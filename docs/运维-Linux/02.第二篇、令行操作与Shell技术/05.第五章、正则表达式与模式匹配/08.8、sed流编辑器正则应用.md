---
title: 8、sed流编辑器正则应用
---
## 📚 目录

1. [sed流编辑器基础概念](#1-sed流编辑器基础概念)
2. [sed地址模式详解](#2-sed地址模式详解)
3. [替换命令核心语法](#3-替换命令核心语法)
4. [分隔符选择与技巧](#4-分隔符选择与技巧)
5. [反向引用高级应用](#5-反向引用高级应用)
6. [多命令组合操作](#6-多命令组合操作)
7. [条件替换实战](#7-条件替换实战)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔧 sed流编辑器基础概念


### 1.1 什么是sed流编辑器


> 📌 **核心概念**  
> sed是"Stream Editor"的缩写，意思是"流编辑器"。它专门用来处理文本流，可以对文本进行自动化的编辑操作。

**通俗理解**：
```
就像工厂的流水线一样：
原始文本 → sed处理 → 修改后的文本

特点：
• 逐行处理：一行一行地读取和处理文本
• 非交互式：不需要人工干预，自动完成
• 流式处理：处理完一行立即输出，不占用大量内存
```

### 1.2 sed的工作机制


**工作流程图示**：
```
文件/输入流
    ↓
┌─────────────────┐
│  读取一行到模式空间  │ ← 临时存储区域
├─────────────────┤
│  执行sed命令       │ ← 查找、替换、删除等
├─────────────────┤
│  输出处理结果      │ ← 打印到屏幕或文件
└─────────────────┘
    ↓
继续处理下一行...
```

**核心特点**：
- **模式空间**：sed的工作缓冲区，每次处理一行
- **默认输出**：处理完每行后自动打印（除非使用`-n`选项）
- **原文件不变**：默认情况下不修改原文件

### 1.3 基本命令格式


```bash
# 基本语法
sed [选项] '命令' 文件名

# 常用选项
-n    # 静默模式，不自动打印每行
-i    # 直接修改原文件
-e    # 指定多个命令
-f    # 从文件读取命令
```

**简单示例**：
```bash
# 查看文件内容
cat test.txt
Hello World
Linux is great
sed is powerful

# 基本替换操作
sed 's/is/was/' test.txt
Hello World
Linux was great    # 只替换第一个'is'
sed was powerful   # 只替换第一个'is'
```

---

## 2. 📍 sed地址模式详解


### 2.1 什么是地址模式


> 💡 **实用技巧**  
> 地址模式就是告诉sed"在哪些行上执行操作"。就像给快递员指定送货地址一样，你需要告诉sed在哪些行上工作。

**地址模式类型**：

```
数字地址：指定具体行号
正则地址：匹配特定模式的行
范围地址：指定行号范围或模式范围
特殊地址：$ (最后一行)、! (取反)
```

### 2.2 行号地址模式


**基本行号定位**：
```bash
# 示例文件
cat demo.txt
line 1: first
line 2: second  
line 3: third
line 4: fourth
line 5: fifth

# 只处理第2行
sed '2s/second/SECOND/' demo.txt
line 1: first
line 2: SECOND     # 只有第2行被修改
line 3: third
line 4: fourth
line 5: fifth

# 处理第2到4行
sed '2,4s/line/LINE/' demo.txt
LINE 1: first      # 第1行不变
LINE 2: second     # 第2-4行被修改
LINE 3: third
LINE 4: fourth
line 5: fifth      # 第5行不变
```

**特殊行号标记**：
```bash
# 最后一行
sed '$s/fifth/LAST/' demo.txt

# 除了第3行之外的所有行
sed '3!s/line/LINE/' demo.txt

# 从第3行到最后一行
sed '3,$s/line/LINE/' demo.txt
```

### 2.3 正则表达式地址模式


**模式匹配定位**：
```bash
# 示例文件
cat users.txt
admin:x:0:0:root:/root:/bin/bash
user1:x:1001:1001::/home/user1:/bin/bash
guest:x:1002:1002::/home/guest:/bin/sh
service:x:1003:1003::/var/service:/sbin/nologin

# 只处理包含'admin'的行
sed '/admin/s/:/ | /g' users.txt
admin | x | 0 | 0 | root | /root | /bin/bash
user1:x:1001:1001::/home/user1:/bin/bash
guest:x:1002:1002::/home/guest:/bin/sh
service:x:1003:1003::/var/service:/sbin/nologin

# 处理以'user'开头的行
sed '/^user/s/1001/2001/g' users.txt
```

### 2.4 范围地址模式


**组合地址范围**：
```bash
# 从匹配'user1'的行到匹配'service'的行
sed '/user1/,/service/s/:/ -> /g' users.txt

# 第2行到包含'guest'的行
sed '2,/guest/s/:/|/g' users.txt

# 包含'admin'的行到最后一行
sed '/admin/,$s/bash/BASH/g' users.txt
```

---

## 3. 🔄 替换命令核心语法


### 3.1 基本替换语法


> 📌 **核心概念**  
> 替换命令的格式是 `s/pattern/replacement/flags`，其中 s 代表 substitute（替换）

**语法结构详解**：
```
s/查找模式/替换内容/标志

组成部分：
s         - 替换命令
/         - 分隔符（可以改变）
pattern   - 要查找的正则表达式
replacement - 替换的内容
flags     - 控制替换行为的标志
```

### 3.2 替换标志详解


**g标志 - 全局替换**：
```bash
# 示例文件
cat text.txt
The cat sat on the mat. The cat was fat.

# 不使用g标志（只替换每行第一个匹配）
sed 's/cat/dog/' text.txt
The dog sat on the mat. The cat was fat.
                          ↑ 第二个cat没有被替换

# 使用g标志（替换所有匹配）
sed 's/cat/dog/g' text.txt
The dog sat on the mat. The dog was fat.
                          ↑ 所有cat都被替换
```

**数字标志 - 指定替换第几个**：
```bash
# 只替换每行第2个匹配项
sed 's/the/THE/2' text.txt
The cat sat on THE mat. The cat was fat.
                ↑ 只有第2个'the'被替换（忽略大小写的话）

# 从第2个匹配开始全部替换
sed 's/the/THE/2g' text.txt
```

**p标志 - 打印修改的行**：
```bash
# 打印被修改的行（通常配合-n使用）
sed -n 's/cat/dog/p' text.txt
The dog sat on the mat. The dog was fat.
# 只显示发生替换的行
```

### 3.3 模式匹配技巧


**大小写处理**：
```bash
# 示例文件
cat mixed.txt  
Hello WORLD
hello world
HELLO world

# 使用字符类匹配大小写
sed 's/[Hh]ello/Hi/g' mixed.txt
Hi WORLD
Hi world  
Hi world

# 使用正则表达式组合
sed 's/[Hh][Ee][Ll][Ll][Oo]/Greetings/g' mixed.txt
```

**特殊字符转义**：
```bash
# 处理包含特殊字符的文本
cat urls.txt
http://www.example.com/path
https://secure.site.org/login
ftp://files.server.net/data

# 替换协议部分（需要转义特殊字符）
sed 's/http:\/\//HTTP:\/\//' urls.txt
sed 's/https:\/\//HTTPS:\/\//' urls.txt
```

---

## 4. 🔧 分隔符选择与技巧


### 4.1 为什么需要不同分隔符


> ⚠️ **注意事项**  
> 当要处理的文本包含大量斜杠 `/` 时，使用默认的 `/` 分隔符会导致转义困难。选择不同的分隔符可以让命令更清晰易读。

### 4.2 常用分隔符选择


**处理路径时使用不同分隔符**：
```bash
# 示例文件
cat paths.txt
/home/user/documents/file1.txt
/var/log/system/error.log
/usr/local/bin/myapp

# 使用默认分隔符（需要转义）
sed 's/\/home\/user/\/backup/' paths.txt
# 命令难读，容易出错

# 使用#分隔符
sed 's#/home/user#/backup#' paths.txt
/backup/documents/file1.txt
/var/log/system/error.log
/usr/local/bin/myapp

# 使用|分隔符
sed 's|/var/log|/logs|' paths.txt
/home/user/documents/file1.txt
/logs/system/error.log
/usr/local/bin/myapp
```

### 4.3 分隔符选择原则


**分隔符选择表**：

| **文本特点** | **推荐分隔符** | **示例** | **说明** |
|-------------|-------------|---------|---------|
| 包含 `/` 路径 | `#` 或 `\|` | `s#/old#/new#` | 避免转义斜杠 |
| 包含 `#` 注释 | `/` 或 `\|` | `s\|#old\|#new\|` | 避免与注释符冲突 |
| 包含 `\|` 管道 | `/` 或 `#` | `s/\|old\|/\|new\|/` | 避免与管道符冲突 |
| 一般文本 | `/` | `s/old/new/` | 标准用法，最常见 |

### 4.4 实际应用示例


**配置文件修改**：
```bash
# 修改Apache配置文件路径
cat apache.conf
DocumentRoot /var/www/html
ErrorLog /var/log/apache/error.log
CustomLog /var/log/apache/access.log

# 使用#分隔符修改路径
sed 's#/var/www/html#/home/website#' apache.conf
sed 's#/var/log/apache#/logs/apache#g' apache.conf

# 如果使用默认分隔符会很混乱
sed 's/\/var\/www\/html/\/home\/website/' apache.conf  # 难读
```

---

## 5. 🔄 反向引用高级应用


### 5.1 什么是反向引用


> 💡 **实用技巧**  
> 反向引用就像"复制粘贴"功能。你用括号圈出要记住的部分，然后在替换时用 `\1`、`\2` 等来引用这些部分。

**基本概念图示**：
```
原文：John Smith, 25 years old
模式：\([A-Z][a-z]*\) \([A-Z][a-z]*\), \([0-9]*\)
       ↑第1组      ↑第2组        ↑第3组

反向引用：
\1 = John
\2 = Smith  
\3 = 25

替换结果可以重新排列这些部分
```

### 5.2 基础反向引用示例


**姓名格式转换**：
```bash
# 示例文件
cat names.txt
Smith, John
Johnson, Mary
Brown, David

# 将"姓, 名"格式改为"名 姓"格式
sed 's/\([^,]*\), \(.*\)/\2 \1/' names.txt
John Smith
Mary Johnson
David Brown

# 解释：
# \([^,]*\)  - 第1组：匹配逗号前的姓氏
# , \(.*\)   - 第2组：匹配逗号后的名字
# \2 \1      - 用名字+空格+姓氏替换
```

**日期格式转换**：
```bash
# 示例文件
cat dates.txt
2024-12-25
2024-01-15
2024-06-30

# 将YYYY-MM-DD格式改为MM/DD/YYYY格式
sed 's/\([0-9][0-9][0-9][0-9]\)-\([0-9][0-9]\)-\([0-9][0-9]\)/\2\/\3\/\1/' dates.txt
12/25/2024
01/15/2024
06/30/2024
```

### 5.3 高级反向引用应用


**提取和重组信息**：
```bash
# 日志文件示例
cat access.log
192.168.1.10 - - [25/Dec/2024:10:30:15] "GET /index.html" 200
192.168.1.20 - - [25/Dec/2024:10:31:20] "POST /login" 200
192.168.1.30 - - [25/Dec/2024:10:32:25] "GET /admin" 404

# 提取IP和请求方法，格式化输出
sed 's/\([0-9\.]*\) .* "\([A-Z]*\) \([^"]*\)".*/IP: \1, Method: \2, Path: \3/' access.log
IP: 192.168.1.10, Method: GET, Path: /index.html
IP: 192.168.1.20, Method: POST, Path: /login
IP: 192.168.1.30, Method: GET, Path: /admin
```

**电子邮件地址处理**：
```bash
# 示例文件
cat emails.txt
Contact: john.doe@company.com
Email: admin@website.org
Send to: user123@domain.net

# 提取用户名和域名，重新格式化
sed 's/.*: \([^@]*\)@\(.*\)/User: \1, Domain: \2/' emails.txt
User: john.doe, Domain: company.com
User: admin, Domain: website.org  
User: user123, Domain: domain.net
```

### 5.4 反向引用与正则表达式组合


**复杂模式匹配**：
```bash
# HTML标签处理
cat html.txt
<div class="header">Welcome</div>
<span id="title">Hello World</span>
<p class="content">This is text</p>

# 将HTML标签改为大写，保留属性和内容
sed 's/<\([a-z]*\)\([^>]*\)>\(.*\)<\/\([a-z]*\)>/<\U\1\E\2>\3<\/\U\4\E>/' html.txt
# 这个例子比较复杂，实际使用中要根据具体需求简化
```

---

## 6. 🔗 多命令组合操作


### 6.1 多命令执行方式


> 📌 **核心概念**  
> sed可以在一次运行中执行多个命令，就像批处理一样。有多种方式可以组合命令。

**方式对比表**：

| **方法** | **语法** | **适用场景** | **示例** |
|---------|---------|-------------|---------|
| `-e` 选项 | `sed -e 'cmd1' -e 'cmd2'` | 命令行多命令 | `sed -e 's/a/A/' -e 's/b/B/'` |
| 分号分隔 | `sed 'cmd1;cmd2'` | 简单多命令 | `sed 's/a/A/;s/b/B/'` |
| 花括号组合 | `sed '/pattern/{cmd1;cmd2}'` | 条件多命令 | `sed '/user/{s/:/|/;s/bash/sh/}'` |
| 脚本文件 | `sed -f script.sed` | 复杂批量处理 | 从文件读取命令 |

### 6.2 简单多命令组合


**基本多替换操作**：
```bash
# 示例文件
cat data.txt
apple banana cherry
dog cat bird
red blue green

# 使用-e选项执行多个替换
sed -e 's/apple/APPLE/' -e 's/banana/BANANA/' -e 's/cherry/CHERRY/' data.txt
APPLE BANANA CHERRY
dog cat bird
red blue green

# 使用分号分隔（更简洁）
sed 's/apple/APPLE/;s/banana/BANANA/;s/cherry/CHERRY/' data.txt
# 结果相同
```

**链式替换示例**：
```bash
# 多步骤数据清理
cat messy_data.txt
  user1:  password123  :  /bin/bash  
  user2:password456:/bin/sh
user3:   password789   :/bin/zsh   

# 链式清理：去除多余空格，统一分隔符
sed 's/^ *//;s/ *$//;s/ *: */:/' messy_data.txt
user1:password123:/bin/bash
user2:password456:/bin/sh
user3:password789:/bin/zsh
```

### 6.3 条件多命令组合


**基于模式的批量处理**：
```bash
# 系统用户文件示例
cat users.txt
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
user1:x:1001:1001:User One:/home/user1:/bin/bash
user2:x:1002:1002:User Two:/home/user2:/bin/sh
guest:x:1003:1003:Guest Account:/home/guest:/bin/bash

# 只对普通用户(UID >= 1000)进行批量修改
sed '/100[0-9]/{s/:/ | /g;s/bash/BASH/}' users.txt
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
user1 | x | 1001 | 1001 | User One | /home/user1 | /bin/BASH
user2 | x | 1002 | 1002 | User Two | /home/user2 | /bin/sh  
guest | x | 1003 | 1003 | Guest Account | /home/guest | /bin/BASH
```

### 6.4 sed脚本文件


**创建sed脚本**：
```bash
# 创建脚本文件
cat > format_log.sed << 'EOF'
# 这是sed脚本文件，用于格式化日志
# 替换时间戳格式
s/\[([0-9][0-9])\/([A-Z][a-z][a-z])\/([0-9][0-9][0-9][0-9]):([0-9][0-9]):([0-9][0-9]):([0-9][0-9])\]/[\3-\2-\1 \4:\5:\6]/
# 替换HTTP状态码
s/ 200 / SUCCESS /
s/ 404 / NOT_FOUND /
s/ 500 / ERROR /
# 添加分隔线
s/$/\n---/
EOF

# 使用脚本文件处理日志
sed -f format_log.sed access.log
```

---

## 7. ✅ 条件替换实战


### 7.1 条件替换基本概念


> 💡 **实用技巧**  
> 条件替换就是"只在特定行上执行替换操作"。就像给邮递员说"只给住在3楼的人送信"一样，你可以告诉sed只在符合条件的行上工作。

### 7.2 基于行号的条件替换


**指定行范围替换**：
```bash
# 示例配置文件
cat config.txt
# Database Configuration
host=localhost
port=3306
user=admin
password=secret
# Web Server Configuration  
host=webserver
port=8080
user=webuser
password=webpass

# 只替换前5行中的配置
sed '1,5s/admin/dbadmin/' config.txt
# Database Configuration
host=localhost
port=3306
user=dbadmin          # 只有这行被修改
password=secret
# Web Server Configuration
host=webserver        # 这些行不受影响
port=8080
user=webuser
password=webpass
```

### 7.3 基于模式的条件替换


**匹配特定模式的行**：
```bash
# 日志文件示例
cat server.log
[INFO] Server started successfully
[ERROR] Database connection failed
[INFO] User logged in: admin
[ERROR] File not found: config.xml
[INFO] Request processed: GET /api/users

# 只在ERROR行中替换信息
sed '/ERROR/s/failed/FAILED/' server.log
[INFO] Server started successfully
[ERROR] Database connection FAILED    # 只有ERROR行被修改
[INFO] User logged in: admin
[ERROR] File not found: config.xml    # 这行没有'failed'所以不变
[INFO] Request processed: GET /api/users
```

### 7.4 复杂条件替换场景


**多条件组合**：
```bash
# 员工数据文件
cat employees.txt
ID:1001,Name:John Smith,Dept:IT,Salary:50000,Status:Active
ID:1002,Name:Jane Doe,Dept:HR,Status:Inactive,Salary:45000
ID:1003,Name:Mike Johnson,Dept:IT,Salary:55000,Status:Active
ID:1004,Name:Sarah Wilson,Dept:Finance,Salary:60000,Status:Active

# 只对IT部门的活跃员工调整薪资格式
sed '/Dept:IT.*Status:Active/s/Salary:\([0-9]*\)/Salary:$\1/' employees.txt
ID:1001,Name:John Smith,Dept:IT,Salary:$50000,Status:Active
ID:1002,Name:Jane Doe,Dept:HR,Status:Inactive,Salary:45000
ID:1003,Name:Mike Johnson,Dept:IT,Salary:$55000,Status:Active
ID:1004,Name:Sarah Wilson,Dept:Finance,Salary:60000,Status:Active
```

### 7.5 实用条件替换技巧


**配置文件批量更新**：
```bash
# 应用配置文件
cat app.conf
[database]
host=localhost
port=3306
timeout=30

[cache]  
host=localhost
port=6379
timeout=60

[api]
host=localhost
port=8080
timeout=120

# 只更新database段落中的配置
sed '/\[database\]/,/\[cache\]/{s/localhost/db-server.local/;s/timeout=30/timeout=45/}' app.conf
```

**日志过滤和标记**：
```bash
# 系统日志
cat system.log  
2024-12-25 10:30:15 INFO: System startup
2024-12-25 10:30:16 ERROR: Failed to load module
2024-12-25 10:30:17 WARN: Low disk space
2024-12-25 10:30:18 INFO: Service started
2024-12-25 10:30:19 ERROR: Connection timeout

# 只标记ERROR和WARN级别的日志
sed '/ERROR\|WARN/s/^/>>> ATTENTION: /' system.log
2024-12-25 10:30:15 INFO: System startup
>>> ATTENTION: 2024-12-25 10:30:16 ERROR: Failed to load module
>>> ATTENTION: 2024-12-25 10:30:17 WARN: Low disk space  
2024-12-25 10:30:18 INFO: Service started
>>> ATTENTION: 2024-12-25 10:30:19 ERROR: Connection timeout
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 sed本质：流编辑器，逐行处理文本，自动化文本操作
🔸 地址模式：行号定位、正则匹配、范围选择
🔸 替换语法：s/pattern/replacement/flags 格式
🔸 全局标志：g标志实现全行替换，数字标志控制替换位置
🔸 分隔符灵活性：使用#、|等避免转义问题
🔸 反向引用：\1、\2等引用匹配组，实现复杂重组
🔸 多命令组合：-e选项、分号连接、条件组合
🔸 条件替换：只在特定行或匹配模式的行上执行操作
```

### 8.2 关键理解要点


**🔹 sed工作原理**
```
理解要点：
- sed是流处理工具，一次处理一行
- 模式空间是临时工作区域
- 默认会输出所有行（除非使用-n）
- 不修改原文件（除非使用-i）
```

**🔹 地址模式的选择策略**
```
选择原则：
- 精确行号：用于已知位置的修改
- 正则模式：用于内容驱动的查找
- 范围地址：用于批量区域处理
- 条件地址：用于复杂逻辑判断
```

**🔹 替换命令的灵活性**
```
核心技巧：
- 合理选择分隔符，提高可读性
- 使用反向引用实现复杂重组
- 组合多个命令实现批量操作
- 条件替换避免误操作
```

### 8.3 实际应用指导


✅ **适用场景判断**：
- **批量文本替换**：配置文件更新、代码重构
- **日志处理**：格式统一、信息提取、状态标记
- **数据清理**：格式规范化、多余空格删除
- **内容转换**：格式转换、结构重组

❌ **不适用场景**：
- **复杂XML/JSON处理**：建议使用专门工具
- **交互式编辑**：使用vi/vim更合适
- **大文件内存敏感操作**：sed流处理的优势

### 8.4 最佳实践建议


```
🔧 操作建议：
- 先用小文件测试命令再应用到重要文件
- 使用-i.bak选项创建备份
- 复杂操作拆分成多个简单步骤
- 充分利用反向引用减少重复工作

⚡ 性能优化：
- 使用具体的地址模式减少不必要处理
- 多命令组合减少多次扫描
- 适当使用-n选项控制输出

🔒 安全注意：
- 重要文件操作前一定要备份
- 测试正则表达式避免意外匹配
- 特殊字符注意转义处理
```

### 8.5 常用命令速查


📖 **常用sed模式**：
```
基础替换：
sed 's/old/new/'           # 替换每行第一个
sed 's/old/new/g'          # 全局替换
sed 's/old/new/2'          # 替换第2个匹配

地址定位：
sed '3s/old/new/'          # 第3行替换
sed '2,5s/old/new/'        # 第2-5行替换  
sed '/pattern/s/old/new/'  # 匹配行替换

分隔符变换：
sed 's#/path#/newpath#'    # 处理路径
sed 's|old|new|'           # 避免转义

反向引用：
sed 's/\(.*\):\(.*\)/\2:\1/' # 交换冒号前后内容

多命令：
sed 's/a/A/;s/b/B/'        # 分号连接
sed -e 's/a/A/' -e 's/b/B/' # -e选项
```

**核心记忆口诀**：
- sed流编辑逐行扫，地址模式定范围
- 替换语法s分隔，标志控制替换法  
- 反向引用组重排，多命令批量来
- 条件替换更精准，备份测试保安全