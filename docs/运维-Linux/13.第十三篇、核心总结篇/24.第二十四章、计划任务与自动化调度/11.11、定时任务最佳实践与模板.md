---
title: 11ã€å®šæ—¶ä»»åŠ¡æœ€ä½³å®è·µä¸æ¨¡æ¿
---
## ğŸ“š ç›®å½•

1. [ä»»åŠ¡è„šæœ¬ç¼–å†™è§„èŒƒ](#1-ä»»åŠ¡è„šæœ¬ç¼–å†™è§„èŒƒ)
2. [é”™è¯¯å¤„ç†æœºåˆ¶](#2-é”™è¯¯å¤„ç†æœºåˆ¶)  
3. [é”æ–‡ä»¶é˜²é‡å¤æ‰§è¡Œ](#3-é”æ–‡ä»¶é˜²é‡å¤æ‰§è¡Œ)
4. [ä»»åŠ¡è¶…æ—¶æ§åˆ¶](#4-ä»»åŠ¡è¶…æ—¶æ§åˆ¶)
5. [èµ„æºä½¿ç”¨é™åˆ¶](#5-èµ„æºä½¿ç”¨é™åˆ¶)
6. [ä»»åŠ¡ä¾èµ–å…³ç³»å¤„ç†](#6-ä»»åŠ¡ä¾èµ–å…³ç³»å¤„ç†)
7. [å¤‡ä»½ä»»åŠ¡æ ‡å‡†æ¨¡æ¿](#7-å¤‡ä»½ä»»åŠ¡æ ‡å‡†æ¨¡æ¿)
8. [ç›‘æ§ä»»åŠ¡æ ‡å‡†æ¨¡æ¿](#8-ç›‘æ§ä»»åŠ¡æ ‡å‡†æ¨¡æ¿)
9. [æ¸…ç†ä»»åŠ¡æ ‡å‡†æ¨¡æ¿](#9-æ¸…ç†ä»»åŠ¡æ ‡å‡†æ¨¡æ¿)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“ ä»»åŠ¡è„šæœ¬ç¼–å†™è§„èŒƒ


### 1.1 åŸºæœ¬è„šæœ¬ç»“æ„è§„èŒƒ


**ä»€ä¹ˆæ˜¯ä»»åŠ¡è„šæœ¬ç¼–å†™è§„èŒƒï¼Ÿ**
å°±åƒå†™ä½œæ–‡éœ€è¦æœ‰å¼€å¤´ã€æ­£æ–‡ã€ç»“å°¾ä¸€æ ·ï¼Œå®šæ—¶ä»»åŠ¡è„šæœ¬ä¹Ÿéœ€è¦æœ‰å›ºå®šçš„ç»“æ„ï¼Œè¿™æ ·æ—¢ä¾¿äºç»´æŠ¤ï¼Œä¹Ÿä¸å®¹æ˜“å‡ºé”™ã€‚

**ğŸ”´ å¿…é¡»æŒæ¡**ï¼šæ ‡å‡†è„šæœ¬æ¨¡æ¿ç»“æ„

```bash
#!/bin/bash
# è„šæœ¬åç§°ï¼šbackup_database.sh
# åŠŸèƒ½æè¿°ï¼šæ•°æ®åº“è‡ªåŠ¨å¤‡ä»½
# ä½œè€…ï¼šè¿ç»´å›¢é˜Ÿ
# åˆ›å»ºæ—¶é—´ï¼š2025-09-18
# ä¿®æ”¹è®°å½•ï¼šåˆå§‹ç‰ˆæœ¬

# ç¯å¢ƒå˜é‡è®¾ç½®
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export PATH

# åŸºç¡€é…ç½®
SCRIPT_NAME=$(basename $0)
SCRIPT_DIR=$(dirname $0)
LOG_DIR="/var/log/crontab"
LOCK_DIR="/var/lock"
DATE=$(date +"%Y%m%d_%H%M%S")

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p $LOG_DIR

# æ—¥å¿—è®°å½•å‡½æ•°
log_info() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] INFO: $1" >> $LOG_DIR/${SCRIPT_NAME}.log
}

log_error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $1" >> $LOG_DIR/${SCRIPT_NAME}.log
}

# ä¸»è¦ä¸šåŠ¡é€»è¾‘
main() {
    log_info "è„šæœ¬å¼€å§‹æ‰§è¡Œ"
    
    # å…·ä½“ä¸šåŠ¡ä»£ç 
    
    log_info "è„šæœ¬æ‰§è¡Œå®Œæˆ"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

### 1.2 ç¯å¢ƒå˜é‡è®¾ç½®è§„èŒƒ


**ä¸ºä»€ä¹ˆè¦è®¾ç½®PATHç¯å¢ƒå˜é‡ï¼Ÿ**
crontabæ‰§è¡Œæ—¶çš„ç¯å¢ƒå¾ˆç®€å•ï¼ŒPATHè·¯å¾„å¯èƒ½ä¸å®Œæ•´ï¼Œå¯¼è‡´æ‰¾ä¸åˆ°å‘½ä»¤ã€‚å°±åƒä½ æ¬åˆ°æ–°å®¶ï¼Œä¸çŸ¥é“è¶…å¸‚åœ¨å“ªé‡Œä¸€æ ·ã€‚

```bash
# âœ… æ­£ç¡®çš„ç¯å¢ƒå˜é‡è®¾ç½®
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export PATH

# æ•°æ®åº“ç›¸å…³ç¯å¢ƒå˜é‡
export MYSQL_HOME=/usr/local/mysql
export MYSQL_USER="backup_user"
export MYSQL_PASSWORD="secure_password"

# åº”ç”¨ç›¸å…³ç¯å¢ƒå˜é‡
export APP_HOME="/opt/myapp"
export JAVA_HOME="/usr/java/default"
```

### 1.3 æ—¥å¿—è®°å½•è§„èŒƒ


**æ—¥å¿—å°±åƒä»»åŠ¡çš„"è¡Œè½¦è®°å½•ä»ª"**ï¼Œè®°å½•äº†ä»»åŠ¡æ‰§è¡Œçš„å…¨è¿‡ç¨‹ï¼Œå‡ºäº†é—®é¢˜å¯ä»¥å¿«é€Ÿå®šä½ã€‚

**ğŸ”´ å¿…é¡»æŒæ¡**ï¼šæ ‡å‡†æ—¥å¿—æ ¼å¼

```bash
# æ—¥å¿—çº§åˆ«å®šä¹‰
LOG_LEVEL_INFO="INFO"
LOG_LEVEL_WARN="WARN" 
LOG_LEVEL_ERROR="ERROR"

# ç»Ÿä¸€æ—¥å¿—å‡½æ•°
write_log() {
    local level=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [$level] $message" >> $LOG_FILE
}

# ä½¿ç”¨ç¤ºä¾‹
write_log $LOG_LEVEL_INFO "å¼€å§‹æ‰§è¡Œæ•°æ®åº“å¤‡ä»½"
write_log $LOG_LEVEL_ERROR "æ•°æ®åº“è¿æ¥å¤±è´¥"
```

---

## 2. âš ï¸ é”™è¯¯å¤„ç†æœºåˆ¶


### 2.1 åŸºæœ¬é”™è¯¯å¤„ç†åŸåˆ™


**ä»€ä¹ˆæ˜¯é”™è¯¯å¤„ç†ï¼Ÿ**
å°±åƒå¼€è½¦è¦ç³»å®‰å…¨å¸¦ä¸€æ ·ï¼Œè„šæœ¬æ‰§è¡Œæ—¶ä¹Ÿè¦é¢„é˜²å„ç§æ„å¤–æƒ…å†µï¼Œä¿è¯å³ä½¿å‡ºé”™äº†ä¹Ÿèƒ½ä¼˜é›…åœ°å¤„ç†ã€‚

**æ ¸å¿ƒåŸåˆ™**ï¼š
- **é¢„é˜²ä¸ºä¸»**ï¼šæå‰æ£€æŸ¥æ¡ä»¶
- **å¿«é€Ÿå¤±è´¥**ï¼šå‘ç°é”™è¯¯ç«‹å³åœæ­¢
- **è¯¦ç»†è®°å½•**ï¼šè®°å½•é”™è¯¯è¯¦æƒ…
- **æ¸…ç†èµ„æº**ï¼šå‡ºé”™åæ¸…ç†ä¸´æ—¶æ–‡ä»¶

### 2.2 åŸºç¡€é”™è¯¯æ£€æŸ¥æœºåˆ¶


```bash
# è®¾ç½®é”™è¯¯æ—¶ç«‹å³é€€å‡º
set -e  # å‘½ä»¤å¤±è´¥æ—¶é€€å‡º
set -u  # ä½¿ç”¨æœªå®šä¹‰å˜é‡æ—¶é€€å‡º
set -o pipefail  # ç®¡é“å‘½ä»¤ä»»ä½•ä¸€ä¸ªå¤±è´¥éƒ½é€€å‡º

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
check_command() {
    local cmd=$1
    if ! command -v $cmd >/dev/null 2>&1; then
        log_error "å‘½ä»¤ $cmd ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£…"
        exit 1
    fi
}

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
check_file() {
    local file=$1
    if [[ ! -f $file ]]; then
        log_error "æ–‡ä»¶ $file ä¸å­˜åœ¨"
        exit 1
    fi
}

# æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
check_directory() {
    local dir=$1
    if [[ ! -d $dir ]]; then
        log_error "ç›®å½• $dir ä¸å­˜åœ¨"
        exit 1
    fi
}
```

### 2.3 é”™è¯¯æ¢å¤æœºåˆ¶


**ä»€ä¹ˆæ˜¯é”™è¯¯æ¢å¤ï¼Ÿ**
å°±åƒæ‘”å€’äº†è¦çˆ¬èµ·æ¥ç»§ç»­èµ°ä¸€æ ·ï¼Œè„šæœ¬é‡åˆ°æŸäº›é”™è¯¯æ—¶ï¼Œè¦èƒ½è‡ªåŠ¨é‡è¯•æˆ–é‡‡ç”¨å¤‡ç”¨æ–¹æ¡ˆã€‚

```bash
# å¸¦é‡è¯•çš„å‡½æ•°æ‰§è¡Œ
retry_command() {
    local cmd="$1"
    local max_attempts=${2:-3}
    local delay=${3:-5}
    local attempt=1
    
    while [[ $attempt -le $max_attempts ]]; do
        log_info "æ‰§è¡Œå‘½ä»¤ï¼Œç¬¬ $attempt æ¬¡å°è¯•: $cmd"
        
        if eval $cmd; then
            log_info "å‘½ä»¤æ‰§è¡ŒæˆåŠŸ"
            return 0
        else
            log_warn "å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œç¬¬ $attempt æ¬¡å°è¯•"
            if [[ $attempt -eq $max_attempts ]]; then
                log_error "å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
                return 1
            fi
            sleep $delay
            ((attempt++))
        fi
    done
}

# ä½¿ç”¨ç¤ºä¾‹
retry_command "mysqldump -u$USER -p$PASS mydb > backup.sql" 3 10
```

---

## 3. ğŸ”’ é”æ–‡ä»¶é˜²é‡å¤æ‰§è¡Œ


### 3.1 ä»€ä¹ˆæ˜¯é”æ–‡ä»¶æœºåˆ¶


**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
â”Œâ”€ ç”Ÿæ´»ç±»æ¯” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å°±åƒå•æ‰€é—¨ä¸Šçš„é”ä¸€æ ·ï¼š      â”‚
â”‚ â€¢ è¿›å»æ—¶é”é—¨ï¼ˆåˆ›å»ºé”æ–‡ä»¶ï¼‰  â”‚
â”‚ â€¢ æœ‰äººåœ¨æ—¶åˆ«äººç­‰å¾…          â”‚
â”‚ â€¢ å‡ºæ¥æ—¶å¼€é”ï¼ˆåˆ é™¤é”æ–‡ä»¶ï¼‰  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆéœ€è¦é”æ–‡ä»¶ï¼Ÿ**
é˜²æ­¢åŒä¸€ä¸ªä»»åŠ¡åŒæ—¶è¿è¡Œå¤šæ¬¡ï¼Œå°±åƒä¸èƒ½è®©ä¸¤ä¸ªå¤‡ä»½ä»»åŠ¡åŒæ—¶æ“ä½œåŒä¸€ä¸ªæ•°æ®åº“ï¼Œä¼šé€ æˆæ•°æ®æŸåã€‚

### 3.2 åŸºç¡€é”æ–‡ä»¶å®ç°


```bash
# é”æ–‡ä»¶é…ç½®
LOCK_FILE="$LOCK_DIR/${SCRIPT_NAME}.lock"
LOCK_TIMEOUT=3600  # 1å°æ—¶è¶…æ—¶

# åˆ›å»ºé”æ–‡ä»¶
create_lock() {
    if [[ -f $LOCK_FILE ]]; then
        local lock_pid=$(cat $LOCK_FILE)
        
        # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
        if kill -0 $lock_pid 2>/dev/null; then
            log_error "ä»»åŠ¡å·²åœ¨è¿è¡Œï¼ŒPID: $lock_pid"
            exit 1
        else
            log_warn "å‘ç°åƒµå°¸é”æ–‡ä»¶ï¼Œæ¸…ç†åç»§ç»­"
            rm -f $LOCK_FILE
        fi
    fi
    
    # åˆ›å»ºé”æ–‡ä»¶ï¼Œå†™å…¥å½“å‰è¿›ç¨‹ID
    echo $$ > $LOCK_FILE
    log_info "åˆ›å»ºé”æ–‡ä»¶: $LOCK_FILE"
}

# æ¸…ç†é”æ–‡ä»¶
cleanup_lock() {
    if [[ -f $LOCK_FILE ]]; then
        rm -f $LOCK_FILE
        log_info "æ¸…ç†é”æ–‡ä»¶: $LOCK_FILE"
    fi
}

# è„šæœ¬é€€å‡ºæ—¶è‡ªåŠ¨æ¸…ç†
trap cleanup_lock EXIT
```

### 3.3 é«˜çº§é”æ–‡ä»¶æœºåˆ¶


**ğŸ”´ å¿…é¡»æŒæ¡**ï¼šå¸¦è¶…æ—¶çš„é”æ–‡ä»¶å¤„ç†

```bash
# å¸¦è¶…æ—¶æ£€æŸ¥çš„é”æ–‡ä»¶
create_lock_with_timeout() {
    if [[ -f $LOCK_FILE ]]; then
        local lock_time=$(stat -c %Y $LOCK_FILE 2>/dev/null || echo 0)
        local current_time=$(date +%s)
        local lock_age=$((current_time - lock_time))
        
        if [[ $lock_age -gt $LOCK_TIMEOUT ]]; then
            log_warn "é”æ–‡ä»¶è¶…æ—¶ï¼ˆ${lock_age}ç§’ï¼‰ï¼Œå¼ºåˆ¶æ¸…ç†"
            rm -f $LOCK_FILE
        else
            log_error "ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­ï¼Œå‰©ä½™æ—¶é—´ï¼š$((LOCK_TIMEOUT - lock_age))ç§’"
            exit 1
        fi
    fi
    
    echo $$ > $LOCK_FILE
    log_info "åˆ›å»ºé”æ–‡ä»¶æˆåŠŸ"
}
```

---

## 4. â° ä»»åŠ¡è¶…æ—¶æ§åˆ¶


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶æ§åˆ¶


**é—®é¢˜åœºæ™¯**ï¼š
```
âŒ å¸¸è§é—®é¢˜ï¼š
- ç½‘ç»œå¤‡ä»½å¡ä½äº†ï¼Œå ç”¨èµ„æºä¸€æ•´å¤©
- æ•°æ®æ¸…ç†ä»»åŠ¡åˆ é™¤å¤§æ–‡ä»¶æ—¶é—´è¿‡é•¿
- APIè°ƒç”¨æ— å“åº”ï¼Œè„šæœ¬ä¸€ç›´ç­‰å¾…

âœ… è§£å†³æ–¹æ¡ˆï¼š
è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶è‡ªåŠ¨ç»ˆæ­¢
```

### 4.2 åŸºç¡€è¶…æ—¶å®ç°


```bash
# ä½¿ç”¨timeoutå‘½ä»¤æ§åˆ¶è¶…æ—¶
BACKUP_TIMEOUT=1800  # 30åˆ†é’Ÿ

# æ‰§è¡Œå¸¦è¶…æ—¶çš„å‘½ä»¤
execute_with_timeout() {
    local cmd="$1"
    local timeout_sec=${2:-300}  # é»˜è®¤5åˆ†é’Ÿ
    
    log_info "æ‰§è¡Œå‘½ä»¤ï¼ˆè¶…æ—¶ï¼š${timeout_sec}ç§’ï¼‰: $cmd"
    
    if timeout $timeout_sec bash -c "$cmd"; then
        log_info "å‘½ä»¤æ‰§è¡ŒæˆåŠŸ"
        return 0
    else
        local exit_code=$?
        if [[ $exit_code -eq 124 ]]; then
            log_error "å‘½ä»¤æ‰§è¡Œè¶…æ—¶ï¼ˆ${timeout_sec}ç§’ï¼‰"
        else
            log_error "å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç ï¼š$exit_code"
        fi
        return $exit_code
    fi
}

# ä½¿ç”¨ç¤ºä¾‹
execute_with_timeout "mysqldump -u$USER -p$PASS mydb > backup.sql" 1800
```

### 4.3 é«˜çº§è¶…æ—¶æ§åˆ¶


**ğŸŸ¡ å»ºè®®äº†è§£**ï¼šè‡ªå®šä¹‰è¶…æ—¶å¤„ç†

```bash
# å¸¦æ¸…ç†çš„è¶…æ—¶æ§åˆ¶
execute_with_cleanup_timeout() {
    local cmd="$1"
    local timeout_sec=$2
    local cleanup_cmd="$3"
    
    # åœ¨åå°æ‰§è¡Œå‘½ä»¤
    eval "$cmd" &
    local cmd_pid=$!
    
    # ç›‘æ§è¶…æ—¶
    (
        sleep $timeout_sec
        if kill -0 $cmd_pid 2>/dev/null; then
            log_warn "ä»»åŠ¡è¶…æ—¶ï¼Œæ­£åœ¨æ¸…ç†..."
            kill -TERM $cmd_pid
            sleep 5
            kill -KILL $cmd_pid 2>/dev/null
            
            # æ‰§è¡Œæ¸…ç†å‘½ä»¤
            if [[ -n $cleanup_cmd ]]; then
                eval "$cleanup_cmd"
            fi
        fi
    ) &
    local timeout_pid=$!
    
    # ç­‰å¾…å‘½ä»¤å®Œæˆ
    wait $cmd_pid
    local exit_code=$?
    
    # æ¸…ç†è¶…æ—¶ç›‘æ§è¿›ç¨‹
    kill $timeout_pid 2>/dev/null
    
    return $exit_code
}
```

---

## 5. ğŸ’¾ èµ„æºä½¿ç”¨é™åˆ¶


### 5.1 CPUä½¿ç”¨é™åˆ¶


**ä»€ä¹ˆæ˜¯èµ„æºé™åˆ¶ï¼Ÿ**
å°±åƒåœ¨å…¬å…±åœºæ‰€è¦æ§åˆ¶éŸ³é‡ä¸€æ ·ï¼Œå®šæ—¶ä»»åŠ¡ä¹Ÿè¦æ§åˆ¶èµ„æºä½¿ç”¨ï¼Œä¸èƒ½å½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œã€‚

```bash
# ä½¿ç”¨niceæ§åˆ¶CPUä¼˜å…ˆçº§
# niceå€¼ï¼š-20(æœ€é«˜ä¼˜å…ˆçº§) åˆ° 19(æœ€ä½ä¼˜å…ˆçº§)

# ä½ä¼˜å…ˆçº§æ‰§è¡Œå¤‡ä»½ä»»åŠ¡
nice -n 15 mysqldump -u$USER -p$PASS mydb > backup.sql

# ä½¿ç”¨ioniceæ§åˆ¶IOä¼˜å…ˆçº§
# class: 0(æ— é™åˆ¶) 1(å®æ—¶) 2(å°½åŠ›è€Œä¸º) 3(ç©ºé—²)
ionice -c 3 -n 7 tar czf backup.tar.gz /data/

# ç»¼åˆä½¿ç”¨
nice -n 10 ionice -c 2 -n 5 rsync -av /source/ /backup/
```

### 5.2 å†…å­˜ä½¿ç”¨é™åˆ¶


```bash
# ä½¿ç”¨ulimité™åˆ¶å†…å­˜ä½¿ç”¨
# é™åˆ¶è™šæ‹Ÿå†…å­˜ä¸º1GB
ulimit -v 1048576

# é™åˆ¶è¿›ç¨‹æ•°æ®æ®µå¤§å°
ulimit -d 524288

# åœ¨è„šæœ¬ä¸­è®¾ç½®èµ„æºé™åˆ¶
set_resource_limits() {
    # é™åˆ¶å†…å­˜ä½¿ç”¨ï¼ˆKBï¼‰
    ulimit -v 2097152  # 2GBè™šæ‹Ÿå†…å­˜
    ulimit -m 1048576  # 1GBç‰©ç†å†…å­˜
    
    # é™åˆ¶æ–‡ä»¶å¤§å°ï¼ˆKBï¼‰
    ulimit -f 10485760  # 10GBæ–‡ä»¶å¤§å°é™åˆ¶
    
    # é™åˆ¶è¿›ç¨‹æ•°
    ulimit -u 100
    
    log_info "å·²è®¾ç½®èµ„æºé™åˆ¶"
}
```

### 5.3 ç£ç›˜ç©ºé—´æ£€æŸ¥


**ğŸ”´ å¿…é¡»æŒæ¡**ï¼šæ‰§è¡Œå‰æ£€æŸ¥ç£ç›˜ç©ºé—´

```bash
# æ£€æŸ¥ç£ç›˜å¯ç”¨ç©ºé—´
check_disk_space() {
    local path=$1
    local required_gb=$2
    
    # è·å–å¯ç”¨ç©ºé—´ï¼ˆGBï¼‰
    local available_gb=$(df -BG $path | awk 'NR==2 {print int($4)}')
    
    if [[ $available_gb -lt $required_gb ]]; then
        log_error "ç£ç›˜ç©ºé—´ä¸è¶³ï¼šéœ€è¦${required_gb}GBï¼Œå¯ç”¨${available_gb}GB"
        return 1
    else
        log_info "ç£ç›˜ç©ºé—´å……è¶³ï¼šéœ€è¦${required_gb}GBï¼Œå¯ç”¨${available_gb}GB"
        return 0
    fi
}

# ä½¿ç”¨ç¤ºä¾‹
if check_disk_space "/backup" 10; then
    # æ‰§è¡Œå¤‡ä»½ä»»åŠ¡
    execute_backup
else
    # æ¸…ç†æ—§å¤‡ä»½
    cleanup_old_backups
fi
```

---

## 6. ğŸ”— ä»»åŠ¡ä¾èµ–å…³ç³»å¤„ç†


### 6.1 ä»€ä¹ˆæ˜¯ä»»åŠ¡ä¾èµ–


**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
åšé¥­çš„ä¾èµ–å…³ç³»ï¼š
ä¹°èœ â†’ æ´—èœ â†’ åˆ‡èœ â†’ ç‚’èœ â†’ ä¸Šæ¡Œ

ç³»ç»Ÿå¤‡ä»½çš„ä¾èµ–å…³ç³»ï¼š
åœæ­¢æœåŠ¡ â†’ å¤‡ä»½æ•°æ®åº“ â†’ å¤‡ä»½æ–‡ä»¶ â†’ å¯åŠ¨æœåŠ¡ â†’ é€šçŸ¥ç®¡ç†å‘˜
```

### 6.2 ç®€å•ä¾èµ–æ£€æŸ¥


```bash
# æ£€æŸ¥å‰ç½®ä»»åŠ¡æ˜¯å¦å®Œæˆ
check_prerequisite() {
    local task_name=$1
    local flag_file="/tmp/${task_name}.done"
    
    if [[ ! -f $flag_file ]]; then
        log_error "å‰ç½®ä»»åŠ¡ $task_name æœªå®Œæˆ"
        return 1
    fi
    
    # æ£€æŸ¥æ ‡å¿—æ–‡ä»¶æ˜¯å¦æ˜¯ä»Šå¤©åˆ›å»ºçš„
    local file_date=$(date -r $flag_file +%Y%m%d)
    local today=$(date +%Y%m%d)
    
    if [[ $file_date != $today ]]; then
        log_error "å‰ç½®ä»»åŠ¡ $task_name ä¸æ˜¯ä»Šå¤©å®Œæˆçš„"
        return 1
    fi
    
    log_info "å‰ç½®ä»»åŠ¡ $task_name æ£€æŸ¥é€šè¿‡"
    return 0
}

# æ ‡è®°ä»»åŠ¡å®Œæˆ
mark_task_done() {
    local task_name=$1
    local flag_file="/tmp/${task_name}.done"
    
    echo "$(date)" > $flag_file
    log_info "ä»»åŠ¡ $task_name å·²æ ‡è®°ä¸ºå®Œæˆ"
}

# ä½¿ç”¨ç¤ºä¾‹
if check_prerequisite "database_backup"; then
    # æ‰§è¡Œæ–‡ä»¶å¤‡ä»½
    execute_file_backup
    mark_task_done "file_backup"
fi
```

### 6.3 å¤æ‚ä¾èµ–ç®¡ç†


**ğŸŸ¡ å»ºè®®äº†è§£**ï¼šå¤šä»»åŠ¡ä¾èµ–åè°ƒ

```bash
# ä»»åŠ¡çŠ¶æ€ç®¡ç†
TASK_STATUS_DIR="/var/run/crontab_status"
mkdir -p $TASK_STATUS_DIR

# ç­‰å¾…ä¾èµ–ä»»åŠ¡å®Œæˆ
wait_for_dependencies() {
    local dependencies=("$@")
    local max_wait=3600  # æœ€å¤§ç­‰å¾…1å°æ—¶
    local wait_time=0
    
    log_info "ç­‰å¾…ä¾èµ–ä»»åŠ¡å®Œæˆ: ${dependencies[*]}"
    
    while [[ $wait_time -lt $max_wait ]]; do
        local all_done=true
        
        for dep in "${dependencies[@]}"; do
            local status_file="$TASK_STATUS_DIR/${dep}.status"
            if [[ ! -f $status_file ]] || [[ $(cat $status_file) != "completed" ]]; then
                all_done=false
                break
            fi
        done
        
        if [[ $all_done == true ]]; then
            log_info "æ‰€æœ‰ä¾èµ–ä»»åŠ¡å·²å®Œæˆ"
            return 0
        fi
        
        sleep 30
        wait_time=$((wait_time + 30))
    done
    
    log_error "ç­‰å¾…ä¾èµ–ä»»åŠ¡è¶…æ—¶"
    return 1
}

# æ›´æ–°ä»»åŠ¡çŠ¶æ€
update_task_status() {
    local task_name=$1
    local status=$2  # running, completed, failed
    local status_file="$TASK_STATUS_DIR/${task_name}.status"
    
    echo $status > $status_file
    log_info "ä»»åŠ¡ $task_name çŠ¶æ€æ›´æ–°ä¸º: $status"
}
```

---

## 7. ğŸ’¾ å¤‡ä»½ä»»åŠ¡æ ‡å‡†æ¨¡æ¿


### 7.1 æ•°æ®åº“å¤‡ä»½æ¨¡æ¿


**ğŸ”´ å¿…é¡»æŒæ¡**ï¼šæ ‡å‡†æ•°æ®åº“å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# æ•°æ®åº“å¤‡ä»½æ ‡å‡†æ¨¡æ¿

# åŸºç¡€é…ç½®
DB_HOST="localhost"
DB_USER="backup_user"
DB_PASS="secure_password"
DB_NAME="production_db"

BACKUP_DIR="/backup/database"
BACKUP_RETENTION_DAYS=7

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ‰§è¡Œå¤‡ä»½
database_backup() {
    local backup_file="$BACKUP_DIR/${DB_NAME}_${DATE}.sql"
    local compressed_file="${backup_file}.gz"
    
    log_info "å¼€å§‹æ•°æ®åº“å¤‡ä»½: $DB_NAME"
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆè‡³å°‘éœ€è¦2GBï¼‰
    if ! check_disk_space $BACKUP_DIR 2; then
        log_error "ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œå¤‡ä»½ç»ˆæ­¢"
        return 1
    fi
    
    # æ‰§è¡Œå¤‡ä»½
    if execute_with_timeout "mysqldump -h$DB_HOST -u$DB_USER -p$DB_PASS --single-transaction --routines --triggers $DB_NAME > $backup_file" 1800; then
        
        # å‹ç¼©å¤‡ä»½æ–‡ä»¶
        if gzip $backup_file; then
            log_info "æ•°æ®åº“å¤‡ä»½å®Œæˆ: $compressed_file"
            
            # éªŒè¯å¤‡ä»½æ–‡ä»¶
            if [[ -f $compressed_file ]] && [[ $(stat -c%s $compressed_file) -gt 1024 ]]; then
                log_info "å¤‡ä»½æ–‡ä»¶éªŒè¯é€šè¿‡"
                return 0
            else
                log_error "å¤‡ä»½æ–‡ä»¶éªŒè¯å¤±è´¥"
                return 1
            fi
        else
            log_error "å¤‡ä»½æ–‡ä»¶å‹ç¼©å¤±è´¥"
            return 1
        fi
    else
        log_error "æ•°æ®åº“å¤‡ä»½å¤±è´¥"
        return 1
    fi
}

# æ¸…ç†æ—§å¤‡ä»½
cleanup_old_backups() {
    log_info "æ¸…ç† $BACKUP_RETENTION_DAYS å¤©å‰çš„å¤‡ä»½æ–‡ä»¶"
    find $BACKUP_DIR -name "${DB_NAME}_*.sql.gz" -mtime +$BACKUP_RETENTION_DAYS -delete
}

# ä¸»æ‰§è¡Œé€»è¾‘
main() {
    create_lock
    
    if database_backup; then
        cleanup_old_backups
        log_info "å¤‡ä»½ä»»åŠ¡å®Œæˆ"
    else
        log_error "å¤‡ä»½ä»»åŠ¡å¤±è´¥"
        exit 1
    fi
}
```

### 7.2 æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½æ¨¡æ¿


```bash
#!/bin/bash
# æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½æ¨¡æ¿

# å¤‡ä»½é…ç½®
SOURCE_DIRS=("/var/www" "/etc" "/home/important")
BACKUP_ROOT="/backup/files"
EXCLUDE_FILE="/etc/backup_exclude.txt"

# å¢é‡å¤‡ä»½å‡½æ•°
incremental_backup() {
    local source_dir=$1
    local backup_name=$(basename $source_dir)
    local backup_dir="$BACKUP_ROOT/$backup_name"
    local snapshot_file="$backup_dir/rsync_snapshot.txt"
    
    mkdir -p $backup_dir
    
    log_info "å¼€å§‹å¢é‡å¤‡ä»½: $source_dir"
    
    # ä½¿ç”¨rsyncè¿›è¡Œå¢é‡å¤‡ä»½
    local rsync_opts="--archive --verbose --compress --delete --partial"
    rsync_opts="$rsync_opts --exclude-from=$EXCLUDE_FILE"
    rsync_opts="$rsync_opts --link-dest=$backup_dir/latest"
    
    local current_backup="$backup_dir/$DATE"
    
    if execute_with_timeout "rsync $rsync_opts $source_dir/ $current_backup/" 7200; then
        # æ›´æ–°latesté“¾æ¥
        rm -f $backup_dir/latest
        ln -s $current_backup $backup_dir/latest
        
        echo "$DATE" > $snapshot_file
        log_info "å¢é‡å¤‡ä»½å®Œæˆ: $current_backup"
        return 0
    else
        log_error "å¢é‡å¤‡ä»½å¤±è´¥: $source_dir"
        return 1
    fi
}
```

---

## 8. ğŸ“Š ç›‘æ§ä»»åŠ¡æ ‡å‡†æ¨¡æ¿


### 8.1 ç³»ç»Ÿç›‘æ§æ¨¡æ¿


**ä»€ä¹ˆæ˜¯ç³»ç»Ÿç›‘æ§ä»»åŠ¡ï¼Ÿ**
å°±åƒåŒ»ç”Ÿå®šæœŸä½“æ£€ä¸€æ ·ï¼Œç³»ç»Ÿç›‘æ§ä»»åŠ¡å®šæœŸæ£€æŸ¥æœåŠ¡å™¨çš„"å¥åº·çŠ¶å†µ"ï¼ŒåŠæ—¶å‘ç°é—®é¢˜ã€‚

```bash
#!/bin/bash
# ç³»ç»Ÿç›‘æ§æ ‡å‡†æ¨¡æ¿

# ç›‘æ§é˜ˆå€¼é…ç½®
CPU_THRESHOLD=80        # CPUä½¿ç”¨ç‡é˜ˆå€¼
MEMORY_THRESHOLD=85     # å†…å­˜ä½¿ç”¨ç‡é˜ˆå€¼  
DISK_THRESHOLD=90       # ç£ç›˜ä½¿ç”¨ç‡é˜ˆå€¼
LOAD_THRESHOLD=5.0      # ç³»ç»Ÿè´Ÿè½½é˜ˆå€¼

# å‘Šè­¦é…ç½®
ALERT_EMAIL="admin@company.com"
ALERT_WEBHOOK="https://hooks.slack.com/xxx"

# CPUç›‘æ§
check_cpu_usage() {
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}')
    
    if (( $(echo "$cpu_usage > $CPU_THRESHOLD" | bc -l) )); then
        log_error "CPUä½¿ç”¨ç‡è¿‡é«˜: ${cpu_usage}%"
        send_alert "CPUå‘Šè­¦" "CPUä½¿ç”¨ç‡: ${cpu_usage}%ï¼Œè¶…è¿‡é˜ˆå€¼: ${CPU_THRESHOLD}%"
        return 1
    else
        log_info "CPUä½¿ç”¨ç‡æ­£å¸¸: ${cpu_usage}%"
        return 0
    fi
}

# å†…å­˜ç›‘æ§
check_memory_usage() {
    local mem_info=$(free | grep Mem)
    local total=$(echo $mem_info | awk '{print $2}')
    local used=$(echo $mem_info | awk '{print $3}')
    local usage=$(( used * 100 / total ))
    
    if [[ $usage -gt $MEMORY_THRESHOLD ]]; then
        log_error "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${usage}%"
        send_alert "å†…å­˜å‘Šè­¦" "å†…å­˜ä½¿ç”¨ç‡: ${usage}%ï¼Œè¶…è¿‡é˜ˆå€¼: ${MEMORY_THRESHOLD}%"
        return 1
    else
        log_info "å†…å­˜ä½¿ç”¨ç‡æ­£å¸¸: ${usage}%"
        return 0
    fi
}

# ç£ç›˜ç›‘æ§
check_disk_usage() {
    local alert_triggered=false
    
    while IFS= read -r line; do
        local usage=$(echo $line | awk '{print $5}' | sed 's/%//')
        local mount_point=$(echo $line | awk '{print $6}')
        
        if [[ $usage -gt $DISK_THRESHOLD ]]; then
            log_error "ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: $mount_point ${usage}%"
            send_alert "ç£ç›˜å‘Šè­¦" "æŒ‚è½½ç‚¹: $mount_pointï¼Œä½¿ç”¨ç‡: ${usage}%ï¼Œè¶…è¿‡é˜ˆå€¼: ${DISK_THRESHOLD}%"
            alert_triggered=true
        else
            log_info "ç£ç›˜ä½¿ç”¨ç‡æ­£å¸¸: $mount_point ${usage}%"
        fi
    done < <(df -h | grep -vE '^Filesystem|tmpfs|cdrom')
    
    [[ $alert_triggered == false ]]
}

# å‘Šè­¦å‘é€å‡½æ•°
send_alert() {
    local subject=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # é‚®ä»¶å‘Šè­¦
    echo "$message" | mail -s "[$timestamp] $subject" $ALERT_EMAIL
    
    # Webhookå‘Šè­¦
    curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"[$timestamp] $subject: $message\"}" \
        $ALERT_WEBHOOK
}
```

### 8.2 æœåŠ¡ç›‘æ§æ¨¡æ¿


```bash
#!/bin/bash
# æœåŠ¡ç›‘æ§æ¨¡æ¿

# éœ€è¦ç›‘æ§çš„æœåŠ¡åˆ—è¡¨
SERVICES=("nginx" "mysql" "redis" "php-fpm")

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_service_status() {
    local service=$1
    
    if systemctl is-active --quiet $service; then
        log_info "æœåŠ¡è¿è¡Œæ­£å¸¸: $service"
        return 0
    else
        log_error "æœåŠ¡å¼‚å¸¸: $service"
        
        # å°è¯•é‡å¯æœåŠ¡
        if systemctl restart $service; then
            log_info "æœåŠ¡é‡å¯æˆåŠŸ: $service"
            send_alert "æœåŠ¡é‡å¯" "æœåŠ¡ $service å·²è‡ªåŠ¨é‡å¯"
            return 0
        else
            log_error "æœåŠ¡é‡å¯å¤±è´¥: $service"
            send_alert "æœåŠ¡æ•…éšœ" "æœåŠ¡ $service é‡å¯å¤±è´¥ï¼Œéœ€è¦äººå·¥å¤„ç†"
            return 1
        fi
    fi
}

# æ£€æŸ¥ç«¯å£ç›‘å¬
check_port_listening() {
    local port=$1
    local service_name=$2
    
    if netstat -ln | grep ":$port " >/dev/null; then
        log_info "ç«¯å£ç›‘å¬æ­£å¸¸: $service_name ($port)"
        return 0
    else
        log_error "ç«¯å£æœªç›‘å¬: $service_name ($port)"
        send_alert "ç«¯å£å‘Šè­¦" "æœåŠ¡ $service_name ç«¯å£ $port æœªç›‘å¬"
        return 1
    fi
}

# ä¸»ç›‘æ§é€»è¾‘
main() {
    local failed_services=()
    
    for service in "${SERVICES[@]}"; do
        if ! check_service_status $service; then
            failed_services+=($service)
        fi
    done
    
    # æ£€æŸ¥å…³é”®ç«¯å£
    check_port_listening 80 "nginx"
    check_port_listening 3306 "mysql"
    check_port_listening 6379 "redis"
    
    # ç³»ç»Ÿèµ„æºæ£€æŸ¥
    check_cpu_usage
    check_memory_usage  
    check_disk_usage
    
    if [[ ${#failed_services[@]} -eq 0 ]]; then
        log_info "æ‰€æœ‰æœåŠ¡è¿è¡Œæ­£å¸¸"
    else
        log_error "å¼‚å¸¸æœåŠ¡: ${failed_services[*]}"
    fi
}
```

---

## 9. ğŸ§¹ æ¸…ç†ä»»åŠ¡æ ‡å‡†æ¨¡æ¿


### 9.1 æ—¥å¿—æ¸…ç†æ¨¡æ¿


**ä¸ºä»€ä¹ˆéœ€è¦æ—¥å¿—æ¸…ç†ï¼Ÿ**
å°±åƒå®¶é‡Œè¦å®šæœŸæ‰“æ‰«ä¸€æ ·ï¼ŒæœåŠ¡å™¨ä¸Šçš„æ—¥å¿—æ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤šï¼Œä¸å®šæœŸæ¸…ç†ä¼šå æ»¡ç£ç›˜ç©ºé—´ã€‚

```bash
#!/bin/bash
# æ—¥å¿—æ¸…ç†æ ‡å‡†æ¨¡æ¿

# æ¸…ç†é…ç½®
LOG_DIRS=("/var/log" "/opt/app/logs" "/home/user/logs")
LOG_RETENTION_DAYS=30
COMPRESSED_LOG_RETENTION_DAYS=90

# æ¸…ç†æ™®é€šæ—¥å¿—æ–‡ä»¶
cleanup_log_files() {
    local log_dir=$1
    local retention_days=$2
    
    if [[ ! -d $log_dir ]]; then
        log_warn "æ—¥å¿—ç›®å½•ä¸å­˜åœ¨: $log_dir"
        return 0
    fi
    
    log_info "å¼€å§‹æ¸…ç†æ—¥å¿—ç›®å½•: $log_dir"
    
    # æŸ¥æ‰¾éœ€è¦æ¸…ç†çš„æ–‡ä»¶
    local files_to_delete=$(find $log_dir -type f -name "*.log" -mtime +$retention_days)
    local delete_count=$(echo "$files_to_delete" | wc -l)
    
    if [[ -n $files_to_delete ]]; then
        log_info "å‡†å¤‡åˆ é™¤ $delete_count ä¸ªæ—¥å¿—æ–‡ä»¶"
        
        # è®¡ç®—é‡Šæ”¾çš„ç©ºé—´
        local space_to_free=$(echo "$files_to_delete" | xargs du -ch | tail -1 | awk '{print $1}')
        log_info "å°†é‡Šæ”¾ç£ç›˜ç©ºé—´: $space_to_free"
        
        # æ‰§è¡Œåˆ é™¤
        echo "$files_to_delete" | xargs rm -f
        log_info "æ—¥å¿—æ¸…ç†å®Œæˆ: $log_dir"
    else
        log_info "æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ—¥å¿—æ–‡ä»¶: $log_dir"
    fi
}

# æ¸…ç†å‹ç¼©æ—¥å¿—
cleanup_compressed_logs() {
    local log_dir=$1
    local retention_days=$2
    
    log_info "æ¸…ç†å‹ç¼©æ—¥å¿—: $log_dir"
    
    # æ¸…ç†.gzæ–‡ä»¶
    find $log_dir -type f -name "*.gz" -mtime +$retention_days -delete
    
    # æ¸…ç†.bz2æ–‡ä»¶  
    find $log_dir -type f -name "*.bz2" -mtime +$retention_days -delete
    
    log_info "å‹ç¼©æ—¥å¿—æ¸…ç†å®Œæˆ: $log_dir"
}

# åº”ç”¨æ—¥å¿—æ¸…ç†
cleanup_application_logs() {
    # Nginxæ—¥å¿—æ¸…ç†
    if [[ -d /var/log/nginx ]]; then
        # é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼ˆé¿å…æ­£åœ¨å†™å…¥çš„æ–‡ä»¶è¢«åˆ é™¤ï¼‰
        nginx -s reopen
        sleep 2
        cleanup_log_files "/var/log/nginx" $LOG_RETENTION_DAYS
    fi
    
    # Apacheæ—¥å¿—æ¸…ç†
    if [[ -d /var/log/apache2 ]]; then
        systemctl reload apache2
        sleep 2
        cleanup_log_files "/var/log/apache2" $LOG_RETENTION_DAYS  
    fi
    
    # MySQLæ…¢æŸ¥è¯¢æ—¥å¿—æ¸…ç†
    if [[ -f /var/log/mysql/slow.log ]]; then
        # å¤‡ä»½å½“å‰æ…¢æŸ¥è¯¢æ—¥å¿—
        cp /var/log/mysql/slow.log /var/log/mysql/slow.log.$(date +%Y%m%d)
        
        # æ¸…ç©ºæ…¢æŸ¥è¯¢æ—¥å¿—
        > /var/log/mysql/slow.log
        
        # æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶
        find /var/log/mysql -name "slow.log.*" -mtime +$LOG_RETENTION_DAYS -delete
    fi
}
```

### 9.2 ä¸´æ—¶æ–‡ä»¶æ¸…ç†æ¨¡æ¿


```bash
#!/bin/bash
# ä¸´æ—¶æ–‡ä»¶æ¸…ç†æ¨¡æ¿

# ä¸´æ—¶ç›®å½•é…ç½®
TEMP_DIRS=("/tmp" "/var/tmp" "/opt/temp")
TEMP_FILE_RETENTION_HOURS=24

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
cleanup_temp_files() {
    local temp_dir=$1
    local retention_hours=$2
    
    if [[ ! -d $temp_dir ]]; then
        return 0
    fi
    
    log_info "æ¸…ç†ä¸´æ—¶ç›®å½•: $temp_dir"
    
    # æ¸…ç†æ™®é€šä¸´æ—¶æ–‡ä»¶ï¼ˆæ’é™¤ç³»ç»Ÿé‡è¦æ–‡ä»¶ï¼‰
    find $temp_dir -type f -mtime +0 -not -path "*/systemd/*" \
        -not -name "*.socket" -not -name ".X*" \
        -exec rm -f {} \;
    
    # æ¸…ç†ç©ºç›®å½•
    find $temp_dir -type d -empty -not -path $temp_dir -delete 2>/dev/null || true
    
    log_info "ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ: $temp_dir"
}

# æ¸…ç†åº”ç”¨ä¸´æ—¶æ–‡ä»¶
cleanup_app_temp() {
    # PHPä¼šè¯æ–‡ä»¶æ¸…ç†
    if [[ -d /var/lib/php/sessions ]]; then
        find /var/lib/php/sessions -name "sess_*" -mtime +1 -delete
        log_info "PHPä¼šè¯æ–‡ä»¶æ¸…ç†å®Œæˆ"
    fi
    
    # ç”¨æˆ·ä¸Šä¼ ä¸´æ—¶æ–‡ä»¶
    if [[ -d /var/www/temp ]]; then
        find /var/www/temp -type f -mtime +0 -delete
        log_info "ç”¨æˆ·ä¸Šä¼ ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"  
    fi
}

# ä¸»æ¸…ç†é€»è¾‘
main() {
    create_lock
    
    # æ¸…ç†ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶
    for temp_dir in "${TEMP_DIRS[@]}"; do
        cleanup_temp_files $temp_dir $TEMP_FILE_RETENTION_HOURS
    done
    
    # æ¸…ç†æ—¥å¿—æ–‡ä»¶
    for log_dir in "${LOG_DIRS[@]}"; do
        cleanup_log_files $log_dir $LOG_RETENTION_DAYS
        cleanup_compressed_logs $log_dir $COMPRESSED_LOG_RETENTION_DAYS
    done
    
    # æ¸…ç†åº”ç”¨ç›¸å…³æ–‡ä»¶
    cleanup_application_logs
    cleanup_app_temp
    
    log_info "ç³»ç»Ÿæ¸…ç†ä»»åŠ¡å®Œæˆ"
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”´ å¿…é¡»æŒæ¡**ï¼š
- **è„šæœ¬è§„èŒƒ**ï¼šæ ‡å‡†çš„è„šæœ¬ç»“æ„ã€ç¯å¢ƒå˜é‡è®¾ç½®ã€æ—¥å¿—è®°å½•
- **é”™è¯¯å¤„ç†**ï¼šé¢„é˜²æ£€æŸ¥ã€å¿«é€Ÿå¤±è´¥ã€è¯¦ç»†è®°å½•ã€èµ„æºæ¸…ç†  
- **é”æ–‡ä»¶æœºåˆ¶**ï¼šé˜²é‡å¤æ‰§è¡Œã€è¿›ç¨‹æ£€æŸ¥ã€è¶…æ—¶æ¸…ç†
- **è¶…æ—¶æ§åˆ¶**ï¼šåˆç†è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢ä»»åŠ¡å¡æ­»
- **èµ„æºé™åˆ¶**ï¼šCPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨æ§åˆ¶

**ğŸŸ¡ å»ºè®®äº†è§£**ï¼š
- **ä¾èµ–ç®¡ç†**ï¼šä»»åŠ¡é—´çš„ä¾èµ–å…³ç³»å¤„ç†
- **ç›‘æ§å‘Šè­¦**ï¼šè‡ªåŠ¨åŒ–ç›‘æ§å’Œé—®é¢˜é€šçŸ¥
- **æ¨¡æ¿ä½¿ç”¨**ï¼šå¤‡ä»½ã€ç›‘æ§ã€æ¸…ç†ä»»åŠ¡æ¨¡æ¿

### 10.2 å®ç”¨æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**ï¼š
```bash
# 1. æ ‡å‡†è„šæœ¬å¼€å¤´
#!/bin/bash
set -e -u -o pipefail
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# 2. å®Œæ•´çš„é”™è¯¯å¤„ç†
trap cleanup_on_exit EXIT
trap cleanup_on_signal TERM INT

# 3. è¯¦ç»†çš„æ—¥å¿—è®°å½•
log_info "$(date) - ä»»åŠ¡å¼€å§‹æ‰§è¡Œ"

# 4. é”æ–‡ä»¶ä¿æŠ¤
create_lock_with_timeout

# 5. èµ„æºä½¿ç”¨æ£€æŸ¥
check_disk_space "/backup" 5
```

**âŒ é¿å…çš„é—®é¢˜**ï¼š
- ä¸è®¾ç½®PATHç¯å¢ƒå˜é‡
- æ²¡æœ‰é”™è¯¯å¤„ç†æœºåˆ¶
- å¿˜è®°æ¸…ç†é”æ–‡ä»¶
- ä¸æ§åˆ¶èµ„æºä½¿ç”¨
- ç¼ºå°‘æ—¥å¿—è®°å½•

### 10.3 æ¨¡æ¿é€‰æ‹©æŒ‡å—


| ä»»åŠ¡ç±»å‹ | **æ¨èæ¨¡æ¿** | **å…³é”®ç‰¹æ€§** | **é€‚ç”¨åœºæ™¯** |
|---------|-------------|-------------|-------------|
| ğŸ—„ï¸ **æ•°æ®åº“å¤‡ä»½** | `å¤‡ä»½ä»»åŠ¡æ¨¡æ¿` | `é”æ–‡ä»¶+è¶…æ—¶+å‹ç¼©+æ¸…ç†` | `å®šæœŸæ•°æ®å¤‡ä»½` |
| ğŸ“ **æ–‡ä»¶å¤‡ä»½** | `å¢é‡å¤‡ä»½æ¨¡æ¿` | `rsync+ç¡¬é“¾æ¥+ç©ºé—´æ£€æŸ¥` | `æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½` |
| ğŸ“Š **ç³»ç»Ÿç›‘æ§** | `ç›‘æ§ä»»åŠ¡æ¨¡æ¿` | `é˜ˆå€¼æ£€æŸ¥+å‘Šè­¦+é‡è¯•` | `ç³»ç»ŸçŠ¶æ€ç›‘æ§` |
| ğŸ§¹ **æ¸…ç†ä»»åŠ¡** | `æ¸…ç†ä»»åŠ¡æ¨¡æ¿` | `æŸ¥æ‰¾+è®¡ç®—+å®‰å…¨åˆ é™¤` | `æ—¥å¿—å’Œä¸´æ—¶æ–‡ä»¶æ¸…ç†` |

### 10.4 è°ƒè¯•å’Œä¼˜åŒ–æŠ€å·§


**ğŸ” è°ƒè¯•æŠ€å·§**ï¼š
```bash
# å¯ç”¨è°ƒè¯•æ¨¡å¼
set -x  # æ˜¾ç¤ºæ‰§è¡Œçš„å‘½ä»¤

# å‡½æ•°æ‰§è¡Œæ—¶é—´ç»Ÿè®¡
time_function() {
    local start_time=$(date +%s)
    "$@"
    local end_time=$(date +%s)
    log_info "å‡½æ•°æ‰§è¡Œæ—¶é—´: $((end_time - start_time))ç§’"
}

# ä½¿ç”¨ç¤ºä¾‹
time_function database_backup
```

**âš¡ æ€§èƒ½ä¼˜åŒ–**ï¼š
- ä½¿ç”¨`nice`å’Œ`ionice`æ§åˆ¶ä¼˜å…ˆçº§
- å‹ç¼©ä¼ è¾“å‡å°‘IOå‹åŠ›
- å¹¶è¡Œæ‰§è¡Œæé«˜æ•ˆç‡
- å¢é‡å¤„ç†å‡å°‘é‡å¤å·¥ä½œ

**ğŸ¯ ä¸€å¥è¯ç²¾å**ï¼š
å®šæ—¶ä»»åŠ¡å°±åƒè‡ªåŠ¨åŒ–çš„ç®¡å®¶ï¼Œæ—¢è¦å‹¤å‹¤æ³æ³å·¥ä½œï¼Œä¹Ÿè¦èªæ˜åœ°é¿å…å‡ºé”™ï¼Œè¿˜è¦åŠæ—¶æ±‡æŠ¥å·¥ä½œæƒ…å†µã€‚

**ğŸ§  è®°å¿†é”šç‚¹**ï¼š
- è„šæœ¬ = è§„èŒƒ + é”™è¯¯å¤„ç† + æ—¥å¿—
- å®‰å…¨ = é”æ–‡ä»¶ + è¶…æ—¶ + èµ„æºé™åˆ¶  
- å®ç”¨ = æ¨¡æ¿ + ç›‘æ§ + æ¸…ç†