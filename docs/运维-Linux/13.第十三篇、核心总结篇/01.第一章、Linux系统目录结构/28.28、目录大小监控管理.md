---
title: 28、目录大小监控管理
---
## 📚 目录

1. [磁盘空间监控基础](#1-磁盘空间监控基础)
2. [du命令深度应用](#2-du命令深度应用)
3. [大文件定位技巧](#3-大文件定位技巧)
4. [目录清理策略](#4-目录清理策略)
5. [磁盘空间告警机制](#5-磁盘空间告警机制)
6. [日志轮转配置](#6-日志轮转配置)
7. [空间回收方法](#7-空间回收方法)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔍 磁盘空间监控基础


### 1.1 为什么要监控目录大小


磁盘空间管理就像管理家里的储物空间一样，如果不及时整理，很快就会被各种杂物占满。在Linux系统中，磁盘空间不足会导致：

> 💡 **关键问题**  
> • 系统无法创建新文件  
> • 应用程序运行异常  
> • 系统日志无法写入  
> • 数据库操作失败

### 1.2 查看磁盘使用情况的基本命令


**`df`命令 - 查看整体磁盘使用情况**

```bash
# 显示人类可读的格式
df -h

# 显示inode使用情况
df -i
```

**输出示例解读：**
```
文件系统        容量  已用  可用 已用% 挂载点
/dev/sda1       20G   15G  4.2G   79% /
/dev/sda2       50G   30G   18G   63% /home
tmpfs           2.0G     0  2.0G    0% /dev/shm
```

> 🔧 **实践提示**  
> 当"已用%"超过80%时就要开始关注，超过90%就比较危险了

**`lsblk`命令 - 查看块设备树状结构**

```
磁盘设备结构示意：
sda                    ← 物理硬盘
├─sda1    20G    /     ← 根分区
└─sda2    50G    /home ← 家目录分区

nvme0n1               ← NVMe固态硬盘
├─nvme0n1p1    1G    /boot
└─nvme0n1p2   100G    /var
```

---

## 2. 🛠️ du命令深度应用


### 2.1 du命令基础用法


**`du`**（disk usage）是查看目录大小的专用命令，就像测量房间里每个柜子占了多少空间。

**基础语法：**
```bash
du [选项] [目录/文件]
```

**常用选项对比表：**

| 选项 | **含义** | **使用场景** | **示例效果** |
|------|----------|--------------|--------------|
| `-h` | **人类可读格式** | `日常查看` | `1.5G 而非 1572864` |
| `-s` | **汇总模式** | `只看总大小` | `显示目录总大小` |
| `-a` | **显示所有文件** | `详细分析` | `包含单个文件大小` |
| `-d` | **限制深度** | `控制显示层级` | `只显示指定层级` |
| `-x` | **不跨越文件系统** | `避免挂载点` | `不统计其他分区` |

### 2.2 实用du命令组合


**快速查看当前目录各子目录大小：**
```bash
du -h --max-depth=1 | sort -hr
```

**查找占用空间最大的前10个目录：**
```bash
du -h | sort -hr | head -10
```

> 💭 **理解要点**  
> `sort -hr` 中的 `-h` 表示按人类可读格式排序，`-r` 表示倒序（从大到小）

**监控特定目录的变化：**
```bash
# 每5秒更新一次目录大小
watch -n 5 "du -sh /var/log"
```

### 2.3 du高级应用技巧


**排除特定目录或文件类型：**

```bash
# 排除.git目录
du -sh --exclude='.git' /home/user/projects

# 排除所有.log文件
du -sh --exclude='*.log' /var/log
```

**按时间查看大小变化：**
```bash
# 显示最近7天修改的文件占用空间
find /home/user -mtime -7 -type f -exec du -ch {} + | tail -1
```

---

## 3. 🎯 大文件定位技巧


### 3.1 快速定位大文件的方法


寻找大文件就像在仓库里找占地方的大箱子，需要有条不紊地搜索。

**方法一：使用find命令按文件大小搜索**

```bash
# 找出大于100MB的文件
find /home -size +100M -type f -ls

# 找出大于1GB的文件，按大小排序
find / -size +1G -type f -exec ls -lh {} \; | sort -k5 -hr
```

**方法二：结合du和find定位目录中的大文件**

```bash
# 找出指定目录下最大的10个文件
find /var/log -type f -exec du -h {} + | sort -hr | head -10
```

### 3.2 大文件分析技巧


**文件大小分布统计：**

```
大文件定位流程图：
开始
  ↓
检查根目录各分区 (df -h)
  ↓
定位占用最大的分区
  ↓
进入该分区查看子目录 (du -h --max-depth=1)
  ↓
逐层深入最大的目录
  ↓
定位具体大文件 (find + ls)
  ↓
分析文件用途和清理策略
```

> ⚠️ **重要提醒**  
> 删除文件前一定要确认文件用途，特别是系统文件和日志文件

**按文件类型统计大小：**

```bash
# 统计各类型文件的总大小
find /home/user -type f | sed 's/.*\.//' | sort | uniq -c | while read count ext
do
    echo ".$ext files: $count"
    find /home/user -name "*.$ext" -type f -exec du -ch {} + | tail -1
done
```

---

## 4. 🧹 目录清理策略


### 4.1 清理策略制定原则


目录清理要像整理房间一样有策略，不能一股脑地删除，也不能放任不管。

**清理优先级表：**

| 优先级 | **文件类型** | **清理策略** | **风险等级** |
|--------|--------------|--------------|--------------|
| **高** | `临时文件` | `立即清理` | `低风险` |
| **高** | `缓存文件` | `定期清理` | `低风险` |
| **中** | `旧日志文件` | `压缩或删除` | `中风险` |
| **中** | `备份文件` | `归档处理` | `中风险` |
| **低** | `用户数据` | `谨慎处理` | `高风险` |
| **低** | `系统文件` | `禁止删除` | `极高风险` |

### 4.2 常见目录清理方法


**清理系统临时文件：**

```bash
# 清理/tmp目录（系统重启时也会自动清理）
sudo find /tmp -type f -atime +7 -delete

# 清理用户临时文件
rm -rf ~/.cache/*
rm -rf ~/.tmp/*
```

**清理包管理器缓存：**

```bash
# Ubuntu/Debian系统
sudo apt clean
sudo apt autoclean

# CentOS/RHEL系统
sudo yum clean all

# 查看清理效果
df -h
```

> 💡 **清理小贴士**  
> 清理前后使用 `df -h` 对比，可以看到实际释放了多少空间

### 4.3 安全清理脚本


**创建安全的清理脚本：**

```bash
#!/bin/bash
# 目录清理脚本

LOG_FILE="/var/log/disk_cleanup.log"
THRESHOLD=90

# 检查磁盘使用率
check_disk_usage() {
    usage=$(df / | awk 'END{print $(NF-1)}' | sed 's/%//')
    if [ $usage -gt $THRESHOLD ]; then
        echo "$(date): 磁盘使用率 ${usage}%，开始清理" >> $LOG_FILE
        return 0
    else
        echo "$(date): 磁盘使用率 ${usage}%，无需清理" >> $LOG_FILE
        return 1
    fi
}

# 执行清理
if check_disk_usage; then
    # 清理操作
    find /tmp -type f -atime +3 -delete
    find /var/log -name "*.log" -mtime +30 -delete
fi
```

---

## 5. 🚨 磁盘空间告警机制


### 5.1 建立监控告警系统


磁盘空间监控就像给仓库装个报警器，空间不足时及时通知管理员。

**简单的告警脚本：**

```bash
#!/bin/bash
# 磁盘空间监控脚本

THRESHOLD=85
EMAIL="admin@company.com"

check_disk_space() {
    df -h | grep -vE '^Filesystem|tmpfs|cdrom' | awk '{print $5 " " $1}' | while read output;
    do
        usage=$(echo $output | awk '{print $1}' | cut -d'%' -f1)
        partition=$(echo $output | awk '{print $2}')
        
        if [ $usage -ge $THRESHOLD ]; then
            echo "警告：分区 $partition 使用率达到 ${usage}%"
            # 发送邮件告警（需要配置邮件系统）
            # echo "分区 $partition 空间不足" | mail -s "磁盘空间告警" $EMAIL
        fi
    done
}
```

### 5.2 监控配置详解


**使用cron定时监控：**

```bash
# 编辑定时任务
crontab -e

# 每小时检查一次磁盘空间
0 * * * * /path/to/disk_monitor.sh

# 每天早上8点发送磁盘空间报告
0 8 * * * df -h | mail -s "每日磁盘报告" admin@company.com
```

> 📅 **定时规则说明**  
> `0 * * * *` 表示每小时的第0分钟执行  
> `0 8 * * *` 表示每天早上8点执行

**监控指标设定：**

```
磁盘空间告警级别：
正常     ：0-70%    ← 绿色，正常运行
注意     ：71-80%   ← 黄色，开始关注  
警告     ：81-90%   ← 橙色，需要清理
危险     ：91-95%   ← 红色，紧急处理
严重     ：96-100%  ← 紫色，立即行动
```

---

## 6. 📋 日志轮转配置


### 6.1 日志轮转的作用


日志轮转就像定期更换笔记本，旧的归档保存，新的继续记录，防止单个日志文件过大。

**logrotate配置文件位置：**
- 主配置文件：`/etc/logrotate.conf`
- 应用配置目录：`/etc/logrotate.d/`

### 6.2 logrotate配置详解


**基本配置语法：**

```bash
# /etc/logrotate.d/myapp
/var/log/myapp/*.log {
    daily                 # 每天轮转
    rotate 30            # 保留30个历史文件
    compress             # 压缩旧文件
    delaycompress        # 延迟压缩（下次轮转时压缩）
    missingok            # 文件丢失不报错
    notifempty           # 空文件不轮转
    copytruncate         # 复制后清空（不重启服务）
}
```

**配置选项对比表：**

| 选项 | **作用** | **适用场景** |
|------|----------|--------------|
| `daily/weekly/monthly` | **轮转频率** | `根据日志产生量选择` |
| `size 100M` | **按大小轮转** | `日志增长不规律时` |
| `rotate 10` | **保留文件数** | `平衡存储空间和历史需求` |
| `compress` | **压缩存储** | `节省磁盘空间` |
| `copytruncate` | **不重启服务** | `应用无法重新加载日志文件` |

### 6.3 常见应用的日志轮转配置


**Apache日志轮转：**

```bash
# /etc/logrotate.d/apache
/var/log/apache2/*.log {
    weekly
    rotate 52
    compress
    delaycompress
    missingok
    notifempty
    postrotate
        /etc/init.d/apache2 reload > /dev/null
    endscript
}
```

**自定义应用日志轮转：**

```bash
# /etc/logrotate.d/custom-app
/var/log/custom-app/app.log {
    size 50M
    rotate 5
    compress
    notifempty
    copytruncate
    postrotate
        echo "$(date): 日志已轮转" >> /var/log/logrotate.log
    endscript
}
```

> 🔧 **配置测试**  
> 使用 `logrotate -d /etc/logrotate.d/配置文件` 可以测试配置是否正确

---

## 7. 🔄 空间回收方法


### 7.1 文件删除后空间不释放的问题


有时候删除了文件，但磁盘空间没有释放，这通常是因为有进程还在使用这些文件。

**检查被删除但仍被占用的文件：**

```bash
# 查看被删除但仍在使用的文件
lsof | grep deleted

# 查看占用空间最大的已删除文件
lsof | grep deleted | sort -k7 -nr
```

**释放被占用的文件空间：**

```bash
# 方法1：重启相关服务
sudo systemctl restart 服务名

# 方法2：向进程发送信号让其重新打开文件
sudo kill -USR1 进程ID

# 方法3：清空文件内容而不删除文件
> /path/to/large/logfile
```

### 7.2 系统缓存清理


**清理页面缓存：**

```bash
# 清理页面缓存
echo 1 > /proc/sys/vm/drop_caches

# 清理目录项和inode缓存
echo 2 > /proc/sys/vm/drop_caches

# 清理所有缓存
echo 3 > /proc/sys/vm/drop_caches
```

> ⚠️ **注意事项**  
> 清理缓存会临时降低系统性能，建议在系统负载较低时操作

### 7.3 回收站和意外删除恢复


**创建安全删除函数：**

```bash
# 在.bashrc中添加安全删除函数
trash() {
    local trash_dir="$HOME/.trash/$(date +%Y%m%d)"
    mkdir -p "$trash_dir"
    mv "$@" "$trash_dir/"
    echo "文件已移动到回收站: $trash_dir"
}

# 清理回收站
clean_trash() {
    find "$HOME/.trash" -type f -mtime +30 -delete
    find "$HOME/.trash" -type d -empty -delete
}
```

**意外删除恢复工具：**

```bash
# 安装文件恢复工具
sudo apt install testdisk photorec extundelete

# 使用extundelete恢复ext4文件系统的文件
sudo extundelete /dev/sda1 --restore-file path/to/deleted/file
```

---

## 8. 📝 核心要点总结


### 8.1 必须掌握的基本概念


```
🔸 磁盘监控：使用df查看整体，du查看目录，lsof查看占用
🔸 大文件定位：find命令按大小搜索，结合sort排序分析
🔸 清理策略：分优先级，临时文件优先，系统文件禁碰
🔸 告警机制：设置阈值监控，定时检查，及时通知
🔸 日志轮转：定期归档日志，压缩存储，控制文件数量
🔸 空间回收：处理删除后未释放的空间，清理系统缓存
```

### 8.2 关键理解要点


> 💡 **监控思维**  
> 磁盘空间监控要像体检一样定期进行，预防胜于治疗

> 🎯 **清理原则**  
> 清理要有计划有步骤，先临时后永久，先备份后删除

> ⚡ **效率技巧**  
> 善用命令组合，一行命令解决复杂问题

### 8.3 实际应用指南


**日常维护检查单：**

- [ ] 每周检查磁盘使用率 (`df -h`)
- [ ] 每月清理临时文件和缓存
- [ ] 季度检查日志轮转配置
- [ ] 半年审查大文件和无用文件
- [ ] 年度制定磁盘扩容计划

**应急处理流程：**

```
磁盘空间告急处理流程：
磁盘使用率>90%
       ↓
立即定位最大占用目录 (du -h --max-depth=1)
       ↓
清理临时文件和缓存
       ↓
检查已删除但未释放的文件 (lsof | grep deleted)
       ↓
重启相关服务释放空间
       ↓
如仍不足，联系管理员扩容
```

**最佳实践建议：**

> 📋 **实用建议**  
> • 建立定期监控机制，不要等到空间不足才处理  
> • 重要数据清理前一定要备份  
> • 了解系统各目录的作用，避免误删  
> • 合理配置日志轮转，平衡存储和追溯需求

**核心记忆口诀：**
- 监控在先防患未然，定位精准对症下药
- 清理有序安全第一，轮转配置省心省力
- 空间回收细致入微，应急处理有条不紊