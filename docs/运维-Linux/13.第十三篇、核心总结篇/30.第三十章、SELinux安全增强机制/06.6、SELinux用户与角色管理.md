---
title: 6、SELinux用户与角色管理
---
## 📚 目录

1. [SELinux用户与Linux用户的区别](#1-selinux用户与linux用户的区别)
2. [用户映射关系管理](#2-用户映射关系管理)
3. [SELinux角色机制详解](#3-selinux角色机制详解)
4. [用户角色切换操作](#4-用户角色切换操作)
5. [用户上下文配置管理](#5-用户上下文配置管理)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🔐 SELinux用户与Linux用户的区别


### 1.1 基本概念理解


> 💡 **核心理解**：SELinux用户和Linux用户是两套完全不同的用户体系，就像身份证和驾照的区别。

**Linux用户系统**：
```
用途：控制文件访问权限
特点：基于UID/GID的传统权限控制
例子：root、普通用户、服务用户
```

**SELinux用户系统**：
```
用途：强制访问控制的安全标签
特点：基于安全上下文的访问控制
例子：unconfined_u、staff_u、user_u
```

### 1.2 两套用户系统的关系


```
┌─ Linux系统 ─────────────┐    ┌─ SELinux系统 ─────────────┐
│                         │    │                           │
│ Linux用户: root         │───▶│ SELinux用户: unconfined_u │
│ Linux用户: alice        │───▶│ SELinux用户: user_u       │
│ Linux用户: webserver    │───▶│ SELinux用户: system_u     │
│                         │    │                           │
└─────────────────────────┘    └───────────────────────────┘

映射关系：一个Linux用户 → 一个SELinux用户
```

> 📌 **重要提醒**：Linux用户负责"谁能访问"，SELinux用户负责"能访问什么类型的资源"。

### 1.3 常见的SELinux用户类型


| SELinux用户 | **用途说明** | **权限特点** | **常见映射** |
|-------------|-------------|-------------|-------------|
| **unconfined_u** | `不受SELinux限制的用户` | `几乎无限制` | `root、管理员用户` |
| **user_u** | `受限制的普通用户` | `严格限制，只能基本操作` | `一般用户账号` |
| **staff_u** | `半管理员用户` | `比user_u权限大，但受限制` | `技术人员账号` |
| **system_u** | `系统服务用户` | `只能运行系统服务` | `系统守护进程` |
| **sysadm_u** | `系统管理员用户` | `管理权限，但比unconfined_u受限` | `专业管理员` |

---

## 2. 🔗 用户映射关系管理


### 2.1 查看用户映射关系


**查看当前用户的SELinux身份**：
```bash
# 查看当前用户的SELinux上下文
id -Z
# 输出示例：unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

# 查看所有用户映射关系
semanage login -l
```

**典型映射关系示例**：
```
Login Name           SELinux User         MLS/MCS Range        Service
__default__          unconfined_u         s0-s0:c0.c1023       *
root                 unconfined_u         s0-s0:c0.c1023       *
system_u             system_u             s0-s0:c0.c1023       *
```

> 💭 **生活类比**：就像公司员工卡和门禁卡的关系，员工卡识别你是谁，门禁卡决定你能进哪些房间。

### 2.2 使用semanage管理用户映射


**添加用户映射**：
```bash
# 将Linux用户alice映射到SELinux用户user_u
semanage login -a -s user_u alice

# 为用户指定MLS范围
semanage login -a -s staff_u -r s0-s2 bob
```

**修改用户映射**：
```bash
# 修改alice的SELinux用户映射
semanage login -m -s staff_u alice

# 修改默认用户映射
semanage login -m -s user_u __default__
```

**删除用户映射**：
```bash
# 删除特定用户映射
semanage login -d alice

# 用户将回到默认映射
```

### 2.3 映射配置实战示例


```bash
# 🎯 实际场景：配置Web服务器用户权限

# 1. 查看当前apache用户映射
semanage login -l | grep apache

# 2. 将apache用户映射到system_u（系统用户）
semanage login -a -s system_u apache

# 3. 验证映射结果
semanage login -l | grep apache
# 输出：apache    system_u    s0    *

# 4. 重启服务使配置生效
systemctl restart httpd
```

---

## 3. ⚔️ SELinux角色机制详解


### 3.1 角色的概念与作用


> 🔍 **深入理解**：角色就像职位，决定用户能执行什么类型的操作。

**角色的本质**：
```
作用：连接用户和类型的桥梁
格式：用户:角色:类型:MLS级别
意义：不同角色有不同的权限范围
```

### 3.2 常见SELinux角色


**系统预定义角色**：

| 角色名 | **适用用户** | **权限描述** | **典型场景** |
|--------|-------------|-------------|-------------|
| **unconfined_r** | `unconfined_u` | `不受限制，可执行任何操作` | `系统管理员日常工作` |
| **user_r** | `user_u, staff_u` | `基本用户操作，不能切换角色` | `普通用户登录使用` |
| **staff_r** | `staff_u` | `用户操作+部分管理功能` | `技术支持人员` |
| **sysadm_r** | `staff_u, sysadm_u` | `系统管理权限` | `执行管理任务` |
| **system_r** | `system_u` | `系统服务运行` | `守护进程运行` |

### 3.3 角色与权限的关系


```
权限层次结构：
┌─────────────┐
│ unconfined_r │ ← 最高权限，几乎无限制
├─────────────┤
│   sysadm_r   │ ← 系统管理权限
├─────────────┤
│   staff_r    │ ← 扩展用户权限
├─────────────┤
│    user_r    │ ← 基本用户权限
├─────────────┤
│   system_r   │ ← 系统服务专用
└─────────────┘
```

> 📌 **关键理解**：角色决定了用户能"变身"成什么身份去执行操作。

---

## 4. 🔄 用户角色切换操作


### 4.1 newrole命令基础


**newrole命令的作用**：
```
功能：在当前会话中切换SELinux角色
场景：需要执行特定权限操作时
限制：只能切换到用户被允许的角色
```

### 4.2 角色切换实操


**基本切换命令**：
```bash
# 查看当前角色
id -Z
# unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

# 切换到系统管理员角色（如果被允许）
newrole -r sysadm_r

# 切换时指定类型
newrole -r sysadm_r -t sysadm_t

# 退出角色（回到原来的shell）
exit
```

**带密码验证的角色切换**：
```bash
# 切换到需要认证的角色
newrole -r sysadm_r
# 系统会提示输入当前用户密码进行验证
```

### 4.3 角色切换的限制机制


```
角色切换规则矩阵：
┌─────────────┬─────────────┬─────────────┬─────────────┐
│ 当前角色    │ 目标角色    │ 是否允许    │ 需要密码    │
├─────────────┼─────────────┼─────────────┼─────────────┤
│ staff_r     │ sysadm_r    │ ✅ 允许     │ ✅ 需要     │
│ user_r      │ sysadm_r    │ ❌ 禁止     │ -           │
│ unconfined_r│ 任何角色    │ ✅ 允许     │ 可选        │
│ system_r    │ 其他角色    │ ❌ 禁止     │ -           │
└─────────────┴─────────────┴─────────────┴─────────────┘
```

### 4.4 实际应用场景


```bash
# 🎯 典型工作流程：日常用户需要执行管理任务

# 1. 查看当前身份（普通用户角色）
id -Z
# staff_u:staff_r:staff_t:s0

# 2. 尝试执行管理命令（被拒绝）
semanage port -l
# Permission denied

# 3. 切换到管理员角色
newrole -r sysadm_r
# 输入密码验证身份

# 4. 验证角色切换成功
id -Z
# staff_u:sysadm_r:sysadm_t:s0

# 5. 现在可以执行管理命令
semanage port -l
# 成功执行

# 6. 完成任务后退出管理角色
exit
# 回到原来的staff_r角色
```

---

## 5. ⚙️ 用户上下文配置管理


### 5.1 默认用户上下文配置


**配置文件位置**：
```
主配置文件：/etc/selinux/targeted/contexts/default_contexts
用户配置：/etc/selinux/targeted/contexts/users/
```

**查看默认上下文配置**：
```bash
# 查看系统默认上下文配置
cat /etc/selinux/targeted/contexts/default_contexts

# 查看特定用户的默认上下文
semanage user -l
```

### 5.2 用户上下文范围设置


**MLS/MCS范围说明**：
```
格式：s0-s15:c0.c1023
含义：安全级别范围和类别范围
s0：最低安全级别
s15：最高安全级别（如果启用MLS）
c0.c1023：类别范围
```

**设置用户MLS范围**：
```bash
# 为用户设置特定的安全级别范围
semanage login -m -s staff_u -r s0-s2:c0.c100 alice

# 查看设置结果
semanage login -l | grep alice
```

### 5.3 自定义用户上下文配置


**创建自定义SELinux用户**：
```bash
# 1. 创建新的SELinux用户类型
semanage user -a -R "staff_r sysadm_r" -r s0-s2 mycompany_u

# 2. 查看创建的用户
semanage user -l | grep mycompany_u

# 3. 将Linux用户映射到自定义SELinux用户
semanage login -a -s mycompany_u alice
```

**用户权限范围配置**：
```bash
# 查看用户可用角色
semanage user -l
# Name                Labeling   MLS/       MLS/                          
# SELinux User        Prefix     MCS Level  MCS Range                      SELinux Roles
# staff_u             user       s0         s0-s0:c0.c1023                staff_r sysadm_r
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的基本概念


> 🧠 **记忆口诀**：用户映射定身份，角色切换授权限，上下文配置控范围。

```
🔸 双重用户系统：Linux用户负责传统权限，SELinux用户负责强制访问控制
🔸 映射关系：通过semanage login管理Linux用户到SELinux用户的映射
🔸 角色机制：角色是用户和类型之间的桥梁，决定操作权限范围
🔸 角色切换：使用newrole命令在会话中切换角色，需要相应权限
🔸 上下文配置：包括用户、角色、类型和MLS级别的完整安全标签
```

### 6.2 关键操作命令总结


| 操作类型 | **核心命令** | **主要用途** | **示例** |
|----------|-------------|-------------|----------|
| **查看身份** | `id -Z` | `查看当前SELinux上下文` | `unconfined_u:unconfined_r:unconfined_t` |
| **映射管理** | `semanage login` | `管理用户映射关系` | `semanage login -a -s user_u alice` |
| **角色切换** | `newrole` | `切换SELinux角色` | `newrole -r sysadm_r` |
| **用户管理** | `semanage user` | `管理SELinux用户类型` | `semanage user -l` |

### 6.3 实际应用价值


**🎯 日常运维场景**：
- **权限分离**：不同用户具有不同的SELinux权限范围
- **安全提升**：即使获得root权限，仍受SELinux用户限制
- **精细控制**：通过角色机制实现更细粒度的权限管理
- **合规要求**：满足军用级别的安全访问控制标准

**🔧 最佳实践建议**：
```
1. 新用户默认映射到user_u，限制权限范围
2. 管理员使用staff_u，需要时切换到sysadm_r
3. 系统服务统一使用system_u，避免权限泄露
4. 定期审查用户映射关系，清理不必要的高权限映射
5. 为敏感操作建立角色切换流程，确保操作可追溯
```

**📚 学习检查清单**：
- [ ] 理解Linux用户与SELinux用户的区别
- [ ] 掌握semanage login命令的使用
- [ ] 了解常见SELinux角色的权限范围  
- [ ] 能够使用newrole命令切换角色
- [ ] 理解用户上下文的完整格式
- [ ] 知道如何配置用户MLS范围

**核心记忆**：
- SELinux用户与角色管理是强制访问控制的基础
- 映射关系决定用户身份，角色决定操作权限
- 合理的用户角色配置是系统安全的重要保障
- 掌握这些机制有助于构建更安全的Linux系统