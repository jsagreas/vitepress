---
title: 6、pstree进程树查看
---
## 📚 目录

1. [pstree基本概念](#1-pstree基本概念)
2. [进程层次结构理解](#2-进程层次结构理解)
3. [基本显示选项](#3-基本显示选项)
4. [进程关系追踪](#4-进程关系追踪)
5. [高级显示控制](#5-高级显示控制)
6. [实际应用场景](#6-实际应用场景)
7. [故障排查应用](#7-故障排查应用)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🌳 pstree基本概念


### 1.1 什么是pstree


**简单理解**：pstree就像给你画一张"家族谱"，但这个家族是Linux系统中的进程家族。

想象一下，你家里有爷爷、爸爸、你、还有你的孩子，他们之间有明确的辈分关系。Linux系统中的进程也是这样，有父进程、子进程、孙进程等层次关系。pstree就是专门用来显示这种关系的工具。

```
传统ps命令显示：
PID   PPID  CMD
1     0     systemd
1234  1     sshd
1235  1234  bash
1236  1235  vim

pstree显示效果：
systemd─┬─sshd───bash───vim
        ├─NetworkManager
        └─other processes
```

### 1.2 为什么需要pstree


**解决的核心问题**：
- **关系可视化**：直观看到进程之间的父子关系
- **问题追踪**：快速找到问题进程的源头
- **资源分析**：了解哪个父进程产生了大量子进程
- **系统理解**：更好地理解系统运行机制

### 1.3 安装pstree


在大多数Linux发行版中，pstree通常已经预装：

```bash
# 检查是否已安装
which pstree

# Ubuntu/Debian安装（如果未安装）
sudo apt install psmisc

# CentOS/RHEL安装
sudo yum install psmisc
```

---

## 2. 🏗️ 进程层次结构理解


### 2.1 Linux进程家族树


在Linux系统中，所有进程都形成一个巨大的家族树，就像这样：

```
Linux进程树结构：
init(1) 或 systemd(1) ← 系统老祖宗
├─ kernel threads     ← 内核线程家族
├─ systemd services   ← 系统服务家族  
│  ├─ NetworkManager
│  ├─ sshd
│  └─ apache2
├─ user login shells  ← 用户登录家族
│  ├─ bash
│  │  ├─ vim
│  │  └─ python script
│  └─ another bash
└─ desktop processes  ← 桌面环境家族
   ├─ gnome-shell
   ├─ firefox
   └─ terminal
```

### 2.2 进程关系类型


**父子关系特点**：

🔸 **父进程（Parent Process）**
- 创建子进程的进程
- 负责管理子进程生命周期
- 回收子进程资源

🔸 **子进程（Child Process）**  
- 由父进程创建的进程
- 继承父进程的某些属性
- 可以创建自己的子进程

🔸 **孤儿进程（Orphan Process）**
- 父进程已经结束的子进程
- 会被init/systemd进程收养
- 成为系统进程的直接子进程

### 2.3 进程树的实际意义


**理解进程关系的重要性**：

```
实际场景举例：
Web服务器启动过程
systemd 启动 apache2 主进程
apache2 主进程 创建多个工作进程
每个工作进程 处理用户请求

如果网站出现问题：
通过pstree可以看到：
- apache2主进程是否正常
- 有多少个工作进程在运行  
- 是否有进程异常退出
- 哪个用户的进程占用资源过多
```

---

## 3. 📊 基本显示选项


### 3.1 最简单的使用


直接运行pstree，显示系统完整的进程树：

```bash
pstree
```

**输出示例解读**：
```
systemd─┬─ModemManager───2*[{ModemManager}]
        ├─NetworkManager───2*[{NetworkManager}]
        ├─accounts-daemon───2*[{accounts-daemon}]
        ├─apache2───5*[apache2]
        ├─bash───pstree
        └─sshd───sshd───bash───vim

符号含义：
─ 表示父子关系连线
┬ 表示有多个子进程
├ 表示中间的子进程
└ 表示最后一个子进程
5*[apache2] 表示有5个相同的apache2子进程
```

### 3.2 显示进程ID


**-p选项**：显示每个进程的PID号

```bash
pstree -p
```

**为什么显示PID重要**：
- **精确识别**：相同名称的进程可通过PID区分
- **操作目标**：kill、nice等命令需要PID
- **监控跟踪**：结合其他工具监控特定进程

```
输出效果：
systemd(1)─┬─ModemManager(756)─┬─{ModemManager}(791)
           │                   └─{ModemManager}(794)
           ├─NetworkManager(732)─┬─{NetworkManager}(743)
           │                     └─{NetworkManager}(746)
           └─sshd(1234)───sshd(5678)───bash(5679)
```

### 3.3 显示完整命令行


**-a选项**：显示进程的完整命令行参数

```bash
pstree -a
```

**实用价值**：
- **参数识别**：看到进程启动时的具体参数
- **配置检查**：确认服务使用的配置文件路径
- **调试帮助**：了解程序如何被调用

```
输出效果：
systemd --switched-root --system --deserialize 22
├─NetworkManager --no-daemon
├─apache2 -D FOREGROUND
│   ├─apache2 -D FOREGROUND
│   └─apache2 -D FOREGROUND
└─sshd -D
    └─sshd: user@pts/0
        └─bash
            └─vim /etc/hosts
```

### 3.4 紧凑显示模式


**-c选项**：不显示相同进程的合并信息

```bash
pstree -c
```

这样每个进程都单独显示，而不是用`5*[apache2]`的方式合并显示。

---

## 4. 🔍 进程关系追踪


### 4.1 追踪特定用户的进程


**按用户过滤显示**：

```bash
# 显示特定用户的进程树
pstree username

# 显示当前用户的进程树  
pstree $USER

# 显示root用户的进程树
pstree root
```

**实际应用场景**：
- **用户行为分析**：查看某用户运行了哪些程序
- **资源占用调查**：确认用户进程的层次结构
- **权限问题排查**：看用户进程的启动路径

### 4.2 追踪特定进程及其子进程


**从指定进程开始显示进程树**：

```bash
# 从指定PID开始显示
pstree 1234

# 从指定进程名开始显示
pstree sshd

# 组合选项使用
pstree -p sshd  # 显示sshd及其子进程的PID
```

### 4.3 高亮显示特定进程


**-H选项**：高亮显示指定的进程

```bash
# 高亮显示指定PID的进程
pstree -H 1234

# 高亮显示当前shell进程
pstree -H $$
```

这个功能在复杂的进程树中快速定位目标进程非常有用。

### 4.4 显示线程信息


**-T选项**：显示线程而不仅仅是进程

```bash
pstree -T
```

**线程vs进程的区别**：
- **进程**：独立的执行单元，有自己的内存空间
- **线程**：进程内部的执行单元，共享进程内存

```
不显示线程：
apache2───5*[apache2]

显示线程：
apache2─┬─apache2
        ├─apache2─┬─{apache2}
        │         └─{apache2}
        ├─apache2─┬─{apache2}
        │         └─{apache2}
        └─apache2
```

---

## 5. ⚙️ 高级显示控制


### 5.1 组合选项使用


**最实用的组合**：

```bash
# 显示完整信息：PID + 命令行参数
pstree -ap

# 显示用户进程树，包含PID和完整命令
pstree -ap username

# 高亮特定进程，显示PID
pstree -Hp 1234
```

### 5.2 输出格式控制


**-A选项**：使用ASCII字符绘制树结构

```bash
pstree -A
```

当终端不支持Unicode字符时，用ASCII字符替代：
```
systemd-+-ModemManager-+-{ModemManager}
        |               `-{ModemManager}
        |-NetworkManager-+-{NetworkManager}
        |                `-{NetworkManager}
        `-sshd---sshd---bash---vim
```

### 5.3 数值排序显示


**-n选项**：按PID数值排序显示子进程

```bash
pstree -n
```

这样可以按进程创建顺序（PID大小）来排列，有助于理解进程创建时序。

### 5.4 进程统计信息


使用pstree时结合其他命令获取更多信息：

```bash
# 统计某个用户的进程数量
pstree username | wc -l

# 查看进程树并统计特定进程数量
pstree | grep -c "apache2"

# 保存进程树到文件
pstree -ap > process_tree.txt
```

---

## 6. 💼 实际应用场景


### 6.1 Web服务器管理


**场景**：管理Apache/Nginx Web服务器

```bash
# 查看Web服务器进程结构
pstree -ap | grep -E "(apache2|nginx|httpd)"

# 检查Web服务器是否正常启动
pstree apache2

# 统计Web服务器工作进程数量
pstree -c apache2 | grep apache2 | wc -l
```

**分析要点**：
- 主进程是否正常运行
- 工作进程数量是否合理
- 是否有异常的子进程

### 6.2 数据库服务监控


**场景**：监控MySQL/PostgreSQL数据库

```bash
# 查看MySQL进程树
pstree mysqld

# 检查PostgreSQL主进程及子进程
pstree -ap postgres

# 查看数据库连接进程
pstree -p `pgrep mysqld`
```

### 6.3 SSH连接管理


**场景**：管理远程SSH连接

```bash
# 查看所有SSH连接
pstree sshd

# 查看特定用户的SSH会话
pstree -ap | grep "sshd.*username"

# 检查SSH会话中运行的程序
pstree -ap `pgrep -f "sshd.*pts"`
```

**实际输出示例**：
```
sshd─┬─sshd───bash───htop
     ├─sshd───bash───vim
     └─sshd───sftp-server
```

从这个输出可以看到：
- 有3个SSH连接
- 一个用户在运行htop监控系统
- 一个用户在编辑文件
- 一个是SFTP文件传输连接

### 6.4 桌面环境分析


**场景**：分析桌面环境进程结构

```bash
# 查看图形界面相关进程
pstree -ap | grep -E "(gnome|kde|xorg|wayland)"

# 查看浏览器进程树
pstree firefox

# 检查终端模拟器及其子进程
pstree gnome-terminal
```

---

## 7. 🚨 故障排查应用


### 7.1 资源占用问题排查


**场景**：系统CPU或内存使用率异常高

**排查步骤**：

1. **确定问题进程**：
```bash
# 找出CPU占用高的进程
top -n1 | head -20

# 查看该进程的完整进程树
pstree -ap suspicious_pid
```

2. **分析进程关系**：
```bash
# 查看是否有父进程持续创建子进程
pstree -c problematic_process

# 检查进程启动命令和参数
pstree -a problematic_process
```

### 7.2 僵尸进程清理


**什么是僵尸进程**：
子进程已经结束，但父进程还没有清理它的状态信息，这样的进程叫僵尸进程。

**识别和处理**：
```bash
# 查看系统中的僵尸进程
ps aux | grep -i defunct

# 通过进程树找到僵尸进程的父进程
pstree -p | grep defunct

# 清理僵尸进程（通常需要重启父进程）
kill -CHLD parent_pid
```

### 7.3 服务启动问题诊断


**场景**：某个服务无法正常启动

```bash
# 检查服务进程是否存在
pstree service_name

# 如果存在，查看其完整信息
pstree -ap service_name

# 检查父进程是否正常
pstree -p | grep service_name
```

**常见问题分析**：
- 服务进程没有出现：启动脚本问题
- 进程存在但立即退出：配置文件错误
- 子进程异常：权限或依赖问题

### 7.4 用户会话异常分析


**场景**：用户登录后会话异常

```bash
# 查看用户完整的进程树
pstree -ap username

# 检查登录shell和启动的程序
pstree -H $$ -ap

# 对比正常用户的进程树
pstree -ap normal_user
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基本概念


```
🔸 pstree作用：可视化显示Linux系统进程的层次关系
🔸 进程树结构：从init/systemd根进程开始的完整家族树
🔸 父子关系：理解进程创建和管理的层次机制
🔸 显示选项：-p显示PID，-a显示完整命令，-u显示用户
🔸 过滤功能：可以指定用户或进程来限制显示范围
🔸 实用价值：系统监控、问题排查、服务管理的重要工具
```

### 8.2 关键理解要点


**🔹 为什么进程树很重要**：
```
系统理解：
• 清晰看到系统服务的启动层次
• 理解用户程序的运行环境
• 掌握进程间的依赖关系

问题诊断：
• 快速定位问题进程的来源
• 分析异常进程的创建路径
• 找到需要重启的父进程
```

**🔹 如何高效使用pstree**：
```
日常监控：
• pstree -ap 查看完整系统状态
• pstree username 检查特定用户活动
• pstree service_name 监控服务状态

故障排查：
• pstree -p 获取精确的进程ID
• pstree -H pid 高亮显示目标进程
• pstree -c 查看完整的进程展开
```

**🔹 与其他工具的配合**：
```
工具组合：
• ps + pstree：静态信息 + 关系结构
• top + pstree：动态监控 + 层次分析  
• kill + pstree：进程终止 + 影响范围
• systemctl + pstree：服务管理 + 运行状态
```

### 8.3 实际应用价值


**💼 系统管理应用**：
- **服务监控**：检查Web服务器、数据库等关键服务状态
- **用户管理**：了解用户登录后的活动情况
- **资源分析**：找出创建大量子进程的父进程
- **安全审计**：追踪可疑进程的启动路径

**🛠️ 故障排查应用**：
- **性能问题**：定位高CPU/内存使用的进程来源
- **僵尸进程**：找到需要处理的父进程
- **服务异常**：分析服务启动失败的原因
- **会话问题**：排查用户登录异常

**🎯 学习建议**：
```
实践练习：
1. 在自己的系统上运行pstree，熟悉基本输出
2. 尝试不同的选项组合，观察显示差异
3. 启动一些程序，用pstree观察进程关系变化
4. 模拟问题场景，练习故障排查流程

进阶学习：
• 结合ps、top等工具综合分析
• 学习shell脚本自动化进程监控
• 了解systemd服务管理机制
• 掌握进程信号和生命周期管理
```

### 8.4 常用命令速查


| 命令 | **作用** | **使用场景** |
|------|----------|-------------|
| `pstree` | `显示完整进程树` | `系统概览` |
| `pstree -p` | `显示进程树和PID` | `需要操作特定进程` |
| `pstree -ap` | `显示完整信息` | `详细分析系统状态` |
| `pstree username` | `显示用户进程树` | `用户活动监控` |
| `pstree service_name` | `显示服务进程树` | `服务状态检查` |
| `pstree -H pid` | `高亮特定进程` | `复杂环境中快速定位` |
| `pstree -c` | `展开显示所有进程` | `详细进程关系分析` |

### 8.5 记忆要点


**🧠 核心记忆口诀**：
```
"进程如树有层次，pstree显示父子情"
"查看系统用-ap，用户过滤加名字"
"故障排查看关系，高亮定位用-H"
"服务监控树状图，问题源头一目明"
```

**💡 理解要点**：
- pstree是理解Linux进程管理的重要工具
- 进程树反映了系统的运行机制和服务依赖关系
- 掌握基本选项就能解决大部分实际问题
- 与其他系统工具配合使用效果更佳

**🎯 实用技巧**：
- 经常用`pstree -ap`了解系统整体状态
- 结合用户名和服务名进行针对性分析
- 在排查问题时先看进程树再使用其他工具
- 养成定期查看系统进程树的习惯