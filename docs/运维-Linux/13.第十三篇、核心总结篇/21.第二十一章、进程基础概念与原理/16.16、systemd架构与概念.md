---
title: 16、systemd架构与概念
---
## 📚 目录

1. [systemd系统架构概述](#1-systemd系统架构概述)
2. [Unit单元类型详解](#2-unit单元类型详解)  
3. [Target目标概念](#3-target目标概念)
4. [依赖关系管理](#4-依赖关系管理)
5. [并行启动机制](#5-并行启动机制)
6. [systemd vs SysV对比](#6-systemd-vs-sysv对比)
7. [系统初始化过程](#7-系统初始化过程)
8. [systemd配置目录结构](#8-systemd配置目录结构)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🏗️ systemd系统架构概述


### 1.1 什么是systemd


**📋 基本概念**
```
systemd：System and Service Manager
中文含义：系统和服务管理器
作用：Linux系统的初始化系统和服务管理器
地位：现代Linux发行版的标准初始化系统
```

**🎯 systemd的核心作用**

systemd简单理解就是Linux系统的"**总管家**"，负责：
- **系统启动**：控制整个系统如何启动
- **服务管理**：管理所有系统服务的启动、停止、重启
- **资源控制**：管理系统资源分配和限制
- **日志管理**：统一管理系统日志

### 1.2 systemd架构设计


**🏛️ 整体架构图**
```
┌─────────────────────────────────────────────┐
│                Linux内核                    │
└─────────────────────────────────────────────┘
                      ▲
┌─────────────────────────────────────────────┐
│               systemd (PID 1)              │
│  ┌─────────────┐  ┌─────────────┐         │
│  │  systemctl  │  │  journalctl │  管理工具│
│  └─────────────┘  └─────────────┘         │
│  ┌─────────────────────────────────────────┤
│  │            Unit管理层                   │
│  │ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐      │
│  │ │.service│.target│.mount│.timer│ 等   │
│  │ └─────┘ └─────┘ └─────┘ └─────┘      │
│  └─────────────────────────────────────────┤
│  │            依赖管理层                   │
│  └─────────────────────────────────────────┤
└─────────────────────────────────────────────┘
                      ▲
┌─────────────────────────────────────────────┐
│           各种系统服务和应用程序              │
│    Web服务器  数据库  网络服务  等等         │
└─────────────────────────────────────────────┘
```

**🔹 架构特点**
- **PID 1进程**：systemd是系统启动后的第一个进程
- **单一入口**：所有服务管理都通过systemd进行
- **模块化设计**：不同功能由不同的组件负责
- **统一管理**：提供一致的管理接口

### 1.3 systemd的核心优势


**⚡ 主要优势对比传统方式**

| 特性 | **systemd** | **传统SysV** | **优势说明** |
|------|-------------|--------------|-------------|
| 🚀 **启动速度** | `并行启动` | `串行启动` | `systemd可以同时启动多个服务` |
| 🎯 **依赖管理** | `自动解析` | `手动配置` | `systemd智能处理服务依赖关系` |
| 📊 **资源管理** | `内置支持` | `需额外工具` | `systemd可以限制CPU、内存等资源` |
| 🔧 **配置方式** | `统一格式` | `脚本各异` | `systemd使用标准化的配置文件` |
| 📝 **日志管理** | `集成journald` | `分散管理` | `systemd提供统一的日志系统` |

---

## 2. 📦 Unit单元类型详解


### 2.1 什么是Unit


**🔸 Unit的基本概念**

Unit就是systemd管理的**基本单位**，可以理解为systemd眼中的"**工作对象**"。

```
简单类比：
把systemd想象成一个工厂的管理员
Unit就是这个管理员要管理的各种"东西"：
- 机器设备（服务）
- 工作流程（目标）  
- 存储仓库（挂载点）
- 定时任务（计时器）
```

### 2.2 主要Unit类型


**📋 核心Unit类型详解**

#### 🔸 Service单元（.service）

```
作用：管理系统服务程序
举例：nginx.service、mysql.service
理解：就是各种后台运行的程序服务
```

**Service示例**
```ini
# /etc/systemd/system/myapp.service
[Unit]
Description=我的应用服务
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/myapp
Restart=always
User=myapp

[Install]
WantedBy=multi-user.target
```

#### 🔸 Target单元（.target）

```
作用：定义系统状态目标
举例：multi-user.target、graphical.target
理解：就像是"系统要达到什么状态"的目标
```

#### 🔸 Mount单元（.mount）

```
作用：管理文件系统挂载
举例：home.mount、tmp.mount
理解：就是把存储设备"连接"到系统目录
```

#### 🔸 Timer单元（.timer）

```
作用：定时任务调度
举例：backup.timer、cleanup.timer
理解：就像系统的"闹钟"，到时间就执行任务
```

### 2.3 Unit配置文件结构


**📝 标准Unit文件格式**

每个Unit配置文件都分为三个主要部分：

```ini
[Unit]          # 单元描述和依赖关系
Description=服务描述
After=依赖的其他单元
Requires=必需的依赖

[Service/Target/Mount等]  # 具体单元类型的配置
Type=服务类型
ExecStart=启动命令
...其他配置...

[Install]       # 安装信息
WantedBy=安装到哪个目标
```

**🔹 各部分含义**
- **`[Unit]`**：描述这个Unit是什么，依赖什么
- **`[Service]`**：如果是服务，具体怎么运行
- **`[Install]`**：系统启动时如何处理这个Unit

---

## 3. 🎯 Target目标概念


### 3.1 Target的本质理解


**🎯 什么是Target**

Target可以理解为系统的**"运行状态"**或**"工作模式"**。

```
生活类比：
想象你的电脑有不同的使用模式：
- 办公模式：启动办公软件、网络服务
- 游戏模式：启动游戏相关服务、关闭省电功能
- 服务器模式：只启动必要的后台服务

Target就是Linux系统的这种"模式"概念
```

### 3.2 常用系统Target


**📊 主要Target类型**

| Target名称 | **作用说明** | **包含服务** | **使用场景** |
|------------|-------------|-------------|-------------|
| 🏠 **rescue.target** | `救援模式` | `最基本的系统服务` | `系统故障修复` |
| 🖥️ **multi-user.target** | `多用户文本模式` | `网络、多用户、基本服务` | `服务器环境` |
| 🖼️ **graphical.target** | `图形界面模式` | `multi-user + 图形界面` | `桌面系统` |
| ⚡ **emergency.target** | `紧急模式` | `只有最基本的shell` | `严重故障处理` |

### 3.3 Target的依赖关系


**🔗 Target依赖关系图**
```
emergency.target
    ▲
    │ (更基础)
rescue.target
    ▲
    │
multi-user.target ← 包含网络、多用户等服务
    ▲
    │ (添加图形界面)
graphical.target ← 完整的桌面环境
```

**💡 依赖关系理解**
- **向上依赖**：高级Target包含低级Target的所有功能
- **递进关系**：每个Target都是在下一级基础上添加新功能
- **自动包含**：启动`graphical.target`会自动启动`multi-user.target`

### 3.4 Target操作实例


**🔧 常用Target操作**
```bash
# 查看当前Target
systemctl get-default

# 查看当前活动的Target
systemctl list-units --type=target

# 切换到指定Target
systemctl isolate multi-user.target

# 设置默认Target
systemctl set-default graphical.target
```

---

## 4. 🔗 依赖关系管理


### 4.1 依赖关系的重要性


**🎯 为什么需要依赖管理**

系统服务之间存在先后顺序关系：
```
实际例子：
数据库服务 ← Web服务需要先启动数据库
网络服务 ← 大多数网络应用需要先有网络
文件系统 ← 几乎所有服务都需要先挂载文件系统

如果没有依赖管理：
Web服务启动时数据库还没准备好 → 启动失败
```

### 4.2 依赖关系类型


**📋 主要依赖关系说明**

#### 🔸 Requires（强依赖）

```ini
[Unit]
Requires=mysql.service

含义：必须先启动mysql.service，否则当前服务启动失败
特点：mysql停止时，当前服务也会停止
```

#### 🔸 After（顺序依赖）

```ini
[Unit]
After=network.target

含义：等network.target启动完成后，再启动当前服务
特点：只管顺序，不管成功失败
```

#### 🔸 Wants（弱依赖）

```ini
[Unit]
Wants=redis.service

含义：希望redis.service启动，但启动失败也没关系
特点：不会因为依赖失败而影响当前服务
```

#### 🔸 Before（反向顺序）

```ini
[Unit]
Before=apache.service

含义：当前服务要在apache.service之前启动
特点：与After相反的顺序关系
```

### 4.3 依赖关系实践示例


**📝 Web服务依赖配置示例**
```ini
# /etc/systemd/system/webapp.service
[Unit]
Description=我的Web应用
# 强依赖数据库（必须有）
Requires=mysql.service
# 弱依赖Redis（可有可无）
Wants=redis.service
# 顺序：先启动网络和数据库
After=network.target mysql.service redis.service

[Service]
Type=simple
ExecStart=/usr/bin/webapp
User=webapp

[Install]
WantedBy=multi-user.target
```

**🔍 依赖关系解读**
1. **网络先启动**：`After=network.target`确保有网络
2. **数据库必须有**：`Requires=mysql.service`保证数据库可用
3. **Redis可选**：`Wants=redis.service`有更好，没有也行
4. **启动顺序**：网络 → 数据库/Redis → Web应用

---

## 5. ⚡ 并行启动机制


### 5.1 传统串行启动的问题


**🐌 传统SysV的串行启动**
```
启动过程（串行）：
网络服务 ──(等待完成)──> 数据库 ──(等待完成)──> Web服务 ──> ...
   30秒              20秒              15秒

总启动时间：30 + 20 + 15 = 65秒
```

**❌ 串行启动的缺点**
- **启动慢**：每个服务都要等前面的完成
- **资源浪费**：CPU在等待时处于空闲状态
- **故障影响大**：一个服务卡住，整个启动过程停滞

### 5.2 systemd的并行启动


**⚡ 并行启动原理**
```
systemd并行启动：

时间轴：0秒    10秒   20秒   30秒
       │      │      │      │
网络   ████████
数据库     ██████████
Web服务         ██████
邮件服务   ████████████
文件服务     ████████

总启动时间：约30秒（而不是所有时间相加）
```

**✅ 并行启动的优势**
- **启动快**：多个无依赖服务同时启动
- **资源充分利用**：CPU多核并行处理
- **智能调度**：有依赖的服务等待，无依赖的先启动

### 5.3 并行启动的依赖处理


**🧠 智能依赖解析**

systemd会自动分析服务依赖，决定启动顺序：

```
示例服务依赖图：
          A
        /   \
       B     C
      / \   /
     D   E F

启动策略：
第1批（并行）：D, E, F  ← 没有依赖的先启动
第2批（并行）：B, C     ← 等依赖完成后并行启动
第3批：A              ← 最后启动A
```

**🎯 关键理解**
- **无依赖服务**：立即并行启动
- **有依赖服务**：等依赖满足后再启动
- **智能调度**：systemd自动计算最优启动顺序

### 5.4 并行启动配置


**📝 优化并行启动的配置技巧**

```ini
# 错误配置（会导致串行）
[Unit]
After=service1.service service2.service service3.service
Requires=service1.service service2.service service3.service

# 优化配置（支持并行）
[Unit]
# 只依赖真正必要的服务
Requires=database.service
After=network.target database.service
# 其他服务用Wants（弱依赖）
Wants=cache.service logging.service
```

---

## 6. ⚖️ systemd vs SysV对比


### 6.1 启动方式对比


**🔄 启动过程对比**

```
SysV启动过程：
内核 → init(PID 1) → /etc/rc.d/rcX.d/脚本按序号执行
       串行执行：S01网络 → S02数据库 → S03Web服务...

systemd启动过程：  
内核 → systemd(PID 1) → 解析依赖关系 → 并行启动服务
       智能调度：网络//数据库//日志 同时启动
```

### 6.2 详细功能对比


**📊 功能特性对比表**

| 对比维度 | **SysV Init** | **systemd** | **优势分析** |
|----------|---------------|-------------|-------------|
| 🚀 **启动速度** | `串行启动，慢` | `并行启动，快` | `systemd快2-3倍` |
| 📝 **配置方式** | `Shell脚本` | `INI格式文件` | `systemd更简单易读` |
| 🔧 **服务控制** | `service命令` | `systemctl命令` | `systemd功能更强大` |
| 📊 **状态监控** | `ps/top查看` | `内置状态跟踪` | `systemd提供详细状态` |
| 🔗 **依赖管理** | `手动配置启动顺序` | `自动解析依赖` | `systemd智能化管理` |
| 📝 **日志管理** | `分散在多个文件` | `journald统一管理` | `systemd集中化日志` |
| ⚡ **资源控制** | `需要额外工具` | `内置cgroup支持` | `systemd原生支持` |

### 6.3 命令对比


**💻 常用操作命令对比**

| 操作 | **SysV方式** | **systemd方式** | **说明** |
|------|-------------|----------------|---------|
| 启动服务 | `service nginx start` | `systemctl start nginx` | `systemd命令更统一` |
| 停止服务 | `service nginx stop` | `systemctl stop nginx` | `功能相同` |
| 重启服务 | `service nginx restart` | `systemctl restart nginx` | `systemd支持更多选项` |
| 查看状态 | `service nginx status` | `systemctl status nginx` | `systemd显示更详细` |
| 开机启动 | `chkconfig nginx on` | `systemctl enable nginx` | `systemd更简单` |
| 查看日志 | `tail /var/log/nginx/error.log` | `journalctl -u nginx` | `systemd集中化日志` |

### 6.4 配置文件对比


**📋 配置复杂度对比**

**SysV服务脚本示例（简化）**
```bash
#!/bin/bash
# /etc/init.d/myservice
. /etc/rc.d/init.d/functions

case "$1" in
    start)
        echo "Starting myservice..."
        daemon /usr/bin/myservice
        ;;
    stop)
        echo "Stopping myservice..."
        killproc myservice
        ;;
    restart)
        $0 stop
        $0 start
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        ;;
esac
```

**systemd服务文件示例**
```ini
# /etc/systemd/system/myservice.service
[Unit]
Description=我的服务
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/myservice
Restart=always

[Install]
WantedBy=multi-user.target
```

**🔍 对比分析**
- **SysV**：需要写完整的Shell脚本，复杂易错
- **systemd**：简单的配置文件，清晰易懂
- **维护性**：systemd配置更容易维护和调试

---

## 7. 🚀 系统初始化过程


### 7.1 系统启动全流程


**🔄 从开机到登录的完整过程**

```
系统启动时序图：

开机 → BIOS/UEFI → 引导加载器 → Linux内核 → systemd → 登录界面
 1秒      2秒         3秒        5秒      15秒     20秒

详细过程：
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   硬件自检   │───▶│  加载引导程序│───▶│  启动内核   │
│  BIOS/UEFI  │    │ GRUB/LILO   │    │   vmlinuz   │
└─────────────┘    └─────────────┘    └─────────────┘
                                           │
┌─────────────┐    ┌─────────────┐        ▼
│   用户登录   │◀───│ 启动目标服务 │◀───┌─────────────┐
│  登录界面   │    │multi-user.target││  systemd   │
└─────────────┘    └─────────────┘    │   (PID 1)  │
                                      └─────────────┘
```

### 7.2 systemd初始化步骤


**📋 systemd接管后的详细步骤**

#### 步骤1：基础系统初始化

```
systemd启动后首先做的事：
1. 挂载基本文件系统（/proc, /sys, /dev）
2. 启动udev设备管理器
3. 设置主机名、时区等基本配置
```

#### 步骤2：解析目标Target

```
systemd读取默认目标：
1. 读取 /etc/systemd/system/default.target
2. 通常指向 multi-user.target 或 graphical.target
3. 解析目标包含的所有服务和依赖
```

#### 步骤3：并行启动服务

```
根据依赖关系并行启动：
第1轮：基础服务（网络、日志、设备）
第2轮：系统服务（SSH、时间同步、防火墙）
第3轮：应用服务（Web服务器、数据库）
```

#### 步骤4：到达运行状态

```
所有服务启动完成：
1. 系统进入指定的Target状态
2. 用户可以正常使用系统
3. systemd持续监控服务状态
```

### 7.3 初始化过程的日志查看


**🔍 查看启动过程的方法**

```bash
# 查看系统启动日志
journalctl -b

# 查看启动时间分析
systemd-analyze

# 查看服务启动时间排序
systemd-analyze blame

# 查看启动过程依赖关系
systemd-analyze critical-chain
```

**📊 启动时间分析示例**
```bash
$ systemd-analyze
Startup finished in 2.841s (kernel) + 8.723s (userspace) = 11.564s
graphical.target reached after 8.456s in userspace

# 含义解释：
# 内核启动：2.841秒
# 用户空间（systemd管理）：8.723秒  
# 总启动时间：11.564秒
# 到达图形界面：8.456秒
```

---

## 8. 📂 systemd配置目录结构


### 8.1 主要配置目录


**🗂️ systemd配置文件的组织结构**

```
systemd配置目录层次：
/etc/systemd/system/     ← 管理员自定义配置（优先级最高）
    ├── multi-user.target.wants/
    ├── graphical.target.wants/
    └── 各种.service .target文件

/usr/lib/systemd/system/ ← 系统默认配置文件
    ├── 发行版提供的标准服务
    └── 软件包安装的服务

/run/systemd/system/     ← 运行时临时配置
    └── 动态生成的临时配置
```

### 8.2 配置文件优先级


**⚡ 优先级规则**

当同名配置文件在多个目录中存在时：

```
优先级从高到低：
1. /etc/systemd/system/          ← 管理员配置（最高优先级）
2. /run/systemd/system/          ← 运行时配置  
3. /usr/lib/systemd/system/      ← 系统默认配置（最低优先级）

实际应用：
如果你要自定义nginx服务配置：
1. 复制 /usr/lib/systemd/system/nginx.service
2. 到 /etc/systemd/system/nginx.service  
3. 修改 /etc/systemd/system/nginx.service
4. systemd会优先使用你的自定义配置
```

### 8.3 配置目录详解


#### 🔸 /etc/systemd/system/

```
作用：存放管理员自定义的配置
特点：优先级最高，系统更新不会覆盖
用途：
- 自定义服务配置
- 修改默认服务行为
- 创建新的服务单元
```

#### 🔸 .wants/ 和 .requires/ 目录

```
/etc/systemd/system/multi-user.target.wants/
├── nginx.service -> /etc/systemd/system/nginx.service
├── mysql.service -> /usr/lib/systemd/system/mysql.service
└── ssh.service -> /usr/lib/systemd/system/ssh.service

含义：
- .wants/ 目录包含"希望启动"的服务（弱依赖）
- .requires/ 目录包含"必须启动"的服务（强依赖）
- 通过符号链接指向实际的服务文件
```

### 8.4 实用配置操作


**🔧 常用配置目录操作**

```bash
# 查看某个Target包含哪些服务
ls -la /etc/systemd/system/multi-user.target.wants/

# 手动添加服务到Target（等同于enable）
ln -s /etc/systemd/system/myapp.service \
      /etc/systemd/system/multi-user.target.wants/

# 创建自定义服务
sudo nano /etc/systemd/system/myservice.service

# 重新加载配置
sudo systemctl daemon-reload

# 启用服务（会自动创建符号链接）
sudo systemctl enable myservice
```

**📝 配置文件管理最佳实践**
- **不要直接修改** `/usr/lib/systemd/system/` 中的文件
- **自定义配置** 都放在 `/etc/systemd/system/`
- **使用systemctl命令** 而不是手动创建链接
- **修改配置后** 记得执行 `daemon-reload`

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 systemd本质：Linux系统的总管家，负责启动和管理一切
🔸 Unit概念：systemd管理的基本单位，包括服务、目标、挂载点等
🔸 Target概念：系统运行状态/模式，如文本模式、图形模式
🔸 依赖管理：服务之间的启动顺序和依赖关系
🔸 并行启动：systemd相比传统方式的最大优势
🔸 配置目录：/etc/systemd/system/ 优先级最高
```

### 9.2 关键理解要点


**🔹 systemd vs 传统SysV的本质区别**
```
传统方式：用Shell脚本按顺序一个个启动服务
systemd方式：智能分析依赖关系，并行启动无依赖的服务

结果：启动速度提升2-3倍，配置更简单，管理更统一
```

**🔹 依赖关系的实际意义**
```
Requires：强依赖，就像"没有电就不能开电脑"
After：顺序依赖，就像"先穿袜子再穿鞋"
Wants：弱依赖，就像"有Wi-Fi更好，没有也行"
```

**🔹 Target的理解技巧**
```
把Target想象成手机的使用模式：
- 飞行模式：只有基本功能
- 正常模式：所有网络功能可用
- 省电模式：限制部分功能

Linux的Target就是类似的"系统模式"
```

### 9.3 实际应用价值


**🎯 日常运维中的应用**
- **服务管理**：使用systemctl命令管理各种系统服务
- **启动优化**：通过分析依赖关系优化系统启动速度
- **故障排查**：利用systemd日志快速定位服务问题
- **自动化运维**：创建自定义服务实现任务自动化

**🔧 学习和实践建议**
- **从基本命令开始**：熟练使用systemctl的各种操作
- **理解配置文件**：学会阅读和编写.service文件
- **实践依赖管理**：尝试创建有依赖关系的自定义服务
- **掌握日志查看**：使用journalctl排查服务问题

**核心记忆**：
- systemd是系统总管家，Unit是管理对象
- Target定义系统模式，依赖决定启动顺序
- 并行启动提速度，配置统一好管理
- /etc优先级最高，daemon-reload要记牢