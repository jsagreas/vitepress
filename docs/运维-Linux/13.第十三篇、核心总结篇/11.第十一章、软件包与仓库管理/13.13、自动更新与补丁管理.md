---
title: 13ã€è‡ªåŠ¨æ›´æ–°ä¸è¡¥ä¸ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [è‡ªåŠ¨æ›´æ–°åŸºç¡€æ¦‚å¿µ](#1-è‡ªåŠ¨æ›´æ–°åŸºç¡€æ¦‚å¿µ)
2. [yum-cronè‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ](#2-yum-cronè‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ)
3. [dnf-automaticç°ä»£åŒ–é…ç½®](#3-dnf-automaticç°ä»£åŒ–é…ç½®)
4. [å®‰å…¨æ›´æ–°ç­–ç•¥åˆ¶å®š](#4-å®‰å…¨æ›´æ–°ç­–ç•¥åˆ¶å®š)
5. [å†…æ ¸æ›´æ–°ç®¡ç†å®è·µ](#5-å†…æ ¸æ›´æ–°ç®¡ç†å®è·µ)
6. [æ›´æ–°å›æ»šä¸æ•…éšœæ¢å¤](#6-æ›´æ–°å›æ»šä¸æ•…éšœæ¢å¤)
7. [ä¼ä¸šçº§è¡¥ä¸ç®¡ç†](#7-ä¼ä¸šçº§è¡¥ä¸ç®¡ç†)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è‡ªåŠ¨æ›´æ–°åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è‡ªåŠ¨æ›´æ–°


**ğŸ”¸ åŸºæœ¬å®šä¹‰**
è‡ªåŠ¨æ›´æ–°æ˜¯æŒ‡ç³»ç»Ÿåœ¨é¢„è®¾æ—¶é—´è‡ªåŠ¨æ£€æŸ¥ã€ä¸‹è½½å¹¶å®‰è£…è½¯ä»¶åŒ…æ›´æ–°çš„æœºåˆ¶ï¼Œæ— éœ€äººå·¥å¹²é¢„å³å¯ä¿æŒç³»ç»Ÿå¤„äºæœ€æ–°çŠ¶æ€ã€‚

**ğŸŒ° ç”Ÿæ´»ç±»æ¯”**
å°±åƒæ‰‹æœºçš„è‡ªåŠ¨æ›´æ–°åŠŸèƒ½ï¼Œä½ å¯ä»¥è®¾ç½®åœ¨å¤œé—´WiFiç¯å¢ƒä¸‹è‡ªåŠ¨ä¸‹è½½å®‰è£…ç³»ç»Ÿæ›´æ–°ï¼Œæ—©ä¸Šèµ·æ¥å°±æ˜¯æœ€æ–°ç‰ˆæœ¬äº†ã€‚LinuxæœåŠ¡å™¨çš„è‡ªåŠ¨æ›´æ–°ä¹Ÿæ˜¯åŒæ ·é“ç†ã€‚

### 1.2 è‡ªåŠ¨æ›´æ–°çš„æ ¸å¿ƒä»·å€¼


**ğŸ”¸ å®‰å…¨æ€§ä¿éšœ**
```
åŠæ—¶ä¿®å¤æ¼æ´ â†’ å‡å°‘å®‰å…¨é£é™© â†’ ä¿æŠ¤ç³»ç»Ÿå®‰å…¨
è‡ªåŠ¨åŒ–æµç¨‹ â†’ é¿å…äººä¸ºé—æ¼ â†’ æé«˜å®‰å…¨ç­‰çº§
```

**ğŸ”¸ è¿ç»´æ•ˆç‡æå‡**
- **å‡å°‘äººå·¥æ“ä½œ**ï¼šä¸éœ€è¦ç®¡ç†å‘˜æ‰‹åŠ¨æ‰§è¡Œæ›´æ–°
- **æ‰¹é‡ç®¡ç†**ï¼šå¯åŒæ—¶ç®¡ç†å¤šå°æœåŠ¡å™¨
- **æ—¶é—´ä¼˜åŒ–**ï¼šé€‰æ‹©ä¸šåŠ¡ä½å³°æœŸè‡ªåŠ¨æ‰§è¡Œ

**ğŸ”¸ ç³»ç»Ÿç¨³å®šæ€§**
- **åŠæ—¶ä¿®å¤bug**ï¼šè‡ªåŠ¨è·å¾—è½¯ä»¶bugä¿®å¤
- **æ€§èƒ½æ”¹è¿›**ï¼šè·å¾—æ€§èƒ½ä¼˜åŒ–æ›´æ–°
- **å…¼å®¹æ€§æå‡**ï¼šä¿æŒä¸å…¶ä»–è½¯ä»¶çš„å…¼å®¹

### 1.3 è‡ªåŠ¨æ›´æ–°vsæ‰‹åŠ¨æ›´æ–°å¯¹æ¯”


| ç‰¹æ€§å¯¹æ¯” | **æ‰‹åŠ¨æ›´æ–°** | **è‡ªåŠ¨æ›´æ–°** | **æœ€ä½³å®è·µ** |
|---------|------------|-------------|-------------|
| ğŸ”¸ **åŠæ—¶æ€§** | `ä¾èµ–äººå·¥æ‰§è¡Œ` | `å®šæ—¶è‡ªåŠ¨æ‰§è¡Œ` | `å…³é”®ç³»ç»Ÿè‡ªåŠ¨ï¼Œæµ‹è¯•ç¯å¢ƒæ‰‹åŠ¨` |
| ğŸ”¸ **å¯æ§æ€§** | `å®Œå…¨å¯æ§` | `éœ€è¦é…ç½®ç­–ç•¥` | `è®¾ç½®æ›´æ–°ç­–ç•¥å’Œé»‘åå•` |
| ğŸ”¸ **å®‰å…¨æ€§** | `å¯èƒ½å»¶è¿Ÿä¿®å¤` | `åŠæ—¶ä¿®å¤æ¼æ´` | `å®‰å…¨æ›´æ–°è‡ªåŠ¨ï¼ŒåŠŸèƒ½æ›´æ–°æ‰‹åŠ¨` |
| ğŸ”¸ **é£é™©æ€§** | `å¯é¢„å…ˆæµ‹è¯•` | `å¯èƒ½å¼•å…¥é—®é¢˜` | `å…ˆæµ‹è¯•ç¯å¢ƒï¼Œå†ç”Ÿäº§ç¯å¢ƒ` |

---

## 2. âš™ï¸ yum-cronè‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ


### 2.1 yum-cronåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯yum-cron**
yum-cronæ˜¯Red Hatç³»åˆ—ç³»ç»Ÿï¼ˆå¦‚CentOS 7ï¼‰æä¾›çš„è‡ªåŠ¨æ›´æ–°å·¥å…·ï¼Œå®ƒåŸºäºcronå®šæ—¶ä»»åŠ¡ï¼Œå®šæœŸæ£€æŸ¥å’Œå®‰è£…è½¯ä»¶åŒ…æ›´æ–°ã€‚

**ğŸ”¸ å·¥ä½œåŸç†**
```
å®šæ—¶è§¦å‘ â†’ æ£€æŸ¥æ›´æ–° â†’ ä¸‹è½½è½¯ä»¶åŒ… â†’ å®‰è£…æ›´æ–° â†’ å‘é€é€šçŸ¥
    â†“           â†“           â†“           â†“           â†“
  cronä»»åŠ¡   yum check   yum download  yum install   é‚®ä»¶é€šçŸ¥
```

### 2.2 yum-cronå®‰è£…ä¸åŸºç¡€é…ç½®


**ğŸ“¦ å®‰è£…yum-cron**
```bash
# å®‰è£…yum-cronè½¯ä»¶åŒ…

sudo yum install yum-cron -y

# å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡

sudo systemctl enable yum-cron
sudo systemctl start yum-cron
```

**ğŸ”§ åŸºç¡€é…ç½®æ–‡ä»¶**
yum-cronçš„ä¸»è¦é…ç½®æ–‡ä»¶ä½äºï¼š`/etc/yum/yum-cron.conf`

```ini
[commands]
# æ›´æ–°å‘½ä»¤ï¼šdefaultè¡¨ç¤ºyum upgrade

update_cmd = default
# æ˜¯å¦éšæœºå»¶è¿Ÿå¯åŠ¨ï¼šé¿å…æ‰€æœ‰æœåŠ¡å™¨åŒæ—¶æ›´æ–°

random_sleep = 360

[emitters] 
# è¾“å‡ºæ–¹å¼ï¼šstdioè¡¨ç¤ºæ ‡å‡†è¾“å‡ºï¼Œemailè¡¨ç¤ºé‚®ä»¶

system_name = myserver.example.com
emit_via = stdio

[email]
# é‚®ä»¶é€šçŸ¥é…ç½®

email_from = root@localhost
email_to = admin@example.com
email_host = localhost

[groups]
# è¦æ›´æ–°çš„è½¯ä»¶åŒ…ç»„

group_list = None
group_package_types = mandatory, default

[base]
# åŸºç¡€é…ç½®

debuglevel = -2
skip_broken = True
```

### 2.3 yum-cronæ ¸å¿ƒé…ç½®è¯¦è§£


**ğŸ”¸ æ›´æ–°ç­–ç•¥é…ç½®**
```ini
# å®Œæ•´é…ç½®ç¤ºä¾‹

[commands]
# ä»…ä¸‹è½½ä¸å®‰è£…ï¼šsecurity, bugfix, enhancement, newpackage

update_cmd = security
# æ˜¯å¦è‡ªåŠ¨å®‰è£…ï¼šyesè‡ªåŠ¨å®‰è£…ï¼Œnoä»…ä¸‹è½½

apply_updates = no
# éšæœºå»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼‰

random_sleep = 300
```

**ğŸ’¡ é…ç½®è¯´æ˜**
- `update_cmd = security`ï¼šä»…å®‰è£…å®‰å…¨æ›´æ–°
- `update_cmd = default`ï¼šå®‰è£…æ‰€æœ‰å¯ç”¨æ›´æ–°  
- `apply_updates = no`ï¼šä»…ä¸‹è½½ä¸å®‰è£…ï¼Œéœ€è¦æ‰‹åŠ¨ç¡®è®¤
- `apply_updates = yes`ï¼šè‡ªåŠ¨ä¸‹è½½å¹¶å®‰è£…

**ğŸ”¸ é€šçŸ¥é…ç½®**
```ini
[emitters]
# ç³»ç»Ÿæ ‡è¯†åç§°

system_name = web-server-01
# è¾“å‡ºæ–¹å¼ï¼šstdioæ ‡å‡†è¾“å‡ºï¼Œemailé‚®ä»¶ï¼Œmotdç™»å½•æ¶ˆæ¯

emit_via = email

[email]
# å‘é€æ–¹é‚®ç®±

email_from = yum-cron@mycompany.com
# æ¥æ”¶æ–¹é‚®ç®±ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰

email_to = sysadmin@mycompany.com, security@mycompany.com
# é‚®ä»¶æœåŠ¡å™¨

email_host = mail.mycompany.com
```

### 2.4 yum-cronä½¿ç”¨å®è·µ


**ğŸš€ å¿«é€Ÿé…ç½®æ­¥éª¤**

**1ï¸âƒ£ å®‰å…¨ä¼˜å…ˆé…ç½®**
```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶

sudo vi /etc/yum/yum-cron.conf

# ä¿®æ”¹å…³é”®é…ç½®

update_cmd = security        # ä»…å®‰å…¨æ›´æ–°
apply_updates = yes          # è‡ªåŠ¨å®‰è£…
emit_via = email            # é‚®ä»¶é€šçŸ¥
```

**2ï¸âƒ£ æµ‹è¯•é…ç½®**
```bash
# æ‰‹åŠ¨æ‰§è¡Œyum-cronæµ‹è¯•

sudo /usr/sbin/yum-cron

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€

sudo systemctl status yum-cron

# æŸ¥çœ‹æ—¥å¿—

sudo journalctl -u yum-cron -f
```

**3ï¸âƒ£ å®šåˆ¶åŒ–é…ç½®**
```bash
# åˆ›å»ºè‡ªå®šä¹‰é…ç½®

sudo cp /etc/yum/yum-cron.conf /etc/yum/yum-cron-security.conf

# ç¼–è¾‘å®‰å…¨æ›´æ–°ä¸“ç”¨é…ç½®

sudo vi /etc/yum/yum-cron-security.conf
```

---

## 3. ğŸ”„ dnf-automaticç°ä»£åŒ–é…ç½®


### 3.1 dnf-automaticæ¦‚è¿°


**ğŸ”¸ ä»€ä¹ˆæ˜¯dnf-automatic**
dnf-automaticæ˜¯Fedoraã€RHEL 8+ã€Rocky Linuxç­‰ç°ä»£Red Hatç³»åˆ—ç³»ç»Ÿä½¿ç”¨çš„è‡ªåŠ¨æ›´æ–°å·¥å…·ï¼Œæ˜¯yum-cronçš„ç»§æ‰¿è€…ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ã€é…ç½®æ›´çµæ´»ã€‚

**ğŸ”¸ ä¸yum-cronçš„åŒºåˆ«**
```
yum-cron (æ—§ç‰ˆæœ¬)          dnf-automatic (æ–°ç‰ˆæœ¬)
     â†“                           â†“
åŸºäºyumåŒ…ç®¡ç†å™¨              åŸºäºdnfåŒ…ç®¡ç†å™¨
é…ç½®ç›¸å¯¹ç®€å•                 é…ç½®æ›´çµæ´»å¼ºå¤§
åŠŸèƒ½ç›¸å¯¹åŸºç¡€                 æ”¯æŒæ›´å¤šé«˜çº§åŠŸèƒ½
```

### 3.2 dnf-automaticå®‰è£…é…ç½®


**ğŸ“¦ å®‰è£…dnf-automatic**
```bash
# RHEL 8+ / Rocky Linux / AlmaLinux

sudo dnf install dnf-automatic -y

# å¯ç”¨æœåŠ¡

sudo systemctl enable dnf-automatic.timer
sudo systemctl start dnf-automatic.timer
```

**ğŸ”§ ä¸»é…ç½®æ–‡ä»¶è¯¦è§£**
é…ç½®æ–‡ä»¶ä½ç½®ï¼š`/etc/dnf/automatic.conf`

```ini
[commands]
# å‡çº§ç±»å‹ï¼šdefault, security, security-severity:Critical

upgrade_type = security
# æ˜¯å¦éšæœºå»¶è¿Ÿ

random_sleep = 300
# ç½‘ç»œåœ¨çº¿æ£€æŸ¥

network_online_timeout = 60
# æ˜¯å¦è‡ªåŠ¨ä¸‹è½½

download_updates = yes
# æ˜¯å¦è‡ªåŠ¨åº”ç”¨æ›´æ–°

apply_updates = no

[emitters]
# è¾“å‡ºç³»ç»Ÿï¼šstdio, motd, command, email

emit_via = email
system_name = production-server

[email]
email_from = dnf-automatic@company.com
email_to = admin@company.com
email_host = localhost
email_port = 25

[command]
# è‡ªå®šä¹‰å‘½ä»¤ï¼ˆå½“emit_via = commandæ—¶ï¼‰

command_format = "echo '{body}' | mail -s '{subject}' admin@company.com"

[base]
debuglevel = 1
```

### 3.3 dnf-automaticé«˜çº§é…ç½®


**ğŸ”¸ å¤šç§æ›´æ–°ç­–ç•¥**
```ini
# ä»…å®‰å…¨æ›´æ–°

upgrade_type = security

# æ‰€æœ‰æ›´æ–°

upgrade_type = default  

# ç‰¹å®šä¸¥é‡çº§åˆ«çš„å®‰å…¨æ›´æ–°

upgrade_type = security-severity:Critical,Important

# æ’é™¤ç‰¹å®šè½¯ä»¶åŒ…

excludepkgs = kernel*, mysql*
```

**ğŸ”¸ å®šæ—¶å™¨é…ç½®è‡ªå®šä¹‰**
```bash
# æŸ¥çœ‹é»˜è®¤å®šæ—¶å™¨é…ç½®

sudo systemctl cat dnf-automatic.timer

# åˆ›å»ºè‡ªå®šä¹‰å®šæ—¶å™¨

sudo systemctl edit dnf-automatic.timer
```

åœ¨ç¼–è¾‘å™¨ä¸­æ·»åŠ ï¼š
```ini
[Timer]
# è¦†ç›–é»˜è®¤é…ç½®ï¼Œæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ

OnCalendar=
OnCalendar=02:00
# éšæœºå»¶è¿Ÿ30åˆ†é’Ÿ

RandomizedDelaySec=1800
```

**ğŸ”¸ å¤šé…ç½®æ–‡ä»¶ç®¡ç†**
```bash
# åˆ›å»ºä¸“ç”¨çš„å®‰å…¨æ›´æ–°é…ç½®

sudo cp /etc/dnf/automatic.conf /etc/dnf/automatic-security.conf

# ç¼–è¾‘å®‰å…¨æ›´æ–°é…ç½®

sudo vi /etc/dnf/automatic-security.conf

# åˆ›å»ºå¯¹åº”çš„systemdæœåŠ¡

sudo cp /usr/lib/systemd/system/dnf-automatic.service /etc/systemd/system/dnf-automatic-security.service

# ä¿®æ”¹æœåŠ¡æ–‡ä»¶æŒ‡å‘æ–°é…ç½®

sudo vi /etc/systemd/system/dnf-automatic-security.service
```

---

## 4. ğŸ›¡ï¸ å®‰å…¨æ›´æ–°ç­–ç•¥åˆ¶å®š


### 4.1 å®‰å…¨æ›´æ–°ä¼˜å…ˆçº§åˆ†çº§


**ğŸ”¸ å®‰å…¨æ›´æ–°ä¸¥é‡æ€§åˆ†ç±»**
```
ğŸ”´ Critical (ä¸¥é‡)     â†’ ç«‹å³æ›´æ–°ï¼Œ24å°æ—¶å†…å®Œæˆ
ğŸŸ¡ Important (é‡è¦)    â†’ ä¼˜å…ˆæ›´æ–°ï¼Œ72å°æ—¶å†…å®Œæˆ  
ğŸ”µ Moderate (ä¸­ç­‰)     â†’ å¸¸è§„æ›´æ–°ï¼Œä¸€å‘¨å†…å®Œæˆ
ğŸŸ¢ Low (è¾ƒä½)         â†’ å®šæœŸæ›´æ–°ï¼Œæœˆåº¦æ›´æ–°å‘¨æœŸ
```

**ğŸ”¸ ç­–ç•¥é…ç½®ç¤ºä¾‹**
```ini
# ä»…å®‰è£…ä¸¥é‡å’Œé‡è¦çº§åˆ«å®‰å…¨æ›´æ–°

[commands]
upgrade_type = security-severity:Critical,Important
apply_updates = yes
download_updates = yes

# ä¸­ç­‰å’Œè¾ƒä½çº§åˆ«æ‰‹åŠ¨å¤„ç†

excludepkgs = 
```

### 4.2 åˆ†ç¯å¢ƒæ›´æ–°ç­–ç•¥


**ğŸ¯ ç¯å¢ƒåˆ†å±‚ç®¡ç†**
```
æµ‹è¯•ç¯å¢ƒ â†’ é¢„ç”Ÿäº§ç¯å¢ƒ â†’ ç”Ÿäº§ç¯å¢ƒ
    â†“           â†“           â†“
  è‡ªåŠ¨å®‰è£…    è‡ªåŠ¨ä¸‹è½½     ä»…é€šçŸ¥
  é£é™©æµ‹è¯•    äººå·¥ç¡®è®¤     è°¨æ…æ›´æ–°
```

**ğŸ”§ é…ç½®å®ç°**
```bash
# æµ‹è¯•ç¯å¢ƒé…ç½®

[commands]
upgrade_type = default
apply_updates = yes

# ç”Ÿäº§ç¯å¢ƒé…ç½®  

[commands]
upgrade_type = security
apply_updates = no       # ä»…ä¸‹è½½ä¸å®‰è£…
download_updates = yes
```

### 4.3 ä¸šåŠ¡æ—¶é—´çª—å£ç®¡ç†


**â° æ›´æ–°æ—¶é—´ç­–ç•¥**
```
ä¸šåŠ¡é«˜å³°æœŸï¼š    09:00-18:00  â†’ ç¦æ­¢æ›´æ–°
ä¸šåŠ¡ä½å³°æœŸï¼š    18:00-23:00  â†’ å…è®¸ä¸‹è½½
ç»´æŠ¤çª—å£ï¼š      02:00-05:00  â†’ å…è®¸å®‰è£…
ç´§æ€¥ç»´æŠ¤ï¼š      éšæ—¶         â†’ å®‰å…¨æ¼æ´ä¿®å¤
```

**ğŸ“… å®šæ—¶å™¨é…ç½®**
```ini
# å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼Œé¿å¼€ä¸šåŠ¡é«˜å³°

OnCalendar=02:00
# éšæœºå»¶è¿Ÿé¿å…æœåŠ¡å™¨é›†ä¸­æ›´æ–°

RandomizedDelaySec=3600
```

---

## 5. ğŸ”§ å†…æ ¸æ›´æ–°ç®¡ç†å®è·µ


### 5.1 å†…æ ¸æ›´æ–°ç‰¹æ®Šæ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆå†…æ ¸æ›´æ–°éœ€è¦ç‰¹åˆ«å¯¹å¾…**

**ğŸ’¡ å†…æ ¸çš„é‡è¦æ€§**
å†…æ ¸æ˜¯æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒï¼Œç®¡ç†ç€ç¡¬ä»¶èµ„æºã€è¿›ç¨‹è°ƒåº¦ã€å†…å­˜ç®¡ç†ç­‰åŸºç¡€åŠŸèƒ½ã€‚å†…æ ¸æ›´æ–°ç›¸å½“äºç»™æ±½è½¦æ¢å‘åŠ¨æœºï¼Œéœ€è¦æ ¼å¤–è°¨æ…ã€‚

**âš ï¸ å†…æ ¸æ›´æ–°é£é™©**
- **å…¼å®¹æ€§é—®é¢˜**ï¼šæ–°å†…æ ¸å¯èƒ½ä¸ç°æœ‰ç¡¬ä»¶é©±åŠ¨ä¸å…¼å®¹
- **æ€§èƒ½å½±å“**ï¼šå†…æ ¸è°ƒåº¦ç®—æ³•å˜åŒ–å¯èƒ½å½±å“åº”ç”¨æ€§èƒ½  
- **é‡å¯å¿…éœ€**ï¼šå†…æ ¸æ›´æ–°åå¿…é¡»é‡å¯ç³»ç»Ÿæ‰èƒ½ç”Ÿæ•ˆ
- **å›æ»šå¤æ‚**ï¼šå†…æ ¸é—®é¢˜çš„ä¿®å¤ç›¸å¯¹å¤æ‚

### 5.2 å†…æ ¸æ›´æ–°ç­–ç•¥é…ç½®


**ğŸ”¸ æ’é™¤å†…æ ¸è‡ªåŠ¨æ›´æ–°**
```bash
# åœ¨yum-croné…ç½®ä¸­æ’é™¤å†…æ ¸

sudo vi /etc/yum/yum-cron.conf
```

```ini
[base]
# æ’é™¤å†…æ ¸ç›¸å…³åŒ…çš„è‡ªåŠ¨æ›´æ–°

exclude = kernel* kmod-*
```

**ğŸ”¸ å†…æ ¸æ›´æ–°ä¸“ç”¨æµç¨‹**
```bash
# æ‰‹åŠ¨æ£€æŸ¥å†…æ ¸æ›´æ–°

sudo yum check-update kernel

# æŸ¥çœ‹å½“å‰å†…æ ¸ç‰ˆæœ¬

uname -r

# æŸ¥çœ‹å·²å®‰è£…çš„å†…æ ¸

rpm -q kernel

# æ‰‹åŠ¨æ›´æ–°å†…æ ¸ï¼ˆè°¨æ…æ“ä½œï¼‰

sudo yum update kernel
```

### 5.3 é‡å¯éœ€æ±‚æ£€æµ‹ä¸ç®¡ç†


**ğŸ”¸ æ£€æµ‹ç³»ç»Ÿæ˜¯å¦éœ€è¦é‡å¯**

**ğŸ“‹ needs-restartingå·¥å…·**
```bash
# å®‰è£…needs-restartingå·¥å…·

sudo yum install yum-utils -y

# æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å¯

sudo needs-restarting -r
echo $?  # è¿”å›1è¡¨ç¤ºéœ€è¦é‡å¯ï¼Œ0è¡¨ç¤ºä¸éœ€è¦

# æŸ¥çœ‹éœ€è¦é‡å¯çš„æœåŠ¡

sudo needs-restarting -s
```

**ğŸ”§ è‡ªåŠ¨åŒ–é‡å¯æ£€æµ‹è„šæœ¬**
```bash
#!/bin/bash

# /usr/local/bin/check-reboot-needed.sh


# æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å¯

needs-restarting -r > /dev/null
REBOOT_NEEDED=$?

if [ $REBOOT_NEEDED -eq 1 ]; then
    echo "ç³»ç»Ÿéœ€è¦é‡å¯ä»¥å®Œæˆæ›´æ–°"
    echo "å»ºè®®åœ¨ç»´æŠ¤çª—å£æœŸæ‰§è¡Œé‡å¯"
    
#    # å¯é€‰ï¼šè‡ªåŠ¨å‘é€é‚®ä»¶é€šçŸ¥
    echo "æœåŠ¡å™¨ $(hostname) éœ€è¦é‡å¯ä»¥å®Œæˆæ›´æ–°" | \
    mail -s "é‡å¯éœ€æ±‚é€šçŸ¥" admin@company.com
    
#    # å¯é€‰ï¼šåœ¨ç»´æŠ¤æ—¶é—´çª—å£è‡ªåŠ¨é‡å¯
    current_hour=$(date +%H)
    if [ $current_hour -ge 2 ] && [ $current_hour -le 5 ]; then
        echo "åœ¨ç»´æŠ¤çª—å£å†…ï¼Œå‡†å¤‡è‡ªåŠ¨é‡å¯..."
        sleep 300  # ç­‰å¾…5åˆ†é’Ÿ
        shutdown -r now
    fi
else
    echo "ç³»ç»Ÿä¸éœ€è¦é‡å¯"
fi
```

### 5.4 å†…æ ¸ç‰ˆæœ¬ç®¡ç†æœ€ä½³å®è·µ


**ğŸ“š å¤šå†…æ ¸ç‰ˆæœ¬ä¿ç•™**
```bash
# æŸ¥çœ‹ç³»ç»Ÿä¿ç•™çš„å†…æ ¸æ•°é‡

grep installonly_limit /etc/yum.conf

# è®¾ç½®ä¿ç•™3ä¸ªå†…æ ¸ç‰ˆæœ¬

echo "installonly_limit=3" >> /etc/yum.conf

# æ‰‹åŠ¨æ¸…ç†æ—§å†…æ ¸ï¼ˆä¿ç•™æœ€æ–°2ä¸ªï¼‰

sudo package-cleanup --oldkernels --count=2
```

**ğŸ”„ å†…æ ¸å›æ»šå‡†å¤‡**
```bash
# æŸ¥çœ‹GRUBå¼•å¯¼èœå•ä¸­çš„å†…æ ¸é€‰é¡¹

sudo grub2-editenv list

# è®¾ç½®é»˜è®¤å¯åŠ¨çš„å†…æ ¸

sudo grub2-set-default 0  # 0è¡¨ç¤ºæœ€æ–°å†…æ ¸

# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å†…æ ¸

sudo grub2-mkconfig -o /boot/grub2/grub.cfg
```

---

## 6. ğŸ”™ æ›´æ–°å›æ»šä¸æ•…éšœæ¢å¤


### 6.1 æ›´æ–°é»‘åå•é…ç½®


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ›´æ–°é»‘åå•**
æ›´æ–°é»‘åå•æ˜¯æŒ‡æ˜ç¡®æŒ‡å®šä¸è¿›è¡Œè‡ªåŠ¨æ›´æ–°çš„è½¯ä»¶åŒ…åˆ—è¡¨ï¼Œé€šå¸¸åŒ…å«å¯¹ä¸šåŠ¡å…³é”®æˆ–å®¹æ˜“å¼•èµ·å…¼å®¹æ€§é—®é¢˜çš„è½¯ä»¶åŒ…ã€‚

**ğŸ”§ é…ç½®æ›´æ–°é»‘åå•**
```ini
# åœ¨yum-cron.confä¸­é…ç½®

[base]
exclude = kernel* mysql* apache* nginx* php*

# æˆ–åœ¨dnf automatic.confä¸­é…ç½®  

[commands]
excludepkgs = kernel*, mysql*, docker*
```

**ğŸ“‹ å¸¸è§é»‘åå•è½¯ä»¶**
```
ğŸ”¸ ç³»ç»Ÿæ ¸å¿ƒï¼škernel*, systemd*, glibc*
ğŸ”¸ æ•°æ®åº“ï¼šmysql*, mariadb*, postgresql*  
ğŸ”¸ WebæœåŠ¡ï¼šapache*, nginx*, tomcat*
ğŸ”¸ å®¹å™¨ï¼šdocker*, podman*, containerd*
ğŸ”¸ ç¼–ç¨‹è¯­è¨€ï¼špython3*, php*, nodejs*
```

### 6.2 æ›´æ–°å‰å¤‡ä»½ç­–ç•¥


**ğŸ’¾ å…³é”®é…ç½®å¤‡ä»½**
```bash
#!/bin/bash

# æ›´æ–°å‰è‡ªåŠ¨å¤‡ä»½è„šæœ¬


BACKUP_DIR="/backup/pre-update-$(date +%Y%m%d-%H%M%S)"
mkdir -p $BACKUP_DIR

# å¤‡ä»½å…³é”®é…ç½®æ–‡ä»¶

cp -r /etc/ $BACKUP_DIR/etc-backup/
cp -r /boot/ $BACKUP_DIR/boot-backup/

# å¤‡ä»½è½¯ä»¶åŒ…åˆ—è¡¨

rpm -qa > $BACKUP_DIR/installed-packages.list
yum history > $BACKUP_DIR/yum-history.log

# å¤‡ä»½æ•°æ®åº“ï¼ˆå¦‚æœæœ‰ï¼‰

if systemctl is-active mysql; then
    mysqldump --all-databases > $BACKUP_DIR/mysql-backup.sql
fi

echo "å¤‡ä»½å®Œæˆï¼š$BACKUP_DIR"
```

### 6.3 æ›´æ–°å›æ»šæ“ä½œ


**ğŸ”„ yumå†å²å›æ»š**
```bash
# æŸ¥çœ‹æ›´æ–°å†å²

sudo yum history

# æŸ¥çœ‹ç‰¹å®šæ›´æ–°çš„è¯¦ç»†ä¿¡æ¯

sudo yum history info <ID>

# å›æ»šåˆ°ä¸Šä¸€æ¬¡æ›´æ–°å‰çŠ¶æ€

sudo yum history undo <ID>

# é‡å¤æ‰§è¡Œç‰¹å®šçš„æ›´æ–°æ“ä½œ

sudo yum history redo <ID>
```

**ğŸ”§ è½¯ä»¶åŒ…çº§åˆ«å›æ»š**
```bash
# é™çº§ç‰¹å®šè½¯ä»¶åŒ…

sudo yum downgrade package-name

# æŸ¥çœ‹è½¯ä»¶åŒ…çš„æ‰€æœ‰å¯ç”¨ç‰ˆæœ¬

yum --showduplicates list package-name

# å®‰è£…ç‰¹å®šç‰ˆæœ¬

sudo yum install package-name-version
```

### 6.4 ç³»ç»Ÿå¿«ç…§ä¸æ¢å¤


**ğŸ“¸ LVMå¿«ç…§å¤‡ä»½**
```bash
# åˆ›å»ºæ ¹åˆ†åŒºå¿«ç…§ï¼ˆéœ€è¦LVMï¼‰

sudo lvcreate -L 2G -s -n root-snapshot /dev/vg0/root

# æŒ‚è½½å¿«ç…§æŸ¥çœ‹å†…å®¹

sudo mkdir /mnt/snapshot
sudo mount /dev/vg0/root-snapshot /mnt/snapshot

# æ¢å¤å¿«ç…§ï¼ˆå±é™©æ“ä½œï¼ï¼‰

sudo umount /
sudo lvconvert --merge /dev/vg0/root-snapshot
```

---

## 7. ğŸ¢ ä¼ä¸šçº§è¡¥ä¸ç®¡ç†


### 7.1 æ›´æ–°æ—¥å¿—è®°å½•ä¸å®¡è®¡


**ğŸ“Š æ—¥å¿—è®°å½•é…ç½®**
```bash
# é…ç½®è¯¦ç»†æ—¥å¿—è®°å½•

sudo vi /etc/yum/yum-cron.conf
```

```ini
[base]
# å¼€å¯è¯¦ç»†æ—¥å¿—

debuglevel = 2
# æ—¥å¿—æ–‡ä»¶ä½ç½®

logfile = /var/log/yum-cron.log
```

**ğŸ” æ—¥å¿—åˆ†æè„šæœ¬**
```bash
#!/bin/bash

# æ›´æ–°æ—¥å¿—åˆ†æè„šæœ¬


LOG_FILE="/var/log/yum-cron.log"
REPORT_FILE="/var/log/update-report-$(date +%Y%m%d).txt"

echo "=== ç³»ç»Ÿæ›´æ–°æŠ¥å‘Š - $(date) ===" > $REPORT_FILE
echo "" >> $REPORT_FILE

# ç»Ÿè®¡æœ¬æœˆæ›´æ–°æ¬¡æ•°

echo "æœ¬æœˆæ›´æ–°ç»Ÿè®¡ï¼š" >> $REPORT_FILE
grep "$(date +%Y-%m)" $LOG_FILE | grep "Updated:" | wc -l >> $REPORT_FILE
echo "" >> $REPORT_FILE

# æœ€è¿‘æ›´æ–°çš„åŒ…

echo "æœ€è¿‘æ›´æ–°çš„è½¯ä»¶åŒ…ï¼š" >> $REPORT_FILE
grep "Updated:" $LOG_FILE | tail -10 >> $REPORT_FILE
echo "" >> $REPORT_FILE

# å‘é€æŠ¥å‘Š

mail -s "ç³»ç»Ÿæ›´æ–°æŠ¥å‘Š" admin@company.com < $REPORT_FILE
```

### 7.2 é›†ä¸­åŒ–è¡¥ä¸ç®¡ç†


**ğŸŒ å†…éƒ¨æ›´æ–°ä»“åº“æ­å»º**
```bash
# åˆ›å»ºæœ¬åœ°yumä»“åº“

sudo mkdir -p /var/www/html/repo/centos7
cd /var/www/html/repo/centos7

# åŒæ­¥å®˜æ–¹ä»“åº“ï¼ˆä»…ä¸‹è½½ï¼Œä¸è‡ªåŠ¨å®‰è£…ï¼‰

sudo rsync -avH --delete rsync://mirror.centos.org/centos/7/ ./

# åˆ›å»ºä»“åº“å…ƒæ•°æ®

sudo createrepo .

# é…ç½®å®¢æˆ·ç«¯ä½¿ç”¨å†…éƒ¨ä»“åº“

sudo vi /etc/yum.repos.d/internal.repo
```

```ini
[internal-base]
name=Internal CentOS Base Repository
baseurl=http://internal-repo.company.com/repo/centos7/os/x86_64/
gpgcheck=1
enabled=1
priority=1
```

### 7.3 æ‰¹é‡æœåŠ¡å™¨ç®¡ç†


**ğŸ”§ Ansibleæ‰¹é‡æ›´æ–°**
```yaml
# update-playbook.yml

---
- hosts: all
  become: yes
  tasks:
    - name: å®‰è£…yum-cron
      yum:
        name: yum-cron
        state: present
        
    - name: é…ç½®yum-cron
      template:
        src: yum-cron.conf.j2
        dest: /etc/yum/yum-cron.conf
        backup: yes
      notify: restart yum-cron
      
    - name: å¯åŠ¨yum-cronæœåŠ¡
      systemd:
        name: yum-cron
        enabled: yes
        state: started
        
  handlers:
    - name: restart yum-cron
      systemd:
        name: yum-cron
        state: restarted
```

**ğŸš€ æ‰§è¡Œæ‰¹é‡é…ç½®**
```bash
# æ‰§è¡ŒAnsible playbook

ansible-playbook -i inventory update-playbook.yml

# æ‰¹é‡æ£€æŸ¥æ›´æ–°çŠ¶æ€

ansible all -m shell -a "systemctl status yum-cron"

# æ‰¹é‡æŸ¥çœ‹å¾…æ›´æ–°åŒ…

ansible all -m shell -a "yum check-update"
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ è‡ªåŠ¨æ›´æ–°æœ¬è´¨**
```
å®šæ—¶æ£€æŸ¥ â†’ è‡ªåŠ¨ä¸‹è½½ â†’ ç­–ç•¥å®‰è£… â†’ é€šçŸ¥åé¦ˆ
```

**ğŸ”¸ ä¸¤å¤§å·¥å…·å¯¹æ¯”**
- **yum-cron**ï¼šé€‚ç”¨äºCentOS 7ç­‰è¾ƒè€ç‰ˆæœ¬ç³»ç»Ÿ
- **dnf-automatic**ï¼šé€‚ç”¨äºRHEL 8+ã€Rocky Linuxç­‰æ–°ç‰ˆæœ¬ç³»ç»Ÿ

**ğŸ”¸ å…³é”®é…ç½®è¦ç‚¹**
- `apply_updates`ï¼šæ§åˆ¶æ˜¯å¦è‡ªåŠ¨å®‰è£…ï¼ˆå…³é”®å†³ç­–ç‚¹ï¼‰
- `upgrade_type`ï¼šæ§åˆ¶æ›´æ–°ç±»å‹ï¼ˆå®‰å…¨/å…¨éƒ¨ï¼‰
- `excludepkgs`ï¼šæ’é™¤å…³é”®è½¯ä»¶åŒ…é¿å…é£é™©

### 8.2 å®è·µåº”ç”¨ç­–ç•¥


**ğŸ¯ åˆ†ç¯å¢ƒç­–ç•¥**
```
æµ‹è¯•ç¯å¢ƒï¼šapply_updates = yes    (è‡ªåŠ¨å®‰è£…éªŒè¯)
ç”Ÿäº§ç¯å¢ƒï¼šapply_updates = no     (ä»…ä¸‹è½½å¾…ç¡®è®¤)
```

**ğŸ”’ å®‰å…¨ä¼˜å…ˆåŸåˆ™**
```
å®‰å…¨æ›´æ–°ï¼šåŠæ—¶è‡ªåŠ¨å®‰è£…
åŠŸèƒ½æ›´æ–°ï¼šäººå·¥è¯„ä¼°åå®‰è£…  
å†…æ ¸æ›´æ–°ï¼šä¸¥æ ¼æµ‹è¯•åæ‰‹åŠ¨å®‰è£…
```

**â° æ—¶é—´çª—å£ç®¡ç†**
```
ä¸šåŠ¡æ—¶é—´ï¼šç¦æ­¢æ›´æ–°æ“ä½œ
ç»´æŠ¤çª—å£ï¼šå…è®¸è‡ªåŠ¨å®‰è£…
ç´§æ€¥æƒ…å†µï¼šå®‰å…¨æ¼æ´ç«‹å³ä¿®å¤
```

### 8.3 é£é™©æ§åˆ¶è¦ç‚¹


**ğŸ›¡ï¸ æ›´æ–°é»‘åå•**
- å†…æ ¸ç›¸å…³è½¯ä»¶åŒ…
- ä¸šåŠ¡å…³é”®ç»„ä»¶
- å®¹æ˜“å¼•èµ·å…¼å®¹æ€§é—®é¢˜çš„è½¯ä»¶

**ğŸ’¾ å¤‡ä»½æ¢å¤æœºåˆ¶**
- æ›´æ–°å‰è‡ªåŠ¨å¤‡ä»½
- yumå†å²è®°å½•ç®¡ç†
- LVMå¿«ç…§æ¢å¤æ–¹æ¡ˆ

**ğŸ“Š ç›‘æ§å®¡è®¡ä½“ç³»**
- æ›´æ–°æ—¥å¿—è¯¦ç»†è®°å½•
- å®šæœŸç”Ÿæˆæ›´æ–°æŠ¥å‘Š
- å¼‚å¸¸æƒ…å†µåŠæ—¶å‘Šè­¦

### 8.4 ä¼ä¸šçº§ç®¡ç†


**ğŸ—ï¸ åŸºç¡€è®¾æ–½**
```
å†…éƒ¨æ›´æ–°ä»“åº“ â†’ ç»Ÿä¸€è½¯ä»¶åŒ…ç‰ˆæœ¬
æ‰¹é‡ç®¡ç†å·¥å…· â†’ è‡ªåŠ¨åŒ–é…ç½®éƒ¨ç½²
ç›‘æ§å‘Šè­¦ç³»ç»Ÿ â†’ å®æ—¶çŠ¶æ€è·Ÿè¸ª
```

**ğŸ“ˆ æŒç»­æ”¹è¿›**
- æ ¹æ®æ›´æ–°æ•ˆæœè°ƒæ•´ç­–ç•¥
- å®šæœŸè¯„ä¼°é»‘åå•è½¯ä»¶
- ä¼˜åŒ–æ›´æ–°æ—¶é—´çª—å£
- å®Œå–„å›æ»šæµç¨‹

### 8.5 å®é™…åº”ç”¨å»ºè®®


**ğŸš€ æ–°æ‰‹èµ·æ­¥å»ºè®®**
1. ä»æµ‹è¯•ç¯å¢ƒå¼€å§‹å®è·µ
2. å…ˆé…ç½®ä»…å®‰å…¨æ›´æ–°
3. è®¾ç½®é‚®ä»¶é€šçŸ¥ç›‘æ§æ•ˆæœ
4. é€æ­¥æ‰©å¤§è‡ªåŠ¨æ›´æ–°èŒƒå›´

**âš¡ è¿›é˜¶ä¼˜åŒ–æ–¹å‘**
1. æ­å»ºå†…éƒ¨æ›´æ–°ä»“åº“
2. å®ç°æ‰¹é‡æœåŠ¡å™¨ç®¡ç†
3. é›†æˆç›‘æ§å‘Šè­¦ç³»ç»Ÿ
4. å»ºç«‹å®Œæ•´çš„å˜æ›´æµç¨‹

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- å®‰å…¨ç¬¬ä¸€ï¼Œæµ‹è¯•å…ˆè¡Œï¼Œç”Ÿäº§è°¨æ…
- è‡ªåŠ¨åŒ–ææ•ˆï¼Œç­–ç•¥æ§é£é™©ï¼Œç›‘æ§ä¿è´¨é‡
- åˆ†ç¯å¢ƒç®¡ç†ï¼Œåˆ†ç±»æ›´æ–°ï¼Œåˆ†æ—¶æ‰§è¡Œ
- æ—¥å¿—è®°å½•å…¨ï¼Œå›æ»šæ–¹æ¡ˆå¤‡ï¼Œåº”æ€¥å“åº”å¿«