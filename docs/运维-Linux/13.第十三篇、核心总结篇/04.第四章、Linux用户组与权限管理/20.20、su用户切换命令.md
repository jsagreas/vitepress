---
title: 20ã€suç”¨æˆ·åˆ‡æ¢å‘½ä»¤
---
## ğŸ“š ç›®å½•

1. [suå‘½ä»¤åŸºæœ¬æ¦‚å¿µ](#1-suå‘½ä»¤åŸºæœ¬æ¦‚å¿µ)
2. [suå‘½ä»¤åŸºæœ¬ç”¨æ³•](#2-suå‘½ä»¤åŸºæœ¬ç”¨æ³•)
3. [å®Œæ•´ç¯å¢ƒåˆ‡æ¢su -](#3-å®Œæ•´ç¯å¢ƒåˆ‡æ¢su-)
4. [æŒ‡å®šç”¨æˆ·åˆ‡æ¢](#4-æŒ‡å®šç”¨æˆ·åˆ‡æ¢)
5. [suå‘½ä»¤å®‰å…¨æ—¥å¿—](#5-suå‘½ä»¤å®‰å…¨æ—¥å¿—)
6. [wheelç»„æƒé™æ§åˆ¶](#6-wheelç»„æƒé™æ§åˆ¶)
7. [suå‘½ä»¤é™åˆ¶ç­–ç•¥](#7-suå‘½ä»¤é™åˆ¶ç­–ç•¥)
8. [su vs sudoé€‰æ‹©ç­–ç•¥](#8-su-vs-sudoé€‰æ‹©ç­–ç•¥)
9. [suå®‰å…¨é…ç½®å®è·µ](#9-suå®‰å…¨é…ç½®å®è·µ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ suå‘½ä»¤åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯suå‘½ä»¤


**suå‘½ä»¤**å°±æ˜¯**S**witch **U**serçš„ç¼©å†™ï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯"åˆ‡æ¢ç”¨æˆ·"çš„æ„æ€ã€‚ç®€å•ç†è§£ï¼Œå°±æ˜¯è®©ä½ åœ¨å½“å‰ç»ˆç«¯é‡Œå˜æˆå¦ä¸€ä¸ªç”¨æˆ·èº«ä»½æ¥æ‰§è¡Œå‘½ä»¤ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦suå‘½ä»¤ï¼Ÿ**
```
æ—¥å¸¸åœºæ™¯ä¸¾ä¾‹ï¼š
ä½ æ˜¯æ™®é€šç”¨æˆ·johnï¼Œæƒ³è¦å®‰è£…è½¯ä»¶
â†’ éœ€è¦rootæƒé™æ‰èƒ½å®‰è£…
â†’ ä½¿ç”¨suåˆ‡æ¢åˆ°rootèº«ä»½
â†’ å®‰è£…å®Œæˆååˆ‡æ¢å›æ™®é€šç”¨æˆ·

å°±åƒä½ åœ¨åŠå…¬å®¤ï¼Œéœ€è¦ç”¨è€æ¿çš„æƒé™ç­¾å­—
â†’ ä¸´æ—¶"å˜æˆ"è€æ¿èº«ä»½
â†’ ç­¾å®Œå­—åæ¢å¤è‡ªå·±èº«ä»½
```

### 1.2 suå‘½ä»¤çš„æ ¸å¿ƒåŸç†


**èº«ä»½åˆ‡æ¢æœºåˆ¶**ï¼š
```
å½“å‰ç”¨æˆ·ç¯å¢ƒ          suå‘½ä»¤æ‰§è¡Œ          ç›®æ ‡ç”¨æˆ·ç¯å¢ƒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·: john  â”‚   â†’    â”‚   su    â”‚   â†’    â”‚ ç”¨æˆ·: root  â”‚
â”‚ UID: 1001   â”‚        â”‚ éªŒè¯å¯†ç  â”‚        â”‚ UID: 0      â”‚
â”‚ æƒé™: æ™®é€š  â”‚        â”‚ åˆ‡æ¢èº«ä»½ â”‚        â”‚ æƒé™: è¶…çº§  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”‘ å…³é”®ç†è§£**ï¼š
- suä¸æ˜¯ç™»å½•æ–°ç”¨æˆ·ï¼Œè€Œæ˜¯åœ¨**å½“å‰ç»ˆç«¯**é‡Œåˆ‡æ¢èº«ä»½
- éœ€è¦è¾“å…¥**ç›®æ ‡ç”¨æˆ·çš„å¯†ç **ï¼ˆä¸æ˜¯å½“å‰ç”¨æˆ·å¯†ç ï¼‰
- åˆ‡æ¢åè·å¾—ç›®æ ‡ç”¨æˆ·çš„**æ‰€æœ‰æƒé™å’Œç¯å¢ƒ**

### 1.3 suå‘½ä»¤çš„åŸºæœ¬è¯­æ³•


```bash
su [é€‰é¡¹] [ç”¨æˆ·å]
```

**å¸¸ç”¨æ ¼å¼è¯´æ˜**ï¼š
- `su` - åˆ‡æ¢åˆ°rootç”¨æˆ·ï¼ˆé»˜è®¤ï¼‰
- `su root` - æ˜ç¡®æŒ‡å®šåˆ‡æ¢åˆ°rootç”¨æˆ·
- `su - root` - å®Œæ•´ç¯å¢ƒåˆ‡æ¢åˆ°rootç”¨æˆ·
- `su john` - åˆ‡æ¢åˆ°johnç”¨æˆ·

---

## 2. âš¡ suå‘½ä»¤åŸºæœ¬ç”¨æ³•


### 2.1 æœ€ç®€å•çš„suä½¿ç”¨


**åˆ‡æ¢åˆ°rootç”¨æˆ·**ï¼š
```bash
# å½“å‰æ˜¯æ™®é€šç”¨æˆ·
[john@server ~]$ whoami
john

# ä½¿ç”¨suåˆ‡æ¢åˆ°root
[john@server ~]$ su
Password: [è¾“å…¥rootå¯†ç ]

# æˆåŠŸåˆ‡æ¢ï¼Œæç¤ºç¬¦å˜åŒ–
[root@server john]# whoami
root
```

**ğŸ” æ³¨æ„è§‚å¯Ÿ**ï¼š
- æç¤ºç¬¦ä» `$` å˜æˆ `#`ï¼ˆè¡¨ç¤ºè¶…çº§ç”¨æˆ·ï¼‰
- ç”¨æˆ·åä» `john` å˜æˆ `root`
- ä½†å·¥ä½œç›®å½•è¿˜åœ¨ `/home/john`

### 2.2 é€€å‡ºsuç¯å¢ƒ


```bash
# æ–¹æ³•1ï¼šä½¿ç”¨exitå‘½ä»¤
[root@server john]# exit
[john@server ~]$ 

# æ–¹æ³•2ï¼šä½¿ç”¨Ctrl+Då¿«æ·é”®
[root@server john]# [æŒ‰Ctrl+D]
[john@server ~]$ 

# æ–¹æ³•3ï¼šä½¿ç”¨logoutå‘½ä»¤
[root@server john]# logout
[john@server ~]$ 
```

### 2.3 suæ‰§è¡Œè¿‡ç¨‹è§£æ


```
suå‘½ä»¤æ‰§è¡Œæµç¨‹ï¼š
ç”¨æˆ·è¾“å…¥su
     â†“
ç³»ç»Ÿæç¤ºè¾“å…¥ç›®æ ‡ç”¨æˆ·å¯†ç 
     â†“
éªŒè¯å¯†ç æ­£ç¡®æ€§
     â†“
åˆ›å»ºæ–°çš„shellè¿›ç¨‹
     â†“
è®¾ç½®æ–°çš„ç”¨æˆ·IDå’Œç»„ID
     â†“
åŠ è½½ç›®æ ‡ç”¨æˆ·ç¯å¢ƒï¼ˆéƒ¨åˆ†ï¼‰
     â†“
æ˜¾ç¤ºæ–°çš„å‘½ä»¤æç¤ºç¬¦
```

**å®é™…æ¼”ç¤º**ï¼š
```bash
# æŸ¥çœ‹å½“å‰è¿›ç¨‹
[john@server ~]$ ps -ef | grep bash
john  1234  1230  bash

# åˆ‡æ¢ç”¨æˆ·åæŸ¥çœ‹è¿›ç¨‹
[root@server john]# ps -ef | grep bash
john  1234  1230  bash      â† åŸæ¥çš„bashè¿›ç¨‹
root  1567  1234  bash      â† æ–°çš„bashè¿›ç¨‹ï¼ˆsuåˆ›å»ºï¼‰
```

---

## 3. ğŸ  å®Œæ•´ç¯å¢ƒåˆ‡æ¢su -


### 3.1 su - çš„å«ä¹‰å’Œä½œç”¨


**æ™®é€šsuçš„é—®é¢˜**ï¼š
```bash
[john@server ~]$ su
[root@server john]# echo $HOME
/home/john                    â† è¿˜æ˜¯johnçš„å®¶ç›®å½•

[root@server john]# echo $PATH
/usr/local/bin:/bin:/usr/bin  â† å¯èƒ½ç¼ºå°‘ç®¡ç†å‘˜è·¯å¾„

[root@server john]# pwd
/home/john                    â† å·¥ä½œç›®å½•æ²¡å˜
```

**su - çš„å®Œæ•´åˆ‡æ¢**ï¼š
```bash
[john@server ~]$ su -
Password: [è¾“å…¥rootå¯†ç ]

[root@server ~]# echo $HOME
/root                         â† rootçš„å®¶ç›®å½•

[root@server ~]# echo $PATH
/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin
                             â† åŒ…å«ç®¡ç†å‘˜ä¸“ç”¨è·¯å¾„

[root@server ~]# pwd
/root                        â† åˆ‡æ¢åˆ°rootå®¶ç›®å½•
```

### 3.2 ç¯å¢ƒå˜é‡å¯¹æ¯”


| ç¯å¢ƒå˜é‡ | **æ™®é€šsu** | **su -** | **è¯´æ˜** |
|----------|-----------|----------|----------|
| `$HOME` | `/home/john` | `/root` | `su -`æ­£ç¡®è®¾ç½®å®¶ç›®å½• |
| `$USER` | `root` | `root` | `ä¸¤è€…éƒ½æ­£ç¡®` |
| `$PATH` | `ç”¨æˆ·è·¯å¾„` | `ç®¡ç†å‘˜è·¯å¾„` | `su -`åŒ…å«ç³»ç»Ÿç®¡ç†å‘½ä»¤è·¯å¾„ |
| `$PWD` | `/home/john` | `/root` | `su -`åˆ‡æ¢åˆ°ç›®æ ‡ç”¨æˆ·å®¶ç›®å½• |
| `$SHELL` | `/bin/bash` | `/bin/bash` | `ä¸¤è€…ç›¸åŒ` |

### 3.3 ä»€ä¹ˆæ—¶å€™ç”¨su -


**ğŸ“‹ ä½¿ç”¨åœºæ™¯å¯¹æ¯”**ï¼š

**ä½¿ç”¨su -çš„æƒ…å†µ**ï¼š
- âœ… **ç³»ç»Ÿç®¡ç†ä»»åŠ¡** - éœ€è¦å®Œæ•´çš„ç®¡ç†å‘˜ç¯å¢ƒ
- âœ… **è¿è¡Œç®¡ç†å‘˜è„šæœ¬** - è„šæœ¬ä¾èµ–ç‰¹å®šç¯å¢ƒå˜é‡
- âœ… **é•¿æœŸä½¿ç”¨root** - éœ€è¦å®Œæ•´çš„rootå·¥ä½œç¯å¢ƒ

**ä½¿ç”¨æ™®é€šsuçš„æƒ…å†µ**ï¼š
- âœ… **å¿«é€Ÿæƒé™æå‡** - ä¸´æ—¶æ‰§è¡Œä¸€ä¸¤ä¸ªå‘½ä»¤
- âœ… **ä¿æŒå½“å‰ç›®å½•** - éœ€è¦åœ¨å½“å‰è·¯å¾„ä¸‹å·¥ä½œ
- âœ… **è°ƒè¯•é—®é¢˜** - éœ€è¦åœ¨é—®é¢˜å‘ç”Ÿçš„ç¯å¢ƒä¸­æ’æŸ¥

### 3.4 å®é™…ä½¿ç”¨ç¤ºä¾‹


```bash
# åœºæ™¯1ï¼šç³»ç»Ÿç»´æŠ¤ï¼ˆæ¨èsu -ï¼‰
[john@server ~]$ su -
[root@server ~]# systemctl status httpd
[root@server ~]# cd /var/log
[root@server log]# tail -f messages

# åœºæ™¯2ï¼šå½“å‰ç›®å½•æƒé™æ“ä½œï¼ˆæ¨èsuï¼‰
[john@server project]$ ls -l file.txt
-rw-------. 1 root root 100 Jan 21 file.txt
[john@server project]$ su
[root@server project]# chmod 644 file.txt
[root@server project]# exit
[john@server project]$ cat file.txt  # ç°åœ¨å¯ä»¥è¯»å–äº†
```

---

## 4. ğŸ‘¥ æŒ‡å®šç”¨æˆ·åˆ‡æ¢


### 4.1 åˆ‡æ¢åˆ°æŒ‡å®šç”¨æˆ·


**åŸºæœ¬è¯­æ³•**ï¼š
```bash
su [ç”¨æˆ·å]          # æ™®é€šåˆ‡æ¢
su - [ç”¨æˆ·å]        # å®Œæ•´ç¯å¢ƒåˆ‡æ¢
```

**å®é™…æ“ä½œç¤ºä¾‹**ï¼š
```bash
# ä»johnåˆ‡æ¢åˆ°alice
[john@server ~]$ su alice
Password: [è¾“å…¥aliceçš„å¯†ç ]
[alice@server john]$ whoami
alice

# å®Œæ•´ç¯å¢ƒåˆ‡æ¢åˆ°alice
[john@server ~]$ su - alice
Password: [è¾“å…¥aliceçš„å¯†ç ]
[alice@server ~]$ pwd
/home/alice
```

### 4.2 å¸¸è§ç”¨æˆ·åˆ‡æ¢åœºæ™¯


**ğŸ“Š ç”¨æˆ·åˆ‡æ¢åœºæ™¯è¡¨**ï¼š

| åˆ‡æ¢æ–¹å‘ | **å‘½ä»¤** | **éœ€è¦å¯†ç ** | **å¸¸è§ç”¨é€”** |
|----------|----------|-------------|-------------|
| `æ™®é€šç”¨æˆ· â†’ root` | `su -` | `rootå¯†ç ` | `ç³»ç»Ÿç®¡ç†` |
| `root â†’ æ™®é€šç”¨æˆ·` | `su - john` | `æ— éœ€å¯†ç ` | `æµ‹è¯•ç”¨æˆ·ç¯å¢ƒ` |
| `æ™®é€šç”¨æˆ· â†’ æ™®é€šç”¨æˆ·` | `su - alice` | `aliceå¯†ç ` | `ä»£ç†å·¥ä½œ` |
| `æœåŠ¡è´¦æˆ·åˆ‡æ¢` | `su - nginx` | `é€šå¸¸ç¦ç”¨ç™»å½•` | `æœåŠ¡è°ƒè¯•` |

### 4.3 rootç”¨æˆ·çš„ç‰¹æƒ


**rootåˆ‡æ¢åˆ°ä»»ä½•ç”¨æˆ·æ— éœ€å¯†ç **ï¼š
```bash
# rootå¯ä»¥æ— å¯†ç åˆ‡æ¢åˆ°ä»»ä½•ç”¨æˆ·
[root@server ~]# su - john
[john@server ~]$ whoami
john

[root@server ~]# su - alice  
[alice@server ~]$ whoami
alice
```

**ğŸ”‘ ç†è§£åŸå› **ï¼š
- rootæ˜¯ç³»ç»Ÿçš„**è¶…çº§ç”¨æˆ·**
- æ‹¥æœ‰**ç»•è¿‡æ‰€æœ‰å®‰å…¨æ£€æŸ¥**çš„æƒé™
- å¯ä»¥**æ¨¡æ‹Ÿä»»ä½•ç”¨æˆ·èº«ä»½**è¿›è¡Œæ“ä½œ

### 4.4 æœåŠ¡è´¦æˆ·åˆ‡æ¢æ³¨æ„äº‹é¡¹


**ç³»ç»ŸæœåŠ¡è´¦æˆ·ç‰¹ç‚¹**ï¼š
```bash
# æŸ¥çœ‹ç³»ç»Ÿç”¨æˆ·
[root@server ~]# grep "nologin\|false" /etc/passwd
nginx:x:498:498:nginx:/var/lib/nginx:/sbin/nologin
mysql:x:499:499:MySQL:/var/lib/mysql:/bin/false
```

**åˆ‡æ¢åˆ°æœåŠ¡è´¦æˆ·**ï¼š
```bash
# æ–¹æ³•1ï¼šä½¿ç”¨-så‚æ•°æŒ‡å®šshell
[root@server ~]# su -s /bin/bash nginx
bash-4.2$ whoami
nginx

# æ–¹æ³•2ï¼šä¸´æ—¶ä¿®æ”¹shellï¼ˆä¸æ¨èï¼‰
[root@server ~]# usermod -s /bin/bash nginx
[root@server ~]# su - nginx
[nginx@server ~]$ 
```

**âš ï¸ é‡è¦æé†’**ï¼š
- æœåŠ¡è´¦æˆ·é€šå¸¸**ç¦æ­¢ç™»å½•shell**
- åˆ‡æ¢åè¦åŠæ—¶**æ¢å¤åŸå§‹shellè®¾ç½®**
- ä»…ç”¨äº**è°ƒè¯•å’Œæ•…éšœæ’æŸ¥**

---

## 5. ğŸ“Š suå‘½ä»¤å®‰å…¨æ—¥å¿—


### 5.1 suæ—¥å¿—è®°å½•ä½ç½®


**ä¸»è¦æ—¥å¿—æ–‡ä»¶**ï¼š
```bash
# CentOS/RHELç³»ç»Ÿ
/var/log/secure     # suç™»å½•å°è¯•è®°å½•
/var/log/messages   # ç³»ç»Ÿæ¶ˆæ¯æ—¥å¿—

# Ubuntu/Debianç³»ç»Ÿ  
/var/log/auth.log   # è®¤è¯ç›¸å…³æ—¥å¿—
/var/log/syslog     # ç³»ç»Ÿæ—¥å¿—
```

### 5.2 æŸ¥çœ‹suä½¿ç”¨è®°å½•


**æˆåŠŸçš„suè®°å½•**ï¼š
```bash
[root@server ~]# grep "su:" /var/log/secure
Jan 21 10:15:32 server su: pam_unix(su:session): session opened for user root by john(uid=1001)
Jan 21 10:18:45 server su: pam_unix(su:session): session closed for user root
Jan 21 10:20:15 server su: pam_unix(su-l:session): session opened for user alice by john(uid=1001)
```

**å¤±è´¥çš„suè®°å½•**ï¼š
```bash
Jan 21 10:25:30 server su: pam_unix(su:auth): authentication failure; logname=john uid=1001 euid=1001 tty=pts/0 ruser=john rhost=  user=root
Jan 21 10:25:33 server su: FAILED SU (to root) john on pts/0
```

### 5.3 æ—¥å¿—ä¿¡æ¯è§£è¯»


**æ—¥å¿—å­—æ®µå«ä¹‰**ï¼š
```
æ—¶é—´æˆ³     ä¸»æœºå   æœåŠ¡   è®¤è¯æ¨¡å—                            è¯¦ç»†ä¿¡æ¯
  â†“          â†“       â†“        â†“                                  â†“
Jan 21 10:15:32 server su: pam_unix(su:session): session opened for user root by john(uid=1001)
```

**ğŸ” å…³é”®ä¿¡æ¯**ï¼š
- **æ—¶é—´æˆ³** - æ“ä½œå‘ç”Ÿæ—¶é—´
- **æœåŠ¡** - suå‘½ä»¤
- **è®¤è¯ç»“æœ** - æˆåŠŸ(session opened)æˆ–å¤±è´¥(authentication failure)
- **ç›®æ ‡ç”¨æˆ·** - è¦åˆ‡æ¢åˆ°çš„ç”¨æˆ·
- **æºç”¨æˆ·** - æ‰§è¡Œsuå‘½ä»¤çš„ç”¨æˆ·

### 5.4 ç›‘æ§suä½¿ç”¨


**å®æ—¶ç›‘æ§suæ´»åŠ¨**ï¼š
```bash
# å®æ—¶æŸ¥çœ‹suæ—¥å¿—
[root@server ~]# tail -f /var/log/secure | grep su:

# ç»Ÿè®¡suä½¿ç”¨æƒ…å†µ
[root@server ~]# grep "su:" /var/log/secure | grep "$(date '+%b %d')" | wc -l
15

# æŸ¥çœ‹ä»Šå¤©çš„suå¤±è´¥è®°å½•
[root@server ~]# grep "FAILED SU" /var/log/secure | grep "$(date '+%b %d')"
```

**å®‰å…¨åˆ†æè„šæœ¬ç¤ºä¾‹**ï¼š
```bash
#!/bin/bash
# su_monitor.sh - suä½¿ç”¨ç›‘æ§è„šæœ¬

echo "=== ä»Šæ—¥suä½¿ç”¨ç»Ÿè®¡ ==="
TODAY=$(date '+%b %d')

# æˆåŠŸæ¬¡æ•°
SUCCESS=$(grep "su:.*session opened" /var/log/secure | grep "$TODAY" | wc -l)
echo "æˆåŠŸåˆ‡æ¢æ¬¡æ•°: $SUCCESS"

# å¤±è´¥æ¬¡æ•°  
FAILED=$(grep "FAILED SU" /var/log/secure | grep "$TODAY" | wc -l)
echo "å¤±è´¥å°è¯•æ¬¡æ•°: $FAILED"

# æœ€è¿‘çš„suç”¨æˆ·
echo -e "\n=== æœ€è¿‘suç”¨æˆ· ==="
grep "su:.*session opened" /var/log/secure | grep "$TODAY" | tail -5
```

---

## 6. ğŸ›¡ï¸ wheelç»„æƒé™æ§åˆ¶


### 6.1 ä»€ä¹ˆæ˜¯wheelç»„


**wheelç»„**æ˜¯Linuxç³»ç»Ÿä¸­çš„ä¸€ä¸ª**ç‰¹æ®Šç”¨æˆ·ç»„**ï¼Œä¸“é—¨ç”¨æ¥æ§åˆ¶å“ªäº›ç”¨æˆ·å¯ä»¥ä½¿ç”¨suå‘½ä»¤åˆ‡æ¢åˆ°rootã€‚

**wheelç»„çš„å†å²**ï¼š
```
wheelç»„æ¦‚å¿µæ¥æºäºUnixç³»ç»Ÿ
"wheel" = "big wheel" = é‡è¦äººç‰©
åªæœ‰wheelç»„æˆå‘˜æ‰èƒ½æˆä¸ºroot
è¿™æ˜¯ä¸€ç§ä¼ ç»Ÿçš„å®‰å…¨æœºåˆ¶
```

### 6.2 æ£€æŸ¥wheelç»„é…ç½®


**æŸ¥çœ‹wheelç»„æˆå‘˜**ï¼š
```bash
# æ–¹æ³•1ï¼šæŸ¥çœ‹ç»„æ–‡ä»¶
[root@server ~]# grep wheel /etc/group
wheel:x:10:john,alice

# æ–¹æ³•2ï¼šæŸ¥çœ‹ç”¨æˆ·æ‰€å±ç»„
[root@server ~]# groups john
john : john wheel

# æ–¹æ³•3ï¼šä½¿ç”¨idå‘½ä»¤
[root@server ~]# id john
uid=1001(john) gid=1001(john) groups=1001(john),10(wheel)
```

### 6.3 é…ç½®wheelç»„é™åˆ¶


**ç¼–è¾‘PAMé…ç½®æ–‡ä»¶**ï¼š
```bash
[root@server ~]# vim /etc/pam.d/su
```

**å¯ç”¨wheelç»„é™åˆ¶**ï¼š
```bash
# æ‰¾åˆ°è¿™ä¸€è¡Œï¼ˆé€šå¸¸è¢«æ³¨é‡Šï¼‰
#auth           required        pam_wheel.so use_uid

# å–æ¶ˆæ³¨é‡Šå¯ç”¨é™åˆ¶
auth            required        pam_wheel.so use_uid

# ä¿å­˜é€€å‡º
```

### 6.4 wheelç»„é™åˆ¶æ•ˆæœ


**wheelç»„æˆå‘˜å¯ä»¥su**ï¼š
```bash
[john@server ~]$ groups
john wheel
[john@server ~]$ su -
Password: [è¾“å…¥rootå¯†ç ]
[root@server ~]# whoami
root
```

**éwheelç»„æˆå‘˜è¢«æ‹’ç»**ï¼š
```bash
[bob@server ~]$ groups  
bob
[bob@server ~]$ su -
Password: [å³ä½¿å¯†ç æ­£ç¡®ä¹Ÿè¢«æ‹’ç»]
su: Permission denied
```

### 6.5 ç®¡ç†wheelç»„æˆå‘˜


**æ·»åŠ ç”¨æˆ·åˆ°wheelç»„**ï¼š
```bash
# æ–¹æ³•1ï¼šä½¿ç”¨usermodå‘½ä»¤
[root@server ~]# usermod -G wheel alice

# æ–¹æ³•2ï¼šä½¿ç”¨gpasswdå‘½ä»¤  
[root@server ~]# gpasswd -a alice wheel
Adding user alice to group wheel

# éªŒè¯æ·»åŠ ç»“æœ
[root@server ~]# groups alice
alice : alice wheel
```

**ä»wheelç»„ç§»é™¤ç”¨æˆ·**ï¼š
```bash
# ä½¿ç”¨gpasswdå‘½ä»¤
[root@server ~]# gpasswd -d alice wheel
Removing user alice from group wheel

# éªŒè¯ç§»é™¤ç»“æœ
[root@server ~]# groups alice
alice : alice
```

**âš ï¸ å®‰å…¨å»ºè®®**ï¼š
- åªå°†**çœŸæ­£éœ€è¦**rootæƒé™çš„ç”¨æˆ·åŠ å…¥wheelç»„
- å®šæœŸ**å®¡æ ¸**wheelç»„æˆå‘˜
- è€ƒè™‘ä½¿ç”¨**sudo**æ›¿ä»£suæä¾›æ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶

---

## 7. ğŸ”’ suå‘½ä»¤é™åˆ¶ç­–ç•¥


### 7.1 åŸºäºæ—¶é—´çš„é™åˆ¶


**é…ç½®æ—¶é—´é™åˆ¶**ï¼š
```bash
# ç¼–è¾‘PAMæ—¶é—´é™åˆ¶é…ç½®
[root@server ~]# vim /etc/security/time.conf

# æ·»åŠ æ—¶é—´é™åˆ¶è§„åˆ™
su;*;*;Wk0800-1800
# å«ä¹‰ï¼šsuå‘½ä»¤åªèƒ½åœ¨å·¥ä½œæ—¥8:00-18:00ä½¿ç”¨
```

**å¯ç”¨æ—¶é—´é™åˆ¶æ¨¡å—**ï¼š
```bash
[root@server ~]# vim /etc/pam.d/su
# æ·»åŠ è¿™ä¸€è¡Œ
account    required     pam_time.so
```

### 7.2 åŸºäºç»ˆç«¯çš„é™åˆ¶


**é™åˆ¶suä½¿ç”¨çš„ç»ˆç«¯**ï¼š
```bash
# ç¼–è¾‘å®‰å…¨ç»ˆç«¯é…ç½®
[root@server ~]# vim /etc/securetty

# åªå…è®¸åœ¨è¿™äº›ç»ˆç«¯ä½¿ç”¨su
console
tty1
tty2
tty3
# ä¸åŒ…å«pts/* è¡¨ç¤ºç¦æ­¢é€šè¿‡SSHä½¿ç”¨su
```

### 7.3 åŸºäºç½‘ç»œçš„é™åˆ¶


**é™åˆ¶æ¥æºIP**ï¼š
```bash
# ä½¿ç”¨pam_accessæ¨¡å—
[root@server ~]# vim /etc/security/access.conf

# åªå…è®¸æœ¬åœ°ç½‘ç»œä½¿ç”¨su
+ : wheel : 192.168.1.0/24
+ : wheel : LOCAL
- : ALL : ALL
```

**åœ¨PAMä¸­å¯ç”¨**ï¼š
```bash
[root@server ~]# vim /etc/pam.d/su
# æ·»åŠ è®¿é—®æ§åˆ¶
account    required     pam_access.so
```

### 7.4 ç™»å½•å¤±è´¥é™åˆ¶


**é…ç½®å¤±è´¥é”å®š**ï¼š
```bash
[root@server ~]# vim /etc/pam.d/su

# æ·»åŠ å¤±è´¥é”å®šæœºåˆ¶
auth        required      pam_tally2.so deny=3 unlock_time=300
account     required      pam_tally2.so
```

**è§£é”è¢«é”å®šçš„ç”¨æˆ·**ï¼š
```bash
# æŸ¥çœ‹å¤±è´¥æ¬¡æ•°
[root@server ~]# pam_tally2 --user=john

# æ‰‹åŠ¨è§£é”ç”¨æˆ·
[root@server ~]# pam_tally2 --user=john --reset
```

---

## 8. âš–ï¸ su vs sudoé€‰æ‹©ç­–ç•¥


### 8.1 suå’Œsudoçš„æ ¹æœ¬åŒºåˆ«


**suå‘½ä»¤ç‰¹ç‚¹**ï¼š
```
å·¥ä½œæ–¹å¼ï¼šåˆ‡æ¢ç”¨æˆ·èº«ä»½
æƒé™è·å–ï¼šè·å¾—ç›®æ ‡ç”¨æˆ·çš„å®Œæ•´æƒé™
å¯†ç è¦æ±‚ï¼šéœ€è¦ç›®æ ‡ç”¨æˆ·å¯†ç 
ä½¿ç”¨æ—¶é•¿ï¼šå¯ä»¥é•¿æœŸä¿æŒåˆ‡æ¢çŠ¶æ€
å®¡è®¡ç²’åº¦ï¼šåªèƒ½è®°å½•åˆ‡æ¢è¡Œä¸ºï¼Œä¸è®°å½•å…·ä½“æ“ä½œ
```

**sudoå‘½ä»¤ç‰¹ç‚¹**ï¼š
```
å·¥ä½œæ–¹å¼ï¼šä»¥å…¶ä»–ç”¨æˆ·èº«ä»½æ‰§è¡Œå•ä¸ªå‘½ä»¤
æƒé™è·å–ï¼šæ‰§è¡Œç‰¹å®šå‘½ä»¤çš„æƒé™
å¯†ç è¦æ±‚ï¼šéœ€è¦è‡ªå·±çš„å¯†ç ï¼ˆå¯é…ç½®ï¼‰
ä½¿ç”¨æ—¶é•¿ï¼šæ‰§è¡Œå®Œå‘½ä»¤ç«‹å³æ¢å¤åŸèº«ä»½
å®¡è®¡ç²’åº¦ï¼šè®°å½•æ¯ä¸ªæ‰§è¡Œçš„å‘½ä»¤
```

### 8.2 å¯¹æ¯”åˆ†æè¡¨


| ç‰¹æ€§ | **su** | **sudo** | **é€‚ç”¨åœºæ™¯** |
|------|--------|----------|-------------|
| **æƒé™èŒƒå›´** | `å®Œæ•´ç”¨æˆ·æƒé™` | `æŒ‡å®šå‘½ä»¤æƒé™` | `sudoæ›´ç²¾ç¡®` |
| **å¯†ç è¦æ±‚** | `ç›®æ ‡ç”¨æˆ·å¯†ç ` | `è‡ªå·±å¯†ç ` | `sudoæ›´å®‰å…¨` |
| **ä¼šè¯ä¿æŒ** | `å¯é•¿æœŸä¿æŒ` | `å•å‘½ä»¤æ‰§è¡Œ` | `çœ‹ä½¿ç”¨ä¹ æƒ¯` |
| **å®¡è®¡èƒ½åŠ›** | `åŸºæœ¬è®°å½•` | `è¯¦ç»†è®°å½•` | `sudoå®¡è®¡æ›´å¥½` |
| **é…ç½®å¤æ‚åº¦** | `ç®€å•` | `ç›¸å¯¹å¤æ‚` | `sué…ç½®ç®€å•` |
| **å®‰å…¨é£é™©** | `è¾ƒé«˜` | `è¾ƒä½` | `sudoæ›´å®‰å…¨` |

### 8.3 ä½¿ç”¨åœºæ™¯é€‰æ‹©


**é€‰æ‹©suçš„æƒ…å†µ**ï¼š
- âœ… **ç³»ç»Ÿç»´æŠ¤ä»»åŠ¡** - éœ€è¦é•¿æ—¶é—´rootæƒé™
- âœ… **è„šæœ¬æ‰§è¡Œ** - è„šæœ¬éœ€è¦å®Œæ•´ç¯å¢ƒ
- âœ… **å­¦ä¹ è°ƒè¯•** - éœ€è¦å®Œæ•´çš„ç”¨æˆ·ç¯å¢ƒä½“éªŒ
- âœ… **ç´§æ€¥æƒ…å†µ** - sudoé…ç½®æŸåæ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ

**é€‰æ‹©sudoçš„æƒ…å†µ**ï¼š
- âœ… **æ—¥å¸¸ç®¡ç†** - å¤§éƒ¨åˆ†ç³»ç»Ÿç®¡ç†ä»»åŠ¡
- âœ… **å¤šç”¨æˆ·ç¯å¢ƒ** - éœ€è¦ç²¾ç¡®æƒé™æ§åˆ¶
- âœ… **åˆè§„è¦æ±‚** - éœ€è¦è¯¦ç»†çš„æ“ä½œå®¡è®¡
- âœ… **å®‰å…¨æ•æ„Ÿ** - é«˜å®‰å…¨è¦æ±‚çš„ç¯å¢ƒ

### 8.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ”¸ ä¼ä¸šç¯å¢ƒæ¨è**ï¼š
```bash
# 1. ç¦ç”¨rootç›´æ¥SSHç™»å½•
[root@server ~]# vim /etc/ssh/sshd_config
PermitRootLogin no

# 2. é…ç½®sudoæ›¿ä»£å¤§éƒ¨åˆ†suä½¿ç”¨
[root@server ~]# visudo
# ç»™ç®¡ç†å‘˜ç»„sudoæƒé™
%admin ALL=(ALL:ALL) ALL

# 3. ä¿ç•™suä½œä¸ºåº”æ€¥æ‰‹æ®µ
# é™åˆ¶wheelç»„ä½¿ç”¨su
```

**ğŸ”¸ ä¸ªäººå­¦ä¹ ç¯å¢ƒ**ï¼š
```bash
# å¯ä»¥åŒæ—¶ä½¿ç”¨suå’Œsudo
# suç”¨äºå­¦ä¹ ç³»ç»Ÿç®¡ç†
# sudoç”¨äºæ—¥å¸¸æ“ä½œ
```

**ğŸ”¸ å®‰å…¨é…ç½®ç»„åˆ**ï¼š
```bash
# 1. å¯ç”¨wheelç»„é™åˆ¶su
auth required pam_wheel.so use_uid

# 2. é…ç½®sudoè¯¦ç»†è®°å½•
Defaults logfile=/var/log/sudo.log
Defaults log_input,log_output

# 3. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
Defaults timestamp_timeout=5
```

---

## 9. ğŸ”§ suå®‰å…¨é…ç½®å®è·µ


### 9.1 åŸºç¡€å®‰å…¨é…ç½®


**é…ç½®æ–‡ä»¶ä½ç½®**ï¼š
```bash
/etc/pam.d/su          # suçš„PAMé…ç½®
/etc/login.defs        # ç™»å½•ç›¸å…³é»˜è®¤é…ç½®
/etc/security/         # å®‰å…¨æ¨¡å—é…ç½®ç›®å½•
/etc/sudoers          # sudoé…ç½®ï¼ˆå¯¹æ¯”å‚è€ƒï¼‰
```

**åŸºæœ¬å®‰å…¨è®¾ç½®**ï¼š
```bash
# 1. å¯ç”¨wheelç»„é™åˆ¶
[root@server ~]# vim /etc/pam.d/su
auth            required        pam_wheel.so use_uid

# 2. é…ç½®ç™»å½•å¤±è´¥é”å®š
auth            required        pam_tally2.so deny=3 unlock_time=600

# 3. å¯ç”¨è¯¦ç»†æ—¥å¿—
session         required        pam_unix.so
```

### 9.2 ç¯å¢ƒå˜é‡å®‰å…¨


**æ¸…ç†å±é™©ç¯å¢ƒå˜é‡**ï¼š
```bash
[root@server ~]# vim /etc/pam.d/su

# æ·»åŠ ç¯å¢ƒæ¸…ç†
session    required   pam_env.so readenv=1 envfile=/etc/security/pam_env.conf
```

**é…ç½®ç¯å¢ƒå˜é‡æ¸…ç†**ï¼š
```bash
[root@server ~]# vim /etc/security/pam_env.conf

# æ¸…ç†æ½œåœ¨å±é™©çš„ç¯å¢ƒå˜é‡
LD_LIBRARY_PATH DEFAULT=""
LD_PRELOAD      DEFAULT=""
PYTHONPATH      DEFAULT=""
```

### 9.3 å®¡è®¡å’Œç›‘æ§


**é…ç½®è¯¦ç»†æ—¥å¿—è®°å½•**ï¼š
```bash
# rsyslogé…ç½®
[root@server ~]# vim /etc/rsyslog.conf

# suç›¸å…³æ—¥å¿—å•ç‹¬è®°å½•
authpriv.*                              /var/log/secure
local0.*                               /var/log/su-audit.log
```

**åˆ›å»ºsuç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# /usr/local/bin/su-monitor.sh

LOGFILE="/var/log/secure"
ALERT_EMAIL="admin@company.com"

# æ£€æŸ¥æœ€è¿‘5åˆ†é’Ÿçš„suå¤±è´¥
FAILED_COUNT=$(grep "FAILED SU" $LOGFILE | grep "$(date -d '5 minutes ago' '+%b %d %H:%M'):" | wc -l)

if [ $FAILED_COUNT -gt 3 ]; then
    echo "è­¦å‘Šï¼šæ£€æµ‹åˆ°å¼‚å¸¸suå¤±è´¥å°è¯•" | mail -s "Su Security Alert" $ALERT_EMAIL
fi
```

### 9.4 ç½‘ç»œå®‰å…¨å¢å¼º


**é™åˆ¶suä½¿ç”¨æ¥æº**ï¼š
```bash
# é…ç½®è®¿é—®æ§åˆ¶
[root@server ~]# vim /etc/security/access.conf

# åªå…è®¸æœ¬åœ°å’Œç®¡ç†ç½‘ç»œä½¿ç”¨su
+ : wheel : 127.0.0.1
+ : wheel : 192.168.1.0/24
+ : wheel : 10.0.0.0/8
- : ALL : ALL
```

**SSHé…ç½®é…åˆ**ï¼š
```bash
[root@server ~]# vim /etc/ssh/sshd_config

# ç¦ç”¨root SSHç™»å½•
PermitRootLogin no

# é™åˆ¶SSHç”¨æˆ·
AllowUsers john alice admin

# å¯ç”¨å…¬é’¥è®¤è¯
PubkeyAuthentication yes
PasswordAuthentication no
```

### 9.5 åº”æ€¥æ¢å¤å‡†å¤‡


**åˆ›å»ºåº”æ€¥ç”¨æˆ·**ï¼š
```bash
# åˆ›å»ºåº”æ€¥ç®¡ç†å‘˜è´¦æˆ·
[root@server ~]# useradd -m -G wheel emergency
[root@server ~]# passwd emergency

# é…ç½®åº”æ€¥è®¿é—®
[root@server ~]# vim /etc/security/access.conf
+ : emergency : ALL
```

**å¤‡ä»½å…³é”®é…ç½®**ï¼š
```bash
#!/bin/bash
# é…ç½®å¤‡ä»½è„šæœ¬
BACKUP_DIR="/root/security-backup"
DATE=$(date +%Y%m%d)

mkdir -p $BACKUP_DIR

# å¤‡ä»½å…³é”®å®‰å…¨é…ç½®
cp /etc/pam.d/su $BACKUP_DIR/su-$DATE
cp /etc/security/access.conf $BACKUP_DIR/access-$DATE
cp /etc/ssh/sshd_config $BACKUP_DIR/sshd-$DATE

echo "å®‰å…¨é…ç½®å·²å¤‡ä»½åˆ° $BACKUP_DIR"
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ suå‘½ä»¤æœ¬è´¨ï¼šåœ¨å½“å‰ç»ˆç«¯åˆ‡æ¢ç”¨æˆ·èº«ä»½ï¼Œè·å¾—ç›®æ ‡ç”¨æˆ·æƒé™
ğŸ”¸ åŸºæœ¬ç”¨æ³•ï¼šsuï¼ˆåˆ‡æ¢åˆ°rootï¼‰ï¼Œsu -ï¼ˆå®Œæ•´ç¯å¢ƒåˆ‡æ¢ï¼‰
ğŸ”¸ æŒ‡å®šç”¨æˆ·ï¼šsu username æˆ– su - username
ğŸ”¸ ç¯å¢ƒåŒºåˆ«ï¼šæ™®é€šsuä¿ç•™å½“å‰ç¯å¢ƒï¼Œsu -è·å¾—å®Œæ•´ç›®æ ‡ç¯å¢ƒ
ğŸ”¸ å¯†ç è¦æ±‚ï¼šéœ€è¦ç›®æ ‡ç”¨æˆ·å¯†ç ï¼ˆrootåˆ‡æ¢é™¤å¤–ï¼‰
ğŸ”¸ æ—¥å¿—è®°å½•ï¼šæ“ä½œè®°å½•åœ¨/var/log/secureç­‰æ—¥å¿—æ–‡ä»¶ä¸­
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ su - ä¸ su çš„åŒºåˆ«**
```
è®°å¿†è¦ç‚¹ï¼š
- suï¼šå¿«é€Ÿæƒé™æå‡ï¼Œä¿æŒå½“å‰å·¥ä½œç¯å¢ƒ
- su -ï¼šå®Œæ•´èº«ä»½åˆ‡æ¢ï¼Œè·å¾—ç›®æ ‡ç”¨æˆ·å®Œæ•´ç¯å¢ƒ
- ç³»ç»Ÿç®¡ç†ç”¨su -ï¼Œä¸´æ—¶æ“ä½œç”¨su
```

**ğŸ”¹ å®‰å…¨æ§åˆ¶æœºåˆ¶**
```
æ ¸å¿ƒæ€è·¯ï¼š
- wheelç»„ï¼šæ§åˆ¶è°èƒ½ä½¿ç”¨su
- PAMæ¨¡å—ï¼šæä¾›å„ç§å®‰å…¨é™åˆ¶
- æ—¥å¿—è®°å½•ï¼šç›‘æ§å’Œå®¡è®¡suä½¿ç”¨
- ç¯å¢ƒæ¸…ç†ï¼šé˜²æ­¢ç¯å¢ƒå˜é‡æ”»å‡»
```

**ğŸ”¹ su vs sudo é€‰æ‹©**
```
ç®€å•åˆ¤æ–­ï¼š
- éœ€è¦é•¿æ—¶é—´rootæƒé™ â†’ ä½¿ç”¨su
- æ‰§è¡Œå•ä¸ªç®¡ç†å‘½ä»¤ â†’ ä½¿ç”¨sudo  
- å­¦ä¹ ç³»ç»Ÿç®¡ç† â†’ suå’Œsudoéƒ½è¦ä¼š
- ç”Ÿäº§ç¯å¢ƒ â†’ ä¼˜å…ˆä½¿ç”¨sudo
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š æ—¥å¸¸ä½¿ç”¨å»ºè®®**ï¼š

| ä½¿ç”¨åœºæ™¯ | **æ¨èå‘½ä»¤** | **ç†ç”±** |
|----------|-------------|----------|
| `ç³»ç»Ÿç»´æŠ¤` | `su -` | `éœ€è¦å®Œæ•´rootç¯å¢ƒ` |
| `å½“å‰ç›®å½•æ“ä½œ` | `su` | `ä¿æŒå·¥ä½œç›®å½•ä¸å˜` |
| `æœåŠ¡è°ƒè¯•` | `su - service_user` | `å®Œæ•´æœåŠ¡ç”¨æˆ·ç¯å¢ƒ` |
| `å¿«é€Ÿæƒé™æ£€æŸ¥` | `su` | `ä¸´æ—¶ææƒå³å¯` |

**ğŸ”’ å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•**ï¼š
- [ ] å¯ç”¨wheelç»„é™åˆ¶
- [ ] é…ç½®ç™»å½•å¤±è´¥é”å®š  
- [ ] è®¾ç½®æ—¶é—´å’Œç½‘ç»œé™åˆ¶
- [ ] å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•
- [ ] å®šæœŸå®¡è®¡suä½¿ç”¨æƒ…å†µ
- [ ] å¤‡ä»½å®‰å…¨é…ç½®æ–‡ä»¶

### 10.4 æ•…éšœæ’æŸ¥è¦ç‚¹


**å¸¸è§é—®é¢˜è§£å†³**ï¼š
```bash
# 1. suæç¤ºPermission denied
â†’ æ£€æŸ¥wheelç»„é…ç½®å’Œç”¨æˆ·ç»„æˆå‘˜

# 2. suåç¯å¢ƒå˜é‡ä¸æ­£ç¡®
â†’ ä½¿ç”¨su -ä»£æ›¿suè·å¾—å®Œæ•´ç¯å¢ƒ

# 3. suæ— æ³•åˆ‡æ¢åˆ°æœåŠ¡è´¦æˆ·
â†’ æ£€æŸ¥ç›®æ ‡ç”¨æˆ·shellè®¾ç½®ï¼Œä½¿ç”¨-så‚æ•°

# 4. suæ—¥å¿—ä¸è®°å½•
â†’ æ£€æŸ¥rsyslogé…ç½®å’ŒPAMæ¨¡å—è®¾ç½®
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
suåˆ‡æ¢èº«ä»½è¦å¯†ç ï¼Œæ™®é€šåˆ‡æ¢å’Œå®Œæ•´åˆ†
wheelç»„æ§åˆ¶è°èƒ½ç”¨ï¼Œæ—¥å¿—è®°å½•è¦ç›‘æ§
å®‰å…¨é…ç½®å¤šå±‚æ¬¡ï¼Œåº”æ€¥é¢„æ¡ˆåˆ«å¿˜è®°
ç”Ÿäº§ç¯å¢ƒsudoå¥½ï¼Œå­¦ä¹ é˜¶æ®µéƒ½è¦ä¼š
```