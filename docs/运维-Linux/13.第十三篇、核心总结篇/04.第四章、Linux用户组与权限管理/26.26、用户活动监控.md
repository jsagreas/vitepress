---
title: 26、用户活动监控
---
## 📚 目录

1. [用户活动监控概述](#1-用户活动监控概述)
2. [用户登录记录查看](#2-用户登录记录查看)
3. [last与lastlog命令详解](#3-last与lastlog命令详解)
4. [用户活动日志分析](#4-用户活动日志分析)
5. [异常登录检测方法](#5-异常登录检测方法)
6. [用户会话监控技术](#6-用户会话监控技术)
7. [用户操作轨迹追踪](#7-用户操作轨迹追踪)
8. [用户行为分析策略](#8-用户行为分析策略)
9. [用户安全告警配置](#9-用户安全告警配置)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔍 用户活动监控概述


### 1.1 什么是用户活动监控


**用户活动监控**就是系统管理员通过各种工具和方法，实时或定期查看用户在Linux系统上的行为记录。简单来说，就是**"看看用户都在系统上做了什么"**。

**为什么需要监控用户活动？**
```
安全角度：
• 防止恶意用户入侵系统
• 发现异常登录行为
• 追踪安全事件的来源

管理角度：
• 了解系统资源使用情况
• 分析用户工作模式
• 优化系统性能

合规角度：
• 满足审计要求
• 提供法律证据
• 符合企业安全标准
```

### 1.2 监控的核心内容


```
用户登录信息：
┌─────────────────────────────────────┐
│ 谁登录了？ → 用户名                   │
│ 什么时候？ → 登录时间                 │  
│ 从哪里？  → IP地址/终端               │
│ 用什么？  → SSH/控制台/图形界面        │
│ 做了什么？ → 执行的命令               │
│ 何时离开？ → 退出时间                 │
└─────────────────────────────────────┘
```

**监控等级分类**：
- 🟢**基础监控**：登录/退出记录
- 🟡**中级监控**：命令历史追踪  
- 🔴**高级监控**：实时行为分析

---

## 2. 👥 用户登录记录查看


### 2.1 Linux登录记录存储位置


Linux系统把用户的登录信息存储在特定的文件中，就像是一本"访客记录簿"：

```
核心日志文件：
/var/log/wtmp     → 用户登录/退出的详细记录
/var/log/btmp     → 失败登录尝试记录  
/var/log/lastlog  → 每个用户最后一次登录信息
/var/log/utmp     → 当前登录用户信息
```

**文件特点说明**：
- 📁 **wtmp**：记录所有成功的登录和退出
- ⚠️ **btmp**：记录所有失败的登录尝试（重要！）
- 📅 **lastlog**：只保存最新的登录信息
- ⏱️ **utmp**：显示当前在线用户

### 2.2 基本登录信息查看


**查看当前在线用户**：
```bash
# 最简单的方法 - 显示当前登录用户
who

# 显示更详细信息
w

# 查看系统运行时间和负载
uptime
```

**命令对比**：
| 命令 | **显示内容** | **详细程度** | **使用场景** |
|------|-------------|-------------|-------------|
| `who` | `当前用户、终端、登录时间` | `简单` | `快速查看在线用户` |
| `w` | `用户活动、负载、进程信息` | `详细` | `了解用户在做什么` |
| `uptime` | `系统运行时间、用户数、负载` | `概要` | `系统整体状态` |

### 2.3 登录记录文件解读


**wtmp文件内容解读**：
```
wtmp文件记录格式：
用户名 | 终端类型 | 登录IP | 登录时间 | 退出时间

实际例子：
root    pts/0    192.168.1.100   Mon Sep 18 09:15   still logged in
john    tty1     console         Mon Sep 18 08:30   Mon Sep 18 17:45
```

**重要概念解释**：
- **pts/0**：伪终端（通常是SSH连接）
- **tty1**：物理终端（直接在机器前操作）
- **console**：控制台登录
- **still logged in**：用户还在线

---

## 3. 📖 last与lastlog命令详解


### 3.1 last命令 - 登录历史查看神器


**last命令**是查看用户登录历史最常用的工具，它读取`/var/log/wtmp`文件并以易读的格式显示。

**基础用法**：
```bash
# 显示所有用户的登录记录
last

# 显示特定用户的登录记录
last username

# 显示最近N条记录
last -n 10

# 显示特定日期的记录
last -s yesterday
```

**实用参数组合**：
```bash
# 显示登录但隐藏退出时间（更简洁）
last -R

# 显示完整的主机名
last -a

# 按时间范围查询
last -s "2024-09-01" -t "2024-09-19"

# 查看特定终端的登录
last -t pts/0
```

### 3.2 lastlog命令 - 用户最后登录信息


**lastlog命令**显示每个用户最后一次登录的信息，读取`/var/log/lastlog`文件。

```bash
# 查看所有用户最后登录时间
lastlog

# 查看特定用户
lastlog -u username

# 查看7天内登录的用户
lastlog -t 7

# 查看从未登录的用户
lastlog | grep "Never"
```

**输出结果解读**：
```
Username    Port     From             Latest
root        pts/0    192.168.1.100    Thu Sep 19 09:15:22 +0800 2024
john        tty1                      Wed Sep 18 08:30:15 +0800 2024
guest                                **Never logged in**
```

### 3.3 失败登录记录 - lastb命令


**lastb命令**专门查看失败的登录尝试，这对安全监控非常重要：

```bash
# 查看所有失败登录（需要root权限）
sudo lastb

# 查看特定用户的失败登录
sudo lastb username

# 查看最近的失败尝试
sudo lastb -n 20
```

**安全意义**：
- 🔒 **密码猜测攻击**：大量失败尝试
- 🌐 **暴力破解**：来自外部IP的频繁尝试
- ⚠️ **账户异常**：正常用户的异常失败登录

---

## 4. 📊 用户活动日志分析


### 4.1 系统日志文件详解


除了登录记录，Linux还有多个重要的日志文件记录用户活动：

```
主要日志文件：
/var/log/auth.log      → 认证相关日志（Ubuntu/Debian）
/var/log/secure        → 安全相关日志（CentOS/RHEL）  
/var/log/messages      → 系统消息日志
/var/log/syslog        → 系统综合日志
~/.bash_history        → 用户命令历史记录
```

**日志文件作用说明**：
- **auth.log/secure**：记录登录、sudo使用、密码更改等
- **messages/syslog**：记录系统级别的重要事件
- **bash_history**：记录用户执行过的所有命令

### 4.2 命令历史分析


**查看用户命令历史**：
```bash
# 查看当前用户的命令历史
history

# 查看其他用户的命令历史（需要权限）
cat /home/username/.bash_history

# 查看历史命令的时间戳
HISTTIMEFORMAT="%Y-%m-%d %H:%M:%S " history
```

**历史记录配置**：
```bash
# 设置历史记录数量
export HISTSIZE=2000
export HISTFILESIZE=5000

# 忽略重复命令
export HISTCONTROL=ignoredups

# 实时保存历史记录
shopt -s histappend
```

### 4.3 日志分析实用技巧


**使用grep分析日志**：
```bash
# 查找特定用户的所有活动
grep "username" /var/log/auth.log

# 查找SSH登录记录
grep "sshd" /var/log/auth.log

# 查找sudo使用记录
grep "sudo" /var/log/auth.log

# 查找密码更改记录
grep "password" /var/log/auth.log
```

**时间范围分析**：
```bash
# 查看今天的登录记录
grep "$(date '+%b %d')" /var/log/auth.log

# 查看最近一小时的活动
find /var/log -name "*.log" -newermt "1 hour ago" -exec grep "Failed\|Accepted" {} \;
```

---

## 5. 🚨 异常登录检测方法


### 5.1 识别异常登录模式


**什么是异常登录？**
异常登录就是不符合正常使用模式的登录行为，可能表示安全威胁：

```
异常登录特征：
┌─────────────────────────────────────┐
│ 时间异常 → 深夜或非工作时间登录        │
│ 地点异常 → 来自不常见的IP地址         │
│ 频率异常 → 短时间内大量登录尝试        │
│ 行为异常 → 登录后立即执行危险命令      │
│ 用户异常 → 已禁用账户的登录尝试        │
└─────────────────────────────────────┘
```

### 5.2 异常检测方法


**🔍 基于时间的检测**：
```bash
# 查找非工作时间的登录（假设工作时间是8-18点）
last | awk '$4 !~ /0[8-9]|1[0-8]/ {print}'

# 查找周末的登录记录
last | grep -E "(Sat|Sun)"

# 查找深夜登录（22点后到6点前）
last | awk '$4 ~ /(2[2-3]|0[0-6]):/' 
```

**🌐 基于IP地址的检测**：
```bash
# 统计登录IP地址出现频率
last | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+' | sort | uniq -c | sort -nr

# 查找来自外网的登录
last | grep -v "192.168\|10\.\|172\."

# 查找单次登录的IP（可能是扫描）
last | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+' | sort | uniq -c | awk '$1==1 {print $2}'
```

### 5.3 自动化异常检测脚本


**简单的异常检测脚本**：
```bash
#!/bin/bash
# 异常登录检测脚本

echo "=== 异常登录检测报告 ==="
echo "检测时间: $(date)"
echo

# 1. 检查失败登录次数
echo "🚨 最近失败登录统计："
sudo lastb | head -20 | awk '{print $3}' | sort | uniq -c | sort -nr | head -10

# 2. 检查深夜登录
echo -e "\n🌙 深夜登录记录："
last -n 50 | awk '$4 ~ /(2[2-3]|0[0-6]):/ {print $1, $3, $4, $5}'

# 3. 检查新IP登录
echo -e "\n🌐 外网IP登录："
last -n 100 | grep -v "192.168\|10\.\|172\.\|localhost" | head -10

echo -e "\n=== 检测完成 ==="
```

**使用方法**：
```bash
# 保存为check_login.sh
chmod +x check_login.sh
./check_login.sh
```

---

## 6. 👀 用户会话监控技术


### 6.1 实时会话监控


**实时监控用户活动**就是能够看到用户当前正在系统上做什么，就像"实时直播"用户的操作。

**w命令详解**：
```bash
# 显示当前所有用户活动
w

# 显示特定用户活动
w username

# 简化显示格式
w -s
```

**输出信息解读**：
```
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
root     pts/0    192.168.1.100    09:15    0.00s  0.45s  0.01s vim config.txt
john     pts/1    192.168.1.101    10:30    5:20   0.12s  0.05s -bash

含义说明：
TTY    → 用户使用的终端
FROM   → 登录来源IP
LOGIN@ → 登录时间  
IDLE   → 空闲时间
JCPU   → 该终端所有进程占用的CPU时间
PCPU   → 当前进程占用的CPU时间
WHAT   → 当前正在执行的命令
```

### 6.2 进程监控


**查看用户进程**：
```bash
# 查看特定用户的所有进程
ps -u username

# 查看进程树形结构
pstree -u username

# 实时监控进程
top -u username
```

**进程分析要点**：
- 🔍 **异常进程**：不应该运行的程序
- ⚡ **资源消耗**：CPU/内存使用异常
- 🕒 **运行时间**：长时间运行的可疑进程

### 6.3 网络连接监控


**监控用户网络活动**：
```bash
# 查看网络连接
netstat -tnp | grep username

# 查看监听端口
ss -tlnp | grep username

# 查看网络统计
netstat -s
```

**网络监控关注点**：
```
可疑网络行为：
• 连接到不明外部服务器
• 监听异常端口
• 大量网络连接
• 异常数据传输量
```

---

## 7. 🔎 用户操作轨迹追踪


### 7.1 详细命令审计


**启用详细的命令审计**，可以记录用户执行的每一个命令，包括参数和结果。

**配置命令审计**：
```bash
# 在.bashrc中添加以下内容，记录详细命令历史
export HISTTIMEFORMAT="%Y-%m-%d %H:%M:%S "
export HISTSIZE=10000
export HISTFILESIZE=20000

# 记录命令到syslog
export PROMPT_COMMAND='history 1 | logger -p local6.info -t "$USER[$$]"'
```

**查看详细命令记录**：
```bash
# 查看带时间戳的历史命令
history | tail -20

# 从syslog查看命令记录
grep "$USER" /var/log/syslog | tail -20
```

### 7.2 文件访问追踪


**监控文件操作**：
```bash
# 查看最近修改的文件
find /home/username -type f -mtime -1 -ls

# 查看用户访问的文件
lsof -u username

# 监控特定目录的文件变化
inotifywait -m -r /important/directory/
```

**文件操作分析**：
```
关注的文件操作：
✅ 配置文件修改 → 可能的权限提升
✅ 日志文件删除 → 可能的痕迹清理  
✅ 系统文件访问 → 可能的恶意行为
✅ 敏感数据访问 → 可能的数据泄露
```

### 7.3 系统调用追踪


**使用strace追踪系统调用**：
```bash
# 追踪特定进程的系统调用
strace -p PID

# 追踪用户启动的新进程
strace -f -o trace.log command

# 只追踪文件操作相关的系统调用
strace -e trace=file command
```

**追踪结果分析**：
- 📁 **文件操作**：open, read, write, unlink
- 🌐 **网络操作**：socket, connect, send, recv  
- 🔧 **进程操作**：fork, exec, kill
- 🔐 **权限操作**：setuid, setgid, chmod

---

## 8. 📈 用户行为分析策略


### 8.1 建立用户行为基线


**什么是行为基线？**
就是记录和分析用户的正常使用模式，比如：
- 通常什么时间登录
- 经常从哪些IP地址访问
- 常用的命令和工具
- 典型的工作流程

**建立基线的方法**：
```bash
# 分析用户登录时间模式
last username | awk '{print $4}' | sort | uniq -c

# 分析用户常用命令
history | awk '{print $4}' | sort | uniq -c | sort -nr | head -20

# 分析登录来源IP
last username | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+' | sort | uniq -c
```

### 8.2 异常行为识别模式


**典型异常行为模式**：

```
🔴 高危行为模式：
┌─────────────────────────────────────┐
│ 权限提升    → sudo su, chmod +s     │
│ 系统修改    → 修改重要配置文件        │
│ 数据窃取    → scp, rsync大量文件     │
│ 后门植入    → 创建新用户、修改SSH配置  │
│ 痕迹清理    → 删除日志文件           │
└─────────────────────────────────────┘

🟡 可疑行为模式：
┌─────────────────────────────────────┐
│ 时间异常    → 非工作时间大量活动      │
│ 命令异常    → 使用不常见的系统工具    │
│ 网络异常    → 连接外部可疑服务器      │
│ 文件异常    → 访问不相关的敏感文件    │
└─────────────────────────────────────┘
```

### 8.3 用户风险等级评估


**用户风险评估模型**：

| 风险等级 | **行为特征** | **监控频率** | **处理策略** |
|---------|-------------|-------------|-------------|
| 🟢**低风险** | `正常工作模式，无异常行为` | `日常监控` | `常规记录` |
| 🟡**中风险** | `偶有异常，但在合理范围` | `重点关注` | `增强监控` |
| 🔴**高风险** | `频繁异常，疑似恶意行为` | `实时监控` | `立即处理` |

**风险评估脚本示例**：
```bash
#!/bin/bash
# 用户风险评估脚本

username=$1
risk_score=0

# 检查失败登录次数
failed_logins=$(sudo lastb $username | wc -l)
if [ $failed_logins -gt 10 ]; then
    risk_score=$((risk_score + 20))
    echo "⚠️ 失败登录次数过多: $failed_logins"
fi

# 检查深夜登录
night_logins=$(last $username | awk '$4 ~ /(2[2-3]|0[0-6]):/' | wc -l)
if [ $night_logins -gt 5 ]; then
    risk_score=$((risk_score + 15))
    echo "🌙 深夜登录频繁: $night_logins 次"
fi

# 评估风险等级
if [ $risk_score -ge 30 ]; then
    echo "🔴 高风险用户"
elif [ $risk_score -ge 15 ]; then
    echo "🟡 中风险用户"
else
    echo "🟢 低风险用户"
fi

echo "风险评分: $risk_score/100"
```

---

## 9. ⚠️ 用户安全告警配置


### 9.1 实时告警系统设计


**告警系统的目标**是在发现异常行为时立即通知管理员，就像"系统的保安"一样。

**告警触发条件**：
```
立即告警情况：
🚨 连续登录失败超过5次
🚨 root账户异地登录
🚨 深夜时段的敏感操作
🚨 系统文件被修改
🚨 新用户账户被创建
🚨 sudo权限被滥用
```

### 9.2 基于日志的告警配置


**使用logwatch进行日志监控**：
```bash
# 安装logwatch
sudo apt install logwatch    # Ubuntu/Debian
sudo yum install logwatch    # CentOS/RHEL

# 配置logwatch
sudo vim /etc/logwatch/conf/logwatch.conf

# 关键配置项：
Detail = High              # 详细级别
Range = Today             # 监控范围
Service = sshd            # 监控SSH服务
Service = sudo            # 监控sudo使用
```

**自定义告警脚本**：
```bash
#!/bin/bash
# 实时告警脚本 - monitor_alerts.sh

LOGFILE="/var/log/auth.log"
ALERT_EMAIL="admin@company.com"

# 监控SSH登录失败
tail -f $LOGFILE | while read line; do
    if echo "$line" | grep -q "Failed password"; then
        # 提取IP地址和用户名
        ip=$(echo "$line" | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+')
        user=$(echo "$line" | awk '{print $9}')
        
        # 检查5分钟内的失败次数
        failures=$(grep "$ip" $LOGFILE | grep "Failed password" | \
                   grep "$(date '+%b %d %H:%M' -d '5 minutes ago')" | wc -l)
        
        if [ $failures -gt 5 ]; then
            echo "🚨 告警: IP $ip 对用户 $user 连续登录失败 $failures 次" | \
            mail -s "SSH暴力破解告警" $ALERT_EMAIL
        fi
    fi
done
```

### 9.3 告警通知方式


**多种通知渠道配置**：

```bash
# 1. 邮件通知
echo "告警信息" | mail -s "安全告警" admin@company.com

# 2. 短信通知（需要配置短信网关）
curl -X POST "https://sms-api.com/send" \
     -d "phone=13800138000&message=系统安全告警"

# 3. 企业微信/钉钉通知
curl -X POST "https://qyapi.weixin.qq.com/cgi-bin/webhook/send" \
     -H "Content-Type: application/json" \
     -d '{"msgtype":"text","text":{"content":"安全告警信息"}}'

# 4. Slack通知  
curl -X POST -H 'Content-type: application/json' \
     --data '{"text":"安全告警信息"}' \
     YOUR_SLACK_WEBHOOK_URL
```

**告警级别分类**：
```
📢 信息级别：
• 正常登录记录
• 定期系统维护
• 常规配置更改

⚠️ 警告级别：  
• 异常时间登录
• 多次登录失败
• 权限使用异常

🚨 紧急级别：
• 可疑的恶意行为
• 系统安全威胁
• 数据泄露风险
```

### 9.4 告警响应流程


**标准响应流程**：
```
告警处理流程：
┌─────────────────┐
│  1. 接收告警     │
│     ↓          │
│  2. 初步分析     │  
│     ↓          │
│  3. 风险评估     │
│     ↓          │
│  4. 采取措施     │
│     ↓          │
│  5. 跟踪处理     │
│     ↓          │
│  6. 总结反馈     │
└─────────────────┘
```

**应急处理措施**：
```bash
# 紧急情况下的用户处理

# 1. 立即锁定可疑用户
sudo usermod -L suspicious_user

# 2. 强制断开用户会话
sudo pkill -u suspicious_user

# 3. 备份用户数据进行分析
sudo tar -czf /backup/user_$(date +%Y%m%d).tar.gz /home/suspicious_user/

# 4. 查看用户最近活动
last suspicious_user | head -20
history -r /home/suspicious_user/.bash_history

# 5. 检查用户创建的文件
find /home/suspicious_user -type f -mtime -7 -ls
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 用户活动监控：通过工具和日志追踪用户系统行为
🔸 登录记录查看：使用last/lastlog/lastb命令查看登录历史
🔸 日志文件分析：理解wtmp/btmp/lastlog等关键日志文件
🔸 异常行为识别：基于时间、地点、频率等维度发现异常
🔸 实时监控技术：使用w/ps/netstat等工具监控当前活动
🔸 安全告警配置：建立自动化的异常检测和通知系统
```

### 10.2 重要命令速查表


| 命令类别 | **命令** | **作用** | **关键参数** |
|---------|---------|---------|-------------|
| **登录查看** | `last` | `查看登录历史` | `-n 数量`, `-u 用户` |
| **最后登录** | `lastlog` | `最后登录时间` | `-u 用户`, `-t 天数` |
| **失败登录** | `lastb` | `失败登录记录` | `需要root权限` |
| **当前用户** | `w` | `当前活动用户` | `-s 简化显示` |
| **在线用户** | `who` | `当前登录用户` | `简单快速` |

### 10.3 关键理解要点


**🔹 监控的层次性**
```
监控层次从低到高：
基础层 → 登录/退出记录
应用层 → 命令执行历史  
行为层 → 用户操作模式
威胁层 → 异常行为分析
```

**🔹 日志文件的重要性**
```
日志文件特点：
wtmp  → 详细完整，历史记录
btmp  → 安全关键，失败尝试
lastlog → 简洁明了，最新状态
auth.log → 综合全面，认证相关
```

**🔹 异常检测的思路**
```
检测维度：
时间维度 → 非正常时间的活动
空间维度 → 异常来源IP的访问
行为维度 → 不符合常规的操作
频率维度 → 异常频繁的尝试
```

### 10.4 实际应用价值


**💼 系统管理员**：
- 监控服务器安全状态
- 追踪用户操作历史
- 快速定位安全问题
- 建立安全审计体系

**🔒 安全运维人员**：
- 实时发现安全威胁
- 分析攻击行为模式
- 建立威胁情报体系
- 优化安全防护策略

**📊 合规审计人员**：
- 提供完整的操作记录
- 满足法规审计要求
- 生成合规性报告
- 支持法律证据收集

### 10.5 最佳实践建议


**✅ 监控策略**：
```
日常监控：
• 定期检查登录记录
• 关注失败登录趋势
• 监控特权用户活动
• 备份重要日志文件

实时监控：
• 配置自动化告警
• 建立异常检测规则
• 设置多级告警通知
• 制定应急响应流程
```

**⚠️ 注意事项**：
```
隐私保护：
• 遵守公司隐私政策
• 合理使用监控权限
• 保护敏感信息安全
• 建立监控审批流程

技术限制：
• 日志文件大小管理
• 系统性能影响考虑
• 存储空间合理规划
• 监控工具资源消耗
```

**核心记忆口诀**：
- 用户活动要监控，last命令是基础
- 登录记录看wtmp，失败尝试查btmp  
- 异常行为多维度，时间地点频率行为
- 实时告警保安全，日志分析找威胁