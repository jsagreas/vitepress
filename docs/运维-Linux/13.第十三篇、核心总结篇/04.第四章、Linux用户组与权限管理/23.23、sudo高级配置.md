---
title: 23ã€sudoé«˜çº§é…ç½®
---
## ğŸ“š ç›®å½•

1. [sudoé«˜çº§é…ç½®æ¦‚è¿°](#1-sudoé«˜çº§é…ç½®æ¦‚è¿°)
2. [sudoæ’ä»¶ç³»ç»Ÿé…ç½®](#2-sudoæ’ä»¶ç³»ç»Ÿé…ç½®)
3. [sudoä¼šè¯ç®¡ç†](#3-sudoä¼šè¯ç®¡ç†)
4. [sudoå‘½ä»¤æ—¥å¿—è¯¦ç»†è®°å½•](#4-sudoå‘½ä»¤æ—¥å¿—è¯¦ç»†è®°å½•)
5. [sudoæƒé™æ—¶é—´é™åˆ¶](#5-sudoæƒé™æ—¶é—´é™åˆ¶)
6. [sudoç¯å¢ƒå˜é‡è¿‡æ»¤](#6-sudoç¯å¢ƒå˜é‡è¿‡æ»¤)
7. [sudoå®‰å…¨é€‰é¡¹é…ç½®](#7-sudoå®‰å…¨é€‰é¡¹é…ç½®)
8. [sudoæ•…éšœæ’æŸ¥æŠ€å·§](#8-sudoæ•…éšœæ’æŸ¥æŠ€å·§)
9. [sudoæ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#9-sudoæ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ sudoé«˜çº§é…ç½®æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯sudoé«˜çº§é…ç½®


**åŸºæœ¬å®šä¹‰**ï¼šsudoé«˜çº§é…ç½®æ˜¯æŒ‡é€šè¿‡ä¿®æ”¹`/etc/sudoers`æ–‡ä»¶å’Œç›¸å…³é…ç½®ï¼Œå®ç°æ›´ç²¾ç»†åŒ–çš„æƒé™æ§åˆ¶å’Œç³»ç»Ÿå®‰å…¨ç®¡ç†ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦é«˜çº§é…ç½®**ï¼š
- **ç²¾ç»†æƒé™æ§åˆ¶**ï¼šä¸æ˜¯ç®€å•çš„å…¨éƒ¨æƒé™æˆ–æ— æƒé™
- **å®‰å…¨åŠ å›º**ï¼šé˜²æ­¢æƒé™æ»¥ç”¨å’Œå®‰å…¨é£é™©
- **å®¡è®¡è¿½è¸ª**ï¼šè®°å½•æ‰€æœ‰æ“ä½œä¾¿äºå®‰å…¨å®¡è®¡
- **ç¯å¢ƒéš”ç¦»**ï¼šæ§åˆ¶å‘½ä»¤æ‰§è¡Œçš„ç¯å¢ƒå˜é‡

```
åŸºç¡€sudoä½¿ç”¨ï¼š         é«˜çº§sudoé…ç½®ï¼š
ç”¨æˆ· â†’ sudo â†’ æ‰§è¡Œ     ç”¨æˆ· â†’ æ—¶é—´æ£€æŸ¥ â†’ ç¯å¢ƒè¿‡æ»¤ â†’ 
                         â†“
                      æ—¥å¿—è®°å½• â†’ æ’ä»¶éªŒè¯ â†’ æ‰§è¡Œ
```

### 1.2 sudoé…ç½®æ–‡ä»¶ç»“æ„


**ä¸»è¦é…ç½®æ–‡ä»¶**ï¼š
```
/etc/sudoers           â† ä¸»é…ç½®æ–‡ä»¶ï¼ˆä¸è¦ç›´æ¥ç¼–è¾‘ï¼‰
/etc/sudoers.d/        â† é…ç½®æ–‡ä»¶ç›®å½•ï¼ˆæ¨èä½¿ç”¨ï¼‰
/var/log/sudo/         â† sudoæ—¥å¿—ç›®å½•
/etc/sudo.conf         â† sudoæ’ä»¶é…ç½®æ–‡ä»¶
```

**é…ç½®ç¼–è¾‘æ–¹å¼**ï¼š
```bash
# å®‰å…¨ç¼–è¾‘sudoersæ–‡ä»¶
sudo visudo

# ç¼–è¾‘sudoers.dç›®å½•ä¸‹çš„æ–‡ä»¶
sudo visudo -f /etc/sudoers.d/myconfig
```

> âš ï¸ **é‡è¦æé†’**ï¼šæ°¸è¿œä¸è¦ç›´æ¥ç”¨æ–‡æœ¬ç¼–è¾‘å™¨ç¼–è¾‘sudoersæ–‡ä»¶ï¼Œå¿…é¡»ä½¿ç”¨`visudo`å‘½ä»¤ï¼Œå®ƒä¼šæ£€æŸ¥è¯­æ³•é”™è¯¯é˜²æ­¢é”æ­»ç³»ç»Ÿã€‚

---

## 2. ğŸ”Œ sudoæ’ä»¶ç³»ç»Ÿé…ç½®


### 2.1 sudoæ’ä»¶ç³»ç»ŸåŸç†


**ä»€ä¹ˆæ˜¯sudoæ’ä»¶**ï¼šsudoæ’ä»¶æ˜¯æ‰©å±•sudoåŠŸèƒ½çš„æ¨¡å—ï¼Œå¯ä»¥è‡ªå®šä¹‰è®¤è¯æ–¹å¼ã€å®¡è®¡ç­–ç•¥ç­‰ã€‚

**æ’ä»¶ç±»å‹**ï¼š
- **è®¤è¯æ’ä»¶**ï¼šæ§åˆ¶ç”¨æˆ·èº«ä»½éªŒè¯æ–¹å¼
- **ç­–ç•¥æ’ä»¶**ï¼šå†³å®šç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ‰§è¡Œå‘½ä»¤
- **å®¡è®¡æ’ä»¶**ï¼šè®°å½•å’Œç›‘æ§sudoæ“ä½œ
- **IOæ’ä»¶**ï¼šè®°å½•è¾“å…¥è¾“å‡ºå†…å®¹

```
sudoæ‰§è¡Œæµç¨‹ï¼š
ç”¨æˆ·è¾“å…¥å‘½ä»¤ â†’ è®¤è¯æ’ä»¶éªŒè¯ â†’ ç­–ç•¥æ’ä»¶æ£€æŸ¥æƒé™ â†’ 
            â†“
          æ‰§è¡Œå‘½ä»¤ â†’ IOæ’ä»¶è®°å½• â†’ å®¡è®¡æ’ä»¶æ—¥å¿—
```

### 2.2 å¸¸ç”¨æ’ä»¶é…ç½®


**sudoersç­–ç•¥æ’ä»¶**ï¼ˆé»˜è®¤æ’ä»¶ï¼‰ï¼š
```bash
# /etc/sudo.confé…ç½®ç¤ºä¾‹
Plugin sudoers_policy sudoers.so
Plugin sudoers_io sudoers.so
Plugin sudoers_audit sudoers.so
```

**JSONæ—¥å¿—æ’ä»¶é…ç½®**ï¼š
```bash
# å¯ç”¨JSONæ ¼å¼æ—¥å¿—
Plugin sudoers_audit sudo_logsrvd.so

# åœ¨sudoersä¸­é…ç½®
Defaults log_format=json
Defaults logfile=/var/log/sudo/sudo.log
```

### 2.3 è‡ªå®šä¹‰æ’ä»¶ç¤ºä¾‹


**Pythonè®¤è¯æ’ä»¶ç¤ºä¾‹**ï¼š
```python
#!/usr/bin/env python3
# è‡ªå®šä¹‰æ—¶é—´æ®µé™åˆ¶æ’ä»¶
import datetime
import sys

def check_time_policy():
    now = datetime.datetime.now()
    # åªå…è®¸å·¥ä½œæ—¶é—´ä½¿ç”¨sudoï¼ˆ9:00-18:00ï¼‰
    if 9 <= now.hour < 18:
        return True
    return False

if __name__ == "__main__":
    if check_time_policy():
        sys.exit(0)  # å…è®¸
    else:
        sys.exit(1)  # æ‹’ç»
```

---

## 3. ğŸ“… sudoä¼šè¯ç®¡ç†


### 3.1 sudoä¼šè¯æœºåˆ¶åŸç†


**ä»€ä¹ˆæ˜¯sudoä¼šè¯**ï¼šç”¨æˆ·é¦–æ¬¡è¾“å…¥å¯†ç åï¼Œåœ¨ä¸€æ®µæ—¶é—´å†…ä¸éœ€è¦é‡å¤è¾“å…¥å¯†ç ï¼Œè¿™ä¸ªæ—¶é—´çª—å£å°±æ˜¯ä¼šè¯ã€‚

**ä¼šè¯å·¥ä½œåŸç†**ï¼š
```
ç”¨æˆ·é¦–æ¬¡sudo â†’ è¾“å…¥å¯†ç  â†’ åˆ›å»ºä¼šè¯ç¥¨æ® â†’ 
                    â†“
              åœ¨æœ‰æ•ˆæœŸå†… â†’ ç›´æ¥æ‰§è¡Œsudoå‘½ä»¤
                    â†“  
              è¶…è¿‡æœ‰æ•ˆæœŸ â†’ éœ€è¦é‡æ–°è¾“å…¥å¯†ç 
```

### 3.2 ä¼šè¯æ—¶é—´é…ç½®


**åŸºæœ¬ä¼šè¯é…ç½®**ï¼š
```bash
# è®¾ç½®ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
Defaults timestamp_timeout=15

# ç¦ç”¨ä¼šè¯ï¼ˆæ¯æ¬¡éƒ½è¦è¾“å…¥å¯†ç ï¼‰
Defaults timestamp_timeout=0

# æ°¸ä¹…ä¼šè¯ï¼ˆä¸æ¨èï¼‰
Defaults timestamp_timeout=-1
```

**æŒ‰ç”¨æˆ·é…ç½®ä¼šè¯**ï¼š
```bash
# ç»™ç‰¹å®šç”¨æˆ·è®¾ç½®ä¸åŒçš„ä¼šè¯æ—¶é—´
Defaults:alice timestamp_timeout=30
Defaults:bob timestamp_timeout=5
```

### 3.3 ä¼šè¯å­˜å‚¨ä½ç½®


**ä¼šè¯ç¥¨æ®å­˜å‚¨**ï¼š
```bash
# ä¼šè¯æ–‡ä»¶ä½ç½®ï¼ˆæ¯ä¸ªç”¨æˆ·ä¸€ä¸ªç›®å½•ï¼‰
/var/lib/sudo/ts/ç”¨æˆ·å

# æŸ¥çœ‹å½“å‰ç”¨æˆ·ä¼šè¯çŠ¶æ€
sudo -n true && echo "ä¼šè¯æœ‰æ•ˆ" || echo "éœ€è¦å¯†ç "

# æ¸…é™¤å½“å‰ç”¨æˆ·ä¼šè¯
sudo -k
```

**ä¼šè¯å®‰å…¨é…ç½®**ï¼š
```bash
# é€€å‡ºç»ˆç«¯æ—¶æ¸…é™¤ä¼šè¯
Defaults tty_tickets

# æ¯ä¸ªç»ˆç«¯ç‹¬ç«‹ä¼šè¯
Defaults timestamp_type=tty
```

---

## 4. ğŸ“‹ sudoå‘½ä»¤æ—¥å¿—è¯¦ç»†è®°å½•


### 4.1 sudoæ—¥å¿—ç±»å‹


**æ—¥å¿—è®°å½•çš„å†…å®¹**ï¼š
- **è°**æ‰§è¡Œäº†sudoï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰
- **ä»€ä¹ˆæ—¶å€™**æ‰§è¡Œçš„ï¼ˆæ—¶é—´æˆ³ï¼‰
- **åœ¨å“ªé‡Œ**æ‰§è¡Œçš„ï¼ˆç»ˆç«¯ã€IPåœ°å€ï¼‰
- **æ‰§è¡Œäº†ä»€ä¹ˆ**å‘½ä»¤ï¼ˆå®Œæ•´å‘½ä»¤è¡Œï¼‰
- **ç»“æœå¦‚ä½•**ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰

### 4.2 åŸºç¡€æ—¥å¿—é…ç½®


**å¯ç”¨åŸºæœ¬æ—¥å¿—è®°å½•**ï¼š
```bash
# è®°å½•æ‰€æœ‰sudoå‘½ä»¤
Defaults log_host, log_year, logfile=/var/log/sudo/sudo.log

# è®°å½•å‘½ä»¤çš„è¾“å…¥è¾“å‡º
Defaults log_input, log_output
Defaults iolog_dir=/var/log/sudo/io
```

**æ—¥å¿—æ ¼å¼é…ç½®**ï¼š
```bash
# è¯¦ç»†çš„æ—¥å¿—æ ¼å¼
Defaults log_format="%h %e %p %u %t %c"
# %h: ä¸»æœºå
# %e: æœ‰æ•ˆç”¨æˆ·ID  
# %p: è¿›ç¨‹ID
# %u: ç”¨æˆ·å
# %t: æ—¶é—´æˆ³
# %c: æ‰§è¡Œçš„å‘½ä»¤
```

### 4.3 é«˜çº§æ—¥å¿—è®°å½•


**IOæ—¥å¿—è®°å½•**ï¼š
```bash
# è®°å½•å‘½ä»¤çš„å®Œæ•´è¾“å…¥è¾“å‡º
Defaults log_input, log_output
Defaults iolog_dir="/var/log/sudo/io/%{seq}"
Defaults iolog_file="%{seq}"
```

**æ—¥å¿—æ–‡ä»¶ç¤ºä¾‹**ï¼š
```
Jan 17 10:30:15 server sudo: alice : TTY=pts/1 ; PWD=/home/alice ; USER=root ; COMMAND=/bin/ls -la
Jan 17 10:31:22 server sudo: bob : TTY=pts/2 ; PWD=/tmp ; USER=root ; COMMAND=/usr/bin/vim /etc/hosts
```

### 4.4 æ—¥å¿—åˆ†æå’ŒæŸ¥è¯¢


**æŸ¥çœ‹sudoæ—¥å¿—**ï¼š
```bash
# æŸ¥çœ‹æœ€è¿‘çš„sudoæ“ä½œ
tail -f /var/log/sudo/sudo.log

# æŒ‰ç”¨æˆ·ç­›é€‰æ—¥å¿—
grep "alice" /var/log/sudo/sudo.log

# æŒ‰å‘½ä»¤ç­›é€‰æ—¥å¿—
grep "COMMAND=" /var/log/sudo/sudo.log | grep "rm"
```

**é‡è¦æ—¥å¿—æ¨¡å¼**ï¼š
```bash
# æŸ¥æ‰¾å¤±è´¥çš„sudoå°è¯•
grep "authentication failure" /var/log/auth.log

# æŸ¥æ‰¾å¯ç–‘çš„æƒé™æå‡
grep "COMMAND=/bin/su" /var/log/sudo/sudo.log
```

---

## 5. â° sudoæƒé™æ—¶é—´é™åˆ¶


### 5.1 æ—¶é—´é™åˆ¶çš„ç”¨é€”


**ä¸ºä»€ä¹ˆéœ€è¦æ—¶é—´é™åˆ¶**ï¼š
- **é™ä½å®‰å…¨é£é™©**ï¼šé™åˆ¶å±é™©æ“ä½œçš„æ—¶é—´çª—å£
- **ä¸šåŠ¡éœ€æ±‚**ï¼šæŸäº›æ“ä½œåªèƒ½åœ¨ç‰¹å®šæ—¶é—´è¿›è¡Œ
- **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³å®‰å…¨å®¡è®¡çš„æ—¶é—´æ§åˆ¶è¦æ±‚

### 5.2 åŸºäºæ—¶é—´çš„è®¿é—®æ§åˆ¶


**æŒ‰æ—¶é—´æ®µé™åˆ¶sudo**ï¼š
```bash
# åªå…è®¸å·¥ä½œæ—¶é—´ä½¿ç”¨sudoï¼ˆéœ€è¦è‡ªå®šä¹‰è„šæœ¬ï¼‰
# åœ¨sudoersä¸­è°ƒç”¨æ—¶é—´æ£€æŸ¥è„šæœ¬
alice ALL=(ALL) ALL, !/usr/local/bin/time_check.sh

# æ—¶é—´æ£€æŸ¥è„šæœ¬ç¤ºä¾‹
#!/bin/bash
hour=$(date +%H)
if [ $hour -ge 9 ] && [ $hour -lt 18 ]; then
    exit 0  # å…è®¸
else
    echo "sudoä»…åœ¨å·¥ä½œæ—¶é—´(9:00-18:00)å¯ç”¨"
    exit 1  # æ‹’ç»
fi
```

**æŒ‰æ˜ŸæœŸé™åˆ¶**ï¼š
```bash
# å‘¨æœ«ç¦ç”¨æŸäº›å±é™©å‘½ä»¤
%weekend ALL=(ALL) ALL, !DANGEROUS
```

### 5.3 ä¼šè¯è¶…æ—¶é…ç½®


**çµæ´»çš„è¶…æ—¶è®¾ç½®**ï¼š
```bash
# ä¸åŒå‘½ä»¤ä¸åŒè¶…æ—¶æ—¶é—´
Defaults!/usr/bin/vim timestamp_timeout=60
Defaults!/bin/rm timestamp_timeout=5
Defaults!/usr/sbin/service timestamp_timeout=30
```

**åŸºäºå‘½ä»¤ç±»å‹çš„è¶…æ—¶**ï¼š
```bash
# ç³»ç»Ÿç®¡ç†å‘½ä»¤çŸ­è¶…æ—¶
Cmnd_Alias SYSTEM_CMDS = /usr/sbin/service, /bin/systemctl
Defaults!SYSTEM_CMDS timestamp_timeout=5

# æ–‡ä»¶ç¼–è¾‘å‘½ä»¤é•¿è¶…æ—¶  
Cmnd_Alias EDIT_CMDS = /usr/bin/vim, /bin/nano
Defaults!EDIT_CMDS timestamp_timeout=30
```

---

## 6. ğŸŒ sudoç¯å¢ƒå˜é‡è¿‡æ»¤


### 6.1 ç¯å¢ƒå˜é‡å®‰å…¨é£é™©


**ä¸ºä»€ä¹ˆè¦è¿‡æ»¤ç¯å¢ƒå˜é‡**ï¼š
- **å®‰å…¨é£é™©**ï¼šæ¶æ„çš„ç¯å¢ƒå˜é‡å¯èƒ½å¯¼è‡´æƒé™æå‡
- **éš”ç¦»ç¯å¢ƒ**ï¼šé¿å…ç”¨æˆ·ç¯å¢ƒå½±å“ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œ
- **ä¸€è‡´æ€§**ï¼šç¡®ä¿å‘½ä»¤åœ¨ç›¸åŒç¯å¢ƒä¸‹æ‰§è¡Œ

**å¸¸è§å±é™©ç¯å¢ƒå˜é‡**ï¼š
```bash
LD_LIBRARY_PATH    # å¯èƒ½åŠ è½½æ¶æ„åº“æ–‡ä»¶
PATH               # å¯èƒ½æ‰§è¡Œæ¶æ„ç¨‹åº  
IFS                # å¯èƒ½æ”¹å˜å‘½ä»¤è§£ææ–¹å¼
SHELL              # å¯èƒ½æŒ‡å®šæ¶æ„shell
```

### 6.2 ç¯å¢ƒå˜é‡è¿‡æ»¤é…ç½®


**åŸºæœ¬ç¯å¢ƒé‡ç½®**ï¼š
```bash
# é‡ç½®ä¸ºå®‰å…¨çš„ç¯å¢ƒå˜é‡
Defaults env_reset

# ä¿ç•™å¿…è¦çš„ç¯å¢ƒå˜é‡
Defaults env_keep += "LANG LC_* HOME USER LOGNAME"
```

**è¯¦ç»†ç¯å¢ƒé…ç½®**ï¼š
```bash
# å…è®¸ä¿ç•™çš„å®‰å…¨ç¯å¢ƒå˜é‡
Defaults env_keep += "HOME"
Defaults env_keep += "LANG"  
Defaults env_keep += "LOGNAME"
Defaults env_keep += "PATH"
Defaults env_keep += "USER"

# æ˜ç¡®ç¦æ­¢çš„å±é™©ç¯å¢ƒå˜é‡
Defaults env_delete += "LD_LIBRARY_PATH"
Defaults env_delete += "LD_PRELOAD"
```

### 6.3 è‡ªå®šä¹‰ç¯å¢ƒå˜é‡ç­–ç•¥


**æŒ‰å‘½ä»¤è®¾ç½®ç¯å¢ƒ**ï¼š
```bash
# ä¸ºç‰¹å®šå‘½ä»¤è®¾ç½®ç¯å¢ƒå˜é‡
Defaults!/usr/bin/mysql env_keep += "MYSQL_HOST"
Defaults!/usr/bin/python env_keep += "PYTHONPATH"
```

**ç”¨æˆ·ç‰¹å®šç¯å¢ƒç­–ç•¥**ï¼š
```bash
# å¼€å‘äººå‘˜å¯ä»¥ä¿ç•™æ›´å¤šç¯å¢ƒå˜é‡
Defaults:developer env_keep += "JAVA_HOME MAVEN_HOME"

# è¿ç»´äººå‘˜ä¿ç•™ç³»ç»Ÿç›¸å…³å˜é‡
Defaults:sysadmin env_keep += "KUBECONFIG AWS_PROFILE"
```

---

## 7. ğŸ”’ sudoå®‰å…¨é€‰é¡¹é…ç½®


### 7.1 è®¤è¯å®‰å…¨é…ç½®


**å¯†ç ç­–ç•¥é…ç½®**ï¼š
```bash
# å¯†ç é‡è¯•æ¬¡æ•°
Defaults passwd_tries=3

# å¯†ç è¾“å…¥è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
Defaults passwd_timeout=5

# é”™è¯¯å¯†ç åçš„ç­‰å¾…æ—¶é—´
Defaults badpass_message="å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•"
```

**è®¤è¯æ–¹å¼é…ç½®**ï¼š
```bash
# è¦æ±‚ç”¨æˆ·è¾“å…¥è‡ªå·±çš„å¯†ç ï¼ˆè€Œérootå¯†ç ï¼‰
Defaults targetpw=false

# è¦æ±‚è¾“å…¥ç›®æ ‡ç”¨æˆ·çš„å¯†ç 
Defaults runaspw=true

# ç¦ç”¨å¯†ç è®¤è¯ï¼Œåªå…è®¸å…¬é’¥è®¤è¯
Defaults !authenticate
```

### 7.2 å‘½ä»¤æ‰§è¡Œå®‰å…¨


**shellç›¸å…³å®‰å…¨**ï¼š
```bash
# ç¦æ­¢shellè½¬ä¹‰
Defaults noexec

# ç¦ç”¨!historyå‘½ä»¤
Defaults !shell_noargs

# è®¾ç½®å®‰å…¨çš„PATH
Defaults secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
```

**æ–‡ä»¶ç³»ç»Ÿå®‰å…¨**ï¼š
```bash
# ç¦æ­¢é€šè¿‡ç¼–è¾‘å™¨æ‰§è¡Œshell
Defaults noexec
Defaults env_editor

# é™åˆ¶å¯ä»¥ç¼–è¾‘çš„æ–‡ä»¶
alice ALL=(root) sudoedit /etc/hosts, /etc/resolv.conf
```

### 7.3 ç½‘ç»œå’Œè¿œç¨‹è®¿é—®å®‰å…¨


**è¿œç¨‹sudoé™åˆ¶**ï¼š
```bash
# é™åˆ¶sudoåªèƒ½åœ¨æœ¬åœ°ä½¿ç”¨
Defaults requiretty

# å…è®¸ç‰¹å®šIPçš„è¿œç¨‹sudo
Defaults:alice !requiretty
alice ALL=(ALL) ALL
Host_Alias TRUSTED_HOSTS = 192.168.1.0/24
alice TRUSTED_HOSTS=(ALL) ALL
```

**æ—¥å¿—å’Œç›‘æ§å¢å¼º**ï¼š
```bash
# å‘é€é‚®ä»¶é€šçŸ¥
Defaults mail_always
Defaults mailto="admin@company.com"

# è¯¦ç»†çš„ç”¨æˆ·ä¿¡æ¯è®°å½•
Defaults log_host, log_year
Defaults syslog=auth
```

---

## 8. ğŸ” sudoæ•…éšœæ’æŸ¥æŠ€å·§


### 8.1 å¸¸è§sudoé—®é¢˜


**æƒé™è¢«æ‹’ç»é—®é¢˜**ï¼š
```bash
# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨sudoersä¸­
sudo -l -U username

# æ£€æŸ¥sudoersæ–‡ä»¶è¯­æ³•
sudo visudo -c

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
sudo -v
```

**ä¼šè¯é—®é¢˜æ’æŸ¥**ï¼š
```bash
# æŸ¥çœ‹ä¼šè¯çŠ¶æ€
sudo -n true && echo "æœ‰æ•ˆ" || echo "æ— æ•ˆ"

# æ¸…é™¤ä¼šè¯é‡æ–°æµ‹è¯•
sudo -k
sudo ls

# æ£€æŸ¥ä¼šè¯æ–‡ä»¶æƒé™
ls -la /var/lib/sudo/ts/
```

### 8.2 æ—¥å¿—åˆ†ææ’æŸ¥


**æŸ¥çœ‹sudoé”™è¯¯æ—¥å¿—**ï¼š
```bash
# ç³»ç»Ÿæ—¥å¿—ä¸­çš„sudoé”™è¯¯
grep sudo /var/log/auth.log | tail -20

# sudoä¸“ç”¨æ—¥å¿—æ–‡ä»¶
tail -f /var/log/sudo/sudo.log

# æŸ¥æ‰¾æƒé™æ‹’ç»è®°å½•
grep "not allowed" /var/log/sudo/sudo.log
```

**åˆ†æç”¨æˆ·è¡Œä¸º**ï¼š
```bash
# ç»Ÿè®¡ç”¨æˆ·sudoä½¿ç”¨é¢‘ç‡
awk '/sudo:/ {print $6}' /var/log/sudo/sudo.log | sort | uniq -c

# æŸ¥æ‰¾å¼‚å¸¸å‘½ä»¤æ‰§è¡Œ
grep "COMMAND=" /var/log/sudo/sudo.log | grep -E "(rm -rf|dd |mkfs)"
```

### 8.3 é…ç½®æ–‡ä»¶è°ƒè¯•


**sudoersè¯­æ³•æ£€æŸ¥**ï¼š
```bash
# æ£€æŸ¥ä¸»é…ç½®æ–‡ä»¶
sudo visudo -c

# æ£€æŸ¥ç‰¹å®šé…ç½®æ–‡ä»¶
sudo visudo -c -f /etc/sudoers.d/myconfig

# æµ‹è¯•é…ç½®æ˜¯å¦ç”Ÿæ•ˆ
sudo -l
```

**é€æ­¥è°ƒè¯•æ–¹æ³•**ï¼š
```bash
# 1. å…ˆç»™ç”¨æˆ·å®Œæ•´æƒé™æµ‹è¯•
username ALL=(ALL) NOPASSWD: ALL

# 2. ç¡®è®¤åŸºæœ¬åŠŸèƒ½æ­£å¸¸åå†é™åˆ¶
username ALL=(ALL) NOPASSWD: /bin/ls, /bin/cat

# 3. é€æ­¥æ·»åŠ é™åˆ¶æ¡ä»¶
username ALL=(ALL) NOPASSWD: /bin/ls, !/bin/rm
```

---

## 9. âš¡ sudoæ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 9.1 sudoæ€§èƒ½å½±å“å› ç´ 


**æ€§èƒ½ç“¶é¢ˆåˆ†æ**ï¼š
- **DNSè§£æå»¶è¿Ÿ**ï¼šhostnameæŸ¥æ‰¾è€—æ—¶
- **è®¤è¯æ’ä»¶å¼€é”€**ï¼šå¤æ‚è®¤è¯é€»è¾‘
- **æ—¥å¿—IOå¼€é”€**ï¼šé¢‘ç¹çš„æ—¥å¿—å†™å…¥
- **ç½‘ç»œå»¶è¿Ÿ**ï¼šè¿œç¨‹è®¤è¯æœåŠ¡å™¨

### 9.2 DNSå’Œç½‘ç»œä¼˜åŒ–


**DNSä¼˜åŒ–é…ç½®**ï¼š
```bash
# è·³è¿‡DNSåå‘è§£æï¼ˆæå‡é€Ÿåº¦ï¼‰
Defaults !fqdn

# ä½¿ç”¨IPåœ°å€è€Œéä¸»æœºå
192.168.1.100 ALL=(ALL) NOPASSWD: ALL

# æœ¬åœ°hostsæ–‡ä»¶ä¼˜åŒ–
echo "192.168.1.100 server01" >> /etc/hosts
```

**ç½‘ç»œè¿æ¥ä¼˜åŒ–**ï¼š
```bash
# å‡å°‘ç½‘ç»œè¶…æ—¶æ—¶é—´
Defaults timeout=30

# æœ¬åœ°è®¤è¯ä¼˜å…ˆ
Defaults !requiretty
```

### 9.3 è®¤è¯å’Œæ—¥å¿—ä¼˜åŒ–


**è®¤è¯ä¼˜åŒ–**ï¼š
```bash
# å¯¹å¯ä¿¡ç”¨æˆ·è·³è¿‡å¯†ç è®¤è¯
trusteduser ALL=(ALL) NOPASSWD: ALL

# ä½¿ç”¨ç»„è®¤è¯å‡å°‘é…ç½®è¡Œæ•°
%admin ALL=(ALL) ALL
```

**æ—¥å¿—æ€§èƒ½ä¼˜åŒ–**ï¼š
```bash
# å¼‚æ­¥æ—¥å¿—å†™å…¥
Defaults log_input, log_output
Defaults iolog_dir="/var/log/sudo/io"
Defaults iolog_flush=false

# å®šæœŸæ¸…ç†æ—§æ—¥å¿—
# åœ¨cronä¸­æ·»åŠ æ—¥å¿—æ¸…ç†ä»»åŠ¡
0 2 * * 0 find /var/log/sudo -name "*.log" -mtime +30 -delete
```

### 9.4 ç¼“å­˜å’Œä¼šè¯ä¼˜åŒ–


**ä¼šè¯ç¼“å­˜ä¼˜åŒ–**ï¼š
```bash
# å»¶é•¿ä¼šè¯æ—¶é—´å‡å°‘è®¤è¯æ¬¡æ•°
Defaults timestamp_timeout=60

# ä½†è¦å¹³è¡¡å®‰å…¨å’Œæ€§èƒ½
Defaults timestamp_timeout=15
Defaults tty_tickets
```

**é…ç½®ç¼“å­˜ä¼˜åŒ–**ï¼š
```bash
# å‡å°‘sudoersæ–‡ä»¶å¤§å°å’Œå¤æ‚åº¦
# ä½¿ç”¨ç»„è€Œéä¸ªäººæƒé™
%developers ALL=(ALL) /usr/bin/git, /usr/bin/docker

# é¿å…è¿‡å¤šçš„å¦å®šè§„åˆ™
%users ALL=(ALL) ALL, !/bin/su, !/usr/bin/passwd [A-z]*
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ sudoæ’ä»¶ç³»ç»Ÿï¼šè®¤è¯ã€ç­–ç•¥ã€å®¡è®¡ã€IOå››ç±»æ’ä»¶æ‰©å±•sudoåŠŸèƒ½
ğŸ”¸ ä¼šè¯ç®¡ç†ï¼šé€šè¿‡æ—¶é—´çª—å£å‡å°‘é‡å¤å¯†ç è¾“å…¥ï¼Œå¹³è¡¡å®‰å…¨å’Œä¾¿åˆ©
ğŸ”¸ æ—¥å¿—è®°å½•ï¼šè¯¦ç»†è®°å½•æ‰€æœ‰sudoæ“ä½œï¼Œæ”¯æŒå®‰å…¨å®¡è®¡å’Œæ•…éšœæ’æŸ¥
ğŸ”¸ æ—¶é—´é™åˆ¶ï¼šåŸºäºæ—¶é—´æ®µå’Œä¼šè¯è¶…æ—¶çš„æƒé™æ§åˆ¶æœºåˆ¶
ğŸ”¸ ç¯å¢ƒå˜é‡è¿‡æ»¤ï¼šé˜²æ­¢æ¶æ„ç¯å¢ƒå˜é‡å¯¼è‡´çš„å®‰å…¨é£é™©
ğŸ”¸ å®‰å…¨é€‰é¡¹ï¼šå¤šå±‚æ¬¡çš„å®‰å…¨åŠ å›ºé…ç½®
ğŸ”¸ æ•…éšœæ’æŸ¥ï¼šç³»ç»ŸåŒ–çš„é—®é¢˜è¯Šæ–­å’Œè§£å†³æ–¹æ³•
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šåœ¨ä¿è¯å®‰å…¨çš„å‰æä¸‹æå‡sudoæ‰§è¡Œæ•ˆç‡
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ sudoé«˜çº§é…ç½®çš„è®¾è®¡æ€è·¯**
```
å®‰å…¨ç¬¬ä¸€åŸåˆ™ï¼š
- æœ€å°æƒé™ï¼šåªç»™å¿…è¦çš„æƒé™
- æ·±åº¦é˜²å¾¡ï¼šå¤šå±‚å®‰å…¨æ§åˆ¶
- å®¡è®¡è·Ÿè¸ªï¼šæ‰€æœ‰æ“ä½œå¯è¿½æº¯
- å¤±è´¥å®‰å…¨ï¼šé…ç½®é”™è¯¯æ—¶æ‹’ç»è®¿é—®
```

**ğŸ”¹ é…ç½®æ–‡ä»¶çš„ç®¡ç†ç­–ç•¥**
```
é…ç½®ç®¡ç†æœ€ä½³å®è·µï¼š
- ä½¿ç”¨visudoç¼–è¾‘ï¼šé˜²æ­¢è¯­æ³•é”™è¯¯
- æ¨¡å—åŒ–é…ç½®ï¼š/etc/sudoers.d/ç›®å½•åˆ†ç±»ç®¡ç†
- ç‰ˆæœ¬æ§åˆ¶ï¼šé…ç½®æ–‡ä»¶çº³å…¥gitç®¡ç†
- æµ‹è¯•éªŒè¯ï¼šé…ç½®å‰ååŠŸèƒ½æµ‹è¯•
```

**ğŸ”¹ æ—¥å¿—å’Œç›‘æ§çš„é‡è¦æ€§**
```
å®‰å…¨è¿ç»´ä»·å€¼ï¼š
- è¡Œä¸ºåˆ†æï¼šå‘ç°å¼‚å¸¸è®¿é—®æ¨¡å¼
- åˆè§„å®¡è®¡ï¼šæ»¡è¶³å®‰å…¨è®¤è¯è¦æ±‚  
- æ•…éšœå®šä½ï¼šå¿«é€Ÿå‘ç°é…ç½®é—®é¢˜
- æ€§èƒ½ç›‘æ§ï¼šè¯†åˆ«æ€§èƒ½ç“¶é¢ˆç‚¹
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä¼ä¸šçº§sudoé…ç½®æ¨¡æ¿**
```bash
# åŸºç¡€å®‰å…¨é…ç½®
Defaults env_reset
Defaults secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin"
Defaults timestamp_timeout=15
Defaults passwd_tries=3

# æ—¥å¿—é…ç½®
Defaults log_host, log_year
Defaults logfile=/var/log/sudo/sudo.log
Defaults log_input, log_output
Defaults iolog_dir="/var/log/sudo/io"

# ç”¨æˆ·ç»„æƒé™
%admin ALL=(ALL) ALL
%developers ALL=(ALL) /usr/bin/git, /usr/bin/docker, /usr/bin/kubectl
%operators ALL=(ALL) /bin/systemctl, /usr/sbin/service

# ç‰¹æ®Šç”¨æˆ·æ— å¯†ç æƒé™
backup ALL=(ALL) NOPASSWD: /usr/bin/rsync, /bin/tar
monitor ALL=(ALL) NOPASSWD: /bin/ps, /usr/bin/top, /bin/netstat
```

**ğŸ”§ å¸¸ç”¨ç»´æŠ¤å‘½ä»¤**
```bash
# é…ç½®æ£€æŸ¥
sudo visudo -c
sudo -l

# æ—¥å¿—åˆ†æ  
tail -f /var/log/sudo/sudo.log
grep "COMMAND=" /var/log/sudo/sudo.log | awk '{print $NF}' | sort | uniq -c

# ç”¨æˆ·æƒé™æŸ¥è¯¢
sudo -l -U username
sudo -U username -l

# ä¼šè¯ç®¡ç†
sudo -k          # æ¸…é™¤å½“å‰ä¼šè¯
sudo -K          # æ¸…é™¤æ‰€æœ‰ä¼šè¯
sudo -v          # éªŒè¯å½“å‰ä¼šè¯
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- sudoé«˜çº§é…ç½®æ˜¯Linuxç³»ç»Ÿå®‰å…¨çš„é‡è¦ç»„æˆéƒ¨åˆ†
- é€šè¿‡æ’ä»¶ã€ä¼šè¯ã€æ—¥å¿—ã€ç¯å¢ƒå˜é‡ç­‰å¤šç»´åº¦æ§åˆ¶
- é…ç½®æ—¶è¦å¹³è¡¡å®‰å…¨æ€§ã€æ˜“ç”¨æ€§å’Œæ€§èƒ½
- è¯¦ç»†çš„æ—¥å¿—è®°å½•æ˜¯å®‰å…¨å®¡è®¡å’Œæ•…éšœæ’æŸ¥çš„åŸºç¡€
- ä½¿ç”¨visudoç¼–è¾‘é…ç½®ï¼Œé‡‡ç”¨æ¨¡å—åŒ–ç®¡ç†ç­–ç•¥