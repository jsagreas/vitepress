---
title: 9ã€Podman Rootlesså®¹å™¨
---
## ğŸ“š ç›®å½•

1. [Rootlesså®¹å™¨åŸºç¡€æ¦‚å¿µ](#1-Rootlesså®¹å™¨åŸºç¡€æ¦‚å¿µ)
2. [ç”¨æˆ·å‘½åç©ºé—´æ˜ å°„](#2-ç”¨æˆ·å‘½åç©ºé—´æ˜ å°„)
3. [subuid/subgidé…ç½®ç®¡ç†](#3-subuid-subgidé…ç½®ç®¡ç†)
4. [Rootlessç½‘ç»œé…ç½®](#4-Rootlessç½‘ç»œé…ç½®)
5. [SystemDç”¨æˆ·æœåŠ¡é›†æˆ](#5-SystemDç”¨æˆ·æœåŠ¡é›†æˆ)
6. [æƒé™é™åˆ¶ä¸å®‰å…¨æœºåˆ¶](#6-æƒé™é™åˆ¶ä¸å®‰å…¨æœºåˆ¶)
7. [Rootlesså­˜å‚¨é…ç½®](#7-Rootlesså­˜å‚¨é…ç½®)
8. [å¸¸è§æƒé™é—®é¢˜è§£å†³](#8-å¸¸è§æƒé™é—®é¢˜è§£å†³)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ Rootlesså®¹å™¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Rootlesså®¹å™¨


**Rootlesså®¹å™¨**å°±æ˜¯ä¸éœ€è¦rootæƒé™å°±èƒ½è¿è¡Œçš„å®¹å™¨ï¼Œå°±åƒæ™®é€šç”¨æˆ·è¿è¡Œè‡ªå·±çš„ç¨‹åºä¸€æ ·ç®€å•å®‰å…¨ã€‚

> **ğŸ’¡ æ ¸å¿ƒç†è§£**
> Rootless = æ™®é€šç”¨æˆ·æƒé™è¿è¡Œå®¹å™¨ï¼Œæå‡å®‰å…¨æ€§ï¼Œé™ä½æƒé™é£é™©

**ä¼ ç»Ÿå®¹å™¨ vs Rootlesså®¹å™¨å¯¹æ¯”ï¼š**
```
ä¼ ç»ŸDockerå®¹å™¨è¿è¡Œï¼š
ç”¨æˆ· â†’ sudo docker run â†’ Dockerå®ˆæŠ¤è¿›ç¨‹(root) â†’ å®¹å™¨(root)
é—®é¢˜ï¼šéœ€è¦rootæƒé™ï¼Œå®‰å…¨é£é™©é«˜

Podman Rootlesså®¹å™¨ï¼š
ç”¨æˆ· â†’ podman run â†’ å®¹å™¨(ç”¨æˆ·æƒé™)
ä¼˜åŠ¿ï¼šæ— éœ€rootæƒé™ï¼Œå®‰å…¨é£é™©ä½
```

### 1.2 Rootlesså®¹å™¨çš„æ ¸å¿ƒä¼˜åŠ¿


**ğŸ”¸ å®‰å…¨æ€§æå‡**
- å®¹å™¨è¿›ç¨‹ä»¥æ™®é€šç”¨æˆ·èº«ä»½è¿è¡Œ
- å³ä½¿å®¹å™¨è¢«æ”»ç ´ï¼Œå½±å“èŒƒå›´æœ‰é™
- ç¬¦åˆæœ€å°æƒé™åŸåˆ™

**ğŸ”¸ å¤šç”¨æˆ·ç¯å¢ƒå‹å¥½**
- æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ç®¡ç†è‡ªå·±çš„å®¹å™¨
- ä¸éœ€è¦å…±äº«Dockerå®ˆæŠ¤è¿›ç¨‹
- é¿å…æƒé™å†²çªé—®é¢˜

**ğŸ”¸ éƒ¨ç½²ç®€ä¾¿**
- æ™®é€šç”¨æˆ·å³å¯å®‰è£…ä½¿ç”¨
- æ— éœ€ç³»ç»Ÿç®¡ç†å‘˜æƒé™
- é€‚åˆå¼€å‘æµ‹è¯•ç¯å¢ƒ

### 1.3 åº”ç”¨åœºæ™¯åˆ†æ


| åœºæ™¯ç±»å‹ | **ä¼ ç»Ÿå®¹å™¨** | **Rootlesså®¹å™¨** | **æ¨èé€‰æ‹©** |
|---------|-------------|-----------------|-------------|
| `ç”Ÿäº§ç¯å¢ƒ` | âš¡ æ€§èƒ½å¥½ | ğŸ”’ æ›´å®‰å…¨ | `æ ¹æ®å®‰å…¨éœ€æ±‚` |
| `å¼€å‘ç¯å¢ƒ` | ğŸ”§ éœ€è¦sudo | âœ… ç”¨æˆ·å‹å¥½ | `âœ… Rootless` |
| `CI/CD` | âš ï¸ æƒé™ç®¡ç†å¤æ‚ | âœ… éš”ç¦»æ€§å¥½ | `âœ… Rootless` |
| `å…±äº«æœåŠ¡å™¨` | âŒ å®‰å…¨é£é™© | âœ… ç”¨æˆ·éš”ç¦» | `âœ… Rootless` |

---

## 2. ğŸ—ºï¸ ç”¨æˆ·å‘½åç©ºé—´æ˜ å°„


### 2.1 å‘½åç©ºé—´æ˜ å°„åŸç†


**ç”¨æˆ·å‘½åç©ºé—´**æ˜¯Linuxå†…æ ¸æä¾›çš„åŠŸèƒ½ï¼Œè®©å®¹å™¨å†…çš„ç”¨æˆ·IDæ˜ å°„åˆ°ä¸»æœºä¸Šçš„ä¸åŒç”¨æˆ·IDã€‚

```
æ˜ å°„æœºåˆ¶å›¾ç¤ºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    å®¹å™¨å†…éƒ¨     â”‚    â”‚    ä¸»æœºç³»ç»Ÿ     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ root (UID 0)    â”‚ â†’  â”‚ user1000(1000)  â”‚
â”‚ app  (UID 1000) â”‚ â†’  â”‚ nobody(65534)   â”‚
â”‚ www  (UID 33)   â”‚ â†’  â”‚ user1033(1033)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> **ğŸ” å®è·µæ„ä¹‰**
> å®¹å™¨å†…çš„rootç”¨æˆ·åœ¨ä¸»æœºä¸Šåªæ˜¯æ™®é€šç”¨æˆ·ï¼Œå¤§å¤§é™ä½äº†å®‰å…¨é£é™©

### 2.2 æŸ¥çœ‹å‘½åç©ºé—´æ˜ å°„


**æŸ¥çœ‹å½“å‰æ˜ å°„çŠ¶æ€ï¼š**
```bash
# æŸ¥çœ‹ç”¨æˆ·IDæ˜ å°„
cat /proc/self/uid_map

# æŸ¥çœ‹ç»„IDæ˜ å°„  
cat /proc/self/gid_map

# åœ¨è¿è¡Œçš„å®¹å™¨ä¸­æŸ¥çœ‹
podman exec -it mycontainer cat /proc/self/uid_map
```

**å®é™…è¾“å‡ºç¤ºä¾‹ï¼š**
```
$ cat /proc/self/uid_map
         0       1000          1
         1     100000      65536

è§£é‡Šï¼š
å®¹å™¨UID 0 â†’ ä¸»æœºUID 1000 (æ˜ å°„1ä¸ªID)
å®¹å™¨UID 1-65536 â†’ ä¸»æœºUID 100000-165535 (æ˜ å°„65536ä¸ªID)
```

### 2.3 æ˜ å°„é…ç½®è¯¦è§£


**æ˜ å°„è§„åˆ™æ ¼å¼ï¼š**
```
å®¹å™¨å†…ID  ä¸»æœºID  æ˜ å°„æ•°é‡

ç¤ºä¾‹é…ç½®ï¼š
0    1000    1        # å®¹å™¨root â†’ ä¸»æœºç”¨æˆ·1000
1    100000  65536    # å®¹å™¨1-65536 â†’ ä¸»æœº100000-165535
```

**ğŸ”§ æ‰‹åŠ¨é…ç½®æ˜ å°„ï¼š**
```bash
# åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´å¹¶è®¾ç½®æ˜ å°„
unshare --user --pid --mount --fork --map-root-user bash

# éªŒè¯æ˜ å°„æ•ˆæœ
id  # æ˜¾ç¤ºå®¹å™¨å†…ID
cat /proc/self/uid_map  # æ˜¾ç¤ºæ˜ å°„å…³ç³»
```

---

## 3. âš™ï¸ subuid/subgidé…ç½®ç®¡ç†


### 3.1 subuid/subgidæ–‡ä»¶ä½œç”¨


**subuid**å’Œ**subgid**æ–‡ä»¶å®šä¹‰äº†æ¯ä¸ªç”¨æˆ·å¯ä»¥ä½¿ç”¨çš„"ä»å±ç”¨æˆ·ID"èŒƒå›´ï¼Œå°±åƒç»™æ¯ä¸ªç”¨æˆ·åˆ†é…ä¸€ä¸ª"IDæ± "ã€‚

> **ğŸ’¡ æ ¸å¿ƒç†è§£**
> subuid = ç”¨æˆ·çš„"è™šæ‹Ÿç”¨æˆ·IDæ± "ï¼Œç”¨äºå®¹å™¨å†…éƒ¨çš„ç”¨æˆ·æ˜ å°„

### 3.2 é…ç½®æ–‡ä»¶ç»“æ„


**æ–‡ä»¶ä½ç½®å’Œæ ¼å¼ï¼š**
```
/etc/subuid - ç”¨æˆ·IDèŒƒå›´åˆ†é…
/etc/subgid - ç»„IDèŒƒå›´åˆ†é…

æ ¼å¼ï¼šç”¨æˆ·å:èµ·å§‹ID:æ•°é‡
```

**æ ‡å‡†é…ç½®ç¤ºä¾‹ï¼š**
```bash
# /etc/subuid å†…å®¹
john:100000:65536
mary:165536:65536
developer:231072:65536

# /etc/subgid å†…å®¹  
john:100000:65536
mary:165536:65536
developer:231072:65536
```

### 3.3 é…ç½®ç®¡ç†æ“ä½œ


**ğŸ”¸ æŸ¥çœ‹å½“å‰é…ç½®ï¼š**
```bash
# æŸ¥çœ‹ç”¨æˆ·çš„subuidåˆ†é…
grep $USER /etc/subuid

# æŸ¥çœ‹ç”¨æˆ·çš„subgidåˆ†é…  
grep $USER /etc/subgid

# ä½¿ç”¨usermodæŸ¥çœ‹(å¦‚æœæ”¯æŒ)
usermod --list-subid $USER
```

**ğŸ”¹ æ·»åŠ subuid/subgidé…ç½®ï¼š**
```bash
# ä½¿ç”¨usermodæ·»åŠ (æ¨èæ–¹æ³•)
sudo usermod --add-subuids 100000-165535 username
sudo usermod --add-subgids 100000-165535 username

# æ‰‹åŠ¨ç¼–è¾‘æ–‡ä»¶(è°¨æ…ä½¿ç”¨)
echo "username:100000:65536" | sudo tee -a /etc/subuid
echo "username:100000:65536" | sudo tee -a /etc/subgid
```

**âš¡ å¿«é€Ÿé…ç½®è„šæœ¬ï¼š**
```bash
#!/bin/bash
# ä¸ºå½“å‰ç”¨æˆ·è‡ªåŠ¨é…ç½®subuid/subgid

USER_NAME=$(whoami)

# æ£€æŸ¥æ˜¯å¦å·²é…ç½®
if ! grep -q "^$USER_NAME:" /etc/subuid; then
    # æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨çš„èµ·å§‹ID
    NEXT_ID=$(awk -F: 'END{print $2+$3}' /etc/subuid)
    NEXT_ID=${NEXT_ID:-100000}
    
    # æ·»åŠ é…ç½®
    echo "$USER_NAME:$NEXT_ID:65536" | sudo tee -a /etc/subuid
    echo "$USER_NAME:$NEXT_ID:65536" | sudo tee -a /etc/subgid
    
    echo "é…ç½®å®Œæˆï¼š$USER_NAME å¯ä½¿ç”¨ $NEXT_ID-$((NEXT_ID+65535))"
else
    echo "ç”¨æˆ· $USER_NAME å·²ç»é…ç½®äº†subuid/subgid"
fi
```

### 3.4 é…ç½®éªŒè¯æµ‹è¯•


**éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆï¼š**
```bash
# é‡æ–°ç™»å½•åæµ‹è¯•
podman system info | grep -A5 "IDMappings"

# åˆ›å»ºç®€å•å®¹å™¨æµ‹è¯•æ˜ å°„
podman run --rm -it alpine id
```

**é¢„æœŸè¾“å‡ºç¤ºä¾‹ï¼š**
```
$ podman run --rm -it alpine id
uid=0(root) gid=0(root) groups=0(root)

åœ¨ä¸»æœºä¸ŠæŸ¥çœ‹è¿›ç¨‹ï¼š
$ ps aux | grep alpine
john    12345  0.0  0.0  container_process
# å®¹å™¨å†…rootè¿›ç¨‹åœ¨ä¸»æœºä¸Šä»¥johnç”¨æˆ·èº«ä»½è¿è¡Œ
```

---

## 4. ğŸŒ Rootlessç½‘ç»œé…ç½®


### 4.1 Rootlessç½‘ç»œé™åˆ¶


åœ¨Rootlessæ¨¡å¼ä¸‹ï¼Œç½‘ç»œåŠŸèƒ½å—åˆ°é™åˆ¶ï¼Œå› ä¸ºåˆ›å»ºç½‘ç»œæ¥å£éœ€è¦ç‰¹æ®Šæƒé™ã€‚

**ğŸ”¸ ä¸»è¦é™åˆ¶ï¼š**
- æ— æ³•ç»‘å®š1024ä»¥ä¸‹çš„ç‰¹æƒç«¯å£
- æ— æ³•åˆ›å»ºæ¡¥æ¥ç½‘ç»œ
- é»˜è®¤ä½¿ç”¨slirp4netnsè¿›è¡Œç½‘ç»œè½¬æ¢

```
ç½‘ç»œæ¶æ„å¯¹æ¯”ï¼š
Rootæ¨¡å¼ï¼š    å®¹å™¨ â†” æ¡¥æ¥ç½‘ç»œ â†” ä¸»æœºç½‘ç»œ
Rootlessæ¨¡å¼ï¼šå®¹å™¨ â†” slirp4netns â†” ç”¨æˆ·ç©ºé—´ â†” ä¸»æœºç½‘ç»œ
```

### 4.2 ç«¯å£æ˜ å°„é…ç½®


**åŸºæœ¬ç«¯å£æ˜ å°„è¯­æ³•ï¼š**
```bash
# æ˜ å°„åˆ°é«˜ç«¯å£(>=1024)
podman run -p 8080:80 nginx

# æ˜ å°„åˆ°ç‰¹æƒç«¯å£éœ€è¦ç‰¹æ®Šé…ç½®
podman run --privileged -p 80:80 nginx  # é€šå¸¸ä¸å¯ç”¨

# ä½¿ç”¨ç«¯å£è½¬å‘å·¥å…·
socat TCP-LISTEN:80,fork TCP:localhost:8080 &
podman run -p 8080:80 nginx
```

### 4.3 ç½‘ç»œæ¨¡å¼é€‰æ‹©


| ç½‘ç»œæ¨¡å¼ | **ç‰¹ç‚¹** | **ç«¯å£é™åˆ¶** | **æ€§èƒ½** | **é€‚ç”¨åœºæ™¯** |
|---------|----------|-------------|---------|-------------|
| `slirp4netns` | é»˜è®¤æ¨¡å¼ | `>=1024` | ä¸­ç­‰ | `ä¸€èˆ¬åº”ç”¨` |
| `pasta` | æ–°å‹ç½‘ç»œæ ˆ | `>=1024` | è¾ƒå¥½ | `æ–°å†…æ ¸ç³»ç»Ÿ` |
| `host` | ä¸»æœºç½‘ç»œ | æ— é™åˆ¶ | æœ€ä½³ | `ç½‘ç»œå¯†é›†å‹` |

**ğŸ”§ ç½‘ç»œæ¨¡å¼é…ç½®ï¼š**
```bash
# ä½¿ç”¨pastaç½‘ç»œ(æ¨èï¼Œéœ€è¦è¾ƒæ–°å†…æ ¸)
podman run --network pasta -p 8080:80 nginx

# ä½¿ç”¨ä¸»æœºç½‘ç»œ(å…±äº«ä¸»æœºç½‘ç»œæ ˆ)
podman run --network host nginx

# æŸ¥çœ‹å¯ç”¨ç½‘ç»œé©±åŠ¨
podman info | grep -A10 networkBackend
```

### 4.4 è§£å†³ç«¯å£é™åˆ¶


**æ–¹æ³•1ï¼šä½¿ç”¨åå‘ä»£ç†**
```bash
# è¿è¡Œåº”ç”¨åœ¨é«˜ç«¯å£
podman run -d -p 8080:80 --name webapp nginx

# ä½¿ç”¨nginxåå‘ä»£ç†åˆ°80ç«¯å£
sudo nginxé…ç½®:
server {
    listen 80;
    location / {
        proxy_pass http://localhost:8080;
    }
}
```

**æ–¹æ³•2ï¼šè®¾ç½®CAP_NET_BIND_SERVICE**
```bash
# ç»™podmanäºŒè¿›åˆ¶æ–‡ä»¶æ·»åŠ ç½‘ç»œç»‘å®šèƒ½åŠ›
sudo setcap cap_net_bind_service=ep /usr/bin/podman

# ç„¶åå¯ä»¥ç»‘å®šç‰¹æƒç«¯å£
podman run -p 80:80 nginx
```

---

## 5. ğŸ”§ SystemDç”¨æˆ·æœåŠ¡é›†æˆ


### 5.1 SystemDç”¨æˆ·æœåŠ¡åŸºç¡€


**SystemDç”¨æˆ·æœåŠ¡**è®©æ™®é€šç”¨æˆ·å¯ä»¥ç®¡ç†è‡ªå·±çš„ç³»ç»ŸæœåŠ¡ï¼Œæ— éœ€rootæƒé™ã€‚

> **ğŸ’¡ æ ¸å¿ƒç†è§£**
> ç”¨æˆ·æœåŠ¡ = ä¸ªäººä¸“å±çš„SystemDå®ä¾‹ï¼Œç®¡ç†è‡ªå·±çš„å®¹å™¨æœåŠ¡

**ç”¨æˆ·æœåŠ¡ vs ç³»ç»ŸæœåŠ¡å¯¹æ¯”ï¼š**
```
ç³»ç»ŸæœåŠ¡ï¼š/etc/systemd/system/     (éœ€è¦root)
ç”¨æˆ·æœåŠ¡ï¼š~/.config/systemd/user/  (æ™®é€šç”¨æˆ·)

ç³»ç»ŸæœåŠ¡ï¼šsudo systemctl start service
ç”¨æˆ·æœåŠ¡ï¼šsystemctl --user start service
```

### 5.2 åˆ›å»ºå®¹å™¨æœåŠ¡å•å…ƒ


**ğŸ”¸ ç”ŸæˆæœåŠ¡æ–‡ä»¶ï¼š**
```bash
# Podmanå¯ä»¥è‡ªåŠ¨ç”ŸæˆsystemdæœåŠ¡æ–‡ä»¶
podman create --name webapp -p 8080:80 nginx

# ç”Ÿæˆç”¨æˆ·æœåŠ¡æ–‡ä»¶
podman generate systemd --new --files --name webapp

# æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
ls -la container-webapp.service
```

**ç”Ÿæˆçš„æœåŠ¡æ–‡ä»¶ç¤ºä¾‹ï¼š**
```ini
[Unit]
Description=Podman container-webapp.service
Wants=network-online.target
After=network-online.target
RequiresMountsFor=%t/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStartPre=/bin/rm -f %t/webapp.pid %t/webapp.ctr-id
ExecStart=/usr/bin/podman run --conmon-pidfile %t/webapp.pid --cidfile %t/webapp.ctr-id --cgroups=no-conmon --replace -d --name webapp -p 8080:80 nginx
ExecStop=/usr/bin/podman stop --ignore --cidfile %t/webapp.ctr-id -t 10
ExecStopPost=/usr/bin/podman rm --ignore -f --cidfile %t/webapp.ctr-id
PIDFile=%t/webapp.pid
Type=forking

[Install]
WantedBy=default.target
```

### 5.3 æœåŠ¡ç®¡ç†æ“ä½œ


**ğŸ”§ å®‰è£…å’Œå¯åŠ¨æœåŠ¡ï¼š**
```bash
# åˆ›å»ºç”¨æˆ·systemdç›®å½•
mkdir -p ~/.config/systemd/user

# ç§»åŠ¨æœåŠ¡æ–‡ä»¶
mv container-webapp.service ~/.config/systemd/user/

# é‡æ–°åŠ è½½ç”¨æˆ·æœåŠ¡
systemctl --user daemon-reload

# å¯åŠ¨æœåŠ¡
systemctl --user start container-webapp.service

# è®¾ç½®å¼€æœºå¯åŠ¨
systemctl --user enable container-webapp.service
```

### 5.4 ç”¨æˆ·æœåŠ¡æŒä¹…åŒ–


**å¯ç”¨ç”¨æˆ·æœåŠ¡æŒä¹…åŒ–ï¼š**
```bash
# å…è®¸ç”¨æˆ·æœåŠ¡åœ¨ç”¨æˆ·æœªç™»å½•æ—¶è¿è¡Œ
sudo loginctl enable-linger $USER

# æŸ¥çœ‹lingerçŠ¶æ€
loginctl show-user $USER | grep Linger

# æ£€æŸ¥ç”¨æˆ·æœåŠ¡çŠ¶æ€
systemctl --user status
```

**âš¡ å¿«é€Ÿéƒ¨ç½²è„šæœ¬ï¼š**
```bash
#!/bin/bash
# ä¸€é”®éƒ¨ç½²Podmanå®¹å™¨ä¸ºç”¨æˆ·æœåŠ¡

CONTAINER_NAME=${1:-webapp}
IMAGE=${2:-nginx}
PORT=${3:-8080:80}

echo "éƒ¨ç½²å®¹å™¨æœåŠ¡ï¼š$CONTAINER_NAME"

# åˆ›å»ºå®¹å™¨
podman create --name $CONTAINER_NAME -p $PORT $IMAGE

# ç”ŸæˆæœåŠ¡æ–‡ä»¶
podman generate systemd --new --files --name $CONTAINER_NAME

# å®‰è£…æœåŠ¡
mkdir -p ~/.config/systemd/user
mv container-$CONTAINER_NAME.service ~/.config/systemd/user/

# å¯åŠ¨æœåŠ¡
systemctl --user daemon-reload
systemctl --user enable --now container-$CONTAINER_NAME.service

echo "æœåŠ¡éƒ¨ç½²å®Œæˆï¼"
echo "ç®¡ç†å‘½ä»¤ï¼š"
echo "  æŸ¥çœ‹çŠ¶æ€ï¼šsystemctl --user status container-$CONTAINER_NAME"
echo "  æŸ¥çœ‹æ—¥å¿—ï¼šjournalctl --user -fu container-$CONTAINER_NAME"
```

---

## 6. ğŸ›¡ï¸ æƒé™é™åˆ¶ä¸å®‰å…¨æœºåˆ¶


### 6.1 Rootlesså®‰å…¨æ¨¡å‹


**Rootlesså®¹å™¨çš„å®‰å…¨è¾¹ç•Œï¼š**
```
å®‰å…¨éš”ç¦»å±‚æ¬¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å®¹å™¨åº”ç”¨è¿›ç¨‹        â”‚ â† åº”ç”¨å±‚éš”ç¦»
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å®¹å™¨è¿è¡Œæ—¶ç¯å¢ƒ        â”‚ â† å®¹å™¨è¿è¡Œæ—¶éš”ç¦»
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚   ç”¨æˆ·å‘½åç©ºé—´          â”‚ â† ç”¨æˆ·æƒé™éš”ç¦»
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ™®é€šç”¨æˆ·æƒé™          â”‚ â† ç³»ç»Ÿæƒé™é™åˆ¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 èƒ½åŠ›é™åˆ¶åˆ†æ


**ğŸ”¸ Rootlesså®¹å™¨ä¸èƒ½åšçš„äº‹ï¼š**
- è®¿é—®å…¶ä»–ç”¨æˆ·çš„æ–‡ä»¶
- ä¿®æ”¹ç³»ç»Ÿé…ç½®æ–‡ä»¶
- å®‰è£…ç³»ç»Ÿçº§è½¯ä»¶åŒ…
- ç»‘å®šç‰¹æƒç«¯å£(<1024)
- åŠ è½½å†…æ ¸æ¨¡å—
- è®¿é—®åŸå§‹ç½‘ç»œæ¥å£

**ğŸ”¹ Rootlesså®¹å™¨èƒ½åšçš„äº‹ï¼š**
- åœ¨ç”¨æˆ·å®¶ç›®å½•èŒƒå›´å†…æ“ä½œ
- ä½¿ç”¨ç”¨æˆ·çº§èµ„æº
- è¿è¡Œç”¨æˆ·æƒé™èŒƒå›´å†…çš„ç¨‹åº
- è®¿é—®ç”¨æˆ·æœ‰æƒé™çš„æ–‡ä»¶

### 6.3 å®‰å…¨æœ€ä½³å®è·µ


> **ğŸ”’ å®‰å…¨å»ºè®®**
> å³ä½¿æ˜¯Rootlesså®¹å™¨ï¼Œä¹Ÿè¦éµå¾ªæœ€å°æƒé™åŸåˆ™å’Œæ·±åº¦é˜²å¾¡ç­–ç•¥

**æ¨èå®‰å…¨é…ç½®ï¼š**
```bash
# 1. é™åˆ¶å®¹å™¨èµ„æºä½¿ç”¨
podman run --memory=512m --cpus=1.0 --ulimit nofile=1024:2048 nginx

# 2. ä½¿ç”¨åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
podman run --read-only --tmpfs /tmp nginx

# 3. åˆ é™¤ä¸å¿…è¦çš„èƒ½åŠ›
podman run --cap-drop=ALL nginx

# 4. ä½¿ç”¨éç‰¹æƒç”¨æˆ·è¿è¡Œ
podman run --user 1001:1001 nginx

# 5. é™åˆ¶ç³»ç»Ÿè°ƒç”¨
podman run --security-opt seccomp=/path/to/seccomp.json nginx
```

### 6.4 æƒé™å®¡è®¡å·¥å…·


**ğŸ” æƒé™æ£€æŸ¥å‘½ä»¤ï¼š**
```bash
# æ£€æŸ¥å®¹å™¨è¿è¡Œæƒé™
podman run --rm -it alpine sh -c 'whoami && id'

# æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæƒé™
podman run --rm -v /:/host:ro alpine ls -la /host/etc/passwd

# æ£€æŸ¥ç½‘ç»œæƒé™  
podman run --rm alpine sh -c 'cat /proc/net/tcp'

# æ£€æŸ¥è¿›ç¨‹æƒé™
podman run --rm alpine sh -c 'cat /proc/self/status | grep -i cap'
```

---

## 7. ğŸ’¾ Rootlesså­˜å‚¨é…ç½®


### 7.1 Rootlesså­˜å‚¨æ¶æ„


**Rootlesså­˜å‚¨ç‰¹ç‚¹ï¼š**
```
å­˜å‚¨ä½ç½®ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ~/.local/share/containers/  â”‚ â† ç”¨æˆ·å®¹å™¨æ•°æ®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ~/.config/containers/       â”‚ â† ç”¨æˆ·é…ç½®æ–‡ä»¶
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /tmp/podman-run-uid/        â”‚ â† è¿è¡Œæ—¶æ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¯¹æ¯”ç³»ç»Ÿå­˜å‚¨ï¼š
/var/lib/containers/  (éœ€è¦rootæƒé™)
```

### 7.2 å­˜å‚¨é…ç½®æ–‡ä»¶


**ä¸»è¦é…ç½®æ–‡ä»¶è·¯å¾„ï¼š**
```bash
# å­˜å‚¨é…ç½®
~/.config/containers/storage.conf

# å®¹å™¨é…ç½®
~/.config/containers/containers.conf

# æ³¨å†Œè¡¨é…ç½®
~/.config/containers/registries.conf
```

**storage.confé…ç½®ç¤ºä¾‹ï¼š**
```ini
[storage]
driver = "overlay"
runroot = "/tmp/podman-run-${uid}"
graphroot = "$HOME/.local/share/containers/storage"

[storage.options]
additionalimagestores = [
  "/usr/share/containers/storage"
]

[storage.options.overlay]
mount_program = "/usr/bin/fuse-overlayfs"
mountopt = "nodev,metacopy=on"
```

### 7.3 å­˜å‚¨é©±åŠ¨é€‰æ‹©


| å­˜å‚¨é©±åŠ¨ | **ç‰¹ç‚¹** | **æƒé™éœ€æ±‚** | **æ€§èƒ½** | **æ¨èåº¦** |
|---------|----------|-------------|----------|-----------|
| `overlay` | æ ‡å‡†overlayfs | éœ€è¦fuse-overlayfs | é«˜ | `âœ… æ¨è` |
| `vfs` | ç®€å•ç›®å½•å¤åˆ¶ | æ— ç‰¹æ®Šéœ€æ±‚ | ä½ | `å¼€å‘æµ‹è¯•` |
| `fuse-overlayfs` | ç”¨æˆ·ç©ºé—´overlay | éœ€è¦fuseæ”¯æŒ | ä¸­é«˜ | `å…¼å®¹æ€§å¥½` |

**ğŸ”§ é…ç½®å­˜å‚¨é©±åŠ¨ï¼š**
```bash
# æ£€æŸ¥å½“å‰å­˜å‚¨é…ç½®
podman info | grep -A10 "store:"

# å®‰è£…fuse-overlayfs(Ubuntu/Debian)
sudo apt install fuse-overlayfs

# å®‰è£…fuse-overlayfs(CentOS/RHEL)  
sudo yum install fuse-overlayfs

# é‡ç½®å­˜å‚¨(æ¸…ç©ºæ‰€æœ‰æ•°æ®!)
podman system reset
```

### 7.4 å­˜å‚¨æ¸…ç†ç»´æŠ¤


**ğŸ§¹ å­˜å‚¨ç©ºé—´ç®¡ç†ï¼š**
```bash
# æŸ¥çœ‹å­˜å‚¨ä½¿ç”¨æƒ…å†µ
podman system df

# æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
podman image prune -a

# æ¸…ç†æœªä½¿ç”¨çš„å®¹å™¨
podman container prune

# æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨èµ„æº
podman system prune -a -f

# æŸ¥çœ‹è¯¦ç»†å­˜å‚¨ä¿¡æ¯
du -sh ~/.local/share/containers/
```

**å®šæœŸæ¸…ç†è„šæœ¬ï¼š**
```bash
#!/bin/bash
# Podmanå­˜å‚¨ç©ºé—´å®šæœŸæ¸…ç†

echo "=== Podmanå­˜å‚¨æ¸…ç†å¼€å§‹ ==="

# æ˜¾ç¤ºæ¸…ç†å‰çŠ¶æ€
echo "æ¸…ç†å‰å­˜å‚¨ä½¿ç”¨ï¼š"
podman system df

# æ¸…ç†åœæ­¢çš„å®¹å™¨
echo "æ¸…ç†åœæ­¢çš„å®¹å™¨..."
podman container prune -f

# æ¸…ç†æ‚¬ç©ºé•œåƒ
echo "æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
podman image prune -f

# æ¸…ç†æ„å»ºç¼“å­˜
echo "æ¸…ç†æ„å»ºç¼“å­˜..."
podman builder prune -f

# æ˜¾ç¤ºæ¸…ç†åçŠ¶æ€
echo "æ¸…ç†åå­˜å‚¨ä½¿ç”¨ï¼š"
podman system df

echo "=== å­˜å‚¨æ¸…ç†å®Œæˆ ==="
```

---

## 8. ğŸ”§ å¸¸è§æƒé™é—®é¢˜è§£å†³


### 8.1 å…¸å‹æƒé™é”™è¯¯


**ğŸ”¸ å¸¸è§é”™è¯¯ç±»å‹ï¼š**

**é”™è¯¯1ï¼šsubuid/subgidæœªé…ç½®**
```
é”™è¯¯ä¿¡æ¯ï¼š
ERRO[0000] cannot find UID/GID for user john: No subuid ranges found for user "john"

è§£å†³æ–¹æ¡ˆï¼š
sudo usermod --add-subuids 100000-165535 john
sudo usermod --add-subgids 100000-165535 john
```

**é”™è¯¯2ï¼šç½‘ç»œæƒé™ä¸è¶³**
```
é”™è¯¯ä¿¡æ¯ï¼š
Error: rootlessport cannot expose privileged port 80

è§£å†³æ–¹æ¡ˆï¼š
# æ–¹æ³•1ï¼šä½¿ç”¨é«˜ç«¯å£
podman run -p 8080:80 nginx

# æ–¹æ³•2ï¼šè®¾ç½®capability
sudo setcap cap_net_bind_service=ep /usr/bin/podman
```

**é”™è¯¯3ï¼šæ–‡ä»¶æƒé™æ˜ å°„é—®é¢˜**
```
é”™è¯¯ä¿¡æ¯ï¼š
Permission denied: cannot write to mounted volume

è§£å†³æ–¹æ¡ˆï¼š
# æ£€æŸ¥æ–‡ä»¶æ‰€æœ‰æƒ
ls -la /path/to/volume

# ä¿®æ”¹æ–‡ä»¶æƒé™
chmod 777 /path/to/volume
# æˆ–è€…ä½¿ç”¨:Zé€‰é¡¹
podman run -v /path/to/volume:/data:Z nginx
```

### 8.2 æƒé™é—®é¢˜è¯Šæ–­


**ğŸ” è¯Šæ–­å·¥å…·è„šæœ¬ï¼š**
```bash
#!/bin/bash
# Podman Rootlessæƒé™è¯Šæ–­å·¥å…·

echo "=== Podman Rootlessæƒé™è¯Šæ–­ ==="

# 1. æ£€æŸ¥ç”¨æˆ·æƒé™
echo "1. å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼š"
id
echo

# 2. æ£€æŸ¥subuid/subgidé…ç½®
echo "2. subuidé…ç½®ï¼š"
grep "^$(whoami):" /etc/subuid || echo "æœªé…ç½®subuid"
echo "   subgidé…ç½®ï¼š"
grep "^$(whoami):" /etc/subgid || echo "æœªé…ç½®subgid"
echo

# 3. æ£€æŸ¥podmanå®‰è£…
echo "3. Podmanç‰ˆæœ¬ï¼š"
podman --version
echo

# 4. æ£€æŸ¥å­˜å‚¨é…ç½®
echo "4. å­˜å‚¨é…ç½®ï¼š"
podman info | grep -A5 "store:"
echo

# 5. æ£€æŸ¥ç½‘ç»œé…ç½®
echo "5. ç½‘ç»œåç«¯ï¼š"
podman info | grep -A3 "networkBackend"
echo

# 6. æµ‹è¯•åŸºæœ¬åŠŸèƒ½
echo "6. åŠŸèƒ½æµ‹è¯•ï¼š"
echo "   è¿è¡Œæµ‹è¯•å®¹å™¨..."
if podman run --rm hello-world > /dev/null 2>&1; then
    echo "   âœ… åŸºæœ¬å®¹å™¨è¿è¡Œæ­£å¸¸"
else
    echo "   âŒ å®¹å™¨è¿è¡Œå¤±è´¥"
fi

echo "=== è¯Šæ–­å®Œæˆ ==="
```

### 8.3 SELinuxå…¼å®¹æ€§


**SELinuxç¯å¢ƒä¸‹çš„é…ç½®ï¼š**
```bash
# æ£€æŸ¥SELinuxçŠ¶æ€
sestatus

# è®¾ç½®SELinuxå¸ƒå°”å€¼å…è®¸ç”¨æˆ·å‘½åç©ºé—´
sudo setsebool -P container_use_cgroup_ns 1
sudo setsebool -P virt_use_fusefs 1

# ä¸ºå®¹å™¨å·è®¾ç½®æ­£ç¡®çš„SELinuxä¸Šä¸‹æ–‡
podman run -v /host/path:/container/path:Z nginx
```

### 8.4 é—®é¢˜è§£å†³æµç¨‹å›¾


```
æƒé™é—®é¢˜è§£å†³æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é‡åˆ°æƒé™é—®é¢˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æŸ¥é”™è¯¯ä¿¡æ¯     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è¿è¡Œè¯Šæ–­è„šæœ¬     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ ¹æ®ç±»å‹å¤„ç†ï¼š   â”‚
â”‚ â€¢ subuid/subgidé—®é¢˜ â”‚
â”‚ â€¢ ç½‘ç»œæƒé™é—®é¢˜      â”‚
â”‚ â€¢ æ–‡ä»¶æƒé™é—®é¢˜      â”‚
â”‚ â€¢ SELinuxé—®é¢˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. éªŒè¯ä¿®å¤æ•ˆæœ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ Rootlesså®¹å™¨ï¼šæ™®é€šç”¨æˆ·æƒé™è¿è¡Œçš„å®¹å™¨ï¼Œå®‰å…¨æ€§é«˜
ğŸ”¸ ç”¨æˆ·å‘½åç©ºé—´ï¼šå®ç°UID/GIDæ˜ å°„çš„æ ¸å¿ƒæœºåˆ¶  
ğŸ”¸ subuid/subgidï¼šå®šä¹‰ç”¨æˆ·å¯ç”¨çš„IDèŒƒå›´é…ç½®
ğŸ”¸ å­˜å‚¨éš”ç¦»ï¼šç”¨æˆ·ç‹¬ç«‹çš„å®¹å™¨å­˜å‚¨ç©ºé—´
ğŸ”¸ ç½‘ç»œé™åˆ¶ï¼šæ— æ³•ä½¿ç”¨ç‰¹æƒç«¯å£å’ŒæŸäº›ç½‘ç»œåŠŸèƒ½
ğŸ”¸ SystemDé›†æˆï¼šç”¨æˆ·æœåŠ¡ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸ
```

### 9.2 å…³é”®æ“ä½œè¦ç‚¹


**ğŸ”¹ é…ç½®æ£€æŸ¥æ¸…å•ï¼š**
```
âœ… subuid/subgid å·²æ­£ç¡®é…ç½®
âœ… fuse-overlayfs å·²å®‰è£…
âœ… ç”¨æˆ·å­˜å‚¨ç›®å½•å¯è®¿é—®
âœ… ç½‘ç»œåç«¯æ­£å¸¸å·¥ä½œ
âœ… SystemDç”¨æˆ·æœåŠ¡å¯ç”¨
âœ… SELinuxå…¼å®¹æ€§è®¾ç½®
```

**ğŸ”¹ å¸¸ç”¨å‘½ä»¤è®°å¿†ï¼š**
```
é…ç½®æ£€æŸ¥ï¼špodman info | grep -E "(store|network)"
ç”¨æˆ·æ˜ å°„ï¼šcat /proc/self/uid_map  
æœåŠ¡ç”Ÿæˆï¼špodman generate systemd --new --files
æƒé™è¯Šæ–­ï¼šè¿è¡Œè‡ªå®šä¹‰è¯Šæ–­è„šæœ¬
ç©ºé—´æ¸…ç†ï¼špodman system prune -a
```

### 9.3 æœ€ä½³å®è·µå»ºè®®


**ğŸš€ éƒ¨ç½²å»ºè®®ï¼š**
- **å¼€å‘ç¯å¢ƒ**ï¼šä¼˜å…ˆä½¿ç”¨Rootlessæ¨¡å¼ï¼Œå®‰å…¨ä¾¿æ·
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šæ ¹æ®å®‰å…¨è¦æ±‚é€‰æ‹©ï¼Œè€ƒè™‘æ€§èƒ½å½±å“
- **å¤šç”¨æˆ·ç³»ç»Ÿ**ï¼šå¿…é¡»ä½¿ç”¨Rootlessï¼Œé¿å…æƒé™å†²çª
- **CI/CDç¯å¢ƒ**ï¼šRootlessæä¾›æ›´å¥½çš„éš”ç¦»æ€§

**âš ï¸ æ³¨æ„äº‹é¡¹ï¼š**
- å®šæœŸæ£€æŸ¥subuid/subgidé…ç½®çš„æœ‰æ•ˆæ€§
- ç½‘ç»œç«¯å£é™åˆ¶éœ€è¦æå‰è§„åˆ’
- å­˜å‚¨ç©ºé—´éœ€è¦å®šæœŸæ¸…ç†ç»´æŠ¤
- SELinuxç¯å¢ƒéœ€è¦é¢å¤–é…ç½®

**ğŸ’¡ è®°å¿†è¦ç‚¹ï¼š**
- Rootless = å®‰å…¨ + éš”ç¦» + ç”¨æˆ·å‹å¥½
- æƒé™é—®é¢˜å¤šæ•°ç”±é…ç½®ä¸å½“å¼•èµ·
- ç½‘ç»œåŠŸèƒ½å—é™ä½†æœ‰å¤šç§è§£å†³æ–¹æ¡ˆ
- SystemDé›†æˆè®©å®¹å™¨æœåŠ¡åŒ–ç®¡ç†æ›´ç®€å•

**ğŸ¯ æ ¸å¿ƒç†å¿µ**ï¼š
Rootlesså®¹å™¨ä½“ç°äº†"æœ€å°æƒé™åŸåˆ™"ï¼Œåœ¨ä¿è¯åŠŸèƒ½çš„å‰æä¸‹æœ€å¤§åŒ–å®‰å…¨æ€§ï¼Œæ˜¯ç°ä»£å®¹å™¨å®‰å…¨çš„é‡è¦å‘å±•æ–¹å‘ã€‚