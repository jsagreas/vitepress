---
title: 10ã€Podmanä¸systemdé›†æˆ
---
## ğŸ“š ç›®å½•

1. [Podmanä¸systemdé›†æˆæ¦‚è¿°](#1-podmanä¸systemdé›†æˆæ¦‚è¿°)
2. [systemdæœåŠ¡ç”Ÿæˆä¸é…ç½®](#2-systemdæœåŠ¡ç”Ÿæˆä¸é…ç½®)
3. [å®¹å™¨è‡ªåŠ¨å¯åŠ¨é…ç½®](#3-å®¹å™¨è‡ªåŠ¨å¯åŠ¨é…ç½®)
4. [systemdç”¨æˆ·æœåŠ¡](#4-systemdç”¨æˆ·æœåŠ¡)
5. [æœåŠ¡ä¾èµ–å…³ç³»é…ç½®](#5-æœåŠ¡ä¾èµ–å…³ç³»é…ç½®)
6. [å®¹å™¨å¥åº·æ£€æŸ¥é›†æˆ](#6-å®¹å™¨å¥åº·æ£€æŸ¥é›†æˆ)
7. [æ—¥å¿—é›†æˆç®¡ç†](#7-æ—¥å¿—é›†æˆç®¡ç†)
8. [æœåŠ¡æ•…éšœæ¢å¤æœºåˆ¶](#8-æœåŠ¡æ•…éšœæ¢å¤æœºåˆ¶)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”— Podmanä¸systemdé›†æˆæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯systemdé›†æˆ


**ç®€å•ç†è§£**ï¼šå°±æ˜¯è®©å®¹å™¨åƒç³»ç»ŸæœåŠ¡ä¸€æ ·ç®¡ç†ï¼Œå¼€æœºè‡ªå¯ã€æ•…éšœé‡å¯ã€æ—¥å¿—ç»Ÿä¸€æ”¶é›†ã€‚

```
ä¼ ç»Ÿæ–¹å¼è¿è¡Œå®¹å™¨ï¼š
æ‰‹åŠ¨å¯åŠ¨ â†’ podman run nginx
æ‰‹åŠ¨åœæ­¢ â†’ podman stop nginx
é‡å¯ä¸¢å¤± â†’ ç³»ç»Ÿé‡å¯åå®¹å™¨æ¶ˆå¤±

systemdé›†æˆåï¼š
è‡ªåŠ¨å¯åŠ¨ â†’ systemctl start nginx-container
å¼€æœºè‡ªå¯ â†’ systemctl enable nginx-container  
æ•…éšœæ¢å¤ â†’ å®¹å™¨å´©æºƒè‡ªåŠ¨é‡å¯
æ—¥å¿—ç»Ÿä¸€ â†’ journalctlæŸ¥çœ‹å®¹å™¨æ—¥å¿—
```

### 1.2 é›†æˆçš„æ ¸å¿ƒä¼˜åŠ¿


**ğŸ”¸ ç”Ÿäº§çº§ç®¡ç†**
- **ç»Ÿä¸€ç®¡ç†ç•Œé¢**ï¼šæ‰€æœ‰æœåŠ¡éƒ½ç”¨systemctlå‘½ä»¤
- **å¼€æœºè‡ªå¯åŠ¨**ï¼šç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨å®¹å™¨
- **æ•…éšœè‡ªæ¢å¤**ï¼šå®¹å™¨å¼‚å¸¸é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯
- **ä¾èµ–å…³ç³»**ï¼šå¯ä»¥è®¾ç½®æœåŠ¡é—´çš„å¯åŠ¨é¡ºåº

**ğŸ”¸ ä¼ä¸šçº§ç‰¹æ€§**
- **æ—¥å¿—é›†ä¸­åŒ–**ï¼šå®¹å™¨æ—¥å¿—è‡ªåŠ¨è¿›å…¥systemdæ—¥å¿—ç³»ç»Ÿ
- **èµ„æºé™åˆ¶**ï¼šé€šè¿‡systemdæ§åˆ¶å®¹å™¨èµ„æºä½¿ç”¨
- **å®‰å…¨éš”ç¦»**ï¼šç”¨æˆ·çº§æœåŠ¡é¿å…rootæƒé™è¿è¡Œ
- **ç›‘æ§é›†æˆ**ï¼šä¸ç³»ç»Ÿç›‘æ§å·¥å…·æ— ç¼å¯¹æ¥

### 1.3 å·¥ä½œåŸç†ç®€å›¾


```
ç³»ç»Ÿå¯åŠ¨
    â†“
systemdå¯åŠ¨
    â†“
è¯»å–æœåŠ¡é…ç½®æ–‡ä»¶(.service)
    â†“
æ‰§è¡Œpodmanå‘½ä»¤å¯åŠ¨å®¹å™¨
    â†“
ç›‘æ§å®¹å™¨çŠ¶æ€
    â†“
å®¹å™¨å¼‚å¸¸ â†’ è‡ªåŠ¨é‡å¯
æ—¥å¿—è¾“å‡º â†’ journalctlæ”¶é›†
```

---

## 2. âš™ï¸ systemdæœåŠ¡ç”Ÿæˆä¸é…ç½®


### 2.1 generate systemdå‘½ä»¤è¯¦è§£


**æ ¸å¿ƒå‘½ä»¤**ï¼š`podman generate systemd`

```bash
# åŸºæœ¬è¯­æ³•
podman generate systemd [é€‰é¡¹] å®¹å™¨åç§°æˆ–ID

# å¸¸ç”¨é€‰é¡¹è¯´æ˜
--new          # ç”Ÿæˆæ–°å®¹å™¨çš„æœåŠ¡æ–‡ä»¶ï¼Œè€Œä¸æ˜¯åŸºäºç°æœ‰å®¹å™¨
--files        # å°†æœåŠ¡æ–‡ä»¶å†™å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œä¸æ˜¯è¾“å‡ºåˆ°ç»ˆç«¯
--name         # ä½¿ç”¨å®¹å™¨åç§°ä½œä¸ºæœåŠ¡å
--restart-policy # è®¾ç½®é‡å¯ç­–ç•¥
--time         # è®¾ç½®åœæ­¢å®¹å™¨çš„ç­‰å¾…æ—¶é—´
```

### 2.2 ç”ŸæˆæœåŠ¡æ–‡ä»¶å®ä¾‹


**æ­¥éª¤1ï¼šåˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨**
```bash
# åˆ›å»ºä¸€ä¸ªnginxå®¹å™¨
podman run -d --name web-server \
  -p 8080:80 \
  -v /var/www/html:/usr/share/nginx/html:Z \
  nginx:latest
```

**æ­¥éª¤2ï¼šç”ŸæˆsystemdæœåŠ¡æ–‡ä»¶**
```bash
# ç”ŸæˆæœåŠ¡æ–‡ä»¶åˆ°æ ‡å‡†è¾“å‡º
podman generate systemd --new --name web-server

# ç”ŸæˆæœåŠ¡æ–‡ä»¶åˆ°æ–‡ä»¶ç³»ç»Ÿ
podman generate systemd --new --files --name web-server
```

**ç”Ÿæˆçš„æœåŠ¡æ–‡ä»¶ç¤ºä¾‹**ï¼š
```ini
# container-web-server.service
[Unit]
Description=Podman container-web-server.service
Documentation=man:podman-generate-systemd(1)
Wants=network-online.target
After=network-online.target
RequiresMountsFor=%t/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStartPre=/bin/rm -f %t/%n.ctr-id
ExecStart=/usr/bin/podman run \
  --cidfile=%t/%n.ctr-id \
  --cgroups=no-conmon \
  --rm \
  --sdnotify=conmon \
  --replace \
  --detach \
  --name web-server \
  -p 8080:80 \
  -v /var/www/html:/usr/share/nginx/html:Z \
  nginx:latest
ExecStop=/usr/bin/podman stop --ignore --cidfile=%t/%n.ctr-id
ExecStopPost=/usr/bin/podman rm -f --ignore --cidfile=%t/%n.ctr-id
Type=notify
NotifyAccess=all

[Install]
WantedBy=default.target
```

### 2.3 æœåŠ¡æ–‡ä»¶é…ç½®è§£æ


**ğŸ”§ [Unit]æ®µé…ç½®**
```ini
Description=æœåŠ¡æè¿°ä¿¡æ¯
Wants=network-online.target      # å¼±ä¾èµ–ï¼šç½‘ç»œåœ¨çº¿åå¯åŠ¨
After=network-online.target      # å¯åŠ¨é¡ºåºï¼šç½‘ç»œå°±ç»ªåå¯åŠ¨
RequiresMountsFor=%t/containers  # è¦æ±‚æŒ‚è½½ç‚¹å¯ç”¨
```

**ğŸ”§ [Service]æ®µé…ç½®**
```ini
Type=notify                    # æœåŠ¡ç±»å‹ï¼šæ”¯æŒsystemdé€šçŸ¥
Restart=on-failure            # é‡å¯ç­–ç•¥ï¼šå¤±è´¥æ—¶é‡å¯
TimeoutStopSec=70            # åœæ­¢è¶…æ—¶ï¼š70ç§’åå¼ºåˆ¶ç»ˆæ­¢
NotifyAccess=all             # é€šçŸ¥è®¿é—®ï¼šå…è®¸æ‰€æœ‰è¿›ç¨‹å‘é€é€šçŸ¥
```

**ğŸ”§ [Install]æ®µé…ç½®**
```ini
WantedBy=default.target      # å®‰è£…ç›®æ ‡ï¼šé»˜è®¤ç›®æ ‡å¯åŠ¨æ—¶å¯ç”¨
# ä¹Ÿå¯ä»¥æ˜¯ï¼šmulti-user.targetï¼ˆå¤šç”¨æˆ·æ¨¡å¼ï¼‰
```

---

## 3. ğŸš€ å®¹å™¨è‡ªåŠ¨å¯åŠ¨é…ç½®


### 3.1 å¯ç”¨å®¹å™¨æœåŠ¡


**å®‰è£…å’Œå¯åŠ¨æœåŠ¡**ï¼š
```bash
# å°†æœåŠ¡æ–‡ä»¶å¤åˆ¶åˆ°ç³»ç»Ÿç›®å½•ï¼ˆç³»ç»Ÿçº§æœåŠ¡ï¼‰
sudo cp container-web-server.service /etc/systemd/system/

# æˆ–å¤åˆ¶åˆ°ç”¨æˆ·ç›®å½•ï¼ˆç”¨æˆ·çº§æœåŠ¡ï¼‰
cp container-web-server.service ~/.config/systemd/user/

# é‡æ–°åŠ è½½systemdé…ç½®
systemctl daemon-reload  # ç³»ç»Ÿçº§
systemctl --user daemon-reload  # ç”¨æˆ·çº§

# å¯ç”¨æœåŠ¡ï¼ˆå¼€æœºè‡ªå¯ï¼‰
systemctl enable container-web-server.service

# ç«‹å³å¯åŠ¨æœåŠ¡
systemctl start container-web-server.service
```

### 3.2 æœåŠ¡ç®¡ç†å‘½ä»¤


| æ“ä½œ | **å‘½ä»¤** | **è¯´æ˜** |
|------|---------|----------|
| ğŸŸ¢ **å¯åŠ¨æœåŠ¡** | `systemctl start container-web-server` | `ç«‹å³å¯åŠ¨å®¹å™¨æœåŠ¡` |
| ğŸ”´ **åœæ­¢æœåŠ¡** | `systemctl stop container-web-server` | `åœæ­¢å®¹å™¨æœåŠ¡` |
| ğŸ”„ **é‡å¯æœåŠ¡** | `systemctl restart container-web-server` | `é‡å¯å®¹å™¨æœåŠ¡` |
| âœ… **å¯ç”¨è‡ªå¯** | `systemctl enable container-web-server` | `å¼€æœºè‡ªåŠ¨å¯åŠ¨` |
| âŒ **ç¦ç”¨è‡ªå¯** | `systemctl disable container-web-server` | `å–æ¶ˆå¼€æœºè‡ªå¯` |
| ğŸ“Š **æŸ¥çœ‹çŠ¶æ€** | `systemctl status container-web-server` | `æŸ¥çœ‹æœåŠ¡è¿è¡ŒçŠ¶æ€` |
| ğŸ“‹ **æŸ¥çœ‹æ—¥å¿—** | `journalctl -u container-web-server` | `æŸ¥çœ‹æœåŠ¡æ—¥å¿—` |

### 3.3 éªŒè¯è‡ªåŠ¨å¯åŠ¨


**æµ‹è¯•å¼€æœºè‡ªå¯åŠ¨**ï¼š
```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²å¯ç”¨
systemctl is-enabled container-web-server

# æ£€æŸ¥æœåŠ¡å½“å‰çŠ¶æ€
systemctl is-active container-web-server

# é‡å¯ç³»ç»Ÿæµ‹è¯•ï¼ˆè°¨æ…æ“ä½œï¼‰
sudo reboot

# ç³»ç»Ÿå¯åŠ¨åæ£€æŸ¥å®¹å™¨æ˜¯å¦è‡ªåŠ¨è¿è¡Œ
podman ps
systemctl status container-web-server
```

---

## 4. ğŸ‘¤ systemdç”¨æˆ·æœåŠ¡


### 4.1 ç”¨æˆ·æœåŠ¡vsç³»ç»ŸæœåŠ¡


**ç³»ç»ŸæœåŠ¡ï¼ˆrootçº§åˆ«ï¼‰**ï¼š
```bash
æœåŠ¡æ–‡ä»¶ä½ç½®ï¼š/etc/systemd/system/
ç®¡ç†å‘½ä»¤ï¼šsystemctl <action> service-name
æƒé™è¦æ±‚ï¼šéœ€è¦sudoæƒé™
å¯åŠ¨æ—¶æœºï¼šç³»ç»Ÿå¯åŠ¨æ—¶
é€‚ç”¨åœºæ™¯ï¼šç”Ÿäº§ç¯å¢ƒã€å…±äº«æœåŠ¡
```

**ç”¨æˆ·æœåŠ¡ï¼ˆæ™®é€šç”¨æˆ·ï¼‰**ï¼š
```bash
æœåŠ¡æ–‡ä»¶ä½ç½®ï¼š~/.config/systemd/user/
ç®¡ç†å‘½ä»¤ï¼šsystemctl --user <action> service-name
æƒé™è¦æ±‚ï¼šå½“å‰ç”¨æˆ·æƒé™
å¯åŠ¨æ—¶æœºï¼šç”¨æˆ·ç™»å½•æ—¶
é€‚ç”¨åœºæ™¯ï¼šä¸ªäººå¼€å‘ã€æµ‹è¯•ç¯å¢ƒ
```

### 4.2 é…ç½®ç”¨æˆ·æœåŠ¡


**æ­¥éª¤1ï¼šå‡†å¤‡ç”¨æˆ·æœåŠ¡ç›®å½•**
```bash
# åˆ›å»ºç”¨æˆ·æœåŠ¡ç›®å½•
mkdir -p ~/.config/systemd/user/

# ç”Ÿæˆå¹¶å¤åˆ¶æœåŠ¡æ–‡ä»¶
podman generate systemd --new --files --name web-server
cp container-web-server.service ~/.config/systemd/user/
```

**æ­¥éª¤2ï¼šé…ç½®ç”¨æˆ·çº§æœåŠ¡**
```bash
# é‡æ–°åŠ è½½ç”¨æˆ·æœåŠ¡é…ç½®
systemctl --user daemon-reload

# å¯ç”¨ç”¨æˆ·æœåŠ¡
systemctl --user enable container-web-server.service

# å¯åŠ¨ç”¨æˆ·æœåŠ¡
systemctl --user start container-web-server.service
```

**æ­¥éª¤3ï¼šå¯ç”¨ç”¨æˆ·æœåŠ¡çš„æŒä¹…åŒ–**
```bash
# å¯ç”¨ç”¨æˆ·lingeringï¼ˆé‡è¦ï¼ï¼‰
# è¿™æ ·ç”¨æˆ·æœåŠ¡åœ¨ç”¨æˆ·æœªç™»å½•æ—¶ä¹Ÿèƒ½è¿è¡Œ
sudo loginctl enable-linger $USER

# æ£€æŸ¥lingeringçŠ¶æ€
loginctl show-user $USER
```

### 4.3 ç”¨æˆ·æœåŠ¡çš„ä¼˜åŠ¿


**ğŸ”¸ å®‰å…¨éš”ç¦»**
- ä»¥æ™®é€šç”¨æˆ·èº«ä»½è¿è¡Œï¼Œé™ä½å®‰å…¨é£é™©
- ç”¨æˆ·é—´æœåŠ¡ç›¸äº’éš”ç¦»
- å‡å°‘ç³»ç»Ÿçº§æƒé™éœ€æ±‚

**ğŸ”¸ å¼€å‘å‹å¥½**
- å¼€å‘è€…å¯ä»¥ç‹¬ç«‹ç®¡ç†è‡ªå·±çš„å®¹å™¨æœåŠ¡
- ä¸éœ€è¦ç®¡ç†å‘˜æƒé™
- ä¾¿äºæµ‹è¯•å’Œè°ƒè¯•

---

## 5. ğŸ”— æœåŠ¡ä¾èµ–å…³ç³»é…ç½®


### 5.1 ä¾èµ–å…³ç³»ç±»å‹


**ä¾èµ–å…³ç³»è¯´æ˜**ï¼š
```
Wants=    # å¼±ä¾èµ–ï¼šç›®æ ‡æœåŠ¡å¯åŠ¨å¤±è´¥ä¸å½±å“æœ¬æœåŠ¡
Requires= # å¼ºä¾èµ–ï¼šç›®æ ‡æœåŠ¡å¿…é¡»æˆåŠŸå¯åŠ¨
After=    # é¡ºåºä¾èµ–ï¼šåœ¨ç›®æ ‡æœåŠ¡ä¹‹åå¯åŠ¨
Before=   # é¡ºåºä¾èµ–ï¼šåœ¨ç›®æ ‡æœåŠ¡ä¹‹å‰å¯åŠ¨
```

### 5.2 å¤šå®¹å™¨æœåŠ¡ä¾èµ–ç¤ºä¾‹


**åœºæ™¯**ï¼šWebåº”ç”¨ + æ•°æ®åº“ + Redisç¼“å­˜

**æ•°æ®åº“æœåŠ¡ï¼ˆmysql-db.serviceï¼‰**ï¼š
```ini
[Unit]
Description=MySQL Database Container
After=network-online.target
Wants=network-online.target

[Service]
Restart=on-failure
ExecStart=/usr/bin/podman run --name mysql-db \
  -e MYSQL_ROOT_PASSWORD=secret \
  -v mysql_data:/var/lib/mysql \
  -p 3306:3306 \
  mysql:8.0
ExecStop=/usr/bin/podman stop -t 10 mysql-db
ExecStopPost=/usr/bin/podman rm mysql-db

[Install]
WantedBy=default.target
```

**RedisæœåŠ¡ï¼ˆredis-cache.serviceï¼‰**ï¼š
```ini
[Unit]
Description=Redis Cache Container
After=network-online.target
Wants=network-online.target

[Service]
Restart=on-failure
ExecStart=/usr/bin/podman run --name redis-cache \
  -v redis_data:/data \
  -p 6379:6379 \
  redis:latest
ExecStop=/usr/bin/podman stop redis-cache
ExecStopPost=/usr/bin/podman rm redis-cache

[Install]
WantedBy=default.target
```

**Webåº”ç”¨æœåŠ¡ï¼ˆweb-app.serviceï¼‰**ï¼š
```ini
[Unit]
Description=Web Application Container
# å¼ºä¾èµ–ï¼šæ•°æ®åº“å’ŒRediså¿…é¡»å…ˆå¯åŠ¨æˆåŠŸ
Requires=mysql-db.service redis-cache.service
# å¯åŠ¨é¡ºåºï¼šåœ¨æ•°æ®åº“å’ŒRedisä¹‹åå¯åŠ¨
After=mysql-db.service redis-cache.service network-online.target
Wants=network-online.target

[Service]
Restart=on-failure
ExecStart=/usr/bin/podman run --name web-app \
  -e DB_HOST=localhost \
  -e REDIS_HOST=localhost \
  -p 8080:80 \
  my-web-app:latest
ExecStop=/usr/bin/podman stop web-app
ExecStopPost=/usr/bin/podman rm web-app

[Install]
WantedBy=default.target
```

### 5.3 ä¾èµ–å…³ç³»æœ€ä½³å®è·µ


**ğŸ¯ è®¾è®¡åŸåˆ™**
- **æœ€å°ä¾èµ–**ï¼šåªå£°æ˜å¿…éœ€çš„ä¾èµ–å…³ç³»
- **åˆç†é¡ºåº**ï¼šåŸºç¡€æœåŠ¡å…ˆå¯åŠ¨ï¼Œåº”ç”¨æœåŠ¡åå¯åŠ¨
- **å¤±è´¥éš”ç¦»**ï¼šä½¿ç”¨Wantsè€Œä¸æ˜¯Requiresï¼Œé¿å…è¿é”æ•…éšœ

**å¯åŠ¨é¡ºåºç¤ºä¾‹**ï¼š
```
1. network-online.target    # ç½‘ç»œå°±ç»ª
2. mysql-db.service        # æ•°æ®åº“å¯åŠ¨
3. redis-cache.service     # ç¼“å­˜å¯åŠ¨
4. web-app.service         # Webåº”ç”¨å¯åŠ¨
```

---

## 6. â¤ï¸ å®¹å™¨å¥åº·æ£€æŸ¥é›†æˆ


### 6.1 Podmanå¥åº·æ£€æŸ¥é…ç½®


**åœ¨å®¹å™¨ä¸­é…ç½®å¥åº·æ£€æŸ¥**ï¼š
```bash
# åˆ›å»ºå¸¦å¥åº·æ£€æŸ¥çš„nginxå®¹å™¨
podman run -d --name web-server \
  --health-cmd="curl -f http://localhost:80/ || exit 1" \
  --health-interval=30s \
  --health-retries=3 \
  --health-start-period=1m \
  --health-timeout=10s \
  -p 8080:80 \
  nginx:latest
```

**å¥åº·æ£€æŸ¥å‚æ•°è¯´æ˜**ï¼š
```
--health-cmd         # å¥åº·æ£€æŸ¥å‘½ä»¤
--health-interval    # æ£€æŸ¥é—´éš”æ—¶é—´
--health-retries     # è¿ç»­å¤±è´¥æ¬¡æ•°é˜ˆå€¼
--health-start-period # å®¹å™¨å¯åŠ¨åçš„å®½é™æœŸ
--health-timeout     # å•æ¬¡æ£€æŸ¥è¶…æ—¶æ—¶é—´
```

### 6.2 systemdæœåŠ¡å¥åº·æ£€æŸ¥é›†æˆ


**å¢å¼ºçš„æœåŠ¡æ–‡ä»¶é…ç½®**ï¼š
```ini
[Unit]
Description=Web Server with Health Check
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
Restart=on-failure
RestartSec=10
# å¥åº·æ£€æŸ¥å¤±è´¥æ—¶çš„é‡å¯ç­–ç•¥
# on-failure: åªæœ‰åœ¨éæ­£å¸¸é€€å‡ºæ—¶é‡å¯
# always: æ— è®ºå¦‚ä½•éƒ½é‡å¯

ExecStart=/usr/bin/podman run \
  --name web-server \
  --health-cmd="curl -f http://localhost:80/ || exit 1" \
  --health-interval=30s \
  --health-retries=3 \
  --health-start-period=1m \
  --health-timeout=10s \
  -p 8080:80 \
  nginx:latest

ExecStop=/usr/bin/podman stop -t 10 web-server
ExecStopPost=/usr/bin/podman rm web-server

# ç›‘æ§è„šæœ¬ï¼ˆå¯é€‰ï¼‰
ExecReload=/bin/bash -c 'podman healthcheck run web-server'

[Install]
WantedBy=default.target
```

### 6.3 è‡ªå®šä¹‰å¥åº·æ£€æŸ¥è„šæœ¬


**å¤æ‚åº”ç”¨çš„å¥åº·æ£€æŸ¥è„šæœ¬**ï¼š
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/usr/local/bin/app-health-check.sh

# æ£€æŸ¥HTTPæœåŠ¡
if ! curl -f http://localhost:8080/health > /dev/null 2>&1; then
    echo "HTTP health check failed"
    exit 1
fi

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
if ! podman exec web-app mysql -h localhost -u app -p$DB_PASS -e "SELECT 1" > /dev/null 2>&1; then
    echo "Database connection failed"
    exit 1
fi

# æ£€æŸ¥å…³é”®è¿›ç¨‹
if ! podman exec web-app pgrep -f "nginx: master process" > /dev/null; then
    echo "Nginx master process not found"
    exit 1
fi

echo "All health checks passed"
exit 0
```

**åœ¨å®¹å™¨ä¸­ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬**ï¼š
```bash
podman run -d --name web-app \
  --health-cmd="/usr/local/bin/app-health-check.sh" \
  --health-interval=60s \
  -v /usr/local/bin/app-health-check.sh:/usr/local/bin/app-health-check.sh:ro \
  my-web-app:latest
```

---

## 7. ğŸ“Š æ—¥å¿—é›†æˆç®¡ç†


### 7.1 systemdæ—¥å¿—ç³»ç»Ÿæ¦‚è¿°


**ä»€ä¹ˆæ˜¯journalctl**ï¼šsystemdçš„æ—¥å¿—ç®¡ç†å·¥å…·ï¼Œå¯ä»¥ç»Ÿä¸€æ”¶é›†å’ŒæŸ¥çœ‹ç³»ç»ŸåŠæœåŠ¡æ—¥å¿—ã€‚

**Podmanä¸journalctlé›†æˆ**ï¼š
```
å®¹å™¨æ ‡å‡†è¾“å‡º/é”™è¯¯è¾“å‡º
        â†“
    systemdæœåŠ¡
        â†“
    journaldå®ˆæŠ¤è¿›ç¨‹
        â†“
    journalctlå‘½ä»¤æŸ¥çœ‹
```

### 7.2 å®¹å™¨æ—¥å¿—æŸ¥çœ‹å‘½ä»¤


**åŸºæœ¬æ—¥å¿—æŸ¥çœ‹**ï¼š
```bash
# æŸ¥çœ‹æœåŠ¡çš„æ‰€æœ‰æ—¥å¿—
journalctl -u container-web-server

# å®æ—¶è·Ÿè¸ªæ—¥å¿—ï¼ˆç±»ä¼¼tail -fï¼‰
journalctl -u container-web-server -f

# æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—æ¡ç›®
journalctl -u container-web-server -n 50

# æŸ¥çœ‹ç‰¹å®šæ—¶é—´èŒƒå›´çš„æ—¥å¿—
journalctl -u container-web-server --since "2024-01-01" --until "2024-01-02"

# æŸ¥çœ‹ä»Šå¤©çš„æ—¥å¿—
journalctl -u container-web-server --since today

# æŸ¥çœ‹æœ€è¿‘1å°æ—¶çš„æ—¥å¿—
journalctl -u container-web-server --since "1 hour ago"
```

### 7.3 æ—¥å¿—æ ¼å¼é…ç½®


**æœåŠ¡æ–‡ä»¶ä¸­çš„æ—¥å¿—é…ç½®**ï¼š
```ini
[Service]
# æ ‡å‡†è¾“å‡ºåˆ°journal
StandardOutput=journal
StandardError=journal

# æ—¥å¿—çº§åˆ«è®¾ç½®
SyslogLevel=info
SyslogIdentifier=web-server-container

# æ—¥å¿—æ ‡ç­¾
Environment=CONTAINER_LOG_LEVEL=info
```

**å®¹å™¨å†…åº”ç”¨æ—¥å¿—é…ç½®**ï¼š
```bash
# å°†åº”ç”¨æ—¥å¿—è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼Œç”±systemdæ”¶é›†
podman run -d --name web-server \
  --log-driver=journald \
  --log-opt tag="web-server" \
  -p 8080:80 \
  nginx:latest
```

### 7.4 æ—¥å¿—åˆ†æå’Œè¿‡æ»¤


**å¸¸ç”¨æ—¥å¿—è¿‡æ»¤æŠ€å·§**ï¼š
```bash
# åªæŸ¥çœ‹é”™è¯¯çº§åˆ«æ—¥å¿—
journalctl -u container-web-server -p err

# æœç´¢åŒ…å«ç‰¹å®šå…³é”®è¯çš„æ—¥å¿—
journalctl -u container-web-server | grep "ERROR"

# æŸ¥çœ‹æ—¥å¿—ç»Ÿè®¡ä¿¡æ¯
journalctl -u container-web-server --disk-usage

# å¯¼å‡ºæ—¥å¿—åˆ°æ–‡ä»¶
journalctl -u container-web-server > /tmp/container.log

# JSONæ ¼å¼è¾“å‡ºï¼ˆä¾¿äºç¨‹åºå¤„ç†ï¼‰
journalctl -u container-web-server -o json
```

**æ—¥å¿—è½®è½¬å’Œæ¸…ç†**ï¼š
```bash
# æŸ¥çœ‹journalä½¿ç”¨çš„ç£ç›˜ç©ºé—´
journalctl --disk-usage

# æ¸…ç†è¶…è¿‡æŒ‡å®šæ—¶é—´çš„æ—¥å¿—
sudo journalctl --vacuum-time=7d

# é™åˆ¶journalæ–‡ä»¶å¤§å°
sudo journalctl --vacuum-size=500M

# é…ç½®æ°¸ä¹…çš„æ—¥å¿—ä¿ç•™ç­–ç•¥ï¼ˆç¼–è¾‘é…ç½®æ–‡ä»¶ï¼‰
sudo nano /etc/systemd/journald.conf
```

---

## 8. ğŸ”„ æœåŠ¡æ•…éšœæ¢å¤æœºåˆ¶


### 8.1 é‡å¯ç­–ç•¥é…ç½®


**é‡å¯ç­–ç•¥é€‰é¡¹**ï¼š
```ini
# æœåŠ¡æ–‡ä»¶ä¸­çš„é‡å¯é…ç½®
[Service]
Restart=on-failure     # åªåœ¨éæ­£å¸¸é€€å‡ºæ—¶é‡å¯
# Restart=always       # æ€»æ˜¯é‡å¯ï¼ˆåŒ…æ‹¬æ­£å¸¸é€€å‡ºï¼‰
# Restart=on-success   # åªåœ¨æˆåŠŸé€€å‡ºåé‡å¯
# Restart=on-abnormal  # åœ¨å¼‚å¸¸ä¿¡å·æˆ–è¶…æ—¶æ—¶é‡å¯
# Restart=no           # ä»ä¸é‡å¯

RestartSec=10          # é‡å¯å‰ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰
StartLimitBurst=5      # åœ¨æŒ‡å®šæ—¶é—´å†…æœ€å¤šé‡å¯æ¬¡æ•°
StartLimitIntervalSec=60  # é‡å¯è®¡æ•°æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
```

### 8.2 æ•…éšœæ£€æµ‹å’Œå¤„ç†


**å®Œæ•´çš„æ•…éšœæ¢å¤é…ç½®ç¤ºä¾‹**ï¼š
```ini
[Unit]
Description=Resilient Web Server Container
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
Restart=on-failure
RestartSec=15
StartLimitBurst=3
StartLimitIntervalSec=300

# å¯åŠ¨å‰æ¸…ç†
ExecStartPre=/bin/bash -c 'podman rm -f web-server || true'

# å¯åŠ¨å®¹å™¨
ExecStart=/usr/bin/podman run \
  --name web-server \
  --health-cmd="curl -f http://localhost:80/ || exit 1" \
  --health-interval=30s \
  --health-retries=3 \
  -p 8080:80 \
  nginx:latest

# æ­£å¸¸åœæ­¢
ExecStop=/usr/bin/podman stop -t 30 web-server

# åœæ­¢åæ¸…ç†
ExecStopPost=/usr/bin/podman rm -f web-server

# é‡æ–°åŠ è½½é…ç½®
ExecReload=/usr/bin/podman kill -s HUP web-server

# è¶…æ—¶è®¾ç½®
TimeoutStartSec=120
TimeoutStopSec=60

[Install]
WantedBy=default.target
```

### 8.3 ç›‘æ§å’Œå‘Šè­¦é›†æˆ


**ç®€å•çš„ç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/usr/local/bin/container-monitor.sh

CONTAINER_SERVICE="container-web-server"
LOG_FILE="/var/log/container-monitor.log"

while true; do
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if ! systemctl is-active --quiet $CONTAINER_SERVICE; then
        echo "$(date): $CONTAINER_SERVICE is not active" >> $LOG_FILE
        
        # å‘é€å‘Šè­¦é‚®ä»¶ï¼ˆéœ€è¦é…ç½®é‚®ä»¶ç³»ç»Ÿï¼‰
        echo "Container service $CONTAINER_SERVICE is down" | \
        mail -s "Container Alert" admin@example.com
        
        # å°è¯•é‡å¯æœåŠ¡
        systemctl restart $CONTAINER_SERVICE
    fi
    
    # æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€
    if podman healthcheck run web-server 2>/dev/null | grep -q "unhealthy"; then
        echo "$(date): Container health check failed" >> $LOG_FILE
        systemctl restart $CONTAINER_SERVICE
    fi
    
    sleep 60
done
```

**å°†ç›‘æ§è„šæœ¬è®¾ç½®ä¸ºsystemdæœåŠ¡**ï¼š
```ini
# /etc/systemd/system/container-monitor.service
[Unit]
Description=Container Monitor Service
After=multi-user.target

[Service]
Type=simple
ExecStart=/usr/local/bin/container-monitor.sh
Restart=always
RestartSec=10
User=monitor

[Install]
WantedBy=multi-user.target
```

### 8.4 æ•…éšœæ’æŸ¥æ­¥éª¤


**ç³»ç»ŸåŒ–æ•…éšœæ’æŸ¥æµç¨‹**ï¼š

1ï¸âƒ£ **æ£€æŸ¥æœåŠ¡çŠ¶æ€**
```bash
systemctl status container-web-server
```

2ï¸âƒ£ **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**
```bash
journalctl -u container-web-server -f
```

3ï¸âƒ£ **æ£€æŸ¥å®¹å™¨çŠ¶æ€**
```bash
podman ps -a
podman logs web-server
```

4ï¸âƒ£ **æ£€æŸ¥ç³»ç»Ÿèµ„æº**
```bash
podman stats web-server  # èµ„æºä½¿ç”¨æƒ…å†µ
df -h                     # ç£ç›˜ç©ºé—´
free -h                   # å†…å­˜ä½¿ç”¨
```

5ï¸âƒ£ **æ£€æŸ¥ç½‘ç»œè¿æ¥**
```bash
podman port web-server    # ç«¯å£æ˜ å°„
ss -tulpn | grep :8080   # ç«¯å£ç›‘å¬çŠ¶æ€
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ systemdé›†æˆæœ¬è´¨ï¼šè®©å®¹å™¨åƒç³»ç»ŸæœåŠ¡ä¸€æ ·è¢«ç®¡ç†
ğŸ”¸ æœåŠ¡æ–‡ä»¶ç”Ÿæˆï¼špodman generate systemd --new --files
ğŸ”¸ ç”¨æˆ·æœåŠ¡é…ç½®ï¼š~/.config/systemd/user/ ç›®å½•ä¸‹ç®¡ç†
ğŸ”¸ ä¾èµ–å…³ç³»è®¾è®¡ï¼šWantså¼±ä¾èµ–ï¼ŒRequireså¼ºä¾èµ–ï¼ŒAfteræ§åˆ¶é¡ºåº
ğŸ”¸ å¥åº·æ£€æŸ¥é›†æˆï¼šå®¹å™¨å†…å¥åº·æ£€æŸ¥ + systemdé‡å¯ç­–ç•¥
ğŸ”¸ æ—¥å¿—ç»Ÿä¸€ç®¡ç†ï¼šjournalctlæŸ¥çœ‹å®¹å™¨æ—¥å¿—
ğŸ”¸ æ•…éšœè‡ªåŠ¨æ¢å¤ï¼šRestart=on-failure + é‡å¯é™åˆ¶
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦systemdé›†æˆ**
```
ç”Ÿäº§ç¯å¢ƒéœ€æ±‚ï¼š
- å®¹å™¨å¿…é¡»èƒ½å¼€æœºè‡ªå¯
- æ•…éšœæ—¶èƒ½è‡ªåŠ¨æ¢å¤
- æ—¥å¿—éœ€è¦ç»Ÿä¸€ç®¡ç†
- æœåŠ¡é—´éœ€è¦åè°ƒå¯åŠ¨

systemdä¼˜åŠ¿ï¼š
- ç»Ÿä¸€çš„æœåŠ¡ç®¡ç†ç•Œé¢
- æˆç†Ÿçš„ä¾èµ–å…³ç³»å¤„ç†
- å®Œå–„çš„æ—¥å¿—è®°å½•ç³»ç»Ÿ
- çµæ´»çš„é‡å¯å’Œæ¢å¤ç­–ç•¥
```

**ğŸ”¹ ç”¨æˆ·æœåŠ¡vsç³»ç»ŸæœåŠ¡çš„é€‰æ‹©**
```
ç”¨æˆ·æœåŠ¡é€‚åˆï¼š
âœ… å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ
âœ… ä¸ªäººé¡¹ç›®
âœ… ä¸éœ€è¦rootæƒé™çš„åº”ç”¨
âœ… ç”¨æˆ·ç™»å½•åæ‰éœ€è¦çš„æœåŠ¡

ç³»ç»ŸæœåŠ¡é€‚åˆï¼š
âœ… ç”Ÿäº§ç¯å¢ƒ
âœ… å…±äº«æœåŠ¡
âœ… éœ€è¦ç³»ç»Ÿçº§æƒé™çš„åº”ç”¨
âœ… ç³»ç»Ÿå¯åŠ¨æ—¶å°±éœ€è¦çš„æœåŠ¡
```

**ğŸ”¹ ä¾èµ–å…³ç³»è®¾è®¡åŸåˆ™**
```
è®¾è®¡æ€è·¯ï¼š
- åŸºç¡€æœåŠ¡ï¼ˆæ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼‰å…ˆå¯åŠ¨
- åº”ç”¨æœåŠ¡åå¯åŠ¨
- ä½¿ç”¨Wantsè€ŒéRequiresé¿å…è¿é”æ•…éšœ
- Afteræ§åˆ¶å¯åŠ¨é¡ºåºï¼Œä½†ä¸å¼ºåˆ¶æˆåŠŸ
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**
- **å®¹å™¨å³æœåŠ¡**ï¼šå®¹å™¨ä»¥æœåŠ¡å½¢å¼éƒ¨ç½²å’Œç®¡ç†
- **è¿ç»´æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„å¯åŠ¨ã€åœæ­¢ã€é‡å¯æ“ä½œ
- **æ•…éšœå¤„ç†**ï¼šè‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤æœºåˆ¶
- **ç›‘æ§é›†æˆ**ï¼šä¸ä¼ä¸šç›‘æ§ç³»ç»Ÿæ— ç¼å¯¹æ¥

**ğŸ”§ æ—¥å¸¸è¿ç»´æ“ä½œ**
- **æœåŠ¡ç®¡ç†**ï¼š`systemctl start/stop/restart/status`
- **å¼€æœºé…ç½®**ï¼š`systemctl enable/disable`
- **æ—¥å¿—æŸ¥çœ‹**ï¼š`journalctl -u service-name`
- **å¥åº·æ£€æŸ¥**ï¼š`podman healthcheck run container-name`

**ğŸ“Š æœ€ä½³å®è·µå»ºè®®**
- **æœåŠ¡å‘½å**ï¼šä½¿ç”¨æè¿°æ€§çš„æœåŠ¡åç§°
- **èµ„æºé™åˆ¶**ï¼šé€šè¿‡systemdè®¾ç½®å†…å­˜å’ŒCPUé™åˆ¶
- **æ—¥å¿—ç®¡ç†**ï¼šé…ç½®åˆç†çš„æ—¥å¿—è½®è½¬ç­–ç•¥
- **ç›‘æ§å‘Šè­¦**ï¼šé›†æˆå¤–éƒ¨ç›‘æ§ç³»ç»Ÿ
- **å¤‡ä»½ç­–ç•¥**ï¼šå®šæœŸå¤‡ä»½æœåŠ¡é…ç½®æ–‡ä»¶

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- systemdè®©å®¹å™¨å˜æˆçœŸæ­£çš„ç³»ç»ŸæœåŠ¡
- generate systemdå‘½ä»¤æ˜¯é›†æˆçš„èµ·ç‚¹
- ç”¨æˆ·æœåŠ¡é™ä½æƒé™é£é™©ï¼Œç³»ç»ŸæœåŠ¡æä¾›å…¨å±€æœåŠ¡
- ä¾èµ–å…³ç³»ç¡®ä¿æœåŠ¡æŒ‰æ­£ç¡®é¡ºåºå¯åŠ¨
- å¥åº·æ£€æŸ¥+é‡å¯ç­–ç•¥å®ç°è‡ªåŠ¨æ•…éšœæ¢å¤
- journalctlç»Ÿä¸€æŸ¥çœ‹å’Œç®¡ç†æ—¥å¿—