---
title: 16、全局命令与批处理
---
## 📚 目录

1. [全局命令基础概念](#1-全局命令基础概念)
2. [基本全局命令语法](#2-基本全局命令语法)
3. [反向全局命令](#3-反向全局命令)
4. [常用全局命令操作](#4-常用全局命令操作)
5. [复合全局命令](#5-复合全局命令)
6. [实际应用场景](#6-实际应用场景)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🎯 全局命令基础概念


### 1.1 什么是全局命令


**📝 核心定义**
```
全局命令：在vi/vim编辑器中对整个文件进行批量操作的强大功能
原理：先找到匹配特定模式的所有行，然后对这些行执行指定的命令
格式：:g/pattern/command
```

**💡 通俗理解**
想象你有一本厚厚的电话簿，你想要：
- 删除所有姓"张"的人的信息
- 把所有手机号改成统一格式
- 显示所有北京地址的条目

全局命令就像一个超级助手，能一次性帮你处理整本书中符合条件的所有内容，而不需要你一页一页地翻找。

### 1.2 全局命令的工作原理


**🔄 执行流程图**
```
1. 扫描整个文件
   ↓
2. 找出所有匹配pattern的行
   ↓ 
3. 标记这些行
   ↓
4. 依次对每个标记的行执行command
   ↓
5. 完成批量处理
```

**⚡ 关键特点**
- **🟢简单**: 一条命令处理多行数据
- **🟢高效**: 避免重复的手动操作  
- **🟢精确**: 只处理符合条件的行
- **🟢安全**: 可以先预览再执行

---

## 2. 📋 基本全局命令语法


### 2.1 标准语法格式


**🔸 基本结构**
```bash
:g/pattern/command
```

**📊 语法解析表**

| 组成部分 | **含义** | **说明** | **示例** |
|---------|---------|---------|---------|
| `:g` | `全局命令标识` | `告诉vim这是全局操作` | `固定写法` |
| `/pattern/` | `匹配模式` | `指定要查找的内容` | `/hello/` `/^#/` |
| `command` | `执行命令` | `对匹配行要做的操作` | `d` `p` `s//` |

### 2.2 pattern模式详解


**🎯 常用模式类型**

**简单文本匹配**
```bash
:g/error/d          # 删除包含"error"的行
:g/TODO/p           # 显示包含"TODO"的行
```

**正则表达式匹配**
```bash
:g/^$/d             # 删除空行（^表示行首，$表示行尾）
:g/^#/d             # 删除以#开头的注释行
:g/[0-9]\{3\}/p     # 显示包含3位数字的行
```

**⭐ 常用模式速查**

| 模式 | **含义** | **实际用途** |
|------|---------|-------------|
| `^` | `行首` | `匹配行开头的内容` |
| `$` | `行尾` | `匹配行结尾的内容` |
| `^$` | `空行` | `处理空白行` |
| `.*` | `任意字符` | `匹配包含某词的整行` |
| `[0-9]` | `数字` | `处理包含数字的行` |

### 2.3 command命令详解


**📝 基础命令类型**

| 命令 | **作用** | **完整示例** | **结果** |
|------|---------|-------------|---------|
| `d` | `删除行` | `:g/debug/d` | `删除包含debug的所有行` |
| `p` | `打印行` | `:g/error/p` | `显示包含error的所有行` |
| `m地址` | `移动行` | `:g/TODO/m$` | `把TODO行移动到文件末尾` |
| `s///` | `替换` | `:g/old/s//new/g` | `在匹配行中替换内容` |

---

## 3. 🔄 反向全局命令


### 3.1 反向命令基础


**🔸 基本概念**
```bash
:v/pattern/command
# 等同于
:g!/pattern/command
```

**💡 通俗解释**
- `:g`是"对匹配的行执行操作"
- `:v`是"对不匹配的行执行操作"

就像筛子一样：
- `:g`留下匹配的，处理留下的
- `:v`留下不匹配的，处理留下的

### 3.2 反向命令实例


**📋 对比示例**

```bash
# 有一个日志文件，内容如下：
2023-09-18 INFO: 系统启动
2023-09-18 ERROR: 连接失败  
2023-09-18 INFO: 用户登录
2023-09-18 DEBUG: 调试信息
2023-09-18 ERROR: 数据库错误
```

**正向vs反向对比**
```bash
:g/ERROR/d          # 删除包含ERROR的行
                    # 结果：只剩INFO和DEBUG行

:v/ERROR/d          # 删除不包含ERROR的行  
                    # 结果：只剩ERROR行
```

**⚠️ 实用技巧**
```bash
:v/^$/d             # 删除所有非空行（保留空行）
:v/^#/d             # 删除所有非注释行（保留注释）
:v/important/d      # 删除不包含"important"的行
```

---

## 4. ⚙️ 常用全局命令操作


### 4.1 删除匹配行操作


**🗑️ 删除命令详解**

**基础删除**
```bash
:g/pattern/d        # 删除匹配pattern的所有行
```

**实战示例**
```bash
:g/^$/d             # 🔥 删除所有空行（超常用！）
:g/debug/d          # 删除包含debug的行
:g/^#/d             # 删除所有注释行（以#开头）
:g/TODO/d           # 删除所有待办事项行
:g/^\s*$/d          # 删除空行和只有空格的行
```

**💯 最佳实践**
```bash
# 删除前先预览
:g/pattern/p        # 先看看匹配了哪些行
:g/pattern/d        # 确认无误后再删除
```

### 4.2 显示匹配行操作


**👁️ 显示命令详解**

**基础显示**
```bash
:g/pattern/p        # 显示匹配的行
:g/pattern/nu       # 显示匹配的行及行号
```

**📊 实际应用场景**
```bash
:g/error/p          # 快速查看所有错误信息
:g/function/nu      # 查看所有函数定义及行号
:g/TODO/p           # 检查所有未完成任务
:g/^import/p        # 查看所有import语句
```

### 4.3 移动匹配行操作


**📦 移动命令详解**

**语法格式**
```bash
:g/pattern/m 目标位置
```

**常用目标位置**
- `0` - 文件开头
- `$` - 文件结尾  
- `数字` - 指定行号

**实战应用**
```bash
:g/import/m 0       # 把所有import语句移到文件开头
:g/TODO/m $         # 把所有TODO项移到文件末尾
:g/function/m 10    # 把所有函数定义移到第10行后
```

### 4.4 替换操作


**🔄 在匹配行中替换**

**基础语法**
```bash
:g/pattern/s/old/new/选项
```

**实用示例**
```bash
:g/debug/s/debug/info/g     # 在包含debug的行中，把所有debug改为info
:g/TODO/s/$/  - 已完成/     # 在TODO行末尾添加"已完成"
:g/^#/s/#/\/\//             # 把#注释改为//注释
```

---

## 5. 🧩 复合全局命令


### 5.1 多个全局命令组合


**🔗 连续执行多个命令**

**基本方式**
```bash
:g/pattern/command1 | command2 | command3
```

**实际示例**
```bash
# 找到包含error的行，复制后粘贴到文件末尾
:g/error/y | $put

# 在匹配行进行多重替换
:g/old/s/old/new/g | s/foo/bar/g
```

### 5.2 嵌套全局命令


**🎯 高级用法**
```bash
# 在匹配的行中再次进行全局操作
:g/class/g/function/p       # 在包含"class"的行中找包含"function"的
```

### 5.3 全局命令与地址范围结合


**📍 限定范围的全局命令**
```bash
:1,100g/pattern/d           # 只在1-100行范围内执行全局删除
:10,$g/TODO/m 5             # 从第10行到末尾，把TODO项移到第5行
```

---

## 6. 🚀 实际应用场景


### 6.1 代码清理场景


**🧹 清理调试代码**
```bash
# 删除所有console.log调试语句
:g/console\.log/d

# 删除所有print调试语句  
:g/print(/d

# 删除临时注释
:g/\/\/ TODO:/d
```

### 6.2 日志文件处理


**📊 日志分析场景**

**提取错误日志**
```bash
:g/ERROR/w errors.log       # 把错误行写入新文件
:v/ERROR\|WARN/d            # 只保留错误和警告信息
```

**按时间过滤**
```bash
:g/2023-09-18/p             # 显示特定日期的日志
:g/^2023-09-1[89]/d         # 删除18、19日的日志
```

### 6.3 配置文件处理


**⚙️ 配置管理场景**

**处理配置注释**
```bash
:g/^#/d                     # 删除所有注释行
:g/^$/d                     # 删除所有空行
:g/^#/s/^#\s*//             # 去掉注释符号（取消注释）
```

**批量修改配置**
```bash
:g/port.*80/s/80/8080/      # 把端口从80改为8080
:g/localhost/s//127.0.0.1/g # 把localhost改为IP地址
```

### 6.4 数据整理场景


**📋 文本数据清理**

**格式统一**
```bash
:g/^\s\+/s///               # 删除行首空格
:g/\s\+$/s///               # 删除行尾空格
:g/,\s*/s//, /g             # 统一逗号后的空格格式
```

**内容提取**
```bash
:g/email:/y | $put          # 提取所有邮箱行到文件末尾
:g/@/s/.*\(@.*\)/\1/        # 只保留@后面的域名部分
```

### 6.5 文档处理场景


**📝 文档编辑任务**

**标题处理**
```bash
:g/^# /s/^# /## /           # 把一级标题改为二级标题
:g/^[0-9]\+\./s//•/         # 把数字序号改为圆点
```

**内容重组**
```bash
:g/^TODO:/m $               # 把所有待办事项移到文末
:g/^注意:/s/$/【重要】/      # 在注意事项后添加标记
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的基本概念


```
🔸 全局命令：:g/pattern/command，对匹配行批量操作
🔸 反向命令：:v/pattern/command，对不匹配行操作  
🔸 核心组成：模式匹配 + 命令执行
🔸 工作原理：先找到目标行，再批量处理
🔸 安全原则：先预览(:g/pattern/p)再操作
```

### 7.2 关键操作技巧


**🔹 常用命令组合**
```
删除操作：:g/pattern/d
显示操作：:g/pattern/p  
移动操作：:g/pattern/m地址
替换操作：:g/pattern/s/old/new/g
复制操作：:g/pattern/y
```

**🔹 实用模式**
```
^$     - 空行
^#     - 注释行（#开头）  
^\s*$  - 空行或只有空格的行
^import- import语句
[0-9]  - 包含数字的行
```

### 7.3 最佳实践建议


**💯 使用原则**
- **预览优先**: 先用`:g/pattern/p`查看匹配结果
- **小范围测试**: 先在小文件中测试命令
- **备份重要文件**: 批量操作前先保存
- **逐步操作**: 复杂任务分解为简单步骤

**⚡ 效率提升**
- **组合使用**: 多个命令用`|`连接
- **范围限定**: 用地址范围限制操作范围  
- **正则熟练**: 掌握基本正则表达式
- **历史记录**: 使用`q:`查看命令历史

### 7.4 实际应用价值


**🎯 核心优势**
- **批量处理**: 一次操作处理多行数据
- **精确匹配**: 只处理符合条件的内容
- **效率提升**: 避免重复的手动操作
- **错误减少**: 减少人工操作失误

**🔧 适用场景**
- 代码清理和重构
- 日志文件分析处理  
- 配置文件批量修改
- 文档格式统一调整
- 数据提取和整理

**核心记忆口诀**：
- 全局命令很强大，批量操作不用怕
- 先用p来预览，确认无误再执行
- g是正向v反向，模式匹配要准确
- 删除移动替换显，组合使用效率佳