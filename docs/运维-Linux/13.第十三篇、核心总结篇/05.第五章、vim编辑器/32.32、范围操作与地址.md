---
title: 32、范围操作与地址
---
## 📚 目录

1. [sed地址系统概述](#1-sed地址系统概述)
2. [行地址表示方法](#2-行地址表示方法)
3. [范围操作符详解](#3-范围操作符详解)
4. [模式地址匹配](#4-模式地址匹配)
5. [标记地址系统](#5-标记地址系统)
6. [地址与命令组合](#6-地址与命令组合)
7. [复杂范围表达式](#7-复杂范围表达式)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🎯 sed地址系统概述


### 1.1 什么是地址系统


**简单理解**：sed的地址系统就像给文本中的每一行编上门牌号，然后告诉sed"我要对第几行到第几行做什么操作"。

```
把文本想象成一栋楼：
第1行 ← 101房间
第2行 ← 201房间  
第3行 ← 301房间
...
最后一行 ← 顶层房间($)
```

**核心作用**：
- **精准定位**：指定要操作哪些行
- **批量处理**：一次性操作多行内容
- **条件筛选**：根据内容特征选择行
- **灵活控制**：组合使用实现复杂操作

### 1.2 地址类型总览


| 地址类型 | **语法** | **含义** | **使用场景** |
|---------|---------|----------|-------------|
| 🔢 **数字地址** | `5` | 第5行 | 操作指定行 |
| 💲 **特殊符号** | `$` | 最后一行 | 处理文件末尾 |
| 📍 **当前行** | `.` | 当前处理行 | 交互式操作 |
| 🔍 **模式匹配** | `/pattern/` | 匹配内容的行 | 按内容筛选 |
| 🏷️ **标记地址** | `'a` | 标记为a的行 | 复杂范围操作 |
| ➕ **相对地址** | `+3` | 当前行后3行 | 相对位置操作 |

---

## 2. 🔢 行地址表示方法


### 2.1 数字行地址


**基本概念**：用数字直接指定行号，就像电梯按钮一样简单直接。

```bash
# 示例文件内容
cat > test.txt << EOF
第1行：hello
第2行：world  
第3行：linux
第4行：sed命令
第5行：学习笔记
EOF
```

**数字地址用法**：

```bash
# 打印第3行
sed -n '3p' test.txt
# 输出：第3行：linux

# 删除第2行
sed '2d' test.txt
# 输出：第1、3、4、5行（第2行被删除）

# 在第1行后插入内容
sed '1a\插入的新行' test.txt
```

> **💡 关键理解**：数字地址从1开始计数，不是从0开始！这和数组索引不同。

### 2.2 特殊符号地址


**美元符号($) - 最后一行**
```bash
# 打印最后一行
sed -n '$p' test.txt
# 输出：第5行：学习笔记

# 在最后一行后追加内容
sed '$a\这是新的最后一行' test.txt

# 删除最后一行
sed '$d' test.txt
```

**点号(.) - 当前行**
```bash
# 主要用于交互式模式或脚本中
# 在sed脚本中，.表示当前正在处理的行
sed '3{.=}' test.txt  # 在第3行位置打印行号
```

**百分号(%) - 所有行**
```bash
# %等同于1,$（从第1行到最后一行）
sed '%s/行/LINE/g' test.txt  # 替换所有行中的"行"为"LINE"
```

### 2.3 相对地址表示


**加号(+) - 向后偏移**
```bash
# 从第2行开始，包含后面3行（即第2到第5行）
sed -n '2,+3p' test.txt

# 从匹配"linux"的行开始，包含后面2行
sed -n '/linux/,+2p' test.txt
```

**减号(-) - 向前偏移**
```bash
# 从第5行开始，向前2行（即第3到第5行）
sed -n '5,-2p' test.txt

# 注意：减法地址使用较少，主要用于特殊场景
```

---

## 3. ⚖️ 范围操作符详解


### 3.1 逗号(,) - 连续范围


**含义**：指定一个连续的行范围，就像说"从A房间到B房间"。

```bash
# 基本语法：开始地址,结束地址
sed -n '2,4p' test.txt
# 输出第2、3、4行

# 从第1行到最后一行
sed -n '1,$p' test.txt  # 等同于cat test.txt

# 从匹配的行到指定行
sed -n '/world/,4p' test.txt
# 从包含"world"的行开始到第4行
```

**实际应用场景**：
```bash
# 提取配置文件的某个段落
sed -n '/^\[database\]/,/^\[/p' config.ini

# 删除日志文件的指定时间段
sed '/2024-01-01/,/2024-01-31/d' app.log
```

### 3.2 分号(;) - 多个独立范围


**含义**：在同一命令中指定多个不相关的地址或范围。

```bash
# 同时处理第1行和第3行
sed -n '1p;3p' test.txt

# 同时处理第2行和最后一行
sed -n '2p;$p' test.txt

# 组合不同类型的地址
sed -n '1p;/linux/p;$p' test.txt
```

**范围组合示例**：
```bash
# 处理多个段落
sed -n '1,2p;4,5p' test.txt  # 输出1-2行和4-5行

# 复杂条件组合
sed '1,3s/第/Line/;4,$s/行/Row/' test.txt
```

> **🔍 深入理解**：逗号是"范围"，分号是"并且"。逗号连接两点成一条线，分号是多个独立的点。

### 3.3 范围边界处理


**包含性原则**：
```
范围 2,4 包括：
- 第2行（开始边界）✅
- 第3行（中间）✅  
- 第4行（结束边界）✅
```

**边界测试**：
```bash
# 创建测试文件
seq 1 10 > numbers.txt  # 生成1到10的数字文件

# 测试不同范围
sed -n '3,7p' numbers.txt   # 输出：3 4 5 6 7
sed -n '3,3p' numbers.txt   # 输出：3（单行范围）
sed -n '8,$p' numbers.txt   # 输出：8 9 10
```

---

## 4. 🔍 模式地址匹配


### 4.1 基本模式匹配


**语法格式**：`/pattern/` - 用斜杠包围要匹配的模式

```bash
# 创建包含不同内容的测试文件
cat > fruits.txt << EOF
apple red
banana yellow  
orange orange
grape purple
apple green
EOF
```

**基础匹配操作**：
```bash
# 打印包含"apple"的行
sed -n '/apple/p' fruits.txt
# 输出：
# apple red
# apple green

# 删除包含"orange"的行
sed '/orange/d' fruits.txt

# 替换包含"banana"的行中的内容
sed '/banana/s/yellow/gold/' fruits.txt
```

### 4.2 正则表达式模式


**常用正则符号**：

| 符号 | **含义** | **示例** | **匹配结果** |
|------|---------|---------|-------------|
| `^` | 行首 | `/^apple/` | 以apple开头的行 |
| `$` | 行尾 | `/red$/` | 以red结尾的行 |
| `.` | 任意字符 | `/ap.le/` | apple, aple等 |
| `*` | 前字符0次或多次 | `/ap*le/` | ale, aple, apple |
| `[]` | 字符集 | `/[aeiou]/` | 包含元音的行 |

**实际应用**：
```bash
# 匹配空行
sed -n '/^$/p' file.txt

# 匹配以数字开头的行
sed -n '/^[0-9]/p' file.txt

# 匹配包含邮箱的行
sed -n '/[a-zA-Z0-9]*@[a-zA-Z0-9]*\.[a-zA-Z]/p' file.txt
```

### 4.3 模式范围组合


**模式到模式的范围**：
```bash
# 从第一个"apple"到第一个"grape"
sed -n '/apple/,/grape/p' fruits.txt

# 从包含"banana"的行到文件末尾
sed -n '/banana/,$p' fruits.txt

# 从第2行到包含"orange"的行
sed -n '2,/orange/p' fruits.txt
```

**复杂模式匹配**：
```bash
# 提取HTML标签之间的内容
sed -n '/<body>/,/<\/body>/p' index.html

# 提取配置文件段落
sed -n '/^#.*START/,/^#.*END/p' config.conf
```

---

## 5. 🏷️ 标记地址系统


### 5.1 标记的创建与使用


**基本概念**：标记就像在文本中贴便签纸，给某些行做记号，方便后续引用。

**标记语法**：
- 创建标记：`:label` 或 `label:`
- 引用标记：`'label`

```bash
# sed脚本示例（保存为script.sed）
cat > mark_script.sed << 'EOF'
# 在第2行创建标记a
2 {
    h        # 保存到hold空间
    :mark_a  # 创建标记mark_a
}

# 在第4行跳转到标记a
4 {
    g        # 从hold空间获取内容
    b mark_a # 跳转到mark_a
}
EOF
```

### 5.2 标记与范围结合


**标记范围操作**：
```bash
# 使用标记定义复杂范围
sed '
/START/ {
    :begin
    n
    /END/!b begin
    /END/ {
        # 处理START到END之间的内容
        s/old/new/g
    }
}
' input.txt
```

### 5.3 实际应用场景


**日志处理示例**：
```bash
# 处理多行日志记录
sed '
/ERROR/ {
    :error_block
    h
    n
    /^[0-9]/{
        # 新的日志条目开始
        x
        p
        b
    }
    b error_block
}
' error.log
```

> **⚠️ 重要提醒**：标记地址主要用于复杂的sed脚本，日常使用中数字地址和模式地址已能满足大多数需求。

---

## 6. 🔧 地址与命令组合


### 6.1 常用命令组合


**打印命令(p)组合**：
```bash
# 只打印匹配行
sed -n '/pattern/p' file.txt

# 打印范围内的行
sed -n '1,5p' file.txt

# 打印除了某范围外的所有行
sed '2,4d' file.txt  # 等效于删除2-4行，打印其余行
```

**删除命令(d)组合**：
```bash
# 删除空行
sed '/^$/d' file.txt

# 删除注释行（以#开头）
sed '/^#/d' config.txt

# 删除指定范围
sed '10,20d' file.txt
```

**替换命令(s)组合**：
```bash
# 只在特定行替换
sed '3s/old/new/' file.txt

# 在特定范围内替换
sed '1,10s/old/new/g' file.txt

# 在匹配行中替换
sed '/pattern/s/old/new/g' file.txt
```

### 6.2 多命令组合


**花括号{}分组**：
```bash
# 对同一地址执行多个命令
sed '2,4{
    s/old/new/g
    s/test/example/g
    /error/d
}' file.txt

# 条件执行
sed '/START/{
    n          # 读取下一行
    s/^/    /  # 添加缩进
    p          # 打印
}' file.txt
```

**命令链式组合**：
```bash
# 一行中执行多个操作
sed '1s/^/# /;$s/$/\n--- End ---/' file.txt

# 复杂的多步骤处理
sed '
1i\=== Document Start ===
/^$/d
/TODO/s/$/  [待处理]
$a\=== Document End ===
' document.txt
```

### 6.3 实战应用示例


**配置文件处理**：
```bash
# 处理nginx配置文件
sed '
# 删除注释和空行
/^#/d
/^$/d
# 在server块中添加标记
/server {/,/}/ {
    /location/i\    # Location配置
}
' nginx.conf
```

**日志分析**：
```bash
# 提取错误信息
sed -n '
/ERROR/,/^$/ {
    /^$/!p
}
' app.log

# 格式化输出
sed '
/\[INFO\]/ {
    s/.*\[\(.*\)\].*/📝 信息: \1/
}
/\[ERROR\]/ {
    s/.*\[\(.*\)\].*/❌ 错误: \1/
}
' system.log
```

---

## 7. 🧩 复杂范围表达式


### 7.1 嵌套范围操作


**概念理解**：就像俄罗斯套娃一样，在大范围里面还有小范围。

```
文件结构：
1: [Section A]
2: item1
3: item2  
4: [Section B]
5: item3
6: item4
7: [Section C]
8: item5

需求：只处理Section B中的内容
```

**实现方法**：
```bash
# 方法1：使用范围限定
sed -n '/\[Section B\]/,/\[Section C\]/ {
    /\[Section/d  # 排除段落标题
    p
}' config.txt

# 方法2：使用标记跳转
sed '
/\[Section B\]/ {
    :section_b
    n
    /\[Section C\]/b end_section
    # 处理Section B中的内容
    s/^/>> /
    b section_b
    :end_section
}
' config.txt
```

### 7.2 条件范围处理


**多条件组合**：
```bash
# 同时满足多个条件
sed -n '
/START/,/END/ {
    /IMPORTANT/ {
        /ERROR/p
    }
}
' log.txt

# 条件互斥处理
sed '
/WARNING/,/^$/ {
    /ERROR/! {
        s/^/[警告] /
    }
}
/ERROR/,/^$/ {
    s/^/[错误] /
}
' messages.log
```

### 7.3 动态范围计算


**基于内容的动态范围**：
```bash
# 处理变长的数据块
sed '
/^BEGIN/ {
    :block_start
    h
    :block_loop
    n
    /^END/b block_end
    H
    b block_loop
    :block_end
    g
    s/BEGIN\n/=== 数据块开始 ===\n/
    s/\nEND/\n=== 数据块结束 ===/
    p
}
' data.txt
```

**计数器范围**：
```bash
# 每隔N行处理一次
sed '
1 {
    x
    s/$/0/
    x
}
{
    x
    s/./&1/
    /11111/ {
        s/.*/0/
        x
        s/^/*** 第5行倍数: /
        x
    }
    x
}
' file.txt
```

### 7.4 复杂范围调试


**调试技巧**：
```bash
# 添加行号和状态信息
sed = file.txt | sed '
N
s/\n/: /
/: ERROR/,/: ^$/ {
    s/^/[范围内] /
}
'

# 可视化范围匹配
sed '
/START/,/END/ {
    s/^/>>> [范围内] /
}
/START/ {
    i\=== 范围开始 ===
}
/END/ {
    a\=== 范围结束 ===
}
' test.txt
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基本概念


```
🔸 地址系统：sed的地址就像门牌号，指定要操作哪些行
🔸 数字地址：1,2,3...直接指定行号，$表示最后一行
🔸 模式地址：/pattern/根据内容匹配行
🔸 范围操作：逗号(,)表示连续范围，分号(;)表示多个独立地址
🔸 地址组合：可以混合使用数字、模式、符号等不同类型地址
```

### 8.2 关键理解要点


**🔹 地址的本质作用**
```
定位功能：告诉sed"在哪里"执行操作
范围控制：批量处理多行内容
条件筛选：根据行号或内容特征选择目标行
灵活组合：通过组合实现复杂的文本处理逻辑
```

**🔹 范围操作的逻辑**
```
连续范围(,)：从A行到B行的所有行
独立地址(;)：A行和B行（可能不连续）
包含边界：范围的开始和结束行都会被包含
动态边界：可以用模式匹配作为范围边界
```

**🔹 实际使用策略**
```
简单场景：优先使用数字地址，直观明确
内容相关：使用模式地址，根据文本特征操作
批量处理：使用范围操作，提高效率
复杂需求：组合多种地址类型，灵活应对
```

### 8.3 实际应用价值


**📊 使用频率排序**
1. **数字地址** (90%)：`1`, `5`, `$`, `1,10`
2. **模式地址** (80%)：`/pattern/`, `/start/,/end/`
3. **范围组合** (60%)：`1,5`, `/begin/,$`
4. **相对地址** (30%)：`+3`, `-2`
5. **标记地址** (10%)：`:label`, `'a`

**🎯 典型应用场景**
- **日志分析**：提取特定时间段或错误类型的日志
- **配置管理**：修改配置文件的特定段落
- **数据清洗**：删除空行、注释行、无用数据
- **格式转换**：批量修改文件格式和内容
- **代码处理**：修改源代码中的特定部分

### 8.4 学习建议


**🚀 学习路径**
```
第一步：掌握数字地址和基本范围操作
第二步：学会模式地址和正则表达式
第三步：练习地址与命令的组合使用
第四步：探索复杂的范围表达式和条件处理
```

**💡 实践技巧**
- 从简单的单行操作开始练习
- 逐步尝试范围操作和模式匹配
- 使用`-n`选项配合`p`命令验证地址选择
- 在真实文件上测试前先用小文件验证
- 学会使用行号命令`=`来调试地址范围

**🔧 调试方法**
```bash
# 验证地址选择是否正确
sed -n '地址范围p' file.txt

# 添加行号帮助理解
sed = file.txt | sed 'N;s/\n/: /'

# 逐步测试复杂地址表达式
sed -n '1,5p; /pattern/p; $p' file.txt
```

**核心记忆**：
- 地址是sed的导航系统，告诉它"去哪里"
- 数字地址最直接，模式地址最灵活
- 逗号连范围，分号连地址，组合用花括号
- 掌握地址系统，sed操作就成功了一半