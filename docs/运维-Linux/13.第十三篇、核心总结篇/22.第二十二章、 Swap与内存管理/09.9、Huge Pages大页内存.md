---
title: 9ã€Huge Pageså¤§é¡µå†…å­˜
---
## ğŸ“š ç›®å½•


1. [å¤§é¡µå†…å­˜åŸºç¡€æ¦‚å¿µ](#1-å¤§é¡µå†…å­˜åŸºç¡€æ¦‚å¿µ)
2. [å¤§é¡µå†…å­˜ä¼˜åŠ¿åˆ†æ](#2-å¤§é¡µå†…å­˜ä¼˜åŠ¿åˆ†æ)
3. [ç³»ç»Ÿå¤§é¡µä¿¡æ¯æŸ¥çœ‹](#3-ç³»ç»Ÿå¤§é¡µä¿¡æ¯æŸ¥çœ‹)
4. [å¤§é¡µå†…å­˜é…ç½®ç®¡ç†](#4-å¤§é¡µå†…å­˜é…ç½®ç®¡ç†)
5. [hugetlbfsæ–‡ä»¶ç³»ç»Ÿ](#5-hugetlbfsæ–‡ä»¶ç³»ç»Ÿ)
6. [é€æ˜å¤§é¡µTHPæœºåˆ¶](#6-é€æ˜å¤§é¡µthpæœºåˆ¶)
7. [åº”ç”¨ç¨‹åºå¤§é¡µä½¿ç”¨](#7-åº”ç”¨ç¨‹åºå¤§é¡µä½¿ç”¨)
8. [å¤§é¡µå†…å­˜æ€§èƒ½ä¼˜åŒ–](#8-å¤§é¡µå†…å­˜æ€§èƒ½ä¼˜åŒ–)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

# ğŸ¯ **å­¦ä¹ è·¯å¾„å¯¼èˆª**


**å‰ç½®çŸ¥è¯†**ï¼šéœ€è¦æŒæ¡Linuxå†…å­˜ç®¡ç†åŸºç¡€ã€è™šæ‹Ÿå†…å­˜æ¦‚å¿µ â†’ **å½“å‰å†…å®¹**ï¼šHuge Pageså¤§é¡µå†…å­˜ â†’ **åç»­å­¦ä¹ **ï¼šå»ºè®®å­¦ä¹ NUMAå†…å­˜æ¶æ„ä¼˜åŒ–

â±ï¸ **é¢„è®¡å­¦ä¹ æ—¶é—´**ï¼šæœ¬ç« é¢„è®¡50åˆ†é’Ÿ | å®è·µæ“ä½œ30åˆ†é’Ÿ

---

## 1. ğŸ—ï¸ å¤§é¡µå†…å­˜åŸºç¡€æ¦‚å¿µ



### 1.1 ä»€ä¹ˆæ˜¯å¤§é¡µå†…å­˜



**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
å¤§é¡µå†…å­˜ï¼ˆHuge Pagesï¼‰æ˜¯Linuxå†…æ ¸æä¾›çš„ä¸€ç§å†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œä½¿ç”¨æ¯”æ ‡å‡†4KBæ›´å¤§çš„å†…å­˜é¡µé¢æ¥å‡å°‘é¡µè¡¨å¼€é”€å’ŒTLBç¼ºå¤±ã€‚

**ğŸ’¡ é€šä¿—ç†è§£**
æƒ³è±¡å†…å­˜ç®¡ç†å°±åƒå›¾ä¹¦é¦†ç®¡ç†ä¹¦ç±ï¼š
- **æ™®é€šé¡µé¢**ï¼šæ¯æœ¬ä¹¦å•ç‹¬ç¼–å·ç®¡ç†ï¼Œéœ€è¦å¾ˆå¤§çš„ç›®å½•å†Œ
- **å¤§é¡µå†…å­˜**ï¼šæŠŠç›¸å…³ä¹¦ç±æ‰“åŒ…æˆå¥—è£…ï¼Œç›®å½•å†Œå˜å°ï¼ŒæŸ¥æ‰¾æ›´å¿«

### 1.2 é¡µé¢å¤§å°å¯¹æ¯”



**ğŸ“Š ä¸åŒæ¶æ„çš„é¡µé¢å¤§å°**

| **æ¶æ„** | **æ ‡å‡†é¡µé¢** | **å¤§é¡µé¢é€‰é¡¹** | **å…¸å‹åº”ç”¨** |
|---------|-------------|---------------|-------------|
| **x86_64** | 4KB | 2MB, 1GB | æ•°æ®åº“ã€è™šæ‹ŸåŒ– |
| **ARM64** | 4KB/16KB/64KB | 2MB, 32MB, 1GB | é«˜æ€§èƒ½è®¡ç®— |
| **PowerPC** | 4KB/64KB | 16MB, 16GB | ä¼ä¸šçº§åº”ç”¨ |

### 1.3 å¤§é¡µå†…å­˜å·¥ä½œåŸç†



**ğŸ”§ å†…å­˜æ˜ å°„æœºåˆ¶**
```
æ ‡å‡†é¡µé¢æ˜ å°„ï¼š
ç‰©ç†å†…å­˜    é¡µè¡¨é¡¹        è™šæ‹Ÿåœ°å€
[4KBé¡µ] â†â†’ [PTEæ¡ç›®] â†â†’ [ç¨‹åºåœ°å€]
éœ€è¦å¤§é‡é¡µè¡¨é¡¹å­˜å‚¨æ˜ å°„å…³ç³»

å¤§é¡µé¢æ˜ å°„ï¼š  
ç‰©ç†å†…å­˜    é¡µè¡¨é¡¹        è™šæ‹Ÿåœ°å€
[2MBé¡µ] â†â†’ [PTEæ¡ç›®] â†â†’ [ç¨‹åºåœ°å€]
ä¸€ä¸ªé¡µè¡¨é¡¹ç®¡ç†æ›´å¤§å†…å­˜åŒºåŸŸ
```

---

## 2. âš¡ å¤§é¡µå†…å­˜ä¼˜åŠ¿åˆ†æ



### 2.1 æ€§èƒ½ä¼˜åŠ¿è¯¦è§£



**ğŸš€ TLBç¼“å­˜æ•ˆç‡æå‡**
```
TLBå·¥ä½œåŸç†ï¼š
- TLBï¼ˆTranslation Lookaside Bufferï¼‰å­˜å‚¨è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„
- TLBæ¡ç›®æœ‰é™ï¼Œé¢‘ç¹çš„é¡µé¢åˆ‡æ¢å¯¼è‡´TLBç¼ºå¤±
- å¤§é¡µå‡å°‘TLBæ¡ç›®éœ€æ±‚ï¼Œæé«˜å‘½ä¸­ç‡

å®é™…æ•ˆæœï¼š
æ™®é€š4KBé¡µï¼š1ä¸ªTLBæ¡ç›®è¦†ç›–4KBå†…å­˜
2MBå¤§é¡µï¼š1ä¸ªTLBæ¡ç›®è¦†ç›–2MBå†…å­˜ (æå‡512å€è¦†ç›–èŒƒå›´)
```

**ğŸ“ˆ å†…å­˜ç®¡ç†å¼€é”€é™ä½**

| **æŒ‡æ ‡** | **4KBé¡µé¢** | **2MBå¤§é¡µ** | **æ€§èƒ½æå‡** |
|---------|------------|------------|------------|
| **é¡µè¡¨æ¡ç›®æ•°** | é«˜ | å‡å°‘512å€ | âœ… æ˜¾è‘—é™ä½å†…å­˜å¼€é”€ |
| **TLBç¼ºå¤±ç‡** | é«˜ | å¤§å¹…å‡å°‘ | âš¡ å†…å­˜è®¿é—®åŠ é€Ÿ5-15% |
| **é¡µé¢é”™è¯¯å¤„ç†** | é¢‘ç¹ | æ˜æ˜¾å‡å°‘ | ğŸ¯ ç³»ç»Ÿè°ƒç”¨å¼€é”€é™ä½ |

### 2.2 é€‚ç”¨åœºæ™¯åˆ†æ



**ğŸ¯ æœ€ä½³åº”ç”¨åœºæ™¯**
- **æ•°æ®åº“ç³»ç»Ÿ**ï¼šå¤§é‡è¿ç»­å†…å­˜è®¿é—®ï¼Œå¦‚MySQLã€PostgreSQL
- **è™šæ‹ŸåŒ–å¹³å°**ï¼šKVMã€QEMUç­‰è™šæ‹Ÿæœºå†…å­˜åˆ†é…
- **é«˜æ€§èƒ½è®¡ç®—**ï¼šç§‘å­¦è®¡ç®—ã€æœºå™¨å­¦ä¹ è®­ç»ƒ
- **å†…å­˜æ•°æ®åº“**ï¼šRedisã€Memcachedç­‰ç¼“å­˜ç³»ç»Ÿ

**âš ï¸ ä¸é€‚ç”¨åœºæ™¯**
- **å°å†…å­˜åº”ç”¨**ï¼šå†…å­˜éœ€æ±‚å°äºå¤§é¡µå¤§å°çš„ç¨‹åº
- **ç¢ç‰‡åŒ–è´Ÿè½½**ï¼šå†…å­˜è®¿é—®æ¨¡å¼éšæœºã€åˆ†æ•£çš„åº”ç”¨
- **é¢‘ç¹forkè¿›ç¨‹**ï¼šå¤§é¡µä¸èƒ½è¢«å¤šè¿›ç¨‹å…±äº«ï¼Œé€ æˆå†…å­˜æµªè´¹

---

## 3. ğŸ” ç³»ç»Ÿå¤§é¡µä¿¡æ¯æŸ¥çœ‹



### 3.1 /proc/meminfoæŸ¥çœ‹å¤§é¡µçŠ¶æ€



**ğŸ“Š å…³é”®æŒ‡æ ‡è§£è¯»**
```bash
# æŸ¥çœ‹ç³»ç»Ÿå¤§é¡µä¿¡æ¯

cat /proc/meminfo | grep -i huge

# è¾“å‡ºç¤ºä¾‹è§£æï¼š

HugePages_Total:      20    # æ€»å¤§é¡µæ•°é‡
HugePages_Free:       15    # ç©ºé—²å¤§é¡µæ•°é‡  
HugePages_Rsvd:        2    # é¢„ç•™å¤§é¡µæ•°é‡
HugePages_Surp:        0    # ä¸´æ—¶åˆ†é…çš„å¤§é¡µæ•°é‡
Hugepagesize:       2048    # å•ä¸ªå¤§é¡µå¤§å°(KB)
Hugetlb:           40960    # å¤§é¡µæ€»å†…å­˜(KB)
```

**ğŸ’¡ çŠ¶æ€æŒ‡æ ‡å«ä¹‰**
- **Total**ï¼šç³»ç»Ÿé…ç½®çš„å¤§é¡µæ€»æ•°
- **Free**ï¼šå½“å‰æœªä½¿ç”¨çš„å¤§é¡µæ•°é‡
- **Reserved**ï¼šåº”ç”¨ç¨‹åºé¢„ç•™ä½†æœªå®é™…ä½¿ç”¨çš„å¤§é¡µ
- **Surplus**ï¼šè¶…è¿‡é…ç½®æ•°é‡çš„ä¸´æ—¶å¤§é¡µ

### 3.2 /sysæ¥å£è¯¦ç»†ä¿¡æ¯



**ğŸ” ç³»ç»Ÿæ¥å£æŸ¥çœ‹**
```bash
# æŸ¥çœ‹å¤§é¡µè¯¦ç»†é…ç½®

ls /sys/kernel/mm/hugepages/

# å…¸å‹è¾“å‡ºï¼š

hugepages-1048576kB/  # 1GBå¤§é¡µ
hugepages-2048kB/     # 2MBå¤§é¡µ

# æŸ¥çœ‹2MBå¤§é¡µè¯¦ç»†ä¿¡æ¯

cat /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
cat /sys/kernel/mm/hugepages/hugepages-2048kB/free_hugepages
```

### 3.3 å®æ—¶ç›‘æ§å¤§é¡µä½¿ç”¨



**ğŸ“ˆ åŠ¨æ€ç›‘æ§è„šæœ¬ç¤ºä¾‹**
```bash
#!/bin/bash

# å¤§é¡µä½¿ç”¨ç›‘æ§è„šæœ¬


echo "=== å¤§é¡µå†…å­˜ä½¿ç”¨ç›‘æ§ ==="
while true; do
    total=$(grep HugePages_Total /proc/meminfo | awk '{print $2}')
    free=$(grep HugePages_Free /proc/meminfo | awk '{print $2}')
    used=$((total - free))
    usage_percent=$((used * 100 / total))
    
    echo "$(date): å¤§é¡µä½¿ç”¨ç‡ ${usage_percent}% (${used}/${total})"
    sleep 5
done
```

---

## 4. âš™ï¸ å¤§é¡µå†…å­˜é…ç½®ç®¡ç†



### 4.1 è¿è¡Œæ—¶é…ç½®å¤§é¡µæ•°é‡



**ğŸ”§ ä¸´æ—¶é…ç½®æ–¹æ³•**
```bash
# æ–¹æ³•1ï¼šç›´æ¥å†™å…¥procæ–‡ä»¶ç³»ç»Ÿ

echo 100 > /proc/sys/vm/nr_hugepages

# æ–¹æ³•2ï¼šä½¿ç”¨sysctlå‘½ä»¤

sysctl -w vm.nr_hugepages=100

# éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆ

cat /proc/meminfo | grep HugePages_Total
```

**ğŸ“ é…ç½®è®¡ç®—æ–¹æ³•**
éœ€è¦çš„å¤§é¡µæ•°é‡ = åº”ç”¨å†…å­˜éœ€æ±‚ Ã· å¤§é¡µå¤§å°
```bash
# ç¤ºä¾‹ï¼šåº”ç”¨éœ€è¦4GBå†…å­˜ï¼Œä½¿ç”¨2MBå¤§é¡µ

# è®¡ç®—ï¼š4GB Ã· 2MB = 4096MB Ã· 2MB = 2048ä¸ªå¤§é¡µ

echo 2048 > /proc/sys/vm/nr_hugepages
```

### 4.2 æ°¸ä¹…é…ç½®è®¾ç½®



**âš¡ ç³»ç»Ÿå¯åŠ¨é…ç½®**
```bash
# ç¼–è¾‘/etc/sysctl.confæ·»åŠ ï¼š

vm.nr_hugepages = 1024

# æˆ–åˆ›å»ºä¸“é—¨é…ç½®æ–‡ä»¶ï¼š

echo "vm.nr_hugepages = 1024" > /etc/sysctl.d/99-hugepages.conf

# åº”ç”¨é…ç½®

sysctl -p /etc/sysctl.d/99-hugepages.conf
```

### 4.3 NUMAç³»ç»Ÿå¤§é¡µé…ç½®



**ğŸ—ï¸ å¤šèŠ‚ç‚¹å†…å­˜é…ç½®**
```bash
# æŸ¥çœ‹NUMAèŠ‚ç‚¹ä¿¡æ¯

numactl --hardware

# ä¸ºç‰¹å®šNUMAèŠ‚ç‚¹é…ç½®å¤§é¡µ

echo 512 > /sys/devices/system/node/node0/hugepages/hugepages-2048kB/nr_hugepages
echo 512 > /sys/devices/system/node/node1/hugepages/hugepages-2048kB/nr_hugepages

# éªŒè¯å„èŠ‚ç‚¹å¤§é¡µåˆ†å¸ƒ

for node in /sys/devices/system/node/node*/hugepages/hugepages-2048kB/nr_hugepages; do
    echo "$(dirname $node): $(cat $node)"
done
```

---

## 5. ğŸ’¾ hugetlbfsæ–‡ä»¶ç³»ç»Ÿ



### 5.1 hugetlbfsåŸºç¡€æ¦‚å¿µ



**ğŸ”¸ ä»€ä¹ˆæ˜¯hugetlbfs**
hugetlbfsæ˜¯Linuxå†…æ ¸æä¾›çš„ä¸“é—¨ç”¨äºå¤§é¡µå†…å­˜çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå…è®¸åº”ç”¨ç¨‹åºé€šè¿‡æ–‡ä»¶æ˜ å°„çš„æ–¹å¼ä½¿ç”¨å¤§é¡µå†…å­˜ã€‚

**ğŸ’¡ å·¥ä½œæœºåˆ¶ç†è§£**
```
ä¼ ç»Ÿå†…å­˜åˆ†é…ï¼šmalloc() â†’ æ ‡å‡†4KBé¡µé¢
å¤§é¡µå†…å­˜åˆ†é…ï¼šmmap(hugetlbfsæ–‡ä»¶) â†’ 2MB/1GBå¤§é¡µé¢

ä¼˜åŠ¿ï¼š
- åº”ç”¨ç¨‹åºæ— éœ€ä¿®æ”¹å†…å­˜åˆ†é…é€»è¾‘
- é€šè¿‡æ–‡ä»¶ç³»ç»Ÿæ¥å£ä½¿ç”¨å¤§é¡µ
- æ”¯æŒå†…å­˜å…±äº«å’ŒæŒä¹…åŒ–
```

### 5.2 æŒ‚è½½hugetlbfsæ–‡ä»¶ç³»ç»Ÿ



**ğŸ“ æŒ‚è½½é…ç½®æ–¹æ³•**
```bash
# åˆ›å»ºæŒ‚è½½ç‚¹

mkdir /mnt/hugepages

# æŒ‚è½½hugetlbfs (2MBé¡µé¢)

mount -t hugetlbfs -o pagesize=2MB none /mnt/hugepages

# æŒ‚è½½1GBå¤§é¡µé¢

mkdir /mnt/hugepages_1g
mount -t hugetlbfs -o pagesize=1GB none /mnt/hugepages_1g

# æŸ¥çœ‹æŒ‚è½½çŠ¶æ€

mount | grep hugetlbfs
```

**âš¡ æ°¸ä¹…æŒ‚è½½é…ç½®**
```bash
# ç¼–è¾‘/etc/fstabæ·»åŠ ï¼š

none /mnt/hugepages hugetlbfs pagesize=2MB 0 0
none /mnt/hugepages_1g hugetlbfs pagesize=1GB 0 0

# æµ‹è¯•æŒ‚è½½é…ç½®

mount -a
```

### 5.3 hugetlbfsä½¿ç”¨ç¤ºä¾‹



**ğŸ’» Cç¨‹åºä½¿ç”¨å¤§é¡µç¤ºä¾‹**
```c
#include <sys/mman.h>

#include <fcntl.h>

#include <unistd.h>


int main() {
    int fd;
    void *addr;
    size_t length = 2 * 1024 * 1024; // 2MB
    
    // æ‰“å¼€hugetlbfsæ–‡ä»¶
    fd = open("/mnt/hugepages/myapp", O_CREAT | O_RDWR, 0755);
    if (fd < 0) return -1;
    
    // è®¾ç½®æ–‡ä»¶å¤§å°
    if (ftruncate(fd, length) < 0) return -1;
    
    // æ˜ å°„å¤§é¡µå†…å­˜
    addr = mmap(NULL, length, PROT_READ | PROT_WRITE, 
                MAP_SHARED, fd, 0);
    if (addr == MAP_FAILED) return -1;
    
    // ä½¿ç”¨å†…å­˜...
    
    // æ¸…ç†èµ„æº
    munmap(addr, length);
    close(fd);
    unlink("/mnt/hugepages/myapp");
    return 0;
}
```

---

## 6. ğŸ”„ é€æ˜å¤§é¡µTHPæœºåˆ¶



### 6.1 THPåŸºæœ¬æ¦‚å¿µ



**ğŸ”¸ é€æ˜å¤§é¡µå®šä¹‰**
é€æ˜å¤§é¡µï¼ˆTransparent Huge Pages, THPï¼‰æ˜¯Linuxå†…æ ¸è‡ªåŠ¨å°†æ ‡å‡†4KBé¡µé¢åˆå¹¶ä¸ºå¤§é¡µçš„æœºåˆ¶ï¼Œåº”ç”¨ç¨‹åºæ— éœ€ä¿®æ”¹å³å¯å—ç›Šã€‚

**ğŸ’¡ THP vs ä¼ ç»Ÿå¤§é¡µå¯¹æ¯”**

| **ç‰¹æ€§** | **ä¼ ç»Ÿå¤§é¡µ** | **é€æ˜å¤§é¡µTHP** |
|---------|-------------|----------------|
| **é…ç½®å¤æ‚åº¦** | éœ€è¦é¢„åˆ†é…å’ŒæŒ‚è½½ | è‡ªåŠ¨ç®¡ç† |
| **åº”ç”¨ç¨‹åºä¿®æ”¹** | éœ€è¦ä»£ç é€‚é… | å®Œå…¨é€æ˜ |
| **å†…å­˜åˆ©ç”¨ç‡** | å¯èƒ½æœ‰æµªè´¹ | åŠ¨æ€ä¼˜åŒ– |
| **æ€§èƒ½å¯é¢„æµ‹æ€§** | é«˜ | ä¸­ç­‰ |

### 6.2 THPé…ç½®ç®¡ç†



**âš™ï¸ THPçŠ¶æ€æŸ¥çœ‹å’Œé…ç½®**
```bash
# æŸ¥çœ‹THPå½“å‰çŠ¶æ€

cat /sys/kernel/mm/transparent_hugepage/enabled

# å…¸å‹è¾“å‡ºï¼š

[always] madvise never
# [always]: å§‹ç»ˆå¯ç”¨THP

# madvise: ä»…åœ¨ç¨‹åºæ˜ç¡®è¯·æ±‚æ—¶å¯ç”¨  

# never: å®Œå…¨ç¦ç”¨THP


# ä¿®æ”¹THPç­–ç•¥

echo madvise > /sys/kernel/mm/transparent_hugepage/enabled

# æŸ¥çœ‹THPç»Ÿè®¡ä¿¡æ¯

grep AnonHugePages /proc/meminfo
```

**ğŸ”§ THPè¯¦ç»†å‚æ•°é…ç½®**
```bash
# THPç›¸å…³é…ç½®ç›®å½•

ls /sys/kernel/mm/transparent_hugepage/

# å…³é”®é…ç½®æ–‡ä»¶ï¼š

cat /sys/kernel/mm/transparent_hugepage/defrag
# å†…å­˜ç¢ç‰‡æ•´ç†ç­–ç•¥


cat /sys/kernel/mm/transparent_hugepage/khugepaged/
# THPåå°æ•´ç†è¿›ç¨‹é…ç½®

```

### 6.3 THPæ€§èƒ½è°ƒä¼˜



**ğŸ“Š THPé€‚ç”¨åœºæ™¯åˆ¤æ–­**
```bash
# ç›‘æ§THPä½¿ç”¨æ•ˆæœ

echo "=== THPä½¿ç”¨ç»Ÿè®¡ ==="
grep -E "(AnonHugePages|HugePages)" /proc/meminfo

# æŸ¥çœ‹THPåˆ†é…å¤±è´¥ç»Ÿè®¡

cat /proc/vmstat | grep thp

# è¾“å‡ºè§£æï¼š

thp_fault_alloc 15234      # THPåˆ†é…æˆåŠŸæ¬¡æ•°
thp_fault_fallback 892     # THPåˆ†é…å¤±è´¥å›é€€åˆ°å°é¡µ
thp_collapse_alloc 45      # åå°åˆå¹¶æˆåŠŸæ¬¡æ•°
```

**âš¡ THPä¼˜åŒ–å»ºè®®**
- **æ•°æ®åº“åº”ç”¨**ï¼šé€šå¸¸å»ºè®®è®¾ç½®ä¸º`madvise`æ¨¡å¼
- **WebæœåŠ¡**ï¼šå¯ä»¥å¯ç”¨`always`æ¨¡å¼æå‡æ€§èƒ½
- **å†…å­˜å—é™ç¯å¢ƒ**ï¼šè€ƒè™‘è®¾ç½®ä¸º`never`é¿å…å†…å­˜ç¢ç‰‡

---

## 7. ğŸ’» åº”ç”¨ç¨‹åºå¤§é¡µä½¿ç”¨



### 7.1 ç¼–ç¨‹æ¥å£ä½¿ç”¨



**ğŸ”§ mmapæ–¹å¼ä½¿ç”¨å¤§é¡µ**
```c
// ä½¿ç”¨hugetlbfsçš„å¤§é¡µåˆ†é…
void* allocate_hugepage_memory(size_t size) {
    int fd;
    void* addr;
    
    // æ‰“å¼€hugetlbfsæ–‡ä»¶
    fd = open("/mnt/hugepages/temp", O_CREAT | O_RDWR, 0755);
    if (fd == -1) return NULL;
    
    // è®¾ç½®æ–‡ä»¶å¤§å°ä¸ºå¤§é¡µçš„æ•´æ•°å€
    if (ftruncate(fd, size) == -1) {
        close(fd);
        return NULL;
    }
    
    // æ˜ å°„å¤§é¡µå†…å­˜
    addr = mmap(NULL, size, PROT_READ | PROT_WRITE,
                MAP_SHARED, fd, 0);
    
    close(fd);
    unlink("/mnt/hugepages/temp");
    
    return (addr == MAP_FAILED) ? NULL : addr;
}
```

### 7.2 libhugetlbfsåº“ä½¿ç”¨



**ğŸ“š ç®€åŒ–çš„å¤§é¡µç¼–ç¨‹æ¥å£**
```c
#include <hugetlbfs.h>


int main() {
    void *addr;
    long hpage_size = gethugepagesize();
    
    // åˆ†é…å¤§é¡µå†…å­˜
    addr = get_hugepage_region(4 * hpage_size, GHR_DEFAULT);
    if (addr == NULL) {
        fprintf(stderr, "å¤§é¡µå†…å­˜åˆ†é…å¤±è´¥\n");
        return -1;
    }
    
    // ä½¿ç”¨å†…å­˜
    memset(addr, 0, 4 * hpage_size);
    
    // é‡Šæ”¾å†…å­˜
    free_hugepage_region(addr);
    return 0;
}

// ç¼–è¯‘å‘½ä»¤ï¼š
// gcc -lhugetlbfs program.c -o program
```

### 7.3 Javaåº”ç”¨å¤§é¡µé…ç½®



**â˜• JVMå¤§é¡µä¼˜åŒ–**
```bash
# JVMå¯åŠ¨å‚æ•°é…ç½®å¤§é¡µ

java -XX:+UseLargePages \
     -XX:LargePageSizeInBytes=2m \
     -Xms4g -Xmx4g \
     MyApplication

# æ£€æŸ¥JVMæ˜¯å¦ä½¿ç”¨å¤§é¡µ

jcmd <pid> VM.flags | grep UseLargePages

# æŸ¥çœ‹Javaè¿›ç¨‹å†…å­˜æ˜ å°„

pmap -x <java_pid> | grep -E "(2048|huge)"
```

---

## 8. ğŸš€ å¤§é¡µå†…å­˜æ€§èƒ½ä¼˜åŒ–



### 8.1 æ•°æ®åº“ä¼˜åŒ–æ¡ˆä¾‹



**ğŸ—„ï¸ MySQLå¤§é¡µé…ç½®**
```bash
# MySQLé…ç½®æ–‡ä»¶æ·»åŠ 

[mysqld]
large-pages = 1

# ç³»ç»Ÿå±‚é¢é…ç½®è¶³å¤Ÿçš„å¤§é¡µ

# MySQL 8GBå†…å­˜éœ€æ±‚è®¡ç®—ï¼š

# 8GB Ã· 2MB = 4096ä¸ªå¤§é¡µ

echo 4096 > /proc/sys/vm/nr_hugepages

# å¯åŠ¨MySQLå¹¶éªŒè¯

mysqld --large-pages &

# æ£€æŸ¥MySQLæ˜¯å¦ä½¿ç”¨å¤§é¡µ

pmap -x $(pgrep mysqld) | grep 2048
```

### 8.2 è™šæ‹ŸåŒ–å¹³å°ä¼˜åŒ–



**ğŸ–¥ï¸ KVMè™šæ‹Ÿæœºå¤§é¡µé…ç½®**
```xml
<!-- libvirtè™šæ‹Ÿæœºé…ç½® -->
<domain>
  <memoryBacking>
    <hugepages>
      <page size='2048' unit='KiB'/>
    </hugepages>
  </memoryBacking>
  <memory unit='GiB'>8</memory>
</domain>
```

```bash
# QEMUå‘½ä»¤è¡Œé…ç½®å¤§é¡µ

qemu-system-x86_64 \
  -mem-path /mnt/hugepages \
  -mem-prealloc \
  -m 8192 \
  ...å…¶ä»–å‚æ•°
```

### 8.3 æ€§èƒ½æµ‹è¯•ä¸ç›‘æ§



**ğŸ“ˆ å¤§é¡µæ€§èƒ½æµ‹è¯•è„šæœ¬**
```bash
#!/bin/bash

# å¤§é¡µæ€§èƒ½å¯¹æ¯”æµ‹è¯•


test_memory_performance() {
    local use_hugepages=$1
    local test_name=$2
    
    echo "=== $test_name ==="
    
#    # å‡†å¤‡æµ‹è¯•ç¯å¢ƒ
    if [ "$use_hugepages" = "true" ]; then
        echo 1024 > /proc/sys/vm/nr_hugepages
        mount -t hugetlbfs none /mnt/hugepages 2>/dev/null
    fi
    
#    # è¿è¡Œå†…å­˜å¯†é›†å‹æµ‹è¯•ç¨‹åº
    time ./memory_test_program
    
#    # æ”¶é›†æ€§èƒ½æŒ‡æ ‡
    echo "TLBç¼ºå¤±ç‡: $(perf stat -e dTLB-load-misses ./memory_test_program 2>&1 | grep dTLB)"
}

# å¯¹æ¯”æµ‹è¯•

test_memory_performance false "æ ‡å‡†4KBé¡µé¢"
test_memory_performance true "2MBå¤§é¡µé¢"
```

**ğŸ” æ€§èƒ½æŒ‡æ ‡ç›‘æ§**
```bash
# ä½¿ç”¨perfå·¥å…·åˆ†æå¤§é¡µæ•ˆæœ

perf stat -e dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads \
  your_application

# ç›‘æ§ç³»ç»Ÿæ•´ä½“å¤§é¡µä½¿ç”¨æƒ…å†µ

watch -n 1 'grep -E "(Huge|AnonHuge)" /proc/meminfo'
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ å¤§é¡µå†…å­˜æœ¬è´¨ï¼šç”¨æ›´å¤§çš„é¡µé¢å‡å°‘é¡µè¡¨é¡¹å’ŒTLBç¼ºå¤±
ğŸ”¸ æ€§èƒ½ä¼˜åŠ¿ï¼šTLBå‘½ä¸­ç‡æå‡ã€å†…å­˜ç®¡ç†å¼€é”€é™ä½
ğŸ”¸ é…ç½®æ–¹å¼ï¼šè¿è¡Œæ—¶é…ç½®å’Œæ°¸ä¹…é…ç½®ä¸¤ç§æ–¹æ³•
ğŸ”¸ ä½¿ç”¨æ¥å£ï¼šhugetlbfsæ–‡ä»¶ç³»ç»Ÿå’Œç¼–ç¨‹API
ğŸ”¸ é€æ˜å¤§é¡µï¼šå†…æ ¸è‡ªåŠ¨åˆå¹¶å°é¡µä¸ºå¤§é¡µçš„æœºåˆ¶
ğŸ”¸ åº”ç”¨åœºæ™¯ï¼šæ•°æ®åº“ã€è™šæ‹ŸåŒ–ã€é«˜æ€§èƒ½è®¡ç®—ç­‰
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ ä½•æ—¶ä½¿ç”¨å¤§é¡µå†…å­˜**
```
é€‚åˆåœºæ™¯ï¼š
âœ… å†…å­˜éœ€æ±‚å¤§(>100MB)çš„åº”ç”¨
âœ… è¿ç»­å†…å­˜è®¿é—®æ¨¡å¼
âœ… å¯¹å»¶è¿Ÿæ•æ„Ÿçš„ç³»ç»Ÿ
âœ… é•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡

ä¸é€‚åˆåœºæ™¯ï¼š
âŒ å°å†…å­˜åº”ç”¨(<10MB)
âŒ é¢‘ç¹forkçš„è¿›ç¨‹
âŒ å†…å­˜è®¿é—®éšæœºåˆ†æ•£
âŒ çŸ­ç”Ÿå‘½å‘¨æœŸç¨‹åº
```

**ğŸ”¹ å¤§é¡µé…ç½®ç­–ç•¥é€‰æ‹©**
```
ä¼ ç»Ÿå¤§é¡µï¼šæ€§èƒ½ç¨³å®šï¼Œéœ€è¦é¢„é…ç½®
é€æ˜å¤§é¡µï¼šä½¿ç”¨ç®€å•ï¼Œæ€§èƒ½æœ‰æ³¢åŠ¨
æ··åˆç­–ç•¥ï¼šå…³é”®åº”ç”¨ç”¨ä¼ ç»Ÿï¼Œå…¶ä»–ç”¨THP
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼



**ğŸ› ï¸ é…ç½®æœ€ä½³å®è·µ**
- **å®¹é‡è§„åˆ’**ï¼šé¢„ç•™20%çš„å¤§é¡µä½œä¸ºç¼“å†²
- **NUMAä¼˜åŒ–**ï¼šåœ¨å¤šèŠ‚ç‚¹ç³»ç»Ÿä¸­å‡åŒ€åˆ†é…å¤§é¡µ
- **ç›‘æ§å‘Šè­¦**ï¼šè®¾ç½®å¤§é¡µä½¿ç”¨ç‡ç›‘æ§ï¼Œé¿å…è€—å°½
- **åº”ç”¨é€‚é…**ï¼šä¿®æ”¹åº”ç”¨ç¨‹åºæ˜ç¡®ä½¿ç”¨å¤§é¡µæ¥å£

**âš¡ æ€§èƒ½è°ƒä¼˜å»ºè®®**
```
æ•°æ®åº“ç³»ç»Ÿï¼š
- MySQL: é…ç½®large-pages=1
- PostgreSQL: è®¾ç½®huge_pages=on
- Redis: ç¦ç”¨THPï¼Œä½¿ç”¨ä¼ ç»Ÿå¤§é¡µ

è™šæ‹ŸåŒ–å¹³å°ï¼š
- ä¸ºè™šæ‹Ÿæœºé¢„åˆ†é…å¤§é¡µå†…å­˜
- ä½¿ç”¨-mem-preallocé¿å…è¿è¡Œæ—¶åˆ†é…
- ç›‘æ§hostå’Œguestçš„å¤§é¡µä½¿ç”¨
```

### 9.4 å­¦ä¹ æ£€æŸ¥æ¸…å•



- [ ] ç†è§£å¤§é¡µå†…å­˜çš„å·¥ä½œåŸç†å’Œä¼˜åŠ¿
- [ ] ä¼šæŸ¥çœ‹ç³»ç»Ÿå¤§é¡µé…ç½®å’Œä½¿ç”¨çŠ¶æ€
- [ ] èƒ½å¤Ÿé…ç½®å’Œç®¡ç†å¤§é¡µå†…å­˜
- [ ] æŒæ¡hugetlbfsæ–‡ä»¶ç³»ç»Ÿä½¿ç”¨
- [ ] äº†è§£é€æ˜å¤§é¡µçš„æœºåˆ¶å’Œé…ç½®
- [ ] èƒ½åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å¤§é¡µå†…å­˜
- [ ] ä¼šè¿›è¡Œå¤§é¡µæ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§

**ğŸ”‘ æ ¸å¿ƒè®°å¿†å£è¯€**
> å¤§é¡µå†…å­˜å‡å°‘ç¢ç‰‡ï¼ŒTLBå‘½ä¸­æ€§èƒ½ä½³
> hugetlbfsæ–‡ä»¶æ˜ å°„ï¼Œé€æ˜å¤§é¡µè‡ªåŠ¨åŒ–
> æ•°æ®åº“è™šæ‹ŸåŒ–é¦–é€‰ï¼Œç›‘æ§é…ç½®è¦è·Ÿä¸Š

**ğŸ’¡ å»¶ä¼¸å­¦ä¹ å»ºè®®**
- æ·±å…¥å­¦ä¹ CPUçš„TLBå’ŒMMUå·¥ä½œæœºåˆ¶
- ç ”ç©¶NUMAæ¶æ„ä¸‹çš„å†…å­˜ä¼˜åŒ–ç­–ç•¥  
- äº†è§£å®¹å™¨ç¯å¢ƒä¸­çš„å¤§é¡µå†…å­˜é…ç½®