---
title: 2、Swap分区创建与配置
---
## 📚 目录

1. [Swap分区基本概念](#1-Swap分区基本概念)
2. [Swap分区大小规划策略](#2-Swap分区大小规划策略)
3. [创建Swap分区实战](#3-创建Swap分区实战)
4. [Swap分区管理操作](#4-Swap分区管理操作)
5. [持久化配置与UUID管理](#5-持久化配置与UUID管理)
6. [多Swap分区管理](#6-多Swap分区管理)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔄 Swap分区基本概念


### 1.1 什么是Swap分区


**💡 通俗理解**
```
想象你的房子（内存RAM）住满了人，这时候有客人来访怎么办？
你可以让一些人先去车库（硬盘上的Swap空间）待着，
等房子有空间了再让他们回来。

Swap分区就是硬盘上专门划出的一块空间，
当内存不够用时，系统把暂时不用的数据"搬"到这里存放。
```

**🔸 核心作用**
- **内存扩展**：当物理内存不足时提供虚拟内存空间
- **系统稳定**：防止因内存耗尽导致程序崩溃
- **休眠支持**：系统休眠时将内存内容保存到Swap分区

**⚠️ 重要理解**
> Swap分区本质上是用硬盘空间模拟内存使用，但速度比真实内存慢很多（约100倍差距）

### 1.2 Swap工作原理


**🔄 内存交换过程**
```
正常情况：程序直接使用物理内存
┌─────────┐    读写    ┌─────────┐
│  程序   │ --------> │  内存   │
└─────────┘           └─────────┘

内存不足时：启用Swap交换
┌─────────┐           ┌─────────┐
│  程序   │ --------> │  内存   │
└─────────┘           └─────────┘
                         ↕️ 交换
                   ┌─────────────┐
                   │  Swap分区   │
                   └─────────────┘
```

**🔸 交换时机**
- 系统内存使用率达到一定阈值（默认约60%）
- 有新程序启动需要内存空间
- 系统判断某些程序长时间未活跃

---

## 2. 📊 Swap分区大小规划策略


### 2.1 传统规划方法


**📋 经典规则**
| 物理内存大小 | 推荐Swap大小 | 适用场景 |
|------------|------------|----------|
| **≤ 2GB** | `内存大小 × 2` | 老旧服务器，内存紧张 |
| **2GB - 8GB** | `内存大小 × 1` | 一般桌面系统 |
| **8GB - 64GB** | `内存大小 ÷ 2` | 现代服务器 |
| **> 64GB** | `4GB - 8GB` | 高内存服务器 |

**🔸 特殊情况考虑**
```
需要休眠功能：Swap ≥ 物理内存大小
• 休眠时需要保存整个内存内容到Swap

大内存服务器：可以不设置Swap
• 32GB以上内存，通常不会用完
• 避免性能下降，直接让程序报内存不足错误

数据库服务器：建议较小Swap或无Swap  
• 数据库程序被交换出去会严重影响性能
• 通过其他方式保证内存充足
```

### 2.2 现代规划建议


**🎯 实用规划策略**
```
桌面用户：
内存 4GB  → Swap 4GB（需要休眠）
内存 8GB  → Swap 2GB（偶尔使用）
内存 16GB → Swap 1GB（紧急缓冲）

服务器用户：
Web服务器  → Swap = 内存 ÷ 4
数据库服务器 → Swap = 1GB 或 无Swap
缓存服务器  → Swap = 内存 ÷ 8
```

---

## 3. 🛠️ 创建Swap分区实战


### 3.1 使用fdisk创建分区


**步骤1：查看现有分区情况**
```bash
# 查看磁盘分区状况
sudo fdisk -l

# 查看当前Swap使用情况
free -h
swapon --show
```

**步骤2：创建新分区**
```bash
# 对/dev/sdb磁盘进行分区（示例）
sudo fdisk /dev/sdb

# fdisk交互式操作流程：
# n     - 创建新分区
# p     - 选择主分区
# 分区号  - 选择分区编号（如3）
# 起始扇区 - 按回车使用默认值
# 结束扇区 - 输入+2G（创建2GB分区）
# t     - 更改分区类型
# 82    - 选择Linux swap类型
# w     - 写入分区表并退出
```

**🔸 操作示例演示**
```
Command (m for help): n
Partition type:
   p   primary (2 primary, 0 extended, 2 free)
   e   extended
Select (default p): p
Partition number (3,4, default 3): 3
First sector: [回车使用默认]
Last sector: +2G

Command (m for help): t
Partition number: 3
Hex code: 82

Command (m for help): w
```

### 3.2 格式化为Swap文件系统


**使用mkswap命令格式化**
```bash
# 格式化刚创建的分区为swap格式
sudo mkswap /dev/sdb3

# 输出示例：
# Setting up swapspace version 1, size = 2 GiB
# no label, UUID=abc12345-6789-def0-1234-56789abcdef0
```

**🔸 重要说明**
> `mkswap`命令相当于给硬盘分区安装"swap文件系统"，让系统知道这块空间是用来做内存交换的

### 3.3 激活Swap分区


**使用swapon激活**
```bash
# 激活新创建的swap分区
sudo swapon /dev/sdb3

# 验证激活结果
swapon --show
free -h
```

**📊 验证结果示例**
```
NAME      TYPE SIZE USED PRIO
/dev/sda2 partition 1G  0B    -2
/dev/sdb3 partition 2G  0B    -3

              total     used     free
Mem:          4.0Gi    1.2Gi    2.8Gi
Swap:         3.0Gi       0B    3.0Gi
```

---

## 4. 🔧 Swap分区管理操作


### 4.1 查看Swap状态


**常用查看命令**
```bash
# 方法1：查看内存和swap总体情况
free -h

# 方法2：详细查看所有swap分区
swapon --show

# 方法3：查看swap详细统计信息
cat /proc/swaps

# 方法4：实时监控内存和swap使用
top
htop
```

**📈 输出解读**
```bash
# free -h 输出解读：
              total     used     free   shared  buff/cache   available
Mem:          7.8Gi    2.1Gi    3.2Gi    156Mi       2.5Gi       5.3Gi
Swap:         2.0Gi       0B    2.0Gi

total：总的swap空间大小
used：已使用的swap空间  
free：剩余可用的swap空间
```

### 4.2 停用Swap分区


**使用swapoff命令**
```bash
# 停用指定的swap分区
sudo swapoff /dev/sdb3

# 停用所有swap分区（谨慎使用）
sudo swapoff -a

# 验证是否成功停用
swapon --show
```

**⚠️ 注意事项**
```
停用swap前确保：
✅ 当前swap使用量为0或很少
✅ 物理内存充足，不会导致程序崩溃
✅ 没有重要程序正在使用swap空间

如果swap正在使用中：
系统会先将数据移回内存，然后才停用分区
如果内存不足以容纳所有数据，停用操作会失败
```

### 4.3 重新激活Swap


**灵活的激活管理**
```bash
# 激活指定分区
sudo swapon /dev/sdb3

# 激活所有在/etc/fstab中配置的swap
sudo swapon -a

# 设置优先级激活（数字越大优先级越高）
sudo swapon /dev/sdb3 -p 10
```

---

## 5. 🔗 持久化配置与UUID管理


### 5.1 /etc/fstab配置文件


**💡 什么是/etc/fstab**
```
/etc/fstab是Linux系统的"开机自动挂载清单"
系统启动时会自动读取这个文件，按照配置挂载各种分区
包括普通分区、swap分区、网络存储等

如果不配置fstab，每次重启后都需要手动swapon激活swap
```

**📝 fstab基本格式**
```
设备标识  挂载点  文件系统类型  挂载选项  转储  检查
/dev/sdb3  none   swap        defaults   0    0
```

**🔸 字段含义详解**
- **设备标识**：可以是设备名、UUID或LABEL
- **挂载点**：swap分区固定写`none`
- **文件系统类型**：swap分区固定写`swap`
- **挂载选项**：通常写`defaults`
- **转储**：是否备份，swap写0
- **检查**：是否检查，swap写0

### 5.2 UUID标识的优势


**🆔 获取UUID信息**
```bash
# 查看所有分区的UUID
sudo blkid

# 只查看swap分区的UUID
sudo blkid | grep swap

# 输出示例：
# /dev/sdb3: UUID="abc12345-6789-def0-1234-56789abcdef0" TYPE="swap"
```

**🔸 UUID vs 设备名对比**
| 标识方式 | 优点 | 缺点 | 适用场景 |
|---------|------|------|----------|
| **设备名** | `简单直观` | 硬盘顺序改变会失效 | 固定硬件环境 |
| **UUID** | `永久唯一，不受硬盘顺序影响` | 看起来复杂 | 生产环境推荐 |
| **LABEL** | `自定义名称，易记` | 需要手动设置 | 个人偏好 |

### 5.3 配置持久化挂载


**编辑fstab文件**
```bash
# 备份原文件（重要）
sudo cp /etc/fstab /etc/fstab.backup

# 编辑fstab文件
sudo nano /etc/fstab
```

**添加swap配置**
```bash
# 使用UUID方式（推荐）
UUID=abc12345-6789-def0-1234-56789abcdef0  none  swap  defaults  0  0

# 使用设备名方式
/dev/sdb3  none  swap  defaults  0  0

# 使用LABEL方式（需要先设置label）
LABEL=myswap  none  swap  defaults  0  0
```

**🔄 测试配置**
```bash
# 先停用所有swap
sudo swapoff -a

# 重新加载fstab中的swap配置
sudo swapon -a

# 验证是否成功
swapon --show
```

### 5.4 设置LABEL标识


**创建有意义的标签**
```bash
# 为swap分区设置标签（分区必须先停用）
sudo swapoff /dev/sdb3
sudo mkswap -L myswap /dev/sdb3
sudo swapon /dev/sdb3

# 验证标签设置
sudo blkid | grep myswap
```

---

## 6. 🔀 多Swap分区管理


### 6.1 多Swap的应用场景


**📋 实际需求场景**
```
场景1：分阶段扩容
• 系统初期swap空间较小
• 后期增加新硬盘，添加更多swap

场景2：不同性能需求
• SSD上的小swap：高速响应
• 机械硬盘上的大swap：大容量存储

场景3：负载均衡
• 多个swap分区可以并行工作
• 提高整体交换性能
```

### 6.2 Swap优先级管理


**🎯 优先级概念**
```
Linux允许为不同swap分区设置优先级（priority）
优先级范围：-1 到 32767
数字越大优先级越高，系统优先使用高优先级的swap

默认优先级：-1（最低）
相同优先级：系统会并行使用（轮询方式）
```

**设置优先级示例**
```bash
# 激活时指定优先级
sudo swapon /dev/sdb3 -p 10    # 高优先级
sudo swapon /dev/sdc1 -p 5     # 低优先级

# 在fstab中设置优先级
UUID=abc123...  none  swap  defaults,pri=10  0  0
UUID=def456...  none  swap  defaults,pri=5   0  0
```

### 6.3 多Swap分区监控


**查看多分区状态**
```bash
# 详细查看所有swap分区
swapon --show

# 示例输出：
NAME      TYPE      SIZE USED PRIO
/dev/sda2 partition 1.9G   0B   -2
/dev/sdb3 partition 2.0G   0B   10
/dev/sdc1 partition 1.0G   0B    5

# 查看实时使用情况
cat /proc/swaps
```

**📊 使用策略**
```
推荐配置：
1. SSD小swap：高优先级（pri=10），用于频繁交换
2. 机械硬盘大swap：低优先级（pri=1），用于大量数据

实际效果：
系统会优先使用SSD上的快速swap
当SSD swap用完后，才使用机械硬盘swap
```

### 6.4 管理多个Swap的技巧


**批量操作命令**
```bash
# 批量激活所有fstab中的swap
sudo swapon -a

# 批量停用所有swap
sudo swapoff -a

# 只激活某个优先级的swap
sudo swapon -p 10 /dev/sdb3
```

**🔧 维护策略**
```
定期检查：
• 检查各个swap分区的使用情况
• 确认优先级设置是否合理
• 监控是否有分区故障

性能优化：
• SSD分区设置较高优先级
• 将不同swap分区放在不同物理硬盘上
• 避免swap分区与系统分区在同一硬盘
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的基本操作


```
🔸 创建流程：fdisk分区 → mkswap格式化 → swapon激活
🔸 管理命令：swapon激活、swapoff停用、free查看状态
🔸 持久化配置：编辑/etc/fstab，使用UUID标识
🔸 大小规划：根据内存大小和使用场景合理规划
🔸 多分区管理：利用优先级实现分层使用策略
```

### 7.2 关键理解要点


**🔹 Swap的本质**
```
Swap本质是用硬盘空间扩展内存
优点：防止内存不足导致系统崩溃
缺点：访问速度比真实内存慢很多（约100倍）
```

**🔹 合理规划的重要性**
```
太小：起不到缓解内存压力的作用
太大：浪费硬盘空间，交换时间过长
刚好：根据实际需求和硬件配置合理设置
```

**🔹 UUID的价值**
```
设备名会因硬盘顺序改变而变化
UUID是分区的唯一标识，永远不变
生产环境必须使用UUID，避免系统启动失败
```

### 7.3 实际应用指导


**🎯 不同场景的最佳实践**
```
个人桌面：
• 4-8GB内存：设置2-4GB swap
• 需要休眠功能：swap ≥ 内存大小
• 使用SSD：设置较小swap减少磨损

Web服务器：
• 16GB以上内存：设置2-4GB swap作为缓冲
• 使用高速存储：提高交换效率
• 监控swap使用率，超过50%需要加内存

数据库服务器：
• 大内存服务器：建议不设swap或设很小
• 避免数据库进程被交换出内存
• 通过参数优化减少内存使用
```

**🔧 日常维护要点**
```
定期监控：
✅ 使用 free -h 查看swap使用情况
✅ 使用 swapon --show 检查分区状态
✅ 通过 top/htop 观察哪些进程使用swap

性能优化：
✅ 调整swappiness值控制交换频率
✅ 使用SSD作为swap提高速度
✅ 多个swap分区设置合理优先级

故障处理：
✅ swap使用率过高：增加物理内存
✅ swap分区故障：准备备用分区
✅ 系统响应慢：检查是否大量使用swap
```

### 7.4 常见问题与解决


**❓ 为什么系统有很多内存但还是使用swap？**
```
原因：Linux内核的swap策略比较激进
解决：调整 /proc/sys/vm/swappiness 参数
• 默认值60，可以调整到10-20
• 数值越小，越不倾向于使用swap
```

**❓ swap分区损坏怎么办？**
```
应急处理：
1. swapoff 停用损坏的分区
2. 从 /etc/fstab 中注释掉该分区
3. 重启系统验证不影响启动
4. 创建新的swap分区替换
```

**核心记忆口诀**：
- fdisk建分区，mkswap来格式化
- swapon激活用，swapoff能停下
- fstab配持久，UUID最可靠
- 大小要合理，优先级要分化