---
title: 4、Swap优先级与策略配置
---
## 📚 目录

1. [Swap优先级基本概念](#1-swap优先级基本概念)
2. [优先级配置与管理](#2-优先级配置与管理)
3. [多Swap设备策略](#3-多swap设备策略)
4. [性能优化配置](#4-性能优化配置)
5. [实际应用场景](#5-实际应用场景)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🎯 Swap优先级基本概念


### 1.1 什么是Swap优先级


**💡 简单理解**：就像医院的挂号一样，有普通号和专家号，Linux的Swap也有优先级之分。

```
现实中的排队：              Linux Swap优先级：
VIP通道 → 优先服务          高优先级Swap → 优先使用
普通通道 → 按序等候         低优先级Swap → 备用补充
```

**🔸 核心作用**
- **使用顺序**：决定系统先用哪个swap分区
- **性能优化**：让快速存储设备优先工作  
- **负载分配**：合理分配多个swap设备的工作量
- **故障保障**：主要swap出问题时自动切换备用

### 1.2 优先级数值含义


**📊 优先级规则**
```
数值范围：-1 到 32767
数值越大 = 优先级越高 = 越先使用

优先级示例：
32767 ← 最高优先级（超快SSD）
  100 ← 高优先级（普通SSD）
   10 ← 中等优先级（机械硬盘）
    0 ← 默认优先级
   -1 ← 最低优先级（网络存储）
```

**⚠️ 特殊说明**
- **默认值**：新建swap默认优先级为 `-1`
- **相同优先级**：系统会轮流使用（负载均衡）
- **-1的特殊性**：表示最低优先级，所有正数优先级都比它高

---

## 2. 🔧 优先级配置与管理


### 2.1 查看当前Swap信息


**🔍 使用 `/proc/swaps` 查看**
```bash
# 查看所有swap设备及其优先级
cat /proc/swaps
```

**输出示例解读**：
```
Filename                Type        Size     Used    Priority
/dev/sda2              partition   2097148    0        -2
/dev/sdb1              partition   4194300    256      10
/swapfile              file        1048572    0        5
```

**📋 字段含义**：
- **Filename**：swap设备路径
- **Type**：类型（partition分区 / file文件）
- **Size**：总容量（KB）
- **Used**：已使用（KB）  
- **Priority**：当前优先级

### 2.2 使用swapon设置优先级


**🎛️ swapon命令详解**

**基本语法**：
```bash
swapon -p <优先级> <设备路径>
```

**实际操作示例**：
```bash
# 以优先级15启用swap分区
sudo swapon -p 15 /dev/sdb1

# 以优先级20启用swap文件  
sudo swapon -p 20 /swapfile

# 启用所有fstab中的swap（使用配置的优先级）
sudo swapon -a
```

### 2.3 永久配置优先级


**📝 修改 `/etc/fstab` 文件**

**配置格式**：
```
设备路径  none  swap  sw,pri=优先级  0  0
```

**实际配置示例**：
```bash
# 编辑fstab文件
sudo vim /etc/fstab

# 添加或修改swap条目
/dev/sda2    none    swap    sw,pri=10     0  0
/dev/sdb1    none    swap    sw,pri=20     0  0  
/swapfile    none    swap    sw,pri=15     0  0
```

**🔄 应用配置**：
```bash
# 关闭所有swap
sudo swapoff -a

# 重新启用（读取fstab配置）
sudo swapon -a

# 验证优先级设置
cat /proc/swaps
```

---

## 3. ⚖️ 多Swap设备策略


### 3.1 并行使用 vs 顺序使用


**🔸 相同优先级 = 并行使用（负载均衡）**
```
设备配置：
/dev/sda2  优先级: 10
/dev/sdb1  优先级: 10  
/dev/sdc1  优先级: 10

使用策略：
┌─────────┐  ┌─────────┐  ┌─────────┐
│ sda2    │  │ sdb1    │  │ sdc1    │
│ 33%负载 │  │ 33%负载 │  │ 33%负载 │
└─────────┘  └─────────┘  └─────────┘
     ↑           ↑           ↑
   轮流分配数据块，实现负载均衡
```

**🔸 不同优先级 = 顺序使用**
```
设备配置：
/dev/sda2  优先级: 20 (高)
/dev/sdb1  优先级: 10 (中)  
/dev/sdc1  优先级: 5  (低)

使用策略：
┌─────────┐    ┌─────────┐    ┌─────────┐
│ sda2    │    │ sdb1    │    │ sdc1    │
│ 先用完  │ →  │ 再使用  │ →  │ 最后用  │
└─────────┘    └─────────┘    └─────────┘
```

### 3.2 实际应用策略


**🏆 推荐配置方案**

**方案一：性能分层**
```bash
# 高速SSD - 最高优先级
/dev/nvme0n1p2  none  swap  sw,pri=100  0  0

# 普通SSD - 中等优先级  
/dev/sda2       none  swap  sw,pri=50   0  0

# 机械硬盘 - 低优先级备用
/dev/sdb2       none  swap  sw,pri=10   0  0
```

**方案二：负载均衡**
```bash
# 多个相同性能设备，均衡使用
/dev/sda2  none  swap  sw,pri=20  0  0
/dev/sdb2  none  swap  sw,pri=20  0  0  
/dev/sdc2  none  swap  sw,pri=20  0  0
```

---

## 4. 🚀 性能优化配置


### 4.1 RAID条带化Swap配置


**💡 什么是RAID条带化**：把数据分散写入多个硬盘，提高读写速度

**🔧 配置步骤**：

**第一步：创建RAID0阵列**
```bash
# 创建RAID0（条带化）
sudo mdadm --create /dev/md0 --level=0 --raid-devices=2 /dev/sdb /dev/sdc

# 查看RAID状态
cat /proc/mdstat
```

**第二步：在RAID上创建swap**
```bash
# 在RAID设备上创建swap
sudo mkswap /dev/md0

# 启用RAID swap
sudo swapon -p 30 /dev/md0
```

**第三步：永久配置**
```bash
# 添加到fstab
echo "/dev/md0  none  swap  sw,pri=30  0  0" | sudo tee -a /etc/fstab
```

### 4.2 存储类型性能对比


| 存储类型 | **读写速度** | **建议优先级** | **适用场景** |
|---------|-------------|---------------|-------------|
| **NVMe SSD** | `>3000MB/s` | `pri=100` | 主力swap，性能要求高 |
| **SATA SSD** | `~500MB/s` | `pri=50` | 常用swap，平衡性能 |
| **机械硬盘** | `~150MB/s` | `pri=10` | 备用swap，成本考虑 |
| **网络存储** | `<100MB/s` | `pri=1` | 应急swap，特殊需求 |

### 4.3 优化配置建议


**⚡ 性能调优参数**

**vm.swappiness调整**：
```bash
# 查看当前swappiness值
cat /proc/sys/vm/swappiness

# 临时调整（值越小越不愿意使用swap）
echo 10 | sudo tee /proc/sys/vm/swappiness

# 永久配置
echo "vm.swappiness=10" | sudo tee -a /etc/sysctl.conf
```

**🔸 swappiness值指导**：
- **0-10**：尽量使用物理内存，swap作为最后手段
- **60**：系统默认值，平衡使用
- **100**：积极使用swap

---

## 5. 📋 实际应用场景


### 5.1 场景一：高性能服务器


**🎯 需求**：数据库服务器，要求极高的swap响应速度

**配置方案**：
```bash
# 主swap：高速NVMe
/dev/nvme0n1p2  none  swap  sw,pri=100  0  0

# 备用swap：RAID0机械盘阵列  
/dev/md0        none  swap  sw,pri=10   0  0

# 调优参数
echo "vm.swappiness=1" >> /etc/sysctl.conf
```

### 5.2 场景二：开发测试环境


**🎯 需求**：多用户开发环境，需要稳定的swap保障

**配置方案**：
```bash
# 负载均衡：多个SSD并行工作
/dev/sda2  none  swap  sw,pri=20  0  0
/dev/sdb2  none  swap  sw,pri=20  0  0

# 备用保障：大容量机械盘
/dev/sdc2  none  swap  sw,pri=5   0  0
```

### 5.3 场景三：资源受限环境


**🎯 需求**：单硬盘系统，最大化利用有限资源

**配置方案**：
```bash
# 主分区swap
/dev/sda2   none  swap  sw,pri=15  0  0

# swap文件作为扩展
/swapfile   none  swap  sw,pri=10  0  0

# 适中的swappiness
echo "vm.swappiness=30" >> /etc/sysctl.conf
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的关键概念


```
🔸 优先级数值：-1到32767，数值越大优先级越高
🔸 查看命令：cat /proc/swaps 显示所有swap信息
🔸 设置命令：swapon -p <优先级> <设备> 临时设置
🔸 永久配置：/etc/fstab 中使用 pri=数值 参数
🔸 使用策略：相同优先级并行，不同优先级顺序
```

### 6.2 实用操作要点


**🔹 日常管理命令**
```bash
# 查看swap状态
cat /proc/swaps

# 关闭指定swap  
sudo swapoff /dev/sdb1

# 重启所有swap
sudo swapoff -a && sudo swapon -a
```

**🔹 配置最佳实践**
- **高速设备**：设置高优先级（pri=50-100）
- **相同设备**：设置相同优先级实现负载均衡  
- **备用设备**：设置低优先级（pri=1-10）
- **网络存储**：谨慎使用，优先级最低

### 6.3 性能优化指导


**⚡ 关键调优思路**：
1. **存储分层**：快速设备优先，慢速设备备用
2. **负载均衡**：多个同速设备并行工作
3. **容量规划**：总swap容量 = 物理内存 × 1-2倍
4. **监控调整**：根据实际使用情况调整优先级

**📊 效果验证方法**：
```bash
# 监控swap使用情况
watch -n 1 'cat /proc/swaps'

# 观察内存和swap状态  
free -h

# 系统负载监控
iostat -x 1
```

### 6.4 故障排查要点


**🔧 常见问题解决**：

> ⚠️ **问题**：swap优先级设置后不生效
> 
> **解决**：检查fstab语法，使用 `mount -a` 验证配置

> ⚠️ **问题**：多swap设备没有负载均衡  
>
> **解决**：确保设备优先级完全相同

> ⚠️ **问题**：swap性能不理想
>
> **解决**：检查存储设备性能，调整swappiness值

**核心记忆口诀**：
- 优先级高数值大，快速设备排在前
- 相同优先级能均衡，不同优先级按序来  
- 性能分层是关键，监控调优保稳定