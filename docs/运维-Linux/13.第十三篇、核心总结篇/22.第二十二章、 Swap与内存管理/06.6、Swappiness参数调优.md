---
title: 6、Swappiness参数调优
---
## 📚 目录

1. [Swappiness参数基础概念](#1-swappiness参数基础概念)
2. [参数取值范围与影响机制](#2-参数取值范围与影响机制)
3. [临时修改swappiness设置](#3-临时修改swappiness设置)
4. [永久配置方法详解](#4-永久配置方法详解)
5. [不同应用场景的最佳值](#5-不同应用场景的最佳值)
6. [桌面与服务器配置差异](#6-桌面与服务器配置差异)
7. [实时监控swappiness效果](#7-实时监控swappiness效果)
8. [动态调整策略与实践](#8-动态调整策略与实践)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔧 Swappiness参数基础概念


### 1.1 什么是vm.swappiness参数


**基础定义**
vm.swappiness是Linux内核的一个重要参数，用来控制系统在内存紧张时使用swap分区的倾向性。简单理解：**这个数值决定了系统是更愿意把数据放到swap里，还是更愿意清理缓存来释放内存**。

**工作原理图示**
```
内存使用情况判断流程：

应用程序需要内存
        ↓
   当前内存不足？
        ↓
    swappiness值判断
   /              \
高值(60-100)      低值(0-10)
优先使用swap      优先清理缓存
   ↓                ↓
将程序数据         清理文件缓存
写入swap分区       和buffer缓存
```

### 1.2 参数的核心作用机制


**内存回收的两种策略**
当系统内存不足时，Linux有两种主要的内存回收方式：

1. **匿名页回收**：将程序占用的内存数据写入swap分区
2. **文件页回收**：清理文件系统缓存和缓冲区数据

swappiness参数就是在这两种策略之间进行权衡的调节器。

### 1.3 参数在系统中的位置


**参数文件位置**
```bash
# 查看当前swappiness值
cat /proc/sys/vm/swappiness

# 或者使用sysctl命令
sysctl vm.swappiness
```

这个参数存储在内核的虚拟文件系统中，属于vm（虚拟内存）子系统的配置项。

---

## 2. 📊 参数取值范围与影响机制


### 2.1 数值范围与含义


**取值范围：0-200**

| 数值范围 | **行为特征** | **适用场景** | **影响描述** |
|---------|-------------|-------------|-------------|
| **0** | `禁用swap使用` | `特殊需求场景` | `除非内存耗尽否则不使用swap` |
| **1-10** | `最小化swap使用` | `性能敏感应用` | `优先清理缓存，极少使用swap` |
| **10-30** | `保守使用swap` | `服务器环境` | `平衡缓存清理和swap使用` |
| **30-60** | `适中平衡模式` | `一般桌面应用` | `根据实际需要灵活选择` |
| **60-100** | `积极使用swap` | `内存受限环境` | `较早开始使用swap分区` |
| **100+** | `优先使用swap` | `特殊测试环境` | `大量使用swap，可能影响性能` |

### 2.2 数值对系统行为的具体影响


**低swappiness值的表现（1-20）**
- 系统会尽可能保持程序数据在物理内存中
- 当内存紧张时，优先清理文件缓存和缓冲区
- 磁盘IO主要用于清理缓存，而非swap读写
- 适合对响应时间要求严格的应用

**高swappiness值的表现（60-100）**
- 系统更容易将不活跃的程序数据移到swap
- 保留更多内存用于文件系统缓存
- 可能出现程序切换时的延迟（从swap加载数据）
- 适合需要大量文件IO操作的场景

### 2.3 内核版本差异


**不同内核版本的默认值**
- **传统Linux**：默认值通常为60
- **现代发行版**：很多调整为10-30的较低值
- **容器环境**：可能根据使用场景预设不同值

```bash
# 查看系统默认值
sysctl vm.swappiness

# 查看内核版本
uname -r
```

---

## 3. ⚙️ 临时修改swappiness设置


### 3.1 使用sysctl命令临时修改


**基本修改命令**
```bash
# 临时设置swappiness为10
sudo sysctl vm.swappiness=10

# 验证修改结果
sysctl vm.swappiness
```

这种修改方式的特点：
- **立即生效**：无需重启系统
- **临时性质**：系统重启后恢复默认值
- **适用场景**：测试不同参数值的效果

### 3.2 直接写入proc文件系统


**另一种临时修改方法**
```bash
# 直接修改内核参数文件
echo 10 | sudo tee /proc/sys/vm/swappiness

# 检查修改结果
cat /proc/sys/vm/swappiness
```

### 3.3 临时修改的验证方法


**观察系统响应变化**
```bash
# 修改前记录当前内存状态
free -h
cat /proc/meminfo | grep -E "SwapTotal|SwapUsed|SwapFree"

# 修改swappiness值
sudo sysctl vm.swappiness=5

# 运行一些内存密集型程序观察变化
# 可以用以下命令模拟内存压力
stress --vm 2 --vm-bytes 1G --timeout 60s
```

**实时监控效果**
```bash
# 使用watch命令持续观察
watch -n 1 'free -h && echo "Swappiness: $(cat /proc/sys/vm/swappiness)"'
```

---

## 4. 💾 永久配置方法详解


### 4.1 修改/etc/sysctl.conf文件


**标准永久配置方法**
```bash
# 备份原始配置文件
sudo cp /etc/sysctl.conf /etc/sysctl.conf.backup

# 编辑配置文件
sudo vim /etc/sysctl.conf

# 在文件末尾添加以下行
vm.swappiness=10
```

**配置文件示例**
```bash
# /etc/sysctl.conf 相关部分
# Kernel sysctl configuration file

# 内存管理相关配置
vm.swappiness=10
vm.dirty_background_ratio=5
vm.dirty_ratio=10
```

### 4.2 使用sysctl.d目录管理


**现代Linux系统推荐的方法**
```bash
# 创建专门的配置文件
sudo vim /etc/sysctl.d/99-swappiness.conf

# 文件内容
vm.swappiness=10
```

这种方法的优势：
- **模块化管理**：不同配置分开存放
- **版本兼容性**：新版本系统的标准做法
- **易于维护**：可以针对特定配置进行管理

### 4.3 配置生效方法


**使配置立即生效**
```bash
# 重新加载sysctl配置
sudo sysctl -p

# 或者指定特定配置文件
sudo sysctl -p /etc/sysctl.d/99-swappiness.conf

# 验证配置是否生效
sysctl vm.swappiness
```

### 4.4 配置验证与排错


**检查配置是否正确**
```bash
# 检查语法错误
sudo sysctl -p 2>&1 | grep -i error

# 查看所有vm相关参数
sysctl -a | grep vm.

# 测试重启后配置持久性
# 重启系统后执行
sysctl vm.swappiness
```

---

## 5. 🎯 不同应用场景的最佳值


### 5.1 数据库服务器环境


**推荐配置：swappiness=1**

数据库服务器的特殊需求：
- **内存密集性**：数据库缓存池需要稳定的内存访问
- **响应时间敏感**：查询延迟直接影响业务性能
- **IO模式特殊**：数据库有自己的缓存管理机制

```bash
# 数据库服务器配置示例
vm.swappiness=1
vm.dirty_background_ratio=3
vm.dirty_ratio=15
```

**配置理由说明**
- 将swappiness设置为1而非0，避免在极端内存不足时系统假死
- 让数据库管理自己的内存缓存，而非依赖系统文件缓存
- 减少swap使用，避免数据库操作因swap IO导致的延迟

### 5.2 Web服务器环境


**推荐配置：swappiness=10-20**

Web服务器的典型特征：
- **并发连接多**：需要为大量连接保持内存
- **静态文件服务**：受益于文件系统缓存
- **动态内容生成**：PHP、Python等进程需要稳定内存

| 服务类型 | **推荐值** | **配置说明** |
|---------|-----------|-------------|
| **Nginx + 静态文件** | `15-20` | `保留文件缓存提升性能` |
| **Apache + PHP** | `10-15` | `平衡进程内存和缓存需求` |
| **Node.js应用** | `5-10` | `保证V8引擎内存稳定性` |

### 5.3 桌面工作站环境


**推荐配置：swappiness=10-30**

桌面环境的使用模式：
- **交互式应用**：用户界面响应速度重要
- **多媒体处理**：大文件操作需要缓存支持
- **多任务切换**：程序间频繁切换

**根据使用习惯调整**
- **开发者桌面**：swappiness=10（代码编译、IDE使用）
- **办公桌面**：swappiness=20（文档处理、浏览器）
- **多媒体桌面**：swappiness=30（视频编辑、图像处理）

### 5.4 虚拟化环境


**虚拟机配置：swappiness=1-5**

虚拟化环境的特殊考虑：
- **资源竞争**：多个虚拟机共享物理资源
- **嵌套swap**：避免宿主机和虚拟机同时使用swap
- **性能隔离**：减少swap造成的性能抖动

```bash
# 虚拟机优化配置
vm.swappiness=1
vm.vfs_cache_pressure=50
vm.min_free_kbytes=65536
```

---

## 6. 💻 桌面与服务器配置差异


### 6.1 桌面系统的内存使用特点


**桌面环境内存模式**
```
用户行为驱动的内存使用：

活跃应用程序
    ↓
GUI界面组件（占用大量内存）
    ↓
后台服务进程
    ↓
系统缓存（文件浏览、媒体缓存）
```

**桌面系统推荐配置**
- **轻量级桌面**（XFCE、LXDE）：swappiness=20-30
- **标准桌面**（GNOME、KDE）：swappiness=10-20
- **游戏/多媒体桌面**：swappiness=5-15

### 6.2 服务器系统的内存使用特点


**服务器环境内存模式**
```
服务导向的内存使用：

核心服务进程（固定内存需求）
    ↓
连接池和缓存（可预测的内存模式）
    ↓
系统缓存（IO密集型应用受益）
    ↓
监控和日志服务
```

**服务器系统推荐配置**

| 服务器类型 | **Swappiness值** | **配置重点** |
|-----------|-----------------|-------------|
| **数据库服务器** | `1-5` | `最小化swap，保证查询性能` |
| **Web服务器** | `10-20` | `平衡缓存和应用内存` |
| **文件服务器** | `20-30` | `重视文件系统缓存` |
| **计算服务器** | `5-10` | `保证计算任务内存稳定` |

### 6.3 配置差异的技术原因


**桌面vs服务器的关键差异**

**响应时间要求不同**
- 桌面：用户交互需要即时响应，短暂的swap延迟用户能感知
- 服务器：批量处理任务可以容忍一定的延迟

**内存使用模式不同**
- 桌面：程序启动关闭频繁，内存需求变化大
- 服务器：长期运行进程，内存需求相对稳定

**IO特征不同**
- 桌面：随机小文件访问多，缓存命中率相对较低
- 服务器：大文件顺序访问多，文件缓存效果明显

---

## 7. 📈 实时监控swappiness效果


### 7.1 基础监控命令


**内存和swap使用情况监控**
```bash
# 实时查看内存使用
watch -n 2 'free -h'

# 查看详细内存信息
cat /proc/meminfo | grep -E "MemTotal|MemFree|MemAvailable|SwapTotal|SwapUsed|SwapFree|Cached|Buffers"

# 查看当前swappiness设置
sysctl vm.swappiness
```

**进程级内存使用监控**
```bash
# 按内存使用排序显示进程
ps aux --sort=-%mem | head -20

# 显示swap使用最多的进程
for file in /proc/*/status; do awk '/VmSwap|Name/{printf $2 " " $3}END{ print ""}' $file; done | sort -k 2 -nr | head -10
```

### 7.2 高级监控脚本


**自定义监控脚本示例**
```bash
#!/bin/bash
# swap_monitor.sh - Swappiness效果监控脚本

monitor_swap_effect() {
    echo "=== Swap使用监控 $(date) ==="
    echo "当前Swappiness值: $(cat /proc/sys/vm/swappiness)"
    echo
    
    # 内存概况
    echo "内存使用概况："
    free -h | grep -E "Mem|Swap"
    echo
    
    # swap使用率计算
    swap_total=$(awk '/SwapTotal/ {print $2}' /proc/meminfo)
    swap_used=$(awk '/SwapUsed/ {print $2}' /proc/meminfo)
    if [ $swap_total -gt 0 ]; then
        swap_percent=$(echo "scale=2; $swap_used * 100 / $swap_total" | bc)
        echo "Swap使用率: ${swap_percent}%"
    else
        echo "未配置Swap分区"
    fi
    
    echo "----------------------------------------"
}

# 持续监控模式
while true; do
    monitor_swap_effect
    sleep 30
done
```

### 7.3 性能影响分析


**IO性能监控**
```bash
# 监控磁盘IO情况
iostat -x 1 5

# 查看swap分区的IO统计
cat /proc/swaps
```

**系统负载监控**
```bash
# 系统负载平均值
uptime

# 详细的系统资源使用
vmstat 1 10

# 内存压力和回收统计
cat /proc/vmstat | grep -E "pgpgin|pgpgout|pswpin|pswpout"
```

### 7.4 监控数据的解读


**关键指标含义**
- **pswpin/pswpout**：swap读取/写入页数，数值增长表明swap活跃
- **pgpgin/pgpgout**：页面读取/写出总数，包含文件和swap
- **内存可用性**：MemAvailable比MemFree更准确反映可用内存

**性能评估标准**
- swap使用率持续低于10%：配置合理
- swap IO频繁且系统负载高：可能需要降低swappiness
- 内存不足但swap使用很少：可能需要适当提高swappiness

---

## 8. 🔄 动态调整策略与实践


### 8.1 基于负载的动态调整


**负载感知调整策略**
不同的系统负载情况下，最优的swappiness值可能不同。可以根据系统运行状态动态调整：

**高负载时期（CPU使用率>80%）**
- 降低swappiness至5-10
- 减少swap IO对系统性能的影响
- 优先保证活跃进程的内存访问

**低负载时期（CPU使用率<30%）**
- 可适当提高swappiness至20-30
- 利用空闲时间进行内存整理
- 为未来的负载高峰预留物理内存

### 8.2 基于应用场景的切换脚本


**场景切换脚本示例**
```bash
#!/bin/bash
# swappiness_switch.sh - 场景化swappiness配置脚本

set_development_mode() {
    echo "设置开发环境模式..."
    sysctl vm.swappiness=5
    echo "Swappiness设置为5 - 优化编译和IDE性能"
}

set_server_mode() {
    echo "设置服务器模式..."
    sysctl vm.swappiness=10
    echo "Swappiness设置为10 - 平衡服务性能和资源利用"
}

set_desktop_mode() {
    echo "设置桌面环境模式..."
    sysctl vm.swappiness=20
    echo "Swappiness设置为20 - 优化用户交互体验"
}

case "$1" in
    dev|development)
        set_development_mode
        ;;
    server|srv)
        set_server_mode
        ;;
    desktop|gui)
        set_desktop_mode
        ;;
    *)
        echo "使用方法: $0 {dev|server|desktop}"
        echo "当前swappiness值: $(sysctl vm.swappiness)"
        ;;
esac
```

### 8.3 自动化调整方案


**基于内存压力的自动调整**
```bash
#!/bin/bash
# auto_swappiness.sh - 自动swappiness调整脚本

get_memory_pressure() {
    # 获取内存使用百分比
    local mem_percent=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
    echo $mem_percent
}

adjust_swappiness() {
    local mem_pressure=$(get_memory_pressure)
    local current_swappiness=$(cat /proc/sys/vm/swappiness)
    local new_swappiness=$current_swappiness
    
    if [ $mem_pressure -gt 80 ]; then
        # 内存压力大，降低swappiness
        new_swappiness=5
    elif [ $mem_pressure -lt 50 ]; then
        # 内存充足，可以适当提高swappiness
        new_swappiness=20
    else
        # 中等内存压力，使用中等值
        new_swappiness=10
    fi
    
    if [ $new_swappiness -ne $current_swappiness ]; then
        echo "内存压力: ${mem_pressure}%, 调整swappiness: ${current_swappiness} -> ${new_swappiness}"
        sysctl vm.swappiness=$new_swappiness
    fi
}

# 定期检查并调整
while true; do
    adjust_swappiness
    sleep 300  # 每5分钟检查一次
done
```

### 8.4 调整效果的验证方法


**性能基准测试**
```bash
# 调整前后的性能对比测试

# 内存分配测试
time stress --vm 1 --vm-bytes 2G --timeout 60s

# 编译性能测试（如果是开发环境）
time make -j$(nproc) clean all

# 文件IO测试
time dd if=/dev/zero of=testfile bs=1M count=1000
```

**长期效果监控**
- 记录调整前后的系统负载变化
- 观察应用程序响应时间的改善
- 统计swap使用频率和IO活动的变化

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的基本概念


```
🔸 swappiness本质：控制内存回收策略的权衡参数
🔸 取值影响：0-200范围，数值越低越少使用swap
🔸 配置方法：临时修改（sysctl）和永久配置（sysctl.conf）
🔸 应用差异：桌面、服务器、数据库需要不同的配置策略
🔸 监控验证：通过内存使用和性能指标评估调整效果
```

### 9.2 关键理解要点


**🔹 swappiness不是开关，而是倾向性**
很多人误解swappiness为开关参数，实际上它是一个权衡参数：
- 低值：优先清理文件缓存来释放内存
- 高值：优先将不活跃数据移到swap分区
- 系统会根据实际情况和这个倾向性做决定

**🔹 没有万能的最佳值**
最佳的swappiness值取决于：
- 硬件配置（内存大小、存储类型）
- 应用类型（数据库、Web、桌面应用）
- 使用模式（交互式、批处理、服务后台）

**🔹 需要结合实际监控来调整**
理论推荐值只是起点，实际优化需要：
- 监控系统在不同负载下的表现
- 测试不同swappiness值的效果
- 根据具体应用场景进行微调

### 9.3 实践建议与最佳做法


**💡 调优流程建议**
1. **确定基准**：记录当前系统的性能表现
2. **选择初始值**：根据应用类型选择推荐的起始值
3. **逐步测试**：小幅度调整并观察效果
4. **长期验证**：在真实负载下运行一段时间
5. **文档记录**：记录最终配置和调整理由

**⚠️ 常见误区避免**
- **误区1**：认为swappiness=0就完全不用swap
- **误区2**：盲目设置极端值（如100+）而不测试效果
- **误区3**：一次性调整多个内存相关参数，难以定位效果
- **误区4**：忽视硬件差异（SSD vs 机械硬盘）对最佳值的影响

### 9.4 不同场景的快速配置参考


| 使用场景 | **推荐swappiness** | **配置重点** | **监控要点** |
|---------|-------------------|-------------|-------------|
| **数据库服务器** | `1-5` | `最小化swap使用` | `查询响应时间` |
| **Web服务器** | `10-20` | `平衡缓存和内存` | `并发处理能力` |
| **开发桌面** | `5-15` | `优化编译性能` | `IDE响应速度` |
| **办公桌面** | `15-25` | `平衡多任务切换` | `界面响应性` |
| **文件服务器** | `20-30` | `重视文件缓存` | `文件传输速度` |

**核心记忆要点**：
- swappiness是内存管理的倾向性参数，不是绝对控制
- 低值优先清理缓存，高值优先使用swap
- 数据库和性能敏感应用使用低值(1-10)
- 桌面和文件服务可以使用中等值(10-30)
- 需要通过实际监控验证调整效果
- 永久配置使用/etc/sysctl.conf或sysctl.d目录