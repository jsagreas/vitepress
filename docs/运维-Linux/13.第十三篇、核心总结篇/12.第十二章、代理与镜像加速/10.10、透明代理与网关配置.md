---
title: 10ã€é€æ˜ä»£ç†ä¸ç½‘å…³é…ç½®
---
## ğŸ“š ç›®å½•

1. [é€æ˜ä»£ç†åŸºç¡€æ¦‚å¿µ](#1-é€æ˜ä»£ç†åŸºç¡€æ¦‚å¿µ)
2. [iptablesé€æ˜ä»£ç†è§„åˆ™é…ç½®](#2-iptablesé€æ˜ä»£ç†è§„åˆ™é…ç½®)
3. [Squidé€æ˜ä»£ç†éƒ¨ç½²](#3-squidé€æ˜ä»£ç†éƒ¨ç½²)
4. [ç½‘å…³ä»£ç†è‡ªåŠ¨é…ç½®](#4-ç½‘å…³ä»£ç†è‡ªåŠ¨é…ç½®)
5. [PACè‡ªåŠ¨ä»£ç†é…ç½®](#5-pacè‡ªåŠ¨ä»£ç†é…ç½®)
6. [WPADä»£ç†å‘ç°åè®®](#6-wpadä»£ç†å‘ç°åè®®)
7. [æ€§èƒ½ä¼˜åŒ–ä¸è´Ÿè½½å‡è¡¡](#7-æ€§èƒ½ä¼˜åŒ–ä¸è´Ÿè½½å‡è¡¡)
8. [æ•…éšœæ’æŸ¥ä¸ç›‘æ§](#8-æ•…éšœæ’æŸ¥ä¸ç›‘æ§)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ é€æ˜ä»£ç†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯é€æ˜ä»£ç†


**é€æ˜ä»£ç†**å°±åƒæ˜¯ç½‘ç»œä¸­çš„"éšå½¢æœåŠ¡å‘˜"ï¼Œå®¢æˆ·ç«¯å®Œå…¨æ„Ÿå—ä¸åˆ°å®ƒçš„å­˜åœ¨ï¼Œä½†æ‰€æœ‰çš„ç½‘ç»œè¯·æ±‚éƒ½ä¼šç»è¿‡å®ƒå¤„ç†ã€‚

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ å»é¤å…ç‚¹èœï¼ŒæœåŠ¡å‘˜ä¼šå¸®ä½ æŠŠè®¢å•ä¼ ç»™å¨æˆ¿ï¼Œä½†ä½ æ„Ÿè§‰å°±åƒç›´æ¥å’Œå¨æˆ¿å¯¹è¯ä¸€æ ·ã€‚é€æ˜ä»£ç†å°±æ˜¯è¿™ä¸ª"éšå½¢æœåŠ¡å‘˜"ã€‚

### 1.2 é€æ˜ä»£ç† vs æ™®é€šä»£ç†


```
æ™®é€šä»£ç†æ¨¡å¼ï¼š
å®¢æˆ·ç«¯ â†’ [æ˜ç¡®é…ç½®ä»£ç†] â†’ ä»£ç†æœåŠ¡å™¨ â†’ ç›®æ ‡æœåŠ¡å™¨
ç‰¹ç‚¹ï¼šå®¢æˆ·ç«¯å¿…é¡»æ‰‹åŠ¨é…ç½®ä»£ç†è®¾ç½®

é€æ˜ä»£ç†æ¨¡å¼ï¼š
å®¢æˆ·ç«¯ â†’ [ç½‘å…³è‡ªåŠ¨æ‹¦æˆª] â†’ ä»£ç†æœåŠ¡å™¨ â†’ ç›®æ ‡æœåŠ¡å™¨  
ç‰¹ç‚¹ï¼šå®¢æˆ·ç«¯æ— éœ€ä»»ä½•é…ç½®ï¼Œå®Œå…¨é€æ˜
```

### 1.3 é€æ˜ä»£ç†çš„å·¥ä½œåŸç†


**æ ¸å¿ƒæœºåˆ¶**ï¼šé€šè¿‡ç½‘ç»œå±‚çš„æ•°æ®åŒ…æ‹¦æˆªå’Œé‡å®šå‘å®ç°

```
å·¥ä½œæµç¨‹å›¾ç¤ºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯    â”‚â”€â”€â”€â–·â”‚   ç½‘å…³è·¯ç”±   â”‚â”€â”€â”€â–·â”‚  ç›®æ ‡æœåŠ¡å™¨ â”‚
â”‚192.168.1.10 â”‚    â”‚192.168.1.1   â”‚    â”‚ 8.8.8.8     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–²
                           â”‚ iptablesè§„åˆ™æ‹¦æˆª
                           â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  é€æ˜ä»£ç†æœåŠ¡â”‚
                   â”‚   (Squid)    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ å…³é”®æŠ€æœ¯ç‚¹**ï¼š
- **æ•°æ®åŒ…æ‹¦æˆª**ï¼šiptablesåœ¨ç½‘ç»œå±‚æ‹¦æˆªç‰¹å®šæµé‡
- **é€æ˜é‡å®šå‘**ï¼šå°†è¯·æ±‚é‡å®šå‘åˆ°ä»£ç†æœåŠ¡å™¨
- **åŸå§‹åœ°å€ä¿ç•™**ï¼šä»£ç†æœåŠ¡å™¨çŸ¥é“çœŸå®ç›®æ ‡åœ°å€
- **å“åº”è¿”å›**ï¼šä»£ç†å¤„ç†åå°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯

### 1.4 é€æ˜ä»£ç†çš„åº”ç”¨åœºæ™¯


| åº”ç”¨åœºæ™¯ | **ä½¿ç”¨ç›®çš„** | **å…¸å‹ç¯å¢ƒ** |
|---------|-------------|-------------|
| ğŸ¢ **ä¼ä¸šç½‘å…³** | `å†…å®¹è¿‡æ»¤ã€ä¸Šç½‘è¡Œä¸ºç®¡ç†` | `å…¬å¸å†…ç½‘ã€å­¦æ ¡ç½‘ç»œ` |
| ğŸš€ **ç¼“å­˜åŠ é€Ÿ** | `æé«˜è®¿é—®é€Ÿåº¦ã€èŠ‚çœå¸¦å®½` | `ISPç½‘ç»œã€CDNèŠ‚ç‚¹` |
| ğŸ” **æµé‡ç›‘æ§** | `ç½‘ç»œå®¡è®¡ã€å®‰å…¨åˆ†æ` | `å®‰å…¨ç½‘å…³ã€ç›‘æ§ä¸­å¿ƒ` |
| ğŸŒ **ç§‘å­¦ä¸Šç½‘** | `çªç ´ç½‘ç»œé™åˆ¶` | `å®¶åº­è·¯ç”±å™¨ã€VPSæœåŠ¡å™¨` |

---

## 2. âš¡ iptablesé€æ˜ä»£ç†è§„åˆ™é…ç½®


### 2.1 iptablesåŸºç¡€æ¦‚å¿µå›é¡¾


**iptables**æ˜¯Linuxé˜²ç«å¢™çš„æ ¸å¿ƒå·¥å…·ï¼Œå°±åƒç½‘ç»œä¸–ç•Œçš„"äº¤é€šè­¦å¯Ÿ"ï¼Œå†³å®šå“ªäº›æ•°æ®åŒ…å¯ä»¥é€šè¿‡ï¼Œå“ªäº›è¦è¢«æ‹¦æˆªã€‚

> ğŸ§  **ç”Ÿæ´»ç±»æ¯”**ï¼šiptableså°±åƒå°åŒºé—¨å£çš„ä¿å®‰ï¼Œæ ¹æ®è§„åˆ™å†³å®šå“ªäº›è½¦è¾†å¯ä»¥è¿›å…¥ï¼Œå“ªäº›è¦è¢«æ‹¦æˆªæ£€æŸ¥ã€‚

**å…³é”®æ¦‚å¿µ**ï¼š
- **è¡¨(Table)**ï¼šä¸åŒç±»å‹è§„åˆ™çš„é›†åˆ
- **é“¾(Chain)**ï¼šè§„åˆ™çš„æ‰§è¡Œé¡ºåº
- **è§„åˆ™(Rule)**ï¼šå…·ä½“çš„å¤„ç†åŠ¨ä½œ

### 2.2 é€æ˜ä»£ç†æ ¸å¿ƒè§„åˆ™é…ç½®


**ç¬¬ä¸€æ­¥ï¼šå¼€å¯IPè½¬å‘åŠŸèƒ½**

```bash
# ä¸´æ—¶å¼€å¯IPè½¬å‘
echo 1 > /proc/sys/net/ipv4/ip_forward

# æ°¸ä¹…å¼€å¯IPè½¬å‘
echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf
sysctl -p
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼šIPè½¬å‘æ˜¯é€æ˜ä»£ç†çš„åŸºç¡€ï¼Œå¿…é¡»å…ˆå¼€å¯è¿™ä¸ªåŠŸèƒ½ã€‚

**ç¬¬äºŒæ­¥ï¼šé…ç½®REDIRECTè§„åˆ™**

```bash
# æ‹¦æˆªHTTPæµé‡é‡å®šå‘åˆ°æœ¬åœ°3128ç«¯å£ï¼ˆSquidé»˜è®¤ç«¯å£ï¼‰
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 \
    -j REDIRECT --to-port 3128

# æ‹¦æˆªHTTPSæµé‡é‡å®šå‘åˆ°æœ¬åœ°3129ç«¯å£
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 \
    -j REDIRECT --to-port 3129
```

**ç¬¬ä¸‰æ­¥ï¼šé…ç½®FORWARDé“¾è§„åˆ™**

```bash
# å…è®¸è½¬å‘æµé‡é€šè¿‡
iptables -I FORWARD -j ACCEPT

# æˆ–è€…æ›´ç²¾ç¡®çš„æ§åˆ¶
iptables -I FORWARD -s 192.168.1.0/24 -j ACCEPT
```

### 2.3 å®Œæ•´çš„é€æ˜ä»£ç†iptablesè„šæœ¬


```bash
#!/bin/bash
# é€æ˜ä»£ç†iptablesé…ç½®è„šæœ¬

# æ¸…ç©ºç°æœ‰è§„åˆ™
iptables -F
iptables -t nat -F

# è®¾ç½®é»˜è®¤ç­–ç•¥
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT

# æœ¬åœ°å›ç¯æµé‡
iptables -A INPUT -i lo -j ACCEPT

# é€æ˜ä»£ç†è§„åˆ™
LAN_INTERFACE="eth0"      # å†…ç½‘æ¥å£
LAN_NETWORK="192.168.1.0/24"  # å†…ç½‘ç½‘æ®µ
SQUID_PORT="3128"         # Squidç«¯å£

# HTTPæµé‡é€æ˜ä»£ç†
iptables -t nat -A PREROUTING -i $LAN_INTERFACE \
    -s $LAN_NETWORK -p tcp --dport 80 \
    -j REDIRECT --to-port $SQUID_PORT

# å…è®¸å·²å»ºç«‹çš„è¿æ¥
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

# å…è®¸å†…ç½‘è®¿é—®å¤–ç½‘
iptables -A FORWARD -s $LAN_NETWORK -j ACCEPT

# ä¿å­˜è§„åˆ™
iptables-save > /etc/iptables/rules.v4
```

### 2.4 é«˜çº§iptablesé…ç½®æŠ€å·§


**åŸºäºæ—¶é—´çš„é€æ˜ä»£ç†**ï¼š
```bash
# å·¥ä½œæ—¶é—´(9-18ç‚¹)å¯ç”¨é€æ˜ä»£ç†
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 \
    -m time --timestart 09:00 --timestop 18:00 \
    -j REDIRECT --to-port 3128
```

**æ’é™¤ç‰¹å®šç½‘ç«™**ï¼š
```bash
# ä¸ä»£ç†é“¶è¡Œç½‘ç«™(å‡è®¾ä¸º10.0.0.100)
iptables -t nat -I PREROUTING -d 10.0.0.100 -j ACCEPT
```

**åŸºäºç”¨æˆ·ç»„çš„ä»£ç†**ï¼š
```bash
# åªå¯¹ç‰¹å®šç”¨æˆ·ç»„åº”ç”¨é€æ˜ä»£ç†
iptables -t nat -A PREROUTING -m owner --gid-owner proxy-users \
    -p tcp --dport 80 -j REDIRECT --to-port 3128
```

---

## 3. ğŸ¦‘ Squidé€æ˜ä»£ç†éƒ¨ç½²


### 3.1 Squidç®€ä»‹


**Squid**æ˜¯ä¸–ç•Œä¸Šæœ€æµè¡Œçš„Webä»£ç†ç¼“å­˜æœåŠ¡å™¨ï¼Œå°±åƒä¸€ä¸ª"è¶…çº§èªæ˜çš„ç½‘ç»œç®¡å®¶"ï¼Œèƒ½ç¼“å­˜ç½‘é¡µã€è¿‡æ»¤å†…å®¹ã€æ§åˆ¶è®¿é—®ã€‚

> ğŸª **å•†åº—ç±»æ¯”**ï¼šSquidå°±åƒä¾¿åˆ©åº—ï¼ŒæŠŠå¸¸ç”¨å•†å“(ç½‘é¡µ)æå‰å‡†å¤‡å¥½ï¼Œé¡¾å®¢(ç”¨æˆ·)æ¥äº†ç›´æ¥æ‹¿ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å»å¤§è¶…å¸‚(åŸå§‹æœåŠ¡å™¨)ã€‚

### 3.2 Squidå®‰è£…ä¸åŸºç¡€é…ç½®


**å®‰è£…Squid**ï¼š
```bash
# CentOS/RHEL
yum install squid -y

# Ubuntu/Debian  
apt-get install squid -y

# å¯åŠ¨å¹¶è®¾ç½®è‡ªå¯åŠ¨
systemctl start squid
systemctl enable squid
```

### 3.3 é€æ˜ä»£ç†é…ç½®æ–‡ä»¶


**ä¸»é…ç½®æ–‡ä»¶ä½ç½®**ï¼š`/etc/squid/squid.conf`

```bash
# åŸºç¡€é€æ˜ä»£ç†é…ç½®
# ========================================

# HTTPç«¯å£é…ç½® - å…³é”®çš„transparenté€‰é¡¹
http_port 3128 transparent

# è®¿é—®æ§åˆ¶åˆ—è¡¨(ACL)å®šä¹‰
acl localnet src 192.168.1.0/24    # å®šä¹‰å†…ç½‘ç½‘æ®µ
acl Safe_ports port 80              # HTTPç«¯å£
acl Safe_ports port 443             # HTTPSç«¯å£
acl CONNECT method CONNECT          # CONNECTæ–¹æ³•

# è®¿é—®æƒé™æ§åˆ¶
http_access allow localnet          # å…è®¸å†…ç½‘è®¿é—®
http_access deny all               # æ‹’ç»å…¶ä»–æ‰€æœ‰è®¿é—®

# ç¼“å­˜é…ç½®
cache_dir ufs /var/spool/squid 1000 16 256  # ç¼“å­˜ç›®å½•å’Œå¤§å°

# æ—¥å¿—é…ç½®
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# é€æ˜ä»£ç†å¿…éœ€é…ç½®
visible_hostname proxy-gateway     # å¯è§ä¸»æœºå
```

### 3.4 é«˜çº§Squidé…ç½®é€‰é¡¹


**æ€§èƒ½ä¼˜åŒ–é…ç½®**ï¼š
```bash
# å†…å­˜ç¼“å­˜è®¾ç½®
cache_mem 256 MB                   # å†…å­˜ç¼“å­˜å¤§å°
maximum_object_size_in_memory 512 KB  # å†…å­˜ä¸­å¯¹è±¡æœ€å¤§å¤§å°

# ç£ç›˜ç¼“å­˜è®¾ç½®  
maximum_object_size 100 MB         # ç£ç›˜ç¼“å­˜å¯¹è±¡æœ€å¤§å¤§å°
cache_replacement_policy lru       # ç¼“å­˜æ›¿æ¢ç­–ç•¥

# å¹¶å‘è¿æ¥æ•°
client_lifetime 1 day             # å®¢æˆ·ç«¯è¿æ¥ç”Ÿå­˜æ—¶é—´
half_closed_clients off           # ç¦ç”¨åŠå…³é—­å®¢æˆ·ç«¯
```

**å†…å®¹è¿‡æ»¤é…ç½®**ï¼š
```bash
# å®šä¹‰ç¦æ­¢è®¿é—®çš„ç½‘ç«™
acl blocked_sites dstdomain "/etc/squid/blocked_sites.txt"
http_access deny blocked_sites

# blocked_sites.txtå†…å®¹ç¤ºä¾‹:
# .gambling.com
# .adult.com  
# facebook.com
```

### 3.5 SquidæœåŠ¡ç®¡ç†


**æœåŠ¡æ“ä½œå‘½ä»¤**ï¼š
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
squid -k parse

# é‡æ–°åŠ è½½é…ç½®(ä¸ä¸­æ–­æœåŠ¡)
squid -k reconfigure
# æˆ–è€…
systemctl reload squid

# æŸ¥çœ‹Squidè¿è¡ŒçŠ¶æ€
systemctl status squid

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/squid/cache.log
```

**ç¼“å­˜ç®¡ç†**ï¼š
```bash
# åˆå§‹åŒ–ç¼“å­˜ç›®å½•
squid -z

# æ¸…ç©ºç¼“å­˜
rm -rf /var/spool/squid/*
squid -z
systemctl restart squid
```

---

## 4. ğŸ—ï¸ ç½‘å…³ä»£ç†è‡ªåŠ¨é…ç½®


### 4.1 ç½‘å…³ä»£ç†çš„æ¦‚å¿µ


**ç½‘å…³ä»£ç†**å°±æ˜¯æŠŠLinuxæœåŠ¡å™¨é…ç½®æˆç½‘ç»œçš„"å¤§é—¨"ï¼Œæ‰€æœ‰è®¾å¤‡çš„ç½‘ç»œæµé‡éƒ½ä¼šç»è¿‡è¿™ä¸ªå¤§é—¨ï¼Œç„¶åç»Ÿä¸€å¤„ç†ã€‚

> ğŸšª **é—¨å«ç±»æ¯”**ï¼šç½‘å…³ä»£ç†å°±åƒå°åŒºçš„é—¨å«å®¤ï¼Œæ‰€æœ‰è¿›å‡ºçš„äººå’Œè½¦éƒ½è¦ç»è¿‡é—¨å«æ£€æŸ¥ç™»è®°ã€‚

### 4.2 DHCPè‡ªåŠ¨åˆ†å‘ä»£ç†é…ç½®


**é…ç½®DHCPæœåŠ¡å™¨æ¨é€ä»£ç†ä¿¡æ¯**ï¼š

```bash
# ç¼–è¾‘DHCPé…ç½®æ–‡ä»¶ /etc/dhcp/dhcpd.conf
subnet 192.168.1.0 netmask 255.255.255.0 {
    range 192.168.1.100 192.168.1.200;
    option routers 192.168.1.1;
    option domain-name-servers 8.8.8.8, 8.8.4.4;
    
    # è‡ªåŠ¨æ¨é€ä»£ç†é…ç½®
    option wpad-url "http://192.168.1.1/wpad.dat";
    option proxy-autodiscovery-url "http://192.168.1.1/wpad.dat";
}
```

### 4.3 è·¯ç”±å™¨çº§ä»£ç†é…ç½®


**åœ¨OpenWrtè·¯ç”±å™¨ä¸Šé…ç½®é€æ˜ä»£ç†**ï¼š

```bash
# å®‰è£…å¿…è¦è½¯ä»¶åŒ…
opkg update
opkg install iptables-mod-extra squid

# é…ç½®é€æ˜ä»£ç†è§„åˆ™
# ç¼–è¾‘ /etc/config/firewall
config redirect
    option target 'DNAT'
    option src 'lan' 
    option dest 'lan'
    option proto 'tcp'
    option src_dport '80'
    option dest_ip '192.168.1.1'
    option dest_port '3128'
    option name 'Transparent Proxy'
```

### 4.4 è‡ªåŠ¨æ£€æµ‹ä¸åˆ‡æ¢è„šæœ¬


**æ™ºèƒ½ä»£ç†æ£€æµ‹è„šæœ¬**ï¼š
```bash
#!/bin/bash
# è‡ªåŠ¨æ£€æµ‹ç½‘ç»œç¯å¢ƒå¹¶é…ç½®ç›¸åº”ä»£ç†

PROXY_SERVER="192.168.1.1:3128"
DIRECT_TEST_URL="http://www.baidu.com"

# æµ‹è¯•ç›´è¿æ˜¯å¦æ­£å¸¸
test_direct() {
    curl -s --connect-timeout 5 "$DIRECT_TEST_URL" > /dev/null
    return $?
}

# æµ‹è¯•ä»£ç†æ˜¯å¦æ­£å¸¸  
test_proxy() {
    curl -s --connect-timeout 5 --proxy "$PROXY_SERVER" "$DIRECT_TEST_URL" > /dev/null
    return $?
}

# è‡ªåŠ¨é…ç½®ä»£ç†
if test_direct; then
    echo "ç›´è¿æ­£å¸¸ï¼Œæ— éœ€ä»£ç†"
    unset http_proxy https_proxy
elif test_proxy; then
    echo "å¯ç”¨ä»£ç†: $PROXY_SERVER"
    export http_proxy="http://$PROXY_SERVER"
    export https_proxy="http://$PROXY_SERVER"
else
    echo "ç½‘ç»œå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥é…ç½®"
fi
```

---

## 5. ğŸ“„ PACè‡ªåŠ¨ä»£ç†é…ç½®


### 5.1 PACæ–‡ä»¶åŸç†


**PAC**ï¼ˆProxy Auto-Configurationï¼‰å°±åƒä¸€ä¸ª"æ™ºèƒ½è·¯çº¿è§„åˆ’å¸ˆ"ï¼Œæ ¹æ®ä¸åŒçš„ç½‘ç«™è‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„è®¿é—®æ–¹å¼ã€‚

> ğŸš— **å¯¼èˆªç±»æ¯”**ï¼šPACæ–‡ä»¶å°±åƒå¯¼èˆªè½¯ä»¶ï¼Œå»ä¸åŒåœ°æ–¹è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜è·¯çº¿ï¼šé«˜é€Ÿã€å›½é“è¿˜æ˜¯å¸‚åŒºé“è·¯ã€‚

**PACæ–‡ä»¶åŸºæœ¬ç»“æ„**ï¼š
```javascript
function FindProxyForURL(url, host) {
    // æ ¹æ®URLå’Œä¸»æœºåè¿”å›ä»£ç†é…ç½®
    // è¿”å›å€¼æ ¼å¼ï¼š
    // "DIRECT" - ç›´æ¥è¿æ¥
    // "PROXY host:port" - ä½¿ç”¨ä»£ç†
    // "SOCKS host:port" - ä½¿ç”¨SOCKSä»£ç†
}
```

### 5.2 PACæ–‡ä»¶é…ç½®å®ä¾‹


**åŸºç¡€PACé…ç½®ç¤ºä¾‹**ï¼š
```javascript
function FindProxyForURL(url, host) {
    // æœ¬åœ°åœ°å€ç›´æ¥è¿æ¥
    if (isInNet(host, "192.168.0.0", "255.255.0.0") ||
        isInNet(host, "10.0.0.0", "255.0.0.0") ||
        isInNet(host, "127.0.0.0", "255.0.0.0")) {
        return "DIRECT";
    }
    
    // å¸¸è§ç½‘ç«™ç›´è¿
    if (dnsDomainIs(host, ".baidu.com") ||
        dnsDomainIs(host, ".qq.com") ||
        dnsDomainIs(host, ".taobao.com")) {
        return "DIRECT";
    }
    
    // å…¶ä»–ç½‘ç«™ä½¿ç”¨ä»£ç†
    return "PROXY 192.168.1.1:3128";
}
```

**é«˜çº§PACé…ç½®ç¤ºä¾‹**ï¼š
```javascript
function FindProxyForURL(url, host) {
    // å®šä¹‰ä»£ç†æœåŠ¡å™¨
    var proxy = "PROXY 192.168.1.1:3128";
    var backup_proxy = "PROXY 192.168.1.2:3128";
    var direct = "DIRECT";
    
    // æœ¬åœ°ç½‘ç»œç›´è¿
    if (isPlainHostName(host) ||
        shExpMatch(host, "*.local") ||
        isInNet(host, "192.168.0.0", "255.255.0.0")) {
        return direct;
    }
    
    // æ ¹æ®æ—¶é—´é€‰æ‹©ä»£ç†ï¼ˆå·¥ä½œæ—¶é—´ä½¿ç”¨ä»£ç†ï¼‰
    var now = new Date();
    var hour = now.getHours();
    if (hour >= 9 && hour < 18) {
        // å·¥ä½œæ—¶é—´ï¼Œç‰¹æ®Šç½‘ç«™ç›´è¿
        if (shExpMatch(host, "*bank*.com") ||
            shExpMatch(host, "*gov*.cn")) {
            return direct;
        }
        return proxy + "; " + backup_proxy + "; " + direct;
    }
    
    // éå·¥ä½œæ—¶é—´ç›´è¿
    return direct;
}
```

### 5.3 PACæ–‡ä»¶éƒ¨ç½²


**HTTPæœåŠ¡å™¨éƒ¨ç½²PAC**ï¼š
```bash
# åœ¨WebæœåŠ¡å™¨ç›®å½•æ”¾ç½®PACæ–‡ä»¶
cp proxy.pac /var/www/html/wpad.dat

# è®¾ç½®æ­£ç¡®çš„MIMEç±»å‹
echo 'AddType application/x-ns-proxy-autoconfig .pac' >> /etc/apache2/mime.conf
echo 'AddType application/x-ns-proxy-autoconfig .dat' >> /etc/apache2/mime.conf

# é‡å¯WebæœåŠ¡
systemctl restart apache2
```

**å®¢æˆ·ç«¯é…ç½®ç¤ºä¾‹**ï¼š
- **æµè§ˆå™¨é…ç½®**ï¼šåœ¨ä»£ç†è®¾ç½®ä¸­è¾“å…¥`http://192.168.1.1/wpad.dat`
- **ç³»ç»Ÿçº§é…ç½®**ï¼šåœ¨ç½‘ç»œè®¾ç½®ä¸­é…ç½®è‡ªåŠ¨ä»£ç†URL

### 5.4 PACæ–‡ä»¶è°ƒè¯•æŠ€å·§


**PACæ–‡ä»¶æµ‹è¯•è„šæœ¬**ï¼š
```bash
#!/bin/bash
# PACæ–‡ä»¶æµ‹è¯•å·¥å…·

PAC_URL="http://192.168.1.1/wpad.dat"
TEST_URLS=(
    "http://www.google.com"
    "http://www.baidu.com"  
    "http://192.168.1.100"
    "https://github.com"
)

echo "æµ‹è¯•PACæ–‡ä»¶: $PAC_URL"
for url in "${TEST_URLS[@]}"; do
    result=$(curl -s --proxy-pac-file "$PAC_URL" "$url" -o /dev/null -w "%{http_code}")
    echo "$url -> HTTP $result"
done
```

---

## 6. ğŸ” WPADä»£ç†å‘ç°åè®®


### 6.1 WPADåè®®åŸç†


**WPAD**ï¼ˆWeb Proxy Auto-Discoveryï¼‰æ˜¯ä¸€ç§è®©å®¢æˆ·ç«¯è‡ªåŠ¨å‘ç°ä»£ç†æœåŠ¡å™¨çš„åè®®ï¼Œå°±åƒ"ç½‘ç»œä¸­çš„GPSå®šä½ç³»ç»Ÿ"ã€‚

> ğŸ“¡ **GPSç±»æ¯”**ï¼šWPADå°±åƒæ‰‹æœºçš„GPSï¼Œèƒ½è‡ªåŠ¨æ‰¾åˆ°ä½ æ‰€åœ¨ä½ç½®çš„æœ€ä½³ç½‘ç»œè·¯å¾„ï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥åœ°å€ã€‚

**WPADå‘ç°æµç¨‹**ï¼š
```
å®¢æˆ·ç«¯å¯åŠ¨
    â†“
1. DHCPæŸ¥è¯¢ â†’ è·å–wpad-urlé€‰é¡¹
    â†“
2. DNSæŸ¥è¯¢ â†’ æŸ¥æ‰¾wpad.åŸŸå
    â†“  
3. HTTPè¯·æ±‚ â†’ è·å–http://wpad/wpad.dat
    â†“
4. PACè§£æ â†’ æ‰§è¡Œä»£ç†é…ç½®
```

### 6.2 DHCPæ–¹å¼é…ç½®WPAD


**DHCPæœåŠ¡å™¨é…ç½®**ï¼š
```bash
# /etc/dhcp/dhcpd.confé…ç½®ç¤ºä¾‹
subnet 192.168.1.0 netmask 255.255.255.0 {
    range 192.168.1.100 192.168.1.200;
    option routers 192.168.1.1;
    option domain-name-servers 192.168.1.1;
    option domain-name "example.local";
    
    # WPADé…ç½®é€‰é¡¹
    option wpad-url code 252 = text;
    option wpad-url "http://192.168.1.1/wpad.dat";
    
    # å¾®è½¯ç‰¹æœ‰é€‰é¡¹
    option ms-classless-static-route code 121 = array of integer 8;
}

# é‡å¯DHCPæœåŠ¡
systemctl restart dhcpd
```

### 6.3 DNSæ–¹å¼é…ç½®WPAD


**DNSè§£æé…ç½®**ï¼š
```bash
# åœ¨DNSæœåŠ¡å™¨ä¸­æ·»åŠ WPADè®°å½•
# /etc/bind/example.local.zone

$TTL    604800
@       IN      SOA     ns1.example.local. admin.example.local. (
                      2023091901  ; Serial
                        604800    ; Refresh
                         86400    ; Retry
                       2419200    ; Expire
                        604800 )  ; Negative Cache TTL

; åç§°æœåŠ¡å™¨
@       IN      NS      ns1.example.local.

; Aè®°å½•
ns1     IN      A       192.168.1.1
wpad    IN      A       192.168.1.1    ; WPADè®°å½•

; é‡å¯DNSæœåŠ¡
systemctl restart bind9
```

### 6.4 HTTPæœåŠ¡å™¨é…ç½®


**WebæœåŠ¡å™¨WPADæ–‡ä»¶é…ç½®**ï¼š
```bash
# Apacheé…ç½®
# åœ¨/var/www/html/ç›®å½•åˆ›å»ºwpad.datæ–‡ä»¶
cat > /var/www/html/wpad.dat << 'EOF'
function FindProxyForURL(url, host) {
    // å†…ç½‘ç›´è¿
    if (isInNet(host, "192.168.1.0", "255.255.255.0")) {
        return "DIRECT";
    }
    
    // ä½¿ç”¨ä»£ç†æœåŠ¡å™¨
    return "PROXY 192.168.1.1:3128; DIRECT";
}
EOF

# è®¾ç½®æ­£ç¡®çš„Content-Type
echo 'AddType application/x-ns-proxy-autoconfig .dat' >> /etc/apache2/conf-available/wpad.conf
a2enconf wpad
systemctl restart apache2
```

### 6.5 WPADå®‰å…¨è€ƒè™‘


**WPADå®‰å…¨é…ç½®è¦ç‚¹**ï¼š

```bash
# 1. é™åˆ¶WPADæ–‡ä»¶è®¿é—®
# Apacheé…ç½®ç¤ºä¾‹
<Files "wpad.dat">
    Require ip 192.168.1.0/24    # åªå…è®¸å†…ç½‘è®¿é—®
    Header always set Cache-Control "no-cache, no-store, must-revalidate"
</Files>

# 2. ä½¿ç”¨HTTPSæä¾›WPAD
# åœ¨SSLè™šæ‹Ÿä¸»æœºä¸­é…ç½®wpad.dat

# 3. å®šæœŸæ›´æ–°WPADæ–‡ä»¶
# åˆ›å»ºè‡ªåŠ¨æ›´æ–°è„šæœ¬
#!/bin/bash
# /usr/local/bin/update-wpad.sh
WPAD_FILE="/var/www/html/wpad.dat"
BACKUP_FILE="/var/www/html/wpad.dat.backup"

# å¤‡ä»½ç°æœ‰æ–‡ä»¶
cp "$WPAD_FILE" "$BACKUP_FILE"

# ç”Ÿæˆæ–°çš„WPADæ–‡ä»¶
cat > "$WPAD_FILE" << 'EOF'
function FindProxyForURL(url, host) {
    var now = new Date();
    var hour = now.getHours();
    
    // æ ¹æ®æ—¶é—´æ®µé€‰æ‹©ä»£ç†ç­–ç•¥
    if (hour >= 8 && hour < 18) {
        // å·¥ä½œæ—¶é—´å¯ç”¨ä»£ç†
        if (isInNet(host, "192.168.1.0", "255.255.255.0")) {
            return "DIRECT";
        }
        return "PROXY 192.168.1.1:3128; PROXY 192.168.1.2:3128; DIRECT";
    } else {
        // éå·¥ä½œæ—¶é—´ç›´è¿
        return "DIRECT";
    }
}
EOF

# é‡å¯WebæœåŠ¡
systemctl reload apache2
```

**å®¢æˆ·ç«¯WPADéªŒè¯**ï¼š
```bash
# æµ‹è¯•WPADå‘ç°
nslookup wpad.example.local

# æµ‹è¯•PACæ–‡ä»¶ä¸‹è½½
curl http://wpad.example.local/wpad.dat

# éªŒè¯ä»£ç†è‡ªåŠ¨é…ç½®
# åœ¨æµè§ˆå™¨ä¸­å¯ç”¨"è‡ªåŠ¨æ£€æµ‹ä»£ç†é…ç½®"é€‰é¡¹
```

---

## 7. ğŸš€ æ€§èƒ½ä¼˜åŒ–ä¸è´Ÿè½½å‡è¡¡


### 7.1 é€æ˜ä»£ç†æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


é€æ˜ä»£ç†çš„æ€§èƒ½ä¼˜åŒ–å°±åƒ"ç»™é«˜é€Ÿå…¬è·¯æ‰©å»ºè½¦é“"ï¼Œè®©æ›´å¤šçš„ç½‘ç»œæµé‡èƒ½å¤Ÿå¿«é€Ÿé€šè¿‡ã€‚

> ğŸ›£ï¸ **é«˜é€Ÿå…¬è·¯ç±»æ¯”**ï¼šæ€§èƒ½ä¼˜åŒ–å°±åƒäº¤é€šç®¡ç†ï¼Œé€šè¿‡åˆç†è§„åˆ’è½¦é“ã€è®¾ç½®æ”¶è´¹ç«™ã€ä¼˜åŒ–ä¿¡å·ç¯æ¥æå‡æ•´ä½“é€šè¡Œæ•ˆç‡ã€‚

### 7.2 Squidæ€§èƒ½ä¼˜åŒ–é…ç½®


**å†…å­˜å’Œç¼“å­˜ä¼˜åŒ–**ï¼š
```bash
# /etc/squid/squid.conf æ€§èƒ½ä¼˜åŒ–é…ç½®

# å†…å­˜ä½¿ç”¨ä¼˜åŒ–
cache_mem 1024 MB                    # å¢åŠ å†…å­˜ç¼“å­˜
memory_replacement_policy lru         # ä½¿ç”¨LRUç®—æ³•
maximum_object_size_in_memory 2048 KB # å†…å­˜å¯¹è±¡æœ€å¤§å¤§å°

# ç£ç›˜ç¼“å­˜ä¼˜åŒ–  
cache_dir aufs /var/spool/squid 20000 32 256  # ä½¿ç”¨aufsæå‡æ€§èƒ½
maximum_object_size 1024 MB          # ç£ç›˜å¯¹è±¡æœ€å¤§å¤§å°
minimum_object_size 0 KB             # ç£ç›˜å¯¹è±¡æœ€å°å¤§å°

# å¹¶å‘è¿æ¥ä¼˜åŒ–
workers 4                            # å¯ç”¨å¤šè¿›ç¨‹æ¨¡å¼
cpu_affinity_map process_numbers=1,2,3,4 cores=0,1,2,3

# ç½‘ç»œä¼˜åŒ–
tcp_outgoing_address 192.168.1.1     # ç»‘å®šå‡ºå£IP
client_db off                        # å…³é—­å®¢æˆ·ç«¯æ•°æ®åº“ä»¥èŠ‚çœå†…å­˜
```

**è¿æ¥ç®¡ç†ä¼˜åŒ–**ï¼š
```bash
# è¿æ¥æ± é…ç½®
connection_pool_size 64              # è¿æ¥æ± å¤§å°
server_persistent_connections on      # å¯ç”¨æŒä¹…è¿æ¥
client_persistent_connections on      # å®¢æˆ·ç«¯æŒä¹…è¿æ¥

# è¶…æ—¶è®¾ç½®ä¼˜åŒ–
connect_timeout 30 seconds           # è¿æ¥è¶…æ—¶
read_timeout 60 seconds              # è¯»å–è¶…æ—¶  
request_timeout 30 seconds           # è¯·æ±‚è¶…æ—¶
```

### 7.3 ç³»ç»Ÿçº§æ€§èƒ½ä¼˜åŒ–


**å†…æ ¸å‚æ•°è°ƒä¼˜**ï¼š
```bash
# /etc/sysctl.conf ç½‘ç»œå‚æ•°ä¼˜åŒ–

# TCPç¼“å†²åŒºå¤§å°
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144  
net.core.wmem_max = 16777216

# TCPçª—å£ç¼©æ”¾
net.ipv4.tcp_window_scaling = 1

# å¢åŠ è¿æ¥é˜Ÿåˆ—å¤§å°
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 5000

# ä¼˜åŒ–TIME_WAITè¿æ¥
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30

# åº”ç”¨é…ç½®
sysctl -p
```

**æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ä¼˜åŒ–**ï¼š
```bash
# /etc/security/limits.conf
squid soft nofile 65535
squid hard nofile 65535  

# /etc/systemd/system/squid.service.d/override.conf
[Service]
LimitNOFILE=65535
```

### 7.4 ä»£ç†æœåŠ¡å™¨è´Ÿè½½å‡è¡¡


**HAProxyè´Ÿè½½å‡è¡¡é…ç½®**ï¼š
```bash
# /etc/haproxy/haproxy.cfg
global
    daemon
    user haproxy
    group haproxy

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend proxy_frontend
    bind *:3128
    default_backend proxy_servers

backend proxy_servers
    balance roundrobin                    # è½®è¯¢ç®—æ³•
    option httpchk GET /squid-internal-mgr/info  # å¥åº·æ£€æŸ¥
    server proxy1 192.168.1.10:3128 check
    server proxy2 192.168.1.11:3128 check  
    server proxy3 192.168.1.12:3128 check backup  # å¤‡ä»½æœåŠ¡å™¨
```

**åŸºäºiptablesçš„è´Ÿè½½å‡è¡¡**ï¼š
```bash
#!/bin/bash
# å¤šä»£ç†æœåŠ¡å™¨è´Ÿè½½å‡è¡¡è„šæœ¬

PROXY_SERVERS=(
    "192.168.1.10:3128"
    "192.168.1.11:3128" 
    "192.168.1.12:3128"
)

# æ¸…é™¤ç°æœ‰è§„åˆ™
iptables -t nat -F PREROUTING

# ä½¿ç”¨randomæ¨¡å—å®ç°è´Ÿè½½å‡è¡¡
for i in "${!PROXY_SERVERS[@]}"; do
    IFS=':' read -r ip port <<< "${PROXY_SERVERS[$i]}"
    probability=$(echo "scale=4; 1.0/($((${#PROXY_SERVERS[@]} - $i)))" | bc)
    
    iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 \
        -m statistic --mode random --probability $probability \
        -j DNAT --to-destination $ip:$port
done
```

### 7.5 æ€§èƒ½ç›‘æ§è„šæœ¬


**ä»£ç†æ€§èƒ½ç›‘æ§å·¥å…·**ï¼š
```bash
#!/bin/bash
# proxy-monitor.sh - ä»£ç†æœåŠ¡å™¨æ€§èƒ½ç›‘æ§

SQUID_LOG="/var/log/squid/access.log"
PROXY_PORT="3128"

# å®æ—¶è¿æ¥æ•°ç›‘æ§
monitor_connections() {
    echo "=== å½“å‰è¿æ¥çŠ¶æ€ ==="
    ss -tuln | grep ":$PROXY_PORT" 
    echo "æ´»è·ƒè¿æ¥æ•°: $(ss -t | grep ":$PROXY_PORT" | wc -l)"
}

# ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
cache_hit_rate() {
    echo "=== ç¼“å­˜å‘½ä¸­ç‡ ==="
    if [[ -f "$SQUID_LOG" ]]; then
        total=$(tail -1000 "$SQUID_LOG" | wc -l)
        hits=$(tail -1000 "$SQUID_LOG" | grep -c "TCP_HIT\|TCP_MEM_HIT")
        hit_rate=$(echo "scale=2; $hits * 100 / $total" | bc 2>/dev/null || echo "0")
        echo "æœ€è¿‘1000ä¸ªè¯·æ±‚å‘½ä¸­ç‡: ${hit_rate}%"
    fi
}

# CPUå’Œå†…å­˜ä½¿ç”¨ç‡
resource_usage() {
    echo "=== èµ„æºä½¿ç”¨æƒ…å†µ ==="
    squid_pid=$(pgrep -f squid)
    if [[ -n "$squid_pid" ]]; then
        ps -p $squid_pid -o pid,pcpu,pmem,cmd --no-headers
    fi
}

# ä¸»ç›‘æ§å‡½æ•°
main() {
    while true; do
        clear
        echo "ä»£ç†æœåŠ¡å™¨æ€§èƒ½ç›‘æ§ - $(date)"
        echo "================================"
        monitor_connections
        echo
        cache_hit_rate  
        echo
        resource_usage
        echo
        echo "æŒ‰ Ctrl+C é€€å‡ºç›‘æ§"
        sleep 5
    done
}

main
```

---

## 8. ğŸ”§ æ•…éšœæ’æŸ¥ä¸ç›‘æ§


### 8.1 å¸¸è§æ•…éšœç±»å‹ä¸ç—‡çŠ¶


é€æ˜ä»£ç†æ•…éšœæ’æŸ¥å°±åƒ"ç»™ç½‘ç»œçœ‹ç—…"ï¼Œéœ€è¦é€šè¿‡å„ç§ç—‡çŠ¶æ¥è¯Šæ–­é—®é¢˜æ‰€åœ¨ã€‚

> ğŸ¥ **åŒ»ç”Ÿè¯Šæ–­ç±»æ¯”**ï¼šç½‘ç»œæ•…éšœæ’æŸ¥å°±åƒåŒ»ç”Ÿçœ‹ç—…ï¼Œé€šè¿‡è§‚å¯Ÿç—‡çŠ¶(æ—¥å¿—)ã€æ£€æŸ¥èº«ä½“(ç½‘ç»œè¿æ¥)ã€åŒ–éªŒæ£€æŸ¥(æŠ“åŒ…åˆ†æ)æ¥æ‰¾åˆ°ç—…å› ã€‚

**å…¸å‹æ•…éšœç—‡çŠ¶è¡¨**ï¼š

| æ•…éšœç—‡çŠ¶ | **å¯èƒ½åŸå› ** | **æ£€æŸ¥æ–¹æ³•** |
|---------|-------------|-------------|
| ğŸš« **æ— æ³•ä¸Šç½‘** | `iptablesè§„åˆ™é”™è¯¯` | `iptables -t nat -L` |
| ğŸŒ **è®¿é—®å¾ˆæ…¢** | `ä»£ç†æœåŠ¡å™¨æ€§èƒ½é—®é¢˜` | `topã€iotopæŸ¥çœ‹èµ„æº` |
| âŒ **éƒ¨åˆ†ç½‘ç«™æ— æ³•è®¿é—®** | `ACLè®¿é—®æ§åˆ¶é™åˆ¶` | `æ£€æŸ¥squidé…ç½®` |
| ğŸ”„ **è¿æ¥ç»å¸¸æ–­å¼€** | `è¶…æ—¶è®¾ç½®è¿‡çŸ­` | `è°ƒæ•´timeoutå‚æ•°` |

### 8.2 iptablesè§„åˆ™æ•…éšœæ’æŸ¥


**æ£€æŸ¥é€æ˜ä»£ç†è§„åˆ™**ï¼š
```bash
# æŸ¥çœ‹NATè¡¨è§„åˆ™
iptables -t nat -L -n -v

# æŸ¥çœ‹æ•°æ®åŒ…åŒ¹é…æƒ…å†µ
iptables -t nat -L -n -v --line-numbers

# å®æ—¶ç›‘æ§è§„åˆ™åŒ¹é…
watch 'iptables -t nat -L -n -v'
```

**è§„åˆ™æµ‹è¯•è„šæœ¬**ï¼š
```bash
#!/bin/bash
# iptablesè§„åˆ™æµ‹è¯•è„šæœ¬

# æµ‹è¯•é€æ˜ä»£ç†è§„åˆ™æ˜¯å¦æ­£å¸¸å·¥ä½œ
test_transparent_proxy() {
    local test_port=80
    local proxy_port=3128
    
    echo "æµ‹è¯•é€æ˜ä»£ç†è§„åˆ™..."
    
    # æ£€æŸ¥REDIRECTè§„åˆ™æ˜¯å¦å­˜åœ¨
    if iptables -t nat -L PREROUTING | grep -q "REDIRECT.*$proxy_port"; then
        echo "âœ… REDIRECTè§„åˆ™å·²é…ç½®"
    else
        echo "âŒ æœªæ‰¾åˆ°REDIRECTè§„åˆ™"
        return 1
    fi
    
    # æ£€æŸ¥IPè½¬å‘æ˜¯å¦å¼€å¯
    if [[ $(cat /proc/sys/net/ipv4/ip_forward) == "1" ]]; then
        echo "âœ… IPè½¬å‘å·²å¼€å¯"
    else
        echo "âŒ IPè½¬å‘æœªå¼€å¯"
        echo "æ‰§è¡Œ: echo 1 > /proc/sys/net/ipv4/ip_forward"
    fi
}

test_transparent_proxy
```

### 8.3 SquidæœåŠ¡æ•…éšœæ’æŸ¥


**SquidçŠ¶æ€æ£€æŸ¥**ï¼š
```bash
# æ£€æŸ¥SquidæœåŠ¡çŠ¶æ€
systemctl status squid

# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
squid -k parse

# æŸ¥çœ‹Squidè¿›ç¨‹
ps aux | grep squid

# æ£€æŸ¥ç«¯å£ç›‘å¬
ss -tlnp | grep :3128
```

**Squidæ—¥å¿—åˆ†æ**ï¼š
```bash
# å®æ—¶æŸ¥çœ‹è®¿é—®æ—¥å¿—
tail -f /var/log/squid/access.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/squid/cache.log

# åˆ†æå¸¸è§é”™è¯¯
grep "ERROR\|FATAL\|WARNING" /var/log/squid/cache.log

# ç»Ÿè®¡è®¿é—®çŠ¶æ€ç 
awk '{print $4}' /var/log/squid/access.log | sort | uniq -c | sort -nr
```

**Squidç®¡ç†æ¥å£**ï¼š
```bash
# è·å–Squidç»Ÿè®¡ä¿¡æ¯
squidclient -h 127.0.0.1 -p 3128 mgr:info

# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
squidclient mgr:storedir

# æŸ¥çœ‹æ´»è·ƒè¿æ¥
squidclient mgr:active_requests
```

### 8.4 ç½‘ç»œè¿é€šæ€§æµ‹è¯•


**å¤šå±‚æ¬¡ç½‘ç»œæµ‹è¯•**ï¼š
```bash
#!/bin/bash
# ç½‘ç»œè¿é€šæ€§å…¨é¢æµ‹è¯•è„šæœ¬

PROXY_SERVER="192.168.1.1:3128"
TEST_URLS=(
    "http://www.baidu.com"
    "https://www.google.com"
    "http://www.github.com"
)

# æµ‹è¯•ç›´è¿
test_direct() {
    echo "=== æµ‹è¯•ç›´è¿ ==="
    for url in "${TEST_URLS[@]}"; do
        if curl -s --connect-timeout 10 "$url" > /dev/null; then
            echo "âœ… $url - ç›´è¿æ­£å¸¸"
        else  
            echo "âŒ $url - ç›´è¿å¤±è´¥"
        fi
    done
}

# æµ‹è¯•ä»£ç†è¿æ¥
test_proxy() {
    echo "=== æµ‹è¯•ä»£ç†è¿æ¥ ==="
    for url in "${TEST_URLS[@]}"; do
        if curl -s --connect-timeout 10 --proxy "$PROXY_SERVER" "$url" > /dev/null; then
            echo "âœ… $url - ä»£ç†è¿æ¥æ­£å¸¸"
        else
            echo "âŒ $url - ä»£ç†è¿æ¥å¤±è´¥" 
        fi
    done
}

# DNSè§£ææµ‹è¯•  
test_dns() {
    echo "=== DNSè§£ææµ‹è¯• ==="
    local test_domains=("www.baidu.com" "www.google.com" "github.com")
    
    for domain in "${test_domains[@]}"; do
        if nslookup "$domain" > /dev/null 2>&1; then
            echo "âœ… $domain - DNSè§£ææ­£å¸¸"
        else
            echo "âŒ $domain - DNSè§£æå¤±è´¥"
        fi
    done
}

# ç«¯å£è¿é€šæ€§æµ‹è¯•
test_ports() {
    echo "=== ç«¯å£è¿é€šæ€§æµ‹è¯• ==="
    local test_ports=("80" "443" "3128")
    
    for port in "${test_ports[@]}"; do
        if nc -z -w3 192.168.1.1 "$port" 2>/dev/null; then
            echo "âœ… ç«¯å£ $port - è¿é€šæ­£å¸¸"
        else
            echo "âŒ ç«¯å£ $port - è¿æ¥å¤±è´¥"
        fi
    done
}

# æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
main() {
    echo "ç½‘ç»œè¿é€šæ€§å…¨é¢æµ‹è¯• - $(date)"
    echo "================================"
    test_dns
    echo
    test_ports  
    echo
    test_direct
    echo
    test_proxy
}

main
```

### 8.5 å®æ—¶ç›‘æ§ä¸å‘Šè­¦


**ç³»ç»Ÿç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# proxy-alert.sh - ä»£ç†æœåŠ¡ç›‘æ§å‘Šè­¦è„šæœ¬

# é…ç½®å‚æ•°
SQUID_PID_FILE="/var/run/squid.pid"
PROXY_PORT="3128"  
MAX_CPU=80        # CPUä½¿ç”¨ç‡é˜ˆå€¼
MAX_MEM=80        # å†…å­˜ä½¿ç”¨ç‡é˜ˆå€¼
EMAIL_ALERT="admin@example.com"  # å‘Šè­¦é‚®ç®±

# æ£€æŸ¥SquidæœåŠ¡çŠ¶æ€
check_squid_status() {
    if ! systemctl is-active --quiet squid; then
        send_alert "SquidæœåŠ¡å·²åœæ­¢è¿è¡Œ"
        return 1
    fi
    return 0
}

# æ£€æŸ¥ç«¯å£ç›‘å¬
check_port_listen() {
    if ! ss -tlnp | grep -q ":$PROXY_PORT"; then
        send_alert "ä»£ç†ç«¯å£ $PROXY_PORT æœªç›‘å¬"
        return 1
    fi
    return 0
}

# æ£€æŸ¥èµ„æºä½¿ç”¨ç‡
check_resource_usage() {
    local squid_pid=$(cat "$SQUID_PID_FILE" 2>/dev/null)
    if [[ -n "$squid_pid" ]]; then
        local cpu_usage=$(ps -p "$squid_pid" -o pcpu --no-headers | tr -d ' ')
        local mem_usage=$(ps -p "$squid_pid" -o pmem --no-headers | tr -d ' ')
        
        if (( $(echo "$cpu_usage > $MAX_CPU" | bc -l) )); then
            send_alert "CPUä½¿ç”¨ç‡è¿‡é«˜: ${cpu_usage}%"
        fi
        
        if (( $(echo "$mem_usage > $MAX_MEM" | bc -l) )); then
            send_alert "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${mem_usage}%"
        fi
    fi
}

# å‘é€å‘Šè­¦
send_alert() {
    local message="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    echo "[$timestamp] ALERT: $message" | tee -a /var/log/proxy-alert.log
    
    # å‘é€é‚®ä»¶å‘Šè­¦(éœ€è¦é…ç½®é‚®ä»¶æœåŠ¡)
    if command -v mail > /dev/null; then
        echo "$message" | mail -s "ä»£ç†æœåŠ¡å‘Šè­¦ - $timestamp" "$EMAIL_ALERT"
    fi
}

# ä¸»ç›‘æ§å¾ªç¯
main() {
    while true; do
        check_squid_status
        check_port_listen  
        check_resource_usage
        sleep 60  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    done
}

# ä½œä¸ºç³»ç»ŸæœåŠ¡è¿è¡Œ
if [[ "$1" == "--daemon" ]]; then
    main &
    echo $! > /var/run/proxy-monitor.pid
else
    main
fi
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é€æ˜ä»£ç†æœ¬è´¨ï¼šå®¢æˆ·ç«¯æ— æ„ŸçŸ¥çš„ç½‘ç»œæµé‡æ‹¦æˆªä¸å¤„ç†
ğŸ”¸ iptablesè§„åˆ™ï¼šREDIRECTé‡å®šå‘æ˜¯é€æ˜ä»£ç†çš„åŸºç¡€
ğŸ”¸ Squidé…ç½®ï¼štransparenté€‰é¡¹æ˜¯å…³é”®é…ç½®å‚æ•°
ğŸ”¸ WPADåè®®ï¼šè‡ªåŠ¨ä»£ç†å‘ç°çš„æ ‡å‡†æœºåˆ¶
ğŸ”¸ PACæ–‡ä»¶ï¼šæ™ºèƒ½ä»£ç†é€‰æ‹©çš„JavaScripté…ç½®è„šæœ¬
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šå†…å­˜ç¼“å­˜ã€è¿æ¥æ± ã€ç³»ç»Ÿå‚æ•°è°ƒä¼˜
ğŸ”¸ æ•…éšœæ’æŸ¥ï¼šæ—¥å¿—åˆ†æã€è¿é€šæ€§æµ‹è¯•ã€è§„åˆ™éªŒè¯
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é€æ˜ä»£ç†çš„å·¥ä½œæµç¨‹**
```
æ•°æ®åŒ…æ‹¦æˆª â†’ ä»£ç†å¤„ç† â†’ ç›®æ ‡è®¿é—® â†’ å“åº”è¿”å›
å…³é”®åœ¨äºï¼šç”¨æˆ·å®Œå…¨æ„Ÿå—ä¸åˆ°ä»£ç†çš„å­˜åœ¨
```

**ğŸ”¹ é…ç½®çš„å…³é”®è¦ç´ **
```
ç½‘ç»œå±‚ï¼šiptables REDIRECTè§„åˆ™é…ç½®
åº”ç”¨å±‚ï¼šSquid transparentæ¨¡å¼é…ç½®  
è‡ªåŠ¨åŒ–ï¼šWPAD/PACè‡ªåŠ¨å‘ç°é…ç½®
ä¼˜åŒ–å±‚ï¼šæ€§èƒ½è°ƒä¼˜å’Œè´Ÿè½½å‡è¡¡
```

**ğŸ”¹ æ•…éšœæ’æŸ¥æ€è·¯**
```
åˆ†å±‚è¯Šæ–­ï¼šç½‘ç»œè¿é€š â†’ æœåŠ¡çŠ¶æ€ â†’ é…ç½®æ­£ç¡®æ€§ â†’ æ€§èƒ½ç“¶é¢ˆ
æ—¥å¿—ä¸ºç‹ï¼šaccess.logçœ‹è®¿é—®ï¼Œcache.logçœ‹é”™è¯¯
å·¥å…·è¾…åŠ©ï¼šcurlæµ‹è¯•ã€tcpdumpæŠ“åŒ…ã€iptablesæŸ¥çœ‹è§„åˆ™
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**é€‚ç”¨åœºæ™¯åˆ¤æ–­**ï¼š
- âœ… ä¼ä¸šå†…ç½‘ç»Ÿä¸€ä¸Šç½‘ç®¡ç†
- âœ… å®¶åº­ç½‘ç»œå†…å®¹è¿‡æ»¤  
- âœ… ç½‘å§ã€å­¦æ ¡ç½‘ç»œæ§åˆ¶
- âœ… ISPçº§åˆ«ç¼“å­˜åŠ é€Ÿ

**é…ç½®æœ€ä½³å®è·µ**ï¼š
- ğŸ”§ å…ˆé…ç½®iptablesè§„åˆ™ï¼Œå†å¯åŠ¨Squid
- ğŸ”§ ä½¿ç”¨PACæ–‡ä»¶å®ç°æ™ºèƒ½ä»£ç†é€‰æ‹©
- ğŸ”§ é…ç½®WPADå®ç°é›¶é…ç½®éƒ¨ç½²
- ğŸ”§ è®¾ç½®ç›‘æ§å‘Šè­¦åŠæ—¶å‘ç°é—®é¢˜

### 9.4 è¿›é˜¶å­¦ä¹ æ–¹å‘


**æŠ€æœ¯æ‰©å±•**ï¼š
- ğŸš€ **é«˜çº§è´Ÿè½½å‡è¡¡**ï¼šLVSã€HAProxyé›†ç¾¤éƒ¨ç½²
- ğŸš€ **SSLé€æ˜ä»£ç†**ï¼šHTTPSæµé‡çš„é€æ˜å¤„ç†
- ğŸš€ **å†…å®¹å®¡è®¡**ï¼šDPIæ·±åº¦åŒ…æ£€æµ‹æŠ€æœ¯
- ğŸš€ **æ™ºèƒ½QoS**ï¼šåŸºäºåº”ç”¨çš„æµé‡æ§åˆ¶

**å®æˆ˜é¡¹ç›®**ï¼š
- ğŸ¯ ä¼ä¸šç½‘å…³ä¸€ä½“æœºæ­å»º
- ğŸ¯ å®¶åº­æ™ºèƒ½è·¯ç”±å™¨å¼€å‘
- ğŸ¯ æ ¡å›­ç½‘ç®¡ç†ç³»ç»Ÿéƒ¨ç½²
- ğŸ¯ äº‘ç«¯ä»£ç†æœåŠ¡æ¶æ„

> ğŸ’¡ **æ ¸å¿ƒè®°å¿†**ï¼š
> - é€æ˜ä»£ç†è®©ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œiptablesæ‹¦æˆªæ˜¯å…³é”®
> - Squidé…transparentï¼ŒWPADè®©é…ç½®è‡ªåŠ¨åŒ–  
> - PACæ–‡ä»¶æ™ºèƒ½é€‰æ‹©ï¼Œæ€§èƒ½ä¼˜åŒ–ä¿æµç•…
> - æ—¥å¿—ç›‘æ§å‹¤æ£€æŸ¥ï¼Œæ•…éšœæ’æŸ¥æœ‰ç« æ³•

**æœ€åæé†’**ï¼šé€æ˜ä»£ç†æ¶‰åŠç½‘ç»œåº•å±‚æ“ä½œï¼Œé…ç½®å‰åŠ¡å¿…åšå¥½å¤‡ä»½ï¼Œæµ‹è¯•ç¯å¢ƒéªŒè¯åå†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼