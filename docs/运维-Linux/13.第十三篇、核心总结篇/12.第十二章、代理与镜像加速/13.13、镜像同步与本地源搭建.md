---
title: 13ã€é•œåƒåŒæ­¥ä¸æœ¬åœ°æºæ­å»º
---
## ğŸ“š ç›®å½•

1. [é•œåƒåŒæ­¥åŸºç¡€æ¦‚å¿µ](#1-é•œåƒåŒæ­¥åŸºç¡€æ¦‚å¿µ)
2. [rsyncé•œåƒåŒæ­¥å·¥å…·è¯¦è§£](#2-rsyncé•œåƒåŒæ­¥å·¥å…·è¯¦è§£)
3. [æœ¬åœ°è½¯ä»¶æºæ­å»ºå®æˆ˜](#3-æœ¬åœ°è½¯ä»¶æºæ­å»ºå®æˆ˜)
4. [é•œåƒç«™ç‚¹æ¶æ„è®¾è®¡](#4-é•œåƒç«™ç‚¹æ¶æ„è®¾è®¡)
5. [åŒæ­¥è„šæœ¬ç¼–å†™ä¸ä¼˜åŒ–](#5-åŒæ­¥è„šæœ¬ç¼–å†™ä¸ä¼˜åŒ–)
6. [é•œåƒæ›´æ–°ç­–ç•¥ç®¡ç†](#6-é•œåƒæ›´æ–°ç­–ç•¥ç®¡ç†)
7. [æœ¬åœ°æºè®¿é—®æ§åˆ¶](#7-æœ¬åœ°æºè®¿é—®æ§åˆ¶)
8. [é•œåƒåŒæ­¥ç›‘æ§ä½“ç³»](#8-é•œåƒåŒæ­¥ç›‘æ§ä½“ç³»)
9. [CDNé•œåƒåˆ†å‘æ¶æ„](#9-CDNé•œåƒåˆ†å‘æ¶æ„)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ é•œåƒåŒæ­¥åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯é•œåƒåŒæ­¥


**ğŸ”¸ åŸºæœ¬å®šä¹‰**
```
é•œåƒåŒæ­¥å°±åƒ"å¤å°åº—"çš„æ¦‚å¿µï¼š
â€¢ åŸç‰ˆæ–‡æ¡£ = å®˜æ–¹è½¯ä»¶æº
â€¢ å¤å°æ–‡æ¡£ = æœ¬åœ°é•œåƒæº  
â€¢ å¤å°è¿‡ç¨‹ = é•œåƒåŒæ­¥
â€¢ å®šæœŸæ›´æ–°å¤å° = å®šæ—¶åŒæ­¥
```

é•œåƒåŒæ­¥æ˜¯æŒ‡å°†è¿œç¨‹è½¯ä»¶ä»“åº“çš„å†…å®¹å®Œæ•´å¤åˆ¶åˆ°æœ¬åœ°æœåŠ¡å™¨ï¼Œå¹¶ä¿æŒå®šæœŸæ›´æ–°çš„è¿‡ç¨‹ã€‚

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦é•œåƒåŒæ­¥


**ğŸ’¡ æ ¸å¿ƒä»·å€¼åˆ†æ**

| åœºæ™¯é—®é¢˜ | é•œåƒåŒæ­¥è§£å†³æ–¹æ¡ˆ | å®é™…æ•ˆæœ |
|---------|-----------------|----------|
| ğŸŒ **ä¸‹è½½é€Ÿåº¦æ…¢** | æœ¬åœ°é«˜é€Ÿè®¿é—® | é€Ÿåº¦æå‡10-100å€ |
| ğŸŒ **ç½‘ç»œä¸ç¨³å®š** | å†…ç½‘ç¨³å®šè¿æ¥ | 99.9%å¯ç”¨æ€§ |
| ğŸ’° **å¸¦å®½æˆæœ¬é«˜** | ä¸€æ¬¡ä¸‹è½½å¤šæ¬¡ä½¿ç”¨ | èŠ‚çœ80%å¤–ç½‘æµé‡ |
| ğŸ¢ **ä¼ä¸šç®¡æ§éœ€æ±‚** | ç‰ˆæœ¬ç»Ÿä¸€ç®¡ç† | ç¯å¢ƒä¸€è‡´æ€§ä¿è¯ |

### 1.3 é•œåƒåŒæ­¥çš„å·¥ä½œåŸç†


**ğŸ”„ åŒæ­¥æµç¨‹ç¤ºæ„å›¾**
```
å®˜æ–¹æºæœåŠ¡å™¨                     æœ¬åœ°é•œåƒæœåŠ¡å™¨                    å®¢æˆ·ç«¯æœºå™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ubuntuå®˜æ–¹  â”‚ â”€â”€[1]åŒæ­¥â”€â”€â†’   â”‚   æœ¬åœ°é•œåƒç«™    â”‚ â”€â”€[2]ä¸‹è½½â”€â”€â†’ â”‚  ç”¨æˆ·ç”µè„‘    â”‚
â”‚  è½¯ä»¶ä»“åº“    â”‚                â”‚   /var/mirror   â”‚              â”‚  apt install â”‚
â”‚  packages   â”‚                â”‚   nginxæœåŠ¡     â”‚              â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æµç¨‹è¯´æ˜ï¼š
[1] å®šæ—¶åŒæ­¥ï¼šæ¯6å°æ—¶ä»å®˜æ–¹æºåŒæ­¥æœ€æ–°è½¯ä»¶åŒ…
[2] æœ¬åœ°ä¸‹è½½ï¼šç”¨æˆ·ä»æœ¬åœ°é•œåƒç«™ä¸‹è½½ï¼Œé€Ÿåº¦å¿«ä¸”ç¨³å®š
```

---

## 2. âš¡ rsyncé•œåƒåŒæ­¥å·¥å…·è¯¦è§£


### 2.1 rsyncåŸºç¡€è®¤çŸ¥


**ğŸ”¸ rsyncæ˜¯ä»€ä¹ˆ**
```
rsync = remote syncï¼ˆè¿œç¨‹åŒæ­¥ï¼‰
â€¢ æ ¸å¿ƒåŠŸèƒ½ï¼šæ–‡ä»¶åŒæ­¥å’Œä¼ è¾“å·¥å…·
â€¢ ç‹¬ç‰¹ä¼˜åŠ¿ï¼šå¢é‡åŒæ­¥ï¼Œåªä¼ è¾“å˜åŒ–çš„éƒ¨åˆ†
â€¢ é€‚ç”¨åœºæ™¯ï¼šå¤§æ–‡ä»¶ã€å¤§é‡æ–‡ä»¶çš„åŒæ­¥ä»»åŠ¡
```

**ğŸ’ª rsyncæ ¸å¿ƒä¼˜åŠ¿**
- **å¢é‡åŒæ­¥**ï¼šåªåŒæ­¥ä¿®æ”¹çš„æ–‡ä»¶ï¼ŒèŠ‚çœæ—¶é—´å’Œå¸¦å®½
- **æ–­ç‚¹ç»­ä¼ **ï¼šç½‘ç»œä¸­æ–­åå¯ä»¥ä»æ–­ç‚¹ç»§ç»­
- **æƒé™ä¿æŒ**ï¼šå®Œæ•´ä¿æŒæ–‡ä»¶æƒé™ã€æ—¶é—´æˆ³ç­‰å±æ€§
- **å‹ç¼©ä¼ è¾“**ï¼šæ”¯æŒä¼ è¾“è¿‡ç¨‹ä¸­çš„æ•°æ®å‹ç¼©

### 2.2 rsyncåŸºæœ¬è¯­æ³•è¯¦è§£


**ğŸ“ æ ¸å¿ƒè¯­æ³•æ ¼å¼**
```bash
rsync [é€‰é¡¹] æºè·¯å¾„ ç›®æ ‡è·¯å¾„

# æœ¬åœ°åŒæ­¥æ ¼å¼
rsync -av /source/path/ /dest/path/

# è¿œç¨‹åŒæ­¥æ ¼å¼  
rsync -av user@remote:/remote/path/ /local/path/
```

**ğŸ”§ å…³é”®é€‰é¡¹è¯´æ˜**

| é€‰é¡¹ | å«ä¹‰ | å®é™…ä½œç”¨ | æ¨èä½¿ç”¨ |
|------|------|----------|----------|
| `-a` | archiveå½’æ¡£æ¨¡å¼ | ä¿æŒæ–‡ä»¶å±æ€§ã€æƒé™ã€æ—¶é—´ | âœ… å¿…ç”¨ |
| `-v` | verboseè¯¦ç»†è¾“å‡º | æ˜¾ç¤ºåŒæ­¥è¿‡ç¨‹ä¿¡æ¯ | âœ… æ¨è |
| `-z` | compresså‹ç¼© | ç½‘ç»œä¼ è¾“å‹ç¼©æ•°æ® | âœ… ç½‘ç»œåŒæ­¥å¿…ç”¨ |
| `-P` | progress+partial | æ˜¾ç¤ºè¿›åº¦+æ”¯æŒæ–­ç‚¹ç»­ä¼  | âœ… å¤§æ–‡ä»¶å¿…ç”¨ |
| `--delete` | åˆ é™¤å¤šä½™æ–‡ä»¶ | ä¿æŒç›®æ ‡ä¸æºå®Œå…¨ä¸€è‡´ | âš ï¸ è°¨æ…ä½¿ç”¨ |

### 2.3 å®ç”¨rsyncåŒæ­¥ç¤ºä¾‹


**ğŸ¯ å®é™…æ“ä½œæ¼”ç¤º**

```bash
# ç¤ºä¾‹1ï¼šåŒæ­¥Ubuntuå®˜æ–¹æºåˆ°æœ¬åœ°
rsync -avzP --delete \
  rsync://mirrors.ustc.edu.cn/ubuntu/ \
  /var/www/html/ubuntu/

# ç¤ºä¾‹2ï¼šåªåŒæ­¥ç‰¹å®šå‘è¡Œç‰ˆ
rsync -avzP --delete \
  --include="dists/focal/" \
  --include="pool/" \
  --exclude="*" \
  rsync://archive.ubuntu.com/ubuntu/ \
  /var/mirror/ubuntu/

# ç¤ºä¾‹3ï¼šé™åˆ¶å¸¦å®½çš„åŒæ­¥ï¼ˆé¿å…å æ»¡å¸¦å®½ï¼‰
rsync -avzP --delete --bwlimit=1000 \
  rsync://mirrors.aliyun.com/centos/ \
  /var/mirror/centos/
```

**ğŸ’¡ å‚æ•°è§£é‡Šè¯´æ˜**
- `--bwlimit=1000`ï¼šé™åˆ¶å¸¦å®½ä¸º1000KB/sï¼Œé¿å…å½±å“æ­£å¸¸ä¸šåŠ¡
- `--include/--exclude`ï¼šç²¾ç¡®æ§åˆ¶åŒæ­¥å“ªäº›å†…å®¹ï¼ŒèŠ‚çœç©ºé—´
- `rsync://`åè®®ï¼šä¸“é—¨çš„rsyncåè®®ï¼Œæ•ˆç‡æ¯”HTTPé«˜

### 2.4 rsyncé«˜çº§æŠ€å·§


**ğŸ¨ å®ç”¨æŠ€å·§é›†åˆ**

```bash
# æŠ€å·§1ï¼šæŸ¥çœ‹åŒæ­¥å˜åŒ–ä½†ä¸å®é™…æ‰§è¡Œï¼ˆå¹²è·‘æ¨¡å¼ï¼‰
rsync -avzP --delete --dry-run source/ dest/

# æŠ€å·§2ï¼šæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ç±»å‹
rsync -avzP --delete \
  --exclude="*.iso" \
  --exclude="debug/" \
  source/ dest/

# æŠ€å·§3ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶ç®¡ç†å¤æ‚é€‰é¡¹
rsync --config=/etc/rsync.conf source/ dest/
```

---

## 3. ğŸ—ï¸ æœ¬åœ°è½¯ä»¶æºæ­å»ºå®æˆ˜


### 3.1 ç¯å¢ƒå‡†å¤‡ä¸è§„åˆ’


**ğŸ¯ æ­å»ºå‰çš„å‡†å¤‡å·¥ä½œ**

```bash
# æ£€æŸ¥ç³»ç»Ÿèµ„æº
df -h                    # æŸ¥çœ‹ç£ç›˜ç©ºé—´ï¼ˆè‡³å°‘éœ€è¦500GBï¼‰
free -h                  # æŸ¥çœ‹å†…å­˜æƒ…å†µ
nproc                    # æŸ¥çœ‹CPUæ ¸å¿ƒæ•°

# åˆ›å»ºé•œåƒå­˜å‚¨ç›®å½•
sudo mkdir -p /var/mirror/{ubuntu,centos,debian}
sudo chown -R $(whoami):$(whoami) /var/mirror
```

**ğŸ’¾ å­˜å‚¨ç©ºé—´è§„åˆ’æŒ‡å—**

| å‘è¡Œç‰ˆç±»å‹ | å®Œæ•´é•œåƒå¤§å° | æ¨èç©ºé—´ | è¯´æ˜ |
|-----------|------------|----------|------|
| **Ubuntu** | ~200GB | 300GB | åŒ…å«æ‰€æœ‰ç»„ä»¶å’Œæ¶æ„ |
| **CentOS** | ~150GB | 250GB | åŒ…å«baseã€updatesã€extras |
| **Debian** | ~300GB | 400GB | åŒ…å«mainã€contribã€non-free |
| **Alpine** | ~5GB | 20GB | è½»é‡çº§å‘è¡Œç‰ˆ |

### 3.2 Ubuntuæœ¬åœ°æºæ­å»ºè¯¦è§£


**ğŸ”¸ æ­¥éª¤1ï¼šåŒæ­¥Ubuntuè½¯ä»¶åŒ…**

```bash
# åˆ›å»ºåŒæ­¥è„šæœ¬
cat > /home/sync/ubuntu-sync.sh << 'EOF'
#!/bin/bash

# Ubuntué•œåƒåŒæ­¥è„šæœ¬
MIRROR_ROOT="/var/mirror/ubuntu"
LOG_FILE="/var/log/ubuntu-sync.log"
UPSTREAM="rsync://mirrors.ustc.edu.cn/ubuntu/"

echo "$(date): å¼€å§‹åŒæ­¥Ubuntué•œåƒ..." >> $LOG_FILE

rsync -avzP --delete \
    --exclude="ls-lR.gz" \
    --exclude="Packages*" \
    --exclude="Sources*" \
    --exclude="Release*" \
    --timeout=3600 \
    $UPSTREAM $MIRROR_ROOT/ >> $LOG_FILE 2>&1

if [ $? -eq 0 ]; then
    echo "$(date): Ubuntué•œåƒåŒæ­¥æˆåŠŸ" >> $LOG_FILE
else
    echo "$(date): Ubuntué•œåƒåŒæ­¥å¤±è´¥" >> $LOG_FILE
fi
EOF

# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x /home/sync/ubuntu-sync.sh
```

**ğŸ”¸ æ­¥éª¤2ï¼šé…ç½®WebæœåŠ¡**

```bash
# å®‰è£…nginx
sudo apt update && sudo apt install nginx -y

# é…ç½®nginxè™šæ‹Ÿä¸»æœº
sudo tee /etc/nginx/sites-available/mirror << 'EOF'
server {
    listen 80;
    server_name mirror.company.com;
    root /var/mirror;
    
    location / {
        autoindex on;              # å¼€å¯ç›®å½•æµè§ˆ
        autoindex_exact_size off;  # æ˜¾ç¤ºæ–‡ä»¶å¤§å°çš„å¯è¯»æ ¼å¼
        autoindex_localtime on;    # æ˜¾ç¤ºæœ¬åœ°æ—¶é—´
    }
    
    # Ubuntuæºé…ç½®
    location /ubuntu/ {
        alias /var/mirror/ubuntu/;
    }
    
    # è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/mirror_access.log;
    error_log /var/log/nginx/mirror_error.log;
}
EOF

# å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/mirror /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx
```

### 3.3 CentOSæœ¬åœ°æºæ­å»º


**ğŸ”¸ CentOS YUMæºåŒæ­¥é…ç½®**

```bash
# CentOSåŒæ­¥è„šæœ¬
cat > /home/sync/centos-sync.sh << 'EOF'
#!/bin/bash

CENTOS_VERSIONS="7 8-stream"
MIRROR_ROOT="/var/mirror/centos"
UPSTREAM="rsync://mirrors.aliyun.com/centos/"

for version in $CENTOS_VERSIONS; do
    echo "åŒæ­¥CentOS $version..."
    
    rsync -avzP --delete \
        --include="$version/" \
        --include="$version/os/" \
        --include="$version/updates/" \
        --include="$version/extras/" \
        --exclude="*" \
        $UPSTREAM $MIRROR_ROOT/
        
    # åˆ›å»ºæœ¬åœ°repodataï¼ˆå¦‚æœéœ€è¦ï¼‰
    if command -v createrepo &> /dev/null; then
        createrepo --update $MIRROR_ROOT/$version/os/x86_64/
    fi
done
EOF

chmod +x /home/sync/centos-sync.sh
```

### 3.4 æœ¬åœ°æºä½¿ç”¨é…ç½®


**ğŸ¯ å®¢æˆ·ç«¯é…ç½®ç¤ºä¾‹**

```bash
# Ubuntuå®¢æˆ·ç«¯é…ç½®
sudo tee /etc/apt/sources.list.d/local-mirror.list << EOF
# æœ¬åœ°é•œåƒæºé…ç½®
deb http://mirror.company.com/ubuntu/ focal main restricted universe multiverse
deb http://mirror.company.com/ubuntu/ focal-updates main restricted universe multiverse
deb http://mirror.company.com/ubuntu/ focal-security main restricted universe multiverse
EOF

# CentOSå®¢æˆ·ç«¯é…ç½®
sudo tee /etc/yum.repos.d/local-mirror.repo << EOF
[local-base]
name=Local CentOS Base
baseurl=http://mirror.company.com/centos/7/os/x86_64/
enabled=1
gpgcheck=1
gpgkey=http://mirror.company.com/centos/RPM-GPG-KEY-CentOS-7

[local-updates]
name=Local CentOS Updates
baseurl=http://mirror.company.com/centos/7/updates/x86_64/
enabled=1
gpgcheck=1
gpgkey=http://mirror.company.com/centos/RPM-GPG-KEY-CentOS-7
EOF
```

---

## 4. ğŸ¢ é•œåƒç«™ç‚¹æ¶æ„è®¾è®¡


### 4.1 å•æœºæ¶æ„è®¾è®¡


**ğŸ—ï¸ åŸºç¡€å•æœºæ¶æ„**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           é•œåƒæœåŠ¡å™¨                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åº”ç”¨å±‚ï¼šNginx WebæœåŠ¡å™¨             â”‚
â”‚  â”œâ”€â”€ é™æ€æ–‡ä»¶æœåŠ¡                    â”‚
â”‚  â”œâ”€â”€ ç›®å½•æµè§ˆåŠŸèƒ½                    â”‚
â”‚  â””â”€â”€ è®¿é—®æ—¥å¿—è®°å½•                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å­˜å‚¨å±‚ï¼šæ–‡ä»¶ç³»ç»Ÿ                    â”‚
â”‚  â”œâ”€â”€ /var/mirror/ubuntu (200GB)     â”‚
â”‚  â”œâ”€â”€ /var/mirror/centos (150GB)     â”‚
â”‚  â””â”€â”€ /var/mirror/debian (300GB)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŒæ­¥å±‚ï¼šrsyncå®šæ—¶ä»»åŠ¡               â”‚
â”‚  â”œâ”€â”€ ubuntu-sync.sh (æ¯6å°æ—¶)       â”‚
â”‚  â”œâ”€â”€ centos-sync.sh (æ¯12å°æ—¶)      â”‚
â”‚  â””â”€â”€ åŒæ­¥ç›‘æ§è„šæœ¬                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“Š ç¡¬ä»¶é…ç½®å»ºè®®**

| è§„æ¨¡ | CPU | å†…å­˜ | å­˜å‚¨ | ç½‘ç»œ |
|------|-----|------|------|------|
| **å°å‹** | 4æ ¸ | 8GB | 1TB SSD | 100Mbps |
| **ä¸­å‹** | 8æ ¸ | 16GB | 2TB SSD | 1Gbps |
| **å¤§å‹** | 16æ ¸ | 32GB | 5TB SSD + HDD | 10Gbps |

### 4.2 é«˜å¯ç”¨æ¶æ„è®¾è®¡


**ğŸ”„ ä¸»ä»åŒæ­¥æ¶æ„**
```
    ä¸Šæ¸¸é•œåƒæº
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ä¸»é•œåƒæœåŠ¡å™¨â”‚ â”€â”€â”€â”€â”
    â”‚ Master   â”‚     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ rsyncåŒæ­¥
                    â”‚
              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
              â”‚ä»é•œåƒæœåŠ¡å™¨â”‚
              â”‚ Slave   â”‚
              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                    â”‚
              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
              â”‚è´Ÿè½½å‡è¡¡å™¨ â”‚
              â”‚ Nginx   â”‚
              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚å®¢æˆ·ç«¯ç¾¤ç»„1â”‚            â”‚å®¢æˆ·ç«¯ç¾¤ç»„2â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 ä¼ä¸šçº§æ¶æ„è€ƒè™‘


**ğŸ¯ å…³é”®æ¶æ„è¦ç´ **

| æ¶æ„å±‚é¢ | è®¾è®¡è¦ç‚¹ | å®ç°æ–¹æ¡ˆ |
|---------|---------|----------|
| **å¯ç”¨æ€§** | 99.9%æœåŠ¡å¯ç”¨ | ä¸»ä»çƒ­å¤‡+å¥åº·æ£€æŸ¥ |
| **æ‰©å±•æ€§** | æ”¯æŒä¸šåŠ¡å¢é•¿ | æ°´å¹³æ‰©å±•+CDNåˆ†å‘ |
| **å®‰å…¨æ€§** | è®¿é—®æ§åˆ¶+å®¡è®¡ | IPç™½åå•+è®¿é—®æ—¥å¿— |
| **ç›‘æ§æ€§** | å®æ—¶çŠ¶æ€ç›‘æ§ | Prometheus+Grafana |

---

## 5. ğŸ“œ åŒæ­¥è„šæœ¬ç¼–å†™ä¸ä¼˜åŒ–


### 5.1 æ™ºèƒ½åŒæ­¥è„šæœ¬è®¾è®¡


**ğŸ”§ é«˜çº§åŒæ­¥è„šæœ¬ç¤ºä¾‹**

```bash
#!/bin/bash
# æ™ºèƒ½é•œåƒåŒæ­¥è„šæœ¬ - smart-mirror-sync.sh

# é…ç½®éƒ¨åˆ†
SCRIPT_NAME="SmartMirrorSync"
CONFIG_FILE="/etc/mirror-sync.conf"
LOCK_FILE="/var/run/mirror-sync.lock"
LOG_DIR="/var/log/mirror-sync"

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p $LOG_DIR

# é”æ–‡ä»¶æœºåˆ¶ï¼ˆé˜²æ­¢é‡å¤è¿è¡Œï¼‰
if [ -f "$LOCK_FILE" ]; then
    echo "åŒæ­¥è„šæœ¬å·²åœ¨è¿è¡Œä¸­ï¼Œé€€å‡º..."
    exit 1
fi
echo $$ > $LOCK_FILE

# æ¸…ç†å‡½æ•°
cleanup() {
    rm -f $LOCK_FILE
    echo "$(date): åŒæ­¥ä»»åŠ¡ç»“æŸ"
}
trap cleanup EXIT

# æ—¥å¿—è®°å½•å‡½æ•°
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S'): $1" | tee -a $LOG_DIR/sync.log
}

# ç½‘ç»œæ£€æµ‹å‡½æ•°
check_network() {
    local upstream=$1
    if ! ping -c 3 -W 5 $(echo $upstream | cut -d'/' -f3) > /dev/null 2>&1; then
        log_message "ç½‘ç»œä¸å¯è¾¾: $upstream"
        return 1
    fi
    return 0
}

# ç£ç›˜ç©ºé—´æ£€æŸ¥
check_disk_space() {
    local path=$1
    local required_gb=$2
    local available=$(df $path | awk 'NR==2 {print int($4/1024/1024)}')
    
    if [ $available -lt $required_gb ]; then
        log_message "ç£ç›˜ç©ºé—´ä¸è¶³: éœ€è¦${required_gb}GBï¼Œå¯ç”¨${available}GB"
        return 1
    fi
    return 0
}

# ä¸»åŒæ­¥å‡½æ•°
sync_repository() {
    local name=$1
    local upstream=$2  
    local local_path=$3
    local required_space=$4
    
    log_message "å¼€å§‹åŒæ­¥: $name"
    
    # é¢„æ£€æŸ¥
    if ! check_network $upstream || ! check_disk_space $local_path $required_space; then
        log_message "é¢„æ£€æŸ¥å¤±è´¥ï¼Œè·³è¿‡ $name"
        return 1
    fi
    
    # æ‰§è¡ŒåŒæ­¥
    rsync -avzP --delete \
        --timeout=3600 \
        --log-file=$LOG_DIR/${name}-sync.log \
        $upstream $local_path/
        
    local exit_code=$?
    if [ $exit_code -eq 0 ]; then
        log_message "$name åŒæ­¥æˆåŠŸ"
        # æ›´æ–°åŒæ­¥æ—¶é—´æˆ³
        echo "$(date)" > $local_path/.last_sync
    else
        log_message "$name åŒæ­¥å¤±è´¥ï¼Œé€€å‡ºç : $exit_code"
    fi
    
    return $exit_code
}

# ä¸»ç¨‹åº
main() {
    log_message "å¼€å§‹é•œåƒåŒæ­¥ä»»åŠ¡"
    
    # åŒæ­¥Ubuntu
    sync_repository "Ubuntu" \
        "rsync://mirrors.ustc.edu.cn/ubuntu/" \
        "/var/mirror/ubuntu" \
        300
    
    # åŒæ­¥CentOS
    sync_repository "CentOS" \
        "rsync://mirrors.aliyun.com/centos/" \
        "/var/mirror/centos" \
        200
    
    log_message "æ‰€æœ‰åŒæ­¥ä»»åŠ¡å®Œæˆ"
}

# æ‰§è¡Œä¸»ç¨‹åº
main "$@"
```

### 5.2 åŒæ­¥è„šæœ¬ä¼˜åŒ–æŠ€å·§


**âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**

| ä¼˜åŒ–æ–¹å‘ | å…·ä½“æ–¹æ³• | æ•ˆæœ |
|---------|---------|------|
| **å¹¶è¡ŒåŒæ­¥** | å¤šä¸ªä»“åº“åŒæ—¶åŒæ­¥ | æ—¶é—´èŠ‚çœ50% |
| **å¢é‡åŒæ­¥** | åªåŒæ­¥å˜åŒ–æ–‡ä»¶ | å¸¦å®½èŠ‚çœ80% |
| **å‹ç¼©ä¼ è¾“** | å¯ç”¨rsyncå‹ç¼© | ä¼ è¾“æ•ˆç‡æå‡30% |
| **æœ¬åœ°ç¼“å­˜** | ä¸­é—´ç¼“å­˜æœºåˆ¶ | å‡å°‘é‡å¤ä¸‹è½½ |

```bash
# å¹¶è¡ŒåŒæ­¥ç¤ºä¾‹
sync_ubuntu() {
    rsync -avzP rsync://ubuntu.com/ubuntu/ /var/mirror/ubuntu/
}

sync_centos() {
    rsync -avzP rsync://centos.org/centos/ /var/mirror/centos/
}

# åå°å¹¶è¡Œæ‰§è¡Œ
sync_ubuntu & 
PID1=$!

sync_centos &
PID2=$!

# ç­‰å¾…æ‰€æœ‰åŒæ­¥å®Œæˆ
wait $PID1 $PID2
echo "æ‰€æœ‰åŒæ­¥å®Œæˆ"
```

### 5.3 å®šæ—¶ä»»åŠ¡é…ç½®


**â° Crontabå®šæ—¶é…ç½®**

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ å®šæ—¶ä»»åŠ¡
# æ¯å¤©å‡Œæ™¨2ç‚¹åŒæ­¥Ubuntu
0 2 * * * /home/sync/ubuntu-sync.sh >> /var/log/ubuntu-cron.log 2>&1

# æ¯å¤©å‡Œæ™¨4ç‚¹åŒæ­¥CentOS  
0 4 * * * /home/sync/centos-sync.sh >> /var/log/centos-cron.log 2>&1

# æ¯å‘¨æ—¥å‡Œæ™¨6ç‚¹æ‰§è¡Œå®Œæ•´åŒæ­¥
0 6 * * 0 /home/sync/full-sync.sh >> /var/log/full-sync.log 2>&1
```

**ğŸ“Š å®šæ—¶ç­–ç•¥å»ºè®®**

| ä»“åº“ç±»å‹ | æ›´æ–°é¢‘ç‡ | æ¨èåŒæ­¥é—´éš” | åŒæ­¥æ—¶é—´ |
|---------|---------|------------|---------|
| **Ubuntu** | æ¯å¤©å¤šæ¬¡ | 6å°æ—¶ | 02:00, 08:00, 14:00, 20:00 |
| **CentOS** | æ¯å¤©1-2æ¬¡ | 12å°æ—¶ | 02:00, 14:00 |
| **Debian** | æ¯å¤©1æ¬¡ | 24å°æ—¶ | 03:00 |
| **Alpine** | æŒ‰éœ€æ›´æ–° | 48å°æ—¶ | 04:00ï¼ˆéš”å¤©ï¼‰ |

---

## 6. ğŸ“… é•œåƒæ›´æ–°ç­–ç•¥ç®¡ç†


### 6.1 æ›´æ–°ç­–ç•¥åˆ†ç±»


**ğŸ¯ ä¸åŒåœºæ™¯çš„æ›´æ–°ç­–ç•¥**

```
ç”Ÿäº§ç¯å¢ƒç­–ç•¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç¨³å®šä¼˜å…ˆ   â”‚   å‡è¡¡ç­–ç•¥   â”‚   æ—¶æ•ˆä¼˜å…ˆ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ¯å‘¨æ›´æ–°1æ¬¡  â”‚  æ¯å¤©æ›´æ–°1æ¬¡ â”‚  æ¯6å°æ—¶æ›´æ–° â”‚
â”‚ å……åˆ†æµ‹è¯•éªŒè¯ â”‚  åŸºç¡€éªŒè¯    â”‚  å®æ—¶è·Ÿè¿›    â”‚
â”‚ é€‚åˆæ ¸å¿ƒç³»ç»Ÿ â”‚  é€‚åˆæ™®é€šåº”ç”¨â”‚  é€‚åˆå¼€å‘ç¯å¢ƒâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ç‰ˆæœ¬æ§åˆ¶ä¸å›æ»šæœºåˆ¶


**ğŸ”„ å¿«ç…§å¼ç‰ˆæœ¬ç®¡ç†**

```bash
# ç‰ˆæœ¬å¿«ç…§è„šæœ¬
create_snapshot() {
    local repo_name=$1
    local snapshot_dir="/var/mirror/snapshots/$repo_name"
    local current_time=$(date +%Y%m%d_%H%M%S)
    
    # åˆ›å»ºå¿«ç…§ç›®å½•
    mkdir -p $snapshot_dir
    
    # åˆ›å»ºç¡¬é“¾æ¥å¿«ç…§ï¼ˆèŠ‚çœç©ºé—´ï¼‰
    cp -al /var/mirror/$repo_name $snapshot_dir/$current_time
    
    echo "å¿«ç…§åˆ›å»ºå®Œæˆ: $snapshot_dir/$current_time"
    
    # ä¿ç•™æœ€è¿‘7ä¸ªå¿«ç…§
    cd $snapshot_dir
    ls -t | tail -n +8 | xargs rm -rf
}

# å›æ»šåˆ°æŒ‡å®šå¿«ç…§
rollback_to_snapshot() {
    local repo_name=$1
    local snapshot_name=$2
    local backup_current="/var/mirror/${repo_name}_backup_$(date +%Y%m%d_%H%M%S)"
    
    # å¤‡ä»½å½“å‰ç‰ˆæœ¬
    mv /var/mirror/$repo_name $backup_current
    
    # æ¢å¤åˆ°æŒ‡å®šå¿«ç…§
    cp -al /var/mirror/snapshots/$repo_name/$snapshot_name /var/mirror/$repo_name
    
    echo "å·²å›æ»šåˆ°å¿«ç…§: $snapshot_name"
    echo "åŸç‰ˆæœ¬å¤‡ä»½åœ¨: $backup_current"
}
```

### 6.3 å¢é‡æ›´æ–°ä¼˜åŒ–


**âš¡ æ™ºèƒ½å¢é‡æ›´æ–°æœºåˆ¶**

| æ›´æ–°ç±»å‹ | æ£€æµ‹æ–¹å¼ | æ›´æ–°ç­–ç•¥ | é€‚ç”¨åœºæ™¯ |
|---------|---------|----------|----------|
| **æ–‡ä»¶çº§å¢é‡** | MD5æ ¡éªŒ | åªæ›´æ–°å˜åŒ–æ–‡ä»¶ | å¤§æ–‡ä»¶å°‘é‡å˜åŒ– |
| **åŒ…çº§å¢é‡** | ç‰ˆæœ¬å·å¯¹æ¯” | åªä¸‹è½½æ–°ç‰ˆæœ¬åŒ… | è½¯ä»¶åŒ…ä»“åº“ |
| **æ—¶é—´æˆ³å¢é‡** | ä¿®æ”¹æ—¶é—´ | åŸºäºæ—¶é—´è¿‡æ»¤ | æ—¥å¿—ã€æ–‡æ¡£ç±» |
| **å·®å¼‚åŒæ­¥** | rsyncç®—æ³• | äºŒè¿›åˆ¶çº§å·®å¼‚ | ä»»ä½•æ–‡ä»¶ç±»å‹ |

```bash
# æ™ºèƒ½å¢é‡æ›´æ–°ç¤ºä¾‹
smart_incremental_sync() {
    local repo_name=$1
    local upstream=$2
    local local_path=$3
    
    # è·å–è¿œç¨‹æœ€åä¿®æ”¹æ—¶é—´
    remote_timestamp=$(curl -s -I $upstream | grep -i last-modified | cut -d' ' -f2-)
    
    # è·å–æœ¬åœ°æœ€ååŒæ­¥æ—¶é—´
    if [ -f "$local_path/.last_sync_time" ]; then
        local_timestamp=$(cat $local_path/.last_sync_time)
    else
        local_timestamp=""
    fi
    
    # æ¯”è¾ƒæ—¶é—´æˆ³å†³å®šæ˜¯å¦åŒæ­¥
    if [ "$remote_timestamp" != "$local_timestamp" ]; then
        echo "æ£€æµ‹åˆ°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
        rsync -avzP --delete $upstream $local_path/
        echo "$remote_timestamp" > $local_path/.last_sync_time
    else
        echo "æ— æ›´æ–°ï¼Œè·³è¿‡åŒæ­¥"
    fi
}
```

---

## 7. ğŸ” æœ¬åœ°æºè®¿é—®æ§åˆ¶


### 7.1 ç½‘ç»œè®¿é—®æ§åˆ¶


**ğŸ›¡ï¸ IPç™½åå•é…ç½®**

```nginx
# Nginxè®¿é—®æ§åˆ¶é…ç½®
server {
    listen 80;
    server_name mirror.company.com;
    root /var/mirror;
    
    # å…è®¸å†…ç½‘è®¿é—®
    allow 192.168.0.0/16;
    allow 172.16.0.0/12;
    allow 10.0.0.0/8;
    
    # å…è®¸ç‰¹å®šå¤–ç½‘IP
    allow 203.0.113.10;
    allow 198.51.100.0/24;
    
    # æ‹’ç»å…¶ä»–æ‰€æœ‰IP
    deny all;
    
    location / {
        autoindex on;
    }
    
    # ç®¡ç†æ¥å£æ›´ä¸¥æ ¼æ§åˆ¶
    location /admin/ {
        allow 192.168.1.10;  # åªå…è®¸ç®¡ç†å‘˜IP
        deny all;
        
        auth_basic "ç®¡ç†åŒºåŸŸ";
        auth_basic_user_file /etc/nginx/.htpasswd;
    }
}
```

### 7.2 ç”¨æˆ·è®¤è¯æœºåˆ¶


**ğŸ”‘ åŸºç¡€HTTPè®¤è¯é…ç½®**

```bash
# åˆ›å»ºè®¤è¯ç”¨æˆ·
sudo apt install apache2-utils -y

# æ·»åŠ ç”¨æˆ·åˆ°å¯†ç æ–‡ä»¶
sudo htpasswd -c /etc/nginx/.htpasswd admin
sudo htpasswd /etc/nginx/.htpasswd developer
sudo htpasswd /etc/nginx/.htpasswd readonly

# è®¾ç½®åˆé€‚çš„æƒé™
sudo chown root:www-data /etc/nginx/.htpasswd
sudo chmod 640 /etc/nginx/.htpasswd
```

### 7.3 å¸¦å®½é™åˆ¶ä¸QoS


**ğŸ“Š æµé‡æ§åˆ¶é…ç½®**

```nginx
# åŸºäºç”¨æˆ·çš„å¸¦å®½é™åˆ¶
http {
    # å®šä¹‰é™é€ŸåŒºåŸŸ
    limit_rate_zone $binary_remote_addr zone=download:10m rate=10r/s;
    
    server {
        location /ubuntu/ {
            # æ™®é€šç”¨æˆ·é™é€Ÿ1MB/s
            limit_rate 1m;
            
            # VIPç”¨æˆ·ä¸é™é€Ÿ
            if ($remote_user = "admin") {
                limit_rate 0;
            }
        }
        
        location /centos/ {
            # ä½¿ç”¨å…±äº«é™é€Ÿæ± 
            limit_req zone=download burst=5 nodelay;
            limit_rate 512k;
        }
    }
}
```

### 7.4 è®¿é—®å®¡è®¡ä¸æ—¥å¿—


**ğŸ“ è¯¦ç»†è®¿é—®æ—¥å¿—é…ç½®**

```nginx
# è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
log_format mirror_access '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        '$request_time $upstream_response_time';

server {
    # åˆ†ç±»è®°å½•è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/mirror_access.log mirror_access;
    error_log /var/log/nginx/mirror_error.log;
    
    # ç‰¹æ®Šè·¯å¾„å•ç‹¬è®°å½•
    location /ubuntu/ {
        access_log /var/log/nginx/ubuntu_access.log mirror_access;
    }
    
    location /centos/ {
        access_log /var/log/nginx/centos_access.log mirror_access;
    }
}
```

---

## 8. ğŸ“Š é•œåƒåŒæ­¥ç›‘æ§ä½“ç³»


### 8.1 åŒæ­¥çŠ¶æ€ç›‘æ§


**âš¡ å®æ—¶ç›‘æ§è„šæœ¬**

```bash
#!/bin/bash
# é•œåƒåŒæ­¥ç›‘æ§è„šæœ¬ - mirror-monitor.sh

MONITOR_LOG="/var/log/mirror-monitor.log"
ALERT_EMAIL="admin@company.com"

# ç›‘æ§æŒ‡æ ‡æ”¶é›†
collect_metrics() {
    local repo_path=$1
    local repo_name=$2
    
    # è®¡ç®—ä»“åº“å¤§å°
    local repo_size=$(du -sh $repo_path | cut -f1)
    
    # æ£€æŸ¥æœ€ååŒæ­¥æ—¶é—´
    if [ -f "$repo_path/.last_sync" ]; then
        local last_sync=$(cat $repo_path/.last_sync)
        local sync_age=$(($(date +%s) - $(date -d "$last_sync" +%s)))
    else
        local sync_age=999999
    fi
    
    # è¾“å‡ºç›‘æ§æ•°æ®
    echo "$repo_name:size=$repo_size:age=${sync_age}s"
}

# å¥åº·æ£€æŸ¥
health_check() {
    local repo_name=$1
    local max_age=$2  # æœ€å¤§å…è®¸çš„åŒæ­¥é—´éš”ï¼ˆç§’ï¼‰
    
    local metrics=$(collect_metrics "/var/mirror/$repo_name" "$repo_name")
    local sync_age=$(echo $metrics | cut -d: -f3 | sed 's/age=\|s//g')
    
    if [ $sync_age -gt $max_age ]; then
        echo "CRITICAL: $repo_name åŒæ­¥å·²è¿‡æœŸ ${sync_age}ç§’"
        return 1
    else
        echo "OK: $repo_name åŒæ­¥æ­£å¸¸"
        return 0
    fi
}

# å‘é€å‘Šè­¦
send_alert() {
    local message=$1
    echo "$message" | mail -s "é•œåƒåŒæ­¥å‘Šè­¦" $ALERT_EMAIL
    echo "$(date): ALERT - $message" >> $MONITOR_LOG
}

# ä¸»ç›‘æ§é€»è¾‘
main() {
    echo "$(date): å¼€å§‹ç›‘æ§æ£€æŸ¥" >> $MONITOR_LOG
    
    # æ£€æŸ¥å„ä¸ªä»“åº“
    if ! health_check "ubuntu" 43200; then  # 12å°æ—¶
        send_alert "Ubuntué•œåƒåŒæ­¥å¼‚å¸¸"
    fi
    
    if ! health_check "centos" 86400; then  # 24å°æ—¶  
        send_alert "CentOSé•œåƒåŒæ­¥å¼‚å¸¸"
    fi
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    local disk_usage=$(df /var/mirror | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ $disk_usage -gt 85 ]; then
        send_alert "é•œåƒå­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œä½¿ç”¨ç‡: ${disk_usage}%"
    fi
    
    echo "$(date): ç›‘æ§æ£€æŸ¥å®Œæˆ" >> $MONITOR_LOG
}

main "$@"
```

### 8.2 Prometheusç›‘æ§é›†æˆ


**ğŸ“ˆ æŒ‡æ ‡æš´éœ²é…ç½®**

```bash
# åˆ›å»ºPrometheusæŒ‡æ ‡æš´éœ²è„šæœ¬
cat > /opt/mirror-exporter.sh << 'EOF'
#!/bin/bash
# Prometheus Node Exporterè‡ªå®šä¹‰æŒ‡æ ‡

TEXTFILE_DIR="/var/lib/node_exporter/textfile_collector"
mkdir -p $TEXTFILE_DIR

# æ”¶é›†é•œåƒä»“åº“æŒ‡æ ‡
collect_repo_metrics() {
    local repo_name=$1
    local repo_path="/var/mirror/$repo_name"
    
    if [ -d "$repo_path" ]; then
        # ä»“åº“å¤§å°ï¼ˆå­—èŠ‚ï¼‰
        local size_bytes=$(du -sb $repo_path | cut -f1)
        echo "mirror_repository_size_bytes{repo=\"$repo_name\"} $size_bytes"
        
        # æœ€ååŒæ­¥æ—¶é—´æˆ³
        if [ -f "$repo_path/.last_sync" ]; then
            local last_sync_ts=$(date -d "$(cat $repo_path/.last_sync)" +%s)
            echo "mirror_last_sync_timestamp{repo=\"$repo_name\"} $last_sync_ts"
        fi
        
        # æ–‡ä»¶æ•°é‡
        local file_count=$(find $repo_path -type f | wc -l)
        echo "mirror_file_count{repo=\"$repo_name\"} $file_count"
    fi
}

# ç”ŸæˆæŒ‡æ ‡æ–‡ä»¶
{
    collect_repo_metrics "ubuntu"
    collect_repo_metrics "centos"
    collect_repo_metrics "debian"
} > $TEXTFILE_DIR/mirror_metrics.prom
EOF

# å®šæ—¶æ”¶é›†æŒ‡æ ‡
echo "*/5 * * * * /opt/mirror-exporter.sh" | crontab -
```

### 8.3 Grafanaä»ªè¡¨ç›˜é…ç½®


**ğŸ“Š å…³é”®ç›‘æ§é¢æ¿**

| é¢æ¿ç±»å‹ | ç›‘æ§æŒ‡æ ‡ | å‘Šè­¦é˜ˆå€¼ | è¯´æ˜ |
|---------|---------|----------|------|
| **åŒæ­¥çŠ¶æ€** | æœ€ååŒæ­¥æ—¶é—´ | >12å°æ—¶ | åŒæ­¥æ˜¯å¦æ­£å¸¸ |
| **å­˜å‚¨ä½¿ç”¨** | ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡ | >85% | å­˜å‚¨ç©ºé—´ç›‘æ§ |
| **ç½‘ç»œæµé‡** | ä¸‹è½½å¸¦å®½ä½¿ç”¨ | >80%å¸¦å®½ | ç½‘ç»œè´Ÿè½½ç›‘æ§ |
| **é”™è¯¯ç»Ÿè®¡** | åŒæ­¥å¤±è´¥æ¬¡æ•° | >3æ¬¡/å¤© | é”™è¯¯è¶‹åŠ¿åˆ†æ |

---

## 9. ğŸŒ CDNé•œåƒåˆ†å‘æ¶æ„


### 9.1 CDNåˆ†å‘åŸç†


**ğŸ”„ CDNé•œåƒåˆ†å‘æ¶æ„å›¾**
```
          å®˜æ–¹æº
             â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚ä¸»é•œåƒèŠ‚ç‚¹ â”‚ â”€â”€â”€â”€â”€â”€â”
        â”‚ Beijing â”‚       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
             â”‚            â”‚ å†…å®¹åˆ†å‘
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”‚
        â”‚ CDNç½‘ç»œ â”‚ â†â”€â”€â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
â”‚è¾¹ç¼˜èŠ‚ç‚¹â”‚ â”‚è¾¹ç¼˜èŠ‚ç‚¹â”‚ â”‚è¾¹ç¼˜èŠ‚ç‚¹â”‚
â”‚ä¸Šæµ·    â”‚ â”‚å¹¿å·    â”‚ â”‚æˆéƒ½    â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜
    â”‚         â”‚         â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
â”‚ç”¨æˆ·ç¾¤Aâ”‚ â”‚ç”¨æˆ·ç¾¤Bâ”‚ â”‚ç”¨æˆ·ç¾¤Câ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 å¤šèŠ‚ç‚¹åŒæ­¥ç­–ç•¥


**ğŸ¯ åˆ†å±‚åŒæ­¥é…ç½®**

```bash
# ä¸»èŠ‚ç‚¹åˆ°è¾¹ç¼˜èŠ‚ç‚¹åŒæ­¥è„šæœ¬
#!/bin/bash
# cdn-sync.sh - CDNèŠ‚ç‚¹åŒæ­¥è„šæœ¬

# é…ç½®è¾¹ç¼˜èŠ‚ç‚¹åˆ—è¡¨
EDGE_NODES=(
    "edge1.shanghai.company.com"
    "edge2.guangzhou.company.com" 
    "edge3.chengdu.company.com"
)

# ä¸»èŠ‚ç‚¹æ•°æ®ç›®å½•
MASTER_DATA="/var/mirror"

# åŒæ­¥åˆ°è¾¹ç¼˜èŠ‚ç‚¹
sync_to_edge_nodes() {
    local repo_name=$1
    
    for node in "${EDGE_NODES[@]}"; do
        echo "åŒæ­¥ $repo_name åˆ° $node..."
        
        rsync -avzP --delete \
            --bwlimit=50000 \
            $MASTER_DATA/$repo_name/ \
            edge-sync@$node:/var/mirror/$repo_name/ &
            
        # è®°å½•åŒæ­¥è¿›ç¨‹ID
        echo $! >> /tmp/sync_pids
    done
    
    # ç­‰å¾…æ‰€æœ‰åŒæ­¥å®Œæˆ
    wait $(cat /tmp/sync_pids)
    rm -f /tmp/sync_pids
    
    echo "$repo_name å·²åŒæ­¥åˆ°æ‰€æœ‰è¾¹ç¼˜èŠ‚ç‚¹"
}

# æ‰§è¡ŒåŒæ­¥
sync_to_edge_nodes "ubuntu"
sync_to_edge_nodes "centos"
```

### 9.3 æ™ºèƒ½è´Ÿè½½å‡è¡¡


**âš–ï¸ DNSè½®è¯¢+åœ°ç†ä½ç½®åˆ†å‘**

```bash
# DNSé…ç½®ç¤ºä¾‹ï¼ˆbind9ï¼‰
# /etc/bind/mirror.company.com.zone

$TTL    300
@       IN      SOA     ns1.company.com. admin.company.com. (
                2023091901      ; serial
                3600            ; refresh
                1800            ; retry  
                1209600         ; expire
                300 )           ; minimum

@       IN      NS      ns1.company.com.

; åŸºäºåœ°ç†ä½ç½®çš„CDNåˆ†å‘
mirror  IN      A       203.0.113.10    ; åŒ—äº¬èŠ‚ç‚¹
        IN      A       203.0.113.20    ; ä¸Šæµ·èŠ‚ç‚¹  
        IN      A       203.0.113.30    ; å¹¿å·èŠ‚ç‚¹

; é’ˆå¯¹ä¸åŒåœ°åŒºçš„ç‰¹å®šè®°å½•
beijing.mirror  IN  A   203.0.113.10
shanghai.mirror IN  A   203.0.113.20
guangzhou.mirror IN A   203.0.113.30
```

### 9.4 CDNæ€§èƒ½ç›‘æ§


**ğŸ“Š CDNèŠ‚ç‚¹æ€§èƒ½ç›‘æ§**

```bash
# CDNèŠ‚ç‚¹å¥åº·æ£€æŸ¥è„šæœ¬
#!/bin/bash
# cdn-health-check.sh

check_node_health() {
    local node_url=$1
    local node_name=$2
    
    # ä¸‹è½½æµ‹è¯•æ–‡ä»¶æ£€æŸ¥é€Ÿåº¦
    local start_time=$(date +%s.%N)
    curl -s -o /dev/null "$node_url/test-file.txt"
    local end_time=$(date +%s.%N)
    
    local response_time=$(echo "$end_time - $start_time" | bc)
    
    # è¾“å‡ºç›‘æ§æŒ‡æ ‡
    echo "cdn_response_time{node=\"$node_name\"} $response_time"
    
    # æ£€æŸ¥HTTPçŠ¶æ€ç 
    local http_code=$(curl -s -o /dev/null -w "%{http_code}" "$node_url")
    if [ "$http_code" = "200" ]; then
        echo "cdn_node_status{node=\"$node_name\"} 1"
    else
        echo "cdn_node_status{node=\"$node_name\"} 0"
    fi
}

# æ£€æŸ¥æ‰€æœ‰èŠ‚ç‚¹
check_node_health "http://beijing.mirror.company.com" "beijing"
check_node_health "http://shanghai.mirror.company.com" "shanghai"  
check_node_health "http://guangzhou.mirror.company.com" "guangzhou"
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


ğŸ”¸ **é•œåƒåŒæ­¥æœ¬è´¨**ï¼šå°†è¿œç¨‹è½¯ä»¶ä»“åº“å®Œæ•´å¤åˆ¶åˆ°æœ¬åœ°ï¼Œå¹¶ä¿æŒå®šæœŸæ›´æ–°çš„è¿‡ç¨‹
ğŸ”¸ **rsyncæ ¸å¿ƒä¼˜åŠ¿**ï¼šå¢é‡åŒæ­¥ã€æ–­ç‚¹ç»­ä¼ ã€æƒé™ä¿æŒã€å‹ç¼©ä¼ è¾“
ğŸ”¸ **æœ¬åœ°æºä»·å€¼**ï¼šé€Ÿåº¦æå‡ã€ç½‘ç»œç¨³å®šã€æˆæœ¬èŠ‚çº¦ã€ç®¡æ§ç»Ÿä¸€
ğŸ”¸ **åŒæ­¥ç­–ç•¥åˆ†ç±»**ï¼šç¨³å®šä¼˜å…ˆã€å‡è¡¡ç­–ç•¥ã€æ—¶æ•ˆä¼˜å…ˆ
ğŸ”¸ **è®¿é—®æ§åˆ¶è¦ç´ **ï¼šIPç™½åå•ã€ç”¨æˆ·è®¤è¯ã€å¸¦å®½é™åˆ¶ã€å®¡è®¡æ—¥å¿—

### 10.2 å…³é”®æŠ€æœ¯è¦ç‚¹


**ğŸ”¹ rsyncä½¿ç”¨ç²¾é«“**
```
å¿…ç”¨é€‰é¡¹ç»„åˆï¼š-avzP --delete
â€¢ -a: å½’æ¡£æ¨¡å¼ï¼Œä¿æŒæ–‡ä»¶å®Œæ•´å±æ€§
â€¢ -v: è¯¦ç»†è¾“å‡ºï¼Œä¾¿äºç›‘æ§åŒæ­¥è¿‡ç¨‹  
â€¢ -z: å‹ç¼©ä¼ è¾“ï¼ŒèŠ‚çœç½‘ç»œå¸¦å®½
â€¢ -P: è¿›åº¦æ˜¾ç¤º+æ–­ç‚¹ç»­ä¼ 
â€¢ --delete: ä¿æŒç›®æ ‡ä¸æºå®Œå…¨ä¸€è‡´
```

**ğŸ”¹ è„šæœ¬ç¼–å†™è¦ç‚¹**
```
æ™ºèƒ½è„šæœ¬å¿…å¤‡åŠŸèƒ½ï¼š
â€¢ é”æ–‡ä»¶æœºåˆ¶ï¼šé˜²æ­¢é‡å¤è¿è¡Œ
â€¢ é¢„æ£€æŸ¥ï¼šç½‘ç»œè¿é€šæ€§+ç£ç›˜ç©ºé—´
â€¢ æ—¥å¿—è®°å½•ï¼šè¯¦ç»†çš„æ“ä½œå’Œé”™è¯¯æ—¥å¿—
â€¢ é”™è¯¯å¤„ç†ï¼šä¼˜é›…çš„å¼‚å¸¸å¤„ç†å’Œæ¢å¤
â€¢ å¹¶è¡Œå¤„ç†ï¼šæé«˜åŒæ­¥æ•ˆç‡
```

**ğŸ”¹ ç›‘æ§ä½“ç³»è¦ç‚¹**
```
å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š
â€¢ åŒæ­¥æ—¶æ•ˆæ€§ï¼šæœ€ååŒæ­¥æ—¶é—´ < 12å°æ—¶
â€¢ å­˜å‚¨å®¹é‡ï¼šç£ç›˜ä½¿ç”¨ç‡ < 85%
â€¢ ç½‘ç»œçŠ¶å†µï¼šå¸¦å®½ä½¿ç”¨ < 80%
â€¢ é”™è¯¯é¢‘ç‡ï¼šåŒæ­¥å¤±è´¥ < 3æ¬¡/å¤©
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… é€‚ç”¨åœºæ™¯åˆ¤æ–­**
- ä¼ä¸šå†…ç½‘ç¯å¢ƒï¼Œå¤–ç½‘å¸¦å®½æœ‰é™
- å¤§é‡æœåŠ¡å™¨éœ€è¦è½¯ä»¶åŒ…å®‰è£…
- å¯¹è½¯ä»¶ç‰ˆæœ¬æœ‰ç»Ÿä¸€ç®¡æ§éœ€æ±‚
- ç½‘ç»œç¯å¢ƒä¸ç¨³å®šï¼Œéœ€è¦æœ¬åœ°å¤‡ä»½

**âš ï¸ æ³¨æ„äº‹é¡¹**
- å­˜å‚¨å®¹é‡è§„åˆ’è¦ç•™è¶³ä½™é‡ï¼ˆè‡³å°‘1.5å€ï¼‰
- ç½‘ç»œå¸¦å®½æ§åˆ¶é¿å…å½±å“æ­£å¸¸ä¸šåŠ¡
- å®šæœŸæ£€æŸ¥åŒæ­¥æ—¥å¿—ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
- å»ºç«‹å®Œå–„çš„å¤‡ä»½å’Œå›æ»šæœºåˆ¶

### 10.4 è¿›é˜¶ä¼˜åŒ–æ–¹å‘


**ğŸš€ æ€§èƒ½ä¼˜åŒ–**
- **å¹¶è¡ŒåŒæ­¥**ï¼šå¤šä»“åº“åŒæ—¶æ›´æ–°ï¼Œæ—¶é—´èŠ‚çœ50%
- **å¢é‡ä¼˜åŒ–**ï¼šæ™ºèƒ½æ£€æµ‹å˜åŒ–ï¼Œå¸¦å®½èŠ‚çœ80%
- **æœ¬åœ°ç¼“å­˜**ï¼šå‡å°‘é‡å¤ä¼ è¾“ï¼Œæ•ˆç‡æå‡30%
- **CDNåˆ†å‘**ï¼šå°±è¿‘è®¿é—®ï¼Œç”¨æˆ·ä½“éªŒå¤§å¹…æå‡

**ğŸ“ˆ æ¶æ„æ¼”è¿›**
- **å•æœº â†’ ä¸»ä»**ï¼šæé«˜å¯ç”¨æ€§
- **ä¸»ä» â†’ åˆ†å¸ƒå¼**ï¼šæ”¯æŒæ›´å¤§è§„æ¨¡
- **æœ¬åœ° â†’ CDN**ï¼šå…¨å›½èŒƒå›´è¦†ç›–
- **é™æ€ â†’ æ™ºèƒ½**ï¼šè‡ªé€‚åº”è´Ÿè½½å‡è¡¡

### 10.5 æ•…éšœå¤„ç†ä¸è¿ç»´


**ğŸ”§ å¸¸è§é—®é¢˜è§£å†³**

| é—®é¢˜ç±»å‹ | ç—‡çŠ¶è¡¨ç° | è§£å†³æ–¹æ³• |
|---------|---------|----------|
| **åŒæ­¥ä¸­æ–­** | rsyncè¿›ç¨‹å¼‚å¸¸é€€å‡º | æ£€æŸ¥ç½‘ç»œ+é‡æ–°å¯åŠ¨åŒæ­¥ |
| **ç©ºé—´ä¸è¶³** | ç£ç›˜å†™å…¥å¤±è´¥ | æ¸…ç†æ—§æ–‡ä»¶+æ‰©å®¹å­˜å‚¨ |
| **æƒé™é”™è¯¯** | 403/404è®¿é—®é”™è¯¯ | æ£€æŸ¥nginxé…ç½®+æ–‡ä»¶æƒé™ |
| **å¸¦å®½å æ»¡** | ç½‘ç»œå¡é¡¿ | å¯ç”¨é™é€Ÿ+è°ƒæ•´åŒæ­¥æ—¶é—´ |

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- é•œåƒåŒæ­¥ä¸‰è¦ç´ ï¼šrsyncå·¥å…·+å®šæ—¶ä»»åŠ¡+WebæœåŠ¡
- è„šæœ¬ç¼–å†™äº”åŸåˆ™ï¼šé”+æ£€+æ—¥å¿—+é”™è¯¯å¤„ç†+å¹¶è¡Œ  
- ç›‘æ§å‘Šè­¦å››æŒ‡æ ‡ï¼šæ—¶æ•ˆ+ç©ºé—´+ç½‘ç»œ+é”™è¯¯
- ä¼˜åŒ–æå‡åŒæ–¹å‘ï¼šæŠ€æœ¯ä¼˜åŒ–+æ¶æ„å‡çº§