---
title: 9ã€DHCPå®¢æˆ·ç«¯DNSé…ç½®
---
## ðŸ“š ç›®å½•

1. [DHCPä¸ŽDNSåŸºç¡€æ¦‚å¿µ](#1-DHCPä¸ŽDNSåŸºç¡€æ¦‚å¿µ)
2. [DHCPå®¢æˆ·ç«¯DNSè‡ªåŠ¨èŽ·å–æœºåˆ¶](#2-DHCPå®¢æˆ·ç«¯DNSè‡ªåŠ¨èŽ·å–æœºåˆ¶)
3. [dhclienté…ç½®æ–‡ä»¶DNSé€‰é¡¹](#3-dhclienté…ç½®æ–‡ä»¶DNSé€‰é¡¹)
4. [é™æ€DNSä¸ŽDHCP DNSä¼˜å…ˆçº§å¤„ç†](#4-é™æ€DNSä¸ŽDHCP-DNSä¼˜å…ˆçº§å¤„ç†)
5. [DHCP DNSè¦†ç›–ä¸Žè¿½åŠ é…ç½®](#5-DHCP-DNSè¦†ç›–ä¸Žè¿½åŠ é…ç½®)
6. [NetworkManager DHCP DNSå¤„ç†](#6-NetworkManager-DHCP-DNSå¤„ç†)
7. [systemd-networkd DHCP DNSé…ç½®](#7-systemd-networkd-DHCP-DNSé…ç½®)
8. [DNSåŸŸåæœç´¢åˆ—è¡¨DHCPèŽ·å–](#8-DNSåŸŸåæœç´¢åˆ—è¡¨DHCPèŽ·å–)
9. [DHCP DNSæ•…éšœæŽ’æŸ¥æ–¹æ³•](#9-DHCP-DNSæ•…éšœæŽ’æŸ¥æ–¹æ³•)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸŒ DHCPä¸ŽDNSåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯DHCP DNSé…ç½®


**ðŸ”¸ ç®€å•ç†è§£**ï¼š
å°±åƒä½é…’åº—æ—¶å‰å°ä¼šå‘Šè¯‰ä½ WiFiå¯†ç ä¸€æ ·ï¼ŒDHCPæœåŠ¡å™¨ä¸ä»…åˆ†é…IPåœ°å€ï¼Œè¿˜ä¼šå‘Šè¯‰ä½ çš„ç”µè„‘"åº”è¯¥åŽ»å“ªé‡ŒæŸ¥è¯¢åŸŸå"ï¼Œè¿™å°±æ˜¯DNSæœåŠ¡å™¨åœ°å€ã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
ä½ åˆ°ä¸€ä¸ªæ–°åŸŽå¸‚ â†’ éœ€è¦çŸ¥é“å½“åœ°çš„é—®è·¯æ–¹å¼
ç”µè„‘è¿žæŽ¥ç½‘ç»œ â†’ éœ€è¦çŸ¥é“DNSæœåŠ¡å™¨åœ°å€

ä¼ ç»Ÿæ–¹å¼ï¼šæ‰‹åŠ¨è®¾ç½®ï¼ˆå°±åƒäº‹å…ˆæŸ¥å¥½åœ°å›¾ï¼‰
DHCPæ–¹å¼ï¼šè‡ªåŠ¨èŽ·å–ï¼ˆå°±åƒé—®å½“åœ°äººæŽ¨èï¼‰
```

**ðŸ“ æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **DHCP**ï¼šåŠ¨æ€ä¸»æœºé…ç½®åè®®ï¼Œè‡ªåŠ¨åˆ†é…ç½‘ç»œå‚æ•°
- **DNSæœåŠ¡å™¨**ï¼šå°†åŸŸåè½¬æ¢ä¸ºIPåœ°å€çš„æœåŠ¡
- **DNSé…ç½®**ï¼šå‘Šè¯‰ç³»ç»ŸåŽ»å“ªé‡ŒæŸ¥è¯¢åŸŸåè§£æž

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦DHCP DNSé…ç½®


**ðŸ’¡ å®žé™…é—®é¢˜**ï¼š
```
åœºæ™¯1ï¼šå…¬å¸ç½‘ç»œ
- å†…ç½‘æœ‰ä¸“é—¨çš„DNSæœåŠ¡å™¨
- éœ€è¦è§£æžå†…éƒ¨åŸŸålike mail.company.com
- æ‰‹åŠ¨é…ç½®å¤ªéº»çƒ¦ï¼ŒDHCPè‡ªåŠ¨åˆ†é…æœ€æ–¹ä¾¿

åœºæ™¯2ï¼šå®¶åº­ç½‘ç»œ  
- è·¯ç”±å™¨æä¾›DNSä»£ç†æœåŠ¡
- æˆ–è€…ä½¿ç”¨è¿è¥å•†DNSæœåŠ¡å™¨
- è®¾å¤‡è‡ªåŠ¨èŽ·å–ï¼Œå³æ’å³ç”¨

åœºæ™¯3ï¼šç§»åŠ¨åŠžå…¬
- ä¸åŒç½‘ç»œçŽ¯å¢ƒDNSæœåŠ¡å™¨ä¸åŒ
- DHCPè®©è®¾å¤‡è‡ªåŠ¨é€‚åº”çŽ¯å¢ƒ
```

**ðŸŽ¯ æ ¸å¿ƒä»·å€¼**ï¼š
- **è‡ªåŠ¨åŒ–**ï¼šæ— éœ€æ‰‹åŠ¨é…ç½®DNS
- **é€‚åº”æ€§**ï¼šä¸åŒç½‘ç»œçŽ¯å¢ƒè‡ªåŠ¨é€‚é…  
- **ä¾¿æ·æ€§**ï¼šå³æ’å³ç”¨çš„ç½‘ç»œä½“éªŒ

### 1.3 DHCP DNSå·¥ä½œæµç¨‹


```
è®¾å¤‡å¯åŠ¨æµç¨‹ï¼š
1. è®¾å¤‡å‘é€DHCPè¯·æ±‚ â†’ "æˆ‘éœ€è¦ç½‘ç»œé…ç½®"
2. DHCPæœåŠ¡å™¨å“åº”   â†’ "ç»™ä½ IPã€ç½‘å…³ã€DNS"
3. è®¾å¤‡åº”ç”¨é…ç½®     â†’ "æ›´æ–°/etc/resolv.conf"
4. DNSè§£æžç”Ÿæ•ˆ     â†’ "å¯ä»¥è®¿é—®www.baidu.comäº†"

è¯¦ç»†äº¤äº’è¿‡ç¨‹ï¼š
å®¢æˆ·ç«¯                    DHCPæœåŠ¡å™¨
   |                           |
   |----DHCP Discover--------->|
   |<---DHCP Offer-------------|
   |----DHCP Request---------->|
   |<---DHCP ACK---------------|
   |                           |
   â†“                           
åº”ç”¨DNSé…ç½®åˆ°ç³»ç»Ÿ
```

---

## 2. âš™ï¸ DHCPå®¢æˆ·ç«¯DNSè‡ªåŠ¨èŽ·å–æœºåˆ¶


### 2.1 DHCPé€‰é¡¹ä¸­çš„DNSä¿¡æ¯


**ðŸ“‹ DHCPé€‰é¡¹è¯´æ˜Ž**ï¼š

| é€‰é¡¹ç¼–å· | **é€‰é¡¹åç§°** | **å«ä¹‰** | **ç¤ºä¾‹** |
|---------|-------------|----------|----------|
| **é€‰é¡¹6** | `Domain Name Servers` | `ä¸»DNSæœåŠ¡å™¨åˆ—è¡¨` | `8.8.8.8, 8.8.4.4` |
| **é€‰é¡¹15** | `Domain Name` | `é»˜è®¤åŸŸå` | `example.com` |
| **é€‰é¡¹119** | `Domain Search List` | `åŸŸåæœç´¢åˆ—è¡¨` | `local, corp.com` |

**ðŸ” å®žé™…å«ä¹‰è§£é‡Š**ï¼š
- **é€‰é¡¹6**ï¼šå°±æ˜¯å‘Šè¯‰ä½ "æŸ¥åŸŸååŽ»æ‰¾è¿™äº›DNSæœåŠ¡å™¨"
- **é€‰é¡¹15**ï¼šå½“ä½ åªè¾“å…¥ä¸»æœºåæ—¶ï¼Œè‡ªåŠ¨è¡¥å…¨çš„åŸŸååŽç¼€
- **é€‰é¡¹119**ï¼šæœç´¢åŸŸåçš„ä¼˜å…ˆçº§åˆ—è¡¨ï¼Œæ¯”å¦‚è¾“å…¥`mail`ä¼šå…ˆå°è¯•`mail.local`å†å°è¯•`mail.corp.com`

### 2.2 DHCPå®¢æˆ·ç«¯æŽ¥æ”¶å¤„ç†è¿‡ç¨‹


**ðŸ”„ å¤„ç†æ­¥éª¤**ï¼š
```
Step 1: è§£æžDHCPå“åº”åŒ…
â€¢ æå–DNSæœåŠ¡å™¨åœ°å€ï¼ˆé€‰é¡¹6ï¼‰
â€¢ æå–åŸŸååŽç¼€ï¼ˆé€‰é¡¹15ï¼‰  
â€¢ æå–æœç´¢åŸŸåˆ—è¡¨ï¼ˆé€‰é¡¹119ï¼‰

Step 2: ç”ŸæˆDNSé…ç½®
â€¢ æ ¼å¼åŒ–ä¸ºresolv.confæ ¼å¼
â€¢ å¤„ç†å¤šä¸ªDNSæœåŠ¡å™¨çš„ä¼˜å…ˆçº§
â€¢ åˆå¹¶æœç´¢åŸŸåˆ—è¡¨

Step 3: åº”ç”¨åˆ°ç³»ç»Ÿ
â€¢ æ›´æ–°/etc/resolv.confæ–‡ä»¶
â€¢ æˆ–é€šè¿‡systemd-resolvedæœåŠ¡
â€¢ æˆ–é€šè¿‡NetworkManagerç®¡ç†
```

### 2.3 è‡ªåŠ¨èŽ·å–çš„ä¼˜åŠ¿ä¸Žé™åˆ¶


**âœ… ä¼˜åŠ¿**ï¼š
- **é›¶é…ç½®**ï¼šè®¾å¤‡è¿žç½‘å³å¯æ­£å¸¸è§£æžåŸŸå
- **åŠ¨æ€é€‚åº”**ï¼šåˆ‡æ¢ç½‘ç»œè‡ªåŠ¨æ›´æ–°DNSè®¾ç½®
- **é›†ä¸­ç®¡ç†**ï¼šç½‘ç»œç®¡ç†å‘˜ç»Ÿä¸€é…ç½®DHCPæœåŠ¡å™¨

**âš ï¸ é™åˆ¶**ï¼š
- **ä¾èµ–ç½‘ç»œ**ï¼šDHCPæœåŠ¡å™¨æ•…éšœå½±å“DNSèŽ·å–
- **å®‰å…¨é£Žé™©**ï¼šæ¶æ„DHCPå¯èƒ½æä¾›é”™è¯¯DNS
- **å®šåˆ¶å›°éš¾**ï¼šéš¾ä»¥é’ˆå¯¹ç‰¹å®šåº”ç”¨å®šåˆ¶DNS

---

## 3. ðŸ”§ dhclienté…ç½®æ–‡ä»¶DNSé€‰é¡¹


### 3.1 dhclient.confåŸºç¡€é…ç½®


**ðŸ“ é…ç½®æ–‡ä»¶ä½ç½®**ï¼š`/etc/dhcp/dhclient.conf`

**ðŸ”¸ åŸºæœ¬DNSç›¸å…³é…ç½®**ï¼š
```bash
# è¯·æ±‚ç‰¹å®šDHCPé€‰é¡¹
request subnet-mask, broadcast-address, time-offset, routers,
        domain-name, domain-name-servers, domain-search;

# é¢„è®¾DNSæœåŠ¡å™¨ï¼ˆDHCPå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
supersede domain-name-servers 8.8.8.8, 8.8.4.4;

# è¿½åŠ DNSæœåŠ¡å™¨ï¼ˆåœ¨DHCPèŽ·å–çš„åŸºç¡€ä¸Šå¢žåŠ ï¼‰
prepend domain-name-servers 127.0.0.1;
```

**ðŸ’¡ é…ç½®å«ä¹‰è§£é‡Š**ï¼š
- **request**ï¼šå‘Šè¯‰DHCPæœåŠ¡å™¨"æˆ‘éœ€è¦è¿™äº›ä¿¡æ¯"
- **supersede**ï¼š"ä¸ç®¡DHCPç»™ä»€ä¹ˆï¼Œæˆ‘å°±ç”¨è¿™ä¸ªDNS"
- **prepend**ï¼šåœ¨DHCPç»™çš„DNSå‰é¢åŠ ä¸ŠæŒ‡å®šçš„DNS

### 3.2 é«˜çº§DNSé…ç½®é€‰é¡¹


**ðŸŽ¯ å®žç”¨é…ç½®ç¤ºä¾‹**ï¼š
```bash
# åªåœ¨ç‰¹å®šæŽ¥å£ä½¿ç”¨ç‰¹å®šDNS
interface "eth0" {
    supersede domain-name-servers 192.168.1.1;
    supersede domain-search "company.local";
}

# ä¸åŒç½‘ç»œä½¿ç”¨ä¸åŒDNSç­–ç•¥
interface "wlan0" {
    prepend domain-name-servers 1.1.1.1;
    append domain-name-servers 8.8.8.8;
}
```

### 3.3 dhclientè„šæœ¬é’©å­


**ðŸ”— è‡ªå®šä¹‰DNSå¤„ç†**ï¼š
dhclienté€šè¿‡è„šæœ¬é’©å­å¤„ç†DNSé…ç½®ï¼š

- **è¿›å…¥è„šæœ¬**ï¼š`/etc/dhcp/dhclient-enter-hooks.d/`
- **é€€å‡ºè„šæœ¬**ï¼š`/etc/dhcp/dhclient-exit-hooks.d/`

```bash
# ç¤ºä¾‹ï¼š/etc/dhcp/dhclient-exit-hooks.d/custom-dns
case $reason in
    BOUND|RENEW|REBIND|REBOOT)
        # DHCPèŽ·å–æˆåŠŸåŽçš„è‡ªå®šä¹‰å¤„ç†
        if [ -n "$new_domain_name_servers" ]; then
            echo "èŽ·å–åˆ°DNS: $new_domain_name_servers"
            # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªå®šä¹‰é€»è¾‘
        fi
        ;;
esac
```

---

## 4. âš–ï¸ é™æ€DNSä¸ŽDHCP DNSä¼˜å…ˆçº§å¤„ç†


### 4.1 ä¼˜å…ˆçº§å†²çªé—®é¢˜


**ðŸ¤” å®žé™…é—®é¢˜**ï¼š
å½“ç³»ç»Ÿæ—¢é…ç½®äº†é™æ€DNSï¼ˆå¦‚æ‰‹åŠ¨è®¾ç½®8.8.8.8ï¼‰ï¼Œåˆé€šè¿‡DHCPèŽ·å–DNSï¼ˆå¦‚192.168.1.1ï¼‰æ—¶ï¼Œåˆ°åº•å¬è°çš„ï¼Ÿ

```
å†²çªåœºæ™¯ç¤ºä¾‹ï¼š
/etc/resolv.conf é™æ€é…ç½®:
nameserver 8.8.8.8
nameserver 8.8.4.4

DHCPæœåŠ¡å™¨æä¾›:
nameserver 192.168.1.1
nameserver 192.168.1.2

æœ€ç»ˆresult: ???
```

### 4.2 ä¸åŒç³»ç»Ÿçš„å¤„ç†ç­–ç•¥


**ðŸ”„ å¤„ç†æœºåˆ¶å¯¹æ¯”**ï¼š

| ç³»ç»Ÿç»„ä»¶ | **é™æ€ä¼˜å…ˆ** | **DHCPä¼˜å…ˆ** | **åˆå¹¶ç­–ç•¥** |
|----------|-------------|-------------|-------------|
| **ä¼ ç»Ÿdhclient** | âŒ | âœ… | `è¦†ç›–é™æ€é…ç½®` |
| **NetworkManager** | âš–ï¸ | âš–ï¸ | `å¯é…ç½®ä¼˜å…ˆçº§` |
| **systemd-resolved** | âš–ï¸ | âš–ï¸ | `åˆ†æŽ¥å£ç®¡ç†` |

### 4.3 æŽ§åˆ¶ä¼˜å…ˆçº§çš„æ–¹æ³•


**ðŸŽ¯ æ–¹æ³•1ï¼šdhclienté…ç½®æŽ§åˆ¶**
```bash
# /etc/dhcp/dhclient.conf
# é˜»æ­¢DHCPè¦†ç›–é™æ€DNS
supersede domain-name-servers 8.8.8.8, 8.8.4.4;

# åœ¨DHCP DNSåŸºç¡€ä¸Šè¿½åŠ 
append domain-name-servers 8.8.8.8;
```

**ðŸŽ¯ æ–¹æ³•2ï¼šNetworkManagerç­–ç•¥**
```bash
# é€šè¿‡nmcliè®¾ç½®æŽ¥å£DNSç­–ç•¥
nmcli connection modify eth0 ipv4.ignore-auto-dns yes
nmcli connection modify eth0 ipv4.dns "8.8.8.8,8.8.4.4"
```

**ðŸŽ¯ æ–¹æ³•3ï¼šä¿æŠ¤resolv.conf**
```bash
# é˜²æ­¢è¢«è‡ªåŠ¨ä¿®æ”¹
chattr +i /etc/resolv.conf

# æˆ–ä½¿ç”¨ç¬¦å·é“¾æŽ¥æŒ‡å‘è‡ªå®šä¹‰æ–‡ä»¶
rm /etc/resolv.conf
ln -s /etc/resolv.conf.custom /etc/resolv.conf
```

---

## 5. ðŸ”€ DHCP DNSè¦†ç›–ä¸Žè¿½åŠ é…ç½®


### 5.1 è¦†ç›–é…ç½®ï¼ˆsupersedeï¼‰


**ðŸ’ª å®Œå…¨æ›¿æ¢ç­–ç•¥**ï¼š
å½“ä½ ç¡®å®šè¦ç”¨ç‰¹å®šDNSï¼Œä¸ç®¡DHCPç»™ä»€ä¹ˆéƒ½ä¸è¦æ—¶ä½¿ç”¨ã€‚

```bash
# /etc/dhcp/dhclient.conf
supersede domain-name-servers 1.1.1.1, 1.1.1.2;
supersede domain-search "mycompany.com";
```

**ðŸŽ¯ é€‚ç”¨åœºæ™¯**ï¼š
- **ä¼ä¸šå†…ç½‘**ï¼šå¿…é¡»ä½¿ç”¨å…¬å¸DNSæœåŠ¡å™¨
- **å®‰å…¨è¦æ±‚**ï¼šä¸ä¿¡ä»»å¤–éƒ¨DHCPæä¾›çš„DNS
- **ç‰¹æ®Šéœ€æ±‚**ï¼šéœ€è¦ä½¿ç”¨ç‰¹å®šçš„DNSè¿‡æ»¤æœåŠ¡

### 5.2 è¿½åŠ é…ç½®ï¼ˆprepend/appendï¼‰


**ðŸ”— ç»„åˆä½¿ç”¨ç­–ç•¥**ï¼š
ä¿ç•™DHCPæä¾›çš„DNSï¼ŒåŒæ—¶å¢žåŠ è‡ªå·±çš„DNSã€‚

```bash
# åœ¨å‰é¢æ·»åŠ ï¼ˆä¼˜å…ˆä½¿ç”¨ï¼‰
prepend domain-name-servers 127.0.0.1;

# åœ¨åŽé¢æ·»åŠ ï¼ˆå¤‡ç”¨ä½¿ç”¨ï¼‰  
append domain-name-servers 8.8.8.8, 8.8.4.4;
```

**ðŸ“Š æœ€ç»ˆDNSåˆ—è¡¨é¡ºåº**ï¼š
```
å‡è®¾DHCPæä¾›: 192.168.1.1, 192.168.1.2
é…ç½®äº†prepend: 127.0.0.1
é…ç½®äº†append: 8.8.8.8

æœ€ç»ˆé¡ºåº:
1. 127.0.0.1     â† prepend
2. 192.168.1.1   â† DHCPåŽŸå§‹
3. 192.168.1.2   â† DHCPåŽŸå§‹  
4. 8.8.8.8       â† append
```

### 5.3 æ¡ä»¶åŒ–é…ç½®


**ðŸŽ¨ çµæ´»ç­–ç•¥é…ç½®**ï¼š
```bash
# åŸºäºŽç½‘ç»œçŽ¯å¢ƒçš„æ¡ä»¶é…ç½®
script "/etc/dhcp/dhclient-script" {
    if ($new_network_number = 192.168.1.0) {
        # å®¶åº­ç½‘ç»œä½¿ç”¨è·¯ç”±å™¨DNS
        supersede domain-name-servers $new_routers;
    } else if ($new_network_number = 10.0.0.0) {
        # å…¬å¸ç½‘ç»œä½¿ç”¨å…¬å¸DNS
        supersede domain-name-servers 10.0.1.10, 10.0.1.11;
    }
}
```

---

## 6. ðŸ› ï¸ NetworkManager DHCP DNSå¤„ç†


### 6.1 NetworkManager DNSç®¡ç†æœºåˆ¶


**ðŸ”¸ å·¥ä½œåŽŸç†**ï¼š
NetworkManagerä½œä¸ºçŽ°ä»£Linuxçš„ç½‘ç»œç®¡ç†å™¨ï¼Œæä¾›äº†æ›´æ™ºèƒ½çš„DNSå¤„ç†æ–¹å¼ã€‚

```
NetworkManager DNSå¤„ç†æµç¨‹ï¼š
1. ç›‘å¬DHCPå“åº” â†’ èŽ·å–DNSä¿¡æ¯
2. åº”ç”¨è¿žæŽ¥é…ç½® â†’ æ£€æŸ¥ç”¨æˆ·è®¾ç½®
3. ç”ŸæˆDNSé…ç½® â†’ åˆå¹¶å¤šä¸ªæ¥æº
4. æ›´æ–°ç³»ç»ŸDNS â†’ é€šè¿‡å¤šç§åŽç«¯å®žçŽ°
```

**ðŸ” DNSåŽç«¯æ”¯æŒ**ï¼š
- **default**ï¼šç›´æŽ¥ä¿®æ”¹`/etc/resolv.conf`
- **systemd-resolved**ï¼šé€šè¿‡systemd-resolvedæœåŠ¡
- **dnsmasq**ï¼šä½¿ç”¨æœ¬åœ°dnsmasqç¼“å­˜
- **unbound**ï¼šä½¿ç”¨unboundé€’å½’DNSæœåŠ¡å™¨

### 6.2 è¿žæŽ¥çº§åˆ«çš„DNSé…ç½®


**ðŸŽ¯ é€šè¿‡nmcliç®¡ç†DNS**ï¼š
```bash
# æŸ¥çœ‹å½“å‰è¿žæŽ¥çš„DNSè®¾ç½®
nmcli connection show "Wired connection 1" | grep dns

# è®¾ç½®é™æ€DNSï¼ˆå¿½ç•¥DHCPï¼‰
nmcli connection modify "Wired connection 1" \
    ipv4.ignore-auto-dns yes \
    ipv4.dns "8.8.8.8,1.1.1.1"

# å…è®¸DHCP DNSä½†è¿½åŠ é¢å¤–DNS
nmcli connection modify "Wired connection 1" \
    ipv4.ignore-auto-dns no \
    ipv4.dns-options "edns0"
```

### 6.3 å…¨å±€DNSç­–ç•¥é…ç½®


**âš™ï¸ NetworkManager.confé…ç½®**ï¼š
```bash
# /etc/NetworkManager/NetworkManager.conf
[main]
dns=systemd-resolved

[connection]
# å…¨å±€DNSç­–ç•¥
ipv4.ignore-auto-dns=false
ipv4.dns-priority=50
```

**ðŸ”§ åˆ†æŽ¥å£DNSä¼˜å…ˆçº§**ï¼š
```bash
# æœ‰çº¿è¿žæŽ¥ä¼˜å…ˆçº§æ›´é«˜
nmcli connection modify eth0 ipv4.dns-priority 10
nmcli connection modify wlan0 ipv4.dns-priority 20

# ä¼˜å…ˆçº§è¶Šä½Žï¼ŒDNSä¼˜å…ˆçº§è¶Šé«˜
```

---

## 7. ðŸ§ systemd-networkd DHCP DNSé…ç½®


### 7.1 systemd-networkdç½‘ç»œé…ç½®


**ðŸ“ é…ç½®æ–‡ä»¶ç»“æž„**ï¼š
```
/etc/systemd/network/
â”œâ”€â”€ 10-eth0.network          â† æœ‰çº¿ç½‘ç»œé…ç½®
â”œâ”€â”€ 20-wlan0.network         â† æ— çº¿ç½‘ç»œé…ç½®
â””â”€â”€ 99-default.network       â† é»˜è®¤é…ç½®
```

**ðŸ”¸ åŸºç¡€DHCP DNSé…ç½®**ï¼š
```ini
# /etc/systemd/network/10-eth0.network
[Match]
Name=eth0

[Network]
DHCP=ipv4
# ä½¿ç”¨DHCPèŽ·å–çš„DNS
UseDNS=true
# ä½¿ç”¨DHCPèŽ·å–çš„åŸŸå
UseDomains=true

[DHCP]
# DNSç›¸å…³çš„DHCPé€‰é¡¹
UseDNS=true
UseDomains=route
UseNTP=true
```

### 7.2 DNSé…ç½®é€‰é¡¹è¯¦è§£


**ðŸŽ¯ DNSå¤„ç†ç­–ç•¥**ï¼š

| é…ç½®é€‰é¡¹ | **ä½œç”¨** | **å¯é€‰å€¼** |
|----------|----------|------------|
| `UseDNS=` | `æ˜¯å¦ä½¿ç”¨DHCP DNS` | `true/false` |
| `UseDomains=` | `åŸŸåå¤„ç†æ–¹å¼` | `false/route/yes` |
| `DNS=` | `é™æ€DNSæœåŠ¡å™¨` | `IPåœ°å€åˆ—è¡¨` |
| `Domains=` | `æœç´¢åŸŸåˆ—è¡¨` | `åŸŸååˆ—è¡¨` |

**ðŸ’¡ UseDomainsé€‰é¡¹è¯´æ˜Ž**ï¼š
- **false**ï¼šä¸ä½¿ç”¨DHCPåŸŸå
- **route**ï¼šä»…ç”¨äºŽè·¯ç”±åŸŸåè§£æž 
- **yes**ï¼šç”¨ä½œæœç´¢åŸŸå

### 7.3 é™æ€ä¸ŽDHCP DNSæ··åˆé…ç½®


**ðŸ”€ æ··åˆé…ç½®ç¤ºä¾‹**ï¼š
```ini
# /etc/systemd/network/10-eth0.network
[Match]
Name=eth0

[Network]
DHCP=ipv4
# é™æ€DNSï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
DNS=127.0.0.1
DNS=8.8.8.8
# é™æ€æœç´¢åŸŸ
Domains=company.local

[DHCP]
# åŒæ—¶ä½¿ç”¨DHCPæä¾›çš„DNSï¼ˆè¾ƒä½Žä¼˜å…ˆçº§ï¼‰
UseDNS=true
UseDomains=route
```

### 7.4 systemd-resolvedé›†æˆ


**ðŸ”— ä¸Žsystemd-resolvedååŒå·¥ä½œ**ï¼š
```bash
# æŸ¥çœ‹DNSçŠ¶æ€
systemctl status systemd-resolved
resolvectl status

# æŸ¥çœ‹æ¯ä¸ªæŽ¥å£çš„DNSé…ç½®
resolvectl status eth0
resolvectl status wlan0

# ä¸´æ—¶è®¾ç½®æŽ¥å£DNS
resolvectl dns eth0 8.8.8.8 1.1.1.1
resolvectl domain eth0 company.local
```

---

## 8. ðŸ” DNSåŸŸåæœç´¢åˆ—è¡¨DHCPèŽ·å–


### 8.1 åŸŸåæœç´¢åˆ—è¡¨çš„ä½œç”¨


**ðŸ”¸ ä»€ä¹ˆæ˜¯æœç´¢åˆ—è¡¨**ï¼š
å½“ä½ è¾“å…¥ä¸å®Œæ•´çš„åŸŸåï¼ˆå¦‚`mail`è€Œä¸æ˜¯`mail.company.com`ï¼‰æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°è¯•æ·»åŠ æœç´¢åˆ—è¡¨ä¸­çš„åŸŸååŽç¼€ã€‚

```
æœç´¢åˆ—è¡¨ç¤ºä¾‹ï¼š
search company.com local.lan example.org

å½“è¾“å…¥: ping mail
ç³»ç»Ÿå°è¯•:
1. mail.company.com    â† ç¬¬ä¸€ä¸ªæœç´¢åŸŸ
2. mail.local.lan      â† ç¬¬äºŒä¸ªæœç´¢åŸŸ  
3. mail.example.org    â† ç¬¬ä¸‰ä¸ªæœç´¢åŸŸ
4. mail                â† æœ€åŽå°è¯•åŽŸå§‹åç§°
```

### 8.2 DHCPé€‰é¡¹119è¯¦è§£


**ðŸ“‹ DHCPé€‰é¡¹119é…ç½®**ï¼š
æœåŠ¡å™¨ç«¯é…ç½®ç¤ºä¾‹ï¼ˆISC DHCPï¼‰ï¼š
```bash
# /etc/dhcp/dhcpd.conf
option domain-search "company.com", "local.lan", "backup.org";

subnet 192.168.1.0 netmask 255.255.255.0 {
    option domain-search "dept1.company.com", "dept2.company.com";
}
```

**ðŸ” å®¢æˆ·ç«¯å¤„ç†æµç¨‹**ï¼š
```
DHCPå“åº”åŒ…å«:
é€‰é¡¹119 = ["company.com", "local.lan"]

å®¢æˆ·ç«¯ç”Ÿæˆ:
/etc/resolv.conf:
search company.com local.lan

æˆ–systemd-resolved:
æ¯ä¸ªæŽ¥å£è®¾ç½®ç‹¬ç«‹çš„æœç´¢åŸŸ
```

### 8.3 å¤šæŽ¥å£æœç´¢åŸŸå¤„ç†


**ðŸ”„ å¤æ‚åœºæ™¯å¤„ç†**ï¼š
```
åœºæ™¯ï¼šåŒæ—¶è¿žæŽ¥æœ‰çº¿å’Œæ— çº¿
eth0 DHCP: search company.com corp.local  
wlan0 DHCP: search home.local guest.net

ä¼ ç»Ÿå¤„ç†ï¼šåŽè¿žæŽ¥è¦†ç›–å…ˆè¿žæŽ¥
çŽ°ä»£å¤„ç†ï¼šåˆ†æŽ¥å£ç®¡ç†æœç´¢åŸŸ
```

**âš™ï¸ systemd-resolvedåˆ†æŽ¥å£ç®¡ç†**ï¼š
```bash
# æŸ¥çœ‹å„æŽ¥å£çš„æœç´¢åŸŸ
resolvectl status

# æ‰‹åŠ¨è®¾ç½®æŽ¥å£æœç´¢åŸŸ
resolvectl domain eth0 company.com corp.local
resolvectl domain wlan0 home.local

# å…¨å±€æœç´¢åŸŸï¼ˆå…œåº•ï¼‰
resolvectl domain fallback.dns
```

---

## 9. ðŸ”§ DHCP DNSæ•…éšœæŽ’æŸ¥æ–¹æ³•


### 9.1 å¸¸è§æ•…éšœçŽ°è±¡


**âŒ å…¸åž‹é—®é¢˜ç—‡çŠ¶**ï¼š

| çŽ°è±¡ | **å¯èƒ½åŽŸå› ** | **æ£€æŸ¥é‡ç‚¹** |
|------|-------------|-------------|
| `åŸŸåæ— æ³•è§£æž` | `DNSæœåŠ¡å™¨åœ°å€é”™è¯¯` | `æ£€æŸ¥/etc/resolv.conf` |
| `å†…ç½‘åŸŸåè§£æžå¤±è´¥` | `æœç´¢åŸŸé…ç½®é—®é¢˜` | `æ£€æŸ¥searchåŸŸè®¾ç½®` |
| `DNSé…ç½®ä¸ç”Ÿæ•ˆ` | `è¢«å…¶ä»–æœåŠ¡è¦†ç›–` | `æ£€æŸ¥NetworkManager/systemd` |
| `è§£æžé€Ÿåº¦æ…¢` | `DNSæœåŠ¡å™¨å“åº”æ…¢` | `æµ‹è¯•DNSæœåŠ¡å™¨æ€§èƒ½` |

### 9.2 åˆ†å±‚æŽ’æŸ¥æ–¹æ³•


**ðŸŽ¯ Step 1: åŸºç¡€æ£€æŸ¥**
```bash
# æ£€æŸ¥å½“å‰DNSé…ç½®
cat /etc/resolv.conf

# æ£€æŸ¥ç½‘ç»œæŽ¥å£çŠ¶æ€
ip addr show
ip route show

# æ£€æŸ¥DHCPç§Ÿçº¦ä¿¡æ¯
cat /var/lib/dhcp/dhclient.leases
```

**ðŸŽ¯ Step 2: DHCPè¿‡ç¨‹æŽ’æŸ¥**
```bash
# é‡æ–°èŽ·å–DHCPé…ç½®
sudo dhclient -r eth0  # é‡Šæ”¾
sudo dhclient -v eth0  # é‡æ–°èŽ·å–ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯

# æŸ¥çœ‹DHCPäº¤äº’è¿‡ç¨‹
sudo tcpdump -i eth0 port 67 or port 68

# æ£€æŸ¥dhclientæ—¥å¿—
journalctl -u dhclient
```

**ðŸŽ¯ Step 3: DNSè§£æžæµ‹è¯•**
```bash
# æµ‹è¯•DNSæœåŠ¡å™¨è¿žé€šæ€§
ping 8.8.8.8

# æµ‹è¯•åŸŸåè§£æž
nslookup www.baidu.com
dig @8.8.8.8 www.baidu.com

# æµ‹è¯•æœç´¢åŸŸåŠŸèƒ½
nslookup mail  # åº”è¯¥è‡ªåŠ¨è¡¥å…¨åŸŸå
```

### 9.3 é«˜çº§æ•…éšœæŽ’æŸ¥


**ðŸ” ç½‘ç»œç®¡ç†å™¨ç›¸å…³**ï¼š
```bash
# NetworkManagerçŠ¶æ€
systemctl status NetworkManager
nmcli general status
nmcli device status

# æŸ¥çœ‹è¿žæŽ¥è¯¦ç»†ä¿¡æ¯
nmcli connection show --active
nmcli device show eth0

# é‡ç½®ç½‘ç»œé…ç½®
nmcli connection down "Wired connection 1"
nmcli connection up "Wired connection 1"
```

**ðŸ” systemd-resolvedç›¸å…³**ï¼š
```bash
# systemd-resolvedçŠ¶æ€
systemctl status systemd-resolved
resolvectl status

# æŸ¥çœ‹DNSæŸ¥è¯¢ç»Ÿè®¡
resolvectl statistics

# æ¸…ç©ºDNSç¼“å­˜
resolvectl flush-caches

# æŸ¥çœ‹æ¯ä¸ªæŽ¥å£çš„DNSé…ç½®
resolvectl status eth0
```

### 9.4 æ•…éšœè§£å†³ç­–ç•¥


**ðŸ› ï¸ å¸¸ç”¨ä¿®å¤æ–¹æ³•**ï¼š

```bash
# æ–¹æ³•1ï¼šå¼ºåˆ¶æ›´æ–°DNSé…ç½®
sudo dhclient -r && sudo dhclient

# æ–¹æ³•2ï¼šé‡å¯ç½‘ç»œæœåŠ¡
sudo systemctl restart NetworkManager
# æˆ–
sudo systemctl restart systemd-networkd

# æ–¹æ³•3ï¼šæ‰‹åŠ¨è®¾ç½®DNSï¼ˆä¸´æ—¶ï¼‰
echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf

# æ–¹æ³•4ï¼šæ£€æŸ¥å¹¶ä¿®å¤é…ç½®æ–‡ä»¶
sudo nano /etc/dhcp/dhclient.conf
sudo nano /etc/NetworkManager/NetworkManager.conf
```

**âš ï¸ æ•…éšœé¢„é˜²æŽªæ–½**ï¼š
- å®šæœŸæ£€æŸ¥DNSé…ç½®çš„ä¸€è‡´æ€§
- é…ç½®å¤‡ç”¨DNSæœåŠ¡å™¨
- ç›‘æŽ§DHCPæœåŠ¡å™¨çš„å¥åº·çŠ¶æ€
- å»ºç«‹DNSé…ç½®å˜æ›´çš„è®°å½•æœºåˆ¶

---

## 10. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ðŸ”¸ DHCP DNSæœºåˆ¶ï¼šDHCPä¸ä»…åˆ†é…IPï¼Œè¿˜æä¾›DNSæœåŠ¡å™¨ä¿¡æ¯
ðŸ”¸ é…ç½®ä¼˜å…ˆçº§ï¼šé™æ€é…ç½®vs DHCPé…ç½®çš„ä¼˜å…ˆçº§å…³ç³»
ðŸ”¸ å¤šæŽ¥å£å¤„ç†ï¼šä¸åŒç½‘ç»œæŽ¥å£å¯èƒ½æœ‰ä¸åŒçš„DNSè®¾ç½®  
ðŸ”¸ æœç´¢åŸŸä½œç”¨ï¼šç®€åŒ–åŸŸåè¾“å…¥ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
ðŸ”¸ çŽ°ä»£åŒ–ç®¡ç†ï¼šNetworkManagerå’Œsystemd-resolvedçš„ä¼˜åŠ¿
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ DNSèŽ·å–çš„è‡ªåŠ¨åŒ–ä»·å€¼**
```
ä¼ ç»Ÿæ‰‹åŠ¨é…ç½®çš„é—®é¢˜ï¼š
â€¢ éœ€è¦çŸ¥é“æ¯ä¸ªç½‘ç»œçš„DNSæœåŠ¡å™¨
â€¢ åˆ‡æ¢ç½‘ç»œæ—¶éœ€è¦é‡æ–°é…ç½®
â€¢ å®¹æ˜“å‡ºçŽ°é…ç½®é”™è¯¯

DHCPè‡ªåŠ¨èŽ·å–çš„ä¼˜åŠ¿ï¼š
â€¢ å³æ’å³ç”¨çš„ç½‘ç»œä½“éªŒ
â€¢ è‡ªåŠ¨é€‚åº”ä¸åŒç½‘ç»œçŽ¯å¢ƒ
â€¢ å‡å°‘äººä¸ºé…ç½®é”™è¯¯
```

**ðŸ”¹ ä¼˜å…ˆçº§æŽ§åˆ¶çš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆéœ€è¦æŽ§åˆ¶ä¼˜å…ˆçº§ï¼š
â€¢ æŸäº›çŽ¯å¢ƒå¿…é¡»ä½¿ç”¨ç‰¹å®šDNSï¼ˆå¦‚ä¼ä¸šå†…ç½‘ï¼‰
â€¢ éœ€è¦ç»„åˆä½¿ç”¨å¤šä¸ªDNSæœåŠ¡å™¨
â€¢ å¸Œæœ›ä¿ç•™å¤‡ç”¨DNSä»¥æé«˜å¯é æ€§

æŽ§åˆ¶æ–¹æ³•çš„é€‰æ‹©ï¼š
â€¢ dhclient.confï¼šé€‚åˆä¼ ç»Ÿç³»ç»Ÿ
â€¢ NetworkManagerï¼šé€‚åˆæ¡Œé¢ç³»ç»Ÿ
â€¢ systemd-networkdï¼šé€‚åˆæœåŠ¡å™¨ç³»ç»Ÿ
```

**ðŸ”¹ æ•…éšœæŽ’æŸ¥çš„ç³»ç»Ÿæ€§æ–¹æ³•**
```
åˆ†å±‚æŽ’æŸ¥çš„é‡è¦æ€§ï¼š
â€¢ ç½‘ç»œè¿žé€šæ€§ â†’ DHCPèŽ·å– â†’ DNSé…ç½® â†’ åŸŸåè§£æž
â€¢ æ¯ä¸€å±‚éƒ½å¯èƒ½å‡ºçŽ°é—®é¢˜
â€¢ ç³»ç»Ÿæ€§æŽ’æŸ¥é¿å…é—æ¼

å¸¸ç”¨å·¥å…·çš„ä½œç”¨ï¼š
â€¢ tcpdumpï¼šæŠ“åŒ…åˆ†æžDHCPäº¤äº’
â€¢ dig/nslookupï¼šæµ‹è¯•DNSè§£æž
â€¢ resolvectlï¼šæŸ¥çœ‹çŽ°ä»£DNSé…ç½®
```

### 10.3 å®žé™…åº”ç”¨ä»·å€¼


**ðŸ’¼ ä¼ä¸šçŽ¯å¢ƒåº”ç”¨**ï¼š
- **å†…ç½‘DNS**ï¼šè‡ªåŠ¨èŽ·å–å…¬å¸å†…éƒ¨DNSæœåŠ¡å™¨ï¼Œè§£æžå†…éƒ¨åŸŸå
- **åˆ†æ”¯æœºæž„**ï¼šä¸åŒåˆ†æ”¯è‡ªåŠ¨èŽ·å–å½“åœ°DNSï¼Œæå‡è§£æžé€Ÿåº¦
- **ç§»åŠ¨åŠžå…¬**ï¼šç¬”è®°æœ¬ç”µè„‘åœ¨ä¸åŒç½‘ç»œé—´åˆ‡æ¢æ— éœ€é‡é…ç½®

**ðŸ  å®¶åº­ç½‘ç»œåº”ç”¨**ï¼š
- **æ™ºèƒ½è®¾å¤‡**ï¼šIoTè®¾å¤‡è‡ªåŠ¨èŽ·å–è·¯ç”±å™¨æä¾›çš„DNS
- **ç½‘ç»œä¼˜åŒ–**ï¼šé€šè¿‡DHCPç»Ÿä¸€åˆ†é…æ›´å¿«çš„å…¬å…±DNS
- **å®¶é•¿æŽ§åˆ¶**ï¼šé€šè¿‡DNSè¿‡æ»¤æœåŠ¡æŽ§åˆ¶è®¿é—®å†…å®¹

**â˜ï¸ äº‘çŽ¯å¢ƒåº”ç”¨**ï¼š
- **å®¹å™¨ç½‘ç»œ**ï¼šå®¹å™¨è‡ªåŠ¨èŽ·å–é›†ç¾¤å†…éƒ¨DNSé…ç½®
- **å¾®æœåŠ¡**ï¼šæœåŠ¡å‘çŽ°ä¾èµ–æ­£ç¡®çš„DNSé…ç½®
- **æ··åˆäº‘**ï¼šä¸åŒçŽ¯å¢ƒçš„DNSè‡ªåŠ¨é€‚é…

### 10.4 å­¦ä¹ æ£€æŸ¥æ¸…å•


**âœ… æŽŒæ¡ç¨‹åº¦è‡ªæµ‹**ï¼š
- [ ] èƒ½è§£é‡ŠDHCP DNSèŽ·å–çš„å·¥ä½œæµç¨‹
- [ ] ä¼šé…ç½®dhclient.confæŽ§åˆ¶DNSä¼˜å…ˆçº§
- [ ] äº†è§£NetworkManagerçš„DNSç®¡ç†æœºåˆ¶
- [ ] æŽŒæ¡systemd-resolvedçš„åŸºæœ¬ä½¿ç”¨
- [ ] èƒ½è¿›è¡ŒDNSæ•…éšœçš„åŸºç¡€æŽ’æŸ¥
- [ ] ç†è§£æœç´¢åŸŸçš„ä½œç”¨å’Œé…ç½®æ–¹æ³•

### 10.5 å»¶ä¼¸å­¦ä¹ å»ºè®®


**ðŸ”— ç›¸å…³çŸ¥è¯†ç‚¹**ï¼š
- DNSåè®®åŽŸç†å’Œè®°å½•ç±»åž‹
- DHCPåè®®è¯¦è§£å’ŒæœåŠ¡å™¨é…ç½®
- Linuxç½‘ç»œç®¡ç†å·¥å…·å¯¹æ¯”
- ä¼ä¸šç½‘ç»œDNSæž¶æž„è®¾è®¡
- å®‰å…¨DNSå’ŒDNS over HTTPS

**ðŸ›¤ï¸ è¿›é˜¶å­¦ä¹ è·¯å¾„**ï¼š
1. **åŸºç¡€å·©å›º**ï¼šæ·±å…¥ç†è§£DNSè§£æžè¿‡ç¨‹
2. **å®žè·µåº”ç”¨**ï¼šæ­å»ºæµ‹è¯•çŽ¯å¢ƒéªŒè¯é…ç½®
3. **é«˜çº§ç‰¹æ€§**ï¼šå­¦ä¹ DNSç¼“å­˜å’Œè´Ÿè½½å‡è¡¡
4. **å®‰å…¨åŠ å›º**ï¼šäº†è§£DNSå®‰å…¨å¨èƒå’Œé˜²æŠ¤
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šDNSæ€§èƒ½ç›‘æŽ§å’Œè°ƒä¼˜

**ðŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
DHCPä¸åªåˆ†IPåœ°å€ï¼ŒDNSæœåŠ¡å™¨ä¸€èµ·å‘
å®¢æˆ·ç«¯æ”¶åˆ°è‡ªåŠ¨é…ï¼Œresolv.confæ¥æ›´æ–°
é™æ€DHCPæœ‰å†²çªï¼Œä¼˜å…ˆçº§åˆ«è¦å¼„æ¸…
NetworkManagerå¾ˆæ™ºèƒ½ï¼ŒsystemdåŠŸèƒ½æ›´å¼ºå¤§
æ•…éšœæŽ’æŸ¥åˆ†å±‚æ¬¡ï¼Œå·¥å…·ä½¿ç”¨è¦ç†Ÿç»ƒ
```