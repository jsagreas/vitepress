---
title: 12ã€å¤šç½‘ç»œç¯å¢ƒDNSé…ç½®
---
## ğŸ“š ç›®å½•

1. [å¤šç½‘ç»œç¯å¢ƒDNSåŸºæœ¬æ¦‚å¿µ](#1-å¤šç½‘ç»œç¯å¢ƒDNSåŸºæœ¬æ¦‚å¿µ)
2. [VPNè¿æ¥DNSè·¯ç”±é…ç½®](#2-VPNè¿æ¥DNSè·¯ç”±é…ç½®)
3. [å¤šç½‘å¡ç¯å¢ƒDNSé…ç½®ç­–ç•¥](#3-å¤šç½‘å¡ç¯å¢ƒDNSé…ç½®ç­–ç•¥)
4. [åˆ†ç¦»è§£æä¸æ¡ä»¶è½¬å‘è®¾ç½®](#4-åˆ†ç¦»è§£æä¸æ¡ä»¶è½¬å‘è®¾ç½®)
5. [å†…ç½‘ä¸å¤–ç½‘DNSåˆ†æµé…ç½®](#5-å†…ç½‘ä¸å¤–ç½‘DNSåˆ†æµé…ç½®)
6. [å®¹å™¨ç¯å¢ƒDNSé…ç½®ç®¡ç†](#6-å®¹å™¨ç¯å¢ƒDNSé…ç½®ç®¡ç†)
7. [è™šæ‹ŸåŒ–ç¯å¢ƒDNSç½‘ç»œé…ç½®](#7-è™šæ‹ŸåŒ–ç¯å¢ƒDNSç½‘ç»œé…ç½®)
8. [è·¨ç½‘æ®µDNSè§£æé…ç½®](#8-è·¨ç½‘æ®µDNSè§£æé…ç½®)
9. [å¤æ‚ç½‘ç»œæ‹“æ‰‘DNSè§„åˆ’](#9-å¤æ‚ç½‘ç»œæ‹“æ‰‘DNSè§„åˆ’)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ å¤šç½‘ç»œç¯å¢ƒDNSåŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¤šç½‘ç»œç¯å¢ƒDNS


> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šå°±åƒä½ å®¶é‡Œæœ‰å¤šæ¡ç½‘çº¿ï¼ˆæœ‰çº¿ç½‘ã€WiFiã€æ‰‹æœºçƒ­ç‚¹ï¼‰ï¼Œæ¯æ¡çº¿è·¯å¯èƒ½éœ€è¦ç”¨ä¸åŒçš„"ç”µè¯ç°¿"ï¼ˆDNSæœåŠ¡å™¨ï¼‰æ¥æŸ¥æ‰¾ç½‘ç«™åœ°å€

**å¤šç½‘ç»œç¯å¢ƒçš„ç‰¹ç‚¹**ï¼š
```
å®é™…åœºæ™¯ä¸¾ä¾‹ï¼š
åŠå…¬å®¤ç”µè„‘ â”€â”€â”¬â”€â”€ æœ‰çº¿ç½‘ï¼ˆå†…ç½‘DNSï¼š192.168.1.1ï¼‰
              â”œâ”€â”€ WiFiç½‘ï¼ˆå¤–ç½‘DNSï¼š8.8.8.8ï¼‰  
              â””â”€â”€ VPNè¿æ¥ï¼ˆå…¬å¸DNSï¼š10.0.0.1ï¼‰

éœ€è¦è§£å†³çš„é—®é¢˜ï¼š
â€¢ æŸ¥æ‰¾å†…ç½‘æœåŠ¡å™¨ç”¨å†…ç½‘DNS
â€¢ è®¿é—®äº’è”ç½‘ç”¨å¤–ç½‘DNS  
â€¢ VPNçŠ¶æ€ä¸‹ç”¨VPNçš„DNS
```

### 1.2 å¤šç½‘ç»œDNSé¢ä¸´çš„æŒ‘æˆ˜


**ğŸ”¸ è·¯ç”±å†²çªé—®é¢˜**
```
é—®é¢˜åœºæ™¯ï¼š
ç”¨æˆ·è¿æ¥VPNåï¼Œæ‰€æœ‰DNSè¯·æ±‚éƒ½èµ°VPN
ç»“æœï¼šè®¿é—®æœ¬åœ°ç½‘ç«™å˜æ…¢ï¼Œç”šè‡³æ— æ³•è®¿é—®

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    VPNéš§é“    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ¬åœ°PC  â”‚ ============> â”‚ å…¬å¸DNS  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“                        â†“
è®¿é—®ç™¾åº¦.com                 æŸ¥è¯¢ç¼“æ…¢
```

**ğŸ”¸ DNSæ³„éœ²é—®é¢˜**
```
å®‰å…¨é£é™©ï¼š
â€¢ å†…ç½‘DNSæŸ¥è¯¢æš´éœ²ç»™å¤–ç½‘
â€¢ VPNç¯å¢ƒä¸‹DNSè¯·æ±‚èµ°é”™é€šé“
â€¢ æ•æ„ŸåŸŸåè¢«éæˆæƒDNSæœåŠ¡å™¨è®°å½•
```

**ğŸ”¸ è§£æä¼˜å…ˆçº§æ··ä¹±**
```
å…¸å‹é—®é¢˜ï¼š
å¤šä¸ªç½‘å¡ â†’ å¤šä¸ªDNSæœåŠ¡å™¨ â†’ ä¸çŸ¥é“ç”¨å“ªä¸ª
ç»“æœï¼šç½‘ç»œè®¿é—®ä¸ç¨³å®šï¼Œæ—¶å¥½æ—¶å
```

### 1.3 DNSé…ç½®çš„åŸºæœ¬ç­–ç•¥


**ç­–ç•¥â‘ ï¼šåŸºäºåŸŸååˆ†æµ**
- `*.company.com` â†’ ä½¿ç”¨å†…ç½‘DNS
- `*.baidu.com` â†’ ä½¿ç”¨å¤–ç½‘DNS
- å…¶ä»–åŸŸå â†’ ä½¿ç”¨é»˜è®¤DNS

**ç­–ç•¥â‘¡ï¼šåŸºäºç½‘ç»œæ¥å£åˆ†æµ**  
- `eth0`(æœ‰çº¿) â†’ å†…ç½‘DNS
- `wlan0`(WiFi) â†’ å¤–ç½‘DNS
- `tun0`(VPN) â†’ VPNä¸“ç”¨DNS

**ç­–ç•¥â‘¢ï¼šåŸºäºIPåœ°å€æ®µåˆ†æµ**
- `192.168.x.x` â†’ å†…ç½‘DNSè§£æ
- å…¬ç½‘IP â†’ å¤–ç½‘DNSè§£æ

---

## 2. ğŸ”’ VPNè¿æ¥DNSè·¯ç”±é…ç½®


### 2.1 VPN DNSè·¯ç”±çš„å·¥ä½œåŸç†


**ä¼ ç»ŸVPN DNSé—®é¢˜**ï¼š
```
é—®é¢˜ç¤ºæ„ï¼š
æœ¬åœ°ç”µè„‘ â”€â”€VPNè¿æ¥â”€â”€> å…¬å¸ç½‘ç»œ
    â†“                    â†“
æ‰€æœ‰DNSè¯·æ±‚            å…¬å¸DNSæœåŠ¡å™¨
åŒ…æ‹¬è®¿é—®ç™¾åº¦            (è§£æç™¾åº¦å¾ˆæ…¢)

ç»“æœï¼šä¸Šç½‘ä½“éªŒå˜å·®
```

**æ™ºèƒ½DNSè·¯ç”±è§£å†³æ–¹æ¡ˆ**ï¼š
```
ç†æƒ³çŠ¶æ€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æœ¬åœ°ç”µè„‘   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”œâ”€â”€ å…¬å¸åŸŸå â”€â”€VPNâ”€â”€> å…¬å¸DNS
       â””â”€â”€ å¤–ç½‘åŸŸå â”€â”€ç›´è¿â”€â”€> å…¬ç½‘DNS
```

### 2.2 OpenVPN DNSè·¯ç”±é…ç½®


**å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ç¤ºä¾‹**ï¼š
```bash
# /etc/openvpn/client.conf
client
dev tun
proto udp
remote vpn.company.com 1194

# DNSé…ç½®ï¼šä¸è¦æ¨é€æ‰€æœ‰æµé‡
pull-filter ignore "redirect-gateway"
pull-filter ignore "dhcp-option DNS"

# æ‰‹åŠ¨æŒ‡å®šè·¯ç”±
route 10.0.0.0 255.255.255.0
dhcp-option DNS 10.0.0.1
```

**ğŸ”§ systemd-resolvedé›†æˆ**ï¼š
```bash
# åˆ›å»ºVPNæ¥å£DNSé…ç½®
sudo systemd-resolve --interface tun0 --set-dns 10.0.0.1 \
  --set-domain company.com --set-domain ~company.local
```

### 2.3 WireGuard DNSé…ç½®


**WireGuardé…ç½®æ–‡ä»¶**ï¼š
```ini
[Interface]
PrivateKey = <ç§é’¥>
Address = 10.0.0.100/24

# ä»…VPNç½‘æ®µèµ°VPNè·¯ç”±
AllowedIPs = 10.0.0.0/24

[Peer]
PublicKey = <æœåŠ¡å™¨å…¬é’¥>
Endpoint = vpn.company.com:51820

# ä¸è®¾ç½® 0.0.0.0/0ï¼Œé¿å…å…¨éƒ¨æµé‡èµ°VPN
```

**é…åˆdnsmasqå®ç°åˆ†ç¦»è§£æ**ï¼š
```bash
# /etc/dnsmasq.d/vpn.conf
# å…¬å¸åŸŸåèµ°VPN DNS
server=/company.com/10.0.0.1
server=/company.local/10.0.0.1

# å…¶ä»–åŸŸåèµ°é»˜è®¤DNS
server=8.8.8.8
```

### 2.4 VPN DNSè‡ªåŠ¨åˆ‡æ¢è„šæœ¬


```bash
#!/bin/bash
# vpn-dns-switch.sh

VPN_DNS="10.0.0.1"
DEFAULT_DNS="8.8.8.8"
COMPANY_DOMAINS="company.com company.local"

vpn_up() {
    echo "VPNè¿æ¥å»ºç«‹ï¼Œé…ç½®DNSåˆ†ç¦»..."
    
    # å¤‡ä»½åŸå§‹DNSé…ç½®
    cp /etc/systemd/resolved.conf /etc/systemd/resolved.conf.backup
    
    # é…ç½®åŸŸååˆ†ç¦»
    for domain in $COMPANY_DOMAINS; do
        systemd-resolve --interface tun0 --set-dns $VPN_DNS --set-domain "~$domain"
    done
    
    systemctl restart systemd-resolved
    echo "DNSé…ç½®å®Œæˆ"
}

vpn_down() {
    echo "VPNæ–­å¼€ï¼Œæ¢å¤DNSé…ç½®..."
    mv /etc/systemd/resolved.conf.backup /etc/systemd/resolved.conf
    systemctl restart systemd-resolved
}

case "$1" in
    up) vpn_up ;;
    down) vpn_down ;;
    *) echo "ç”¨æ³•: $0 {up|down}" ;;
esac
```

---

## 3. ğŸ–§ å¤šç½‘å¡ç¯å¢ƒDNSé…ç½®ç­–ç•¥


### 3.1 å¤šç½‘å¡DNSä¼˜å…ˆçº§ç®¡ç†


**ç½‘å¡ä¼˜å…ˆçº§ç¤ºä¾‹**ï¼š
```
ç½‘ç»œç¯å¢ƒï¼š
eth0 (æœ‰çº¿ç½‘) â”€â”€â”€â”€ ä¼˜å…ˆçº§1 â”€â”€â”€â”€ å†…ç½‘DNS: 192.168.1.1
wlan0 (WiFi)  â”€â”€â”€â”€ ä¼˜å…ˆçº§2 â”€â”€â”€â”€ å¤–ç½‘DNS: 8.8.8.8  
tun0 (VPN)    â”€â”€â”€â”€ ä¼˜å…ˆçº§3 â”€â”€â”€â”€ VPN DNS: 10.0.0.1

é—®é¢˜ï¼šä¼˜å…ˆçº§é«˜çš„ç½‘å¡DNSä¼šè¦†ç›–å…¶ä»–é…ç½®
```

**ğŸ”§ NetworkManageré…ç½®æ–¹æ³•**ï¼š
```bash
# æŸ¥çœ‹è¿æ¥çŠ¶æ€
nmcli connection show

# è®¾ç½®æœ‰çº¿ç½‘DNSä¼˜å…ˆçº§
nmcli connection modify "Wired connection 1" \
  ipv4.dns "192.168.1.1" \
  ipv4.dns-priority 100

# è®¾ç½®WiFi DNSä¼˜å…ˆçº§  
nmcli connection modify "WiFi-Home" \
  ipv4.dns "8.8.8.8" \
  ipv4.dns-priority 200

# æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
```

### 3.2 systemd-resolvedå¤šæ¥å£é…ç½®


**systemd-resolvedé…ç½®**ï¼š
```ini
# /etc/systemd/resolved.conf
[Resolve]
# å…¨å±€å¤‡ç”¨DNS
DNS=8.8.8.8 1.1.1.1
FallbackDNS=114.114.114.114

# å¯ç”¨åˆ†æ¥å£DNS
Cache=yes
DNSStubListener=yes
```

**æŒ‰æ¥å£è®¾ç½®DNS**ï¼š
```bash
# ä¸ºä¸åŒæ¥å£è®¾ç½®ä¸“ç”¨DNS
sudo systemd-resolve --interface eth0 --set-dns 192.168.1.1 \
  --set-domain "~local"

sudo systemd-resolve --interface wlan0 --set-dns 8.8.8.8

# æŸ¥çœ‹å½“å‰DNSé…ç½®çŠ¶æ€
systemd-resolve --status
```

### 3.3 æ‰‹åŠ¨è·¯ç”±è¡¨DNSé…ç½®


**åˆ›å»ºè‡ªå®šä¹‰è·¯ç”±è¡¨**ï¼š
```bash
# /etc/iproute2/rt_tables
100 internal
200 external  
300 vpn

# æ·»åŠ è·¯ç”±è§„åˆ™
ip rule add from 192.168.1.0/24 table internal
ip rule add from 0.0.0.0/0 table external

# è®¾ç½®é»˜è®¤ç½‘å…³
ip route add default via 192.168.1.1 dev eth0 table internal
ip route add default via 192.168.0.1 dev wlan0 table external
```

**é…åˆiptableså®ç°DNSåˆ†æµ**ï¼š
```bash
# å†…ç½‘DNSè¯·æ±‚èµ°å†…ç½‘æ¥å£
iptables -t mangle -A OUTPUT -d 192.168.1.1 -j MARK --set-mark 100
ip rule add fwmark 100 table internal

# å¤–ç½‘DNSè¯·æ±‚èµ°å¤–ç½‘æ¥å£  
iptables -t mangle -A OUTPUT -d 8.8.8.8 -j MARK --set-mark 200
ip rule add fwmark 200 table external
```

---

## 4. ğŸ”€ åˆ†ç¦»è§£æä¸æ¡ä»¶è½¬å‘è®¾ç½®


### 4.1 ä»€ä¹ˆæ˜¯DNSåˆ†ç¦»è§£æ


> **é€šä¿—è§£é‡Š**ï¼šå°±åƒä¸åŒçš„é—®é¢˜æ‰¾ä¸åŒçš„ä¸“å®¶ã€‚é—®å†…ç½‘æœåŠ¡å™¨åœ°å€æ‰¾å†…ç½‘DNSä¸“å®¶ï¼Œé—®å¤–ç½‘ç½‘ç«™åœ°å€æ‰¾å¤–ç½‘DNSä¸“å®¶ã€‚

**åˆ†ç¦»è§£æçš„åœºæ™¯**ï¼š
```
åœºæ™¯ç¤ºä¾‹ï¼š
æŸ¥è¯¢ mail.company.com    â”€â”€> å†…ç½‘DNS (192.168.1.1)  
æŸ¥è¯¢ www.baidu.com       â”€â”€> å¤–ç½‘DNS (8.8.8.8)
æŸ¥è¯¢ api.github.com      â”€â”€> å¤–ç½‘DNS (8.8.8.8)

ç›®çš„ï¼š
â€¢ å†…ç½‘åŸŸåè§£æå¿«é€Ÿå‡†ç¡®
â€¢ å¤–ç½‘åŸŸåè§£æä¸å—å½±å“  
â€¢ é¿å…DNSæœåŠ¡å™¨ä¹‹é—´çš„å†²çª
```

### 4.2 ä½¿ç”¨dnsmasqå®ç°åˆ†ç¦»è§£æ


**å®‰è£…å’ŒåŸºæœ¬é…ç½®**ï¼š
```bash
# å®‰è£…dnsmasq
sudo apt install dnsmasq

# åŸºæœ¬é…ç½®æ–‡ä»¶
sudo vim /etc/dnsmasq.conf
```

**æ ¸å¿ƒé…ç½®ç¤ºä¾‹**ï¼š
```bash
# /etc/dnsmasq.conf

# ç›‘å¬æ¥å£
interface=lo
bind-interfaces

# ä¸Šæ¸¸DNSæœåŠ¡å™¨
# å…¬å¸åŸŸåèµ°å…¬å¸DNS
server=/company.com/192.168.1.1
server=/company.local/192.168.1.1
server=/internal.corp/10.0.0.1

# å¤–ç½‘åŸŸåèµ°å…¬ç½‘DNS
server=8.8.8.8
server=1.1.1.1

# æœ¬åœ°hostsæ–‡ä»¶ä¼˜å…ˆ
no-hosts
addn-hosts=/etc/hosts.company

# ç¼“å­˜è®¾ç½®
cache-size=1000
```

**å¯åŠ¨å’Œæµ‹è¯•**ï¼š
```bash
# å¯åŠ¨dnsmasq
sudo systemctl enable dnsmasq
sudo systemctl start dnsmasq

# ä¿®æ”¹ç³»ç»ŸDNSæŒ‡å‘æœ¬åœ°
echo "nameserver 127.0.0.1" | sudo tee /etc/resolv.conf

# æµ‹è¯•åˆ†ç¦»è§£æ
dig mail.company.com     # åº”è¯¥èµ°å†…ç½‘DNS
dig www.google.com       # åº”è¯¥èµ°å¤–ç½‘DNS
```

### 4.3 BIND9æ¡ä»¶è½¬å‘é…ç½®


**BIND9é…ç½®æ–‡ä»¶ç»“æ„**ï¼š
```bash
# /etc/bind/named.conf.local

# å†…ç½‘åŸŸåè½¬å‘åˆ°å†…ç½‘DNS
zone "company.com" {
    type forward;
    forwarders { 192.168.1.1; };
    forward only;
};

zone "company.local" {
    type forward; 
    forwarders { 192.168.1.1; };
    forward only;
};

# åå‘è§£æä¹Ÿè¦è½¬å‘
zone "1.168.192.in-addr.arpa" {
    type forward;
    forwarders { 192.168.1.1; };
    forward only;  
};
```

**å…¨å±€è½¬å‘å™¨é…ç½®**ï¼š
```bash
# /etc/bind/named.conf.options
options {
    directory "/var/cache/bind";
    
    # é»˜è®¤è½¬å‘å™¨ï¼ˆå¤–ç½‘DNSï¼‰
    forwarders {
        8.8.8.8;
        1.1.1.1;
    };
    
    forward first;  # å…ˆå°è¯•è½¬å‘ï¼Œå¤±è´¥åè‡ªå·±è§£æ
    
    dnssec-validation auto;
    listen-on-v6 { any; };
};
```

### 4.4 æ¡ä»¶è½¬å‘æµ‹è¯•éªŒè¯


**åˆ›å»ºæµ‹è¯•è„šæœ¬**ï¼š
```bash
#!/bin/bash
# test-dns-split.sh

echo "=== DNSåˆ†ç¦»è§£ææµ‹è¯• ==="

# æµ‹è¯•å†…ç½‘åŸŸå
echo "æµ‹è¯•å†…ç½‘åŸŸåè§£æï¼š"
for domain in mail.company.com web.company.local; do
    result=$(dig +short $domain @127.0.0.1)
    echo "$domain -> $result"
done

# æµ‹è¯•å¤–ç½‘åŸŸå  
echo "æµ‹è¯•å¤–ç½‘åŸŸåè§£æï¼š"
for domain in www.baidu.com www.google.com; do
    result=$(dig +short $domain @127.0.0.1)
    echo "$domain -> $result"
done

# æ£€æŸ¥è§£ææ—¶é—´
echo "è§£æé€Ÿåº¦æµ‹è¯•ï¼š"
time dig company.com @127.0.0.1 > /dev/null
time dig google.com @127.0.0.1 > /dev/null
```

---

## 5. ğŸš¦ å†…ç½‘ä¸å¤–ç½‘DNSåˆ†æµé…ç½®


### 5.1 åŸºäºåŸŸåçš„è‡ªåŠ¨åˆ†æµ


**æ™ºèƒ½åˆ†æµç­–ç•¥**ï¼š
```
åˆ†æµè§„åˆ™è®¾è®¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åŸŸåç±»å‹        â”‚  ä½¿ç”¨DNS     â”‚     åŸå›         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ *.company.com       â”‚ å†…ç½‘DNS      â”‚ åªæœ‰å†…ç½‘çŸ¥é“    â”‚
â”‚ *.local             â”‚ å†…ç½‘DNS      â”‚ æœ¬åœ°ç½‘ç»œåŸŸå    â”‚  
â”‚ *.internal          â”‚ å†…ç½‘DNS      â”‚ å†…éƒ¨æœåŠ¡åŸŸå    â”‚
â”‚ 10.*.*.*, 192.168.* â”‚ å†…ç½‘DNS      â”‚ ç§æœ‰IPæ®µ       â”‚
â”‚ å…¶ä»–æ‰€æœ‰åŸŸå         â”‚ å¤–ç½‘DNS      â”‚ å…¬ç½‘å¯è¾¾        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°æ™ºèƒ½åˆ†æµçš„é…ç½®**ï¼š
```bash
# /etc/dnsmasq.d/smart-split.conf

# å†…ç½‘åŸŸåè§„åˆ™ - è¿™äº›åŸŸåèµ°å†…ç½‘DNS
server=/company.com/192.168.1.1
server=/company.local/192.168.1.1  
server=/corp/192.168.1.1
server=/internal/192.168.1.1

# IPåå‘è§£æ - å†…ç½‘IPæ®µèµ°å†…ç½‘DNS
server=/168.192.in-addr.arpa/192.168.1.1
server=/16.172.in-addr.arpa/192.168.1.1
server=/10.in-addr.arpa/192.168.1.1

# å¤–ç½‘é»˜è®¤DNS
server=8.8.8.8
server=1.1.1.1

# ä¸è¦å‘ä¸Šæ¸¸æŸ¥è¯¢ç®€å•ä¸»æœºå
domain-needed
bogus-priv
```

### 5.2 åŸºäºIPåœ°å€çš„åˆ†æµé…ç½®


**åˆ›å»ºIPåˆ†ç±»è§„åˆ™**ï¼š
```bash
#!/bin/bash
# create-ip-rules.sh

# å†…ç½‘IPæ®µåˆ—è¡¨
INTERNAL_NETWORKS=(
    "192.168.0.0/16"
    "172.16.0.0/12"  
    "10.0.0.0/8"
    "127.0.0.0/8"
)

# ä¸ºæ¯ä¸ªå†…ç½‘æ®µåˆ›å»ºè·¯ç”±è§„åˆ™
for network in "${INTERNAL_NETWORKS[@]}"; do
    echo "ä¸º $network åˆ›å»ºå†…ç½‘DNSè·¯ç”±..."
    
    # ä½¿ç”¨iptablesæ ‡è®°å†…ç½‘æµé‡
    iptables -t mangle -A OUTPUT -d $network -p udp --dport 53 \
      -j MARK --set-mark 100
done

# å†…ç½‘DNSæµé‡èµ°å†…ç½‘è·¯ç”±è¡¨
ip rule add fwmark 100 table internal
ip route add default via 192.168.1.1 dev eth0 table internal
```

### 5.3 åŠ¨æ€DNSåˆ†æµè„šæœ¬


```bash
#!/bin/bash
# dynamic-dns-split.sh

INTERNAL_DNS="192.168.1.1"
EXTERNAL_DNS="8.8.8.8"
CONFIG_DIR="/etc/dnsmasq.d"

# æ£€æµ‹ç½‘ç»œå˜åŒ–
detect_network_change() {
    local current_networks=$(ip route show | grep -E "192.168|172.16|10\.")
    
    if [[ "$current_networks" != "$last_networks" ]]; then
        echo "æ£€æµ‹åˆ°ç½‘ç»œç¯å¢ƒå˜åŒ–ï¼Œé‡æ–°é…ç½®DNSåˆ†æµ..."
        configure_dns_split
        last_networks="$current_networks"
    fi
}

# é…ç½®DNSåˆ†æµ
configure_dns_split() {
    cat > $CONFIG_DIR/auto-split.conf << EOF
# è‡ªåŠ¨ç”Ÿæˆçš„DNSåˆ†æµé…ç½®
# ç”Ÿæˆæ—¶é—´: $(date)

# å½“å‰å†…ç½‘DNS
server=/company.com/$INTERNAL_DNS
server=/local/$INTERNAL_DNS

# å¤–ç½‘DNS  
server=$EXTERNAL_DNS

# å†…ç½‘IPåå‘è§£æ
EOF
    
    # æ£€æµ‹å½“å‰ç½‘ç»œå¹¶æ·»åŠ å¯¹åº”è§„åˆ™
    for route in $(ip route show | grep -o "192.168.[0-9]*.0/24"); do
        echo "server=/${route}/192.168.1.1" >> $CONFIG_DIR/auto-split.conf
    done
    
    # é‡å¯dnsmasq
    systemctl reload dnsmasq
}

# ä¸»å¾ªç¯ - æ¯30ç§’æ£€æµ‹ä¸€æ¬¡
while true; do
    detect_network_change
    sleep 30
done
```

### 5.4 åˆ†æµæ•ˆæœéªŒè¯å·¥å…·


```bash
#!/bin/bash
# verify-dns-split.sh

echo "ğŸ” DNSåˆ†æµé…ç½®éªŒè¯å·¥å…·"
echo "======================"

# æµ‹è¯•å†…ç½‘åŸŸåè§£æ
test_internal() {
    echo "ğŸ“‹ å†…ç½‘åŸŸåè§£ææµ‹è¯•ï¼š"
    
    domains=("mail.company.com" "web.company.local" "server.internal")
    
    for domain in "${domains[@]}"; do
        if result=$(dig +short $domain @127.0.0.1 2>/dev/null); then
            if [[ -n "$result" ]]; then
                echo "  âœ… $domain -> $result"
            else
                echo "  âŒ $domain -> æ— è§£æç»“æœ"  
            fi
        else
            echo "  âŒ $domain -> è§£æå¤±è´¥"
        fi
    done
}

# æµ‹è¯•å¤–ç½‘åŸŸåè§£æ
test_external() {
    echo "ğŸŒ å¤–ç½‘åŸŸåè§£ææµ‹è¯•ï¼š"
    
    domains=("www.baidu.com" "www.google.com" "github.com")
    
    for domain in "${domains[@]}"; do
        if result=$(dig +short $domain @127.0.0.1 2>/dev/null); then
            if [[ -n "$result" ]]; then
                echo "  âœ… $domain -> $result"
            else
                echo "  âŒ $domain -> æ— è§£æç»“æœ"
            fi
        else  
            echo "  âŒ $domain -> è§£æå¤±è´¥"
        fi
    done
}

# æ£€æŸ¥DNSåˆ†æµæ˜¯å¦ç”Ÿæ•ˆ
check_split_working() {
    echo "ğŸ”„ DNSåˆ†æµçŠ¶æ€æ£€æŸ¥ï¼š"
    
    # æ£€æŸ¥dnsmasqæ˜¯å¦è¿è¡Œ
    if systemctl is-active --quiet dnsmasq; then
        echo "  âœ… dnsmasqæœåŠ¡æ­£åœ¨è¿è¡Œ"
    else
        echo "  âŒ dnsmasqæœåŠ¡æœªè¿è¡Œ"
        return 1
    fi
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶
    if [[ -f /etc/dnsmasq.d/smart-split.conf ]]; then
        echo "  âœ… åˆ†æµé…ç½®æ–‡ä»¶å­˜åœ¨"
        
        internal_rules=$(grep "server=.*192.168" /etc/dnsmasq.d/smart-split.conf | wc -l)
        echo "  ğŸ“Š å†…ç½‘DNSè§„åˆ™: $internal_rules æ¡"
    else
        echo "  âŒ åˆ†æµé…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
    fi
}

# æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
check_split_working
echo ""
test_internal  
echo ""
test_external
```

---

## 6. ğŸ³ å®¹å™¨ç¯å¢ƒDNSé…ç½®ç®¡ç†


### 6.1 Dockerå®¹å™¨DNSé…ç½®


> **åœºæ™¯è¯´æ˜**ï¼šå®¹å™¨éœ€è¦è®¿é—®å®¿ä¸»æœºå†…ç½‘æœåŠ¡ï¼ŒåŒæ—¶ä¹Ÿè¦è®¿é—®å¤–ç½‘ã€‚éœ€è¦åˆç†é…ç½®å®¹å™¨çš„DNSï¼Œè®©å®ƒèƒ½æ­£ç¡®è§£æå†…å¤–ç½‘åŸŸåã€‚

**Dockeré»˜è®¤DNSè¡Œä¸º**ï¼š
```
Dockeré»˜è®¤DNSé…ç½®ï¼š
å®¹å™¨ -> Dockerå†…ç½®DNS(127.0.0.11) -> å®¿ä¸»æœºDNS -> å¤–éƒ¨DNS

é—®é¢˜ï¼šå®¹å™¨å¯èƒ½æ— æ³•è§£æå†…ç½‘åŸŸå
```

**è‡ªå®šä¹‰å®¹å™¨DNSé…ç½®**ï¼š
```bash
# æ–¹æ³•1ï¼šå¯åŠ¨æ—¶æŒ‡å®šDNS
docker run -d --name webapp \
  --dns 192.168.1.1 \
  --dns 8.8.8.8 \
  --dns-search company.com \
  nginx

# æ–¹æ³•2ï¼šé€šè¿‡docker-composeé…ç½®  
```

**docker-compose.yml DNSé…ç½®**ï¼š
```yaml
version: '3.8'

services:
  webapp:
    image: nginx
    dns:
      - 192.168.1.1    # å†…ç½‘DNS
      - 8.8.8.8        # å¤–ç½‘DNSå¤‡ç”¨
    dns_search:
      - company.com
      - company.local
    extra_hosts:
      - "api.company.com:192.168.1.100"
      - "db.company.com:192.168.1.200"

  database:
    image: mysql:8.0
    dns:
      - 192.168.1.1
    dns_search:
      - company.com
```

### 6.2 Dockerç½‘ç»œè‡ªå®šä¹‰DNS


**åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ**ï¼š
```bash
# åˆ›å»ºå¸¦DNSé…ç½®çš„è‡ªå®šä¹‰ç½‘ç»œ
docker network create \
  --driver bridge \
  --subnet=172.20.0.0/16 \
  --ip-range=172.20.240.0/20 \
  --opt com.docker.network.bridge.name=br-company \
  company-network

# ä¸ºç½‘ç»œé…ç½®DNS
docker run -d --name dnsmasq \
  --network company-network \
  --ip 172.20.0.2 \
  -v /etc/dnsmasq.d:/etc/dnsmasq.d:ro \
  andyshinn/dnsmasq
```

**å®¹å™¨ä½¿ç”¨è‡ªå®šä¹‰DNS**ï¼š
```bash
# å¯åŠ¨å®¹å™¨å¹¶è¿æ¥åˆ°è‡ªå®šä¹‰ç½‘ç»œ
docker run -d --name webapp \
  --network company-network \
  --dns 172.20.0.2 \
  nginx

# æµ‹è¯•å®¹å™¨å†…DNSè§£æ
docker exec webapp nslookup api.company.com
```

### 6.3 Kubernetesé›†ç¾¤DNSé…ç½®


**Pod DNSç­–ç•¥é…ç½®**ï¼š
```yaml
# pod-dns-config.yaml
apiVersion: v1
kind: Pod
metadata:
  name: webapp
spec:
  # DNSç­–ç•¥ï¼šä½¿ç”¨é›†ç¾¤DNSä½†è‡ªå®šä¹‰é…ç½®
  dnsPolicy: "None"
  dnsConfig:
    nameservers:
      - 10.96.0.10      # é›†ç¾¤DNSæœåŠ¡
      - 192.168.1.1     # å†…ç½‘DNS
    searches:
      - default.svc.cluster.local
      - svc.cluster.local  
      - cluster.local
      - company.com
    options:
      - name: ndots
        value: "2"
      - name: edns0
  containers:
  - name: webapp
    image: nginx
```

**ConfigMapæ–¹å¼ç®¡ç†DNS**ï¼š
```yaml
# dns-config-map.yaml  
apiVersion: v1
kind: ConfigMap
metadata:
  name: dns-config
data:
  resolv.conf: |
    nameserver 10.96.0.10
    nameserver 192.168.1.1
    search default.svc.cluster.local svc.cluster.local cluster.local company.com
    options ndots:2
---
apiVersion: v1
kind: Pod
metadata:
  name: webapp
spec:
  containers:
  - name: webapp
    image: nginx
    volumeMounts:
    - name: dns-config
      mountPath: /etc/resolv.conf
      subPath: resolv.conf
  volumes:
  - name: dns-config
    configMap:
      name: dns-config
```

### 6.4 å®¹å™¨DNSæ•…éšœæ’æŸ¥


**DNSè§£ææµ‹è¯•è„šæœ¬**ï¼š
```bash
#!/bin/bash
# container-dns-test.sh

CONTAINER_NAME="$1"

if [[ -z "$CONTAINER_NAME" ]]; then
    echo "ç”¨æ³•: $0 <å®¹å™¨åç§°>"
    exit 1
fi

echo "ğŸ” å®¹å™¨ $CONTAINER_NAME DNSé…ç½®æ£€æŸ¥"
echo "================================"

# æ£€æŸ¥å®¹å™¨DNSé…ç½®
echo "ğŸ“‹ DNSé…ç½®ä¿¡æ¯ï¼š"
docker exec $CONTAINER_NAME cat /etc/resolv.conf

echo ""
echo "ğŸŒ DNSè§£ææµ‹è¯•ï¼š"

# æµ‹è¯•å†…ç½‘åŸŸå
echo "å†…ç½‘åŸŸåè§£æï¼š"  
docker exec $CONTAINER_NAME nslookup api.company.com 2>/dev/null || echo "  âŒ å†…ç½‘åŸŸåè§£æå¤±è´¥"

# æµ‹è¯•å¤–ç½‘åŸŸå
echo "å¤–ç½‘åŸŸåè§£æï¼š"
docker exec $CONTAINER_NAME nslookup www.baidu.com 2>/dev/null || echo "  âŒ å¤–ç½‘åŸŸåè§£æå¤±è´¥"

# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
echo ""
echo "ğŸ”— ç½‘ç»œè¿é€šæ€§æµ‹è¯•ï¼š"
docker exec $CONTAINER_NAME ping -c 2 8.8.8.8 > /dev/null && echo "  âœ… å¤–ç½‘è¿é€š" || echo "  âŒ å¤–ç½‘ä¸é€š"
```

---

## 7. ğŸ’» è™šæ‹ŸåŒ–ç¯å¢ƒDNSç½‘ç»œé…ç½®


### 7.1 VMwareè™šæ‹ŸæœºDNSé…ç½®


**ç½‘ç»œæ¨¡å¼ä¸DNSçš„å…³ç³»**ï¼š
```
VMwareç½‘ç»œæ¨¡å¼å¯¹DNSçš„å½±å“ï¼š

NATæ¨¡å¼ï¼š
è™šæ‹Ÿæœº -> VMware NAT -> å®¿ä¸»æœºDNS -> å¤–éƒ¨DNS
â€¢ ç®€å•ä½†å¯èƒ½æœ‰DNSå»¶è¿Ÿ
â€¢ è™šæ‹Ÿæœºä½¿ç”¨å®¿ä¸»æœºDNSè®¾ç½®

æ¡¥æ¥æ¨¡å¼ï¼š  
è™šæ‹Ÿæœº -> ç‰©ç†ç½‘ç»œ -> è·¯ç”±å™¨DNS -> å¤–éƒ¨DNS  
â€¢ è™šæ‹Ÿæœºè·å¾—ç‹¬ç«‹IPå’ŒDNSé…ç½®
â€¢ ä¸ç‰©ç†æœºåŒç­‰ç½‘ç»œåœ°ä½

ä¸»æœºæ¨¡å¼ï¼š
è™šæ‹Ÿæœº -> è™šæ‹Ÿç½‘ç»œ -> å®¿ä¸»æœº  
â€¢ åªèƒ½ä¸å®¿ä¸»æœºé€šä¿¡
â€¢ DNSéœ€è¦ç‰¹æ®Šé…ç½®
```

**VMwareè™šæ‹Ÿç½‘ç»œé…ç½®**ï¼š
```bash
# ç¼–è¾‘VMwareè™šæ‹Ÿç½‘ç»œé…ç½®
sudo vmware-netcfg

# NATæ¨¡å¼DNSè®¾ç½®ï¼ˆåœ¨VMwareç•Œé¢ä¸­ï¼‰
# è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨ -> é€‰æ‹©VMnet8(NAT) -> NATè®¾ç½® -> DNSè®¾ç½®
```

**è™šæ‹Ÿæœºå†…Linuxç³»ç»ŸDNSé…ç½®**ï¼š
```bash
# Ubuntu/Debianç³»ç»Ÿ
sudo vim /etc/netplan/01-netcfg.yaml

network:
  version: 2
  ethernets:
    ens33:
      dhcp4: true
      nameservers:
        addresses: [192.168.1.1, 8.8.8.8]
        search: [company.com, local]

# åº”ç”¨é…ç½®        
sudo netplan apply
```

### 7.2 VirtualBoxè™šæ‹ŸæœºDNSé…ç½®


**ç½‘ç»œé€‚é…å™¨DNSè®¾ç½®**ï¼š
```bash
# VirtualBoxå‘½ä»¤è¡Œé…ç½®DNS
VBoxManage modifyvm "è™šæ‹Ÿæœºåç§°" --natdnshostresolver1 on
VBoxManage modifyvm "è™šæ‹Ÿæœºåç§°" --natdnsproxy1 on

# å¯ç”¨DNSä»£ç†ï¼Œè®©è™šæ‹Ÿæœºä½¿ç”¨å®¿ä¸»æœºDNS
```

**è™šæ‹Ÿæœºå†…ç½‘ç»œé…ç½®**ï¼š
```bash
# /etc/systemd/resolved.conf
[Resolve]
DNS=192.168.1.1 8.8.8.8
Domains=company.com company.local
LLMNR=yes
```

### 7.3 KVM/libvirtè™šæ‹ŸæœºDNSé…ç½®


**libvirtç½‘ç»œXMLé…ç½®**ï¼š
```xml
<!-- /etc/libvirt/qemu/networks/company.xml -->
<network>
  <name>company</name>
  <forward mode='nat'>
    <nat>
      <port start='1024' end='65535'/>
    </nat>
  </forward>
  <bridge name='virbr1' stp='on' delay='0'/>
  <ip address='192.168.100.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.100.100' end='192.168.100.200'/>
    </dhcp>
  </ip>
  <dns>
    <!-- è‡ªå®šä¹‰DNSæœåŠ¡å™¨ -->
    <forwarder addr='192.168.1.1'/>
    <forwarder addr='8.8.8.8'/>
    
    <!-- æœ¬åœ°åŸŸåè§£æ -->
    <host ip='192.168.100.10'>
      <hostname>api.company.local</hostname>
    </host>
  </dns>
</network>
```

**å¯ç”¨è‡ªå®šä¹‰ç½‘ç»œ**ï¼š
```bash
# å®šä¹‰å¹¶å¯åŠ¨ç½‘ç»œ
sudo virsh net-define /etc/libvirt/qemu/networks/company.xml
sudo virsh net-start company
sudo virsh net-autostart company

# æŸ¥çœ‹ç½‘ç»œçŠ¶æ€
sudo virsh net-list --all
```

**è™šæ‹Ÿæœºè¿æ¥åˆ°è‡ªå®šä¹‰ç½‘ç»œ**ï¼š
```xml
<!-- è™šæ‹Ÿæœºé…ç½®ä¸­æ·»åŠ ç½‘ç»œæ¥å£ -->
<interface type='network'>
  <mac address='52:54:00:12:34:56'/>
  <source network='company'/>
  <model type='virtio'/>
  <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>
</interface>
```

### 7.4 è™šæ‹ŸåŒ–ç¯å¢ƒDNSä¼˜åŒ–


**DNSç¼“å­˜ä¼˜åŒ–é…ç½®**ï¼š
```bash
# åœ¨è™šæ‹Ÿæœºä¸­é…ç½®æœ¬åœ°DNSç¼“å­˜
sudo apt install dnsmasq

# /etc/dnsmasq.conf
cache-size=1000
neg-ttl=60

# ä¸Šæ¸¸DNSé…ç½®
server=192.168.1.1    # å†…ç½‘DNS
server=8.8.8.8        # å¤–ç½‘DNSå¤‡ç”¨

# ç¦ç”¨systemd-resolvedçš„DNSç¼“å­˜ï¼Œé¿å…å†²çª
sudo systemctl disable systemd-resolved
sudo rm /etc/resolv.conf
echo "nameserver 127.0.0.1" | sudo tee /etc/resolv.conf
```

---

## 8. ğŸŒ è·¨ç½‘æ®µDNSè§£æé…ç½®


### 8.1 è·¨ç½‘æ®µDNSè§£æåŸç†


**è·¨ç½‘æ®µDNSé—®é¢˜åœºæ™¯**ï¼š
```
ç½‘ç»œæ‹“æ‰‘ï¼š
åŠå…¬ç½‘æ®µï¼š192.168.1.0/24 ï¼ˆDNS: 192.168.1.1ï¼‰
å¼€å‘ç½‘æ®µï¼š192.168.2.0/24 ï¼ˆDNS: 192.168.2.1ï¼‰  
æµ‹è¯•ç½‘æ®µï¼š192.168.3.0/24 ï¼ˆDNS: 192.168.3.1ï¼‰

é—®é¢˜ï¼š
å¼€å‘ç½‘æ®µçš„æœºå™¨æ— æ³•è§£æåŠå…¬ç½‘æ®µçš„å†…éƒ¨åŸŸå
æµ‹è¯•ç¯å¢ƒæ— æ³•è®¿é—®å¼€å‘ç¯å¢ƒçš„æœåŠ¡
```

**è§£å†³æ–¹æ¡ˆå¯¹æ¯”**ï¼š
```
æ–¹æ¡ˆå¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è§£å†³æ–¹æ¡ˆ    â”‚   å¤æ‚åº¦    â”‚   æ€§èƒ½      â”‚   é€‚ç”¨åœºæ™¯    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DNSè½¬å‘      â”‚    ç®€å•     â”‚    å¥½       â”‚ å°å‹ç½‘ç»œ     â”‚
â”‚ DNSä¸»ä»å¤åˆ¶  â”‚    ä¸­ç­‰     â”‚    å¾ˆå¥½     â”‚ ä¸­å‹ç½‘ç»œ     â”‚ 
â”‚ ç»Ÿä¸€DNSæœåŠ¡å™¨â”‚    ç®€å•     â”‚    ä¸€èˆ¬     â”‚ é›†ä¸­ç®¡ç†     â”‚
â”‚ æ¡ä»¶è½¬å‘     â”‚    å¤æ‚     â”‚    å¾ˆå¥½     â”‚ å¤§å‹ç½‘ç»œ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 DNSè½¬å‘é…ç½®å®ç°


**é…ç½®DNSè½¬å‘æœåŠ¡å™¨**ï¼š
```bash
# åœ¨ç½‘æ®µ1çš„DNSæœåŠ¡å™¨ä¸Šé…ç½®
# /etc/bind/named.conf.local

# è½¬å‘ç½‘æ®µ2çš„DNSè¯·æ±‚
zone "dev.company.com" {
    type forward;
    forwarders { 192.168.2.1; };
    forward only;
};

# è½¬å‘ç½‘æ®µ3çš„DNSè¯·æ±‚  
zone "test.company.com" {
    type forward;
    forwarders { 192.168.3.1; };
    forward only;
};

# åå‘è§£æä¹Ÿè¦è½¬å‘
zone "2.168.192.in-addr.arpa" {
    type forward;
    forwarders { 192.168.2.1; };
    forward only;
};
```

**ä½¿ç”¨dnsmasqå®ç°ç®€å•è½¬å‘**ï¼š
```bash
# /etc/dnsmasq.d/cross-network.conf

# å¼€å‘ç½‘æ®µåŸŸåè½¬å‘
server=/dev.company.com/192.168.2.1
server=/192.168.2.0/24/192.168.2.1

# æµ‹è¯•ç½‘æ®µåŸŸåè½¬å‘
server=/test.company.com/192.168.3.1  
server=/192.168.3.0/24/192.168.3.1

# æœ¬ç½‘æ®µé»˜è®¤è§£æ
server=/office.company.com/192.168.1.1
```

### 8.3 è·¯ç”±ä¸é˜²ç«å¢™é…ç½®


**é…ç½®è·¨ç½‘æ®µè·¯ç”±**ï¼š
```bash
# åœ¨æ ¸å¿ƒè·¯ç”±å™¨ä¸Šæ·»åŠ è·¯ç”±
ip route add 192.168.2.0/24 via 192.168.1.254
ip route add 192.168.3.0/24 via 192.168.1.254

# æˆ–è€…åœ¨æ¯å°æœºå™¨ä¸Šæ·»åŠ 
route add -net 192.168.2.0/24 gw 192.168.1.1
route add -net 192.168.3.0/24 gw 192.168.1.1
```

**é˜²ç«å¢™DNSè½¬å‘è§„åˆ™**ï¼š
```bash
# å…è®¸DNSæŸ¥è¯¢é€šè¿‡é˜²ç«å¢™
iptables -A FORWARD -p udp --dport 53 -j ACCEPT
iptables -A FORWARD -p tcp --dport 53 -j ACCEPT

# å…è®¸ç‰¹å®šç½‘æ®µçš„DNSæŸ¥è¯¢
iptables -A INPUT -s 192.168.2.0/24 -p udp --dport 53 -j ACCEPT
iptables -A INPUT -s 192.168.3.0/24 -p udp --dport 53 -j ACCEPT

# NATè§„åˆ™ï¼ˆå¦‚æœéœ€è¦ï¼‰
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -d 192.168.2.0/24 -j MASQUERADE
```

### 8.4 æµ‹è¯•è·¨ç½‘æ®µDNSè§£æ


**åˆ›å»ºè·¨ç½‘æ®µæµ‹è¯•è„šæœ¬**ï¼š
```bash
#!/bin/bash
# cross-network-dns-test.sh

# å®šä¹‰æµ‹è¯•ç›®æ ‡
declare -A TEST_DOMAINS=(
    ["åŠå…¬ç½‘æ®µ"]="mail.office.company.com"
    ["å¼€å‘ç½‘æ®µ"]="api.dev.company.com"  
    ["æµ‹è¯•ç½‘æ®µ"]="web.test.company.com"
)

echo "ğŸŒ è·¨ç½‘æ®µDNSè§£ææµ‹è¯•"
echo "=================="

# å½“å‰ç½‘æ®µæ£€æµ‹
current_ip=$(hostname -I | awk '{print $1}')
echo "å½“å‰æœºå™¨IP: $current_ip"

# æµ‹è¯•å„ç½‘æ®µåŸŸåè§£æ
for network in "${!TEST_DOMAINS[@]}"; do
    domain=${TEST_DOMAINS[$network]}
    echo ""
    echo "æµ‹è¯• $network ($domain):"
    
    # DNSè§£ææµ‹è¯•
    if result=$(dig +short $domain 2>/dev/null); then
        if [[ -n "$result" ]]; then
            echo "  âœ… è§£ææˆåŠŸ: $domain -> $result"
            
            # è¿é€šæ€§æµ‹è¯•
            if ping -c 1 -W 2 $result >/dev/null 2>&1; then
                echo "  âœ… ç½‘ç»œè¿é€š: å¯ä»¥pingé€š $result"
            else
                echo "  âŒ ç½‘ç»œä¸é€š: æ— æ³•pingé€š $result"  
            fi
        else
            echo "  âŒ è§£æå¤±è´¥: $domain æ— è§£æç»“æœ"
        fi
    else
        echo "  âŒ è§£æé”™è¯¯: $domain è§£æå‡ºç°é”™è¯¯"
    fi
done

# æ£€æŸ¥è·¯ç”±è¡¨
echo ""
echo "ğŸ“Š å½“å‰è·¯ç”±è¡¨ï¼š"
ip route show | grep -E "192.168.[1-3]"
```

---

## 9. ğŸ—ï¸ å¤æ‚ç½‘ç»œæ‹“æ‰‘DNSè§„åˆ’


### 9.1 å¤æ‚ç½‘ç»œæ‹“æ‰‘åˆ†æ


**å…¸å‹å¤æ‚ç½‘ç»œåœºæ™¯**ï¼š
```
ä¼ä¸šç½‘ç»œæ‹“æ‰‘ç¤ºä¾‹ï¼š

äº’è”ç½‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¾¹ç•Œè·¯ç”±å™¨ â”€â”€â”€â”€â”€â”€ DMZåŒºåŸŸ
                            â”‚              â”‚
                            â”‚              â”œâ”€ WebæœåŠ¡å™¨
                            â”‚              â”œâ”€ é‚®ä»¶æœåŠ¡å™¨  
                            â”‚              â””â”€ DNSæœåŠ¡å™¨
                            â”‚
                        æ ¸å¿ƒäº¤æ¢æœº
                            â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                  â”‚                  â”‚
      åŠå…¬ç½‘ç»œ           å¼€å‘ç½‘ç»œ           ç”Ÿäº§ç½‘ç»œ
   192.168.1.0/24     192.168.10.0/24    10.0.0.0/24
         â”‚                  â”‚                  â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
   WiFi   æœ‰çº¿        æµ‹è¯•ç¯å¢ƒ   å¼€å‘ç¯å¢ƒ    æ•°æ®åº“   åº”ç”¨
```

**DNSæœåŠ¡å™¨å±‚æ¬¡è§„åˆ’**ï¼š
```
DNSæœåŠ¡å™¨æ¶æ„ï¼š
æ ¹DNS â”€â”€â”€ æƒå¨DNS â”€â”¬â”€ åŠå…¬åŒºDNSï¼ˆ192.168.1.1ï¼‰
                  â”œâ”€ å¼€å‘åŒºDNSï¼ˆ192.168.10.1ï¼‰ 
                  â”œâ”€ ç”Ÿäº§åŒºDNSï¼ˆ10.0.0.1ï¼‰
                  â””â”€ DMZåŒºDNSï¼ˆå…¬ç½‘IPï¼‰

æ¯ä¸ªåŒºåŸŸçš„DNSèŒè´£ï¼š
â€¢ åŠå…¬åŒºï¼šè§£æåŠå…¬åŸŸåï¼Œè½¬å‘å…¶ä»–è¯·æ±‚
â€¢ å¼€å‘åŒºï¼šè§£æå¼€å‘åŸŸåï¼Œç¼“å­˜å¤–ç½‘è¯·æ±‚  
â€¢ ç”Ÿäº§åŒºï¼šè§£æç”Ÿäº§åŸŸåï¼Œé«˜å¯ç”¨é…ç½®
â€¢ DMZåŒºï¼š  è§£æå…¬ç½‘åŸŸåï¼Œå¯¹å¤–æä¾›æœåŠ¡
```

### 9.2 åˆ†å±‚DNSæ¶æ„è®¾è®¡


**ä¸»DNSæœåŠ¡å™¨é…ç½®**ï¼š
```bash
# /etc/bind/named.conf.local (ä¸»DNSæœåŠ¡å™¨)

# åŠå…¬åŒºåŸŸé…ç½®
zone "office.company.com" {
    type master;
    file "/etc/bind/zones/office.company.com";
    allow-transfer { 192.168.1.2; };  # ä»æœåŠ¡å™¨
    notify yes;
};

# å¼€å‘åŒºåŸŸé…ç½®  
zone "dev.company.com" {
    type forward;
    forwarders { 192.168.10.1; };
    forward only;
};

# ç”Ÿäº§åŒºåŸŸé…ç½®
zone "prod.company.com" {
    type forward; 
    forwarders { 10.0.0.1; };
    forward only;
};

# å¤–ç½‘è½¬å‘
zone "." {
    type forward;
    forwarders { 8.8.8.8; 1.1.1.1; };
    forward first;
};
```

**åŒºåŸŸæ–‡ä»¶ç¤ºä¾‹**ï¼š
```dns
; /etc/bind/zones/office.company.com
$TTL    604800
@       IN      SOA     dns.office.company.com. admin.office.company.com. (
                      2023091901         ; Serial
                         604800         ; Refresh  
                          86400         ; Retry
                        2419200         ; Expire
                         604800 )       ; Negative Cache TTL

; Name servers
@       IN      NS      dns.office.company.com.
@       IN      NS      dns2.office.company.com.

; A records  
dns     IN      A       192.168.1.1
dns2    IN      A       192.168.1.2
mail    IN      A       192.168.1.10
web     IN      A       192.168.1.20
file    IN      A       192.168.1.30

; CNAME records
www     IN      CNAME   web
ftp     IN      CNAME   file
```

### 9.3 é«˜å¯ç”¨DNSé…ç½®


**ä¸»ä»DNSæœåŠ¡å™¨é…ç½®**ï¼š
```bash
# ä¸»æœåŠ¡å™¨é…ç½® (192.168.1.1)
# /etc/bind/named.conf.local

zone "company.com" {
    type master;
    file "/etc/bind/zones/company.com";
    allow-transfer { 192.168.1.2; 192.168.1.3; };
    also-notify { 192.168.1.2; 192.168.1.3; };
    notify yes;
};

# ä»æœåŠ¡å™¨é…ç½® (192.168.1.2)  
# /etc/bind/named.conf.local

zone "company.com" {
    type slave;
    file "/var/cache/bind/company.com";
    masters { 192.168.1.1; };
};
```

**å®¢æˆ·ç«¯DNSé«˜å¯ç”¨é…ç½®**ï¼š
```bash
# /etc/systemd/resolved.conf
[Resolve]
# å¤šä¸ªDNSæœåŠ¡å™¨ï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»
DNS=192.168.1.1 192.168.1.2 192.168.1.3
FallbackDNS=8.8.8.8 1.1.1.1

# æˆ–è€…ä½¿ç”¨ä¼ ç»Ÿresolv.conf
echo "nameserver 192.168.1.1" > /etc/resolv.conf
echo "nameserver 192.168.1.2" >> /etc/resolv.conf  
echo "nameserver 192.168.1.3" >> /etc/resolv.conf
```

### 9.4 ç½‘ç»œæ‹“æ‰‘DNSè‡ªåŠ¨åŒ–ç®¡ç†


**DNSé…ç½®è‡ªåŠ¨åŒ–è„šæœ¬**ï¼š
```bash
#!/bin/bash
# dns-topology-manager.sh

# ç½‘ç»œé…ç½®æ–‡ä»¶
CONFIG_FILE="/etc/dns-topology.conf"

# è¯»å–ç½‘ç»œæ‹“æ‰‘é…ç½®
load_network_config() {
    # ç¤ºä¾‹é…ç½®æ ¼å¼
    # NETWORK_NAME:SUBNET:DNS_SERVER:DOMAIN
    
    declare -A NETWORKS
    while IFS=':' read -r name subnet dns domain; do
        NETWORKS["$name"]="$subnet:$dns:$domain"
    done < "$CONFIG_FILE"
}

# ç”ŸæˆDNSè½¬å‘é…ç½®
generate_dns_config() {
    local output_file="/etc/dnsmasq.d/auto-topology.conf"
    
    echo "# è‡ªåŠ¨ç”Ÿæˆçš„DNSæ‹“æ‰‘é…ç½®" > "$output_file"
    echo "# ç”Ÿæˆæ—¶é—´: $(date)" >> "$output_file"
    echo "" >> "$output_file"
    
    # ä¸ºæ¯ä¸ªç½‘ç»œç”Ÿæˆè§„åˆ™
    for network in "${!NETWORKS[@]}"; do
        IFS=':' read -r subnet dns domain <<< "${NETWORKS[$network]}"
        
        echo "# $network ç½‘ç»œé…ç½®" >> "$output_file"
        echo "server=/$domain/$dns" >> "$output_file"
        echo "server=/$subnet/$dns" >> "$output_file"
        echo "" >> "$output_file"
    done
    
    # é‡å¯DNSæœåŠ¡
    systemctl reload dnsmasq
    echo "DNSé…ç½®å·²æ›´æ–°å¹¶é‡æ–°åŠ è½½"
}

# ç½‘ç»œå˜åŒ–æ£€æµ‹
monitor_network_changes() {
    local last_config=""
    
    while true; do
        current_config=$(ip route show)
        
        if [[ "$current_config" != "$last_config" ]]; then
            echo "æ£€æµ‹åˆ°ç½‘ç»œæ‹“æ‰‘å˜åŒ–ï¼Œé‡æ–°ç”ŸæˆDNSé…ç½®..."
            generate_dns_config
            last_config="$current_config"
        fi
        
        sleep 60  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    done
}

# ä¸»å‡½æ•°
case "$1" in
    "generate") 
        load_network_config
        generate_dns_config
        ;;
    "monitor")
        load_network_config  
        monitor_network_changes
        ;;
    *)
        echo "ç”¨æ³•: $0 {generate|monitor}"
        ;;
esac
```

**ç½‘ç»œæ‹“æ‰‘é…ç½®æ–‡ä»¶ç¤ºä¾‹**ï¼š
```bash
# /etc/dns-topology.conf
# ç½‘ç»œåç§°:å­ç½‘:DNSæœåŠ¡å™¨:åŸŸå

office:192.168.1.0/24:192.168.1.1:office.company.com
dev:192.168.10.0/24:192.168.10.1:dev.company.com  
test:192.168.20.0/24:192.168.20.1:test.company.com
prod:10.0.0.0/24:10.0.0.1:prod.company.com
dmz:172.16.1.0/24:172.16.1.1:dmz.company.com
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ å¤šç½‘ç»œDNSæœ¬è´¨ï¼šä¸åŒç½‘ç»œç”¨ä¸åŒDNSï¼Œé¿å…è§£æå†²çª
ğŸ”¸ åˆ†ç¦»è§£æåŸç†ï¼šå†…ç½‘åŸŸåèµ°å†…ç½‘DNSï¼Œå¤–ç½‘åŸŸåèµ°å¤–ç½‘DNS  
ğŸ”¸ DNSåˆ†æµç­–ç•¥ï¼šåŸºäºåŸŸåã€IPæ®µã€ç½‘ç»œæ¥å£çš„æ™ºèƒ½åˆ†æµ
ğŸ”¸ å®¹å™¨åŒ–DNSï¼šå®¹å™¨éœ€è¦ç‰¹æ®ŠDNSé…ç½®æ‰èƒ½æ­£ç¡®è§£æå†…å¤–ç½‘
ğŸ”¸ é«˜å¯ç”¨è®¾è®¡ï¼šå¤šDNSæœåŠ¡å™¨+è‡ªåŠ¨æ•…éšœè½¬ç§»
```

### 10.2 å…³é”®æŠ€æœ¯ç†è§£è¦ç‚¹


**ğŸ”¹ DNSè·¯ç”±é€‰æ‹©é€»è¾‘**
```
é€‰æ‹©åŸåˆ™ï¼š
â€¢ ç²¾ç¡®åŒ¹é…ä¼˜å…ˆï¼šcompany.com æ¯” .com ä¼˜å…ˆ
â€¢ æœ¬åœ°DNSä¼˜å…ˆï¼šæœ¬ç½‘æ®µDNSæ¯”è¿œç¨‹DNSå¿«
â€¢ å¤‡ç”¨DNSä¿éšœï¼šä¸»DNSå¤±æ•ˆæ—¶è‡ªåŠ¨åˆ‡æ¢
â€¢ ç¼“å­˜æå‡æ€§èƒ½ï¼šé¿å…é‡å¤æŸ¥è¯¢ç›¸åŒåŸŸå
```

**ğŸ”¹ é…ç½®å·¥å…·é€‰æ‹©æŒ‡å—**  
```
å·¥å…·å¯¹æ¯”ï¼š
dnsmasq     â†’ è½»é‡çº§ï¼Œé…ç½®ç®€å•ï¼Œé€‚åˆå°ç¯å¢ƒ
systemd-resolved â†’ ç°ä»£Linuxæ ‡é…ï¼ŒåŠŸèƒ½å®Œå–„
BIND9       â†’ åŠŸèƒ½å¼ºå¤§ï¼Œé€‚åˆå¤§å‹ä¼ä¸šç½‘ç»œ
æ¡ä»¶è½¬å‘     â†’ å¤æ‚ç½‘ç»œå¿…å¤‡ï¼Œéœ€è¦ä»”ç»†è§„åˆ’
```

**ğŸ”¹ æ•…éšœæ’æŸ¥æ€è·¯**
```
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ï¼šping DNSæœåŠ¡å™¨
2. æµ‹è¯•DNSè§£æï¼šdig/nslookupæµ‹è¯•
3. æ£€æŸ¥DNSé…ç½®ï¼šresolv.confç­‰é…ç½®æ–‡ä»¶
4. æŸ¥çœ‹DNSæœåŠ¡çŠ¶æ€ï¼šsystemctl status  
5. åˆ†æDNSæŸ¥è¯¢è·¯å¾„ï¼štcpdumpæŠ“åŒ…åˆ†æ
```

### 10.3 å®é™…åº”ç”¨åœºæ™¯æŒ‡å¯¼


**âœ… é€‚ç”¨åœºæ™¯åˆ¤æ–­**
```
éœ€è¦å¤šç½‘ç»œDNSé…ç½®çš„æƒ…å†µï¼š
â€¢ åŠå…¬ç½‘ç»œ+VPNåŒæ—¶ä½¿ç”¨
â€¢ å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒéš”ç¦»
â€¢ å®¹å™¨åŒ–åº”ç”¨éƒ¨ç½²
â€¢ å¤šæœºæˆ¿ã€å¤šåœ°åŸŸç½‘ç»œ
â€¢ å†…å¤–ç½‘æœåŠ¡æ··åˆè®¿é—®
```

**âŒ å¸¸è§é…ç½®é”™è¯¯**
```
é¿å…è¿™äº›é”™è¯¯ï¼š  
â€¢ DNSæœåŠ¡å™¨é…ç½®é”™è¯¯é¡ºåº
â€¢ å¿˜è®°é…ç½®åå‘è§£æ
â€¢ é˜²ç«å¢™é˜»æ­¢DNSæŸ¥è¯¢
â€¢ è·¯ç”±è¡¨é…ç½®ä¸å½“
â€¢ å®¹å™¨DNSä¸å®¿ä¸»æœºå†²çª
```

### 10.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ› ï¸ é…ç½®æœ€ä½³å®è·µ**
```
æ¨èåšæ³•ï¼š
â€¢ è§„åˆ’å¥½åŸŸåç©ºé—´ï¼šä¸åŒç¯å¢ƒç”¨ä¸åŒå­åŸŸ
â€¢ é…ç½®DNSç¼“å­˜ï¼šæå‡è§£ææ€§èƒ½
â€¢ è®¾ç½®å¤šä¸ªDNSæœåŠ¡å™¨ï¼šæé«˜å¯ç”¨æ€§  
â€¢ å®šæœŸå¤‡ä»½DNSé…ç½®ï¼šé¿å…é…ç½®ä¸¢å¤±
â€¢ ç›‘æ§DNSæœåŠ¡çŠ¶æ€ï¼šåŠæ—¶å‘ç°é—®é¢˜
```

**ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```
ä¼˜åŒ–æ–¹å‘ï¼š
â€¢ å°±è¿‘åŸåˆ™ï¼šDNSæœåŠ¡å™¨éƒ¨ç½²åœ¨ç½‘ç»œé™„è¿‘
â€¢ ç¼“å­˜ç­–ç•¥ï¼šåˆç†è®¾ç½®TTLæ—¶é—´
â€¢ è´Ÿè½½å‡è¡¡ï¼šå¤šDNSæœåŠ¡å™¨åˆ†æ‹…å‹åŠ›
â€¢ æ¡ä»¶è½¬å‘ï¼šé¿å…ä¸å¿…è¦çš„æŸ¥è¯¢è½¬å‘
â€¢ ç›‘æ§å‘Šè­¦ï¼šè‡ªåŠ¨åŒ–è¿ç»´ç®¡ç†
```

**ğŸ”’ å®‰å…¨é˜²æŠ¤è¦ç‚¹**  
```
å®‰å…¨è€ƒè™‘ï¼š
â€¢ é˜²æ­¢DNSåŠ«æŒï¼šä½¿ç”¨å¯ä¿¡DNSæœåŠ¡å™¨
â€¢ é¿å…DNSæ³„éœ²ï¼šVPNç¯å¢ƒä¸‹æ£€æŸ¥DNSèµ°å‘
â€¢ è®¿é—®æ§åˆ¶ï¼šé™åˆ¶DNSæœåŠ¡å™¨è®¿é—®èŒƒå›´  
â€¢ æ—¥å¿—å®¡è®¡ï¼šè®°å½•DNSæŸ¥è¯¢æ—¥å¿—
â€¢ å®šæœŸæ›´æ–°ï¼šä¿æŒDNSè½¯ä»¶æœ€æ–°ç‰ˆæœ¬
```

### 10.5 æ•…éšœæ’æŸ¥å·¥å…·ç®±


**ğŸ”§ å¸¸ç”¨æ’æŸ¥å‘½ä»¤**
```bash
# DNSé…ç½®æ£€æŸ¥
cat /etc/resolv.conf
systemctl status systemd-resolved

# DNSè§£ææµ‹è¯•  
dig domain.com
nslookup domain.com @dns-server

# ç½‘ç»œè¿é€šæ€§æµ‹è¯•
ping dns-server-ip
telnet dns-server-ip 53

# DNSæŸ¥è¯¢è·¯å¾„è¿½è¸ª
dig +trace domain.com  

# å®æ—¶DNSæŸ¥è¯¢ç›‘æ§
tcpdump -i any port 53
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å¤šç½‘ç¯å¢ƒDNSåˆ†æµï¼Œå†…å¤–ç½‘ç»œå„è‡ªæ˜  
- å®¹å™¨è™šæ‹Ÿè¦ç‰¹é…ï¼Œé«˜å¯ç”¨æ€§ä¸èƒ½åœ
- åˆ†å±‚è½¬å‘æ¡ä»¶è®¾ï¼Œæ•…éšœæ’æŸ¥æœ‰ç« å¾ª
- å®‰å…¨æ€§èƒ½ä¸¤æ‰‹æŠ“ï¼Œè‡ªåŠ¨ç®¡ç†æ•ˆç‡å‡