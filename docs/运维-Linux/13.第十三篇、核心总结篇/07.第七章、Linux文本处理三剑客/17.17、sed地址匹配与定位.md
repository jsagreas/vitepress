---
title: 17、sed地址匹配与定位
---
## 📚 目录

1. [sed地址匹配基础概念](#1-sed地址匹配基础概念)
2. [行号地址匹配详解](#2-行号地址匹配详解)
3. [正则表达式地址匹配](#3-正则表达式地址匹配)
4. [地址范围指定技巧](#4-地址范围指定技巧)
5. [特殊地址符号应用](#5-特殊地址符号应用)
6. [地址取反与组合使用](#6-地址取反与组合使用)
7. [实战应用案例](#7-实战应用案例)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🎯 sed地址匹配基础概念


### 1.1 什么是地址匹配


**地址匹配**就是告诉sed命令："我要对哪些行进行操作"。就像你要找到特定的房子才能敲门一样，sed需要先"找到"目标行，然后才能对这些行执行编辑操作。

```
简单理解：地址 = 定位器，告诉sed去哪里工作

没有地址：sed会处理所有行（默认行为）
有地址：sed只处理符合条件的行
```

**核心概念**：
- **🔸 地址（Address）**：指定sed要操作的行位置
- **🔸 定位（Positioning）**：精确找到目标行的过程  
- **🔸 匹配（Matching）**：按条件筛选出符合要求的行

### 1.2 地址的作用原理


```
sed的工作流程：

输入文本
    ↓
读取一行 → 检查地址条件 → 符合条件？
    ↓                        ↓
不符合 ← ← ← ← ← ← ← ← ← ← ← 符合
    ↓                        ↓
跳过这行                   执行命令
    ↓                        ↓
    → → → → → 输出结果 ← ← ← ←
    ↓
继续下一行
```

> 💡 **重要理解**  
> 地址匹配是sed的"筛选器"，决定了命令的作用范围。没有地址就是"全选"，有地址就是"精选"。

---

## 2. 📏 行号地址匹配详解


### 2.1 单行号匹配


**基本语法**：`行号 + 命令`

```bash
# 删除第3行
sed '3d' file.txt

# 打印第5行
sed -n '5p' file.txt

# 在第2行后插入新内容
sed '2a\新增的一行' file.txt
```

**实际示例**：
```bash
# 测试文件内容
cat > test.txt << EOF
第一行内容
第二行内容  
第三行内容
第四行内容
第五行内容
EOF

# 只打印第3行
sed -n '3p' test.txt
# 输出：第三行内容
```

### 2.2 多个单行号匹配


使用 **分号** 或 **多个-e选项** 指定多个行号：

```bash
# 删除第2行和第4行
sed '2d;4d' file.txt
# 或者
sed -e '2d' -e '4d' file.txt

# 打印第1、3、5行
sed -n '1p;3p;5p' file.txt
```

### 2.3 行号匹配的实用技巧


| 应用场景 | 命令示例 | 说明 |
|---------|---------|------|
| **查看文件开头** | `sed -n '1,10p' file.txt` | 显示前10行，类似head |
| **删除第一行** | `sed '1d' file.txt` | 去掉标题行 |
| **查看特定行** | `sed -n '25p' file.txt` | 精确查看第25行 |
| **替换特定行** | `sed '3s/old/new/' file.txt` | 只在第3行进行替换 |

---

## 3. 🔍 正则表达式地址匹配


### 3.1 基本正则地址语法


**语法格式**：`/正则表达式/ + 命令`

```bash
# 删除包含"error"的行
sed '/error/d' log.txt

# 打印包含"success"的行  
sed -n '/success/p' log.txt

# 在包含"TODO"的行前插入分隔符
sed '/TODO/i\=== 待处理事项 ===' file.txt
```

### 3.2 常用正则表达式模式


**🔸 基础模式匹配**：
```bash
# 匹配空行
sed '/^$/d' file.txt

# 匹配以#开头的注释行
sed '/^#/d' config.txt

# 匹配以数字结尾的行
sed -n '/[0-9]$/p' file.txt

# 匹配包含邮箱格式的行
sed -n '/[a-zA-Z0-9._-]*@[a-zA-Z0-9.-]*\.[a-zA-Z]{2,4}/p' file.txt
```

**🔸 复杂模式实例**：
```bash
# 匹配IP地址格式的行
sed -n '/^[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}/p' access.log

# 匹配包含特定单词的行（单词边界）
sed -n '/\broot\b/p' /etc/passwd
```

### 3.3 正则地址的修饰符


**🔸 忽略大小写**：
```bash
# 在某些sed版本中支持I标志
sed '/pattern/Id' file.txt  # 忽略大小写删除

# 通用方法：使用字符类
sed '/[Ee][Rr][Rr][Oo][Rr]/d' file.txt
```

---

## 4. 📊 地址范围指定技巧


### 4.1 行号范围


**语法**：`起始行号,结束行号 + 命令`

```bash
# 删除第2到第5行
sed '2,5d' file.txt

# 打印第10到第20行
sed -n '10,20p' file.txt

# 在第3到第7行进行替换
sed '3,7s/old/new/g' file.txt
```

**实际应用示例**：
```bash
# 提取配置文件的特定部分
sed -n '15,25p' /etc/ssh/sshd_config

# 删除日志文件的前100行
sed '1,100d' large.log
```

### 4.2 正则范围匹配


**语法**：`/开始模式/,/结束模式/ + 命令`

```bash
# 删除从包含"START"到包含"END"的所有行
sed '/START/,/END/d' file.txt

# 打印从第一个空行到下一个空行之间的内容
sed -n '/^$/,/^$/p' file.txt

# 提取XML标签之间的内容
sed -n '/<config>/,/<\/config>/p' config.xml
```

**实用案例**：
```bash
# 提取函数定义（从function开始到}结束）
sed -n '/function.*{/,/^}/p' script.js

# 删除多行注释
sed '/\/\*/,/\*\//d' source.c
```

### 4.3 混合范围匹配


**行号与正则混合**：
```bash
# 从第5行开始到匹配pattern的行结束
sed '5,/pattern/d' file.txt

# 从匹配start的行到第100行
sed '/start/,100s/old/new/g' file.txt
```

---

## 5. 🎲 特殊地址符号应用


### 5.1 最后一行匹配($)


**`$`符号** 代表文件的最后一行：

```bash
# 删除最后一行
sed '$d' file.txt

# 在最后一行后添加内容
sed '$a\这是新增的最后一行' file.txt

# 打印最后5行
sed -n '$-4,$p' file.txt  # 注意：不是所有sed版本都支持算术

# 只替换最后一行的内容
sed '$s/old/new/' file.txt
```

**实际应用**：
```bash
# 在文件末尾添加时间戳
sed '$a\处理时间: '$(date) file.txt

# 删除文件末尾的空行
sed '${/^$/d;}' file.txt
```

### 5.2 步进地址匹配(~)


**语法**：`起始行~步长`，表示从起始行开始，每隔步长取一行

```bash
# 打印奇数行（从第1行开始，每2行取1行）
sed -n '1~2p' file.txt

# 打印偶数行（从第2行开始，每2行取1行） 
sed -n '2~2p' file.txt

# 每5行删除1行（从第5行开始）
sed '5~5d' file.txt

# 每3行打印1行（从第1行开始）
sed -n '1~3p' file.txt
```

**实用场景**：
```bash
# 处理CSV文件，跳过标题行后每2行取1行
sed -n '2~2p' data.csv

# 从日志中提取采样数据
sed -n '1~10p' access.log  # 每10行取1行作为样本
```

---

## 6. 🔄 地址取反与组合使用


### 6.1 地址取反操作(!)


**语法**：`地址! + 命令`，表示对**不匹配**地址的行执行命令

```bash
# 删除不包含"keep"的行（只保留包含keep的行）
sed '/keep/!d' file.txt

# 打印不是空行的内容
sed -n '/^$/!p' file.txt

# 在非注释行前添加行号
sed '/^#/!=' file.txt | sed 'N;s/\n/ /'
```

**实际应用**：
```bash
# 删除除了第1行以外的所有行（只保留标题）
sed '1!d' data.csv

# 对非root用户的行进行处理
sed '/^root:/!s/:.*/:DISABLED:/' /etc/passwd
```

### 6.2 多地址组合使用


**🔸 多个条件的OR关系**：
```bash
# 删除包含error或warning的行
sed '/error/d;/warning/d' log.txt
# 或写成
sed -e '/error/d' -e '/warning/d' log.txt
```

**🔸 地址范围的嵌套**：
```bash
# 在第10-20行中，删除包含"debug"的行
sed '10,20{/debug/d;}' file.txt

# 在匹配section的范围内进行替换
sed '/\[section\]/,/\[.*\]/{s/old/new/g;}' config.ini
```

**🔸 复杂组合示例**：
```bash
# 除了前5行和最后5行，删除所有空行
sed '6,$-5{/^$/d;}' file.txt

# 在包含函数定义的行范围内添加注释
sed '/^function/,/^}/{s/^/# /;}' script.sh
```

---

## 7. 🚀 实战应用案例


### 7.1 日志文件处理


**场景**：处理Web服务器访问日志

```bash
# 提取特定时间段的日志（假设时间格式为HH:MM:SS）
sed -n '/09:00:00/,/17:59:59/p' access.log

# 删除成功请求的记录（状态码200）
sed '/\" 200 /d' access.log

# 只保留错误请求（4xx和5xx状态码）
sed -n '/\" [45][0-9][0-9] /p' access.log

# 统计每小时的请求数（提取小时部分）
sed -n 's/.*\[\([0-9]\{2\}\):\([0-9]\{2\}\):\([0-9]\{2\}\).*/\1/p' access.log | sort | uniq -c
```

### 7.2 配置文件处理


**场景**：批量修改配置文件

```bash
# 注释掉除了某些重要配置外的所有行
sed '/^port\|^host\|^database/!{/^[^#]/s/^/# /;}' config.conf

# 在配置文件的特定段落中添加新配置
sed '/\[database\]/a\max_connections = 100' config.ini

# 删除配置文件中的所有注释和空行
sed '/^#/d;/^$/d' config.conf
```

### 7.3 代码文件处理


**场景**：源代码批处理

```bash
# 删除C++文件中的单行注释
sed '/\/\//d' source.cpp

# 在每个函数定义前添加分隔注释
sed '/^[a-zA-Z_][a-zA-Z0-9_]* *(/i\// ==============================' source.c

# 提取Python文件中的类定义
sed -n '/^class /,/^[[:space:]]*$/p' script.py
```

---

## 8. 📋 核心要点总结


### 8.1 地址类型速查表


| 地址类型 | 语法示例 | 作用说明 |
|---------|---------|---------|
| **🔸 单行号** | `3d` | 删除第3行 |
| **🔸 行范围** | `2,5p` | 打印第2到5行 |
| **🔸 正则匹配** | `/pattern/d` | 删除匹配pattern的行 |
| **🔸 正则范围** | `/start/,/end/p` | 打印start到end之间的行 |
| **🔸 最后一行** | `$s/a/b/` | 在最后一行替换a为b |
| **🔸 步进匹配** | `1~2p` | 打印奇数行 |
| **🔸 地址取反** | `/pattern/!d` | 删除不匹配pattern的行 |

### 8.2 实用技巧总结


**🔹 地址匹配的性能考虑**：
- 行号匹配比正则匹配更快
- 简单正则比复杂正则更高效  
- 使用范围可以减少不必要的匹配尝试

**🔹 常见错误避免**：
- 正则表达式要用`/`包围
- 地址取反的`!`要紧跟地址后面
- 范围匹配要注意开始和结束条件

**🔹 调试技巧**：
```bash
# 先用-n和p命令测试地址是否正确
sed -n '地址p' file.txt

# 使用=命令显示行号帮助调试
sed '地址=' file.txt
```

### 8.3 记忆口诀


```
地址定位很重要，sed命令效果好
行号直接数字写，正则表达式用斜杠
范围匹配用逗号，步进匹配波浪号  
最后一行美元号，取反操作感叹号
组合使用分号连，精准定位不会错
```

### 8.4 学习建议


- [x] **掌握基本地址类型**：行号、正则、范围
- [x] **理解特殊符号含义**：$、~、!的具体作用
- [x] **练习组合使用**：多种地址类型的灵活组合  
- [ ] **熟悉实际应用**：在真实场景中运用地址匹配
- [ ] **掌握调试方法**：学会测试和验证地址匹配效果

> 💡 **学习提示**  
> 地址匹配是sed最核心的概念，掌握了地址匹配就掌握了sed的精髓。建议多做练习，从简单的行号匹配开始，逐步掌握复杂的正则范围匹配。