---
title: 4、chrony时间同步服务
---
## 📚 目录

1. [chrony服务概述](#1-chrony服务概述)
2. [chronyd守护进程详解](#2-chronyd守护进程详解)
3. [主配置文件解析](#3-主配置文件解析)
4. [chronyc客户端管理](#4-chronyc客户端管理)
5. [时间源配置策略](#5-时间源配置策略)
6. [时钟调整机制](#6-时钟调整机制)
7. [日志监控与故障排查](#7-日志监控与故障排查)
8. [核心要点总结](#8-核心要点总结)

---

## 1. ⏰ chrony服务概述


### 1.1 什么是chrony

**chrony** 是一个现代化的网络时间协议（NTP）实现，专门用于在Linux系统中保持系统时钟的精确同步。

```
传统NTP服务 vs chrony服务：
老式ntpd：        现代chrony：
- 启动慢          - 启动快
- 同步精度一般    - 同步精度高
- 资源消耗多      - 资源消耗少
- 配置复杂        - 配置简单
```

**🔸 chrony的核心优势**：
- **快速同步**：能够在几秒内完成时钟同步，而不是传统NTP的几分钟
- **网络适应性**：对网络延迟和间歇性连接有更好的适应能力
- **精确度高**：在良好网络条件下可达到微秒级精度
- **资源友好**：占用更少的系统资源

### 1.2 chrony的工作原理

chrony通过以下方式确保时间同步：

```
时间同步基本流程：
本地系统 → chronyd进程 → NTP服务器
    ↑                         ↓
    ←── 获取准确时间 ←────────────
```

**核心工作机制**：
1. **时间测量**：定期向时间源发送时间查询请求
2. **延迟计算**：计算网络传输延迟，补偿时间差异
3. **时钟调整**：根据测量结果调整本地系统时钟
4. **漂移记录**：记录时钟漂移情况，提高长期精度

---

## 2. 🔧 chronyd守护进程详解


### 2.1 chronyd是什么

**chronyd** 是chrony服务的核心守护进程，负责实际的时间同步工作。

> 💡 **简单理解**：如果把时间同步比作校对手表，chronyd就是那个专门负责校对的"工人"，它不停地工作，确保你的"手表"（系统时钟）始终准确。

### 2.2 chronyd的启动与管理


**systemd管理方式**：
```bash
# 启动chrony服务
sudo systemctl start chronyd

# 设置开机自启
sudo systemctl enable chronyd

# 查看服务状态
sudo systemctl status chronyd

# 重启服务
sudo systemctl restart chronyd
```

**服务状态解读**：
```
● chronyd.service - NTP client/server
   Loaded: loaded (/usr/lib/systemd/system/chronyd.service; enabled)
   Active: active (running) since Mon 2024-01-15 10:30:00 CST
   
✅ Active (running) = 服务正常运行
⚠️ Failed = 服务启动失败
🔄 Inactive = 服务已停止
```

### 2.3 chronyd进程监控

```bash
# 查看chronyd进程
ps aux | grep chronyd

# 查看进程详细信息
pstree -p | grep chronyd
```

**典型输出解析**：
```
chrony   1234  0.0  0.1  12345  6789 ? Ss 10:30 0:00 /usr/sbin/chronyd
         ↑     ↑    ↑     ↑      ↑   ↑  ↑    ↑     ↑
      用户名  PID  CPU  内存   虚拟  实际 状态 启动时间 运行时间
```

---

## 3. 📁 主配置文件解析


### 3.1 /etc/chrony.conf文件结构

这个配置文件是chrony的"大脑"，告诉它如何进行时间同步。

**文件路径与权限**：
```
配置文件：/etc/chrony.conf
权限要求：root可读写，其他用户只读
备份建议：修改前先备份原文件
```

### 3.2 核心配置指令详解


#### 🌐 时间源配置（server/pool）


**server指令** - 指定单个时间服务器：
```bash
server 0.centos.pool.ntp.org iburst
server 1.centos.pool.ntp.org iburst
server ntp.aliyun.com iburst
```

**pool指令** - 指定时间服务器池：
```bash
pool 2.centos.pool.ntp.org iburst
pool cn.pool.ntp.org iburst
```

> 📝 **pool vs server的区别**：
> - **server**：指定一台具体的NTP服务器
> - **pool**：指定一组NTP服务器，chrony会自动选择最佳的几台

**iburst选项解释**：
- **作用**：在服务启动时快速发送8个时间查询包
- **好处**：大大加快初始同步速度
- **建议**：几乎所有server/pool配置都应该加上这个选项

#### ⚖️ 时间调整配置


**makestep指令**：
```bash
makestep 1.0 3
#       ↑   ↑
#   阈值时间 前几次同步
```

> 💡 **通俗解释**：当时间差异超过1秒时，前3次同步可以"大幅调整"时间（跳跃式调整），之后只能"缓慢调整"

**driftfile指令**：
```bash
driftfile /var/lib/chrony/drift
```

> 📊 **drift文件作用**：记录系统时钟的"走时偏差"，就像记录手表每天快几秒或慢几秒，用于提高同步精度

#### 🔒 访问控制配置


**allow指令**：
```bash
allow 192.168.1.0/24    # 允许整个子网
allow 10.0.0.100        # 允许单个IP
```

**deny指令**：
```bash
deny 192.168.2.0/24     # 拒绝特定子网
deny all                # 拒绝所有（默认策略）
```

### 3.3 完整配置文件示例

```bash
# 时间源配置
pool cn.pool.ntp.org iburst
server ntp.aliyun.com iburst

# 时钟调整设置
makestep 1.0 3
driftfile /var/lib/chrony/drift

# 访问控制
allow 192.168.1.0/24

# 日志配置
logdir /var/log/chrony
log measurements statistics tracking

# 其他设置
rtcsync                 # 同步RTC硬件时钟
```

---

## 4. 🛠️ chronyc客户端管理工具


### 4.1 chronyc工具简介

**chronyc** 是chrony的客户端管理工具，用于查看状态、监控同步情况和执行管理操作。

> 🔧 **形象比喻**：如果chronyd是工人，那么chronyc就是管理员，用来查看工人的工作状态，下达工作指令

### 4.2 基础状态查看命令


#### 📊 sources - 查看时间源状态

```bash
chronyc sources -v
```

**输出解析**：
```
MS Name/IP address         Stratum Poll Reach LastRx Last sample               
===============================================================================
^+ ntp.aliyun.com                2   6   377    63   +1ms[  +2ms] +/-   50ms
^* cn.pool.ntp.org               1   6   377    31   -2ms[  -1ms] +/-   30ms
^? 202.112.10.36                 2   6   377   125   +5ms[  +5ms] +/-  100ms

符号含义：
^* = 当前同步源（最佳选择）
^+ = 候选同步源（备用选择） 
^? = 不可用或质量差的源
^- = 被排除的源
```

#### 🎯 tracking - 查看同步状态

```bash
chronyc tracking
```

**输出解析**：
```
Reference ID    : C0A80001 (192.168.0.1)
Stratum         : 3            # 时间层级
Ref time (UTC)  : Mon Jan 15 10:30:00 2024
System time     : 0.000123000 seconds fast of NTP time
Last offset     : +0.000050000 seconds
RMS offset      : 0.000100000 seconds
```

> 📈 **关键指标说明**：
> - **System time**：本地时间与NTP时间的偏差
> - **Last offset**：上次调整的偏移量
> - **RMS offset**：偏移量的均方根值（越小越好）

### 4.3 管理操作命令


#### ⚡ makestep - 强制时间调整

```bash
# 立即强制调整时间
chronyc makestep
```

> ⚠️ **使用注意**：这个命令会立即调整系统时间，可能影响正在运行的程序，建议谨慎使用

#### 🔄 burst - 快速同步

```bash
# 向指定服务器发送突发同步请求
chronyc burst 4/4
```

#### 📝 activity - 查看活动状态

```bash
chronyc activity
```

**输出示例**：
```
200 OK
4 sources online
0 sources offline
2 sources doing burst (return to online)
0 sources doing burst (return to offline)
```

---

## 5. 🌐 时间源配置策略


### 5.1 NTP服务器池的概念


**什么是NTP池**：
NTP池是由全球志愿者提供的时间服务器集群，通过DNS轮询技术自动分配最佳服务器。

```
单一服务器 vs 服务器池：
单一服务器：               服务器池：
    ↓                       ↓
  [NTP1]                [NTP Pool]
    ↓                    ↙  ↓  ↘
 你的服务器             NTP1 NTP2 NTP3
                         ↘  ↓  ↙
                        你的服务器

风险：单点故障            优势：自动故障切换
```

### 5.2 常用NTP服务器推荐


**🇨🇳 中国区域NTP池**：
```bash
# 中国NTP池（推荐）
pool cn.pool.ntp.org iburst
pool asia.pool.ntp.org iburst

# 阿里云NTP服务器（稳定）
server ntp.aliyun.com iburst
server ntp1.aliyun.com iburst

# 国家授时中心
server ntp.ntsc.ac.cn iburst
```

**🌍 全球通用NTP池**：
```bash
pool 0.pool.ntp.org iburst
pool 1.pool.ntp.org iburst
pool 2.pool.ntp.org iburst
```

### 5.3 时间源优先级配置


**prefer选项** - 设置首选服务器：
```bash
server ntp.aliyun.com iburst prefer
server cn.pool.ntp.org iburst
```

**maxsources选项** - 限制源数量：
```bash
pool cn.pool.ntp.org iburst maxsources 4
```

> 💡 **配置建议**：
> - 至少配置3-4个时间源以确保可靠性
> - 混合使用pool和server指令
> - 优先选择地理位置近的服务器

---

## 6. ⚙️ 时钟调整机制


### 6.1 makestep强制时间调整详解


**makestep指令语法**：
```bash
makestep threshold limit
#        阈值      次数限制
```

**参数含义**：
- **threshold**：时间差异阈值（秒）
- **limit**：允许强制调整的次数，0表示不限制

**常见配置模式**：
```bash
makestep 1.0 3      # 超过1秒差异时，前3次可强制调整
makestep 0.1 -1     # 超过0.1秒就强制调整，不限次数
makestep 1.0 0      # 从不强制调整，只能缓慢调整
```

### 6.2 时钟调整方式对比


| 调整方式 | **适用场景** | **调整速度** | **对系统影响** |
|----------|-------------|-------------|---------------|
| **步进调整** | `时差>阈值，前几次同步` | `立即生效` | `可能影响运行程序` |
| **渐进调整** | `时差<阈值，日常同步` | `缓慢调整` | `对系统影响最小` |

### 6.3 driftfile时钟漂移记录


**drift文件的作用机制**：
```
系统启动 → 读取drift文件 → 获取历史漂移数据 → 预补偿时钟偏差
    ↓                                              ↓
运行期间 ← 更新drift文件 ← 监测实际漂移 ← 计算漂移率
```

**drift文件内容示例**：
```bash
cat /var/lib/chrony/drift
# 输出：-2.345000
# 含义：系统时钟每秒比标准时间慢2.345微秒
```

> 📊 **漂移值解读**：
> - **负值**：系统时钟偏慢
> - **正值**：系统时钟偏快
> - **绝对值越小**：时钟精度越高

---

## 7. 📊 日志监控与故障排查


### 7.1 chrony日志配置


**日志相关配置指令**：
```bash
# 日志目录
logdir /var/log/chrony

# 启用不同类型的日志
log measurements    # 记录时间测量数据
log statistics      # 记录统计信息
log tracking       # 记录跟踪信息
log tempcomp       # 记录温度补偿（如果启用）
log refclocks      # 记录参考时钟信息
```

### 7.2 重要日志文件分析


**measurements.log** - 时间测量日志：
```bash
tail -f /var/log/chrony/measurements.log
```

**典型日志条目**：
```
2024-01-15 10:30:15 N  2 111.230.189.174  7FFF  -0.001234  0.000567  0.125000  0.089000
                    ↑  ↑      ↑           ↑        ↑         ↑         ↑         ↑
                  来源 层级   服务器IP    状态码   偏移量    延迟    离散度    根延迟
```

**statistics.log** - 统计信息日志：
```bash
# 查看统计日志
tail -f /var/log/chrony/statistics.log
```

### 7.3 常见问题诊断


**🔍 问题1：时间无法同步**
```bash
# 检查步骤
chronyc sources -v     # 查看时间源状态
chronyc tracking       # 查看同步状态
systemctl status chronyd  # 查看服务状态
```

**解决思路**：
- ✅ 检查网络连接是否正常
- ✅ 验证防火墙是否阻止NTP端口（123/udp）
- ✅ 确认时间源服务器是否可达

**🔍 问题2：同步精度不佳**
```bash
# 查看详细跟踪信息
chronyc tracking
chronyc sourcestats -v
```

**优化措施**：
- 🎯 选择更近的时间服务器
- 🎯 增加时间源数量
- 🎯 调整polling间隔

**🔍 问题3：服务启动失败**
```bash
# 查看详细错误信息
journalctl -u chronyd -f
systemctl status chronyd -l
```

**常见启动失败原因**：
- ❌ 配置文件语法错误
- ❌ 端口被占用（其他NTP服务运行）
- ❌ 权限问题

### 7.4 性能监控命令


**sourcestats** - 时间源统计：
```bash
chronyc sourcestats -v
```

**输出解析**：
```
Name/IP Address            NP  NR  Span  Frequency  Freq Skew  Offset  Std Dev
================================================================================
ntp.aliyun.com             15  10   17m     +0.025      1.234  -0.001ms   2.3ms
                           ↑   ↑    ↑        ↑         ↑        ↑        ↑
                       样本数 运行 时间跨度  频率偏移  频率偏斜  时间偏移  标准差
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 chronyd守护进程：chrony的核心工作进程，负责实际时间同步
🔸 /etc/chrony.conf：主配置文件，定义时间源、调整策略等
🔸 chronyc工具：客户端管理工具，用于查看状态和执行管理操作
🔸 pool指令：配置NTP服务器池，提供冗余和负载均衡
🔸 makestep机制：控制大幅时间调整的阈值和次数
🔸 driftfile：记录系统时钟漂移，提高长期同步精度
```

### 8.2 关键配置要点


**🔹 时间源配置最佳实践**：
```bash
# 推荐配置组合
pool cn.pool.ntp.org iburst maxsources 4
server ntp.aliyun.com iburst prefer
server ntp1.aliyun.com iburst
```

**🔹 时钟调整策略**：
```bash
# 平衡稳定性和快速同步
makestep 1.0 3          # 启动时允许大调整
driftfile /var/lib/chrony/drift  # 记录漂移提高精度
```

**🔹 安全访问控制**：
```bash
# 仅允许必要的网络访问
allow 192.168.1.0/24    # 内网访问
deny all                # 拒绝其他所有访问
```

### 8.3 日常管理命令速查


| **命令** | **用途** | **输出关键信息** |
|----------|----------|-----------------|
| `chronyc sources -v` | `查看时间源状态` | `^*表示当前同步源` |
| `chronyc tracking` | `查看同步精度` | `System time偏差` |
| `chronyc activity` | `查看服务活动` | `在线源数量` |
| `systemctl status chronyd` | `查看服务状态` | `运行状态和错误` |

### 8.4 故障排查思路


**⭐ 基础检查流程**：
1. **服务状态** → `systemctl status chronyd`
2. **时间源状态** → `chronyc sources -v`
3. **同步精度** → `chronyc tracking`
4. **网络连通性** → `ping ntp服务器地址`
5. **日志分析** → `journalctl -u chronyd`

**⭐ 常见问题解决**：
- **无法同步**：检查网络和防火墙设置
- **精度不够**：优化时间源选择和配置参数
- **启动失败**：检查配置文件语法和端口占用

**核心记忆要点**：
- chrony比传统NTP更快更准确
- chronyd是工作进程，chronyc是管理工具
- /etc/chrony.conf是核心配置文件
- makestep控制大幅时间调整策略
- driftfile提高长期同步精度
- pool指令比server指令更可靠