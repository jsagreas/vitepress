---
title: 1、系统日志体系架构
---
## 📚 目录

1. [Linux日志系统概述](#1-Linux日志系统概述)
2. [syslog协议标准](#2-syslog协议标准)
3. [现代双轨制日志架构](#3-现代双轨制日志架构)
4. [日志级别与设施分类](#4-日志级别与设施分类)
5. [日志消息格式解析](#5-日志消息格式解析)
6. [内核日志与用户空间日志](#6-内核日志与用户空间日志)
7. [日志缓冲区与持久化](#7-日志缓冲区与持久化)
8. [CentOS/RHEL默认配置](#8-CentOS-RHEL默认配置)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🖥️ Linux日志系统概述


### 1.1 什么是日志系统


Linux日志系统就像是系统的"**记录员**"，它负责收集、存储和管理系统中各种程序产生的信息记录。

**🔸 日志系统的作用**
- **记录系统活动**：什么时候发生了什么事情
- **故障诊断**：出问题时可以查看日志找原因
- **安全审计**：追踪谁在什么时候做了什么操作
- **性能监控**：了解系统运行状态和资源使用情况

### 1.2 日志系统的发展历程


```
传统时代           现代时代
┌─────────────┐   ┌─────────────────┐
│   syslog    │ → │  rsyslog        │
│  (简单记录)  │   │ (功能增强)       │
└─────────────┘   │  systemd-journald│
                  │ (二进制日志)      │
                  └─────────────────┘
```

Linux日志系统经历了从简单到复杂的演进：
- **早期**：只有基本的syslog功能
- **现在**：有rsyslog和systemd-journald两套系统并存

### 1.3 日志系统的核心组件


**📋 主要组件说明**
- **`rsyslog`**：传统文本日志处理程序，负责收集和存储日志
- **`systemd-journald`**：现代二进制日志系统，与systemd集成
- **日志文件**：存储在`/var/log/`目录下的各种日志文件
- **配置文件**：控制日志如何收集、处理和存储

---

## 2. 📜 syslog协议标准


### 2.1 syslog协议是什么


syslog是一个**标准化的日志协议**，定义了日志消息的格式和传输方式。就像邮件有统一的格式一样，日志消息也需要统一的标准。

**🎯 syslog的核心特点**
- **标准化格式**：所有程序产生的日志都遵循相同格式
- **网络传输**：支持通过网络发送日志到远程服务器
- **优先级分类**：按重要程度和来源对日志分类
- **简单可靠**：设计简单，不容易出故障

### 2.2 syslog协议的工作方式


```
应用程序                syslog守护进程              日志文件
    |                        |                       |
    |--发送日志消息----------->|                       |
    |   (包含优先级)          |                       |
    |                        |--根据规则筛选--------->|/var/log/messages
    |                        |                       |/var/log/secure
    |                        |                       |/var/log/maillog
    |                        |                       |    ...
```

**工作流程解释**：
1. 应用程序产生日志消息
2. 通过syslog接口发送给syslog守护进程
3. syslog守护进程根据配置规则决定存储位置
4. 日志被写入相应的文件或发送到网络

### 2.3 syslog的实现版本


| 实现版本 | **特点** | **适用场景** |
|---------|---------|-------------|
| **传统syslog** | `基础功能，配置简单` | `老旧系统，简单需求` |
| **rsyslog** | `功能丰富，性能较好` | `企业环境，复杂配置` |
| **syslog-ng** | `配置灵活，过滤强大` | `高级用户，定制需求` |

---

## 3. 🔄 现代双轨制日志架构


### 3.1 什么是双轨制


现代Linux系统采用**双轨制日志架构**，就是同时运行两套日志系统：

```
┌─────────────────────────────────────────┐
│            应用程序产生日志              │
└─────────────┬───────────────────────────┘
              │
         ┌────▼────┐
         │分发到两套│
         │日志系统  │
         └────┬────┘
              │
    ┌─────────▼─────────┐
    │                   │
┌───▼────┐        ┌────▼─────┐
│rsyslog │        │systemd-  │
│(文本)  │        │journald  │
│        │        │(二进制)  │
└───┬────┘        └────┬─────┘
    │                  │
┌───▼────┐        ┌────▼─────┐
│/var/log│        │journal   │
│/*.log  │        │数据库    │
└────────┘        └──────────┘
```

### 3.2 rsyslog系统特点


**🔸 rsyslog是什么**
rsyslog是传统syslog的增强版本，处理**文本格式**的日志。

**主要特点**：
- **⭐ 人类可读**：日志文件是普通文本，可以直接用cat、less等命令查看
- **🔧 配置灵活**：支持复杂的过滤和路由规则
- **🌐 网络支持**：可以接收和发送网络日志
- **📁 文件分类**：按不同类型存储到不同文件

**常见配置文件**：`/etc/rsyslog.conf`

### 3.3 systemd-journald系统特点


**🔸 systemd-journald是什么**
systemd-journald是现代Linux发行版的**二进制日志系统**，与systemd紧密集成。

**主要特点**：
- **💾 二进制存储**：使用二进制格式存储，查询速度快
- **🔍 结构化查询**：支持复杂的查询和过滤
- **🔐 完整性保护**：具有数据完整性校验
- **📊 元数据丰富**：每条日志包含丰富的元信息

**查看工具**：使用`journalctl`命令查看

### 3.4 双轨制的协作方式


**🤝 两套系统如何协作**

```bash
# journald收集所有日志，然后转发给rsyslog
journalctl --no-pager -n 5  # 查看最新5条journal日志
tail -5 /var/log/messages   # 查看最新5条rsyslog日志
```

**协作流程**：
1. **journald**先收集所有日志
2. 对重要日志，journald转发给**rsyslog**
3. rsyslog按传统方式存储到文本文件
4. 用户可以选择查看journal日志或传统日志文件

---

## 4. 🎯 日志级别与设施分类


### 4.1 日志级别分类详解


日志级别就像**紧急程度分类**，告诉我们这条日志有多重要。

**📊 8个日志级别（从高到低）**

| 级别代码 | **级别名称** | **含义解释** | **实际例子** |
|---------|-------------|-------------|-------------|
| `0` | **emergency** | `系统无法使用，灾难性故障` | `内核崩溃，系统无法启动` |
| `1` | **alert** | `需要立即采取行动` | `硬盘已满，数据库崩溃` |
| `2` | **critical** | `关键错误条件` | `重要服务停止，硬件故障` |
| `3` | **error** | `一般错误条件` | `文件找不到，连接失败` |
| `4` | **warning** | `警告条件，可能出问题` | `磁盘空间不足，配置有误` |
| `5` | **notice** | `正常但重要的条件` | `用户登录，服务启动` |
| `6` | **info** | `一般信息性消息` | `程序正常运行状态` |
| `7` | **debug** | `调试级别信息` | `程序内部调试信息` |

**🎯 级别使用建议**
- **0-2级**：系统管理员必须立即处理
- **3-4级**：需要关注，但不一定紧急
- **5-6级**：正常运行信息，可定期查看
- **7级**：只在调试时需要关注

### 4.2 日志设施分类详解


日志设施就像**部门分类**，告诉我们这条日志来自哪个系统组件。

**📋 主要设施类型**

| 设施代码 | **设施名称** | **来源说明** | **存储位置** |
|---------|-------------|-------------|-------------|
| `kern` | **内核消息** | `内核和驱动程序` | `/var/log/dmesg` |
| `mail` | **邮件系统** | `邮件服务器和客户端` | `/var/log/maillog` |
| `daemon` | **系统守护进程** | `各种后台服务` | `/var/log/messages` |
| `auth` | **安全认证** | `登录、sudo、ssh等` | `/var/log/secure` |
| `syslog` | **syslog消息** | `syslog程序自身` | `/var/log/messages` |
| `user` | **用户程序** | `普通用户程序` | `/var/log/messages` |
| `local0-7` | **本地自定义** | `自定义程序分类` | `可配置` |

### 4.3 优先级的计算方式


**🧮 优先级 = 设施码 × 8 + 级别码**

```bash
# 举例：mail.warning的优先级计算
# mail设施码=2，warning级别码=4
# 优先级 = 2 × 8 + 4 = 20

# 查看系统当前设施和级别
logger -p mail.warning "测试邮件警告消息"
```

**常见优先级组合**：
- `kern.emerg`：内核紧急消息
- `auth.info`：认证信息消息  
- `mail.err`：邮件错误消息
- `daemon.warning`：守护进程警告

---

## 5. 📝 日志消息格式解析


### 5.1 标准syslog消息格式


每条日志消息都有**固定的格式**，就像填写表格一样有固定栏位。

**📋 标准格式结构**
```
时间戳 主机名 程序名[进程ID]: 消息内容
```

**🔍 实际例子解析**
```
Jan 15 10:30:45 server01 sshd[12345]: Accepted password for user1 from 192.168.1.100 port 22 ssh2
│     │   │      │       │     │                    │
│     │   │      │       │     └─ 进程ID
│     │   │      │       └─ 程序名  
│     │   │      └─ 主机名
│     │   └─ 时间
│     └─ 月份
└─ 月份
```

**字段含义说明**：
- **时间戳**：`Jan 15 10:30:45`（月 日 时:分:秒）
- **主机名**：`server01`（产生日志的机器名）
- **程序名**：`sshd`（产生日志的程序）
- **进程ID**：`[12345]`（程序的进程号）
- **消息内容**：具体的日志信息

### 5.2 rsyslog增强格式


rsyslog支持更丰富的格式，可以添加更多信息：

```bash
# 查看rsyslog配置的消息格式
grep "Format" /etc/rsyslog.conf

# 常见的增强格式包含：
# %timegenerated% %HOSTNAME% %syslogtag% %msg%
# 2025-01-15T10:30:45.123456+08:00 server01 sshd[12345]: 消息内容
```

**🎯 增强格式的优势**
- **精确时间**：包含毫秒和时区信息
- **更多元数据**：可以包含设施、级别等信息
- **自定义格式**：可以根据需要调整格式

### 5.3 journal消息格式


systemd-journald使用结构化的二进制格式：

```bash
# 查看journal的完整字段
journalctl -o verbose -n 1

# 输出示例（简化）：
# _HOSTNAME=server01
# _PID=12345
# _COMM=sshd
# MESSAGE=Accepted password for user1
# PRIORITY=6
# SYSLOG_FACILITY=10
```

**journal格式特点**：
- **结构化存储**：每个字段都有明确的名称和类型
- **丰富元数据**：包含进程、用户、系统状态等信息
- **快速查询**：可以按任意字段快速检索

---

## 6. 🔄 内核日志与用户空间日志


### 6.1 什么是内核日志


**内核日志**就是Linux**内核自己产生的日志**，记录系统底层的活动。

```
┌─────────────────────────────────────┐
│            内核空间                  │
│  ┌─────────────────────────────┐    │
│  │    内核日志 (printk)        │    │
│  │  - 启动信息                  │    │ 
│  │  - 硬件检测                  │    │
│  │  - 驱动加载                  │    │
│  │  - 错误报告                  │    │
│  └─────────────────────────────┘    │
└─────────────────┬───────────────────┘
                  │
┌─────────────────▼───────────────────┐
│            用户空间                  │
│  ┌─────────────────────────────┐    │
│  │   用户程序日志               │    │
│  │  - 应用程序日志              │    │
│  │  - 服务日志                  │    │
│  │  - 登录日志                  │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

### 6.2 内核日志的特点


**🔸 内核日志特点**
- **系统启动时产生**：记录系统启动过程中的所有信息
- **硬件相关**：显示硬件检测和驱动程序加载信息
- **错误诊断重要**：系统底层问题通常在这里体现
- **级别分明**：有不同的严重性级别

**查看内核日志的命令**：
```bash
# 查看内核日志
dmesg                    # 查看内核环形缓冲区
dmesg -T                 # 显示时间戳
dmesg -l err,warn        # 只显示错误和警告

# 查看启动日志
journalctl -k            # systemd方式查看内核日志
cat /var/log/dmesg       # 查看启动时的内核日志文件
```

### 6.3 用户空间日志


**用户空间日志**是运行在用户空间的**各种程序产生的日志**。

**🎯 用户空间日志分类**

| 日志类型 | **文件位置** | **记录内容** |
|---------|-------------|-------------|
| **登录日志** | `/var/log/secure` | `SSH登录、su切换、sudo操作` |
| **系统服务** | `/var/log/messages` | `系统服务的启动、停止、错误` |
| **邮件日志** | `/var/log/maillog` | `邮件服务器的收发记录` |
| **网页服务** | `/var/log/httpd/` | `Apache网页服务器访问记录` |
| **数据库** | `/var/log/mysql/` | `MySQL数据库操作记录` |

### 6.4 两类日志的区别


**⚖️ 主要区别对比**

| 方面 | **内核日志** | **用户空间日志** |
|-----|-------------|----------------|
| **产生者** | `Linux内核` | `用户程序和服务` |
| **内容** | `硬件、驱动、系统底层` | `应用程序、服务运行状态` |
| **查看方式** | `dmesg、journalctl -k` | `tail、cat、journalctl` |
| **存储位置** | `内核环形缓冲区` | `文件系统中的日志文件` |
| **重要性** | `系统底层故障诊断` | `应用层问题诊断` |

---

## 7. 💾 日志缓冲区与持久化


### 7.1 什么是日志缓冲区


**日志缓冲区**就像是一个**临时存储区域**，系统先把日志放在内存里，再决定是否写入硬盘。

```
程序产生日志 → 内存缓冲区 → 判断条件 → 写入磁盘
     │           │         │         │
     │           │         │         └─持久化存储
     │           │         └─达到条件触发
     │           └─临时存储
     └─日志源头
```

**🎯 缓冲区的作用**
- **提高性能**：避免频繁的磁盘写入操作
- **批量处理**：积攒一定量的日志再一起写入
- **过滤无用**：可以在缓冲区阶段过滤掉不重要的日志
- **应对突发**：处理短时间内的大量日志

### 7.2 内核环形缓冲区


内核有一个特殊的**环形缓冲区**（Ring Buffer）来存储内核日志。

**🔄 环形缓冲区工作原理**
```
┌─────────────────────────────────┐
│    内核环形缓冲区 (固定大小)     │
│                                │
│  [旧日志]←─────┐  ┌─────→[新日志] │
│     ↑         │  │         ↓    │
│     │    ┌────▼──▼────┐    │    │
│     │    │    写指针    │    │    │
│     │    │    读指针    │    │    │
│     │    └────────────┘    │    │
│     └───────────────────────┘    │
│                                │
└─────────────────────────────────┘
```

**特点说明**：
- **固定大小**：通常几MB，满了就覆盖最旧的日志
- **不持久**：重启后内容丢失
- **高速访问**：在内存中，访问速度快
- **dmesg查看**：使用dmesg命令查看内容

### 7.3 用户空间缓冲机制


rsyslog和journald都有自己的缓冲机制：

**📊 rsyslog缓冲配置**
```bash
# /etc/rsyslog.conf 中的缓冲配置
$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat
$ActionFileEnableSync on     # 同步写入，安全但慢
$ActionQueueSize 10000       # 队列大小
$ActionQueueDiscardSeverity 0 # 丢弃级别
```

**🔧 journald缓冲配置**
```bash
# /etc/systemd/journald.conf 中的缓冲配置
[Journal]
Storage=persistent          # 持久化存储
SystemMaxUse=1G            # 最大使用空间
RuntimeMaxUse=100M         # 运行时最大内存使用
SyncIntervalSec=5m         # 同步间隔
```

### 7.4 持久化策略


**什么是持久化**：把内存中的日志数据写入到磁盘文件中，确保重启后不丢失。

**🎯 持久化触发条件**
- **时间触发**：每隔一定时间自动写入
- **数量触发**：积累一定数量的日志后写入
- **级别触发**：遇到重要级别的日志立即写入
- **关机触发**：系统关闭时强制写入所有缓冲日志

**💡 持久化配置示例**
```bash
# 立即同步重要日志
*.emerg                     :omusrmsg:*
*.alert                     /var/log/alert.log

# 批量写入一般日志  
*.info;mail.none;authpriv.none;cron.none    /var/log/messages
```

---

## 8. ⚙️ CentOS/RHEL默认配置


### 8.1 默认日志目录结构


CentOS/RHEL系统的日志文件都存放在`/var/log/`目录下：

```
/var/log/
├── messages        ← 系统主日志文件
├── secure         ← 安全认证日志
├── maillog        ← 邮件系统日志
├── cron           ← 定时任务日志
├── boot.log       ← 系统启动日志
├── dmesg          ← 内核启动日志
├── yum.log        ← 软件包管理日志
├── audit/         ← 审计日志目录
├── httpd/         ← Apache日志目录
└── journal/       ← systemd journal日志
```

### 8.2 主要配置文件


**📋 关键配置文件位置**

| 配置文件 | **作用** | **主要内容** |
|---------|---------|-------------|
| `/etc/rsyslog.conf` | `rsyslog主配置` | `日志规则、输出格式` |
| `/etc/rsyslog.d/` | `rsyslog扩展配置` | `各服务的专门配置` |
| `/etc/systemd/journald.conf` | `journald配置` | `journal存储设置` |
| `/etc/logrotate.conf` | `日志轮转配置` | `日志切割和清理规则` |

### 8.3 默认rsyslog.conf配置解读


**🔍 典型配置示例**
```bash
# 查看rsyslog配置的关键部分
grep -v "^#\|^$" /etc/rsyslog.conf

# 典型配置内容：
*.info;mail.none;authpriv.none;cron.none    /var/log/messages
authpriv.*                                  /var/log/secure  
mail.*                                      -/var/log/maillog
cron.*                                      /var/log/cron
*.emerg                                     :omusrmsg:*
```

**配置规则解释**：
- `*.info`：所有设施的info级别及以上日志
- `mail.none`：排除邮件设施的日志
- `-/var/log/maillog`：异步写入（前面的减号表示异步）
- `:omusrmsg:*`：发送给所有在线用户

### 8.4 默认journald配置


**📝 查看journald配置**
```bash
# 查看journald配置
systemd-analyze cat-config systemd/journald.conf

# 主要默认设置：
[Journal]
Storage=persistent      # 持久化存储
SystemMaxUse=10%       # 最大使用磁盘空间的10%
RuntimeMaxUse=15%      # 最大使用运行时内存的15%  
MaxFileSec=1month      # 单个文件最长保存1个月
```

### 8.5 常用日志查看命令


**🔧 日志查看工具箱**

```bash
# ===== 传统日志文件查看 =====
tail -f /var/log/messages    # 实时查看系统日志
tail -n 100 /var/log/secure  # 查看最新100条安全日志
grep "error" /var/log/messages # 搜索错误信息

# ===== journalctl查看命令 =====  
journalctl -f               # 实时查看journal日志
journalctl -u sshd          # 查看SSH服务日志
journalctl --since "1 hour ago"  # 查看1小时内的日志
journalctl -p err           # 只查看错误级别日志

# ===== 内核日志查看 =====
dmesg                       # 查看内核日志
dmesg -T                    # 带时间戳的内核日志
dmesg | grep -i error       # 查找内核错误信息
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 日志系统架构：rsyslog + systemd-journald 双轨制运行
🔸 syslog协议：标准化的日志格式和传输协议
🔸 日志级别：8个级别从emergency到debug，按重要性排序
🔸 日志设施：按来源分类，如kern、mail、auth、daemon等  
🔸 消息格式：时间戳+主机名+程序名[PID]+消息内容
🔸 缓冲机制：内存缓冲提高性能，持久化保证数据安全
```

### 9.2 关键理解要点


**🔹 双轨制的优势**
```
传统rsyslog：
✅ 人类可读的文本格式
✅ 配置灵活，兼容性好
✅ 网络传输支持完善

现代journald：  
✅ 结构化存储，查询快速
✅ 元数据丰富，过滤精确
✅ 与systemd深度集成
```

**🔹 日志级别的实际意义**
```
运维实践建议：
🚨 0-2级：立即处理，可能影响业务
⚠️  3-4级：需要关注，定期检查处理
📝 5-6级：正常运行信息，了解系统状态
🔍 7级：  调试信息，开发测试时使用
```

**🔹 缓冲区的作用机制**
```
性能优化：批量写入减少磁盘IO
数据安全：重要日志立即同步写入  
资源管理：控制内存和磁盘使用量
```

### 9.3 实际应用指导


**🎯 日常运维场景**
- **故障排查**：先看`/var/log/messages`了解整体，再查具体服务日志
- **安全检查**：重点关注`/var/log/secure`中的登录异常
- **性能监控**：使用`journalctl -f`实时监控系统状态
- **历史分析**：结合`grep`和时间范围查找特定问题

**⚡ 最佳实践建议**
```
✅ 定期查看日志，及时发现问题苗头
✅ 合理配置日志级别，避免信息过载
✅ 设置日志轮转，防止磁盘空间耗尽
✅ 重要系统启用远程日志，避免本地日志丢失
✅ 熟练掌握journalctl和传统日志查看命令
```

**核心记忆要点**：
- 双轨制并行：rsyslog处理文本，journald管理二进制
- 8级4设施：emergency到debug八级别，kern/mail/auth/daemon四大设施  
- 缓冲加持久：内存缓冲提性能，磁盘持久保安全
- /var/log集中：所有日志文件统一存储管理