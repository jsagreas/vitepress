---
title: 7、logrotate日志轮转机制
---
## 📚 目录

1. [日志轮转概述](#1-日志轮转概述)
2. [logrotate核心配置](#2-logrotate核心配置)
3. [轮转策略详解](#3-轮转策略详解)
4. [压缩与保留设置](#4-压缩与保留设置)
5. [脚本执行机制](#5-脚本执行机制)
6. [手动测试与状态管理](#6-手动测试与状态管理)
7. [实际应用案例](#7-实际应用案例)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🗂️ 日志轮转概述


### 1.1 什么是日志轮转


**💡 简单理解**：就像我们定期清理垃圾桶一样，日志轮转是定期清理和归档系统日志的机制。

```
日志文件的生命周期：
产生 → 增长 → 轮转 → 压缩 → 删除

实际例子：
access.log (当前日志)
↓ 轮转
access.log.1 (昨天的日志)
access.log.2.gz (前天的压缩日志)
access.log.3.gz (大前天的压缩日志)
```

### 1.2 为什么需要日志轮转


**🔸 核心问题**
- **磁盘空间**：日志文件会无限增长，最终耗尽磁盘空间
- **性能影响**：超大日志文件影响读写性能
- **管理困难**：单个巨大文件难以分析和处理
- **备份问题**：大文件备份和传输困难

**🎯 轮转带来的好处**
```
空间管理：控制日志占用的磁盘空间
性能优化：保持日志文件在合理大小
便于分析：按时间段组织日志便于查找问题
自动化：无需人工干预的自动管理
```

### 1.3 logrotate工作原理


**📋 基本工作流程**
```
1. 检查配置文件
2. 判断是否满足轮转条件
3. 重命名当前日志文件
4. 创建新的空日志文件
5. 压缩旧日志（如果配置）
6. 删除过期日志
7. 执行后续脚本（如果有）
```

---

## 2. ⚙️ logrotate核心配置


### 2.1 全局配置文件 - /etc/logrotate.conf


**📍 配置文件位置**：`/etc/logrotate.conf`

**🔸 主要作用**：设置系统默认的轮转规则

```bash
# 典型的全局配置内容
weekly              # 默认每周轮转
rotate 4            # 保留4个轮转文件
create              # 轮转后创建新文件
dateext             # 使用日期作为扩展名
compress            # 压缩轮转的文件

# 包含其他配置目录
include /etc/logrotate.d
```

**💭 配置解释**
- `weekly`：告诉系统"每周做一次大扫除"
- `rotate 4`：就像"只保留最近4次的备份"
- `create`：轮转后立即创建新的空日志文件
- `compress`：把旧日志压缩节省空间

### 2.2 独立配置目录 - /etc/logrotate.d/


**📂 目录作用**：存放各个服务的专用轮转配置

**🔸 组织方式**
```
/etc/logrotate.d/
├── apache2          # Apache服务器日志配置
├── mysql-server     # MySQL数据库日志配置
├── nginx            # Nginx服务器日志配置
├── rsyslog          # 系统日志配置
└── custom-app       # 自定义应用日志配置
```

**💡 配置示例 - nginx日志轮转**
```bash
/var/log/nginx/*.log {
    daily              # 每天轮转
    missingok          # 文件不存在也不报错
    rotate 30          # 保留30天
    compress           # 压缩旧日志
    delaycompress      # 延迟压缩（第二次轮转时才压缩）
    notifempty         # 空文件不轮转
    create 0644 www-data www-data  # 创建新文件的权限和所有者
    sharedscripts      # 多个文件共享脚本
    postrotate         # 轮转后执行的脚本
        service nginx reload
    endscript
}
```

### 2.3 配置文件层次关系


**📊 优先级关系**

| 配置来源 | 优先级 | 作用范围 | 说明 |
|---------|--------|----------|------|
| `/etc/logrotate.d/` 中的文件 | **高** | `特定服务` | `覆盖全局设置` |
| `/etc/logrotate.conf` | **低** | `全系统` | `提供默认值` |

**🔄 配置合并规则**
```
实际生效配置 = 全局默认设置 + 服务特定设置
              ↑              ↑
        /etc/logrotate.conf  /etc/logrotate.d/服务名
```

---

## 3. 📅 轮转策略详解


### 3.1 基于时间的轮转策略


**⏰ 时间策略对比**

| 策略 | 关键字 | 轮转频率 | 适用场景 | 示例 |
|------|--------|----------|----------|------|
| **每日** | `daily` | `24小时` | `高流量网站，交易系统` | `Web服务器访问日志` |
| **每周** | `weekly` | `7天` | `中等流量应用` | `应用程序日志` |
| **每月** | `monthly` | `30天` | `低频日志，报告类` | `系统维护日志` |

**💻 配置示例对比**
```bash
# 高频应用 - 每日轮转
/var/log/apache2/access.log {
    daily
    rotate 30    # 保留30天历史
}

# 中频应用 - 每周轮转  
/var/log/app/application.log {
    weekly
    rotate 12    # 保留12周历史
}

# 低频应用 - 每月轮转
/var/log/backup/backup.log {
    monthly  
    rotate 6     # 保留6个月历史
}
```

### 3.2 基于大小的轮转策略


**📏 大小策略配置**
```bash
/var/log/large-app/app.log {
    size 100M           # 文件达到100MB时轮转
    rotate 5            # 保留5个文件
    compress           # 压缩旧文件
}

# 更灵活的配置
/var/log/database/mysql.log {
    size 1G             # 1GB轮转
    daily               # 每天检查一次
    rotate 10
}
```

**🎯 大小单位说明**
- `K` 或 `k`：千字节（1024字节）
- `M` 或 `m`：兆字节（1024K）
- `G` 或 `g`：吉字节（1024M）

### 3.3 混合策略应用


**🔄 时间+大小组合**
```bash
/var/log/hybrid/service.log {
    daily               # 每天检查
    size 50M            # 但如果单天内超过50M也轮转
    rotate 14           # 保留2周
    compress
    notifempty
}
```

**💭 策略选择建议**
- **高I/O服务**：daily + size限制（防止单天内文件过大）
- **稳定服务**：weekly（减少轮转开销）
- **调试期间**：hourly或size很小（便于追踪问题）

---

## 4. 🗜️ 压缩与保留设置


### 4.1 压缩选项详解


**🔸 基础压缩配置**
```bash
compress               # 启用压缩（使用gzip）
nocompress            # 不压缩
delaycompress         # 延迟压缩
nodelaycompress       # 立即压缩
```

**💡 压缩机制图解**
```
立即压缩模式：
轮转时: log → log.1.gz + 新log
下次轮转: log → log.1.gz, log.1.gz → log.2.gz + 新log

延迟压缩模式：
轮转时: log → log.1 + 新log
下次轮转: log → log.1, log.1 → log.2.gz + 新log
```

**🎯 延迟压缩的好处**
- **兼容性**：某些程序可能还在写入刚轮转的文件
- **性能**：避免在服务繁忙时进行压缩操作
- **调试**：最近一次的日志保持未压缩，便于查看

### 4.2 保留份数控制


**📊 rotate参数详解**
```bash
rotate 0              # 不保留旧文件（直接删除）
rotate 7              # 保留7个轮转文件
rotate 365            # 保留365个文件（适合daily+rotate）
```

**📈 存储空间计算**
```
每日100MB日志 + rotate 30:
存储需求 ≈ 30 × 100MB = 3GB（压缩后约1GB）

每周500MB日志 + rotate 12:
存储需求 ≈ 12 × 500MB = 6GB（压缩后约2GB）
```

### 4.3 压缩程序自定义


**🛠️ 自定义压缩工具**
```bash
/var/log/special/app.log {
    compress
    compresscmd /usr/bin/bzip2    # 使用bzip2而非gzip
    compressext .bz2              # 压缩文件扩展名
    compressoptions -9            # 最高压缩率
    uncompresscmd /usr/bin/bunzip2
}
```

**📋 压缩工具对比**

| 工具 | 压缩率 | 压缩速度 | CPU使用 | 适用场景 |
|------|--------|----------|---------|----------|
| **gzip** | `中等` | `快` | `低` | `默认选择，平衡性好` |
| **bzip2** | `高` | `慢` | `高` | `存储空间紧张时` |
| **xz** | `最高` | `最慢` | `最高` | `长期归档存储` |

---

## 5. 📜 脚本执行机制


### 5.1 prerotate脚本


**🔸 执行时机**：在轮转操作开始之前

```bash
/var/log/myapp/app.log {
    daily
    rotate 7
    prerotate
        # 通知应用准备轮转
        echo "Preparing log rotation" | logger
        # 可以在这里停止应用或切换到只读模式
    endscript
}
```

**🎯 典型用途**
- **应用通知**：通知应用程序即将轮转日志
- **数据一致性**：确保当前日志写入完成
- **权限检查**：验证轮转权限

### 5.2 postrotate脚本


**🔸 执行时机**：轮转操作完成之后

```bash
/var/log/nginx/*.log {
    daily
    rotate 30
    compress
    delaycompress
    sharedscripts          # 重要：多个文件共享一个脚本
    postrotate
        # 重新加载nginx配置，让其重新打开日志文件
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}
```

**💭 脚本执行原理**
```
没有sharedscripts：
对每个日志文件都执行一次脚本
access.log → 执行脚本
error.log → 执行脚本  (重复重载服务)

有sharedscripts：
所有文件轮转完后只执行一次脚本
access.log + error.log → 执行一次脚本
```

### 5.3 常见脚本案例


**🔄 Web服务器日志轮转**
```bash
/var/log/apache2/*.log {
    weekly
    rotate 52
    compress
    delaycompress
    missingok
    notifempty
    sharedscripts
    postrotate
        # Apache优雅重启
        systemctl reload apache2
    endscript
}
```

**🗃️ 数据库日志轮转**
```bash
/var/log/mysql/mysql.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    postrotate
        # MySQL刷新日志
        mysqladmin flush-logs
    endscript
}
```

---

## 6. 🔧 手动测试与状态管理


### 6.1 手动执行轮转测试


**🧪 测试命令**
```bash
# 测试模式 - 只显示会做什么，不实际执行
logrotate -d /etc/logrotate.conf

# 强制执行轮转（忽略时间条件）
logrotate -f /etc/logrotate.conf

# 测试特定配置文件
logrotate -d /etc/logrotate.d/nginx

# 详细输出模式
logrotate -v /etc/logrotate.conf
```

**📝 测试输出解读**
```bash
# 执行 logrotate -d /etc/logrotate.conf 的输出示例
reading config file /etc/logrotate.conf
including /etc/logrotate.d
reading config file nginx
considering log /var/log/nginx/access.log
  log does not need rotating
considering log /var/log/nginx/error.log  
  log does not need rotating
```

### 6.2 轮转状态文件


**📍 状态文件位置**：`/var/lib/logrotate/logrotate.status`

**🔸 状态文件内容**
```bash
# 查看状态文件
cat /var/lib/logrotate/logrotate.status

# 典型内容
"/var/log/nginx/access.log" 2025-1-19-10:0:0
"/var/log/nginx/error.log" 2025-1-19-10:0:0
"/var/log/apache2/access.log" 2025-1-18-0:0:0
```

**💡 状态信息含义**
- **文件路径**：被轮转的日志文件完整路径
- **时间戳**：上次轮转的时间
- **作用**：logrotate根据这个时间判断是否需要再次轮转

### 6.3 调试常见问题


**🐛 权限问题调试**
```bash
# 检查logrotate权限
ls -la /usr/sbin/logrotate

# 检查日志文件权限  
ls -la /var/log/nginx/

# 检查配置文件权限
ls -la /etc/logrotate.d/nginx
```

**🔍 轮转失败排查**
```bash
# 查看系统日志中的logrotate错误
grep logrotate /var/log/syslog

# 手动调试特定配置
logrotate -d -v /etc/logrotate.d/nginx

# 强制执行看错误信息
logrotate -f -v /etc/logrotate.d/nginx
```

---

## 7. 🎯 实际应用案例


### 7.1 Web服务器日志管理


**📋 场景**：高流量网站的访问日志管理

```bash
/var/log/nginx/access.log {
    daily                    # 每天轮转
    rotate 30               # 保留30天
    compress                # 压缩节省空间
    delaycompress          # 延迟压缩
    missingok              # 文件丢失不报错
    notifempty             # 空文件不轮转
    create 644 nginx nginx # 新文件权限和所有者
    sharedscripts
    postrotate
        # 发送USR1信号让nginx重新打开日志文件
        kill -USR1 $(cat /var/run/nginx.pid 2>/dev/null) 2>/dev/null || true
    endscript
}
```

### 7.2 应用程序日志管理


**📋 场景**：Java应用的滚动日志管理

```bash
/var/log/myapp/*.log {
    size 100M               # 大小轮转
    daily                   # 每天检查
    rotate 10               # 保留10个文件
    compress
    delaycompress
    missingok
    notifempty
    copytruncate           # 复制后截断（适合一直打开文件句柄的应用）
}
```

**💭 copytruncate说明**
```
普通轮转：重命名文件，应用需要重新打开
copytruncate轮转：复制内容后清空原文件，应用无需重新打开

适用场景：
- Java应用保持文件句柄打开
- 无法通过信号重新打开日志文件的程序
```

### 7.3 系统日志管理


**📋 场景**：系统核心日志的精细化管理

```bash
# /etc/logrotate.d/rsyslog
/var/log/syslog {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    postrotate
        systemctl reload rsyslog
    endscript
}

/var/log/auth.log {
    weekly
    rotate 12           # 安全日志保留更久
    compress
    delaycompress
    missingok
    notifempty
    postrotate
        systemctl reload rsyslog  
    endscript
}
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基础概念


```
🔸 日志轮转本质：定期归档和清理日志文件的自动化机制
🔸 配置层次：全局配置(/etc/logrotate.conf) + 服务配置(/etc/logrotate.d/)
🔸 轮转策略：时间策略(daily/weekly/monthly) + 大小策略(size)
🔸 压缩机制：compress压缩 + delaycompress延迟压缩
🔸 脚本执行：prerotate前置脚本 + postrotate后置脚本
🔸 状态管理：/var/lib/logrotate/logrotate.status记录轮转状态
```

### 8.2 关键配置参数理解


**⚡ 高频使用参数**

| 参数 | 作用 | 使用建议 |
|------|------|----------|
| `rotate N` | `保留N个历史文件` | `根据磁盘空间和需求平衡` |
| `compress` | `压缩旧文件节省空间` | `几乎总是启用` |
| `delaycompress` | `延迟到下次轮转时压缩` | `与应用兼容性考虑` |
| `missingok` | `文件不存在不报错` | `提高脚本健壮性` |
| `notifempty` | `空文件不轮转` | `避免无意义的轮转` |
| `sharedscripts` | `多文件共享脚本` | `避免重复执行重载命令` |

### 8.3 实践要点


**🔹 配置设计原则**
```
时间策略选择：
- 高频服务：daily（Web服务器、数据库）
- 中频服务：weekly（应用日志）  
- 低频服务：monthly（系统维护日志）

大小控制：
- 防止单个文件过大影响性能
- 一般设置100M-1G作为大小上限

保留策略：
- 日志重要性 × 法规要求 × 磁盘空间 = 保留时长
- 调试日志：7-30天
- 访问日志：30-90天
- 安全日志：6个月-1年
```

**🔹 故障预防**
```
权限配置：
- create参数正确设置文件权限和所有者
- logrotate进程有足够权限操作文件

服务兼容：
- 正确配置postrotate脚本重载服务
- 使用sharedscripts避免重复重载
- copytruncate适配不支持重新打开文件的应用

监控检查：
- 定期检查/var/lib/logrotate/logrotate.status
- 监控磁盘空间使用情况
- 检查系统日志中的logrotate错误
```

**🎯 核心记忆要点**
- logrotate是Linux日志管理的标准工具
- 配置分全局和服务两层，服务配置优先级更高
- 轮转策略要结合时间和大小双重考虑  
- 压缩和保留策略平衡存储效率和访问需求
- postrotate脚本是通知服务重新打开日志的关键
- 手动测试和状态文件是调试轮转问题的重要工具