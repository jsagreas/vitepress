---
title: 2、rsyslog配置与管理
---
## 📚 目录

1. [rsyslog系统概述](#1-rsyslog系统概述)
2. [主配置文件详解](#2-主配置文件详解)
3. [模块化配置管理](#3-模块化配置管理)
4. [选择器语法深入](#4-选择器语法深入)
5. [动作配置实战](#5-动作配置实战)
6. [模板定义与格式化](#6-模板定义与格式化)
7. [过滤规则与条件表达式](#7-过滤规则与条件表达式)
8. [服务管理与维护](#8-服务管理与维护)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 📋 rsyslog系统概述


### 1.1 什么是rsyslog


🔰 **入门理解**：rsyslog是Linux系统中负责**收集、处理和存储日志**的核心服务

**🌰 生活类比**：就像一个智能的**信件分拣中心**
- 各个程序产生的日志信息就像不同的信件
- rsyslog根据信件的类型和重要程度进行分类
- 然后把这些信件送到对应的"信箱"里保存

### 1.2 rsyslog的核心作用


```
程序A ──┐
        ├──▶ rsyslog ──▶ 分类处理 ──▶ 存储到不同文件
程序B ──┤    (日志中心)     │
程序C ──┘                  ├──▶ /var/log/messages
                          ├──▶ /var/log/secure  
                          └──▶ /var/log/cron
```

**🔸 主要功能**：
- **收集日志**：从各种程序和系统组件收集日志
- **分类存储**：根据日志类型和级别分别保存
- **格式化输出**：将日志格式化成易读的形式
- **远程传输**：可以将日志发送到其他服务器

### 1.3 为什么需要rsyslog


⏱️ **预计学习时间**：5分钟  
🎯 **学习目标**：理解rsyslog存在的必要性

**🔸 解决的问题**：
- **统一管理**：不让每个程序都自己管理日志文件
- **避免混乱**：防止日志文件到处乱放
- **便于维护**：集中配置，统一处理
- **提高效率**：专业的日志处理，性能更好

---

## 2. 🔧 主配置文件详解


### 2.1 /etc/rsyslog.conf文件结构


**📍 文件位置**：`/etc/rsyslog.conf`

**🔸 文件作用**：这是rsyslog的**主要配置文件**，决定了日志如何被处理

```
/etc/rsyslog.conf 文件结构：

┌─────────────────────┐
│  全局配置指令        │ ← 影响整个rsyslog行为
├─────────────────────┤  
│  模块加载           │ ← 加载需要的功能模块
├─────────────────────┤
│  规则配置           │ ← 核心部分：日志处理规则
│  (选择器 + 动作)    │
└─────────────────────┘
```

### 2.2 全局配置指令


**🔸 常见全局配置**：

```bash
# 设置文件创建时的权限掩码
$umask 0000

# 设置工作目录
$WorkDirectory /var/spool/rsyslog

# 包含其他配置文件
$IncludeConfig /etc/rsyslog.d/*.conf
```

**💡 通俗解释**：
- `$umask`：就像设置新建文件的"默认权限"
- `$WorkDirectory`：告诉rsyslog把临时文件放在哪里
- `$IncludeConfig`：告诉rsyslog还要读取哪些配置文件

### 2.3 模块加载配置


**🔸 模块的概念**：模块就像**功能插件**，需要什么功能就加载什么模块

```bash
# 加载输入模块（接收日志）
module(load="imjournal")      # 从systemd journal读取
module(load="imuxsock")       # 从Unix socket读取

# 加载输出模块（输出日志）  
module(load="omfile")         # 输出到文件
module(load="omfwd")          # 转发到远程服务器
```

**🌰 类比理解**：
- 就像手机需要安装不同的APP来实现不同功能
- rsyslog需要加载不同模块来处理不同类型的日志

### 2.4 配置文件查看实例


```bash
# 查看主配置文件
cat /etc/rsyslog.conf

# 检查配置文件语法
rsyslogd -N1 -f /etc/rsyslog.conf
```

**🔍 实际操作**：
```bash
# 备份原配置文件（重要！）
sudo cp /etc/rsyslog.conf /etc/rsyslog.conf.backup

# 编辑配置文件
sudo vim /etc/rsyslog.conf
```

---

## 3. 📁 模块化配置管理


### 3.1 /etc/rsyslog.d/目录的作用


**🔸 模块化思想**：不把所有配置都写在一个文件里，而是**分门别类**地管理

```
/etc/rsyslog.d/ 目录结构：
├── 00-global.conf        ← 全局设置
├── 20-ufw.conf          ← 防火墙日志配置
├── 50-default.conf      ← 默认日志规则
└── 99-custom.conf       ← 自定义配置
```

**💡 命名规则**：
- 数字前缀决定加载顺序（00最先，99最后）
- 描述性的文件名便于管理

### 3.2 模块化配置的优势


| 优势 | **传统方式** | **模块化方式** | **实际好处** |
|------|------------|--------------|-------------|
| 🔧 **维护性** | `单一大文件` | `多个小文件` | `修改某个功能不影响其他` |
| 🎯 **可读性** | `混杂在一起` | `功能分离` | `一眼就能找到相关配置` |
| 🚀 **扩展性** | `修改主文件` | `新增配置文件` | `安装软件时可自动添加配置` |

### 3.3 创建自定义配置文件


**🔸 实践操作**：
```bash
# 创建自定义配置文件
sudo vim /etc/rsyslog.d/99-myapp.conf
```

**示例配置内容**：
```bash
# 自定义应用日志配置
# 将myapp程序的日志单独保存
:programname, isequal, "myapp" /var/log/myapp.log
& stop
```

**🧠 记忆技巧**：`& stop`表示"处理完就停止"，不再继续后续规则

---

## 4. ⚙️ 选择器语法深入


### 4.1 选择器的基本概念


**🔸 什么是选择器**：选择器就像**筛子**，决定哪些日志要被处理

**语法格式**：`facility.priority`

```
选择器结构：
┌──────────┬──────────┐
│ facility │ priority │
│  (设施)   │  (级别)   │
└──────────┴──────────┘
    ↓          ↓
  谁产生的    有多重要
```

### 4.2 Facility（设施）详解


**🔸 facility的含义**：表示**日志来源**，即哪个程序或系统组件产生的日志

| Facility | **含义** | **典型用途** | **生活类比** |
|----------|---------|-------------|-------------|
| `kern` | `内核消息` | `系统内核产生的日志` | `汽车引擎的状态信息` |
| `mail` | `邮件系统` | `邮件服务器的日志` | `邮局的业务记录` |
| `auth` | `认证系统` | `用户登录、权限验证` | `门禁系统的刷卡记录` |
| `cron` | `定时任务` | `计划任务执行情况` | `闹钟的响铃记录` |
| `local0-7` | `自定义` | `用户自定义程序` | `自己的私人日记本` |

**💡 通俗理解**：facility就是在日志上贴个"标签"，标明这条日志是从哪里来的

### 4.3 Priority（优先级）详解


**🔸 priority的含义**：表示**日志的重要程度**，类似于"紧急程度"

```
优先级从高到低：
🔴 emerg    (0) ← 系统无法使用（最严重）
🔴 alert    (1) ← 必须立即采取行动  
🔴 crit     (2) ← 严重错误
🟡 err      (3) ← 一般错误
🟡 warning  (4) ← 警告信息
🔵 notice   (5) ← 重要的普通信息
🔵 info     (6) ← 一般信息
⚪ debug    (7) ← 调试信息（最详细）
```

**🌰 生活类比**：
- `emerg`：火警！整栋楼立即疏散
- `crit`：电梯故障，需要立即维修
- `err`：水管漏水，尽快处理
- `warning`：门锁有点松，注意一下
- `info`：今天来了几个访客
- `debug`：记录每个人进出的详细时间

### 4.4 选择器语法组合


**🔸 基本语法**：
```bash
# 精确匹配
mail.info           # 邮件系统的info级别日志

# 级别范围（该级别及以上）
mail.warning        # 邮件系统warning级别及以上的日志

# 多个facility
mail,cron.info      # 邮件和定时任务的info级别日志

# 排除语法
*.info;mail.none    # 所有info级别日志，但排除邮件日志
```

**🧠 记忆要点**：
- 逗号`,`表示"或者"（多个facility）
- 分号`;`表示"并且"（多个条件）
- `.none`表示"排除"

---

## 5. 🎯 动作配置实战


### 5.1 动作的基本概念


**🔸 什么是动作**：选择器决定了"哪些日志"，动作决定了"怎么处理这些日志"

```
完整的日志规则：
选择器        动作
   ↓           ↓
mail.info    /var/log/maillog
 (什么日志)    (存到哪里)
```

### 5.2 文件输出动作


**🔸 最常用的动作**：将日志保存到文件

```bash
# 基本文件输出
mail.info    /var/log/maillog

# 同步写入（立即写入磁盘，更安全但慢）
mail.crit    -/var/log/mail.crit

# 动态文件名（根据时间或主机名等）
*.info       /var/log/messages-%$YEAR%-%$MONTH%
```

**💡 符号说明**：
- 普通路径：异步写入（更快，但可能丢数据）
- 前面加`-`：同步写入（更安全，但较慢）

### 5.3 远程传输动作


**🔸 将日志发送到远程服务器**：

```bash
# TCP传输（可靠但慢）
*.emerg      $$logserver.example.com:514

# UDP传输（快但可能丢包）  
*.info       @logserver.example.com:514
```

**🔸 符号含义**：
- `$$`：TCP协议传输
- `@`：UDP协议传输

### 5.4 程序输出动作


**🔸 将日志发送给程序处理**：

```bash
# 发送给指定程序
*.emerg      |/usr/local/bin/emergency_handler.sh

# 发送邮件通知
*.crit       ^root
```

### 5.5 丢弃动作


**🔸 有时候需要"忽略"某些日志**：

```bash
# 丢弃垃圾日志
:msg, contains, "Connection reset"    stop
& ~

# 新语法（推荐）
:msg, contains, "Connection reset"    /dev/null
& stop
```

**🧠 理解要点**：`stop`表示"到此为止"，不再执行后续规则

---

## 6. 🎨 模板定义与格式化


### 6.1 模板的作用


**🔸 模板的概念**：模板就像**日志的格式化工具**，决定日志最终长什么样

**默认格式 vs 自定义格式**：
```bash
# 默认格式
Dec 13 10:30:45 server1 sshd[1234]: Accepted password for user

# 自定义格式
2024-12-13 10:30:45 [INFO] server1 sshd[1234]: Accepted password for user
```

### 6.2 定义自定义模板


**🔸 模板定义语法**：

```bash
# 定义模板
template(name="MyFormat" type="string" 
         string="%TIMESTAMP% [%syslogseverity-text%] %HOSTNAME% %programname%: %msg%\n")

# 使用模板
*.info    /var/log/messages;MyFormat
```

**💡 常用变量**：
- `%TIMESTAMP%`：时间戳
- `%HOSTNAME%`：主机名
- `%programname%`：程序名
- `%msg%`：日志消息内容
- `%syslogseverity-text%`：级别名称（如INFO、ERROR）

### 6.3 实用模板示例


**🔸 JSON格式模板**：
```bash
template(name="JsonFormat" type="string"
         string="{ \"time\":\"%TIMESTAMP:::date-rfc3339%\", \"host\":\"%HOSTNAME%\", \"program\":\"%programname%\", \"message\":\"%msg%\" }\n")
```

**🔸 详细格式模板**：
```bash
template(name="DetailedFormat" type="string"
         string="[%TIMESTAMP%] %HOSTNAME% %syslogseverity-text%/%programname%[%procid%]: %msg%\n")
```

---

## 7. 🔍 过滤规则与条件表达式


### 7.1 基于内容的过滤


**🔸 过滤的概念**：不仅可以根据facility和priority选择日志，还可以根据**日志内容**进行筛选

### 7.2 常用过滤语法


**🔸 包含过滤**：
```bash
# 包含特定字符串
:msg, contains, "error"         /var/log/errors.log

# 正则表达式匹配
:msg, regex, "user [a-zA-Z]+ login"    /var/log/logins.log

# 完全匹配
:programname, isequal, "sshd"   /var/log/ssh.log
```

**🔸 排除过滤**：
```bash
# 排除包含特定内容的日志
:msg, !contains, "Connection reset"    /var/log/filtered.log
```

### 7.3 复合条件表达式


**🔸 组合条件**：
```bash
# AND条件（同时满足）
if ($programname == "sshd" and $msg contains "Failed") then {
    /var/log/ssh_failures.log
    stop
}

# OR条件（满足其一）
if ($syslogseverity <= 3 or $programname == "kernel") then {
    /var/log/critical.log
}
```

---

## 8. 🔧 服务管理与维护


### 8.1 rsyslog服务控制


**🔸 基本服务操作**：

```bash
# 启动服务
sudo systemctl start rsyslog

# 停止服务
sudo systemctl stop rsyslog

# 重启服务（完全重启）
sudo systemctl restart rsyslog

# 重新加载配置（推荐）
sudo systemctl reload rsyslog

# 查看服务状态
sudo systemctl status rsyslog

# 设置开机自启
sudo systemctl enable rsyslog
```

**💡 reload vs restart**：
- `reload`：只重新读取配置，不中断日志处理
- `restart`：完全重启服务，会短暂中断日志收集

### 8.2 配置语法检查


⚠️ **重要提醒**：修改配置前必须检查语法！

```bash
# 检查主配置文件语法
sudo rsyslogd -N1 -f /etc/rsyslog.conf

# 检查所有配置文件
sudo rsyslogd -N1

# 详细检查（显示更多信息）
sudo rsyslogd -N3 -f /etc/rsyslog.conf
```

**🔸 检查结果解读**：
```bash
# 正常输出
rsyslogd: version X.XX.X, config validation run (level 1), master config /etc/rsyslog.conf
rsyslogd: End of config validation run. Bye.

# 有错误的输出
rsyslogd: CONFIG ERROR: line 23: syntax error near 'invalid_directive'
```

### 8.3 常见错误排查


**🔸 配置错误排查步骤**：

```
1. 检查语法
   ↓
2. 查看系统日志
   ↓  
3. 测试配置
   ↓
4. 逐步恢复
```

**🔍 实用排查命令**：

```bash
# 查看rsyslog相关的系统日志
sudo journalctl -u rsyslog -n 20

# 实时查看日志
sudo journalctl -u rsyslog -f

# 测试日志生成
logger -t test "This is a test message"

# 检查日志文件是否生成
tail -f /var/log/messages
```

### 8.4 性能监控与优化


**🔸 监控rsyslog性能**：

```bash
# 查看rsyslog进程状态
ps aux | grep rsyslog

# 查看日志文件增长情况
du -sh /var/log/*

# 监控日志文件实时变化
watch "ls -lah /var/log/"
```

**📈 性能优化建议**：

| 场景 | **问题** | **优化方案** | **效果** |
|------|---------|-------------|---------|
| 🔸 **高并发日志** | `写入性能差` | `使用异步写入模式` | `提升吞吐量` |
| 🔸 **磁盘空间** | `日志文件过大` | `配置日志轮转` | `节省存储空间` |
| 🔸 **网络传输** | `远程传输慢` | `使用TCP + 压缩` | `提高可靠性` |

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 rsyslog作用：统一的日志收集、分类、存储系统
🔸 配置文件：主配置/etc/rsyslog.conf + 模块化/etc/rsyslog.d/
🔸 选择器语法：facility.priority决定处理哪些日志
🔸 动作配置：文件存储、远程传输、程序处理、丢弃
🔸 服务管理：启停、重载、语法检查、错误排查
```

### 9.2 实用操作清单


**📋 日常维护检查清单**：
- [x] 配置修改前备份原文件
- [x] 修改后执行语法检查
- [x] 使用reload而不是restart加载配置
- [x] 定期检查日志文件大小
- [x] 监控rsyslog服务状态

### 9.3 常用配置模式


**🔸 典型配置示例**：
```bash
# 1. 基本日志分类
*.info;mail.none;authpriv.none;cron.none    /var/log/messages
authpriv.*                                  /var/log/secure
mail.*                                      /var/log/maillog
cron.*                                      /var/log/cron

# 2. 应用程序日志分离
:programname, isequal, "myapp"              /var/log/myapp.log
& stop

# 3. 紧急日志邮件通知
*.emerg                                     ^root

# 4. 远程日志备份
*.info                                      @logserver.example.com:514
```

### 9.4 故障排查思路


```
配置问题排查流程：

语法检查 ──▶ 服务状态 ──▶ 权限检查 ──▶ 测试验证
    │           │           │           │
    ▼           ▼           ▼           ▼
rsyslogd -N1   systemctl   ls -l       logger命令
```

**🧠 记忆口诀**：
- 配置改完先检查，语法错误要修正
- 重载配置别重启，服务不断日志清
- 权限路径都要对，测试验证才放心

**🎯 学习重点**：
- **理解概念**：facility和priority的区别和作用
- **掌握语法**：选择器和动作的正确写法  
- **实践操作**：配置修改、语法检查、服务管理
- **问题排查**：能够独立解决常见配置问题

通过掌握rsyslog配置与管理，你就能够有效地控制Linux系统的日志行为，让日志系统为系统监控和故障排查提供强有力的支持！