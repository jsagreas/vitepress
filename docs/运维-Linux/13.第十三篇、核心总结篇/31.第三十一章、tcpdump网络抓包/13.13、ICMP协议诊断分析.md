---
title: 13ã€ICMPåè®®è¯Šæ–­åˆ†æž
---
## ðŸ“š ç›®å½•

1. [ICMPåè®®åŸºç¡€æ¦‚å¿µ](#1-ICMPåè®®åŸºç¡€æ¦‚å¿µ)
2. [ICMPæ¶ˆæ¯ç±»åž‹è¯†åˆ«](#2-ICMPæ¶ˆæ¯ç±»åž‹è¯†åˆ«)
3. [pingå‘½ä»¤æ•°æ®åŒ…åˆ†æž](#3-pingå‘½ä»¤æ•°æ®åŒ…åˆ†æž)
4. [tracerouteè·¯å¾„è·Ÿè¸ª](#4-tracerouteè·¯å¾„è·Ÿè¸ª)
5. [ç½‘ç»œé”™è¯¯è¯Šæ–­](#5-ç½‘ç»œé”™è¯¯è¯Šæ–­)
6. [å®žæˆ˜æ¡ˆä¾‹åˆ†æž](#6-å®žæˆ˜æ¡ˆä¾‹åˆ†æž)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸŒ ICMPåè®®åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ICMPåè®®


**ICMP (Internet Control Message Protocol)** æ˜¯äº’è”ç½‘æŽ§åˆ¶æ¶ˆæ¯åè®®ï¼Œè¯´ç™½äº†å°±æ˜¯ç½‘ç»œè®¾å¤‡ä¹‹é—´ç”¨æ¥**äº’ç›¸æŠ¥å‘Šæƒ…å†µ**çš„"é€šè®¯å‘˜"ã€‚

```
ç®€å•ç†è§£ï¼š
ç½‘ç»œå°±åƒä¸€ä¸ªå¤§åž‹å¿«é€’ç³»ç»Ÿ
IPåè®®è´Ÿè´£é€åŒ…è£¹
ICMPåè®®è´Ÿè´£æŠ¥å‘Š"åŒ…è£¹é€åˆ°äº†å—ï¼Ÿè·¯ä¸Šé‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼Ÿ"
```

**ðŸ”¸ ICMPçš„æ ¸å¿ƒä½œç”¨**
- **é”™è¯¯æŠ¥å‘Š** - å‘Šè¯‰ä½ æ•°æ®åŒ…å“ªé‡Œå‡ºé—®é¢˜äº†
- **ç½‘ç»œè¯Šæ–­** - æµ‹è¯•ç½‘ç»œæ˜¯å¦é€šç•…
- **è·¯å¾„å‘çŽ°** - æ‰¾å‡ºæ•°æ®åŒ…èµ°äº†ä»€ä¹ˆè·¯çº¿
- **æµé‡æŽ§åˆ¶** - æé†’å‘é€æ–¹æ…¢ä¸€ç‚¹

### 1.2 ICMPåœ¨ç½‘ç»œåè®®æ ˆä¸­çš„ä½ç½®


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨å±‚        â”‚ â† pingã€tracerouteç­‰å·¥å…·
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä¼ è¾“å±‚        â”‚ â† TCP/UDP
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç½‘ç»œå±‚        â”‚ â† IPåè®® + ICMPåè®®ï¼ˆåŒå±‚åä½œï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®é“¾è·¯å±‚    â”‚ â† ä»¥å¤ªç½‘å¸§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ðŸ’¡ **é‡è¦ç†è§£**ï¼šICMPè™½ç„¶ä¾èµ–IPåè®®ä¼ è¾“ï¼Œä½†å®ƒæ˜¯IPåè®®çš„"åŠ©æ‰‹"ï¼Œä¸“é—¨å¤„ç†ç½‘ç»œå±‚çš„æŽ§åˆ¶å’Œé”™è¯¯æ¶ˆæ¯ã€‚

### 1.3 ICMPæ•°æ®åŒ…ç»“æž„


```
ICMPæ•°æ®åŒ…åŸºæœ¬æ ¼å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Type   â”‚   Code   â”‚ Checksum â”‚    Data    â”‚
â”‚  (8ä½)   â”‚  (8ä½)   â”‚  (16ä½)  â”‚  (å¯å˜é•¿)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Type: æ¶ˆæ¯ç±»åž‹ï¼ˆå¦‚pingè¯·æ±‚æ˜¯8ï¼Œå›žå¤æ˜¯0ï¼‰
Code: å…·ä½“çš„é”™è¯¯ä»£ç æˆ–å­ç±»åž‹
Checksum: æ ¡éªŒå’Œï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§
Data: å…·ä½“çš„æ¶ˆæ¯å†…å®¹
```

---

## 2. ðŸ·ï¸ ICMPæ¶ˆæ¯ç±»åž‹è¯†åˆ«


### 2.1 æ ¸å¿ƒæ¶ˆæ¯ç±»åž‹è¡¨


| Type | Code | **æ¶ˆæ¯åç§°** | **ç”¨é€”è¯´æ˜Ž** | **å¸¸è§åœºæ™¯** |
|------|------|-------------|-------------|-------------|
| 0 | 0 | `Echo Reply` | pingå›žå¤æ¶ˆæ¯ | ç›®æ ‡ä¸»æœºå›žåº”ping |
| 3 | 0-15 | `Destination Unreachable` | ç›®æ ‡ä¸å¯è¾¾ | ç½‘ç»œ/ä¸»æœº/ç«¯å£æ— æ³•è®¿é—® |
| 5 | 0-3 | `Redirect` | é‡å®šå‘æ¶ˆæ¯ | è·¯ç”±å™¨å»ºè®®æ›´å¥½çš„è·¯å¾„ |
| 8 | 0 | `Echo Request` | pingè¯·æ±‚æ¶ˆæ¯ | å‘èµ·pingæµ‹è¯• |
| 11 | 0-1 | `Time Exceeded` | è¶…æ—¶æ¶ˆæ¯ | TTLè¿‡æœŸæˆ–åˆ†ç‰‡è¶…æ—¶ |
| 12 | 0-2 | `Parameter Problem` | å‚æ•°é”™è¯¯ | IPå¤´éƒ¨å­—æ®µé”™è¯¯ |

### 2.2 å¸¸è§Type 3è¯¦ç»†åˆ†ç±»


**ç›®æ ‡ä¸å¯è¾¾æ¶ˆæ¯è¯¦è§£**ï¼š

```
Code 0: ç½‘ç»œä¸å¯è¾¾      â†’ è·¯ç”±å™¨æ‰¾ä¸åˆ°åˆ°è¾¾ç›®æ ‡ç½‘ç»œçš„è·¯å¾„
Code 1: ä¸»æœºä¸å¯è¾¾      â†’ èƒ½åˆ°è¾¾ç½‘ç»œï¼Œä½†ä¸»æœºä¸åœ¨çº¿
Code 2: åè®®ä¸å¯è¾¾      â†’ ä¸»æœºä¸æ”¯æŒè¯¥åè®®
Code 3: ç«¯å£ä¸å¯è¾¾      â†’ ä¸»æœºæ²¡æœ‰ç›‘å¬è¯¥ç«¯å£çš„ç¨‹åº
Code 4: éœ€è¦åˆ†ç‰‡ä½†è®¾ç½®äº†DF â†’ æ•°æ®åŒ…å¤ªå¤§ä¸”ç¦æ­¢åˆ†ç‰‡
Code 9: ç½‘ç»œè¢«ç®¡ç†ç¦æ­¢   â†’ é˜²ç«å¢™æˆ–è·¯ç”±ç­–ç•¥é˜»æ­¢
Code 10: ä¸»æœºè¢«ç®¡ç†ç¦æ­¢  â†’ ç›®æ ‡ä¸»æœºé˜²ç«å¢™é˜»æ­¢
```

ðŸ’¡ **å®žç”¨æŠ€å·§**ï¼šé€šè¿‡tcpdumpçœ‹åˆ°Type 3æ¶ˆæ¯æ—¶ï¼Œé‡ç‚¹å…³æ³¨Codeå€¼ï¼Œå®ƒèƒ½ç²¾ç¡®å‘Šè¯‰ä½ é—®é¢˜åœ¨å“ªé‡Œã€‚

### 2.3 tcpdumpä¸­çš„ICMPæ˜¾ç¤º


```bash
# æŠ“å–ICMPæ•°æ®åŒ…çš„åŸºæœ¬å‘½ä»¤
tcpdump -i eth0 icmp -v

# è¾“å‡ºç¤ºä¾‹è§£è¯»ï¼š
10:30:15.123456 IP 192.168.1.100 > 8.8.8.8: ICMP echo request, id 12345, seq 1, length 64
10:30:15.145678 IP 8.8.8.8 > 192.168.1.100: ICMP echo reply, id 12345, seq 1, length 64
```

**è¾“å‡ºå­—æ®µå«ä¹‰**ï¼š
- `echo request/reply` - ICMPæ¶ˆæ¯ç±»åž‹
- `id 12345` - è¿›ç¨‹IDï¼Œç”¨äºŽåŒ¹é…è¯·æ±‚å’Œå›žå¤
- `seq 1` - åºåˆ—å·ï¼Œpingå‘½ä»¤çš„ç¬¬å‡ ä¸ªåŒ…
- `length 64` - ICMPæ•°æ®éƒ¨åˆ†é•¿åº¦

---

## 3. ðŸ“ pingå‘½ä»¤æ•°æ®åŒ…åˆ†æž


### 3.1 pingå‘½ä»¤å·¥ä½œåŽŸç†


```
pingå·¥ä½œæµç¨‹ï¼š
æœ¬åœ°ä¸»æœº                        ç›®æ ‡ä¸»æœº
    |                              |
    |â”€â”€[ICMP Echo Request]â”€â”€â”€â”€â”€â”€â”€â”€>|
    |  Type=8, Code=0              |
    |                              |
    |<â”€[ICMP Echo Reply]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€|
    |  Type=0, Code=0              |

å…³é”®ç†è§£ï¼š
pingä¸ä½¿ç”¨TCPæˆ–UDPï¼Œç›´æŽ¥ä½¿ç”¨ICMPåè®®
æ¯æ¬¡pingéƒ½æœ‰å”¯ä¸€çš„IDå’Œåºåˆ—å·
```

### 3.2 å®žæˆ˜æŠ“åŒ…åˆ†æž


```bash
# å¼€å¯æŠ“åŒ…
tcpdump -i any icmp -v -n

# å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œping
ping -c 3 8.8.8.8

# tcpdumpè¾“å‡ºåˆ†æžï¼š
```

**å…¸åž‹è¾“å‡ºè§£è¯»**ï¼š

```
â­ è¯·æ±‚åŒ…åˆ†æžï¼š
11:25:30.123456 IP 192.168.1.100 > 8.8.8.8: ICMP echo request, id 8776, seq 1, length 64

è¯¦ç»†å«ä¹‰ï¼š
- æ—¶é—´æˆ³: 11:25:30.123456
- æ–¹å‘: 192.168.1.100 â†’ 8.8.8.8
- ç±»åž‹: echo request (Type=8)
- è¿›ç¨‹ID: 8776 (ç”¨äºŽåŒºåˆ†ä¸åŒpingè¿›ç¨‹)
- åºåˆ—: seq 1 (ç¬¬1ä¸ªpingåŒ…)
- é•¿åº¦: 64å­—èŠ‚æ•°æ®
```

```
â­ å›žå¤åŒ…åˆ†æžï¼š
11:25:30.145123 IP 8.8.8.8 > 192.168.1.100: ICMP echo reply, id 8776, seq 1, length 64

å…³é”®ä¿¡æ¯ï¼š
- RTTè®¡ç®—: 145123 - 123456 = 21.667ms
- IDåŒ¹é…: 8776 (ä¸Žè¯·æ±‚åŒ…ç›¸åŒ)
- åºåˆ—åŒ¹é…: seq 1 (ç¡®è®¤æ˜¯ç¬¬1ä¸ªåŒ…çš„å›žå¤)
```

### 3.3 pingå¼‚å¸¸æƒ…å†µåˆ†æž


**ðŸš¨ æƒ…å†µ1ï¼šç›®æ ‡ä¸»æœºä¸å¯è¾¾**

```bash
# pingä¸€ä¸ªä¸å­˜åœ¨çš„ä¸»æœº
ping 192.168.1.254

# tcpdumpä¼šçœ‹åˆ°ï¼š
11:30:15.123456 IP 192.168.1.100 > 192.168.1.254: ICMP echo request, id 9001, seq 1
11:30:15.124567 IP 192.168.1.1 > 192.168.1.100: ICMP 192.168.1.254 unreachable - admin prohibited

è§£è¯»ï¼š
- è·¯ç”±å™¨(192.168.1.1)å›žå¤äº†"ç›®æ ‡ä¸å¯è¾¾"æ¶ˆæ¯
- "admin prohibited"è¡¨ç¤ºè¢«ç®¡ç†ç­–ç•¥é˜»æ­¢
```

**ðŸš¨ æƒ…å†µ2ï¼šç½‘ç»œè¶…æ—¶**

```
çŽ°è±¡ï¼šåªçœ‹åˆ°è¯·æ±‚ï¼Œæ²¡æœ‰å›žå¤
å¯èƒ½åŽŸå› ï¼š
âœ“ ç›®æ ‡ä¸»æœºé˜²ç«å¢™ä¸¢å¼ƒICMP
âœ“ ç½‘ç»œè·¯å¾„ä¸­æ–­
âœ“ ç›®æ ‡ä¸»æœºå…³æœº
âœ“ è·¯ç”±é…ç½®é”™è¯¯
```

### 3.4 pingå‘½ä»¤é€‰é¡¹ä¸ŽæŠ“åŒ…


| **pingé€‰é¡¹** | **ä½œç”¨** | **æŠ“åŒ…è§‚å¯Ÿç‚¹** |
|-------------|---------|---------------|
| `ping -c 5` | å‘é€5ä¸ªåŒ… | çœ‹åˆ°5å¯¹è¯·æ±‚/å›žå¤ |
| `ping -i 2` | é—´éš”2ç§’ | æ—¶é—´æˆ³é—´éš”2ç§’ |
| `ping -s 1000` | æ•°æ®1000å­—èŠ‚ | lengthæ˜¾ç¤º1000 |
| `ping -W 5` | è¶…æ—¶5ç§’ | 5ç§’å†…æ— å›žå¤åˆ™è¶…æ—¶ |

---

## 4. ðŸ›¤ï¸ tracerouteè·¯å¾„è·Ÿè¸ª


### 4.1 tracerouteå·¥ä½œåŽŸç†


**æ ¸å¿ƒæœºåˆ¶ï¼šå·§å¦™åˆ©ç”¨TTLå­—æ®µ**

```
tracerouteçš„èªæ˜Žåšæ³•ï¼š
ç¬¬1ä¸ªåŒ…: TTL=1 â†’ ç¬¬1è·³è·¯ç”±å™¨æ”¶åˆ°åŽTTLå˜0 â†’ è¿”å›ž"Time Exceeded"
ç¬¬2ä¸ªåŒ…: TTL=2 â†’ ç¬¬2è·³è·¯ç”±å™¨æ”¶åˆ°åŽTTLå˜0 â†’ è¿”å›ž"Time Exceeded"  
ç¬¬3ä¸ªåŒ…: TTL=3 â†’ ç¬¬3è·³è·¯ç”±å™¨æ”¶åˆ°åŽTTLå˜0 â†’ è¿”å›ž"Time Exceeded"
...
ç›´åˆ°åˆ°è¾¾ç›®æ ‡ä¸»æœº â†’ è¿”å›ž"Port Unreachable"(UDPç‰ˆæœ¬)
```

```
è·¯å¾„è·Ÿè¸ªç¤ºæ„å›¾ï¼š
æœ¬åœ°ä¸»æœº          è·¯ç”±å™¨1          è·¯ç”±å™¨2          ç›®æ ‡ä¸»æœº
   |                |                |               |
   |â”€TTL=1â”€â”€â”€â”€â”€â”€â”€â”€â”€>|                |               |
   |<â”€Time Exceededâ”€|                |               |
   |                                 |               |
   |â”€TTL=2â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>|               |
   |<â”€Time Exceededâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€|               |
   |                                                 |
   |â”€TTL=3â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>|
   |<â”€Port Unreachableâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€|
```

### 4.2 tcpdumpæŠ“å–traceroute


```bash
# æ–¹æ³•1ï¼šæŠ“å–UDP traceroute (é»˜è®¤)
tcpdump -i any 'icmp or (udp and dst port 33434:33464)' -v

# æ–¹æ³•2ï¼šæŠ“å–ICMP traceroute
tcpdump -i any 'icmp' -v

# å¯åŠ¨traceroute
traceroute 8.8.8.8
```

**ðŸ” UDPç‰ˆæœ¬tracerouteæŠ“åŒ…è¾“å‡º**ï¼š

```
æ­¥éª¤1 - TTL=1çš„æŽ¢æµ‹ï¼š
12:10:30.100 IP 192.168.1.100 > 8.8.8.8: UDP, length 32, ttl 1
12:10:30.102 IP 192.168.1.1 > 192.168.1.100: ICMP time exceeded in-transit

è§£è¯»ï¼š
- æœ¬åœ°å‘é€UDPåŒ…åˆ°8.8.8.8ï¼ŒTTLè®¾ä¸º1
- ç¬¬ä¸€è·³è·¯ç”±å™¨(192.168.1.1)å›žå¤"time exceeded"
- çŽ°åœ¨çŸ¥é“ç¬¬1è·³æ˜¯192.168.1.1
```

```
æ­¥éª¤2 - TTL=2çš„æŽ¢æµ‹ï¼š
12:10:30.200 IP 192.168.1.100 > 8.8.8.8: UDP, length 32, ttl 2  
12:10:30.205 IP 10.0.0.1 > 192.168.1.100: ICMP time exceeded in-transit

è§£è¯»ï¼š
- TTL=2çš„åŒ…è¢«ç¬¬äºŒè·³è·¯ç”±å™¨(10.0.0.1)æ‹¦æˆª
- ç¬¬2è·³è·¯ç”±å™¨åœ°å€æ˜¯10.0.0.1
```

### 4.3 tracerouteå¼‚å¸¸æƒ…å†µ


**âš ï¸ å¸¸è§å¼‚å¸¸åŠtcpdumpè¡¨çŽ°**ï¼š

| **çŽ°è±¡** | **tcpdumpè¾“å‡º** | **å¯èƒ½åŽŸå› ** |
|---------|----------------|-------------|
| æ˜¾ç¤º `* * *` | åªçœ‹åˆ°UDPè¯·æ±‚ï¼Œæ— ICMPå›žå¤ | è·¯ç”±å™¨ä¸¢å¼ƒICMPæˆ–è¿‡è½½ |
| è¶…æ—¶ | é•¿æ—¶é—´æ— å“åº” | ç½‘ç»œæ‹¥å¡žæˆ–è·¯ç”±å™¨æ•…éšœ |
| é‡å¤IP | åŒä¸€IPå‡ºçŽ°å¤šè·³ | è´Ÿè½½å‡è¡¡æˆ–è·¯ç”±çŽ¯è·¯ |

**ðŸ”§ æŽ’æŸ¥æŠ€å·§**ï¼š
```bash
# ä½¿ç”¨ICMPæ¨¡å¼çš„traceroute
traceroute -I 8.8.8.8

# ä½¿ç”¨TCPæ¨¡å¼çš„traceroute  
traceroute -T -p 80 8.8.8.8

# å¯¹åº”çš„tcpdumpå‘½ä»¤è°ƒæ•´ï¼š
tcpdump -i any 'icmp or (tcp and dst port 80)' -v
```

### 4.4 è·¯å¾„è·Ÿè¸ªå®žç”¨åˆ†æž


**ðŸ“Š æ€§èƒ½åˆ†æžè¦ç‚¹**ï¼š

```bash
# tracerouteè¾“å‡ºç¤ºä¾‹ï¼š
1  192.168.1.1    1.234 ms  1.456 ms  1.123 ms
2  10.0.0.1      15.678 ms 16.234 ms 15.890 ms  
3  203.208.60.1  25.123 ms 24.987 ms 25.456 ms

åˆ†æžæ–¹æ³•ï¼š
1. æ—¶å»¶çªå¢žç‚¹ - ç¬¬2è·³æ¯”ç¬¬1è·³å¢žåŠ äº†çº¦15msï¼Œå¯èƒ½æ˜¯ç“¶é¢ˆ
2. æ—¶å»¶ç¨³å®šæ€§ - ç¬¬1è·³ä¸‰æ¬¡æµ‹è¯•å¾ˆç¨³å®šï¼Œç¬¬2è·³ç•¥æœ‰æ³¢åŠ¨
3. åœ°ç†ä½ç½® - é€šè¿‡IPåœ°å€æŸ¥è¯¢å¯åˆ¤æ–­æ•°æ®åŒ…èµ°å‘
```

---

## 5. âš ï¸ ç½‘ç»œé”™è¯¯è¯Šæ–­


### 5.1 ç½‘ç»œä¸å¯è¾¾æ¶ˆæ¯åˆ†æž


**Type 3 (Destination Unreachable) è¯¦ç»†è¯Šæ–­**ï¼š

```bash
# æ¨¡æ‹Ÿå„ç§ä¸å¯è¾¾æƒ…å†µå¹¶è§‚å¯Ÿ
tcpdump -i any icmp -v

# æµ‹è¯•åœºæ™¯1ï¼šè®¿é—®å…³é—­çš„æœåŠ¡
telnet 192.168.1.100 22
```

**ðŸ” æŠ“åŒ…åˆ†æžä¸åŒCodeå€¼**ï¼š

```
Code 0 - ç½‘ç»œä¸å¯è¾¾ï¼š
13:15:20.100 IP 192.168.1.100 > 10.0.0.100: ICMP 10.0.0.100 net unreachable

å«ä¹‰ï¼šè·¯ç”±å™¨æ²¡æœ‰åˆ°è¾¾ç›®æ ‡ç½‘ç»œ10.0.0.0/24çš„è·¯ç”±è¡¨é¡¹
è§£å†³ï¼šæ£€æŸ¥è·¯ç”±é…ç½®ï¼Œæ·»åŠ æ­£ç¡®çš„è·¯ç”±æ¡ç›®
```

```
Code 1 - ä¸»æœºä¸å¯è¾¾ï¼š  
13:15:25.200 IP 192.168.1.1 > 192.168.1.100: ICMP 192.168.1.200 host unreachable

å«ä¹‰ï¼šèƒ½åˆ°è¾¾ç›®æ ‡ç½‘ç»œï¼Œä½†ä¸»æœº192.168.1.200æ— å“åº”
è§£å†³ï¼šæ£€æŸ¥ç›®æ ‡ä¸»æœºæ˜¯å¦åœ¨çº¿ï¼ŒARPè¡¨æ˜¯å¦æ­£ç¡®
```

```
Code 3 - ç«¯å£ä¸å¯è¾¾ï¼š
13:15:30.300 IP 192.168.1.100 > 192.168.1.100: ICMP 192.168.1.200 udp port 12345 unreachable  

å«ä¹‰ï¼šä¸»æœºåœ¨çº¿ä½†æ²¡æœ‰ç¨‹åºç›‘å¬UDP 12345ç«¯å£
è§£å†³ï¼šç¡®è®¤ç›®æ ‡æœåŠ¡æ˜¯å¦å¯åŠ¨ï¼Œç«¯å£æ˜¯å¦æ­£ç¡®
```

### 5.2 è¶…æ—¶æ¶ˆæ¯å¤„ç†


**Type 11 (Time Exceeded) åˆ†æž**ï¼š

```bash
# åˆ›å»ºä¸€ä¸ªTTLå¾ˆå°çš„æµ‹è¯•
ping -t 1 8.8.8.8

# tcpdumpè¾“å‡ºï¼š
13:20:15.100 IP 192.168.1.100 > 8.8.8.8: ICMP echo request, ttl 1
13:20:15.102 IP 192.168.1.1 > 192.168.1.100: ICMP time exceeded in-transit
```

**å¸¸è§è¶…æ—¶åœºæ™¯**ï¼š

| **Code** | **å«ä¹‰** | **å…¸åž‹åœºæ™¯** | **è§£å†³æ–¹å‘** |
|----------|---------|-------------|-------------|
| 0 | TTLåœ¨ä¼ è¾“ä¸­è¿‡æœŸ | è·¯ç”±çŽ¯è·¯ï¼ŒTTLè®¾ç½®è¿‡å° | æ£€æŸ¥è·¯ç”±è¡¨ï¼Œå¢žå¤§TTL |
| 1 | åˆ†ç‰‡é‡ç»„è¶…æ—¶ | å¤§åŒ…åˆ†ç‰‡åŽä¸¢å¤±éƒ¨åˆ†ç‰‡æ®µ | å‡å°MTUï¼Œæ£€æŸ¥åˆ†ç‰‡å¤„ç† |

### 5.3 é‡å®šå‘æ¶ˆæ¯å«ä¹‰


**Type 5 (Redirect) ç†è§£**ï¼š

```
é‡å®šå‘åœºæ™¯ï¼š
ä¸»æœºA           è·¯ç”±å™¨R1          è·¯ç”±å™¨R2          ç›®æ ‡ç½‘ç»œ
  |               |                |                |
  |â”€æ•°æ®åŒ…â”€â”€â”€â”€â”€â”€â”€â”€>|                |                |
  |               |â”€è½¬å‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>|                |
  |<â”€é‡å®šå‘æ¶ˆæ¯â”€â”€â”€â”€|                |                |
  |  "ä¸‹æ¬¡ç›´æŽ¥å‘ç»™R2"               |                |
```

```bash
# æŠ“åŒ…çœ‹åˆ°é‡å®šå‘æ¶ˆæ¯
tcpdump -i any icmp -v

# è¾“å‡ºç¤ºä¾‹ï¼š
13:25:10.100 IP 192.168.1.1 > 192.168.1.100: ICMP redirect 10.0.0.0/24 to host 192.168.1.2

è§£è¯»ï¼š
- è·¯ç”±å™¨192.168.1.1å»ºè®®
- å‘å¾€10.0.0.0/24ç½‘ç»œçš„æ•°æ®åŒ…  
- åº”è¯¥ç›´æŽ¥å‘ç»™192.168.1.2è·¯ç”±å™¨
```

ðŸ’¡ **å®žé™…æ„ä¹‰**ï¼šçŽ°ä»£ç½‘ç»œä¸­å¾ˆå°‘å¯ç”¨é‡å®šå‘åŠŸèƒ½ï¼Œå› ä¸ºæœ‰å®‰å…¨é£Žé™©ã€‚å¤§å¤šæ•°ç³»ç»Ÿé»˜è®¤å¿½ç•¥é‡å®šå‘æ¶ˆæ¯ã€‚

---

## 6. ðŸ”§ å®žæˆ˜æ¡ˆä¾‹åˆ†æž


### 6.1 ç½‘ç»œè¿žé€šæ€§æ•…éšœæŽ’æŸ¥


**ðŸ“‹ æ•…éšœåœºæ™¯**ï¼šæ— æ³•è®¿é—®æŸä¸ªç½‘ç«™

```bash
# ç¬¬1æ­¥ï¼šåŸºæœ¬è¿žé€šæ€§æµ‹è¯•
ping www.example.com

# ç¬¬2æ­¥ï¼šå¯åŠ¨æŠ“åŒ…
tcpdump -i any icmp -v -n

# ç¬¬3æ­¥ï¼šåˆ†æžæŠ“åŒ…ç»“æžœ
```

**ðŸ” æ¡ˆä¾‹1ï¼šDNSè§£æžæ­£å¸¸ä½†pingå¤±è´¥**

```
æŠ“åŒ…è¾“å‡ºï¼š
14:10:15.100 IP 192.168.1.100 > 93.184.216.34: ICMP echo request, id 1234, seq 1
14:10:16.100 IP 192.168.1.100 > 93.184.216.34: ICMP echo request, id 1234, seq 2  
14:10:17.100 IP 192.168.1.100 > 93.184.216.34: ICMP echo request, id 1234, seq 3

åˆ†æžç»“æžœï¼š
âœ“ DNSè§£æžæˆåŠŸ (æœ‰å…·ä½“IPåœ°å€93.184.216.34)
âœ— åªæœ‰è¯·æ±‚æ²¡æœ‰å›žå¤ (ç›®æ ‡ä¸»æœºå¯èƒ½ç¦ç”¨ICMPå›žå¤)
âœ“ ç½‘ç»œè·¯å¾„é€šç•… (è¯·æ±‚èƒ½å‘å‡ºåŽ»)

ç»“è®ºï¼šç½‘ç»œè¿žæŽ¥æ­£å¸¸ï¼Œç›®æ ‡ä¸»æœºé˜²ç«å¢™ç­–ç•¥å¯¼è‡´
```

**ðŸ” æ¡ˆä¾‹2ï¼šç½‘ç»œè·¯å¾„ä¸­æ–­**

```  
æŠ“åŒ…è¾“å‡ºï¼š
14:15:20.100 IP 192.168.1.100 > 8.8.8.8: ICMP echo request, id 5678, seq 1
14:15:20.105 IP 10.0.0.1 > 192.168.1.100: ICMP 8.8.8.8 net unreachable

åˆ†æžç»“æžœï¼š
âœ— ä¸­é—´è·¯ç”±å™¨10.0.0.1æŠ¥å‘Šç½‘ç»œä¸å¯è¾¾
âœ“ æœ¬åœ°ç½‘ç»œæ­£å¸¸ (èƒ½å‘å‡ºè¯·æ±‚å¹¶æ”¶åˆ°é”™è¯¯æ¶ˆæ¯)
âœ— ä¸Šæ¸¸è·¯ç”±é…ç½®é—®é¢˜

è§£å†³æ–¹å‘ï¼šè”ç³»ç½‘ç»œç®¡ç†å‘˜æ£€æŸ¥è·¯ç”±é…ç½®
```

### 6.2 MTUå‘çŽ°é—®é¢˜


**ðŸ” å¤§åŒ…ä¼ è¾“å¤±è´¥åˆ†æž**ï¼š

```bash
# å‘é€å¤§pingåŒ…æµ‹è¯•MTU
ping -s 1472 8.8.8.8

# æŠ“åŒ…åˆ†æž
tcpdump -i any icmp -v
```

```
æ­£å¸¸æƒ…å†µè¾“å‡ºï¼š
14:20:30.100 IP 192.168.1.100 > 8.8.8.8: ICMP echo request, id 9999, seq 1, length 1472
14:20:30.120 IP 8.8.8.8 > 192.168.1.100: ICMP echo reply, id 9999, seq 1, length 1472

MTUé—®é¢˜è¾“å‡ºï¼š  
14:20:35.200 IP 192.168.1.100 > 8.8.8.8: ICMP echo request, id 9999, seq 2, length 1500
14:20:35.205 IP 192.168.1.1 > 192.168.1.100: ICMP 8.8.8.8 unreachable - need to frag (mtu 1400)

è§£è¯»ï¼š
- è·¯ç”±å™¨æŠ¥å‘Šéœ€è¦åˆ†ç‰‡ä½†è®¾ç½®äº†DFæ ‡å¿—  
- MTUåªæœ‰1400å­—èŠ‚ï¼Œéœ€è¦åˆ†ç‰‡
- å»ºè®®è°ƒæ•´æ•°æ®åŒ…å¤§å°
```

### 6.3 ç½‘ç»œæ€§èƒ½è¯Šæ–­


**ðŸ“Š åˆ©ç”¨ICMPè¿›è¡Œæ€§èƒ½åˆ†æž**ï¼š

```bash
# æŒç»­pingç›‘æŽ§ç½‘ç»œè´¨é‡
ping -i 0.1 8.8.8.8 | tee ping.log &

# åŒæ—¶æŠ“åŒ…åˆ†æž
tcpdump -i any icmp -v -t > icmp.log
```

**è´¨é‡æŒ‡æ ‡æå–**ï¼š

```bash
# åˆ†æžpingæ—¥å¿—æå–å…³é”®æŒ‡æ ‡
grep "time=" ping.log | awk '{print $7}' | sed 's/time=//' > rtt.data

# è®¡ç®—ç»Ÿè®¡å€¼
cat rtt.data | awk '
{
    sum += $1; 
    if($1 > max) max = $1; 
    if(min == 0 || $1 < min) min = $1
} 
END {
    print "å¹³å‡RTT:", sum/NR "ms"
    print "æœ€å°RTT:", min "ms" 
    print "æœ€å¤§RTT:", max "ms"
}'
```

---

## 7. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ðŸ”¸ ICMPæœ¬è´¨ï¼šç½‘ç»œå±‚çš„æŽ§åˆ¶å’Œé”™è¯¯æŠ¥å‘Šåè®®
ðŸ”¸ æ¶ˆæ¯ç±»åž‹ï¼šping(8/0)ã€ä¸å¯è¾¾(3)ã€è¶…æ—¶(11)ã€é‡å®šå‘(5)
ðŸ”¸ æŠ“åŒ…è¦ç‚¹ï¼šå…³æ³¨Type/Codeç»„åˆï¼Œç†è§£é”™è¯¯å«ä¹‰
ðŸ”¸ è¯Šæ–­æµç¨‹ï¼špingæµ‹è¯• â†’ tracerouteè·Ÿè¸ª â†’ é”™è¯¯åˆ†æž
ðŸ”¸ å®žç”¨ä»·å€¼ï¼šç½‘ç»œæ•…éšœæŽ’æŸ¥çš„åŸºç¡€å·¥å…·
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ ICMPä¸æ˜¯"å¯æœ‰å¯æ— "çš„åè®®**
```
ç½‘ç»œè¯Šæ–­ä»·å€¼ï¼š
â€¢ pingå‘½ä»¤ä¾èµ–ICMP Echoæ¶ˆæ¯
â€¢ tracerouteåˆ©ç”¨ICMP Time Exceededæ¶ˆæ¯  
â€¢ é”™è¯¯æŠ¥å‘Šå¸®åŠ©å®šä½ç½‘ç»œé—®é¢˜
â€¢ MTUå‘çŽ°ä¾èµ–ICMP Fragmentation Neededæ¶ˆæ¯
```

**ðŸ”¹ tcpdumpæŠ“åŒ…çš„å…³é”®ä¿¡æ¯**
```
å¿…çœ‹å­—æ®µï¼š
â€¢ Type/Code - ç¡®å®šæ¶ˆæ¯ç±»åž‹å’Œå…·ä½“åŽŸå› 
â€¢ TTLå€¼ - åˆ¤æ–­æ•°æ®åŒ…ç»è¿‡çš„è·³æ•°
â€¢ æ—¶é—´æˆ³ - è®¡ç®—RTTå’Œåˆ†æžæ—¶åº
â€¢ æº/ç›®æ ‡IP - ç¡®å®šé”™è¯¯æŠ¥å‘Šçš„æ¥æº
```

**ðŸ”¹ å¸¸è§æ•…éšœçš„ICMPè¡¨çŽ°**
```
ç½‘ç»œä¸é€šï¼šåªæœ‰è¯·æ±‚æ— å›žå¤
ä¸»æœºå…³é—­ï¼šHost Unreachable  
ç«¯å£å…³é—­ï¼šPort Unreachable
è·¯ç”±é—®é¢˜ï¼šNet Unreachable
MTUé—®é¢˜ï¼šFragmentation Needed
è·¯å¾„é—®é¢˜ï¼šTime Exceeded
```

### 7.3 å®žé™…åº”ç”¨æŒ‡å¯¼


**ðŸŽ¯ æ•…éšœæŽ’æŸ¥æµç¨‹**
```
ç¬¬1æ­¥ï¼šåŸºç¡€è¿žé€šæ€§ â†’ pingç›®æ ‡ä¸»æœº
ç¬¬2æ­¥ï¼šè·¯å¾„åˆ†æž   â†’ tracerouteæŸ¥çœ‹è·¯å¾„
ç¬¬3æ­¥ï¼šè¯¦ç»†æŠ“åŒ…   â†’ tcpdumpåˆ†æžICMPæ¶ˆæ¯
ç¬¬4æ­¥ï¼šå®šä½é—®é¢˜   â†’ æ ¹æ®Type/Codeç¡®å®šåŽŸå› 
ç¬¬5æ­¥ï¼šé’ˆå¯¹è§£å†³   â†’ è·¯ç”±/é˜²ç«å¢™/MTUç­‰
```

**ðŸ”§ æŠ“åŒ…å‘½ä»¤é€ŸæŸ¥**
```bash
# åŸºç¡€ICMPæŠ“åŒ…
tcpdump -i any icmp -v -n

# åŒ…å«tracerouteçš„å®Œæ•´æŠ“åŒ…  
tcpdump -i any 'icmp or (udp and dst port 33434:33464)' -v

# è¯¦ç»†åˆ†æžæ¨¡å¼
tcpdump -i any icmp -v -x -s 0

# ä¿å­˜åˆ°æ–‡ä»¶åˆ†æž
tcpdump -i any icmp -w icmp.pcap
```

**ðŸ’¡ å®žç”¨æŠ€å·§**
- **IDåŒ¹é…**ï¼šåŒä¸€pingè¿›ç¨‹çš„è¯·æ±‚å’Œå›žå¤IDç›¸åŒ
- **åºåˆ—åˆ†æž**ï¼šseqå·å¸®åŠ©è¯†åˆ«ä¸¢åŒ…å’Œä¹±åº  
- **æ—¶é—´è®¡ç®—**ï¼šæ‰‹å·¥è®¡ç®—RTTéªŒè¯pingç»“æžœ
- **é”™è¯¯å®šä½**ï¼šType 3çš„ä¸åŒCodeå€¼ç²¾ç¡®æŒ‡ç¤ºé—®é¢˜ç±»åž‹

**ðŸ” é«˜çº§åˆ†æž**
```bash
# ç»Ÿè®¡ICMPæ¶ˆæ¯ç±»åž‹åˆ†å¸ƒ
tcpdump -i any icmp -c 100 | grep -o 'ICMP [^,]*' | sort | uniq -c

# åˆ†æžç‰¹å®šç±»åž‹çš„ICMPæ¶ˆæ¯
tcpdump -i any 'icmp[icmptype] = 3' -v    # åªçœ‹ç›®æ ‡ä¸å¯è¾¾
tcpdump -i any 'icmp[icmptype] = 11' -v   # åªçœ‹è¶…æ—¶æ¶ˆæ¯  
```

### 7.4 å­¦ä¹ è¦ç‚¹æ€»ç»“


**æ ¸å¿ƒè®°å¿†**ï¼š
- ICMPæ˜¯ç½‘ç»œè¯Šæ–­çš„åŸºç¡€åè®®ï¼Œç†è§£å…¶å·¥ä½œåŽŸç†æ˜¯ç½‘ç»œæ•…éšœæŽ’æŸ¥çš„å…³é”®
- tcpdumpæŠ“å–ICMPæ¶ˆæ¯èƒ½ç›´è§‚çœ‹åˆ°ç½‘ç»œé—®é¢˜ï¼ŒType/Codeç»„åˆæ˜¯åˆ†æžé‡ç‚¹
- pingå’Œtracerouteéƒ½ä¾èµ–ICMPï¼ŒæŽŒæ¡å…¶æ•°æ®åŒ…æ ¼å¼æœ‰åŠ©äºŽæ·±å…¥ç†è§£ç½‘ç»œè¡Œä¸º
- ç½‘ç»œæ•…éšœå¾€å¾€é€šè¿‡ICMPé”™è¯¯æ¶ˆæ¯æš´éœ²ï¼Œå­¦ä¼šè¯»æ‡‚è¿™äº›"é”™è¯¯æŠ¥å‘Š"æ˜¯è¿ç»´å¿…å¤‡æŠ€èƒ½

**å®žè·µå»ºè®®**ï¼š
- å¤šåœ¨ä¸åŒç½‘ç»œçŽ¯å¢ƒä¸‹æŠ“åŒ…ç»ƒä¹ ï¼Œç§¯ç´¯å„ç§ICMPæ¶ˆæ¯çš„è¯†åˆ«ç»éªŒ
- ç»“åˆpingã€tracerouteç­‰å·¥å…·çš„å®žé™…ä½¿ç”¨ï¼Œç†è§£ICMPåœ¨ç½‘ç»œè¯Šæ–­ä¸­çš„ä»·å€¼
- å…³æ³¨é˜²ç«å¢™å’Œå®‰å…¨ç­–ç•¥å¯¹ICMPçš„å½±å“ï¼Œäº†è§£çŽ°å®žç½‘ç»œçŽ¯å¢ƒçš„å¤æ‚æ€§