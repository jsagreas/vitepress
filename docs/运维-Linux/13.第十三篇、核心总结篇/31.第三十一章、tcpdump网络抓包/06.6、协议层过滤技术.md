---
title: 6、协议层过滤技术
---
## 📚 目录

1. [协议层过滤基础概念](#1-协议层过滤基础概念)
2. [数据链路层过滤技术](#2-数据链路层过滤技术)
3. [网络层过滤技术](#3-网络层过滤技术)
4. [传输层过滤技术](#4-传输层过滤技术)
5. [应用层协议识别](#5-应用层协议识别)
6. [协议字段访问方法](#6-协议字段访问方法)
7. [多协议组合过滤](#7-多协议组合过滤)
8. [协议栈层次理解](#8-协议栈层次理解)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🌐 协议层过滤基础概念


### 1.1 什么是协议层过滤


**简单理解**：协议层过滤就像是在数据流中设置不同层次的"筛子"，只让特定协议的数据包通过。

```
想象一下邮局分拣邮件：
📮 所有邮件 → 按地区分类 → 按街道分类 → 按门牌号分类
📦 网络数据 → 按协议分类 → 按端口分类 → 按内容分类
```

**核心作用**：
- 🎯 **精准定位**：只抓取你关心的协议数据
- 🚀 **提高效率**：减少无关数据，降低分析复杂度
- 💾 **节省空间**：避免抓取大量无用数据
- 🔍 **问题排查**：快速定位特定协议的问题

### 1.2 网络协议栈层次结构


```
应用层    |  HTTP、FTP、SSH、DNS等
         |  ↑ 应用程序直接使用的协议
---------+--------------------------------
传输层    |  TCP、UDP
         |  ↑ 负责端到端的数据传输
---------+--------------------------------  
网络层    |  IP、ICMP、ARP
         |  ↑ 负责路由和寻址
---------+--------------------------------
数据链路层 |  Ethernet、WiFi
         |  ↑ 负责局域网内的数据传输
---------+--------------------------------
物理层    |  网线、光纤、无线电波
```

> 💡 **理解要点**：每一层都有自己的"语言"（协议），tcpdump可以在任意一层进行过滤

### 1.3 协议过滤的基本语法


**基本格式**：`tcpdump [协议名称] [其他条件]`

```bash
# 基本协议过滤示例
tcpdump tcp          # 只抓TCP协议数据包
tcpdump udp          # 只抓UDP协议数据包  
tcpdump ip           # 只抓IP协议数据包
tcpdump ether        # 只抓以太网协议数据包
```

---

## 2. 🔗 数据链路层过滤技术


### 2.1 以太网协议过滤


**什么是以太网协议**：以太网是局域网中最常用的数据链路层协议，就像是局域网内设备互相"说话"的共同语言。

**基本过滤语法**：

| 过滤条件 | 语法示例 | 说明 |
|---------|---------|------|
| **以太网协议** | `ether` | 抓取所有以太网数据包 |
| **源MAC地址** | `ether src 00:11:22:33:44:55` | 指定源设备的物理地址 |
| **目标MAC地址** | `ether dst aa:bb:cc:dd:ee:ff` | 指定目标设备的物理地址 |
| **MAC地址范围** | `ether host 00:11:22:33:44:55` | 包含该MAC的所有通信 |

**实用示例**：

```bash
# 监控特定设备的所有网络活动
tcpdump ether host 00:11:22:33:44:55

# 查看来自路由器的数据包
tcpdump ether src 00:11:22:33:44:55

# 监控发送到特定设备的数据
tcpdump ether dst aa:bb:cc:dd:ee:ff
```

### 2.2 数据链路层协议类型


**常见协议类型**：

```
协议类型对照表：
┌─────────────┬──────────────┬─────────────────┐
│ 协议名称     │   类型值     │    实际用途      │
├─────────────┼──────────────┼─────────────────┤
│ IP协议      │   0x0800     │  互联网通信      │
│ ARP协议     │   0x0806     │  地址解析        │
│ IPv6协议    │   0x86DD     │  下一代互联网    │
│ 802.1Q VLAN │   0x8100     │  虚拟局域网      │
└─────────────┴──────────────┴─────────────────┘
```

```bash
# 按协议类型过滤
tcpdump ether proto \\ip        # 只看IP数据包
tcpdump ether proto \\arp       # 只看ARP数据包
```

### 2.3 实际应用场景


> 🎯 **使用场景**：
> - **网络故障排查**：设备间无法通信时，检查数据链路层
> - **安全监控**：监控可疑MAC地址的活动
> - **网络拓扑分析**：了解局域网内设备通信模式

---

## 3. 🌍 网络层过滤技术


### 3.1 IP协议过滤基础


**什么是IP协议**：IP协议就像互联网的"邮政系统"，负责把数据包从一个地址送到另一个地址。

### 3.2 IPv4过滤技术


**基本语法结构**：

| 过滤类型 | 语法格式 | 实际含义 |
|---------|---------|---------|
| **IP协议** | `ip` | 所有IPv4数据包 |
| **源IP** | `src 192.168.1.100` | 来自特定IP的数据 |
| **目标IP** | `dst 8.8.8.8` | 发往特定IP的数据 |
| **主机IP** | `host 192.168.1.1` | 与特定IP相关的所有通信 |
| **网段过滤** | `net 192.168.1.0/24` | 整个网段的通信 |

**实用过滤示例**：

```bash
# 监控与特定服务器的通信
tcpdump host 8.8.8.8

# 查看局域网内部通信
tcpdump net 192.168.1.0/24

# 监控来自外网的访问
tcpdump src net not 192.168.0.0/16

# 查看访问特定网站的请求
tcpdump dst host www.baidu.com
```

### 3.3 IPv6过滤技术


**IPv6特点**：IPv6是下一代互联网协议，地址更长，功能更强大。

```bash
# IPv6基本过滤
tcpdump ip6                           # 所有IPv6数据包
tcpdump src 2001:db8::1              # 来自特定IPv6地址
tcpdump dst 2001:db8::1              # 发往特定IPv6地址
tcpdump ip6 and host 2001:db8::1     # IPv6主机通信
```

### 3.4 网络层协议组合


**常用组合过滤**：

```bash
# 同时监控IPv4和IPv6
tcpdump ip or ip6

# 排除本地回环通信
tcpdump ip and not host 127.0.0.1

# 只看外网通信，排除局域网
tcpdump ip and not net 192.168.0.0/16 and not net 10.0.0.0/8
```

> 💡 **实用技巧**：使用 `not` 操作符可以排除不关心的流量，让分析更加精准

---

## 4. 🚚 传输层过滤技术


### 4.1 TCP协议过滤详解


**什么是TCP**：TCP就像是"挂号信"，保证数据能可靠地送达目的地，适合重要数据传输。

### 4.2 TCP连接状态过滤


**TCP连接过程理解**：

```
客户端          服务器
   |              |
   |----SYN------>|  第1步：客户端请求连接
   |              |
   |<---SYN+ACK---|  第2步：服务器确认并请求
   |              |
   |----ACK------>|  第3步：客户端最终确认
   |              |
   |<==数据传输==>|  正常通信阶段
   |              |
   |----FIN------>|  第4步：客户端请求断开
   |              |
   |<---ACK-------|  第5步：服务器确认断开
```

**TCP标志位过滤**：

| TCP标志 | 含义解释 | 过滤语法 | 应用场景 |
|---------|---------|----------|----------|
| **SYN** | 连接请求 | `tcp[tcpflags] & tcp-syn != 0` | 监控新连接 |
| **ACK** | 确认应答 | `tcp[tcpflags] & tcp-ack != 0` | 查看响应情况 |
| **FIN** | 结束连接 | `tcp[tcpflags] & tcp-fin != 0` | 监控连接关闭 |
| **RST** | 重置连接 | `tcp[tcpflags] & tcp-rst != 0` | 查看异常断开 |

**实用TCP过滤**：

```bash
# 监控HTTP连接建立
tcpdump tcp port 80 and tcp[tcpflags] & tcp-syn != 0

# 查看连接异常断开
tcpdump tcp[tcpflags] & tcp-rst != 0

# 监控HTTPS通信
tcpdump tcp port 443
```

### 4.3 UDP协议过滤详解


**什么是UDP**：UDP就像是"平信"，发送速度快但不保证送达，适合实时通信。

**UDP特点与应用**：

```
UDP协议特点：
✅ 传输速度快        ❌ 不保证可靠性
✅ 开销小           ❌ 无连接状态  
✅ 支持广播         ❌ 无流量控制

常见UDP应用：
🎮 在线游戏 (需要低延迟)
📺 视频直播 (允许少量丢包) 
🌍 DNS查询 (快速响应)
⏰ NTP时间同步 (定期更新)
```

**UDP过滤示例**：

```bash
# 监控DNS查询
tcpdump udp port 53

# 查看DHCP分配过程
tcpdump udp port 67 or udp port 68

# 监控NTP时间同步
tcpdump udp port 123
```

### 4.4 端口号过滤技术


**端口号理解**：端口号就像是建筑物的"房间号"，用来区分同一设备上的不同服务。

**常用端口对照表**：

| 端口号 | 协议类型 | 服务名称 | 实际用途 |
|-------|---------|---------|----------|
| **22** | TCP | SSH | 远程登录管理 |
| **80** | TCP | HTTP | 网页浏览 |
| **443** | TCP | HTTPS | 安全网页浏览 |
| **53** | UDP | DNS | 域名解析 |
| **21** | TCP | FTP | 文件传输 |
| **25** | TCP | SMTP | 邮件发送 |

**端口过滤语法**：

```bash
# 单个端口
tcpdump port 80                    # HTTP流量
tcpdump tcp port 22                # SSH登录
tcpdump udp port 53                # DNS查询

# 端口范围
tcpdump portrange 1000-2000        # 端口范围
tcpdump tcp portrange 80-443       # Web服务端口

# 多端口组合
tcpdump port 80 or port 443        # HTTP和HTTPS
tcpdump tcp and (port 22 or port 23) # SSH和Telnet
```

---

## 5. 🌐 应用层协议识别


### 5.1 应用层协议概述


**什么是应用层协议**：应用层协议是最接近用户的协议，就像是不同的"对话方式"，比如HTTP用来浏览网页，FTP用来传输文件。

### 5.2 Web协议识别


**HTTP/HTTPS协议特征**：

```
HTTP请求特征：
GET /index.html HTTP/1.1        ← 请求方法和路径
Host: www.example.com           ← 目标网站  
User-Agent: Mozilla/5.0         ← 浏览器信息

HTTPS特征：
- 使用443端口
- 数据加密，无法直接看到内容
- 握手过程包含证书交换
```

**Web流量过滤**：

```bash
# HTTP流量分析
tcpdump tcp port 80 and host www.baidu.com

# HTTPS握手过程
tcpdump tcp port 443 and tcp[tcpflags] & tcp-syn != 0

# 监控特定网站访问
tcpdump host www.example.com and (port 80 or port 443)
```

### 5.3 邮件协议识别


**邮件协议类型**：

| 协议名称 | 端口号 | 协议类型 | 主要功能 |
|---------|-------|---------|----------|
| **SMTP** | 25/587 | TCP | 邮件发送 |
| **POP3** | 110/995 | TCP | 邮件接收（下载） |
| **IMAP** | 143/993 | TCP | 邮件接收（同步） |

```bash
# 邮件发送监控
tcpdump tcp port 25 or tcp port 587

# 邮件接收监控  
tcpdump tcp port 110 or tcp port 143

# 安全邮件协议
tcpdump tcp port 465 or tcp port 993 or tcp port 995
```

### 5.4 文件传输协议


**FTP协议特点**：

```
FTP工作模式：
控制连接：端口21 (发送命令)
   |
   ↓
数据连接：端口20 或随机端口 (传输文件)

主动模式 vs 被动模式：
主动：服务器主动连接客户端数据端口
被动：客户端主动连接服务器数据端口
```

```bash
# FTP控制连接
tcpdump tcp port 21

# FTP完整会话（包括数据传输）
tcpdump tcp port 21 or tcp port 20

# 被动模式FTP（端口范围较大）
tcpdump tcp and (port 21 or portrange 1024-65535)
```

---

## 6. 🔧 协议字段访问方法


### 6.1 协议字段访问基础


**什么是协议字段访问**：就像解剖数据包，可以查看数据包内部的具体信息，比如查看IP包头的某个特定字段。

### 6.2 字节偏移访问方法


**基本语法**：`协议名[偏移量:字节数]`

```
IP包头结构示例 (简化版)：
字节位置:  0  1  2  3  4  5  6  7  8  9 ...
内容:    [版本|头长][服务类型][总长度] [标识]...
偏移量:    0     1      2-3     4-5
```

**常用字段访问**：

| 协议 | 字段名称 | 访问语法 | 含义说明 |
|------|---------|----------|----------|
| **IP** | 协议字段 | `ip[9]` | 下层协议类型 |
| **IP** | 源地址 | `ip[12:4]` | 源IP地址 |
| **IP** | 目标地址 | `ip[16:4]` | 目标IP地址 |
| **TCP** | 标志位 | `tcp[13]` | TCP连接状态 |
| **TCP** | 源端口 | `tcp[0:2]` | 源端口号 |
| **TCP** | 目标端口 | `tcp[2:2]` | 目标端口号 |

### 6.3 实用字段过滤示例


```bash
# 查看特定协议类型 (6=TCP, 17=UDP, 1=ICMP)
tcpdump 'ip[9] = 6'              # 只看TCP数据包
tcpdump 'ip[9] = 17'             # 只看UDP数据包
tcpdump 'ip[9] = 1'              # 只看ICMP数据包

# TCP标志位分析
tcpdump 'tcp[13] & 2 != 0'       # SYN标志位
tcpdump 'tcp[13] & 16 != 0'      # ACK标志位  
tcpdump 'tcp[13] & 4 != 0'       # RST标志位

# 端口号访问
tcpdump 'tcp[0:2] = 80'          # 源端口80
tcpdump 'tcp[2:2] = 443'         # 目标端口443
```

### 6.4 高级字段操作


**位运算操作**：

```bash
# TCP标志位组合检查
tcpdump 'tcp[13] & 18 = 18'      # SYN+ACK同时设置
tcpdump 'tcp[13] & 17 = 17'      # FIN+ACK同时设置

# IP包头长度检查
tcpdump 'ip[0] & 0x0f > 5'       # 有IP选项的数据包

# 检查特定字节值
tcpdump 'tcp[13] = 0x18'         # 精确匹配标志位值
```

> ⚠️ **注意事项**：字节偏移访问需要对协议格式有深入了解，建议先掌握基本过滤再学习高级用法

---

## 7. 🔄 多协议组合过滤


### 7.1 逻辑运算符使用


**基本逻辑操作**：

| 操作符 | 含义 | 语法示例 | 实际用途 |
|-------|------|----------|----------|
| **and** | 逻辑与 | `tcp and port 80` | 同时满足多个条件 |
| **or** | 逻辑或 | `port 80 or port 443` | 满足任一条件 |
| **not** | 逻辑非 | `not tcp` | 排除特定条件 |
| **()** | 分组 | `(tcp or udp) and port 53` | 控制运算优先级 |

### 7.2 实用组合过滤案例


**Web流量分析**：

```bash
# 监控所有Web流量（HTTP+HTTPS）
tcpdump tcp and (port 80 or port 443)

# 特定网站的Web访问
tcpdump host www.example.com and tcp and (port 80 or port 443)

# 排除本地Web服务流量
tcpdump tcp and (port 80 or port 443) and not host 127.0.0.1
```

**邮件服务监控**：

```bash
# 所有邮件协议流量
tcpdump tcp and (port 25 or port 110 or port 143 or port 465 or port 587 or port 993 or port 995)

# 安全邮件协议
tcpdump tcp and (port 465 or port 587 or port 993 or port 995)
```

**DNS查询分析**：

```bash
# 所有DNS查询（包括TCP和UDP）
tcpdump port 53

# 只看DNS查询请求
tcpdump udp port 53 and src host 192.168.1.100

# 大型DNS响应（可能使用TCP）
tcpdump tcp port 53
```

### 7.3 复杂过滤场景


**安全监控场景**：

```bash
# 监控可疑端口扫描
tcpdump tcp[tcpflags] & tcp-syn != 0 and tcp[tcpflags] & tcp-ack = 0

# 检测端口扫描响应
tcpdump tcp[tcpflags] & tcp-rst != 0

# 监控异常大流量
tcpdump greater 1000  # 大于1000字节的数据包
```

**网络故障排查**：

```bash
# ICMP错误消息
tcpdump icmp and (icmp[0] = 3 or icmp[0] = 11)

# ARP请求/响应
tcpdump arp and (arp[6:2] = 1 or arp[6:2] = 2)

# 重传数据包检测
tcpdump tcp[tcpflags] & tcp-ack != 0 and greater 0
```

---

## 8. 📚 协议栈层次理解


### 8.1 协议封装过程


**数据封装理解**：就像寄包裹一样，每一层都会给数据包"包装"一层信息。

```
应用数据封装过程：

第4步: [应用数据] "Hello World"
       ↓ 应用层添加HTTP头
第3步: [HTTP头][应用数据] 
       ↓ 传输层添加TCP头
第2步: [TCP头][HTTP头][应用数据]
       ↓ 网络层添加IP头  
第1步: [IP头][TCP头][HTTP头][应用数据]
       ↓ 数据链路层添加以太网头
最终: [以太网头][IP头][TCP头][HTTP头][应用数据]
```

### 8.2 协议解封装过程


**接收端处理**：

```
数据包接收处理过程：

接收: [以太网头][IP头][TCP头][HTTP头][应用数据]
      ↓ 数据链路层处理
去掉: [IP头][TCP头][HTTP头][应用数据] 
      ↓ 网络层处理  
去掉: [TCP头][HTTP头][应用数据]
      ↓ 传输层处理
去掉: [HTTP头][应用数据]
      ↓ 应用层处理
最终: [应用数据] "Hello World"
```

### 8.3 协议层次过滤策略


**不同层次的过滤用途**：

| 协议层次 | 过滤目的 | 典型应用 | 示例命令 |
|---------|---------|----------|----------|
| **数据链路层** | 设备通信分析 | 局域网故障排查 | `tcpdump ether host MAC地址` |
| **网络层** | 路由和寻址分析 | 网络连通性检查 | `tcpdump ip host IP地址` |
| **传输层** | 连接状态分析 | 服务可用性检查 | `tcpdump tcp port 端口` |
| **应用层** | 业务逻辑分析 | 应用性能分析 | `tcpdump port 80` |

### 8.4 协议栈故障定位


**分层排查方法**：

```bash
# 第1步：检查物理连接（数据链路层）
tcpdump -i eth0 ether

# 第2步：检查IP连通性（网络层）  
tcpdump icmp
tcpdump ip host 目标IP

# 第3步：检查端口连接（传输层）
tcpdump tcp port 目标端口

# 第4步：检查应用响应（应用层）
tcpdump tcp port 80 -A  # 显示ASCII内容
```

> 💡 **排查技巧**：从下往上逐层检查，确定问题出现在哪一层，然后针对性解决

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的基本概念


```
🔸 协议层次：数据链路层 → 网络层 → 传输层 → 应用层
🔸 基本过滤：ether, ip, tcp, udp等协议名称直接使用
🔸 逻辑运算：and, or, not组合多个条件
🔸 端口过滤：port, portrange指定服务端口
🔸 主机过滤：host, src, dst指定通信地址
🔸 字段访问：协议[偏移:长度]访问特定字段
```

### 9.2 关键理解要点


**🔹 协议层次的关系**
```
每一层解决不同问题：
- 数据链路层：解决局域网通信问题
- 网络层：解决跨网络路由问题  
- 传输层：解决端到端可靠性问题
- 应用层：解决具体业务功能问题
```

**🔹 过滤策略的选择**
```
根据问题选择合适的过滤层次：
- 设备无法通信 → 数据链路层过滤
- 网络无法访问 → 网络层过滤
- 端口无法连接 → 传输层过滤  
- 应用功能异常 → 应用层过滤
```

**🔹 组合过滤的技巧**
```
有效组合多个条件：
✅ 先确定主要协议，再添加细化条件
✅ 使用括号控制逻辑运算优先级
✅ 用not排除干扰流量
✅ 从宽泛条件逐步细化
```

### 9.3 实际应用指导


**常用过滤模板**：

```bash
# Web服务问题排查
tcpdump tcp and (port 80 or port 443) and host 服务器IP

# 邮件服务监控
tcpdump tcp and port 25 and (src host 客户端IP or dst host 客户端IP)

# DNS解析问题
tcpdump udp port 53 and host DNS服务器IP

# 网络连通性检查
tcpdump icmp and host 目标IP

# 安全异常监控
tcpdump tcp[tcpflags] & tcp-rst != 0
```

**性能优化建议**：

| 过滤方式 | 性能影响 | 使用建议 |
|---------|---------|----------|
| **协议名过滤** | 🟢 影响很小 | 优先使用，如tcp、udp |
| **端口过滤** | 🟢 影响很小 | 常用且高效 |
| **IP地址过滤** | 🟡 影响中等 | 适中使用 |
| **字节访问过滤** | 🔴 影响较大 | 谨慎使用，先用基本过滤 |
| **复杂逻辑组合** | 🔴 影响较大 | 避免过于复杂的组合 |

### 9.4 常见错误避免


**🔹 过滤语法错误**
```
❌ 错误：tcpdump tcp and 80        # 缺少port关键字
✅ 正确：tcpdump tcp and port 80   

❌ 错误：tcpdump src 192.168.1.1 and dst 8.8.8.8  # 逻辑可能有问题
✅ 正确：tcpdump host 192.168.1.1 and host 8.8.8.8 # 或者明确指定src/dst
```

**🔹 逻辑运算优先级**
```
❌ 可能有歧义：tcpdump tcp and port 80 or port 443
✅ 明确优先级：tcpdump tcp and (port 80 or port 443)
```

**🔹 过滤条件过于宽泛**
```
❌ 数据量太大：tcpdump ip
✅ 精确定位：tcpdump tcp port 80 and host www.example.com
```

**核心记忆**：
- 协议分层过滤，从粗到细逐步精确
- 逻辑组合要清晰，括号明确优先级  
- 字段访问需谨慎，基本过滤为优先
- 问题定位要分层，下往上逐层排查