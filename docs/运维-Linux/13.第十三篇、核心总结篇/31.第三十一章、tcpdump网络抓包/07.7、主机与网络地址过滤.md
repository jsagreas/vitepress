---
title: 7、主机与网络地址过滤
---
## 📚 目录

1. [主机地址过滤基础](#1-主机地址过滤基础)
2. [源地址与目标地址过滤](#2-源地址与目标地址过滤)
3. [网段范围过滤详解](#3-网段范围过滤详解)
4. [地址排除与组合过滤](#4-地址排除与组合过滤)
5. [实际应用场景](#5-实际应用场景)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🎯 主机地址过滤基础


### 1.1 什么是主机过滤


**主机过滤的本质**：通过IP地址精确定位我们想要观察的网络通信对象。

就像在人群中找特定的人一样，网络中有成千上万的数据包在飞来飞去，我们需要通过IP地址这个"身份证号"来找到我们关心的那些通信。

**基本概念理解**：
- **主机（Host）**：网络中的一台设备，拥有独特的IP地址
- **过滤（Filter）**：从大量数据中筛选出我们需要的部分
- **IP地址**：就像门牌号，唯一标识网络中的设备

### 1.2 单一主机过滤语法


**核心命令格式**：
```bash
tcpdump host IP地址
```

**实际操作示例**：
```bash
# 抓取与192.168.1.100相关的所有通信
tcpdump host 192.168.1.100

# 这会捕获什么？
# ✅ 192.168.1.100发出的数据包
# ✅ 发送给192.168.1.100的数据包
# ❌ 其他主机之间的通信
```

**通俗理解**：
想象你在监控一个特定的电话号码，不管是这个号码打出去的电话，还是打给这个号码的电话，你都能听到。`host`过滤就是这个意思 - 双向监控。

### 1.3 主机过滤的工作原理


**数据包流向示意**：
```
网络中的数据包流动：

主机A          主机B          主机C
(192.168.1.1)  (192.168.1.100) (192.168.1.200)
     |              |              |
     |    数据包1    |              |
     |─────────────→|              |
     |              |    数据包2    |
     |              |─────────────→|
     |              |              |
     |    数据包3    |              |
     |←─────────────|              |

使用 tcpdump host 192.168.1.100：
✅ 捕获数据包1 (A→B)
✅ 捕获数据包3 (B→A)  
❌ 忽略数据包2 (B→C)
```

---

## 2. 🔄 源地址与目标地址过滤


### 2.1 源地址过滤 - 只看发出方


**什么是源地址过滤**：
只关注从特定IP地址**发出**的数据包，不管发给谁。

**语法格式**：
```bash
tcpdump src host IP地址
```

**实际应用**：
```bash
# 只抓取从192.168.1.100发出的数据包
tcpdump src host 192.168.1.100

# 实际含义：监控这台机器都在和谁通信
# ✅ 192.168.1.100 → 任何其他主机
# ❌ 任何主机 → 192.168.1.100
```

**现实类比**：
就像监听某个人打出去的所有电话，但不关心别人打给他的电话。

### 2.2 目标地址过滤 - 只看接收方


**什么是目标地址过滤**：
只关注发送**给特定IP地址**的数据包，不管谁发的。

**语法格式**：
```bash
tcpdump dst host IP地址
```

**实际应用**：
```bash
# 只抓取发给192.168.1.100的数据包
tcpdump dst host 192.168.1.100

# 实际含义：监控都有谁在联系这台机器
# ✅ 任何主机 → 192.168.1.100
# ❌ 192.168.1.100 → 任何其他主机
```

### 2.3 源地址与目标地址的区别对比


| 过滤类型 | **监控方向** | **实际应用场景** | **命令示例** |
|---------|------------|-----------------|-------------|
| 🔍 **host** | `双向通信` | `全面监控某台主机` | `tcpdump host 192.168.1.100` |
| 📤 **src host** | `仅发出方向` | `检查某主机的外发流量` | `tcpdump src host 192.168.1.100` |
| 📥 **dst host** | `仅接收方向` | `检查某主机的接收流量` | `tcpdump dst host 192.168.1.100` |

**典型使用场景**：

**排查网络攻击**：
```bash
# 怀疑192.168.1.50在攻击其他主机
tcpdump src host 192.168.1.50

# 怀疑192.168.1.100被攻击
tcpdump dst host 192.168.1.100
```

**监控服务器状态**：
```bash
# 监控Web服务器的访问情况
tcpdump dst host 192.168.1.200 and port 80
```

---

## 3. 🌐 网段范围过滤详解


### 3.1 什么是网段过滤


**网段的概念**：
网段就像一个小区，里面有很多房子（主机），我们可以一次性监控整个小区的通信，而不用一个房子一个房子地指定。

**为什么需要网段过滤**：
- 🎯 **批量监控**：一次监控多台主机
- 🏢 **按部门管理**：不同网段代表不同部门
- 🔍 **流量分析**：分析不同网段间的通信模式

### 3.2 CIDR记法详解


**CIDR的含义**：
CIDR（无类别域间路由）是一种表示网络地址范围的方法。

**基本格式**：
```
网络地址/子网掩码位数
```

**常见CIDR表示法对照**：

| CIDR记法 | **子网掩码** | **包含主机数** | **地址范围** |
|---------|-------------|---------------|-------------|
| `/24` | `255.255.255.0` | `254台` | `192.168.1.1-192.168.1.254` |
| `/16` | `255.255.0.0` | `65534台` | `192.168.0.1-192.168.255.254` |
| `/8` | `255.0.0.0` | `16777214台` | `10.0.0.1-10.255.255.254` |

**通俗理解**：
```
想象一个地址系统：
192.168.1.0/24 就像说：
- 前24位（192.168.1）是"街道名"
- 后8位（0-255）是"门牌号"
- 这个网段包含192.168.1.1到192.168.1.254所有房子
```

### 3.3 网段过滤语法


**基本语法**：
```bash
tcpdump net 网络地址/子网掩码位数
```

**实际应用示例**：
```bash
# 监控192.168.1.0/24网段的所有通信
tcpdump net 192.168.1.0/24

# 等价写法（传统子网掩码方式）
tcpdump net 192.168.1.0 mask 255.255.255.0
```

**网段过滤的工作示意**：
```
网络拓扑：
192.168.1.0/24 网段      192.168.2.0/24 网段
    |                        |
192.168.1.10            192.168.2.10
192.168.1.20            192.168.2.20
192.168.1.30            192.168.2.30

使用 tcpdump net 192.168.1.0/24：
✅ 捕获 192.168.1.10 → 192.168.2.10
✅ 捕获 192.168.1.20 → 192.168.1.30  
✅ 捕获 外网 → 192.168.1.10
❌ 忽略 192.168.2.10 → 192.168.2.20
```

### 3.4 源网段和目标网段过滤


**语法扩展**：
```bash
# 源网段过滤 - 只看从指定网段发出的包
tcpdump src net 192.168.1.0/24

# 目标网段过滤 - 只看发给指定网段的包
tcpdump dst net 192.168.1.0/24
```

**实际应用场景**：
```bash
# 监控内网向外网的访问
tcpdump src net 192.168.0.0/16 and not dst net 192.168.0.0/16

# 监控外网对内网的访问
tcpdump not src net 192.168.0.0/16 and dst net 192.168.0.0/16
```

---

## 4. ❌ 地址排除与组合过滤


### 4.1 地址排除技巧


**排除的概念**：
有时候我们想看除了某些主机之外的所有通信，这时候用排除比包含更方便。

**基本排除语法**：
```bash
tcpdump not host IP地址
```

**实际应用**：
```bash
# 排除本机通信，看其他所有通信
tcpdump not host 192.168.1.1

# 排除特定服务器的通信
tcpdump not host 192.168.1.100
```

**排除网段**：
```bash
# 排除整个内网，只看外网通信
tcpdump not net 192.168.0.0/16

# 排除多个网段
tcpdump not net 192.168.0.0/16 and not net 10.0.0.0/8
```

### 4.2 多主机组合过滤


**逻辑运算符**：
- **and**：同时满足多个条件
- **or**：满足任一条件
- **not**：排除条件

**多主机包含**：
```bash
# 监控两台主机的通信（任一方向）
tcpdump host 192.168.1.100 or host 192.168.1.200

# 监控两台主机之间的通信
tcpdump host 192.168.1.100 and host 192.168.1.200
```

**复杂组合示例**：
```bash
# 监控Web服务器与数据库服务器的HTTP通信
tcpdump host 192.168.1.100 and host 192.168.1.200 and port 80

# 监控除了DNS服务器外的所有通信
tcpdump not host 192.168.1.1 and not port 53
```

### 4.3 高级过滤组合


**实用组合模式**：

**监控特定服务器的外部访问**：
```bash
# 监控Web服务器与外网的通信
tcpdump host 192.168.1.100 and not net 192.168.0.0/16
```

**监控内网互访**：
```bash
# 只看内网机器之间的通信
tcpdump src net 192.168.0.0/16 and dst net 192.168.0.0/16
```

**排除噪音流量**：
```bash
# 排除SSH和SNMP监控流量
tcpdump not port 22 and not port 161 and not host 192.168.1.1
```

### 4.4 过滤条件的优先级


**括号的使用**：
```bash
# 错误的理解
tcpdump host 192.168.1.100 or host 192.168.1.200 and port 80

# 正确的写法
tcpdump (host 192.168.1.100 or host 192.168.1.200) and port 80
```

**运算优先级说明**：
```
优先级从高到低：
1. () 括号
2. not 非运算
3. and 与运算  
4. or 或运算
```

---

## 5. 🎯 实际应用场景


### 5.1 网络故障排查


**场景一：用户访问慢**
```bash
# 用户反馈192.168.1.50访问很慢
# 先看这台机器的所有通信
tcpdump host 192.168.1.50

# 进一步细化，只看Web访问
tcpdump host 192.168.1.50 and port 80

# 检查是否有异常的重传
tcpdump host 192.168.1.50 and tcp[tcpflags] & tcp-rst != 0
```

**场景二：网络攻击检测**
```bash
# 怀疑有DDoS攻击，监控Web服务器
tcpdump dst host 192.168.1.200 and port 80

# 检查是否有异常的源地址
tcpdump dst host 192.168.1.200 and port 80 | head -100
```

### 5.2 流量分析


**部门间通信分析**：
```bash
# 分析研发部门(192.168.10.0/24)与测试部门(192.168.20.0/24)的通信
tcpdump src net 192.168.10.0/24 and dst net 192.168.20.0/24
```

**服务器负载分析**：
```bash
# 分析数据库服务器的访问模式
tcpdump dst host 192.168.1.100 and port 3306
```

### 5.3 安全监控


**异常外联检测**：
```bash
# 监控内网主机访问外网的异常端口
tcpdump src net 192.168.0.0/16 and not dst net 192.168.0.0/16 and not port 80 and not port 443
```

**内网横向移动检测**：
```bash
# 监控一台主机访问多台内网主机（可能的横向移动）
tcpdump src host 192.168.1.50 and dst net 192.168.0.0/16
```

### 5.4 性能调优


**带宽使用分析**：
```bash
# 找出流量最大的主机通信
tcpdump -n -c 1000 net 192.168.0.0/16 | \
awk '{print $3 " " $5}' | sort | uniq -c | sort -nr | head -10
```

**连接质量检查**：
```bash
# 检查特定主机的TCP重传情况
tcpdump host 192.168.1.100 and tcp[tcpflags] & tcp-rst != 0
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的核心命令


```bash
# 🎯 基础过滤
tcpdump host 192.168.1.100           # 双向监控单一主机
tcpdump src host 192.168.1.100       # 只看发出的包
tcpdump dst host 192.168.1.100       # 只看接收的包

# 🌐 网段过滤
tcpdump net 192.168.1.0/24           # 监控整个网段
tcpdump src net 192.168.0.0/16       # 源网段过滤
tcpdump dst net 192.168.0.0/16       # 目标网段过滤

# ❌ 排除过滤
tcpdump not host 192.168.1.1         # 排除单一主机
tcpdump not net 192.168.0.0/16       # 排除网段
```

### 6.2 关键理解要点


**🔹 过滤方向的含义**
```
host     = 双向通信（发出+接收）
src host = 只看发出方向
dst host = 只看接收方向

记忆技巧：
src = source = 源头 = 发出
dst = destination = 目的地 = 接收
```

**🔹 网段表示法**
```
192.168.1.0/24 表示：
- 网络部分：192.168.1（前24位）
- 主机部分：0-255（后8位）
- 实际主机：192.168.1.1 到 192.168.1.254

常用网段：
/24 = 255.255.255.0   （254台主机）
/16 = 255.255.0.0     （65534台主机）
/8  = 255.0.0.0       （16777214台主机）
```

**🔹 逻辑运算优先级**
```
从高到低：
1. ()  括号最优先
2. not 非运算
3. and 与运算
4. or  或运算

实际使用建议：多用括号明确逻辑关系
```

### 6.3 实际应用价值


**网络故障排查**：
- 🔍 快速定位问题主机的通信状况
- 📊 分析流量方向和异常模式
- ⚡ 实时监控关键服务器状态

**安全监控**：
- 🛡️ 检测异常的外联行为
- 👀 监控可疑主机的活动
- 🚨 发现潜在的攻击模式

**性能调优**：
- 📈 分析网络流量分布
- 🎯 识别高负载通信路径
- ⚖️ 评估网络带宽使用情况

**核心记忆口诀**：
```
host看双向，src看发出dst看收
net加斜杠，网段范围一网收
not来排除，and和or来组合
括号明逻辑，过滤精准不出错
```

### 6.4 进阶学习建议


**掌握程度检验**：
- ✅ 能写出监控特定主机的命令
- ✅ 理解CIDR网段表示法
- ✅ 会组合多个过滤条件
- ✅ 能根据实际需求设计过滤策略

**下一步学习方向**：
- 📡 端口过滤与协议分析
- 🔍 数据包内容过滤
- 📊 流量统计与分析工具
- 🛠️ 自动化网络监控脚本