---
title: 5、过滤表达式基础语法
---
## 📚 目录

1. [BPF过滤表达式概述](#1-BPF过滤表达式概述)
2. [协议过滤语法详解](#2-协议过滤语法详解)
3. [主机地址过滤操作](#3-主机地址过滤操作)
4. [端口过滤精确控制](#4-端口过滤精确控制)
5. [网段过滤批量抓包](#5-网段过滤批量抓包)
6. [逻辑运算符组合技巧](#6-逻辑运算符组合技巧)
7. [括号优先级与复杂表达式](#7-括号优先级与复杂表达式)
8. [实用过滤表达式案例](#8-实用过滤表达式案例)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔍 BPF过滤表达式概述


### 1.1 什么是BPF过滤表达式


**BPF (Berkeley Packet Filter)** 是tcpdump的过滤引擎，它让我们能够精确指定要抓取哪些数据包。

> 💡 **通俗理解**：就像在茫茫人海中找特定的人，BPF表达式就是你的"查找条件"

**核心作用**：
- 🎯 **精确筛选** - 只抓取我们需要的数据包
- ⚡ **提升效率** - 减少无关数据的干扰
- 💾 **节省空间** - 避免存储大量无用信息

### 1.2 BPF表达式的基本构成


```
基本语法结构：
[方向] [协议] [主机/端口] [逻辑运算符] [其他条件]

示例：
src host 192.168.1.100 and tcp port 80
```

**语法特点**：
- **方向性** - `src`源、`dst`目标
- **层次性** - 协议层、网络层、传输层
- **逻辑性** - 支持`and`、`or`、`not`组合

---

## 2. 🌐 协议过滤语法详解


### 2.1 三大核心协议过滤


**TCP协议过滤**

```bash
# 抓取所有TCP数据包
tcpdump tcp

# 抓取TCP SYN包（建立连接）
tcpdump 'tcp[tcpflags] & tcp-syn != 0'
```

**UDP协议过滤**

```bash
# 抓取所有UDP数据包
tcpdump udp

# 抓取DNS查询（UDP 53端口）
tcpdump udp port 53
```

**ICMP协议过滤**

```bash
# 抓取所有ICMP数据包（ping命令）
tcpdump icmp

# 抓取ping请求
tcpdump 'icmp[icmptype] = icmp-echo'
```

### 2.2 协议过滤实际应用


| 协议类型 | **使用场景** | **常用命令** | **说明** |
|---------|-------------|-------------|----------|
| **TCP** | `网页访问、文件传输` | `tcpdump tcp` | `可靠传输协议` |
| **UDP** | `DNS查询、视频流` | `tcpdump udp` | `快速传输协议` |
| **ICMP** | `网络诊断、ping测试` | `tcpdump icmp` | `网络控制协议` |

### 2.3 协议组合过滤


```bash
# 同时抓取TCP和UDP
tcpdump tcp or udp

# 排除ICMP流量
tcpdump not icmp

# 只要HTTP流量（TCP 80端口）
tcpdump tcp port 80
```

---

## 3. 🏠 主机地址过滤操作


### 3.1 主机过滤基础语法


**`host` - 双向流量过滤**

```bash
# 抓取与指定主机的所有通信
tcpdump host 192.168.1.100

# 抓取与百度服务器的通信
tcpdump host baidu.com
```

**`src host` - 源地址过滤**

```bash
# 只抓取来自192.168.1.100的数据包
tcpdump src host 192.168.1.100
```

**`dst host` - 目标地址过滤**

```bash
# 只抓取发往192.168.1.100的数据包
tcpdump dst host 192.168.1.100
```

### 3.2 主机过滤方向说明


```
网络通信方向图：

本机 ←------ src host A ------- A主机
本机 ------> dst host B ------→ B主机
本机 ←-----  host C    ------→ C主机（双向）

src：数据包的来源
dst：数据包的目标  
host：不区分方向，双向抓取
```

### 3.3 多主机过滤技巧


```bash
# 抓取多个主机的流量
tcpdump host 192.168.1.100 or host 192.168.1.200

# 排除特定主机
tcpdump not host 192.168.1.100

# 抓取两个主机之间的通信
tcpdump host 192.168.1.100 and host 192.168.1.200
```

---

## 4. 🚪 端口过滤精确控制


### 4.1 端口过滤基本用法


**`port` - 双向端口过滤**

```bash
# 抓取80端口的所有流量（HTTP）
tcpdump port 80

# 抓取22端口的所有流量（SSH）
tcpdump port 22
```

**`src port` - 源端口过滤**

```bash
# 抓取来源端口为80的数据包
tcpdump src port 80
```

**`dst port` - 目标端口过滤**

```bash
# 抓取目标端口为443的数据包（HTTPS）
tcpdump dst port 443
```

### 4.2 常用端口对照表


| 端口号 | **协议** | **服务** | **过滤命令** |
|-------|----------|---------|-------------|
| **22** | `SSH` | `远程登录` | `tcpdump port 22` |
| **53** | `DNS` | `域名解析` | `tcpdump port 53` |
| **80** | `HTTP` | `网页访问` | `tcpdump port 80` |
| **443** | `HTTPS` | `安全网页` | `tcpdump port 443` |
| **3306** | `MySQL` | `数据库` | `tcpdump port 3306` |

### 4.3 端口范围和组合过滤


```bash
# 端口范围过滤
tcpdump portrange 1000-2000

# 多端口过滤
tcpdump port 80 or port 443

# 排除特定端口
tcpdump not port 22

# 协议+端口组合
tcpdump tcp port 80
```

### 4.4 端口过滤实际场景


```
Web服务器流量分析：
┌─────────────┐    HTTP(80)     ┌──────────────┐
│   客户端     │ ──────────────→ │  Web服务器    │
│             │ ←────────────── │              │
└─────────────┘    HTTPS(443)   └──────────────┘

命令：tcpdump port 80 or port 443
作用：抓取所有Web访问流量
```

---

## 5. 🌍 网段过滤批量抓包


### 5.1 网段过滤语法


**`net` - 网络地址过滤**

```bash
# 抓取整个C类网段
tcpdump net 192.168.1.0/24

# 抓取B类网段
tcpdump net 192.168.0.0/16
```

**`subnet` - 子网掩码方式**

```bash
# 使用子网掩码表示
tcpdump net 192.168.1.0 mask 255.255.255.0
```

### 5.2 网段表示方法对比


| **表示方法** | **语法** | **含义** | **IP范围** |
|-------------|---------|----------|-----------|
| **CIDR** | `192.168.1.0/24` | `C类网段` | `192.168.1.1-254` |
| **掩码** | `192.168.1.0 mask 255.255.255.0` | `C类网段` | `192.168.1.1-254` |
| **B类** | `192.168.0.0/16` | `B类网段` | `192.168.*.1-254` |

### 5.3 网段过滤实际应用


```bash
# 监控内网流量
tcpdump net 192.168.0.0/16

# 监控特定部门网段
tcpdump net 10.1.100.0/24

# 排除本地网段，只看外网流量
tcpdump not net 192.168.0.0/16
```

### 5.4 网段过滤场景示意


```
企业网络拓扑：
                    Internet
                        │
                   ┌────┴────┐
                   │ 路由器   │
                   └────┬────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
   192.168.1.0/24  192.168.2.0/24  192.168.3.0/24
    ┌─────────┐    ┌─────────┐    ┌─────────┐
    │ 开发部   │    │ 财务部   │    │ 市场部   │
    └─────────┘    └─────────┘    └─────────┘

监控开发部流量：tcpdump net 192.168.1.0/24
```

---

## 6. 🔗 逻辑运算符组合技巧


### 6.1 三大逻辑运算符


**`and` - 逻辑与（同时满足）**

```bash
# 同时满足主机和端口条件
tcpdump host 192.168.1.100 and port 80

# TCP协议且80端口
tcpdump tcp and port 80
```

**`or` - 逻辑或（满足其一）**

```bash
# 80端口或443端口
tcpdump port 80 or port 443

# HTTP或HTTPS流量
tcpdump tcp port 80 or tcp port 443
```

**`not` - 逻辑非（排除条件）**

```bash
# 排除SSH流量
tcpdump not port 22

# 排除本地回环
tcpdump not host 127.0.0.1
```

### 6.2 逻辑运算符优先级


```
优先级从高到低：
1. () 括号
2. not 非
3. and 与  
4. or 或

示例理解：
A or B and C  等价于  A or (B and C)
not A and B   等价于  (not A) and B
```

### 6.3 复合条件实战案例


```bash
# 案例1：监控Web服务器异常
tcpdump host 192.168.1.100 and (port 80 or port 443) and not icmp

# 案例2：排除内网，只看外网流量
tcpdump not net 192.168.0.0/16 and not net 10.0.0.0/8

# 案例3：监控数据库访问
tcpdump (host db1.example.com or host db2.example.com) and port 3306
```

### 6.4 逻辑组合最佳实践


| **场景** | **表达式** | **说明** |
|---------|-----------|----------|
| **Web流量** | `port 80 or port 443` | `HTTP和HTTPS` |
| **排除SSH** | `not port 22` | `避免管理流量干扰` |
| **内网通信** | `net 192.168.0.0/16` | `局域网流量` |
| **特定主机Web访问** | `host 1.2.3.4 and (port 80 or port 443)` | `精确定位` |

---

## 7. 📐 括号优先级与复杂表达式


### 7.1 括号的重要性


**为什么需要括号？**

```bash
# 不使用括号 - 可能产生歧义
tcpdump host A or host B and port 80

# 实际含义：host A or (host B and port 80)
# 可能的误解：(host A or host B) and port 80
```

**使用括号明确意图**

```bash
# 明确表达：A主机的所有流量 OR B主机的80端口流量
tcpdump host A or (host B and port 80)

# 明确表达：(A主机 OR B主机) 的80端口流量
tcpdump (host A or host B) and port 80
```

### 7.2 复杂表达式构建技巧


**分层构建法**

```
第一层：基础条件
host 192.168.1.100
port 80
tcp

第二层：逻辑组合  
(host 192.168.1.100 and port 80)
(tcp and port 443)

第三层：条件合并
(host 192.168.1.100 and port 80) or (tcp and port 443)
```

**实际构建示例**

```bash
# 监控Web服务器集群
tcpdump (host web1.example.com or host web2.example.com or host web3.example.com) and (port 80 or port 443)

# 排除管理流量，只看业务流量
tcpdump not (port 22 or port 161 or host monitor.example.com)

# 监控数据库集群的特定操作
tcpdump (host db-master or host db-slave) and port 3306 and not icmp
```

### 7.3 表达式可读性优化


```bash
# 不好的写法 - 难以理解
tcpdump host A and port 80 or host B and port 443 or host C and port 22

# 好的写法 - 清晰易懂  
tcpdump (host A and port 80) or (host B and port 443) or (host C and port 22)

# 更好的写法 - 按业务逻辑分组
tcpdump (host A and port 80) or \
        (host B and port 443) or \
        (host C and port 22)
```

---

## 8. 💼 实用过滤表达式案例


### 8.1 Web服务器监控


```bash
# HTTP/HTTPS流量监控
tcpdump 'port 80 or port 443'

# 特定Web服务器的访问流量
tcpdump 'host webserver.com and (port 80 or port 443)'

# 排除静态资源，只看动态请求
tcpdump 'port 80 and not (src port 80)'
```

### 8.2 数据库连接分析


```bash
# MySQL数据库连接
tcpdump 'port 3306'

# 特定数据库服务器
tcpdump 'host db.example.com and port 3306'

# 监控数据库集群
tcpdump '(host db1 or host db2 or host db3) and port 3306'
```

### 8.3 网络故障诊断


```bash
# DNS解析问题
tcpdump 'port 53'

# 网络连通性测试
tcpdump 'icmp'

# ARP广播分析
tcpdump 'arp'

# 检查TCP连接建立
tcpdump 'tcp[tcpflags] & (tcp-syn|tcp-fin) != 0'
```

### 8.4 安全监控场景


```bash
# SSH登录监控
tcpdump 'port 22'

# 可疑端口扫描
tcpdump 'tcp[tcpflags] & tcp-syn != 0 and tcp[tcpflags] & tcp-ack = 0'

# 监控特定IP的所有活动
tcpdump 'host 192.168.1.100'

# 排除正常流量，关注异常
tcpdump 'not (port 80 or port 443 or port 22)'
```

### 8.5 性能优化分析


```bash
# 大包传输监控
tcpdump 'greater 1000'

# 小包密集传输
tcpdump 'less 100'

# 重传包检测
tcpdump 'tcp[tcpflags] & tcp-rst != 0'
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 BPF表达式：tcpdump的核心过滤机制，精确筛选数据包
🔸 协议过滤：tcp、udp、icmp三大协议的基础过滤语法  
🔸 主机过滤：host、src host、dst host的方向性理解
🔸 端口过滤：port、src port、dst port的精确控制
🔸 网段过滤：net和subnet的批量抓包能力
🔸 逻辑运算：and、or、not的组合使用技巧
🔸 优先级控制：括号在复杂表达式中的关键作用
```

### 9.2 关键理解要点


**🔹 方向性的重要性**
```
src - 数据包的来源方向
dst - 数据包的目标方向  
无方向 - 双向流量都抓取

理解方向性有助于精确定位问题源头
```

**🔹 逻辑运算的实际应用**
```
and - 缩小范围，精确定位
or  - 扩大范围，全面覆盖
not - 排除干扰，专注目标

合理使用逻辑运算能显著提高抓包效率
```

**🔹 括号优先级的必要性**
```
复杂表达式中，括号能避免歧义
按业务逻辑分组，提高可读性
分层构建复杂条件，降低出错率
```

### 9.3 实际应用指导


**💡 新手建议**
- 从简单表达式开始，逐步增加复杂度
- 先测试基础条件，再组合复杂逻辑
- 使用 `-c` 参数限制抓包数量进行测试

**🚀 进阶技巧**
- 结合 `grep` 命令进行二次过滤
- 使用 `-w` 保存文件，`-r` 读取分析
- 学会读懂抓包输出，理解数据包结构

**⚠️ 常见陷阱**
- 忘记使用括号导致逻辑错误
- 方向性混淆（src/dst）  
- 协议和端口不匹配（如udp port 80）

**核心记忆口诀**：
- 协议主机端口网段，方向逻辑要分清
- 括号优先级最高，复杂表达式不出错  
- 先简后繁测试好，抓包分析效率高