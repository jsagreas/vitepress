---
title: 9ã€è™šæ‹Ÿæœºè¿ç§»æŠ€æœ¯
---
## ğŸ“š ç›®å½•

1. [è™šæ‹Ÿæœºè¿ç§»æ¦‚è¿°](#1-è™šæ‹Ÿæœºè¿ç§»æ¦‚è¿°)
2. [ç¦»çº¿è¿ç§»æ“ä½œæµç¨‹](#2-ç¦»çº¿è¿ç§»æ“ä½œæµç¨‹)
3. [åœ¨çº¿çƒ­è¿ç§»æŠ€æœ¯å®ç°](#3-åœ¨çº¿çƒ­è¿ç§»æŠ€æœ¯å®ç°)
4. [è¿ç§»å‰ç½®æ¡ä»¶æ£€æŸ¥](#4-è¿ç§»å‰ç½®æ¡ä»¶æ£€æŸ¥)
5. [å…±äº«å­˜å‚¨è¿ç§»é…ç½®](#5-å…±äº«å­˜å‚¨è¿ç§»é…ç½®)
6. [è·¨ä¸»æœºè¿ç§»ç½‘ç»œè¦æ±‚](#6-è·¨ä¸»æœºè¿ç§»ç½‘ç»œè¦æ±‚)
7. [è¿ç§»æ•…éšœæ’æŸ¥æ–¹æ³•](#7-è¿ç§»æ•…éšœæ’æŸ¥æ–¹æ³•)
8. [è¿ç§»æ€§èƒ½ä¼˜åŒ–](#8-è¿ç§»æ€§èƒ½ä¼˜åŒ–)
9. [è¿ç§»å®‰å…¨è€ƒè™‘](#9-è¿ç§»å®‰å…¨è€ƒè™‘)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ è™šæ‹Ÿæœºè¿ç§»æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯è™šæ‹Ÿæœºè¿ç§»


**è™šæ‹Ÿæœºè¿ç§»**å°±æ˜¯æŠŠæ­£åœ¨è¿è¡Œçš„è™šæ‹Ÿæœºä»ä¸€å°ç‰©ç†æœåŠ¡å™¨æ¬åˆ°å¦ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šï¼Œå°±åƒæ¬å®¶ä¸€æ ·ã€‚

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ åœ¨ç”µè„‘ä¸Šç©æ¸¸æˆï¼Œçªç„¶éœ€è¦æ¢åˆ°å¦ä¸€å°ç”µè„‘ç»§ç»­ç©ï¼Œè™šæ‹Ÿæœºè¿ç§»å°±æ˜¯è®©ä½ çš„"æ¸¸æˆ"å¯ä»¥æ— ç¼è½¬ç§»è¿‡å»

```
è¿ç§»å‰çŠ¶æ€ï¼š
ç‰©ç†æœºA: [è™šæ‹Ÿæœº1] [è™šæ‹Ÿæœº2] [è™šæ‹Ÿæœº3]
ç‰©ç†æœºB: [è™šæ‹Ÿæœº4] [è™šæ‹Ÿæœº5]

è¿ç§»åçŠ¶æ€ï¼š
ç‰©ç†æœºA: [è™šæ‹Ÿæœº1] [è™šæ‹Ÿæœº3]
ç‰©ç†æœºB: [è™šæ‹Ÿæœº4] [è™šæ‹Ÿæœº5] [è™šæ‹Ÿæœº2]  â† è¿ç§»è¿‡æ¥çš„
```

### 1.2 è¿ç§»çš„åˆ†ç±»


**æŒ‰åœæœºæ—¶é—´åˆ†ç±»ï¼š**

| è¿ç§»ç±»å‹ | **åœæœºæ—¶é—´** | **é€‚ç”¨åœºæ™¯** | **æŠ€æœ¯éš¾åº¦** |
|---------|------------|-------------|-------------|
| ğŸ”´ **ç¦»çº¿è¿ç§»** | `éœ€è¦å…³æœº` | ç»´æŠ¤çª—å£æœŸé—´ | â­â­â˜†â˜†â˜† |
| ğŸŸ¢ **åœ¨çº¿çƒ­è¿ç§»** | `å‡ ä¹æ— åœæœº` | ç”Ÿäº§ç¯å¢ƒ | â­â­â­â­â­ |

**æŒ‰å­˜å‚¨æ–¹å¼åˆ†ç±»ï¼š**
- **å…±äº«å­˜å‚¨è¿ç§»**ï¼šè™šæ‹Ÿæœºç£ç›˜æ”¾åœ¨å…±äº«å­˜å‚¨ä¸Š
- **æœ¬åœ°å­˜å‚¨è¿ç§»**ï¼šè™šæ‹Ÿæœºç£ç›˜åœ¨æœ¬åœ°ï¼Œéœ€è¦ä¸€èµ·æ¬

### 1.3 è¿ç§»çš„åº”ç”¨åœºæ™¯


**ğŸ”§ ç¡¬ä»¶ç»´æŠ¤**
- ç‰©ç†æœºéœ€è¦æ›´æ¢ç¡¬ä»¶
- ç³»ç»Ÿå‡çº§æˆ–æ‰“è¡¥ä¸
- é¢„é˜²æ€§ç»´æŠ¤

**âš–ï¸ è´Ÿè½½å‡è¡¡**
- æŸå°æœºå™¨è´Ÿè½½è¿‡é«˜
- èµ„æºåˆ†é…ä¸å‡è¡¡
- åŠ¨æ€è°ƒæ•´èµ„æº

**ğŸš¨ æ•…éšœæ¢å¤**
- ç¡¬ä»¶å³å°†æ•…éšœ
- ä¸»æœºæ€§èƒ½ä¸‹é™
- ç´§æ€¥é¿é™©

---

## 2. ğŸ“‹ ç¦»çº¿è¿ç§»æ“ä½œæµç¨‹


### 2.1 ç¦»çº¿è¿ç§»çš„å·¥ä½œåŸç†


**ç¦»çº¿è¿ç§»**å°±æ˜¯å…ˆæŠŠè™šæ‹Ÿæœºå…³æœºï¼Œç„¶åæŠŠå®ƒçš„æ‰€æœ‰æ–‡ä»¶æ¬åˆ°æ–°æœºå™¨ä¸Šï¼Œå†å¼€æœºã€‚

```
ç¦»çº¿è¿ç§»æµç¨‹å›¾ï¼š
æºä¸»æœº                           ç›®æ ‡ä¸»æœº
   â”‚                              â”‚
   â–¼                              â”‚
1. å…³é—­è™šæ‹Ÿæœº                      â”‚
   â”‚                              â”‚
   â–¼                              â”‚
2. å¤åˆ¶è™šæ‹Ÿæœºæ–‡ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ 3. æ¥æ”¶æ–‡ä»¶
   â”‚                              â”‚
   â–¼                              â–¼
4. åˆ é™¤æºæ–‡ä»¶                   5. å¯åŠ¨è™šæ‹Ÿæœº
```

> ğŸ“– **æ¦‚å¿µ**ï¼šç¦»çº¿è¿ç§»ç±»ä¼¼äº"æ‰“åŒ…æ¬å®¶"ï¼Œéœ€è¦å…ˆåœæ­¢æœåŠ¡ï¼Œæ‰“åŒ…æ‰€æœ‰ä¸œè¥¿ï¼Œæ¬åˆ°æ–°åœ°æ–¹ï¼Œå†é‡æ–°å¼€å§‹

### 2.2 ç¦»çº¿è¿ç§»æ“ä½œæ­¥éª¤


**æ­¥éª¤1ï¼šè™šæ‹Ÿæœºå…³æœº**
```bash
# ä¼˜é›…å…³æœº
virsh shutdown vm-name

# å¼ºåˆ¶å…³æœºï¼ˆç´§æ€¥æƒ…å†µï¼‰
virsh destroy vm-name

# ç¡®è®¤å…³æœºçŠ¶æ€
virsh list --all
```

**æ­¥éª¤2ï¼šå¯¼å‡ºè™šæ‹Ÿæœºé…ç½®**
```bash
# å¯¼å‡ºXMLé…ç½®æ–‡ä»¶
virsh dumpxml vm-name > /tmp/vm-name.xml

# æŸ¥çœ‹è™šæ‹Ÿæœºç£ç›˜ä½ç½®
virsh domblklist vm-name
```

**æ­¥éª¤3ï¼šå¤åˆ¶è™šæ‹Ÿæœºæ–‡ä»¶**
```bash
# å¤åˆ¶ç£ç›˜é•œåƒæ–‡ä»¶
scp /var/lib/libvirt/images/vm-name.qcow2 root@target-host:/var/lib/libvirt/images/

# å¤åˆ¶é…ç½®æ–‡ä»¶
scp /tmp/vm-name.xml root@target-host:/tmp/
```

**æ­¥éª¤4ï¼šåœ¨ç›®æ ‡ä¸»æœºå¯¼å…¥**
```bash
# åœ¨ç›®æ ‡ä¸»æœºä¸Šå¯¼å…¥è™šæ‹Ÿæœº
virsh define /tmp/vm-name.xml

# å¯åŠ¨è™šæ‹Ÿæœº
virsh start vm-name
```

### 2.3 ç¦»çº¿è¿ç§»çš„ä¼˜ç¼ºç‚¹


**âœ… ä¼˜ç‚¹ï¼š**
- æ“ä½œç®€å•ï¼Œä¸å®¹æ˜“å‡ºé”™
- å¯¹ç½‘ç»œè¦æ±‚ä¸é«˜
- è¿ç§»è¿‡ç¨‹å¯æ§æ€§å¼º

**âŒ ç¼ºç‚¹ï¼š**
- éœ€è¦åœæœºï¼Œå½±å“ä¸šåŠ¡
- å¤§ç£ç›˜æ–‡ä»¶ä¼ è¾“è€—æ—¶é•¿
- ä¸é€‚åˆ7Ã—24å°æ—¶æœåŠ¡

---

## 3. ğŸ”¥ åœ¨çº¿çƒ­è¿ç§»æŠ€æœ¯å®ç°


### 3.1 çƒ­è¿ç§»çš„å·¥ä½œåŸç†


**åœ¨çº¿çƒ­è¿ç§»**å°±æ˜¯åœ¨è™šæ‹Ÿæœºæ­£å¸¸è¿è¡Œæ—¶ï¼ŒæŠŠå®ƒ"æ¬"åˆ°å¦ä¸€å°æœºå™¨ä¸Šï¼Œæ•´ä¸ªè¿‡ç¨‹ç”¨æˆ·å‡ ä¹æ„Ÿè§‰ä¸åˆ°ã€‚

> ğŸš€ **è¿›é˜¶æ¦‚å¿µ**ï¼šçƒ­è¿ç§»åƒæ˜¯åœ¨é«˜é€Ÿè¡Œé©¶ä¸­æ¢è½®èƒï¼Œéœ€è¦é«˜è¶…çš„æŠ€æœ¯ä¿è¯è¿‡ç¨‹ä¸­ä¸åœè½¦

```
çƒ­è¿ç§»æŠ€æœ¯æ¶æ„ï¼š
â”Œâ”€ æºä¸»æœº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€ ç›®æ ‡ä¸»æœº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â”‚    â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   è™šæ‹Ÿæœº    â”‚â—„â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â–¶â”‚   è™šæ‹Ÿæœº    â”‚    â”‚
â”‚  â”‚             â”‚    â”‚    â”‚  â”‚  (å‰¯æœ¬)     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                     â”‚    â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  å†…å­˜çŠ¶æ€   â”‚â—„â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â–¶â”‚  å†…å­˜çŠ¶æ€   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                            â–²
         â””â”€â”€â”€â”€ å…±äº«å­˜å‚¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 çƒ­è¿ç§»çš„ä¸‰ä¸ªé˜¶æ®µ


**ğŸ”„ é˜¶æ®µ1ï¼šé¢„æ‹·è´ï¼ˆPre-copyï¼‰**
- è™šæ‹Ÿæœºç»§ç»­è¿è¡Œ
- å¼€å§‹å¤åˆ¶å†…å­˜é¡µé¢åˆ°ç›®æ ‡ä¸»æœº
- æ ‡è®°è¢«ä¿®æ”¹çš„å†…å­˜é¡µé¢

**âš¡ é˜¶æ®µ2ï¼šåœæ­¢å¹¶å¤åˆ¶ï¼ˆStop-and-copyï¼‰**
- æš‚åœè™šæ‹Ÿæœºï¼ˆå‡ æ¯«ç§’åˆ°å‡ ç§’ï¼‰
- å¤åˆ¶å‰©ä½™çš„è„é¡µé¢
- è½¬ç§»CPUçŠ¶æ€

**ğŸš€ é˜¶æ®µ3ï¼šæ¿€æ´»ç›®æ ‡**
- åœ¨ç›®æ ‡ä¸»æœºå¯åŠ¨è™šæ‹Ÿæœº
- æºä¸»æœºæ¸…ç†èµ„æº
- å®Œæˆè¿ç§»è¿‡ç¨‹

```
çƒ­è¿ç§»æ—¶åºå›¾ï¼š
æºè™šæ‹Ÿæœº    ç›®æ ‡è™šæ‹Ÿæœº    å…±äº«å­˜å‚¨
    â”‚           â”‚           â”‚
    â”œâ”€è¿è¡Œä¸­â”€â”€â”€â”€â”¤           â”‚
    â”‚           â”‚           â”‚
    â”œâ”€å¤åˆ¶å†…å­˜â”€â”€â–¶           â”‚
    â”‚           â”œâ”€æ¥æ”¶å†…å­˜â”€â”€â”¤
    â”‚           â”‚           â”‚
    â”œâ”€æš‚åœâ”€â”€â”€â”€â”€â”€â”¤           â”‚
    â”œâ”€æœ€ç»ˆåŒæ­¥â”€â”€â–¶           â”‚
    â”‚           â”œâ”€å¯åŠ¨â”€â”€â”€â”€â”€â”€â”¤
    â”œâ”€æ¸…ç†â”€â”€â”€â”€â”€â”€â”¤           â”‚
    â”‚           â”œâ”€è¿è¡Œä¸­â”€â”€â”€â”€â”¤
```

### 3.3 çƒ­è¿ç§»å‘½ä»¤æ“ä½œ


**åŸºæœ¬çƒ­è¿ç§»å‘½ä»¤ï¼š**
```bash
# åŸºæœ¬çƒ­è¿ç§»
virsh migrate --live vm-name qemu+ssh://target-host/system

# å¸¦å‚æ•°çš„çƒ­è¿ç§»
virsh migrate --live --persistent --undefinesource \
  vm-name qemu+ssh://target-host/system

# æŸ¥çœ‹è¿ç§»çŠ¶æ€
virsh migrate-getmaxdowntime vm-name
```

**é«˜çº§è¿ç§»é€‰é¡¹ï¼š**
- `--live`: åœ¨çº¿è¿ç§»
- `--persistent`: è¿ç§»åä¿æŒæŒä¹…åŒ–
- `--undefinesource`: è¿ç§»æˆåŠŸååˆ é™¤æºå®šä¹‰
- `--timeout`: è®¾ç½®è¶…æ—¶æ—¶é—´
- `--bandwidth`: é™åˆ¶è¿ç§»å¸¦å®½

---

## 4. âœ… è¿ç§»å‰ç½®æ¡ä»¶æ£€æŸ¥


### 4.1 ç¡¬ä»¶å…¼å®¹æ€§æ£€æŸ¥


**CPUå…¼å®¹æ€§**
```bash
# æ£€æŸ¥CPUå‹å·å’Œç‰¹æ€§
cat /proc/cpuinfo | grep "model name\|flags"

# æ£€æŸ¥è™šæ‹ŸåŒ–æ”¯æŒ
egrep -c '(vmx|svm)' /proc/cpuinfo

# æ£€æŸ¥CPUæ‹“æ‰‘ç»“æ„
lscpu
```

> âš ï¸ **æ³¨æ„**ï¼šæºä¸»æœºå’Œç›®æ ‡ä¸»æœºçš„CPUå¿…é¡»å…¼å®¹ï¼Œå¦åˆ™è™šæ‹Ÿæœºå¯èƒ½æ— æ³•å¯åŠ¨

**å†…å­˜å®¹é‡æ£€æŸ¥**
```bash
# æ£€æŸ¥å¯ç”¨å†…å­˜
free -h

# æ£€æŸ¥è™šæ‹Ÿæœºå†…å­˜ä½¿ç”¨
virsh dommemstat vm-name
```

### 4.2 è½¯ä»¶ç¯å¢ƒæ£€æŸ¥


**KVMç‰ˆæœ¬å…¼å®¹æ€§**
```bash
# æ£€æŸ¥KVMç‰ˆæœ¬
qemu-kvm --version

# æ£€æŸ¥libvirtç‰ˆæœ¬  
libvirtd --version

# æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬
uname -r
```

**ç½‘ç»œé…ç½®æ£€æŸ¥**
```bash
# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping target-host

# æ£€æŸ¥SSHè¿æ¥
ssh root@target-host "echo 'Connection OK'"

# æ£€æŸ¥libvirtè¿æ¥
virsh -c qemu+ssh://target-host/system list
```

### 4.3 æƒé™å’Œè®¤è¯æ£€æŸ¥


**SSHå¯†é’¥é…ç½®**
```bash
# ç”ŸæˆSSHå¯†é’¥å¯¹
ssh-keygen -t rsa

# å¤åˆ¶å…¬é’¥åˆ°ç›®æ ‡ä¸»æœº
ssh-copy-id root@target-host

# æµ‹è¯•å…å¯†ç™»å½•
ssh root@target-host
```

**å­˜å‚¨è®¿é—®æƒé™**
```bash
# æ£€æŸ¥å­˜å‚¨æŒ‚è½½çŠ¶æ€
df -h | grep /shared-storage

# æµ‹è¯•æ–‡ä»¶è¯»å†™æƒé™
touch /shared-storage/test.tmp
rm /shared-storage/test.tmp
```

---

## 5. ğŸ’¾ å…±äº«å­˜å‚¨è¿ç§»é…ç½®


### 5.1 å…±äº«å­˜å‚¨çš„ä½œç”¨


**å…±äº«å­˜å‚¨**å°±æ˜¯å¤šå°ç‰©ç†æœºéƒ½èƒ½è®¿é—®çš„å­˜å‚¨ç©ºé—´ï¼Œå°±åƒä¸€ä¸ªæ‰€æœ‰äººéƒ½èƒ½æ‰“å¼€çš„å…¬å…±ä¿é™©ç®±ã€‚

```
å…±äº«å­˜å‚¨æ¶æ„å›¾ï¼š
  ç‰©ç†æœºA          ç‰©ç†æœºB          ç‰©ç†æœºC
     â”‚                â”‚                â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   å…±äº«å­˜å‚¨     â”‚
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
              â”‚  â”‚VM1ç£ç›˜ â”‚  â”‚
              â”‚  â”‚VM2ç£ç›˜ â”‚  â”‚  â† æ‰€æœ‰ä¸»æœºéƒ½èƒ½è®¿é—®
              â”‚  â”‚VM3ç£ç›˜ â”‚  â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 NFSå…±äº«å­˜å‚¨é…ç½®


**NFSæœåŠ¡å™¨é…ç½®**
```bash
# å®‰è£…NFSæœåŠ¡
yum install -y nfs-utils

# é…ç½®å…±äº«ç›®å½•
echo "/shared-storage *(rw,sync,no_root_squash)" >> /etc/exports

# å¯åŠ¨NFSæœåŠ¡
systemctl start nfs-server
systemctl enable nfs-server

# å¯¼å‡ºå…±äº«ç›®å½•
exportfs -a
```

**NFSå®¢æˆ·ç«¯é…ç½®**
```bash
# å®‰è£…NFSå®¢æˆ·ç«¯
yum install -y nfs-utils

# åˆ›å»ºæŒ‚è½½ç‚¹
mkdir -p /var/lib/libvirt/images/shared

# æŒ‚è½½NFS
mount -t nfs nfs-server:/shared-storage /var/lib/libvirt/images/shared

# è®¾ç½®å¼€æœºè‡ªåŠ¨æŒ‚è½½
echo "nfs-server:/shared-storage /var/lib/libvirt/images/shared nfs defaults 0 0" >> /etc/fstab
```

### 5.3 iSCSIå…±äº«å­˜å‚¨é…ç½®


**iSCSI Targeté…ç½®**
```bash
# å®‰è£…targetcli
yum install -y targetcli

# é…ç½®å­˜å‚¨åç«¯
targetcli
> /backstores/block create shared-disk /dev/sdb
> /iscsi create iqn.2024-01.com.example:shared-storage
> /iscsi/iqn.2024-01.com.example:shared-storage/tpg1/luns create /backstores/block/shared-disk
> /iscsi/iqn.2024-01.com.example:shared-storage/tpg1/acls create iqn.2024-01.com.example:client
> exit

# å¯åŠ¨targetæœåŠ¡
systemctl start target
systemctl enable target
```

**iSCSI Initiatoré…ç½®**
```bash
# å®‰è£…initiator
yum install -y iscsi-initiator-utils

# é…ç½®initiatoråç§°
echo "InitiatorName=iqn.2024-01.com.example:client" > /etc/iscsi/initiatorname.iscsi

# å‘ç°target
iscsiadm -m discovery -t st -p iscsi-server

# ç™»å½•target
iscsiadm -m node -T iqn.2024-01.com.example:shared-storage -p iscsi-server --login
```

---

## 6. ğŸŒ è·¨ä¸»æœºè¿ç§»ç½‘ç»œè¦æ±‚


### 6.1 ç½‘ç»œå¸¦å®½è¦æ±‚


**å¸¦å®½è®¡ç®—å…¬å¼ï¼š**
> æ‰€éœ€å¸¦å®½ = è™šæ‹Ÿæœºå†…å­˜å¤§å° Ã· æœŸæœ›è¿ç§»æ—¶é—´

```
å®é™…æ¡ˆä¾‹è®¡ç®—ï¼š
è™šæ‹Ÿæœºå†…å­˜ï¼š8GB
æœŸæœ›è¿ç§»æ—¶é—´ï¼š30ç§’
æ‰€éœ€ç†è®ºå¸¦å®½ï¼š8GB Ã· 30s = 273MB/s â‰ˆ 2.2Gbps

è€ƒè™‘å¼€é”€ï¼Œå»ºè®®å¸¦å®½ï¼š2.2Gbps Ã— 1.5 = 3.3Gbps
å®é™…å»ºè®®ï¼šä½¿ç”¨10Gbpsç½‘ç»œ
```

**ç½‘ç»œæ€§èƒ½æµ‹è¯•**
```bash
# ä½¿ç”¨iperfæµ‹è¯•å¸¦å®½
# åœ¨ç›®æ ‡ä¸»æœºå¯åŠ¨æœåŠ¡ç«¯
iperf -s

# åœ¨æºä¸»æœºæµ‹è¯•å¸¦å®½
iperf -c target-host -t 30

# ä½¿ç”¨pingæµ‹è¯•å»¶è¿Ÿ
ping -c 100 target-host
```

### 6.2 ç½‘ç»œé…ç½®è¦æ±‚


**ä¸“ç”¨è¿ç§»ç½‘ç»œ**
```
æ¨èç½‘ç»œæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç‰©ç†æœºA   â”‚     â”‚   ç‰©ç†æœºB   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç®¡ç†ç½‘ç»œ    â”‚â—„â”€â”€â”€â–¶â”‚ ç®¡ç†ç½‘ç»œ    â”‚  â† 1Gbps
â”‚ ä¸šåŠ¡ç½‘ç»œ    â”‚â—„â”€â”€â”€â–¶â”‚ ä¸šåŠ¡ç½‘ç»œ    â”‚  â† 1Gbps  
â”‚ è¿ç§»ç½‘ç»œ    â”‚â—„â”€â”€â”€â–¶â”‚ è¿ç§»ç½‘ç»œ    â”‚  â† 10Gbps
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç½‘ç»œé…ç½®ç¤ºä¾‹**
```bash
# é…ç½®è¿ç§»ä¸“ç”¨ç½‘å¡
ip addr add 192.168.100.10/24 dev eth1  # æºä¸»æœº
ip addr add 192.168.100.11/24 dev eth1  # ç›®æ ‡ä¸»æœº

# é…ç½®è·¯ç”±ï¼ˆå¦‚æœéœ€è¦ï¼‰
ip route add 192.168.100.0/24 dev eth1

# æµ‹è¯•è¿é€šæ€§
ping 192.168.100.11
```

### 6.3 é˜²ç«å¢™é…ç½®


**libvirtç«¯å£å¼€æ”¾**
```bash
# å¼€æ”¾libvirtç«¯å£
firewall-cmd --permanent --add-port=16509/tcp  # libvirt
firewall-cmd --permanent --add-port=5900-5999/tcp  # VNCç«¯å£èŒƒå›´
firewall-cmd --permanent --add-port=49152-49215/tcp  # è¿ç§»ç«¯å£èŒƒå›´

# é‡æ–°è½½å…¥é˜²ç«å¢™è§„åˆ™
firewall-cmd --reload
```

---

## 7. ğŸ”§ è¿ç§»æ•…éšœæ’æŸ¥æ–¹æ³•


### 7.1 å¸¸è§è¿ç§»é”™è¯¯


**é”™è¯¯1ï¼šCPUä¸å…¼å®¹**
```
é”™è¯¯ä¿¡æ¯ï¼šunsupported configuration: guest and host CPU are not compatible

è§£å†³æ–¹æ³•ï¼š
1. ä½¿ç”¨é€šç”¨CPUæ¨¡å‹
virsh edit vm-name
<cpu mode='host-model' check='partial'/>

2. æˆ–è€…ä½¿ç”¨æœ€ä½å…¼å®¹æ¨¡å¼
<cpu mode='custom' match='exact'>
  <model>qemu64</model>
</cpu>
```

**é”™è¯¯2ï¼šç½‘ç»œè¿æ¥å¤±è´¥**
```
é”™è¯¯ä¿¡æ¯ï¼šCannot recv data: Connection reset by peer

æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥SSHè¿æ¥
ssh root@target-host

2. æ£€æŸ¥libvirtæœåŠ¡
systemctl status libvirtd

3. æ£€æŸ¥é˜²ç«å¢™
firewall-cmd --list-all
```

**é”™è¯¯3ï¼šå­˜å‚¨è®¿é—®å¤±è´¥**
```
é”™è¯¯ä¿¡æ¯ï¼šStorage file not accessible

è§£å†³æ­¥éª¤ï¼š
1. æ£€æŸ¥å­˜å‚¨è·¯å¾„
ls -la /var/lib/libvirt/images/

2. æ£€æŸ¥æƒé™
chown qemu:qemu /var/lib/libvirt/images/*

3. æ£€æŸ¥SELinux
setsebool -P virt_use_nfs 1
```

### 7.2 è¿ç§»çŠ¶æ€ç›‘æ§


**è¿ç§»è¿›åº¦æŸ¥çœ‹**
```bash
# æŸ¥çœ‹è¿ç§»ä»»åŠ¡çŠ¶æ€
virsh migrate-getjobinfo vm-name

# æŸ¥çœ‹è¿ç§»ç»Ÿè®¡ä¿¡æ¯
virsh migrate-getstats vm-name

# å®æ—¶ç›‘æ§è¿ç§»è¿›åº¦
watch -n 2 'virsh migrate-getjobinfo vm-name'
```

**æ—¥å¿—åˆ†ææ–¹æ³•**
```bash
# æŸ¥çœ‹libvirtæ—¥å¿—
tail -f /var/log/libvirt/libvirtd.log

# æŸ¥çœ‹qemuæ—¥å¿—
tail -f /var/log/libvirt/qemu/vm-name.log

# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
journalctl -u libvirtd -f
```

### 7.3 è¿ç§»å›æ»šå¤„ç†


**è¿ç§»å¤±è´¥å›æ»š**
```bash
# å¦‚æœè¿ç§»å¡ä½ï¼Œå–æ¶ˆè¿ç§»
virsh migrate-postcopy vm-name

# å¦‚æœç›®æ ‡ä¸»æœºå¯åŠ¨å¤±è´¥ï¼Œå›åˆ°æºä¸»æœº
virsh start vm-name  # åœ¨æºä¸»æœºæ‰§è¡Œ

# æ¸…ç†ç›®æ ‡ä¸»æœºæ®‹ç•™
virsh undefine vm-name  # åœ¨ç›®æ ‡ä¸»æœºæ‰§è¡Œ
```

---

## 8. ğŸš€ è¿ç§»æ€§èƒ½ä¼˜åŒ–


### 8.1 å†…å­˜è¿ç§»ä¼˜åŒ–


**å†…å­˜å‹ç¼©æŠ€æœ¯**
```bash
# å¯ç”¨å†…å­˜å‹ç¼©è¿ç§»
virsh migrate --live --compressed vm-name qemu+ssh://target-host/system

# è®¾ç½®å‹ç¼©çº§åˆ«ï¼ˆ1-9ï¼Œ9ä¸ºæœ€é«˜å‹ç¼©ç‡ï¼‰
virsh migrate-setparameter vm-name compression-level 6

# è®¾ç½®å‹ç¼©çº¿ç¨‹æ•°
virsh migrate-setparameter vm-name compression-threads 4
```

**å†…å­˜é¢„æ‹·è´ä¼˜åŒ–**
```bash
# è®¾ç½®æœ€å¤§åœæœºæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
virsh migrate-setmaxdowntime vm-name 500

# è®¾ç½®è¿ç§»å¸¦å®½é™åˆ¶ï¼ˆMB/sï¼‰
virsh migrate-setspeed vm-name 1000

# è®¾ç½®è„é¡µç‡é˜ˆå€¼
virsh migrate-setparameter vm-name downtime-limit 300
```

### 8.2 ç½‘ç»œä¼ è¾“ä¼˜åŒ–


**TCPå‚æ•°è°ƒä¼˜**
```bash
# è°ƒæ•´TCPçª—å£å¤§å°
echo 'net.core.rmem_max = 67108864' >> /etc/sysctl.conf
echo 'net.core.wmem_max = 67108864' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_rmem = 4096 87380 67108864' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_wmem = 4096 65536 67108864' >> /etc/sysctl.conf

# åº”ç”¨é…ç½®
sysctl -p
```

**å¹¶è¡Œä¼ è¾“ä¼˜åŒ–**
```bash
# å¯ç”¨å¤šé€šé“è¿ç§»
virsh migrate --live --parallel-connections 4 vm-name qemu+ssh://target-host/system

# è®¾ç½®å¹¶è¡Œä¼ è¾“å¸¦å®½
virsh migrate-setparameter vm-name parallel-bandwidth 2000
```

### 8.3 å­˜å‚¨è¿ç§»ä¼˜åŒ–


**ç£ç›˜é•œåƒä¼˜åŒ–**
```bash
# å‹ç¼©ç£ç›˜é•œåƒ
qemu-img convert -c -O qcow2 source.qcow2 compressed.qcow2

# æ£€æŸ¥é•œåƒå®é™…ä½¿ç”¨ç©ºé—´
qemu-img info vm-disk.qcow2

# ç£ç›˜é¢„åˆ†é…
qemu-img create -f qcow2 -o preallocation=metadata vm-disk.qcow2 50G
```

---

## 9. ğŸ”’ è¿ç§»å®‰å…¨è€ƒè™‘


### 9.1 ä¼ è¾“åŠ å¯†


**SSL/TLSåŠ å¯†é…ç½®**
```bash
# é…ç½®libvirt TLS
echo 'listen_tls = 1' >> /etc/libvirt/libvirtd.conf
echo 'listen_tcp = 0' >> /etc/libvirt/libvirtd.conf

# ç”ŸæˆTLSè¯ä¹¦
certtool --generate-privkey > server-key.pem
certtool --generate-certificate --load-privkey server-key.pem > server-cert.pem

# ä½¿ç”¨TLSè¿æ¥è¿ç§»
virsh migrate --live vm-name qemu+tls://target-host/system
```

### 9.2 è®¿é—®æ§åˆ¶


**SASLè®¤è¯é…ç½®**
```bash
# å®‰è£…SASL
yum install -y cyrus-sasl-plain

# é…ç½®libvirtä½¿ç”¨SASL
echo 'auth_tcp = "sasl"' >> /etc/libvirt/libvirtd.conf

# åˆ›å»ºç”¨æˆ·
saslpasswd2 -a libvirt username

# ä½¿ç”¨SASLè¿æ¥
virsh -c qemu+tcp://username@target-host/system migrate --live vm-name
```

### 9.3 å®¡è®¡å’Œæ—¥å¿—


**è¿ç§»å®¡è®¡é…ç½®**
```bash
# å¯ç”¨å®¡è®¡æ—¥å¿—
echo 'audit_level = 2' >> /etc/libvirt/libvirtd.conf
echo 'audit_logging = 1' >> /etc/libvirt/libvirtd.conf

# æŸ¥çœ‹å®¡è®¡æ—¥å¿—
grep libvirt /var/log/audit/audit.log

# é…ç½®æ—¥å¿—è½®è½¬
cat > /etc/logrotate.d/libvirt << EOF
/var/log/libvirt/*.log {
    daily
    missingok
    rotate 30
    compress
    notifempty
    copytruncate
}
EOF
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è¿ç§»ç±»å‹ï¼šç¦»çº¿è¿ç§»ç®€å•å¯é ï¼Œçƒ­è¿ç§»æ— éœ€åœæœº
ğŸ”¸ å·¥ä½œåŸç†ï¼šå†…å­˜çŠ¶æ€å¤åˆ¶ + å­˜å‚¨å…±äº« = æ— ç¼è¿ç§»
ğŸ”¸ å‰ç½®æ¡ä»¶ï¼šç¡¬ä»¶å…¼å®¹ + ç½‘ç»œè¿é€š + å­˜å‚¨å…±äº«
ğŸ”¸ æ•…éšœæ’æŸ¥ï¼šæ—¥å¿—åˆ†æ + çŠ¶æ€ç›‘æ§ + å›æ»šæœºåˆ¶
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šå‹ç¼©ä¼ è¾“ + ç½‘ç»œè°ƒä¼˜ + å¹¶è¡Œå¤„ç†
ğŸ”¸ å®‰å…¨åŠ å›ºï¼šä¼ è¾“åŠ å¯† + è®¿é—®æ§åˆ¶ + å®¡è®¡æ—¥å¿—
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è¿ç§»æœ¬è´¨ç†è§£**
```
è™šæ‹Ÿæœºè¿ç§» = çŠ¶æ€è½¬ç§» + èµ„æºé‡å®šä½
- è®¡ç®—çŠ¶æ€ï¼šCPUå¯„å­˜å™¨ã€å†…å­˜å†…å®¹
- å­˜å‚¨çŠ¶æ€ï¼šç£ç›˜æ–‡ä»¶ä½ç½®è®¿é—®
- ç½‘ç»œçŠ¶æ€ï¼šIPåœ°å€ã€è¿æ¥ç»´æŒ
```

**ğŸ”¹ æ€§èƒ½å½±å“å› ç´ **
```
å½±å“è¿ç§»é€Ÿåº¦çš„å…³é”®å› ç´ ï¼š
1. è™šæ‹Ÿæœºå†…å­˜å¤§å° â†’ éœ€è¦å¤åˆ¶çš„æ•°æ®é‡
2. å†…å­˜è„é¡µç‡ â†’ æ•°æ®å˜åŒ–é€Ÿåº¦  
3. ç½‘ç»œå¸¦å®½ â†’ ä¼ è¾“èƒ½åŠ›ä¸Šé™
4. å­˜å‚¨ç±»å‹ â†’ å…±äº«vsæœ¬åœ°å­˜å‚¨
```

**ğŸ”¹ é€‚ç”¨åœºæ™¯é€‰æ‹©**
```
ç¦»çº¿è¿ç§»é€‚åˆï¼š
âœ… ç»´æŠ¤çª—å£æœŸé—´
âœ… æµ‹è¯•å¼€å‘ç¯å¢ƒ
âœ… å¯¹åœæœºæ—¶é—´ä¸æ•æ„Ÿçš„åº”ç”¨

çƒ­è¿ç§»é€‚åˆï¼š
âœ… ç”Ÿäº§ç¯å¢ƒ7Ã—24æœåŠ¡
âœ… è´Ÿè½½å‡è¡¡è°ƒæ•´
âœ… æ•…éšœé¢„é˜²æ€§è¿ç§»
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


- **æ•°æ®ä¸­å¿ƒç®¡ç†**ï¼šåŠ¨æ€èµ„æºè°ƒé…ï¼Œç¡¬ä»¶ç»´æŠ¤é›¶åœæœº
- **äº‘è®¡ç®—å¹³å°**ï¼šå¼¹æ€§æ‰©ç¼©å®¹ï¼Œå¤šç§Ÿæˆ·èµ„æºéš”ç¦»
- **ç¾éš¾æ¢å¤**ï¼šå¿«é€Ÿæ•…éšœè½¬ç§»ï¼Œä¸šåŠ¡è¿ç»­æ€§ä¿éšœ
- **èƒ½è€—ä¼˜åŒ–**ï¼šè´Ÿè½½æ•´åˆï¼Œç»¿è‰²æ•°æ®ä¸­å¿ƒå»ºè®¾

**æ ¸å¿ƒè®°å¿†**ï¼š
- è™šæ‹Ÿæœºè¿ç§»æ˜¯ç°ä»£æ•°æ®ä¸­å¿ƒçš„æ ¸å¿ƒæŠ€æœ¯
- çƒ­è¿ç§»å®ç°ä¸šåŠ¡é›¶ä¸­æ–­ï¼Œç¦»çº¿è¿ç§»æ“ä½œæ›´ç®€å•
- ç½‘ç»œå’Œå­˜å‚¨æ˜¯è¿ç§»æˆåŠŸçš„å…³é”®åŸºç¡€è®¾æ–½
- å®‰å…¨å’Œæ€§èƒ½ä¼˜åŒ–å†³å®šè¿ç§»æŠ€æœ¯çš„å®ç”¨ä»·å€¼