---
title: 7、虚拟网络配置
---
## 📚 目录

1. [KVM虚拟网络基础概念](#1-KVM虚拟网络基础概念)
2. [libvirt默认网络配置](#2-libvirt默认网络配置)
3. [NAT网络模式配置与应用](#3-NAT网络模式配置与应用)
4. [桥接网络配置与管理](#4-桥接网络配置与管理)
5. [虚拟网络创建与删除](#5-虚拟网络创建与删除)
6. [网络接口热插拔](#6-网络接口热插拔)
7. [VLAN配置与隔离](#7-VLAN配置与隔离)
8. [网络性能优化](#8-网络性能优化)
9. [网络故障诊断方法](#9-网络故障诊断方法)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🌐 KVM虚拟网络基础概念


### 1.1 什么是虚拟网络


**简单理解**：虚拟网络就是用软件模拟出来的网络环境，让虚拟机之间、虚拟机与宿主机之间能够相互通信。

```
现实世界的网络：           KVM虚拟网络：
    路由器                   虚拟交换机
   /  |  \                  /   |   \
电脑1 电脑2 电脑3         虚拟机1 虚拟机2 虚拟机3

物理设备连接              软件模拟连接
```

**🔸 核心作用**
- **连接虚拟机**：让多个虚拟机能互相通信
- **访问外网**：让虚拟机能上网
- **隔离安全**：不同网络环境互不干扰
- **灵活管理**：可以随时创建、删除、修改网络

### 1.2 虚拟网络的主要组件


**🏗️ 基本组件图示**
```
┌─────────────────────────────────────┐
│            宿主机系统                │
│  ┌─────────┐    ┌─────────────────┐  │
│  │ 虚拟机1  │    │   libvirt网络   │  │
│  │ ┌─────┐ │    │   管理服务      │  │
│  │ │vNIC1│ │────┤                 │  │
│  │ └─────┘ │    │   ┌───────────┐ │  │
│  └─────────┘    │   │虚拟交换机 │ │  │
│  ┌─────────┐    │   │(virbr0)   │ │  │
│  │ 虚拟机2  │    │   └───────────┘ │  │
│  │ ┌─────┐ │────┤                 │  │
│  │ │vNIC2│ │    └─────────────────┘  │
│  │ └─────┘ │              │          │
│  └─────────┘              │          │
└────────────────────────────┼──────────┘
                             │
                        ┌─────────┐
                        │物理网卡 │
                        │(eth0)   │
                        └─────────┘
                             │
                        ┌─────────┐
                        │  互联网  │
                        └─────────┘
```

**核心组件说明**：

**虚拟网卡（vNIC）**：
- 含义：虚拟机内部的网络接口
- 作用：就像电脑的网卡一样，负责收发网络数据
- 特点：每个虚拟机可以有多个虚拟网卡

**虚拟交换机（Virtual Switch）**：
- 含义：软件模拟的网络交换机
- 作用：连接多个虚拟机，转发网络数据包
- 常见名称：`virbr0`、`br0`等

**网络命名空间（Network Namespace）**：
- 含义：Linux系统中独立的网络环境
- 作用：为虚拟机提供隔离的网络空间
- 好处：不同虚拟机的网络配置互不影响

### 1.3 虚拟网络的主要模式


| 网络模式 | **工作原理** | **使用场景** | **特点** |
|---------|------------|-------------|---------|
| 🔀 **NAT模式** | `虚拟机通过宿主机NAT访问外网` | `测试环境，简单应用` | `配置简单，安全隔离` |
| 🌉 **桥接模式** | `虚拟机直接连接物理网络` | `生产环境，服务器应用` | `性能好，可直接访问` |
| 🔒 **隔离模式** | `虚拟机只能内部通信` | `安全测试，内部网络` | `完全隔离，高安全性` |
| 🔗 **宿主机模式** | `只与宿主机通信` | `开发调试` | `简单直接` |

---

## 2. ⚙️ libvirt默认网络配置


### 2.1 libvirt网络管理系统


**什么是libvirt**：
libvirt是Linux下的虚拟化管理工具，它不仅管理虚拟机，还管理虚拟网络。就像一个"虚拟化管家"，帮你打理所有虚拟资源。

**🔸 libvirt的网络管理功能**
- **自动创建**：安装时自动创建默认网络
- **统一管理**：用命令统一管理所有虚拟网络
- **配置持久化**：网络配置保存到文件，重启不丢失
- **状态监控**：实时监控网络状态和流量

### 2.2 默认网络的基本信息


**查看默认网络**：
```bash
# 查看所有虚拟网络
virsh net-list --all

# 查看默认网络详细信息
virsh net-dumpxml default
```

**📊 默认网络配置解析**
```xml
<network>
  <name>default</name>              <!-- 网络名称：default -->
  <bridge name='virbr0'/>           <!-- 虚拟网桥：virbr0 -->
  <forward mode='nat'/>             <!-- 转发模式：NAT -->
  <ip address='192.168.122.1'      <!-- 网关地址 -->
      netmask='255.255.255.0'>      <!-- 子网掩码 -->
    <dhcp>                          <!-- DHCP服务 -->
      <range start='192.168.122.2'  <!-- IP分配范围 -->
             end='192.168.122.254'/>
    </dhcp>
  </ip>
</network>
```

### 2.3 默认网络的工作机制


**📋 网络架构图示**
```
虚拟机网络访问流程：
  
虚拟机1 (192.168.122.10)
    ↓
虚拟网桥 virbr0 (192.168.122.1)
    ↓
NAT转换 (iptables规则)
    ↓  
物理网卡 eth0 (对外IP)
    ↓
    互联网

内部通信：虚拟机 ←→ virbr0 ←→ 虚拟机
外部通信：虚拟机 → virbr0 → NAT → 物理网卡 → 互联网
```

**🔸 关键组件作用**

**virbr0网桥**：
- 作用：连接所有使用默认网络的虚拟机
- 地址：通常是192.168.122.1
- 功能：充当虚拟机的网关

**dnsmasq服务**：
- 作用：为虚拟机提供DHCP和DNS服务
- DHCP：自动分配IP地址
- DNS：域名解析服务

**iptables规则**：
- 作用：实现NAT转换和防火墙功能
- NAT：将虚拟机内网IP转换为宿主机IP
- 防火墙：控制网络访问权限

### 2.4 默认网络的优缺点


> 💡 **优点分析**：
> - **开箱即用**：安装后立即可用，无需配置
> - **安全隔离**：虚拟机与外网隔离，相对安全
> - **资源节约**：多个虚拟机共享一个外网IP

> ⚠️ **限制说明**：
> - **性能开销**：NAT转换有一定性能损失
> - **访问限制**：外部无法直接访问虚拟机
> - **端口冲突**：需要手动配置端口转发

---

## 3. 🔀 NAT网络模式配置与应用


### 3.1 NAT网络模式原理


**什么是NAT**：
NAT（Network Address Translation）网络地址转换，就像一个"翻译官"，把虚拟机的内网地址翻译成宿主机的外网地址。

**🔸 NAT工作原理图示**
```
外部访问视角：                    内部实际结构：
    互联网                           互联网
      ↓                               ↓
  宿主机IP                         宿主机IP
 (公网:8080)                      (192.168.1.100)
      ↓                               ↓
   看起来直接                    [NAT转换规则]  
   访问宿主机                         ↓
                               虚拟机内网IP
                              (192.168.122.10:80)

NAT转换过程：
1. 虚拟机发出请求：192.168.122.10 → 目标网站
2. NAT转换：192.168.1.100 → 目标网站  
3. 响应返回：目标网站 → 192.168.1.100
4. NAT转换：目标网站 → 192.168.122.10
```

### 3.2 创建自定义NAT网络


**创建NAT网络配置文件**：
```xml
<!-- nat-network.xml -->
<network>
  <name>my-nat</name>
  <bridge name='virbr1'/>
  <forward mode='nat'>
    <nat>
      <port start='1024' end='65535'/>
    </nat>
  </forward>
  <ip address='10.0.0.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='10.0.0.10' end='10.0.0.100'/>
      <!-- 静态IP绑定 -->
      <host mac='52:54:00:12:34:56' 
            ip='10.0.0.50' 
            name='web-server'/>
    </dhcp>
  </ip>
</network>
```

**网络管理命令**：
```bash
# 定义网络
virsh net-define nat-network.xml

# 启动网络  
virsh net-start my-nat

# 设置自动启动
virsh net-autostart my-nat

# 查看网络状态
virsh net-info my-nat
```

### 3.3 端口转发配置


**什么是端口转发**：
就是把外部访问宿主机某个端口的请求，转发到虚拟机的特定端口。比如访问宿主机的8080端口，实际访问的是虚拟机的80端口。

**🔧 配置端口转发**
```bash
# 添加端口转发规则（HTTP服务）
iptables -t nat -A PREROUTING -p tcp --dport 8080 \
  -j DNAT --to-destination 10.0.0.50:80

# 添加端口转发规则（SSH服务）  
iptables -t nat -A PREROUTING -p tcp --dport 2222 \
  -j DNAT --to-destination 10.0.0.50:22

# 保存iptables规则
iptables-save > /etc/iptables/rules.v4
```

**📋 常用端口转发场景**
| 服务类型 | **宿主机端口** | **虚拟机端口** | **用途** |
|---------|--------------|--------------|---------|
| 🌐 **Web服务** | `8080` | `80` | `访问网站` |
| 🔒 **SSH远程** | `2222` | `22` | `远程登录` |
| 🗄️ **数据库** | `3307` | `3306` | `MySQL访问` |
| 📧 **邮件服务** | `2525` | `25` | `SMTP服务` |

### 3.4 NAT网络的实际应用


**💼 适用场景**
- **开发测试**：搭建测试环境，不影响生产网络
- **学习实验**：安全地试验各种网络配置
- **服务部署**：部署不需要外部直接访问的服务
- **安全隔离**：需要严格网络隔离的应用

> 🎯 **最佳实践**：
> - 为不同项目创建独立的NAT网络
> - 合理规划IP地址段，避免冲突
> - 及时清理不用的端口转发规则
> - 定期备份网络配置文件

---

## 4. 🌉 桥接网络配置与管理


### 4.1 桥接网络原理


**什么是桥接网络**：
桥接网络就像在虚拟机和物理网络之间架了一座"桥"，让虚拟机看起来就像直接连在物理网络上一样。

**🔸 桥接 vs NAT 对比图示**
```
NAT模式：
物理网络 ←→ 宿主机 ←→ [NAT转换] ←→ 虚拟机
         (一个IP)                  (内网IP)

桥接模式：
物理网络 ←→ [网络桥] ←→ 宿主机
                   ↕
                 虚拟机
        (每个都有独立的物理网络IP)
```

**🔸 桥接网络的特点**
- **直接访问**：虚拟机拥有物理网络的IP地址
- **无需转换**：数据包直接在物理网络中传输  
- **性能更好**：没有NAT转换的开销
- **外部可访问**：其他设备可以直接访问虚拟机

### 4.2 创建网络桥接


**步骤1：创建网络桥接配置**
```bash
# 备份原网络配置
cp /etc/netplan/01-netcfg.yaml /etc/netplan/01-netcfg.yaml.backup

# 编辑网络配置文件
nano /etc/netplan/01-netcfg.yaml
```

**网络配置示例**：
```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:                    # 物理网卡
      dhcp4: false           # 禁用DHCP
      dhcp6: false
  bridges:
    br0:                     # 网桥名称
      interfaces:
        - eth0               # 绑定物理网卡
      dhcp4: true            # 网桥使用DHCP
      # 或者使用静态IP：
      # addresses: [192.168.1.100/24]
      # gateway4: 192.168.1.1
      # nameservers:
      #   addresses: [8.8.8.8]
```

**步骤2：应用网络配置**
```bash
# 应用新配置
netplan apply

# 查看网桥状态
brctl show

# 查看IP分配情况
ip addr show br0
```

### 4.3 配置虚拟机使用桥接网络


**创建桥接网络定义**：
```xml
<!-- bridge-network.xml -->
<network>
  <name>host-bridge</name>
  <forward mode="bridge"/>
  <bridge name="br0"/>
</network>
```

**管理桥接网络**：
```bash
# 定义并启动桥接网络
virsh net-define bridge-network.xml
virsh net-start host-bridge
virsh net-autostart host-bridge

# 修改虚拟机网络配置
virsh edit vm-name
```

**虚拟机XML配置示例**：
```xml
<interface type='network'>
  <source network='host-bridge'/>
  <model type='virtio'/>
  <mac address='52:54:00:12:34:57'/>
</interface>
```

### 4.4 桥接网络管理


**🔧 常用管理命令**
```bash
# 查看桥接信息
brctl show br0

# 查看桥接统计
cat /proc/net/dev | grep br0

# 查看连接到桥接的设备
brctl showstp br0

# 临时禁用桥接的STP协议
brctl stp br0 off
```

**📊 网络接口状态监控**
```bash
# 实时监控网络流量
watch -n 1 cat /proc/net/dev

# 查看桥接MAC地址表
brctl showmacs br0

# 测试桥接连通性
ping -c 3 192.168.1.1
```

### 4.5 桥接网络故障排除


> ⚠️ **常见问题及解决**：

**问题1：虚拟机无法获取IP**
```bash
# 检查DHCP客户端
dhclient -v

# 重启网络服务
systemctl restart systemd-networkd
```

**问题2：桥接网络断开**
```bash
# 检查桥接状态
ip link show br0

# 重建桥接
ip link set br0 down
ip link set br0 up
```

**问题3：性能问题**
```bash
# 禁用不必要的协议
echo 0 > /sys/class/net/br0/bridge/multicast_snooping
```

---

## 5. 🏗️ 虚拟网络创建与删除


### 5.1 网络生命周期管理


**虚拟网络的生命周期**：
```
创建阶段 → 配置阶段 → 使用阶段 → 维护阶段 → 删除阶段
   ↓         ↓         ↓         ↓         ↓
 定义XML → 启动网络 → 分配给VM → 监控调优 → 清理资源
```

### 5.2 创建不同类型的虚拟网络


**🔸 创建隔离网络**
隔离网络让虚拟机只能内部通信，无法访问外网，适合安全测试。

```xml
<!-- isolated-network.xml -->
<network>
  <name>isolated</name>
  <bridge name='virbr2'/>
  <!-- 注意：没有forward标签，表示隔离 -->
  <ip address='172.16.0.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='172.16.0.10' end='172.16.0.100'/>
    </dhcp>
  </ip>
</network>
```

**🔸 创建仅主机网络**
只能与宿主机通信，适合开发调试。

```xml
<!-- host-only-network.xml -->
<network>
  <name>host-only</name>
  <bridge name='virbr3'/>
  <forward mode='route'/>
  <ip address='192.168.100.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.100.2' end='192.168.100.50'/>
    </dhcp>
  </ip>
</network>
```

**🔸 创建带VLAN的网络**
```xml
<!-- vlan-network.xml -->
<network>
  <name>vlan100</name>
  <forward mode='bridge'/>
  <bridge name='br0'/>
  <vlan tag='100'/>
  <ip address='10.100.0.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='10.100.0.10' end='10.100.0.100'/>
    </dhcp>
  </ip>
</network>
```

### 5.3 网络操作命令详解


**📋 基本管理命令**
```bash
# 定义网络（从XML文件）
virsh net-define network.xml

# 创建临时网络（重启后消失）
virsh net-create network.xml

# 启动网络
virsh net-start network-name

# 停止网络
virsh net-destroy network-name

# 删除网络定义
virsh net-undefine network-name

# 设置网络自动启动
virsh net-autostart network-name

# 取消自动启动
virsh net-autostart --disable network-name
```

**🔍 查询和监控命令**
```bash
# 列出所有网络
virsh net-list --all

# 显示网络详细信息
virsh net-info network-name

# 导出网络XML配置
virsh net-dumpxml network-name

# 编辑网络配置
virsh net-edit network-name

# 查看网络统计信息
virsh domifstat vm-name interface-name
```

### 5.4 批量网络管理


**创建多个相似网络的脚本示例**：
```bash
#!/bin/bash
# create-test-networks.sh

# 创建测试网络模板
create_test_network() {
    local net_id=$1
    local ip_base=$2
    
    cat > test-net-${net_id}.xml << EOF
<network>
  <name>test-net-${net_id}</name>
  <bridge name='virbr${net_id}'/>
  <forward mode='nat'/>
  <ip address='192.168.${ip_base}.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.${ip_base}.10' 
             end='192.168.${ip_base}.100'/>
    </dhcp>
  </ip>
</network>
EOF
    
    # 定义并启动网络
    virsh net-define test-net-${net_id}.xml
    virsh net-start test-net-${net_id}
    virsh net-autostart test-net-${net_id}
    
    echo "创建网络: test-net-${net_id} (192.168.${ip_base}.0/24)"
}

# 批量创建网络
for i in {10..15}; do
    create_test_network $i $((100 + i))
done
```

### 5.5 安全的网络删除


**🛡️ 安全删除步骤**：
```bash
# 1. 检查网络使用情况
virsh net-info network-name

# 2. 查找使用该网络的虚拟机
virsh list --all
for vm in $(virsh list --name); do
    virsh domiflist $vm | grep network-name && echo "VM: $vm 使用此网络"
done

# 3. 停止相关虚拟机（如需要）
virsh shutdown vm-name

# 4. 停止并删除网络
virsh net-destroy network-name
virsh net-undefine network-name

# 5. 清理配置文件
rm -f network.xml
```

> ⚠️ **删除前检查清单**：
> - 确认没有虚拟机正在使用此网络
> - 备份重要的网络配置
> - 通知相关用户网络变更
> - 检查是否有依赖的防火墙规则

---

## 6. 🔌 网络接口热插拔


### 6.1 什么是网络接口热插拔


**热插拔的含义**：
热插拔就是在虚拟机运行时，无需关机就能添加或移除网络接口。就像给电脑插拔USB设备一样方便。

**🔸 热插拔的优势**
- **零停机**：无需关闭虚拟机
- **灵活调整**：根据需要动态调整网络配置
- **故障恢复**：快速替换有问题的网络接口
- **资源优化**：按需分配网络资源

### 6.2 热插拔网络接口


**📋 添加网络接口**

步骤1：创建网络接口配置文件
```xml
<!-- new-interface.xml -->
<interface type='network'>
  <source network='default'/>
  <model type='virtio'/>
  <mac address='52:54:00:12:34:58'/>
</interface>
```

步骤2：执行热插拔添加
```bash
# 添加网络接口（临时，重启后消失）
virsh attach-device vm-name new-interface.xml

# 永久添加网络接口
virsh attach-device vm-name new-interface.xml --persistent

# 同时添加到运行配置和持久配置
virsh attach-device vm-name new-interface.xml --live --persistent
```

**📋 移除网络接口**
```bash
# 临时移除网络接口
virsh detach-device vm-name new-interface.xml

# 永久移除网络接口  
virsh detach-device vm-name new-interface.xml --persistent

# 同时从运行和持久配置移除
virsh detach-device vm-name new-interface.xml --live --persistent
```

### 6.3 网络接口信息查看


**🔍 查看虚拟机网络接口**
```bash
# 查看虚拟机所有网络接口
virsh domiflist vm-name

# 查看接口详细信息
virsh domifstat vm-name interface-name

# 查看接口MAC地址
virsh dumpxml vm-name | grep -A5 -B5 "mac address"
```

**输出示例**：
```
Interface  Type       Source     Model       MAC
-------------------------------------------------------
vnet0      network    default    virtio      52:54:00:12:34:56
vnet1      bridge     br0        virtio      52:54:00:12:34:57
```

### 6.4 网络接口参数调整


**🔧 修改网络接口属性**

修改MAC地址：
```bash
# 创建新配置
cat > update-mac.xml << EOF
<interface type='network'>
  <source network='default'/>
  <mac address='52:54:00:12:34:59'/>
  <model type='virtio'/>
</interface>
EOF

# 更新接口配置
virsh update-device vm-name update-mac.xml --live --persistent
```

修改网络连接：
```bash
# 更换网络（从default切换到bridge）
cat > switch-network.xml << EOF  
<interface type='bridge'>
  <source bridge='br0'/>
  <mac address='52:54:00:12:34:56'/>
  <model type='virtio'/>
</interface>
EOF

virsh update-device vm-name switch-network.xml --live --persistent
```

### 6.5 热插拔操作的最佳实践


> 💡 **操作建议**：

**热插拔前的准备**：
```bash
# 1. 检查虚拟机状态
virsh domstate vm-name

# 2. 备份当前配置
virsh dumpxml vm-name > vm-backup.xml

# 3. 检查网络可用性
virsh net-list --all
```

**操作后的验证**：
```bash
# 1. 确认接口添加成功
virsh domiflist vm-name

# 2. 在虚拟机内检查网络接口
# （在虚拟机内执行）
ip link show

# 3. 测试网络连通性
ping -c 3 gateway-ip
```

> ⚠️ **注意事项**：
> - 热插拔可能需要虚拟机操作系统支持
> - 某些老版本Linux可能需要手动激活新接口
> - Windows虚拟机可能需要安装virtio驱动
> - 建议在非生产环境先测试热插拔操作

**虚拟机内网络接口激活**：
```bash
# Ubuntu/Debian系统
sudo dhclient eth1

# CentOS/RHEL系统
sudo ifup eth1

# 或使用NetworkManager
sudo nmcli device connect eth1
```

---

## 7. 🏷️ VLAN配置与隔离


### 7.1 VLAN基础概念


**什么是VLAN**：
VLAN（Virtual Local Area Network）虚拟局域网，就是在同一个物理网络上创建多个逻辑上独立的网络。就像在一栋楼里用隔墙隔出不同的房间一样。

**🔸 VLAN的作用**
```
物理网络视角：        VLAN逻辑视角：
     交换机              VLAN 100 (财务部)
    /  |  \              ┌─────┬─────┐
   电脑1 电脑2 电脑3        │电脑1│电脑3│
   (全在一个网络)          └─────┴─────┘
                        
                         VLAN 200 (技术部)  
                           ┌─────┐
                           │电脑2│
                           └─────┘
```

**🔸 VLAN的优势**
- **网络隔离**：不同VLAN之间默认无法通信
- **安全性高**：敏感数据不会跨VLAN传输
- **灵活管理**：可以按部门、项目划分网络
- **提高性能**：减少广播域，降低网络拥堵

### 7.2 KVM中的VLAN配置


**创建VLAN网络配置**：
```xml
<!-- vlan-100.xml -->
<network>
  <name>vlan-100</name>
  <forward mode='bridge'/>
  <bridge name='br0'/>
  <vlan tag='100'>                    <!-- VLAN标签100 -->
    <interface dev='eth0'/>           <!-- 物理接口 -->
  </vlan>
  <ip address='10.100.1.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='10.100.1.10' end='10.100.1.100'/>
    </dhcp>
  </ip>
</network>
```

**创建多个VLAN网络**：
```bash
#!/bin/bash
# 创建多个VLAN的脚本

create_vlan_network() {
    local vlan_id=$1
    local dept_name=$2
    
    cat > vlan-${vlan_id}.xml << EOF
<network>
  <name>vlan-${vlan_id}</name>
  <forward mode='bridge'/>
  <bridge name='br0'/>
  <vlan tag='${vlan_id}'/>
  <ip address='10.${vlan_id}.1.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='10.${vlan_id}.1.10' 
             end='10.${vlan_id}.1.100'/>
    </dhcp>
  </ip>
</network>
EOF

    virsh net-define vlan-${vlan_id}.xml
    virsh net-start vlan-${vlan_id}
    echo "创建VLAN ${vlan_id} (${dept_name})"
}

# 创建不同部门的VLAN
create_vlan_network 100 "财务部"
create_vlan_network 200 "技术部" 
create_vlan_network 300 "市场部"
```

### 7.3 虚拟机VLAN分配


**为虚拟机分配VLAN**：
```xml
<!-- 虚拟机使用VLAN 100 -->
<interface type='network'>
  <source network='vlan-100'/>
  <model type='virtio'/>
  <mac address='52:54:00:10:01:01'/>
</interface>
```

**批量分配VLAN示例**：
```bash
# 财务部虚拟机使用VLAN 100
virsh attach-device finance-vm1 vlan-100-interface.xml --persistent
virsh attach-device finance-vm2 vlan-100-interface.xml --persistent

# 技术部虚拟机使用VLAN 200  
virsh attach-device tech-vm1 vlan-200-interface.xml --persistent
virsh attach-device tech-vm2 vlan-200-interface.xml --persistent
```

### 7.4 VLAN间通信控制


**🔒 默认隔离策略**
不同VLAN之间默认无法通信，这是VLAN隔离的基本功能。

**🔗 配置VLAN间路由**
如果需要特定VLAN之间通信，需要配置路由：

```bash
# 在路由器或Linux网关上配置VLAN间路由
# 允许VLAN 100访问VLAN 200的特定服务

# 添加路由规则
ip route add 10.200.1.0/24 via 10.100.1.1 dev vlan100
ip route add 10.100.1.0/24 via 10.200.1.1 dev vlan200

# 配置防火墙规则（允许特定端口）
iptables -A FORWARD -s 10.100.1.0/24 -d 10.200.1.0/24 \
  -p tcp --dport 80 -j ACCEPT
```

### 7.5 VLAN管理和监控


**📊 VLAN状态查看**
```bash
# 查看所有VLAN网络
virsh net-list | grep vlan

# 查看VLAN网络详情
virsh net-dumpxml vlan-100

# 查看VLAN接口统计
cat /proc/net/vlan/config

# 监控VLAN流量
tcpdump -i br0.100 -n
```

**🔧 VLAN故障排除**
```bash
# 检查VLAN接口状态
ip link show br0.100

# 检查VLAN路由
ip route show table all | grep vlan

# 测试VLAN连通性
ping -I vlan100 10.100.1.10

# 查看VLAN ARP表
arp -i br0.100
```

**📋 VLAN管理最佳实践**

> 💡 **规划建议**：
> - 为不同部门分配不同的VLAN ID段
> - 使用有意义的VLAN命名（如dept-finance）
> - 记录VLAN分配表，避免冲突
> - 定期审查VLAN使用情况

**VLAN分配表示例**：
| VLAN ID | **部门** | **IP段** | **用途** | **备注** |
|---------|---------|---------|---------|---------|
| 100 | `财务部` | `10.100.1.0/24` | `办公应用` | `高安全要求` |
| 200 | `技术部` | `10.200.1.0/24` | `开发测试` | `需互联网访问` |
| 300 | `市场部` | `10.300.1.0/24` | `营销系统` | `外部合作` |
| 999 | `管理` | `10.999.1.0/24` | `网络管理` | `仅管理员` |

---

## 8. ⚡ 网络性能优化


### 8.1 网络性能影响因素


**🔸 主要性能瓶颈**
```
性能瓶颈分析：
  
应用层
  ↓ 应用程序效率
虚拟机OS
  ↓ 虚拟网卡驱动  ← 优化点1：virtio驱动
Hypervisor层
  ↓ 网络模拟开销  ← 优化点2：桥接模式
宿主机OS
  ↓ 网络栈处理   ← 优化点3：内核参数
物理网络
  ↓ 硬件性能     ← 优化点4：硬件升级
```

### 8.2 虚拟网卡性能优化


**🚀 使用virtio网络驱动**

virtio是专为虚拟化优化的高性能驱动，比传统的e1000模拟网卡快很多。

```xml
<!-- 高性能网络接口配置 -->
<interface type='network'>
  <source network='default'/>
  <model type='virtio'/>           <!-- 使用virtio驱动 -->
  <driver name='vhost' queues='4'> <!-- 多队列支持 -->
    <host csum='off' gso='off' 
          tso4='off' tso6='off' 
          ecn='off' ufo='off'/>     <!-- 关闭不必要特性 -->
    <guest csum='off' tso4='off' 
           tso6='off' ecn='off' 
           ufo='off'/>
  </driver>
</interface>
```

**📊 网卡性能对比**
| 网卡类型 | **吞吐量** | **延迟** | **CPU使用率** | **适用场景** |
|---------|-----------|---------|--------------|-------------|
| **e1000** | `~100Mbps` | `高` | `高` | `兼容性要求高` |
| **rtl8139** | `~100Mbps` | `高` | `高` | `老系统兼容` |
| **virtio** | `~1Gbps+` | `低` | `低` | `现代Linux系统` |

### 8.3 网络模式性能优化


**🔸 选择最优网络模式**
```bash
# 性能排序（从高到低）：
# 1. SR-IOV直通 > 2. 桥接模式 > 3. macvtap > 4. NAT模式

# 桥接模式配置（推荐生产环境）
<interface type='bridge'>
  <source bridge='br0'/>
  <model type='virtio'/>
  <driver name='vhost' queues='4'/>
</interface>
```

**网络模式性能对比**：
```
性能测试结果（相对值）：
SR-IOV直通:  ████████████ 100% (接近物理性能)
桥接模式:    ██████████   85%  (生产推荐)  
macvtap:     ████████     70%  (轻量选择)
NAT模式:     ██████       50%  (开发测试)
```

### 8.4 系统级性能调优


**🔧 内核参数优化**
```bash
# 编辑系统配置
echo "# 网络性能优化" >> /etc/sysctl.conf

# 增大网络缓冲区
echo "net.core.rmem_max = 16777216" >> /etc/sysctl.conf
echo "net.core.wmem_max = 16777216" >> /etc/sysctl.conf

# TCP参数优化  
echo "net.ipv4.tcp_rmem = 4096 65536 16777216" >> /etc/sysctl.conf
echo "net.ipv4.tcp_wmem = 4096 65536 16777216" >> /etc/sysctl.conf

# 启用TCP窗口缩放
echo "net.ipv4.tcp_window_scaling = 1" >> /etc/sysctl.conf

# 应用配置
sysctl -p
```

**🔧 CPU亲和性设置**
```bash
# 为虚拟机绑定专用CPU核心
virsh vcpupin vm-name 0 2    # 虚拟CPU0绑定物理CPU2
virsh vcpupin vm-name 1 3    # 虚拟CPU1绑定物理CPU3

# 为网络中断绑定CPU核心
echo 4 > /proc/irq/24/smp_affinity  # 网卡中断绑定CPU2(二进制100=4)
```

### 8.5 网络性能监控


**📊 性能监控工具**
```bash
# 实时网络流量监控
iftop -i br0

# 详细网络统计
netstat -i

# 虚拟机网络统计
virsh domifstat vm-name vnet0

# 网络延迟测试
ping -c 100 target-ip | tail -1

# 带宽测试
iperf3 -c target-ip -t 30
```

**性能基准测试脚本**：
```bash
#!/bin/bash
# network-benchmark.sh

VM_NAME="test-vm"
INTERFACE="vnet0"

echo "开始网络性能测试..."

# 1. 获取基础信息
echo "=== 网络接口信息 ==="
virsh domiflist $VM_NAME

# 2. 流量统计
echo "=== 流量统计 ==="
virsh domifstat $VM_NAME $INTERFACE

# 3. 延迟测试
echo "=== 延迟测试 ==="
ping -c 10 8.8.8.8 | tail -1

# 4. 吞吐量测试（需要对端配合）
echo "=== 吞吐量测试 ==="
# iperf3 -c server-ip -t 10

echo "测试完成"
```

### 8.6 性能优化checklist


> 🎯 **优化清单**：

**✅ 硬件层面**
- [ ] 使用支持SR-IOV的网卡
- [ ] 确保充足的内存和CPU资源
- [ ] 使用SSD存储减少I/O瓶颈

**✅ 网络配置**
- [ ] 优先选择桥接网络模式
- [ ] 使用virtio网络驱动
- [ ] 启用多队列网络支持
- [ ] 关闭不必要的网络特性

**✅ 系统调优**
- [ ] 优化内核网络参数
- [ ] 配置CPU亲和性
- [ ] 调整网络缓冲区大小
- [ ] 禁用不必要的服务

**✅ 监控维护**
- [ ] 定期监控网络性能
- [ ] 建立性能基准线
- [ ] 及时处理网络瓶颈
- [ ] 记录优化效果

---

## 9. 🔍 网络故障诊断方法


### 9.1 网络故障分层诊断


**🔸 网络故障诊断思路**
```
网络故障诊断层次：

应用层故障
  ↓ 检查应用服务状态
传输层故障  
  ↓ 检查端口连通性
网络层故障
  ↓ 检查路由和IP配置
数据链路层故障
  ↓ 检查网桥和接口状态
物理层故障
  ↓ 检查硬件和驱动
```

### 9.2 常见网络故障及诊断


**🔧 虚拟机无法获取IP地址**

诊断步骤：
```bash
# 1. 检查虚拟机网络接口状态
virsh domiflist vm-name

# 2. 检查libvirt网络状态
virsh net-list --all
virsh net-info default

# 3. 检查dnsmasq服务
systemctl status libvirtd
ps aux | grep dnsmasq

# 4. 检查网桥状态
brctl show virbr0
ip addr show virbr0

# 5. 在虚拟机内检查
# （在虚拟机内执行）
dhclient -v eth0
ip addr show eth0
```

**🔧 虚拟机网络连通性问题**

分步诊断：
```bash
# 1. 基础连通性测试
ping -c 3 192.168.122.1  # ping网关
ping -c 3 8.8.8.8        # ping外网DNS

# 2. 路由表检查
route -n
ip route show

# 3. DNS解析测试
nslookup google.com
dig google.com

# 4. 防火墙规则检查
iptables -L -n
ufw status
```

### 9.3 网络性能问题诊断


**📊 性能问题排查**
```bash
# 1. 网络带宽测试
iperf3 -c server-ip -t 30

# 2. 网络延迟分析
mtr google.com

# 3. 网络丢包检查
ping -c 100 target-ip | grep "packet loss"

# 4. 网络接口统计
cat /proc/net/dev
netstat -i

# 5. 系统资源监控
top -p $(pgrep qemu)
iostat -x 1 5
```

### 9.4 网络配置问题诊断


**🔍 配置验证工具**
```bash
# 网络配置验证脚本
#!/bin/bash
# network-diagnosis.sh

echo "=== KVM网络配置诊断 ==="

# 1. libvirt服务状态
echo "1. libvirt服务状态:"
systemctl status libvirtd --no-pager

# 2. 虚拟网络列表
echo "2. 虚拟网络状态:"
virsh net-list --all

# 3. 网桥信息
echo "3. 网桥状态:"
brctl show

# 4. iptables NAT规则
echo "4. NAT规则:"
iptables -t nat -L -n

# 5. 虚拟机网络接口
echo "5. 虚拟机网络接口:"
for vm in $(virsh list --name); do
    echo "VM: $vm"
    virsh domiflist $vm
done
```

### 9.5 网络故障排除工具箱


**🛠️ 常用诊断命令**
```bash
# 网络接口工具
ip addr show                    # 查看IP配置
ip link show                    # 查看接口状态  
ip route show                   # 查看路由表
brctl show                      # 查看网桥信息

# 网络连通性测试
ping target-ip                  # 基础连通性
traceroute target-ip            # 路径跟踪
mtr target-ip                   # 网络诊断
telnet target-ip port           # 端口连通性

# 网络统计和监控
netstat -tuln                   # 端口监听状态
ss -tuln                        # 现代版netstat  
iftop                           # 实时流量监控
tcpdump -i interface           # 数据包捕获

# libvirt专用工具
virsh net-list --all           # 网络列表
virsh net-info network-name    # 网络详情
virsh domifstat vm interface   # 接口统计
```

### 9.6 故障处理流程


**📋 标准故障处理流程**

> 🚨 **紧急故障处理**：
> 1. **快速恢复**：先恢复服务，再分析原因
> 2. **备份现状**：保存故障时的配置和日志  
> 3. **逐步诊断**：按层次逐步排查问题
> 4. **文档记录**：记录故障现象和解决方案

**故障处理模板**：
```bash
#!/bin/bash
# 网络故障快速修复脚本

TIMESTAMP=$(date +%Y%m%d-%H%M%S)
LOG_FILE="/var/log/network-fix-${TIMESTAMP}.log"

log() {
    echo "[$(date)] $1" | tee -a $LOG_FILE
}

# 1. 备份当前状态
log "开始网络故障诊断..."
virsh net-list --all > /tmp/networks-${TIMESTAMP}.txt
iptables-save > /tmp/iptables-${TIMESTAMP}.txt

# 2. 重启基础服务
log "重启网络相关服务..."
systemctl restart libvirtd
systemctl restart systemd-networkd

# 3. 重启默认网络
log "重启默认网络..."
virsh net-destroy default 2>/dev/null
virsh net-start default

# 4. 验证修复结果
log "验证网络状态..."
if virsh net-list | grep -q "default.*active"; then
    log "网络修复成功"
else
    log "网络修复失败，需要人工干预"
fi
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 虚拟网络基础：libvirt管理的软件定义网络系统
🔸 网络模式选择：NAT适合测试，桥接适合生产，隔离适合安全
🔸 网络组件理解：虚拟交换机、网桥、DHCP、NAT的作用机制
🔸 热插拔操作：动态添加删除网络接口的方法和注意事项
🔸 VLAN隔离：网络分段和安全隔离的重要手段
🔸 性能优化：virtio驱动、桥接模式、系统参数调优
🔸 故障诊断：分层排查思路和常用工具命令
```

### 10.2 关键理解要点


**🔹 网络模式选择原则**
```
测试开发环境：
- NAT模式：简单安全，适合初学者
- 默认配置即可满足基本需求

生产服务环境：
- 桥接模式：性能最优，外部可直接访问
- 需要规划IP地址段

安全隔离环境：
- 隔离模式：完全内部通信
- VLAN模式：分层隔离管理
```

**🔹 性能优化重点**
```
驱动选择：virtio > e1000 > 其他模拟驱动
网络模式：桥接 > macvtap > NAT
硬件支持：SR-IOV > 普通网卡
系统调优：内核参数 + CPU亲和性
```

**🔹 故障诊断思路**
```
从下往上诊断：
物理层 → 数据链路层 → 网络层 → 传输层 → 应用层

从简单到复杂：
基础连通性 → 路由配置 → 防火墙规则 → 性能问题
```

### 10.3 实际应用指导


**💼 企业环境部署建议**
- **小型环境**：使用默认NAT网络，简单易管理
- **中型环境**：部署桥接网络，提供更好性能和灵活性
- **大型环境**：结合VLAN实现网络分段，提高安全性
- **高性能需求**：考虑SR-IOV直通技术

**🔧 运维最佳实践**
- **网络规划**：提前规划IP地址段和VLAN分配
- **配置备份**：定期备份网络配置文件
- **性能监控**：建立网络性能基准和监控体系  
- **故障预案**：准备常见故障的快速修复脚本
- **文档管理**：维护详细的网络拓扑和配置文档

**📊 监控指标建议**
- **连通性监控**：ping延迟、丢包率
- **性能监控**：带宽利用率、吞吐量
- **资源监控**：CPU使用率、内存使用率
- **错误监控**：网络错误计数、接口状态

### 10.4 学习进阶路径


**🎯 进阶学习建议**
```
初级阶段：
- 掌握基本的NAT和桥接配置
- 学会使用virsh命令管理网络
- 理解libvirt默认网络工作原理

中级阶段：  
- 学会创建自定义网络配置
- 掌握网络接口热插拔操作
- 理解VLAN配置和网络隔离

高级阶段：
- 深入理解网络性能优化
- 掌握SR-IOV等高级特性
- 具备复杂网络故障诊断能力
```

**🔗 相关技术扩展**
- **SDN软件定义网络**：OpenStack Neutron、OVS等
- **容器网络**：Docker网络、Kubernetes网络
- **云网络**：VPC、负载均衡、CDN等
- **网络安全**：防火墙、VPN、网络入侵检测

**核心记忆口诀**：
- 虚拟网络libvirt管，NAT桥接要选好
- 热插拔时需谨慎，VLAN隔离保安全  
- 性能优化选virtio，故障诊断分层查
- 监控运维要跟上，文档备份不能忘