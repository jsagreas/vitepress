---
title: 12、logrotate日志轮转配置
---
## 📚 目录

1. [日志轮转基本概念](#1-日志轮转基本概念)
2. [logrotate.conf全局配置](#2-logrotate-conf全局配置)
3. [logrotate.d目录配置详解](#3-logrotate-d目录配置详解)
4. [轮转策略与参数配置](#4-轮转策略与参数配置)
5. [脚本钩子配置](#5-脚本钩子配置)
6. [测试与验证方法](#6-测试与验证方法)
7. [常见轮转策略实践](#7-常见轮转策略实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 📋 日志轮转基本概念


### 1.1 什么是日志轮转


**💡 核心理解**：日志轮转就像定期整理文件夹，把旧文件归档，给新文件腾地方。

```
日志轮转的本质：
旧日志文件 → 重命名归档 → 新日志文件诞生

实际效果：
access.log (当前) → access.log.1 (昨天) → access.log.2 (前天)
                 ↓
              新的access.log (今天开始记录)
```

### 1.2 为什么需要日志轮转


**🎯 主要目的**：
- **磁盘管理**：防止日志文件无限增长占满硬盘
- **性能优化**：大文件读写慢，小文件操作快
- **便于分析**：按时间分割，方便查找特定时期的日志
- **合规要求**：很多企业要求保留特定时间的日志记录

### 1.3 logrotate工作原理


```
logrotate运行流程：

cron定时任务 → /usr/sbin/logrotate → 读取配置文件
     ↓                                      ↓
检查轮转条件 ← ← ← ← ← ← ← ← ← ← ← ← ← /etc/logrotate.conf
     ↓                                      ↓
满足条件？ → 是 → 执行轮转动作 → 完成     /etc/logrotate.d/*
     ↓
     否 → 跳过等待下次检查
```

---

## 2. ⚙️ logrotate.conf全局配置


### 2.1 主配置文件位置与作用


**📍 文件位置**：`/etc/logrotate.conf`

**🔸 作用说明**：
- 设置全局默认规则
- 定义所有日志轮转的基础行为
- 包含具体服务配置目录

### 2.2 全局配置参数详解


```bash
# /etc/logrotate.conf 核心配置示例

# 轮转周期：每周轮转一次
weekly

# 保留数量：保留4个轮转后的文件
rotate 4

# 创建新文件：轮转后创建新的空日志文件
create

# 压缩选项：对轮转的日志进行压缩
compress

# 包含配置目录：加载具体服务的配置
include /etc/logrotate.d
```

**🔍 参数含义解释**：

| 参数 | **含义** | **实际效果** |
|------|----------|-------------|
| `weekly` | `每周轮转` | `7天后自动轮转日志` |
| `rotate 4` | `保留4份` | `超过4个旧文件就删除最老的` |
| `create` | `创建新文件` | `轮转后立即生成空的新日志文件` |
| `compress` | `压缩归档` | `旧日志文件用gzip压缩节省空间` |

### 2.3 全局配置最佳实践


```bash
# 推荐的全局配置
weekly                    # 周轮转，平衡频率与性能
rotate 8                  # 保留8周，约2个月的历史
create 640 root adm      # 新文件权限和所有者
compress                 # 压缩节省空间
delaycompress           # 延迟压缩，避免程序还在写入
notifempty              # 空文件不轮转
missingok               # 文件丢失不报错
```

---

## 3. 📁 logrotate.d目录配置详解


### 3.1 服务特定配置目录


**📍 目录位置**：`/etc/logrotate.d/`

**🎯 设计理念**：每个服务一个配置文件，模块化管理更清晰。

```
/etc/logrotate.d/ 目录结构示例：
├── apache2          # Apache服务器日志轮转
├── nginx           # Nginx服务器日志轮转  
├── mysql-server    # MySQL数据库日志轮转
├── rsyslog         # 系统日志轮转
└── custom-app      # 自定义应用日志轮转
```

### 3.2 Nginx配置实例详解


```bash
# /etc/logrotate.d/nginx 配置文件
/var/log/nginx/*.log {
    # 轮转频率：每天轮转
    daily
    
    # 保留份数：保留30天的日志
    rotate 30
    
    # 空文件处理：空日志不轮转
    notifempty
    
    # 文件权限：新文件权限设置
    create 640 www-data adm
    
    # 压缩设置：压缩但延迟一天
    compress
    delaycompress
    
    # 错误处理：配置文件丢失不报错
    missingok
    
    # 重启服务：轮转后重新加载nginx
    postrotate
        /bin/kill -USR1 $(cat /var/run/nginx.pid 2>/dev/null) 2>/dev/null || true
    endscript
}
```

**🔍 配置解读**：

> **路径通配符**：`/var/log/nginx/*.log` 匹配所有nginx日志文件
> 
> **daily + rotate 30**：每天轮转，保留一个月历史
>
> **postrotate脚本**：轮转完成后通知nginx重新打开日志文件

### 3.3 MySQL配置实例


```bash
# /etc/logrotate.d/mysql-server
/var/log/mysql/*.log {
    weekly
    rotate 52        # 保留一年的周日志
    missingok
    notifempty
    compress
    delaycompress
    create 640 mysql adm
    
    # MySQL特殊处理：需要刷新日志
    postrotate
        if test -x /usr/bin/mysqladmin && \
           /usr/bin/mysqladmin ping &>/dev/null
        then
            /usr/bin/mysqladmin flush-logs
        fi
    endscript
}
```

---

## 4. 🎛️ 轮转策略与参数配置


### 4.1 轮转频率控制


**⏰ 时间周期选项**：

```bash
daily      # 每天轮转（高频服务器）
weekly     # 每周轮转（中等负载）  
monthly    # 每月轮转（低频应用）
yearly     # 每年轮转（归档日志）
```

**📊 选择建议**：

| 服务类型 | **推荐频率** | **原因** |
|---------|-------------|---------|
| `Web服务器` | `daily` | `访问量大，日志增长快` |
| `数据库` | `weekly` | `日志相对稳定` |
| `系统日志` | `weekly` | `内容变化适中` |
| `应用日志` | `daily/weekly` | `根据业务量决定` |

### 4.2 文件大小控制


```bash
# 按大小轮转，不受时间限制
/var/log/app.log {
    size 100M        # 文件达到100M就轮转
    rotate 10
    compress
    create 644 root root
}

# 组合条件：时间或大小满足其一就轮转
/var/log/busy-app.log {
    daily           # 每天检查
    size 50M        # 或者达到50M
    rotate 15
    compress
}
```

### 4.3 保留策略配置


**🗂️ 数量控制**：

```bash
rotate 7     # 保留7个轮转文件
rotate 30    # 保留30个轮转文件  
rotate 365   # 保留365个文件（适合daily）
```

**📅 时间计算示例**：

```
daily + rotate 30   = 保留30天历史
weekly + rotate 8   = 保留8周历史（约2个月）
monthly + rotate 12 = 保留12个月历史（1年）
```

### 4.4 压缩与删除配置


```bash
# 压缩相关配置
compress              # 启用压缩
nocompress           # 禁用压缩
delaycompress        # 延迟压缩（推荐）
compresscmd gzip     # 指定压缩命令
compressext .gz      # 压缩文件扩展名
compressoptions -9   # 压缩选项（最高压缩比）

# 文件处理配置  
create 644 user group    # 创建新文件及权限
copy                     # 复制而不是移动
copytruncate            # 复制后截断原文件
notifempty              # 空文件不轮转
missingok               # 文件不存在不报错
```

---

## 5. ⚡ 脚本钩子配置


### 5.1 prerotate脚本


**🎯 作用时机**：在日志轮转**之前**执行

```bash
/var/log/application.log {
    daily
    rotate 7
    
    # 轮转前执行的脚本
    prerotate
        # 检查磁盘空间
        if [ $(df /var/log | tail -1 | awk '{print $4}') -lt 1000000 ]; then
            echo "磁盘空间不足，清理临时文件"
            find /tmp -name "*.tmp" -delete
        fi
    endscript
    
    compress
    create 644 app app
}
```

**💡 常用场景**：
- 检查磁盘空间
- 停止相关服务
- 备份重要配置
- 环境预检查

### 5.2 postrotate脚本


**🎯 作用时机**：在日志轮转**之后**执行

```bash
/var/log/custom-app/*.log {
    weekly
    rotate 12
    
    compress
    delaycompress
    create 640 appuser appgroup
    
    # 轮转后执行的脚本
    postrotate
        # 通知应用重新打开日志文件
        /bin/kill -HUP $(cat /var/run/custom-app.pid) 2>/dev/null || true
        
        # 发送轮转完成通知
        echo "日志轮转完成: $(date)" | mail -s "Log Rotation" admin@company.com
        
        # 上传日志到备份服务器
        rsync -az /var/log/custom-app/*.gz backup-server:/backup/logs/
    endscript
}
```

### 5.3 脚本最佳实践


**✅ 推荐做法**：

```bash
postrotate
    # 1. 错误处理：命令失败不影响轮转
    /bin/kill -USR1 $(cat /var/run/app.pid 2>/dev/null) 2>/dev/null || true
    
    # 2. 条件执行：检查服务是否运行
    if systemctl is-active --quiet nginx; then
        systemctl reload nginx
    fi
    
    # 3. 日志记录：记录轮转操作
    logger "nginx日志轮转完成"
endscript
```

**❌ 避免错误**：
- 不要在脚本中使用阻塞命令
- 避免复杂的逻辑处理
- 不要依赖外部不稳定的服务

---

## 6. 🔍 测试与验证方法


### 6.1 手动测试轮转


```bash
# 测试特定配置文件
sudo logrotate -d /etc/logrotate.d/nginx
# -d 参数：调试模式，只显示会做什么，不实际执行

# 强制执行轮转（忽略时间条件）  
sudo logrotate -f /etc/logrotate.d/nginx
# -f 参数：强制轮转，即使条件不满足

# 详细输出模式
sudo logrotate -v /etc/logrotate.conf
# -v 参数：显示详细的执行过程
```

### 6.2 验证轮转结果


**📋 检查清单**：

```bash
# 1. 查看日志文件列表
ls -la /var/log/nginx/
# 应该看到：access.log, access.log.1, access.log.2.gz 等

# 2. 检查文件权限和所有者
ls -l /var/log/nginx/access.log
# 确认新文件的权限和所有者正确

# 3. 验证服务正常运行
systemctl status nginx
# 确保服务重启/重载成功

# 4. 检查日志写入
tail -f /var/log/nginx/access.log
# 访问网站，确认新日志正在写入
```

### 6.3 故障排查方法


**🚨 常见问题诊断**：

```bash
# 查看logrotate执行历史
sudo cat /var/lib/logrotate/status
# 显示每个配置文件的最后轮转时间

# 检查cron执行记录
sudo grep logrotate /var/log/cron
# 确认定时任务正常执行

# 手动执行查看错误
sudo logrotate -v /etc/logrotate.conf
# 观察是否有错误信息输出
```

---

## 7. 📈 常见轮转策略实践


### 7.1 高流量Web服务器策略


```bash
# 适用于：日PV百万级以上的网站
/var/log/nginx/access.log {
    hourly               # 按小时轮转
    rotate 168          # 保留7天（7×24小时）
    size 500M           # 或文件超过500M
    compress
    delaycompress
    notifempty
    create 644 www-data adm
    
    postrotate
        /bin/kill -USR1 $(cat /var/run/nginx.pid) || true
        # 实时上传到日志分析系统
        /usr/local/bin/upload-logs.sh &
    endscript
}
```

### 7.2 数据库服务器策略


```bash
# MySQL慢查询日志轮转
/var/log/mysql/slow.log {
    weekly              # 每周轮转
    rotate 12          # 保留3个月
    size 100M          # 大小限制
    compress
    delaycompress
    missingok
    notifempty
    create 640 mysql mysql
    
    postrotate
        # 刷新MySQL日志
        /usr/bin/mysqladmin --defaults-file=/etc/mysql/debian.cnf \
            flush-logs 2>/dev/null || true
    endscript
}
```

### 7.3 应用程序日志策略


```bash
# Java应用日志轮转
/opt/app/logs/*.log {
    daily
    rotate 30          # 保留1个月
    size 200M         # 单文件大小限制
    compress
    delaycompress
    copytruncate      # 复制截断方式，适合持续写入的应用
    notifempty
    missingok
    
    postrotate
        # 清理临时文件
        find /opt/app/temp -name "*.tmp" -mtime +1 -delete
        # 发送统计报告
        /opt/app/bin/log-stats.sh
    endscript
}
```

### 7.4 系统日志策略


```bash
# 系统关键日志
/var/log/messages /var/log/secure /var/log/maillog {
    weekly
    rotate 52          # 保留一年
    compress
    delaycompress
    missingok
    notifempty
    create 600 root root
    
    postrotate
        # 重启rsyslog服务
        /bin/systemctl reload rsyslog.service 2>/dev/null || true
        # 发送重要日志摘要
        /usr/local/bin/security-summary.sh
    endscript
}
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 日志轮转本质：定期归档旧日志，创建新日志文件
🔸 配置层级：全局配置(/etc/logrotate.conf) + 服务配置(/etc/logrotate.d/*)  
🔸 轮转条件：时间周期(daily/weekly) + 文件大小(size)
🔸 处理动作：创建、压缩、删除、重新加载服务
🔸 脚本钩子：prerotate(轮转前) + postrotate(轮转后)
```

### 8.2 关键理解要点


**🔹 轮转时机的选择**：
```
高频服务：daily + size限制，确保及时轮转
普通服务：weekly，平衡性能和管理便利
低频服务：monthly，减少不必要的轮转开销
```

**🔹 压缩策略的权衡**：
```
compress + delaycompress：节省空间，避免程序写入冲突
仅compress：立即压缩，适合已停止写入的日志
nocompress：保留原格式，便于实时查看和分析
```

**🔹 脚本钩子的作用**：
```
prerotate：环境预检查、服务暂停、资源清理
postrotate：服务重载、通知发送、文件上传
重点：必须处理异常，不能影响轮转过程
```

### 8.3 实际应用指导


**📋 配置检查清单**：
- ✅ 确认cron定时任务正常运行
- ✅ 验证日志文件路径和权限正确
- ✅ 测试postrotate脚本的执行效果
- ✅ 监控磁盘使用量和轮转频率匹配
- ✅ 定期检查轮转状态文件

**🎯 性能优化建议**：
```
大文件处理：copytruncate适合持续写入的应用
压缩策略：delaycompress避免程序写入冲突  
保留策略：根据合规要求和磁盘空间平衡
监控告警：关键日志轮转失败要及时通知
```

**🔧 故障处理思路**：
```
轮转不生效：检查cron服务和配置文件语法
权限问题：确认logrotate运行用户权限
空间不足：调整保留数量或增加压缩
服务异常：检查postrotate脚本的服务重载命令
```

> 💡 **一句话总结**：logrotate让日志管理自动化，通过合理配置轮转周期、保留策略和脚本钩子，实现日志的高效归档和磁盘空间管理。

> 🔑 **核心记忆**：全局设默认，服务配个性，轮转靠时间，脚本保平稳，测试验结果，监控防故障。