---
title: 8、iptables防火墙配置
---
## 📚 目录

1. [iptables基础概念理解](#1-iptables基础概念理解)
2. [配置文件位置与作用](#2-配置文件位置与作用)
3. [iptables规则语法结构](#3-iptables规则语法结构)
4. [三大核心链详解](#4-三大核心链详解)
5. [动作配置详解](#5-动作配置详解)
6. [端口开放与服务控制](#6-端口开放与服务控制)
7. [NAT网络地址转换](#7-nat网络地址转换)
8. [规则备份与恢复](#8-规则备份与恢复)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔥 iptables基础概念理解


### 1.1 什么是iptables

> 💡 **通俗理解**：iptables就像是Linux系统的**门卫**，决定哪些数据包能进来、哪些能出去、哪些能通过

**核心概念**：
- **防火墙工具**：Linux系统内置的网络防火墙管理工具
- **规则集合**：通过一系列规则来过滤网络数据包
- **内核级别**：工作在Linux内核的netfilter框架上

### 1.2 iptables工作原理图示

```
外网数据包流向示意图：

外网 → 路由器 → Linux系统
         ↓
    [INPUT链检查]
         ↓
     本机程序处理
         ↓
    [OUTPUT链检查]
         ↓
    数据包发出到外网

数据包转发流向：
外网 → [INPUT] → [FORWARD] → [OUTPUT] → 内网
```

### 1.3 iptables的作用

**🔸 主要功能**：
- **访问控制**：允许或拒绝特定的网络连接
- **端口管理**：开放或关闭特定端口
- **IP过滤**：基于源IP或目标IP进行过滤
- **网络转换**：NAT地址转换功能

---

## 2. 📁 配置文件位置与作用


### 2.1 主要配置文件

> 🔸 **重要**：理解配置文件位置是管理防火墙的基础

**核心配置文件**：
```
/etc/sysconfig/iptables    ← 主要规则配置文件
/etc/sysconfig/ip6tables   ← IPv6规则配置文件
/etc/sysconfig/iptables-config  ← 防火墙服务配置
```

### 2.2 配置文件作用说明

```
文件功能详解：

📄 /etc/sysconfig/iptables
作用：存储所有防火墙规则
特点：系统启动时自动加载
格式：iptables-save命令导出的格式

📄 /etc/sysconfig/iptables-config  
作用：防火墙服务的配置选项
内容：模块加载、备份设置等
影响：服务启动行为
```

### 2.3 文件查看与编辑

```bash
# 查看当前规则文件
cat /etc/sysconfig/iptables

# 编辑规则文件（谨慎操作）
vi /etc/sysconfig/iptables

# 查看防火墙服务配置
cat /etc/sysconfig/iptables-config
```

---

## 3. 📝 iptables规则语法结构


### 3.1 基本语法格式

> 💡 **记忆要点**：iptables规则就像写句子，有固定的语法结构

**标准语法**：
```
iptables -t 表名 -操作 链名 -匹配条件 -动作

基本结构拆解：
-t table    ← 指定表（filter、nat、mangle）
-A/-I/-D    ← 操作类型（添加、插入、删除）
INPUT/OUTPUT ← 链名称
-s/-d       ← 源地址/目标地址
-p          ← 协议类型
--dport     ← 目标端口
-j          ← 执行动作
```

### 3.2 常用参数详解

| **参数** | **含义** | **示例** | **说明** |
|---------|---------|---------|---------|
| **-t** | 指定表 | `-t filter` | 默认filter表 |
| **-A** | 追加规则 | `-A INPUT` | 在链末尾添加 |
| **-I** | 插入规则 | `-I INPUT 1` | 在指定位置插入 |
| **-D** | 删除规则 | `-D INPUT 1` | 删除指定规则 |
| **-s** | 源地址 | `-s 192.168.1.0/24` | 来源IP范围 |
| **-d** | 目标地址 | `-d 10.0.0.1` | 目标IP |
| **-p** | 协议 | `-p tcp` | tcp/udp/icmp |
| **--dport** | 目标端口 | `--dport 80` | 端口号 |
| **-j** | 动作 | `-j ACCEPT` | 执行动作 |

### 3.3 规则语法示例

```bash
# 简单规则示例
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
#        ↑     ↑   ↑      ↑        ↑
#       追加  INPUT链 TCP协议  22端口  允许通过

# 复杂规则示例  
iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 80 -j ACCEPT
#                 ↑                          ↑
#            来源IP段限制                   HTTP端口
```

---

## 4. ⚖️ 三大核心链详解


### 4.1 INPUT链 - 进入本机

> 🔸 **理解要点**：INPUT链控制**进入本机**的数据包

**作用说明**：
```
INPUT链处理流程：

外网数据包 → 网卡接收 → INPUT链检查 → 本机程序
                        ↓
                   [规则匹配]
                        ↓
                 ACCEPT/DROP/REJECT
```

**常见应用场景**：
- ✅ **SSH远程登录**：允许22端口访问
- ✅ **Web服务访问**：开放80/443端口
- ✅ **数据库连接**：限制3306端口访问IP

**典型配置示例**：
```bash
# 允许SSH登录
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 允许HTTP访问
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# 只允许内网访问数据库
iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 3306 -j ACCEPT
```

### 4.2 OUTPUT链 - 从本机出去

> 🔸 **理解要点**：OUTPUT链控制**从本机发出**的数据包

**作用说明**：
```
OUTPUT链处理流程：

本机程序 → OUTPUT链检查 → 网卡发送 → 外网
            ↓
       [规则匹配]
            ↓
    ACCEPT/DROP/REJECT
```

**应用场景**：
- ✅ **访问外网限制**：控制服务器主动外联
- ✅ **域名解析**：允许DNS查询
- ✅ **软件更新**：允许yum/apt更新

**配置示例**：
```bash
# 允许DNS查询
iptables -A OUTPUT -p udp --dport 53 -j ACCEPT

# 允许HTTP/HTTPS访问外网
iptables -A OUTPUT -p tcp --dport 80 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 443 -j ACCEPT
```

### 4.3 FORWARD链 - 转发通过

> 🔸 **理解要点**：FORWARD链控制**经过本机转发**的数据包

**作用说明**：
```
FORWARD链应用场景：

内网设备 → Linux网关 → 外网
           ↓
    [FORWARD链检查]
           ↓
    控制转发规则
```

**典型应用**：
- ✅ **路由器功能**：Linux作为网关设备
- ✅ **内网访问控制**：限制内网设备外网访问
- ✅ **流量转发**：数据包中转

**配置示例**：
```bash
# 允许内网访问外网
iptables -A FORWARD -s 192.168.1.0/24 -j ACCEPT

# 允许外网回应数据包
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
```

---

## 5. 🎯 动作配置详解


### 5.1 ACCEPT - 允许通过

> 💡 **通俗理解**：ACCEPT就是"绿灯"，让数据包顺利通过

**基本含义**：
- **允许通过**：数据包可以继续传输
- **常用场景**：开放服务端口、允许特定IP访问

```bash
# 允许SSH连接
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 允许ping请求  
iptables -A INPUT -p icmp -j ACCEPT
```

### 5.2 DROP - 直接丢弃

> ⚠️ **注意**：DROP是"悄悄扔掉"，不告诉对方

**特点分析**：
```
DROP动作特点：

数据包处理：直接丢弃，不回应
对方感受：连接超时，不知道被拒绝
安全性：较高，不暴露服务信息
用户体验：连接等待时间长
```

**适用场景**：
- ✅ **恶意IP屏蔽**：不想让攻击者知道服务状态
- ✅ **隐藏服务**：让不开放的端口看起来不存在

```bash
# 丢弃来自恶意IP的所有连接
iptables -A INPUT -s 123.123.123.123 -j DROP

# 丢弃对未开放端口的访问
iptables -A INPUT -p tcp --dport 3389 -j DROP
```

### 5.3 REJECT - 拒绝并回应

> 🔄 **通俗理解**：REJECT是"明确拒绝"，会告诉对方被拒绝了

**特点对比**：
| **动作** | **处理方式** | **对方感受** | **响应速度** | **安全性** |
|---------|------------|------------|------------|-----------|
| **ACCEPT** | 允许通过 | 连接成功 | 快 | - |
| **DROP** | 悄悄丢弃 | 连接超时 | 慢 | 高 |
| **REJECT** | 明确拒绝 | 连接被拒绝 | 快 | 中 |

**应用示例**：
```bash
# 拒绝特定网段访问
iptables -A INPUT -s 10.0.0.0/8 -j REJECT

# 拒绝访问并返回端口不可达
iptables -A INPUT -p tcp --dport 23 -j REJECT --reject-with tcp-reset
```

---

## 6. 🚪 端口开放与服务访问控制


### 6.1 常见服务端口开放

> 📋 **实用技能**：掌握常见服务的端口开放方法

**Web服务端口**：
```bash
# HTTP服务 (端口80)
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# HTTPS服务 (端口443)  
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 同时开放多个端口
iptables -A INPUT -p tcp -m multiport --dports 80,443 -j ACCEPT
```

**远程管理端口**：
```bash
# SSH服务 (端口22)
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 限制SSH只能从特定IP访问
iptables -A INPUT -s 192.168.1.100 -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j DROP
```

### 6.2 数据库服务控制

**MySQL数据库示例**：
```bash
# 只允许应用服务器访问数据库
iptables -A INPUT -s 192.168.1.10 -p tcp --dport 3306 -j ACCEPT
iptables -A INPUT -p tcp --dport 3306 -j REJECT

# 允许整个内网访问  
iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 3306 -j ACCEPT
```

### 6.3 端口范围控制

```bash
# 开放端口范围 (如FTP被动模式)
iptables -A INPUT -p tcp --dport 21000:21010 -j ACCEPT

# 使用multiport模块开放多个不连续端口
iptables -A INPUT -p tcp -m multiport --dports 80,443,8080,8443 -j ACCEPT
```

### 6.4 服务访问时间控制

```bash
# 只在工作时间允许SSH访问 (9:00-18:00)
iptables -A INPUT -p tcp --dport 22 -m time --timestart 09:00 --timestop 18:00 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j DROP
```

---

## 7. 🔄 NAT网络地址转换


### 7.1 NAT基本概念

> 💡 **通俗理解**：NAT就像"地址翻译官"，把内网IP转换成外网IP

**NAT作用图示**：
```
内网设备访问外网流程：

内网设备                Linux网关                  外网服务器
192.168.1.10    →    [NAT转换]    →         目标服务器
  ↓                     ↓                        ↓
原始数据包           修改源IP为公网IP              接收处理
源IP: 192.168.1.10   源IP: 公网IP               看到的是公网IP
目标IP: 外网IP       目标IP: 外网IP             源IP: 公网IP
```

### 7.2 SNAT源地址转换

> 🔸 **应用场景**：内网设备通过Linux网关访问外网

**基本配置**：
```bash
# 基础SNAT规则 - 固定公网IP
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j SNAT --to-source 公网IP

# 动态IP环境使用MASQUERADE
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE
```

**实际应用示例**：
```bash
# 允许内网访问外网 (前提需要开启IP转发)
echo 1 > /proc/sys/net/ipv4/ip_forward

# 配置SNAT让内网可以访问外网
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE

# 允许转发
iptables -A FORWARD -s 192.168.1.0/24 -j ACCEPT
iptables -A FORWARD -d 192.168.1.0/24 -j ACCEPT
```

### 7.3 DNAT目标地址转换  

> 🔸 **应用场景**：外网访问内网服务器（端口映射）

**端口映射示例**：
```bash
# 将外网80端口映射到内网Web服务器
iptables -t nat -A PREROUTING -d 公网IP -p tcp --dport 80 -j DNAT --to-destination 192.168.1.10:80

# 允许转发到内网服务器
iptables -A FORWARD -d 192.168.1.10 -p tcp --dport 80 -j ACCEPT
```

### 7.4 完整NAT配置示例

```bash
# 1. 开启IP转发
echo 1 > /proc/sys/net/ipv4/ip_forward

# 2. 配置SNAT (内网访问外网)
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE

# 3. 配置DNAT (外网访问内网服务)
iptables -t nat -A PREROUTING -d 公网IP -p tcp --dport 80 -j DNAT --to-destination 192.168.1.10:80
iptables -t nat -A PREROUTING -d 公网IP -p tcp --dport 22 -j DNAT --to-destination 192.168.1.10:22

# 4. 配置FORWARD规则
iptables -A FORWARD -s 192.168.1.0/24 -j ACCEPT
iptables -A FORWARD -d 192.168.1.0/24 -j ACCEPT
```

---

## 8. 💾 规则备份与恢复


### 8.1 规则备份方法

> ⚠️ **重要提醒**：修改防火墙前必须先备份，避免锁死系统

**手动备份命令**：
```bash
# 备份当前规则到文件
iptables-save > /etc/sysconfig/iptables.backup

# 备份时添加时间戳
iptables-save > /etc/sysconfig/iptables.backup.$(date +%Y%m%d)

# 查看备份文件
ls -la /etc/sysconfig/iptables*
```

**自动备份脚本**：
```bash
#!/bin/bash
# 防火墙规则备份脚本

BACKUP_DIR="/root/iptables_backup"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/iptables_$DATE.rules"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份当前规则
iptables-save > $BACKUP_FILE

# 保留最近7天的备份
find $BACKUP_DIR -name "iptables_*.rules" -mtime +7 -delete

echo "规则已备份到: $BACKUP_FILE"
```

### 8.2 规则恢复方法

**基本恢复命令**：
```bash
# 从备份文件恢复
iptables-restore < /etc/sysconfig/iptables.backup

# 恢复系统默认规则文件
iptables-restore < /etc/sysconfig/iptables
```

**安全恢复技巧**：
```bash
# 临时测试规则 (5分钟后自动恢复)
(sleep 300 && iptables-restore < /etc/sysconfig/iptables.backup) &

# 应用新规则
iptables-restore < /etc/sysconfig/iptables.new

# 如果连接正常，取消自动恢复
kill %1
```

### 8.3 服务管理与持久化

**服务操作命令**：
```bash
# CentOS 6/7 系统
service iptables save     # 保存当前规则
service iptables start    # 启动防火墙
service iptables stop     # 停止防火墙  
service iptables restart  # 重启防火墙

# CentOS 8/RHEL 8 系统
systemctl start iptables
systemctl enable iptables
systemctl status iptables
```

**规则持久化**：
```bash
# 临时规则持久化保存
iptables-save > /etc/sysconfig/iptables

# 设置开机自动加载
systemctl enable iptables
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的基础概念

> 💎 **核心理解**：iptables是Linux系统的网络防火墙工具

```
🔸 基本概念：iptables = 网络数据包过滤器 + 规则管理工具
🔸 工作原理：基于规则匹配 → 执行对应动作
🔸 核心文件：/etc/sysconfig/iptables存储规则
🔸 三大链条：INPUT(进)、OUTPUT(出)、FORWARD(转)
🔸 三大动作：ACCEPT(允许)、DROP(丢弃)、REJECT(拒绝)
```

### 9.2 实用操作要点

**🔧 日常管理技巧**：
- ✅ **规则顺序**：iptables按顺序匹配，先匹配先生效
- ✅ **备份习惯**：修改前必须备份，防止锁死系统  
- ✅ **测试方法**：使用临时规则+定时恢复测试
- ✅ **服务管理**：修改后要保存并重启服务

**⚠️ 安全注意事项**：
- **远程操作**：SSH环境下修改防火墙要格外小心
- **默认策略**：建议设置合理的默认DROP策略
- **规则顺序**：具体规则放在前面，通用规则放在后面

### 9.3 常用场景配置模板

**🎯 Web服务器配置**：
```bash
# 基础Web服务器防火墙配置
iptables -A INPUT -p tcp --dport 22 -j ACCEPT    # SSH
iptables -A INPUT -p tcp --dport 80 -j ACCEPT    # HTTP  
iptables -A INPUT -p tcp --dport 443 -j ACCEPT   # HTTPS
iptables -A INPUT -p icmp -j ACCEPT              # ping
iptables -A INPUT -i lo -j ACCEPT                # 本地回环
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -P INPUT DROP                           # 默认拒绝
```

**🌐 NAT网关配置**：
```bash
# 基础NAT网关配置
echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE
iptables -A FORWARD -s 192.168.1.0/24 -j ACCEPT
iptables -A FORWARD -d 192.168.1.0/24 -m state --state ESTABLISHED,RELATED -j ACCEPT
```

### 9.4 故障排除要点

**🔍 常见问题解决**：
- **连接被拒绝**：检查对应端口的INPUT规则
- **无法访问外网**：检查OUTPUT规则和NAT配置
- **规则不生效**：确认规则顺序和服务状态
- **配置丢失**：检查规则是否已保存到配置文件

**核心记忆口诀**：
> 🎯 **防火墙三步走**：备份规则保安全，语法结构要记清，测试生效再保存  
> 🔥 **链条动作要分清**：INPUT进OUTPUT出，FORWARD转发要记住，ACCEPT放行DROP扔，REJECT拒绝有回应