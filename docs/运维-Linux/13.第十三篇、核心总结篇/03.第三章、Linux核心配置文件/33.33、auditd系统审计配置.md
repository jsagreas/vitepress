---
title: 33、auditd系统审计配置
---
## 📚 目录

1. [auditd系统审计概述](#1-auditd系统审计概述)
2. [审计守护进程配置文件](#2-审计守护进程配置文件)
3. [审计规则配置目录详解](#3-审计规则配置目录详解)
4. [文件访问审计配置](#4-文件访问审计配置)
5. [系统调用审计配置](#5-系统调用审计配置)
6. [用户操作审计配置](#6-用户操作审计配置)
7. [审计日志轮转配置](#7-审计日志轮转配置)
8. [审计数据分析与查询](#8-审计数据分析与查询)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔍 auditd系统审计概述


### 1.1 什么是auditd审计系统


**简单理解**：auditd就像给Linux系统安装了一个"监控摄像头"，专门记录系统中发生的各种操作。

```
想象一个银行的场景：
🏦 银行大厅 = Linux系统
📹 监控摄像头 = auditd审计系统
📋 监控记录 = 审计日志

功能：记录谁在什么时间做了什么操作
```

**核心作用**：
- **🔒 安全监控**：跟踪可疑操作和入侵行为
- **📊 合规审计**：满足法规要求的操作记录
- **🔍 问题排查**：帮助定位系统问题的根源
- **📈 行为分析**：分析用户和系统的操作模式

### 1.2 auditd工作原理


**工作流程图示**：
```
用户操作 → 内核audit子系统 → auditd守护进程 → 审计日志文件
    ↓              ↓              ↓              ↓
  登录文件       捕获事件       格式化记录      存储分析
  创建删除       系统调用       添加时间戳      日志轮转
  权限变更       网络连接       过滤规则        查询分析
```

**核心组件**：
- **内核audit子系统**：在内核层面捕获事件
- **auditd守护进程**：用户空间的审计服务
- **审计规则**：定义要监控哪些操作
- **审计日志**：存储所有审计记录

---

## 2. ⚙️ 审计守护进程配置文件


### 2.1 /etc/audit/auditd.conf主配置文件


这个文件是auditd的"大脑"，控制审计系统如何工作。

**配置文件结构图示**：
```
/etc/audit/auditd.conf
├── 日志存储配置
├── 日志文件管理
├── 性能调优设置
├── 网络传输配置
└── 安全策略配置
```

### 2.2 核心配置参数详解


**📁 日志存储配置**

| 配置参数 | **作用说明** | **推荐值** | **通俗理解** |
|---------|------------|-----------|------------|
| `log_file` | 审计日志存放位置 | `/var/log/audit/audit.log` | 日志放在哪个文件夹里 |
| `log_format` | 日志记录格式 | `ENRICHED` | 日志内容的详细程度 |
| `log_group` | 日志文件所属组 | `root` | 哪个用户组能读日志 |
| `priority_boost` | 进程优先级 | `4` | 审计进程的重要程度 |

**💾 日志文件管理**

```bash
# 主要配置项说明
max_log_file = 50          # 单个日志文件最大50MB
num_logs = 10              # 最多保留10个日志文件
max_log_file_action = rotate   # 日志满了就轮转
space_left = 200           # 剩余200MB时发警告
space_left_action = email  # 空间不足时发邮件通知
```

**通俗解释**：
- `max_log_file`：就像设定每个记事本最多写50页
- `num_logs`：最多准备10个记事本，写满了就用新的
- `space_left`：硬盘空间剩下200MB时提醒你
- `space_left_action`：空间不够时发邮件通知管理员

### 2.3 性能调优配置


**🚀 性能相关设置**

```bash
# 缓冲区设置
freq = 50                  # 每秒最多写50次日志
disp_qos = lossy          # 网络传输质量控制
dispatcher = /sbin/audispd # 日志分发程序路径
```

**关键理解**：
- `freq`：控制写入频率，避免频繁写磁盘影响性能
- `disp_qos`：网络不稳定时是否允许丢失部分日志
- `dispatcher`：负责将日志发送到其他系统

---

## 3. 📂 审计规则配置目录详解


### 3.1 /etc/audit/rules.d/目录结构


这个目录存放所有的审计规则文件，每个文件定义不同类型的监控规则。

**目录结构展示**：
```
/etc/audit/rules.d/
├── audit.rules           ← 主规则文件（自动生成）
├── 10-base-config.rules  ← 基础配置规则
├── 30-stig.rules         ← 安全技术指导规则
├── 43-module-load.rules  ← 内核模块加载规则
├── 50-access.rules       ← 文件访问规则
├── 50-identity.rules     ← 身份认证规则
├── 50-network.rules      ← 网络活动规则
└── 99-finalize.rules     ← 规则锁定文件
```

### 3.2 规则文件加载顺序


**加载顺序说明**：
```
文件名前缀数字 → 加载顺序
10-xxx.rules  → 最先加载（基础配置）
30-xxx.rules  → 其次加载（安全规则）
50-xxx.rules  → 中间加载（具体规则）
99-xxx.rules  → 最后加载（锁定规则）
```

**💡 为什么要有顺序**：
- **基础配置先行**：确保基本设置正确
- **具体规则跟进**：添加详细的监控规则
- **锁定规则最后**：防止规则被意外修改

### 3.3 规则语法基础


**基本规则格式**：
```bash
-w 监控路径 -p 权限 -k 关键字
-a always,exit -S 系统调用 -k 关键字
-a always,exit -F arch=b64 -S 系统调用 -k 关键字
```

**参数含义解释**：
- **`-w`**：watch，监控某个文件或目录
- **`-p`**：permission，监控的权限类型（r读/w写/x执行/a属性）
- **`-k`**：key，给规则起个名字，便于后续查找
- **`-S`**：syscall，监控特定的系统调用
- **`-F`**：field，添加过滤条件

---

## 4. 📁 文件访问审计配置


### 4.1 监控重要系统文件


文件访问审计就是监控谁在什么时候访问了哪些重要文件。

**重要文件监控规则**：
```bash
# 监控系统关键配置文件
-w /etc/passwd -p wa -k identity_changes
-w /etc/group -p wa -k identity_changes
-w /etc/shadow -p wa -k identity_changes
-w /etc/sudoers -p wa -k privilege_changes

# 监控系统启动文件
-w /etc/rc.d/ -p wa -k system_startup
-w /etc/systemd/ -p wa -k system_startup
```

**规则解读**：
- `/etc/passwd`：用户账户信息文件
- `p wa`：监控写入(w)和属性变更(a)
- `k identity_changes`：用"identity_changes"标记这类事件

### 4.2 监控敏感目录


**目录监控配置**：
```bash
# 监控系统管理员目录
-w /root/ -p wa -k admin_activity

# 监控临时目录（常被恶意软件利用）
-w /tmp/ -p wa -k temp_activity
-w /var/tmp/ -p wa -k temp_activity

# 监控日志目录
-w /var/log/ -p wa -k log_changes
```

### 4.3 文件权限变更监控


**权限变更审计**：
```bash
# 监控文件权限和所有权变更
-a always,exit -F arch=b64 -S chmod -k permission_changes
-a always,exit -F arch=b64 -S chown -k owner_changes
-a always,exit -F arch=b64 -S setxattr -k attribute_changes
```

**实际应用场景**：
- **🔐 权限提升攻击检测**：发现异常的权限修改
- **🏠 文件归属变更**：监控文件所有者改变
- **📋 属性修改跟踪**：记录文件属性的变化

---

## 5. 🔧 系统调用审计配置


### 5.1 什么是系统调用审计


**通俗理解**：系统调用就像程序向操作系统"请求服务"的过程。

```
程序运行过程：
应用程序 → 系统调用 → 内核服务 → 硬件操作
    ↓         ↓         ↓         ↓
  打开文件   open()    文件系统   磁盘读写
  网络通信   socket()  网络栈    网卡收发
  进程管理   fork()    进程调度   CPU调度
```

### 5.2 网络相关系统调用


**网络监控规则**：
```bash
# 监控网络连接建立
-a always,exit -F arch=b64 -S socket -k network_connections
-a always,exit -F arch=b64 -S connect -k network_connections
-a always,exit -F arch=b64 -S accept -k network_connections

# 监控网络配置变更
-w /etc/hosts -p wa -k network_config
-w /etc/resolv.conf -p wa -k network_config
```

### 5.3 进程管理系统调用


**进程监控规则**：
```bash
# 监控进程创建和终止
-a always,exit -F arch=b64 -S execve -k process_execution
-a always,exit -F arch=b64 -S fork -k process_creation
-a always,exit -F arch=b64 -S clone -k process_creation

# 监控程序执行
-a always,exit -F arch=b64 -S execve -F euid=0 -k root_commands
```

**规则含义**：
- `execve`：程序执行系统调用
- `F euid=0`：只监控root用户（用户ID为0）执行的命令
- `k root_commands`：用这个关键字标记root用户的操作

---

## 6. 👤 用户操作审计配置


### 6.1 用户登录审计


用户操作审计主要记录用户的登录、注销和权限使用情况。

**登录监控配置**：
```bash
# 监控登录相关文件
-w /var/log/lastlog -p wa -k user_login
-w /var/log/wtmp -p wa -k user_login
-w /var/log/btmp -p wa -k failed_login

# 监控用户会话管理
-w /var/run/utmp -p wa -k session_management
```

### 6.2 权限提升监控


**sudo操作审计**：
```bash
# 监控sudo配置文件
-w /etc/sudoers -p wa -k privilege_escalation
-w /etc/sudoers.d/ -p wa -k privilege_escalation

# 监控特权命令执行
-a always,exit -F arch=b64 -S execve -F euid=0 -F auid>=1000 -k privilege_commands
```

**规则解释**：
- `euid=0`：有效用户ID为0（root权限）
- `auid>=1000`：审计用户ID大于等于1000（普通用户）
- 含义：监控普通用户获得root权限后执行的命令

### 6.3 用户管理操作审计


**用户账户管理**：
```bash
# 监控用户账户变更工具
-w /usr/sbin/useradd -p x -k user_management
-w /usr/sbin/userdel -p x -k user_management
-w /usr/sbin/usermod -p x -k user_management
-w /usr/sbin/groupadd -p x -k group_management
```

---

## 7. 🔄 审计日志轮转配置


### 7.1 为什么需要日志轮转


**问题场景**：
```
审计日志增长情况：
第1天：10MB
第7天：70MB
第30天：300MB
第365天：3.6GB+

不轮转的后果：
💾 磁盘空间耗尽
🐌 系统性能下降  
🔍 查找困难
```

### 7.2 日志轮转配置方式


**方式一：auditd内置轮转**
```bash
# 在auditd.conf中配置
max_log_file = 50                    # 日志文件最大50MB
num_logs = 10                        # 保留10个轮转文件
max_log_file_action = rotate         # 达到上限时轮转
```

**方式二：logrotate系统轮转**
```bash
# /etc/logrotate.d/audit文件配置
/var/log/audit/audit.log {
    weekly          # 每周轮转
    rotate 12       # 保留12个备份
    compress        # 压缩旧日志
    delaycompress   # 延迟压缩
    missingok       # 文件不存在不报错
    postrotate      # 轮转后执行
        /bin/kill -HUP `cat /var/run/auditd.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
```

### 7.3 日志文件命名规律


**轮转后的文件名**：
```
当前日志：audit.log
第1次轮转：audit.log.1
第2次轮转：audit.log.2
...
压缩后：audit.log.1.gz
```

---

## 8. 📊 审计数据分析与查询


### 8.1 基础查询命令


审计数据分析就是从大量的日志中找出有用的信息。

**主要查询工具**：

| 工具命令 | **主要用途** | **通俗理解** |
|---------|-------------|------------|
| `ausearch` | 搜索审计日志 | 在日志中找特定记录 |
| `aureport` | 生成统计报告 | 制作各种统计图表 |
| `auditctl` | 管理审计规则 | 添加删除监控规则 |
| `aulast` | 查看登录记录 | 看谁什么时候登录过 |

### 8.2 常用查询实例


**🔍 按关键字搜索**：
```bash
# 搜索身份认证相关事件
ausearch -k identity_changes

# 搜索权限变更事件  
ausearch -k privilege_changes

# 搜索文件访问事件
ausearch -k file_access -ts recent
```

**📅 按时间范围搜索**：
```bash
# 搜索今天的审计记录
ausearch -ts today

# 搜索最近1小时的记录
ausearch -ts recent

# 搜索指定时间段
ausearch -ts 10:30 -te 12:00
```

### 8.3 生成审计报告


**📈 用户活动报告**：
```bash
# 生成登录统计报告
aureport -l

# 生成用户命令执行报告
aureport -x --summary

# 生成文件访问报告
aureport -f
```

**报告输出示例**：
```
Login Report
============================================
# 日期     时间   用户    终端    主机       执行状态
1. 01/19 09:30  admin   pts/0   192.168.1.100  成功
2. 01/19 10:15  user1   ssh     192.168.1.50   失败  
3. 01/19 11:20  root    console localhost      成功
```

### 8.4 实时监控


**🔴 实时查看审计事件**：
```bash
# 实时显示新的审计记录
tail -f /var/log/audit/audit.log | grep -E "USER_LOGIN|USER_LOGOUT"

# 监控特定类型的事件
ausearch -m USER_LOGIN --input-logs -i | tail -f
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 auditd系统：Linux的"监控摄像头"，记录系统中的各种操作
🔸 主配置文件：/etc/audit/auditd.conf控制审计系统如何工作
🔸 规则目录：/etc/audit/rules.d/存放各种监控规则文件
🔸 审计规则：定义要监控哪些文件、系统调用和用户操作
🔸 日志管理：通过轮转机制控制日志文件的大小和数量
🔸 数据分析：使用ausearch、aureport等工具查询和分析审计数据
```

### 9.2 关键配置理解要点


**🔹 配置文件的作用分工**：
```
auditd.conf：控制审计系统的整体行为
rules.d目录：存放具体的监控规则
每个.rules文件：负责监控特定类型的操作
```

**🔹 规则配置的逻辑**：
```
-w 参数：监控文件和目录的访问
-a 参数：监控系统调用和进程操作  
-k 参数：给规则起名字，便于后续查找和分析
```

**🔹 日志管理的重要性**：
```
不管理：日志无限增长，最终耗尽磁盘空间
合理轮转：控制日志大小，保留足够的历史记录
定期清理：删除过老的日志，释放存储空间
```

### 9.3 实际应用价值


**🛡️ 安全防护应用**：
- **入侵检测**：发现异常的文件访问和权限变更
- **合规审计**：满足安全法规对操作记录的要求
- **事件追踪**：出现安全问题时追踪攻击路径

**🔧 运维管理应用**：
- **问题排查**：通过日志定位系统故障原因
- **性能分析**：了解系统的使用模式和瓶颈
- **用户管理**：监控用户的操作行为和权限使用

**💡 配置建议**：
- **分阶段部署**：先监控关键文件，再扩展到详细操作
- **性能平衡**：避免过度监控影响系统性能
- **定期维护**：检查日志轮转和存储空间使用情况
- **安全存储**：确保审计日志本身的安全性

**核心记忆口诀**：
- 审计系统像摄像，记录操作防篡改
- 配置规则要精准，关键文件必须看
- 日志轮转很重要，空间管理不能忘
- 查询分析找问题，安全运维都靠它