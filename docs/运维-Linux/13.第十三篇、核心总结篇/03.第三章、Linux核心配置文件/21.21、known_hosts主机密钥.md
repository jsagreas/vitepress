---
title: 21、known_hosts主机密钥
---
## 📚 目录

1. [known_hosts文件概述](#1-known_hosts文件概述)
2. [主机密钥验证机制](#2-主机密钥验证机制)
3. [文件位置与作用域](#3-文件位置与作用域)
4. [密钥格式与结构](#4-密钥格式与结构)
5. [严格主机密钥检查配置](#5-严格主机密钥检查配置)
6. [主机密钥变更处理](#6-主机密钥变更处理)
7. [安全防护机制](#7-安全防护机制)
8. [批量管理策略](#8-批量管理策略)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔐 known_hosts文件概述


### 1.1 什么是known_hosts文件


**🔸 核心定义**
```
known_hosts：SSH客户端存储已知主机公钥的文件
作用：防止中间人攻击，确保连接到正确的服务器
机制：首次连接时记录服务器公钥，后续连接时对比验证
```

**💡 工作原理类比**
```
就像你的手机通讯录：
📱 第一次和朋友通话 → 记录朋友的手机号码
📞 以后再通话时 → 对比号码是否匹配
🚨 如果号码变了 → 提醒可能有问题

SSH known_hosts也是这样：
🔑 第一次连接服务器 → 记录服务器的"数字指纹"
🌐 以后连接时 → 检查指纹是否一致
⚠️ 指纹不匹配 → 警告可能遭受攻击
```

### 1.2 为什么需要known_hosts


**🎯 核心问题**
```
网络环境不可信：
• 公共WiFi可能被监听
• DNS可能被劫持指向恶意服务器
• 中间人可能伪装成目标服务器

known_hosts解决方案：
• 建立服务器身份的"信任锚点"
• 检测服务器身份是否发生变化
• 在不安全网络中提供安全保障
```

---

## 2. 🔍 主机密钥验证机制


### 2.1 首次连接流程


**🔄 完整验证过程**
```
客户端                                服务器
   |                                    |
   |--[1] SSH连接请求----------------->|
   |                                    |
   |<--[2] 发送服务器公钥---------------|
   |                                    |
   |--[3] 检查known_hosts文件--------->|本地操作
   |                                    |
   |--[4] 询问用户是否信任------------>|用户决策
   |                                    |
   |--[5] 保存到known_hosts----------->|记录密钥
   |                                    |
   |<--[6] 建立加密通道----------------|继续连接
```

**📋 用户交互示例**
```
首次连接时的提示：
The authenticity of host '192.168.1.100 (192.168.1.100)' can't be established.
ED25519 key fingerprint is SHA256:abc123def456ghi789...
Are you sure you want to continue connecting (yes/no/[fingerprint])?

用户选择：
✅ yes → 信任并保存密钥
❌ no  → 拒绝连接
🔍 fingerprint → 输入指纹确认
```

### 2.2 后续连接验证


**⚡ 自动验证流程**
```
连接建立时：
1. 服务器发送公钥
2. 客户端查找known_hosts中的记录
3. 对比密钥是否匹配
4. 匹配 → 继续连接
   不匹配 → 发出警告并中断
```

---

## 3. 📁 文件位置与作用域


### 3.1 用户级配置文件


**🏠 ~/.ssh/known_hosts**
```
文件路径：/home/username/.ssh/known_hosts
作用范围：仅对当前用户生效
权限设置：600 (rw-------)
管理方式：用户自行维护
```

**💻 实际使用场景**
```
适用情况：
• 个人开发环境
• 用户专属的服务器连接
• 测试环境的临时连接

管理特点：
• 用户完全控制
• 不影响其他用户
• 灵活性高
```

### 3.2 系统级配置文件


**🏢 /etc/ssh/ssh_known_hosts**
```
文件路径：/etc/ssh/ssh_known_hosts
作用范围：系统内所有用户共享
权限设置：644 (rw-r--r--)
管理方式：系统管理员维护
```

**🔧 企业环境应用**
```
适用场景：
• 企业内部服务器
• 批量用户管理
• 标准化配置

优势：
• 统一管理
• 减少用户操作
• 提高安全性
```

### 3.3 优先级与查找顺序


**📊 查找优先级**
| **顺序** | **文件位置** | **作用域** | **优先级** |
|---------|------------|----------|----------|
| 1️⃣ | `~/.ssh/known_hosts` | 用户级 | **最高** |
| 2️⃣ | `/etc/ssh/ssh_known_hosts` | 系统级 | 次级 |

**🔄 查找逻辑**
```
SSH客户端查找流程：
Step 1 → 检查用户级文件
   ↓
找到匹配 → 使用该密钥验证
   ↓
未找到 → 继续检查系统级文件
   ↓
找到匹配 → 使用系统级密钥
   ↓
都未找到 → 触发首次连接流程
```

---

## 4. 📄 密钥格式与结构


### 4.1 标准格式解析


**🔸 基本格式结构**
```
hostname[,hostname2] keytype base64-key [comment]

实际示例：
192.168.1.100 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... server-01
```

**📋 字段详细说明**
```
🔹 hostname：主机标识
• IP地址：192.168.1.100
• 域名：example.com
• 别名组合：server.com,192.168.1.50

🔹 keytype：密钥类型
• ssh-ed25519：现代推荐
• ssh-rsa：传统RSA密钥
• ecdsa-sha2-nistp256：椭圆曲线

🔹 base64-key：公钥数据
• 经过base64编码的二进制密钥
• 每种密钥类型格式不同

🔹 comment：可选注释
• 服务器描述信息
• 便于管理识别
```

### 4.2 哈希格式 (推荐)


**🛡️ 安全哈希格式**
```
标准格式（明文）：
192.168.1.100 ssh-ed25519 AAAAC3NzaC1...

哈希格式（推荐）：
|1|base64hash1|base64hash2 ssh-ed25519 AAAAC3NzaC1...
```

**💡 哈希格式优势**
```
安全性提升：
• 隐藏主机名信息
• 防止信息泄露
• 保护网络拓扑

生成方法：
ssh-keyscan -H hostname >> ~/.ssh/known_hosts
```

### 4.3 多主机名记录


**🔗 同一服务器多标识**
```
同时支持IP和域名：
example.com,192.168.1.100,server01 ssh-ed25519 AAAAC3...

应用场景：
• 服务器有多个网络接口
• DNS和IP同时访问
• 内外网地址不同
```

---

## 5. ⚙️ 严格主机密钥检查配置


### 5.1 StrictHostKeyChecking参数


**📋 配置选项详解**

| **选项值** | **行为描述** | **适用场景** | **安全级别** |
|-----------|------------|------------|------------|
| `yes` | **严格检查，必须匹配** | 生产环境 | 🔴 **最高** |
| `no` | **不检查，自动接受** | 自动化脚本 | 🟡 **最低** |
| `ask` | **询问用户决定（默认）** | 交互环境 | 🟢 **中等** |
| `accept-new` | **接受新主机，检查已知** | 动态环境 | 🟠 **中高** |

### 5.2 配置方法


**🔧 全局配置 (/etc/ssh/ssh_config)**
```bash
# 严格模式 - 生产环境推荐
Host *
    StrictHostKeyChecking yes

# 灵活模式 - 开发环境
Host 192.168.*
    StrictHostKeyChecking accept-new
```

**👤 用户配置 (~/.ssh/config)**
```bash
# 特定主机配置
Host production-server
    HostName prod.example.com
    StrictHostKeyChecking yes

Host test-*
    StrictHostKeyChecking no
    UserKnownHostsFile /dev/null
```

**⚡ 命令行指定**
```bash
# 临时使用严格检查
ssh -o StrictHostKeyChecking=yes user@hostname

# 跳过检查（谨慎使用）
ssh -o StrictHostKeyChecking=no user@hostname
```

### 5.3 安全策略建议


**🎯 环境分级策略**
```
🔴 生产环境：
StrictHostKeyChecking yes
• 零容忍策略
• 所有连接必须验证
• 手动处理密钥变更

🟡 测试环境：
StrictHostKeyChecking accept-new  
• 接受新主机
• 检查已知主机
• 平衡安全与便利

🟢 开发环境：
StrictHostKeyChecking no
• 快速迭代需求
• 频繁重建服务器
• 注意安全风险
```

---

## 6. 🔄 主机密钥变更处理


### 6.1 密钥变更的常见原因


**🔸 正常变更情况**
```
合理的密钥变更：
✅ 服务器重新安装系统
✅ SSH服务配置更新
✅ 安全策略要求定期更换
✅ 服务器硬件更换
```

**⚠️ 可疑变更情况**
```
需要警惕的情况：
🚨 DNS劫持攻击
🚨 中间人攻击
🚨 服务器被入侵
🚨 网络设备被替换
```

### 6.2 密钥冲突警告示例


**🚨 系统警告信息**
```
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!

Host key verification failed.
```

### 6.3 处理步骤与方法


**🔍 Step 1: 验证变更合理性**
```
确认检查清单：
□ 联系服务器管理员确认
□ 检查服务器是否重装过
□ 确认网络环境安全性
□ 验证服务器指纹信息
```

**🛠️ Step 2: 清除旧密钥**
```bash
# 方法1：使用ssh-keygen删除特定主机
ssh-keygen -R hostname
ssh-keygen -R 192.168.1.100

# 方法2：手动编辑known_hosts文件
vim ~/.ssh/known_hosts
# 删除对应行

# 方法3：删除指定行号
sed -i '行号d' ~/.ssh/known_hosts
```

**✅ Step 3: 重新建立信任**
```bash
# 重新连接，建立新的密钥记录
ssh user@hostname

# 或预先获取新密钥
ssh-keyscan hostname >> ~/.ssh/known_hosts
```

### 6.4 批量密钥更新


**🔧 自动化处理脚本**
```bash
#!/bin/bash
# 批量更新known_hosts脚本

HOSTS_FILE="hostlist.txt"
KNOWN_HOSTS="$HOME/.ssh/known_hosts"

while read -r host; do
    echo "更新主机: $host"
    # 删除旧记录
    ssh-keygen -R "$host"
    # 添加新记录
    ssh-keyscan -H "$host" >> "$KNOWN_HOSTS"
done < "$HOSTS_FILE"
```

---

## 7. 🛡️ 安全防护机制


### 7.1 中间人攻击防护原理


**🔒 防护机制解析**
```
攻击场景：
普通用户 → [恶意中间人] → 真实服务器
              ↑
         伪装成目标服务器

known_hosts防护：
1. 记录真实服务器的数字指纹
2. 每次连接时对比指纹
3. 指纹不匹配时阻止连接
4. 提醒用户潜在安全风险
```

**📊 安全效果评估**

| **攻击类型** | **防护效果** | **说明** |
|-------------|-------------|----------|
| 🎯 **中间人攻击** | ✅ **高效防护** | 检测到密钥变化立即警告 |
| 🌐 **DNS劫持** | ✅ **有效检测** | IP变化但密钥不匹配 |
| 🔄 **会话劫持** | ⚠️ **部分防护** | 建立连接后的攻击难防护 |
| 📡 **流量监听** | ❌ **无法防护** | 需要结合其他安全措施 |

### 7.2 指纹验证最佳实践


**🔐 安全验证流程**
```
🔹 首次连接安全确认：
Step 1 → 通过安全渠道获取服务器指纹
Step 2 → 对比SSH连接显示的指纹
Step 3 → 完全匹配后再接受连接
Step 4 → 保存至known_hosts文件

🔹 指纹获取渠道：
• 服务器控制台直接查看
• 管理员通过邮件提供
• 企业内部安全文档
• 带外验证（电话确认）
```

### 7.3 高级安全配置


**🎯 增强安全措施**
```bash
# SSH客户端安全配置
Host *
    # 严格密钥检查
    StrictHostKeyChecking yes
    # 检查IP地址
    CheckHostIP yes
    # 使用哈希格式存储主机名
    HashKnownHosts yes
    # 验证主机密钥DNS记录
    VerifyHostKeyDNS ask
```

---

## 8. 📊 批量管理策略


### 8.1 企业环境统一管理


**🏢 集中管理架构**
```
管理层次：
┌─────────────────────────┐
│   配置管理中心          │
├─────────────────────────┤
│   /etc/ssh/ssh_known_hosts │ ← 全局配置
├─────────────────────────┤
│   用户1  用户2  用户3   │ ← 继承全局
└─────────────────────────┘
```

**⚙️ 自动化部署策略**
```bash
# 使用配置管理工具
# Ansible示例
- name: 部署known_hosts文件
  copy:
    src: company_known_hosts
    dest: /etc/ssh/ssh_known_hosts
    mode: '0644'

# Puppet示例  
file { '/etc/ssh/ssh_known_hosts':
  source  => 'puppet:///modules/ssh/known_hosts',
  mode    => '0644',
}
```

### 8.2 动态主机密钥管理


**🔄 自动发现与更新**
```bash
#!/bin/bash
# 动态主机发现脚本
NETWORK="192.168.1"
OUTPUT_FILE="/tmp/discovered_hosts"

# 扫描网段
for i in {1..254}; do
    host="${NETWORK}.${i}"
    if ping -c1 -W1 "$host" >/dev/null 2>&1; then
        # 检查SSH服务
        if nc -z "$host" 22 2>/dev/null; then
            echo "发现SSH主机: $host"
            ssh-keyscan -H "$host" >> "$OUTPUT_FILE"
        fi
    fi
done
```

### 8.3 密钥轮换策略


**🔁 定期更新流程**
```
密钥轮换周期：
📅 季度更新：高安全环境
📅 半年更新：一般企业环境  
📅 年度更新：低风险环境

自动化轮换流程：
1. 生成新的服务器密钥
2. 更新服务器SSH配置
3. 通知所有用户更新known_hosts
4. 验证新密钥部署成功
5. 清理旧密钥记录
```

### 8.4 监控与审计


**📈 安全监控指标**
```
关键监控点：
• 密钥变更频率统计
• 连接失败原因分析  
• 新主机首次连接记录
• 用户密钥管理行为

审计日志示例：
2024-09-18 15:30:01 用户john 连接192.168.1.100 密钥验证成功
2024-09-18 15:31:15 用户mary 连接test.com 密钥不匹配 连接被拒绝
2024-09-18 15:32:30 用户bob 添加新主机密钥 server-new.com
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的基本概念


```
🔸 known_hosts作用：存储已知主机的公钥，防止中间人攻击
🔸 文件位置：用户级(~/.ssh/)和系统级(/etc/ssh/)
🔸 验证机制：首次记录，后续对比，不匹配则警告
🔸 配置选项：StrictHostKeyChecking控制检查严格程度
🔸 安全意义：SSH安全连接的重要防护措施
```

### 9.2 关键操作技能


**🔹 日常管理操作**
```bash
# 查看known_hosts内容
cat ~/.ssh/known_hosts

# 删除特定主机记录
ssh-keygen -R hostname

# 预先添加主机密钥
ssh-keyscan hostname >> ~/.ssh/known_hosts

# 使用哈希格式添加
ssh-keyscan -H hostname >> ~/.ssh/known_hosts
```

**🔹 故障处理步骤**
```
密钥冲突处理：
1. 确认服务器变更是否合理
2. 删除冲突的旧密钥记录
3. 重新建立信任关系
4. 验证新连接正常工作
```

### 9.3 安全最佳实践


**🛡️ 推荐配置策略**
```
生产环境：
• 使用StrictHostKeyChecking yes
• 启用CheckHostIP验证
• 使用HashKnownHosts隐藏主机信息
• 建立密钥变更审批流程

开发环境：
• 使用StrictHostKeyChecking accept-new
• 配置合理的超时设置
• 定期清理测试环境密钥
• 避免在生产中使用宽松配置
```

### 9.4 常见问题与解决


❓ **为什么要使用哈希格式存储主机名？**
💡 保护网络拓扑信息，防止known_hosts文件泄露时暴露内部服务器列表

❓ **如何在自动化脚本中安全使用SSH？**  
💡 使用accept-new选项或预先部署known_hosts文件，避免完全跳过检查

❓ **服务器重装后连接失败怎么办？**
💡 使用`ssh-keygen -R hostname`删除旧记录，然后重新连接建立信任

**🎯 核心记忆要点**：
- known_hosts是SSH安全的第一道防线
- 严格检查配置要根据环境选择合适级别  
- 密钥变更时要谨慎验证合理性
- 企业环境需要统一管理和自动化部署
- 安全与便利需要找到合适的平衡点