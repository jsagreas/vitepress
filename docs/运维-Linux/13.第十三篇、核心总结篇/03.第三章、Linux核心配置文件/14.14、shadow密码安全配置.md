---
title: 14、shadow密码安全配置
---
## 📚 目录

1. [Shadow文件基础概念](#1-shadow文件基础概念)
2. [密码加密与哈希机制](#2-密码加密与哈希机制)
3. [密码过期时间配置](#3-密码过期时间配置)
4. [账户锁定与解锁机制](#4-账户锁定与解锁机制)
5. [密码策略强度配置](#5-密码策略强度配置)
6. [密码历史记录管理](#6-密码历史记录管理)
7. [账户安全审计检查](#7-账户安全审计检查)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔐 Shadow文件基础概念


### 1.1 什么是/etc/shadow文件


💭 **思考一下**：为什么要把密码信息单独存放，而不是和用户信息放在一起？

🔍 **深入理解**：
`/etc/shadow`文件是Linux系统专门用来**安全存储用户密码信息**的配置文件。它的作用就是把敏感的密码数据从普通用户可读的`/etc/passwd`文件中分离出来。

🌰 **举个例子**：
```
想象一下银行的设计：
- 大厅展示牌（/etc/passwd）：显示客户姓名、账户号
- 保险库（/etc/shadow）：存放真正的资金和重要信息

两者分离，确保安全！
```

### 1.2 Shadow文件的权限设置


**🔒 文件权限特点**：
```
文件路径：/etc/shadow
权限设置：-rw-r----- (640)
所有者：root
所属组：shadow
```

💡 **为什么这样设置权限**：
- **只有root用户**可以读写密码信息
- **shadow组成员**可以读取（一些系统服务需要）
- **其他用户完全无权限**访问

### 1.3 Shadow文件格式解析


📋 **字段结构图示**：
```
用户名:加密密码:最后修改日期:最小间隔:最大间隔:警告期:非活跃期:过期日期:保留字段

示例：
john:$6$salt$hashedpassword:18900:0:99999:7:::
 ↓     ↓                    ↓    ↓   ↓   ↓
用户名  加密后的密码         日期信息...
```

🏷️ **字段含义详解**：

| 字段位置 | 名称 | 含义说明 |
|---------|------|----------|
| 1 | **用户名** | 对应/etc/passwd中的用户名 |
| 2 | **加密密码** | 经过哈希算法加密的密码串 |
| 3 | **最后修改日期** | 距离1970-1-1的天数 |
| 4 | **最小间隔** | 两次密码修改的最小间隔天数 |
| 5 | **最大间隔** | 密码有效期，超过需强制修改 |
| 6 | **警告期** | 密码过期前几天开始警告 |
| 7 | **非活跃期** | 密码过期后账户锁定前的宽限期 |
| 8 | **过期日期** | 账户绝对过期时间 |
| 9 | **保留字段** | 暂时未使用，为将来扩展保留 |

---

## 2. 🔐 密码加密与哈希机制


### 2.1 密码为什么要加密


🤔 **为什么这样**：
传统系统把密码直接存储是极其危险的，一旦文件泄露，所有用户密码都会暴露。Linux采用**单向哈希加密**，即使获得加密后的字符串，也无法反推出原始密码。

### 2.2 哈希算法类型识别


**📖 算法标识符**：
```
密码字段格式：$id$salt$hashed

算法类型识别：
$1$ → MD5算法（已不安全，不建议使用）
$5$ → SHA-256算法（较安全）
$6$ → SHA-512算法（推荐使用）
$y$ → yescrypt算法（最新，更安全）
```

🌰 **实际示例解析**：
```
$6$randomsalt$K8hjT4nR2z3...
 ↓      ↓         ↓
算法   盐值    哈希结果
```

### 2.3 盐值的作用机制


💭 **思考一下**：为什么需要加盐值？

🔍 **深入理解**：
**盐值（Salt）**是在密码哈希过程中添加的随机字符串，作用是防止**彩虹表攻击**和**相同密码产生相同哈希值**的问题。

```
无盐值加密：
密码"123456" → hash("123456") → 固定哈希值
攻击者可以预先计算常用密码的哈希值

加盐值加密：
密码"123456" + 盐值"abc123" → hash("123456abc123") → 随机哈希值
每个用户的盐值不同，相同密码也产生不同哈希值
```

### 2.4 检查当前系统加密算法


🛠️ **查看系统默认算法**：
```bash
# 查看系统加密配置
grep -E "ENCRYPT_METHOD|SHA_CRYPT" /etc/login.defs

# 查看PAM加密配置
grep pam_unix /etc/pam.d/passwd
```

---

## 3. ⏰ 密码过期时间配置


### 3.1 密码过期机制原理


🌰 **生活类比**：
```
密码过期就像身份证有效期：
- 设定有效期限制（最大间隔）
- 到期前提醒更换（警告期）
- 过期后给一定宽限时间（非活跃期）
- 超过宽限期就冻结账户
```

### 3.2 时间字段计算方法


📅 **时间计算规则**：
所有时间字段都以**距离1970年1月1日的天数**来计算。

```bash
# 将日期转换为天数
date -d "2024-01-01" +%s | awk '{print int($1/86400)}'

# 将天数转换为日期
date -d "1970-01-01 +18900 days"
```

### 3.3 密码策略配置实践


**🔧 修改用户密码策略**：

设置密码60天后过期：
```bash
chage -M 60 username
```

设置密码过期前7天警告：
```bash
chage -W 7 username
```

设置两次密码修改最小间隔2天：
```bash
chage -m 2 username
```

**📋 查看用户密码策略**：
```bash
# 详细查看用户密码信息
chage -l username

# 输出示例：
# 最近一次密码修改时间: 2024-01-15
# 密码过期时间: 2024-03-15
# 密码失效时间: 从不
# 账户过期时间: 从不
# 两次改变密码之间相距的最小天数: 2
# 两次改变密码之间相距的最大天数: 60
# 在密码过期之前警告的天数: 7
```

### 3.4 系统默认密码策略设置


**⚙️ 配置文件位置**：`/etc/login.defs`

```bash
# 密码相关默认配置
PASS_MAX_DAYS   90    # 密码最大有效期
PASS_MIN_DAYS   1     # 密码修改最小间隔
PASS_MIN_LEN    8     # 密码最小长度
PASS_WARN_AGE   7     # 密码过期警告天数
```

💡 **配置生效说明**：
- 这些设置只对**新创建用户**生效
- 已存在用户需要用`chage`命令单独设置

---

## 4. 🔒 账户锁定与解锁机制


### 4.1 账户锁定的几种情况


**📊 锁定状态识别**：

| 密码字段内容 | 状态说明 | 用户影响 |
|-------------|----------|----------|
| `!` | 账户被锁定 | 无法使用密码登录 |
| `*` | 账户禁用 | 完全无法登录 |
| `!!` | 密码过期锁定 | 需要修改密码后才能使用 |
| 正常哈希值 | 账户正常 | 可以正常登录 |

### 4.2 手动锁定和解锁账户


**🔐 锁定用户账户**：
```bash
# 方法1：使用passwd命令
passwd -l username

# 方法2：使用usermod命令
usermod -L username

# 验证锁定状态
grep "^username:" /etc/shadow
# 输出：username:!$6$salt$hash:...
```

**🔓 解锁用户账户**：
```bash
# 解锁方法1
passwd -u username

# 解锁方法2
usermod -U username
```

### 4.3 密码过期导致的自动锁定


🤔 **为什么会自动锁定**：
当密码超过最大有效期且超过非活跃期时，系统会自动锁定账户，防止过期密码被恶意使用。

**🔍 检查过期锁定状态**：
```bash
# 检查账户过期信息
chage -l username | grep -E "密码过期|账户过期"

# 强制用户下次登录修改密码
chage -d 0 username
```

### 4.4 登录失败锁定机制


💡 **PAM模块配置**：
通过`pam_tally2`或`pam_faillock`模块实现登录失败自动锁定。

配置示例（/etc/pam.d/login）：
```
auth required pam_tally2.so deny=3 unlock_time=300
```

解释：
- `deny=3`：3次登录失败后锁定
- `unlock_time=300`：300秒后自动解锁

---

## 5. 💪 密码策略强度配置


### 5.1 密码复杂度要求设置


**🏷️ PAM密码模块**：`pam_pwquality.so`

配置文件位置：`/etc/pam.d/passwd` 或 `/etc/security/pwquality.conf`

**📋 常用密码强度选项**：

| 选项 | 作用 | 示例配置 |
|------|------|----------|
| `minlen` | 最小长度 | `minlen=8` |
| `minclass` | 最少字符类别数 | `minclass=3` |
| `maxrepeat` | 最大重复字符数 | `maxrepeat=2` |
| `dcredit` | 数字字符要求 | `dcredit=-1` |
| `ucredit` | 大写字母要求 | `ucredit=-1` |
| `lcredit` | 小写字母要求 | `lcredit=-1` |
| `ocredit` | 特殊字符要求 | `ocredit=-1` |

### 5.2 实用密码策略配置


**⚙️ 推荐配置示例**：
```bash
# 编辑密码质量配置文件
vim /etc/security/pwquality.conf

# 推荐配置内容：
minlen = 8          # 最少8位
minclass = 3        # 至少包含3种字符类型
maxrepeat = 2       # 相同字符最多重复2次
dcredit = -1        # 至少包含1个数字
ucredit = -1        # 至少包含1个大写字母
lcredit = -1        # 至少包含1个小写字母
ocredit = -1        # 至少包含1个特殊字符
```

### 5.3 密码强度测试


🔍 **测试密码复杂度**：
```bash
# 使用pwscore命令测试密码强度
echo "MyPass123!" | pwscore
# 输出分数，100分为满分

# 手动测试新密码策略
passwd username
# 系统会根据配置的策略检查密码
```

---

## 6. 📚 密码历史记录管理


### 6.1 密码历史记录的作用


💭 **思考一下**：为什么要记录密码历史？

🔍 **深入理解**：
密码历史记录防止用户**反复使用相同的旧密码**，这是一个重要的安全措施。如果没有历史记录限制，用户可能在被要求修改密码时，立即改回原来的密码。

### 6.2 配置密码历史记录


**🔧 PAM配置方式**：
编辑`/etc/pam.d/passwd`文件：

```
password required pam_unix.so remember=5 md5
```

解释：
- `remember=5`：记住最近5个密码
- 用户不能使用最近5次使用过的密码

### 6.3 历史记录存储位置


**📁 存储文件**：
```
/etc/security/opasswd  # 存储用户历史密码哈希值
```

⚠️ **重要提醒**：
- 这个文件权限应该设置为600（只有root可读写）
- 文件内容也是加密存储的，不是明文

**🔍 检查历史记录设置**：
```bash
# 查看当前密码历史配置
grep remember /etc/pam.d/passwd

# 查看历史记录文件
ls -la /etc/security/opasswd
```

---

## 7. 🔍 账户安全审计检查


### 7.1 定期安全检查清单


**✅ 基础安全检查**：

🔸 **检查空密码账户**：
```bash
awk -F: '($2 == "") {print $1}' /etc/shadow
```

🔸 **检查相同UID的账户**：
```bash
awk -F: '{print $3}' /etc/passwd | sort | uniq -d
```

🔸 **检查密码过期账户**：
```bash
# 查看7天内过期的账户
for user in $(cut -d: -f1 /etc/passwd); do
    chage -l $user | grep "密码过期" | grep -v "从不"
done
```

### 7.2 账户异常状态检测


**🚨 检查异常登录尝试**：
```bash
# 查看登录失败记录
lastb | head -20

# 查看成功登录记录
last | head -20

# 检查当前登录用户
w
```

**🔍 检查sudo权限使用**：
```bash
# 查看sudo日志
grep sudo /var/log/auth.log | tail -20
```

### 7.3 密码策略合规性检查


**📊 系统密码策略审计**：

```bash
# 创建密码审计脚本
#!/bin/bash
echo "=== 密码策略审计报告 ==="
echo "1. 系统默认密码策略："
grep -E "PASS_MAX_DAYS|PASS_MIN_DAYS|PASS_WARN_AGE" /etc/login.defs

echo -e "\n2. 密码复杂度策略："
grep -v "^#" /etc/security/pwquality.conf | grep -v "^$"

echo -e "\n3. 用户密码状态统计："
echo "正常用户: $(awk -F: '($2 !~ /^[!*]/) {count++} END {print count+0}' /etc/shadow)"
echo "锁定用户: $(awk -F: '($2 ~ /^!/) {count++} END {print count+0}' /etc/shadow)"
echo "禁用用户: $(awk -F: '($2 ~ /^\*/) {count++} END {print count+0}' /etc/shadow)"
```

### 7.4 安全加固建议


**🎯 最佳实践清单**：

1. **密码策略强化**
   - 最小长度≥8位
   - 包含多种字符类型
   - 设置密码历史记录

2. **账户管理规范**
   - 定期审计无用账户
   - 及时锁定离职人员账户
   - 监控异常登录活动

3. **文件权限检查**
   - /etc/shadow权限640
   - /etc/passwd权限644
   - 关键配置文件权限正确

4. **日志监控机制**
   - 启用认证日志记录
   - 定期分析登录模式
   - 设置异常告警机制

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔐 Shadow文件作用：安全存储用户密码信息，与/etc/passwd分离
🔒 密码加密机制：使用SHA-512等哈希算法+盐值确保安全性
⏰ 过期管理策略：通过时间字段控制密码和账户生命周期
🛡️ 锁定解锁机制：多种锁定状态和对应的管理命令
💪 密码强度策略：通过PAM模块强制密码复杂度要求
📚 历史记录管理：防止用户重复使用旧密码
🔍 安全审计检查：定期检查账户状态和异常行为
```

### 8.2 实际操作要点


**🔹 日常管理命令**：
- `chage -l username` → 查看密码策略
- `passwd -l/-u username` → 锁定/解锁账户
- `chage -d 0 username` → 强制修改密码
- `pwscore` → 测试密码强度

**🔹 配置文件位置**：
- `/etc/shadow` → 密码存储文件
- `/etc/login.defs` → 默认密码策略
- `/etc/security/pwquality.conf` → 密码复杂度要求
- `/etc/pam.d/passwd` → PAM密码模块配置

**🔹 安全检查重点**：
- 文件权限正确性（shadow为640权限）
- 空密码账户检查
- 密码过期状态监控
- 异常登录行为分析

### 8.3 实际应用价值


**💼 系统管理场景**：
- **企业环境**：建立统一的密码策略和账户管理规范
- **安全加固**：通过合理配置提升系统安全防护能力
- **合规要求**：满足行业安全标准和审计要求
- **故障排查**：快速定位和解决账户认证问题

**🎓 学习建议**：
- 理解shadow文件每个字段的实际含义
- 掌握chage、passwd等核心管理命令
- 熟悉PAM模块的密码策略配置
- 建立定期安全检查的运维习惯

**🔑 核心记忆**：
- Shadow文件专门存密码，权限设置要严格
- 密码加密用哈希加盐值，安全性能有保证
- 过期锁定有策略，定期检查很重要
- 强度历史要配好，安全审计不能少