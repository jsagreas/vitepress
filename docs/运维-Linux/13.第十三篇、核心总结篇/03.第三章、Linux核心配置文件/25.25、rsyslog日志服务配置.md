---
title: 25、rsyslog日志服务配置
---
## 📚 目录

1. [rsyslog服务概述](#1-rsyslog服务概述)
2. [主配置文件详解](#2-主配置文件详解)
3. [模块化配置管理](#3-模块化配置管理)
4. [日志设施与级别](#4-日志设施与级别)
5. [日志输出目标配置](#5-日志输出目标配置)
6. [日志过滤规则配置](#6-日志过滤规则配置)
7. [日志格式模板配置](#7-日志格式模板配置)
8. [远程日志传输配置](#8-远程日志传输配置)
9. [实战配置案例](#9-实战配置案例)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔍 rsyslog服务概述


### 1.1 什么是rsyslog


**简单理解**：rsyslog就像系统的"记录员"，专门负责记录系统运行过程中发生的各种事情。

```
类比生活场景：
就像学校的值日生要记录今天班里发生的事情：
- 谁迟到了 → 系统错误日志
- 谁表现好 → 系统信息日志  
- 发生了什么重要事件 → 系统事件日志

rsyslog = 系统的"值日生记录本"
```

**核心作用** ⭐⭐⭐：
- **事件记录**：记录系统中发生的各种事件
- **问题诊断**：帮助管理员发现和解决问题
- **安全审计**：追踪系统的安全相关事件
- **性能分析**：了解系统运行状况

### 1.2 rsyslog的重要性


| 重要程度 | 应用场景 | 说明 |
|---------|---------|------|
| 🔥🔥🔥 | **故障排查** | 快速定位系统问题根源 |
| 🔥🔥🔥 | **安全监控** | 发现异常登录、攻击行为 |
| 🔥🔥 | **性能监控** | 分析系统负载和资源使用 |
| 🔥🔥 | **合规审计** | 满足安全合规要求 |

### 1.3 rsyslog工作原理


```
系统事件发生流程：

应用程序/系统服务
         ↓
    生成日志消息
         ↓
   rsyslog接收处理
         ↓
    按规则过滤分类
         ↓
  写入指定目标位置
(本地文件/远程服务器)
```

---

## 2. 📋 主配置文件详解


### 2.1 配置文件位置


**主配置文件**：`/etc/rsyslog.conf`

> **💡 理解要点**：这个文件就是rsyslog的"大脑"，所有的日志处理规则都在这里定义。

### 2.2 配置文件基本结构


```bash
# /etc/rsyslog.conf 文件结构示意

# 1. 全局配置段
$ModLoad imuxsock    # 加载模块
$WorkDirectory /tmp  # 工作目录

# 2. 规则配置段  
*.info;mail.none     /var/log/messages    # 日志规则
mail.*               /var/log/maillog     # 邮件日志

# 3. 包含其他配置文件
$IncludeConfig /etc/rsyslog.d/*.conf     # 包含模块化配置
```

### 2.3 配置文件语法规则


**基本语法格式**：
```
设施.级别    目标位置
```

**语法说明**：
- **设施(Facility)**：日志来源，比如邮件系统、内核等
- **级别(Priority)**：日志严重程度，从调试到紧急
- **目标位置**：日志存储位置，可以是文件、远程服务器等

### 2.4 常见全局配置选项


| 配置项 | 含义 | 示例值 |
|-------|------|--------|
| `$WorkDirectory` | **工作目录** | `/tmp` |
| `$ActionFileDefaultTemplate` | **默认日志格式** | `RSYSLOG_TraditionalFormat` |
| `$RepeatedMsgReduction` | **重复消息压缩** | `on` |
| `$FileOwner` | **日志文件所有者** | `root` |
| `$FileGroup` | **日志文件用户组** | `adm` |

---

## 3. 📁 模块化配置管理


### 3.1 模块化配置目录


**配置目录**：`/etc/rsyslog.d/`

**为什么要模块化** ❓：
```
传统方式问题：
- 所有配置都写在一个文件里 → 难以管理
- 不同服务的日志配置混在一起 → 容易出错  
- 修改配置风险大 → 可能影响其他服务

模块化优势：
- 每个服务单独配置文件 → 清晰明了
- 独立管理，互不影响 → 降低风险
- 便于维护和扩展 → 易于管理
```

### 3.2 模块化配置文件命名


**命名规范**：`数字-服务名.conf`

```bash
/etc/rsyslog.d/
├── 10-kernel.conf        # 内核日志配置
├── 20-ufw.conf          # 防火墙日志配置  
├── 30-apache.conf       # Apache日志配置
├── 40-mysql.conf        # MySQL日志配置
└── 50-custom.conf       # 自定义日志配置
```

**数字前缀作用** 📝：
- 控制加载顺序，数字越小越先加载
- 避免配置冲突，确保规则按预期执行

### 3.3 模块化配置示例


**Apache日志独立配置** `/etc/rsyslog.d/30-apache.conf`：
```bash
# Apache访问日志
if $programname == 'apache2' then /var/log/apache/access.log

# Apache错误日志
if $programname == 'apache2' and $msg contains 'error' then /var/log/apache/error.log

# 停止进一步处理Apache日志
if $programname == 'apache2' then stop
```

---

## 4. 📊 日志设施与级别


### 4.1 日志设施(Facility)详解


**设施含义**：标识日志消息的来源系统或应用。

**常用设施对照表**：

| 设施代码 | 设施名称 | **实际含义** | 典型用途 |
|---------|---------|-------------|---------|
| `kern` | **内核** | Linux内核产生的消息 | 硬件错误、驱动问题 |
| `mail` | **邮件系统** | 邮件服务相关消息 | 邮件发送失败、队列状态 |
| `daemon` | **系统守护进程** | 后台服务程序消息 | SSH、FTP等服务状态 |
| `auth` | **认证授权** | 用户登录认证消息 | 登录成功/失败记录 |
| `syslog` | **系统日志** | rsyslog自身消息 | 日志服务状态信息 |
| `user` | **用户程序** | 用户空间程序消息 | 用户自定义应用日志 |
| `local0-7` | **本地自定义** | 管理员自定义用途 | 自定义应用分类 |

### 4.2 日志级别(Priority)详解


**级别含义**：标识日志消息的严重程度和重要性。

**日志级别排序**（严重程度从高到低）：

```
严重程度等级图：

🚨 emerg(0)     紧急情况，系统无法使用
🔥 alert(1)     需要立即采取行动
💥 crit(2)      严重错误条件
❌ err(3)       一般错误条件  
⚠️  warning(4)   警告信息
📢 notice(5)    正常但重要的信息
📝 info(6)      一般信息消息
🔍 debug(7)     调试信息
```

**级别详细说明**：

| 级别 | 数字值 | **实际含义** | 使用场景举例 |
|-----|-------|-------------|-------------|
| `emerg` | 0 | **系统崩溃** | 内核panic、系统完全无法工作 |
| `alert` | 1 | **需要立即处理** | 数据库损坏、文件系统满了 |
| `crit` | 2 | **严重错误** | 硬件故障、网络中断 |
| `err` | 3 | **一般错误** | 程序异常退出、配置错误 |
| `warning` | 4 | **警告提醒** | 磁盘空间不足、内存使用率高 |
| `notice` | 5 | **重要通知** | 用户登录、服务启动 |
| `info` | 6 | **一般信息** | 程序正常运行状态 |
| `debug` | 7 | **调试信息** | 程序内部执行细节 |

### 4.3 设施级别组合使用


**组合语法规则**：

```bash
# 基本格式
设施.级别    目标

# 多个设施
设施1,设施2.级别    目标

# 级别范围  
设施.级别及以上    目标
设施.=指定级别     目标
设施.!级别        目标(排除指定级别)
```

**实际配置示例**：
```bash
# 记录内核的所有错误及以上级别
kern.err                    /var/log/kernel.log

# 记录邮件系统的所有级别日志
mail.*                      /var/log/mail.log

# 记录认证相关的信息，但排除调试信息
auth.info;auth.!debug       /var/log/auth.log

# 多个设施的警告级别日志
daemon,syslog.warning       /var/log/daemon.log
```

---

## 5. 📤 日志输出目标配置


### 5.1 输出目标类型


**rsyslog支持的输出目标**：

```
日志输出目标类型图：

rsyslog日志
    ↓
┌─────────────────┐
│   输出目标选择   │
└─────────────────┘
    ↓
┌────┬────┬────┬────┐
│文件│控制台│用户│远程│
└────┴────┴────┴────┘
```

### 5.2 文件输出配置


**文件输出语法**：`设施.级别    /path/to/logfile`

**常见文件输出示例**：
```bash
# 系统基本日志
*.info;mail.none;authpriv.none;cron.none    /var/log/messages

# 内核日志
kern.*                                       /var/log/kern.log

# 邮件日志  
mail.*                                       /var/log/maillog

# 认证日志
authpriv.*                                   /var/log/secure
```

**文件输出特殊选项** ⭐：

| 选项符号 | **含义** | 示例 |
|---------|---------|------|
| `-/path/file` | **异步写入** | `-/var/log/messages` |
| `/path/file;template` | **指定格式** | `/var/log/custom.log;MyTemplate` |

### 5.3 控制台输出配置


**控制台输出语法**：`设施.级别    /dev/console`

```bash
# 紧急消息显示到控制台
*.emerg                     /dev/console

# 内核严重错误显示到所有终端
kern.crit                   /dev/tty*
```

### 5.4 用户输出配置


**向特定用户发送消息**：
```bash
# 发送给root用户
*.alert                     root

# 发送给多个用户
*.crit                      root,admin,operator

# 发送给所有登录用户
*.emerg                     *
```

### 5.5 输出目标选择建议


| 日志类型 | 推荐输出目标 | 原因 |
|---------|-------------|------|
| **系统错误** | 文件 + 控制台 | 便于排查，及时发现 |
| **安全日志** | 独立文件 + 远程 | 防篡改，集中管理 |
| **应用日志** | 独立文件 | 便于应用排查 |
| **调试信息** | 文件或丢弃 | 避免占用过多空间 |

---

## 6. 🔍 日志过滤规则配置


### 6.1 过滤规则基本概念


**过滤规则作用**：就像邮件分类一样，把不同类型的日志消息分门别类地处理。

```
日志过滤处理流程：

接收到日志消息
     ↓
  应用过滤规则
     ↓
┌────────┬────────┬────────┐
│符合规则1│符合规则2│符合规则3│
└────────┴────────┴────────┘
     ↓        ↓        ↓
  目标1    目标2    目标3
```

### 6.2 基于设施级别的过滤


**基础过滤语法**：
```bash
# 精确匹配
mail.=info          /var/log/mail-info.log

# 级别及以上
mail.warning        /var/log/mail-warning.log

# 排除特定级别
mail.!debug         /var/log/mail-no-debug.log

# 级别范围
mail.info;mail.!err /var/log/mail-info-warn.log
```

### 6.3 基于程序名称的过滤


**程序名称过滤** `[核心技能]`：
```bash
# 基于程序名过滤
if $programname == 'sshd' then /var/log/ssh.log

# 多个程序名
if $programname == 'sshd' or $programname == 'sudo' then /var/log/security.log

# 程序名包含特定字符串
if $programname contains 'apache' then /var/log/web.log
```

### 6.4 基于消息内容的过滤


**内容过滤规则**：
```bash
# 消息包含特定内容
if $msg contains 'error' then /var/log/errors.log

# 消息开头匹配
if $msg startswith 'Failed login' then /var/log/failed-login.log

# 正则表达式匹配
if $msg regex '.*[Ff]ailed.*login.*' then /var/log/security.log
```

### 6.5 复合过滤规则


**多条件组合过滤**：
```bash
# AND条件
if $programname == 'sshd' and $msg contains 'Failed' then {
    /var/log/ssh-failed.log
    stop
}

# OR条件  
if $facility-text == 'mail' or $facility-text == 'news' then /var/log/mail-news.log

# 复杂条件组合
if ($programname == 'apache2' and $syslogseverity >= 4) or $msg contains 'critical' then /var/log/important.log
```

### 6.6 停止处理规则


**stop指令作用** `[重要概念]`：
```bash
# 处理完SSH日志后停止，避免重复记录
if $programname == 'sshd' then {
    /var/log/ssh.log
    stop
}

# 丢弃调试信息
if $syslogseverity == 7 then stop

# 条件性停止
if $programname == 'cron' and $msg contains 'run-parts' then stop
```

---

## 7. 🎨 日志格式模板配置


### 7.1 日志格式模板概念


**模板作用**：定义日志消息的显示格式，就像Word文档的格式模板一样。

**默认格式示例**：
```
Jan 20 14:30:15 server01 sshd[1234]: Failed password for user from 192.168.1.100
```

### 7.2 预定义模板


**rsyslog内置模板** `[必知模板]`：

| 模板名称 | **格式特点** | 适用场景 |
|---------|-------------|---------|
| `RSYSLOG_TraditionalFormat` | **传统syslog格式** | 兼容旧系统 |
| `RSYSLOG_SyslogProtocol23Format` | **RFC3164标准格式** | 标准化环境 |
| `RSYSLOG_FileFormat` | **文件存储优化格式** | 本地文件存储 |
| `RSYSLOG_ForwardFormat` | **网络传输格式** | 远程日志传输 |

### 7.3 自定义模板配置


**模板定义语法**：
```bash
# 定义模板
$template 模板名称,"格式字符串"

# 使用模板
设施.级别    /path/to/file;模板名称
```

**常用模板变量**：

| 变量 | **含义** | 示例值 |
|-----|---------|-------|
| `%timegenerated%` | **生成时间** | `Jan 20 14:30:15` |
| `%HOSTNAME%` | **主机名** | `server01` |
| `%programname%` | **程序名** | `sshd` |
| `%msg%` | **消息内容** | `Failed password for user` |
| `%syslogtag%` | **系统标签** | `sshd[1234]:` |

### 7.4 实用模板示例


**详细信息模板**：
```bash
$template DetailedFormat,"%timegenerated% [%HOSTNAME%] %syslogtag% %syslogfacility-text%.%syslogpriority-text%: %msg%\n"

# 使用详细格式记录SSH日志
if $programname == 'sshd' then /var/log/ssh-detailed.log;DetailedFormat
```

**JSON格式模板** `[现代化格式]`：
```bash
$template JSONFormat,"{ \"timestamp\":\"%timegenerated:::date-rfc3339%\", \"host\":\"%HOSTNAME%\", \"program\":\"%programname%\", \"message\":\"%msg:::json%\" }\n"

# 使用JSON格式便于日志分析工具处理
*.info    /var/log/json-format.log;JSONFormat
```

**简洁格式模板**：
```bash
$template SimpleFormat,"%timegenerated:1:15% %programname%: %msg%\n"

# 调试时使用简洁格式
*.debug   /var/log/debug-simple.log;SimpleFormat
```

---

## 8. 🌐 远程日志传输配置


### 8.1 远程日志传输概念


**为什么需要远程日志** ❓：
```
本地日志存储问题：
- 磁盘空间有限 → 日志可能丢失
- 系统被入侵 → 日志可能被篡改  
- 硬件故障 → 日志无法恢复

远程日志优势：
- 集中存储管理 → 统一查看分析
- 安全性提升 → 防止本地篡改
- 容量弹性 → 专用日志服务器
- 高可用性 → 避免单点故障
```

### 8.2 UDP远程传输配置


**发送端配置** `[客户端]`：
```bash
# 发送所有日志到远程服务器
*.*    @192.168.1.100:514

# 只发送重要级别日志
*.warning    @log-server.example.com:514

# 发送特定设施日志
mail.*       @mail-log.example.com:514
```

**接收端配置** `[服务器端]`：
```bash
# 启用UDP接收模块
$ModLoad imudp
$UDPServerRun 514
$UDPServerAddress 0.0.0.0

# 配置接收规则
$template RemoteFormat,"%timegenerated% [%fromhost-ip%] %syslogtag% %msg%\n"
*.* /var/log/remote/%fromhost%/%programname%.log;RemoteFormat
```

### 8.3 TCP远程传输配置


**TCP传输优势** ⭐：
- 可靠传输，保证日志不丢失
- 支持加密传输，提高安全性
- 适合重要日志的远程传输

**发送端TCP配置**：
```bash
# TCP传输(双@符号)
*.crit    $$192.168.1.100:514

# 指定TCP端口
*.error   $$log-server.example.com:1514
```

**接收端TCP配置**：
```bash
# 启用TCP接收模块
$ModLoad imtcp
$InputTCPServerRun 514

# TCP接收配置
$template TCPFormat,"%timegenerated% [%fromhost%] %syslogtag% %msg%\n"
*.* /var/log/remote-tcp/%fromhost%/%programname%.log;TCPFormat
```

### 8.4 安全传输配置


**TLS加密传输** `[高安全性]`：
```bash
# 加载TLS模块
$DefaultNetstreamDriver gtls
$DefaultNetstreamDriverCAFile /path/to/ca.pem
$DefaultNetstreamDriverCertFile /path/to/cert.pem
$DefaultNetstreamDriverKeyFile /path/to/key.pem

# 客户端TLS配置
$ActionSendStreamDriverAuthMode x509/name
$ActionSendStreamDriverPermittedPeer *.example.com
*.* $$(o)log-server.example.com:6514
```

### 8.5 远程日志最佳实践


**配置建议**：

| 日志类型 | 传输协议 | 加密需求 | 配置要点 |
|---------|---------|---------|---------|
| **系统错误** | TCP | 推荐TLS | 可靠传输，防丢失 |
| **安全日志** | TCP + TLS | 必须加密 | 防篡改，保密性 |
| **应用日志** | UDP/TCP | 看需求 | 平衡性能与可靠性 |
| **调试信息** | UDP | 不需要 | 性能优先 |

---

## 9. 🔧 实战配置案例


### 9.1 Web服务器日志配置


**场景描述**：配置Apache Web服务器的访问日志和错误日志分离。

**配置文件** `/etc/rsyslog.d/30-apache.conf`：
```bash
# Apache访问日志(信息级别)
if $programname == 'apache2' and $syslogfacility-text == 'local1' then {
    /var/log/apache/access.log
    stop
}

# Apache错误日志(警告及以上级别)
if $programname == 'apache2' and $syslogseverity <= 4 then {
    /var/log/apache/error.log
    stop  
}

# Apache调试信息丢弃
if $programname == 'apache2' and $syslogseverity == 7 then stop
```

### 9.2 安全日志集中管理


**场景描述**：将SSH登录、sudo操作、防火墙日志集中到安全日志文件。

**配置文件** `/etc/rsyslog.d/20-security.conf`：
```bash
# 定义安全日志模板
$template SecurityFormat,"%timegenerated% [%HOSTNAME%] %programname%: %msg%\n"

# SSH相关日志
if $programname == 'sshd' then {
    /var/log/security/ssh.log;SecurityFormat
    # 同时发送到远程安全服务器
    $$security-log.company.com:514
    stop
}

# sudo操作日志
if $programname == 'sudo' then {
    /var/log/security/sudo.log;SecurityFormat
    $$security-log.company.com:514
    stop
}

# 防火墙日志
if $programname == 'kernel' and $msg contains 'UFW' then {
    /var/log/security/firewall.log;SecurityFormat
    stop
}
```

### 9.3 数据库服务器日志配置


**场景描述**：MySQL数据库日志的分类管理和远程备份。

**配置文件** `/etc/rsyslog.d/40-mysql.conf`：
```bash
# MySQL日志模板
$template MySQLFormat,"%timegenerated:::date-mysql% [%HOSTNAME%] MySQL: %msg%\n"

# MySQL一般信息日志
if $programname == 'mysqld' and $syslogseverity >= 6 then {
    /var/log/mysql/general.log;MySQLFormat
}

# MySQL警告和错误日志
if $programname == 'mysqld' and $syslogseverity <= 4 then {
    /var/log/mysql/error.log;MySQLFormat
    # 错误日志发送给DBA
    root,dba
    # 同时备份到远程
    $$db-log.company.com:514
}

# MySQL慢查询日志(如果通过syslog记录)
if $programname == 'mysqld' and $msg contains 'slow query' then {
    /var/log/mysql/slow.log;MySQLFormat
    stop
}
```

### 9.4 日志轮转配置


**配合logrotate的配置** `/etc/logrotate.d/rsyslog-custom`：
```bash
/var/log/apache/*.log
/var/log/security/*.log  
/var/log/mysql/*.log {
    daily                    # 每天轮转
    rotate 30               # 保留30天
    compress                # 压缩旧日志
    delaycompress           # 延迟压缩
    missingok               # 文件不存在不报错
    create 0644 root root   # 创建新文件权限
    postrotate
        /bin/kill -HUP `cat /var/run/rsyslogd.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 rsyslog作用：系统日志服务，负责收集、处理、存储系统日志
🔸 主配置文件：/etc/rsyslog.conf，控制全局日志处理规则
🔸 模块化配置：/etc/rsyslog.d/目录，分类管理不同服务的日志配置
🔸 设施级别：Facility.Priority格式，控制日志来源和严重程度
🔸 输出目标：文件、控制台、用户、远程服务器等多种输出方式
🔸 过滤规则：基于设施级别、程序名、消息内容的灵活过滤
🔸 格式模板：自定义日志显示格式，便于阅读和分析
🔸 远程传输：UDP/TCP协议，支持集中化日志管理
```

### 10.2 关键理解要点


**🔹 日志级别的重要性**：
```
理解要点：
- 级别决定了日志的重要程度
- 合理设置级别可以避免日志过多或遗漏重要信息
- 不同级别适用于不同的运维场景
```

**🔹 模块化配置的优势**：
```
实际意义：
- 便于管理维护，每个服务独立配置
- 降低配置错误风险，修改不会影响其他服务
- 便于团队协作，不同人员管理不同模块
```

**🔹 远程日志的必要性**：
```
现实需求：
- 集中管理，统一分析问题
- 安全考虑，防止日志被篡改
- 容量管理，专用存储服务器
- 高可用性，避免本地故障导致日志丢失
```

### 10.3 实际应用指导


**配置优先级** `[实战经验]`：

| 优先级 | 配置内容 | 配置原因 |
|-------|---------|---------|
| **最高** | 安全相关日志 | 涉及系统安全，必须完整记录 |
| **高** | 系统错误日志 | 故障排查的重要依据 |
| **中** | 应用服务日志 | 业务问题排查需要 |
| **低** | 调试信息日志 | 开发阶段需要，生产可关闭 |

**配置检查清单** ✅：
```
□ 主配置文件语法正确
□ 模块化配置文件权限正确(644)
□ 日志目录存在且有写权限
□ 重要日志配置了远程备份
□ 日志轮转配置已设置
□ 测试配置是否生效
□ 监控日志文件大小和磁盘空间
```

### 10.4 常见问题排查


**问题排查思路**：

```
日志问题诊断流程：

1. 检查rsyslog服务状态
   systemctl status rsyslog

2. 检查配置文件语法
   rsyslogd -N1 -f /etc/rsyslog.conf

3. 查看rsyslog自身日志
   tail -f /var/log/messages | grep rsyslog

4. 测试日志规则
   logger -p local0.info "测试消息"

5. 检查文件权限和磁盘空间
   ls -la /var/log/
   df -h /var/log
```

**记忆要点** 🧠：
- rsyslog = 系统日志管理员，负责收集和分发日志
- 设施.级别 = 来源.重要性，控制日志分类
- 模块化配置 = 分而治之，便于管理
- 远程传输 = 集中备份，提高安全性
- 过滤规则 = 精准分类，避免信息过载