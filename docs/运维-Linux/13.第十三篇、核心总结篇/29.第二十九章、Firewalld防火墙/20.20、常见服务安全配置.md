---
title: 20、常见服务安全配置
---
## 📚 目录

1. [Web服务器防火墙配置](#1-Web服务器防火墙配置)
2. [数据库服务安全配置](#2-数据库服务安全配置)
3. [SSH服务安全加固](#3-SSH服务安全加固)
4. [邮件服务配置](#4-邮件服务配置)
5. [DNS服务安全配置](#5-DNS服务安全配置)
6. [FTP服务配置](#6-FTP服务配置)
7. [远程桌面安全配置](#7-远程桌面安全配置)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🌐 Web服务器防火墙配置


### 1.1 Web服务基本概念


**🔸 什么是Web服务器**
```
Web服务器：运行网站的程序，负责处理用户的HTTP请求
常见Web服务器：Apache、Nginx、Tomcat
主要端口：HTTP(80)、HTTPS(443)
```

Web服务器就像一个餐厅的服务员，客户（浏览器）点菜（发送请求），服务员把菜（网页内容）送给客户。

### 1.2 Apache/Nginx基础防火墙配置


**🔧 开放基本Web端口**

最基本的Web服务需要开放`80`端口（HTTP）和`443`端口（HTTPS）：

```bash
# 开放HTTP服务（端口80）
firewall-cmd --zone=public --add-service=http --permanent

# 开放HTTPS服务（端口443）
firewall-cmd --zone=public --add-service=https --permanent

# 重新加载配置
firewall-cmd --reload
```

> 💡 **提示**：`--permanent`参数确保重启后配置依然生效，不加这个参数只是临时生效。

**🔒 高级Web服务配置**

如果你的网站使用特殊端口（比如8080、8443），需要单独配置：

```bash
# 开放自定义端口（如8080用于测试环境）
firewall-cmd --zone=public --add-port=8080/tcp --permanent

# 开放端口范围（如8000-8010用于多个测试站点）
firewall-cmd --zone=public --add-port=8000-8010/tcp --permanent
```

### 1.3 Web服务安全加固策略


**🛡️ 限制访问来源**

只允许特定IP访问管理端口：

```bash
# 创建专门的管理区域
firewall-cmd --new-zone=admin --permanent

# 只允许管理员IP访问
firewall-cmd --zone=admin --add-source=192.168.1.100 --permanent

# 在管理区域开放管理端口
firewall-cmd --zone=admin --add-port=8080/tcp --permanent
```

**⚠️ 防止DDoS攻击**

| 配置项 | **作用** | **命令示例** |
|--------|----------|-------------|
| **连接限制** | `限制单IP并发连接数` | `--limit-burst=10` |
| **频率限制** | `限制访问频率` | `--limit=5/min` |
| **黑名单** | `屏蔽恶意IP` | `--add-rich-rule="rule source address=恶意IP drop"` |

---

## 2. 🗄️ 数据库服务安全配置


### 2.1 数据库服务概念解析


**🔸 数据库服务是什么**
```
数据库：存储和管理数据的系统
常见数据库：MySQL(3306)、PostgreSQL(5432)、MongoDB(27017)
安全原则：最小权限、网络隔离、访问控制
```

数据库就像银行的保险柜，里面存着最重要的数据，必须严格控制谁能进入。

### 2.2 MySQL数据库防火墙配置


**🔒 基本安全配置**

MySQL默认监听`3306`端口，但**不应该**直接对外开放：

```bash
# 错误做法：直接开放MySQL端口（危险！）
# firewall-cmd --add-service=mysql --permanent  # 不要这样做

# 正确做法：创建数据库专用区域
firewall-cmd --new-zone=database --permanent
firewall-cmd --reload

# 只允许应用服务器访问数据库
firewall-cmd --zone=database --add-source=192.168.1.10 --permanent  # 应用服务器IP
firewall-cmd --zone=database --add-service=mysql --permanent
```

**🎯 多层安全策略**

```bash
# 1. 应用服务器可以访问数据库
firewall-cmd --zone=database --add-source=192.168.1.10/32 --permanent

# 2. 管理员可以从办公网访问
firewall-cmd --zone=database --add-source=192.168.100.0/24 --permanent

# 3. 禁止其他所有访问（默认行为）
```

### 2.3 其他数据库安全配置


**📊 常见数据库端口配置对比**

| 数据库类型 | **默认端口** | **服务名** | **安全建议** |
|-----------|------------|-----------|-------------|
| **MySQL** | `3306` | `mysql` | `内网访问，强密码` |
| **PostgreSQL** | `5432` | `postgresql` | `SSL连接，角色控制` |
| **MongoDB** | `27017` | `自定义` | `认证启用，网络绑定` |
| **Redis** | `6379` | `自定义` | `密码保护，内网限制` |

> ⚠️ **重要安全提醒**：数据库服务**绝不**应该直接暴露在公网上，必须通过应用服务器访问。

---

## 3. 🔐 SSH服务安全加固


### 3.1 SSH服务基础知识


**🔸 SSH是什么**
```
SSH：安全外壳协议，用于远程登录和管理服务器
默认端口：22
主要用途：远程命令执行、文件传输、端口转发
```

SSH就像你家的钥匙，让你能远程进入服务器，但如果不妥善保管，坏人也可能进入。

### 3.2 SSH基本防火墙配置


**🔧 标准SSH配置**

```bash
# 开放SSH服务（谨慎操作）
firewall-cmd --zone=public --add-service=ssh --permanent

# 查看SSH服务详情
firewall-cmd --info-service=ssh
```

**🛡️ SSH安全加固策略**

**第一步：更改默认端口**

修改SSH端口可以避免大量的自动扫描攻击：

```bash
# 1. 修改SSH配置文件
vim /etc/ssh/sshd_config
# 找到 #Port 22，改为 Port 2222

# 2. 在防火墙中开放新端口
firewall-cmd --zone=public --add-port=2222/tcp --permanent

# 3. 移除默认SSH服务（端口22）
firewall-cmd --zone=public --remove-service=ssh --permanent

# 4. 重启SSH服务
systemctl restart sshd

# 5. 重新加载防火墙
firewall-cmd --reload
```

### 3.3 SSH高级安全配置


**🎯 限制SSH访问来源**

只允许特定网络访问SSH：

```bash
# 创建管理区域
firewall-cmd --new-zone=ssh-admin --permanent
firewall-cmd --reload

# 只允许办公网络SSH访问
firewall-cmd --zone=ssh-admin --add-source=192.168.100.0/24 --permanent
firewall-cmd --zone=ssh-admin --add-port=2222/tcp --permanent

# 从公共区域移除SSH服务
firewall-cmd --zone=public --remove-service=ssh --permanent
```

**🔥 防暴力破解配置**

使用rich rule限制SSH连接频率：

```bash
# 限制单IP每分钟最多尝试3次SSH连接
firewall-cmd --add-rich-rule='rule service name=ssh limit value=3/m accept' --permanent

# 10分钟内失败5次则封IP 30分钟
firewall-cmd --add-rich-rule='rule service name=ssh log prefix="SSH-Attack: " level=warning limit value=5/10m reject' --permanent
```

**✅ SSH安全检查清单**

- [x] 更改默认端口22
- [x] 禁用root直接登录
- [x] 使用密钥认证
- [x] 限制访问来源IP
- [x] 配置连接频率限制
- [x] 启用日志监控

---

## 4. 📧 邮件服务配置


### 4.1 邮件服务基础概念


**🔸 邮件服务组件**
```
SMTP：发送邮件协议（端口25、587、465）
POP3：接收邮件协议（端口110、995）
IMAP：邮箱同步协议（端口143、993）
```

邮件服务就像邮局系统：SMTP负责寄信，POP3/IMAP负责收信。

### 4.2 邮件服务器防火墙配置


**📬 基本邮件端口配置**

```bash
# 开放标准邮件服务
firewall-cmd --zone=public --add-service=smtp --permanent        # 端口25
firewall-cmd --zone=public --add-service=pop3 --permanent        # 端口110  
firewall-cmd --zone=public --add-service=imap --permanent        # 端口143

# 开放安全邮件服务（SSL/TLS）
firewall-cmd --zone=public --add-service=smtps --permanent       # 端口465
firewall-cmd --zone=public --add-service=pop3s --permanent       # 端口995
firewall-cmd --zone=public --add-service=imaps --permanent       # 端口993
```

### 4.3 邮件服务安全策略


**🛡️ 邮件安全配置表**

| 服务类型 | **端口** | **加密** | **用途** | **安全建议** |
|---------|---------|----------|----------|-------------|
| **SMTP** | `25` | `无` | `服务器间通信` | `内网使用` |
| **SMTP** | `587` | `STARTTLS` | `客户端发送` | `推荐使用` |
| **SMTP** | `465` | `SSL/TLS` | `安全发送` | `企业首选` |
| **IMAP** | `143` | `无` | `邮件同步` | `仅内网` |
| **IMAP** | `993` | `SSL/TLS` | `安全同步` | `对外服务` |

**⚡ 反垃圾邮件配置**

```bash
# 限制SMTP连接频率，防止垃圾邮件发送
firewall-cmd --add-rich-rule='rule service name=smtp limit value=10/m accept' --permanent

# 只允许认证用户从587端口发送邮件
firewall-cmd --zone=public --remove-service=smtp --permanent
firewall-cmd --zone=public --add-port=587/tcp --permanent
```

---

## 5. 🌐 DNS服务安全配置


### 5.1 DNS服务基础知识


**🔸 DNS服务解析**
```
DNS：域名系统，将域名转换为IP地址
端口：53（TCP和UDP都需要）
类型：递归DNS、权威DNS、缓存DNS
```

DNS就像互联网的电话簿，帮你找到网站的真实地址。

### 5.2 DNS服务器防火墙配置


**🔧 基本DNS配置**

```bash
# 开放DNS服务（UDP 53用于查询，TCP 53用于区域传输）
firewall-cmd --zone=public --add-service=dns --permanent

# 手动指定端口（如果需要）
firewall-cmd --zone=public --add-port=53/tcp --permanent
firewall-cmd --zone=public --add-port=53/udp --permanent
```

### 5.3 DNS安全加固措施


**🛡️ DNS安全策略**

```bash
# 创建DNS服务专用区域
firewall-cmd --new-zone=dns-servers --permanent
firewall-cmd --reload

# 只允许内网进行DNS查询
firewall-cmd --zone=dns-servers --add-source=192.168.0.0/16 --permanent
firewall-cmd --zone=dns-servers --add-source=10.0.0.0/8 --permanent
firewall-cmd --zone=dns-servers --add-service=dns --permanent
```

**⚠️ 防DNS放大攻击**

DNS放大攻击利用DNS服务器进行流量放大，需要特别防范：

```bash
# 限制外网DNS查询频率
firewall-cmd --add-rich-rule='rule family=ipv4 source address=0.0.0.0/0 service name=dns limit value=5/s reject' --permanent

# 只允许内网无限制查询
firewall-cmd --add-rich-rule='rule family=ipv4 source address=192.168.0.0/16 service name=dns accept' --permanent
```

> 💡 **DNS安全提示**：如果你的DNS服务器只为内网提供服务，不要对外开放53端口。

---

## 6. 📁 FTP服务配置


### 6.1 FTP服务基础概念


**🔸 FTP服务原理**
```
FTP：文件传输协议，用于上传下载文件
控制端口：21（命令传输）
数据端口：20（主动模式）或随机端口（被动模式）
工作模式：主动FTP vs 被动FTP
```

FTP就像文件传输的卡车，需要两条路：一条用来发指令（控制），一条用来运货（数据传输）。

### 6.2 FTP基本防火墙配置


**📂 标准FTP配置**

```bash
# 开放FTP服务
firewall-cmd --zone=public --add-service=ftp --permanent

# 查看FTP服务包含的端口
firewall-cmd --info-service=ftp
```

### 6.3 FTP数据传输模式配置


**🔄 被动模式FTP配置**

被动模式FTP需要开放数据端口范围：

```bash
# 配置vsftpd被动模式端口范围（在/etc/vsftpd/vsftpd.conf中）
# pasv_min_port=20000
# pasv_max_port=20010

# 在防火墙中开放被动端口范围
firewall-cmd --zone=public --add-port=20000-20010/tcp --permanent

# 重启FTP服务
systemctl restart vsftpd
```

**🎯 FTP安全配置方案**

| 配置方案 | **适用场景** | **端口配置** | **安全级别** |
|----------|-------------|-------------|-------------|
| **匿名FTP** | `公共下载` | `21 + 被动端口` | `低` |
| **用户FTP** | `文件共享` | `21 + 认证` | `中` |
| **SFTP** | `安全传输` | `22（SSH）` | `高` |
| **FTPS** | `加密FTP` | `21 + SSL` | `高` |

**🔒 推荐使用SFTP替代FTP**

SFTP更安全，走SSH协议：

```bash
# 不需要额外配置，使用SSH端口
# 用户可以通过SFTP客户端连接：
# sftp username@server-ip
```

---

## 7. 🖥️ 远程桌面安全配置


### 7.1 远程桌面服务概念


**🔸 远程桌面协议类型**
```
RDP：Windows远程桌面（端口3389）
VNC：跨平台图形远程（端口5900系列）
XRDP：Linux上的RDP服务
SSH X11转发：通过SSH传输图形
```

远程桌面就像远程控制你的电脑，让你在家也能操作办公室的电脑。

### 7.2 VNC服务配置


**🖥️ VNC基本配置**

```bash
# 开放VNC服务（端口5901表示display :1）
firewall-cmd --zone=public --add-port=5901/tcp --permanent

# 如果有多个VNC会话
firewall-cmd --zone=public --add-port=5901-5910/tcp --permanent
```

### 7.3 远程桌面安全加固


**🔒 VNC安全配置策略**

```bash
# 创建远程桌面专用区域
firewall-cmd --new-zone=remote-desktop --permanent
firewall-cmd --reload

# 只允许管理网络访问
firewall-cmd --zone=remote-desktop --add-source=192.168.100.0/24 --permanent
firewall-cmd --zone=remote-desktop --add-port=5901/tcp --permanent

# 从公共区域移除（重要！）
firewall-cmd --zone=public --remove-port=5901/tcp --permanent
```

**🛡️ 远程桌面安全等级对比**

| 方案 | **协议** | **加密** | **认证** | **推荐度** |
|------|---------|----------|----------|-----------|
| **直接VNC** | `VNC` | `无` | `密码` | `❌ 不推荐` |
| **VNC+SSH隧道** | `VNC over SSH` | `SSH加密` | `SSH密钥` | `✅ 推荐` |
| **XRDP** | `RDP` | `RDP加密` | `系统用户` | `⭐ 较好` |
| **SSH X11** | `SSH` | `SSH加密` | `SSH密钥` | `⭐⭐ 最佳` |

**💡 最安全的方案：SSH隧道**

```bash
# 不直接开放VNC端口，通过SSH隧道访问
# 客户端命令：
# ssh -L 5901:localhost:5901 username@server
# 然后连接本地的 localhost:5901
```

> ⚠️ **安全警告**：远程桌面服务存在重大安全风险，务必不要直接暴露在公网上。

---

## 8. 📋 核心要点总结


### 8.1 各服务安全配置速查


**🔸 服务端口安全等级分类**

```
🟢 相对安全（可适当对外开放）：
• HTTP/HTTPS (80/443) - Web服务
• DNS (53) - 域名解析
• 邮件服务 (25/587/993等) - 使用加密

🟡 需要谨慎（建议限制来源）：
• SSH (22) - 远程管理
• FTP (21) - 文件传输

🔴 高度危险（严禁公网暴露）：
• 数据库 (3306/5432等) - 核心数据
• 远程桌面 (3389/5900等) - 系统控制
```

### 8.2 通用安全配置原则


**🛡️ 防火墙安全黄金法则**

1. **最小权限原则**：只开放必要的端口和服务
2. **来源限制**：根据业务需求限制访问来源IP
3. **端口变更**：更改默认端口，减少自动扫描
4. **加密优先**：优先使用加密版本的协议
5. **日志监控**：启用日志记录，监控异常访问
6. **定期审查**：定期检查和清理不必要的规则

### 8.3 常见配置命令速记


**⚡ 常用firewalld命令一览表**

| 操作类型 | **命令模板** | **说明** |
|---------|-------------|----------|
| **开放服务** | `firewall-cmd --add-service=服务名 --permanent` | `开放预定义服务` |
| **开放端口** | `firewall-cmd --add-port=端口/协议 --permanent` | `开放自定义端口` |
| **限制来源** | `firewall-cmd --zone=区域名 --add-source=IP段` | `创建访问控制` |
| **移除配置** | `firewall-cmd --remove-service=服务名 --permanent` | `关闭服务端口` |
| **查看配置** | `firewall-cmd --list-all` | `查看当前配置` |
| **重新加载** | `firewall-cmd --reload` | `应用配置更改` |

### 8.4 安全检查清单


**📝 日常安全维护任务**

- [x] **定期检查**：`firewall-cmd --list-all` 查看开放端口
- [x] **日志分析**：检查 `/var/log/firewalld` 异常记录  
- [x] **规则优化**：清理不再使用的端口和服务
- [x] **安全扫描**：定期进行端口扫描测试
- [x] **备份配置**：备份防火墙配置文件
- [x] **应急预案**：准备紧急封锁和恢复方案

### 8.5 故障排查要点


**🔧 常见问题解决**

```bash
# 1. 服务无法访问 - 检查端口是否开放
firewall-cmd --list-ports

# 2. 配置不生效 - 重新加载配置
firewall-cmd --reload

# 3. 误封锁自己 - 紧急恢复（谨慎使用）
firewall-cmd --panic-off

# 4. 查看详细日志
journalctl -u firewalld -f
```

**🧠 记忆口诀**

> **安全配置三要素**：权限最小化，来源要限制，加密是首选  
> **维护检查三步骤**：定期查规则，异常看日志，备份保平安  
> **故障排查三方向**：端口开没开，配置加载没，日志有线索

**核心理念**：防火墙配置既要保证业务正常运行，又要最大限度保护系统安全。宁可多一分谨慎，不可少一分防护。