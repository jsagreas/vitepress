---
title: 18ã€masqueradingåœ°å€ä¼ªè£…
---
## ğŸ“š ç›®å½•

1. [åœ°å€ä¼ªè£…åŸºæœ¬æ¦‚å¿µ](#1-åœ°å€ä¼ªè£…åŸºæœ¬æ¦‚å¿µ)
2. [NATåœ°å€è½¬æ¢åŸç†](#2-NATåœ°å€è½¬æ¢åŸç†)
3. [Masqueradingé…ç½®å®è·µ](#3-Masqueradingé…ç½®å®è·µ)
4. [è·¯ç”±å™¨åŠŸèƒ½å®ç°](#4-è·¯ç”±å™¨åŠŸèƒ½å®ç°)
5. [æ•…éšœæ’æŸ¥ä¸æ€§èƒ½ä¼˜åŒ–](#5-æ•…éšœæ’æŸ¥ä¸æ€§èƒ½ä¼˜åŒ–)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ­ åœ°å€ä¼ªè£…åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åœ°å€ä¼ªè£…


**ğŸ”¸ masqueradingå®šä¹‰**
```
åœ°å€ä¼ªè£…(masquerading)ï¼šä¸€ç§ç‰¹æ®Šçš„NATæŠ€æœ¯
ä½œç”¨ï¼šè®©å†…ç½‘è®¾å¤‡é€šè¿‡ä¸€å°Linuxä¸»æœºè®¿é—®å¤–ç½‘
æœ¬è´¨ï¼šå°†å†…ç½‘ç§æœ‰IPåœ°å€"ä¼ªè£…"æˆå…¬ç½‘IPåœ°å€
```

**ğŸ’¡ ç”Ÿæ´»åŒ–ç†è§£**
- å°±åƒ**ä»£è´­**ä¸€æ ·ï¼Œä½ (å†…ç½‘è®¾å¤‡)æƒ³ä¹°å›½å¤–å•†å“(è®¿é—®å¤–ç½‘)
- ä½†å•†å®¶ä¸è®¤è¯†ä½ çš„åœ°å€(ç§æœ‰IPæ— æ³•åœ¨å…¬ç½‘è·¯ç”±)
- éœ€è¦æ‰¾ä»£è´­(Linuxè·¯ç”±å™¨)ç”¨ä»–çš„åœ°å€(å…¬ç½‘IP)å¸®ä½ ä¸‹å•
- å•†å“åˆ°äº†ä»£è´­é‚£é‡Œï¼Œå†è½¬å‘ç»™ä½ 

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åœ°å€ä¼ªè£…


**ğŸ  å†…ç½‘è®¿é—®å¤–ç½‘çš„é—®é¢˜**
```
é—®é¢˜æ ¹æºï¼šIPv4åœ°å€ä¸å¤Ÿç”¨
è§£å†³æ–¹æ¡ˆï¼šç§æœ‰IP + NATæŠ€æœ¯

ç§æœ‰IPåœ°å€æ®µï¼š
â€¢ 10.0.0.0/8      (10.0.0.1 - 10.255.255.254)
â€¢ 172.16.0.0/12   (172.16.0.1 - 172.31.255.254)  
â€¢ 192.168.0.0/16  (192.168.0.1 - 192.168.255.254)

ç‰¹ç‚¹ï¼šåªèƒ½åœ¨å±€åŸŸç½‘å†…ä½¿ç”¨ï¼Œæ— æ³•ç›´æ¥è®¿é—®äº’è”ç½‘
```

**ğŸŒ ç½‘ç»œæ‹“æ‰‘ç¤ºä¾‹**
```
äº’è”ç½‘                  Linuxè·¯ç”±å™¨                å†…ç½‘è®¾å¤‡
     |                       |                        |
å…¬ç½‘IP: ä»»æ„          eth0: 203.0.113.1        192.168.1.10
                     eth1: 192.168.1.1        192.168.1.11
                                               192.168.1.12

æ²¡æœ‰masqueradingï¼š
å†…ç½‘è®¾å¤‡è®¿é—®ç™¾åº¦ â†’ è·¯ç”±å™¨è½¬å‘(æºIP:192.168.1.10) â†’ ç™¾åº¦æ”¶åˆ°
ç™¾åº¦å›å¤ â†’ ä¸çŸ¥é“192.168.1.10åœ¨å“ªé‡Œ â†’ æ•°æ®åŒ…ä¸¢å¤± âŒ

å¯ç”¨masqueradingï¼š
å†…ç½‘è®¾å¤‡è®¿é—®ç™¾åº¦ â†’ è·¯ç”±å™¨è½¬å‘(æºIPæ”¹ä¸º203.0.113.1) â†’ ç™¾åº¦æ”¶åˆ°
ç™¾åº¦å›å¤ â†’ å›å¤ç»™203.0.113.1 â†’ è·¯ç”±å™¨è½¬å‘ç»™192.168.1.10 âœ…
```

### 1.3 masqueradingä¸SNATçš„åŒºåˆ«


| **ç‰¹æ€§** | **Masquerading** | **SNAT** |
|---------|-----------------|----------|
| **é€‚ç”¨åœºæ™¯** | `åŠ¨æ€IPæˆ–æ‹¨å·ä¸Šç½‘` | `å›ºå®šå…¬ç½‘IP` |
| **é…ç½®å¤æ‚åº¦** | `ç®€å•ï¼Œè‡ªåŠ¨è·å–å¤–ç½‘IP` | `éœ€æ‰‹åŠ¨æŒ‡å®šç›®æ ‡IP` |
| **æ€§èƒ½å¼€é”€** | `ç¨é«˜ï¼Œéœ€åŠ¨æ€æŸ¥è¯¢IP` | `è¾ƒä½ï¼ŒIPå›ºå®š` |
| **çµæ´»æ€§** | `è‡ªåŠ¨é€‚åº”IPå˜åŒ–` | `IPå˜åŒ–éœ€é‡æ–°é…ç½®` |

---

## 2. ğŸ”„ NATåœ°å€è½¬æ¢åŸç†


### 2.1 NATå·¥ä½œæœºåˆ¶è¯¦è§£


**ğŸ”¸ åœ°å€è½¬æ¢è¿‡ç¨‹**
```
å†…ç½‘è®¿é—®å¤–ç½‘çš„å®Œæ•´æµç¨‹ï¼š

æ­¥éª¤1ï¼šå†…ç½‘è®¾å¤‡å‘èµ·è¿æ¥
æºIP: 192.168.1.10:5000 â†’ ç›®æ ‡IP: 8.8.8.8:53

æ­¥éª¤2ï¼šè·¯ç”±å™¨æ¥æ”¶å¹¶è®°å½•
è¿æ¥è¡¨æ·»åŠ ï¼š192.168.1.10:5000 â†” 203.0.113.1:30000 â†” 8.8.8.8:53

æ­¥éª¤3ï¼šä¿®æ”¹æ•°æ®åŒ…å‘é€
æºIP: 203.0.113.1:30000 â†’ ç›®æ ‡IP: 8.8.8.8:53

æ­¥éª¤4ï¼šå¤–ç½‘å›å¤
æºIP: 8.8.8.8:53 â†’ ç›®æ ‡IP: 203.0.113.1:30000

æ­¥éª¤5ï¼šè·¯ç”±å™¨è½¬å‘å›å†…ç½‘
æºIP: 8.8.8.8:53 â†’ ç›®æ ‡IP: 192.168.1.10:5000
```

**ğŸ“Š è¿æ¥çŠ¶æ€è¡¨**
```
å†…ç½‘åœ°å€:ç«¯å£     å…¬ç½‘åœ°å€:ç«¯å£     å¤–ç½‘åœ°å€:ç«¯å£     çŠ¶æ€
192.168.1.10:5000  203.0.113.1:30000  8.8.8.8:53     ESTABLISHED
192.168.1.11:6000  203.0.113.1:30001  1.1.1.1:53     ESTABLISHED  
192.168.1.12:7000  203.0.113.1:30002  ç™¾åº¦IP:80       TIME_WAIT
```

### 1.2 ç«¯å£æ˜ å°„æœºåˆ¶


**âš¡ ç«¯å£åˆ†é…ç­–ç•¥**
```
åŠ¨æ€ç«¯å£åˆ†é…ï¼š
â€¢ èŒƒå›´ï¼šé€šå¸¸ä½¿ç”¨ 32768-65535
â€¢ ç®—æ³•ï¼šå°½é‡ä¿æŒåŸç«¯å£ï¼Œå†²çªæ—¶é€’å¢æŸ¥æ‰¾
â€¢ ç®¡ç†ï¼šç³»ç»Ÿè‡ªåŠ¨åˆ†é…å’Œå›æ”¶

ç¤ºä¾‹ï¼š
å†…ç½‘è®¾å¤‡A(192.168.1.10:5000) â†’ æ˜ å°„åˆ° 203.0.113.1:5000
å†…ç½‘è®¾å¤‡B(192.168.1.11:5000) â†’ æ˜ å°„åˆ° 203.0.113.1:5001 (ç«¯å£å†²çª)
```

**ğŸ”„ è¿æ¥ç”Ÿå‘½å‘¨æœŸ**
```
å»ºç«‹é˜¶æ®µï¼š
å†…ç½‘ â†’ å¤–ç½‘ï¼šåˆ›å»ºæ˜ å°„è¡¨é¡¹
å¤–ç½‘ â†’ å†…ç½‘ï¼šæŸ¥è¡¨è½¬å‘

ç»´æŒé˜¶æ®µï¼š
å®šæœŸæ›´æ–°è¿æ¥çŠ¶æ€
TCP: æ ¹æ®è¿æ¥çŠ¶æ€ç»´æŠ¤
UDP: åŸºäºè¶…æ—¶æ—¶é—´ç»´æŠ¤

ç»“æŸé˜¶æ®µï¼š
TCP: FIN/RSTåæ¸…ç†è¡¨é¡¹
UDP: è¶…æ—¶åè‡ªåŠ¨æ¸…ç†
```

---

## 3. âš™ï¸ Masqueradingé…ç½®å®è·µ


### 3.1 åŸºæœ¬é…ç½®å‘½ä»¤


**ğŸ”§ å¯ç”¨åœ°å€ä¼ªè£…**
```bash
# ä¸´æ—¶å¯ç”¨(é‡å¯å¤±æ•ˆ)
firewall-cmd --add-masquerade

# æ°¸ä¹…å¯ç”¨
firewall-cmd --permanent --add-masquerade
firewall-cmd --reload

# æŒ‡å®šåŒºåŸŸå¯ç”¨
firewall-cmd --zone=public --add-masquerade --permanent
```

**ğŸ“‹ æŸ¥çœ‹é…ç½®çŠ¶æ€**
```bash
# æŸ¥çœ‹å½“å‰masqueradingçŠ¶æ€
firewall-cmd --query-masquerade

# æŸ¥çœ‹æŒ‡å®šåŒºåŸŸçŠ¶æ€  
firewall-cmd --zone=public --query-masquerade

# åˆ—å‡ºæ‰€æœ‰åŒºåŸŸçš„masqueradingçŠ¶æ€
firewall-cmd --list-all-zones | grep -A 10 -B 2 masquerade
```

**ğŸš« ç¦ç”¨åœ°å€ä¼ªè£…**
```bash
# ä¸´æ—¶ç¦ç”¨
firewall-cmd --remove-masquerade

# æ°¸ä¹…ç¦ç”¨
firewall-cmd --permanent --remove-masquerade
firewall-cmd --reload
```

### 3.2 å®Œæ•´é…ç½®ç¤ºä¾‹


**ğŸ—ï¸ è·¯ç”±å™¨é…ç½®æ­¥éª¤**

```bash
# æ­¥éª¤1ï¼šå¯ç”¨IPè½¬å‘
echo 'net.ipv4.ip_forward = 1' >> /etc/sysctl.conf
sysctl -p

# æ­¥éª¤2ï¼šé…ç½®ç½‘ç»œæ¥å£åŒºåŸŸ
# å¤–ç½‘æ¥å£é…ç½®ä¸ºpublicåŒºåŸŸ
firewall-cmd --zone=public --change-interface=eth0 --permanent

# å†…ç½‘æ¥å£é…ç½®ä¸ºinternalåŒºåŸŸ  
firewall-cmd --zone=internal --change-interface=eth1 --permanent

# æ­¥éª¤3ï¼šå¯ç”¨åœ°å€ä¼ªè£…
firewall-cmd --zone=public --add-masquerade --permanent

# æ­¥éª¤4ï¼šé‡è½½é…ç½®
firewall-cmd --reload
```

**ğŸ’» éªŒè¯é…ç½®**
```bash
# æ£€æŸ¥IPè½¬å‘
cat /proc/sys/net/ipv4/ip_forward
# è¾“å‡ºï¼š1 è¡¨ç¤ºå·²å¯ç”¨

# æ£€æŸ¥æ¥å£åŒºåŸŸåˆ†é…
firewall-cmd --get-active-zones
# è¾“å‡ºç¤ºä¾‹ï¼š
# internal
#   interfaces: eth1
# public  
#   interfaces: eth0

# æ£€æŸ¥masqueradingçŠ¶æ€
firewall-cmd --zone=public --query-masquerade
# è¾“å‡ºï¼šyes è¡¨ç¤ºå·²å¯ç”¨
```

### 3.3 é«˜çº§é…ç½®é€‰é¡¹


**ğŸ¯ å¯Œè§„åˆ™é…ç½®masquerading**
```bash
# åªå¯¹ç‰¹å®šæºåœ°å€å¯ç”¨masquerading
firewall-cmd --permanent --zone=public --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" masquerade'

# åªå¯¹ç‰¹å®šæœåŠ¡å¯ç”¨masquerading  
firewall-cmd --permanent --zone=public --add-rich-rule='rule family="ipv4" service name="http" masquerade'

# åŸºäºç›®æ ‡åœ°å€çš„masquerading
firewall-cmd --permanent --zone=public --add-rich-rule='rule family="ipv4" destination address="8.8.8.8/32" masquerade'
```

**âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®**
```bash
# è°ƒæ•´è¿æ¥è·Ÿè¸ªè¡¨å¤§å°
echo 'net.netfilter.nf_conntrack_max = 131072' >> /etc/sysctl.conf

# è°ƒæ•´è¿æ¥è¶…æ—¶æ—¶é—´
echo 'net.netfilter.nf_conntrack_tcp_timeout_established = 1200' >> /etc/sysctl.conf
echo 'net.netfilter.nf_conntrack_udp_timeout = 60' >> /etc/sysctl.conf

# åº”ç”¨é…ç½®
sysctl -p
```

---

## 4. ğŸŒ è·¯ç”±å™¨åŠŸèƒ½å®ç°


### 4.1 ä¼ä¸šçº§è·¯ç”±å™¨é…ç½®


**ğŸ¢ åœºæ™¯ï¼šå…¬å¸å†…ç½‘è®¿é—®äº’è”ç½‘**
```
ç½‘ç»œæ‹“æ‰‘ï¼š
                    äº’è”ç½‘
                       |
              [å…¬å¸è·¯ç”±å™¨-Linux]
              eth0: å…¬ç½‘IP (DHCP)
              eth1: 192.168.10.1/24
                       |
    +------------------+------------------+
    |                  |                  |
å‘˜å·¥PC1           å‘˜å·¥PC2            æœåŠ¡å™¨
192.168.10.10   192.168.10.11    192.168.10.100
```

**ğŸ“ é…ç½®è„šæœ¬**
```bash
#!/bin/bash
# ä¼ä¸šè·¯ç”±å™¨é…ç½®è„šæœ¬

# 1. åŸºç¡€ç½‘ç»œé…ç½®
# å¤–ç½‘æ¥å£(DHCPè·å–IP)
nmcli con mod "eth0" ipv4.method auto
nmcli con up "eth0"

# å†…ç½‘æ¥å£(é™æ€IP)  
nmcli con mod "eth1" ipv4.method manual ipv4.addresses "192.168.10.1/24"
nmcli con up "eth1"

# 2. å¯ç”¨IPè½¬å‘
echo 'net.ipv4.ip_forward = 1' >> /etc/sysctl.conf
sysctl -p

# 3. é˜²ç«å¢™é…ç½®
firewall-cmd --zone=external --change-interface=eth0 --permanent
firewall-cmd --zone=internal --change-interface=eth1 --permanent
firewall-cmd --zone=external --add-masquerade --permanent

# 4. å†…ç½‘æœåŠ¡é…ç½®
firewall-cmd --zone=internal --add-service=ssh --permanent
firewall-cmd --zone=internal --add-service=dhcp --permanent

# 5. é‡è½½ç”Ÿæ•ˆ
firewall-cmd --reload

echo "è·¯ç”±å™¨é…ç½®å®Œæˆï¼"
```

### 4.2 å®¶åº­ç½‘ç»œå…±äº«é…ç½®


**ğŸ  åœºæ™¯ï¼šå®¶åº­å¤šè®¾å¤‡ä¸Šç½‘**
```bash
# å®¶åº­è·¯ç”±å™¨ç®€åŒ–é…ç½®

# WiFiçƒ­ç‚¹æ¥å£é…ç½®
firewall-cmd --zone=internal --change-interface=wlan0 --permanent

# æœ‰çº¿ç½‘ç»œæ¥å£é…ç½®  
firewall-cmd --zone=external --change-interface=eth0 --permanent

# å¯ç”¨masquerading
firewall-cmd --zone=external --add-masquerade --permanent

# å…è®¸å†…ç½‘è®¾å¤‡äº’è®¿
firewall-cmd --zone=internal --add-service=ssh --permanent
firewall-cmd --zone=internal --add-service=samba --permanent

firewall-cmd --reload
```

### 4.3 å¤šå‡ºå£è·¯ç”±é…ç½®


**ğŸ”€ åŒçº¿è·¯è´Ÿè½½å‡è¡¡**
```bash
# åœºæ™¯ï¼šç”µä¿¡å’Œè”é€šåŒçº¿æ¥å…¥

# ç”µä¿¡çº¿è·¯
firewall-cmd --zone=public --change-interface=eth0 --permanent
firewall-cmd --zone=public --add-masquerade --permanent

# è”é€šçº¿è·¯
firewall-cmd --zone=external --change-interface=eth1 --permanent  
firewall-cmd --zone=external --add-masquerade --permanent

# å†…ç½‘æ¥å£
firewall-cmd --zone=internal --change-interface=eth2 --permanent

# åŸºäºæºIPçš„è·¯ç”±ç­–ç•¥
firewall-cmd --permanent --zone=public --add-rich-rule='rule family="ipv4" source address="192.168.1.0/25" masquerade'
firewall-cmd --permanent --zone=external --add-rich-rule='rule family="ipv4" source address="192.168.1.128/25" masquerade'
```

---

## 5. ğŸ” æ•…éšœæ’æŸ¥ä¸æ€§èƒ½ä¼˜åŒ–


### 5.1 å¸¸è§æ•…éšœè¯Šæ–­


**âŒ æ•…éšœç°è±¡ï¼šå†…ç½‘æ— æ³•è®¿é—®å¤–ç½‘**

**ğŸ”§ æ’æŸ¥æ­¥éª¤**
```bash
# 1. æ£€æŸ¥IPè½¬å‘æ˜¯å¦å¯ç”¨
cat /proc/sys/net/ipv4/ip_forward
# æœŸæœ›è¾“å‡ºï¼š1

# 2. æ£€æŸ¥masqueradingçŠ¶æ€
firewall-cmd --query-masquerade
# æœŸæœ›è¾“å‡ºï¼šyes

# 3. æ£€æŸ¥ç½‘ç»œæ¥å£åŒºåŸŸåˆ†é…
firewall-cmd --get-active-zones
# ç¡®è®¤æ¥å£åœ¨æ­£ç¡®åŒºåŸŸ

# 4. æ£€æŸ¥è·¯ç”±è¡¨
ip route show
# ç¡®è®¤é»˜è®¤è·¯ç”±æ­£ç¡®

# 5. æ£€æŸ¥è¿æ¥è·Ÿè¸ª
cat /proc/net/nf_conntrack | head -5
# æŸ¥çœ‹æ˜¯å¦æœ‰è¿æ¥è®°å½•
```

**ğŸ“Š è¿æ¥çŠ¶æ€åˆ†æ**
```bash
# æŸ¥çœ‹è¿æ¥è·Ÿè¸ªç»Ÿè®¡
cat /proc/sys/net/netfilter/nf_conntrack_count
cat /proc/sys/net/netfilter/nf_conntrack_max

# æŸ¥çœ‹å…·ä½“è¿æ¥ä¿¡æ¯
conntrack -L | grep -E "(192\.168\.|10\.)" | head -10

# ç›‘æ§å®æ—¶è¿æ¥å˜åŒ–
watch -n 1 'cat /proc/sys/net/netfilter/nf_conntrack_count'
```

### 5.2 æ€§èƒ½å½±å“è¯„ä¼°


**âš¡ æ€§èƒ½æŒ‡æ ‡ç›‘æ§**

| **æŒ‡æ ‡** | **å‘½ä»¤** | **æ­£å¸¸èŒƒå›´** | **é—®é¢˜æ’æŸ¥** |
|---------|---------|-------------|-------------|
| **è¿æ¥æ•°** | `cat /proc/sys/net/netfilter/nf_conntrack_count` | `< 80% max` | `å¢å¤§maxå€¼æˆ–æ¸…ç†è¿æ¥` |
| **CPUä½¿ç”¨** | `top -p $(pgrep firewalld)` | `< 10%` | `ä¼˜åŒ–è§„åˆ™æˆ–å‡çº§ç¡¬ä»¶` |
| **å†…å­˜ä½¿ç”¨** | `cat /proc/net/nf_conntrack` | `åˆç†èŒƒå›´` | `è°ƒæ•´è¶…æ—¶æ—¶é—´` |
| **ç½‘ç»œå»¶è¿Ÿ** | `ping -c 10 8.8.8.8` | `< 50mså¢é‡` | `æ£€æŸ¥ç½‘ç»œé…ç½®` |

**ğŸ”„ æ€§èƒ½ä¼˜åŒ–é…ç½®**
```bash
# è¿æ¥è·Ÿè¸ªä¼˜åŒ–
echo 'net.netfilter.nf_conntrack_max = 262144' >> /etc/sysctl.conf
echo 'net.netfilter.nf_conntrack_buckets = 32768' >> /etc/sysctl.conf

# è¶…æ—¶æ—¶é—´è°ƒæ•´(ç§’)
echo 'net.netfilter.nf_conntrack_tcp_timeout_established = 600' >> /etc/sysctl.conf
echo 'net.netfilter.nf_conntrack_udp_timeout = 30' >> /etc/sysctl.conf
echo 'net.netfilter.nf_conntrack_tcp_timeout_time_wait = 30' >> /etc/sysctl.conf

# åº”ç”¨é…ç½®
sysctl -p
```

### 5.3 ç›‘æ§ä¸ç»´æŠ¤


**ğŸ“ˆ æ—¥å¿—ç›‘æ§**
```bash
# å¯ç”¨è¿æ¥è·Ÿè¸ªæ—¥å¿—
echo 'net.netfilter.nf_log_all_netns = 1' >> /etc/sysctl.conf

# æŸ¥çœ‹masqueradingç›¸å…³æ—¥å¿—
journalctl -u firewalld | grep -i masquerade

# ç›‘æ§è¿æ¥å»ºç«‹æƒ…å†µ
tcpdump -i any -n "src net 192.168.0.0/16 and dst not net 192.168.0.0/16"
```

**ğŸ”§ ç»´æŠ¤è„šæœ¬**
```bash
#!/bin/bash
# masqueradingå¥åº·æ£€æŸ¥è„šæœ¬

check_masquerading() {
    # æ£€æŸ¥IPè½¬å‘
    if [ "$(cat /proc/sys/net/ipv4/ip_forward)" != "1" ]; then
        echo "âŒ IPè½¬å‘æœªå¯ç”¨"
        return 1
    fi
    
    # æ£€æŸ¥masqueradingçŠ¶æ€  
    if ! firewall-cmd --query-masquerade >/dev/null 2>&1; then
        echo "âŒ Masqueradingæœªå¯ç”¨"
        return 1
    fi
    
    # æ£€æŸ¥è¿æ¥è·Ÿè¸ªè¡¨ä½¿ç”¨ç‡
    current=$(cat /proc/sys/net/netfilter/nf_conntrack_count)
    max=$(cat /proc/sys/net/netfilter/nf_conntrack_max)
    usage=$((current * 100 / max))
    
    if [ $usage -gt 80 ]; then
        echo "âš ï¸  è¿æ¥è·Ÿè¸ªè¡¨ä½¿ç”¨ç‡è¿‡é«˜: ${usage}%"
        return 1
    fi
    
    echo "âœ… Masqueradingè¿è¡Œæ­£å¸¸"
    echo "ğŸ“Š è¿æ¥æ•°: $current/$max (${usage}%)"
    return 0
}

# æ‰§è¡Œæ£€æŸ¥
check_masquerading
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ åœ°å€ä¼ªè£…æœ¬è´¨ï¼šå°†ç§æœ‰IPä¼ªè£…æˆå…¬ç½‘IPï¼Œå®ç°å†…ç½‘è®¿é—®å¤–ç½‘
ğŸ”¸ NATè½¬æ¢æœºåˆ¶ï¼šä¿®æ”¹æ•°æ®åŒ…æºIPå’Œç«¯å£ï¼Œç»´æŠ¤è¿æ¥çŠ¶æ€è¡¨
ğŸ”¸ é…ç½®ä¸‰è¦ç´ ï¼šIPè½¬å‘ + æ¥å£åŒºåŸŸ + masqueradingå¯ç”¨
ğŸ”¸ é€‚ç”¨åœºæ™¯ï¼šåŠ¨æ€IPç¯å¢ƒä¸‹çš„ç½‘ç»œå…±äº«å’Œè·¯ç”±å™¨åŠŸèƒ½
ğŸ”¸ æ€§èƒ½è€ƒè™‘ï¼šè¿æ¥è·Ÿè¸ªè¡¨å¤§å°å’Œè¶…æ—¶æ—¶é—´è®¾ç½®
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ masquerading vs SNAT**
```
é€‰æ‹©åŸåˆ™ï¼š
- åŠ¨æ€IP/æ‹¨å·ä¸Šç½‘ â†’ ä½¿ç”¨masquerading
- å›ºå®šå…¬ç½‘IP â†’ ä½¿ç”¨SNATæ€§èƒ½æ›´å¥½
- è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜ â†’ masqueradingæ›´é€‚åˆ
- ç²¾ç»†æ§åˆ¶éœ€æ±‚ â†’ SNATæ›´çµæ´»
```

**ğŸ”¹ ç½‘ç»œæµé‡è·¯å¾„**
```
å‡ºç«™æµé‡ï¼šå†…ç½‘è®¾å¤‡ â†’ Linuxè·¯ç”±å™¨ â†’ ä¿®æ”¹æºIP â†’ å¤–ç½‘
å…¥ç«™æµé‡ï¼šå¤–ç½‘ â†’ Linuxè·¯ç”±å™¨ â†’ æŸ¥è¡¨è½¬æ¢ â†’ å†…ç½‘è®¾å¤‡
å…³é”®ï¼šè¿æ¥çŠ¶æ€è¡¨æ˜¯åŒå‘è½¬æ¢çš„åŸºç¡€
```

**ğŸ”¹ é…ç½®æ£€æŸ¥é‡ç‚¹**
```
å¿…æ£€é¡¹ç›®ï¼š
1. IPè½¬å‘æ˜¯å¦å¯ç”¨ (/proc/sys/net/ipv4/ip_forward)
2. æ¥å£åŒºåŸŸåˆ†é…æ˜¯å¦æ­£ç¡®
3. masqueradingæ˜¯å¦åœ¨æ­£ç¡®åŒºåŸŸå¯ç”¨
4. é»˜è®¤è·¯ç”±æ˜¯å¦æŒ‡å‘å¤–ç½‘æ¥å£
5. è¿æ¥è·Ÿè¸ªè¡¨æ˜¯å¦æ­£å¸¸å·¥ä½œ
```

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯**
- **ä¼ä¸šç½‘å…³**ï¼šå…¬å¸å†…ç½‘ç»Ÿä¸€å‡ºå£ä¸Šç½‘
- **å®¶åº­è·¯ç”±**ï¼šå¤šè®¾å¤‡å…±äº«å®½å¸¦è¿æ¥  
- **äº‘ä¸»æœº**ï¼šè™šæ‹Ÿæœºé€šè¿‡å®¿ä¸»æœºè®¿é—®å¤–ç½‘
- **æµ‹è¯•ç¯å¢ƒ**ï¼šå¿«é€Ÿæ­å»ºç½‘ç»œéš”ç¦»ç¯å¢ƒ

**ğŸ”§ æœ€ä½³å®è·µ**
```bash
# æ ‡å‡†é…ç½®æµç¨‹
1. å¯ç”¨IPè½¬å‘ï¼šsysctl net.ipv4.ip_forward=1
2. é…ç½®æ¥å£åŒºåŸŸï¼šå†…ç½‘internalï¼Œå¤–ç½‘public/external  
3. å¯ç”¨masqueradingï¼šfirewall-cmd --add-masquerade
4. éªŒè¯é…ç½®ï¼šæµ‹è¯•å†…ç½‘è®¾å¤‡è®¿é—®å¤–ç½‘
5. æ€§èƒ½è°ƒä¼˜ï¼šæ ¹æ®è´Ÿè½½è°ƒæ•´è¿æ¥è·Ÿè¸ªå‚æ•°
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
```
å®‰å…¨é£é™©ï¼š
- masqueradingä¼šéšè—å†…ç½‘çœŸå®IPï¼Œå½±å“æ—¥å¿—å®¡è®¡
- éœ€è¦é…åˆå…¶ä»–å®‰å…¨ç­–ç•¥æ§åˆ¶è®¿é—®æƒé™
- æ³¨æ„é˜²èŒƒå†…ç½‘è®¾å¤‡è¢«æ¶æ„åˆ©ç”¨

æ€§èƒ½å½±å“ï¼š  
- æ¯ä¸ªè¿æ¥éƒ½éœ€è¦ç»´æŠ¤çŠ¶æ€è¡¨ï¼Œæ¶ˆè€—å†…å­˜
- è¿æ¥æ•°è¿‡å¤šæ—¶ä¼šå½±å“æ•´ä½“æ€§èƒ½
- éœ€è¦æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´ç›¸å…³å‚æ•°
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- masquerading = åœ°å€ä¼ªè£… = åŠ¨æ€SNAT
- å†…ç½‘è®¿é—®å¤–ç½‘çš„æ¡¥æ¢ï¼ŒLinuxå˜èº«è·¯ç”±å™¨
- IPè½¬å‘ + åŒºåŸŸé…ç½® + masqueradingå¯ç”¨ = å®Œæ•´æ–¹æ¡ˆ
- è¿æ¥çŠ¶æ€è¡¨æ˜¯æ ¸å¿ƒï¼Œæ€§èƒ½ä¼˜åŒ–çœ‹è¿™é‡Œ
- åŠ¨æ€IPç¯å¢ƒé¦–é€‰ï¼Œå›ºå®šIPå¯ç”¨SNATæ›¿ä»£