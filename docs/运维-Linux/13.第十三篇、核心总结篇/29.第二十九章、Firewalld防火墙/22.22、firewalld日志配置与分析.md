---
title: 22、firewalld日志配置与分析
---
## 📚 目录

1. [firewalld日志概述](#1-firewalld日志概述)
2. [日志配置详解](#2-日志配置详解)
3. [日志级别与类型](#3-日志级别与类型)
4. [拒绝连接日志记录](#4-拒绝连接日志记录)
5. [日志文件位置与格式](#5-日志文件位置与格式)
6. [日志轮转配置](#6-日志轮转配置)
7. [日志分析工具与技巧](#7-日志分析工具与技巧)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔍 firewalld日志概述


### 1.1 什么是firewalld日志


📍 **基础概念**：🟢 入门必知
```
firewalld日志 = 防火墙的"行车记录仪"
记录所有通过防火墙的流量信息，包括允许、拒绝、丢弃的连接
帮助管理员了解网络安全状况和排查网络问题
```

**💡 实际意义**：
> 📱 **生活类比**：就像小区门卫的登记本
> - 记录谁进出了小区（哪些连接通过了防火墙）
> - 记录被拒绝进入的人（被阻止的连接）
> - 方便查询和安全审计

### 1.2 firewalld日志的重要作用


🎯 **核心价值**：
- **🔒 安全监控**：发现恶意攻击和入侵尝试
- **🔧 故障排查**：定位网络连接问题
- **📊 流量分析**：了解网络使用情况
- **📋 合规审计**：满足安全规范要求

**📈 应用场景**：
| 场景类型 | 日志作用 | 实际价值 |
|----------|----------|----------|
| 🏢 **企业环境** | 监控外部访问 | 防止数据泄露 |
| 🖥️ **服务器管理** | 跟踪服务状态 | 快速定位问题 |
| 🔐 **安全审计** | 记录访问行为 | 合规性检查 |

---

## 2. ⚙️ 日志配置详解


### 2.1 日志配置文件位置


**🗂️ 主要配置文件**：
```
/etc/firewalld/firewalld.conf  ← 主配置文件
/etc/rsyslog.conf             ← 系统日志配置
/etc/logrotate.d/rsyslog      ← 日志轮转配置
```

### 2.2 基本日志配置


**🔧 配置方法一：命令行配置**
```bash
# 启用防火墙日志
firewall-cmd --set-log-denied=all

# 查看当前日志配置
firewall-cmd --get-log-denied

# 设置不同的日志级别
firewall-cmd --set-log-denied=unicast  # 只记录单播包
firewall-cmd --set-log-denied=broadcast # 只记录广播包
firewall-cmd --set-log-denied=multicast # 只记录组播包
```

❓ **常见问题**：
**Q: 为什么要分不同的日志级别？**
**A:** 不同类型的流量产生的日志量差异很大。广播和组播包通常很多，如果全部记录会产生大量日志，影响系统性能。

**🔧 配置方法二：配置文件修改**
```bash
# 编辑主配置文件
vim /etc/firewalld/firewalld.conf

# 找到以下配置项
LogDenied=off     # 修改为：LogDenied=all
```

**📊 日志配置选项对比**：
| 选项值 | 记录内容 | 日志量 | 适用场景 |
|--------|----------|--------|----------|
| `off` | 不记录 | 无 | 性能优先 |
| `all` | 记录所有 | 很大 | 详细监控 |
| `unicast` | 单播包 | 中等 | 一般监控 |
| `broadcast` | 广播包 | 大 | 网络调试 |
| `multicast` | 组播包 | 大 | 组播调试 |

### 2.3 配置生效与验证


🔄 **使配置生效**：
```bash
# 重新加载配置
firewall-cmd --reload

# 查看配置状态
firewall-cmd --get-log-denied

# 验证配置是否生效
systemctl restart firewalld
```

---

## 3. 📊 日志级别与类型


### 3.1 Linux系统日志级别


📍 **日志级别层次**：🟡 需要理解
```
系统日志级别（数字越小级别越高）：
0 = emergency  (紧急)    ← 系统不可用
1 = alert      (警报)    ← 必须立即处理
2 = critical   (严重)    ← 严重错误
3 = error      (错误)    ← 一般错误
4 = warning    (警告)    ← 警告信息
5 = notice     (通知)    ← 正常但重要
6 = info       (信息)    ← 一般信息
7 = debug      (调试)    ← 调试信息
```

🧠 **记忆口诀**：
"紧急警报很严重，错误警告要通知，信息调试帮排错"

### 3.2 firewalld日志类型


**🔸 按连接状态分类**：
- **ACCEPT**：允许通过的连接
- **DROP**：直接丢弃的连接（不回应）
- **REJECT**：拒绝的连接（会回应拒绝信息）

**🔸 按流量类型分类**：
- **INPUT**：进入本机的流量
- **OUTPUT**：从本机发出的流量
- **FORWARD**：通过本机转发的流量

💼 **实际理解**：
> 🏢 **办公楼比喻**：
> - INPUT像访客要进入办公楼
> - OUTPUT像员工要离开办公楼
> - FORWARD像快递员路过办公楼去别的地方

### 3.3 日志详细程度控制


**📈 详细程度级别**：
| 级别 | 记录内容 | 性能影响 | 使用建议 |
|------|----------|----------|----------|
| **最少** | 只记录REJECT | 影响很小 | 日常监控 |
| **一般** | 记录DROP+REJECT | 影响较小 | 安全监控 |
| **详细** | 记录所有拒绝 | 影响中等 | 问题排查 |
| **完整** | 记录所有连接 | 影响较大 | 调试分析 |

---

## 4. 🚫 拒绝连接日志记录


### 4.1 拒绝连接记录原理


**🔸 核心机制**：
```
网络包到达 → firewalld规则匹配 → 拒绝处理 → 写入日志
                                    ↓
                           内核netfilter记录
                                    ↓
                           rsyslog收集并写入文件
```

### 4.2 配置拒绝连接日志


**🔧 启用拒绝日志记录**：
```bash
# 记录所有被拒绝的连接
firewall-cmd --set-log-denied=all --permanent
firewall-cmd --reload

# 只记录单播被拒绝的连接（推荐）
firewall-cmd --set-log-denied=unicast --permanent
```

❓ **为什么推荐unicast**：
**A:** 广播和组播包在网络中很常见（如ARP、DHCP等），如果全部记录会产生大量日志，unicast模式只记录针对性的连接尝试，更有安全价值。

### 4.3 拒绝日志示例分析


**📋 典型拒绝日志格式**：
```
Jan 18 10:30:15 server kernel: FINAL_REJECT: IN=eth0 OUT= MAC=00:0c:29:xx:xx:xx SRC=192.168.1.100 DST=192.168.1.10 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=12345 DF PROTO=TCP SPT=54321 DPT=22 WINDOW=29200 RES=0x00 SYN URGP=0
```

**🔍 字段解读**：
- `FINAL_REJECT`: 最终拒绝动作
- `IN=eth0`: 从eth0网卡进入
- `SRC=192.168.1.100`: 源IP地址
- `DST=192.168.1.10`: 目标IP地址
- `PROTO=TCP`: 协议类型
- `SPT=54321`: 源端口
- `DPT=22`: 目标端口（SSH）
- `SYN`: TCP连接请求

💡 **这条日志含义**：
"有人从192.168.1.100尝试SSH连接到本机的22端口，被防火墙拒绝了"

### 4.4 常见拒绝场景分析


**🎯 典型拒绝场景**：
| 场景 | 特征 | 可能原因 | 处理建议 |
|------|------|----------|----------|
| **SSH扫描** | DPT=22，多个源IP | 暴力破解 | 加强SSH安全 |
| **Web攻击** | DPT=80/443，异常请求 | 网站攻击 | 检查Web日志 |
| **内网扫描** | 连续端口，同源IP | 内网探测 | 排查内网安全 |

---

## 5. 📂 日志文件位置与格式


### 5.1 日志文件位置


**🗂️ 主要日志文件**：
```
/var/log/messages     ← 系统主日志（包含防火墙日志）
/var/log/secure       ← 安全相关日志
/var/log/firewalld    ← firewalld服务日志（如果配置）
/var/log/kern.log     ← 内核日志（某些发行版）
```

**🔍 查看日志命令**：
```bash
# 查看实时日志
tail -f /var/log/messages

# 查看防火墙相关日志
grep -i firewall /var/log/messages

# 查看被拒绝的连接
grep "REJECT\|DROP" /var/log/messages

# 查看指定IP的日志
grep "192.168.1.100" /var/log/messages
```

### 5.2 日志格式详解


**📋 标准日志格式**：
```
时间戳 主机名 进程[PID]: 日志级别 具体内容
```

**🔍 实际示例分析**：
```
Jan 18 10:30:15 server kernel: FINAL_REJECT: IN=eth0 OUT= SRC=10.0.0.50 DST=10.0.0.10 PROTO=TCP DPT=3306
```

**📊 字段对应表**：
| 字段 | 含义 | 示例值 | 说明 |
|------|------|--------|------|
| 时间戳 | 日志时间 | `Jan 18 10:30:15` | 月日时分秒 |
| 主机名 | 服务器名称 | `server` | 本机主机名 |
| 进程 | 记录进程 | `kernel` | 内核日志 |
| 动作 | 处理结果 | `FINAL_REJECT` | 拒绝连接 |
| 网络信息 | 连接详情 | `SRC/DST/PROTO` | 源/目标/协议 |

### 5.3 自定义日志位置


**🔧 配置独立的防火墙日志文件**：
```bash
# 编辑rsyslog配置
vim /etc/rsyslog.conf

# 添加以下配置
kern.warning    /var/log/firewall.log

# 重启rsyslog服务
systemctl restart rsyslog
```

💡 **独立日志文件的好处**：
- 方便日志分析和处理
- 不与其他系统日志混合
- 便于设置专门的轮转策略
- 提高日志查询效率

---

## 6. 🔄 日志轮转配置


### 6.1 什么是日志轮转


📍 **基础概念**：🟢 入门必知
```
日志轮转 = 日志文件的"自动清理"
当日志文件过大或过旧时，自动：
- 重命名旧日志（如messages → messages.1）
- 创建新的日志文件
- 压缩或删除很旧的日志
```

> 📱 **生活类比**：像手机相册的自动整理功能
> - 旧照片自动分类存档
> - 释放存储空间
> - 保留重要照片

### 6.2 配置防火墙日志轮转


**🔧 创建专用轮转配置**：
```bash
# 创建防火墙日志轮转配置
vim /etc/logrotate.d/firewall

# 配置内容
/var/log/firewall.log {
    daily                # 每天轮转
    rotate 30           # 保留30个备份
    missingok           # 文件不存在不报错
    notifempty          # 空文件不轮转
    compress            # 压缩旧日志
    delaycompress       # 延迟一天压缩
    postrotate          # 轮转后执行
        /bin/kill -HUP `cat /var/run/rsyslogd.pid 2>/dev/null` 2>/dev/null || true
    endscript
}
```

**📊 轮转策略对比**：
| 策略 | 轮转频率 | 保留数量 | 适用场景 |
|------|----------|----------|----------|
| **保守型** | weekly | 52个 | 小型系统 |
| **平衡型** | daily | 30个 | 一般服务器 |
| **激进型** | daily | 7个 | 高流量系统 |

### 6.3 验证轮转配置


**🔍 测试轮转配置**：
```bash
# 手动测试轮转
logrotate -d /etc/logrotate.d/firewall

# 强制执行轮转
logrotate -f /etc/logrotate.d/firewall

# 查看轮转状态
cat /var/lib/logrotate/status
```

### 6.4 日志空间管理


**📊 日志空间监控**：
```bash
# 查看日志目录占用
du -sh /var/log/

# 查看具体日志文件大小
ls -lh /var/log/messages*

# 清理过期日志（谨慎操作）
find /var/log -name "*.log.*" -mtime +30 -delete
```

**⚠️ 重要提醒**：
> 清理日志前一定要确认：
> - 是否还需要这些日志进行分析
> - 是否满足合规要求的保留期限
> - 是否已经备份重要日志

---

## 7. 🔧 日志分析工具与技巧


### 7.1 基础分析命令


**🔍 常用日志查询命令**：
```bash
# 查看最新的防火墙日志
tail -100 /var/log/messages | grep -i firewall

# 查看特定时间段的日志
grep "Jan 18 10:" /var/log/messages

# 统计被拒绝的连接数
grep "REJECT\|DROP" /var/log/messages | wc -l

# 查看最频繁的攻击源IP
grep "REJECT\|DROP" /var/log/messages | \
grep -o "SRC=[0-9.]*" | sort | uniq -c | sort -nr | head -10
```

### 7.2 高级分析技巧


**📊 攻击模式分析**：
```bash
# 分析攻击的目标端口
grep "REJECT" /var/log/messages | \
grep -o "DPT=[0-9]*" | sort | uniq -c | sort -nr

# 分析攻击时间模式
grep "REJECT" /var/log/messages | \
awk '{print $3}' | cut -d: -f1 | sort | uniq -c

# 分析协议分布
grep "REJECT" /var/log/messages | \
grep -o "PROTO=[A-Z]*" | sort | uniq -c
```

### 7.3 实用分析脚本


**🛠️ 防火墙日志分析脚本**：
```bash
#!/bin/bash
# firewall_analyzer.sh - 防火墙日志分析工具

echo "=== 防火墙日志统计 ==="
echo "日志文件: /var/log/messages"
echo "分析时间: $(date)"
echo

# 基础统计
echo "1. 基础统计信息："
echo "   总拒绝连接数: $(grep -c "REJECT\|DROP" /var/log/messages)"
echo "   今日拒绝连接数: $(grep "$(date '+%b %d')" /var/log/messages | grep -c "REJECT\|DROP")"
echo

# TOP攻击源IP
echo "2. TOP 10 攻击源IP："
grep "REJECT\|DROP" /var/log/messages | \
grep -o "SRC=[0-9.]*" | cut -d= -f2 | sort | uniq -c | sort -nr | head -10 | \
while read count ip; do
    echo "   $ip: $count 次"
done
echo

# TOP攻击目标端口
echo "3. TOP 10 攻击目标端口："
grep "REJECT\|DROP" /var/log/messages | \
grep -o "DPT=[0-9]*" | cut -d= -f2 | sort | uniq -c | sort -nr | head -10 | \
while read count port; do
    echo "   端口 $port: $count 次"
done
```

### 7.4 图形化分析工具


**📊 推荐分析工具**：
| 工具名称 | 特点 | 适用场景 |
|----------|------|----------|
| **GoAccess** | 实时Web界面 | 在线监控 |
| **Logwatch** | 定期邮件报告 | 自动化监控 |
| **ELK Stack** | 企业级分析 | 大规模环境 |

**🔧 快速部署GoAccess**：
```bash
# 安装GoAccess
yum install goaccess -y

# 分析防火墙日志
goaccess /var/log/messages -o /var/www/html/firewall-report.html --log-format=COMBINED
```

### 7.5 自动化监控与告警


**⚡ 简单告警脚本**：
```bash
#!/bin/bash
# firewall_alert.sh - 防火墙攻击告警

THRESHOLD=100  # 告警阈值
LOG_FILE="/var/log/messages"
TEMP_FILE="/tmp/firewall_count"

# 获取最近一小时的拒绝连接数
HOUR_AGO=$(date -d "1 hour ago" "+%b %d %H:")
REJECT_COUNT=$(grep "$HOUR_AGO" $LOG_FILE | grep -c "REJECT\|DROP")

echo $REJECT_COUNT > $TEMP_FILE

if [ $REJECT_COUNT -gt $THRESHOLD ]; then
    echo "警告: 检测到大量攻击尝试！"
    echo "最近一小时被拒绝连接数: $REJECT_COUNT"
    echo "超过告警阈值: $THRESHOLD"
    # 这里可以添加邮件或短信告警
fi
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 firewalld日志是网络安全监控的重要工具
🔸 日志配置需要平衡详细程度和系统性能
🔸 拒绝连接日志记录是安全监控的重点
🔸 合理的日志轮转策略防止磁盘空间不足
🔸 掌握基础的日志分析技巧和工具使用
```

### 8.2 关键配置要点


**🔹 配置最佳实践**：
```
推荐设置：
- LogDenied=unicast  # 平衡详细程度和性能
- 日志轮转：daily rotate 30  # 保留一个月
- 独立日志文件：便于分析
- 定期监控：设置告警阈值
```

**🔹 分析关键指标**：
```
重点关注：
- 攻击源IP Top排行
- 被攻击端口分布
- 攻击时间模式
- 攻击协议类型
- 异常流量增长
```

### 8.3 实际应用指导


**✅ 学习检查点**：
- [ ] 能够配置firewalld日志记录
- [ ] 理解不同日志级别的含义和选择
- [ ] 会分析日志格式和字段含义
- [ ] 能够设置合理的日志轮转策略
- [ ] 掌握基本的日志分析命令和技巧

**🛤️ 学习路径**：
```
入门级: 理解日志概念 → 基本配置 → 简单分析
进阶级: 高级配置 → 自动化分析 → 告警设置
专家级: 性能优化 → 大规模部署 → 安全策略
```

**💡 实用建议**：
- **开始时使用unicast级别**，避免日志过多
- **定期检查日志文件大小**，防止磁盘满
- **建立分析习惯**，每天查看攻击统计
- **结合其他安全工具**，形成完整的安全监控体系

**🧠 记忆要点**：
"日志配置要平衡，轮转策略防爆盘，分析工具助排查，安全监控保平安"

**🔗 相关知识**：
- **前置知识**：需要了解 `Linux系统日志机制`
- **相关概念**：与 `iptables日志` `rsyslog配置` 密切相关
- **后续学习**：可以进一步学习 `ELK日志分析` `安全事件响应`