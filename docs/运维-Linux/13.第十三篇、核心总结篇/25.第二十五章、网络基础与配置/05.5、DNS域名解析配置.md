---
title: 5、DNS域名解析配置
---
## 📚 目录

1. [DNS基础概念](#1-DNS基础概念)
2. [DNS配置文件详解](#2-DNS配置文件详解)
3. [本地域名解析配置](#3-本地域名解析配置)
4. [域名解析顺序控制](#4-域名解析顺序控制)
5. [DNS诊断工具使用](#5-DNS诊断工具使用)
6. [DNS缓存机制与管理](#6-DNS缓存机制与管理)
7. [公共DNS服务器配置](#7-公共DNS服务器配置)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🌐 DNS基础概念


### 1.1 什么是DNS


**DNS（Domain Name System）**：域名系统，就像互联网的"电话簿"

> **💡 生活类比**
> 
> 就像你找朋友时，记住朋友的名字（域名）比记住电话号码（IP地址）容易得多。DNS就是帮你把朋友名字转换成电话号码的服务。

**为什么需要DNS？**
- **人类友好**：记住`www.baidu.com`比记住`220.181.38.148`容易
- **灵活变更**：网站换服务器时，只需更新DNS记录，域名不变
- **负载分担**：一个域名可以对应多个IP地址

### 1.2 DNS工作原理


```
用户输入网址的解析过程：

用户浏览器 ──→ 本地DNS配置 ──→ DNS服务器 ──→ 返回IP地址
     ↓              ↓              ↓              ↓
输入baidu.com   查询本地配置   向DNS服务器查询   得到具体IP
```

**DNS解析的基本流程**：
1. **检查本地缓存**：先看电脑是否记住了这个域名对应的IP
2. **查看hosts文件**：检查本地是否有手动配置的域名解析
3. **查询DNS服务器**：向配置的DNS服务器发起查询请求
4. **返回结果**：DNS服务器返回域名对应的IP地址

---

## 2. ⚙️ DNS配置文件详解


### 2.1 /etc/resolv.conf - 主要DNS配置文件


**这是什么文件？**
`/etc/resolv.conf`就是Linux系统的"DNS设置面板"，告诉系统去哪里查询域名。

```bash
# 查看当前DNS配置
cat /etc/resolv.conf
```

**典型的配置内容**：
```
nameserver 8.8.8.8
nameserver 114.114.114.114  
search example.com
domain example.com
options timeout:2 attempts:3
```

### 2.2 配置参数详解


**nameserver - DNS服务器地址**
```
nameserver 8.8.8.8          # 主DNS服务器
nameserver 114.114.114.114   # 备用DNS服务器
```
> **📌 重要说明**：可以配置多个nameserver，系统会按顺序尝试查询

**search - 搜索域列表**
```
search company.com local.domain
```
- **作用**：当你输入不完整域名时，系统自动补全后缀
- **例子**：输入`web`会自动尝试查询`web.company.com`和`web.local.domain`

**domain - 本地域名**
```
domain company.com
```
- **作用**：指定本机所属的域
- **区别**：domain只能指定一个域，search可以指定多个

**options - 查询选项**
```
options timeout:2 attempts:3 rotate
```
| 选项 | 含义 | 默认值 |
|------|------|--------|
| `timeout` | 等待DNS响应的超时时间（秒） | 5秒 |
| `attempts` | 查询失败后的重试次数 | 2次 |
| `rotate` | 轮询使用多个DNS服务器 | 不轮询 |

### 2.3 手动配置DNS


```bash
# 备份原配置
sudo cp /etc/resolv.conf /etc/resolv.conf.backup

# 编辑DNS配置
sudo vim /etc/resolv.conf
```

**推荐配置示例**：
```
# 主DNS：谷歌公共DNS  
nameserver 8.8.8.8
# 备用DNS：114公共DNS
nameserver 114.114.114.114
# 查询选项优化
options timeout:1 attempts:2
```

> **⚠️ 重要提醒**：某些系统(如使用NetworkManager)会自动覆盖此文件，需要通过网络管理工具配置

---

## 3. 🏠 本地域名解析配置


### 3.1 /etc/hosts - 本地域名映射


**这是干什么的？**
`/etc/hosts`文件就像你的私人电话簿，可以直接指定某个域名对应哪个IP地址，**优先级比DNS服务器查询更高**。

```bash
# 查看hosts文件
cat /etc/hosts
```

**默认内容解释**：
```
127.0.0.1   localhost localhost.localdomain
::1         localhost localhost.localdomain
127.0.0.1   my-hostname
```

### 3.2 自定义域名映射


**常用场景**：
- **开发测试**：将测试域名指向本地服务器
- **屏蔽网站**：将广告域名指向无效IP
- **内网访问**：配置内网服务器的友好域名

**配置格式**：
```
IP地址    域名1    域名2    别名
```

**实用配置示例**：
```bash
# 编辑hosts文件
sudo vim /etc/hosts

# 添加以下内容：
# 开发环境配置
192.168.1.100    dev.mysite.com    dev-api.mysite.com
192.168.1.101    test.mysite.com

# 屏蔽广告域名
0.0.0.0    ads.google.com
0.0.0.0    doubleclick.net

# 本地服务别名  
127.0.0.1    local.db    local.redis
```

### 3.3 hosts文件验证


**测试配置是否生效**：
```bash
# 测试域名解析
ping dev.mysite.com

# 查看解析结果  
nslookup dev.mysite.com
```

**验证优先级**：
```bash
# hosts文件中的配置会优先于DNS服务器
# 即使DNS服务器返回不同IP，hosts文件的配置优先
```

> **💭 理解要点**：hosts文件的配置是"强制性"的，系统会直接使用这里的映射关系，不会再去查询DNS服务器

---

## 4. 🔄 域名解析顺序控制


### 4.1 /etc/nsswitch.conf - 解析顺序配置


**这个文件的作用**：
控制系统在进行各种查询（包括域名解析）时的顺序和方式，就像设置"查找规则"。

```bash
# 查看名称解析配置
grep hosts /etc/nsswitch.conf
```

**典型配置**：
```
hosts: files dns
```

### 4.2 解析顺序选项详解


| 选项 | 含义 | 查询位置 |
|------|------|----------|
| `files` | 查询本地文件 | `/etc/hosts` |
| `dns` | 查询DNS服务器 | `/etc/resolv.conf`中的nameserver |
| `myhostname` | 查询本机hostname | 系统hostname设置 |

**常见配置组合**：

**标准配置**（推荐）：
```
hosts: files dns
```
- 含义：先查hosts文件，再查DNS服务器
- 适用：大多数情况

**仅本地解析**：
```  
hosts: files
```
- 含义：只查hosts文件，不查DNS
- 适用：完全离线环境

**DNS优先**：
```
hosts: dns files  
```
- 含义：先查DNS服务器，再查hosts文件
- 适用：特殊需求场景

### 4.3 修改解析顺序


```bash
# 备份配置文件
sudo cp /etc/nsswitch.conf /etc/nsswitch.conf.backup

# 编辑配置
sudo vim /etc/nsswitch.conf

# 找到hosts行，修改为需要的顺序
hosts: files dns myhostname
```

> **🧠 记忆技巧**：解析顺序就像排队，写在前面的先查询，查到了就不再继续查后面的

---

## 5. 🔍 DNS诊断工具使用


### 5.1 nslookup - 基础域名查询


**什么是nslookup？**
nslookup是最基础的域名查询工具，就像问DNS服务器"这个域名对应什么IP地址？"

```bash
# 基本查询
nslookup baidu.com

# 指定DNS服务器查询
nslookup baidu.com 8.8.8.8
```

**常用查询类型**：
```bash
# 查询A记录（IPv4地址）
nslookup baidu.com

# 查询MX记录（邮件服务器）
nslookup -type=MX baidu.com

# 查询NS记录（域名服务器）
nslookup -type=NS baidu.com

# 反向查询（IP查域名）
nslookup 220.181.38.148
```

### 5.2 dig - 高级DNS诊断工具


**dig比nslookup强在哪里？**
dig提供更详细的查询结果和更多的控制选项，是DNS问题诊断的首选工具。

**基础用法**：
```bash
# 简单查询
dig baidu.com

# 查询指定记录类型
dig baidu.com A      # IPv4地址
dig baidu.com MX     # 邮件服务器
dig baidu.com NS     # 域名服务器
dig baidu.com CNAME  # 别名记录

# 指定DNS服务器
dig @8.8.8.8 baidu.com
```

**高级诊断选项**：
```bash
# 显示详细查询过程
dig +trace baidu.com

# 简化输出（只显示结果）
dig +short baidu.com

# 反向DNS查询
dig -x 220.181.38.148

# 查询所有记录类型
dig baidu.com ANY
```

### 5.3 host - 简洁域名查询


**host命令的特点**：
输出简洁明了，适合快速查询和脚本使用。

```bash
# 基本查询
host baidu.com

# 查询特定类型
host -t MX baidu.com    # 邮件服务器
host -t NS baidu.com    # 域名服务器  
host -t A baidu.com     # IPv4地址

# 反向查询
host 220.181.38.148

# 详细输出
host -v baidu.com
```

### 5.4 工具选择指南


| 场景 | 推荐工具 | 原因 |
|------|----------|------|
| 快速查询IP | `host` | 输出简洁 |
| 问题诊断 | `dig` | 信息详细 |
| 学习DNS | `nslookup` | 交互式操作 |
| 脚本使用 | `dig +short` | 输出格式化 |

---

## 6. 💾 DNS缓存机制与管理


### 6.1 DNS缓存的作用


**为什么需要DNS缓存？**
- **提高速度**：避免重复查询同一个域名
- **减少网络负担**：减少DNS服务器压力
- **提高稳定性**：DNS服务器故障时仍能访问缓存的域名

```
DNS缓存层级：

浏览器缓存 ──→ 系统缓存 ──→ 路由器缓存 ──→ ISP缓存 ──→ 权威DNS服务器
(几分钟)     (几小时)      (几小时)      (几天)      (真实数据)
```

### 6.2 查看DNS缓存


**systemd-resolved系统**（Ubuntu 18.04+）：
```bash
# 查看DNS缓存统计
systemd-resolve --statistics

# 查看缓存内容
systemd-resolve --status
```

**传统系统**：
```bash
# 大多数Linux系统默认不缓存DNS
# 可以通过安装nscd服务启用缓存
sudo systemctl status nscd
```

### 6.3 清理DNS缓存


**systemd-resolved系统**：
```bash
# 清理所有DNS缓存
sudo systemd-resolve --flush-caches

# 验证缓存已清理
systemd-resolve --statistics
```

**nscd缓存系统**：
```bash
# 清理nscd的DNS缓存
sudo systemctl restart nscd
# 或者
sudo nscd -i hosts
```

**浏览器缓存清理**：
```bash
# Chrome浏览器访问：
chrome://net-internals/#dns

# 点击"Clear host cache"按钮
```

### 6.4 缓存相关问题排查


**常见DNS缓存问题**：

| 现象 | 可能原因 | 解决方法 |
|------|----------|----------|
| 域名解析到旧IP | DNS缓存未更新 | 清理DNS缓存 |
| 某些网站无法访问 | DNS缓存损坏 | 重启DNS服务 |
| 解析速度很慢 | 缓存命中率低 | 检查DNS服务器响应速度 |

**排查步骤**：
```bash
# 1. 清理系统DNS缓存
sudo systemd-resolve --flush-caches

# 2. 测试域名解析
dig baidu.com

# 3. 检查不同DNS服务器的结果
dig @8.8.8.8 baidu.com
dig @114.114.114.114 baidu.com

# 4. 检查hosts文件是否有冲突
grep baidu.com /etc/hosts
```

---

## 7. 🌍 公共DNS服务器配置


### 7.1 主流公共DNS服务器


**为什么使用公共DNS？**
- **速度快**：专业公司维护，服务器分布全球
- **稳定性高**：7x24小时监控，故障率低
- **安全性好**：有恶意域名过滤功能

**主流公共DNS服务器对比**：

| 服务商 | 主DNS | 备DNS | 特点 |
|--------|-------|-------|------|
| **Google** | `8.8.8.8` | `8.8.4.4` | 速度快，全球覆盖 |
| **Cloudflare** | `1.1.1.1` | `1.0.0.1` | 主打隐私保护 |
| **114DNS** | `114.114.114.114` | `114.114.115.115` | 国内访问快 |
| **阿里DNS** | `223.5.5.5` | `223.6.6.6` | 阿里云提供 |
| **腾讯DNS** | `119.29.29.29` | `182.254.116.116` | 腾讯云提供 |

### 7.2 选择DNS服务器的原则


**选择建议**：
```
国外网站访问多 ➤ 推荐Google DNS (8.8.8.8)
注重隐私保护   ➤ 推荐Cloudflare (1.1.1.1)  
国内访问为主   ➤ 推荐114DNS或阿里DNS
企业内网环境   ➤ 配置内网DNS + 公共DNS备用
```

### 7.3 配置公共DNS


**方法一：直接修改resolv.conf**
```bash
sudo vim /etc/resolv.conf

# 添加以下内容
nameserver 8.8.8.8
nameserver 114.114.114.114
options timeout:1 attempts:2
```

**方法二：通过NetworkManager配置**（推荐）
```bash
# 查看网络连接
nmcli connection show

# 修改DNS设置（以连接名为ethernet为例）
sudo nmcli connection modify ethernet ipv4.dns "8.8.8.8,114.114.114.114"

# 重启网络连接
sudo nmcli connection down ethernet
sudo nmcli connection up ethernet
```

**方法三：通过netplan配置**（Ubuntu 18.04+）
```bash
sudo vim /etc/netplan/01-netcfg.yaml

# 添加DNS配置
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: true
      nameservers:
        addresses: [8.8.8.8, 114.114.114.114]
        
# 应用配置
sudo netplan apply
```

### 7.4 DNS性能测试


**测试DNS响应速度**：
```bash
# 使用dig测试查询时间
dig baidu.com | grep "Query time"

# 测试多个DNS服务器
for dns in 8.8.8.8 114.114.114.114 223.5.5.5; do
    echo "Testing $dns:"
    dig @$dns baidu.com | grep "Query time"
done
```

**专业DNS测试工具**：
```bash
# 安装namebench（需要Python）
pip install namebench

# 运行DNS基准测试
namebench
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 DNS基础：域名到IP地址的转换服务，互联网的"电话簿"
🔸 配置文件：/etc/resolv.conf(DNS服务器)、/etc/hosts(本地映射)
🔸 解析顺序：/etc/nsswitch.conf控制查询顺序，一般是files dns
🔸 诊断工具：nslookup(基础)、dig(专业)、host(简洁)
🔸 缓存机制：提高速度，需要定期清理避免问题
🔸 公共DNS：8.8.8.8、1.1.1.1、114.114.114.114等
```

### 8.2 关键理解要点


**🔹 DNS解析的优先级顺序**
```
本地缓存 ➤ /etc/hosts文件 ➤ DNS服务器查询
(最快)    (本地强制)        (网络查询)
```

**🔹 配置文件的作用关系**
```
/etc/nsswitch.conf  ← 控制解析顺序  
/etc/resolv.conf    ← DNS服务器设置
/etc/hosts          ← 本地域名映射
```

**🔹 故障排查思路**
```
Step 1: 检查网络连通性 (ping IP地址)
Step 2: 检查DNS配置 (cat /etc/resolv.conf)  
Step 3: 测试DNS查询 (dig domain.com)
Step 4: 清理DNS缓存 (flush cache)
Step 5: 检查hosts文件 (grep domain /etc/hosts)
```

### 8.3 实际应用价值


**🎯 开发调试场景**
- **本地开发**：在hosts文件中配置测试域名
- **API测试**：快速切换不同环境的API地址
- **问题排查**：使用dig/nslookup诊断域名解析问题

**🔧 运维管理场景**  
- **服务器配置**：设置可靠的公共DNS服务器
- **内网访问**：配置内网服务器的友好域名
- **性能优化**：选择响应速度最快的DNS服务器

**🛡️ 安全防护场景**
- **广告屏蔽**：在hosts文件中屏蔽广告域名
- **恶意网站防护**：使用带安全过滤的公共DNS
- **内网隔离**：控制内网设备的域名解析范围

### 8.4 常用命令速查


```bash
# 查看当前DNS配置
cat /etc/resolv.conf

# 测试域名解析
dig baidu.com
nslookup baidu.com  
host baidu.com

# 清理DNS缓存
sudo systemd-resolve --flush-caches

# 编辑本地域名映射
sudo vim /etc/hosts

# 测试DNS服务器响应速度  
dig @8.8.8.8 baidu.com | grep "Query time"
```

**核心记忆口诀**：
- DNS解析有顺序，hosts文件排第一
- resolv.conf配服务器，nsswitch控制序
- 问题排查用dig查，缓存清理别忘记
- 公共DNS选得好，上网速度差不了