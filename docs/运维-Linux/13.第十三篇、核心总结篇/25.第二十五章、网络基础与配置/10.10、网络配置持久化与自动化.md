---
title: 10ã€ç½‘ç»œé…ç½®æŒä¹…åŒ–ä¸è‡ªåŠ¨åŒ–
---
## ğŸ“š ç›®å½•

1. [ç½‘ç»œé…ç½®æŒä¹…åŒ–åŸºç¡€](#1-ç½‘ç»œé…ç½®æŒä¹…åŒ–åŸºç¡€)
2. [ç½‘ç»œé…ç½®æ–‡ä»¶ç®¡ç†](#2-ç½‘ç»œé…ç½®æ–‡ä»¶ç®¡ç†)
3. [å¼€æœºç½‘ç»œè‡ªåŠ¨é…ç½®](#3-å¼€æœºç½‘ç»œè‡ªåŠ¨é…ç½®)
4. [ç½‘ç»œæœåŠ¡é‡å¯ä¸reload](#4-ç½‘ç»œæœåŠ¡é‡å¯ä¸reload)
5. [ç½‘ç»œé…ç½®å¤‡ä»½ä¸æ¢å¤](#5-ç½‘ç»œé…ç½®å¤‡ä»½ä¸æ¢å¤)
6. [ç½‘ç»œé…ç½®æ¨¡æ¿åŒ–ç®¡ç†](#6-ç½‘ç»œé…ç½®æ¨¡æ¿åŒ–ç®¡ç†)
7. [æ‰¹é‡ç½‘ç»œé…ç½®ç®¡ç†](#7-æ‰¹é‡ç½‘ç»œé…ç½®ç®¡ç†)
8. [ç½‘ç»œé…ç½®ç‰ˆæœ¬æ§åˆ¶](#8-ç½‘ç»œé…ç½®ç‰ˆæœ¬æ§åˆ¶)
9. [ç½‘ç»œé…ç½®éªŒè¯è„šæœ¬](#9-ç½‘ç»œé…ç½®éªŒè¯è„šæœ¬)
10. [ç½‘ç»œé…ç½®è‡ªåŠ¨åŒ–éƒ¨ç½²](#10-ç½‘ç»œé…ç½®è‡ªåŠ¨åŒ–éƒ¨ç½²)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ ç½‘ç»œé…ç½®æŒä¹…åŒ–åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯ç½‘ç»œé…ç½®æŒä¹…åŒ–


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µç†è§£**

ç½‘ç»œé…ç½®æŒä¹…åŒ–å°±æ˜¯è®©ä½ è®¾ç½®çš„ç½‘ç»œå‚æ•°åœ¨ç³»ç»Ÿé‡å¯åä¾ç„¶ç”Ÿæ•ˆã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯**"ä¸€æ¬¡é…ç½®ï¼Œæ°¸ä¹…æœ‰æ•ˆ"**ã€‚

```
ä¸´æ—¶é…ç½® vs æŒä¹…åŒ–é…ç½®ï¼š

ä¸´æ—¶é…ç½®ï¼ˆé‡å¯å¤±æ•ˆï¼‰ï¼š
ip addr add 192.168.1.100/24 dev eth0  # é‡å¯åæ¶ˆå¤±
route add default gw 192.168.1.1       # é‡å¯åæ¶ˆå¤±

æŒä¹…åŒ–é…ç½®ï¼ˆé‡å¯ä»æœ‰æ•ˆï¼‰ï¼š
å†™å…¥é…ç½®æ–‡ä»¶ â†’ å¼€æœºè‡ªåŠ¨åº”ç”¨ â†’ æ°¸ä¹…ç”Ÿæ•ˆ
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦æŒä¹…åŒ–**

| åœºæ™¯ | ä¸´æ—¶é…ç½®é—®é¢˜ | æŒä¹…åŒ–è§£å†³æ–¹æ¡ˆ |
|------|-------------|---------------|
| **æœåŠ¡å™¨è¿ç»´** | æ¯æ¬¡é‡å¯éƒ½è¦é‡æ–°é…ç½® | è‡ªåŠ¨æ¢å¤ç½‘ç»œè®¾ç½® |
| **æ‰¹é‡éƒ¨ç½²** | æ‰‹åŠ¨é€å°é…ç½®æ•ˆç‡ä½ | æ¨¡æ¿åŒ–æ‰¹é‡åº”ç”¨ |
| **æ•…éšœæ¢å¤** | é…ç½®ä¸¢å¤±éš¾ä»¥å¿«é€Ÿæ¢å¤ | å¤‡ä»½æ–‡ä»¶å¿«é€Ÿè¿˜åŸ |
| **æ ‡å‡†åŒ–ç®¡ç†** | é…ç½®ä¸ä¸€è‡´å®¹æ˜“å‡ºé”™ | ç»Ÿä¸€æ¨¡æ¿ç¡®ä¿ä¸€è‡´æ€§ |

### 1.2 Linuxç½‘ç»œé…ç½®æ¶æ„


**ğŸ—ï¸ é…ç½®å±‚æ¬¡ç»“æ„**
```
åº”ç”¨å±‚é…ç½®
    â†“
ç³»ç»Ÿé…ç½®æ–‡ä»¶ (/etc/network/, /etc/sysconfig/network-scripts/)
    â†“  
ç½‘ç»œç®¡ç†æœåŠ¡ (systemd-networkd, NetworkManager)
    â†“
å†…æ ¸ç½‘ç»œæ ˆ (netlink, ioctl)
    â†“
ç¡¬ä»¶ç½‘ç»œè®¾å¤‡
```

**ğŸ” ä¸åŒå‘è¡Œç‰ˆçš„é…ç½®æ–¹å¼å¯¹æ¯”**

| å‘è¡Œç‰ˆ | é…ç½®æ–¹å¼ | é…ç½®æ–‡ä»¶ä½ç½® | ç®¡ç†å·¥å…· |
|--------|---------|-------------|----------|
| **Ubuntu/Debian** | netplan/interfaces | `/etc/netplan/` | `netplan apply` |
| **CentOS/RHEL** | network-scripts | `/etc/sysconfig/network-scripts/` | `nmcli/ifup` |
| **SUSE** | wicked | `/etc/sysconfig/network/` | `wicked` |
| **Arch Linux** | systemd-networkd | `/etc/systemd/network/` | `networkctl` |

---

## 2. ğŸ“ ç½‘ç»œé…ç½®æ–‡ä»¶ç®¡ç†


### 2.1 Ubuntu/Debiané…ç½®æ–‡ä»¶ç®¡ç†


**ğŸ”¸ Netplané…ç½®æ–¹å¼ï¼ˆUbuntu 18.04+ï¼‰**

Netplanæ˜¯Ubuntuç°ä»£åŒ–çš„ç½‘ç»œé…ç½®å·¥å…·ï¼Œä½¿ç”¨YAMLæ ¼å¼ï¼Œ**ç®€å•ç›´è§‚**ã€‚

åŸºæœ¬é…ç½®æ–‡ä»¶ç»“æ„ï¼š
```yaml
# /etc/netplan/01-network-manager-all.yaml
network:
  version: 2
  renderer: networkd  # æˆ–è€… NetworkManager
  ethernets:
    eth0:
      dhcp4: false
      addresses:
        - 192.168.1.100/24
      gateway4: 192.168.1.1
      nameservers:
        addresses: [8.8.8.8, 1.1.1.1]
```

**ğŸ’¡ é…ç½®æ–‡ä»¶å‘½åè§„åˆ™**
- æ–‡ä»¶åä»¥æ•°å­—å¼€å¤´ï¼ŒæŒ‰**æ•°å­—å¤§å°é¡ºåº**åŠ è½½
- æ¨èå‘½åï¼š`01-network.yaml`ã€`02-wifi.yaml`
- ååŠ è½½çš„é…ç½®ä¼š**è¦†ç›–**å…ˆåŠ è½½çš„è®¾ç½®

**ğŸ”§ å¸¸ç”¨é…ç½®ç¤ºä¾‹**

é™æ€IPé…ç½®ï¼š
```yaml
network:
  version: 2
  ethernets:
    enp0s3:  # ç½‘å¡åç§°ï¼Œç”¨ ip link æŸ¥çœ‹
      addresses: [192.168.1.50/24]
      gateway4: 192.168.1.1
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
        search: [local.domain]
```

DHCPé…ç½®ï¼š
```yaml
network:
  version: 2
  ethernets:
    enp0s3:
      dhcp4: true
      dhcp6: false
```

**âš™ï¸ åº”ç”¨é…ç½®çš„å‘½ä»¤**
```bash
# æµ‹è¯•é…ç½®è¯­æ³•
sudo netplan try

# åº”ç”¨é…ç½®
sudo netplan apply

# æŸ¥çœ‹å½“å‰é…ç½®
netplan get
```

### 2.2 ä¼ ç»Ÿinterfacesæ–‡ä»¶é…ç½®


**ğŸ”¸ /etc/network/interfacesæ ¼å¼**

å¯¹äºè¾ƒè€çš„Debianç³»ç»Ÿæˆ–éœ€è¦ç²¾ç»†æ§åˆ¶çš„åœºæ™¯ï¼Œä»å¯ä½¿ç”¨ä¼ ç»Ÿinterfacesæ–‡ä»¶ï¼š

```bash
# /etc/network/interfaces
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    gateway 192.168.1.1
    dns-nameservers 8.8.8.8 8.8.4.4
    dns-search example.com
```

**ğŸ”§ é«˜çº§é…ç½®é€‰é¡¹**
```bash
# ç½‘å¡ç»‘å®šé…ç½®
auto bond0
iface bond0 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    bond-slaves eth0 eth1
    bond-mode active-backup
    bond-primary eth0

# VLANé…ç½®
auto eth0.100
iface eth0.100 inet static
    address 10.0.100.1
    netmask 255.255.255.0
    vlan-raw-device eth0
```

### 2.3 CentOS/RHELé…ç½®æ–‡ä»¶ç®¡ç†


**ğŸ”¸ network-scriptsé…ç½®æ–¹å¼**

CentOSä½¿ç”¨ä¼ ç»Ÿçš„network-scriptsæ–¹å¼ï¼Œæ¯ä¸ªç½‘å¡å¯¹åº”ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼š

```bash
# /etc/sysconfig/network-scripts/ifcfg-eth0
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=static         # static/dhcp/none
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
NAME=eth0
UUID=12345678-1234-1234-1234-123456789012
DEVICE=eth0
ONBOOT=yes              # å¼€æœºå¯åŠ¨
IPADDR=192.168.1.100    # IPåœ°å€
PREFIX=24               # å­ç½‘æ©ç é•¿åº¦
GATEWAY=192.168.1.1     # ç½‘å…³
DNS1=8.8.8.8           # ä¸»DNS
DNS2=8.8.4.4           # å¤‡DNS
```

**ğŸ“ å…³é”®å‚æ•°è¯´æ˜**

| å‚æ•° | è¯´æ˜ | å¸¸ç”¨å€¼ |
|------|------|--------|
| `BOOTPROTO` | è·å–IPæ–¹å¼ | `static`, `dhcp`, `none` |
| `ONBOOT` | å¼€æœºå¯åŠ¨ | `yes`, `no` |
| `DEFROUTE` | é»˜è®¤è·¯ç”± | `yes`, `no` |
| `IPV6INIT` | IPv6æ”¯æŒ | `yes`, `no` |
| `PEERDNS` | ä½¿ç”¨DHCPçš„DNS | `yes`, `no` |

### 2.4 é…ç½®æ–‡ä»¶æƒé™ä¸å®‰å…¨


**ğŸ”’ é…ç½®æ–‡ä»¶æƒé™è®¾ç½®**

æ­£ç¡®çš„æƒé™è®¾ç½®ç¡®ä¿ç³»ç»Ÿå®‰å…¨ï¼š

```bash
# è®¾ç½®åˆé€‚çš„æƒé™
sudo chmod 644 /etc/netplan/*.yaml
sudo chown root:root /etc/netplan/*.yaml

# CentOSç½‘ç»œé…ç½®æ–‡ä»¶æƒé™
sudo chmod 644 /etc/sysconfig/network-scripts/ifcfg-*
sudo chown root:root /etc/sysconfig/network-scripts/ifcfg-*
```

**âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹**
- é…ç½®æ–‡ä»¶ä¸åº”åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚WiFiå¯†ç æ˜æ–‡ï¼‰
- å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶åˆ°å®‰å…¨ä½ç½®
- ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶è·Ÿè¸ªé…ç½®å˜æ›´

---

## 3. ğŸš€ å¼€æœºç½‘ç»œè‡ªåŠ¨é…ç½®


### 3.1 systemdç½‘ç»œæœåŠ¡ç®¡ç†


**ğŸ”¸ ç†è§£systemdç½‘ç»œæœåŠ¡**

ç°ä»£Linuxç³»ç»Ÿä½¿ç”¨systemdç®¡ç†ç½‘ç»œæœåŠ¡ï¼Œä¸»è¦åŒ…æ‹¬ï¼š
- `systemd-networkd`ï¼šsystemdåŸç”Ÿç½‘ç»œç®¡ç†
- `NetworkManager`ï¼šå›¾å½¢åŒ–ç½‘ç»œç®¡ç†å™¨  
- `networking`ï¼šä¼ ç»Ÿçš„ç½‘ç»œåˆå§‹åŒ–æœåŠ¡

**ğŸ“Š æœåŠ¡å¯¹æ¯”åˆ†æ**

| æœåŠ¡ | é€‚ç”¨åœºæ™¯ | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|------|----------|------|------|
| `systemd-networkd` | æœåŠ¡å™¨ç¯å¢ƒ | è½»é‡ã€ç¨³å®š | é…ç½®å¤æ‚ |
| `NetworkManager` | æ¡Œé¢ç¯å¢ƒ | æ˜“ç”¨ã€åŠŸèƒ½ä¸°å¯Œ | èµ„æºå ç”¨å¤§ |
| `networking` | ä¼ ç»Ÿç³»ç»Ÿ | ç®€å•å¯é  | åŠŸèƒ½æœ‰é™ |

### 3.2 é…ç½®å¼€æœºç½‘ç»œè‡ªå¯åŠ¨


**âš™ï¸ systemd-networkdé…ç½®**

å¯ç”¨systemd-networkdæœåŠ¡ï¼š
```bash
# å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
sudo systemctl enable systemd-networkd
sudo systemctl start systemd-networkd

# å¯ç”¨DNSè§£ææœåŠ¡
sudo systemctl enable systemd-resolved
sudo systemctl start systemd-resolved

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status systemd-networkd
```

**ğŸ”§ ç½‘ç»œé…ç½®æ–‡ä»¶ç¤ºä¾‹**
```ini
# /etc/systemd/network/20-wired.network
[Match]
Name=eth0

[Network]
DHCP=ipv4
DNS=8.8.8.8
DNS=1.1.1.1

[DHCP]
UseDomains=true
```

**ğŸ’¡ NetworkManageræ–¹å¼**
```bash
# Ubuntué»˜è®¤ä½¿ç”¨NetworkManager
sudo systemctl enable NetworkManager
sudo systemctl start NetworkManager

# æŸ¥çœ‹è¿æ¥çŠ¶æ€
nmcli connection show
nmcli device status
```

### 3.3 ç½‘ç»œé…ç½®å¯åŠ¨é¡ºåº


**ğŸ”„ å¯åŠ¨æµç¨‹ç†è§£**

```
ç³»ç»Ÿå¯åŠ¨
    â†“
systemdåˆå§‹åŒ–
    â†“
ç½‘ç»œæœåŠ¡å¯åŠ¨ (networking.service / NetworkManager.service)
    â†“
è¯»å–é…ç½®æ–‡ä»¶
    â†“
é…ç½®ç½‘ç»œæ¥å£
    â†“
å¯åŠ¨ç½‘ç»œç›¸å…³æœåŠ¡ (SSH, HTTPç­‰)
```

**âš™ï¸ æ§åˆ¶å¯åŠ¨é¡ºåº**

ç¡®ä¿ç½‘ç»œåœ¨å…¶ä»–æœåŠ¡ä¹‹å‰å¯åŠ¨ï¼š
```ini
# /etc/systemd/system/my-service.service
[Unit]
Description=My Network Service
After=network.target network-online.target
Wants=network-online.target

[Service]
ExecStart=/usr/local/bin/my-service

[Install]
WantedBy=multi-user.target
```

### 3.4 å¼€æœºç½‘ç»œæ£€æŸ¥è„šæœ¬


**ğŸ” åˆ›å»ºç½‘ç»œæ£€æŸ¥è„šæœ¬**

è‡ªåŠ¨æ£€æŸ¥ç½‘ç»œé…ç½®æ˜¯å¦æ­£ç¡®åº”ç”¨ï¼š

```bash
#!/bin/bash
# /usr/local/bin/network-check.sh

LOG_FILE="/var/log/network-startup.log"

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

check_interface() {
    local interface=$1
    local expected_ip=$2
    
    current_ip=$(ip addr show "$interface" | grep 'inet ' | awk '{print $2}' | cut -d/ -f1)
    
    if [[ "$current_ip" == "$expected_ip" ]]; then
        log_message "âœ“ Interface $interface has correct IP: $current_ip"
        return 0
    else
        log_message "âœ— Interface $interface IP mismatch. Expected: $expected_ip, Got: $current_ip"
        return 1
    fi
}

# ä¸»æ£€æŸ¥é€»è¾‘
log_message "Starting network configuration check"

# æ£€æŸ¥ç½‘ç»œæ¥å£
check_interface "eth0" "192.168.1.100"

# æ£€æŸ¥ç½‘å…³è¿é€šæ€§
if ping -c 1 -W 5 192.168.1.1 >/dev/null 2>&1; then
    log_message "âœ“ Gateway 192.168.1.1 is reachable"
else
    log_message "âœ— Gateway 192.168.1.1 is not reachable"
fi

# æ£€æŸ¥DNSè§£æ
if nslookup google.com >/dev/null 2>&1; then
    log_message "âœ“ DNS resolution is working"
else
    log_message "âœ— DNS resolution failed"
fi

log_message "Network check completed"
```

åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶ï¼š
```ini
# /etc/systemd/system/network-check.service
[Unit]
Description=Network Configuration Check
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/network-check.sh
User=root

[Install]
WantedBy=multi-user.target
```

---

## 4. ğŸ”„ ç½‘ç»œæœåŠ¡é‡å¯ä¸reload


### 4.1 ç†è§£é‡å¯ä¸reloadçš„åŒºåˆ«


**ğŸ”¸ æ¦‚å¿µå¯¹æ¯”**

| æ“ä½œ | å½±å“èŒƒå›´ | ä¸­æ–­æ—¶é—´ | é€‚ç”¨åœºæ™¯ |
|------|----------|----------|----------|
| **restart** | å®Œå…¨é‡å¯æœåŠ¡ | è¾ƒé•¿ï¼ˆå‡ ç§’ï¼‰ | é‡å¤§é…ç½®å˜æ›´ |
| **reload** | é‡è½½é…ç½®æ–‡ä»¶ | å¾ˆçŸ­ï¼ˆæ¯«ç§’çº§ï¼‰ | è½»å¾®é…ç½®è°ƒæ•´ |
| **try-restart** | ä»…åœ¨è¿è¡Œæ—¶é‡å¯ | è¾ƒé•¿ | å®‰å…¨é‡å¯ |
| **force-reload** | å¼ºåˆ¶é‡è½½æˆ–é‡å¯ | è§†æƒ…å†µè€Œå®š | ç¡®ä¿ç”Ÿæ•ˆ |

### 4.2 ä¸åŒç³»ç»Ÿçš„ç½‘ç»œæœåŠ¡æ“ä½œ


**âš™ï¸ Ubuntu/Debianç³»ç»Ÿ**

Netplanæ–¹å¼ï¼š
```bash
# åº”ç”¨æ–°é…ç½®ï¼ˆæ¨èï¼‰
sudo netplan apply

# æµ‹è¯•é…ç½®ï¼ˆå®‰å…¨ï¼‰
sudo netplan try  # ä¼šè‡ªåŠ¨å›æ»šæ— æ•ˆé…ç½®

# ä¼ ç»Ÿinterfacesæ–¹å¼
sudo systemctl restart networking
sudo systemctl reload networking  # å¦‚æœæ”¯æŒ
```

**ğŸ”§ CentOS/RHELç³»ç»Ÿ**
```bash
# NetworkManageræ–¹å¼ï¼ˆCentOS 7+ï¼‰
sudo systemctl restart NetworkManager
sudo nmcli connection reload

# ä¼ ç»ŸnetworkæœåŠ¡æ–¹å¼
sudo systemctl restart network

# å•ä¸ªæ¥å£é‡å¯
sudo ifdown eth0 && sudo ifup eth0
```

### 4.3 æ— ä¸­æ–­ç½‘ç»œé…ç½®æ›´æ–°


**ğŸ’¡ å®ç°é›¶ä¸­æ–­é…ç½®æ›´æ–°**

ä½¿ç”¨ç½‘ç»œå‘½åç©ºé—´å’Œä¸´æ—¶æ¥å£ï¼š
```bash
#!/bin/bash
# å®‰å…¨çš„ç½‘ç»œé…ç½®æ›´æ–°è„šæœ¬

INTERFACE="eth0"
CONFIG_FILE="/etc/netplan/01-network.yaml"

# å¤‡ä»½å½“å‰é…ç½®
backup_config() {
    cp "$CONFIG_FILE" "$CONFIG_FILE.backup.$(date +%s)"
    echo "é…ç½®å·²å¤‡ä»½"
}

# éªŒè¯æ–°é…ç½®
test_config() {
    echo "æµ‹è¯•æ–°é…ç½®..."
    if sudo netplan try --timeout=30; then
        echo "æ–°é…ç½®éªŒè¯æˆåŠŸ"
        return 0
    else
        echo "æ–°é…ç½®éªŒè¯å¤±è´¥ï¼Œè‡ªåŠ¨å›æ»š"
        return 1
    fi
}

# åº”ç”¨é…ç½®
apply_config() {
    echo "åº”ç”¨ç½‘ç»œé…ç½®..."
    sudo netplan apply
    
    # ç­‰å¾…ç½‘ç»œç¨³å®š
    sleep 3
    
    # éªŒè¯ç½‘ç»œè¿é€šæ€§
    if ping -c 3 -W 5 8.8.8.8 >/dev/null 2>&1; then
        echo "ç½‘ç»œè¿é€šæ€§éªŒè¯æˆåŠŸ"
        return 0
    else
        echo "ç½‘ç»œè¿é€šæ€§éªŒè¯å¤±è´¥"
        return 1
    fi
}

# ä¸»æµç¨‹
main() {
    backup_config
    
    if test_config && apply_config; then
        echo "ç½‘ç»œé…ç½®æ›´æ–°æˆåŠŸ"
        # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
        find "$(dirname "$CONFIG_FILE")" -name "$(basename "$CONFIG_FILE").backup.*" -type f | sort | head -n -5 | xargs rm -f
    else
        echo "ç½‘ç»œé…ç½®æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
        exit 1
    fi
}

main "$@"
```

### 4.4 æ‰¹é‡æœåŠ¡é‡å¯è„šæœ¬


**ğŸ”§ æœåŠ¡å™¨æ‰¹é‡ç½‘ç»œé‡å¯**

ç”¨äºå¤šå°æœåŠ¡å™¨çš„ç½‘ç»œé…ç½®åŒæ­¥æ›´æ–°ï¼š
```bash
#!/bin/bash
# æ‰¹é‡ç½‘ç»œæœåŠ¡é‡å¯è„šæœ¬

SERVERS_FILE="/etc/ansible/hosts"  # æˆ–å…¶ä»–æœåŠ¡å™¨åˆ—è¡¨æ–‡ä»¶
SSH_KEY="/root/.ssh/id_rsa"

# è¯»å–æœåŠ¡å™¨åˆ—è¡¨
readarray -t servers < <(grep -v '^#' "$SERVERS_FILE" | grep -v '^$')

restart_network_service() {
    local server=$1
    
    echo "æ­£åœ¨é‡å¯ $server çš„ç½‘ç»œæœåŠ¡..."
    
    # æ‰§è¡Œè¿œç¨‹å‘½ä»¤
    if ssh -i "$SSH_KEY" -o ConnectTimeout=10 root@"$server" '
        # æ£€æµ‹ç³»ç»Ÿç±»å‹å¹¶æ‰§è¡Œç›¸åº”å‘½ä»¤
        if command -v netplan >/dev/null 2>&1; then
            netplan apply
        elif systemctl is-active NetworkManager >/dev/null 2>&1; then
            systemctl restart NetworkManager
        else
            systemctl restart networking
        fi
        
        # éªŒè¯ç½‘ç»œè¿é€šæ€§
        ping -c 1 -W 5 8.8.8.8 >/dev/null 2>&1
    '; then
        echo "âœ“ $server ç½‘ç»œæœåŠ¡é‡å¯æˆåŠŸ"
        return 0
    else
        echo "âœ— $server ç½‘ç»œæœåŠ¡é‡å¯å¤±è´¥"
        return 1
    fi
}

# å¹¶è¡Œå¤„ç†æœåŠ¡å™¨
for server in "${servers[@]}"; do
    restart_network_service "$server" &
done

# ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡å®Œæˆ
wait
echo "æ‰¹é‡ç½‘ç»œæœåŠ¡é‡å¯å®Œæˆ"
```

---

## 5. ğŸ’¾ ç½‘ç»œé…ç½®å¤‡ä»½ä¸æ¢å¤


### 5.1 ç½‘ç»œé…ç½®å¤‡ä»½ç­–ç•¥


**ğŸ”¸ å¤‡ä»½å†…å®¹æ¸…å•**

å®Œæ•´çš„ç½‘ç»œé…ç½®å¤‡ä»½åº”åŒ…æ‹¬ï¼š
- ç½‘ç»œé…ç½®æ–‡ä»¶
- è·¯ç”±è¡¨ä¿¡æ¯  
- é˜²ç«å¢™è§„åˆ™
- DNSé…ç½®
- ä¸»æœºåé…ç½®
- ç½‘ç»œæœåŠ¡é…ç½®

**ğŸ“‹ å¤‡ä»½æ–‡ä»¶æ¸…å•**

| ç³»ç»Ÿ | ä¸»è¦é…ç½®æ–‡ä»¶ |
|------|-------------|
| **é€šç”¨** | `/etc/hosts`, `/etc/hostname`, `/etc/resolv.conf` |
| **Ubuntu** | `/etc/netplan/`, `/etc/network/interfaces` |
| **CentOS** | `/etc/sysconfig/network-scripts/`, `/etc/sysconfig/network` |
| **è·¯ç”±è¡¨** | `ip route show` è¾“å‡º |
| **é˜²ç«å¢™** | `iptables-save` è¾“å‡º |

### 5.2 è‡ªåŠ¨å¤‡ä»½è„šæœ¬


**ğŸ”§ åˆ›å»ºå…¨é¢å¤‡ä»½è„šæœ¬**

```bash
#!/bin/bash
# /usr/local/bin/network-backup.sh

BACKUP_DIR="/var/backups/network"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/network-config-$DATE.tar.gz"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# ä¸´æ—¶å·¥ä½œç›®å½•
TEMP_DIR=$(mktemp -d)
WORK_DIR="$TEMP_DIR/network-config-$DATE"
mkdir -p "$WORK_DIR"

backup_files() {
    echo "å¤‡ä»½é…ç½®æ–‡ä»¶..."
    
    # é€šç”¨é…ç½®æ–‡ä»¶
    [[ -f /etc/hosts ]] && cp /etc/hosts "$WORK_DIR/"
    [[ -f /etc/hostname ]] && cp /etc/hostname "$WORK_DIR/"
    [[ -f /etc/resolv.conf ]] && cp /etc/resolv.conf "$WORK_DIR/"
    
    # æ ¹æ®ç³»ç»Ÿç±»å‹å¤‡ä»½ç‰¹å®šæ–‡ä»¶
    if [[ -d /etc/netplan ]]; then
        # Ubuntu/Netplan
        cp -r /etc/netplan "$WORK_DIR/"
    fi
    
    if [[ -d /etc/network ]]; then
        # Debian/interfaces
        cp -r /etc/network "$WORK_DIR/"
    fi
    
    if [[ -d /etc/sysconfig/network-scripts ]]; then
        # CentOS/RHEL
        cp -r /etc/sysconfig/network-scripts "$WORK_DIR/"
        [[ -f /etc/sysconfig/network ]] && cp /etc/sysconfig/network "$WORK_DIR/"
    fi
}

backup_runtime_info() {
    echo "å¤‡ä»½è¿è¡Œæ—¶ç½‘ç»œä¿¡æ¯..."
    
    # ç½‘ç»œæ¥å£ä¿¡æ¯
    ip addr show > "$WORK_DIR/ip-addr.txt"
    ip link show > "$WORK_DIR/ip-link.txt"
    
    # è·¯ç”±è¡¨
    ip route show > "$WORK_DIR/routes.txt"
    ip route show table all > "$WORK_DIR/routes-all.txt"
    
    # é˜²ç«å¢™è§„åˆ™
    if command -v iptables >/dev/null 2>&1; then
        iptables-save > "$WORK_DIR/iptables.rules"
    fi
    
    # ç½‘ç»œè¿æ¥çŠ¶æ€
    ss -tuln > "$WORK_DIR/network-connections.txt"
    
    # ç³»ç»Ÿç½‘ç»œé…ç½®
    sysctl -a | grep net > "$WORK_DIR/sysctl-net.txt"
}

create_restore_script() {
    cat > "$WORK_DIR/restore.sh" << 'EOF'
#!/bin/bash
# ç½‘ç»œé…ç½®æ¢å¤è„šæœ¬

RESTORE_DIR="$(dirname "$0")"

echo "å¼€å§‹æ¢å¤ç½‘ç»œé…ç½®..."

# æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·
if [[ $EUID -ne 0 ]]; then
    echo "è¯·ä½¿ç”¨rootæƒé™è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# å¤‡ä»½å½“å‰é…ç½®
echo "å¤‡ä»½å½“å‰é…ç½®..."
cp -r /etc/netplan /etc/netplan.backup.$(date +%s) 2>/dev/null || true
cp -r /etc/network /etc/network.backup.$(date +%s) 2>/dev/null || true

# æ¢å¤é…ç½®æ–‡ä»¶
echo "æ¢å¤é…ç½®æ–‡ä»¶..."
[[ -f "$RESTORE_DIR/hosts" ]] && cp "$RESTORE_DIR/hosts" /etc/
[[ -f "$RESTORE_DIR/hostname" ]] && cp "$RESTORE_DIR/hostname" /etc/
[[ -d "$RESTORE_DIR/netplan" ]] && cp -r "$RESTORE_DIR/netplan"/* /etc/netplan/

# æ¢å¤è·¯ç”±è¡¨
if [[ -f "$RESTORE_DIR/routes.txt" ]]; then
    echo "æ¢å¤è·¯ç”±è¡¨..."
    while read -r route; do
        [[ -n "$route" ]] && ip route add $route 2>/dev/null || true
    done < "$RESTORE_DIR/routes.txt"
fi

# åº”ç”¨ç½‘ç»œé…ç½®
if command -v netplan >/dev/null 2>&1; then
    netplan apply
elif systemctl is-active NetworkManager >/dev/null 2>&1; then
    systemctl restart NetworkManager
else
    systemctl restart networking
fi

echo "ç½‘ç»œé…ç½®æ¢å¤å®Œæˆ"
EOF
    chmod +x "$WORK_DIR/restore.sh"
}

# æ‰§è¡Œå¤‡ä»½
echo "å¼€å§‹ç½‘ç»œé…ç½®å¤‡ä»½..."
backup_files
backup_runtime_info
create_restore_script

# åˆ›å»ºå‹ç¼©åŒ…
echo "åˆ›å»ºå¤‡ä»½æ–‡ä»¶..."
tar -czf "$BACKUP_FILE" -C "$TEMP_DIR" "network-config-$DATE"

# æ¸…ç†ä¸´æ—¶ç›®å½•
rm -rf "$TEMP_DIR"

# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘10ä¸ªï¼‰
find "$BACKUP_DIR" -name "network-config-*.tar.gz" -type f | sort | head -n -10 | xargs rm -f

echo "å¤‡ä»½å®Œæˆ: $BACKUP_FILE"
ls -lh "$BACKUP_FILE"
```

### 5.3 å¿«é€Ÿæ¢å¤æœºåˆ¶


**âš¡ ä¸€é”®æ¢å¤è„šæœ¬**

```bash
#!/bin/bash
# /usr/local/bin/network-restore.sh

BACKUP_DIR="/var/backups/network"

list_backups() {
    echo "å¯ç”¨çš„ç½‘ç»œé…ç½®å¤‡ä»½ï¼š"
    ls -lt "$BACKUP_DIR"/network-config-*.tar.gz | head -10 | nl
}

restore_from_backup() {
    local backup_file=$1
    
    if [[ ! -f "$backup_file" ]]; then
        echo "å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: $backup_file"
        return 1
    fi
    
    echo "ä»å¤‡ä»½æ¢å¤: $(basename "$backup_file")"
    
    # è§£å‹åˆ°ä¸´æ—¶ç›®å½•
    local temp_dir=$(mktemp -d)
    tar -xzf "$backup_file" -C "$temp_dir"
    
    # æ‰§è¡Œæ¢å¤è„šæœ¬
    local restore_script=$(find "$temp_dir" -name "restore.sh" -type f)
    if [[ -f "$restore_script" ]]; then
        bash "$restore_script"
    else
        echo "æœªæ‰¾åˆ°æ¢å¤è„šæœ¬"
        return 1
    fi
    
    # æ¸…ç†ä¸´æ—¶ç›®å½•
    rm -rf "$temp_dir"
    
    echo "æ¢å¤å®Œæˆ"
}

# ä¸»é€»è¾‘
case "${1:-list}" in
    "list")
        list_backups
        ;;
    "restore")
        if [[ -n "$2" ]]; then
            if [[ "$2" =~ ^[0-9]+$ ]]; then
                # æŒ‰åºå·é€‰æ‹©
                backup_file=$(ls -t "$BACKUP_DIR"/network-config-*.tar.gz | sed -n "${2}p")
            else
                # ç›´æ¥æŒ‡å®šæ–‡ä»¶
                backup_file="$2"
            fi
            restore_from_backup "$backup_file"
        else
            echo "è¯·æŒ‡å®šè¦æ¢å¤çš„å¤‡ä»½æ–‡ä»¶æˆ–åºå·"
            list_backups
        fi
        ;;
    *)
        echo "ç”¨æ³•: $0 {list|restore} [backup_number|backup_file]"
        echo "ç¤ºä¾‹: $0 restore 1"
        ;;
esac
```

### 5.4 å®šæ—¶å¤‡ä»½é…ç½®


**â° crontabå®šæ—¶å¤‡ä»½**

```bash
# æ·»åŠ åˆ°rootçš„crontab
# crontab -e

# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ç½‘ç»œé…ç½®
0 2 * * * /usr/local/bin/network-backup.sh >/dev/null 2>&1

# æ¯å‘¨æ—¥æ¸…ç†è¶…è¿‡30å¤©çš„å¤‡ä»½
0 3 * * 0 find /var/backups/network -name "network-config-*.tar.gz" -mtime +30 -delete
```

---

## 6. ğŸ“„ ç½‘ç»œé…ç½®æ¨¡æ¿åŒ–ç®¡ç†


### 6.1 æ¨¡æ¿åŒ–ç®¡ç†çš„ä¼˜åŠ¿


**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦æ¨¡æ¿åŒ–**

æ¨¡æ¿åŒ–ç®¡ç†è§£å†³äº†å¤§è§„æ¨¡éƒ¨ç½²ä¸­çš„é…ç½®ä¸€è‡´æ€§é—®é¢˜ï¼š

```
ä¼ ç»Ÿæ–¹å¼é—®é¢˜ï¼š
- æ¯å°æœåŠ¡å™¨æ‰‹åŠ¨é…ç½® â†’ è€—æ—¶ä¸”æ˜“å‡ºé”™
- é…ç½®ä¸ä¸€è‡´ â†’ æ•…éšœæ’æŸ¥å›°éš¾  
- æ ‡å‡†åŒ–ç¨‹åº¦ä½ â†’ ç»´æŠ¤æˆæœ¬é«˜

æ¨¡æ¿åŒ–ä¼˜åŠ¿ï¼š
- ç»Ÿä¸€é…ç½®æ ‡å‡† â†’ å‡å°‘äººä¸ºé”™è¯¯
- æ‰¹é‡å¿«é€Ÿéƒ¨ç½² â†’ æé«˜æ•ˆç‡
- ç‰ˆæœ¬åŒ–ç®¡ç† â†’ ä¾¿äºå›æ»šå’Œå®¡è®¡
```

### 6.2 åˆ›å»ºç½‘ç»œé…ç½®æ¨¡æ¿


**ğŸ”§ Netplanæ¨¡æ¿ç¤ºä¾‹**

åˆ›å»ºå‚æ•°åŒ–çš„ç½‘ç»œé…ç½®æ¨¡æ¿ï¼š

```yaml
# /etc/network-templates/netplan-template.yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    {{INTERFACE_NAME}}:
      addresses:
        - {{IP_ADDRESS}}/{{NETMASK}}
      gateway4: {{GATEWAY}}
      nameservers:
        addresses: {{DNS_SERVERS}}
        search: {{DNS_SEARCH_DOMAINS}}
      {% if STATIC_ROUTES %}
      routes:
        {% for route in STATIC_ROUTES %}
        - to: {{route.to}}
          via: {{route.via}}
        {% endfor %}
      {% endif %}
```

**ğŸ“‹ æ¨¡æ¿å‚æ•°é…ç½®æ–‡ä»¶**

```bash
# /etc/network-templates/server-configs/web01.conf
INTERFACE_NAME=eth0
IP_ADDRESS=192.168.1.10
NETMASK=24
GATEWAY=192.168.1.1
DNS_SERVERS=[8.8.8.8, 1.1.1.1]
DNS_SEARCH_DOMAINS=[company.local]
STATIC_ROUTES=[]

# /etc/network-templates/server-configs/db01.conf  
INTERFACE_NAME=eth0
IP_ADDRESS=192.168.1.20
NETMASK=24
GATEWAY=192.168.1.1
DNS_SERVERS=[192.168.1.2, 8.8.8.8]
DNS_SEARCH_DOMAINS=[company.local, db.local]
```

### 6.3 æ¨¡æ¿å¤„ç†è„šæœ¬


**âš™ï¸ æ¨¡æ¿ç”Ÿæˆå·¥å…·**

```bash
#!/bin/bash
# /usr/local/bin/generate-network-config.sh

TEMPLATE_DIR="/etc/network-templates"
OUTPUT_DIR="/etc/netplan"

generate_config() {
    local server_name=$1
    local config_file="$TEMPLATE_DIR/server-configs/$server_name.conf"
    local template_file="$TEMPLATE_DIR/netplan-template.yaml"
    local output_file="$OUTPUT_DIR/01-netcfg.yaml"
    
    if [[ ! -f "$config_file" ]]; then
        echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $config_file"
        return 1
    fi
    
    if [[ ! -f "$template_file" ]]; then
        echo "æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨: $template_file"
        return 1
    fi
    
    echo "ä¸ºæœåŠ¡å™¨ $server_name ç”Ÿæˆç½‘ç»œé…ç½®..."
    
    # åŠ è½½é…ç½®å˜é‡
    source "$config_file"
    
    # ä½¿ç”¨envsubstæ›¿æ¢æ¨¡æ¿å˜é‡
    envsubst < "$template_file" > "$output_file"
    
    echo "é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ: $output_file"
    
    # éªŒè¯YAMLè¯­æ³•
    if command -v yamllint >/dev/null 2>&1; then
        if yamllint "$output_file" >/dev/null 2>&1; then
            echo "âœ“ YAMLè¯­æ³•æ£€æŸ¥é€šè¿‡"
        else
            echo "âœ— YAMLè¯­æ³•é”™è¯¯"
            return 1
        fi
    fi
    
    return 0
}

apply_config() {
    echo "åº”ç”¨ç½‘ç»œé…ç½®..."
    if netplan try --timeout=30; then
        echo "é…ç½®åº”ç”¨æˆåŠŸ"
        return 0
    else
        echo "é…ç½®åº”ç”¨å¤±è´¥"
        return 1
    fi
}

# ä¸»é€»è¾‘
case "${1:-help}" in
    "generate")
        if [[ -n "$2" ]]; then
            generate_config "$2"
        else
            echo "è¯·æŒ‡å®šæœåŠ¡å™¨åç§°"
            echo "å¯ç”¨é…ç½®:"
            ls "$TEMPLATE_DIR/server-configs/"*.conf 2>/dev/null | xargs -n1 basename | sed 's/.conf$//'
        fi
        ;;
    "apply")
        if [[ -n "$2" ]]; then
            generate_config "$2" && apply_config
        else
            echo "è¯·æŒ‡å®šæœåŠ¡å™¨åç§°"
        fi
        ;;
    "list")
        echo "å¯ç”¨çš„æœåŠ¡å™¨é…ç½®æ¨¡æ¿:"
        ls "$TEMPLATE_DIR/server-configs/"*.conf 2>/dev/null | xargs -n1 basename | sed 's/.conf$//' | nl
        ;;
    *)
        echo "ç”¨æ³•: $0 {generate|apply|list} [server_name]"
        echo ""
        echo "å‘½ä»¤è¯´æ˜:"
        echo "  generate <server> - ç”ŸæˆæŒ‡å®šæœåŠ¡å™¨çš„ç½‘ç»œé…ç½®"
        echo "  apply <server>    - ç”Ÿæˆå¹¶åº”ç”¨ç½‘ç»œé…ç½®"
        echo "  list              - åˆ—å‡ºå¯ç”¨çš„æœåŠ¡å™¨é…ç½®æ¨¡æ¿"
        ;;
esac
```

### 6.4 é«˜çº§æ¨¡æ¿ç‰¹æ€§


**ğŸ”§ æ¡ä»¶é…ç½®å’Œå¾ªç¯**

ä½¿ç”¨æ›´å¼ºå¤§çš„æ¨¡æ¿å¼•æ“ï¼ˆå¦‚Jinja2ï¼‰å¤„ç†å¤æ‚åœºæ™¯ï¼š

```python
#!/usr/bin/env python3
# /usr/local/bin/advanced-network-template.py

import yaml
import json
from jinja2 import Template
import sys
import argparse

def load_config(config_file):
    """åŠ è½½æœåŠ¡å™¨é…ç½®"""
    with open(config_file, 'r') as f:
        if config_file.endswith('.json'):
            return json.load(f)
        else:
            return yaml.safe_load(f)

def generate_config(template_file, config_data, output_file):
    """ç”Ÿæˆç½‘ç»œé…ç½®"""
    with open(template_file, 'r') as f:
        template_content = f.read()
    
    template = Template(template_content)
    result = template.render(**config_data)
    
    with open(output_file, 'w') as f:
        f.write(result)
    
    print(f"é…ç½®å·²ç”Ÿæˆ: {output_file}")

def main():
    parser = argparse.ArgumentParser(description='é«˜çº§ç½‘ç»œé…ç½®æ¨¡æ¿ç”Ÿæˆå™¨')
    parser.add_argument('--template', required=True, help='æ¨¡æ¿æ–‡ä»¶è·¯å¾„')
    parser.add_argument('--config', required=True, help='é…ç½®æ–‡ä»¶è·¯å¾„')  
    parser.add_argument('--output', required=True, help='è¾“å‡ºæ–‡ä»¶è·¯å¾„')
    
    args = parser.parse_args()
    
    try:
        config_data = load_config(args.config)
        generate_config(args.template, config_data, args.output)
    except Exception as e:
        print(f"é”™è¯¯: {e}")
        sys.exit(1)

if __name__ == '__main__':
    main()
```

**ğŸ“„ å¤æ‚æ¨¡æ¿ç¤ºä¾‹**

```yaml
# /etc/network-templates/advanced-netplan.yaml.j2
network:
  version: 2
  renderer: {{ renderer | default('networkd') }}
  
  {% if ethernets %}
  ethernets:
    {% for interface in ethernets %}
    {{ interface.name }}:
      {% if interface.dhcp4 %}
      dhcp4: true
      {% else %}
      addresses:
        {% for addr in interface.addresses %}
        - {{ addr }}
        {% endfor %}
      {% if interface.gateway4 %}
      gateway4: {{ interface.gateway4 }}
      {% endif %}
      {% endif %}
      
      {% if interface.nameservers %}
      nameservers:
        addresses: {{ interface.nameservers.addresses }}
        {% if interface.nameservers.search %}
        search: {{ interface.nameservers.search }}
        {% endif %}
      {% endif %}
      
      {% if interface.routes %}
      routes:
        {% for route in interface.routes %}
        - to: {{ route.to }}
          via: {{ route.via }}
          {% if route.metric %}
          metric: {{ route.metric }}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endfor %}
  {% endif %}
  
  {% if bonds %}
  bonds:
    {% for bond in bonds %}
    {{ bond.name }}:
      interfaces: {{ bond.interfaces }}
      parameters:
        mode: {{ bond.mode | default('active-backup') }}
        primary: {{ bond.primary | default(bond.interfaces[0]) }}
      addresses:
        {% for addr in bond.addresses %}
        - {{ addr }}
        {% endfor %}
      gateway4: {{ bond.gateway4 }}
    {% endfor %}
  {% endif %}
```

---

## 7. ğŸ¢ æ‰¹é‡ç½‘ç»œé…ç½®ç®¡ç†


### 7.1 æ‰¹é‡ç®¡ç†æ¶æ„è®¾è®¡


**ğŸ—ï¸ æ‰¹é‡ç®¡ç†ç³»ç»Ÿæ¶æ„**

```
ç®¡ç†æ§åˆ¶å° (Management Console)
           â†“
é…ç½®ç®¡ç†ç³»ç»Ÿ (Ansible/Salt/Puppet)
           â†“
ç½‘ç»œé…ç½®æ¨¡æ¿åº“ (Template Repository) 
           â†“
ç›®æ ‡æœåŠ¡å™¨ç¾¤ç»„ (Target Server Groups)
```

**ğŸ“Š æ‰¹é‡ç®¡ç†çš„åº”ç”¨åœºæ™¯**

| åœºæ™¯ | æŒ‘æˆ˜ | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **æ•°æ®ä¸­å¿ƒéƒ¨ç½²** | æ•°ç™¾å°æœåŠ¡å™¨é…ç½® | è‡ªåŠ¨åŒ–æ‰¹é‡éƒ¨ç½² |
| **ç½‘ç»œæ¶æ„å˜æ›´** | å…¨ç½‘é…ç½®åŒæ­¥æ›´æ–° | åˆ†æ‰¹æ¬¡æ»šåŠ¨æ›´æ–° |
| **ç¾å¤‡åˆ‡æ¢** | å¿«é€Ÿæ‰¹é‡é‡é…ç½® | é¢„è®¾é…ç½®å¿«é€Ÿåº”ç”¨ |
| **åˆè§„æ£€æŸ¥** | é…ç½®ä¸€è‡´æ€§éªŒè¯ | è‡ªåŠ¨åŒ–é…ç½®å®¡è®¡ |

### 7.2 ä½¿ç”¨Ansibleè¿›è¡Œæ‰¹é‡é…ç½®


**âš™ï¸ Ansible inventoryé…ç½®**

```ini
# /etc/ansible/hosts
[web_servers]
web01 ansible_host=192.168.1.10
web02 ansible_host=192.168.1.11
web03 ansible_host=192.168.1.12

[db_servers]  
db01 ansible_host=192.168.1.20
db02 ansible_host=192.168.1.21

[all:vars]
ansible_user=root
ansible_ssh_private_key_file=/root/.ssh/id_rsa
```

**ğŸ“„ ç½‘ç»œé…ç½®Playbook**

```yaml
# /etc/ansible/playbooks/network-config.yml
---
- name: æ‰¹é‡ç½‘ç»œé…ç½®ç®¡ç†
  hosts: all
  become: yes
  vars:
    backup_dir: "/var/backups/network"
    
  tasks:
    - name: åˆ›å»ºå¤‡ä»½ç›®å½•
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
        
    - name: å¤‡ä»½å½“å‰ç½‘ç»œé…ç½®
      shell: |
        mkdir -p {{ backup_dir }}/$(date +%Y%m%d_%H%M%S)
        cp -r /etc/netplan/* {{ backup_dir }}/$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || true
        cp /etc/hosts {{ backup_dir }}/$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || true
      args:
        creates: "{{ backup_dir }}/{{ ansible_date_time.date }}_*"
        
    - name: åº”ç”¨ç½‘ç»œé…ç½®æ¨¡æ¿
      template:
        src: "templates/{{ inventory_hostname }}-netplan.yaml.j2"
        dest: "/etc/netplan/01-netcfg.yaml"
        backup: yes
        mode: '0644'
      notify: apply_netplan
      
    - name: æ›´æ–°hostsæ–‡ä»¶
      template:
        src: "templates/hosts.j2"  
        dest: "/etc/hosts"
        backup: yes
        mode: '0644'
        
    - name: éªŒè¯ç½‘ç»œé…ç½®è¯­æ³•
      shell: netplan try --timeout=10
      register: netplan_test
      failed_when: netplan_test.rc != 0
      
  handlers:
    - name: apply_netplan
      shell: netplan apply
      listen: "apply_netplan"
```

**ğŸ”§ å˜é‡æ–‡ä»¶é…ç½®**

```yaml
# /etc/ansible/group_vars/web_servers.yml
network_config:
  interface: eth0
  gateway: 192.168.1.1
  dns_servers:
    - 8.8.8.8
    - 1.1.1.1
  dns_search:
    - web.local
    - company.com

# /etc/ansible/host_vars/web01.yml
network_config:
  ip_address: 192.168.1.10/24
  
# /etc/ansible/host_vars/web02.yml  
network_config:
  ip_address: 192.168.1.11/24
```

### 7.3 æ‰¹é‡é…ç½®éªŒè¯è„šæœ¬


**ğŸ” ç½‘ç»œé…ç½®æ‰¹é‡éªŒè¯**

```bash
#!/bin/bash
# /usr/local/bin/batch-network-verify.sh

SERVERS_FILE="/etc/ansible/hosts"
RESULTS_FILE="/tmp/network-verify-results.txt"
SSH_OPTIONS="-o ConnectTimeout=10 -o StrictHostKeyChecking=no"

# è§£æinventoryæ–‡ä»¶è·å–æœåŠ¡å™¨åˆ—è¡¨
get_servers() {
    awk '/^\[.*\]/ { group=$0; next } 
         /^[^#].*ansible_host/ { 
             split($0, a, " "); 
             split(a[2], b, "="); 
             print a[1], b[2], group 
         }' "$SERVERS_FILE"
}

verify_server_network() {
    local hostname=$1  
    local ip=$2
    local group=$3
    
    echo "æ£€æŸ¥æœåŠ¡å™¨: $hostname ($ip) [$group]"
    
    # è¿é€šæ€§æµ‹è¯•
    if ! ping -c 1 -W 5 "$ip" >/dev/null 2>&1; then
        echo "âœ— $hostname: ç½‘ç»œä¸å¯è¾¾" | tee -a "$RESULTS_FILE"
        return 1
    fi
    
    # SSHè¿æ¥æµ‹è¯•å¹¶æ”¶é›†ç½‘ç»œä¿¡æ¯
    network_info=$(ssh $SSH_OPTIONS root@"$ip" '
        echo "=== Network Interface Info ==="
        ip addr show | grep -E "inet |^[0-9]:" | head -10
        echo ""
        echo "=== Default Route ==="  
        ip route show default
        echo ""
        echo "=== DNS Config ==="
        cat /etc/resolv.conf | head -5
        echo ""
        echo "=== Connectivity Test ==="
        ping -c 1 -W 3 8.8.8.8 >/dev/null 2>&1 && echo "Internet: OK" || echo "Internet: FAILED"
    ' 2>/dev/null)
    
    if [[ $? -eq 0 ]]; then
        echo "âœ“ $hostname: SSHè¿æ¥æˆåŠŸ" | tee -a "$RESULTS_FILE"
        echo "$network_info" | sed "s/^/  /" | tee -a "$RESULTS_FILE"
        echo "" | tee -a "$RESULTS_FILE"
        return 0
    else
        echo "âœ— $hostname: SSHè¿æ¥å¤±è´¥" | tee -a "$RESULTS_FILE"
        return 1
    fi
}

# æ¸…ç©ºç»“æœæ–‡ä»¶
> "$RESULTS_FILE"

echo "å¼€å§‹æ‰¹é‡ç½‘ç»œé…ç½®éªŒè¯..."
echo "ç»“æœå°†ä¿å­˜åˆ°: $RESULTS_FILE"
echo ""

# å¹¶è¡ŒéªŒè¯æ‰€æœ‰æœåŠ¡å™¨
success_count=0
total_count=0

while read -r hostname ip group; do
    ((total_count++))
    if verify_server_network "$hostname" "$ip" "$group"; then
        ((success_count++))
    fi
    echo "---"
done < <(get_servers)

echo ""
echo "éªŒè¯å®Œæˆ: $success_count/$total_count æœåŠ¡å™¨ç½‘ç»œé…ç½®æ­£å¸¸"
echo "è¯¦ç»†ç»“æœæŸ¥çœ‹: $RESULTS_FILE"

# ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
cat >> "$RESULTS_FILE" << EOF

=== éªŒè¯æ±‡æ€» ===
æ€»æœåŠ¡å™¨æ•°: $total_count
éªŒè¯æˆåŠŸ: $success_count  
éªŒè¯å¤±è´¥: $((total_count - success_count))
æˆåŠŸç‡: $(( success_count * 100 / total_count ))%
éªŒè¯æ—¶é—´: $(date)
EOF
```

### 7.4 é…ç½®å·®å¼‚æ£€æµ‹


**ğŸ” æ‰¹é‡é…ç½®å·®å¼‚åˆ†æ**

```bash
#!/bin/bash
# /usr/local/bin/network-config-diff.sh

BASELINE_SERVER="web01"
BASELINE_IP="192.168.1.10"  
SERVERS_LIST="/etc/ansible/hosts"

collect_config() {
    local server_ip=$1
    local output_file=$2
    
    ssh -o ConnectTimeout=10 root@"$server_ip" '
        echo "=== Netplan Config ==="
        find /etc/netplan -name "*.yaml" -exec cat {} \;
        echo ""
        echo "=== Network Interfaces ==="  
        ip addr show
        echo ""
        echo "=== Routing Table ==="
        ip route show
        echo ""
        echo "=== DNS Configuration ==="
        cat /etc/resolv.conf
    ' > "$output_file" 2>/dev/null
}

generate_diff_report() {
    local baseline_file=$1
    local compare_file=$2
    local server_name=$3
    
    echo "=== é…ç½®å·®å¼‚æŠ¥å‘Š: $server_name ==="
    echo ""
    
    # ä½¿ç”¨diffå‘½ä»¤æ¯”è¾ƒé…ç½®
    if diff -u "$baseline_file" "$compare_file" >/dev/null; then
        echo "âœ“ é…ç½®ä¸åŸºå‡†æœåŠ¡å™¨ä¸€è‡´"
    else
        echo "âœ— å‘ç°é…ç½®å·®å¼‚:"
        diff -u "$baseline_file" "$compare_file" | head -50
    fi
    echo ""
    echo "----------------------------------------"
}

main() {
    local temp_dir=$(mktemp -d)
    local baseline_config="$temp_dir/baseline.txt"
    
    echo "æ”¶é›†åŸºå‡†é…ç½® ($BASELINE_SERVER)..."
    collect_config "$BASELINE_IP" "$baseline_config"
    
    if [[ ! -s "$baseline_config" ]]; then
        echo "æ— æ³•æ”¶é›†åŸºå‡†é…ç½®"
        exit 1
    fi
    
    echo "å¼€å§‹æ‰¹é‡é…ç½®å·®å¼‚æ£€æµ‹..."
    echo ""
    
    # éå†æ‰€æœ‰æœåŠ¡å™¨è¿›è¡Œæ¯”è¾ƒ
    while read -r hostname ip group; do
        if [[ "$ip" == "$BASELINE_IP" ]]; then
            continue  # è·³è¿‡åŸºå‡†æœåŠ¡å™¨
        fi
        
        local server_config="$temp_dir/${hostname}.txt"
        echo "æ”¶é›† $hostname ($ip) é…ç½®..."
        
        collect_config "$ip" "$server_config"
        
        if [[ -s "$server_config" ]]; then
            generate_diff_report "$baseline_config" "$server_config" "$hostname"
        else
            echo "âœ— æ— æ³•æ”¶é›† $hostname çš„é…ç½®"
            echo "----------------------------------------"
        fi
        
    done < <(awk '/^\[.*\]/ { group=$0; next } 
                  /^[^#].*ansible_host/ { 
                      split($0, a, " "); 
                      split(a[2], b, "="); 
                      print a[1], b[2], group 
                  }' "$SERVERS_LIST")
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -rf "$temp_dir"
    
    echo "é…ç½®å·®å¼‚æ£€æµ‹å®Œæˆ"
}

main "$@"
```

---

## 8. ğŸ“š ç½‘ç»œé…ç½®ç‰ˆæœ¬æ§åˆ¶


### 8.1 ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬æ§åˆ¶


**ğŸ”¸ ç‰ˆæœ¬æ§åˆ¶çš„ä»·å€¼**

ç½‘ç»œé…ç½®ç‰ˆæœ¬æ§åˆ¶è§£å†³äº†è¿ç»´ä¸­çš„å…³é”®é—®é¢˜ï¼š

```
é—®é¢˜åœºæ™¯ï¼š
- é…ç½®å˜æ›´åå‡ºç°é—®é¢˜ï¼Œéœ€è¦å¿«é€Ÿå›æ»š
- å¤šäººåä½œæ—¶é…ç½®å†²çª
- æ— æ³•è¿½è¸ªé…ç½®å˜æ›´å†å²
- ç¼ºä¹å˜æ›´å®¡æ‰¹æµç¨‹

ç‰ˆæœ¬æ§åˆ¶è§£å†³æ–¹æ¡ˆï¼š
- å®Œæ•´çš„å˜æ›´å†å²è®°å½•
- å¿«é€Ÿå›æ»šåˆ°ä»»æ„ç‰ˆæœ¬
- åˆ†æ”¯ç®¡ç†æ”¯æŒå¹¶è¡Œå¼€å‘
- ä»£ç å®¡æŸ¥ç¡®ä¿é…ç½®è´¨é‡
```

### 8.2 Gitç‰ˆæœ¬æ§åˆ¶å®è·µ


**ğŸ”§ å»ºç«‹ç½‘ç»œé…ç½®Gitä»“åº“**

```bash
# åˆ›å»ºé…ç½®ä»“åº“
mkdir -p /etc/network-configs
cd /etc/network-configs

# åˆå§‹åŒ–Gitä»“åº“
git init
git config user.name "Network Admin"
git config user.email "netadmin@company.com"

# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p {templates,hosts,environments/{prod,staging,dev}}

# åˆ›å»º.gitignore
cat > .gitignore << 'EOF'
# å¿½ç•¥æ•æ„Ÿä¿¡æ¯
*.key
*.pem
*password*
*secret*

# å¿½ç•¥ä¸´æ—¶æ–‡ä»¶
*.tmp
*.backup
.DS_Store
EOF

# åˆå§‹æäº¤
git add .
git commit -m "Initial network configuration repository"
```

**ğŸ“ æ¨èçš„ç›®å½•ç»“æ„**
```
/etc/network-configs/
â”œâ”€â”€ templates/              # é…ç½®æ¨¡æ¿
â”‚   â”œâ”€â”€ netplan/
â”‚   â”œâ”€â”€ interfaces/
â”‚   â””â”€â”€ network-scripts/
â”œâ”€â”€ environments/            # ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ production/
â”‚   â”œâ”€â”€ staging/
â”‚   â””â”€â”€ development/
â”œâ”€â”€ hosts/                   # ä¸»æœºç‰¹å®šé…ç½®
â”‚   â”œâ”€â”€ web-servers/
â”‚   â”œâ”€â”€ db-servers/
â”‚   â””â”€â”€ load-balancers/
â”œâ”€â”€ scripts/                 # è‡ªåŠ¨åŒ–è„šæœ¬
â”œâ”€â”€ docs/                    # æ–‡æ¡£
â””â”€â”€ README.md
```

### 8.3 é…ç½®å˜æ›´å·¥ä½œæµ


**ğŸ”„ Gitå·¥ä½œæµç¨‹**

```bash
#!/bin/bash
# /usr/local/bin/network-config-workflow.sh

CONFIG_REPO="/etc/network-configs"
REMOTE_REPO="git@gitlab.company.com:infrastructure/network-configs.git"

# åˆ›å»ºæ–°çš„é…ç½®å˜æ›´åˆ†æ”¯
create_change_branch() {
    local change_description="$1"
    local branch_name="change-$(date +%Y%m%d-%H%M%S)-${change_description// /-}"
    
    cd "$CONFIG_REPO"
    
    # ç¡®ä¿åœ¨ä¸»åˆ†æ”¯ä¸Š
    git checkout main
    git pull origin main
    
    # åˆ›å»ºæ–°åˆ†æ”¯
    git checkout -b "$branch_name"
    
    echo "å·²åˆ›å»ºå˜æ›´åˆ†æ”¯: $branch_name"
    echo "è¯·åœ¨æ­¤åˆ†æ”¯ä¸Šè¿›è¡Œé…ç½®ä¿®æ”¹"
}

# æäº¤é…ç½®å˜æ›´
commit_changes() {
    local commit_message="$1"
    
    cd "$CONFIG_REPO"
    
    # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
    if git diff --quiet && git diff --cached --quiet; then
        echo "æ²¡æœ‰æ£€æµ‹åˆ°é…ç½®å˜æ›´"
        return 1
    fi
    
    # æ˜¾ç¤ºå˜æ›´å†…å®¹
    echo "å‡†å¤‡æäº¤çš„å˜æ›´:"
    git diff --stat
    echo ""
    
    # æ·»åŠ æ‰€æœ‰å˜æ›´
    git add -A
    
    # æäº¤å˜æ›´
    git commit -m "$commit_message

å˜æ›´è¯¦æƒ…:
$(git diff --cached --stat)

å˜æ›´æ—¶é—´: $(date)
æ“ä½œäººå‘˜: $(whoami)@$(hostname)"
    
    echo "å˜æ›´å·²æäº¤åˆ°æœ¬åœ°ä»“åº“"
}

# éƒ¨ç½²é…ç½®åˆ°ç›®æ ‡ç¯å¢ƒ
deploy_config() {
    local environment="$1"
    local target_hosts="$2"
    
    cd "$CONFIG_REPO"
    
    echo "éƒ¨ç½²é…ç½®åˆ°ç¯å¢ƒ: $environment"
    
    # ç¡®ä¿é…ç½®æ˜¯æœ€æ–°çš„
    git pull origin main
    
    # ä½¿ç”¨Ansibleéƒ¨ç½²é…ç½®
    ansible-playbook \
        -i "environments/$environment/inventory" \
        -l "$target_hosts" \
        playbooks/deploy-network-config.yml \
        --diff
    
    # è®°å½•éƒ¨ç½²ä¿¡æ¯
    git tag "deploy-$environment-$(date +%Y%m%d-%H%M%S)"
    git push origin --tags
}

# å›æ»šé…ç½®
rollback_config() {
    local target_version="$1"
    local environment="$2"
    
    cd "$CONFIG_REPO"
    
    echo "å›æ»šé…ç½®åˆ°ç‰ˆæœ¬: $target_version"
    
    # åˆ›å»ºå›æ»šåˆ†æ”¯
    git checkout -b "rollback-$(date +%Y%m%d-%H%M%S)"
    git revert "$target_version" --no-edit
    
    # éƒ¨ç½²å›æ»šé…ç½®
    deploy_config "$environment" "all"
    
    echo "é…ç½®å›æ»šå®Œæˆ"
}

# ä¸»é€»è¾‘
case "${1:-help}" in
    "new-change")
        create_change_branch "$2"
        ;;
    "commit")
        commit_changes "$2"
        ;;
    "deploy")
        deploy_config "$2" "${3:-all}"
        ;;
    "rollback")
        rollback_config "$2" "$3"
        ;;
    "status")
        cd "$CONFIG_REPO"
        echo "=== GitçŠ¶æ€ ==="
        git status
        echo ""
        echo "=== æœ€è¿‘æäº¤ ==="
        git log --oneline -10
        ;;
    *)
        echo "ç½‘ç»œé…ç½®ç‰ˆæœ¬æ§åˆ¶å·¥å…·"
        echo ""
        echo "ç”¨æ³•: $0 {new-change|commit|deploy|rollback|status}"
        echo ""
        echo "å‘½ä»¤è¯´æ˜:"
        echo "  new-change <æè¿°>     - åˆ›å»ºæ–°çš„é…ç½®å˜æ›´åˆ†æ”¯"
        echo "  commit <æäº¤ä¿¡æ¯>     - æäº¤å½“å‰å˜æ›´"
        echo "  deploy <ç¯å¢ƒ> [ä¸»æœº]  - éƒ¨ç½²é…ç½®åˆ°æŒ‡å®šç¯å¢ƒ"
        echo "  rollback <ç‰ˆæœ¬> <ç¯å¢ƒ> - å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬"
        echo "  status               - æŸ¥çœ‹ä»“åº“çŠ¶æ€"
        ;;
esac
```

### 8.4 é…ç½®å®¡æŸ¥æœºåˆ¶


**ğŸ” Pre-commité’©å­**

```bash
#!/bin/bash
# /etc/network-configs/.git/hooks/pre-commit

echo "æ‰§è¡Œç½‘ç»œé…ç½®æäº¤å‰æ£€æŸ¥..."

# æ£€æŸ¥YAMLæ–‡ä»¶è¯­æ³•
check_yaml_syntax() {
    local yaml_files=$(git diff --cached --name-only | grep '\.ya?ml$')
    
    if [[ -n "$yaml_files" ]]; then
        echo "æ£€æŸ¥YAMLæ–‡ä»¶è¯­æ³•..."
        for file in $yaml_files; do
            if ! yamllint "$file" >/dev/null 2>&1; then
                echo "âœ— YAMLè¯­æ³•é”™è¯¯: $file"
                yamllint "$file"
                return 1
            fi
        done
        echo "âœ“ YAMLæ–‡ä»¶è¯­æ³•æ£€æŸ¥é€šè¿‡"
    fi
    return 0
}

# æ£€æŸ¥ç½‘ç»œé…ç½®æœ‰æ•ˆæ€§
check_network_config() {
    local netplan_files=$(git diff --cached --name-only | grep netplan | grep '\.yaml$')
    
    if [[ -n "$netplan_files" ]]; then
        echo "éªŒè¯Netplané…ç½®..."
        for file in $netplan_files; do
            # ä½¿ç”¨ä¸´æ—¶ç›®å½•æµ‹è¯•é…ç½®
            local temp_dir=$(mktemp -d)
            cp "$file" "$temp_dir/99-test.yaml"
            
            if ! NETPLAN_CONFIG_ROOT="$temp_dir" netplan generate >/dev/null 2>&1; then
                echo "âœ— Netplané…ç½®é”™è¯¯: $file"
                rm -rf "$temp_dir"
                return 1
            fi
            rm -rf "$temp_dir"
        done
        echo "âœ“ Netplané…ç½®éªŒè¯é€šè¿‡"
    fi
    return 0
}

# æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
check_sensitive_info() {
    echo "æ£€æŸ¥æ•æ„Ÿä¿¡æ¯æ³„éœ²..."
    
    # æ£€æŸ¥å¸¸è§çš„æ•æ„Ÿä¿¡æ¯æ¨¡å¼
    local sensitive_patterns=(
        "password.*=.*"
        "secret.*=.*"
        "-----BEGIN.*KEY-----"
        "ssh-rsa.*"
        "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}.*password"
    )
    
    for pattern in "${sensitive_patterns[@]}"; do
        if git diff --cached | grep -iE "$pattern"; then
            echo "âœ— å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²"
            echo "è¯·æ£€æŸ¥å¹¶ç§»é™¤æ•æ„Ÿä¿¡æ¯åé‡æ–°æäº¤"
            return 1
        fi
    done
    
    echo "âœ“ æ•æ„Ÿä¿¡æ¯æ£€æŸ¥é€šè¿‡"
    return 0
}

# æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
if check_yaml_syntax && check_network_config && check_sensitive_info; then
    echo "âœ“ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå…è®¸æäº¤"
    exit 0
else
    echo "âœ— æ£€æŸ¥å¤±è´¥ï¼Œæ‹’ç»æäº¤"
    exit 1
fi
```

---

## 9. âœ… ç½‘ç»œé…ç½®éªŒè¯è„šæœ¬


### 9.1 å…¨é¢ç½‘ç»œé…ç½®éªŒè¯


**ğŸ” ç»¼åˆéªŒè¯è„šæœ¬æ¶æ„**

```bash
#!/bin/bash
# /usr/local/bin/comprehensive-network-verify.sh

# é…ç½®æ–‡ä»¶
CONFIG_FILE="/etc/network-verify.conf"
LOG_FILE="/var/log/network-verify.log"
REPORT_FILE="/var/log/network-verify-report.html"

# é»˜è®¤é…ç½®
DEFAULT_TESTS=(
    "interface_status"
    "ip_configuration"  
    "routing_table"
    "dns_resolution"
    "connectivity"
    "firewall_rules"
    "network_services"
)

# æ—¥å¿—å‡½æ•°
log_message() {
    local level=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    echo "[$timestamp] [$level] $message" | tee -a "$LOG_FILE"
}

# æµ‹è¯•æ¥å£çŠ¶æ€
test_interface_status() {
    log_message "INFO" "æµ‹è¯•ç½‘ç»œæ¥å£çŠ¶æ€"
    
    local interfaces=$(ip link show | awk -F: '/^[0-9]+:/ {print $2}' | tr -d ' ' | grep -v lo)
    local failed_interfaces=()
    
    for interface in $interfaces; do
        local status=$(ip link show "$interface" | grep -o "state [A-Z]*" | cut -d' ' -f2)
        
        if [[ "$status" == "UP" ]]; then
            log_message "PASS" "æ¥å£ $interface çŠ¶æ€: UP"
        else
            log_message "FAIL" "æ¥å£ $interface çŠ¶æ€: $status"
            failed_interfaces+=("$interface")
        fi
    done
    
    if [[ ${#failed_interfaces[@]} -eq 0 ]]; then
        return 0
    else
        log_message "ERROR" "å¤±è´¥çš„æ¥å£: ${failed_interfaces[*]}"
        return 1
    fi
}

# æµ‹è¯•IPé…ç½®
test_ip_configuration() {
    log_message "INFO" "éªŒè¯IPåœ°å€é…ç½®"
    
    # ä»é…ç½®æ–‡ä»¶è¯»å–æœŸæœ›çš„IPé…ç½®
    local expected_configs
    if [[ -f "$CONFIG_FILE" ]]; then
        expected_configs=$(grep "^EXPECTED_IP" "$CONFIG_FILE")
    fi
    
    # è·å–å½“å‰IPé…ç½®
    local current_ips=$(ip addr show | grep 'inet ' | grep -v '127.0.0.1' | awk '{print $2}')
    
    if [[ -z "$current_ips" ]]; then
        log_message "FAIL" "æœªå‘ç°æœ‰æ•ˆIPåœ°å€é…ç½®"
        return 1
    fi
    
    log_message "PASS" "å½“å‰IPé…ç½®: $(echo $current_ips | tr '\n' ' ')"
    return 0
}

# æµ‹è¯•è·¯ç”±è¡¨
test_routing_table() {
    log_message "INFO" "éªŒè¯è·¯ç”±è¡¨é…ç½®"
    
    # æ£€æŸ¥é»˜è®¤è·¯ç”±
    local default_route=$(ip route show default | head -1)
    
    if [[ -n "$default_route" ]]; then
        log_message "PASS" "é»˜è®¤è·¯ç”±: $default_route"
    else
        log_message "FAIL" "æœªå‘ç°é»˜è®¤è·¯ç”±"
        return 1
    fi
    
    # æ£€æŸ¥è·¯ç”±è¡¨å®Œæ•´æ€§
    local route_count=$(ip route show | wc -l)
    log_message "INFO" "è·¯ç”±è¡¨æ¡ç›®æ•°: $route_count"
    
    return 0
}

# æµ‹è¯•DNSè§£æ
test_dns_resolution() {
    log_message "INFO" "æµ‹è¯•DNSè§£æåŠŸèƒ½"
    
    local test_domains=("google.com" "baidu.com" "github.com")
    local failed_domains=()
    
    for domain in "${test_domains[@]}"; do
        if nslookup "$domain" >/dev/null 2>&1; then
            log_message "PASS" "DNSè§£ææˆåŠŸ: $domain"
        else
            log_message "FAIL" "DNSè§£æå¤±è´¥: $domain"
            failed_domains+=("$domain")
        fi
    done
    
    # æ£€æŸ¥DNSé…ç½®æ–‡ä»¶
    if [[ -f /etc/resolv.conf ]]; then
        local dns_servers=$(grep nameserver /etc/resolv.conf | awk '{print $2}')
        log_message "INFO" "DNSæœåŠ¡å™¨: $(echo $dns_servers | tr '\n' ' ')"
    fi
    
    [[ ${#failed_domains[@]} -eq 0 ]]
}

# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
test_connectivity() {
    log_message "INFO" "æµ‹è¯•ç½‘ç»œè¿é€šæ€§"
    
    local test_targets=("8.8.8.8" "1.1.1.1" "114.114.114.114")
    local success_count=0
    
    for target in "${test_targets[@]}"; do
        if ping -c 3 -W 5 "$target" >/dev/null 2>&1; then
            log_message "PASS" "è¿é€šæ€§æµ‹è¯•æˆåŠŸ: $target"
            ((success_count++))
        else
            log_message "FAIL" "è¿é€šæ€§æµ‹è¯•å¤±è´¥: $target"
        fi
    done
    
    # è‡³å°‘ä¸€ä¸ªç›®æ ‡å¯è¾¾å³è®¤ä¸ºè¿é€šæ€§æ­£å¸¸
    if [[ $success_count -gt 0 ]]; then
        log_message "INFO" "ç½‘ç»œè¿é€šæ€§: $success_count/${#test_targets[@]} ç›®æ ‡å¯è¾¾"
        return 0
    else
        log_message "ERROR" "æ‰€æœ‰è¿é€šæ€§æµ‹è¯•å‡å¤±è´¥"
        return 1
    fi
}

# æµ‹è¯•é˜²ç«å¢™è§„åˆ™
test_firewall_rules() {
    log_message "INFO" "æ£€æŸ¥é˜²ç«å¢™è§„åˆ™"
    
    # æ£€æŸ¥iptablesè§„åˆ™
    if command -v iptables >/dev/null 2>&1; then
        local rule_count=$(iptables -L | wc -l)
        log_message "INFO" "iptablesè§„åˆ™æ•°: $rule_count"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ‹’ç»æ‰€æœ‰æµé‡çš„è§„åˆ™
        if iptables -L INPUT | grep -q "DROP.*all"; then
            log_message "WARN" "å‘ç°DROP ALLè§„åˆ™ï¼Œå¯èƒ½å½±å“ç½‘ç»œè®¿é—®"
        fi
    fi
    
    # æ£€æŸ¥ufwçŠ¶æ€
    if command -v ufw >/dev/null 2>&1; then
        local ufw_status=$(ufw status | head -1)
        log_message "INFO" "UFWçŠ¶æ€: $ufw_status"
    fi
    
    return 0
}

# æµ‹è¯•ç½‘ç»œæœåŠ¡
test_network_services() {
    log_message "INFO" "æ£€æŸ¥ç½‘ç»œç›¸å…³æœåŠ¡"
    
    local network_services=("NetworkManager" "systemd-networkd" "networking")
    
    for service in "${network_services[@]}"; do
        if systemctl is-active "$service" >/dev/null 2>&1; then
            local status=$(systemctl is-active "$service")
            log_message "PASS" "æœåŠ¡ $service çŠ¶æ€: $status"
        fi
    done
    
    return 0
}

# ç”ŸæˆHTMLæŠ¥å‘Š
generate_html_report() {
    local start_time=$1
    local end_time=$2
    local total_tests=$3
    local passed_tests=$4
    
    cat > "$REPORT_FILE" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>ç½‘ç»œé…ç½®éªŒè¯æŠ¥å‘Š</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background: #f0f0f0; padding: 20px; border-radius: 5px; }
        .summary { margin: 20px 0; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        .warn { color: orange; font-weight: bold; }
        .log-entry { margin: 5px 0; padding: 5px; border-left: 3px solid #ddd; }
        .log-pass { border-left-color: green; }
        .log-fail { border-left-color: red; }
        .log-warn { border-left-color: orange; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ç½‘ç»œé…ç½®éªŒè¯æŠ¥å‘Š</h1>
        <p><strong>ä¸»æœºå:</strong> $(hostname)</p>
        <p><strong>æ£€æµ‹æ—¶é—´:</strong> $start_time - $end_time</p>
        <p><strong>æ€»è€—æ—¶:</strong> $((end_time - start_time)) ç§’</p>
    </div>
    
    <div class="summary">
        <h2>æ£€æµ‹æ‘˜è¦</h2>
        <p>æ€»æµ‹è¯•é¡¹: <strong>$total_tests</strong></p>
        <p>é€šè¿‡æµ‹è¯•: <span class="pass">$passed_tests</span></p>
        <p>å¤±è´¥æµ‹è¯•: <span class="fail">$((total_tests - passed_tests))</span></p>
        <p>æˆåŠŸç‡: <strong>$((passed_tests * 100 / total_tests))%</strong></p>
    </div>
    
    <div class="details">
        <h2>è¯¦ç»†æ—¥å¿—</h2>
EOF

    # æ·»åŠ æ—¥å¿—å†…å®¹åˆ°HTML
    while IFS= read -r line; do
        local css_class=""
        if echo "$line" | grep -q "\[PASS\]"; then
            css_class="log-pass"
        elif echo "$line" | grep -q "\[FAIL\]"; then
            css_class="log-fail"  
        elif echo "$line" | grep -q "\[WARN\]"; then
            css_class="log-warn"
        fi
        
        echo "        <div class=\"log-entry $css_class\">$line</div>" >> "$REPORT_FILE"
    done < "$LOG_FILE"
    
    cat >> "$REPORT_FILE" << EOF
    </div>
</body>
</html>
EOF
    
    log_message "INFO" "HTMLæŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_FILE"
}

# ä¸»æ‰§è¡Œå‡½æ•°
main() {
    local start_time=$(date +%s)
    local total_tests=0
    local passed_tests=0
    
    # æ¸…ç©ºæ—¥å¿—æ–‡ä»¶
    > "$LOG_FILE"
    
    log_message "INFO" "å¼€å§‹ç½‘ç»œé…ç½®å…¨é¢éªŒè¯"
    log_message "INFO" "ä¸»æœº: $(hostname), æ—¶é—´: $(date)"
    
    # æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
    for test_name in "${DEFAULT_TESTS[@]}"; do
        ((total_tests++))
        log_message "INFO" "æ‰§è¡Œæµ‹è¯•: $test_name"
        
        if "test_$test_name"; then
            ((passed_tests++))
            log_message "PASS" "æµ‹è¯• $test_name é€šè¿‡"
        else
            log_message "FAIL" "æµ‹è¯• $test_name å¤±è´¥"
        fi
        
        echo "" >> "$LOG_FILE"
    done
    
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    log_message "INFO" "éªŒè¯å®Œæˆï¼Œè€—æ—¶ ${duration} ç§’"
    log_message "INFO" "æ€»æµ‹è¯•: $total_tests, é€šè¿‡: $passed_tests, å¤±è´¥: $((total_tests - passed_tests))"
    
    # ç”ŸæˆHTMLæŠ¥å‘Š
    generate_html_report "$start_time" "$end_time" "$total_tests" "$passed_tests"
    
    # è¿”å›é€‚å½“çš„é€€å‡ºç 
    if [[ $passed_tests -eq $total_tests ]]; then
        echo "âœ“ æ‰€æœ‰ç½‘ç»œé…ç½®éªŒè¯é€šè¿‡"
        exit 0
    else
        echo "âœ— éƒ¨åˆ†ç½‘ç»œé…ç½®éªŒè¯å¤±è´¥ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹ $LOG_FILE"
        exit 1
    fi
}

# è„šæœ¬å…¥å£
case "${1:-run}" in
    "run")
        main
        ;;
    "report")
        if [[ -f "$REPORT_FILE" ]]; then
            echo "HTMLæŠ¥å‘Šä½ç½®: $REPORT_FILE"
            if command -v xdg-open >/dev/null 2>&1; then
                xdg-open "$REPORT_FILE"
            fi
        else
            echo "æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡ŒéªŒè¯"
        fi
        ;;
    "clean")
        rm -f "$LOG_FILE" "$REPORT_FILE"
        echo "æ—¥å¿—å’ŒæŠ¥å‘Šæ–‡ä»¶å·²æ¸…ç†"
        ;;
    *)
        echo "ç”¨æ³•: $0 {run|report|clean}"
        ;;
esac
```

### 9.2 ç½‘ç»œæ€§èƒ½éªŒè¯


**âš¡ ç½‘ç»œæ€§èƒ½æµ‹è¯•è„šæœ¬**

```bash
#!/bin/bash
# /usr/local/bin/network-performance-test.sh

RESULTS_FILE="/var/log/network-performance.json"

# æµ‹è¯•ç½‘ç»œååé‡
test_bandwidth() {
    local target_host="$1"
    local test_duration="10"
    
    echo "æµ‹è¯•åˆ° $target_host çš„ç½‘ç»œå¸¦å®½..."
    
    # ä½¿ç”¨iperf3æµ‹è¯•ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if command -v iperf3 >/dev/null 2>&1; then
        local result=$(iperf3 -c "$target_host" -t "$test_duration" -J 2>/dev/null)
        echo "$result" | jq -r '.end.sum_received.bits_per_second // "N/A"'
    else
        echo "iperf3æœªå®‰è£…ï¼Œè·³è¿‡å¸¦å®½æµ‹è¯•"
        return 1
    fi
}

# æµ‹è¯•ç½‘ç»œå»¶è¿Ÿ
test_latency() {
    local target="$1"
    local count="10"
    
    echo "æµ‹è¯•åˆ° $target çš„ç½‘ç»œå»¶è¿Ÿ..."
    
    local ping_result=$(ping -c "$count" -q "$target" 2>/dev/null | tail -1)
    local avg_latency=$(echo "$ping_result" | awk -F'/' '{print $5}')
    
    echo "${avg_latency:-N/A}"
}

# æµ‹è¯•DNSè§£ææ—¶é—´
test_dns_performance() {
    local domain="$1"
    
    echo "æµ‹è¯• $domain çš„DNSè§£ææ—¶é—´..."
    
    local start_time=$(date +%s%3N)
    nslookup "$domain" >/dev/null 2>&1
    local end_time=$(date +%s%3N)
    
    local dns_time=$((end_time - start_time))
    echo "${dns_time}ms"
}

# ä¸»æµ‹è¯•å‡½æ•°
main() {
    local test_targets=("8.8.8.8" "1.1.1.1" "baidu.com")
    local timestamp=$(date -Iseconds)
    
    echo "å¼€å§‹ç½‘ç»œæ€§èƒ½æµ‹è¯•..."
    
    # åˆ›å»ºJSONç»“æœæ–‡ä»¶
    cat > "$RESULTS_FILE" << EOF
{
    "timestamp": "$timestamp",
    "hostname": "$(hostname)",
    "tests": {
EOF
    
    local first_test=true
    for target in "${test_targets[@]}"; do
        [[ "$first_test" == "true" ]] && first_test=false || echo "," >> "$RESULTS_FILE"
        
        echo "        \"$target\": {" >> "$RESULTS_FILE"
        echo "            \"latency\": \"$(test_latency "$target")\"," >> "$RESULTS_FILE"
        echo "            \"dns_time\": \"$(test_dns_performance "$target")\"" >> "$RESULTS_FILE"
        echo -n "        }" >> "$RESULTS_FILE"
    done
    
    cat >> "$RESULTS_FILE" << EOF

    }
}
EOF
    
    echo "ç½‘ç»œæ€§èƒ½æµ‹è¯•å®Œæˆï¼Œç»“æœä¿å­˜åˆ°: $RESULTS_FILE"
    
    # æ˜¾ç¤ºç®€è¦ç»“æœ
    echo ""
    echo "æµ‹è¯•ç»“æœæ‘˜è¦:"
    jq -r '.tests | to_entries[] | "\(.key): å»¶è¿Ÿ \(.value.latency), DNS \(.value.dns_time)"' "$RESULTS_FILE"
}

main "$@"
```

### 9.3 æŒç»­ç›‘æ§è„šæœ¬


**ğŸ“Š ç½‘ç»œçŠ¶æ€æŒç»­ç›‘æ§**

```bash
#!/bin/bash
# /usr/local/bin/network-monitor.sh

MONITOR_INTERVAL=60  # ç›‘æ§é—´éš”ï¼ˆç§’ï¼‰
ALERT_LOG="/var/log/network-alerts.log"
STATUS_FILE="/var/run/network-status.json"

# å‘é€å‘Šè­¦
send_alert() {
    local severity="$1"
    local message="$2"
    local timestamp=$(date -Iseconds)
    
    # è®°å½•åˆ°æ—¥å¿—
    echo "[$timestamp] [$severity] $message" >> "$ALERT_LOG"
    
    # å‘é€é‚®ä»¶å‘Šè­¦ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
    if [[ -n "$ALERT_EMAIL" ]] && command -v mail >/dev/null 2>&1; then
        echo "$message" | mail -s "ç½‘ç»œå‘Šè­¦: $severity" "$ALERT_EMAIL"
    fi
    
    # å‘é€åˆ°syslog
    logger -p local0.warning "ç½‘ç»œç›‘æ§: $message"
}

# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
check_connectivity() {
    local targets=("8.8.8.8" "1.1.1.1")
    local failed_count=0
    
    for target in "${targets[@]}"; do
        if ! ping -c 1 -W 3 "$target" >/dev/null 2>&1; then
            ((failed_count++))
        fi
    done
    
    if [[ $failed_count -eq ${#targets[@]} ]]; then
        send_alert "CRITICAL" "æ‰€æœ‰å¤–ç½‘è¿é€šæ€§æµ‹è¯•å¤±è´¥"
        return 1
    elif [[ $failed_count -gt 0 ]]; then
        send_alert "WARNING" "éƒ¨åˆ†å¤–ç½‘è¿é€šæ€§æµ‹è¯•å¤±è´¥ ($failed_count/${#targets[@]})"
        return 2
    fi
    
    return 0
}

# æ£€æŸ¥DNSè§£æ
check_dns() {
    local test_domain="google.com"
    
    if ! nslookup "$test_domain" >/dev/null 2>&1; then
        send_alert "ERROR" "DNSè§£æå¤±è´¥: $test_domain"
        return 1
    fi
    
    return 0
}

# æ£€æŸ¥ç½‘ç»œæ¥å£çŠ¶æ€
check_interfaces() {
    local down_interfaces=()
    
    while IFS= read -r interface; do
        local status=$(cat "/sys/class/net/$interface/operstate" 2>/dev/null)
        if [[ "$status" != "up" ]] && [[ "$interface" != "lo" ]]; then
            down_interfaces+=("$interface")
        fi
    done < <(ls /sys/class/net/)
    
    if [[ ${#down_interfaces[@]} -gt 0 ]]; then
        send_alert "ERROR" "ç½‘ç»œæ¥å£å¼‚å¸¸: ${down_interfaces[*]}"
        return 1
    fi
    
    return 0
}

# æ›´æ–°çŠ¶æ€æ–‡ä»¶
update_status() {
    local connectivity_status="$1"
    local dns_status="$2"
    local interface_status="$3"
    local timestamp=$(date -Iseconds)
    
    cat > "$STATUS_FILE" << EOF
{
    "timestamp": "$timestamp",
    "hostname": "$(hostname)",
    "status": {
        "connectivity": $connectivity_status,
        "dns": $dns_status,
        "interfaces": $interface_status,
        "overall": $(( (connectivity_status + dns_status + interface_status) == 0 ))
    },
    "uptime": "$(uptime -p)",
    "load": "$(uptime | awk -F'load average:' '{print $2}')"
}
EOF
}

# ä¸»ç›‘æ§å¾ªç¯
main() {
    echo "å¯åŠ¨ç½‘ç»œçŠ¶æ€ç›‘æ§..."
    echo "ç›‘æ§é—´éš”: ${MONITOR_INTERVAL}ç§’"
    echo "å‘Šè­¦æ—¥å¿—: $ALERT_LOG"
    echo "çŠ¶æ€æ–‡ä»¶: $STATUS_FILE"
    
    while true; do
        local connectivity_result=0
        local dns_result=0
        local interface_result=0
        
        # æ‰§è¡Œå„é¡¹æ£€æŸ¥
        check_connectivity || connectivity_result=$?
        check_dns || dns_result=$?
        check_interfaces || interface_result=$?
        
        # æ›´æ–°çŠ¶æ€
        update_status $connectivity_result $dns_result $interface_result
        
        # ç­‰å¾…ä¸‹ä¸€æ¬¡æ£€æŸ¥
        sleep "$MONITOR_INTERVAL"
    done
}

# å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼
case "${1:-monitor}" in
    "monitor")
        main
        ;;
    "status")
        if [[ -f "$STATUS_FILE" ]]; then
            jq '.' "$STATUS_FILE"
        else
            echo "çŠ¶æ€æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç›‘æ§å¯èƒ½æœªè¿è¡Œ"
        fi
        ;;
    "daemon")
        # ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œ
        nohup "$0" monitor >/dev/null 2>&1 &
        echo "ç½‘ç»œç›‘æ§å®ˆæŠ¤è¿›ç¨‹å·²å¯åŠ¨ (PID: $!)"
        ;;
    "stop")
        pkill -f "network-monitor.sh"
        echo "ç½‘ç»œç›‘æ§å®ˆæŠ¤è¿›ç¨‹å·²åœæ­¢"
        ;;
    *)
        echo "ç”¨æ³•: $0 {monitor|status|daemon|stop}"
        ;;
esac
```

---

## 10. ğŸ¤– ç½‘ç»œé…ç½®è‡ªåŠ¨åŒ–éƒ¨ç½²


### 10.1 è‡ªåŠ¨åŒ–éƒ¨ç½²æ¶æ„


**ğŸ—ï¸ éƒ¨ç½²ç³»ç»Ÿæ•´ä½“æ¶æ„**

```
é…ç½®ç®¡ç†ä¸­å¿ƒ (Control Node)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Ansible/Salt      â”‚ â† é…ç½®ç®¡ç†å¼•æ“
â”‚   â””â”€ Inventory      â”‚   
â”‚   â””â”€ Playbooks     â”‚
â”‚   â””â”€ Templates     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç›®æ ‡æœåŠ¡å™¨ç¾¤ç»„      â”‚
â”‚  â”œâ”€ Web Servers    â”‚ â† åº”ç”¨é…ç½®
â”‚  â”œâ”€ DB Servers     â”‚
â”‚  â””â”€ Load Balancers â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ è‡ªåŠ¨åŒ–éƒ¨ç½²çš„å…³é”®ä¼˜åŠ¿**

| ä¼ ç»Ÿæ‰‹å·¥éƒ¨ç½² | è‡ªåŠ¨åŒ–éƒ¨ç½² |
|-------------|-----------|
| è€—æ—¶æ•°å°æ—¶/å¤© | å‡ åˆ†é’Ÿå®Œæˆ |
| æ˜“å‡ºé”™ï¼Œä¸ä¸€è‡´ | æ ‡å‡†åŒ–ï¼Œå¯é‡å¤ |
| éš¾ä»¥å›æ»š | ä¸€é”®å›æ»š |
| æ— æ³•æ‰¹é‡æ“ä½œ | æ”¯æŒå¤§è§„æ¨¡éƒ¨ç½² |
| ç¼ºä¹å˜æ›´è®°å½• | å®Œæ•´çš„å®¡è®¡æ—¥å¿— |

### 10.2 Ansibleè‡ªåŠ¨åŒ–éƒ¨ç½²


**ğŸ“„ å®Œæ•´çš„éƒ¨ç½²Playbook**

```yaml
---
# /etc/ansible/playbooks/network-deployment.yml
- name: ç½‘ç»œé…ç½®è‡ªåŠ¨åŒ–éƒ¨ç½²
  hosts: all
  become: yes
  gather_facts: yes
  
  vars:
    config_backup_dir: "/var/backups/network/{{ ansible_date_time.epoch }}"
    deployment_log: "/var/log/network-deployment.log"
    
  pre_tasks:
    - name: åˆ›å»ºéƒ¨ç½²æ—¥å¿—
      copy:
        content: |
          ç½‘ç»œé…ç½®éƒ¨ç½²å¼€å§‹
          æ—¶é—´: {{ ansible_date_time.iso8601 }}
          ç›®æ ‡ä¸»æœº: {{ inventory_hostname }}
          æ“ä½œç”¨æˆ·: {{ ansible_user }}
        dest: "{{ deployment_log }}"
      delegate_to: localhost
      run_once: true
      
    - name: éªŒè¯ç›®æ ‡ä¸»æœºè¿é€šæ€§
      ping:
      
    - name: æ”¶é›†ç½‘ç»œé…ç½®ä¿¡æ¯
      setup:
        gather_subset:
          - network
          - hardware
          
  tasks:
    - name: åˆ›å»ºé…ç½®å¤‡ä»½ç›®å½•
      file:
        path: "{{ config_backup_dir }}"
        state: directory
        mode: '0755'
        
    - name: å¤‡ä»½å½“å‰ç½‘ç»œé…ç½®
      block:
        - name: å¤‡ä»½netplané…ç½®
          copy:
            src: "/etc/netplan/"
            dest: "{{ config_backup_dir }}/netplan/"
            remote_src: yes
          ignore_errors: yes
          
        - name: å¤‡ä»½ç½‘ç»œç›¸å…³é…ç½®æ–‡ä»¶
          copy:
            src: "{{ item }}"
            dest: "{{ config_backup_dir }}/"
            remote_src: yes
          loop:
            - "/etc/hosts"
            - "/etc/hostname"
            - "/etc/resolv.conf"
          ignore_errors: yes
          
        - name: ä¿å­˜å½“å‰ç½‘ç»œçŠ¶æ€
          shell: |
            ip addr show > {{ config_backup_dir }}/ip-addr.txt
            ip route show > {{ config_backup_dir }}/routes.txt
            ss -tuln > {{ config_backup_dir }}/connections.txt
            
    - name: ç”Ÿæˆç½‘ç»œé…ç½®æ–‡ä»¶
      template:
        src: "templates/{{ ansible_hostname }}-netplan.yaml.j2"
        dest: "/etc/netplan/01-netcfg.yaml"
        backup: yes
        mode: '0644'
        validate: 'netplan try --timeout=10'
      notify:
        - apply_network_config
        - verify_network_config
        
    - name: æ›´æ–°ä¸»æœºå
      hostname:
        name: "{{ target_hostname | default(inventory_hostname) }}"
      when: target_hostname is defined
      
    - name: æ›´æ–°hostsæ–‡ä»¶
      template:
        src: "templates/hosts.j2"
        dest: "/etc/hosts"
        backup: yes
        mode: '0644'
        
    - name: é…ç½®DNSè§£æ
      template:
        src: "templates/resolv.conf.j2"
        dest: "/etc/resolv.conf"
        backup: yes
        mode: '0644'
      when: manage_dns | default(false)
      
  handlers:
    - name: apply_network_config
      shell: netplan apply
      async: 30
      poll: 0
      register: apply_job
      
    - name: verify_network_config
      wait_for:
        timeout: 30
      when: apply_job is defined
      
    - name: restart_network_services
      systemd:
        name: "{{ item }}"
        state: restarted
      loop:
        - systemd-networkd
        - systemd-resolved
      ignore_errors: yes
      
  post_tasks:
    - name: éªŒè¯ç½‘ç»œè¿é€šæ€§
      uri:
        url: "http://www.baidu.com"
        method: GET
        timeout: 10
      register: connectivity_test
      ignore_errors: yes
      
    - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      template:
        src: "templates/deployment-report.j2"
        dest: "/var/log/network-deployment-{{ ansible_date_time.epoch }}.html"
        
    - name: éƒ¨ç½²ç»“æœé€šçŸ¥
      debug:
        msg: |
          ç½‘ç»œé…ç½®éƒ¨ç½²å®Œæˆ
          ä¸»æœº: {{ inventory_hostname }}
          çŠ¶æ€: {% if connectivity_test.status == 200 %}æˆåŠŸ{% else %}éœ€è¦æ£€æŸ¥{% endif %}
          å¤‡ä»½ä½ç½®: {{ config_backup_dir }}
```

**ğŸ”§ éƒ¨ç½²å˜é‡é…ç½®**

```yaml
# /etc/ansible/group_vars/web_servers.yml
network_config:
  interface: "eth0"
  gateway: "192.168.1.1"
  dns_servers:
    - "8.8.8.8"
    - "1.1.1.1"
  dns_search_domains:
    - "web.local"
    - "company.com"
    
manage_dns: true
target_hostname_suffix: ".web.local"

# /etc/ansible/host_vars/web01.yml
network_config:
  ip_address: "192.168.1.10"
  netmask: "24"
  
target_hostname: "web01.web.local"

# /etc/ansible/host_vars/web02.yml
network_config:
  ip_address: "192.168.1.11" 
  netmask: "24"
  
target_hostname: "web02.web.local"
```

### 10.3 éƒ¨ç½²è„šæœ¬é›†æˆ


**âš™ï¸ ä¸€é”®éƒ¨ç½²è„šæœ¬**

```bash
#!/bin/bash
# /usr/local/bin/network-auto-deploy.sh

ANSIBLE_DIR="/etc/ansible"
PLAYBOOK="$ANSIBLE_DIR/playbooks/network-deployment.yml"
INVENTORY="$ANSIBLE_DIR/inventory/production"
LOG_DIR="/var/log/network-deployment"

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p "$LOG_DIR"

# éƒ¨ç½²å‡½æ•°
deploy_network_config() {
    local target_group="$1"
    local deployment_id="deploy-$(date +%Y%m%d-%H%M%S)"
    local log_file="$LOG_DIR/$deployment_id.log"
    
    echo "å¼€å§‹ç½‘ç»œé…ç½®éƒ¨ç½²..."
    echo "ç›®æ ‡: $target_group"
    echo "éƒ¨ç½²ID: $deployment_id"
    echo "æ—¥å¿—: $log_file"
    echo ""
    
    # æ‰§è¡Œéƒ¨ç½²å‰æ£€æŸ¥
    echo "æ‰§è¡Œéƒ¨ç½²å‰æ£€æŸ¥..."
    if ! ansible "$target_group" -i "$INVENTORY" -m ping >/dev/null 2>&1; then
        echo "âŒ éƒ¨ç½²å‰æ£€æŸ¥å¤±è´¥ï¼šç›®æ ‡ä¸»æœºä¸å¯è¾¾"
        return 1
    fi
    
    # æ‰§è¡ŒAnsibleéƒ¨ç½²
    echo "æ‰§è¡Œç½‘ç»œé…ç½®éƒ¨ç½²..."
    if ansible-playbook \
        -i "$INVENTORY" \
        -l "$target_group" \
        "$PLAYBOOK" \
        --extra-vars "deployment_id=$deployment_id" \
        --diff \
        | tee "$log_file"; then
        
        echo "âœ… ç½‘ç»œé…ç½®éƒ¨ç½²æˆåŠŸ"
        
        # æ‰§è¡Œéƒ¨ç½²åéªŒè¯
        echo ""
        echo "æ‰§è¡Œéƒ¨ç½²åéªŒè¯..."
        verify_deployment "$target_group"
        
        return 0
    else
        echo "âŒ ç½‘ç»œé…ç½®éƒ¨ç½²å¤±è´¥"
        echo "è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹: $log_file"
        return 1
    fi
}

# éªŒè¯éƒ¨ç½²ç»“æœ
verify_deployment() {
    local target_group="$1"
    
    echo "éªŒè¯éƒ¨ç½²ç»“æœ..."
    
    # è¿è¡ŒéªŒè¯playbook
    local verify_playbook="$ANSIBLE_DIR/playbooks/network-verify.yml"
    
    if [[ -f "$verify_playbook" ]]; then
        ansible-playbook \
            -i "$INVENTORY" \
            -l "$target_group" \
            "$verify_playbook"
    else
        # ç®€å•éªŒè¯
        echo "æ‰§è¡ŒåŸºæœ¬è¿é€šæ€§éªŒè¯..."
        ansible "$target_group" -i "$INVENTORY" \
            -m shell -a "ping -c 3 8.8.8.8 && echo 'Network OK' || echo 'Network FAIL'"
    fi
}

# å›æ»šéƒ¨ç½²
rollback_deployment() {
    local target_group="$1"
    local backup_timestamp="$2"
    
    echo "å›æ»šç½‘ç»œé…ç½®..."
    echo "ç›®æ ‡: $target_group"
    echo "å›æ»šåˆ°: $backup_timestamp"
    
    # æ‰§è¡Œå›æ»šplaybook
    ansible-playbook \
        -i "$INVENTORY" \
        -l "$target_group" \
        "$ANSIBLE_DIR/playbooks/network-rollback.yml" \
        --extra-vars "backup_timestamp=$backup_timestamp"
}

# åˆ—å‡ºå¯ç”¨çš„å¤‡ä»½
list_backups() {
    local target_host="$1"
    
    echo "å¯ç”¨çš„é…ç½®å¤‡ä»½ï¼š"
    ansible "$target_host" -i "$INVENTORY" \
        -m shell -a "ls -la /var/backups/network/ | tail -10"
}

# ä¸»é€»è¾‘
case "${1:-help}" in
    "deploy")
        if [[ -n "$2" ]]; then
            deploy_network_config "$2"
        else
            echo "è¯·æŒ‡å®šéƒ¨ç½²ç›®æ ‡ç»„"
            echo "å¯ç”¨ç»„: $(ansible-inventory -i $INVENTORY --list | jq -r 'keys[]' | grep -v '_meta')"
        fi
        ;;
    "verify")
        if [[ -n "$2" ]]; then
            verify_deployment "$2"
        else
            echo "è¯·æŒ‡å®šéªŒè¯ç›®æ ‡ç»„"
        fi
        ;;
    "rollback")
        if [[ -n "$2" ]] && [[ -n "$3" ]]; then
            rollback_deployment "$2" "$3"
        else
            echo "ç”¨æ³•: $0 rollback <target_group> <backup_timestamp>"
            echo "ä½¿ç”¨ '$0 list-backups <host>' æŸ¥çœ‹å¯ç”¨å¤‡ä»½"
        fi
        ;;
    "list-backups")
        if [[ -n "$2" ]]; then
            list_backups "$2"
        else
            echo "è¯·æŒ‡å®šä¸»æœºå"
        fi
        ;;
    "status")
        echo "éƒ¨ç½²æ—¥å¿—ç›®å½•: $LOG_DIR"
        echo "æœ€è¿‘çš„éƒ¨ç½²:"
        ls -lt "$LOG_DIR"/*.log 2>/dev/null | head -5
        ;;
    *)
        echo "ç½‘ç»œé…ç½®è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…·"
        echo ""
        echo "ç”¨æ³•: $0 {deploy|verify|rollback|list-backups|status}"
        echo ""
        echo "å‘½ä»¤è¯´æ˜:"
        echo "  deploy <group>           - éƒ¨ç½²ç½‘ç»œé…ç½®åˆ°æŒ‡å®šç»„"
        echo "  verify <group>           - éªŒè¯æŒ‡å®šç»„çš„ç½‘ç»œé…ç½®"
        echo "  rollback <group> <time>  - å›æ»šåˆ°æŒ‡å®šæ—¶é—´çš„å¤‡ä»½"
        echo "  list-backups <host>      - åˆ—å‡ºä¸»æœºçš„é…ç½®å¤‡ä»½"
        echo "  status                   - æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€"
        echo ""
        echo "ç¤ºä¾‹:"
        echo "  $0 deploy web_servers"
        echo "  $0 verify web_servers" 
        echo "  $0 rollback web01 1640995200"
        ;;
esac
```

### 10.4 CI/CDé›†æˆéƒ¨ç½²


**ğŸ”„ GitLab CI/CD Pipeline**

```yaml
# .gitlab-ci.yml
stages:
  - validate
  - test
  - deploy
  - verify

variables:
  ANSIBLE_HOST_KEY_CHECKING: "False"
  ANSIBLE_STDOUT_CALLBACK: "yaml"

# é…ç½®éªŒè¯é˜¶æ®µ
validate_config:
  stage: validate
  image: ansible/ansible:latest
  script:
    - echo "éªŒè¯Ansibleé…ç½®æ–‡ä»¶è¯­æ³•"
    - ansible-playbook --syntax-check playbooks/network-deployment.yml
    - echo "éªŒè¯YAMLæ–‡ä»¶æ ¼å¼"
    - find . -name "*.yml" -o -name "*.yaml" | xargs -I {} yamllint {}
  only:
    - merge_requests
    - main

# æµ‹è¯•ç¯å¢ƒéƒ¨ç½²
test_deploy:
  stage: test
  image: ansible/ansible:latest
  script:
    - echo "éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ"
    - ansible-playbook -i inventory/test playbooks/network-deployment.yml --check --diff
    - echo "åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯é…ç½®"
    - ansible-playbook -i inventory/test playbooks/network-verify.yml
  environment:
    name: test
  only:
    - merge_requests

# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
production_deploy:
  stage: deploy
  image: ansible/ansible:latest
  script:
    - echo "å¤‡ä»½å½“å‰ç”Ÿäº§é…ç½®"
    - ansible-playbook -i inventory/production playbooks/backup-config.yml
    - echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
    - ansible-playbook -i inventory/production playbooks/network-deployment.yml
  environment:
    name: production
    url: http://production.example.com
  when: manual
  only:
    - main

# éƒ¨ç½²åéªŒè¯
post_deploy_verify:
  stage: verify
  image: ansible/ansible:latest
  script:
    - echo "éªŒè¯ç”Ÿäº§ç¯å¢ƒç½‘ç»œé…ç½®"
    - ansible-playbook -i inventory/production playbooks/network-verify.yml
    - echo "æ‰§è¡Œç½‘ç»œæ€§èƒ½æµ‹è¯•"
    - ansible production -i inventory/production -m script -a "/tmp/network-performance-test.sh"
  environment:
    name: production
  dependencies:
    - production_deploy
  only:
    - main
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æŒä¹…åŒ–æœ¬è´¨ï¼šè®©ç½‘ç»œé…ç½®åœ¨é‡å¯åè‡ªåŠ¨æ¢å¤ï¼Œé¿å…æ‰‹åŠ¨é‡å¤è®¾ç½®
ğŸ”¸ é…ç½®æ–‡ä»¶ç®¡ç†ï¼šä¸åŒç³»ç»Ÿä½¿ç”¨ä¸åŒé…ç½®æ–¹å¼ï¼Œéœ€è¦ç†Ÿæ‚‰å„ç§æ ¼å¼
ğŸ”¸ æœåŠ¡ç®¡ç†ï¼šç†è§£ç½‘ç»œæœåŠ¡çš„é‡å¯ã€é‡è½½æœºåˆ¶å’ŒåŒºåˆ«
ğŸ”¸ å¤‡ä»½ç­–ç•¥ï¼šå®Œæ•´å¤‡ä»½åŒ…å«é…ç½®æ–‡ä»¶å’Œè¿è¡Œæ—¶çŠ¶æ€ä¿¡æ¯
ğŸ”¸ æ¨¡æ¿åŒ–ï¼šæ ‡å‡†åŒ–é…ç½®æ¨¡æ¿æé«˜éƒ¨ç½²æ•ˆç‡å’Œä¸€è‡´æ€§
ğŸ”¸ ç‰ˆæœ¬æ§åˆ¶ï¼šGitç®¡ç†é…ç½®å˜æ›´ï¼Œæ”¯æŒå›æ»šå’Œåä½œå¼€å‘
ğŸ”¸ è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼šä½¿ç”¨Ansibleç­‰å·¥å…·å®ç°å¤§è§„æ¨¡è‡ªåŠ¨åŒ–é…ç½®
```

### 11.2 å…³é”®å®è·µè¦ç‚¹


**ğŸ”¹ é…ç½®ç®¡ç†æœ€ä½³å®è·µ**
```
æ–‡ä»¶æƒé™å®‰å…¨ï¼š
- é…ç½®æ–‡ä»¶è®¾ç½®åˆé€‚æƒé™ï¼ˆ644ï¼‰
- é¿å…åœ¨é…ç½®æ–‡ä»¶ä¸­å­˜å‚¨æ˜æ–‡å¯†ç 
- å®šæœŸå®¡æ ¸é…ç½®æ–‡ä»¶è®¿é—®æƒé™

å¤‡ä»½ç­–ç•¥ï¼š
- å˜æ›´å‰å¿…é¡»å¤‡ä»½
- ä¿ç•™å¤šä¸ªç‰ˆæœ¬çš„å†å²å¤‡ä»½
- å¤‡ä»½åŒ…å«å®Œæ•´çš„è¿è¡Œæ—¶çŠ¶æ€
- å®šæœŸæµ‹è¯•å¤‡ä»½çš„å¯æ¢å¤æ€§
```

**ğŸ”¹ è‡ªåŠ¨åŒ–éƒ¨ç½²åŸåˆ™**
```
æ¸è¿›å¼éƒ¨ç½²ï¼š
- å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- åˆ†æ‰¹æ¬¡æ»šåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- æ¯ä¸ªæ‰¹æ¬¡åè¿›è¡ŒéªŒè¯

å¿«é€Ÿå›æ»šæœºåˆ¶ï¼š
- ä¿æŒä¸Šä¸€ç‰ˆæœ¬çš„å®Œæ•´å¤‡ä»½
- é¢„è®¾å›æ»šè„šæœ¬å’Œæµç¨‹
- å»ºç«‹å‘Šè­¦å’Œç›‘æ§æœºåˆ¶
```

### 11.3 æ•…éšœå¤„ç†ç­–ç•¥


**ğŸ”§ å¸¸è§é—®é¢˜è§£å†³æ€è·¯**

| é—®é¢˜ç±»å‹ | æ’æŸ¥æ–¹æ³• | è§£å†³æ–¹æ¡ˆ |
|---------|---------|----------|
| **é…ç½®ä¸ç”Ÿæ•ˆ** | æ£€æŸ¥è¯­æ³•ã€æƒé™ã€æœåŠ¡çŠ¶æ€ | é‡æ–°åº”ç”¨é…ç½®ã€é‡å¯æœåŠ¡ |
| **ç½‘ç»œä¸­æ–­** | æ£€æŸ¥æ¥å£çŠ¶æ€ã€è·¯ç”±è¡¨ | ä½¿ç”¨å¤‡ä»½é…ç½®å¿«é€Ÿæ¢å¤ |
| **DNSè§£æå¤±è´¥** | æ£€æŸ¥resolv.confã€ç½‘ç»œè¿é€š | é‡ç½®DNSé…ç½®ã€æ£€æŸ¥æœåŠ¡å™¨ |
| **æ‰¹é‡éƒ¨ç½²å¤±è´¥** | æ£€æŸ¥è¿é€šæ€§ã€æƒé™ã€é…ç½®è¯­æ³• | åˆ†æ‰¹å¤„ç†ã€å•ç‹¬æ’æŸ¥å¤±è´¥èŠ‚ç‚¹ |

### 11.4 ç›‘æ§å’Œç»´æŠ¤


**ğŸ“Š æŒç»­ç›‘æ§è¦ç‚¹**
```
å…³é”®æŒ‡æ ‡ç›‘æ§ï¼š
âœ… ç½‘ç»œæ¥å£çŠ¶æ€å’Œæµé‡
âœ… è·¯ç”±è¡¨å˜åŒ–
âœ… DNSè§£ææ€§èƒ½
âœ… ç½‘ç»œè¿é€šæ€§æµ‹è¯•
âœ… é…ç½®æ–‡ä»¶å®Œæ•´æ€§

å‘Šè­¦é˜ˆå€¼è®¾ç½®ï¼š
âœ… ç½‘ç»œä¸­æ–­ç«‹å³å‘Šè­¦
âœ… DNSè§£æå»¶è¿Ÿè¶…è¿‡é˜ˆå€¼å‘Šè­¦  
âœ… é…ç½®æ–‡ä»¶å¼‚å¸¸å˜æ›´å‘Šè­¦
âœ… æ‰¹é‡éƒ¨ç½²å¤±è´¥å‘Šè­¦
```

### 11.5 æŠ€èƒ½è¿›é˜¶å»ºè®®


**ğŸ¯ æ·±å…¥å­¦ä¹ æ–¹å‘**
```
å·¥å…·æ·±åº¦æŒæ¡ï¼š
- Ansibleé«˜çº§ç‰¹æ€§å’Œæœ€ä½³å®è·µ
- Gitåˆ†æ”¯ç®¡ç†å’Œåˆå¹¶ç­–ç•¥
- ç›‘æ§å‘Šè­¦ç³»ç»Ÿé›†æˆ

ç½‘ç»œæŠ€æœ¯æ‰©å±•ï¼š
- å¤æ‚ç½‘ç»œæ‹“æ‰‘é…ç½®
- ç½‘ç»œå®‰å…¨ç­–ç•¥ç®¡ç†  
- å®¹å™¨ç½‘ç»œé…ç½®è‡ªåŠ¨åŒ–
- äº‘å¹³å°ç½‘ç»œæœåŠ¡é›†æˆ
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- ç½‘ç»œé…ç½®æŒä¹…åŒ–æ˜¯è¿ç»´è‡ªåŠ¨åŒ–çš„åŸºç¡€
- å¤‡ä»½å’Œç‰ˆæœ¬æ§åˆ¶æ˜¯é…ç½®ç®¡ç†çš„å®‰å…¨ç½‘
- æ¨¡æ¿åŒ–å’Œè‡ªåŠ¨åŒ–æé«˜å¤§è§„æ¨¡éƒ¨ç½²æ•ˆç‡
- éªŒè¯å’Œç›‘æ§ç¡®ä¿é…ç½®å˜æ›´çš„å¯é æ€§
- å·¥å…·é“¾æ•´åˆå½¢æˆå®Œæ•´çš„é…ç½®ç®¡ç†ä½“ç³»