---
title: 4、匹配条件与规则设置
---
## 📚 目录

1. [iptables匹配条件概述](#1-iptables匹配条件概述)
2. [基础匹配条件详解](#2-基础匹配条件详解)
3. [扩展匹配模块](#3-扩展匹配模块)
4. [多条件组合匹配](#4-多条件组合匹配)
5. [实际应用场景](#5-实际应用场景)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🎯 iptables匹配条件概述


### 1.1 什么是匹配条件

🔥 **必须掌握**

**简单理解**：匹配条件就是告诉防火墙"什么样的网络包要被处理"

```
生活类比：
就像门卫检查访客一样
- 看证件（IP地址）
- 看来访时间（时间匹配）  
- 看访问目的（端口）
- 看走哪个门（网卡接口）
```

**匹配条件的作用**：
- 🎯 **精确筛选**：只对符合条件的数据包执行动作
- 🔒 **安全控制**：实现细粒度的访问控制
- ⚡ **性能优化**：避免处理无关数据包

### 1.2 匹配条件分类


**📋 两大类别**：

| 类型 | **说明** | **特点** | **举例** |
|------|----------|----------|----------|
| 🔸 **基础匹配** | `iptables内置的条件` | `不需要加载模块` | `IP地址、端口、协议` |
| 🔸 **扩展匹配** | `通过模块实现的条件` | `需要-m参数加载` | `状态匹配、时间匹配` |

---

## 2. ⚙️ 基础匹配条件详解


### 2.1 接口匹配（网卡匹配）


**🔌 什么是接口匹配**

接口就是网卡，比如eth0（有线网卡）、wlan0（无线网卡）、lo（本地回环）

```
网络数据包的流动路径：
外网 → eth0网卡 → 防火墙 → 应用程序
     ↑
   这里可以匹配
```

#### 2.1.1 输入接口匹配（-i）


**语法格式**：
```bash
-i 接口名    # 匹配从指定接口进入的数据包
```

**⭐⭐ 进阶级** - **实际应用**：

```bash
# 只允许从内网网卡(eth1)访问SSH
iptables -A INPUT -i eth1 -p tcp --dport 22 -j ACCEPT

# 拒绝从外网网卡(eth0)的所有访问
iptables -A INPUT -i eth0 -j DROP
```

💡 **理解要点**：
- `-i`只能用在`INPUT`和`FORWARD`链中
- 因为只有进入的包才有"来源接口"的概念

#### 2.1.2 输出接口匹配（-o）


**语法格式**：
```bash
-o 接口名    # 匹配从指定接口发出的数据包
```

**实际应用**：
```bash
# 限制只能从eth0发出HTTP请求
iptables -A OUTPUT -o eth0 -p tcp --dport 80 -j ACCEPT

# 禁止从无线网卡发出任何数据
iptables -A OUTPUT -o wlan0 -j DROP
```

**🧠 记忆技巧**：
- `-i`：**i**n（进入），用于INPUT
- `-o`：**o**ut（出去），用于OUTPUT

### 2.2 协议匹配（-p）


**🌐 什么是协议**

协议就是网络通信的"语言规则"，不同服务使用不同协议：

```
常用协议对应关系：
TCP  ← 网页浏览、文件下载、SSH
UDP  ← 视频直播、DNS查询、游戏
ICMP ← ping命令、网络诊断
```

#### 2.2.1 TCP协议匹配


**🔥 必须掌握**

```bash
# 匹配所有TCP协议的数据包
iptables -A INPUT -p tcp -j ACCEPT

# 匹配特定TCP端口（SSH服务）
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```

**TCP协议特点**：
- ✅ **可靠传输**：保证数据完整到达
- 📱 **适用场景**：网页、邮件、文件传输

#### 2.2.2 UDP协议匹配  


```bash
# 允许DNS查询（UDP 53端口）
iptables -A INPUT -p udp --dport 53 -j ACCEPT

# 允许DHCP客户端请求
iptables -A INPUT -p udp --dport 68 -j ACCEPT
```

**UDP协议特点**：
- ⚡ **快速传输**：不保证可靠性，但速度快
- 🎮 **适用场景**：游戏、直播、DNS查询

#### 2.2.3 ICMP协议匹配


```bash
# 允许ping命令
iptables -A INPUT -p icmp -j ACCEPT

# 只允许ping回应，禁止主动ping
iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT
```

### 2.3 IP地址匹配


**🏠 什么是IP地址匹配**

IP地址就像网络世界的门牌号，用来标识不同的设备

#### 2.3.1 源IP地址匹配（-s）


**语法格式**：
```bash
-s IP地址/子网    # 匹配来源IP地址
```

**⭐ 入门级** - **基础用法**：

```bash
# 允许特定IP访问
iptables -A INPUT -s 192.168.1.100 -j ACCEPT

# 允许整个内网段访问
iptables -A INPUT -s 192.168.1.0/24 -j ACCEPT

# 拒绝某个IP访问
iptables -A INPUT -s 192.168.1.50 -j DROP
```

**📊 子网掩码说明**：
```
192.168.1.0/24 表示：
- 网络部分：192.168.1（前24位）
- 主机部分：0-255（后8位）
- 包含IP：192.168.1.1 到 192.168.1.254
```

#### 2.3.2 目标IP地址匹配（-d）


```bash
# 限制只能访问内网Web服务器
iptables -A OUTPUT -d 192.168.1.10 -p tcp --dport 80 -j ACCEPT

# 禁止访问某个恶意网站
iptables -A OUTPUT -d 192.168.1.200 -j DROP
```

### 2.4 端口匹配


**🚪 什么是端口**

端口就像建筑物的不同房间号，不同服务占用不同端口：

```
常用端口对照表：
端口22  ← SSH远程登录
端口80  ← HTTP网页服务  
端口443 ← HTTPS加密网页
端口53  ← DNS域名解析
端口21  ← FTP文件传输
```

#### 2.4.1 源端口匹配（--sport）


**⭐⭐ 进阶级**

```bash
# 只允许从1024以上端口发起连接（普通用户端口）
iptables -A INPUT -p tcp --sport 1024:65535 -j ACCEPT

# 拒绝从特权端口发起的连接
iptables -A INPUT -p tcp --sport 1:1023 -j DROP
```

#### 2.4.2 目标端口匹配（--dport）


**🔥 必须掌握**

```bash
# 允许SSH访问
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 允许Web服务（HTTP和HTTPS）
iptables -A INPUT -p tcp --dport 80 -j ACCEPT  
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 允许端口范围（FTP被动模式）
iptables -A INPUT -p tcp --dport 20000:20100 -j ACCEPT
```

**💡 端口范围语法**：
- `--dport 80`：单个端口
- `--dport 80:90`：端口范围80-90
- `--dport :1023`：1-1023端口
- `--dport 1024:`：1024以上端口

---

## 3. 🔧 扩展匹配模块


### 3.1 状态匹配（-m state）


**🎯 什么是连接状态**

网络连接就像打电话，有不同的状态：

```
连接状态类比：
NEW        ← 第一次拨号（新建连接）
ESTABLISHED← 通话中（已建立连接）  
RELATED    ← 相关通话（如FTP数据连接）
INVALID    ← 无效通话（异常连接）
```

#### 3.1.1 基本状态类型


**⭐⭐⭐ 高级** - **状态详解**：

| 状态 | **含义** | **应用场景** |
|------|----------|--------------|
| 🟢 **NEW** | `首次连接请求` | `客户端发起新连接` |
| 🔵 **ESTABLISHED** | `已建立的连接` | `正常通信数据包` |
| 🟡 **RELATED** | `相关连接` | `FTP数据传输、ICMP错误` |
| 🔴 **INVALID** | `无效连接` | `异常或损坏的数据包` |

#### 3.1.2 实际应用示例


```bash
# 允许所有出去的连接，只允许相关的回来
iptables -A OUTPUT -j ACCEPT
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 只允许内网发起新的SSH连接
iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 22 -m state --state NEW -j ACCEPT

# 丢弃所有无效连接
iptables -A INPUT -m state --state INVALID -j DROP
```

**🚨 注意事项**：
> ⚠️ **重要提醒**：状态匹配需要加载连接跟踪模块，会消耗一定系统资源

### 3.2 时间匹配（-m time）


**⏰ 什么是时间匹配**

时间匹配可以根据时间段控制网络访问，比如上班时间才能上网

#### 3.2.1 时间段匹配


```bash
# 工作时间（9:00-18:00）才允许上网
iptables -A OUTPUT -p tcp --dport 80 -m time --timestart 09:00 --timestop 18:00 -j ACCEPT

# 晚上禁止游戏（假设游戏端口8080）
iptables -A OUTPUT -p tcp --dport 8080 -m time --timestart 22:00 --timestop 06:00 -j DROP
```

#### 3.2.2 星期匹配


```bash  
# 工作日才允许访问某服务
iptables -A INPUT -p tcp --dport 3389 -m time --weekdays Mon,Tue,Wed,Thu,Fri -j ACCEPT

# 周末禁止办公软件连接
iptables -A OUTPUT -p tcp --dport 443 -m time --weekdays Sat,Sun -j DROP
```

**📅 星期缩写对照**：
- Mon（周一）、Tue（周二）、Wed（周三）、Thu（周四）
- Fri（周五）、Sat（周六）、Sun（周日）

### 3.3 其他常用扩展匹配


#### 3.3.1 多端口匹配（-m multiport）


**⭐⭐ 进阶级** - **批量端口操作**：

```bash
# 同时开放多个Web相关端口
iptables -A INPUT -p tcp -m multiport --dports 80,443,8080,8443 -j ACCEPT

# 限制多个危险端口
iptables -A INPUT -p tcp -m multiport --dports 135,139,445 -j DROP
```

#### 3.3.2 字符串匹配（-m string）


```bash
# 阻止包含特定内容的HTTP请求
iptables -A INPUT -p tcp --dport 80 -m string --string "malware" --algo bm -j DROP

# 阻止特定的用户代理
iptables -A INPUT -p tcp --dport 80 -m string --string "BadBot" --algo kmp -j DROP
```

---

## 4. 🔄 多条件组合匹配


### 4.1 逻辑AND组合（默认）


**📝 基本概念**：

默认情况下，多个条件之间是**AND**关系，即所有条件都要满足

```
条件组合逻辑：
条件A AND 条件B AND 条件C = 全部满足才匹配
```

#### 4.1.1 基础组合示例


**⭐ 入门级**：

```bash
# 只允许内网通过SSH访问（IP + 协议 + 端口）
iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 22 -j ACCEPT

# 工作时间内网才能上网（时间 + IP + 协议）
iptables -A OUTPUT -s 192.168.1.0/24 -p tcp --dport 80 -m time --timestart 09:00 --timestop 18:00 -j ACCEPT
```

#### 4.1.2 复杂组合示例


**⭐⭐⭐ 高级**：

```bash
# 复合条件：特定IP在工作时间通过特定接口访问Web服务
iptables -A INPUT -i eth1 -s 192.168.1.100 -p tcp --dport 80 -m time --weekdays Mon,Tue,Wed,Thu,Fri --timestart 09:00 --timestop 18:00 -m state --state NEW,ESTABLISHED -j ACCEPT
```

**条件分解说明**：
- `-i eth1`：从内网接口进入
- `-s 192.168.1.100`：来源是特定IP
- `-p tcp --dport 80`：TCP协议的80端口  
- `time`模块：工作日的上班时间
- `state`模块：新建或已建立的连接

### 4.2 取反匹配（！操作符）


**🔄 什么是取反**

取反就是"相反"的意思，用`!`符号表示

```bash
# 除了SSH端口，其他都拒绝
iptables -A INPUT -p tcp ! --dport 22 -j DROP

# 拒绝除内网外的所有IP
iptables -A INPUT ! -s 192.168.1.0/24 -j DROP

# 非工作时间禁止上网
iptables -A OUTPUT -p tcp --dport 80 -m time ! --timestart 09:00 --timestop 18:00 -j DROP
```

**🧠 记忆技巧**：
- `!`放在条件前面
- 表示"不是"、"除了"、"相反"

### 4.3 实际业务场景组合


#### 4.3.1 Web服务器防护


```bash
# 只允许HTTP/HTTPS访问，且限制连接数
iptables -A INPUT -p tcp -m multiport --dports 80,443 -m state --state NEW,ESTABLISHED -m connlimit --connlimit-above 50 -j DROP
iptables -A INPUT -p tcp -m multiport --dports 80,443 -m state --state NEW,ESTABLISHED -j ACCEPT
```

#### 4.3.2 办公网络管理


```bash
# 管理员IP可以随时SSH，普通用户只能工作时间
iptables -A INPUT -s 192.168.1.10 -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 22 -m time --timestart 08:00 --timestop 20:00 --weekdays Mon,Tue,Wed,Thu,Fri -j ACCEPT
```

---

## 5. 🎯 实际应用场景


### 5.1 家用路由器场景


**📱 需求**：控制孩子上网时间，保护家庭网络安全

```bash
# 孩子设备只能在指定时间上网
iptables -A FORWARD -s 192.168.1.50 -p tcp --dport 80 -m time --timestart 19:00 --timestop 21:00 --weekdays Mon,Tue,Wed,Thu,Fri -j ACCEPT
iptables -A FORWARD -s 192.168.1.50 -p tcp --dport 80 -j DROP

# 阻止访问游戏服务器
iptables -A FORWARD -p tcp --dport 8080 -m string --string "game.example.com" --algo bm -j DROP
```

### 5.2 企业服务器场景


**🏢 需求**：保护服务器安全，实现分级访问控制

```bash
# 数据库服务器只允许Web服务器访问
iptables -A INPUT -s 192.168.1.10 -p tcp --dport 3306 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -p tcp --dport 3306 -j DROP

# 管理端口只允许办公时间访问
iptables -A INPUT -s 192.168.100.0/24 -p tcp --dport 22 -m time --timestart 08:00 --timestop 20:00 -j ACCEPT
```

### 5.3 个人电脑场景


**💻 需求**：防止恶意软件，控制网络流量

```bash
# 阻止向外发送敏感端口数据
iptables -A OUTPUT -p tcp -m multiport --dports 25,465,587 ! -d 192.168.1.0/24 -j DROP

# 只允许知名DNS服务器
iptables -A OUTPUT -p udp --dport 53 -d 8.8.8.8 -j ACCEPT
iptables -A OUTPUT -p udp --dport 53 -d 114.114.114.114 -j ACCEPT  
iptables -A OUTPUT -p udp --dport 53 -j DROP
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的基础匹配


**🔥 核心匹配条件**：
```
接口匹配：-i（入）/-o（出）
协议匹配：-p tcp/udp/icmp
地址匹配：-s（源）/-d（目标）
端口匹配：--sport（源）/--dport（目标）
```

### 6.2 重要的扩展匹配


**⚡ 实用扩展模块**：
```
状态匹配：-m state --state NEW,ESTABLISHED,RELATED
时间匹配：-m time --timestart/--timestop/--weekdays
多端口：-m multiport --dports 80,443,8080
字符串：-m string --string "关键字" --algo bm
```

### 6.3 匹配条件组合规则


**🎯 组合原则**：
- **默认AND**：多条件同时满足
- **取反操作**：用`!`表示相反条件  
- **优先级**：越具体的条件越优先
- **性能考虑**：常用条件放前面

### 6.4 最佳实践建议


> ✨ **推荐做法**：
> - 从最严格的规则开始写
> - 善用状态匹配减少规则数量
> - 时间匹配用于访问控制
> - 定期清理无用规则

> 🚫 **避免做法**：
> - 不要写过于复杂的单条规则
> - 避免大量使用字符串匹配（影响性能）
> - 不要忘记配置默认策略

**🔑 记忆要点**：
- **接口**：控制数据包从哪来到哪去
- **协议**：控制使用什么通信方式  
- **地址**：控制谁能访问谁
- **端口**：控制访问什么服务
- **状态**：控制连接的生命周期
- **时间**：控制什么时候能访问

**核心理念**：iptables的匹配条件就是在回答"**什么样的网络包**需要被**如何处理**"，通过精确的条件匹配，实现灵活而安全的网络访问控制。