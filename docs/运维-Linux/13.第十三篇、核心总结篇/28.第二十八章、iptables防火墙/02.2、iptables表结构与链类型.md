---
title: 2、iptables表结构与链类型
---
## 📚 目录


1. [iptables基础架构概述](#1-iptables基础架构概述)
2. [filter表（过滤表）](#2-filter表过滤表)
3. [nat表（网络地址转换表）](#3-nat表网络地址转换表)
4. [mangle表（数据包修改表）](#4-mangle表数据包修改表)
5. [raw表（原始数据包表）](#5-raw表原始数据包表)
6. [security表（SELinux安全表）](#6-security表selinux安全表)
7. [链类型详解](#7-链类型详解)
8. [表与链的关系](#8-表与链的关系)
9. [数据包处理流程](#9-数据包处理流程)
10. [核心要点总结](#10-核心要点总结)

---

# 🎯 **学习路径导航**


**前置知识**：需要掌握Linux网络基础、TCP/IP协议 → **当前内容**：iptables表结构与链类型 → **后续学习**：建议学习iptables规则语法与配置

⏱️ **预计学习时间**：本章预计45分钟 | 实践练习30分钟

🏷️ **知识标签**：`#防火墙` `#网络安全` `#Linux系统管理` `#必掌握`

---

## 1. 🏗️ iptables基础架构概述



### 1.1 什么是iptables



**🔸 核心定义**
```
iptables：Linux系统的网络防火墙工具
本质：基于netfilter框架的用户空间配置工具
作用：控制进出系统的网络数据包
位置：工作在内核空间，处理所有网络流量
```

**💡 通俗理解**
把iptables想象成小区的**安保系统**：
- **小区大门**：所有人员车辆都要经过检查
- **安保规则**：根据不同情况执行不同的处理方式
- **多道关卡**：可以设置多个检查点，层层把关
- **分类处理**：访客、业主、快递员走不同的通道

### 1.2 表和链的基本概念



**📋 核心概念解释**
```
表（Table）：存放规则的容器，按功能分类
- 就像不同用途的文件夹
- 每个表负责特定的网络处理任务

链（Chain）：规则的执行顺序，按处理时机分类  
- 就像流水线上的不同工位
- 数据包按顺序经过各个链进行处理
```

**🏷️ 五大表概览**

| **表名** | **主要功能** | **使用频率** | **典型应用** |
|---------|-------------|-------------|-------------|
| **filter** | `数据包过滤` | ⭐⭐⭐⭐⭐ | `防火墙规则、访问控制` |
| **nat** | `地址转换` | ⭐⭐⭐⭐ | `端口映射、IP伪装` |
| **mangle** | `包头修改` | ⭐⭐ | `QoS流量控制、标记` |
| **raw** | `连接跟踪` | ⭐ | `性能优化、特殊场景` |
| **security** | `SELinux标记` | ⭐ | `强制访问控制` |

---

## 2. 🛡️ filter表（过滤表）



### 2.1 filter表的作用



**🎯 核心功能**
filter表是iptables的**默认表**，主要负责：
- **数据包过滤**：决定允许或拒绝数据包通过
- **访问控制**：控制哪些服务可以被访问
- **安全防护**：阻止恶意网络连接

**💡 生活类比**
filter表就像**海关检查**：
- 检查每个"旅客"（数据包）的"身份证"（源IP、目标IP）
- 根据"入境规则"决定是否允许通过
- 不合规的直接拒绝入境

### 2.2 filter表包含的链



**📊 filter表的三条链**

```
INPUT链：处理进入本机的数据包
┌─────────────────┐
│   外部网络      │ ──→ INPUT链 ──→ 本机应用程序
└─────────────────┘

OUTPUT链：处理本机发出的数据包  
本机应用程序 ──→ OUTPUT链 ──→ 外部网络

FORWARD链：处理转发的数据包
网络A ──→ FORWARD链 ──→ 网络B
```

### 2.3 filter表典型应用场景



**🔸 常见用途**
- **SSH访问控制**：只允许特定IP访问SSH服务
- **Web服务保护**：控制对HTTP/HTTPS的访问
- **端口封锁**：关闭不需要的网络端口
- **IP黑名单**：阻止恶意IP地址访问

> 💭 **思考问题**
> 💡 为什么filter表是默认表？因为防火墙最基本的功能就是过滤，这是网络安全的第一道防线。

---

## 3. 🔄 nat表（网络地址转换表）



### 3.1 nat表的核心作用



**🔸 主要功能**
nat表负责**网络地址转换**（NAT - Network Address Translation）：
- **SNAT**：源地址转换，改变数据包的源IP
- **DNAT**：目标地址转换，改变数据包的目标IP
- **MASQUERADE**：动态源地址伪装
- **REDIRECT**：本地重定向

**🏠 家庭网络类比**
想象你家的**路由器**：
- **家里设备**：都用192.168.1.x的内网IP
- **访问互联网**：路由器把内网IP转换成公网IP
- **外网回复**：路由器再把公网IP转回对应的内网IP
- **这就是NAT**：一个公网IP让多台设备上网

### 3.2 nat表包含的链



**📋 nat表的三条主要链**

```
PREROUTING链：数据包进入时的地址转换
外部 ──→ [PREROUTING] ──→ 路由决策 ──→ 内部

POSTROUTING链：数据包发出时的地址转换  
内部 ──→ 路由决策 ──→ [POSTROUTING] ──→ 外部

OUTPUT链：本机产生的数据包地址转换
本机程序 ──→ [OUTPUT] ──→ 外部网络
```

### 3.3 nat表实际应用



**🌐 典型使用场景**
- **家庭路由器**：多台设备共享一个公网IP上网
- **企业网关**：内网员工通过NAT访问互联网
- **端口映射**：外网访问内网的Web服务器
- **负载均衡**：将请求分发到多台后端服务器

> 🔍 **深入理解**
> 🤔 为什么需要NAT？因为IPv4地址不够用，NAT让有限的公网IP服务更多的设备。

---

## 4. 🔧 mangle表（数据包修改表）



### 4.1 mangle表的特殊用途



**🔸 核心功能**
mangle表用于**修改数据包**，主要包括：
- **TOS字段修改**：改变服务类型，影响路由优先级
- **TTL字段修改**：改变生存时间
- **MARK标记**：给数据包打标记，供其他程序使用
- **DSCP标记**：流量分类和优先级控制

**🏃‍♂️ 快递分拣类比**
mangle表像**快递分拣中心**：
- **普通包裹**：正常速度处理
- **加急件**：打上"急"标签，优先处理
- **贵重物品**：打上"小心"标签，特殊处理
- **不同目的地**：根据标记走不同的传送带

### 4.2 mangle表的五条链



**📊 mangle表链结构**

| **链名** | **处理时机** | **主要用途** |
|---------|-------------|-------------|
| **PREROUTING** | `路由前` | `入站包标记和修改` |
| **INPUT** | `进入本机前` | `本机接收包处理` |
| **FORWARD** | `转发时` | `转发包标记修改` |
| **OUTPUT** | `本机发出时` | `出站包标记修改` |
| **POSTROUTING** | `路由后` | `最终发送前修改` |

### 4.3 mangle表应用场景



**⚡ 实际用途**
- **QoS流量控制**：对不同类型流量进行优先级标记
- **带宽管理**：配合tc工具实现流量整形
- **负载均衡**：标记数据包实现复杂的负载分发
- **网络监控**：标记特定流量便于统计分析

---

## 5. 🎯 raw表（原始数据包表）



### 5.1 raw表的特殊地位



**🔸 优先级最高**
raw表是**第一个处理数据包**的表：
- **连接跟踪控制**：决定是否跟踪连接状态
- **性能优化**：跳过不需要的连接跟踪
- **特殊处理**：对某些数据包进行特殊标记

**🚥 交通指挥类比**
raw表像**交通第一岗**：
- **所有车辆**：都要先过这个检查点
- **快速通道**：VIP车辆可以标记为"不查车"
- **普通通道**：需要详细检查的正常排队
- **节省资源**：减少不必要的重复检查

### 5.2 raw表包含的链



**📋 raw表的两条链**

```
PREROUTING链：最早处理进入的数据包
网络接口 ──→ [raw PREROUTING] ──→ 连接跟踪 ──→ 其他表

OUTPUT链：最早处理本机发出的数据包
本机应用 ──→ [raw OUTPUT] ──→ 连接跟踪 ──→ 其他表
```

### 5.3 raw表典型应用



**⚡ 性能优化场景**
- **高并发服务器**：跳过大量短连接的状态跟踪
- **DNS服务器**：UDP查询不需要连接跟踪
- **代理服务器**：减少连接跟踪的内存开销

---

## 6. 🔒 security表（SELinux安全表）



### 6.1 security表的作用



**🔸 SELinux集成**
security表专门为**SELinux强制访问控制**服务：
- **安全上下文标记**：给数据包打上SELinux标签
- **强制访问控制**：基于安全策略控制网络访问
- **多级安全**：支持机密性分级保护

> ⚠️ **使用提醒**
> 只有启用SELinux的系统才会用到security表，一般企业环境较少使用。

---

## 7. 🔗 链类型详解



## 7.1 数据流向链



**📊 三大流向链**

```
INPUT链 - 外部到本机
┌─────────┐    ┌─────────┐
│ 互联网  │───→│ INPUT   │───→ 本机服务
└─────────┘    └─────────┘

OUTPUT链 - 本机到外部  
本机程序 ───→ OUTPUT ───→ 互联网

FORWARD链 - 经过本机转发
网络A ───→ FORWARD ───→ 网络B
```

**💡 记忆技巧**
- **INPUT**：**进**入本机 → **I**n
- **OUTPUT**：**出**去本机 → **O**ut  
- **FORWARD**：**转**发通过 → **F**orward

## 7.2 处理时机链



**📋 两大时机链**

```
PREROUTING链：路由决策之前
数据包进入 ──→ [PREROUTING] ──→ 路由表查询 ──→ 决定去向

POSTROUTING链：路由决策之后
路由决策 ──→ [POSTROUTING] ──→ 发送到网络接口
```

**🎯 关键理解**
- **PREROUTING**：还不知道数据包要去哪里
- **POSTROUTING**：已经知道从哪个接口发出去

---

## 8. 🔄 表与链的关系



### 8.1 表链对应关系



**📊 完整对应表**

| **表名** | **PREROUTING** | **INPUT** | **FORWARD** | **OUTPUT** | **POSTROUTING** |
|---------|---------------|-----------|-------------|------------|-----------------|
| **raw** | ✅ | ❌ | ❌ | ✅ | ❌ |
| **mangle** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **nat** | ✅ | ❌ | ❌ | ✅ | ✅ |
| **filter** | ❌ | ✅ | ✅ | ✅ | ❌ |
| **security** | ❌ | ✅ | ✅ | ✅ | ❌ |

### 8.2 链的处理顺序



**⚡ 同一链中表的优先级**
```
数据包处理顺序（从高到低）：
1. raw表      ← 最先处理
2. mangle表   
3. nat表      
4. filter表   
5. security表 ← 最后处理
```

> 💭 **思考问题**
> 💡 为什么raw表优先级最高？因为它决定是否要跟踪连接，这个决定会影响后续所有的处理。

---

## 9. 🌊 数据包处理流程



### 9.1 完整处理流程图



```
数据包到达网卡
         │
         ▼
┌─────────────────┐
│  raw表          │ ── PREROUTING链
│  mangle表       │    (决定是否跟踪连接)
│  nat表          │    (目标地址转换)
└─────────────────┘
         │
         ▼
     路由决策
    ┌────┴────┐
    │         │
    ▼         ▼
转发给其他主机   发给本机
    │         │
    ▼         ▼
┌─────────┐ ┌─────────┐
│FORWARD链│ │INPUT链  │
│mangle表 │ │mangle表 │
│filter表 │ │filter表 │
│security表│ │security表│
└─────────┘ └─────────┘
    │         │
    ▼         ▼
┌─────────┐   本机应用程序
│POSTROUTING│      │
│mangle表 │      │
│nat表    │      ▼
└─────────┘ ┌─────────┐
    │       │OUTPUT链 │
    │       │raw表    │
    │       │mangle表 │
    │       │nat表    │
    │       │filter表 │
    │       │security表│
    │       └─────────┘
    │           │
    └───────────┘
         │
         ▼
    发送到网络接口
```

### 9.2 三种典型场景



**🔸 场景一：访问本机服务**
外部客户端访问本机Web服务器
```
客户端 → 网卡 → PREROUTING → 路由 → INPUT → Web服务器
```

**🔸 场景二：本机访问外部**
本机程序访问外部网站
```
本机程序 → OUTPUT → 路由 → POSTROUTING → 网卡 → 外部网站
```

**🔸 场景三：网关转发**
本机作为路由器转发数据包
```
网络A → 网卡1 → PREROUTING → 路由 → FORWARD → POSTROUTING → 网卡2 → 网络B
```

---

## 10. 📋 核心要点总结



### 10.1 必须掌握的核心概念



```
🔸 五大表功能：filter过滤、nat转换、mangle修改、raw控制、security安全
🔸 五条链作用：INPUT进入、OUTPUT输出、FORWARD转发、PRE/POST路由前后
🔸 处理顺序：raw→mangle→nat→filter→security
🔸 数据流向：根据路由决策走不同的链和表
🔸 实际应用：每个表都有特定的使用场景
```

### 10.2 关键理解要点



**🔹 表和链的本质区别**
```
表（Table）：
- 按功能分类的规则容器
- 每个表负责特定类型的处理
- 就像不同部门各司其职

链（Chain）：
- 按处理时机分类的执行点
- 数据包流经的不同阶段
- 就像流水线的不同工位
```

**🔹 为什么要分表分链**
```
分表的好处：
- 功能模块化，便于管理
- 规则分类，提高效率
- 避免规则冲突

分链的好处：
- 按处理时机执行
- 避免重复处理
- 提高处理效率
```

### 10.3 实际应用指导



**🎯 表的选择原则**
- **简单防火墙**：主要使用filter表
- **网关路由器**：重点配置nat表
- **流量控制**：配合使用mangle表
- **高性能场景**：考虑raw表优化

**🛠️ 配置顺序建议**
1. **先规划**：明确网络拓扑和安全需求
2. **选对表**：根据功能需求选择合适的表
3. **定好链**：确定在哪个链设置规则
4. **测试验证**：规则生效后要充分测试

### 10.4 学习检查清单



- [ ] 能说出五个表的主要功能
- [ ] 理解五条链的处理时机  
- [ ] 掌握数据包的完整处理流程
- [ ] 知道不同场景选择哪个表
- [ ] 了解表和链的对应关系

**🔑 核心记忆口诀**
> 五表功能要分清：filter过滤nat转换
> 五链时机要记牢：输入输出加转发  
> 处理顺序有规律：raw先行security后
> 路由决策是关键：决定数据包去向

**💡 延伸学习建议**
- 动手实践各种iptables命令
- 学习具体的规则语法和匹配条件
- 了解iptables与其他防火墙工具的对比
- 研究企业级防火墙解决方案