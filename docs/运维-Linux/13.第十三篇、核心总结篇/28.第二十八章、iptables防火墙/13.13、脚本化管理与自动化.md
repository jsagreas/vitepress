---
title: 13ã€è„šæœ¬åŒ–ç®¡ç†ä¸è‡ªåŠ¨åŒ–
---
## ğŸ“š ç›®å½•

1. [è„šæœ¬åŒ–ç®¡ç†æ¦‚è¿°](#1-è„šæœ¬åŒ–ç®¡ç†æ¦‚è¿°)
2. [é˜²ç«å¢™è„šæœ¬ç¼–å†™å®æˆ˜](#2-é˜²ç«å¢™è„šæœ¬ç¼–å†™å®æˆ˜)
3. [è§„åˆ™å¯¼å…¥å¯¼å‡ºç®¡ç†](#3-è§„åˆ™å¯¼å…¥å¯¼å‡ºç®¡ç†)
4. [å¼€æœºè‡ªåŠ¨åŒ–é…ç½®](#4-å¼€æœºè‡ªåŠ¨åŒ–é…ç½®)
5. [é…ç½®æ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶](#5-é…ç½®æ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶)
6. [è‡ªåŠ¨åŒ–éƒ¨ç½²ç­–ç•¥](#6-è‡ªåŠ¨åŒ–éƒ¨ç½²ç­–ç•¥)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ è„šæœ¬åŒ–ç®¡ç†æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦è„šæœ¬åŒ–ç®¡ç†


**ğŸ¤” ä¼ ç»Ÿæ‰‹å·¥ç®¡ç†çš„ç—›ç‚¹**

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ˜¯ä¸€ä¸ªç³»ç»Ÿç®¡ç†å‘˜ï¼Œæ¯å¤©éƒ½è¦ç®¡ç†å‡ åå°æœåŠ¡å™¨çš„é˜²ç«å¢™è§„åˆ™ï¼š

```
æ‰‹å·¥ç®¡ç†çš„å›°æ‰°ï¼š
- æ¯å°æœåŠ¡å™¨éƒ½è¦å•ç‹¬é…ç½® â†’ é‡å¤åŠ³åŠ¨ï¼Œå®¹æ˜“å‡ºé”™
- è§„åˆ™å¤æ‚æ—¶å®¹æ˜“é—æ¼ â†’ å®‰å…¨æ¼æ´é£é™©
- æœåŠ¡å™¨é‡å¯åè§„åˆ™ä¸¢å¤± â†’ ä¸šåŠ¡ä¸­æ–­
- å¤šäººç®¡ç†æ—¶é…ç½®ä¸ä¸€è‡´ â†’ ç»´æŠ¤æ··ä¹±
- æ— æ³•å¿«é€Ÿæ‰¹é‡ä¿®æ”¹ â†’ æ•ˆç‡ä½ä¸‹
```

> **ğŸ’¡ æ ¸å¿ƒç†å¿µ**ï¼šè„šæœ¬åŒ–ç®¡ç†å°±æ˜¯æŠŠäººå·¥æ“ä½œå˜æˆè‡ªåŠ¨åŒ–è„šæœ¬ï¼Œè®©è®¡ç®—æœºå¸®æˆ‘ä»¬åšé‡å¤æ€§å·¥ä½œï¼Œæ—¢æé«˜æ•ˆç‡åˆå‡å°‘é”™è¯¯ã€‚

### 1.2 è„šæœ¬åŒ–ç®¡ç†çš„æ ¸å¿ƒä¼˜åŠ¿


**â­ å››å¤§æ ¸å¿ƒä»·å€¼**

| **ä»·å€¼** | **å…·ä½“è¡¨ç°** | **å®é™…æ•ˆç›Š** |
|---------|-------------|-------------|
| **ğŸ”„ æ ‡å‡†åŒ–** | `ç»Ÿä¸€çš„é…ç½®æ¨¡æ¿å’Œæµç¨‹` | `æ¶ˆé™¤äººä¸ºå·®å¼‚ï¼Œæé«˜ä¸€è‡´æ€§` |
| **âš¡ æ•ˆç‡åŒ–** | `æ‰¹é‡æ“ä½œï¼Œä¸€é”®éƒ¨ç½²` | `åŸæ¥1å°æ—¶çš„å·¥ä½œï¼Œç°åœ¨1åˆ†é’Ÿ` |
| **ğŸ›¡ï¸ å¯é æ€§** | `é¿å…æ‰‹å·¥æ“ä½œé”™è¯¯` | `å‡å°‘90%çš„äººä¸ºå¤±è¯¯` |
| **ğŸ“Š å¯è¿½æº¯** | `ç‰ˆæœ¬æ§åˆ¶ï¼Œå˜æ›´è®°å½•` | `é—®é¢˜å¿«é€Ÿå®šä½å’Œå›æ»š` |

### 1.3 è„šæœ¬åŒ–ç®¡ç†çš„æ¶æ„æ€è·¯


```
iptablesè„šæœ¬åŒ–ç®¡ç†æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ç®¡ç†æ§åˆ¶å±‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  é…ç½®æ¨¡æ¿   â”‚   éƒ¨ç½²è„šæœ¬  â”‚  ç›‘æ§è„šæœ¬   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 æ‰§è¡Œå¼•æ“å±‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ è§„åˆ™ç”Ÿæˆå™¨  â”‚  æ‰¹é‡æ‰§è¡Œå™¨ â”‚  çŠ¶æ€æ£€æŸ¥å™¨ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 å­˜å‚¨ç®¡ç†å±‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ é…ç½®æ–‡ä»¶åº“  â”‚  å¤‡ä»½ä»“åº“   â”‚  æ—¥å¿—ç³»ç»Ÿ   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ“ é˜²ç«å¢™è„šæœ¬ç¼–å†™å®æˆ˜


### 2.1 åŸºç¡€è„šæœ¬æ¡†æ¶è®¾è®¡


**ğŸ—ï¸ è„šæœ¬çš„åŸºæœ¬ç»“æ„**

ä¸€ä¸ªå¥½çš„iptablesè„šæœ¬åº”è¯¥åƒæ­ç§¯æœ¨ä¸€æ ·ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½æœ‰æ˜ç¡®çš„åŠŸèƒ½ï¼š

```bash
#!/bin/bash
# iptablesé˜²ç«å¢™é…ç½®è„šæœ¬

# =====================================
# é…ç½®å‚æ•°éƒ¨åˆ† - æ‰€æœ‰å¯å˜çš„å‚æ•°éƒ½æ”¾è¿™é‡Œ
# =====================================
SCRIPT_NAME="iptables-firewall"
LOG_FILE="/var/log/firewall.log"
CONFIG_DIR="/etc/firewall"

# =====================================
# æ—¥å¿—å‡½æ•° - æ–¹ä¾¿è®°å½•æ“ä½œè¿‡ç¨‹
# =====================================
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# =====================================
# æ¸…ç©ºç°æœ‰è§„åˆ™ - ä»å¹²å‡€çŠ¶æ€å¼€å§‹
# =====================================
clear_rules() {
    log_message "æ¸…ç©ºç°æœ‰iptablesè§„åˆ™"
    iptables -F  # æ¸…ç©ºæ‰€æœ‰è§„åˆ™
    iptables -X  # åˆ é™¤è‡ªå®šä¹‰é“¾
    iptables -t nat -F  # æ¸…ç©ºNATè¡¨
    iptables -t nat -X
}

# =====================================
# è®¾ç½®é»˜è®¤ç­–ç•¥ - å®‰å…¨ä¼˜å…ˆ
# =====================================
set_default_policy() {
    log_message "è®¾ç½®é»˜è®¤ç­–ç•¥"
    iptables -P INPUT DROP    # é»˜è®¤æ‹’ç»å…¥ç«™
    iptables -P FORWARD DROP  # é»˜è®¤æ‹’ç»è½¬å‘
    iptables -P OUTPUT ACCEPT # é»˜è®¤å…è®¸å‡ºç«™
}

# =====================================
# ä¸»è¦è§„åˆ™é…ç½®å‡½æ•°
# =====================================
configure_basic_rules() {
    log_message "é…ç½®åŸºç¡€è§„åˆ™"
    # å…è®¸æœ¬åœ°å›ç¯
    iptables -A INPUT -i lo -j ACCEPT
    
    # å…è®¸å·²å»ºç«‹çš„è¿æ¥
    iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
}
```

**ğŸ”§ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

- **æ¨¡å—åŒ–**ï¼šæ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹æˆå‡½æ•°ï¼Œä¾¿äºç»´æŠ¤å’Œæµ‹è¯•
- **æ—¥å¿—è®°å½•**ï¼šæ–¹ä¾¿å‡ºé—®é¢˜æ—¶æŸ¥æ‰¾åŸå› 
- **å‚æ•°åŒ–**ï¼šæŠŠå˜åŒ–çš„å†…å®¹æå–æˆå˜é‡ï¼Œé€‚åº”ä¸åŒç¯å¢ƒ

### 2.2 å®ç”¨è„šæœ¬æ¨¡æ¿


**ğŸ¯ WebæœåŠ¡å™¨é˜²ç«å¢™è„šæœ¬**

```bash
#!/bin/bash
# WebæœåŠ¡å™¨iptablesé…ç½®è„šæœ¬

# é…ç½®å‚æ•°ï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
WEB_PORT=80
SSL_PORT=443
SSH_PORT=22
ADMIN_IP="192.168.1.100"  # ç®¡ç†å‘˜IP

# è„šæœ¬ä¸»å‡½æ•°
main() {
    echo "å¼€å§‹é…ç½®WebæœåŠ¡å™¨é˜²ç«å¢™..."
    
    # ç¬¬ä¸€æ­¥ï¼šæ¸…ç©ºå’Œé‡ç½®
    clear_and_reset
    
    # ç¬¬äºŒæ­¥ï¼šåŸºç¡€å®‰å…¨è§„åˆ™
    setup_basic_security
    
    # ç¬¬ä¸‰æ­¥ï¼šWebæœåŠ¡è§„åˆ™
    setup_web_services
    
    # ç¬¬å››æ­¥ï¼šç®¡ç†è®¿é—®è§„åˆ™
    setup_admin_access
    
    # ç¬¬äº”æ­¥ï¼šä¿å­˜é…ç½®
    save_configuration
    
    echo "é˜²ç«å¢™é…ç½®å®Œæˆï¼"
}

clear_and_reset() {
    iptables -F
    iptables -P INPUT DROP
    iptables -P FORWARD DROP  
    iptables -P OUTPUT ACCEPT
}

setup_basic_security() {
    # å…è®¸æœ¬åœ°é€šä¿¡
    iptables -A INPUT -i lo -j ACCEPT
    
    # å…è®¸å·²å»ºç«‹çš„è¿æ¥ç»§ç»­
    iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
    
    # é˜²æ­¢pingæ´ªæ°´æ”»å‡»
    iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s -j ACCEPT
}

setup_web_services() {
    # å…è®¸HTTPè®¿é—®
    iptables -A INPUT -p tcp --dport $WEB_PORT -j ACCEPT
    
    # å…è®¸HTTPSè®¿é—®
    iptables -A INPUT -p tcp --dport $SSL_PORT -j ACCEPT
}

setup_admin_access() {
    # åªå…è®¸ç®¡ç†å‘˜IPè¿›è¡ŒSSH
    iptables -A INPUT -p tcp -s $ADMIN_IP --dport $SSH_PORT -j ACCEPT
}

save_configuration() {
    # ä¿å­˜è§„åˆ™åˆ°æ–‡ä»¶
    iptables-save > /etc/iptables/rules.v4
    echo "è§„åˆ™å·²ä¿å­˜åˆ° /etc/iptables/rules.v4"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

### 2.3 é«˜çº§è„šæœ¬æŠ€å·§


**ğŸ¨ æ™ºèƒ½å‚æ•°å¤„ç†**

```bash
# æ”¯æŒå‘½ä»¤è¡Œå‚æ•°çš„è„šæœ¬
usage() {
    echo "ç”¨æ³•: $0 [é€‰é¡¹]"
    echo "é€‰é¡¹ï¼š"
    echo "  -s, --start    å¯åŠ¨é˜²ç«å¢™"
    echo "  -r, --reload   é‡æ–°åŠ è½½è§„åˆ™"
    echo "  -t, --test     æµ‹è¯•æ¨¡å¼ï¼ˆä¸å®é™…æ‰§è¡Œï¼‰"
    echo "  -h, --help     æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
}

# è§£æå‘½ä»¤è¡Œå‚æ•°
while [[ $# -gt 0 ]]; do
    case $1 in
        -s|--start)
            ACTION="start"
            shift
            ;;
        -r|--reload)
            ACTION="reload"
            shift
            ;;
        -t|--test)
            TEST_MODE=1
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "æœªçŸ¥å‚æ•°: $1"
            usage
            exit 1
            ;;
    esac
done
```

**ğŸ” è§„åˆ™éªŒè¯åŠŸèƒ½**

```bash
# è§„åˆ™ç”Ÿæ•ˆå‰çš„éªŒè¯æ£€æŸ¥
validate_rules() {
    echo "éªŒè¯é˜²ç«å¢™è§„åˆ™..."
    
    # æ£€æŸ¥å…³é”®æœåŠ¡ç«¯å£æ˜¯å¦å¼€æ”¾
    local critical_ports="22 80 443"
    for port in $critical_ports; do
        if ! iptables -L INPUT -n | grep -q "dpt:$port"; then
            echo "è­¦å‘Šï¼šç«¯å£ $port å¯èƒ½æœªæ­£ç¡®é…ç½®"
        fi
    done
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æ˜æ˜¾çš„å®‰å…¨é—®é¢˜
    if iptables -L INPUT -n | grep -q "ACCEPT.*anywhere"; then
        echo "è­¦å‘Šï¼šå‘ç°è¿‡äºå®½æ¾çš„è§„åˆ™"
    fi
}
```

---

## 3. ğŸ’¾ è§„åˆ™å¯¼å…¥å¯¼å‡ºç®¡ç†


### 3.1 iptables-save å’Œ iptables-restore è¯¦è§£


**ğŸ”§ è¿™ä¸¤ä¸ªå·¥å…·æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ**

ç®€å•ç†è§£ï¼š
- **iptables-save**ï¼šæŠŠå½“å‰çš„é˜²ç«å¢™è§„åˆ™"æ‹ç…§"ä¿å­˜æˆæ–‡ä»¶
- **iptables-restore**ï¼šä»æ–‡ä»¶"æ¢å¤"é˜²ç«å¢™è§„åˆ™

å°±åƒä½ ç©æ¸¸æˆæ—¶çš„å­˜æ¡£å’Œè¯»æ¡£åŠŸèƒ½ä¸€æ ·ï¼

**ğŸ“ åŸºæœ¬ä½¿ç”¨æ–¹æ³•**

```bash
# å¯¼å‡ºå½“å‰è§„åˆ™ï¼ˆå­˜æ¡£ï¼‰
iptables-save > /etc/iptables/current-rules.txt

# æŸ¥çœ‹å¯¼å‡ºçš„è§„åˆ™å†…å®¹
cat /etc/iptables/current-rules.txt

# ä»æ–‡ä»¶æ¢å¤è§„åˆ™ï¼ˆè¯»æ¡£ï¼‰
iptables-restore < /etc/iptables/current-rules.txt
```

### 3.2 è§„åˆ™æ–‡ä»¶æ ¼å¼è§£è¯»


**ğŸ“‹ å¯¼å‡ºæ–‡ä»¶çš„ç»“æ„**

å½“ä½ ç”¨ `iptables-save` å¯¼å‡ºè§„åˆ™åï¼Œæ–‡ä»¶å†…å®¹å¤§æ¦‚æ˜¯è¿™æ ·ï¼š

```
# Generated by iptables-save v1.8.4
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
COMMIT
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
COMMIT
```

**ğŸ” æ–‡ä»¶å†…å®¹è¯¦è§£**

| **éƒ¨åˆ†** | **å«ä¹‰** | **ä½œç”¨** |
|---------|---------|---------|
| `# Generated by...` | æ³¨é‡Šè¡Œ | è¯´æ˜ç”Ÿæˆå·¥å…·å’Œç‰ˆæœ¬ |
| `*filter` | è¡¨å¼€å§‹æ ‡è®° | è¡¨ç¤ºfilterè¡¨çš„è§„åˆ™å¼€å§‹ |
| `:INPUT DROP [0:0]` | é“¾çš„é»˜è®¤ç­–ç•¥ | INPUTé“¾é»˜è®¤DROPï¼Œ[åŒ…æ•°:å­—èŠ‚æ•°] |
| `-A INPUT ...` | è§„åˆ™å†…å®¹ | å…·ä½“çš„è§„åˆ™æ¡ç›® |
| `COMMIT` | è¡¨ç»“æŸæ ‡è®° | æäº¤è¿™ä¸ªè¡¨çš„æ‰€æœ‰è§„åˆ™ |

### 3.3 æ‰¹é‡å¯¼å…¥å¯¼å‡ºå®æˆ˜


**ğŸ¯ è§„åˆ™å¤‡ä»½è„šæœ¬**

```bash
#!/bin/bash
# é˜²ç«å¢™è§„åˆ™å¤‡ä»½è„šæœ¬

BACKUP_DIR="/etc/iptables/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/iptables_$DATE.rules"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# å¤‡ä»½å½“å‰è§„åˆ™
echo "å¤‡ä»½å½“å‰iptablesè§„åˆ™..."
iptables-save > "$BACKUP_FILE"

# ä¿ç•™æœ€è¿‘10ä¸ªå¤‡ä»½æ–‡ä»¶
echo "æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶..."
cd "$BACKUP_DIR"
ls -t iptables_*.rules | tail -n +11 | xargs rm -f

echo "å¤‡ä»½å®Œæˆï¼š$BACKUP_FILE"
```

**ğŸ”„ è§„åˆ™æ¢å¤è„šæœ¬**

```bash
#!/bin/bash
# é˜²ç«å¢™è§„åˆ™æ¢å¤è„šæœ¬

BACKUP_DIR="/etc/iptables/backups"

# æ˜¾ç¤ºå¯ç”¨çš„å¤‡ä»½æ–‡ä»¶
echo "å¯ç”¨çš„å¤‡ä»½æ–‡ä»¶ï¼š"
ls -lt "$BACKUP_DIR"/iptables_*.rules 2>/dev/null | head -5

# è®©ç”¨æˆ·é€‰æ‹©å¤‡ä»½æ–‡ä»¶
echo "è¯·è¾“å…¥è¦æ¢å¤çš„å¤‡ä»½æ–‡ä»¶åï¼š"
read BACKUP_FILE

FULL_PATH="$BACKUP_DIR/$BACKUP_FILE"

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "$FULL_PATH" ]; then
    echo "é”™è¯¯ï¼šæ–‡ä»¶ $FULL_PATH ä¸å­˜åœ¨"
    exit 1
fi

# æ¢å¤è§„åˆ™
echo "æ­£åœ¨æ¢å¤è§„åˆ™ï¼š$FULL_PATH"
iptables-restore < "$FULL_PATH"

echo "è§„åˆ™æ¢å¤å®Œæˆï¼"
```

### 3.4 æ™ºèƒ½è§„åˆ™ç®¡ç†


**ğŸ¨ è§„åˆ™æ¨¡æ¿ç³»ç»Ÿ**

```bash
#!/bin/bash
# è§„åˆ™æ¨¡æ¿ç®¡ç†ç³»ç»Ÿ

TEMPLATE_DIR="/etc/iptables/templates"

# åˆ›å»ºWebæœåŠ¡å™¨æ¨¡æ¿
create_web_template() {
    cat > "$TEMPLATE_DIR/web-server.rules" << 'EOF'
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# åŸºç¡€è§„åˆ™
-A INPUT -i lo -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

# WebæœåŠ¡
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT

# SSHç®¡ç†ï¼ˆéœ€è¦ä¿®æ”¹ä¸ºå®é™…ç®¡ç†IPï¼‰
-A INPUT -p tcp -s 192.168.1.0/24 --dport 22 -j ACCEPT

COMMIT
EOF
    echo "WebæœåŠ¡å™¨æ¨¡æ¿åˆ›å»ºå®Œæˆ"
}

# åº”ç”¨æ¨¡æ¿
apply_template() {
    local template_name=$1
    local template_file="$TEMPLATE_DIR/$template_name.rules"
    
    if [ -f "$template_file" ]; then
        echo "åº”ç”¨æ¨¡æ¿ï¼š$template_name"
        iptables-restore < "$template_file"
    else
        echo "æ¨¡æ¿ä¸å­˜åœ¨ï¼š$template_name"
    fi
}
```

---

## 4. ğŸš€ å¼€æœºè‡ªåŠ¨åŒ–é…ç½®


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦å¼€æœºè‡ªåŠ¨åŠ è½½


**ğŸ˜± å¸¸è§é—®é¢˜åœºæ™¯**

ä½ æœ‰æ²¡æœ‰é‡åˆ°è¿‡è¿™ç§æƒ…å†µï¼š
- æœåŠ¡å™¨é‡å¯åï¼Œè¾›è‹¦é…ç½®çš„é˜²ç«å¢™è§„åˆ™å…¨æ²¡äº†
- ç½‘ç«™çªç„¶æ— æ³•è®¿é—®ï¼Œä¸€æŸ¥å‘ç°é˜²ç«å¢™è§„åˆ™ä¸¢å¤±
- ç»´æŠ¤äººå‘˜é‡å¯æœåŠ¡å™¨ï¼Œå¿˜äº†é‡æ–°é…ç½®é˜²ç«å¢™

> **ğŸ’¡ æ ¸å¿ƒé—®é¢˜**ï¼šiptablesè§„åˆ™é»˜è®¤åªä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œé‡å¯åå°±ä¼šä¸¢å¤±ã€‚æˆ‘ä»¬éœ€è¦è®©ç³»ç»Ÿå¼€æœºæ—¶è‡ªåŠ¨æ¢å¤è¿™äº›è§„åˆ™ã€‚

### 4.2 ä¸åŒLinuxå‘è¡Œç‰ˆçš„è‡ªåŠ¨åŒ–æ–¹æ¡ˆ


**ğŸ§ Ubuntu/Debian ç³»ç»Ÿ**

Ubuntuä½¿ç”¨ `iptables-persistent` åŒ…æ¥å®ç°è§„åˆ™æŒä¹…åŒ–ï¼š

```bash
# å®‰è£…æŒä¹…åŒ–å·¥å…·
sudo apt-get install iptables-persistent

# ä¿å­˜å½“å‰è§„åˆ™
sudo iptables-save > /etc/iptables/rules.v4
sudo ip6tables-save > /etc/iptables/rules.v6

# ç³»ç»Ÿé‡å¯æ—¶ä¼šè‡ªåŠ¨åŠ è½½è¿™äº›è§„åˆ™
```

**ğŸ© CentOS/RHEL ç³»ç»Ÿ**

CentOSæœ‰ä¸¤ç§ä¸»è¦æ–¹æ³•ï¼š

**æ–¹æ³•ä¸€ï¼šä½¿ç”¨iptablesæœåŠ¡**
```bash
# å®‰è£…iptablesæœåŠ¡
sudo yum install iptables-services

# å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable iptables
sudo systemctl start iptables

# ä¿å­˜å½“å‰è§„åˆ™
sudo service iptables save
```

**æ–¹æ³•äºŒï¼šä½¿ç”¨rc.local**
```bash
# ç¼–è¾‘å¯åŠ¨è„šæœ¬
sudo vi /etc/rc.local

# æ·»åŠ è§„åˆ™æ¢å¤å‘½ä»¤
iptables-restore < /etc/iptables/rules.v4

# ç»™è„šæœ¬æ‰§è¡Œæƒé™
sudo chmod +x /etc/rc.local
```

### 4.3 systemdæœåŠ¡æ–¹å¼ï¼ˆæ¨èï¼‰


**ğŸ¯ åˆ›å»ºè‡ªå®šä¹‰systemdæœåŠ¡**

è¿™æ˜¯æœ€ç°ä»£åŒ–å’Œå¯é çš„æ–¹æ³•ï¼š

```bash
# åˆ›å»ºæœåŠ¡æ–‡ä»¶
sudo vi /etc/systemd/system/iptables-restore.service
```

æœåŠ¡æ–‡ä»¶å†…å®¹ï¼š
```ini
[Unit]
Description=Restore iptables rules
After=network.target

[Service]
Type=oneshot
ExecStart=/sbin/iptables-restore /etc/iptables/rules.v4
ExecReload=/sbin/iptables-restore /etc/iptables/rules.v4
RemainAfterExit=true

[Install]
WantedBy=multi-user.target
```

**å¯ç”¨æœåŠ¡ï¼š**
```bash
# é‡æ–°åŠ è½½systemdé…ç½®
sudo systemctl daemon-reload

# å¯ç”¨æœåŠ¡
sudo systemctl enable iptables-restore.service

# æµ‹è¯•æœåŠ¡
sudo systemctl start iptables-restore.service
sudo systemctl status iptables-restore.service
```

### 4.4 å¼€æœºå¯åŠ¨è„šæœ¬å®Œæ•´æ–¹æ¡ˆ


**ğŸ› ï¸ é€šç”¨å¼€æœºå¯åŠ¨è„šæœ¬**

```bash
#!/bin/bash
# /usr/local/bin/firewall-startup.sh
# é˜²ç«å¢™å¼€æœºå¯åŠ¨è„šæœ¬

LOG_FILE="/var/log/firewall-startup.log"
RULES_FILE="/etc/iptables/rules.v4"
BACKUP_DIR="/etc/iptables/backups"

# æ—¥å¿—è®°å½•å‡½æ•°
log_msg() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# æ£€æŸ¥è§„åˆ™æ–‡ä»¶æ˜¯å¦å­˜åœ¨
check_rules_file() {
    if [ ! -f "$RULES_FILE" ]; then
        log_msg "é”™è¯¯ï¼šè§„åˆ™æ–‡ä»¶ $RULES_FILE ä¸å­˜åœ¨"
        return 1
    fi
    return 0
}

# å¤‡ä»½å½“å‰è§„åˆ™ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
backup_current_rules() {
    if iptables -L > /dev/null 2>&1; then
        local backup_file="$BACKUP_DIR/before_restore_$(date +%Y%m%d_%H%M%S).rules"
        mkdir -p "$BACKUP_DIR"
        iptables-save > "$backup_file"
        log_msg "å½“å‰è§„åˆ™å·²å¤‡ä»½åˆ°ï¼š$backup_file"
    fi
}

# æ¢å¤è§„åˆ™
restore_rules() {
    log_msg "å¼€å§‹æ¢å¤iptablesè§„åˆ™..."
    
    if iptables-restore < "$RULES_FILE"; then
        log_msg "iptablesè§„åˆ™æ¢å¤æˆåŠŸ"
        return 0
    else
        log_msg "é”™è¯¯ï¼šiptablesè§„åˆ™æ¢å¤å¤±è´¥"
        return 1
    fi
}

# éªŒè¯è§„åˆ™
verify_rules() {
    local rule_count=$(iptables -L | grep -c "^Chain\|^target")
    log_msg "å½“å‰å…±æœ‰ $rule_count æ¡è§„åˆ™"
    
    # æ£€æŸ¥SSHç«¯å£æ˜¯å¦å¼€æ”¾ï¼ˆé˜²æ­¢è¢«é”åœ¨å¤–é¢ï¼‰
    if iptables -L INPUT -n | grep -q "dpt:22"; then
        log_msg "SSHè®¿é—®è§„åˆ™æ­£å¸¸"
    else
        log_msg "è­¦å‘Šï¼šæœªå‘ç°SSHè®¿é—®è§„åˆ™"
    fi
}

# ä¸»å‡½æ•°
main() {
    log_msg "é˜²ç«å¢™å¯åŠ¨è„šæœ¬å¼€å§‹æ‰§è¡Œ"
    
    check_rules_file || exit 1
    backup_current_rules
    restore_rules || exit 1
    verify_rules
    
    log_msg "é˜²ç«å¢™å¯åŠ¨è„šæœ¬æ‰§è¡Œå®Œæˆ"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

---

## 5. ğŸ—‚ï¸ é…ç½®æ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬æ§åˆ¶


**ğŸ¤” å®é™…å·¥ä½œä¸­çš„ç—›ç‚¹**

æƒ³è±¡è¿™æ ·çš„åœºæ™¯ï¼š
- æ˜¨å¤©ä¿®æ”¹äº†é˜²ç«å¢™è§„åˆ™ï¼Œä»Šå¤©æœåŠ¡å‡ºé—®é¢˜äº†ï¼Œæƒ³å›åˆ°æ˜¨å¤©çš„é…ç½®
- å¤šä¸ªåŒäº‹éƒ½åœ¨ä¿®æ”¹é˜²ç«å¢™é…ç½®ï¼Œä¸çŸ¥é“è°æ”¹äº†ä»€ä¹ˆ
- æƒ³çŸ¥é“æŸä¸ªè§„åˆ™æ˜¯ä»€ä¹ˆæ—¶å€™åŠ çš„ï¼Œä¸ºä»€ä¹ˆåŠ çš„
- éœ€è¦åœ¨ä¸åŒç¯å¢ƒï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰ä¿æŒé…ç½®åŒæ­¥

**ğŸ’¡ ç‰ˆæœ¬æ§åˆ¶çš„ä»·å€¼**

| **ä»·å€¼** | **å…·ä½“è¡¨ç°** |
|---------|-------------|
| **ğŸ“ˆ å˜æ›´è¿½è¸ª** | çŸ¥é“æ¯æ¬¡æ”¹äº†ä»€ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™æ”¹çš„ |
| **ğŸ”„ å¿«é€Ÿå›æ»š** | å‡ºé—®é¢˜æ—¶èƒ½å¿«é€Ÿæ¢å¤åˆ°ä¹‹å‰çš„ç‰ˆæœ¬ |
| **ğŸ‘¥ åä½œç®¡ç†** | å¤šäººåä½œæ—¶é¿å…å†²çªå’Œæ··ä¹± |
| **ğŸ” é—®é¢˜å®šä½** | å‡ºé—®é¢˜æ—¶èƒ½å¿«é€Ÿæ‰¾åˆ°æ ¹æœ¬åŸå›  |

### 5.2 Gitç‰ˆæœ¬æ§åˆ¶å®æˆ˜


**ğŸ—ï¸ å»ºç«‹Gitä»“åº“**

```bash
# åˆ›å»ºé˜²ç«å¢™é…ç½®ä»“åº“
mkdir /etc/iptables-config
cd /etc/iptables-config

# åˆå§‹åŒ–Gitä»“åº“
git init

# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p {rules,scripts,templates,backups}

# åˆ›å»º.gitignoreæ–‡ä»¶
cat > .gitignore << 'EOF'
# å¿½ç•¥å¤‡ä»½æ–‡ä»¶
backups/*.rules
# å¿½ç•¥æ—¥å¿—æ–‡ä»¶
*.log
# å¿½ç•¥ä¸´æ—¶æ–‡ä»¶
*.tmp
EOF
```

**ğŸ“ é…ç½®ç®¡ç†è„šæœ¬**

```bash
#!/bin/bash
# é˜²ç«å¢™é…ç½®ç‰ˆæœ¬ç®¡ç†è„šæœ¬

REPO_DIR="/etc/iptables-config"
RULES_FILE="$REPO_DIR/rules/current.rules"

# ä¿å­˜å½“å‰é…ç½®å¹¶æäº¤åˆ°Git
save_config() {
    local commit_message="$1"
    
    cd "$REPO_DIR"
    
    # å¯¼å‡ºå½“å‰è§„åˆ™
    iptables-save > "$RULES_FILE"
    
    # æ·»åŠ åˆ°Git
    git add .
    
    # æäº¤æ›´æ”¹
    if [ -n "$commit_message" ]; then
        git commit -m "$commit_message"
    else
        git commit -m "æ›´æ–°é˜²ç«å¢™è§„åˆ™ $(date '+%Y-%m-%d %H:%M:%S')"
    fi
    
    echo "é…ç½®å·²ä¿å­˜å¹¶æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶"
}

# æŸ¥çœ‹ç‰ˆæœ¬å†å²
show_history() {
    cd "$REPO_DIR"
    echo "æœ€è¿‘çš„é…ç½®å˜æ›´å†å²ï¼š"
    git log --oneline -10
}

# æ¢å¤åˆ°æŒ‡å®šç‰ˆæœ¬
restore_version() {
    local commit_hash="$1"
    
    if [ -z "$commit_hash" ]; then
        echo "è¯·æŒ‡å®šè¦æ¢å¤çš„ç‰ˆæœ¬å“ˆå¸Œå€¼"
        show_history
        return 1
    fi
    
    cd "$REPO_DIR"
    
    # æ£€å‡ºæŒ‡å®šç‰ˆæœ¬
    git checkout "$commit_hash" -- "$RULES_FILE"
    
    # æ¢å¤è§„åˆ™
    iptables-restore < "$RULES_FILE"
    
    echo "å·²æ¢å¤åˆ°ç‰ˆæœ¬ï¼š$commit_hash"
}

# å‘½ä»¤è¡Œå‚æ•°å¤„ç†
case "$1" in
    save)
        save_config "$2"
        ;;
    history)
        show_history
        ;;
    restore)
        restore_version "$2"
        ;;
    *)
        echo "ç”¨æ³•ï¼š$0 {save|history|restore}"
        echo "  save [æ¶ˆæ¯]     - ä¿å­˜å½“å‰é…ç½®"
        echo "  history        - æŸ¥çœ‹å†å²ç‰ˆæœ¬"  
        echo "  restore [hash] - æ¢å¤åˆ°æŒ‡å®šç‰ˆæœ¬"
        ;;
esac
```

### 5.3 ç¯å¢ƒé…ç½®ç®¡ç†


**ğŸŒ å¤šç¯å¢ƒé…ç½®æ–¹æ¡ˆ**

```bash
# ç›®å½•ç»“æ„
/etc/iptables-config/
â”œâ”€â”€ environments/
â”‚   â”œâ”€â”€ development.rules    # å¼€å‘ç¯å¢ƒ
â”‚   â”œâ”€â”€ testing.rules       # æµ‹è¯•ç¯å¢ƒ
â”‚   â””â”€â”€ production.rules    # ç”Ÿäº§ç¯å¢ƒ
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ web-server.template
â”‚   â””â”€â”€ database.template
â””â”€â”€ scripts/
    â””â”€â”€ deploy.sh
```

**ğŸ“‹ ç¯å¢ƒéƒ¨ç½²è„šæœ¬**

```bash
#!/bin/bash
# ç¯å¢ƒéƒ¨ç½²è„šæœ¬

REPO_DIR="/etc/iptables-config"
ENVIRONMENT="$1"

# æ£€æŸ¥ç¯å¢ƒå‚æ•°
if [ -z "$ENVIRONMENT" ]; then
    echo "ç”¨æ³•ï¼š$0 {development|testing|production}"
    exit 1
fi

RULES_FILE="$REPO_DIR/environments/$ENVIRONMENT.rules"

# æ£€æŸ¥è§„åˆ™æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "$RULES_FILE" ]; then
    echo "é”™è¯¯ï¼šç¯å¢ƒé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼š$RULES_FILE"
    exit 1
fi

# å¤‡ä»½å½“å‰é…ç½®
BACKUP_FILE="/tmp/iptables_backup_$(date +%Y%m%d_%H%M%S).rules"
iptables-save > "$BACKUP_FILE"
echo "å½“å‰é…ç½®å·²å¤‡ä»½åˆ°ï¼š$BACKUP_FILE"

# åº”ç”¨æ–°ç¯å¢ƒé…ç½®
echo "åº”ç”¨ $ENVIRONMENT ç¯å¢ƒé…ç½®..."
iptables-restore < "$RULES_FILE"

# éªŒè¯é…ç½®
if iptables -L > /dev/null 2>&1; then
    echo "$ENVIRONMENT ç¯å¢ƒé…ç½®åº”ç”¨æˆåŠŸ"
else
    echo "é…ç½®åº”ç”¨å¤±è´¥ï¼Œæ­£åœ¨æ¢å¤å¤‡ä»½..."
    iptables-restore < "$BACKUP_FILE"
fi
```

---

## 6. ğŸ¤– è‡ªåŠ¨åŒ–éƒ¨ç½²ç­–ç•¥


### 6.1 è‡ªåŠ¨åŒ–éƒ¨ç½²çš„æ ¸å¿ƒæ€æƒ³


**ğŸ¯ ä»€ä¹ˆæ˜¯è‡ªåŠ¨åŒ–éƒ¨ç½²**

ç®€å•æ¥è¯´ï¼Œå°±æ˜¯è®©æœºå™¨è‡ªåŠ¨å¸®ä½ å®Œæˆé˜²ç«å¢™è§„åˆ™çš„éƒ¨ç½²å·¥ä½œï¼š
- ä¸éœ€è¦æ‰‹å·¥ç™»å½•æ¯å°æœåŠ¡å™¨
- ä¸éœ€è¦é‡å¤è¾“å…¥ç›¸åŒçš„å‘½ä»¤
- é…ç½®é”™è¯¯æ—¶èƒ½è‡ªåŠ¨å›æ»š
- èƒ½å¤ŸåŒæ—¶ç®¡ç†å‡ åå°ç”šè‡³ä¸Šç™¾å°æœåŠ¡å™¨

**âš¡ è‡ªåŠ¨åŒ–éƒ¨ç½²çš„å¥½å¤„**

```
ä¼ ç»Ÿæ–¹å¼ vs è‡ªåŠ¨åŒ–æ–¹å¼ï¼š

ä¼ ç»Ÿéƒ¨ç½²ï¼š
ç™»å½•æœåŠ¡å™¨1 â†’ æ‰‹å·¥é…ç½® â†’ æµ‹è¯• â†’ ä¸‹ä¸€å°æœåŠ¡å™¨
   â†“           â†“        â†“         â†“
 è€—æ—¶é•¿      æ˜“å‡ºé”™    ä¸ä¸€è‡´    æ•ˆç‡ä½

è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼š
ä¸€ä¸ªå‘½ä»¤ â†’ æ‰¹é‡æ‰§è¡Œ â†’ è‡ªåŠ¨éªŒè¯ â†’ ç»Ÿä¸€ç»“æœ
   â†“          â†“         â†“         â†“
 ç§’çº§å®Œæˆ   æ ‡å‡†åŒ–     å¯é æ€§é«˜   é«˜æ•ˆç‡
```

### 6.2 Ansibleè‡ªåŠ¨åŒ–éƒ¨ç½²


**ğŸ› ï¸ ä¸ºä»€ä¹ˆé€‰æ‹©Ansible**

Ansibleæ˜¯ç›®å‰æœ€æµè¡Œçš„è‡ªåŠ¨åŒ–å·¥å…·ï¼Œç‰¹ç‚¹ï¼š
- **æ— éœ€ä»£ç†**ï¼šä¸ç”¨åœ¨ç›®æ ‡æœåŠ¡å™¨å®‰è£…ä»»ä½•è½¯ä»¶
- **è¯­æ³•ç®€å•**ï¼šä½¿ç”¨YAMLæ ¼å¼ï¼Œäººç±»å¯è¯»
- **å¹‚ç­‰æ€§**ï¼šå¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´ï¼Œä¸ä¼šé‡å¤æ“ä½œ

**ğŸ“‹ Ansibleé˜²ç«å¢™é…ç½®ç¤ºä¾‹**

```yaml
---
# iptables.yml - Ansible playbook
- name: é…ç½®iptablesé˜²ç«å¢™
  hosts: webservers
  become: yes
  
  vars:
    web_ports: [80, 443]
    ssh_port: 22
    admin_networks: ['192.168.1.0/24']
  
  tasks:
    - name: å®‰è£…iptables
      package:
        name: iptables
        state: present
    
    - name: å¤‡ä»½å½“å‰è§„åˆ™
      shell: iptables-save > /tmp/iptables_backup_{{ ansible_date_time.epoch }}.rules
      
    - name: æ¸…ç©ºç°æœ‰è§„åˆ™
      iptables:
        chain: "{{ item }}"
        flush: yes
      loop: [INPUT, FORWARD, OUTPUT]
    
    - name: è®¾ç½®é»˜è®¤ç­–ç•¥
      iptables:
        chain: "{{ item.chain }}"
        policy: "{{ item.policy }}"
      loop:
        - { chain: INPUT, policy: DROP }
        - { chain: FORWARD, policy: DROP }
        - { chain: OUTPUT, policy: ACCEPT }
    
    - name: å…è®¸æœ¬åœ°å›ç¯
      iptables:
        chain: INPUT
        in_interface: lo
        jump: ACCEPT
    
    - name: å…è®¸å·²å»ºç«‹çš„è¿æ¥
      iptables:
        chain: INPUT
        match: state
        state: ESTABLISHED,RELATED
        jump: ACCEPT
    
    - name: å…è®¸WebæœåŠ¡ç«¯å£
      iptables:
        chain: INPUT
        protocol: tcp
        destination_port: "{{ item }}"
        jump: ACCEPT
      loop: "{{ web_ports }}"
    
    - name: å…è®¸ç®¡ç†ç½‘æ®µSSH
      iptables:
        chain: INPUT
        protocol: tcp
        source: "{{ item }}"
        destination_port: "{{ ssh_port }}"
        jump: ACCEPT
      loop: "{{ admin_networks }}"
    
    - name: ä¿å­˜iptablesè§„åˆ™
      shell: iptables-save > /etc/iptables/rules.v4
```

**ğŸš€ æ‰§è¡ŒAnsibleéƒ¨ç½²**

```bash
# æ‰§è¡Œplaybook
ansible-playbook -i inventory iptables.yml

# åªåœ¨ç‰¹å®šä¸»æœºç»„æ‰§è¡Œ
ansible-playbook -i inventory iptables.yml --limit webservers

# æ£€æŸ¥æ¨¡å¼ï¼ˆä¸å®é™…æ‰§è¡Œï¼Œåªæ˜¾ç¤ºä¼šåšä»€ä¹ˆï¼‰
ansible-playbook -i inventory iptables.yml --check
```

### 6.3 Dockerå®¹å™¨åŒ–éƒ¨ç½²


**ğŸ³ å®¹å™¨åŒ–é˜²ç«å¢™ç®¡ç†**

```dockerfile
# Dockerfile
FROM centos:7

# å®‰è£…å¿…è¦å·¥å…·
RUN yum install -y iptables openssh-clients git

# å¤åˆ¶è„šæœ¬å’Œé…ç½®
COPY scripts/ /opt/firewall-scripts/
COPY configs/ /opt/firewall-configs/

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /opt/firewall-scripts

# å…¥å£è„šæœ¬
ENTRYPOINT ["./deploy.sh"]
```

**ğŸ”§ å®¹å™¨åŒ–éƒ¨ç½²è„šæœ¬**

```bash
#!/bin/bash
# å®¹å™¨åŒ–éƒ¨ç½²è„šæœ¬

HOSTS_FILE="/opt/firewall-configs/hosts.txt"
CONFIG_DIR="/opt/firewall-configs"

# è¯»å–ç›®æ ‡ä¸»æœºåˆ—è¡¨
while IFS= read -r host; do
    echo "æ­£åœ¨é…ç½®ä¸»æœºï¼š$host"
    
    # å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°ç›®æ ‡ä¸»æœº
    scp "$CONFIG_DIR/iptables.rules" root@"$host":/tmp/
    
    # è¿œç¨‹æ‰§è¡Œé…ç½®
    ssh root@"$host" << 'EOF'
        # å¤‡ä»½å½“å‰è§„åˆ™
        iptables-save > /tmp/backup_$(date +%s).rules
        
        # åº”ç”¨æ–°è§„åˆ™
        iptables-restore < /tmp/iptables.rules
        
        # ä¿å­˜è§„åˆ™
        iptables-save > /etc/iptables/rules.v4
        
        echo "é…ç½®å®Œæˆ"
EOF
    
done < "$HOSTS_FILE"
```

### 6.4 ç›‘æ§å’Œå¥åº·æ£€æŸ¥


**ğŸ” è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬**

```bash
#!/bin/bash
# é˜²ç«å¢™çŠ¶æ€ç›‘æ§è„šæœ¬

HOSTS_FILE="/etc/firewall-monitor/hosts.txt"
LOG_FILE="/var/log/firewall-monitor.log"
ALERT_EMAIL="admin@example.com"

# æ£€æŸ¥å•ä¸ªä¸»æœºçš„é˜²ç«å¢™çŠ¶æ€
check_host() {
    local host="$1"
    local result
    
    # æ£€æŸ¥SSHè¿æ¥
    if ! timeout 10 ssh -o ConnectTimeout=5 "$host" "echo 'connected'" > /dev/null 2>&1; then
        echo "ERROR: æ— æ³•è¿æ¥åˆ° $host"
        return 1
    fi
    
    # æ£€æŸ¥iptablesæœåŠ¡çŠ¶æ€
    result=$(ssh "$host" "iptables -L INPUT | wc -l" 2>/dev/null)
    
    if [ "$result" -gt 5 ]; then
        echo "OK: $host é˜²ç«å¢™è§„åˆ™æ­£å¸¸ ($result æ¡è§„åˆ™)"
        return 0
    else
        echo "WARNING: $host é˜²ç«å¢™è§„åˆ™å¼‚å¸¸ (åªæœ‰ $result æ¡è§„åˆ™)"
        return 1
    fi
}

# ä¸»ç›‘æ§å¾ªç¯
main() {
    local failed_hosts=()
    
    echo "[$(date)] å¼€å§‹é˜²ç«å¢™çŠ¶æ€æ£€æŸ¥" | tee -a "$LOG_FILE"
    
    while IFS= read -r host; do
        if ! check_host "$host"; then
            failed_hosts+=("$host")
        fi
    done < "$HOSTS_FILE"
    
    # å¦‚æœæœ‰å¤±è´¥çš„ä¸»æœºï¼Œå‘é€å‘Šè­¦
    if [ ${#failed_hosts[@]} -gt 0 ]; then
        local alert_msg="é˜²ç«å¢™å¼‚å¸¸ä¸»æœºï¼š${failed_hosts[*]}"
        echo "$alert_msg" | mail -s "é˜²ç«å¢™ç›‘æ§å‘Šè­¦" "$ALERT_EMAIL"
        echo "[$(date)] $alert_msg" | tee -a "$LOG_FILE"
    fi
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è„šæœ¬åŒ–æ€ç»´ï¼šæŠŠé‡å¤æ€§æ“ä½œå˜æˆè‡ªåŠ¨åŒ–è„šæœ¬
ğŸ”¸ è§„åˆ™æŒä¹…åŒ–ï¼šä½¿ç”¨iptables-save/restoreä¿å­˜å’Œæ¢å¤è§„åˆ™
ğŸ”¸ å¼€æœºè‡ªå¯åŠ¨ï¼šç¡®ä¿æœåŠ¡å™¨é‡å¯åè§„åˆ™è‡ªåŠ¨ç”Ÿæ•ˆ
ğŸ”¸ ç‰ˆæœ¬æ§åˆ¶ï¼šç”¨Gitç®¡ç†é…ç½®æ–‡ä»¶çš„å˜æ›´å†å²
ğŸ”¸ è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼šæ‰¹é‡ç®¡ç†å¤šå°æœåŠ¡å™¨çš„é˜²ç«å¢™é…ç½®
ğŸ”¸ ç›‘æ§æ£€æŸ¥ï¼šè‡ªåŠ¨åŒ–ç›‘æ§é˜²ç«å¢™çŠ¶æ€å’Œå¥åº·åº¦
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è„šæœ¬åŒ–çš„æ ¸å¿ƒä»·å€¼**
```
æ ‡å‡†åŒ– â†’ æ¶ˆé™¤äººä¸ºå·®å¼‚ï¼Œæé«˜ä¸€è‡´æ€§
è‡ªåŠ¨åŒ– â†’ æé«˜æ•ˆç‡ï¼Œå‡å°‘é‡å¤åŠ³åŠ¨  
å¯è¿½æº¯ â†’ è®°å½•å˜æ›´å†å²ï¼Œé—®é¢˜å¿«é€Ÿå®šä½
å¯æ¢å¤ â†’ å‡ºé—®é¢˜æ—¶èƒ½å¿«é€Ÿå›æ»š
```

**ğŸ”¹ è§„åˆ™æŒä¹…åŒ–çš„é‡è¦æ€§**
```
é—®é¢˜ï¼šiptablesè§„åˆ™é»˜è®¤ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œé‡å¯ä¸¢å¤±
è§£å†³ï¼šé€šè¿‡å¤šç§æ–¹å¼å®ç°è§„åˆ™çš„æŒä¹…åŒ–ä¿å­˜
æ–¹æ³•ï¼šiptables-persistentã€systemdæœåŠ¡ã€å¯åŠ¨è„šæœ¬
```

**ğŸ”¹ è‡ªåŠ¨åŒ–éƒ¨ç½²çš„å±‚æ¬¡**
```
å•æœºè‡ªåŠ¨åŒ– â†’ è„šæœ¬åŒ–ç®¡ç†å•å°æœåŠ¡å™¨
æ‰¹é‡è‡ªåŠ¨åŒ– â†’ åŒæ—¶ç®¡ç†å¤šå°æœåŠ¡å™¨
æµç¨‹è‡ªåŠ¨åŒ– â†’ æ•´ä¸ªéƒ¨ç½²æµç¨‹çš„è‡ªåŠ¨åŒ–
ç›‘æ§è‡ªåŠ¨åŒ– â†’ çŠ¶æ€æ£€æŸ¥å’Œé—®é¢˜å‘Šè­¦
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¼ä¸šç¯å¢ƒå®è·µ**
- **è¿ç»´æ•ˆç‡**ï¼šåŸæ¥éœ€è¦1å¤©çš„é…ç½®å·¥ä½œï¼Œç°åœ¨10åˆ†é’Ÿå®Œæˆ
- **é…ç½®ä¸€è‡´æ€§**ï¼šæ‰€æœ‰æœåŠ¡å™¨ä½¿ç”¨ç›¸åŒçš„æ ‡å‡†åŒ–é…ç½®
- **é—®é¢˜å®šä½**ï¼šé€šè¿‡ç‰ˆæœ¬æ§åˆ¶å¿«é€Ÿæ‰¾åˆ°é—®é¢˜æ ¹å› 
- **ä¸šåŠ¡è¿ç»­æ€§**ï¼šè‡ªåŠ¨åŒ–ç›‘æ§ç¡®ä¿æœåŠ¡ç¨³å®šè¿è¡Œ

**ğŸ¯ æŠ€èƒ½å‘å±•è·¯å¾„**
- **åŸºç¡€é˜¶æ®µ**ï¼šæŒæ¡åŸºæœ¬çš„shellè„šæœ¬ç¼–å†™
- **è¿›é˜¶é˜¶æ®µ**ï¼šå­¦ä¹ Ansibleç­‰è‡ªåŠ¨åŒ–å·¥å…·
- **é«˜çº§é˜¶æ®µ**ï¼šæ„å»ºå®Œæ•´çš„DevOpsæµæ°´çº¿
- **ä¸“å®¶é˜¶æ®µ**ï¼šè®¾è®¡ä¼ä¸šçº§çš„åŸºç¡€è®¾æ–½ç®¡ç†å¹³å°

### 7.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**âš ï¸ æ–°æ‰‹å¸¸è§é”™è¯¯**
```
å¿˜è®°å¤‡ä»½ç°æœ‰é…ç½® â†’ å¯¼è‡´æ— æ³•æ¢å¤
è„šæœ¬æƒé™ä¸æ­£ç¡® â†’ æ‰§è¡Œå¤±è´¥
è§„åˆ™è¯­æ³•é”™è¯¯ â†’ é˜²ç«å¢™å¤±æ•ˆ
æ²¡æœ‰éªŒè¯æœºåˆ¶ â†’ é…ç½®é”™è¯¯éš¾å‘ç°
```

**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**
```
æµ‹è¯•ä¼˜å…ˆï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è„šæœ¬
åˆ†æ­¥æ‰§è¡Œï¼šå¤æ‚æ“ä½œåˆ†è§£æˆå°æ­¥éª¤
æ—¥å¿—è®°å½•ï¼šè¯¦ç»†è®°å½•æ¯ä¸ªæ“ä½œè¿‡ç¨‹
ç›‘æ§å‘Šè­¦ï¼šåŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜
æ–‡æ¡£ç»´æŠ¤ï¼šä¿æŒæ–‡æ¡£å’Œä»£ç åŒæ­¥
```

### 7.5 è¿›é˜¶å­¦ä¹ æ–¹å‘


**ğŸš€ ç›¸å…³æŠ€æœ¯æ ˆ**
- **é…ç½®ç®¡ç†**ï¼šAnsible, Puppet, Chef
- **å®¹å™¨åŒ–**ï¼šDocker, Kubernetes
- **ç›‘æ§ç³»ç»Ÿ**ï¼šPrometheus, Grafana, Zabbix
- **CI/CD**ï¼šJenkins, GitLab CI, GitHub Actions

**ğŸ“š æ‰©å±•çŸ¥è¯†é¢†åŸŸ**
- **ç½‘ç»œå®‰å…¨**ï¼šæ·±å…¥å­¦ä¹ é˜²ç«å¢™åŸç†å’Œç½‘ç»œæ”»é˜²
- **ç³»ç»Ÿè¿ç»´**ï¼šLinuxç³»ç»Ÿç®¡ç†å’Œæ€§èƒ½ä¼˜åŒ–
- **äº‘è®¡ç®—**ï¼šå…¬æœ‰äº‘çš„ç½‘ç»œå®‰å…¨å’Œè®¿é—®æ§åˆ¶
- **DevOps**ï¼šæŒç»­é›†æˆå’ŒæŒç»­éƒ¨ç½²å®è·µ

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
è„šæœ¬è‡ªåŠ¨å‡äººå·¥ï¼Œè§„åˆ™æŒä¹…é˜²ä¸¢å¤±
ç‰ˆæœ¬æ§åˆ¶è¿½å˜æ›´ï¼Œæ‰¹é‡éƒ¨ç½²ææ•ˆç‡
ç›‘æ§å‘Šè­¦ä¿ç¨³å®šï¼Œæ ‡å‡†æµç¨‹æ˜¯æ ¹æœ¬
æµ‹è¯•éªŒè¯ä¸å¯å°‘ï¼Œå¤‡ä»½æ¢å¤è¦ç‰¢è®°
```