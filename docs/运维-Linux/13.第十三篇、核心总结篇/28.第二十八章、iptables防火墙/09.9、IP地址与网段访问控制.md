---
title: 9、IP地址与网段访问控制
---
## 📚 目录

1. [IP访问控制基础概念](#1-IP访问控制基础概念)
2. [单IP地址控制](#2-单IP地址控制)
3. [IP网段范围控制](#3-IP网段范围控制)
4. [黑名单与白名单机制](#4-黑名单与白名单机制)
5. [地理位置IP限制](#5-地理位置IP限制)
6. [内网外网访问控制](#6-内网外网访问控制)
7. [VPN网段访问控制](#7-VPN网段访问控制)
8. [动态IP处理方案](#8-动态IP处理方案)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🎯 IP访问控制基础概念


### 1.1 什么是IP访问控制


**通俗理解**：就像小区门禁一样，只允许指定的人（IP地址）进入你的服务器

```
生活类比：
🏠 小区门禁系统          🖥️ 服务器访问控制
业主卡片 → 允许进入      白名单IP → 允许访问
访客登记 → 临时许可      临时规则 → 特定时间允许
黑名单 → 禁止进入        黑名单IP → 拒绝访问
```

**核心作用**：
- **安全防护**：阻止恶意IP攻击
- **访问管理**：控制谁能访问什么服务
- **流量控制**：限制特定来源的访问量
- **合规要求**：满足网络安全规范

### 1.2 iptables中的IP控制原理


**工作机制**：
```
数据包到达 → 检查源IP → 匹配规则 → 执行动作
     ↓              ↓          ↓        ↓
来自192.168.1.100  在白名单中   匹配成功   ACCEPT允许
来自1.2.3.4       在黑名单中   匹配成功   DROP拒绝
```

**基本语法结构**：
```bash
iptables -I INPUT -s [源IP] -j [动作]
#        ↑      ↑      ↑       ↑
#      插入规则 输入链  源地址   执行动作
```

---

## 2. 🔒 单IP地址控制


### 2.1 允许单个IP访问


**基本操作**：允许指定IP访问服务器

```bash
# 允许192.168.1.100访问所有服务
iptables -I INPUT -s 192.168.1.100 -j ACCEPT

# 允许特定IP访问SSH服务（22端口）
iptables -I INPUT -s 192.168.1.100 -p tcp --dport 22 -j ACCEPT

# 允许特定IP访问Web服务（80端口）
iptables -I INPUT -s 192.168.1.100 -p tcp --dport 80 -j ACCEPT
```

**实际应用场景**：
- 管理员远程维护服务器
- 特定客户端访问数据库
- 合作伙伴访问API接口

### 2.2 拒绝单个IP访问


**恶意IP封禁**：
```bash
# 完全封禁恶意IP
iptables -I INPUT -s 1.2.3.4 -j DROP

# 拒绝访问特定服务
iptables -I INPUT -s 1.2.3.4 -p tcp --dport 80 -j REJECT

# 记录并拒绝（便于分析）
iptables -I INPUT -s 1.2.3.4 -j LOG --log-prefix "BLOCKED_IP: "
iptables -I INPUT -s 1.2.3.4 -j DROP
```

**DROP vs REJECT的区别**：
```
┌─ 对比理解 ────────────────────────┐
│ DROP：静默丢弃，像石沉大海         │
│ - 攻击者不知道服务器存在           │
│ - 不消耗带宽回复                   │
│                                    │
│ REJECT：明确拒绝，有回复消息       │
│ - 告诉对方"访问被拒绝"             │
│ - 正常的网络礼貌行为               │
└────────────────────────────────────┘
```

### 2.3 临时IP控制


**临时允许访问**：
```bash
# 临时允许IP访问（重启后失效）
iptables -I INPUT -s 192.168.1.200 -j ACCEPT

# 查看当前规则
iptables -L INPUT -n --line-numbers

# 删除临时规则（假设规则编号为3）
iptables -D INPUT 3
```

---

## 3. 🌐 IP网段范围控制


### 3.1 网段基础知识


**CIDR表示法**：用简洁的方式表示IP网段

```
网段表示方式：
192.168.1.0/24  → 192.168.1.1 到 192.168.1.254 (254个IP)
192.168.0.0/16  → 192.168.0.1 到 192.168.255.254 (65534个IP)  
10.0.0.0/8      → 10.0.0.1 到 10.255.255.254 (16777214个IP)

快速理解：
/24 = 24位网络位 = 8位主机位 = 2^8-2 = 254个可用IP
/16 = 16位网络位 = 16位主机位 = 2^16-2 = 65534个可用IP
```

### 3.2 网段访问控制


**允许整个网段**：
```bash
# 允许整个内网网段访问
iptables -I INPUT -s 192.168.0.0/16 -j ACCEPT

# 允许公司网段访问SSH
iptables -I INPUT -s 10.10.0.0/16 -p tcp --dport 22 -j ACCEPT

# 允许特定子网访问数据库
iptables -I INPUT -s 172.16.100.0/24 -p tcp --dport 3306 -j ACCEPT
```

**拒绝网段访问**：
```bash
# 封禁整个可疑网段
iptables -I INPUT -s 1.2.3.0/24 -j DROP

# 拒绝某个国家的IP段（示例）
iptables -I INPUT -s 5.6.0.0/16 -j DROP
```

### 3.3 多网段组合控制


**复合网段规则**：
```bash
# 允许多个办公网段
iptables -I INPUT -s 192.168.1.0/24 -j ACCEPT
iptables -I INPUT -s 192.168.2.0/24 -j ACCEPT  
iptables -I INPUT -s 10.10.10.0/24 -j ACCEPT

# 使用脚本批量添加
#!/bin/bash
ALLOWED_NETWORKS="192.168.1.0/24 192.168.2.0/24 10.10.10.0/24"
for network in $ALLOWED_NETWORKS; do
    iptables -I INPUT -s $network -j ACCEPT
done
```

---

## 4. 🛡️ 黑名单与白名单机制


### 4.1 白名单策略（推荐）


**原理**：默认拒绝所有，只允许指定的IP/网段

```bash
# 第1步：清空现有规则
iptables -F INPUT

# 第2步：设置默认策略为拒绝
iptables -P INPUT DROP

# 第3步：允许本地环回
iptables -I INPUT -i lo -j ACCEPT

# 第4步：允许已建立的连接
iptables -I INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 第5步：添加白名单IP
iptables -I INPUT -s 192.168.1.100 -j ACCEPT
iptables -I INPUT -s 10.10.10.0/24 -j ACCEPT
```

**白名单的优势**：
- 🔒 **安全性最高**：未授权IP无法访问
- 🎯 **精确控制**：明确知道谁能访问
- 🛡️ **防御未知威胁**：新出现的攻击IP自动被阻止

### 4.2 黑名单策略


**原理**：默认允许所有，拒绝指定的恶意IP

```bash
# 保持默认允许策略
iptables -P INPUT ACCEPT

# 添加恶意IP到黑名单
iptables -I INPUT -s 1.2.3.4 -j DROP
iptables -I INPUT -s 5.6.7.8 -j DROP
iptables -I INPUT -s 9.10.11.0/24 -j DROP
```

**黑名单管理脚本**：
```bash
#!/bin/bash
# 恶意IP黑名单文件
BLACKLIST_FILE="/etc/iptables/blacklist.txt"

# 读取黑名单并添加规则
while read -r ip; do
    if [[ ! $ip =~ ^#.*$ ]] && [[ -n $ip ]]; then
        iptables -I INPUT -s "$ip" -j DROP
        echo "已封禁: $ip"
    fi
done < "$BLACKLIST_FILE"
```

### 4.3 策略选择指导


```
┌─ 安全策略对比 ─────────────────────┐
│                                    │
│ 🏢 企业内部服务器                  │
│ → 推荐白名单：只允许办公网段       │
│                                    │  
│ 🌐 公共Web服务器                   │
│ → 推荐黑名单：允许所有访问但       │
│   及时封禁恶意IP                   │
│                                    │
│ 🔐 关键业务系统                    │
│ → 严格白名单：仅允许必要IP         │
│                                    │
└────────────────────────────────────┘
```

---

## 5. 🌍 地理位置IP限制


### 5.1 基于国家的IP限制


**应用场景**：某些服务只对特定国家开放，或屏蔽高风险地区

**使用GeoIP模块**：
```bash
# 安装GeoIP模块（CentOS/RHEL）
yum install iptables-services xtables-addons-common

# 下载GeoIP数据库
mkdir -p /usr/share/xt_geoip
wget -O GeoIPCountryDB.dat http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz
gunzip GeoIP.dat.gz
```

**地理位置规则示例**：
```bash
# 只允许中国IP访问
iptables -I INPUT -m geoip --src-cc CN -j ACCEPT
iptables -I INPUT -j DROP

# 拒绝特定国家IP
iptables -I INPUT -m geoip --src-cc RU,KP -j DROP

# 允许多个国家访问特定服务
iptables -I INPUT -p tcp --dport 80 -m geoip --src-cc US,CA,GB -j ACCEPT
```

### 5.2 简单的地理位置控制


**基于已知IP段的方法**：
```bash
# 中国电信IP段（示例）
iptables -I INPUT -s 61.135.0.0/16 -j ACCEPT
iptables -I INPUT -s 124.115.0.0/16 -j ACCEPT

# 屏蔽已知的海外攻击IP段
iptables -I INPUT -s 41.0.0.0/8 -j DROP     # 非洲部分地区
iptables -I INPUT -s 186.0.0.0/8 -j DROP    # 南美部分地区
```

**💡 实用建议**：
- 地理位置限制可能误伤正常用户
- 适合对地理位置有严格要求的业务
- 建议结合业务需求谨慎使用

---

## 6. 🏠 内网外网访问控制


### 6.1 内网IP识别与控制


**常见内网IP段**：
```
私有IP地址范围：
10.0.0.0/8      → 10.0.0.0 至 10.255.255.255
172.16.0.0/12   → 172.16.0.0 至 172.31.255.255  
192.168.0.0/16  → 192.168.0.0 至 192.168.255.255

特殊IP：
127.0.0.0/8     → 本地回环地址
169.254.0.0/16  → 链路本地地址（APIPA）
```

### 6.2 内网访问控制策略


**允许内网全面访问**：
```bash
# 允许所有私有IP段
iptables -I INPUT -s 10.0.0.0/8 -j ACCEPT
iptables -I INPUT -s 172.16.0.0/12 -j ACCEPT
iptables -I INPUT -s 192.168.0.0/16 -j ACCEPT

# 允许本地回环
iptables -I INPUT -s 127.0.0.0/8 -j ACCEPT
```

**内网分级访问控制**：
```bash
# 管理网段：全部权限
iptables -I INPUT -s 192.168.100.0/24 -j ACCEPT

# 办公网段：限制端口
iptables -I INPUT -s 192.168.10.0/24 -p tcp --dport 22 -j ACCEPT
iptables -I INPUT -s 192.168.10.0/24 -p tcp --dport 80 -j ACCEPT

# 访客网段：仅Web访问  
iptables -I INPUT -s 192.168.200.0/24 -p tcp --dport 80 -j ACCEPT
iptables -I INPUT -s 192.168.200.0/24 -p tcp --dport 443 -j ACCEPT
```

### 6.3 外网访问限制


**严格的外网访问控制**：
```bash
# 方法1：拒绝所有外网IP，仅允许内网
iptables -P INPUT DROP
iptables -I INPUT -s 192.168.0.0/16 -j ACCEPT
iptables -I INPUT -s 10.0.0.0/8 -j ACCEPT
iptables -I INPUT -s 172.16.0.0/12 -j ACCEPT

# 方法2：外网仅允许特定服务
iptables -I INPUT -s ! 192.168.0.0/16 -p tcp --dport 80 -j ACCEPT
iptables -I INPUT -s ! 192.168.0.0/16 -p tcp --dport 443 -j ACCEPT
iptables -I INPUT -s ! 192.168.0.0/16 -j DROP
```

---

## 7. 🔐 VPN网段访问控制


### 7.1 VPN网段识别


**常见VPN网段**：
```bash
OpenVPN默认：       10.8.0.0/24
IPSec VPN：        192.168.100.0/24  
WireGuard：        10.0.0.0/24
企业VPN：          172.20.0.0/16
```

### 7.2 VPN用户访问控制


**基础VPN访问规则**：
```bash
# 允许VPN网段访问内部资源
iptables -I INPUT -s 10.8.0.0/24 -j ACCEPT

# VPN用户访问数据库服务器
iptables -I INPUT -s 10.8.0.0/24 -p tcp --dport 3306 -j ACCEPT

# VPN管理员特殊权限
iptables -I INPUT -s 10.8.0.100 -j ACCEPT
```

**分级VPN访问控制**：
```bash
# 管理员VPN（10.8.0.1-10.8.0.50）
iptables -I INPUT -s 10.8.0.0/27 -j ACCEPT

# 普通员工VPN（10.8.0.100-10.8.0.200）
iptables -I INPUT -s 10.8.0.100/26 -p tcp --dport 22 -j ACCEPT
iptables -I INPUT -s 10.8.0.100/26 -p tcp --dport 80 -j ACCEPT

# 临时VPN用户（仅Web访问）
iptables -I INPUT -s 10.8.0.200/29 -p tcp --dport 80 -j ACCEPT
iptables -I INPUT -s 10.8.0.200/29 -p tcp --dport 443 -j ACCEPT
```

### 7.3 VPN安全策略


**VPN访问监控**：
```bash
# 记录VPN访问日志
iptables -I INPUT -s 10.8.0.0/24 -j LOG --log-prefix "VPN_ACCESS: "

# 限制VPN并发连接
iptables -I INPUT -s 10.8.0.0/24 -p tcp --dport 22 -m connlimit --connlimit-above 3 -j REJECT

# 防止VPN用户访问内网其他服务器
iptables -I FORWARD -s 10.8.0.0/24 -d 192.168.2.0/24 -j DROP
```

---

## 8. ⚡ 动态IP处理方案


### 8.1 动态IP的挑战


**问题场景**：
- 家庭宽带IP经常变化
- 移动办公人员位置不固定  
- 云服务器IP可能调整

### 8.2 动态IP解决方案


**方法1：域名动态解析**
```bash
#!/bin/bash
# 通过域名获取当前IP并更新规则
DOMAIN="office.example.com"
OLD_IP=$(iptables -L INPUT -n | grep "office-access" | awk '{print $4}')
NEW_IP=$(dig +short $DOMAIN)

if [ "$OLD_IP" != "$NEW_IP" ]; then
    # 删除旧规则
    iptables -D INPUT -s $OLD_IP -j ACCEPT -m comment --comment "office-access"
    # 添加新规则
    iptables -I INPUT -s $NEW_IP -j ACCEPT -m comment --comment "office-access"
    echo "IP更新：$OLD_IP → $NEW_IP"
fi
```

**方法2：预授权IP池**
```bash
# 预先允许可能的IP范围
iptables -I INPUT -s 123.45.0.0/16 -j ACCEPT    # ISP分配的IP段
iptables -I INPUT -s 67.89.0.0/16 -j ACCEPT     # 备用ISP IP段
```

**方法3：端口敲门技术**
```bash
# 安装knockd
yum install knock-server

# 配置文件 /etc/knockd.conf
[openSSH]
    sequence    = 7000,8000,9000
    seq_timeout = 5  
    command     = iptables -I INPUT -s %IP% -p tcp --dport 22 -j ACCEPT
    tcpflags    = syn
```

### 8.3 自动化管理脚本


**IP变化检测脚本**：
```bash
#!/bin/bash
# 文件：/usr/local/bin/dynamic-ip-manager.sh

LOG_FILE="/var/log/dynamic-ip.log"
IP_FILE="/var/lib/iptables/allowed-ips.txt"

# 函数：记录日志
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

# 函数：更新IP规则
update_ip_rule() {
    local old_ip=$1
    local new_ip=$2
    local comment=$3
    
    # 删除旧规则
    if [ -n "$old_ip" ]; then
        iptables -D INPUT -s $old_ip -j ACCEPT -m comment --comment "$comment" 2>/dev/null
        log_message "删除旧IP规则: $old_ip"
    fi
    
    # 添加新规则
    iptables -I INPUT -s $new_ip -j ACCEPT -m comment --comment "$comment"
    log_message "添加新IP规则: $new_ip"
}

# 定期执行，放入crontab
# */5 * * * * /usr/local/bin/dynamic-ip-manager.sh
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🎯 核心技能清单：
✅ 单IP和网段的控制语法
✅ 黑名单和白名单策略选择  
✅ 内网外网访问权限设计
✅ VPN网段的安全管理
✅ 动态IP的处理方法
```

### 9.2 最佳实践策略


**🔸 安全优先原则**
```
推荐策略组合：
1. 默认拒绝 + 白名单机制
2. 内网分级访问控制
3. 关键服务严格IP限制
4. 定期审查和清理规则
```

**🔸 规则管理技巧**
```bash
# 1. 使用注释标记规则用途
iptables -I INPUT -s 192.168.1.100 -j ACCEPT -m comment --comment "admin-access"

# 2. 定期备份规则
iptables-save > /etc/iptables/rules.backup.$(date +%Y%m%d)

# 3. 测试规则前保留后门
iptables -I INPUT -p tcp --dport 22 -j ACCEPT -m comment --comment "emergency-ssh"
```

**🔸 故障排查要点**
```
常见问题检查：
- 规则顺序是否正确（-I vs -A）
- 默认策略是否过于严格
- 是否误封了自己的IP
- 日志记录是否开启
```

### 9.3 实际应用场景指南


| 应用场景 | 推荐策略 | 关键配置 |
|---------|---------|---------|
| **🏢 企业内网服务器** | 严格白名单 | 仅允许办公网段+VPN |
| **🌐 公共Web服务** | 黑名单为主 | 封禁恶意IP，允许全球访问 |
| **🔐 数据库服务器** | 极严格白名单 | 仅允许应用服务器IP |
| **📱 API接口服务** | IP+频率限制 | 合作伙伴IP+访问频率控制 |
| **🏠 家庭NAS** | 动态IP+端口敲门 | 处理ISP动态分配IP |

### 9.4 安全建议


**⚠️ 重要提醒**
```
操作前必做：
1. 📋 备份当前规则
2. 🚪 保留管理后门  
3. 🕰️ 设置自动恢复计划
4. 📞 准备应急联系方式

安全建议：
• 定期审查访问日志
• 及时更新恶意IP黑名单  
• 监控异常访问模式
• 建立规则变更审批流程
```

**🎯 记忆要点**
- **白名单更安全**：默认拒绝，精确允许
- **网段比单IP灵活**：用CIDR表示法管理IP范围
- **内网外网要区分**：不同网络不同权限
- **动态IP需特殊处理**：域名解析或预授权IP池
- **规则顺序很重要**：iptables按顺序匹配，先匹配先执行

通过这些IP访问控制策略，你可以构建一个既安全又灵活的网络防护体系！