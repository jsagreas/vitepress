---
title: 3、iptables命令语法与基本操作
---
## 📚 目录

1. [iptables基本概念](#1-iptables基本概念)
2. [命令基本格式](#2-命令基本格式)
3. [规则管理操作](#3-规则管理操作)
4. [规则查看与列出](#4-规则查看与列出)
5. [链策略设置](#5-链策略设置)
6. [规则位置控制](#6-规则位置控制)
7. [规则清理操作](#7-规则清理操作)
8. [常用参数详解](#8-常用参数详解)
9. [实际操作示例](#9-实际操作示例)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔥 iptables基本概念


### 1.1 什么是iptables


💭 **简单理解**：iptables就像是Linux系统的"门卫"，负责检查进出服务器的网络数据包，决定哪些允许通过，哪些要拒绝。

🏷️ **专业术语**：`iptables` = Linux内核防火墙系统的用户空间控制工具

**🔍 深入理解**：
```
现实类比：
机场安检 ←→ iptables防火墙
护照检查 ←→ 源IP地址检查  
行李检查 ←→ 数据包内容检查
登机牌验证 ←→ 端口和协议验证
安检规则 ←→ iptables规则
```

### 1.2 核心组成要素


**📋 知识清单**：
- ✅ **表（Table）**：不同功能的规则分类容器
- ✅ **链（Chain）**：规则的执行序列
- ✅ **规则（Rule）**：具体的过滤条件和动作
- ✅ **目标（Target）**：规则匹配后的处理方式

**🏗️ 知识架构**：
```
iptables系统结构：
┌─────────────────┐
│    iptables     │ ← 用户命令工具
├─────────────────┤
│   netfilter     │ ← 内核防火墙框架
├─────────────────┤
│  Linux Kernel   │ ← 系统内核
└─────────────────┘

数据流向：
网络数据包 → netfilter钩子 → iptables规则 → 处理结果
```

---

## 2. 📝 命令基本格式


### 2.1 标准命令结构


**🎯 学习目标**：掌握iptables命令的标准格式和基本语法

**基本语法格式**：
```bash
iptables [-t 表名] 命令选项 [链名] [规则匹配条件] [-j 目标动作]
```

**🔢 步骤分解**：
1. **指定表**：`-t table` (可选，默认filter表)
2. **命令操作**：如`-A`添加、`-D`删除等
3. **目标链**：INPUT、OUTPUT、FORWARD等
4. **匹配条件**：IP地址、端口、协议等
5. **处理动作**：ACCEPT、DROP、REJECT等

### 2.2 命令格式示例


🌰 **举个例子**：
```bash
# 完整命令示例
iptables -t filter -A INPUT -s 192.168.1.100 -p tcp --dport 22 -j ACCEPT

# 拆解理解：
-t filter     # 操作filter表（可省略，这是默认表）
-A INPUT      # 向INPUT链添加规则
-s 192.168.1.100  # 源IP匹配条件
-p tcp        # 协议匹配条件  
--dport 22    # 目标端口匹配条件
-j ACCEPT     # 匹配后的动作：接受
```

**🔄 换句话说**：这条命令的意思是"允许IP地址为192.168.1.100的机器通过TCP协议访问本机的22端口"。

---

## 3. ⚙️ 规则管理操作


### 3.1 添加规则（-A/-I）


**📚 前置知识**：规则添加有两种方式，追加到末尾或插入到指定位置。

**💡 概念澄清**：
- **`-A`（Append）**：把规则添加到链的**末尾**
- **`-I`（Insert）**：把规则**插入**到链的指定位置

**基本用法**：
```bash
# 追加规则到INPUT链末尾
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# 插入规则到INPUT链的第1位（最优先）
iptables -I INPUT 1 -p tcp --dport 443 -j ACCEPT

# 插入规则到INPUT链的第3位
iptables -I INPUT 3 -s 192.168.1.0/24 -j ACCEPT
```

**🤔 为什么这样**：
- 规则按顺序执行，**先匹配的规则先生效**
- 重要的规则要放在前面，确保优先执行
- 默认策略通常是最后的"兜底"规则

### 3.2 删除规则（-D）


**删除方式对比**：

| 删除方法 | **语法** | **优缺点** |
|---------|---------|-----------|
| 📍 **按规则内容删除** | `iptables -D INPUT -p tcp --dport 80 -j ACCEPT` | `精确但命令长` |
| 🔢 **按行号删除** | `iptables -D INPUT 3` | `简单但需要先查行号` |

**实际操作**：
```bash
# 方法1：按完整规则内容删除
iptables -D INPUT -s 192.168.1.100 -p tcp --dport 22 -j ACCEPT

# 方法2：先查看规则编号，再按编号删除
iptables -L INPUT --line-numbers  # 查看带行号的规则
iptables -D INPUT 2               # 删除第2条规则
```

**💥 容易出错**：删除规则时，如果按内容删除，命令必须与添加时**完全一致**，包括参数顺序。

---

## 4. 📊 规则查看与列出


### 4.1 基本查看命令（-L）


**🎭 角色扮演**：把自己当作系统管理员，需要检查当前防火墙规则配置。

**常用查看选项**：

```bash
# 基本查看（显示所有链的规则）
iptables -L

# 查看指定链
iptables -L INPUT

# 详细显示（包含数据包统计）
iptables -L -v

# 显示行号（便于删除规则）
iptables -L --line-numbers

# 数字显示IP和端口（不解析域名）
iptables -L -n
```

**🔍 输出内容解读**：
```bash
# 示例输出
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num  target     prot opt source        destination         
1    ACCEPT     tcp  --  192.168.1.100 anywhere    tcp dpt:ssh
2    DROP       all  --  anywhere      anywhere    

# 字段含义：
num        # 规则编号
target     # 目标动作（ACCEPT/DROP等）
prot       # 协议类型（tcp/udp/icmp等）
opt        # 额外选项
source     # 源地址
destination # 目标地址
```

### 4.2 规则导出（-S）


**🛠️ 工具推荐**：使用`-S`选项可以导出规则配置，便于备份和迁移。

```bash
# 导出所有规则（可直接执行的命令格式）
iptables -S

# 导出指定链的规则
iptables -S INPUT

# 保存到文件
iptables-save > /etc/iptables/rules.v4
```

**✅ 最佳实践**：修改重要规则前，先导出当前配置作为备份。

---

## 5. 🔧 链策略设置


### 5.1 什么是链策略


💭 **思考一下**：如果数据包不匹配任何规则，系统应该怎么处理？

**🏷️ 专业术语**：`链策略`（Policy）= 当数据包不匹配任何规则时的**默认处理方式**

**策略类型**：
- **ACCEPT**：默认允许通过
- **DROP**：默认丢弃（静默拒绝）
- **REJECT**：默认拒绝（返回错误信息）

### 5.2 策略设置操作


**🔢 步骤分解**：
1. 查看当前策略
2. 设置新策略
3. 验证策略生效

```bash
# 查看当前策略
iptables -L | head -5

# 设置INPUT链默认策略为DROP
iptables -P INPUT DROP

# 设置OUTPUT链默认策略为ACCEPT  
iptables -P OUTPUT ACCEPT

# 设置FORWARD链默认策略为DROP
iptables -P FORWARD DROP
```

**🚨 重要提醒**：设置策略为DROP前，确保有允许SSH连接的规则，否则可能断开远程连接！

**安全操作顺序**：
```bash
# 1. 先添加允许SSH的规则
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 2. 添加允许本地回环的规则
iptables -A INPUT -i lo -j ACCEPT

# 3. 再设置默认策略为DROP
iptables -P INPUT DROP
```

---

## 6. 🎯 规则位置控制


### 6.1 规则编号系统


**🔍 深入理解**：iptables中的规则按照编号顺序执行，编号越小优先级越高。

**编号特点**：
```
规则执行顺序：
1. 第1条规则（最高优先级）
2. 第2条规则  
3. 第3条规则
...
n. 第n条规则
默认策略（最后兜底）
```

### 6.2 位置控制操作


**插入规则到指定位置**：
```bash
# 插入到第1位（最高优先级）
iptables -I INPUT 1 -s 10.0.0.0/8 -j ACCEPT

# 插入到第3位
iptables -I INPUT 3 -p icmp -j ACCEPT

# 如果不指定位置，默认插入到第1位
iptables -I INPUT -p tcp --dport 443 -j ACCEPT
```

**🌰 举个例子**：假设你想禁止某个IP访问，但又想允许它访问特定端口：
```bash
# 错误的顺序（不会生效）
iptables -A INPUT -s 192.168.1.50 -j DROP        # 先禁止所有
iptables -A INPUT -s 192.168.1.50 -p tcp --dport 80 -j ACCEPT  # 后允许80端口

# 正确的顺序（会生效）  
iptables -I INPUT 1 -s 192.168.1.50 -p tcp --dport 80 -j ACCEPT # 先允许80端口
iptables -I INPUT 2 -s 192.168.1.50 -j DROP                    # 再禁止其他
```

**🤔 为什么这样**：规则是从上到下匹配的，一旦匹配就执行动作，不会继续检查后面的规则。

---

## 7. 🧹 规则清理操作


### 7.1 清空规则（-F）


**💭 思考一下**：什么时候需要清空防火墙规则？

**使用场景**：
- 🔄 **重新配置**：推倒重来配置新规则
- 🚨 **紧急恢复**：配置错误需要快速恢复
- 🧪 **测试环境**：实验不同的配置方案

**清空操作**：
```bash
# 清空指定链的所有规则
iptables -F INPUT

# 清空所有链的规则
iptables -F

# 清空指定表的所有规则
iptables -t nat -F
```

### 7.2 删除用户自定义链（-X）


**📋 知识清单**：
- 系统内置链（INPUT/OUTPUT/FORWARD）不能删除
- 只能删除空的用户自定义链
- 删除前需要先清空链中的规则

```bash
# 删除用户自定义链（链必须为空）
iptables -X MY_CUSTOM_CHAIN

# 删除所有空的用户自定义链
iptables -X
```

### 7.3 重置计数器（-Z）


**🏷️ 专业术语**：`计数器` = iptables统计每条规则匹配的数据包数量和字节数

```bash
# 重置指定链的计数器
iptables -Z INPUT

# 重置所有链的计数器  
iptables -Z

# 重置指定规则的计数器
iptables -Z INPUT 2
```

**🔗 知识串联**：计数器统计功能配合`-L -v`命令，可以监控规则的使用情况。

---

## 8. ⚡ 常用参数详解


### 8.1 协议指定参数


**协议参数格式**：
```bash
-p tcp     # TCP协议
-p udp     # UDP协议  
-p icmp    # ICMP协议（ping命令使用）
-p all     # 所有协议（默认值）
```

**端口参数**：
```bash
--sport 80          # 源端口为80
--dport 443         # 目标端口为443
--sport 1000:2000   # 源端口范围1000-2000
--dport :1024       # 目标端口小于等于1024
--dport 1024:       # 目标端口大于等于1024
```

### 8.2 地址匹配参数


**IP地址参数**：
```bash
-s 192.168.1.100      # 源IP为192.168.1.100
-d 10.0.0.1           # 目标IP为10.0.0.1
-s 192.168.1.0/24     # 源IP网段192.168.1.0/24
-s ! 192.168.1.100    # 源IP不是192.168.1.100（取反）
```

**网络接口参数**：
```bash
-i eth0    # 从eth0网卡进入的数据包
-o eth1    # 从eth1网卡输出的数据包
-i lo      # 本地回环接口
```

### 8.3 状态匹配参数


**连接状态**：
```bash
-m state --state NEW        # 新连接
-m state --state ESTABLISHED # 已建立的连接
-m state --state RELATED    # 相关连接
-m state --state INVALID    # 无效连接
```

**🌰 举个例子**：
```bash
# 允许新的SSH连接建立
iptables -A INPUT -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT

# 允许已建立连接的响应数据
iptables -A OUTPUT -m state --state ESTABLISHED -j ACCEPT
```

---

## 9. 🛠️ 实际操作示例


### 9.1 基础防火墙配置


**🎯 场景模拟**：为Web服务器配置基本防火墙规则。

**完整配置流程**：
```bash
# 1. 清空现有规则
iptables -F

# 2. 设置默认策略
iptables -P INPUT DROP
iptables -P FORWARD DROP  
iptables -P OUTPUT ACCEPT

# 3. 允许本地回环
iptables -A INPUT -i lo -j ACCEPT

# 4. 允许已建立的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 5. 允许SSH管理
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 6. 允许Web服务
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 7. 允许ping
iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
```

### 9.2 规则验证与调试


**规则测试步骤**：
```bash
# 1. 查看规则配置
iptables -L -n -v --line-numbers

# 2. 测试连接
telnet 目标IP 端口

# 3. 查看规则命中情况
iptables -L -v | grep "规则关键字"

# 4. 实时监控规则匹配
watch -n 1 'iptables -L -v -n'
```

**🔧 解决方案**：如果规则不生效，检查以下几点：
- ✅ 规则顺序是否正确
- ✅ 参数是否完整准确
- ✅ 默认策略是否合理
- ✅ 服务是否正在运行

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的基本概念


```
🔸 命令格式：iptables [-t 表] 命令 [链] [条件] [-j 动作]
🔸 规则管理：-A追加 -I插入 -D删除 -L查看 -F清空
🔸 策略设置：-P设置链的默认处理策略
🔸 参数选项：-p协议 -s源地址 -d目标地址 --sport/dport端口
🔸 执行顺序：规则按编号从小到大依次匹配执行
```

### 10.2 关键理解要点


**🔹 规则顺序的重要性**：
```
理解要点：
- 规则是按顺序匹配的，先匹配的先执行
- 一旦匹配就执行动作，不再检查后续规则
- 重要规则要放在前面，确保优先生效
```

**🔹 策略与规则的关系**：
```
记忆方法：
- 规则 = 具体的条件和动作
- 策略 = 兜底的默认处理方式  
- 先检查规则，规则不匹配才执行策略
```

**🔹 安全配置原则**：
```
最佳实践：
- 先允许必要服务，再设置严格策略
- 远程管理时必须保留SSH规则
- 修改前做好备份，测试后再应用
```

### 10.3 实际应用价值


**📊 数据说话**：
- **安全防护**：阻止99%的恶意扫描和攻击
- **访问控制**：精确控制服务访问权限
- **流量管理**：基于规则进行流量过滤
- **合规要求**：满足企业安全规范要求

**🏢 实际应用**：
- **Web服务器**：只允许80/443端口访问
- **数据库服务器**：只允许应用服务器连接
- **内网隔离**：不同网段间的访问控制
- **开发测试**：快速搭建网络访问环境

**🎓 能力等级**：
- ⭐ **初级**：能够查看和添加基本规则
- ⭐⭐ **中级**：熟练配置常见服务的防火墙规则
- ⭐⭐⭐ **高级**：能够设计复杂的网络访问控制策略

**📝 一句话总结**：iptables是Linux网络安全的第一道防线，掌握基本命令操作是系统管理员的必备技能。

**🔑 关键词提取**：iptables、防火墙、规则、链、策略、INPUT、OUTPUT、ACCEPT、DROP、端口、协议