---
title: 5、目标动作与处理方式
---
## 📚 目录

1. [目标动作基本概念](#1-目标动作基本概念)
2. [基础处理动作详解](#2-基础处理动作详解)
3. [日志记录与调试](#3-日志记录与调试)
4. [流量控制动作](#4-流量控制动作)
5. [地址转换动作](#5-地址转换动作)
6. [实际应用场景](#6-实际应用场景)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🎯 目标动作基本概念


### 1.1 什么是目标动作


> **💡 核心理解**  
> iptables的目标动作就像是"交警的手势"，告诉数据包该怎么办：是放行、拦截、记录，还是做其他处理。

**目标动作的本质**：
```
数据包流向示意：
┌─────────┐    规则匹配    ┌─────────┐    目标动作    ┌─────────┐
│ 数据包  │ ─────────────> │ iptables │ ─────────────> │ 处理结果 │
│ 进入    │                │  规则   │                │ 输出    │
└─────────┘                └─────────┘                └─────────┘

就像生活中的安检：
进入商场 → 安检规则判断 → 执行动作(放行/拒绝/登记)
```

### 1.2 目标动作的工作原理


**基本语法结构**：
```bash
iptables -t 表名 -操作 链名 匹配条件 -j 目标动作
```

**实际理解**：
- **匹配条件**：什么样的数据包（比如来自哪里、去哪里）
- **目标动作**：对这些数据包做什么处理
- **链的概念**：数据包经过的不同检查点

```
数据包处理流程：
客户端请求 → INPUT链检查 → 本地进程处理 → OUTPUT链检查 → 响应返回
     ↓            ↓              ↓              ↓            ↓
   数据包      规则匹配        应用处理        规则匹配      返回结果
```

---

## 2. ✅ 基础处理动作详解


### 2.1 ACCEPT：允许通过


> **🔍 深入理解**  
> ACCEPT就像绿灯，告诉数据包"可以通过，一路畅行"

**ACCEPT的特点**：
- 数据包被允许继续传输
- 停止在当前链中继续匹配其他规则
- 数据包正常到达目的地

**实际应用示例**：
```bash
# 允许SSH连接（端口22）
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 允许本地回环通信
iptables -A INPUT -i lo -j ACCEPT

# 允许已建立的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```

**生活类比**：
```
就像小区门禁：
住户刷卡 → 门禁识别 → 显示绿灯 → 开门放行
数据包  → 规则匹配 → ACCEPT → 正常传输
```

### 2.2 DROP：丢弃数据包


> **⚠️ 重要特性**  
> DROP是"无声拒绝"，数据包被悄悄丢掉，发送方不知道发生了什么

**DROP的工作方式**：
- 数据包被直接丢弃
- 不给发送方任何回复
- 发送方会超时等待

**典型使用场景**：
```bash
# 拒绝来自特定IP的访问
iptables -A INPUT -s 192.168.1.100 -j DROP

# 阻止ping请求
iptables -A INPUT -p icmp --icmp-type echo-request -j DROP

# 默认拒绝所有未明确允许的连接
iptables -P INPUT DROP
```

**DROP vs 传统拒绝的区别**：
```
传统拒绝方式：
客户端请求 → 服务器 → "拒绝访问"回复 → 客户端知道被拒绝

DROP方式：
客户端请求 → 防火墙 → 数据包消失 → 客户端超时等待
```

> **💭 使用建议**  
> DROP适合阻止恶意扫描和攻击，因为攻击者无法确定目标主机是否存在

### 2.3 REJECT：拒绝并回复


> **🔄 对比理解**  
> 如果说DROP是"装死"，那REJECT就是"明确拒绝"

**REJECT的特点**：
- 拒绝数据包并发送错误信息
- 告诉发送方连接被拒绝的原因
- 比DROP更"礼貌"，但会暴露主机存在

**常用REJECT类型**：

| 拒绝类型 | 说明 | 使用场景 |
|---------|------|----------|
| `icmp-port-unreachable` | 端口不可达（默认） | 一般拒绝 |
| `icmp-net-unreachable` | 网络不可达 | 网络层拒绝 |
| `icmp-host-unreachable` | 主机不可达 | 主机层拒绝 |
| `tcp-reset` | TCP复位 | TCP连接拒绝 |

**实际应用**：
```bash
# 拒绝FTP连接并告知原因
iptables -A INPUT -p tcp --dport 21 -j REJECT --reject-with icmp-port-unreachable

# 拒绝TCP连接并发送RST
iptables -A INPUT -p tcp --dport 80 -j REJECT --reject-with tcp-reset
```

**DROP vs REJECT选择指南**：
```
🔐 安全性考虑：
DROP：更隐蔽，适合防止扫描
REJECT：更明确，适合正常的访问控制

⏱️ 响应速度：
DROP：客户端需要等待超时
REJECT：客户端立即收到拒绝信息

🎯 使用建议：
内网环境：多用REJECT（用户体验好）
公网环境：多用DROP（安全性高）
```

---

## 3. 📝 日志记录与调试


### 3.1 LOG：记录日志


> **🔍 调试神器**  
> LOG动作不会阻止或允许数据包，而是把匹配的数据包信息记录下来，继续匹配后面的规则

**LOG的用途**：
- 监控网络访问情况
- 调试防火墙规则
- 安全审计和分析
- 故障排查

**基本LOG语法**：
```bash
# 记录所有SSH尝试
iptables -A INPUT -p tcp --dport 22 -j LOG --log-prefix "SSH_ATTEMPT: "

# 记录被拒绝的连接
iptables -A INPUT -j LOG --log-prefix "DROPPED: " --log-level 4
iptables -A INPUT -j DROP
```

**LOG选项详解**：

| 选项 | 作用 | 示例 |
|------|------|------|
| `--log-prefix` | 日志前缀标识 | `"WEB_ACCESS: "` |
| `--log-level` | 日志级别(0-7) | `4`(警告级别) |
| `--log-tcp-sequence` | 记录TCP序列号 | 调试TCP问题 |
| `--log-tcp-options` | 记录TCP选项 | 详细TCP分析 |

### 3.2 日志查看与分析


**日志位置**：
```bash
# CentOS/RHEL系统
tail -f /var/log/messages

# Ubuntu/Debian系统  
tail -f /var/log/syslog

# 专门查看iptables日志
dmesg | grep -i iptables
```

**日志格式解读**：
```
实际日志示例：
Sep 18 15:30:15 server kernel: SSH_ATTEMPT: IN=eth0 OUT= MAC=00:0c:29:xx:xx:xx SRC=192.168.1.100 DST=192.168.1.10 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=12345 PROTO=TCP SPT=54321 DPT=22 

解读：
- SSH_ATTEMPT：我们设置的日志前缀
- IN=eth0：从eth0网卡进入
- SRC=192.168.1.100：来源IP
- DST=192.168.1.10：目标IP
- PROTO=TCP SPT=54321 DPT=22：TCP协议，源端口54321，目标端口22
```

---

## 4. 🔄 流量控制动作


### 4.1 RETURN：返回上级链


> **💡 理解要点**  
> RETURN就像函数中的return语句，停止当前链的处理，返回到调用它的地方

**RETURN的工作机制**：
```
主链调用自定义链的情况：
主链规则1
主链规则2 → 跳转到自定义链
             ↓
           自定义链规则1
           自定义链规则2
           RETURN ← 在这里返回
             ↑
主链规则3 ← 回到这里继续执行
```

**实际应用示例**：
```bash
# 创建自定义链处理Web访问
iptables -N WEB_RULES

# 在自定义链中处理HTTP/HTTPS
iptables -A WEB_RULES -p tcp --dport 80 -j ACCEPT
iptables -A WEB_RULES -p tcp --dport 443 -j ACCEPT
iptables -A WEB_RULES -j RETURN

# 主链调用自定义链
iptables -A INPUT -p tcp -j WEB_RULES
```

### 4.2 REDIRECT：端口重定向


> **🔀 应用场景**  
> REDIRECT主要用于透明代理，把访问某个端口的流量悄悄转到另一个端口

**常见用途**：
- 透明代理设置
- 端口映射
- 流量劫持（用于缓存等）

**实际应用**：
```bash
# 将80端口的流量重定向到8080端口
iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080

# 将DNS查询重定向到本地DNS服务
iptables -t nat -A PREROUTING -p udp --dport 53 -j REDIRECT --to-port 5353
```

**重定向工作流程**：
```
客户端想访问：服务器:80
      ↓
iptables拦截并重定向
      ↓  
实际访问：服务器:8080
      ↓
客户端无感知，以为访问的是80端口
```

---

## 5. 🌐 地址转换动作


### 5.1 SNAT：源地址转换


> **🏠 生活类比**  
> SNAT就像小区的门牌号系统，把内网的"楼栋号+房间号"统一改成小区的对外地址

**SNAT的作用**：
- 让内网主机可以访问互联网
- 隐藏内网真实IP地址
- 实现网络地址复用

**SNAT工作原理**：
```
内网访问外网流程：
内网主机(192.168.1.10) → 路由器 → 互联网服务器
     ↓                    ↓           ↓
原始数据包              SNAT转换    看到的来源IP
SRC: 192.168.1.10    →  SRC: 公网IP   公网IP
DST: 外网服务器         DST: 外网服务器  (隐藏了内网IP)
```

**SNAT配置示例**：
```bash
# 基本SNAT：将内网IP转换为指定公网IP
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j SNAT --to-source 202.103.1.1

# MASQUERADE：自动使用出口网卡的IP（动态IP场景）
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE

# 指定端口范围的SNAT
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j SNAT --to-source 202.103.1.1:1024-65535
```

### 5.2 DNAT：目标地址转换


> **🏢 理解场景**  
> DNAT像是公司的前台，外来访客说要找"张经理"，前台把他引导到"3楼305室的张经理"

**DNAT的用途**：
- 将公网访问转发到内网服务器
- 实现端口映射
- 负载均衡的基础

**DNAT工作流程**：
```
外网访问内网服务流程：
外网客户端 → 公网IP:80 → DNAT转换 → 内网Web服务器:80
    ↓             ↓          ↓             ↓
发起请求      到达防火墙    地址转换      实际处理请求
DST: 公网IP:80  →  DST: 192.168.1.10:80  →  响应请求
```

**DNAT配置示例**：
```bash
# 将公网80端口映射到内网Web服务器
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.10:80

# 将公网SSH端口映射到内网不同主机
iptables -t nat -A PREROUTING -p tcp --dport 2221 -j DNAT --to-destination 192.168.1.10:22
iptables -t nat -A PREROUTING -p tcp --dport 2222 -j DNAT --to-destination 192.168.1.11:22

# 端口映射到不同的内网端口
iptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to-destination 192.168.1.10:80
```

### 5.3 SNAT vs DNAT 对比理解


| 特性 | **SNAT** | **DNAT** |
|------|----------|----------|
| **转换对象** | 源地址（发送方） | 目标地址（接收方） |
| **使用场景** | 内网访问外网 | 外网访问内网服务 |
| **工作位置** | POSTROUTING链 | PREROUTING链 |
| **典型应用** | 共享上网、隐藏内网 | 服务器发布、端口映射 |

**记忆技巧**：
```
🎯 简单记忆法：
SNAT = Source NAT = 改源地址 = 出去的时候改
DNAT = Destination NAT = 改目标地址 = 进来的时候改

🔄 时机记忆：
SNAT：数据包要出门了，改一下"寄件人地址"
DNAT：数据包刚进门，改一下"收件人地址"
```

---

## 6. 🛠️ 实际应用场景


### 6.1 家用路由器场景


> **🏠 实际应用：小型家庭网络**

**网络拓扑**：
```
互联网 ←→ 路由器(iptables) ←→ 内网设备
             ↓
        ┌─────────────┐
        │  防火墙规则  │
        │ SNAT+安全策略│  
        └─────────────┘
             ↓
   192.168.1.2   192.168.1.3   192.168.1.4
   (电脑)        (手机)        (智能电视)
```

**配置方案**：
```bash
# 1. 基础SNAT：让内网设备上网
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE

# 2. 安全防护：拒绝外网主动连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -m state --state NEW -i eth0 -j DROP

# 3. 服务发布：将内网Web服务器发布到公网
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.10:80
```

### 6.2 企业网络场景


> **🏢 复杂场景：企业多区域网络**

**网络分区**：
```
                    互联网
                      ↓
                 ┌─────────┐
                 │ 边界防火墙 │
                 │ iptables │
                 └─────────┘
                      ↓
        ┌─────────────┼─────────────┐
        ↓             ↓             ↓
   DMZ区域        内网办公区      服务器区
   (Web服务器)     (员工电脑)    (数据库服务器)
   192.168.10.x   192.168.20.x   192.168.30.x
```

**分区访问策略**：
```bash
# DMZ区域规则：允许互联网访问Web服务，但限制访问内网
iptables -A FORWARD -s 0.0.0.0/0 -d 192.168.10.0/24 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -s 192.168.10.0/24 -d 192.168.20.0/24 -j DROP

# 办公区规则：允许访问互联网和特定服务器
iptables -A FORWARD -s 192.168.20.0/24 -d 0.0.0.0/0 -j ACCEPT
iptables -A FORWARD -s 192.168.20.0/24 -d 192.168.30.0/24 -p tcp --dport 3306 -j ACCEPT

# 服务器区规则：只允许特定访问
iptables -A INPUT -s 192.168.20.0/24 -d 192.168.30.0/24 -p tcp --dport 22 -j ACCEPT
```

### 6.3 Web服务器安全加固


> **🛡️ 实战案例：保护Web服务器**

**常见威胁与对策**：
```bash
# 1. 防止暴力破解SSH
iptables -A INPUT -p tcp --dport 22 -m recent --name SSH_ATTEMPTS --set
iptables -A INPUT -p tcp --dport 22 -m recent --name SSH_ATTEMPTS --rcheck --seconds 60 --hitcount 4 -j DROP

# 2. 限制Web访问频率
iptables -A INPUT -p tcp --dport 80 -m recent --name WEB_REQUESTS --set
iptables -A INPUT -p tcp --dport 80 -m recent --name WEB_REQUESTS --rcheck --seconds 10 --hitcount 20 -j DROP

# 3. 记录可疑访问
iptables -A INPUT -p tcp --dport 80 -m recent --name WEB_REQUESTS --rcheck --seconds 10 --hitcount 15 -j LOG --log-prefix "HIGH_FREQUENCY_ACCESS: "

# 4. 允许正常访问
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT
```

**分层防护策略**：
```
🔒 多层安全防护：
第1层：网络防火墙(硬件)
第2层：主机防火墙(iptables)  ← 我们的重点
第3层：应用程序安全
第4层：数据加密

🎯 防护重点：
- 端口访问控制
- 访问频率限制  
- 可疑行为记录
- 攻击自动阻断
```

---

## 7. 📋 核心要点总结


### 7.1 目标动作选择指南


> **🎯 快速选择参考**

| 需求场景 | **推荐动作** | **选择理由** |
|---------|-------------|-------------|
| **内网用户正常访问** | `ACCEPT` | 简单直接，性能最好 |
| **拒绝恶意扫描** | `DROP` | 隐蔽性好，不暴露信息 |
| **拒绝内网误操作** | `REJECT` | 用户能及时发现问题 |
| **调试规则问题** | `LOG` | 详细记录，便于分析 |
| **内网共享上网** | `SNAT/MASQUERADE` | 地址转换，隐藏内网 |
| **发布内网服务** | `DNAT` | 端口映射，服务可达 |

### 7.2 必须掌握的核心概念


**🔸 基础处理动作**：
- `ACCEPT`：绿灯放行，数据包正常传输
- `DROP`：静默丢弃，发送方超时等待
- `REJECT`：明确拒绝，发送错误信息给对方

**🔸 调试分析工具**：
- `LOG`：记录匹配的数据包信息，继续后续规则
- `RETURN`：返回上级链，用于自定义链管理

**🔸 地址转换核心**：
- `SNAT`：改源地址，用于内网访问外网
- `DNAT`：改目标地址，用于外网访问内网服务
- `REDIRECT`：端口重定向，用于透明代理

### 7.3 实战应用要点


**🔧 配置原则**：
```
1. 先配置允许规则，再配置拒绝规则
2. 重要服务先记录日志，再执行动作
3. 测试环境用REJECT，生产环境用DROP  
4. SNAT放在POSTROUTING，DNAT放在PREROUTING
```

**⚠️ 常见错误**：
```
❌ 错误做法：
- 在错误的链中配置NAT规则
- LOG规则后面不加其他动作
- SNAT和DNAT的表和链搞混

✅ 正确做法：
- NAT规则必须在nat表中配置
- LOG后面要跟ACCEPT、DROP等终结动作
- 记住"出门SNAT，进门DNAT"的原则
```

### 7.4 性能与安全平衡


**🚀 性能考虑**：
- LOG动作会影响性能，仅在必要时使用
- 复杂的匹配条件放在简单条件后面
- 使用MASQUERADE比固定SNAT稍慢但更灵活

**🛡️ 安全考虑**：
- 生产环境默认策略设为DROP
- 重要服务的访问都要记录日志
- 定期分析日志，发现异常访问模式

**核心记忆口诀**：
```
🎪 动作记忆法：
ACCEPT放行绿灯亮，DROP丢弃静悄悄
REJECT拒绝告原因，LOG记录便调试  
SNAT出门改源址，DNAT进门改目标
RETURN返回上一级，动作选择要恰当
```

---

> **📚 学习建议**  
> 1. **动手实践**：在虚拟机中搭建测试环境，亲手配置各种动作
> 2. **日志分析**：学会读懂iptables日志，这是调试的关键技能  
> 3. **场景应用**：结合实际网络环境，理解不同动作的适用场景
> 4. **安全意识**：始终考虑安全性和隐蔽性的平衡

**下一步学习**：掌握了目标动作后，建议学习iptables的链和表的概念，以及如何编写复杂的规则组合。