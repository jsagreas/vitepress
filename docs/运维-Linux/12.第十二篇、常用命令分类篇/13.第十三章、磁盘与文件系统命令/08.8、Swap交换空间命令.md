---
title: 8、Swap交换空间命令
---
## 📚 目录

1. [Swap交换空间概述](#1-Swap交换空间概述)
2. [mkswap创建交换空间](#2-mkswap创建交换空间)
3. [swapon启用交换空间](#3-swapon启用交换空间)
4. [swapoff禁用交换空间](#4-swapoff禁用交换空间)
5. [交换文件创建方法](#5-交换文件创建方法)
6. [监控交换空间状态](#6-监控交换空间状态)
7. [交换空间实践配置](#7-交换空间实践配置)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 💾 Swap交换空间概述


### 1.1 什么是Swap交换空间


**简单理解**：Swap就像电脑的"临时仓库"，当内存不够用时，系统会把暂时不用的数据搬到硬盘上的特殊区域，需要时再搬回内存。

```
内存工作原理：
🏠 物理内存 (RAM)     - 真正的工作空间，速度快
📦 交换空间 (Swap)    - 临时存储空间，速度慢
🔄 交换过程 (Swapping) - 在两者间移动数据

实际类比：
内存 = 办公桌面 (有限但高效)
Swap = 文件柜   (容量大但查找慢)
当桌面放不下时，把不常用文件放入文件柜
```

### 1.2 交换空间的作用机制


**🔄 交换空间工作流程**：
```
系统内存充足时：
应用程序 ←→ 物理内存 (直接访问，速度快)

系统内存不足时：
应用程序 ←→ 物理内存 ←→ 交换空间
                    ↑
               内核自动管理数据换入换出
```

**💡 交换空间的核心价值**：
- **防止系统崩溃**：内存不足时避免程序被强制终止
- **支持更多应用**：可以运行超出物理内存限制的程序
- **内存管理优化**：把不活跃的内存页面换出，为活跃程序让路
- **休眠功能支持**：系统休眠时需要保存内存内容到swap

### 1.3 交换空间的类型


**📋 两种实现方式**：

| 类型 | **交换分区** | **交换文件** |
|------|-------------|-------------|
| **实现方式** | `独立的磁盘分区` | `文件系统中的普通文件` |
| **性能** | `稍快` | `稍慢` |
| **灵活性** | `固定大小，难调整` | `可动态调整大小` |
| **管理复杂度** | `需要分区规划` | `更容易管理` |
| **推荐场景** | `服务器，固定需求` | `桌面，灵活需求` |

---

## 2. 🔨 mkswap创建交换空间


### 2.1 mkswap命令概述


**mkswap是什么？**
mkswap就像是给一块区域贴上"交换空间"标签的工具，告诉系统"这里可以用来存放换出的内存数据"。

```
🎯 mkswap核心作用：
✅ 格式化交换分区或文件
✅ 写入交换空间的标识信息
✅ 设置交换空间的UUID和标签
✅ 为swapon启用做好准备
```

### 2.2 mkswap基本语法


**📝 命令格式**：
`mkswap [选项] 设备/文件`

**🔧 常用选项说明**：
- **`-L <标签>`** - 为交换空间设置标签名称
- **`-U <UUID>`** - 指定特定的UUID标识
- **`-c`** - 创建前检查坏块（谨慎使用）
- **`-v1`** - 使用版本1格式（兼容旧系统）

### 2.3 分区交换空间创建


**准备交换分区**：
```bash
# 查看现有分区状态
lsblk
fdisk -l

# 使用fdisk创建新分区（假设在/dev/sdb上）
sudo fdisk /dev/sdb
# 在fdisk中：n(新建) → p(主分区) → 设置大小 → t(改类型) → 82(Linux swap) → w(写入)

# 创建交换空间格式
sudo mkswap /dev/sdb1
```

**💡 创建过程详解**：
```
mkswap执行步骤：
1. 检查目标设备/文件
2. 写入交换空间头部信息
3. 设置页面映射表
4. 生成UUID标识
5. 显示创建结果

输出示例：
Setting up swapspace version 1, size = 2 GiB (2147479552 bytes)
no label, UUID=a1b2c3d4-e5f6-7890-abcd-ef1234567890
```

### 2.4 带标签的交换空间


**🏷️ 设置交换空间标签**：
```bash
# 创建带标签的交换空间
sudo mkswap -L myswap /dev/sdb1

# 查看创建结果
sudo blkid /dev/sdb1
# 输出：/dev/sdb1: LABEL="myswap" UUID="..." TYPE="swap"

# 使用标签引用（在/etc/fstab中更直观）
echo 'LABEL=myswap none swap sw 0 0' | sudo tee -a /etc/fstab
```

**⚠️ 重要注意事项**：
```
安全提醒：
🔴 mkswap会销毁目标设备上的所有数据
🔴 执行前务必确认设备路径正确
🔴 建议先备份重要数据
🔴 交换分区不需要文件系统，mkswap直接覆盖

检查确认：
✅ 使用lsblk确认分区路径
✅ 确保分区类型为Linux swap (82)
✅ 确认分区未被挂载使用
```

---

## 3. 🔄 swapon启用交换空间


### 3.1 swapon命令详解


**swapon是什么？**
如果说mkswap是"制作交换空间"，那么swapon就是"告诉系统开始使用它"。就像装好了仓库，现在要开门营业。

```
🎯 swapon主要功能：
✅ 激活交换分区或交换文件
✅ 显示当前交换空间状态
✅ 设置交换优先级
✅ 批量启用所有配置的交换空间
```

### 3.2 启用交换空间


**📱 基本启用操作**：
```bash
# 启用特定交换分区
sudo swapon /dev/sdb1

# 启用交换文件
sudo swapon /path/to/swapfile

# 使用标签启用
sudo swapon LABEL=myswap

# 使用UUID启用
sudo swapon UUID=a1b2c3d4-e5f6-7890-abcd-ef1234567890

# 启用/etc/fstab中配置的所有交换空间
sudo swapon -a
```

**🎚️ 设置交换优先级**：
```bash
# 设置优先级（数值越高优先级越高，范围-1到32767）
sudo swapon -p 10 /dev/sdb1
sudo swapon -p 5 /path/to/swapfile

# 查看优先级设置
cat /proc/swaps
```

**优先级使用策略**：
```
优先级规则：
🥇 高优先级 (10-32767)：SSD交换空间，速度快
🥈 中等优先级 (1-9)：普通硬盘交换空间
🥉 低优先级 (-1-0)：网络存储或临时交换

实际配置示例：
SSD交换分区：   优先级 10
HDD交换分区：   优先级 5  
临时交换文件：   优先级 1
```

### 3.3 查看交换状态


**📊 swapon状态查看**：
```bash
# 显示交换空间使用摘要
swapon -s
# 输出示例：
# Filename      Type      Size     Used   Priority
# /dev/sdb1     partition 2097148  0      10
# /swapfile     file      1048572  4096   5

# 显示详细信息（更易读的格式）
swapon --show
# 输出示例：
# NAME      TYPE      SIZE USED PRIO
# /dev/sdb1 partition   2G   0B   10
# /swapfile file        1G   4M    5

# 同时显示列标题（推荐使用）
swapon --show=NAME,TYPE,SIZE,USED,PRIO
```

**📋 状态信息解读**：
```
字段含义说明：
NAME/Filename：交换空间的路径或设备名
TYPE：类型（partition分区/file文件）  
SIZE：交换空间总大小
USED：当前已使用的大小
PRIO/Priority：优先级数值

使用建议：
✅ 定期检查USED值，了解系统内存压力
✅ 多个交换空间时关注优先级设置
✅ 注意TYPE类型，确保符合预期配置
```

---

## 4. ⏹️ swapoff禁用交换空间


### 4.1 swapoff命令作用


**swapoff是什么？**
swapoff就像关闭仓库一样，先把里面的东西搬回内存，然后告诉系统这个交换空间不再使用。

```
🎯 swapoff主要作用：
✅ 禁用指定的交换空间
✅ 将交换空间中的数据移回内存
✅ 释放交换空间占用的资源
✅ 为交换空间维护做准备
```

### 4.2 禁用交换空间操作


**⏸️ 基本禁用命令**：
```bash
# 禁用特定交换分区
sudo swapoff /dev/sdb1

# 禁用交换文件
sudo swapoff /path/to/swapfile

# 使用标签禁用
sudo swapoff LABEL=myswap

# 禁用所有交换空间
sudo swapoff -a
```

**⚠️ 禁用注意事项**：
```
安全考虑：
🔴 禁用前确保有足够的物理内存
🔴 系统会尝试将交换数据移回内存
🔴 如果内存不足，操作可能失败或导致系统卡顿
🔴 建议在系统负载较低时执行

检查步骤：
1. free -h        # 查看当前内存使用
2. swapon --show  # 查看交换空间使用情况
3. 确保 可用内存 > 已使用交换空间
4. sudo swapoff   # 执行禁用操作
```

### 4.3 交换空间维护场景


**🔧 常见维护操作**：
```bash
# 场景1：调整交换文件大小
sudo swapoff /swapfile          # 先禁用
sudo rm /swapfile               # 删除旧文件
sudo fallocate -l 4G /swapfile  # 创建新的更大文件
sudo chmod 600 /swapfile        # 设置权限
sudo mkswap /swapfile           # 格式化
sudo swapon /swapfile           # 重新启用

# 场景2：更换交换分区
sudo swapoff /dev/sdb1          # 禁用旧分区
# 重新分区或使用新设备
sudo mkswap /dev/sdc1           # 格式化新分区
sudo swapon /dev/sdc1           # 启用新分区

# 场景3：临时禁用进行系统检查
sudo swapoff -a                 # 禁用所有交换
# 进行内存测试或系统检查
sudo swapon -a                  # 重新启用所有交换
```

---

## 5. 📁 交换文件创建方法


### 5.1 fallocate创建交换文件


**fallocate是什么？**
fallocate就像"预定空间"的工具，可以快速创建指定大小的文件，比传统的dd命令快很多。

```
🚀 fallocate优势：
✅ 创建速度极快（几乎瞬间完成）
✅ 不实际写入数据，只分配空间
✅ 支持各种大小单位（K、M、G、T）
✅ 现代文件系统的首选方法
```

**📝 fallocate创建交换文件**：
```bash
# 创建2GB交换文件
sudo fallocate -l 2G /swapfile

# 创建4GB交换文件
sudo fallocate -l 4096M /swapfile

# 设置正确的权限（重要！）
sudo chmod 600 /swapfile

# 验证文件大小
ls -lh /swapfile

# 完整的创建流程
sudo fallocate -l 2G /swapfile       # 分配空间
sudo chmod 600 /swapfile             # 设置权限
sudo mkswap /swapfile                # 格式化
sudo swapon /swapfile                # 启用
```

**🔒 权限设置的重要性**：
```
为什么需要600权限？
🔐 交换文件可能包含敏感的内存数据
🔐 防止其他用户读取内存快照信息
🔐 600权限：仅文件所有者可读写

错误权限的风险：
❌ 644权限：其他用户可以读取交换文件
❌ 可能泄露密码、私钥等敏感信息
❌ 系统安全漏洞
```

### 5.2 dd命令创建交换文件


**dd命令特点**：
dd是传统的文件创建方法，虽然较慢，但在某些情况下更可靠。

```bash
# 创建2GB交换文件（传统方法）
sudo dd if=/dev/zero of=/swapfile bs=1M count=2048

# 创建1GB交换文件（更快的块大小）
sudo dd if=/dev/zero of=/swapfile bs=1G count=1

# 显示进度（较新的dd版本）
sudo dd if=/dev/zero of=/swapfile bs=1M count=2048 status=progress

# 设置权限并格式化
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

**⚖️ fallocate vs dd 对比**：

| 特性 | **fallocate** | **dd** |
|------|--------------|--------|
| **速度** | `极快（秒级）` | `较慢（分钟级）` |
| **原理** | `分配空间不写入` | `实际写入数据` |
| **文件系统要求** | `现代文件系统` | `所有文件系统` |
| **磁盘IO** | `很少` | `大量写入IO` |
| **兼容性** | `ext4、xfs等` | `通用兼容` |

**🎯 选择建议**：
```
推荐使用fallocate的情况：
✅ 现代Linux系统（ext4、xfs、btrfs文件系统）
✅ 需要快速创建大型交换文件
✅ 系统IO负载敏感

推荐使用dd的情况：
✅ 老旧文件系统（ext3等）
✅ 需要确保文件实际占用磁盘空间
✅ 嵌入式系统或特殊环境
```

---

## 6. 📊 监控交换空间状态


### 6.1 free命令查看内存和交换


**free命令详解**：
free是查看系统内存和交换空间使用情况的首选工具，就像查看银行账户余额一样简单直观。

```bash
# 以人类友好格式显示
free -h

# 输出示例：
#               total        used        free      shared  buff/cache   available
# Mem:           7.8G        2.1G        3.2G        145M        2.5G        5.3G
# Swap:          2.0G          0B        2.0G

# 每秒更新一次（实时监控）
free -h -s 1

# 显示详细统计信息
free -h --wide
```

**📋 free输出解读**：
```
内存(Mem)行含义：
total：总物理内存大小
used：已使用内存（不包括缓冲区）
free：完全未使用的内存
shared：共享内存大小
buff/cache：缓冲区和缓存使用的内存
available：应用程序实际可用内存

交换(Swap)行含义：
total：交换空间总大小
used：已使用的交换空间
free：可用的交换空间

关键理解：
💡 available比free更重要：实际可用于新程序的内存
💡 buff/cache可以被释放：不是真正"占用"的内存
💡 swap used=0：理想状态，说明内存充足
```

### 6.2 /proc/swaps文件分析


**/proc/swaps详细信息**：
/proc/swaps就像系统的"交换空间账本"，记录着所有活动交换空间的详细信息。

```bash
# 查看活动交换空间详情
cat /proc/swaps

# 输出示例：
# Filename                Type        Size    Used    Priority
# /dev/sdb1              partition    2097148    0       10
# /swapfile              file         1048572    4096    5

# 结合排序查看优先级
sort -k5 -nr /proc/swaps  # 按优先级降序排列
```

**📈 监控脚本示例**：
```bash
#!/bin/bash
# 交换空间监控脚本

echo "=== 交换空间状态监控 ==="
echo "时间: $(date)"
echo

# 显示总体内存情况
echo "📊 内存使用概况:"
free -h

echo
echo "📁 活动交换空间详情:"
if [ -s /proc/swaps ]; then
    cat /proc/swaps
else
    echo "当前没有活动的交换空间"
fi

echo
echo "⚠️  交换使用警告:"
swap_used=$(free | awk '/Swap:/ {print $3}')
if [ "$swap_used" -gt 0 ]; then
    echo "🔴 检测到交换空间正在使用，建议检查内存使用情况"
    echo "💡 可能需要增加物理内存或优化程序内存使用"
else
    echo "✅ 交换空间未使用，内存状态良好"
fi
```

### 6.3 实时监控工具


**🔍 htop中的交换监控**：
```bash
# 安装htop（如果未安装）
sudo apt install htop    # Ubuntu/Debian
sudo dnf install htop    # CentOS/Fedora

# 运行htop查看实时状态
htop

# htop中交换相关信息：
# 顶部显示：Swp: 0K/2.0G  (交换使用情况)
# 进程列表：VIRT、RES、SHR列显示进程内存使用
```

**⌚ 系统监控最佳实践**：
```
监控指标建议：
🎯 交换使用率 < 10%：健康状态
🟡 交换使用率 10-50%：需要关注
🔴 交换使用率 > 50%：需要立即优化

定期检查项目：
✅ 每日检查：free -h 查看交换使用
✅ 每周检查：分析交换使用趋势
✅ 异常情况：立即调查高交换使用的进程
✅ 性能优化：考虑增加内存或优化应用
```

---

## 7. ⚙️ 交换空间实践配置


### 7.1 永久交换空间配置


**/etc/fstab配置详解**：
要让交换空间在系统重启后自动启用，需要在/etc/fstab文件中添加配置，就像给系统写一个"开机备忘录"。

```bash
# 查看当前fstab配置
cat /etc/fstab

# 添加交换分区到fstab
echo '/dev/sdb1 none swap sw 0 0' | sudo tee -a /etc/fstab

# 添加交换文件到fstab  
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# 使用UUID更安全（推荐）
# 先获取UUID
sudo blkid /dev/sdb1
# 然后添加到fstab
echo 'UUID=a1b2c3d4-e5f6-7890-abcd-ef1234567890 none swap sw 0 0' | sudo tee -a /etc/fstab
```

**📋 fstab条目解析**：
```
fstab条目格式：
设备 挂载点 文件系统类型 选项 转储 检查

交换空间示例：
/dev/sdb1  none  swap  sw  0  0
    ↓       ↓     ↓    ↓   ↓  ↓
   设备   挂载点  类型 选项 转储 检查

字段详解：
• 设备：可以是设备路径、UUID或LABEL
• 挂载点：交换空间使用none
• 文件系统类型：必须是swap
• 选项：sw（swap），还可以加pri=优先级
• 转储：0（不转储）
• 检查：0（不检查）
```

### 7.2 交换优先级配置


**🎚️ 在fstab中设置优先级**：
```bash
# 高优先级SSD交换分区
/dev/sda2 none swap sw,pri=10 0 0

# 中等优先级HDD交换分区  
/dev/sdb1 none swap sw,pri=5 0 0

# 低优先级交换文件
/swapfile none swap sw,pri=1 0 0

# 验证配置
sudo mount -a    # 测试所有挂载点
sudo swapon -a   # 启用所有交换空间
swapon --show    # 检查优先级设置
```

**💡 优先级策略建议**：
```
存储类型优先级：
🥇 NVMe SSD：   优先级 15-20
🥈 SATA SSD：   优先级 10-15  
🥉 HDD 7200转： 优先级 5-10
🏃 HDD 5400转： 优先级 1-5
📦 网络存储：   优先级 0或负值

容量规划建议：
• 物理内存 ≤ 2GB：  交换空间 = 2×内存
• 物理内存 2-8GB：  交换空间 = 内存大小
• 物理内存 > 8GB：  交换空间 = 0.5×内存（最少4GB）
• 服务器环境：      根据实际负载调整
```

### 7.3 完整配置实例


**🛠️ 生产环境交换配置案例**：
```bash
# 场景：8GB内存的Web服务器，配置4GB交换空间

# 1. 创建交换文件
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap -L webserver-swap /swapfile

# 2. 临时启用测试
sudo swapon /swapfile
free -h  # 验证交换空间已启用

# 3. 添加到fstab实现永久配置
echo 'LABEL=webserver-swap none swap sw,pri=5 0 0' | sudo tee -a /etc/fstab

# 4. 验证配置
sudo swapoff /swapfile    # 禁用测试
sudo swapon -a            # 从fstab启用
swapon --show            # 确认配置正确

# 5. 系统参数优化（可选）
echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf  # 降低交换倾向
sudo sysctl -p           # 应用配置
```

**📋 配置检查清单**：
```
部署前检查：
☑️ 交换空间大小合理（不超过物理内存2倍）
☑️ 文件权限正确（600）
☑️ fstab语法正确
☑️ UUID或LABEL引用有效
☑️ 优先级设置合理

部署后验证：  
☑️ 重启系统测试自动启用
☑️ free -h确认交换空间可用
☑️ swapon --show检查优先级
☑️ 系统日志无错误信息
☑️ 性能测试验证影响
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基本概念


```
🔸 交换空间本质：虚拟内存系统的硬盘部分，内存不足时的缓冲区
🔸 mkswap作用：格式化分区或文件为交换空间格式
🔸 swapon功能：启用交换空间，让系统开始使用
🔸 swapoff功能：禁用交换空间，将数据移回内存
🔸 交换文件vs分区：文件灵活易调整，分区性能稍好
🔸 优先级机制：数值越高优先使用，合理配置提升性能
🔸 监控重要性：交换使用率反映系统内存压力状态
```

### 8.2 关键理解要点


**🔹 交换空间的工作机制**：
```
内存管理策略：
• 系统优先使用物理内存（速度快）
• 内存不足时将不活跃页面换出到swap
• 需要时再将数据从swap换入内存
• 频繁换入换出会影响系统性能

性能影响：
• 交换到SSD：性能影响相对较小
• 交换到HDD：明显的性能下降
• 过度使用交换：系统响应变慢
• 合理使用：提供内存缓冲，防止OOM
```

**🔹 交换空间大小规划**：
```
传统经验法则：
• 内存小于2GB：swap = 2×内存
• 内存2-8GB：swap = 内存大小
• 内存大于8GB：swap = 内存的1/2

现代考虑因素：
• 桌面系统：重视休眠功能，swap ≥ 内存
• 服务器系统：重视性能，swap适中即可
• 云主机：按实际负载需求配置
• 容器环境：通常不配置交换空间
```

**🔹 安全和权限考虑**：
```
安全要点：
• 交换文件权限必须是600
• 避免在网络文件系统上创建交换文件
• 敏感数据可能被写入交换空间
• 考虑加密交换空间（高安全需求）

最佳实践：
• 使用UUID或LABEL引用，避免设备路径变化
• 设置合理的优先级，优先使用快速存储
• 定期监控交换使用情况
• 根据实际需求调整swappiness参数
```

### 8.3 实际应用指导


**💼 不同场景的配置策略**：
```
桌面用户：
• 配置交换文件，便于调整大小
• 启用休眠功能，交换空间 ≥ 内存大小
• 使用SSD时适当减小交换空间

Web服务器：
• 配置适量交换空间防止OOM
• 监控交换使用，及时优化应用
• 设置告警，交换使用率过高时通知

数据库服务器：
• 谨慎使用交换空间，可能影响性能
• 优先增加物理内存
• 如需配置，使用高性能存储

开发环境：
• 灵活配置交换文件
• 根据开发需求动态调整
• 使用容器时通常不配置交换
```

**🛠️ 运维最佳实践**：
```
监控和维护：
• 日常监控：free -h查看交换使用
• 性能监控：关注交换活动频率  
• 容量规划：根据使用趋势调整大小
• 定期检查：验证交换空间配置正确

故障处理：
• 交换空间满：检查内存泄漏程序
• 系统变慢：查看交换使用情况
• 启动失败：检查fstab配置语法
• 权限错误：确认交换文件权限600
```

### 8.4 命令速查手册


**🚀 常用命令组合**：
```bash
# 快速创建并启用2GB交换文件
sudo fallocate -l 2G /swapfile && sudo chmod 600 /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile

# 查看当前内存和交换状态
free -h && echo "---" && swapon --show

# 安全禁用所有交换空间
sudo swapoff -a

# 重新启用所有配置的交换空间
sudo swapon -a

# 检查交换空间配置
cat /etc/fstab | grep swap

# 监控交换使用（每5秒更新）
watch -n 5 'free -h && echo "---" && cat /proc/swaps'
```

**🧠 记忆要点**：
- mkswap格式化，swapon启用，swapoff禁用
- 交换文件权限600，安全第一不能忘
- fallocate创建快，dd命令更兼容  
- 优先级数字高先用，fstab配置永久生效
- free命令看状态，/proc/swaps查详情

**核心理念**：交换空间是内存的有益补充，不是性能的万能药。合理配置可以提升系统稳定性，过度依赖会影响系统性能。关键在于找到内存需求与性能要求的平衡点。