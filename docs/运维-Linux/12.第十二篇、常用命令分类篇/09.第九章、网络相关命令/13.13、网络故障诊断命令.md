---
title: 13、网络故障诊断命令
---
## 📚 目录

1. [网络诊断基础概念](#1-网络诊断基础概念)
2. [ping - 网络连通性诊断](#2-ping-网络连通性诊断)
3. [traceroute - 网络路径诊断](#3-traceroute-网络路径诊断)
4. [netstat - 连接状态诊断](#4-netstat-连接状态诊断)
5. [ss - 现代网络套接字诊断](#5-ss-现代网络套接字诊断)
6. [tcpdump - 网络包分析](#6-tcpdump-网络包分析)
7. [网络配置问题排查](#7-网络配置问题排查)
8. [DNS解析故障诊断](#8-DNS解析故障诊断)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🌐 网络诊断基础概念


### 1.1 什么是网络故障诊断


**🔸 网络诊断的本质**
网络故障诊断就像是给网络"看病"，当你的网络出现问题时（比如网页打不开、文件传不了），我们需要用专门的工具来找出问题出在哪里。

```
网络问题常见症状：
✗ 网页无法打开
✗ 文件传输速度慢
✗ 视频卡顿严重
✗ SSH连接超时
✗ 服务器无响应

就像看病需要体温计、听诊器一样，
网络诊断也有专门的"检查工具"
```

**💡 网络诊断的思路**
网络诊断遵循"从近到远、从下到上"的原则：

```
诊断层次图：
应用层问题 ← HTTP、DNS、邮件等
    ↑
传输层问题 ← TCP、UDP端口问题  
    ↑
网络层问题 ← IP路由、防火墙
    ↑
链路层问题 ← 网卡、交换机、网线
    ↑
物理层问题 ← 硬件故障、信号问题
```

### 1.2 网络诊断工具分类


**🔧 按功能分类**

| 工具类型 | **主要作用** | **代表命令** | **解决问题** |
|---------|------------|-------------|-------------|
| 🔍 **连通性测试** | 检查两点间是否能通信 | `ping` | 网络是否连通 |
| 🗺️ **路径追踪** | 查看数据传输路径 | `traceroute` | 哪一跳出问题 |
| 📊 **连接状态** | 查看网络连接情况 | `netstat/ss` | 端口是否开放 |
| 📡 **数据包分析** | 分析网络数据包 | `tcpdump` | 具体传输内容 |
| 🌍 **域名解析** | 检查DNS解析 | `nslookup/dig` | 域名解析问题 |

---

## 2. 🏓 ping - 网络连通性诊断


### 2.1 ping命令基础概念


**🔸 ping是什么**
`ping`就像是网络中的"敲门"命令，你向目标主机发送一个小数据包问"你在吗？"，如果对方在线并且网络通畅，就会回复"我在！"

> 💡 **名字来源**：ping来自声纳的"ping"声，就像潜艇发声探测一样

**⚙️ ping的工作原理**
```
ping工作流程：
你的电脑 ──发送ICMP回显请求──→ 目标主机
         ←──收到ICMP回显应答──── 

类似于：
你："喂，你听得到吗？"（ICMP请求）
对方："听得到！"（ICMP回复）
```

### 2.2 ping命令基本用法


**🎯 最简单的用法**
```bash
# 测试能否连接到百度
ping baidu.com

# 测试本地网络（回环地址）
ping 127.0.0.1

# 测试局域网内其他设备
ping 192.168.1.1
```

**📊 理解ping的输出结果**
```bash
$ ping baidu.com
PING baidu.com (110.242.68.66) 56(84) bytes of data.
64 bytes from 110.242.68.66: icmp_seq=1 ttl=49 time=25.2 ms
64 bytes from 110.242.68.66: icmp_seq=1 ttl=49 time=24.8 ms
^C
--- baidu.com ping statistics ---
2 packets transmitted, 2 received, 0% packet loss
round-trip min/avg/max/mdev = 24.8/25.0/25.2/0.2 ms
```

**🔍 输出解读说明**：

| 字段 | **含义** | **说明** |
|------|---------|---------|
| `64 bytes` | 数据包大小 | 发送的数据包大小 |
| `icmp_seq=1` | 序列号 | 第几个数据包 |
| `ttl=49` | 生存时间 | 数据包还能经过多少跳 |
| `time=25.2 ms` | 往返时间 | 数据包来回用时 |
| `0% packet loss` | 丢包率 | 丢失的数据包比例 |

### 2.3 ping命令实用参数


**⏰ 控制ping的次数和间隔**
```bash
# 只ping 3次就停止
ping -c 3 baidu.com

# 每2秒ping一次
ping -i 2 baidu.com

# 设置超时时间为5秒
ping -W 5 baidu.com
```

**📏 调整数据包大小**
```bash
# 发送大数据包测试MTU
ping -s 1400 baidu.com    # 1400字节数据

# 测试网络承载能力
ping -s 65000 baidu.com   # 最大数据包
```

> ⚠️ **注意**：有些网络设备会限制或丢弃大数据包，这是正常的安全策略

### 2.4 ping诊断常见网络问题


**🔸 问题1：完全无法ping通**
```bash
$ ping 192.168.1.100
ping: connect: Network is unreachable
```

**可能原因**：
- 🔌 网线没插好或网卡故障
- 🌐 IP地址配置错误
- 🚫 防火墙阻止了ICMP
- 📡 路由配置问题

**🔸 问题2：ping有时通有时不通**
```bash
$ ping baidu.com
64 bytes from baidu.com: time=20.1 ms
Request timeout for icmp_seq 2
64 bytes from baidu.com: time=25.3 ms
Request timeout for icmp_seq 4
```

**可能原因**：
- 📶 网络信号不稳定
- 🔄 网络负载过高
- ⚡ 设备性能问题
- 🌊 网络拥塞

**🔸 问题3：ping延迟很高**
```bash
$ ping baidu.com
64 bytes from baidu.com: time=500.2 ms    # 延迟过高
```

**可能原因**：
- 🌍 物理距离太远
- 🔄 网络负载重
- 📡 设备处理能力不足
- 🛣️ 路由路径不佳

---

## 3. 🗺️ traceroute - 网络路径诊断


### 3.1 traceroute基础概念


**🔸 traceroute是什么**
`traceroute`就像是网络世界的"导航记录仪"，它能告诉你数据包从你的电脑到目标服务器经过了哪些"路口"（路由器），每一跳用了多长时间。

```
数据传输路径示意：
你的电脑 → 家用路由器 → ISP网关 → 骨干网 → 目标服务器
   0跳      1跳        2跳      3跳      4跳

traceroute就是记录这个完整路径
```

**⚙️ traceroute工作原理**
```
工作机制（TTL递增法）：
第1次：发送TTL=1的包 → 第1跳路由器收到后TTL变0 → 返回"超时"消息
第2次：发送TTL=2的包 → 第2跳路由器收到后TTL变0 → 返回"超时"消息
...
直到到达目标主机
```

### 3.2 traceroute基本用法


**🎯 基础使用**
```bash
# Linux系统使用traceroute
traceroute baidu.com

# 有些系统可能需要安装
sudo apt install traceroute    # Ubuntu/Debian
sudo yum install traceroute    # CentOS/RHEL
```

**📊 理解traceroute输出**
```bash
$ traceroute baidu.com
traceroute to baidu.com (110.242.68.66), 30 hops max, 60 byte packets
 1  192.168.1.1 (192.168.1.1)  1.245 ms  1.123 ms  1.089 ms
 2  10.0.0.1 (10.0.0.1)  15.234 ms  14.567 ms  16.123 ms
 3  * * *
 4  61.135.169.125  25.234 ms  24.567 ms  26.123 ms
 5  110.242.68.66 (110.242.68.66)  30.123 ms  29.456 ms  31.234 ms
```

**🔍 输出解读**：

| 字段 | **含义** | **说明** |
|------|---------|---------|
| `1, 2, 3...` | 跳数 | 第几个路由节点 |
| `192.168.1.1` | IP地址 | 该跳的路由器IP |
| `1.245 ms` | 延迟时间 | 到达该跳的用时 |
| `* * *` | 超时 | 该路由器不响应 |

### 3.3 traceroute实用参数


**🔧 常用参数选项**
```bash
# 使用ICMP协议代替UDP
traceroute -I baidu.com

# 指定最大跳数
traceroute -m 15 baidu.com

# 设置每跳的探测次数
traceroute -q 1 baidu.com      # 每跳只探测1次

# 指定源IP地址
traceroute -s 192.168.1.100 baidu.com
```

### 3.4 traceroute诊断网络问题


**🔸 问题诊断场景1：找出网络瓶颈**
```bash
$ traceroute slow-website.com
 1  192.168.1.1     2 ms    2 ms    2 ms     # 正常
 2  10.0.0.1       15 ms   14 ms   16 ms    # 正常  
 3  61.135.1.1     25 ms   24 ms   26 ms    # 正常
 4  * * *                                   # 这一跳有问题
 5  202.106.1.1   500 ms  480 ms  520 ms   # 延迟突然变高
```

> 💡 **分析**：第4跳出现超时，第5跳延迟暴增，问题很可能出在第4跳的网络设备上

**🔸 问题诊断场景2：路由路径异常**
```bash
# 国内网站却绕道海外
$ traceroute domestic-site.com
 1  192.168.1.1      2 ms
 2  local-isp.com   15 ms    # 本地ISP
 3  overseas.net   200 ms    # 突然跳到海外！
 4  foreign-route  250 ms
 5  back-to-china  300 ms    # 又绕回国内
```

> ⚠️ **问题**：数据包本该在国内传输，却绕道海外，导致延迟增加

**🔸 问题诊断场景3：网络中断点定位**
```bash
$ traceroute unreachable-server.com
 1  192.168.1.1     2 ms    2 ms    2 ms
 2  10.0.0.1       15 ms   14 ms   16 ms
 3  * * *                              # 从这里开始就没响应了
 4  * * *
 5  * * *
```

> 🎯 **分析**：问题出现在第3跳，很可能是该路由器故障或网络中断

---

## 4. 📊 netstat - 连接状态诊断


### 4.1 netstat基础概念


**🔸 netstat是什么**
`netstat`就像是网络连接的"体检报告"，它能告诉你当前系统所有的网络连接情况：哪些端口在监听、哪些连接是活跃的、网络流量统计等。

```
netstat的"透视能力"：
🔍 查看所有网络连接
🔍 检查端口是否被占用
🔍 监控网络服务状态
🔍 统计网络流量信息
🔍 排查网络服务问题
```

**📋 网络连接状态说明**

| 状态 | **含义** | **通俗解释** |
|------|---------|-------------|
| `LISTEN` | 监听状态 | 服务端等待客户端连接 |
| `ESTABLISHED` | 已连接 | 双方正在通信中 |
| `TIME_WAIT` | 等待关闭 | 连接关闭中，等待最后确认 |
| `CLOSE_WAIT` | 等待关闭 | 等待应用程序关闭连接 |
| `FIN_WAIT1` | 结束等待1 | 主动关闭，等待对方确认 |
| `FIN_WAIT2` | 结束等待2 | 主动关闭，等待对方关闭 |

### 4.2 netstat基本用法


**🎯 查看所有网络连接**
```bash
# 显示所有连接（TCP和UDP）
netstat -a

# 只显示TCP连接
netstat -t

# 只显示UDP连接  
netstat -u

# 显示监听端口
netstat -l
```

**📊 实用组合参数**
```bash
# 最常用：显示所有TCP连接，包括端口号
netstat -an

# 显示连接对应的进程
netstat -anp

# 只看监听的TCP端口
netstat -tlp

# 查看网络统计信息
netstat -s
```

### 4.3 netstat实际应用场景


**🔸 场景1：检查服务是否正常启动**
```bash
# 检查Web服务器是否在80端口监听
$ netstat -tlp | grep :80
tcp  0  0  0.0.0.0:80  0.0.0.0:*  LISTEN  1234/nginx

# 检查数据库服务
$ netstat -tlp | grep :3306
tcp  0  0  127.0.0.1:3306  0.0.0.0:*  LISTEN  5678/mysql
```

> 💡 **解读**：如果看到`LISTEN`状态，说明服务正常启动并等待连接

**🔸 场景2：查看谁在连接我的服务器**
```bash
$ netstat -an | grep :22    # 查看SSH连接
tcp  0  0  0.0.0.0:22       0.0.0.0:*      LISTEN
tcp  0  0  192.168.1.10:22  192.168.1.5:54321  ESTABLISHED
tcp  0  0  192.168.1.10:22  203.45.67.89:12345  ESTABLISHED
```

> 🔍 **分析**：有两个客户端正在SSH连接到服务器

**🔸 场景3：排查端口占用问题**
```bash
# 查看8080端口被哪个进程占用
$ netstat -tlp | grep :8080
tcp  0  0  :::8080  :::*  LISTEN  9527/java

# 或者使用更精确的查找
$ netstat -anp | grep :8080
tcp6  0  0  :::8080  :::*  LISTEN  9527/java
```

> ⚠️ **问题解决**：如果端口被占用，可以用`kill 9527`结束进程

**🔸 场景4：监控网络连接数**
```bash
# 统计不同状态的连接数
$ netstat -an | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'
ESTABLISHED 45
LISTEN 12
TIME_WAIT 23
CLOSE_WAIT 5
```

### 4.4 netstat网络故障排查


**🔧 常见问题诊断流程**

```
网络服务问题排查步骤：
1️⃣ 服务是否启动？ → netstat -tlp | grep :端口
2️⃣ 端口是否监听？ → 查看LISTEN状态
3️⃣ 防火墙是否阻挡？ → 从外部telnet测试
4️⃣ 连接是否建立？ → 查看ESTABLISHED状态
5️⃣ 连接是否异常？ → 检查异常状态连接数
```

---

## 5. ⚡ ss - 现代网络套接字诊断


### 5.1 ss命令基础概念


**🔸 ss是什么**
`ss`是Socket Statistics的缩写，是`netstat`的现代化替代品。如果说`netstat`是老式的"听诊器"，那么`ss`就是现代的"彩超设备"，功能更强大，速度更快。

> 💡 **为什么要用ss**：`ss`直接从内核获取信息，比`netstat`快得多，特别是在连接数很多的服务器上

**🚀 ss vs netstat 对比**

| 特性 | **netstat** | **ss** |
|------|------------|--------|
| 🏃 **速度** | 较慢，遍历/proc目录 | 很快，直接读内核 |
| 📊 **信息详细度** | 基础信息 | 更详细的套接字信息 |
| 🔍 **过滤功能** | 基础过滤 | 强大的过滤表达式 |
| 💾 **内存占用** | 较高 | 较低 |
| 📈 **发展趋势** | 逐渐被替代 | 现代Linux的标准工具 |

### 5.2 ss基本用法


**🎯 基础命令对比**
```bash
# netstat风格的基本用法
ss -a          # 显示所有套接字 (对应 netstat -a)
ss -t          # 显示TCP套接字 (对应 netstat -t)  
ss -u          # 显示UDP套接字 (对应 netstat -u)
ss -l          # 显示监听套接字 (对应 netstat -l)
ss -p          # 显示进程信息 (对应 netstat -p)
```

**📊 实用组合参数**
```bash
# 最常用组合
ss -tulp       # 显示TCP和UDP的监听端口及进程
ss -anp        # 显示所有套接字的数字形式

# 查看网络统计
ss -s          # 显示套接字统计摘要
```

### 5.3 ss的强大过滤功能


**🔍 按状态过滤**
```bash
# 只看已建立的连接
ss -t state established

# 只看监听状态的端口
ss -t state listening

# 查看正在关闭的连接
ss -t state time-wait
```

**🎯 按端口过滤**
```bash
# 查看80端口的连接
ss -t sport :80        # 源端口是80
ss -t dport :80        # 目标端口是80

# 查看端口范围
ss -t sport :1000-2000

# 查看特定端口的所有连接
ss -t '( sport :22 or dport :22 )'
```

**🌐 按IP地址过滤**
```bash
# 查看特定IP的连接
ss -t dst 192.168.1.100

# 查看本地IP的连接
ss -t src 192.168.1.10

# 查看网段连接
ss -t dst 192.168.1.0/24
```

### 5.4 ss实际应用场景


**🔸 场景1：快速检查服务状态**
```bash
# 检查Web服务器状态（比netstat快很多）
$ ss -tlp sport :80
State    Recv-Q Send-Q Local Address:Port Peer Address:Port Process
LISTEN   0      511    0.0.0.0:80         0.0.0.0:*     users:(("nginx",pid=1234,fd=6))
```

**🔸 场景2：监控高并发连接**
```bash
# 查看连接到80端口的客户端数量
$ ss -t dst :80 | wc -l
156

# 统计各种状态的连接数
$ ss -t -a | awk '{print $1}' | sort | uniq -c
    1 CLOSE-WAIT
   45 ESTAB
   12 LISTEN
   23 TIME-WAIT
```

**🔸 场景3：排查网络性能问题**
```bash
# 查看有大量数据等待发送的连接
$ ss -t -a | awk '$2>0 {print $0}' 
State    Recv-Q Send-Q Local Address:Port Peer Address:Port
ESTAB    0      8192   192.168.1.10:80   192.168.1.20:54321

# Send-Q>0 表示发送缓冲区有数据积压，可能网络拥塞
```

> ⚠️ **性能警告**：如果Send-Q持续很高，说明网络发送出现瓶颈

**🔸 场景4：安全监控**
```bash
# 查看来自外网的SSH连接
$ ss -t dport :22 | grep -v 192.168
ESTAB  0  0  10.0.0.5:22    203.45.67.89:12345

# 监控可疑的大量连接
$ ss -t dst :80 | awk '{print $4}' | cut -d: -f1 | sort | uniq -c | sort -nr
     25 192.168.1.20
     15 192.168.1.21  
      8 203.45.67.100    # 这个外网IP连接数异常
```

---

## 6. 📡 tcpdump - 网络包分析


### 6.1 tcpdump基础概念


**🔸 tcpdump是什么**
`tcpdump`就像是网络世界的"窃听器"，它能够截获并分析网络中传输的数据包。想象成在网络这条"高速公路"上设置一个"监控摄像头"，记录每辆"车"（数据包）的详细信息。

```
tcpdump的能力：
🕵️ 捕获网络接口上的所有数据包
🔍 分析数据包的内容和头部信息  
📊 统计网络流量和协议分布
🐛 调试网络通信问题
🔒 安全分析和入侵检测
```

> ⚠️ **权限要求**：tcpdump需要root权限或者用户在pcap组中

### 6.2 tcpdump基本用法


**🎯 最简单的抓包**
```bash
# 抓取所有网络接口的数据包
sudo tcpdump

# 抓取指定接口的数据包  
sudo tcpdump -i eth0

# 抓取并保存到文件
sudo tcpdump -w capture.pcap

# 读取抓包文件
tcpdump -r capture.pcap
```

**📊 常用参数组合**
```bash
# 详细显示，不解析主机名，显示绝对序列号
sudo tcpdump -v -n -S

# 抓取100个包后停止
sudo tcpdump -c 100

# 显示数据包内容（十六进制）
sudo tcpdump -x

# 显示更详细的数据包内容
sudo tcpdump -X    # 十六进制+ASCII
```

### 6.3 tcpdump过滤表达式


**🔍 按协议过滤**
```bash
# 只抓TCP包
sudo tcpdump tcp

# 只抓UDP包  
sudo tcpdump udp

# 只抓ICMP包（ping使用的协议）
sudo tcpdump icmp
```

**🎯 按端口过滤**
```bash
# 抓取80端口的流量
sudo tcpdump port 80

# 抓取SSH流量
sudo tcpdump port 22

# 抓取端口范围
sudo tcpdump portrange 8000-8080
```

**🌐 按IP地址过滤**
```bash
# 抓取特定主机的流量
sudo tcpdump host 192.168.1.100

# 抓取源IP的流量
sudo tcpdump src 192.168.1.100

# 抓取目标IP的流量
sudo tcpdump dst 192.168.1.100

# 抓取网段流量
sudo tcpdump net 192.168.1.0/24
```

**🔧 复杂过滤组合**
```bash
# 抓取80端口且来自特定IP的流量
sudo tcpdump port 80 and src 192.168.1.100

# 抓取SSH或HTTP流量
sudo tcpdump 'port 22 or port 80'

# 排除SSH流量
sudo tcpdump 'not port 22'
```

### 6.4 tcpdump实际应用场景


**🔸 场景1：诊断网络连通性问题**
```bash
# 用ping测试时同时抓包分析
# 终端1：
sudo tcpdump -i eth0 icmp

# 终端2：
ping 8.8.8.8

# 如果只看到请求没有回复，说明：
# 1. 出去的包没问题，回来的包有问题
# 2. 可能是防火墙、路由等问题
```

**🔸 场景2：Web服务器问题诊断**
```bash
# 抓取HTTP流量查看请求响应
sudo tcpdump -A port 80

# 抓包输出示例：
# 12:34:56.123456 IP client.12345 > server.80: Flags [P.], seq 1:100
# GET /index.html HTTP/1.1
# Host: www.example.com
# ...
```

> 💡 **分析要点**：
> - 看到`GET`请求说明客户端请求正常发送
> - 看到`HTTP/1.1 200 OK`说明服务器正常响应
> - 如果只有请求没有响应，说明服务器有问题

**🔸 场景3：数据库连接问题排查**
```bash
# 监控MySQL连接
sudo tcpdump -i eth0 port 3306

# 如果看到大量的连接建立和断开：
# 12:34:56.123 IP client.54321 > server.3306: Flags [S]      # 连接请求
# 12:34:56.124 IP server.3306 > client.54321: Flags [S.]     # 服务器确认  
# 12:34:56.125 IP client.54321 > server.3306: Flags [.]      # 连接建立
# ...
# 12:34:57.000 IP client.54321 > server.3306: Flags [F.]     # 连接关闭

# 频繁的连接建立关闭可能说明连接池配置不当
```

**🔸 场景4：网络性能分析**
```bash
# 分析网络延迟（结合ping使用）
sudo tcpdump -i eth0 -ttt icmp

# 输出显示时间间隔：
# 00:00:00.000000 IP client > server: ICMP echo request
# 00:00:00.025123 IP server > client: ICMP echo reply    # 25ms延迟
# 00:00:01.000000 IP client > server: ICMP echo request  
# 00:00:01.125456 IP server > client: ICMP echo reply    # 125ms延迟
```

### 6.5 tcpdump输出解读技巧


**📋 TCP包格式解读**
```
典型TCP包输出：
12:34:56.123456 IP 192.168.1.10.54321 > 192.168.1.20.80: 
Flags [P.], seq 1:100, ack 1, win 65535, length 99

解读：
- 12:34:56.123456：时间戳
- 192.168.1.10.54321：源IP:端口
- 192.168.1.20.80：目标IP:端口  
- Flags [P.]：P=Push, .=ACK
- seq 1:100：序列号范围
- length 99：数据长度
```

**🏳️ TCP标志位含义**

| 标志 | **含义** | **说明** |
|------|---------|---------|
| `S` | SYN | 建立连接请求 |
| `F` | FIN | 关闭连接请求 |
| `R` | RST | 重置连接 |
| `P` | PUSH | 立即发送数据 |
| `.` | ACK | 确认 |
| `U` | URG | 紧急数据 |

---

## 7. 🔧 网络配置问题排查


### 7.1 网络配置排查思路


**🎯 系统化排查方法**
网络问题排查需要按照网络层次从下往上逐层检查：

```
网络问题排查层次：
                        
应用层 ─┐ HTTP、DNS服务配置
传输层 ─┤ 端口、防火墙设置  
网络层 ─┤ IP地址、路由配置
链路层 ─┤ 网卡配置、交换机
物理层 ─┘ 网线、网卡硬件

排查顺序：先物理，后逻辑；先本地，后远程
```

### 7.2 网卡和IP配置检查


**🔍 检查网络接口状态**
```bash
# 查看所有网络接口
ip addr show
# 或者使用传统命令
ifconfig -a

# 查看特定接口
ip addr show eth0

# 检查接口是否启用
ip link show eth0
```

**📊 理解网络接口输出**
```bash
$ ip addr show eth0
2: eth0: <BROADCAST,MULTICAST,UP,RUNNING> mtu 1500 qdisc pfifo_fast state UP
    link/ether 00:0c:29:12:34:56 brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.100/24 brd 192.168.1.255 scope global eth0
    inet6 fe80::20c:29ff:fe12:3456/64 scope link
```

**🔍 重要信息解读**：
- `UP,RUNNING`：接口已启用且物理连接正常
- `192.168.1.100/24`：IP地址和子网掩码
- `00:0c:29:12:34:56`：MAC地址
- `mtu 1500`：最大传输单元

**🔧 常见网卡问题修复**
```bash
# 启用网络接口
sudo ip link set eth0 up

# 配置IP地址
sudo ip addr add 192.168.1.100/24 dev eth0

# 删除IP地址
sudo ip addr del 192.168.1.100/24 dev eth0

# 重启网络服务
sudo systemctl restart networking    # Debian/Ubuntu
sudo systemctl restart network       # RHEL/CentOS
```

### 7.3 路由配置检查


**🗺️ 查看路由表**
```bash
# 显示路由表
ip route show
# 或者
route -n

# 查看默认网关
ip route show default
```

**📋 路由表输出理解**
```bash
$ ip route show
default via 192.168.1.1 dev eth0               # 默认路由
192.168.1.0/24 dev eth0 proto kernel src 192.168.1.100    # 直连网络
127.0.0.0/8 dev lo                              # 本地回环
```

**🔧 路由问题修复**
```bash
# 添加默认路由
sudo ip route add default via 192.168.1.1

# 添加特定网络路由
sudo ip route add 10.0.0.0/8 via 192.168.1.1

# 删除路由
sudo ip route del 10.0.0.0/8 via 192.168.1.1
```

### 7.4 防火墙配置检查


**🛡️ 检查防火墙状态**
```bash
# Ubuntu/Debian (ufw)
sudo ufw status

# RHEL/CentOS (firewalld)  
sudo firewall-cmd --state
sudo firewall-cmd --list-all

# 传统iptables
sudo iptables -L -n
```

**🔧 防火墙常见问题解决**
```bash
# 临时关闭防火墙（调试用）
sudo ufw disable                    # Ubuntu
sudo systemctl stop firewalld       # CentOS

# 开放特定端口
sudo ufw allow 80                   # Ubuntu
sudo firewall-cmd --add-port=80/tcp --permanent  # CentOS

# 重新加载防火墙规则
sudo firewall-cmd --reload          # CentOS
```

> ⚠️ **安全提醒**：只在调试时临时关闭防火墙，问题解决后立即重新启用

---

## 8. 🌍 DNS解析故障诊断


### 8.1 DNS解析基础概念


**🔸 DNS是什么**
DNS（Domain Name System）就像是互联网的"电话簿"，它把人们容易记住的域名（如baidu.com）翻译成计算机理解的IP地址（如110.242.68.66）。

```
DNS解析过程：
用户输入: www.baidu.com
        ↓
本地DNS缓存 → 本地DNS服务器 → 根域名服务器
        ↓              ↓              ↓
返回IP: 110.242.68.66 ← .com域名服务器 ← baidu.com域名服务器
```

**🔍 DNS解析问题的症状**
- 🌐 能ping通IP但ping不通域名
- 📱 浏览器显示"找不到服务器"
- ⏰ 网页打开速度很慢
- 🔄 时而能访问，时而不能访问

### 8.2 DNS诊断基本工具


**🎯 使用nslookup查询DNS**
```bash
# 基本域名查询
nslookup baidu.com

# 指定DNS服务器查询
nslookup baidu.com 8.8.8.8

# 查询特定记录类型
nslookup -type=MX baidu.com    # 邮件服务器记录
nslookup -type=NS baidu.com    # 域名服务器记录
```

**🔧 使用dig进行高级查询**
```bash
# 基本查询（输出更详细）
dig baidu.com

# 简短输出
dig +short baidu.com

# 查询特定记录类型
dig MX baidu.com               # 邮件服务器
dig NS baidu.com               # 域名服务器
dig AAAA baidu.com             # IPv6地址

# 反向DNS查询
dig -x 8.8.8.8                # 查询IP对应的域名
```

### 8.3 DNS配置文件检查


**📄 检查DNS服务器配置**
```bash
# 查看DNS服务器配置
cat /etc/resolv.conf

# 典型内容：
# nameserver 8.8.8.8
# nameserver 8.8.4.4  
# search localdomain

# 查看hosts文件（本地DNS）
cat /etc/hosts

# 典型内容：
# 127.0.0.1   localhost
# 192.168.1.100   myserver.local
```

**🔧 常见DNS配置问题修复**
```bash
# 临时修改DNS服务器
echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf

# 添加备用DNS
echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf

# 清空DNS缓存
sudo systemctl flush-dns       # Ubuntu 18.04+
sudo /etc/init.d/dns-clean start  # 较旧版本
```

### 8.4 DNS故障诊断实例


**🔸 问题场景1：域名完全无法解析**
```bash
$ ping baidu.com
ping: cannot resolve baidu.com: Unknown host

# 诊断步骤：
# 1. 检查DNS配置
cat /etc/resolv.conf
# 如果为空或配置错误，需要重新配置

# 2. 手工测试DNS
nslookup baidu.com
# 如果超时，说明DNS服务器不可用

# 3. 尝试不同的DNS服务器
nslookup baidu.com 8.8.8.8
# 如果成功，说明当前DNS服务器有问题
```

**🔸 问题场景2：DNS解析很慢**
```bash
# 测试DNS解析时间
$ time nslookup baidu.com
# ...
# real    0m5.123s    # 超过1秒说明DNS响应慢

# 对比不同DNS服务器的响应时间
time dig @8.8.8.8 baidu.com          # Google DNS
time dig @114.114.114.114 baidu.com  # 114 DNS  
time dig @223.5.5.5 baidu.com        # 阿里DNS
```

**🔸 问题场景3：特定网站无法访问**
```bash
# 现象：其他网站正常，特定网站无法访问
$ ping example.com
ping: cannot resolve example.com: Unknown host

# 但是其他网站正常
$ ping baidu.com  
PING baidu.com (110.242.68.66): 56 data bytes
64 bytes from 110.242.68.66: icmp_seq=0 ttl=49 time=25.2 ms

# 诊断：
# 1. 用不同DNS服务器测试
dig @8.8.8.8 example.com
dig @114.114.114.114 example.com

# 2. 检查域名是否存在
whois example.com
```

**🛠️ DNS优化建议**
```bash
# 配置多个DNS服务器提高可靠性
/etc/resolv.conf 内容：
nameserver 223.5.5.5      # 阿里DNS（国内快）
nameserver 8.8.8.8        # Google DNS（稳定）
nameserver 114.114.114.114 # 114DNS（兼容性好）
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 网络诊断思路：从下到上，从近到远，系统化排查
🔸 ping：检查连通性，判断网络是否可达
🔸 traceroute：追踪路径，定位网络瓶颈和故障点
🔸 netstat/ss：查看连接状态，排查端口和服务问题
🔸 tcpdump：数据包分析，深入了解网络通信细节
🔸 DNS诊断：解决域名解析问题，优化访问速度
```

### 9.2 故障诊断流程图


```
网络故障诊断标准流程：

1️⃣ 基础检查
├─ 网线是否连接？
├─ 网卡是否启用？ → ip link show
└─ IP配置是否正确？ → ip addr show

2️⃣ 连通性测试  
├─ 能否ping通本机？ → ping 127.0.0.1
├─ 能否ping通网关？ → ping 网关IP
├─ 能否ping通外网？ → ping 8.8.8.8
└─ 能否ping通域名？ → ping baidu.com

3️⃣ 深入分析
├─ 路径问题 → traceroute 目标主机
├─ 端口问题 → netstat/ss -tlp
├─ 服务问题 → tcpdump 抓包分析
└─ DNS问题 → nslookup/dig 域名查询
```

### 9.3 关键命令速查表


| **故障类型** | **诊断命令** | **关键参数** | **用途说明** |
|-------------|-------------|-------------|-------------|
| 🔍 **连通性** | `ping` | `-c 3` | 测试网络连通性 |
| 🗺️ **路由** | `traceroute` | `-I` | 追踪网络路径 |
| 📊 **连接** | `ss` | `-tlp` | 查看端口监听 |
| 📡 **抓包** | `tcpdump` | `-i eth0 port 80` | 分析数据包 |
| 🌍 **DNS** | `dig` | `+short` | 测试域名解析 |
| ⚙️ **配置** | `ip addr show` | `-` | 查看网络配置 |

### 9.4 实战经验技巧


**🎯 常见问题快速判断**
```
问题现象 → 快速诊断方法

网页打不开：
1. ping IP地址 → 如果通，是DNS问题
2. ping 域名 → 如果不通，是连通性问题
3. telnet IP 端口 → 如果不通，是服务问题

连接慢：
1. ping 查看延迟 → 网络延迟问题
2. traceroute 查看路径 → 路由问题  
3. ss 查看连接数 → 并发连接问题

服务无法访问：
1. ss -tlp 查看监听 → 服务是否启动
2. tcpdump 抓包 → 数据包是否到达
3. 检查防火墙 → 端口是否被阻止
```

**💡 高效诊断技巧**
- **分层诊断**：物理→链路→网络→传输→应用
- **对比法**：正常设备vs问题设备，不同时间段对比
- **排除法**：逐步排除可能的原因
- **日志分析**：结合系统日志进行分析

**🔧 预防和监控**
```bash
# 建立网络监控脚本
#!/bin/bash
# 网络健康检查脚本
echo "检查时间: $(date)"
echo "网卡状态: $(ip link show eth0 | grep state)"
echo "网关连通性: $(ping -c 1 192.168.1.1 >/dev/null && echo "正常" || echo "异常")"
echo "外网连通性: $(ping -c 1 8.8.8.8 >/dev/null && echo "正常" || echo "异常")"
echo "DNS解析: $(dig +short baidu.com | head -1)"
echo "当前连接数: $(ss -t | wc -l)"
```

### 9.5 学习建议和扩展方向


**📚 深入学习路径**
1. **基础扎实**：熟练掌握每个命令的基本用法
2. **组合应用**：学会多个工具配合使用诊断复杂问题  
3. **案例积累**：收集和练习真实的网络故障案例
4. **自动化**：编写脚本自动化常见的诊断流程

**🚀 进阶技能方向**
- **Wireshark图形化抓包分析**
- **网络性能优化和调优**
- **复杂网络环境故障排查**
- **网络安全和入侵检测**
- **SDN和虚拟网络诊断**

**核心记忆口诀**：
- ping通不通先要知，tracert路径细追踪
- netstat端口查状态，tcpdump抓包见真章  
- DNS解析dig来帮，网络诊断有方向
- 从下到上分层查，问题定位不迷茫