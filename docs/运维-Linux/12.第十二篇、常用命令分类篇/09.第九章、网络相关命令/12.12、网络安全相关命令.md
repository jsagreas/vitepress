---
title: 12ã€ç½‘ç»œå®‰å…¨ç›¸å…³å‘½ä»¤
---
## ğŸ“š ç›®å½•

1. [iptablesé˜²ç«å¢™å®‰å…¨è§„åˆ™](#1-iptablesé˜²ç«å¢™å®‰å…¨è§„åˆ™)
2. [fail2banå…¥ä¾µé˜²æŠ¤ç³»ç»Ÿ](#2-fail2banå…¥ä¾µé˜²æŠ¤ç³»ç»Ÿ)
3. [tcpwrappersè®¿é—®æ§åˆ¶](#3-tcpwrappersè®¿é—®æ§åˆ¶)
4. [ç«¯å£æ‰«æé˜²æŠ¤ä¸æ£€æµ‹](#4-ç«¯å£æ‰«æé˜²æŠ¤ä¸æ£€æµ‹)
5. [ç½‘ç»œè¿æ¥å®‰å…¨æ£€æŸ¥](#5-ç½‘ç»œè¿æ¥å®‰å…¨æ£€æŸ¥)
6. [SSL/TLSè¿æ¥æµ‹è¯•](#6-ssl-tlsè¿æ¥æµ‹è¯•)
7. [ç½‘ç»œå®‰å…¨æ—¥å¿—åˆ†æ](#7-ç½‘ç»œå®‰å…¨æ—¥å¿—åˆ†æ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”¥ iptablesé˜²ç«å¢™å®‰å…¨è§„åˆ™


### 1.1 iptablesåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯iptables**
```
ç®€å•ç†è§£ï¼šiptableså°±åƒé—¨å«ï¼Œå†³å®šå“ªäº›ç½‘ç»œæ•°æ®åŒ…èƒ½è¿›æ¥ã€å‡ºå»
ä½œç”¨ï¼šè¿‡æ»¤ç½‘ç»œæµé‡ï¼Œä¿æŠ¤æœåŠ¡å™¨å®‰å…¨
ä½ç½®ï¼šå·¥ä½œåœ¨Linuxå†…æ ¸çš„ç½‘ç»œå±‚ï¼Œæ£€æŸ¥æ¯ä¸ªæ•°æ®åŒ…
```

**ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µè§£é‡Š**
```
è¡¨(Tables)ï¼šä¸åŒåŠŸèƒ½çš„è§„åˆ™åˆ†ç±»
â”œâ”€ filterè¡¨ï¼šè¿‡æ»¤æ•°æ®åŒ…ï¼ˆæœ€å¸¸ç”¨ï¼‰
â”œâ”€ natè¡¨ï¼šç½‘ç»œåœ°å€è½¬æ¢
â”œâ”€ mangleè¡¨ï¼šä¿®æ”¹æ•°æ®åŒ…æ ‡è®°
â””â”€ rawè¡¨ï¼šè·³è¿‡è¿æ¥è·Ÿè¸ª

é“¾(Chains)ï¼šè§„åˆ™çš„æ‰§è¡Œé¡ºåº
â”œâ”€ INPUTï¼šè¿›å…¥æœ¬æœºçš„æ•°æ®åŒ…
â”œâ”€ OUTPUTï¼šæœ¬æœºå‘å‡ºçš„æ•°æ®åŒ…
â”œâ”€ FORWARDï¼šç»è¿‡æœ¬æœºè½¬å‘çš„æ•°æ®åŒ…
â”œâ”€ PREROUTINGï¼šæ•°æ®åŒ…åˆ°è¾¾å‰å¤„ç†
â””â”€ POSTROUTINGï¼šæ•°æ®åŒ…ç¦»å¼€åå¤„ç†
```

### 1.2 iptableså¸¸ç”¨å®‰å…¨è§„åˆ™


**ğŸ›¡ï¸ åŸºç¡€é˜²æŠ¤é…ç½®**

```bash
# æŸ¥çœ‹å½“å‰è§„åˆ™
iptables -L -n -v

# è®¾ç½®é»˜è®¤ç­–ç•¥ï¼ˆé»˜è®¤æ‹’ç»æ‰€æœ‰ï¼‰
iptables -P INPUT DROP
iptables -P FORWARD DROP  
iptables -P OUTPUT ACCEPT

# å…è®¸æœ¬åœ°å›ç¯
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT
```

**ğŸ” SSHå®‰å…¨é˜²æŠ¤**
```bash
# é™åˆ¶SSHè¿æ¥é¢‘ç‡ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW -m limit --limit 3/min --limit-burst 3 -j ACCEPT

# åªå…è®¸ç‰¹å®šIPè®¿é—®SSH
iptables -A INPUT -p tcp -s 192.168.1.100 --dport 22 -j ACCEPT

# ä¿®æ”¹SSHé»˜è®¤ç«¯å£åçš„è§„åˆ™
iptables -A INPUT -p tcp --dport 2222 -j ACCEPT
```

**ğŸŒ WebæœåŠ¡å®‰å…¨è§„åˆ™**
```bash
# å…è®¸HTTPå’ŒHTTPS
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# é˜²æ­¢SYNæ´ªæ°´æ”»å‡»
iptables -A INPUT -p tcp --syn -m limit --limit 1/s --limit-burst 3 -j ACCEPT

# é˜»æ­¢Pingæ´ªæ°´æ”»å‡»
iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s -j ACCEPT
```

### 1.3 é«˜çº§é˜²æŠ¤è§„åˆ™


**ğŸš« é˜²æ­¢å¸¸è§æ”»å‡»**

| æ”»å‡»ç±»å‹ | **é˜²æŠ¤è§„åˆ™** | **ä½œç”¨è¯´æ˜** |
|---------|-------------|-------------|
| **ç«¯å£æ‰«æ** | `iptables -A INPUT -p tcp --tcp-flags ALL FIN,URG,PSH -j DROP` | é˜»æ­¢éšè”½æ‰«æ |
| **NULLæ”»å‡»** | `iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP` | é˜»æ­¢NULLåŒ…æ”»å‡» |
| **XMASæ”»å‡»** | `iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP` | é˜»æ­¢åœ£è¯æ ‘æ”»å‡» |
| **è¿æ¥æ•°é™åˆ¶** | `iptables -A INPUT -p tcp --syn -m connlimit --connlimit-above 20 -j DROP` | é™åˆ¶å•IPè¿æ¥æ•° |

**âš™ï¸ å®ç”¨ç®¡ç†å‘½ä»¤**
```bash
# ä¿å­˜è§„åˆ™
iptables-save > /etc/iptables/rules.v4

# æ¢å¤è§„åˆ™  
iptables-restore < /etc/iptables/rules.v4

# æ¸…ç©ºæ‰€æœ‰è§„åˆ™
iptables -F
iptables -X
iptables -Z

# æ’å…¥è§„åˆ™åˆ°æŒ‡å®šä½ç½®
iptables -I INPUT 1 -p tcp --dport 8080 -j ACCEPT
```

> âš ï¸ **å®‰å…¨æé†’**
> 
> é…ç½®iptablesæ—¶è¦å°å¿ƒï¼Œé”™è¯¯çš„è§„åˆ™å¯èƒ½å¯¼è‡´SSHè¿æ¥æ–­å¼€ï¼Œæ— æ³•è¿œç¨‹ç®¡ç†æœåŠ¡å™¨
> **å»ºè®®**ï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼Œæˆ–è€…è®¾ç½®å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ¸…ç†è§„åˆ™

---

## 2. ğŸ›¡ï¸ fail2banå…¥ä¾µé˜²æŠ¤ç³»ç»Ÿ


### 2.1 fail2banå·¥ä½œåŸç†


**ğŸ”¸ ä»€ä¹ˆæ˜¯fail2ban**
```
ç®€å•ç†è§£ï¼šfail2banå°±åƒæ™ºèƒ½ä¿å®‰ï¼Œè‡ªåŠ¨è¯†åˆ«å’Œé˜»æ­¢å¯ç–‘è¡Œä¸º
å·¥ä½œæ–¹å¼ï¼šç›‘æ§æ—¥å¿—æ–‡ä»¶ï¼Œå‘ç°å¼‚å¸¸è¡Œä¸ºå°±ä¸´æ—¶å°ç¦IP
å…¸å‹åœºæ™¯ï¼šé˜²æ­¢SSHæš´åŠ›ç ´è§£ã€ç½‘ç«™æ¶æ„è®¿é—®
```

**ğŸ”„ å·¥ä½œæµç¨‹å›¾**
```
æ—¥å¿—ç›‘æ§ â†’ åŒ¹é…è§„åˆ™ â†’ è§¦å‘é˜ˆå€¼ â†’ æ‰§è¡ŒåŠ¨ä½œ â†’ è‡ªåŠ¨è§£å°
    â†“         â†“         â†“         â†“         â†“
/var/log/  æ­£åˆ™è¡¨è¾¾å¼  å¤±è´¥æ¬¡æ•°   å°ç¦IP    æŒ‡å®šæ—¶é—´å
auth.log   åŒ¹é…å¤±è´¥    è¾¾åˆ°é™åˆ¶   æ·»åŠ è§„åˆ™   è‡ªåŠ¨ç§»é™¤
```

### 2.2 fail2banåŸºæœ¬é…ç½®


**ğŸ“ é…ç½®æ–‡ä»¶ç»“æ„**
```
/etc/fail2ban/
â”œâ”€â”€ fail2ban.conf      # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ jail.conf          # ç›‘ç‹±é…ç½®æ–‡ä»¶ï¼ˆä¸è¦ç›´æ¥ä¿®æ”¹ï¼‰
â”œâ”€â”€ jail.local         # è‡ªå®šä¹‰ç›‘ç‹±é…ç½®
â””â”€â”€ filter.d/          # è¿‡æ»¤è§„åˆ™ç›®å½•
    â”œâ”€â”€ sshd.conf
    â”œâ”€â”€ apache.conf
    â””â”€â”€ nginx.conf
```

**ğŸ”§ SSHé˜²æŠ¤é…ç½®ç¤ºä¾‹**
```bash
# ç¼–è¾‘ /etc/fail2ban/jail.local
[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3         # æœ€å¤§å°è¯•æ¬¡æ•°
bantime = 3600       # å°ç¦æ—¶é—´(ç§’)
findtime = 600       # æ—¶é—´çª—å£(ç§’)
```

**ğŸ“Š é…ç½®å‚æ•°è¯¦è§£**

| å‚æ•° | **å«ä¹‰** | **æ¨èå€¼** | **è¯´æ˜** |
|------|---------|-----------|---------|
| **maxretry** | æœ€å¤§å¤±è´¥æ¬¡æ•° | `3-5` | è¶…è¿‡æ­¤æ¬¡æ•°è§¦å‘å°ç¦ |
| **bantime** | å°ç¦æŒç»­æ—¶é—´ | `3600` | 1å°æ—¶ï¼Œå¯è®¾ç½®-1æ°¸ä¹…å°ç¦ |
| **findtime** | æ£€æµ‹æ—¶é—´çª—å£ | `600` | 10åˆ†é’Ÿå†…çš„å¤±è´¥æ¬¡æ•° |
| **ignoreip** | ç™½åå•IP | `127.0.0.1/8` | æ°¸ä¸å°ç¦çš„IPåœ°å€ |

### 2.3 fail2banå¸¸ç”¨å‘½ä»¤


**ğŸ” çŠ¶æ€æŸ¥çœ‹å‘½ä»¤**
```bash
# æŸ¥çœ‹fail2bançŠ¶æ€
fail2ban-client status

# æŸ¥çœ‹ç‰¹å®šç›‘ç‹±çŠ¶æ€
fail2ban-client status sshd

# æŸ¥çœ‹è¢«å°ç¦çš„IP
fail2ban-client get sshd banned
```

**âš¡ ç®¡ç†å‘½ä»¤**
```bash
# æ‰‹åŠ¨å°ç¦IP
fail2ban-client set sshd banip 192.168.1.100

# è§£å°IP
fail2ban-client set sshd unbanip 192.168.1.100

# é‡æ–°åŠ è½½é…ç½®
fail2ban-client reload

# å¯åŠ¨/åœæ­¢æœåŠ¡
systemctl start fail2ban
systemctl enable fail2ban
```

**ğŸ¯ å®ç”¨æŠ€å·§**
```bash
# æŸ¥çœ‹å®æ—¶å°ç¦æ—¥å¿—
tail -f /var/log/fail2ban.log

# ç»Ÿè®¡å°ç¦æƒ…å†µ
fail2ban-client status | grep "Currently banned"

# è‡ªå®šä¹‰é‚®ä»¶é€šçŸ¥
# åœ¨jail.localä¸­æ·»åŠ ï¼š
[DEFAULT]
destemail = admin@yourdomain.com
sendername = Fail2Ban-Server
mta = sendmail
action = %(action_mw)s
```

---

## 3. ğŸ”’ tcpwrappersè®¿é—®æ§åˆ¶


### 3.1 tcpwrappersåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯tcpwrappers**
```
ç®€å•ç†è§£ï¼štcpwrappersæ˜¯æœåŠ¡çº§åˆ«çš„é—¨å«ï¼Œæ§åˆ¶å“ªäº›IPèƒ½è®¿é—®ç‰¹å®šæœåŠ¡
ç‰¹ç‚¹ï¼šæ— éœ€é‡å¯æœåŠ¡å³å¯ç”Ÿæ•ˆï¼Œé€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶è®¿é—®æƒé™
æ”¯æŒæœåŠ¡ï¼šSSHã€FTPã€Telnetç­‰å¤§å¤šæ•°ç½‘ç»œæœåŠ¡
```

**ğŸ“ æ ¸å¿ƒé…ç½®æ–‡ä»¶**
```
/etc/hosts.allow   # å…è®¸è®¿é—®è§„åˆ™ï¼ˆä¼˜å…ˆçº§é«˜ï¼‰
/etc/hosts.deny    # æ‹’ç»è®¿é—®è§„åˆ™ï¼ˆä¼˜å…ˆçº§ä½ï¼‰

å¤„ç†é¡ºåºï¼š
1. å…ˆæ£€æŸ¥ hosts.allowï¼ŒåŒ¹é…åˆ™å…è®¸
2. å†æ£€æŸ¥ hosts.denyï¼ŒåŒ¹é…åˆ™æ‹’ç»  
3. éƒ½ä¸åŒ¹é…åˆ™é»˜è®¤å…è®¸
```

### 3.2 tcpwrappersé…ç½®è¯­æ³•


**ğŸ“ åŸºæœ¬è¯­æ³•æ ¼å¼**
```
æœåŠ¡å : å®¢æˆ·ç«¯åˆ—è¡¨ : é€‰é¡¹

ç¤ºä¾‹ï¼š
sshd : 192.168.1.0/24 : allow
sshd : ALL : deny
```

**ğŸ¯ å¸¸ç”¨é…ç½®ç¤ºä¾‹**

```bash
# /etc/hosts.allow ç¤ºä¾‹
# å…è®¸æœ¬åœ°ç½‘ç»œè®¿é—®SSH
sshd : 192.168.1.0/24
sshd : 10.0.0.0/8
sshd : localhost

# å…è®¸ç‰¹å®šIPè®¿é—®FTP
vsftpd : 192.168.1.100, 192.168.1.200

# å…è®¸åŸŸåè®¿é—®ï¼ˆéœ€è¦DNSè§£æï¼‰
sshd : .example.com

# /etc/hosts.deny ç¤ºä¾‹  
# æ‹’ç»æ‰€æœ‰å…¶ä»–è¿æ¥
sshd : ALL
```

**ğŸ”§ é«˜çº§é…ç½®é€‰é¡¹**

| è¯­æ³• | **å«ä¹‰** | **ç¤ºä¾‹** |
|------|---------|---------|
| **ALL** | æ‰€æœ‰æœåŠ¡æˆ–æ‰€æœ‰å®¢æˆ·ç«¯ | `ALL : ALL : deny` |
| **LOCAL** | æœ¬åœ°ä¸»æœº | `sshd : LOCAL` |
| **UNKNOWN** | æ— æ³•è§£æçš„ä¸»æœº | `ALL : UNKNOWN : deny` |
| **PARANOID** | IPä¸ä¸»æœºåä¸åŒ¹é… | `ALL : PARANOID : deny` |

### 3.3 tcpwrapperså®ç”¨æŠ€å·§


**ğŸš€ åŠ¨æ€é…ç½®ç®¡ç†**
```bash
# ä¸´æ—¶æµ‹è¯•é…ç½®ï¼ˆä¸å½±å“åŸæ–‡ä»¶ï¼‰
echo "sshd : 192.168.1.100" >> /etc/hosts.allow

# æŸ¥çœ‹æœåŠ¡æ˜¯å¦æ”¯æŒtcpwrappers
ldd /usr/sbin/sshd | grep wrap

# æµ‹è¯•è®¿é—®æ§åˆ¶è§„åˆ™
tcpdchk -v
```

**ğŸ“Š æ—¥å¿—è®°å½•é…ç½®**
```bash
# åœ¨ hosts.allow ä¸­æ·»åŠ æ—¥å¿—è®°å½•
sshd : 192.168.1.0/24 : spawn /bin/echo "$(date) SSH access from %c to %s" >> /var/log/tcp_wrapper.log

# åœ¨ hosts.deny ä¸­è®°å½•æ‹’ç»è®¿é—®
ALL : ALL : spawn /bin/echo "$(date) Denied access from %c to %s" >> /var/log/tcp_wrapper.log
```

> ğŸ’¡ **å®ç”¨å»ºè®®**
> 
> tcpwrappersæ˜¯**è½»é‡çº§**çš„è®¿é—®æ§åˆ¶å·¥å…·ï¼Œé€‚åˆç®€å•çš„IPç™½/é»‘åå•ç®¡ç†
> å¯¹äºå¤æ‚çš„è®¿é—®æ§åˆ¶éœ€æ±‚ï¼Œå»ºè®®ç»“åˆiptablesä½¿ç”¨

---

## 4. ğŸ” ç«¯å£æ‰«æé˜²æŠ¤ä¸æ£€æµ‹


### 4.1 ç«¯å£æ‰«ææ£€æµ‹


**ğŸ”¸ ä»€ä¹ˆæ˜¯ç«¯å£æ‰«æ**
```
ç®€å•ç†è§£ï¼šç«¯å£æ‰«æå°±åƒå°å·è¸©ç‚¹ï¼Œè¯•å›¾æ‰¾å‡ºæœåŠ¡å™¨å¼€æ”¾äº†å“ªäº›æœåŠ¡
å±é™©æ€§ï¼šæš´éœ²æœåŠ¡ä¿¡æ¯ï¼Œä¸ºåç»­æ”»å‡»æä¾›ç›®æ ‡
å¸¸è§å·¥å…·ï¼šnmapã€masscanã€zmapç­‰
```

**ğŸ” æ£€æµ‹ç«¯å£æ‰«æçš„æ–¹æ³•**

```bash
# 1. ä½¿ç”¨netstatç›‘æ§è¿æ¥
netstat -an | grep SYN_RECV | wc -l

# 2. å®æ—¶ç›‘æ§æ–°å»ºè¿æ¥
ss -tn state syn-recv | wc -l

# 3. æŸ¥çœ‹å¼‚å¸¸è¿æ¥å°è¯•
journalctl -u ssh | grep "Failed\|Invalid" | tail -20

# 4. ç›‘æ§è¿æ¥çŠ¶æ€å˜åŒ–
watch -n 1 'netstat -tan | grep :22 | sort'
```

### 4.2 ç«¯å£æ‰«æé˜²æŠ¤ç­–ç•¥


**ğŸ›¡ï¸ åŸºç¡€é˜²æŠ¤æªæ–½**

```bash
# 1. ä¿®æ”¹é»˜è®¤ç«¯å£
# SSHé»˜è®¤22æ”¹ä¸ºå…¶ä»–ç«¯å£
Port 2222  # åœ¨/etc/ssh/sshd_configä¸­ä¿®æ”¹

# 2. ç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡
systemctl disable telnet
systemctl disable ftp
systemctl stop rsh

# 3. ä½¿ç”¨iptablesé™åˆ¶è¿æ¥é¢‘ç‡
iptables -A INPUT -p tcp --dport 22 -m recent --set --name SSH
iptables -A INPUT -p tcp --dport 22 -m recent --update --seconds 60 --hitcount 4 --name SSH -j DROP
```

**ğŸ¯ é«˜çº§é˜²æŠ¤æŠ€æœ¯**

| æŠ€æœ¯ | **å®ç°æ–¹æ³•** | **æ•ˆæœ** |
|------|-------------|---------|
| **ç«¯å£æ•²é—¨** | ä½¿ç”¨knockdæœåŠ¡ | åŠ¨æ€å¼€å¯ç«¯å£ |
| **èœœç½ç«¯å£** | è®¾ç½®å‡æœåŠ¡ç›‘å¬ | è¯±å¯¼å’Œè®°å½•æ‰«æè€… |
| **è¿æ¥é™åˆ¶** | iptablesé™åˆ¶è§„åˆ™ | é˜²æ­¢å¿«é€Ÿæ‰«æ |
| **åœ°ç†ä½ç½®è¿‡æ»¤** | GeoIPæ¨¡å— | é˜»æ­¢ç‰¹å®šå›½å®¶IP |

### 4.3 æ‰«ææ£€æµ‹è„šæœ¬


**ğŸ”§ ç®€å•ç›‘æ§è„šæœ¬**
```bash
#!/bin/bash
# ç«¯å£æ‰«æç›‘æ§è„šæœ¬

LOG_FILE="/var/log/port_scan.log"
THRESHOLD=10

while true; do
    SCAN_COUNT=$(netstat -an | grep SYN_RECV | wc -l)
    
    if [ $SCAN_COUNT -gt $THRESHOLD ]; then
        echo "$(date): æ£€æµ‹åˆ°å¯èƒ½çš„ç«¯å£æ‰«æï¼ŒSYN_RECVè¿æ¥æ•°: $SCAN_COUNT" >> $LOG_FILE
        
        # è·å–æ‰«ææºIP
        netstat -an | grep SYN_RECV | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -rn | head -5 >> $LOG_FILE
    fi
    
    sleep 5
done
```

---

## 5. ğŸ” ç½‘ç»œè¿æ¥å®‰å…¨æ£€æŸ¥


### 5.1 ç½‘ç»œè¿æ¥çŠ¶æ€ç›‘æ§


**ğŸ”¸ ä¸ºä»€ä¹ˆè¦ç›‘æ§ç½‘ç»œè¿æ¥**
```
ç›®çš„ï¼šåŠæ—¶å‘ç°å¼‚å¸¸è¿æ¥ï¼Œè¯†åˆ«æ½œåœ¨çš„å®‰å…¨å¨èƒ
é‡ç‚¹å…³æ³¨ï¼š
- æœªæˆæƒçš„è¿œç¨‹è¿æ¥
- å¼‚å¸¸çš„å¤–å‘è¿æ¥  
- å¤§é‡çš„è¿æ¥è¯·æ±‚
- å¯ç–‘çš„ç«¯å£æ´»åŠ¨
```

**ğŸ“Š è¿æ¥çŠ¶æ€æŸ¥çœ‹å‘½ä»¤**

```bash
# æŸ¥çœ‹æ‰€æœ‰ç½‘ç»œè¿æ¥
netstat -tuln  # æ˜¾ç¤ºç›‘å¬ç«¯å£
netstat -tun   # æ˜¾ç¤ºæ‰€æœ‰TCP/UDPè¿æ¥

# æ›´ç°ä»£çš„sså‘½ä»¤
ss -tuln       # æ˜¾ç¤ºç›‘å¬ç«¯å£
ss -tun        # æ˜¾ç¤ºæ‰€æœ‰è¿æ¥
ss -p          # æ˜¾ç¤ºè¿›ç¨‹ä¿¡æ¯

# æŒ‰çŠ¶æ€åˆ†ç±»æŸ¥çœ‹è¿æ¥
ss -t state established    # å·²å»ºç«‹è¿æ¥
ss -t state listening      # ç›‘å¬çŠ¶æ€
ss -t state syn-sent       # å‘èµ·è¿æ¥ä¸­
```

### 5.2 å¼‚å¸¸è¿æ¥è¯†åˆ«


**ğŸš¨ å¼‚å¸¸è¿æ¥ç‰¹å¾**

```bash
# 1. æŸ¥æ‰¾å¼‚å¸¸çš„å¤–å‘è¿æ¥
ss -tn | grep :80 | grep -v "192.168\|127.0.0.1\|10\."

# 2. ç»Ÿè®¡è¿æ¥æ•°æœ€å¤šçš„å¤–éƒ¨IP
netstat -tn | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -rn | head -10

# 3. æŸ¥çœ‹éæ ‡å‡†ç«¯å£è¿æ¥
ss -tn | grep -E ":[0-9]{5,}|:99[0-9][0-9]"

# 4. æ£€æŸ¥å¯ç–‘è¿›ç¨‹çš„ç½‘ç»œæ´»åŠ¨
lsof -i -P | grep -E "LISTEN|ESTABLISHED" | grep -v "ssh\|http"
```

**ğŸ” è¿æ¥å®‰å…¨åˆ†æ**

| æ£€æŸ¥é¡¹ | **å‘½ä»¤** | **å…³æ³¨ç‚¹** |
|-------|---------|-----------|
| **ç›‘å¬ç«¯å£** | `ss -tuln` | ä¸åº”è¯¥å¼€æ”¾çš„ç«¯å£ |
| **å¤–éƒ¨è¿æ¥** | `ss -tn \| grep :80` | å¼‚å¸¸çš„å¤–å‘è¿æ¥ |
| **è¿æ¥ç»Ÿè®¡** | `ss -s` | è¿æ¥æ•°é‡å¼‚å¸¸ |
| **è¿›ç¨‹å…³è”** | `lsof -i -P` | å¯ç–‘è¿›ç¨‹çš„ç½‘ç»œè¡Œä¸º |

### 5.3 è‡ªåŠ¨åŒ–å®‰å…¨æ£€æŸ¥


**ğŸ¤– è¿æ¥ç›‘æ§è„šæœ¬**
```bash
#!/bin/bash
# ç½‘ç»œè¿æ¥å®‰å…¨æ£€æŸ¥è„šæœ¬

echo "=== ç½‘ç»œè¿æ¥å®‰å…¨æ£€æŸ¥æŠ¥å‘Š $(date) ==="

# 1. æ£€æŸ¥å¼‚å¸¸ç›‘å¬ç«¯å£
echo "1. å¼‚å¸¸ç›‘å¬ç«¯å£æ£€æŸ¥ï¼š"
ss -tuln | grep -v -E ":22|:80|:443|:53" | grep -E ":(80[0-9][0-9]|9[0-9]{3}|[1-9][0-9]{4})"

# 2. æ£€æŸ¥å¤–éƒ¨è¿æ¥ç»Ÿè®¡
echo "2. å¤–éƒ¨è¿æ¥TOP 5ï¼š"
ss -tn | grep ESTAB | awk '{print $4}' | cut -d: -f1 | sort | uniq -c | sort -rn | head -5

# 3. æ£€æŸ¥å¯ç–‘è¿›ç¨‹
echo "3. å¯ç–‘ç½‘ç»œè¿›ç¨‹ï¼š"
lsof -i -P | grep -v -E "ssh|http|dns" | grep LISTEN

# 4. è¿æ¥çŠ¶æ€ç»Ÿè®¡
echo "4. è¿æ¥çŠ¶æ€ç»Ÿè®¡ï¼š"
ss -s
```

---

## 6. ğŸ” SSL/TLSè¿æ¥æµ‹è¯•


### 6.1 SSL/TLSåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯SSL/TLS**
```
ç®€å•ç†è§£ï¼šSSL/TLSå°±åƒç»™æ•°æ®ä¼ è¾“åŠ äº†ä¸€ä¸ªä¿é™©ç®±ï¼Œä¿è¯æ•°æ®å®‰å…¨ä¼ è¾“
ä½œç”¨ï¼šåŠ å¯†ç½‘ç»œé€šä¿¡ï¼Œé˜²æ­¢æ•°æ®è¢«çªƒå¬ã€ç¯¡æ”¹
åº”ç”¨åœºæ™¯ï¼šHTTPSç½‘ç«™ã€é‚®ä»¶æœåŠ¡ã€VPNè¿æ¥ç­‰
```

**ğŸ”’ SSL/TLSè¿æ¥è¿‡ç¨‹**
```
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼šHelloï¼Œæˆ‘æƒ³å»ºç«‹å®‰å…¨è¿æ¥
æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼šè¿™æ˜¯æˆ‘çš„è¯ä¹¦ï¼Œè¯æ˜æˆ‘çš„èº«ä»½  
å®¢æˆ·ç«¯éªŒè¯è¯ä¹¦ â†’ ç”Ÿæˆå¯†é’¥ â†’ åŠ å¯†é€šä¿¡å¼€å§‹
         â†“
    å®‰å…¨çš„æ•°æ®ä¼ è¾“é€šé“å»ºç«‹å®Œæˆ
```

### 6.2 SSL/TLSè¿æ¥æµ‹è¯•å·¥å…·


**ğŸ”§ opensslæµ‹è¯•å‘½ä»¤**

```bash
# 1. æµ‹è¯•HTTPSè¿æ¥
openssl s_client -connect www.example.com:443

# 2. æŸ¥çœ‹è¯ä¹¦è¯¦ç»†ä¿¡æ¯
openssl s_client -connect www.example.com:443 -showcerts

# 3. æµ‹è¯•ç‰¹å®šSSLç‰ˆæœ¬
openssl s_client -connect www.example.com:443 -tls1_2

# 4. æµ‹è¯•è¯ä¹¦æœ‰æ•ˆæœŸ
echo | openssl s_client -connect www.example.com:443 2>/dev/null | openssl x509 -dates -noout
```

**ğŸ“Š SSL/TLSå®‰å…¨æ£€æŸ¥**

| æ£€æŸ¥é¡¹ | **å‘½ä»¤** | **æ£€æŸ¥å†…å®¹** |
|-------|---------|-------------|
| **è¯ä¹¦æœ‰æ•ˆæœŸ** | `openssl x509 -dates` | æ˜¯å¦è¿‡æœŸ |
| **åŠ å¯†å¼ºåº¦** | `openssl ciphers -V` | åŠ å¯†ç®—æ³•å®‰å…¨æ€§ |
| **åè®®ç‰ˆæœ¬** | `openssl s_client -tls1_2` | æ”¯æŒçš„TLSç‰ˆæœ¬ |
| **è¯ä¹¦é“¾** | `openssl s_client -showcerts` | è¯ä¹¦é“¾å®Œæ•´æ€§ |

### 6.3 SSL/TLSå®‰å…¨é…ç½®


**ğŸ›¡ï¸ å®‰å…¨é…ç½®å»ºè®®**
```bash
# 1. ç”Ÿæˆå¼ºå¯†é’¥
openssl genrsa -out private.key 2048

# 2. åˆ›å»ºè¯ä¹¦è¯·æ±‚
openssl req -new -key private.key -out cert.csr

# 3. è‡ªç­¾åè¯ä¹¦(æµ‹è¯•ç”¨)
openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365

# 4. æŸ¥çœ‹è¯ä¹¦å†…å®¹
openssl x509 -in cert.pem -text -noout
```

**âš™ï¸ æœåŠ¡å™¨SSLé…ç½®ä¼˜åŒ–**
```bash
# Nginx SSLå®‰å…¨é…ç½®ç¤ºä¾‹
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
ssl_prefer_server_ciphers off;
ssl_session_cache shared:SSL:10m;
```

---

## 7. ğŸ“Š ç½‘ç»œå®‰å…¨æ—¥å¿—åˆ†æ


### 7.1 é‡è¦å®‰å…¨æ—¥å¿—æ–‡ä»¶


**ğŸ“ æ ¸å¿ƒæ—¥å¿—æ–‡ä»¶ä½ç½®**
```
/var/log/auth.log          # è®¤è¯ç›¸å…³æ—¥å¿—(Ubuntu/Debian)
/var/log/secure            # è®¤è¯ç›¸å…³æ—¥å¿—(RedHat/CentOS)
/var/log/messages          # ç³»ç»Ÿæ¶ˆæ¯æ—¥å¿—
/var/log/syslog            # ç³»ç»Ÿæ—¥å¿—
/var/log/fail2ban.log      # fail2banæ—¥å¿—
/var/log/iptables.log      # iptablesæ—¥å¿—(å¦‚æœé…ç½®)
```

**ğŸ” æ—¥å¿—åˆ†æåŸºæœ¬æŠ€å·§**
```bash
# 1. æŸ¥çœ‹SSHç™»å½•å¤±è´¥è®°å½•
grep "Failed password" /var/log/auth.log | tail -20

# 2. ç»Ÿè®¡å¤±è´¥ç™»å½•çš„IP
grep "Failed password" /var/log/auth.log | awk '{print $11}' | sort | uniq -c | sort -rn

# 3. æŸ¥çœ‹æˆåŠŸç™»å½•è®°å½•
grep "Accepted password" /var/log/auth.log | tail -10

# 4. å®æ—¶ç›‘æ§ç™»å½•å°è¯•
tail -f /var/log/auth.log | grep --line-buffered "sshd"
```

### 7.2 æ—¥å¿—åˆ†æå®ç”¨å‘½ä»¤


**ğŸ“ˆ ç™»å½•å®‰å…¨åˆ†æ**

```bash
# ç»Ÿè®¡ä»Šæ—¥ç™»å½•å¤±è´¥æ¬¡æ•°
grep "$(date '+%b %d')" /var/log/auth.log | grep "Failed password" | wc -l

# æŸ¥æ‰¾æš´åŠ›ç ´è§£æ”»å‡»
awk '/Failed password/ {count[$11]++} END {for (ip in count) if (count[ip] > 5) print ip, count[ip]}' /var/log/auth.log

# åˆ†æç™»å½•æ—¶é—´æ¨¡å¼
grep "Accepted password" /var/log/auth.log | awk '{print $1, $2, $3}' | sort | uniq -c

# æ£€æŸ¥å¼‚å¸¸ç™»å½•æ—¶é—´
grep "Accepted password" /var/log/auth.log | awk '{print $3}' | awk -F: '{print $1}' | sort | uniq -c
```

**ğŸš¨ å¼‚å¸¸è¡Œä¸ºæ£€æµ‹**

| å¼‚å¸¸ç±»å‹ | **æ£€æµ‹å‘½ä»¤** | **å…³æ³¨æŒ‡æ ‡** |
|---------|-------------|-------------|
| **æš´åŠ›ç ´è§£** | `awk '/Failed password/ {count[$11]++}'` | å•IPå¤±è´¥æ¬¡æ•° |
| **å¼‚å¸¸æ—¶é—´ç™»å½•** | `grep "02\|03\|04\|05:" auth.log` | å‡Œæ™¨æ—¶æ®µç™»å½• |
| **rootç™»å½•å°è¯•** | `grep "root" auth.log \| grep "Failed"` | é’ˆå¯¹rootè´¦æˆ·æ”»å‡» |
| **æ–°ç”¨æˆ·ç™»å½•** | `grep "New session" auth.log` | é¦–æ¬¡ç™»å½•ç”¨æˆ· |

### 7.3 æ—¥å¿—ç›‘æ§è‡ªåŠ¨åŒ–


**ğŸ”§ æ—¥å¿—åˆ†æè„šæœ¬**
```bash
#!/bin/bash
# å®‰å…¨æ—¥å¿—åˆ†æè„šæœ¬

LOG_FILE="/var/log/auth.log"
REPORT_FILE="/tmp/security_report.txt"

echo "=== å®‰å…¨æ—¥å¿—åˆ†ææŠ¥å‘Š $(date) ===" > $REPORT_FILE

# 1. ç»Ÿè®¡ä»Šæ—¥ç™»å½•å¤±è´¥
echo "ä»Šæ—¥ç™»å½•å¤±è´¥æ¬¡æ•°:" >> $REPORT_FILE
grep "$(date '+%b %d')" $LOG_FILE | grep "Failed password" | wc -l >> $REPORT_FILE

# 2. TOP 10å¤±è´¥IP
echo "å¤±è´¥ç™»å½•TOP 10 IP:" >> $REPORT_FILE
grep "Failed password" $LOG_FILE | awk '{print $11}' | sort | uniq -c | sort -rn | head -10 >> $REPORT_FILE

# 3. æ£€æŸ¥rootç™»å½•å°è¯•
echo "rootè´¦æˆ·æ”»å‡»å°è¯•:" >> $REPORT_FILE
grep "root" $LOG_FILE | grep "Failed password" | wc -l >> $REPORT_FILE

# 4. å¼‚å¸¸æ—¶é—´ç™»å½•
echo "å‡Œæ™¨æ—¶æ®µç™»å½•è®°å½•:" >> $REPORT_FILE
grep "0[2-5]:" $LOG_FILE | grep "Accepted password" >> $REPORT_FILE

# å‘é€æŠ¥å‘Š(å¦‚æœé…ç½®äº†é‚®ä»¶)
# mail -s "å®‰å…¨æ—¥å¿—æŠ¥å‘Š" admin@example.com < $REPORT_FILE
```

**ğŸ“Š æ—¥å¿—è½®è½¬å’Œç®¡ç†**
```bash
# é…ç½®logrotateè‡ªåŠ¨è½®è½¬æ—¥å¿—
# /etc/logrotate.d/security-logs
/var/log/security.log {
    daily
    missingok
    rotate 30
    compress
    notifempty
    copytruncate
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒå‘½ä»¤


```
ğŸ”¸ iptablesï¼šLinuxé˜²ç«å¢™æ ¸å¿ƒå·¥å…·ï¼Œæ§åˆ¶ç½‘ç»œæ•°æ®åŒ…è¿›å‡º
ğŸ”¸ fail2banï¼šè‡ªåŠ¨å…¥ä¾µé˜²æŠ¤ï¼Œç›‘æ§æ—¥å¿—å¹¶ä¸´æ—¶å°ç¦æ”»å‡»IP  
ğŸ”¸ tcpwrappersï¼šæœåŠ¡çº§è®¿é—®æ§åˆ¶ï¼Œé€šè¿‡hosts.allow/denyæ–‡ä»¶ç®¡ç†
ğŸ”¸ netstat/ssï¼šç½‘ç»œè¿æ¥çŠ¶æ€æŸ¥çœ‹ï¼Œç›‘æ§å¼‚å¸¸è¿æ¥
ğŸ”¸ opensslï¼šSSL/TLSè¿æ¥æµ‹è¯•ï¼Œè¯ä¹¦éªŒè¯å’ŒåŠ å¯†æµ‹è¯•
ğŸ”¸ æ—¥å¿—åˆ†æï¼šé€šè¿‡ç³»ç»Ÿæ—¥å¿—å‘ç°å®‰å…¨å¨èƒï¼Œç»Ÿè®¡æ”»å‡»æ¨¡å¼
```

### 8.2 å…³é”®å®‰å…¨ç­–ç•¥


**ğŸ›¡ï¸ é˜²æŠ¤å±‚æ¬¡åŒ–**
```
ç½‘ç»œå±‚é˜²æŠ¤ï¼šiptablesè§„åˆ™è¿‡æ»¤
åº”ç”¨å±‚é˜²æŠ¤ï¼šfail2banè¡Œä¸ºåˆ†æ  
æœåŠ¡å±‚é˜²æŠ¤ï¼štcpwrappersè®¿é—®æ§åˆ¶
ç›‘æ§å±‚é˜²æŠ¤ï¼šæ—¥å¿—åˆ†æå’Œå®æ—¶ç›‘æ§
```

**ğŸ¯ å®‰å…¨é…ç½®åŸåˆ™**
```
é»˜è®¤æ‹’ç»ï¼šé™¤å¿…éœ€ç«¯å£å¤–éƒ½å…³é—­
æœ€å°æƒé™ï¼šåªå¼€æ”¾å¿…è¦çš„æœåŠ¡å’Œç«¯å£
å¤šå±‚é˜²æŠ¤ï¼šç»“åˆå¤šç§å®‰å…¨å·¥å…·
æŒç»­ç›‘æ§ï¼šå®šæœŸæ£€æŸ¥æ—¥å¿—å’Œè¿æ¥çŠ¶æ€
```

### 8.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ“Š æ—¥å¸¸å®‰å…¨æ£€æŸ¥æ¸…å•**
- [ ] æ£€æŸ¥iptablesè§„åˆ™æ˜¯å¦ç”Ÿæ•ˆ
- [ ] æŸ¥çœ‹fail2banå°ç¦çŠ¶æ€  
- [ ] åˆ†æSSHç™»å½•æ—¥å¿—å¼‚å¸¸
- [ ] ç›‘æ§ç½‘ç»œè¿æ¥çŠ¶æ€
- [ ] éªŒè¯SSLè¯ä¹¦æœ‰æ•ˆæœŸ
- [ ] æ£€æŸ¥ç³»ç»ŸæœåŠ¡å¼€æ”¾ç«¯å£

**ğŸš€ åº”æ€¥å“åº”æµç¨‹**
```
å‘ç°æ”»å‡» â†’ æŸ¥çœ‹æ—¥å¿—ç¡®è®¤ â†’ å°ç¦æ”»å‡»IP â†’ åŠ å¼ºé˜²æŠ¤è§„åˆ™ â†’ æŒç»­ç›‘æ§
     â†“         â†“          â†“          â†“          â†“
  ç›‘æ§å‘Šè­¦   æ—¥å¿—åˆ†æ   iptables   æ›´æ–°è§„åˆ™   å®šæœŸæ£€æŸ¥
           fail2ban    tcpwrappers  é…ç½®ä¼˜åŒ–
```

**ğŸ’¡ å®‰å…¨æå‡å»ºè®®**
- **ä¿®æ”¹é»˜è®¤ç«¯å£**ï¼šSSHã€æ•°æ®åº“ç­‰æœåŠ¡ç«¯å£  
- **å¯ç”¨å¯†é’¥è®¤è¯**ï¼šç¦ç”¨å¯†ç ç™»å½•
- **å®šæœŸæ›´æ–°ç³»ç»Ÿ**ï¼šåŠæ—¶æ‰“è¡¥ä¸
- **å¤‡ä»½é…ç½®æ–‡ä»¶**ï¼šé˜²æ­¢è¯¯æ“ä½œ
- **è®¾ç½®ç›‘æ§å‘Šè­¦**ï¼šå¼‚å¸¸æƒ…å†µåŠæ—¶é€šçŸ¥

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- iptableså®ˆå¤§é—¨ï¼Œfail2banæŠ“åäºº
- tcpwrappersç®¡æœåŠ¡ï¼Œæ—¥å¿—åˆ†ææ‰¾ç—•è¿¹
- SSLåŠ å¯†ä¿æ•°æ®ï¼Œç›‘æ§æ£€æŸ¥ä¸èƒ½åœ
- å¤šå±‚é˜²æŠ¤å±‚å±‚è®¾ï¼Œå®‰å…¨è¿ç»´æ­¥æ­¥ç¨³