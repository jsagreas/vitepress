---
title: 4、磁盘使用监控命令
---
## 📚 目录

1. [磁盘监控基础概念](#1-磁盘监控基础概念)
2. [df命令详解](#2-df命令详解)
3. [du命令详解](#3-du命令详解)
4. [磁盘空间问题排查](#4-磁盘空间问题排查)
5. [inode资源监控](#5-inode资源监控)
6. [实用技巧与最佳实践](#6-实用技巧与最佳实践)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 💾 磁盘监控基础概念


### 1.1 为什么要监控磁盘使用情况


磁盘监控是Linux系统管理中**最重要的日常工作之一**。想象一下，磁盘就像你的钱包，你需要随时知道：
- 钱包里还有多少钱（磁盘剩余空间）
- 钱花到哪里去了（哪些目录占用空间大）
- 是否快要没钱了（空间不足预警）

**磁盘空间耗尽的后果**：
- 系统无法写入新文件
- 应用程序崩溃
- 日志无法记录
- 数据库操作失败

### 1.2 磁盘空间 vs inode资源


Linux文件系统有两种重要资源需要监控：

```
文件系统资源类型：
┌──────────────┬──────────────┐
│ 磁盘空间     │ inode数量    │
├──────────────┼──────────────┤
│ 存储文件内容 │ 存储文件信息 │
│ 以字节计算   │ 以个数计算   │
│ 大文件消耗多 │ 小文件消耗多 │
└──────────────┴──────────────┘
```

**通俗理解**：
- **磁盘空间**：就像仓库的存储面积，放大东西占地多
- **inode**：就像仓库的货架编号，每个物品都需要一个编号

### 1.3 常见磁盘监控场景


**日常监控场景**：
- 🏠 **个人桌面**：防止下载文件塞满硬盘
- 🖥️ **服务器运维**：监控日志文件增长
- 📊 **数据库服务器**：监控数据文件大小
- 🌐 **Web服务器**：监控上传文件存储

---

## 2. 📊 df命令详解


### 2.1 df命令基本概念


**df的含义**：`df` = `disk free`，显示文件系统的磁盘空间使用情况

**df命令的作用**：告诉你每个磁盘分区用了多少空间，还剩多少空间

```bash
# 最基本的df命令
df
```

### 2.2 df命令核心参数详解


#### 📋 df -h：人性化显示


```bash
df -h
```

**输出示例**：
```
文件系统        大小  已用  可用  使用% 挂载点
/dev/sda1       20G   15G   4.2G   79%   /
/dev/sda2       50G   32G   16G    67%   /home
tmpfs           2.0G  0     2.0G   0%    /tmp
```

**各列含义解释**：
- **文件系统**：实际的磁盘分区或存储设备
- **大小**：分区总容量
- **已用**：已经使用的空间
- **可用**：还能使用的空间  
- **使用%**：使用百分比（**重点关注指标**）
- **挂载点**：分区在目录树中的位置

> 💡 **新手提示**：`-h`参数会自动转换单位（K、M、G、T），比看一堆数字友好多了

#### 📈 df -i：inode使用统计


```bash
df -i
```

**输出示例**：
```
文件系统         Inodes   已用   可用  使用% 挂载点
/dev/sda1       1280000  45230  1234770   4%   /
/dev/sda2       3200000  156720 3043280   5%   /home
```

**inode统计的重要性**：
- 即使磁盘空间充足，inode用完了也无法创建新文件
- 小文件很多的系统容易出现inode不足

### 2.3 df命令实用技巧


**查看特定目录所在分区**：
```bash
df -h /var/log    # 查看日志目录所在分区使用情况
df -h .           # 查看当前目录所在分区
```

**监控脚本示例**：
```bash
# 简单的磁盘空间监控
df -h | awk '$5 > 80 {print "警告: "$1" 使用率达到 "$5}'
```

---

## 3. 📁 du命令详解


### 3.1 du命令基本概念


**du的含义**：`du` = `disk usage`，分析目录和文件的磁盘占用情况

**du与df的区别**：
```
df：看整个分区的使用情况（宏观视角）
du：看具体目录或文件占用多少空间（微观视角）

比喻：
df像查看银行账户总余额
du像查看每笔支出明细
```

### 3.2 du命令核心用法


#### 📋 du -sh：目录大小汇总


```bash
du -sh /var/log
```

**参数含义**：
- `-s`：`summarize`，只显示总计（不显示子目录详情）
- `-h`：`human-readable`，人性化显示单位

**输出示例**：
```
2.3G    /var/log
```

> 🎯 **实用场景**：快速了解某个目录总共占用多少空间

#### 📊 du -h：显示目录层级占用


```bash
du -h /var/log
```

**输出示例**：
```
120M    /var/log/nginx
850M    /var/log/mysql  
45M     /var/log/apache2
2.3G    /var/log
```

**用途**：找出目录下哪些子目录占用空间最大

#### 🔍 du常用组合技巧


**查找当前目录下最大的10个目录**：
```bash
du -sh * | sort -rh | head -10
```

**命令解析**：
- `du -sh *`：统计当前目录下所有项目的大小
- `sort -rh`：按大小逆序排列（从大到小）
- `head -10`：只显示前10个

**查找指定目录深度**：
```bash
du -h --max-depth=2 /var
```

---

## 4. 🔍 磁盘空间问题排查


### 4.1 磁盘空间不足的排查流程


**排查步骤图示**：
```
磁盘空间不足问题排查流程：

步骤1️⃣ 确认问题
   ↓
df -h 查看整体使用情况
   ↓
步骤2️⃣ 定位问题目录  
   ↓
du -sh /* 查看根目录各分区占用
   ↓
步骤3️⃣ 深入分析
   ↓
du -sh /var/* 逐层深入大目录
   ↓
步骤4️⃣ 找到具体文件
   ↓
find命令查找大文件
```

### 4.2 大文件查找技巧


#### 🔍 使用find命令查找大文件


**查找大于100M的文件**：
```bash
find /var -type f -size +100M -exec ls -lh {} \; | sort -k5 -rh
```

**命令解析**：
- `/var`：搜索路径
- `-type f`：只查找文件（不包括目录）  
- `-size +100M`：大于100M的文件
- `-exec ls -lh {} \;`：对找到的文件执行ls命令
- `sort -k5 -rh`：按第5列（文件大小）逆序排列

**查找最近7天修改的大文件**：
```bash
find /var -type f -mtime -7 -size +50M
```

### 4.3 日志文件处理策略


**安全清理日志文件**：
```bash
# 清空文件内容但保持文件存在（推荐）
> /var/log/large.log

# 或使用truncate命令
truncate -s 0 /var/log/large.log
```

> ⚠️ **重要提醒**：不要直接删除正在使用的日志文件，可能导致应用程序出错

**日志轮转配置示例**：
```bash
# 查看日志轮转配置
cat /etc/logrotate.conf
```

---

## 5. 🗂️ inode资源监控


### 5.1 什么是inode


**inode的通俗理解**：
- **inode**就像文件的"身份证号码"
- 每创建一个文件，就会用掉一个inode
- inode用完了，即使磁盘空间充足也无法创建新文件

**文件系统结构图示**：
```
Linux文件系统结构：
┌─────────────────┐
│   文件名        │ ← 人类可读的名称
├─────────────────┤  
│   inode编号     │ ← 系统内部标识
├─────────────────┤
│   inode信息     │ ← 文件元数据
│   - 权限        │
│   - 时间戳      │
│   - 大小        │
│   - 数据块指针  │
├─────────────────┤
│   数据块        │ ← 实际文件内容
└─────────────────┘
```

### 5.2 inode耗尽问题诊断


**检查inode使用情况**：
```bash
df -i
```

**典型的inode耗尽场景**：
- 大量小文件（如邮件、临时文件）
- 程序异常产生海量临时文件
- 缓存文件堆积

**查找inode消耗大户**：
```bash
# 统计目录下文件数量
find /var -type f | wc -l

# 查看各目录文件数量
for dir in /var/*; do
    echo -n "$dir: "
    find "$dir" -type f 2>/dev/null | wc -l
done
```

### 5.3 解决inode不足问题


**清理策略**：
1. **删除不必要的小文件**
2. **清理临时文件**：`/tmp`、`/var/tmp`
3. **清理缓存文件**：应用程序缓存目录
4. **配置自动清理脚本**

---

## 6. 🛠️ 实用技巧与最佳实践


### 6.1 磁盘使用率阈值监控


**设置监控阈值**：
```
磁盘使用率警戒线：
🟢 正常：< 70%    
🟡 注意：70-85%   
🔴 警告：85-95%   
🚨 危险：> 95%    
```

**简单监控脚本**：
```bash
#!/bin/bash
# 磁盘空间监控脚本
THRESHOLD=85

df -h | grep -vE '^Filesystem|tmpfs|cdrom' | awk '{ print $5 " " $6 }' | while read output;
do
    usage=$(echo $output | awk '{print $1}' | sed 's/%//g')
    partition=$(echo $output | awk '{print $2}')
    
    if [ $usage -ge $THRESHOLD ]; then
        echo "警告：$partition 分区使用率达到 $usage%"
    fi
done
```

### 6.2 定期清理策略


**建议的清理计划**：
```
每日清理：
- 临时文件 /tmp/*
- 应用日志轮转

每周清理：  
- 旧的日志文件
- 缓存文件清理

每月清理：
- 系统更新包缓存
- 用户垃圾文件
```

### 6.3 磁盘空间预警设置


**使用cron定时监控**：
```bash
# 编辑cron任务
crontab -e

# 添加每小时检查一次磁盘使用率
0 * * * * /path/to/disk_monitor.sh
```

**邮件预警示例**：
```bash
# 磁盘使用率超过阈值时发送邮件
if [ $usage -ge $THRESHOLD ]; then
    echo "磁盘空间不足警告" | mail -s "服务器磁盘告警" admin@company.com
fi
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心命令


```
🔸 df -h：查看磁盘空间使用情况（人性化显示）
🔸 df -i：查看inode使用情况  
🔸 du -sh：查看目录大小汇总
🔸 du -h：查看目录层级占用详情
🔸 find查找大文件：定位空间占用大户
```

### 7.2 关键理解要点


**🔹 df与du的使用场景**：
```
使用df的情况：
- 查看整个系统磁盘使用状况
- 监控各个分区使用率
- 检查inode资源情况

使用du的情况：  
- 分析具体目录占用空间
- 找出占用空间最大的目录
- 清理前确定删除目标
```

**🔹 磁盘空间与inode的关系**：
```
两种资源独立计算：
- 磁盘空间充足，inode可能不足
- inode充足，磁盘空间可能不足  
- 需要同时监控两种资源
```

### 7.3 实际应用价值


**日常运维场景**：
- **空间预警**：设置阈值，提前发现问题
- **问题定位**：快速找到占用空间的罪魁祸首
- **容量规划**：了解各目录增长趋势
- **系统优化**：识别可清理的无用文件

**故障排查流程**：
```
故障现象：磁盘空间不足
   ↓
df -h 确认问题分区
   ↓  
du -sh /* 定位大目录
   ↓
du -sh /var/* 逐层深入
   ↓
find查找大文件
   ↓
制定清理策略
   ↓
执行清理操作
```

### 7.4 最佳实践建议


**🔹 监控策略**：
- 建立定期检查机制
- 设置合理的预警阈值  
- 自动化监控脚本部署
- 及时响应告警信息

**🔹 预防措施**：
- 配置日志轮转策略
- 定期清理临时文件
- 监控应用程序文件增长
- 规划磁盘容量扩展

**核心记忆**：
- df看分区整体，du看目录细节
- 磁盘空间和inode都要监控  
- 预防胜于治疗，监控重于清理
- 找到大文件是解决问题的关键