---
title: 8、综合系统监控命令
---
## 📚 目录

1. [系统监控命令概述](#1-系统监控命令概述)
2. [vmstat系统整体性能统计](#2-vmstat系统整体性能统计)
3. [sar系统活动报告工具](#3-sar系统活动报告工具)
4. [dstat多种资源统计组合](#4-dstat多种资源统计组合)
5. [系统瓶颈综合诊断方法](#5-系统瓶颈综合诊断方法)
6. [监控数据解读与分析](#6-监控数据解读与分析)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔍 系统监控命令概述


### 1.1 什么是系统监控


**监控的本质**：就像给汽车装了仪表盘，让你随时知道引擎转速、油量、温度等关键指标。系统监控就是给Linux装仪表盘，实时查看CPU、内存、磁盘、网络的使用情况。

> 💡 **形象比喻**：如果说Linux系统是一座繁忙的工厂，那么监控命令就是工厂的监控室，通过各种仪表和屏幕实时观察生产线的运行状态

### 1.2 为什么需要监控


**解决的问题**：
- 🔴 **性能问题**：系统跑得慢，到底哪里出了问题？
- 🟡 **资源瓶颈**：CPU满了？内存不够？磁盘IO慢？
- 🟢 **趋势分析**：系统负载是在增加还是减少？
- ⚠️ **故障预警**：问题爆发前能提前发现征兆

### 1.3 监控命令分类对比


| 命令类型 | **主要用途** | **监控范围** | **适用场景** | **难度等级** |
|---------|------------|-------------|-------------|-------------|
| `vmstat` | 整体性能概览 | CPU+内存+IO | 快速诊断系统状态 | ⭐⭐ |
| `sar` | 详细历史分析 | 全面系统活动 | 深入分析+报告 | ⭐⭐⭐ |
| `dstat` | 实时综合监控 | 多资源组合 | 实时观察+定制 | ⭐⭐ |

---

## 2. 📊 vmstat系统整体性能统计


### 2.1 vmstat是什么


**通俗解释**：vmstat就像系统的"体检报告"，一次性告诉你CPU忙不忙、内存够不够、磁盘读写快不快。名字虽然叫"虚拟内存统计"，但实际上是个全能监控工具。

> 🔸 **记忆技巧**：vm = Virtual Memory（虚拟内存），stat = Statistics（统计）

### 2.2 基本使用方法


```bash
# 最简单的使用 - 显示当前系统状态
vmstat

# 每2秒显示一次，共显示5次
vmstat 2 5

# 持续每秒显示一次
vmstat 1
```

### 2.3 输出结果解读


**标准输出示例**：
```
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 2  0      0 1024000  52000 256000    0    0    10    5  100  200 10  2 85  3  0
```

**字段含义详解**：

#### 🏃 **procs（进程状态）**

- **r（running）**：正在运行或等待CPU的进程数
  - 理想值：≤ CPU核心数
  - 过高表示：CPU成为瓶颈
- **b（blocked）**：等待IO完成的进程数
  - 理想值：接近0
  - 过高表示：IO成为瓶颈

#### 💾 **memory（内存使用）**

```
系统内存分布图：
┌─────────────────────────────────┐
│  已用内存  │  空闲内存(free)    │
├───────────┼────────────────────┤
│  缓冲区   │   缓存区(cache)    │
│ (buff)    │                   │
└─────────────────────────────────┘
```
- **swpd**：使用的虚拟内存量（KB）
- **free**：空闲内存量（KB）
- **buff**：用作缓冲区的内存（KB）
- **cache**：用作缓存的内存（KB）

#### 🔄 **swap（交换分区）**

- **si（swap in）**：从磁盘读入交换分区的数据量
- **so（swap out）**：写入磁盘交换分区的数据量
- ⚠️ **注意**：这两个值不为0说明内存不足

#### 💿 **io（输入输出）**

- **bi（block in）**：每秒从块设备读取的数据块数
- **bo（block out）**：每秒写入块设备的数据块数

#### 🖥️ **system（系统）**

- **in（interrupts）**：每秒的中断次数
- **cs（context switch）**：每秒的上下文切换次数

#### ⚡ **cpu（CPU使用率）**

```
CPU时间分配图：
User Time    System Time    Idle Time    Wait Time    Steal Time
    │            │             │            │            │
 用户程序      内核操作       空闲        等待IO       虚拟化损耗
    │            │             │            │            │
   us%          sy%           id%          wa%          st%
```
- **us**：用户进程CPU使用率
- **sy**：系统进程CPU使用率
- **id**：CPU空闲率
- **wa**：等待IO的CPU时间比例
- **st**：被虚拟化偷走的CPU时间

### 2.4 实际使用场景


**场景1：系统响应慢**
```bash
# 每秒检查一次系统状态
vmstat 1

# 关注指标：
# - r > CPU核心数 → CPU瓶颈
# - wa > 20% → IO瓶颈  
# - si/so > 0 → 内存不足
```

**场景2：定期健康检查**
```bash
# 每5分钟检查一次，检查12次（1小时）
vmstat 300 12
```

---

## 3. 📈 sar系统活动报告工具


### 3.1 sar是什么


**通俗解释**：sar就像系统的"行车记录仪"，不仅能看到现在的状态，还能回放历史记录。它是System Activity Reporter的缩写，专门收集、报告和保存系统活动信息。

> 💡 **记忆方法**：SAR = **S**ystem **A**ctivity **R**eporter（系统活动报告器）

### 3.2 sar的核心优势


**与其他监控工具的区别**：
- ✅ **历史数据**：可以查看过去的系统状态
- ✅ **自动收集**：系统自动定期收集数据
- ✅ **详细分类**：针对不同资源有专门的报告
- ✅ **报告格式**：生成易读的分析报告

### 3.3 基本使用语法


```bash
# 基本格式
sar [选项] [间隔] [次数]

# 查看CPU使用情况
sar -u 1 5

# 查看内存使用情况  
sar -r 1 5

# 查看IO统计
sar -b 1 5
```

### 3.4 主要功能选项详解


#### 🖥️ **CPU监控（-u选项）**


```bash
# 显示CPU使用率
sar -u 2 3
```

**输出示例**：
```
02:30:00 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle
02:30:02 PM     all      8.50      0.00      2.25      1.75      0.00     87.50
02:30:04 PM     all     10.25      0.00      2.75      0.50      0.00     86.50
Average:        all      9.38      0.00      2.50      1.13      0.00     87.00
```

**字段含义**：
- **%user**：用户程序使用CPU的百分比
- **%system**：系统内核使用CPU的百分比  
- **%iowait**：CPU等待IO操作的百分比
- **%idle**：CPU空闲百分比

#### 💾 **内存监控（-r选项）**


```bash
# 显示内存使用统计
sar -r 2 3
```

**关键指标**：
- **kbmemfree**：空闲内存量（KB）
- **kbmemused**：已用内存量（KB）
- **%memused**：内存使用率百分比
- **kbbuffers**：缓冲区内存量
- **kbcached**：缓存内存量

#### 💿 **IO监控（-b选项）**


```bash
# 显示IO传输统计
sar -b 2 3
```

**关键指标**：
- **tps**：每秒传输数（transfers per second）
- **rtps**：每秒读取传输数
- **wtps**：每秒写入传输数
- **bread/s**：每秒读取的块数
- **bwrtn/s**：每秒写入的块数

### 3.5 历史数据查看


**查看历史记录**：
```bash
# 查看今天的CPU使用历史
sar -u

# 查看指定日期的数据（日期格式：DD）
sar -u -f /var/log/sysstat/saDD

# 查看昨天的数据
sar -u -f /var/log/sysstat/sa$(date -d yesterday +%d)
```

> 📝 **重要说明**：sar的历史数据通常存储在`/var/log/sysstat/`目录下

### 3.6 生成报告


**综合报告生成**：
```bash
# 生成全面的系统报告
sar -A > system_report.txt

# 生成特定时间段的报告
sar -u -s 14:00:00 -e 16:00:00
```

---

## 4. 🎯 dstat多种资源统计组合


### 4.1 dstat是什么


**通俗解释**：dstat就像是监控命令中的"瑞士军刀"，把vmstat、iostat、netstat等多个工具的功能整合到一起，还加上了彩色显示，让数据更直观易读。

> 🌟 **特色**：dstat = **d**ata **stat**istics，数据统计的意思，最大特点是**彩色显示**和**高度可定制**

### 4.2 dstat的优势


**相比其他工具的优点**：
- 🎨 **彩色显示**：不同类型数据用不同颜色区分
- 🔧 **高度可定制**：可以选择显示哪些指标
- 📊 **实时更新**：数据实时刷新，直观展示变化
- 🔄 **多合一**：一个命令替代多个监控工具

### 4.3 基本使用方法


```bash
# 安装dstat（如果系统没有）
# CentOS/RHEL: yum install dstat
# Ubuntu/Debian: apt-get install dstat

# 基本使用
dstat

# 每2秒更新一次
dstat 2

# 显示10次后停止
dstat 1 10
```

### 4.4 常用组合选项


#### 🔥 **经典组合**


```bash
# CPU、内存、网络、磁盘综合监控
dstat -cdngy

# 详细的CPU和内存监控
dstat -cm --top-cpu --top-mem
```

**选项含义**：
- **-c**：CPU使用率
- **-d**：磁盘读写
- **-n**：网络收发
- **-g**：页面统计
- **-y**：系统统计
- **-m**：内存使用

#### 📊 **输出示例解读**


```
----total-cpu-usage---- -dsk/total- -net/total- ---paging-- ---system--
usr sys idl wai hiq siq| read  writ| recv  send|  in   out | int   csw
  8   2  88   2   0   0| 1.2M  890k|   0     0 |   0     0 | 890  1.2k
 12   3  82   3   0   0| 890k  1.2M| 234k  123k|   0     0 | 1.2k  1.8k
```

**彩色含义**：
- 🟢 **绿色**：正常范围内的数值
- 🟡 **黄色**：需要注意的数值
- 🔴 **红色**：可能有问题的数值

### 4.5 高级功能


#### 🔍 **进程监控**


```bash
# 显示CPU使用最高的进程
dstat --top-cpu

# 显示内存使用最高的进程
dstat --top-mem

# 显示IO最高的进程
dstat --top-io
```

#### 📈 **插件扩展**


```bash
# 查看所有可用插件
dstat --list

# 使用特定插件
dstat --mysql5-conn --mysql5-io
```

### 4.6 实际应用场景


**场景1：服务器性能实时监控**
```bash
# 适合运维人员的全面监控
dstat -cdngy 5
```

**场景2：问题诊断**
```bash
# 发现CPU和内存占用高的进程
dstat -cm --top-cpu --top-mem 2
```

**场景3：网络流量监控**
```bash
# 专门监控网络流量
dstat -n 1
```

---

## 5. 🔧 系统瓶颈综合诊断方法


### 5.1 诊断思路流程


```
系统问题诊断流程：
    系统响应慢/性能差
           ↓
    快速检查(vmstat)
           ↓
     ┌─────┴─────┐
     ↓           ↓
  CPU瓶颈?    内存瓶颈?
     ↓           ↓
  详细分析     详细分析
   (sar-u)     (sar-r)
     ↓           ↓
    IO瓶颈?    网络瓶颈?
     ↓           ↓
  详细分析     详细分析
   (sar-b)     (dstat-n)
     ↓
   综合诊断
     ↓
   制定方案
```

### 5.2 CPU瓶颈诊断


**🔴 判断标准**：
- vmstat中 `r` > CPU核心数
- CPU使用率持续 > 80%
- `wa`（等待IO）< 10%（排除IO瓶颈）

**诊断步骤**：
```bash
# 1. 快速检查CPU状态
vmstat 1 5

# 2. 详细分析CPU使用
sar -u 1 10

# 3. 找出占用CPU最高的进程
dstat --top-cpu 2 10
```

> ⚠️ **注意区分**：高CPU使用率有两种情况
> - **计算密集型**：%user高，正常现象
> - **系统问题**：%system高，可能有问题

### 5.3 内存瓶颈诊断


**🔴 判断标准**：
- 可用内存 < 总内存的10%
- swap使用率 > 0
- vmstat中 `si`、`so` > 0

**诊断步骤**：
```bash
# 1. 检查内存整体状况
vmstat 1 5

# 2. 详细内存分析
sar -r 1 10

# 3. 找出内存占用最高的进程
dstat --top-mem 2 10
```

**内存使用优先级**：
```
内存分配优先级：
应用程序内存 > 缓存内存 > 空闲内存
     ↑            ↑         ↑
   不可释放     可以释放    立即可用
```

### 5.4 IO瓶颈诊断


**🔴 判断标准**：
- vmstat中 `wa` > 20%
- `b`（阻塞进程数）> 0
- IO读写量持续很高

**诊断步骤**：
```bash
# 1. 检查IO等待
vmstat 1 5

# 2. 详细IO分析
sar -b 1 10

# 3. 找出IO最高的进程
dstat --top-io 2 10
```

### 5.5 综合诊断实例


**场景：系统响应变慢**

**Step 1：快速诊断**
```bash
vmstat 1 3
# 输出：r=8, b=2, wa=25%
# 分析：进程排队多，IO等待高 → 可能是IO瓶颈
```

**Step 2：确认IO问题**
```bash
sar -b 1 5
# 输出：rtps=150, wtps=80, bread/s=3000
# 分析：读写频繁，确认是IO瓶颈
```

**Step 3：找出问题进程**
```bash
dstat --top-io 2 5
# 输出：mysql进程IO最高
# 分析：数据库查询导致大量磁盘读写
```

---

## 6. 📊 监控数据解读与分析


### 6.1 数据解读原则


#### 🎯 **基准线原则**

> 💡 **关键理念**：没有绝对的"好"与"坏"，只有相对于基准的"正常"与"异常"

**建立基准的方法**：
- 📊 记录系统正常运行时的各项指标
- 📈 观察一段时间内的数据波动范围
- 📋 建立告警阈值（通常是基准±20%）

#### ⏱️ **趋势分析原则**

- **短期波动**：1-5分钟内的变化，通常是正常的
- **中期趋势**：30分钟-2小时，需要关注
- **长期趋势**：一天以上，需要调整策略

### 6.2 关键指标阈值参考


| **指标类型** | **正常范围** | **注意阈值** | **警告阈值** |
|-------------|-------------|-------------|-------------|
| CPU使用率 | < 70% | 70-85% | > 85% |
| 内存使用率 | < 80% | 80-90% | > 90% |
| IO等待(wa) | < 10% | 10-20% | > 20% |
| 负载平均值 | < CPU核心数 | CPU核心数×1.5 | CPU核心数×2 |
| Swap使用 | 0 | > 0 | 持续使用 |

> ⚠️ **重要提醒**：这些只是参考值，实际阈值需要根据具体业务场景调整

### 6.3 数据分析方法


#### 📈 **时间序列分析**


**观察模式**：
```bash
# 收集24小时的数据
sar -u 900 96 > cpu_24h.log

# 分析规律：
# - 工作时间(9:00-18:00)：CPU使用率较高
# - 夜间时间(22:00-6:00)：CPU使用率较低  
# - 备份时间(2:00-4:00)：IO活动增加
```

#### 🔍 **关联分析**


**分析不同指标间的关系**：
- CPU高 + IO等待低 → 计算密集型任务
- CPU低 + IO等待高 → IO密集型任务  
- 内存不足 + Swap使用 → 需要增加内存
- 网络流量高 + CPU使用正常 → 网络应用

### 6.4 性能数据采集策略


#### 📋 **采集频率建议**


| **监控类型** | **采集间隔** | **保存时长** | **适用场景** |
|-------------|-------------|-------------|-------------|
| 实时监控 | 1-5秒 | 1-2小时 | 问题诊断 |
| 日常监控 | 1-5分钟 | 1-7天 | 运维管理 |
| 历史分析 | 15-30分钟 | 1-12个月 | 容量规划 |

#### 💾 **数据存储与管理**


```bash
# 创建监控脚本目录
mkdir -p /opt/monitoring/logs

# CPU监控脚本示例
#!/bin/bash
# 每5分钟记录一次系统状态
while true; do
    echo "$(date): $(vmstat 1 1 | tail -1)" >> /opt/monitoring/logs/vmstat.log
    sleep 300
done
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心概念


```
🔸 vmstat：系统整体性能快速诊断工具
🔸 sar：系统活动历史记录和详细分析工具  
🔸 dstat：彩色多合一实时监控工具
🔸 瓶颈诊断：CPU、内存、IO、网络四大方面
🔸 数据解读：建立基准、趋势分析、关联分析
```

### 7.2 实用技能检查清单


**⭐ 基础技能**
- [ ] 能够使用vmstat快速判断系统状态
- [ ] 理解vmstat输出中各个字段的含义
- [ ] 会使用sar查看历史系统活动数据
- [ ] 能够识别CPU、内存、IO瓶颈的典型特征

**⭐⭐ 进阶技能**
- [ ] 熟练使用dstat进行综合监控
- [ ] 能够分析监控数据找出性能问题
- [ ] 掌握系统瓶颈的综合诊断方法
- [ ] 会制定合理的监控数据采集策略

**⭐⭐⭐ 高级技能**
- [ ] 能够建立系统性能基准和告警机制
- [ ] 掌握长期趋势分析和容量规划
- [ ] 会编写自动化监控脚本
- [ ] 能够根据监控数据制定优化方案

### 7.3 常用命令快速参考


```bash
# 快速系统检查
vmstat 1 5

# 详细CPU分析  
sar -u 1 10

# 内存使用分析
sar -r 1 10

# IO性能分析
sar -b 1 10

# 综合实时监控
dstat -cdngy 2

# 找出问题进程
dstat --top-cpu --top-mem --top-io
```

### 7.4 故障诊断思维导图


```
系统性能问题
    ↓
用vmstat快速判断
    ↓
┌─────┬─────┬─────┐
↓     ↓     ↓     ↓
CPU   内存   IO   网络
高?   不足?  慢?  堵塞?
↓     ↓     ↓     ↓
用    用    用    用
sar   sar   sar   dstat
-u    -r    -b    -n
↓     ↓     ↓     ↓
找出具体原因和解决方案
```

### 7.5 学习建议


**🚀 实践方法**：
1. **日常观察**：在正常业务时间定期运行监控命令，熟悉正常状态的数据
2. **模拟测试**：用压测工具制造负载，观察各监控工具的反应
3. **问题记录**：遇到性能问题时记录监控数据和解决方法
4. **脚本自动化**：将常用的监控组合写成脚本，提高效率

> 💡 **记忆口诀**
> - vmstat看概况，sar查历史详
> - dstat彩色显，问题诊断强
> - CPU内存IO，网络四方向
> - 建立好基准，趋势要分析

**核心理解**：系统监控不是为了监控而监控，而是要通过数据发现问题、分析问题、解决问题。掌握这些工具只是第一步，真正的能力在于通过监控数据做出正确的判断和决策。