---
title: 15ã€ç³»ç»Ÿèµ„æºä½¿ç”¨æŸ¥çœ‹
---
## ğŸ“š ç›®å½•

1. [ç³»ç»Ÿèµ„æºé™åˆ¶æ¦‚è¿°](#1-ç³»ç»Ÿèµ„æºé™åˆ¶æ¦‚è¿°)
2. [ulimitèµ„æºé™åˆ¶æŸ¥çœ‹](#2-ulimitèµ„æºé™åˆ¶æŸ¥çœ‹)
3. [procæ–‡ä»¶ç³»ç»Ÿé™åˆ¶æŸ¥çœ‹](#3-procæ–‡ä»¶ç³»ç»Ÿé™åˆ¶æŸ¥çœ‹)
4. [limits.confé…ç½®æ–‡ä»¶](#4-limitsconfé…ç½®æ–‡ä»¶)
5. [è¿›ç¨‹èµ„æºé™åˆ¶æŸ¥çœ‹](#5-è¿›ç¨‹èµ„æºé™åˆ¶æŸ¥çœ‹)
6. [ç³»ç»Ÿè°ƒç”¨ä¸é«˜çº§å·¥å…·](#6-ç³»ç»Ÿè°ƒç”¨ä¸é«˜çº§å·¥å…·)
7. [cgroupsèµ„æºæ§åˆ¶](#7-cgroupsèµ„æºæ§åˆ¶)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ç³»ç»Ÿèµ„æºé™åˆ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ç³»ç»Ÿèµ„æºé™åˆ¶


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
ç³»ç»Ÿèµ„æºé™åˆ¶å°±åƒç»™æ¯ä¸ªç”¨æˆ·å’Œè¿›ç¨‹è®¾å®šçš„"ä½¿ç”¨è§„åˆ™"ï¼Œé˜²æ­¢æŸä¸ªç¨‹åºæˆ–ç”¨æˆ·å ç”¨å¤ªå¤šç³»ç»Ÿèµ„æºï¼Œå½±å“å…¶ä»–ç¨‹åºçš„æ­£å¸¸è¿è¡Œã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
å°±åƒå…¬å…±å›¾ä¹¦é¦†çš„å€Ÿä¹¦è§„å®šï¼š
â€¢ æ¯äººæœ€å¤šå€Ÿ10æœ¬ä¹¦ï¼ˆæ–‡ä»¶æ‰“å¼€æ•°é™åˆ¶ï¼‰
â€¢ æ¯æ¬¡å€Ÿé˜…ä¸è¶…è¿‡30å¤©ï¼ˆæ—¶é—´é™åˆ¶ï¼‰
â€¢ å¤å°çº¸å¼ ä¸è¶…è¿‡100é¡µï¼ˆå†…å­˜ä½¿ç”¨é™åˆ¶ï¼‰
```

**âš¡ ä¸ºä»€ä¹ˆéœ€è¦èµ„æºé™åˆ¶**
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šé˜²æ­¢å•ä¸ªç¨‹åºè€—å°½æ‰€æœ‰èµ„æº
- **å…¬å¹³æ€§**ï¼šç¡®ä¿å¤šç”¨æˆ·ç¯å¢ƒä¸‹èµ„æºåˆç†åˆ†é…
- **å®‰å…¨æ€§**ï¼šé™åˆ¶æ¶æ„ç¨‹åºçš„èµ„æºæ¶ˆè€—
- **æ€§èƒ½ä¿éšœ**ï¼šç»´æŒç³»ç»Ÿæ•´ä½“å“åº”é€Ÿåº¦

### 1.2 èµ„æºé™åˆ¶çš„ç±»å‹


| èµ„æºç±»å‹ | **è¯´æ˜** | **å½±å“èŒƒå›´** |
|---------|---------|-------------|
| ğŸ—‚ï¸ **æ–‡ä»¶ç›¸å…³** | `æ‰“å¼€æ–‡ä»¶æ•°ã€æ–‡ä»¶å¤§å°` | `ç¨‹åºè¿è¡Œã€æ•°æ®å¤„ç†` |
| ğŸ’¾ **å†…å­˜ç›¸å…³** | `è™šæ‹Ÿå†…å­˜ã€ç‰©ç†å†…å­˜` | `ç¨‹åºæ€§èƒ½ã€ç³»ç»Ÿç¨³å®š` |
| â° **æ—¶é—´ç›¸å…³** | `CPUæ—¶é—´ã€è¿è¡Œæ—¶é—´` | `ç¨‹åºæ‰§è¡Œæ—¶é—´` |
| ğŸ”¢ **æ•°é‡ç›¸å…³** | `è¿›ç¨‹æ•°ã€ç”¨æˆ·æ•°` | `å¹¶å‘èƒ½åŠ›` |

---

## 2. âš™ï¸ ulimitèµ„æºé™åˆ¶æŸ¥çœ‹


### 2.1 ulimitåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯ulimit**
ulimitæ˜¯Linuxç³»ç»Ÿä¸­æ§åˆ¶shellè¿›ç¨‹åŠå…¶å­è¿›ç¨‹èµ„æºä½¿ç”¨çš„å†…ç½®å‘½ä»¤ã€‚å®ƒå°±åƒæ˜¯ç»™æ¯ä¸ªç”¨æˆ·è®¾ç½®çš„"èµ„æºä½¿ç”¨é¢åº¦"ã€‚

```
ç®€å•ç†è§£ï¼š
ulimit = user limitï¼ˆç”¨æˆ·é™åˆ¶ï¼‰
ä½œç”¨ï¼šå‘Šè¯‰ç³»ç»Ÿè¿™ä¸ªç”¨æˆ·æœ€å¤šèƒ½ç”¨å¤šå°‘èµ„æº
```

### 2.2 æŸ¥çœ‹å½“å‰èµ„æºé™åˆ¶


**ğŸ“Š åŸºæœ¬æŸ¥çœ‹å‘½ä»¤**

```bash
# æŸ¥çœ‹æ‰€æœ‰èµ„æºé™åˆ¶
ulimit -a

# æŸ¥çœ‹ç‰¹å®šèµ„æºé™åˆ¶
ulimit -n    # æ–‡ä»¶æè¿°ç¬¦æ•°é‡
ulimit -u    # æœ€å¤§ç”¨æˆ·è¿›ç¨‹æ•°
ulimit -f    # æ–‡ä»¶å¤§å°é™åˆ¶
ulimit -t    # CPUæ—¶é—´é™åˆ¶
```

**ğŸ’¡ è¾“å‡ºç»“æœè§£è¯»**
```
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 15663
max locked memory       (kbytes, -l) 16384
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1024
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 15663
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
```

### 2.3 é‡è¦å‚æ•°è¯¦è§£


**ğŸ—‚ï¸ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶(-n)**
```bash
ulimit -n
# è¾“å‡º: 1024

# å«ä¹‰ï¼šæ¯ä¸ªè¿›ç¨‹æœ€å¤šèƒ½åŒæ—¶æ‰“å¼€1024ä¸ªæ–‡ä»¶
# å½±å“ï¼šç½‘ç»œè¿æ¥ã€æ–‡ä»¶æ“ä½œã€æ•°æ®åº“è¿æ¥ç­‰
```

**ğŸ‘¥ ç”¨æˆ·è¿›ç¨‹æ•°é™åˆ¶(-u)**
```bash
ulimit -u  
# è¾“å‡º: 15663

# å«ä¹‰ï¼šå½“å‰ç”¨æˆ·æœ€å¤šèƒ½åˆ›å»º15663ä¸ªè¿›ç¨‹
# å½±å“ï¼šå¹¶å‘ç¨‹åºã€å¤šè¿›ç¨‹åº”ç”¨
```

**ğŸ’¾ å†…å­˜ç›¸å…³é™åˆ¶**
```bash
ulimit -v    # è™šæ‹Ÿå†…å­˜
ulimit -m    # ç‰©ç†å†…å­˜
ulimit -s    # æ ˆå¤§å°

# æ ˆå¤§å°ç¤ºä¾‹
ulimit -s
# è¾“å‡º: 8192 (8MB)
# å«ä¹‰ï¼šæ¯ä¸ªè¿›ç¨‹çš„æ ˆç©ºé—´æœ€å¤§8MB
```

### 2.4 ä¸´æ—¶ä¿®æ”¹é™åˆ¶


**âš ï¸ é‡è¦æç¤ºï¼šä»…å¯¹å½“å‰shellæœ‰æ•ˆ**

```bash
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
ulimit -n 2048

# è®¾ç½®æœ€å¤§è¿›ç¨‹æ•°
ulimit -u 20000

# è®¾ç½®æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆä»¥å—ä¸ºå•ä½ï¼Œ1å—=512å­—èŠ‚ï¼‰
ulimit -f 102400    # é™åˆ¶æ–‡ä»¶æœ€å¤§50MB
```

**ğŸ“ ä¿®æ”¹æ–¹å¼å¯¹æ¯”**

```
è½¯é™åˆ¶ vs ç¡¬é™åˆ¶ï¼š
ulimit -Sn 1024    # è®¾ç½®è½¯é™åˆ¶ï¼ˆå¯ä»¥ä¸´æ—¶è¶…è¿‡ï¼‰
ulimit -Hn 4096    # è®¾ç½®ç¡¬é™åˆ¶ï¼ˆç»å¯¹ä¸èƒ½è¶…è¿‡ï¼‰

æŸ¥çœ‹åŒºåˆ«ï¼š
ulimit -Sn    # æŸ¥çœ‹è½¯é™åˆ¶
ulimit -Hn    # æŸ¥çœ‹ç¡¬é™åˆ¶
```

---

## 3. ğŸ“ procæ–‡ä»¶ç³»ç»Ÿé™åˆ¶æŸ¥çœ‹


### 3.1 /proc/sys/fsæ–‡ä»¶ç³»ç»Ÿé™åˆ¶


**ğŸ”¸ ä»€ä¹ˆæ˜¯/proc/sys/fs**
è¿™æ˜¯Linuxå†…æ ¸æš´éœ²çš„æ–‡ä»¶ç³»ç»Ÿå‚æ•°æ¥å£ï¼ŒåŒ…å«äº†æ•´ä¸ªç³»ç»Ÿçº§åˆ«çš„æ–‡ä»¶æ“ä½œé™åˆ¶ã€‚

**ğŸ“Š ä¸»è¦å‚æ•°æŸ¥çœ‹**

```bash
# ç³»ç»Ÿçº§æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
cat /proc/sys/fs/file-max
# è¾“å‡º: 9223372036854775807 (ç³»ç»Ÿæœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°)

# å½“å‰æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°
cat /proc/sys/fs/file-nr  
# è¾“å‡º: 1568    0    9223372036854775807
# å«ä¹‰: å·²åˆ†é…  å·²é‡Šæ”¾  æœ€å¤§å€¼

# inodeç›¸å…³é™åˆ¶
cat /proc/sys/fs/inode-max
cat /proc/sys/fs/inode-nr
```

**ğŸ’¡ å‚æ•°å«ä¹‰è§£é‡Š**

```
file-max: æ•´ä¸ªç³»ç»Ÿèƒ½åŒæ—¶æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æ•°
file-nr: å½“å‰æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨æƒ…å†µ
  ç¬¬ä¸€ä¸ªæ•°å­—: å½“å‰å·²åˆ†é…çš„æ–‡ä»¶æè¿°ç¬¦æ•°
  ç¬¬äºŒä¸ªæ•°å­—: å·²é‡Šæ”¾ä½†æœªå›æ”¶çš„æ–‡ä»¶æè¿°ç¬¦æ•°  
  ç¬¬ä¸‰ä¸ªæ•°å­—: æœ€å¤§é™åˆ¶æ•°
```

### 3.2 /proc/sys/kernelå†…æ ¸å‚æ•°


**ğŸ”¸ è¿›ç¨‹ç›¸å…³å‚æ•°**

```bash
# ç³»ç»Ÿæœ€å¤§è¿›ç¨‹æ•°
cat /proc/sys/kernel/pid_max
# è¾“å‡º: 32768

# å½“å‰è¿è¡Œè¿›ç¨‹æ•°ç»Ÿè®¡
cat /proc/sys/kernel/threads-max
# è¾“å‡º: 62654

# ç³»ç»Ÿè´Ÿè½½ç›¸å…³
cat /proc/loadavg
# è¾“å‡º: 0.15 0.08 0.05 1/239 1456
# å«ä¹‰: 1åˆ†é’Ÿ 5åˆ†é’Ÿ 15åˆ†é’Ÿå¹³å‡è´Ÿè½½ è¿è¡Œè¿›ç¨‹/æ€»è¿›ç¨‹ æœ€æ–°PID
```

**âš¡ å†…å­˜ç›¸å…³å‚æ•°**

```bash
# å†…å­˜è¿‡åº¦åˆ†é…ç­–ç•¥
cat /proc/sys/vm/overcommit_memory
# 0: å¯å‘å¼è¿‡åº¦åˆ†é…ï¼ˆé»˜è®¤ï¼‰
# 1: æ€»æ˜¯è¿‡åº¦åˆ†é…
# 2: ä¸¥æ ¼åˆ†é…

# ç³»ç»Ÿå†…å­˜ä¿¡æ¯
cat /proc/meminfo | head -10
```

**ğŸ”§ ç½‘ç»œç›¸å…³å‚æ•°**

```bash
# TCPè¿æ¥ç›¸å…³
cat /proc/sys/net/core/somaxconn    # ç›‘å¬é˜Ÿåˆ—æœ€å¤§é•¿åº¦
cat /proc/sys/net/ipv4/ip_local_port_range    # æœ¬åœ°ç«¯å£èŒƒå›´
```

### 3.3 å®æ—¶ç›‘æ§æŠ€å·§


**ğŸ“Š åˆ›å»ºç›‘æ§è„šæœ¬**

```bash
# åˆ›å»ºç®€å•çš„èµ„æºç›‘æ§
cat > resource_monitor.sh << 'EOF'
#!/bin/bash
echo "=== ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ ==="
echo "å½“å‰æ—¶é—´: $(date)"
echo "æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨: $(cat /proc/sys/fs/file-nr | awk '{print $1"/"$3}')"
echo "è¿›ç¨‹æ•°: $(ps aux | wc -l)/$(($(cat /proc/sys/kernel/pid_max)))"
echo "å†…å­˜ä½¿ç”¨: $(free -h | grep '^Mem' | awk '{print $3"/"$2}')"
echo "è´Ÿè½½: $(cat /proc/loadavg | awk '{print $1,$2,$3}')"
echo
EOF

chmod +x resource_monitor.sh
```

---

## 4. âš™ï¸ limits.confé…ç½®æ–‡ä»¶


### 4.1 limits.confåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯limits.conf**
è¿™æ˜¯PAMï¼ˆå¯æ’æ‹”è®¤è¯æ¨¡å—ï¼‰çš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºè®¾ç½®ç”¨æˆ·ç™»å½•æ—¶çš„èµ„æºé™åˆ¶ã€‚å®ƒå°±åƒæ˜¯"ç”¨æˆ·èµ„æºä½¿ç”¨åˆåŒ"ã€‚

```
æ–‡ä»¶ä½ç½®: /etc/security/limits.conf
ä½œç”¨: ä¸ºä¸åŒç”¨æˆ·/ç»„è®¾ç½®ä¸åŒçš„èµ„æºé™åˆ¶
ç”Ÿæ•ˆæ—¶æœº: ç”¨æˆ·ç™»å½•æ—¶
```

### 4.2 é…ç½®æ–‡ä»¶æ ¼å¼


**ğŸ“ åŸºæœ¬è¯­æ³•ç»“æ„**

```
# é…ç½®æ ¼å¼ï¼š
# <domain> <type> <item> <value>

ç¤ºä¾‹é…ç½®ï¼š
root     soft    nofile    65536
root     hard    nofile    65536
@mysql   soft    nproc     2048
@mysql   hard    nproc     4096
*        soft    core      0
```

**ğŸ” å‚æ•°è¯¦è§£**

| å‚æ•° | **å«ä¹‰** | **ç¤ºä¾‹** |
|------|---------|---------|
| **domain** | `ç”¨æˆ·/ç»„åï¼Œ*è¡¨ç¤ºæ‰€æœ‰ç”¨æˆ·` | `root, @mysql, *` |
| **type** | `soft(è½¯é™åˆ¶) / hard(ç¡¬é™åˆ¶)` | `soft, hard` |
| **item** | `èµ„æºé¡¹ç›®åç§°` | `nofile, nproc, core` |
| **value** | `é™åˆ¶å€¼` | `65536, unlimited` |

### 4.3 å¸¸ç”¨èµ„æºé¡¹ç›®


**ğŸ“Š é‡è¦èµ„æºé¡¹ç›®è¯´æ˜**

```bash
# æŸ¥çœ‹å½“å‰é…ç½®
cat /etc/security/limits.conf | grep -v "^#" | grep -v "^$"

# å¸¸ç”¨é¡¹ç›®ï¼š
nofile   - æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°
nproc    - æœ€å¤§è¿›ç¨‹æ•°  
fsize    - æœ€å¤§æ–‡ä»¶å¤§å°
data     - æœ€å¤§æ•°æ®æ®µå¤§å°
stack    - æœ€å¤§æ ˆå¤§å°
core     - æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶å¤§å°
rss      - æœ€å¤§å¸¸é©»å†…å­˜
cpu      - æœ€å¤§CPUæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
memlock  - æœ€å¤§é”å®šå†…å­˜
```

### 4.4 å®é™…é…ç½®ç¤ºä¾‹


**ğŸ”§ é’ˆå¯¹ä¸åŒç”¨æˆ·çš„é…ç½®**

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo vim /etc/security/limits.conf

# æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

# æ™®é€šç”¨æˆ·é™åˆ¶
*        soft    nofile    1024
*        hard    nofile    4096
*        soft    nproc     1024  
*        hard    nproc     2048

# æ•°æ®åº“ç”¨æˆ·ç‰¹æ®Šé…ç½®
mysql    soft    nofile    65536
mysql    hard    nofile    65536  
mysql    soft    nproc     4096
mysql    hard    nproc     8192

# WebæœåŠ¡ç”¨æˆ·
nginx    soft    nofile    10240
nginx    hard    nofile    20480

# å¼€å‘ç”¨æˆ·
@dev     soft    nofile    8192
@dev     hard    nofile    16384
```

**âš ï¸ é…ç½®æ³¨æ„äº‹é¡¹**

```
1. ä¿®æ”¹åéœ€è¦é‡æ–°ç™»å½•æ‰èƒ½ç”Ÿæ•ˆ
2. è½¯é™åˆ¶ä¸èƒ½è¶…è¿‡ç¡¬é™åˆ¶
3. æ™®é€šç”¨æˆ·ä¸èƒ½æé«˜ç¡¬é™åˆ¶
4. rootç”¨æˆ·å¯ä»¥éšæ—¶ä¿®æ”¹é™åˆ¶
5. ç³»ç»Ÿé‡å¯åé…ç½®æŒä¹…æœ‰æ•ˆ
```

---

## 5. ğŸ” è¿›ç¨‹èµ„æºé™åˆ¶æŸ¥çœ‹


### 5.1 /proc/PID/limitsè¿›ç¨‹èµ„æºæŸ¥çœ‹


**ğŸ”¸ ä»€ä¹ˆæ˜¯è¿›ç¨‹èµ„æºé™åˆ¶**
æ¯ä¸ªè¿è¡Œä¸­çš„è¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„èµ„æºé™åˆ¶ï¼Œè¿™äº›é™åˆ¶ç»§æ‰¿è‡ªå¯åŠ¨å®ƒçš„ç”¨æˆ·è®¾ç½®ï¼Œå¯ä»¥é€šè¿‡procæ–‡ä»¶ç³»ç»ŸæŸ¥çœ‹ã€‚

**ğŸ“Š æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹é™åˆ¶**

```bash
# æŸ¥çœ‹å½“å‰shellè¿›ç¨‹çš„é™åˆ¶
cat /proc/$$/limits

# æŸ¥çœ‹æŒ‡å®šPIDçš„é™åˆ¶
cat /proc/1234/limits

# æŸ¥çœ‹ç³»ç»Ÿè¿›ç¨‹é™åˆ¶
cat /proc/1/limits    # initè¿›ç¨‹
```

**ğŸ’¡ è¾“å‡ºç»“æœç¤ºä¾‹**
```
Limit                     Soft Limit           Hard Limit           Units     
Max cpu time              unlimited            unlimited            seconds   
Max file size             unlimited            unlimited            bytes     
Max data size             unlimited            unlimited            bytes     
Max stack size            8388608              unlimited            bytes     
Max core file size        0                    unlimited            bytes     
Max resident set          unlimited            unlimited            bytes     
Max processes             15663                15663                processes 
Max open files            1024                 4096                 files     
Max locked memory         16777216             16777216             bytes     
Max address space         unlimited            unlimited            bytes     
Max file locks            unlimited            unlimited            locks     
Max pending signals       15663                15663                signals   
Max msgqueue size         819200               819200               bytes     
Max nice priority         0                    0                    
Max realtime priority     0                    0                    
Max realtime timeout      unlimited            unlimited            us        
```

### 5.2 æ‰¹é‡æŸ¥çœ‹è¿›ç¨‹é™åˆ¶


**ğŸ”§ å®ç”¨æŸ¥çœ‹æŠ€å·§**

```bash
# æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
for pid in $(pgrep -f "nginx\|apache\|mysql"); do
    echo "PID $pid æ–‡ä»¶æè¿°ç¬¦é™åˆ¶:"
    awk '/Max open files/ {print $4"/"$5}' /proc/$pid/limits 2>/dev/null
done

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·æ‰€æœ‰è¿›ç¨‹çš„é™åˆ¶
ps -eo pid,user,comm | grep "^[[:space:]]*[0-9]*[[:space:]]*mysql" | while read pid user comm; do
    echo "è¿›ç¨‹ $comm (PID: $pid) é™åˆ¶:"
    cat /proc/$pid/limits 2>/dev/null | grep "Max open files\|Max processes"
done
```

**ğŸ“ˆ è¿›ç¨‹èµ„æºä½¿ç”¨ç»Ÿè®¡**

```bash
# æŸ¥çœ‹è¿›ç¨‹å®é™…èµ„æºä½¿ç”¨
cat /proc/PID/status | grep -E "(VmPeak|VmSize|VmRSS|Threads)"

# VmPeak: è¿›ç¨‹ä½¿ç”¨è™šæ‹Ÿå†…å­˜çš„å³°å€¼
# VmSize: å½“å‰è™šæ‹Ÿå†…å­˜å¤§å°  
# VmRSS: å¸¸é©»å†…å­˜å¤§å°
# Threads: çº¿ç¨‹æ•°é‡
```

---

## 6. ğŸ› ï¸ ç³»ç»Ÿè°ƒç”¨ä¸é«˜çº§å·¥å…·


### 6.1 getrlimitç³»ç»Ÿè°ƒç”¨


**ğŸ”¸ ä»€ä¹ˆæ˜¯getrlimit**
getrlimitæ˜¯Linuxç³»ç»Ÿè°ƒç”¨ï¼Œç¨‹åºå¯ä»¥é€šè¿‡å®ƒæŸ¥è¯¢è‡ªå·±çš„èµ„æºé™åˆ¶ã€‚è¿™æ˜¯ç¨‹åºçº§åˆ«çš„èµ„æºæŸ¥çœ‹æ–¹æ³•ã€‚

**ğŸ’» ç®€å•æ¼”ç¤ºç¨‹åº**

```c
#include <sys/resource.h>
#include <stdio.h>

int main() {
    struct rlimit limit;
    
    // æŸ¥çœ‹æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
    getrlimit(RLIMIT_NOFILE, &limit);
    printf("æ–‡ä»¶æè¿°ç¬¦é™åˆ¶: %ld/%ld\n", limit.rlim_cur, limit.rlim_max);
    
    // æŸ¥çœ‹è¿›ç¨‹æ•°é™åˆ¶
    getrlimit(RLIMIT_NPROC, &limit);
    printf("è¿›ç¨‹æ•°é™åˆ¶: %ld/%ld\n", limit.rlim_cur, limit.rlim_max);
    
    return 0;
}
```

**ğŸ”§ ä½¿ç”¨ç³»ç»Ÿå·¥å…·æŸ¥çœ‹**

```bash
# ä½¿ç”¨straceè·Ÿè¸ªç¨‹åºçš„èµ„æºé™åˆ¶è°ƒç”¨
strace -e trace=getrlimit ls >/dev/null

# ä½¿ç”¨lsofæŸ¥çœ‹è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æ•°
lsof -p PID | wc -l
```

### 6.2 prlimitè¿›ç¨‹èµ„æºé™åˆ¶å·¥å…·


**ğŸ”¸ prlimitåŸºæœ¬æ¦‚å¿µ**
prlimitæ˜¯è¾ƒæ–°çš„Linuxå·¥å…·ï¼Œå¯ä»¥æŸ¥çœ‹å’Œä¿®æ”¹è¿è¡Œä¸­è¿›ç¨‹çš„èµ„æºé™åˆ¶ï¼Œæ¯”ulimitæ›´å¼ºå¤§ã€‚

**ğŸ“Š åŸºæœ¬ä½¿ç”¨æ–¹æ³•**

```bash
# æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„æ‰€æœ‰é™åˆ¶
prlimit -p 1234

# æŸ¥çœ‹å½“å‰è¿›ç¨‹é™åˆ¶  
prlimit

# æŸ¥çœ‹ç‰¹å®šèµ„æºé™åˆ¶
prlimit -p 1234 -n    # æ–‡ä»¶æè¿°ç¬¦
prlimit -p 1234 -u    # è¿›ç¨‹æ•°
```

**âš¡ åŠ¨æ€ä¿®æ”¹è¿›ç¨‹é™åˆ¶**

```bash
# ä¿®æ”¹è¿è¡Œä¸­è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
sudo prlimit -p 1234 -n=4096:8192

# å¯åŠ¨ç¨‹åºæ—¶è®¾ç½®é™åˆ¶
prlimit -n=2048 -u=1024 ./my_program

# æŸ¥çœ‹ä¿®æ”¹ç»“æœ
prlimit -p 1234 -n
```

**ğŸ’¡ prlimitä¼˜åŠ¿**

```
ç›¸æ¯”ulimitçš„ä¼˜åŠ¿ï¼š
âœ… å¯ä»¥ä¿®æ”¹è¿è¡Œä¸­çš„è¿›ç¨‹
âœ… å¯ä»¥åŒæ—¶è®¾ç½®è½¯ç¡¬é™åˆ¶
âœ… è¾“å‡ºæ ¼å¼æ›´æ¸…æ™°
âœ… æ”¯æŒæ›´å¤šèµ„æºç±»å‹
```

---

## 7. ğŸ—ï¸ cgroupsèµ„æºæ§åˆ¶


### 7.1 cgroupsåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯cgroups**
cgroupsï¼ˆControl Groupsï¼‰æ˜¯Linuxå†…æ ¸çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œç”¨äºå¯¹è¿›ç¨‹ç»„è¿›è¡Œèµ„æºé™åˆ¶ã€ä¼˜å…ˆçº§æ§åˆ¶å’Œå®¡è®¡ã€‚å®ƒå°±åƒæ˜¯ç»™è¿›ç¨‹åˆ†ç»„ç®¡ç†çš„"ç­çº§åˆ¶åº¦"ã€‚

```
ç®€å•ç†è§£ï¼š
ä¼ ç»Ÿé™åˆ¶ï¼šæ¯ä¸ªç”¨æˆ·æœ‰å›ºå®šé¢åº¦
cgroupsï¼šå¯ä»¥ç»™è¿›ç¨‹åˆ†ç»„ï¼Œæ¯ç»„æœ‰ä¸åŒçš„èµ„æºåˆ†é…

åº”ç”¨åœºæ™¯ï¼š
â€¢ å®¹å™¨æŠ€æœ¯ï¼ˆDockerï¼‰
â€¢ ç³»ç»ŸæœåŠ¡ç®¡ç†ï¼ˆsystemdï¼‰  
â€¢ æ‰¹å¤„ç†ä½œä¸šæ§åˆ¶
```

### 7.2 cgroupsä¿¡æ¯æŸ¥çœ‹


**ğŸ“ cgroupsæŒ‚è½½ç‚¹æŸ¥çœ‹**

```bash
# æŸ¥çœ‹cgroupsæŒ‚è½½ç‚¹
mount | grep cgroup
# æˆ–è€…
cat /proc/mounts | grep cgroup

# å…¸å‹è¾“å‡ºï¼š
# cgroup on /sys/fs/cgroup/memory type cgroup (rw,relatime,memory)
# cgroup on /sys/fs/cgroup/cpu type cgroup (rw,relatime,cpu)
```

**ğŸ” æŸ¥çœ‹è¿›ç¨‹çš„cgroupä¿¡æ¯**

```bash
# æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹å±äºå“ªä¸ªcgroup
cat /proc/PID/cgroup

# æŸ¥çœ‹å½“å‰è¿›ç¨‹çš„cgroup
cat /proc/self/cgroup

# ç¤ºä¾‹è¾“å‡ºï¼š
# 12:memory:/user.slice/user-1000.slice/session-1.scope  
# 11:cpu:/user.slice/user-1000.slice/session-1.scope
```

### 7.3 systemdé›†æˆçš„èµ„æºæ§åˆ¶


**ğŸ”§ systemdæœåŠ¡èµ„æºé™åˆ¶**

```bash
# æŸ¥çœ‹æœåŠ¡çš„èµ„æºé™åˆ¶
systemctl show nginx.service | grep -i limit

# æŸ¥çœ‹æœåŠ¡çš„cgroupä¿¡æ¯
systemctl status nginx.service

# æŸ¥çœ‹ç”¨æˆ·ä¼šè¯çš„èµ„æºä½¿ç”¨
systemctl --user status
```

**ğŸ“Š æŸ¥çœ‹cgroupèµ„æºä½¿ç”¨æƒ…å†µ**

```bash
# å†…å­˜ä½¿ç”¨æƒ…å†µ
cat /sys/fs/cgroup/memory/memory.usage_in_bytes
cat /sys/fs/cgroup/memory/memory.limit_in_bytes

# CPUä½¿ç”¨æƒ…å†µ  
cat /sys/fs/cgroup/cpu/cpu.stat

# è¿›ç¨‹åˆ—è¡¨
cat /sys/fs/cgroup/memory/cgroup.procs
```

### 7.4 Dockerå®¹å™¨èµ„æºæŸ¥çœ‹


**ğŸ³ å®¹å™¨èµ„æºé™åˆ¶æŸ¥çœ‹**

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºé™åˆ¶
docker stats container_name

# æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯
docker inspect container_name | grep -A 20 "Resources"

# æŸ¥çœ‹å®¹å™¨çš„cgroup
docker exec container_name cat /proc/1/cgroup
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ulimitï¼šç”¨æˆ·çº§èµ„æºé™åˆ¶ï¼Œå½±å“shellåŠå­è¿›ç¨‹
ğŸ”¸ /proc/sysï¼šç³»ç»Ÿçº§å‚æ•°ï¼Œå…¨å±€èµ„æºé…ç½®
ğŸ”¸ limits.confï¼šç”¨æˆ·ç™»å½•æ—¶çš„èµ„æºé™åˆ¶é…ç½®
ğŸ”¸ /proc/PID/limitsï¼šè¿›ç¨‹çº§èµ„æºé™åˆ¶æŸ¥çœ‹
ğŸ”¸ prlimitï¼šåŠ¨æ€ä¿®æ”¹è¿›ç¨‹èµ„æºé™åˆ¶çš„å·¥å…·
ğŸ”¸ cgroupsï¼šè¿›ç¨‹ç»„èµ„æºæ§åˆ¶å’Œç®¡ç†
```

### 8.2 å®é™…åº”ç”¨åœºæ™¯ç†è§£


**ğŸ”¹ WebæœåŠ¡å™¨ä¼˜åŒ–**
```
é—®é¢˜ï¼šç½‘ç«™å¹¶å‘è®¿é—®é‡å¤§ï¼Œå‡ºç°"too many open files"é”™è¯¯
è§£å†³ï¼š
1. æ£€æŸ¥å½“å‰é™åˆ¶ï¼šulimit -n
2. ä¸´æ—¶æé«˜é™åˆ¶ï¼šulimit -n 65536
3. æ°¸ä¹…é…ç½®ï¼šä¿®æ”¹limits.conf
4. é‡å¯æœåŠ¡ï¼šè®©æ–°é…ç½®ç”Ÿæ•ˆ
```

**ğŸ”¹ æ•°æ®åº“æ€§èƒ½è°ƒä¼˜**
```
é—®é¢˜ï¼šæ•°æ®åº“è¿æ¥æ•°ä¸å¤Ÿç”¨
è§£å†³ï¼š
1. æŸ¥çœ‹è¿›ç¨‹é™åˆ¶ï¼šcat /proc/$(pgrep mysql)/limits
2. ä¿®æ”¹é…ç½®ï¼šåœ¨limits.confä¸­å¢åŠ mysqlç”¨æˆ·çš„nofileé™åˆ¶
3. éªŒè¯ç”Ÿæ•ˆï¼šé‡æ–°ç™»å½•mysqlç”¨æˆ·åæ£€æŸ¥ulimit -n
```

**ğŸ”¹ æ‰¹å¤„ç†ä»»åŠ¡æ§åˆ¶**
```
åœºæ™¯ï¼šé˜²æ­¢æ‰¹å¤„ç†ä½œä¸šå ç”¨å¤ªå¤šèµ„æº
æ–¹æ³•ï¼š
1. ä½¿ç”¨prlimitå¯åŠ¨ï¼šprlimit -n=1024 -u=100 ./batch_job
2. é…ç½®cgroupsï¼šåˆ›å»ºä¸“é—¨çš„èµ„æºç»„
3. ç›‘æ§ä½¿ç”¨ï¼šå®šæœŸæ£€æŸ¥/proc/sys/fs/file-nr
```

### 8.3 æ•…éšœæ’æŸ¥æ€è·¯


**ğŸ” èµ„æºä¸è¶³é—®é¢˜æ’æŸ¥æ­¥éª¤**

```
1. ç¡®å®šé—®é¢˜ç±»å‹ï¼š
   â€¢ æ–‡ä»¶æè¿°ç¬¦ä¸è¶³ï¼šulimit -n
   â€¢ è¿›ç¨‹æ•°ä¸è¶³ï¼šulimit -u  
   â€¢ å†…å­˜ä¸è¶³ï¼šfree -h

2. æ‰¾åˆ°é™åˆ¶æºå¤´ï¼š
   â€¢ ç”¨æˆ·é™åˆ¶ï¼šcat /etc/security/limits.conf
   â€¢ ç³»ç»Ÿé™åˆ¶ï¼šcat /proc/sys/fs/file-max
   â€¢ è¿›ç¨‹é™åˆ¶ï¼šcat /proc/PID/limits

3. ç¡®å®šä¿®æ”¹æ–¹æ³•ï¼š
   â€¢ ä¸´æ—¶ä¿®æ”¹ï¼šulimitæˆ–prlimit
   â€¢ æ°¸ä¹…ä¿®æ”¹ï¼šlimits.conf
   â€¢ ç³»ç»Ÿçº§ä¿®æ”¹ï¼š/proc/syså‚æ•°

4. éªŒè¯æ•ˆæœï¼š
   â€¢ æ£€æŸ¥æ–°é™åˆ¶ï¼šulimit -a
   â€¢ ç›‘æ§ä½¿ç”¨ï¼šå®šæœŸæŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ
```

### 8.4 æœ€ä½³å®è·µå»ºè®®


**âš¡ é…ç½®åŸåˆ™**
- **æ¸è¿›è°ƒæ•´**ï¼šä¸è¦ä¸€æ¬¡æ€§è®¾ç½®è¿‡å¤§çš„å€¼
- **ç›‘æ§éªŒè¯**ï¼šä¿®æ”¹åæŒç»­è§‚å¯Ÿç³»ç»Ÿè¡¨ç°
- **æ–‡æ¡£è®°å½•**ï¼šè®°å½•ä¿®æ”¹åŸå› å’Œé¢„æœŸæ•ˆæœ
- **å¤‡ä»½é…ç½®**ï¼šä¿®æ”¹å‰å¤‡ä»½åŸå§‹é…ç½®

**ğŸ”§ å¸¸ç”¨ç›‘æ§å‘½ä»¤ç»„åˆ**
```bash
# åˆ›å»ºèµ„æºç›‘æ§åˆ«å
alias resource_check='echo "æ–‡ä»¶æè¿°ç¬¦: $(ulimit -n)"; echo "è¿›ç¨‹æ•°: $(ulimit -u)"; echo "ç³»ç»Ÿè´Ÿè½½: $(cat /proc/loadavg)"'

# å¿«é€ŸæŸ¥çœ‹ç³»ç»Ÿèµ„æºä½¿ç”¨
alias sys_usage='cat /proc/sys/fs/file-nr; free -h | head -2; ps aux | wc -l'
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- èµ„æºé™åˆ¶å¦‚åŒäº¤é€šè§„åˆ™ï¼Œä¿éšœç³»ç»Ÿæœ‰åºè¿è¡Œ
- ulimitç®¡ç”¨æˆ·ï¼Œ/procç®¡ç³»ç»Ÿï¼Œlimits.confç®¡ç™»å½•
- é—®é¢˜æ’æŸ¥ä»å°åˆ°å¤§ï¼šè¿›ç¨‹â†’ç”¨æˆ·â†’ç³»ç»Ÿâ†’å†…æ ¸
- ä¿®æ”¹é…ç½®è¦è°¨æ…ï¼Œç›‘æ§éªŒè¯æ˜¯å…³é”®