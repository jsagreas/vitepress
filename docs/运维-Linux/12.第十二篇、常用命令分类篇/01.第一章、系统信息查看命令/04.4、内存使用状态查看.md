---
title: 4、内存使用状态查看
---
## 📚 目录

1. [内存查看概述](#1-内存查看概述)
2. [free命令详解](#2-free命令详解)  
3. [proc内存信息文件](#3-proc内存信息文件)
4. [vmstat虚拟内存统计](#4-vmstat虚拟内存统计)
5. [进程内存映射查看](#5-进程内存映射查看)
6. [内存使用率计算](#6-内存使用率计算)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔍 内存查看概述


### 1.1 为什么要查看内存状态


在Linux系统运维中，**内存状态监控**是最重要的性能指标之一。内存不够用会导致系统卡顿、进程被杀死，甚至系统崩溃。

**内存监控的重要性**：
- **性能诊断**：找出内存瓶颈，优化系统性能
- **故障排查**：定位内存不足导致的问题
- **容量规划**：评估是否需要增加内存
- **进程管理**：识别占用内存过多的进程

### 1.2 Linux内存管理机制


```
Linux内存结构：
┌─────────────────────────────┐
│      物理内存（RAM）         │
├─────────────────────────────┤
│  内核空间  │   用户空间     │
├─────────────────────────────┤
│ 缓存(Cache) │ 缓冲(Buffer) │ ← 可释放内存
├─────────────────────────────┤
│      交换分区(Swap)         │ ← 虚拟内存
└─────────────────────────────┘
```

**关键概念解释**：
- **物理内存**：真实的RAM硬件
- **缓存(Cache)**：文件系统缓存，加速文件读取
- **缓冲(Buffer)**：磁盘I/O缓冲，提高写入效率
- **交换分区**：硬盘上的虚拟内存空间

---

## 2. 📊 free命令详解


### 2.1 基本用法


`free`命令是查看内存使用情况最常用的工具，就像查看银行账户余额一样简单直观。

```bash
# 基本查看内存
free

# 以人类可读格式显示(推荐)
free -h

# 每2秒刷新一次
free -h -s 2
```

### 2.2 输出解读


```
              total        used        free      shared  buff/cache   available
Mem:           7.7G        2.1G        1.2G        156M        4.4G        5.1G
Swap:          2.0G          0B        2.0G
```

**每列含义详解**：

| 列名 | **含义** | **通俗解释** |
|------|----------|-------------|
| `total` | 总内存大小 | `你的电脑总共有多少内存` |
| `used` | 已使用内存 | `程序真正占用的内存` |
| `free` | 空闲内存 | `完全没用的内存` |
| `shared` | 共享内存 | `多个程序共用的内存` |
| `buff/cache` | 缓存内存 | `系统用来加速的缓存，可以释放` |
| `available` | 可用内存 | `新程序可以使用的内存总量` |

> 💡 **重要提示**：`available`才是真正可用的内存！不要只看`free`。

### 2.3 常用选项组合


```bash
# 显示详细信息，每行显示一种内存类型
free -h -w

# 显示总计信息
free -h -t

# 持续监控，每3秒更新
free -h -s 3 -c 10  # 只显示10次后退出
```

**实际使用场景**：
- **日常检查**：`free -h`
- **持续监控**：`free -h -s 2`
- **脚本使用**：`free -m | grep Mem`

---

## 3. 📂 /proc内存信息文件


### 3.1 /proc/meminfo详细内存信息


`/proc/meminfo`文件包含了系统内存的完整详细信息，就像内存的"体检报告"。

```bash
# 查看详细内存信息
cat /proc/meminfo

# 查看前10行关键信息
head -10 /proc/meminfo
```

**关键字段解读**：
```
MemTotal:        7897832 kB    ← 总内存
MemFree:         1245632 kB    ← 空闲内存
MemAvailable:    5234156 kB    ← 可用内存
Buffers:          876432 kB    ← 缓冲区
Cached:          3456789 kB    ← 文件缓存
SwapTotal:       2097148 kB    ← 交换分区总大小
SwapFree:        2097148 kB    ← 交换分区空闲
```

> 🔍 **查看技巧**：可以用`grep`过滤关键信息
> ```bash
> cat /proc/meminfo | grep -E "(MemTotal|MemFree|MemAvailable|Cached)"
> ```

### 3.2 /proc/buddyinfo内存碎片信息


这个文件显示内存碎片情况，帮助了解内存分配状态。

```bash
cat /proc/buddyinfo
```

**输出示例**：
```
Node 0, zone      DMA     42    78    52    34    23    12     3     2     1     0     0
Node 0, zone    DMA32   1234  2345  1234   567   234    89    23    12     3     1     0
```

**含义解释**：
- 每行代表一个内存区域
- 数字表示不同大小的连续内存块数量
- 左边是小块，右边是大块
- 如果右边数字很少，说明大块内存不足

### 3.3 /proc/slabinfo内核缓存信息


显示内核内存分配器的使用情况，主要用于系统调优。

```bash
# 需要root权限查看
sudo cat /proc/slabinfo | head -10
```

**用途说明**：
- 诊断内核内存泄漏
- 了解内核缓存使用情况
- 系统性能调优参考

---

## 4. 📈 vmstat虚拟内存统计


### 4.1 基本用法


`vmstat`命令提供虚拟内存、进程、CPU等综合统计信息，是系统性能监控的"多面手"。

```bash
# 基本用法
vmstat

# 每2秒显示一次，总共显示5次
vmstat 2 5

# 显示内存统计详情
vmstat -s
```

### 4.2 输出解读


```
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 1245632 876432 3456789  0    0    45   123  234  567 12  3 84  1  0
```

**字段分组说明**：

| 分组 | **字段** | **含义** |
|------|----------|----------|
| **内存** | `swpd` | `使用的swap空间(KB)` |
| | `free` | `空闲内存(KB)` |
| | `buff` | `缓冲区内存(KB)` |
| | `cache` | `缓存内存(KB)` |
| **交换** | `si` | `从swap读入内存的速度(KB/s)` |
| | `so` | `写入swap的速度(KB/s)` |

> ⚠️ **警告信号**：如果`si`和`so`数值很大，说明系统在频繁使用swap，性能会很差！

### 4.3 内存监控要点


**正常状态指标**：
- `free` + `buff` + `cache` 应该占总内存的合理比例
- `si`和`so`应该为0或很小的数值
- `swpd`最好为0

**异常状态处理**：
```bash
# 如果swap使用过多，查看哪个进程占用内存最多
ps aux --sort=-%mem | head -10

# 清理缓存(谨慎使用)
sudo sync && echo 3 | sudo tee /proc/sys/vm/drop_caches
```

---

## 5. 🔍 进程内存映射查看


### 5.1 pmap进程内存映射


`pmap`命令显示进程的内存映射情况，帮助分析单个进程的内存使用详情。

```bash
# 查看指定进程的内存映射
pmap <进程ID>

# 显示详细信息
pmap -x <进程ID>

# 显示设备信息
pmap -d <进程ID>
```

**实际使用示例**：
```bash
# 先找到进程ID
ps aux | grep nginx
# 假设nginx的PID是1234
pmap -x 1234
```

**输出解读**：
```
Address           Kbytes     RSS   Dirty Mode  Mapping
0000558a12345000    1024    1024       0 r-x-- nginx
0000558a12346000     512     512     512 rw--- nginx
...
----------------  ------  ------  ------
total kB           45678   23456   12345
```

- **Address**：内存地址
- **Kbytes**：虚拟内存大小
- **RSS**：实际物理内存使用
- **Dirty**：已修改但未写入磁盘的内存

### 5.2 smaps进程内存详情


`/proc/<PID>/smaps`提供比pmap更详细的内存信息。

```bash
# 查看进程详细内存映射
cat /proc/1234/smaps | head -20

# 统计进程总的物理内存使用
grep -E "^(Rss|Pss):" /proc/1234/smaps | awk '{sum+=$2} END {print sum" KB"}'
```

**关键指标含义**：
- **RSS**：实际物理内存使用
- **PSS**：按比例分摊的内存使用
- **USS**：进程独占的内存

---

## 6. 🧮 内存使用率计算


### 6.1 计算方法详解


理解内存使用率的正确计算方法对系统监控至关重要。

**传统错误算法**：
```
错误：使用率 = used / total
```
这种算法会把cache和buffer都算作已用内存，导致使用率虚高。

**正确计算算法**：
```
正确：使用率 = (total - available) / total × 100%
```

### 6.2 实用计算脚本


```bash
#!/bin/bash
# 获取内存信息并计算使用率

# 方法1：使用free命令
memory_usage() {
    free | awk '/Mem:/ {
        total=$2; 
        available=$7; 
        used_ratio=(total-available)/total*100; 
        printf "内存使用率: %.1f%%\n", used_ratio
    }'
}

# 方法2：从/proc/meminfo计算  
memory_usage_proc() {
    awk '/MemTotal|MemAvailable/ {mem[$1]=$2} 
         END {
             used_ratio=(mem["MemTotal:"]-mem["MemAvailable:"])/mem["MemTotal:"]*100;
             printf "内存使用率: %.1f%%\n", used_ratio
         }' /proc/meminfo
}
```

### 6.3 监控阈值建议


**内存使用率警告阈值**：

| 使用率 | **状态** | **建议操作** |
|--------|----------|-------------|
| `< 70%` | 🟢 正常 | `无需操作` |
| `70-85%` | 🟡 注意 | `监控进程内存使用` |
| `85-95%` | 🟠 警告 | `清理不必要进程，考虑加内存` |
| `> 95%` | 🔴 危险 | `立即处理，可能导致系统崩溃` |

**实用监控命令**：
```bash
# 持续监控内存使用率
watch -n 2 "free -h && echo '---' && ps aux --sort=-%mem | head -5"
```

---

## 7. 📋 核心要点总结


### 7.1 命令速查表


| 命令 | **用途** | **常用选项** |
|------|----------|-------------|
| `free -h` | `查看内存概况` | `-h`人性化显示，`-s`间隔刷新 |
| `cat /proc/meminfo` | `详细内存信息` | `grep`过滤关键字段 |
| `vmstat` | `虚拟内存统计` | `vmstat 2 5`间隔监控 |
| `pmap -x PID` | `进程内存映射` | `-x`显示详细信息 |

### 7.2 内存状态判断要点


**🔹 关键指标理解**：
```
真正可用内存 = available (不是free!)
内存压力指标 = swap使用量(si/so数值)
进程内存占用 = RSS(不是VSZ)
```

**🔹 常见误区纠正**：
- ❌ **错误**：认为cache/buffer是被占用的内存
- ✅ **正确**：cache/buffer是可释放的，会自动让给应用程序

- ❌ **错误**：只看free数值判断内存够不够
- ✅ **正确**：看available数值才是真正可用内存

**🔹 实际运维经验**：
```
日常检查：free -h
性能诊断：vmstat 2 5  
进程分析：ps aux --sort=-%mem | head -10
深度分析：cat /proc/meminfo | grep -E "关键字段"
```

### 7.3 记忆要点


**🧠 记忆口诀**：
```
free看概况，meminfo看详情
vmstat看趋势，pmap看进程
available才是真可用
swap使用要警惕
```

**💡 实用技巧**：
- 内存不足时优先查看占用最多的进程
- 定期清理不必要的服务和进程
- 合理设置swap大小(通常为物理内存的1-2倍)
- 监控脚本中使用available而不是free计算使用率