---
title: 13、文件属性安全检查与审计
---
## 📚 目录

1. [文件权限安全检查基础](#1-文件权限安全检查基础)
2. [异常权限检测方法](#2-异常权限检测方法)
3. [SUID/SGID文件安全审计](#3-SUID/SGID文件安全审计)
4. [权限变更日志记录](#4-权限变更日志记录)
5. [文件属性基线建立](#5-文件属性基线建立)
6. [权限合规性检查](#6-权限合规性检查)
7. [安全权限配置标准](#7-安全权限配置标准)
8. [权限审计工具使用](#8-权限审计工具使用)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔍 文件权限安全检查基础


### 1.1 什么是文件权限安全检查


**💡 通俗解释**：
文件权限安全检查就像是**定期检查房屋的门锁和钥匙**一样。我们需要确保：
- 该锁的门确实锁了
- 不该有钥匙的人没有钥匙
- 重要房间的安全等级足够高

在Linux系统中，这意味着检查文件和目录的读写执行权限是否合理安全。

### 1.2 为什么需要安全检查


**🚨 常见安全风险**：
- **权限过松**：重要文件被普通用户修改
- **权限过紧**：系统服务无法正常运行
- **特殊权限滥用**：SUID程序被恶意利用
- **权限变更未知**：不知道谁改了什么权限

### 1.3 基础检查方法


**🔧 手工检查命令**：

```bash
# 查看文件详细权限信息
ls -la /etc/passwd
# 输出：-rw-r--r-- 1 root root 1234 Sep 18 10:00 /etc/passwd

# 查看目录权限
ls -ld /tmp
# 输出：drwxrwxrwt 15 root root 4096 Sep 18 10:00 /tmp
```

**📊 权限含义解读**：
```
-rw-r--r--  解读：
│││││││││└── 其他用户权限：r--（只读）
││││││└──── 组权限：r--（只读）  
│││└────── 用户权限：rw-（读写）
││└─────── 链接数
│└──────── 文件类型：-（普通文件）
```

---

## 2. 🚨 异常权限检测方法


### 2.1 什么是异常权限


**💡 异常权限概念**：
异常权限就是**不符合安全规范的权限设置**，比如：
- 系统配置文件任何人都能写入
- 普通用户目录其他人可以访问
- 临时文件夹权限设置错误

### 2.2 常见异常权限类型


**⚠️ 高危权限配置**：

| 文件类型 | **异常表现** | **安全风险** | **应有权限** |
|---------|------------|------------|-------------|
| `/etc/passwd` | `-rw-rw-rw-` | `任何人可修改用户信息` | `-rw-r--r--` |
| `/etc/shadow` | `-rw-r--r--` | `密码哈希被读取` | `-rw-------` |
| `用户家目录` | `drwxrwxrwx` | `隐私文件被访问` | `drwx------` |
| `可执行文件` | `-rwxrwxrwx` | `被恶意修改执行` | `-rwxr-xr-x` |

### 2.3 异常检测脚本


**🔧 基础检测脚本**：
```bash
#!/bin/bash
# 文件权限异常检测脚本

echo "🔍 开始权限安全检查..."

# 检查世界可写文件
echo "📋 检查世界可写文件："
find / -type f -perm -002 2>/dev/null | head -10

# 检查无主文件
echo "📋 检查无主文件："
find / -nouser -o -nogroup 2>/dev/null | head -5

# 检查空密码用户
echo "📋 检查空密码用户："
awk -F: '$2 == "" {print $1}' /etc/shadow
```

### 2.4 目录权限检测


**🏠 重要目录权限标准**：
```
系统目录权限检查：
┌─────────────┬──────────────┬─────────────────┐
│   目录路径   │   标准权限    │     说明        │
├─────────────┼──────────────┼─────────────────┤
│ /etc/       │ drwxr-xr-x   │ 配置文件目录     │
│ /var/log/   │ drwxr-xr-x   │ 日志文件目录     │
│ /tmp/       │ drwxrwxrwt   │ 临时文件目录     │
│ /home/user/ │ drwx------   │ 用户家目录      │
└─────────────┴──────────────┴─────────────────┘
```

---

## 3. ⚡ SUID/SGID文件安全审计


### 3.1 SUID和SGID是什么


**💡 通俗理解**：
- **SUID**：就像**临时借用别人身份证**的权限
- **SGID**：就像**临时加入某个组织**的权限

当你运行一个有SUID权限的程序时，系统会临时把你当作文件所有者来执行程序。

### 3.2 为什么要审计SUID/SGID


**🚨 安全风险**：
- 恶意程序获得root权限
- 系统提权攻击
- 权限滥用和误用

**✅ 常见合法SUID程序**：
```
正常的SUID程序：
/usr/bin/passwd  - 修改密码需要root权限
/usr/bin/sudo    - 执行管理命令
/bin/ping        - 发送网络包需要特殊权限
```

### 3.3 SUID/SGID检测方法


**🔍 查找所有SUID文件**：
```bash
# 查找系统中所有SUID文件
find / -type f -perm -4000 2>/dev/null

# 查找所有SGID文件  
find / -type f -perm -2000 2>/dev/null

# 同时查找SUID和SGID文件
find / -type f \( -perm -4000 -o -perm -2000 \) 2>/dev/null
```

### 3.4 SUID审计脚本


**📋 审计脚本示例**：
```bash
#!/bin/bash
# SUID/SGID文件审计脚本

echo "🔒 SUID/SGID文件安全审计"
echo "========================"

# 已知安全的SUID文件列表
SAFE_SUID=(
    "/usr/bin/passwd"
    "/usr/bin/sudo" 
    "/bin/ping"
    "/usr/bin/su"
)

# 查找当前所有SUID文件
CURRENT_SUID=$(find / -type f -perm -4000 2>/dev/null)

echo "📋 发现的SUID文件："
for file in $CURRENT_SUID; do
    if [[ " ${SAFE_SUID[@]} " =~ " ${file} " ]]; then
        echo "✅ $file (安全)"
    else
        echo "⚠️  $file (需要检查)"
        ls -la "$file"
    fi
done
```

---

## 4. 📝 权限变更日志记录


### 4.1 为什么要记录权限变更


**💡 记录的重要性**：
权限变更日志就像**安全监控录像**，能帮我们：
- 追踪谁修改了文件权限
- 发现异常的权限变更行为
- 在出问题时快速定位原因
- 满足安全合规要求

### 4.2 Linux系统日志机制


**📊 权限相关日志位置**：
```
主要日志文件：
┌─────────────────┬───────────────────────────────┐
│   日志文件      │           记录内容             │
├─────────────────┼───────────────────────────────┤
│ /var/log/auth.log│ 用户登录、sudo使用记录        │
│ /var/log/secure  │ 安全相关事件（CentOS/RHEL）  │
│ /var/log/messages│ 系统通用消息                  │
│ /var/log/audit/  │ 系统审计日志（如果启用）      │
└─────────────────┴───────────────────────────────┘
```

### 4.3 使用auditd进行权限审计


**🔧 启用系统审计**：
```bash
# 安装auditd
sudo apt-get install auditd  # Ubuntu/Debian
# 或
sudo yum install audit       # CentOS/RHEL

# 启动审计服务
sudo systemctl start auditd
sudo systemctl enable auditd

# 添加文件权限监控规则
sudo auditctl -w /etc/passwd -p wa -k passwd_changes
sudo auditctl -w /etc/shadow -p wa -k shadow_changes
```

### 4.4 权限变更监控脚本


**📋 实时监控脚本**：
```bash
#!/bin/bash
# 权限变更实时监控

WATCH_DIRS=("/etc" "/usr/bin" "/var/www")
LOG_FILE="/var/log/permission_changes.log"

echo "🔍 启动权限变更监控..."

for dir in "${WATCH_DIRS[@]}"; do
    inotifywatch -m -r -e attrib "$dir" --format '%T %w%f %e' \
    --timefmt '%Y-%m-%d %H:%M:%S' >> "$LOG_FILE" &
done

echo "📝 监控日志输出到: $LOG_FILE"
```

---

## 5. 📊 文件属性基线建立


### 5.1 什么是文件属性基线


**💡 基线概念**：
文件属性基线就是**系统的健康体检报告**，记录了：
- 所有重要文件的正常权限状态
- 文件的所有者和所属组
- 文件的修改时间和大小
- 文件的哈希值（完整性检查）

### 5.2 为什么需要建立基线


**🎯 基线的作用**：
- **对比检测**：发现权限是否被篡改
- **快速恢复**：出问题时知道正确配置
- **合规审计**：证明系统配置符合标准
- **变更管理**：追踪系统配置变化

### 5.3 基线建立方法


**🔧 创建权限基线**：
```bash
#!/bin/bash
# 文件属性基线建立脚本

BASELINE_FILE="/etc/security/file_baseline.txt"
IMPORTANT_DIRS=("/etc" "/usr/bin" "/usr/sbin" "/boot")

echo "📊 建立文件属性基线..."
echo "# File Permission Baseline - $(date)" > "$BASELINE_FILE"
echo "# Format: permissions owner:group size date path" >> "$BASELINE_FILE"

for dir in "${IMPORTANT_DIRS[@]}"; do
    echo "正在扫描: $dir"
    find "$dir" -type f -exec ls -la {} \; 2>/dev/null | \
    awk '{print $1,$3":"$4,$5,$6" "$7" "$8,$9}' >> "$BASELINE_FILE"
done

echo "✅ 基线文件已保存到: $BASELINE_FILE"
```

### 5.4 基线对比检查


**📋 基线对比脚本**：
```bash
#!/bin/bash
# 基线对比检查脚本

BASELINE_FILE="/etc/security/file_baseline.txt"
TEMP_CURRENT="/tmp/current_baseline.txt"
DIFF_REPORT="/var/log/baseline_diff.log"

# 生成当前状态基线
./create_baseline.sh > /dev/null

# 对比基线差异
echo "🔍 对比文件属性变化..."
diff "$BASELINE_FILE" "$TEMP_CURRENT" > "$DIFF_REPORT"

if [ $? -eq 0 ]; then
    echo "✅ 文件属性无变化"
else
    echo "⚠️ 发现文件属性变化，详见: $DIFF_REPORT"
    head -20 "$DIFF_REPORT"
fi
```

---

## 6. ✅ 权限合规性检查


### 6.1 什么是权限合规性


**💡 合规性概念**：
权限合规性就是**按照安全标准来配置权限**，确保系统配置符合：
- 公司安全政策
- 行业安全标准（如CIS基准）
- 法规要求（如等保要求）

### 6.2 常见合规标准


**📋 CIS Linux基准示例**：

| 检查项目 | **要求** | **检查方法** |
|---------|---------|-------------|
| `密码文件权限` | `/etc/passwd 权限644` | `ls -la /etc/passwd` |
| `影子文件权限` | `/etc/shadow 权限600` | `ls -la /etc/shadow` |
| `用户家目录权限` | `权限700或750` | `ls -ld /home/*` |
| `世界可写文件` | `不应存在` | `find / -perm -002` |

### 6.3 合规性检查脚本


**🔧 CIS基准检查脚本**：
```bash
#!/bin/bash
# Linux CIS基准合规性检查

echo "🔒 Linux安全基准合规性检查"
echo "=========================="

# 检查1：密码文件权限
echo "1. 检查/etc/passwd权限..."
PASSWD_PERM=$(stat -c %a /etc/passwd)
if [ "$PASSWD_PERM" = "644" ]; then
    echo "✅ /etc/passwd权限正确 (644)"
else
    echo "❌ /etc/passwd权限异常: $PASSWD_PERM (应为644)"
fi

# 检查2：影子文件权限
echo "2. 检查/etc/shadow权限..."
SHADOW_PERM=$(stat -c %a /etc/shadow 2>/dev/null)
if [ "$SHADOW_PERM" = "600" ] || [ "$SHADOW_PERM" = "640" ]; then
    echo "✅ /etc/shadow权限正确 ($SHADOW_PERM)"
else
    echo "❌ /etc/shadow权限异常: $SHADOW_PERM"
fi

# 检查3：世界可写文件
echo "3. 检查世界可写文件..."
WORLD_WRITABLE=$(find / -xdev -type f -perm -002 2>/dev/null | wc -l)
if [ "$WORLD_WRITABLE" -eq 0 ]; then
    echo "✅ 未发现世界可写文件"
else
    echo "⚠️ 发现 $WORLD_WRITABLE 个世界可写文件"
fi
```

---

## 7. 🛡️ 安全权限配置标准


### 7.1 系统文件权限标准


**📋 核心系统文件权限配置**：

```
重要系统文件权限标准：
┌─────────────────┬──────────┬────────────┬─────────────────┐
│    文件路径     │  标准权限 │  所有者    │      说明       │
├─────────────────┼──────────┼────────────┼─────────────────┤
│ /etc/passwd     │   644    │ root:root  │ 用户账户信息     │
│ /etc/shadow     │   600    │ root:root  │ 用户密码哈希     │
│ /etc/group      │   644    │ root:root  │ 用户组信息       │
│ /etc/gshadow    │   600    │ root:root  │ 组密码信息       │
│ /etc/ssh/       │   755    │ root:root  │ SSH配置目录      │
│ /var/log/       │   755    │ root:root  │ 日志目录         │
└─────────────────┴──────────┴────────────┴─────────────────┘
```

### 7.2 用户目录权限标准


**🏠 用户相关目录权限**：
```
用户目录权限配置：
/home/username/     权限: 750 (用户可读写执行，组可读执行)
/home/username/.ssh/ 权限: 700 (只有用户可访问)
/home/username/.bashrc 权限: 644 (用户可写，其他只读)
```

### 7.3 服务配置文件权限


**⚙️ 常见服务配置文件**：
```bash
# Web服务器配置
/etc/apache2/       755 root:root
/etc/nginx/         755 root:root
/var/www/           755 www-data:www-data

# 数据库配置
/etc/mysql/         755 root:root
/var/lib/mysql/     700 mysql:mysql

# 防火墙配置
/etc/iptables/      755 root:root
```

### 7.4 权限标准化脚本


**🔧 权限标准化脚本**：
```bash
#!/bin/bash
# 系统权限标准化脚本

echo "🛡️ 执行系统权限标准化..."

# 设置核心系统文件权限
chmod 644 /etc/passwd
chmod 600 /etc/shadow  
chmod 644 /etc/group
chmod 600 /etc/gshadow

# 设置SSH相关权限
chmod 755 /etc/ssh
chmod 600 /etc/ssh/ssh_host_*_key
chmod 644 /etc/ssh/ssh_host_*_key.pub
chmod 644 /etc/ssh/sshd_config

# 设置用户家目录权限
for user_home in /home/*; do
    if [ -d "$user_home" ]; then
        chmod 750 "$user_home"
        chmod 700 "$user_home/.ssh" 2>/dev/null
    fi
done

echo "✅ 系统权限标准化完成"
```

---

## 8. 🛠️ 权限审计工具使用


### 8.1 系统内置工具


**🔧 基础审计工具**：

**find命令 - 权限查找神器**：
```bash
# 查找特定权限的文件
find /etc -perm 777          # 查找权限为777的文件
find /home -perm -4000       # 查找SUID文件
find / -type f -perm -002    # 查找世界可写文件

# 查找所有者异常的文件
find / -nouser -o -nogroup   # 查找无主文件
find /home -not -user john   # 查找不属于john的文件
```

**stat命令 - 详细文件信息**：
```bash
# 查看文件详细属性
stat /etc/passwd
# 输出包括：权限、所有者、修改时间、inode等

# 只显示权限（八进制）
stat -c %a /etc/passwd       # 输出：644
stat -c %A /etc/passwd       # 输出：-rw-r--r--
```

### 8.2 专业审计工具


**🔍 Lynis - 系统安全审计**：
```bash
# 安装Lynis
sudo apt-get install lynis

# 运行完整系统审计
sudo lynis audit system

# 只审计文件权限
sudo lynis audit system --tests-category "permissions"
```

**🛡️ AIDE - 文件完整性监控**：
```bash
# 安装AIDE
sudo apt-get install aide

# 初始化数据库
sudo aideinit

# 检查文件变化
sudo aide --check
```

### 8.3 自定义审计工具


**📋 综合权限审计脚本**：
```bash
#!/bin/bash
# 综合权限安全审计工具

REPORT_FILE="/var/log/security_audit_$(date +%Y%m%d).log"

echo "🔒 Linux系统权限安全审计报告" > "$REPORT_FILE"
echo "审计时间: $(date)" >> "$REPORT_FILE"
echo "========================================" >> "$REPORT_FILE"

# 1. SUID/SGID文件检查
echo "1. SUID/SGID文件列表:" >> "$REPORT_FILE"
find / -type f \( -perm -4000 -o -perm -2000 \) 2>/dev/null >> "$REPORT_FILE"

# 2. 世界可写文件检查
echo -e "\n2. 世界可写文件:" >> "$REPORT_FILE"
find / -xdev -type f -perm -002 2>/dev/null | head -20 >> "$REPORT_FILE"

# 3. 空密码账户检查
echo -e "\n3. 空密码账户:" >> "$REPORT_FILE"
awk -F: '($2 == "") {print $1}' /etc/shadow >> "$REPORT_FILE"

# 4. 用户家目录权限检查
echo -e "\n4. 用户家目录权限:" >> "$REPORT_FILE"
ls -ld /home/* 2>/dev/null >> "$REPORT_FILE"

echo "✅ 审计完成，报告保存至: $REPORT_FILE"
```

### 8.4 定期审计任务


**⏰ 设置定期审计crontab**：
```bash
# 编辑定时任务
crontab -e

# 每周执行一次全面审计
0 2 * * 0 /usr/local/bin/security_audit.sh

# 每天检查SUID文件变化
0 1 * * * find / -type f -perm -4000 2>/dev/null > /tmp/suid_daily.log
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 安全检查本质：定期验证系统文件权限是否符合安全标准
🔸 异常权限识别：能够发现过松、过紧或异常的权限配置
🔸 SUID/SGID审计：重点监控特殊权限文件，防止提权攻击
🔸 基线管理：建立标准配置基线，定期对比检查变化
🔸 合规性检查：按照安全标准执行权限配置检查
🔸 审计工具使用：熟练使用find、stat等工具进行权限分析
```

### 9.2 关键理解要点


**🔹 安全检查的重要性**：
- **预防为主**：定期检查比事后补救更有效
- **持续监控**：权限状态需要持续跟踪
- **标准化管理**：按照统一标准进行配置

**🔹 检查重点优先级**：
1. **SUID/SGID文件** - 最高风险，优先检查
2. **系统配置文件** - 影响系统安全
3. **用户权限配置** - 防止权限滥用
4. **日志审计配置** - 确保可追踪

**🔹 工具选择原则**：
- **日常检查**：使用shell脚本和基础命令
- **深度审计**：使用专业工具如Lynis、AIDE
- **实时监控**：结合auditd和inotify工具

### 9.3 实际应用价值


**🎯 业务场景应用**：
- **企业环境**：满足安全合规要求，通过等保测评
- **运维管理**：及时发现权限配置问题，避免安全事故
- **开发环境**：确保开发服务器权限配置安全
- **个人使用**：保护个人服务器和重要数据安全

**🔧 运维最佳实践**：
- **定期执行**：建立定期权限审计机制
- **脚本自动化**：减少人工操作，提高效率
- **日志记录**：保留审计日志，便于问题追踪
- **及时处理**：发现问题立即整改，不拖延

**核心记忆要点**：
- 权限安全检查是系统安全的基础防线
- SUID/SGID文件是重点监控对象
- 基线管理和合规检查是安全运维的标准做法
- 工具使用要结合实际需求，不能盲目依赖