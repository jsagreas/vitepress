---
title: 16、Web服务器防护
---
## 📚 目录

1. [Web服务器防火墙基础](#1-Web服务器防火墙基础)
2. [HTTP/HTTPS服务配置](#2-HTTP-HTTPS服务配置)
3. [Web管理端口保护](#3-Web管理端口保护)
4. [静态资源访问控制](#4-静态资源访问控制)
5. [SSL证书端口开放](#5-SSL证书端口开放)
6. [反向代理端口设置](#6-反向代理端口设置)
7. [CDN回源IP白名单](#7-CDN回源IP白名单)
8. [攻击IP自动封禁](#8-攻击IP自动封禁)
9. [Web服务监控配置](#9-Web服务监控配置)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🌐 Web服务器防火墙基础


### 1.1 什么是Web服务器防护


**通俗理解**：Web服务器就像一家餐厅，防火墙就是门卫
```
餐厅比喻：
🏪 餐厅 = Web服务器（提供网页服务）
🚪 大门 = 80端口（HTTP访问入口）
🔐 包间 = 443端口（HTTPS安全访问）
👮 门卫 = firewall-cmd（控制谁能进来）
📋 黑名单 = 封禁规则（拒绝恶意访客）
```

**核心作用**：
- **访问控制**：决定哪些人能访问你的网站
- **端口管理**：开放网站需要的端口，关闭不需要的
- **安全防护**：阻止恶意攻击和垃圾流量
- **流量监控**：记录访问日志，发现异常

### 1.2 Web服务常用端口说明


**基础端口认知**：
```
端口就像房间号码：

🔸 80端口 = HTTP服务
  └─ 普通网页访问（如：http://example.com）
  └─ 数据明文传输，不加密

🔸 443端口 = HTTPS服务  
  └─ 安全网页访问（如：https://example.com）
  └─ 数据加密传输，更安全

🔸 8080端口 = 备用Web端口
  └─ 测试环境或辅助服务
  └─ 访问方式：http://example.com:8080

🔸 8443端口 = 备用HTTPS端口
  └─ 安全的备用服务
  └─ 访问方式：https://example.com:8443
```

### 1.3 Web防火墙的重要性


**为什么需要防火墙保护**：
```
没有防火墙的Web服务器：
👹 恶意扫描 → 发现漏洞 → 入侵服务器
🤖 机器人攻击 → 消耗资源 → 网站卡顿
💣 DDoS攻击 → 大量请求 → 服务器瘫痪
🕵️ 信息泄露 → 敏感数据 → 被人窃取

有防火墙保护的服务器：
✅ 只允许正常访问
✅ 阻止恶意IP
✅ 限制访问频率
✅ 保护管理端口
```

---

## 2. 🔧 HTTP/HTTPS服务配置


### 2.1 开启基本Web服务


**第一步：启用HTTP服务**

🔸 **方法一：使用服务名（推荐）**
```bash
# 永久开启HTTP服务（80端口）
firewall-cmd --permanent --add-service=http

# 立即生效
firewall-cmd --reload

# 检查是否开启成功
firewall-cmd --list-services
```

> **新手解释**：`--add-service=http` 就是告诉防火墙"允许HTTP服务通过"，比直接开端口更安全，因为它只开启必要的端口。

🔸 **方法二：直接开启端口**
```bash
# 开启80端口
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --reload
```

**第二步：启用HTTPS服务**
```bash
# 开启HTTPS服务（443端口）
firewall-cmd --permanent --add-service=https
firewall-cmd --reload

# 验证配置
firewall-cmd --list-all
```

### 2.2 配置验证与测试


**检查配置是否正确**：
```bash
# 查看当前开放的服务
firewall-cmd --list-services

# 查看当前开放的端口  
firewall-cmd --list-ports

# 查看完整配置
firewall-cmd --list-all
```

**测试Web服务可访问性**：
```bash
# 本地测试HTTP
curl -I http://localhost

# 本地测试HTTPS（如果配置了SSL）
curl -I https://localhost

# 外部测试（替换为实际IP）
curl -I http://你的服务器IP
```

> **小贴士**：`curl -I` 只获取响应头信息，不下载完整页面，适合快速测试。

### 2.3 临时vs永久配置


**临时配置**（重启后失效）：
```bash
# 临时开启HTTP（测试用）
firewall-cmd --add-service=http

# 临时开启HTTPS  
firewall-cmd --add-service=https
```

**永久配置**（重启后保持）：
```bash
# 永久配置（推荐）
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload
```

**配置对比**：
| 配置类型 | **命令特点** | **使用场景** | **优缺点** |
|---------|------------|-------------|-----------|
| 🔄 **临时配置** | `无--permanent` | `测试调试` | `立即生效，重启失效` |
| 💾 **永久配置** | `有--permanent` | `生产环境` | `需reload生效，永久保存` |

---

## 3. 🔐 Web管理端口保护


### 3.1 什么是Web管理端口


**管理端口就像后门**：
```
网站访问层次：
🌐 前台访问：用户看网页（80/443端口）
🔧 后台管理：管理员操作（特殊端口）
💻 服务器管理：系统维护（SSH等）

常见管理端口：
- 8080：Tomcat管理界面
- 9000：phpMyAdmin数据库管理  
- 3000：某些Web管理面板
- 8443：安全管理界面
```

### 3.2 限制管理端口访问


**只允许特定IP访问管理端口**：

🔸 **创建管理源IP集合**
```bash
# 创建可信管理IP列表
firewall-cmd --permanent --new-source=trusted-admin
firewall-cmd --permanent --source=trusted-admin --add-source=192.168.1.100
firewall-cmd --permanent --source=trusted-admin --add-source=10.0.0.50
```

🔸 **为管理端口设置访问限制**
```bash
# 创建管理区域
firewall-cmd --permanent --new-zone=admin-zone

# 只允许可信IP访问管理端口
firewall-cmd --permanent --zone=admin-zone --add-source=192.168.1.100
firewall-cmd --permanent --zone=admin-zone --add-port=8080/tcp

# 生效配置
firewall-cmd --reload
```

### 3.3 实用的管理端口保护策略


**策略一：办公网段保护**
```bash
# 只允许办公室网段访问管理端口
firewall-cmd --permanent --zone=trusted --add-source=192.168.1.0/24
firewall-cmd --permanent --zone=trusted --add-port=8080/tcp
firewall-cmd --permanent --zone=trusted --add-port=9000/tcp
firewall-cmd --reload
```

**策略二：VPN用户保护**
```bash
# 只允许VPN网段访问
firewall-cmd --permanent --zone=trusted --add-source=10.8.0.0/24
firewall-cmd --permanent --zone=trusted --add-service=http
firewall-cmd --permanent --zone=trusted --add-port=8080/tcp
firewall-cmd --reload
```

> **安全建议**：管理端口永远不要对公网开放，只允许可信网段或VPN用户访问。

---

## 4. 📁 静态资源访问控制


### 4.1 什么是静态资源


**静态资源通俗解释**：
```
网站文件类型：
📄 HTML文件：网页结构（index.html）
🎨 CSS文件：网页样式（style.css）  
🔧 JS文件：网页交互（script.js）
🖼️ 图片文件：网页图像（logo.png, banner.jpg）
📱 字体文件：网页字体（font.woff）
📦 压缩包：下载文件（software.zip）

特点：这些文件内容固定，不需要服务器实时生成
```

### 4.2 CDN场景的访问控制


**CDN回源保护**：当使用CDN时，只允许CDN服务器访问源站

🔸 **常见CDN厂商IP段保护**
```bash
# 阿里云CDN回源IP段（示例）
firewall-cmd --permanent --zone=public --add-rich-rule='
  rule family="ipv4" 
  source address="47.246.0.0/16" 
  port protocol="tcp" port="80" accept'

# 腾讯云CDN回源IP段（示例）  
firewall-cmd --permanent --zone=public --add-rich-rule='
  rule family="ipv4"
  source address="58.247.0.0/16"
  port protocol="tcp" port="80" accept'

firewall-cmd --reload
```

### 4.3 地区访问限制


**限制特定地区访问**：
```bash
# 禁止某些国家IP访问（需要配合ipset）
# 创建国外IP集合
firewall-cmd --permanent --new-ipset=foreign-ips --type=net

# 添加要屏蔽的IP段
firewall-cmd --permanent --ipset=foreign-ips --add-entry=185.0.0.0/8
firewall-cmd --permanent --ipset=foreign-ips --add-entry=194.0.0.0/8

# 创建屏蔽规则
firewall-cmd --permanent --add-rich-rule='
  rule family="ipv4" 
  source ipset="foreign-ips" 
  drop'

firewall-cmd --reload
```

### 4.4 文件类型访问控制


**保护敏感文件**：
```bash
# 创建Web保护区域
firewall-cmd --permanent --new-zone=web-protected

# 允许正常Web访问
firewall-cmd --permanent --zone=web-protected --add-service=http
firewall-cmd --permanent --zone=web-protected --add-service=https

# 禁止访问配置文件（在Web服务器层面配置）
# 这里主要是端口层面的保护
firewall-cmd --reload
```

---

## 5. 🔒 SSL证书端口开放


### 5.1 SSL证书服务端口


**SSL证书相关端口**：
```
证书管理端口：
🔸 443端口：HTTPS服务（必须）
🔸 80端口：HTTP重定向到HTTPS
🔸 8443端口：备用HTTPS服务
🔸 其他端口：自定义SSL服务

证书验证端口：
🔸 80端口：Let's Encrypt证书验证
🔸 443端口：证书链验证
```

### 5.2 Let's Encrypt证书配置


**自动证书申请的防火墙配置**：
```bash
# 开启证书申请必需端口
firewall-cmd --permanent --add-service=http    # 用于域名验证
firewall-cmd --permanent --add-service=https   # 用于证书应用

# 如果使用certbot的standalone模式
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp

firewall-cmd --reload
```

**证书自动更新时的临时开放**：
```bash
# 创建证书更新脚本
cat > /etc/firewall-renew-cert.sh << 'EOF'
#!/bin/bash
# 临时开放端口进行证书更新
firewall-cmd --add-port=80/tcp
certbot renew --standalone
firewall-cmd --remove-port=80/tcp
EOF

chmod +x /etc/firewall-renew-cert.sh
```

### 5.3 多域名SSL配置


**为不同域名配置不同端口**：
```bash
# 主域名使用443端口
firewall-cmd --permanent --add-service=https

# 子域名使用8443端口  
firewall-cmd --permanent --add-port=8443/tcp

# API域名使用9443端口
firewall-cmd --permanent --add-port=9443/tcp

# 管理域名使用安全端口（仅内网访问）
firewall-cmd --permanent --zone=trusted --add-port=7443/tcp

firewall-cmd --reload
```

---

## 6. 🔄 反向代理端口设置


### 6.1 什么是反向代理


**反向代理通俗解释**：
```
正向代理（翻墙）：
你 → 代理服务器 → 目标网站
(帮你访问被屏蔽的网站)

反向代理（负载均衡）：
用户 → 代理服务器 → 后端服务器1/2/3
(帮服务器分担压力)

实际场景：
用户访问 example.com:80
↓
Nginx反向代理服务器
↓  
转发到内部服务器:8080, 8081, 8082
```

### 6.2 Nginx反向代理防火墙配置


**典型的Nginx反向代理架构**：
```
公网访问流程：
互联网用户 → 防火墙 → Nginx(80/443) → 后端服务(8080/8081)

防火墙配置原则：
✅ 对外开放：80, 443端口
❌ 对外关闭：8080, 8081等后端端口  
✅ 内网开放：后端服务器间通信
```

**防火墙配置实现**：
```bash
# 开放前端代理端口（面向公网）
firewall-cmd --permanent --zone=public --add-service=http
firewall-cmd --permanent --zone=public --add-service=https

# 后端服务端口（仅内网访问）
firewall-cmd --permanent --zone=trusted --add-port=8080/tcp
firewall-cmd --permanent --zone=trusted --add-port=8081/tcp
firewall-cmd --permanent --zone=trusted --add-port=8082/tcp

# 添加内网网段到可信区域
firewall-cmd --permanent --zone=trusted --add-source=192.168.1.0/24

firewall-cmd --reload
```

### 6.3 微服务架构防火墙配置


**微服务端口规划**：
```bash
# 前端网关（对外）
firewall-cmd --permanent --zone=public --add-port=80/tcp    # HTTP网关
firewall-cmd --permanent --zone=public --add-port=443/tcp   # HTTPS网关

# 微服务端口（内网）
firewall-cmd --permanent --zone=trusted --add-port=8001/tcp # 用户服务
firewall-cmd --permanent --zone=trusted --add-port=8002/tcp # 订单服务  
firewall-cmd --permanent --zone=trusted --add-port=8003/tcp # 支付服务
firewall-cmd --permanent --zone=trusted --add-port=8004/tcp # 商品服务

# 服务发现端口
firewall-cmd --permanent --zone=trusted --add-port=8500/tcp # Consul
firewall-cmd --permanent --zone=trusted --add-port=2379/tcp # etcd

firewall-cmd --reload
```

### 6.4 负载均衡器配置


**HAProxy + Nginx组合**：
```bash
# HAProxy前端（公网访问）
firewall-cmd --permanent --zone=public --add-port=80/tcp
firewall-cmd --permanent --zone=public --add-port=443/tcp

# HAProxy管理界面（限制访问）
firewall-cmd --permanent --zone=trusted --add-port=8404/tcp

# 后端Nginx服务器（内网）
firewall-cmd --permanent --zone=trusted --add-port=8080/tcp
firewall-cmd --permanent --zone=trusted --add-port=8081/tcp

# 健康检查端口
firewall-cmd --permanent --zone=trusted --add-port=8888/tcp

firewall-cmd --reload
```

---

## 7. 🌐 CDN回源IP白名单


### 7.1 CDN回源原理


**CDN工作流程**：
```
用户请求 → CDN节点 → 源站服务器

CDN回源场景：
🔸 缓存未命中：CDN节点没有该文件
🔸 缓存过期：CDN节点文件过期需要更新  
🔸 动态内容：CDN不缓存的内容需要实时获取

安全问题：
❌ 恶意用户直接访问源站IP绕过CDN
❌ 源站暴露真实IP被攻击
✅ 只允许CDN IP访问源站
```

### 7.2 主流CDN厂商IP白名单配置


**阿里云CDN回源配置**：
```bash
# 创建阿里云CDN IP集合
firewall-cmd --permanent --new-ipset=aliyun-cdn --type=net

# 添加阿里云CDN IP段（示例，实际IP段请查阅官方文档）
firewall-cmd --permanent --ipset=aliyun-cdn --add-entry=47.246.0.0/16
firewall-cmd --permanent --ipset=aliyun-cdn --add-entry=47.250.0.0/16
firewall-cmd --permanent --ipset=aliyun-cdn --add-entry=116.211.0.0/16

# 只允许CDN IP访问Web服务
firewall-cmd --permanent --add-rich-rule='
  rule family="ipv4" 
  source ipset="aliyun-cdn" 
  port protocol="tcp" port="80" accept'

firewall-cmd --permanent --add-rich-rule='
  rule family="ipv4" 
  source ipset="aliyun-cdn" 
  port protocol="tcp" port="443" accept'
```

**腾讯云CDN回源配置**：
```bash
# 创建腾讯云CDN IP集合
firewall-cmd --permanent --new-ipset=qcloud-cdn --type=net

# 添加腾讯云CDN IP段
firewall-cmd --permanent --ipset=qcloud-cdn --add-entry=58.247.0.0/16
firewall-cmd --permanent --ipset=qcloud-cdn --add-entry=58.250.0.0/16

# 应用CDN白名单规则
firewall-cmd --permanent --add-rich-rule='
  rule family="ipv4" 
  source ipset="qcloud-cdn" 
  service name="http" accept'

firewall-cmd --reload
```

### 7.3 多CDN厂商混合配置


**使用多个CDN时的配置**：
```bash
# 创建综合CDN IP集合
firewall-cmd --permanent --new-ipset=all-cdn --type=net

# 添加多个CDN厂商IP
firewall-cmd --permanent --ipset=all-cdn --add-entry=47.246.0.0/16  # 阿里云
firewall-cmd --permanent --ipset=all-cdn --add-entry=58.247.0.0/16  # 腾讯云  
firewall-cmd --permanent --ipset=all-cdn --add-entry=36.0.0.0/8     # 网宿CDN

# 综合CDN访问规则
firewall-cmd --permanent --add-rich-rule='
  rule family="ipv4" 
  source ipset="all-cdn" 
  port protocol="tcp" port="80-443" accept'

firewall-cmd --reload
```

### 7.4 CDN IP自动更新策略


**CDN IP变更自动更新**：
```bash
# 创建CDN IP更新脚本
cat > /etc/firewall-update-cdn.sh << 'EOF'
#!/bin/bash
# CDN IP自动更新脚本

# 获取最新的CDN IP段（示例API）
curl -s https://cdn-api.example.com/ips > /tmp/cdn-ips.txt

# 清空现有CDN IP集合
firewall-cmd --permanent --ipset=all-cdn --flush

# 重新添加最新IP段
while read ip; do
    firewall-cmd --permanent --ipset=all-cdn --add-entry="$ip"
done < /tmp/cdn-ips.txt

# 重新加载配置
firewall-cmd --reload

echo "CDN IP whitelist updated: $(date)"
EOF

chmod +x /etc/firewall-update-cdn.sh

# 添加到定时任务（每天更新）
echo "0 2 * * * /etc/firewall-update-cdn.sh" >> /etc/crontab
```

---

## 8. 🛡️ 攻击IP自动封禁


### 8.1 什么是攻击IP自动封禁


**攻击识别原理**：
```
常见Web攻击行为：
🔸 暴力破解：短时间大量登录尝试
🔸 扫描攻击：访问大量不存在的页面
🔸 SQL注入：在URL中包含恶意代码
🔸 DDoS攻击：大量并发请求

自动封禁流程：
监控日志 → 发现异常 → 提取IP → 加入黑名单 → 自动解封
```

### 8.2 基于日志的攻击检测


**Nginx日志分析封IP**：
```bash
# 创建日志分析脚本
cat > /etc/firewall-auto-ban.sh << 'EOF'
#!/bin/bash

LOG_FILE="/var/log/nginx/access.log"
BAN_TIME=3600  # 封禁1小时

# 检测短时间内大量404请求（扫描行为）
awk '$9==404 {print $1}' $LOG_FILE | sort | uniq -c | \
while read count ip; do
    if [ $count -gt 50 ]; then
        echo "Banning IP $ip for excessive 404 requests ($count)"
        firewall-cmd --add-rich-rule="rule family='ipv4' source address='$ip' drop" --timeout=${BAN_TIME}
    fi
done

# 检测短时间内大量POST请求（暴力破解）
awk '$6=="POST" {print $1}' $LOG_FILE | sort | uniq -c | \
while read count ip; do
    if [ $count -gt 20 ]; then
        echo "Banning IP $ip for excessive POST requests ($count)"
        firewall-cmd --add-rich-rule="rule family='ipv4' source address='$ip' drop" --timeout=${BAN_TIME}
    fi
done
EOF

chmod +x /etc/firewall-auto-ban.sh
```

### 8.3 fail2ban集成配置


**安装和配置fail2ban**：
```bash
# 安装fail2ban
yum install fail2ban -y  # CentOS/RHEL
# 或
apt install fail2ban -y  # Ubuntu/Debian

# 配置fail2ban使用firewalld
cat > /etc/fail2ban/jail.local << 'EOF'
[DEFAULT]
banaction = firewallcmd-ipset
bantime = 3600
findtime = 600
maxretry = 5

[nginx-noscript]
enabled = true
port = http,https
filter = nginx-noscript
logpath = /var/log/nginx/access.log
maxretry = 6

[nginx-badbots]
enabled = true
port = http,https
filter = nginx-badbots
logpath = /var/log/nginx/access.log
maxretry = 2

[nginx-noproxy]
enabled = true
port = http,https
filter = nginx-noproxy
logpath = /var/log/nginx/access.log
maxretry = 2
EOF

# 启动fail2ban
systemctl enable fail2ban
systemctl start fail2ban
```

### 8.4 手动封禁和解封操作


**手动操作恶意IP**：
```bash
# 立即封禁恶意IP
firewall-cmd --add-rich-rule="rule family='ipv4' source address='恶意IP' drop"

# 永久封禁IP
firewall-cmd --permanent --add-rich-rule="rule family='ipv4' source address='恶意IP' drop"
firewall-cmd --reload

# 临时封禁IP（1小时后自动解封）
firewall-cmd --add-rich-rule="rule family='ipv4' source address='恶意IP' drop" --timeout=3600

# 封禁整个网段
firewall-cmd --permanent --add-rich-rule="rule family='ipv4' source address='192.168.100.0/24' drop"

# 解封IP
firewall-cmd --remove-rich-rule="rule family='ipv4' source address='恶意IP' drop"

# 查看当前封禁列表
firewall-cmd --list-rich-rules | grep drop
```

### 8.5 高级攻击防护


**针对特定攻击类型的防护**：
```bash
# 创建恶意IP集合
firewall-cmd --permanent --new-ipset=blacklist-ips --type=hash:ip

# 批量添加恶意IP
cat > /tmp/bad-ips.txt << 'EOF'
192.168.100.50
10.0.0.100
172.16.1.200
EOF

# 批量导入黑名单
while read ip; do
    firewall-cmd --permanent --ipset=blacklist-ips --add-entry="$ip"
done < /tmp/bad-ips.txt

# 应用黑名单规则
firewall-cmd --permanent --add-rich-rule='
  rule family="ipv4" 
  source ipset="blacklist-ips" 
  drop'

firewall-cmd --reload
```

---

## 9. 📊 Web服务监控配置


### 9.1 防火墙状态监控


**监控防火墙规则和连接**：
```bash
# 查看当前活跃连接
ss -tuln | grep :80
ss -tuln | grep :443

# 监控防火墙日志
tail -f /var/log/firewalld

# 查看被拒绝的连接（需要启用日志）
firewall-cmd --set-log-denied=all
journalctl -f -u firewalld

# 统计连接数
netstat -an | grep :80 | wc -l
netstat -an | grep :443 | wc -l
```

### 9.2 Web访问监控配置


**开启必要的监控端口**：
```bash
# 开启监控相关端口
firewall-cmd --permanent --zone=trusted --add-port=9090/tcp  # Prometheus
firewall-cmd --permanent --zone=trusted --add-port=3000/tcp  # Grafana
firewall-cmd --permanent --zone=trusted --add-port=9115/tcp  # Blackbox exporter

# 限制监控服务访问
firewall-cmd --permanent --zone=trusted --add-source=192.168.1.0/24
firewall-cmd --reload
```

### 9.3 实时流量监控


**监控Web流量状态**：
```bash
# 创建流量监控脚本
cat > /etc/monitor-web-traffic.sh << 'EOF'
#!/bin/bash

echo "=== Web服务器流量监控 ==="
echo "时间: $(date)"
echo

# HTTP连接统计
echo "HTTP连接数:"
ss -tuln | grep :80 | wc -l

# HTTPS连接统计  
echo "HTTPS连接数:"
ss -tuln | grep :443 | wc -l

# 当前活跃连接的IP统计
echo "最活跃的前10个IP:"
ss -tn | awk 'NR>1 {print $5}' | cut -d: -f1 | sort | uniq -c | sort -nr | head -10

# 防火墙拒绝统计
echo "最近被拒绝的IP:"
journalctl -u firewalld --since "1 hour ago" | grep REJECT | tail -5

echo "========================="
EOF

chmod +x /etc/monitor-web-traffic.sh

# 设置定时监控
echo "*/5 * * * * /etc/monitor-web-traffic.sh >> /var/log/web-traffic.log" >> /etc/crontab
```

### 9.4 告警配置


**异常情况自动告警**：
```bash
# 创建告警脚本
cat > /etc/firewall-alert.sh << 'EOF'
#!/bin/bash

ALERT_EMAIL="admin@example.com"
MAX_CONNECTIONS=1000

# 检查连接数是否超限
HTTP_CONN=$(ss -tuln | grep :80 | wc -l)
HTTPS_CONN=$(ss -tuln | grep :443 | wc -l)
TOTAL_CONN=$((HTTP_CONN + HTTPS_CONN))

if [ $TOTAL_CONN -gt $MAX_CONNECTIONS ]; then
    echo "警告: Web连接数过高 ($TOTAL_CONN)" | \
    mail -s "Web服务器连接数告警" $ALERT_EMAIL
fi

# 检查是否有大量被拒绝的连接
REJECTED_COUNT=$(journalctl -u firewalld --since "5 minutes ago" | grep REJECT | wc -l)

if [ $REJECTED_COUNT -gt 50 ]; then
    echo "警告: 5分钟内有 $REJECTED_COUNT 个连接被拒绝" | \
    mail -s "防火墙拒绝连接告警" $ALERT_EMAIL
fi
EOF

chmod +x /etc/firewall-alert.sh

# 每分钟检查一次
echo "* * * * * /etc/firewall-alert.sh" >> /etc/crontab
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的基本概念


```
🔸 Web服务端口：80(HTTP)、443(HTTPS)是基础，8080/8443是备用
🔸 管理端口保护：永远不要对公网开放管理端口，只允许可信网段
🔸 反向代理架构：对外开放代理端口，对内保护后端服务端口  
🔸 CDN回源保护：只允许CDN厂商IP访问源站，隐藏真实服务器
🔸 自动封禁：通过日志分析识别攻击行为，自动封禁恶意IP
🔸 监控告警：实时监控流量和防火墙状态，异常时及时告警
```

### 10.2 关键理解要点


**🔹 Web防火墙的防护层次**
```
第一层：网络层防护
• 端口访问控制
• IP白名单/黑名单
• 流量限制

第二层：应用层防护  
• Web服务配置
• SSL证书管理
• 反向代理设置

第三层：监控预警
• 实时流量监控
• 攻击行为检测
• 自动响应处理
```

**🔹 安全配置的平衡点**
```
安全性 vs 可用性：
✅ 既要保护服务器安全
✅ 又要保证用户正常访问
✅ 合理的白名单策略
✅ 灵活的临时调整机制

性能 vs 保护：
✅ 防火墙规则不能太复杂
✅ 影响正常访问性能
✅ 适度的监控频率
✅ 必要的自动化处理
```

### 10.3 实际应用最佳实践


**🎯 生产环境配置步骤**
```
1️⃣ 基础配置：
   • 开启必要的Web服务端口(80/443)
   • 关闭不需要的默认端口
   • 配置SSH访问限制

2️⃣ 业务配置：
   • 根据架构开放内部通信端口
   • 配置CDN回源IP白名单
   • 设置管理端口访问限制

3️⃣ 安全加固：
   • 部署自动封禁系统
   • 配置攻击检测规则
   • 建立监控告警机制

4️⃣ 持续优化：
   • 定期更新IP白名单
   • 分析日志优化规则
   • 调整封禁策略
```

**🛠️ 故障排查指南**
```
网站无法访问：
1. 检查防火墙是否开启Web端口
2. 确认服务是否正常运行
3. 查看是否被误封IP

CDN回源失败：
1. 验证CDN IP是否在白名单
2. 检查源站端口是否开放
3. 确认CDN配置是否正确

管理界面无法访问：
1. 确认管理端口配置
2. 检查访问来源IP是否可信
3. 验证VPN连接状态
```

**⚠️ 常见错误和注意事项**
```
❌ 常见错误：
• 忘记reload使配置生效
• 管理端口对公网开放
• CDN IP白名单不完整
• 封禁规则过于严格

✅ 最佳实践：
• 配置前做好备份
• 使用临时规则测试
• 建立应急解封机制
• 定期检查规则有效性
```

**核心记忆口诀**：
- Web防护端口八零四四三，管理端口内网限
- CDN回源要白名单，恶意IP要封禁
- 监控告警保平安，规则优化要持续
- 安全可用两平衡，故障排查有步骤