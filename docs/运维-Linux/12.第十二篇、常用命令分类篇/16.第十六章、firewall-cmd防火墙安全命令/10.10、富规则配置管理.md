---
title: 10、富规则配置管理
---
## 📚 目录

1. [富规则基础概念](#1-富规则基础概念)
2. [富规则语法结构](#2-富规则语法结构)
3. [基本富规则操作](#3-基本富规则操作)
4. [地址族与源地址配置](#4-地址族与源地址配置)
5. [目标地址与端口设置](#5-目标地址与端口设置)
6. [动作定义与高级配置](#6-动作定义与高级配置)
7. [实战案例与最佳实践](#7-实战案例与最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🎯 富规则基础概念


### 1.1 什么是富规则


**🏠 生活类比**
> 想象你家的门禁系统。普通规则就像"允许所有朋友进入"，而富规则就像"只允许张三在周末晚上7点到9点从前门进入客厅，但不能进入卧室"

**📋 富规则定义**
```
富规则（Rich Rules）：firewalld的高级规则配置功能
作用：提供比基本规则更精细、更灵活的网络访问控制
特点：可以精确指定源地址、目标地址、端口、协议、时间等多个条件
```

### 1.2 为什么需要富规则


**🔸 普通规则的局限性**
```
普通规则示例：
firewall-cmd --add-service=ssh
↓
结果：允许所有人通过SSH连接

问题：无法区分来源，安全性不够高
```

**🔸 富规则的优势**
```
富规则示例：
只允许192.168.1.100这台机器通过SSH连接
↓
实现：精确控制访问来源，提高安全性

优势：
• 精细化控制：可以指定具体的源IP、端口等
• 灵活配置：支持复杂的组合条件
• 安全性高：最小权限原则的完美体现
```

### 1.3 富规则与普通规则的对比


| 特性 | **普通规则** | **富规则** | **适用场景** |
|------|-------------|------------|-------------|
| 🎯 **精确度** | `粗粒度控制` | `细粒度控制` | `富规则适合企业环境` |
| ⚡ **配置复杂度** | `简单易用` | `相对复杂` | `普通规则适合个人用户` |
| 🔒 **安全性** | `基础防护` | `高级防护` | `富规则提供更强安全性` |
| 🛠️ **灵活性** | `有限条件` | `多条件组合` | `富规则支持复杂场景` |

---

## 2. 📝 富规则语法结构


### 2.1 完整语法格式


**📋 富规则语法模板**
```
rule [family="<family>"]
    [source address="<address>" [invert="<invert>"]]
    [destination address="<address>" [invert="<invert>"]]
    [<element>]
    <action>
```

**🔍 语法要素解析**
```
family：     IP协议族（ipv4/ipv6）
source：     源地址配置
destination：目标地址配置
element：    协议元素（service/port/protocol等）
action：     执行动作（accept/reject/drop）
```

### 2.2 语法要素详解


**🌐 地址族（Family）**
```
作用：指定IP协议版本
选项：
• family="ipv4" - IPv4协议（默认）
• family="ipv6" - IPv6协议

实例：
rule family="ipv4" source address="192.168.1.0/24" accept
rule family="ipv6" source address="2001:db8::/32" accept
```

**📍 地址配置格式**
```
单个IP：     address="192.168.1.100"
网段：       address="192.168.1.0/24"
IPv6地址：   address="2001:db8::1"
IPv6网段：   address="2001:db8::/32"
取反：       address="192.168.1.0/24" invert="true"
```

**⚡ 动作类型**
```
accept：  允许通过（相当于开绿灯）
reject：  拒绝并返回错误信息（有礼貌的拒绝）
drop：    直接丢弃，不返回任何信息（无声拒绝）
```

### 2.3 语法组合示例


**🎯 基础语法示例**
```
# 允许特定IP访问SSH
rule source address="192.168.1.100" service name="ssh" accept

# 拒绝某个网段访问HTTP
rule source address="10.0.0.0/8" service name="http" reject

# 丢弃来自公网的特定端口访问
rule source address="0.0.0.0/0" port port="3389" protocol="tcp" drop
```

---

## 3. 🛠️ 基本富规则操作


### 3.1 添加富规则


**🔸 --add-rich-rule 命令详解**
```
基本语法：
firewall-cmd --add-rich-rule='规则内容'

临时添加：
firewall-cmd --add-rich-rule='rule source address="192.168.1.100" accept'

永久添加：
firewall-cmd --permanent --add-rich-rule='rule source address="192.168.1.100" accept'
```

**💡 实用添加示例**
```bash
# 1. 允许特定IP访问SSH服务
firewall-cmd --add-rich-rule='rule source address="192.168.1.100" service name="ssh" accept'

# 2. 允许整个内网访问HTTP服务
firewall-cmd --add-rich-rule='rule source address="192.168.0.0/16" service name="http" accept'

# 3. 拒绝特定IP的所有访问
firewall-cmd --add-rich-rule='rule source address="192.168.1.200" reject'
```

### 3.2 移除富规则


**🔸 --remove-rich-rule 命令使用**
```
基本语法：
firewall-cmd --remove-rich-rule='规则内容'

注意：移除时必须提供完全相同的规则内容
```

**🗑️ 移除示例操作**
```bash
# 移除之前添加的SSH访问规则
firewall-cmd --remove-rich-rule='rule source address="192.168.1.100" service name="ssh" accept'

# 永久移除规则
firewall-cmd --permanent --remove-rich-rule='rule source address="192.168.1.100" service name="ssh" accept'

# 重新加载配置使永久更改生效
firewall-cmd --reload
```

### 3.3 查看富规则


**🔸 --list-rich-rules 命令详解**
```
查看当前活动的富规则：
firewall-cmd --list-rich-rules

查看永久配置的富规则：
firewall-cmd --permanent --list-rich-rules

指定区域查看：
firewall-cmd --zone=public --list-rich-rules
```

**📊 查看结果示例**
```bash
$ firewall-cmd --list-rich-rules
rule source address="192.168.1.100" service name="ssh" accept
rule source address="192.168.0.0/16" service name="http" accept
rule source address="10.0.0.0/8" reject
```

### 3.4 规则生效管理


**⚡ 临时vs永久规则**
```
临时规则特点：
• 立即生效
• 重启后失效
• 适合测试场景

永久规则特点：
• 需要reload才生效
• 重启后保持
• 适合生产环境
```

**🔄 规则生效操作流程**
```
步骤1：添加永久规则
firewall-cmd --permanent --add-rich-rule='规则内容'

步骤2：重新加载配置
firewall-cmd --reload

步骤3：验证规则生效
firewall-cmd --list-rich-rules
```

---

## 4. 🌐 地址族与源地址配置


### 4.1 地址族配置详解


**🔸 IPv4 地址族配置**
```
默认配置：
不指定family时，默认使用ipv4

显式指定：
rule family="ipv4" source address="192.168.1.0/24" accept

适用场景：
• 传统网络环境
• 内网访问控制
• 大多数服务器场景
```

**🔸 IPv6 地址族配置**
```
IPv6格式示例：
rule family="ipv6" source address="2001:db8::1" service name="ssh" accept

常见IPv6地址：
• 单播地址：2001:db8::1
• 网段地址：2001:db8::/32
• 本地地址：::1（相当于IPv4的127.0.0.1）
```

**📋 地址族对比表**

| 地址族 | **地址格式** | **网段表示** | **使用场景** |
|--------|-------------|-------------|-------------|
| 🔸 **IPv4** | `192.168.1.1` | `192.168.1.0/24` | `传统网络、内网` |
| 🔸 **IPv6** | `2001:db8::1` | `2001:db8::/32` | `现代网络、公网` |

### 4.2 源地址配置方式


**🏠 单个IP地址配置**
```bash
# 允许特定办公室IP访问
firewall-cmd --add-rich-rule='rule source address="203.0.113.10" accept'

# 拒绝特定恶意IP
firewall-cmd --add-rich-rule='rule source address="198.51.100.50" reject'
```

**🏢 网段地址配置**
```bash
# 允许整个办公网络
firewall-cmd --add-rich-rule='rule source address="192.168.1.0/24" service name="ssh" accept'

# 允许多个分支机构网段
firewall-cmd --add-rich-rule='rule source address="10.0.0.0/8" accept'

# 允许小范围网段
firewall-cmd --add-rich-rule='rule source address="192.168.1.0/28" service name="http" accept'
```

### 4.3 源地址取反配置


**🔄 invert 参数使用**
```
作用：取反源地址条件
效果：除了指定地址外的所有地址

语法：
source address="地址" invert="true"
```

**💡 取反配置实例**
```bash
# 除了内网外，拒绝所有其他地址访问SSH
firewall-cmd --add-rich-rule='rule source address="192.168.0.0/16" invert="true" service name="ssh" reject'

# 除了管理员IP外，其他人无法访问管理端口
firewall-cmd --add-rich-rule='rule source address="192.168.1.100" invert="true" port port="8080" protocol="tcp" drop'
```

**⚠️ 取反使用注意事项**
```
安全提醒：
• 取反规则要谨慎使用
• 可能意外阻断正常访问
• 建议先测试再永久应用

最佳实践：
• 先添加允许规则
• 再添加取反拒绝规则
• 确保管理访问不被阻断
```

---

## 5. 🎯 目标地址与端口设置


### 5.1 目标地址配置


**🔸 目标地址的作用**
```
实际场景：
服务器有多个网卡，多个IP地址
需要控制客户端访问哪个具体IP地址

例如：
eth0: 192.168.1.10 (内网接口)
eth1: 203.0.113.10 (公网接口)
```

**📍 目标地址配置语法**
```bash
# 只允许访问内网接口的SSH
firewall-cmd --add-rich-rule='rule destination address="192.168.1.10" service name="ssh" accept'

# 只允许通过公网接口访问Web服务
firewall-cmd --add-rich-rule='rule destination address="203.0.113.10" service name="http" accept'

# 组合源和目标地址
firewall-cmd --add-rich-rule='rule source address="192.168.1.0/24" destination address="192.168.1.10" service name="ssh" accept'
```

### 5.2 端口配置详解


**🔌 端口配置语法**
```
单个端口：
port port="端口号" protocol="协议"

端口范围：
port port="起始端口-结束端口" protocol="协议"

协议选择：
• tcp：TCP协议（Web、SSH、数据库等）
• udp：UDP协议（DNS、视频流等）
```

**💻 端口配置实例**
```bash
# 允许特定IP访问自定义SSH端口
firewall-cmd --add-rich-rule='rule source address="192.168.1.100" port port="2222" protocol="tcp" accept'

# 允许内网访问数据库端口
firewall-cmd --add-rich-rule='rule source address="192.168.0.0/16" port port="3306" protocol="tcp" accept'

# 开放端口范围给特定网段
firewall-cmd --add-rich-rule='rule source address="192.168.1.0/24" port port="8000-8010" protocol="tcp" accept'
```

### 5.3 服务与端口的区别


**🔸 使用服务名 vs 使用端口号**

| 方式 | **优点** | **缺点** | **适用场景** |
|------|---------|---------|-------------|
| 🎯 **服务名** | `语义清晰，易维护` | `受预定义服务限制` | `标准服务（ssh、http等）` |
| 🔌 **端口号** | `灵活自由，支持自定义` | `需要记住端口号` | `自定义服务、非标准端口` |

**📝 对比示例**
```bash
# 方式1：使用服务名（推荐标准服务）
firewall-cmd --add-rich-rule='rule source address="192.168.1.100" service name="ssh" accept'

# 方式2：使用端口号（自定义服务）
firewall-cmd --add-rich-rule='rule source address="192.168.1.100" port port="22" protocol="tcp" accept'

# 方式3：自定义端口必须用端口号
firewall-cmd --add-rich-rule='rule source address="192.168.1.100" port port="2222" protocol="tcp" accept'
```

---

## 6. ⚡ 动作定义与高级配置


### 6.1 三种动作详解


**🟢 accept 动作**
```
作用：允许数据包通过
特点：
• 明确放行指定流量
• 类似绿灯，直接通过
• 最常用的允许动作

使用场景：
• 允许可信IP访问
• 开放必要服务端口
• 建立白名单规则
```

**🟡 reject 动作**
```
作用：拒绝数据包并返回错误信息
特点：
• 有礼貌的拒绝方式
• 客户端会收到连接被拒绝的提示
• 便于故障排查

使用场景：
• 明确拒绝某些访问
• 调试网络连接问题
• 给用户明确的反馈
```

**🔴 drop 动作**
```
作用：直接丢弃数据包，不返回任何信息
特点：
• 静默拒绝方式
• 客户端会超时等待
• 隐蔽性好，不暴露服务存在

使用场景：
• 防范恶意扫描
• 隐藏服务端口
• 安全性要求高的环境
```

### 6.2 动作选择策略


**📊 动作使用对比**

| 动作类型 | **响应速度** | **安全性** | **调试友好度** | **推荐场景** |
|---------|-------------|-----------|---------------|-------------|
| 🟢 **accept** | `快速通过` | `中等` | `高` | `正常业务流量` |
| 🟡 **reject** | `快速拒绝` | `中等` | `高` | `明确拒绝场景` |
| 🔴 **drop** | `超时等待` | `高` | `低` | `防恶意扫描` |

**🎯 实际选择建议**
```
内网环境：
• 多用accept和reject
• 便于故障排查
• 用户体验好

公网环境：
• 敏感端口用drop
• 隐藏服务信息
• 防范恶意扫描

测试环境：
• 优先使用reject
• 方便调试问题
• 快速定位故障
```

### 6.3 高级动作配置


**🔥 限制连接速率**
```bash
# 限制SSH连接频率（防暴力破解）
firewall-cmd --add-rich-rule='rule service name="ssh" accept limit value="3/m"'

# 限制HTTP连接速率
firewall-cmd --add-rich-rule='rule service name="http" accept limit value="10/s"'
```

**⏰ 时间限制规则**
```bash
# 只在工作时间允许访问（需要更复杂的脚本配合）
# 这里展示概念，实际实现可能需要cron配合

# 工作日规则（概念示例）
firewall-cmd --add-rich-rule='rule source address="192.168.1.0/24" service name="ssh" accept'
```

**🔄 日志记录配置**
```bash
# 记录被拒绝的连接
firewall-cmd --add-rich-rule='rule source address="0.0.0.0/0" service name="telnet" log prefix="TELNET-REJECT" level="info" reject'

# 记录可疑端口访问
firewall-cmd --add-rich-rule='rule port port="3389" protocol="tcp" log prefix="RDP-ATTEMPT" level="warning" drop'
```

---

## 7. 🚀 实战案例与最佳实践


### 7.1 Web服务器安全配置


**🏢 场景描述**
```
需求：
• 只允许办公网络访问SSH管理
• 允许全网访问Web服务
• 拒绝特定恶意IP段
• 限制数据库访问仅来自应用服务器
```

**🛠️ 配置实现**
```bash
# 1. 只允许办公网络SSH访问
firewall-cmd --permanent --add-rich-rule='rule source address="192.168.1.0/24" service name="ssh" accept'

# 2. 拒绝其他来源的SSH访问
firewall-cmd --permanent --add-rich-rule='rule source address="192.168.1.0/24" invert="true" service name="ssh" reject'

# 3. 允许全网HTTP/HTTPS访问
firewall-cmd --permanent --add-rich-rule='rule service name="http" accept'
firewall-cmd --permanent --add-rich-rule='rule service name="https" accept'

# 4. 只允许应用服务器访问数据库
firewall-cmd --permanent --add-rich-rule='rule source address="192.168.1.50" port port="3306" protocol="tcp" accept'

# 5. 拒绝恶意IP段
firewall-cmd --permanent --add-rich-rule='rule source address="185.0.0.0/8" drop'

# 6. 应用配置
firewall-cmd --reload
```

### 7.2 企业内网访问控制


**🏭 企业网络场景**
```
网络拓扑：
• 管理网段：192.168.10.0/24
• 办公网段：192.168.20.0/24  
• 服务器网段：192.168.30.0/24
• 访客网段：192.168.40.0/24
```

**🔐 分层访问控制**
```bash
# 管理网段：允许所有访问
firewall-cmd --permanent --add-rich-rule='rule source address="192.168.10.0/24" accept'

# 办公网段：允许Web和SSH
firewall-cmd --permanent --add-rich-rule='rule source address="192.168.20.0/24" service name="ssh" accept'
firewall-cmd --permanent --add-rich-rule='rule source address="192.168.20.0/24" service name="http" accept'

# 服务器网段：允许特定服务通信
firewall-cmd --permanent --add-rich-rule='rule source address="192.168.30.0/24" port port="3306" protocol="tcp" accept'

# 访客网段：仅允许Web访问
firewall-cmd --permanent --add-rich-rule='rule source address="192.168.40.0/24" service name="http" accept'
firewall-cmd --permanent --add-rich-rule='rule source address="192.168.40.0/24" service name="https" accept'

# 拒绝访客访问其他服务
firewall-cmd --permanent --add-rich-rule='rule source address="192.168.40.0/24" service name="ssh" reject'
```

### 7.3 应急响应配置


**🚨 紧急阻断恶意IP**
```bash
# 发现攻击时快速阻断
firewall-cmd --add-rich-rule='rule source address="恶意IP" drop'

# 阻断整个恶意网段
firewall-cmd --add-rich-rule='rule source address="恶意网段/24" drop'

# 紧急情况：只允许管理员IP访问
firewall-cmd --add-rich-rule='rule source address="管理员IP" accept'
firewall-cmd --add-rich-rule='rule source address="管理员IP" invert="true" drop'
```

### 7.4 配置管理最佳实践


**📝 配置管理流程**
```
1. 规划阶段：
   • 梳理业务需求
   • 设计访问策略
   • 制定安全规则

2. 测试阶段：
   • 先添加临时规则
   • 验证业务功能
   • 确认安全效果

3. 部署阶段：
   • 添加永久规则
   • 重新加载配置
   • 监控运行状态

4. 维护阶段：
   • 定期审查规则
   • 清理无用规则
   • 优化性能表现
```

**🔄 规则管理技巧**
```bash
# 备份当前配置
firewall-cmd --list-rich-rules > firewall-rules-backup.txt

# 批量删除规则（小心使用）
for rule in $(firewall-cmd --list-rich-rules); do
    firewall-cmd --remove-rich-rule="$rule"
done

# 验证规则有效性
firewall-cmd --check-config

# 查看规则统计
firewall-cmd --info-zone=public
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 富规则本质：精细化的网络访问控制工具
🔸 基本语法：family + source/destination + element + action
🔸 核心命令：--add-rich-rule / --remove-rich-rule / --list-rich-rules
🔸 三种动作：accept（允许）/ reject（拒绝并通知）/ drop（静默丢弃）
🔸 地址配置：支持单IP、网段、IPv6以及取反操作
🔸 永久生效：--permanent + --reload 的组合使用
```

### 8.2 关键理解要点


**🔹 富规则vs普通规则的选择**
```
使用富规则的情况：
• 需要指定具体源IP或网段
• 需要组合多个条件
• 安全要求较高的环境
• 需要精细化访问控制

使用普通规则的情况：
• 简单的服务开放
• 个人环境或测试环境
• 不需要复杂条件判断
```

**🔹 安全配置原则**
```
最小权限原则：
• 只开放必要的服务和端口
• 尽可能限制访问来源
• 定期审查和清理规则

分层防护原则：
• 网络层 + 主机层防护
• 外网 + 内网分别配置
• 管理 + 业务分离

应急响应原则：
• 保留管理员访问通道
• 准备紧急阻断方案
• 建立配置回滚机制
```

### 8.3 实际应用价值


**🎯 业务场景应用**
- **Web服务器**：精确控制访问来源，提高安全性
- **数据库服务器**：限制应用服务器访问，防止数据泄露
- **管理服务器**：只允许运维人员访问，降低风险
- **堡垒机**：实现跳板访问控制，满足审计要求

**🔧 运维实践技巧**
- **渐进配置**：先临时测试，后永久应用
- **文档记录**：详细记录规则用途和修改历史
- **监控告警**：关注规则命中情况和异常访问
- **定期审查**：清理过期规则，优化配置性能

### 8.4 常见问题与解决


**❓ 常见配置问题**
```
问题1：规则不生效
解决：检查是否--reload，确认zone是否正确

问题2：误删重要规则
解决：事先备份配置，使用版本控制

问题3：规则冲突
解决：理解规则优先级，合理安排规则顺序

问题4：性能影响
解决：避免过多复杂规则，定期清理无用规则
```

**🛡️ 安全注意事项**
```
防止误操作：
• 保持管理员访问通道
• 测试规则后再永久应用
• 建立紧急恢复方案

监控和审计：
• 启用日志记录
• 定期检查规则合理性
• 关注异常访问模式

性能考虑：
• 避免过于复杂的规则
• 将常用规则放在前面
• 定期清理无用配置
```

**🎯 一分钟掌握富规则**
```
1. 理解语法：source + element + action
2. 掌握三个核心命令：add / remove / list
3. 记住三种动作：accept / reject / drop
4. 遵循安全原则：最小权限 + 分层防护
5. 养成良好习惯：测试 → 永久 → 备份
```

**💡 记忆口诀**
> 富规则精细控制强，源地址动作要配上  
> 临时测试永久存，重载生效记心上  
> 三种动作各不同，安全运维两手抓

**核心记忆**：
- 富规则让防火墙变得智能，能够识别"谁"要访问"什么"
- 语法虽然看起来复杂，但遵循"来源-服务-动作"的逻辑
- 安全配置的核心是最小权限原则
- 生产环境必须先测试，再永久应用