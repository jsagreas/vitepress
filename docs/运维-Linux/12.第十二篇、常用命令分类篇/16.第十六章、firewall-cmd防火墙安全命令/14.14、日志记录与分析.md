---
title: 14、日志记录与分析
---
## 📚 目录

1. [日志记录基础概念](#1-日志记录基础概念)
2. [日志设置与配置](#2-日志设置与配置)
3. [日志文件位置与格式](#3-日志文件位置与格式)
4. [日志查看与分析方法](#4-日志查看与分析方法)
5. [实际应用场景](#5-实际应用场景)
6. [故障排查实战](#6-故障排查实战)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔍 日志记录基础概念


### 1.1 什么是防火墙日志


**简单理解：** 防火墙日志就像门卫的记录本，记录着谁来敲门、什么时间来的、让不让进等信息。

```
生活类比：
酒店门卫记录本：
- 10:30 张三来访，已放行进入
- 10:35 可疑人员，已拒绝入内
- 10:40 快递员送货，已放行

防火墙日志：
- 10:30 SSH连接请求，已允许
- 10:35 未知端口扫描，已拒绝
- 10:40 HTTP访问请求，已允许
```

**🔸 日志的作用：**
- **安全监控**：发现可疑攻击行为
- **故障排查**：找出连接失败的原因
- **性能分析**：了解网络流量情况
- **合规审计**：满足安全管理要求

### 1.2 日志记录机制


**工作原理图：**
```
网络请求 → 防火墙规则检查 → 记录日志 → 执行动作
    ↓              ↓               ↓          ↓
客户端访问    规则匹配判断      写入日志文件   允许/拒绝
```

**🔸 记录内容包括：**
- **时间戳**：什么时候发生的
- **源IP**：请求来自哪里
- **目标端口**：访问什么服务
- **动作结果**：允许还是拒绝
- **规则信息**：匹配了哪条规则

---

## 2. ⚙️ 日志设置与配置


### 2.1 开启拒绝日志记录


**基本概念：** 默认情况下，防火墙只记录允许的连接，被拒绝的请求不会记录。我们需要手动开启拒绝日志。

**🔧 设置拒绝日志记录：**
```bash
# 开启所有拒绝请求的日志记录

firewall-cmd --set-log-denied=all

# 只记录单播包的拒绝日志（推荐）

firewall-cmd --set-log-denied=unicast

# 关闭拒绝日志记录

firewall-cmd --set-log-denied=off
```

**💡 参数说明：**
- `all`：记录所有被拒绝的包（包括广播包）
- `unicast`：只记录单播包（点对点通信），过滤掉广播噪音
- `multicast`：只记录组播包
- `broadcast`：只记录广播包
- `off`：不记录拒绝日志

**🎯 实际使用建议：**
```bash
# 大多数情况下使用unicast就够了

firewall-cmd --set-log-denied=unicast
firewall-cmd --runtime-to-permanent
```

### 2.2 查看当前日志设置


```bash
# 查看当前拒绝日志设置

firewall-cmd --get-log-denied

# 输出示例：unicast

```

### 2.3 日志级别设置


**配置文件修改：** `/etc/firewalld/firewalld.conf`

```bash
# 编辑配置文件

sudo vim /etc/firewalld/firewalld.conf

# 找到以下配置项

LogDenied=unicast          # 拒绝日志类型
FirewallBackend=nftables   # 防火墙后端
```

**重启服务使配置生效：**
```bash
sudo systemctl restart firewalld
```

---

## 3. 📂 日志文件位置与格式


### 3.1 主要日志文件位置


**🔸 系统日志位置：**
```
/var/log/messages    # CentOS/RHEL 系统日志
/var/log/syslog      # Ubuntu/Debian 系统日志
/var/log/firewalld   # firewalld专用日志目录
```

**🔸 systemd日志：**
```bash
# 使用journalctl查看（推荐方式）

journalctl -u firewalld
```

### 3.2 日志格式解析


**典型日志条目：**
```
Jan 21 10:30:15 server01 kernel: FINAL_REJECT: IN=eth0 OUT= MAC=00:0c:29:xx:xx:xx SRC=192.168.1.100 DST=192.168.1.10 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=12345 DF PROTO=TCP SPT=35678 DPT=22 WINDOW=64240 RES=0x00 SYN URGP=0
```

**🔍 字段含义解析：**
| 字段 | 含义 | 示例值 | 说明 |
|------|------|--------|------|
| `Jan 21 10:30:15` | 时间戳 | 1月21日10:30:15 | 事件发生时间 |
| `FINAL_REJECT` | 动作类型 | 最终拒绝 | 表示被防火墙拒绝 |
| `IN=eth0` | 入口网卡 | eth0网卡 | 数据包从哪个网卡进入 |
| `SRC=192.168.1.100` | 源IP地址 | 192.168.1.100 | 请求来源IP |
| `DST=192.168.1.10` | 目标IP地址 | 192.168.1.10 | 请求目标IP |
| `PROTO=TCP` | 协议类型 | TCP协议 | 使用的网络协议 |
| `SPT=35678` | 源端口 | 35678 | 发起连接的端口 |
| `DPT=22` | 目标端口 | 22 | 尝试访问的服务端口 |

### 3.3 常见日志类型


**🔸 拒绝日志标识：**
```
FINAL_REJECT    # 被防火墙规则拒绝
REJECT_ICMP     # ICMP包被拒绝
DROP            # 静默丢弃（无响应）
```

**🔸 允许日志标识：**
```
ACCEPT          # 连接被允许
FORWARD         # 数据包被转发
```

---

## 4. 🔎 日志查看与分析方法


### 4.1 使用journalctl查看日志


**🔸 基本查看命令：**
```bash
# 查看firewalld服务日志

journalctl -u firewalld

# 查看最近的日志（最新50条）

journalctl -u firewalld -n 50

# 实时监控日志

journalctl -u firewalld -f
```

**🔸 按时间范围查看：**
```bash
# 查看今天的日志

journalctl -u firewalld --since today

# 查看最近一小时的日志

journalctl -u firewalld --since "1 hour ago"

# 查看指定时间段的日志

journalctl -u firewalld --since "2025-01-21 09:00:00" --until "2025-01-21 12:00:00"
```

### 4.2 过滤和搜索日志


**🔸 关键词过滤：**
```bash
# 只看拒绝的连接

journalctl -u firewalld | grep REJECT

# 查看特定IP的访问记录

journalctl -u firewalld | grep "192.168.1.100"

# 查看特定端口的访问

journalctl -u firewalld | grep "DPT=22"
```

**🔸 组合过滤示例：**
```bash
# 查看被拒绝的SSH连接尝试

journalctl -u firewalld | grep -E "REJECT.*DPT=22"

# 查看来自外网的访问尝试

journalctl -u firewalld | grep -v "192.168"
```

### 4.3 使用传统日志文件


```bash
# 查看系统日志中的防火墙信息

sudo tail -f /var/log/messages | grep firewalld

# 搜索特定内容

sudo grep "REJECT" /var/log/messages | tail -20

# 查看今天的拒绝记录

sudo grep "$(date +%b\ %d)" /var/log/messages | grep REJECT
```

### 4.4 实时监控技巧


**🔸 多终端监控：**
```bash
# 终端1：实时监控所有firewalld日志

journalctl -u firewalld -f

# 终端2：实时监控拒绝日志

journalctl -f | grep REJECT

# 终端3：监控特定服务端口

journalctl -f | grep "DPT=80\|DPT=443"
```

---

## 5. 🎯 实际应用场景


### 5.1 安全监控场景


**场景：发现可疑扫描行为**

```bash
# 查看端口扫描行为

journalctl -u firewalld --since "1 hour ago" | grep REJECT | \
awk '{print $8}' | cut -d'=' -f2 | sort | uniq -c | sort -nr

# 输出示例：

#   15 192.168.1.100    # 这个IP被拒绝了15次，可能在扫描

#    3 10.0.0.50

#    1 172.16.1.20

```

**🔍 分析步骤：**
1. **识别高频IP**：找出被拒绝次数最多的IP
2. **查看尝试端口**：确认扫描的目标端口
3. **时间分析**：判断是否为密集扫描
4. **决定处理**：是否需要封禁该IP

### 5.2 故障排查场景


**场景：用户无法连接服务**

**🔧 排查步骤：**

```bash
# 1. 检查是否有拒绝日志

journalctl -u firewalld --since "10 minutes ago" | grep "SRC=用户IP"

# 2. 检查特定端口的访问

journalctl -u firewalld | grep "DPT=目标端口" | tail -10

# 3. 查看当前防火墙规则

firewall-cmd --list-all
```

**💡 常见问题分析：**
```
情况1：有REJECT日志 → 防火墙规则阻止了连接
解决：添加允许规则

情况2：无任何日志 → 可能服务本身没启动
解决：检查服务状态

情况3：有ACCEPT但仍失败 → 可能是应用层问题
解决：检查应用配置
```

### 5.3 性能分析场景


**场景：分析网络流量模式**

```bash
# 分析最活跃的源IP

journalctl -u firewalld --since today | \
grep -o 'SRC=[0-9.]*' | sort | uniq -c | sort -nr | head -10

# 分析最常访问的端口

journalctl -u firewalld --since today | \
grep -o 'DPT=[0-9]*' | sort | uniq -c | sort -nr | head -10

# 统计拒绝连接的数量

journalctl -u firewalld --since today | grep -c REJECT
```

---

## 6. 🚨 故障排查实战


### 6.1 常见问题诊断


**问题1：SSH连接被拒绝**

```bash
# 检查SSH相关的拒绝日志

journalctl -u firewalld | grep "DPT=22" | grep REJECT | tail -5

# 查看当前SSH规则

firewall-cmd --list-services | grep ssh
firewall-cmd --list-ports | grep 22

# 解决方案

firewall-cmd --add-service=ssh --permanent
firewall-cmd --reload
```

**问题2：Web服务无法访问**

```bash
# 检查HTTP/HTTPS相关日志

journalctl -u firewalld | grep -E "DPT=80|DPT=443" | tail -10

# 检查当前规则

firewall-cmd --list-services | grep -E "http|https"

# 添加规则

firewall-cmd --add-service=http --permanent
firewall-cmd --add-service=https --permanent
firewall-cmd --reload
```

### 6.2 日志分析工具


**🔸 创建分析脚本：**

```bash
#!/bin/bash

# firewall-analyzer.sh - 防火墙日志分析脚本


echo "=== 防火墙日志分析报告 ==="
echo "时间范围：最近1小时"
echo

echo "1. 被拒绝连接统计："
journalctl -u firewalld --since "1 hour ago" | grep -c REJECT

echo
echo "2. 最活跃的源IP（前5名）："
journalctl -u firewalld --since "1 hour ago" | \
grep REJECT | grep -o 'SRC=[0-9.]*' | \
sort | uniq -c | sort -nr | head -5

echo
echo "3. 最常被扫描的端口（前5名）："
journalctl -u firewalld --since "1 hour ago" | \
grep REJECT | grep -o 'DPT=[0-9]*' | \
sort | uniq -c | sort -nr | head -5
```

**使用方法：**
```bash
chmod +x firewall-analyzer.sh
./firewall-analyzer.sh
```

### 6.3 日志轮转配置


**配置日志轮转防止日志文件过大：**

```bash
# 创建logrotate配置

sudo vim /etc/logrotate.d/firewalld

# 内容示例：

/var/log/firewalld {
    daily           # 每天轮转
    rotate 30       # 保留30个备份
    compress        # 压缩旧日志
    delaycompress   # 延迟压缩
    missingok       # 文件丢失不报错
    notifempty      # 空文件不轮转
    create 644 root root  # 创建新文件的权限
}
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的基本概念


```
🔸 日志记录本质：防火墙的"记录本"，记录网络访问行为
🔸 日志设置重点：--set-log-denied参数控制拒绝日志记录
🔸 日志查看方式：journalctl是现代Linux的标准方法
🔸 日志分析目的：安全监控、故障排查、性能分析
```

### 7.2 关键命令速查


| 功能 | 命令 | 说明 |
|------|------|------|
| **开启拒绝日志** | `firewall-cmd --set-log-denied=unicast` | 记录被拒绝的连接 |
| **查看日志设置** | `firewall-cmd --get-log-denied` | 查看当前日志配置 |
| **实时监控** | `journalctl -u firewalld -f` | 实时查看防火墙日志 |
| **按时间查看** | `journalctl -u firewalld --since "1 hour ago"` | 查看最近1小时日志 |
| **过滤拒绝** | `journalctl -u firewalld \| grep REJECT` | 只看被拒绝的连接 |

### 7.3 实用分析技巧


**🔹 快速定位问题：**
```bash
# 三步排查法

1. journalctl -u firewalld --since "10 minutes ago" | grep REJECT
2. firewall-cmd --list-all
3. 对比日志和规则找出问题
```

**🔹 安全监控要点：**
```
监控指标：
• 拒绝连接数量是否异常增加
• 是否有大量来自同一IP的请求
• 是否有端口扫描行为
• 是否有异常时间段的访问
```

**🔹 性能优化建议：**
```
最佳实践：
• 使用unicast模式，避免广播日志噪音
• 定期清理旧日志，防止磁盘空间不足
• 对高频访问的服务，考虑调整日志级别
• 使用脚本自动化日常日志分析
```

### 7.4 故障排查流程


```
标准排查步骤：
1. 确认问题现象（用户反馈的具体问题）
   ↓
2. 检查防火墙日志（是否有拒绝记录）
   ↓
3. 查看当前规则（规则是否正确配置）
   ↓
4. 测试连接（验证问题是否解决）
   ↓
5. 永久保存（确保重启后规则仍有效）
```

**核心记忆口诀：**
- "日志记录找问题，journalctl是利器"
- "拒绝日志要开启，unicast模式最合适"
- "实时监控用-f，时间过滤加--since"
- "安全排查看REJECT，故障诊断查规则"

**实际应用价值：**
- **提升安全性**：及时发现攻击行为
- **加快排查**：快速定位网络问题
- **优化性能**：了解流量模式做优化
- **满足合规**：保留安全审计记录