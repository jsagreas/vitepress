---
title: 13ã€è§„åˆ™æŸ¥è¯¢ä¸çŠ¶æ€
---
## ğŸ“š ç›®å½•

1. [é˜²ç«å¢™ç›‘æ§åŸºç¡€æ¦‚å¿µ](#1-é˜²ç«å¢™ç›‘æ§åŸºç¡€æ¦‚å¿µ)
2. [è§„åˆ™æŸ¥è¯¢å‘½ä»¤è¯¦è§£](#2-è§„åˆ™æŸ¥è¯¢å‘½ä»¤è¯¦è§£)
3. [çŠ¶æ€ç›‘æ§ä¸éªŒè¯](#3-çŠ¶æ€ç›‘æ§ä¸éªŒè¯)
4. [æ—¥å¿—ç›‘æ§ä¸è°ƒè¯•](#4-æ—¥å¿—ç›‘æ§ä¸è°ƒè¯•)
5. [é…ç½®ä¿¡æ¯ç®¡ç†](#5-é…ç½®ä¿¡æ¯ç®¡ç†)
6. [æ•…éšœæ’æŸ¥å®æˆ˜](#6-æ•…éšœæ’æŸ¥å®æˆ˜)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” é˜²ç«å¢™ç›‘æ§åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯é˜²ç«å¢™ç›‘æ§

**ç®€å•ç†è§£**ï¼šé˜²ç«å¢™ç›‘æ§å°±åƒæ˜¯æŸ¥çœ‹é—¨å«çš„å·¥ä½œè®°å½•ï¼Œäº†è§£è°è¢«æ”¾è¡Œäº†ã€è°è¢«æ‹¦ä½äº†

```
æ—¥å¸¸åœºæ™¯ç±»æ¯”ï¼š
å°åŒºé—¨å« = é˜²ç«å¢™
è®¿å®¢è®°å½• = é˜²ç«å¢™æ—¥å¿—  
é—¨ç¦è§„åˆ™ = é˜²ç«å¢™è§„åˆ™
ä¿å®‰å·¡æŸ¥ = é˜²ç«å¢™ç›‘æ§

ç›‘æ§ç›®çš„ï¼š
âœ… ç¡®è®¤è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆ
âœ… æŸ¥çœ‹å“ªäº›è¿æ¥è¢«å…è®¸/æ‹’ç»
âœ… å‘ç°å¼‚å¸¸è®¿é—®è¡Œä¸º
âœ… ä¼˜åŒ–é˜²ç«å¢™æ€§èƒ½
```

### 1.2 firewall-cmdç›‘æ§ä½“ç³»


**ğŸ—ï¸ ç›‘æ§å±‚æ¬¡ç»“æ„**
```
ç³»ç»Ÿå±‚é¢ç›‘æ§
    â”œâ”€â”€ é˜²ç«å¢™æœåŠ¡çŠ¶æ€
    â”œâ”€â”€ åŒºåŸŸé…ç½®çŠ¶æ€  
    â””â”€â”€ æ•´ä½“è§„åˆ™çŠ¶æ€

åŒºåŸŸå±‚é¢ç›‘æ§
    â”œâ”€â”€ å½“å‰æ´»åŠ¨åŒºåŸŸ
    â”œâ”€â”€ åŒºåŸŸå†…çš„æœåŠ¡
    â”œâ”€â”€ åŒºåŸŸå†…çš„ç«¯å£
    â””â”€â”€ åŒºåŸŸå†…çš„è§„åˆ™

è¿æ¥å±‚é¢ç›‘æ§
    â”œâ”€â”€ æ´»åŠ¨è¿æ¥çŠ¶æ€
    â”œâ”€â”€ è¢«æ‹’ç»çš„è¿æ¥
    â”œâ”€â”€ æ—¥å¿—è®°å½•åˆ†æ
    â””â”€â”€ æ€§èƒ½æŒ‡æ ‡ç›‘æ§
```

### 1.3 ç›‘æ§çš„æ ¸å¿ƒä½œç”¨


**ğŸ¯ ç›‘æ§ä»·å€¼**
- **å®‰å…¨ä¿éšœ**ï¼šåŠæ—¶å‘ç°å¼‚å¸¸è®¿é—®å’Œæ”»å‡»è¡Œä¸º
- **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¾å‡ºå½±å“ç½‘ç»œæ€§èƒ½çš„è§„åˆ™
- **æ•…éšœæ’æŸ¥**ï¼šå¿«é€Ÿå®šä½ç½‘ç»œè¿æ¥é—®é¢˜
- **åˆè§„å®¡è®¡**ï¼šæ»¡è¶³å®‰å…¨å®¡è®¡å’Œæ—¥å¿—è¦æ±‚

---

## 2. ğŸ“‹ è§„åˆ™æŸ¥è¯¢å‘½ä»¤è¯¦è§£


### 2.1 åŸºç¡€æŸ¥è¯¢å‘½ä»¤


#### ğŸ”¸ æŸ¥çœ‹æ‰€æœ‰åŒºåŸŸé…ç½® (--list-all-zones)


**å‘½ä»¤å«ä¹‰**ï¼šä¸€æ¬¡æ€§æŸ¥çœ‹æ‰€æœ‰é˜²ç«å¢™åŒºåŸŸçš„å®Œæ•´é…ç½®ä¿¡æ¯

```bash
# æŸ¥çœ‹æ‰€æœ‰åŒºåŸŸçš„è¯¦ç»†é…ç½®
firewall-cmd --list-all-zones
```

**è¾“å‡ºè§£è¯»**ï¼š
```
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: eth0
  sources: 
  services: ssh http https
  ports: 8080/tcp
  protocols: 
  masquerade: no
  forward-ports: 
  source-ports: 
  icmp-blocks: 
  rich-rules:

internal
  target: default
  icmp-block-inversion: no
  interfaces: 
  sources: 
  services: ssh mdns samba-client dhcpv6-client
  ports: 
  protocols: 
  masquerade: no
  forward-ports: 
  source-ports: 
  icmp-blocks: 
  rich-rules:
```

**ğŸ”¹ è¾“å‡ºå†…å®¹è§£é‡Š**ï¼š
- **`(active)`**ï¼šè¡¨ç¤ºè¯¥åŒºåŸŸå½“å‰æœ‰ç½‘ç»œæ¥å£ç»‘å®šï¼Œæ­£åœ¨ä½¿ç”¨ä¸­
- **`target`**ï¼šåŒºåŸŸçš„é»˜è®¤åŠ¨ä½œï¼ˆdefault/ACCEPT/REJECT/DROPï¼‰
- **`interfaces`**ï¼šç»‘å®šåˆ°æ­¤åŒºåŸŸçš„ç½‘ç»œæ¥å£
- **`services`**ï¼šå…è®¸çš„æœåŠ¡åˆ—è¡¨
- **`ports`**ï¼šç›´æ¥å¼€æ”¾çš„ç«¯å£

#### ğŸ”¸ æŸ¥çœ‹å½“å‰åŒºåŸŸé…ç½® (--list-all)


**å‘½ä»¤å«ä¹‰**ï¼šæŸ¥çœ‹å½“å‰é»˜è®¤åŒºåŸŸçš„è¯¦ç»†é…ç½®

```bash
# æŸ¥çœ‹å½“å‰æ´»åŠ¨åŒºåŸŸçš„é…ç½®
firewall-cmd --list-all

# æŸ¥çœ‹æŒ‡å®šåŒºåŸŸçš„é…ç½®
firewall-cmd --zone=public --list-all
```

**å®ç”¨æŠ€å·§**ï¼š
```bash
# æ¯”è¾ƒä¸åŒåŒºåŸŸçš„é…ç½®å·®å¼‚
firewall-cmd --zone=public --list-all > public_zone.txt
firewall-cmd --zone=internal --list-all > internal_zone.txt
diff public_zone.txt internal_zone.txt
```

### 2.2 è¯¦ç»†ä¿¡æ¯æŸ¥è¯¢


#### ğŸ”¸ æŸ¥è¯¢åŒºåŸŸè¯¦ç»†ä¿¡æ¯ (--info-zone)


**å‘½ä»¤å«ä¹‰**ï¼šè·å–æŒ‡å®šåŒºåŸŸçš„å®Œæ•´é…ç½®ä¿¡æ¯ï¼Œæ¯”--list-allæ›´è¯¦ç»†

```bash
# æŸ¥è¯¢æŒ‡å®šåŒºåŸŸçš„è¯¦ç»†ä¿¡æ¯
firewall-cmd --info-zone=public

# æŸ¥è¯¢æ‰€æœ‰åŒºåŸŸçš„è¯¦ç»†ä¿¡æ¯
for zone in $(firewall-cmd --get-zones); do
    echo "=== Zone: $zone ==="
    firewall-cmd --info-zone=$zone
    echo
done
```

**è¯¦ç»†ä¿¡æ¯åŒ…å«**ï¼š
- åŒºåŸŸçš„æè¿°ä¿¡æ¯
- ç›®æ ‡ç­–ç•¥è®¾ç½®
- ç»‘å®šçš„æ¥å£å’Œæºåœ°å€
- æ‰€æœ‰å…è®¸çš„æœåŠ¡ã€ç«¯å£ã€åè®®
- ç«¯å£è½¬å‘è§„åˆ™
- å¯Œè§„åˆ™é…ç½®

#### ğŸ”¸ æŸ¥è¯¢æœåŠ¡ä¿¡æ¯ (--info-service)


**å‘½ä»¤å«ä¹‰**ï¼šæŸ¥çœ‹é¢„å®šä¹‰æœåŠ¡çš„è¯¦ç»†é…ç½®ä¿¡æ¯

```bash
# æŸ¥çœ‹HTTPæœåŠ¡çš„è¯¦ç»†ä¿¡æ¯
firewall-cmd --info-service=http

# æŸ¥çœ‹SSHæœåŠ¡çš„è¯¦ç»†ä¿¡æ¯  
firewall-cmd --info-service=ssh
```

**æœåŠ¡ä¿¡æ¯è¾“å‡ºç¤ºä¾‹**ï¼š
```
http
  ports: 80/tcp
  protocols: 
  source-ports: 
  modules: 
  destination: 
```

**ğŸ”¹ ç†è§£æœåŠ¡é…ç½®**ï¼š
- **`ports`**ï¼šæœåŠ¡ä½¿ç”¨çš„ç«¯å£å’Œåè®®
- **`protocols`**ï¼šæœåŠ¡ä½¿ç”¨çš„ç½‘ç»œåè®®
- **`modules`**ï¼šéœ€è¦åŠ è½½çš„å†…æ ¸æ¨¡å—
- **`destination`**ï¼šç›®æ ‡åœ°å€é™åˆ¶

### 2.3 å¿«é€ŸçŠ¶æ€æŸ¥è¯¢


**ğŸš€ å¸¸ç”¨çŠ¶æ€æŸ¥è¯¢ç»„åˆ**

```bash
# ä¸€é”®æŸ¥çœ‹é˜²ç«å¢™æ ¸å¿ƒçŠ¶æ€
echo "=== é˜²ç«å¢™æœåŠ¡çŠ¶æ€ ==="
firewall-cmd --state

echo "=== å½“å‰é»˜è®¤åŒºåŸŸ ==="
firewall-cmd --get-default-zone

echo "=== å½“å‰æ´»åŠ¨åŒºåŸŸ ==="
firewall-cmd --get-active-zones

echo "=== å½“å‰åŒºåŸŸé…ç½® ==="
firewall-cmd --list-all
```

**ğŸ“Š æ ¼å¼åŒ–è¾“å‡ºè„šæœ¬**ï¼š
```bash
#!/bin/bash
# é˜²ç«å¢™çŠ¶æ€ä¸€è§ˆè„šæœ¬

echo "ğŸ”¥ é˜²ç«å¢™çŠ¶æ€æ€»è§ˆ"
echo "=================="
echo "æœåŠ¡çŠ¶æ€: $(firewall-cmd --state)"
echo "é»˜è®¤åŒºåŸŸ: $(firewall-cmd --get-default-zone)" 
echo "è¿è¡Œæ—¶é—´: $(systemctl show firewalld --property=ActiveEnterTimestamp | cut -d= -f2)"
echo

echo "ğŸ“¡ æ´»åŠ¨åŒºåŸŸä¿¡æ¯"
echo "=================="
firewall-cmd --get-active-zones

echo "ğŸ›¡ï¸ å½“å‰åŒºåŸŸè¯¦ç»†é…ç½®"
echo "===================="
firewall-cmd --list-all
```

---

## 3. âœ… çŠ¶æ€ç›‘æ§ä¸éªŒè¯


### 3.1 é˜²ç«å¢™æœåŠ¡çŠ¶æ€ç›‘æ§


**ğŸ” æœåŠ¡è¿è¡ŒçŠ¶æ€æ£€æŸ¥**

```bash
# æ£€æŸ¥firewalldæœåŠ¡çŠ¶æ€
systemctl status firewalld

# æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦è¿è¡Œ
firewall-cmd --state

# æ£€æŸ¥æœåŠ¡å¼€æœºè‡ªå¯çŠ¶æ€
systemctl is-enabled firewalld
```

**çŠ¶æ€å«ä¹‰è§£é‡Š**ï¼š
- **`running`**ï¼šé˜²ç«å¢™æ­£å¸¸è¿è¡Œ
- **`not running`**ï¼šé˜²ç«å¢™æœåŠ¡å·²åœæ­¢
- **`unknown`**ï¼šæ— æ³•ç¡®å®šçŠ¶æ€ï¼Œå¯èƒ½æœ‰é—®é¢˜

### 3.2 è§„åˆ™ç”Ÿæ•ˆçŠ¶æ€éªŒè¯


**ğŸ¯ éªŒè¯ç«¯å£å¼€æ”¾çŠ¶æ€**

```bash
# æ£€æŸ¥ç«¯å£æ˜¯å¦åœ¨é˜²ç«å¢™ä¸­å¼€æ”¾
firewall-cmd --query-port=80/tcp

# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¢«å…è®¸
firewall-cmd --query-service=http

# æ‰¹é‡æ£€æŸ¥å¤šä¸ªç«¯å£
for port in 22 80 443 3306; do
    if firewall-cmd --query-port=${port}/tcp >/dev/null 2>&1; then
        echo "âœ… ç«¯å£ $port/tcp å·²å¼€æ”¾"
    else
        echo "âŒ ç«¯å£ $port/tcp æœªå¼€æ”¾"
    fi
done
```

**ğŸ”§ ç½‘ç»œè¿é€šæ€§æµ‹è¯•**

```bash
# ä»å¤–éƒ¨æµ‹è¯•ç«¯å£è¿é€šæ€§
telnet your_server_ip 80

# ä½¿ç”¨nmapæ‰«æç«¯å£çŠ¶æ€
nmap -p 80,443,22 your_server_ip

# æ£€æŸ¥æœ¬åœ°ç›‘å¬ç«¯å£
netstat -tulpn | grep :80
ss -tulpn | grep :80
```

### 3.3 é…ç½®ä¸€è‡´æ€§æ£€æŸ¥


**ğŸ“‹ è¿è¡Œæ—¶ä¸æ°¸ä¹…é…ç½®å¯¹æ¯”**

```bash
# æ¯”è¾ƒè¿è¡Œæ—¶å’Œæ°¸ä¹…é…ç½®
echo "è¿è¡Œæ—¶é…ç½®ï¼š"
firewall-cmd --list-all

echo "æ°¸ä¹…é…ç½®ï¼š"
firewall-cmd --permanent --list-all

# æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„é…ç½®
if ! firewall-cmd --check-config >/dev/null 2>&1; then
    echo "âš ï¸ é…ç½®æ–‡ä»¶æœ‰è¯­æ³•é”™è¯¯"
else
    echo "âœ… é…ç½®æ–‡ä»¶è¯­æ³•æ­£ç¡®"
fi
```

**é…ç½®å·®å¼‚åˆ†æ**ï¼š
```bash
#!/bin/bash
# é…ç½®å·®å¼‚æ£€æŸ¥è„šæœ¬

check_config_diff() {
    local zone=${1:-$(firewall-cmd --get-default-zone)}
    
    echo "æ£€æŸ¥åŒºåŸŸ: $zone"
    echo "===================="
    
    # è·å–è¿è¡Œæ—¶é…ç½®
    firewall-cmd --zone=$zone --list-all > /tmp/runtime_$zone.conf
    
    # è·å–æ°¸ä¹…é…ç½®  
    firewall-cmd --permanent --zone=$zone --list-all > /tmp/permanent_$zone.conf
    
    # æ¯”è¾ƒå·®å¼‚
    if diff /tmp/runtime_$zone.conf /tmp/permanent_$zone.conf >/dev/null; then
        echo "âœ… è¿è¡Œæ—¶ä¸æ°¸ä¹…é…ç½®ä¸€è‡´"
    else
        echo "âš ï¸ å‘ç°é…ç½®å·®å¼‚ï¼š"
        diff /tmp/runtime_$zone.conf /tmp/permanent_$zone.conf
    fi
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f /tmp/runtime_$zone.conf /tmp/permanent_$zone.conf
}

# æ£€æŸ¥æ‰€æœ‰æ´»åŠ¨åŒºåŸŸ
for zone in $(firewall-cmd --get-active-zones | grep -v "interfaces\|sources"); do
    check_config_diff $zone
    echo
done
```

---

## 4. ğŸ“œ æ—¥å¿—ç›‘æ§ä¸è°ƒè¯•


### 4.1 æ—¥å¿—é…ç½®ç®¡ç†


#### ğŸ”¸ æ‹’ç»æ—¥å¿—è®¾ç½® (--get-log-denied)


**å‘½ä»¤å«ä¹‰**ï¼šæŸ¥çœ‹å½“å‰é˜²ç«å¢™æ‹’ç»è¿æ¥çš„æ—¥å¿—è®°å½•çº§åˆ«

```bash
# æŸ¥çœ‹å½“å‰æ—¥å¿—è®¾ç½®
firewall-cmd --get-log-denied

# è®¾ç½®è®°å½•æ‰€æœ‰è¢«æ‹’ç»çš„è¿æ¥
firewall-cmd --set-log-denied=all

# è®¾ç½®åªè®°å½•å•æ’­è¿æ¥è¢«æ‹’ç»çš„æƒ…å†µ
firewall-cmd --set-log-denied=unicast

# å…³é—­æ‹’ç»æ—¥å¿—è®°å½•
firewall-cmd --set-log-denied=off
```

**æ—¥å¿—çº§åˆ«è¯´æ˜**ï¼š
- **`all`**ï¼šè®°å½•æ‰€æœ‰è¢«æ‹’ç»çš„è¿æ¥ï¼ˆåŒ…æ‹¬å¹¿æ’­ã€å¤šæ’­ï¼‰
- **`unicast`**ï¼šåªè®°å½•å•æ’­è¿æ¥è¢«æ‹’ç»çš„æƒ…å†µ
- **`broadcast`**ï¼šåªè®°å½•å¹¿æ’­åŒ…è¢«æ‹’ç»çš„æƒ…å†µ
- **`multicast`**ï¼šåªè®°å½•å¤šæ’­åŒ…è¢«æ‹’ç»çš„æƒ…å†µ
- **`off`**ï¼šä¸è®°å½•è¢«æ‹’ç»çš„è¿æ¥

### 4.2 æ—¥å¿—æŸ¥çœ‹ä¸åˆ†æ


**ğŸ“Š é˜²ç«å¢™æ—¥å¿—ä½ç½®**

```bash
# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ä¸­çš„é˜²ç«å¢™ä¿¡æ¯
journalctl -u firewalld

# æŸ¥çœ‹æœ€è¿‘çš„é˜²ç«å¢™æ—¥å¿—
journalctl -u firewalld --since "1 hour ago"

# å®æ—¶ç›‘æ§é˜²ç«å¢™æ—¥å¿—
journalctl -u firewalld -f

# æŸ¥çœ‹å†…æ ¸é˜²ç«å¢™æ‹’ç»æ—¥å¿—
dmesg | grep -i "drop\|reject\|deny"
```

**ğŸ” æ—¥å¿—åˆ†æç¤ºä¾‹**

```bash
# åˆ†æè¢«æ‹’ç»çš„è¿æ¥
grep "DROP" /var/log/messages | tail -10

# ç»Ÿè®¡æœ€å¸¸è¢«æ‹’ç»çš„IP
grep "DROP" /var/log/messages | \
    awk '{print $13}' | cut -d'=' -f2 | \
    sort | uniq -c | sort -nr | head -10

# åˆ†æè¢«æ‹’ç»çš„ç«¯å£
grep "DROP" /var/log/messages | \
    awk '{print $15}' | cut -d'=' -f2 | \
    sort | uniq -c | sort -nr | head -10
```

### 4.3 è°ƒè¯•æ¨¡å¼ä½¿ç”¨


**ğŸ”§ ä¸´æ—¶è°ƒè¯•é…ç½®**

```bash
# å¼€å¯è¯¦ç»†æ—¥å¿—æ¨¡å¼
firewall-cmd --set-log-denied=all

# ä¸´æ—¶å¼€æ”¾æ‰€æœ‰ç«¯å£è¿›è¡Œæµ‹è¯•ï¼ˆå±é™©æ“ä½œï¼Œä»…ç”¨äºè°ƒè¯•ï¼‰
firewall-cmd --zone=public --add-rich-rule='rule family="ipv4" source address="your_test_ip" accept'

# æµ‹è¯•å®Œæˆåç§»é™¤è§„åˆ™
firewall-cmd --zone=public --remove-rich-rule='rule family="ipv4" source address="your_test_ip" accept'

# æ¢å¤æ—¥å¿—è®¾ç½®
firewall-cmd --set-log-denied=off
```

---

## 5. ğŸ“ é…ç½®ä¿¡æ¯ç®¡ç†


### 5.1 é…ç½®ä¿¡æ¯æ ¼å¼åŒ–è¾“å‡º


**ğŸ“‹ ç»“æ„åŒ–æŸ¥çœ‹é…ç½®**

```bash
# ä»¥æ˜“è¯»æ ¼å¼è¾“å‡ºå½“å‰é…ç½®
firewall-cmd --list-all | while read line; do
    case "$line" in
        *"(active)"*) echo "ğŸŸ¢ $line" ;;
        *"services:"*) echo "ğŸ›¡ï¸  $line" ;;
        *"ports:"*) echo "ğŸ”Œ $line" ;;
        *"interfaces:"*) echo "ğŸ“¡ $line" ;;
        *) echo "   $line" ;;
    esac
done
```

**ğŸ“Š ç”Ÿæˆé…ç½®æŠ¥å‘Š**

```bash
#!/bin/bash
# é˜²ç«å¢™é…ç½®æŠ¥å‘Šç”Ÿæˆè„šæœ¬

generate_firewall_report() {
    local report_file="firewall_report_$(date +%Y%m%d_%H%M%S).txt"
    
    {
        echo "ğŸ”¥ Linuxé˜²ç«å¢™é…ç½®æŠ¥å‘Š"
        echo "======================="
        echo "ç”Ÿæˆæ—¶é—´: $(date)"
        echo "ç³»ç»Ÿä¿¡æ¯: $(uname -a)"
        echo
        
        echo "ğŸ“Š æœåŠ¡çŠ¶æ€"
        echo "==========="
        echo "é˜²ç«å¢™çŠ¶æ€: $(firewall-cmd --state)"
        echo "é»˜è®¤åŒºåŸŸ: $(firewall-cmd --get-default-zone)"
        echo "å·²åŠ è½½åŒºåŸŸ: $(firewall-cmd --get-zones | tr ' ' '\n' | wc -l) ä¸ª"
        echo
        
        echo "ğŸŒ æ´»åŠ¨åŒºåŸŸ"
        echo "==========="
        firewall-cmd --get-active-zones
        echo
        
        echo "ğŸ“‹ æ‰€æœ‰åŒºåŸŸè¯¦ç»†é…ç½®"
        echo "=================="
        for zone in $(firewall-cmd --get-zones); do
            echo "--- Zone: $zone ---"
            firewall-cmd --zone=$zone --list-all
            echo
        done
        
        echo "ğŸ” é¢„å®šä¹‰æœåŠ¡"
        echo "============="
        firewall-cmd --get-services | tr ' ' '\n' | head -20
        echo "... æ›´å¤šæœåŠ¡è¯·ä½¿ç”¨: firewall-cmd --get-services"
        
    } > "$report_file"
    
    echo "âœ… æŠ¥å‘Šå·²ç”Ÿæˆ: $report_file"
}

# æ‰§è¡Œç”ŸæˆæŠ¥å‘Š
generate_firewall_report
```

### 5.2 é…ç½®å¤‡ä»½ä¸è¿˜åŸ


**ğŸ’¾ é…ç½®å¤‡ä»½ç®¡ç†**

```bash
# å¤‡ä»½å½“å‰é˜²ç«å¢™é…ç½®
backup_firewall_config() {
    local backup_dir="/etc/firewalld_backup_$(date +%Y%m%d)"
    
    echo "ğŸ”„ å¼€å§‹å¤‡ä»½é˜²ç«å¢™é…ç½®..."
    
    # åˆ›å»ºå¤‡ä»½ç›®å½•
    mkdir -p "$backup_dir"
    
    # å¤‡ä»½é…ç½®æ–‡ä»¶
    cp -r /etc/firewalld/* "$backup_dir/"
    
    # å¤‡ä»½å½“å‰è¿è¡Œæ—¶çŠ¶æ€
    firewall-cmd --list-all-zones > "$backup_dir/runtime_config.txt"
    
    # åˆ›å»ºå¤‡ä»½è¯´æ˜
    cat > "$backup_dir/backup_info.txt" << EOF
å¤‡ä»½æ—¶é—´: $(date)
ç³»ç»Ÿç‰ˆæœ¬: $(cat /etc/redhat-release 2>/dev/null || echo "Unknown")
é˜²ç«å¢™ç‰ˆæœ¬: $(firewall-cmd --version)
é»˜è®¤åŒºåŸŸ: $(firewall-cmd --get-default-zone)
æ´»åŠ¨åŒºåŸŸ: $(firewall-cmd --get-active-zones)
EOF
    
    echo "âœ… å¤‡ä»½å®Œæˆ: $backup_dir"
}

# è¿˜åŸé˜²ç«å¢™é…ç½®
restore_firewall_config() {
    local backup_dir="$1"
    
    if [ ! -d "$backup_dir" ]; then
        echo "âŒ å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $backup_dir"
        return 1
    fi
    
    echo "âš ï¸ å³å°†è¿˜åŸé˜²ç«å¢™é…ç½®ï¼Œè¿™å°†è¦†ç›–å½“å‰é…ç½®ï¼"
    read -p "æ˜¯å¦ç»§ç»­? (y/N): " confirm
    
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        # åœæ­¢é˜²ç«å¢™æœåŠ¡
        systemctl stop firewalld
        
        # è¿˜åŸé…ç½®æ–‡ä»¶
        cp -r "$backup_dir"/* /etc/firewalld/
        
        # å¯åŠ¨é˜²ç«å¢™æœåŠ¡
        systemctl start firewalld
        
        echo "âœ… é…ç½®è¿˜åŸå®Œæˆ"
    else
        echo "âŒ è¿˜åŸæ“ä½œå·²å–æ¶ˆ"
    fi
}
```

---

## 6. ğŸ”§ æ•…éšœæ’æŸ¥å®æˆ˜


### 6.1 å¸¸è§é—®é¢˜è¯Šæ–­


**ğŸš¨ ç«¯å£æ— æ³•è®¿é—®é—®é¢˜**

```bash
# å®Œæ•´çš„ç«¯å£è®¿é—®é—®é¢˜æ’æŸ¥æµç¨‹
troubleshoot_port_access() {
    local port="$1"
    local protocol="${2:-tcp}"
    
    echo "ğŸ” æ’æŸ¥ç«¯å£è®¿é—®é—®é¢˜: $port/$protocol"
    echo "=================================="
    
    # 1. æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
    echo "1ï¸âƒ£ æ£€æŸ¥é˜²ç«å¢™æœåŠ¡çŠ¶æ€"
    if firewall-cmd --state >/dev/null 2>&1; then
        echo "   âœ… é˜²ç«å¢™æœåŠ¡æ­£å¸¸è¿è¡Œ"
    else
        echo "   âŒ é˜²ç«å¢™æœåŠ¡æœªè¿è¡Œ"
        return 1
    fi
    
    # 2. æ£€æŸ¥ç«¯å£æ˜¯å¦åœ¨é˜²ç«å¢™ä¸­å¼€æ”¾
    echo "2ï¸âƒ£ æ£€æŸ¥é˜²ç«å¢™ç«¯å£é…ç½®"
    if firewall-cmd --query-port="$port/$protocol" >/dev/null 2>&1; then
        echo "   âœ… ç«¯å£ $port/$protocol å·²åœ¨é˜²ç«å¢™ä¸­å¼€æ”¾"
    else
        echo "   âŒ ç«¯å£ $port/$protocol æœªåœ¨é˜²ç«å¢™ä¸­å¼€æ”¾"
        echo "   ğŸ’¡ å»ºè®®: firewall-cmd --add-port=$port/$protocol"
    fi
    
    # 3. æ£€æŸ¥ç«¯å£æ˜¯å¦æœ‰è¿›ç¨‹ç›‘å¬
    echo "3ï¸âƒ£ æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€"
    local listening=$(ss -tulpn | grep ":$port ")
    if [ -n "$listening" ]; then
        echo "   âœ… ç«¯å£ $port æœ‰è¿›ç¨‹ç›‘å¬"
        echo "   ğŸ“Š ç›‘å¬è¯¦æƒ…: $listening"
    else
        echo "   âŒ ç«¯å£ $port æ²¡æœ‰è¿›ç¨‹ç›‘å¬"
        echo "   ğŸ’¡ å»ºè®®: æ£€æŸ¥åº”ç”¨ç¨‹åºæ˜¯å¦æ­£å¸¸å¯åŠ¨"
    fi
    
    # 4. æ£€æŸ¥SELinuxçŠ¶æ€ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if command -v getenforce >/dev/null 2>&1; then
        echo "4ï¸âƒ£ æ£€æŸ¥SELinuxçŠ¶æ€"
        local selinux_status=$(getenforce)
        echo "   ğŸ“Š SELinuxçŠ¶æ€: $selinux_status"
        if [ "$selinux_status" = "Enforcing" ]; then
            echo "   ğŸ’¡ å»ºè®®: æ£€æŸ¥SELinuxç­–ç•¥æ˜¯å¦å…è®¸ç«¯å£è®¿é—®"
        fi
    fi
    
    # 5. æä¾›æµ‹è¯•å»ºè®®
    echo "5ï¸âƒ£ è¿é€šæ€§æµ‹è¯•å»ºè®®"
    echo "   ğŸ”§ æœ¬åœ°æµ‹è¯•: telnet 127.0.0.1 $port"
    echo "   ğŸ”§ è¿œç¨‹æµ‹è¯•: telnet your_server_ip $port"
    echo "   ğŸ”§ ç«¯å£æ‰«æ: nmap -p $port your_server_ip"
}

# ä½¿ç”¨ç¤ºä¾‹
# troubleshoot_port_access 80 tcp
```

### 6.2 æ€§èƒ½ç›‘æ§è„šæœ¬


**ğŸ“ˆ é˜²ç«å¢™æ€§èƒ½ç›‘æ§**

```bash
#!/bin/bash
# é˜²ç«å¢™æ€§èƒ½ç›‘æ§è„šæœ¬

monitor_firewall_performance() {
    local duration="${1:-60}"  # ç›‘æ§æ—¶é•¿ï¼Œé»˜è®¤60ç§’
    local interval="${2:-5}"   # é‡‡æ ·é—´éš”ï¼Œé»˜è®¤5ç§’
    
    echo "ğŸ”¥ é˜²ç«å¢™æ€§èƒ½ç›‘æ§ (ç›‘æ§${duration}ç§’ï¼Œæ¯${interval}ç§’é‡‡æ ·)"
    echo "================================================"
    
    local start_time=$(date +%s)
    local end_time=$((start_time + duration))
    
    # åˆ›å»ºç›‘æ§æ—¥å¿—æ–‡ä»¶
    local log_file="firewall_monitor_$(date +%Y%m%d_%H%M%S).log"
    
    {
        echo "æ—¶é—´,è¿æ¥æ•°,iptablesè§„åˆ™æ•°,å†…å­˜ä½¿ç”¨,CPUä½¿ç”¨"
        
        while [ $(date +%s) -lt $end_time ]; do
            local current_time=$(date '+%H:%M:%S')
            
            # è·å–å½“å‰è¿æ¥æ•°
            local connections=$(ss -ant | wc -l)
            
            # è·å–iptablesè§„åˆ™æ•°
            local rules=$(iptables -L -n | grep -c "^ACCEPT\|^REJECT\|^DROP")
            
            # è·å–firewalldè¿›ç¨‹å†…å­˜ä½¿ç”¨
            local memory=$(ps -o rss= -p $(pgrep firewalld) 2>/dev/null | head -1)
            memory=${memory:-0}
            
            # è·å–ç³»ç»ŸCPUä½¿ç”¨ç‡
            local cpu=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
            
            echo "$current_time,$connections,$rules,$memory,$cpu"
            
            sleep $interval
        done
    } > "$log_file"
    
    echo "âœ… ç›‘æ§å®Œæˆï¼Œæ•°æ®ä¿å­˜åœ¨: $log_file"
    
    # ç”Ÿæˆç®€å•çš„ç»Ÿè®¡æŠ¥å‘Š
    echo
    echo "ğŸ“Š ç›‘æ§ç»Ÿè®¡æ‘˜è¦:"
    echo "==============="
    tail -n +2 "$log_file" | awk -F',' '
    {
        conn_sum += $2; rules_sum += $3; mem_sum += $4; cpu_sum += $5; count++
    }
    END {
        printf "å¹³å‡è¿æ¥æ•°: %.0f\n", conn_sum/count
        printf "å¹³å‡è§„åˆ™æ•°: %.0f\n", rules_sum/count  
        printf "å¹³å‡å†…å­˜ä½¿ç”¨: %.0f KB\n", mem_sum/count
        printf "å¹³å‡CPUä½¿ç”¨: %.1f%%\n", cpu_sum/count
    }'
}

# ä½¿ç”¨ç¤ºä¾‹
# monitor_firewall_performance 120 10  # ç›‘æ§120ç§’ï¼Œæ¯10ç§’é‡‡æ ·
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„ç›‘æ§å‘½ä»¤


```
ğŸ”¸ åŸºç¡€æŸ¥è¯¢å‘½ä»¤
  --list-all-zones    : æŸ¥çœ‹æ‰€æœ‰åŒºåŸŸé…ç½®
  --list-all          : æŸ¥çœ‹å½“å‰åŒºåŸŸé…ç½®  
  --info-zone=zone    : æŸ¥çœ‹åŒºåŸŸè¯¦ç»†ä¿¡æ¯
  --info-service=svc  : æŸ¥çœ‹æœåŠ¡è¯¦ç»†ä¿¡æ¯

ğŸ”¸ çŠ¶æ€æ£€æŸ¥å‘½ä»¤
  --state            : æ£€æŸ¥é˜²ç«å¢™è¿è¡ŒçŠ¶æ€
  --get-default-zone : è·å–é»˜è®¤åŒºåŸŸ
  --get-active-zones : è·å–æ´»åŠ¨åŒºåŸŸ
  --query-port=port  : æŸ¥è¯¢ç«¯å£å¼€æ”¾çŠ¶æ€

ğŸ”¸ æ—¥å¿—ç®¡ç†å‘½ä»¤
  --get-log-denied   : æŸ¥çœ‹æ‹’ç»æ—¥å¿—è®¾ç½®
  --set-log-denied   : è®¾ç½®æ‹’ç»æ—¥å¿—çº§åˆ«
```

### 7.2 ç›‘æ§æœ€ä½³å®è·µ


**ğŸ¯ æ—¥å¸¸ç›‘æ§æµç¨‹**

```
æ¯æ—¥æ£€æŸ¥æ¸…å•ï¼š
âœ… æ£€æŸ¥é˜²ç«å¢™æœåŠ¡çŠ¶æ€
âœ… ç¡®è®¤å…³é”®ç«¯å£å¼€æ”¾çŠ¶æ€  
âœ… æŸ¥çœ‹å¼‚å¸¸è¿æ¥æ—¥å¿—
âœ… éªŒè¯é…ç½®ä¸€è‡´æ€§
âœ… ç›‘æ§ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡

æ•…éšœæ’æŸ¥æ­¥éª¤ï¼š
1. ç¡®è®¤é˜²ç«å¢™æœåŠ¡çŠ¶æ€
2. æ£€æŸ¥ç«¯å£é…ç½®
3. éªŒè¯åº”ç”¨ç¨‹åºç›‘å¬
4. æµ‹è¯•ç½‘ç»œè¿é€šæ€§
5. åˆ†ææ—¥å¿—ä¿¡æ¯
```

### 7.3 å®ç”¨è„šæœ¬æ¨¡æ¿


**ğŸ”§ ç›‘æ§è„šæœ¬æ¡†æ¶**

```bash
# é€šç”¨é˜²ç«å¢™æ£€æŸ¥è„šæœ¬æ¨¡æ¿
#!/bin/bash

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æ‰“å°å¸¦é¢œè‰²çš„ä¿¡æ¯
print_status() {
    local status="$1"
    local message="$2"
    
    case "$status" in
        "ok")    echo -e "${GREEN}âœ… $message${NC}" ;;
        "warn")  echo -e "${YELLOW}âš ï¸  $message${NC}" ;;
        "error") echo -e "${RED}âŒ $message${NC}" ;;
        *)       echo "$message" ;;
    esac
}

# æ£€æŸ¥é˜²ç«å¢™åŸºæœ¬çŠ¶æ€
check_firewall_basics() {
    echo "ğŸ”¥ é˜²ç«å¢™åŸºç¡€çŠ¶æ€æ£€æŸ¥"
    echo "===================="
    
    if firewall-cmd --state >/dev/null 2>&1; then
        print_status "ok" "é˜²ç«å¢™æœåŠ¡æ­£å¸¸è¿è¡Œ"
    else
        print_status "error" "é˜²ç«å¢™æœåŠ¡æœªè¿è¡Œ"
        return 1
    fi
    
    local default_zone=$(firewall-cmd --get-default-zone)
    print_status "ok" "é»˜è®¤åŒºåŸŸ: $default_zone"
    
    local active_zones=$(firewall-cmd --get-active-zones)
    print_status "ok" "æ´»åŠ¨åŒºåŸŸ: $active_zones"
}

# ä¸»å‡½æ•°
main() {
    check_firewall_basics
    # æ·»åŠ æ›´å¤šæ£€æŸ¥å‡½æ•°...
}

# æ‰§è¡Œè„šæœ¬
main "$@"
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- **ç›‘æ§ä¸‰æ­¥èµ°**ï¼šçŠ¶æ€æŸ¥çœ‹ â†’ è§„åˆ™éªŒè¯ â†’ æ—¥å¿—åˆ†æ
- **æŸ¥è¯¢æœ‰å±‚æ¬¡**ï¼šæœåŠ¡çŠ¶æ€ â†’ åŒºåŸŸé…ç½® â†’ å…·ä½“è§„åˆ™
- **è°ƒè¯•é‡æ–¹æ³•**ï¼šå¼€å¯æ—¥å¿— â†’ åˆ†æé—®é¢˜ â†’ æµ‹è¯•éªŒè¯ â†’ å…³é—­æ—¥å¿—
- **æ•…éšœæ’æŸ¥è¦ç³»ç»Ÿ**ï¼šé˜²ç«å¢™ â†’ åº”ç”¨ â†’ ç½‘ç»œ â†’ ç³»ç»Ÿ
- **å®šæœŸæ£€æŸ¥ä¿å®‰å…¨**ï¼šé…ç½®ä¸€è‡´æ€§ã€æ€§èƒ½æŒ‡æ ‡ã€å¼‚å¸¸æ—¥å¿—