---
title: 11、IP地址白黑名单
---
## 📚 目录

1. [IP地址访问控制基础概念](#1-IP地址访问控制基础概念)
2. [源地址管理核心命令](#2-源地址管理核心命令)
3. [IP地址格式与表示方法](#3-IP地址格式与表示方法)
4. [白名单访问控制实战](#4-白名单访问控制实战)
5. [黑名单IP封禁技术](#5-黑名单IP封禁技术)
6. [IP地址组管理策略](#6-IP地址组管理策略)
7. [实际应用场景与最佳实践](#7-实际应用场景与最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🛡️ IP地址访问控制基础概念


### 1.1 什么是IP地址访问控制


**💡 生活类比**
```
IP地址访问控制就像小区门禁系统：
🏠 小区门禁 ←→ 防火墙IP控制
📋 业主名单 ←→ 白名单（允许访问的IP）
🚫 黑名单   ←→ 黑名单（禁止访问的IP）
🔐 门卫检查 ←→ 防火墙检查IP地址
```

### 1.2 firewalld中的源地址控制


**🔍 核心概念**
```
源地址（Source Address）：
定义：发起网络连接的那台设备的IP地址
作用：识别"谁"在试图访问我们的服务器
控制：可以允许或拒绝特定IP的访问

实际场景：
- 服务器IP：192.168.1.100
- 客户端A：192.168.1.50 (想要连接)
- 客户端B：192.168.1.60 (想要连接)
- 我们可以只允许A访问，拒绝B访问
```

### 1.3 白名单与黑名单的区别


**📊 访问策略对比**

| 策略类型 | **工作原理** | **适用场景** | **安全级别** |
|---------|-------------|-------------|-------------|
| 🟢 **白名单模式** | `只允许名单内IP访问` | `高安全要求环境` | `极高` |
| 🔴 **黑名单模式** | `禁止名单内IP，允许其他` | `开放服务环境` | `中等` |
| 🟡 **混合模式** | `白名单+黑名单组合` | `复杂业务场景` | `灵活可控` |

**🧠 记忆口诀**
```
白名单严格控制入，只有名单才能进
黑名单宽松多开放，坏人名单不让过
混合使用最灵活，根据需要来配置
```

---

## 2. ⚙️ 源地址管理核心命令


### 2.1 基础源地址操作命令


**🔧 核心命令三大套**

#### ➕ 添加源地址 (`--add-source`)

```bash
# 基本语法
firewall-cmd --add-source=IP地址 [--zone=区域名]

# 实例说明
firewall-cmd --add-source=192.168.1.50        # 临时添加
firewall-cmd --add-source=192.168.1.50 --permanent  # 永久添加
```

#### ➖ 移除源地址 (`--remove-source`)

```bash
# 基本语法  
firewall-cmd --remove-source=IP地址 [--zone=区域名]

# 实例说明
firewall-cmd --remove-source=192.168.1.50     # 临时移除
firewall-cmd --remove-source=192.168.1.50 --permanent  # 永久移除
```

#### 📋 列出源地址 (`--list-sources`)

```bash
# 查看当前区域的源地址
firewall-cmd --list-sources

# 查看指定区域的源地址
firewall-cmd --zone=public --list-sources

# 查看所有区域的源地址
firewall-cmd --list-all-zones | grep sources
```

### 2.2 命令参数详解


**📝 重要参数说明**

**`--zone=区域名`**：
```
作用：指定操作的防火墙区域
默认：如果不指定，使用当前默认区域
常用区域：
- public（公共区域，默认）
- internal（内部网络）
- trusted（可信区域）
- dmz（非军事化区域）
```

**`--permanent`**：
```
作用：使配置永久生效（重启后仍有效）
注意：permanent配置需要reload才能立即生效
对比：
- 不加permanent：立即生效，重启失效
- 加permanent：需要reload，重启后仍有效
```

**💡 实用技巧**
```bash
# 同时添加临时和永久规则的方法
firewall-cmd --add-source=192.168.1.50           # 立即生效
firewall-cmd --add-source=192.168.1.50 --permanent  # 永久保存
firewall-cmd --reload                             # 重新加载配置
```

---

## 3. 🌐 IP地址格式与表示方法


### 3.1 单个IP地址


**📍 最基础的IP表示**
```bash
# 单个IP地址格式
192.168.1.50

# 实际应用
firewall-cmd --add-source=192.168.1.50    # 只允许这一台设备
firewall-cmd --add-source=203.0.113.100   # 允许公网某台服务器
```

### 3.2 CIDR网络地址段


**🔍 什么是CIDR**
```
CIDR全称：Classless Inter-Domain Routing
中文含义：无类别域间路由
简单理解：用斜杠数字表示网络范围的方法

格式：IP地址/数字
例如：192.168.1.0/24
```

**📊 CIDR表示法详解**

| CIDR表示 | **包含IP范围** | **IP数量** | **实际含义** |
|---------|---------------|-----------|-------------|
| `192.168.1.0/24` | `192.168.1.1-192.168.1.254` | `254个` | `整个C类网段` |
| `192.168.1.0/25` | `192.168.1.1-192.168.1.126` | `126个` | `C类网段的一半` |
| `192.168.1.0/26` | `192.168.1.1-192.168.1.62` | `62个` | `C类网段的四分之一` |
| `10.0.0.0/8` | `10.0.0.1-10.255.255.254` | `约1677万个` | `整个A类网段` |

**🧠 CIDR数字含义记忆**
```
/24 = 24个1 + 8个0 = 255.255.255.0
/16 = 16个1 + 16个0 = 255.255.0.0  
/8  = 8个1 + 24个0 = 255.0.0.0

数字越大，范围越小，控制越精确
数字越小，范围越大，控制越宽松
```

### 3.3 地址范围设置实例


**🎯 常用网络范围配置**

**内网办公环境**：
```bash
# 允许整个办公网段访问
firewall-cmd --add-source=192.168.1.0/24

# 允许特定部门网段
firewall-cmd --add-source=192.168.10.0/24    # 技术部
firewall-cmd --add-source=192.168.20.0/24    # 运营部
```

**云服务器环境**：
```bash
# 允许特定公网IP段
firewall-cmd --add-source=203.0.113.0/24     # 公司公网IP段
firewall-cmd --add-source=198.51.100.50/32   # 特定服务器(/32表示单个IP)
```

**🔍 地址范围选择原则**
```
精确控制：使用/32（单个IP）
部门网段：使用/24（C类网段）
分支机构：使用/22或/23（多个C类）
临时访问：优先使用单个IP
```

---

## 4. ✅ 白名单访问控制实战


### 4.1 白名单工作原理


**💭 工作机制图示**
```
请求流程：
外部IP → 防火墙检查 → 白名单对比 → 决策
         ↓
      是否在白名单？
         ↓
    是 ─────→ 允许访问
         ↓
    否 ─────→ 拒绝访问
```

### 4.2 创建严格白名单


**🔒 高安全模式配置**

**步骤1：清空现有规则**
```bash
# 查看当前源地址
firewall-cmd --list-sources

# 清空所有源地址（谨慎操作）
for ip in $(firewall-cmd --list-sources); do
    firewall-cmd --remove-source=$ip
done
```

**步骤2：添加信任IP**
```bash
# 添加管理员IP（重要！避免把自己锁在外面）
firewall-cmd --add-source=192.168.1.100/32    # 管理员工作站
firewall-cmd --add-source=192.168.1.100/32 --permanent

# 添加办公网段
firewall-cmd --add-source=192.168.1.0/24      # 整个办公网
firewall-cmd --add-source=192.168.1.0/24 --permanent

# 添加特定服务器
firewall-cmd --add-source=203.0.113.50/32     # 监控服务器
firewall-cmd --add-source=203.0.113.50/32 --permanent
```

**步骤3：设置默认拒绝策略**
```bash
# 设置区域默认行为为拒绝
firewall-cmd --set-default-zone=drop
firewall-cmd --reload
```

### 4.3 Web服务白名单示例


**🌐 网站访问控制场景**

> 💡 **场景说明**  
> 公司内部管理系统只允许办公网络和指定外部IP访问

```bash
# 1. 为Web服务创建专用区域
firewall-cmd --new-zone=web-admin --permanent

# 2. 添加允许的IP地址
firewall-cmd --zone=web-admin --add-source=192.168.1.0/24 --permanent    # 办公网
firewall-cmd --zone=web-admin --add-source=10.0.1.100/32 --permanent     # 老板家里
firewall-cmd --zone=web-admin --add-source=203.0.113.200/32 --permanent  # 外部顾问

# 3. 开放Web服务端口
firewall-cmd --zone=web-admin --add-service=http --permanent
firewall-cmd --zone=web-admin --add-service=https --permanent

# 4. 应用配置
firewall-cmd --reload

# 5. 验证配置
firewall-cmd --zone=web-admin --list-all
```

### 4.4 数据库白名单配置


**🗄️ 数据库安全访问**

```bash
# 数据库服务器只允许应用服务器访问
firewall-cmd --add-source=192.168.1.10/32     # Web服务器1  
firewall-cmd --add-source=192.168.1.11/32     # Web服务器2
firewall-cmd --add-source=192.168.1.12/32     # API服务器

# 添加端口访问权限
firewall-cmd --add-port=3306/tcp               # MySQL端口
firewall-cmd --add-port=5432/tcp               # PostgreSQL端口

# 永久保存
firewall-cmd --runtime-to-permanent
```

---

## 5. 🚫 黑名单IP封禁技术


### 5.1 黑名单工作原理


**🎯 封禁机制说明**
```
黑名单策略：默认允许所有访问，但拒绝黑名单中的IP

工作流程：
访问请求 → 检查黑名单 → 命中黑名单？
                           ↓
                      是 → 拒绝访问
                           ↓  
                      否 → 继续处理
```

### 5.2 单个恶意IP封禁


**⚡ 快速封禁操作**

**发现恶意IP**：
```bash
# 查看访问日志发现恶意IP
tail -f /var/log/secure | grep "Failed password"
# 或者查看Web访问日志
tail -f /var/log/httpd/access_log | grep "suspicious_pattern"
```

**立即封禁**：
```bash
# 临时封禁（立即生效）
firewall-cmd --add-source=201.2.3.4 --zone=drop

# 永久封禁
firewall-cmd --add-source=201.2.3.4 --zone=drop --permanent

# 验证封禁效果
firewall-cmd --zone=drop --list-sources
```

### 5.3 批量IP封禁


**📋 批量处理恶意IP**

**从文件批量导入**：
```bash
# 创建黑名单文件
cat > /tmp/blacklist.txt << EOF
185.220.101.1
185.220.101.2  
198.98.51.0/24
203.0.113.100
EOF

# 批量添加到防火墙
while read ip; do
    firewall-cmd --add-source=$ip --zone=drop --permanent
    echo "已封禁: $ip"
done < /tmp/blacklist.txt

# 重新加载配置
firewall-cmd --reload
```

**🔍 自动化恶意IP检测**：
```bash
# 简单的自动封禁脚本示例
#!/bin/bash
# 检测SSH暴力破解并自动封禁

# 查找失败登录超过5次的IP
grep "Failed password" /var/log/secure | \
awk '{print $11}' | sort | uniq -c | \
awk '$1 > 5 {print $2}' > /tmp/bad_ips.txt

# 批量封禁
while read ip; do
    # 检查是否已封禁
    if ! firewall-cmd --zone=drop --query-source=$ip &>/dev/null; then
        firewall-cmd --add-source=$ip --zone=drop --permanent
        echo "$(date): 自动封禁IP $ip"
    fi
done < /tmp/bad_ips.txt
```

### 5.4 地理位置封禁


**🌍 按国家/地区封禁**

> ⚠️ **注意**  
> 地理位置封禁需要IP地理位置数据库支持，这里展示思路

```bash
# 封禁某些地区的IP段（示例）
# 这些是常见的可疑IP段，实际使用需要查询IP地理位置库

firewall-cmd --add-source=185.220.100.0/22 --zone=drop --permanent  # 某地区段1
firewall-cmd --add-source=198.98.50.0/23 --zone=drop --permanent    # 某地区段2
```

---

## 6. 👥 IP地址组管理策略


### 6.1 使用ipset管理大量IP


**🔧 ipset简介**
```
ipset是什么：
- Linux内核的IP集合管理工具
- 可以高效处理大量IP地址
- 与firewalld配合使用更高效

优势：
- 性能高：查找速度O(1)
- 节省内存：批量存储IP地址
- 管理方便：支持动态添加删除
```

**📦 创建和使用ipset**

**安装ipset**：
```bash
# CentOS/RHEL
yum install ipset -y

# Ubuntu/Debian  
apt install ipset -y
```

**创建IP集合**：
```bash
# 创建黑名单集合
ipset create blacklist hash:ip

# 创建白名单集合
ipset create whitelist hash:net

# 添加IP到集合
ipset add blacklist 192.168.1.100
ipset add blacklist 203.0.113.50
ipset add whitelist 192.168.1.0/24

# 查看集合内容
ipset list blacklist
```

**与firewalld集成**：
```bash
# 在firewalld中使用ipset
firewall-cmd --permanent --new-ipset=company-ips --type=hash:ip
firewall-cmd --permanent --ipset=company-ips --add-entry=192.168.1.100
firewall-cmd --permanent --ipset=company-ips --add-entry=192.168.1.101

# 将ipset应用到规则
firewall-cmd --permanent --add-source=ipset:company-ips
firewall-cmd --reload
```

### 6.2 动态IP地址组管理


**🔄 动态管理场景**

**办公室IP自动管理**：
```bash
# 创建办公室IP组管理脚本
#!/bin/bash
OFFICE_IPS="office-network"

# 创建IP集合
firewall-cmd --permanent --new-ipset=$OFFICE_IPS --type=hash:net

# 添加办公网段
office_networks=(
    "192.168.1.0/24"    # 主办公区
    "192.168.10.0/24"   # 开发区  
    "192.168.20.0/24"   # 测试区
)

for network in "${office_networks[@]}"; do
    firewall-cmd --permanent --ipset=$OFFICE_IPS --add-entry=$network
done

# 应用到防火墙规则
firewall-cmd --permanent --add-source=ipset:$OFFICE_IPS
firewall-cmd --reload
```

### 6.3 IP地址组的高级操作


**📊 IP组管理命令集**

| 操作类型 | **命令** | **说明** |
|---------|---------|---------|
| **创建集合** | `firewall-cmd --new-ipset=名称 --type=类型` | `创建新的IP集合` |
| **添加IP** | `firewall-cmd --ipset=名称 --add-entry=IP` | `向集合添加IP` |
| **删除IP** | `firewall-cmd --ipset=名称 --remove-entry=IP` | `从集合删除IP` |
| **列出内容** | `firewall-cmd --ipset=名称 --get-entries` | `显示集合中的IP` |
| **删除集合** | `firewall-cmd --delete-ipset=名称` | `删除整个集合` |

**🎯 实用管理技巧**：
```bash
# 备份IP集合
firewall-cmd --ipset=whitelist --get-entries > whitelist-backup.txt

# 从备份恢复
while read ip; do
    firewall-cmd --permanent --ipset=whitelist --add-entry=$ip
done < whitelist-backup.txt

# 统计集合中IP数量
firewall-cmd --ipset=blacklist --get-entries | wc -l
```

---

## 7. 🎯 实际应用场景与最佳实践


### 7.1 企业内网安全场景


**🏢 企业网络分层管理**

```
网络架构示例：
┌─────────────────────────────┐
│         互联网               │
└─────────────┬───────────────┘
              │
┌─────────────▼───────────────┐
│         防火墙               │ ← IP白名单控制
└─────────────┬───────────────┘
              │
┌─────────────▼───────────────┐
│         DMZ区域              │ ← Web服务器
└─────────────┬───────────────┘
              │
┌─────────────▼───────────────┐
│         内网区域              │ ← 数据库服务器
└─────────────────────────────┘
```

**具体配置策略**：
```bash
# 1. DMZ区域配置（Web服务器）
firewall-cmd --zone=dmz --add-source=0.0.0.0/0           # 允许所有外网访问Web
firewall-cmd --zone=dmz --add-service=http
firewall-cmd --zone=dmz --add-service=https

# 2. 内网区域配置（数据库）
firewall-cmd --zone=internal --add-source=192.168.10.0/24  # 只允许DMZ访问
firewall-cmd --zone=internal --add-port=3306/tcp           # MySQL端口

# 3. 管理区域配置
firewall-cmd --zone=trusted --add-source=192.168.1.100/32  # 管理员IP
firewall-cmd --zone=trusted --add-service=ssh              # SSH管理
```

### 7.2 云服务器安全配置


**☁️ 公有云最佳实践**

**场景：阿里云/腾讯云服务器安全**

> 💡 **云服务器特点**  
> 面向公网，攻击频繁，需要更严格的IP控制

```bash
# 1. 立即封禁常见扫描IP段
common_scanner_ips=(
    "185.220.100.0/22"    # 常见扫描源1
    "198.98.50.0/23"      # 常见扫描源2  
    "89.248.160.0/22"     # 常见扫描源3
)

for ip in "${common_scanner_ips[@]}"; do
    firewall-cmd --add-source=$ip --zone=drop --permanent
done

# 2. 只允许必要的管理IP
firewall-cmd --zone=public --add-source=YOUR_OFFICE_IP/32 --permanent
firewall-cmd --zone=public --add-service=ssh --permanent

# 3. Web服务使用CDN白名单
firewall-cmd --zone=public --add-source=CDN_IP_RANGE --permanent
firewall-cmd --zone=public --add-service=http --permanent
firewall-cmd --zone=public --add-service=https --permanent
```

### 7.3 自动化安全响应


**🤖 智能封禁系统**

**实时监控脚本**：
```bash
#!/bin/bash
# 自动安全响应脚本

LOG_FILE="/var/log/security-monitor.log"
THRESHOLD=10  # 失败次数阈值

# 监控SSH暴力破解
monitor_ssh() {
    tail -f /var/log/secure | while read line; do
        if echo "$line" | grep -q "Failed password"; then
            ip=$(echo "$line" | awk '{print $11}')
            
            # 统计失败次数
            count=$(grep "Failed password.*$ip" /var/log/secure | wc -l)
            
            if [ $count -gt $THRESHOLD ]; then
                # 自动封禁
                firewall-cmd --add-source=$ip --zone=drop --permanent
                echo "$(date): 自动封禁暴力破解IP: $ip (失败$count次)" >> $LOG_FILE
                
                # 可选：发送告警邮件
                # echo "检测到暴力破解，已封禁IP: $ip" | mail -s "安全告警" admin@company.com
            fi
        fi
    done
}

# 启动监控
monitor_ssh &
```

### 7.4 紧急响应处理


**🚨 安全事件应急处理**

**发现攻击时的快速响应**：

**步骤1：立即封禁攻击源**
```bash
# 紧急封禁单个IP
firewall-cmd --add-source=ATTACKER_IP --zone=drop

# 紧急封禁IP段
firewall-cmd --add-source=ATTACKER_NETWORK/24 --zone=drop
```

**步骤2：启用白名单模式**
```bash
# 临时切换到最严格模式
firewall-cmd --set-default-zone=drop

# 只允许管理员IP
firewall-cmd --zone=trusted --add-source=ADMIN_IP/32
firewall-cmd --zone=trusted --add-service=ssh
```

**步骤3：日志分析和持久化**
```bash
# 分析攻击模式
grep "ATTACKER_IP" /var/log/* 

# 将临时规则永久化
firewall-cmd --runtime-to-permanent
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心命令


```
🔸 基础操作三剑客：
  --add-source    ：添加允许的IP地址
  --remove-source ：移除IP地址
  --list-sources  ：查看当前IP列表

🔸 重要参数组合：
  --permanent     ：永久保存配置
  --zone=区域名   ：指定操作区域
  --reload        ：重新加载配置

🔸 紧急处理命令：
  --zone=drop     ：立即封禁IP
  --runtime-to-permanent ：临时转永久
```

### 8.2 IP地址格式要点


**🧠 格式记忆要点**
```
单个IP：192.168.1.50/32        ← /32表示精确到单个IP
C类网段：192.168.1.0/24        ← /24表示256个IP
B类网段：192.168.0.0/16        ← /16表示65536个IP
A类网段：10.0.0.0/8           ← /8表示1677万个IP

记忆技巧：数字越大范围越小，控制越精确
```

### 8.3 安全策略选择指南


**🎯 策略选择原则**

| 安全级别 | **推荐策略** | **适用场景** | **配置重点** |
|---------|-------------|-------------|-------------|
| 🔴 **极高** | `纯白名单模式` | `核心数据库、管理系统` | `只允许必要IP，默认拒绝` |
| 🟡 **较高** | `白名单+黑名单` | `企业Web应用` | `办公网白名单+恶意IP黑名单` |
| 🟢 **一般** | `黑名单为主` | `公开Web服务` | `封禁已知恶意IP，开放其他` |

### 8.4 常见错误与避免方法


**⚠️ 新手常犯错误**

**错误1：把自己锁在外面**
```bash
# ❌ 错误做法：直接清空所有规则
firewall-cmd --remove-source=0.0.0.0/0

# ✅ 正确做法：先添加自己的IP
firewall-cmd --add-source=YOUR_IP/32
# 然后再清理其他规则
```

**错误2：忘记永久保存**
```bash
# ❌ 错误：只做临时配置
firewall-cmd --add-source=192.168.1.50

# ✅ 正确：临时+永久双重保险
firewall-cmd --add-source=192.168.1.50              # 立即生效
firewall-cmd --add-source=192.168.1.50 --permanent  # 重启保持
```

**错误3：IP格式写错**
```bash
# ❌ 常见错误格式
192.168.1.1-192.168.1.10    # 不支持范围格式
192.168.1.*                 # 不支持通配符

# ✅ 正确格式
192.168.1.0/28              # 使用CIDR表示范围
```

### 8.5 实战应用记忆口诀


**🧠 核心记忆口诀**
```
IP控制有门道，白黑名单要记牢
add-source添加源，remove清理要趁早
permanent永久存，zone区域分得好
CIDR格式要规范，斜杠数字含义明
先保自己后操作，安全第一不出错
```

**🎯 应用场景快速判断**
```
内网服务器 → 白名单严控
公网Web站 → 黑名单为主  
数据库层 → 应用服务器白名单
管理接口 → 管理员IP白名单
紧急处理 → 先封禁再分析
```

**💡 日常管理建议**
- **定期检查**：每周检查一次IP规则是否合理
- **日志监控**：关注访问日志中的异常IP
- **备份配置**：重要变更前先备份当前配置
- **测试验证**：新规则生效后及时测试访问
- **文档记录**：维护IP白黑名单的详细说明文档

**核心理念**：IP访问控制是网络安全的第一道防线，合理的白黑名单策略能够有效阻挡90%以上的恶意访问，但同时要平衡安全性与可用性，避免过度限制影响正常业务。