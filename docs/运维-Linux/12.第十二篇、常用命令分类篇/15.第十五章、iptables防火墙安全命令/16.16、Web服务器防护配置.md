---
title: 16、Web服务器防护配置
---
## 📚 目录

1. [Web服务器防护基础概念](#1-Web服务器防护基础概念)
2. [HTTP/HTTPS端口开放配置](#2-HTTP/HTTPS端口开放配置)
3. [Web服务访问控制](#3-Web服务访问控制)
4. [恶意IP封禁与管理](#4-恶意IP封禁与管理)
5. [CC攻击防护设置](#5-CC攻击防护设置)
6. [静态文件访问限制](#6-静态文件访问限制)
7. [管理端口保护策略](#7-管理端口保护策略)
8. [SSL证书端口配置](#8-SSL证书端口配置)
9. [CDN源站保护实战](#9-CDN源站保护实战)
10. [完整防护方案示例](#10-完整防护方案示例)
11. [核心要点总结](#11-核心要点总结)

---

## 1. 🌐 Web服务器防护基础概念


### 1.1 什么是Web服务器防护


**简单理解**：就像给你的网站装上一道安全门，控制哪些人能进来，哪些人不能进来。

```
现实比喻：
商店大门 = Web服务器
顾客     = 网站访客
保安     = iptables防火墙

保安的工作：
✅ 让正常顾客进入
❌ 拦住可疑人员
🔍 检查每个进入的人
⚡ 应对突发情况
```

### 1.2 Web服务器面临的常见威胁


**🔥 主要安全威胁**
- **暴力破解攻击**：不断尝试密码
- **DDoS攻击**：大量请求让服务器瘫痪
- **CC攻击**：专门针对网页的攻击
- **恶意扫描**：寻找服务器漏洞
- **非法访问**：试图进入管理后台

### 1.3 iptables在Web防护中的作用


**核心防护机制**：
```
用户请求 → iptables检查 → Web服务器
    ↓
[IP过滤] [端口控制] [频率限制] [访问日志]
```

**🛡️ 防护层次图**
```
┌─────────────────────────────┐
│        用户访问请求          │
└──────────┬──────────────────┘
           │
┌──────────▼──────────────────┐
│     iptables防火墙层        │  ← 第一道防线
├─────────────────────────────┤
│     Web服务器层(Nginx)      │  ← 第二道防线
├─────────────────────────────┤
│     应用程序层(PHP/Java)    │  ← 第三道防线
└─────────────────────────────┘
```

---

## 2. 🚪 HTTP/HTTPS端口开放配置


### 2.1 基础端口开放


**🔸 标准Web端口说明**
- **端口80**：HTTP协议，普通网页访问
- **端口443**：HTTPS协议，加密网页访问

**基础开放命令**：
```bash
# 开放HTTP端口(80)
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# 开放HTTPS端口(443)  
iptables -A INPUT -p tcp --dport 443 -j ACCEPT
```

### 2.2 指定来源IP开放


```bash
# 只允许特定IP访问
iptables -A INPUT -s 192.168.1.100 -p tcp --dport 80 -j ACCEPT

# 允许整个网段访问
iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 80 -j ACCEPT

# 允许多个IP访问
iptables -A INPUT -s 10.0.0.1,10.0.0.2 -p tcp --dport 80 -j ACCEPT
```

### 2.3 时间限制访问


```bash
# 工作时间开放Web服务(9:00-18:00)
iptables -A INPUT -p tcp --dport 80 -m time --timestart 09:00 --timestop 18:00 -j ACCEPT

# 周末不开放管理端口
iptables -A INPUT -p tcp --dport 8080 -m time --weekdays Mon,Tue,Wed,Thu,Fri -j ACCEPT
```

### 2.4 端口开放状态检查


| 检查方式 | 命令 | 说明 |
|---------|------|------|
| **查看规则** | `iptables -L INPUT -n` | 显示INPUT链规则 |
| **端口监听** | `netstat -tlnp \| grep :80` | 检查80端口监听状态 |
| **外部测试** | `telnet 服务器IP 80` | 从外部测试端口连通性 |

---

## 3. 🎯 Web服务访问控制


### 3.1 基于地理位置的访问控制


**🌍 国家/地区访问限制**
```bash
# 只允许中国IP访问(需要安装geoip模块)
iptables -A INPUT -p tcp --dport 80 -m geoip --src-cc CN -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -j DROP

# 禁止特定国家访问
iptables -A INPUT -p tcp --dport 80 -m geoip --src-cc US,RU -j DROP
```

### 3.2 基于域名的访问控制


```bash
# 限制特定域名访问频率
iptables -A INPUT -p tcp --dport 80 -m string --string "Host: evil.com" -j DROP

# 只允许指定User-Agent
iptables -A INPUT -p tcp --dport 80 -m string --string "User-Agent: MyBot" -j ACCEPT
```

### 3.3 访问频率控制


**⚡ 连接频率限制**
```bash
# 每分钟最多10个新连接
iptables -A INPUT -p tcp --dport 80 -m state --state NEW -m recent --set
iptables -A INPUT -p tcp --dport 80 -m state --state NEW -m recent --update --seconds 60 --hitcount 10 -j DROP

# 每个IP最多3个并发连接
iptables -A INPUT -p tcp --dport 80 -m connlimit --connlimit-above 3 -j REJECT
```

### 3.4 访问时间段控制


```bash
# 维护时间禁止访问(凌晨2-4点)
iptables -A INPUT -p tcp --dport 80 -m time --timestart 02:00 --timestop 04:00 -j DROP

# 只在工作日开放某些功能
iptables -A INPUT -p tcp --dport 8080 -m time --weekdays Mon,Tue,Wed,Thu,Fri -j ACCEPT
```

---

## 4. 🚫 恶意IP封禁与管理


### 4.1 单个IP封禁


**🔸 临时封禁**
```bash
# 封禁单个恶意IP
iptables -I INPUT -s 192.168.1.100 -j DROP

# 封禁IP段
iptables -I INPUT -s 192.168.1.0/24 -j DROP

# 只封禁Web端口
iptables -I INPUT -s 192.168.1.100 -p tcp --dport 80 -j DROP
```

### 4.2 批量IP封禁


```bash
# 从文件批量封禁IP
while read ip; do
    iptables -I INPUT -s $ip -j DROP
done < /etc/iptables/blacklist.txt

# 创建IP黑名单链
iptables -N BLACKLIST
iptables -A INPUT -j BLACKLIST
```

### 4.3 自动封禁可疑IP


**🤖 基于连接数自动封禁**
```bash
#!/bin/bash
# 自动封禁脚本示例

# 查找连接数超过50的IP
netstat -an | grep :80 | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -nr | head -10

# 自动封禁连接数过多的IP
for ip in $(netstat -an | grep :80 | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | awk '$1>50{print $2}')
do
    iptables -I INPUT -s $ip -j DROP
    echo "Blocked IP: $ip at $(date)" >> /var/log/auto-block.log
done
```

### 4.4 IP封禁管理


| 操作类型 | 命令示例 | 说明 |
|---------|---------|------|
| **查看被封IP** | `iptables -L INPUT -n \| grep DROP` | 显示所有DROP规则 |
| **解封特定IP** | `iptables -D INPUT -s 1.2.3.4 -j DROP` | 删除对应封禁规则 |
| **清空黑名单** | `iptables -F BLACKLIST` | 清空黑名单链 |

---

## 5. ⚡ CC攻击防护设置


### 5.1 什么是CC攻击


**简单理解**：CC攻击就像有一群人同时不停地刷新你的网页，让正常用户无法访问。

```
CC攻击示意：
正常访问：用户 → 网站 (偶尔访问)
CC攻击：  攻击者 → 网站 (疯狂刷新)
         攻击者 → 网站 (疯狂刷新)  
         攻击者 → 网站 (疯狂刷新)
结果：服务器资源耗尽，正常用户无法访问
```

### 5.2 基础CC防护规则


**🛡️ 连接频率限制**
```bash
# 限制每个IP每分钟最多20个HTTP请求
iptables -A INPUT -p tcp --dport 80 -m state --state NEW -m recent --set --name HTTP
iptables -A INPUT -p tcp --dport 80 -m state --state NEW -m recent --update --seconds 60 --hitcount 20 --name HTTP -j DROP
```

### 5.3 高级CC防护策略


**🔥 多层防护机制**
```bash
# 第一层：限制新连接频率
iptables -A INPUT -p tcp --dport 80 -m state --state NEW -m limit --limit 25/minute --limit-burst 100 -j ACCEPT

# 第二层：限制并发连接数  
iptables -A INPUT -p tcp --dport 80 -m connlimit --connlimit-above 10 -j REJECT

# 第三层：限制每IP连接数
iptables -A INPUT -p tcp --dport 80 -m state --state NEW -m recent --set
iptables -A INPUT -p tcp --dport 80 -m recent --update --seconds 60 --hitcount 15 -j DROP
```

### 5.4 针对HTTPS的CC防护


```bash
# HTTPS端口防护(443端口)
iptables -A INPUT -p tcp --dport 443 -m state --state NEW -m recent --set --name HTTPS
iptables -A INPUT -p tcp --dport 443 -m recent --update --seconds 60 --hitcount 30 --name HTTPS -j DROP

# SSL握手限制
iptables -A INPUT -p tcp --dport 443 -m connlimit --connlimit-above 15 -j REJECT
```

### 5.5 CC攻击监控脚本


```bash
#!/bin/bash
# CC攻击监控和自动防护脚本

LOG_FILE="/var/log/cc-monitor.log"
THRESHOLD=100

# 检查当前连接数
current_connections=$(netstat -an | grep :80 | grep ESTABLISHED | wc -l)

if [ $current_connections -gt $THRESHOLD ]; then
    echo "$(date): 检测到异常连接数: $current_connections" >> $LOG_FILE
    
    # 自动应用紧急防护规则
    iptables -I INPUT -p tcp --dport 80 -m limit --limit 10/minute -j ACCEPT
    iptables -I INPUT -p tcp --dport 80 -j DROP
    
    echo "$(date): 已应用紧急防护规则" >> $LOG_FILE
fi
```

---

## 6. 📁 静态文件访问限制


### 6.1 保护敏感文件类型


**🔒 常见敏感文件保护**
```bash
# 禁止访问配置文件
iptables -A INPUT -p tcp --dport 80 -m string --string "/.env" --algo bm -j DROP
iptables -A INPUT -p tcp --dport 80 -m string --string "/config.php" --algo bm -j DROP

# 禁止访问备份文件  
iptables -A INPUT -p tcp --dport 80 -m string --string ".bak" --algo bm -j DROP
iptables -A INPUT -p tcp --dport 80 -m string --string ".sql" --algo bm -j DROP
```

### 6.2 限制文件下载频率


```bash
# 限制大文件下载频率
iptables -A INPUT -p tcp --dport 80 -m string --string ".zip" --algo bm -m limit --limit 1/minute -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -m string --string ".zip" --algo bm -j DROP

# 限制视频文件访问
iptables -A INPUT -p tcp --dport 80 -m string --string ".mp4" --algo bm -m recent --set --name VIDEO
iptables -A INPUT -p tcp --dport 80 -m string --string ".mp4" --algo bm -m recent --update --seconds 300 --hitcount 3 --name VIDEO -j DROP
```

### 6.3 保护管理目录


```bash
# 禁止访问管理目录
iptables -A INPUT -p tcp --dport 80 -m string --string "/admin/" --algo bm -j DROP
iptables -A INPUT -p tcp --dport 80 -m string --string "/manager/" --algo bm -j DROP

# 只允许特定IP访问管理目录
iptables -A INPUT -s 192.168.1.100 -p tcp --dport 80 -m string --string "/admin/" --algo bm -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -m string --string "/admin/" --algo bm -j DROP
```

---

## 7. 🔐 管理端口保护策略


### 7.1 常见管理端口


**🔧 Web管理端口列表**
| 端口 | 服务 | 说明 |
|------|------|------|
| **8080** | Tomcat管理 | Java应用服务器 |
| **8443** | HTTPS管理 | 加密管理接口 |
| **9090** | 监控面板 | 系统监控界面 |
| **3000** | Grafana | 数据可视化 |

### 7.2 管理端口基础保护


```bash
# 只允许内网访问管理端口
iptables -A INPUT -s 192.168.0.0/16 -p tcp --dport 8080 -j ACCEPT
iptables -A INPUT -p tcp --dport 8080 -j DROP

# 只允许特定IP访问
iptables -A INPUT -s 10.0.0.1 -p tcp --dport 9090 -j ACCEPT
iptables -A INPUT -p tcp --dport 9090 -j DROP
```

### 7.3 管理端口高级保护


**🛡️ 多重验证机制**
```bash
# 敲门端口序列保护
iptables -A INPUT -p tcp --dport 1234 -m recent --set --name KNOCK1
iptables -A INPUT -p tcp --dport 5678 -m recent --rcheck --seconds 30 --name KNOCK1 -m recent --set --name KNOCK2  
iptables -A INPUT -p tcp --dport 8080 -m recent --rcheck --seconds 30 --name KNOCK2 -j ACCEPT

# 时间窗口保护
iptables -A INPUT -p tcp --dport 8080 -m time --timestart 09:00 --timestop 17:00 --weekdays Mon,Tue,Wed,Thu,Fri -j ACCEPT
```

### 7.4 紧急访问通道


```bash
# 创建紧急访问规则(VPN IP)
iptables -I INPUT 1 -s 10.8.0.0/24 -j ACCEPT

# 临时开放管理端口(30分钟后自动关闭)
iptables -I INPUT -p tcp --dport 8080 -m time --datestart $(date +%Y-%m-%d) --timestart $(date +%H:%M) --timestop $(date -d "+30 minutes" +%H:%M) -j ACCEPT
```

---

## 8. 🔒 SSL证书端口配置


### 8.1 HTTPS端口基础配置


```bash
# 标准HTTPS端口开放
iptables -A INPUT -p tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT

# 自定义HTTPS端口
iptables -A INPUT -p tcp --dport 8443 -m state --state NEW,ESTABLISHED -j ACCEPT
```

### 8.2 SSL协议版本控制


```bash
# 只允许TLS 1.2及以上版本(需要Web服务器配合)
iptables -A INPUT -p tcp --dport 443 -m string --string "TLS" --algo bm -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -m string --string "SSL" --algo bm -j DROP
```

### 8.3 证书更新期间的处理


```bash
# 证书更新时临时规则
iptables -I INPUT -s 证书颁发机构IP -p tcp --dport 80 -j ACCEPT
iptables -I INPUT -p tcp --dport 80 -m string --string "/.well-known/acme-challenge/" --algo bm -j ACCEPT
```

---

## 9. 🌐 CDN源站保护实战


### 9.1 什么是CDN源站保护


**简单理解**：CDN就像网站的"分身"，分布在全国各地为用户提供服务，而源站是"真身"，需要隐藏保护起来。

```
CDN架构示意：
用户 → CDN节点 → 源站服务器
     (公开访问)  (需要保护)

保护原理：
✅ 只允许CDN IP访问源站  
❌ 拒绝其他IP直接访问源站
```

### 9.2 获取CDN服务商IP段


**🔸 主流CDN服务商**
```bash
# 阿里云CDN IP段(示例)
ALIYUN_IPS="47.246.0.0/16 47.250.0.0/16 47.254.0.0/16"

# 腾讯云CDN IP段(示例)  
TENCENT_IPS="118.89.0.0/16 123.207.0.0/16"

# Cloudflare IP段
CLOUDFLARE_IPS="173.245.48.0/20 103.21.244.0/22 103.22.200.0/22"
```

### 9.3 CDN白名单配置


```bash
# 创建CDN白名单链
iptables -N CDN_WHITELIST

# 添加CDN IP段到白名单
for ip in $CLOUDFLARE_IPS; do
    iptables -A CDN_WHITELIST -s $ip -j ACCEPT
done

# 应用CDN白名单到Web端口
iptables -A INPUT -p tcp --dport 80 -j CDN_WHITELIST
iptables -A INPUT -p tcp --dport 443 -j CDN_WHITELIST

# 拒绝其他IP直接访问
iptables -A INPUT -p tcp --dport 80 -j DROP
iptables -A INPUT -p tcp --dport 443 -j DROP
```

### 9.4 CDN回源验证


```bash
# 验证CDN回源请求
iptables -A INPUT -p tcp --dport 80 -m string --string "X-Forwarded-For" --algo bm -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -m string --string "CF-Connecting-IP" --algo bm -j ACCEPT

# 记录非CDN访问日志
iptables -A INPUT -p tcp --dport 80 -j LOG --log-prefix "Direct-Access: "
iptables -A INPUT -p tcp --dport 80 -j DROP
```

---

## 10. 🛠️ 完整防护方案示例


### 10.1 生产环境Web服务器防护脚本


```bash
#!/bin/bash
# Web服务器iptables防护配置脚本

# 清空现有规则
iptables -F
iptables -X
iptables -Z

# 设置默认策略
iptables -P INPUT DROP
iptables -P FORWARD DROP  
iptables -P OUTPUT ACCEPT

# 允许本地回环
iptables -A INPUT -i lo -j ACCEPT

# 允许已建立的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# SSH管理端口(限制IP)
iptables -A INPUT -s 管理员IP -p tcp --dport 22 -j ACCEPT

# Web服务端口基础防护
iptables -A INPUT -p tcp --dport 80 -m state --state NEW -m recent --set --name HTTP
iptables -A INPUT -p tcp --dport 80 -m state --state NEW -m recent --update --seconds 60 --hitcount 30 --name HTTP -j DROP
iptables -A INPUT -p tcp --dport 80 -m connlimit --connlimit-above 20 -j REJECT
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# HTTPS端口防护
iptables -A INPUT -p tcp --dport 443 -m state --state NEW -m recent --set --name HTTPS  
iptables -A INPUT -p tcp --dport 443 -m state --state NEW -m recent --update --seconds 60 --hitcount 40 --name HTTPS -j DROP
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 恶意IP黑名单
if [ -f /etc/iptables/blacklist.txt ]; then
    while read ip; do
        iptables -I INPUT -s $ip -j DROP
    done < /etc/iptables/blacklist.txt
fi

# 保存规则
iptables-save > /etc/iptables/rules.v4

echo "Web服务器防护规则配置完成！"
```

### 10.2 防护效果监控脚本


```bash
#!/bin/bash
# Web防护效果监控脚本

LOG_FILE="/var/log/web-protection.log"

# 检查当前连接状态
echo "=== $(date) Web服务器状态检查 ===" >> $LOG_FILE

# HTTP连接数
http_connections=$(netstat -an | grep :80 | grep ESTABLISHED | wc -l)
echo "HTTP活跃连接数: $http_connections" >> $LOG_FILE

# HTTPS连接数  
https_connections=$(netstat -an | grep :443 | grep ESTABLISHED | wc -l)
echo "HTTPS活跃连接数: $https_connections" >> $LOG_FILE

# 被阻止的连接数
blocked_count=$(iptables -L INPUT -v -n | grep DROP | awk '{sum+=$1} END {print sum}')
echo "今日阻止连接数: $blocked_count" >> $LOG_FILE

# Top 10 访问IP
echo "Top 10 访问IP:" >> $LOG_FILE
netstat -an | grep :80 | awk '{print $5}' | cut -d: -f1 | sort | uniq -c | sort -nr | head -10 >> $LOG_FILE

echo "================================" >> $LOG_FILE
```

### 10.3 紧急响应脚本


```bash
#!/bin/bash
# 紧急攻击响应脚本

case $1 in
    "block")
        # 紧急封锁模式
        iptables -I INPUT -p tcp --dport 80 -m limit --limit 5/minute -j ACCEPT
        iptables -I INPUT -p tcp --dport 80 -j DROP
        echo "紧急封锁模式已启动"
        ;;
    "unblock")
        # 解除封锁模式  
        iptables -D INPUT -p tcp --dport 80 -m limit --limit 5/minute -j ACCEPT
        iptables -D INPUT -p tcp --dport 80 -j DROP
        echo "封锁模式已解除"
        ;;
    "status")
        # 查看当前状态
        echo "当前防护状态:"
        iptables -L INPUT -n | grep -E "(80|443)"
        ;;
    *)
        echo "用法: $0 {block|unblock|status}"
        ;;
esac
```

---

## 11. 📋 核心要点总结


### 11.1 必须掌握的核心概念


```
🔸 Web端口：80(HTTP) 443(HTTPS) 是网站的大门
🔸 访问控制：谁能进来，什么时候能进来，能做什么
🔸 频率限制：防止有人疯狂刷新攻击网站  
🔸 IP封禁：把坏人的地址拉入黑名单
🔸 CDN保护：隐藏真实服务器，只让CDN访问
```

### 11.2 关键理解要点


**🔹 防护层次化思维**
```
第一层：IP过滤 → 拦截已知恶意IP
第二层：频率控制 → 防止刷量攻击  
第三层：内容过滤 → 阻止恶意请求
第四层：时间控制 → 限制访问时段
```

**🔹 常用端口记忆**
```
Web服务端口：
• 80  = HTTP  (普通网页)
• 443 = HTTPS (加密网页)
• 8080 = 管理后台 (需要特殊保护)
• 8443 = 加密管理 (双重保护)
```

**🔹 攻击防护策略**
```
CC攻击防护：
✅ 限制连接频率 (每分钟最多X次)
✅ 限制并发数量 (同时最多Y个连接)  
✅ 自动封禁 (超过阈值立即拉黑)
```

### 11.3 实际应用价值


**🎯 生产环境应用场景**
- **电商网站**：防护购物高峰期的恶意攻击
- **企业官网**：保护品牌形象，防止网站被攻击
- **API服务**：控制接口调用频率，防止滥用
- **内容网站**：保护原创内容，防止恶意爬取

**🔧 运维实践要点**
- **监控日志**：定期检查访问日志，发现异常及时处理
- **规则备份**：重要防护规则要备份，避免误删
- **测试验证**：新规则上线前要充分测试
- **应急预案**：准备紧急封锁和解封脚本

### 11.4 记忆口诀


```
Web防护记心间，
端口开放要安全，
频率限制防攻击，  
IP封禁拦坏蛋，
CDN保护源站好，
监控日志不能少！
```

### 11.5 实战检查清单


**🔥 部署前检查**
- ✅ 基础端口(80/443)是否正常开放
- ✅ 管理端口是否限制了访问IP  
- ✅ 频率限制规则是否配置合理
- ✅ 恶意IP黑名单是否及时更新
- ✅ CDN白名单是否配置正确

**⚡ 运行中监控**
- ✅ 每日检查连接数是否异常
- ✅ 定期查看被封IP列表
- ✅ 监控Web服务响应时间
- ✅ 检查防护规则命中情况

**核心记忆**：
- Web防护就是给网站装安全门，控制访问权限
- 80端口是HTTP，443端口是HTTPS，记住这两个最重要
- 防护要分层：IP过滤、频率控制、内容检查、时间限制
- 监控很重要：没有监控的防护是盲目的防护