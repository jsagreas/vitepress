---
title: 19ã€è§„åˆ™æŒä¹…åŒ–ä¸å¤‡ä»½
---
## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆéœ€è¦è§„åˆ™æŒä¹…åŒ–](#1-ä¸ºä»€ä¹ˆéœ€è¦è§„åˆ™æŒä¹…åŒ–)
2. [iptables-saveè§„åˆ™ä¿å­˜](#2-iptables-saveè§„åˆ™ä¿å­˜)
3. [è§„åˆ™é…ç½®æ–‡ä»¶è¯¦è§£](#3-è§„åˆ™é…ç½®æ–‡ä»¶è¯¦è§£)
4. [å¼€æœºè‡ªåŠ¨åŠ è½½è§„åˆ™](#4-å¼€æœºè‡ªåŠ¨åŠ è½½è§„åˆ™)
5. [è§„åˆ™å¤‡ä»½ç­–ç•¥](#5-è§„åˆ™å¤‡ä»½ç­–ç•¥)
6. [ç‰ˆæœ¬æ§åˆ¶ç®¡ç†](#6-ç‰ˆæœ¬æ§åˆ¶ç®¡ç†)
7. [è§„åˆ™æ¨¡æ¿åˆ¶ä½œ](#7-è§„åˆ™æ¨¡æ¿åˆ¶ä½œ)
8. [æ‰¹é‡éƒ¨ç½²æ–¹æ³•](#8-æ‰¹é‡éƒ¨ç½²æ–¹æ³•)
9. [é…ç½®åŒæ­¥ç­–ç•¥](#9-é…ç½®åŒæ­¥ç­–ç•¥)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦è§„åˆ™æŒä¹…åŒ–


### 1.1 iptablesè§„åˆ™çš„"å¥å¿˜ç—‡"


**ä»€ä¹ˆæ˜¯è§„åˆ™ä¸¢å¤±é—®é¢˜**ï¼š
æƒ³è±¡ä¸€ä¸‹ï¼Œä½ ç²¾å¿ƒé…ç½®äº†ä¸€æ•´å¥—é˜²ç«å¢™è§„åˆ™ï¼Œä¿æŠ¤æœåŠ¡å™¨çš„å®‰å…¨ã€‚ä½†æ˜¯å½“æœåŠ¡å™¨é‡å¯åï¼Œä½ ä¼šå‘ç°ä¸€ä¸ªä»¤äººå´©æºƒçš„äº‹å®ï¼š**æ‰€æœ‰çš„ iptables è§„åˆ™éƒ½æ¶ˆå¤±äº†ï¼**

```
æœåŠ¡å™¨é‡å¯å‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç²¾å¿ƒé…ç½®çš„é˜²ç«å¢™è§„åˆ™        â”‚
â”‚ âœ… åªå…è®¸SSHç«¯å£22          â”‚
â”‚ âœ… å¼€æ”¾Webç«¯å£80/443        â”‚
â”‚ âœ… ç¦æ­¢å±é™©ç«¯å£è®¿é—®         â”‚
â”‚ âœ… é™åˆ¶è¿æ¥é¢‘ç‡             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœåŠ¡å™¨é‡å¯åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç©ºç©ºå¦‚ä¹Ÿçš„è§„åˆ™è¡¨            â”‚
â”‚ âŒ æ‰€æœ‰è§„åˆ™éƒ½æ¶ˆå¤±äº†         â”‚
â”‚ âŒ é˜²ç«å¢™å½¢åŒè™šè®¾           â”‚
â”‚ âŒ å®‰å…¨é£é™©æš´éœ²             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆä¼šè¿™æ ·**ï¼š
- iptables è§„åˆ™å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä¸æ˜¯ç¡¬ç›˜ä¸Š
- ç³»ç»Ÿé‡å¯æ—¶ï¼Œå†…å­˜æ¸…ç©ºï¼Œè§„åˆ™è‡ªç„¶æ¶ˆå¤±
- å°±åƒç”µè„‘å…³æœºåï¼Œå†…å­˜é‡Œçš„æ•°æ®ä¼šä¸¢å¤±ä¸€æ ·

### 1.2 æŒä¹…åŒ–çš„é‡è¦æ€§


> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šæŒä¹…åŒ–å°±æ˜¯æŠŠè§„åˆ™"å†™åœ¨çº¸ä¸Š"ï¼Œè€Œä¸åªæ˜¯"è®°åœ¨è„‘å­é‡Œ"

**æŒä¹…åŒ–çš„å¥½å¤„**ï¼š
- ğŸ”’ **å®‰å…¨ä¿éšœ**ï¼šé‡å¯åé˜²ç«å¢™è§„åˆ™ä»ç„¶æœ‰æ•ˆ
- âš¡ **è¿ç»´æ•ˆç‡**ï¼šæ— éœ€é‡å¤æ‰‹åŠ¨é…ç½®è§„åˆ™
- ğŸ›¡ï¸ **ä¸šåŠ¡è¿ç»­æ€§**ï¼šé¿å…é‡å¯åçš„å®‰å…¨ç©ºçª—æœŸ
- ğŸ“‹ **æ ‡å‡†åŒ–ç®¡ç†**ï¼šè§„åˆ™å¯ä»¥ç‰ˆæœ¬åŒ–ã€æ¨¡æ¿åŒ–

---

## 2. ğŸ’¾ iptables-saveè§„åˆ™ä¿å­˜


### 2.1 iptables-saveå‘½ä»¤è¯¦è§£


**ä»€ä¹ˆæ˜¯ iptables-save**ï¼š
è¿™æ˜¯ Linux ç³»ç»Ÿæä¾›çš„"è§„åˆ™å¯¼å‡ºå·¥å…·"ï¼Œå°±åƒç»™ä½ çš„é˜²ç«å¢™è§„åˆ™æ‹ä¸ª"å¿«ç…§"ï¼Œä¿å­˜å½“å‰æ‰€æœ‰çš„è§„åˆ™é…ç½®ã€‚

**åŸºæœ¬è¯­æ³•**ï¼š
```bash
iptables-save [é€‰é¡¹] [è¡¨å]
```

**å¸¸ç”¨é€‰é¡¹è¯´æ˜**ï¼š

| é€‰é¡¹ | å«ä¹‰ | ç”¨é€” |
|------|------|------|
| æ— é€‰é¡¹ | å¯¼å‡ºæ‰€æœ‰è¡¨çš„è§„åˆ™ | `iptables-save` |
| `-t è¡¨å` | å¯¼å‡ºæŒ‡å®šè¡¨çš„è§„åˆ™ | `iptables-save -t filter` |
| `-c` | åŒ…å«åŒ…è®¡æ•°å™¨ä¿¡æ¯ | `iptables-save -c` |

### 2.2 è§„åˆ™å¯¼å‡ºå®æˆ˜


**ğŸ’» æŸ¥çœ‹å½“å‰è§„åˆ™**ï¼š
```bash
# æŸ¥çœ‹å½“å‰filterè¡¨è§„åˆ™
iptables -L -n --line-numbers

Chain INPUT (policy ACCEPT)
num  target     prot opt source       destination
1    ACCEPT     tcp  --  0.0.0.0/0    0.0.0.0/0    tcp dpt:22
2    ACCEPT     tcp  --  0.0.0.0/0    0.0.0.0/0    tcp dpt:80
3    DROP       all  --  0.0.0.0/0    0.0.0.0/0
```

**ğŸ’¾ å¯¼å‡ºè§„åˆ™åˆ°æ–‡ä»¶**ï¼š
```bash
# æ–¹æ³•1ï¼šå¯¼å‡ºæ‰€æœ‰è§„åˆ™åˆ°æ–‡ä»¶
iptables-save > /etc/iptables/rules.v4

# æ–¹æ³•2ï¼šå¯¼å‡ºæŒ‡å®šè¡¨çš„è§„åˆ™
iptables-save -t filter > /tmp/filter_rules.txt

# æ–¹æ³•3ï¼šå¯¼å‡ºåŒ…å«è®¡æ•°å™¨çš„è§„åˆ™
iptables-save -c > /etc/iptables/rules_with_counters.v4
```

### 2.3 å¯¼å‡ºæ–‡ä»¶æ ¼å¼è§£æ


**å¯¼å‡ºæ–‡ä»¶å†…å®¹ç¤ºä¾‹**ï¼š
```bash
# Generated by iptables-save v1.8.4 on Sun Sep 21 08:30:00 2025
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -p tcp --dport 22 -j ACCEPT
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -j DROP
COMMIT
# Completed on Sun Sep 21 08:30:00 2025
```

**æ–‡ä»¶ç»“æ„è§£é‡Š**ï¼š
- `# Generated by...`ï¼šæ³¨é‡Šè¡Œï¼Œè®°å½•ç”Ÿæˆæ—¶é—´
- `*filter`ï¼šè¡¨åæ ‡è¯†ï¼Œå¼€å§‹filterè¡¨çš„è§„åˆ™
- `:INPUT ACCEPT [0:0]`ï¼šé“¾çš„é»˜è®¤ç­–ç•¥å’Œè®¡æ•°å™¨
- `-A INPUT...`ï¼šå…·ä½“çš„è§„åˆ™æ¡ç›®
- `COMMIT`ï¼šæäº¤æ ‡è®°ï¼Œè¡¨ç¤ºè§„åˆ™ç»“æŸ

---

## 3. ğŸ“ è§„åˆ™é…ç½®æ–‡ä»¶è¯¦è§£


### 3.1 ç³»ç»Ÿé»˜è®¤å­˜å‚¨ä½ç½®


**ä¸åŒç³»ç»Ÿçš„è§„åˆ™æ–‡ä»¶ä½ç½®**ï¼š

```
Ubuntu/Debian ç³»ç»Ÿï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /etc/iptables/             â”‚
â”‚ â”œâ”€â”€ rules.v4 (IPv4è§„åˆ™)    â”‚
â”‚ â””â”€â”€ rules.v6 (IPv6è§„åˆ™)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CentOS/RHEL ç³»ç»Ÿï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /etc/sysconfig/            â”‚
â”‚ â”œâ”€â”€ iptables (IPv4è§„åˆ™)    â”‚
â”‚ â””â”€â”€ ip6tables (IPv6è§„åˆ™)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é€šç”¨ä½ç½®ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /etc/iptables/             â”‚
â”‚ â”œâ”€â”€ rules.v4               â”‚
â”‚ â”œâ”€â”€ rules.v6               â”‚
â”‚ â””â”€â”€ backup/                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 åˆ›å»ºè§„åˆ™ç›®å½•ç»“æ„


**ğŸ’» æ ‡å‡†ç›®å½•åˆ›å»º**ï¼š
```bash
# åˆ›å»ºiptablesé…ç½®ç›®å½•
sudo mkdir -p /etc/iptables
sudo mkdir -p /etc/iptables/backup
sudo mkdir -p /etc/iptables/templates

# è®¾ç½®åˆé€‚çš„æƒé™
sudo chmod 755 /etc/iptables
sudo chmod 700 /etc/iptables/backup
```

### 3.3 è§„åˆ™æ–‡ä»¶å†…å®¹è§„èŒƒ


**æ ‡å‡†è§„åˆ™æ–‡ä»¶æ¨¡æ¿**ï¼š
```bash
# ============================================
# iptablesè§„åˆ™é…ç½®æ–‡ä»¶
# åˆ›å»ºæ—¶é—´ï¼š2025-09-21
# ç»´æŠ¤äººå‘˜ï¼šç³»ç»Ÿç®¡ç†å‘˜
# æœåŠ¡å™¨ï¼šWebæœåŠ¡å™¨
# ============================================

*filter
# è®¾ç½®é»˜è®¤ç­–ç•¥
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# å…è®¸æœ¬åœ°å›ç¯
-A INPUT -i lo -j ACCEPT

# å…è®¸å·²å»ºç«‹çš„è¿æ¥
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# å…è®¸SSHè¿æ¥(ç«¯å£22)
-A INPUT -p tcp --dport 22 -j ACCEPT

# å…è®¸WebæœåŠ¡(ç«¯å£80,443)
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT

# æœ€åæ‹’ç»æ‰€æœ‰å…¶ä»–è¿æ¥
-A INPUT -j DROP

COMMIT
```

---

## 4. ğŸš€ å¼€æœºè‡ªåŠ¨åŠ è½½è§„åˆ™


### 4.1 systemdæœåŠ¡æ–¹å¼ï¼ˆæ¨èï¼‰


**ä»€ä¹ˆæ˜¯systemdæœåŠ¡**ï¼š
systemdæ˜¯ç°ä»£Linuxç³»ç»Ÿçš„æœåŠ¡ç®¡ç†å™¨ï¼Œå°±åƒä¸€ä¸ª"å¼€æœºå¯åŠ¨ç®¡å®¶"ï¼Œå¯ä»¥åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡ŒæŒ‡å®šçš„ä»»åŠ¡ã€‚

**ğŸ”§ åˆ›å»ºiptablesæœåŠ¡æ–‡ä»¶**ï¼š
```bash
# åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶
sudo vim /etc/systemd/system/iptables-restore.service
```

**æœåŠ¡æ–‡ä»¶å†…å®¹**ï¼š
```ini
[Unit]
Description=Restore iptables rules
After=network.target

[Service]
Type=oneshot
ExecStart=/sbin/iptables-restore /etc/iptables/rules.v4
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```

**é…ç½®è¯´æ˜**ï¼š
- `Description`ï¼šæœåŠ¡æè¿°ï¼Œå°±æ˜¯ç»™è¿™ä¸ªæœåŠ¡èµ·ä¸ªåå­—
- `After=network.target`ï¼šåœ¨ç½‘ç»œå¯åŠ¨åå†åŠ è½½è§„åˆ™
- `Type=oneshot`ï¼šä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œå°±ç»“æŸ
- `ExecStart`ï¼šå…·ä½“è¦æ‰§è¡Œçš„å‘½ä»¤
- `RemainAfterExit=yes`ï¼šä»»åŠ¡å®Œæˆåä¿æŒæ¿€æ´»çŠ¶æ€

**ğŸ’» å¯ç”¨æœåŠ¡**ï¼š
```bash
# é‡æ–°åŠ è½½systemdé…ç½®
sudo systemctl daemon-reload

# å¯ç”¨å¼€æœºè‡ªå¯
sudo systemctl enable iptables-restore.service

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status iptables-restore.service
```

### 4.2 ä½¿ç”¨iptables-persistentåŒ…ï¼ˆUbuntuï¼‰


**å®‰è£…persistentåŒ…**ï¼š
```bash
# å®‰è£…iptables-persistentåŒ…
sudo apt update
sudo apt install iptables-persistent

# å®‰è£…è¿‡ç¨‹ä¸­ä¼šè¯¢é—®æ˜¯å¦ä¿å­˜å½“å‰è§„åˆ™
# é€‰æ‹©Yesä¿å­˜å½“å‰è§„åˆ™åˆ°æ–‡ä»¶
```

**ç®¡ç†å‘½ä»¤**ï¼š
```bash
# ä¿å­˜å½“å‰è§„åˆ™
sudo netfilter-persistent save

# é‡æ–°åŠ è½½è§„åˆ™
sudo netfilter-persistent reload

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status netfilter-persistent
```

### 4.3 rc.localæ–¹å¼ï¼ˆä¼ ç»Ÿæ–¹æ³•ï¼‰


**ç¼–è¾‘rc.localæ–‡ä»¶**ï¼š
```bash
# ç¼–è¾‘å¼€æœºå¯åŠ¨è„šæœ¬
sudo vim /etc/rc.local

# åœ¨exit 0ä¹‹å‰æ·»åŠ ï¼š
/sbin/iptables-restore < /etc/iptables/rules.v4

# ä½¿æ–‡ä»¶å¯æ‰§è¡Œ
sudo chmod +x /etc/rc.local
```

---

## 5. ğŸ“¦ è§„åˆ™å¤‡ä»½ç­–ç•¥


### 5.1 æ‰‹åŠ¨å¤‡ä»½æ–¹æ³•


**ğŸ’¾ åˆ›å»ºå¤‡ä»½è„šæœ¬**ï¼š
```bash
#!/bin/bash
# iptablesè§„åˆ™å¤‡ä»½è„šæœ¬

# è®¾ç½®å˜é‡
BACKUP_DIR="/etc/iptables/backup"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="iptables_${DATE}.rules"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½å½“å‰è§„åˆ™
iptables-save > "${BACKUP_DIR}/${BACKUP_FILE}"

# ä¿ç•™æœ€è¿‘30å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "iptables_*.rules" -mtime +30 -delete

echo "è§„åˆ™å·²å¤‡ä»½åˆ°: ${BACKUP_DIR}/${BACKUP_FILE}"
```

**ä½¿ç”¨å¤‡ä»½è„šæœ¬**ï¼š
```bash
# ä¿å­˜è„šæœ¬
sudo vim /usr/local/bin/iptables-backup.sh
sudo chmod +x /usr/local/bin/iptables-backup.sh

# æ‰§è¡Œå¤‡ä»½
sudo /usr/local/bin/iptables-backup.sh
```

### 5.2 è‡ªåŠ¨å¤‡ä»½é…ç½®


**è®¾ç½®å®šæ—¶å¤‡ä»½ä»»åŠ¡**ï¼š
```bash
# ç¼–è¾‘crontab
sudo crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨å¤‡ä»½ï¼‰
0 2 * * * /usr/local/bin/iptables-backup.sh
```

**ğŸ“Š å¤‡ä»½æ–‡ä»¶ç®¡ç†ç­–ç•¥**ï¼š

| å¤‡ä»½ç±»å‹ | ä¿å­˜æ—¶é—´ | å¤‡ä»½é¢‘ç‡ | æ–‡ä»¶å‘½å |
|----------|----------|----------|----------|
| **æ—¥å¸¸å¤‡ä»½** | 30å¤© | æ¯å¤©1æ¬¡ | `iptables_YYYYMMDD.rules` |
| **æœˆåº¦å¤‡ä»½** | 12ä¸ªæœˆ | æ¯æœˆ1æ¬¡ | `iptables_monthly_YYYYMM.rules` |
| **ç‰ˆæœ¬å¤‡ä»½** | æ°¸ä¹…ä¿å­˜ | å˜æ›´æ—¶ | `iptables_v1.0_description.rules` |

### 5.3 å¤‡ä»½éªŒè¯å’Œæ¢å¤


**éªŒè¯å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§**ï¼š
```bash
# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶è¯­æ³•
iptables-restore --test < /etc/iptables/backup/iptables_20250921.rules

# å¦‚æœæ²¡æœ‰é”™è¯¯è¾“å‡ºï¼Œè¯´æ˜å¤‡ä»½æ–‡ä»¶æ­£å¸¸
```

**è§„åˆ™æ¢å¤æ“ä½œ**ï¼š
```bash
# æ–¹æ³•1ï¼šç›´æ¥æ¢å¤ï¼ˆå±é™©ï¼Œä¼šæ¸…ç©ºç°æœ‰è§„åˆ™ï¼‰
sudo iptables-restore < /etc/iptables/backup/iptables_20250921.rules

# æ–¹æ³•2ï¼šå®‰å…¨æ¢å¤ï¼ˆå…ˆå¤‡ä»½å½“å‰è§„åˆ™ï¼‰
sudo iptables-save > /tmp/current_rules_backup.rules
sudo iptables-restore < /etc/iptables/backup/iptables_20250921.rules
```

---

## 6. ğŸ“ ç‰ˆæœ¬æ§åˆ¶ç®¡ç†


### 6.1 ä½¿ç”¨Gitç®¡ç†è§„åˆ™æ–‡ä»¶


**ä¸ºä»€ä¹ˆè¦ç”¨ç‰ˆæœ¬æ§åˆ¶**ï¼š
ç‰ˆæœ¬æ§åˆ¶å°±åƒç»™ä½ çš„é˜²ç«å¢™è§„åˆ™å»ºç«‹ä¸€ä¸ª"æ—¶å…‰æœºå™¨"ï¼Œä½ å¯ä»¥ï¼š
- ğŸ“ è®°å½•æ¯æ¬¡è§„åˆ™å˜æ›´çš„åŸå› 
- ğŸ”„ éšæ—¶å›é€€åˆ°ä¹‹å‰çš„ç‰ˆæœ¬
- ğŸ‘¥ å¤šäººåä½œæ—¶é¿å…å†²çª
- ğŸ“Š æŸ¥çœ‹è§„åˆ™æ¼”å˜å†å²

**ğŸ”§ åˆå§‹åŒ–Gitä»“åº“**ï¼š
```bash
# è¿›å…¥iptablesé…ç½®ç›®å½•
cd /etc/iptables

# åˆå§‹åŒ–gitä»“åº“
sudo git init

# åˆ›å»º.gitignoreæ–‡ä»¶
sudo cat > .gitignore << EOF
# å¿½ç•¥ä¸´æ—¶æ–‡ä»¶
*.tmp
*.log
# å¿½ç•¥æ•æ„Ÿä¿¡æ¯
*password*
*secret*
EOF

# æ·»åŠ è§„åˆ™æ–‡ä»¶
sudo git add rules.v4 rules.v6
sudo git commit -m "åˆå§‹ç‰ˆæœ¬ï¼šåŸºç¡€é˜²ç«å¢™è§„åˆ™"
```

### 6.2 è§„åˆ™å˜æ›´ç®¡ç†æµç¨‹


**ğŸ“‹ æ ‡å‡†å˜æ›´æµç¨‹**ï¼š

```
1. å˜æ›´å‰å‡†å¤‡
   â”œâ”€â”€ å¤‡ä»½å½“å‰è§„åˆ™
   â”œâ”€â”€ è®°å½•å˜æ›´åŸå› 
   â””â”€â”€ åˆ¶å®šå›æ»šè®¡åˆ’

2. å®æ–½å˜æ›´
   â”œâ”€â”€ ä¿®æ”¹è§„åˆ™é…ç½®
   â”œâ”€â”€ æµ‹è¯•æ–°è§„åˆ™
   â””â”€â”€ ç¡®è®¤åŠŸèƒ½æ­£å¸¸

3. å˜æ›´åå¤„ç†
   â”œâ”€â”€ ä¿å­˜æ–°è§„åˆ™
   â”œâ”€â”€ æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
   â””â”€â”€ æ›´æ–°æ–‡æ¡£è¯´æ˜
```

**ğŸ’» å®é™…æ“ä½œç¤ºä¾‹**ï¼š
```bash
# 1. å˜æ›´å‰å¤‡ä»½
sudo iptables-save > /tmp/before_change.rules
sudo git add -A
sudo git commit -m "å˜æ›´å‰å¤‡ä»½: $(date)"

# 2. ä¿®æ”¹è§„åˆ™ï¼ˆä¾‹å¦‚å¼€æ”¾æ–°ç«¯å£ï¼‰
sudo iptables -A INPUT -p tcp --dport 8080 -j ACCEPT

# 3. æµ‹è¯•æ–°è§„åˆ™
curl -I http://localhost:8080

# 4. ä¿å­˜æ–°è§„åˆ™
sudo iptables-save > /etc/iptables/rules.v4

# 5. æäº¤ç‰ˆæœ¬æ§åˆ¶
sudo git add rules.v4
sudo git commit -m "æ–°å¢ç«¯å£8080è®¿é—®è§„åˆ™ï¼šæ”¯æŒæ–°åº”ç”¨éƒ¨ç½²"
```

### 6.3 ç‰ˆæœ¬æ ‡ç­¾ç®¡ç†


**åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾**ï¼š
```bash
# ä¸ºé‡è¦ç‰ˆæœ¬åˆ›å»ºæ ‡ç­¾
sudo git tag -a v1.0 -m "ç”Ÿäº§ç¯å¢ƒåˆå§‹ç‰ˆæœ¬"
sudo git tag -a v1.1 -m "å¢åŠ Webåº”ç”¨æ”¯æŒ"
sudo git tag -a v2.0 -m "é‡æ„å®‰å…¨ç­–ç•¥"

# æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬
sudo git tag -l

# å›é€€åˆ°æŒ‡å®šç‰ˆæœ¬
sudo git checkout v1.0
sudo cp rules.v4 /etc/iptables/
sudo iptables-restore < /etc/iptables/rules.v4
```

---

## 7. ğŸ“‹ è§„åˆ™æ¨¡æ¿åˆ¶ä½œ


### 7.1 é€šç”¨è§„åˆ™æ¨¡æ¿


**ä»€ä¹ˆæ˜¯è§„åˆ™æ¨¡æ¿**ï¼š
è§„åˆ™æ¨¡æ¿å°±åƒ"æ ‡å‡†ç­”æ¡ˆ"ï¼Œé’ˆå¯¹ä¸åŒç±»å‹çš„æœåŠ¡å™¨ï¼Œé¢„å…ˆè®¾è®¡å¥½å®‰å…¨è§„åˆ™ï¼Œéœ€è¦æ—¶ç›´æ¥ä½¿ç”¨ï¼Œé¿å…é‡å¤è®¾è®¡ã€‚

**ğŸŒ WebæœåŠ¡å™¨æ¨¡æ¿**ï¼š
```bash
# ==========================================
# WebæœåŠ¡å™¨iptablesè§„åˆ™æ¨¡æ¿
# é€‚ç”¨äºï¼šApache/Nginx WebæœåŠ¡å™¨
# å®‰å…¨çº§åˆ«ï¼šä¸­ç­‰
# ==========================================

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# åŸºç¡€è¿æ¥å…è®¸
-A INPUT -i lo -j ACCEPT
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# SSHç®¡ç†ç«¯å£
-A INPUT -p tcp --dport 22 -m state --state NEW -m recent --set
-A INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 60 --hitcount 4 -j DROP
-A INPUT -p tcp --dport 22 -j ACCEPT

# WebæœåŠ¡ç«¯å£
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT

# ICMPå…è®¸ï¼ˆpingï¼‰
-A INPUT -p icmp --icmp-type echo-request -j ACCEPT

COMMIT
```

**ğŸ—„ï¸ æ•°æ®åº“æœåŠ¡å™¨æ¨¡æ¿**ï¼š
```bash
# ==========================================
# æ•°æ®åº“æœåŠ¡å™¨iptablesè§„åˆ™æ¨¡æ¿
# é€‚ç”¨äºï¼šMySQL/PostgreSQLæœåŠ¡å™¨
# å®‰å…¨çº§åˆ«ï¼šé«˜
# ==========================================

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# åŸºç¡€è¿æ¥
-A INPUT -i lo -j ACCEPT
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# SSHç®¡ç†ï¼ˆé™åˆ¶æºIPï¼‰
-A INPUT -s 192.168.1.0/24 -p tcp --dport 22 -j ACCEPT

# æ•°æ®åº“ç«¯å£ï¼ˆä»…å…è®¸åº”ç”¨æœåŠ¡å™¨ï¼‰
-A INPUT -s 192.168.1.100 -p tcp --dport 3306 -j ACCEPT
-A INPUT -s 192.168.1.101 -p tcp --dport 3306 -j ACCEPT

# ç›‘æ§ç«¯å£ï¼ˆä»…å…è®¸ç›‘æ§æœåŠ¡å™¨ï¼‰
-A INPUT -s 192.168.1.200 -p tcp --dport 9100 -j ACCEPT

COMMIT
```

### 7.2 æ¨¡æ¿å‚æ•°åŒ–


**åˆ›å»ºå¯é…ç½®æ¨¡æ¿**ï¼š
```bash
#!/bin/bash
# iptablesè§„åˆ™æ¨¡æ¿ç”Ÿæˆè„šæœ¬

# é…ç½®å‚æ•°
SSH_PORT=${1:-22}
WEB_PORTS=${2:-"80 443"}
ADMIN_NETWORK=${3:-"192.168.1.0/24"}
SERVER_TYPE=${4:-"web"}

cat > /tmp/iptables_template.rules << EOF
# ==========================================
# ${SERVER_TYPE}æœåŠ¡å™¨iptablesè§„åˆ™
# ç”Ÿæˆæ—¶é—´: $(date)
# SSHç«¯å£: ${SSH_PORT}
# Webç«¯å£: ${WEB_PORTS}
# ç®¡ç†ç½‘æ®µ: ${ADMIN_NETWORK}
# ==========================================

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# åŸºç¡€è¿æ¥
-A INPUT -i lo -j ACCEPT
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# SSHç®¡ç†
-A INPUT -s ${ADMIN_NETWORK} -p tcp --dport ${SSH_PORT} -j ACCEPT

EOF

# æ ¹æ®æœåŠ¡ç±»å‹æ·»åŠ ç‰¹å®šè§„åˆ™
if [ "$SERVER_TYPE" = "web" ]; then
    for port in $WEB_PORTS; do
        echo "-A INPUT -p tcp --dport $port -j ACCEPT" >> /tmp/iptables_template.rules
    done
fi

echo "COMMIT" >> /tmp/iptables_template.rules
echo "æ¨¡æ¿å·²ç”Ÿæˆ: /tmp/iptables_template.rules"
```

### 7.3 æ¨¡æ¿ä½¿ç”¨å’Œè‡ªå®šä¹‰


**ä½¿ç”¨æ¨¡æ¿çš„æ ‡å‡†æµç¨‹**ï¼š

> ğŸ“‹ **æ¨¡æ¿ä½¿ç”¨æ£€æŸ¥æ¸…å•**
> - [x] ç¡®è®¤æœåŠ¡å™¨ç±»å‹å’Œç”¨é€”
> - [x] æ£€æŸ¥ç½‘ç»œç¯å¢ƒå’Œç«¯å£éœ€æ±‚  
> - [x] ä¿®æ”¹æ¨¡æ¿ä¸­çš„IPåœ°å€æ®µ
> - [x] æ·»åŠ ä¸šåŠ¡ç‰¹å®šç«¯å£
> - [x] æµ‹è¯•è§„åˆ™æœ‰æ•ˆæ€§
> - [x] å¤‡ä»½åŸæœ‰è§„åˆ™

**ğŸ’» æ¨¡æ¿åº”ç”¨å®ä¾‹**ï¼š
```bash
# 1. å¤åˆ¶åˆé€‚çš„æ¨¡æ¿
cp /etc/iptables/templates/web_server.rules /etc/iptables/rules.v4

# 2. æ ¹æ®å®é™…ç¯å¢ƒä¿®æ”¹
sed -i 's/192.168.1.0\/24/10.0.0.0\/24/g' /etc/iptables/rules.v4

# 3. æ·»åŠ è‡ªå®šä¹‰ç«¯å£
echo "-A INPUT -p tcp --dport 8080 -j ACCEPT" >> /etc/iptables/rules.v4

# 4. æµ‹è¯•è§„åˆ™
iptables-restore --test < /etc/iptables/rules.v4

# 5. åº”ç”¨è§„åˆ™
iptables-restore < /etc/iptables/rules.v4
```

---

## 8. ğŸš¢ æ‰¹é‡éƒ¨ç½²æ–¹æ³•


### 8.1 ä½¿ç”¨Ansibleæ‰¹é‡éƒ¨ç½²


**ä»€ä¹ˆæ˜¯Ansible**ï¼š
Ansibleæ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–è¿ç»´å·¥å…·ï¼Œå°±åƒä¸€ä¸ª"æŒ‡æŒ¥å®˜"ï¼Œå¯ä»¥åŒæ—¶å‘å¤šå°æœåŠ¡å™¨ä¸‹è¾¾ç›¸åŒçš„å‘½ä»¤ï¼Œå®ç°æ‰¹é‡ç®¡ç†ã€‚

**ğŸ”§ Ansible playbookç¤ºä¾‹**ï¼š
```yaml
# iptables-deploy.yml
---
- name: æ‰¹é‡éƒ¨ç½²iptablesè§„åˆ™
  hosts: web_servers
  become: yes
  vars:
    iptables_rules_file: /etc/iptables/rules.v4
    
  tasks:
    - name: å¤‡ä»½ç°æœ‰è§„åˆ™
      shell: iptables-save > /tmp/iptables_backup_{{ ansible_date_time.epoch }}.rules
      
    - name: åˆ›å»ºiptablesç›®å½•
      file:
        path: /etc/iptables
        state: directory
        mode: '0755'
        
    - name: å¤åˆ¶è§„åˆ™æ–‡ä»¶
      copy:
        src: templates/{{ server_type }}_rules.v4
        dest: "{{ iptables_rules_file }}"
        mode: '0644'
        backup: yes
        
    - name: æµ‹è¯•è§„åˆ™è¯­æ³•
      shell: iptables-restore --test < {{ iptables_rules_file }}
      
    - name: åº”ç”¨iptablesè§„åˆ™
      shell: iptables-restore < {{ iptables_rules_file }}
      
    - name: å®‰è£…iptables-persistent
      apt:
        name: iptables-persistent
        state: present
      when: ansible_os_family == "Debian"
```

**æ‰§è¡Œæ‰¹é‡éƒ¨ç½²**ï¼š
```bash
# éƒ¨ç½²åˆ°WebæœåŠ¡å™¨ç»„
ansible-playbook -i inventory iptables-deploy.yml -e "server_type=web"

# éƒ¨ç½²åˆ°æ•°æ®åº“æœåŠ¡å™¨ç»„  
ansible-playbook -i inventory iptables-deploy.yml -e "server_type=database"
```

### 8.2 ä½¿ç”¨è„šæœ¬æ‰¹é‡éƒ¨ç½²


**ğŸ“œ æ‰¹é‡éƒ¨ç½²è„šæœ¬**ï¼š
```bash
#!/bin/bash
# iptablesæ‰¹é‡éƒ¨ç½²è„šæœ¬

# æœåŠ¡å™¨åˆ—è¡¨
SERVERS=(
    "192.168.1.10"
    "192.168.1.11" 
    "192.168.1.12"
)

# SSHç”¨æˆ·å’Œå¯†é’¥
SSH_USER="admin"
SSH_KEY="/root/.ssh/id_rsa"

# è§„åˆ™æ–‡ä»¶
RULES_FILE="/etc/iptables/templates/web_server.rules"

# éƒ¨ç½²å‡½æ•°
deploy_to_server() {
    local server=$1
    echo "éƒ¨ç½²åˆ°æœåŠ¡å™¨: $server"
    
    # 1. å¤‡ä»½è¿œç¨‹æœåŠ¡å™¨ç°æœ‰è§„åˆ™
    ssh -i $SSH_KEY $SSH_USER@$server "sudo iptables-save > /tmp/backup_$(date +%Y%m%d_%H%M%S).rules"
    
    # 2. ä¼ è¾“è§„åˆ™æ–‡ä»¶
    scp -i $SSH_KEY $RULES_FILE $SSH_USER@$server:/tmp/new_rules.v4
    
    # 3. åº”ç”¨æ–°è§„åˆ™
    ssh -i $SSH_KEY $SSH_USER@$server "sudo iptables-restore < /tmp/new_rules.v4"
    
    # 4. ä¿å­˜è§„åˆ™
    ssh -i $SSH_KEY $SSH_USER@$server "sudo iptables-save > /etc/iptables/rules.v4"
    
    echo "æœåŠ¡å™¨ $server éƒ¨ç½²å®Œæˆ"
}

# æ‰¹é‡éƒ¨ç½²
for server in "${SERVERS[@]}"; do
    deploy_to_server $server
done

echo "æ‰€æœ‰æœåŠ¡å™¨éƒ¨ç½²å®Œæˆ"
```

### 8.3 éƒ¨ç½²éªŒè¯å’Œå›æ»š


**ğŸ” éƒ¨ç½²åéªŒè¯è„šæœ¬**ï¼š
```bash
#!/bin/bash
# éªŒè¯iptablesè§„åˆ™éƒ¨ç½²ç»“æœ

verify_server() {
    local server=$1
    echo "éªŒè¯æœåŠ¡å™¨: $server"
    
    # æ£€æŸ¥SSHè¿æ¥
    if ssh -i $SSH_KEY $SSH_USER@$server "echo 'SSHè¿æ¥æ­£å¸¸'"; then
        echo "âœ… SSHè¿æ¥: æ­£å¸¸"
    else
        echo "âŒ SSHè¿æ¥: å¤±è´¥"
        return 1
    fi
    
    # æ£€æŸ¥WebæœåŠ¡
    if curl -s -o /dev/null -w "%{http_code}" http://$server | grep -q "200\|301\|302"; then
        echo "âœ… WebæœåŠ¡: æ­£å¸¸"
    else
        echo "âŒ WebæœåŠ¡: æ— æ³•è®¿é—®"
    fi
    
    # æ£€æŸ¥iptablesè§„åˆ™æ•°é‡
    rule_count=$(ssh -i $SSH_KEY $SSH_USER@$server "sudo iptables -L | wc -l")
    echo "ğŸ“Š è§„åˆ™æ•°é‡: $rule_count æ¡"
}

# å¿«é€Ÿå›æ»šå‡½æ•°
rollback_server() {
    local server=$1
    local backup_file=$2
    
    echo "å›æ»šæœåŠ¡å™¨: $server"
    ssh -i $SSH_KEY $SSH_USER@$server "sudo iptables-restore < $backup_file"
    echo "æœåŠ¡å™¨ $server å·²å›æ»š"
}
```

---

## 9. ğŸ”„ é…ç½®åŒæ­¥ç­–ç•¥


### 9.1 ä¸»ä»åŒæ­¥æ¨¡å¼


**ä»€ä¹ˆæ˜¯ä¸»ä»åŒæ­¥**ï¼š
ç±»ä¼¼äº"å¸ˆçˆ¶å¸¦å¾’å¼Ÿ"çš„æ¨¡å¼ï¼Œæœ‰ä¸€å°ä¸»æœåŠ¡å™¨ä½œä¸º"æ ‡å‡†ç­”æ¡ˆ"ï¼Œå…¶ä»–æœåŠ¡å™¨å®šæœŸå‘ä¸»æœåŠ¡å™¨å­¦ä¹ ï¼Œä¿æŒè§„åˆ™ä¸€è‡´ã€‚

**ğŸ—ï¸ åŒæ­¥æ¶æ„è®¾è®¡**ï¼š
```
ä¸»é…ç½®æœåŠ¡å™¨ (Master)
        â”‚
        â”œâ”€â”€ å­˜å‚¨æ ‡å‡†è§„åˆ™é…ç½®
        â”œâ”€â”€ ç‰ˆæœ¬æ§åˆ¶ç®¡ç†
        â””â”€â”€ é…ç½®å˜æ›´å®¡æ‰¹
        
        â”‚ (å®šæœŸåŒæ­¥)
        â–¼
        
ä»æœåŠ¡å™¨ç¾¤ (Slaves)
â”œâ”€â”€ WebæœåŠ¡å™¨1 â”€â”€â”
â”œâ”€â”€ WebæœåŠ¡å™¨2   â”œâ”€â”€ å®šæœŸæ‹‰å–æœ€æ–°é…ç½®
â”œâ”€â”€ æ•°æ®åº“æœåŠ¡å™¨ â”œâ”€â”€ è‡ªåŠ¨åº”ç”¨è§„åˆ™æ›´æ–°
â””â”€â”€ åº”ç”¨æœåŠ¡å™¨ â”€â”€â”˜
```

**ğŸ”§ åŒæ­¥è„šæœ¬å®ç°**ï¼š
```bash
#!/bin/bash
# iptablesé…ç½®åŒæ­¥è„šæœ¬

# é…ç½®å‚æ•°
MASTER_SERVER="192.168.1.100"
MASTER_USER="config-admin" 
CONFIG_PATH="/etc/iptables/rules.v4"
SYNC_INTERVAL=3600  # åŒæ­¥é—´éš”(ç§’)

# è·å–é…ç½®ç‰ˆæœ¬
get_remote_version() {
    ssh $MASTER_USER@$MASTER_SERVER "md5sum $CONFIG_PATH | cut -d' ' -f1"
}

get_local_version() {
    if [ -f $CONFIG_PATH ]; then
        md5sum $CONFIG_PATH | cut -d' ' -f1
    else
        echo "none"
    fi
}

# åŒæ­¥é…ç½®
sync_config() {
    echo "å¼€å§‹åŒæ­¥iptablesé…ç½®..."
    
    # 1. å¤‡ä»½å½“å‰é…ç½®
    if [ -f $CONFIG_PATH ]; then
        cp $CONFIG_PATH "${CONFIG_PATH}.backup.$(date +%Y%m%d_%H%M%S)"
    fi
    
    # 2. ä¸‹è½½æ–°é…ç½®
    scp $MASTER_USER@$MASTER_SERVER:$CONFIG_PATH /tmp/new_rules.v4
    
    # 3. éªŒè¯é…ç½®è¯­æ³•
    if iptables-restore --test < /tmp/new_rules.v4; then
        echo "é…ç½®è¯­æ³•éªŒè¯é€šè¿‡"
        
        # 4. åº”ç”¨æ–°é…ç½®
        cp /tmp/new_rules.v4 $CONFIG_PATH
        iptables-restore < $CONFIG_PATH
        
        echo "é…ç½®åŒæ­¥å®Œæˆ"
    else
        echo "é…ç½®è¯­æ³•é”™è¯¯ï¼ŒåŒæ­¥å¤±è´¥"
        return 1
    fi
}

# ä¸»åŒæ­¥å¾ªç¯
while true; do
    remote_version=$(get_remote_version)
    local_version=$(get_local_version)
    
    if [ "$remote_version" != "$local_version" ]; then
        echo "æ£€æµ‹åˆ°é…ç½®æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
        sync_config
    else
        echo "é…ç½®å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
    fi
    
    sleep $SYNC_INTERVAL
done
```

### 9.2 é›†ä¸­é…ç½®ç®¡ç†


**ä½¿ç”¨é…ç½®ç®¡ç†ä¸­å¿ƒ**ï¼š

```
é…ç½®ç®¡ç†ä¸­å¿ƒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŒ Webç®¡ç†ç•Œé¢                  â”‚
â”‚ â”œâ”€â”€ è§„åˆ™æ¨¡æ¿ç®¡ç†               â”‚  
â”‚ â”œâ”€â”€ æœåŠ¡å™¨åˆ†ç»„                 â”‚
â”‚ â”œâ”€â”€ é…ç½®å˜æ›´å®¡æ‰¹               â”‚
â”‚ â””â”€â”€ éƒ¨ç½²çŠ¶æ€ç›‘æ§               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Š APIæ¥å£                     â”‚
â”‚ â”œâ”€â”€ GET /api/rules/{group}     â”‚
â”‚ â”œâ”€â”€ POST /api/deploy          â”‚
â”‚ â”œâ”€â”€ GET /api/status           â”‚
â”‚ â””â”€â”€ POST /api/rollback        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’» APIè°ƒç”¨ç¤ºä¾‹**ï¼š
```bash
# è·å–WebæœåŠ¡å™¨ç»„çš„è§„åˆ™
curl -H "Authorization: Bearer $TOKEN" \
     http://config-center/api/rules/web-servers

# éƒ¨ç½²è§„åˆ™åˆ°æŒ‡å®šæœåŠ¡å™¨ç»„
curl -X POST \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"group":"web-servers","version":"v2.1"}' \
     http://config-center/api/deploy

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
curl -H "Authorization: Bearer $TOKEN" \
     http://config-center/api/status/web-servers
```

### 9.3 å®æ—¶ç›‘æ§å’Œå‘Šè­¦


**ğŸ“Š ç›‘æ§æŒ‡æ ‡è®¾è®¡**ï¼š

| ç›‘æ§é¡¹ | æ­£å¸¸èŒƒå›´ | å‘Šè­¦æ¡ä»¶ | å¤„ç†æ–¹å¼ |
|--------|----------|----------|----------|
| **é…ç½®ç‰ˆæœ¬ä¸€è‡´æ€§** | 100% | <95% | è‡ªåŠ¨é‡æ–°åŒæ­¥ |
| **è§„åˆ™åº”ç”¨çŠ¶æ€** | æˆåŠŸ | å¤±è´¥ | å‘é€å‘Šè­¦é€šçŸ¥ |
| **é˜²ç«å¢™æœåŠ¡çŠ¶æ€** | è¿è¡Œä¸­ | åœæ­¢ | è‡ªåŠ¨é‡å¯æœåŠ¡ |
| **è§„åˆ™æ•°é‡å˜åŒ–** | ç¨³å®š | å¼‚å¸¸å¢å‡ | äººå·¥æ£€æŸ¥ç¡®è®¤ |

**ğŸš¨ å‘Šè­¦è„šæœ¬ç¤ºä¾‹**ï¼š
```bash
#!/bin/bash
# iptablesç›‘æ§å‘Šè­¦è„šæœ¬

# ç›‘æ§å‡½æ•°
monitor_iptables_status() {
    # æ£€æŸ¥iptablesæœåŠ¡çŠ¶æ€
    if ! systemctl is-active --quiet iptables; then
        send_alert "iptablesæœåŠ¡æœªè¿è¡Œ" "CRITICAL"
    fi
    
    # æ£€æŸ¥è§„åˆ™æ•°é‡
    rule_count=$(iptables -L | wc -l)
    if [ $rule_count -lt 10 ]; then
        send_alert "iptablesè§„åˆ™æ•°é‡å¼‚å¸¸: $rule_count" "WARNING"
    fi
    
    # æ£€æŸ¥é»˜è®¤ç­–ç•¥
    default_policy=$(iptables -L INPUT | head -1 | grep -o 'policy [A-Z]*' | cut -d' ' -f2)
    if [ "$default_policy" != "DROP" ]; then
        send_alert "INPUTé“¾é»˜è®¤ç­–ç•¥ä¸æ˜¯DROP: $default_policy" "WARNING"
    fi
}

# å‘é€å‘Šè­¦
send_alert() {
    local message=$1
    local level=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # è®°å½•æ—¥å¿—
    echo "[$timestamp] [$level] $message" >> /var/log/iptables-monitor.log
    
    # å‘é€é‚®ä»¶å‘Šè­¦ï¼ˆéœ€è¦é…ç½®é‚®ä»¶æœåŠ¡ï¼‰
    echo "$message" | mail -s "iptableså‘Šè­¦ [$level]" admin@company.com
    
    # å‘é€åˆ°Slackï¼ˆå¯é€‰ï¼‰
    curl -X POST -H 'Content-type: application/json' \
         --data "{\"text\":\"iptableså‘Šè­¦: $message\"}" \
         $SLACK_WEBHOOK_URL
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æŒä¹…åŒ–åŸç†ï¼šiptablesè§„åˆ™å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œé‡å¯ä¼šä¸¢å¤±
ğŸ”¸ ä¿å­˜å‘½ä»¤ï¼šiptables-saveå¯¼å‡ºè§„åˆ™ï¼Œiptables-restoreæ¢å¤è§„åˆ™  
ğŸ”¸ é…ç½®æ–‡ä»¶ï¼š/etc/iptables/rules.v4æ˜¯æ ‡å‡†å­˜å‚¨ä½ç½®
ğŸ”¸ è‡ªåŠ¨åŠ è½½ï¼šsystemdæœåŠ¡ã€persistentåŒ…ã€rc.localä¸‰ç§æ–¹å¼
ğŸ”¸ å¤‡ä»½ç­–ç•¥ï¼šå®šæœŸå¤‡ä»½ã€ç‰ˆæœ¬æ§åˆ¶ã€æ¨¡æ¿ç®¡ç†
ğŸ”¸ æ‰¹é‡éƒ¨ç½²ï¼šAnsibleã€è„šæœ¬ã€é…ç½®ä¸­å¿ƒå¤šç§æ–¹æ¡ˆ
```

### 10.2 å…³é”®æ“ä½œå‘½ä»¤


**ğŸ’» æ ¸å¿ƒå‘½ä»¤æ€»ç»“**ï¼š

| æ“ä½œç±»å‹ | å‘½ä»¤ | è¯´æ˜ |
|----------|------|------|
| **ä¿å­˜è§„åˆ™** | `iptables-save > /etc/iptables/rules.v4` | å¯¼å‡ºå½“å‰è§„åˆ™åˆ°æ–‡ä»¶ |
| **æ¢å¤è§„åˆ™** | `iptables-restore < /etc/iptables/rules.v4` | ä»æ–‡ä»¶æ¢å¤è§„åˆ™ |
| **æµ‹è¯•è§„åˆ™** | `iptables-restore --test < rules.v4` | æµ‹è¯•è§„åˆ™æ–‡ä»¶è¯­æ³• |
| **è‡ªåŠ¨ä¿å­˜** | `netfilter-persistent save` | Ubuntuè‡ªåŠ¨ä¿å­˜ |
| **è‡ªåŠ¨æ¢å¤** | `netfilter-persistent reload` | Ubuntuè‡ªåŠ¨æ¢å¤ |

### 10.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ è¿ç»´æœ€ä½³å®è·µ**ï¼š

> ğŸ’¡ **å®‰å…¨ç¬¬ä¸€åŸåˆ™**
> - å˜æ›´å‰åŠ¡å¿…å¤‡ä»½ç°æœ‰è§„åˆ™
> - è¿œç¨‹æ“ä½œæ—¶ä¿ç•™åº”æ€¥è®¿é—®é€šé“
> - ä½¿ç”¨å®šæ—¶ä»»åŠ¡ç¡®ä¿è§„åˆ™å¤±æ•ˆæ—¶è‡ªåŠ¨æ¢å¤

> ğŸ“‹ **æ ‡å‡†åŒ–ç®¡ç†**
> - å»ºç«‹è§„åˆ™æ¨¡æ¿åº“ï¼Œé¿å…é‡å¤è®¾è®¡
> - ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶è¿½è¸ªæ‰€æœ‰å˜æ›´
> - åˆ¶å®šæ˜ç¡®çš„å˜æ›´å®¡æ‰¹æµç¨‹

> ğŸ”„ **è‡ªåŠ¨åŒ–è¿ç»´**
> - å®ç°æ‰¹é‡éƒ¨ç½²å‡å°‘äººå·¥é”™è¯¯
> - é…ç½®ç›‘æ§å‘Šè­¦åŠæ—¶å‘ç°é—®é¢˜
> - å»ºç«‹é…ç½®åŒæ­¥ä¿æŒç¯å¢ƒä¸€è‡´

### 10.4 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ


**â“ å¸¸è§é—®é¢˜æ¸…å•**ï¼š

<details>
<summary><strong>Q: é‡å¯åè§„åˆ™ä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ</strong></summary>

**A: è§„åˆ™æŒä¹…åŒ–é…ç½®é—®é¢˜**
```bash
# 1. æ£€æŸ¥æ˜¯å¦æœ‰æŒä¹…åŒ–æœåŠ¡
systemctl status iptables-restore
systemctl status netfilter-persistent

# 2. å¦‚æœæ²¡æœ‰ï¼Œæ‰‹åŠ¨åˆ›å»ºsystemdæœåŠ¡
sudo vim /etc/systemd/system/iptables-restore.service

# 3. å¯ç”¨è‡ªåŠ¨åŠ è½½
sudo systemctl enable iptables-restore.service
```
</details>

<details>
<summary><strong>Q: è§„åˆ™å¤‡ä»½æ–‡ä»¶æŸåå¦‚ä½•æ¢å¤ï¼Ÿ</strong></summary>

**A: å¤šå±‚å¤‡ä»½ä¿æŠ¤**
```bash
# 1. æ£€æŸ¥å¤‡ä»½ç›®å½•
ls -la /etc/iptables/backup/

# 2. ä½¿ç”¨gitç‰ˆæœ¬æ§åˆ¶æ¢å¤
cd /etc/iptables && git log --oneline
git checkout HEAD~1 rules.v4

# 3. ä»å…¶ä»–æœåŠ¡å™¨å¤åˆ¶
scp admin@backup-server:/etc/iptables/rules.v4 ./
```
</details>

<details>
<summary><strong>Q: æ‰¹é‡éƒ¨ç½²æ—¶éƒ¨åˆ†æœåŠ¡å™¨å¤±è´¥æ€ä¹ˆå¤„ç†ï¼Ÿ</strong></summary>

**A: åˆ†æ‰¹éƒ¨ç½²å’Œæ•…éšœéš”ç¦»**
```bash
# 1. å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
ansible-playbook -i test-inventory iptables-deploy.yml

# 2. ç”Ÿäº§ç¯å¢ƒåˆ†æ‰¹éƒ¨ç½²
ansible-playbook -i prod-inventory iptables-deploy.yml --limit "web_servers[0:2]"

# 3. å¤±è´¥æœåŠ¡å™¨å•ç‹¬å¤„ç†
ansible-playbook -i prod-inventory iptables-deploy.yml --limit "failed_server"
```
</details>

### 10.5 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š è¿›é˜¶å­¦ä¹ è·¯çº¿**ï¼š

```
å…¥é—¨é˜¶æ®µ (1-2å‘¨)ï¼š
â”œâ”€â”€ æŒæ¡ iptables-save/restore åŸºæœ¬ç”¨æ³•
â”œâ”€â”€ é…ç½®å¼€æœºè‡ªåŠ¨åŠ è½½è§„åˆ™
â””â”€â”€ å®ç°æ‰‹åŠ¨å¤‡ä»½å’Œæ¢å¤

å®è·µé˜¶æ®µ (2-4å‘¨)ï¼š
â”œâ”€â”€ è®¾è®¡é€‚åˆä¸šåŠ¡çš„è§„åˆ™æ¨¡æ¿
â”œâ”€â”€ å®ç°è‡ªåŠ¨åŒ–å¤‡ä»½ç­–ç•¥  
â””â”€â”€ æŒæ¡ç‰ˆæœ¬æ§åˆ¶ç®¡ç†

è¿›é˜¶é˜¶æ®µ (1-2ä¸ªæœˆ)ï¼š
â”œâ”€â”€ å®ç°æ‰¹é‡éƒ¨ç½²æ–¹æ¡ˆ
â”œâ”€â”€ å»ºç«‹ç›‘æ§å‘Šè­¦ä½“ç³»
â””â”€â”€ æŒæ¡é…ç½®åŒæ­¥ç­–ç•¥

ä¸“å®¶é˜¶æ®µ (æŒç»­å­¦ä¹ )ï¼š
â”œâ”€â”€ é›†æˆé…ç½®ç®¡ç†ä¸­å¿ƒ
â”œâ”€â”€ å®ç°æ™ºèƒ½åŒ–è¿ç»´
â””â”€â”€ ä¼˜åŒ–æ€§èƒ½å’Œå®‰å…¨æ€§
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- è§„åˆ™ä¿å­˜è¦æŒä¹…ï¼Œé‡å¯ä¸æ€•é…ç½®å¤±
- å¤‡ä»½ç‰ˆæœ¬åŒä¿é™©ï¼Œæ¨¡æ¿æ‰¹é‡ææ•ˆç‡
- ç›‘æ§åŒæ­¥ä¿ä¸€è‡´ï¼Œè¿ç»´è‡ªåŠ¨å‡é£é™©