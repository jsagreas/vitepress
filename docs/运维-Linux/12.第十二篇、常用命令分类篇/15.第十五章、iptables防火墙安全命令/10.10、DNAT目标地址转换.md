---
title: 10、DNAT目标地址转换
---
## 📚 目录

1. [什么是DNAT目标地址转换](#1-什么是DNAT目标地址转换)
2. [DNAT工作原理深度解析](#2-DNAT工作原理深度解析)
3. [PREROUTING链与DNAT规则](#3-PREROUTING链与DNAT规则)
4. [端口映射配置实战](#4-端口映射配置实战)
5. [服务器发布与负载均衡](#5-服务器发布与负载均衡)
6. [DNAT与filter表协同工作](#6-DNAT与filter表协同工作)
7. [双向NAT高级配置](#7-双向NAT高级配置)
8. [生产环境最佳实践](#8-生产环境最佳实践)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🎯 什么是DNAT目标地址转换


### 1.1 DNAT的本质含义


**DNAT（Destination Network Address Translation）**，翻译过来就是**目标网络地址转换**。

**🔍 通俗理解**：
想象你是一个**邮递员**，收到一封信件地址写的是"A小区1号楼"，但实际上收件人住在"B小区5号楼"。DNAT就像是**地址转换服务**，帮你把信件的目标地址从"A小区1号楼"改写成"B小区5号楼"，然后送到正确的地方。

```
外网用户访问：             实际转发给：
公网IP:80端口    ──DNAT──>  内网服务器:8080端口
```

### 1.2 DNAT解决的实际问题


**🏠 典型应用场景**：

**家庭/办公室网络**：
- 你在家里搭建了一个网站服务器（内网IP：192.168.1.100）
- 外网朋友想访问你的网站，但只能访问你的公网IP
- 通过DNAT，把对公网IP:80的访问转发到内网服务器192.168.1.100:80

**企业环境**：
- 公司有多台内网服务器提供不同服务
- 对外只有一个公网IP
- 使用DNAT将不同端口的访问分发给不同的内网服务器

### 1.3 DNAT与SNAT的区别


| 对比项目 | **DNAT目标地址转换** | **SNAT源地址转换** |
|---------|---------------------|-------------------|
| **转换对象** | `修改数据包的目标地址` | `修改数据包的源地址` |
| **工作位置** | `PREROUTING链（数据包刚进来时）` | `POSTROUTING链（数据包要出去时）` |
| **典型用途** | `外网访问内网服务（端口映射）` | `内网访问外网（共享上网）` |
| **数据流向** | `外部 → 内部` | `内部 → 外部` |

**📝 记忆技巧**：
- **DNAT**：**D**estination（目标），改**目标地址**，让外网能访问内网
- **SNAT**：**S**ource（源），改**源地址**，让内网能访问外网

---

## 2. ⚙️ DNAT工作原理深度解析


### 2.1 数据包转换流程图


```
外网客户端                    Linux防火墙                     内网服务器
     |                           |                              |
     |--[1]发送请求-------------->|                              |
     |   目标: 公网IP:80         |                              |
     |                           |                              |
     |                    [PREROUTING链]                        |
     |                           |                              |
     |                    [DNAT规则处理]                        |
     |                    修改目标地址：                         |
     |                    公网IP:80 → 192.168.1.100:80         |
     |                           |                              |
     |                           |--[2]转发请求--------------->|
     |                           |   目标: 192.168.1.100:80   |
     |                           |                              |
     |                           |<--[3]返回响应---------------|
     |                           |   源: 192.168.1.100:80     |
     |                           |                              |
     |                    [POSTROUTING链]                       |
     |                    修改源地址：                          |
     |                    192.168.1.100:80 → 公网IP:80        |
     |                           |                              |
     |<--[4]返回给客户端----------|                              |
     |   源: 公网IP:80           |                              |
```

### 2.2 DNAT转换的详细步骤


**🔄 第一步：接收外网请求**
```
数据包状态：
源地址：外网客户端IP:随机端口
目标地址：Linux服务器公网IP:80
```

**🔄 第二步：PREROUTING链处理**
- 数据包刚进入Linux系统
- 在路由决策**之前**先进行DNAT转换
- 这个时机很重要：**必须在路由之前转换目标地址**

**🔄 第三步：DNAT规则匹配**
```bash
# 假设有这样的DNAT规则
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:8080
```

**转换过程**：
- 检查：是否是TCP协议？✓
- 检查：目标端口是否是80？✓
- 执行：将目标地址改为192.168.1.100:8080

**🔄 第四步：路由决策**
```
转换后的数据包：
源地址：外网客户端IP:随机端口
目标地址：192.168.1.100:8080  ← 已经被DNAT修改
```

系统查看目标地址192.168.1.100，发现是内网地址，通过内网接口转发。

### 2.3 连接跟踪的作用


**🧠 什么是连接跟踪**：
Linux内核会记住每一个连接的转换信息，就像记账本一样。

```
连接跟踪表记录：
外网IP:12345 ↔ 公网IP:80  =  外网IP:12345 ↔ 192.168.1.100:8080
```

**📖 为什么需要连接跟踪**：
- **去程**：知道怎么转换目标地址
- **回程**：知道怎么还原源地址
- 没有连接跟踪，回程数据包就不知道该发给谁了

---

## 3. 🔧 PREROUTING链与DNAT规则


### 3.1 为什么DNAT必须在PREROUTING链


**📍 数据包处理顺序**：
```
网络接口 → PREROUTING → 路由决策 → FORWARD/INPUT → POSTROUTING → 网络接口
```

**🎯 PREROUTING链的重要性**：

**必须在路由之前**：
- 路由决策基于目标地址来选择转发路径
- 如果不先修改目标地址，数据包会被发送到错误的地方
- DNAT必须在**路由决策之前**完成目标地址转换

**实际例子说明**：
```bash
# 错误的做法（假设能在FORWARD链做DNAT）
# 数据包流程：
1. 接收数据包，目标：公网IP:80
2. 路由决策：目标是本机，送到INPUT链
3. FORWARD链永远收不到这个数据包！

# 正确的做法（在PREROUTING链做DNAT）
1. 接收数据包，目标：公网IP:80
2. PREROUTING链：修改目标为192.168.1.100:80
3. 路由决策：目标是内网，转发到FORWARD链
4. 成功转发给内网服务器
```

### 3.2 DNAT规则的基本语法


**🔤 基础语法结构**：
```bash
iptables -t nat -A PREROUTING [匹配条件] -j DNAT --to-destination [目标地址:端口]
```

**📝 语法要素解释**：

| 参数 | **含义** | **说明** |
|------|---------|----------|
| `-t nat` | `指定NAT表` | `DNAT必须在nat表中操作` |
| `-A PREROUTING` | `添加到PREROUTING链` | `在路由前处理数据包` |
| `[匹配条件]` | `指定哪些数据包需要转换` | `可以指定协议、端口、来源等` |
| `-j DNAT` | `执行DNAT动作` | `目标地址转换动作` |
| `--to-destination` | `指定转换后的目标` | `可以是IP或IP:端口` |

### 3.3 常用匹配条件详解


**🎯 协议匹配**：
```bash
-p tcp        # 匹配TCP协议
-p udp        # 匹配UDP协议
-p icmp       # 匹配ICMP协议
```

**🎯 端口匹配**：
```bash
--dport 80              # 目标端口80
--dport 80:90           # 目标端口80到90
--dport 80,443,8080     # 目标端口80、443、8080
```

**🎯 来源限制**：
```bash
-s 192.168.1.0/24       # 只允许192.168.1网段
-s 10.0.0.100           # 只允许特定IP
```

**🎯 接口限制**：
```bash
-i eth0                 # 只处理从eth0进来的数据包
-i ppp+                 # 处理所有ppp接口
```

---

## 4. 🚀 端口映射配置实战


### 4.1 基础端口映射


**📝 场景1：HTTP网站服务映射**

```bash
# 将外网80端口映射到内网服务器的80端口
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:80

# 允许转发到内网服务器（配合filter表）
iptables -A FORWARD -p tcp -d 192.168.1.100 --dport 80 -j ACCEPT
```

**🔍 这条规则的含义**：
- 任何人访问我们的公网IP的80端口
- 自动转发到内网192.168.1.100的80端口
- 就像是给内网服务器开了一个"窗口"

**📝 场景2：SSH远程管理映射**

```bash
# 将外网2222端口映射到内网服务器的22端口
iptables -t nat -A PREROUTING -p tcp --dport 2222 -j DNAT --to-destination 192.168.1.100:22

# 允许SSH转发
iptables -A FORWARD -p tcp -d 192.168.1.100 --dport 22 -j ACCEPT
```

**💡 为什么用2222而不是22**：
- 安全考虑：隐藏真实的SSH端口
- 避免冲突：本机可能也需要SSH服务
- 便于管理：不同服务器可以用不同的外网端口

### 4.2 端口范围映射


**📝 场景：FTP被动模式端口映射**

```bash
# 映射FTP控制端口
iptables -t nat -A PREROUTING -p tcp --dport 21 -j DNAT --to-destination 192.168.1.100:21

# 映射FTP被动模式数据端口范围
iptables -t nat -A PREROUTING -p tcp --dport 10000:10100 -j DNAT --to-destination 192.168.1.100:10000-10100

# 对应的FORWARD规则
iptables -A FORWARD -p tcp -d 192.168.1.100 --dport 21 -j ACCEPT
iptables -A FORWARD -p tcp -d 192.168.1.100 --dport 10000:10100 -j ACCEPT
```

**🔍 端口范围映射说明**：
- `--dport 10000:10100`：匹配10000到10100的所有端口
- `--to-destination 192.168.1.100:10000-10100`：对应映射到内网的相同端口范围
- 保持端口号的对应关系

### 4.3 多服务器端口分发


**📝 场景：不同端口访问不同服务器**

```bash
# Web服务器1：处理HTTP
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:80

# Web服务器2：处理HTTPS  
iptables -t nat -A PREROUTING -p tcp --dport 443 -j DNAT --to-destination 192.168.1.101:443

# 数据库服务器：MySQL
iptables -t nat -A PREROUTING -p tcp --dport 3306 -j DNAT --to-destination 192.168.1.102:3306

# 邮件服务器：SMTP
iptables -t nat -A PREROUTING -p tcp --dport 25 -j DNAT --to-destination 192.168.1.103:25
```

**🏗️ 服务架构图**：
```
                    外网访问
                        |
                 [Linux防火墙]
                   公网IP
                        |
        ┌───────────────┼───────────────┐
        │               │               │
     :80│            :443│           :3306│
        │               │               │
   Web服务器1       Web服务器2       数据库服务器
 192.168.1.100   192.168.1.101   192.168.1.102
```

---

## 5. 🏢 服务器发布与负载均衡


### 5.1 基于来源的负载均衡


**📝 场景：根据客户端IP分发请求**

```bash
# 将来自不同网段的请求分发到不同服务器
# A网段用户访问服务器1
iptables -t nat -A PREROUTING -s 10.0.0.0/8 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:80

# B网段用户访问服务器2  
iptables -t nat -A PREROUTING -s 172.16.0.0/12 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.101:80

# 其他用户访问服务器3
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.102:80
```

**🎯 规则匹配顺序**：
- iptables按规则顺序匹配，**第一个匹配的规则生效**
- 所以具体的规则要放在前面，通用的规则放在后面

### 5.2 基于时间的服务切换


**📝 场景：白天和夜间使用不同服务器**

```bash
# 白天时间(8:00-18:00)使用主服务器
iptables -t nat -A PREROUTING -p tcp --dport 80 -m time --timestart 08:00 --timestop 18:00 -j DNAT --to-destination 192.168.1.100:80

# 夜间时间使用备用服务器（维护、备份等）
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.101:80
```

**⏰ 时间模块说明**：
- `-m time`：使用时间匹配模块
- `--timestart`：开始时间
- `--timestop`：结束时间
- 可以配合`--weekdays`指定星期几

### 5.3 随机负载均衡


**📝 场景：使用random模块实现简单负载均衡**

```bash
# 50%概率分发到服务器1
iptables -t nat -A PREROUTING -p tcp --dport 80 -m random --average 50 -j DNAT --to-destination 192.168.1.100:80

# 剩余请求分发到服务器2
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.101:80
```

**🎲 random模块说明**：
- `-m random`：使用随机匹配模块
- `--average 50`：50%的概率匹配这条规则
- 可以用多条规则实现更复杂的权重分配

---

## 6. 🛡️ DNAT与filter表协同工作


### 6.1 为什么需要配合filter表


**🤔 只有DNAT规则够吗？**

```bash
# 仅有DNAT规则
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:80
```

**⚠️ 潜在问题**：
- DNAT只负责**地址转换**，不负责**访问控制**
- 如果filter表的FORWARD链默认策略是DROP
- 转换后的数据包可能被filter表阻止，无法到达目标服务器

### 6.2 完整的DNAT配置


**✅ 正确的配置方式**：

```bash
# 第一步：在nat表配置DNAT
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:80

# 第二步：在filter表允许转发
iptables -A FORWARD -p tcp -d 192.168.1.100 --dport 80 -j ACCEPT

# 第三步：允许回程数据包
iptables -A FORWARD -p tcp -s 192.168.1.100 --sport 80 -j ACCEPT
```

**📋 三步配置说明**：

| 步骤 | **作用** | **说明** |
|------|---------|----------|
| **DNAT规则** | `地址转换` | `修改目标地址，实现端口映射` |
| **入向FORWARD** | `允许进入` | `允许转换后的数据包进入内网` |
| **出向FORWARD** | `允许返回` | `允许内网服务器的响应返回` |

### 6.3 使用连接跟踪简化配置


**🧠 利用连接状态**：

```bash
# DNAT规则
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:80

# 只允许新连接和已建立的连接进入
iptables -A FORWARD -p tcp -d 192.168.1.100 --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT

# 允许已建立连接的回程数据包
iptables -A FORWARD -p tcp -s 192.168.1.100 --sport 80 -m state --state ESTABLISHED -j ACCEPT
```

**💡 更简化的方式**：

```bash
# DNAT规则
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:80

# 一条规则搞定双向通信
iptables -A FORWARD -d 192.168.1.100 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -s 192.168.1.100 -m state --state ESTABLISHED -j ACCEPT
```

---

## 7. 🔄 双向NAT高级配置


### 7.1 什么是双向NAT


**🔍 双向NAT的含义**：
同时使用DNAT和SNAT，对数据包的源地址和目标地址都进行转换。

**📝 典型应用场景**：
```
外网客户端 ──→ 防火墙 ──→ 内网服务器
  (A网段)     (转换)     (B网段)
```

**需要双向NAT的情况**：
- 外网客户端和内网服务器在不同的网络段
- 需要隐藏内网服务器的真实IP
- 实现复杂的网络拓扑

### 7.2 双向NAT配置实例


**📝 场景：DMZ服务器发布**

**网络拓扑**：
```
外网              DMZ网段             内网
Internet ──→ [防火墙] ──→ 服务器 ──→ 数据库
公网IP        转换规则    10.1.1.100   192.168.1.100
```

**配置步骤**：

```bash
# 第一步：DNAT - 将外网访问转发到DMZ服务器
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 10.1.1.100:80

# 第二步：SNAT - 修改源地址，让DMZ服务器能够正确响应
iptables -t nat -A POSTROUTING -d 10.1.1.100 -p tcp --dport 80 -j SNAT --to-source 10.1.1.1

# 第三步：配置filter表规则
iptables -A FORWARD -d 10.1.1.100 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -s 10.1.1.100 -p tcp --sport 80 -j ACCEPT
```

### 7.3 双向NAT的数据流分析


**🔄 数据包转换过程**：

**去程（外网→内网）**：
```
1. 外网请求：     源=外网IP:随机端口    目标=公网IP:80
2. DNAT处理：     源=外网IP:随机端口    目标=10.1.1.100:80
3. SNAT处理：     源=10.1.1.1:随机端口  目标=10.1.1.100:80
4. 到达服务器：   收到来自10.1.1.1的请求
```

**回程（内网→外网）**：
```
1. 服务器响应：   源=10.1.1.100:80     目标=10.1.1.1:随机端口
2. SNAT还原：     源=10.1.1.100:80     目标=外网IP:随机端口  
3. DNAT还原：     源=公网IP:80         目标=外网IP:随机端口
4. 返回客户端：   收到来自公网IP的响应
```

**🧠 为什么需要SNAT**：
- 如果不做SNAT，DMZ服务器会直接回复给外网IP
- 外网客户端发送给公网IP，却收到来自10.1.1.100的响应
- 客户端会认为这是无效的数据包并丢弃

---

## 8. 🏭 生产环境最佳实践


### 8.1 规则管理和备份


**📋 规则保存和恢复**：

```bash
# 保存当前规则
iptables-save > /etc/iptables/rules.v4

# 恢复规则
iptables-restore < /etc/iptables/rules.v4

# 开机自动加载规则
echo 'iptables-restore < /etc/iptables/rules.v4' >> /etc/rc.local
```

**🔄 规则更新流程**：

```bash
# 1. 备份当前规则
iptables-save > /root/iptables-backup-$(date +%Y%m%d).rules

# 2. 测试新规则
iptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to-destination 192.168.1.200:80

# 3. 验证规则效果
curl -I http://your-server:8080

# 4. 确认无误后保存
iptables-save > /etc/iptables/rules.v4
```

### 8.2 监控和日志记录


**📊 连接跟踪监控**：

```bash
# 查看NAT连接跟踪表
cat /proc/net/nf_conntrack | grep DNAT

# 监控连接数量
watch 'cat /proc/net/nf_conntrack | wc -l'

# 查看特定IP的连接
cat /proc/net/nf_conntrack | grep 192.168.1.100
```

**📝 日志记录配置**：

```bash
# 记录DNAT转发的连接
iptables -t nat -A PREROUTING -p tcp --dport 80 -j LOG --log-prefix "DNAT-HTTP: "
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:80

# 在/var/log/messages中查看日志
tail -f /var/log/messages | grep "DNAT-HTTP"
```

### 8.3 性能优化建议


**⚡ 规则优化原则**：

```bash
# 1. 常用规则放在前面
iptables -t nat -I PREROUTING 1 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:80

# 2. 使用具体的匹配条件，避免通配符
# 好的做法
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:80

# 避免的做法
iptables -t nat -A PREROUTING -p tcp -j DNAT --to-destination 192.168.1.100:80

# 3. 定期清理无用规则
iptables -t nat -L PREROUTING --line-numbers
iptables -t nat -D PREROUTING 5  # 删除第5条规则
```

**🔧 系统参数调优**：

```bash
# 增加连接跟踪表大小
echo 'net.netfilter.nf_conntrack_max = 262144' >> /etc/sysctl.conf

# 减少连接跟踪超时时间
echo 'net.netfilter.nf_conntrack_tcp_timeout_established = 3600' >> /etc/sysctl.conf

# 应用设置
sysctl -p
```

### 8.4 故障排查方法


**🔍 常见问题诊断**：

**问题1：DNAT规则不生效**
```bash
# 检查规则是否存在
iptables -t nat -L PREROUTING -n --line-numbers

# 检查规则顺序
iptables -t nat -L PREROUTING -v

# 检查数据包计数
watch 'iptables -t nat -L PREROUTING -v'
```

**问题2：连接建立但无法传输数据**
```bash
# 检查filter表规则
iptables -L FORWARD -v

# 检查连接跟踪状态
cat /proc/net/nf_conntrack | grep 192.168.1.100

# 检查路由表
ip route show
```

**问题3：性能问题**
```bash
# 检查连接跟踪表使用情况
cat /proc/sys/net/netfilter/nf_conntrack_count
cat /proc/sys/net/netfilter/nf_conntrack_max

# 检查规则匹配统计
iptables -t nat -L -v | grep -v "0     0"
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的基本概念


```
🔸 DNAT本质：目标地址转换，让外网能访问内网服务
🔸 工作位置：PREROUTING链，在路由决策之前进行转换
🔸 基本语法：iptables -t nat -A PREROUTING [条件] -j DNAT --to-destination [目标]
🔸 配合使用：必须配合filter表的FORWARD规则才能完整工作
🔸 连接跟踪：Linux内核自动记录转换关系，实现双向通信
```

### 9.2 关键理解要点


**🔹 DNAT的核心作用**
```
外网访问内网：
- 解决内网服务器没有公网IP的问题
- 实现端口映射和服务发布
- 提供负载均衡和故障切换能力
```

**🔹 PREROUTING链的重要性**
```
时机关键：
- 必须在路由决策前修改目标地址
- 影响数据包的转发路径选择
- 是实现DNAT功能的唯一正确位置
```

**🔹 双表协同工作**
```
完整配置：
- nat表负责地址转换（DNAT规则）
- filter表负责访问控制（FORWARD规则）
- 两者缺一不可，必须同时配置
```

### 9.3 实际应用指导


**🎯 常见应用场景**
- **网站发布**：将内网Web服务器发布到外网
- **远程管理**：SSH、RDP等管理服务的安全映射
- **邮件服务**：SMTP、POP3、IMAP服务的对外发布
- **数据库访问**：为外部应用提供数据库访问
- **负载均衡**：简单的流量分发和故障切换

**🔧 配置最佳实践**
- **规则顺序**：具体规则在前，通用规则在后
- **安全考虑**：配合filter表进行访问控制
- **性能优化**：合理设置连接跟踪参数
- **监控管理**：定期检查规则效果和系统状态
- **备份恢复**：建立规则备份和快速恢复机制

**💡 故障排查思路**
- **规则检查**：确认DNAT规则正确且生效
- **路径跟踪**：验证数据包转发路径
- **状态监控**：检查连接跟踪表状态
- **日志分析**：利用日志记录排查问题
- **分层诊断**：分别检查nat表和filter表

**核心记忆要点**：
- DNAT改目标，让外网进内网
- PREROUTING链，路由前转换
- 双表配合，转换加控制
- 连接跟踪，记录转换关系
- 生产应用，监控与备份并重