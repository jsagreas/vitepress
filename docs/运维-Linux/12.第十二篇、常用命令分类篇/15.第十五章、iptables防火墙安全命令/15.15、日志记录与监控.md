---
title: 15ã€æ—¥å¿—è®°å½•ä¸ç›‘æ§
---
## ğŸ“š ç›®å½•

1. [æ—¥å¿—è®°å½•åŸºç¡€æ¦‚å¿µ](#1-æ—¥å¿—è®°å½•åŸºç¡€æ¦‚å¿µ)
2. [LOGç›®æ ‡è¯¦è§£](#2-LOGç›®æ ‡è¯¦è§£)
3. [æ—¥å¿—é…ç½®å‚æ•°](#3-æ—¥å¿—é…ç½®å‚æ•°)
4. [ç³»ç»Ÿæ—¥å¿—é…ç½®](#4-ç³»ç»Ÿæ—¥å¿—é…ç½®)
5. [å®æ—¶ç›‘æ§æŠ€å·§](#5-å®æ—¶ç›‘æ§æŠ€å·§)
6. [æ—¥å¿—åˆ†æä¸ç®¡ç†](#6-æ—¥å¿—åˆ†æä¸ç®¡ç†)
7. [ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ](#7-ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” æ—¥å¿—è®°å½•åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯iptablesæ—¥å¿—è®°å½•


**ç®€å•ç†è§£**ï¼šå°±åƒå®‰ä¿äººå‘˜è®°å½•è¿›å‡ºå¤§æ¥¼çš„äººå‘˜ä¿¡æ¯ä¸€æ ·ï¼Œiptableså¯ä»¥è®°å½•ç½‘ç»œæ•°æ®åŒ…çš„è¯¦ç»†ä¿¡æ¯ã€‚

```
ç°å®ç”Ÿæ´»ç±»æ¯”ï¼š
å¤§æ¥¼å®‰ä¿è®°å½• â†’ "2025å¹´9æœˆ21æ—¥ 15:30 å¼ ä¸‰ä»ä¸œé—¨è¿›å…¥"
iptablesæ—¥å¿— â†’ "2025å¹´9æœˆ21æ—¥ 15:30 IP 192.168.1.100 è®¿é—® 80ç«¯å£"

ä½œç”¨ï¼š
âœ… å®‰å…¨å®¡è®¡ï¼šè®°å½•è°åœ¨ä»€ä¹ˆæ—¶å€™åšäº†ä»€ä¹ˆ
âœ… æ•…éšœæ’æŸ¥ï¼šåˆ†æç½‘ç»œè¿æ¥é—®é¢˜
âœ… æ€§èƒ½ç›‘æ§ï¼šç»Ÿè®¡æµé‡å’Œè¿æ¥æƒ…å†µ
âœ… åˆè§„è¦æ±‚ï¼šæ»¡è¶³å®‰å…¨è§„èŒƒè¦æ±‚
```

### 1.2 æ—¥å¿—è®°å½•çš„å·¥ä½œåŸç†


**æ ¸å¿ƒæœºåˆ¶**ï¼š
```
æ•°æ®åŒ…æµç»è¿‡ç¨‹ï¼š
ç½‘ç»œæ•°æ®åŒ… â†’ iptablesè§„åˆ™é“¾ â†’ åŒ¹é…LOGè§„åˆ™ â†’ è®°å½•æ—¥å¿— â†’ ç»§ç»­å¤„ç†

å…³é”®ç†è§£ï¼š
ğŸ”¸ LOGæ˜¯ä¸€ä¸ª"åŠ¨ä½œç›®æ ‡"ï¼Œä¸æ˜¯æœ€ç»ˆå¤„ç†
ğŸ”¸ æ•°æ®åŒ…è®°å½•æ—¥å¿—åä¼šç»§ç»­æ‰§è¡Œåç»­è§„åˆ™
ğŸ”¸ å¯ä»¥åœ¨ä»»æ„ä½ç½®æ’å…¥LOGè§„åˆ™è¿›è¡Œè®°å½•
ğŸ”¸ ä¸å½±å“æ•°æ®åŒ…çš„æ­£å¸¸æµè½¬
```

### 1.3 æ—¥å¿—è®°å½•çš„åº”ç”¨åœºæ™¯


**å¸¸è§ä½¿ç”¨æƒ…å†µ**ï¼š
- **ğŸš« è®°å½•è¢«æ‹’ç»çš„è¿æ¥**ï¼šå“ªäº›IPè¢«é˜²ç«å¢™æ‹¦æˆªäº†
- **ğŸ” è®°å½•æ•æ„Ÿç«¯å£è®¿é—®**ï¼šSSHã€æ•°æ®åº“ç­‰é‡è¦æœåŠ¡çš„è®¿é—®
- **âš ï¸ è®°å½•å¼‚å¸¸æµé‡**ï¼šå¤§é‡è¿æ¥ã€å¯ç–‘æ‰«æè¡Œä¸º
- **ğŸ“Š æµé‡ç»Ÿè®¡åˆ†æ**ï¼šäº†è§£ç½‘ç»œä½¿ç”¨æƒ…å†µ
- **ğŸ”§ æ•…éšœæ’æŸ¥è°ƒè¯•**ï¼šä¸´æ—¶å¯ç”¨æ—¥å¿—åˆ†æé—®é¢˜

---

## 2. ğŸ“ LOGç›®æ ‡è¯¦è§£


### 2.1 LOGç›®æ ‡åŸºæœ¬è¯­æ³•


**æ ¸å¿ƒè¯­æ³•**ï¼š
```bash
-j LOG [æ—¥å¿—é€‰é¡¹]
```

**åŸºæœ¬ç¤ºä¾‹**ï¼š
```bash
# è®°å½•æ‰€æœ‰è¢«æ‹’ç»çš„è¿æ¥
iptables -A INPUT -j LOG
iptables -A INPUT -j DROP

# è®°å½•ç‰¹å®šç«¯å£çš„è®¿é—®
iptables -A INPUT -p tcp --dport 22 -j LOG
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```

**é‡è¦ç†è§£**ï¼š
- LOGåŠ¨ä½œ**ä¸ä¼šç»ˆæ­¢**æ•°æ®åŒ…å¤„ç†
- æ•°æ®åŒ…è®°å½•æ—¥å¿—åä¼š**ç»§ç»­**åŒ¹é…åç»­è§„åˆ™
- é€šå¸¸LOGåé¢è¿˜éœ€è¦ä¸€ä¸ªæœ€ç»ˆåŠ¨ä½œï¼ˆACCEPT/DROPç­‰ï¼‰

### 2.2 LOGä¸å…¶ä»–ç›®æ ‡çš„åŒºåˆ«


| ç›®æ ‡ç±»å‹ | **ä½œç”¨** | **æ˜¯å¦ç»ˆæ­¢å¤„ç†** | **å…¸å‹ç”¨é€”** |
|---------|---------|-----------------|-------------|
| `ACCEPT` | `å…è®¸é€šè¿‡` | `âœ… æ˜¯` | `æ”¾è¡Œæ•°æ®åŒ…` |
| `DROP` | `ä¸¢å¼ƒæ•°æ®åŒ…` | `âœ… æ˜¯` | `æ‹’ç»è®¿é—®` |
| `REJECT` | `æ‹’ç»å¹¶å›å¤` | `âœ… æ˜¯` | `å‹å¥½æ‹’ç»` |
| `LOG` | `è®°å½•æ—¥å¿—` | `âŒ å¦` | `ä¿¡æ¯è®°å½•` |

### 2.3 LOGç›®æ ‡çš„å®é™…åº”ç”¨


**ç›‘æ§SSHç™»å½•å°è¯•**ï¼š
```bash
# è®°å½•æ‰€æœ‰SSHè¿æ¥å°è¯•
iptables -A INPUT -p tcp --dport 22 -j LOG --log-prefix "SSH-ACCESS: "
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```

**è®°å½•è¢«æ‹’ç»çš„è¿æ¥**ï¼š
```bash
# åœ¨DROPå‰è®°å½•æ—¥å¿—
iptables -A INPUT -j LOG --log-prefix "DROPPED: "
iptables -A INPUT -j DROP
```

---

## 3. âš™ï¸ æ—¥å¿—é…ç½®å‚æ•°


### 3.1 --log-prefix æ—¥å¿—å‰ç¼€


**ä½œç”¨**ï¼šä¸ºæ—¥å¿—æ·»åŠ è‡ªå®šä¹‰æ ‡è¯†ï¼Œæ–¹ä¾¿åç»­åˆ†æå’Œè¿‡æ»¤ã€‚

**è¯­æ³•**ï¼š
```bash
--log-prefix "è‡ªå®šä¹‰å‰ç¼€å­—ç¬¦ä¸²"
```

**å®ç”¨ç¤ºä¾‹**ï¼š
```bash
# SSHè®¿é—®è®°å½•
iptables -A INPUT -p tcp --dport 22 -j LOG --log-prefix "SSH-LOGIN: "

# Webè®¿é—®è®°å½•
iptables -A INPUT -p tcp --dport 80 -j LOG --log-prefix "HTTP-ACCESS: "

# æ¶æ„æ‰«æè®°å½•
iptables -A INPUT -p tcp --dport 1:1023 -m limit --limit 10/min \
  -j LOG --log-prefix "PORT-SCAN: "

# è¢«æ‹’ç»çš„è¿æ¥
iptables -A INPUT -j LOG --log-prefix "FIREWALL-DROP: "
```

**å‰ç¼€è®¾è®¡æŠ€å·§**ï¼š
```bash
å‘½åè§„èŒƒå»ºè®®ï¼š
âœ… ä½¿ç”¨å¤§å†™å­—æ¯å’Œè¿å­—ç¬¦
âœ… åŒ…å«æœåŠ¡åç§°æˆ–è§„åˆ™ç±»å‹
âœ… ä¿æŒç®€çŸ­ä½†æœ‰æ„ä¹‰
âœ… ä¾¿äºgrepè¿‡æ»¤

ç¤ºä¾‹ï¼š
SSH-ALLOW:     SSHå…è®¸è¿æ¥
SSH-DENY:      SSHæ‹’ç»è¿æ¥
WEB-ACCESS:    Webè®¿é—®
DB-CONNECT:    æ•°æ®åº“è¿æ¥
SCAN-DETECT:   æ‰«ææ£€æµ‹
```

### 3.2 --log-level æ—¥å¿—çº§åˆ«


**ä½œç”¨**ï¼šè®¾ç½®æ—¥å¿—è®°å½•çš„é‡è¦ç¨‹åº¦çº§åˆ«ã€‚

**çº§åˆ«è¯´æ˜**ï¼š
```bash
æ•°å­—çº§åˆ«    åç§°çº§åˆ«      å«ä¹‰è¯´æ˜
0          emerg        ç´§æ€¥æƒ…å†µï¼Œç³»ç»Ÿä¸å¯ç”¨
1          alert        éœ€è¦ç«‹å³é‡‡å–è¡ŒåŠ¨
2          crit         ä¸¥é‡é”™è¯¯æƒ…å†µ
3          err          ä¸€èˆ¬é”™è¯¯æƒ…å†µ
4          warning      è­¦å‘Šä¿¡æ¯
5          notice       æ­£å¸¸ä½†é‡è¦çš„ä¿¡æ¯
6          info         ä¸€èˆ¬ä¿¡æ¯
7          debug        è°ƒè¯•ä¿¡æ¯
```

**å®é™…ä½¿ç”¨**ï¼š
```bash
# é«˜ä¼˜å…ˆçº§ï¼šå®‰å…¨ç›¸å…³
iptables -A INPUT -p tcp --dport 22 -m state --state NEW \
  -j LOG --log-level 2 --log-prefix "SSH-NEW-CONN: "

# ä¸­ç­‰ä¼˜å…ˆçº§ï¼šä¸€èˆ¬è®¿é—®
iptables -A INPUT -p tcp --dport 80 \
  -j LOG --log-level 6 --log-prefix "HTTP-ACCESS: "

# ä½ä¼˜å…ˆçº§ï¼šè°ƒè¯•ä¿¡æ¯
iptables -A INPUT -p icmp \
  -j LOG --log-level 7 --log-prefix "ICMP-DEBUG: "
```

### 3.3 å…¶ä»–LOGé€‰é¡¹


**å®Œæ•´é€‰é¡¹åˆ—è¡¨**ï¼š
```bash
--log-prefix "å‰ç¼€"      # è‡ªå®šä¹‰æ—¥å¿—å‰ç¼€
--log-level çº§åˆ«         # è®¾ç½®æ—¥å¿—çº§åˆ«
--log-tcp-sequence      # è®°å½•TCPåºåˆ—å·
--log-tcp-options       # è®°å½•TCPé€‰é¡¹
--log-ip-options        # è®°å½•IPé€‰é¡¹
--log-uid               # è®°å½•ç”¨æˆ·IDï¼ˆæœ¬åœ°ç”Ÿæˆçš„åŒ…ï¼‰
```

**é«˜çº§æ—¥å¿—è®°å½•ç¤ºä¾‹**ï¼š
```bash
# è¯¦ç»†çš„TCPè¿æ¥æ—¥å¿—
iptables -A INPUT -p tcp --dport 80 -j LOG \
  --log-prefix "HTTP-DETAIL: " \
  --log-level 6 \
  --log-tcp-sequence \
  --log-tcp-options
```

---

## 4. ğŸ”§ ç³»ç»Ÿæ—¥å¿—é…ç½®


### 4.1 syslogç³»ç»Ÿé…ç½®


**syslogå·¥ä½œåŸç†**ï¼š
```
iptables LOG â†’ å†…æ ¸ â†’ syslogå®ˆæŠ¤è¿›ç¨‹ â†’ æ—¥å¿—æ–‡ä»¶

é…ç½®æµç¨‹ï¼š
1. iptablesç”Ÿæˆæ—¥å¿—
2. å†…æ ¸æ¥æ”¶æ—¥å¿—ä¿¡æ¯
3. syslogæœåŠ¡å¤„ç†åˆ†å‘
4. å†™å…¥æŒ‡å®šçš„æ—¥å¿—æ–‡ä»¶
```

### 4.2 rsyslogé…ç½®æ–‡ä»¶


**é…ç½®æ–‡ä»¶ä½ç½®**ï¼š`/etc/rsyslog.conf` æˆ– `/etc/rsyslog.d/`

**åŸºæœ¬é…ç½®è¯­æ³•**ï¼š
```bash
# æ ¼å¼ï¼šè®¾æ–½.çº§åˆ«    ç›®æ ‡æ–‡ä»¶
kern.warning        /var/log/iptables.log
```

**å®ç”¨é…ç½®ç¤ºä¾‹**ï¼š
```bash
# åˆ›å»ºä¸“é—¨çš„iptablesæ—¥å¿—é…ç½®
# æ–‡ä»¶ï¼š/etc/rsyslog.d/10-iptables.conf

# å°†iptablesæ—¥å¿—åˆ†ç¦»åˆ°ä¸“é—¨æ–‡ä»¶
:msg,contains,"FIREWALL" /var/log/iptables/firewall.log
:msg,contains,"SSH-" /var/log/iptables/ssh.log
:msg,contains,"WEB-" /var/log/iptables/web.log

# åœæ­¢ç»§ç»­å¤„ç†è¿™äº›æ¶ˆæ¯ï¼ˆé¿å…é‡å¤è®°å½•ï¼‰
& stop
```

### 4.3 æ—¥å¿—æ–‡ä»¶ä½ç½®


**é»˜è®¤æ—¥å¿—ä½ç½®**ï¼š
```bash
ç³»ç»Ÿç±»å‹         é»˜è®¤ä½ç½®
CentOS/RHEL     /var/log/messages
Ubuntu/Debian   /var/log/syslog
ä¸“ç”¨é˜²ç«å¢™æ—¥å¿—   /var/log/iptables.logï¼ˆéœ€è¦é…ç½®ï¼‰
```

**åˆ›å»ºä¸“ç”¨æ—¥å¿—ç›®å½•**ï¼š
```bash
# åˆ›å»ºiptablesä¸“ç”¨æ—¥å¿—ç›®å½•
mkdir -p /var/log/iptables

# è®¾ç½®æƒé™
chmod 755 /var/log/iptables
chown syslog:syslog /var/log/iptables

# é‡å¯syslogæœåŠ¡
systemctl restart rsyslog
```

### 4.4 æ—¥å¿—è½®è½¬é…ç½®


**logrotateé…ç½®**ï¼š
```bash
# æ–‡ä»¶ï¼š/etc/logrotate.d/iptables
/var/log/iptables/*.log {
    daily                    # æ¯å¤©è½®è½¬
    missingok               # æ–‡ä»¶ä¸å­˜åœ¨ä¸æŠ¥é”™
    rotate 30               # ä¿ç•™30å¤©çš„æ—¥å¿—
    compress                # å‹ç¼©æ—§æ—¥å¿—
    delaycompress           # å»¶è¿Ÿå‹ç¼©
    notifempty              # ç©ºæ–‡ä»¶ä¸è½®è½¬
    postrotate              # è½®è½¬åæ‰§è¡Œçš„å‘½ä»¤
        /bin/kill -HUP `cat /var/run/rsyslogd.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
```

---

## 5. ğŸ‘€ å®æ—¶ç›‘æ§æŠ€å·§


### 5.1 tailå‘½ä»¤å®æ—¶æŸ¥çœ‹


**åŸºæœ¬ç›‘æ§å‘½ä»¤**ï¼š
```bash
# å®æ—¶æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
tail -f /var/log/messages

# å®æ—¶æŸ¥çœ‹iptablesä¸“ç”¨æ—¥å¿—
tail -f /var/log/iptables.log

# åŒæ—¶ç›‘æ§å¤šä¸ªæ—¥å¿—æ–‡ä»¶
tail -f /var/log/iptables/*.log
```

**è¿‡æ»¤ç‰¹å®šå†…å®¹**ï¼š
```bash
# åªçœ‹SSHç›¸å…³æ—¥å¿—
tail -f /var/log/messages | grep "SSH-"

# åªçœ‹è¢«æ‹’ç»çš„è¿æ¥
tail -f /var/log/messages | grep "DROPPED"

# å½©è‰²æ˜¾ç¤ºï¼ˆä½¿ç”¨cczeå·¥å…·ï¼‰
tail -f /var/log/messages | ccze -A
```

### 5.2 grepé«˜çº§è¿‡æ»¤


**å¸¸ç”¨è¿‡æ»¤æ¨¡å¼**ï¼š
```bash
# æŒ‰æ—¶é—´è¿‡æ»¤ï¼ˆä»Šå¤©çš„æ—¥å¿—ï¼‰
grep "$(date '+%b %d')" /var/log/messages

# æŒ‰IPåœ°å€è¿‡æ»¤
grep "192.168.1.100" /var/log/iptables.log

# æŒ‰ç«¯å£è¿‡æ»¤
grep "DPT=22" /var/log/iptables.log

# ç»„åˆæ¡ä»¶è¿‡æ»¤
grep "SSH-ACCESS" /var/log/messages | grep "192.168.1"
```

### 5.3 watchå‘½ä»¤å®šæ—¶ç›‘æ§


**å®šæ—¶ç»Ÿè®¡ç¤ºä¾‹**ï¼š
```bash
# æ¯2ç§’ç»Ÿè®¡ä¸€æ¬¡è¿æ¥æ•°
watch -n 2 "grep 'SSH-ACCESS' /var/log/messages | tail -10"

# ç›‘æ§æœ€è¿‘çš„é˜²ç«å¢™æ‹’ç»è®°å½•
watch -n 5 "grep 'DROPPED' /var/log/messages | tail -5"

# ç»Ÿè®¡ä¸åŒIPçš„è®¿é—®æ¬¡æ•°
watch -n 10 "grep 'HTTP-ACCESS' /var/log/messages | \
             awk '{print \$12}' | sort | uniq -c | sort -nr | head -10"
```

---

## 6. ğŸ“Š æ—¥å¿—åˆ†æä¸ç®¡ç†


### 6.1 æ—¥å¿—æ ¼å¼è§£æ


**æ ‡å‡†iptablesæ—¥å¿—æ ¼å¼**ï¼š
```
æ—¶é—´æˆ³ ä¸»æœºå kernel: [æ—¶é—´] å‰ç¼€ IN=æ¥å£ OUT=æ¥å£ SRC=æºIP DST=ç›®æ ‡IP ... DPT=ç›®æ ‡ç«¯å£
```

**å®é™…æ—¥å¿—ç¤ºä¾‹**ï¼š
```
Sep 21 15:30:15 server01 kernel: [12345.678] SSH-ACCESS: IN=eth0 OUT= 
MAC=00:11:22:33:44:55:66:77:88:99:aa:bb:08:00 SRC=192.168.1.100 
DST=192.168.1.10 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=12345 DF 
PROTO=TCP SPT=45678 DPT=22 WINDOW=65535 RES=0x00 SYN URGP=0
```

**å­—æ®µå«ä¹‰è§£é‡Š**ï¼š
```bash
IN=eth0          # è¿›å…¥æ¥å£
OUT=             # è¾“å‡ºæ¥å£ï¼ˆç©ºè¡¨ç¤ºæœ¬æœºæ¥æ”¶ï¼‰
SRC=192.168.1.100 # æºIPåœ°å€
DST=192.168.1.10  # ç›®æ ‡IPåœ°å€
PROTO=TCP        # åè®®ç±»å‹
SPT=45678        # æºç«¯å£
DPT=22           # ç›®æ ‡ç«¯å£
LEN=60           # æ•°æ®åŒ…é•¿åº¦
TTL=64           # ç”Ÿå­˜æ—¶é—´
```

### 6.2 å¸¸ç”¨åˆ†æå‘½ä»¤


**ç»Ÿè®¡è®¿é—®æœ€å¤šçš„IP**ï¼š
```bash
# ç»Ÿè®¡æºIPè®¿é—®æ¬¡æ•°
grep "SSH-ACCESS" /var/log/messages | \
awk '{for(i=1;i<=NF;i++) if($i~/^SRC=/) print substr($i,5)}' | \
sort | uniq -c | sort -nr | head -10
```

**ç»Ÿè®¡è®¿é—®çš„ç«¯å£åˆ†å¸ƒ**ï¼š
```bash
# ç»Ÿè®¡ç›®æ ‡ç«¯å£è®¿é—®æ¬¡æ•°
grep "HTTP-ACCESS" /var/log/messages | \
awk '{for(i=1;i<=NF;i++) if($i~/^DPT=/) print substr($i,5)}' | \
sort | uniq -c | sort -nr
```

**æŒ‰æ—¶é—´ç»Ÿè®¡è®¿é—®é‡**ï¼š
```bash
# æŒ‰å°æ—¶ç»Ÿè®¡
grep "SSH-ACCESS" /var/log/messages | \
awk '{print $1,$2,$3}' | sort | uniq -c
```

### 6.3 æ—¥å¿—åˆ†æè„šæœ¬


**ç®€å•åˆ†æè„šæœ¬ç¤ºä¾‹**ï¼š
```bash
#!/bin/bash
# æ–‡ä»¶ï¼šiptables_log_analyzer.sh

LOG_FILE="/var/log/messages"
PREFIX="$1"

if [ -z "$PREFIX" ]; then
    echo "ç”¨æ³•: $0 <æ—¥å¿—å‰ç¼€>"
    echo "ç¤ºä¾‹: $0 SSH-ACCESS"
    exit 1
fi

echo "=== iptablesæ—¥å¿—åˆ†ææŠ¥å‘Š ==="
echo "æ—¥å¿—å‰ç¼€: $PREFIX"
echo "åˆ†ææ—¶é—´: $(date)"
echo

echo "1. æ€»è®¿é—®æ¬¡æ•°:"
grep "$PREFIX" "$LOG_FILE" | wc -l

echo
echo "2. è®¿é—®æœ€å¤šçš„å‰10ä¸ªIP:"
grep "$PREFIX" "$LOG_FILE" | \
awk '{for(i=1;i<=NF;i++) if($i~/^SRC=/) print substr($i,5)}' | \
sort | uniq -c | sort -nr | head -10

echo
echo "3. æœ€è¿‘10æ¬¡è®¿é—®:"
grep "$PREFIX" "$LOG_FILE" | tail -10
```

---

## 7. ğŸ­ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ


### 7.1 æ—¥å¿—è®°å½•ç­–ç•¥


**åˆ†å±‚è®°å½•åŸåˆ™**ï¼š
```bash
# 1. é‡è¦æœåŠ¡è¯¦ç»†è®°å½•
iptables -A INPUT -p tcp --dport 22 -j LOG --log-prefix "SSH-CRITICAL: "

# 2. ä¸€èˆ¬æœåŠ¡é€‚åº¦è®°å½•
iptables -A INPUT -p tcp --dport 80 -m limit --limit 10/min \
  -j LOG --log-prefix "HTTP-NORMAL: "

# 3. å¼‚å¸¸è¡Œä¸ºé‡ç‚¹è®°å½•
iptables -A INPUT -p tcp --tcp-flags ALL ALL -j LOG --log-prefix "XMAS-SCAN: "
iptables -A INPUT -p tcp --tcp-flags ALL NONE -j LOG --log-prefix "NULL-SCAN: "
```

### 7.2 æ€§èƒ½ä¼˜åŒ–considerations


**é¿å…æ—¥å¿—é£æš´**ï¼š
```bash
# ä½¿ç”¨limité™åˆ¶æ—¥å¿—é¢‘ç‡
iptables -A INPUT -p icmp -m limit --limit 5/min --limit-burst 10 \
  -j LOG --log-prefix "ICMP-FLOOD: "

# é¿å…è®°å½•æ­£å¸¸çš„establishedè¿æ¥
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
# åªè®°å½•æ–°è¿æ¥
iptables -A INPUT -m state --state NEW -j LOG --log-prefix "NEW-CONN: "
```

### 7.3 å®‰å…¨æ³¨æ„äº‹é¡¹


**æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**ï¼š
```bash
# æ—¥å¿—æ–‡ä»¶æƒé™è®¾ç½®
chmod 640 /var/log/iptables/*.log
chown root:adm /var/log/iptables/*.log

# å®šæœŸæ¸…ç†æ•æ„Ÿæ—¥å¿—
find /var/log/iptables -name "*.log" -mtime +90 -delete
```

### 7.4 ç›‘æ§å‘Šè­¦é›†æˆ


**ç®€å•å‘Šè­¦è„šæœ¬**ï¼š
```bash
#!/bin/bash
# æ£€æŸ¥å¼‚å¸¸è®¿é—®å¹¶å‘é€å‘Šè­¦

ALERT_THRESHOLD=100
ALERT_EMAIL="admin@company.com"

# æ£€æŸ¥æœ€è¿‘1å°æ—¶çš„å¤±è´¥ç™»å½•æ¬¡æ•°
FAILED_COUNT=$(grep "SSH-FAILED" /var/log/iptables.log | \
               grep "$(date '+%b %d %H')" | wc -l)

if [ $FAILED_COUNT -gt $ALERT_THRESHOLD ]; then
    echo "è­¦å‘Šï¼šæœ€è¿‘1å°æ—¶SSHå¤±è´¥ç™»å½•æ¬¡æ•°: $FAILED_COUNT" | \
    mail -s "iptableså®‰å…¨å‘Šè­¦" $ALERT_EMAIL
fi
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ LOGç›®æ ‡æœ¬è´¨ï¼šè®°å½•ä¿¡æ¯ä½†ä¸ç»ˆæ­¢æ•°æ®åŒ…å¤„ç†
ğŸ”¸ æ—¥å¿—å‰ç¼€ï¼šä½¿ç”¨--log-prefixä¸ºä¸åŒè§„åˆ™æ·»åŠ æ ‡è¯†
ğŸ”¸ æ—¥å¿—çº§åˆ«ï¼šé€šè¿‡--log-levelæ§åˆ¶é‡è¦ç¨‹åº¦
ğŸ”¸ ç³»ç»Ÿé›†æˆï¼šé…ç½®syslogå®ç°æ—¥å¿—åˆ†ç¦»å’Œç®¡ç†
ğŸ”¸ å®æ—¶ç›‘æ§ï¼šä½¿ç”¨tailã€grepã€watchç­‰å·¥å…·
ğŸ”¸ æ—¥å¿—åˆ†æï¼šæŒæ¡åŸºæœ¬çš„ç»Ÿè®¡å’Œè¿‡æ»¤æŠ€å·§
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ LOGä¸å…¶ä»–ç›®æ ‡çš„å…³ç³»**
```
æ­£ç¡®ç†è§£ï¼š
- LOGä¸æ˜¯æœ€ç»ˆå¤„ç†åŠ¨ä½œ
- é€šå¸¸éœ€è¦é…åˆACCEPT/DROPä½¿ç”¨
- å¯ä»¥åœ¨è§„åˆ™é“¾çš„ä»»æ„ä½ç½®æ’å…¥

å¸¸è§é”™è¯¯ï¼š
âŒ åªä½¿ç”¨LOGæ²¡æœ‰æœ€ç»ˆåŠ¨ä½œ
âŒ åœ¨é”™è¯¯ä½ç½®æ’å…¥LOGè§„åˆ™
âŒ æ²¡æœ‰é™åˆ¶æ—¥å¿—é¢‘ç‡å¯¼è‡´æ€§èƒ½é—®é¢˜
```

**ğŸ”¹ æ—¥å¿—è®°å½•çš„æˆæœ¬è€ƒè™‘**
```
å¹³è¡¡å› ç´ ï¼š
- è¯¦ç»†ç¨‹åº¦ vs æ€§èƒ½å½±å“
- å­˜å‚¨ç©ºé—´ vs ä¿ç•™æ—¶é—´
- å®æ—¶æ€§ vs ç³»ç»Ÿè´Ÿè½½

æœ€ä½³å®è·µï¼š
âœ… é‡è¦æœåŠ¡è¯¦ç»†è®°å½•
âœ… ä¸€èˆ¬æœåŠ¡é€‚åº¦è®°å½•
âœ… ä½¿ç”¨limité¿å…æ—¥å¿—é£æš´
âœ… å®šæœŸè½®è½¬å’Œæ¸…ç†æ—¥å¿—
```

### 8.3 ç”Ÿäº§ç¯å¢ƒåº”ç”¨å»ºè®®


**æ—¥å¿—è®°å½•ä¼˜å…ˆçº§**ï¼š
1. **ğŸ”´ é«˜ä¼˜å…ˆçº§**ï¼šSSHè®¿é—®ã€ç®¡ç†ç«¯å£ã€å®‰å…¨äº‹ä»¶
2. **ğŸŸ¡ ä¸­ä¼˜å…ˆçº§**ï¼šWebè®¿é—®ã€ä¸šåŠ¡ç«¯å£ã€å¼‚å¸¸è¿æ¥
3. **ğŸŸ¢ ä½ä¼˜å…ˆçº§**ï¼šICMPã€å†…éƒ¨é€šä¿¡ã€è°ƒè¯•ä¿¡æ¯

**ç›‘æ§å’Œç»´æŠ¤**ï¼š
- å»ºç«‹æ—¥å¿—è½®è½¬æœºåˆ¶
- å®ç°å¼‚å¸¸å‘Šè­¦é€šçŸ¥
- å®šæœŸåˆ†æè®¿é—®æ¨¡å¼
- åŠæ—¶æ¸…ç†è¿‡æœŸæ—¥å¿—

**è®°å¿†è¦ç‚¹**ï¼š
- LOGè®°å½•ä¿¡æ¯ç»§ç»­èµ°ï¼Œå‰ç¼€æ ‡è¯†å¥½åˆ†ç±»
- çº§åˆ«æ§åˆ¶é‡è¦æ€§ï¼Œé™åˆ¶é¢‘ç‡é˜²é£æš´
- å®æ—¶ç›‘æ§ç”¨tail grepï¼Œåˆ†æç»Ÿè®¡awk sed
- ç”Ÿäº§ç¯å¢ƒè¦è§„åˆ’ï¼Œå®‰å…¨æ€§èƒ½ä¸¤å…¼é¡¾