---
title: 5、基础协议与端口过滤
---
## 📚 目录

1. [协议过滤基础](#1-协议过滤基础)
2. [端口过滤详解](#2-端口过滤详解)
3. [多端口过滤技巧](#3-多端口过滤技巧)
4. [常用端口与服务](#4-常用端口与服务)
5. [实战应用案例](#5-实战应用案例)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🌐 协议过滤基础


### 1.1 什么是协议过滤


> **🎯 通俗理解**：就像快递分拣一样，我们要根据不同的运输方式（协议）来处理包裹

**协议过滤本质**：根据网络数据包使用的传输协议来决定是否允许通过

```
现实比喻：
邮局分拣 → iptables协议过滤
普通信件 → TCP协议数据包
快递包裹 → UDP协议数据包
电报    → ICMP协议数据包

不同类型用不同方式处理！
```

### 1.2 -p参数：指定协议类型


**🔸 基本语法格式**
```bash
iptables -A INPUT -p [协议名称] [其他条件] -j [动作]
```

**📋 支持的主要协议**

| 协议名称 | **数字代号** | **主要用途** | **特点说明** |
|---------|-------------|-------------|-------------|
| `tcp` | `6` | `网页、邮件、文件传输` | `可靠传输，有连接状态` |
| `udp` | `17` | `DNS查询、视频直播` | `快速传输，无连接状态` |
| `icmp` | `1` | `ping测试、错误报告` | `网络诊断和控制` |
| `all` | `所有` | `匹配所有协议` | `默认值，不写-p就是all` |

**💡 协议选择的简单理解**
```
🔸 TCP协议：像打电话
- 需要先"拨通"建立连接
- 确保对方收到每句话
- 适合重要数据传输

🔸 UDP协议：像广播
- 直接发送，不管对方是否收到
- 速度快，但不保证送达
- 适合实时性要求高的场景

🔸 ICMP协议：像信号灯
- 用于网络状态检测
- ping命令就是用ICMP
```

### 1.3 协议过滤实际应用


**🚀 常用协议过滤示例**

```bash
# 允许所有TCP连接
iptables -A INPUT -p tcp -j ACCEPT

# 禁止所有UDP流量
iptables -A INPUT -p udp -j DROP

# 允许ping（ICMP协议）
iptables -A INPUT -p icmp -j ACCEPT

# 使用数字代号指定协议
iptables -A INPUT -p 6 -j ACCEPT    # 等同于 -p tcp
```

---

## 2. 🔌 端口过滤详解


### 2.1 什么是端口


> **🏠 生活比喻**：如果IP地址是一栋大楼的地址，那么端口就是这栋楼里的具体房间号

**端口的作用**：
- **区分服务**：同一台电脑可以同时运行多个网络服务
- **数据分发**：系统知道收到的数据包应该给哪个程序处理
- **访问控制**：我们可以控制哪些"房间门"开放给外界

```
端口号分布图：
┌─────────────────────────────────────────┐
│  0-1023    │  知名端口（系统保留）        │
│            │  HTTP:80, HTTPS:443, SSH:22│
├─────────────────────────────────────────┤
│  1024-49151│  注册端口（应用程序使用）    │
│            │  MySQL:3306, Redis:6379    │
├─────────────────────────────────────────┤
│  49152-65535│ 动态端口（临时使用）        │
│            │  客户端连接时随机分配       │
└─────────────────────────────────────────┘
```

### 2.2 --dport：目标端口过滤


**🎯 什么是目标端口**：数据包要到达的端口，也就是服务器提供服务的端口

```bash
# 基本语法
iptables -A INPUT -p tcp --dport [端口号] -j [动作]
```

**📝 实用示例**

```bash
# 允许访问网站（HTTP端口80）
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# 允许访问HTTPS网站（端口443）
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 允许SSH远程登录（端口22）
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 禁止访问FTP服务（端口21）
iptables -A INPUT -p tcp --dport 21 -j DROP
```

**⚠️ 重要提醒**
- **--dport只能用于TCP和UDP协议**，ICMP协议没有端口概念
- **必须先指定协议**才能使用端口过滤

### 2.3 --sport：源端口过滤


**🎯 什么是源端口**：数据包发送方使用的端口，通常是客户端的随机端口

```bash
# 基本语法
iptables -A OUTPUT -p tcp --sport [端口号] -j [动作]
```

**💡 源端口过滤的实际应用**

```bash
# 限制从特定端口发出的连接
iptables -A OUTPUT -p tcp --sport 8080 -j DROP

# 允许Web服务器从80端口发送响应
iptables -A OUTPUT -p tcp --sport 80 -j ACCEPT
```

**🤔 为什么源端口过滤用得少？**
- 客户端端口通常是随机的
- 主要用于限制服务器的响应行为
- 大多数情况下我们更关心目标端口

---

## 3. 🎯 多端口过滤技巧


### 3.1 端口范围指定


**📊 --dports：连续端口范围**

```bash
# 指定端口范围（注意是--dports，多了个s）
iptables -A INPUT -p tcp --dports 8000:8080 -j ACCEPT

# 等效写法
iptables -A INPUT -p tcp --dport 8000:8080 -j ACCEPT
```

**🔸 范围表示方法**

| 写法 | **含义** | **示例** |
|-----|---------|---------|
| `80:90` | `端口80到90` | `包含80和90` |
| `80:` | `端口80及以上` | `80到65535` |
| `:80` | `端口80及以下` | `1到80` |

### 3.2 -m multiport：多端口模块


**🚀 什么是multiport模块**：允许一条规则匹配多个不连续的端口

```bash
# 基本语法
iptables -A INPUT -p tcp -m multiport --dports [端口列表] -j ACCEPT
```

**📝 multiport模块使用示例**

```bash
# 允许多个Web相关端口
iptables -A INPUT -p tcp -m multiport --dports 80,443,8080 -j ACCEPT

# 允许常用的管理端口
iptables -A INPUT -p tcp -m multiport --dports 22,80,443,3306 -j ACCEPT

# 同时指定源端口和目标端口
iptables -A INPUT -p tcp -m multiport --sports 1024:65535 --dports 80,443 -j ACCEPT
```

**⚡ multiport的优势**

```
传统方式需要多条规则：
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT  
iptables -A INPUT -p tcp --dport 8080 -j ACCEPT

multiport一条规则搞定：
iptables -A INPUT -p tcp -m multiport --dports 80,443,8080 -j ACCEPT

✅ 规则更简洁
✅ 性能更好
✅ 管理更方便
```

### 3.3 端口过滤组合技巧


**🔧 复杂端口过滤示例**

```bash
# 允许Web服务相关的所有端口
iptables -A INPUT -p tcp -m multiport --dports 80,443,8000:8080 -j ACCEPT

# 只允许内网访问数据库端口
iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 3306 -j ACCEPT
iptables -A INPUT -p tcp --dport 3306 -j DROP

# 限制SSH只能从特定网段访问
iptables -A INPUT -s 10.0.0.0/8 -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j DROP
```

---

## 4. 📋 常用端口与服务


### 4.1 Web服务端口


**🌐 HTTP/HTTPS相关**

| 端口号 | **服务名称** | **用途说明** | **协议** |
|-------|-------------|-------------|---------|
| `80` | `HTTP` | `普通网站访问` | `TCP` |
| `443` | `HTTPS` | `加密网站访问` | `TCP` |
| `8080` | `HTTP备用` | `开发测试、代理服务` | `TCP` |
| `8443` | `HTTPS备用` | `备用HTTPS端口` | `TCP` |

**💻 常用配置**
```bash
# Web服务器基础端口开放
iptables -A INPUT -p tcp -m multiport --dports 80,443 -j ACCEPT

# 包含开发测试端口
iptables -A INPUT -p tcp -m multiport --dports 80,443,8080,8443 -j ACCEPT
```

### 4.2 远程管理端口


**🔐 远程访问服务**

| 端口号 | **服务名称** | **用途说明** | **安全级别** |
|-------|-------------|-------------|-------------|
| `22` | `SSH` | `Linux远程登录` | `🔒 高安全` |
| `23` | `Telnet` | `不安全远程登录` | `⚠️ 不推荐` |
| `3389` | `RDP` | `Windows远程桌面` | `🔒 中等安全` |

```bash
# SSH安全配置
iptables -A INPUT -s 管理员IP -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j DROP

# 禁用不安全的Telnet
iptables -A INPUT -p tcp --dport 23 -j DROP
```

### 4.3 数据库服务端口


**🗄️ 常用数据库**

| 端口号 | **数据库** | **用途说明** | **访问建议** |
|-------|-----------|-------------|-------------|
| `3306` | `MySQL` | `最流行的关系数据库` | `内网访问` |
| `5432` | `PostgreSQL` | `高级关系数据库` | `内网访问` |
| `6379` | `Redis` | `内存缓存数据库` | `内网访问` |
| `27017` | `MongoDB` | `文档型数据库` | `内网访问` |

**🛡️ 数据库安全配置**
```bash
# 只允许应用服务器访问数据库
iptables -A INPUT -s 应用服务器IP -p tcp --dport 3306 -j ACCEPT
iptables -A INPUT -p tcp --dport 3306 -j DROP

# 批量保护所有数据库端口
iptables -A INPUT -s 192.168.1.0/24 -p tcp -m multiport --dports 3306,5432,6379,27017 -j ACCEPT
iptables -A INPUT -p tcp -m multiport --dports 3306,5432,6379,27017 -j DROP
```

### 4.4 其他常用端口


**📡 网络服务端口**

| 端口号 | **服务** | **协议** | **用途** |
|-------|---------|---------|---------|
| `53` | `DNS` | `TCP/UDP` | `域名解析` |
| `21` | `FTP` | `TCP` | `文件传输` |
| `25` | `SMTP` | `TCP` | `邮件发送` |
| `110` | `POP3` | `TCP` | `邮件接收` |
| `143` | `IMAP` | `TCP` | `邮件接收` |

**🔧 网络服务配置示例**
```bash
# 允许DNS查询（TCP和UDP都要开放）
iptables -A INPUT -p tcp --dport 53 -j ACCEPT
iptables -A INPUT -p udp --dport 53 -j ACCEPT

# 邮件服务器端口
iptables -A INPUT -p tcp -m multiport --dports 25,110,143 -j ACCEPT
```

---

## 5. 🚀 实战应用案例


### 5.1 Web服务器防护配置


**🎯 场景**：配置一台Web服务器的基础防护

```bash
#!/bin/bash
# Web服务器iptables配置脚本

# 1. 清空现有规则
iptables -F

# 2. 设置默认策略
iptables -P INPUT DROP
iptables -P FORWARD DROP  
iptables -P OUTPUT ACCEPT

# 3. 允许本地回环
iptables -A INPUT -i lo -j ACCEPT

# 4. 允许已建立的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 5. 允许Web服务端口
iptables -A INPUT -p tcp -m multiport --dports 80,443 -j ACCEPT

# 6. 允许SSH管理（限制来源IP）
iptables -A INPUT -s 管理员IP/32 -p tcp --dport 22 -j ACCEPT

# 7. 允许ping（ICMP）
iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT

# 8. 保存规则
service iptables save
```

### 5.2 数据库服务器安全配置


**🛡️ 场景**：保护数据库服务器，只允许应用服务器访问

```bash
# 数据库服务器防护配置

# 基础设置
iptables -F
iptables -P INPUT DROP
iptables -P OUTPUT ACCEPT

# 允许本地访问
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 只允许应用服务器访问数据库
iptables -A INPUT -s 192.168.1.10 -p tcp --dport 3306 -j ACCEPT
iptables -A INPUT -s 192.168.1.11 -p tcp --dport 3306 -j ACCEPT

# 允许管理员SSH访问
iptables -A INPUT -s 192.168.1.100 -p tcp --dport 22 -j ACCEPT

# 允许监控系统访问
iptables -A INPUT -s 192.168.1.200 -p tcp --dport 3306 -j ACCEPT
```

### 5.3 办公网络出口控制


**🏢 场景**：控制员工的网络访问，只允许必要的服务

```bash
# 办公网络出口控制

# 设置OUTPUT链默认拒绝
iptables -P OUTPUT DROP

# 允许已建立的连接
iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 允许Web浏览
iptables -A OUTPUT -p tcp -m multiport --dports 80,443 -j ACCEPT

# 允许DNS查询
iptables -A OUTPUT -p tcp --dport 53 -j ACCEPT
iptables -A OUTPUT -p udp --dport 53 -j ACCEPT

# 允许邮件服务
iptables -A OUTPUT -p tcp -m multiport --dports 25,110,143,587,993,995 -j ACCEPT

# 禁止QQ、游戏等（通过端口限制）
iptables -A OUTPUT -p tcp --dport 8000 -j DROP
iptables -A OUTPUT -p udp --dport 8000 -j DROP
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的基本概念


```
🔸 协议过滤：用-p指定tcp/udp/icmp，决定处理哪种类型的数据包
🔸 端口过滤：用--dport指定目标端口，--sport指定源端口
🔸 多端口：用-m multiport处理多个不连续端口
🔸 端口范围：用冒号表示范围，如80:90表示80到90端口
🔸 常用端口：Web(80,443)、SSH(22)、数据库(3306)等
```

### 6.2 关键理解要点


**🔹 协议选择的判断标准**
```
选择TCP：
✅ 需要可靠传输（网页、邮件、文件）
✅ 需要连接状态管理
✅ 数据完整性要求高

选择UDP：  
✅ 需要快速传输（视频、游戏）
✅ 可以容忍少量数据丢失
✅ 实时性要求高

选择ICMP：
✅ 网络诊断（ping、traceroute）
✅ 错误报告和网络控制
```

**🔹 端口过滤的安全原则**
```
最小权限原则：
- 只开放必要的端口
- 不用的服务及时关闭
- 定期审查开放的端口

访问控制原则：
- 关键服务限制来源IP
- 数据库端口不对外开放
- 管理端口只允许管理员访问

分层防护原则：
- 网络层：iptables过滤
- 应用层：服务自身认证
- 系统层：用户权限控制
```

### 6.3 实用操作技巧


**🔧 命令组合技巧**
```bash
# 查看当前端口使用情况
netstat -tlnp | grep :80

# 测试端口是否开放
telnet 目标IP 端口号

# 查看iptables中的端口规则
iptables -L -n | grep dpt

# 临时测试规则（不保存）
iptables -I INPUT -p tcp --dport 8080 -j ACCEPT
# 测试完成后删除
iptables -D INPUT -p tcp --dport 8080 -j ACCEPT
```

**⚠️ 常见错误避免**
```
错误示例：
❌ iptables -A INPUT --dport 80 -j ACCEPT
    （没有指定协议）

❌ iptables -A INPUT -p icmp --dport 80 -j ACCEPT  
    （ICMP协议没有端口概念）

❌ iptables -A INPUT -p tcp --dports 80 -j ACCEPT
    （单个端口不要用--dports）

正确示例：
✅ iptables -A INPUT -p tcp --dport 80 -j ACCEPT
✅ iptables -A INPUT -p icmp -j ACCEPT
✅ iptables -A INPUT -p tcp -m multiport --dports 80,443 -j ACCEPT
```

### 6.4 实际应用指导


**📊 不同场景的端口策略**

| 服务器类型 | **需要开放的端口** | **安全建议** |
|-----------|------------------|-------------|
| `Web服务器` | `80,443,22` | `SSH限制来源IP` |
| `数据库服务器` | `3306,22` | `数据库只允许内网访问` |
| `邮件服务器` | `25,110,143,587,993,995` | `启用SSL/TLS加密` |
| `DNS服务器` | `53(TCP/UDP)` | `防止DNS放大攻击` |

**🔍 监控和维护**
```bash
# 定期检查开放端口
ss -tlnp

# 查看连接状态统计
netstat -s

# 监控异常连接
netstat -an | grep :80 | wc -l

# 查看iptables规则匹配情况
iptables -L -n -v
```

**核心记忆口诀**：
- 协议端口要匹配，TCP UDP各不同
- 目标端口用dport，源端口sport要记清  
- 多端口multiport，范围用冒号分
- 安全第一最小化，只开必要端口行