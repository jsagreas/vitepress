---
title: 1、iptables基本概念与架构
---
## 📚 目录

1. [iptables防火墙概述](#1-iptables防火墙概述)
2. [四表五链架构体系](#2-四表五链架构体系)
3. [数据包处理流程](#3-数据包处理流程)
4. [规则匹配机制原理](#4-规则匹配机制原理)
5. [默认策略与基础操作](#5-默认策略与基础操作)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🛡️ iptables防火墙概述


### 1.1 什么是iptables


**🔸 通俗理解**
> 想象一下，你的Linux服务器就像一栋大楼，iptables就是这栋大楼的**安保系统**。它负责检查每一个进出大楼的人（数据包），决定谁可以进入、谁必须离开、谁需要转到其他地方。

**💡 核心定义**
```
iptables = Linux内核防火墙管理工具
作用：控制网络数据包的进出和转发
本质：基于规则的数据包过滤器
位置：工作在Linux内核网络层
```

**🎯 主要功能**

| **功能类型** | **具体作用** | **生活比喻** | **实际应用** |
|-------------|-------------|-------------|-------------|
| **🚪 访问控制** | `允许或拒绝特定连接` | `门卫检查身份证` | `只允许特定IP访问SSH` |
| **🔄 地址转换** | `修改数据包IP地址` | `快递转发服务` | `内网访问外网的NAT` |
| **📊 流量整形** | `控制网络流量速度` | `限制车道车速` | `限制下载带宽` |
| **🔍 数据包标记** | `给数据包打标签` | `给包裹贴标签` | `QoS质量控制` |

### 1.2 为什么需要学习iptables


**🌟 重要性体现**

```
企业服务器安全防护：
┌─────────────────────────────────────────────────────┐
│                     互联网                           │
│                       ↓                            │
│                   iptables                         │ ← 第一道防线
│                       ↓                            │
│              ┌─────────────────┐                   │
│              │   Linux服务器    │                   │
│              │  ┌─────────────┐ │                   │
│              │  │  Web服务    │ │                   │
│              │  │  数据库     │ │                   │
│              │  │  应用程序   │ │                   │
│              │  └─────────────┘ │                   │
│              └─────────────────┘                   │
└─────────────────────────────────────────────────────┘
```

**✅ 学习价值**
- **服务器安全**：保护系统免受网络攻击
- **运维必备**：Linux运维工程师必须掌握的技能
- **问题排查**：网络连接问题的重要排查工具
- **性能优化**：合理配置能提升网络性能

---

## 2. 🏗️ 四表五链架构体系


### 2.1 核心架构概览


**🎯 架构全貌**

```
iptables四表五链架构图：

         表(Tables)                    链(Chains)
    ┌─────────────────┐           ┌─────────────────┐
    │   raw表         │           │  PREROUTING     │
    │   (连接跟踪)     │           │  (路由前处理)    │
    ├─────────────────┤           ├─────────────────┤
    │   mangle表      │    ←→     │  INPUT          │
    │   (包修改)       │           │  (入站处理)     │
    ├─────────────────┤           ├─────────────────┤
    │   nat表         │           │  FORWARD        │
    │   (地址转换)     │           │  (转发处理)     │
    ├─────────────────┤           ├─────────────────┤
    │   filter表      │           │  OUTPUT         │
    │   (过滤控制)     │           │  (出站处理)     │
    └─────────────────┘           ├─────────────────┤
                                  │  POSTROUTING    │
                                  │  (路由后处理)    │
                                  └─────────────────┘
```

### 2.2 四大表详解


#### 🔍 filter表 - 过滤控制表


**📋 核心作用**
> filter表就像大楼的**安检门**，决定哪些人可以进入、哪些人必须被拦截。这是我们用得最多的表。

```
filter表包含的链：
INPUT链   ────► 处理进入本机的数据包
OUTPUT链  ────► 处理从本机发出的数据包  
FORWARD链 ────► 处理经过本机转发的数据包
```

**💡 实际应用场景**
- **INPUT链**：阻止恶意IP访问你的Web服务器
- **OUTPUT链**：限制服务器只能访问特定的外部服务
- **FORWARD链**：控制内网用户访问外网的权限

#### 🔄 nat表 - 网络地址转换表


**📋 核心作用**
> nat表就像**快递中转站**，负责修改数据包的地址信息，让内网和外网能够正常通信。

```
nat表包含的链：
PREROUTING链  ────► 数据包到达时的地址转换
OUTPUT链      ────► 本机产生数据包的地址转换
POSTROUTING链 ────► 数据包离开时的地址转换
```

**💡 常见应用**
- **SNAT**：内网访问外网时隐藏真实内网IP
- **DNAT**：外网访问内网服务时的端口转发
- **MASQUERADE**：动态IP环境下的地址伪装

#### 🛠️ mangle表 - 数据包修改表


**📋 核心作用**
> mangle表就像**包裹加工厂**，可以给数据包添加特殊标记或修改某些属性，通常用于高级网络管理。

```
mangle表的作用：
• 修改数据包的TOS字段
• 给数据包打标记(MARK)
• 修改TTL值
• 实现QoS质量控制
```

#### 📊 raw表 - 连接跟踪控制表


**📋 核心作用**
> raw表是**最高优先级**的表，主要用于关闭特定数据包的连接跟踪，提升高流量环境下的性能。

### 2.3 五大链详解


**🔗 数据包处理链路**

```
五链处理顺序图：

外部数据包进入：
Internet → PREROUTING → [路由判断] → INPUT → 本机进程
                            ↓
                        FORWARD → POSTROUTING → Internet
                            ↑
本机数据包发出：
本机进程 → OUTPUT → [路由判断] → POSTROUTING → Internet
```

| **链名称** | **触发时机** | **主要用途** | **常见操作** |
|-----------|-------------|-------------|-------------|
| **PREROUTING** | `数据包刚到达网卡` | `DNAT端口转发` | `外网访问内网服务` |
| **INPUT** | `数据包进入本机前` | `访问控制` | `开放/关闭端口` |
| **FORWARD** | `数据包转发时` | `转发控制` | `内网访问控制` |
| **OUTPUT** | `本机数据包发出前` | `出站控制` | `限制外部访问` |
| **POSTROUTING** | `数据包离开网卡前` | `SNAT地址转换` | `内网上网配置` |

---

## 3. 🚀 数据包处理流程


### 3.1 完整处理流程图


**📊 数据流向详解**

```
iptables数据包完整处理流程：

┌─────────────────────────────────────────────────────────────────┐
│                           网络接口                               │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
                 ┌─────────────────┐
                 │   PREROUTING    │ ← raw表、mangle表、nat表
                 └─────────┬───────┘
                          │
                          ▼
                 ┌─────────────────┐
                 │     路由判断     │ ← 目标是本机？还是转发？
                 └─────┬─────┬─────┘
                      │     │
            本机目标  │     │ 转发目标
                      ▼     ▼
               ┌─────────┐  ┌─────────┐
               │  INPUT  │  │ FORWARD │ ← filter表
               └────┬────┘  └────┬────┘
                    │            │
                    ▼            │
              ┌───────────┐      │
              │  本机进程  │      │
              └─────┬─────┘      │
                    │            │
                    ▼            │
               ┌─────────┐       │
               │ OUTPUT  │ ← raw、mangle、nat、filter表
               └────┬────┘       │
                    │            │
                    └─────┬──────┘
                          ▼
                 ┌─────────────────┐
                 │  POSTROUTING   │ ← mangle表、nat表
                 └─────────┬───────┘
                          │
                          ▼
                 ┌─────────────────┐
                 │     网络接口     │
                 └─────────────────┘
```

### 3.2 三种典型场景


#### 🔽 场景一：外部访问本机服务


```
示例：用户访问Web服务器
Internet → 服务器网卡 → PREROUTING → INPUT → Web进程

处理步骤：
1. PREROUTING：可能进行DNAT端口转发
2. 路由判断：确认是访问本机
3. INPUT：检查是否允许访问80端口
4. 本机进程：Web服务器接收请求
```

#### ↔️ 场景二：本机访问外部服务


```
示例：服务器更新软件包
本机进程 → OUTPUT → POSTROUTING → 网卡 → Internet

处理步骤：
1. OUTPUT：检查是否允许本机发起外部连接
2. 路由判断：确定发送路径
3. POSTROUTING：可能进行SNAT地址转换
4. 网络接口：数据包发送到外网
```

#### 🔄 场景三：数据包转发


```
示例：内网通过网关上网
内网PC → 网关INPUT → FORWARD → POSTROUTING → Internet

处理步骤：
1. PREROUTING：接收内网数据包
2. 路由判断：确认需要转发
3. FORWARD：检查转发策略
4. POSTROUTING：SNAT转换为公网IP
```

---

## 4. ⚙️ 规则匹配机制原理


### 4.1 规则匹配顺序


**🎯 匹配原则**

> **重要规律**：iptables像**单行道**一样，规则从上到下依次检查，一旦匹配就执行动作，**不再继续往下查看**。

```
规则匹配示例：
规则1: 允许192.168.1.100访问     ✓ 匹配 → 执行ACCEPT
规则2: 拒绝192.168.1.0/24访问    ✗ 跳过（已匹配上面规则）
规则3: 允许所有HTTP访问          ✗ 跳过
规则4: 拒绝所有访问              ✗ 跳过
```

**📋 匹配逻辑流程**

```
规则检查流程：
┌────────────────┐    是    ┌─────────────┐
│  读取第一条规则  │ ────────→ │ 条件匹配？   │
└────────────────┘          └─────┬───┬───┘
         ↓                        │   │
         │                       是   │否
         │                        │   │
         │                        ▼   │
         │                  ┌──────────┴───┐
         │                  │  执行动作     │
         │                  │(ACCEPT/DROP) │
         │                  └──────────────┘
         │                        │
         │                        ▼
         │                  ┌──────────────┐
         │                  │   处理结束    │
         │                  └──────────────┘
         │                                  
         ▼                                  
┌────────────────┐                         
│  读取下一条规则  │                         
└────────────────┘                         
```

### 4.2 常见匹配条件


**🔍 主要匹配参数**

| **匹配类型** | **参数** | **作用** | **示例** |
|-------------|---------|---------|---------|
| **源IP地址** | `-s` | `指定来源IP` | `-s 192.168.1.100` |
| **目标IP地址** | `-d` | `指定目标IP` | `-d 10.0.0.1` |
| **网络接口** | `-i/-o` | `指定进出接口` | `-i eth0` |
| **协议类型** | `-p` | `指定协议` | `-p tcp` |
| **端口号** | `--dport/--sport` | `指定端口` | `--dport 80` |
| **连接状态** | `-m state --state` | `连接状态` | `--state NEW` |

### 4.3 动作类型说明


**⚡ 常用动作解释**

```
iptables动作类型：

ACCEPT  ────► 允许通过（绿灯）
DROP    ────► 直接丢弃（无响应）
REJECT  ────► 拒绝并返回错误信息
LOG     ────► 记录日志但继续处理
SNAT    ────► 源地址转换
DNAT    ────► 目标地址转换
```

**💡 ACCEPT vs DROP vs REJECT 区别**

```
场景：有人敲门访问

ACCEPT：  开门让进来 ✓
DROP：    装作没听见，不回应 🤐
REJECT：  明确说"不让进"，然后关门 ❌

网络含义：
ACCEPT：  数据包正常通过
DROP：    静默丢弃，客户端超时等待
REJECT：  发送拒绝消息，客户端立即收到错误
```

---

## 5. 🎛️ 默认策略与基础操作


### 5.1 默认策略概念


**🔸 什么是默认策略**

> 默认策略就像大楼的**基本安保规定**。当所有具体规则都不匹配时，系统按照默认策略来处理数据包。

**🎯 策略类型**

```
两种基本策略思路：

白名单策略（推荐）：
默认策略：DROP（拒绝所有）
具体规则：ACCEPT（明确允许的才放行）
安全性：高 ✓

黑名单策略：
默认策略：ACCEPT（允许所有）
具体规则：DROP（明确拒绝的才阻止）
安全性：低 ⚠️
```

### 5.2 查看当前配置


**📊 基础查看命令**

```bash
# 查看所有规则（推荐格式）
iptables -L -n -v

# 查看特定表
iptables -t nat -L -n -v
iptables -t filter -L -n -v
```

**🔍 输出解读**

```
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source      destination
    0     0 DROP       tcp  --  *      *       0.0.0.0/0   0.0.0.0/0  tcp dpt:22

解释：
Chain INPUT     ← 链名称
policy ACCEPT   ← 默认策略
pkts bytes      ← 匹配的包数和字节数
target          ← 动作
prot            ← 协议
in out          ← 入接口和出接口
source dest     ← 源地址和目标地址
```

### 5.3 基础安全配置


**🛡️ 最小安全配置示例**

```bash
# 1. 允许本地回环通信
iptables -A INPUT -i lo -j ACCEPT

# 2. 允许已建立的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 3. 允许SSH访问（谨慎配置）
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 4. 设置默认拒绝策略
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT
```

> **⚠️ 安全提醒**：在远程服务器上配置iptables时，一定要先允许SSH连接，否则可能会把自己锁在外面！

### 5.4 规则管理基础


**🔧 常用管理命令**

| **操作** | **命令格式** | **示例** | **说明** |
|---------|-------------|---------|---------|
| **添加规则** | `iptables -A` | `iptables -A INPUT -p tcp --dport 80 -j ACCEPT` | `在链末尾添加` |
| **插入规则** | `iptables -I` | `iptables -I INPUT 1 -s 192.168.1.1 -j ACCEPT` | `插入到指定位置` |
| **删除规则** | `iptables -D` | `iptables -D INPUT 1` | `删除指定位置规则` |
| **清空规则** | `iptables -F` | `iptables -F INPUT` | `清空指定链规则` |
| **重置计数** | `iptables -Z` | `iptables -Z` | `重置包计数器` |

**💾 规则持久化**

```bash
# 保存当前规则（CentOS/RHEL）
service iptables save

# 保存当前规则（Ubuntu/Debian）
iptables-save > /etc/iptables/rules.v4

# 开机自动加载
systemctl enable iptables
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的基本概念


```
🔸 四表功能：filter过滤、nat转换、mangle修改、raw跟踪
🔸 五链时机：PREROUTING进入前、INPUT本机入、FORWARD转发、OUTPUT本机出、POSTROUTING离开前
🔸 处理流程：数据包按固定路径通过不同的表和链
🔸 匹配原则：从上到下逐条检查，首次匹配即执行
🔸 默认策略：白名单模式更安全，黑名单模式更宽松
```

### 6.2 关键理解要点


**🔹 表和链的关系**
```
表：定义功能类型（做什么）
链：定义处理时机（什么时候做）
规则：定义具体条件和动作（对谁做什么）
```

**🔹 数据流向记忆方法**
```
外→内：PREROUTING → INPUT → 进程
内→外：进程 → OUTPUT → POSTROUTING  
转发：PREROUTING → FORWARD → POSTROUTING
```

**🔹 安全配置原则**
```
1. 先配置允许规则，再设置默认拒绝
2. 重要服务（如SSH）优先配置
3. 规则顺序很重要，严格的在前面
4. 定期备份和测试配置
```

### 6.3 实际应用场景


**💼 运维实践应用**
- **Web服务器防护**：只开放必要端口（80/443），拒绝其他访问
- **数据库安全**：只允许应用服务器访问数据库端口
- **内网管理**：配置NAT让内网访问外网，同时控制访问权限
- **日志监控**：配置LOG规则记录可疑访问尝试

**🎯 学习进阶路径**
1. **基础操作**：熟练使用增删改查命令
2. **实战配置**：配置常见服务的防火墙规则
3. **高级功能**：学习连接跟踪、速度限制等
4. **脚本化管理**：编写自动化配置脚本
5. **故障排查**：掌握调试和问题定位方法

### 6.4 常见新手误区


**⚠️ 避免的错误**
```
远程配置时锁住自己 → 先允许SSH再改默认策略
规则顺序搞错 → 宽松规则不要放在严格规则前面
忘记保存规则 → 重启后配置丢失
测试不充分 → 影响正常业务访问
```

**💡 最佳实践建议**
```
测试环境先验证 → 生产环境再应用
备份原始配置 → 便于出问题时恢复
分步骤配置 → 每步测试确认无误
文档记录规则 → 方便后续维护管理
```

**核心记忆口诀**：
```
四表各司其职能，五链控制处理点
数据流向要理清，规则顺序定成败
白名单策略保安全，SSH规则要先配
```

> **🎓 学习建议**：iptables是Linux运维的核心技能，建议通过实际动手练习来加深理解。可以先在虚拟机环境中练习基本操作，熟悉后再应用到生产环境。记住：**理论学习+实践操作=真正掌握**！