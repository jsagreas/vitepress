---
title: 4、规则添加与删除命令
---
## 📚 目录

1. [规则添加与删除基础概念](#1-规则添加与删除基础概念)
2. [iptables -A 追加规则详解](#2-iptables--a-追加规则详解)
3. [iptables -I 插入规则详解](#3-iptables--i-插入规则详解)
4. [iptables -D 删除规则详解](#4-iptables--d-删除规则详解)
5. [iptables -R 替换规则详解](#5-iptables--r-替换规则详解)
6. [规则编号操作技巧](#6-规则编号操作技巧)
7. [批量删除规则方法](#7-批量删除规则方法)
8. [规则顺序的重要性](#8-规则顺序的重要性)
9. [临时规则与永久规则](#9-临时规则与永久规则)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🎯 规则添加与删除基础概念


### 1.1 什么是iptables规则操作


**简单理解**：就像给门卫写规定一样
```
门卫规定本：
1. 员工可以进入 ← 这是一条规则
2. 访客需要登记 ← 这是另一条规则
3. 快递放在门口 ← 这是第三条规则

iptables规则：
1. 允许SSH连接 ← 允许22端口
2. 禁止某个IP ← 拒绝特定地址
3. 开放Web服务 ← 允许80端口
```

### 1.2 四种基本操作


| 操作 | 命令 | 作用 | 比喻 |
|------|------|------|------|
| **追加** | `-A` | 在规则链末尾添加 | 在规定本最后加一条 |
| **插入** | `-I` | 在指定位置插入 | 在规定本中间插一条 |
| **删除** | `-D` | 删除指定规则 | 从规定本中划掉一条 |
| **替换** | `-R` | 替换指定规则 | 把某条规定改写 |

### 1.3 规则操作的基本流程


```
查看现有规则 → 分析需求 → 选择操作方式 → 执行命令 → 验证结果

🔍 查看：iptables -L -n --line-numbers
🎯 分析：我要达到什么目的？
⚡ 执行：选择-A、-I、-D、-R中的一种
✅ 验证：再次查看规则是否正确
```

---

## 2. 📝 iptables -A 追加规则详解


### 2.1 -A参数的含义


**核心概念**：`-A` = `Append`（追加）
- **作用**：在指定链的**末尾**添加新规则
- **特点**：新规则排在最后，优先级最低
- **适用场景**：添加兜底规则、默认策略

### 2.2 基本语法结构


```bash
iptables -A [链名] [匹配条件] -j [动作]
```

**语法解析**：
- `链名`：INPUT、OUTPUT、FORWARD等
- `匹配条件`：-s源IP、-d目标IP、-p协议等
- `动作`：ACCEPT、DROP、REJECT等

### 2.3 实用示例讲解


**示例1：允许SSH连接**
```bash
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```

**通俗解释**：
- 在INPUT链末尾追加一条规则
- 匹配：TCP协议，目标端口22
- 动作：允许通过
- 实际效果：开放SSH远程登录

**示例2：禁止特定IP访问**
```bash
iptables -A INPUT -s 192.168.1.100 -j DROP
```

**通俗解释**：
- 在INPUT链末尾追加规则
- 匹配：来源IP是192.168.1.100
- 动作：直接丢弃数据包
- 实际效果：这个IP无法访问服务器

### 2.4 -A操作的注意事项


> ⚠️ **重要提醒**
> 
> 追加的规则在链的最后，如果前面有冲突规则，可能不会生效！

**规则执行顺序示例**：
```
现有规则：
1. DROP所有连接     ← 第1条先执行
2. ACCEPT SSH连接   ← 第2条永远执行不到

问题：SSH规则被第1条阻挡了
解决：要么删除第1条，要么用-I插入到第1条前面
```

---

## 3. 🔍 iptables -I 插入规则详解


### 3.1 -I参数的核心作用


**核心概念**：`-I` = `Insert`（插入）
- **作用**：在指定位置插入新规则
- **特点**：可以控制规则优先级
- **适用场景**：紧急规则、高优先级规则

### 3.2 插入规则的两种方式


**方式1：插入到链首（默认）**
```bash
iptables -I INPUT -s 192.168.1.50 -j ACCEPT
```
- 插入位置：第1条
- 优先级：最高

**方式2：插入到指定位置**
```bash
iptables -I INPUT 3 -p tcp --dport 80 -j ACCEPT
```
- 插入位置：第3条
- 原来第3条及以后的规则自动后移

### 3.3 位置编号的理解


```
插入前的规则列表：
1. 允许本地连接
2. 允许SSH连接
3. 拒绝所有连接

执行：iptables -I INPUT 2 -p tcp --dport 80 -j ACCEPT

插入后的规则列表：
1. 允许本地连接
2. 允许HTTP连接 ← 新插入的
3. 允许SSH连接  ← 原来的第2条变成第3条
4. 拒绝所有连接 ← 原来的第3条变成第4条
```

### 3.4 实际应用场景


**场景1：紧急开放端口**
```bash
# 网站突然无法访问，紧急开放80端口
iptables -I INPUT 1 -p tcp --dport 80 -j ACCEPT
```

**场景2：临时允许某个IP**
```bash
# 开发人员需要临时访问，插入高优先级规则
iptables -I INPUT 1 -s 203.0.113.10 -j ACCEPT
```

---

## 4. ❌ iptables -D 删除规则详解


### 4.1 删除规则的两种方法


**方法1：按规则内容删除**
```bash
iptables -D INPUT -p tcp --dport 22 -j ACCEPT
```
- 优点：不需要知道规则编号
- 缺点：必须完全匹配规则内容

**方法2：按规则编号删除**
```bash
iptables -D INPUT 3
```
- 优点：简单快捷
- 缺点：需要先查看规则编号

### 4.2 查看规则编号的方法


```bash
iptables -L INPUT -n --line-numbers
```

**输出示例**：
```
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination
1    ACCEPT     all  --  127.0.0.1            0.0.0.0/0
2    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0    tcp dpt:22
3    DROP       all  --  192.168.1.100        0.0.0.0/0
```

### 4.3 删除操作实例


**删除第2条规则**：
```bash
iptables -D INPUT 2
```

**删除特定内容的规则**：
```bash
iptables -D INPUT -s 192.168.1.100 -j DROP
```

### 4.4 删除操作的风险提示


> ⚠️ **安全警告**
> 
> 删除规则可能导致网络连接中断！建议操作前：
> 1. 确保有其他方式访问服务器（如控制台）
> 2. 设置定时任务自动恢复规则
> 3. 在测试环境先验证

**安全删除示例**：
```bash
# 设置5分钟后自动恢复规则
echo "iptables -A INPUT -p tcp --dport 22 -j ACCEPT" | at now + 5 minutes

# 然后再删除规则
iptables -D INPUT -p tcp --dport 22 -j ACCEPT
```

---

## 5. 🔄 iptables -R 替换规则详解


### 5.1 -R参数的使用场景


**核心概念**：`-R` = `Replace`（替换）
- **作用**：替换指定位置的规则
- **特点**：保持规则位置不变，只改变内容
- **适用场景**：修改现有规则，保持优先级

### 5.2 替换操作的语法


```bash
iptables -R [链名] [规则编号] [新的规则内容]
```

**实例演示**：
```bash
# 查看当前规则
iptables -L INPUT -n --line-numbers

# 假设第3条是：ACCEPT tcp dpt:80
# 现在要改为只允许特定IP访问80端口
iptables -R INPUT 3 -s 192.168.1.0/24 -p tcp --dport 80 -j ACCEPT
```

### 5.3 替换操作的优势


**对比其他方法**：
```
删除+重新添加：
1. iptables -D INPUT 3
2. iptables -I INPUT 3 [新规则]
问题：如果第2步失败，规则就丢失了

直接替换：
iptables -R INPUT 3 [新规则]
优势：原子操作，要么成功要么保持原状
```

### 5.4 替换操作实例


**场景：修改端口号**
```bash
# 原规则：允许22端口SSH
# 新需求：改为2222端口

# 查看规则编号
iptables -L INPUT -n --line-numbers

# 假设SSH规则是第2条
iptables -R INPUT 2 -p tcp --dport 2222 -j ACCEPT
```

---

## 6. 🔢 规则编号操作技巧


### 6.1 查看规则编号


**基本命令**：
```bash
iptables -L -n --line-numbers
```

**查看特定链**：
```bash
iptables -L INPUT -n --line-numbers
iptables -L OUTPUT -n --line-numbers
iptables -L FORWARD -n --line-numbers
```

### 6.2 规则编号的特点


**编号规律**：
- 从1开始连续编号
- 删除规则后，后面规则编号自动前移
- 插入规则后，后面规则编号自动后移

**示例演示**：
```
初始状态：
1. 规则A
2. 规则B  
3. 规则C

删除第2条后：
1. 规则A
2. 规则C ← 原来的第3条变成第2条

在第1条后插入规则D：
1. 规则A
2. 规则D ← 新插入
3. 规则C ← 原来的第2条变成第3条
```

### 6.3 批量操作技巧


**获取特定规则编号**：
```bash
# 查找包含SSH的规则
iptables -L INPUT -n --line-numbers | grep "dpt:22"

# 查找特定IP的规则
iptables -L INPUT -n --line-numbers | grep "192.168.1.100"
```

---

## 7. 🗑️ 批量删除规则方法


### 7.1 清空整个链


```bash
# 清空INPUT链的所有规则
iptables -F INPUT

# 清空所有链的规则
iptables -F
```

> ⚠️ **危险操作警告**
> 
> `iptables -F` 会删除所有规则！如果默认策略是DROP，可能导致网络完全中断！

### 7.2 安全的批量删除


**方法1：先改变默认策略**
```bash
# 先设置为允许所有
iptables -P INPUT ACCEPT
iptables -P OUTPUT ACCEPT
iptables -P FORWARD ACCEPT

# 然后清空规则
iptables -F

# 最后重新配置
```

**方法2：逐条删除（推荐）**
```bash
# 从最后一条开始删除，避免编号混乱
for i in $(iptables -L INPUT --line-numbers | grep ^[0-9] | awk '{print $1}' | tac); do
    iptables -D INPUT $i
done
```

### 7.3 按条件批量删除


**删除特定IP的所有规则**：
```bash
# 查找所有包含特定IP的规则编号
iptables -L INPUT -n --line-numbers | grep "192.168.1.100" | awk '{print $1}' | tac | while read line; do
    iptables -D INPUT $line
done
```

---

## 8. 📋 规则顺序的重要性


### 8.1 为什么顺序很重要


**核心原理**：iptables按顺序逐条检查规则，匹配到第一条就停止

**错误示例**：
```
规则顺序（错误）：
1. DROP all from anywhere     ← 拒绝所有
2. ACCEPT tcp dpt:22          ← SSH规则永远执行不到

结果：SSH无法连接，因为第1条就把所有连接拒绝了
```

**正确示例**：
```
规则顺序（正确）：
1. ACCEPT tcp dpt:22          ← SSH规则先执行
2. DROP all from anywhere     ← 拒绝其他所有

结果：SSH可以连接，其他连接被拒绝
```

### 8.2 规则顺序的最佳实践


**建议顺序**：
```
1. 允许本地回环（lo接口）
2. 允许已建立的连接
3. 允许必要的服务端口（SSH、HTTP等）
4. 允许特定IP或网段
5. 记录或拒绝其他连接
```

**实际配置示例**：
```bash
# 1. 允许本地回环
iptables -A INPUT -i lo -j ACCEPT

# 2. 允许已建立的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 3. 允许SSH
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 4. 允许Web服务
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 5. 拒绝其他
iptables -A INPUT -j DROP
```

### 8.3 调整规则顺序的方法


**方法1：删除后重新插入**
```bash
# 将第5条规则移到第2位
# 先记录规则内容
rule=$(iptables -S INPUT | sed -n '5p' | sed 's/-A INPUT/-I INPUT 2/')

# 删除原规则
iptables -D INPUT 5

# 插入到新位置
eval $rule
```

**方法2：重新规划配置**
```bash
# 备份当前规则
iptables-save > /tmp/iptables-backup

# 清空规则
iptables -F INPUT

# 按正确顺序重新添加
iptables -A INPUT -i lo -j ACCEPT
# ... 其他规则按顺序添加
```

---

## 9. ⏰ 临时规则与永久规则


### 9.1 临时规则的特点


**什么是临时规则**：
- 只在当前会话有效
- 重启后自动消失
- 适合测试和临时需求

**临时规则示例**：
```bash
# 临时开放端口（重启后失效）
iptables -A INPUT -p tcp --dport 8080 -j ACCEPT

# 临时禁止IP（重启后失效）
iptables -A INPUT -s 192.168.1.200 -j DROP
```

### 9.2 永久规则的保存方法


**方法1：使用iptables-save**
```bash
# 保存当前规则到文件
iptables-save > /etc/iptables/rules.v4

# 开机自动加载（Ubuntu/Debian）
apt-get install iptables-persistent
```

**方法2：使用service命令（CentOS/RHEL）**
```bash
# 保存当前规则
service iptables save

# 开机自动启动
chkconfig iptables on
```

**方法3：写入启动脚本**
```bash
# 编辑/etc/rc.local
echo "iptables -A INPUT -p tcp --dport 22 -j ACCEPT" >> /etc/rc.local
```

### 9.3 规则管理策略


**测试新规则的安全流程**：
```
第1步：备份当前规则
iptables-save > /tmp/iptables-$(date +%Y%m%d-%H%M%S)

第2步：设置自动恢复（5分钟后）
echo "iptables-restore < /tmp/iptables-$(date +%Y%m%d-%H%M%S)" | at now + 5 minutes

第3步：测试新规则
iptables -A INPUT ... 

第4步：验证效果
# 测试连接是否正常

第5步：如果正常，取消自动恢复并保存
atrm [job_id]
iptables-save > /etc/iptables/rules.v4
```

### 9.4 不同系统的永久化方法


| 系统 | 保存命令 | 恢复命令 | 开机自动加载 |
|------|----------|----------|--------------|
| **Ubuntu/Debian** | `iptables-save > /etc/iptables/rules.v4` | `iptables-restore < /etc/iptables/rules.v4` | `iptables-persistent` |
| **CentOS 7-** | `service iptables save` | `service iptables start` | `chkconfig iptables on` |
| **CentOS 8+** | `iptables-save > /etc/sysconfig/iptables` | `iptables-restore < /etc/sysconfig/iptables` | `systemctl enable iptables` |
| **通用方法** | `iptables-save > /path/to/file` | `iptables-restore < /path/to/file` | 添加到启动脚本 |

---

## 10. 📋 核心要点总结


### 10.1 四种基本操作对比


| 操作 | 命令 | 位置 | 优先级 | 适用场景 |
|------|------|------|--------|----------|
| **追加** | `-A` | 链末尾 | 最低 | 默认规则、兜底策略 |
| **插入** | `-I` | 指定位置 | 可控制 | 紧急规则、高优先级 |
| **删除** | `-D` | 移除规则 | - | 清理不需要的规则 |
| **替换** | `-R` | 原位置 | 不变 | 修改现有规则 |

### 10.2 实用命令速查


```bash
# 查看规则（带编号）
iptables -L -n --line-numbers

# 追加规则到末尾
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# 插入规则到首位
iptables -I INPUT -s 192.168.1.0/24 -j ACCEPT

# 插入规则到第3位
iptables -I INPUT 3 -p tcp --dport 443 -j ACCEPT

# 删除第2条规则
iptables -D INPUT 2

# 删除特定内容规则
iptables -D INPUT -p tcp --dport 22 -j ACCEPT

# 替换第3条规则
iptables -R INPUT 3 -p tcp --dport 8080 -j ACCEPT

# 清空所有规则
iptables -F

# 保存规则
iptables-save > /etc/iptables/rules.v4

# 恢复规则
iptables-restore < /etc/iptables/rules.v4
```

### 10.3 最佳实践要点


> 💡 **核心原则**
> 
> 1. **安全第一**：操作前确保有恢复方案
> 2. **顺序重要**：规则顺序决定优先级
> 3. **测试验证**：每次修改后都要测试
> 4. **备份习惯**：重要操作前必须备份
> 5. **永久保存**：测试通过后及时保存

### 10.4 常见错误与解决


| 问题 | 原因 | 解决方法 |
|------|------|----------|
| SSH断开 | 规则顺序错误 | 控制台登录，调整规则顺序 |
| 规则不生效 | 被前面规则阻挡 | 使用-I插入到前面 |
| 删除错误规则 | 编号记错 | 先用-L查看确认编号 |
| 重启后失效 | 未永久保存 | 使用iptables-save保存 |

**🧠 记忆口诀**：
```
添删改查四大操作要记清，
-A追加末尾优先级最低，
-I插入可控位置灵活用，
-D删除-R替换要小心，
规则顺序影响优先级，
临时测试永久要保存！
```