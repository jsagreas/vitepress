---
title: 3、规则查看与基础操作
---
## 📚 目录

1. [iptables是什么？新手必知](#1-iptables是什么新手必知)
2. [规则查看与基础操作](#2-规则查看与基础操作)
3. [iptables的工作原理](#3-iptables的工作原理)
4. [表和链的关系详解](#4-表和链的关系详解)
5. [常用命令实战演练](#5-常用命令实战演练)
6. [实际应用场景案例](#6-实际应用场景案例)
7. [新手常见问题与避坑指南](#7-新手常见问题与避坑指南)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔥 iptables是什么？新手必知


### 1.1 用生活例子理解iptables


想象一下，你家门口有个**智能保安**，他的工作是：

```
📦 快递员来了 → 检查身份 → 决定放行还是拒绝
🚗 外卖小哥 → 查看订单 → 允许进入还是请离开  
👥 陌生访客 → 询问来意 → 通报主人或直接拒绝
```

**iptables就是Linux系统的这个"智能保安"！**

它负责检查每一个进出服务器的**网络数据包**，根据你设定的规则决定：
- ✅ **ACCEPT**：放行通过
- ❌ **DROP**：直接丢弃（对方不知道被拒绝）
- 🚫 **REJECT**：拒绝并告知原因

### 1.2 iptables在系统中的位置


```
外网用户 → [防火墙iptables] → Linux服务器
    ↑                           ↓
   决定是否放行              处理允许的请求
```

**🎯 核心理解：**
- iptables = Linux内置的防火墙管理工具
- 它不是防火墙本身，而是管理防火墙规则的**命令行工具**
- 真正的防火墙是Linux内核中的**netfilter框架**

### 1.3 为什么要学iptables？


| 使用场景 | 具体作用 | 重要程度 |
|---------|----------|----------|
| 🛡️ **服务器安全** | 阻止恶意攻击和扫描 | ⭐⭐⭐⭐⭐ |
| 🌐 **访问控制** | 限制特定IP或端口访问 | ⭐⭐⭐⭐⭐ |
| 📊 **流量管理** | 控制带宽和连接数 | ⭐⭐⭐⭐ |
| 🔄 **端口转发** | 内网服务对外发布 | ⭐⭐⭐⭐ |
| 📈 **网络监控** | 统计流量和连接信息 | ⭐⭐⭐ |

---

## 2. 👀 规则查看与基础操作


### 2.1 查看现有规则 - 你的第一个iptables命令


**最基础的查看命令：**

```bash
# 查看所有规则（最常用）
iptables -L
```

**输出示例解读：**
```
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
```

**📝 新手解读：**
- `Chain INPUT`：处理**进入**服务器的数据包
- `Chain FORWARD`：处理**转发**的数据包（通常用于路由器）  
- `Chain OUTPUT`：处理**离开**服务器的数据包
- `policy ACCEPT`：默认策略是**允许通过**

### 2.2 更详细的查看选项


**🔍 常用查看命令对比：**

| 命令 | 作用 | 适用场景 |
|------|------|----------|
| `iptables -L` | 基础查看 | 快速了解规则概况 |
| `iptables -L -n` | **数字显示**（不解析域名） | 🔥 **最推荐**，速度快 |
| `iptables -L -v` | 详细信息（包含流量统计） | 查看规则使用情况 |
| `iptables -L --line-numbers` | 显示规则行号 | 方便删除特定规则 |

**💡 新手推荐组合：**
```bash
# 这是最实用的查看命令
iptables -L -n -v --line-numbers
```

**输出解读：**
```
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num  target     prot opt source          destination         pkts bytes
1    ACCEPT     tcp  --  192.168.1.0/24  0.0.0.0/0           150  12K
2    DROP       all  --  0.0.0.0/0       0.0.0.0/0           0    0
```

**🎯 每列含义：**
- `num`：规则编号（用于删除）
- `target`：动作（ACCEPT/DROP/REJECT）
- `prot`：协议（tcp/udp/icmp/all）
- `source`：来源IP
- `destination`：目标IP
- `pkts`：匹配的数据包数量
- `bytes`：匹配的字节数

### 2.3 指定表查看


iptables有多个表，默认查看的是`filter`表：

```bash
# 查看不同的表
iptables -t filter -L     # 过滤表（默认）
iptables -t nat -L        # NAT表（地址转换）
iptables -t mangle -L     # 修改表（修改数据包）
iptables -t raw -L        # 原始表（连接跟踪）
```

**🔰 新手建议：**
刚开始只关注`filter`表就够了，其他表后续深入学习。

### 2.4 清空操作命令


> ⚠️ **重要警告**
> 
> 清空操作有风险！在生产环境操作前请确保有备份方案

**基础清空命令：**

| 命令 | 作用 | 风险级别 |
|------|------|----------|
| `iptables -F` | 清空所有链的规则 | 🔴 **高风险** |
| `iptables -F INPUT` | 只清空INPUT链 | 🟡 **中等风险** |
| `iptables -X` | 删除用户自定义链 | 🟢 **低风险** |
| `iptables -Z` | 清零计数器 | 🟢 **无风险** |

**🛡️ 安全操作建议：**

```bash
# 1. 先备份当前规则
iptables-save > /tmp/iptables_backup.txt

# 2. 设置临时允许规则（防止自己被锁在外面）
iptables -I INPUT -s 你的IP地址 -j ACCEPT

# 3. 然后进行清空操作
iptables -F

# 4. 如果出问题，恢复备份
iptables-restore < /tmp/iptables_backup.txt
```

---

## 3. ⚙️ iptables的工作原理


### 3.1 数据包的旅程


想象数据包是快递，iptables是沿途的检查站：

```
互联网 → [INPUT检查站] → 服务器程序
                ↓
服务器程序 → [OUTPUT检查站] → 互联网
                ↓
路由转发 → [FORWARD检查站] → 其他网络
```

**📍 检查站详解：**

**INPUT链**：
- 🎯 **检查对象**：发给本机的数据包
- 🌰 **举例**：有人访问你的网站、SSH连接等

**OUTPUT链**：
- 🎯 **检查对象**：本机发出的数据包  
- 🌰 **举例**：服务器主动访问外网、发送邮件等

**FORWARD链**：
- 🎯 **检查对象**：经过本机转发的数据包
- 🌰 **举例**：本机作为路由器时用到

### 3.2 规则匹配流程


```
数据包到达
    ↓
按顺序检查规则1、2、3...
    ↓
找到匹配的规则 → 执行对应动作
    ↓
没找到匹配 → 执行默认策略
```

**🔍 匹配条件示例：**
```
如果（来源IP = 192.168.1.100）
并且（目标端口 = 22）  
并且（协议 = TCP）
那么（动作 = ACCEPT）
```

### 3.3 常用动作说明


| 动作 | 效果 | 对方感受 | 使用场景 |
|------|------|----------|----------|
| **ACCEPT** | 允许通过 | 正常访问 | 允许可信来源 |
| **DROP** | 悄悄丢弃 | 连接超时 | 屏蔽扫描攻击 |
| **REJECT** | 拒绝并回复 | 立即收到拒绝信息 | 明确告知不允许 |
| **LOG** | 记录日志后继续 | 无感知 | 审计和调试 |

---

## 4. 📊 表和链的关系详解


### 4.1 四大表的职责分工


**用公司部门来理解：**

```
🏢 iptables公司的四个部门

📋 filter部门（安保部）
   职责：决定是否放行
   常用链：INPUT、OUTPUT、FORWARD

🔄 nat部门（地址转换部）  
   职责：修改IP地址和端口
   常用链：PREROUTING、POSTROUTING

🔧 mangle部门（数据修改部）
   职责：修改数据包内容
   常用链：所有链都有

📦 raw部门（原始处理部）
   职责：连接跟踪控制
   常用链：PREROUTING、OUTPUT
```

### 4.2 表和链的对应关系


```
           PREROUTING  INPUT  FORWARD  OUTPUT  POSTROUTING
raw表          ✅       ❌      ❌       ✅        ❌
mangle表       ✅       ✅      ✅       ✅        ✅  
nat表          ✅       ❌      ❌       ✅        ✅
filter表       ❌       ✅      ✅       ✅        ❌
```

**🎯 新手重点关注：**
- **filter表的INPUT链**：控制谁能访问你的服务器
- **filter表的OUTPUT链**：控制服务器能访问什么

### 4.3 数据包处理优先级


```
数据包处理顺序：
1. raw表
2. mangle表  
3. nat表
4. filter表
```

**💡 实际含义：**
即使在filter表设置了DROP规则，如果在nat表已经处理了，可能不会生效。

---

## 5. 🛠️ 常用命令实战演练


### 5.1 添加规则的基本语法


**标准格式：**
```bash
iptables [表选项] [链选项] [匹配条件] [动作]
```

**🌰 实例分解：**
```bash
iptables -t filter -A INPUT -s 192.168.1.100 -j ACCEPT
   ↑        ↑      ↑     ↑           ↑            ↑
 命令名   指定表   链   规则位置    匹配条件      动作
```

### 5.2 基础规则添加实战


**场景1：允许特定IP访问SSH（22端口）**
```bash
# 允许192.168.1.100通过SSH连接
iptables -A INPUT -s 192.168.1.100 -p tcp --dport 22 -j ACCEPT
```

**场景2：阻止特定IP访问**
```bash
# 阻止恶意IP 1.2.3.4
iptables -A INPUT -s 1.2.3.4 -j DROP
```

**场景3：开放Web服务端口**
```bash
# 允许所有人访问80端口（HTTP）
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# 允许所有人访问443端口（HTTPS）  
iptables -A INPUT -p tcp --dport 443 -j ACCEPT
```

### 5.3 规则的增删改查


**🔍 查看规则：**
```bash
# 查看所有规则并显示行号
iptables -L -n --line-numbers
```

**➕ 添加规则：**
```bash
# 在链的末尾添加（-A = append）
iptables -A INPUT -p tcp --dport 3306 -j DROP

# 在指定位置插入（-I = insert）
iptables -I INPUT 1 -s 192.168.1.0/24 -j ACCEPT
```

**❌ 删除规则：**
```bash
# 按行号删除（推荐方式）
iptables -D INPUT 3

# 按规则内容删除
iptables -D INPUT -s 1.2.3.4 -j DROP
```

**✏️ 修改规则：**
```bash
# 替换指定行号的规则
iptables -R INPUT 2 -s 192.168.1.0/24 -p tcp --dport 22 -j ACCEPT
```

### 5.4 常用参数详解


| 参数 | 含义 | 示例 | 说明 |
|------|------|------|------|
| `-s` | 来源IP | `-s 192.168.1.100` | 可以是单个IP或网段 |
| `-d` | 目标IP | `-d 10.0.0.1` | 通常用于OUTPUT链 |
| `-p` | 协议 | `-p tcp` | tcp/udp/icmp/all |
| `--dport` | 目标端口 | `--dport 80` | 需要配合-p tcp/udp |
| `--sport` | 源端口 | `--sport 1024:65535` | 可以指定范围 |
| `-i` | 入站接口 | `-i eth0` | 网络接口名称 |
| `-o` | 出站接口 | `-o eth0` | 网络接口名称 |

**💡 高级技巧：**
```bash
# 端口范围
iptables -A INPUT -p tcp --dport 8000:8080 -j ACCEPT

# 网段表示  
iptables -A INPUT -s 192.168.1.0/24 -j ACCEPT

# 排除IP（使用！号）
iptables -A INPUT -s ! 192.168.1.100 -j DROP
```

---

## 6. 🎯 实际应用场景案例


### 6.1 场景一：Web服务器基础防护


**需求：**搭建一个Web服务器，只允许HTTP/HTTPS访问，屏蔽其他端口

**🔧 实施步骤：**

**第一步：清空现有规则并设置默认策略**
```bash
# 清空规则
iptables -F

# 设置默认拒绝策略（谨慎使用！）
iptables -P INPUT DROP
iptables -P FORWARD DROP  
iptables -P OUTPUT ACCEPT
```

**第二步：添加基础允许规则**
```bash
# 允许本地回环
iptables -A INPUT -i lo -j ACCEPT

# 允许已建立的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 允许HTTP访问
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# 允许HTTPS访问
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 允许SSH管理（限制来源IP）
iptables -A INPUT -s 你的管理IP -p tcp --dport 22 -j ACCEPT
```

**第三步：验证配置**
```bash
# 查看规则
iptables -L -n -v --line-numbers

# 测试Web访问
curl -I http://服务器IP
```

### 6.2 场景二：数据库服务器安全加固


**需求：**MySQL服务器只允许应用服务器访问，禁止外网直接连接

```bash
# 只允许应用服务器（192.168.1.10）访问MySQL
iptables -A INPUT -s 192.168.1.10 -p tcp --dport 3306 -j ACCEPT

# 拒绝其他所有对MySQL的访问
iptables -A INPUT -p tcp --dport 3306 -j DROP

# 记录恶意尝试
iptables -A INPUT -p tcp --dport 3306 -j LOG --log-prefix "MySQL攻击："
```

### 6.3 场景三：限制SSH暴力破解


**需求：**防止SSH密码暴力破解攻击

```bash
# 限制SSH连接频率（每分钟最多3次新连接）
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --set
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 60 --hitcount 4 -j DROP

# 只允许特定网段SSH访问
iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j DROP
```

### 6.4 场景四：简单的内网共享上网


**需求：**让内网机器通过服务器上网

```bash
# 开启IP转发
echo 1 > /proc/sys/net/ipv4/ip_forward

# 设置NAT规则（MASQUERADE）
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE

# 允许转发
iptables -A FORWARD -s 192.168.1.0/24 -j ACCEPT
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
```

---

## 7. ⚠️ 新手常见问题与避坑指南


### 7.1 致命错误：把自己锁在门外


**🚨 问题描述：**
新手最容易犯的错误，设置了严格的INPUT规则后，SSH连接断开，再也连不上服务器。

**💥 典型错误操作：**
```bash
# 危险操作：直接设置默认拒绝
iptables -P INPUT DROP
# 然后SSH断开，无法重新连接！
```

**🛡️ 正确做法：**
```bash
# 1. 先设置SSH允许规则
iptables -A INPUT -s 你的IP -p tcp --dport 22 -j ACCEPT

# 2. 再设置默认策略
iptables -P INPUT DROP

# 3. 或者使用at命令定时恢复
at now + 10 minutes <<< "iptables -P INPUT ACCEPT"
```

### 7.2 规则顺序搞错


**🔴 错误示例：**
```bash
# 先设置了拒绝所有
iptables -A INPUT -j DROP
# 后设置允许SSH（永远不会生效！）
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```

**✅ 正确做法：**
```bash
# 允许规则要放在拒绝规则前面
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -j DROP
```

**📝 规则检查：**
```bash
# 用这个命令查看规则执行情况
iptables -L -n -v --line-numbers
# 看pkts列，如果某个规则一直是0，可能位置有问题
```

### 7.3 忘记保存规则


**😱 问题：**
辛苦配置的规则，重启服务器后全部消失！

**💾 保存方法：**

**CentOS/RHEL系统：**
```bash
# 保存规则
service iptables save
# 或者
iptables-save > /etc/sysconfig/iptables
```

**Ubuntu/Debian系统：**
```bash
# 安装持久化工具
apt-get install iptables-persistent

# 手动保存
iptables-save > /etc/iptables/rules.v4

# 开机自动加载
systemctl enable netfilter-persistent
```

### 7.4 协议和端口不匹配


**🔴 错误示例：**
```bash
# 错误：ping使用ICMP协议，不是TCP
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
# 期望允许ping，但ping用的是ICMP
```

**✅ 正确做法：**
```bash
# 允许ping（ICMP协议）
iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT

# 允许TCP端口
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# 允许UDP端口  
iptables -A INPUT -p udp --dport 53 -j ACCEPT
```

### 7.5 测试环境与生产环境差异


**⚠️ 注意事项：**

| 环境 | 建议策略 | 风险控制 |
|------|----------|----------|
| **测试环境** | 可以大胆试验 | 定期快照备份 |
| **生产环境** | 保守操作 | 多重验证+备份 |

**🔧 生产环境操作流程：**
1. **测试环境验证** → 2. **备份当前规则** → 3. **分步骤执行** → 4. **逐步验证** → 5. **持久化保存**

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基础命令


```bash
# 🔍 查看类命令（日常必用）
iptables -L -n -v --line-numbers    # 查看所有规则详情
iptables -t nat -L -n               # 查看NAT表

# ➕ 添加类命令  
iptables -A INPUT -p tcp --dport 80 -j ACCEPT     # 末尾添加
iptables -I INPUT 1 -s 192.168.1.0/24 -j ACCEPT  # 指定位置插入

# ❌ 删除类命令
iptables -D INPUT 3                 # 按行号删除
iptables -F                         # 清空所有规则

# 💾 保存类命令
iptables-save > /tmp/rules.txt      # 备份规则
iptables-restore < /tmp/rules.txt   # 恢复规则
```

### 8.2 安全操作清单


> 🛡️ **安全第一原则**
> 
> 1. **操作前必备份**：`iptables-save > backup.txt`
> 2. **测试环境先验证**：避免生产环境直接操作
> 3. **SSH规则先设置**：防止把自己锁在外面
> 4. **规则顺序要注意**：允许规则在拒绝规则前面
> 5. **及时保存配置**：避免重启后丢失

### 8.3 学习进阶路线


**🎯 初级阶段（1-2周）：**
- ✅ 掌握基本查看命令
- ✅ 理解INPUT/OUTPUT/FORWARD链
- ✅ 会设置简单的允许/拒绝规则
- ✅ 能保存和恢复规则

**🚀 中级阶段（2-4周）：**
- ✅ 熟练使用各种匹配条件
- ✅ 理解状态连接跟踪
- ✅ 掌握NAT表的基本用法
- ✅ 能设计完整的防火墙策略

**🏆 高级阶段（1-3个月）：**
- ✅ 自定义链的使用
- ✅ 复杂规则的性能优化
- ✅ 结合脚本实现动态管理
- ✅ 企业级防火墙架构设计

### 8.4 实用技巧备忘


**🔧 日常管理技巧：**

```bash
# 快速备份当前规则
alias ipt-backup='iptables-save > /tmp/ipt-$(date +%Y%m%d-%H%M%S).txt'

# 快速查看规则摘要
alias ipt-list='iptables -L -n --line-numbers'

# 临时允许自己的IP（紧急情况用）
MY_IP=$(curl -s ifconfig.me)
iptables -I INPUT 1 -s $MY_IP -j ACCEPT
```

**📊 监控和调试：**

```bash
# 查看规则匹配统计
watch -n 1 'iptables -L -n -v'

# 实时查看被DROP的包  
tail -f /var/log/messages | grep "iptables:"

# 测试端口连通性
nc -zv 目标IP 目标端口
```

### 8.5 常见端口速查表


| 服务 | 端口 | 协议 | iptables规则示例 |
|------|------|------|------------------|
| SSH | 22 | TCP | `iptables -A INPUT -p tcp --dport 22 -j ACCEPT` |
| HTTP | 80 | TCP | `iptables -A INPUT -p tcp --dport 80 -j ACCEPT` |
| HTTPS | 443 | TCP | `iptables -A INPUT -p tcp --dport 443 -j ACCEPT` |
| MySQL | 3306 | TCP | `iptables -A INPUT -p tcp --dport 3306 -j ACCEPT` |
| Redis | 6379 | TCP | `iptables -A INPUT -p tcp --dport 6379 -j ACCEPT` |
| DNS | 53 | UDP | `iptables -A INPUT -p udp --dport 53 -j ACCEPT` |
| PING | - | ICMP | `iptables -A INPUT -p icmp -j ACCEPT` |

**核心记忆：**
- iptables = Linux系统的智能门卫
- 三个主要链：INPUT（进门）、OUTPUT（出门）、FORWARD（路过）
- 规则有顺序：从上往下匹配，匹配到就执行
- 安全第一：备份、测试、分步操作
- 熟能生巧：多练习、多实践、多总结

---

> 💡 **学习建议**
> 
> iptables虽然概念较多，但核心就是"规则匹配和动作执行"。建议在虚拟机中多加练习，熟悉基本命令后再逐步深入高级功能。记住：理论结合实践，安全第一，循序渐进！