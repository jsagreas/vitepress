---
title: 10、服务性能与资源控制
---
## 📚 目录

1. [服务资源监控与查看](#1-服务资源监控与查看)
2. [服务资源限制配置](#2-服务资源限制配置)
3. [动态资源调整](#3-动态资源调整)
4. [资源分组管理](#4-资源分组管理)
5. [服务超时与重启策略](#5-服务超时与重启策略)
6. [实际应用场景](#6-实际应用场景)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔍 服务资源监控与查看


### 1.1 systemctl show 查看服务资源使用


**概念理解**：`systemctl show` 就像给服务做"体检"，能详细显示服务当前的资源使用情况和配置信息。

**基本语法**：
```bash
systemctl show [服务名] [--property=属性名]
```

**查看服务完整信息**：
```bash
# 查看nginx服务的所有信息
systemctl show nginx

# 查看特定属性（内存相关）
systemctl show nginx --property=MemoryCurrent
systemctl show nginx --property=MemoryMax

# 查看多个属性
systemctl show nginx --property=MemoryCurrent,CPUQuotaPerSecUSec,TasksCurrent
```

**常用资源属性含义**：

| 属性名 | 含义 | 示例值 |
|--------|------|--------|
| **MemoryCurrent** | 当前内存使用量 | `52428800` (50MB) |
| **MemoryMax** | 内存使用限制 | `134217728` (128MB) |
| **CPUQuotaPerSecUSec** | CPU配额限制 | `500000` (50%CPU) |
| **TasksCurrent** | 当前任务/线程数 | `5` |
| **TasksMax** | 最大任务数限制 | `1024` |

### 1.2 systemd-cgtop 实时监控资源


**概念理解**：`systemd-cgtop` 就像Linux版的"任务管理器"，专门监控systemd服务的资源使用情况，实时显示哪个服务占用了多少CPU、内存。

**基本使用**：
```bash
# 启动实时监控
systemd-cgtop

# 按CPU使用率排序
systemd-cgtop --order=cpu

# 按内存使用排序  
systemd-cgtop --order=memory

# 只显示指定数量的服务
systemd-cgtop -n 10
```

**监控界面解读**：
```
Control Group                    Tasks   %CPU   Memory  Input/s Output/s
/                                  156   12.5     1.2G        -        -
/system.slice                       45    8.2   423.5M        -        -
/system.slice/nginx.service          4    2.1    52.3M        -        -
/system.slice/mysql.service          8    5.8   234.1M        -        -
/user.slice                         23    1.8   145.2M        -        -
```

**字段含义说明**：
- **Control Group**：服务的控制组路径
- **Tasks**：该服务的任务/进程数量
- **%CPU**：CPU使用百分比
- **Memory**：内存使用量
- **Input/s**：磁盘读取速度
- **Output/s**：磁盘写入速度

---

## 2. ⚙️ 服务资源限制配置


### 2.1 内存限制 - MemoryMax


**概念理解**：`MemoryMax` 就像给服务设置"内存天花板"，防止某个服务占用过多内存影响系统稳定性。

**配置方法**：

**方式一：修改服务文件**
```bash
# 编辑服务配置文件
sudo systemctl edit nginx

# 在打开的编辑器中添加
[Service]
MemoryMax=128M        # 最大使用128MB内存
MemoryHigh=96M        # 内存使用达到96MB时开始限制
```

**方式二：临时设置**
```bash
# 临时设置内存限制
sudo systemctl set-property nginx MemoryMax=128M
```

**内存限制相关配置**：

| 配置项 | 含义 | 示例 |
|--------|------|------|
| **MemoryMax** | 硬性内存上限，超过会被杀死 | `MemoryMax=256M` |
| **MemoryHigh** | 软性内存警告线，超过开始限制 | `MemoryHigh=200M` |
| **MemorySwapMax** | swap使用上限 | `MemorySwapMax=512M` |

### 2.2 CPU限制 - CPUQuota


**概念理解**：`CPUQuota` 就像给服务分配"CPU时间片"，控制服务最多能使用多少CPU资源。

**配置示例**：
```bash
# 编辑服务配置
sudo systemctl edit apache2

# 添加CPU限制
[Service]
CPUQuota=50%          # 最多使用50%的CPU
CPUWeight=100         # CPU权重（相对优先级）
```

**CPU配置详解**：

```
CPU配置关系图：
┌─────────────────────────────────────┐
│              CPU 100%               │
├─────────────────┬───────────────────┤
│   Service A     │    Service B      │
│   CPUQuota=30%  │   CPUQuota=70%    │
└─────────────────┴───────────────────┘

实际效果：
- Service A 最多占用30%CPU
- Service B 最多占用70%CPU  
- 超出限制时会被throttle(节流)
```

**常用CPU配置**：
- `CPUQuota=50%` - 限制使用50%CPU
- `CPUQuota=200%` - 在多核系统上可使用2个CPU核心
- `CPUWeight=200` - 相对权重，默认100

---

## 3. 🎛️ 动态资源调整


### 3.1 systemctl set-property 实时调整


**概念理解**：`set-property` 就像"热插拔"调整资源，不需要重启服务就能修改资源限制，立即生效。

**基本语法**：
```bash
systemctl set-property [服务名] [属性=值] [--runtime]
```

**实际使用示例**：

```bash
# 动态调整内存限制
sudo systemctl set-property nginx MemoryMax=256M

# 动态调整CPU限制
sudo systemctl set-property nginx CPUQuota=75%

# 临时调整（重启后失效）
sudo systemctl set-property --runtime nginx MemoryMax=512M

# 调整任务数限制
sudo systemctl set-property nginx TasksMax=50
```

**验证调整结果**：
```bash
# 查看调整后的配置
systemctl show nginx --property=MemoryMax,CPUQuotaPerSecUSec

# 查看实时资源使用
systemd-cgtop | grep nginx
```

### 3.2 永久性 vs 临时性调整


**调整类型对比**：

```
永久调整 (默认)：
├─ 写入配置文件
├─ 重启后仍生效  
└─ 适合长期配置

临时调整 (--runtime)：
├─ 只在内存中生效
├─ 重启后恢复原配置
└─ 适合临时测试
```

---

## 4. 📊 资源分组管理


### 4.1 slice.slice 资源分组概念


**概念理解**：`slice` 就像"资源管理的文件夹"，把相关的服务放在同一个组里统一管理资源，比如把所有Web服务放在一个slice里。

**系统默认slice结构**：
```
systemd slice 层次结构：
├─ -.slice (根slice)
├─ system.slice (系统服务)
│  ├─ nginx.service
│  ├─ mysql.service  
│  └─ apache2.service
├─ user.slice (用户服务)
│  └─ user-1000.slice
└─ machine.slice (虚拟机容器)
```

### 4.2 创建自定义slice


**创建Web服务slice**：
```bash
# 创建web服务slice配置
sudo nano /etc/systemd/system/web.slice

# 配置内容
[Unit]
Description=Web Services Resource Group
Before=slices.target

[Slice]
MemoryMax=2G           # 整个组最多使用2GB内存
CPUQuota=150%          # 整个组最多使用1.5个CPU核心
TasksMax=200           # 整个组最多200个任务
```

**将服务分配到slice**：
```bash
# 编辑nginx服务
sudo systemctl edit nginx

# 添加slice配置
[Service]
Slice=web.slice        # 将nginx分配到web.slice

# 重新加载配置
sudo systemctl daemon-reload
sudo systemctl restart nginx
```

**查看slice资源使用**：
```bash
# 查看slice状态
systemctl status web.slice

# 监控slice资源使用
systemd-cgtop | grep web.slice
```

---

## 5. ⏱️ 服务超时与重启策略


### 5.1 超时设置 - TimeoutStartSec/TimeoutStopSec


**概念理解**：超时设置就像给服务设置"耐心等待时间"，规定服务启动或停止最多等多长时间，超时就认为失败。

**超时配置详解**：

```bash
# 编辑服务配置
sudo systemctl edit mysql

# 添加超时设置
[Service]
TimeoutStartSec=60s    # 启动超时60秒
TimeoutStopSec=30s     # 停止超时30秒
TimeoutSec=90s         # 同时设置启动和停止超时
```

**不同服务的超时建议**：

| 服务类型 | 启动超时 | 停止超时 | 说明 |
|----------|----------|----------|------|
| **Web服务** | `30s` | `15s` | 启动快，停止也快 |
| **数据库** | `120s` | `60s` | 需要时间初始化和保存数据 |
| **应用服务** | `60s` | `30s` | 根据应用复杂度调整 |

### 5.2 重启策略 - Restart配置


**概念理解**：重启策略就像给服务设置"自愈能力"，当服务异常退出时，系统会根据策略决定是否自动重启。

**重启策略类型**：

| 策略值 | 含义 | 适用场景 |
|--------|------|----------|
| **no** | 从不自动重启 | 一次性任务 |
| **always** | 总是重启 | 关键服务，必须保持运行 |
| **on-failure** | 异常退出时重启 | 大多数应用服务 |
| **on-abnormal** | 异常信号或超时时重启 | 系统服务 |
| **on-abort** | 收到未处理信号时重启 | 特殊应用 |

**重启策略配置示例**：
```bash
# 编辑服务配置
sudo systemctl edit nginx

# 配置重启策略
[Service]
Restart=on-failure     # 失败时重启
RestartSec=5s          # 重启间隔5秒
StartLimitBurst=3      # 连续重启次数限制
StartLimitIntervalSec=60s  # 时间窗口60秒
```

### 5.3 RestartSec 重启间隔


**概念理解**：`RestartSec` 就像设置"冷却时间"，防止服务频繁重启造成系统负担，规定两次重启之间的等待时间。

**重启间隔策略**：

```
重启时间线示例：
服务崩溃 -> 等待5秒 -> 重启 -> 又崩溃 -> 等待5秒 -> 重启
    ↓         ↓         ↓        ↓         ↓
   00:00    00:05    00:05    00:10    00:15

RestartSec=5s 的作用：
- 防止无限重启循环
- 给系统资源恢复时间
- 避免日志快速膨胀
```

**不同服务的重启间隔建议**：
- **Web服务**：`RestartSec=3s` - 快速恢复服务
- **数据库服务**：`RestartSec=10s` - 给足初始化时间
- **应用服务**：`RestartSec=5s` - 平衡恢复速度和稳定性

---

## 6. 🚀 实际应用场景


### 6.1 高负载Web服务优化


**场景描述**：网站访问量大，需要限制资源使用防止服务器崩溃。

**完整配置示例**：
```bash
# 创建Web服务资源组
sudo nano /etc/systemd/system/web.slice
```

配置文件内容：
```ini
[Unit]
Description=Web Services Resource Group

[Slice]
MemoryMax=4G
CPUQuota=200%
TasksMax=500
```

```bash
# 配置nginx服务
sudo systemctl edit nginx
```

配置内容：
```ini
[Service]
Slice=web.slice
MemoryMax=1G
MemoryHigh=800M
CPUQuota=100%
TimeoutStartSec=30s
TimeoutStopSec=15s
Restart=on-failure
RestartSec=5s
StartLimitBurst=3
```

### 6.2 数据库服务稳定性配置


**场景描述**：MySQL数据库需要保证稳定运行，合理的资源限制和重启策略。

```bash
# 配置MySQL服务
sudo systemctl edit mysql
```

配置内容：
```ini
[Service]
MemoryMax=2G
CPUQuota=150%
TimeoutStartSec=120s
TimeoutStopSec=60s
Restart=on-failure
RestartSec=10s
StartLimitBurst=3
StartLimitIntervalSec=300s
```

### 6.3 资源监控脚本


**自动化监控脚本**：
```bash
#!/bin/bash
# 服务资源监控脚本

echo "=== 服务资源使用情况 ==="
for service in nginx mysql apache2; do
    if systemctl is-active $service >/dev/null 2>&1; then
        echo "[$service 服务]"
        systemctl show $service --property=MemoryCurrent,MemoryMax,TasksCurrent | \
        while IFS= read -r line; do
            echo "  $line"
        done
        echo ""
    fi
done

echo "=== Top 10 资源占用服务 ==="
systemd-cgtop -n 10 --batch -1
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心概念


```
🔸 资源监控：systemctl show查看详情，systemd-cgtop实时监控
🔸 资源限制：MemoryMax内存限制，CPUQuota CPU限制
🔸 动态调整：systemctl set-property实时修改配置
🔸 分组管理：slice.slice统一管理相关服务资源
🔸 超时设置：TimeoutStartSec/TimeoutStopSec控制启停时间
🔸 重启策略：Restart=策略 + RestartSec=间隔时间
```

### 7.2 关键理解要点


**🔹 资源监控的意义**：
```
实时掌握：了解服务当前资源使用情况
预防问题：及时发现资源使用异常
优化依据：为资源配置调整提供数据支撑
```

**🔹 资源限制的作用**：
```
系统稳定：防止单个服务占用过多资源
服务隔离：确保关键服务有足够资源
性能优化：合理分配资源提高整体效率
```

**🔹 重启策略的选择**：
```
关键服务：使用always或on-failure确保高可用
一次性任务：使用no避免不必要的重启
调试阶段：使用on-failure便于问题排查
```

### 7.3 最佳实践建议


**🎯 监控策略**：
- 定期检查服务资源使用情况
- 设置合理的资源限制阈值
- 建立资源使用趋势分析

**⚙️ 配置原则**：
- 根据服务特点设置超时时间
- 选择合适的重启策略
- 使用slice进行分组管理

**🔧 运维技巧**：
- 先临时调整测试效果
- 确认无问题后设为永久配置
- 保留配置变更记录

**核心记忆口诀**：
```
show查看property属性，cgtop监控很直观
Memory内存CPU配额，set-property动态调
slice分组管资源，超时重启保稳定
监控限制两手抓，服务性能有保障
```

### 7.4 故障排查要点


**常见问题及解决**：

| 问题现象 | 可能原因 | 解决方法 |
|----------|----------|----------|
| 服务频繁重启 | 资源限制过严 | 适当放宽资源限制 |
| 启动超时失败 | TimeoutStartSec过短 | 增加启动超时时间 |
| 内存使用过高 | 未设置MemoryMax | 设置合理的内存限制 |
| CPU占用100% | 未设置CPU限制 | 配置CPUQuota限制 |

这些配置和监控方法是Linux系统服务管理的核心技能，掌握后能显著提高系统的稳定性和性能。