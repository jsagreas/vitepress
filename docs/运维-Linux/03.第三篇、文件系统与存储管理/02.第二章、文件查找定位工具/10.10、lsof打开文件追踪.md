---
title: 10、lsof打开文件追踪
---
## 📚 目录

1. [lsof命令基础入门](#1-lsof命令基础入门)
2. [按进程查看打开文件](#2-按进程查看打开文件)
3. [按文件查看访问进程](#3-按文件查看访问进程)
4. [网络连接文件描述符](#4-网络连接文件描述符)
5. [设备文件占用分析](#5-设备文件占用分析)
6. [删除文件恢复追踪](#6-删除文件恢复追踪)
7. [系统资源占用诊断](#7-系统资源占用诊断)
8. [进程文件依赖分析](#8-进程文件依赖分析)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 📂 lsof命令基础入门


### 1.1 什么是lsof


**简单理解**：lsof就是"**L**i**s**t **O**pen **F**iles"的缩写，翻译过来就是"列出打开的文件"。

```
生活类比：
就像物业管理员查看大楼里：
• 哪些房间正在被使用（进程）
• 每个房间里的人在用什么设备（文件）
• 谁在占用电梯、水电设施（系统资源）
```

**lsof的本质**：在Linux中，一切皆文件。lsof能告诉你：
- 哪个程序正在使用哪个文件
- 哪个文件被哪些程序占用
- 网络连接、设备、管道等都被谁在用

### 1.2 为什么需要lsof


**实际场景问题**：
```
🤔 遇到的困惑：
• 文件删不掉，提示"文件正在使用"
• 磁盘空间不够，但找不到大文件在哪
• 网络端口被占用，不知道是哪个程序
• 系统卡顿，想找出是哪个程序在读写文件
```

**lsof解决方案**：
- ✅ **快速定位**：哪个程序占用了文件
- ✅ **故障排查**：找出系统资源占用的真凶
- ✅ **安全监控**：检查可疑程序的文件访问
- ✅ **性能分析**：了解程序的文件操作行为

### 1.3 lsof基本语法结构


```bash
# 基本语法格式
lsof [选项] [文件/目录/进程]
```

**常用选项速查**：
```
-p PID     # 查看指定进程打开的文件
-c 命令名   # 查看指定命令打开的文件  
-u 用户名   # 查看指定用户打开的文件
-i         # 查看网络连接
+D 目录     # 递归查看目录下被访问的文件
-t         # 仅显示进程ID
```

---

## 2. 🔍 按进程查看打开文件


### 2.1 通过进程ID查看


**实际应用场景**：想知道某个程序到底在访问哪些文件。

```bash
# 查看进程1234打开了哪些文件
lsof -p 1234

# 输出示例：
COMMAND  PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
firefox 1234  zhang  cwd  DIR   8,1     4096  2 /home/zhang
firefox 1234  zhang  rtd  DIR   8,1     4096  2 /
firefox 1234  zhang  txt  REG   8,1  5123456 12 /usr/bin/firefox
firefox 1234  zhang   0u  CHR   1,3      0t0  6 /dev/null
firefox 1234  zhang   1u  CHR   1,3      0t0  6 /dev/null
firefox 1234  zhang   4r  REG   8,1    45678 89 /home/zhang/.config/firefox/profile.db
```

**输出字段含义解释**：
```
┌─ lsof输出字段说明 ─────────────────┐
│ COMMAND: 程序名称（firefox）       │
│ PID: 进程ID（1234）               │
│ USER: 运行用户（zhang）           │
│ FD: 文件描述符类型                │
│   - cwd: 当前工作目录            │
│   - rtd: 根目录                  │
│   - txt: 程序文件本身            │
│   - 0u/1u/2u: 标准输入/输出/错误 │
│   - 数字: 普通文件描述符         │
│ TYPE: 文件类型（DIR目录/REG普通文件）│
│ NAME: 文件路径                    │
└────────────────────────────────────┘
```

### 2.2 通过程序名查看


```bash
# 查看所有firefox进程打开的文件
lsof -c firefox

# 查看多个程序（用逗号分隔）
lsof -c firefox,chrome

# 更灵活的匹配（以fire开头的程序）
lsof -c fire
```

**实用技巧**：
```bash
# 只看打开的普通文件，过滤掉系统文件
lsof -c nginx | grep REG

# 统计某程序打开了多少个文件
lsof -c mysql | wc -l
```

### 2.3 按用户查看文件


```bash
# 查看用户zhang打开的所有文件
lsof -u zhang

# 查看除了root以外所有用户的文件
lsof -u ^root

# 组合查询：用户zhang的firefox程序
lsof -u zhang -c firefox
```

---

## 3. 📁 按文件查看访问进程


### 3.1 查看单个文件被谁占用


**典型场景**：文件删不掉，想知道谁在用。

```bash
# 查看/var/log/syslog被哪些进程占用
lsof /var/log/syslog

# 输出示例：
COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF    NODE NAME
rsyslogd 1020 root    4w   REG    8,1  1048576  123456 /var/log/syslog
tail     2340 zhang   3r   REG    8,1  1048576  123456 /var/log/syslog
```

**解读结果**：
- `rsyslogd`进程在写入日志（4w表示写模式）
- `tail`命令在读取日志（3r表示读模式）

### 3.2 查看目录下文件占用


```bash
# 查看/home/zhang目录下被访问的文件
lsof +D /home/zhang

# 递归查看整个目录树
lsof +D /var/log
```

**性能提示**：
```
⚡ 注意：+D选项会递归搜索，大目录会很慢
💡 建议：先用ls确认目录大小，必要时限制搜索深度
```

### 3.3 查看挂载点占用


**应用场景**：卸载U盘或磁盘分区时提示设备忙。

```bash
# 查看/mnt/usb挂载点被谁占用
lsof +D /mnt/usb

# 或者直接查看设备
lsof /dev/sdb1
```

**实战示例**：
```bash
# 场景：想卸载U盘但提示device is busy
$ umount /mnt/usb
umount: /mnt/usb: device is busy

# 用lsof找出占用者
$ lsof +D /mnt/usb
COMMAND  PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
bash    1234  zhang  cwd  DIR    8,17     4096    2 /mnt/usb/documents

# 发现bash进程在/mnt/usb目录中，切换目录后即可卸载
$ cd ~
$ umount /mnt/usb  # 成功卸载
```

---

## 4. 🌐 网络连接文件描述符


### 4.1 查看所有网络连接


**基础网络查看**：
```bash
# 查看所有网络连接
lsof -i

# 输出示例：
COMMAND  PID  USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
sshd    1234  root    3u  IPv4  12345      0t0  TCP *:22 (LISTEN)
chrome  5678  zhang   8u  IPv4  23456      0t0  TCP 192.168.1.100:45678->142.250.191.14:443 (ESTABLISHED)
nginx   9999  www     6u  IPv4  34567      0t0  TCP *:80 (LISTEN)
```

**网络连接状态含义**：
```
┌─ 网络连接状态说明 ─────────────────┐
│ LISTEN: 监听状态，等待连接         │
│ ESTABLISHED: 已建立连接            │
│ TIME_WAIT: 连接关闭中             │
│ CLOSE_WAIT: 等待关闭              │
│ *:22: 监听所有网卡的22端口        │
│ IP:PORT->IP:PORT: 具体连接详情    │
└────────────────────────────────────┘
```

### 4.2 按端口和协议筛选


```bash
# 查看80端口被谁占用
lsof -i :80

# 查看特定IP和端口
lsof -i @192.168.1.100:8080

# 查看TCP连接
lsof -i TCP

# 查看UDP连接  
lsof -i UDP

# 查看监听状态的端口
lsof -i -sTCP:LISTEN
```

**实用组合查询**：
```bash
# 查看所有ESTABLISHED状态的连接
lsof -i -sTCP:ESTABLISHED

# 查看哪个进程在监听3306端口（MySQL默认端口）
lsof -i :3306

# 查看某个IP的所有连接
lsof -i @192.168.1.100
```

### 4.3 网络故障排查实例


**场景1：端口被占用**
```bash
# 启动服务时提示端口被占用
$ python -m http.server 8000
OSError: [Errno 98] Address already in use

# 找出占用8000端口的进程
$ lsof -i :8000
COMMAND  PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
python  1234  zhang   3u  IPv4  12345      0t0  TCP *:8000 (LISTEN)

# 杀掉占用进程
$ kill 1234
```

**场景2：查看可疑网络连接**
```bash
# 检查是否有异常的对外连接
lsof -i -sTCP:ESTABLISHED | grep -v ":80\|:443\|:22"
```

---

## 5. 🖥️ 设备文件占用分析


### 5.1 查看设备文件占用


**Linux设备文件概念**：
```
/dev/sda1  # 硬盘分区
/dev/tty1  # 终端设备
/dev/null  # 空设备
/dev/random # 随机数设备
```

```bash
# 查看硬盘设备被谁使用
lsof /dev/sda1

# 查看所有设备文件占用
lsof /dev/*

# 查看USB设备
lsof /dev/sd*
```

### 5.2 终端和控制台占用


```bash
# 查看当前终端被谁占用
lsof /dev/pts/0

# 查看所有终端占用情况
lsof /dev/pts/*

# 查看控制台占用
lsof /dev/console
```

**实际应用**：
```bash
# 找出谁在使用音频设备
lsof /dev/snd/*

# 查看摄像头占用
lsof /dev/video0
```

---

## 6. 🗑️ 删除文件恢复追踪


### 6.1 已删除文件的占用追踪


**重要概念**：在Linux中，文件被删除后，如果还有进程在使用它，文件内容仍然存在，只是看不见了。

```bash
# 查看已删除但仍被占用的文件
lsof | grep "(deleted)"

# 输出示例：
COMMAND  PID  USER  FD   TYPE DEVICE SIZE/OFF   NODE NAME
apache  1234  www   2w   REG    8,1  1048576  12345 /var/log/access.log (deleted)
```

**文件恢复方法**：
```bash
# 通过/proc文件系统恢复删除的文件
cp /proc/1234/fd/2 /var/log/access.log.recovered

# 或者让进程重新打开文件
kill -HUP 1234  # 发送重新加载信号
```

### 6.2 磁盘空间异常排查


**场景**：删除了大文件但磁盘空间没释放。

```bash
# 找出占用已删除文件的进程
lsof | grep "(deleted)" | awk '{print $2}' | sort -u

# 查看具体占用情况
lsof +L1  # 显示link count为0的文件（已删除但被占用）
```

**解决步骤**：
```bash
# 1. 找出占用删除文件的进程
lsof | grep "(deleted)"

# 2. 重启相关服务释放文件句柄
systemctl restart apache2

# 3. 或者强制杀掉进程
kill -9 PID
```

---

## 7. 📊 系统资源占用诊断


### 7.1 文件句柄使用统计


```bash
# 统计系统总的文件句柄使用情况
lsof | wc -l

# 按进程统计文件句柄数量
lsof | awk '{print $2}' | sort | uniq -c | sort -rn | head -10

# 输出示例：
#   125 1234  # 进程1234打开了125个文件
#    89 5678  # 进程5678打开了89个文件
```

### 7.2 系统资源占用TOP排名


```bash
# 查看打开文件最多的进程
lsof | awk '{print $1, $2}' | sort | uniq -c | sort -rn | head -10

# 查看哪个用户打开文件最多
lsof | awk '{print $3}' | sort | uniq -c | sort -rn | head -10
```

### 7.3 监控脚本示例


```bash
#!/bin/bash
# 文件句柄监控脚本

echo "=== 系统文件句柄使用情况 ==="
echo "总文件句柄数: $(lsof | wc -l)"
echo ""

echo "=== TOP 5 进程文件句柄使用 ==="
lsof | awk '{print $1, $2}' | sort | uniq -c | sort -rn | head -5
echo ""

echo "=== 已删除但仍被占用的文件 ==="
lsof | grep "(deleted)" | wc -l
echo "个文件"
```

---

## 8. 🔗 进程文件依赖分析


### 8.1 分析程序文件依赖


```bash
# 查看程序的完整文件依赖
lsof -p $(pidof nginx) | grep REG

# 只看程序加载的库文件
lsof -p $(pidof nginx) | grep "\.so"

# 查看程序的配置文件访问
lsof -p $(pidof nginx) | grep "\.conf"
```

### 8.2 服务启动依赖检查


```bash
# 检查MySQL服务的文件依赖
lsof -c mysqld | grep -E "\.(cnf|log|pid|sock)$"

# 检查Web服务的依赖文件
lsof -c apache2 | grep -E "\.(conf|log|pid)$"
```

### 8.3 共享文件分析


```bash
# 找出被多个进程共享的文件
lsof | awk '{print $NF}' | sort | uniq -c | sort -rn | head -10

# 查看共享库被多少进程使用
lsof /lib/x86_64-linux-gnu/libc.so.6
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 lsof本质：列出系统中所有打开的文件及其占用进程
🔸 核心用途：故障排查、资源监控、安全分析、性能诊断
🔸 查询方式：按进程(-p)、按程序(-c)、按用户(-u)、按文件
🔸 网络功能：查看端口占用(-i)、连接状态分析
🔸 特殊功能：已删除文件追踪、设备占用分析
```

### 9.2 常用命令速记


```
🎯 日常最常用：
lsof -i :端口号          # 查端口占用
lsof -p 进程ID          # 查进程打开的文件  
lsof 文件路径           # 查文件被谁占用
lsof | grep deleted    # 查已删除但被占用文件

🔧 故障排查：
lsof +D /挂载点         # 查挂载点占用
lsof -c 程序名          # 查程序文件依赖
lsof -u 用户名          # 查用户文件占用
lsof -i -sTCP:LISTEN   # 查监听端口
```

### 9.3 实际应用场景总结


**🔹 系统维护场景**：
- 磁盘卸载不了 → `lsof +D /mount/point`
- 端口被占用 → `lsof -i :port`
- 文件删不掉 → `lsof filename`
- 磁盘空间异常 → `lsof | grep deleted`

**🔹 性能分析场景**：
- 进程资源占用 → `lsof -p PID`
- 系统文件句柄统计 → `lsof | wc -l`
- 用户资源使用 → `lsof -u username`

**🔹 安全监控场景**：
- 异常网络连接 → `lsof -i`
- 可疑文件访问 → `lsof +D /sensitive/dir`
- 进程行为分析 → `lsof -c suspicious_process`

### 9.4 学习进阶建议


```
📚 基础掌握：
☐ 理解lsof输出格式含义
☐ 掌握基本选项使用(-p, -c, -u, -i)
☐ 熟练进行文件占用查询

🔧 进阶应用：
☐ 结合其他命令进行复杂查询
☐ 编写监控脚本定期检查
☐ 理解文件描述符和句柄概念

🎯 实战技能：
☐ 快速定位系统资源占用问题
☐ 进行网络连接安全分析  
☐ 掌握文件恢复和故障排查
```

**🔑 记忆口诀**：
- lsof万能查，进程文件网络全不怕
- 端口占用看-i，进程文件用-p查  
- 删除文件grep deleted，挂载占用+D搞定它
- 系统维护必备工具，故障排查第一法