---
title: 2、物理卷PV管理操作
---
## 📚 目录

1. [物理卷基础概念](#1-物理卷基础概念)
2. [创建物理卷pvcreate](#2-创建物理卷pvcreate)
3. [查看物理卷信息](#3-查看物理卷信息)
4. [物理卷数据迁移pvmove](#4-物理卷数据迁移pvmove)
5. [删除物理卷pvremove](#5-删除物理卷pvremove)
6. [物理卷扩展与收缩](#6-物理卷扩展与收缩)
7. [物理卷标签管理](#7-物理卷标签管理)
8. [损坏物理卷恢复](#8-损坏物理卷恢复)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 💽 物理卷基础概念


### 1.1 什么是物理卷（PV）


**简单理解**：物理卷就是LVM系统的"原材料"，把硬盘或分区变成LVM能识别和管理的基本单元。

```
普通磁盘使用：
硬盘 → 分区 → 格式化 → 挂载使用

LVM磁盘使用：
硬盘 → 分区 → 创建PV → 加入VG → 创建LV → 格式化 → 挂载使用
       ↑
    物理卷就在这一步
```

**🔸 核心作用**：
- **标识作用**：告诉系统这个设备属于LVM管理
- **元数据存储**：记录PV的基本信息和所属卷组
- **空间管理**：将物理存储空间按PE（物理扩展）单元管理

### 1.2 物理卷的组成结构


```
物理卷内部结构：
┌─────────────────────────┐
│  LVM标签区域 (Label)     │ ← 标识这是LVM设备
├─────────────────────────┤
│  元数据区域 (Metadata)   │ ← 存储PV配置信息
├─────────────────────────┤
│  数据区域 (Data Area)    │ ← 实际存储数据的地方
│  ┌─────┬─────┬─────┐    │
│  │ PE1 │ PE2 │ PE3 │... │ ← 按PE单元划分
│  └─────┴─────┴─────┘    │
└─────────────────────────┘
```

**关键概念解释**：
- **PE（Physical Extent）**：物理扩展单元，默认4MB大小
- **元数据**：记录PV属性、所属VG、PE使用情况等
- **标签**：LVM的身份证，标识这是LVM管理的设备

### 1.3 支持的设备类型


**🔸 可以创建PV的设备**：
```
✅ 整个磁盘：/dev/sdb
✅ 磁盘分区：/dev/sdb1, /dev/sdc2
✅ RAID设备：/dev/md0
✅ 环回设备：/dev/loop0
✅ SSD设备：/dev/nvme0n1p1
```

**🔸 实际使用建议**：
- **推荐**：使用整个磁盘创建PV（/dev/sdb）
- **可用**：使用分区创建PV（/dev/sdb1）
- **注意**：不要在系统盘上创建PV

---

## 2. 🔧 创建物理卷pvcreate


### 2.1 基本创建语法


```bash
# 基本语法
pvcreate [选项] 设备名

# 最简单用法
pvcreate /dev/sdb
```

**🔸 创建前的准备工作**：
```bash
# 1. 查看可用磁盘
lsblk
fdisk -l

# 2. 确认磁盘未被使用
mount | grep sdb    # 确认没有挂载
swap -s             # 确认没有作为交换分区
```

### 2.2 单个设备创建示例


```bash
# 创建单个物理卷
pvcreate /dev/sdb

# 输出信息解读
Physical volume "/dev/sdb" successfully created.
```

**🔸 创建过程详解**：
1. **检查设备**：确认设备存在且可用
2. **写入标签**：在设备开始位置写入LVM标签
3. **初始化元数据**：创建PV的配置信息
4. **建立PE映射**：将设备空间按PE单元划分

### 2.3 批量创建物理卷


```bash
# 一次创建多个PV
pvcreate /dev/sdb /dev/sdc /dev/sdd

# 输出示例
Physical volume "/dev/sdb" successfully created.
Physical volume "/dev/sdc" successfully created.
Physical volume "/dev/sdd" successfully created.
```

### 2.4 高级创建选项


```bash
# 自定义PE大小（默认4MB）
pvcreate --dataalignment 1m /dev/sdb

# 强制创建（覆盖现有签名）
pvcreate --force /dev/sdb

# 指定元数据大小
pvcreate --metadatasize 128k /dev/sdb

# 详细输出
pvcreate --verbose /dev/sdb
```

**🔸 常用选项说明**：
- `--force`：强制创建，会清除现有文件系统签名
- `--dataalignment`：数据对齐，优化SSD性能
- `--verbose`：显示详细创建过程

### 2.5 创建前的安全检查


```bash
# 完整的安全创建流程
#!/bin/bash
DEVICE="/dev/sdb"

# 检查设备是否存在
if [ ! -b "$DEVICE" ]; then
    echo "设备 $DEVICE 不存在"
    exit 1
fi

# 检查是否已经是PV
if pvdisplay "$DEVICE" >/dev/null 2>&1; then
    echo "$DEVICE 已经是物理卷"
    exit 1
fi

# 检查是否有文件系统
if blkid "$DEVICE" >/dev/null 2>&1; then
    echo "警告：$DEVICE 上存在文件系统"
    echo "确认要继续吗？(y/N)"
    read -r confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# 创建PV
pvcreate "$DEVICE"
```

---

## 3. 🔍 查看物理卷信息


### 3.1 pvdisplay详细信息查看


```bash
# 查看所有PV的详细信息
pvdisplay

# 查看特定PV
pvdisplay /dev/sdb
```

**🔸 输出信息解读**：
```bash
--- Physical volume ---
PV Name               /dev/sdb          # PV设备名
VG Name               vg01              # 所属卷组名
PV Size               20.00 GiB         # PV总大小
Allocatable           yes               # 是否可分配
PE Size               4.00 MiB          # PE单元大小
Total PE              5119              # 总PE数量
Free PE               2559              # 剩余PE数量
Allocated PE          2560              # 已使用PE数量
PV UUID               abc123-def456...   # PV唯一标识
```

### 3.2 pvs简洁信息查看


```bash
# 简洁格式查看所有PV
pvs

# 自定义显示字段
pvs -o pv_name,pv_size,pv_free,vg_name

# 以MB为单位显示
pvs --units m
```

**🔸 输出示例**：
```bash
  PV         VG   Fmt  Attr PSize  PFree
  /dev/sdb   vg01 lvm2 a--  20.00g  10.00g
  /dev/sdc   vg01 lvm2 a--  30.00g  30.00g
  /dev/sdd        lvm2 ---  15.00g  15.00g
```

**字段含义**：
- **Attr**：属性标志（a=allocatable可分配）
- **PSize**：物理卷总大小
- **PFree**：剩余可用空间

### 3.3 pvscan扫描物理卷


```bash
# 扫描系统中所有PV
pvscan

# 详细扫描输出
pvscan -v

# 扫描并缓存
pvscan --cache
```

**🔸 实际应用场景**：
- **系统启动后**：重新扫描识别PV
- **热插拔后**：发现新添加的磁盘
- **故障恢复后**：重新识别修复的设备

### 3.4 查看PE使用情况


```bash
# 查看PE详细分布
pvdisplay -m /dev/sdb

# 查看所有PV的PE统计
pvs -o +pv_pe_count,pv_pe_alloc_count
```

**🔸 PE分布示例**：
```bash
--- Physical Segments ---
Physical extent 0 to 1279:
  Logical volume      /dev/vg01/lv_data
  Logical extent      0 to 1279
Physical extent 1280 to 2559:
  FREE               # 未使用的PE
```

---

## 4. 🚚 物理卷数据迁移pvmove


### 4.1 pvmove基本概念


**简单理解**：pvmove就是把一个物理卷上的数据"搬家"到其他物理卷上，就像整理房间时把东西从一个柜子移到另一个柜子。

**🔸 使用场景**：
- 磁盘即将故障，需要迁移数据
- 更换更大容量的磁盘
- 重新规划存储布局
- 维护前的预防性迁移

### 4.2 数据迁移操作


```bash
# 基本迁移语法
pvmove 源PV [目标PV]

# 将/dev/sdb上的所有数据迁移到其他PV
pvmove /dev/sdb

# 将数据迁移到指定PV
pvmove /dev/sdb /dev/sdc

# 只迁移特定LV的数据
pvmove -n lv_data /dev/sdb /dev/sdc
```

### 4.3 迁移过程监控


```bash
# 查看迁移进度
pvmove

# 实时监控迁移状态
watch -n 2 'pvmove'

# 查看详细进度
pvs -o +pv_move_pv,move_pv
```

**🔸 迁移过程示例**：
```bash
/dev/sdb: Moved: 15.2%
/dev/sdb: Moved: 32.8%
/dev/sdb: Moved: 67.4%
/dev/sdb: Moved: 100.0%
```

### 4.4 中止和恢复迁移


```bash
# 中止正在进行的迁移（数据会回滚）
pvmove --abort /dev/sdb

# 如果迁移中断，恢复迁移
pvmove --resume
```

**⚠️ 重要注意事项**：
- 迁移过程中不要断电或强制停止
- 确保目标PV有足够的空闲空间
- 迁移期间IO性能会受影响
- 建议在业务低峰期进行

### 4.5 迁移脚本示例


```bash
#!/bin/bash
# 安全的PV数据迁移脚本

SOURCE_PV="/dev/sdb"
TARGET_PV="/dev/sdc"

# 检查源PV状态
if ! pvdisplay "$SOURCE_PV" >/dev/null 2>&1; then
    echo "错误：源PV $SOURCE_PV 不存在"
    exit 1
fi

# 检查目标PV空间
SOURCE_USED=$(pvs --noheadings --units b -o pv_used "$SOURCE_PV" | tr -d ' ')
TARGET_FREE=$(pvs --noheadings --units b -o pv_free "$TARGET_PV" | tr -d ' ')

if [ "$SOURCE_USED" -gt "$TARGET_FREE" ]; then
    echo "错误：目标PV空间不足"
    exit 1
fi

# 开始迁移
echo "开始迁移 $SOURCE_PV 到 $TARGET_PV..."
pvmove "$SOURCE_PV" "$TARGET_PV"

if [ $? -eq 0 ]; then
    echo "迁移完成！"
else
    echo "迁移失败！"
    exit 1
fi
```

---

## 5. 🗑️ 删除物理卷pvremove


### 5.1 删除前的准备工作


**🔸 删除前必须满足的条件**：
- PV上没有分配的PE（即没有存储任何LV数据）
- PV不属于任何卷组，或已从卷组中移除
- 确认数据已经备份或迁移

```bash
# 检查PV状态
pvdisplay /dev/sdb

# 查看PE使用情况
pvs -o pv_name,pv_used,pv_free /dev/sdb

# 确认PV不属于VG
pvs -o pv_name,vg_name /dev/sdb
```

### 5.2 从卷组中移除PV


```bash
# 如果PV属于某个VG，先移除
vgreduce vg01 /dev/sdb

# 如果PV上有数据，先迁移再移除
pvmove /dev/sdb
vgreduce vg01 /dev/sdb
```

### 5.3 删除物理卷


```bash
# 删除PV
pvremove /dev/sdb

# 强制删除（跳过一些安全检查）
pvremove --force /dev/sdb

# 删除多个PV
pvremove /dev/sdb /dev/sdc
```

**🔸 删除成功输出**：
```bash
Labels on physical volume "/dev/sdb" successfully wiped.
```

### 5.4 完整的安全删除流程


```bash
#!/bin/bash
# 安全删除PV的完整流程

PV_DEVICE="/dev/sdb"

echo "准备删除物理卷: $PV_DEVICE"

# 1. 检查PV是否存在
if ! pvdisplay "$PV_DEVICE" >/dev/null 2>&1; then
    echo "错误：$PV_DEVICE 不是物理卷"
    exit 1
fi

# 2. 检查PV是否有数据
PV_USED=$(pvs --noheadings -o pv_used "$PV_DEVICE" | tr -d ' ')
if [[ "$PV_USED" != "0" ]]; then
    echo "警告：PV上还有数据未迁移"
    echo "是否要先迁移数据？(y/N)"
    read -r migrate
    if [[ "$migrate" =~ ^[Yy]$ ]]; then
        pvmove "$PV_DEVICE"
    else
        echo "取消删除操作"
        exit 1
    fi
fi

# 3. 从VG中移除
VG_NAME=$(pvs --noheadings -o vg_name "$PV_DEVICE" | tr -d ' ')
if [[ "$VG_NAME" != "" ]]; then
    echo "从卷组 $VG_NAME 中移除PV..."
    vgreduce "$VG_NAME" "$PV_DEVICE"
fi

# 4. 删除PV
echo "删除物理卷..."
pvremove "$PV_DEVICE"

echo "物理卷 $PV_DEVICE 删除完成！"
```

---

## 6. 📏 物理卷扩展与收缩


### 6.1 物理卷扩展概念


**简单理解**：当磁盘分区扩大后，需要让PV识别新的空间，就像房子扩建后需要重新丈量面积。

**🔸 扩展场景**：
- 磁盘分区大小增加了
- 更换了更大容量的磁盘
- 虚拟机磁盘扩容了

### 6.2 扩展磁盘分区


```bash
# 1. 查看当前磁盘情况
fdisk -l /dev/sdb
parted /dev/sdb print

# 2. 扩展分区（以parted为例）
parted /dev/sdb
(parted) resizepart 1 100%    # 将分区1扩展到磁盘全部空间
(parted) quit

# 3. 通知内核重新读取分区表
partprobe /dev/sdb
```

### 6.3 扩展物理卷


```bash
# 扩展PV以识别新空间
pvresize /dev/sdb1

# 查看扩展结果
pvdisplay /dev/sdb1
pvs -o pv_name,pv_size
```

**🔸 扩展过程示例**：
```bash
# 扩展前
pvs /dev/sdb1
  PV         VG   Fmt  Attr PSize  PFree
  /dev/sdb1  vg01 lvm2 a--  10.00g 2.00g

# 执行扩展
pvresize /dev/sdb1
Physical volume "/dev/sdb1" changed

# 扩展后
pvs /dev/sdb1
  PV         VG   Fmt  Attr PSize  PFree
  /dev/sdb1  vg01 lvm2 a--  20.00g 12.00g
```

### 6.4 物理卷收缩


**⚠️ 重要提醒**：PV收缩比较危险，通常不推荐。如果必须收缩，需要确保收缩后的空间足够容纳所有已使用的PE。

```bash
# 查看PV使用情况
pvdisplay -m /dev/sdb1

# 如果需要收缩，先迁移数据到安全区域
pvmove --alloc anywhere /dev/sdb1

# 收缩PV（指定新大小）
pvresize --setphysicalvolumesize 15G /dev/sdb1
```

### 6.5 自动扩展脚本


```bash
#!/bin/bash
# 自动扩展PV脚本

PV_DEVICE="/dev/sdb1"

echo "开始扩展物理卷: $PV_DEVICE"

# 1. 记录扩展前大小
OLD_SIZE=$(pvs --noheadings --units g -o pv_size "$PV_DEVICE" | tr -d ' ')
echo "扩展前大小: $OLD_SIZE"

# 2. 重新扫描分区表
partprobe "${PV_DEVICE%[0-9]}"

# 3. 扩展PV
pvresize "$PV_DEVICE"

# 4. 检查扩展结果
NEW_SIZE=$(pvs --noheadings --units g -o pv_size "$PV_DEVICE" | tr -d ' ')
echo "扩展后大小: $NEW_SIZE"

if [[ "$NEW_SIZE" != "$OLD_SIZE" ]]; then
    echo "PV扩展成功！"
else
    echo "PV大小没有变化，可能不需要扩展"
fi
```

---

## 7. 🏷️ 物理卷标签管理


### 7.1 LVM标签的作用


**简单理解**：LVM标签就像给磁盘贴了个"身份证"，告诉系统这个设备属于LVM管理。

**🔸 标签包含的信息**：
- 设备是LVM物理卷
- PV的UUID（唯一标识）
- 创建时间戳
- LVM版本信息

### 7.2 查看标签信息


```bash
# 使用blkid查看设备标签
blkid /dev/sdb1

# 输出示例
/dev/sdb1: UUID="abc123-def456-ghi789" TYPE="LVM2_member"

# 使用file命令查看
file -s /dev/sdb1

# LVM专用命令查看
pvdisplay -C -o pv_name,pv_uuid /dev/sdb1
```

### 7.3 重建损坏的标签


```bash
# 如果PV标签损坏，可以尝试重建
pvcreate --restorefile /etc/lvm/backup/vg01 --uuid "原始UUID" /dev/sdb1

# 或者从配置备份恢复
vgcfgrestore vg01
```

### 7.4 标签位置管理


```bash
# 查看LVM配置中的标签设置
grep -i label /etc/lvm/lvm.conf

# 重要配置项
pvmetadatacopies = 1        # 元数据副本数
metadatasize = 1024         # 元数据区域大小(KB)
```

---

## 8. 🛠️ 损坏物理卷恢复


### 8.1 常见PV故障类型


**🔸 故障类型及症状**：
```
标签损坏：
- pvs命令看不到PV
- blkid显示unknown类型

元数据损坏：
- PV能识别但信息错误
- VG激活失败

部分扇区损坏：
- 读写特定区域出错
- PV状态显示异常
```

### 8.2 故障诊断步骤


```bash
# 1. 基本检查
pvs -v                    # 详细扫描PV
vgs -v                    # 检查VG状态
dmesg | grep -i error     # 查看内核错误信息

# 2. 磁盘健康检查
smartctl -a /dev/sdb      # 硬盘SMART信息
badblocks -sv /dev/sdb1   # 坏道检测

# 3. LVM一致性检查
vgck vg01                 # 检查VG一致性
```

### 8.3 元数据备份与恢复


**🔸 自动备份位置**：
```bash
# LVM自动备份位置
/etc/lvm/backup/          # VG元数据备份
/etc/lvm/archive/         # 历史配置存档
```

**🔸 手动备份操作**：
```bash
# 备份VG配置
vgcfgbackup vg01

# 显示备份文件内容
cat /etc/lvm/backup/vg01

# 恢复VG配置
vgcfgrestore -f /etc/lvm/backup/vg01 vg01
```

### 8.4 PV标签重建


```bash
#!/bin/bash
# PV标签重建脚本

DEVICE="/dev/sdb1"
VG_NAME="vg01"

echo "重建PV标签: $DEVICE"

# 1. 尝试从备份恢复
if [ -f "/etc/lvm/backup/$VG_NAME" ]; then
    echo "从备份恢复..."
    vgcfgrestore -f "/etc/lvm/backup/$VG_NAME" "$VG_NAME"
    
    # 重新扫描
    pvscan --cache
    vgscan --mknodes
    
    if pvs "$DEVICE" >/dev/null 2>&1; then
        echo "恢复成功！"
        exit 0
    fi
fi

# 2. 手动重建标签
echo "手动重建标签..."
echo "警告：这将清除设备上的现有标签"
read -p "确认继续？(y/N): " confirm

if [[ "$confirm" =~ ^[Yy]$ ]]; then
    pvcreate --force "$DEVICE"
    echo "请手动将PV加入到VG中："
    echo "vgextend $VG_NAME $DEVICE"
fi
```

### 8.5 数据恢复最佳实践


**🔸 恢复原则**：
1. **停止写入**：发现问题立即停止对相关设备的写入
2. **评估损坏程度**：确定是标签损坏还是数据损坏
3. **优先使用备份**：LVM自动备份通常能解决大部分问题
4. **渐进式恢复**：从安全的操作开始，逐步尝试

**🔸 预防措施**：
```bash
# 定期备份LVM配置
vgcfgbackup

# 监控磁盘健康状态
smartctl -a /dev/sdb

# 保留多个元数据副本
# 编辑/etc/lvm/lvm.conf
pvmetadatacopies = 2
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的基本概念

```
🔸 物理卷本质：将普通磁盘转换为LVM管理的基本单元
🔸 PV组成结构：标签区 + 元数据区 + 数据区（PE单元）
🔸 核心命令：pvcreate创建、pvdisplay查看、pvremove删除
🔸 数据迁移：pvmove实现PV间数据搬迁
🔸 扩展收缩：pvresize调整PV大小
🔸 故障恢复：基于LVM自动备份进行元数据恢复
```

### 9.2 关键操作流程


**🔹 创建PV标准流程**：
```
1. 磁盘准备 → 确认设备可用，无重要数据
2. 安全检查 → 检查挂载状态，文件系统类型
3. 创建PV → pvcreate /dev/sdb
4. 验证结果 → pvdisplay确认创建成功
```

**🔹 数据迁移标准流程**：
```
1. 评估空间 → 确认目标PV有足够空间
2. 开始迁移 → pvmove源PV目标PV
3. 监控进度 → 实时查看迁移状态
4. 验证结果 → 确认数据完整迁移
```

**🔹 故障恢复标准流程**：
```
1. 问题诊断 → 确定故障类型和影响范围
2. 停止写入 → 防止进一步损坏
3. 备份恢复 → 优先使用LVM自动备份
4. 验证修复 → 确认PV功能正常
```

### 9.3 实际应用价值


**🎯 运维场景应用**：
- **容量规划**：通过PV扩展应对存储增长需求
- **设备更换**：用pvmove实现无停机数据迁移
- **故障处理**：快速恢复损坏的PV标签和元数据
- **性能优化**：合理配置PE大小和数据对齐

**🔧 最佳实践要点**：
- **创建前检查**：确认设备状态，避免误操作
- **定期备份**：保持LVM配置备份的及时性
- **监控磁盘健康**：预防性发现和处理潜在问题
- **文档记录**：详细记录PV配置和变更历史

**核心记忆口诀**：
- 物理卷是LVM基石，标签元数据要记清
- 创建查看删除移，安全检查不可忘  
- 数据迁移用pvmove，扩展空间靠resize
- 故障恢复有备份，标签重建能救急