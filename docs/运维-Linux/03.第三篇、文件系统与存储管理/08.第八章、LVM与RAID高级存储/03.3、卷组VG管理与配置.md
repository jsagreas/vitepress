---
title: 3、卷组VG管理与配置
---
## 📚 目录

1. [卷组VG基础概念](#1-卷组VG基础概念)
2. [创建卷组vgcreate](#2-创建卷组vgcreate)
3. [查看卷组状态](#3-查看卷组状态)
4. [扩展与收缩卷组](#4-扩展与收缩卷组)
5. [卷组激活管理](#5-卷组激活管理)
6. [卷组导入导出](#6-卷组导入导出)
7. [卷组备份恢复](#7-卷组备份恢复)
8. [删除卷组操作](#8-删除卷组操作)
9. [实战案例演练](#9-实战案例演练)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🗂️ 卷组VG基础概念


### 1.1 什么是卷组VG


**💡 通俗理解**：
卷组（Volume Group，VG）就像一个**大型存储池子**，你可以把多个物理磁盘丢进这个池子里，然后从池子里随意舀出存储空间来使用。

```
现实类比：
┌─────────────────────────────────────┐
│            存储资源池               │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐   │
│  │磁盘1│ │磁盘2│ │磁盘3│ │磁盘4│   │ ← 物理卷PV
│  └─────┘ └─────┘ └─────┘ └─────┘   │
│                                     │
│ 统一管理的存储空间池 = 卷组VG       │
└─────────────────────────────────────┘
           ↓ 从池子里分配
    ┌─────────┐ ┌─────────┐
    │逻辑卷LV1│ │逻辑卷LV2│ ← 实际使用的分区
    └─────────┘ └─────────┘
```

**🔸 核心作用**：
- **统一管理**：把多个物理磁盘当作一个整体来管理
- **灵活分配**：可以随时调整存储空间的分配
- **动态扩展**：需要更多空间时直接加硬盘进池子
- **简化操作**：不用关心具体是哪块硬盘，只管总容量

### 1.2 卷组在LVM中的位置


```
LVM存储架构图：
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  物理磁盘    │    │   物理卷PV   │    │   卷组VG     │
│ /dev/sdb     │───▶│   /dev/sdb   │───▶│              │
│ /dev/sdc     │    │   /dev/sdc   │    │  myvg01      │
│ /dev/sdd     │    │   /dev/sdd   │    │              │
└──────────────┘    └──────────────┘    └──────────────┘
                                                ▼
                                        ┌──────────────┐
                                        │   逻辑卷LV   │
                                        │  /dev/myvg01/│
                                        │    lv_root   │
                                        │    lv_home   │
                                        └──────────────┘
```

### 1.3 卷组的基本特性


| 特性 | 说明 | 实际意义 |
|------|------|----------|
| **动态扩展** | `随时添加新磁盘` | 存储空间不够时无需重装系统 |
| **统一命名** | `所有LV都在VG命名空间下` | 便于管理和识别 |
| **空间池化** | `多个PV的空间合并使用` | 避免单个磁盘容量限制 |
| **故障隔离** | `一个PV故障不影响整个VG` | 提高系统可靠性 |

---

## 2. 🛠️ 创建卷组vgcreate


### 2.1 基本创建语法


```bash
# 基础语法
vgcreate [选项] 卷组名 物理卷1 [物理卷2 ...]

# 最简单的创建方式
vgcreate myvg /dev/sdb /dev/sdc
```

**💡 命令解析**：
- `myvg` - 卷组的名字，就像给存储池起个名字
- `/dev/sdb /dev/sdc` - 要放入池子的物理磁盘（必须先做成PV）

### 2.2 创建前的准备工作


**🔸 步骤1：确认磁盘状态**
```bash
# 查看可用的磁盘
lsblk
# 输出示例：
# sdb    8:16   0   20G  0 disk
# sdc    8:32   0   30G  0 disk
```

**🔸 步骤2：创建物理卷**
```bash
# 将磁盘转换为LVM物理卷
pvcreate /dev/sdb /dev/sdc
# 输出：Physical volume "/dev/sdb" successfully created
```

**🔸 步骤3：验证物理卷**
```bash
# 确认PV创建成功
pvs
# 输出示例：
# PV         VG   Fmt  Attr PSize  PFree
# /dev/sdb        lvm2 ---  20.00g 20.00g
# /dev/sdc        lvm2 ---  30.00g 30.00g
```

### 2.3 实际创建操作


```bash
# 创建名为webdata的卷组
vgcreate webdata /dev/sdb /dev/sdc

# 成功输出：
# Volume group "webdata" successfully created
```

**🎯 创建成功标志**：
- 系统提示创建成功
- 在`/dev/`下生成对应目录
- `vgs`命令能看到新卷组

### 2.4 高级创建选项


```bash
# 指定PE大小（默认4MB）
vgcreate -s 8M bigdata /dev/sdb /dev/sdc

# 指定最大逻辑卷数量
vgcreate -l 100 webdata /dev/sdb

# 指定最大物理卷数量
vgcreate -p 10 dbdata /dev/sdb /dev/sdc
```

**📋 常用选项说明**：

| 选项 | 含义 | 使用场景 |
|------|------|----------|
| `-s size` | `设置PE大小` | 大文件系统使用大PE提高效率 |
| `-l number` | `最大LV数量` | 限制逻辑卷创建数量 |
| `-p number` | `最大PV数量` | 限制物理卷添加数量 |

💡 **新手建议**：刚开始学习时使用默认设置即可，高级选项在有特殊需求时再使用。

---

## 3. 📊 查看卷组状态


### 3.1 快速查看命令vgs


```bash
# 简洁查看所有卷组
vgs

# 输出示例：
#   VG      #PV #LV #SN Attr   VSize  VFree
#   webdata   2   0   0 wz--n- 49.99g 49.99g
```

**📋 输出含义解释**：
- `VG` - 卷组名称
- `#PV` - 包含的物理卷数量（这里是2个）
- `#LV` - 包含的逻辑卷数量（这里是0个，还没创建）
- `#SN` - 快照数量
- `Attr` - 属性标志
- `VSize` - 总大小（约50GB）
- `VFree` - 可用空间（还没使用所以全部可用）

### 3.2 详细信息查看vgdisplay


```bash
# 查看详细信息
vgdisplay webdata

# 输出示例：
--- Volume group ---
VG Name               webdata
System ID             
Format                lvm2
Metadata Areas        2
Metadata Sequence No  1
VG Access             read/write
VG Status             resizable
MAX LV                0
Cur LV                0
Open LV               0
Max PV                0
Cur PV                2
Act PV                2
VG Size               49.99 GiB
PE Size               4.00 MiB
Total PE              12798
Alloc PE / Size       0 / 0
Free  PE / Size       12798 / 49.99 GiB
VG UUID               abc123-def4-5678-90ab-cdef12345678
```

**🔍 关键信息解读**：

| 字段 | 含义 | 新手重点关注 |
|------|------|-------------|
| `VG Name` | `卷组名称` | ✅ 确认操作的是正确卷组 |
| `VG Size` | `总容量` | ✅ 了解可用总空间 |
| `Free PE / Size` | `剩余空间` | ✅ 创建LV前必看 |
| `Cur PV` | `当前PV数量` | ✅ 确认包含的磁盘数 |
| `PE Size` | `基本单位大小` | 了解即可，一般是4MB |

### 3.3 查看卷组中的物理卷


```bash
# 查看卷组包含哪些物理卷
vgdisplay -v webdata | grep "PV Name"

# 或者更直观的方式
pvs | grep webdata
```

---

## 4. 📈 扩展与收缩卷组


### 4.1 扩展卷组vgextend


**💡 使用场景**：当存储空间不够用时，添加新硬盘到现有卷组

```bash
# 准备新的物理卷
pvcreate /dev/sdd

# 将新PV添加到现有卷组
vgextend webdata /dev/sdd

# 成功输出：
# Volume group "webdata" successfully extended
```

**🔸 扩展前后对比**：
```bash
# 扩展前
vgs webdata
# VG      #PV #LV #SN Attr   VSize  VFree
# webdata   2   0   0 wz--n- 49.99g 49.99g

# 扩展后（假设/dev/sdd是40GB）
vgs webdata  
# VG      #PV #LV #SN Attr   VSize  VFree
# webdata   3   0   0 wz--n- 89.99g 89.99g
```

### 4.2 收缩卷组vgreduce


**⚠️ 重要提醒**：收缩卷组前必须确保要移除的PV上没有数据！

```bash
# 第一步：将数据从指定PV移走（如果有数据）
pvmove /dev/sdd

# 第二步：从卷组中移除PV
vgreduce webdata /dev/sdd

# 成功输出：
# Removed "/dev/sdd" from volume group "webdata"
```

**🔸 安全收缩流程**：

```
1. 检查PV使用情况
   ├── pvs 查看哪些PV有数据
   └── pvdisplay 查看详细使用情况

2. 数据迁移（如果需要）
   ├── pvmove 移动数据到其他PV
   └── 等待迁移完成

3. 执行收缩
   ├── vgreduce 从VG中移除PV  
   └── pvremove 彻底移除PV标识
```

### 4.3 实战演示


```bash
# 查看当前状态
echo "=== 扩展前状态 ==="
vgs webdata

# 准备新磁盘
echo "=== 准备新物理卷 ==="
pvcreate /dev/sde
pvs /dev/sde

# 执行扩展
echo "=== 扩展卷组 ==="
vgextend webdata /dev/sde

# 确认扩展结果
echo "=== 扩展后状态 ==="
vgs webdata
vgdisplay webdata | grep -E "VG Size|Free"
```

---

## 5. 🔄 卷组激活管理


### 5.1 什么是卷组激活


**💡 通俗解释**：
卷组激活就像**打开电源开关**，只有激活的卷组才能被系统使用。未激活的卷组就像断电的设备，虽然存在但无法工作。

```
激活状态对比：
┌─────────────────┐    ┌─────────────────┐
│   未激活卷组    │    │   已激活卷组    │
│                 │    │                 │
│  ❌ 无法创建LV   │    │  ✅ 可以创建LV   │
│  ❌ 无法挂载     │    │  ✅ 可以正常挂载  │
│  ❌ 无法读写     │    │  ✅ 可以读写数据  │
└─────────────────┘    └─────────────────┘
```

### 5.2 激活卷组vgchange


```bash
# 激活指定卷组
vgchange -a y webdata
# 输出：1 logical volume(s) in volume group "webdata" now active

# 激活所有卷组
vgchange -a y
```

### 5.3 去激活卷组


```bash
# 去激活指定卷组
vgchange -a n webdata
# 输出：0 logical volume(s) in volume group "webdata" now active

# 去激活所有卷组（危险操作！）
vgchange -a n
```

**⚠️ 去激活注意事项**：
- 确保没有程序正在使用卷组中的逻辑卷
- 先卸载所有相关文件系统
- 系统卷组不要去激活（会导致系统无法运行）

### 5.4 查看激活状态


```bash
# 查看卷组状态
vgs -o vg_name,vg_attr webdata

# Attr字段含义：
# 第5位：a=active(激活), -=inactive(未激活)
```

---

## 6. 📤 卷组导入导出


### 6.1 为什么需要导入导出


**💡 实际应用场景**：
- **硬盘迁移**：将硬盘从一台服务器转移到另一台
- **系统维护**：临时移除存储设备进行维护
- **灾难恢复**：从备份硬盘恢复数据

```
典型场景示例：
服务器A                          服务器B
┌─────────────┐                ┌─────────────┐
│   webdata   │   物理迁移      │             │
│  ┌─────────┐│  ═════════▶     │   导入后    │
│  │ /dev/sdb││                │   webdata   │
│  │ /dev/sdc││                │  ┌─────────┐│
│  └─────────┘│                │  │ /dev/sdb││
└─────────────┘                │  │ /dev/sdc││
                               │  └─────────┘│
                               └─────────────┘
```

### 6.2 导出卷组vgexport


```bash
# 第一步：去激活卷组（必须！）
vgchange -a n webdata

# 第二步：导出卷组
vgexport webdata
# 输出：Volume group "webdata" successfully exported

# 验证导出状态
vgs webdata
# 会显示exported状态
```

**🔸 导出后的影响**：
- 卷组变为不可用状态
- 无法创建新的逻辑卷
- 现有逻辑卷无法挂载使用
- 但数据仍然安全存储在磁盘上

### 6.3 导入卷组vgimport


```bash
# 扫描可导入的卷组
vgscan
# 输出：Found exported volume group "webdata" using metadata type lvm2

# 导入卷组
vgimport webdata
# 输出：Volume group "webdata" successfully imported

# 激活导入的卷组
vgchange -a y webdata
```

### 6.4 完整的迁移流程


```bash
# === 源服务器操作 ===
echo "1. 卸载相关文件系统"
umount /mnt/webdata

echo "2. 去激活卷组"  
vgchange -a n webdata

echo "3. 导出卷组"
vgexport webdata

echo "4. 确认导出成功"
vgs | grep webdata

# 此时可以安全移除硬盘

# === 目标服务器操作 ===
echo "5. 连接硬盘后扫描"
vgscan

echo "6. 导入卷组"
vgimport webdata

echo "7. 激活卷组"
vgchange -a y webdata

echo "8. 挂载使用"
mount /dev/webdata/lv01 /mnt/webdata
```

---

## 7. 💾 卷组备份恢复


### 7.1 为什么要备份卷组配置


**💡 重要性说明**：
卷组的配置信息（metadata）包含了整个存储结构的"地图"，如果配置损坏，即使数据完好也可能无法访问。

```
配置信息包含内容：
┌─────────────────────────────────┐
│         卷组元数据              │
├─────────────────────────────────┤
│ • 物理卷列表和位置              │
│ • 逻辑卷的分布情况              │  
│ • PE到LE的映射关系              │
│ • 卷组的属性设置                │
│ • UUID和标识符                  │
└─────────────────────────────────┘
```

### 7.2 自动备份机制


LVM默认会自动备份卷组配置：

```bash
# 查看备份配置
grep archive /etc/lvm/lvm.conf
# archive = 1        # 启用自动归档
# archive_dir = "/etc/lvm/archive"

# 查看现有备份
ls -la /etc/lvm/archive/
# webdata_00000-1234567890.vg
# webdata_00001-1234567891.vg
```

**🔸 备份文件命名规则**：
- `webdata` - 卷组名称
- `00001` - 序列号（递增）
- `.vg` - 卷组配置文件标识

### 7.3 手动创建备份


```bash
# 手动备份单个卷组
vgcfgbackup webdata
# 输出：Volume group "webdata" successfully backed up.

# 备份所有卷组  
vgcfgbackup
```

### 7.4 恢复卷组配置


```bash
# 从最新备份恢复
vgcfgrestore webdata

# 从指定备份文件恢复
vgcfgrestore -f /etc/lvm/archive/webdata_00001-1234567891.vg webdata

# 强制恢复（危险操作）
vgcfgrestore -f backup_file webdata --force
```

**⚠️ 恢复注意事项**：
- 恢复前务必停止所有相关应用
- 确保物理卷状态正常
- 建议先在测试环境验证

### 7.5 备份最佳实践


```bash
#!/bin/bash
# LVM备份脚本示例

BACKUP_DIR="/backup/lvm-configs"
DATE=$(date +%Y%m%d_%H%M%S)

echo "开始LVM配置备份 - $DATE"

# 创建备份目录
mkdir -p $BACKUP_DIR/$DATE

# 备份所有卷组配置
vgcfgbackup --file $BACKUP_DIR/$DATE/vg-backup.cfg

# 备份LVM配置文件
cp /etc/lvm/lvm.conf $BACKUP_DIR/$DATE/

# 记录当前状态
vgs > $BACKUP_DIR/$DATE/vgs-status.txt
pvs > $BACKUP_DIR/$DATE/pvs-status.txt
lvs > $BACKUP_DIR/$DATE/lvs-status.txt

echo "备份完成，保存在：$BACKUP_DIR/$DATE"
```

---

## 8. 🗑️ 删除卷组操作


### 8.1 删除前的安全检查


**⚠️ 删除卷组是不可逆操作！删除前必须做好以下确认：**

```bash
# 1. 确认卷组中的逻辑卷
lvs webdata
echo "以上逻辑卷将全部丢失！"

# 2. 确认挂载情况
df -h | grep webdata
echo "确保没有文件系统在使用"

# 3. 确认没有活跃进程
lsof +D /mount/point
fuser -v /mount/point

# 4. 检查数据重要性
echo "确认数据已备份或不再需要"
```

### 8.2 删除步骤详解


```bash
# 步骤1：卸载所有相关文件系统
umount /dev/webdata/lv01
umount /dev/webdata/lv02

# 步骤2：删除所有逻辑卷
lvremove /dev/webdata/lv01
lvremove /dev/webdata/lv02
# 或批量删除
lvremove webdata

# 步骤3：去激活卷组
vgchange -a n webdata

# 步骤4：删除卷组
vgremove webdata
# 输出：Volume group "webdata" successfully removed

# 步骤5：清理物理卷（可选）
pvremove /dev/sdb /dev/sdc
```

### 8.3 删除确认与验证


```bash
# 确认卷组已删除
vgs | grep webdata
echo "如果没有输出，说明删除成功"

# 确认物理卷状态
pvs /dev/sdb /dev/sdc
echo "如果显示空白VG列，说明PV已释放"

# 确认设备文件清理
ls /dev/webdata/
echo "目录应该不存在或为空"
```

---

## 9. 🎯 实战案例演练


### 9.1 企业Web服务器存储扩容


**📋 场景描述**：
Web服务器的`/var/www`分区空间不足，需要添加新硬盘并扩容。

```bash
# 当前状态检查
df -h /var/www
# /dev/webvg/www-lv  18G   16G  1.2G  94% /var/www

vgs webvg  
# VG    #PV #LV #SN Attr   VSize  VFree
# webvg   2   3   0 wz--n- 40.00g    0

echo "可用空间为0，需要扩容"
```

**🔸 解决方案步骤**：

```bash
# 第1步：准备新硬盘
echo "=== 添加新硬盘 /dev/sdd (50GB) ==="
pvcreate /dev/sdd
pvs /dev/sdd

# 第2步：扩展卷组
echo "=== 扩展卷组 ==="
vgextend webvg /dev/sdd
vgs webvg
# 现在VFree应该显示约50GB

# 第3步：扩展逻辑卷（这是下个主题内容）
echo "=== 后续可扩展逻辑卷和文件系统 ==="
lvextend -L +50G /dev/webvg/www-lv
resize2fs /dev/webvg/www-lv
```

### 9.2 数据库服务器存储迁移


**📋 场景描述**：
需要将数据库服务器的存储从旧服务器迁移到新服务器。

```bash
# === 旧服务器操作 ===
echo "=== 准备迁移数据库存储 ==="

# 1. 停止数据库服务
systemctl stop mysql

# 2. 卸载数据库分区
umount /var/lib/mysql

# 3. 去激活并导出卷组
vgchange -a n dbvg
vgexport dbvg

echo "现在可以安全移除硬盘"

# === 新服务器操作 ===
echo "=== 在新服务器导入存储 ==="

# 1. 连接硬盘后扫描
vgscan

# 2. 导入卷组  
vgimport dbvg

# 3. 激活卷组
vgchange -a y dbvg

# 4. 挂载并启动服务
mount /dev/dbvg/mysql-lv /var/lib/mysql
systemctl start mysql

echo "数据库迁移完成"
```

### 9.3 开发环境快速部署


**📋 场景描述**：
为开发团队快速创建标准化的存储环境。

```bash
#!/bin/bash
# 开发环境存储自动化部署脚本

PROJECT_NAME=$1
if [ -z "$PROJECT_NAME" ]; then
    echo "用法: $0 <项目名称>"
    exit 1
fi

VG_NAME="${PROJECT_NAME}_vg"
DISKS="/dev/sdb /dev/sdc"

echo "为项目 $PROJECT_NAME 创建存储环境"

# 1. 创建物理卷
pvcreate $DISKS

# 2. 创建卷组
vgcreate $VG_NAME $DISKS

# 3. 显示创建结果
vgdisplay $VG_NAME | grep -E "VG Name|VG Size|Free"

echo "存储环境创建完成："
echo "- 卷组名称: $VG_NAME"
echo "- 总容量: $(vgs --noheadings -o vg_size $VG_NAME | tr -d ' ')"
echo "- 可用空间: $(vgs --noheadings -o vg_free $VG_NAME | tr -d ' ')"
echo "可以开始创建逻辑卷了！"
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的基本概念


```
🔸 卷组本质：多个物理磁盘的统一存储池
🔸 主要作用：统一管理、灵活分配、动态扩展
🔸 生命周期：创建 → 使用 → 扩展/收缩 → 导出/导入 → 删除
🔸 激活机制：只有激活的卷组才能正常使用
🔸 备份重要性：配置损坏可能导致数据无法访问
```

### 10.2 关键命令速查


| 操作类型 | **命令** | **说明** | **使用频率** |
|---------|---------|----------|------------|
| **创建** | `vgcreate` | `创建新卷组` | 🔥🔥🔥 |
| **查看** | `vgs/vgdisplay` | `查看卷组状态` | 🔥🔥🔥🔥🔥 |
| **扩展** | `vgextend` | `添加物理卷到卷组` | 🔥🔥🔥🔥 |
| **收缩** | `vgreduce` | `从卷组移除物理卷` | 🔥🔥 |
| **激活** | `vgchange -a y/n` | `激活/去激活卷组` | 🔥🔥🔥 |
| **导出** | `vgexport` | `导出卷组用于迁移` | 🔥🔥 |
| **导入** | `vgimport` | `导入卷组从其他系统` | 🔥🔥 |
| **备份** | `vgcfgbackup` | `备份卷组配置` | 🔥🔥🔥 |
| **删除** | `vgremove` | `删除卷组` | 🔥🔥 |

### 10.3 实用操作流程


**🔹 新建存储环境流程**：
```
1. 准备磁盘 → pvcreate
2. 创建卷组 → vgcreate  
3. 查看状态 → vgs
4. 创建逻辑卷 → (下个主题)
```

**🔹 扩容存储流程**：
```
1. 添加新磁盘 → pvcreate
2. 扩展卷组 → vgextend
3. 确认扩展 → vgs
4. 扩展逻辑卷 → (下个主题)
```

**🔹 存储迁移流程**：
```
1. 停止服务 → systemctl stop
2. 卸载文件系统 → umount
3. 去激活并导出 → vgchange -a n → vgexport
4. 物理迁移硬盘
5. 导入并激活 → vgimport → vgchange -a y
6. 挂载并启动 → mount → systemctl start
```

### 10.4 安全注意事项


```
⚠️ 删除操作：vgremove是不可逆的，删除前务必确认数据备份
⚠️ 收缩操作：vgreduce前必须用pvmove迁移数据
⚠️ 去激活：系统卷组不要去激活，会导致系统崩溃
⚠️ 导出导入：确保物理卷在两个系统间正确识别
⚠️ 备份习惯：定期备份卷组配置，关键时刻可以救命
```

### 10.5 故障排除思路


```
问题分类：

卷组无法激活：
├── 检查物理卷状态 (pvs)
├── 扫描卷组 (vgscan)  
└── 查看系统日志 (journalctl)

扩展失败：
├── 确认PV创建成功 (pvs)
├── 检查磁盘空间 (df -h)
└── 查看错误信息

导入失败：  
├── 确认卷组已导出
├── 检查设备连接状态
└── 扫描LVM设备 (pvscan)

配置丢失：
├── 查找备份文件 (/etc/lvm/archive/)
├── 尝试配置恢复 (vgcfgrestore)
└── 重建卷组配置
```

**💡 记忆要点**：
- **卷组是存储池**：把多个磁盘变成一个大仓库
- **激活才能用**：就像开电源，不激活就用不了  
- **扩展很简单**：加磁盘就是往池子里倒水
- **删除要小心**：一删除数据就没了，要三思而后行
- **备份很重要**：配置信息是存储系统的"地图"，丢了就找不到数据了