---
title: 7、磁盘空间使用统计
---
## 📚 目录

1. [磁盘空间统计基础概念](#1-磁盘空间统计基础概念)
2. [df命令：文件系统使用情况](#2-df命令文件系统使用情况)
3. [du命令：目录空间占用统计](#3-du命令目录空间占用统计)
4. [ncdu交互式磁盘分析工具](#4-ncdu交互式磁盘分析工具)
5. [磁盘使用率监控与告警](#5-磁盘使用率监控与告警)
6. [inode使用情况分析](#6-inode使用情况分析)
7. [隐藏文件与删除文件处理](#7-隐藏文件与删除文件处理)
8. [大文件查找与清理策略](#8-大文件查找与清理策略)
9. [磁盘空间趋势分析](#9-磁盘空间趋势分析)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 💾 磁盘空间统计基础概念


### 1.1 为什么需要磁盘空间管理？


**🏠 生活类比**
> 就像管理家里的储物空间一样，我们需要知道哪个房间放了什么东西，还剩多少空间可以用，哪些东西占地方最多。Linux系统的磁盘管理也是同样的道理。

**核心需求：**
```
服务器管理痛点：
• 磁盘空间不足导致系统崩溃
• 日志文件疯狂增长吞噬空间  
• 不知道哪些文件占用空间最多
• 删除文件后空间没有释放
• 无法提前预警磁盘空间不足
```

### 1.2 磁盘空间统计的基本概念


**📊 核心概念解释**

**文件系统 vs 目录空间：**
```
文件系统空间：整个分区的使用情况
• 显示挂载点总容量
• 已用空间和可用空间  
• 包含系统预留空间

目录空间：具体文件夹占用情况
• 统计目录下所有文件大小
• 递归计算子目录空间
• 不包含系统预留部分
```

**🔍 关键术语说明**

| 术语 | **含义** | **通俗解释** |
|------|----------|-------------|
| **挂载点** | `文件系统附加到目录树的位置` | `就像给U盘指定一个文件夹名` |
| **inode** | `文件系统中存储文件元数据的数据结构` | `文件的"身份证"，记录文件基本信息` |
| **块大小** | `文件系统分配的最小存储单位` | `像停车场的车位，最小分配单位` |
| **预留空间** | `系统为root用户保留的磁盘空间` | `紧急情况下管理员的"备用金"` |

**💡 关键洞察**
> 磁盘空间管理的本质是：**知道现状** → **发现问题** → **采取行动** → **预防未来**

---

## 2. 📈 df命令：文件系统使用情况


### 2.1 df命令基础使用


**🔸 df命令作用**
```
df = Disk Free（磁盘剩余）
作用：显示每个挂载的文件系统的磁盘空间使用情况
重要性：系统管理员的第一诊断工具
```

**基本语法：**
```bash
df [选项] [文件系统或目录]
```

### 2.2 常用df命令选项


**📋 核心选项详解**

```bash
# 最常用：人类可读格式
df -h
```

**输出解释：**
```
文件系统        容量  已用  可用 已用% 挂载点
/dev/sda1        20G  15G  4.2G   79% /
/dev/sda2       100G  45G   50G   48% /home
tmpfs           2.0G     0  2.0G    0% /dev/shm
```

**🔧 选项说明表**

| 选项 | **功能** | **使用场景** |
|------|----------|-------------|
| `-h` | `人类可读格式(K,M,G)` | `日常查看，最常用` |
| `-H` | `1000进制而非1024` | `与硬盘厂商标准一致` |
| `-i` | `显示inode使用情况` | `诊断文件数量问题` |
| `-T` | `显示文件系统类型` | `了解分区格式` |
| `-x` | `排除指定类型文件系统` | `过滤临时文件系统` |

### 2.3 df命令实战示例


**🚀 快速上手**

**1️⃣ 查看所有文件系统：**
```bash
df -h
```

**2️⃣ 查看指定目录：**
```bash
df -h /home    # 查看/home目录所在文件系统
df -h .        # 查看当前目录所在文件系统
```

**3️⃣ 显示文件系统类型：**
```bash
df -hT
```
```
文件系统       类型      容量  已用  可用 已用% 挂载点
/dev/sda1      ext4       20G  15G  4.2G   79% /
/dev/sda2      xfs       100G  45G   50G   48% /home
```

**4️⃣ 查看inode使用情况：**
```bash
df -hi
```
```
文件系统       Inode 已用(I) 可用(I) 已用%(I) 挂载点
/dev/sda1      1.3M    120K    1.2M     9%   /
/dev/sda2      6.5M     45K    6.4M     1%   /home
```

**💡 关键洞察**
> df命令看的是整个文件系统的全貌，就像从飞机上俯瞰一个城市的整体规划。

### 2.4 df命令输出分析


**🔍 深入思考**

**已用百分比的陷阱：**
```bash
# 看起来还有空间，但系统提示空间不足？
df -h
# /dev/sda1  10G  8.5G  1.5G  85%  /

# 原因：系统预留了5%空间给root用户
# 实际可用 = 1.5G - 5%预留 = 约1G
```

**⚠️ 常见误区**
- ❌ **错误理解**：认为显示还有1.5G就是真的可用
- ✅ **正确理解**：要考虑系统预留空间，实际可用空间更少

**🎯 实用技巧**

**监控脚本示例：**
```bash
#!/bin/bash
# 磁盘空间预警脚本
THRESHOLD=80

df -h | grep -vE '^文件系统|tmpfs|cdrom' | awk '{ print $5 " " $1 " " $6}' | while read output;
do
  usage=$(echo $output | awk '{print $1}' | sed 's/%//g')
  partition=$(echo $output | awk '{print $2}')
  mount=$(echo $output | awk '{print $3}')
  
  if [ $usage -ge $THRESHOLD ]; then
    echo "警告: $partition ($mount) 使用率达到 $usage%"
  fi
done
```

---

## 3. 📂 du命令：目录空间占用统计


### 3.1 du命令基础概念


**🔸 du命令作用**
```
du = Disk Usage（磁盘使用）
作用：统计目录和文件的实际磁盘占用空间
特点：递归计算，精确到文件级别
```

**💡 du vs df 区别**
```
df：看文件系统总体情况（俯瞰城市）
du：看具体目录占用情况（深入街区）

举例：
df -h /home     # 显示/home所在文件系统总体情况
du -h /home     # 显示/home目录实际占用空间
```

### 3.2 du命令常用选项


**📋 核心选项解析**

```bash
# 基本用法
du [选项] [目录或文件]
```

| 选项 | **功能** | **使用场景** |
|------|----------|-------------|
| `-h` | `人类可读格式` | `日常使用必备` |
| `-s` | `只显示总计` | `快速查看目录总大小` |
| `-a` | `显示所有文件` | `详细分析每个文件` |
| `-c` | `显示总和` | `多个目录的汇总` |
| `--max-depth=N` | `限制显示层级` | `避免输出过多信息` |

### 3.3 du命令实战应用


**🚀 快速上手**

**1️⃣ 查看当前目录总大小：**
```bash
du -sh .
# 输出：2.3G    .
```

**2️⃣ 查看目录下各子目录大小：**
```bash
du -sh *
```
```
1.2G    Documents
800M    Downloads
150M    Pictures
200M    Videos
50M     Desktop
```

**3️⃣ 找出最大的几个目录：**
```bash
du -sh * | sort -hr | head -5
```
```
1.2G    Documents
800M    Downloads
200M    Videos
150M    Pictures
50M     Desktop
```

**4️⃣ 限制显示深度：**
```bash
du -h --max-depth=2 /var
```

**💪 实践挑战**

**查找占用空间最大的目录：**
```bash
# 方法1：使用sort排序
du -sh /var/* 2>/dev/null | sort -hr | head -10

# 方法2：递归查找大目录
find /var -type d -exec du -sh {} \; 2>/dev/null | sort -hr | head -10
```

### 3.4 du命令高级技巧


**🔧 高级用法示例**

**1. 排除特定文件类型：**
```bash
# 排除临时文件
du -sh --exclude='*.tmp' --exclude='*.log' /home/user
```

**2. 按时间过滤：**
```bash
# 查找7天内修改的文件大小
find /home/user -mtime -7 -exec du -ch {} + | tail -1
```

**3. 交叉验证空间使用：**
```bash
# 比较df和du的差异
echo "df显示："; df -h /home
echo "du显示："; du -sh /home
```

**⚠️ 注意事项**
```
du命令可能遇到的问题：
• 权限不足，无法访问某些目录
• 符号链接可能导致重复计算
• 硬链接会被重复计算
• 正在写入的文件大小可能不准确
```

---

## 4. 🖥️ ncdu交互式磁盘分析工具


### 4.1 ncdu工具介绍


**🔸 什么是ncdu**
```
ncdu = NCurses Disk Usage
本质：du命令的交互式图形化版本
特点：树形显示，支持导航和排序
优势：直观、快速、操作简单
```

**🏠 生活类比**
> 如果du命令像看账单明细，那么ncdu就像用手机银行APP查看消费分类图表，更直观更好操作。

### 4.2 ncdu安装与基础使用


**安装ncdu：**
```bash
# Ubuntu/Debian
sudo apt install ncdu

# CentOS/RHEL
sudo yum install ncdu
# 或者
sudo dnf install ncdu

# macOS
brew install ncdu
```

**基础使用：**
```bash
# 分析当前目录
ncdu

# 分析指定目录
ncdu /var/log

# 导出分析结果
ncdu -o report.txt /home
```

### 4.3 ncdu交互操作


**📋 界面说明**

```
ncdu界面布局：
┌─────────────────────────────────────────┐
│ ncdu 1.15 ~ Use the arrow keys to      │
│ navigate, press ? for help             │
├─────────────────────────────────────────┤
│   2.1 GiB [##########] /home/user/docs │
│   1.8 GiB [########  ] /home/user/down │
│ 800.0 MiB [###       ] /home/user/pics │
│ 200.0 MiB [#         ] /home/user/vids │
│  50.0 MiB [          ] /home/user/desk │
├─────────────────────────────────────────┤
│ Total disk usage: 4.95 GiB             │
│ Apparent size:   4.98 GiB              │
└─────────────────────────────────────────┘
```

**🔧 常用快捷键**

| 按键 | **功能** | **说明** |
|------|----------|----------|
| `↑/↓` | `导航移动` | `上下选择条目` |
| `→/Enter` | `进入目录` | `深入查看子目录` |
| `←` | `返回上级` | `回到父目录` |
| `d` | `删除选中项` | `直接删除文件/目录` |
| `s` | `切换排序方式` | `按大小或名称排序` |
| `?` | `显示帮助` | `查看所有快捷键` |
| `q` | `退出程序` | `返回命令行` |

### 4.4 ncdu实战技巧


**🎯 实用操作流程**

**1️⃣ 快速定位大文件：**
```bash
# 启动ncdu并进入最大的目录
ncdu /home
# 按↓键移动到最大项目，按→键进入
# 重复操作直到找到具体大文件
```

**2️⃣ 安全删除文件：**
```
操作步骤：
1. 用箭头键选中要删除的项目
2. 按'd'键删除
3. 确认删除提示（输入yes）
4. 实时看到空间释放效果
```

**3️⃣ 导出和导入分析结果：**
```bash
# 导出分析结果（耗时较长的目录建议这样做）
ncdu -o /tmp/home-analysis.txt /home

# 稍后导入查看（速度很快）
ncdu -f /tmp/home-analysis.txt
```

**💡 关键洞察**
> ncdu的最大优势是**交互性**和**实时反馈**，删除文件后立即看到空间释放，这是命令行工具无法提供的体验。

**🚨 注意事项**
```
使用ncdu时要注意：
• 删除操作不可恢复，要谨慎
• 分析大目录时会消耗较多时间和CPU
• 对系统目录要特别小心，不要误删
• 可以先用-o选项保存分析结果，避免重复扫描
```

---

## 5. ⚠️ 磁盘使用率监控与告警


### 5.1 为什么需要磁盘使用率告警


**🔸 磁盘空间耗尽的严重后果**
```
系统层面：
• 无法创建新文件，程序崩溃
• 日志无法写入，问题排查困难
• 数据库无法运行，服务中断
• 系统无法更新，安全风险增加

业务层面：
• 用户无法上传文件
• 网站页面加载失败
• 数据备份失败
• 服务完全不可用
```

**💡 关键洞察**
> 磁盘空间管理的黄金法则：**预防胜于治疗**。等到空间耗尽再处理，往往为时已晚。

### 5.2 磁盘使用率阈值设置


**📊 告警阈值建议**

| 使用率 | **级别** | **处理策略** |
|--------|----------|-------------|
| `< 70%` | `正常` | `定期检查即可` |
| `70-80%` | `注意` | `开始关注增长趋势` |
| `80-90%` | `警告` | `清理不必要文件` |
| `90-95%` | `严重` | `立即清理大文件` |
| `> 95%` | `紧急` | `停止写入，扩容磁盘` |

**🎯 不同场景的阈值设置**

```bash
# Web服务器（用户上传文件多）
WARNING_THRESHOLD=75
CRITICAL_THRESHOLD=85

# 数据库服务器（数据增长稳定）
WARNING_THRESHOLD=80
CRITICAL_THRESHOLD=90

# 日志服务器（增长快速）
WARNING_THRESHOLD=70
CRITICAL_THRESHOLD=80
```

### 5.3 磁盘监控脚本编写


**🔧 基础监控脚本**

```bash
#!/bin/bash
# disk_monitor.sh - 磁盘空间监控脚本

# 配置参数
WARNING=80
CRITICAL=90
LOG_FILE="/var/log/disk_monitor.log"
EMAIL="admin@company.com"

# 检查磁盘使用率
check_disk_usage() {
    df -H | grep -vE '^文件系统|tmpfs|cdrom' | awk '{ print $5 " " $1 " " $6}' | while read output; do
        usage=$(echo $output | awk '{print $1}' | sed 's/%//g')
        partition=$(echo $output | awk '{print $2}')
        mount_point=$(echo $output | awk '{print $3}')
        
        timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        
        if [ $usage -ge $CRITICAL ]; then
            message="紧急: $partition ($mount_point) 使用率 $usage%"
            echo "[$timestamp] CRITICAL: $message" >> $LOG_FILE
            echo "$message" | mail -s "磁盘空间严重不足" $EMAIL
        elif [ $usage -ge $WARNING ]; then
            message="警告: $partition ($mount_point) 使用率 $usage%"
            echo "[$timestamp] WARNING: $message" >> $LOG_FILE
        fi
    done
}

# 执行检查
check_disk_usage
```

**📅 定时执行设置**

```bash
# 编辑crontab
crontab -e

# 每5分钟检查一次
*/5 * * * * /path/to/disk_monitor.sh

# 每小时发送概要报告
0 * * * * df -h | mail -s "磁盘使用情况报告" admin@company.com
```

### 5.4 高级监控方案


**🚀 快速部署监控**

**1️⃣ 使用iostat监控IO性能：**
```bash
# 安装sysstat包
sudo apt install sysstat

# 监控磁盘IO
iostat -x 1 5
```

**2️⃣ 集成系统监控工具：**
```bash
# 使用Prometheus + Node Exporter
# node_exporter会自动收集磁盘指标
curl http://localhost:9100/metrics | grep filesystem
```

**3️⃣ 智能告警脚本：**
```bash
#!/bin/bash
# smart_disk_alert.sh - 智能磁盘告警

# 检查增长率
check_growth_rate() {
    current_usage=$(df /home | tail -1 | awk '{print $3}')
    
    if [ -f /tmp/last_usage ]; then
        last_usage=$(cat /tmp/last_usage)
        growth=$((current_usage - last_usage))
        
        # 如果1小时增长超过1GB，发送预警
        if [ $growth -gt 1048576 ]; then  # 1GB in KB
            echo "磁盘使用量增长异常：1小时内增长${growth}KB"
        fi
    fi
    
    echo $current_usage > /tmp/last_usage
}

check_growth_rate
```

---

## 6. 🗂️ inode使用情况分析


### 6.1 什么是inode


**🔸 inode基础概念**
```
inode = index node（索引节点）
作用：存储文件的元数据信息
重要性：每个文件都需要一个inode
限制：inode数量有限，用完就无法创建新文件
```

**🏠 生活类比**
> inode就像图书馆的图书编号卡片，每本书(文件)都需要一张卡片记录基本信息。卡片用完了，即使书架(磁盘空间)还有地方，也无法收录新书。

**🔍 inode存储的信息**
```
inode包含的文件信息：
• 文件大小
• 文件权限（rwx）
• 文件所有者（用户和组）
• 时间戳（创建、修改、访问）
• 链接计数
• 数据块指针（文件内容位置）

注意：inode不存储文件名！
文件名存储在目录的数据块中
```

### 6.2 inode使用情况检查


**📊 检查inode使用率**

```bash
# 查看所有文件系统的inode使用情况
df -i
```

**输出解释：**
```
文件系统       Inode  已用(I)  可用(I) 已用%(I) 挂载点
/dev/sda1     655360   120450   534910    19%   /
/dev/sda2    1310720    45280  1265440     4%   /home
tmpfs         125856        1   125855     1%   /dev/shm
```

**🔍 深入分析inode使用**

```bash
# 查看特定目录的inode使用情况
df -i /var/log

# 统计目录下文件数量（消耗inode数）
find /var/log -type f | wc -l

# 找出包含文件最多的目录
find /var -type d -exec sh -c 'echo "$(find "$1" -maxdepth 1 -type f | wc -l) $1"' _ {} \; | sort -nr | head -10
```

### 6.3 inode耗尽问题诊断


**⚠️ inode耗尽的症状**
```
典型现象：
• 磁盘空间充足，但无法创建新文件
• 系统提示"No space left on device"
• df显示磁盘空间充足，但df -i显示inode使用率100%
```

**🔧 诊断inode问题的方法**

**1️⃣ 快速定位问题目录：**
```bash
# 找出文件数量最多的目录
for dir in /*; do
    if [ -d "$dir" ]; then
        count=$(find "$dir" -type f 2>/dev/null | wc -l)
        echo "$count files in $dir"
    fi
done | sort -nr | head -5
```

**2️⃣ 详细分析特定目录：**
```bash
# 分析/var/log目录的文件分布
find /var/log -type f -printf '%h\n' | sort | uniq -c | sort -nr
```

**3️⃣ 找出创建大量小文件的进程：**
```bash
# 监控文件创建活动
sudo lsof | grep REG | awk '{print $2}' | sort | uniq -c | sort -nr | head -10
```

### 6.4 inode问题解决方案


**🎯 解决策略**

**策略1：清理不必要的小文件**
```bash
# 清理临时文件
find /tmp -type f -atime +7 -delete
find /var/tmp -type f -atime +7 -delete

# 清理旧日志文件
find /var/log -name "*.log.*" -type f -mtime +30 -delete

# 清理缓存文件
find /home -name "*.cache" -type f -mtime +7 -delete
```

**策略2：合并小文件**
```bash
# 将多个小日志文件合并为一个
cd /var/log/myapp
cat *.log > combined.log
rm *.log.old
```

**策略3：增加inode数量（重新格式化）**
```bash
# 查看当前文件系统的inode密度
tune2fs -l /dev/sda1 | grep -i inode

# 重新格式化时指定更多inode
mkfs.ext4 -i 4096 /dev/sda1  # 每4KB分配一个inode
```

**💡 预防措施**
```
避免inode耗尽的最佳实践：
• 定期清理临时文件和日志
• 监控文件数量增长趋势
• 避免创建大量小文件
• 使用日志轮转机制
• 规划合理的inode密度
```

---

## 7. 👻 隐藏文件与删除文件处理


### 7.1 隐藏文件的识别与统计


**🔸 什么是隐藏文件**
```
Linux隐藏文件特点：
• 文件名以点(.)开头
• ls命令默认不显示
• 通常是配置文件或缓存文件
• 可能占用大量磁盘空间
```

**📂 常见隐藏文件类型**
```
用户目录下常见隐藏文件：
~/.cache/          # 应用缓存文件
~/.local/share/    # 用户数据文件
~/.config/         # 配置文件
~/.mozilla/        # Firefox数据
~/.docker/         # Docker镜像缓存
~/.npm/            # npm包缓存
```

**🔍 查找和统计隐藏文件**

```bash
# 显示当前目录所有文件（包括隐藏文件）
ls -la

# 只显示隐藏文件
ls -ld .*

# 统计隐藏文件占用的空间
du -sh .[^.]*

# 查找最大的隐藏目录
du -sh .[^.]* 2>/dev/null | sort -hr | head -5
```

### 7.2 清理隐藏文件的策略


**🧹 安全清理策略**

**1️⃣ 清理缓存类隐藏文件：**
```bash
# 清理浏览器缓存
rm -rf ~/.cache/mozilla/
rm -rf ~/.cache/chromium/

# 清理包管理器缓存
rm -rf ~/.cache/pip/
rm -rf ~/.npm/_cacache/
rm -rf ~/.cache/yarn/

# 清理Docker缓存
docker system prune -a
```

**2️⃣ 清理日志类隐藏文件：**
```bash
# 清理系统日志
sudo journalctl --vacuum-time=7d
sudo journalctl --vacuum-size=100M

# 清理用户日志
find ~ -name "*.log" -type f -mtime +30 -delete
```

**⚠️ 不要删除的重要隐藏文件**
```
重要配置文件（谨慎处理）：
~/.bashrc          # bash配置
~/.ssh/            # SSH密钥和配置
~/.gitconfig       # Git全局配置
~/.vimrc           # Vim配置
~/.profile         # 用户环境配置
```

### 7.3 已删除但未释放空间的文件


**🔸 文件删除但空间未释放的原因**
```
常见原因：
• 文件被进程占用（文件句柄未关闭）
• 硬链接还存在
• 文件被移动到回收站
• NFS网络文件系统延迟
```

**🏠 生活类比**
> 就像房间里的家具，即使你把它搬出了房间，但如果有根绳子还连着，家具实际上还占据着房间的空间。

**🔍 诊断未释放空间的文件**

```bash
# 查找被删除但仍被进程占用的文件
lsof +L1

# 查看具体进程占用情况
lsof | grep deleted
```

**输出示例：**
```
COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NLINK    NODE NAME
nginx    1234 root    3w   REG  259,1  1048576     0 1234567 /var/log/nginx/access.log (deleted)
```

### 7.4 释放已删除文件的空间


**🔧 解决方法**

**方法1：重启相关进程**
```bash
# 找到占用已删除文件的进程
lsof +L1 | grep deleted

# 重启相关服务
sudo systemctl restart nginx
sudo systemctl restart apache2
```

**方法2：清空文件内容而非删除**
```bash
# 对于日志文件，清空内容而不删除
> /var/log/large.log

# 或使用truncate命令
truncate -s 0 /var/log/large.log
```

**方法3：强制关闭文件句柄**
```bash
# 使用fuser命令查看文件使用情况
fuser /var/log/large.log

# 杀死占用文件的进程（谨慎使用）
fuser -k /var/log/large.log
```

**💡 预防措施**
```
避免空间未释放的最佳实践：
• 删除大文件前先停止相关服务
• 使用logrotate管理日志文件
• 定期重启长期运行的服务
• 监控文件句柄使用情况
```

---

## 8. 🔍 大文件查找与清理策略


### 8.1 大文件查找技术


**🔸 为什么要查找大文件**
```
磁盘空间管理的80/20法则：
• 80%的磁盘空间通常被20%的大文件占用
• 清理几个大文件比删除千个小文件更有效
• 大文件往往是清理的重点目标
```

**🚀 快速查找大文件的方法**

**方法1：使用find命令**
```bash
# 查找大于100MB的文件
find /home -type f -size +100M -exec ls -lh {} \; 2>/dev/null

# 查找大于1GB的文件并按大小排序
find / -type f -size +1G -exec ls -lh {} \; 2>/dev/null | sort -k5 -hr

# 查找最近7天内创建的大文件
find /var -type f -size +50M -mtime -7 -ls 2>/dev/null
```

**方法2：组合使用find和du**
```bash
# 查找并显示大文件的详细信息
find /var/log -type f -size +10M -exec du -h {} \; | sort -hr

# 统计各种大小文件的数量
find /home -type f -size +10M -size -100M | wc -l    # 10M-100M
find /home -type f -size +100M -size -1G | wc -l     # 100M-1G  
find /home -type f -size +1G | wc -l                 # 大于1G
```

### 8.2 大文件分类分析


**📊 按文件类型分析大文件**

```bash
# 查找大的日志文件
find /var/log -name "*.log" -size +50M -exec ls -lh {} \;

# 查找大的数据库文件
find /var/lib -name "*.db" -o -name "*.sql" -size +100M -exec ls -lh {} \;

# 查找大的压缩文件
find /home -name "*.tar.gz" -o -name "*.zip" -size +100M -exec ls -lh {} \;

# 查找大的媒体文件
find /home -name "*.mp4" -o -name "*.avi" -o -name "*.mkv" -size +500M -exec ls -lh {} \;
```

**🎯 实用的大文件分析脚本**

```bash
#!/bin/bash
# large_files_analysis.sh - 大文件分析脚本

echo "=== 磁盘空间Top 10大文件 ==="
find / -type f -exec du -h {} \; 2>/dev/null | sort -hr | head -10

echo -e "\n=== 各目录下最大文件 ==="
for dir in /home /var /usr /opt; do
    if [ -d "$dir" ]; then
        echo "[$dir] 最大文件:"
        find "$dir" -type f -exec du -h {} \; 2>/dev/null | sort -hr | head -3
        echo
    fi
done

echo "=== 按文件类型统计 ==="
echo "日志文件: $(find / -name "*.log" -type f 2>/dev/null | wc -l) 个"
echo "压缩文件: $(find / \( -name "*.tar.gz" -o -name "*.zip" \) -type f 2>/dev/null | wc -l) 个"
echo "数据库文件: $(find / \( -name "*.db" -o -name "*.sql" \) -type f 2>/dev/null | wc -l) 个"
```

### 8.3 大文件清理策略


**🧹 清理策略分类**

**策略1：日志文件清理**
```bash
# 清理旧日志文件（保留最近30天）
find /var/log -name "*.log.*" -mtime +30 -delete
find /var/log -name "*.gz" -mtime +30 -delete

# 压缩大日志文件
find /var/log -name "*.log" -size +100M -exec gzip {} \;

# 清理应用日志
find /home/*/logs -name "*.log" -mtime +7 -delete 2>/dev/null
```

**策略2：缓存和临时文件清理**
```bash
# 清理系统缓存
sudo apt clean                    # Ubuntu/Debian
sudo yum clean all               # CentOS/RHEL

# 清理用户缓存
rm -rf ~/.cache/*
rm -rf /tmp/*
rm -rf /var/tmp/*

# 清理Docker缓存
docker system prune -a --volumes
```

**策略3：重复文件清理**
```bash
# 使用fdupes查找重复文件
sudo apt install fdupes
fdupes -r /home > duplicates.txt

# 删除重复文件（保留一个）
fdupes -r -d /home/user/Downloads
```

### 8.4 自动化清理方案


**📅 定时清理脚本**

```bash
#!/bin/bash
# auto_cleanup.sh - 自动化清理脚本

LOG_FILE="/var/log/cleanup.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

cleanup_logs() {
    echo "[$DATE] 开始清理日志文件..." >> $LOG_FILE
    
    # 清理应用日志（保留7天）
    find /var/log -name "*.log.*" -mtime +7 -delete
    
    # 压缩大日志文件
    find /var/log -name "*.log" -size +100M -exec gzip {} \;
    
    # 清理系统日志
    journalctl --vacuum-time=7d
}

cleanup_temp() {
    echo "[$DATE] 清理临时文件..." >> $LOG_FILE
    
    # 清理临时目录
    find /tmp -type f -atime +3 -delete 2>/dev/null
    find /var/tmp -type f -atime +7 -delete 2>/dev/null
}

cleanup_cache() {
    echo "[$DATE] 清理缓存文件..." >> $LOG_FILE
    
    # 清理包管理器缓存
    apt clean 2>/dev/null
    yum clean all 2>/dev/null
}

# 执行清理
cleanup_logs
cleanup_temp  
cleanup_cache

echo "[$DATE] 清理完成" >> $LOG_FILE
```

**设置定时任务：**
```bash
# 编辑crontab
crontab -e

# 每天凌晨2点执行清理
0 2 * * * /path/to/auto_cleanup.sh

# 每周日执行深度清理
0 3 * * 0 /path/to/deep_cleanup.sh
```

---

## 9. 📈 磁盘空间趋势分析


### 9.1 为什么需要趋势分析


**🔸 趋势分析的重要性**
```
预测性维护：
• 提前预知空间耗尽时间
• 合理规划磁盘扩容计划
• 识别异常增长模式
• 优化存储资源配置
```

**💡 关键洞察**
> 磁盘空间管理不仅要解决当前问题，更要预测未来需求。趋势分析是从被动响应转向主动管理的关键。

### 9.2 数据收集与记录


**📊 基础数据收集**

```bash
#!/bin/bash
# disk_trend_collector.sh - 磁盘使用趋势数据收集

DATA_FILE="/var/log/disk_usage_trend.csv"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

# 创建CSV文件头（仅第一次）
if [ ! -f "$DATA_FILE" ]; then
    echo "时间,文件系统,总空间(GB),已用空间(GB),可用空间(GB),使用率(%),挂载点" > $DATA_FILE
fi

# 收集磁盘使用数据
df -BG | grep -vE '^文件系统|tmpfs|cdrom' | while read line; do
    filesystem=$(echo $line | awk '{print $1}')
    total=$(echo $line | awk '{print $2}' | sed 's/G//g')
    used=$(echo $line | awk '{print $3}' | sed 's/G//g')
    available=$(echo $line | awk '{print $4}' | sed 's/G//g')
    usage=$(echo $line | awk '{print $5}' | sed 's/%//g')
    mount=$(echo $line | awk '{print $6}')
    
    echo "$DATE,$filesystem,$total,$used,$available,$usage,$mount" >> $DATA_FILE
done
```

**设置定时收集：**
```bash
# 每小时收集一次数据
0 * * * * /path/to/disk_trend_collector.sh

# 每5分钟收集一次（高频监控）
*/5 * * * * /path/to/disk_trend_collector.sh
```

### 9.3 趋势分析脚本


**📈 增长率分析脚本**

```bash
#!/bin/bash
# disk_growth_analysis.sh - 磁盘增长趋势分析

DATA_FILE="/var/log/disk_usage_trend.csv"
MOUNT_POINT="/"

# 分析最近24小时的增长情况
analyze_24h_growth() {
    # 获取24小时前和当前的使用量
    current_usage=$(tail -1 $DATA_FILE | grep "$MOUNT_POINT" | cut -d',' -f4)
    past_usage=$(grep "$(date -d '24 hours ago' '+%Y-%m-%d')" $DATA_FILE | grep "$MOUNT_POINT" | tail -1 | cut -d',' -f4)
    
    if [ -n "$current_usage" ] && [ -n "$past_usage" ]; then
        growth=$((current_usage - past_usage))
        echo "24小时磁盘增长: ${growth}GB"
        
        # 计算预计耗尽时间
        available=$(tail -1 $DATA_FILE | grep "$MOUNT_POINT" | cut -d',' -f5)
        if [ $growth -gt 0 ]; then
            days_left=$((available / growth))
            echo "按当前增长速度，预计 $days_left 天后空间耗尽"
        fi
    fi
}

# 分析每周增长趋势
analyze_weekly_growth() {
    echo "=== 最近7天增长趋势 ==="
    for i in {0..6}; do
        date_check=$(date -d "$i days ago" '+%Y-%m-%d')
        daily_max=$(grep "$date_check" $DATA_FILE | grep "$MOUNT_POINT" | tail -1 | cut -d',' -f4)
        if [ -n "$daily_max" ]; then
            echo "$date_check: ${daily_max}GB"
        fi
    done
}

analyze_24h_growth
analyze_weekly_growth
```

### 9.4 可视化分析


**📊 简单的文本图表**

```bash
#!/bin/bash
# disk_usage_chart.sh - 创建简单的使用率图表

DATA_FILE="/var/log/disk_usage_trend.csv"
MOUNT_POINT="/"

echo "磁盘使用率趋势图 (最近24小时)"
echo "时间                 使用率  图表"
echo "================================================"

# 提取最近24小时的数据并生成简单图表
grep "$(date '+%Y-%m-%d')" $DATA_FILE | grep "$MOUNT_POINT" | tail -24 | while read line; do
    time=$(echo $line | cut -d',' -f1 | cut -d' ' -f2 | cut -d':' -f1-2)
    usage=$(echo $line | cut -d',' -f6)
    
    # 创建简单的条形图
    bars=$((usage / 2))  # 每2%一个字符
    bar_chart=$(printf "%*s" $bars | tr ' ' '█')
    
    printf "%-20s %3s%%   %s\n" "$time" "$usage" "$bar_chart"
done
```

**🔧 高级分析工具集成**

```bash
# 导出数据给专业工具分析
# 导出到Grafana/Prometheus格式
cat /var/log/disk_usage_trend.csv | awk -F',' '{print "disk_usage{mount=\""$7"\"} "$6" "strftime("%s", mktime(gsub(/-|:/, " ", $1)))}' > metrics.txt

# 生成统计报告
awk -F',' 'NR>1 {
    mount[$7] += $4
    count[$7]++
} END {
    print "磁盘使用统计报告:"
    for (m in mount) {
        avg = mount[m]/count[m]
        print m ": 平均使用 " avg "GB"
    }
}' /var/log/disk_usage_trend.csv
```

### 9.5 异常检测与预警


**⚠️ 异常模式识别**

```bash
#!/bin/bash
# disk_anomaly_detector.sh - 磁盘使用异常检测

DATA_FILE="/var/log/disk_usage_trend.csv"

detect_unusual_growth() {
    # 计算最近6小时的增长率
    recent_growth=$(tail -6 $DATA_FILE | awk -F',' 'NR==1{start=$4} END{growth=$4-start; print growth}')
    
    # 计算历史平均6小时增长率
    avg_growth=$(awk -F',' 'NR>1 && NR%6==0 {print $4}' $DATA_FILE | awk '{sum+=$1; count++} END {print sum/count}')
    
    # 如果增长率超过历史平均3倍，发出警告
    if (( $(echo "$recent_growth > $avg_growth * 3" | bc -l) )); then
        echo "异常检测: 磁盘增长异常，6小时内增长 ${recent_growth}GB"
        echo "历史平均6小时增长: ${avg_growth}GB"
        
        # 发送告警邮件
        echo "检测到磁盘使用异常增长" | mail -s "磁盘异常告警" admin@company.com
    fi
}

detect_unusual_growth
```

**🎯 智能预测脚本**

```bash
#!/bin/bash
# disk_usage_predictor.sh - 磁盘使用预测

predict_usage() {
    # 使用线性回归预测未来使用量
    python3 << EOF
import csv
import numpy as np
from datetime import datetime, timedelta
import matplotlib.pyplot as plt

# 读取数据
dates = []
usage = []

with open('/var/log/disk_usage_trend.csv', 'r') as f:
    reader = csv.reader(f)
    next(reader)  # 跳过标题行
    for row in reader:
        if '$MOUNT_POINT' in row[6]:
            dates.append(datetime.strptime(row[0], '%Y-%m-%d %H:%M:%S'))
            usage.append(float(row[4]))

# 线性回归预测
x = np.array([(d - dates[0]).total_seconds() for d in dates])
y = np.array(usage)
coeffs = np.polyfit(x, y, 1)

# 预测未来7天
future_seconds = x[-1] + 7*24*3600  # 7天后
predicted_usage = coeffs[0] * future_seconds + coeffs[1]

print(f"当前使用量: {usage[-1]:.1f}GB")
print(f"预测7天后使用量: {predicted_usage:.1f}GB")
print(f"预计每天增长: {coeffs[0]*24*3600:.2f}GB")
EOF
}

predict_usage
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 df命令：查看文件系统整体使用情况，是系统管理的第一诊断工具
🔸 du命令：统计目录和文件实际占用空间，精确定位空间消耗
🔸 ncdu工具：交互式磁盘分析，直观高效的空间管理助手
🔸 inode概念：文件索引节点，可能成为空间瓶颈的隐形因素
🔸 监控告警：预防性管理，防患于未然的关键策略
```

### 10.2 关键理解要点


**🔹 df和du的本质区别**
```
df看文件系统：就像查看银行账户总额
du看目录占用：就像查看每笔消费明细
两者结合使用：全面掌握磁盘使用状况
```

**🔹 磁盘空间问题的根本原因**
```
常见原因排序：
1️⃣ 日志文件无限增长（最常见）
2️⃣ 缓存和临时文件堆积
3️⃣ 大文件未及时清理
4️⃣ 删除文件但进程未释放
5️⃣ inode耗尽（特殊情况）
```

**🔹 预防性管理的重要性**
```
磁盘管理的黄金法则：
• 监控 > 清理 > 扩容
• 预防 > 治疗 > 救火
• 自动化 > 手动 > 临时
```

### 10.3 实际应用价值


**📊 日常运维场景**
- **系统监控**：设置磁盘使用率告警，避免系统崩溃
- **性能优化**：清理不必要文件，提升系统性能
- **容量规划**：通过趋势分析预测扩容需求
- **故障处理**：快速定位和解决磁盘空间问题

**🔧 实用技能清单**

**初级技能：**
- [ ] 熟练使用`df -h`查看磁盘使用情况
- [ ] 使用`du -sh`统计目录大小
- [ ] 安装和使用ncdu进行交互式分析
- [ ] 编写基础的磁盘监控脚本

**中级技能：**
- [ ] 理解并监控inode使用情况
- [ ] 处理删除文件但空间未释放的问题
- [ ] 设置合理的磁盘使用率告警阈值
- [ ] 实施定期自动化清理策略

**高级技能：**
- [ ] 建立磁盘使用趋势分析系统
- [ ] 实现异常增长模式检测
- [ ] 集成专业监控工具
- [ ] 制定全面的磁盘容量管理策略

### 10.4 最佳实践建议


**🎯 监控策略**
```
告警阈值设置：
• 70%：开始关注
• 80%：发出提醒
• 90%：立即处理
• 95%：紧急响应
```

**🧹 清理策略**
```
定期清理内容：
• 每日：临时文件、旧日志
• 每周：缓存文件、重复文件
• 每月：大文件分析、深度清理
• 每季度：容量规划评估
```

**📈 趋势分析**
```
数据收集频率：
• 生产系统：每5分钟
• 开发系统：每小时
• 测试系统：每天
• 历史数据保留：至少3个月
```

### 10.5 常见问题与解决方案


**🚨 紧急情况处理**

**场景1：磁盘空间突然耗尽**
```bash
1. 立即释放临时空间：rm -rf /tmp/*
2. 清空大日志文件：> /var/log/large.log
3. 查找最大文件：find / -type f -size +1G
4. 停止写入密集的服务
5. 紧急扩容或清理
```

**场景2：inode耗尽**
```bash
1. 确认问题：df -i
2. 找到文件最多的目录：find /var -type d -exec sh -c 'echo "$(find "$1" -maxdepth 1 | wc -l) $1"' _ {} \;
3. 清理小文件：find /path -type f -size 0 -delete
4. 合并小文件或重建文件系统
```

**场景3：删除文件但空间未释放**
```bash
1. 查找占用进程：lsof +L1
2. 重启相关服务：systemctl restart service
3. 或者清空而非删除：> filename
```

### 10.6 进阶学习方向


**🚀 扩展技能**
- **LVM管理**：逻辑卷管理，动态扩容磁盘
- **RAID配置**：磁盘阵列，提供冗余和性能
- **文件系统调优**：ext4、xfs等文件系统优化
- **存储虚拟化**：Docker、LXC等容器存储管理

**📚 相关工具学习**
- **iotop**：IO监控工具
- **sysstat**：系统统计工具包
- **Prometheus + Grafana**：专业监控和可视化
- **Logrotate**：日志轮转管理

**🎯 一分钟掌握核心要点**
1. **df命令看全局**，du命令看细节，ncdu工具更直观
2. **监控告警很重要**，预防胜过临时抱佛脚
3. **inode也会满**，小文件多了创建不了新文件
4. **删除后不释放**，通常是进程还在占用文件句柄
5. **趋势分析做预测**，提前规划避免紧急扩容

**🔑 记忆口诀**
> **df看系统du看目录，ncdu交互更清楚；监控告警要及时，inode小文件需注意；删除文件查进程，趋势分析助决策。**

**核心记忆**：磁盘空间管理是系统运维的基础技能，掌握工具使用只是开始，建立完善的监控预警体系和清理策略才是关键。记住：**监控为先，预防为主，自动为王！**