---
title: 5ã€Shellè„šæœ¬ä¸­inotifyåº”ç”¨
---
## ğŸ“š ç›®å½•

1. [Shellä¸­inotifyåŸºç¡€åº”ç”¨](#1-Shellä¸­inotifyåŸºç¡€åº”ç”¨)
2. [while readå¾ªç¯å¤„ç†äº‹ä»¶](#2-while-readå¾ªç¯å¤„ç†äº‹ä»¶)
3. [äº‹ä»¶å‚æ•°è§£æä¸å¤„ç†](#3-äº‹ä»¶å‚æ•°è§£æä¸å¤„ç†)
4. [æ¡ä»¶åˆ¤æ–­ä¸äº‹ä»¶åˆ†ç±»](#4-æ¡ä»¶åˆ¤æ–­ä¸äº‹ä»¶åˆ†ç±»)
5. [å¤šç›®å½•å¹¶å‘ç›‘æ§å®ç°](#5-å¤šç›®å½•å¹¶å‘ç›‘æ§å®ç°)
6. [æ—¥å¿—è®°å½•ä¸äº‹ä»¶å­˜å‚¨](#6-æ—¥å¿—è®°å½•ä¸äº‹ä»¶å­˜å‚¨)
7. [é”™è¯¯å¤„ç†ä¸å¼‚å¸¸æ¢å¤](#7-é”™è¯¯å¤„ç†ä¸å¼‚å¸¸æ¢å¤)
8. [è„šæœ¬åå°è¿è¡Œç®¡ç†](#8-è„šæœ¬åå°è¿è¡Œç®¡ç†)
9. [ç›‘æ§è„šæœ¬æ€§èƒ½ä¼˜åŒ–](#9-ç›‘æ§è„šæœ¬æ€§èƒ½ä¼˜åŒ–)
10. [å®é™…ä¸šåŠ¡åœºæ™¯é›†æˆ](#10-å®é™…ä¸šåŠ¡åœºæ™¯é›†æˆ)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ Shellä¸­inotifyåŸºç¡€åº”ç”¨


### 1.1 ä»€ä¹ˆæ˜¯inotify


> **ğŸ’¡ ç®€å•ç†è§£**ï¼šinotifyå°±åƒç»™æ–‡ä»¶ç³»ç»Ÿå®‰è£…äº†"ç›‘æ§æ‘„åƒå¤´"ï¼Œå½“æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶ä¼šç«‹å³é€šçŸ¥ä½ 

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
```
inotify = Linuxå†…æ ¸æä¾›çš„æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶ç›‘æ§æœºåˆ¶
ä½œç”¨ï¼šå®æ—¶ç›‘æ§æ–‡ä»¶å’Œç›®å½•çš„å˜åŒ–ï¼ˆåˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ç­‰ï¼‰
ä¼˜åŠ¿ï¼šæ¯”è½®è¯¢æ–¹å¼æ›´é«˜æ•ˆï¼Œå ç”¨èµ„æºå°‘
```

**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
â”Œâ”€ ğŸ’­ ç”Ÿæ´»ç±»æ¯” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼ ç»Ÿè½®è¯¢ = æ¯éš”å‡ åˆ†é’Ÿå»çœ‹é‚®ç®±  â”‚
â”‚ inotify  = é‚®ç®±æœ‰æ–°é‚®ä»¶ç«‹å³æé†’â”‚
â”‚                               â”‚
â”‚ æ˜¾ç„¶ç¬¬äºŒç§æ–¹å¼æ›´é«˜æ•ˆï¼        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 inotifyå·¥å…·ç®€ä»‹


**ä¸»è¦å·¥å…·å¯¹æ¯”**ï¼š
| å·¥å…· | **ä½œç”¨** | **ä½¿ç”¨åœºæ™¯** |
|------|----------|-------------|
| `inotifywait` | ç­‰å¾…äº‹ä»¶å‘ç”Ÿ | è„šæœ¬ä¸­ç›‘æ§æ–‡ä»¶å˜åŒ– |
| `inotifywatch` | ç»Ÿè®¡äº‹ä»¶æ¬¡æ•° | åˆ†ææ–‡ä»¶è®¿é—®æ¨¡å¼ |

**åŸºç¡€è¯­æ³•**ï¼š
```bash
# æœ€ç®€å•çš„ç”¨æ³•
inotifywait /path/to/watch

# å¸¸ç”¨å‚æ•°ç»„åˆ
inotifywait -m -e modify,create,delete /path/to/watch
```

**å‚æ•°å«ä¹‰**ï¼š
- `-m`ï¼šæŒç»­ç›‘æ§ï¼ˆmonitorï¼‰ï¼Œä¸é€€å‡º
- `-e`ï¼šæŒ‡å®šè¦ç›‘æ§çš„äº‹ä»¶ç±»å‹
- `-r`ï¼šé€’å½’ç›‘æ§å­ç›®å½•

---

## 2. ğŸ”„ while readå¾ªç¯å¤„ç†äº‹ä»¶


### 2.1 åŸºæœ¬å¾ªç¯ç»“æ„


> **ğŸ” æ ¸å¿ƒç†è§£**ï¼šwhile readå¾ªç¯æ˜¯å¤„ç†inotifyäº‹ä»¶çš„æ ‡å‡†æ¨¡å¼

**åŸºç¡€æ¨¡æ¿**ï¼š
```bash
#!/bin/bash

# åŸºç¡€äº‹ä»¶å¤„ç†å¾ªç¯
inotifywait -m -e create,modify,delete /home/user/watched/ | \
while read path action file; do
    echo "æ£€æµ‹åˆ°å˜åŒ–: $file åœ¨ $path å‘ç”Ÿäº† $action"
done
```

**å·¥ä½œæµç¨‹å›¾**ï¼š
```
inotifywaitå¯åŠ¨
       â†“
   ç›‘æ§ç›®å½•å˜åŒ–
       â†“
   äº‹ä»¶å‘ç”Ÿæ—¶è¾“å‡º
       â†“
while readæ¥æ”¶è¾“å‡º
       â†“
   è§£æäº‹ä»¶ä¿¡æ¯
       â†“
   æ‰§è¡Œç›¸åº”å¤„ç†
       â†“
   ç»§ç»­ç­‰å¾…ä¸‹ä¸€ä¸ªäº‹ä»¶
```

### 2.2 æ”¹è¿›çš„å¾ªç¯å¤„ç†


**æ·»åŠ æ—¶é—´æˆ³å’Œæ—¥å¿—**ï¼š
```bash
#!/bin/bash

LOG_FILE="/var/log/file_monitor.log"
WATCH_DIR="/home/user/documents/"

echo "å¼€å§‹ç›‘æ§ç›®å½•: $WATCH_DIR" | tee -a "$LOG_FILE"

inotifywait -m -r -e create,modify,delete,move "$WATCH_DIR" | \
while read path action file; do
    timestamp=$(date "+%Y-%m-%d %H:%M:%S")
    echo "[$timestamp] $path$file: $action" | tee -a "$LOG_FILE"
    
    # è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„å¤„ç†é€»è¾‘
    case "$action" in
        "CREATE")
            echo "æ–°æ–‡ä»¶åˆ›å»ºï¼Œæ‰§è¡Œå¤‡ä»½æ“ä½œ..."
            ;;
        "MODIFY")
            echo "æ–‡ä»¶è¢«ä¿®æ”¹ï¼Œæ£€æŸ¥å†…å®¹å˜åŒ–..."
            ;;
        "DELETE")
            echo "æ–‡ä»¶è¢«åˆ é™¤ï¼Œè®°å½•åˆ é™¤ä¿¡æ¯..."
            ;;
    esac
done
```

**è„šæœ¬è§£æ**ï¼š
- `tee -a`ï¼šæ—¢æ˜¾ç¤ºåœ¨å±å¹•ä¸Šåˆè¿½åŠ åˆ°æ—¥å¿—æ–‡ä»¶
- `case`è¯­å¥ï¼šæ ¹æ®ä¸åŒäº‹ä»¶ç±»å‹æ‰§è¡Œä¸åŒæ“ä½œ
- æ—¶é—´æˆ³ï¼šè®°å½•äº‹ä»¶å‘ç”Ÿçš„ç²¾ç¡®æ—¶é—´

---

## 3. ğŸ“‹ äº‹ä»¶å‚æ•°è§£æä¸å¤„ç†


### 3.1 inotifyäº‹ä»¶ç±»å‹è¯¦è§£


**å¸¸ç”¨äº‹ä»¶ç±»å‹**ï¼š
```bash
# æ ¸å¿ƒäº‹ä»¶ç±»å‹è¯´æ˜
CREATE     # æ–‡ä»¶/ç›®å½•è¢«åˆ›å»º
MODIFY     # æ–‡ä»¶å†…å®¹è¢«ä¿®æ”¹  
DELETE     # æ–‡ä»¶/ç›®å½•è¢«åˆ é™¤
MOVE       # æ–‡ä»¶/ç›®å½•è¢«ç§»åŠ¨æˆ–é‡å‘½å
CLOSE_WRITE # æ–‡ä»¶å†™å…¥å®Œæˆå¹¶å…³é—­
OPEN       # æ–‡ä»¶è¢«æ‰“å¼€
ACCESS     # æ–‡ä»¶è¢«è¯»å–
```

**äº‹ä»¶ç»„åˆä½¿ç”¨**ï¼š
```bash
# ç›‘æ§æ–‡ä»¶ç¼–è¾‘å®Œæˆï¼ˆæ¨èï¼‰
inotifywait -m -e close_write /path/to/file

# ç›‘æ§ç›®å½•ç»“æ„å˜åŒ–
inotifywait -m -e create,delete,move /path/to/dir

# ç›‘æ§æ‰€æœ‰è®¿é—®æ´»åŠ¨ï¼ˆè°ƒè¯•ç”¨ï¼‰
inotifywait -m -e all /path/to/monitor
```

### 3.2 å‚æ•°è§£ææŠ€å·§


**æ ‡å‡†ä¸‰å‚æ•°è§£æ**ï¼š
```bash
#!/bin/bash

inotifywait -m -r -e create,modify,delete /home/user/test/ | \
while read path action file; do
    # path: ç›‘æ§çš„ç›®å½•è·¯å¾„ï¼ˆä»¥/ç»“å°¾ï¼‰
    # action: äº‹ä»¶ç±»å‹ï¼ˆCREATE, MODIFYç­‰ï¼‰
    # file: å‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶å
    
    full_path="${path}${file}"
    echo "å®Œæ•´è·¯å¾„: $full_path"
    echo "äº‹ä»¶ç±»å‹: $action"
    echo "æ–‡ä»¶å: $file"
    echo "---"
done
```

**é«˜çº§å‚æ•°è§£æ**ï¼š
```bash
#!/bin/bash

# ä½¿ç”¨æ ¼å¼åŒ–è¾“å‡ºè·å–æ›´å¤šä¿¡æ¯
inotifywait -m -r --format '%w%f %e %T' --timefmt '%Y-%m-%d %H:%M:%S' \
  -e create,modify,delete /home/user/test/ | \
while read file_path event_type timestamp; do
    echo "æ—¶é—´: $timestamp"
    echo "æ–‡ä»¶: $file_path"  
    echo "äº‹ä»¶: $event_type"
    
    # æ ¹æ®æ–‡ä»¶æ‰©å±•åè¿›è¡Œä¸åŒå¤„ç†
    case "$file_path" in
        *.txt)
            echo "è¿™æ˜¯æ–‡æœ¬æ–‡ä»¶ï¼Œæ‰§è¡Œæ–‡æœ¬å¤„ç†..."
            ;;
        *.jpg|*.png)
            echo "è¿™æ˜¯å›¾ç‰‡æ–‡ä»¶ï¼Œæ‰§è¡Œå›¾ç‰‡å¤„ç†..."
            ;;
        *.log)
            echo "è¿™æ˜¯æ—¥å¿—æ–‡ä»¶ï¼Œæ‰§è¡Œæ—¥å¿—åˆ†æ..."
            ;;
    esac
    echo "=========="
done
```

---

## 4. âš–ï¸ æ¡ä»¶åˆ¤æ–­ä¸äº‹ä»¶åˆ†ç±»


### 4.1 åŸºäºäº‹ä»¶ç±»å‹çš„åˆ†ç±»å¤„ç†


**äº‹ä»¶åˆ†ç±»å¤„ç†æ¨¡æ¿**ï¼š
```bash
#!/bin/bash

process_file_event() {
    local file_path="$1"
    local event_type="$2"
    local timestamp="$3"
    
    case "$event_type" in
        "CREATE"|"MOVED_TO")
            handle_file_created "$file_path" "$timestamp"
            ;;
        "MODIFY"|"CLOSE_WRITE")
            handle_file_modified "$file_path" "$timestamp"
            ;;
        "DELETE"|"MOVED_FROM")
            handle_file_deleted "$file_path" "$timestamp"
            ;;
        *)
            echo "æœªå¤„ç†çš„äº‹ä»¶ç±»å‹: $event_type"
            ;;
    esac
}

handle_file_created() {
    local file="$1"
    local time="$2"
    echo "[$time] æ–°æ–‡ä»¶åˆ›å»º: $file"
    
    # æ£€æŸ¥æ–‡ä»¶å¤§å°
    if [ -f "$file" ] && [ $(stat -c%s "$file") -gt 1048576 ]; then
        echo "è­¦å‘Š: å¤§æ–‡ä»¶åˆ›å»º (>1MB)"
    fi
}

handle_file_modified() {
    local file="$1"
    local time="$2"
    echo "[$time] æ–‡ä»¶ä¿®æ”¹: $file"
    
    # åˆ›å»ºå¤‡ä»½
    if [ -f "$file" ]; then
        backup_dir="/backup/$(dirname "$file")"
        mkdir -p "$backup_dir"
        cp "$file" "$backup_dir/$(basename "$file").bak.$(date +%s)"
    fi
}

handle_file_deleted() {
    local file="$1"
    local time="$2"
    echo "[$time] æ–‡ä»¶åˆ é™¤: $file"
    
    # è®°å½•åˆ é™¤æ—¥å¿—
    echo "$time: $file" >> /var/log/deleted_files.log
}
```

### 4.2 åŸºäºæ–‡ä»¶ç±»å‹çš„åˆ†ç±»å¤„ç†


**æ–‡ä»¶æ‰©å±•ååˆ†ç±»**ï¼š
```bash
#!/bin/bash

classify_and_process() {
    local file_path="$1"
    local action="$2"
    
    # è·å–æ–‡ä»¶æ‰©å±•å
    extension="${file_path##*.}"
    extension=$(echo "$extension" | tr '[:upper:]' '[:lower:]')
    
    case "$extension" in
        # æ–‡æ¡£æ–‡ä»¶
        "txt"|"doc"|"docx"|"pdf")
            process_document "$file_path" "$action"
            ;;
        # å›¾ç‰‡æ–‡ä»¶  
        "jpg"|"jpeg"|"png"|"gif"|"bmp")
            process_image "$file_path" "$action"
            ;;
        # ä»£ç æ–‡ä»¶
        "sh"|"py"|"js"|"html"|"css")
            process_code "$file_path" "$action"
            ;;
        # é…ç½®æ–‡ä»¶
        "conf"|"cfg"|"ini"|"json"|"xml")
            process_config "$file_path" "$action"
            ;;
        *)
            echo "æœªåˆ†ç±»æ–‡ä»¶: $file_path ($extension)"
            ;;
    esac
}

process_document() {
    local file="$1"
    local action="$2"
    echo "å¤„ç†æ–‡æ¡£æ–‡ä»¶: $file ($action)"
    
    if [ "$action" = "MODIFY" ]; then
        # æ–‡æ¡£ä¿®æ”¹æ—¶åˆ›å»ºç‰ˆæœ¬å¤‡ä»½
        backup_with_version "$file"
    fi
}

process_image() {
    local file="$1"  
    local action="$2"
    echo "å¤„ç†å›¾ç‰‡æ–‡ä»¶: $file ($action)"
    
    if [ "$action" = "CREATE" ] && [ -f "$file" ]; then
        # æ–°å›¾ç‰‡åˆ›å»ºæ—¶ç”Ÿæˆç¼©ç•¥å›¾
        generate_thumbnail "$file"
    fi
}
```

---

## 5. ğŸ”€ å¤šç›®å½•å¹¶å‘ç›‘æ§å®ç°


### 5.1 å¤šè¿›ç¨‹ç›‘æ§æ–¹æ¡ˆ


> **ğŸ’¡ æ ¸å¿ƒæ€è·¯**ï¼šä¸ºæ¯ä¸ªç›®å½•å¯åŠ¨ä¸€ä¸ªç‹¬ç«‹çš„ç›‘æ§è¿›ç¨‹ï¼Œå®ç°å¹¶å‘ç›‘æ§

**å¤šç›®å½•ç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash

# è¦ç›‘æ§çš„ç›®å½•åˆ—è¡¨
WATCH_DIRS=(
    "/home/user/documents"
    "/home/user/downloads" 
    "/var/log/application"
    "/etc/myapp"
)

# å­˜å‚¨å­è¿›ç¨‹PIDçš„æ•°ç»„
declare -a CHILD_PIDS

# æ¸…ç†å‡½æ•°
cleanup() {
    echo "æ­£åœ¨åœæ­¢æ‰€æœ‰ç›‘æ§è¿›ç¨‹..."
    for pid in "${CHILD_PIDS[@]}"; do
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid"
            echo "åœæ­¢è¿›ç¨‹: $pid"
        fi
    done
    exit 0
}

# æ³¨å†Œæ¸…ç†å‡½æ•°
trap cleanup SIGTERM SIGINT

# å•ä¸ªç›®å½•ç›‘æ§å‡½æ•°
monitor_directory() {
    local watch_dir="$1"
    local log_prefix="[$(basename "$watch_dir")]"
    
    echo "$log_prefix å¼€å§‹ç›‘æ§: $watch_dir"
    
    inotifywait -m -r -e create,modify,delete,move "$watch_dir" | \
    while read path action file; do
        timestamp=$(date "+%Y-%m-%d %H:%M:%S")
        echo "$log_prefix [$timestamp] $path$file: $action"
        
        # é’ˆå¯¹ä¸åŒç›®å½•çš„ç‰¹æ®Šå¤„ç†
        case "$watch_dir" in
            "/var/log/application")
                # æ—¥å¿—ç›®å½•ç‰¹æ®Šå¤„ç†
                if [[ "$file" == *.log && "$action" == "MODIFY" ]]; then
                    echo "$log_prefix æ£€æµ‹åˆ°æ—¥å¿—æ–‡ä»¶æ›´æ–°"
                fi
                ;;
            "/etc/myapp")
                # é…ç½®ç›®å½•ç‰¹æ®Šå¤„ç†
                if [[ "$action" == "MODIFY" ]]; then
                    echo "$log_prefix é…ç½®æ–‡ä»¶å·²ä¿®æ”¹ï¼Œå¯èƒ½éœ€è¦é‡å¯æœåŠ¡"
                fi
                ;;
        esac
    done
}

# å¯åŠ¨æ‰€æœ‰ç›‘æ§è¿›ç¨‹
for dir in "${WATCH_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        monitor_directory "$dir" &
        CHILD_PIDS+=($!)
        echo "ä¸ºç›®å½• $dir å¯åŠ¨ç›‘æ§è¿›ç¨‹ï¼ŒPID: ${CHILD_PIDS[-1]}"
    else
        echo "è­¦å‘Š: ç›®å½•ä¸å­˜åœ¨ $dir"
    fi
done

echo "æ‰€æœ‰ç›‘æ§è¿›ç¨‹å·²å¯åŠ¨ï¼Œæ€»è®¡: ${#CHILD_PIDS[@]} ä¸ª"
echo "æŒ‰ Ctrl+C åœæ­¢æ‰€æœ‰ç›‘æ§"

# ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹
wait
```

### 5.2 ç»Ÿä¸€äº‹ä»¶å¤„ç†ä¸­å¿ƒ


**äº‹ä»¶æ±‡æ€»å¤„ç†æ–¹æ¡ˆ**ï¼š
```bash
#!/bin/bash

# å‘½åç®¡é“ç”¨äºè¿›ç¨‹é—´é€šä¿¡
FIFO_FILE="/tmp/inotify_events.fifo"

# åˆ›å»ºå‘½åç®¡é“
create_fifo() {
    if [ ! -p "$FIFO_FILE" ]; then
        mkfifo "$FIFO_FILE"
        echo "åˆ›å»ºå‘½åç®¡é“: $FIFO_FILE"
    fi
}

# æ¸…ç†èµ„æº
cleanup_fifo() {
    if [ -p "$FIFO_FILE" ]; then
        rm -f "$FIFO_FILE"
        echo "æ¸…ç†å‘½åç®¡é“: $FIFO_FILE"
    fi
}

# äº‹ä»¶æ”¶é›†å™¨ï¼ˆåœ¨åå°è¿è¡Œï¼‰
start_event_collector() {
    local watch_dir="$1"
    local dir_tag="$(basename "$watch_dir")"
    
    inotifywait -m -r --format "$dir_tag|%w%f|%e|%T" \
      --timefmt '%Y-%m-%d %H:%M:%S' \
      -e create,modify,delete,move "$watch_dir" >> "$FIFO_FILE" &
    
    echo $!  # è¿”å›å­è¿›ç¨‹PID
}

# ç»Ÿä¸€äº‹ä»¶å¤„ç†å™¨
process_events() {
    while IFS='|' read -r dir_tag file_path event_type timestamp; do
        echo "[$timestamp] [$dir_tag] $file_path: $event_type"
        
        # ç»Ÿä¸€çš„äº‹ä»¶å¤„ç†é€»è¾‘
        case "$event_type" in
            "CREATE")
                echo "  â†’ æ–‡ä»¶åˆ›å»ºå¤„ç†é€»è¾‘"
                ;;
            "MODIFY")
                echo "  â†’ æ–‡ä»¶ä¿®æ”¹å¤„ç†é€»è¾‘"
                ;;
            "DELETE")
                echo "  â†’ æ–‡ä»¶åˆ é™¤å¤„ç†é€»è¾‘"
                ;;
        esac
        
        # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ•°æ®åº“è®°å½•ã€é‚®ä»¶é€šçŸ¥ç­‰
        
    done < "$FIFO_FILE"
}

# ä¸»ç¨‹åº
main() {
    create_fifo
    
    # å¯åŠ¨å¤šä¸ªç›®å½•ç›‘æ§
    declare -a PIDS
    for dir in "/home/user/test1" "/home/user/test2" "/var/log"; do
        if [ -d "$dir" ]; then
            pid=$(start_event_collector "$dir")
            PIDS+=($pid)
            echo "å¯åŠ¨ç›‘æ§: $dir (PID: $pid)"
        fi
    done
    
    # å¯åŠ¨äº‹ä»¶å¤„ç†å™¨
    process_events &
    PROCESSOR_PID=$!
    
    # æ¸…ç†å‡½æ•°
    cleanup() {
        echo "æ­£åœ¨æ¸…ç†èµ„æº..."
        for pid in "${PIDS[@]}" "$PROCESSOR_PID"; do
            kill "$pid" 2>/dev/null
        done
        cleanup_fifo
        exit 0
    }
    
    trap cleanup SIGTERM SIGINT
    
    echo "å¤šç›®å½•ç›‘æ§å·²å¯åŠ¨ï¼ŒæŒ‰ Ctrl+C åœæ­¢"
    wait
}

main "$@"
```

---

## 6. ğŸ“Š æ—¥å¿—è®°å½•ä¸äº‹ä»¶å­˜å‚¨


### 6.1 ç»“æ„åŒ–æ—¥å¿—è®°å½•


> **ğŸ” é‡ç‚¹ç†è§£**ï¼šå¥½çš„æ—¥å¿—è®°å½•æ˜¯ç›‘æ§ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œéœ€è¦åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯ä¾¿äºåç»­åˆ†æ

**æ ‡å‡†æ—¥å¿—æ ¼å¼**ï¼š
```bash
#!/bin/bash

# æ—¥å¿—é…ç½®
LOG_DIR="/var/log/inotify"
LOG_FILE="$LOG_DIR/file_events.log"
ERROR_LOG="$LOG_DIR/errors.log"

# ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
mkdir -p "$LOG_DIR"

# æ—¥å¿—è½®è½¬é…ç½®
MAX_LOG_SIZE=10485760  # 10MB
MAX_LOG_FILES=5

# æ ‡å‡†åŒ–æ—¥å¿—è®°å½•å‡½æ•°
log_event() {
    local level="$1"      # INFO, WARN, ERROR
    local category="$2"   # FILE, DIR, SYSTEM
    local action="$3"     # CREATE, MODIFY, DELETE
    local path="$4"       # æ–‡ä»¶è·¯å¾„
    local details="$5"    # é¢å¤–ä¿¡æ¯
    
    local timestamp=$(date "+%Y-%m-%d %H:%M:%S")
    local hostname=$(hostname)
    local pid=$$
    
    # æ„é€ æ—¥å¿—æ¡ç›®
    local log_entry="$timestamp|$hostname|$pid|$level|$category|$action|$path|$details"
    
    # å†™å…¥æ—¥å¿—æ–‡ä»¶
    echo "$log_entry" >> "$LOG_FILE"
    
    # å¦‚æœæ˜¯é”™è¯¯ï¼ŒåŒæ—¶å†™å…¥é”™è¯¯æ—¥å¿—
    if [ "$level" = "ERROR" ]; then
        echo "$log_entry" >> "$ERROR_LOG"
    fi
    
    # æ§åˆ¶å°è¾“å‡ºï¼ˆå¯é€‰ï¼‰
    if [ "$VERBOSE" = "1" ]; then
        echo "[$level] $category $action: $path"
        [ -n "$details" ] && echo "  è¯¦æƒ…: $details"
    fi
}

# æ—¥å¿—è½®è½¬å‡½æ•°
rotate_log() {
    local log_file="$1"
    
    if [ -f "$log_file" ] && [ $(stat -c%s "$log_file") -gt $MAX_LOG_SIZE ]; then
        echo "å¼€å§‹æ—¥å¿—è½®è½¬: $log_file"
        
        # ç§»åŠ¨æ—§æ—¥å¿—æ–‡ä»¶
        for i in $(seq $((MAX_LOG_FILES-1)) -1 1); do
            if [ -f "${log_file}.$i" ]; then
                mv "${log_file}.$i" "${log_file}.$((i+1))"
            fi
        done
        
        mv "$log_file" "${log_file}.1"
        touch "$log_file"
        
        # åˆ é™¤è¿‡æœŸæ—¥å¿—
        if [ -f "${log_file}.$MAX_LOG_FILES" ]; then
            rm -f "${log_file}.$MAX_LOG_FILES"
        fi
        
        log_event "INFO" "SYSTEM" "ROTATE" "$log_file" "æ—¥å¿—è½®è½¬å®Œæˆ"
    fi
}

# ä½¿ç”¨ç¤ºä¾‹
monitor_with_logging() {
    local watch_dir="$1"
    
    log_event "INFO" "SYSTEM" "START" "$watch_dir" "å¼€å§‹ç›‘æ§"
    
    inotifywait -m -r --format '%w%f|%e|%T' --timefmt '%s' \
      -e create,modify,delete,move "$watch_dir" | \
    while IFS='|' read -r file_path event_type timestamp; do
        
        # å®šæœŸæ£€æŸ¥æ—¥å¿—è½®è½¬
        rotate_log "$LOG_FILE"
        
        # è®°å½•äº‹ä»¶
        case "$event_type" in
            "CREATE")
                log_event "INFO" "FILE" "CREATE" "$file_path" "æ–‡ä»¶å¤§å°: $(stat -c%s "$file_path" 2>/dev/null || echo "N/A")"
                ;;
            "MODIFY")
                log_event "INFO" "FILE" "MODIFY" "$file_path" "ä¿®æ”¹æ—¶é—´: $(date -d @$timestamp)"
                ;;
            "DELETE")
                log_event "WARN" "FILE" "DELETE" "$file_path" "æ–‡ä»¶å·²è¢«åˆ é™¤"
                ;;
            "MOVE")
                log_event "INFO" "FILE" "MOVE" "$file_path" "æ–‡ä»¶ç§»åŠ¨æˆ–é‡å‘½å"
                ;;
        esac
    done
}
```

### 6.2 æ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆ


**SQLiteå­˜å‚¨å®ç°**ï¼š
```bash
#!/bin/bash

DB_FILE="/var/lib/inotify/events.db"
DB_DIR="$(dirname "$DB_FILE")"

# åˆ›å»ºæ•°æ®åº“å’Œè¡¨
init_database() {
    mkdir -p "$DB_DIR"
    
    sqlite3 "$DB_FILE" <<EOF
CREATE TABLE IF NOT EXISTS file_events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp INTEGER NOT NULL,
    hostname TEXT NOT NULL,
    pid INTEGER NOT NULL,
    watch_path TEXT NOT NULL,
    file_path TEXT NOT NULL,
    event_type TEXT NOT NULL,
    file_size INTEGER,
    file_mode TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_timestamp ON file_events(timestamp);
CREATE INDEX IF NOT EXISTS idx_file_path ON file_events(file_path);
CREATE INDEX IF NOT EXISTS idx_event_type ON file_events(event_type);
EOF

    echo "æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ: $DB_FILE"
}

# æ’å…¥äº‹ä»¶è®°å½•
insert_event() {
    local watch_path="$1"
    local file_path="$2"
    local event_type="$3"
    local timestamp="$4"
    
    # è·å–æ–‡ä»¶ä¿¡æ¯ï¼ˆå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼‰
    local file_size="NULL"
    local file_mode="NULL"
    
    if [ -f "$file_path" ]; then
        file_size=$(stat -c%s "$file_path")
        file_mode=$(stat -c%a "$file_path")
    fi
    
    sqlite3 "$DB_FILE" <<EOF
INSERT INTO file_events (
    timestamp, hostname, pid, watch_path, file_path, 
    event_type, file_size, file_mode
) VALUES (
    $timestamp, '$(hostname)', $$, '$watch_path', '$file_path',
    '$event_type', $file_size, '$file_mode'
);
EOF
}

# æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯
query_statistics() {
    echo "=== äº‹ä»¶ç»Ÿè®¡ ==="
    sqlite3 "$DB_FILE" <<EOF
SELECT 
    event_type,
    COUNT(*) as count,
    MIN(datetime(timestamp, 'unixepoch')) as first_event,
    MAX(datetime(timestamp, 'unixepoch')) as last_event
FROM file_events 
GROUP BY event_type
ORDER BY count DESC;
EOF

    echo -e "\n=== æœ€æ´»è·ƒçš„æ–‡ä»¶ ==="
    sqlite3 "$DB_FILE" <<EOF
SELECT 
    file_path,
    COUNT(*) as events,
    GROUP_CONCAT(DISTINCT event_type) as event_types
FROM file_events 
GROUP BY file_path 
ORDER BY events DESC 
LIMIT 10;
EOF
}

# æ¸…ç†è€æ—§æ•°æ®
cleanup_old_data() {
    local days_to_keep=30
    local cutoff_timestamp=$(($(date +%s) - days_to_keep * 86400))
    
    local deleted_count=$(sqlite3 "$DB_FILE" "SELECT COUNT(*) FROM file_events WHERE timestamp < $cutoff_timestamp;")
    
    if [ "$deleted_count" -gt 0 ]; then
        sqlite3 "$DB_FILE" "DELETE FROM file_events WHERE timestamp < $cutoff_timestamp;"
        echo "æ¸…ç†äº† $deleted_count æ¡è¶…è¿‡ $days_to_keep å¤©çš„è®°å½•"
    fi
}
```

---

## 7. â— é”™è¯¯å¤„ç†ä¸å¼‚å¸¸æ¢å¤


### 7.1 å¸¸è§é”™è¯¯å¤„ç†


> **âš ï¸ é‡è¦æé†’**ï¼šç›‘æ§è„šæœ¬éœ€è¦é•¿æ—¶é—´è¿è¡Œï¼Œå¿…é¡»å…·å¤‡è‰¯å¥½çš„é”™è¯¯å¤„ç†å’Œè‡ªåŠ¨æ¢å¤èƒ½åŠ›

**é”™è¯¯ç±»å‹ä¸å¤„ç†ç­–ç•¥**ï¼š
```bash
#!/bin/bash

# é”™è¯¯ä»£ç å®šä¹‰
readonly ERR_DIR_NOT_EXIST=1
readonly ERR_PERMISSION_DENIED=2
readonly ERR_INOTIFY_LIMIT=3
readonly ERR_DISK_FULL=4
readonly ERR_LOG_WRITE_FAIL=5

# é”™è¯¯å¤„ç†å‡½æ•°
handle_error() {
    local error_code="$1"
    local error_msg="$2"
    local context="$3"
    
    local timestamp=$(date "+%Y-%m-%d %H:%M:%S")
    
    case "$error_code" in
        $ERR_DIR_NOT_EXIST)
            echo "[$timestamp] é”™è¯¯: ç›‘æ§ç›®å½•ä¸å­˜åœ¨ - $context"
            echo "å°è¯•åˆ›å»ºç›®å½•æˆ–æ£€æŸ¥è·¯å¾„é…ç½®"
            return 1
            ;;
        $ERR_PERMISSION_DENIED)
            echo "[$timestamp] é”™è¯¯: æƒé™ä¸è¶³ - $context"
            echo "è¯·æ£€æŸ¥ç›®å½•æƒé™æˆ–ä½¿ç”¨é€‚å½“çš„ç”¨æˆ·è¿è¡Œè„šæœ¬"
            return 1
            ;;
        $ERR_INOTIFY_LIMIT)
            echo "[$timestamp] é”™è¯¯: inotifyç›‘æ§æ•°é‡è¾¾åˆ°ç³»ç»Ÿé™åˆ¶ - $context"
            echo "å¢åŠ ç³»ç»Ÿé™åˆ¶: echo 8192 > /proc/sys/fs/inotify/max_user_watches"
            return 2  # å¯æ¢å¤é”™è¯¯
            ;;
        $ERR_DISK_FULL)
            echo "[$timestamp] é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³ - $context"
            echo "æ¸…ç†æ—¥å¿—æ–‡ä»¶æˆ–å¢åŠ å­˜å‚¨ç©ºé—´"
            return 2
            ;;
        *)
            echo "[$timestamp] æœªçŸ¥é”™è¯¯: $error_msg - $context"
            return 1
            ;;
    esac
}

# ç›‘æ§ç›®å½•æœ‰æ•ˆæ€§æ£€æŸ¥
validate_watch_directory() {
    local watch_dir="$1"
    
    if [ ! -e "$watch_dir" ]; then
        handle_error $ERR_DIR_NOT_EXIST "ç›®å½•ä¸å­˜åœ¨" "$watch_dir"
        return $?
    fi
    
    if [ ! -d "$watch_dir" ]; then
        handle_error $ERR_DIR_NOT_EXIST "è·¯å¾„ä¸æ˜¯ç›®å½•" "$watch_dir" 
        return $?
    fi
    
    if [ ! -r "$watch_dir" ]; then
        handle_error $ERR_PERMISSION_DENIED "æ— è¯»å–æƒé™" "$watch_dir"
        return $?
    fi
    
    echo "ç›®å½•éªŒè¯é€šè¿‡: $watch_dir"
    return 0
}

# å¸¦é‡è¯•çš„ç›‘æ§å¯åŠ¨
start_monitoring_with_retry() {
    local watch_dir="$1"
    local max_retries=3
    local retry_count=0
    local retry_delay=5
    
    while [ $retry_count -lt $max_retries ]; do
        echo "å¯åŠ¨ç›‘æ§ (å°è¯• $((retry_count + 1))/$max_retries): $watch_dir"
        
        # éªŒè¯ç›®å½•
        if ! validate_watch_directory "$watch_dir"; then
            echo "ç›®å½•éªŒè¯å¤±è´¥ï¼Œç­‰å¾… $retry_delay ç§’åé‡è¯•..."
            sleep $retry_delay
            retry_count=$((retry_count + 1))
            retry_delay=$((retry_delay * 2))  # æŒ‡æ•°é€€é¿
            continue
        fi
        
        # å¯åŠ¨inotifyç›‘æ§
        inotifywait -m -r -e create,modify,delete "$watch_dir" 2>/tmp/inotify_error.log | \
        while read path action file; do
            # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯è¾“å‡º
            if [ -s /tmp/inotify_error.log ]; then
                local error_msg=$(cat /tmp/inotify_error.log)
                
                if echo "$error_msg" | grep -q "No space left on device"; then
                    handle_error $ERR_DISK_FULL "$error_msg" "$watch_dir"
                    break
                elif echo "$error_msg" | grep -q "upper limit"; then
                    handle_error $ERR_INOTIFY_LIMIT "$error_msg" "$watch_dir"
                    break
                fi
            fi
            
            # æ­£å¸¸äº‹ä»¶å¤„ç†
            echo "äº‹ä»¶: $path$file -> $action"
            
        done
        
        # å¦‚æœåˆ°è¿™é‡Œè¯´æ˜ç›‘æ§å¼‚å¸¸é€€å‡º
        echo "ç›‘æ§è¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼Œå‡†å¤‡é‡å¯..."
        retry_count=$((retry_count + 1))
        
        if [ $retry_count -lt $max_retries ]; then
            echo "ç­‰å¾… $retry_delay ç§’åé‡è¯•..."
            sleep $retry_delay
        fi
    done
    
    echo "è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œç›‘æ§å¯åŠ¨å¤±è´¥: $watch_dir"
    return 1
}
```

### 7.2 è‡ªåŠ¨æ¢å¤æœºåˆ¶


**å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨é‡å¯**ï¼š
```bash
#!/bin/bash

# è¿›ç¨‹ç®¡ç†é…ç½®
PID_FILE="/var/run/inotify_monitor.pid"
WATCH_DIR="/home/user/monitored"
LOG_FILE="/var/log/inotify_monitor.log"

# å¥åº·æ£€æŸ¥å‡½æ•°
check_health() {
    local pid_file="$1"
    
    if [ ! -f "$pid_file" ]; then
        echo "PIDæ–‡ä»¶ä¸å­˜åœ¨: $pid_file"
        return 1
    fi
    
    local pid=$(cat "$pid_file")
    
    if ! kill -0 "$pid" 2>/dev/null; then
        echo "è¿›ç¨‹ä¸å­˜åœ¨: PID $pid"
        rm -f "$pid_file"
        return 1
    fi
    
    # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨ç›‘æ§ï¼ˆé€šè¿‡æ£€æŸ¥æ˜¯å¦æœ‰inotifyç›¸å…³è¿›ç¨‹ï¼‰
    if ! pgrep -f "inotifywait.*$WATCH_DIR" >/dev/null; then
        echo "ç›‘æ§è¿›ç¨‹å·²åœæ­¢å·¥ä½œ"
        return 1
    fi
    
    echo "è¿›ç¨‹å¥åº·: PID $pid"
    return 0
}

# å¯åŠ¨ç›‘æ§æœåŠ¡
start_service() {
    local watch_dir="$1"
    
    if check_health "$PID_FILE"; then
        echo "æœåŠ¡å·²åœ¨è¿è¡Œ"
        return 0
    fi
    
    echo "å¯åŠ¨inotifyç›‘æ§æœåŠ¡..."
    
    # åå°å¯åŠ¨ç›‘æ§
    nohup bash -c "
        echo \$\$ > '$PID_FILE'
        exec inotifywait -m -r -e create,modify,delete '$watch_dir' | \\
        while read path action file; do
            echo \"\$(date '+%Y-%m-%d %H:%M:%S') \$path\$file: \$action\" >> '$LOG_FILE'
        done
    " >/dev/null 2>&1 &
    
    sleep 2
    
    if check_health "$PID_FILE"; then
        echo "æœåŠ¡å¯åŠ¨æˆåŠŸ"
        return 0
    else
        echo "æœåŠ¡å¯åŠ¨å¤±è´¥"
        return 1
    fi
}

# åœæ­¢ç›‘æ§æœåŠ¡
stop_service() {
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        echo "åœæ­¢æœåŠ¡: PID $pid"
        
        # ä¼˜é›…åœæ­¢
        kill "$pid" 2>/dev/null
        sleep 2
        
        # å¼ºåˆ¶åœæ­¢
        if kill -0 "$pid" 2>/dev/null; then
            kill -9 "$pid" 2>/dev/null
            echo "å¼ºåˆ¶åœæ­¢è¿›ç¨‹"
        fi
        
        rm -f "$PID_FILE"
        echo "æœåŠ¡å·²åœæ­¢"
    else
        echo "æœåŠ¡æœªè¿è¡Œ"
    fi
}

# é‡å¯æœåŠ¡
restart_service() {
    echo "é‡å¯ç›‘æ§æœåŠ¡..."
    stop_service
    sleep 1
    start_service "$WATCH_DIR"
}

# ç›‘æ§å®ˆæŠ¤è¿›ç¨‹
daemon_monitor() {
    local check_interval=60  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    
    echo "å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼Œæ£€æŸ¥é—´éš”: ${check_interval}ç§’"
    
    while true; do
        if ! check_health "$PID_FILE"; then
            echo "æ£€æµ‹åˆ°æœåŠ¡å¼‚å¸¸ï¼Œå°è¯•é‡å¯..."
            restart_service
        fi
        
        sleep $check_interval
    done
}

# ä¸»ç¨‹åºå…¥å£
case "$1" in
    "start")
        start_service "$WATCH_DIR"
        ;;
    "stop")
        stop_service
        ;;
    "restart")
        restart_service
        ;;
    "status")
        check_health "$PID_FILE"
        ;;
    "daemon")
        daemon_monitor
        ;;
    *)
        echo "ç”¨æ³•: $0 {start|stop|restart|status|daemon}"
        echo "  start  - å¯åŠ¨ç›‘æ§æœåŠ¡"
        echo "  stop   - åœæ­¢ç›‘æ§æœåŠ¡"  
        echo "  restart- é‡å¯ç›‘æ§æœåŠ¡"
        echo "  status - æ£€æŸ¥æœåŠ¡çŠ¶æ€"
        echo "  daemon - å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹"
        exit 1
        ;;
esac
```

---

## 8. ğŸ”„ è„šæœ¬åå°è¿è¡Œç®¡ç†


### 8.1 systemdæœåŠ¡é…ç½®


> **ğŸ’¡ æ¨èæ–¹æ³•**ï¼šä½¿ç”¨systemdç®¡ç†inotifyç›‘æ§è„šæœ¬ï¼Œå®ç°å¼€æœºè‡ªå¯å’Œè¿›ç¨‹ç®¡ç†

**åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶**ï¼š
```bash
# /etc/systemd/system/inotify-monitor.service
[Unit]
Description=File System Monitor using inotify
After=network.target
Wants=network.target

[Service]
Type=simple
User=monitor
Group=monitor
WorkingDirectory=/opt/inotify-monitor
ExecStart=/opt/inotify-monitor/monitor.sh /home/user/watched
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

# ç¯å¢ƒå˜é‡
Environment=WATCH_DIR=/home/user/watched
Environment=LOG_LEVEL=INFO

# èµ„æºé™åˆ¶
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
```

**æœåŠ¡ç®¡ç†è„šæœ¬**ï¼š
```bash
#!/bin/bash

SERVICE_NAME="inotify-monitor"
SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"
SCRIPT_DIR="/opt/inotify-monitor"
SCRIPT_FILE="$SCRIPT_DIR/monitor.sh"

# å®‰è£…æœåŠ¡
install_service() {
    echo "å®‰è£…inotifyç›‘æ§æœåŠ¡..."
    
    # åˆ›å»ºç”¨æˆ·å’Œç›®å½•
    if ! id -u monitor >/dev/null 2>&1; then
        sudo useradd -r -s /bin/false monitor
        echo "åˆ›å»ºç›‘æ§ç”¨æˆ·: monitor"
    fi
    
    sudo mkdir -p "$SCRIPT_DIR"
    sudo cp monitor.sh "$SCRIPT_FILE"
    sudo chown monitor:monitor "$SCRIPT_DIR" -R
    sudo chmod +x "$SCRIPT_FILE"
    
    # å¤åˆ¶æœåŠ¡æ–‡ä»¶
    sudo cp inotify-monitor.service "$SERVICE_FILE"
    
    # é‡æ–°åŠ è½½systemd
    sudo systemctl daemon-reload
    
    # å¯ç”¨æœåŠ¡
    sudo systemctl enable "$SERVICE_NAME"
    
    echo "æœåŠ¡å®‰è£…å®Œæˆ"
}

# æœåŠ¡æ“ä½œ
service_start() {
    echo "å¯åŠ¨æœåŠ¡..."
    sudo systemctl start "$SERVICE_NAME"
    sudo systemctl status "$SERVICE_NAME"
}

service_stop() {
    echo "åœæ­¢æœåŠ¡..."
    sudo systemctl stop "$SERVICE_NAME"
}

service_restart() {
    echo "é‡å¯æœåŠ¡..."
    sudo systemctl restart "$SERVICE_NAME"
    sudo systemctl status "$SERVICE_NAME"
}

service_status() {
    sudo systemctl status "$SERVICE_NAME"
}

# æŸ¥çœ‹æ—¥å¿—
view_logs() {
    local lines=${1:-50}
    echo "æ˜¾ç¤ºæœ€è¿‘ $lines è¡Œæ—¥å¿—:"
    sudo journalctl -u "$SERVICE_NAME" -n "$lines" -f
}

# å¸è½½æœåŠ¡
uninstall_service() {
    echo "å¸è½½æœåŠ¡..."
    sudo systemctl stop "$SERVICE_NAME" 2>/dev/null
    sudo systemctl disable "$SERVICE_NAME" 2>/dev/null
    sudo rm -f "$SERVICE_FILE"
    sudo systemctl daemon-reload
    echo "æœåŠ¡å·²å¸è½½"
}

case "$1" in
    "install")
        install_service
        ;;
    "start")
        service_start
        ;;
    "stop") 
        service_stop
        ;;
    "restart")
        service_restart
        ;;
    "status")
        service_status
        ;;
    "logs")
        view_logs "$2"
        ;;
    "uninstall")
        uninstall_service
        ;;
    *)
        echo "ç”¨æ³•: $0 {install|start|stop|restart|status|logs [lines]|uninstall}"
        exit 1
        ;;
esac
```

### 8.2 ä¼ ç»Ÿåå°è¿è¡Œæ–¹æ³•


**ä½¿ç”¨screen/tmuxç®¡ç†**ï¼š
```bash
#!/bin/bash

SCRIPT_NAME="inotify-monitor"
SCREEN_NAME="inotify-session"

# ä½¿ç”¨screenåå°è¿è¡Œ
start_with_screen() {
    local watch_dir="$1"
    
    if screen -list | grep -q "$SCREEN_NAME"; then
        echo "ç›‘æ§ä¼šè¯å·²å­˜åœ¨: $SCREEN_NAME"
        return 1
    fi
    
    echo "ä½¿ç”¨screenå¯åŠ¨åå°ç›‘æ§..."
    screen -dmS "$SCREEN_NAME" bash -c "
        echo 'å¼€å§‹ç›‘æ§: $watch_dir'
        inotifywait -m -r -e create,modify,delete '$watch_dir' | \\
        while read path action file; do
            echo \"\$(date '+%Y-%m-%d %H:%M:%S') \$path\$file: \$action\"
        done
    "
    
    sleep 1
    
    if screen -list | grep -q "$SCREEN_NAME"; then
        echo "åå°ç›‘æ§å¯åŠ¨æˆåŠŸ"
        echo "è¿æ¥åˆ°ç›‘æ§ä¼šè¯: screen -r $SCREEN_NAME"
        echo "é€€å‡ºä¼šè¯ä½†ä¿æŒè¿è¡Œ: Ctrl+A, D"
    else
        echo "å¯åŠ¨å¤±è´¥"
        return 1
    fi
}

# åœæ­¢screenä¼šè¯
stop_screen_session() {
    if screen -list | grep -q "$SCREEN_NAME"; then
        screen -S "$SCREEN_NAME" -X quit
        echo "åœæ­¢ç›‘æ§ä¼šè¯: $SCREEN_NAME"
    else
        echo "ç›‘æ§ä¼šè¯ä¸å­˜åœ¨"
    fi
}

# è¿æ¥åˆ°ç°æœ‰ä¼šè¯
attach_session() {
    if screen -list | grep -q "$SCREEN_NAME"; then
        screen -r "$SCREEN_NAME"
    else
        echo "ç›‘æ§ä¼šè¯ä¸å­˜åœ¨ï¼Œè¯·å…ˆå¯åŠ¨"
    fi
}

# æŸ¥çœ‹ä¼šè¯çŠ¶æ€
list_sessions() {
    echo "å½“å‰screenä¼šè¯:"
    screen -list
}

# nohupæ–¹æ³•ï¼ˆç®€å•ä½†åŠŸèƒ½æœ‰é™ï¼‰
start_with_nohup() {
    local watch_dir="$1"
    local log_file="/tmp/inotify-monitor.log"
    local pid_file="/tmp/inotify-monitor.pid"
    
    if [ -f "$pid_file" ] && kill -0 $(cat "$pid_file") 2>/dev/null; then
        echo "ç›‘æ§è¿›ç¨‹å·²åœ¨è¿è¡Œ: PID $(cat $pid_file)"
        return 1
    fi
    
    echo "ä½¿ç”¨nohupå¯åŠ¨åå°ç›‘æ§..."
    
    nohup inotifywait -m -r -e create,modify,delete "$watch_dir" 2>&1 | \
    while read path action file; do
        echo "$(date '+%Y-%m-%d %H:%M:%S') $path$file: $action"
    done > "$log_file" &
    
    echo $! > "$pid_file"
    
    echo "åå°ç›‘æ§å¯åŠ¨æˆåŠŸ: PID $!"
    echo "æ—¥å¿—æ–‡ä»¶: $log_file"
    echo "æŸ¥çœ‹æ—¥å¿—: tail -f $log_file"
}

case "$1" in
    "screen")
        case "$2" in
            "start")
                start_with_screen "$3"
                ;;
            "stop")
                stop_screen_session
                ;;
            "attach")
                attach_session
                ;;
            "list")
                list_sessions
                ;;
            *)
                echo "ç”¨æ³•: $0 screen {start <ç›®å½•>|stop|attach|list}"
                ;;
        esac
        ;;
    "nohup")
        start_with_nohup "$2"
        ;;
    *)
        echo "ç”¨æ³•: $0 {screen|nohup} [å‚æ•°...]"
        echo "  screen start <ç›®å½•> - ä½¿ç”¨screenå¯åŠ¨ç›‘æ§"
        echo "  screen stop         - åœæ­¢screenä¼šè¯"
        echo "  screen attach       - è¿æ¥åˆ°screenä¼šè¯"
        echo "  screen list         - åˆ—å‡ºæ‰€æœ‰ä¼šè¯"
        echo "  nohup <ç›®å½•>        - ä½¿ç”¨nohupå¯åŠ¨ç›‘æ§"
        ;;
esac
```

---

## 9. âš¡ ç›‘æ§è„šæœ¬æ€§èƒ½ä¼˜åŒ–


### 9.1 å‡å°‘ä¸å¿…è¦çš„äº‹ä»¶ç›‘æ§


> **ğŸ” æ ¸å¿ƒæ€è·¯**ï¼šåªç›‘æ§çœŸæ­£éœ€è¦çš„äº‹ä»¶ï¼Œé¿å…ç³»ç»Ÿèµ„æºæµªè´¹

**äº‹ä»¶è¿‡æ»¤ä¼˜åŒ–**ï¼š
```bash
#!/bin/bash

# é’ˆå¯¹ä¸åŒåœºæ™¯ä¼˜åŒ–äº‹ä»¶ç›‘æ§
optimize_events_for_scenario() {
    local scenario="$1"
    local watch_dir="$2"
    
    case "$scenario" in
        "backup")
            # å¤‡ä»½åœºæ™¯ï¼šåªå…³å¿ƒæ–‡ä»¶ä¿®æ”¹å®Œæˆ
            echo "å¤‡ä»½ç›‘æ§æ¨¡å¼: ç›‘æ§æ–‡ä»¶å†™å…¥å®Œæˆäº‹ä»¶"
            inotifywait -m -r -e close_write "$watch_dir"
            ;;
        "sync")
            # åŒæ­¥åœºæ™¯ï¼šç›‘æ§åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤
            echo "åŒæ­¥ç›‘æ§æ¨¡å¼: ç›‘æ§æ–‡ä»¶å˜æ›´äº‹ä»¶"
            inotifywait -m -r -e create,modify,delete,move "$watch_dir"
            ;;
        "security")
            # å®‰å…¨ç›‘æ§ï¼šç›‘æ§æ‰€æœ‰è®¿é—®
            echo "å®‰å…¨ç›‘æ§æ¨¡å¼: ç›‘æ§æ–‡ä»¶è®¿é—®äº‹ä»¶"
            inotifywait -m -r -e access,modify,attrib,move,create,delete "$watch_dir"
            ;;
        "development")
            # å¼€å‘åœºæ™¯ï¼šç›‘æ§ä»£ç æ–‡ä»¶ä¿®æ”¹
            echo "å¼€å‘ç›‘æ§æ¨¡å¼: ç›‘æ§ä»£ç æ–‡ä»¶ä¿®æ”¹"
            inotifywait -m -r -e close_write --include '.*\.(py|js|html|css|sh)$' "$watch_dir"
            ;;
        *)
            echo "æœªçŸ¥åœºæ™¯ï¼Œä½¿ç”¨é»˜è®¤ç›‘æ§"
            inotifywait -m -r -e create,modify,delete "$watch_dir"
            ;;
    esac
}

# æ–‡ä»¶ç±»å‹è¿‡æ»¤
setup_file_filters() {
    local watch_dir="$1"
    
    echo "è®¾ç½®æ™ºèƒ½æ–‡ä»¶è¿‡æ»¤..."
    
    # åªç›‘æ§ç‰¹å®šç±»å‹æ–‡ä»¶
    inotifywait -m -r \
        --include '.*\.(txt|doc|pdf|jpg|png|mp4|zip)$' \
        --exclude '.*\.(tmp|swp|~)$' \
        -e create,modify,delete \
        "$watch_dir" | \
    while read path action file; do
        # é¢å¤–è¿‡æ»¤ï¼šå¿½ç•¥éšè—æ–‡ä»¶å’Œä¸´æ—¶æ–‡ä»¶
        if [[ "$file" =~ ^\. ]] || [[ "$file" =~ .*\.tmp$ ]]; then
            continue
        fi
        
        echo "å¤„ç†æ–‡ä»¶: $path$file ($action)"
    done
}

# ç›®å½•æ·±åº¦é™åˆ¶
limit_directory_depth() {
    local watch_dir="$1"
    local max_depth="$2"
    
    echo "é™åˆ¶ç›‘æ§æ·±åº¦: $max_depth å±‚"
    
    # ä½¿ç”¨findé™åˆ¶æ·±åº¦ï¼Œç„¶åä¼ é€’ç»™inotifywait
    find "$watch_dir" -maxdepth "$max_depth" -type d | \
    while read dir; do
        echo "ç›‘æ§ç›®å½•: $dir"
        inotifywait -m -e create,modify,delete "$dir" &
    done
    
    wait  # ç­‰å¾…æ‰€æœ‰åå°è¿›ç¨‹
}
```

### 9.2 æ‰¹é‡äº‹ä»¶å¤„ç†


**äº‹ä»¶ç¼“å†²å’Œæ‰¹å¤„ç†**ï¼š
```bash
#!/bin/bash

# äº‹ä»¶æ‰¹å¤„ç†é…ç½®
BATCH_SIZE=50
BATCH_TIMEOUT=5
EVENT_BUFFER=()
LAST_BATCH_TIME=0

# è·å–å½“å‰æ—¶é—´æˆ³
get_timestamp() {
    date +%s
}

# æ·»åŠ äº‹ä»¶åˆ°ç¼“å†²åŒº
add_to_buffer() {
    local event_data="$1"
    
    EVENT_BUFFER+=("$event_data")
    
    local current_time=$(get_timestamp)
    local time_since_last_batch=$((current_time - LAST_BATCH_TIME))
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦å¤„ç†æ‰¹æ¬¡
    if [ ${#EVENT_BUFFER[@]} -ge $BATCH_SIZE ] || \
       [ $time_since_last_batch -ge $BATCH_TIMEOUT ]; then
        process_batch
    fi
}

# æ‰¹é‡å¤„ç†äº‹ä»¶
process_batch() {
    if [ ${#EVENT_BUFFER[@]} -eq 0 ]; then
        return
    fi
    
    local batch_size=${#EVENT_BUFFER[@]}
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    echo "[$timestamp] å¤„ç†äº‹ä»¶æ‰¹æ¬¡: $batch_size ä¸ªäº‹ä»¶"
    
    # æ‰¹é‡å†™å…¥æ—¥å¿—
    {
        echo "=== äº‹ä»¶æ‰¹æ¬¡å¼€å§‹ ($timestamp) ==="
        printf '%s\n' "${EVENT_BUFFER[@]}"
        echo "=== äº‹ä»¶æ‰¹æ¬¡ç»“æŸ ==="
        echo
    } >> /var/log/inotify_batch.log
    
    # åˆ†ç±»ç»Ÿè®¡
    local create_count=0
    local modify_count=0
    local delete_count=0
    
    for event in "${EVENT_BUFFER[@]}"; do
        case "$event" in
            *CREATE*) create_count=$((create_count + 1)) ;;
            *MODIFY*) modify_count=$((modify_count + 1)) ;;
            *DELETE*) delete_count=$((delete_count + 1)) ;;
        esac
    done
    
    echo "  åˆ›å»º: $create_count, ä¿®æ”¹: $modify_count, åˆ é™¤: $delete_count"
    
    # æ¸…ç©ºç¼“å†²åŒº
    EVENT_BUFFER=()
    LAST_BATCH_TIME=$(get_timestamp)
    
    # æ‰§è¡Œæ‰¹é‡ä¸šåŠ¡å¤„ç†
    execute_batch_operations "$batch_size"
}

# æ‰§è¡Œæ‰¹é‡ä¸šåŠ¡æ“ä½œ
execute_batch_operations() {
    local event_count="$1"
    
    # è¿™é‡Œå¯ä»¥æ‰§è¡Œå„ç§æ‰¹é‡æ“ä½œ
    echo "æ‰§è¡Œæ‰¹é‡æ“ä½œ: $event_count ä¸ªäº‹ä»¶"
    
    # ç¤ºä¾‹ï¼šæ‰¹é‡åŒæ­¥åˆ°è¿œç¨‹æœåŠ¡å™¨
    if [ $event_count -gt 10 ]; then
        echo "è§¦å‘å¢é‡å¤‡ä»½..."
        # rsync -av /watched/path/ backup-server:/backup/
    fi
    
    # ç¤ºä¾‹ï¼šæ‰¹é‡å‘é€é€šçŸ¥
    if [ $event_count -gt 100 ]; then
        echo "å‘é€é«˜æ´»è·ƒåº¦æŠ¥è­¦é‚®ä»¶..."
        # echo "æ£€æµ‹åˆ° $event_count ä¸ªæ–‡ä»¶å˜æ›´" | mail -s "æ–‡ä»¶æ´»åŠ¨æŠ¥å‘Š" admin@example.com
    fi
}

# å®šæ—¶åˆ·æ–°ç¼“å†²åŒº
flush_buffer_periodically() {
    while true; do
        sleep $BATCH_TIMEOUT
        
        local current_time=$(get_timestamp)
        local time_since_last_batch=$((current_time - LAST_BATCH_TIME))
        
        if [ ${#EVENT_BUFFER[@]} -gt 0 ] && \
           [ $time_since_last_batch -ge $BATCH_TIMEOUT ]; then
            echo "å®šæ—¶åˆ·æ–°äº‹ä»¶ç¼“å†²åŒº..."
            process_batch
        fi
    done
}

# å¯åŠ¨æ‰¹å¤„ç†ç›‘æ§
start_batch_monitoring() {
    local watch_dir="$1"
    
    echo "å¯åŠ¨æ‰¹å¤„ç†ç›‘æ§: $watch_dir"
    echo "æ‰¹é‡å¤§å°: $BATCH_SIZE, è¶…æ—¶: $BATCH_TIMEOUT ç§’"
    
    # å¯åŠ¨å®šæ—¶åˆ·æ–°è¿›ç¨‹
    flush_buffer_periodically &
    local flush_pid=$!
    
    # æ¸…ç†å‡½æ•°
    cleanup() {
        echo "æ­£åœ¨åœæ­¢æ‰¹å¤„ç†ç›‘æ§..."
        kill $flush_pid 2>/dev/null
        process_batch  # å¤„ç†å‰©ä½™äº‹ä»¶
        exit 0
    }
    
    trap cleanup SIGTERM SIGINT
    
    # å¼€å§‹ç›‘æ§
    inotifywait -m -r -e create,modify,delete "$watch_dir" | \
    while read path action file; do
        local event_data="$(date '+%Y-%m-%d %H:%M:%S') $path$file: $action"
        add_to_buffer "$event_data"
    done
}

# ä½¿ç”¨ç¤ºä¾‹
start_batch_monitoring "/home/user/watched"
```

### 9.3 å†…å­˜å’ŒCPUä¼˜åŒ–


**èµ„æºä½¿ç”¨ä¼˜åŒ–**ï¼š
```bash
#!/bin/bash

# è®¾ç½®è¿›ç¨‹ä¼˜å…ˆçº§å’Œèµ„æºé™åˆ¶
optimize_process() {
    local nice_value=10        # é™ä½CPUä¼˜å…ˆçº§
    local memory_limit="100M"  # é™åˆ¶å†…å­˜ä½¿ç”¨
    
    echo "ä¼˜åŒ–è¿›ç¨‹èµ„æºä½¿ç”¨..."
    
    # è®¾ç½®è¿›ç¨‹ä¼˜å…ˆçº§
    renice $nice_value $$ >/dev/null 2>&1
    
    # è®¾ç½®å†…å­˜é™åˆ¶ï¼ˆå¦‚æœæ”¯æŒï¼‰
    if command -v ulimit >/dev/null; then
        ulimit -v 102400  # é™åˆ¶è™šæ‹Ÿå†…å­˜ä¸º100MB
    fi
    
    echo "è¿›ç¨‹ä¼˜åŒ–å®Œæˆ: PID $$, Nice $nice_value"
}

# å†…å­˜ç›‘æ§å’Œæ¸…ç†
monitor_memory_usage() {
    local max_memory_mb=200
    local check_interval=300  # 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    
    while true; do
        sleep $check_interval
        
        # è·å–å½“å‰è¿›ç¨‹å†…å­˜ä½¿ç”¨ (KB)
        local memory_kb=$(ps -o rss= -p $$)
        local memory_mb=$((memory_kb / 1024))
        
        echo "å½“å‰å†…å­˜ä½¿ç”¨: ${memory_mb}MB"
        
        if [ $memory_mb -gt $max_memory_mb ]; then
            echo "è­¦å‘Š: å†…å­˜ä½¿ç”¨è¶…è¿‡é™åˆ¶ ${memory_mb}MB > ${max_memory_mb}MB"
            
            # æ‰§è¡Œå†…å­˜æ¸…ç†æ“ä½œ
            echo "æ‰§è¡Œå†…å­˜æ¸…ç†..."
            
            # æ¸…ç†æ—¥å¿—æ–‡ä»¶
            find /tmp -name "*.log" -mtime +1 -delete 2>/dev/null
            
            # å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¯¹äºæŸäº›è§£é‡Šå‹è¯­è¨€ï¼‰
            # è¿™é‡Œæ˜¯bashï¼Œæ‰€ä»¥ä¸»è¦æ˜¯æ¸…ç†æ•°ç»„ç­‰
            unset EVENT_BUFFER
            EVENT_BUFFER=()
            
            echo "å†…å­˜æ¸…ç†å®Œæˆ"
        fi
    done
}

# CPUä½¿ç”¨ç‡ç›‘æ§
monitor_cpu_usage() {
    local max_cpu_percent=80
    local check_interval=60
    
    while true; do
        sleep $check_interval
        
        # è·å–å½“å‰è¿›ç¨‹CPUä½¿ç”¨ç‡
        local cpu_percent=$(ps -o %cpu= -p $$ | xargs)
        
        # æ£€æŸ¥CPUä½¿ç”¨ç‡ï¼ˆç®€å•çš„å­—ç¬¦ä¸²æ¯”è¾ƒï¼‰
        if (( $(echo "$cpu_percent > $max_cpu_percent" | bc -l) )); then
            echo "è­¦å‘Š: CPUä½¿ç”¨ç‡è¿‡é«˜ ${cpu_percent}% > ${max_cpu_percent}%"
            
            # ä¸´æ—¶é™ä½ä¼˜å…ˆçº§
            renice 15 $$ >/dev/null 2>&1
            echo "ä¸´æ—¶é™ä½è¿›ç¨‹ä¼˜å…ˆçº§"
            
            # å‡å°‘ç›‘æ§é¢‘ç‡
            sleep 30
            
            # æ¢å¤æ­£å¸¸ä¼˜å…ˆçº§
            renice 10 $$ >/dev/null 2>&1
        fi
    done
}

# é«˜æ•ˆçš„inotifyé…ç½®
configure_inotify_limits() {
    echo "é…ç½®inotifyç³»ç»Ÿé™åˆ¶..."
    
    # æ£€æŸ¥å½“å‰é™åˆ¶
    local max_user_watches=$(cat /proc/sys/fs/inotify/max_user_watches 2>/dev/null || echo "8192")
    local max_user_instances=$(cat /proc/sys/fs/inotify/max_user_instances 2>/dev/null || echo "128")
    
    echo "å½“å‰inotifyé™åˆ¶:"
    echo "  max_user_watches: $max_user_watches"
    echo "  max_user_instances: $max_user_instances"
    
    # å»ºè®®ä¼˜åŒ–çš„é…ç½®
    if [ "$max_user_watches" -lt 16384 ]; then
        echo "å»ºè®®å¢åŠ ç›‘æ§æ•°é‡é™åˆ¶:"
        echo "  echo 16384 | sudo tee /proc/sys/fs/inotify/max_user_watches"
    fi
    
    # æ˜¾ç¤ºå½“å‰ä½¿ç”¨æƒ…å†µ
    local used_watches=$(find /proc/*/fd -lname anon_inode:inotify 2>/dev/null | wc -l)
    echo "å½“å‰ä½¿ç”¨çš„ç›‘æ§æ•°: $used_watches"
}

# å¯åŠ¨ä¼˜åŒ–çš„ç›‘æ§
start_optimized_monitoring() {
    local watch_dir="$1"
    
    echo "å¯åŠ¨ä¼˜åŒ–çš„ç›‘æ§ç³»ç»Ÿ..."
    
    # åº”ç”¨è¿›ç¨‹ä¼˜åŒ–
    optimize_process
    
    # é…ç½®ç³»ç»Ÿé™åˆ¶
    configure_inotify_limits
    
    # å¯åŠ¨èµ„æºç›‘æ§
    monitor_memory_usage &
    local memory_monitor_pid=$!
    
    monitor_cpu_usage &
    local cpu_monitor_pid=$!
    
    # æ¸…ç†å‡½æ•°
    cleanup_optimized() {
        echo "æ¸…ç†ç›‘æ§è¿›ç¨‹..."
        kill $memory_monitor_pid $cpu_monitor_pid 2>/dev/null
        exit 0
    }
    
    trap cleanup_optimized SIGTERM SIGINT
    
    # å¯åŠ¨ä¼˜åŒ–çš„inotifyç›‘æ§
    echo "å¼€å§‹æ–‡ä»¶ç›‘æ§: $watch_dir"
    inotifywait -m -r \
        --exclude '.*\.(tmp|swp|~)$' \
        -e create,modify,delete \
        "$watch_dir" | \
    while read path action file; do
        # ç®€åŒ–çš„äº‹ä»¶å¤„ç†ï¼Œå‡å°‘å­—ç¬¦ä¸²æ“ä½œ
        printf '%s %s%s: %s\n' "$(date '+%H:%M:%S')" "$path" "$file" "$action"
    done
}

# å¯åŠ¨ä¼˜åŒ–ç›‘æ§
start_optimized_monitoring "/home/user/watched"
```

---

## 10. ğŸ¯ å®é™…ä¸šåŠ¡åœºæ™¯é›†æˆ


### 10.1 è‡ªåŠ¨å¤‡ä»½ç³»ç»Ÿ


> **ğŸ’¡ å®ç”¨åœºæ™¯**ï¼šæ–‡ä»¶ä¿®æ”¹åè‡ªåŠ¨è§¦å‘å¤‡ä»½ï¼Œç¡®ä¿é‡è¦æ•°æ®ä¸ä¸¢å¤±

**æ™ºèƒ½å¤‡ä»½è„šæœ¬**ï¼š
```bash
#!/bin/bash

# å¤‡ä»½é…ç½®
BACKUP_BASE="/backup"
SOURCE_DIR="/home/user/documents"
RSYNC_OPTIONS="-avz --delete"
MAX_BACKUPS=7

# åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„å¤‡ä»½
create_timestamped_backup() {
    local source="$1"
    local changed_file="$2"
    
    local timestamp=$(date "+%Y%m%d_%H%M%S")
    local backup_name="backup_$timestamp"
    local backup_path="$BACKUP_BASE/$backup_name"
    
    echo "åˆ›å»ºå¤‡ä»½: $backup_path"
    
    # åˆ›å»ºå¤‡ä»½ç›®å½•
    mkdir -p "$backup_path"
    
    # æ‰§è¡Œå¢é‡å¤‡ä»½
    if rsync $RSYNC_OPTIONS "$source/" "$backup_path/"; then
        echo "å¤‡ä»½å®Œæˆ: $backup_path"
        
        # è®°å½•å¤‡ä»½ä¿¡æ¯
        echo "$timestamp|$changed_file|$backup_path" >> "$BACKUP_BASE/backup.log"
        
        # æ¸…ç†æ—§å¤‡ä»½
        cleanup_old_backups
        
        return 0
    else
        echo "å¤‡ä»½å¤±è´¥: $backup_path"
        rm -rf "$backup_path"
        return 1
    fi
}

# æ¸…ç†æ—§å¤‡ä»½
cleanup_old_backups() {
    local backup_dirs=($(ls -dt "$BACKUP_BASE"/backup_* 2>/dev/null))
    local total_backups=${#backup_dirs[@]}
    
    if [ $total_backups -gt $MAX_BACKUPS ]; then
        local excess=$((total_backups - MAX_BACKUPS))
        echo "æ¸…ç† $excess ä¸ªæ—§å¤‡ä»½..."
        
        for ((i=MAX_BACKUPS; i<total_backups; i++)); do
            local old_backup="${backup_dirs[$i]}"
            echo "åˆ é™¤æ—§å¤‡ä»½: $old_backup"
            rm -rf "$old_backup"
        done
    fi
}

# æ™ºèƒ½å¤‡ä»½å†³ç­–
should_trigger_backup() {
    local file_path="$1"
    local event_type="$2"
    
    # åªå¯¹é‡è¦æ–‡ä»¶ç±»å‹è§¦å‘å¤‡ä»½
    case "${file_path##*.}" in
        "txt"|"doc"|"docx"|"pdf"|"xlsx"|"ppt")
            return 0  # è§¦å‘å¤‡ä»½
            ;;
        "jpg"|"jpeg"|"png"|"mp4"|"avi")
            # å¤§æ–‡ä»¶åªåœ¨åˆ›å»ºæ—¶å¤‡ä»½
            [ "$event_type" = "CREATE" ] && return 0
            return 1
            ;;
        "tmp"|"log"|"cache")
            return 1  # ä¸å¤‡ä»½ä¸´æ—¶æ–‡ä»¶
            ;;
        *)
            # é»˜è®¤å¤‡ä»½å…¶ä»–æ–‡ä»¶
            return 0
            ;;
    esac
}

# å¯åŠ¨å¤‡ä»½ç›‘æ§
start_backup_monitoring() {
    local watch_dir="$SOURCE_DIR"
    
    echo "å¯åŠ¨è‡ªåŠ¨å¤‡ä»½ç›‘æ§: $watch_dir"
    echo "å¤‡ä»½ä½ç½®: $BACKUP_BASE"
    echo "æœ€å¤§å¤‡ä»½æ•°: $MAX_BACKUPS"
    
    # åˆ›å»ºå¤‡ä»½åŸºç¡€ç›®å½•
    mkdir -p "$BACKUP_BASE"
    
    inotifywait -m -r -e close_write,create,delete,move "$watch_dir" | \
    while read path action file; do
        local full_path="$path$file"
        local timestamp=$(date "+%Y-%m-%d %H:%M:%S")
        
        echo "[$timestamp] æ£€æµ‹åˆ°å˜åŒ–: $full_path ($action)"
        
        # åˆ¤æ–­æ˜¯å¦éœ€è¦å¤‡ä»½
        if should_trigger_backup "$full_path" "$action"; then
            echo "è§¦å‘å¤‡ä»½æ¡ä»¶ï¼Œå¼€å§‹å¤‡ä»½..."
            create_timestamped_backup "$watch_dir" "$full_path"
        else
            echo "è·³è¿‡å¤‡ä»½: $full_path"
        fi
    done
}
```

### 10.2 ä»£ç åŒæ­¥ç³»ç»Ÿ


**å¼€å‘ç¯å¢ƒè‡ªåŠ¨åŒæ­¥**ï¼š
```bash
#!/bin/bash

# åŒæ­¥é…ç½®
LOCAL_CODE_DIR="/home/dev/projects"
REMOTE_HOST="dev-server"
REMOTE_CODE_DIR="/var/www/projects"
SYNC_DELAY=2  # ç­‰å¾…2ç§’å†åŒæ­¥ï¼Œé¿å…é¢‘ç¹åŒæ­¥

# Gitè‡ªåŠ¨æäº¤å’Œæ¨é€
auto_git_commit() {
    local project_dir="$1"
    local changed_file="$2"
    local action="$3"
    
    cd "$project_dir" || return 1
    
    # æ£€æŸ¥æ˜¯å¦æ˜¯Gitä»“åº“
    if [ ! -d ".git" ]; then
        echo "ä¸æ˜¯Gitä»“åº“: $project_dir"
        return 1
    fi
    
    echo "æ‰§è¡ŒGitè‡ªåŠ¨æäº¤..."
    
    # æ·»åŠ å˜æ›´æ–‡ä»¶
    git add "$changed_file"
    
    # ç”Ÿæˆæäº¤ä¿¡æ¯
    local commit_msg="Auto-commit: $action $(basename "$changed_file") at $(date '+%H:%M:%S')"
    
    # æäº¤å˜æ›´
    if git commit -m "$commit_msg"; then
        echo "Gitæäº¤æˆåŠŸ: $commit_msg"
        
        # æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼ˆå¯é€‰ï¼‰
        if [ "$AUTO_PUSH" = "1" ]; then
            echo "æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
            git push origin "$(git branch --show-current)" 2>/dev/null || {
                echo "æ¨é€å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨è§£å†³å†²çª"
            }
        fi
    else
        echo "Gitæäº¤å¤±è´¥æˆ–æ— å˜æ›´"
    fi
}

# è¿œç¨‹åŒæ­¥
sync_to_remote() {
    local local_path="$1"
    local relative_path="$2"
    
    echo "åŒæ­¥åˆ°è¿œç¨‹æœåŠ¡å™¨: $relative_path"
    
    # æ„å»ºè¿œç¨‹è·¯å¾„
    local remote_path="$REMOTE_HOST:$REMOTE_CODE_DIR/$relative_path"
    
    # æ‰§è¡ŒåŒæ­¥
    if rsync -avz --delete "$local_path" "$remote_path"; then
        echo "è¿œç¨‹åŒæ­¥æˆåŠŸ: $remote_path"
        
        # å¯é€‰ï¼šè¿œç¨‹æ‰§è¡Œé‡å¯å‘½ä»¤
        if [ -n "$REMOTE_RESTART_CMD" ]; then
            echo "æ‰§è¡Œè¿œç¨‹é‡å¯å‘½ä»¤..."
            ssh "$REMOTE_HOST" "$REMOTE_RESTART_CMD" 2>/dev/null || {
                echo "è¿œç¨‹é‡å¯å‘½ä»¤æ‰§è¡Œå¤±è´¥"
            }
        fi
    else
        echo "è¿œç¨‹åŒæ­¥å¤±è´¥: $remote_path"
    fi
}

# ç¼–è¯‘å’Œæµ‹è¯•
auto_build_test() {
    local project_dir="$1"
    local file_extension="$2"
    
    cd "$project_dir" || return 1
    
    echo "è‡ªåŠ¨æ„å»ºå’Œæµ‹è¯•..."
    
    case "$file_extension" in
        "py")
            # Pythoné¡¹ç›®
            if [ -f "requirements.txt" ]; then
                echo "æ£€æŸ¥Pythonä¾èµ–..."
                pip install -r requirements.txt >/dev/null 2>&1
            fi
            
            if [ -f "manage.py" ]; then
                echo "Djangoé¡¹ç›®æ£€æŸ¥..."
                python manage.py check --deploy >/dev/null 2>&1
            fi
            ;;
        "js"|"jsx")
            # JavaScript/Node.jsé¡¹ç›®
            if [ -f "package.json" ]; then
                echo "è¿è¡ŒJavaScriptæµ‹è¯•..."
                npm test >/dev/null 2>&1 || echo "æµ‹è¯•å¤±è´¥æˆ–æ— æµ‹è¯•"
            fi
            ;;
        "sh")
            # Shellè„šæœ¬
            echo "æ£€æŸ¥Shellè„šæœ¬è¯­æ³•..."
            bash -n "$1" || echo "è„šæœ¬è¯­æ³•é”™è¯¯"
            ;;
    esac
}

# ä»£ç ç›‘æ§ä¸»å‡½æ•°
start_code_monitoring() {
    echo "å¯åŠ¨ä»£ç åŒæ­¥ç›‘æ§: $LOCAL_CODE_DIR"
    
    # å»¶è¿ŸåŒæ­¥æ˜ å°„ï¼ˆé¿å…é¢‘ç¹åŒæ­¥ï¼‰
    declare -A PENDING_SYNC
    
    # å»¶è¿ŸåŒæ­¥å¤„ç†
    process_delayed_sync() {
        while true; do
            sleep $SYNC_DELAY
            
            for path in "${!PENDING_SYNC[@]}"; do
                local sync_time="${PENDING_SYNC[$path]}"
                local current_time=$(date +%s)
                
                if [ $((current_time - sync_time)) -ge $SYNC_DELAY ]; then
                    echo "æ‰§è¡Œå»¶è¿ŸåŒæ­¥: $path"
                    
                    # è·å–é¡¹ç›®æ ¹ç›®å½•
                    local project_root=$(find_project_root "$path")
                    local relative_path=$(realpath --relative-to="$LOCAL_CODE_DIR" "$project_root")
                    
                    # æ‰§è¡ŒGitæäº¤
                    auto_git_commit "$project_root" "$path" "MODIFY"
                    
                    # æ‰§è¡Œè¿œç¨‹åŒæ­¥
                    sync_to_remote "$project_root/" "$relative_path"
                    
                    # ç§»é™¤å·²å¤„ç†çš„åŒæ­¥ä»»åŠ¡
                    unset PENDING_SYNC["$path"]
                fi
            done
        done
    }
    
    # å¯åŠ¨å»¶è¿ŸåŒæ­¥å¤„ç†å™¨
    process_delayed_sync &
    local sync_processor_pid=$!
    
    # æ¸…ç†å‡½æ•°
    cleanup_code_monitor() {
        echo "åœæ­¢ä»£ç ç›‘æ§..."
        kill $sync_processor_pid 2>/dev/null
        exit 0
    }
    
    trap cleanup_code_monitor SIGTERM SIGINT
    
    # ç›‘æ§ä»£ç æ–‡ä»¶å˜åŒ–
    inotifywait -m -r \
        --include '.*\.(py|js|jsx|html|css|sh|java|cpp|c|h) \
        --exclude '.*\.(pyc|pyo|tmp|swp|~) \
        -e close_write "$LOCAL_CODE_DIR" | \
    while read path action file; do
        local full_path="$path$file"
        local file_ext="${file##*.}"
        
        echo "ä»£ç æ–‡ä»¶å˜æ›´: $full_path ($action)"
        
        # æ·»åŠ åˆ°å»¶è¿ŸåŒæ­¥é˜Ÿåˆ—
        PENDING_SYNC["$full_path"]=$(date +%s)
        
        # ç«‹å³æ‰§è¡Œæ„å»ºæµ‹è¯•
        local project_root=$(find_project_root "$full_path")
        auto_build_test "$project_root" "$file_ext"
    done
}

# æŸ¥æ‰¾é¡¹ç›®æ ¹ç›®å½•
find_project_root() {
    local file_path="$1"
    local current_dir=$(dirname "$file_path")
    
    # å‘ä¸ŠæŸ¥æ‰¾é¡¹ç›®æ ‡è¯†æ–‡ä»¶
    while [ "$current_dir" != "/" ]; do
        if [ -f "$current_dir/.git/config" ] || \
           [ -f "$current_dir/package.json" ] || \
           [ -f "$current_dir/setup.py" ] || \
           [ -f "$current_dir/Makefile" ]; then
            echo "$current_dir"
            return 0
        fi
        current_dir=$(dirname "$current_dir")
    done
    
    # å¦‚æœæ²¡æ‰¾åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼Œè¿”å›æ–‡ä»¶æ‰€åœ¨ç›®å½•
    dirname "$file_path"
}
```

### 10.3 æ—¥å¿—åˆ†æç³»ç»Ÿ


**å®æ—¶æ—¥å¿—ç›‘æ§å’Œå‘Šè­¦**ï¼š
```bash
#!/bin/bash

# æ—¥å¿—åˆ†æé…ç½®
LOG_PATTERNS_FILE="/etc/log-monitor/patterns.conf"
ALERT_EMAIL="admin@example.com"
ALERT_WEBHOOK="https://hooks.slack.com/your-webhook-url"

# é”™è¯¯æ¨¡å¼é…ç½®
init_error_patterns() {
    mkdir -p "$(dirname "$LOG_PATTERNS_FILE")"
    
    cat > "$LOG_PATTERNS_FILE" <<EOF
# é”™è¯¯çº§åˆ«æ¨¡å¼ (çº§åˆ«:æ¨¡å¼:æè¿°)
CRITICAL:FATAL|CRITICAL|PANIC:ä¸¥é‡é”™è¯¯
ERROR:ERROR|Exception|failed:ä¸€èˆ¬é”™è¯¯  
WARNING:WARN|WARNING|deprecated:è­¦å‘Šä¿¡æ¯
INFO:INFO|Starting|Stopping:ä¿¡æ¯è®°å½•
EOF
}

# è§£ææ—¥å¿—è¡Œ
parse_log_line() {
    local log_line="$1"
    local log_file="$2"
    
    # æå–æ—¶é—´æˆ³ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
    local timestamp=""
    if echo "$log_line" | grep -qE '^\d{4}-\d{2}-\d{2}'; then
        timestamp=$(echo "$log_line" | grep -oE '^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}')
    elif echo "$log_line" | grep -qE '^\w{3} \d{2} \d{2}:\d{2}:\d{2}'; then
        timestamp=$(echo "$log_line" | grep -oE '^\w{3} \d{2} \d{2}:\d{2}:\d{2}')
    else
        timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    fi
    
    # åˆ†æé”™è¯¯çº§åˆ«
    local level="INFO"
    while IFS=':' read -r check_level pattern description; do
        if echo "$log_line" | grep -qiE "$pattern"; then
            level="$check_level"
            break
        fi
    done < "$LOG_PATTERNS_FILE"
    
    # è¾“å‡ºç»“æ„åŒ–ä¿¡æ¯
    echo "$timestamp|$level|$log_file|$log_line"
}

# å‘é€å‘Šè­¦
send_alert() {
    local level="$1"
    local log_file="$2"
    local log_line="$3"
    local count="$4"
    
    local subject="[$level] æ—¥å¿—å‘Šè­¦: $(basename "$log_file")"
    local message="æ£€æµ‹åˆ° $level çº§åˆ«æ—¥å¿—äº‹ä»¶ (æ¬¡æ•°: $count)
    
æ–‡ä»¶: $log_file
æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
å†…å®¹: $log_line

è¯·åŠæ—¶æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ã€‚"
    
    # é‚®ä»¶å‘Šè­¦
    if command -v mail >/dev/null && [ -n "$ALERT_EMAIL" ]; then
        echo "$message" | mail -s "$subject" "$ALERT_EMAIL"
        echo "é‚®ä»¶å‘Šè­¦å·²å‘é€: $ALERT_EMAIL"
    fi
    
    # Webhookå‘Šè­¦
    if command -v curl >/dev/null && [ -n "$ALERT_WEBHOOK" ]; then
        local webhook_data="{
            \"text\": \"$subject\",
            \"attachments\": [{
                \"color\": \"danger\",
                \"fields\": [{
                    \"title\": \"æ—¥å¿—æ–‡ä»¶\",
                    \"value\": \"$log_file\",
                    \"short\": true
                }, {
                    \"title\": \"é”™è¯¯æ¬¡æ•°\", 
                    \"value\": \"$count\",
                    \"short\": true
                }, {
                    \"title\": \"æ—¥å¿—å†…å®¹\",
                    \"value\": \"$log_line\"
                }]
            }]
        }"
        
        curl -X POST -H 'Content-type: application/json' \
             --data "$webhook_data" \
             "$ALERT_WEBHOOK" >/dev/null 2>&1
        
        echo "Webhookå‘Šè­¦å·²å‘é€"
    fi
}

# é”™è¯¯ç»Ÿè®¡å’Œå‘Šè­¦
track_errors() {
    declare -A ERROR_COUNTS
    declare -A LAST_ALERT_TIME
    local alert_threshold=5
    local alert_cooldown=300  # 5åˆ†é’Ÿå†·å´æœŸ
    
    while IFS='|' read -r timestamp level log_file log_line; do
        echo "[$timestamp] [$level] $(basename "$log_file"): $log_line"
        
        # åªå¯¹ERRORå’ŒCRITICALçº§åˆ«è¿›è¡Œå‘Šè­¦
        if [ "$level" = "ERROR" ] || [ "$level" = "CRITICAL" ]; then
            local error_key="${log_file}_${level}"
            ERROR_COUNTS["$error_key"]=$((${ERROR_COUNTS["$error_key"]} + 1))
            
            local current_time=$(date +%s)
            local last_alert=${LAST_ALERT_TIME["$error_key"]:-0}
            local time_diff=$((current_time - last_alert))
            
            # æ£€æŸ¥æ˜¯å¦éœ€è¦å‘Šè­¦
            if [ ${ERROR_COUNTS["$error_key"]} -ge $alert_threshold ] && \
               [ $time_diff -ge $alert_cooldown ]; then
                
                send_alert "$level" "$log_file" "$log_line" "${ERROR_COUNTS["$error_key"]}"
                LAST_ALERT_TIME["$error_key"]=$current_time
                ERROR_COUNTS["$error_key"]=0  # é‡ç½®è®¡æ•°
            fi
        fi
        
        # è®°å½•åˆ°åˆ†ææ—¥å¿—
        echo "$timestamp|$level|$log_file|$log_line" >> /var/log/log-analysis.log
    done
}

# å¯åŠ¨æ—¥å¿—ç›‘æ§
start_log_monitoring() {
    local log_files=("$@")
    
    if [ ${#log_files[@]} -eq 0 ]; then
        echo "é”™è¯¯: è¯·æŒ‡å®šè¦ç›‘æ§çš„æ—¥å¿—æ–‡ä»¶"
        echo "ç”¨æ³•: $0 /var/log/app.log /var/log/error.log"
        exit 1
    fi
    
    echo "åˆå§‹åŒ–æ—¥å¿—ç›‘æ§..."
    init_error_patterns
    
    echo "å¼€å§‹ç›‘æ§ä»¥ä¸‹æ—¥å¿—æ–‡ä»¶:"
    printf '  %s\n' "${log_files[@]}"
    
    # æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    for log_file in "${log_files[@]}"; do
        if [ ! -f "$log_file" ]; then
            echo "è­¦å‘Š: æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ $log_file"
        fi
    done
    
    # ç›‘æ§å¤šä¸ªæ—¥å¿—æ–‡ä»¶
    for log_file in "${log_files[@]}"; do
        if [ -f "$log_file" ]; then
            echo "å¯åŠ¨ç›‘æ§: $log_file"
            
            inotifywait -m -e modify "$log_file" | \
            while read path action file; do
                # è¯»å–æ–°å¢çš„æ—¥å¿—è¡Œ
                tail -n 1 "$log_file" | while read log_line; do
                    if [ -n "$log_line" ]; then
                        parse_log_line "$log_line" "$log_file"
                    fi
                done
            done &
        fi
    done
    
    # ç­‰å¾…æ‰€æœ‰ç›‘æ§è¿›ç¨‹
    wait
} | track_errors

# ä½¿ç”¨ç¤ºä¾‹
case "$1" in
    "start")
        shift
        start_log_monitoring "$@"
        ;;
    "test")
        # æµ‹è¯•å‘Šè­¦åŠŸèƒ½
        echo "æµ‹è¯•å‘Šè­¦åŠŸèƒ½..."
        send_alert "ERROR" "/var/log/test.log" "This is a test error message" "1"
        ;;
    *)
        echo "ç”¨æ³•: $0 {start|test} [æ—¥å¿—æ–‡ä»¶...]"
        echo "ç¤ºä¾‹: $0 start /var/log/apache/error.log /var/log/mysql/error.log"
        ;;
esac
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ“Œ **inotifyåŸºç¡€ç†è§£**
â€¢ inotifyæ˜¯Linuxå†…æ ¸æä¾›çš„æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶ç›‘æ§æœºåˆ¶
â€¢ æ¯”è½®è¯¢æ–¹å¼æ›´é«˜æ•ˆï¼Œå®æ—¶æ€§å¥½ï¼Œèµ„æºå ç”¨å°‘
â€¢ ä¸»è¦å·¥å…·ï¼šinotifywaitï¼ˆç›‘æ§ï¼‰å’Œinotifywatchï¼ˆç»Ÿè®¡ï¼‰

ğŸ“Œ **while readäº‹ä»¶å¤„ç†**  
â€¢ while readæ˜¯å¤„ç†inotifyäº‹ä»¶çš„æ ‡å‡†æ¨¡å¼
â€¢ äº‹ä»¶è¾“å‡ºæ ¼å¼ï¼šè·¯å¾„ åŠ¨ä½œ æ–‡ä»¶å
â€¢ éœ€è¦å¤„ç†ç®¡é“å’Œè¿›ç¨‹é—´çš„æ•°æ®ä¼ é€’

ğŸ“Œ **äº‹ä»¶ç±»å‹åˆ†ç±»**
â€¢ å¸¸ç”¨äº‹ä»¶ï¼šCREATEã€MODIFYã€DELETEã€MOVEã€CLOSE_WRITE
â€¢ é€‰æ‹©åˆé€‚çš„äº‹ä»¶ç±»å‹èƒ½æé«˜ç›‘æ§æ•ˆç‡
â€¢ é¿å…ç›‘æ§ä¸å¿…è¦çš„äº‹ä»¶ï¼ˆå¦‚ä¸´æ—¶æ–‡ä»¶ã€ç¼“å­˜æ–‡ä»¶ï¼‰
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆä½¿ç”¨while readå¾ªç¯**ï¼š
```
æ ¸å¿ƒåŸå› ï¼š
â€¢ inotifywaitè¾“å‡ºæ˜¯è¿ç»­çš„æ•°æ®æµ
â€¢ while readèƒ½é€è¡Œå¤„ç†äº‹ä»¶æ•°æ®
â€¢ æ”¯æŒé•¿æœŸè¿è¡Œå’Œå®æ—¶å¤„ç†
â€¢ å¯ä»¥åœ¨å¾ªç¯ä¸­æ·»åŠ å¤æ‚çš„ä¸šåŠ¡é€»è¾‘

å®ç°è¦ç‚¹ï¼š
â€¢ ä½¿ç”¨ç®¡é“å°†inotifywaitè¾“å‡ºä¼ é€’ç»™while read
â€¢ æ­£ç¡®è§£æäº‹ä»¶å‚æ•°ï¼ˆè·¯å¾„ã€åŠ¨ä½œã€æ–‡ä»¶åï¼‰
â€¢ æ·»åŠ å¼‚å¸¸å¤„ç†å’Œè¿›ç¨‹ç®¡ç†
```

**ğŸ”¹ å¤šç›®å½•ç›‘æ§çš„æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆ**ï¼š
```
ä¸»è¦æŒ‘æˆ˜ï¼š
â€¢ å•ä¸ªinotifywaitåªèƒ½ç›‘æ§ä¸€ä¸ªç›®å½•æ ‘
â€¢ éœ€è¦ä¸ºæ¯ä¸ªç›®å½•å¯åŠ¨ç‹¬ç«‹è¿›ç¨‹
â€¢ è¿›ç¨‹é—´é€šä¿¡å’Œäº‹ä»¶æ±‡æ€»

è§£å†³æ–¹æ¡ˆï¼š
â€¢ å¤šè¿›ç¨‹å¹¶å‘ç›‘æ§
â€¢ å‘½åç®¡é“è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡
â€¢ ç»Ÿä¸€çš„äº‹ä»¶å¤„ç†ä¸­å¿ƒ
â€¢ è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ€è·¯**ï¼š
```
å‡å°‘æ— æ•ˆç›‘æ§ï¼š
â€¢ åªç›‘æ§å¿…è¦çš„äº‹ä»¶ç±»å‹
â€¢ ä½¿ç”¨æ–‡ä»¶æ‰©å±•åè¿‡æ»¤
â€¢ æ’é™¤ä¸´æ—¶æ–‡ä»¶å’Œç³»ç»Ÿæ–‡ä»¶

æ‰¹é‡å¤„ç†ï¼š
â€¢ äº‹ä»¶ç¼“å†²å’Œæ‰¹é‡å¤„ç†
â€¢ é¿å…é¢‘ç¹çš„ç£ç›˜å†™å…¥
â€¢ åˆå¹¶ç›¸ä¼¼çš„æ“ä½œ

èµ„æºé™åˆ¶ï¼š
â€¢ æ§åˆ¶å†…å­˜ä½¿ç”¨é‡
â€¢ è®¾ç½®åˆç†çš„è¿›ç¨‹ä¼˜å…ˆçº§
â€¢ ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
```

### 11.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ“Š ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
```
æ–‡ä»¶å¤‡ä»½ï¼š
â€¢ å®æ—¶ç›‘æ§é‡è¦æ–‡ä»¶å˜åŒ–
â€¢ è‡ªåŠ¨è§¦å‘å¢é‡å¤‡ä»½
â€¢ ç‰ˆæœ¬æ§åˆ¶å’Œå†å²ç®¡ç†

å¼€å‘ç¯å¢ƒï¼š  
â€¢ ä»£ç æ–‡ä»¶å˜åŒ–è‡ªåŠ¨åŒæ­¥
â€¢ è§¦å‘è‡ªåŠ¨ç¼–è¯‘å’Œæµ‹è¯•
â€¢ Gitè‡ªåŠ¨æäº¤å’Œæ¨é€

ç³»ç»Ÿè¿ç»´ï¼š
â€¢ æ—¥å¿—æ–‡ä»¶å®æ—¶åˆ†æ
â€¢ é…ç½®æ–‡ä»¶å˜æ›´ç›‘æ§
â€¢ å®‰å…¨äº‹ä»¶æ£€æµ‹å’Œå‘Šè­¦

æ•°æ®åŒæ­¥ï¼š
â€¢ æ–‡ä»¶æœåŠ¡å™¨æ•°æ®åŒæ­¥
â€¢ æ•°æ®åº“æ–‡ä»¶ç›‘æ§
â€¢ ç¼“å­˜æ›´æ–°è§¦å‘
```

### 11.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ› ï¸ è„šæœ¬ç¼–å†™å»ºè®®**ï¼š
```
é”™è¯¯å¤„ç†ï¼š
â€¢ å¿…é¡»åŒ…å«å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
â€¢ å®ç°è‡ªåŠ¨é‡è¯•å’Œæ¢å¤åŠŸèƒ½
â€¢ è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

è¿›ç¨‹ç®¡ç†ï¼š
â€¢ ä½¿ç”¨PIDæ–‡ä»¶ç®¡ç†è¿›ç¨‹
â€¢ å®ç°ä¼˜é›…çš„å¯åŠ¨å’Œåœæ­¢
â€¢ æ”¯æŒsystemdæˆ–å…¶ä»–æœåŠ¡ç®¡ç†

ç›‘æ§ä¼˜åŒ–ï¼š
â€¢ åˆç†é€‰æ‹©ç›‘æ§äº‹ä»¶ç±»å‹
â€¢ ä½¿ç”¨æ–‡ä»¶è¿‡æ»¤å‡å°‘æ— æ•ˆäº‹ä»¶
â€¢ å®ç°æ‰¹é‡å¤„ç†æé«˜æ•ˆç‡
```

**âš ï¸ å¸¸è§é—®é¢˜é¿å…**ï¼š
```
ç³»ç»Ÿé™åˆ¶ï¼š
â€¢ æ³¨æ„inotifyç›‘æ§æ•°é‡é™åˆ¶
â€¢ é¿å…ç›‘æ§è¿‡æ·±çš„ç›®å½•ç»“æ„
â€¢ åˆç†è®¾ç½®äº‹ä»¶ç¼“å†²åŒºå¤§å°

è„šæœ¬ç¨³å®šæ€§ï¼š
â€¢ å¤„ç†æ–‡ä»¶æƒé™é—®é¢˜
â€¢ é¿å…æ­»å¾ªç¯å’Œå†…å­˜æ³„æ¼
â€¢ å®ç°è¿›ç¨‹æ¸…ç†æœºåˆ¶

ä¸šåŠ¡é€»è¾‘ï¼š
â€¢ é¿å…åœ¨äº‹ä»¶å¤„ç†ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
â€¢ ä½¿ç”¨å¼‚æ­¥å¤„ç†å¤æ‚ä¸šåŠ¡é€»è¾‘
â€¢ å®ç°å¹‚ç­‰æ€§æ“ä½œ
```

### 11.5 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š æ·±å…¥å­¦ä¹ æ–¹å‘**ï¼š
```
åŸºç¡€å·©å›ºï¼š
â€¢ ç†Ÿç»ƒæŒæ¡Shellè„šæœ¬ç¼–ç¨‹
â€¢ æ·±å…¥ç†è§£Linuxè¿›ç¨‹ç®¡ç†
â€¢ æŒæ¡æ–‡ä»¶ç³»ç»Ÿå’Œæƒé™æœºåˆ¶

é«˜çº§åº”ç”¨ï¼š
â€¢ å­¦ä¹ systemdæœåŠ¡é…ç½®
â€¢ æŒæ¡è¿›ç¨‹é—´é€šä¿¡æ–¹æ³•
â€¢ äº†è§£æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

å®é™…é¡¹ç›®ï¼š
â€¢ ä»ç®€å•çš„æ–‡ä»¶ç›‘æ§å¼€å§‹
â€¢ é€æ­¥é›†æˆå¤æ‚çš„ä¸šåŠ¡é€»è¾‘
â€¢ æ„å»ºå®Œæ•´çš„ç›‘æ§ç³»ç»Ÿ
```

**ğŸ¯ æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- inotifyè®©æ–‡ä»¶ç³»ç»Ÿå˜åŒ–"ä¸»åŠ¨é€šçŸ¥"è€Œä¸æ˜¯"è¢«åŠ¨æŸ¥è¯¢"
- while readå¾ªç¯æ˜¯å¤„ç†è¿ç»­äº‹ä»¶æµçš„æ ‡å‡†æ¨¡å¼
- äº‹ä»¶åˆ†ç±»å¤„ç†è®©ç›‘æ§ç³»ç»Ÿæ›´æ™ºèƒ½é«˜æ•ˆ
- å¤šè¿›ç¨‹å¹¶å‘ç›‘æ§éœ€è¦åˆç†çš„è¿›ç¨‹ç®¡ç†å’Œé€šä¿¡æœºåˆ¶
- æ€§èƒ½ä¼˜åŒ–çš„å…³é”®æ˜¯å‡å°‘æ— æ•ˆæ“ä½œå’Œåˆç†æ‰¹å¤„ç†
- å®é™…åº”ç”¨ä¸­é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ¢å¤æ¯”åŠŸèƒ½å®ç°æ›´é‡è¦

**ğŸ’¡ ä¸€å¥è¯æ€»ç»“**ï¼š
inotify + Shellè„šæœ¬ = è®©Linuxç³»ç»Ÿæ‹¥æœ‰"æ–‡ä»¶å˜åŒ–çš„å®æ—¶æ„ŸçŸ¥èƒ½åŠ›"ï¼Œé…åˆåˆç†çš„äº‹ä»¶å¤„ç†é€»è¾‘ï¼Œå¯ä»¥æ„å»ºå‡ºé«˜æ•ˆç¨³å®šçš„è‡ªåŠ¨åŒ–ç›‘æ§ç³»ç»Ÿã€‚