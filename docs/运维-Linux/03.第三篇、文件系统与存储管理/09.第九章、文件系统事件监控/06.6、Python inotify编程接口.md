---
title: 6ã€Python inotifyç¼–ç¨‹æ¥å£
---
## ğŸ“š ç›®å½•

1. [pyinotifyæ¨¡å—æ¦‚è¿°](#1-pyinotifyæ¨¡å—æ¦‚è¿°)
2. [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#2-æ ¸å¿ƒç»„ä»¶è¯¦è§£)
3. [åŸºç¡€ç›‘æ§å®ç°](#3-åŸºç¡€ç›‘æ§å®ç°)
4. [äº‹ä»¶å¤„ç†æœºåˆ¶](#4-äº‹ä»¶å¤„ç†æœºåˆ¶)
5. [é«˜çº§ç›‘æ§åº”ç”¨](#5-é«˜çº§ç›‘æ§åº”ç”¨)
6. [å¼‚å¸¸å¤„ç†ä¸ä¼˜åŒ–](#6-å¼‚å¸¸å¤„ç†ä¸ä¼˜åŒ–)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ pyinotifyæ¨¡å—æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯pyinotify


**pyinotify**æ˜¯Pythonä¸­ç”¨äºç›‘æ§æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶çš„ç¬¬ä¸‰æ–¹åº“ï¼Œå®ƒæ˜¯Linuxå†…æ ¸inotifyæœºåˆ¶çš„Pythonå°è£…ã€‚

```
ç®€å•ç†è§£ï¼š
å°±åƒç»™æ–‡ä»¶ç³»ç»Ÿè£…äº†ä¸ª"ç›‘æ§æ‘„åƒå¤´"
- æ–‡ä»¶è¢«åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤æ—¶è‡ªåŠ¨é€šçŸ¥ä½ 
- ä¸éœ€è¦ä¸æ–­è½®è¯¢æ£€æŸ¥ï¼Œæ•ˆç‡å¾ˆé«˜
- å¯ä»¥ç›‘æ§æ•´ä¸ªç›®å½•æ ‘çš„å˜åŒ–

å®é™…åº”ç”¨åœºæ™¯ï¼š
â€¢ æ—¥å¿—æ–‡ä»¶ç›‘æ§ï¼šæ–°æ—¥å¿—å†™å…¥æ—¶ç«‹å³å¤„ç†
â€¢ ä»£ç çƒ­é‡è½½ï¼šä»£ç ä¿®æ”¹åè‡ªåŠ¨é‡å¯æœåŠ¡
â€¢ æ–‡ä»¶åŒæ­¥ï¼šæ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨å¤‡ä»½
â€¢ å®‰å…¨ç›‘æ§ï¼šæ•æ„Ÿæ–‡ä»¶è¢«ä¿®æ”¹æ—¶æŠ¥è­¦
```

### 1.2 å®‰è£…ä¸åŸºæœ¬æ¦‚å¿µ


**å®‰è£…æ–¹å¼**ï¼š
```bash
# ä½¿ç”¨pipå®‰è£…
pip install pyinotify

# æˆ–è€…ä½¿ç”¨conda
conda install pyinotify
```

**æ ¸å¿ƒæ¦‚å¿µè§£é‡Š**ï¼š
```
ğŸ”¸ äº‹ä»¶ï¼ˆEventï¼‰ï¼šæ–‡ä»¶ç³»ç»Ÿå‘ç”Ÿçš„å˜åŒ–
   - åˆ›å»ºæ–‡ä»¶ã€åˆ é™¤æ–‡ä»¶ã€ä¿®æ”¹å†…å®¹ç­‰

ğŸ”¸ ç›‘æ§å™¨ï¼ˆWatcherï¼‰ï¼šè´Ÿè´£ç›‘å¬æŒ‡å®šè·¯å¾„
   - å¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ªç›®å½•
   - æ”¯æŒé€’å½’ç›‘æ§å­ç›®å½•

ğŸ”¸ äº‹ä»¶æ©ç ï¼ˆMaskï¼‰ï¼šå®šä¹‰è¦ç›‘æ§å“ªäº›ç±»å‹çš„äº‹ä»¶
   - IN_CREATEï¼šæ–‡ä»¶åˆ›å»º
   - IN_MODIFYï¼šæ–‡ä»¶ä¿®æ”¹  
   - IN_DELETEï¼šæ–‡ä»¶åˆ é™¤

ğŸ”¸ äº‹ä»¶å¤„ç†å™¨ï¼šæ”¶åˆ°äº‹ä»¶åæ‰§è¡Œçš„æ“ä½œ
   - å¯ä»¥è‡ªå®šä¹‰å¤„ç†é€»è¾‘
   - æ”¯æŒå¼‚æ­¥å’ŒåŒæ­¥å¤„ç†
```

---

## 2. ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶è¯¦è§£


### 2.1 WatchManagerç›‘æ§ç®¡ç†å™¨


**WatchManager**æ˜¯pyinotifyçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰çš„æ–‡ä»¶ç›‘æ§ã€‚

```python
import pyinotify

# åˆ›å»ºç›‘æ§ç®¡ç†å™¨
wm = pyinotify.WatchManager()

# ç†è§£WatchManagerçš„ä½œç”¨ï¼š
# å°±åƒä¸€ä¸ª"æ€»è°ƒåº¦å®¤"
# - å†³å®šç›‘æ§å“ªäº›ç›®å½•
# - è®¾ç½®ç›‘æ§å“ªäº›ç±»å‹çš„äº‹ä»¶
# - ç®¡ç†æ‰€æœ‰çš„ç›‘æ§ä»»åŠ¡
```

**åŸºæœ¬ä½¿ç”¨æ–¹æ³•**ï¼š
```python
# æ·»åŠ ç›‘æ§è·¯å¾„
mask = pyinotify.IN_CREATE | pyinotify.IN_DELETE | pyinotify.IN_MODIFY
wd = wm.add_watch('/path/to/monitor', mask, rec=True)

# å‚æ•°è§£é‡Šï¼š
# - path: è¦ç›‘æ§çš„ç›®å½•è·¯å¾„
# - mask: äº‹ä»¶æ©ç ï¼Œå®šä¹‰ç›‘æ§å“ªäº›äº‹ä»¶
# - rec: æ˜¯å¦é€’å½’ç›‘æ§å­ç›®å½•ï¼ˆTrue/Falseï¼‰
# - auto_add: æ–°å»ºç›®å½•æ—¶æ˜¯å¦è‡ªåŠ¨ç›‘æ§ï¼ˆé»˜è®¤Falseï¼‰
```

### 2.2 äº‹ä»¶æ©ç è¯¦è§£


**å¸¸ç”¨äº‹ä»¶ç±»å‹**ï¼š
```python
# æ–‡ä»¶æ“ä½œäº‹ä»¶
IN_CREATE    = 0x00000100   # æ–‡ä»¶/ç›®å½•åˆ›å»º
IN_DELETE    = 0x00000200   # æ–‡ä»¶/ç›®å½•åˆ é™¤
IN_MODIFY    = 0x00000002   # æ–‡ä»¶å†…å®¹ä¿®æ”¹
IN_MOVED_TO  = 0x00000080   # æ–‡ä»¶ç§»å…¥ç›‘æ§ç›®å½•
IN_MOVED_FROM= 0x00000040   # æ–‡ä»¶ç§»å‡ºç›‘æ§ç›®å½•

# è®¿é—®äº‹ä»¶
IN_ACCESS    = 0x00000001   # æ–‡ä»¶è¢«è¯»å–
IN_OPEN      = 0x00000020   # æ–‡ä»¶è¢«æ‰“å¼€
IN_CLOSE_WRITE=0x00000008   # å¯å†™æ–‡ä»¶å…³é—­

# ç»„åˆæ©ç ï¼ˆå¸¸ç”¨ï¼‰
IN_ALL_EVENTS = 0x00000fff  # æ‰€æœ‰äº‹ä»¶
```

**æ©ç ç»„åˆä½¿ç”¨**ï¼š
```python
# ç›‘æ§æ–‡ä»¶çš„åˆ›å»ºå’Œä¿®æ”¹
mask = pyinotify.IN_CREATE | pyinotify.IN_MODIFY

# ç›‘æ§æ‰€æœ‰æ–‡ä»¶æ“ä½œ
mask = pyinotify.IN_CREATE | pyinotify.IN_DELETE | pyinotify.IN_MODIFY

# ç®€å•ç²—æš´ï¼šç›‘æ§æ‰€æœ‰äº‹ä»¶
mask = pyinotify.IN_ALL_EVENTS
```

### 2.3 ProcessEventäº‹ä»¶å¤„ç†ç±»


**ProcessEvent**æ˜¯å®šä¹‰å¦‚ä½•å¤„ç†å„ç§æ–‡ä»¶äº‹ä»¶çš„åŸºç¡€ç±»ã€‚

```python
class MyEventHandler(pyinotify.ProcessEvent):
    """è‡ªå®šä¹‰äº‹ä»¶å¤„ç†å™¨"""
    
    def process_IN_CREATE(self, event):
        """å¤„ç†æ–‡ä»¶åˆ›å»ºäº‹ä»¶"""
        print(f"æ–‡ä»¶åˆ›å»º: {event.pathname}")
    
    def process_IN_DELETE(self, event):
        """å¤„ç†æ–‡ä»¶åˆ é™¤äº‹ä»¶"""
        print(f"æ–‡ä»¶åˆ é™¤: {event.pathname}")
    
    def process_IN_MODIFY(self, event):
        """å¤„ç†æ–‡ä»¶ä¿®æ”¹äº‹ä»¶"""
        print(f"æ–‡ä»¶ä¿®æ”¹: {event.pathname}")
```

**äº‹ä»¶å¯¹è±¡å±æ€§**ï¼š
```python
def process_IN_CREATE(self, event):
    print(f"ç›‘æ§æè¿°ç¬¦: {event.wd}")      # ç›‘æ§æè¿°ç¬¦ID
    print(f"äº‹ä»¶æ©ç : {event.mask}")      # äº‹ä»¶ç±»å‹æ©ç 
    print(f"æ–‡ä»¶å: {event.name}")        # æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„ï¼‰
    print(f"å®Œæ•´è·¯å¾„: {event.pathname}")  # å®Œæ•´æ–‡ä»¶è·¯å¾„
    print(f"æ˜¯å¦ç›®å½•: {event.dir}")       # æ˜¯å¦ä¸ºç›®å½•
```

### 2.4 Notifieräº‹ä»¶é€šçŸ¥å™¨


**Notifier**è´Ÿè´£æ¥æ”¶å†…æ ¸å‘é€çš„inotifyäº‹ä»¶å¹¶åˆ†å‘ç»™å¤„ç†å™¨ã€‚

```python
# åˆ›å»ºäº‹ä»¶å¤„ç†å™¨å’Œé€šçŸ¥å™¨
handler = MyEventHandler()
notifier = pyinotify.Notifier(wm, handler)

# é€šçŸ¥å™¨çš„ä½œç”¨ï¼š
# å°±åƒé‚®å±€çš„é‚®é€’å‘˜
# - ä»å†…æ ¸æ¥æ”¶äº‹ä»¶é€šçŸ¥
# - æŠŠäº‹ä»¶åˆ†å‘ç»™å¯¹åº”çš„å¤„ç†å‡½æ•°
# - å¯ä»¥è®¾ç½®åŒæ­¥æˆ–å¼‚æ­¥å¤„ç†æ¨¡å¼
```

---

## 3. ğŸ“ åŸºç¡€ç›‘æ§å®ç°


### 3.1 ç®€å•æ–‡ä»¶ç›‘æ§ç¤ºä¾‹


```python
#!/usr/bin/env python3
import pyinotify
import os

class SimpleMonitor(pyinotify.ProcessEvent):
    """ç®€å•çš„æ–‡ä»¶ç›‘æ§å™¨"""
    
    def process_IN_CREATE(self, event):
        if not event.dir:  # åªå¤„ç†æ–‡ä»¶ï¼Œä¸å¤„ç†ç›®å½•
            print(f"ğŸ“ æ–°æ–‡ä»¶åˆ›å»º: {event.name}")
    
    def process_IN_DELETE(self, event):
        if not event.dir:
            print(f"ğŸ—‘ï¸ æ–‡ä»¶åˆ é™¤: {event.name}")
    
    def process_IN_MODIFY(self, event):
        if not event.dir:
            print(f"âœï¸ æ–‡ä»¶ä¿®æ”¹: {event.name}")

def main():
    # è¦ç›‘æ§çš„ç›®å½•
    watch_path = "/tmp/test"
    
    # ç¡®ä¿ç›®å½•å­˜åœ¨
    os.makedirs(watch_path, exist_ok=True)
    
    # åˆ›å»ºç›‘æ§ç®¡ç†å™¨å’Œäº‹ä»¶å¤„ç†å™¨
    wm = pyinotify.WatchManager()
    handler = SimpleMonitor()
    notifier = pyinotify.Notifier(wm, handler)
    
    # è®¾ç½®ç›‘æ§
    mask = pyinotify.IN_CREATE | pyinotify.IN_DELETE | pyinotify.IN_MODIFY
    wm.add_watch(watch_path, mask, rec=True)
    
    print(f"å¼€å§‹ç›‘æ§ç›®å½•: {watch_path}")
    print("æŒ‰ Ctrl+C åœæ­¢ç›‘æ§")
    
    try:
        # å¼€å§‹ç›‘æ§å¾ªç¯
        notifier.loop()
    except KeyboardInterrupt:
        print("\nç›‘æ§åœæ­¢")
    finally:
        notifier.stop()

if __name__ == "__main__":
    main()
```

### 3.2 ç›‘æ§ç›®å½•ç»“æ„


```
ç›‘æ§ç›®å½•å±‚æ¬¡ç¤ºä¾‹ï¼š
/home/user/project/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.py
â”‚   â””â”€â”€ utils.py
â”œâ”€â”€ config/
â”‚   â””â”€â”€ settings.ini
â””â”€â”€ logs/
    â””â”€â”€ app.log

è®¾ç½® rec=True å¯ä»¥ç›‘æ§æ‰€æœ‰å­ç›®å½•çš„å˜åŒ–
```

---

## 4. ğŸ¯ äº‹ä»¶å¤„ç†æœºåˆ¶


### 4.1 è‡ªå®šä¹‰äº‹ä»¶å¤„ç†å‡½æ•°


```python
class AdvancedEventHandler(pyinotify.ProcessEvent):
    """é«˜çº§äº‹ä»¶å¤„ç†å™¨"""
    
    def __init__(self):
        super().__init__()
        self.file_count = 0
    
    def process_IN_CREATE(self, event):
        """å¤„ç†åˆ›å»ºäº‹ä»¶"""
        if event.dir:
            print(f"ğŸ“‚ ç›®å½•åˆ›å»º: {event.pathname}")
        else:
            self.file_count += 1
            print(f"ğŸ“„ æ–‡ä»¶åˆ›å»º: {event.pathname} (æ€»è®¡: {self.file_count})")
            
            # æ ¹æ®æ–‡ä»¶ç±»å‹è¿›è¡Œä¸åŒå¤„ç†
            if event.name.endswith('.log'):
                self.handle_log_file(event.pathname)
            elif event.name.endswith('.py'):
                self.handle_python_file(event.pathname)
    
    def process_IN_MODIFY(self, event):
        """å¤„ç†ä¿®æ”¹äº‹ä»¶"""
        if not event.dir:
            print(f"âœï¸ æ–‡ä»¶ä¿®æ”¹: {event.pathname}")
            # å¯ä»¥åœ¨è¿™é‡Œè§¦å‘çƒ­é‡è½½æˆ–å…¶ä»–æ“ä½œ
    
    def process_IN_DELETE(self, event):
        """å¤„ç†åˆ é™¤äº‹ä»¶"""
        print(f"ğŸ—‘ï¸ {'ç›®å½•' if event.dir else 'æ–‡ä»¶'}åˆ é™¤: {event.pathname}")
    
    def handle_log_file(self, filepath):
        """å¤„ç†æ—¥å¿—æ–‡ä»¶"""
        print(f"  -> è¿™æ˜¯æ—¥å¿—æ–‡ä»¶ï¼Œå¯ä»¥è¿›è¡Œæ—¥å¿—åˆ†æ")
    
    def handle_python_file(self, filepath):
        """å¤„ç†Pythonæ–‡ä»¶"""
        print(f"  -> è¿™æ˜¯Pythonæ–‡ä»¶ï¼Œå¯ä»¥è¿›è¡Œè¯­æ³•æ£€æŸ¥")
```

### 4.2 é€šç”¨äº‹ä»¶å¤„ç†æ–¹æ³•


```python
class UniversalHandler(pyinotify.ProcessEvent):
    """é€šç”¨äº‹ä»¶å¤„ç†å™¨"""
    
    def process_default(self, event):
        """å¤„ç†æ‰€æœ‰ç±»å‹çš„äº‹ä»¶"""
        event_types = {
            pyinotify.IN_CREATE: "åˆ›å»º",
            pyinotify.IN_DELETE: "åˆ é™¤", 
            pyinotify.IN_MODIFY: "ä¿®æ”¹",
            pyinotify.IN_MOVED_TO: "ç§»å…¥",
            pyinotify.IN_MOVED_FROM: "ç§»å‡º",
        }
        
        event_name = event_types.get(event.mask, "æœªçŸ¥äº‹ä»¶")
        file_type = "ç›®å½•" if event.dir else "æ–‡ä»¶"
        
        print(f"{event_name} {file_type}: {event.pathname}")
```

---

## 5. ğŸš€ é«˜çº§ç›‘æ§åº”ç”¨


### 5.1 å¼‚æ­¥äº‹ä»¶å¤„ç†æ¨¡å¼


```python
import pyinotify
import asyncio
from threading import Thread

class AsyncEventHandler(pyinotify.ProcessEvent):
    """å¼‚æ­¥äº‹ä»¶å¤„ç†å™¨"""
    
    def __init__(self, loop):
        super().__init__()
        self.loop = loop
    
    def process_IN_CREATE(self, event):
        """å¼‚æ­¥å¤„ç†åˆ›å»ºäº‹ä»¶"""
        if not event.dir:
            # å°†ä»»åŠ¡æäº¤åˆ°äº‹ä»¶å¾ªç¯
            asyncio.run_coroutine_threadsafe(
                self.async_handle_create(event.pathname), 
                self.loop
            )
    
    async def async_handle_create(self, filepath):
        """å¼‚æ­¥å¤„ç†æ–‡ä»¶åˆ›å»º"""
        print(f"å¼‚æ­¥å¤„ç†æ–‡ä»¶åˆ›å»º: {filepath}")
        # æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œï¼ˆæ¯”å¦‚ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æ“ä½œç­‰ï¼‰
        await asyncio.sleep(0.1)
        print(f"å¤„ç†å®Œæˆ: {filepath}")

def start_async_monitor(watch_path):
    """å¯åŠ¨å¼‚æ­¥ç›‘æ§"""
    # åˆ›å»ºäº‹ä»¶å¾ªç¯
    loop = asyncio.new_event_loop()
    
    # åœ¨çº¿ç¨‹ä¸­è¿è¡Œäº‹ä»¶å¾ªç¯
    def run_loop():
        asyncio.set_event_loop(loop)
        loop.run_forever()
    
    thread = Thread(target=run_loop, daemon=True)
    thread.start()
    
    # è®¾ç½®ç›‘æ§
    wm = pyinotify.WatchManager()
    handler = AsyncEventHandler(loop)
    notifier = pyinotify.Notifier(wm, handler)
    
    mask = pyinotify.IN_CREATE
    wm.add_watch(watch_path, mask, rec=True)
    
    return notifier, loop
```

### 5.2 å¤šçº¿ç¨‹ç›‘æ§å®ç°


```python
import pyinotify
import threading
import queue
import time

class ThreadedMonitor:
    """å¤šçº¿ç¨‹ç›‘æ§å™¨"""
    
    def __init__(self, watch_paths):
        self.watch_paths = watch_paths
        self.event_queue = queue.Queue()
        self.monitors = []
        self.running = False
    
    def start(self):
        """å¯åŠ¨ç›‘æ§"""
        self.running = True
        
        # ä¸ºæ¯ä¸ªè·¯å¾„å¯åŠ¨ä¸€ä¸ªç›‘æ§çº¿ç¨‹
        for path in self.watch_paths:
            monitor = MonitorThread(path, self.event_queue)
            monitor.start()
            self.monitors.append(monitor)
        
        # å¯åŠ¨äº‹ä»¶å¤„ç†çº¿ç¨‹
        self.processor = EventProcessor(self.event_queue)
        self.processor.start()
        
        print(f"å¯åŠ¨äº† {len(self.monitors)} ä¸ªç›‘æ§çº¿ç¨‹")
    
    def stop(self):
        """åœæ­¢ç›‘æ§"""
        self.running = False
        
        # åœæ­¢æ‰€æœ‰ç›‘æ§çº¿ç¨‹
        for monitor in self.monitors:
            monitor.stop()
        
        # åœæ­¢äº‹ä»¶å¤„ç†çº¿ç¨‹
        self.processor.stop()

class MonitorThread(threading.Thread):
    """å•ä¸ªè·¯å¾„çš„ç›‘æ§çº¿ç¨‹"""
    
    def __init__(self, watch_path, event_queue):
        super().__init__(daemon=True)
        self.watch_path = watch_path
        self.event_queue = event_queue
        self.running = False
    
    def run(self):
        """è¿è¡Œç›‘æ§"""
        self.running = True
        
        wm = pyinotify.WatchManager()
        handler = QueueEventHandler(self.event_queue)
        notifier = pyinotify.Notifier(wm, handler, timeout=1000)
        
        mask = pyinotify.IN_ALL_EVENTS
        wm.add_watch(self.watch_path, mask, rec=True)
        
        while self.running:
            if notifier.check_events(1000):
                notifier.read_events()
                notifier.process_events()
    
    def stop(self):
        """åœæ­¢ç›‘æ§"""
        self.running = False

class QueueEventHandler(pyinotify.ProcessEvent):
    """å°†äº‹ä»¶æ”¾å…¥é˜Ÿåˆ—çš„å¤„ç†å™¨"""
    
    def __init__(self, event_queue):
        super().__init__()
        self.event_queue = event_queue
    
    def process_default(self, event):
        """å°†æ‰€æœ‰äº‹ä»¶æ”¾å…¥é˜Ÿåˆ—"""
        self.event_queue.put({
            'type': event.mask,
            'path': event.pathname,
            'name': event.name,
            'is_dir': event.dir,
            'timestamp': time.time()
        })

class EventProcessor(threading.Thread):
    """äº‹ä»¶å¤„ç†çº¿ç¨‹"""
    
    def __init__(self, event_queue):
        super().__init__(daemon=True)
        self.event_queue = event_queue
        self.running = False
    
    def run(self):
        """å¤„ç†é˜Ÿåˆ—ä¸­çš„äº‹ä»¶"""
        self.running = True
        
        while self.running:
            try:
                # ä»é˜Ÿåˆ—è·å–äº‹ä»¶ï¼Œè¶…æ—¶1ç§’
                event = self.event_queue.get(timeout=1)
                self.handle_event(event)
                self.event_queue.task_done()
            except queue.Empty:
                continue
    
    def handle_event(self, event):
        """å¤„ç†å…·ä½“äº‹ä»¶"""
        event_types = {
            pyinotify.IN_CREATE: "åˆ›å»º",
            pyinotify.IN_DELETE: "åˆ é™¤",
            pyinotify.IN_MODIFY: "ä¿®æ”¹",
        }
        
        event_name = event_types.get(event['type'], "å…¶ä»–")
        file_type = "ç›®å½•" if event['is_dir'] else "æ–‡ä»¶"
        
        print(f"[{event['timestamp']:.2f}] {event_name} {file_type}: {event['path']}")
    
    def stop(self):
        """åœæ­¢å¤„ç†"""
        self.running = False
```

### 5.3 å®æ—¶æ—¥å¿—ç›‘æ§åº”ç”¨


```python
class LogMonitor(pyinotify.ProcessEvent):
    """å®æ—¶æ—¥å¿—ç›‘æ§å™¨"""
    
    def __init__(self, log_patterns=None):
        super().__init__()
        self.log_patterns = log_patterns or ['*.log', '*.txt']
        self.file_positions = {}  # è®°å½•æ–‡ä»¶è¯»å–ä½ç½®
    
    def process_IN_MODIFY(self, event):
        """å¤„ç†æ—¥å¿—æ–‡ä»¶ä¿®æ”¹"""
        if self.is_log_file(event.name):
            self.read_new_lines(event.pathname)
    
    def process_IN_CREATE(self, event):
        """å¤„ç†æ–°æ—¥å¿—æ–‡ä»¶åˆ›å»º"""
        if self.is_log_file(event.name):
            print(f"æ£€æµ‹åˆ°æ–°æ—¥å¿—æ–‡ä»¶: {event.pathname}")
            self.file_positions[event.pathname] = 0
    
    def is_log_file(self, filename):
        """åˆ¤æ–­æ˜¯å¦ä¸ºæ—¥å¿—æ–‡ä»¶"""
        import fnmatch
        return any(fnmatch.fnmatch(filename, pattern) 
                  for pattern in self.log_patterns)
    
    def read_new_lines(self, filepath):
        """è¯»å–æ–‡ä»¶æ–°å¢çš„è¡Œ"""
        try:
            with open(filepath, 'r', encoding='utf-8') as f:
                # ç§»åŠ¨åˆ°ä¸Šæ¬¡è¯»å–çš„ä½ç½®
                last_pos = self.file_positions.get(filepath, 0)
                f.seek(last_pos)
                
                # è¯»å–æ–°å†…å®¹
                new_lines = f.readlines()
                if new_lines:
                    print(f"ğŸ“‹ æ–‡ä»¶ {filepath} æ–°å¢å†…å®¹:")
                    for line in new_lines:
                        line = line.strip()
                        if line:
                            self.analyze_log_line(line)
                
                # æ›´æ–°ä½ç½®
                self.file_positions[filepath] = f.tell()
                
        except Exception as e:
            print(f"è¯»å–æ–‡ä»¶å‡ºé”™ {filepath}: {e}")
    
    def analyze_log_line(self, line):
        """åˆ†ææ—¥å¿—è¡Œ"""
        # ç®€å•çš„å…³é”®è¯æ£€æµ‹
        keywords = ['ERROR', 'WARNING', 'CRITICAL', 'å¼‚å¸¸']
        
        for keyword in keywords:
            if keyword in line.upper():
                print(f"  ğŸš¨ å‘ç° {keyword}: {line}")
                break
        else:
            print(f"  ğŸ“ {line}")
```

---

## 6. âš ï¸ å¼‚å¸¸å¤„ç†ä¸ä¼˜åŒ–


### 6.1 å¼‚å¸¸å¤„ç†æœºåˆ¶


```python
class RobustMonitor(pyinotify.ProcessEvent):
    """å¥å£®çš„ç›‘æ§å™¨ï¼ˆåŒ…å«å¼‚å¸¸å¤„ç†ï¼‰"""
    
    def __init__(self):
        super().__init__()
        self.error_count = 0
        self.max_errors = 10
    
    def process_default(self, event):
        """å¸¦å¼‚å¸¸å¤„ç†çš„äº‹ä»¶å¤„ç†"""
        try:
            self.handle_event_safely(event)
        except Exception as e:
            self.handle_error(e, event)
    
    def handle_event_safely(self, event):
        """å®‰å…¨å¤„ç†äº‹ä»¶"""
        # å®é™…çš„äº‹ä»¶å¤„ç†é€»è¾‘
        print(f"å¤„ç†äº‹ä»¶: {event.pathname}")
        
        # å¯èƒ½å‡ºé”™çš„æ“ä½œ
        if event.mask == pyinotify.IN_CREATE:
            self.process_create_event(event)
    
    def process_create_event(self, event):
        """å¤„ç†åˆ›å»ºäº‹ä»¶ï¼ˆå¯èƒ½å‡ºé”™ï¼‰"""
        # æ¨¡æ‹Ÿå¯èƒ½å‡ºé”™çš„æ“ä½œ
        import os
        file_size = os.path.getsize(event.pathname)
        print(f"æ–‡ä»¶å¤§å°: {file_size} å­—èŠ‚")
    
    def handle_error(self, error, event):
        """å¤„ç†å¼‚å¸¸"""
        self.error_count += 1
        print(f"å¤„ç†äº‹ä»¶æ—¶å‡ºé”™ ({self.error_count}/{self.max_errors}): {error}")
        print(f"é—®é¢˜äº‹ä»¶: {event.pathname}")
        
        if self.error_count >= self.max_errors:
            print("é”™è¯¯è¿‡å¤šï¼Œåœæ­¢ç›‘æ§")
            raise RuntimeError("ç›‘æ§å™¨é”™è¯¯è¿‡å¤š")

def create_robust_monitor(watch_path):
    """åˆ›å»ºå¥å£®çš„ç›‘æ§å™¨"""
    try:
        wm = pyinotify.WatchManager()
        handler = RobustMonitor()
        notifier = pyinotify.Notifier(wm, handler)
        
        # æ·»åŠ ç›‘æ§ï¼Œä½¿ç”¨auto_addè‡ªåŠ¨æ·»åŠ æ–°ç›®å½•
        mask = pyinotify.IN_ALL_EVENTS
        wm.add_watch(watch_path, mask, rec=True, auto_add=True)
        
        return notifier
        
    except pyinotify.WatchManagerError as e:
        print(f"ç›‘æ§ç®¡ç†å™¨é”™è¯¯: {e}")
        return None
    except Exception as e:
        print(f"åˆ›å»ºç›‘æ§å™¨å¤±è´¥: {e}")
        return None
```

### 6.2 èµ„æºæ¸…ç†ä¸ä¼˜åŒ–


```python
import signal
import sys

class OptimizedMonitor:
    """ä¼˜åŒ–çš„ç›‘æ§å™¨"""
    
    def __init__(self, watch_paths, buffer_size=1024):
        self.watch_paths = watch_paths
        self.buffer_size = buffer_size
        self.notifier = None
        self.running = False
    
    def start(self):
        """å¯åŠ¨ç›‘æ§"""
        try:
            # æ³¨å†Œä¿¡å·å¤„ç†å™¨
            signal.signal(signal.SIGINT, self.signal_handler)
            signal.signal(signal.SIGTERM, self.signal_handler)
            
            # åˆ›å»ºç›‘æ§ç»„ä»¶
            wm = pyinotify.WatchManager()
            handler = pyinotify.ProcessEvent()
            
            # è®¾ç½®ç¼“å†²åŒºå¤§å°ä¼˜åŒ–æ€§èƒ½
            self.notifier = pyinotify.Notifier(wm, handler)
            
            # æ·»åŠ å¤šä¸ªç›‘æ§è·¯å¾„
            mask = pyinotify.IN_CREATE | pyinotify.IN_MODIFY | pyinotify.IN_DELETE
            for path in self.watch_paths:
                wm.add_watch(path, mask, rec=True)
                print(f"æ·»åŠ ç›‘æ§è·¯å¾„: {path}")
            
            self.running = True
            print("ç›‘æ§å¯åŠ¨æˆåŠŸ")
            
            # å¼€å§‹ç›‘æ§å¾ªç¯
            self.notifier.loop()
            
        except Exception as e:
            print(f"å¯åŠ¨ç›‘æ§å¤±è´¥: {e}")
        finally:
            self.cleanup()
    
    def signal_handler(self, signum, frame):
        """ä¿¡å·å¤„ç†å‡½æ•°"""
        print(f"\næ¥æ”¶åˆ°ä¿¡å· {signum}ï¼Œå‡†å¤‡é€€å‡º...")
        self.stop()
    
    def stop(self):
        """åœæ­¢ç›‘æ§"""
        self.running = False
        if self.notifier:
            self.notifier.stop()
    
    def cleanup(self):
        """æ¸…ç†èµ„æº"""
        print("æ¸…ç†ç›‘æ§èµ„æº...")
        if self.notifier:
            self.notifier.stop()
        print("èµ„æºæ¸…ç†å®Œæˆ")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    paths = ["/tmp/test1", "/tmp/test2"]
    monitor = OptimizedMonitor(paths)
    
    try:
        monitor.start()
    except KeyboardInterrupt:
        print("ç”¨æˆ·ä¸­æ–­")
    finally:
        print("ç¨‹åºç»“æŸ")
```

### 6.3 æ€§èƒ½ç›‘æ§ä¸ç»Ÿè®¡


```python
import time
from collections import defaultdict, deque

class PerformanceMonitor(pyinotify.ProcessEvent):
    """æ€§èƒ½ç›‘æ§å™¨"""
    
    def __init__(self, stats_interval=60):
        super().__init__()
        self.stats_interval = stats_interval  # ç»Ÿè®¡é—´éš”ï¼ˆç§’ï¼‰
        self.event_count = defaultdict(int)   # äº‹ä»¶è®¡æ•°
        self.event_times = deque()            # äº‹ä»¶æ—¶é—´æˆ³
        self.last_stats = time.time()
    
    def process_default(self, event):
        """è®°å½•äº‹ä»¶ç»Ÿè®¡"""
        current_time = time.time()
        
        # è®°å½•äº‹ä»¶
        event_type = self.get_event_type_name(event.mask)
        self.event_count[event_type] += 1
        self.event_times.append(current_time)
        
        # æ¸…ç†è€çš„æ—¶é—´æˆ³ï¼ˆåªä¿ç•™æœ€è¿‘ä¸€åˆ†é’Ÿçš„ï¼‰
        cutoff_time = current_time - 60
        while self.event_times and self.event_times[0] < cutoff_time:
            self.event_times.popleft()
        
        # å®šæœŸè¾“å‡ºç»Ÿè®¡ä¿¡æ¯
        if current_time - self.last_stats > self.stats_interval:
            self.print_stats()
            self.last_stats = current_time
        
        # å¤„ç†å…·ä½“äº‹ä»¶
        print(f"{event_type}: {event.pathname}")
    
    def get_event_type_name(self, mask):
        """è·å–äº‹ä»¶ç±»å‹åç§°"""
        event_names = {
            pyinotify.IN_CREATE: "CREATE",
            pyinotify.IN_DELETE: "DELETE", 
            pyinotify.IN_MODIFY: "MODIFY",
            pyinotify.IN_MOVED_TO: "MOVE_TO",
            pyinotify.IN_MOVED_FROM: "MOVE_FROM",
        }
        return event_names.get(mask, f"OTHER({mask})")
    
    def print_stats(self):
        """è¾“å‡ºç»Ÿè®¡ä¿¡æ¯"""
        print("\n" + "="*50)
        print("ğŸ“Š ç›‘æ§ç»Ÿè®¡ä¿¡æ¯")
        print("="*50)
        
        # æ€»äº‹ä»¶æ•°
        total_events = sum(self.event_count.values())
        print(f"æ€»äº‹ä»¶æ•°: {total_events}")
        
        # å„ç±»äº‹ä»¶ç»Ÿè®¡
        if self.event_count:
            print("äº‹ä»¶ç±»å‹åˆ†å¸ƒ:")
            for event_type, count in sorted(self.event_count.items()):
                percentage = (count / total_events) * 100
                print(f"  {event_type}: {count} ({percentage:.1f}%)")
        
        # æœ€è¿‘ä¸€åˆ†é’Ÿäº‹ä»¶é¢‘ç‡
        recent_count = len(self.event_times)
        print(f"æœ€è¿‘1åˆ†é’Ÿäº‹ä»¶æ•°: {recent_count}")
        print(f"å¹³å‡äº‹ä»¶é¢‘ç‡: {recent_count/60:.2f} äº‹ä»¶/ç§’")
        
        print("="*50 + "\n")
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ pyinotifyï¼šPythonçš„inotifyå°è£…åº“ï¼Œç”¨äºæ–‡ä»¶ç³»ç»Ÿäº‹ä»¶ç›‘æ§
ğŸ”¸ WatchManagerï¼šç›‘æ§ç®¡ç†å™¨ï¼Œè´Ÿè´£æ·»åŠ å’Œç®¡ç†ç›‘æ§è·¯å¾„
ğŸ”¸ ProcessEventï¼šäº‹ä»¶å¤„ç†åŸºç±»ï¼Œå®šä¹‰å„ç§äº‹ä»¶çš„å¤„ç†æ–¹æ³•
ğŸ”¸ Notifierï¼šäº‹ä»¶é€šçŸ¥å™¨ï¼Œè´Ÿè´£æ¥æ”¶å’Œåˆ†å‘äº‹ä»¶
ğŸ”¸ äº‹ä»¶æ©ç ï¼šå®šä¹‰è¦ç›‘æ§çš„äº‹ä»¶ç±»å‹ï¼ˆåˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ç­‰ï¼‰
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç›‘æ§æœºåˆ¶çš„æœ¬è´¨**
```
å†…æ ¸å±‚é¢ï¼š
â€¢ Linuxå†…æ ¸çš„inotifyæœºåˆ¶æä¾›åº•å±‚æ”¯æŒ
â€¢ ä¸éœ€è¦è½®è¯¢ï¼Œäº‹ä»¶é©±åŠ¨ï¼Œæ•ˆç‡é«˜
â€¢ ç›´æ¥ç”±å†…æ ¸é€šçŸ¥ï¼Œå®æ—¶æ€§å¥½

åº”ç”¨å±‚é¢ï¼š
â€¢ pyinotifyå°è£…äº†å¤æ‚çš„åº•å±‚æ“ä½œ
â€¢ æä¾›é¢å‘å¯¹è±¡çš„ç¼–ç¨‹æ¥å£
â€¢ æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥å¤„ç†æ¨¡å¼
```

**ğŸ”¹ äº‹ä»¶å¤„ç†çš„å±‚æ¬¡**
```
äº‹ä»¶äº§ç”Ÿï¼šæ–‡ä»¶ç³»ç»Ÿæ“ä½œè§¦å‘å†…æ ¸äº‹ä»¶
äº‹ä»¶æ¥æ”¶ï¼šWatchManageræ¥æ”¶å†…æ ¸é€šçŸ¥
äº‹ä»¶åˆ†å‘ï¼šNotifierå°†äº‹ä»¶åˆ†å‘ç»™å¤„ç†å™¨
äº‹ä»¶å¤„ç†ï¼šProcessEventçš„å­ç±»å¤„ç†å…·ä½“äº‹ä»¶
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
åˆç†è®¾ç½®æ©ç ï¼šåªç›‘æ§éœ€è¦çš„äº‹ä»¶ç±»å‹
ä½¿ç”¨é€’å½’ç›‘æ§ï¼šrec=Trueå¯ä»¥ç›‘æ§å­ç›®å½•
å¼‚æ­¥å¤„ç†ï¼šé¿å…äº‹ä»¶å¤„ç†é˜»å¡ç›‘æ§å¾ªç¯
èµ„æºç®¡ç†ï¼šåŠæ—¶æ¸…ç†ç›‘æ§èµ„æº
```

### 7.3 å®é™…åº”ç”¨åœºæ™¯


**å¸¸è§åº”ç”¨**ï¼š
- **å¼€å‘å·¥å…·**ï¼šä»£ç ä¿®æ”¹åè‡ªåŠ¨é‡å¯æœåŠ¡
- **æ—¥å¿—ç›‘æ§**ï¼šå®æ—¶åˆ†ææ—¥å¿—æ–‡ä»¶å˜åŒ–  
- **æ–‡ä»¶åŒæ­¥**ï¼šæ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨å¤‡ä»½åŒæ­¥
- **å®‰å…¨ç›‘æ§**ï¼šæ•æ„Ÿæ–‡ä»¶ä¿®æ”¹æ—¶æŠ¥è­¦
- **è‡ªåŠ¨åŒ–è„šæœ¬**ï¼šæ–‡ä»¶å˜åŒ–è§¦å‘ç‰¹å®šæ“ä½œ

**é€‰æ‹©å»ºè®®**ï¼š
```
ç®€å•ç›‘æ§ï¼šä½¿ç”¨åŸºæœ¬çš„ProcessEventå³å¯
é«˜æ€§èƒ½åœºæ™¯ï¼šè€ƒè™‘å¼‚æ­¥å¤„ç†æˆ–å¤šçº¿ç¨‹
å¤æ‚åº”ç”¨ï¼šç»“åˆé˜Ÿåˆ—å’Œçº¿ç¨‹æ± 
ç”Ÿäº§ç¯å¢ƒï¼šå¿…é¡»æ·»åŠ å¼‚å¸¸å¤„ç†å’Œèµ„æºæ¸…ç†
```

### 7.4 å¸¸è§é—®é¢˜ä¸è§£å†³


**ç›‘æ§ä¸ç”Ÿæ•ˆ**ï¼š
- æ£€æŸ¥è·¯å¾„æ˜¯å¦å­˜åœ¨å’Œæœ‰æƒé™
- ç¡®è®¤äº‹ä»¶æ©ç è®¾ç½®æ­£ç¡®
- éªŒè¯é€’å½’ç›‘æ§å‚æ•°

**æ€§èƒ½é—®é¢˜**ï¼š
- é¿å…ç›‘æ§è¿‡å¤šç›®å½•
- åˆç†è®¾ç½®äº‹ä»¶æ©ç 
- ä½¿ç”¨å¼‚æ­¥å¤„ç†

**èµ„æºæ³„éœ²**ï¼š
- ä½¿ç”¨try-finallyç¡®ä¿èµ„æºæ¸…ç†
- æ³¨å†Œä¿¡å·å¤„ç†å™¨ä¼˜é›…é€€å‡º
- å®šæœŸæ¸…ç†ä¸éœ€è¦çš„ç›‘æ§

**æ ¸å¿ƒè®°å¿†**ï¼š
- pyinotifyè®©æ–‡ä»¶ç›‘æ§å˜å¾—ç®€å•é«˜æ•ˆ
- WatchManagerç®¡ç†ç›‘æ§ï¼ŒProcessEventå¤„ç†äº‹ä»¶
- äº‹ä»¶æ©ç å†³å®šç›‘æ§èŒƒå›´ï¼ŒNotifierè´Ÿè´£äº‹ä»¶åˆ†å‘
- å¼‚å¸¸å¤„ç†å’Œèµ„æºæ¸…ç†æ˜¯ç”Ÿäº§åº”ç”¨çš„å…³é”®