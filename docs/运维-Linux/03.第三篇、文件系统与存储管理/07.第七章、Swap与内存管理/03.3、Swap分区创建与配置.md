---
title: 3、Swap分区创建与配置
---
## 📚 目录

1. [Swap分区基本概念](#1-swap分区基本概念)
2. [fdisk创建Swap分区](#2-fdisk创建swap分区)
3. [mkswap格式化交换分区](#3-mkswap格式化交换分区)
4. [swapon激活交换分区](#4-swapon激活交换分区)
5. [永久挂载配置](#5-永久挂载配置)
6. [分区大小规划](#6-分区大小规划)
7. [高级配置与管理](#7-高级配置与管理)
8. [安全考虑与最佳实践](#8-安全考虑与最佳实践)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 💾 Swap分区基本概念


### 1.1 什么是Swap分区


**简单理解**：Swap分区就是硬盘上的一块特殊区域，当内存不够用时，系统会把一些暂时不用的数据搬到这里存放，腾出内存给正在运行的程序使用。

```
内存示意图：
┌─────────────────┐
│   物理内存RAM    │ ← 速度快，容量小，价格贵
│  [程序][数据]   │
└─────────────────┘
        ↕ 数据交换
┌─────────────────┐
│   Swap交换分区   │ ← 速度慢，容量大，价格便宜
│  [临时数据]     │
└─────────────────┘
```

**核心作用**：
- 🔄 **扩展内存** - 让系统能运行更多程序
- 🛡️ **内存保护** - 防止程序因内存不足崩溃
- 💤 **休眠支持** - 保存系统休眠时的内存状态

### 1.2 Swap工作原理


**工作过程**：
1. **内存充足时** - 程序正常在内存中运行
2. **内存不足时** - 系统把不常用的数据移到Swap
3. **需要数据时** - 系统再把数据从Swap搬回内存
4. **循环往复** - 这个过程叫做"页面交换"

```
交换过程示意：
时刻1: RAM满载          时刻2: 部分数据换出
┌─────────────┐        ┌─────────────┐
│ 程序A程序B  │   →    │ 程序A新程序 │
│ 程序C数据   │        │ 数据       │
└─────────────┘        └─────────────┘
                              ↓
                       ┌─────────────┐
                       │ Swap: 程序B │
                       │      程序C │
                       └─────────────┘
```

> 💡 **通俗比喻**
> 
> Swap就像是你桌子旁边的柜子：桌子（内存）空间有限，当桌子放满了，你就把暂时不用的东西放到柜子（Swap）里。需要时再从柜子里拿出来放到桌子上。

---

## 2. 🔧 fdisk创建Swap分区


### 2.1 准备工作与硬盘查看


**第一步：查看现有磁盘情况**
```bash
# 查看所有磁盘和分区
lsblk
```

**输出示例**：
```
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda      8:0    0   20G  0 disk 
├─sda1   8:1    0   18G  0 part /
├─sda2   8:2    0    1G  0 part [SWAP]
└─sda3   8:3    0    1G  0 part 
sdb      8:16   0   10G  0 disk  ← 新硬盘，准备创建Swap
```

**查看详细磁盘信息**：
```bash
# 查看磁盘分区表
sudo fdisk -l
```

> ⚠️ **重要提醒**
> 
> 创建分区会影响磁盘数据，操作前务必备份重要数据！

### 2.2 fdisk分区操作详解


**启动fdisk工具**：
```bash
# 对/dev/sdb磁盘进行分区操作
sudo fdisk /dev/sdb
```

**fdisk交互式操作流程**：

```
步骤 1️⃣：进入fdisk界面
Command (m for help): m    ← 输入m查看帮助

常用命令说明：
  n   创建新分区
  d   删除分区
  t   更改分区类型
  p   显示分区表
  w   保存并退出
  q   不保存退出
```

**创建Swap分区的完整过程**：

```bash
Command (m for help): n    ← 创建新分区
```

```
分区类型选择：
Select (default p): p      ← 选择主分区(primary)

分区号选择：
Partition number (1-4): 1  ← 选择分区号1

起始扇区：
First sector: [默认]      ← 直接回车使用默认值

结束扇区（确定分区大小）：
Last sector: +2G          ← 创建2GB的分区
```

**设置分区类型为Swap**：
```bash
Command (m for help): t    ← 更改分区类型
Partition number (1): 1    ← 选择刚创建的分区1
Hex code: 82              ← 输入82（Linux swap类型）
```

> 📚 **分区类型码说明**
> 
> - **82** = Linux swap（交换分区）
> - **83** = Linux（普通文件系统）
> - **8e** = Linux LVM

**验证分区设置**：
```bash
Command (m for help): p    ← 查看分区表
```

**输出示例**：
```
Device     Boot Start   End Sectors Size Id Type
/dev/sdb1        2048  4196351 4194304   2G 82 Linux swap
```

**保存分区设置**：
```bash
Command (m for help): w    ← 写入分区表并退出
```

### 2.3 分区创建验证


**重新扫描分区表**：
```bash
# 通知系统重新读取分区表
sudo partprobe /dev/sdb
```

**验证新分区**：
```bash
# 查看新创建的分区
lsblk | grep sdb
```

**预期输出**：
```
sdb      8:16   0  10G  0 disk
└─sdb1   8:17   0   2G  0 part  ← 新创建的swap分区
```

---

## 3. 🛠️ mkswap格式化交换分区


### 3.1 mkswap命令基础


**mkswap的作用**：把普通分区格式化成Swap格式，让系统能够识别和使用这个分区作为交换空间。

**基本语法**：
```bash
sudo mkswap [选项] 设备名
```

### 3.2 格式化交换分区


**基础格式化命令**：
```bash
# 将/dev/sdb1格式化为swap分区
sudo mkswap /dev/sdb1
```

**输出示例**：
```
Setting up swapspace version 1, size = 2 GiB (2147479552 bytes)
no label, UUID=a1b2c3d4-e5f6-7890-abcd-ef1234567890
```

> 💡 **理解UUID**
> 
> UUID（通用唯一识别码）是系统为每个分区分配的唯一标识符，即使分区位置改变，UUID也不会变，这让分区管理更可靠。

**带标签的格式化**：
```bash
# 创建带标签的swap分区，方便管理
sudo mkswap -L myswap /dev/sdb1
```

**带UUID的格式化**：
```bash
# 指定特定UUID（可选）
sudo mkswap -U a1b2c3d4-e5f6-7890-abcd-ef1234567890 /dev/sdb1
```

### 3.3 格式化验证


**查看swap分区信息**：
```bash
# 显示分区的UUID和标签
sudo blkid /dev/sdb1
```

**输出示例**：
```
/dev/sdb1: LABEL="myswap" UUID="a1b2c3d4-e5f6-7890-abcd-ef1234567890" TYPE="swap" PARTUUID="12345678-01"
```

**查看分区详细信息**：
```bash
# 查看文件系统信息
file -s /dev/sdb1
```

---

## 4. ⚡ swapon激活交换分区


### 4.1 swapon命令详解


**swapon的作用**：激活（启用）交换分区，让系统开始使用这个分区进行内存交换。

**基本语法**：
```bash
sudo swapon [选项] 设备名
```

### 4.2 激活交换分区


**立即激活swap分区**：
```bash
# 激活刚创建的swap分区
sudo swapon /dev/sdb1
```

**使用UUID激活**：
```bash
# 通过UUID激活（更安全可靠）
sudo swapon UUID=a1b2c3d4-e5f6-7890-abcd-ef1234567890
```

**使用标签激活**：
```bash
# 通过标签激活
sudo swapon LABEL=myswap
```

### 4.3 查看交换分区状态


**查看当前活跃的swap**：
```bash
# 显示所有激活的交换分区
sudo swapon -s
```

**输出示例**：
```
Filename        Type        Size    Used    Priority
/dev/sda2       partition   1048572 0       -2
/dev/sdb1       partition   2097148 0       -3
```

**使用free命令查看**：
```bash
# 查看内存和swap使用情况
free -h
```

**输出示例**：
```
              total        used        free      shared  buff/cache   available
Mem:          3.9Gi       1.2Gi       1.8Gi        50Mi       890Mi        2.5Gi
Swap:         3.0Gi          0B       3.0Gi  ← 总swap空间增加到3GB
```

### 4.4 交换分区优先级


**理解优先级概念**：
- 数值越高，优先级越高
- 相同优先级的swap会轮流使用
- 默认优先级从-2开始递减

**设置优先级**：
```bash
# 设置高优先级（0是最高优先级）
sudo swapon -p 10 /dev/sdb1
```

**查看优先级设置**：
```bash
cat /proc/swaps
```

---

## 5. 📝 永久挂载配置


### 5.1 /etc/fstab文件详解


**fstab的作用**：这是Linux系统的"自动挂载配置文件"，系统启动时会读取这个文件，自动挂载里面配置的分区和设备。

**fstab文件结构**：
```
设备标识  挂载点  文件系统类型  选项  转储  检查
```

### 5.2 添加swap到fstab


**查看当前fstab内容**：
```bash
cat /etc/fstab
```

**典型fstab文件内容**：
```bash
# <设备>                           <挂载点>  <类型>  <选项>    <转储> <检查>
UUID=12345678-1234-1234-1234-123456789012 /         ext4    defaults     1      1
UUID=abcdef12-3456-7890-abcd-ef1234567890 none      swap    defaults     0      0
```

**添加新的swap配置**：
```bash
# 备份原文件
sudo cp /etc/fstab /etc/fstab.backup

# 编辑fstab文件
sudo vim /etc/fstab
```

**添加swap条目的三种方式**：

<details>
<summary>🔍 点击查看三种配置方式详解</summary>

**方式1：使用设备名（不推荐）**
```bash
/dev/sdb1  none  swap  defaults  0  0
```

**方式2：使用UUID（推荐）**
```bash
UUID=a1b2c3d4-e5f6-7890-abcd-ef1234567890  none  swap  defaults  0  0
```

**方式3：使用标签**
```bash
LABEL=myswap  none  swap  defaults  0  0
```

</details>

> 🔥 **最佳实践**
> 
> 推荐使用UUID方式，因为即使硬盘连接顺序改变，UUID也不会变，系统仍能正确找到swap分区。

### 5.3 fstab字段详解


**字段含义解释**：

| 字段位置 | 名称 | Swap配置值 | 含义说明 |
|---------|------|-----------|----------|
| 1️⃣ | 设备标识 | `UUID=...` | 使用UUID标识swap分区 |
| 2️⃣ | 挂载点 | `none` | swap不需要挂载点 |
| 3️⃣ | 文件系统 | `swap` | 指定为swap类型 |
| 4️⃣ | 选项 | `defaults` | 使用默认挂载选项 |
| 5️⃣ | 转储 | `0` | 不进行备份转储 |
| 6️⃣ | 检查 | `0` | 不进行文件系统检查 |

### 5.4 验证fstab配置


**测试fstab配置正确性**：
```bash
# 先关闭当前swap
sudo swapoff /dev/sdb1

# 测试fstab配置是否正确
sudo swapon -a

# 查看是否成功激活
free -h
```

**如果配置错误**：
```bash
# 恢复备份文件
sudo cp /etc/fstab.backup /etc/fstab
```

---

## 6. 📏 分区大小规划


### 6.1 Swap大小规划策略


**传统规则**：
```
物理内存大小     推荐Swap大小
≤ 2GB           2 × 内存大小
2GB - 8GB       = 内存大小  
8GB - 64GB      0.5 × 内存大小
> 64GB          4GB - 8GB
```

**现代规划建议**：

```
使用场景分析：
桌面用户：     内存 8GB  → Swap 4-8GB
服务器：       内存 16GB → Swap 2-4GB  
数据库服务器： 内存 32GB → Swap 4-8GB
虚拟化主机：   内存 64GB → Swap 8GB
```

### 6.2 特殊需求考虑


**休眠功能需求**：
```bash
# 如果需要休眠功能，swap大小应该 >= 物理内存
# 例如：8GB内存的电脑，swap至少需要8GB
```

**应用特殊需求**：
```
高内存消耗应用：  适当增加swap大小
内存充足系统：    可以减少或不使用swap  
SSD固态硬盘：    适当减少swap使用，延长寿命
机械硬盘：       正常使用swap
```

### 6.3 动态调整策略


**监控内存使用情况**：
```bash
# 实时监控内存和swap使用
watch -n 1 'free -h'
```

**分析swap使用模式**：
```bash
# 查看swap使用历史
sar -S 1 10
```

---

## 7. 🔧 高级配置与管理


### 7.1 多个Swap分区配置


**为什么需要多个swap分区**：
- **性能提升** - 并行读写多个分区
- **可靠性** - 一个分区损坏不影响其他
- **灵活管理** - 不同分区可设置不同优先级

**多分区配置示例**：
```bash
# fstab中配置多个swap分区
UUID=uuid1  none  swap  defaults,pri=10  0  0  # 高优先级
UUID=uuid2  none  swap  defaults,pri=5   0  0  # 中优先级  
UUID=uuid3  none  swap  defaults,pri=1   0  0  # 低优先级
```

### 7.2 Swap分区标签管理


**创建有意义的标签**：
```bash
# 为不同用途的swap分区设置标签
sudo mkswap -L swap-fast /dev/sdb1    # 快速SSD上的swap
sudo mkswap -L swap-large /dev/sdc1   # 大容量机械盘上的swap
```

**标签的好处**：
- 🏷️ **便于识别** - 清楚知道每个分区的用途
- 🔧 **便于管理** - 可以通过标签操作特定分区
- 📝 **文档化** - 配置文件更容易理解

### 7.3 Swap使用监控


**创建监控脚本**：
```bash
#!/bin/bash
# swap_monitor.sh - 监控swap使用情况

echo "=== Swap使用情况监控 ==="
echo "时间: $(date)"
echo

# 显示swap总体情况
echo "📊 Swap总体状态:"
free -h | grep -E "Mem|Swap"

echo
echo "📋 详细Swap分区信息:"
cat /proc/swaps

echo
echo "📈 内存压力情况:"
cat /proc/vmstat | grep -E "pgpgin|pgpgout|pswpin|pswpout"
```

### 7.4 临时Swap文件


**创建临时swap文件**：
```bash
# 创建1GB的swap文件
sudo dd if=/dev/zero of=/tmp/swapfile bs=1M count=1024

# 设置权限
sudo chmod 600 /tmp/swapfile

# 格式化为swap
sudo mkswap /tmp/swapfile

# 激活使用
sudo swapon /tmp/swapfile
```

**临时文件的用途**：
- 🚑 **应急使用** - 临时增加swap空间
- 🧪 **测试目的** - 测试swap配置
- 🔄 **动态调整** - 根据需要临时调整

---

## 8. 🔒 安全考虑与最佳实践


### 8.1 Swap安全风险


**数据泄露风险**：
```
风险说明：
敏感数据（密码、密钥等）可能被写入swap分区
系统关闭后，数据仍残留在磁盘上
恶意用户可能读取swap分区恢复敏感信息
```

**敏感数据示例**：
- 🔑 用户密码和认证信息
- 🗝️ SSL/TLS私钥
- 💳 信用卡号等个人信息
- 📄 机密文档内容

### 8.2 Swap加密配置


**启用swap加密**：
```bash
# 安装加密工具
sudo apt install cryptsetup

# 创建加密的swap分区
sudo cryptsetup luksFormat /dev/sdb1

# 打开加密分区
sudo cryptsetup luksOpen /dev/sdb1 encrypted-swap

# 格式化为swap
sudo mkswap /dev/mapper/encrypted-swap

# 激活加密swap
sudo swapon /dev/mapper/encrypted-swap
```

**加密swap的fstab配置**：
```bash
# 在/etc/crypttab中配置
echo "encrypted-swap /dev/sdb1 none swap" >> /etc/crypttab

# 在/etc/fstab中配置
echo "/dev/mapper/encrypted-swap none swap defaults 0 0" >> /etc/fstab
```

### 8.3 权限与访问控制


**swap文件权限设置**：
```bash
# 如果使用swap文件，设置正确权限
sudo chmod 600 /swapfile
sudo chown root:root /swapfile
```

**监控swap访问**：
```bash
# 监控哪些进程在使用swap
sudo smem -s swap
```

### 8.4 性能优化建议


**swappiness参数调优**：
```bash
# 查看当前swappiness值
cat /proc/sys/vm/swappiness

# 临时调整（0-100，数值越小越不愿意使用swap）
sudo sysctl vm.swappiness=10

# 永久调整
echo "vm.swappiness=10" >> /etc/sysctl.conf
```

**swappiness值含义**：
```
数值范围：0-100
  0-10:  极少使用swap，只在内存极度不足时使用
 10-60:  平衡使用，根据内存压力决定
60-100:  积极使用swap，更早将数据交换出去
```

> 💡 **调优建议**
> 
> - **桌面系统**：设置为10-20，减少卡顿
> - **服务器**：设置为1-10，保持性能
> - **数据库服务器**：设置为1，避免数据库性能下降

---

## 9. 📋 核心要点总结


### 9.1 必掌握的操作流程


**完整创建流程**：
```
1️⃣ fdisk创建分区     → 硬盘上划分空间
2️⃣ mkswap格式化      → 让系统识别为swap
3️⃣ swapon激活        → 开始使用交换功能  
4️⃣ fstab永久配置     → 开机自动激活
5️⃣ 验证和监控        → 确保正常工作
```

### 9.2 关键命令速查


| 操作类型 | 命令示例 | 作用说明 |
|---------|---------|----------|
| **查看状态** | `free -h` | 查看内存和swap使用情况 |
| **分区操作** | `sudo fdisk /dev/sdb` | 创建分区 |
| **格式化** | `sudo mkswap /dev/sdb1` | 格式化为swap |
| **激活** | `sudo swapon /dev/sdb1` | 启用swap分区 |
| **停用** | `sudo swapoff /dev/sdb1` | 停用swap分区 |
| **查看详情** | `cat /proc/swaps` | 查看所有激活的swap |

### 9.3 重要注意事项


> ⚠️ **操作前必读**
> 
> 1. **备份数据** - 分区操作有风险，务必备份
> 2. **确认设备名** - 确保操作正确的磁盘
> 3. **测试配置** - fstab配置错误会影响系统启动
> 4. **权限管理** - swap操作需要root权限

> 🔥 **性能优化要点**
> 
> 1. **SSD vs 机械盘** - SSD上适当减少swap使用
> 2. **合理规划大小** - 根据实际使用情况调整
> 3. **监控使用情况** - 定期检查swap使用率
> 4. **调整swappiness** - 根据场景优化交换策略

### 9.4 故障排查指南


**常见问题及解决**：

```
问题1: swapon失败
排查: sudo swapon /dev/sdb1
解决: 检查分区是否存在，格式是否正确

问题2: 开机swap未自动激活  
排查: cat /etc/fstab
解决: 检查fstab配置语法是否正确

问题3: swap使用率过高
排查: free -h 和 top命令
解决: 增加物理内存或优化应用程序

问题4: 系统变慢
排查: iostat -x 1 查看磁盘IO
解决: 调整swappiness参数或使用更快的存储
```

**应急处理**：
```bash
# 如果swap导致系统问题，紧急停用所有swap
sudo swapoff -a

# 重新启用
sudo swapon -a
```

**核心记忆要点**：
- Swap是硬盘上的虚拟内存扩展空间
- 创建过程：分区→格式化→激活→配置自启
- 大小规划要考虑内存大小和使用场景  
- 安全性考虑包括加密和权限控制
- 性能调优重点是swappiness参数设置