---
title: 12ã€ç›‘æ§æ•…éšœæ’æŸ¥è°ƒè¯•
---
## ğŸ“š ç›®å½•


1. [inotifyäº‹ä»¶ä¸¢å¤±è¯Šæ–­](#1-inotifyäº‹ä»¶ä¸¢å¤±è¯Šæ–­)
2. [ç›‘æ§è¿›ç¨‹å¼‚å¸¸é€€å‡ºæ’æŸ¥](#2-ç›‘æ§è¿›ç¨‹å¼‚å¸¸é€€å‡ºæ’æŸ¥)
3. [é«˜è´Ÿè½½ä¸‹ç›‘æ§å¤±æ•ˆ](#3-é«˜è´Ÿè½½ä¸‹ç›‘æ§å¤±æ•ˆ)
4. [æ–‡ä»¶ç³»ç»Ÿç±»å‹å…¼å®¹æ€§](#4-æ–‡ä»¶ç³»ç»Ÿç±»å‹å…¼å®¹æ€§)
5. [ç›‘æ§è„šæœ¬è°ƒè¯•æŠ€å·§](#5-ç›‘æ§è„šæœ¬è°ƒè¯•æŠ€å·§)
6. [å†…æ ¸é™åˆ¶é—®é¢˜è§£å†³](#6-å†…æ ¸é™åˆ¶é—®é¢˜è§£å†³)
7. [æƒé™é—®é¢˜è¯Šæ–­æ–¹æ³•](#7-æƒé™é—®é¢˜è¯Šæ–­æ–¹æ³•)
8. [ç›‘æ§æ€§èƒ½ç“¶é¢ˆåˆ†æ](#8-ç›‘æ§æ€§èƒ½ç“¶é¢ˆåˆ†æ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” inotifyäº‹ä»¶ä¸¢å¤±è¯Šæ–­



### 1.1 ä»€ä¹ˆæ˜¯äº‹ä»¶ä¸¢å¤±



**ç®€å•ç†è§£**ï¼šinotifyäº‹ä»¶ä¸¢å¤±å°±åƒä½ çœ¼ç›çœ¨äº†ä¸€ä¸‹ï¼Œé”™è¿‡äº†æŸä¸ªåŠ¨ä½œä¸€æ ·ã€‚æœ¬æ¥åº”è¯¥ç›‘æ§åˆ°çš„æ–‡ä»¶å˜åŒ–ï¼Œç³»ç»Ÿå´æ²¡æœ‰é€šçŸ¥ä½ çš„ç¨‹åºã€‚

```
æ­£å¸¸æƒ…å†µï¼š
æ–‡ä»¶åˆ›å»º â†’ inotifyæ£€æµ‹åˆ° â†’ ç¨‹åºæ”¶åˆ°é€šçŸ¥ â†’ æ‰§è¡ŒåŠ¨ä½œ

äº‹ä»¶ä¸¢å¤±ï¼š
æ–‡ä»¶åˆ›å»º â†’ inotifyæ²¡æ£€æµ‹åˆ° âŒ â†’ ç¨‹åºæ²¡æ”¶åˆ°é€šçŸ¥ â†’ æ²¡æœ‰æ‰§è¡ŒåŠ¨ä½œ
```

### 1.2 äº‹ä»¶ä¸¢å¤±çš„å¸¸è§åŸå› 



**ğŸ”¸ ç¼“å†²åŒºæº¢å‡º**
```bash
# æŸ¥çœ‹inotifyé˜Ÿåˆ—çŠ¶æ€

cat /proc/sys/fs/inotify/max_queued_events
# é»˜è®¤å€¼é€šå¸¸æ˜¯16384


# æ£€æŸ¥å½“å‰é˜Ÿåˆ—ä½¿ç”¨æƒ…å†µ

ls /proc/*/fd/ | xargs -I {} readlink {} 2>/dev/null | grep inotify | wc -l
```

**ğŸ”¸ ç›‘æ§å¥æŸ„ä¸è¶³**
```bash
# æŸ¥çœ‹å½“å‰inotifyå®ä¾‹æ•°é‡é™åˆ¶

cat /proc/sys/fs/inotify/max_user_instances
# é»˜è®¤å€¼é€šå¸¸æ˜¯128


# æŸ¥çœ‹æ¯ä¸ªå®ä¾‹çš„ç›‘æ§æ•°é‡é™åˆ¶  

cat /proc/sys/fs/inotify/max_user_watches
# é»˜è®¤å€¼é€šå¸¸æ˜¯8192

```

### 1.3 è¯Šæ–­äº‹ä»¶ä¸¢å¤±çš„æ–¹æ³•



**æ–¹æ³•ä¸€ï¼šä½¿ç”¨dmesgæ£€æŸ¥å†…æ ¸æ—¥å¿—**
```bash
# æŸ¥çœ‹inotifyç›¸å…³é”™è¯¯

dmesg | grep -i inotify
dmesg | grep "inotify.*queue overflow"
```

**æ–¹æ³•äºŒï¼šç›‘æ§inotifyç»Ÿè®¡ä¿¡æ¯**
```bash
#!/bin/bash

# inotify_monitor.sh - ç›‘æ§inotifyä½¿ç”¨æƒ…å†µ


while true; do
    echo "=== $(date) ==="
    echo "æ’é˜Ÿäº‹ä»¶æ•°: $(cat /proc/sys/fs/inotify/max_queued_events)"
    echo "å®ä¾‹æ•°é™åˆ¶: $(cat /proc/sys/fs/inotify/max_user_instances)" 
    echo "ç›‘æ§æ•°é™åˆ¶: $(cat /proc/sys/fs/inotify/max_user_watches)"
    
#    # ç»Ÿè®¡å½“å‰inotifyä½¿ç”¨é‡
    active_watches=$(find /proc/*/fd -type l 2>/dev/null | \
                    xargs readlink 2>/dev/null | \
                    grep inotify | wc -l)
    echo "å½“å‰æ´»è·ƒç›‘æ§: $active_watches"
    
    sleep 5
done
```

### 1.4 è§£å†³äº‹ä»¶ä¸¢å¤±é—®é¢˜



**ğŸ”§ è°ƒæ•´å†…æ ¸å‚æ•°**
```bash
# ä¸´æ—¶è°ƒæ•´ï¼ˆé‡å¯åå¤±æ•ˆï¼‰

echo 65536 > /proc/sys/fs/inotify/max_queued_events
echo 256 > /proc/sys/fs/inotify/max_user_instances
echo 65536 > /proc/sys/fs/inotify/max_user_watches

# æ°¸ä¹…è°ƒæ•´ï¼ˆå†™å…¥é…ç½®æ–‡ä»¶ï¼‰

cat >> /etc/sysctl.conf << EOF
fs.inotify.max_queued_events = 65536
fs.inotify.max_user_instances = 256
fs.inotify.max_user_watches = 65536
EOF

# åº”ç”¨é…ç½®

sysctl -p
```

**ğŸ”§ ä¼˜åŒ–ç›‘æ§ç¨‹åº**
```bash
# ä½¿ç”¨inotifywaitæ—¶å¢åŠ ç¼“å†²åŒº

inotifywait -m -r --format '%w%f %e' \
    -e create,delete,modify \
    --buffer 1024 \
    /path/to/watch
```

---

## 2. âš ï¸ ç›‘æ§è¿›ç¨‹å¼‚å¸¸é€€å‡ºæ’æŸ¥



### 2.1 ç›‘æ§è¿›ç¨‹ä¸ºä»€ä¹ˆä¼šé€€å‡º



**å¸¸è§é€€å‡ºåŸå› **ï¼š
- ğŸ’¥ **ç¨‹åºå´©æºƒ**ï¼šä»£ç bugæˆ–å†…å­˜ä¸è¶³
- ğŸ›‘ **è¢«ç³»ç»Ÿæ€æ­»**ï¼šOOM Killeræ€æ­»è¿›ç¨‹
- âŒ **é…ç½®é”™è¯¯**ï¼šç›‘æ§è·¯å¾„ä¸å­˜åœ¨æˆ–æƒé™ä¸è¶³
- ğŸ”Œ **èµ„æºè€—å°½**ï¼šæ–‡ä»¶æè¿°ç¬¦ç”¨å®Œ

### 2.2 é€€å‡ºåŸå› è¯Šæ–­æ–¹æ³•



**ğŸ” æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—**
```bash
# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ä¸­çš„è¿›ç¨‹é€€å‡ºä¿¡æ¯

journalctl -u your-monitor-service | tail -50

# æŸ¥çœ‹å†…æ ¸æ—¥å¿—ï¼ˆOOM Killerä¿¡æ¯ï¼‰

dmesg | grep -E "(killed|oom|out of memory)"

# æŸ¥çœ‹ç¨‹åºå´©æºƒä¿¡æ¯

cat /var/log/messages | grep -i "segfault\|core dump"
```

**ğŸ” åˆ†æè¿›ç¨‹é€€å‡ºçŠ¶æ€**
```bash
#!/bin/bash

# process_monitor.sh - ç›‘æ§è¿›ç¨‹é€€å‡ºçŠ¶æ€


PROGRAM="inotifywait"
LOG_FILE="/var/log/monitor_debug.log"

while true; do
#    # å¯åŠ¨ç›‘æ§ç¨‹åº
    $PROGRAM -m -r /path/to/watch &
    PID=$!
    
    echo "[$(date)] å¯åŠ¨ç›‘æ§è¿›ç¨‹ï¼ŒPID: $PID" >> $LOG_FILE
    
#    # ç­‰å¾…è¿›ç¨‹ç»“æŸ
    wait $PID
    EXIT_CODE=$?
    
#    # åˆ†æé€€å‡ºåŸå› 
    case $EXIT_CODE in
        0)   echo "[$(date)] æ­£å¸¸é€€å‡º" >> $LOG_FILE ;;
        1)   echo "[$(date)] ä¸€èˆ¬é”™è¯¯" >> $LOG_FILE ;;
        2)   echo "[$(date)] å‚æ•°é”™è¯¯" >> $LOG_FILE ;;
        127) echo "[$(date)] å‘½ä»¤æœªæ‰¾åˆ°" >> $LOG_FILE ;;
        139) echo "[$(date)] æ®µé”™è¯¯ï¼ˆSIGSEGVï¼‰" >> $LOG_FILE ;;
        143) echo "[$(date)] è¢«SIGTERMä¿¡å·ç»ˆæ­¢" >> $LOG_FILE ;;
        *)   echo "[$(date)] æœªçŸ¥é€€å‡ºç : $EXIT_CODE" >> $LOG_FILE ;;
    esac
    
    sleep 1
done
```

### 2.3 é˜²æ­¢è¿›ç¨‹å¼‚å¸¸é€€å‡ºçš„æ–¹æ³•



**ğŸ›¡ï¸ ä½¿ç”¨systemdç®¡ç†ç›‘æ§æœåŠ¡**
```ini
# /etc/systemd/system/file-monitor.service

[Unit]
Description=File Monitor Service
After=multi-user.target

[Service]
Type=simple
User=monitor
Group=monitor
WorkingDirectory=/opt/monitor
ExecStart=/usr/local/bin/monitor.sh
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

**ğŸ›¡ï¸ åœ¨è„šæœ¬ä¸­æ·»åŠ é”™è¯¯å¤„ç†**
```bash
#!/bin/bash

# robust_monitor.sh - å¥å£®çš„ç›‘æ§è„šæœ¬


set -euo pipefail  # ä¸¥æ ¼é”™è¯¯å¤„ç†

LOG_FILE="/var/log/file_monitor.log"
MAX_RETRIES=5
RETRY_COUNT=0

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

cleanup() {
    log_message "ç›‘æ§ç¨‹åºæ­£åœ¨é€€å‡º..."
    exit 0
}

# æ•è·é€€å‡ºä¿¡å·

trap cleanup SIGTERM SIGINT

while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    log_message "å¯åŠ¨ç›‘æ§ï¼Œé‡è¯•æ¬¡æ•°: $RETRY_COUNT"
    
    if inotifywait -m -r --format '%w%f %e' /path/to/watch 2>>$LOG_FILE; then
        RETRY_COUNT=0  # é‡ç½®é‡è¯•è®¡æ•°
    else
        RETRY_COUNT=$((RETRY_COUNT + 1))
        log_message "ç›‘æ§å¤±è´¥ï¼Œ$RETRY_COUNT/$MAX_RETRIES"
        sleep $((RETRY_COUNT * 5))  # é€’å¢å»¶è¿Ÿ
    fi
done

log_message "é‡è¯•æ¬¡æ•°ç”¨å®Œï¼Œç›‘æ§ç¨‹åºé€€å‡º"
```

---

## 3. ğŸš„ é«˜è´Ÿè½½ä¸‹ç›‘æ§å¤±æ•ˆ



### 3.1 ä»€ä¹ˆæ˜¯é«˜è´Ÿè½½ç›‘æ§å¤±æ•ˆ



**ç®€å•ç†è§£**ï¼šå°±åƒåœ¨éå¸¸å˜ˆæ‚çš„ç¯å¢ƒä¸­ï¼Œä½ å¯èƒ½å¬ä¸æ¸…åˆ«äººè¯´è¯ä¸€æ ·ã€‚å½“ç³»ç»Ÿè´Ÿè½½å¾ˆé«˜æ—¶ï¼Œinotifyå¯èƒ½æ¥ä¸åŠå¤„ç†æ‰€æœ‰çš„æ–‡ä»¶å˜åŒ–äº‹ä»¶ã€‚

```
é«˜è´Ÿè½½æƒ…å†µä¸‹çš„é—®é¢˜ï¼š
å¤§é‡æ–‡ä»¶æ“ä½œ â†’ inotifyé˜Ÿåˆ—å †ç§¯ â†’ å¤„ç†ä¸è¿‡æ¥ â†’ äº‹ä»¶ä¸¢å¤±
```

### 3.2 è¯†åˆ«é«˜è´Ÿè½½ç›‘æ§é—®é¢˜



**ğŸ” ç›‘æ§ç³»ç»Ÿè´Ÿè½½æŒ‡æ ‡**
```bash
#!/bin/bash

# load_monitor.sh - ç›‘æ§ç³»ç»Ÿè´Ÿè½½å’ŒinotifyçŠ¶æ€


check_system_load() {
#    # è·å–ç³»ç»Ÿè´Ÿè½½
    load_avg=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')
    cpu_cores=$(nproc)
    
#    # è®¡ç®—è´Ÿè½½æ¯”ä¾‹
    load_ratio=$(echo "scale=2; $load_avg / $cpu_cores" | bc)
    
    echo "å½“å‰è´Ÿè½½: $load_avg (CPUæ ¸å¿ƒ: $cpu_cores, æ¯”ä¾‹: $load_ratio)"
    
#    # è´Ÿè½½è¿‡é«˜è­¦å‘Š
    if (( $(echo "$load_ratio > 0.8" | bc -l) )); then
        echo "âš ï¸  ç³»ç»Ÿè´Ÿè½½è¾ƒé«˜ï¼Œå¯èƒ½å½±å“inotifyæ€§èƒ½"
    fi
}

check_io_wait() {
#    # æ£€æŸ¥IOç­‰å¾…æ—¶é—´
    io_wait=$(iostat 1 2 | tail -1 | awk '{print $4}')
    echo "IOç­‰å¾…æ—¶é—´: ${io_wait}%"
    
    if (( $(echo "$io_wait > 20" | bc -l) )); then
        echo "âš ï¸  IOç­‰å¾…æ—¶é—´è¿‡é«˜ï¼Œå¯èƒ½å½±å“æ–‡ä»¶ç›‘æ§"
    fi
}

while true; do
    echo "=== $(date) ==="
    check_system_load
    check_io_wait
    echo
    sleep 10
done
```

### 3.3 é«˜è´Ÿè½½ä¸‹çš„ä¼˜åŒ–ç­–ç•¥



**ğŸ”§ ç­–ç•¥ä¸€ï¼šå‡å°‘ç›‘æ§èŒƒå›´**
```bash
# ä¸å¥½çš„åšæ³•ï¼šç›‘æ§æ•´ä¸ªæ ¹ç›®å½•

inotifywait -m -r / 

# å¥½çš„åšæ³•ï¼šåªç›‘æ§å¿…è¦çš„ç›®å½•

inotifywait -m -r /var/log /etc /home/user/important
```

**ğŸ”§ ç­–ç•¥äºŒï¼šè¿‡æ»¤ä¸å¿…è¦çš„äº‹ä»¶**
```bash
# ä¸å¥½çš„åšæ³•ï¼šç›‘æ§æ‰€æœ‰äº‹ä»¶

inotifywait -m -r -e all_events /path/to/watch

# å¥½çš„åšæ³•ï¼šåªç›‘æ§å…³é”®äº‹ä»¶

inotifywait -m -r -e create,delete,modify /path/to/watch \
    --exclude '\.tmp$|\.swp$|~$'  # æ’é™¤ä¸´æ—¶æ–‡ä»¶
```

**ğŸ”§ ç­–ç•¥ä¸‰ï¼šä½¿ç”¨æ‰¹å¤„ç†**
```bash
#!/bin/bash

# batch_monitor.sh - æ‰¹é‡å¤„ç†ç›‘æ§äº‹ä»¶


EVENT_BUFFER=""
BUFFER_SIZE=0
MAX_BUFFER_SIZE=100

process_events() {
    if [ $BUFFER_SIZE -gt 0 ]; then
        echo "æ‰¹é‡å¤„ç† $BUFFER_SIZE ä¸ªäº‹ä»¶"
#        # åœ¨è¿™é‡Œæ‰¹é‡å¤„ç†äº‹ä»¶
        echo "$EVENT_BUFFER" | while read line; do
#            # å¤„ç†å•ä¸ªäº‹ä»¶
            handle_event "$line"
        done
        
        EVENT_BUFFER=""
        BUFFER_SIZE=0
    fi
}

handle_event() {
    local event="$1"
#    # å®é™…çš„äº‹ä»¶å¤„ç†é€»è¾‘
    echo "å¤„ç†äº‹ä»¶: $event"
}

# å®šæ—¶å¤„ç†ç¼“å†²åŒº

{
    while true; do
        sleep 5
        process_events
    done
} &

# ç›‘æ§å¹¶ç¼“å†²äº‹ä»¶

inotifywait -m -r --format '%w%f %e' /path/to/watch | while read event; do
    EVENT_BUFFER="$EVENT_BUFFER$event\n"
    BUFFER_SIZE=$((BUFFER_SIZE + 1))
    
#    # ç¼“å†²åŒºæ»¡æ—¶ç«‹å³å¤„ç†
    if [ $BUFFER_SIZE -ge $MAX_BUFFER_SIZE ]; then
        process_events
    fi
done
```

---

## 4. ğŸ’¾ æ–‡ä»¶ç³»ç»Ÿç±»å‹å…¼å®¹æ€§



### 4.1 inotifyæ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿ



**âœ… å®Œå…¨æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿ**
- **ext2/ext3/ext4**ï¼šLinuxæ ‡å‡†æ–‡ä»¶ç³»ç»Ÿï¼Œæ”¯æŒæœ€å¥½
- **xfs**ï¼šé«˜æ€§èƒ½æ–‡ä»¶ç³»ç»Ÿï¼Œå®Œå…¨æ”¯æŒ
- **btrfs**ï¼šç°ä»£æ–‡ä»¶ç³»ç»Ÿï¼Œæ”¯æŒæ‰€æœ‰inotifyåŠŸèƒ½

**âš ï¸ éƒ¨åˆ†æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿ**
- **NFS**ï¼šç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼Œæœ¬åœ°ä¿®æ”¹å¯ä»¥ç›‘æ§ï¼Œè¿œç¨‹ä¿®æ”¹ä¸è¡Œ
- **CIFS/SMB**ï¼šWindowsç½‘ç»œå…±äº«ï¼Œæ”¯æŒæœ‰é™
- **FUSE**ï¼šç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿï¼Œå–å†³äºå…·ä½“å®ç°

**âŒ ä¸æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿ**
- **FAT32/VFAT**ï¼šè€å¼æ–‡ä»¶ç³»ç»Ÿï¼Œä¸æ”¯æŒinotify
- **ISO9660**ï¼šCD-ROMæ–‡ä»¶ç³»ç»Ÿï¼Œåªè¯»ä¸”ä¸æ”¯æŒ

### 4.2 æ£€æµ‹æ–‡ä»¶ç³»ç»Ÿç±»å‹



```bash
#!/bin/bash

# check_filesystem.sh - æ£€æµ‹æ–‡ä»¶ç³»ç»Ÿç±»å‹å’Œinotifyå…¼å®¹æ€§


check_filesystem_support() {
    local path="$1"
    
#    # è·å–æ–‡ä»¶ç³»ç»Ÿç±»å‹
    fs_type=$(df -T "$path" | tail -1 | awk '{print $2}')
    echo "è·¯å¾„ $path çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹: $fs_type"
    
    case "$fs_type" in
        ext2|ext3|ext4|xfs|btrfs)
            echo "âœ… å®Œå…¨æ”¯æŒinotify"
            return 0
            ;;
        nfs|nfs4)
            echo "âš ï¸  NFSæ–‡ä»¶ç³»ç»Ÿï¼Œåªèƒ½ç›‘æ§æœ¬åœ°ä¿®æ”¹"
            return 1
            ;;
        cifs|smb)
            echo "âš ï¸  CIFS/SMBæ–‡ä»¶ç³»ç»Ÿï¼Œæ”¯æŒæœ‰é™"
            return 1
            ;;
        vfat|fat|fat32)
            echo "âŒ FATæ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒinotify"
            return 2
            ;;
        *)
            echo "âš ï¸  æœªçŸ¥æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œå»ºè®®æµ‹è¯•"
            return 1
            ;;
    esac
}

# æµ‹è¯•å‡½æ•°

test_inotify_support() {
    local path="$1"
    local test_file="$path/.inotify_test_$$"
    
    echo "æµ‹è¯• $path çš„inotifyæ”¯æŒ..."
    
#    # å¯åŠ¨ç›‘æ§ï¼ˆåå°ï¼‰
    timeout 5 inotifywait -m "$path" &
    monitor_pid=$!
    
    sleep 1
    
#    # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
    echo "test" > "$test_file"
    sleep 1
    rm -f "$test_file"
    
#    # ç»“æŸç›‘æ§
    kill $monitor_pid 2>/dev/null
    wait $monitor_pid 2>/dev/null
    
    echo "æµ‹è¯•å®Œæˆ"
}

# ä½¿ç”¨ç¤ºä¾‹

for path in "/tmp" "/home" "/mnt/nfs_share"; do
    echo "===================="
    if [ -d "$path" ]; then
        check_filesystem_support "$path"
        test_inotify_support "$path"
    else
        echo "è·¯å¾„ $path ä¸å­˜åœ¨ï¼Œè·³è¿‡æ£€æµ‹"
    fi
done
```

### 4.3 é’ˆå¯¹ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„ç›‘æ§ç­–ç•¥



**ğŸ“‹ NFSæ–‡ä»¶ç³»ç»Ÿç›‘æ§æ–¹æ¡ˆ**
```bash
#!/bin/bash

# nfs_monitor.sh - NFSæ–‡ä»¶ç³»ç»Ÿç›‘æ§æ–¹æ¡ˆ


NFS_PATH="/mnt/nfs_share"

# æ–¹æ¡ˆ1ï¼šç»“åˆè¿œç¨‹ç›‘æ§

monitor_nfs_hybrid() {
    echo "å¯åŠ¨NFSæ··åˆç›‘æ§æ¨¡å¼"
    
#    # æœ¬åœ°inotifyç›‘æ§ï¼ˆç›‘æ§æœ¬æœºå¯¹NFSçš„ä¿®æ”¹ï¼‰
    {
        inotifywait -m -r "$NFS_PATH" --format 'LOCAL: %w%f %e' 
    } &
    local_pid=$!
    
#    # å®šæ—¶è½®è¯¢æ£€æŸ¥ï¼ˆæ£€æµ‹è¿œç¨‹ä¿®æ”¹ï¼‰
    {
        while true; do
            find "$NFS_PATH" -newer /tmp/nfs_check_timestamp 2>/dev/null | \
            while read file; do
                echo "REMOTE: $file MODIFY"
            done
            touch /tmp/nfs_check_timestamp
            sleep 10
        done
    } &
    poll_pid=$!
    
    echo "æœ¬åœ°ç›‘æ§PID: $local_pid, è½®è¯¢ç›‘æ§PID: $poll_pid"
    wait
}

# æ–¹æ¡ˆ2ï¼šçº¯è½®è¯¢æ¨¡å¼ï¼ˆé€‚ç”¨äºå®Œå…¨ä¸æ”¯æŒinotifyçš„æ–‡ä»¶ç³»ç»Ÿï¼‰

monitor_polling_only() {
    echo "å¯åŠ¨çº¯è½®è¯¢ç›‘æ§æ¨¡å¼"
    
    SNAPSHOT_FILE="/tmp/fs_snapshot"
    
#    # åˆ›å»ºåˆå§‹å¿«ç…§
    find "$NFS_PATH" -type f -exec stat -c "%n %Y %s" {} \; > "$SNAPSHOT_FILE"
    
    while true; do
#        # åˆ›å»ºæ–°å¿«ç…§
        find "$NFS_PATH" -type f -exec stat -c "%n %Y %s" {} \; > "${SNAPSHOT_FILE}.new"
        
#        # å¯¹æ¯”å˜åŒ–
        comm -13 <(sort "$SNAPSHOT_FILE") <(sort "${SNAPSHOT_FILE}.new") | \
        while read line; do
            echo "CHANGED: $line"
        done
        
        mv "${SNAPSHOT_FILE}.new" "$SNAPSHOT_FILE"
        sleep 5
    done
}

# æ ¹æ®æ–‡ä»¶ç³»ç»Ÿç±»å‹é€‰æ‹©ç›‘æ§æ–¹å¼

fs_type=$(df -T "$NFS_PATH" | tail -1 | awk '{print $2}')
case "$fs_type" in
    nfs*)
        monitor_nfs_hybrid
        ;;
    vfat|fat*)
        monitor_polling_only
        ;;
    *)
        echo "ä½¿ç”¨æ ‡å‡†inotifyç›‘æ§"
        inotifywait -m -r "$NFS_PATH"
        ;;
esac
```

---

## 5. ğŸ”§ ç›‘æ§è„šæœ¬è°ƒè¯•æŠ€å·§



### 5.1 è°ƒè¯•æ¨¡å¼çš„å¼€å¯



**ğŸ” åŸºç¡€è°ƒè¯•ä¿¡æ¯**
```bash
#!/bin/bash

# debug_monitor.sh - å¸¦è°ƒè¯•åŠŸèƒ½çš„ç›‘æ§è„šæœ¬


# è°ƒè¯•å¼€å…³

DEBUG=true
VERBOSE=true

debug_log() {
    if [ "$DEBUG" = true ]; then
        echo "[DEBUG $(date '+%H:%M:%S')] $1" >&2
    fi
}

verbose_log() {
    if [ "$VERBOSE" = true ]; then
        echo "[INFO $(date '+%H:%M:%S')] $1"
    fi
}

# æµ‹è¯•inotifyåŠŸèƒ½

test_inotify() {
    local test_dir="/tmp/inotify_test_$$"
    mkdir -p "$test_dir"
    
    debug_log "åˆ›å»ºæµ‹è¯•ç›®å½•: $test_dir"
    
#    # å¯åŠ¨ç›‘æ§ï¼ˆè¶…æ—¶5ç§’ï¼‰
    timeout 5 inotifywait -m "$test_dir" --format '%w%f %e' &
    local monitor_pid=$!
    
    sleep 1
    
#    # æ‰§è¡Œæµ‹è¯•æ“ä½œ
    debug_log "æ‰§è¡Œæµ‹è¯•æ“ä½œ"
    echo "test content" > "$test_dir/testfile"
    echo "modified content" >> "$test_dir/testfile"
    rm "$test_dir/testfile"
    
    wait $monitor_pid 2>/dev/null
    local exit_code=$?
    
    rm -rf "$test_dir"
    
    if [ $exit_code -eq 0 ] || [ $exit_code -eq 124 ]; then  # 124æ˜¯timeoutçš„é€€å‡ºç 
        verbose_log "âœ… inotifyæµ‹è¯•é€šè¿‡"
        return 0
    else
        verbose_log "âŒ inotifyæµ‹è¯•å¤±è´¥ï¼Œé€€å‡ºç : $exit_code"
        return 1
    fi
}

# ä¸»ç›‘æ§å¾ªç¯

main_monitor() {
    local watch_path="$1"
    
    verbose_log "å¼€å§‹ç›‘æ§è·¯å¾„: $watch_path"
    
    inotifywait -m -r "$watch_path" \
        --format '%T %w%f %e' \
        --timefmt '%Y-%m-%d %H:%M:%S' \
        -e create,delete,modify,move | \
    while read timestamp filepath event; do
        debug_log "åŸå§‹äº‹ä»¶: $timestamp $filepath $event"
        
#        # è¿‡æ»¤ä¸´æ—¶æ–‡ä»¶
        if [[ "$filepath" =~ \.(tmp|swp)$ ]] || [[ "$filepath" =~ ~$ ]]; then
            debug_log "è·³è¿‡ä¸´æ—¶æ–‡ä»¶: $filepath"
            continue
        fi
        
        verbose_log "å¤„ç†æ–‡ä»¶äº‹ä»¶: $filepath -> $event"
        
#        # åœ¨è¿™é‡Œæ·»åŠ å®é™…çš„å¤„ç†é€»è¾‘
        handle_file_event "$filepath" "$event"
    done
}

handle_file_event() {
    local file="$1"
    local event="$2"
    
    debug_log "å¤„ç†äº‹ä»¶å‡½æ•°è¢«è°ƒç”¨: file=$file, event=$event"
    
    case "$event" in
        CREATE)
            verbose_log "ğŸ“ æ–°å»ºæ–‡ä»¶: $file"
            ;;
        DELETE)
            verbose_log "ğŸ—‘ï¸  åˆ é™¤æ–‡ä»¶: $file"
            ;;
        MODIFY)
            verbose_log "âœï¸  ä¿®æ”¹æ–‡ä»¶: $file"
            ;;
        MOVED_FROM|MOVED_TO)
            verbose_log "ğŸ“ ç§»åŠ¨æ–‡ä»¶: $file"
            ;;
        *)
            debug_log "æœªå¤„ç†çš„äº‹ä»¶ç±»å‹: $event"
            ;;
    esac
}

# å¯åŠ¨è„šæœ¬

if [ $# -eq 0 ]; then
    echo "ç”¨æ³•: $0 <ç›‘æ§è·¯å¾„>"
    exit 1
fi

# æ‰§è¡Œé¢„æ£€æŸ¥

if test_inotify; then
    main_monitor "$1"
else
    echo "âŒ inotifyåŠŸèƒ½å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿé…ç½®"
    exit 1
fi
```

### 5.2 æ—¥å¿—è®°å½•å’Œåˆ†æ



**ğŸ“ ç»“æ„åŒ–æ—¥å¿—è®°å½•**
```bash
#!/bin/bash

# structured_logging.sh - ç»“æ„åŒ–æ—¥å¿—è®°å½•


LOG_DIR="/var/log/file-monitor"
LOG_FILE="$LOG_DIR/monitor.log"
ERROR_LOG="$LOG_DIR/error.log"
DEBUG_LOG="$LOG_DIR/debug.log"

# ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨

mkdir -p "$LOG_DIR"

# æ—¥å¿—è®°å½•å‡½æ•°

log_info() {
    local message="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [INFO] $message" | tee -a "$LOG_FILE"
}

log_error() {
    local message="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [ERROR] $message" | tee -a "$ERROR_LOG" >&2
}

log_debug() {
    local message="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    if [ "${DEBUG:-false}" = "true" ]; then
        echo "[$timestamp] [DEBUG] $message" >> "$DEBUG_LOG"
    fi
}

# æ€§èƒ½ç›‘æ§

performance_monitor() {
    local start_time=$(date +%s.%N)
    
    "$@"  # æ‰§è¡Œä¼ å…¥çš„å‘½ä»¤
    
    local end_time=$(date +%s.%N)
    local duration=$(echo "$end_time - $start_time" | bc)
    
    log_debug "å‘½ä»¤ '$*' æ‰§è¡Œæ—¶é—´: ${duration}ç§’"
}

# ä½¿ç”¨ç¤ºä¾‹

DEBUG=true

log_info "ç›‘æ§ç¨‹åºå¯åŠ¨"
log_debug "è°ƒè¯•ä¿¡æ¯ï¼šä½¿ç”¨è°ƒè¯•æ¨¡å¼"

performance_monitor inotifywait -m /tmp --timeout 5

log_info "ç›‘æ§ç¨‹åºç»“æŸ"
```

### 5.3 å¸¸è§é—®é¢˜çš„è°ƒè¯•æ–¹æ³•



**ğŸ” æƒé™é—®é¢˜è°ƒè¯•**
```bash
#!/bin/bash

# permission_debug.sh - æƒé™é—®é¢˜è°ƒè¯•å·¥å…·


check_permissions() {
    local path="$1"
    
    echo "æ£€æŸ¥è·¯å¾„æƒé™: $path"
    
#    # æ£€æŸ¥è·¯å¾„æ˜¯å¦å­˜åœ¨
    if [ ! -e "$path" ]; then
        echo "âŒ è·¯å¾„ä¸å­˜åœ¨: $path"
        return 1
    fi
    
#    # æ£€æŸ¥è¯»æƒé™
    if [ -r "$path" ]; then
        echo "âœ… è¯»æƒé™: OK"
    else
        echo "âŒ è¯»æƒé™: æ— æ³•è¯»å–"
        echo "   å½“å‰ç”¨æˆ·: $(whoami)"
        echo "   æ–‡ä»¶æ‰€æœ‰è€…: $(stat -c '%U' "$path")"
        echo "   æ–‡ä»¶æƒé™: $(stat -c '%A' "$path")"
    fi
    
#    # æ£€æŸ¥ç›‘æ§æƒé™ï¼ˆå°è¯•åˆ›å»ºinotifyç›‘æ§ï¼‰
    if timeout 2 inotifywait -e create "$path" --timeout 1 >/dev/null 2>&1; then
        echo "âœ… ç›‘æ§æƒé™: OK"
    else
        echo "âŒ ç›‘æ§æƒé™: æ— æ³•å»ºç«‹ç›‘æ§"
        echo "   å»ºè®®æ£€æŸ¥:"
        echo "   1. SELinuxè®¾ç½®: sestatus"
        echo "   2. AppArmoré™åˆ¶: aa-status"
        echo "   3. æ–‡ä»¶ç³»ç»ŸæŒ‚è½½é€‰é¡¹: mount | grep $(df --output=source \"$path\" | tail -1)"
    fi
}

# é€’å½’æ£€æŸ¥ç›®å½•æƒé™

check_directory_tree() {
    local dir="$1"
    local max_depth="${2:-3}"
    
    echo "é€’å½’æ£€æŸ¥ç›®å½•æ ‘æƒé™ (æœ€å¤§æ·±åº¦: $max_depth)"
    
    find "$dir" -maxdepth "$max_depth" -type d | while read subdir; do
        echo "--- æ£€æŸ¥ç›®å½•: $subdir ---"
        check_permissions "$subdir"
        echo
    done
}

# ä½¿ç”¨ç¤ºä¾‹

if [ $# -eq 0 ]; then
    echo "ç”¨æ³•: $0 <è·¯å¾„> [æ£€æŸ¥æ·±åº¦]"
    echo "ç¤ºä¾‹: $0 /var/log 2"
    exit 1
fi

check_directory_tree "$1" "${2:-3}"
```

---

## 6. ğŸš« å†…æ ¸é™åˆ¶é—®é¢˜è§£å†³



### 6.1 ç†è§£å†…æ ¸é™åˆ¶å‚æ•°



**ğŸ“Š inotifyå†…æ ¸å‚æ•°è¯´æ˜**

| å‚æ•° | é»˜è®¤å€¼ | ä½œç”¨ | å½±å“ |
|------|--------|------|------|
| `max_user_instances` | 128 | æ¯ä¸ªç”¨æˆ·æœ€å¤§inotifyå®ä¾‹æ•° | é™åˆ¶åŒæ—¶è¿è¡Œçš„ç›‘æ§ç¨‹åºæ•°é‡ |
| `max_user_watches` | 8192 | æ¯ä¸ªç”¨æˆ·æœ€å¤§ç›‘æ§æ•° | é™åˆ¶å¯ä»¥ç›‘æ§çš„æ–‡ä»¶/ç›®å½•æ€»æ•° |
| `max_queued_events` | 16384 | äº‹ä»¶é˜Ÿåˆ—æœ€å¤§é•¿åº¦ | é™åˆ¶æœªå¤„ç†äº‹ä»¶çš„æ•°é‡ |

### 6.2 æ£€æŸ¥å½“å‰é™åˆ¶ä½¿ç”¨æƒ…å†µ



```bash
#!/bin/bash

# check_limits.sh - æ£€æŸ¥inotifyé™åˆ¶ä½¿ç”¨æƒ…å†µ


check_inotify_limits() {
    echo "=== inotifyå†…æ ¸é™åˆ¶æ£€æŸ¥ ==="
    
#    # è·å–é™åˆ¶å€¼
    max_instances=$(cat /proc/sys/fs/inotify/max_user_instances)
    max_watches=$(cat /proc/sys/fs/inotify/max_user_watches)
    max_queued=$(cat /proc/sys/fs/inotify/max_queued_events)
    
    echo "ğŸ“‹ å½“å‰é™åˆ¶å€¼:"
    echo "  æœ€å¤§å®ä¾‹æ•°: $max_instances"
    echo "  æœ€å¤§ç›‘æ§æ•°: $max_watches"  
    echo "  æœ€å¤§é˜Ÿåˆ—æ•°: $max_queued"
    
#    # ç»Ÿè®¡å½“å‰ä½¿ç”¨é‡
    echo "ğŸ“Š å½“å‰ä½¿ç”¨æƒ…å†µ:"
    
#    # ç»Ÿè®¡inotifyå®ä¾‹æ•°
    instance_count=0
    watch_count=0
    
    for proc_dir in /proc/[0-9]*; do
        if [ -d "$proc_dir/fd" ]; then
            proc_instances=$(ls -la "$proc_dir/fd/" 2>/dev/null | grep -c "inotify" || echo 0)
            if [ "$proc_instances" -gt 0 ]; then
                instance_count=$((instance_count + proc_instances))
                
#                # è·å–è¿›ç¨‹ä¿¡æ¯
                pid=$(basename "$proc_dir")
                proc_name=$(ps -p "$pid" -o comm= 2>/dev/null || echo "unknown")
                echo "  è¿›ç¨‹ $pid ($proc_name): $proc_instances ä¸ªå®ä¾‹"
            fi
        fi
    done
    
    echo "  æ€»å®ä¾‹æ•°: $instance_count / $max_instances"
    
#    # è®¡ç®—ä½¿ç”¨ç‡
    if [ "$max_instances" -gt 0 ]; then
        instance_usage=$((instance_count * 100 / max_instances))
        echo "  å®ä¾‹ä½¿ç”¨ç‡: ${instance_usage}%"
        
        if [ "$instance_usage" -gt 80 ]; then
            echo "âš ï¸  å®ä¾‹ä½¿ç”¨ç‡è¿‡é«˜ï¼"
        fi
    fi
}

# æ¨èçš„é™åˆ¶å€¼è°ƒæ•´

suggest_limits() {
    echo "=== æ¨èé…ç½® ==="
    
#    # æ ¹æ®ç³»ç»Ÿå†…å­˜æ¨èé…ç½®
    total_mem_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    total_mem_gb=$((total_mem_kb / 1024 / 1024))
    
    echo "ç³»ç»Ÿå†…å­˜: ${total_mem_gb}GB"
    
    if [ "$total_mem_gb" -ge 8 ]; then
        echo "æ¨èé…ç½® (>=8GBå†…å­˜):"
        echo "  max_user_instances = 1024"
        echo "  max_user_watches = 524288"  # 512K
        echo "  max_queued_events = 65536"
    elif [ "$total_mem_gb" -ge 4 ]; then
        echo "æ¨èé…ç½® (4-8GBå†…å­˜):"
        echo "  max_user_instances = 512"
        echo "  max_user_watches = 262144"  # 256K
        echo "  max_queued_events = 32768"
    else
        echo "æ¨èé…ç½® (<4GBå†…å­˜):"
        echo "  max_user_instances = 256"
        echo "  max_user_watches = 65536"   # 64K
        echo "  max_queued_events = 16384"
    fi
}

check_inotify_limits
echo
suggest_limits
```

### 6.3 åŠ¨æ€è°ƒæ•´å†…æ ¸å‚æ•°



```bash
#!/bin/bash

# adjust_limits.sh - åŠ¨æ€è°ƒæ•´inotifyé™åˆ¶


# ä¿å­˜åŸå§‹é…ç½®

backup_current_config() {
    local backup_file="/tmp/inotify_limits_backup_$(date +%Y%m%d_%H%M%S)"
    
    echo "å¤‡ä»½å½“å‰é…ç½®åˆ°: $backup_file"
    cat > "$backup_file" << EOF
# inotifyåŸå§‹é…ç½®å¤‡ä»½

max_user_instances=$(cat /proc/sys/fs/inotify/max_user_instances)
max_user_watches=$(cat /proc/sys/fs/inotify/max_user_watches)
max_queued_events=$(cat /proc/sys/fs/inotify/max_queued_events)
EOF
    
    echo "âœ… é…ç½®å·²å¤‡ä»½"
}

# åº”ç”¨æ–°é…ç½®

apply_config() {
    local instances="$1"
    local watches="$2" 
    local queued="$3"
    
    echo "åº”ç”¨æ–°é…ç½®..."
    echo "  å®ä¾‹æ•°é™åˆ¶: $instances"
    echo "  ç›‘æ§æ•°é™åˆ¶: $watches"
    echo "  é˜Ÿåˆ—æ•°é™åˆ¶: $queued"
    
#    # ä¸´æ—¶ç”Ÿæ•ˆ
    echo "$instances" > /proc/sys/fs/inotify/max_user_instances
    echo "$watches" > /proc/sys/fs/inotify/max_user_watches
    echo "$queued" > /proc/sys/fs/inotify/max_queued_events
    
    echo "âœ… ä¸´æ—¶é…ç½®å·²ç”Ÿæ•ˆ"
    
#    # æ°¸ä¹…ç”Ÿæ•ˆï¼ˆå¯é€‰ï¼‰
    read -p "æ˜¯å¦æ°¸ä¹…ä¿å­˜åˆ° /etc/sysctl.conf? (y/N): " -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        cat >> /etc/sysctl.conf << EOF

# inotifyé…ç½® - $(date)

fs.inotify.max_user_instances = $instances
fs.inotify.max_user_watches = $watches  
fs.inotify.max_queued_events = $queued
EOF
        sysctl -p
        echo "âœ… æ°¸ä¹…é…ç½®å·²ä¿å­˜"
    fi
}

# æ™ºèƒ½é…ç½®æ¨è

smart_config() {
    echo "=== æ™ºèƒ½é…ç½®æ¨è ==="
    
#    # æ£€æŸ¥å½“å‰ç³»ç»Ÿæƒ…å†µ
    total_mem_gb=$(free -g | awk '/^Mem:/{print $2}')
    cpu_cores=$(nproc)
    
    echo "ç³»ç»Ÿé…ç½®: ${total_mem_gb}GBå†…å­˜, ${cpu_cores}æ ¸CPU"
    
#    # æ ¹æ®ç³»ç»Ÿé…ç½®æ¨èå‚æ•°
    if [ "$total_mem_gb" -ge 16 ]; then
        instances=2048
        watches=1048576  # 1M
        queued=131072
        config_type="é«˜æ€§èƒ½æœåŠ¡å™¨"
    elif [ "$total_mem_gb" -ge 8 ]; then
        instances=1024
        watches=524288   # 512K
        queued=65536
        config_type="æ ‡å‡†æœåŠ¡å™¨"
    elif [ "$total_mem_gb" -ge 4 ]; then
        instances=512
        watches=262144   # 256K
        queued=32768
        config_type="å°å‹æœåŠ¡å™¨"
    else
        instances=256
        watches=131072   # 128K
        queued=16384
        config_type="èµ„æºå—é™ç¯å¢ƒ"
    fi
    
    echo "æ¨èé…ç½®ç±»å‹: $config_type"
    echo "  max_user_instances = $instances"
    echo "  max_user_watches = $watches"
    echo "  max_queued_events = $queued"
    
    read -p "æ˜¯å¦åº”ç”¨è¿™ä¸ªé…ç½®? (y/N): " -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        backup_current_config
        apply_config "$instances" "$watches" "$queued"
    fi
}

# æ£€æŸ¥æ˜¯å¦éœ€è¦rootæƒé™

if [ "$EUID" -ne 0 ]; then
    echo "âŒ éœ€è¦rootæƒé™æ¥ä¿®æ”¹å†…æ ¸å‚æ•°"
    echo "è¯·ä½¿ç”¨: sudo $0"
    exit 1
fi

smart_config
```

---

## 7. ğŸ” æƒé™é—®é¢˜è¯Šæ–­æ–¹æ³•



### 7.1 æƒé™é—®é¢˜çš„å¸¸è§è¡¨ç°



**å…¸å‹é”™è¯¯ä¿¡æ¯**ï¼š
```bash
# å¸¸è§çš„æƒé™ç›¸å…³é”™è¯¯

inotifywait: cannot add watch '/some/path': Permission denied
inotifywait: cannot add watch '/some/path': Operation not permitted  
inotifywait: cannot add watch '/some/path': No such file or directory
```

### 7.2 ç³»ç»Ÿæ€§æƒé™æ£€æŸ¥



```bash
#!/bin/bash

# comprehensive_permission_check.sh - å…¨é¢æƒé™æ£€æŸ¥å·¥å…·


# é¢œè‰²å®šä¹‰ï¼ˆç”¨äºç¾åŒ–è¾“å‡ºï¼‰

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_success() { echo -e "${GREEN}âœ… $1${NC}"; }
log_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
log_error() { echo -e "${RED}âŒ $1${NC}"; }

check_basic_permissions() {
    local path="$1"
    
    echo "ğŸ” åŸºç¡€æƒé™æ£€æŸ¥: $path"
    
#    # æ£€æŸ¥è·¯å¾„å­˜åœ¨æ€§
    if [ ! -e "$path" ]; then
        log_error "è·¯å¾„ä¸å­˜åœ¨"
        return 1
    fi
    
#    # æ£€æŸ¥è¯»æƒé™
    if [ -r "$path" ]; then
        log_success "è¯»æƒé™æ­£å¸¸"
    else
        log_error "ç¼ºå°‘è¯»æƒé™"
        echo "   æ–‡ä»¶æ‰€æœ‰è€…: $(stat -c '%U:%G' "$path")"
        echo "   å½“å‰ç”¨æˆ·: $(whoami)"
        echo "   æ–‡ä»¶æƒé™: $(stat -c '%A' "$path")"
    fi
    
#    # æ£€æŸ¥ç›®å½•çš„æ‰§è¡Œæƒé™ï¼ˆå¯¹äºç›®å½•éå†å¾ˆé‡è¦ï¼‰
    if [ -d "$path" ] && [ -x "$path" ]; then
        log_success "ç›®å½•æ‰§è¡Œæƒé™æ­£å¸¸"
    elif [ -d "$path" ]; then
        log_error "ç¼ºå°‘ç›®å½•æ‰§è¡Œæƒé™"
    fi
}

check_selinux() {
    local path="$1"
    
    echo "ğŸ›¡ï¸  SELinuxæ£€æŸ¥"
    
#    # æ£€æŸ¥SELinuxæ˜¯å¦å¯ç”¨
    if command -v getenforce >/dev/null 2>&1; then
        selinux_status=$(getenforce)
        echo "   SELinuxçŠ¶æ€: $selinux_status"
        
        if [ "$selinux_status" = "Enforcing" ] || [ "$selinux_status" = "Permissive" ]; then
#            # æ£€æŸ¥æ–‡ä»¶çš„SELinuxæ ‡ç­¾
            selinux_context=$(ls -Z "$path" 2>/dev/null | awk '{print $1}')
            echo "   SELinuxä¸Šä¸‹æ–‡: $selinux_context"
            
#            # æ£€æŸ¥æ˜¯å¦æœ‰æ‹’ç»è®°å½•
            recent_denials=$(ausearch -m avc -ts recent 2>/dev/null | grep -c "inotify\|watch" || echo 0)
            if [ "$recent_denials" -gt 0 ]; then
                log_warning "å‘ç° $recent_denials æ¡SELinuxæ‹’ç»è®°å½•"
                echo "   è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è¯¦æƒ…: ausearch -m avc -ts recent | grep inotify"
            else
                log_success "SELinuxæ£€æŸ¥æ­£å¸¸"
            fi
        fi
    else
        echo "   SELinuxæœªå®‰è£…"
    fi
}

check_apparmor() {
    local path="$1"
    
    echo "ğŸ›¡ï¸  AppArmoræ£€æŸ¥"
    
    if command -v aa-status >/dev/null 2>&1; then
#        # æ£€æŸ¥AppArmorçŠ¶æ€
        if aa-status >/dev/null 2>&1; then
#            # æŸ¥çœ‹æ˜¯å¦æœ‰ç›¸å…³çš„é…ç½®æ–‡ä»¶é™åˆ¶
            profiles=$(aa-status --profiled 2>/dev/null | grep -c "inotify\|watch" || echo 0)
            if [ "$profiles" -gt 0 ]; then
                log_warning "å‘ç°AppArmoré…ç½®å¯èƒ½å½±å“inotify"
            else
                log_success "AppArmoræ£€æŸ¥æ­£å¸¸"
            fi
        else
            echo "   AppArmoræœªè¿è¡Œ"
        fi
    else
        echo "   AppArmoræœªå®‰è£…"
    fi
}

check_mount_options() {
    local path="$1"
    
    echo "ğŸ’¾ æŒ‚è½½é€‰é¡¹æ£€æŸ¥"
    
#    # è·å–æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹
    mountpoint=$(df --output=target "$path" | tail -1)
    mount_info=$(mount | grep "$mountpoint")
    
    echo "   æŒ‚è½½ç‚¹: $mountpoint"
    echo "   æŒ‚è½½ä¿¡æ¯: $mount_info"
    
#    # æ£€æŸ¥å¯èƒ½å½±å“inotifyçš„æŒ‚è½½é€‰é¡¹
    if echo "$mount_info" | grep -q "noatime"; then
        log_warning "ä½¿ç”¨äº†noatimeé€‰é¡¹ï¼Œå¯èƒ½å½±å“æŸäº›äº‹ä»¶æ£€æµ‹"
    fi
    
    if echo "$mount_info" | grep -q "ro,"; then
        log_error "æ–‡ä»¶ç³»ç»Ÿä»¥åªè¯»æ–¹å¼æŒ‚è½½"
    else
        log_success "æ–‡ä»¶ç³»ç»Ÿå¯å†™"
    fi
}

check_process_limits() {
    echo "ğŸ”¢ è¿›ç¨‹é™åˆ¶æ£€æŸ¥"
    
#    # æ£€æŸ¥å½“å‰ç”¨æˆ·çš„èµ„æºé™åˆ¶
    echo "   æ–‡ä»¶æè¿°ç¬¦é™åˆ¶:"
    ulimit -n
    
#    # æ£€æŸ¥inotifyç‰¹å®šé™åˆ¶
    echo "   inotifyé™åˆ¶:"
    echo "     å®ä¾‹æ•°é™åˆ¶: $(cat /proc/sys/fs/inotify/max_user_instances)"
    echo "     ç›‘æ§æ•°é™åˆ¶: $(cat /proc/sys/fs/inotify/max_user_watches)"
    echo "     é˜Ÿåˆ—æ•°é™åˆ¶: $(cat /proc/sys/fs/inotify/max_queued_events)"
    
#    # æ£€æŸ¥å½“å‰ä½¿ç”¨é‡
    current_watches=$(find /proc/*/fd -type l 2>/dev/null | xargs readlink 2>/dev/null | grep -c inotify || echo 0)
    max_watches=$(cat /proc/sys/fs/inotify/max_user_watches)
    
    usage_percent=$((current_watches * 100 / max_watches))
    echo "   å½“å‰ç›‘æ§ä½¿ç”¨é‡: $current_watches / $max_watches (${usage_percent}%)"
    
    if [ "$usage_percent" -gt 80 ]; then
        log_warning "inotifyç›‘æ§ä½¿ç”¨é‡è¿‡é«˜"
    else
        log_success "inotifyä½¿ç”¨é‡æ­£å¸¸"
    fi
}

# ç»¼åˆè¯Šæ–­å‡½æ•°

comprehensive_diagnosis() {
    local path="$1"
    
    echo "=== å¼€å§‹å…¨é¢æƒé™è¯Šæ–­ ==="
    echo "ç›®æ ‡è·¯å¾„: $path"
    echo "å½“å‰ç”¨æˆ·: $(whoami)"
    echo "å½“å‰æ—¶é—´: $(date)"
    echo
    
    check_basic_permissions "$path"
    echo
    check_selinux "$path"  
    echo
    check_apparmor "$path"
    echo
    check_mount_options "$path"
    echo
    check_process_limits
    echo
    
#    # å®é™…æµ‹è¯•inotifyåŠŸèƒ½
    echo "ğŸ§ª å®é™…åŠŸèƒ½æµ‹è¯•"
    test_dir="/tmp/inotify_permission_test_$$"
    mkdir -p "$test_dir"
    
    if timeout 3 inotifywait -e create "$test_dir" --timeout 1 >/dev/null 2>&1; then
        log_success "inotifyåŠŸèƒ½æµ‹è¯•é€šè¿‡"
    else
        log_error "inotifyåŠŸèƒ½æµ‹è¯•å¤±è´¥"
        echo "   å»ºè®®:"
        echo "   1. æ£€æŸ¥å†…æ ¸æ¨¡å—: lsmod | grep inotify"
        echo "   2. æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨æƒé™"
        echo "   3. æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—: dmesg | tail -20"
    fi
    
    rm -rf "$test_dir"
    echo
    echo "=== è¯Šæ–­å®Œæˆ ==="
}

# ä¸»ç¨‹åº

if [ $# -eq 0 ]; then
    echo "ç”¨æ³•: $0 <è¦æ£€æŸ¥çš„è·¯å¾„>"
    echo "ç¤ºä¾‹: $0 /var/log"
    exit 1
fi

comprehensive_diagnosis "$1"
```

### 7.3 æƒé™é—®é¢˜è§£å†³æ–¹æ¡ˆ



```bash
#!/bin/bash  

# fix_permissions.sh - æƒé™é—®é¢˜ä¿®å¤å·¥å…·


fix_basic_permissions() {
    local path="$1"
    local fix_mode="$2"  # user|group|all
    
    echo "ğŸ”§ ä¿®å¤åŸºç¡€æƒé™é—®é¢˜"
    
    case "$fix_mode" in
        "user")
            echo "ä¸ºå½“å‰ç”¨æˆ·æ·»åŠ è¯»æƒé™..."
            sudo chmod u+r "$path"
            if [ -d "$path" ]; then
                sudo chmod u+x "$path"  # ç›®å½•éœ€è¦æ‰§è¡Œæƒé™
            fi
            ;;
        "group")
            echo "ä¸ºå½“å‰ç”¨æˆ·ç»„æ·»åŠ è¯»æƒé™..."
            sudo chmod g+r "$path"
            if [ -d "$path" ]; then
                sudo chmod g+x "$path"
            fi
            ;;
        "all")
            echo "ä¸ºæ‰€æœ‰ç”¨æˆ·æ·»åŠ è¯»æƒé™..."
            sudo chmod a+r "$path"
            if [ -d "$path" ]; then
                sudo chmod a+x "$path"
            fi
            ;;
        *)
            echo "æœªçŸ¥ä¿®å¤æ¨¡å¼: $fix_mode"
            return 1
            ;;
    esac
    
    log_success "æƒé™ä¿®å¤å®Œæˆ"
}

create_monitor_user() {
    local username="filemonitor"
    
    echo "ğŸ“ åˆ›å»ºä¸“ç”¨ç›‘æ§ç”¨æˆ·"
    
#    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
    if id "$username" >/dev/null 2>&1; then
        echo "ç”¨æˆ· $username å·²å­˜åœ¨"
        return 0
    fi
    
#    # åˆ›å»ºç³»ç»Ÿç”¨æˆ·
    sudo useradd -r -s /bin/false -d /var/lib/filemonitor "$username"
    
#    # åˆ›å»ºå·¥ä½œç›®å½•
    sudo mkdir -p /var/lib/filemonitor
    sudo chown "$username:$username" /var/lib/filemonitor
    
    log_success "ç›‘æ§ç”¨æˆ·åˆ›å»ºå®Œæˆ"
    echo "   ç”¨æˆ·å: $username"
    echo "   å·¥ä½œç›®å½•: /var/lib/filemonitor"
    echo "   å»ºè®®å°†ç›‘æ§è„šæœ¬ä»¥æ­¤ç”¨æˆ·èº«ä»½è¿è¡Œ"
}

# ä¸»ä¿®å¤èœå•

show_fix_menu() {
    local path="$1"
    
    echo "=== æƒé™é—®é¢˜ä¿®å¤èœå• ==="
    echo "ç›®æ ‡è·¯å¾„: $path"
    echo
    echo "1) ä¸ºå½“å‰ç”¨æˆ·ä¿®å¤æƒé™"
    echo "2) ä¸ºç”¨æˆ·ç»„ä¿®å¤æƒé™"  
    echo "3) ä¸ºæ‰€æœ‰ç”¨æˆ·ä¿®å¤æƒé™"
    echo "4) åˆ›å»ºä¸“ç”¨ç›‘æ§ç”¨æˆ·"
    echo "5) æŸ¥çœ‹ä¿®å¤å»ºè®®"
    echo "0) é€€å‡º"
    echo
    
    read -p "è¯·é€‰æ‹©ä¿®å¤é€‰é¡¹ (0-5): " -r choice
    
    case "$choice" in
        1) fix_basic_permissions "$path" "user" ;;
        2) fix_basic_permissions "$path" "group" ;;
        3) fix_basic_permissions "$path" "all" ;;
        4) create_monitor_user ;;
        5) show_suggestions "$path" ;;
        0) echo "é€€å‡º"; exit 0 ;;
        *) echo "æ— æ•ˆé€‰é¡¹"; show_fix_menu "$path" ;;
    esac
}

show_suggestions() {
    local path="$1"
    
    echo "ğŸ’¡ ä¿®å¤å»ºè®®"
    echo
    echo "æ ¹æ®æƒé™æ£€æŸ¥ç»“æœï¼Œå»ºè®®é‡‡å–ä»¥ä¸‹æªæ–½:"
    echo
    echo "ğŸ” æƒé™é—®é¢˜ï¼š"
    echo "  - æœ€å°æƒé™åŸåˆ™ï¼šåªç»™å¿…è¦çš„æƒé™"
    echo "  - ä½¿ç”¨ä¸“ç”¨ç”¨æˆ·ï¼šåˆ›å»ºä¸“é—¨çš„ç›‘æ§ç”¨æˆ·"
    echo "  - å®šæœŸæ£€æŸ¥ï¼šå®šæœŸå®¡æŸ¥æƒé™è®¾ç½®"
    echo
    echo "ğŸ›¡ï¸  å®‰å…¨å¢å¼ºï¼š"
    echo "  - SELinuxï¼šé…ç½®é€‚å½“çš„å®‰å…¨ä¸Šä¸‹æ–‡"
    echo "  - AppArmorï¼šåˆ›å»ºç›‘æ§ç¨‹åºçš„é…ç½®æ–‡ä»¶"
    echo "  - å®¡è®¡ï¼šå¯ç”¨æ–‡ä»¶è®¿é—®å®¡è®¡"
    echo
    echo "ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼š"
    echo "  - é¿å…ç›‘æ§æ ¹ç›®å½•ï¼šåªç›‘æ§å¿…è¦è·¯å¾„"
    echo "  - æ’é™¤ä¸´æ—¶æ–‡ä»¶ï¼šä½¿ç”¨--excludeé€‰é¡¹"
    echo "  - åˆç†è®¾ç½®é™åˆ¶ï¼šæ ¹æ®éœ€æ±‚è°ƒæ•´å†…æ ¸å‚æ•°"
}

# ä½¿ç”¨ç¤ºä¾‹

if [ $# -eq 0 ]; then
    echo "ç”¨æ³•: $0 <è·¯å¾„> [auto]"
    echo "ç¤ºä¾‹: $0 /var/log"
    echo "      $0 /home/user auto  # è‡ªåŠ¨ä¿®å¤"
    exit 1
fi

if [ "$2" = "auto" ]; then
    echo "ğŸ¤– è‡ªåŠ¨ä¿®å¤æ¨¡å¼"
    fix_basic_permissions "$1" "user"
else
    show_fix_menu "$1"
fi
```

---

## 8. ğŸ“Š ç›‘æ§æ€§èƒ½ç“¶é¢ˆåˆ†æ



### 8.1 æ€§èƒ½ç“¶é¢ˆçš„å¸¸è§è¡¨ç°



**å…¸å‹ç—‡çŠ¶**ï¼š
- ğŸ“‰ **äº‹ä»¶å¤„ç†å»¶è¿Ÿ**ï¼šç›‘æ§åˆ°æ–‡ä»¶å˜åŒ–ï¼Œä½†å¤„ç†å¾ˆæ…¢
- ğŸ’¥ **CPUå ç”¨è¿‡é«˜**ï¼šinotifyè¿›ç¨‹æ¶ˆè€—å¤§é‡CPU
- ğŸ’¾ **å†…å­˜æ³„æ¼**ï¼šå†…å­˜ä½¿ç”¨é‡æŒç»­å¢é•¿
- ğŸŒ **å“åº”é€Ÿåº¦ä¸‹é™**ï¼šç³»ç»Ÿæ•´ä½“å˜æ…¢

### 8.2 æ€§èƒ½ç›‘æ§å·¥å…·



```bash
#!/bin/bash

# performance_monitor.sh - ç›‘æ§æ€§èƒ½åˆ†æå·¥å…·


# æ€§èƒ½æ•°æ®æ”¶é›†

collect_performance_data() {
    local monitor_pid="$1"
    local output_file="$2"
    local duration="${3:-60}"  # ç›‘æ§æ—¶é•¿ï¼ˆç§’ï¼‰
    
    echo "ğŸ“Š å¼€å§‹æ”¶é›†æ€§èƒ½æ•°æ®..."
    echo "ç›‘æ§è¿›ç¨‹PID: $monitor_pid"
    echo "æ•°æ®è¾“å‡º: $output_file"
    echo "ç›‘æ§æ—¶é•¿: ${duration}ç§’"
    
#    # åˆ›å»ºæ•°æ®æ–‡ä»¶
    cat > "$output_file" << EOF
# æ€§èƒ½ç›‘æ§æ•°æ® - $(date)

# PID: $monitor_pid

# æ—¶é—´æˆ³,CPUä½¿ç”¨ç‡(%),å†…å­˜ä½¿ç”¨(KB),æ–‡ä»¶æè¿°ç¬¦æ•°,inotifyå®ä¾‹æ•°,å¤„ç†å»¶è¿Ÿ(ms)

EOF
    
    local start_time=$(date +%s)
    local end_time=$((start_time + duration))
    
    while [ $(date +%s) -lt $end_time ]; do
        if ! ps -p "$monitor_pid" > /dev/null 2>&1; then
            echo "âš ï¸  ç›‘æ§è¿›ç¨‹å·²é€€å‡º"
            break
        fi
        
#        # æ”¶é›†CPUå’Œå†…å­˜æ•°æ®
        cpu_mem=$(ps -p "$monitor_pid" -o %cpu,%mem,rss --no-headers)
        cpu_usage=$(echo "$cpu_mem" | awk '{print $1}')
        mem_usage=$(echo "$cpu_mem" | awk '{print $3}')  # RSS in KB
        
#        # æ”¶é›†æ–‡ä»¶æè¿°ç¬¦æ•°é‡
        fd_count=$(ls /proc/"$monitor_pid"/fd/ 2>/dev/null | wc -l)
        
#        # æ”¶é›†inotifyå®ä¾‹æ•°é‡
        inotify_count=$(ls -la /proc/"$monitor_pid"/fd/ 2>/dev/null | grep -c "inotify" || echo 0)
        
#        # ç®€å•çš„å»¶è¿Ÿæµ‹è¯•ï¼ˆåˆ›å»ºæ–‡ä»¶å¹¶æµ‹é‡æ£€æµ‹æ—¶é—´ï¼‰
        delay_ms=$(measure_detection_delay)
        
#        # è®°å½•æ•°æ®
        echo "$(date +%s),$cpu_usage,$mem_usage,$fd_count,$inotify_count,$delay_ms" >> "$output_file"
        
        sleep 5
    done
    
    echo "âœ… æ€§èƒ½æ•°æ®æ”¶é›†å®Œæˆ"
}

# æµ‹é‡æ£€æµ‹å»¶è¿Ÿ

measure_detection_delay() {
    local test_dir="/tmp/perf_test_$$"
    mkdir -p "$test_dir"
    
    local start_time_ns=$(date +%s%N)
    
#    # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
    echo "test" > "$test_dir/testfile_$$"
    
#    # ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿äº‹ä»¶è¢«å¤„ç†
    sleep 0.1
    
    local end_time_ns=$(date +%s%N)
    local delay_ns=$((end_time_ns - start_time_ns))
    local delay_ms=$((delay_ns / 1000000))
    
#    # æ¸…ç†
    rm -rf "$test_dir"
    
    echo "$delay_ms"
}

# åˆ†ææ€§èƒ½æ•°æ®

analyze_performance() {
    local data_file="$1"
    
    echo "ğŸ“ˆ æ€§èƒ½æ•°æ®åˆ†æ"
    
    if [ ! -f "$data_file" ]; then
        echo "âŒ æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨: $data_file"
        return 1
    fi
    
#    # è·³è¿‡å¤´éƒ¨æ³¨é‡Šï¼Œåˆ†ææ•°æ®
    tail -n +6 "$data_file" > /tmp/perf_data.csv
    
    if [ ! -s /tmp/perf_data.csv ]; then
        echo "âŒ æ²¡æœ‰æœ‰æ•ˆçš„æ€§èƒ½æ•°æ®"
        return 1
    fi
    
    echo "CPUä½¿ç”¨ç‡ç»Ÿè®¡:"
    awk -F',' '{cpu+=$2; count++} END {
        if(count>0) {
            avg=cpu/count
            printf "  å¹³å‡CPUä½¿ç”¨ç‡: %.2f%%\n", avg
            if(avg > 50) print "  âš ï¸  CPUä½¿ç”¨ç‡åé«˜"
            else print "  âœ… CPUä½¿ç”¨ç‡æ­£å¸¸"
        }
    }' /tmp/perf_data.csv
    
    echo
    echo "å†…å­˜ä½¿ç”¨ç»Ÿè®¡:"
    awk -F',' '{
        mem=$3; 
        if(NR==1) {start_mem=mem; max_mem=mem; min_mem=mem}
        if(mem>max_mem) max_mem=mem
        if(mem<min_mem) min_mem=mem
        total_mem+=mem; count++
    } END {
        if(count>0) {
            avg_mem=total_mem/count
            growth=max_mem-start_mem
            printf "  å¹³å‡å†…å­˜ä½¿ç”¨: %.0f KB\n", avg_mem
            printf "  æœ€å¤§å†…å­˜ä½¿ç”¨: %.0f KB\n", max_mem
            printf "  å†…å­˜å¢é•¿: %.0f KB\n", growth
            if(growth > avg_mem*0.1) print "  âš ï¸  å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼"
            else print "  âœ… å†…å­˜ä½¿ç”¨ç¨³å®š"
        }
    }' /tmp/perf_data.csv
    
    echo
    echo "å“åº”å»¶è¿Ÿç»Ÿè®¡:"
    awk -F',' '{
        delay=$5
        total_delay+=delay; count++
        if(delay>max_delay) max_delay=delay
        if(NR==1) min_delay=delay
        if(delay<min_delay) min_delay=delay
    } END {
        if(count>0) {
            avg_delay=total_delay/count
            printf "  å¹³å‡å»¶è¿Ÿ: %.0f ms\n", avg_delay
            printf "  æœ€å¤§å»¶è¿Ÿ: %.0f ms\n", max_delay
            printf "  æœ€å°å»¶è¿Ÿ: %.0f ms\n", min_delay
            if(avg_delay > 100) print "  âš ï¸  å“åº”å»¶è¿Ÿè¾ƒé«˜"
            else print "  âœ… å“åº”å»¶è¿Ÿæ­£å¸¸"
        }
    }' /tmp/perf_data.csv
    
    rm -f /tmp/perf_data.csv
}

# ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š

generate_report() {
    local data_file="$1"
    local report_file="${data_file}.report"
    
    echo "ğŸ“„ ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š: $report_file"
    
    cat > "$report_file" << EOF
# inotifyç›‘æ§æ€§èƒ½æŠ¥å‘Š

ç”Ÿæˆæ—¶é—´: $(date)
æ•°æ®æ–‡ä»¶: $data_file

# ç³»ç»Ÿä¿¡æ¯


æ“ä½œç³»ç»Ÿ: $(uname -a)
CPUä¿¡æ¯: $(grep "model name" /proc/cpuinfo | head -1 | cut -d: -f2)
å†…å­˜ä¿¡æ¯: $(free -h | grep "Mem:" | awk '{print $2}')

# æ€§èƒ½åˆ†æç»“æœ


EOF
    
    analyze_performance "$data_file" >> "$report_file"
    
    cat >> "$report_file" << EOF

# ä¼˜åŒ–å»ºè®®


æ ¹æ®æ€§èƒ½åˆ†æç»“æœï¼Œå»ºè®®ï¼š

1. å¦‚æœCPUä½¿ç”¨ç‡è¿‡é«˜ï¼š
   - å‡å°‘ç›‘æ§çš„ç›®å½•æ•°é‡
   - ä½¿ç”¨--excludeæ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ç±»å‹
   - å¢åŠ äº‹ä»¶å¤„ç†çš„æ‰¹å¤„ç†å¤§å°

2. å¦‚æœå†…å­˜ä½¿ç”¨å¢é•¿ï¼š
   - æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼
   - å®šæœŸé‡å¯ç›‘æ§è¿›ç¨‹
   - ä¼˜åŒ–äº‹ä»¶å¤„ç†é€»è¾‘

3. å¦‚æœå“åº”å»¶è¿Ÿè¿‡é«˜ï¼š
   - æ£€æŸ¥ç£ç›˜IOæ€§èƒ½
   - ä¼˜åŒ–æ–‡ä»¶å¤„ç†è„šæœ¬
   - è€ƒè™‘ä½¿ç”¨å¼‚æ­¥å¤„ç†
EOF
    
    echo "âœ… æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
}
```

### 8.3 æ€§èƒ½ä¼˜åŒ–å®è·µ



```bash
#!/bin/bash

# optimized_monitor.sh - æ€§èƒ½ä¼˜åŒ–çš„ç›‘æ§è„šæœ¬


# é…ç½®å‚æ•°

WATCH_PATH="${1:-/var/log}"
BATCH_SIZE=50
BATCH_TIMEOUT=5
WORKER_PROCESSES=4

# æ€§èƒ½ä¼˜åŒ–é…ç½®

optimize_system() {
    echo "ğŸš€ åº”ç”¨ç³»ç»Ÿä¼˜åŒ–é…ç½®"
    
#    # è°ƒæ•´inotifyå‚æ•°
    echo 1048576 > /proc/sys/fs/inotify/max_user_watches    # 1M watches
    echo 512 > /proc/sys/fs/inotify/max_user_instances      # 512 instances  
    echo 65536 > /proc/sys/fs/inotify/max_queued_events     # 64K events
    
#    # è°ƒæ•´è¿›ç¨‹ä¼˜å…ˆçº§
    renice -10 $$  # æé«˜å½“å‰è¿›ç¨‹ä¼˜å…ˆçº§
    
    echo "âœ… ç³»ç»Ÿä¼˜åŒ–å®Œæˆ"
}

# æ‰¹é‡äº‹ä»¶å¤„ç†

batch_process_events() {
    local batch_file="$1"
    local batch_id="$2"
    
#    # ç»Ÿè®¡å¤„ç†äº‹ä»¶æ•°é‡
    local event_count=$(wc -l < "$batch_file")
    echo "[æ‰¹æ¬¡$batch_id] å¤„ç† $event_count ä¸ªäº‹ä»¶"
    
#    # æ‰¹é‡å¤„ç†ï¼ˆç¤ºä¾‹ï¼šæŒ‰æ–‡ä»¶ç±»å‹åˆ†ç±»å¤„ç†ï¼‰
    {
#        # å¤„ç†CREATEäº‹ä»¶
        grep " CREATE" "$batch_file" | while read event; do
            handle_create_event "$event"
        done
        
#        # å¤„ç†MODIFYäº‹ä»¶
        grep " MODIFY" "$batch_file" | while read event; do
            handle_modify_event "$event"
        done
        
#        # å¤„ç†DELETEäº‹ä»¶
        grep " DELETE" "$batch_file" | while read event; do
            handle_delete_event "$event"
        done
    } &  # åå°å¤„ç†
}

handle_create_event() {
    local event="$1"
    local filepath=$(echo "$event" | awk '{print $1}')
    echo "ğŸ“ æ–°å»ºæ–‡ä»¶: $filepath"
#    # è¿™é‡Œæ·»åŠ åˆ›å»ºäº‹ä»¶çš„å¤„ç†é€»è¾‘
}

handle_modify_event() {
    local event="$1"
    local filepath=$(echo "$event" | awk '{print $1}')
    echo "âœï¸ ä¿®æ”¹æ–‡ä»¶: $filepath"
#    # è¿™é‡Œæ·»åŠ ä¿®æ”¹äº‹ä»¶çš„å¤„ç†é€»è¾‘
}

handle_delete_event() {
    local event="$1"
    local filepath=$(echo "$event" | awk '{print $1}')
    echo "ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶: $filepath"
#    # è¿™é‡Œæ·»åŠ åˆ é™¤äº‹ä»¶çš„å¤„ç†é€»è¾‘
}

# ä¸»ç›‘æ§å¾ªç¯ï¼ˆé«˜æ€§èƒ½ç‰ˆæœ¬ï¼‰

main_monitor_optimized() {
    local watch_path="$1"
    
    echo "ğŸš€ å¯åŠ¨é«˜æ€§èƒ½ç›‘æ§æ¨¡å¼"
    echo "ç›‘æ§è·¯å¾„: $watch_path"
    echo "æ‰¹å¤„ç†å¤§å°: $BATCH_SIZE"
    echo "æ‰¹å¤„ç†è¶…æ—¶: ${BATCH_TIMEOUT}ç§’"
    
    local batch_counter=0
    local batch_file="/tmp/inotify_batch_$"
    local last_flush=$(date +%s)
    
#    # å¯åŠ¨inotifyç›‘æ§
    inotifywait -m -r "$watch_path" \
        --format '%w%f %e %T' \
        --timefmt '%s' \
        -e create,delete,modify \
        --exclude '\.(tmp|swp|lock)$|~ | \
    while read filepath event timestamp; do
#        # æ·»åŠ åˆ°æ‰¹å¤„ç†ç¼“å†²åŒº
        echo "$filepath $event $timestamp" >> "$batch_file"
        batch_counter=$((batch_counter + 1))
        
        current_time=$(date +%s)
        time_elapsed=$((current_time - last_flush))
        
#        # æ£€æŸ¥æ˜¯å¦éœ€è¦å¤„ç†æ‰¹æ¬¡
        if [ "$batch_counter" -ge "$BATCH_SIZE" ] || [ "$time_elapsed" -ge "$BATCH_TIMEOUT" ]; then
            if [ -s "$batch_file" ]; then
#                # å¼‚æ­¥å¤„ç†æ‰¹æ¬¡
                batch_process_events "$batch_file" "$(date +%H%M%S)" &
                
#                # é‡ç½®æ‰¹å¤„ç†çŠ¶æ€
                > "$batch_file"  # æ¸…ç©ºæ–‡ä»¶
                batch_counter=0
                last_flush=$current_time
            fi
        fi
    done
    
#    # æ¸…ç†
    rm -f "$batch_file"
}

# èµ„æºç›‘æ§å’Œè‡ªåŠ¨è°ƒä¼˜

auto_tune_performance() {
    echo "ğŸ›ï¸ å¯åŠ¨è‡ªåŠ¨æ€§èƒ½è°ƒä¼˜"
    
    while true; do
#        # æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
        load_avg=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')
        cpu_cores=$(nproc)
        load_ratio=$(echo "scale=2; $load_avg / $cpu_cores" | bc -l)
        
#        # æ£€æŸ¥å†…å­˜ä½¿ç”¨
        mem_usage=$(free | awk '/^Mem:/ {printf "%.1f", $3/$2 * 100}')
        
        echo "[$(date '+%H:%M:%S')] è´Ÿè½½: $load_avg, å†…å­˜: ${mem_usage}%"
        
#        # æ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´
        if (( $(echo "$load_ratio > 1.5" | bc -l) )); then
            echo "âš ï¸ é«˜è´Ÿè½½æ£€æµ‹ï¼Œå‡å°‘ç›‘æ§é¢‘ç‡"
#            # å¯ä»¥åŠ¨æ€è°ƒæ•´ç›‘æ§å‚æ•°
            export BATCH_SIZE=$((BATCH_SIZE + 10))
            export BATCH_TIMEOUT=$((BATCH_TIMEOUT + 2))
        elif (( $(echo "$load_ratio < 0.5" | bc -l) )); then
            echo "âœ… è´Ÿè½½æ­£å¸¸ï¼Œæ¢å¤æ ‡å‡†ç›‘æ§"
            export BATCH_SIZE=50
            export BATCH_TIMEOUT=5
        fi
        
        sleep 30
    done
}

# ç›‘æ§ç»Ÿè®¡ä¿¡æ¯

show_monitor_stats() {
    echo "ğŸ“Š ç›‘æ§ç»Ÿè®¡ä¿¡æ¯"
    echo "=================================="
    
#    # æ˜¾ç¤ºinotifyä½¿ç”¨æƒ…å†µ
    echo "inotifyèµ„æºä½¿ç”¨:"
    max_watches=$(cat /proc/sys/fs/inotify/max_user_watches)
    current_watches=$(find /proc/*/fd -type l 2>/dev/null | xargs readlink 2>/dev/null | grep -c inotify)
    usage_percent=$((current_watches * 100 / max_watches))
    echo "  ç›‘æ§æ•°ä½¿ç”¨: $current_watches / $max_watches (${usage_percent}%)"
    
#    # æ˜¾ç¤ºç³»ç»Ÿèµ„æº
    echo "ç³»ç»Ÿèµ„æº:"
    echo "  CPUè´Ÿè½½: $(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')"
    echo "  å†…å­˜ä½¿ç”¨: $(free -h | awk '/^Mem:/ {print $3 "/" $2}')"
    echo "  ç£ç›˜IO: $(iostat -x 1 1 | tail -1 | awk '{print "è¯»:" $4 "KB/s å†™:" $5 "KB/s"}')"
    
#    # æ˜¾ç¤ºç›‘æ§è¿›ç¨‹ä¿¡æ¯
    echo "ç›‘æ§è¿›ç¨‹:"
    ps aux | grep -E "(inotifywait|inotify)" | grep -v grep | while read line; do
        echo "  $line"
    done
}

# æ•…éšœæ¢å¤æœºåˆ¶

implement_fault_recovery() {
    local watch_path="$1"
    local max_retries=5
    local retry_count=0
    local backoff_time=1
    
    echo "ğŸ›¡ï¸ å¯åŠ¨æ•…éšœæ¢å¤ç›‘æ§"
    
    while [ $retry_count -lt $max_retries ]; do
        echo "å°è¯•å¯åŠ¨ç›‘æ§ (ç¬¬$((retry_count + 1))æ¬¡)"
        
        if main_monitor_optimized "$watch_path"; then
            echo "âœ… ç›‘æ§æ­£å¸¸é€€å‡º"
            break
        else
            retry_count=$((retry_count + 1))
            
            echo "âŒ ç›‘æ§å¼‚å¸¸é€€å‡ºï¼Œç­‰å¾…${backoff_time}ç§’åé‡è¯•"
            sleep $backoff_time
            
#            # æŒ‡æ•°é€€é¿
            backoff_time=$((backoff_time * 2))
            if [ $backoff_time -gt 60 ]; then
                backoff_time=60
            fi
            
#            # æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
            echo "æ£€æŸ¥ç³»ç»ŸçŠ¶æ€..."
            if ! command -v inotifywait >/dev/null; then
                echo "âŒ inotifywaitå‘½ä»¤ä¸å¯ç”¨"
                break
            fi
            
            if [ ! -d "$watch_path" ]; then
                echo "âŒ ç›‘æ§è·¯å¾„ä¸å­˜åœ¨: $watch_path"
                break
            fi
        fi
    done
    
    if [ $retry_count -ge $max_retries ]; then
        echo "ğŸ’¥ ç›‘æ§é‡è¯•æ¬¡æ•°ç”¨å®Œï¼Œç¨‹åºé€€å‡º"
        exit 1
    fi
}

# ä¸»ç¨‹åºå…¥å£

main() {
    echo "=== inotifyé«˜æ€§èƒ½ç›‘æ§ç³»ç»Ÿ ==="
    echo "å¯åŠ¨æ—¶é—´: $(date)"
    
#    # æ£€æŸ¥å‚æ•°
    if [ $# -eq 0 ]; then
        echo "ç”¨æ³•: $0 <ç›‘æ§è·¯å¾„> [é€‰é¡¹]"
        echo "é€‰é¡¹:"
        echo "  --optimize    åº”ç”¨ç³»ç»Ÿä¼˜åŒ–"
        echo "  --auto-tune   å¯ç”¨è‡ªåŠ¨è°ƒä¼˜"
        echo "  --stats       æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯"
        echo "  --recovery    å¯ç”¨æ•…éšœæ¢å¤"
        exit 1
    fi
    
    local watch_path="$1"
    shift
    
#    # å¤„ç†é€‰é¡¹
    local enable_optimize=false
    local enable_autotune=false
    local show_stats=false
    local enable_recovery=false
    
    while [ $# -gt 0 ]; do
        case "$1" in
            --optimize)   enable_optimize=true ;;
            --auto-tune)  enable_autotune=true ;;
            --stats)      show_stats=true ;;
            --recovery)   enable_recovery=true ;;
            *)           echo "æœªçŸ¥é€‰é¡¹: $1" ;;
        esac
        shift
    done
    
#    # æ‰§è¡Œç›¸åº”åŠŸèƒ½
    if [ "$show_stats" = true ]; then
        show_monitor_stats
        exit 0
    fi
    
    if [ "$enable_optimize" = true ]; then
        optimize_system
    fi
    
    if [ "$enable_autotune" = true ]; then
        auto_tune_performance &
    fi
    
#    # å¯åŠ¨ç›‘æ§
    if [ "$enable_recovery" = true ]; then
        implement_fault_recovery "$watch_path"
    else
        main_monitor_optimized "$watch_path"
    fi
}

# ä¿¡å·å¤„ç†

cleanup() {
    echo
    echo "ğŸ›‘ æ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œæ­£åœ¨æ¸…ç†..."
    
#    # ç»ˆæ­¢æ‰€æœ‰åå°ä»»åŠ¡
    jobs -p | xargs -r kill
    
#    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f /tmp/inotify_batch_*
    
    echo "âœ… æ¸…ç†å®Œæˆï¼Œç¨‹åºé€€å‡º"
    exit 0
}

trap cleanup SIGTERM SIGINT

# è¿è¡Œä¸»ç¨‹åº

main "$@"
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ äº‹ä»¶ä¸¢å¤±ï¼šç†è§£ä¸ºä»€ä¹ˆä¼šä¸¢å¤±äº‹ä»¶ï¼Œå¦‚ä½•è¯Šæ–­å’Œé¢„é˜²
ğŸ”¸ è¿›ç¨‹ç®¡ç†ï¼šç›‘æ§è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œå¼‚å¸¸å¤„ç†
ğŸ”¸ æ€§èƒ½ç“¶é¢ˆï¼šè¯†åˆ«å’Œè§£å†³é«˜è´Ÿè½½ä¸‹çš„ç›‘æ§é—®é¢˜
ğŸ”¸ ç³»ç»Ÿå…¼å®¹ï¼šä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„æ”¯æŒæƒ…å†µå’Œåº”å¯¹ç­–ç•¥
ğŸ”¸ è°ƒè¯•æŠ€å·§ï¼šæœ‰æ•ˆçš„æ•…éšœæ’æŸ¥å’Œé—®é¢˜å®šä½æ–¹æ³•
ğŸ”¸ å†…æ ¸é™åˆ¶ï¼šç†è§£å’Œè°ƒæ•´inotifyç›¸å…³çš„å†…æ ¸å‚æ•°
ğŸ”¸ æƒé™è¯Šæ–­ï¼šå…¨é¢çš„æƒé™é—®é¢˜æ’æŸ¥å’Œè§£å†³æ–¹æ¡ˆ
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šç›‘æ§ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆåˆ†æå’Œä¼˜åŒ–
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ æ•…éšœæ’æŸ¥çš„ç³»ç»Ÿæ€§æ–¹æ³•**
```
åˆ†å±‚è¯Šæ–­æ€è·¯:
1ï¸âƒ£ åŸºç¡€ç¯å¢ƒ â†’ æ£€æŸ¥å‘½ä»¤ã€è·¯å¾„ã€æƒé™
2ï¸âƒ£ ç³»ç»Ÿèµ„æº â†’ æ£€æŸ¥å†…æ ¸é™åˆ¶ã€æ–‡ä»¶æè¿°ç¬¦
3ï¸âƒ£ æ–‡ä»¶ç³»ç»Ÿ â†’ æ£€æŸ¥å…¼å®¹æ€§ã€æŒ‚è½½é€‰é¡¹
4ï¸âƒ£ å®‰å…¨æœºåˆ¶ â†’ æ£€æŸ¥SELinuxã€AppArmor
5ï¸âƒ£ æ€§èƒ½ç“¶é¢ˆ â†’ æ£€æŸ¥CPUã€å†…å­˜ã€IO
```

**ğŸ”¹ é¢„é˜²èƒœäºæ²»ç–—çš„åŸåˆ™**
```
é¢„é˜²æªæ–½:
â€¢ å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
â€¢ å¥å£®çš„é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘  
â€¢ åˆç†çš„èµ„æºé™åˆ¶å’Œé…ç½®
â€¢ å®šæœŸçš„å¥åº·æ£€æŸ¥å’Œç»´æŠ¤
â€¢ è¯¦ç»†çš„æ—¥å¿—è®°å½•å’Œåˆ†æ
```

**ğŸ”¹ æ€§èƒ½ä¸ç¨³å®šæ€§çš„å¹³è¡¡**
```
ä¼˜åŒ–ç­–ç•¥:
â€¢ ç›‘æ§èŒƒå›´ vs ç³»ç»Ÿè´Ÿè½½
â€¢ äº‹ä»¶å¤„ç†é€Ÿåº¦ vs èµ„æºæ¶ˆè€—
â€¢ å®æ—¶æ€§ vs æ‰¹å¤„ç†æ•ˆç‡
â€¢ åŠŸèƒ½å®Œæ•´æ€§ vs ç³»ç»Ÿå¤æ‚åº¦
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼



**ğŸ“Š ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ**
- **ç›‘æ§ç³»ç»Ÿè®¾è®¡**ï¼šå¤šå±‚æ¬¡çš„ç›‘æ§å’Œå‘Šè­¦
- **æ•…éšœå¿«é€Ÿå®šä½**ï¼šç³»ç»ŸåŒ–çš„è¯Šæ–­æµç¨‹
- **æ€§èƒ½æŒç»­ä¼˜åŒ–**ï¼šåŸºäºæ•°æ®çš„è°ƒä¼˜å†³ç­–
- **è¿ç»´è‡ªåŠ¨åŒ–**ï¼šæ•…éšœè‡ªæ„ˆå’Œè‡ªåŠ¨æ‰©å±•

**ğŸ”§ è¿ç»´å®æˆ˜æŠ€èƒ½**
- **é—®é¢˜å®šä½èƒ½åŠ›**ï¼šå¿«é€Ÿè¯†åˆ«å’Œå®šä½æ•…éšœæ ¹å› 
- **ç³»ç»Ÿè°ƒä¼˜ç»éªŒ**ï¼šåŸºäºè´Ÿè½½ç‰¹å¾çš„å‚æ•°è°ƒæ•´
- **è„šæœ¬ç¼–å†™èƒ½åŠ›**ï¼šè‡ªåŠ¨åŒ–ç›‘æ§å’Œæ•…éšœå¤„ç†
- **æ–‡æ¡£è®°å½•ä¹ æƒ¯**ï¼šå®Œå–„çš„æ•…éšœå¤„ç†æ–‡æ¡£

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ç›‘æ§æ•…éšœè«æ…Œå¼ ï¼Œåˆ†å±‚è¯Šæ–­æ‰¾æ–¹å‘
æƒé™èµ„æºå…ˆæ£€æŸ¥ï¼Œç³»ç»Ÿå…¼å®¹å†è€ƒé‡
æ—¥å¿—è°ƒè¯•æ˜¯åˆ©å™¨ï¼Œæ€§èƒ½ä¼˜åŒ–è¦è·Ÿä¸Š
é¢„é˜²æªæ–½è¦åˆ°ä½ï¼Œè¿ç»´è‡ªåŠ¨åŒ–ä¸ºç‹
```

**ğŸ¯ å…³é”®è¦ç‚¹**ï¼š
- æ•…éšœæ’æŸ¥éœ€è¦ç³»ç»Ÿæ€§æ€ç»´ï¼Œä¸èƒ½å¤´ç—›åŒ»å¤´è„šç—›åŒ»è„š
- æ€§èƒ½ä¼˜åŒ–è¦åŸºäºå®é™…ç›‘æ§æ•°æ®ï¼Œé¿å…è¿‡æ—©ä¼˜åŒ–
- æƒé™é—®é¢˜å¾€å¾€æ˜¯ç›‘æ§å¤±è´¥çš„ä¸»è¦åŸå› ä¹‹ä¸€
- é«˜è´Ÿè½½ç¯å¢ƒä¸‹éœ€è¦ç‰¹æ®Šçš„ç›‘æ§ç­–ç•¥å’Œä¼˜åŒ–æ‰‹æ®µ
- å®Œå–„çš„æ—¥å¿—è®°å½•æ˜¯æ•…éšœæ’æŸ¥çš„é‡è¦åŸºç¡€