---
title: 10ã€é«˜çº§ç›‘æ§æ¨¡å¼åº”ç”¨
---
## ğŸ“š ç›®å½•

1. [å¤šå±‚çº§ç›®å½•ç›‘æ§æ¶æ„](#1-å¤šå±‚çº§ç›®å½•ç›‘æ§æ¶æ„)
2. [åˆ†å¸ƒå¼æ–‡ä»¶ç›‘æ§æ–¹æ¡ˆ](#2-åˆ†å¸ƒå¼æ–‡ä»¶ç›‘æ§æ–¹æ¡ˆ)
3. [è¿œç¨‹æ–‡ä»¶ç³»ç»Ÿç›‘æ§](#3-è¿œç¨‹æ–‡ä»¶ç³»ç»Ÿç›‘æ§)
4. [å®¹å™¨å†…æ–‡ä»¶ç›‘æ§](#4-å®¹å™¨å†…æ–‡ä»¶ç›‘æ§)
5. [ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿäº‹ä»¶å¤„ç†](#5-ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿäº‹ä»¶å¤„ç†)
6. [ç›‘æ§æ•°æ®èšåˆåˆ†æ](#6-ç›‘æ§æ•°æ®èšåˆåˆ†æ)
7. [å®æ—¶ç›‘æ§Dashboard](#7-å®æ—¶ç›‘æ§Dashboard)
8. [ç›‘æ§å‘Šè­¦é›†æˆæ–¹æ¡ˆ](#8-ç›‘æ§å‘Šè­¦é›†æˆæ–¹æ¡ˆ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ å¤šå±‚çº§ç›®å½•ç›‘æ§æ¶æ„


### 1.1 ä»€ä¹ˆæ˜¯å¤šå±‚çº§ç›‘æ§


**é€šä¿—ç†è§£**ï¼šå°±åƒä¸€ä¸ªå¤§å‹å•†åœºï¼Œä¸ä»…è¦ç›‘æ§æ¯ä¸ªåº—é“ºï¼Œè¿˜è¦ç›‘æ§æ¯å±‚æ¥¼ï¼Œç”šè‡³æ•´æ ‹æ¥¼çš„äººæµå˜åŒ–

```
ä¼ä¸šæ–‡ä»¶ç³»ç»Ÿæ¶æ„ç¤ºä¾‹ï¼š
/company/
â”œâ”€â”€ projects/          â† é¡¹ç›®æ–‡ä»¶å¤¹
â”‚   â”œâ”€â”€ project-a/     â† å…·ä½“é¡¹ç›®
â”‚   â””â”€â”€ project-b/
â”œâ”€â”€ shared/            â† å…±äº«èµ„æº
â”‚   â”œâ”€â”€ documents/
â”‚   â””â”€â”€ templates/
â””â”€â”€ backup/            â† å¤‡ä»½ç›®å½•
    â”œâ”€â”€ daily/
    â””â”€â”€ weekly/

æ¯ä¸€å±‚éƒ½éœ€è¦ä¸åŒçš„ç›‘æ§ç­–ç•¥ï¼
```

### 1.2 åˆ†å±‚ç›‘æ§ç­–ç•¥è®¾è®¡


**ğŸ¯ æ ¸å¿ƒæ€è·¯**ï¼šä¸åŒå±‚çº§ç”¨ä¸åŒçš„ç›‘æ§ç²’åº¦å’Œå¤„ç†æ–¹å¼

```bash
#!/bin/bash
# åˆ†å±‚ç›‘æ§è„šæœ¬
# æ ¹æ®ç›®å½•å±‚çº§è®¾ç½®ä¸åŒç›‘æ§è§„åˆ™

setup_layered_monitoring() {
    # é¡¶å±‚ç›®å½• - åªç›‘æ§ç»“æ„å˜åŒ–
    inotifywait -m /company/ -e create,delete,move --format '%w%f %e' | while read file event; do
        echo "[TOP] é¡¶å±‚ç»“æ„å˜åŒ–: $file - $event"
        # å‘é€ç»“æ„å˜åŒ–å‘Šè­¦
        send_structure_alert "$file" "$event"
    done &
    
    # é¡¹ç›®ç›®å½• - ç›‘æ§æ–‡ä»¶ä¿®æ”¹å’Œè®¿é—®
    inotifywait -m -r /company/projects/ -e modify,access,create --format '%w%f %e %T' --timefmt '%Y-%m-%d %H:%M:%S' | while read file event time; do
        echo "[PROJECT] é¡¹ç›®æ–‡ä»¶æ“ä½œ: $file - $event at $time"
        # è®°å½•é¡¹ç›®æ´»åŠ¨æ—¥å¿—
        log_project_activity "$file" "$event" "$time"
    done &
    
    # å¤‡ä»½ç›®å½• - åªç›‘æ§å†™å…¥å®Œæˆ
    inotifywait -m -r /company/backup/ -e close_write --format '%w%f %e' | while read file event; do
        echo "[BACKUP] å¤‡ä»½å®Œæˆ: $file"
        # éªŒè¯å¤‡ä»½å®Œæ•´æ€§
        verify_backup "$file"
    done &
}
```

### 1.3 é€’å½’ç›‘æ§ä¼˜åŒ–


**é—®é¢˜**ï¼šç›‘æ§å¤§ç›®å½•æ ‘ä¼šæ¶ˆè€—å¤§é‡ç³»ç»Ÿèµ„æº

**è§£å†³æ–¹æ¡ˆ**ï¼šæ™ºèƒ½é€’å½’ç›‘æ§

```bash
# æ™ºèƒ½é€’å½’ç›‘æ§ - é¿å…ç›‘æ§æ— ç”¨ç›®å½•
setup_smart_recursive() {
    local base_dir="$1"
    
    # æ’é™¤ä¸éœ€è¦ç›‘æ§çš„ç›®å½•
    exclude_patterns=(
        "*/\.git/*"        # Gitç›®å½•
        "*/node_modules/*" # npmç›®å½•
        "*/\.tmp/*"        # ä¸´æ—¶ç›®å½•
        "*/cache/*"        # ç¼“å­˜ç›®å½•
    )
    
    # æ„å»ºæ’é™¤å‚æ•°
    exclude_args=""
    for pattern in "${exclude_patterns[@]}"; do
        exclude_args="$exclude_args --exclude=$pattern"
    done
    
    # å¯åŠ¨ç›‘æ§
    inotifywait -m -r "$base_dir" $exclude_args \
        -e modify,create,delete \
        --format '%w%f %e %T' \
        --timefmt '%Y-%m-%d %H:%M:%S'
}
```

---

## 2. ğŸŒ åˆ†å¸ƒå¼æ–‡ä»¶ç›‘æ§æ–¹æ¡ˆ


### 2.1 åˆ†å¸ƒå¼ç›‘æ§çš„å¿…è¦æ€§


**ç°å®åœºæ™¯**ï¼šå…¬å¸æœ‰å¤šå°æœåŠ¡å™¨ï¼Œæ¯å°éƒ½æœ‰é‡è¦æ–‡ä»¶éœ€è¦ç›‘æ§

```
åˆ†å¸ƒå¼åœºæ™¯ç¤ºä¾‹ï¼š
æœåŠ¡å™¨A (WebæœåŠ¡å™¨)    â†’ ç›‘æ§ç½‘ç«™æ–‡ä»¶å˜åŒ–
æœåŠ¡å™¨B (æ•°æ®åº“æœåŠ¡å™¨) â†’ ç›‘æ§æ•°æ®æ–‡ä»¶å˜åŒ–  
æœåŠ¡å™¨C (æ–‡ä»¶æœåŠ¡å™¨)   â†’ ç›‘æ§å…±äº«æ–‡ä»¶å˜åŒ–
æœåŠ¡å™¨D (å¤‡ä»½æœåŠ¡å™¨)   â†’ ç›‘æ§å¤‡ä»½å®Œæ•´æ€§

éœ€è¦é›†ä¸­ç®¡ç†è¿™äº›ç›‘æ§æ•°æ®ï¼
```

### 2.2 ä¸­å¿ƒåŒ–æ”¶é›†æ¶æ„


**ğŸ”¸ æ ¸å¿ƒç»„ä»¶**ï¼š
- **ç›‘æ§èŠ‚ç‚¹**ï¼šå„æœåŠ¡å™¨ä¸Šçš„inotifyç›‘æ§ç¨‹åº
- **æ•°æ®æ”¶é›†å™¨**ï¼šä¸­å¤®æ•°æ®æ”¶é›†æœåŠ¡
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šç¼“å†²å’Œä¼ è¾“ç›‘æ§æ•°æ®
- **åˆ†æå¼•æ“**ï¼šå¤„ç†å’Œåˆ†ææ”¶é›†çš„æ•°æ®

```bash
# ç›‘æ§èŠ‚ç‚¹è„šæœ¬ï¼ˆéƒ¨ç½²åœ¨å„æœåŠ¡å™¨ï¼‰
#!/bin/bash
NODE_ID=$(hostname)
COLLECTOR_URL="http://central-server:8080/events"

monitor_and_report() {
    inotifywait -m -r /important/files/ \
        -e modify,create,delete,move \
        --format '%w%f|%e|%T' \
        --timefmt '%Y-%m-%d %H:%M:%S' | \
    while IFS='|' read file event timestamp; do
        # æ„é€ JSONæ•°æ®
        json_data=$(cat <<EOF
{
    "node_id": "$NODE_ID",
    "file_path": "$file",
    "event_type": "$event",
    "timestamp": "$timestamp",
    "file_size": $(stat -f%z "$file" 2>/dev/null || echo 0)
}
EOF
)
        
        # å‘é€åˆ°ä¸­å¤®æ”¶é›†å™¨
        curl -X POST "$COLLECTOR_URL" \
            -H "Content-Type: application/json" \
            -d "$json_data" \
            --max-time 5 --retry 2
    done
}
```

### 2.3 é«˜å¯ç”¨ç›‘æ§é›†ç¾¤


```bash
# ç›‘æ§èŠ‚ç‚¹é«˜å¯ç”¨é…ç½®
setup_ha_monitoring() {
    # ä¸»æ”¶é›†å™¨å’Œå¤‡ä»½æ”¶é›†å™¨
    PRIMARY_COLLECTOR="http://collector1:8080/events"
    BACKUP_COLLECTOR="http://collector2:8080/events"
    
    send_event() {
        local data="$1"
        
        # é¦–å…ˆå°è¯•ä¸»æ”¶é›†å™¨
        if ! curl -X POST "$PRIMARY_COLLECTOR" -d "$data" --max-time 3; then
            echo "ä¸»æ”¶é›†å™¨ä¸å¯ç”¨ï¼Œåˆ‡æ¢åˆ°å¤‡ä»½æ”¶é›†å™¨"
            curl -X POST "$BACKUP_COLLECTOR" -d "$data" --max-time 3 || {
                echo "æ‰€æœ‰æ”¶é›†å™¨ä¸å¯ç”¨ï¼Œæ•°æ®å†™å…¥æœ¬åœ°é˜Ÿåˆ—"
                echo "$data" >> /tmp/monitoring_queue.json
            }
        fi
    }
}
```

---

## 3. ğŸŒ è¿œç¨‹æ–‡ä»¶ç³»ç»Ÿç›‘æ§


### 3.1 è¿œç¨‹ç›‘æ§çš„æŒ‘æˆ˜


**ä¸»è¦é—®é¢˜**ï¼š
- **ç½‘ç»œå»¶è¿Ÿ**ï¼šè¿œç¨‹è®¿é—®æ–‡ä»¶ç³»ç»Ÿæœ‰å»¶è¿Ÿ
- **è¿æ¥ç¨³å®šæ€§**ï¼šç½‘ç»œå¯èƒ½ä¸­æ–­
- **æƒé™ç®¡ç†**ï¼šè¿œç¨‹è®¿é—®æƒé™å¤æ‚
- **æ•°æ®åŒæ­¥**ï¼šæœ¬åœ°ç¼“å­˜ä¸è¿œç¨‹æ•°æ®ä¸€è‡´æ€§

### 3.2 SSHéš§é“ç›‘æ§æ–¹æ¡ˆ


**åŸç†**ï¼šé€šè¿‡SSHéš§é“åœ¨è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œç›‘æ§ï¼Œå°†ç»“æœä¼ å›æœ¬åœ°

```bash
#!/bin/bash
# è¿œç¨‹SSHç›‘æ§è„šæœ¬
remote_monitor() {
    local remote_host="$1"
    local remote_path="$2"
    local ssh_user="monitor"
    
    # åˆ›å»ºSSHéš§é“å¹¶æ‰§è¡Œè¿œç¨‹ç›‘æ§
    ssh -o ConnectTimeout=10 -o ServerAliveInterval=30 \
        "$ssh_user@$remote_host" "
        # è¿œç¨‹æ‰§è¡Œçš„ç›‘æ§è„šæœ¬
        inotifywait -m -r '$remote_path' \
            -e modify,create,delete \
            --format 'REMOTE:$remote_host|%w%f|%e|%T' \
            --timefmt '%Y-%m-%d %H:%M:%S' 2>/dev/null
    " | while read line; do
        # å¤„ç†è¿œç¨‹ç›‘æ§æ•°æ®
        process_remote_event "$line"
    done
}

process_remote_event() {
    local event_line="$1"
    echo "[$(date)] $event_line"
    
    # è§£æäº‹ä»¶æ•°æ®
    IFS='|' read -r prefix file event timestamp <<< "$event_line"
    
    # æ ¹æ®äº‹ä»¶ç±»å‹æ‰§è¡Œç›¸åº”æ“ä½œ
    case "$event" in
        "CREATE")
            echo "è¿œç¨‹æ–‡ä»¶åˆ›å»º: $file"
            ;;
        "MODIFY")  
            echo "è¿œç¨‹æ–‡ä»¶ä¿®æ”¹: $file"
            ;;
        "DELETE")
            echo "è¿œç¨‹æ–‡ä»¶åˆ é™¤: $file"
            ;;
    esac
}
```

### 3.3 NFS/CIFSç›‘æ§ç‰¹æ®Šå¤„ç†


**ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿç‰¹ç‚¹**ï¼šäº‹ä»¶å¯èƒ½æœ‰å»¶è¿Ÿæˆ–ä¸¢å¤±

```bash
# NFSæŒ‚è½½ç‚¹ç›‘æ§
monitor_nfs_mount() {
    local nfs_mount="/mnt/shared_nfs"
    
    # æ£€æŸ¥æŒ‚è½½ç‚¹çŠ¶æ€
    check_mount_status() {
        if ! mountpoint -q "$nfs_mount"; then
            echo "NFSæŒ‚è½½ç‚¹ä¸å¯ç”¨: $nfs_mount"
            return 1
        fi
        return 0
    }
    
    # NFSç‰¹æ®Šç›‘æ§ï¼ˆå¢åŠ è¶…æ—¶å¤„ç†ï¼‰
    while true; do
        if check_mount_status; then
            timeout 300 inotifywait -m "$nfs_mount" \
                -e create,delete,modify \
                --format '%w%f %e %T' \
                --timefmt '%Y-%m-%d %H:%M:%S' | \
            while read file event timestamp; do
                echo "[NFS] $timestamp: $file - $event"
                
                # NFSå»¶è¿Ÿè¡¥å¿ - å»¶è¿Ÿ1ç§’åå†æ¬¡æ£€æŸ¥æ–‡ä»¶çŠ¶æ€
                sleep 1
                if [[ "$event" == "CREATE" || "$event" == "MODIFY" ]]; then
                    if [[ -f "$file" ]]; then
                        echo "[NFS] æ–‡ä»¶ç¡®è®¤å­˜åœ¨: $file"
                    else
                        echo "[NFS] æ–‡ä»¶å¯èƒ½æœªåŒæ­¥: $file"
                    fi
                fi
            done
        else
            echo "[NFS] æŒ‚è½½ç‚¹æ£€æŸ¥å¤±è´¥ï¼Œç­‰å¾…5ç§’åé‡è¯•"
            sleep 5
        fi
    done
}
```

---

## 4. ğŸ³ å®¹å™¨å†…æ–‡ä»¶ç›‘æ§


### 4.1 å®¹å™¨ç›‘æ§çš„ç‰¹æ®Šæ€§


**å®¹å™¨ç¯å¢ƒç‰¹ç‚¹**ï¼š
- **æ–‡ä»¶ç³»ç»Ÿå±‚çº§å¤æ‚**ï¼šæœ‰å¤šå±‚è”åˆæ–‡ä»¶ç³»ç»Ÿ
- **ç”Ÿå‘½å‘¨æœŸçŸ­æš‚**ï¼šå®¹å™¨å¯èƒ½éšæ—¶é‡å¯
- **èµ„æºé™åˆ¶**ï¼šCPUå’Œå†…å­˜èµ„æºæœ‰é™åˆ¶
- **æƒé™éš”ç¦»**ï¼šå®¹å™¨å†…æƒé™ä¸å®¿ä¸»æœºä¸åŒ

```
Dockeræ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨æ–‡ä»¶å±‚        â”‚ â† åº”ç”¨ç¨‹åºæ–‡ä»¶
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å¯å†™å®¹å™¨å±‚        â”‚ â† è¿è¡Œæ—¶ä¿®æ”¹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   é•œåƒå±‚(åªè¯»)      â”‚ â† åŸºç¡€é•œåƒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å®¹å™¨å†…ç›‘æ§å®ç°


```bash
#!/bin/bash
# å®¹å™¨å†…ç›‘æ§è„šæœ¬ï¼ˆåœ¨å®¹å™¨å†…è¿è¡Œï¼‰
container_file_monitor() {
    # è·å–å®¹å™¨ä¿¡æ¯
    CONTAINER_ID=$(cat /proc/self/cgroup | grep docker | head -1 | sed 's/.*\///' | cut -c1-12)
    HOSTNAME=$(hostname)
    
    echo "å¼€å§‹ç›‘æ§å®¹å™¨ $CONTAINER_ID ($HOSTNAME)"
    
    # ç›‘æ§åº”ç”¨å…³é”®ç›®å½•
    monitor_dirs=(
        "/app/data"        # åº”ç”¨æ•°æ®ç›®å½•
        "/app/logs"        # æ—¥å¿—ç›®å½•  
        "/app/config"      # é…ç½®ç›®å½•
    )
    
    for dir in "${monitor_dirs[@]}"; do
        if [[ -d "$dir" ]]; then
            echo "å¯åŠ¨ç›‘æ§: $dir"
            inotifywait -m -r "$dir" \
                -e modify,create,delete,move \
                --format "CONTAINER:$CONTAINER_ID|%w%f|%e|%T" \
                --timefmt '%Y-%m-%d %H:%M:%S' &
        fi
    done
    
    # ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡
    wait
}
```

### 4.3 å®¿ä¸»æœºç›‘æ§å®¹å™¨æ–‡ä»¶


**ä»å®¿ä¸»æœºç›‘æ§å®¹å™¨å†…çš„æ–‡ä»¶å˜åŒ–**ï¼š

```bash
# å®¿ä¸»æœºç›‘æ§å®¹å™¨è„šæœ¬
monitor_container_from_host() {
    local container_name="$1"
    
    # è·å–å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿè·¯å¾„
    container_root=$(docker inspect "$container_name" | jq -r '.[0].GraphDriver.Data.MergedDir')
    
    if [[ -z "$container_root" || "$container_root" == "null" ]]; then
        echo "æ— æ³•è·å–å®¹å™¨ $container_name çš„æ–‡ä»¶ç³»ç»Ÿè·¯å¾„"
        return 1
    fi
    
    echo "ç›‘æ§å®¹å™¨ $container_name çš„æ–‡ä»¶ç³»ç»Ÿ: $container_root"
    
    # ç›‘æ§å®¹å™¨çš„å…³é”®ç›®å½•
    inotifywait -m -r "$container_root/app" \
        -e modify,create,delete \
        --format "HOST->CONTAINER:$container_name|%w%f|%e|%T" \
        --timefmt '%Y-%m-%d %H:%M:%S' | \
    while read event_line; do
        echo "[$(date)] $event_line"
        
        # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å‘Šè­¦é€»è¾‘
        if [[ "$event_line" =~ DELETE ]]; then
            echo "è­¦å‘Š: å®¹å™¨å†…æ–‡ä»¶è¢«åˆ é™¤!"
        fi
    done
}
```

---

## 5. ğŸŒ ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿäº‹ä»¶å¤„ç†


### 5.1 ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿçš„ç›‘æ§æŒ‘æˆ˜


**ä¸»è¦é—®é¢˜**ï¼š
- **äº‹ä»¶å»¶è¿Ÿ**ï¼šç½‘ç»œä¼ è¾“å¯¼è‡´äº‹ä»¶å»¶è¿Ÿ
- **äº‹ä»¶ä¸¢å¤±**ï¼šç½‘ç»œä¸ç¨³å®šå¯èƒ½ä¸¢å¤±äº‹ä»¶
- **ç¼“å­˜æœºåˆ¶**ï¼šå®¢æˆ·ç«¯ç¼“å­˜å½±å“äº‹ä»¶è§¦å‘
- **å¤šå®¢æˆ·ç«¯**ï¼šå¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è®¿é—®åŒä¸€æ–‡ä»¶

### 5.2 äº‹ä»¶å»é‡å’Œå»¶è¿Ÿå¤„ç†


```bash
#!/bin/bash
# ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿç›‘æ§ - å¸¦å»é‡å’Œå»¶è¿Ÿå¤„ç†
declare -A event_cache
declare -A event_timestamps

nfs_event_processor() {
    local file="$1"
    local event="$2"
    local timestamp="$3"
    
    # ç”Ÿæˆäº‹ä»¶å”¯ä¸€æ ‡è¯†
    local event_key="${file}_${event}"
    local current_time=$(date +%s)
    
    # æ£€æŸ¥æ˜¯å¦æ˜¯é‡å¤äº‹ä»¶ï¼ˆ5ç§’å†…çš„ç›¸åŒäº‹ä»¶è®¤ä¸ºæ˜¯é‡å¤ï¼‰
    if [[ -n "${event_timestamps[$event_key]}" ]]; then
        local time_diff=$((current_time - ${event_timestamps[$event_key]}))
        if [[ $time_diff -lt 5 ]]; then
            echo "[DUPLICATE] å¿½ç•¥é‡å¤äº‹ä»¶: $event_key"
            return
        fi
    fi
    
    # æ›´æ–°äº‹ä»¶æ—¶é—´æˆ³
    event_timestamps[$event_key]=$current_time
    
    echo "[NFS] å¤„ç†äº‹ä»¶: $file - $event - $timestamp"
    
    # é’ˆå¯¹ä¸åŒäº‹ä»¶ç±»å‹çš„ç‰¹æ®Šå¤„ç†
    case "$event" in
        "MODIFY")
            # ä¿®æ”¹äº‹ä»¶å»¶è¿Ÿæ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§
            sleep 2
            check_file_integrity "$file"
            ;;
        "CREATE")
            # åˆ›å»ºäº‹ä»¶ç­‰å¾…æ–‡ä»¶å†™å…¥å®Œæˆ
            wait_for_file_stable "$file"
            ;;
        "DELETE")
            # åˆ é™¤äº‹ä»¶ç«‹å³å¤„ç†
            handle_file_deletion "$file"
            ;;
    esac
}

# ç­‰å¾…æ–‡ä»¶ç¨³å®šï¼ˆå†™å…¥å®Œæˆï¼‰
wait_for_file_stable() {
    local file="$1"
    local last_size=0
    local stable_count=0
    
    while [[ $stable_count -lt 3 ]]; do
        if [[ -f "$file" ]]; then
            local current_size=$(stat -f%z "$file" 2>/dev/null || echo 0)
            if [[ $current_size -eq $last_size ]]; then
                ((stable_count++))
            else
                stable_count=0
                last_size=$current_size
            fi
        else
            echo "æ–‡ä»¶å·²ä¸å­˜åœ¨: $file"
            return 1
        fi
        sleep 1
    done
    
    echo "æ–‡ä»¶å†™å…¥ç¨³å®š: $file (å¤§å°: $last_size å­—èŠ‚)"
    return 0
}
```

### 5.3 SMB/CIFSç›‘æ§ä¼˜åŒ–


```bash
# SMBå…±äº«ç›‘æ§ä¼˜åŒ–
monitor_smb_share() {
    local smb_mount="/mnt/smb_share"
    local max_retries=3
    local retry_count=0
    
    while [[ $retry_count -lt $max_retries ]]; do
        if mountpoint -q "$smb_mount"; then
            echo "SMBæŒ‚è½½ç‚¹æ­£å¸¸: $smb_mount"
            break
        else
            echo "SMBæŒ‚è½½ç‚¹å¼‚å¸¸ï¼Œå°è¯•é‡æ–°æŒ‚è½½ (å°è¯• $((retry_count + 1))/$max_retries)"
            mount "$smb_mount" 2>/dev/null
            ((retry_count++))
            sleep 5
        fi
    done
    
    if [[ $retry_count -eq $max_retries ]]; then
        echo "SMBæŒ‚è½½å¤±è´¥ï¼Œæ— æ³•ç›‘æ§"
        return 1
    fi
    
    # SMBç›‘æ§ï¼ˆå¢åŠ é”™è¯¯æ¢å¤ï¼‰
    while true; do
        inotifywait -m "$smb_mount" \
            -e modify,create,delete,move \
            --format '%w%f %e %T' \
            --timefmt '%Y-%m-%d %H:%M:%S' \
            --timeout 60 | \
        while read file event timestamp; do
            if [[ -n "$file" ]]; then
                echo "[SMB] $timestamp: $file - $event"
                
                # SMBç‰¹æ®Šå¤„ç†ï¼šéªŒè¯æ–‡ä»¶æ˜¯å¦çœŸå®å­˜åœ¨
                if [[ "$event" == "CREATE" ]]; then
                    sleep 1  # ç­‰å¾…SMBç¼“å­˜æ›´æ–°
                    if [[ -e "$file" ]]; then
                        echo "[SMB] æ–‡ä»¶åˆ›å»ºç¡®è®¤: $file"
                    else
                        echo "[SMB] æ–‡ä»¶åˆ›å»ºå¯èƒ½å¤±è´¥: $file"
                    fi
                fi
            fi
        done
        
        # ç›‘æ§è¿›ç¨‹å¼‚å¸¸é€€å‡ºæ—¶é‡å¯
        echo "[SMB] ç›‘æ§è¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼Œ5ç§’åé‡å¯"
        sleep 5
    done
}
```

---

## 6. ğŸ“Š ç›‘æ§æ•°æ®èšåˆåˆ†æ


### 6.1 æ•°æ®èšåˆçš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦èšåˆ**ï¼š
- **æ•°æ®é‡å·¨å¤§**ï¼šæ¯ç§’å¯èƒ½äº§ç”Ÿä¸Šåƒä¸ªæ–‡ä»¶äº‹ä»¶
- **å™ªéŸ³è¿‡æ»¤**ï¼šè¿‡æ»¤æ‰æ— æ„ä¹‰çš„ä¸´æ—¶æ–‡ä»¶æ“ä½œ
- **è¶‹åŠ¿åˆ†æ**ï¼šäº†è§£æ–‡ä»¶ä½¿ç”¨æ¨¡å¼å’Œè¶‹åŠ¿
- **å¼‚å¸¸æ£€æµ‹**ï¼šå‘ç°å¼‚å¸¸çš„æ–‡ä»¶æ“ä½œè¡Œä¸º

### 6.2 å®æ—¶æ•°æ®èšåˆè„šæœ¬


```bash
#!/bin/bash
# æ–‡ä»¶ç›‘æ§æ•°æ®èšåˆåˆ†æå™¨
declare -A file_stats
declare -A user_stats  
declare -A hourly_stats

data_aggregator() {
    local data_file="/tmp/file_monitor_raw.log"
    local output_file="/tmp/file_monitor_summary.log"
    
    # è¯»å–åŸå§‹ç›‘æ§æ•°æ®å¹¶èšåˆ
    tail -f "$data_file" | while read line; do
        # è§£æç›‘æ§æ•°æ®è¡Œ
        if [[ $line =~ (.+)\|(.+)\|(.+)\|(.+) ]]; then
            local file_path="${BASH_REMATCH[2]}"
            local event_type="${BASH_REMATCH[3]}"
            local timestamp="${BASH_REMATCH[4]}"
            local hour=$(date -d "$timestamp" +'%Y-%m-%d %H' 2>/dev/null || date +'%Y-%m-%d %H')
            
            # æ›´æ–°ç»Ÿè®¡æ•°æ®
            ((file_stats["$file_path.$event_type"]++))
            ((hourly_stats["$hour.$event_type"]++))
            
            # æ¯100ä¸ªäº‹ä»¶è¾“å‡ºä¸€æ¬¡èšåˆæŠ¥å‘Š
            local total_events=0
            for key in "${!file_stats[@]}"; do
                ((total_events += ${file_stats[$key]}))
            done
            
            if [[ $((total_events % 100)) -eq 0 ]]; then
                generate_summary_report
            fi
        fi
    done
}

generate_summary_report() {
    echo "=== æ–‡ä»¶ç›‘æ§èšåˆæŠ¥å‘Š $(date) ===" > /tmp/monitoring_summary.txt
    echo "" >> /tmp/monitoring_summary.txt
    
    # çƒ­ç‚¹æ–‡ä»¶åˆ†æ
    echo "ğŸ”¥ æœ€æ´»è·ƒçš„æ–‡ä»¶:" >> /tmp/monitoring_summary.txt
    for key in "${!file_stats[@]}"; do
        local file=$(echo "$key" | cut -d'.' -f1)
        local event=$(echo "$key" | cut -d'.' -f2)
        echo "  $file ($event): ${file_stats[$key]} æ¬¡" >> /tmp/monitoring_summary.txt
    done | sort -k3 -nr | head -10 >> /tmp/monitoring_summary.txt
    
    echo "" >> /tmp/monitoring_summary.txt
    
    # å°æ—¶ç»Ÿè®¡
    echo "ğŸ“ˆ æ¯å°æ—¶äº‹ä»¶ç»Ÿè®¡:" >> /tmp/monitoring_summary.txt
    for key in "${!hourly_stats[@]}"; do
        local hour=$(echo "$key" | cut -d'.' -f1-2)
        local event=$(echo "$key" | cut -d'.' -f3)
        echo "  $hour ($event): ${hourly_stats[$key]} æ¬¡" >> /tmp/monitoring_summary.txt
    done | sort >> /tmp/monitoring_summary.txt
    
    echo "æŠ¥å‘Šå·²ç”Ÿæˆ: /tmp/monitoring_summary.txt"
}
```

### 6.3 å¼‚å¸¸æ¨¡å¼æ£€æµ‹


```bash
# å¼‚å¸¸æ£€æµ‹åˆ†æå™¨
anomaly_detector() {
    local threshold_file_ops=100    # å•ä¸ªæ–‡ä»¶æ“ä½œæ¬¡æ•°é˜ˆå€¼
    local threshold_time_window=60  # æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
    
    declare -A recent_events
    declare -A event_times
    
    while read event_line; do
        local current_time=$(date +%s)
        local file_path=$(echo "$event_line" | cut -d'|' -f2)
        local event_type=$(echo "$event_line" | cut -d'|' -f3)
        
        # è®°å½•äº‹ä»¶
        local event_key="${file_path}_${event_type}"
        recent_events[$event_key]=$(( ${recent_events[$event_key]:-0} + 1 ))
        event_times[$event_key]="$current_time"
        
        # æ¸…ç†è¿‡æœŸäº‹ä»¶ï¼ˆè¶…è¿‡æ—¶é—´çª—å£ï¼‰
        for key in "${!event_times[@]}"; do
            local event_time=${event_times[$key]}
            if [[ $((current_time - event_time)) -gt $threshold_time_window ]]; then
                unset recent_events[$key]
                unset event_times[$key]
            fi
        done
        
        # æ£€æµ‹å¼‚å¸¸
        if [[ ${recent_events[$event_key]} -gt $threshold_file_ops ]]; then
            echo "ğŸš¨ å¼‚å¸¸æ£€æµ‹: $file_path åœ¨ ${threshold_time_window}ç§’ å†…å‘ç”Ÿ ${recent_events[$event_key]} æ¬¡ $event_type æ“ä½œ"
            send_anomaly_alert "$file_path" "$event_type" "${recent_events[$event_key]}"
        fi
    done
}

send_anomaly_alert() {
    local file_path="$1"
    local event_type="$2" 
    local event_count="$3"
    
    # å‘é€å‘Šè­¦é‚®ä»¶æˆ–æ¶ˆæ¯
    local alert_msg="å¼‚å¸¸æ–‡ä»¶æ´»åŠ¨æ£€æµ‹
æ–‡ä»¶: $file_path
äº‹ä»¶ç±»å‹: $event_type  
äº‹ä»¶æ¬¡æ•°: $event_count
æ—¶é—´: $(date)
æœåŠ¡å™¨: $(hostname)"
    
    echo "$alert_msg" | mail -s "æ–‡ä»¶ç›‘æ§å¼‚å¸¸å‘Šè­¦" admin@company.com
}
```

---

## 7. ğŸ“º å®æ—¶ç›‘æ§Dashboard


### 7.1 Web Dashboardæ¶æ„


**Dashboardç»„ä»¶**ï¼š
- **æ•°æ®æ¥æ”¶æœåŠ¡**ï¼šæ¥æ”¶ç›‘æ§æ•°æ®
- **WebSocketæœåŠ¡**ï¼šå®æ—¶æ¨é€ç»™å‰ç«¯
- **å¯è§†åŒ–ç•Œé¢**ï¼šå›¾è¡¨å±•ç¤ºç›‘æ§çŠ¶æ€
- **å‘Šè­¦é¢æ¿**ï¼šæ˜¾ç¤ºå¼‚å¸¸å’Œå‘Šè­¦ä¿¡æ¯

### 7.2 ç®€å•Dashboardåç«¯


```bash
#!/bin/bash
# ç®€å•çš„ç›‘æ§Dashboardæ•°æ®æœåŠ¡
DASHBOARD_PORT=8888
WEBSOCKET_PORT=8889

# å¯åŠ¨HTTPæœåŠ¡æä¾›ç›‘æ§æ•°æ®API
start_dashboard_api() {
    while true; do
        # ç­‰å¾…HTTPè¯·æ±‚
        request=$(nc -l -p $DASHBOARD_PORT)
        
        if [[ $request =~ "GET /api/stats" ]]; then
            # è¿”å›JSONæ ¼å¼çš„ç»Ÿè®¡æ•°æ®
            response="HTTP/1.1 200 OK
Content-Type: application/json
Access-Control-Allow-Origin: *

{
    \"timestamp\": \"$(date -Iseconds)\",
    \"server\": \"$(hostname)\",
    \"active_monitors\": $(pgrep -c inotifywait),
    \"total_events_today\": $(wc -l < /tmp/file_monitor_raw.log 2>/dev/null || echo 0),
    \"system_load\": \"$(uptime | awk -F'load average:' '{print $2}' | trim)\",
    \"disk_usage\": \"$(df -h / | awk 'NR==2 {print $5}')\",
    \"memory_usage\": \"$(free | awk 'NR==2{printf \"%.2f%%\", $3*100/$2}')\",
    \"top_files\": [$(get_top_active_files)]
}"
            echo "$response"
        else
            # è¿”å›HTMLé¡µé¢
            cat << 'EOF'
HTTP/1.1 200 OK
Content-Type: text/html

<!DOCTYPE html>
<html>
<head>
    <title>æ–‡ä»¶ç›‘æ§Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .metrics { display: flex; gap: 20px; margin: 20px 0; }
        .metric-card { border: 1px solid #ddd; padding: 20px; border-radius: 5px; }
        #eventChart { max-width: 800px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>ğŸ” æ–‡ä»¶ç›‘æ§Dashboard</h1>
    
    <div class="metrics">
        <div class="metric-card">
            <h3>æ´»è·ƒç›‘æ§æ•°</h3>
            <div id="active-monitors">-</div>
        </div>
        <div class="metric-card">
            <h3>ä»Šæ—¥äº‹ä»¶æ€»æ•°</h3>
            <div id="total-events">-</div>
        </div>
        <div class="metric-card">
            <h3>ç³»ç»Ÿè´Ÿè½½</h3>
            <div id="system-load">-</div>
        </div>
    </div>
    
    <div id="eventChart">
        <canvas id="chart"></canvas>
    </div>
    
    <div>
        <h3>ğŸ“Š å®æ—¶äº‹ä»¶æµ</h3>
        <div id="event-stream" style="border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px;"></div>
    </div>
    
    <script>
        // å®šæœŸæ›´æ–°æ•°æ®
        function updateDashboard() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('active-monitors').textContent = data.active_monitors;
                    document.getElementById('total-events').textContent = data.total_events_today;
                    document.getElementById('system-load').textContent = data.system_load;
                });
        }
        
        // æ¯5ç§’æ›´æ–°ä¸€æ¬¡
        setInterval(updateDashboard, 5000);
        updateDashboard();
        
        // WebSocketè¿æ¥å®æ—¶äº‹ä»¶æµ
        const ws = new WebSocket('ws://localhost:8889');
        ws.onmessage = function(event) {
            const eventStream = document.getElementById('event-stream');
            eventStream.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + event.data + '</div>';
            eventStream.scrollTop = eventStream.scrollHeight;
        };
    </script>
</body>
</html>
EOF
        fi
    done
}

get_top_active_files() {
    # è·å–æœ€æ´»è·ƒçš„æ–‡ä»¶åˆ—è¡¨
    if [[ -f /tmp/file_monitor_raw.log ]]; then
        tail -1000 /tmp/file_monitor_raw.log | \
        cut -d'|' -f2 | \
        sort | uniq -c | sort -nr | head -5 | \
        while read count file; do
            echo "\"$file ($count)\","
        done | sed '$ s/,$//'
    fi
}
```

### 7.3 å®æ—¶äº‹ä»¶WebSocketæ¨é€


```bash
# WebSocketäº‹ä»¶æ¨é€æœåŠ¡
start_websocket_server() {
    local named_pipe="/tmp/websocket_pipe"
    mkfifo "$named_pipe" 2>/dev/null || true
    
    # ç›‘æ§æ•°æ®æµå¹¶æ¨é€åˆ°WebSocket
    tail -f /tmp/file_monitor_raw.log | while read event; do
        echo "$event" > "$named_pipe" &
    done &
    
    # ç®€å•çš„WebSocketæœåŠ¡å™¨ï¼ˆéœ€è¦å®‰è£…websocketdï¼‰
    if command -v websocketd >/dev/null 2>&1; then
        websocketd --port=8889 cat "$named_pipe"
    else
        echo "éœ€è¦å®‰è£…websocketdå·¥å…·æ¥æ”¯æŒWebSocket"
        echo "ä¸‹è½½åœ°å€: https://github.com/joewalnes/websocketd"
    fi
}
```

---

## 8. ğŸš¨ ç›‘æ§å‘Šè­¦é›†æˆæ–¹æ¡ˆ


### 8.1 å¤šçº§å‘Šè­¦ç­–ç•¥


**å‘Šè­¦çº§åˆ«è®¾è®¡**ï¼š
- **INFO**ï¼šæ™®é€šä¿¡æ¯ï¼Œä»…è®°å½•æ—¥å¿—
- **WARNING**ï¼šéœ€è¦æ³¨æ„ï¼Œå‘é€é‚®ä»¶é€šçŸ¥  
- **CRITICAL**ï¼šä¸¥é‡é—®é¢˜ï¼Œç«‹å³çŸ­ä¿¡+é‚®ä»¶+é’‰é’‰
- **EMERGENCY**ï¼šç´§æ€¥æƒ…å†µï¼Œç”µè¯å‘Šè­¦

### 8.2 å‘Šè­¦è§„åˆ™å¼•æ“


```bash
#!/bin/bash
# å‘Šè­¦è§„åˆ™å¼•æ“
declare -A alert_rules
declare -A alert_cooldowns

# å®šä¹‰å‘Šè­¦è§„åˆ™
setup_alert_rules() {
    # è§„åˆ™æ ¼å¼ï¼šäº‹ä»¶ç±»å‹:æ–‡ä»¶è·¯å¾„æ¨¡å¼:é˜ˆå€¼:æ—¶é—´çª—å£:å‘Šè­¦çº§åˆ«
    alert_rules["config_change"]="MODIFY:/etc/*:1:0:CRITICAL"
    alert_rules["log_deletion"]="DELETE:/var/log/*:1:0:WARNING"  
    alert_rules["mass_deletion"]="DELETE:*:10:60:EMERGENCY"
    alert_rules["suspicious_access"]="ACCESS:/home/*/.ssh/*:1:0:WARNING"
    alert_rules["backup_failure"]="DELETE:/backup/*:1:0:CRITICAL"
}

# å‘Šè­¦è§„åˆ™åŒ¹é…å™¨
check_alert_rules() {
    local file_path="$1"
    local event_type="$2" 
    local current_time=$(date +%s)
    
    for rule_name in "${!alert_rules[@]}"; do
        IFS=':' read -r rule_event rule_pattern rule_threshold rule_window rule_level <<< "${alert_rules[$rule_name]}"
        
        # æ£€æŸ¥äº‹ä»¶ç±»å‹åŒ¹é…
        if [[ "$event_type" == "$rule_event" ]]; then
            # æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ¨¡å¼åŒ¹é…
            if [[ "$file_path" == $rule_pattern ]]; then
                # æ£€æŸ¥å‘Šè­¦å†·å´æœŸ
                local cooldown_key="${rule_name}_${file_path}"
                local last_alert_time=${alert_cooldowns[$cooldown_key]:-0}
                
                if [[ $((current_time - last_alert_time)) -gt 300 ]]; then  # 5åˆ†é’Ÿå†·å´æœŸ
                    trigger_alert "$rule_name" "$file_path" "$event_type" "$rule_level"
                    alert_cooldowns[$cooldown_key]=$current_time
                fi
            fi
        fi
    done
}

# è§¦å‘å‘Šè­¦
trigger_alert() {
    local rule_name="$1"
    local file_path="$2"
    local event_type="$3"
    local alert_level="$4"
    
    local alert_message="[${alert_level}] æ–‡ä»¶ç›‘æ§å‘Šè­¦
è§„åˆ™: $rule_name
æ–‡ä»¶: $file_path  
äº‹ä»¶: $event_type
æ—¶é—´: $(date)
æœåŠ¡å™¨: $(hostname)"
    
    echo "[ALERT] $alert_message"
    
    # æ ¹æ®å‘Šè­¦çº§åˆ«é€‰æ‹©é€šçŸ¥æ–¹å¼
    case "$alert_level" in
        "INFO")
            # ä»…è®°å½•æ—¥å¿—
            echo "$alert_message" >> /var/log/file_monitor_alerts.log
            ;;
        "WARNING")
            # é‚®ä»¶é€šçŸ¥
            send_email_alert "$alert_message"
            ;;
        "CRITICAL")
            # é‚®ä»¶+çŸ­ä¿¡é€šçŸ¥
            send_email_alert "$alert_message"
            send_sms_alert "$alert_message"
            ;;
        "EMERGENCY")
            # å…¨æ–¹ä½é€šçŸ¥
            send_email_alert "$alert_message"
            send_sms_alert "$alert_message"
            send_dingtalk_alert "$alert_message"
            # å¦‚æœé…ç½®äº†ç”µè¯å‘Šè­¦ï¼Œä¹Ÿå¯ä»¥è§¦å‘
            ;;
    esac
}
```

### 8.3 å¤šæ¸ é“é€šçŸ¥å®ç°


```bash
# é‚®ä»¶å‘Šè­¦
send_email_alert() {
    local message="$1"
    local subject="æ–‡ä»¶ç›‘æ§å‘Šè­¦ - $(hostname)"
    
    echo "$message" | mail -s "$subject" alert@company.com
}

# çŸ­ä¿¡å‘Šè­¦ï¼ˆä½¿ç”¨é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡ç¤ºä¾‹ï¼‰
send_sms_alert() {
    local message="$1"
    local phone_numbers="13800138000,13800138001"  # ç®¡ç†å‘˜æ‰‹æœºå·
    
    # è°ƒç”¨çŸ­ä¿¡APIï¼ˆéœ€è¦é…ç½®APIå¯†é’¥ï¼‰
    curl -X POST "https://dysmsapi.aliyuncs.com/" \
        -H "Content-Type: application/json" \
        -d '{
            "PhoneNumbers": "'"$phone_numbers"'",
            "SignName": "æœåŠ¡å™¨ç›‘æ§",
            "TemplateCode": "SMS_123456789",
            "TemplateParam": "{\"content\":\"'"$(echo "$message" | tr '\n' ' ')"'\"}"
        }'
}

# é’‰é’‰ç¾¤æœºå™¨äººå‘Šè­¦
send_dingtalk_alert() {
    local message="$1"
    local webhook_url="https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN"
    
    local json_message=$(cat <<EOF
{
    "msgtype": "text",
    "text": {
        "content": "ğŸš¨ æ–‡ä»¶ç›‘æ§å‘Šè­¦\n\n$message"
    },
    "at": {
        "isAtAll": true
    }
}
EOF
)
    
    curl -X POST "$webhook_url" \
        -H "Content-Type: application/json" \
        -d "$json_message"
}

# Slackå‘Šè­¦ï¼ˆå¦‚æœä½¿ç”¨Slackï¼‰
send_slack_alert() {
    local message="$1"
    local webhook_url="YOUR_SLACK_WEBHOOK_URL"
    
    curl -X POST "$webhook_url" \
        -H "Content-Type: application/json" \
        -d '{
            "text": "ğŸš¨ æ–‡ä»¶ç›‘æ§å‘Šè­¦",
            "attachments": [
                {
                    "color": "danger",
                    "fields": [
                        {
                            "title": "å‘Šè­¦è¯¦æƒ…",
                            "value": "'"$message"'",
                            "short": false
                        }
                    ]
                }
            ]
        }'
}
```

### 8.4 å‘Šè­¦ç®¡ç†è„šæœ¬


```bash
#!/bin/bash
# å‘Šè­¦ç®¡ç†ä¸»æ§åˆ¶å™¨
main_alert_controller() {
    setup_alert_rules
    
    # ç›‘æ§æ•°æ®æµå¹¶å¤„ç†å‘Šè­¦
    tail -f /tmp/file_monitor_raw.log | while read event_line; do
        if [[ $event_line =~ (.+)\|(.+)\|(.+)\|(.+) ]]; then
            local node_id="${BASH_REMATCH[1]}"
            local file_path="${BASH_REMATCH[2]}"
            local event_type="${BASH_REMATCH[3]}"
            local timestamp="${BASH_REMATCH[4]}"
            
            # æ£€æŸ¥æ˜¯å¦åŒ¹é…å‘Šè­¦è§„åˆ™
            check_alert_rules "$file_path" "$event_type"
            
            # ç‰¹æ®Šåœºæ™¯æ£€æŸ¥
            check_special_scenarios "$file_path" "$event_type" "$timestamp"
        fi
    done
}

# ç‰¹æ®Šåœºæ™¯æ£€æŸ¥
check_special_scenarios() {
    local file_path="$1"
    local event_type="$2"
    local timestamp="$3"
    
    # æ·±å¤œå¼‚å¸¸æ“ä½œæ£€æŸ¥
    local hour=$(date -d "$timestamp" +'%H' 2>/dev/null || date +'%H')
    if [[ $hour -ge 22 || $hour -le 6 ]]; then
        if [[ "$event_type" == "DELETE" ]]; then
            trigger_alert "night_deletion" "$file_path" "$event_type" "WARNING"
        fi
    fi
    
    # ç³»ç»Ÿå…³é”®æ–‡ä»¶æ£€æŸ¥
    case "$file_path" in
        /etc/passwd|/etc/shadow|/etc/sudoers)
            trigger_alert "critical_system_file" "$file_path" "$event_type" "EMERGENCY"
            ;;
        /root/.ssh/*)
            trigger_alert "ssh_key_change" "$file_path" "$event_type" "CRITICAL"
            ;;
    esac
    
    # å¤§é‡æ–‡ä»¶æ“ä½œæ£€æŸ¥ï¼ˆå¯èƒ½çš„æ”»å‡»è¡Œä¸ºï¼‰
    check_bulk_operations "$file_path" "$event_type"
}

# å¯åŠ¨å‘Šè­¦ç³»ç»Ÿ
echo "å¯åŠ¨æ–‡ä»¶ç›‘æ§å‘Šè­¦ç³»ç»Ÿ..."
main_alert_controller &
echo "å‘Šè­¦ç³»ç»Ÿå·²å¯åŠ¨ï¼ŒPID: $!"
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¤šå±‚çº§ç›‘æ§ï¼šé’ˆå¯¹ä¸åŒç›®å½•å±‚çº§è®¾è®¡ä¸åŒç›‘æ§ç­–ç•¥
ğŸ”¸ åˆ†å¸ƒå¼ç›‘æ§ï¼šå¤šæœåŠ¡å™¨ç¯å¢ƒä¸‹çš„ç»Ÿä¸€ç›‘æ§ç®¡ç†  
ğŸ”¸ è¿œç¨‹ç›‘æ§ï¼šé€šè¿‡SSHéš§é“ç­‰æ–¹å¼ç›‘æ§è¿œç¨‹æ–‡ä»¶ç³»ç»Ÿ
ğŸ”¸ å®¹å™¨ç›‘æ§ï¼šç†è§£å®¹å™¨æ–‡ä»¶ç³»ç»Ÿç‰¹ç‚¹ï¼Œå®ç°æœ‰æ•ˆç›‘æ§
ğŸ”¸ ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼šå¤„ç†NFS/SMBç­‰ç½‘ç»œå­˜å‚¨çš„ç‰¹æ®Šé—®é¢˜
ğŸ”¸ æ•°æ®èšåˆï¼šå¯¹å¤§é‡ç›‘æ§æ•°æ®è¿›è¡Œå®æ—¶åˆ†æå’Œæ±‡æ€»
ğŸ”¸ å¯è§†åŒ–Dashboardï¼šæä¾›ç›´è§‚çš„ç›‘æ§çŠ¶æ€å±•ç¤º
ğŸ”¸ æ™ºèƒ½å‘Šè­¦ï¼šåŸºäºè§„åˆ™å¼•æ“çš„å¤šçº§å‘Šè­¦é€šçŸ¥æœºåˆ¶
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç›‘æ§æ¶æ„è®¾è®¡åŸåˆ™**
```
åˆ†å±‚è®¾è®¡ï¼š
- ä¸åŒå±‚çº§ä½¿ç”¨ä¸åŒç›‘æ§ç²’åº¦
- é¿å…èµ„æºæµªè´¹å’Œä¿¡æ¯è¿‡è½½
- é‡ç‚¹ç›‘æ§æ ¸å¿ƒä¸šåŠ¡ç›®å½•

æ‰©å±•æ€§è€ƒè™‘ï¼š
- æ”¯æŒæ–°å¢ç›‘æ§èŠ‚ç‚¹
- é…ç½®åŒ–çš„ç›‘æ§è§„åˆ™
- æ¨¡å—åŒ–çš„åŠŸèƒ½ç»„ä»¶
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```
èµ„æºæ§åˆ¶ï¼š
- é™åˆ¶ç›‘æ§è¿›ç¨‹æ•°é‡
- ä¼˜åŒ–ç›‘æ§èŒƒå›´ï¼Œæ’é™¤æ— ç”¨ç›®å½•
- ä½¿ç”¨äº‹ä»¶è¿‡æ»¤å‡å°‘å™ªéŸ³

ç½‘ç»œä¼˜åŒ–ï¼š
- æœ¬åœ°ç¼“å†²è¿œç¨‹äº‹ä»¶
- æ‰¹é‡ä¼ è¾“å‡å°‘ç½‘ç»œå¼€é”€
- æ–­çº¿é‡è¿æœºåˆ¶
```

**ğŸ”¹ å¯é æ€§ä¿éšœ**
```
é«˜å¯ç”¨è®¾è®¡ï¼š
- å¤šä¸ªæ”¶é›†å™¨èŠ‚ç‚¹
- ç›‘æ§è¿›ç¨‹è‡ªåŠ¨é‡å¯
- æ•°æ®æœ¬åœ°ç¼“å­˜å¤‡ä»½

å¼‚å¸¸å¤„ç†ï¼š
- ç½‘ç»œä¸­æ–­æ¢å¤
- æ–‡ä»¶ç³»ç»Ÿå¸è½½å¤„ç†
- ç£ç›˜ç©ºé—´ä¸è¶³åº”å¯¹
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¼ä¸šçº§åº”ç”¨åœºæ™¯**
- **å®‰å…¨å®¡è®¡**ï¼šç›‘æ§æ•æ„Ÿæ–‡ä»¶è®¿é—®ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸æ“ä½œ
- **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³æ•°æ®æ²»ç†å’Œåˆè§„å®¡è®¡éœ€æ±‚
- **æ€§èƒ½ç›‘æ§**ï¼šåˆ†ææ–‡ä»¶è®¿é—®æ¨¡å¼ï¼Œä¼˜åŒ–å­˜å‚¨æ¶æ„
- **æ•…éšœè¯Šæ–­**ï¼šå¿«é€Ÿå®šä½æ–‡ä»¶ç³»ç»Ÿç›¸å…³é—®é¢˜

**ğŸ”§ è¿ç»´å®è·µ**
- **è‡ªåŠ¨åŒ–è¿ç»´**ï¼šæ–‡ä»¶å˜æ›´è§¦å‘è‡ªåŠ¨åŒ–æµç¨‹
- **å®¹é‡ç®¡ç†**ï¼šç›‘æ§æ–‡ä»¶å¢é•¿è¶‹åŠ¿ï¼Œé¢„æµ‹å®¹é‡éœ€æ±‚
- **å¤‡ä»½éªŒè¯**ï¼šç¡®ä¿é‡è¦æ•°æ®åŠæ—¶å¤‡ä»½
- **æƒé™ç®¡ç†**ï¼šç›‘æ§æ–‡ä»¶æƒé™å˜æ›´ï¼Œé˜²æ­¢æƒé™æ³„éœ²

### 9.4 æœ€ä½³å®è·µå»ºè®®


```
ğŸ”¸ ç›‘æ§ç­–ç•¥åˆ¶å®š
- æ˜ç¡®ç›‘æ§ç›®æ ‡å’ŒèŒƒå›´
- åˆ¶å®šåˆç†çš„å‘Šè­¦é˜ˆå€¼
- å®šæœŸè¯„ä¼°å’Œè°ƒæ•´ç›‘æ§è§„åˆ™

ğŸ”¸ ç³»ç»Ÿèµ„æºç®¡ç†  
- ç›‘æ§ç³»ç»Ÿèµ„æºæ¶ˆè€—
- è®¾ç½®åˆç†çš„ç›‘æ§é—´éš”
- åŠæ—¶æ¸…ç†å†å²æ•°æ®

ğŸ”¸ å®‰å…¨æ€§è€ƒè™‘
- ä¿æŠ¤ç›‘æ§æ•°æ®ä¼ è¾“
- é™åˆ¶ç›‘æ§æƒé™èŒƒå›´
- å®¡è®¡ç›‘æ§ç³»ç»Ÿæœ¬èº«

ğŸ”¸ æ–‡æ¡£å’ŒåŸ¹è®­
- ç¼–å†™è¯¦ç»†çš„é…ç½®æ–‡æ¡£
- åŸ¹è®­è¿ç»´äººå‘˜ä½¿ç”¨
- å»ºç«‹æ•…éšœå¤„ç†æµç¨‹
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- é«˜çº§æ–‡ä»¶ç›‘æ§æ˜¯ä¼ä¸šçº§ç³»ç»Ÿè¿ç»´çš„é‡è¦ç»„æˆéƒ¨åˆ†
- éœ€è¦æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚çš„ç›‘æ§ç­–ç•¥å’ŒæŠ€æœ¯æ–¹æ¡ˆ
- å…³æ³¨å¯æ‰©å±•æ€§ã€å¯é æ€§å’Œæ€§èƒ½ä¼˜åŒ–
- å‘Šè­¦æœºåˆ¶è¦ç²¾å‡†ï¼Œé¿å…å‘Šè­¦ç–²åŠ³
- ç›‘æ§æ•°æ®è¦å–„äºåˆ†æï¼Œè½¬åŒ–ä¸ºè¿ç»´æ´å¯Ÿ