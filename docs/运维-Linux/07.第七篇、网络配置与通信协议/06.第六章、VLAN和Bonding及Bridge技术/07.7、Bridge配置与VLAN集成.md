---
title: 7ã€Bridgeé…ç½®ä¸VLANé›†æˆ
---
## ğŸ“š ç›®å½•

1. [Bridgeåˆ›å»ºä¸åˆ é™¤æ“ä½œ](#1-Bridgeåˆ›å»ºä¸åˆ é™¤æ“ä½œ)
2. [æ¥å£æ·»åŠ åˆ°Bridgeç®¡ç†](#2-æ¥å£æ·»åŠ åˆ°Bridgeç®¡ç†)
3. [Bridge VLANè¿‡æ»¤é…ç½®](#3-Bridge-VLANè¿‡æ»¤é…ç½®)
4. [VLAN aware bridgeæ¨¡å¼](#4-VLAN-aware-bridgeæ¨¡å¼)
5. [Bridgeç«¯å£VLANé…ç½®](#5-Bridgeç«¯å£VLANé…ç½®)
6. [Taggedä¸Untaggedç«¯å£ç®¡ç†](#6-Taggedä¸Untaggedç«¯å£ç®¡ç†)
7. [PVIDè®¾ç½®ä¸ç®¡ç†](#7-PVIDè®¾ç½®ä¸ç®¡ç†)
8. [STPå‚æ•°è°ƒä¼˜](#8-STPå‚æ•°è°ƒä¼˜)
9. [Bridgeæ•…éšœæ’æŸ¥](#9-Bridgeæ•…éšœæ’æŸ¥)
10. [ç½‘ç»œæ‹“æ‰‘è®¾è®¡è€ƒè™‘](#10-ç½‘ç»œæ‹“æ‰‘è®¾è®¡è€ƒè™‘)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ‰ Bridgeåˆ›å»ºä¸åˆ é™¤æ“ä½œ


### 1.1 ä»€ä¹ˆæ˜¯Linux Bridge

ğŸ¯ **ç®€å•ç†è§£**ï¼šLinux Bridgeå°±åƒä¸€ä¸ªæ™ºèƒ½äº¤æ¢æœºï¼Œè¿æ¥å¤šä¸ªç½‘ç»œæ¥å£

```
ç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼š
ç‰©ç†äº¤æ¢æœº â†’ è¿æ¥å¤šå°ç”µè„‘åˆ°å±€åŸŸç½‘
Linux Bridge â†’ è¿æ¥è™šæ‹Ÿæœºã€å®¹å™¨åˆ°è™šæ‹Ÿç½‘ç»œ

å®é™…åº”ç”¨åœºæ™¯ï¼š
è™šæ‹ŸåŒ–ç¯å¢ƒï¼šè¿æ¥å¤šä¸ªè™šæ‹Ÿæœº
å®¹å™¨ç½‘ç»œï¼šDockerã€Kubernetesç½‘ç»œ
ç½‘ç»œéš”ç¦»ï¼šåˆ›å»ºç‹¬ç«‹çš„ç½‘ç»œæ®µ
```

**ğŸ”¸ Bridgeçš„æ ¸å¿ƒä½œç”¨**
- **äºŒå±‚äº¤æ¢**ï¼šåœ¨æ•°æ®é“¾è·¯å±‚è½¬å‘æ•°æ®åŒ…
- **MACå­¦ä¹ **ï¼šè‡ªåŠ¨å­¦ä¹ è®¾å¤‡MACåœ°å€
- **å¹¿æ’­åŸŸç®¡ç†**ï¼šæ§åˆ¶å¹¿æ’­æµé‡èŒƒå›´
- **VLANæ”¯æŒ**ï¼šå®ç°ç½‘ç»œéš”ç¦»å’Œåˆ†æ®µ

### 1.2 ä¼ ç»ŸBridgeç®¡ç†å·¥å…·

**ğŸ”§ brctlå·¥å…·åŸºç¡€æ“ä½œ**

```bash
# æŸ¥çœ‹ç³»ç»Ÿä¸­çš„bridge
brctl show

# åˆ›å»ºæ–°çš„bridge
sudo brctl addbr br0

# åˆ é™¤bridgeï¼ˆå¿…é¡»å…ˆåœç”¨ï¼‰
sudo ip link set br0 down
sudo brctl delbr br0

# æŸ¥çœ‹bridgeçš„MACåœ°å€è¡¨
brctl showmacs br0

# æŸ¥çœ‹STPçŠ¶æ€
brctl showstp br0
```

**ğŸ’¡ BridgeåŸºæœ¬é…ç½®æµç¨‹**
```
åˆ›å»ºBridgeçš„æ ‡å‡†æ­¥éª¤ï¼š

1. åˆ›å»ºbridgeæ¥å£
   brctl addbr br0

2. æ·»åŠ ç‰©ç†æ¥å£åˆ°bridge
   brctl addif br0 eth1
   brctl addif br0 eth2

3. é…ç½®IPåœ°å€ï¼ˆå¯é€‰ï¼‰
   ip addr add 192.168.1.1/24 dev br0

4. å¯ç”¨bridge
   ip link set br0 up

5. å¯ç”¨STPï¼ˆå¯é€‰ï¼‰
   brctl stp br0 on
```

### 1.3 ç°ä»£ipå‘½ä»¤ç®¡ç†Bridge

**âš¡ ä½¿ç”¨iproute2å·¥å…·é›†**

```bash
# åˆ›å»ºbridgeæ¥å£
sudo ip link add name br0 type bridge

# æŸ¥çœ‹bridgeæ¥å£
ip link show type bridge

# è®¾ç½®bridgeå±æ€§
sudo ip link set br0 type bridge vlan_filtering 1

# å¯ç”¨bridge
sudo ip link set br0 up

# åˆ é™¤bridge
sudo ip link set br0 down
sudo ip link delete br0
```

### 1.4 systemd-networkdé…ç½®

**ğŸ“‹ æŒä¹…åŒ–Bridgeé…ç½®**

åˆ›å»ºbridgeé…ç½®æ–‡ä»¶ï¼š
```ini
# /etc/systemd/network/br0.netdev
[NetDev]
Name=br0
Kind=bridge

[Bridge]
STP=yes
VLANFiltering=yes
DefaultPVID=100
```

ç½‘ç»œé…ç½®æ–‡ä»¶ï¼š
```ini
# /etc/systemd/network/br0.network
[Match]
Name=br0

[Network]
DHCP=no
IPForward=yes
IPv6AcceptRA=no

[Address]
Address=192.168.1.1/24
```

åº”ç”¨é…ç½®ï¼š
```bash
sudo systemctl restart systemd-networkd
sudo networkctl status br0
```

---

## 2. ğŸ”Œ æ¥å£æ·»åŠ åˆ°Bridgeç®¡ç†


### 2.1 ç‰©ç†æ¥å£æ·»åŠ åˆ°Bridge

**ğŸ”§ æ¥å£ç»‘å®šæ“ä½œè¯¦è§£**

```bash
# ä¼ ç»Ÿbrctlæ–¹å¼
sudo brctl addif br0 eth1
sudo brctl addif br0 eth2

# ç°ä»£ipå‘½ä»¤æ–¹å¼
sudo ip link set eth1 master br0
sudo ip link set eth2 master br0

# éªŒè¯æ¥å£æ·»åŠ çŠ¶æ€
ip link show master br0
brctl show br0
```

**âš ï¸ æ¥å£æ·»åŠ æ³¨æ„äº‹é¡¹**
- ç‰©ç†æ¥å£åŠ å…¥bridgeåä¸èƒ½é…ç½®IPåœ°å€
- åŸæœ‰çš„IPé…ç½®ä¼šå¤±æ•ˆ
- æ¥å£çŠ¶æ€å¿…é¡»ä¸ºUP
- ç¡®ä¿æ¥å£æ²¡æœ‰è¢«å…¶ä»–æœåŠ¡å ç”¨

### 2.2 è™šæ‹Ÿæ¥å£ç®¡ç†

**ğŸ–¥ï¸ è™šæ‹ŸåŒ–ç¯å¢ƒæ¥å£é…ç½®**

åˆ›å»ºtapæ¥å£å¹¶æ·»åŠ åˆ°bridgeï¼š
```bash
# åˆ›å»ºtapæ¥å£
sudo ip tuntap add dev tap0 mode tap

# è®¾ç½®æ¥å£å±ä¸»
sudo ip link set tap0 up

# æ·»åŠ åˆ°bridge
sudo ip link set tap0 master br0

# ä¸ºè™šæ‹Ÿæœºé…ç½®ä½¿ç”¨
qemu-system-x86_64 -netdev tap,id=net0,ifname=tap0,script=no,downscript=no
```

veth pairåˆ›å»ºä¸é…ç½®ï¼š
```bash
# åˆ›å»ºvethå¯¹
sudo ip link add veth0 type veth peer name veth1

# ä¸€ç«¯åŠ å…¥bridge
sudo ip link set veth0 master br0
sudo ip link set veth0 up

# å¦ä¸€ç«¯é…ç½®åˆ°namespace
sudo ip netns add test-ns
sudo ip link set veth1 netns test-ns
sudo ip netns exec test-ns ip link set veth1 up
sudo ip netns exec test-ns ip addr add 192.168.1.100/24 dev veth1
```

### 2.3 æ¥å£ç§»é™¤ä¸æ¸…ç†

**ğŸ§¹ å®‰å…¨ç§»é™¤æ¥å£**

```bash
# ä»bridgeç§»é™¤æ¥å£
sudo ip link set eth1 nomaster
# æˆ–ä½¿ç”¨brctl
sudo brctl delif br0 eth1

# æ£€æŸ¥ç§»é™¤ç»“æœ
brctl show br0

# æ¸…ç†è™šæ‹Ÿæ¥å£
sudo ip link delete tap0
sudo ip link delete veth0  # ä¼šåŒæ—¶åˆ é™¤veth1

# æ¸…ç†namespace
sudo ip netns delete test-ns
```

**ğŸ“Š æ¥å£çŠ¶æ€ç›‘æ§**

| ç›‘æ§å‘½ä»¤ | **åŠŸèƒ½** | **è¾“å‡ºä¿¡æ¯** |
|---------|---------|-------------|
| `brctl show` | æ˜¾ç¤ºbridgeå’Œæˆå‘˜æ¥å£ | bridgeåç§°ã€æ¥å£åˆ—è¡¨ |
| `ip link show master br0` | æ˜¾ç¤ºbridgeæˆå‘˜ | è¯¦ç»†æ¥å£ä¿¡æ¯ |
| `bridge link show` | æ˜¾ç¤ºbridgeé“¾è·¯çŠ¶æ€ | ç«¯å£çŠ¶æ€ã€VLANé…ç½® |
| `cat /sys/class/net/br0/brif/*` | ç³»ç»Ÿçº§æ¥å£ä¿¡æ¯ | åº•å±‚æ¥å£ç»‘å®š |

---

## 3. ğŸ” Bridge VLANè¿‡æ»¤é…ç½®


### 3.1 VLANè¿‡æ»¤æœºåˆ¶åŸç†

**ğŸ¯ ç†è§£VLANè¿‡æ»¤çš„å·¥ä½œæ–¹å¼**

```
VLANè¿‡æ»¤å·¥ä½œåŸç†ï¼š

ä¼ ç»ŸBridgeï¼š
æ•°æ®åŒ… â†’ Bridge â†’ æ³›æ´ªåˆ°æ‰€æœ‰ç«¯å£

VLANè¿‡æ»¤Bridgeï¼š
æ•°æ®åŒ… â†’ æ£€æŸ¥VLANæ ‡ç­¾ â†’ è½¬å‘åˆ°å¯¹åº”VLANç«¯å£
```

**ğŸ”¸ VLANè¿‡æ»¤çš„æ ¸å¿ƒæ¦‚å¿µ**
- **VLAN filtering**ï¼šå¯ç”¨VLANæ ‡ç­¾è¯†åˆ«å’Œè¿‡æ»¤
- **VLAN aware**ï¼šbridgeèƒ½å¤Ÿç†è§£å’Œå¤„ç†VLANæ ‡ç­¾
- **ç«¯å£VLANé…ç½®**ï¼šæ¯ä¸ªç«¯å£å¯é…ç½®å…è®¸çš„VLAN
- **VLANè¡¨**ï¼šç»´æŠ¤VLANåˆ°ç«¯å£çš„æ˜ å°„å…³ç³»

### 3.2 å¯ç”¨VLANè¿‡æ»¤åŠŸèƒ½

**âš¡ VLAN filteringé…ç½®æ­¥éª¤**

```bash
# æ–¹æ³•1ï¼šåˆ›å»ºæ—¶å¯ç”¨
sudo ip link add name br0 type bridge vlan_filtering 1

# æ–¹æ³•2ï¼šè¿è¡Œæ—¶å¯ç”¨
sudo ip link set br0 type bridge vlan_filtering 1

# éªŒè¯VLANè¿‡æ»¤çŠ¶æ€
cat /sys/class/net/br0/bridge/vlan_filtering
# è¾“å‡º 1 è¡¨ç¤ºå·²å¯ç”¨

# æŸ¥çœ‹VLANé…ç½®
bridge vlan show
```

### 3.3 VLANè¡¨ç®¡ç†

**ğŸ“‹ VLANè½¬å‘è¡¨é…ç½®**

```bash
# æŸ¥çœ‹å½“å‰VLANé…ç½®
bridge vlan show

# æ·»åŠ VLANåˆ°ç«¯å£
sudo bridge vlan add vid 100 dev eth1
sudo bridge vlan add vid 200 dev eth2

# æ·»åŠ tagged VLAN
sudo bridge vlan add vid 300 dev eth1 tagged

# æ·»åŠ untagged VLANå¹¶è®¾ç½®PVID
sudo bridge vlan add vid 100 dev eth1 untagged pvid

# åˆ é™¤VLANé…ç½®
sudo bridge vlan del vid 100 dev eth1
```

**ğŸ’¡ VLANé…ç½®éªŒè¯**

æ£€æŸ¥VLANè½¬å‘è¡¨ï¼š
```bash
# æŸ¥çœ‹FDBè¡¨ï¼ˆè½¬å‘æ•°æ®åº“ï¼‰
bridge fdb show

# æŸ¥çœ‹VLANæˆå‘˜å…³ç³»
bridge vlan show dev eth1

# æŸ¥çœ‹å…¨å±€VLANé…ç½®
bridge vlan show br br0
```

### 3.4 æ‰¹é‡VLANé…ç½®

**ğŸ“¦ é«˜æ•ˆæ‰¹é‡é…ç½®æ–¹æ³•**

é…ç½®è„šæœ¬ç¤ºä¾‹ï¼š
```bash
#!/bin/bash
# vlan_batch_config.sh

BRIDGE="br0"
INTERFACES=("eth1" "eth2" "eth3")
VLANS=(100 200 300)

# å¯ç”¨VLANè¿‡æ»¤
sudo ip link set $BRIDGE type bridge vlan_filtering 1

# æ‰¹é‡é…ç½®VLAN
for interface in "${INTERFACES[@]}"; do
    echo "é…ç½®æ¥å£ $interface"
    
    for vlan in "${VLANS[@]}"; do
        # æ·»åŠ tagged VLAN
        sudo bridge vlan add vid $vlan dev $interface
        echo "  æ·»åŠ VLAN $vlan"
    done
    
    # è®¾ç½®é»˜è®¤VLAN
    sudo bridge vlan add vid 1 dev $interface untagged pvid
done

echo "VLANé…ç½®å®Œæˆ"
bridge vlan show
```

---

## 4. ğŸ”„ VLAN aware bridgeæ¨¡å¼


### 4.1 VLAN awareæ¨¡å¼è¯¦è§£

**ğŸ¯ ç†è§£VLAN awareçš„å·¥ä½œæœºåˆ¶**

```
ä¼ ç»ŸBridge vs VLAN aware Bridgeï¼š

ä¼ ç»Ÿæ¨¡å¼ï¼š
- æ‰€æœ‰æµé‡åœ¨åŒä¸€å¹¿æ’­åŸŸ
- æ— æ³•åŒºåˆ†VLANæ ‡ç­¾
- ç®€å•çš„äºŒå±‚è½¬å‘

VLAN awareæ¨¡å¼ï¼š
- æ”¯æŒå¤šä¸ªVLANå¹¿æ’­åŸŸ
- è¯†åˆ«å’Œå¤„ç†VLANæ ‡ç­¾
- åŸºäºVLANçš„æµé‡éš”ç¦»
```

**ğŸ”¸ VLAN awareçš„ä¼˜åŠ¿**
- **æµé‡éš”ç¦»**ï¼šä¸åŒVLANé—´æµé‡å®Œå…¨éš”ç¦»
- **å¸¦å®½ä¼˜åŒ–**ï¼šå‡å°‘ä¸å¿…è¦çš„å¹¿æ’­æµé‡
- **å®‰å…¨å¢å¼º**ï¼šç½‘ç»œæ®µä¹‹é—´çš„å®‰å…¨è¾¹ç•Œ
- **ç®¡ç†ç®€åŒ–**ï¼šå•ä¸ªbridgeæ”¯æŒå¤šä¸ªç½‘ç»œæ®µ

### 4.2 é…ç½®VLAN aware bridge

**âš¡ å®Œæ•´é…ç½®æµç¨‹**

åˆ›å»ºVLAN aware bridgeï¼š
```bash
# åˆ›å»ºå¯ç”¨VLAN filteringçš„bridge
sudo ip link add name br-vlan type bridge vlan_filtering 1

# è®¾ç½®é»˜è®¤PVIDï¼ˆå¯é€‰ï¼‰
sudo ip link set br-vlan type bridge vlan_default_pvid 1

# å¯ç”¨bridge
sudo ip link set br-vlan up
```

æ·»åŠ æ¥å£å¹¶é…ç½®VLANï¼š
```bash
# æ·»åŠ æ¥å£åˆ°bridge
sudo ip link set eth1 master br-vlan
sudo ip link set eth2 master br-vlan

# é…ç½®ç«¯å£VLAN
# eth1 å…è®¸ VLAN 100, 200ï¼ˆtaggedï¼‰
sudo bridge vlan add vid 100 dev eth1
sudo bridge vlan add vid 200 dev eth1

# eth2 å±äº VLAN 100ï¼ˆuntaggedï¼ŒPVID=100ï¼‰
sudo bridge vlan del vid 1 dev eth2  # åˆ é™¤é»˜è®¤VLAN
sudo bridge vlan add vid 100 dev eth2 untagged pvid
```

### 4.3 systemdé…ç½®VLAN aware bridge

**ğŸ“‹ æŒä¹…åŒ–é…ç½®ç®¡ç†**

Bridgeé…ç½®æ–‡ä»¶ï¼š
```ini
# /etc/systemd/network/br-vlan.netdev
[NetDev]
Name=br-vlan
Kind=bridge

[Bridge]
VLANFiltering=yes
DefaultPVID=1
STP=yes
Priority=32768
HelloTimeSec=2
MaxAgeSec=20
ForwardDelaySec=15
```

æ¥å£ç»‘å®šé…ç½®ï¼š
```ini
# /etc/systemd/network/eth1-bridge.network
[Match]
Name=eth1

[Network]
Bridge=br-vlan
ConfigureWithoutCarrier=yes

[BridgeVLAN]
VLAN=100
VLAN=200
```

```ini
# /etc/systemd/network/eth2-bridge.network
[Match]
Name=eth2

[Network]
Bridge=br-vlan
ConfigureWithoutCarrier=yes

[BridgeVLAN]
VLAN=100
PVID=100
EgressUntagged=100
```

### 4.4 éªŒè¯VLAN awareé…ç½®

**ğŸ” é…ç½®éªŒè¯æ–¹æ³•**

```bash
# æ£€æŸ¥VLAN filteringçŠ¶æ€
cat /sys/class/net/br-vlan/bridge/vlan_filtering

# æŸ¥çœ‹è¯¦ç»†VLANé…ç½®
bridge vlan show

# æ£€æŸ¥ç«¯å£çŠ¶æ€
bridge link show

# æµ‹è¯•VLANè¿é€šæ€§
# åœ¨VLAN 100ç½‘ç»œä¸­æµ‹è¯•
sudo ip netns add vlan100-test
sudo ip link add veth-test type veth peer name veth-test-peer
sudo ip link set veth-test master br-vlan
sudo bridge vlan add vid 100 dev veth-test untagged pvid
sudo ip link set veth-test-peer netns vlan100-test
sudo ip netns exec vlan100-test ip addr add 192.168.100.10/24 dev veth-test-peer
sudo ip netns exec vlan100-test ip link set veth-test-peer up
```

---

## 5. âš™ï¸ Bridgeç«¯å£VLANé…ç½®


### 5.1 ç«¯å£VLANç±»å‹è¯¦è§£

**ğŸ”§ ç†è§£ä¸åŒçš„ç«¯å£VLANé…ç½®**

```
ç«¯å£VLANé…ç½®ç±»å‹ï¼š

Accessç«¯å£ï¼š
- åªå±äºä¸€ä¸ªVLAN
- å‘é€untaggedæµé‡
- æ¥æ”¶åˆ°çš„æµé‡æ‰“ä¸ŠPVIDæ ‡ç­¾

Trunkç«¯å£ï¼š
- å¯ä»¥ä¼ è¾“å¤šä¸ªVLAN
- å‘é€taggedæµé‡
- æ”¯æŒnative VLANï¼ˆuntaggedï¼‰

Hybridç«¯å£ï¼š
- æ··åˆæ¨¡å¼
- æŸäº›VLAN taggedï¼ŒæŸäº›untagged
- çµæ´»çš„VLANå¤„ç†
```

### 5.2 Accessç«¯å£é…ç½®

**ğŸ”Œ å•VLANç«¯å£é…ç½®**

```bash
# é…ç½®Accessç«¯å£ï¼ˆä»…å±äºVLAN 100ï¼‰
INTERFACE="eth1"
VLAN_ID="100"

# åˆ é™¤é»˜è®¤VLANé…ç½®
sudo bridge vlan del vid 1 dev $INTERFACE

# æ·»åŠ untagged VLANå¹¶è®¾ç½®PVID
sudo bridge vlan add vid $VLAN_ID dev $INTERFACE untagged pvid

# éªŒè¯é…ç½®
bridge vlan show dev $INTERFACE
```

æ‰¹é‡Accessç«¯å£é…ç½®ï¼š
```bash
#!/bin/bash
# access_port_config.sh

declare -A access_ports=(
    ["eth1"]="100"
    ["eth2"]="200"  
    ["eth3"]="300"
)

for port in "${!access_ports[@]}"; do
    vlan=${access_ports[$port]}
    echo "é…ç½® $port ä¸º Access ç«¯å£ï¼ŒVLAN $vlan"
    
    # æ¸…é™¤é»˜è®¤é…ç½®
    sudo bridge vlan del vid 1 dev $port 2>/dev/null || true
    
    # é…ç½®Access VLAN
    sudo bridge vlan add vid $vlan dev $port untagged pvid
done
```

### 5.3 Trunkç«¯å£é…ç½®

**ğŸ“¡ å¤šVLANç«¯å£é…ç½®**

```bash
# é…ç½®Trunkç«¯å£ï¼ˆä¼ è¾“å¤šä¸ªVLANï¼‰
INTERFACE="eth4"
VLANS=(100 200 300 400)
NATIVE_VLAN="100"

# åˆ é™¤é»˜è®¤VLAN
sudo bridge vlan del vid 1 dev $INTERFACE

# æ·»åŠ native VLANï¼ˆuntaggedï¼‰
sudo bridge vlan add vid $NATIVE_VLAN dev $INTERFACE untagged pvid

# æ·»åŠ å…¶ä»–VLANï¼ˆtaggedï¼‰
for vlan in "${VLANS[@]}"; do
    if [ "$vlan" != "$NATIVE_VLAN" ]; then
        sudo bridge vlan add vid $vlan dev $INTERFACE
    fi
done

# éªŒè¯Trunké…ç½®
bridge vlan show dev $INTERFACE
```

### 5.4 åŠ¨æ€VLANé…ç½®

**âš¡ è¿è¡Œæ—¶VLANè°ƒæ•´**

VLANåŠ¨æ€æ·»åŠ è„šæœ¬ï¼š
```bash
#!/bin/bash
# dynamic_vlan_manager.sh

add_vlan_to_port() {
    local port=$1
    local vlan=$2
    local mode=$3  # tagged æˆ– untagged
    
    if [ "$mode" = "untagged" ]; then
        sudo bridge vlan add vid $vlan dev $port untagged
    else
        sudo bridge vlan add vid $vlan dev $port
    fi
    
    echo "VLAN $vlan å·²æ·»åŠ åˆ°ç«¯å£ $port ($mode)"
}

remove_vlan_from_port() {
    local port=$1
    local vlan=$2
    
    sudo bridge vlan del vid $vlan dev $port
    echo "VLAN $vlan å·²ä»ç«¯å£ $port ç§»é™¤"
}

# ä½¿ç”¨ç¤ºä¾‹
case "$1" in
    add)
        add_vlan_to_port $2 $3 $4
        ;;
    remove)
        remove_vlan_from_port $2 $3
        ;;
    *)
        echo "ç”¨æ³•: $0 {add|remove} <ç«¯å£> <VLAN> [tagged|untagged]"
        ;;
esac
```

**ğŸ“Š ç«¯å£VLANçŠ¶æ€ç›‘æ§**

```bash
# ç›‘æ§è„šæœ¬
#!/bin/bash
# vlan_port_monitor.sh

while true; do
    clear
    echo "=== Bridge VLANç«¯å£çŠ¶æ€ ==="
    echo "æ—¶é—´: $(date)"
    echo
    
    # æ˜¾ç¤ºæ‰€æœ‰ç«¯å£çš„VLANé…ç½®
    bridge vlan show | while read line; do
        if [[ $line == *"port"* ]] || [[ $line == *"br"* ]]; then
            echo "$line"
        fi
    done
    
    echo
    echo "=== FDBè¡¨å¤§å° ==="
    bridge fdb show | wc -l
    
    sleep 5
done
```

---

## 6. ğŸ·ï¸ Taggedä¸Untaggedç«¯å£ç®¡ç†


### 6.1 Taggedå’ŒUntaggedæ¦‚å¿µè¯¦è§£

**ğŸ¯ ç†è§£VLANæ ‡ç­¾å¤„ç†æœºåˆ¶**

```
VLANæ ‡ç­¾å¤„ç†è¿‡ç¨‹ï¼š

Taggedç«¯å£ï¼ˆTrunkæ¨¡å¼ï¼‰ï¼š
è¿›å…¥ï¼šä¿æŒåŸæœ‰VLANæ ‡ç­¾
ä¼ è¾“ï¼šå¸¦VLANæ ‡ç­¾çš„ä»¥å¤ªç½‘å¸§
å‡ºå»ï¼šä¿æŒVLANæ ‡ç­¾ä¸å˜

Untaggedç«¯å£ï¼ˆAccessæ¨¡å¼ï¼‰ï¼š
è¿›å…¥ï¼šæ·»åŠ PVIDä½œä¸ºVLANæ ‡ç­¾
ä¼ è¾“ï¼šå†…éƒ¨å¸¦VLANæ ‡ç­¾å¤„ç†
å‡ºå»ï¼šç§»é™¤VLANæ ‡ç­¾
```

**ğŸ“‹ æ ‡ç­¾å¤„ç†å¯¹æ¯”è¡¨**

| ç«¯å£ç±»å‹ | **æ¥æ”¶å¤„ç†** | **ä¼ è¾“çŠ¶æ€** | **å‘é€å¤„ç†** | **é€‚ç”¨åœºæ™¯** |
|---------|-------------|-------------|-------------|-------------|
| **Tagged** | ä¿æŒæ ‡ç­¾ | å¸¦æ ‡ç­¾è½¬å‘ | ä¿æŒæ ‡ç­¾ | è¿æ¥äº¤æ¢æœºã€è·¯ç”±å™¨ |
| **Untagged** | æ·»åŠ PVID | å¸¦æ ‡ç­¾è½¬å‘ | ç§»é™¤æ ‡ç­¾ | è¿æ¥ç»ˆç«¯è®¾å¤‡ |
| **Hybrid** | æ··åˆå¤„ç† | å¸¦æ ‡ç­¾è½¬å‘ | æ ¹æ®é…ç½® | å¤æ‚ç½‘ç»œç¯å¢ƒ |

### 6.2 Taggedç«¯å£é…ç½®å®è·µ

**ğŸ”§ Trunkç«¯å£è¯¦ç»†é…ç½®**

```bash
# é…ç½®ä¸€ä¸ªæ ‡å‡†çš„Trunkç«¯å£
TRUNK_PORT="eth0"
ALLOWED_VLANS=(10 20 30 40 50)

echo "é…ç½®Trunkç«¯å£: $TRUNK_PORT"

# æ¸…é™¤ç°æœ‰é…ç½®
sudo bridge vlan flush dev $TRUNK_PORT

# æ·»åŠ å…è®¸çš„VLANï¼ˆå…¨éƒ¨ä¸ºtaggedï¼‰
for vlan in "${ALLOWED_VLANS[@]}"; do
    sudo bridge vlan add vid $vlan dev $TRUNK_PORT
    echo "  æ·»åŠ VLAN $vlan (tagged)"
done

# éªŒè¯é…ç½®
echo "å½“å‰é…ç½®:"
bridge vlan show dev $TRUNK_PORT
```

**ğŸ’¡ Trunkç«¯å£é«˜çº§é…ç½®**

æ”¯æŒnative VLANçš„Trunkï¼š
```bash
# é…ç½®å¸¦native VLANçš„Trunkç«¯å£
TRUNK_PORT="eth1"
NATIVE_VLAN="10"
TAGGED_VLANS=(20 30 40)

# é…ç½®native VLANï¼ˆuntagged + PVIDï¼‰
sudo bridge vlan add vid $NATIVE_VLAN dev $TRUNK_PORT untagged pvid

# é…ç½®å…¶ä»–VLANï¼ˆtaggedï¼‰
for vlan in "${TAGGED_VLANS[@]}"; do
    sudo bridge vlan add vid $vlan dev $TRUNK_PORT
done

echo "Trunkç«¯å£é…ç½®å®Œæˆ:"
echo "Native VLAN: $NATIVE_VLAN (untagged)"
echo "Tagged VLANs: ${TAGGED_VLANS[*]}"
```

### 6.3 Untaggedç«¯å£é…ç½®å®è·µ

**ğŸ”Œ Accessç«¯å£ä¸“ä¸šé…ç½®**

```bash
# æ ‡å‡†Accessç«¯å£é…ç½®å‡½æ•°
configure_access_port() {
    local port=$1
    local access_vlan=$2
    
    echo "é…ç½®Accessç«¯å£: $port -> VLAN $access_vlan"
    
    # åˆ é™¤æ‰€æœ‰ç°æœ‰VLANé…ç½®
    for vid in $(bridge vlan show dev $port | grep -oE '[0-9]+' | sort -n); do
        sudo bridge vlan del vid $vid dev $port 2>/dev/null || true
    done
    
    # é…ç½®Access VLAN
    sudo bridge vlan add vid $access_vlan dev $port untagged pvid
    
    # éªŒè¯é…ç½®
    if bridge vlan show dev $port | grep -q "PVID Egress Untagged"; then
        echo "  âœ“ Accessç«¯å£é…ç½®æˆåŠŸ"
    else
        echo "  âœ— Accessç«¯å£é…ç½®å¤±è´¥"
        return 1
    fi
}

# æ‰¹é‡é…ç½®Accessç«¯å£
ACCESS_CONFIG=(
    "eth2:100"
    "eth3:200"
    "tap0:100"
    "veth0:300"
)

for config in "${ACCESS_CONFIG[@]}"; do
    port=${config%:*}
    vlan=${config#*:}
    configure_access_port $port $vlan
done
```

### 6.4 æ··åˆç«¯å£é…ç½®

**ğŸ”€ Hybridç«¯å£çµæ´»é…ç½®**

```bash
# å¤æ‚çš„Hybridç«¯å£é…ç½®
configure_hybrid_port() {
    local port=$1
    local -n tagged_vlans=$2
    local -n untagged_vlans=$3
    local pvid=$4
    
    echo "é…ç½®Hybridç«¯å£: $port"
    
    # æ¸…é™¤ç°æœ‰é…ç½®
    sudo bridge vlan flush dev $port
    
    # é…ç½®tagged VLAN
    for vlan in "${tagged_vlans[@]}"; do
        sudo bridge vlan add vid $vlan dev $port
        echo "  æ·»åŠ tagged VLAN: $vlan"
    done
    
    # é…ç½®untagged VLAN
    for vlan in "${untagged_vlans[@]}"; do
        if [ "$vlan" = "$pvid" ]; then
            sudo bridge vlan add vid $vlan dev $port untagged pvid
            echo "  æ·»åŠ untagged VLAN: $vlan (PVID)"
        else
            sudo bridge vlan add vid $vlan dev $port untagged
            echo "  æ·»åŠ untagged VLAN: $vlan"
        fi
    done
}

# ä½¿ç”¨ç¤ºä¾‹
HYBRID_PORT="eth4"
TAGGED_VLANS=(200 300 400)
UNTAGGED_VLANS=(100 500)
PVID=100

configure_hybrid_port $HYBRID_PORT TAGGED_VLANS UNTAGGED_VLANS $PVID
```

---

## 7. ğŸ“ PVIDè®¾ç½®ä¸ç®¡ç†


### 7.1 PVIDæ¦‚å¿µæ·±å…¥ç†è§£

**ğŸ¯ Port VLAN IDçš„ä½œç”¨æœºåˆ¶**

```
PVIDå·¥ä½œåŸç†ï¼š

æ— æ ‡ç­¾å¸§è¿›å…¥ç«¯å£ï¼š
æ•°æ®å¸§ â†’ æ£€æŸ¥VLANæ ‡ç­¾ â†’ æ— æ ‡ç­¾ â†’ æ·»åŠ PVIDæ ‡ç­¾ â†’ è½¬å‘

æœ‰æ ‡ç­¾å¸§è¿›å…¥ç«¯å£ï¼š
æ•°æ®å¸§ â†’ æ£€æŸ¥VLANæ ‡ç­¾ â†’ æœ‰æ ‡ç­¾ â†’ ä¿æŒåŸæ ‡ç­¾ â†’ è½¬å‘

å¸§ç¦»å¼€ç«¯å£ï¼š
æ•°æ®å¸§ â†’ æ£€æŸ¥ç›®æ ‡ç«¯å£é…ç½® â†’ 
  â””â”€ untaggedï¼šç§»é™¤æ ‡ç­¾
  â””â”€ taggedï¼šä¿æŒæ ‡ç­¾
```

**ğŸ”¸ PVIDçš„å…³é”®ç‰¹æ€§**
- **å”¯ä¸€æ€§**ï¼šæ¯ä¸ªç«¯å£åªèƒ½æœ‰ä¸€ä¸ªPVID
- **é»˜è®¤æ€§**ï¼šå¤„ç†æ— æ ‡ç­¾æµé‡çš„é»˜è®¤VLAN
- **å¼ºåˆ¶æ€§**ï¼šuntaggedç«¯å£å¿…é¡»è®¾ç½®PVID
- **ç»§æ‰¿æ€§**ï¼šæ–°åŠ å…¥çš„æ— æ ‡ç­¾æµé‡è‡ªåŠ¨è·å¾—PVID

### 7.2 PVIDé…ç½®æ“ä½œ

**âš¡ PVIDè®¾ç½®å’Œä¿®æ”¹**

```bash
# æŸ¥çœ‹å½“å‰PVIDè®¾ç½®
bridge vlan show dev eth1

# è®¾ç½®PVIDï¼ˆæ–¹æ³•1ï¼šä¸untaggedåŒæ—¶è®¾ç½®ï¼‰
sudo bridge vlan add vid 100 dev eth1 untagged pvid

# è®¾ç½®PVIDï¼ˆæ–¹æ³•2ï¼šä»…ä¿®æ”¹PVIDï¼‰
sudo bridge vlan add vid 200 dev eth1 pvid

# éªŒè¯PVIDè®¾ç½®
bridge vlan show dev eth1 | grep PVID
```

**ğŸ”§ PVIDæ‰¹é‡ç®¡ç†è„šæœ¬**

```bash
#!/bin/bash
# pvid_manager.sh

set_port_pvid() {
    local port=$1
    local new_pvid=$2
    local old_pvid=$(get_current_pvid $port)
    
    if [ "$old_pvid" = "$new_pvid" ]; then
        echo "ç«¯å£ $port PVID å·²ç»æ˜¯ $new_pvid"
        return 0
    fi
    
    echo "ä¿®æ”¹ç«¯å£ $port PVID: $old_pvid -> $new_pvid"
    
    # æ·»åŠ æ–°PVIDï¼ˆä¿æŒuntaggedï¼‰
    sudo bridge vlan add vid $new_pvid dev $port untagged pvid
    
    # å¦‚æœæ—§PVIDä¸åœ¨å…è®¸åˆ—è¡¨ä¸­ï¼Œåˆ™åˆ é™¤
    if ! bridge vlan show dev $port | grep -v PVID | grep -q "$old_pvid"; then
        sudo bridge vlan del vid $old_pvid dev $port
    fi
}

get_current_pvid() {
    local port=$1
    bridge vlan show dev $port | grep PVID | grep -oE '[0-9]+' | head -1
}

# æ‰¹é‡PVIDé…ç½®
declare -A port_pvids=(
    ["eth1"]="100"
    ["eth2"]="200"
    ["eth3"]="100"
    ["tap0"]="300"
)

for port in "${!port_pvids[@]}"; do
    set_port_pvid $port ${port_pvids[$port]}
done
```

### 7.3 PVIDæ•…éšœæ’æŸ¥

**ğŸ” PVIDç›¸å…³é—®é¢˜è¯Šæ–­**

å¸¸è§PVIDé—®é¢˜ï¼š
```bash
# 1. æ£€æŸ¥PVIDæ˜¯å¦æ­£ç¡®è®¾ç½®
check_pvid() {
    local port=$1
    local expected_pvid=$2
    
    current_pvid=$(bridge vlan show dev $port | grep PVID | grep -oE '[0-9]+' | head -1)
    
    if [ "$current_pvid" = "$expected_pvid" ]; then
        echo "âœ“ $port PVIDæ­£ç¡®: $current_pvid"
    else
        echo "âœ— $port PVIDé”™è¯¯: æœŸæœ›$expected_pvid, å®é™…$current_pvid"
    fi
}

# 2. æ£€æŸ¥PVIDå¯¹åº”çš„VLANæ˜¯å¦å­˜åœ¨
verify_pvid_vlan() {
    local port=$1
    local pvid=$(get_current_pvid $port)
    
    if bridge vlan show dev $port | grep -q "$pvid.*Untagged"; then
        echo "âœ“ $port PVID $pvid å¯¹åº”VLANé…ç½®æ­£ç¡®"
    else
        echo "âœ— $port PVID $pvid å¯¹åº”VLANé…ç½®ç¼ºå¤±"
    fi
}

# 3. æµ‹è¯•PVIDåŠŸèƒ½
test_pvid_functionality() {
    local port=$1
    local test_ns="pvid-test"
    
    # åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
    sudo ip netns add $test_ns
    sudo ip link add veth-test type veth peer name veth-test-peer
    sudo ip link set veth-test master br0
    sudo ip link set veth-test-peer netns $test_ns
    
    # é…ç½®PVID
    local pvid=999
    sudo bridge vlan add vid $pvid dev veth-test untagged pvid
    
    # åœ¨namespaceä¸­é…ç½®IPå¹¶æµ‹è¯•
    sudo ip netns exec $test_ns ip addr add 192.168.99.10/24 dev veth-test-peer
    sudo ip netns exec $test_ns ip link set veth-test-peer up
    sudo ip link set veth-test up
    
    # æ¸…ç†
    sudo ip link delete veth-test
    sudo ip netns delete $test_ns
}
```

### 7.4 PVIDæ€§èƒ½ä¼˜åŒ–

**âš¡ PVIDå¤„ç†æ€§èƒ½è°ƒä¼˜**

```bash
# PVIDæ€§èƒ½ç›¸å…³å‚æ•°
echo "PVIDæ€§èƒ½è°ƒä¼˜å‚æ•°:"

# æŸ¥çœ‹bridgeçš„hashè¡¨å¤§å°
cat /sys/class/net/br0/bridge/hash_max

# è°ƒæ•´FDBè¡¨å¤§å°ï¼ˆæé«˜MACå­¦ä¹ æ€§èƒ½ï¼‰
echo 8192 | sudo tee /sys/class/net/br0/bridge/hash_max

# è°ƒæ•´ageingæ—¶é—´ï¼ˆå½±å“MACè¡¨è€åŒ–ï¼‰
echo 600 | sudo tee /sys/class/net/br0/bridge/ageing_time

# è°ƒæ•´VLANè¡¨æ€§èƒ½å‚æ•°
# ç¦ç”¨ä¸å¿…è¦çš„VLANï¼ˆå‡å°‘æŸ¥æ‰¾å¼€é”€ï¼‰
bridge vlan show | grep -E "^[0-9]+" | while read vlan_info; do
    vlan_id=$(echo $vlan_info | awk '{print $1}')
    # åˆ é™¤æœªä½¿ç”¨çš„VLAN
    if [ $vlan_id -gt 1000 ] && [ $vlan_id -lt 4000 ]; then
        echo "è€ƒè™‘åˆ é™¤æœªä½¿ç”¨çš„VLAN: $vlan_id"
    fi
done
```

---

## 8. ğŸŒ² STPå‚æ•°è°ƒä¼˜


### 8.1 STPåŸºç¡€æ¦‚å¿µå›é¡¾

**ğŸ¯ ç”Ÿæˆæ ‘åè®®åœ¨Bridgeä¸­çš„ä½œç”¨**

```
STPçš„æ ¸å¿ƒä½œç”¨ï¼š

ç¯è·¯æ£€æµ‹ï¼š
ç‰©ç†ç½‘ç»œ â†’ å¤šæ¡è·¯å¾„ â†’ æ½œåœ¨ç¯è·¯ â†’ STPæ£€æµ‹

è·¯å¾„é˜»å¡ï¼š
æ£€æµ‹åˆ°ç¯è·¯ â†’ è®¡ç®—æœ€ä½³è·¯å¾„ â†’ é˜»å¡å†—ä½™è·¯å¾„

åŠ¨æ€æ¢å¤ï¼š
ä¸»è·¯å¾„æ•…éšœ â†’ STPé‡æ–°è®¡ç®— â†’ æ¿€æ´»å¤‡ç”¨è·¯å¾„
```

**ğŸ“‹ STPçŠ¶æ€è½¬æ¢**

```
ç«¯å£çŠ¶æ€è½¬æ¢è¿‡ç¨‹ï¼š

Disabled â†’ Blocking â†’ Listening â†’ Learning â†’ Forwarding
   â†‘         â†‘          â†‘          â†‘          â†‘
 ç®¡ç†ç¦ç”¨   åˆå§‹çŠ¶æ€   å‘é€BPDU   å­¦ä¹ MAC   æ­£å¸¸è½¬å‘
```

### 8.2 STPåŸºæœ¬é…ç½®

**ğŸ”§ å¯ç”¨å’Œé…ç½®STP**

```bash
# å¯ç”¨STP
sudo brctl stp br0 on

# æˆ–ä½¿ç”¨ipå‘½ä»¤
sudo ip link set br0 type bridge stp_state 1

# æŸ¥çœ‹STPçŠ¶æ€
brctl showstp br0

# æŸ¥çœ‹è¯¦ç»†STPä¿¡æ¯
cat /sys/class/net/br0/bridge/stp_state
```

**âš¡ STPå…³é”®å‚æ•°è®¾ç½®**

```bash
# è®¾ç½®bridgeä¼˜å…ˆçº§ï¼ˆæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
sudo brctl setbridgeprio br0 4096

# è®¾ç½®helloæ—¶é—´ï¼ˆç§’ï¼‰
sudo brctl sethello br0 2

# è®¾ç½®æœ€å¤§è€åŒ–æ—¶é—´ï¼ˆç§’ï¼‰
sudo brctl setmaxage br0 20

# è®¾ç½®è½¬å‘å»¶è¿Ÿï¼ˆç§’ï¼‰
sudo brctl setfd br0 15

# ç«¯å£ä¼˜å…ˆçº§è®¾ç½®
sudo brctl setportprio br0 eth1 16

# ç«¯å£è·¯å¾„ä»£ä»·è®¾ç½®
sudo brctl setpathcost br0 eth1 100
```

### 8.3 STPé«˜çº§è°ƒä¼˜

**ğŸ“Š STPæ€§èƒ½ä¼˜åŒ–ç­–ç•¥**

```bash
#!/bin/bash
# stp_optimization.sh

BRIDGE="br0"

optimize_stp_timers() {
    echo "ä¼˜åŒ–STPè®¡æ—¶å™¨å‚æ•°..."
    
    # å¿«é€Ÿæ”¶æ•›è®¾ç½®ï¼ˆé€‚ç”¨äºå°å‹ç½‘ç»œï¼‰
    sudo brctl sethello $BRIDGE 1      # Helloæ—¶é—´ï¼š1ç§’
    sudo brctl setmaxage $BRIDGE 6     # æœ€å¤§è€åŒ–ï¼š6ç§’
    sudo brctl setfd $BRIDGE 4         # è½¬å‘å»¶è¿Ÿï¼š4ç§’
    
    echo "å¿«é€Ÿæ”¶æ•›æ¨¡å¼å·²å¯ç”¨"
}

configure_port_priorities() {
    echo "é…ç½®ç«¯å£ä¼˜å…ˆçº§..."
    
    # ä¸»é“¾è·¯è®¾ç½®æ›´é«˜ä¼˜å…ˆçº§
    sudo brctl setportprio $BRIDGE eth1 16   # é«˜ä¼˜å…ˆçº§
    sudo brctl setportprio $BRIDGE eth2 32   # ä¸­ç­‰ä¼˜å…ˆçº§
    sudo brctl setportprio $BRIDGE eth3 64   # ä½ä¼˜å…ˆçº§
    
    echo "ç«¯å£ä¼˜å…ˆçº§é…ç½®å®Œæˆ"
}

set_path_costs() {
    echo "è®¾ç½®è·¯å¾„ä»£ä»·..."
    
    # æ ¹æ®é“¾è·¯é€Ÿåº¦è®¾ç½®ä»£ä»·
    sudo brctl setpathcost $BRIDGE eth1 4    # 1Gbps
    sudo brctl setpathcost $BRIDGE eth2 19   # 100Mbps
    sudo brctl setpathcost $BRIDGE eth3 100  # 10Mbps
    
    echo "è·¯å¾„ä»£ä»·è®¾ç½®å®Œæˆ"
}

# æ‰§è¡Œä¼˜åŒ–
optimize_stp_timers
configure_port_priorities
set_path_costs

# æ˜¾ç¤ºæœ€ç»ˆé…ç½®
echo "STPé…ç½®æ‘˜è¦:"
brctl showstp $BRIDGE
```

### 8.4 RSTPé…ç½®

**âš¡ å¿«é€Ÿç”Ÿæˆæ ‘åè®®é…ç½®**

```bash
# å¯ç”¨RSTPï¼ˆ802.1wï¼‰
sudo ip link set br0 type bridge stp_state 1

# é…ç½®RSTPç‰¹å®šå‚æ•°
echo 2 | sudo tee /sys/class/net/br0/bridge/stp_protocol

# ç«¯å£å¿«é€Ÿè½¬æ¢é…ç½®
configure_rstp_ports() {
    local bridge=$1
    
    # é…ç½®è¾¹ç¼˜ç«¯å£ï¼ˆè¿æ¥ç»ˆç«¯è®¾å¤‡ï¼‰
    echo "é…ç½®RSTPè¾¹ç¼˜ç«¯å£..."
    
    for port in eth2 eth3; do
        # è®¾ç½®ä¸ºè¾¹ç¼˜ç«¯å£ï¼ˆå¿«é€Ÿè½¬æ¢åˆ°è½¬å‘çŠ¶æ€ï¼‰
        echo 1 | sudo tee /sys/class/net/$port/brport/edge
        
        # å¯ç”¨BPDU guardï¼ˆè¾¹ç¼˜ç«¯å£æ”¶åˆ°BPDUæ—¶ç¦ç”¨ï¼‰
        echo 1 | sudo tee /sys/class/net/$port/brport/bpdu_guard
        
        echo "ç«¯å£ $port é…ç½®ä¸ºè¾¹ç¼˜ç«¯å£"
    done
    
    # é…ç½®ç‚¹å¯¹ç‚¹é“¾è·¯
    for port in eth1; do
        echo 1 | sudo tee /sys/class/net/$port/brport/point_to_point
        echo "ç«¯å£ $port é…ç½®ä¸ºç‚¹å¯¹ç‚¹é“¾è·¯"
    done
}

configure_rstp_ports br0
```

### 8.5 STPç›‘æ§ä¸æ•…éšœæ’æŸ¥

**ğŸ” STPçŠ¶æ€ç›‘æ§**

```bash
#!/bin/bash
# stp_monitor.sh

monitor_stp_status() {
    local bridge=$1
    
    while true; do
        clear
        echo "=== STPçŠ¶æ€ç›‘æ§ ($(date)) ==="
        echo
        
        # BridgeçŠ¶æ€
        echo "BridgeçŠ¶æ€:"
        echo "Root ID: $(cat /sys/class/net/$bridge/bridge/root_id)"
        echo "Bridge ID: $(cat /sys/class/net/$bridge/bridge/bridge_id)"
        echo "Root Port: $(cat /sys/class/net/$bridge/bridge/root_port)"
        echo "Root Path Cost: $(cat /sys/class/net/$bridge/bridge/root_path_cost)"
        echo
        
        # ç«¯å£çŠ¶æ€
        echo "ç«¯å£çŠ¶æ€:"
        printf "%-10s %-12s %-8s %-10s %-8s\n" "ç«¯å£" "çŠ¶æ€" "è§’è‰²" "ä»£ä»·" "ä¼˜å…ˆçº§"
        echo "------------------------------------------------"
        
        for port in $(ls /sys/class/net/$bridge/brif/); do
            state=$(cat /sys/class/net/$port/brport/state)
            role=$(cat /sys/class/net/$port/brport/role)
            cost=$(cat /sys/class/net/$port/brport/path_cost)
            priority=$(cat /sys/class/net/$port/brport/priority)
            
            # è½¬æ¢çŠ¶æ€æ•°å­—ä¸ºæ–‡å­—
            case $state in
                0) state_text="Disabled" ;;
                1) state_text="Listening" ;;
                2) state_text="Learning" ;;
                3) state_text="Forwarding" ;;
                4) state_text="Blocking" ;;
                *) state_text="Unknown" ;;
            esac
            
            # è½¬æ¢è§’è‰²æ•°å­—ä¸ºæ–‡å­—
            case $role in
                0) role_text="Disabled" ;;
                1) role_text="Root" ;;
                2) role_text="Designated" ;;
                3) role_text="Alternate" ;;
                4) role_text="Backup" ;;
                *) role_text="Unknown" ;;
            esac
            
            printf "%-10s %-12s %-8s %-10s %-8s\n" \
                $port $state_text $role_text $cost $priority
        done
        
        echo
        echo "æŒ‰Ctrl+Cé€€å‡ºç›‘æ§"
        sleep 3
    done
}

# STPé—®é¢˜è¯Šæ–­
diagnose_stp_issues() {
    local bridge=$1
    
    echo "=== STPé—®é¢˜è¯Šæ–­ ==="
    
    # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¯è·¯
    echo "1. æ£€æŸ¥æ‹“æ‰‘ç¯è·¯:"
    blocked_ports=$(find /sys/class/net/$bridge/brif -name "*/brport/state" -exec cat {} \; | grep -c "4")
    if [ $blocked_ports -gt 0 ]; then
        echo "  å‘ç° $blocked_ports ä¸ªé˜»å¡ç«¯å£ï¼Œæ‹“æ‰‘æ­£å¸¸"
    else
        echo "  è­¦å‘Šï¼šæ²¡æœ‰é˜»å¡ç«¯å£ï¼Œå¯èƒ½å­˜åœ¨æ‹“æ‰‘é—®é¢˜"
    fi
    
    # æ£€æŸ¥æ”¶æ•›æ—¶é—´
    echo "2. æ£€æŸ¥æ”¶æ•›æ—¶é—´:"
    hello_time=$(cat /sys/class/net/$bridge/bridge/hello_time)
    max_age=$(cat /sys/class/net/$bridge/bridge/max_age)
    forward_delay=$(cat /sys/class/net/$bridge/bridge/forward_delay)
    
    total_convergence=$((max_age + 2 * forward_delay))
    echo "  é¢„è®¡æœ€å¤§æ”¶æ•›æ—¶é—´: ${total_convergence}ç§’"
    
    if [ $total_convergence -gt 50 ]; then
        echo "  å»ºè®®ï¼šæ”¶æ•›æ—¶é—´è¾ƒé•¿ï¼Œè€ƒè™‘å¯ç”¨RSTP"
    fi
    
    # æ£€æŸ¥æ ¹æ¡¥é€‰æ‹©
    echo "3. æ£€æŸ¥æ ¹æ¡¥é€‰æ‹©:"
    root_id=$(cat /sys/class/net/$bridge/bridge/root_id)
    bridge_id=$(cat /sys/class/net/$bridge/bridge/bridge_id)
    
    if [ "$root_id" = "$bridge_id" ]; then
        echo "  å½“å‰è®¾å¤‡æ˜¯æ ¹æ¡¥"
    else
        echo "  æ ¹æ¡¥ID: $root_id"
    fi
}

# ä½¿ç”¨ç¤ºä¾‹
case "$1" in
    monitor)
        monitor_stp_status ${2:-br0}
        ;;
    diagnose)
        diagnose_stp_issues ${2:-br0}
        ;;
    *)
        echo "ç”¨æ³•: $0 {monitor|diagnose} [bridge_name]"
        ;;
esac
```

---

## 9. ğŸ”§ Bridgeæ•…éšœæ’æŸ¥


### 9.1 å¸¸è§Bridgeé—®é¢˜ç±»å‹

**ğŸš¨ Bridgeæ•…éšœåˆ†ç±»ä¸ç—‡çŠ¶**

```
ç½‘ç»œè¿é€šæ€§é—®é¢˜ï¼š
ç—‡çŠ¶ï¼šæ— æ³•pingé€šã€è¿æ¥è¶…æ—¶
åŸå› ï¼šæ¥å£é…ç½®é”™è¯¯ã€VLANé…ç½®é—®é¢˜

VLANéš”ç¦»é—®é¢˜ï¼š
ç—‡çŠ¶ï¼šè·¨VLANé€šä¿¡ã€å®‰å…¨ç­–ç•¥å¤±æ•ˆ
åŸå› ï¼šVLANé…ç½®é”™è¯¯ã€ç«¯å£æ¨¡å¼é”™è¯¯

æ€§èƒ½é—®é¢˜ï¼š
ç—‡çŠ¶ï¼šå»¶è¿Ÿé«˜ã€ä¸¢åŒ…ä¸¥é‡
åŸå› ï¼šå¹¿æ’­é£æš´ã€STPæ”¶æ•›æ…¢

é…ç½®åŒæ­¥é—®é¢˜ï¼š
ç—‡çŠ¶ï¼šé…ç½®ä¸¢å¤±ã€é‡å¯åå¤±æ•ˆ
åŸå› ï¼šé…ç½®æœªæŒä¹…åŒ–ã€æœåŠ¡å†²çª
```

### 9.2 BridgeåŸºç¡€æ•…éšœæ’æŸ¥

**ğŸ” ç³»ç»Ÿæ€§æ•…éšœè¯Šæ–­æµç¨‹**

```bash
#!/bin/bash
# bridge_troubleshoot.sh

basic_bridge_check() {
    local bridge=$1
    
    echo "=== BridgeåŸºç¡€æ£€æŸ¥ ==="
    
    # 1. æ£€æŸ¥bridgeæ˜¯å¦å­˜åœ¨
    if ! ip link show $bridge >/dev/null 2>&1; then
        echo "âŒ Bridge $bridge ä¸å­˜åœ¨"
        return 1
    else
        echo "âœ… Bridge $bridge å­˜åœ¨"
    fi
    
    # 2. æ£€æŸ¥bridgeçŠ¶æ€
    state=$(ip link show $bridge | grep -oE 'state [A-Z]+' | awk '{print $2}')
    if [ "$state" = "UP" ]; then
        echo "âœ… BridgeçŠ¶æ€: $state"
    else
        echo "âš ï¸  BridgeçŠ¶æ€: $state (åº”è¯¥æ˜¯UP)"
    fi
    
    # 3. æ£€æŸ¥æˆå‘˜æ¥å£
    echo "æˆå‘˜æ¥å£:"
    interfaces=$(bridge link show | grep "master $bridge" | awk '{print $2}' | cut -d: -f1)
    
    if [ -z "$interfaces" ]; then
        echo "âš ï¸  æ²¡æœ‰å‘ç°æˆå‘˜æ¥å£"
    else
        for iface in $interfaces; do
            iface_state=$(ip link show $iface | grep -oE 'state [A-Z]+' | awk '{print $2}')
            if [ "$iface_state" = "UP" ]; then
                echo "  âœ… $iface: $iface_state"
            else
                echo "  âŒ $iface: $iface_state"
            fi
        done
    fi
    
    # 4. æ£€æŸ¥IPé…ç½®
    ip_addr=$(ip addr show $bridge | grep 'inet ' | awk '{print $2}')
    if [ -n "$ip_addr" ]; then
        echo "IPåœ°å€: $ip_addr"
    else
        echo "âš ï¸  æœªé…ç½®IPåœ°å€"
    fi
}

check_vlan_config() {
    local bridge=$1
    
    echo "=== VLANé…ç½®æ£€æŸ¥ ==="
    
    # æ£€æŸ¥VLAN filteringçŠ¶æ€
    vlan_filtering=$(cat /sys/class/net/$bridge/bridge/vlan_filtering 2>/dev/null || echo "0")
    if [ "$vlan_filtering" = "1" ]; then
        echo "âœ… VLAN filteringå·²å¯ç”¨"
        
        # æ˜¾ç¤ºVLANé…ç½®
        echo "VLANé…ç½®è¯¦æƒ…:"
        bridge vlan show
        
        # æ£€æŸ¥PVIDé…ç½®
        echo "PVIDé…ç½®æ£€æŸ¥:"
        bridge vlan show | grep PVID | while read line; do
            port=$(echo $line | awk '{print $1}')
            pvid=$(echo $line | grep -oE '[0-9]+' | head -1)
            echo "  $port: PVID=$pvid"
        done
        
    else
        echo "âš ï¸  VLAN filteringæœªå¯ç”¨"
    fi
}

check_stp_status() {
    local bridge=$1
    
    echo "=== STPçŠ¶æ€æ£€æŸ¥ ==="
    
    stp_state=$(cat /sys/class/net/$bridge/bridge/stp_state 2>/dev/null || echo "0")
    if [ "$stp_state" = "1" ]; then
        echo "âœ… STPå·²å¯ç”¨"
        
        # æ˜¾ç¤ºSTPè¯¦ç»†ä¿¡æ¯
        echo "STPè¯¦ç»†çŠ¶æ€:"
        brctl showstp $bridge
        
        # æ£€æŸ¥æ˜¯å¦æœ‰é˜»å¡ç«¯å£
        blocked_ports=0
        for port in $(ls /sys/class/net/$bridge/brif/); do
            state=$(cat /sys/class/net/$port/brport/state)
            if [ "$state" = "4" ]; then  # BlockingçŠ¶æ€
                echo "  ç«¯å£ $port å¤„äºé˜»å¡çŠ¶æ€"
                blocked_ports=$((blocked_ports + 1))
            fi
        done
        
        if [ $blocked_ports -eq 0 ]; then
            echo "âš ï¸  æ²¡æœ‰é˜»å¡ç«¯å£ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¯è·¯"
        fi
        
    else
        echo "âš ï¸  STPæœªå¯ç”¨"
    fi
}

# ä¸»æ£€æŸ¥å‡½æ•°
main_check() {
    local bridge=${1:-br0}
    
    echo "å¼€å§‹æ£€æŸ¥Bridge: $bridge"
    echo "========================================"
    
    basic_bridge_check $bridge
    echo
    check_vlan_config $bridge
    echo
    check_stp_status $bridge
    
    echo
    echo "========================================"
    echo "æ£€æŸ¥å®Œæˆ"
}

# æ‰§è¡Œæ£€æŸ¥
main_check "$@"
```

### 9.3 ç½‘ç»œè¿é€šæ€§æ•…éšœæ’æŸ¥

**ğŸ”Œ è¿é€šæ€§é—®é¢˜æ·±åº¦è¯Šæ–­**

```bash
#!/bin/bash
# connectivity_troubleshoot.sh

test_basic_connectivity() {
    local bridge=$1
    local test_ip=${2:-"8.8.8.8"}
    
    echo "=== è¿é€šæ€§æµ‹è¯• ==="
    
    # 1. æµ‹è¯•bridgeæ¥å£æ˜¯å¦èƒ½pingé€š
    if ip addr show $bridge | grep -q 'inet '; then
        bridge_ip=$(ip addr show $bridge | grep 'inet ' | awk '{print $2}' | cut -d/ -f1)
        echo "Bridge IP: $bridge_ip"
        
        # è‡ªpingæµ‹è¯•
        if ping -c 2 -W 2 $bridge_ip >/dev/null 2>&1; then
            echo "âœ… Bridgeè‡ªpingæµ‹è¯•é€šè¿‡"
        else
            echo "âŒ Bridgeè‡ªpingæµ‹è¯•å¤±è´¥"
        fi
        
        # å¤–éƒ¨è¿é€šæ€§æµ‹è¯•
        if ping -c 2 -W 2 $test_ip >/dev/null 2>&1; then
            echo "âœ… å¤–éƒ¨è¿é€šæ€§æ­£å¸¸"
        else
            echo "âŒ å¤–éƒ¨è¿é€šæ€§å¤±è´¥"
        fi
    else
        echo "âš ï¸  Bridgeæœªé…ç½®IPåœ°å€ï¼Œè·³è¿‡pingæµ‹è¯•"
    fi
    
    # 2. æ£€æŸ¥ARPè¡¨
    echo "ARPè¡¨ä¿¡æ¯:"
    arp -a | head -5
    
    # 3. æ£€æŸ¥è·¯ç”±è¡¨
    echo "è·¯ç”±è¡¨ä¿¡æ¯:"
    ip route show | grep $bridge
}

test_vlan_connectivity() {
    local bridge=$1
    
    echo "=== VLANè¿é€šæ€§æµ‹è¯• ==="
    
    # æ£€æŸ¥VLANæ˜¯å¦æ­£ç¡®éš”ç¦»
    if [ "$(cat /sys/class/net/$bridge/bridge/vlan_filtering)" = "1" ]; then
        echo "æµ‹è¯•VLANéš”ç¦»..."
        
        # åˆ›å»ºæµ‹è¯•namespaceå’Œvethå¯¹
        for vlan in 100 200; do
            ns_name="test-vlan-$vlan"
            veth_name="veth-test-$vlan"
            veth_peer="veth-peer-$vlan"
            
            # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æµ‹è¯•ç¯å¢ƒ
            sudo ip netns delete $ns_name 2>/dev/null || true
            sudo ip link delete $veth_name 2>/dev/null || true
            
            # åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
            sudo ip netns add $ns_name
            sudo ip link add $veth_name type veth peer name $veth_peer
            sudo ip link set $veth_name master $bridge
            sudo ip link set $veth_peer netns $ns_name
            
            # é…ç½®VLAN
            sudo bridge vlan add vid $vlan dev $veth_name untagged pvid
            
            # é…ç½®IPåœ°å€
            sudo ip netns exec $ns_name ip addr add 192.168.$vlan.10/24 dev $veth_peer
            sudo ip netns exec $ns_name ip link set $veth_peer up
            sudo ip link set $veth_name up
            
            echo "åˆ›å»ºæµ‹è¯•ç¯å¢ƒ: VLAN $vlan (192.168.$vlan.10)"
        done
        
        # æµ‹è¯•åŒVLANè¿é€šæ€§ï¼ˆåº”è¯¥æˆåŠŸï¼‰
        echo "æµ‹è¯•VLANå†…é€šä¿¡..."
        
        # æµ‹è¯•è·¨VLANè¿é€šæ€§ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
        echo "æµ‹è¯•è·¨VLANé€šä¿¡..."
        if sudo ip netns exec test-vlan-100 ping -c 2 -W 2 192.168.200.10 >/dev/null 2>&1; then
            echo "âŒ è·¨VLANé€šä¿¡æˆåŠŸï¼ˆVLANéš”ç¦»å¤±æ•ˆï¼‰"
        else
            echo "âœ… è·¨VLANé€šä¿¡è¢«é˜»æ­¢ï¼ˆVLANéš”ç¦»æ­£å¸¸ï¼‰"
        fi
        
        # æ¸…ç†æµ‹è¯•ç¯å¢ƒ
        for vlan in 100 200; do
            sudo ip netns delete test-vlan-$vlan 2>/dev/null || true
            sudo ip link delete veth-test-$vlan 2>/dev/null || true
        done
        
    else
        echo "âš ï¸  VLAN filteringæœªå¯ç”¨ï¼Œè·³è¿‡VLANæµ‹è¯•"
    fi
}

check_mac_learning() {
    local bridge=$1
    
    echo "=== MACå­¦ä¹ æ£€æŸ¥ ==="
    
    # æ˜¾ç¤ºFDBè¡¨
    echo "å½“å‰FDBè¡¨:"
    bridge fdb show | head -10
    
    # æ£€æŸ¥FDBè¡¨å¤§å°
    fdb_size=$(bridge fdb show | wc -l)
    echo "FDBè¡¨æ¡ç›®æ•°: $fdb_size"
    
    # æ£€æŸ¥è€åŒ–æ—¶é—´
    ageing_time=$(cat /sys/class/net/$bridge/bridge/ageing_time)
    echo "MACè€åŒ–æ—¶é—´: ${ageing_time}ç§’"
    
    # æ£€æŸ¥æ˜¯å¦æœ‰å¤§é‡æœªçŸ¥MAC
    unknown_macs=$(bridge fdb show | grep "00:00:00:00:00:00" | wc -l)
    if [ $unknown_macs -gt 10 ]; then
        echo "âš ï¸  å‘ç°å¤§é‡æœªçŸ¥MACåœ°å€ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜"
    fi
}

# ä¸»æµ‹è¯•å‡½æ•°
run_connectivity_tests() {
    local bridge=${1:-br0}
    
    echo "å¼€å§‹è¿é€šæ€§æ•…éšœæ’æŸ¥: $bridge"
    echo "========================================"
    
    test_basic_connectivity $bridge
    echo
    test_vlan_connectivity $bridge
    echo
    check_mac_learning $bridge
    
    echo "========================================"
    echo "è¿é€šæ€§æµ‹è¯•å®Œæˆ"
}

run_connectivity_tests "$@"
```

### 9.4 æ€§èƒ½é—®é¢˜æ’æŸ¥

**ğŸ“Š Bridgeæ€§èƒ½åˆ†æä¸ä¼˜åŒ–**

```bash
#!/bin/bash
# bridge_performance_check.sh

check_interface_stats() {
    local bridge=$1
    
    echo "=== æ¥å£ç»Ÿè®¡ä¿¡æ¯ ==="
    
    # Bridgeæ¥å£ç»Ÿè®¡
    echo "Bridge $bridge ç»Ÿè®¡:"
    cat /sys/class/net/$bridge/statistics/rx_packets
    cat /sys/class/net/$bridge/statistics/tx_packets
    cat /sys/class/net/$bridge/statistics/rx_dropped
    cat /sys/class/net/$bridge/statistics/tx_dropped
    
    # æˆå‘˜æ¥å£ç»Ÿè®¡
    echo "æˆå‘˜æ¥å£ç»Ÿè®¡:"
    for iface in $(bridge link show | grep "master $bridge" | awk '{print $2}' | cut -d: -f1); do
        echo "æ¥å£ $iface:"
        echo "  RX packets: $(cat /sys/class/net/$iface/statistics/rx_packets)"
        echo "  TX packets: $(cat /sys/class/net/$iface/statistics/tx_packets)"
        echo "  RX dropped: $(cat /sys/class/net/$iface/statistics/rx_dropped)"
        echo "  TX dropped: $(cat /sys/class/net/$iface/statistics/tx_dropped)"
        echo "  RX errors:  $(cat /sys/class/net/$iface/statistics/rx_errors)"
        echo "  TX errors:  $(cat /sys/class/net/$iface/statistics/tx_errors)"
    done
}

check_broadcast_storm() {
    local bridge=$1
    local duration=${2:-10}
    
    echo "=== å¹¿æ’­é£æš´æ£€æµ‹ ==="
    
    # ç›‘æ§å¹¿æ’­åŒ…æ•°é‡
    echo "ç›‘æ§ ${duration} ç§’çš„å¹¿æ’­æµé‡..."
    
    initial_rx=$(cat /sys/class/net/$bridge/statistics/rx_packets)
    initial_multicast=$(cat /sys/class/net/$bridge/statistics/multicast)
    
    sleep $duration
    
    final_rx=$(cat /sys/class/net/$bridge/statistics/rx_packets)
    final_multicast=$(cat /sys/class/net/$bridge/statistics/multicast)
    
    rx_rate=$(( (final_rx - initial_rx) / duration ))
    multicast_rate=$(( (final_multicast - initial_multicast) / duration ))
    
    echo "æ¥æ”¶é€Ÿç‡: ${rx_rate} pps"
    echo "ç»„æ’­é€Ÿç‡: ${multicast_rate} pps"
    
    # åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¹¿æ’­é£æš´
    if [ $multicast_rate -gt 1000 ]; then
        echo "âš ï¸  å¯èƒ½å­˜åœ¨å¹¿æ’­é£æš´ (${multicast_rate} pps)"
        
        # æä¾›è§£å†³å»ºè®®
        echo "å»ºè®®è§£å†³æ–¹æ¡ˆ:"
        echo "1. æ£€æŸ¥STPé…ç½®"
        echo "2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¯è·¯"
        echo "3. é™åˆ¶å¹¿æ’­æµé‡"
    else
        echo "âœ… å¹¿æ’­æµé‡æ­£å¸¸"
    fi
}

monitor_bridge_load() {
    local bridge=$1
    local samples=${2:-12}  # 60ç§’é‡‡æ ·
    
    echo "=== Bridgeè´Ÿè½½ç›‘æ§ ==="
    
    for i in $(seq 1 $samples); do
        timestamp=$(date '+%H:%M:%S')
        
        # è·å–ç»Ÿè®¡ä¿¡æ¯
        rx_packets=$(cat /sys/class/net/$bridge/statistics/rx_packets)
        tx_packets=$(cat /sys/class/net/$bridge/statistics/tx_packets)
        
        if [ $i -gt 1 ]; then
            rx_rate=$(( (rx_packets - prev_rx) / 5 ))
            tx_rate=$(( (tx_packets - prev_tx) / 5 ))
            
            printf "%s RX: %6d pps, TX: %6d pps\n" $timestamp $rx_rate $tx_rate
            
            # æ£€æŸ¥æ˜¯å¦è¶…è¿‡é˜ˆå€¼
            if [ $rx_rate -gt 10000 ] || [ $tx_rate -gt 10000 ]; then
                echo "  âš ï¸  é«˜è´Ÿè½½è­¦å‘Š"
            fi
        else
            echo "$timestamp å¼€å§‹ç›‘æ§..."
        fi
        
        prev_rx=$rx_packets
        prev_tx=$tx_packets
        
        sleep 5
    done
}

# æ€§èƒ½ä¼˜åŒ–å»ºè®®
suggest_optimizations() {
    local bridge=$1
    
    echo "=== æ€§èƒ½ä¼˜åŒ–å»ºè®® ==="
    
    # æ£€æŸ¥å½“å‰é…ç½®
    hash_max=$(cat /sys/class/net/$bridge/bridge/hash_max)
    ageing_time=$(cat /sys/class/net/$bridge/bridge/ageing_time)
    
    echo "å½“å‰é…ç½®:"
    echo "  Hashè¡¨å¤§å°: $hash_max"
    echo "  MACè€åŒ–æ—¶é—´: ${ageing_time}ç§’"
    
    # æä¾›ä¼˜åŒ–å»ºè®®
    echo "ä¼˜åŒ–å»ºè®®:"
    
    if [ $hash_max -lt 4096 ]; then
        echo "1. å¢åŠ hashè¡¨å¤§å°:"
        echo "   echo 8192 > /sys/class/net/$bridge/bridge/hash_max"
    fi
    
    if [ $ageing_time -gt 600 ]; then
        echo "2. å‡å°‘MACè€åŒ–æ—¶é—´:"
        echo "   echo 300 > /sys/class/net/$bridge/bridge/ageing_time"
    fi
    
    # æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†ä¸å¿…è¦çš„åŠŸèƒ½
    if [ "$(cat /sys/class/net/$bridge/bridge/vlan_filtering)" = "0" ]; then
        echo "3. å¦‚ä¸éœ€è¦VLANï¼Œå»ºè®®ä¿æŒVLAN filteringå…³é—­"
    fi
    
    # STPä¼˜åŒ–å»ºè®®
    if [ "$(cat /sys/class/net/$bridge/bridge/stp_state)" = "1" ]; then
        echo "4. STPä¼˜åŒ–å»ºè®®:"
        echo "   - è€ƒè™‘ä½¿ç”¨RSTPæé«˜æ”¶æ•›é€Ÿåº¦"
        echo "   - ä¸ºè¾¹ç¼˜ç«¯å£å¯ç”¨PortFast"
    fi
}

# ä¸»æ€§èƒ½æ£€æŸ¥å‡½æ•°
run_performance_check() {
    local bridge=${1:-br0}
    
    echo "å¼€å§‹Bridgeæ€§èƒ½æ£€æŸ¥: $bridge"
    echo "========================================"
    
    check_interface_stats $bridge
    echo
    check_broadcast_storm $bridge
    echo
    monitor_bridge_load $bridge
    echo
    suggest_optimizations $bridge
    
    echo "========================================"
    echo "æ€§èƒ½æ£€æŸ¥å®Œæˆ"
}

run_performance_check "$@"
```

---

## 10. ğŸ—ï¸ ç½‘ç»œæ‹“æ‰‘è®¾è®¡è€ƒè™‘


### 10.1 Bridgeæ‹“æ‰‘è®¾è®¡åŸåˆ™

**ğŸ¯ ç½‘ç»œæ¶æ„è®¾è®¡åŸºç¡€**

```
æ‹“æ‰‘è®¾è®¡è€ƒè™‘å› ç´ ï¼š

å¯æ‰©å±•æ€§ï¼š
- æ”¯æŒæ¥å£æ•°é‡
- VLANæ•°é‡é™åˆ¶
- æ€§èƒ½ç“¶é¢ˆé¢„ä¼°

å¯é æ€§ï¼š
- å†—ä½™é“¾è·¯è®¾è®¡
- STP/RSTPé…ç½®
- æ•…éšœè‡ªåŠ¨æ¢å¤

å®‰å…¨æ€§ï¼š
- VLANéš”ç¦»ç­–ç•¥
- è®¿é—®æ§åˆ¶åˆ—è¡¨
- ç«¯å£å®‰å…¨é…ç½®

æ€§èƒ½ï¼š
- å¸¦å®½è§„åˆ’
- å»¶è¿Ÿä¼˜åŒ–
- å¹¿æ’­åŸŸæ§åˆ¶
```

**ğŸ”¸ å…¸å‹æ‹“æ‰‘æ¶æ„æ¨¡å¼**

```
å•Bridgeæ¶æ„ï¼š
[è®¾å¤‡1] â”€â”€ [è®¾å¤‡2] â”€â”€ [Bridge] â”€â”€ [è®¾å¤‡3] â”€â”€ [è®¾å¤‡4]
ä¼˜ç‚¹ï¼šç®€å•ã€æˆæœ¬ä½
ç¼ºç‚¹ï¼šå•ç‚¹æ•…éšœã€æ‰©å±•æ€§é™åˆ¶

å¤šBridgeæ¶æ„ï¼š
[è®¾å¤‡1] â”€â”¬â”€ [Bridge1] â”€â”¬â”€ [æ ¸å¿ƒBridge] â”€â”¬â”€ [Bridge2] â”€â”¬â”€ [è®¾å¤‡4]
         â””â”€ [è®¾å¤‡2]    â”‚                â”‚            â””â”€ [è®¾å¤‡5]
                      â””â”€ [Bridge3] â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹ï¼šé«˜å¯ç”¨ã€è´Ÿè½½åˆ†æ‹…
ç¼ºç‚¹ï¼šé…ç½®å¤æ‚ã€æˆæœ¬è¾ƒé«˜
```

### 10.2 VLANæ‹“æ‰‘è§„åˆ’

**ğŸ“Š VLANç½‘ç»œåˆ†æ®µè®¾è®¡**

```bash
#!/bin/bash
# vlan_topology_planner.sh

design_vlan_topology() {
    echo "=== VLANæ‹“æ‰‘è®¾è®¡åŠ©æ‰‹ ==="
    
    # VLANåˆ†é…ç­–ç•¥
    declare -A vlan_plan=(
        ["ç®¡ç†ç½‘ç»œ"]="10"
        ["ç”Ÿäº§æœåŠ¡å™¨"]="100"
        ["æµ‹è¯•ç¯å¢ƒ"]="200"
        ["å¼€å‘ç¯å¢ƒ"]="300"
        ["DMZåŒºåŸŸ"]="400"
        ["å®¢æˆ·ç«¯ç½‘ç»œ"]="500"
    )
    
    echo "æ¨èVLANåˆ†é…æ–¹æ¡ˆï¼š"
    for segment in "${!vlan_plan[@]}"; do
        echo "  $segment: VLAN ${vlan_plan[$segment]}"
    done
    
    echo
    echo "IPåœ°å€åˆ†é…å»ºè®®ï¼š"
    for segment in "${!vlan_plan[@]}"; do
        vlan_id=${vlan_plan[$segment]}
        echo "  $segment (VLAN $vlan_id): 192.168.$vlan_id.0/24"
    done
}

calculate_vlan_requirements() {
    local total_devices=$1
    local departments=$2
    local security_levels=$3
    
    echo "=== VLANéœ€æ±‚è®¡ç®— ==="
    echo "æ€»è®¾å¤‡æ•°: $total_devices"
    echo "éƒ¨é—¨æ•°é‡: $departments"
    echo "å®‰å…¨çº§åˆ«: $security_levels"
    
    # è®¡ç®—æ¨èVLANæ•°é‡
    base_vlans=5  # ç®¡ç†ã€DMZã€ä¸´æ—¶ç­‰åŸºç¡€VLAN
    dept_vlans=$departments
    security_vlans=$((security_levels * 2))  # æ¯ä¸ªå®‰å…¨çº§åˆ«2ä¸ªVLAN
    
    total_vlans=$((base_vlans + dept_vlans + security_vlans))
    
    echo "æ¨èVLANæ•°é‡: $total_vlans"
    
    # æ£€æŸ¥æ˜¯å¦è¶…è¿‡æ ‡å‡†é™åˆ¶
    if [ $total_vlans -gt 100 ]; then
        echo "âš ï¸  VLANæ•°é‡è¾ƒå¤šï¼Œå»ºè®®é‡‡ç”¨åˆ†å±‚æ¶æ„"
    elif [ $total_vlans -gt 50 ]; then
        echo "âš ï¸  VLANæ•°é‡ä¸­ç­‰ï¼Œæ³¨æ„æ€§èƒ½å½±å“"
    else
        echo "âœ… VLANæ•°é‡åˆç†"
    fi
}

design_vlan_topology
echo
calculate_vlan_requirements 200 8 3
```

### 10.3 é«˜å¯ç”¨æ€§æ¶æ„è®¾è®¡

**ğŸ”„ å†—ä½™å’Œæ•…éšœæ¢å¤è®¾è®¡**

```bash
# é«˜å¯ç”¨Bridgeé…ç½®æ¨¡æ¿
#!/bin/bash
# ha_bridge_setup.sh

setup_redundant_bridges() {
    echo "=== é«˜å¯ç”¨Bridgeé…ç½® ==="
    
    # åˆ›å»ºä¸»å¤‡Bridge
    PRIMARY_BR="br-primary"
    BACKUP_BR="br-backup"
    
    # ä¸»Bridgeé…ç½®
    sudo ip link add name $PRIMARY_BR type bridge vlan_filtering 1
    sudo ip link set $PRIMARY_BR type bridge stp_state 1
    sudo ip link set $PRIMARY_BR type bridge priority 4096  # é«˜ä¼˜å…ˆçº§
    
    # å¤‡Bridgeé…ç½®
    sudo ip link add name $BACKUP_BR type bridge vlan_filtering 1
    sudo ip link set $BACKUP_BR type bridge stp_state 1
    sudo ip link set $BACKUP_BR type bridge priority 8192  # ä½ä¼˜å…ˆçº§
    
    echo "ä¸»å¤‡Bridgeåˆ›å»ºå®Œæˆ"
    
    # é…ç½®é“¾è·¯èšåˆï¼ˆå¯é€‰ï¼‰
    setup_link_aggregation
}

setup_link_aggregation() {
    echo "é…ç½®é“¾è·¯èšåˆ..."
    
    # åˆ›å»ºbondingæ¥å£
    sudo ip link add bond0 type bond mode 802.3ad
    sudo ip link set eth1 master bond0
    sudo ip link set eth2 master bond0
    
    # å°†bondingæ¥å£æ·»åŠ åˆ°Bridge
    sudo ip link set bond0 master br-primary
    
    echo "é“¾è·¯èšåˆé…ç½®å®Œæˆ"
}

configure_vrrp_failover() {
    echo "é…ç½®VRRPæ•…éšœåˆ‡æ¢..."
    
    # å®‰è£…keepalived
    if ! command -v keepalived >/dev/null 2>&1; then
        sudo apt update
        sudo apt install -y keepalived
    fi
    
    # VRRPé…ç½®æ–‡ä»¶
    sudo tee /etc/keepalived/keepalived.conf << EOF
vrrp_script chk_bridge {
    script "/usr/local/bin/check_bridge.sh"
    interval 2
    weight -2
    fall 3
    rise 2
}

vrrp_instance VI_1 {
    state MASTER
    interface br-primary
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass bridge123
    }
    virtual_ipaddress {
        192.168.1.100/24
    }
    track_script {
        chk_bridge
    }
}
EOF

    # Bridgeæ£€æŸ¥è„šæœ¬
    sudo tee /usr/local/bin/check_bridge.sh << 'EOF'
#!/bin/bash
# æ£€æŸ¥BridgeçŠ¶æ€
if ip link show br-primary | grep -q "state UP"; then
    # æ£€æŸ¥æ¥å£æ˜¯å¦æ­£å¸¸
    if [ $(bridge link show | grep "master br-primary" | wc -l) -gt 0 ]; then
        exit 0  # Bridgeæ­£å¸¸
    fi
fi
exit 1  # Bridgeå¼‚å¸¸
EOF
    
    sudo chmod +x /usr/local/bin/check_bridge.sh
    sudo systemctl enable keepalived
    sudo systemctl start keepalived
    
    echo "VRRPæ•…éšœåˆ‡æ¢é…ç½®å®Œæˆ"
}

# æ‰§è¡Œé«˜å¯ç”¨é…ç½®
setup_redundant_bridges
configure_vrrp_failover
```

### 10.4 æ€§èƒ½ä¼˜åŒ–æ‹“æ‰‘è®¾è®¡

**âš¡ é«˜æ€§èƒ½ç½‘ç»œæ¶æ„**

```bash
#!/bin/bash
# performance_topology_design.sh

design_high_performance_topology() {
    echo "=== é«˜æ€§èƒ½æ‹“æ‰‘è®¾è®¡ ==="
    
    # åˆ†å±‚æ¶æ„è®¾è®¡
    echo "1. ä¸‰å±‚ç½‘ç»œæ¶æ„ï¼š"
    echo "   æ ¸å¿ƒå±‚ (Core) - é«˜é€Ÿè½¬å‘"
    echo "   æ±‡èšå±‚ (Aggregation) - VLANæ±‡èš"
    echo "   æ¥å…¥å±‚ (Access) - ç»ˆç«¯æ¥å…¥"
    
    # æ ¸å¿ƒå±‚Bridgeé…ç½®
    configure_core_bridge() {
        local bridge="br-core"
        
        sudo ip link add name $bridge type bridge vlan_filtering 1
        
        # æ€§èƒ½ä¼˜åŒ–å‚æ•°
        echo 16384 | sudo tee /sys/class/net/$bridge/bridge/hash_max
        echo 180 | sudo tee /sys/class/net/$bridge/bridge/ageing_time
        
        # å¯ç”¨RSTPå¿«é€Ÿæ”¶æ•›
        sudo ip link set $bridge type bridge stp_state 1
        echo 2 | sudo tee /sys/class/net/$bridge/bridge/stp_protocol  # RSTP
        
        echo "æ ¸å¿ƒBridgeé…ç½®å®Œæˆ"
    }
    
    # æ±‡èšå±‚Bridgeé…ç½®
    configure_aggregation_bridge() {
        local bridge="br-agg"
        
        sudo ip link add name $bridge type bridge vlan_filtering 1
        
        # ä¸­ç­‰æ€§èƒ½å‚æ•°
        echo 8192 | sudo tee /sys/class/net/$bridge/bridge/hash_max
        echo 300 | sudo tee /sys/class/net/$bridge/bridge/ageing_time
        
        # é…ç½®VLAN Trunkåˆ°æ ¸å¿ƒå±‚
        # è¿™é‡Œä¼šè¿æ¥åˆ°æ ¸å¿ƒBridge
        
        echo "æ±‡èšBridgeé…ç½®å®Œæˆ"
    }
    
    # æ¥å…¥å±‚Bridgeé…ç½®
    configure_access_bridge() {
        local bridge="br-access"
        
        sudo ip link add name $bridge type bridge vlan_filtering 1
        
        # åŸºç¡€æ€§èƒ½å‚æ•°
        echo 4096 | sudo tee /sys/class/net/$bridge/bridge/hash_max
        echo 600 | sudo tee /sys/class/net/$bridge/bridge/ageing_time
        
        echo "æ¥å…¥Bridgeé…ç½®å®Œæˆ"
    }
    
    configure_core_bridge
    configure_aggregation_bridge  
    configure_access_bridge
}

optimize_bridge_performance() {
    local bridge=$1
    
    echo "=== Bridgeæ€§èƒ½ä¼˜åŒ– ==="
    
    # CPUäº²å’Œæ€§è®¾ç½®
    echo "è®¾ç½®ç½‘ç»œä¸­æ–­CPUäº²å’Œæ€§..."
    
    # è·å–ç½‘ç»œæ¥å£çš„ä¸­æ–­å·
    for iface in $(bridge link show | grep "master $bridge" | awk '{print $2}' | cut -d: -f1); do
        # æŸ¥æ‰¾æ¥å£çš„ä¸­æ–­å·
        irq=$(cat /proc/interrupts | grep $iface | awk '{print $1}' | tr -d ':')
        
        if [ -n "$irq" ]; then
            # ç»‘å®šåˆ°ç‰¹å®šCPUï¼ˆè¿™é‡Œç»‘å®šåˆ°CPU 2å’Œ3ï¼‰
            echo 0c | sudo tee /proc/irq/$irq/smp_affinity
            echo "æ¥å£ $iface (IRQ $irq) ç»‘å®šåˆ°CPU 2-3"
        fi
    done
    
    # è°ƒæ•´ç½‘ç»œç¼“å†²åŒºå¤§å°
    echo "è°ƒæ•´ç½‘ç»œç¼“å†²åŒº..."
    echo 'net.core.rmem_max = 268435456' | sudo tee -a /etc/sysctl.conf
    echo 'net.core.wmem_max = 268435456' | sudo tee -a /etc/sysctl.conf
    echo 'net.core.netdev_max_backlog = 5000' | sudo tee -a /etc/sysctl.conf
    
    # åº”ç”¨é…ç½®
    sudo sysctl -p
    
    echo "æ€§èƒ½ä¼˜åŒ–å®Œæˆ"
}

# ç½‘ç»œæµé‡åˆ†æå’Œä¼˜åŒ–å»ºè®®
analyze_traffic_patterns() {
    local bridge=$1
    
    echo "=== æµé‡æ¨¡å¼åˆ†æ ==="
    
    # ç›‘æ§å„æ¥å£æµé‡
    echo "æ¥å£æµé‡ç»Ÿè®¡ (é‡‡æ ·60ç§’):"
    
    declare -A initial_stats
    declare -A final_stats
    
    # åˆå§‹ç»Ÿè®¡
    for iface in $(bridge link show | grep "master $bridge" | awk '{print $2}' | cut -d: -f1); do
        initial_stats["${iface}_rx"]=$(cat /sys/class/net/$iface/statistics/rx_packets)
        initial_stats["${iface}_tx"]=$(cat /sys/class/net/$iface/statistics/tx_packets)
    done
    
    echo "å¼€å§‹ç›‘æ§..."
    sleep 60
    
    # æœ€ç»ˆç»Ÿè®¡
    echo "æµé‡åˆ†æç»“æœ:"
    for iface in $(bridge link show | grep "master $bridge" | awk '{print $2}' | cut -d: -f1); do
        final_rx=$(cat /sys/class/net/$iface/statistics/rx_packets)
        final_tx=$(cat /sys/class/net/$iface/statistics/tx_packets)
        
        rx_rate=$(( (final_rx - initial_stats["${iface}_rx"]) / 60 ))
        tx_rate=$(( (final_tx - initial_stats["${iface}_tx"]) / 60 ))
        
        echo "  $iface: RX ${rx_rate} pps, TX ${tx_rate} pps"
        
        # åŸºäºæµé‡æä¾›ä¼˜åŒ–å»ºè®®
        if [ $rx_rate -gt 1000 ] || [ $tx_rate -gt 1000 ]; then
            echo "    å»ºè®®: é«˜æµé‡æ¥å£ï¼Œè€ƒè™‘é“¾è·¯èšåˆæˆ–å‡çº§å¸¦å®½"
        fi
    done
}

# æ‰§è¡Œæ‹“æ‰‘è®¾è®¡
design_high_performance_topology
echo
optimize_bridge_performance br-core
echo
analyze_traffic_patterns br-core
```

### 10.5 å®‰å…¨æ‹“æ‰‘è®¾è®¡

**ğŸ”’ ç½‘ç»œå®‰å…¨æ¶æ„è€ƒè™‘**

```bash
#!/bin/bash
# security_topology_design.sh

design_security_zones() {
    echo "=== å®‰å…¨åŒºåŸŸæ‹“æ‰‘è®¾è®¡ ==="
    
    # å®šä¹‰å®‰å…¨åŒºåŸŸ
    declare -A security_zones=(
        ["dmz"]="VLAN 10"
        ["internal"]="VLAN 20-30"  
        ["guest"]="VLAN 40"
        ["management"]="VLAN 50"
        ["isolated"]="VLAN 60-70"
    )
    
    echo "å®‰å…¨åŒºåŸŸè§„åˆ’:"
    for zone in "${!security_zones[@]}"; do
        echo "  $zone åŒºåŸŸ: ${security_zones[$zone]}"
    done
    
    # åˆ›å»ºå®‰å…¨Bridge
    create_security_bridges
}

create_security_bridges() {
    echo
    echo "åˆ›å»ºå®‰å…¨Bridgeé…ç½®:"
    
    # DMZ Bridge (å¯¹å¤–æœåŠ¡)
    sudo ip link add name br-dmz type bridge vlan_filtering 1
    sudo ip link set br-dmz type bridge stp_state 1
    
    # å†…ç½‘Bridge (å†…éƒ¨æœåŠ¡)  
    sudo ip link add name br-internal type bridge vlan_filtering 1
    sudo ip link set br-internal type bridge stp_state 1
    
    # éš”ç¦»Bridge (é«˜å®‰å…¨åŒºåŸŸ)
    sudo ip link add name br-isolated type bridge vlan_filtering 1
    sudo ip link set br-isolated type bridge stp_state 1
    
    # ç®¡ç†Bridge (ç½‘ç»œç®¡ç†)
    sudo ip link add name br-mgmt type bridge vlan_filtering 1
    sudo ip link set br-mgmt type bridge stp_state 1
    
    echo "å®‰å…¨Bridgeåˆ›å»ºå®Œæˆ"
}

configure_inter_vlan_rules() {
    echo
    echo "=== é…ç½®VLANé—´è®¿é—®æ§åˆ¶ ==="
    
    # ä½¿ç”¨ebtablesé…ç½®äºŒå±‚è®¿é—®æ§åˆ¶
    if ! command -v ebtables >/dev/null 2>&1; then
        sudo apt update
        sudo apt install -y ebtables
    fi
    
    # ç¤ºä¾‹ï¼šé˜»æ­¢VLAN 40(Guest)è®¿é—®VLAN 20(Internal)
    sudo ebtables -t filter -A FORWARD \
        --logical-in br-internal \
        --logical-out br-internal \
        -p IPv4 --ip-src 192.168.40.0/24 \
        --ip-dst 192.168.20.0/24 \
        -j DROP
    
    echo "VLANé—´è®¿é—®æ§åˆ¶é…ç½®å®Œæˆ"
    
    # é…ç½®é˜²ç«å¢™è§„åˆ™
    configure_firewall_rules
}

configure_firewall_rules() {
    echo "é…ç½®é˜²ç«å¢™è§„åˆ™..."
    
    # åŸºç¡€é˜²ç«å¢™è§„åˆ™
    sudo iptables -F  # æ¸…ç©ºç°æœ‰è§„åˆ™
    sudo iptables -P INPUT DROP
    sudo iptables -P FORWARD DROP
    sudo iptables -P OUTPUT ACCEPT
    
    # å…è®¸æœ¬åœ°å›ç¯
    sudo iptables -A INPUT -i lo -j ACCEPT
    
    # å…è®¸å·²å»ºç«‹çš„è¿æ¥
    sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
    sudo iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
    
    # DMZåŒºåŸŸè§„åˆ™ï¼ˆVLAN 10ï¼‰
    sudo iptables -A FORWARD -i br-dmz -o br-internal -j DROP
    sudo iptables -A FORWARD -i br-internal -o br-dmz -j ACCEPT
    
    # Guestç½‘ç»œè§„åˆ™ï¼ˆVLAN 40ï¼‰
    sudo iptables -A FORWARD -i br-guest -o br-internal -j DROP
    sudo iptables -A FORWARD -i br-guest -o br-mgmt -j DROP
    
    # ç®¡ç†ç½‘ç»œè§„åˆ™ï¼ˆVLAN 50ï¼‰
    sudo iptables -A FORWARD -i br-mgmt -j ACCEPT  # ç®¡ç†ç½‘ç»œå¯è®¿é—®æ‰€æœ‰åŒºåŸŸ
    
    # ä¿å­˜è§„åˆ™
    sudo iptables-save > /etc/iptables/rules.v4
    
    echo "é˜²ç«å¢™è§„åˆ™é…ç½®å®Œæˆ"
}

implement_port_security() {
    local bridge=$1
    local port=$2
    local max_macs=${3:-1}
    
    echo "=== ç«¯å£å®‰å…¨é…ç½® ==="
    echo "Bridge: $bridge, Port: $port, æœ€å¤§MACæ•°: $max_macs"
    
    # åˆ›å»ºMACå­¦ä¹ é™åˆ¶è„šæœ¬
    cat > /usr/local/bin/port_security_${bridge}_${port}.sh << EOF
#!/bin/bash
# ç«¯å£å®‰å…¨ç›‘æ§è„šæœ¬

BRIDGE="$bridge"
PORT="$port" 
MAX_MACS="$max_macs"

while true; do
    # è·å–ç«¯å£å½“å‰MACæ•°é‡
    mac_count=\$(bridge fdb show | grep "\$PORT" | wc -l)
    
    if [ \$mac_count -gt \$MAX_MACS ]; then
        echo "\$(date): ç«¯å£ \$PORT MACæ•°é‡è¶…é™: \$mac_count > \$MAX_MACS"
        
        # å¯ä»¥é€‰æ‹©ç¦ç”¨ç«¯å£æˆ–åˆ é™¤å¤šä½™MAC
        # sudo ip link set \$PORT down
        
        # æˆ–è€…åˆ é™¤æœ€è€çš„MACæ¡ç›®
        bridge fdb show | grep "\$PORT" | head -n \$((mac_count - MAX_MACS)) | \
        while read line; do
            mac=\$(echo \$line | awk '{print \$1}')
            bridge fdb del \$mac dev \$PORT
            echo "åˆ é™¤MAC: \$mac"
        done
    fi
    
    sleep 30
done
EOF
    
    chmod +x /usr/local/bin/port_security_${bridge}_${port}.sh
    
    # åˆ›å»ºsystemdæœåŠ¡
    cat > /etc/systemd/system/port-security-${bridge}-${port}.service << EOF
[Unit]
Description=Port Security for ${bridge} ${port}
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/port_security_${bridge}_${port}.sh
Restart=always
User=root

[Install]
WantedBy=multi-user.target
EOF
    
    sudo systemctl daemon-reload
    sudo systemctl enable port-security-${bridge}-${port}.service
    sudo systemctl start port-security-${bridge}-${port}.service
    
    echo "ç«¯å£å®‰å…¨æœåŠ¡å·²å¯åŠ¨"
}

# å®‰å…¨ç›‘æ§å’Œå®¡è®¡
setup_security_monitoring() {
    echo "=== é…ç½®å®‰å…¨ç›‘æ§ ==="
    
    # åˆ›å»ºå®‰å…¨äº‹ä»¶ç›‘æ§è„šæœ¬
    cat > /usr/local/bin/bridge_security_monitor.sh << 'EOF'
#!/bin/bash
# Bridgeå®‰å…¨ç›‘æ§è„šæœ¬

LOG_FILE="/var/log/bridge_security.log"

log_security_event() {
    echo "$(date): $1" | tee -a $LOG_FILE
}

monitor_mac_changes() {
    # ç›‘æ§MACåœ°å€å˜åŒ–
    bridge fdb show | sort > /tmp/fdb_current
    
    if [ -f /tmp/fdb_previous ]; then
        # æ£€æŸ¥æ–°å¢MAC
        new_macs=$(diff /tmp/fdb_previous /tmp/fdb_current | grep "^>" | wc -l)
        if [ $new_macs -gt 0 ]; then
            log_security_event "æ£€æµ‹åˆ° $new_macs ä¸ªæ–°MACåœ°å€"
            diff /tmp/fdb_previous /tmp/fdb_current | grep "^>" >> $LOG_FILE
        fi
        
        # æ£€æŸ¥æ¶ˆå¤±çš„MAC
        removed_macs=$(diff /tmp/fdb_previous /tmp/fdb_current | grep "^<" | wc -l)
        if [ $removed_macs -gt 0 ]; then
            log_security_event "æ£€æµ‹åˆ° $removed_macs ä¸ªMACåœ°å€æ¶ˆå¤±"
        fi
    fi
    
    mv /tmp/fdb_current /tmp/fdb_previous
}

monitor_port_status() {
    # ç›‘æ§ç«¯å£çŠ¶æ€å˜åŒ–
    for bridge in $(bridge link show | grep "master" | awk '{print $NF}' | sort -u); do
        bridge link show | grep "master $bridge" > /tmp/ports_${bridge}_current
        
        if [ -f /tmp/ports_${bridge}_previous ]; then
            if ! diff -q /tmp/ports_${bridge}_previous /tmp/ports_${bridge}_current >/dev/null; then
                log_security_event "Bridge $bridge ç«¯å£çŠ¶æ€å‘ç”Ÿå˜åŒ–"
                diff /tmp/ports_${bridge}_previous /tmp/ports_${bridge}_current >> $LOG_FILE
            fi
        fi
        
        mv /tmp/ports_${bridge}_current /tmp/ports_${bridge}_previous
    done
}

# ä¸»ç›‘æ§å¾ªç¯
while true; do
    monitor_mac_changes
    monitor_port_status
    sleep 60
done
EOF
    
    chmod +x /usr/local/bin/bridge_security_monitor.sh
    
    # åˆ›å»ºç›‘æ§æœåŠ¡
    cat > /etc/systemd/system/bridge-security-monitor.service << EOF
[Unit]
Description=Bridge Security Monitor
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/bridge_security_monitor.sh
Restart=always
User=root

[Install]
WantedBy=multi-user.target
EOF
    
    sudo systemctl daemon-reload
    sudo systemctl enable bridge-security-monitor.service
    sudo systemctl start bridge-security-monitor.service
    
    echo "å®‰å…¨ç›‘æ§æœåŠ¡å·²å¯åŠ¨"
}

# æ‰§è¡Œå®‰å…¨æ‹“æ‰‘é…ç½®
design_security_zones
configure_inter_vlan_rules
implement_port_security br-internal eth3 2
setup_security_monitoring

echo
echo "=== å®‰å…¨æ‹“æ‰‘è®¾è®¡å®Œæˆ ==="
echo "å»ºè®®å®šæœŸæ£€æŸ¥:"
echo "1. æŸ¥çœ‹å®‰å…¨æ—¥å¿—: tail -f /var/log/bridge_security.log"
echo "2. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™: iptables -L -n"
echo "3. éªŒè¯VLANéš”ç¦»: è¿›è¡Œè·¨VLANè¿é€šæ€§æµ‹è¯•"
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ BridgeåŸºç¡€ï¼šäºŒå±‚äº¤æ¢è®¾å¤‡ï¼Œè¿æ¥å¤šä¸ªç½‘ç»œæ®µï¼Œæ”¯æŒMACå­¦ä¹ 
ğŸ”¸ VLANé›†æˆï¼šVLAN aware bridgeå®ç°ç½‘ç»œéš”ç¦»å’Œæµé‡ç®¡ç†
ğŸ”¸ ç«¯å£é…ç½®ï¼šAccessã€Trunkã€Hybridç«¯å£çš„é…ç½®å’Œåº”ç”¨
ğŸ”¸ PVIDç®¡ç†ï¼šå¤„ç†æ— æ ‡ç­¾æµé‡çš„å…³é”®æœºåˆ¶
ğŸ”¸ STPè°ƒä¼˜ï¼šç”Ÿæˆæ ‘åè®®é˜²ç¯è·¯å’Œæ€§èƒ½ä¼˜åŒ–
ğŸ”¸ æ•…éšœæ’æŸ¥ï¼šç³»ç»ŸåŒ–çš„Bridgeé—®é¢˜è¯Šæ–­å’Œè§£å†³
ğŸ”¸ æ‹“æ‰‘è®¾è®¡ï¼šé«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€å®‰å…¨ç½‘ç»œæ¶æ„è§„åˆ’
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Bridgeä¸VLANçš„åä½œæœºåˆ¶**
```
å·¥ä½œæµç¨‹ç†è§£ï¼š
- æ•°æ®å¸§è¿›å…¥Bridge â†’ æ£€æŸ¥VLANæ ‡ç­¾ â†’ æŸ¥æ‰¾è½¬å‘è¡¨ â†’ é€‰æ‹©å‡ºå£ç«¯å£
- Taggedç«¯å£ï¼šä¿æŒVLANæ ‡ç­¾ä¼ è¾“
- Untaggedç«¯å£ï¼šæ·»åŠ /ç§»é™¤VLANæ ‡ç­¾
- PVIDä½œç”¨ï¼šä¸ºæ— æ ‡ç­¾æµé‡åˆ†é…é»˜è®¤VLAN
```

**ğŸ”¹ ä¸åŒç«¯å£æ¨¡å¼çš„åº”ç”¨åœºæ™¯**
```
Accessç«¯å£ï¼š
- è¿æ¥ç»ˆç«¯è®¾å¤‡ï¼ˆPCã€æœåŠ¡å™¨ã€æ‰“å°æœºï¼‰
- åªå±äºä¸€ä¸ªVLANï¼Œç®€åŒ–ç»ˆç«¯é…ç½®

Trunkç«¯å£ï¼š  
- è¿æ¥äº¤æ¢æœºã€è·¯ç”±å™¨ç­‰ç½‘ç»œè®¾å¤‡
- ä¼ è¾“å¤šä¸ªVLANï¼ŒèŠ‚çº¦ç‰©ç†ç«¯å£

Hybridç«¯å£ï¼š
- å¤æ‚ç½‘ç»œç¯å¢ƒçš„çµæ´»é…ç½®
- éƒ¨åˆ†VLAN taggedï¼Œéƒ¨åˆ†untagged
```

**ğŸ”¹ STPåœ¨Bridgeç¯å¢ƒä¸­çš„é‡è¦æ€§**
```
ç¯è·¯é—®é¢˜ï¼š
- ç‰©ç†å†—ä½™é“¾è·¯å¯èƒ½å½¢æˆäºŒå±‚ç¯è·¯
- ç¯è·¯å¯¼è‡´å¹¿æ’­é£æš´å’ŒMACè¡¨éœ‡è¡

STPè§£å†³æ–¹æ¡ˆï¼š
- é€»è¾‘é˜»å¡å†—ä½™è·¯å¾„
- ä¸»è·¯å¾„æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢
- æ”¶æ•›æ—¶é—´å½±å“ç½‘ç»œå¯ç”¨æ€§
```

### 11.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒåº”ç”¨åœºæ™¯**
- **æ•°æ®ä¸­å¿ƒ**ï¼šè™šæ‹ŸåŒ–ç¯å¢ƒçš„ç½‘ç»œéš”ç¦»å’Œè¿é€šæ€§
- **ä¼ä¸šç½‘ç»œ**ï¼šéƒ¨é—¨VLANåˆ’åˆ†å’Œå®‰å…¨ç­–ç•¥å®æ–½
- **äº‘å¹³å°**ï¼šå®¹å™¨å’Œè™šæ‹Ÿæœºçš„ç½‘ç»œç®¡ç†
- **æ ¡å›­ç½‘ç»œ**ï¼šå­¦ç”Ÿã€æ•™èŒå·¥ã€ç®¡ç†ç½‘ç»œçš„åˆ†ç¦»

**ğŸ”§ è¿ç»´å®è·µå»ºè®®**
- **é…ç½®æ ‡å‡†åŒ–**ï¼šå»ºç«‹ç»Ÿä¸€çš„Bridgeå’ŒVLANé…ç½®è§„èŒƒ
- **ç›‘æ§ä½“ç³»**ï¼šå®æ–½å…¨é¢çš„ç½‘ç»œçŠ¶æ€å’Œæ€§èƒ½ç›‘æ§
- **æ•…éšœé¢„æ¡ˆ**ï¼šåˆ¶å®šè¯¦ç»†çš„æ•…éšœæ’æŸ¥å’Œæ¢å¤æµç¨‹
- **å®‰å…¨åŠ å›º**ï¼šå®æ–½ç«¯å£å®‰å…¨ã€è®¿é—®æ§åˆ¶å’Œå®¡è®¡æœºåˆ¶

**ğŸ“ˆ æŠ€æœ¯å‘å±•è¶‹åŠ¿**
- **è½¯ä»¶å®šä¹‰ç½‘ç»œ**ï¼šSDNæ§åˆ¶å™¨ç®¡ç†Bridgeé…ç½®
- **å®¹å™¨ç½‘ç»œæ¥å£**ï¼šCNIä¸Bridgeçš„æ·±åº¦é›†æˆ
- **ç½‘ç»œè™šæ‹ŸåŒ–**ï¼šVXLANã€NVGREç­‰éš§é“æŠ€æœ¯
- **æ™ºèƒ½åŒ–è¿ç»´**ï¼šAIè¾…åŠ©çš„ç½‘ç»œæ•…éšœè¯Šæ–­å’Œä¼˜åŒ–

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Bridgeè¿é€šå¤šç½‘æ®µï¼ŒVLANéš”ç¦»ä¿å®‰å…¨
- Accesså•ä¸€Trunkå¤šï¼ŒPVIDå¤„ç†æ— æ ‡ç­¾
- STPé˜²ç¯è·¯é˜»å¡ï¼Œæ•…éšœåˆ‡æ¢ä¿å¯ç”¨  
- ç›‘æ§æ’æŸ¥è¦åŠæ—¶ï¼Œæ‹“æ‰‘è®¾è®¡éœ€å‘¨å…¨