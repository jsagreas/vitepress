---
title: 3、Linux系统VLAN配置实践
---
## 📚 目录

1. [VLAN技术基础](#1-VLAN技术基础)
2. [ip命令创建VLAN接口](#2-ip命令创建VLAN接口)
3. [vconfig工具使用方法](#3-vconfig工具使用方法)
4. [VLAN信息查看与监控](#4-VLAN信息查看与监控)
5. [各发行版VLAN配置方法](#5-各发行版VLAN配置方法)
6. [VLAN配置持久化与管理](#6-VLAN配置持久化与管理)
7. [故障排查与最佳实践](#7-故障排查与最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🌐 VLAN技术基础


### 1.1 什么是VLAN


**VLAN（Virtual Local Area Network）虚拟局域网**：在物理网络基础上创建的逻辑分隔的网络

```
物理网络视图：
┌──────────────────────────────────────────┐
│    物理交换机（24个端口）                    │
│  [1][2][3][4][5][6]...[22][23][24]        │
└──────────────────────────────────────────┘

VLAN逻辑视图：
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   VLAN 10       │  │   VLAN 20       │  │   VLAN 30       │
│ 端口1,2,3,4     │  │ 端口5,6,7,8     │  │ 端口9,10,11,12  │
│ (财务部门)       │  │ (技术部门)       │  │ (市场部门)       │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

**核心作用**：
- **网络隔离**：不同VLAN之间默认无法直接通信
- **灵活管理**：可以跨物理位置组织逻辑网络
- **安全提升**：限制广播域，提高网络安全
- **成本节约**：一套物理设备支持多个逻辑网络

### 1.2 VLAN工作原理


**VLAN标签（Tag）机制**：
```
普通以太网帧：
┌─────────┬─────────┬──────┬─────┬─────┐
│ 目标MAC │ 源MAC   │ 类型 │数据 │ FCS │
└─────────┴─────────┴──────┴─────┴─────┘

带VLAN标签的帧：
┌─────────┬─────────┬──────────┬──────┬─────┬─────┐
│ 目标MAC │ 源MAC   │ VLAN标签 │ 类型 │数据 │ FCS │
└─────────┴─────────┴──────────┴──────┴─────┴─────┘
                    ↑
                4字节VLAN标签
                包含VLAN ID
```

**VLAN类型**：
- **Access VLAN**：连接终端设备，发送无标签帧
- **Trunk VLAN**：连接交换机间，传输带标签帧
- **Native VLAN**：在Trunk端口上传输无标签帧的默认VLAN

### 1.3 Linux中的VLAN支持


**内核支持**：
- Linux内核从2.4版本开始支持802.1Q VLAN
- 通过`8021q`内核模块提供VLAN功能
- VLAN接口作为虚拟网络接口存在

**检查VLAN支持**：
```bash
# 检查内核模块
lsmod | grep 8021q

# 如果没有加载，手动加载
modprobe 8021q

# 检查内核配置
grep CONFIG_VLAN /boot/config-$(uname -r)
```

---

## 2. 🔧 ip命令创建VLAN接口


### 2.1 基本语法与概念


**ip命令是现代Linux系统中推荐的网络配置工具**，它替代了传统的`ifconfig`等工具。

**基本语法**：
```bash
ip link add link <父接口> name <VLAN接口名> type vlan id <VLAN_ID>
```

**参数解释**：
- `link <父接口>`：指定物理网卡（如eth0、ens33）
- `name <VLAN接口名>`：新建的VLAN接口名称
- `type vlan`：指定接口类型为VLAN
- `id <VLAN_ID>`：VLAN标识号（1-4094）

### 2.2 创建VLAN接口实例


**示例1：基础VLAN创建**
```bash
# 创建VLAN 100接口
ip link add link eth0 name eth0.100 type vlan id 100

# 启用接口
ip link set dev eth0.100 up

# 配置IP地址
ip addr add 192.168.100.10/24 dev eth0.100
```

**示例2：多个VLAN创建**
```bash
# 为不同部门创建VLAN
ip link add link ens33 name vlan-finance type vlan id 10    # 财务部
ip link add link ens33 name vlan-tech type vlan id 20       # 技术部
ip link add link ens33 name vlan-sales type vlan id 30      # 销售部

# 批量启用
for vlan in vlan-finance vlan-tech vlan-sales; do
    ip link set dev $vlan up
done
```

### 2.3 VLAN接口命名规范


**推荐的命名方式**：

| 命名格式 | 示例 | 说明 | 使用场景 |
|---------|------|------|----------|
| `接口名.VLAN_ID` | `eth0.100` | 传统格式，直观明了 | 临时测试、简单环境 |
| `vlan-用途` | `vlan-dmz` | 按用途命名，语义清晰 | 生产环境推荐 |
| `接口名-vlan-ID` | `ens33-vlan-100` | 完整描述格式 | 复杂网络环境 |

**命名注意事项**：
- 接口名最长15个字符
- 避免使用特殊字符（除了`.`、`-`、`_`）
- 保持命名一致性

### 2.4 VLAN接口管理操作


**查看VLAN接口**：
```bash
# 查看所有网络接口
ip link show

# 只查看VLAN接口
ip link show type vlan

# 查看特定VLAN接口详情
ip link show dev eth0.100
```

**修改VLAN配置**：
```bash
# 修改接口名称
ip link set dev eth0.100 name finance-vlan

# 修改MTU
ip link set dev eth0.100 mtu 1496

# 临时禁用接口
ip link set dev eth0.100 down
```

**删除VLAN接口**：
```bash
# 删除VLAN接口
ip link delete dev eth0.100

# 批量删除
ip link show type vlan | grep "vlan-test" | cut -d: -f2 | xargs -I {} ip link delete dev {}
```

---

## 3. ⚙️ vconfig工具使用方法


### 3.1 vconfig工具简介


**vconfig**是传统的VLAN配置工具，虽然现在推荐使用`ip`命令，但在某些老系统中仍然使用。

**安装vconfig**：
```bash
# Ubuntu/Debian
sudo apt-get install vlan

# RHEL/CentOS
sudo yum install vconfig
# 或在新版本中
sudo dnf install vconfig
```

### 3.2 vconfig基本操作


**创建VLAN接口**：
```bash
# 基本语法
vconfig add <物理接口> <VLAN_ID>

# 示例
vconfig add eth0 100
vconfig add eth0 200
```

**VLAN接口配置**：
```bash
# 创建VLAN后需要手动配置IP
ifconfig eth0.100 192.168.100.10 netmask 255.255.255.0 up
ifconfig eth0.200 192.168.200.10 netmask 255.255.255.0 up
```

**删除VLAN接口**：
```bash
# 删除VLAN接口
vconfig rem eth0.100
vconfig rem eth0.200
```

### 3.3 vconfig vs ip命令对比


| 功能 | vconfig命令 | ip命令 | 推荐度 |
|------|------------|--------|--------|
| **创建VLAN** | `vconfig add eth0 100` | `ip link add link eth0 name eth0.100 type vlan id 100` | 推荐ip |
| **删除VLAN** | `vconfig rem eth0.100` | `ip link delete dev eth0.100` | 推荐ip |
| **命名灵活性** | 固定格式 | 完全自定义 | ip更灵活 |
| **功能完整性** | 基础功能 | 全面功能 | ip更强大 |
| **维护状态** | 不再更新 | 持续维护 | ip是未来 |

**迁移建议**：
- 新系统直接使用`ip`命令
- 老系统可以逐步迁移
- 脚本中优先使用`ip`命令

---

## 4. 📊 VLAN信息查看与监控


### 4.1 /proc/net/vlan/目录信息解读


**目录结构**：
```
/proc/net/vlan/
├── config          # VLAN总体配置信息
├── eth0.100        # 具体VLAN接口统计
├── eth0.200        # 具体VLAN接口统计
└── ...
```

**查看VLAN总体信息**：
```bash
cat /proc/net/vlan/config
```

**输出内容解读**：
```
VLAN Dev name    | VLAN ID
Name-Type: VLAN_NAME_TYPE_RAW_PLUS_VID_NO_PAD
eth0.100       | 100  | eth0
eth0.200       | 200  | eth0
```

**字段含义**：
- `VLAN Dev name`：VLAN接口名称
- `VLAN ID`：VLAN标识号
- 最后一列：父接口名称

### 4.2 VLAN接口详细统计


**查看特定VLAN统计**：
```bash
cat /proc/net/vlan/eth0.100
```

**统计信息内容**：
```
eth0.100  VID: 100  REORDER_HDR: 1  dev->priv_flags: 1
         total frames received            1245
          total bytes received           156234
      Broadcast/Multicast Rcvd               12
      total frames transmitted            987
       total bytes transmitted          98765
            total headroom used               0
           total encap on xmit               0
Device: eth0
INGRESS priority mappings: 0:0  1:0  2:0  3:0  4:0  5:0  6:0 7:0
EGRESS priority mappings:
```

### 4.3 VLAN接口状态监控


**实时监控VLAN流量**：
```bash
# 使用watch命令实时查看
watch -n 1 'cat /proc/net/vlan/config'

# 使用ip命令查看统计
ip -s link show type vlan
```

**网络流量监控脚本**：
```bash
#!/bin/bash
# vlan_monitor.sh - VLAN接口监控脚本

echo "VLAN接口流量监控"
echo "=================="

for vlan_dev in $(ip link show type vlan | grep -o '^[0-9]*: [^:]*' | cut -d' ' -f2); do
    echo "接口: $vlan_dev"
    
    # 获取接收和发送统计
    rx_bytes=$(cat /sys/class/net/$vlan_dev/statistics/rx_bytes)
    tx_bytes=$(cat /sys/class/net/$vlan_dev/statistics/tx_bytes)
    
    echo "  接收: $(($rx_bytes / 1024)) KB"
    echo "  发送: $(($tx_bytes / 1024)) KB"
    echo ""
done
```

---

## 5. 🔧 各发行版VLAN配置方法


### 5.1 NetworkManager中VLAN配置


**NetworkManager**是现代Linux发行版的默认网络管理工具。

**命令行配置（nmcli）**：
```bash
# 创建VLAN连接
nmcli connection add type vlan \
    con-name vlan-finance \
    ifname finance.10 \
    vlan.parent eth0 \
    vlan.id 10 \
    ip4 192.168.10.10/24

# 激活连接
nmcli connection up vlan-finance

# 查看VLAN连接
nmcli connection show --active | grep vlan
```

**图形界面配置步骤**：
1. 打开网络设置
2. 点击"添加连接"
3. 选择"VLAN"类型
4. 配置父接口和VLAN ID
5. 设置IP地址和其他参数

**配置文件位置**：
```bash
# NetworkManager配置文件
ls /etc/NetworkManager/system-connections/
```

### 5.2 systemd-networkd VLAN配置


**systemd-networkd**是systemd提供的网络管理服务。

**配置文件创建**：
```bash
# 创建VLAN设备配置
cat > /etc/systemd/network/10-vlan-finance.netdev << EOF
[NetDev]
Name=vlan-finance
Kind=vlan

[VLAN]
Id=10
EOF

# 创建VLAN网络配置
cat > /etc/systemd/network/20-vlan-finance.network << EOF
[Match]
Name=vlan-finance

[Network]
DHCP=no
IPForward=no

[Address]
Address=192.168.10.10/24

[Route]
Gateway=192.168.10.1
EOF
```

**绑定到物理接口**：
```bash
# 修改物理接口配置
cat > /etc/systemd/network/10-eth0.network << EOF
[Match]
Name=eth0

[Network]
VLAN=vlan-finance
DHCP=yes
EOF
```

**重启服务**：
```bash
systemctl restart systemd-networkd
systemctl enable systemd-networkd
```

### 5.3 ifcfg脚本VLAN配置（RHEL/CentOS）


**传统的ifcfg配置方式**，在RHEL/CentOS系统中常用。

**创建VLAN接口配置文件**：
```bash
# 创建ifcfg-eth0.100配置文件
cat > /etc/sysconfig/network-scripts/ifcfg-eth0.100 << EOF
DEVICE=eth0.100
BOOTPROTO=static
ONBOOT=yes
IPADDR=192.168.100.10
NETMASK=255.255.255.0
GATEWAY=192.168.100.1
VLAN=yes
EOF
```

**多VLAN配置示例**：
```bash
# 财务部门VLAN 10
cat > /etc/sysconfig/network-scripts/ifcfg-eth0.10 << EOF
DEVICE=eth0.10
BOOTPROTO=static
ONBOOT=yes
IPADDR=192.168.10.10
NETMASK=255.255.255.0
VLAN=yes
EOF

# 技术部门VLAN 20
cat > /etc/sysconfig/network-scripts/ifcfg-eth0.20 << EOF
DEVICE=eth0.20
BOOTPROTO=static
ONBOOT=yes
IPADDR=192.168.20.10
NETMASK=255.255.255.0
VLAN=yes
EOF
```

**激活配置**：
```bash
# 重启网络服务
systemctl restart network

# 或者单独启动接口
ifup eth0.100
```

### 5.4 netplan VLAN配置（Ubuntu）


**netplan**是Ubuntu 18.04+的默认网络配置工具。

**基本VLAN配置**：
```yaml
# /etc/netplan/01-netcfg.yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    ens33:
      dhcp4: true
  vlans:
    finance-vlan:
      id: 10
      link: ens33
      addresses:
        - 192.168.10.10/24
      gateway4: 192.168.10.1
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
    
    tech-vlan:
      id: 20
      link: ens33
      addresses:
        - 192.168.20.10/24
      gateway4: 192.168.20.1
```

**高级配置示例**：
```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    ens33:
      dhcp4: false
      addresses:
        - 192.168.1.10/24
  
  vlans:
    dmz-vlan:
      id: 100
      link: ens33
      addresses:
        - 192.168.100.10/24
      routes:
        - to: 0.0.0.0/0
          via: 192.168.100.1
          metric: 100
      nameservers:
        addresses: [192.168.1.1]
        search: [company.local]
```

**应用配置**：
```bash
# 测试配置
netplan try

# 应用配置
netplan apply

# 查看生成的配置
netplan get
```

---

## 6. 💾 VLAN配置持久化与管理


### 6.1 配置持久化方法对比


| 方法 | 适用系统 | 配置复杂度 | 可维护性 | 推荐度 |
|------|----------|------------|----------|--------|
| **NetworkManager** | 现代发行版 | 简单 | 高 | ⭐⭐⭐⭐⭐ |
| **systemd-networkd** | systemd系统 | 中等 | 高 | ⭐⭐⭐⭐ |
| **ifcfg脚本** | RHEL/CentOS | 简单 | 中等 | ⭐⭐⭐ |
| **netplan** | Ubuntu 18.04+ | 简单 | 高 | ⭐⭐⭐⭐ |
| **手动脚本** | 所有系统 | 复杂 | 低 | ⭐⭐ |

### 6.2 启动时自动配置


**systemd服务方式**：
```bash
# 创建VLAN配置服务
cat > /etc/systemd/system/setup-vlans.service << EOF
[Unit]
Description=Setup VLAN interfaces
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/setup-vlans.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# 创建配置脚本
cat > /usr/local/bin/setup-vlans.sh << 'EOF'
#!/bin/bash
# 加载VLAN模块
modprobe 8021q

# 创建VLAN接口
ip link add link eth0 name eth0.100 type vlan id 100
ip link add link eth0 name eth0.200 type vlan id 200

# 配置IP地址
ip addr add 192.168.100.10/24 dev eth0.100
ip addr add 192.168.200.10/24 dev eth0.200

# 启用接口
ip link set dev eth0.100 up
ip link set dev eth0.200 up
EOF

chmod +x /usr/local/bin/setup-vlans.sh
systemctl enable setup-vlans.service
```

### 6.3 VLAN配置模板


**生产环境配置模板**：
```bash
#!/bin/bash
# vlan-setup.sh - 企业VLAN配置脚本

# VLAN配置数组 (VLAN_ID:IP_ADDRESS:DESCRIPTION)
VLANS=(
    "10:192.168.10.10/24:Finance Department"
    "20:192.168.20.10/24:Technology Department"
    "30:192.168.30.10/24:Sales Department"
    "100:192.168.100.10/24:DMZ Network"
)

PARENT_INTERFACE="eth0"

echo "开始配置VLAN接口..."

for vlan_config in "${VLANS[@]}"; do
    IFS=':' read -r vlan_id ip_addr description <<< "$vlan_config"
    
    echo "配置VLAN $vlan_id ($description)"
    
    # 创建VLAN接口
    ip link add link $PARENT_INTERFACE name ${PARENT_INTERFACE}.${vlan_id} type vlan id $vlan_id
    
    # 配置IP地址
    ip addr add $ip_addr dev ${PARENT_INTERFACE}.${vlan_id}
    
    # 启用接口
    ip link set dev ${PARENT_INTERFACE}.${vlan_id} up
    
    echo "  接口: ${PARENT_INTERFACE}.${vlan_id}"
    echo "  IP地址: $ip_addr"
    echo "  描述: $description"
    echo ""
done

echo "VLAN配置完成！"
```

---

## 7. 🔍 故障排查与最佳实践


### 7.1 常见问题诊断


**问题1：VLAN接口创建失败**
```bash
# 检查内核模块
lsmod | grep 8021q
# 如果没有，加载模块
modprobe 8021q

# 检查父接口状态
ip link show eth0

# 检查VLAN ID是否冲突
ip link show type vlan | grep "vlan id"
```

**问题2：VLAN间无法通信**
```bash
# 检查VLAN接口状态
ip link show type vlan

# 检查IP配置
ip addr show

# 检查路由表
ip route show

# 检查防火墙规则
iptables -L -n
```

**问题3：VLAN配置不持久**
```bash
# 检查NetworkManager状态
systemctl status NetworkManager

# 检查配置文件
ls -la /etc/NetworkManager/system-connections/

# 手动重载配置
nmcli connection reload
```

### 7.2 性能监控与优化


**VLAN性能监控脚本**：
```bash
#!/bin/bash
# vlan-performance.sh - VLAN性能监控

echo "VLAN性能监控报告"
echo "=================="
echo "时间: $(date)"
echo ""

for vlan_dev in $(ip link show type vlan | grep -o '^[0-9]*: [^:]*' | cut -d' ' -f2); do
    echo "接口: $vlan_dev"
    
    # 获取统计信息
    rx_packets=$(cat /sys/class/net/$vlan_dev/statistics/rx_packets)
    tx_packets=$(cat /sys/class/net/$vlan_dev/statistics/tx_packets)
    rx_errors=$(cat /sys/class/net/$vlan_dev/statistics/rx_errors)
    tx_errors=$(cat /sys/class/net/$vlan_dev/statistics/tx_errors)
    
    echo "  接收包数: $rx_packets"
    echo "  发送包数: $tx_packets"
    echo "  接收错误: $rx_errors"
    echo "  发送错误: $tx_errors"
    
    # 计算错误率
    if [ $rx_packets -gt 0 ]; then
        rx_error_rate=$(echo "scale=2; $rx_errors * 100 / $rx_packets" | bc)
        echo "  接收错误率: ${rx_error_rate}%"
    fi
    
    echo ""
done
```

### 7.3 最佳实践建议


**网络设计原则**：
- **VLAN ID规划**：建立清晰的VLAN ID分配策略
- **命名规范**：使用有意义的接口名称
- **文档记录**：维护完整的网络配置文档
- **权限控制**：限制VLAN配置权限

**安全建议**：
```bash
# 禁用不必要的VLAN
ip link set dev unused-vlan down

# 配置防火墙规则
iptables -A FORWARD -i vlan-dmz -o vlan-internal -j DROP

# 限制VLAN间路由
echo 0 > /proc/sys/net/ipv4/ip_forward
```

**监控和维护**：
- 定期检查VLAN配置的一致性
- 监控VLAN接口的流量和错误统计
- 建立VLAN配置变更的审核流程
- 定期备份网络配置文件

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 VLAN本质：在物理网络上创建逻辑分隔的虚拟网络
🔸 标签机制：通过802.1Q标签实现帧的VLAN标识
🔸 ip命令：现代Linux推荐的VLAN配置工具
🔸 配置持久化：根据发行版选择合适的持久化方法
🔸 监控管理：通过/proc/net/vlan/目录查看VLAN状态
```

### 8.2 关键操作命令


**VLAN创建与管理**：
```bash
# 创建VLAN接口
ip link add link eth0 name eth0.100 type vlan id 100

# 配置IP地址
ip addr add 192.168.100.10/24 dev eth0.100

# 启用接口
ip link set dev eth0.100 up

# 查看VLAN接口
ip link show type vlan

# 删除VLAN接口
ip link delete dev eth0.100
```

### 8.3 配置方法选择指南


**根据系统特点选择**：
- **现代桌面系统**：使用NetworkManager（nmcli）
- **服务器环境**：使用systemd-networkd或传统ifcfg
- **Ubuntu系统**：优先使用netplan
- **容器环境**：使用ip命令进行临时配置

### 8.4 故障排查要点


**排查步骤**：
1. **检查内核支持**：确认8021q模块已加载
2. **验证物理接口**：确保父接口状态正常
3. **检查VLAN配置**：验证VLAN ID和接口配置
4. **测试网络连通性**：ping测试和路由检查
5. **查看日志信息**：检查系统日志中的错误信息

### 8.5 实际应用价值


**企业网络场景**：
- **部门隔离**：不同部门使用不同VLAN
- **安全分区**：DMZ、内网、管理网络分离
- **服务分类**：按服务类型划分网络
- **流量管理**：针对不同VLAN实施QoS策略

**核心记忆**：
- VLAN是网络虚拟化的基础技术
- ip命令是现代Linux的标准网络配置工具
- 选择合适的持久化方法确保配置重启后生效
- 定期监控和维护VLAN配置的正确性