---
title: 7、systemd-networkd网络管理
---
## 📚 目录

1. [systemd-networkd服务概述](#1-systemd-networkd服务概述)
2. [配置文件体系结构](#2-配置文件体系结构)
3. [.network网络配置文件](#3-network网络配置文件)
4. [.netdev虚拟设备配置](#4-netdev虚拟设备配置)
5. [.link链路配置文件](#5-link链路配置文件)
6. [网络单元依赖关系](#6-网络单元依赖关系)
7. [DHCP客户端配置详解](#7-dhcp客户端配置详解)
8. [静态路由配置管理](#8-静态路由配置管理)
9. [networkctl状态查询工具](#9-networkctl状态查询工具)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🌐 systemd-networkd服务概述


### 1.1 什么是systemd-networkd


**简单理解**：systemd-networkd是现代Linux系统中的**网络管理服务**，它负责自动配置和管理网络接口。

```
传统网络管理 vs systemd-networkd：

传统方式（ifconfig/route）：
手动命令 → 临时生效 → 重启丢失

systemd-networkd方式：
配置文件 → 自动应用 → 持久保存 → 开机自动
```

### 1.2 核心作用和优势


**🔸 主要功能**
- **自动网络配置**：根据配置文件自动设置网络
- **接口管理**：管理物理和虚拟网络接口
- **路由控制**：自动配置静态和动态路由
- **DHCP集成**：内置DHCP客户端功能

**💡 相比传统工具的优势**
```
统一管理：
- 所有网络配置集中在配置文件中
- 不需要记忆复杂的命令行参数

自动化程度高：
- 系统启动时自动应用配置
- 网络状态变化时自动调整

现代化设计：
- 与systemd深度集成
- 支持容器和虚拟化环境
```

### 1.3 服务状态管理


**启用和管理服务**：
```bash
# 启用服务（开机自启）
sudo systemctl enable systemd-networkd

# 启动服务
sudo systemctl start systemd-networkd

# 查看服务状态
sudo systemctl status systemd-networkd

# 重启网络服务
sudo systemctl restart systemd-networkd
```

> 💡 **提示**：启用systemd-networkd之前，通常需要禁用其他网络管理工具如NetworkManager，避免冲突

---

## 2. 📁 配置文件体系结构


### 2.1 配置文件存放位置


**配置文件层次结构**：
```
/etc/systemd/network/          ← 主要配置目录（优先级最高）
/run/systemd/network/          ← 运行时配置（临时）
/usr/lib/systemd/network/      ← 系统默认配置（优先级最低）
```

**文件优先级说明**：
- 数字编号决定加载顺序（00-99，数字越小优先级越高）
- 相同编号时，`/etc/`目录优先于其他目录
- 后加载的配置会覆盖先加载的配置

### 2.2 三类核心配置文件


**📋 配置文件类型对比**

| 文件类型 | **作用** | **配置对象** | **典型用途** |
|---------|---------|-------------|-------------|
| **`.network`** | `网络配置` | `网络接口行为` | `IP地址、路由、DNS` |
| **`.netdev`** | `虚拟设备` | `虚拟网络设备` | `网桥、VLAN、隧道` |
| **`.link`** | `链路配置` | `物理网络特性` | `MAC地址、网卡名称` |

### 2.3 文件命名规范


**命名格式**：`[数字前缀-]描述性名称.扩展名`

```
命名示例：
10-eth0.network          ← 以太网接口配置
20-wlan0.network         ← 无线网接口配置  
00-default.link          ← 默认链路配置
50-bridge0.netdev        ← 网桥虚拟设备
```

> ⚠️ **注意**：数字前缀控制加载顺序，00最先加载，99最后加载

---

## 3. 🔧 .network网络配置文件


### 3.1 基本文件结构


**配置文件的三个主要部分**：
```ini
[Match]           ← 匹配规则：指定这个配置应用于哪个网络接口
Name=eth0

[Network]         ← 网络设置：IP地址、DNS、路由等核心配置  
DHCP=yes

[DHCP]           ← DHCP设置：DHCP客户端的详细行为配置
UseDNS=yes
```

### 3.2 [Match] 部分详解


**🎯 匹配条件说明**：Match部分决定这个配置文件适用于哪个网络接口

**常用匹配选项**：
```ini
[Match]
Name=eth0                    # 按接口名称匹配
MACAddress=00:11:22:33:44:55 # 按MAC地址匹配  
Driver=e1000                 # 按驱动程序匹配
Type=ether                   # 按接口类型匹配
```

**实际应用场景**：
```ini
# 场景1：匹配特定网卡
[Match]
Name=enp3s0

# 场景2：匹配所有以太网卡
[Match]  
Name=en*
Type=ether

# 场景3：匹配特定MAC地址的网卡
[Match]
MACAddress=52:54:00:12:34:56
```

### 3.3 [Network] 部分核心配置


**🔸 IP地址配置方式**

**DHCP自动获取**：
```ini
[Network]
DHCP=yes                    # 启用DHCP（IPv4和IPv6）
# 或者
DHCP=ipv4                   # 仅IPv4使用DHCP
DHCP=ipv6                   # 仅IPv6使用DHCP
```

**静态IP配置**：
```ini
[Network]
Address=192.168.1.100/24    # 静态IP地址和子网掩码
Gateway=192.168.1.1         # 默认网关
DNS=8.8.8.8                 # DNS服务器
DNS=8.8.4.4                 # 备用DNS服务器
```

**🔸 网络行为配置**
```ini
[Network]
IPForward=yes               # 启用IP转发（路由功能）
IPMasquerade=yes            # 启用IP伪装（NAT功能）
ConfigureWithoutCarrier=yes  # 即使网线未连接也应用配置
```

### 3.4 完整配置示例


**静态IP配置示例**：
```ini
# 文件：/etc/systemd/network/10-static-eth0.network
[Match]
Name=eth0

[Network]
Address=192.168.1.100/24
Gateway=192.168.1.1
DNS=8.8.8.8
DNS=8.8.4.4
```

**DHCP配置示例**：
```ini
# 文件：/etc/systemd/network/20-dhcp-eth1.network
[Match]
Name=eth1

[Network]
DHCP=ipv4

[DHCP]
UseDNS=yes
UseRoutes=yes
```

---

## 4. 🌉 .netdev虚拟设备配置


### 4.1 虚拟设备概念理解


**什么是虚拟网络设备**：
虚拟设备是软件模拟的网络接口，不对应实际的物理硬件，但在系统中表现得像真实的网络接口一样。

**常见虚拟设备类型**：
```
网桥（bridge）：    连接多个网络接口，类似于交换机
VLAN：            在单个物理接口上创建多个逻辑网络  
隧道（tunnel）：    在网络间建立加密通道
虚拟以太网（veth）： 成对出现的虚拟网卡，用于容器通信
```

### 4.2 .netdev文件基本结构


```ini
[NetDev]          ← 虚拟设备基本信息
Name=br0          # 设备名称
Kind=bridge       # 设备类型

[Bridge]          ← 特定设备类型的详细配置
STP=yes           # 启用生成树协议
```

### 4.3 网桥（Bridge）配置


**🌉 网桥的作用**：网桥可以将多个网络接口连接在一起，形成一个单一的网络段

**创建网桥示例**：
```ini
# 文件：/etc/systemd/network/10-bridge.netdev
[NetDev]
Name=br0
Kind=bridge

[Bridge]
STP=yes                     # 启用生成树协议，防止环路
ForwardDelaySec=0          # 转发延迟时间
HelloTimeSec=2             # Hello包间隔
```

**配置网桥网络**：
```ini
# 文件：/etc/systemd/network/10-bridge.network
[Match]
Name=br0

[Network]
DHCP=yes
IPForward=yes
```

### 4.4 VLAN配置


**🏷️ VLAN的作用**：在单个物理网卡上创建多个逻辑网络，实现网络隔离

```ini
# 文件：/etc/systemd/network/20-vlan10.netdev
[NetDev]
Name=vlan10
Kind=vlan

[VLAN]
Id=10                       # VLAN ID
```

**VLAN网络配置**：
```ini
# 文件：/etc/systemd/network/20-vlan10.network
[Match]
Name=vlan10

[Network]
Address=192.168.10.1/24
```

---

## 5. 🔗 .link链路配置文件


### 5.1 链路配置的作用


**什么是链路配置**：
.link文件控制网络接口的**物理层属性**，如接口名称、MAC地址、Wake-on-LAN等底层特性。

**🔸 主要用途**：
- **重命名网络接口**：给网卡起个好记的名字
- **设置MAC地址**：修改网卡的硬件地址
- **调整网卡参数**：MTU大小、队列长度等

### 5.2 基本配置结构


```ini
[Match]           ← 匹配物理网卡
MACAddress=52:54:00:12:34:56

[Link]            ← 链路属性设置
Name=internal0    # 重命名网卡
MTUBytes=1500     # 设置MTU大小
```

### 5.3 网卡重命名示例


**重命名网络接口**：
```ini
# 文件：/etc/systemd/network/10-rename-eth.link
[Match]
MACAddress=52:54:00:12:34:56

[Link]
Name=internal0
```

**常用链路配置选项**：
```ini
[Link]
Name=newname              # 新的接口名称
MTUBytes=1500            # 最大传输单元
MACAddress=random        # 随机MAC地址
WakeOnLan=magic          # Wake-on-LAN设置
```

---

## 6. 🔄 网络单元依赖关系


### 6.1 配置单元间的关系


**依赖关系示意图**：
```
物理网卡（eth0）
     ↓
.link文件 → 重命名为internal0  
     ↓
.network文件 → 配置IP地址、路由
     ↓  
.netdev文件 → 创建虚拟设备（如需要）
```

### 6.2 配置加载顺序


**🔸 systemd-networkd的处理流程**：

1. **设备发现阶段**：检测到物理网络设备
2. **链路配置阶段**：应用.link文件，重命名设备、设置MAC等
3. **设备创建阶段**：根据.netdev文件创建虚拟设备
4. **网络配置阶段**：应用.network文件，设置IP、路由、DNS等

### 6.3 配置文件协作示例


**完整的网络配置组合**：

```ini
# 1. 链路配置：/etc/systemd/network/00-rename.link
[Match]
MACAddress=52:54:00:aa:bb:cc

[Link]
Name=external

# 2. 网桥设备：/etc/systemd/network/10-bridge.netdev  
[NetDev]
Name=br0
Kind=bridge

# 3. 物理接口配置：/etc/systemd/network/20-external.network
[Match]
Name=external

[Network]
Bridge=br0                  # 将物理接口加入网桥

# 4. 网桥网络配置：/etc/systemd/network/30-bridge.network
[Match]
Name=br0

[Network]
DHCP=yes
```

---

## 7. 🌐 DHCP客户端配置详解


### 7.1 DHCP工作原理简述


**DHCP过程简化理解**：
```
客户端： "我需要IP地址"     → DHCP服务器
DHCP服务器： "给你192.168.1.100" → 客户端  
客户端： "谢谢，我用这个IP"   → 开始正常通信
```

### 7.2 基本DHCP配置


**启用DHCP的最简配置**：
```ini
[Match]
Name=eth0

[Network]
DHCP=yes
```

### 7.3 [DHCP] 部分详细配置


**🔸 DHCP行为控制选项**

| 配置项 | **作用** | **默认值** | **说明** |
|--------|---------|-----------|----------|
| `UseDNS` | `使用DHCP分配的DNS` | `yes` | `是否接受DNS服务器信息` |
| `UseRoutes` | `使用DHCP分配的路由` | `yes` | `是否接受路由信息` |
| `UseHostname` | `使用DHCP分配的主机名` | `yes` | `是否接受主机名` |
| `SendHostname` | `发送本机主机名` | `yes` | `向DHCP服务器发送主机名` |

**详细DHCP配置示例**：
```ini
[Match]
Name=eth0

[Network]
DHCP=ipv4

[DHCP]
UseDNS=yes                  # 接受DHCP提供的DNS
UseRoutes=yes               # 接受DHCP提供的路由
UseHostname=no              # 不接受DHCP分配的主机名
SendHostname=yes            # 向服务器发送本机主机名
ClientIdentifier=mac        # 使用MAC地址作为客户端标识
```

### 7.4 DHCP故障排查


**常见问题和解决方法**：

> ⚠️ **DHCP获取失败**：检查网线连接和DHCP服务器状态
> 
> ⚠️ **DNS解析问题**：设置`UseDNS=yes`或手动指定DNS
> 
> ⚠️ **获取到错误IP**：检查DHCP服务器配置和网络环境

---

## 8. 🛣️ 静态路由配置管理


### 8.1 路由概念理解


**什么是路由**：
路由就是告诉数据包"要到某个网络，应该走哪条路"的规则。

**路由表示例理解**：
```
目标网络              下一跳网关        接口
192.168.1.0/24   →   直接连接      →   eth0
10.0.0.0/8      →   192.168.1.1   →   eth0  
0.0.0.0/0       →   192.168.1.1   →   eth0（默认路由）
```

### 8.2 在.network文件中配置路由


**🔸 默认网关配置**：
```ini
[Network]
Gateway=192.168.1.1         # 设置默认网关
```

**🔸 静态路由配置**：
```ini
[Network]
Address=192.168.1.100/24

[Route]
Destination=10.0.0.0/8      # 目标网络
Gateway=192.168.1.254       # 下一跳网关

[Route]  
Destination=172.16.0.0/12
Gateway=192.168.1.253
```

### 8.3 高级路由配置


**多路由配置示例**：
```ini
[Match]
Name=eth0

[Network]
Address=192.168.1.100/24
Gateway=192.168.1.1         # 默认网关

[Route]
Destination=10.0.0.0/8      # 内网路由
Gateway=192.168.1.10
Metric=100                  # 路由优先级（数字越小优先级越高）

[Route]
Destination=172.16.0.0/12   # 另一个内网路由  
Gateway=192.168.1.11
Metric=200
```

**🔸 路由优先级说明**：
- Metric值越小，路由优先级越高
- 相同目标的多条路由，优先使用Metric小的
- 默认Metric通常为0或1024

---

## 9. 🔍 networkctl状态查询工具


### 9.1 networkctl基本用法


**networkctl是什么**：
networkctl是systemd-networkd的命令行管理工具，用于查看和管理网络状态。

### 9.2 常用查询命令


**🔸 基本状态查询**：

```bash
# 查看所有网络接口概况
networkctl

# 查看详细网络状态  
networkctl status

# 查看特定接口详细信息
networkctl status eth0
```

**输出示例理解**：
```bash
$ networkctl
IDX LINK      TYPE     OPERATIONAL SETUP     
  1 lo        loopback carrier     unmanaged
  2 eth0      ether    routable    configured
  3 br0       bridge   routable    configured
```

**状态字段含义**：
- **OPERATIONAL**：操作状态（carrier=有载波, routable=可路由）
- **SETUP**：配置状态（configured=已配置, unmanaged=未管理）

### 9.3 详细信息查看


**查看接口详细配置**：
```bash
networkctl status eth0
```

**输出信息包括**：
- IP地址和子网掩码
- 默认网关信息  
- DNS服务器配置
- 路由表信息
- DHCP租约状态

### 9.4 网络管理操作


**🔧 基本管理命令**：

```bash
# 重新配置特定接口
sudo networkctl reconfigure eth0

# 重新加载所有配置
sudo networkctl reload

# 启动/停止接口
sudo networkctl up eth0
sudo networkctl down eth0
```

> 💡 **提示**：配置文件修改后，使用`networkctl reload`或`systemctl restart systemd-networkd`使配置生效

### 9.5 故障诊断命令


**网络问题排查步骤**：

```bash
# 1. 检查服务状态
systemctl status systemd-networkd

# 2. 查看网络接口状态
networkctl status

# 3. 查看具体接口详情
networkctl status eth0

# 4. 查看系统日志
journalctl -u systemd-networkd
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的基本概念


```
🔸 systemd-networkd：现代Linux网络管理服务，基于配置文件自动管理网络
🔸 三类配置文件：.network（网络配置）、.netdev（虚拟设备）、.link（链路配置）
🔸 配置优先级：数字前缀决定加载顺序，/etc/目录优先级最高
🔸 Match机制：决定配置应用于哪个网络接口
🔸 networkctl：网络状态查询和管理的命令行工具
```

### 10.2 关键理解要点


**🔹 配置文件协作关系**
```
配置生效流程：
物理网卡检测 → .link重命名 → .netdev创建虚拟设备 → .network应用网络配置

实际应用：
一个完整的网络配置通常需要多个配置文件协同工作
```

**🔹 DHCP vs 静态配置选择**
```
DHCP适用场景：
- 客户端设备（普通电脑、手机等）
- IP地址需求不固定的环境
- 网络配置经常变化的环境

静态IP适用场景：  
- 服务器设备
- 网络设备（路由器、交换机等）
- 需要固定IP的服务
```

**🔹 虚拟设备的实际用途**
```
网桥（Bridge）：
- 虚拟机网络连接
- 容器网络管理
- 多网卡绑定

VLAN：
- 网络隔离和划分
- 提高网络安全性
- 优化网络性能
```

### 10.3 实际应用场景


**🎯 典型配置场景**

**服务器静态IP配置**：
```ini
# 适用：Web服务器、数据库服务器
[Match]
Name=eth0

[Network]
Address=192.168.1.100/24
Gateway=192.168.1.1
DNS=8.8.8.8
```

**办公环境DHCP配置**：
```ini
# 适用：办公电脑、笔记本
[Match]
Name=*

[Network]
DHCP=yes
```

**虚拟化环境网桥配置**：
```ini
# 适用：KVM虚拟机、Docker容器
[NetDev]
Name=br0
Kind=bridge

[Network]
Bridge=br0
```

### 10.4 最佳实践建议


**🔧 配置文件管理**
```
命名规范：
- 使用数字前缀控制加载顺序
- 使用描述性名称便于理解
- 例：10-eth0-static.network

备份策略：
- 修改前备份原始配置
- 使用版本控制管理配置文件
- 记录配置修改原因和时间
```

**🔍 故障排查流程**
```
1. 检查服务状态：systemctl status systemd-networkd  
2. 查看接口状态：networkctl status
3. 检查配置文件：语法和逻辑是否正确
4. 查看系统日志：journalctl -u systemd-networkd
5. 测试网络连通性：ping、traceroute等
```

**⚠️ 常见注意事项**
```
配置冲突：
- 确保只有一个网络管理服务在运行
- NetworkManager和systemd-networkd不能同时使用

文件权限：
- 配置文件需要root权限修改
- 建议权限设置为644

配置生效：
- 修改配置后需要重启服务或重新加载
- 使用networkctl reload或systemctl restart
```

**核心记忆**：
- systemd-networkd通过配置文件实现网络自动化管理
- 三类配置文件各司其职：.network管网络，.netdev管虚拟设备，.link管物理属性  
- Match部分决定配置适用范围，Network部分定义具体网络行为
- networkctl是查看状态和故障排查的重要工具
- 配置修改后记得重新加载服务使配置生效