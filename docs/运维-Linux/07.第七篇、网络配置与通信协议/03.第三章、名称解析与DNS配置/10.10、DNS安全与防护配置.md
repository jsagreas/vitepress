---
title: 10ã€DNSå®‰å…¨ä¸é˜²æŠ¤é…ç½®
---
## ğŸ“š ç›®å½•

1. [DNSå®‰å…¨å¨èƒä¸é˜²æŠ¤æ¦‚è¿°](#1-DNSå®‰å…¨å¨èƒä¸é˜²æŠ¤æ¦‚è¿°)
2. [DNSåŠ«æŒé˜²æŠ¤æªæ–½](#2-DNSåŠ«æŒé˜²æŠ¤æªæ–½)
3. [DoHåŠ å¯†DNSé…ç½®](#3-DoHåŠ å¯†DNSé…ç½®)
4. [DNSè¿‡æ»¤ä¸æ¶æ„åŸŸåæ‹¦æˆª](#4-DNSè¿‡æ»¤ä¸æ¶æ„åŸŸåæ‹¦æˆª)
5. [DNSSECé…ç½®ä¸éªŒè¯](#5-DNSSECé…ç½®ä¸éªŒè¯)
6. [å…¬å…±DNSæœåŠ¡å™¨é€‰æ‹©é…ç½®](#6-å…¬å…±DNSæœåŠ¡å™¨é€‰æ‹©é…ç½®)
7. [DNSæŸ¥è¯¢åŠ å¯†ä¼ è¾“æŠ€æœ¯](#7-DNSæŸ¥è¯¢åŠ å¯†ä¼ è¾“æŠ€æœ¯)
8. [DNSæ³„éœ²æ£€æµ‹ä¸é˜²æŠ¤](#8-DNSæ³„éœ²æ£€æµ‹ä¸é˜²æŠ¤)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ DNSå®‰å…¨å¨èƒä¸é˜²æŠ¤æ¦‚è¿°


### 1.1 DNSå®‰å…¨å¨èƒåŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯DNSå®‰å…¨å¨èƒï¼Ÿ**
> DNSå°±åƒäº’è”ç½‘çš„"ç”µè¯ç°¿"ï¼Œå¦‚æœç”µè¯ç°¿è¢«ç¯¡æ”¹ï¼Œä½ æ‹¨æ‰“é“¶è¡Œç”µè¯å¯èƒ½æ¥é€šåˆ°éª—å­é‚£é‡Œã€‚DNSå®‰å…¨å¨èƒå°±æ˜¯è¿™æ ·çš„"ç”µè¯ç°¿æ±¡æŸ“"ã€‚

```
æ­£å¸¸DNSè§£ææµç¨‹ï¼š
ç”¨æˆ·è¾“å…¥ï¼šwww.bank.com
DNSè§£æï¼šwww.bank.com â†’ çœŸå®é“¶è¡ŒIPï¼š192.168.1.100
ç”¨æˆ·è®¿é—®ï¼šè¿æ¥åˆ°çœŸå®é“¶è¡Œç½‘ç«™ âœ…

è¢«åŠ«æŒçš„DNSè§£æï¼š
ç”¨æˆ·è¾“å…¥ï¼šwww.bank.com  
DNSè§£æï¼šwww.bank.com â†’ æ¶æ„ç½‘ç«™IPï¼š10.0.0.50
ç”¨æˆ·è®¿é—®ï¼šè¿æ¥åˆ°é’“é±¼ç½‘ç«™ âŒ
```

### 1.2 å¸¸è§DNSå®‰å…¨å¨èƒç±»å‹


#### ğŸ”¸ DNSåŠ«æŒï¼ˆDNS Hijackingï¼‰

**å¨èƒè¯´æ˜**ï¼šæ”»å‡»è€…æ§åˆ¶DNSæœåŠ¡å™¨æˆ–ä¿®æ”¹DNSå“åº”ï¼Œå°†ç”¨æˆ·å¼•å¯¼åˆ°æ¶æ„ç½‘ç«™

**å®é™…æ¡ˆä¾‹**ï¼š
- ç”¨æˆ·æƒ³è®¿é—®`facebook.com`
- è¢«åŠ«æŒåè·³è½¬åˆ°æ¶æ„å¹¿å‘Šé¡µé¢
- æˆ–è·³è½¬åˆ°é’“é±¼ç½‘ç«™çªƒå–ç”¨æˆ·å¯†ç 

#### ğŸ”¸ DNSç¼“å­˜æŠ•æ¯’ï¼ˆDNS Cache Poisoningï¼‰

**å¨èƒè¯´æ˜**ï¼šå‘DNSç¼“å­˜ä¸­æ³¨å…¥è™šå‡è®°å½•ï¼Œå½±å“åç»­æ‰€æœ‰æŸ¥è¯¢

```
æŠ•æ¯’è¿‡ç¨‹ç¤ºæ„ï¼š
æ­£å¸¸ç¼“å­˜ï¼šgoogle.com â†’ 172.217.160.78 (çœŸå®IP)
è¢«æŠ•æ¯’åï¼šgoogle.com â†’ 192.168.1.99 (æ¶æ„IP)
å½±å“æ—¶é—´ï¼šç›´åˆ°ç¼“å­˜è¿‡æœŸæˆ–æ‰‹åŠ¨æ¸…é™¤
```

#### ğŸ”¸ DNSéš§é“æ”»å‡»ï¼ˆDNS Tunnelingï¼‰

**å¨èƒè¯´æ˜**ï¼šåˆ©ç”¨DNSåè®®ä¼ è¾“æ¶æ„æ•°æ®ï¼Œç»•è¿‡é˜²ç«å¢™æ£€æµ‹

#### ğŸ”¸ DNSæ”¾å¤§æ”»å‡»ï¼ˆDNS Amplificationï¼‰

**å¨èƒè¯´æ˜**ï¼šåˆ©ç”¨DNSæœåŠ¡å™¨å‘èµ·DDoSæ”»å‡»ï¼Œæ”¾å¤§æ”»å‡»æµé‡

### 1.3 DNSå®‰å…¨é˜²æŠ¤ä½“ç³»æ¡†æ¶


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DNSå®‰å…¨é˜²æŠ¤ä½“ç³»              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ä¼ è¾“å±‚å®‰å…¨    â”‚      åº”ç”¨å±‚å®‰å…¨        â”‚
â”‚                â”‚                      â”‚
â”‚  â€¢ DoH/DoTåŠ å¯†  â”‚   â€¢ DNSè¿‡æ»¤          â”‚
â”‚  â€¢ å®‰å…¨ä¼ è¾“åè®®  â”‚   â€¢ æ¶æ„åŸŸåæ‹¦æˆª      â”‚ 
â”‚  â€¢ é˜²çªƒå¬ä¿æŠ¤   â”‚   â€¢ å†…å®¹å®‰å…¨ç­–ç•¥      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æ•°æ®å±‚å®‰å…¨    â”‚      ç³»ç»Ÿå±‚å®‰å…¨        â”‚
â”‚                â”‚                      â”‚
â”‚  â€¢ DNSSECéªŒè¯   â”‚   â€¢ DNSæœåŠ¡å™¨å®‰å…¨     â”‚
â”‚  â€¢ æ•°æ®å®Œæ•´æ€§   â”‚   â€¢ è®¿é—®æ§åˆ¶         â”‚
â”‚  â€¢ é˜²ç¯¡æ”¹ä¿æŠ¤   â”‚   â€¢ æ—¥å¿—ç›‘æ§         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸš« DNSåŠ«æŒé˜²æŠ¤æªæ–½


### 2.1 DNSåŠ«æŒæ£€æµ‹æ–¹æ³•


#### ğŸ”¸ æ‰‹åŠ¨æ£€æµ‹DNSåŠ«æŒ

**åŸºç¡€æ£€æµ‹å‘½ä»¤**ï¼š
```bash
# æ£€æŸ¥å½“å‰DNSæœåŠ¡å™¨
cat /etc/resolv.conf

# ä½¿ç”¨ä¸åŒDNSæœåŠ¡å™¨å¯¹æ¯”æŸ¥è¯¢ç»“æœ
nslookup google.com 8.8.8.8
nslookup google.com 1.1.1.1
nslookup google.com  # ä½¿ç”¨å½“å‰DNS

# æ£€æŸ¥DNSå“åº”æ—¶é—´å¼‚å¸¸
dig google.com +stats
```

**ç»“æœåˆ†æ**ï¼šå¦‚æœä¸åŒDNSæœåŠ¡å™¨è¿”å›çš„IPåœ°å€ä¸ä¸€è‡´ï¼Œå¯èƒ½å­˜åœ¨åŠ«æŒ

#### ğŸ”¸ è‡ªåŠ¨åŒ–æ£€æµ‹è„šæœ¬

```bash
#!/bin/bash
# DNSåŠ«æŒæ£€æµ‹è„šæœ¬

DOMAIN="google.com"
DNS_SERVERS=("8.8.8.8" "1.1.1.1" "208.67.222.222")
RESULTS=()

echo "ğŸ” æ£€æµ‹åŸŸå: $DOMAIN"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

for dns in "${DNS_SERVERS[@]}"; do
    result=$(dig +short @$dns $DOMAIN | head -1)
    RESULTS+=("$dns:$result")
    echo "DNS $dns â†’ $result"
done

# æ£€æŸ¥ç»“æœä¸€è‡´æ€§
if [ ${#RESULTS[@]} -gt 1 ]; then
    first_ip=$(echo ${RESULTS[0]} | cut -d: -f2)
    for result in "${RESULTS[@]:1}"; do
        current_ip=$(echo $result | cut -d: -f2)
        if [ "$first_ip" != "$current_ip" ]; then
            echo "âš ï¸  è­¦å‘Šï¼šæ£€æµ‹åˆ°DNSè§£æä¸ä¸€è‡´ï¼Œå¯èƒ½å­˜åœ¨åŠ«æŒ"
            exit 1
        fi
    done
    echo "âœ… DNSè§£æä¸€è‡´ï¼Œæœªå‘ç°åŠ«æŒ"
fi
```

### 2.2 æœ¬åœ°DNSä¿æŠ¤é…ç½®


#### ğŸ”¸ é…ç½®å¯ä¿¡DNSæœåŠ¡å™¨

```bash
# å¤‡ä»½åŸå§‹é…ç½®
sudo cp /etc/resolv.conf /etc/resolv.conf.backup

# é…ç½®å®‰å…¨DNSæœåŠ¡å™¨
sudo tee /etc/resolv.conf > /dev/null << EOF
# ä¸»DNSï¼šCloudflare
nameserver 1.1.1.1
nameserver 1.0.0.1

# å¤‡ç”¨DNSï¼šGoogle
nameserver 8.8.8.8
nameserver 8.8.4.4

# æœç´¢åŸŸå’Œé€‰é¡¹
options timeout:2
options attempts:3
options rotate
EOF

# é˜²æ­¢é…ç½®è¢«è¦†ç›–
sudo chattr +i /etc/resolv.conf
```

**é…ç½®è¯´æ˜**ï¼š
- `timeout:2`ï¼šDNSæŸ¥è¯¢è¶…æ—¶æ—¶é—´2ç§’
- `attempts:3`ï¼šæœ€å¤šå°è¯•3æ¬¡æŸ¥è¯¢
- `rotate`ï¼šè½®è¯¢ä½¿ç”¨å¤šä¸ªDNSæœåŠ¡å™¨

#### ğŸ”¸ NetworkManagerç¯å¢ƒé…ç½®

```bash
# æŸ¥çœ‹å½“å‰ç½‘ç»œè¿æ¥
nmcli connection show

# è®¾ç½®DNSæœåŠ¡å™¨ï¼ˆæ›¿æ¢CONNECTION_NAMEï¼‰
sudo nmcli connection modify "CONNECTION_NAME" \
    ipv4.dns "1.1.1.1,8.8.8.8" \
    ipv4.ignore-auto-dns yes

# é‡å¯ç½‘ç»œè¿æ¥
sudo nmcli connection down "CONNECTION_NAME"
sudo nmcli connection up "CONNECTION_NAME"

# éªŒè¯é…ç½®
nmcli connection show "CONNECTION_NAME" | grep ipv4.dns
```

### 2.3 è·¯ç”±å™¨çº§åˆ«é˜²æŠ¤


#### ğŸ”¸ è·¯ç”±å™¨DNSè®¾ç½®

**é…ç½®æ­¥éª¤**ï¼š
1. **ç™»å½•è·¯ç”±å™¨ç®¡ç†ç•Œé¢**ï¼ˆé€šå¸¸æ˜¯`192.168.1.1`æˆ–`192.168.0.1`ï¼‰
2. **æ‰¾åˆ°DNSè®¾ç½®**ï¼šç½‘ç»œè®¾ç½® â†’ DNSæœåŠ¡å™¨
3. **é…ç½®å®‰å…¨DNS**ï¼š
   - ä¸»DNSï¼š`1.1.1.1` 
   - è¾…DNSï¼š`8.8.8.8`
4. **å¯ç”¨DNSå®‰å…¨åŠŸèƒ½**ï¼ˆå¦‚æœæ”¯æŒï¼‰

**ä¼˜åŠ¿åˆ†æ**ï¼š
```
ğŸ¯ è·¯ç”±å™¨çº§DNSé˜²æŠ¤ä¼˜åŠ¿ï¼š
âœ… ä¿æŠ¤æ•´ä¸ªç½‘ç»œå†…æ‰€æœ‰è®¾å¤‡
âœ… ç»Ÿä¸€ç®¡ç†ï¼Œé…ç½®ä¸€æ¬¡å…¨ç½‘ç”Ÿæ•ˆ
âœ… å³ä½¿è®¾å¤‡è¢«æ¶æ„è½¯ä»¶æ„ŸæŸ“ä¹Ÿéš¾ä»¥ç»•è¿‡
âœ… å¯¹ç”¨æˆ·å®Œå…¨é€æ˜ï¼Œæ— éœ€é¢å¤–é…ç½®

âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
â€¢ éœ€è¦è·¯ç”±å™¨ç®¡ç†å‘˜æƒé™
â€¢ è·¯ç”±å™¨é‡å¯åéœ€æ£€æŸ¥é…ç½®ä¿æŒ
â€¢ æŸäº›ISPå¯èƒ½å¼ºåˆ¶ä½¿ç”¨å…¶DNSæœåŠ¡å™¨
```

### 2.4 DNSåŠ«æŒåº”æ€¥å“åº”


```bash
# ç´§æ€¥æƒ…å†µDNSä¿®å¤è„šæœ¬
#!/bin/bash

echo "ğŸš¨ DNSåŠ«æŒåº”æ€¥ä¿®å¤ç¨‹åº"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# 1. æ¸…é™¤DNSç¼“å­˜
echo "1ï¸âƒ£ æ¸…é™¤æœ¬åœ°DNSç¼“å­˜..."
sudo systemctl flush-dns 2>/dev/null || \
sudo /etc/init.d/dns-clean start 2>/dev/null || \
sudo service network-manager restart

# 2. é‡ç½®DNSé…ç½®
echo "2ï¸âƒ£ é‡ç½®DNSé…ç½®..."
sudo chattr -i /etc/resolv.conf 2>/dev/null
sudo tee /etc/resolv.conf > /dev/null << EOF
nameserver 1.1.1.1
nameserver 8.8.8.8
EOF

# 3. éªŒè¯ä¿®å¤æ•ˆæœ
echo "3ï¸âƒ£ éªŒè¯ä¿®å¤æ•ˆæœ..."
dig +short google.com
ping -c 1 google.com > /dev/null && echo "âœ… ç½‘ç»œè¿æ¥æ­£å¸¸" || echo "âŒ ç½‘ç»œä»æœ‰é—®é¢˜"

echo "ğŸ”§ åº”æ€¥ä¿®å¤å®Œæˆ"
```

---

## 3. ğŸ”’ DoHåŠ å¯†DNSé…ç½®


### 3.1 DoHæŠ€æœ¯åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯DoHï¼ˆDNS over HTTPSï¼‰ï¼Ÿ**
> DoHå°±åƒç»™DNSæŸ¥è¯¢"ç©¿ä¸Šéšèº«è¡£"ï¼ŒæŠŠDNSè¯·æ±‚ä¼ªè£…æˆæ™®é€šçš„HTTPSç½‘é¡µè®¿é—®ï¼Œè®©ç¬¬ä¸‰æ–¹æ— æ³•ç›‘å¬ä½ åœ¨æŸ¥è¯¢ä»€ä¹ˆç½‘ç«™ã€‚

```
ä¼ ç»ŸDNSæŸ¥è¯¢ï¼ˆæ˜æ–‡ï¼‰ï¼š
å®¢æˆ·ç«¯ â”€â”€DNSæŸ¥è¯¢ï¼šgoogle.comâ”€â”€â–¶ DNSæœåŠ¡å™¨
       â—€â”€â”€è¿”å›IPï¼š172.217.160.78â”€â”€

ç‰¹ç‚¹ï¼šæŸ¥è¯¢å†…å®¹å¯è¢«ç›‘å¬ã€ç¯¡æ”¹

DoHåŠ å¯†æŸ¥è¯¢ï¼š
å®¢æˆ·ç«¯ â”€â”€HTTPSåŠ å¯†è¯·æ±‚â”€â”€â–¶ DoHæœåŠ¡å™¨
       â—€â”€â”€HTTPSåŠ å¯†å“åº”â”€â”€

ç‰¹ç‚¹ï¼šæŸ¥è¯¢å†…å®¹è¢«HTTPSåŠ å¯†ä¿æŠ¤
```

### 3.2 æµè§ˆå™¨DoHé…ç½®


#### ğŸ”¸ Chromeæµè§ˆå™¨é…ç½®

**è®¾ç½®æ­¥éª¤**ï¼š
1. æ‰“å¼€Chromeè®¾ç½®ï¼š`chrome://settings/`
2. è¿›å…¥éšç§å’Œå®‰å…¨ â†’ å®‰å…¨
3. æ‰¾åˆ°"ä½¿ç”¨å®‰å…¨DNS"é€‰é¡¹
4. é€‰æ‹©"ä½¿ç”¨å®‰å…¨DNS"å¹¶é…ç½®æœåŠ¡å™¨

**æ¨èDoHæœåŠ¡å™¨**ï¼š
- **Cloudflare**ï¼š`https://cloudflare-dns.com/dns-query`
- **Google**ï¼š`https://dns.google/dns-query`
- **Quad9**ï¼š`https://dns.quad9.net/dns-query`

#### ğŸ”¸ Firefoxæµè§ˆå™¨é…ç½®

**è®¾ç½®æ­¥éª¤**ï¼š
1. åœ°å€æ è¾“å…¥ï¼š`about:config`
2. æœç´¢ï¼š`network.trr.mode`
3. è®¾ç½®å€¼ä¸º`2`ï¼ˆå¯ç”¨DoHï¼Œé™çº§åˆ°å¸¸è§„DNSä½œä¸ºå¤‡ç”¨ï¼‰
4. æœç´¢ï¼š`network.trr.uri`
5. è®¾ç½®ä¸ºï¼š`https://cloudflare-dns.com/dns-query`

**Firefox DoHæ¨¡å¼è¯´æ˜**ï¼š
```
æ¨¡å¼0ï¼šç¦ç”¨DoH
æ¨¡å¼1ï¼šDoHä¼˜å…ˆï¼Œå¤±è´¥æ—¶ä½¿ç”¨å¸¸è§„DNS
æ¨¡å¼2ï¼šDoHä¼˜å…ˆï¼Œä½†å…è®¸é™çº§åˆ°å¸¸è§„DNS  â­ æ¨è
æ¨¡å¼3ï¼šä»…ä½¿ç”¨DoHï¼Œä¸é™çº§
æ¨¡å¼5ï¼šæ˜¾å¼ç¦ç”¨DoH
```

### 3.3 ç³»ç»Ÿçº§DoHé…ç½®


#### ğŸ”¸ ä½¿ç”¨cloudflaredé…ç½®DoH

```bash
# å®‰è£…cloudflared
wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared
sudo chmod +x /usr/local/bin/cloudflared

# åˆ›å»ºé…ç½®æ–‡ä»¶
sudo mkdir -p /etc/cloudflared
sudo tee /etc/cloudflared/config.yml > /dev/null << EOF
proxy-dns: true
proxy-dns-upstream:
  - https://1.1.1.1/dns-query
  - https://1.0.0.1/dns-query
proxy-dns-address: 127.0.0.1
proxy-dns-port: 5053
EOF

# åˆ›å»ºç³»ç»ŸæœåŠ¡
sudo tee /etc/systemd/system/cloudflared.service > /dev/null << EOF
[Unit]
Description=cloudflared DNS over HTTPS proxy
After=network.target

[Service]
Type=simple
User=nobody
ExecStart=/usr/local/bin/cloudflared --config /etc/cloudflared/config.yml
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
sudo systemctl enable cloudflared
sudo systemctl start cloudflared
sudo systemctl status cloudflared
```

#### ğŸ”¸ é…ç½®ç³»ç»Ÿä½¿ç”¨æœ¬åœ°DoHä»£ç†

```bash
# ä¿®æ”¹ç³»ç»ŸDNSé…ç½®æŒ‡å‘æœ¬åœ°DoHä»£ç†
sudo tee /etc/resolv.conf > /dev/null << EOF
nameserver 127.0.0.1:5053
nameserver 1.1.1.1
EOF

# æµ‹è¯•DoHæ˜¯å¦å·¥ä½œ
dig @127.0.0.1 -p 5053 google.com

# éªŒè¯æŸ¥è¯¢æ˜¯å¦é€šè¿‡HTTPS
sudo netstat -tuln | grep 5053
```

### 3.4 DoHæ€§èƒ½ä¼˜åŒ–


#### ğŸ”¸ DoHæœåŠ¡å™¨é€‰æ‹©ç­–ç•¥

```bash
# DoHæœåŠ¡å™¨å»¶è¿Ÿæµ‹è¯•è„šæœ¬
#!/bin/bash

DOH_SERVERS=(
    "cloudflare-dns.com/dns-query Cloudflare"
    "dns.google/dns-query Google"
    "dns.quad9.net/dns-query Quad9"
    "doh.opendns.com/dns-query OpenDNS"
)

echo "ğŸ” æµ‹è¯•DoHæœåŠ¡å™¨å»¶è¿Ÿ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

for server_info in "${DOH_SERVERS[@]}"; do
    server=$(echo $server_info | cut -d' ' -f1)
    name=$(echo $server_info | cut -d' ' -f2)
    
    echo -n "æµ‹è¯• $name ($server)..."
    
    # æµ‹è¯•å»¶è¿Ÿ
    start_time=$(date +%s%N)
    curl -s -H "Accept: application/dns-json" \
         "https://$server?name=google.com&type=A" > /dev/null
    end_time=$(date +%s%N)
    
    latency=$(( (end_time - start_time) / 1000000 ))
    echo " ${latency}ms"
done
```

**DoHæœåŠ¡å™¨ç‰¹ç‚¹å¯¹æ¯”**ï¼š

| æœåŠ¡å•† | **å»¶è¿Ÿ** | **éšç§æ”¿ç­–** | **è¿‡æ»¤åŠŸèƒ½** | **å¯é æ€§** |
|--------|---------|-------------|-------------|-----------|
| **Cloudflare** | `å¾ˆä½` | `ä¸è®°å½•æŸ¥è¯¢æ—¥å¿—` | `æ— è¿‡æ»¤` | `99.9%+` |
| **Google** | `ä½` | `éƒ¨åˆ†è®°å½•ç”¨äºæ”¹è¿›æœåŠ¡` | `æ— è¿‡æ»¤` | `99.9%+` |
| **Quad9** | `ä¸­ç­‰` | `ä¸è®°å½•IPåœ°å€` | `æ¶æ„åŸŸåè¿‡æ»¤` | `99%+` |
| **OpenDNS** | `ä¸­ç­‰` | `è®°å½•ç”¨äºå®‰å…¨åˆ†æ` | `å¯å®šåˆ¶è¿‡æ»¤` | `99%+` |

---

## 4. ğŸ›¡ï¸ DNSè¿‡æ»¤ä¸æ¶æ„åŸŸåæ‹¦æˆª


### 4.1 DNSè¿‡æ»¤åŸºæœ¬åŸç†


**ä»€ä¹ˆæ˜¯DNSè¿‡æ»¤ï¼Ÿ**
> DNSè¿‡æ»¤å°±åƒç½‘ç»œä¸–ç•Œçš„"å®‰æ£€é—¨"ï¼Œåœ¨ä½ è®¿é—®ç½‘ç«™ä¹‹å‰å°±æŠŠå±é™©ç½‘ç«™æ‹¦æˆªæ‰ï¼Œå°±åƒå®‰æ£€é—¨ä¼šæ‹¦æˆªå±é™©ç‰©å“ä¸€æ ·ã€‚

```
DNSè¿‡æ»¤å·¥ä½œæµç¨‹ï¼š
ç”¨æˆ·è¯·æ±‚ï¼šè®¿é—® malware.example.com
         â†“
DNSè¿‡æ»¤å™¨ï¼šæ£€æŸ¥åŸŸåé»‘åå•
         â†“
åˆ¤æ–­ç»“æœï¼šå‘ç°æ˜¯æ¶æ„åŸŸå
         â†“
æ‹¦æˆªåŠ¨ä½œï¼šè¿”å›æ‹¦æˆªé¡µé¢æˆ–ç©ºå“åº”
         â†“
ç”¨æˆ·çœ‹åˆ°ï¼šç½‘ç«™è¢«æ‹¦æˆªæç¤º
```

### 4.2 Pi-hole DNSè¿‡æ»¤ç³»ç»Ÿ


#### ğŸ”¸ Pi-holeå®‰è£…é…ç½®

```bash
# ä¸€é”®å®‰è£…Pi-hole
curl -sSL https://install.pi-hole.net | bash

# æˆ–è€…æ‰‹åŠ¨å®‰è£…ï¼ˆæ¨èï¼‰
git clone --depth 1 https://github.com/pi-hole/pi-hole.git Pi-hole
cd Pi-hole/automated\ install/
sudo bash basic-install.sh
```

**å®‰è£…ååŸºç¡€é…ç½®**ï¼š
```bash
# è®¾ç½®ç®¡ç†å‘˜å¯†ç 
pihole -a -p

# æ·»åŠ è‡ªå®šä¹‰é»‘åå•
pihole -b malicious-domain.com

# æ·»åŠ è‡ªå®šä¹‰ç™½åå•
pihole -w trusted-domain.com

# æ›´æ–°è¿‡æ»¤åˆ—è¡¨
pihole -g

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
pihole -c
```

#### ğŸ”¸ Pi-holeé«˜çº§é…ç½®

```bash
# è‡ªå®šä¹‰è¿‡æ»¤åˆ—è¡¨é…ç½®
sudo tee -a /etc/pihole/adlists.list > /dev/null << EOF
# æ¶æ„è½¯ä»¶è¿‡æ»¤åˆ—è¡¨
https://raw.githubusercontent.com/DandelionSprout/adfilt/master/Alternate%20versions%20Anti-Malware%20List/AntiMalwareHosts.txt

# è¿½è¸ªå™¨æ‹¦æˆªåˆ—è¡¨  
https://someonewhocares.org/hosts/zero/hosts

# å¹¿å‘Šæ‹¦æˆªåˆ—è¡¨
https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/adservers.txt
EOF

# åº”ç”¨é…ç½®
pihole -g
sudo systemctl restart pihole-FTL
```

### 4.3 dnsmasqæœ¬åœ°DNSè¿‡æ»¤


#### ğŸ”¸ é…ç½®dnsmasqåŸŸåè¿‡æ»¤

```bash
# å®‰è£…dnsmasq
sudo apt update && sudo apt install dnsmasq

# å¤‡ä»½åŸå§‹é…ç½®
sudo cp /etc/dnsmasq.conf /etc/dnsmasq.conf.backup

# åŸºç¡€é…ç½®
sudo tee /etc/dnsmasq.conf > /dev/null << EOF
# ç›‘å¬æ¥å£
interface=lo,eth0

# DNSæœåŠ¡å™¨è®¾ç½®
server=1.1.1.1
server=8.8.8.8

# ç¼“å­˜è®¾ç½®
cache-size=1000

# æ—¥å¿—è®¾ç½®
log-queries
log-facility=/var/log/dnsmasq.log

# æ¶æ„åŸŸåæ‹¦æˆªé…ç½®æ–‡ä»¶
addn-hosts=/etc/dnsmasq-blacklist.hosts
EOF

# åˆ›å»ºé»‘åå•æ–‡ä»¶
sudo tee /etc/dnsmasq-blacklist.hosts > /dev/null << EOF
# æ¶æ„åŸŸåæ‹¦æˆªåˆ—è¡¨
0.0.0.0 malicious-site.com
0.0.0.0 phishing-site.com
0.0.0.0 spam-domain.com
127.0.0.1 blocked-tracker.com
EOF

# å¯åŠ¨æœåŠ¡
sudo systemctl enable dnsmasq
sudo systemctl start dnsmasq
```

#### ğŸ”¸ è‡ªåŠ¨æ›´æ–°é»‘åå•è„šæœ¬

```bash
#!/bin/bash
# DNSé»‘åå•è‡ªåŠ¨æ›´æ–°è„šæœ¬

BLACKLIST_FILE="/etc/dnsmasq-blacklist.hosts"
TEMP_FILE="/tmp/dns-blacklist.tmp"

echo "ğŸ”„ æ›´æ–°DNSæ¶æ„åŸŸåé»‘åå•..."

# ä¸‹è½½æœ€æ–°é»‘åå•
curl -s "https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts" | \
grep "0.0.0.0" | \
grep -v "localhost" | \
sed 's/0.0.0.0/127.0.0.1/g' > "$TEMP_FILE"

# æ£€æŸ¥ä¸‹è½½æ˜¯å¦æˆåŠŸ
if [ -s "$TEMP_FILE" ]; then
    # å¤‡ä»½å½“å‰æ–‡ä»¶
    sudo cp "$BLACKLIST_FILE" "${BLACKLIST_FILE}.backup"
    
    # æ›´æ–°é»‘åå•
    sudo mv "$TEMP_FILE" "$BLACKLIST_FILE"
    
    # é‡å¯dnsmasqæœåŠ¡
    sudo systemctl restart dnsmasq
    
    echo "âœ… é»‘åå•æ›´æ–°å®Œæˆ"
    echo "ğŸ“Š å½“å‰æ‹¦æˆªåŸŸåæ•°é‡: $(wc -l < $BLACKLIST_FILE)"
else
    echo "âŒ é»‘åå•ä¸‹è½½å¤±è´¥"
    rm -f "$TEMP_FILE"
    exit 1
fi
```

### 4.4 DNSè¿‡æ»¤æ•ˆæœç›‘æ§


```bash
# DNSæŸ¥è¯¢æ—¥å¿—åˆ†æè„šæœ¬
#!/bin/bash

LOG_FILE="/var/log/dnsmasq.log"
TODAY=$(date +%Y-%m-%d)

echo "ğŸ“Š ä»Šæ—¥DNSè¿‡æ»¤ç»Ÿè®¡ ($TODAY)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# æ€»æŸ¥è¯¢æ•°
total_queries=$(grep "$TODAY" "$LOG_FILE" | grep "query" | wc -l)
echo "æ€»æŸ¥è¯¢æ•°: $total_queries"

# è¢«æ‹¦æˆªçš„æŸ¥è¯¢
blocked_queries=$(grep "$TODAY" "$LOG_FILE" | grep "127.0.0.1" | wc -l)
echo "æ‹¦æˆªæŸ¥è¯¢: $blocked_queries"

# æ‹¦æˆªç‡
if [ $total_queries -gt 0 ]; then
    block_rate=$(echo "scale=2; $blocked_queries * 100 / $total_queries" | bc)
    echo "æ‹¦æˆªç‡: ${block_rate}%"
fi

# æœ€å¸¸è¢«æŸ¥è¯¢çš„åŸŸå
echo -e "\nğŸ” çƒ­é—¨æŸ¥è¯¢åŸŸå:"
grep "$TODAY" "$LOG_FILE" | grep "query" | \
awk '{print $6}' | sort | uniq -c | sort -rn | head -10

# æœ€å¸¸è¢«æ‹¦æˆªçš„åŸŸå
echo -e "\nğŸš« è¢«æ‹¦æˆªçš„åŸŸå:"
grep "$TODAY" "$LOG_FILE" | grep "127.0.0.1" | \
awk '{print $6}' | sort | uniq -c | sort -rn | head -10
```

---

## 5. ğŸ” DNSSECé…ç½®ä¸éªŒè¯


### 5.1 DNSSECåŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯DNSSECï¼Ÿ**
> DNSSECå°±åƒç»™DNSè®°å½•åŠ ä¸Š"é˜²ä¼ªæ ‡ç­¾"ï¼Œæ¯ä¸ªDNSè®°å½•éƒ½æœ‰æ•°å­—ç­¾åï¼Œç¡®ä¿ä½ æ”¶åˆ°çš„æ˜¯åŸå§‹ã€æœªè¢«ç¯¡æ”¹çš„DNSä¿¡æ¯ã€‚

```
æ— DNSSECçš„DNSæŸ¥è¯¢ï¼š
æŸ¥è¯¢: google.com
å“åº”: 172.217.160.78
é—®é¢˜: æ— æ³•ç¡®è®¤å“åº”æ˜¯å¦è¢«ç¯¡æ”¹

æœ‰DNSSECçš„DNSæŸ¥è¯¢ï¼š
æŸ¥è¯¢: google.com
å“åº”: 172.217.160.78 + æ•°å­—ç­¾å
éªŒè¯: æ£€æŸ¥ç­¾åæœ‰æ•ˆæ€§
ç»“æœ: âœ… ç­¾åæœ‰æ•ˆï¼Œæ•°æ®å¯ä¿¡
```

### 5.2 å¯ç”¨DNSSECéªŒè¯


#### ğŸ”¸ systemd-resolved DNSSECé…ç½®

```bash
# æ£€æŸ¥å½“å‰DNSSECçŠ¶æ€
systemd-resolve --status | grep DNSSEC

# ç¼–è¾‘systemd-resolvedé…ç½®
sudo tee /etc/systemd/resolved.conf > /dev/null << EOF
[Resolve]
DNS=1.1.1.1 8.8.8.8
DNSSEC=yes
DNSOverTLS=opportunistic
Cache=yes
DNSStubListener=yes
EOF

# é‡å¯æœåŠ¡
sudo systemctl restart systemd-resolved

# éªŒè¯DNSSECåŠŸèƒ½
systemd-resolve --status
```

#### ğŸ”¸ unbound DNSSECé…ç½®

```bash
# å®‰è£…unbound
sudo apt update && sudo apt install unbound

# é…ç½®unbound
sudo tee /etc/unbound/unbound.conf > /dev/null << EOF
server:
    # åŸºç¡€è®¾ç½®
    verbosity: 1
    interface: 127.0.0.1
    port: 53
    
    # DNSSECè®¾ç½®
    auto-trust-anchor-file: "/var/lib/unbound/root.key"
    val-log-level: 2
    
    # å®‰å…¨è®¾ç½®
    hide-identity: yes
    hide-version: yes
    
    # ç¼“å­˜è®¾ç½®
    cache-min-ttl: 300
    cache-max-ttl: 3600
    
    # è½¬å‘è®¾ç½®
forward-zone:
    name: "."
    forward-tls-upstream: yes
    forward-addr: 1.1.1.1@853
    forward-addr: 8.8.8.8@853
EOF

# ä¸‹è½½æ ¹å¯†é’¥
sudo unbound-anchor -a /var/lib/unbound/root.key

# å¯åŠ¨æœåŠ¡
sudo systemctl enable unbound
sudo systemctl start unbound
```

### 5.3 DNSSECéªŒè¯æµ‹è¯•


#### ğŸ”¸ éªŒè¯DNSSECåŠŸèƒ½

```bash
# æµ‹è¯•DNSSECéªŒè¯åŠŸèƒ½
dig +dnssec google.com

# æŸ¥çœ‹DNSSECçŠ¶æ€
dig +dnssec +multiline google.com

# æµ‹è¯•æ•…æ„å¤±è´¥çš„DNSSEC
dig +dnssec dnssec-failed.org
```

**DNSSECè®°å½•ç±»å‹è¯´æ˜**ï¼š
```
RRSIGè®°å½•ï¼šèµ„æºè®°å½•çš„æ•°å­—ç­¾å
DNSKEYè®°å½•ï¼šå…¬é’¥ä¿¡æ¯
DSè®°å½•ï¼šå§”æ‰˜ç­¾åè€…è®°å½•
NSEC/NSEC3è®°å½•ï¼šè¯æ˜ä¸å­˜åœ¨çš„è®°å½•
```

#### ğŸ”¸ DNSSECçŠ¶æ€æ£€æµ‹è„šæœ¬

```bash
#!/bin/bash
# DNSSECçŠ¶æ€æ£€æµ‹è„šæœ¬

DOMAINS=("google.com" "cloudflare.com" "github.com")

echo "ğŸ” DNSSECéªŒè¯çŠ¶æ€æ£€æµ‹"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

for domain in "${DOMAINS[@]}"; do
    echo -n "æ£€æµ‹ $domain ... "
    
    # æ£€æŸ¥DNSSECè®°å½•
    dnssec_result=$(dig +short +dnssec "$domain" | grep "RRSIG")
    
    if [ -n "$dnssec_result" ]; then
        # éªŒè¯ç­¾å
        validation=$(dig +dnssec "$domain" | grep "ad flag")
        if [ -n "$validation" ]; then
            echo "âœ… DNSSECå·²å¯ç”¨ä¸”éªŒè¯é€šè¿‡"
        else
            echo "âš ï¸  DNSSECå·²å¯ç”¨ä½†éªŒè¯å¤±è´¥"
        fi
    else
        echo "âŒ æœªå¯ç”¨DNSSEC"
    fi
done

# æ£€æŸ¥æœ¬åœ°DNSSECæ”¯æŒ
echo -e "\nğŸ”§ æœ¬åœ°DNSSECæ”¯æŒæ£€æµ‹:"
if command -v systemd-resolve &> /dev/null; then
    systemd_dnssec=$(systemd-resolve --status | grep "DNSSEC NTA" | wc -l)
    if [ $systemd_dnssec -eq 0 ]; then
        echo "âœ… systemd-resolvedæ”¯æŒDNSSEC"
    else
        echo "âŒ systemd-resolved DNSSECé…ç½®æœ‰é—®é¢˜"
    fi
fi
```

### 5.4 DNSSECæ•…éšœæ’é™¤


**å¸¸è§DNSSECé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**ï¼š

```
é—®é¢˜1ï¼šDNSSECéªŒè¯å¤±è´¥
ç°è±¡ï¼šç½‘ç«™æ— æ³•è®¿é—®ï¼ŒDNSæŸ¥è¯¢è¶…æ—¶
åŸå› ï¼šæ—¶é—´ä¸åŒæ­¥å¯¼è‡´ç­¾åéªŒè¯å¤±è´¥
è§£å†³ï¼šsudo ntpdate -s time.nist.gov

é—®é¢˜2ï¼šæŸäº›åŸŸåæ— æ³•è§£æ  
ç°è±¡ï¼šç‰¹å®šåŸŸåæŸ¥è¯¢å¤±è´¥
åŸå› ï¼šåŸŸåDNSSECé…ç½®é”™è¯¯
è§£å†³ï¼šä¸´æ—¶ç¦ç”¨DNSSECæˆ–ä½¿ç”¨å…¶ä»–DNSæœåŠ¡å™¨

é—®é¢˜3ï¼šDNSSECæ€§èƒ½å½±å“
ç°è±¡ï¼šDNSæŸ¥è¯¢å˜æ…¢
åŸå› ï¼šç­¾åéªŒè¯å¢åŠ è®¡ç®—å¼€é”€
è§£å†³ï¼šå¢åŠ ç¼“å­˜æ—¶é—´ï¼Œä½¿ç”¨æ€§èƒ½æ›´å¥½çš„DNSæœåŠ¡å™¨
```

---

## 6. ğŸŒ å…¬å…±DNSæœåŠ¡å™¨é€‰æ‹©é…ç½®


### 6.1 ä¸»æµå…¬å…±DNSæœåŠ¡å¯¹æ¯”


**å…¬å…±DNSæœåŠ¡å™¨ç‰¹ç‚¹åˆ†æ**ï¼š

| DNSæœåŠ¡å•† | **ä¸»DNS** | **å¤‡DNS** | **ç‰¹è‰²åŠŸèƒ½** | **éšç§æ”¿ç­–** | **é€‚ç”¨åœºæ™¯** |
|-----------|-----------|-----------|-------------|-------------|-------------|
| **Cloudflare** | `1.1.1.1` | `1.0.0.1` | `é€Ÿåº¦æœ€å¿«ï¼Œéšç§ä¿æŠ¤` | `ä¸è®°å½•æŸ¥è¯¢æ—¥å¿—` | `æ—¥å¸¸ä½¿ç”¨é¦–é€‰` |
| **Google** | `8.8.8.8` | `8.8.4.4` | `ç¨³å®šå¯é ï¼Œå…¨çƒèŠ‚ç‚¹` | `åŒ¿ååŒ–è®°å½•` | `ä¼ä¸šçº§åº”ç”¨` |
| **Quad9** | `9.9.9.9` | `149.112.112.112` | `æ¶æ„åŸŸåè¿‡æ»¤` | `éšç§å‹å¥½` | `å®‰å…¨è¦æ±‚é«˜` |
| **OpenDNS** | `208.67.222.222` | `208.67.220.220` | `å†…å®¹è¿‡æ»¤ï¼Œå®¶é•¿æ§åˆ¶` | `è®°å½•ç”¨äºå®‰å…¨` | `å®¶åº­ç½‘ç»œ` |

### 6.2 æœ€ä¼˜DNSæœåŠ¡å™¨é€‰æ‹©


#### ğŸ”¸ DNSæ€§èƒ½æµ‹è¯•å·¥å…·

```bash
#!/bin/bash
# DNSæ€§èƒ½ç»¼åˆæµ‹è¯•è„šæœ¬

DNS_SERVERS=(
    "1.1.1.1 Cloudflare"
    "8.8.8.8 Google"
    "9.9.9.9 Quad9"
    "208.67.222.222 OpenDNS"
    "114.114.114.114 114DNS"
)

TEST_DOMAINS=("google.com" "github.com" "stackoverflow.com" "wikipedia.org")

echo "ğŸš€ DNSæœåŠ¡å™¨æ€§èƒ½æµ‹è¯•"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

for server_info in "${DNS_SERVERS[@]}"; do
    server=$(echo $server_info | cut -d' ' -f1)
    name=$(echo $server_info | cut -d' ' -f2-)
    
    echo "ğŸ” æµ‹è¯• $name ($server)"
    
    total_time=0
    success_count=0
    
    for domain in "${TEST_DOMAINS[@]}"; do
        # æµ‹è¯•æŸ¥è¯¢æ—¶é—´
        result=$(dig +time=3 +tries=1 @$server $domain 2>/dev/null | grep "Query time:")
        
        if [ -n "$result" ]; then
            query_time=$(echo $result | grep -o '[0-9]\+' | head -1)
            total_time=$((total_time + query_time))
            success_count=$((success_count + 1))
            echo "  $domain: ${query_time}ms"
        else
            echo "  $domain: è¶…æ—¶"
        fi
    done
    
    if [ $success_count -gt 0 ]; then
        avg_time=$((total_time / success_count))
        echo "  å¹³å‡å“åº”æ—¶é—´: ${avg_time}ms"
        echo "  æˆåŠŸç‡: $((success_count * 100 / ${#TEST_DOMAINS[@]}))%"
    else
        echo "  å¹³å‡å“åº”æ—¶é—´: N/A"
        echo "  æˆåŠŸç‡: 0%"
    fi
    echo ""
done
```

#### ğŸ”¸ è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜DNS

```bash
#!/bin/bash
# è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜DNSæœåŠ¡å™¨

DNS_LIST=("1.1.1.1" "8.8.8.8" "9.9.9.9" "208.67.222.222")
BEST_DNS=""
BEST_TIME=9999

echo "ğŸ¯ è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜DNSæœåŠ¡å™¨..."

for dns in "${DNS_LIST[@]}"; do
    echo -n "æµ‹è¯• $dns ... "
    
    # æµ‹è¯•å»¶è¿Ÿ
    time_result=$(dig +time=2 +tries=1 @$dns google.com | grep "Query time:")
    
    if [ -n "$time_result" ]; then
        query_time=$(echo $time_result | grep -o '[0-9]\+')
        echo "${query_time}ms"
        
        # æ›´æ–°æœ€ä¼˜DNS
        if [ $query_time -lt $BEST_TIME ]; then
            BEST_TIME=$query_time
            BEST_DNS=$dns
        fi
    else
        echo "è¶…æ—¶"
    fi
done

if [ -n "$BEST_DNS" ]; then
    echo "ğŸ† æœ€ä¼˜DNSæœåŠ¡å™¨: $BEST_DNS (${BEST_TIME}ms)"
    
    # è¯¢é—®æ˜¯å¦åº”ç”¨é…ç½®
    read -p "æ˜¯å¦å°† $BEST_DNS è®¾ä¸ºç³»ç»ŸDNS? (y/n): " choice
    if [[ $choice == [Yy]* ]]; then
        sudo tee /etc/resolv.conf > /dev/null << EOF
nameserver $BEST_DNS
nameserver 8.8.8.8
EOF
        echo "âœ… DNSé…ç½®å·²æ›´æ–°"
    fi
else
    echo "âŒ æ— æ³•æ‰¾åˆ°å¯ç”¨çš„DNSæœåŠ¡å™¨"
fi
```

### 6.3 ç‰¹å®šåœºæ™¯DNSé…ç½®


#### ğŸ”¸ ä¼ä¸šç½‘ç»œDNSé…ç½®

```bash
# ä¼ä¸šçº§DNSé…ç½®ï¼ˆé«˜å¯ç”¨æ€§ï¼‰
sudo tee /etc/resolv.conf > /dev/null << EOF
# ä¸»DNSï¼šCloudflareï¼ˆé€Ÿåº¦å¿«ï¼‰
nameserver 1.1.1.1
nameserver 1.0.0.1

# å¤‡ç”¨DNSï¼šGoogleï¼ˆç¨³å®šæ€§å¥½ï¼‰
nameserver 8.8.8.8  
nameserver 8.8.4.4

# é…ç½®é€‰é¡¹
options timeout:3
options attempts:2
options rotate
options edns0
EOF
```

#### ğŸ”¸ å®¶åº­ç½‘ç»œDNSé…ç½®ï¼ˆå¸¦è¿‡æ»¤ï¼‰

```bash
# å®¶åº­ç½‘ç»œDNSé…ç½®ï¼ˆåŒ…å«å†…å®¹è¿‡æ»¤ï¼‰
sudo tee /etc/resolv.conf > /dev/null << EOF
# ä¸»DNSï¼šQuad9ï¼ˆæ¶æ„ç½‘ç«™è¿‡æ»¤ï¼‰
nameserver 9.9.9.9
nameserver 149.112.112.112

# å¤‡ç”¨DNSï¼šOpenDNSï¼ˆå®¶é•¿æ§åˆ¶ï¼‰
nameserver 208.67.222.222
nameserver 208.67.220.220

options timeout:2
options attempts:3
EOF
```

### 6.4 DNSé…ç½®ç®¡ç†


#### ğŸ”¸ DNSé…ç½®å¤‡ä»½ä¸æ¢å¤

```bash
# DNSé…ç½®ç®¡ç†è„šæœ¬
#!/bin/bash

BACKUP_DIR="/etc/dns-backups"
BACKUP_FILE="$BACKUP_DIR/resolv.conf.$(date +%Y%m%d_%H%M%S)"

case "$1" in
    backup)
        mkdir -p "$BACKUP_DIR"
        cp /etc/resolv.conf "$BACKUP_FILE"
        echo "âœ… DNSé…ç½®å·²å¤‡ä»½åˆ°: $BACKUP_FILE"
        ;;
    
    restore)
        if [ -z "$2" ]; then
            echo "æœ€è¿‘çš„å¤‡ä»½æ–‡ä»¶:"
            ls -lt "$BACKUP_DIR"/ | head -5
            read -p "è¯·è¾“å…¥è¦æ¢å¤çš„å¤‡ä»½æ–‡ä»¶å: " backup_name
            restore_file="$BACKUP_DIR/$backup_name"
        else
            restore_file="$2"
        fi
        
        if [ -f "$restore_file" ]; then
            sudo cp "$restore_file" /etc/resolv.conf
            echo "âœ… DNSé…ç½®å·²æ¢å¤"
        else
            echo "âŒ å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        ;;
    
    list)
        echo "ğŸ—‚ï¸  å¯ç”¨çš„DNSé…ç½®å¤‡ä»½:"
        ls -la "$BACKUP_DIR"/
        ;;
    
    *)
        echo "ç”¨æ³•: $0 {backup|restore [æ–‡ä»¶]|list}"
        ;;
esac
```

---

## 7. ğŸ” DNSæŸ¥è¯¢åŠ å¯†ä¼ è¾“æŠ€æœ¯


### 7.1 DNSåŠ å¯†ä¼ è¾“åè®®å¯¹æ¯”


**DNSåŠ å¯†ä¼ è¾“æŠ€æœ¯æ¦‚è§ˆ**ï¼š

```
ä¼ ç»ŸDNS (Port 53)ï¼š
æ˜æ–‡ä¼ è¾“ â†’ å®¹æ˜“è¢«ç›‘å¬å’Œç¯¡æ”¹

DoT (DNS over TLS, Port 853)ï¼š
TLSåŠ å¯† â†’ ä¸“ç”¨ç«¯å£ï¼Œæ˜“è¢«æ£€æµ‹å’Œå°é”

DoH (DNS over HTTPS, Port 443)ï¼š
HTTPSåŠ å¯† â†’ ä¼ªè£…æˆç½‘é¡µæµé‡ï¼Œéš¾ä»¥æ£€æµ‹

DoQ (DNS over QUIC)ï¼š
QUICåè®® â†’ æ›´å¿«çš„è¿æ¥å»ºç«‹ï¼ŒæŠ—ç½‘ç»œæŠ–åŠ¨
```

### 7.2 DoTï¼ˆDNS over TLSï¼‰é…ç½®


#### ğŸ”¸ stunnelé…ç½®DoT

```bash
# å®‰è£…stunnel
sudo apt update && sudo apt install stunnel4

# åˆ›å»ºDoTé…ç½®
sudo tee /etc/stunnel/dot.conf > /dev/null << EOF
[cloudflare-dot]
accept = 127.0.0.1:853
connect = 1.1.1.1:853
cert = /etc/ssl/certs/ca-certificates.crt

[google-dot] 
accept = 127.0.0.1:854
connect = 8.8.8.8:853
cert = /etc/ssl/certs/ca-certificates.crt
EOF

# å¯ç”¨stunnel
sudo systemctl enable stunnel4
sudo systemctl start stunnel4

# é…ç½®ç³»ç»Ÿä½¿ç”¨DoT
sudo tee /etc/resolv.conf > /dev/null << EOF
nameserver 127.0.0.1
nameserver 127.0.0.1
options timeout:3
EOF
```

#### ğŸ”¸ systemd-resolved DoTé…ç½®

```bash
# é…ç½®systemd-resolvedä½¿ç”¨DoT
sudo tee /etc/systemd/resolved.conf > /dev/null << EOF
[Resolve]
DNS=1.1.1.1#cloudflare-dns.com 8.8.8.8#dns.google
DNSOverTLS=yes
DNSSEC=yes
Cache=yes
DNSStubListener=yes
EOF

# é‡å¯æœåŠ¡
sudo systemctl restart systemd-resolved

# éªŒè¯DoTçŠ¶æ€
systemd-resolve --status | grep "DNS over TLS"
```

### 7.3 é«˜çº§DNSåŠ å¯†é…ç½®


#### ğŸ”¸ dnscrypt-proxyé…ç½®

```bash
# å®‰è£…dnscrypt-proxy
wget https://github.com/DNSCrypt/dnscrypt-proxy/releases/latest/download/dnscrypt-proxy-linux_x86_64-2.1.2.tar.gz
tar -xzf dnscrypt-proxy-linux_x86_64-2.1.2.tar.gz
sudo mv dnscrypt-proxy /usr/local/bin/

# åˆ›å»ºé…ç½®æ–‡ä»¶
sudo mkdir -p /etc/dnscrypt-proxy
sudo tee /etc/dnscrypt-proxy/dnscrypt-proxy.toml > /dev/null << EOF
#########################

#        Global          #
#########################


server_names = ['cloudflare', 'google']
listen_addresses = ['127.0.0.1:53']
max_clients = 250
ipv4_servers = true
ipv6_servers = false
dnscrypt_servers = true
doh_servers = true
require_dnssec = true
require_nolog = true
require_nofilter = false
force_tcp = false
timeout = 5000
keepalive = 30
lb_estimator = true
log_level = 2
use_syslog = true

# ç¼“å­˜é…ç½®
cache = true
cache_size = 4096
cache_min_ttl = 2400
cache_max_ttl = 86400

# æŸ¥è¯¢æ—¥å¿—
query_log = '/var/log/dnscrypt-proxy/query.log'

# è¢«æ‹’ç»çš„æŸ¥è¯¢æ—¥å¿—
refused_code_in_logs = true
EOF

# åˆ›å»ºç³»ç»ŸæœåŠ¡
sudo tee /etc/systemd/system/dnscrypt-proxy.service > /dev/null << EOF
[Unit]
Description=DNSCrypt proxy
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/dnscrypt-proxy -config /etc/dnscrypt-proxy/dnscrypt-proxy.toml
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
sudo systemctl enable dnscrypt-proxy
sudo systemctl start dnscrypt-proxy
```

### 7.4 DNSåŠ å¯†ä¼ è¾“éªŒè¯


#### ğŸ”¸ éªŒè¯DNSåŠ å¯†çŠ¶æ€

```bash
#!/bin/bash
# DNSåŠ å¯†ä¼ è¾“éªŒè¯è„šæœ¬

echo "ğŸ” DNSåŠ å¯†ä¼ è¾“çŠ¶æ€æ£€æµ‹"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# 1. æ£€æŸ¥DoTçŠ¶æ€
echo "1ï¸âƒ£ æ£€æŸ¥DNS over TLS (DoT)..."
if systemctl is-active --quiet systemd-resolved; then
    dot_status=$(systemd-resolve --status | grep "DNS over TLS")
    if [ -n "$dot_status" ]; then
        echo "âœ… DoTå·²å¯ç”¨: $dot_status"
    else
        echo "âŒ DoTæœªå¯ç”¨"
    fi
else
    echo "âš ï¸  systemd-resolvedæœªè¿è¡Œ"
fi

# 2. æ£€æŸ¥DoHçŠ¶æ€  
echo -e "\n2ï¸âƒ£ æ£€æŸ¥DNS over HTTPS (DoH)..."
if pgrep -f cloudflared > /dev/null; then
    echo "âœ… cloudflared DoHä»£ç†æ­£åœ¨è¿è¡Œ"
    
    # æµ‹è¯•DoHæŸ¥è¯¢
    doh_test=$(dig @127.0.0.1 -p 5053 google.com +short 2>/dev/null)
    if [ -n "$doh_test" ]; then
        echo "âœ… DoHæŸ¥è¯¢æµ‹è¯•æˆåŠŸ: $doh_test"
    else
        echo "âŒ DoHæŸ¥è¯¢æµ‹è¯•å¤±è´¥"
    fi
else
    echo "âŒ DoHä»£ç†æœªè¿è¡Œ"
fi

# 3. æ£€æŸ¥DNSCryptçŠ¶æ€
echo -e "\n3ï¸âƒ£ æ£€æŸ¥DNSCryptçŠ¶æ€..."
if pgrep -f dnscrypt-proxy > /dev/null; then
    echo "âœ… dnscrypt-proxyæ­£åœ¨è¿è¡Œ"
else
    echo "âŒ dnscrypt-proxyæœªè¿è¡Œ"
fi

# 4. ç½‘ç»œæµé‡åˆ†æ
echo -e "\n4ï¸âƒ£ åˆ†æDNSæŸ¥è¯¢æµé‡..."
echo "æ‰§è¡Œæµ‹è¯•æŸ¥è¯¢..."
dig google.com > /dev/null 2>&1

# æ£€æŸ¥ç«¯å£53æµé‡ï¼ˆæ˜æ–‡DNSï¼‰
port53_traffic=$(sudo netstat -tuln | grep ":53 ")
if [ -z "$port53_traffic" ]; then
    echo "âœ… æœªæ£€æµ‹åˆ°ç«¯å£53æ˜æ–‡DNSæµé‡"
else
    echo "âš ï¸  æ£€æµ‹åˆ°ç«¯å£53æµé‡ï¼Œå¯èƒ½ä½¿ç”¨æ˜æ–‡DNS"
fi

# æ£€æŸ¥ç«¯å£853æµé‡ï¼ˆDoTï¼‰
port853_traffic=$(sudo netstat -tuln | grep ":853")
if [ -n "$port853_traffic" ]; then
    echo "âœ… æ£€æµ‹åˆ°ç«¯å£853æµé‡ï¼Œæ­£åœ¨ä½¿ç”¨DoT"
fi

echo -e "\nğŸ“Š DNSåŠ å¯†çŠ¶æ€æ€»ç»“:"
if pgrep -f "cloudflared\|dnscrypt-proxy" > /dev/null || [ -n "$dot_status" ]; then
    echo "ğŸ”’ DNSæŸ¥è¯¢å·²åŠ å¯†ä¿æŠ¤"
else
    echo "âš ï¸  DNSæŸ¥è¯¢å¯èƒ½æœªåŠ å¯†ï¼Œå»ºè®®å¯ç”¨DoH/DoT"
fi
```

---

## 8. ğŸ” DNSæ³„éœ²æ£€æµ‹ä¸é˜²æŠ¤


### 8.1 DNSæ³„éœ²åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯DNSæ³„éœ²ï¼Ÿ**
> DNSæ³„éœ²å°±åƒ"éšç§æ¼æ–—"ï¼Œå³ä½¿ä½ ä½¿ç”¨VPNéšè—çœŸå®IPï¼Œä½†DNSæŸ¥è¯¢å¯èƒ½ä»ç„¶é€šè¿‡ISPçš„æœåŠ¡å™¨ï¼Œæš´éœ²ä½ çš„æµè§ˆä¹ æƒ¯ã€‚

```
æ­£å¸¸VPNä¿æŠ¤ï¼š
ç”¨æˆ· â†’ VPNåŠ å¯†éš§é“ â†’ VPNæœåŠ¡å™¨ â†’ ç›®æ ‡ç½‘ç«™
DNSæŸ¥è¯¢ä¹Ÿé€šè¿‡VPN â†’ âœ… éšç§ä¿æŠ¤å®Œæ•´

DNSæ³„éœ²æƒ…å†µï¼š
ç”¨æˆ· â†’ VPNåŠ å¯†éš§é“ â†’ VPNæœåŠ¡å™¨ â†’ ç›®æ ‡ç½‘ç«™
DNSæŸ¥è¯¢ç›´æ¥å‘é€ç»™ISP â†’ âŒ éšç§æ³„éœ²
```

### 8.2 DNSæ³„éœ²æ£€æµ‹æ–¹æ³•


#### ğŸ”¸ åœ¨çº¿DNSæ³„éœ²æ£€æµ‹

**æ¨èæ£€æµ‹ç½‘ç«™**ï¼š
- `https://dnsleaktest.com/`
- `https://www.whatismyipaddress.com/dns-leak-test/`
- `https://ipleak.net/`

**æ£€æµ‹æ­¥éª¤**ï¼š
1. è¿æ¥VPNæœåŠ¡
2. è®¿é—®æ£€æµ‹ç½‘ç«™
3. æŸ¥çœ‹DNSæœåŠ¡å™¨ä½ç½®
4. ç¡®è®¤æ˜¯å¦ä¸VPNæœåŠ¡å™¨ä½ç½®ä¸€è‡´

#### ğŸ”¸ å‘½ä»¤è¡ŒDNSæ³„éœ²æ£€æµ‹

```bash
#!/bin/bash
# DNSæ³„éœ²æ£€æµ‹è„šæœ¬

echo "ğŸ” DNSæ³„éœ²æ£€æµ‹å·¥å…·"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# 1. æ£€æµ‹å½“å‰å…¬ç½‘IP
echo "1ï¸âƒ£ æ£€æµ‹å½“å‰å…¬ç½‘IP..."
current_ip=$(curl -s ifconfig.me)
echo "å½“å‰å…¬ç½‘IP: $current_ip"

# 2. æ£€æµ‹IPåœ°ç†ä½ç½®
echo -e "\n2ï¸âƒ£ æ£€æµ‹IPåœ°ç†ä½ç½®..."
ip_location=$(curl -s "http://ip-api.com/line/$current_ip?fields=country,regionName,city,isp")
echo "ä½ç½®ä¿¡æ¯: $ip_location"

# 3. æ£€æµ‹DNSæœåŠ¡å™¨
echo -e "\n3ï¸âƒ£ æ£€æµ‹å½“å‰DNSæœåŠ¡å™¨..."
dns_servers=$(cat /etc/resolv.conf | grep nameserver | awk '{print $2}')
echo "é…ç½®çš„DNSæœåŠ¡å™¨:"
for dns in $dns_servers; do
    echo "  $dns"
    
    # æ£€æµ‹DNSæœåŠ¡å™¨ä½ç½®
    dns_location=$(curl -s "http://ip-api.com/line/$dns?fields=country,city,isp" 2>/dev/null)
    if [ -n "$dns_location" ]; then
        echo "    ä½ç½®: $dns_location"
    fi
done

# 4. æ‰§è¡ŒDNSæŸ¥è¯¢æµ‹è¯•
echo -e "\n4ï¸âƒ£ DNSæŸ¥è¯¢æµ‹è¯•..."
test_domains=("google.com" "facebook.com" "youtube.com")

for domain in "${test_domains[@]}"; do
    echo "æŸ¥è¯¢ $domain:"
    dig +short $domain | head -3
done

# 5. æ£€æµ‹DNSæŸ¥è¯¢è·¯å¾„
echo -e "\n5ï¸âƒ£ æ£€æµ‹DNSæŸ¥è¯¢è·¯å¾„..."
tcpdump -i any -c 5 port 53 2>/dev/null &
tcpdump_pid=$!
sleep 1

# æ‰§è¡Œæµ‹è¯•æŸ¥è¯¢
dig test.example.com > /dev/null 2>&1
sleep 2

# åœæ­¢æŠ“åŒ…
kill $tcpdump_pid 2>/dev/null

echo "âœ… DNSæ³„éœ²æ£€æµ‹å®Œæˆ"
```

### 8.3 DNSæ³„éœ²é˜²æŠ¤é…ç½®


#### ğŸ”¸ é˜²ç«å¢™DNSæ³„éœ²é˜²æŠ¤

```bash
#!/bin/bash
# é˜²ç«å¢™DNSæ³„éœ²é˜²æŠ¤é…ç½®

echo "ğŸ›¡ï¸ é…ç½®é˜²ç«å¢™DNSæ³„éœ²é˜²æŠ¤..."

# 1. å¤‡ä»½å½“å‰iptablesè§„åˆ™
sudo iptables-save > /tmp/iptables-backup.rules

# 2. é˜»æ­¢ç›´æ¥DNSæŸ¥è¯¢ï¼ˆä»…å…è®¸é€šè¿‡æŒ‡å®šDNSï¼‰
ALLOWED_DNS="1.1.1.1 8.8.8.8"
VPN_INTERFACE="tun0"  # æ ¹æ®å®é™…VPNæ¥å£è°ƒæ•´

# æ¸…é™¤ç°æœ‰DNSè§„åˆ™
sudo iptables -D OUTPUT -p udp --dport 53 -j DROP 2>/dev/null
sudo iptables -D OUTPUT -p tcp --dport 53 -j DROP 2>/dev/null

# å…è®¸æœ¬åœ°DNSæŸ¥è¯¢
sudo iptables -I OUTPUT -o lo -p udp --dport 53 -j ACCEPT
sudo iptables -I OUTPUT -o lo -p tcp --dport 53 -j ACCEPT

# å…è®¸æŒ‡å®šDNSæœåŠ¡å™¨
for dns_ip in $ALLOWED_DNS; do
    sudo iptables -I OUTPUT -d $dns_ip -p udp --dport 53 -j ACCEPT
    sudo iptables -I OUTPUT -d $dns_ip -p tcp --dport 53 -j ACCEPT
    echo "âœ… å…è®¸DNSæŸ¥è¯¢åˆ° $dns_ip"
done

# å…è®¸é€šè¿‡VPNæ¥å£çš„DNSæŸ¥è¯¢
if [ -n "$VPN_INTERFACE" ] && ip link show $VPN_INTERFACE &>/dev/null; then
    sudo iptables -I OUTPUT -o $VPN_INTERFACE -p udp --dport 53 -j ACCEPT
    sudo iptables -I OUTPUT -o $VPN_INTERFACE -p tcp --dport 53 -j ACCEPT
    echo "âœ… å…è®¸é€šè¿‡VPNæ¥å£ $VPN_INTERFACE çš„DNSæŸ¥è¯¢"
fi

# é˜»æ­¢å…¶ä»–æ‰€æœ‰DNSæŸ¥è¯¢
sudo iptables -A OUTPUT -p udp --dport 53 -j DROP
sudo iptables -A OUTPUT -p tcp --dport 53 -j DROP

echo "ğŸ”’ DNSæ³„éœ²é˜²æŠ¤è§„åˆ™å·²ç”Ÿæ•ˆ"
echo "âš ï¸  å¦‚éœ€æ¢å¤åŸå§‹è§„åˆ™ï¼Œè¯·æ‰§è¡Œ:"
echo "sudo iptables-restore < /tmp/iptables-backup.rules"
```

#### ğŸ”¸ VPNç¯å¢ƒDNSé…ç½®

```bash
# VPNä¸“ç”¨DNSé…ç½®è„šæœ¬
#!/bin/bash

VPN_DNS_SERVERS=("10.8.0.1" "1.1.1.1")  # æ ¹æ®VPNæä¾›å•†è°ƒæ•´
ORIGINAL_RESOLV="/etc/resolv.conf.original"

case "$1" in
    connect)
        echo "ğŸ”Œ é…ç½®VPN DNSè®¾ç½®..."
        
        # å¤‡ä»½åŸå§‹DNSé…ç½®
        if [ ! -f "$ORIGINAL_RESOLV" ]; then
            sudo cp /etc/resolv.conf "$ORIGINAL_RESOLV"
        fi
        
        # è®¾ç½®VPN DNS
        sudo tee /etc/resolv.conf > /dev/null << EOF
# VPN DNSé…ç½®
$(for dns in "${VPN_DNS_SERVERS[@]}"; do echo "nameserver $dns"; done)

# é…ç½®é€‰é¡¹
options timeout:3
options attempts:2
EOF
        
        echo "âœ… VPN DNSé…ç½®å®Œæˆ"
        ;;
    
    disconnect)
        echo "ğŸ”Œ æ¢å¤åŸå§‹DNSè®¾ç½®..."
        
        if [ -f "$ORIGINAL_RESOLV" ]; then
            sudo cp "$ORIGINAL_RESOLV" /etc/resolv.conf
            echo "âœ… åŸå§‹DNSé…ç½®å·²æ¢å¤"
        else
            echo "âŒ åŸå§‹DNSé…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
        fi
        ;;
    
    status)
        echo "ğŸ“Š å½“å‰DNSé…ç½®:"
        cat /etc/resolv.conf
        
        echo -e "\nğŸ” DNSæ³„éœ²æ£€æµ‹:"
        current_dns=$(cat /etc/resolv.conf | grep nameserver | head -1 | awk '{print $2}')
        curl -s "https://dns.google/resolve?name=google.com&type=A" > /dev/null
        echo "å½“å‰ä½¿ç”¨DNS: $current_dns"
        ;;
    
    *)
        echo "ç”¨æ³•: $0 {connect|disconnect|status}"
        echo "  connect    - è®¾ç½®VPN DNSé…ç½®"
        echo "  disconnect - æ¢å¤åŸå§‹DNSé…ç½®"  
        echo "  status     - æ˜¾ç¤ºå½“å‰DNSçŠ¶æ€"
        ;;
esac
```

### 8.4 è‡ªåŠ¨åŒ–DNSé˜²æŠ¤ç›‘æ§


```bash
#!/bin/bash
# DNSé˜²æŠ¤çŠ¶æ€ç›‘æ§è„šæœ¬

MONITOR_LOG="/var/log/dns-protection.log"
EXPECTED_DNS=("1.1.1.1" "8.8.8.8")

# æ—¥å¿—å‡½æ•°
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | sudo tee -a "$MONITOR_LOG"
}

# DNSé…ç½®æ£€æŸ¥
check_dns_config() {
    current_dns=($(cat /etc/resolv.conf | grep nameserver | awk '{print $2}'))
    
    for expected in "${EXPECTED_DNS[@]}"; do
        found=false
        for current in "${current_dns[@]}"; do
            if [ "$expected" = "$current" ]; then
                found=true
                break
            fi
        done
        
        if [ "$found" = false ]; then
            log_message "âš ï¸  è­¦å‘Š: æœŸæœ›çš„DNSæœåŠ¡å™¨ $expected æœªåœ¨é…ç½®ä¸­"
            return 1
        fi
    done
    
    return 0
}

# ç½‘ç»œè¿æ¥æ£€æŸ¥
check_network_connectivity() {
    if ping -c 1 -W 3 8.8.8.8 > /dev/null 2>&1; then
        return 0
    else
        log_message "âŒ ç½‘ç»œè¿æ¥å¼‚å¸¸"
        return 1
    fi
}

# DNSæŸ¥è¯¢æµ‹è¯•
test_dns_resolution() {
    test_domain="google.com"
    
    if dig +time=3 +tries=1 "$test_domain" > /dev/null 2>&1; then
        return 0
    else
        log_message "âŒ DNSè§£æå¤±è´¥: $test_domain"
        return 1
    fi
}

# ä¸»ç›‘æ§å¾ªç¯
echo "ğŸ” å¯åŠ¨DNSé˜²æŠ¤ç›‘æ§..."
log_message "ğŸš€ DNSé˜²æŠ¤ç›‘æ§å¯åŠ¨"

while true; do
    # æ£€æŸ¥DNSé…ç½®
    if ! check_dns_config; then
        log_message "ğŸ”§ è‡ªåŠ¨ä¿®å¤DNSé…ç½®..."
        
        # æ¢å¤DNSé…ç½®
        sudo tee /etc/resolv.conf > /dev/null << EOF
$(for dns in "${EXPECTED_DNS[@]}"; do echo "nameserver $dns"; done)
options timeout:3
EOF
        log_message "âœ… DNSé…ç½®å·²è‡ªåŠ¨ä¿®å¤"
    fi
    
    # æ£€æŸ¥ç½‘ç»œè¿æ¥
    if check_network_connectivity && test_dns_resolution; then
        log_message "âœ… DNSé˜²æŠ¤çŠ¶æ€æ­£å¸¸"
    fi
    
    # ç­‰å¾…ä¸‹æ¬¡æ£€æŸ¥
    sleep 300  # 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
done
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ DNSå®‰å…¨å¨èƒï¼šåŠ«æŒã€ç¼“å­˜æŠ•æ¯’ã€éš§é“æ”»å‡»ç­‰å¸¸è§å¨èƒç±»å‹
ğŸ”¸ DNSåŠ«æŒé˜²æŠ¤ï¼šæ£€æµ‹æ–¹æ³•ã€æœ¬åœ°é˜²æŠ¤ã€è·¯ç”±å™¨çº§é˜²æŠ¤
ğŸ”¸ DoHåŠ å¯†æŠ€æœ¯ï¼šæµè§ˆå™¨é…ç½®ã€ç³»ç»Ÿçº§éƒ¨ç½²ã€æ€§èƒ½ä¼˜åŒ–
ğŸ”¸ DNSè¿‡æ»¤æœºåˆ¶ï¼šPi-holeã€dnsmasqç­‰å·¥å…·çš„éƒ¨ç½²ä¸ç®¡ç†
ğŸ”¸ DNSSECéªŒè¯ï¼šæ•°å­—ç­¾åéªŒè¯ã€é…ç½®æ–¹æ³•ã€æ•…éšœæ’é™¤
ğŸ”¸ å…¬å…±DNSé€‰æ‹©ï¼šæ€§èƒ½æµ‹è¯•ã€ç‰¹æ€§å¯¹æ¯”ã€åœºæ™¯é€‚é…
ğŸ”¸ åŠ å¯†ä¼ è¾“åè®®ï¼šDoTã€DoHã€DNSCryptç­‰æŠ€æœ¯å¯¹æ¯”
ğŸ”¸ DNSæ³„éœ²é˜²æŠ¤ï¼šæ£€æµ‹æ–¹æ³•ã€é˜²ç«å¢™é…ç½®ã€VPNç¯å¢ƒå¤„ç†
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ DNSå®‰å…¨é˜²æŠ¤å±‚æ¬¡**
```
ç½‘ç»œå±‚é˜²æŠ¤ï¼š
é˜²ç«å¢™è§„åˆ™ + è·¯ç”±å™¨é…ç½® â†’ åŸºç¡€é˜²æŠ¤

ä¼ è¾“å±‚é˜²æŠ¤ï¼š
DoT/DoHåŠ å¯† + å®‰å…¨åè®® â†’ ä¼ è¾“å®‰å…¨

åº”ç”¨å±‚é˜²æŠ¤ï¼š
åŸŸåè¿‡æ»¤ + æ¶æ„ç½‘ç«™æ‹¦æˆª â†’ å†…å®¹å®‰å…¨

æ•°æ®å±‚é˜²æŠ¤ï¼š
DNSSECéªŒè¯ + æ•°å­—ç­¾å â†’ æ•°æ®å®Œæ•´æ€§
```

**ğŸ”¹ åŠ å¯†DNSæŠ€æœ¯é€‰æ‹©**
```
æ€§èƒ½ä¼˜å…ˆï¼šDoT (DNS over TLS)
éšè”½æ€§ä¼˜å…ˆï¼šDoH (DNS over HTTPS)  
å…¼å®¹æ€§ä¼˜å…ˆï¼šDNSCrypt
ä¼ä¸šç¯å¢ƒï¼šDNSSEC + DoTç»„åˆ
```

**ğŸ”¹ å…¬å…±DNSæœåŠ¡å™¨é€‰æ‹©ç­–ç•¥**
```
æ—¥å¸¸ä½¿ç”¨ï¼šCloudflare (1.1.1.1) - é€Ÿåº¦å¿«ï¼Œéšç§å¥½
ä¼ä¸šç¯å¢ƒï¼šGoogle (8.8.8.8) - ç¨³å®šæ€§é«˜
å®‰å…¨éœ€æ±‚ï¼šQuad9 (9.9.9.9) - æ¶æ„åŸŸåè¿‡æ»¤
å®¶åº­ç½‘ç»œï¼šOpenDNS - å†…å®¹è¿‡æ»¤å’Œå®¶é•¿æ§åˆ¶
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä¸åŒåœºæ™¯çš„DNSå®‰å…¨é…ç½®**

```
å®¶åº­ç½‘ç»œé…ç½®ï¼š
è·¯ç”±å™¨DNSï¼š1.1.1.1 + 9.9.9.9 (é€Ÿåº¦+å®‰å…¨)
è®¾å¤‡DNSï¼šå¯ç”¨DoH/DoT
é¢å¤–é˜²æŠ¤ï¼šPi-holeéƒ¨ç½²

ä¼ä¸šç½‘ç»œé…ç½®ï¼š  
ä¸»DNSï¼š8.8.8.8 + 1.1.1.1 (ç¨³å®š+é€Ÿåº¦)
å®‰å…¨å¢å¼ºï¼šDNSSECéªŒè¯
ç›‘æ§å·¥å…·ï¼šDNSæŸ¥è¯¢æ—¥å¿—åˆ†æ

å¼€å‘è€…ç¯å¢ƒï¼š
çµæ´»é…ç½®ï¼šå¤šDNSæœåŠ¡å™¨è½®è¯¢
æµ‹è¯•å·¥å…·ï¼šDNSæ³„éœ²æ£€æµ‹è„šæœ¬
è°ƒè¯•æ”¯æŒï¼šè¯¦ç»†DNSæ—¥å¿—è®°å½•
```

**ğŸ¯ DNSå®‰å…¨æœ€ä½³å®è·µ**

```
åŸºç¡€å®‰å…¨æªæ–½ï¼š
âœ… ä½¿ç”¨å¯ä¿¡çš„å…¬å…±DNSæœåŠ¡å™¨
âœ… å¯ç”¨DoHæˆ–DoTåŠ å¯†ä¼ è¾“
âœ… å®šæœŸæ£€æµ‹DNSæ³„éœ²
âœ… é…ç½®DNSSECéªŒè¯

é«˜çº§å®‰å…¨æªæ–½ï¼š
âœ… éƒ¨ç½²DNSè¿‡æ»¤ç³»ç»Ÿï¼ˆPi-holeç­‰ï¼‰
âœ… è®¾ç½®é˜²ç«å¢™DNSé˜²æŠ¤è§„åˆ™
âœ… å®æ–½DNSæŸ¥è¯¢ç›‘æ§
âœ… å»ºç«‹DNSå®‰å…¨åº”æ€¥å“åº”æœºåˆ¶

è¿ç»´ç›‘æ§è¦æ±‚ï¼š
âœ… å®šæœŸè¿›è¡ŒDNSæ€§èƒ½æµ‹è¯•
âœ… ç›‘æ§DNSè§£æå¼‚å¸¸
âœ… ç»´æŠ¤DNSé…ç½®å¤‡ä»½
âœ… æ›´æ–°DNSå®‰å…¨å¨èƒæƒ…æŠ¥
```

### 9.4 æ•…éšœè¯Šæ–­ä¸é—®é¢˜è§£å†³


**ğŸ”§ å¸¸è§DNSå®‰å…¨é—®é¢˜è¯Šæ–­**

```
é—®é¢˜1ï¼šDNSè§£æå¼‚å¸¸ç¼“æ…¢
ç°è±¡ï¼šç½‘ç«™è®¿é—®é€Ÿåº¦æ˜æ˜¾ä¸‹é™
è¯Šæ–­ï¼šdig +trace google.com æŸ¥çœ‹è§£æè·¯å¾„
è§£å†³ï¼šæ›´æ¢DNSæœåŠ¡å™¨ï¼Œæ¸…é™¤æœ¬åœ°ç¼“å­˜

é—®é¢˜2ï¼šDNSSECéªŒè¯å¤±è´¥
ç°è±¡ï¼šæŸäº›ç½‘ç«™æ— æ³•è®¿é—®ï¼ŒæŠ¥DNSSECé”™è¯¯
è¯Šæ–­ï¼šdig +dnssec åŸŸå æ£€æŸ¥ç­¾åçŠ¶æ€
è§£å†³ï¼šåŒæ­¥ç³»ç»Ÿæ—¶é—´ï¼Œæˆ–ä¸´æ—¶ç¦ç”¨DNSSEC

é—®é¢˜3ï¼šDoH/DoTè¿æ¥ä¸ç¨³å®š
ç°è±¡ï¼šåŠ å¯†DNSæ—¶æ–­æ—¶ç»­
è¯Šæ–­ï¼šæ£€æŸ¥é˜²ç«å¢™è§„åˆ™å’Œç½‘ç»œè¿æ¥
è§£å†³ï¼šé…ç½®å¤‡ç”¨DNSæœåŠ¡å™¨ï¼Œè°ƒæ•´è¶…æ—¶è®¾ç½®

é—®é¢˜4ï¼šDNSæ³„éœ²æŒç»­å‘ç”Ÿ
ç°è±¡ï¼šVPNç¯å¢ƒä¸‹ä»æ£€æµ‹åˆ°DNSæ³„éœ²
è¯Šæ–­ï¼šnetstat -tuln | grep 53 æ£€æŸ¥è¿æ¥
è§£å†³ï¼šå¼ºåŒ–é˜²ç«å¢™è§„åˆ™ï¼Œä½¿ç”¨DNSç»‘å®š
```

### 9.5 å®‰å…¨é˜²æŠ¤æ£€æŸ¥æ¸…å•


**ğŸ“‹ DNSå®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•**

```
åŸºç¡€é…ç½®æ£€æŸ¥ï¼š
â–¡ å·²é…ç½®å¯ä¿¡çš„å…¬å…±DNSæœåŠ¡å™¨
â–¡ DNSæœåŠ¡å™¨å“åº”æ—¶é—´æ­£å¸¸(<100ms)
â–¡ å·²å¤‡ä»½åŸå§‹DNSé…ç½®æ–‡ä»¶
â–¡ é˜²ç«å¢™å…è®¸DNSæŸ¥è¯¢é€šè¿‡

åŠ å¯†ä¼ è¾“æ£€æŸ¥ï¼š
â–¡ å·²å¯ç”¨DoHæˆ–DoTåŠ å¯†ä¼ è¾“
â–¡ æµè§ˆå™¨DNSå®‰å…¨è®¾ç½®å·²é…ç½®
â–¡ ç³»ç»Ÿçº§DNSåŠ å¯†ä»£ç†è¿è¡Œæ­£å¸¸
â–¡ åŠ å¯†DNSæœåŠ¡å™¨è¿æ¥ç¨³å®š

å®‰å…¨é˜²æŠ¤æ£€æŸ¥ï¼š
â–¡ DNSSECéªŒè¯åŠŸèƒ½å·²å¯ç”¨
â–¡ DNSè¿‡æ»¤ç³»ç»Ÿè¿è¡Œæ­£å¸¸
â–¡ æ¶æ„åŸŸåæ‹¦æˆªåˆ—è¡¨å·²æ›´æ–°
â–¡ DNSæŸ¥è¯¢æ—¥å¿—ç›‘æ§å·²é…ç½®

éšç§ä¿æŠ¤æ£€æŸ¥ï¼š
â–¡ å·²è¿›è¡ŒDNSæ³„éœ²æ£€æµ‹
â–¡ VPNç¯å¢ƒDNSé…ç½®æ­£ç¡®
â–¡ æ— æ˜æ–‡DNSæŸ¥è¯¢æ³„éœ²
â–¡ DNSæŸ¥è¯¢éšç§ç­–ç•¥å·²äº†è§£
```

### 9.6 è¿›é˜¶å­¦ä¹ å»ºè®®


**ğŸ“ DNSå®‰å…¨æŠ€æœ¯å‘å±•æ–¹å‘**

```
æŠ€æœ¯è¶‹åŠ¿å…³æ³¨ï¼š
â€¢ DoQ (DNS over QUIC) æ–°å…´åè®®
â€¢ åŒºå—é“¾DNSè§£å†³æ–¹æ¡ˆ
â€¢ AIé©±åŠ¨çš„æ¶æ„åŸŸåæ£€æµ‹
â€¢ è¾¹ç¼˜è®¡ç®—DNSæœåŠ¡

å®è·µèƒ½åŠ›æå‡ï¼š
â€¢ æ­å»ºç§æœ‰DNSæœåŠ¡å™¨
â€¢ å¼€å‘DNSå®‰å…¨ç›‘æ§å·¥å…·
â€¢ å‚ä¸å¼€æºDNSé¡¹ç›®
â€¢ å­¦ä¹ DNSåè®®åº•å±‚å®ç°

å®‰å…¨æ„è¯†åŸ¹å…»ï¼š
â€¢ å…³æ³¨DNSå®‰å…¨å¨èƒæƒ…æŠ¥
â€¢ å‚åŠ ç½‘ç»œå®‰å…¨ä¼šè®®
â€¢ é˜…è¯»RFCæ–‡æ¡£å’Œå®‰å…¨å…¬å‘Š
â€¢ å®è·µæ¸—é€æµ‹è¯•å’Œé˜²æŠ¤
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- DNSå®‰å…¨æ˜¯ç½‘ç»œå®‰å…¨çš„åŸºç¡€ï¼Œéœ€è¦å¤šå±‚é˜²æŠ¤
- åŠ å¯†ä¼ è¾“ï¼ˆDoH/DoTï¼‰æ˜¯ç°ä»£DNSçš„å¿…å¤‡åŠŸèƒ½
- å®šæœŸæ£€æµ‹å’Œç›‘æ§æ˜¯ç»´æŠ¤DNSå®‰å…¨çš„å…³é”®
- ä¸åŒåœºæ™¯éœ€è¦é‡‡ç”¨ä¸åŒçš„DNSå®‰å…¨ç­–ç•¥
- DNSæ³„éœ²é˜²æŠ¤åœ¨éšç§ä¿æŠ¤ä¸­è‡³å…³é‡è¦