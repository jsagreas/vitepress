---
title: 5、IPv6路由配置与管理
---
## 📚 目录

1. [IPv6路由基础概念](#1-IPv6路由基础概念)
2. [IPv6路由表结构与查看](#2-IPv6路由表结构与查看)
3. [静态路由配置方法](#3-静态路由配置方法)
4. [默认网关配置](#4-默认网关配置)
5. [路由器发现协议](#5-路由器发现协议)
6. [IPv6路由聚合技术](#6-IPv6路由聚合技术)
7. [多路径路由配置](#7-多路径路由配置)
8. [路由优先级与度量值](#8-路由优先级与度量值)
9. [路由故障检测与切换](#9-路由故障检测与切换)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🌐 IPv6路由基础概念


### 1.1 什么是IPv6路由


**📋 基本概念**
IPv6路由就是指导数据包在IPv6网络中如何从源地址到达目标地址的路径选择机制。简单来说，就像GPS导航一样，告诉数据包应该走哪条"道路"才能到达目的地。

**🔸 核心作用**
```
数据包传输指导：
源设备 → [路由决策] → 中转设备 → [路由决策] → 目标设备

路由器的工作：
1. 接收数据包
2. 查看目标IPv6地址
3. 查询路由表
4. 选择最佳路径
5. 转发数据包
```

### 1.2 IPv6路由与IPv4路由的区别


| **特性** | **IPv4路由** | **IPv6路由** | **说明** |
|---------|-------------|-------------|---------|
| **地址长度** | `32位` | `128位` | IPv6地址空间更大 |
| **子网划分** | `手动配置为主` | `自动配置为主` | IPv6支持无状态自动配置 |
| **路由聚合** | `CIDR技术` | `更灵活的聚合` | IPv6层次化地址结构 |
| **邻居发现** | `ARP协议` | `NDP协议` | IPv6使用更高效的邻居发现 |
| **路由配置** | `相对复杂` | `更加智能` | IPv6有更多自动化特性 |

### 1.3 IPv6路由的工作原理


**🔄 路由决策流程**
```
数据包到达 → 提取目标IPv6地址 → 查询路由表 → 匹配最长前缀 → 选择出接口 → 转发数据包

示例流程：
目标地址：2001:db8:cafe:1::100
┌─────────────────────────────────┐
│ 路由表匹配过程：                │
│ 1. 查找完全匹配                │
│ 2. 查找最长前缀匹配            │
│ 3. 查找默认路由 ::/0           │
│ 4. 选择最佳路径                │
└─────────────────────────────────┘
```

---

## 2. 📊 IPv6路由表结构与查看


### 2.1 IPv6路由表的组成


**🔸 路由表基本结构**
IPv6路由表记录了如何到达不同网络的信息，每条路由记录包含以下关键信息：

```
路由记录组成：
目标网络/前缀长度 → 下一跳地址 → 出接口 → 度量值 → 路由来源
```

**💡 路由表字段说明**
- **`Destination`**：目标网络地址和前缀长度
- **`Gateway`**：下一跳路由器的IPv6地址
- **`Interface`**：数据包的出接口
- **`Metric`**：路由的成本或优先级
- **`Source`**：路由的来源（静态、动态等）

### 2.2 查看IPv6路由表的方法


**🔧 基本查看命令**

**方法一：使用`ip -6 route`命令**
```bash
# 查看完整的IPv6路由表
ip -6 route show

# 查看特定网络的路由
ip -6 route show 2001:db8::/32

# 查看默认路由
ip -6 route show default
```

**方法二：使用`route -A inet6`命令**
```bash
# 查看IPv6路由表（传统方式）
route -A inet6

# 显示数字形式的地址
route -A inet6 -n
```

### 2.3 路由表输出解读


**📋 实际输出示例**
```bash
$ ip -6 route show
default via fe80::1 dev eth0 metric 1024
2001:db8::/64 dev eth0 proto kernel scope link src 2001:db8::100
fe80::/64 dev eth0 proto kernel scope link
::1 dev lo proto kernel scope host
```

**🔍 输出解读说明**
```
default via fe80::1 dev eth0 metric 1024
├─ default: 默认路由（::/0）
├─ via fe80::1: 下一跳是链路本地地址fe80::1
├─ dev eth0: 通过eth0接口发送
└─ metric 1024: 路由度量值为1024

2001:db8::/64 dev eth0 proto kernel scope link src 2001:db8::100
├─ 2001:db8::/64: 目标网络
├─ dev eth0: 直连接口
├─ proto kernel: 内核自动生成
├─ scope link: 链路范围
└─ src 2001:db8::100: 源地址
```

### 2.4 路由表的类型分类


**📚 按路由来源分类**
- **`内核路由`**：系统自动生成的路由
- **`静态路由`**：管理员手动配置的路由
- **`动态路由`**：路由协议学习到的路由
- **`直连路由`**：本地网络接口的路由

---

## 3. ⚙️ 静态路由配置方法


### 3.1 什么是静态路由


**📋 基本概念**
静态路由是网络管理员手动配置的固定路由，告诉系统如何到达特定的网络。就像在地图上画出一条固定的路线，不管路况如何变化，都按照这条路线走。

**🎯 静态路由的特点**
- **`手动配置`**：需要管理员明确指定
- **`固定不变`**：不会自动适应网络变化
- **`简单可靠`**：配置简单，不消耗系统资源
- **`适合小网络`**：网络拓扑稳定的环境

### 3.2 静态路由配置语法


**🔧 基本配置命令**
```bash
# 添加静态路由的基本语法
ip -6 route add <目标网络/前缀> via <下一跳地址> dev <接口>

# 完整参数格式
ip -6 route add <网络/前缀> via <网关> dev <接口> metric <度量值>
```

**💡 参数说明**
- **`<目标网络/前缀>`**：要到达的IPv6网络，如`2001:db8:1::/64`
- **`<下一跳地址>`**：下一个路由器的IPv6地址
- **`<接口>`**：本地发送数据的网络接口
- **`<度量值>`**：路由的优先级（数值越小优先级越高）

### 3.3 静态路由配置实例


**🔸 配置示例1：到达远程网络**
```bash
# 配置到达2001:db8:2::/64网络的路由
ip -6 route add 2001:db8:2::/64 via 2001:db8:1::1 dev eth0

# 验证配置结果
ip -6 route show 2001:db8:2::/64
```

**🔸 配置示例2：指定度量值**
```bash
# 添加带度量值的静态路由
ip -6 route add 2001:db8:3::/64 via 2001:db8:1::2 dev eth0 metric 100

# 查看路由详情
ip -6 route get 2001:db8:3::100
```

**🔸 配置示例3：多条路径**
```bash
# 添加主路径
ip -6 route add 2001:db8:4::/64 via 2001:db8:1::1 dev eth0 metric 10

# 添加备用路径
ip -6 route add 2001:db8:4::/64 via 2001:db8:1::2 dev eth1 metric 20
```

### 3.4 静态路由管理操作


**🔧 路由管理命令**

**删除静态路由**
```bash
# 删除特定路由
ip -6 route del 2001:db8:2::/64 via 2001:db8:1::1

# 删除所有到达某网络的路由
ip -6 route del 2001:db8:2::/64
```

**修改静态路由**
```bash
# 替换现有路由
ip -6 route replace 2001:db8:2::/64 via 2001:db8:1::3 dev eth0 metric 50
```

**🔸 永久保存路由配置**
```bash
# Ubuntu/Debian系统 - 编辑网络配置
sudo nano /etc/netplan/01-netcfg.yaml

# 添加路由配置
network:
  version: 2
  ethernets:
    eth0:
      addresses:
        - 2001:db8:1::100/64
      routes:
        - to: 2001:db8:2::/64
          via: 2001:db8:1::1
```

---

## 4. 🚪 默认网关配置


### 4.1 默认网关的作用


**📋 基本概念**
默认网关就像小区的大门，当数据包不知道怎么到达目标地址时，就把它们发送到默认网关，由网关来处理。在IPv6中，默认路由表示为`::/0`。

**🎯 默认网关的重要性**
- **`兜底机制`**：处理所有未匹配的目标地址
- **`上网必需`**：访问外部网络的唯一出口
- **`简化配置`**：避免配置大量具体路由

### 4.2 配置IPv6默认网关


**🔧 基本配置方法**

**方法一：使用`ip`命令**
```bash
# 添加默认网关
ip -6 route add default via fe80::1 dev eth0

# 指定度量值的默认网关
ip -6 route add default via 2001:db8:1::1 dev eth0 metric 100
```

**方法二：使用链路本地地址**
```bash
# 使用链路本地地址作为网关（推荐）
ip -6 route add default via fe80::1%eth0

# 查看默认路由
ip -6 route show default
```

### 4.3 多个默认网关配置


**🔸 配置多个默认网关**
```bash
# 主默认网关（优先级高）
ip -6 route add default via fe80::1 dev eth0 metric 10

# 备用默认网关（优先级低）
ip -6 route add default via fe80::2 dev eth1 metric 20

# 查看所有默认路由
ip -6 route show default
```

**📊 默认网关选择机制**
```
网关选择流程：
数据包需要路由 → 查找具体路由 → 未找到匹配 → 使用默认路由

多网关优先级：
metric 10: fe80::1 (主网关) ← 优先使用
metric 20: fe80::2 (备网关) ← 主网关不可用时使用
```

### 4.4 默认网关管理操作


**🔧 管理命令**
```bash
# 删除默认网关
ip -6 route del default via fe80::1 dev eth0

# 删除所有默认路由
ip -6 route del default

# 替换默认网关
ip -6 route replace default via fe80::3 dev eth0 metric 5
```

---

## 5. 🔍 路由器发现协议


### 5.1 邻居发现协议（NDP）概述


**📋 基本概念**
邻居发现协议（Neighbor Discovery Protocol, NDP）是IPv6的核心协议之一，负责自动发现路由器、解析地址、检测邻居等功能。就像邻居之间相互认识和交流信息一样。

**🔸 NDP的主要功能**
- **`路由器发现`**：自动找到本地网络的路由器
- **`前缀发现`**：获取网络前缀信息
- **`地址解析`**：将IPv6地址解析为MAC地址
- **`邻居不可达检测`**：检测邻居是否可达

### 5.2 路由器通告（RA）机制


**🔄 RA工作流程**
```
路由器通告流程：
路由器 → [定期发送RA] → 主机们
主机 → [发送RS请求] → 路由器
路由器 → [立即回复RA] → 请求的主机

RA消息内容：
┌─────────────────────────┐
│ • 默认网关信息          │
│ • 网络前缀信息          │
│ • MTU大小              │
│ • 跳数限制             │
│ • 地址配置标志         │
└─────────────────────────┘
```

**🔸 查看RA信息**
```bash
# 查看接收到的RA信息
ip -6 route show proto ra

# 监听RA消息
tcpdump -i eth0 icmp6 and ip6[40] == 134
```

### 5.3 路由器请求（RS）机制


**📡 RS的作用**
当主机启动或需要更新路由信息时，会发送路由器请求（Router Solicitation）消息，主动请求路由器发送RA消息。

**🔧 手动发送RS**
```bash
# 使用ping6发送RS（间接方式）
ping6 -I eth0 ff02::2

# 重新获取IPv6配置
dhclient -6 -r eth0  # 释放
dhclient -6 eth0     # 重新获取
```

### 5.4 禁用/启用路由器发现


**⚙️ 系统配置**
```bash
# 查看当前设置
sysctl net.ipv6.conf.eth0.accept_ra

# 禁用接受RA（手动配置模式）
echo 0 > /proc/sys/net/ipv6/conf/eth0/accept_ra

# 启用接受RA（自动配置模式）
echo 1 > /proc/sys/net/ipv6/conf/eth0/accept_ra

# 永久配置
echo "net.ipv6.conf.eth0.accept_ra = 1" >> /etc/sysctl.conf
```

---

## 6. 📈 IPv6路由聚合技术


### 6.1 路由聚合的概念


**📋 基本概念**
路由聚合就是把多个小的网络路由合并成一个大的路由条目，减少路由表的大小。就像把多个小包裹打包成一个大包裹一样，方便管理和传输。

**🎯 路由聚合的优势**
- **`减少路由条目`**：路由表更小，查找更快
- **`节省内存`**：减少系统资源消耗
- **`提高效率`**：路由计算更快速
- **`增强稳定性`**：减少路由震荡影响

### 6.2 IPv6地址层次化结构


**🏗️ IPv6地址分层**
```
IPv6地址结构（128位）：
┌─────────┬─────────┬─────────┬─────────┐
│ 全局前缀 │ 子网ID  │    接口标识符    │
│ (48位)  │ (16位)  │       (64位)     │
└─────────┴─────────┴─────────────────┘

聚合示例：
原始路由：
2001:db8:1::/64
2001:db8:2::/64  
2001:db8:3::/64
2001:db8:4::/64

聚合后：
2001:db8::/62 (包含上述4个/64网络)
```

### 6.3 路由聚合配置实例


**🔧 聚合配置示例**

**场景：聚合多个子网路由**
```bash
# 原来需要4条路由
ip -6 route add 2001:db8:1::/64 via 2001:db8::1 dev eth0
ip -6 route add 2001:db8:2::/64 via 2001:db8::1 dev eth0  
ip -6 route add 2001:db8:3::/64 via 2001:db8::1 dev eth0
ip -6 route add 2001:db8:4::/64 via 2001:db8::1 dev eth0

# 聚合为1条路由
ip -6 route add 2001:db8::/62 via 2001:db8::1 dev eth0
```

**🔸 聚合计算方法**
```
子网聚合计算：
1. 确定共同前缀：2001:db8:
2. 分析子网部分：
   - 2001:db8:1::/64 → 子网1
   - 2001:db8:2::/64 → 子网2
   - 2001:db8:3::/64 → 子网3
   - 2001:db8:4::/64 → 子网4
3. 计算最小包含前缀：/62
```

### 6.4 超网（Supernetting）技术


**🔍 超网的应用**
```bash
# 企业网络聚合示例
# 北京分公司：2001:db8:1000::/52
# 上海分公司：2001:db8:2000::/52
# 广州分公司：2001:db8:3000::/52

# 在核心路由器上聚合
ip -6 route add 2001:db8::/48 via 2001:db8::gateway dev eth0
```

---

## 7. 🛤️ 多路径路由配置


### 7.1 多路径路由概念


**📋 基本概念**
多路径路由就是到达同一个目标网络有多条可用路径，系统可以根据需要选择使用哪条路径。就像从家到公司有多条路线可以走一样。

**🎯 多路径的优势**
- **`负载均衡`**：分散网络流量
- **`故障冗余`**：一条路径断了还有备用
- **`带宽聚合`**：多条路径同时使用
- **`灵活选择`**：根据实际情况选路径

### 7.2 等价多路径（ECMP）配置


**🔧 ECMP配置方法**
```bash
# 配置两条等价路径
ip -6 route add 2001:db8:remote::/64 \
    nexthop via 2001:db8:1::1 dev eth0 weight 1 \
    nexthop via 2001:db8:2::1 dev eth1 weight 1

# 查看多路径路由
ip -6 route show 2001:db8:remote::/64
```

**📊 负载均衡效果**
```
流量分配机制：
数据包1 → 路径1 (via 2001:db8:1::1)
数据包2 → 路径2 (via 2001:db8:2::1)  
数据包3 → 路径1 (via 2001:db8:1::1)
数据包4 → 路径2 (via 2001:db8:2::1)
...（按权重轮询分配）
```

### 7.3 不等价多路径配置


**🔸 按权重分配流量**
```bash
# 配置不同权重的路径
ip -6 route add 2001:db8:remote::/64 \
    nexthop via 2001:db8:1::1 dev eth0 weight 3 \
    nexthop via 2001:db8:2::1 dev eth1 weight 1

# 结果：75%流量走路径1，25%流量走路径2
```

### 7.4 主备路径配置


**🔧 主备模式配置**
```bash
# 主路径（优先级高）
ip -6 route add 2001:db8:remote::/64 via 2001:db8:1::1 dev eth0 metric 10

# 备用路径（优先级低）  
ip -6 route add 2001:db8:remote::/64 via 2001:db8:2::1 dev eth1 metric 20

# 正常情况只使用主路径，主路径故障时自动切换到备用路径
```

---

## 8. ⚡ 路由优先级与度量值


### 8.1 路由优先级概念


**📋 基本概念**
路由优先级决定了当有多条路径到达同一目标时，系统选择哪条路径。就像GPS导航在有多条路线时，会选择最快或最短的路线一样。

**🔢 优先级规则**
- **`度量值越小优先级越高`**：metric 10 > metric 20
- **`管理距离`**：不同路由来源的可信度
- **`最长前缀匹配`**：更具体的路由优先

### 8.2 度量值（Metric）详解


**📏 度量值的含义**
度量值表示到达目标网络的"成本"，可以基于：
- **`跳数`**：经过的路由器数量
- **`带宽`**：链路带宽大小
- **`延迟`**：传输延迟时间
- **`可靠性`**：链路稳定性

**🔧 度量值配置**
```bash
# 设置不同度量值
ip -6 route add 2001:db8:1::/64 via fe80::1 dev eth0 metric 10   # 高优先级
ip -6 route add 2001:db8:1::/64 via fe80::2 dev eth1 metric 100  # 低优先级

# 查看路由选择结果
ip -6 route get 2001:db8:1::100
```

### 8.3 路由来源优先级


**📊 不同来源的优先级**
| **路由来源** | **管理距离** | **说明** | **可信度** |
|-------------|-------------|---------|----------|
| **直连路由** | `0` | 本地接口直连网络 | `最高` |
| **静态路由** | `1` | 管理员手动配置 | `很高` |
| **OSPF** | `110` | 开放最短路径优先 | `较高` |
| **RIP** | `120` | 路由信息协议 | `较低` |
| **默认路由** | `255` | 兜底路由 | `最低` |

### 8.4 路由选择算法


**🔍 路由选择流程**
```
路由选择步骤：
1. 最长前缀匹配
   ├─ 2001:db8:1::100/128 (最具体)
   ├─ 2001:db8:1::/64 (较具体)  
   └─ 2001:db8::/32 (不太具体)

2. 管理距离比较
   ├─ 直连路由 (距离0) ← 优先选择
   ├─ 静态路由 (距离1)
   └─ 动态路由 (距离>1)

3. 度量值比较
   ├─ metric 10 ← 优先选择
   ├─ metric 20
   └─ metric 100
```

---

## 9. 🔧 路由故障检测与切换


### 9.1 路由故障检测机制


**📋 故障检测方法**
系统需要及时发现路由路径是否可用，主要通过以下方式：
- **`邻居不可达检测`**：NDP协议检测直连邻居
- **`路由器通告超时`**：RA消息停止接收
- **`手动探测`**：ping6等工具主动检测
- **`路由协议检测`**：动态路由协议的内建机制

### 9.2 邻居不可达检测（NUD）


**🔍 NUD工作原理**
```
邻居状态转换：
REACHABLE → STALE → DELAY → PROBE → UNREACHABLE
    ↑         ↓       ↓       ↓         ↓
 [正常通信]  [超时]  [触发]  [探测]    [故障]

状态说明：
• REACHABLE: 邻居可达，正常通信
• STALE: 可能不可达，需要验证
• DELAY: 等待上层协议确认
• PROBE: 主动发送探测包
• UNREACHABLE: 确认不可达
```

**🔧 查看邻居状态**
```bash
# 查看IPv6邻居表
ip -6 neigh show

# 查看特定邻居状态
ip -6 neigh show fe80::1

# 手动清除不可达邻居
ip -6 neigh del fe80::1 dev eth0
```

### 9.3 路由故障切换配置


**🔄 自动切换机制**
```bash
# 配置主备路由
ip -6 route add 2001:db8:remote::/64 via 2001:db8:1::1 dev eth0 metric 10
ip -6 route add 2001:db8:remote::/64 via 2001:db8:2::1 dev eth1 metric 20

# 当主路由(metric 10)不可达时，自动切换到备用路由(metric 20)
```

**📊 切换过程监控**
```bash
# 监控路由变化
ip monitor route

# 测试路由可达性
ping6 -I eth0 2001:db8:remote::1

# 查看当前使用的路由
ip -6 route get 2001:db8:remote::1
```

### 9.4 手动故障切换


**🔧 故障处理步骤**

**检测故障**
```bash
# 1. 测试连通性
ping6 2001:db8:1::1

# 2. 查看接口状态  
ip link show eth0

# 3. 检查路由表
ip -6 route show
```

**手动切换**
```bash
# 1. 删除故障路由
ip -6 route del 2001:db8:remote::/64 via 2001:db8:1::1

# 2. 添加新路由
ip -6 route add 2001:db8:remote::/64 via 2001:db8:2::1 dev eth1

# 3. 验证切换结果
ip -6 route get 2001:db8:remote::1
```

### 9.5 路由监控与日志


**📝 监控脚本示例**
```bash
#!/bin/bash
# IPv6路由监控脚本

TARGET="2001:db8:remote::1"
PRIMARY_GW="2001:db8:1::1"  
BACKUP_GW="2001:db8:2::1"

while true; do
    if ping6 -c 3 -W 5 $TARGET > /dev/null 2>&1; then
        echo "$(date): Route to $TARGET is OK"
    else
        echo "$(date): Route failure detected, checking gateway..."
        if ! ping6 -c 3 -W 5 $PRIMARY_GW > /dev/null 2>&1; then
            echo "$(date): Primary gateway down, switching to backup"
            # 执行路由切换逻辑
        fi
    fi
    sleep 30
done
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 IPv6路由基础：数据包在IPv6网络中的路径选择机制
🔸 路由表结构：目标网络、下一跳、接口、度量值等关键信息
🔸 静态路由：手动配置的固定路由，适合小型稳定网络
🔸 默认网关：处理未匹配目标的兜底路由机制（::/0）
🔸 路由器发现：NDP协议实现的自动路由发现功能
🔸 路由聚合：合并多个小网络为大网络，减少路由条目
🔸 多路径路由：到达同一目标的多条路径，提供冗余和负载均衡
🔸 优先级机制：度量值和管理距离决定路由选择
🔸 故障检测：NUD和监控机制确保路由可用性
```

### 10.2 关键理解要点


**🔹 IPv6路由的特殊性**
```
与IPv4的主要区别：
• 地址长度：128位 vs 32位
• 自动配置：NDP协议提供更智能的配置
• 层次化结构：更好的路由聚合能力
• 邻居发现：NDP替代ARP，功能更强大
```

**🔹 路由选择的优先级规则**
```
选择顺序：
1. 最长前缀匹配（越具体越优先）
2. 管理距离（直连 > 静态 > 动态）
3. 度量值（数值越小越优先）
4. 负载均衡（等价路径间分配）
```

**🔹 实际应用场景**
```
静态路由适用：
• 小型网络（<50台设备）
• 网络拓扑固定
• 对路由控制要求精确

动态路由适用：
• 大型网络（>100台设备）  
• 网络拓扑经常变化
• 需要自动故障恢复
```

### 10.3 实际操作要点


**🔧 配置最佳实践**
- **规划先行**：合理设计IPv6地址分配方案
- **分层管理**：利用路由聚合减少管理复杂度
- **冗余设计**：配置多路径提供故障保护
- **监控检测**：建立路由状态监控机制
- **文档记录**：详细记录路由配置和变更

**⚠️ 常见注意事项**
- **链路本地地址**：网关地址优先使用`fe80::`地址
- **度量值设置**：合理设置度量值避免路由震荡
- **邻居发现**：确保NDP协议正常工作
- **配置持久化**：重要路由配置要永久保存

**核心记忆要点**：
- IPv6路由配置比IPv4更智能，但基本原理相同
- 静态路由简单可靠，适合小型稳定网络
- 默认网关是数据包的最后出路，必须正确配置
- 路由优先级遵循：最长匹配 → 管理距离 → 度量值
- 故障检测和切换机制保证网络的高可用性