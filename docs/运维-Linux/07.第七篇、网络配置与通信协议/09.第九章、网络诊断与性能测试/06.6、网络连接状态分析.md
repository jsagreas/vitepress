---
title: 6、网络连接状态分析
---
## 📚 目录

1. [网络连接状态分析概述](#1-网络连接状态分析概述)
2. [ss套接字统计工具](#2-ss套接字统计工具)
3. [netstat网络连接查看](#3-netstat网络连接查看)
4. [TCP连接状态详解](#4-tcp连接状态详解)
5. [监听端口与服务管理](#5-监听端口与服务管理)
6. [进程网络使用分析](#6-进程网络使用分析)
7. [网络性能统计与监控](#7-网络性能统计与监控)
8. [异常连接识别与排查](#8-异常连接识别与排查)
9. [实战应用与最佳实践](#9-实战应用与最佳实践)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🌐 网络连接状态分析概述


### 1.1 什么是网络连接状态分析


**简单理解**：就像医生给病人做体检一样，网络连接状态分析是给Linux系统的网络"做体检"。

> 💡 **核心概念**：通过各种工具查看系统当前有哪些网络连接，这些连接处于什么状态，是否正常工作。

**为什么需要网络连接状态分析**：
- 🔍 **故障排查**：网络不通时找出问题所在
- 📊 **性能监控**：了解网络使用情况和负载
- 🛡️ **安全检查**：发现可疑的网络连接
- ⚙️ **服务管理**：确认服务是否正常启动和监听

### 1.2 网络连接的基本概念


**套接字(Socket)**：
- 简单说就是网络通信的"插座"
- 每个网络连接都需要通过套接字来建立
- 就像电器需要插到插座上才能用电一样

**网络连接的组成要素**：
```
本地地址:端口  ←→  远程地址:端口
192.168.1.100:8080  ←→  192.168.1.200:3306

解释：
- 本地地址：你的电脑IP
- 端口：应用程序的"门牌号"  
- 远程地址：对方电脑IP
- 连接方向：数据传输的方向
```

### 1.3 常用的网络分析工具


| 工具名称 | 主要用途 | 特点 | 推荐程度 |
|---------|---------|------|---------|
| **ss** | 查看套接字信息 | 现代化、速度快 | ⭐⭐⭐⭐⭐ |
| **netstat** | 查看网络连接 | 传统工具、功能全 | ⭐⭐⭐⭐ |
| **lsof** | 查看进程打开文件 | 功能强大、信息详细 | ⭐⭐⭐⭐ |
| **nmap** | 网络扫描 | 端口扫描、服务发现 | ⭐⭐⭐ |

---

## 2. 🔧 ss套接字统计工具


### 2.1 ss工具简介


**ss是什么**：
- **全称**：Socket Statistics（套接字统计）
- **定位**：现代版的netstat，速度更快，功能更强
- **优势**：直接从内核获取信息，不需要遍历/proc目录

> 📖 **发展历程**：ss工具是为了替代老旧的netstat而开发的，在大量连接的服务器上性能表现更好。

### 2.2 ss基础用法


#### 📋 基本查看命令


**查看所有连接**：
```bash
# 显示所有套接字连接
ss -a

# 显示所有TCP连接
ss -t

# 显示所有UDP连接  
ss -u
```

**显示详细信息**：
```bash
# 显示进程信息（需要root权限）
ss -p

# 显示数字形式的地址和端口
ss -n

# 组合使用：显示所有TCP连接的详细信息
ss -tnp
```

#### 🎯 常用参数组合


```bash
# 查看监听状态的端口
ss -tln

# 查看已建立的连接
ss -tn state established  

# 查看特定端口的连接
ss -tn sport = :80

# 查看连接数统计
ss -s
```

**参数说明表**：

| 参数 | 含义 | 实际作用 |
|-----|------|---------|
| `-t` | TCP协议 | 只显示TCP连接 |
| `-u` | UDP协议 | 只显示UDP连接 |
| `-l` | 监听状态 | 只显示正在监听的端口 |
| `-n` | 数字显示 | 不解析域名和服务名 |
| `-p` | 进程信息 | 显示使用连接的进程 |
| `-a` | 所有连接 | 显示所有状态的连接 |

### 2.3 ss高级过滤


#### 🔍 按状态过滤


**TCP连接状态过滤**：
```bash
# 查看所有已建立的连接
ss -tn state established

# 查看所有监听状态的连接
ss -tn state listen

# 查看TIME_WAIT状态的连接
ss -tn state time-wait

# 组合多个状态
ss -tn state established,syn-sent
```

#### 🎯 按地址和端口过滤


**按端口过滤**：
```bash
# 查看80端口的连接
ss -tn sport = :80

# 查看多个端口
ss -tn sport = :80 or sport = :443

# 查看端口范围
ss -tn sport ge :1024
```

**按地址过滤**：
```bash
# 查看指定IP的连接
ss -tn src 192.168.1.100

# 查看目标地址
ss -tn dst 192.168.1.200

# 组合条件
ss -tn src 192.168.1.100 and sport = :80
```

### 2.4 ss输出信息解读


**典型输出格式**：
```
State    Recv-Q Send-Q Local Address:Port Peer Address:Port Process
LISTEN   0      128    0.0.0.0:22         0.0.0.0:*     users:(("sshd",pid=1234,fd=3))
ESTAB    0      0      192.168.1.100:22   192.168.1.200:45678 users:(("sshd",pid=5678,fd=4))
```

**字段含义解释**：

| 字段 | 含义 | 实际意义 |
|-----|------|---------|
| **State** | 连接状态 | 当前连接处于什么阶段 |
| **Recv-Q** | 接收队列 | 等待应用程序读取的数据量 |
| **Send-Q** | 发送队列 | 等待发送的数据量 |
| **Local Address:Port** | 本地地址端口 | 本机的IP和端口 |
| **Peer Address:Port** | 对端地址端口 | 对方的IP和端口 |
| **Process** | 进程信息 | 使用该连接的进程名和PID |

---

## 3. 📊 netstat网络连接查看


### 3.1 netstat工具简介


**netstat是什么**：
- **全称**：Network Statistics（网络统计）
- **定位**：传统的网络连接查看工具
- **特点**：功能全面，使用广泛，但在高负载时性能不如ss

> ⚠️ **使用建议**：虽然netstat是传统工具，但很多老系统和脚本仍在使用，了解它仍然很重要。

### 3.2 netstat基础用法


#### 📋 基本查看命令


**查看网络连接**：
```bash
# 查看所有网络连接
netstat -a

# 查看TCP连接
netstat -t

# 查看UDP连接
netstat -u

# 查看监听端口
netstat -l
```

**显示详细信息**：
```bash
# 显示进程信息
netstat -p

# 不解析主机名和端口名
netstat -n

# 组合使用：查看所有TCP监听端口
netstat -tln
```

#### 🎯 常用参数组合


```bash
# 最常用：查看所有TCP连接和监听端口
netstat -tlnp

# 查看网络统计信息
netstat -s

# 查看路由表
netstat -r

# 查看网络接口统计
netstat -i
```

### 3.3 netstat与ss的对比


**命令对比表**：

| 功能 | netstat命令 | ss命令 | 说明 |
|-----|-----------|--------|------|
| 所有TCP连接 | `netstat -t` | `ss -t` | ss更快 |
| 监听端口 | `netstat -tln` | `ss -tln` | 功能相同 |
| 显示进程 | `netstat -p` | `ss -p` | 都需要root权限 |
| 连接统计 | `netstat -s` | `ss -s` | ss信息更详细 |

> 🔧 **实际应用建议**：
> - 新系统优先使用`ss`命令
> - 老系统或兼容性要求高的脚本使用`netstat`
> - 两个工具可以互相验证结果

---

## 4. 🔄 TCP连接状态详解


### 4.1 TCP连接状态概述


**TCP连接的生命周期**：
```
客户端                    服务端
   |                        |
   |------ SYN ------------>|  (SYN_SENT)
   |                        |  (SYN_RCVD)
   |<-- SYN+ACK ------------|
   |                        |
   |------ ACK ------------>|  (ESTABLISHED)
   |                        |  (ESTABLISHED)
   |                        |
   |    正常数据传输         |
   |                        |
   |------ FIN ------------>|  (FIN_WAIT_1)
   |                        |  (CLOSE_WAIT)
   |<------ ACK ------------|  (FIN_WAIT_2)
   |                        |
   |<------ FIN ------------|  (LAST_ACK)
   |                        |
   |------ ACK ------------>|  (TIME_WAIT)
   |                        |  (CLOSED)
```

### 4.2 主要TCP状态详解


#### 🟢 LISTEN - 监听状态

```
含义：服务端在等待客户端连接
特点：端口处于开放状态，准备接受连接
示例：Web服务器在80端口监听HTTP请求
```

#### 🔵 ESTABLISHED - 已建立连接

```
含义：连接已经建立，可以正常传输数据
特点：这是正常工作状态
示例：你正在浏览网页时的连接状态
```

#### 🟡 TIME_WAIT - 时间等待

```
含义：连接已关闭，但在等待可能的重传数据包
特点：会持续一段时间（通常2分钟）
问题：大量TIME_WAIT可能影响性能
```

#### 🟠 CLOSE_WAIT - 等待关闭

```
含义：对方已关闭连接，等待本端应用程序关闭
特点：如果应用程序未正确处理，连接会一直保持
问题：大量CLOSE_WAIT通常说明应用程序有bug
```

### 4.3 TCP状态统计分析


**查看状态统计**：
```bash
# 使用ss查看状态统计
ss -s

# 按状态分组统计
ss -tan | awk '{print $1}' | sort | uniq -c

# 查看TIME_WAIT连接数
ss -tan state time-wait | wc -l
```

**正常状态分布参考**：
- **LISTEN**: 通常10-50个（取决于运行的服务）
- **ESTABLISHED**: 根据业务量变化
- **TIME_WAIT**: 短时间内不应过多（<1000）
- **CLOSE_WAIT**: 应该很少或没有

---

## 5. 👂 监听端口与服务管理


### 5.1 监听端口概念


**什么是监听端口**：
- 就像商店的"营业中"标志
- 表示某个服务正在等待客户端连接
- 每个监听端口对应一个特定服务

### 5.2 查看监听端口


#### 📋 基本查看方法


**查看所有监听端口**：
```bash
# 使用ss查看
ss -tln

# 使用netstat查看
netstat -tln

# 查看UDP监听端口
ss -uln
```

**查看特定端口**：
```bash
# 检查80端口是否在监听
ss -tln | grep :80

# 查看指定端口的详细信息
ss -tlnp | grep :80
```

#### 🔍 端口与服务对应


**常见服务端口对照**：

| 端口 | 服务名称 | 协议 | 说明 |
|-----|---------|------|------|
| **22** | SSH | TCP | 远程登录服务 |
| **80** | HTTP | TCP | Web服务 |
| **443** | HTTPS | TCP | 安全Web服务 |
| **3306** | MySQL | TCP | 数据库服务 |
| **6379** | Redis | TCP | 缓存服务 |
| **53** | DNS | UDP | 域名解析 |

### 5.3 端口状态检查


**检查端口是否开启**：
```bash
# 方法1：使用ss检查
ss -tln | grep ":80 "

# 方法2：使用telnet测试
telnet localhost 80

# 方法3：使用nmap扫描
nmap -p 80 localhost
```

**端口开启状态判断**：
- ✅ **监听中**: 端口正常开启，服务运行正常
- ❌ **未监听**: 端口未开启，服务可能未启动
- ⚠️ **拒绝连接**: 端口开启但服务有问题

---

## 6. 🔗 进程网络使用分析


### 6.1 进程与网络连接关系


**基本概念**：
- 每个网络连接都属于某个进程
- 通过进程ID(PID)可以找到是哪个程序在使用网络
- 这对于排查网络问题很重要

### 6.2 查看进程网络使用情况


#### 📊 按进程查看网络连接


**查看指定进程的网络连接**：
```bash
# 根据进程名查看
ss -tlnp | grep nginx

# 根据PID查看
ss -tlnp | grep "pid=1234"

# 使用lsof查看进程打开的网络文件
lsof -p 1234 | grep IPv4
```

**查看进程监听的端口**：
```bash
# 查看nginx监听的端口
ss -tlnp | grep nginx

# 查看MySQL监听的端口  
ss -tlnp | grep mysqld
```

#### 🔍 网络连接进程排查


**找到占用端口的进程**：
```bash
# 方法1：使用ss
ss -tlnp | grep ":80"

# 方法2：使用lsof  
lsof -i :80

# 方法3：使用fuser
fuser -n tcp 80
```

**实际排查案例**：
```bash
# 场景：发现80端口被占用，但不知道是什么程序
$ ss -tlnp | grep ":80 "
LISTEN  0  128  *:80  *:*  users:(("nginx",pid=1234,fd=7))

# 结果：发现是nginx进程占用了80端口
```

### 6.3 进程网络资源监控


#### 📈 网络使用统计


**查看进程网络统计**：
```bash
# 查看系统整体网络统计
ss -s

# 查看特定进程的连接数
ss -tnp | grep "pid=1234" | wc -l

# 按进程统计连接数
ss -tnp | grep -o 'pid=[0-9]*' | sort | uniq -c
```

**网络资源占用分析**：
- 💡 **连接数过多**：可能是程序没有正确关闭连接
- 💡 **监听端口冲突**：多个程序试图使用同一端口
- 💡 **异常连接**：大量来自同一IP的连接可能是攻击

---

## 7. 📊 网络性能统计与监控


### 7.1 网络统计信息概述


**网络统计的作用**：
- 📈 **性能监控**：了解网络使用情况
- 🔍 **问题诊断**：发现网络瓶颈和异常
- 📊 **容量规划**：为系统扩容提供数据支持

### 7.2 基本网络统计


#### 📋 连接数统计


**查看连接总数**：
```bash
# 使用ss查看统计信息
ss -s

# 输出示例：
Total: 1234 (kernel 0)
TCP:   567 (estab 234, closed 123, orphaned 0, synrecv 0, timewait 89)
Transport Total     IP        IPv6
*         1234      -         -
RAW       0         0         0  
UDP       12        8         4
TCP       567       456       111
```

**按状态统计TCP连接**：
```bash
# 统计各种状态的连接数
ss -tan | awk 'NR>1 {print $1}' | sort | uniq -c | sort -nr

# 输出示例：
234 ESTABLISHED
123 TIME-WAIT
45 LISTEN
12 CLOSE-WAIT
```

#### 📊 端口使用统计


**统计监听端口数量**：
```bash
# 统计TCP监听端口
ss -tln | grep LISTEN | wc -l

# 按端口统计连接数
ss -tan | awk 'NR>1 {print $4}' | cut -d':' -f2 | sort | uniq -c | sort -nr
```

### 7.3 网络接口统计


#### 🌐 接口流量统计


**查看网络接口统计**：
```bash
# 使用netstat查看接口统计
netstat -i

# 查看详细的接口统计
cat /proc/net/dev

# 使用ip命令查看接口统计
ip -s link show
```

**接口统计信息解读**：

| 指标 | 含义 | 正常范围 |
|-----|------|---------|
| **RX packets** | 接收数据包数 | 持续增长 |
| **RX errors** | 接收错误数 | 应该很少 |
| **TX packets** | 发送数据包数 | 持续增长 |
| **TX errors** | 发送错误数 | 应该很少 |
| **RX dropped** | 接收丢弃数 | 应该很少 |

---

## 8. 🚨 异常连接识别与排查


### 8.1 异常连接的类型


**常见异常连接模式**：

#### 🔴 大量TIME_WAIT连接

```bash
# 检查TIME_WAIT连接数
ss -tan state time-wait | wc -l

# 如果数量过多（>5000），可能的原因：
# - 短连接过多
# - 连接池配置不当
# - 客户端没有复用连接
```

#### 🟡 大量CLOSE_WAIT连接

```bash
# 检查CLOSE_WAIT连接
ss -tan state close-wait

# 大量CLOSE_WAIT通常表示：
# - 应用程序没有正确关闭连接
# - 程序可能有内存泄漏
# - 需要检查应用程序代码
```

#### 🔵 异常源IP连接

```bash
# 统计连接最多的IP地址
ss -tn | awk 'NR>1 {print $5}' | cut -d':' -f1 | sort | uniq -c | sort -nr | head -10

# 检查是否有可疑的大量连接
```

### 8.2 异常连接排查方法


#### 🔍 系统性排查步骤


**第一步：总体情况检查**
```bash
# 1. 查看连接总数和状态分布
ss -s

# 2. 查看连接状态统计
ss -tan | awk 'NR>1 {print $1}' | sort | uniq -c
```

**第二步：具体问题分析**
```bash
# 3. 检查异常状态的连接
ss -tan state close-wait
ss -tan state time-wait | head -20

# 4. 查看连接对应的进程
ss -tanp state close-wait
```

**第三步：根本原因查找**
```bash
# 5. 检查应用程序日志
tail -f /var/log/application.log

# 6. 检查系统资源使用情况
free -h
top -p `pgrep -d',' application_name`
```

#### 🛠️ 常见问题解决方法


**TIME_WAIT过多的解决**：
```bash
# 临时解决：调整内核参数
echo 1 > /proc/sys/net/ipv4/tcp_tw_reuse
echo 1 > /proc/sys/net/ipv4/tcp_tw_recycle

# 永久解决：修改/etc/sysctl.conf
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 1
```

**CLOSE_WAIT过多的解决**：
- 🔧 检查应用程序代码，确保正确关闭连接
- 🔧 重启相关服务（临时解决）
- 🔧 修复程序bug（根本解决）

---

## 9. 🎯 实战应用与最佳实践


### 9.1 日常网络监控脚本


#### 📝 网络状态监控脚本


```bash
#!/bin/bash
# 网络连接状态监控脚本

echo "=== 网络连接状态报告 ==="
echo "时间: $(date)"
echo

# 1. 连接总数统计
echo "1. 连接总数统计:"
ss -s | grep -E "TCP:|Total:"
echo

# 2. TCP状态分布
echo "2. TCP连接状态分布:"
ss -tan | awk 'NR>1 {print $1}' | sort | uniq -c | sort -nr
echo

# 3. 监听端口检查
echo "3. 监听端口:"
ss -tln | grep LISTEN | awk '{print $4}' | sort -V
echo

# 4. 异常连接检查
close_wait_count=$(ss -tan state close-wait | wc -l)
time_wait_count=$(ss -tan state time-wait | wc -l)

if [ $close_wait_count -gt 100 ]; then
    echo "⚠️  警告: CLOSE_WAIT连接数过多 ($close_wait_count)"
fi

if [ $time_wait_count -gt 1000 ]; then
    echo "⚠️  警告: TIME_WAIT连接数过多 ($time_wait_count)"  
fi
```

### 9.2 故障排查工作流


#### 🔧 标准排查流程


```
网络问题报告
    ↓
1. 基础连通性测试
   ping, telnet, curl
    ↓
2. 连接状态检查  
   ss -s, ss -tan
    ↓
3. 端口监听确认
   ss -tln, lsof -i
    ↓
4. 进程状态检查
   ps, top, systemctl
    ↓
5. 日志分析
   /var/log/, journalctl
    ↓
6. 系统资源检查
   free, df, iostat
    ↓
解决方案实施
```

### 9.3 性能优化建议


#### ⚡ 网络性能调优


**连接数优化**：
- 💡 **使用连接池**：避免频繁建立和关闭连接
- 💡 **调整内核参数**：提高并发连接处理能力
- 💡 **应用程序优化**：正确处理连接生命周期

**监控建议**：
- 📊 **定期检查**：每小时检查一次连接状态
- 📊 **设置告警**：异常连接数超过阈值时告警
- 📊 **历史记录**：保存网络统计数据用于趋势分析

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 网络连接状态：了解TCP连接的生命周期和各种状态含义
🔸 套接字概念：理解网络通信的基本单位
🔸 监听端口：知道服务如何对外提供网络服务
🔸 进程关联：理解进程与网络连接的对应关系
🔸 异常识别：能够识别和排查常见的网络连接问题
```

### 10.2 关键工具使用要点


**🔹 ss vs netstat选择**
```
推荐使用顺序：
1. ss - 现代化工具，性能更好
2. netstat - 兼容性好，功能全面
3. lsof - 详细信息查看
```

**🔹 常用命令记忆**
```bash
# 日常检查三剑客
ss -tlnp        # 查看监听端口和进程
ss -tanp        # 查看所有连接和进程  
ss -s           # 查看连接统计
```

**🔹 排查思路**
```
问题排查步骤：
总览 → 细节 → 根因 → 解决
(统计) (具体连接) (日志分析) (修复)
```

### 10.3 实际应用价值


- **🎯 服务器运维**：快速定位网络服务问题
- **🎯 性能调优**：识别网络瓶颈和优化点
- **🎯 安全防护**：发现异常连接和潜在攻击  
- **🎯 容量规划**：基于连接数据进行资源规划
- **🎯 故障诊断**：系统化的问题排查方法

### 10.4 学习进阶路径


**基础掌握** → **工具熟练** → **问题排查** → **性能优化** → **自动化监控**

> 💡 **学习建议**：
> - 先掌握基础概念和常用命令
> - 通过实际问题练习排查技能  
> - 编写监控脚本提高效率
> - 结合其他工具形成完整的运维体系

**核心记忆**：
- ss看连接，netstat做备选
- 状态要分清，异常及时查
- 进程端口要对应，排查问题有章法
- 监控自动化，运维更轻松