---
title: 7ã€DNSç¼“å­˜ä¼˜åŒ–é…ç½®
---
## ğŸ“š ç›®å½•

1. [DNSç¼“å­˜åŸºç¡€æ¦‚å¿µ](#1-DNSç¼“å­˜åŸºç¡€æ¦‚å¿µ)
2. [dnsmasqè½»é‡çº§DNSç¼“å­˜](#2-dnsmasqè½»é‡çº§DNSç¼“å­˜)
3. [systemd-resolvedç¼“å­˜é…ç½®](#3-systemd-resolvedç¼“å­˜é…ç½®)
4. [nscdåç§°æœåŠ¡ç¼“å­˜å®ˆæŠ¤è¿›ç¨‹](#4-nscdåç§°æœåŠ¡ç¼“å­˜å®ˆæŠ¤è¿›ç¨‹)
5. [DNSç¼“å­˜ç›‘æ§ä¸æ€§èƒ½è°ƒä¼˜](#5-DNSç¼“å­˜ç›‘æ§ä¸æ€§èƒ½è°ƒä¼˜)
6. [æœ¬åœ°DNSç¼“å­˜æœåŠ¡éƒ¨ç½²](#6-æœ¬åœ°DNSç¼“å­˜æœåŠ¡éƒ¨ç½²)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” DNSç¼“å­˜åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯DNSç¼“å­˜


**DNSç¼“å­˜ç®€å•ç†è§£**ï¼šå°±åƒä½ çš„é€šè®¯å½•ä¸€æ ·ï¼Œè®°ä½äº†å¸¸è”ç³»äººçš„ç”µè¯å·ç ï¼Œä¸‹æ¬¡å°±ä¸ç”¨å†ç¿»é»„é¡µæŸ¥æ‰¾äº†ã€‚

```
æ²¡æœ‰ç¼“å­˜çš„æƒ…å†µï¼š
ç”¨æˆ· â†’ æ¯æ¬¡éƒ½è¦é—®è¿œç¨‹DNSæœåŠ¡å™¨ â†’ ç­‰å¾…å›ç­” â†’ è·å¾—IPåœ°å€

æœ‰ç¼“å­˜çš„æƒ…å†µï¼š  
ç”¨æˆ· â†’ å…ˆæŸ¥æœ¬åœ°ç¼“å­˜ â†’ æœ‰å°±ç›´æ¥è¿”å› â†’ æ²¡æœ‰å†é—®è¿œç¨‹æœåŠ¡å™¨
```

**ğŸ¯ ç¼“å­˜çš„æ ¸å¿ƒä»·å€¼**ï¼š
- **æå‡å“åº”é€Ÿåº¦**ï¼šæœ¬åœ°æŸ¥è¯¢æ¯”ç½‘ç»œæŸ¥è¯¢å¿«å‡ åå€
- **å‡å°‘ç½‘ç»œæµé‡**ï¼šé¿å…é‡å¤çš„DNSæŸ¥è¯¢è¯·æ±‚
- **é™ä½æœåŠ¡å™¨è´Ÿè½½**ï¼šå‡è½»ä¸Šæ¸¸DNSæœåŠ¡å™¨å‹åŠ›
- **æé«˜å¯ç”¨æ€§**ï¼šç½‘ç»œæ•…éšœæ—¶ä»èƒ½è§£æç¼“å­˜çš„åŸŸå

### 1.2 DNSç¼“å­˜å·¥ä½œåŸç†


**ç¼“å­˜ç”Ÿå‘½å‘¨æœŸç¤ºæ„å›¾**ï¼š
```
åŸŸåæŸ¥è¯¢è¯·æ±‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å‘½ä¸­     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£€æŸ¥ç¼“å­˜   â”‚ --------â†’   â”‚   è¿”å›ç»“æœ   â”‚
â”‚   æ˜¯å¦å­˜åœ¨   â”‚              â”‚   (å¿«é€Ÿå“åº”)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ æœªå‘½ä¸­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŸ¥è¯¢ä¸Šæ¸¸   â”‚ --------â†’   â”‚   ç¼“å­˜ç»“æœ   â”‚
â”‚  DNSæœåŠ¡å™¨  â”‚              â”‚   å¹¶è¿”å›     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**TTLæ—¶é—´æ§åˆ¶æœºåˆ¶**ï¼š
- **TTLå«ä¹‰**ï¼šTime To Liveï¼Œç¼“å­˜å­˜æ´»æ—¶é—´
- **å·¥ä½œæ–¹å¼**ï¼šæ¯ä¸ªDNSè®°å½•éƒ½æœ‰TTLå€¼ï¼Œè¿‡æœŸåè‡ªåŠ¨æ¸…é™¤
- **å¹³è¡¡ç­–ç•¥**ï¼šTTLè¿‡çŸ­ç¼“å­˜æ•ˆæœå·®ï¼Œè¿‡é•¿å¯èƒ½è·å–è¿‡æ—¶ä¿¡æ¯

### 1.3 Linuxç³»ç»Ÿä¸­çš„DNSç¼“å­˜å±‚æ¬¡


**å¤šå±‚ç¼“å­˜æ¶æ„**ï¼š
```
åº”ç”¨ç¨‹åº
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨ç¨‹åºç¼“å­˜    â”‚ â† æµè§ˆå™¨ã€åº”ç”¨è‡ªå¸¦ç¼“å­˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç³»ç»Ÿç¼“å­˜æœåŠ¡    â”‚ â† nscdã€systemd-resolved
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚  æœ¬åœ°DNSç¼“å­˜     â”‚ â† dnsmasqã€unbound
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸Šæ¸¸DNSæœåŠ¡å™¨   â”‚ â† 8.8.8.8ã€114.114.114.114
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸš€ dnsmasqè½»é‡çº§DNSç¼“å­˜


### 2.1 dnsmasqç®€ä»‹


**ä»€ä¹ˆæ˜¯dnsmasq**ï¼š
dnsmasqæ˜¯ä¸€ä¸ªè½»é‡çº§çš„DNSè½¬å‘å™¨å’ŒDHCPæœåŠ¡å™¨ï¼Œç‰¹åˆ«é€‚åˆå°å‹ç½‘ç»œç¯å¢ƒã€‚å°±åƒä¸€ä¸ªæ™ºèƒ½çš„"åŸŸåç”µè¯ç°¿ç®¡ç†å‘˜"ï¼Œæ—¢èƒ½è®°ä½å¸¸ç”¨å·ç ï¼Œåˆèƒ½å¸®ä½ æŸ¥æ‰¾æ–°å·ç ã€‚

**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- **è½»é‡é«˜æ•ˆ**ï¼šå†…å­˜å ç”¨æå°ï¼Œå¯åŠ¨å¿«é€Ÿ
- **æ˜“äºé…ç½®**ï¼šé…ç½®æ–‡ä»¶ç®€å•ç›´è§‚
- **åŠŸèƒ½ä¸°å¯Œ**ï¼šDNSç¼“å­˜ + DHCP + å¹¿å‘Šå±è”½
- **é€‚ç”¨åœºæ™¯**ï¼šå®¶åº­ç½‘ç»œã€å°å‹åŠå…¬å®¤ã€è·¯ç”±å™¨

### 2.2 dnsmasqå®‰è£…ä¸åŸºç¡€é…ç½®


**å®‰è£…dnsmasq**ï¼š
```bash
# Ubuntu/Debianç³»ç»Ÿ
sudo apt update && sudo apt install dnsmasq

# CentOS/RHELç³»ç»Ÿ  
sudo yum install dnsmasq
# æˆ–æ–°ç‰ˆæœ¬ä½¿ç”¨
sudo dnf install dnsmasq
```

**åŸºç¡€é…ç½®æ–‡ä»¶**ï¼š
```bash
# ç¼–è¾‘ä¸»é…ç½®æ–‡ä»¶
sudo vim /etc/dnsmasq.conf
```

**æ ¸å¿ƒé…ç½®é¡¹è¯¦è§£**ï¼š
```bash
# DNSç¼“å­˜ç›¸å…³é…ç½®
cache-size=1000          # ç¼“å­˜è®°å½•æ•°é‡ï¼Œé»˜è®¤150
neg-ttl=60              # å¦å®šå“åº”ç¼“å­˜æ—¶é—´(ç§’)
local-ttl=300           # æœ¬åœ°åŸŸåTTLæ—¶é—´

# ä¸Šæ¸¸DNSæœåŠ¡å™¨é…ç½®
server=8.8.8.8          # ä¸»DNSæœåŠ¡å™¨
server=114.114.114.114  # å¤‡ç”¨DNSæœåŠ¡å™¨
server=223.5.5.5        # é˜¿é‡ŒDNS

# ç›‘å¬é…ç½®
listen-address=127.0.0.1,192.168.1.1  # ç›‘å¬åœ°å€
port=53                 # DNSç«¯å£

# åŸŸåè§£æé…ç½®
domain-needed           # ä¸è½¬å‘æ— åŸŸåçš„æŸ¥è¯¢
bogus-priv             # ä¸è½¬å‘ç§æœ‰IPçš„åå‘æŸ¥è¯¢
expand-hosts           # ä¸ºhostsæ–‡ä»¶ä¸­çš„åç§°æ·»åŠ åŸŸå
```

### 2.3 dnsmasqé«˜çº§ç¼“å­˜é…ç½®


**ç¼“å­˜ä¼˜åŒ–é…ç½®ç¤ºä¾‹**ï¼š
```bash
# /etc/dnsmasq.conf é«˜çº§é…ç½®

# ç¼“å­˜å¤§å°è°ƒä¼˜
cache-size=10000        # å¢å¤§ç¼“å­˜åˆ°10000æ¡è®°å½•
min-cache-ttl=300       # æœ€å°ç¼“å­˜æ—¶é—´5åˆ†é’Ÿ
max-cache-ttl=86400     # æœ€å¤§ç¼“å­˜æ—¶é—´24å°æ—¶

# æœ¬åœ°åŸŸåé…ç½®
local=/home.lan/        # æœ¬åœ°åŸŸååç¼€
expand-hosts            # è‡ªåŠ¨æ‰©å±•hostsæ–‡ä»¶
domain=home.lan         # é»˜è®¤åŸŸå

# æ¡ä»¶è½¬å‘é…ç½®
server=/google.com/8.8.8.8       # ç‰¹å®šåŸŸåä½¿ç”¨ç‰¹å®šDNS
server=/baidu.com/114.114.114.114 # å›½å†…åŸŸåä½¿ç”¨å›½å†…DNS

# å¹¿å‘Šå±è”½(å¯é€‰)
conf-dir=/etc/dnsmasq.d/          # é¢å¤–é…ç½®ç›®å½•
addn-hosts=/etc/dnsmasq.hosts     # é¢å¤–hostsæ–‡ä»¶
```

**è‡ªå®šä¹‰hostsæ–‡ä»¶**ï¼š
```bash
# /etc/dnsmasq.hosts
# æœ¬åœ°æœåŠ¡å™¨åœ°å€
192.168.1.100 fileserver.home.lan
192.168.1.101 webserver.home.lan
192.168.1.102 database.home.lan

# å¹¿å‘ŠåŸŸåå±è”½
0.0.0.0 ads.google.com
0.0.0.0 doubleclick.net
```

### 2.4 dnsmasqæœåŠ¡ç®¡ç†


**æœåŠ¡æ§åˆ¶å‘½ä»¤**ï¼š
```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start dnsmasq
sudo systemctl enable dnsmasq

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status dnsmasq

# é‡æ–°åŠ è½½é…ç½®
sudo systemctl reload dnsmasq

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u dnsmasq -f
```

**é…ç½®éªŒè¯**ï¼š
```bash
# æ£€æŸ¥é…ç½®è¯­æ³•
sudo dnsmasq --test

# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
sudo kill -USR1 $(pidof dnsmasq)
sudo journalctl -u dnsmasq --since "1 minute ago"
```

---

## 3. âš™ï¸ systemd-resolvedç¼“å­˜é…ç½®


### 3.1 systemd-resolvedæ¦‚è¿°


**ä»€ä¹ˆæ˜¯systemd-resolved**ï¼š
è¿™æ˜¯ç°ä»£Linuxç³»ç»Ÿ(å¦‚Ubuntu 18.04+)è‡ªå¸¦çš„DNSè§£ææœåŠ¡ï¼Œå°±åƒç³»ç»Ÿå†…ç½®çš„"æ™ºèƒ½åŸŸååŠ©æ‰‹"ï¼Œä¸ä»…èƒ½ç¼“å­˜DNSè®°å½•ï¼Œè¿˜èƒ½ä¸ç½‘ç»œç®¡ç†å™¨ååŒå·¥ä½œã€‚

**ğŸ”¸ ä¸»è¦ä¼˜åŠ¿**ï¼š
- **ç³»ç»Ÿé›†æˆ**ï¼šä¸NetworkManageræ·±åº¦é›†æˆ
- **å¤šåè®®æ”¯æŒ**ï¼šæ”¯æŒDNS-over-TLSç­‰æ–°åè®®
- **æ™ºèƒ½è·¯ç”±**ï¼šå¯æ ¹æ®ç½‘ç»œæ¥å£é€‰æ‹©DNSæœåŠ¡å™¨
- **é›¶é…ç½®**ï¼šé»˜è®¤å°±èƒ½å·¥ä½œï¼Œé€‚åˆæ¡Œé¢ç”¨æˆ·

### 3.2 systemd-resolvedåŸºç¡€é…ç½®


**æ£€æŸ¥æœåŠ¡çŠ¶æ€**ï¼š
```bash
# æŸ¥çœ‹resolvedçŠ¶æ€
sudo systemctl status systemd-resolved

# æŸ¥çœ‹DNSè§£æç»Ÿè®¡
resolvectl statistics

# æŸ¥çœ‹å½“å‰DNSé…ç½®
resolvectl status
```

**ä¸»é…ç½®æ–‡ä»¶**ï¼š
```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo vim /etc/systemd/resolved.conf
```

**æ ¸å¿ƒé…ç½®é€‰é¡¹**ï¼š
```ini
[Resolve]
# DNSæœåŠ¡å™¨é…ç½®
DNS=8.8.8.8 114.114.114.114
FallbackDNS=223.5.5.5 8.8.4.4

# ç¼“å­˜é…ç½®
Cache=yes                    # å¯ç”¨DNSç¼“å­˜
CacheFromLocalhost=no        # ä¸ç¼“å­˜localhostæŸ¥è¯¢

# åŸŸåæœç´¢
Domains=home.lan office.local # æœç´¢åŸŸ
LLMNR=yes                    # å¯ç”¨é“¾è·¯æœ¬åœ°å¤šæ’­è§£æ
MulticastDNS=yes             # å¯ç”¨å¤šæ’­DNS

# DNSSECéªŒè¯
DNSSEC=allow-downgrade       # å…è®¸DNSSECé™çº§
DNSOverTLS=opportunistic     # æœºä¼šæ€§DNS-over-TLS
```

### 3.3 systemd-resolvedç¼“å­˜ç®¡ç†


**ç¼“å­˜æ“ä½œå‘½ä»¤**ï¼š
```bash
# æ¸…é™¤æ‰€æœ‰DNSç¼“å­˜
sudo resolvectl flush-caches

# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
resolvectl statistics

# æŸ¥è¯¢ç‰¹å®šåŸŸå(æµ‹è¯•ç¼“å­˜)
resolvectl query google.com

# æŸ¥çœ‹åŸŸåè§£æè·¯å¾„
resolvectl query google.com --verbose
```

**ç»Ÿè®¡ä¿¡æ¯è§£è¯»**ï¼š
```bash
# ç¤ºä¾‹è¾“å‡ºè§£è¯»
Current Transactions: 0           # å½“å‰æŸ¥è¯¢äº‹åŠ¡æ•°
Total Transactions: 1547          # æ€»æŸ¥è¯¢æ¬¡æ•°
Cache: 247 hits, 89 misses       # ç¼“å­˜å‘½ä¸­247æ¬¡ï¼Œæœªå‘½ä¸­89æ¬¡
DNSSEC: 45 secure, 0 insecure    # DNSSECéªŒè¯ç»“æœ
```

### 3.4 ç½‘ç»œæ¥å£ç‰¹å®šé…ç½®


**ä¸ºç‰¹å®šæ¥å£é…ç½®DNS**ï¼š
```bash
# ä¸ºeth0æ¥å£è®¾ç½®DNS
sudo resolvectl dns eth0 8.8.8.8 114.114.114.114

# ä¸ºæ¥å£è®¾ç½®æœç´¢åŸŸ
sudo resolvectl domain eth0 home.lan

# æŸ¥çœ‹æ¥å£DNSé…ç½®
resolvectl status eth0
```

---

## 4. ğŸ”„ nscdåç§°æœåŠ¡ç¼“å­˜å®ˆæŠ¤è¿›ç¨‹


### 4.1 nscdæœåŠ¡ä»‹ç»


**nscdæ˜¯ä»€ä¹ˆ**ï¼š
Name Service Cache Daemon(åç§°æœåŠ¡ç¼“å­˜å®ˆæŠ¤è¿›ç¨‹)ï¼Œæ˜¯ä¸€ä¸ªç»å…¸çš„ç³»ç»Ÿçº§ç¼“å­˜æœåŠ¡ï¼Œä¸“é—¨ç¼“å­˜å„ç§åç§°è§£æç»“æœï¼Œä¸ä»…ä»…æ˜¯DNSï¼Œè¿˜åŒ…æ‹¬ç”¨æˆ·åã€ç»„åç­‰ã€‚

**ğŸ”¸ ç¼“å­˜èŒƒå›´**ï¼š
- **DNSè§£æ**ï¼šåŸŸååˆ°IPåœ°å€æ˜ å°„
- **ç”¨æˆ·å**ï¼šç”¨æˆ·IDåˆ°ç”¨æˆ·åæ˜ å°„  
- **ç»„å**ï¼šç»„IDåˆ°ç»„åæ˜ å°„
- **ä¸»æœºå**ï¼š/etc/hostsæ–‡ä»¶å†…å®¹

### 4.2 nscdå®‰è£…ä¸é…ç½®


**å®‰è£…nscd**ï¼š
```bash
# Ubuntu/Debian
sudo apt install nscd

# CentOS/RHEL
sudo yum install nscd
```

**ä¸»é…ç½®æ–‡ä»¶è¯¦è§£**ï¼š
```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo vim /etc/nscd.conf
```

**DNSç¼“å­˜ç›¸å…³é…ç½®**ï¼š
```bash
# DNSä¸»æœºåç¼“å­˜é…ç½®
enable-cache hosts yes           # å¯ç”¨hostsç¼“å­˜
positive-time-to-live hosts 3600 # æ­£ç¡®è®°å½•ç¼“å­˜1å°æ—¶
negative-time-to-live hosts 20   # é”™è¯¯è®°å½•ç¼“å­˜20ç§’  
suggested-size hosts 211         # å“ˆå¸Œè¡¨å¤§å°
check-files hosts yes            # æ£€æŸ¥/etc/hostsæ–‡ä»¶å˜åŒ–
persistent hosts yes             # æŒä¹…åŒ–ç¼“å­˜åˆ°ç£ç›˜

# ç¼“å­˜å¤§å°é™åˆ¶
max-db-size hosts 33554432       # æœ€å¤§æ•°æ®åº“å¤§å°32MB
```

**å…¶ä»–åç§°æœåŠ¡ç¼“å­˜**ï¼š
```bash
# ç”¨æˆ·åç¼“å­˜
enable-cache passwd yes
positive-time-to-live passwd 600
negative-time-to-live passwd 20

# ç»„åç¼“å­˜  
enable-cache group yes
positive-time-to-live group 3600
negative-time-to-live group 60
```

### 4.3 nscdç¼“å­˜ç®¡ç†


**ç¼“å­˜æ§åˆ¶å‘½ä»¤**ï¼š
```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start nscd
sudo systemctl enable nscd

# æ¸…é™¤æŒ‡å®šç±»å‹ç¼“å­˜
sudo nscd -i hosts    # æ¸…é™¤DNSç¼“å­˜
sudo nscd -i passwd   # æ¸…é™¤ç”¨æˆ·ç¼“å­˜
sudo nscd -i group    # æ¸…é™¤ç»„ç¼“å­˜

# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
sudo nscd -g
```

**ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯è§£è¯»**ï¼š
```bash
# hostsç¼“å­˜ç»Ÿè®¡ç¤ºä¾‹
hosts cache:
    yes  cache is enabled
    yes  cache is persistent  
    yes  cache is shared
    211  suggested size
    216064  total data pool size
    144  used data pool size
    3600  seconds time to live for positive entries
    20   seconds time to live for negative entries
    247  cache hits on positive entries
    89   cache hits on negative entries
    156  cache misses on positive entries
```

---

## 5. ğŸ“Š DNSç¼“å­˜ç›‘æ§ä¸æ€§èƒ½è°ƒä¼˜


### 5.1 ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§


**ç›‘æ§æŒ‡æ ‡ä½“ç³»**ï¼š
```bash
# é‡è¦ç›‘æ§æŒ‡æ ‡
ç¼“å­˜å‘½ä¸­ç‡ = å‘½ä¸­æ¬¡æ•° / (å‘½ä¸­æ¬¡æ•° + æœªå‘½ä¸­æ¬¡æ•°)
å¹³å‡å“åº”æ—¶é—´ = æ€»å“åº”æ—¶é—´ / æŸ¥è¯¢æ¬¡æ•°  
ç¼“å­˜ä½¿ç”¨ç‡ = å·²ä½¿ç”¨ç¼“å­˜ç©ºé—´ / æ€»ç¼“å­˜ç©ºé—´
```

**dnsmasqç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# DNSç¼“å­˜ç›‘æ§è„šæœ¬

# è·å–dnsmasqç»Ÿè®¡ä¿¡æ¯
echo "=== dnsmasqç¼“å­˜ç»Ÿè®¡ ==="
sudo kill -USR1 $(pidof dnsmasq) 2>/dev/null
sleep 1
journalctl -u dnsmasq --since "1 minute ago" | grep -E "(cache|queries)"

# æµ‹è¯•DNSå“åº”æ—¶é—´
echo "=== DNSå“åº”æ—¶é—´æµ‹è¯• ==="
for server in 127.0.0.1 8.8.8.8; do
    echo "æµ‹è¯•æœåŠ¡å™¨: $server"
    time nslookup google.com $server > /dev/null
done
```

**systemd-resolvedç›‘æ§**ï¼š
```bash
#!/bin/bash
# resolvedç¼“å­˜ç›‘æ§

echo "=== systemd-resolvedç»Ÿè®¡ ==="
resolvectl statistics

echo "=== ç¼“å­˜å‘½ä¸­ç‡è®¡ç®— ==="
stats=$(resolvectl statistics)
hits=$(echo "$stats" | grep -o "Cache: [0-9]* hits" | grep -o "[0-9]*")
misses=$(echo "$stats" | grep -o "[0-9]* misses" | grep -o "[0-9]*")

if [ -n "$hits" ] && [ -n "$misses" ]; then
    total=$((hits + misses))
    hit_rate=$(echo "scale=2; $hits * 100 / $total" | bc)
    echo "ç¼“å­˜å‘½ä¸­ç‡: $hit_rate%"
fi
```

### 5.2 TTLç­–ç•¥è°ƒä¼˜


**TTLä¼˜åŒ–åŸåˆ™**ï¼š

| åŸŸåç±»å‹ | **å»ºè®®TTL** | **è°ƒä¼˜ç†ç”±** |
|---------|------------|-------------|
| ğŸ  **å†…ç½‘åŸŸå** | `300-600ç§’` | å˜åŒ–é¢‘ç¹ï¼Œéœ€è¦å¿«é€Ÿæ›´æ–° |
| ğŸŒ **å¸¸ç”¨ç½‘ç«™** | `3600-7200ç§’` | ç›¸å¯¹ç¨³å®šï¼Œå‡å°‘æŸ¥è¯¢ |
| ğŸ“§ **é‚®ä»¶æœåŠ¡** | `1800-3600ç§’` | å¹³è¡¡å¯ç”¨æ€§å’Œæ—¶æ•ˆæ€§ |
| ğŸ”’ **å®‰å…¨åŸŸå** | `300-900ç§’` | å®‰å…¨æ›´æ–°éœ€è¦åŠæ—¶ç”Ÿæ•ˆ |

**åŠ¨æ€TTLè°ƒæ•´ç­–ç•¥**ï¼š
```bash
# dnsmasqåŠ¨æ€TTLé…ç½®
min-cache-ttl=300       # æœ€å°5åˆ†é’Ÿï¼Œä¿è¯åŸºæœ¬ç¼“å­˜æ•ˆæœ
max-cache-ttl=7200      # æœ€å¤§2å°æ—¶ï¼Œé¿å…è¿‡æ—¶ä¿¡æ¯
neg-ttl=60              # å¤±è´¥æŸ¥è¯¢1åˆ†é’Ÿï¼Œå¿«é€Ÿé‡è¯•

# ç‰¹æ®ŠåŸŸåTTL
local-ttl=600           # æœ¬åœ°åŸŸå10åˆ†é’Ÿ
auth-ttl=1800           # æƒå¨æœåŠ¡å™¨30åˆ†é’Ÿ
```

### 5.3 ç¼“å­˜æ€§èƒ½åŸºå‡†æµ‹è¯•


**DNSæŸ¥è¯¢æ€§èƒ½æµ‹è¯•å·¥å…·**ï¼š
```bash
# å®‰è£…æµ‹è¯•å·¥å…·
sudo apt install dnsutils bind9-utils

# åŸºå‡†æµ‹è¯•è„šæœ¬
#!/bin/bash
echo "=== DNSæ€§èƒ½åŸºå‡†æµ‹è¯• ==="

domains=("google.com" "github.com" "stackoverflow.com" "baidu.com")
servers=("127.0.0.1" "8.8.8.8" "114.114.114.114")

for server in "${servers[@]}"; do
    echo "æµ‹è¯•DNSæœåŠ¡å™¨: $server"
    total_time=0
    
    for i in {1..10}; do
        for domain in "${domains[@]}"; do
            start_time=$(date +%s.%N)
            nslookup "$domain" "$server" > /dev/null 2>&1
            end_time=$(date +%s.%N)
            duration=$(echo "$end_time - $start_time" | bc)
            total_time=$(echo "$total_time + $duration" | bc)
        done
    done
    
    avg_time=$(echo "scale=3; $total_time / 40" | bc)
    echo "å¹³å‡å“åº”æ—¶é—´: ${avg_time}ç§’"
    echo "---"
done
```

**ç¼“å­˜é¢„çƒ­è„šæœ¬**ï¼š
```bash
#!/bin/bash
# DNSç¼“å­˜é¢„çƒ­è„šæœ¬

echo "å¼€å§‹DNSç¼“å­˜é¢„çƒ­..."

# å¸¸ç”¨åŸŸååˆ—è¡¨
common_domains=(
    "google.com" "github.com" "stackoverflow.com"
    "baidu.com" "qq.com" "taobao.com"
    "amazon.com" "microsoft.com" "apple.com"
)

# é¢„çƒ­ç¼“å­˜
for domain in "${common_domains[@]}"; do
    echo "é¢„çƒ­åŸŸå: $domain"
    nslookup "$domain" 127.0.0.1 > /dev/null 2>&1
    sleep 0.1
done

echo "ç¼“å­˜é¢„çƒ­å®Œæˆï¼"
```

### 5.4 ç¼“å­˜æ¸…ç†ä¸åˆ·æ–°æœºåˆ¶


**è‡ªåŠ¨ç¼“å­˜æ¸…ç†ç­–ç•¥**ï¼š
```bash
# åˆ›å»ºå®šæ—¶æ¸…ç†è„šæœ¬
sudo vim /usr/local/bin/dns-cache-cleanup.sh

#!/bin/bash
# DNSç¼“å­˜å®šæœŸæ¸…ç†è„šæœ¬

# æ¸…ç†ç³»ç»ŸDNSç¼“å­˜
if systemctl is-active --quiet systemd-resolved; then
    resolvectl flush-caches
    echo "$(date): systemd-resolvedç¼“å­˜å·²æ¸…ç†"
fi

# æ¸…ç†nscdç¼“å­˜
if systemctl is-active --quiet nscd; then
    nscd -i hosts
    echo "$(date): nscdç¼“å­˜å·²æ¸…ç†"  
fi

# é‡æ–°åŠ è½½dnsmasqé…ç½®
if systemctl is-active --quiet dnsmasq; then
    systemctl reload dnsmasq
    echo "$(date): dnsmasqé…ç½®å·²é‡è½½"
fi

# æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡
sudo chmod +x /usr/local/bin/dns-cache-cleanup.sh
echo "0 3 * * * /usr/local/bin/dns-cache-cleanup.sh >> /var/log/dns-cleanup.log" | sudo crontab -
```

---

## 6. ğŸ—ï¸ æœ¬åœ°DNSç¼“å­˜æœåŠ¡éƒ¨ç½²


### 6.1 ç”Ÿäº§ç¯å¢ƒDNSç¼“å­˜æ¶æ„


**æ¨èæ¶æ„è®¾è®¡**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åº”ç”¨æœåŠ¡å™¨               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Web App    â”‚ â”‚  Database   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ DNSæŸ¥è¯¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æœ¬åœ°DNSç¼“å­˜å±‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  dnsmasq    â”‚ â”‚  unbound    â”‚   â”‚
â”‚  â”‚  (ä¸»ç¼“å­˜)    â”‚ â”‚  (å¤‡ä»½)     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ ç¼“å­˜æœªå‘½ä¸­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ä¸Šæ¸¸DNSæœåŠ¡å™¨              â”‚
â”‚  8.8.8.8    114.114.114.114       â”‚
â”‚  223.5.5.5  1.1.1.1                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 é«˜å¯ç”¨DNSç¼“å­˜é…ç½®


**ä¸»å¤‡DNSç¼“å­˜é…ç½®**ï¼š
```bash
# ä¸»æœåŠ¡å™¨ - dnsmasqé…ç½®
# /etc/dnsmasq.conf
cache-size=50000
server=8.8.8.8
server=114.114.114.114
listen-address=127.0.0.1,192.168.1.10

# å¤‡æœåŠ¡å™¨ - unboundé…ç½®  
# /etc/unbound/unbound.conf
server:
    cache-min-ttl: 300
    cache-max-ttl: 86400
    msg-cache-size: 50m
    rrset-cache-size: 100m
    
forward-zone:
    name: "."
    forward-addr: 8.8.8.8
    forward-addr: 114.114.114.114
```

**å®¢æˆ·ç«¯DNSé…ç½®**ï¼š
```bash
# /etc/resolv.conf é…ç½®
nameserver 192.168.1.10    # ä¸»DNSç¼“å­˜æœåŠ¡å™¨
nameserver 192.168.1.11    # å¤‡DNSç¼“å­˜æœåŠ¡å™¨  
nameserver 8.8.8.8         # å…¬ç½‘DNSå¤‡ç”¨

# æœç´¢åŸŸé…ç½®
search home.lan office.local
options timeout:2 attempts:3
```

### 6.3 å®¹å™¨åŒ–DNSç¼“å­˜éƒ¨ç½²


**Dockeréƒ¨ç½²dnsmasq**ï¼š
```bash
# åˆ›å»ºé…ç½®ç›®å½•
mkdir -p /opt/dnsmasq/{config,hosts}

# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > /opt/dnsmasq/config/dnsmasq.conf << EOF
cache-size=10000
server=8.8.8.8
server=114.114.114.114
listen-address=0.0.0.0
port=53
log-queries
log-facility=/var/log/dnsmasq.log
EOF

# å¯åŠ¨å®¹å™¨
docker run -d \
  --name dnsmasq \
  --restart unless-stopped \
  -p 53:53/udp \
  -p 53:53/tcp \
  -v /opt/dnsmasq/config:/etc/dnsmasq.d \
  -v /opt/dnsmasq/hosts:/etc/dnsmasq.hosts \
  --cap-add=NET_ADMIN \
  andyshinn/dnsmasq:latest
```

**Kuberneteséƒ¨ç½²ç¤ºä¾‹**ï¼š
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dnsmasq-cache
spec:
  replicas: 2
  selector:
    matchLabels:
      app: dnsmasq-cache
  template:
    metadata:
      labels:
        app: dnsmasq-cache
    spec:
      containers:
      - name: dnsmasq
        image: andyshinn/dnsmasq:latest
        ports:
        - containerPort: 53
          protocol: UDP
        - containerPort: 53
          protocol: TCP
        volumeMounts:
        - name: config
          mountPath: /etc/dnsmasq.d
      volumes:
      - name: config
        configMap:
          name: dnsmasq-config
---
apiVersion: v1
kind: Service
metadata:
  name: dnsmasq-service
spec:
  selector:
    app: dnsmasq-cache
  ports:
  - port: 53
    targetPort: 53
    protocol: UDP
  type: ClusterIP
```

### 6.4 DNSç¼“å­˜æœåŠ¡ç›‘æ§


**ç›‘æ§é…ç½®ç¤ºä¾‹**ï¼š
```bash
# Prometheusç›‘æ§é…ç½®
# /etc/prometheus/prometheus.yml
scrape_configs:
  - job_name: 'dnsmasq'
    static_configs:
      - targets: ['localhost:9153']
    metrics_path: /metrics
    scrape_interval: 30s

# Grafanaé¢æ¿å…³é”®æŒ‡æ ‡
- DNSæŸ¥è¯¢æ€»æ•°
- ç¼“å­˜å‘½ä¸­ç‡  
- å¹³å‡å“åº”æ—¶é—´
- é”™è¯¯æŸ¥è¯¢ç‡
- ç¼“å­˜ä½¿ç”¨ç‡
```

**å‘Šè­¦è§„åˆ™é…ç½®**ï¼š
```yaml
# alerts.yml
groups:
- name: dns_cache_alerts
  rules:
  - alert: DNSCacheHitRateLow
    expr: dns_cache_hit_rate < 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "DNSç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
      description: "DNSç¼“å­˜å‘½ä¸­ç‡ {{ $value }}% ä½äº80%"
      
  - alert: DNSQueryResponseSlow  
    expr: dns_query_duration_seconds > 1
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "DNSæŸ¥è¯¢å“åº”è¿‡æ…¢"
      description: "DNSæŸ¥è¯¢å¹³å‡å“åº”æ—¶é—´ {{ $value }}ç§’"
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ DNSç¼“å­˜æœ¬è´¨ï¼šæœ¬åœ°å­˜å‚¨åŸŸåè§£æç»“æœï¼Œæå‡æŸ¥è¯¢é€Ÿåº¦
ğŸ”¸ ç¼“å­˜å±‚æ¬¡ï¼šåº”ç”¨ç¼“å­˜ â†’ ç³»ç»Ÿç¼“å­˜ â†’ æœ¬åœ°DNSç¼“å­˜ â†’ ä¸Šæ¸¸DNS
ğŸ”¸ TTLæœºåˆ¶ï¼šæ§åˆ¶ç¼“å­˜ç”Ÿå­˜æ—¶é—´ï¼Œå¹³è¡¡æ—¶æ•ˆæ€§å’Œæ€§èƒ½
ğŸ”¸ å‘½ä¸­ç‡ä¼˜åŒ–ï¼šé€šè¿‡åˆç†é…ç½®æå‡ç¼“å­˜æ•ˆæœ
ğŸ”¸ ç›‘æ§ä½“ç³»ï¼šå‘½ä¸­ç‡ã€å“åº”æ—¶é—´ã€ç¼“å­˜ä½¿ç”¨ç‡ç­‰å…³é”®æŒ‡æ ‡
```

### 7.2 ä¸åŒæ–¹æ¡ˆçš„é€‰æ‹©å»ºè®®


| ä½¿ç”¨åœºæ™¯ | **æ¨èæ–¹æ¡ˆ** | **é…ç½®é‡ç‚¹** | **é€‚ç”¨åŸå› ** |
|---------|-------------|-------------|-------------|
| ğŸ  **å®¶åº­ç½‘ç»œ** | `dnsmasq` | ç®€å•é…ç½®ï¼Œå¯ç”¨ç¼“å­˜ | è½»é‡çº§ï¼Œæ˜“ç®¡ç† |
| ğŸ–¥ï¸ **æ¡Œé¢ç³»ç»Ÿ** | `systemd-resolved` | é»˜è®¤é…ç½®å³å¯ | ç³»ç»Ÿé›†æˆåº¦é«˜ |
| ğŸ¢ **ä¼ä¸šå†…ç½‘** | `dnsmasq + nscd` | å¤§ç¼“å­˜ï¼Œè‡ªå®šä¹‰åŸŸå | åŠŸèƒ½ä¸°å¯Œï¼Œå¯æ§æ€§å¼º |
| â˜ï¸ **äº‘æœåŠ¡å™¨** | `unbound` | é«˜æ€§èƒ½é…ç½® | å®‰å…¨æ€§å¼ºï¼Œæ€§èƒ½ä¼˜å¼‚ |

### 7.3 é…ç½®ä¼˜åŒ–æœ€ä½³å®è·µ


**ğŸ”¹ ç¼“å­˜å¤§å°é…ç½®**ï¼š
```
å°å‹ç¯å¢ƒï¼š1000-5000æ¡è®°å½•
ä¸­å‹ç¯å¢ƒï¼š10000-20000æ¡è®°å½•  
å¤§å‹ç¯å¢ƒï¼š50000+æ¡è®°å½•

è®¡ç®—å…¬å¼ï¼šé¢„ä¼°å¹¶å‘ç”¨æˆ·æ•° Ã— å¸¸ç”¨åŸŸåæ•° Ã— 2
```

**ğŸ”¹ TTLç­–ç•¥å»ºè®®**ï¼š
```
å†…ç½‘åŸŸåï¼š300-600ç§’ (å˜åŒ–é¢‘ç¹)
å¸¸ç”¨ç½‘ç«™ï¼š1800-3600ç§’ (ç›¸å¯¹ç¨³å®š)
CDNåŸŸåï¼š600-1800ç§’ (è´Ÿè½½å‡è¡¡è€ƒè™‘)
å¤±è´¥æŸ¥è¯¢ï¼š20-60ç§’ (å¿«é€Ÿé‡è¯•)
```

**ğŸ”¹ æ€§èƒ½ç›‘æ§è¦ç‚¹**ï¼š
```
ç¼“å­˜å‘½ä¸­ç‡ > 80% (è‰¯å¥½)
å¹³å‡å“åº”æ—¶é—´ < 50ms (æœ¬åœ°ç¼“å­˜)
ç¼“å­˜ä½¿ç”¨ç‡ < 90% (é¿å…æº¢å‡º)
é”™è¯¯æŸ¥è¯¢ç‡ < 5% (æœåŠ¡ç¨³å®š)
```

### 7.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â— ç¼“å­˜ä¸ç”Ÿæ•ˆé—®é¢˜**ï¼š
- æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š`systemctl status dnsmasq`
- éªŒè¯é…ç½®è¯­æ³•ï¼š`dnsmasq --test`
- æŸ¥çœ‹ç›‘å¬ç«¯å£ï¼š`netstat -tunlp | grep :53`
- æµ‹è¯•æŸ¥è¯¢è·¯å¾„ï¼š`nslookup domain 127.0.0.1`

**â— å‘½ä¸­ç‡ä½é—®é¢˜**ï¼š
- å¢åŠ ç¼“å­˜å¤§å°é…ç½®
- è°ƒæ•´TTLç­–ç•¥
- æ£€æŸ¥ä¸Šæ¸¸DNSå“åº”
- åˆ†æåŸŸåè®¿é—®æ¨¡å¼

**â— å“åº”æ…¢é—®é¢˜**ï¼š
- ä¼˜åŒ–ä¸Šæ¸¸DNSé€‰æ‹©
- å¯ç”¨DNS-over-TLS
- é…ç½®æœ¬åœ°æƒå¨åŸŸå
- å®æ–½ç¼“å­˜é¢„çƒ­ç­–ç•¥

### 7.5 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ æ€§èƒ½æå‡æ•ˆæœ**ï¼š
- **æŸ¥è¯¢é€Ÿåº¦**ï¼šä»100-200msé™è‡³1-5ms
- **ç½‘ç»œæµé‡**ï¼šå‡å°‘60-80%çš„DNSæŸ¥è¯¢æµé‡  
- **ç”¨æˆ·ä½“éªŒ**ï¼šç½‘é¡µåŠ è½½é€Ÿåº¦æå‡20-30%
- **æœåŠ¡ç¨³å®šæ€§**ï¼šå‡å°‘å¯¹å¤–éƒ¨DNSä¾èµ–

**ğŸ”§ è¿ç»´å®è·µè¦ç‚¹**ï¼š
- **ç›‘æ§å…ˆè¡Œ**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»
- **æ¸è¿›ä¼˜åŒ–**ï¼šä»é»˜è®¤é…ç½®å¼€å§‹é€æ­¥è°ƒä¼˜
- **å¤‡ä»½æœºåˆ¶**ï¼šé…ç½®å¤šçº§DNSç¼“å­˜å’Œå¤‡ç”¨æ–¹æ¡ˆ
- **å®šæœŸç»´æŠ¤**ï¼šæ¸…ç†è¿‡æœŸç¼“å­˜ï¼Œæ›´æ–°é…ç½®

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- DNSç¼“å­˜å¦‚åŒæœ¬åœ°ç”µè¯ç°¿ï¼Œå‡å°‘è¿œç¨‹æŸ¥è¯¢å»¶è¿Ÿ
- ä¸åŒåœºæ™¯é€‰æ‹©åˆé€‚æ–¹æ¡ˆï¼Œdnsmasqè½»é‡ï¼Œresolvedé›†æˆ
- TTLç­–ç•¥å¹³è¡¡æ—¶æ•ˆæ€§ä¸æ€§èƒ½ï¼Œç›‘æ§å‘½ä¸­ç‡æ˜¯å…³é”®
- ç”Ÿäº§ç¯å¢ƒéœ€è¦é«˜å¯ç”¨æ¶æ„å’Œå®Œå–„ç›‘æ§ä½“ç³»