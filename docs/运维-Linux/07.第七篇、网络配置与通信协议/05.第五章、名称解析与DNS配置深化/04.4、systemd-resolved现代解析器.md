---
title: 4ã€systemd-resolvedç°ä»£è§£æå™¨
---
## ğŸ“š ç›®å½•

1. [systemd-resolvedæœåŠ¡æ¶æ„](#1-systemd-resolvedæœåŠ¡æ¶æ„)
2. [resolved.confé…ç½®è¯¦è§£](#2-resolved-confé…ç½®è¯¦è§£)
3. [DNSæœåŠ¡å™¨é…ç½®ç®¡ç†](#3-dnsæœåŠ¡å™¨é…ç½®ç®¡ç†)
4. [åŸŸåè·¯ç”±ä¸åˆ†æµé…ç½®](#4-åŸŸåè·¯ç”±ä¸åˆ†æµé…ç½®)
5. [DNSSECéªŒè¯å¯ç”¨é…ç½®](#5-dnssecéªŒè¯å¯ç”¨é…ç½®)
6. [DNSç¼“å­˜ç®¡ç†ä¸æ¸…ç†](#6-dnsç¼“å­˜ç®¡ç†ä¸æ¸…ç†)
7. [å¤šé“¾è·¯DNSé…ç½®](#7-å¤šé“¾è·¯dnsé…ç½®)
8. [resolvedçŠ¶æ€æŸ¥è¯¢å‘½ä»¤](#8-resolvedçŠ¶æ€æŸ¥è¯¢å‘½ä»¤)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ systemd-resolvedæœåŠ¡æ¶æ„


### 1.1 ä»€ä¹ˆæ˜¯systemd-resolved


**systemd-resolved**æ˜¯ç°ä»£Linuxç³»ç»Ÿä¸­çš„**ç»Ÿä¸€DNSè§£ææœåŠ¡**ï¼Œå®ƒå–ä»£äº†ä¼ ç»Ÿçš„`/etc/resolv.conf`é™æ€é…ç½®æ–¹å¼ã€‚

```
ä¼ ç»ŸDNSè§£ææ–¹å¼ï¼š
åº”ç”¨ç¨‹åº â†’ /etc/resolv.conf â†’ DNSæœåŠ¡å™¨

ç°ä»£systemd-resolvedæ–¹å¼ï¼š
åº”ç”¨ç¨‹åº â†’ systemd-resolvedæœåŠ¡ â†’ æ™ºèƒ½è·¯ç”± â†’ å¤šä¸ªDNSæœåŠ¡å™¨
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ”„ **ç»Ÿä¸€ç®¡ç†**ï¼šé›†ä¸­ç®¡ç†æ‰€æœ‰ç½‘ç»œæ¥å£çš„DNSé…ç½®
- ğŸ§  **æ™ºèƒ½è·¯ç”±**ï¼šæ ¹æ®åŸŸåè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„DNSæœåŠ¡å™¨
- ğŸ’¾ **æœ¬åœ°ç¼“å­˜**ï¼šæä¾›DNSæŸ¥è¯¢ç¼“å­˜ï¼ŒåŠ å¿«è§£æé€Ÿåº¦
- ğŸ”’ **å®‰å…¨å¢å¼º**ï¼šæ”¯æŒDNSSECéªŒè¯å’ŒDNS over TLS

### 1.2 æœåŠ¡æ¶æ„ç»„æˆ


```
systemd-resolvedæ¶æ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åº”ç”¨ç¨‹åºå±‚                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        glibc NSSæ¨¡å—                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       systemd-resolvedæœåŠ¡             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚DNSç¼“å­˜  â”‚åŸŸåè·¯ç”± â”‚ DNSSECéªŒè¯      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     ç½‘ç»œæ¥å£ç®¡ç†ï¼ˆNetworkManagerç­‰ï¼‰     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         å®é™…DNSæœåŠ¡å™¨                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å·¥ä½œåŸç†è§£æ


**è¯·æ±‚å¤„ç†æµç¨‹**ï¼š

```
æ­¥éª¤1ï¸âƒ£ åº”ç”¨å‘èµ·DNSæŸ¥è¯¢è¯·æ±‚
   â†“
æ­¥éª¤2ï¸âƒ£ æ£€æŸ¥æœ¬åœ°ç¼“å­˜æ˜¯å¦æœ‰è®°å½•
   â†“
æ­¥éª¤3ï¸âƒ£ æ ¹æ®åŸŸåé€‰æ‹©åˆé€‚çš„DNSæœåŠ¡å™¨
   â†“  
æ­¥éª¤4ï¸âƒ£ å‘é€æŸ¥è¯¢åˆ°é€‰å®šçš„DNSæœåŠ¡å™¨
   â†“
æ­¥éª¤5ï¸âƒ£ éªŒè¯å“åº”ï¼ˆDNSSECç­‰ï¼‰
   â†“
æ­¥éª¤6ï¸âƒ£ ç¼“å­˜ç»“æœå¹¶è¿”å›ç»™åº”ç”¨
```

**ä¸ä¼ ç»Ÿæ–¹å¼å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | ä¼ ç»Ÿ/etc/resolv.conf | systemd-resolved |
|------|---------------------|------------------|
| **é…ç½®æ–¹å¼** | `æ‰‹åŠ¨ç¼–è¾‘æ–‡ä»¶` | `è‡ªåŠ¨ç®¡ç† + é…ç½®æ–‡ä»¶` |
| **å¤šç½‘å¡æ”¯æŒ** | `å•ä¸€é…ç½®` | `æ¯ä¸ªæ¥å£ç‹¬ç«‹é…ç½®` |
| **ç¼“å­˜åŠŸèƒ½** | `æ— ç¼“å­˜` | `å†…ç½®æ™ºèƒ½ç¼“å­˜` |
| **åŸŸåè·¯ç”±** | `ä¸æ”¯æŒ` | `æ”¯æŒæŒ‰åŸŸååˆ†æµ` |
| **å®‰å…¨ç‰¹æ€§** | `åŸºç¡€` | `DNSSEC + DoTæ”¯æŒ` |

---

## 2. âš™ï¸ resolved.confé…ç½®è¯¦è§£


### 2.1 é…ç½®æ–‡ä»¶ä½ç½®ä¸å±‚çº§


**ä¸»é…ç½®æ–‡ä»¶**ï¼š`/etc/systemd/resolved.conf`

```bash
# æŸ¥çœ‹å½“å‰é…ç½®
sudo cat /etc/systemd/resolved.conf

# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /etc/systemd/resolved.conf
```

**é…ç½®å±‚çº§ç»“æ„**ï¼š
```
é…ç½®ä¼˜å…ˆçº§ï¼ˆé«˜åˆ°ä½ï¼‰ï¼š
1. ç½‘ç»œæ¥å£ç‰¹å®šé…ç½®ï¼ˆNetworkManagerç­‰ï¼‰
2. /etc/systemd/resolved.conf.d/*.confï¼ˆç”¨æˆ·è‡ªå®šä¹‰ï¼‰
3. /etc/systemd/resolved.confï¼ˆä¸»é…ç½®æ–‡ä»¶ï¼‰
4. /usr/lib/systemd/resolved.confï¼ˆç³»ç»Ÿé»˜è®¤ï¼‰
```

### 2.2 æ ¸å¿ƒé…ç½®é€‰é¡¹è¯¦è§£


#### ğŸ“¡ DNSæœåŠ¡å™¨é…ç½®


```ini
[Resolve]
# å…¨å±€DNSæœåŠ¡å™¨ï¼ˆå¤‡ç”¨ï¼‰
DNS=8.8.8.8 1.1.1.1
# å¤‡ç”¨DNSæœåŠ¡å™¨
FallbackDNS=8.8.4.4 1.0.0.1
```

**é…ç½®å«ä¹‰**ï¼š
- **DNS**ï¼šä¸»è¦DNSæœåŠ¡å™¨ï¼Œå½“æ¥å£æœªé…ç½®æ—¶ä½¿ç”¨
- **FallbackDNS**ï¼šå½“æ‰€æœ‰å…¶ä»–DNSéƒ½å¤±è´¥æ—¶çš„æœ€åé€‰æ‹©

#### ğŸŒ åŸŸåæœç´¢é…ç½®


```ini
[Resolve]
# æœç´¢åŸŸåˆ—è¡¨
Domains=company.local home.lan
# è·¯ç”±åŸŸé…ç½®
Domains=~company.local ~.
```

**åŸŸåè·¯ç”±è¯­æ³•**ï¼š
- `company.local` - æ™®é€šæœç´¢åŸŸ
- `~company.local` - è·¯ç”±åŸŸï¼ˆç‰¹å®šåŸŸåèµ°ç‰¹å®šDNSï¼‰
- `~.` - é»˜è®¤è·¯ç”±ï¼ˆæ‰€æœ‰å…¶ä»–åŸŸåï¼‰

#### ğŸ”’ å®‰å…¨ç‰¹æ€§é…ç½®


```ini
[Resolve]
# å¯ç”¨DNSSECéªŒè¯
DNSSEC=yes
# DNS over TLS
DNSOverTLS=yes
# å¯ç”¨å¤šæ’­DNS
MulticastDNS=yes
# å¯ç”¨Link-Localå¤šæ’­åç§°è§£æ
LLMNR=yes
```

### 2.3 å®Œæ•´é…ç½®ç¤ºä¾‹


```ini
[Resolve]
# åŸºç¡€DNSé…ç½®
DNS=192.168.1.1 8.8.8.8
FallbackDNS=1.1.1.1 8.8.4.4
Domains=example.com

# å®‰å…¨é…ç½®
DNSSEC=yes
DNSOverTLS=opportunistic

# æœ¬åœ°ç½‘ç»œé…ç½®
MulticastDNS=yes
LLMNR=yes

# ç¼“å­˜é…ç½®
Cache=yes
CacheFromLocalhost=no

# è°ƒè¯•é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒè®¾ä¸ºnoï¼‰
ReadEtcHosts=yes
ResolveUnicastSingleLabel=no
```

---

## 3. ğŸ› ï¸ DNSæœåŠ¡å™¨é…ç½®ç®¡ç†


### 3.1 æŸ¥çœ‹å½“å‰DNSé…ç½®


```bash
# æŸ¥çœ‹å…¨å±€DNSçŠ¶æ€
resolvectl status

# æŸ¥çœ‹ç‰¹å®šæ¥å£DNSé…ç½®
resolvectl status eth0

# æŸ¥çœ‹DNSç»Ÿè®¡ä¿¡æ¯
resolvectl statistics
```

**è¾“å‡ºè§£é‡Š**ï¼š
```
Global:
       Protocols: +LLMNR +mDNS +DNSOverTLS DNSSEC=yes/supported
resolv.conf mode: stub
    DNS Servers: 8.8.8.8
                 1.1.1.1
```

### 3.2 åŠ¨æ€ä¿®æ”¹DNSæœåŠ¡å™¨


#### ä¸´æ—¶ä¿®æ”¹ï¼ˆé‡å¯åå¤±æ•ˆï¼‰


```bash
# ä¸ºç‰¹å®šæ¥å£è®¾ç½®DNSæœåŠ¡å™¨
sudo resolvectl dns eth0 8.8.8.8 1.1.1.1

# ä¸ºç‰¹å®šæ¥å£è®¾ç½®æœç´¢åŸŸ
sudo resolvectl domain eth0 company.local

# é‡ç½®æ¥å£DNSé…ç½®
sudo resolvectl revert eth0
```

#### æ°¸ä¹…ä¿®æ”¹æ–¹æ³•


**æ–¹æ³•1ï¼šä¿®æ”¹NetworkManageré…ç½®**
```bash
# ç¼–è¾‘ç½‘ç»œè¿æ¥
sudo nmcli connection modify "Wired connection 1" \
  ipv4.dns "8.8.8.8,1.1.1.1" \
  ipv4.dns-search "company.local"

# é‡æ–°æ¿€æ´»è¿æ¥
sudo nmcli connection up "Wired connection 1"
```

**æ–¹æ³•2ï¼šåˆ›å»ºsystemdç½‘ç»œé…ç½®**
```bash
# åˆ›å»ºç½‘ç»œé…ç½®æ–‡ä»¶
sudo nano /etc/systemd/network/eth0.network
```

```ini
[Match]
Name=eth0

[Network]
DHCP=yes

[DHCP]
UseDNS=no

[DHCPv4]
UseDNS=no

# è‡ªå®šä¹‰DNSé…ç½®
DNS=192.168.1.1
DNS=8.8.8.8
Domains=~company.local
Domains=~.
```

### 3.3 DNSæœåŠ¡å™¨ä¼˜å…ˆçº§é…ç½®


**ä¼˜å…ˆçº§è§„åˆ™**ï¼š
```
DNSæŸ¥è¯¢ä¼˜å…ˆçº§ï¼š
1ï¸âƒ£ æ¥å£ç‰¹å®šDNSï¼ˆç½‘å¡é…ç½®ï¼‰
2ï¸âƒ£ å…¨å±€DNSï¼ˆresolved.confä¸­çš„DNSï¼‰
3ï¸âƒ£ å¤‡ç”¨DNSï¼ˆFallbackDNSï¼‰
4ï¸âƒ£ ç³»ç»Ÿé»˜è®¤DNS
```

**é…ç½®ç¤ºä¾‹**ï¼š
```bash
# é«˜ä¼˜å…ˆçº§ï¼šå…¬å¸å†…ç½‘DNS
sudo resolvectl dns eth0 192.168.1.1

# ä¸­ä¼˜å…ˆçº§ï¼šå¯ä¿¡å…¬å…±DNS
echo "DNS=8.8.8.8 1.1.1.1" | sudo tee -a /etc/systemd/resolved.conf

# ä½ä¼˜å…ˆçº§ï¼šå¤‡ç”¨DNS
echo "FallbackDNS=8.8.4.4 1.0.0.1" | sudo tee -a /etc/systemd/resolved.conf
```

---

## 4. ğŸŒ åŸŸåè·¯ç”±ä¸åˆ†æµé…ç½®


### 4.1 åŸŸåè·¯ç”±æ¦‚å¿µ


**åŸŸåè·¯ç”±**å°±æ˜¯è®©ä¸åŒçš„åŸŸåèµ°ä¸åŒçš„DNSæœåŠ¡å™¨ï¼Œè¿™åœ¨**æ··åˆç½‘ç»œç¯å¢ƒ**ä¸­ç‰¹åˆ«æœ‰ç”¨ã€‚

```
ä¼ä¸šç½‘ç»œåœºæ™¯ï¼š
å†…ç½‘åŸŸåï¼ˆ*.company.localï¼‰ â†’ å†…ç½‘DNSæœåŠ¡å™¨ï¼ˆ192.168.1.1ï¼‰
å¤–ç½‘åŸŸåï¼ˆ*.com, *.orgç­‰ï¼‰   â†’ å…¬ç½‘DNSæœåŠ¡å™¨ï¼ˆ8.8.8.8ï¼‰
```

### 4.2 è·¯ç”±é…ç½®è¯­æ³•


**åŸŸåè·¯ç”±æ ‡è®°**ï¼š
- `~domain.com` - è·¯ç”±åŸŸï¼ˆè¯¥åŸŸåèµ°ç‰¹å®šDNSï¼‰
- `domain.com` - æœç´¢åŸŸï¼ˆç”¨äºè¡¥å…¨çŸ­åŸŸåï¼‰
- `~.` - é»˜è®¤è·¯ç”±ï¼ˆåŒ¹é…æ‰€æœ‰å…¶ä»–åŸŸåï¼‰

```bash
# é…ç½®å†…ç½‘åŸŸåè·¯ç”±
sudo resolvectl dns eth0 192.168.1.1
sudo resolvectl domain eth0 ~company.local

# é…ç½®å¤–ç½‘åŸŸåè·¯ç”±  
sudo resolvectl dns wlan0 8.8.8.8
sudo resolvectl domain wlan0 ~.
```

### 4.3 å¤æ‚è·¯ç”±é…ç½®ç¤ºä¾‹


**åœºæ™¯ï¼šä¼ä¸šVPN + å…¬ç½‘æ··åˆç¯å¢ƒ**

```
ç½‘ç»œæ‹“æ‰‘ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å†…ç½‘DNS    â”‚    â”‚ systemd-     â”‚    â”‚   å…¬ç½‘DNS    â”‚
â”‚192.168.1.1   â”‚â—„â”€â”€â”€â”¤ resolved     â”œâ”€â”€â”€â–ºâ”‚  8.8.8.8     â”‚
â”‚              â”‚    â”‚              â”‚    â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–²                     â–²                     â–²
      â”‚                     â”‚                     â”‚
*.company.local        è·¯ç”±å†³ç­–           *.com, *.org
```

**é…ç½®å‘½ä»¤**ï¼š
```bash
# VPNæ¥å£é…ç½®ï¼ˆå†…ç½‘åŸŸåï¼‰
sudo resolvectl dns tun0 192.168.1.1 10.0.0.1
sudo resolvectl domain tun0 ~company.local ~internal.net

# ä¸»ç½‘å¡é…ç½®ï¼ˆå¤–ç½‘åŸŸåï¼‰
sudo resolvectl dns eth0 8.8.8.8 1.1.1.1  
sudo resolvectl domain eth0 ~.

# æµ‹è¯•è·¯ç”±é…ç½®
resolvectl query server.company.local  # èµ°å†…ç½‘DNS
resolvectl query google.com            # èµ°å¤–ç½‘DNS
```

### 4.4 æ¡ä»¶è½¬å‘é…ç½®


**ä½¿ç”¨systemdç½‘ç»œé…ç½®æ–‡ä»¶**ï¼š

```bash
# åˆ›å»ºä¸“ç”¨é…ç½®
sudo nano /etc/systemd/network/10-vpn-routing.network
```

```ini
[Match]
Name=tun0

[Network]
# å†…ç½‘DNSæœåŠ¡å™¨
DNS=192.168.1.1
DNS=10.0.0.1

# åŸŸåè·¯ç”±é…ç½®
Domains=~company.local
Domains=~internal.net
Domains=~10.in-addr.arpa
Domains=~168.192.in-addr.arpa

[Route]
# å†…ç½‘è·¯ç”±
Destination=192.168.0.0/16
Gateway=192.168.1.1
```

---

## 5. ğŸ” DNSSECéªŒè¯å¯ç”¨é…ç½®


### 5.1 DNSSECåŸºç¡€æ¦‚å¿µ


**DNSSECï¼ˆDNSå®‰å…¨æ‰©å±•ï¼‰**æ˜¯DNSçš„å®‰å…¨å¢å¼ºåè®®ï¼Œç”¨äºéªŒè¯DNSå“åº”çš„çœŸå®æ€§å’Œå®Œæ•´æ€§ã€‚

**è§£å†³çš„é—®é¢˜**ï¼š
- ğŸš« **DNSæ¬ºéª—**ï¼šé˜²æ­¢æ¶æ„DNSå“åº”
- ğŸ”’ **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿DNSè®°å½•æœªè¢«ç¯¡æ”¹
- âœ… **æ¥æºéªŒè¯**ï¼šéªŒè¯DNSå“åº”æ¥æºçš„åˆæ³•æ€§

```
DNSSECéªŒè¯æµç¨‹ï¼š
DNSæŸ¥è¯¢ â†’ è·å–è®°å½•+ç­¾å â†’ éªŒè¯ç­¾å â†’ ç¡®è®¤çœŸå®æ€§
```

### 5.2 å¯ç”¨DNSSECé…ç½®


**å…¨å±€å¯ç”¨**ï¼š
```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /etc/systemd/resolved.conf
```

```ini
[Resolve]
# å¯ç”¨DNSSECéªŒè¯
DNSSEC=yes

# å¯é€‰ï¼šå…è®¸é™çº§åˆ°éDNSSEC
# DNSSEC=allow-downgrade  

# å¯é€‰ï¼šå®Œå…¨ç¦ç”¨DNSSEC
# DNSSEC=no
```

**DNSSECé…ç½®é€‰é¡¹**ï¼š
- `yes` - å¼ºåˆ¶DNSSECéªŒè¯
- `allow-downgrade` - ä¼˜å…ˆDNSSECï¼Œå¤±è´¥æ—¶é™çº§
- `no` - ç¦ç”¨DNSSECéªŒè¯

### 5.3 éªŒè¯DNSSECçŠ¶æ€


```bash
# æŸ¥çœ‹DNSSECçŠ¶æ€
resolvectl status | grep DNSSEC

# æµ‹è¯•DNSSECéªŒè¯
resolvectl query cloudflare.com --type=A

# è¯¦ç»†éªŒè¯ä¿¡æ¯
resolvectl query --legend=yes cloudflare.com
```

**éªŒè¯è¾“å‡ºè§£é‡Š**ï¼š
```
cloudflare.com: 104.16.132.229
                104.16.133.229

-- Information acquired via protocol DNS in 45.2ms.
-- Data is authentic (DNSSEC).
```

### 5.4 DNSSECæ•…éšœæ’é™¤


**å¸¸è§é—®é¢˜ä¸è§£å†³**ï¼š

```bash
# é—®é¢˜1ï¼šDNSSECéªŒè¯å¤±è´¥
# ç°è±¡ï¼šæŸäº›åŸŸåæ— æ³•è§£æ
# è§£å†³ï¼šä¸´æ—¶ç¦ç”¨DNSSECéªŒè¯
sudo resolvectl reset-server-features

# é—®é¢˜2ï¼šæ—¶é—´åŒæ­¥é—®é¢˜
# DNSSECå¯¹æ—¶é—´æ•æ„Ÿï¼Œç¡®ä¿ç³»ç»Ÿæ—¶é—´æ­£ç¡®
sudo timedatectl set-ntp true
sudo timedatectl status

# é—®é¢˜3ï¼šä¸Šæ¸¸DNSä¸æ”¯æŒDNSSEC
# æ›´æ¢æ”¯æŒDNSSECçš„DNSæœåŠ¡å™¨
sudo resolvectl dns eth0 1.1.1.1 8.8.8.8
```

**è°ƒè¯•å‘½ä»¤**ï¼š
```bash
# æŸ¥çœ‹DNSSECéªŒè¯è¯¦æƒ…
resolvectl query --legend=yes --type=DNSKEY cloudflare.com

# æ£€æŸ¥ç‰¹å®šè®°å½•çš„DNSSECçŠ¶æ€
dig +dnssec @127.0.0.53 cloudflare.com

# æŸ¥çœ‹éªŒè¯é“¾
delv cloudflare.com
```

---

## 6. ğŸ—‚ï¸ DNSç¼“å­˜ç®¡ç†ä¸æ¸…ç†


### 6.1 DNSç¼“å­˜æœºåˆ¶


**systemd-resolved**å†…ç½®æ™ºèƒ½DNSç¼“å­˜ï¼Œç”¨äºæé«˜DNSæŸ¥è¯¢æ€§èƒ½ã€‚

```
ç¼“å­˜å·¥ä½œåŸç†ï¼š
æŸ¥è¯¢è¯·æ±‚ â†’ æ£€æŸ¥ç¼“å­˜ â†’ ç¼“å­˜å‘½ä¸­ï¼Ÿ
     â†“              â†“         â†“
  å‘é€åˆ°DNS     ç›´æ¥è¿”å›    ä»ç¼“å­˜è¿”å›
     â†“              
  ç¼“å­˜å“åº”
```

**ç¼“å­˜ç‰¹æ€§**ï¼š
- ğŸ’¾ **è‡ªåŠ¨ç®¡ç†**ï¼šæ ¹æ®TTLè‡ªåŠ¨è¿‡æœŸ
- ğŸ§  **æ™ºèƒ½æ›´æ–°**ï¼šè´Ÿç¼“å­˜æœºåˆ¶é¿å…é‡å¤æŸ¥è¯¢å¤±è´¥
- âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘ç½‘ç»œè¯·æ±‚ï¼ŒåŠ å¿«å“åº”é€Ÿåº¦

### 6.2 æŸ¥çœ‹ç¼“å­˜çŠ¶æ€


```bash
# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
resolvectl statistics

# è¯¦ç»†ç¼“å­˜ä¿¡æ¯
systemd-resolve --statistics
```

**ç»Ÿè®¡ä¿¡æ¯è§£è¯»**ï¼š
```
DNSSEC supported by current servers: yes

Transactions
Current Transactions: 0
  Total Transactions: 2504

Cache
  Current Cache Size: 156
  Cache Hits: 1247
  Cache Misses: 1257

DNSSEC Verdicts
  Secure: 892
  Insecure: 365
  Bogus: 0
  Indeterminate: 0
```

### 6.3 ç¼“å­˜ç®¡ç†æ“ä½œ


#### æ¸…ç©ºDNSç¼“å­˜


```bash
# æ–¹æ³•1ï¼šä½¿ç”¨resolvectlå‘½ä»¤ï¼ˆæ¨èï¼‰
sudo resolvectl flush-caches

# æ–¹æ³•2ï¼šé‡å¯systemd-resolvedæœåŠ¡
sudo systemctl restart systemd-resolved

# éªŒè¯ç¼“å­˜å·²æ¸…ç©º
resolvectl statistics
```

#### é…ç½®ç¼“å­˜è¡Œä¸º


```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /etc/systemd/resolved.conf
```

```ini
[Resolve]
# å¯ç”¨/ç¦ç”¨ç¼“å­˜
Cache=yes

# æ˜¯å¦ç¼“å­˜localhostæŸ¥è¯¢
CacheFromLocalhost=no

# è´Ÿç¼“å­˜TTLï¼ˆå¤±è´¥æŸ¥è¯¢çš„ç¼“å­˜æ—¶é—´ï¼‰
# é»˜è®¤å€¼é€šå¸¸è¶³å¤Ÿï¼Œä¸€èˆ¬ä¸éœ€è¦ä¿®æ”¹
```

### 6.4 ç¼“å­˜æ€§èƒ½ä¼˜åŒ–


**ç›‘æ§ç¼“å­˜æ•ˆç‡**ï¼š
```bash
# åˆ›å»ºç¼“å­˜ç›‘æ§è„šæœ¬
cat > /tmp/dns_cache_monitor.sh << 'EOF'
#!/bin/bash
while true; do
    echo "=== $(date) ==="
    resolvectl statistics | grep -E "(Cache|Hit|Miss)"
    echo
    sleep 30
done
EOF

chmod +x /tmp/dns_cache_monitor.sh
/tmp/dns_cache_monitor.sh
```

**ä¼˜åŒ–å»ºè®®**ï¼š
- âœ… **åˆç†TTL**ï¼šä¸è¦è®¾ç½®è¿‡çŸ­çš„TTLå€¼
- âœ… **é¢„çƒ­ç¼“å­˜**ï¼šç³»ç»Ÿå¯åŠ¨åé¢„å…ˆæŸ¥è¯¢å¸¸ç”¨åŸŸå
- âœ… **ç›‘æ§å‘½ä¸­ç‡**ï¼šå‘½ä¸­ç‡åº”ä¿æŒåœ¨60%ä»¥ä¸Š

---

## 7. ğŸ”— å¤šé“¾è·¯DNSé…ç½®


### 7.1 å¤šé“¾è·¯åœºæ™¯ä»‹ç»


**å¤šé“¾è·¯DNS**æ˜¯æŒ‡ç³»ç»ŸåŒæ—¶è¿æ¥å¤šä¸ªç½‘ç»œæ¥å£ï¼Œæ¯ä¸ªæ¥å£å¯èƒ½æœ‰ä¸åŒçš„DNSé…ç½®ã€‚

```
å¤šé“¾è·¯ç½‘ç»œæ‹“æ‰‘ï¼š
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ç³»ç»Ÿä¸»æœº   â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
â”‚ eth0  â”‚ â”‚ wlan0 â”‚ â”‚ tun0  â”‚
â”‚æœ‰çº¿ç½‘ç»œâ”‚ â”‚æ— çº¿ç½‘ç»œâ”‚ â”‚VPNè¿æ¥â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚         â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
â”‚å†…ç½‘DNSâ”‚ â”‚å…¬ç½‘DNSâ”‚ â”‚ä¼ä¸šDNSâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æŸ¥çœ‹å¤šé“¾è·¯çŠ¶æ€


```bash
# æŸ¥çœ‹æ‰€æœ‰æ¥å£çš„DNSé…ç½®
resolvectl status

# æŸ¥çœ‹ç‰¹å®šæ¥å£
resolvectl status eth0
resolvectl status wlan0
resolvectl status tun0
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
Link 2 (eth0):
    Current Scopes: DNS
         Protocols: +DefaultRoute +LLMNR -mDNS +DNSOverTLS DNSSEC=yes/supported
Current DNS Server: 192.168.1.1
       DNS Servers: 192.168.1.1
        DNS Domain: ~company.local

Link 3 (wlan0):
    Current Scopes: DNS
         Protocols: +DefaultRoute +LLMNR -mDNS +DNSOverTLS DNSSEC=yes/supported
Current DNS Server: 8.8.8.8
       DNS Servers: 8.8.8.8
                    1.1.1.1
        DNS Domain: ~.
```

### 7.3 é…ç½®æ¥å£ä¼˜å…ˆçº§


**è®¾ç½®æ¥å£DNSä¼˜å…ˆçº§**ï¼š
```bash
# é«˜ä¼˜å…ˆçº§ï¼šä¼ä¸šVPNï¼ˆå†…ç½‘æŸ¥è¯¢ï¼‰
sudo resolvectl dns tun0 10.0.0.1 192.168.1.1
sudo resolvectl domain tun0 ~company.local ~internal.net

# ä¸­ä¼˜å…ˆçº§ï¼šæœ‰çº¿ç½‘ç»œï¼ˆå¤‡ç”¨å†…ç½‘ï¼‰
sudo resolvectl dns eth0 192.168.1.1
sudo resolvectl domain eth0 ~home.lan

# ä½ä¼˜å…ˆçº§ï¼šæ— çº¿ç½‘ç»œï¼ˆå…¬ç½‘æŸ¥è¯¢ï¼‰
sudo resolvectl dns wlan0 8.8.8.8 1.1.1.1
sudo resolvectl domain wlan0 ~.

# éªŒè¯é…ç½®
resolvectl status
```

### 7.4 åŠ¨æ€é“¾è·¯ç®¡ç†


**è‡ªåŠ¨åŒ–å¤šé“¾è·¯é…ç½®è„šæœ¬**ï¼š
```bash
#!/bin/bash
# å¤šé“¾è·¯DNSè‡ªåŠ¨é…ç½®è„šæœ¬

configure_vpn_dns() {
    if ip link show tun0 >/dev/null 2>&1; then
        echo "é…ç½®VPN DNS..."
        sudo resolvectl dns tun0 10.0.0.1
        sudo resolvectl domain tun0 ~company.local
    fi
}

configure_home_dns() {
    if ip link show eth0 >/dev/null 2>&1; then
        echo "é…ç½®å®¶åº­ç½‘ç»œDNS..."
        sudo resolvectl dns eth0 192.168.1.1
        sudo resolvectl domain eth0 ~home.lan
    fi
}

configure_mobile_dns() {
    if ip link show wlan0 >/dev/null 2>&1; then
        echo "é…ç½®ç§»åŠ¨ç½‘ç»œDNS..."
        sudo resolvectl dns wlan0 8.8.8.8 1.1.1.1
        sudo resolvectl domain wlan0 ~.
    fi
}

# æ‰§è¡Œé…ç½®
configure_vpn_dns
configure_home_dns  
configure_mobile_dns

echo "å¤šé“¾è·¯DNSé…ç½®å®Œæˆ"
resolvectl status
```

---

## 8. ğŸ“Š resolvedçŠ¶æ€æŸ¥è¯¢å‘½ä»¤


### 8.1 åŸºç¡€çŠ¶æ€æŸ¥è¯¢


```bash
# æŸ¥çœ‹systemd-resolvedæœåŠ¡çŠ¶æ€
sudo systemctl status systemd-resolved

# æŸ¥çœ‹å®Œæ•´DNSçŠ¶æ€
resolvectl status

# ç®€åŒ–çŠ¶æ€è¾“å‡º
resolvectl status --no-pager
```

### 8.2 è¯¦ç»†æŸ¥è¯¢å‘½ä»¤


#### DNSæŸ¥è¯¢æµ‹è¯•


```bash
# åŸºç¡€åŸŸåæŸ¥è¯¢
resolvectl query google.com

# æŒ‡å®šè®°å½•ç±»å‹æŸ¥è¯¢
resolvectl query google.com --type=MX
resolvectl query google.com --type=AAAA

# åå‘DNSæŸ¥è¯¢
resolvectl query 8.8.8.8

# æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
resolvectl query --legend=yes google.com
```

#### æœåŠ¡å™¨çŠ¶æ€æŸ¥è¯¢


```bash
# æŸ¥çœ‹DNSæœåŠ¡å™¨ç‰¹æ€§
resolvectl show-server

# é‡ç½®æœåŠ¡å™¨ç‰¹æ€§ç¼“å­˜
sudo resolvectl reset-server-features

# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
resolvectl statistics

# é‡ç½®ç»Ÿè®¡è®¡æ•°å™¨
sudo resolvectl reset-statistics
```

### 8.3 è°ƒè¯•ä¸æ•…éšœæ’é™¤å‘½ä»¤


```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
sudo systemctl edit systemd-resolved
```

```ini
[Service]
Environment=SYSTEMD_LOG_LEVEL=debug
```

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
sudo journalctl -u systemd-resolved -f

# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯æ—¥å¿—
sudo journalctl -u systemd-resolved --since "1 hour ago" -p err

# æµ‹è¯•DNSè§£æè·¯å¾„
resolvectl query --legend=yes --type=A example.com

# éªŒè¯DNSSECçŠ¶æ€
resolvectl query --legend=yes --type=DNSKEY cloudflare.com
```

### 8.4 å®ç”¨æŸ¥è¯¢è„šæœ¬


```bash
#!/bin/bash
# DNSçŠ¶æ€æ£€æŸ¥è„šæœ¬

echo "=== systemd-resolved çŠ¶æ€æ£€æŸ¥ ==="
echo

echo "ğŸ“¡ æœåŠ¡çŠ¶æ€ï¼š"
systemctl is-active systemd-resolved
echo

echo "ğŸŒ DNSé…ç½®æ¦‚è§ˆï¼š"
resolvectl status | head -20
echo

echo "ğŸ“Š ç¼“å­˜ç»Ÿè®¡ï¼š"
resolvectl statistics | grep -E "(Cache|Hit|Miss|Current)"
echo

echo "ğŸ” æµ‹è¯•å¸¸ç”¨åŸŸåè§£æï¼š"
for domain in google.com baidu.com github.com; do
    echo -n "$domain: "
    timeout 3 resolvectl query $domain --type=A | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -1
done
echo

echo "âœ… DNSæ£€æŸ¥å®Œæˆ"
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ systemd-resolvedï¼šç°ä»£Linuxç»Ÿä¸€DNSè§£ææœåŠ¡
ğŸ”¸ resolved.confï¼šä¸»é…ç½®æ–‡ä»¶ï¼Œæ§åˆ¶å…¨å±€DNSè¡Œä¸º
ğŸ”¸ åŸŸåè·¯ç”±ï¼šä¸åŒåŸŸåèµ°ä¸åŒDNSæœåŠ¡å™¨çš„æ™ºèƒ½åˆ†æµ
ğŸ”¸ DNSSECï¼šDNSå®‰å…¨æ‰©å±•ï¼ŒéªŒè¯DNSå“åº”çœŸå®æ€§
ğŸ”¸ å¤šé“¾è·¯DNSï¼šå¤šç½‘å¡ç¯å¢ƒä¸‹çš„DNSé…ç½®ç®¡ç†
ğŸ”¸ DNSç¼“å­˜ï¼šæé«˜è§£ææ€§èƒ½çš„æœ¬åœ°ç¼“å­˜æœºåˆ¶
```

### 9.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ åŸºç¡€é…ç½®æ€è·¯**
```
1ï¸âƒ£ ç¡®å®šDNSæœåŠ¡å™¨ï¼šé€‰æ‹©å¯é çš„DNSæä¾›å•†
2ï¸âƒ£ é…ç½®åŸŸåè·¯ç”±ï¼šå†…ç½‘åŸŸåèµ°å†…ç½‘DNSï¼Œå¤–ç½‘åŸŸåèµ°å…¬ç½‘DNS
3ï¸âƒ£ å¯ç”¨å®‰å…¨ç‰¹æ€§ï¼šå¼€å¯DNSSECå’ŒDoTæå‡å®‰å…¨æ€§
4ï¸âƒ£ ä¼˜åŒ–ç¼“å­˜è®¾ç½®ï¼šåˆç†é…ç½®ç¼“å­˜æå‡æ€§èƒ½
5ï¸âƒ£ ç›‘æ§è¿è¡ŒçŠ¶æ€ï¼šå®šæœŸæ£€æŸ¥DNSè§£ææ˜¯å¦æ­£å¸¸
```

**ğŸ”¹ æ•…éšœæ’é™¤æ­¥éª¤**
```
é—®é¢˜è¯Šæ–­æµç¨‹ï¼š
ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€ â†’ æŸ¥çœ‹é…ç½®æ–‡ä»¶ â†’ æµ‹è¯•DNSè§£æ â†’ æ£€æŸ¥ç½‘ç»œè¿æ¥
     â†“              â†“              â†“              â†“
systemctl status  resolved.conf   resolvectl     pingæµ‹è¯•
```

### 9.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ¯ ä¼ä¸šç½‘ç»œç¯å¢ƒ**
- **æ··åˆDNS**ï¼šå†…ç½‘åŸŸåç”¨å†…ç½‘DNSï¼Œå¤–ç½‘åŸŸåç”¨å…¬ç½‘DNS
- **å®‰å…¨åŠ å›º**ï¼šå¯ç”¨DNSSECéªŒè¯é˜²æ­¢DNSæ±¡æŸ“
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé…ç½®åˆé€‚çš„ç¼“å­˜ç­–ç•¥

**ğŸ  å®¶åº­ç½‘ç»œç¯å¢ƒ**  
- **ç®€åŒ–é…ç½®**ï¼šä½¿ç”¨è·¯ç”±å™¨DNSæˆ–å…¬å…±DNS
- **å¹¿å‘Šå±è”½**ï¼šä½¿ç”¨AdGuardç­‰è¿‡æ»¤DNS
- **å„¿ç«¥ä¿æŠ¤**ï¼šä½¿ç”¨å¸¦å†…å®¹è¿‡æ»¤çš„DNSæœåŠ¡

**ğŸ’» ç§»åŠ¨åŠå…¬ç¯å¢ƒ**
- **å¤šé“¾è·¯ç®¡ç†**ï¼šVPNã€WiFiã€ç§»åŠ¨ç½‘ç»œçš„DNSåˆ†æµ
- **è‡ªåŠ¨åˆ‡æ¢**ï¼šæ ¹æ®ç½‘ç»œç¯å¢ƒè‡ªåŠ¨é…ç½®DNS
- **æ•…éšœæ¢å¤**ï¼šDNSæ•…éšœæ—¶çš„è‡ªåŠ¨é™çº§æœºåˆ¶

### 9.4 æœ€ä½³å®è·µå»ºè®®


**âš¡ æ€§èƒ½ä¼˜åŒ–**
```
âœ… é€‰æ‹©å°±è¿‘çš„DNSæœåŠ¡å™¨ï¼ˆå»¶è¿Ÿ<50msï¼‰
âœ… å¯ç”¨DNSç¼“å­˜ï¼Œè®¾ç½®åˆç†çš„TTL
âœ… ä½¿ç”¨å¤šä¸ªDNSæœåŠ¡å™¨æä¾›å†—ä½™
âœ… å®šæœŸæ¸…ç†DNSç¼“å­˜é¿å…è¿‡æœŸè®°å½•
```

**ğŸ”’ å®‰å…¨å¢å¼º**
```
âœ… å¯ç”¨DNSSECéªŒè¯é˜²æ­¢DNSæ¬ºéª—
âœ… ä½¿ç”¨DNS over TLSåŠ å¯†DNSæŸ¥è¯¢
âœ… é¿å…ä½¿ç”¨ä¸å¯ä¿¡çš„å…¬å…±DNS
âœ… å®šæœŸæ£€æŸ¥DNSé…ç½®æ˜¯å¦è¢«ç¯¡æ”¹
```

**ğŸ› ï¸ è¿ç»´ç®¡ç†**
```
âœ… å»ºç«‹DNSç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
âœ… å¤‡ä»½å’Œç‰ˆæœ¬ç®¡ç†DNSé…ç½®æ–‡ä»¶
âœ… åˆ¶å®šDNSæ•…éšœåº”æ€¥å¤„ç†æµç¨‹
âœ… å®šæœŸæ›´æ–°å’Œç»´æŠ¤DNSæœåŠ¡å™¨åˆ—è¡¨
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- systemd-resolvedæ˜¯ç°ä»£Linuxçš„DNSç®¡ç†æ ¸å¿ƒ
- é€šè¿‡åŸŸåè·¯ç”±å®ç°æ™ºèƒ½DNSåˆ†æµ
- DNSSECå’ŒDoTæä¾›DNSå®‰å…¨ä¿éšœ
- åˆç†çš„ç¼“å­˜é…ç½®èƒ½æ˜¾è‘—æå‡æ€§èƒ½
- å¤šé“¾è·¯ç¯å¢ƒéœ€è¦ç²¾å¿ƒè§„åˆ’DNSç­–ç•¥