---
title: 13ã€ç‰¹æ®Šåœºæ™¯DNSé…ç½®
---
## ğŸ“š ç›®å½•

1. [ç¦»çº¿ç¯å¢ƒDNSé…ç½®](#1-ç¦»çº¿ç¯å¢ƒDNSé…ç½®)
2. [é«˜å®‰å…¨ç¯å¢ƒDNSéš”ç¦»](#2-é«˜å®‰å…¨ç¯å¢ƒDNSéš”ç¦»)
3. [å¼€å‘æµ‹è¯•ç¯å¢ƒDNSé…ç½®](#3-å¼€å‘æµ‹è¯•ç¯å¢ƒDNSé…ç½®)
4. [å®¹å™¨é›†ç¾¤DNSæœåŠ¡å‘ç°](#4-å®¹å™¨é›†ç¾¤DNSæœåŠ¡å‘ç°)
5. [Kubernetesé›†ç¾¤DNSé…ç½®](#5-Kubernetesé›†ç¾¤DNSé…ç½®)
6. [å¾®æœåŠ¡ç¯å¢ƒæœåŠ¡å‘ç°](#6-å¾®æœåŠ¡ç¯å¢ƒæœåŠ¡å‘ç°)
7. [è´Ÿè½½å‡è¡¡ç¯å¢ƒDNSé…ç½®](#7-è´Ÿè½½å‡è¡¡ç¯å¢ƒDNSé…ç½®)
8. [CDNç¯å¢ƒDNSä¼˜åŒ–é…ç½®](#8-CDNç¯å¢ƒDNSä¼˜åŒ–é…ç½®)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”ï¸ ç¦»çº¿ç¯å¢ƒDNSé…ç½®


### 1.1 ä»€ä¹ˆæ˜¯ç¦»çº¿ç¯å¢ƒ


**ç¦»çº¿ç¯å¢ƒçš„æœ¬è´¨**ï¼šæŒ‡æ— æ³•è¿æ¥åˆ°å¤–éƒ¨äº’è”ç½‘çš„å°é—­ç½‘ç»œç¯å¢ƒï¼Œå¸¸è§äºå†›å·¥ã€é‡‘èã€æ”¿åºœç­‰å¯¹å®‰å…¨è¦æ±‚æé«˜çš„åœºæ‰€ã€‚

```
åœ¨çº¿ç¯å¢ƒï¼š
å®¢æˆ·ç«¯ â†’ æœ¬åœ°DNS â†’ å…¬ç½‘DNS(8.8.8.8) â†’ äº’è”ç½‘åŸŸå
    â†“
ç¦»çº¿ç¯å¢ƒï¼š
å®¢æˆ·ç«¯ â†’ æœ¬åœ°DNS â†’ å†…éƒ¨æƒå¨DNS â†’ å†…éƒ¨åŸŸå
```

### 1.2 ç¦»çº¿DNSæ¶æ„è®¾è®¡


**ğŸ¯ æ ¸å¿ƒç»„ä»¶**

```
ç¦»çº¿DNSæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯ç¾¤ç»„  â”‚â”€â”€â”€â†’â”‚   å†…éƒ¨DNS    â”‚â”€â”€â”€â†’â”‚ æƒå¨åŸŸåæœåŠ¡â”‚
â”‚             â”‚    â”‚  è½¬å‘æœåŠ¡å™¨   â”‚    â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  æœ¬åœ°DNSç¼“å­˜ â”‚
                   â”‚   å­˜å‚¨æœåŠ¡   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ ä¸»è¦åŠŸèƒ½**
- **å†…éƒ¨åŸŸåè§£æ**ï¼šè§£æå†…éƒ¨æœåŠ¡å’Œèµ„æº
- **ç¼“å­˜ç®¡ç†**ï¼šç¼“å­˜å¸¸ç”¨åŸŸåé¿å…é‡å¤æŸ¥è¯¢
- **è½¬å‘æ§åˆ¶**ï¼šå†³å®šå“ªäº›æŸ¥è¯¢åœ¨å†…éƒ¨è§£æï¼Œå“ªäº›æ‹’ç»
- **å®‰å…¨éš”ç¦»**ï¼šç¡®ä¿æ— å¤–éƒ¨DNSæ³„éœ²

### 1.3 ç¦»çº¿DNSæœåŠ¡å™¨é…ç½®


**BIND9ç¦»çº¿é…ç½®ç¤ºä¾‹**

```bash
# /etc/named.conf - ä¸»é…ç½®æ–‡ä»¶
options {
    directory "/var/named";
    listen-on port 53 { any; };
    
    # å…³é”®ï¼šç¦ç”¨é€’å½’å’Œè½¬å‘
    recursion no;
    allow-query { 192.168.0.0/16; 10.0.0.0/8; };
    
    # ç¦æ­¢å¤–éƒ¨æŸ¥è¯¢
    forwarders { };
    forward only;
    
    # å®‰å…¨è®¾ç½®
    version "unknown";
    hostname "unknown";
};

# å†…éƒ¨åŸŸé…ç½®
zone "company.local" IN {
    type master;
    file "company.local.zone";
    allow-update { none; };
};

# åå‘è§£æ
zone "168.192.in-addr.arpa" IN {
    type master;
    file "192.168.rev";
};
```

**å†…éƒ¨åŸŸååŒºåŸŸæ–‡ä»¶**

```bash
# /var/named/company.local.zone
$TTL 86400
@   IN  SOA ns1.company.local. admin.company.local. (
        2024091501  ; serial
        3600        ; refresh
        1800        ; retry
        604800      ; expire
        86400       ; minimum
        )

        IN  NS  ns1.company.local.
        IN  NS  ns2.company.local.

ns1     IN  A   192.168.1.10
ns2     IN  A   192.168.1.11
web     IN  A   192.168.1.20
db      IN  A   192.168.1.30
mail    IN  A   192.168.1.40

# æœåŠ¡è®°å½•
ftp     IN  CNAME web.company.local.
www     IN  CNAME web.company.local.
```

### 1.4 ç¦»çº¿ç¯å¢ƒç‰¹æ®Šè€ƒè™‘


**ğŸ”¸ åŸŸåè§„åˆ’ç­–ç•¥**
- ä½¿ç”¨ `.local`ã€`.internal`ã€`.corp` ç­‰ç§æœ‰åŸŸå
- é¿å…ä¸å…¬ç½‘åŸŸåå†²çª
- å»ºç«‹æ¸…æ™°çš„å‘½åè§„èŒƒ

**ğŸ”¸ æ—¶é—´åŒæ­¥é—®é¢˜**
```bash
# ç¦»çº¿ç¯å¢ƒéœ€è¦å†…éƒ¨æ—¶é—´æœåŠ¡å™¨
# /etc/ntp.conf
server 192.168.1.100 prefer
server 192.168.1.101

# ç¦ç”¨å¤–éƒ¨æ—¶é—´æº
restrict default kod nomodify notrap nopeer noquery
```

**ğŸ”¸ è¯ä¹¦ç®¡ç†**
- å»ºç«‹å†…éƒ¨CAè¯ä¹¦é¢å‘æœºæ„
- ä¸ºå†…éƒ¨åŸŸåç­¾å‘SSLè¯ä¹¦
- ç»´æŠ¤è¯ä¹¦ä¿¡ä»»é“¾

---

## 2. ğŸ”’ é«˜å®‰å…¨ç¯å¢ƒDNSéš”ç¦»


### 2.1 DNSéš”ç¦»çš„æ ¸å¿ƒæ€æƒ³


**ä»€ä¹ˆæ˜¯DNSéš”ç¦»**ï¼šé€šè¿‡æŠ€æœ¯æ‰‹æ®µå°†ä¸åŒå®‰å…¨çº§åˆ«çš„ç½‘ç»œåŒºåŸŸçš„DNSæŸ¥è¯¢å®Œå…¨åˆ†ç¦»ï¼Œé˜²æ­¢ä¿¡æ¯æ³„éœ²å’Œæ”»å‡»ã€‚

```
å¤šå±‚å®‰å…¨æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å…¬ç½‘åŒºåŸŸ   â”‚    â”‚   DMZåŒºåŸŸ    â”‚    â”‚   å†…ç½‘åŒºåŸŸ   â”‚
â”‚  DNS: å…¬ç½‘   â”‚    â”‚  DNS: å—æ§   â”‚    â”‚  DNS: éš”ç¦»   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚                     â”‚
       â–¼                     â–¼                     â–¼
  ä¸åŒDNSæœåŠ¡å™¨         ç‹¬ç«‹DNSæœåŠ¡å™¨        å®Œå…¨éš”ç¦»DNS
```

### 2.2 å®‰å…¨éš”ç¦»ç­–ç•¥


**ğŸ”¸ åˆ†çº§DNSè§£æ**

| å®‰å…¨çº§åˆ« | **DNSç­–ç•¥** | **å¯è§£æåŸŸå** | **é˜²æŠ¤æªæ–½** |
|---------|------------|----------------|--------------|
| ğŸ”´ **ç»å¯†** | `å®Œå…¨éš”ç¦»` | `ä»…å†…éƒ¨åŸŸå` | `ç‰©ç†éš”ç¦»ï¼Œä¸“ç”¨DNS` |
| ğŸŸ¡ **æœºå¯†** | `å—æ§è§£æ` | `å†…éƒ¨+æŒ‡å®šå¤–éƒ¨` | `ç™½åå•è¿‡æ»¤` |
| ğŸŸ¢ **ä¸€èˆ¬** | `æ ‡å‡†è§£æ` | `å¤§éƒ¨åˆ†å…¬ç½‘åŸŸå` | `é»‘åå•è¿‡æ»¤` |
| ğŸ”µ **å…¬å¼€** | `å…¨å¼€æ”¾` | `æ‰€æœ‰å…¬ç½‘åŸŸå` | `åŸºç¡€å®‰å…¨ç­–ç•¥` |

**ğŸ”¸ DNSæŸ¥è¯¢è¿‡æ»¤é…ç½®**

```bash
# ä½¿ç”¨dnsmasqå®ç°æŸ¥è¯¢è¿‡æ»¤
# /etc/dnsmasq.conf

# ç™½åå•æ¨¡å¼ - åªå…è®¸ç‰¹å®šåŸŸå
address=/trusted-partner.com/192.168.100.10
address=/approved-vendor.com/192.168.100.20

# é»‘åå•æ¨¡å¼ - ç¦æ­¢ç‰¹å®šåŸŸå
address=/malicious-site.com/127.0.0.1
address=/blocked-domain.com/0.0.0.0

# åˆ†ç±»å¤„ç†
server=/internal.company.com/192.168.1.10
server=/external-allowed.com/8.8.8.8
```

### 2.3 DNSé˜²æ³„éœ²æŠ€æœ¯


**ğŸ”¸ æŸ¥è¯¢ç›‘æ§ä¸å®¡è®¡**

```bash
# å¯ç”¨DNSæŸ¥è¯¢æ—¥å¿—
# /etc/named.conf
logging {
    channel query_log {
        file "/var/log/named/query.log" versions 3 size 100m;
        severity info;
        print-category yes;
        print-severity yes;
        print-time yes;
    };
    category queries { query_log; };
};
```

**ğŸ”¸ DNS over HTTPS (DoH) é˜»æ–­**

```bash
# é˜»æ–­å¸¸è§DoHæœåŠ¡
iptables -A OUTPUT -d 1.1.1.1 -p tcp --dport 443 -j DROP
iptables -A OUTPUT -d 8.8.8.8 -p tcp --dport 443 -j DROP
iptables -A OUTPUT -d 208.67.222.222 -p tcp --dport 443 -j DROP

# ç›‘æ§DNS over TLS
iptables -A OUTPUT -p tcp --dport 853 -j LOG --log-prefix "DNS-TLS: "
```

### 2.4 å®‰å…¨DNSé…ç½®æœ€ä½³å®è·µ


**ğŸ”¸ è®¿é—®æ§åˆ¶åˆ—è¡¨**
```bash
# ä¸¥æ ¼çš„ACLé…ç½®
acl "internal_networks" {
    192.168.0.0/16;
    10.0.0.0/8;
    172.16.0.0/12;
};

acl "secure_servers" {
    192.168.1.10;    # å®‰å…¨DNSæœåŠ¡å™¨1
    192.168.1.11;    # å®‰å…¨DNSæœåŠ¡å™¨2
};

options {
    allow-query { internal_networks; };
    allow-recursion { internal_networks; };
    allow-transfer { secure_servers; };
    blackhole { bogon_networks; };
};
```

---

## 3. ğŸ› ï¸ å¼€å‘æµ‹è¯•ç¯å¢ƒDNSé…ç½®


### 3.1 å¼€å‘ç¯å¢ƒDNSéœ€æ±‚ç‰¹ç‚¹


**ä¸ºä»€ä¹ˆéœ€è¦ç‰¹æ®Šé…ç½®**ï¼šå¼€å‘æµ‹è¯•ç¯å¢ƒç»å¸¸éœ€è¦æ¨¡æ‹Ÿä¸åŒçš„ç½‘ç»œæ¡ä»¶ã€æµ‹è¯•å¤šä¸ªç‰ˆæœ¬çš„æœåŠ¡ï¼Œä»¥åŠå¿«é€Ÿåˆ‡æ¢ä¸åŒçš„åç«¯æœåŠ¡ã€‚

```
å¼€å‘ç¯å¢ƒå…¸å‹åœºæ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æœ¬åœ°å¼€å‘   â”‚    â”‚   æµ‹è¯•ç¯å¢ƒ   â”‚    â”‚   é¢„å‘ç¯å¢ƒ   â”‚
â”‚  localhost  â”‚    â”‚ test.app.comâ”‚    â”‚stage.app.comâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â–¼                   â–¼                   â–¼
   æœ¬åœ°DNSè§£æ        æµ‹è¯•DNSæœåŠ¡å™¨      é¢„å‘DNSæœåŠ¡å™¨
```

### 3.2 æœ¬åœ°å¼€å‘DNSé…ç½®


**ğŸ”¸ /etc/hostsæ–‡ä»¶ç®¡ç†**

```bash
# å¼€å‘ç¯å¢ƒhostsé…ç½®ç¤ºä¾‹
# /etc/hosts

# æœ¬åœ°å¼€å‘æœåŠ¡
127.0.0.1 api.dev.local
127.0.0.1 web.dev.local
127.0.0.1 db.dev.local

# æµ‹è¯•ç¯å¢ƒæ˜ å°„
192.168.10.100 api.test.com
192.168.10.101 web.test.com
192.168.10.102 db.test.com

# é¢„å‘ç¯å¢ƒæ˜ å°„
10.0.1.100 api.staging.com
10.0.1.101 web.staging.com
```

**ğŸ”¸ dnsmasqå¼€å‘é…ç½®**

```bash
# /etc/dnsmasq.conf - å¼€å‘è€…å‹å¥½é…ç½®
# ç›‘å¬æ‰€æœ‰æ¥å£
interface=lo,eth0

# å¼€å‘åŸŸåè§£æ
address=/dev.local/127.0.0.1
address=/test.local/192.168.10.0

# é€šé…ç¬¦æ”¯æŒ - æ‰€æœ‰*.devåŸŸåæŒ‡å‘æœ¬åœ°
address=/.dev/127.0.0.1

# åŠ¨æ€è§£ææµ‹è¯•æœåŠ¡
txt-record=_service._tcp.test.local,"version=1.0,port=8080"
srv-host=_http._tcp.test.local,web.test.local,8080,10,5
```

### 3.3 æµ‹è¯•ç¯å¢ƒDNSæœåŠ¡å‘ç°


**ğŸ”¸ æœåŠ¡æ³¨å†Œä¸å‘ç°**

> ğŸ’¡ **æ¦‚å¿µè¯´æ˜**: æœåŠ¡å‘ç°æ˜¯æŒ‡æœåŠ¡ä¹‹é—´è‡ªåŠ¨æ‰¾åˆ°å½¼æ­¤çš„æœºåˆ¶ï¼Œåœ¨æµ‹è¯•ç¯å¢ƒä¸­ç‰¹åˆ«é‡è¦ï¼Œå› ä¸ºæœåŠ¡åœ°å€å¯èƒ½ç»å¸¸å˜åŒ–ã€‚

```bash
# ä½¿ç”¨Consulä½œä¸ºæœåŠ¡å‘ç°
# consulé…ç½®æ–‡ä»¶
{
  "datacenter": "test-dc",
  "data_dir": "/opt/consul",
  "log_level": "INFO",
  "server": true,
  "bootstrap_expect": 1,
  "bind_addr": "192.168.10.10",
  "client_addr": "0.0.0.0",
  "ui_config": {
    "enabled": true
  },
  "dns_config": {
    "enable_truncate": true
  }
}
```

**ğŸ”¸ åŠ¨æ€DNSæ›´æ–°**

```bash
# è‡ªåŠ¨æ³¨å†Œè„šæœ¬
#!/bin/bash
SERVICE_NAME="web-service"
SERVICE_IP=$(hostname -I | awk '{print $1}')
SERVICE_PORT=8080

# æ³¨å†ŒæœåŠ¡åˆ°Consul
curl -X PUT http://consul.test.local:8500/v1/agent/service/register \
  -d '{
    "ID": "'$SERVICE_NAME'-'$SERVICE_IP'",
    "Name": "'$SERVICE_NAME'",
    "Address": "'$SERVICE_IP'",
    "Port": '$SERVICE_PORT',
    "Check": {
      "HTTP": "http://'$SERVICE_IP':'$SERVICE_PORT'/health",
      "Interval": "10s"
    }
  }'
```

### 3.4 å¤šç¯å¢ƒDNSåˆ‡æ¢


**ğŸ”¸ ç¯å¢ƒåˆ‡æ¢è„šæœ¬**

```bash
#!/bin/bash
# switch-env.sh - ç¯å¢ƒåˆ‡æ¢å·¥å…·

ENV=$1
case $ENV in
  "dev")
    echo "åˆ‡æ¢åˆ°å¼€å‘ç¯å¢ƒ..."
    cp /etc/resolv.conf.dev /etc/resolv.conf
    echo "nameserver 127.0.0.1" > /etc/resolv.conf
    ;;
  "test")
    echo "åˆ‡æ¢åˆ°æµ‹è¯•ç¯å¢ƒ..."
    echo "nameserver 192.168.10.10" > /etc/resolv.conf
    echo "search test.local" >> /etc/resolv.conf
    ;;
  "staging")
    echo "åˆ‡æ¢åˆ°é¢„å‘ç¯å¢ƒ..."
    echo "nameserver 10.0.1.10" > /etc/resolv.conf
    echo "search staging.local" >> /etc/resolv.conf
    ;;
  *)
    echo "ç”¨æ³•: $0 {dev|test|staging}"
    exit 1
    ;;
esac

echo "å½“å‰DNSé…ç½®:"
cat /etc/resolv.conf
```

---

## 4. ğŸ³ å®¹å™¨é›†ç¾¤DNSæœåŠ¡å‘ç°


### 4.1 å®¹å™¨DNSçš„ç‰¹æ®Šæ€§


**ä¸ºä»€ä¹ˆå®¹å™¨éœ€è¦ç‰¹æ®ŠDNSé…ç½®**ï¼šå®¹å™¨ç¯å¢ƒä¸­ï¼ŒæœåŠ¡å®ä¾‹åŠ¨æ€åˆ›å»ºå’Œé”€æ¯ï¼ŒIPåœ°å€ç»å¸¸å˜åŒ–ï¼Œä¼ ç»Ÿçš„é™æ€DNSé…ç½®æ— æ³•æ»¡è¶³éœ€æ±‚ã€‚

```
ä¼ ç»Ÿç¯å¢ƒ vs å®¹å™¨ç¯å¢ƒï¼š

ä¼ ç»Ÿç¯å¢ƒï¼š
web1.company.com â†’ 192.168.1.100 (å›ºå®šIPï¼Œå¾ˆå°‘å˜åŒ–)

å®¹å™¨ç¯å¢ƒï¼š
web-service â†’ 172.17.0.5, 172.17.0.8, 172.17.0.12 (åŠ¨æ€IPï¼Œéšæ—¶å˜åŒ–)
            â†“
          éœ€è¦åŠ¨æ€DNSè§£æ
```

### 4.2 Docker DNSæœºåˆ¶


**ğŸ”¸ Dockerå†…ç½®DNSæœåŠ¡**

```bash
# Dockeråˆ›å»ºç½‘ç»œæ—¶è‡ªåŠ¨é…ç½®DNS
docker network create --driver bridge mynetwork

# å®¹å™¨é—´é€šè¿‡æœåŠ¡åé€šä¿¡
docker run -d --name web-server --network mynetwork nginx
docker run -d --name app-server --network mynetwork myapp

# åœ¨app-serverä¸­å¯ä»¥ç›´æ¥è®¿é—® http://web-server
```

**ğŸ”¸ Docker Compose DNSé…ç½®**

```yaml
# docker-compose.yml
version: '3.8'
services:
  web:
    image: nginx
    container_name: web-server
    networks:
      - app-network
    dns:
      - 8.8.8.8
      - 1.1.1.1
    dns_search:
      - company.local
    extra_hosts:
      - "api.external.com:192.168.1.100"

  app:
    image: myapp
    container_name: app-server
    networks:
      - app-network
    depends_on:
      - web

networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### 4.3 å®¹å™¨æœåŠ¡å‘ç°æ–¹æ¡ˆ


**ğŸ”¸ åŸºäºç¯å¢ƒå˜é‡çš„æœåŠ¡å‘ç°**

> âš ï¸ **æ³¨æ„**: ç¯å¢ƒå˜é‡æ–¹å¼é€‚åˆç®€å•åœºæ™¯ï¼Œä½†ä¸æ”¯æŒåŠ¨æ€æ‰©ç¼©å®¹ã€‚

```bash
# Docker linkæ–¹å¼ï¼ˆå·²åºŸå¼ƒï¼Œä½†ç†è§£åŸç†ï¼‰
docker run -d --name database mysql
docker run -d --name webapp --link database:db webapp

# åœ¨webappå®¹å™¨ä¸­è‡ªåŠ¨ç”Ÿæˆï¼š
# DB_PORT_3306_TCP_ADDR=172.17.0.2
# DB_PORT_3306_TCP_PORT=3306
```

**ğŸ”¸ åŸºäºDNSçš„æœåŠ¡å‘ç°**

```bash
# ä½¿ç”¨å¤–éƒ¨DNSæœåŠ¡
docker run -d \
  --name consul \
  -p 8500:8500 \
  consul agent -dev -client 0.0.0.0

# é…ç½®å®¹å™¨ä½¿ç”¨Consul DNS
docker run -d \
  --name webapp \
  --dns=172.17.0.2 \
  --dns-search=service.consul \
  webapp
```

### 4.4 Docker Swarmé›†ç¾¤DNS


**ğŸ”¸ SwarmæœåŠ¡å‘ç°**

```bash
# åˆ›å»ºSwarmé›†ç¾¤
docker swarm init --advertise-addr 192.168.1.100

# åˆ›å»ºoverlayç½‘ç»œ
docker network create -d overlay --attachable myoverlay

# éƒ¨ç½²æœåŠ¡
docker service create \
  --name web \
  --network myoverlay \
  --replicas 3 \
  nginx

# æœåŠ¡é—´é€šä¿¡é€šè¿‡æœåŠ¡å
docker service create \
  --name app \
  --network myoverlay \
  myapp
```

**Swarm DNSè§£ææµç¨‹**ï¼š

```
å®¢æˆ·ç«¯è¯·æ±‚ web
      â†“
Swarmå†…ç½®DNSè§£æå™¨
      â†“
è¿”å›æ‰€æœ‰webæœåŠ¡å®ä¾‹IP
      â†“
å®¢æˆ·ç«¯é€‰æ‹©ä¸€ä¸ªIPè¿›è¡Œè¿æ¥
```

---

## 5. â˜¸ï¸ Kubernetesé›†ç¾¤DNSé…ç½®


### 5.1 Kubernetes DNSæ¶æ„


**CoreDNSåœ¨K8sä¸­çš„ä½œç”¨**ï¼šKubernetesä½¿ç”¨CoreDNSä½œä¸ºé›†ç¾¤DNSï¼Œä¸ºPodå’ŒServiceæä¾›åŸŸåè§£ææœåŠ¡ã€‚

```
Kubernetes DNSæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Pod     â”‚â”€â”€â”€â†’â”‚   CoreDNS   â”‚â”€â”€â”€â†’â”‚   Service   â”‚
â”‚             â”‚    â”‚   (DNSæœåŠ¡)  â”‚    â”‚   (åç«¯Pod)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  Kubernetes â”‚
                   â”‚    API      â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Kubernetes DNSå‘½åè§„èŒƒ


**ğŸ”¸ DNSå‘½åçº¦å®š**

| èµ„æºç±»å‹ | **DNSæ ¼å¼** | **ç¤ºä¾‹** |
|---------|------------|----------|
| **Service** | `<service>.<namespace>.svc.cluster.local` | `web.default.svc.cluster.local` |
| **Pod** | `<pod-ip>.<namespace>.pod.cluster.local` | `172-17-0-3.default.pod.cluster.local` |
| **Headless Service** | `<pod-name>.<service>.<namespace>.svc.cluster.local` | `web-0.nginx.default.svc.cluster.local` |

**ğŸ”¸ å®é™…ä½¿ç”¨ç¤ºä¾‹**

```yaml
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: web-service
  namespace: production
spec:
  selector:
    app: web
  ports:
  - port: 80
    targetPort: 8080
```

```bash
# åœ¨åŒå‘½åç©ºé—´Podä¸­å¯ä»¥ä½¿ç”¨ï¼š
curl http://web-service
curl http://web-service.production
curl http://web-service.production.svc.cluster.local

# åœ¨ä¸åŒå‘½åç©ºé—´Podä¸­å¿…é¡»ä½¿ç”¨å®Œæ•´åŸŸåï¼š
curl http://web-service.production.svc.cluster.local
```

### 5.3 CoreDNSé…ç½®è¯¦è§£


**ğŸ”¸ CoreDNS ConfigMapé…ç½®**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
data:
  Corefile: |
    .:53 {
        errors
        health {
            lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
            pods insecure
            fallthrough in-addr.arpa ip6.arpa
            ttl 30
        }
        prometheus :9153
        forward . /etc/resolv.conf {
            max_concurrent 1000
        }
        cache 30
        loop
        reload
        loadbalance
    }
```

**ğŸ”¸ è‡ªå®šä¹‰åŸŸåè§£æ**

```yaml
# æ·»åŠ è‡ªå®šä¹‰åŸŸåè§£æ
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
data:
  Corefile: |
    .:53 {
        # ... å…¶ä»–é…ç½® ...
        
        # è‡ªå®šä¹‰åŸŸå
        hosts {
            192.168.1.100 external-api.company.com
            192.168.1.101 legacy-system.company.com
            fallthrough
        }
        
        # æ¡ä»¶è½¬å‘
        forward company.local 192.168.1.10
        
        # ... å…¶ä»–é…ç½® ...
    }
```

### 5.4 K8s DNSæ•…éšœæ’æŸ¥


**ğŸ”¸ å¸¸è§DNSé—®é¢˜è¯Šæ–­**

```bash
# 1. æ£€æŸ¥CoreDNS PodçŠ¶æ€
kubectl get pods -n kube-system -l k8s-app=kube-dns

# 2. æŸ¥çœ‹CoreDNSæ—¥å¿—
kubectl logs -n kube-system -l k8s-app=kube-dns

# 3. æµ‹è¯•DNSè§£æ
kubectl run -it --rm debug --image=busybox --restart=Never -- nslookup kubernetes.default

# 4. æ£€æŸ¥DNSé…ç½®
kubectl exec -it <pod-name> -- cat /etc/resolv.conf
```

**ğŸ”¸ DNSæ€§èƒ½ä¼˜åŒ–**

```yaml
# ä¼˜åŒ–CoreDNSé…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
data:
  Corefile: |
    .:53 {
        # å¢åŠ ç¼“å­˜æ—¶é—´
        cache 300
        
        # å¯ç”¨è´Ÿç¼“å­˜
        cache 30 {
            denial 9984 30
        }
        
        # è°ƒæ•´å¹¶å‘æ•°
        forward . /etc/resolv.conf {
            max_concurrent 1000
        }
        
        # å…¶ä»–é…ç½®...
    }
```

---

## 6. ğŸ”„ å¾®æœåŠ¡ç¯å¢ƒæœåŠ¡å‘ç°


### 6.1 å¾®æœåŠ¡DNSéœ€æ±‚åˆ†æ


**å¾®æœåŠ¡æ¶æ„çš„æŒ‘æˆ˜**ï¼šåœ¨å¾®æœåŠ¡ç¯å¢ƒä¸­ï¼ŒæœåŠ¡æ•°é‡å¤šã€éƒ¨ç½²é¢‘ç¹ã€ä½ç½®åŠ¨æ€å˜åŒ–ï¼Œä¼ ç»ŸDNSæ— æ³•å¾ˆå¥½åœ°æ”¯æŒè¿™ç§åŠ¨æ€æ€§ã€‚

```
å•ä½“åº”ç”¨ vs å¾®æœåŠ¡DNSéœ€æ±‚ï¼š

å•ä½“åº”ç”¨ï¼š
app.company.com â†’ 192.168.1.100 (ä¸€ä¸ªIPï¼Œå¾ˆå°‘å˜åŒ–)

å¾®æœåŠ¡ï¼š
user-service     â†’ å¤šä¸ªå®ä¾‹ï¼ŒåŠ¨æ€IP
order-service    â†’ å¤šä¸ªå®ä¾‹ï¼ŒåŠ¨æ€IP  
payment-service  â†’ å¤šä¸ªå®ä¾‹ï¼ŒåŠ¨æ€IP
catalog-service  â†’ å¤šä¸ªå®ä¾‹ï¼ŒåŠ¨æ€IP
```

### 6.2 æœåŠ¡æ³¨å†Œä¸­å¿ƒæ–¹æ¡ˆ


**ğŸ”¸ ConsulæœåŠ¡å‘ç°**

> ğŸ’¡ **æ¦‚å¿µè¯´æ˜**: Consulæ˜¯ä¸€ä¸ªæœåŠ¡ç½‘æ ¼è§£å†³æ–¹æ¡ˆï¼Œæä¾›æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’Œå®‰å…¨è¿æ¥ç­‰åŠŸèƒ½ã€‚

```bash
# Consul Agenté…ç½®
{
  "datacenter": "dc1",
  "data_dir": "/opt/consul",
  "log_level": "INFO",
  "server": true,
  "bootstrap_expect": 3,
  "bind_addr": "192.168.1.10",
  "client_addr": "0.0.0.0",
  "retry_join": ["192.168.1.11", "192.168.1.12"],
  "ui_config": {
    "enabled": true
  },
  "connect": {
    "enabled": true
  },
  "ports": {
    "grpc": 8502
  }
}
```

**ğŸ”¸ æœåŠ¡æ³¨å†Œç¤ºä¾‹**

```bash
# æ³¨å†ŒæœåŠ¡åˆ°Consul
curl -X PUT http://localhost:8500/v1/agent/service/register \
  -d '{
    "ID": "user-service-1",
    "Name": "user-service",
    "Tags": ["v1.0", "primary"],
    "Address": "192.168.1.100",
    "Port": 8080,
    "Meta": {
      "version": "1.0.0",
      "environment": "production"
    },
    "Check": {
      "HTTP": "http://192.168.1.100:8080/health",
      "Interval": "10s",
      "Timeout": "3s"
    }
  }'
```

### 6.3 DNSé›†æˆæœåŠ¡å‘ç°


**ğŸ”¸ Consul DNSæ¥å£**

```bash
# æŸ¥è¯¢æœåŠ¡å®ä¾‹
dig @localhost -p 8600 user-service.service.consul

# æŸ¥è¯¢å¸¦æ ‡ç­¾çš„æœåŠ¡
dig @localhost -p 8600 primary.user-service.service.consul

# æŸ¥è¯¢SRVè®°å½•
dig @localhost -p 8600 user-service.service.consul SRV
```

**ğŸ”¸ é…ç½®ç³»ç»ŸDNSä½¿ç”¨Consul**

```bash
# /etc/systemd/resolved.conf
[Resolve]
DNS=127.0.0.1:8600
Domains=~consul
```

```bash
# æˆ–è€…é…ç½®dnsmasqè½¬å‘
# /etc/dnsmasq.conf
server=/consul/127.0.0.1#8600
```

### 6.4 å¾®æœåŠ¡DNSæœ€ä½³å®è·µ


**ğŸ”¸ æœåŠ¡å‘½åè§„èŒƒ**

```
æœåŠ¡DNSå‘½åè§„èŒƒï¼š
â”œâ”€â”€ æœåŠ¡åç§°ï¼šuser-service
â”œâ”€â”€ ç¯å¢ƒæ ‡è¯†ï¼šuser-service.prod
â”œâ”€â”€ ç‰ˆæœ¬æ ‡è¯†ï¼šv2.user-service.prod
â””â”€â”€ åŒºåŸŸæ ‡è¯†ï¼šuser-service.prod.us-west
```

**ğŸ”¸ å¥åº·æ£€æŸ¥é…ç½®**

```json
{
  "service": {
    "name": "api-gateway",
    "port": 8080,
    "check": {
      "http": "http://localhost:8080/health",
      "interval": "10s",
      "timeout": "3s",
      "deregister_critical_service_after": "60s"
    }
  }
}
```

**ğŸ”¸ è´Ÿè½½å‡è¡¡DNSé…ç½®**

```bash
# é…ç½®å¤šä¸ªAè®°å½•å®ç°è´Ÿè½½å‡è¡¡
user-service.company.local. 300 IN A 192.168.1.100
user-service.company.local. 300 IN A 192.168.1.101
user-service.company.local. 300 IN A 192.168.1.102
```

---

## 7. âš–ï¸ è´Ÿè½½å‡è¡¡ç¯å¢ƒDNSé…ç½®


### 7.1 DNSè´Ÿè½½å‡è¡¡åŸç†


**ä»€ä¹ˆæ˜¯DNSè´Ÿè½½å‡è¡¡**ï¼šé€šè¿‡DNSæœåŠ¡å™¨è¿”å›ä¸åŒçš„IPåœ°å€ï¼Œå°†å®¢æˆ·ç«¯è¯·æ±‚åˆ†æ•£åˆ°å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œå®ç°è´Ÿè½½åˆ†æ‹…ã€‚

```
DNSè´Ÿè½½å‡è¡¡æµç¨‹ï¼š
å®¢æˆ·ç«¯æŸ¥è¯¢ web.company.com
          â†“
DNSæœåŠ¡å™¨è½®è¯¢è¿”å›ï¼š
â”Œâ”€ 192.168.1.100 (30%)
â”œâ”€ 192.168.1.101 (30%)  
â”œâ”€ 192.168.1.102 (30%)
â””â”€ 192.168.1.103 (10%) [å¤‡ä»½æœåŠ¡å™¨]
```

### 7.2 BIND DNSè´Ÿè½½å‡è¡¡é…ç½®


**ğŸ”¸ åŸºäºæƒé‡çš„è´Ÿè½½å‡è¡¡**

```bash
# /var/named/example.com.zone
$TTL 300
@   IN  SOA ns1.example.com. admin.example.com. (
        2024091501  ; serial
        3600        ; refresh
        1800        ; retry
        604800      ; expire
        300         ; minimum TTL - é‡è¦ï¼šçŸ­TTLæ”¯æŒå¿«é€Ÿåˆ‡æ¢
        )

        IN  NS  ns1.example.com.
        IN  NS  ns2.example.com.

# è´Ÿè½½å‡è¡¡é…ç½® - å¤šä¸ªAè®°å½•
web     IN  A   192.168.1.100   ; ä¸»æœåŠ¡å™¨1
web     IN  A   192.168.1.101   ; ä¸»æœåŠ¡å™¨2
web     IN  A   192.168.1.102   ; ä¸»æœåŠ¡å™¨3

# SRVè®°å½•è´Ÿè½½å‡è¡¡
_http._tcp  IN  SRV 10 60 80 web1.example.com.
_http._tcp  IN  SRV 10 30 80 web2.example.com.
_http._tcp  IN  SRV 20 10 80 web3.example.com.
```

**ğŸ”¸ åœ°ç†ä½ç½®è´Ÿè½½å‡è¡¡**

```bash
# ä½¿ç”¨BIND viewså®ç°åœ°ç†è´Ÿè½½å‡è¡¡
# /etc/named.conf

acl "asia_clients" {
    202.96.0.0/16;      # ä¸­å›½ç”µä¿¡
    61.144.0.0/16;      # ä¸­å›½è”é€š
};

acl "us_clients" {
    8.0.0.0/8;          # ç¾å›½IPæ®µ
    12.0.0.0/8;
};

view "asia" {
    match-clients { asia_clients; };
    zone "example.com" {
        type master;
        file "example.com.asia";
    };
};

view "us" {
    match-clients { us_clients; };
    zone "example.com" {
        type master;
        file "example.com.us";
    };
};
```

### 7.3 å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§»


**ğŸ”¸ DNSå¥åº·æ£€æŸ¥è„šæœ¬**

```bash
#!/bin/bash
# dns-health-check.sh

ZONE_FILE="/var/named/example.com.zone"
TEMP_FILE="/tmp/zone.tmp"
SERVERS=("192.168.1.100" "192.168.1.101" "192.168.1.102")

# æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€
check_server() {
    local server=$1
    # HTTPå¥åº·æ£€æŸ¥
    if curl -f -s --max-time 5 http://$server/health > /dev/null; then
        return 0
    else
        return 1
    fi
}

# ç”Ÿæˆæ–°çš„zoneæ–‡ä»¶
generate_zone() {
    cat > $TEMP_FILE << EOF
\$TTL 60
@   IN  SOA ns1.example.com. admin.example.com. (
        $(date +%Y%m%d%H)  ; serial
        3600        ; refresh
        1800        ; retry
        604800      ; expire
        60          ; minimum
        )

        IN  NS  ns1.example.com.
EOF

    # åªæ·»åŠ å¥åº·çš„æœåŠ¡å™¨
    for server in "${SERVERS[@]}"; do
        if check_server $server; then
            echo "web     IN  A   $server" >> $TEMP_FILE
            echo "æœåŠ¡å™¨ $server å¥åº·ï¼Œå·²æ·»åŠ åˆ°DNS"
        else
            echo "æœåŠ¡å™¨ $server ä¸å¥åº·ï¼Œå·²ä»DNSç§»é™¤"
        fi
    done
}

# æ‰§è¡Œæ£€æŸ¥å¹¶æ›´æ–°
generate_zone
if [ -s $TEMP_FILE ]; then
    mv $TEMP_FILE $ZONE_FILE
    rndc reload
    echo "DNSè®°å½•å·²æ›´æ–°"
else
    echo "é”™è¯¯ï¼šæ²¡æœ‰å¥åº·çš„æœåŠ¡å™¨"
fi
```

### 7.4 DNSä¸ç¡¬ä»¶è´Ÿè½½å‡è¡¡ç»“åˆ


**ğŸ”¸ DNS + LVSæ¶æ„**

```
åˆ†å±‚è´Ÿè½½å‡è¡¡æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DNSè½®è¯¢    â”‚ â† åœ°ç†ä½ç½®è´Ÿè½½å‡è¡¡
â”‚  (å…¨å±€è´Ÿè½½)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LVSè´Ÿè½½    â”‚ â† ä¼šè¯ä¿æŒ+å¥åº·æ£€æŸ¥
â”‚  (æœ¬åœ°è´Ÿè½½)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  çœŸå®æœåŠ¡å™¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ é…ç½®ç¤ºä¾‹**

```bash
# DNSé…ç½® - è¿”å›LVS VIPåœ°å€
web.example.com.     300  IN  A  192.168.1.10   ; LVS VIP 1
web.example.com.     300  IN  A  192.168.1.11   ; LVS VIP 2

# LVSé…ç½®
ipvsadm -A -t 192.168.1.10:80 -s wrr
ipvsadm -a -t 192.168.1.10:80 -r 192.168.1.100:80 -g -w 3
ipvsadm -a -t 192.168.1.10:80 -r 192.168.1.101:80 -g -w 2
ipvsadm -a -t 192.168.1.10:80 -r 192.168.1.102:80 -g -w 1
```

---

## 8. ğŸŒ CDNç¯å¢ƒDNSä¼˜åŒ–é…ç½®


### 8.1 CDN DNSå·¥ä½œåŸç†


**CDNå¦‚ä½•åˆ©ç”¨DNS**ï¼šCDNé€šè¿‡æ™ºèƒ½DNSè§£æï¼Œå°†ç”¨æˆ·è¯·æ±‚å¯¼å‘æœ€è¿‘çš„è¾¹ç¼˜èŠ‚ç‚¹ï¼Œå®ç°å†…å®¹åŠ é€Ÿåˆ†å‘ã€‚

```
CDN DNSè§£ææµç¨‹ï¼š
ç”¨æˆ·è¯·æ±‚ cdn.example.com
         â†“
æƒå¨DNSæœåŠ¡å™¨åˆ†æï¼š
â”œâ”€ ç”¨æˆ·IPåœ°å€
â”œâ”€ ç½‘ç»œè¿è¥å•†  
â”œâ”€ åœ°ç†ä½ç½®
â””â”€ èŠ‚ç‚¹è´Ÿè½½æƒ…å†µ
         â†“
è¿”å›æœ€ä¼˜è¾¹ç¼˜èŠ‚ç‚¹IPï¼š
åŒ—äº¬ç”¨æˆ· â†’ åŒ—äº¬èŠ‚ç‚¹ (1.2.3.4)
ä¸Šæµ·ç”¨æˆ· â†’ ä¸Šæµ·èŠ‚ç‚¹ (5.6.7.8)
```

### 8.2 CDN DNSé…ç½®ç­–ç•¥


**ğŸ”¸ CNAMEæ–¹å¼é›†æˆCDN**

```bash
# åŸå§‹é…ç½®
www.example.com.    IN  A     192.168.1.100

# CDNé…ç½®
www.example.com.    IN  CNAME  www.example.com.cdn.provider.com.
```

**ğŸ”¸ å¤šCDNå®¹ç¾é…ç½®**

```bash
# ä¸»CDNé…ç½®
www         IN  CNAME  www.example.com.primarycdn.com.
static      IN  CNAME  static.example.com.primarycdn.com.

# å¤‡ç”¨CDNé…ç½®ï¼ˆæ‰‹åŠ¨åˆ‡æ¢ï¼‰
www-backup  IN  CNAME  www.example.com.backupcdn.com.
static-backup IN CNAME static.example.com.backupcdn.com.
```

### 8.3 æ™ºèƒ½DNSè°ƒåº¦


**ğŸ”¸ åŸºäºè¿è¥å•†çš„DNSè°ƒåº¦**

| è¿è¥å•† | **DNSè§†å›¾** | **CDNèŠ‚ç‚¹** | **IPæ®µ** |
|-------|------------|-------------|----------|
| **ç”µä¿¡** | `telecom` | `ç”µä¿¡CDNèŠ‚ç‚¹` | `202.96.0.0/16` |
| **è”é€š** | `unicom` | `è”é€šCDNèŠ‚ç‚¹` | `61.144.0.0/16` |
| **ç§»åŠ¨** | `mobile` | `ç§»åŠ¨CDNèŠ‚ç‚¹` | `39.128.0.0/16` |
| **å…¶ä»–** | `default` | `é€šç”¨CDNèŠ‚ç‚¹` | `any` |

```bash
# /etc/named.conf - è¿è¥å•†è§†å›¾é…ç½®
view "telecom" {
    match-clients { telecom_ips; };
    zone "example.com" {
        type master;
        file "example.com.telecom";
    };
};

view "unicom" {
    match-clients { unicom_ips; };
    zone "example.com" {
        type master;
        file "example.com.unicom";
    };
};
```

### 8.4 CDN DNSæ€§èƒ½ä¼˜åŒ–


**ğŸ”¸ TTLä¼˜åŒ–ç­–ç•¥**

```bash
# ä¸åŒèµ„æºç±»å‹çš„TTLè®¾ç½®
www.example.com.        300   IN  CNAME  cdn.provider.com.     # çŸ­TTLï¼Œæ”¯æŒå¿«é€Ÿåˆ‡æ¢
static.example.com.     3600  IN  CNAME  static-cdn.provider.com.  # é™æ€èµ„æºé•¿TTL
api.example.com.        60    IN  A      192.168.1.100         # APIçŸ­TTLï¼Œä¾¿äºæ•…éšœåˆ‡æ¢
```

**ğŸ”¸ DNSé¢„åŠ è½½å’Œé¢„è§£æ**

```html
<!-- ç½‘é¡µä¸­æ·»åŠ DNSé¢„è§£æ -->
<link rel="dns-prefetch" href="//cdn.example.com">
<link rel="dns-prefetch" href="//static.example.com">
<link rel="preconnect" href="//api.example.com">
```

**ğŸ”¸ ç›‘æ§å’Œåˆ†æ**

```bash
# DNSæŸ¥è¯¢åˆ†æè„šæœ¬
#!/bin/bash
# åˆ†æDNSæŸ¥è¯¢æ—¥å¿—ï¼Œä¼˜åŒ–CDNé…ç½®

LOG_FILE="/var/log/named/query.log"
REPORT_FILE="/tmp/dns_analysis.txt"

echo "DNSæŸ¥è¯¢åˆ†ææŠ¥å‘Š - $(date)" > $REPORT_FILE
echo "================================" >> $REPORT_FILE

# ç»Ÿè®¡æŸ¥è¯¢æœ€å¤šçš„åŸŸå
echo "çƒ­é—¨åŸŸåæŸ¥è¯¢:" >> $REPORT_FILE
grep -o "query: .* IN A" $LOG_FILE | awk '{print $2}' | sort | uniq -c | sort -nr | head -10 >> $REPORT_FILE

# ç»Ÿè®¡å®¢æˆ·ç«¯åœ°ç†åˆ†å¸ƒ
echo -e "\nå®¢æˆ·ç«¯IPåˆ†å¸ƒ:" >> $REPORT_FILE
grep -o "client [0-9.]*" $LOG_FILE | awk '{print $2}' | sort | uniq -c | sort -nr | head -10 >> $REPORT_FILE

# ç»Ÿè®¡æŸ¥è¯¢æ—¶é—´åˆ†å¸ƒ
echo -e "\næŸ¥è¯¢æ—¶é—´åˆ†å¸ƒ:" >> $REPORT_FILE
grep "$(date '+%d-%b-%Y')" $LOG_FILE | awk '{print $1" "$2}' | cut -d: -f1-2 | sort | uniq -c >> $REPORT_FILE
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç¦»çº¿ç¯å¢ƒDNSï¼šå®Œå…¨å†…éƒ¨åŒ–çš„DNSè§£æï¼Œç¡®ä¿å®‰å…¨éš”ç¦»
ğŸ”¸ é«˜å®‰å…¨DNSï¼šåˆ†çº§å®‰å…¨ç­–ç•¥ï¼ŒæŸ¥è¯¢è¿‡æ»¤å’Œå®¡è®¡
ğŸ”¸ å¼€å‘æµ‹è¯•DNSï¼šçµæ´»é…ç½®ï¼Œæ”¯æŒç¯å¢ƒå¿«é€Ÿåˆ‡æ¢
ğŸ”¸ å®¹å™¨DNSï¼šåŠ¨æ€æœåŠ¡å‘ç°ï¼Œæ”¯æŒå®¹å™¨åŒ–åº”ç”¨
ğŸ”¸ K8s DNSï¼šCoreDNSé›†ç¾¤æœåŠ¡ï¼Œæ ‡å‡†åŒ–å‘½åè§„èŒƒ
ğŸ”¸ å¾®æœåŠ¡DNSï¼šæœåŠ¡æ³¨å†Œå‘ç°ï¼Œæ”¯æŒåŠ¨æ€æ‰©ç¼©å®¹
ğŸ”¸ è´Ÿè½½å‡è¡¡DNSï¼šæ™ºèƒ½è°ƒåº¦ï¼Œå¥åº·æ£€æŸ¥å’Œæ•…éšœè½¬ç§»
ğŸ”¸ CDN DNSï¼šåœ°ç†ä½ç½®ä¼˜åŒ–ï¼Œæ™ºèƒ½è¾¹ç¼˜èŠ‚ç‚¹é€‰æ‹©
```

### 9.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ å®‰å…¨æ€§é…ç½®**
```
è®¿é—®æ§åˆ¶ï¼šä¸¥æ ¼çš„ACLå’ŒæŸ¥è¯¢é™åˆ¶
æ—¥å¿—å®¡è®¡ï¼šå®Œæ•´çš„DNSæŸ¥è¯¢è®°å½•
éš”ç¦»ç­–ç•¥ï¼šä¸åŒå®‰å…¨çº§åˆ«çš„DNSåˆ†ç¦»
åŠ å¯†ä¼ è¾“ï¼šDoT/DoHç­‰åŠ å¯†DNSåè®®
```

**ğŸ”¹ é«˜å¯ç”¨æ€§é…ç½®**
```
å†—ä½™éƒ¨ç½²ï¼šä¸»ä»DNSæœåŠ¡å™¨é…ç½®
å¥åº·æ£€æŸ¥ï¼šè‡ªåŠ¨åŒ–æœåŠ¡å¥åº·ç›‘æ§
æ•…éšœè½¬ç§»ï¼šå¿«é€Ÿçš„DNSè®°å½•æ›´æ–°
è´Ÿè½½å‡è¡¡ï¼šå¤šæœåŠ¡å™¨è´Ÿè½½åˆ†æ‹…
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–é…ç½®**
```
ç¼“å­˜ç­–ç•¥ï¼šåˆé€‚çš„TTLè®¾ç½®
å¹¶å‘æ§åˆ¶ï¼šDNSæŸ¥è¯¢å¹¶å‘æ•°é™åˆ¶
åœ°ç†ä¼˜åŒ–ï¼šåŸºäºä½ç½®çš„æ™ºèƒ½è§£æ
ç›‘æ§åˆ†æï¼šDNSæ€§èƒ½æ•°æ®æ”¶é›†
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š åœºæ™¯é€‰æ‹©çŸ©é˜µ**

| åº”ç”¨åœºæ™¯ | **æ¨èæ–¹æ¡ˆ** | **å…³é”®ç‰¹æ€§** | **æ³¨æ„äº‹é¡¹** |
|---------|-------------|-------------|-------------|
| ğŸ¢ **ä¼ä¸šå†…ç½‘** | `BIND + è½¬å‘` | `å®‰å…¨éš”ç¦»ï¼Œå†…éƒ¨åŸŸå` | `ä¸¥æ ¼ACLæ§åˆ¶` |
| ğŸ› ï¸ **å¼€å‘æµ‹è¯•** | `dnsmasq + hosts` | `çµæ´»é…ç½®ï¼Œå¿«é€Ÿåˆ‡æ¢` | `ç¯å¢ƒéš”ç¦»` |
| ğŸ³ **å®¹å™¨ç¯å¢ƒ** | `Docker DNS + Consul` | `åŠ¨æ€å‘ç°ï¼Œè‡ªåŠ¨æ³¨å†Œ` | `ç½‘ç»œè§„åˆ’` |
| â˜¸ï¸ **K8sé›†ç¾¤** | `CoreDNS + Service` | `æ ‡å‡†åŒ–ï¼Œè‡ªåŠ¨åŒ–` | `å‘½åè§„èŒƒ` |
| ğŸ”„ **å¾®æœåŠ¡** | `Consul + å¥åº·æ£€æŸ¥` | `æœåŠ¡å‘ç°ï¼Œè´Ÿè½½å‡è¡¡` | `æœåŠ¡æ³¨å†Œ` |
| ğŸŒ **CDNåŠ é€Ÿ** | `æ™ºèƒ½DNS + CNAME` | `åœ°ç†ä¼˜åŒ–ï¼Œè¾¹ç¼˜åˆ†å‘` | `TTLä¼˜åŒ–` |

**ğŸ”§ æ•…éšœæ’æŸ¥æµç¨‹**
```bash
# 1. åŸºç¡€è¿é€šæ€§æ£€æŸ¥
ping dns-server-ip
nslookup domain-name dns-server-ip

# 2. DNSé…ç½®æ£€æŸ¥
dig @dns-server domain-name
host domain-name dns-server

# 3. æ—¥å¿—åˆ†æ
tail -f /var/log/named/named.log
journalctl -u named -f

# 4. æ€§èƒ½æµ‹è¯•
dig +trace domain-name
time dig domain-name
```

### 9.4 æœ€ä½³å®è·µæ€»ç»“


**ğŸŒŸ é…ç½®ç®¡ç†**
- ğŸ”¸ ç‰ˆæœ¬æ§åˆ¶DNSé…ç½®æ–‡ä»¶
- ğŸ”¸ è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œæ›´æ–°æµç¨‹
- ğŸ”¸ é…ç½®å˜æ›´è®°å½•å’Œå›æ»šæœºåˆ¶
- ğŸ”¸ å®šæœŸå¤‡ä»½DNSæ•°æ®

**ğŸŒŸ ç›‘æ§å‘Šè­¦**
- ğŸ”¸ DNSæœåŠ¡å¯ç”¨æ€§ç›‘æ§
- ğŸ”¸ æŸ¥è¯¢æ€§èƒ½å’Œå“åº”æ—¶é—´ç›‘æ§
- ğŸ”¸ DNSè§£æé”™è¯¯ç‡å‘Šè­¦
- ğŸ”¸ å¼‚å¸¸æŸ¥è¯¢æ¨¡å¼æ£€æµ‹

**ğŸŒŸ å®‰å…¨é˜²æŠ¤**
- ğŸ”¸ å®šæœŸæ›´æ–°DNSè½¯ä»¶ç‰ˆæœ¬
- ğŸ”¸ å®æ–½DNSæŸ¥è¯¢é¢‘ç‡é™åˆ¶
- ğŸ”¸ ç›‘æ§DNSéš§é“æ”»å‡»
- ğŸ”¸ é…ç½®DNS over HTTPS (DoH)

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- ğŸ¯ **ç‰¹æ®Šåœºæ™¯éœ€è¦ç‰¹æ®Šé…ç½®** - æ ¹æ®å…·ä½“ç¯å¢ƒé€‰æ‹©æœ€é€‚åˆçš„DNSæ–¹æ¡ˆ
- ğŸ”’ **å®‰å…¨æ€§æ˜¯é¦–è¦è€ƒè™‘** - ä¸åŒç¯å¢ƒéœ€è¦ä¸åŒçº§åˆ«çš„å®‰å…¨ç­–ç•¥
- ğŸš€ **åŠ¨æ€æ€§æ˜¯ç°ä»£éœ€æ±‚** - å®¹å™¨å’Œå¾®æœåŠ¡ç¯å¢ƒéœ€è¦åŠ¨æ€DNSè§£æ
- ğŸ“Š **ç›‘æ§å’Œä¼˜åŒ–æŒç»­è¿›è¡Œ** - DNSæ€§èƒ½ç›´æ¥å½±å“ç”¨æˆ·ä½“éªŒ