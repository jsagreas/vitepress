---
title: 9、多网卡环境DNS配置
---
## 📚 目录

1. [多网卡DNS配置基础概念](#1-多网卡DNS配置基础概念)
2. [网卡特定DNS服务器配置](#2-网卡特定DNS服务器配置)
3. [VPN环境DNS分流配置](#3-VPN环境DNS分流配置)
4. [多接口DNS优先级管理](#4-多接口DNS优先级管理)
5. [内网外网DNS分离配置](#5-内网外网DNS分离配置)
6. [路由表与DNS解析关联](#6-路由表与DNS解析关联)
7. [网络命名空间DNS隔离](#7-网络命名空间DNS隔离)
8. [容器环境DNS配置](#8-容器环境DNS配置)
9. [虚拟网络DNS管理](#9-虚拟网络DNS管理)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🌐 多网卡DNS配置基础概念


### 1.1 什么是多网卡DNS配置


**通俗理解**：就像一个房子有多个门，每个门都有自己的地址查询方式

在Linux系统中，当你有多张网卡时（比如有线网卡、无线网卡、VPN网卡），每张网卡可能需要使用不同的DNS服务器来解析域名。这就是多网卡DNS配置要解决的问题。

```
现实场景类比：
公司办公 → 使用公司内网DNS服务器
家庭网络 → 使用运营商DNS服务器  
VPN连接 → 使用VPN提供商DNS服务器
```

### 1.2 多网卡环境的挑战


**主要问题**：
- **DNS冲突**：不同网卡的DNS服务器可能给出不同答案
- **优先级混乱**：系统不知道该用哪个DNS服务器
- **解析错误**：内网域名被外网DNS解析，导致无法访问
- **安全风险**：敏感查询可能泄露到不安全的DNS服务器

### 1.3 解决思路概览


```
多网卡DNS配置解决方案：

物理层面：
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  有线网卡   │    │  无线网卡   │    │  VPN网卡    │
│  eth0      │    │  wlan0     │    │  tun0      │
└─────────────┘    └─────────────┘    └─────────────┘
       │                  │                  │
       ▼                  ▼                  ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 公司DNS服务器│    │ 家庭DNS服务器│    │ VPN DNS服务器│
│ 192.168.1.1 │    │ 192.168.0.1 │    │ 10.0.0.1   │
└─────────────┘    └─────────────┘    └─────────────┘

配置目标：不同网卡使用对应的DNS服务器
```

---

## 2. 🔧 网卡特定DNS服务器配置


### 2.1 NetworkManager环境配置


NetworkManager是现代Linux发行版的主流网络管理工具，它支持为每个连接单独配置DNS。

**查看当前网络连接**：
```bash
nmcli connection show
```

**为特定连接配置DNS**：
```bash
# 为有线连接配置DNS
nmcli connection modify "Wired connection 1" ipv4.dns "192.168.1.1,8.8.8.8"

# 为无线连接配置DNS  
nmcli connection modify "WiFi-Home" ipv4.dns "192.168.0.1,1.1.1.1"

# 重启连接使配置生效
nmcli connection up "Wired connection 1"
```

> 💡 **理解要点**：每个网络连接都可以有自己的DNS设置，这样不同网络环境下会自动使用对应的DNS服务器。

### 2.2 传统网络配置方法


**修改网卡配置文件**（CentOS/RHEL系统）：
```bash
# 编辑网卡配置文件
vim /etc/sysconfig/network-scripts/ifcfg-eth0
```

在配置文件中添加：
```
DNS1=192.168.1.1
DNS2=8.8.8.8
PEERDNS=yes
```

**Ubuntu/Debian系统使用netplan**：
```yaml
# /etc/netplan/01-netcfg.yaml
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: true
      nameservers:
        addresses: [192.168.1.1, 8.8.8.8]
    eth1:
      dhcp4: true  
      nameservers:
        addresses: [10.0.0.1, 1.1.1.1]
```

### 2.3 验证网卡DNS配置


**检查DNS解析来源**：
```bash
# 查看当前使用的DNS服务器
systemd-resolve --status

# 测试特定DNS服务器解析
nslookup google.com 192.168.1.1
dig @192.168.1.1 google.com
```

---

## 3. 🛡️ VPN环境DNS分流配置


### 3.1 VPN DNS分流的必要性


**为什么需要DNS分流**：
- **隐私保护**：避免DNS查询泄露到本地ISP
- **访问控制**：通过VPN访问被阻止的网站
- **性能优化**：本地域名用本地DNS，远程域名用VPN DNS

### 3.2 OpenVPN客户端DNS配置


**OpenVPN配置文件修改**：
```
# 在客户端配置文件中添加
script-security 2
up /etc/openvpn/update-resolv-conf
down /etc/openvpn/update-resolv-conf

# 推送DNS服务器设置
dhcp-option DNS 10.8.0.1
dhcp-option DOMAIN company.local
```

**手动脚本实现DNS切换**：
```bash
#!/bin/bash
# vpn-dns-switch.sh

VPN_DNS="10.8.0.1"
LOCAL_DNS="192.168.1.1"

case "$1" in
  up)
    # VPN连接时，备份原DNS配置
    cp /etc/resolv.conf /etc/resolv.conf.backup
    echo "nameserver $VPN_DNS" > /etc/resolv.conf
    ;;
  down)
    # VPN断开时，恢复原DNS配置
    cp /etc/resolv.conf.backup /etc/resolv.conf
    ;;
esac
```

### 3.3 systemd-resolved与VPN集成


**配置VPN接口专用DNS**：
```bash
# 为VPN接口设置DNS
systemd-resolve --interface=tun0 --set-dns=10.8.0.1 --set-domain=company.local

# 查看接口DNS配置
systemd-resolve --status tun0
```

---

## 4. ⚖️ 多接口DNS优先级管理


### 4.1 理解DNS优先级机制


DNS优先级决定了当多个网卡都配置了DNS时，系统优先使用哪个DNS服务器。

```
DNS解析优先级顺序：
1. /etc/hosts 文件
2. systemd-resolved (按接口优先级)
3. /etc/resolv.conf 
4. 网卡默认DNS设置

接口优先级影响因素：
- 网卡类型 (有线 > 无线 > VPN)
- 路由度量值 (metric值越小优先级越高)
- 手动配置的优先级
```

### 4.2 使用systemd-resolved管理优先级


**查看当前DNS解析状态**：
```bash
systemd-resolve --status
```

**手动设置接口DNS优先级**：
```bash
# 设置接口DNS并指定搜索域
systemd-resolve --interface=eth0 --set-dns=192.168.1.1 --set-domain=office.local

# 设置接口DNS为仅路由特定域名
systemd-resolve --interface=tun0 --set-dns=10.8.0.1 --set-domain=~company.local
```

> ⚠️ **重要概念**：`~company.local` 中的波浪号表示"仅为此域名使用该DNS"，这是域名路由的关键语法。

### 4.3 NetworkManager优先级配置


**设置连接优先级**：
```bash
# 设置DNS优先级（数值越小优先级越高）
nmcli connection modify "Wired connection 1" ipv4.dns-priority 10
nmcli connection modify "WiFi-Home" ipv4.dns-priority 20
nmcli connection modify "VPN-Company" ipv4.dns-priority 5
```

---

## 5. 🏢 内网外网DNS分离配置


### 5.1 DNS分离的应用场景


**典型场景**：
- **办公环境**：内网服务器用内网DNS，外网网站用公网DNS
- **家庭实验室**：本地服务用本地DNS，其他用运营商DNS
- **混合云环境**：私有云用内网DNS，公有云用其DNS

### 5.2 基于域名的DNS分离


**使用dnsmasq实现分离**：

安装配置dnsmasq：
```bash
# 安装dnsmasq
sudo apt install dnsmasq

# 编辑配置文件
sudo vim /etc/dnsmasq.conf
```

配置内容：
```
# 监听所有接口
listen-address=127.0.0.1,192.168.1.100

# 内网域名使用内网DNS
server=/company.local/192.168.1.1
server=/office.local/192.168.1.1

# 外网域名使用公网DNS
server=8.8.8.8
server=1.1.1.1

# 禁止解析上游没有的域名
domain-needed
bogus-priv
```

**启动和测试**：
```bash
# 启动dnsmasq
sudo systemctl start dnsmasq
sudo systemctl enable dnsmasq

# 测试内网域名解析
dig @127.0.0.1 server.company.local

# 测试外网域名解析  
dig @127.0.0.1 google.com
```

### 5.3 使用systemd-resolved的域名路由


**配置域名路由规则**：
```bash
# 内网域名通过内网DNS解析
systemd-resolve --interface=eth0 --set-dns=192.168.1.1 --set-domain=~company.local

# 外网域名通过外网DNS解析
systemd-resolve --interface=wlan0 --set-dns=8.8.8.8 --set-domain=~.
```

> 📖 **概念解释**：`~.` 表示匹配所有域名，但优先级最低，只有当其他规则都不匹配时才使用。

---

## 6. 🛣️ 路由表与DNS解析关联


### 6.1 理解路由与DNS的关系


路由表决定了数据包的传输路径，而DNS配置决定了域名解析的服务器。在复杂网络环境中，这两者需要协调工作。

```
路由与DNS关联示例：

网络拓扑：
内网: 192.168.1.0/24 → 网关: 192.168.1.1 → DNS: 192.168.1.1
外网: 0.0.0.0/0       → 网关: 192.168.0.1 → DNS: 8.8.8.8

路由表：
Destination     Gateway         Interface
192.168.1.0/24  0.0.0.0         eth0
0.0.0.0/0       192.168.0.1     wlan0

DNS规则：
内网域名 → 通过eth0接口查询192.168.1.1
外网域名 → 通过wlan0接口查询8.8.8.8
```

### 6.2 基于路由的DNS配置


**使用策略路由配置**：
```bash
# 创建路由表
echo "100 office" >> /etc/iproute2/rt_tables
echo "200 internet" >> /etc/iproute2/rt_tables

# 添加路由规则
ip route add 192.168.1.0/24 dev eth0 table office
ip route add default via 192.168.1.1 dev eth0 table office

ip route add 0.0.0.0/0 via 192.168.0.1 dev wlan0 table internet

# 添加策略路由
ip rule add from 192.168.1.0/24 table office
ip rule add to 192.168.1.0/24 table office
```

### 6.3 动态路由DNS更新


**脚本实现路由变化时自动更新DNS**：
```bash
#!/bin/bash
# route-dns-sync.sh

OFFICE_NETWORK="192.168.1.0/24"
OFFICE_DNS="192.168.1.1"
INTERNET_DNS="8.8.8.8"

# 检查到办公网络的路由
if ip route get 192.168.1.1 | grep -q "dev eth0"; then
    # 使用办公网络DNS
    systemd-resolve --interface=eth0 --set-dns=$OFFICE_DNS --set-domain=~company.local
else
    # 使用互联网DNS
    systemd-resolve --interface=wlan0 --set-dns=$INTERNET_DNS
fi
```

---

## 7. 🔒 网络命名空间DNS隔离


### 7.1 网络命名空间基础


网络命名空间提供了完全独立的网络环境，包括独立的DNS配置。这在容器技术、网络隔离中广泛应用。

**创建和管理网络命名空间**：
```bash
# 创建网络命名空间
ip netns add isolated-env
ip netns add office-env

# 查看命名空间列表
ip netns list

# 在命名空间中执行命令
ip netns exec isolated-env bash
```

### 7.2 命名空间DNS独立配置


**为命名空间配置独立的DNS**：
```bash
# 在isolated-env命名空间中配置DNS
ip netns exec isolated-env bash -c "echo 'nameserver 10.0.0.1' > /etc/resolv.conf"

# 在office-env命名空间中配置DNS
ip netns exec office-env bash -c "echo 'nameserver 192.168.1.1' > /etc/resolv.conf"

# 测试不同命名空间的DNS解析
ip netns exec isolated-env nslookup google.com
ip netns exec office-env nslookup server.company.local
```

### 7.3 命名空间网络接口配置


**为命名空间添加网络接口**：
```bash
# 创建veth对
ip link add veth-isolated type veth peer name veth-isolated-br

# 将一端移动到命名空间
ip link set veth-isolated netns isolated-env

# 在命名空间中配置IP地址
ip netns exec isolated-env ip addr add 10.0.0.2/24 dev veth-isolated
ip netns exec isolated-env ip link set veth-isolated up

# 配置路由
ip netns exec isolated-env ip route add default via 10.0.0.1
```

---

## 8. 🐳 容器环境DNS配置


### 8.1 Docker容器DNS配置


Docker容器默认使用宿主机的DNS配置，但可以为容器指定特定的DNS服务器。

**运行时指定DNS**：
```bash
# 为容器指定DNS服务器
docker run --dns=192.168.1.1 --dns=8.8.8.8 ubuntu:20.04

# 指定DNS搜索域
docker run --dns-search=company.local ubuntu:20.04

# 组合使用
docker run --dns=192.168.1.1 --dns-search=company.local --name web-server nginx
```

**Docker Compose DNS配置**：
```yaml
version: '3.8'
services:
  web:
    image: nginx
    dns:
      - 192.168.1.1
      - 8.8.8.8
    dns_search:
      - company.local
      - office.local
```

### 8.2 Kubernetes集群DNS配置


**Pod级别DNS配置**：
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: dns-example
spec:
  dnsPolicy: "None"
  dnsConfig:
    nameservers:
      - 192.168.1.1
      - 8.8.8.8
    searches:
      - company.local
      - office.local
    options:
      - name: ndots
        value: "2"
```

> 🔧 **实践要点**：`dnsPolicy: "None"` 表示完全自定义DNS配置，不使用集群默认设置。

### 8.3 容器网络DNS调试


**容器内DNS调试方法**：
```bash
# 进入容器查看DNS配置
docker exec -it container-name cat /etc/resolv.conf

# 在容器内测试DNS解析
docker exec -it container-name nslookup google.com

# 使用dig进行详细测试
docker exec -it container-name dig @192.168.1.1 server.company.local
```

---

## 9. 🌐 虚拟网络DNS管理


### 9.1 虚拟化环境DNS架构


在虚拟化环境中，通常有多层网络结构，每层都可能需要不同的DNS配置。

```
虚拟化DNS架构：

宿主机层：
┌─────────────────────────────────────────┐
│ 宿主机 (Host OS)                        │
│ DNS: 8.8.8.8, 1.1.1.1                  │
└─────────────────────────────────────────┘
                    │
            虚拟网络桥接
                    │
虚拟机层：
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ VM1 - Web   │  │ VM2 - DB    │  │ VM3 - Cache │
│ DNS:        │  │ DNS:        │  │ DNS:        │  
│ 192.168.1.1 │  │ 192.168.1.1 │  │ 192.168.1.1 │
└─────────────┘  └─────────────┘  └─────────────┘
```

### 9.2 libvirt虚拟网络DNS配置


**创建自定义虚拟网络**：
```xml
<!-- custom-network.xml -->
<network>
  <name>office-network</name>
  <forward mode='nat'/>
  <bridge name='virbr1' stp='on' delay='0'/>
  <ip address='192.168.100.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.100.100' end='192.168.100.200'/>
    </dhcp>
  </ip>
  <dns>
    <forwarder addr='192.168.1.1'/>
    <forwarder addr='8.8.8.8'/>
  </dns>
</network>
```

**应用虚拟网络配置**：
```bash
# 定义虚拟网络
virsh net-define custom-network.xml

# 启动虚拟网络
virsh net-start office-network

# 设置自动启动
virsh net-autostart office-network

# 查看网络详情
virsh net-dumpxml office-network
```

### 9.3 OVS(Open vSwitch) DNS配置


**配置OVS桥接网络**：
```bash
# 创建OVS桥
ovs-vsctl add-br br-office

# 添加物理接口到桥
ovs-vsctl add-port br-office eth1

# 配置桥IP地址
ip addr add 192.168.100.1/24 dev br-office
ip link set br-office up

# 配置DHCP和DNS服务
dnsmasq --interface=br-office --dhcp-range=192.168.100.10,192.168.100.100 \
        --dhcp-option=option:dns-server,192.168.1.1
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 多网卡DNS配置：每个网络接口可以有独立的DNS设置
🔸 DNS优先级：系统按特定顺序选择DNS服务器
🔸 域名路由：不同域名可以使用不同的DNS服务器解析
🔸 网络隔离：通过命名空间实现完全独立的DNS环境
🔸 容器DNS：容器可以有独立于宿主机的DNS配置
```

### 10.2 关键配置工具对比


| 工具 | **适用场景** | **优点** | **缺点** | **推荐度** |
|------|-------------|---------|---------|-----------|
| **NetworkManager** | `桌面环境、简单配置` | `GUI友好、自动管理` | `功能有限` | ⭐⭐⭐⭐⭐ |
| **systemd-resolved** | `现代Linux系统` | `功能强大、域名路由` | `配置复杂` | ⭐⭐⭐⭐⭐ |
| **dnsmasq** | `本地DNS缓存` | `轻量、灵活` | `需手动配置` | ⭐⭐⭐⭐☆ |
| **传统配置文件** | `服务器环境` | `稳定、兼容性好` | `缺乏动态性` | ⭐⭐⭐☆☆ |

### 10.3 实际应用最佳实践


**🏢 企业办公环境**：
```bash
# 有线网络使用公司DNS
nmcli connection modify "Wired connection 1" ipv4.dns "192.168.1.1"

# VPN连接使用VPN DNS并路由特定域名
systemd-resolve --interface=tun0 --set-dns=10.8.0.1 --set-domain=~company.local
```

**🏠 家庭网络环境**：
```bash
# 主网络使用运营商DNS + 公共DNS
nmcli connection modify "WiFi-Home" ipv4.dns "192.168.0.1,1.1.1.1"

# 客人网络使用纯公共DNS
nmcli connection modify "WiFi-Guest" ipv4.dns "8.8.8.8,1.1.1.1"
```

**🐳 容器化环境**：
```yaml
# docker-compose.yml
services:
  web:
    dns:
      - 192.168.1.1  # 内网DNS
      - 8.8.8.8      # 备用公网DNS
    dns_search:
      - company.local
```

### 10.4 故障排查命令速查


```bash
# 查看当前DNS配置
systemd-resolve --status
cat /etc/resolv.conf

# 测试DNS解析
dig google.com
nslookup server.company.local 192.168.1.1

# 查看网络接口状态
ip addr show
nmcli device status

# 检查路由表
ip route show
ip route get 8.8.8.8

# 容器DNS调试
docker exec -it container-name cat /etc/resolv.conf
kubectl exec -it pod-name -- nslookup google.com
```

### 10.5 常见问题解决


> ⚠️ **DNS解析混乱**：使用 `systemd-resolve --flush-caches` 清除缓存

> 🔧 **VPN DNS不生效**：检查是否正确设置了域名路由规则

> 📱 **容器无法解析内网域名**：确保容器DNS配置包含内网DNS服务器

> 🌐 **多网卡优先级错误**：使用NetworkManager设置正确的DNS优先级

**核心记忆要点**：
- 每个网络接口都可以有独立的DNS配置
- 使用域名路由实现精确的DNS分流  
- 网络命名空间提供完全隔离的DNS环境
- 容器环境需要特别关注DNS继承和覆盖规则
- 路由表与DNS配置需要协调一致