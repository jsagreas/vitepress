---
title: 11、DNS故障排查诊断
---
## 📚 目录

1. [DNS故障诊断基础概念](#1-DNS故障诊断基础概念)
2. [DNS解析失败诊断流程](#2-DNS解析失败诊断流程)
3. [超时问题排查方法](#3-超时问题排查方法)
4. [DNS污染检测与处理](#4-DNS污染检测与处理)
5. [解析慢问题定位技巧](#5-解析慢问题定位技巧)
6. [缓存污染清理方法](#6-缓存污染清理方法)
7. [网络连通性验证](#7-网络连通性验证)
8. [DNS服务器响应测试](#8-DNS服务器响应测试)
9. [解析路径追踪分析](#9-解析路径追踪分析)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔍 DNS故障诊断基础概念


### 1.1 什么是DNS故障诊断


**简单理解**：就像修理工诊断机器故障一样，DNS故障诊断是找出网络域名解析问题的过程。

**DNS故障的本质**：
```
正常情况：输入 www.baidu.com → 自动找到对应IP地址 → 成功访问网站
故障情况：输入 www.baidu.com → 找不到IP地址 → 无法访问网站
```

🔸 **常见故障表现**：
- 网站打不开，提示"无法解析域名"
- 网页加载很慢，等很久才打开
- 有些网站能访问，有些不能
- 同样的网址，有时能用有时不能用

### 1.2 DNS解析过程回顾


**完整解析链路**：
```
你的电脑 → 本地DNS缓存 → 路由器DNS → 运营商DNS → 根域名服务器 → 权威DNS服务器
```

**每个环节都可能出问题**：
- 🔸 **本地缓存**：存储了错误信息
- 🔸 **网络连接**：到DNS服务器的网络不通
- 🔸 **DNS服务器**：服务器故障或配置错误
- 🔸 **域名配置**：网站的DNS配置有问题

### 1.3 故障诊断的基本思路


**诊断原则**：从近到远，从简单到复杂

```
第1步：检查本地配置（你自己电脑的设置）
第2步：检查网络连通性（能不能连到DNS服务器）
第3步：检查DNS服务器（服务器本身有没有问题）
第4步：检查域名配置（目标网站的DNS设置）
```

---

## 2. 🛠️ DNS解析失败诊断流程


### 2.1 故障现象分类


**完全无法解析**：
```bash
# 表现：ping域名直接报错
ping www.example.com
# 错误：ping: cannot resolve www.example.com: Unknown host
```

**部分域名解析失败**：
- 有些网站能打开，有些不能
- 国外网站访问不了，国内网站正常

**解析结果错误**：
- 能解析出IP，但IP地址不对
- 访问域名跳转到错误页面

### 2.2 系统化诊断流程


#### 🔹 第一步：基础检查


**检查网络连接**：
```bash
# 检查本地网络是否正常
ping 8.8.8.8
# 如果这个都ping不通，说明网络本身有问题
```

**检查DNS服务器设置**：
```bash
# 查看当前使用的DNS服务器
cat /etc/resolv.conf
# 应该看到类似这样的内容：
# nameserver 114.114.114.114
# nameserver 8.8.8.8
```

#### 🔹 第二步：测试不同DNS服务器


**使用可靠的公共DNS测试**：
```bash
# 临时使用谷歌DNS测试
nslookup www.baidu.com 8.8.8.8

# 临时使用114DNS测试  
nslookup www.baidu.com 114.114.114.114
```

**如果换DNS后能解析**：说明原来的DNS服务器有问题
**如果换DNS后还不能解析**：说明问题在其他地方

#### 🔹 第三步：详细解析测试


**使用dig命令深入检查**：
```bash
# 详细查看解析过程
dig www.baidu.com

# 检查特定记录类型
dig www.baidu.com A      # 查看A记录
dig www.baidu.com CNAME  # 查看CNAME记录
```

### 2.3 常见失败原因及解决方案


| 故障现象 | 可能原因 | 解决方法 |
|---------|---------|---------|
| 🔴 **完全无法解析** | DNS服务器设置错误 | 修改DNS服务器配置 |
| 🟡 **解析很慢** | DNS服务器响应慢 | 更换更快的DNS服务器 |
| 🟠 **部分域名失败** | DNS污染或屏蔽 | 使用国外DNS或VPN |
| 🔵 **解析结果错误** | 本地缓存污染 | 清理DNS缓存 |

---

## 3. ⏱️ 超时问题排查方法


### 3.1 超时问题的表现


**典型症状**：
- 网页打开要等很久，最后显示"连接超时"
- ping域名要等很长时间才有结果
- 浏览器显示"DNS解析失败"

### 3.2 超时问题诊断


#### 🔹 测量DNS响应时间


**使用dig命令测量**：
```bash
# 测量解析时间
dig www.baidu.com | grep "Query time"
# 正常情况下应该在几十毫秒内

# 多次测试取平均值
for i in {1..5}; do 
  dig www.baidu.com | grep "Query time"
done
```

**响应时间参考标准**：
- ✅ **优秀**：< 50ms
- 🟡 **良好**：50-200ms  
- 🟠 **较慢**：200-1000ms
- 🔴 **很慢**：> 1000ms

#### 🔹 网络路径检查


**检查到DNS服务器的网络质量**：
```bash
# 测试到DNS服务器的连通性
ping -c 4 8.8.8.8

# 追踪到DNS服务器的网络路径
traceroute 8.8.8.8
```

### 3.3 超时问题解决方案


**方案一：更换DNS服务器**
```bash
# 临时修改DNS（重启后失效）
echo "nameserver 114.114.114.114" > /etc/resolv.conf

# 永久修改（Ubuntu/Debian）
sudo systemctl edit systemd-resolved
# 添加：
# [Resolve]
# DNS=114.114.114.114 8.8.8.8
```

**方案二：调整超时参数**
```bash
# 修改DNS查询超时时间
# 在/etc/resolv.conf中添加：
# options timeout:2 attempts:3
```

---

## 4. 🦠 DNS污染检测与处理


### 4.1 什么是DNS污染


**通俗解释**：就像有人故意给你错误的地址信息，让你找不到真正想去的地方。

**DNS污染的表现**：
- 访问某些网站时跳转到错误页面
- 国外网站无法正常访问
- 解析出的IP地址明显不对

### 4.2 DNS污染检测方法


#### 🔹 对比不同DNS服务器结果


**检测步骤**：
```bash
# 使用国内DNS查询
nslookup twitter.com 114.114.114.114

# 使用国外DNS查询  
nslookup twitter.com 8.8.8.8

# 对比结果是否一致
```

**污染判断标准**：
- 如果结果完全不同 → 可能存在DNS污染
- 如果国内DNS无结果，国外DNS有结果 → 可能被屏蔽

#### 🔹 使用多个DNS服务器交叉验证


**常用DNS服务器对比表**：

| DNS服务商 | 主DNS | 备DNS | 特点 |
|----------|-------|--------|------|
| 🇨🇳 **114DNS** | 114.114.114.114 | 114.114.115.115 | 国内常用，较快 |
| 🇺🇸 **Google** | 8.8.8.8 | 8.8.4.4 | 全球通用，可靠 |
| 🇺🇸 **Cloudflare** | 1.1.1.1 | 1.0.0.1 | 速度快，隐私保护好 |
| 🇨🇳 **阿里DNS** | 223.5.5.5 | 223.6.6.6 | 阿里云提供，稳定 |

### 4.3 DNS污染处理方法


**方法一：更换纯净DNS服务器**
```bash
# 使用Cloudflare DNS
sudo echo "nameserver 1.1.1.1" > /etc/resolv.conf
sudo echo "nameserver 1.0.0.1" >> /etc/resolv.conf
```

**方法二：使用加密DNS（DoH/DoT）**
- **DoH**：DNS over HTTPS，通过HTTPS加密传输
- **DoT**：DNS over TLS，通过TLS加密传输

**方法三：本地hosts文件绕过**
```bash
# 编辑hosts文件
sudo vim /etc/hosts

# 添加正确的IP映射
140.82.114.4 github.com
151.101.1.140 reddit.com
```

---

## 5. 🐌 解析慢问题定位技巧


### 5.1 解析慢的常见原因


**网络层面原因**：
- 🔸 **距离太远**：DNS服务器在国外，物理距离导致延迟
- 🔸 **网络拥堵**：运营商网络繁忙
- 🔸 **路由问题**：数据包走了很绕的路径

**DNS服务器原因**：
- 🔸 **服务器负载高**：同时处理太多查询请求
- 🔸 **服务器故障**：部分服务器响应异常
- 🔸 **配置不当**：服务器设置有问题

### 5.2 解析速度测试方法


#### 🔹 批量测试多个DNS服务器


**创建测试脚本**：
```bash
#!/bin/bash
# dns_speed_test.sh

echo "测试DNS服务器响应速度："
echo "================================"

dns_servers=("8.8.8.8" "114.114.114.114" "1.1.1.1" "223.5.5.5")
test_domain="www.baidu.com"

for dns in "${dns_servers[@]}"; do
    echo -n "测试 $dns: "
    time=$(dig @$dns $test_domain | grep "Query time" | awk '{print $4}')
    echo "${time}ms"
done
```

#### 🔹 不同时间段测试


**找出网络繁忙时段**：
```bash
# 创建定时测试
# 每小时测试一次，找出最慢的时间段
for hour in {0..23}; do
    echo "时间：${hour}:00"
    dig www.google.com | grep "Query time"
    sleep 3600  # 等待1小时
done
```

### 5.3 解析慢问题优化方案


**优化策略排序**：

```
优先级1：选择就近的DNS服务器
├── 运营商DNS：通常最快，但可能有污染
├── 本地DNS：如公司内部DNS
└── 地理位置近的公共DNS

优先级2：启用DNS缓存
├── 系统级缓存：systemd-resolved
├── 应用级缓存：浏览器DNS缓存
└── 路由器缓存：家用路由器DNS缓存

优先级3：使用CDN友好的DNS
├── 支持EDNS的DNS服务器
├── 与CDN服务商合作的DNS
└── 智能解析的DNS服务
```

---

## 6. 🧹 缓存污染清理方法


### 6.1 缓存污染的危害


**什么是缓存污染**：
就像你的通讯录里存了错误的电话号码，每次想联系某人都拨错号。

**污染表现**：
- 明明DNS服务器是好的，但还是解析到错误IP
- 重启电脑后问题消失，但过一会又出现
- 某些域名总是解析到广告页面

### 6.2 多层缓存清理


#### 🔹 系统DNS缓存清理


**Linux系统缓存清理**：
```bash
# 方法1：重启DNS服务
sudo systemctl restart systemd-resolved

# 方法2：刷新DNS缓存
sudo systemd-resolve --flush-caches

# 方法3：清空缓存文件
sudo rm -rf /var/cache/bind/
```

**验证缓存已清理**：
```bash
# 检查缓存状态
systemd-resolve --statistics
# 应该看到缓存计数器被重置
```

#### 🔹 应用程序缓存清理


**浏览器DNS缓存**：
- **Chrome**：访问 `chrome://net-internals/#dns` 点击"Clear host cache"
- **Firefox**：重启浏览器或访问 `about:networking#dns`

**其他应用缓存**：
```bash
# 清理程序可能用到的缓存文件
sudo rm -rf ~/.cache/
sudo rm -rf /tmp/dns*
```

### 6.3 预防缓存污染


**设置合理的缓存TTL**：
```bash
# 查看域名的TTL设置
dig www.example.com | grep "IN A"
# TTL太长容易造成污染，太短影响性能
# 建议设置：300-3600秒（5分钟到1小时）
```

**定期清理策略**：
```bash
# 创建定时清理脚本
# 每天清理一次DNS缓存
echo "0 2 * * * root systemd-resolve --flush-caches" >> /etc/crontab
```

---

## 7. 🌐 网络连通性验证


### 7.1 连通性测试的重要性


**为什么要测试连通性**：
DNS解析需要网络连接，如果连网络都不通，DNS肯定也解析不了。

**测试层次**：
```
第1层：本地网卡是否正常
第2层：能否连接到路由器
第3层：能否连接到运营商网络
第4层：能否连接到DNS服务器
第5层：能否连接到目标服务器
```

### 7.2 分层连通性测试


#### 🔹 本地网络接口测试


**检查网卡状态**：
```bash
# 查看网络接口
ip addr show
# 确认网卡有IP地址，状态为UP

# 检查路由表
ip route show
# 确认有默认路由
```

**本地回环测试**：
```bash
# 测试本地网络栈
ping 127.0.0.1
# 应该能正常ping通
```

#### 🔹 网关连通性测试


**找到默认网关**：
```bash
# 查看默认网关IP
ip route | grep default
# 通常是类似 192.168.1.1 的地址
```

**测试网关连通性**：
```bash
# ping网关
ping -c 4 192.168.1.1
# 如果ping不通，说明本地网络配置有问题
```

#### 🔹 DNS服务器连通性测试


**测试DNS服务器是否可达**：
```bash
# 测试主要DNS服务器
ping -c 4 8.8.8.8
ping -c 4 114.114.114.114

# 测试DNS端口连通性
nc -u -v 8.8.8.8 53
# 应该显示连接成功
```

### 7.3 连通性问题解决方案


**网络配置问题解决**：

| 问题类型 | 解决方法 |
|---------|---------|
| 🔴 **无IP地址** | `sudo dhclient` 重新获取IP |
| 🟠 **网关不通** | 检查网线连接和路由器设置 |
| 🟡 **DNS不通** | 更换DNS服务器或检查防火墙 |
| 🔵 **间歇性断网** | 检查网络驱动和硬件 |

---

## 8. 🔬 DNS服务器响应测试


### 8.1 DNS服务器健康检查


**什么是DNS服务器响应测试**：
就像体检一样，检查DNS服务器的"身体状况"是否良好。

**检查指标**：
- 🔸 **响应速度**：查询一个域名需要多长时间
- 🔸 **成功率**：100次查询中有多少次成功
- 🔸 **稳定性**：连续查询结果是否一致
- 🔸 **功能完整性**：各种记录类型是否都支持

### 8.2 响应性能测试


#### 🔹 单次查询测试


**基础响应测试**：
```bash
# 测试A记录查询
time nslookup www.baidu.com 8.8.8.8

# 详细响应信息
dig @8.8.8.8 www.baidu.com +stats
# 注意看 "Query time" 和 "ANSWER SECTION"
```

**不同记录类型测试**：
```bash
# 测试各种DNS记录类型
dig @8.8.8.8 baidu.com A      # IPv4地址
dig @8.8.8.8 baidu.com AAAA   # IPv6地址  
dig @8.8.8.8 baidu.com MX     # 邮件服务器
dig @8.8.8.8 baidu.com NS     # 名称服务器
```

#### 🔹 批量性能测试


**创建压力测试脚本**：
```bash
#!/bin/bash
# dns_stress_test.sh

DNS_SERVER="8.8.8.8"
TEST_DOMAIN="www.google.com"
TEST_COUNT=100

echo "开始DNS压力测试..."
echo "目标DNS服务器：$DNS_SERVER"
echo "测试域名：$TEST_DOMAIN"
echo "测试次数：$TEST_COUNT"
echo "=========================="

success_count=0
total_time=0

for i in $(seq 1 $TEST_COUNT); do
    start_time=$(date +%s%N)
    result=$(dig @$DNS_SERVER $TEST_DOMAIN +short)
    end_time=$(date +%s%N)
    
    if [ ! -z "$result" ]; then
        success_count=$((success_count + 1))
        query_time=$(( (end_time - start_time) / 1000000 ))
        total_time=$((total_time + query_time))
        echo "查询 $i: 成功 (${query_time}ms)"
    else
        echo "查询 $i: 失败"
    fi
done

echo "=========================="
echo "成功率：$((success_count * 100 / TEST_COUNT))%"
echo "平均响应时间：$((total_time / success_count))ms"
```

### 8.3 服务器可用性监控


**监控指标定义**：

| 指标 | 优秀 | 良好 | 一般 | 差 |
|------|------|------|------|-----|
| 🎯 **成功率** | >99% | 95-99% | 90-95% | <90% |
| ⚡ **响应时间** | <50ms | 50-200ms | 200-500ms | >500ms |
| 📊 **稳定性** | 波动<10% | 波动10-20% | 波动20-50% | 波动>50% |

**异常DNS服务器识别**：
```bash
# 识别有问题的DNS服务器
# 如果出现以下情况，建议更换：
# 1. 成功率低于95%
# 2. 平均响应时间超过500ms  
# 3. 经常返回错误结果
# 4. 某些域名完全无法解析
```

---

## 9. 🗺️ 解析路径追踪分析


### 9.1 DNS解析路径追踪原理


**什么是解析路径追踪**：
就像快递追踪一样，看看你的DNS查询请求经过了哪些"中转站"。

**完整解析路径**：
```
你的电脑 → 本地DNS缓存 → 递归DNS服务器 → 根DNS服务器 → 
顶级域DNS服务器 → 权威DNS服务器 → 返回结果
```

### 9.2 追踪工具使用


#### 🔹 使用dig追踪解析过程


**开启追踪模式**：
```bash
# 追踪完整解析过程
dig +trace www.baidu.com

# 输出解释：
# . 518400 IN NS a.root-servers.net.     # 根服务器
# com. 172800 IN NS a.gtld-servers.net.  # .com顶级域服务器  
# baidu.com. 86400 IN NS ns1.baidu.com.  # baidu.com权威服务器
# www.baidu.com. 1200 IN A 14.215.177.39 # 最终IP地址
```

**分段解析测试**：
```bash
# 直接查询根服务器
dig @a.root-servers.net. www.baidu.com

# 查询.com顶级域服务器
dig @a.gtld-servers.net. www.baidu.com

# 查询权威DNS服务器
dig @ns1.baidu.com. www.baidu.com
```

#### 🔹 解析时间分析


**每步用时统计**：
```bash
#!/bin/bash
# dns_path_timing.sh

DOMAIN="www.example.com"

echo "DNS解析路径时间分析："
echo "===================="

# 第1步：查询根服务器
echo -n "1. 根服务器查询: "
time dig @a.root-servers.net. $DOMAIN > /dev/null

# 第2步：查询顶级域服务器  
TLD_SERVER=$(dig +short NS $(echo $DOMAIN | rev | cut -d. -f1-2 | rev) | head -1)
echo -n "2. 顶级域服务器查询: "
time dig @$TLD_SERVER $DOMAIN > /dev/null

# 第3步：查询权威服务器
AUTH_SERVER=$(dig +short NS $(echo $DOMAIN | rev | cut -d. -f1-2 | rev) | head -1)
echo -n "3. 权威服务器查询: "
time dig @$AUTH_SERVER $DOMAIN > /dev/null
```

### 9.3 路径问题诊断


**常见路径问题**：

```
问题1：某个环节超时
现象：追踪到某一步就卡住了
原因：该DNS服务器故障或网络不通
解决：更换DNS服务器或等待恢复

问题2：返回错误权威服务器
现象：追踪显示的权威服务器无法访问
原因：域名DNS配置错误
解决：联系域名管理员修正配置

问题3：解析结果不一致
现象：不同路径得到不同结果
原因：DNS服务器间同步问题
解决：等待DNS传播完成或强制刷新
```

**路径优化建议**：
- 🔸 **缩短路径**：使用支持递归查询的DNS服务器
- 🔸 **就近选择**：选择地理位置近的DNS服务器
- 🔸 **负载均衡**：配置多个DNS服务器
- 🔸 **缓存策略**：合理设置TTL值

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的诊断技能


🔹 **基础诊断工具**：
- `ping` - 测试网络连通性
- `nslookup` - 基础DNS查询
- `dig` - 详细DNS分析  
- `host` - 简单DNS查询

🔹 **系统化诊断思路**：
```
步骤1：确认网络基础连通性
步骤2：测试DNS服务器可用性  
步骤3：对比多个DNS服务器结果
步骤4：追踪完整解析路径
步骤5：清理可能的缓存污染
```

### 10.2 常见问题快速诊断表


| 🔍 **故障现象** | 🎯 **最可能原因** | 🛠️ **快速验证方法** | ✅ **解决方案** |
|---------------|-----------------|-------------------|----------------|
| 完全无法解析 | DNS服务器配置错误 | `nslookup domain 8.8.8.8` | 修改DNS配置 |
| 解析很慢 | DNS服务器响应慢 | `dig domain \| grep "Query time"` | 更换DNS服务器 |
| 部分域名失败 | DNS污染/屏蔽 | 对比国内外DNS结果 | 使用纯净DNS |
| 解析结果错误 | 缓存污染 | `systemd-resolve --flush-caches` | 清理DNS缓存 |
| 间歇性故障 | 网络不稳定 | `ping -c 100 dns-server` | 检查网络质量 |

### 10.3 日常维护最佳实践


🔹 **预防性维护**：
- 定期清理DNS缓存（每周一次）
- 监控DNS响应时间（设置告警阈值）
- 备份多个可靠DNS服务器
- 记录故障处理经验

🔹 **应急处理流程**：
```
紧急情况下的快速恢复步骤：
1. 立即更换为8.8.8.8或1.1.1.1
2. 清理所有层级的DNS缓存  
3. 重启网络服务
4. 测试关键域名解析
5. 如仍有问题，使用hosts文件临时绕过
```

🔹 **工具箱配置**：
```bash
# 创建DNS诊断工具集合
mkdir ~/dns-tools
cd ~/dns-tools

# 常用DNS服务器列表
echo "8.8.8.8 8.8.4.4" > reliable-dns.txt
echo "1.1.1.1 1.0.0.1" >> reliable-dns.txt  
echo "114.114.114.114 114.114.115.115" >> reliable-dns.txt

# 快速诊断脚本
echo "#!/bin/bash" > quick-check.sh
echo "dig \$1 @8.8.8.8 +short" >> quick-check.sh
chmod +x quick-check.sh
```

### 10.4 提升诊断效率的技巧


💡 **记忆口诀**：
```
DNS故障不要慌，分层诊断是关键
先查网络再查DNS，缓存清理很重要  
多个服务器来对比，追踪路径找根源
工具使用要熟练，经验积累是王道
```

🎯 **核心理解**：
- DNS故障90%是配置问题，10%是网络问题
- 清理缓存能解决60%的常见故障  
- 更换DNS服务器能解决30%的性能问题
- 剩下的10%需要深入分析解决

🔧 **实战建议**：
- 建立自己的故障知识库，记录每次处理经验
- 熟练掌握3-5个基础诊断命令就足够应对大部分问题
- 与网络管理员保持良好沟通，及时获取网络状态信息
- 定期学习新的DNS技术和安全威胁，保持知识更新