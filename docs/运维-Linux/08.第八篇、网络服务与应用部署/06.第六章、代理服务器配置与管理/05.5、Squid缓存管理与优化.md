---
title: 5、Squid缓存管理与优化
---
## 📚 目录

1. [缓存策略配置](#1-缓存策略配置)
2. [内存缓存vs磁盘缓存](#2-内存缓存vs磁盘缓存)
3. [缓存生存时间设置](#3-缓存生存时间设置)
4. [缓存目录层级结构](#4-缓存目录层级结构)
5. [缓存清理机制](#5-缓存清理机制)
6. [缓存命中率监控](#6-缓存命中率监控)
7. [缓存性能调优参数](#7-缓存性能调优参数)
8. [大文件缓存策略](#8-大文件缓存策略)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🎯 缓存策略配置


### 1.1 什么是Squid缓存策略


**基本概念**：缓存策略就是告诉Squid什么内容要缓存、什么不缓存、缓存多长时间的一套规则。

```
简单理解：
浏览器请求网页 → Squid检查是否有缓存 → 有缓存直接返回，没有则去源服务器获取
这样可以大大减少网络流量，提高访问速度
```

### 1.2 核心缓存策略类型


**🔸 基于内容类型的缓存**
```bash
# 缓存静态文件（图片、CSS、JS等）
acl static_files urlpath_regex \.(jpg|jpeg|png|gif|css|js|pdf)$
cache allow static_files

# 不缓存动态内容
acl dynamic_content urlpath_regex \.(php|asp|jsp|cgi)$
cache deny dynamic_content
```

**🔸 基于域名的缓存策略**
```bash
# 缓存特定域名的内容
acl cache_domains dstdomain .example.com .staticcdn.com
cache allow cache_domains

# 不缓存某些域名
acl no_cache_domains dstdomain .bank.com .payment.com
cache deny no_cache_domains
```

### 1.3 缓存策略配置示例


**基础配置文件结构**：
```bash
# /etc/squid/squid.conf 核心缓存配置

# 定义ACL（访问控制列表）
acl image_files urlpath_regex \.(jpg|jpeg|png|gif|bmp|ico)$
acl css_js_files urlpath_regex \.(css|js)$
acl video_files urlpath_regex \.(mp4|avi|mkv|flv)$

# 缓存策略
cache allow image_files
cache allow css_js_files
cache deny video_files  # 视频文件太大，不缓存

# 刷新模式（控制缓存时间）
refresh_pattern \.(jpg|jpeg|png|gif)$ 1440 20% 2880
refresh_pattern \.(css|js)$ 60 20% 1440
```

> 💡 **理解要点**：ACL是规则定义，cache是缓存决策，refresh_pattern是缓存时间控制

---

## 2. 💾 内存缓存vs磁盘缓存


### 2.1 两种缓存方式的区别


**内存缓存**：
- **速度**：极快，毫秒级响应
- **容量**：有限，受服务器内存限制
- **持久性**：重启后丢失
- **适用**：热门小文件，频繁访问的内容

**磁盘缓存**：
- **速度**：较快，但比内存慢
- **容量**：大，可以TB级别
- **持久性**：重启后保留
- **适用**：大文件，长期缓存的内容

### 2.2 内存缓存配置


```bash
# 内存缓存设置
cache_mem 512 MB                    # 分配512MB内存用于缓存
maximum_object_size_in_memory 64 KB # 超过64KB的对象不放内存
memory_replacement_policy lru        # 内存替换策略：最近最少使用

# 内存缓存对象类型
quick_abort_min 0 KB                # 取消下载的最小阈值
quick_abort_max 0 KB                # 取消下载的最大阈值
```

**🔸 内存缓存工作原理**：
```
用户请求 → 检查内存缓存 → 命中直接返回
                     ↓ 未命中
                检查磁盘缓存 → 命中加载到内存并返回
                     ↓ 未命中
                从源服务器获取 → 存储到缓存并返回
```

### 2.3 磁盘缓存配置


```bash
# 磁盘缓存目录设置
cache_dir ufs /var/spool/squid 10000 16 256

# 参数解释：
# ufs: 文件系统类型
# /var/spool/squid: 缓存目录路径
# 10000: 缓存大小（MB）
# 16: 一级子目录数量
# 256: 二级子目录数量

# 大对象存储
maximum_object_size 1 GB            # 最大缓存对象1GB
minimum_object_size 0 KB             # 最小缓存对象
```

### 2.4 缓存类型选择策略


| 内容类型 | **推荐缓存方式** | **原因** |
|---------|-----------------|---------|
| 🖼️ **小图片** | `内存缓存` | `访问频繁，快速响应` |
| 📄 **CSS/JS文件** | `内存+磁盘` | `中等大小，经常访问` |
| 🎥 **视频文件** | `磁盘缓存` | `文件太大，内存放不下` |
| 📊 **API响应** | `内存缓存` | `数据小，需要快速响应` |
| 📦 **软件包** | `磁盘缓存` | `文件大，但下载频繁` |

---

## 3. ⏰ 缓存生存时间设置


### 3.1 缓存生存时间概念


**TTL（Time To Live）**：缓存对象在Squid中保存的时间，超过这个时间就被认为过期。

**三个关键时间参数**：
- **最小时间**：对象至少缓存多长时间
- **百分比**：基于对象年龄的动态时间
- **最大时间**：对象最多缓存多长时间

### 3.2 refresh_pattern语法详解


```bash
refresh_pattern 正则表达式 最小时间 百分比% 最大时间 [选项]

# 实际示例
refresh_pattern \.(jpg|png|gif)$ 1440 90% 10080 override-expire
```

**参数含义**：
- `\.(jpg|png|gif)$`：匹配图片文件
- `1440`：最少缓存1440分钟（24小时）
- `90%`：如果对象年龄小于90%的过期时间，认为仍然新鲜
- `10080`：最多缓存10080分钟（7天）
- `override-expire`：忽略服务器的过期头信息

### 3.3 不同类型文件的TTL配置


```bash
# 静态图片：长时间缓存
refresh_pattern \.(jpg|jpeg|png|gif|bmp|ico)$ 1440 90% 10080

# CSS和JavaScript：中等时间缓存
refresh_pattern \.(css|js)$ 60 80% 1440

# HTML页面：短时间缓存
refresh_pattern \.(html|htm)$ 5 50% 60

# 动态内容：几乎不缓存
refresh_pattern \.(php|asp|jsp)$ 0 0% 5

# 默认规则：放在最后
refresh_pattern . 30 20% 1440
```

### 3.4 缓存时间计算实例


> 📝 **实际计算例子**：
> 
> 一个CSS文件配置：`refresh_pattern \.css$ 60 80% 1440`
> 
> **场景1**：服务器说这个文件1小时后过期
> - 对象年龄：30分钟
> - 80% × 60分钟 = 48分钟
> - 30分钟 < 48分钟，所以文件仍然新鲜，继续使用缓存
> 
> **场景2**：服务器说这个文件1小时后过期
> - 对象年龄：50分钟  
> - 80% × 60分钟 = 48分钟
> - 50分钟 > 48分钟，所以文件可能过期，需要重新验证

---

## 4. 📁 缓存目录层级结构


### 4.1 为什么需要目录层级


**问题**：如果把所有缓存文件都放在一个目录下会怎样？

```
单一目录的问题：
/var/spool/squid/
├── file1
├── file2
├── file3
├── ... (可能有几十万个文件)
└── fileN

结果：
❌ 文件查找变慢
❌ 目录操作耗时
❌ 文件系统性能下降
```

**解决方案**：使用多级目录分散文件

### 4.2 Squid目录结构配置


```bash
# 基本目录配置
cache_dir ufs /var/spool/squid 10000 16 256

# 配置解释：
# 一级目录：16个 (00-0F，十六进制)
# 二级目录：每个一级目录下256个 (00-FF，十六进制)
# 总共：16 × 256 = 4096个最终目录
```

**实际目录结构**：
```
/var/spool/squid/
├── 00/
│   ├── 00/  ← 最终存放缓存文件
│   ├── 01/
│   ├── ...
│   └── FF/
├── 01/
│   ├── 00/
│   └── ...
├── ...
└── 0F/
    └── ...
```

### 4.3 目录数量选择策略


| 缓存文件数量 | **一级目录** | **二级目录** | **总目录数** | **平均每目录文件数** |
|-------------|-------------|-------------|-------------|-------------------|
| **1万个文件** | `4` | `64` | `256` | `~39个` |
| **10万个文件** | `8` | `128` | `1024` | `~98个` |
| **100万个文件** | `16` | `256` | `4096` | `~244个` |
| **1000万个文件** | `32` | `512` | `16384` | `~610个` |

> 💡 **最佳实践**：每个最终目录下保持100-500个文件为最佳性能

### 4.4 多磁盘缓存配置


```bash
# 使用多个磁盘提高IO性能
cache_dir ufs /cache1/squid 5000 16 256
cache_dir ufs /cache2/squid 5000 16 256
cache_dir ufs /cache3/squid 5000 16 256

# Squid会自动在多个cache_dir之间分配缓存
# 总缓存空间：15GB
# IO压力分散到3个磁盘上
```

---

## 5. 🧹 缓存清理机制


### 5.1 缓存清理的必要性


**为什么需要清理缓存**：
- 🔸 **磁盘空间有限**：缓存会逐渐填满磁盘
- 🔸 **内容更新**：源服务器内容变化，旧缓存需要清理
- 🔸 **性能优化**：清理过期和无用缓存提高效率

### 5.2 自动清理机制


**LRU（Least Recently Used）算法**：
```bash
# 缓存替换策略配置
cache_replacement_policy lru    # 使用LRU算法
memory_replacement_policy lru   # 内存也使用LRU

# 工作原理：
# 当缓存空间不足时，自动删除最近最少使用的对象
```

**缓存水位控制**：
```bash
# 缓存目录水位设置
cache_dir ufs /var/spool/squid 10000 16 256

# 当缓存使用达到95%时开始清理
# 清理到90%时停止
# 这些是Squid的默认行为
```

### 5.3 手动清理工具


**squidclient工具**：
```bash
# 清理特定URL的缓存
squidclient -m PURGE http://example.com/style.css

# 清理域名下所有缓存
squidclient -m PURGE http://example.com/.*

# 查看缓存信息
squidclient mgr:info
squidclient mgr:storedir
```

**批量清理脚本示例**：
```bash
#!/bin/bash
# 清理指定域名的所有缓存

DOMAIN="example.com"
SQUID_HOST="localhost"
SQUID_PORT="3128"

# 获取缓存URL列表并清理
squidclient -h $SQUID_HOST -p $SQUID_PORT mgr:objects | \
grep $DOMAIN | \
while read url; do
    squidclient -h $SQUID_HOST -p $SQUID_PORT -m PURGE "$url"
    echo "已清理: $url"
done
```

### 5.4 定期清理配置


```bash
# crontab定期清理任务
# 每天凌晨2点清理过期缓存
0 2 * * * /usr/sbin/squid -k rotate

# 每周日凌晨清理所有缓存统计
0 3 * * 0 /usr/sbin/squid -k reconfigure

# 磁盘空间监控脚本
*/10 * * * * /scripts/check_cache_space.sh
```

---

## 6. 📊 缓存命中率监控


### 6.1 什么是缓存命中率


**命中率定义**：用户请求中有多少比例是从缓存直接返回的，而不需要去源服务器获取。

```
计算公式：
命中率 = (缓存命中次数 ÷ 总请求次数) × 100%

例如：
100个请求中，80个来自缓存，20个来自源服务器
命中率 = 80 ÷ 100 × 100% = 80%
```

### 6.2 监控命中率的方法


**使用squidclient工具**：
```bash
# 查看基本统计信息
squidclient mgr:info

# 查看详细的缓存统计
squidclient mgr:5min    # 最近5分钟统计
squidclient mgr:60min   # 最近60分钟统计

# 查看特定类型的命中率
squidclient mgr:counters
```

**日志分析方法**：
```bash
# 分析访问日志中的命中情况
# TCP_HIT = 缓存命中
# TCP_MISS = 缓存未命中
# TCP_MEM_HIT = 内存缓存命中

tail -f /var/log/squid/access.log | grep -E "(TCP_HIT|TCP_MISS|TCP_MEM_HIT)"
```

### 6.3 命中率监控脚本


```bash
#!/bin/bash
# 简单的命中率监控脚本

LOG_FILE="/var/log/squid/access.log"
RESULT_FILE="/tmp/squid_stats.txt"

# 统计最近1000条记录
TOTAL=$(tail -1000 $LOG_FILE | wc -l)
HIT=$(tail -1000 $LOG_FILE | grep -c "TCP_HIT\|TCP_MEM_HIT")
MISS=$(tail -1000 $LOG_FILE | grep -c "TCP_MISS")

if [ $TOTAL -gt 0 ]; then
    HIT_RATE=$(echo "scale=2; $HIT * 100 / $TOTAL" | bc)
    echo "总请求: $TOTAL" > $RESULT_FILE
    echo "缓存命中: $HIT" >> $RESULT_FILE
    echo "缓存未命中: $MISS" >> $RESULT_FILE
    echo "命中率: ${HIT_RATE}%" >> $RESULT_FILE
fi
```

### 6.4 命中率优化目标


**不同类型内容的命中率目标**：

| 内容类型 | **目标命中率** | **说明** |
|---------|---------------|---------|
| 🖼️ **静态图片** | `90%+` | `图片很少变化，应该高命中率` |
| 📄 **CSS/JS文件** | `85%+` | `样式脚本更新不频繁` |
| 📰 **新闻页面** | `70%+` | `内容更新较频繁` |
| 🔄 **API接口** | `50-70%` | `数据动态性较强` |
| 🛒 **用户相关页面** | `30-50%` | `个性化内容较多` |

> ⚠️ **注意**：命中率不是越高越好，要平衡内容新鲜度

---

## 7. ⚡ 缓存性能调优参数


### 7.1 内存相关参数优化


```bash
# 内存分配优化
cache_mem 2048 MB                          # 根据服务器内存调整
maximum_object_size_in_memory 512 KB       # 增大内存对象上限
memory_replacement_policy heap LFUDA       # 使用更智能的替换算法

# 内存池配置
memory_pools on                            # 启用内存池
memory_pools_limit 50 MB                   # 内存池大小限制
```

**内存分配建议**：
- **总内存8GB以下**：cache_mem设为总内存的1/8
- **总内存8-32GB**：cache_mem设为总内存的1/4  
- **总内存32GB以上**：cache_mem设为总内存的1/3

### 7.2 网络连接优化


```bash
# HTTP连接优化
client_lifetime 1 day                      # 客户端连接保持时间
half_closed_clients off                    # 关闭半开连接支持
pconn_timeout 60 seconds                   # 持久连接超时

# 并发连接控制
http_port 3128 defaultsite=cache.example.com
maximum_object_size 100 MB                 # 最大对象大小
read_timeout 15 minutes                    # 读取超时
request_timeout 5 minutes                  # 请求超时
```

### 7.3 磁盘IO优化


```bash
# 磁盘缓存优化
cache_dir aufs /var/spool/squid 20000 64 256    # 使用异步IO
read_ahead_gap 16 KB                            # 预读间隙
store_dir_select_algorithm least-load           # 负载均衡选择算法

# 日志优化
cache_store_log none                            # 禁用存储日志减少IO
logfile_rotate 4                               # 日志轮转数量
debug_options ALL,1                            # 降低调试级别
```

### 7.4 CPU和处理优化


```bash
# 处理器优化
workers auto                               # 自动检测CPU核心数
cpu_affinity_map process_numbers=1,2,3,4 cores=0,1,2,3

# DNS解析优化
dns_nameservers 8.8.8.8 8.8.4.4          # 使用快速DNS服务器
dns_timeout 30 seconds                    # DNS超时时间
positive_dns_ttl 6 hours                  # DNS正向缓存时间
negative_dns_ttl 1 minute                 # DNS负向缓存时间
```

### 7.5 性能监控参数


```bash
# 启用性能统计
log_fqdn off                              # 不记录完整域名减少开销
buffered_logs on                          # 启用日志缓冲
netdb_low 900                            # 网络数据库下限
netdb_high 1000                          # 网络数据库上限

# 统计信息收集
cachemgr_passwd secret_password info stats objects
```

---

## 8. 📦 大文件缓存策略


### 8.1 大文件缓存的挑战


**大文件缓存面临的问题**：
- 🔸 **存储空间**：大文件消耗大量磁盘空间
- 🔸 **下载时间**：大文件下载可能被中断
- 🔸 **带宽占用**：影响其他用户的访问
- 🔸 **缓存效率**：大文件可能挤占小文件缓存空间

### 8.2 大文件识别和分类


```bash
# 定义大文件ACL
acl big_files_video urlpath_regex \.(mp4|avi|mkv|mov|wmv|flv)$
acl big_files_software urlpath_regex \.(iso|dmg|exe|msi|deb|rpm)$
acl big_files_archive urlpath_regex \.(zip|rar|7z|tar\.gz|tar\.bz2)$

# 大小限制ACL
acl size_100mb req_header Content-Length ^1[0-9]{8}    # 100MB+
acl size_500mb req_header Content-Length ^[5-9][0-9]{8} # 500MB+
```

### 8.3 大文件缓存配置策略


**分层缓存策略**：
```bash
# 小文件：优先内存缓存
acl small_files maxconn 50
cache_dir ufs /cache/small 5000 32 256
cache allow small_files

# 中等文件：磁盘缓存
acl medium_files maxconn 20  
cache_dir ufs /cache/medium 10000 16 256
maximum_object_size 50 MB

# 大文件：特殊处理
acl large_files maxconn 5
cache_dir ufs /cache/large 50000 8 128
maximum_object_size 1 GB
```

### 8.4 大文件下载优化


**Range请求支持**：
```bash
# 支持断点续传
range_offset_limit -1                     # 不限制Range请求
quick_abort_min -1 KB                     # 不快速中断下载
quick_abort_max -1 KB                     # 允许完整下载
quick_abort_pct 100                       # 下载百分比阈值

# 大文件专用配置
acl big_download urlpath_regex \.(iso|zip|exe)$
delay_pools 1                             # 创建延迟池
delay_class 1 1                          # 延迟类别
delay_access 1 allow big_download         # 应用到大文件
delay_parameters 1 2048000/2048000        # 限速2MB/s
```

### 8.5 大文件缓存清理策略


```bash
# 大文件专门的清理策略
acl big_files_cleanup urlpath_regex \.(mp4|avi|iso|zip)$
refresh_pattern \.(mp4|avi)$ 60 50% 1440 reload-into-ims
refresh_pattern \.(iso|zip)$ 1440 80% 10080

# 基于访问频率的清理
# 大文件如果7天没有访问就清理
logformat cleanup_format %ts %rm %ru %Ss %sh
access_log /var/log/squid/cleanup.log cleanup_format big_files_cleanup

# 清理脚本示例
#!/bin/bash
# 清理7天未访问的大文件缓存
find /var/spool/squid -name "*.big" -atime +7 -delete
```

### 8.6 大文件缓存监控


```bash
# 监控大文件缓存使用情况
#!/bin/bash
echo "=== 大文件缓存统计 ==="
du -sh /cache/large
echo "大文件数量: $(find /cache/large -type f | wc -l)"
echo "平均文件大小: $(du -s /cache/large | awk '{print $1/1024 "MB"}')"

# 监控大文件下载
tail -f /var/log/squid/access.log | \
grep -E '\.(mp4|avi|iso|zip)' | \
awk '{print $7, $5, $6}' | \
while read url size time; do
    echo "下载: $url 大小: ${size}字节 时间: $time"
done
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 缓存策略：控制什么内容缓存、缓存多长时间的规则体系
🔸 内存vs磁盘：内存缓存速度快但容量小，磁盘缓存容量大但速度慢
🔸 TTL机制：通过refresh_pattern控制缓存对象的生存时间
🔸 目录结构：多级目录分散文件，提高文件系统性能
🔸 命中率：衡量缓存效果的核心指标，需要持续监控和优化
🔸 性能调优：从内存、网络、磁盘、CPU多方面进行优化
🔸 大文件处理：需要特殊的缓存策略和清理机制
```

### 9.2 关键理解要点


**🔹 缓存策略的本质**
```
核心思想：
- 热门内容放内存，快速响应
- 大文件放磁盘，节省内存
- 动态内容短缓存，静态内容长缓存
- 根据访问模式调整策略
```

**🔹 缓存时间设置原则**
```
设置要点：
- 静态资源：长时间缓存（天/周级别）
- 动态内容：短时间缓存（分钟/小时级别）
- 关键内容：实时更新，几乎不缓存
- 平衡内容新鲜度和缓存效益
```

**🔹 性能优化的思路**
```
优化层次：
1. 硬件层：足够的内存和快速磁盘
2. 配置层：合理的缓存策略和参数
3. 监控层：持续监控和调整
4. 应用层：配合应用的缓存策略
```

### 9.3 实际应用指导


**💡 部署建议**
```
硬件配置：
- 内存：至少8GB，推荐16GB+
- 磁盘：SSD做缓存，机械盘做大文件存储
- 网络：千兆网卡起步，万兆更佳

配置原则：
- 根据业务类型调整缓存策略
- 定期监控命中率和性能指标
- 建立缓存清理和维护机制
- 做好容量规划和扩展准备
```

**🔧 运维要点**
```
日常维护：
- 监控磁盘空间使用情况
- 定期清理过期和无用缓存
- 分析访问日志优化缓存策略
- 备份重要的配置文件

故障处理：
- 缓存命中率突然下降的排查
- 磁盘空间不足的紧急处理
- 大文件下载慢的性能优化
- 缓存数据损坏的恢复方法
```

### 9.4 常见问题解决


**🐛 缓存相关问题**
- **命中率低**：检查缓存策略、TTL设置、内容类型配置
- **磁盘空间满**：增加清理策略、调整缓存大小、添加存储
- **大文件下载慢**：优化网络参数、启用Range支持、限速控制
- **内存使用高**：调整cache_mem、减少内存对象大小限制

**核心记忆**：
- Squid缓存管理的核心是平衡性能、空间和内容新鲜度
- 合理的缓存策略能显著提高用户访问速度
- 监控和调优是保持缓存系统高效运行的关键
- 大文件缓存需要特殊考虑，避免影响整体性能