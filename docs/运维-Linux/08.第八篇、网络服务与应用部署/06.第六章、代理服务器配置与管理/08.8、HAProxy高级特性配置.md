---
title: 8ã€HAProxyé«˜çº§ç‰¹æ€§é…ç½®
---
## ğŸ“š ç›®å½•

1. [SSL/TLSç»ˆç«¯é…ç½®](#1-SSL-TLSç»ˆç«¯é…ç½®)
2. [HTTPé‡å®šå‘è§„åˆ™](#2-HTTPé‡å®šå‘è§„åˆ™)
3. [è¯·æ±‚é‡å†™ä¸ä¿®æ”¹](#3-è¯·æ±‚é‡å†™ä¸ä¿®æ”¹)
4. [å‹ç¼©åŠŸèƒ½é…ç½®](#4-å‹ç¼©åŠŸèƒ½é…ç½®)
5. [é™é€Ÿä¸é™æµé…ç½®](#5-é™é€Ÿä¸é™æµé…ç½®)
6. [é»‘åå•IPè¿‡æ»¤](#6-é»‘åå•IPè¿‡æ»¤)
7. [è‡ªå®šä¹‰é”™è¯¯é¡µé¢](#7-è‡ªå®šä¹‰é”™è¯¯é¡µé¢)
8. [ç»Ÿè®¡ä¿¡æ¯é¡µé¢é…ç½®](#8-ç»Ÿè®¡ä¿¡æ¯é¡µé¢é…ç½®)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ SSL/TLSç»ˆç«¯é…ç½®


### 1.1 ä»€ä¹ˆæ˜¯SSLç»ˆç«¯


**ç®€å•ç†è§£**ï¼šSSLç»ˆç«¯å°±æ˜¯è®©HAProxyæ¥å¤„ç†HTTPSçš„åŠ å¯†è§£å¯†å·¥ä½œï¼Œè€Œä¸æ˜¯è®©åç«¯æœåŠ¡å™¨å¤„ç†ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼š
å®¢æˆ·ç«¯ --HTTPS--> åç«¯æœåŠ¡å™¨ï¼ˆéœ€è¦å¤„ç†SSLï¼‰

SSLç»ˆç«¯æ–¹å¼ï¼š
å®¢æˆ·ç«¯ --HTTPS--> HAProxy --HTTP--> åç«¯æœåŠ¡å™¨ï¼ˆå‡è½»è´Ÿæ‹…ï¼‰
```

**ä¸ºä»€ä¹ˆè¦ç”¨SSLç»ˆç«¯**ï¼š
- ğŸ”¸ **å‡è½»åç«¯è´Ÿæ‹…**ï¼šåŠ å¯†è§£å¯†å¾ˆæ¶ˆè€—CPUï¼Œè®©HAProxyæ¥åš
- ğŸ”¸ **ç»Ÿä¸€è¯ä¹¦ç®¡ç†**ï¼šæ‰€æœ‰è¯ä¹¦éƒ½åœ¨HAProxyä¸Šç®¡ç†ï¼Œæ–¹ä¾¿
- ğŸ”¸ **æé«˜æ€§èƒ½**ï¼šHAProxyä¸“é—¨ä¼˜åŒ–è¿‡SSLå¤„ç†ï¼Œæ¯”æ™®é€šwebæœåŠ¡å™¨å¿«

### 1.2 åŸºç¡€SSLé…ç½®


**ğŸ”§ æœ€ç®€å•çš„SSLé…ç½®**
```bash
# /etc/haproxy/haproxy.cfg
frontend https_frontend
    bind *:443 ssl crt /etc/ssl/certs/website.pem
    default_backend web_servers

backend web_servers
    server web1 192.168.1.10:80 check
    server web2 192.168.1.11:80 check
```

**é…ç½®è¯´æ˜**ï¼š
- `bind *:443 ssl`ï¼šç›‘å¬443ç«¯å£å¹¶å¯ç”¨SSL
- `crt /path/to/cert.pem`ï¼šæŒ‡å®šè¯ä¹¦æ–‡ä»¶è·¯å¾„
- è¯ä¹¦æ–‡ä»¶éœ€è¦åŒ…å«**ç§é’¥+è¯ä¹¦+ä¸­é—´è¯ä¹¦**ï¼ˆéƒ½æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œï¼‰

### 1.3 è¯ä¹¦æ–‡ä»¶å‡†å¤‡


**ğŸ“‹ è¯ä¹¦æ–‡ä»¶æ ¼å¼è¦æ±‚**
```bash
# åˆå¹¶è¯ä¹¦æ–‡ä»¶ï¼ˆé¡ºåºå¾ˆé‡è¦ï¼‰
cat server.key server.crt intermediate.crt > /etc/ssl/certs/website.pem

# æ–‡ä»¶å†…å®¹é¡ºåºï¼š
# 1. ç§é’¥ (-----BEGIN PRIVATE KEY-----)
# 2. æœåŠ¡å™¨è¯ä¹¦ (-----BEGIN CERTIFICATE-----)  
# 3. ä¸­é—´è¯ä¹¦ (-----BEGIN CERTIFICATE-----)
```

**è®¾ç½®æ­£ç¡®æƒé™**ï¼š
```bash
# è¯ä¹¦æ–‡ä»¶æƒé™è®¾ç½®
chmod 600 /etc/ssl/certs/website.pem
chown haproxy:haproxy /etc/ssl/certs/website.pem
```

### 1.4 å¤šè¯ä¹¦é…ç½®


**ğŸŒ æ”¯æŒå¤šä¸ªåŸŸå**
```bash
frontend https_frontend
    bind *:443 ssl crt-list /etc/haproxy/cert-list.txt
    
    # æ ¹æ®åŸŸååˆ†å‘åˆ°ä¸åŒåç«¯
    acl is_api hdr(host) -i api.example.com
    acl is_www hdr(host) -i www.example.com
    
    use_backend api_servers if is_api
    use_backend web_servers if is_www
```

**è¯ä¹¦åˆ—è¡¨æ–‡ä»¶** `/etc/haproxy/cert-list.txt`ï¼š
```
/etc/ssl/certs/api.example.com.pem
/etc/ssl/certs/www.example.com.pem  
/etc/ssl/certs/default.pem
```

### 1.5 SSLå®‰å…¨å¢å¼º


**ğŸ” å®‰å…¨é…ç½®é€‰é¡¹**
```bash
frontend https_frontend
    bind *:443 ssl crt /etc/ssl/certs/website.pem 
    
    # åªå…è®¸å®‰å…¨çš„SSLç‰ˆæœ¬
    ssl-min-ver TLSv1.2
    
    # æŒ‡å®šå®‰å…¨çš„åŠ å¯†å¥—ä»¶
    ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384
    
    # ç¦ç”¨ä¸å®‰å…¨çš„SSLç‰ˆæœ¬
    no-sslv3
    no-tlsv10
    no-tlsv11
```

---

## 2. ğŸ”„ HTTPé‡å®šå‘è§„åˆ™


### 2.1 é‡å®šå‘æ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼šé‡å®šå‘å°±æ˜¯å‘Šè¯‰æµè§ˆå™¨"ä½ è¦è®¿é—®çš„ç½‘é¡µæ¬åˆ°åˆ«çš„åœ°æ–¹äº†ï¼Œå»é‚£è¾¹æ‰¾å§"ã€‚

**å¸¸è§é‡å®šå‘åœºæ™¯**ï¼š
- HTTPå¼ºåˆ¶è·³è½¬åˆ°HTTPS
- wwwåŸŸåè·³è½¬åˆ°éwwwåŸŸå
- æ—§ç½‘å€è·³è½¬åˆ°æ–°ç½‘å€
- ç»´æŠ¤é¡µé¢è·³è½¬

### 2.2 HTTPåˆ°HTTPSé‡å®šå‘


**ğŸ”’ å¼ºåˆ¶ä½¿ç”¨HTTPS**
```bash
# æ–¹æ³•1ï¼šç®€å•é‡å®šå‘
frontend http_frontend
    bind *:80
    redirect scheme https if !{ ssl_fc }

# æ–¹æ³•2ï¼šä¿æŒåŸå§‹URL
frontend http_frontend  
    bind *:80
    redirect scheme https code 301 if !{ ssl_fc }
```

**é…ç½®è§£é‡Š**ï¼š
- `redirect scheme https`ï¼šé‡å®šå‘åˆ°HTTPSåè®®
- `!{ ssl_fc }`ï¼šå¦‚æœä¸æ˜¯SSLè¿æ¥
- `code 301`ï¼šæ°¸ä¹…é‡å®šå‘çŠ¶æ€ç 

### 2.3 åŸŸåé‡å®šå‘


**ğŸŒ wwwåŸŸåå¤„ç†**
```bash
frontend web_frontend
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/website.pem
    
    # wwwè·³è½¬åˆ°éwww
    acl is_www hdr_beg(host) -i www.
    redirect prefix https://example.com code 301 if is_www
    
    default_backend web_servers
```

### 2.4 è·¯å¾„é‡å®šå‘


**ğŸ“‚ ç‰¹å®šè·¯å¾„é‡å®šå‘**
```bash
frontend web_frontend
    bind *:80
    
    # æ—§çš„ç®¡ç†é¡µé¢è·³è½¬åˆ°æ–°åœ°å€
    acl old_admin path_beg /admin
    redirect location /new-admin code 301 if old_admin
    
    # ä¸´æ—¶ç»´æŠ¤é¡µé¢
    acl maintenance path_beg /maintenance  
    redirect location /under-construction.html if maintenance
    
    default_backend web_servers
```

### 2.5 æ¡ä»¶é‡å®šå‘


**âš¡ åŸºäºæ¡ä»¶çš„é‡å®šå‘**
```bash
frontend web_frontend
    bind *:80
    
    # ç§»åŠ¨è®¾å¤‡é‡å®šå‘åˆ°ç§»åŠ¨ç‰ˆ
    acl is_mobile hdr_sub(user-agent) -i mobile
    redirect location https://m.example.com if is_mobile
    
    # ç‰¹å®šIPé‡å®šå‘åˆ°ç»´æŠ¤é¡µ
    acl maintenance_ip src 192.168.1.0/24
    redirect location /maintenance.html if maintenance_ip
    
    default_backend web_servers
```

---

## 3. âœï¸ è¯·æ±‚é‡å†™ä¸ä¿®æ”¹


### 3.1 ä»€ä¹ˆæ˜¯è¯·æ±‚é‡å†™


**ç®€å•ç†è§£**ï¼šè¯·æ±‚é‡å†™å°±æ˜¯ä¿®æ”¹å®¢æˆ·ç«¯å‘æ¥çš„HTTPè¯·æ±‚ï¼Œæ¯”å¦‚æ”¹URLã€åŠ è¯·æ±‚å¤´ã€æ”¹è¯·æ±‚æ–¹æ³•ç­‰ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦é‡å†™**ï¼š
- ğŸ”¸ **åç«¯å…¼å®¹**ï¼šåç«¯ç³»ç»Ÿè·¯å¾„ä¸ä¸€æ ·ï¼Œéœ€è¦è½¬æ¢
- ğŸ”¸ **å®‰å…¨éšè—**ï¼šéšè—åç«¯çœŸå®è·¯å¾„ç»“æ„
- ğŸ”¸ **ç»Ÿä¸€æ¥å£**ï¼šå¤šä¸ªç‰ˆæœ¬APIç»Ÿä¸€å…¥å£

### 3.2 URLè·¯å¾„é‡å†™


**ğŸ“‚ è·¯å¾„è½¬æ¢ç¤ºä¾‹**
```bash
frontend api_frontend
    bind *:80
    
    # ç§»é™¤APIç‰ˆæœ¬å‰ç¼€
    acl is_v1_api path_beg /api/v1/
    http-request replace-path /api/v1/(.*) /\1 if is_v1_api
    
    # æ·»åŠ ç»Ÿä¸€å‰ç¼€
    acl need_prefix path_beg /users
    http-request replace-path ^/users(.*) /api/users\1 if need_prefix
    
    default_backend api_servers
```

**é‡å†™è§„åˆ™è§£é‡Š**ï¼š
- `replace-path`ï¼šæ›¿æ¢URLè·¯å¾„
- `^/users(.*)` â†’ `/api/users\1`ï¼šåœ¨å‰é¢åŠ ä¸Š/apiå‰ç¼€
- `\1`ï¼šè¡¨ç¤ºç¬¬ä¸€ä¸ªæ‹¬å·åŒ¹é…çš„å†…å®¹

### 3.3 è¯·æ±‚å¤´ä¿®æ”¹


**ğŸ“ æ·»åŠ å’Œä¿®æ”¹è¯·æ±‚å¤´**
```bash
frontend web_frontend
    bind *:80
    
    # æ·»åŠ å®¢æˆ·ç«¯çœŸå®IP
    http-request set-header X-Real-IP %[src]
    
    # æ·»åŠ åè®®ä¿¡æ¯
    http-request set-header X-Forwarded-Proto http
    
    # åˆ é™¤æ•æ„Ÿå¤´ä¿¡æ¯
    http-request del-header X-Powered-By
    
    # ä¿®æ”¹User-Agentï¼ˆå¦‚æœéœ€è¦ï¼‰
    http-request set-header User-Agent "HAProxy-Client" if some_condition
    
    default_backend web_servers
```

### 3.4 å“åº”ä¿®æ”¹


**ğŸ“¤ ä¿®æ”¹æœåŠ¡å™¨å“åº”**
```bash
backend web_servers
    server web1 192.168.1.10:80 check
    
    # æ·»åŠ å®‰å…¨å“åº”å¤´
    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff
    
    # ç§»é™¤æœåŠ¡å™¨ç‰ˆæœ¬ä¿¡æ¯
    http-response del-header Server
    
    # æ·»åŠ è‡ªå®šä¹‰å“åº”å¤´
    http-response set-header X-Served-By HAProxy
```

### 3.5 æ¡ä»¶é‡å†™


**âš¡ åŸºäºæ¡ä»¶çš„é‡å†™**
```bash
frontend api_frontend
    bind *:80
    
    # åªå¯¹POSTè¯·æ±‚æ·»åŠ ç‰¹æ®Šå¤´
    acl is_post method POST
    http-request set-header X-Request-Type API-POST if is_post
    
    # ç§»åŠ¨è®¾å¤‡è¯·æ±‚æ·»åŠ æ ‡è¯†
    acl is_mobile hdr_sub(user-agent) -i mobile
    http-request set-header X-Device-Type mobile if is_mobile
    
    default_backend api_servers
```

---

## 4. ğŸ—œï¸ å‹ç¼©åŠŸèƒ½é…ç½®


### 4.1 å‹ç¼©çš„ä½œç”¨


**é€šä¿—è§£é‡Š**ï¼šå‹ç¼©å°±æ˜¯æŠŠç½‘é¡µå†…å®¹"æ‰“åŒ…å‹ç¼©"å†å‘ç»™ç”¨æˆ·ï¼Œå°±åƒæŠŠæ–‡ä»¶å‹ç¼©æˆzipä¸€æ ·ï¼Œèƒ½å¤§å¤§å‡å°‘ä¼ è¾“æ—¶é—´ã€‚

**å‹ç¼©æ•ˆæœ**ï¼š
- ğŸ”¸ **èŠ‚çœå¸¦å®½**ï¼šæ–‡ä»¶å°äº†ï¼Œä¼ è¾“å¿«äº†
- ğŸ”¸ **æå‡é€Ÿåº¦**ï¼šç”¨æˆ·æ‰“å¼€ç½‘é¡µæ›´å¿«
- ğŸ”¸ **é™ä½æˆæœ¬**ï¼šå‡å°‘æœåŠ¡å™¨å¸¦å®½æ¶ˆè€—

### 4.2 åŸºç¡€å‹ç¼©é…ç½®


**ğŸ—œï¸ å¯ç”¨å‹ç¼©åŠŸèƒ½**
```bash
global
    # å¯ç”¨å‹ç¼©ï¼ˆéœ€è¦ç¼–è¯‘æ—¶æ”¯æŒï¼‰
    tune.comp.maxlevel 6

frontend web_frontend
    bind *:80
    
    # å¯ç”¨å‹ç¼©
    compression algo gzip
    compression type text/html text/plain text/css text/javascript application/javascript application/json
    
    default_backend web_servers
```

**é…ç½®è¯´æ˜**ï¼š
- `compression algo gzip`ï¼šä½¿ç”¨gzipå‹ç¼©ç®—æ³•
- `compression type`ï¼šæŒ‡å®šå“ªäº›æ–‡ä»¶ç±»å‹éœ€è¦å‹ç¼©
- `tune.comp.maxlevel 6`ï¼šå‹ç¼©çº§åˆ«ï¼ˆ1-9ï¼Œ6æ˜¯å¹³è¡¡ç‚¹ï¼‰

### 4.3 å‹ç¼©æ¡ä»¶æ§åˆ¶


**âš¡ æ™ºèƒ½å‹ç¼©ç­–ç•¥**
```bash
frontend web_frontend
    bind *:80
    
    # åªå‹ç¼©å¤§äº1KBçš„æ–‡ä»¶
    compression algo gzip
    compression type text/html text/plain text/css application/javascript
    
    # ä¸å‹ç¼©å·²ç»å‹ç¼©çš„æ–‡ä»¶
    compression offload
    
    default_backend web_servers
```

### 4.4 å‹ç¼©æ•ˆæœç›‘æ§


**ğŸ“Š æŸ¥çœ‹å‹ç¼©ç»Ÿè®¡**
```bash
# åœ¨statsé¡µé¢å¯ä»¥çœ‹åˆ°å‹ç¼©ç»Ÿè®¡
frontend web_frontend
    bind *:80
    compression algo gzip
    compression type text/html text/css application/javascript
    
    default_backend web_servers

# é€šè¿‡æ—¥å¿—æŸ¥çœ‹å‹ç¼©æ¯”ä¾‹
# æ—¥å¿—ä¸­ä¼šæ˜¾ç¤ºå‹ç¼©å‰åçš„å¤§å°
```

---

## 5. ğŸš¦ é™é€Ÿä¸é™æµé…ç½®


### 5.1 é™é€Ÿé™æµçš„åŒºåˆ«


**é€šä¿—è§£é‡Š**ï¼š
- **é™é€Ÿ**ï¼šæ§åˆ¶æ•°æ®ä¼ è¾“é€Ÿåº¦ï¼Œå°±åƒé™åˆ¶æ±½è½¦æœ€é«˜æ—¶é€Ÿ
- **é™æµ**ï¼šæ§åˆ¶åŒæ—¶å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼Œå°±åƒé™åˆ¶å•†åº—åŒæ—¶è¿›å…¥çš„äººæ•°

### 5.2 è¿æ¥æ•°é™åˆ¶


**ğŸ‘¥ æ§åˆ¶å¹¶å‘è¿æ¥**
```bash
# å…¨å±€è¿æ¥é™åˆ¶
global
    maxconn 4000
    
# å‰ç«¯è¿æ¥é™åˆ¶
frontend web_frontend
    bind *:80
    maxconn 2000
    
    default_backend web_servers

# åç«¯æœåŠ¡å™¨è¿æ¥é™åˆ¶  
backend web_servers
    server web1 192.168.1.10:80 maxconn 500 check
    server web2 192.168.1.11:80 maxconn 500 check
```

### 5.3 è¯·æ±‚é¢‘ç‡é™åˆ¶


**â±ï¸ é™åˆ¶è¯·æ±‚é¢‘ç‡**
```bash
# éœ€è¦ä½¿ç”¨stick-tableæ¥è·Ÿè¸ªè¯·æ±‚
backend web_servers
    # åˆ›å»ºç²˜æ€§è¡¨è·Ÿè¸ªIPè¯·æ±‚é¢‘ç‡
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    
    # è®°å½•æ¯ä¸ªIPçš„è¯·æ±‚
    http-request track-sc0 src
    
    # é™åˆ¶æ¯10ç§’æœ€å¤š20ä¸ªè¯·æ±‚
    http-request deny if { sc_http_req_rate(0) gt 20 }
    
    server web1 192.168.1.10:80 check
    server web2 192.168.1.11:80 check
```

### 5.4 å¸¦å®½é™åˆ¶


**ğŸ“Š æ§åˆ¶ä¼ è¾“é€Ÿåº¦**
```bash
frontend web_frontend
    bind *:80
    
    # å¯¹ç‰¹å®šè·¯å¾„é™åˆ¶å¸¦å®½
    acl slow_path path_beg /downloads/
    use_backend slow_backend if slow_path
    
    default_backend normal_backend

backend slow_backend
    # é™åˆ¶åˆ°100KB/s
    server web1 192.168.1.10:80 check maxconn 50
    rate-limit sessions 10

backend normal_backend  
    server web1 192.168.1.10:80 check
```

### 5.5 IPé»‘åå•ä¸ç™½åå•


**ğŸš« è®¿é—®æ§åˆ¶**
```bash
frontend web_frontend
    bind *:80
    
    # æ‹’ç»ç‰¹å®šIPæ®µ
    acl blocked_ips src 192.168.100.0/24 10.0.0.0/8
    http-request deny if blocked_ips
    
    # åªå…è®¸ç‰¹å®šIPè®¿é—®ç®¡ç†é¡µé¢
    acl admin_path path_beg /admin
    acl allowed_admin_ips src 192.168.1.0/24
    http-request deny if admin_path !allowed_admin_ips
    
    default_backend web_servers
```

---

## 6. ğŸ›¡ï¸ é»‘åå•IPè¿‡æ»¤


### 6.1 é»‘åå•çš„ä½œç”¨


**å®‰å…¨é˜²æŠ¤**ï¼šé»‘åå•å°±åƒé—¨å«ï¼ŒæŠŠå·²çŸ¥çš„"åäºº"æ‹’ä¹‹é—¨å¤–ï¼Œä¿æŠ¤ç½‘ç«™å®‰å…¨ã€‚

**å¸¸è§åº”ç”¨åœºæ™¯**ï¼š
- ğŸ”¸ **æ”»å‡»é˜²æŠ¤**ï¼šé˜»æ­¢å·²çŸ¥æ”»å‡»è€…IP
- ğŸ”¸ **çˆ¬è™«æ§åˆ¶**ï¼šé™åˆ¶æ¶æ„çˆ¬è™«è®¿é—®  
- ğŸ”¸ **åŒºåŸŸé™åˆ¶**ï¼šé˜»æ­¢ç‰¹å®šå›½å®¶/åœ°åŒºè®¿é—®
- ğŸ”¸ **åƒåœ¾æµé‡**ï¼šè¿‡æ»¤æ— æ•ˆè®¿é—®

### 6.2 é™æ€IPé»‘åå•


**ğŸ“‹ æ‰‹åŠ¨ç»´æŠ¤é»‘åå•**
```bash
# åˆ›å»ºé»‘åå•æ–‡ä»¶
# /etc/haproxy/blacklist.txt
192.168.100.5
192.168.100.10/32
10.0.0.0/8
172.16.0.0/12

# HAProxyé…ç½®
frontend web_frontend
    bind *:80
    
    # åŠ è½½é»‘åå•æ–‡ä»¶
    acl blacklisted_ips src -f /etc/haproxy/blacklist.txt
    http-request deny if blacklisted_ips
    
    default_backend web_servers
```

### 6.3 åŠ¨æ€é»‘åå•


**âš¡ è‡ªåŠ¨æ£€æµ‹å’Œé˜»æ­¢**
```bash
frontend web_frontend
    bind *:80
    
    # è·Ÿè¸ªIPè¯·æ±‚é¢‘ç‡
    stick-table type ip size 100k expire 300s store http_req_rate(10s),http_err_rate(10s)
    http-request track-sc0 src
    
    # è¯·æ±‚è¿‡å¿«çš„IPåŠ å…¥é»‘åå•
    acl abuse_req_rate sc_http_req_rate(0) gt 50
    acl abuse_err_rate sc_http_err_rate(0) gt 10
    
    http-request deny if abuse_req_rate
    http-request deny if abuse_err_rate
    
    default_backend web_servers
```

### 6.4 åœ°ç†ä½ç½®è¿‡æ»¤


**ğŸŒ åŸºäºå›½å®¶/åœ°åŒºè¿‡æ»¤**
```bash
# ä½¿ç”¨GeoIPæ•°æ®åº“ï¼ˆéœ€è¦å®‰è£…geoip-databaseï¼‰
frontend web_frontend
    bind *:80
    
    # é˜»æ­¢ç‰¹å®šå›½å®¶
    acl blocked_countries src,map_ip(/etc/haproxy/geoip.map,XX) -m str CN RU
    http-request deny if blocked_countries
    
    default_backend web_servers
```

### 6.5 é»‘åå•ç®¡ç†è„šæœ¬


**ğŸ”§ è‡ªåŠ¨åŒ–ç®¡ç†å·¥å…·**
```bash
#!/bin/bash
# blacklist_manager.sh - é»‘åå•ç®¡ç†è„šæœ¬

BLACKLIST_FILE="/etc/haproxy/blacklist.txt"
LOG_FILE="/var/log/haproxy.log"

# æ·»åŠ IPåˆ°é»‘åå•
add_ip() {
    echo "$1" >> $BLACKLIST_FILE
    systemctl reload haproxy
    echo "å·²æ·»åŠ  $1 åˆ°é»‘åå•"
}

# ä»æ—¥å¿—ä¸­è‡ªåŠ¨æ£€æµ‹æ”»å‡»IP
detect_attacks() {
    # æŸ¥æ‰¾1åˆ†é’Ÿå†…è¯·æ±‚è¶…è¿‡100æ¬¡çš„IP
    tail -n 1000 $LOG_FILE | \
    awk '{print $6}' | \
    sort | uniq -c | \
    awk '$1 > 100 {print $2}' | \
    while read ip; do
        if ! grep -q "$ip" $BLACKLIST_FILE; then
            add_ip "$ip"
        fi
    done
}

# ä½¿ç”¨æ–¹æ³•
# ./blacklist_manager.sh detect  # è‡ªåŠ¨æ£€æµ‹
# ./blacklist_manager.sh add 192.168.1.100  # æ‰‹åŠ¨æ·»åŠ 
```

---

## 7. ğŸ¨ è‡ªå®šä¹‰é”™è¯¯é¡µé¢


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰é”™è¯¯é¡µé¢


**ç”¨æˆ·ä½“éªŒ**ï¼šå½“ç½‘ç«™å‡ºé”™æ—¶ï¼Œæ˜¾ç¤ºå‹å¥½çš„é”™è¯¯é¡µé¢æ¯”æµè§ˆå™¨é»˜è®¤çš„é”™è¯¯é¡µé¢æ›´ä¸“ä¸šã€‚

**å¸¸è§é”™è¯¯åœºæ™¯**ï¼š
- ğŸ”¸ **503é”™è¯¯**ï¼šæœåŠ¡å™¨ä¸´æ—¶ä¸å¯ç”¨
- ğŸ”¸ **502é”™è¯¯**ï¼šåç«¯æœåŠ¡å™¨æ•…éšœ
- ğŸ”¸ **404é”™è¯¯**ï¼šé¡µé¢ä¸å­˜åœ¨
- ğŸ”¸ **403é”™è¯¯**ï¼šè®¿é—®è¢«æ‹’ç»

### 7.2 åŸºç¡€é”™è¯¯é¡µé¢é…ç½®


**ğŸ¨ è®¾ç½®è‡ªå®šä¹‰é”™è¯¯é¡µé¢**
```bash
# HAProxyé…ç½®
global
    # æŒ‡å®šé”™è¯¯é¡µé¢ç›®å½•
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http  
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http
```

### 7.3 é”™è¯¯é¡µé¢æ–‡ä»¶æ ¼å¼


**ğŸ“„ é”™è¯¯é¡µé¢æ–‡ä»¶å†…å®¹**
```http
# /etc/haproxy/errors/503.http
HTTP/1.0 503 Service Unavailable
Cache-Control: no-cache
Connection: close
Content-Type: text/html

<!DOCTYPE html>
<html>
<head>
    <title>æœåŠ¡æš‚æ—¶ä¸å¯ç”¨</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 100px; }
        .error-box { max-width: 500px; margin: 0 auto; }
        h1 { color: #e74c3c; }
    </style>
</head>
<body>
    <div class="error-box">
        <h1>ğŸš§ æœåŠ¡ç»´æŠ¤ä¸­</h1>
        <p>æˆ‘ä»¬æ­£åœ¨è¿›è¡Œç³»ç»Ÿç»´æŠ¤ï¼Œè¯·ç¨åå†è¯•ã€‚</p>
        <p>é¢„è®¡æ¢å¤æ—¶é—´ï¼š5åˆ†é’Ÿ</p>
        <a href="/">è¿”å›é¦–é¡µ</a>
    </div>
</body>
</html>
```

**âš ï¸ é‡è¦æ ¼å¼è¦æ±‚**ï¼š
- å¿…é¡»åŒ…å«å®Œæ•´çš„HTTPå“åº”å¤´
- ç¬¬ä¸€è¡Œæ˜¯çŠ¶æ€ç 
- ç©ºè¡Œåˆ†éš”å¤´éƒ¨å’Œå†…å®¹
- æ–‡ä»¶ç¼–ç å¿…é¡»æ˜¯UTF-8

### 7.4 åŠ¨æ€é”™è¯¯é¡µé¢


**âš¡ æ ¹æ®æ¡ä»¶æ˜¾ç¤ºä¸åŒé”™è¯¯é¡µ**
```bash
frontend web_frontend
    bind *:80
    
    # ç»´æŠ¤æ¨¡å¼æ£€æŸ¥
    acl maintenance_mode nbsrv(web_servers) eq 0
    
    # ç»´æŠ¤æœŸé—´æ˜¾ç¤ºç‰¹æ®Šé¡µé¢
    http-request return status 503 content-type text/html file /etc/haproxy/maintenance.html if maintenance_mode
    
    default_backend web_servers

backend web_servers
    # å¥åº·æ£€æŸ¥å¤±è´¥æ—¶ä¼šè§¦å‘503é”™è¯¯
    server web1 192.168.1.10:80 check
    server web2 192.168.1.11:80 check
```

### 7.5 é”™è¯¯é¡µé¢æœ€ä½³å®è·µ


**ğŸ’¡ è®¾è®¡å»ºè®®**ï¼š
```bash
# åˆ›å»ºé”™è¯¯é¡µé¢ç›®å½•
mkdir -p /etc/haproxy/errors

# é”™è¯¯é¡µé¢åº”è¯¥åŒ…å«çš„å…ƒç´ ï¼š
# 1. æ¸…æ™°çš„é”™è¯¯è¯´æ˜
# 2. é¢„è®¡æ¢å¤æ—¶é—´ï¼ˆå¦‚æœçŸ¥é“ï¼‰
# 3. è”ç³»æ–¹å¼æˆ–å¸®åŠ©é“¾æ¥
# 4. è¿”å›é¦–é¡µçš„é“¾æ¥
# 5. ç®€æ´çš„CSSæ ·å¼

# æ–‡ä»¶æƒé™è®¾ç½®
chmod 644 /etc/haproxy/errors/*.http
chown haproxy:haproxy /etc/haproxy/errors/*.http
```

---

## 8. ğŸ“Š ç»Ÿè®¡ä¿¡æ¯é¡µé¢é…ç½®


### 8.1 ç»Ÿè®¡é¡µé¢çš„ä½œç”¨


**ç›‘æ§åˆ©å™¨**ï¼šç»Ÿè®¡é¡µé¢å°±åƒæ±½è½¦çš„ä»ªè¡¨ç›˜ï¼Œè®©ä½ éšæ—¶äº†è§£HAProxyçš„è¿è¡ŒçŠ¶æ€ã€‚

**èƒ½çœ‹åˆ°ä»€ä¹ˆä¿¡æ¯**ï¼š
- ğŸ”¸ **æœåŠ¡å™¨çŠ¶æ€**ï¼šå“ªäº›æœåŠ¡å™¨åœ¨çº¿/ç¦»çº¿
- ğŸ”¸ **è¿æ¥ç»Ÿè®¡**ï¼šå½“å‰è¿æ¥æ•°ã€æ€»è¿æ¥æ•°
- ğŸ”¸ **æµé‡ç»Ÿè®¡**ï¼šæ•°æ®ä¼ è¾“é‡ã€è¯·æ±‚æ•°
- ğŸ”¸ **é”™è¯¯ç»Ÿè®¡**ï¼šå„ç§é”™è¯¯çš„æ¬¡æ•°
- ğŸ”¸ **å“åº”æ—¶é—´**ï¼šæœåŠ¡å™¨å“åº”é€Ÿåº¦

### 8.2 åŸºç¡€ç»Ÿè®¡é…ç½®


**ğŸ“Š å¯ç”¨ç»Ÿè®¡é¡µé¢**
```bash
# æ·»åŠ ç»Ÿè®¡é…ç½®æ®µ
listen stats
    bind *:8080
    stats enable
    stats uri /haproxy-stats
    stats realm "HAProxy Statistics"
    stats auth admin:password123
    stats refresh 30s
```

**é…ç½®è§£é‡Š**ï¼š
- `bind *:8080`ï¼šç»Ÿè®¡é¡µé¢ç›‘å¬8080ç«¯å£
- `stats uri /haproxy-stats`ï¼šè®¿é—®è·¯å¾„
- `stats auth`ï¼šç”¨æˆ·åå’Œå¯†ç 
- `stats refresh 30s`ï¼šæ¯30ç§’è‡ªåŠ¨åˆ·æ–°

**è®¿é—®æ–¹å¼**ï¼šæµè§ˆå™¨æ‰“å¼€ `http://æœåŠ¡å™¨IP:8080/haproxy-stats`

### 8.3 é«˜çº§ç»Ÿè®¡é…ç½®


**âš¡ æ›´ä¸°å¯Œçš„ç»Ÿè®¡åŠŸèƒ½**
```bash
listen stats
    bind *:8080
    stats enable
    stats uri /stats
    stats realm "HAProxyç›‘æ§ä¸­å¿ƒ"
    
    # ç”¨æˆ·è®¤è¯
    stats auth admin:admin123
    stats auth readonly:view123
    
    # ç®¡ç†åŠŸèƒ½
    stats admin if TRUE
    
    # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
    stats show-legends
    stats show-node
    
    # è‡ªåŠ¨åˆ·æ–°
    stats refresh 5s
    
    # éšè—ç‰ˆæœ¬ä¿¡æ¯
    stats hide-version
```

### 8.4 å®‰å…¨è®¿é—®æ§åˆ¶


**ğŸ”’ ä¿æŠ¤ç»Ÿè®¡é¡µé¢**
```bash
listen stats
    bind 127.0.0.1:8080  # åªå…è®¸æœ¬åœ°è®¿é—®
    stats enable
    stats uri /secret-stats-page
    
    # IPè®¿é—®æ§åˆ¶
    acl allowed_ips src 192.168.1.0/24 127.0.0.1
    http-request deny unless allowed_ips
    
    # å¼ºå¯†ç è®¤è¯
    stats auth admin:VeryStr0ngP@ssw0rd
    
    stats admin if TRUE
```

### 8.5 ç»Ÿè®¡æ•°æ®è§£è¯»


**ğŸ“ˆ é‡è¦æŒ‡æ ‡è¯´æ˜**

| å­—æ®µåç§° | **å«ä¹‰** | **æ­£å¸¸èŒƒå›´** | **å¼‚å¸¸æƒ…å†µ** |
|---------|---------|-------------|-------------|
| `Status` | `æœåŠ¡å™¨çŠ¶æ€` | `UP (ç»¿è‰²)` | `DOWN (çº¢è‰²)` |
| `Sessions` | `å½“å‰è¿æ¥æ•°` | `< æœ€å¤§è¿æ¥æ•°80%` | `æ¥è¿‘æˆ–è¾¾åˆ°ä¸Šé™` |
| `Bytes In/Out` | `æµé‡ç»Ÿè®¡` | `ç¨³å®šå¢é•¿` | `çªç„¶æ¿€å¢æˆ–ä¸º0` |
| `Denied Req` | `è¢«æ‹’ç»è¯·æ±‚` | `å¾ˆå°‘æˆ–ä¸º0` | `å¤§é‡æ‹’ç»` |
| `Errors` | `é”™è¯¯æ•°é‡` | `å¾ˆå°‘` | `æŒç»­å¢é•¿` |
| `Response Time` | `å“åº”æ—¶é—´` | `< 500ms` | `> 2000ms` |

**ğŸš¨ å‘Šè­¦æŒ‡æ ‡**ï¼š
- æœåŠ¡å™¨çŠ¶æ€å˜ä¸ºDOWN
- é”™è¯¯ç‡è¶…è¿‡5%
- å“åº”æ—¶é—´è¶…è¿‡2ç§’
- è¿æ¥æ•°æ¥è¿‘ä¸Šé™

### 8.6 ç»Ÿè®¡APIæ¥å£


**ğŸ”Œ ç¨‹åºåŒ–è·å–ç»Ÿè®¡æ•°æ®**
```bash
# è·å–CSVæ ¼å¼ç»Ÿè®¡æ•°æ®
curl "http://admin:password123@localhost:8080/stats;csv"

# è·å–ç‰¹å®šåç«¯çš„ç»Ÿè®¡
curl "http://admin:password123@localhost:8080/stats;csv" | grep "web_servers"

# è·å–JSONæ ¼å¼æ•°æ®ï¼ˆå¦‚æœæ”¯æŒï¼‰
curl "http://admin:password123@localhost:8080/stats?stats;json"
```

**ç›‘æ§è„šæœ¬ç¤ºä¾‹**ï¼š
```bash
#!/bin/bash
# monitor_haproxy.sh - HAProxyç›‘æ§è„šæœ¬

STATS_URL="http://admin:password123@localhost:8080/stats;csv"

# æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
check_servers() {
    curl -s "$STATS_URL" | grep -v "^#" | while IFS=',' read pxname svname status; do
        if [[ "$status" == "DOWN" && "$svname" != "BACKEND" ]]; then
            echo "è­¦å‘Š: æœåŠ¡å™¨ $pxname/$svname å·²ä¸‹çº¿"
            # å‘é€å‘Šè­¦é‚®ä»¶æˆ–çŸ­ä¿¡
        fi
    done
}

check_servers
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ SSLç»ˆç«¯ï¼šHAProxyå¤„ç†HTTPSåŠ å¯†ï¼Œå‡è½»åç«¯è´Ÿæ‹…
ğŸ”¸ é‡å®šå‘ï¼šè‡ªåŠ¨è·³è½¬URLï¼Œå¸¸ç”¨äºHTTPåˆ°HTTPS
ğŸ”¸ è¯·æ±‚é‡å†™ï¼šä¿®æ”¹è¯·æ±‚å†…å®¹ï¼Œå®ç°è·¯å¾„è½¬æ¢å’Œå¤´éƒ¨æ“ä½œ
ğŸ”¸ å‹ç¼©åŠŸèƒ½ï¼šå‡å°‘ä¼ è¾“æ•°æ®é‡ï¼Œæå‡è®¿é—®é€Ÿåº¦
ğŸ”¸ é™æµé™é€Ÿï¼šæ§åˆ¶å¹¶å‘å’Œå¸¦å®½ï¼Œä¿æŠ¤æœåŠ¡ç¨³å®š
ğŸ”¸ é»‘åå•ï¼šé˜»æ­¢æ¶æ„IPè®¿é—®ï¼Œæå‡å®‰å…¨æ€§
ğŸ”¸ é”™è¯¯é¡µé¢ï¼šå‹å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œä¸“ä¸šçš„æ•…éšœå¤„ç†
ğŸ”¸ ç»Ÿè®¡ç›‘æ§ï¼šå®æ—¶äº†è§£ç³»ç»ŸçŠ¶æ€ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
```

### 9.2 é…ç½®ä¼˜å…ˆçº§ç†è§£


**ğŸ”¹ é…ç½®ç”Ÿæ•ˆé¡ºåº**
```
è¯·æ±‚å¤„ç†æµç¨‹ï¼š
å®¢æˆ·ç«¯è¯·æ±‚ â†’ SSLç»ˆç«¯å¤„ç† â†’ é»‘åå•æ£€æŸ¥ â†’ é‡å®šå‘è§„åˆ™ â†’ 
è¯·æ±‚é‡å†™ â†’ é™æµæ£€æŸ¥ â†’ åç«¯é€‰æ‹© â†’ å‹ç¼©å¤„ç† â†’ å“åº”è¿”å›

é…ç½®æ£€æŸ¥é¡ºåºï¼š
1. IPé»‘åå• (æœ€ä¼˜å…ˆ)
2. é™æµè§„åˆ™
3. é‡å®šå‘è§„åˆ™  
4. è¯·æ±‚é‡å†™
5. åç«¯é€‰æ‹©
6. å“åº”å¤„ç† (å‹ç¼©ã€é”™è¯¯é¡µé¢)
```

### 9.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ’¡ æœ€ä½³å®è·µ**ï¼š

**SSLé…ç½®**ï¼š
- âœ… ä½¿ç”¨TLS 1.2ä»¥ä¸Šç‰ˆæœ¬
- âœ… å®šæœŸæ›´æ–°è¯ä¹¦ï¼Œè®¾ç½®è‡ªåŠ¨ç»­æœŸ
- âœ… é…ç½®å®‰å…¨çš„åŠ å¯†å¥—ä»¶

**å®‰å…¨é˜²æŠ¤**ï¼š
- âœ… å¯ç”¨é»‘åå•å’Œé™æµ
- âœ… éšè—æœåŠ¡å™¨ç‰ˆæœ¬ä¿¡æ¯
- âœ… é™åˆ¶ç»Ÿè®¡é¡µé¢è®¿é—®

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- âœ… å¯ç”¨å‹ç¼©åŠŸèƒ½
- âœ… åˆç†è®¾ç½®è¿æ¥é™åˆ¶
- âœ… ç›‘æ§å“åº”æ—¶é—´å’Œé”™è¯¯ç‡

**è¿ç»´ç®¡ç†**ï¼š
- âœ… é…ç½®ç»Ÿè®¡é¡µé¢ç›‘æ§
- âœ… è®¾ç½®å‹å¥½çš„é”™è¯¯é¡µé¢
- âœ… ç¼–å†™è‡ªåŠ¨åŒ–ç®¡ç†è„šæœ¬

### 9.4 æ•…éšœæ’æŸ¥è¦ç‚¹


**ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­**ï¼š

| é—®é¢˜ç°è±¡ | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ³•** |
|---------|-------------|-------------|
| `SSLæ¡æ‰‹å¤±è´¥` | `è¯ä¹¦é…ç½®é”™è¯¯` | `æ£€æŸ¥è¯ä¹¦æ–‡ä»¶æ ¼å¼å’Œæƒé™` |
| `é‡å®šå‘å¾ªç¯` | `é‡å®šå‘è§„åˆ™å†²çª` | `æ£€æŸ¥ACLæ¡ä»¶å’Œè§„åˆ™é¡ºåº` |
| `502é”™è¯¯é¢‘ç¹` | `åç«¯æœåŠ¡å™¨é—®é¢˜` | `æ£€æŸ¥å¥åº·æ£€æŸ¥å’ŒæœåŠ¡å™¨çŠ¶æ€` |
| `è®¿é—®é€Ÿåº¦æ…¢` | `æœªå¯ç”¨å‹ç¼©` | `é…ç½®å‹ç¼©åŠŸèƒ½å’Œç¼“å­˜` |
| `ç»Ÿè®¡é¡µé¢403` | `è®¿é—®æ§åˆ¶è¿‡ä¸¥` | `æ£€æŸ¥IPç™½åå•å’Œè®¤è¯é…ç½®` |

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- SSLç»ˆç«¯å‡è´Ÿæ‹…ï¼Œè¯ä¹¦åˆå¹¶æƒé™ç®¡
- é‡å®šå‘è§„åˆ™è¦æœ‰åºï¼Œæ¡ä»¶åˆ¤æ–­ä¸èƒ½ä¹±  
- è¯·æ±‚é‡å†™æ”¹è·¯å¾„ï¼Œå®‰å…¨å¤´éƒ¨è¦æ·»åŠ 
- å‹ç¼©é™æµä¿æ€§èƒ½ï¼Œé»‘åå•æŠŠé—¨çœ‹
- é”™è¯¯é¡µé¢è¦å‹å¥½ï¼Œç»Ÿè®¡ç›‘æ§ä¸èƒ½å°‘