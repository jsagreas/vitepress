---
title: 4、SSH安全加固配置
---
## 📚 目录

1. [SSH安全基础概念](#1-SSH安全基础概念)
2. [密钥认证与密码禁用](#2-密钥认证与密码禁用)
3. [用户访问控制策略](#3-用户访问控制策略)
4. [主机密钥验证机制](#4-主机密钥验证机制)
5. [加密算法强度配置](#5-加密算法强度配置)
6. [登录安全防护措施](#6-登录安全防护措施)
7. [双因素认证配置](#7-双因素认证配置)
8. [SSH蜜罐检测防护](#8-SSH蜜罐检测防护)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔐 SSH安全基础概念


### 1.1 什么是SSH安全加固


**简单理解**：就像给你家的门换更好的锁，设置更严格的进门规则

```
普通家门安全 → SSH默认配置
• 普通锁     → 密码登录
• 任何人敲门 → 任意用户尝试
• 门牌显眼   → 默认22端口

加固后的安全 → SSH安全配置
• 电子锁     → 密钥认证
• 白名单访客 → 限制用户
• 隐蔽位置   → 修改端口
```

### 1.2 SSH安全威胁现状


**🚨 常见安全问题**：
- **暴力破解**：机器人程序不停试密码
- **弱密码攻击**：使用常见密码字典攻击
- **内部威胁**：员工离职后仍能登录
- **中间人攻击**：网络劫持SSH连接

**💡 为什么要加固SSH**：
```
未加固风险：
普通密码 → 容易被破解 → 系统被入侵 → 数据泄露/系统破坏

加固后效果：
强密钥认证 → 几乎不可破解 → 系统安全 → 数据和业务安全
```

### 1.3 SSH配置文件位置


**📁 关键配置文件**：
```bash
# SSH服务端配置（最重要）
/etc/ssh/sshd_config

# SSH客户端配置
/etc/ssh/ssh_config
~/.ssh/config

# 主机密钥文件
/etc/ssh/ssh_host_*_key
```

⭐⭐⭐ **重要提醒**：修改配置前一定要备份！

```bash
# 备份原配置文件
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.$(date +%Y%m%d)
```

---

## 2. 🗝️ 密钥认证与密码禁用


### 2.1 为什么要禁用密码认证


**🔍 密码 vs 密钥对比**：

| 认证方式 | **安全性** | **便利性** | **被破解风险** |
|---------|----------|----------|-------------|
| 🔑 **密钥认证** | `极高` | `高（一次配置）` | `几乎为零` |
| 🔐 **密码认证** | `低` | `高（每次输入）` | `很高` |

**💭 生活类比**：
- **密码认证**：就像用普通钥匙，别人可能配出一把一样的
- **密钥认证**：就像指纹锁，每个人的指纹都是独一无二的

### 2.2 SSH密钥对工作原理


```
密钥对组成：
┌─────────────┐    ┌─────────────┐
│  私钥文件    │    │   公钥文件   │
│ (保密存储)   │    │ (可以公开)   │
│ id_rsa      │    │ id_rsa.pub  │
└─────────────┘    └─────────────┘
     客户端              服务器

工作流程：
客户端: "我要登录，这是我的身份证明"
服务器: "让我验证一下..." (用公钥验证)
服务器: "验证通过，欢迎登录！"
```

### 2.3 生成和配置SSH密钥


**🛠️ 第一步：生成密钥对**：

```bash
# 生成RSA密钥对（推荐2048位或更高）
ssh-keygen -t rsa -b 4096 -C "your-email@example.com"

# 更安全的Ed25519算法（推荐）
ssh-keygen -t ed25519 -C "your-email@example.com"
```

**🛠️ 第二步：将公钥复制到服务器**：

```bash
# 最简单的方法
ssh-copy-id username@server_ip

# 手动方法
cat ~/.ssh/id_rsa.pub | ssh username@server_ip "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

### 2.4 强制密钥认证配置


**⚙️ 修改SSH服务配置**：

```bash
# 编辑SSH配置文件
sudo nano /etc/ssh/sshd_config
```

**🔧 关键配置选项**：

```bash
# 禁用密码认证（强制使用密钥）
PasswordAuthentication no

# 禁用空密码登录
PermitEmptyPasswords no

# 启用公钥认证
PubkeyAuthentication yes

# 指定公钥文件位置
AuthorizedKeysFile .ssh/authorized_keys

# 禁用质询响应认证
ChallengeResponseAuthentication no
```

**🔄 重启SSH服务使配置生效**：

```bash
# 重启SSH服务
sudo systemctl restart sshd

# 检查服务状态
sudo systemctl status sshd
```

⚠️ **安全提醒**：配置密钥认证后，请保持一个SSH会话不断开，用另一个会话测试登录，确保配置正确！

---

## 3. 👥 用户访问控制策略


### 3.1 root用户登录限制


**🚫 为什么要限制root登录**：
- **风险太大**：root权限可以删除整个系统
- **审计困难**：无法追踪具体是谁的操作
- **攻击目标**：黑客最想获得的就是root权限

**🔒 root登录限制策略**：

```bash
# 完全禁止root登录（推荐）
PermitRootLogin no

# 仅允许密钥登录root（次选）
PermitRootLogin prohibit-password

# 允许root登录（不推荐）
PermitRootLogin yes
```

**💡 最佳实践**：
```
正确做法：
1. 禁用root SSH登录
2. 创建普通用户账号
3. 配置sudo权限
4. 需要管理权限时用sudo
```

### 3.2 用户白名单控制


**🎯 AllowUsers - 只允许指定用户**：

```bash
# 只允许特定用户登录
AllowUsers alice bob charlie

# 允许特定用户从特定IP登录
AllowUsers alice@192.168.1.100 bob@192.168.1.*

# 允许用户从特定网段登录
AllowUsers charlie@192.168.0.0/24
```

**🚫 DenyUsers - 禁止指定用户**：

```bash
# 禁止特定用户登录
DenyUsers guest test

# 禁止用户从特定IP登录
DenyUsers baduser@*
```

**📋 用户组控制**：

```bash
# 只允许特定组的用户
AllowGroups ssh-users admins

# 禁止特定组的用户
DenyGroups guests temp-users
```

### 3.3 实际配置示例


**🏢 企业环境配置示例**：

```bash
# 禁止root登录
PermitRootLogin no

# 只允许运维组和开发组登录
AllowGroups ops-team dev-team

# 禁止测试账号登录生产环境
DenyUsers test* guest* temp*

# 限制管理员只能从办公网络登录
AllowUsers admin@192.168.10.0/24
```

**🔍 配置验证**：

```bash
# 检查当前登录用户
who

# 检查SSH登录日志
sudo tail -f /var/log/auth.log | grep ssh

# 测试用户登录
ssh -o ConnectTimeout=5 testuser@localhost
```

---

## 4. 🔍 主机密钥验证机制


### 4.1 什么是主机密钥验证


**🏠 简单理解**：就像确认你敲的是正确的门

```
第一次连接服务器：
客户端: "你是192.168.1.100服务器吗？"
服务器: "是的，这是我的身份证明（主机密钥）"
客户端: "记住了，以后我认准这个身份证明"

后续连接：
客户端: "出示你的身份证明"
服务器: "给你看（相同的主机密钥）"
客户端: "确认无误，建立连接"
```

### 4.2 StrictHostKeyChecking配置


**🔐 严格模式配置选项**：

| 配置值 | **含义** | **安全性** | **使用场景** |
|--------|---------|----------|-------------|
| `yes` | `严格检查，不匹配就拒绝` | `最高` | `生产环境` |
| `no` | `不检查，自动接受` | `最低` | `测试环境` |
| `ask` | `不匹配时询问用户` | `中等` | `开发环境` |

**⚙️ 客户端配置**：

```bash
# 全局配置 /etc/ssh/ssh_config
Host *
    StrictHostKeyChecking yes

# 用户配置 ~/.ssh/config  
Host production-server
    HostName 192.168.1.100
    StrictHostKeyChecking yes
    
Host test-server
    HostName 192.168.1.200
    StrictHostKeyChecking ask
```

### 4.3 主机密钥管理


**📁 主机密钥存储位置**：

```bash
# 系统级已知主机
/etc/ssh/ssh_known_hosts

# 用户级已知主机  
~/.ssh/known_hosts
```

**🛠️ 主机密钥操作**：

```bash
# 查看服务器主机密钥指纹
ssh-keyscan -t rsa 192.168.1.100

# 手动添加主机密钥
ssh-keyscan -H 192.168.1.100 >> ~/.ssh/known_hosts

# 删除主机密钥（当服务器重装后）
ssh-keygen -R 192.168.1.100

# 验证主机密钥
ssh-keygen -l -f ~/.ssh/known_hosts
```

**⚠️ 主机密钥变化警告处理**：

```
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$@

出现这个警告的原因：
✅ 服务器重新安装了系统
✅ 服务器更换了主机密钥
❌ 可能遭受中间人攻击

处理方法：
1. 确认服务器确实有变化
2. 删除旧的主机密钥记录
3. 重新连接并接受新密钥
```

---

## 5. 🔒 加密算法强度配置


### 5.1 为什么要配置强加密算法


**🛡️ 加密强度对比**：

```
弱加密算法（已过时）：
RC4, DES → 几分钟就能破解
MD5, SHA1 → 已被证明不安全

强加密算法（现代标准）：
AES-256 → 目前最强对称加密
RSA-4096 → 强非对称加密
Ed25519 → 新一代椭圆曲线加密
```

**💭 生活类比**：
- **弱加密**：用透明玻璃做保险箱
- **强加密**：用军用级别的钢材做保险箱

### 5.2 密钥交换算法配置


**🔄 推荐的密钥交换算法**：

```bash
# SSH服务端配置
KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512
```

**❌ 禁用不安全算法**：

```bash
# 禁用弱密钥交换算法
KexAlgorithms -diffie-hellman-group1-sha1,-diffie-hellman-group14-sha1
```

### 5.3 对称加密算法配置


**🔐 推荐加密算法**：

```bash
# 强对称加密算法
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes256-ctr

# 禁用弱加密算法
Ciphers -3des-cbc,-aes128-cbc,-blowfish-cbc
```

### 5.4 消息认证码(MAC)配置


**✅ 推荐MAC算法**：

```bash
# 强消息认证算法
MACs hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com

# 禁用弱MAC算法
MACs -hmac-md5,-hmac-sha1
```

### 5.5 完整的强加密配置


**🔧 生产环境推荐配置**：

```bash
# /etc/ssh/sshd_config 强加密配置

# 协议版本（只用SSH 2）
Protocol 2

# 密钥交换算法
KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group16-sha512

# 对称加密算法  
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes256-ctr

# 消息认证码
MACs hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com

# 主机密钥算法
HostKeyAlgorithms ssh-ed25519,rsa-sha2-512,rsa-sha2-256
```

**🧪 测试加密强度**：

```bash
# 检查SSH支持的算法
ssh -Q cipher
ssh -Q mac  
ssh -Q kex

# 测试连接使用的算法
ssh -v user@server 2>&1 | grep -E "(kex|cipher|mac)"
```

---

## 6. 🛡️ 登录安全防护措施


### 6.1 登录失败限制配置


**🚫 为什么要限制登录失败次数**：
- **防暴力破解**：阻止机器人不断尝试密码
- **降低日志噪音**：减少大量失败登录记录
- **保护系统资源**：避免大量连接消耗资源

**⚙️ SSH内置限制配置**：

```bash
# 最大认证尝试次数
MaxAuthTries 3

# 最大未认证连接数
MaxStartups 10:30:100

# 登录宽限时间（秒）
LoginGraceTime 60
```

**📊 参数含义解释**：

```
MaxStartups 10:30:100 的含义：
10  → 允许10个并发未认证连接
30  → 超过10个后，有30%概率拒绝新连接
100 → 最多允许100个并发连接
```

### 6.2 使用fail2ban防护


**🔒 fail2ban工作原理**：
```
监控日志 → 发现异常 → 自动封禁 → 定时解封

监控对象：
- SSH登录失败
- 暴力破解尝试  
- 异常连接模式
```

**📦 安装fail2ban**：

```bash
# Ubuntu/Debian
sudo apt-get install fail2ban

# CentOS/RHEL
sudo yum install epel-release
sudo yum install fail2ban
```

**⚙️ fail2ban SSH配置**：

```bash
# 创建SSH监狱配置
sudo nano /etc/fail2ban/jail.local
```

```ini
[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
findtime = 600
```

**📋 配置参数说明**：

| 参数 | **含义** | **推荐值** |
|------|---------|-----------|
| `maxretry` | `失败次数限制` | `3-5次` |
| `bantime` | `封禁时长(秒)` | `3600(1小时)` |
| `findtime` | `统计时间窗口(秒)` | `600(10分钟)` |

### 6.3 端口修改防护


**🔢 为什么要修改默认端口**：
- **降低扫描**：大部分自动扫描工具扫描22端口
- **减少噪音**：显著减少恶意连接尝试
- **隐蔽性**：增加攻击者发现难度

**⚙️ 修改SSH端口**：

```bash
# 修改SSH配置
sudo nano /etc/ssh/sshd_config

# 修改端口号（避免使用常见端口）
Port 2022

# 重启SSH服务
sudo systemctl restart sshd
```

**🔥 防火墙规则更新**：

```bash
# 开放新端口
sudo ufw allow 2022/tcp

# 关闭旧端口（确认新端口可用后）
sudo ufw delete allow 22/tcp
```

### 6.4 连接限制配置


**👤 用户连接限制**：

```bash
# 每个用户最大会话数
MaxSessions 4

# 每个网络连接最大会话数  
MaxStartups 10:30:100
```

**⏰ 超时设置**：

```bash
# 客户端活跃检测间隔（秒）
ClientAliveInterval 300

# 最大检测次数
ClientAliveCountMax 2

# 空闲超时 = 300秒 × 2次 = 10分钟
```

---

## 7. 🔐 双因素认证配置


### 7.1 什么是双因素认证(2FA)


**🔒 双因素认证原理**：

```
传统单因素认证：
知道什么 → 密码/密钥

双因素认证：  
知道什么 + 拥有什么 → 密码/密钥 + 手机/令牌

安全层级对比：
单因素: 🔐
双因素: 🔐 + 📱 = 🏰（堡垒级安全）
```

**💡 生活类比**：
- **单因素**：只用钥匙开门
- **双因素**：钥匙开门 + 指纹验证

### 7.2 Google Authenticator配置


**📦 安装Google Authenticator**：

```bash
# Ubuntu/Debian
sudo apt-get install libpam-google-authenticator

# CentOS/RHEL  
sudo yum install google-authenticator
```

**⚙️ 用户配置2FA**：

```bash
# 运行配置向导
google-authenticator

# 配置选项说明
Do you want authentication tokens to be time-based? (y/n) y
# 选择y，使用时间同步令牌

Do you want to disallow multiple uses of the same token? (y/n) y  
# 选择y，防止令牌重放攻击

Do you want to do so? (y/n) y
# 更新.google_authenticator文件
```

**🔧 PAM模块配置**：

```bash
# 编辑PAM SSH配置
sudo nano /etc/pam.d/sshd

# 添加Google Authenticator支持
auth required pam_google_authenticator.so
```

**⚙️ SSH服务配置**：

```bash
# 编辑SSH配置
sudo nano /etc/ssh/sshd_config

# 启用质询响应认证
ChallengeResponseAuthentication yes

# 启用PAM认证
UsePAM yes

# 配置认证方法（密钥+2FA）
AuthenticationMethods publickey,keyboard-interactive
```

### 7.3 短信验证配置


**📱 短信2FA实现方式**：

```bash
# 安装短信发送工具
pip3 install twilio

# 创建短信验证脚本
sudo nano /usr/local/bin/sms-auth.py
```

```python
#!/usr/bin/env python3
import random
import os
from twilio.rest import Client

def send_sms_code(phone_number):
    # 生成6位验证码
    code = str(random.randint(100000, 999999))
    
    # Twilio配置
    client = Client('your_sid', 'your_token')
    
    # 发送短信
    client.messages.create(
        body=f'SSH登录验证码: {code}',
        from_='+1234567890',
        to=phone_number
    )
    
    return code
```

### 7.4 2FA最佳实践


**✅ 配置建议**：

```bash
# 备份恢复码（非常重要！）
Do you want to do so? (y/n) y
Your emergency scratch codes are:
  12345678
  87654321
  # 妥善保存这些恢复码
```

**🔄 2FA + 密钥认证组合**：

```bash
# 最安全的组合配置
AuthenticationMethods publickey,keyboard-interactive:pam

# 含义：必须同时满足
# 1. 公钥认证（你知道的）
# 2. 2FA验证（你拥有的）
```

---

## 8. 🍯 SSH蜜罐检测防护


### 8.1 什么是SSH蜜罐


**🍯 蜜罐技术原理**：

```
正常SSH服务器：
真实服务 → 提供实际功能 → 需要保护

SSH蜜罐：
伪装服务 → 记录攻击行为 → 诱捕黑客

工作流程：
黑客扫描 → 发现蜜罐 → 尝试攻击 → 被记录追踪
```

**🎣 蜜罐的作用**：
- **早期预警**：发现潜在攻击
- **攻击分析**：了解攻击手法
- **威胁情报**：收集攻击者信息
- **转移注意**：吸引攻击者注意力

### 8.2 检测SSH蜜罐方法


**🔍 蜜罐识别技巧**：

```bash
# 1. 检查SSH横幅信息
ssh -v target_host 2>&1 | grep -i "remote protocol"

# 2. 检查响应时间模式
time ssh -o ConnectTimeout=1 target_host "echo test"

# 3. 检查支持的算法
nmap --script ssh2-enum-algos -p 22 target_host

# 4. 检查系统指纹
ssh target_host "uname -a; cat /etc/os-release"
```

**⚠️ 常见蜜罐特征**：

```
可疑特征：
❌ 响应过快或过慢
❌ 支持过时的加密算法  
❌ 系统信息不一致
❌ 登录后功能受限
❌ 异常的网络拓扑
```

### 8.3 防范蜜罐检测


**🛡️ 让SSH服务更像真实环境**：

```bash
# 自定义SSH横幅
sudo nano /etc/issue.net
```

```
Ubuntu 20.04.3 LTS
Authorized users only. All activity monitored.
```

```bash
# 在SSH配置中引用横幅
Banner /etc/issue.net
```

**⚙️ 模拟真实环境**：

```bash
# 添加合理的延迟
LoginGraceTime 120

# 模拟真实的系统负载
ClientAliveInterval 300
ClientAliveCountMax 3

# 使用标准端口（或企业常用端口）
Port 22
```

### 8.4 部署SSH蜜罐


**🍯 使用cowrie蜜罐**：

```bash
# 安装依赖
sudo apt-get install python3-pip git

# 下载cowrie
git clone https://github.com/cowrie/cowrie
cd cowrie

# 安装cowrie
pip3 install -r requirements.txt
```

**⚙️ 蜜罐配置**：

```ini
# etc/cowrie.cfg
[ssh]
# 监听端口
listen_endpoints = tcp:2222:interface=0.0.0.0

# 伪装版本
ssh_version_string = SSH-2.0-OpenSSH_7.4

# 伪装系统
kernel_version = Linux 4.15.0-76-generic #86-Ubuntu
kernel_build_string = #86-Ubuntu SMP Fri Jan 17 17:24:28 UTC 2020
```

**📊 日志分析**：

```bash
# 查看蜜罐日志
tail -f var/log/cowrie/cowrie.log

# 分析攻击统计
grep "login attempt" var/log/cowrie/cowrie.log | wc -l

# 查看攻击者IP
grep "login attempt" var/log/cowrie/cowrie.log | awk '{print $8}' | sort | uniq -c
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 密钥认证：用密钥替代密码，安全性提升1000倍
🔸 用户控制：只允许可信用户访问，拒绝其他所有人
🔸 主机验证：确保连接的是正确服务器，防止中间人攻击
🔸 强加密：使用现代加密算法，淘汰过时不安全算法
🔸 失败限制：防止暴力破解，自动封禁恶意IP
🔸 双因素认证：密钥+动态码，提供堡垒级安全防护
```

### 9.2 关键理解要点


**🔹 SSH安全的层次化防护**：
```
第1层：网络防护 → 防火墙、端口修改
第2层：认证防护 → 密钥认证、2FA
第3层：访问控制 → 用户白名单、权限限制
第4层：行为监控 → 日志分析、异常检测
第5层：诱捕防护 → 蜜罐系统、攻击溯源
```

**🔹 安全与便利的平衡**：
```
高安全配置：
✅ 密钥认证 + 2FA
✅ 严格的用户控制
✅ 强加密算法
❌ 配置复杂，管理成本高

中等安全配置：
✅ 密钥认证
✅ 基本用户控制  
✅ fail2ban防护
✅ 配置简单，易于维护

选择原则：
• 生产环境 → 优先考虑安全性
• 开发环境 → 平衡安全性和便利性
• 内网环境 → 可适当降低安全要求
```

### 9.3 实际应用价值


**🎯 不同场景的配置策略**：

```
🏢 企业生产环境：
• 禁用密码认证，强制密钥
• 严格的用户白名单
• 启用2FA和审计日志
• 部署fail2ban和IDS
• 定期安全评估

🏠 个人服务器：  
• 禁用密码认证
• 修改默认端口
• 配置fail2ban
• 定期更新系统

☁️ 云服务器：
• 强化密钥管理
• 配置云防火墙
• 启用云安全监控
• 使用云原生2FA
```

**🔧 运维最佳实践**：
```
日常维护：
• 定期检查SSH日志
• 更新安全补丁
• 审查用户权限
• 备份配置文件

应急响应：
• 发现异常立即封禁
• 分析攻击来源和手法
• 加强相应防护措施
• 更新安全策略
```

**💡 安全记忆口诀**：
- SSH安全需加固，密钥认证最可靠
- 用户控制严把关，双因素认证保平安  
- 强化加密防窃听，失败限制挡攻击
- 日志监控识异常，蜜罐诱捕知敌情

**核心记住**：
- SSH安全不是一次性配置，而是持续的安全管理过程
- 安全配置要分层防护，单一措施无法提供完整保护
- 平衡安全性和可用性，根据实际需求选择合适策略
- 定期评估和更新安全配置，跟上不断演进的威胁形势