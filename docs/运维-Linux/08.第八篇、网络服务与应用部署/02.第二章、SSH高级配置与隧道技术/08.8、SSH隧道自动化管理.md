---
title: 8ã€SSHéš§é“è‡ªåŠ¨åŒ–ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [SSHéš§é“è‡ªåŠ¨åŒ–ç®¡ç†æ¦‚è¿°](#1-SSHéš§é“è‡ªåŠ¨åŒ–ç®¡ç†æ¦‚è¿°)
2. [autosshè‡ªåŠ¨é‡è¿å·¥å…·](#2-autosshè‡ªåŠ¨é‡è¿å·¥å…·)
3. [systemdæœåŠ¡åŒ–éš§é“ç®¡ç†](#3-systemdæœåŠ¡åŒ–éš§é“ç®¡ç†)
4. [éš§é“å¥åº·æ£€æŸ¥æœºåˆ¶](#4-éš§é“å¥åº·æ£€æŸ¥æœºåˆ¶)
5. [éš§é“ç›‘æ§ä¸å‘Šè­¦ç³»ç»Ÿ](#5-éš§é“ç›‘æ§ä¸å‘Šè­¦ç³»ç»Ÿ)
6. [æ‰¹é‡éš§é“éƒ¨ç½²ä¸ç®¡ç†](#6-æ‰¹é‡éš§é“éƒ¨ç½²ä¸ç®¡ç†)
7. [æ•…éšœè‡ªåŠ¨åˆ‡æ¢æœºåˆ¶](#7-æ•…éšœè‡ªåŠ¨åˆ‡æ¢æœºåˆ¶)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ SSHéš§é“è‡ªåŠ¨åŒ–ç®¡ç†æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªåŠ¨åŒ–ç®¡ç†


**ä¼ ç»ŸSSHéš§é“çš„ç—›ç‚¹**ï¼š
```
æ‰‹åŠ¨ç»´æŠ¤é—®é¢˜ï¼š
â€¢ ç½‘ç»œä¸­æ–­åéœ€è¦äººå·¥é‡è¿
â€¢ æœåŠ¡å™¨é‡å¯åéš§é“ä¸¢å¤±
â€¢ å¤šä¸ªéš§é“ç®¡ç†å¤æ‚
â€¢ æ•…éšœæ’æŸ¥å›°éš¾

ç”Ÿäº§ç¯å¢ƒéœ€æ±‚ï¼š
â€¢ 7x24å°æ—¶ç¨³å®šè¿è¡Œ
â€¢ è‡ªåŠ¨æ•…éšœæ¢å¤
â€¢ é›†ä¸­ç›‘æ§ç®¡ç†
â€¢ å¿«é€Ÿéƒ¨ç½²æ‰©å±•
```

**è‡ªåŠ¨åŒ–ç®¡ç†çš„ä»·å€¼**ï¼š
- **é«˜å¯ç”¨æ€§** - è‡ªåŠ¨é‡è¿ç¡®ä¿æœåŠ¡ä¸ä¸­æ–­
- **è¿ç»´ç®€åŒ–** - å‡å°‘äººå·¥å¹²é¢„å’Œç»´æŠ¤æˆæœ¬
- **æ•…éšœå¿«é€Ÿæ¢å¤** - ç§’çº§æ£€æµ‹å’Œæ¢å¤æœºåˆ¶
- **è§„æ¨¡åŒ–ç®¡ç†** - æ”¯æŒå¤§é‡éš§é“ç»Ÿä¸€ç®¡ç†

### 1.2 è‡ªåŠ¨åŒ–ç®¡ç†æ¶æ„å›¾


```
ç”Ÿäº§ç¯å¢ƒSSHéš§é“è‡ªåŠ¨åŒ–ç®¡ç†æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç›‘æ§ä¸­å¿ƒ   â”‚â—„â”€â”€â–ºâ”‚  é…ç½®ä¸­å¿ƒ   â”‚â—„â”€â”€â–ºâ”‚  å‘Šè­¦ç³»ç»Ÿ   â”‚
â”‚ (Monitoring)â”‚    â”‚ (Config)    â”‚    â”‚ (Alerting)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              éš§é“ç®¡ç†æ§åˆ¶å±‚                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  autossh    â”‚  systemd   â”‚  å¥åº·æ£€æŸ¥  â”‚  æ•…éšœåˆ‡æ¢   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   éš§é“A     â”‚    â”‚   éš§é“B     â”‚    â”‚   éš§é“C     â”‚
â”‚ æœ¬åœ°:8080   â”‚    â”‚ æœ¬åœ°:3306   â”‚    â”‚ æœ¬åœ°:6379   â”‚
â”‚ è¿œç¨‹:80     â”‚    â”‚ è¿œç¨‹:3306   â”‚    â”‚ è¿œç¨‹:6379   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ”§ autosshè‡ªåŠ¨é‡è¿å·¥å…·


### 2.1 autosshå·¥å…·åŸç†


**autosshæ˜¯ä»€ä¹ˆ**ï¼š
autosshæ˜¯SSHè¿æ¥çš„è‡ªåŠ¨é‡è¿å·¥å…·ï¼Œå®ƒå¯ä»¥ç›‘æ§SSHè¿æ¥çŠ¶æ€ï¼Œå½“è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡æ–°å»ºç«‹è¿æ¥ã€‚

**å·¥ä½œåŸç†**ï¼š
```
autosshå·¥ä½œæœºåˆ¶ï¼š

1. å¯åŠ¨SSHè¿æ¥
2. å»ºç«‹ç›‘æ§éš§é“(é»˜è®¤ç«¯å£20000-20001)
3. å®šæœŸå‘é€å¿ƒè·³åŒ…æ£€æµ‹è¿æ¥çŠ¶æ€
4. æ£€æµ‹åˆ°æ–­å¼€åè‡ªåŠ¨é‡è¿
5. è®°å½•è¿æ¥æ—¥å¿—å’Œç»Ÿè®¡ä¿¡æ¯

ç›‘æ§æµç¨‹ï¼š
å®¢æˆ·ç«¯ â”€â”€å¿ƒè·³åŒ…â”€â”€â†’ æœåŠ¡ç«¯
å®¢æˆ·ç«¯ â†â”€â”€å“åº”â”€â”€â”€â”€ æœåŠ¡ç«¯
  â”‚
  â–¼ (æ— å“åº”)
é‡æ–°å»ºç«‹è¿æ¥
```

### 2.2 autosshå®‰è£…é…ç½®


**å®‰è£…autossh**ï¼š
```bash
# CentOS/RHEL
sudo yum install autossh

# Ubuntu/Debian  
sudo apt-get install autossh

# éªŒè¯å®‰è£…
autossh -V
```

**åŸºæœ¬ä½¿ç”¨è¯­æ³•**ï¼š
```bash
# åŸºæœ¬è¯­æ³•
autossh [autosshé€‰é¡¹] ssh [sshé€‰é¡¹] ç›®æ ‡ä¸»æœº

# ç¤ºä¾‹ï¼šå»ºç«‹æœ¬åœ°ç«¯å£è½¬å‘
autossh -M 20000 -L 8080:localhost:80 user@remote-server

å‚æ•°è¯´æ˜ï¼š
-M 20000    # ç›‘æ§ç«¯å£ï¼Œç”¨äºå¿ƒè·³æ£€æµ‹
-L 8080:... # SSHéš§é“å‚æ•°
-f          # åå°è¿è¡Œ
-N          # ä¸æ‰§è¡Œè¿œç¨‹å‘½ä»¤
```

### 2.3 autosshå®æˆ˜é…ç½®


**é…ç½®ç¤ºä¾‹1ï¼šWebæœåŠ¡éš§é“**
```bash
# å°†è¿œç¨‹æœåŠ¡å™¨çš„80ç«¯å£æ˜ å°„åˆ°æœ¬åœ°8080
autossh -M 20000 -f -N -L 8080:localhost:80 webserver@192.168.1.100

# å¸¦é‡è¿é—´éš”çš„é…ç½®
export AUTOSSH_POLL=30        # 30ç§’æ£€æŸ¥ä¸€æ¬¡è¿æ¥
export AUTOSSH_GATETIME=30    # è¿æ¥å¤±è´¥30ç§’åé‡è¯•
autossh -M 20000 -f -N -L 8080:localhost:80 webserver@192.168.1.100
```

**é…ç½®ç¤ºä¾‹2ï¼šæ•°æ®åº“éš§é“**
```bash
# MySQLæ•°æ®åº“éš§é“(3306ç«¯å£)
autossh -M 20001 -f -N -L 3307:localhost:3306 dbuser@db-server

# Redisç¼“å­˜éš§é“(6379ç«¯å£)  
autossh -M 20002 -f -N -L 6380:localhost:6379 redis@cache-server
```

### 2.4 autosshç¯å¢ƒå˜é‡é…ç½®


**é‡è¦ç¯å¢ƒå˜é‡**ï¼š
```bash
# /etc/environment æˆ– ~/.bashrc ä¸­é…ç½®
export AUTOSSH_POLL=60           # è¿æ¥æ£€æŸ¥é—´éš”(ç§’)
export AUTOSSH_GATETIME=30       # é¦–æ¬¡è¿æ¥è¶…æ—¶æ—¶é—´
export AUTOSSH_MAXSTART=3        # æœ€å¤§é‡å¯æ¬¡æ•°  
export AUTOSSH_MAXLIFETIME=0     # è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´(0=æ— é™)
export AUTOSSH_DEBUG=1           # å¼€å¯è°ƒè¯•æ¨¡å¼
export AUTOSSH_LOGFILE=/var/log/autossh.log  # æ—¥å¿—æ–‡ä»¶è·¯å¾„
```

**é…ç½®æ–‡ä»¶ç®¡ç†**ï¼š
```bash
# åˆ›å»ºautosshé…ç½®ç›®å½•
sudo mkdir -p /etc/autossh

# åˆ›å»ºéš§é“é…ç½®æ–‡ä»¶
cat > /etc/autossh/web-tunnel.conf << 'EOF'
# WebæœåŠ¡éš§é“é…ç½®
AUTOSSH_POLL=60
AUTOSSH_GATETIME=30
AUTOSSH_MAXSTART=5
TUNNEL_CMD="autossh -M 20000 -f -N -L 8080:localhost:80 webuser@web-server"
EOF
```

---

## 3. âš™ï¸ systemdæœåŠ¡åŒ–éš§é“ç®¡ç†


### 3.1 systemdæœåŠ¡åŒ–çš„ä¼˜åŠ¿


**ä¸ºä»€ä¹ˆä½¿ç”¨systemdç®¡ç†éš§é“**ï¼š
- **å¼€æœºè‡ªå¯** - ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨å»ºç«‹éš§é“
- **è¿›ç¨‹ç®¡ç†** - è‡ªåŠ¨é‡å¯ã€çŠ¶æ€ç›‘æ§
- **æ—¥å¿—é›†æˆ** - ç»Ÿä¸€çš„æ—¥å¿—ç®¡ç†
- **ä¾èµ–ç®¡ç†** - å¯å®šä¹‰æœåŠ¡ä¾èµ–å…³ç³»
- **èµ„æºé™åˆ¶** - å¯é™åˆ¶CPUã€å†…å­˜ä½¿ç”¨

### 3.2 åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶


**Webéš§é“æœåŠ¡ç¤ºä¾‹**ï¼š
```bash
# åˆ›å»ºæœåŠ¡æ–‡ä»¶
sudo cat > /etc/systemd/system/ssh-tunnel-web.service << 'EOF'
[Unit]
Description=SSH Tunnel for Web Server
After=network.target
Wants=network.target

[Service]
Type=simple
User=tunnel-user
Group=tunnel-user
Restart=always
RestartSec=10
ExecStart=/usr/bin/autossh -M 20000 -N -L 8080:localhost:80 webuser@192.168.1.100
ExecStop=/bin/kill $MAINPID
KillMode=process
Environment="AUTOSSH_POLL=60"
Environment="AUTOSSH_GATETIME=30"  
Environment="AUTOSSH_MAXSTART=5"

[Install]
WantedBy=multi-user.target
EOF
```

**æ•°æ®åº“éš§é“æœåŠ¡ç¤ºä¾‹**ï¼š
```bash
# MySQLéš§é“æœåŠ¡
sudo cat > /etc/systemd/system/ssh-tunnel-mysql.service << 'EOF'
[Unit]
Description=SSH Tunnel for MySQL Database
After=network.target
Wants=network.target

[Service]
Type=simple
User=mysql-tunnel
Group=mysql-tunnel
Restart=always
RestartSec=15
ExecStart=/usr/bin/autossh -M 20001 -N -L 3307:localhost:3306 dbuser@db-server
ExecStop=/bin/kill $MAINPID
StandardOutput=journal
StandardError=journal
Environment="AUTOSSH_POLL=60"
Environment="AUTOSSH_GATETIME=30"

[Install]
WantedBy=multi-user.target
EOF
```

### 3.3 æœåŠ¡ç®¡ç†å‘½ä»¤


**åŸºæœ¬æ“ä½œå‘½ä»¤**ï¼š
```bash
# é‡æ–°åŠ è½½systemdé…ç½®
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start ssh-tunnel-web

# åœæ­¢æœåŠ¡  
sudo systemctl stop ssh-tunnel-web

# é‡å¯æœåŠ¡
sudo systemctl restart ssh-tunnel-web

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status ssh-tunnel-web

# å¼€æœºè‡ªå¯
sudo systemctl enable ssh-tunnel-web

# ç¦ç”¨è‡ªå¯
sudo systemctl disable ssh-tunnel-web
```

**æ‰¹é‡ç®¡ç†å¤šä¸ªéš§é“**ï¼š
```bash
# å¯åŠ¨æ‰€æœ‰éš§é“æœåŠ¡
sudo systemctl start ssh-tunnel-*

# æŸ¥çœ‹æ‰€æœ‰éš§é“çŠ¶æ€
sudo systemctl status ssh-tunnel-*

# é‡å¯æ‰€æœ‰éš§é“
sudo systemctl restart ssh-tunnel-*
```

---

## 4. ğŸ” éš§é“å¥åº·æ£€æŸ¥æœºåˆ¶


### 4.1 å¥åº·æ£€æŸ¥çš„å¿…è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦å¥åº·æ£€æŸ¥**ï¼š
- **è¿æ¥çŠ¶æ€ç›‘æ§** - å®æ—¶äº†è§£éš§é“æ˜¯å¦æ­£å¸¸å·¥ä½œ
- **æœåŠ¡å¯ç”¨æ€§æ£€æµ‹** - ç¡®è®¤ç›®æ ‡æœåŠ¡æ˜¯å¦å¯è®¿é—®
- **é¢„é˜²æ€§ç»´æŠ¤** - åœ¨é—®é¢˜æ¶åŒ–å‰åŠæ—¶å‘ç°
- **æ€§èƒ½ç›‘æ§** - ç›‘æµ‹è¿æ¥å»¶è¿Ÿå’Œååé‡

### 4.2 ç«¯å£æ£€æŸ¥è„šæœ¬


**åŸºç¡€ç«¯å£æ£€æŸ¥**ï¼š
```bash
#!/bin/bash
# æ–‡ä»¶: /usr/local/bin/check-tunnel.sh

check_port() {
    local host=$1
    local port=$2
    local timeout=${3:-5}
    
    if timeout $timeout bash -c "echo >/dev/tcp/$host/$port" 2>/dev/null; then
        return 0  # ç«¯å£å¯è¾¾
    else
        return 1  # ç«¯å£ä¸å¯è¾¾
    fi
}

# æ£€æŸ¥Webéš§é“
if check_port localhost 8080; then
    echo "âœ… Web tunnel (8080) is healthy"
else
    echo "âŒ Web tunnel (8080) is down"
    # é‡å¯æœåŠ¡
    systemctl restart ssh-tunnel-web
    logger "SSH tunnel web service restarted due to health check failure"
fi

# æ£€æŸ¥æ•°æ®åº“éš§é“
if check_port localhost 3307; then
    echo "âœ… MySQL tunnel (3307) is healthy"  
else
    echo "âŒ MySQL tunnel (3307) is down"
    systemctl restart ssh-tunnel-mysql
    logger "SSH tunnel mysql service restarted due to health check failure"
fi
```

### 4.3 æœåŠ¡å“åº”æ£€æŸ¥


**HTTPæœåŠ¡æ£€æŸ¥**ï¼š
```bash
#!/bin/bash
# æ–‡ä»¶: /usr/local/bin/check-http-tunnel.sh

check_http_service() {
    local url=$1
    local expected_code=${2:-200}
    
    response_code=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 "$url")
    
    if [ "$response_code" = "$expected_code" ]; then
        echo "âœ… HTTP service $url is responding (HTTP $response_code)"
        return 0
    else
        echo "âŒ HTTP service $url failed (HTTP $response_code)"
        return 1
    fi
}

# æ£€æŸ¥é€šè¿‡éš§é“çš„WebæœåŠ¡
if ! check_http_service "http://localhost:8080/health"; then
    echo "ğŸ”„ Restarting web tunnel service..."
    systemctl restart ssh-tunnel-web
    sleep 10
    
    # å†æ¬¡æ£€æŸ¥
    if check_http_service "http://localhost:8080/health"; then
        echo "âœ… Web tunnel recovered successfully"
    else
        echo "âš ï¸ Web tunnel still failing, sending alert"
        # å‘é€å‘Šè­¦(å°†åœ¨åé¢ç« èŠ‚è¯¦ç»†è¯´æ˜)
        /usr/local/bin/send-alert.sh "Web tunnel critical failure"
    fi
fi
```

### 4.4 æ•°æ®åº“è¿æ¥æ£€æŸ¥


**MySQLè¿æ¥æ£€æŸ¥**ï¼š
```bash
#!/bin/bash
# æ–‡ä»¶: /usr/local/bin/check-db-tunnel.sh

check_mysql_connection() {
    local host=$1
    local port=$2
    local user=$3
    local password=$4
    
    if mysql -h"$host" -P"$port" -u"$user" -p"$password" -e "SELECT 1;" >/dev/null 2>&1; then
        echo "âœ… MySQL connection through tunnel is healthy"
        return 0
    else
        echo "âŒ MySQL connection through tunnel failed"
        return 1
    fi
}

# æ£€æŸ¥MySQLéš§é“è¿æ¥
if ! check_mysql_connection localhost 3307 testuser testpass; then
    echo "ğŸ”„ Restarting MySQL tunnel..."
    systemctl restart ssh-tunnel-mysql
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 15
    
    # éªŒè¯æ¢å¤
    if check_mysql_connection localhost 3307 testuser testpass; then
        echo "âœ… MySQL tunnel recovered"
        logger "MySQL tunnel recovered after restart"
    else
        echo "âš ï¸ MySQL tunnel still failing"
        # å‘é€ç´§æ€¥å‘Šè­¦
        /usr/local/bin/send-alert.sh "MySQL tunnel critical failure" "urgent"
    fi
fi
```

### 4.5 å®šæ—¶å¥åº·æ£€æŸ¥é…ç½®


**crontabå®šæ—¶æ£€æŸ¥**ï¼š
```bash
# ç¼–è¾‘crontab
sudo crontab -e

# æ·»åŠ å®šæ—¶æ£€æŸ¥ä»»åŠ¡
# æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡éš§é“çŠ¶æ€
*/5 * * * * /usr/local/bin/check-tunnel.sh >> /var/log/tunnel-health.log 2>&1

# æ¯10åˆ†é’Ÿæ£€æŸ¥HTTPæœåŠ¡
*/10 * * * * /usr/local/bin/check-http-tunnel.sh >> /var/log/tunnel-health.log 2>&1

# æ¯15åˆ†é’Ÿæ£€æŸ¥æ•°æ®åº“è¿æ¥
*/15 * * * * /usr/local/bin/check-db-tunnel.sh >> /var/log/tunnel-health.log 2>&1
```

---

## 5. ğŸ“Š éš§é“ç›‘æ§ä¸å‘Šè­¦ç³»ç»Ÿ


### 5.1 ç›‘æ§æŒ‡æ ‡è®¾è®¡


**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**ï¼š
```
è¿æ¥çŠ¶æ€æŒ‡æ ‡ï¼š
â€¢ éš§é“è¿æ¥çŠ¶æ€ (UP/DOWN)
â€¢ è¿æ¥å»ºç«‹æ—¶é—´
â€¢ é‡è¿æ¬¡æ•°ç»Ÿè®¡
â€¢ è¿æ¥æŒç»­æ—¶é•¿

æ€§èƒ½æŒ‡æ ‡ï¼š
â€¢ ç½‘ç»œå»¶è¿Ÿ (RTT)
â€¢ æ•°æ®ä¼ è¾“é€Ÿç‡
â€¢ é”™è¯¯ç‡ç»Ÿè®¡  
â€¢ èµ„æºä½¿ç”¨æƒ…å†µ

ä¸šåŠ¡æŒ‡æ ‡ï¼š
â€¢ ç›®æ ‡æœåŠ¡å“åº”æ—¶é—´
â€¢ ä¸šåŠ¡è¯·æ±‚æˆåŠŸç‡
â€¢ å¹¶å‘è¿æ¥æ•°
â€¢ æœåŠ¡å¯ç”¨æ€§SLA
```

### 5.2 æ—¥å¿—æ”¶é›†ä¸åˆ†æ


**ç»Ÿä¸€æ—¥å¿—æ ¼å¼**ï¼š
```bash
# åˆ›å»ºæ—¥å¿—æ”¶é›†è„šæœ¬
cat > /usr/local/bin/tunnel-logger.sh << 'EOF'
#!/bin/bash

log_tunnel_event() {
    local tunnel_name=$1
    local event_type=$2  # START/STOP/ERROR/HEALTH_CHECK
    local message=$3
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    echo "[$timestamp] [$tunnel_name] [$event_type] $message" >> /var/log/tunnel-events.log
    
    # åŒæ—¶å‘é€åˆ°ç³»ç»Ÿæ—¥å¿—
    logger -t "ssh-tunnel" "[$tunnel_name] [$event_type] $message"
}

# ä½¿ç”¨ç¤ºä¾‹
log_tunnel_event "web-tunnel" "START" "Tunnel established successfully"
log_tunnel_event "mysql-tunnel" "ERROR" "Connection failed, retrying..."
log_tunnel_event "redis-tunnel" "HEALTH_CHECK" "Health check passed"
EOF

chmod +x /usr/local/bin/tunnel-logger.sh
```

**æ—¥å¿—è½®è½¬é…ç½®**ï¼š
```bash
# åˆ›å»ºlogrotateé…ç½®
sudo cat > /etc/logrotate.d/ssh-tunnels << 'EOF'
/var/log/tunnel-*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
    postrotate
        systemctl reload rsyslog > /dev/null 2>&1 || true
    endrotate
}
EOF
```

### 5.3 å‘Šè­¦æœºåˆ¶å®ç°


**é‚®ä»¶å‘Šè­¦è„šæœ¬**ï¼š
```bash
#!/bin/bash
# æ–‡ä»¶: /usr/local/bin/send-alert.sh

send_email_alert() {
    local subject=$1
    local message=$2
    local urgency=${3:-normal}  # normal/urgent/critical
    local email_list="admin@company.com ops@company.com"
    
    # æ ¹æ®ç´§æ€¥ç¨‹åº¦è®¾ç½®é‚®ä»¶æ ‡é¢˜å‰ç¼€
    case $urgency in
        urgent)   prefix="ğŸš¨ [URGENT]" ;;
        critical) prefix="ğŸ”¥ [CRITICAL]" ;;
        *)        prefix="â„¹ï¸ [INFO]" ;;
    esac
    
    # æ„é€ é‚®ä»¶å†…å®¹
    cat << EOF | mail -s "$prefix SSH Tunnel Alert: $subject" $email_list
SSHéš§é“å‘Šè­¦é€šçŸ¥

å‘Šè­¦çº§åˆ«: $urgency
å‘Šè­¦æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
å‘Šè­¦ä¸»æœº: $(hostname)
å‘Šè­¦å†…å®¹: $message

è¯·åŠæ—¶å¤„ç†ç›¸å…³é—®é¢˜ã€‚

--
SSHéš§é“è‡ªåŠ¨åŒ–ç›‘æ§ç³»ç»Ÿ
EOF
    
    echo "Alert sent: $subject (Level: $urgency)"
}

# è„šæœ¬å‚æ•°å¤„ç†
if [ $# -lt 2 ]; then
    echo "Usage: $0 <subject> <message> [urgency_level]"
    exit 1
fi

send_email_alert "$1" "$2" "$3"
```

**å¾®ä¿¡/é’‰é’‰å‘Šè­¦é›†æˆ**ï¼š
```bash
#!/bin/bash  
# æ–‡ä»¶: /usr/local/bin/send-webhook-alert.sh

send_webhook_alert() {
    local webhook_url="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY"
    local message=$1
    local urgency=${2:-normal}
    
    # æ ¹æ®çº§åˆ«è®¾ç½®æ¶ˆæ¯é¢œè‰²
    case $urgency in
        critical) color="red" ;;
        urgent)   color="orange" ;;
        *)        color="green" ;;
    esac
    
    # æ„é€ æ¶ˆæ¯ä½“
    curl -X POST "$webhook_url" \
         -H 'Content-Type: application/json' \
         -d "{
             \"msgtype\": \"markdown\",
             \"markdown\": {
                 \"content\": \"## SSHéš§é“å‘Šè­¦\n> **å‘Šè­¦çº§åˆ«**: <font color=\\\"$color\\\">$urgency</font>\n> **å‘Šè­¦æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')\n> **å‘Šè­¦ä¸»æœº**: $(hostname)\n> **å‘Šè­¦å†…å®¹**: $message\"
             }
         }"
}

send_webhook_alert "$1" "$2"
```

### 5.4 ç›‘æ§ä»ªè¡¨æ¿


**ç®€å•ç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# æ–‡ä»¶: /usr/local/bin/tunnel-dashboard.sh

show_tunnel_status() {
    echo "========================================"
    echo "  SSHéš§é“çŠ¶æ€ç›‘æ§é¢æ¿"
    echo "  æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "========================================"
    echo
    
    # æ£€æŸ¥å„ä¸ªéš§é“æœåŠ¡çŠ¶æ€
    tunnels=("ssh-tunnel-web" "ssh-tunnel-mysql" "ssh-tunnel-redis")
    
    for tunnel in "${tunnels[@]}"; do
        if systemctl is-active --quiet "$tunnel"; then
            status="ğŸŸ¢ è¿è¡Œä¸­"
            uptime=$(systemctl show "$tunnel" --property=ActiveEnterTimestamp --value)
        else
            status="ğŸ”´ å·²åœæ­¢"
            uptime="N/A"
        fi
        
        echo "[$tunnel]"
        echo "  çŠ¶æ€: $status"
        echo "  å¯åŠ¨æ—¶é—´: $uptime"
        echo
    done
    
    # æ˜¾ç¤ºç«¯å£å ç”¨æƒ…å†µ
    echo "ç«¯å£å ç”¨æƒ…å†µ:"
    netstat -tlnp | grep -E "(8080|3307|6380)" | while read line; do
        echo "  $line"
    done
    echo
    
    # æ˜¾ç¤ºæœ€è¿‘çš„é”™è¯¯æ—¥å¿—
    echo "æœ€è¿‘é”™è¯¯æ—¥å¿— (æœ€è¿‘10æ¡):"
    tail -n 10 /var/log/tunnel-events.log | grep -i error
}

# æŒç»­ç›‘æ§æ¨¡å¼
if [ "$1" = "--watch" ]; then
    while true; do
        clear
        show_tunnel_status
        sleep 30
    done
else
    show_tunnel_status
fi
```

---

## 6. ğŸ“¦ æ‰¹é‡éš§é“éƒ¨ç½²ä¸ç®¡ç†


### 6.1 é…ç½®æ¨¡æ¿åŒ–


**éš§é“é…ç½®æ¨¡æ¿**ï¼š
```bash
# åˆ›å»ºé…ç½®æ¨¡æ¿ç›®å½•
sudo mkdir -p /etc/ssh-tunnels/templates
sudo mkdir -p /etc/ssh-tunnels/configs

# åŸºç¡€æ¨¡æ¿æ–‡ä»¶
cat > /etc/ssh-tunnels/templates/tunnel-service.template << 'EOF'
[Unit]
Description=SSH Tunnel for {{SERVICE_NAME}}
After=network.target
Wants=network.target

[Service]
Type=simple
User={{TUNNEL_USER}}
Group={{TUNNEL_GROUP}}
Restart=always
RestartSec={{RESTART_SEC}}
ExecStart=/usr/bin/autossh -M {{MONITOR_PORT}} -N -L {{LOCAL_PORT}}:{{REMOTE_HOST}}:{{REMOTE_PORT}} {{SSH_USER}}@{{SSH_HOST}}
ExecStop=/bin/kill $MAINPID
KillMode=process
Environment="AUTOSSH_POLL={{POLL_INTERVAL}}"
Environment="AUTOSSH_GATETIME={{GATE_TIME}}"
Environment="AUTOSSH_MAXSTART={{MAX_START}}"

[Install]
WantedBy=multi-user.target
EOF
```

**é…ç½®å‚æ•°æ–‡ä»¶**ï¼š
```bash
# WebæœåŠ¡éš§é“é…ç½®
cat > /etc/ssh-tunnels/configs/web-server.conf << 'EOF'
SERVICE_NAME="Web Server"
TUNNEL_USER="tunnel-user"
TUNNEL_GROUP="tunnel-user"
RESTART_SEC="10"
MONITOR_PORT="20000"
LOCAL_PORT="8080"
REMOTE_HOST="localhost"
REMOTE_PORT="80"
SSH_USER="webuser"
SSH_HOST="192.168.1.100"
POLL_INTERVAL="60"
GATE_TIME="30"
MAX_START="5"
EOF

# æ•°æ®åº“éš§é“é…ç½®
cat > /etc/ssh-tunnels/configs/mysql-db.conf << 'EOF'
SERVICE_NAME="MySQL Database"
TUNNEL_USER="tunnel-user"
TUNNEL_GROUP="tunnel-user"
RESTART_SEC="15"
MONITOR_PORT="20001"
LOCAL_PORT="3307"
REMOTE_HOST="localhost"
REMOTE_PORT="3306"
SSH_USER="dbuser"
SSH_HOST="192.168.1.200"
POLL_INTERVAL="60"
GATE_TIME="30"
MAX_START="5"
EOF
```

### 6.2 è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬


**éš§é“éƒ¨ç½²è„šæœ¬**ï¼š
```bash
#!/bin/bash
# æ–‡ä»¶: /usr/local/bin/deploy-tunnel.sh

deploy_tunnel() {
    local config_name=$1
    local config_file="/etc/ssh-tunnels/configs/${config_name}.conf"
    local template_file="/etc/ssh-tunnels/templates/tunnel-service.template"
    local service_file="/etc/systemd/system/ssh-tunnel-${config_name}.service"
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [ ! -f "$config_file" ]; then
        echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $config_file"
        return 1
    fi
    
    echo "ğŸ“¦ éƒ¨ç½²éš§é“æœåŠ¡: $config_name"
    
    # åŠ è½½é…ç½®å˜é‡
    source "$config_file"
    
    # ä½¿ç”¨envsubstæ›¿æ¢æ¨¡æ¿ä¸­çš„å˜é‡
    envsubst < "$template_file" > "$service_file"
    
    # é‡æ–°åŠ è½½systemd
    systemctl daemon-reload
    
    # å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
    systemctl enable "ssh-tunnel-${config_name}"
    systemctl start "ssh-tunnel-${config_name}"
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    sleep 5
    if systemctl is-active --quiet "ssh-tunnel-${config_name}"; then
        echo "âœ… éš§é“ $config_name éƒ¨ç½²æˆåŠŸ"
        return 0
    else
        echo "âŒ éš§é“ $config_name éƒ¨ç½²å¤±è´¥"
        systemctl status "ssh-tunnel-${config_name}"
        return 1
    fi
}

# æ‰¹é‡éƒ¨ç½²
batch_deploy() {
    local configs_dir="/etc/ssh-tunnels/configs"
    local success_count=0
    local total_count=0
    
    echo "ğŸš€ å¼€å§‹æ‰¹é‡éƒ¨ç½²SSHéš§é“..."
    
    for config_file in "$configs_dir"/*.conf; do
        if [ -f "$config_file" ]; then
            config_name=$(basename "$config_file" .conf)
            total_count=$((total_count + 1))
            
            if deploy_tunnel "$config_name"; then
                success_count=$((success_count + 1))
            fi
        fi
    done
    
    echo "ğŸ“Š éƒ¨ç½²å®Œæˆ: $success_count/$total_count æˆåŠŸ"
}

# è„šæœ¬å‚æ•°å¤„ç†
case "$1" in
    "deploy")
        if [ -n "$2" ]; then
            deploy_tunnel "$2"
        else
            echo "Usage: $0 deploy <config_name>"
        fi
        ;;
    "batch")
        batch_deploy
        ;;
    *)
        echo "Usage: $0 {deploy <config_name>|batch}"
        echo "Examples:"
        echo "  $0 deploy web-server    # éƒ¨ç½²å•ä¸ªéš§é“"
        echo "  $0 batch               # æ‰¹é‡éƒ¨ç½²æ‰€æœ‰éš§é“"
        ;;
esac
```

### 6.3 éš§é“ç®¡ç†è„šæœ¬


**ç»Ÿä¸€ç®¡ç†è„šæœ¬**ï¼š
```bash
#!/bin/bash
# æ–‡ä»¶: /usr/local/bin/manage-tunnels.sh

list_tunnels() {
    echo "ğŸ“‹ SSHéš§é“æœåŠ¡åˆ—è¡¨:"
    systemctl list-units --type=service | grep ssh-tunnel | while read line; do
        service_name=$(echo "$line" | awk '{print $1}')
        status=$(echo "$line" | awk '{print $4}')
        echo "  ğŸ”— $service_name - $status"
    done
}

start_all_tunnels() {
    echo "ğŸš€ å¯åŠ¨æ‰€æœ‰éš§é“æœåŠ¡..."
    systemctl start ssh-tunnel-*
    echo "âœ… å¯åŠ¨å‘½ä»¤å·²æ‰§è¡Œ"
}

stop_all_tunnels() {
    echo "ğŸ›‘ åœæ­¢æ‰€æœ‰éš§é“æœåŠ¡..."
    systemctl stop ssh-tunnel-*
    echo "âœ… åœæ­¢å‘½ä»¤å·²æ‰§è¡Œ"
}

restart_all_tunnels() {
    echo "ğŸ”„ é‡å¯æ‰€æœ‰éš§é“æœåŠ¡..."
    systemctl restart ssh-tunnel-*
    echo "âœ… é‡å¯å‘½ä»¤å·²æ‰§è¡Œ"
}

status_all_tunnels() {
    echo "ğŸ“Š æ‰€æœ‰éš§é“æœåŠ¡çŠ¶æ€:"
    for service in $(systemctl list-units --type=service | grep ssh-tunnel | awk '{print $1}'); do
        echo "----------------------------------------"
        systemctl status "$service" --no-pager
    done
}

# è„šæœ¬å‚æ•°å¤„ç†
case "$1" in
    "list"|"ls")
        list_tunnels
        ;;
    "start")
        start_all_tunnels
        ;;
    "stop")
        stop_all_tunnels  
        ;;
    "restart")
        restart_all_tunnels
        ;;
    "status")
        status_all_tunnels
        ;;
    *)
        echo "SSHéš§é“ç®¡ç†å·¥å…·"
        echo "Usage: $0 {list|start|stop|restart|status}"
        echo ""
        echo "Commands:"
        echo "  list     - åˆ—å‡ºæ‰€æœ‰éš§é“æœåŠ¡"
        echo "  start    - å¯åŠ¨æ‰€æœ‰éš§é“æœåŠ¡"
        echo "  stop     - åœæ­¢æ‰€æœ‰éš§é“æœåŠ¡"
        echo "  restart  - é‡å¯æ‰€æœ‰éš§é“æœåŠ¡"
        echo "  status   - æŸ¥çœ‹æ‰€æœ‰éš§é“æœåŠ¡çŠ¶æ€"
        ;;
esac
```

---

## 7. ğŸ”„ æ•…éšœè‡ªåŠ¨åˆ‡æ¢æœºåˆ¶


### 7.1 ä¸»å¤‡éš§é“æ¶æ„


**é«˜å¯ç”¨éš§é“è®¾è®¡**ï¼š
```
ä¸»å¤‡éš§é“æ¶æ„å›¾:

åº”ç”¨ç¨‹åº
    â”‚
    â–¼
è´Ÿè½½å‡è¡¡å™¨ (keepalived/haproxy)
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                 â–¼                 â–¼
ä¸»éš§é“(ä¼˜å…ˆçº§100)  å¤‡éš§é“1(ä¼˜å…ˆçº§90)  å¤‡éš§é“2(ä¼˜å…ˆçº§80)
    â”‚                 â”‚                 â”‚
    â–¼                 â–¼                 â–¼
æœåŠ¡å™¨A           æœåŠ¡å™¨B           æœåŠ¡å™¨C
```

### 7.2 æ•…éšœæ£€æµ‹ä¸åˆ‡æ¢


**æ™ºèƒ½åˆ‡æ¢è„šæœ¬**ï¼š
```bash
#!/bin/bash
# æ–‡ä»¶: /usr/local/bin/tunnel-failover.sh

# éš§é“é…ç½®
PRIMARY_TUNNEL="ssh-tunnel-web-primary"
BACKUP_TUNNELS=("ssh-tunnel-web-backup1" "ssh-tunnel-web-backup2")
PRIMARY_PORT="8080"
BACKUP_PORTS=("8081" "8082")
CHECK_URL="http://localhost:8080/health"

# æ£€æŸ¥éš§é“å¥åº·çŠ¶æ€
check_tunnel_health() {
    local port=$1
    local url="http://localhost:${port}/health"
    
    # ç«¯å£æ£€æŸ¥
    if ! nc -z localhost "$port" 2>/dev/null; then
        return 1
    fi
    
    # HTTPæœåŠ¡æ£€æŸ¥
    response_code=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 "$url" 2>/dev/null)
    if [ "$response_code" = "200" ]; then
        return 0
    else
        return 1
    fi
}

# åˆ‡æ¢åˆ°å¤‡ç”¨éš§é“
failover_to_backup() {
    local backup_index=$1
    local backup_service="${BACKUP_TUNNELS[$backup_index]}"
    local backup_port="${BACKUP_PORTS[$backup_index]}"
    
    echo "ğŸ”„ åˆ‡æ¢åˆ°å¤‡ç”¨éš§é“: $backup_service (ç«¯å£: $backup_port)"
    
    # å¯åŠ¨å¤‡ç”¨éš§é“
    systemctl start "$backup_service"
    sleep 10
    
    # æ£€æŸ¥å¤‡ç”¨éš§é“æ˜¯å¦æ­£å¸¸
    if check_tunnel_health "$backup_port"; then
        echo "âœ… å¤‡ç”¨éš§é“ $backup_service å¯åŠ¨æˆåŠŸ"
        
        # æ›´æ–°è´Ÿè½½å‡è¡¡é…ç½® (è¿™é‡Œä»¥nginxä¸ºä¾‹)
        update_nginx_upstream "$backup_port"
        return 0
    else
        echo "âŒ å¤‡ç”¨éš§é“ $backup_service å¯åŠ¨å¤±è´¥"
        return 1
    fi
}

# æ›´æ–°nginxä¸Šæ¸¸é…ç½®
update_nginx_upstream() {
    local new_port=$1
    local nginx_config="/etc/nginx/conf.d/tunnel-upstream.conf"
    
    # å¤‡ä»½å½“å‰é…ç½®
    cp "$nginx_config" "${nginx_config}.backup.$(date +%s)"
    
    # æ›´æ–°upstreamé…ç½®
    cat > "$nginx_config" << EOF
upstream tunnel_backend {
    server localhost:${new_port};
}
EOF
    
    # é‡æ–°åŠ è½½nginxé…ç½®
    nginx -t && nginx -s reload
    echo "ğŸ”„ Nginxé…ç½®å·²æ›´æ–°ï¼Œæ–°ç«¯å£: $new_port"
}

# ä¸»æ•…éšœåˆ‡æ¢é€»è¾‘
perform_failover() {
    echo "ğŸš¨ ä¸»éš§é“æ•…éšœï¼Œå¼€å§‹æ•…éšœåˆ‡æ¢..."
    
    # å°è¯•é‡å¯ä¸»éš§é“
    echo "ğŸ”„ å°è¯•é‡å¯ä¸»éš§é“..."
    systemctl restart "$PRIMARY_TUNNEL"
    sleep 15
    
    # æ£€æŸ¥ä¸»éš§é“æ˜¯å¦æ¢å¤
    if check_tunnel_health "$PRIMARY_PORT"; then
        echo "âœ… ä¸»éš§é“æ¢å¤æ­£å¸¸"
        return 0
    fi
    
    # ä¸»éš§é“æ— æ³•æ¢å¤ï¼Œåˆ‡æ¢åˆ°å¤‡ç”¨éš§é“
    for i in "${!BACKUP_TUNNELS[@]}"; do
        if failover_to_backup "$i"; then
            # å‘é€æ•…éšœåˆ‡æ¢é€šçŸ¥
            /usr/local/bin/send-alert.sh "éš§é“æ•…éšœåˆ‡æ¢" "ä¸»éš§é“æ•…éšœï¼Œå·²åˆ‡æ¢åˆ°å¤‡ç”¨éš§é“ ${BACKUP_TUNNELS[$i]}" "urgent"
            return 0
        fi
    done
    
    # æ‰€æœ‰éš§é“éƒ½å¤±è´¥
    echo "ğŸ’¥ æ‰€æœ‰éš§é“éƒ½å¤±è´¥ï¼Œç³»ç»Ÿä¸¥é‡æ•…éšœ"
    /usr/local/bin/send-alert.sh "éš§é“ç³»ç»Ÿä¸¥é‡æ•…éšœ" "ä¸»éš§é“å’Œæ‰€æœ‰å¤‡ç”¨éš§é“éƒ½å¤±è´¥" "critical"
    return 1
}

# ä¸»æ£€æŸ¥å¾ªç¯
main_check() {
    while true; do
        if ! check_tunnel_health "$PRIMARY_PORT"; then
            echo "âš ï¸ ä¸»éš§é“å¥åº·æ£€æŸ¥å¤±è´¥"
            perform_failover
        else
            echo "âœ… ä¸»éš§é“è¿è¡Œæ­£å¸¸ ($(date))"
        fi
        
        sleep 30  # 30ç§’æ£€æŸ¥ä¸€æ¬¡
    done
}

# è„šæœ¬å‚æ•°å¤„ç†
case "$1" in
    "check")
        if check_tunnel_health "$PRIMARY_PORT"; then
            echo "âœ… ä¸»éš§é“å¥åº·"
            exit 0
        else
            echo "âŒ ä¸»éš§é“æ•…éšœ"
            exit 1
        fi
        ;;
    "failover")
        perform_failover
        ;;
    "monitor")
        echo "ğŸ” å¼€å§‹æŒç»­ç›‘æ§æ¨¡å¼..."
        main_check
        ;;
    *)
        echo "éš§é“æ•…éšœåˆ‡æ¢å·¥å…·"
        echo "Usage: $0 {check|failover|monitor}"
        echo ""
        echo "Commands:"
        echo "  check    - æ£€æŸ¥ä¸»éš§é“å¥åº·çŠ¶æ€"
        echo "  failover - æ‰§è¡Œæ•…éšœåˆ‡æ¢"
        echo "  monitor  - å¯åŠ¨æŒç»­ç›‘æ§æ¨¡å¼"
        ;;
esac
```

### 7.3 è‡ªåŠ¨æ¢å¤æœºåˆ¶


**ä¸»éš§é“æ¢å¤æ£€æµ‹**ï¼š
```bash
#!/bin/bash
# æ–‡ä»¶: /usr/local/bin/tunnel-recovery.sh

check_primary_recovery() {
    local primary_service="ssh-tunnel-web-primary"
    local primary_port="8080"
    local recovery_check_interval=60  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ä¸»éš§é“æ¢å¤
    
    echo "ğŸ” å¼€å§‹ç›‘æ§ä¸»éš§é“æ¢å¤çŠ¶æ€..."
    
    while true; do
        # æ£€æŸ¥ä¸»éš§é“æœåŠ¡æ˜¯å¦è¿è¡Œ
        if systemctl is-active --quiet "$primary_service"; then
            # æ£€æŸ¥ä¸»éš§é“æ˜¯å¦å¥åº·
            if check_tunnel_health "$primary_port"; then
                echo "âœ… ä¸»éš§é“å·²æ¢å¤ï¼Œå‡†å¤‡åˆ‡æ¢å›ä¸»éš§é“"
                
                # åˆ‡æ¢å›ä¸»éš§é“
                switch_back_to_primary
                break
            fi
        else
            # å°è¯•å¯åŠ¨ä¸»éš§é“æœåŠ¡
            echo "ğŸ”„ å°è¯•å¯åŠ¨ä¸»éš§é“æœåŠ¡..."
            systemctl start "$primary_service"
        fi
        
        sleep "$recovery_check_interval"
    done
}

switch_back_to_primary() {
    local primary_port="8080"
    
    echo "ğŸ”„ åˆ‡æ¢å›ä¸»éš§é“..."
    
    # æ›´æ–°nginxé…ç½®å›ä¸»éš§é“
    update_nginx_upstream "$primary_port"
    
    # åœæ­¢å¤‡ç”¨éš§é“æœåŠ¡(èŠ‚çœèµ„æº)
    for backup_service in "${BACKUP_TUNNELS[@]}"; do
        echo "ğŸ›‘ åœæ­¢å¤‡ç”¨éš§é“: $backup_service"
        systemctl stop "$backup_service"
    done
    
    # å‘é€æ¢å¤é€šçŸ¥
    /usr/local/bin/send-alert.sh "éš§é“æ¢å¤æ­£å¸¸" "ä¸»éš§é“å·²æ¢å¤ï¼Œç³»ç»Ÿå·²åˆ‡æ¢å›ä¸»éš§é“" "normal"
    
    echo "âœ… å·²æˆåŠŸåˆ‡æ¢å›ä¸»éš§é“"
}

# å¯åŠ¨æ¢å¤ç›‘æ§
check_primary_recovery
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ autosshå·¥å…·ï¼šSSHè¿æ¥çš„è‡ªåŠ¨é‡è¿å·¥å…·ï¼Œè§£å†³è¿æ¥æ–­å¼€é—®é¢˜
ğŸ”¸ systemdç®¡ç†ï¼šå°†éš§é“æœåŠ¡åŒ–ï¼Œå®ç°å¼€æœºè‡ªå¯å’Œè¿›ç¨‹ç®¡ç†
ğŸ”¸ å¥åº·æ£€æŸ¥ï¼šé€šè¿‡ç«¯å£æ£€æŸ¥ã€æœåŠ¡å“åº”æ£€æŸ¥ç¡®ä¿éš§é“æ­£å¸¸å·¥ä½œ
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šå®æ—¶ç›‘æ§éš§é“çŠ¶æ€ï¼Œå¼‚å¸¸æ—¶åŠæ—¶é€šçŸ¥è¿ç»´äººå‘˜
ğŸ”¸ æ‰¹é‡éƒ¨ç½²ï¼šé€šè¿‡æ¨¡æ¿åŒ–é…ç½®å’Œè„šæœ¬å®ç°éš§é“çš„æ ‡å‡†åŒ–éƒ¨ç½²
ğŸ”¸ æ•…éšœåˆ‡æ¢ï¼šä¸»å¤‡éš§é“æ¶æ„ï¼Œç¡®ä¿æœåŠ¡é«˜å¯ç”¨æ€§
```

### 8.2 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒåº”ç”¨åœºæ™¯**ï¼š
- **å¾®æœåŠ¡æ¶æ„** - å†…ç½‘æœåŠ¡çš„å¤–ç½‘è®¿é—®éš§é“
- **æ•°æ®åº“è®¿é—®** - å¼€å‘ç¯å¢ƒè®¿é—®ç”Ÿäº§æ•°æ®åº“
- **ç›‘æ§ç³»ç»Ÿ** - ç›‘æ§æœåŠ¡çš„æ•°æ®é‡‡é›†éš§é“
- **CI/CDæµæ°´çº¿** - æ„å»ºæœåŠ¡å™¨è®¿é—®å†…ç½‘èµ„æº

**ğŸ’¡ è¿ç»´æ•ˆç‡æå‡**ï¼š
- **è‡ªåŠ¨åŒ–ç¨‹åº¦** - å‡å°‘90%çš„äººå·¥å¹²é¢„
- **æ•…éšœæ¢å¤æ—¶é—´** - ä»åˆ†é’Ÿçº§é™ä½åˆ°ç§’çº§
- **æœåŠ¡å¯ç”¨æ€§** - è¾¾åˆ°99.9%ä»¥ä¸Šçš„å¯ç”¨æ€§
- **è¿ç»´æˆæœ¬** - å¤§å¹…é™ä½äººåŠ›ç»´æŠ¤æˆæœ¬

### 8.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ”§ éƒ¨ç½²å»ºè®®**ï¼š
```
ç¯å¢ƒé…ç½®ï¼š
â€¢ ä½¿ç”¨ä¸“ç”¨ç”¨æˆ·è¿è¡Œéš§é“æœåŠ¡
â€¢ é…ç½®åˆé€‚çš„SSHå¯†é’¥è®¤è¯
â€¢ è®¾ç½®é˜²ç«å¢™è§„åˆ™ä¿æŠ¤ç›‘æ§ç«¯å£
â€¢ å®šæœŸæ›´æ–°autosshå’Œç³»ç»Ÿè¡¥ä¸

ç›‘æ§é…ç½®ï¼š
â€¢ è®¾ç½®å¤šå±‚æ¬¡å¥åº·æ£€æŸ¥
â€¢ é…ç½®åˆ†çº§å‘Šè­¦æœºåˆ¶
â€¢ å»ºç«‹ç›‘æ§ä»ªè¡¨æ¿
â€¢ å®šæœŸæµ‹è¯•æ•…éšœåˆ‡æ¢

å®‰å…¨è€ƒè™‘ï¼š
â€¢ ä½¿ç”¨éé»˜è®¤ç›‘æ§ç«¯å£
â€¢ é™åˆ¶SSHç”¨æˆ·æƒé™
â€¢ å®šæœŸè½®æ¢SSHå¯†é’¥
â€¢ ç›‘æ§å¼‚å¸¸è¿æ¥è¡Œä¸º
```

**âš ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³**ï¼š

| é—®é¢˜ç±»å‹ | **å¸¸è§åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|---------|-------------|-------------|
| **è¿æ¥é¢‘ç¹æ–­å¼€** | ç½‘ç»œä¸ç¨³å®šã€é˜²ç«å¢™é™åˆ¶ | è°ƒæ•´autosshå‚æ•°ã€ä¼˜åŒ–ç½‘ç»œé…ç½® |
| **æœåŠ¡å¯åŠ¨å¤±è´¥** | ç«¯å£å†²çªã€æƒé™é—®é¢˜ | æ£€æŸ¥ç«¯å£å ç”¨ã€è°ƒæ•´ç”¨æˆ·æƒé™ |
| **ç›‘æ§è¯¯æŠ¥** | æ£€æŸ¥è„šæœ¬é€»è¾‘é”™è¯¯ | ä¼˜åŒ–å¥åº·æ£€æŸ¥é€»è¾‘ã€å¢åŠ å®¹é”™ |
| **åˆ‡æ¢å¤±è´¥** | å¤‡ç”¨éš§é“é…ç½®é”™è¯¯ | éªŒè¯å¤‡ç”¨éš§é“é…ç½®ã€æµ‹è¯•åˆ‡æ¢æµç¨‹ |

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- SSHéš§é“è‡ªåŠ¨åŒ–ç®¡ç†è§£å†³äº†æ‰‹åŠ¨ç»´æŠ¤çš„ç—›ç‚¹
- autossh + systemd æ˜¯éš§é“æœåŠ¡åŒ–çš„æ ‡å‡†ç»„åˆ
- å¥åº·æ£€æŸ¥å’Œç›‘æ§å‘Šè­¦æ˜¯ä¿éšœæœåŠ¡ç¨³å®šçš„å…³é”®
- æ¨¡æ¿åŒ–éƒ¨ç½²å’Œæ‰¹é‡ç®¡ç†æé«˜äº†è¿ç»´æ•ˆç‡
- æ•…éšœåˆ‡æ¢æœºåˆ¶ç¡®ä¿äº†æœåŠ¡çš„é«˜å¯ç”¨æ€§