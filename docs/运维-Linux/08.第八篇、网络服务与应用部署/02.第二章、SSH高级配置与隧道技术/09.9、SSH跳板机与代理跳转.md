---
title: 9ã€SSHè·³æ¿æœºä¸ä»£ç†è·³è½¬
---
## ğŸ“š ç›®å½•

1. [SSHè·³æ¿æœºåŸºç¡€æ¦‚å¿µ](#1-SSHè·³æ¿æœºåŸºç¡€æ¦‚å¿µ)
2. [ProxyJumpå¤šçº§è·³è½¬é…ç½®](#2-ProxyJumpå¤šçº§è·³è½¬é…ç½®)
3. [ProxyCommandä»£ç†å‘½ä»¤è®¾ç½®](#3-ProxyCommandä»£ç†å‘½ä»¤è®¾ç½®)
4. [è·³æ¿æœºè®¿é—®é“¾è·¯è®¾è®¡](#4-è·³æ¿æœºè®¿é—®é“¾è·¯è®¾è®¡)
5. [å¤šå±‚ç½‘ç»œç¯å¢ƒç©¿é€](#5-å¤šå±‚ç½‘ç»œç¯å¢ƒç©¿é€)
6. [è·³è½¬è®¤è¯é“¾å¼é…ç½®](#6-è·³è½¬è®¤è¯é“¾å¼é…ç½®)
7. [è·³æ¿æœºå®‰å…¨ç­–ç•¥](#7-è·³æ¿æœºå®‰å…¨ç­–ç•¥)
8. [è®¿é—®è·¯å¾„ä¼˜åŒ–](#8-è®¿é—®è·¯å¾„ä¼˜åŒ–)
9. [è·³è½¬æ—¥å¿—å®¡è®¡](#9-è·³è½¬æ—¥å¿—å®¡è®¡)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ SSHè·³æ¿æœºåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯SSHè·³æ¿æœº


**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
```
SSHè·³æ¿æœºï¼šä¸€å°ä½œä¸ºä¸­é—´ä»£ç†çš„æœåŠ¡å™¨ï¼Œç”¨æ¥é—´æ¥è®¿é—®ç›®æ ‡æœåŠ¡å™¨
ä½œç”¨ï¼šè§£å†³ç½‘ç»œéš”ç¦»ã€å®‰å…¨è®¿é—®æ§åˆ¶ç­‰é—®é¢˜
è‹±æ–‡åï¼šJump Hostã€Bastion Hostã€Gateway Server
```

**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦è·³æ¿æœº**
- **ç½‘ç»œéš”ç¦»**ï¼šç›®æ ‡æœåŠ¡å™¨ä½äºå†…ç½‘ï¼Œæ— æ³•ç›´æ¥è®¿é—®
- **å®‰å…¨ç®¡æ§**ï¼šç»Ÿä¸€å…¥å£ï¼Œä¾¿äºæƒé™ç®¡ç†å’Œå®¡è®¡
- **é˜²ç«å¢™é™åˆ¶**ï¼šåªèƒ½é€šè¿‡ç‰¹å®šæœåŠ¡å™¨è®¿é—®å†…ç½‘èµ„æº
- **VPNæ›¿ä»£**ï¼šæ— éœ€VPNå³å¯è®¿é—®å†…ç½‘æœåŠ¡å™¨

### 1.2 è·³æ¿æœºå·¥ä½œåŸç†


**ğŸ”„ è®¿é—®æµç¨‹ç¤ºæ„å›¾**
```
å®¢æˆ·ç«¯ â”€â”€SSHâ”€â”€> è·³æ¿æœº â”€â”€SSHâ”€â”€> ç›®æ ‡æœåŠ¡å™¨
 (ä½ )           (ä¸­è½¬)         (æœ€ç»ˆç›®æ ‡)

ç½‘ç»œç¯å¢ƒï¼š
äº’è”ç½‘ â”€â”€â”€â”€â”€â”€ DMZåŒºåŸŸ â”€â”€â”€â”€â”€â”€ å†…ç½‘åŒºåŸŸ
   â”‚           â”‚              â”‚
å®¢æˆ·ç«¯      è·³æ¿æœº        ç›®æ ‡æœåŠ¡å™¨
```

**ğŸ’¡ è¿æ¥å»ºç«‹è¿‡ç¨‹**
1. å®¢æˆ·ç«¯ä¸è·³æ¿æœºå»ºç«‹SSHè¿æ¥
2. è·³æ¿æœºä¸ç›®æ ‡æœåŠ¡å™¨å»ºç«‹SSHè¿æ¥  
3. é€šè¿‡è·³æ¿æœºè½¬å‘æ‰€æœ‰é€šä¿¡æµé‡
4. å®ç°ç«¯åˆ°ç«¯çš„å®‰å…¨è¿æ¥

### 1.3 è·³æ¿æœºçš„ä¼˜åŠ¿ä¸æŒ‘æˆ˜


| ä¼˜åŠ¿ | æŒ‘æˆ˜ |
|------|------|
| âœ… **å®‰å…¨é›†ä¸­ç®¡æ§** | âš ï¸ **å•ç‚¹æ•…éšœé£é™©** |
| âœ… **ç»Ÿä¸€è®¿é—®å…¥å£** | âš ï¸ **æ€§èƒ½ç“¶é¢ˆé—®é¢˜** |
| âœ… **æ“ä½œè¡Œä¸ºå®¡è®¡** | âš ï¸ **é…ç½®å¤æ‚åº¦é«˜** |
| âœ… **æƒé™ç²¾ç»†æ§åˆ¶** | âš ï¸ **ç½‘ç»œå»¶è¿Ÿå¢åŠ ** |

---

## 2. ğŸš€ ProxyJumpå¤šçº§è·³è½¬é…ç½®


### 2.1 ProxyJumpåŸºæœ¬è¯­æ³•


**ğŸ“ å‘½ä»¤è¡Œè¯­æ³•**
```bash
# åŸºæœ¬è¯­æ³•
ssh -J è·³æ¿æœº ç›®æ ‡æœåŠ¡å™¨

# å•çº§è·³è½¬ç¤ºä¾‹
ssh -J jumphost targetserver

# å¤šçº§è·³è½¬ç¤ºä¾‹  
ssh -J jump1,jump2,jump3 targetserver
```

**ğŸ”§ é…ç½®æ–‡ä»¶è¯­æ³•**
```bash
# ~/.ssh/config é…ç½®
Host targetserver
    HostName 192.168.1.100
    User admin
    ProxyJump jumphost
```

### 2.2 å•çº§è·³è½¬é…ç½®å®ä¾‹


**ğŸ’» å®é™…é…ç½®ç¤ºä¾‹**
```bash
# æ–¹å¼1ï¼šå‘½ä»¤è¡Œç›´æ¥ä½¿ç”¨
ssh -J admin@jumphost.company.com admin@192.168.1.100

# æ–¹å¼2ï¼šé…ç½®æ–‡ä»¶æ–¹å¼
Host production-db
    HostName 192.168.1.100
    User admin
    Port 22
    ProxyJump admin@jumphost.company.com
    IdentityFile ~/.ssh/production_key

# ä½¿ç”¨é…ç½®åçš„ç®€å•è¿æ¥
ssh production-db
```

**ğŸ¯ é…ç½®è¯´æ˜**
- `ProxyJump`ï¼šæŒ‡å®šè·³æ¿æœºåœ°å€å’Œç”¨æˆ·å
- `IdentityFile`ï¼šå¯ä¸ºä¸åŒæœåŠ¡å™¨æŒ‡å®šä¸åŒå¯†é’¥
- `Port`ï¼šå¦‚æœç›®æ ‡æœåŠ¡å™¨ä½¿ç”¨éæ ‡å‡†ç«¯å£

### 2.3 å¤šçº§è·³è½¬é…ç½®


**ğŸ”— ä¸‰çº§è·³è½¬ç¤ºä¾‹**
```bash
# ç½‘ç»œæ‹“æ‰‘
å®¢æˆ·ç«¯ -> å¤–ç½‘è·³æ¿æœº -> å†…ç½‘è·³æ¿æœº -> ç›®æ ‡æœåŠ¡å™¨

# é…ç½®æ–‡ä»¶è®¾ç½®
Host outer-jump
    HostName jumphost-external.company.com
    User jumpuser
    Port 22

Host inner-jump  
    HostName 10.0.1.10
    User admin
    ProxyJump outer-jump

Host target-server
    HostName 10.0.2.100
    User root
    ProxyJump outer-jump,inner-jump
```

**âš¡ ä½¿ç”¨å¤šçº§è·³è½¬**
```bash
# ç›´æ¥è¿æ¥åˆ°æœ€ç»ˆç›®æ ‡
ssh target-server

# ç­‰ä»·çš„å‘½ä»¤è¡Œæ–¹å¼
ssh -J jumpuser@jumphost-external.company.com,admin@10.0.1.10 root@10.0.2.100
```

---

## 3. ğŸ”§ ProxyCommandä»£ç†å‘½ä»¤è®¾ç½®


### 3.1 ProxyCommandåŸºæœ¬æ¦‚å¿µ


**ğŸ“‹ ä»€ä¹ˆæ˜¯ProxyCommand**
```
ProxyCommandï¼šé€šè¿‡å¤–éƒ¨å‘½ä»¤å»ºç«‹SSHè¿æ¥çš„ä»£ç†æ–¹å¼
ç‰¹ç‚¹ï¼šæ¯”ProxyJumpæ›´çµæ´»ï¼Œæ”¯æŒå¤æ‚çš„ä»£ç†åœºæ™¯
é€‚ç”¨ï¼šéœ€è¦ç‰¹æ®Šä»£ç†åè®®æˆ–è‡ªå®šä¹‰è¿æ¥é€»è¾‘çš„åœºæ™¯
```

**ğŸ”„ å·¥ä½œåŸç†**
- SSHå®¢æˆ·ç«¯æ‰§è¡ŒæŒ‡å®šçš„ä»£ç†å‘½ä»¤
- ä»£ç†å‘½ä»¤è´Ÿè´£å»ºç«‹åˆ°ç›®æ ‡æœåŠ¡å™¨çš„è¿æ¥
- SSHé€šè¿‡æ ‡å‡†è¾“å…¥è¾“å‡ºä¸ä»£ç†å‘½ä»¤é€šä¿¡

### 3.2 åŸºäºSSHçš„ProxyCommand


**ğŸ’» åŸºç¡€é…ç½®ç¤ºä¾‹**
```bash
# ~/.ssh/config
Host target-via-proxy
    HostName 192.168.1.100
    User admin
    ProxyCommand ssh -W %h:%p jumphost.company.com
```

**ğŸ” å‚æ•°è¯´æ˜**
- `%h`ï¼šç›®æ ‡ä¸»æœºåå ä½ç¬¦
- `%p`ï¼šç›®æ ‡ç«¯å£å·å ä½ç¬¦  
- `-W`ï¼šSSHç«¯å£è½¬å‘é€‰é¡¹

**âš¡ é«˜çº§ProxyCommandé…ç½®**
```bash
Host complex-target
    HostName internal-server.local
    User root
    ProxyCommand ssh -o StrictHostKeyChecking=no \
                     -o UserKnownHostsFile=/dev/null \
                     -W %h:%p jumpuser@gateway.company.com
```

### 3.3 åŸºäºncçš„ProxyCommand


**ğŸŒ é€šè¿‡netcatä»£ç†**
```bash
Host nc-proxy-target
    HostName 192.168.1.100
    User admin
    ProxyCommand ssh jumphost nc %h %p
```

**ğŸ’¡ ç»„åˆä»£ç†ç¤ºä¾‹**
```bash
# é€šè¿‡SOCKSä»£ç†è¿æ¥
Host socks-target
    HostName remote-server.com
    User user
    ProxyCommand nc -X 5 -x socks-proxy:1080 %h %p
```

### 3.4 ProxyJump vs ProxyCommandå¯¹æ¯”


| ç‰¹æ€§ | ProxyJump | ProxyCommand |
|------|-----------|--------------|
| **é…ç½®ç®€ä¾¿æ€§** | ğŸŸ¢ ç®€å•ç›´è§‚ | ğŸŸ¡ ç¨å¤æ‚ |
| **åŠŸèƒ½çµæ´»æ€§** | ğŸŸ¡ åŸºç¡€åŠŸèƒ½ | ğŸŸ¢ é«˜åº¦çµæ´» |
| **æ€§èƒ½å¼€é”€** | ğŸŸ¢ è¾ƒä½ | ğŸŸ¡ ç¨é«˜ |
| **è°ƒè¯•ä¾¿åˆ©æ€§** | ğŸŸ¢ å®¹æ˜“è°ƒè¯• | ğŸ”´ å¤æ‚è°ƒè¯• |
| **å…¼å®¹æ€§** | ğŸŸ¡ éœ€æ–°ç‰ˆSSH | ğŸŸ¢ å¹¿æ³›æ”¯æŒ |

---

## 4. ğŸ—ï¸ è·³æ¿æœºè®¿é—®é“¾è·¯è®¾è®¡


### 4.1 å…¸å‹ç½‘ç»œæ‹“æ‰‘è®¾è®¡


**ğŸŒ ä¼ä¸šçº§ç½‘ç»œæ¶æ„**
```
äº’è”ç½‘                DMZåŒºåŸŸ              å†…ç½‘åŒºåŸŸ
   â”‚                    â”‚                    â”‚
   â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
å®¢æˆ·ç«¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   è·³æ¿æœº1    â”‚ â”€â”€> â”‚  WebæœåŠ¡å™¨   â”‚
   â”‚              â”‚   è·³æ¿æœº2    â”‚      â”‚  DBæœåŠ¡å™¨    â”‚
   â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  AppæœåŠ¡å™¨   â”‚
   â”‚                    â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é˜²ç«å¢™              é˜²ç«å¢™/NAT           å†…ç½‘é˜²ç«å¢™
```

**ğŸ“‹ è®¿é—®é“¾è·¯è§„åˆ’åŸåˆ™**
- **æœ€å°æƒé™**ï¼šåªå¼€æ”¾å¿…è¦çš„è®¿é—®è·¯å¾„
- **å†—ä½™è®¾è®¡**ï¼šé¿å…å•ç‚¹æ•…éšœ
- **åˆ†å±‚é˜²æŠ¤**ï¼šå¤šå±‚å®‰å…¨æ§åˆ¶
- **å®¡è®¡å®Œæ•´**ï¼šå…¨é“¾è·¯æ—¥å¿—è®°å½•

### 4.2 å¤šç¯å¢ƒè·³è½¬é…ç½®


**ğŸ¢ ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹**
```bash
# å¼€å‘ç¯å¢ƒè·³æ¿æœº
Host dev-jump
    HostName dev-jumphost.company.com
    User devuser
    IdentityFile ~/.ssh/dev_key

# æµ‹è¯•ç¯å¢ƒè·³æ¿æœº  
Host test-jump
    HostName test-jumphost.company.com
    User testuser
    IdentityFile ~/.ssh/test_key

# ç”Ÿäº§ç¯å¢ƒè·³æ¿æœº
Host prod-jump
    HostName prod-jumphost.company.com
    User produser
    IdentityFile ~/.ssh/prod_key

# ç”Ÿäº§æ•°æ®åº“æœåŠ¡å™¨
Host prod-db
    HostName 10.10.1.100
    User postgres
    ProxyJump prod-jump
    IdentityFile ~/.ssh/db_key
```

### 4.3 åŠ¨æ€è·¯å¾„é€‰æ‹©


**ğŸ”€ æ™ºèƒ½è·¯ç”±é…ç½®**
```bash
# ä¸»è·³æ¿æœºé…ç½®
Host main-jump
    HostName primary-jump.company.com
    User mainuser
    ConnectTimeout 5

# å¤‡ç”¨è·³æ¿æœºé…ç½®
Host backup-jump
    HostName backup-jump.company.com  
    User backupuser
    ConnectTimeout 5

# ç›®æ ‡æœåŠ¡å™¨ï¼ˆä¼˜å…ˆä½¿ç”¨ä¸»è·³æ¿æœºï¼‰
Host important-server
    HostName 192.168.1.100
    User admin
    ProxyJump main-jump
    # å¦‚æœä¸»è·³æ¿æœºä¸å¯ç”¨ï¼Œæ‰‹åŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨è·³æ¿æœº
```

**ğŸ’¡ è‡ªåŠ¨åˆ‡æ¢è„šæœ¬**
```bash
#!/bin/bash
# smart_ssh.sh - æ™ºèƒ½SSHè¿æ¥è„šæœ¬

TARGET_HOST="$1"
PRIMARY_JUMP="main-jump"
BACKUP_JUMP="backup-jump"

# æµ‹è¯•ä¸»è·³æ¿æœºè¿é€šæ€§
if ssh -o ConnectTimeout=3 -o BatchMode=yes "$PRIMARY_JUMP" exit 2>/dev/null; then
    echo "ä½¿ç”¨ä¸»è·³æ¿æœºè¿æ¥..."
    ssh -J "$PRIMARY_JUMP" "$TARGET_HOST"
else
    echo "ä¸»è·³æ¿æœºä¸å¯ç”¨ï¼Œåˆ‡æ¢åˆ°å¤‡ç”¨è·³æ¿æœº..."
    ssh -J "$BACKUP_JUMP" "$TARGET_HOST"
fi
```

---

## 5. ğŸ” å¤šå±‚ç½‘ç»œç¯å¢ƒç©¿é€


### 5.1 å¤æ‚ç½‘ç»œæ‹“æ‰‘ç©¿é€


**ğŸŒ å¤šå±‚DMZç¯å¢ƒ**
```
äº’è”ç½‘ â”€â”€> å¤–å±‚DMZ â”€â”€> å†…å±‚DMZ â”€â”€> ç”Ÿäº§ç½‘ç»œ â”€â”€> æ ¸å¿ƒç³»ç»Ÿ
  â”‚          â”‚           â”‚           â”‚           â”‚
å®¢æˆ·ç«¯    è¾¹ç•Œè·³æ¿æœº   å†…éƒ¨è·³æ¿æœº   åº”ç”¨è·³æ¿æœº   ç›®æ ‡æœåŠ¡å™¨
```

**ğŸ”§ å››çº§è·³è½¬é…ç½®**
```bash
# å¤–å±‚è¾¹ç•Œè·³æ¿æœº
Host border-jump
    HostName border.company.com
    User border-admin
    Port 2222

# å†…å±‚DMZè·³æ¿æœº
Host dmz-jump
    HostName 172.16.1.10
    User dmz-admin
    ProxyJump border-jump

# ç”Ÿäº§ç½‘è·³æ¿æœº
Host prod-jump
    HostName 10.10.1.10
    User prod-admin
    ProxyJump border-jump,dmz-jump

# æœ€ç»ˆç›®æ ‡ç³»ç»Ÿ
Host core-system
    HostName 10.20.1.100
    User core-admin
    ProxyJump border-jump,dmz-jump,prod-jump
```

### 5.2 NATç©¿é€é…ç½®


**ğŸ”€ NATç¯å¢ƒå¤„ç†**
```bash
# é€šè¿‡NATç½‘å…³è®¿é—®å†…ç½‘æœåŠ¡å™¨
Host nat-target
    HostName 192.168.1.100
    User admin
    Port 22
    ProxyCommand ssh -W %h:%p nat-gateway
    
# NATç½‘å…³é…ç½®
Host nat-gateway
    HostName gateway.company.com
    User gateway-user
    # NATç½‘å…³éœ€è¦é…ç½®ç«¯å£è½¬å‘è§„åˆ™
```

**âš™ï¸ ç«¯å£æ˜ å°„ç­–ç•¥**
```bash
# åœ¨è·³æ¿æœºä¸Šè®¾ç½®ç«¯å£è½¬å‘
# å°†æœ¬åœ°8080ç«¯å£è½¬å‘åˆ°ç›®æ ‡æœåŠ¡å™¨çš„80ç«¯å£
ssh -L 8080:target-server:80 jumphost

# æŒä¹…åŒ–ç«¯å£è½¬å‘é…ç½®
Host web-tunnel
    HostName jumphost.company.com
    User tunneluser
    LocalForward 8080 internal-web:80
    LocalForward 3306 internal-db:3306
```

### 5.3 é˜²ç«å¢™ç©¿é€æŠ€å·§


**ğŸ›¡ï¸ é˜²ç«å¢™è§„åˆ™ä¼˜åŒ–**
```bash
# ä½¿ç”¨éæ ‡å‡†ç«¯å£å‡å°‘æ£€æµ‹
Host stealth-jump
    HostName jumphost.company.com
    Port 443  # ä½¿ç”¨HTTPSç«¯å£
    User admin

# é€šè¿‡HTTPä»£ç†ç©¿é€
Host http-proxy-jump
    HostName internal-server
    ProxyCommand corkscrew proxy.company.com 8080 %h %p
```

---

## 6. ğŸ”‘ è·³è½¬è®¤è¯é“¾å¼é…ç½®


### 6.1 å¯†é’¥é“¾å¼è®¤è¯


**ğŸ” å¤šçº§å¯†é’¥é…ç½®**
```bash
# ä¸ºä¸åŒè·³è½¬çº§åˆ«é…ç½®ä¸åŒå¯†é’¥
Host level1-jump
    HostName jump1.company.com
    User jump1-user
    IdentityFile ~/.ssh/level1_key
    IdentitiesOnly yes

Host level2-jump
    HostName 10.1.1.10
    User jump2-user
    IdentityFile ~/.ssh/level2_key
    ProxyJump level1-jump
    IdentitiesOnly yes

Host final-target
    HostName 10.2.1.100
    User target-user
    IdentityFile ~/.ssh/target_key
    ProxyJump level1-jump,level2-jump
```

### 6.2 Agentè½¬å‘é…ç½®


**ğŸ”„ SSH Agentè½¬å‘è®¾ç½®**
```bash
# å¯ç”¨Agentè½¬å‘
Host secure-jump
    HostName jumphost.company.com
    User admin
    ForwardAgent yes
    IdentityFile ~/.ssh/jump_key

# ç›®æ ‡æœåŠ¡å™¨é…ç½®
Host secure-target
    HostName 192.168.1.100
    User admin
    ProxyJump secure-jump
    ForwardAgent no  # å®‰å…¨è€ƒè™‘ï¼Œåœ¨æœ€ç»ˆç›®æ ‡ç¦ç”¨Agentè½¬å‘
```

**âš ï¸ Agentè½¬å‘å®‰å…¨æ³¨æ„äº‹é¡¹**
> ğŸ”’ **å®‰å…¨è­¦å‘Š**
> 
> Agentè½¬å‘æœ‰å®‰å…¨é£é™©ï¼Œè·³æ¿æœºç®¡ç†å‘˜å¯èƒ½è®¿é—®ä½ çš„ç§é’¥
> å»ºè®®åªåœ¨ä¿¡ä»»çš„è·³æ¿æœºä¸Šå¯ç”¨Agentè½¬å‘

### 6.3 åŸºäºè¯ä¹¦çš„è®¤è¯


**ğŸ“œ è¯ä¹¦è®¤è¯é…ç½®**
```bash
# ä½¿ç”¨SSHè¯ä¹¦è®¤è¯
Host cert-jump
    HostName certified-jump.company.com
    User certuser
    CertificateFile ~/.ssh/user-cert.pub
    IdentityFile ~/.ssh/cert_key

# è¯ä¹¦ç”Ÿæˆå‘½ä»¤ç¤ºä¾‹
ssh-keygen -s ca_key -I "user-certificate" -n admin,root user_key.pub
```

---

## 7. ğŸ›¡ï¸ è·³æ¿æœºå®‰å…¨ç­–ç•¥


### 7.1 è®¿é—®æ§åˆ¶ç­–ç•¥


**ğŸ” ç”¨æˆ·æƒé™ç®¡ç†**
```bash
# /etc/ssh/sshd_config è·³æ¿æœºå®‰å…¨é…ç½®
# é™åˆ¶ç”¨æˆ·è®¿é—®
AllowUsers jumpuser1 jumpuser2
DenyUsers dangerous-user

# é™åˆ¶ç”¨æˆ·ç»„
AllowGroups jump-users admin
DenyGroups regular-users

# ç¦ç”¨å±é™©åŠŸèƒ½
AllowTcpForwarding no
AllowStreamLocalForwarding no
GatewayPorts no
X11Forwarding no
```

**ğŸ¯ åŸºäºæ—¶é—´çš„è®¿é—®æ§åˆ¶**
```bash
# ä½¿ç”¨PAMæ¨¡å—é™åˆ¶è®¿é—®æ—¶é—´
# /etc/security/time.conf
sshd;*;jumpuser;MoTuWeThFr0800-1800

# é™åˆ¶åŒæ—¶è¿æ¥æ•°
MaxSessions 3
MaxStartups 5:30:10
```

### 7.2 å‘½ä»¤é™åˆ¶ç­–ç•¥


**âš¡ å¼ºåˆ¶å‘½ä»¤æ‰§è¡Œ**
```bash
# ~/.ssh/authorized_keys é™åˆ¶å¯æ‰§è¡Œå‘½ä»¤
command="/usr/local/bin/restricted-shell",no-port-forwarding,no-X11-forwarding ssh-rsa AAAAB3...

# å—é™shellè„šæœ¬ç¤ºä¾‹
#!/bin/bash
# /usr/local/bin/restricted-shell
case "$SSH_ORIGINAL_COMMAND" in
    "ssh target-server")
        exec ssh target-server
        ;;
    "scp "*)
        exec $SSH_ORIGINAL_COMMAND
        ;;
    *)
        echo "Command not allowed: $SSH_ORIGINAL_COMMAND"
        exit 1
        ;;
esac
```

### 7.3 ç½‘ç»œå®‰å…¨ç­–ç•¥


**ğŸŒ ç½‘ç»œè®¿é—®é™åˆ¶**
```bash
# iptablesè§„åˆ™é™åˆ¶è·³æ¿æœºå‡ºç«™è¿æ¥
# åªå…è®¸è®¿é—®ç‰¹å®šå†…ç½‘æ®µ
iptables -A OUTPUT -d 192.168.1.0/24 -p tcp --dport 22 -j ACCEPT
iptables -A OUTPUT -d 10.0.0.0/8 -p tcp --dport 22 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 22 -j REJECT

# é™åˆ¶å¹¶å‘è¿æ¥æ•°
iptables -A INPUT -p tcp --dport 22 -m connlimit --connlimit-above 5 -j REJECT
```

---

## 8. âš¡ è®¿é—®è·¯å¾„ä¼˜åŒ–


### 8.1 è¿æ¥å¤ç”¨ä¼˜åŒ–


**ğŸ”„ SSHè¿æ¥å¤ç”¨é…ç½®**
```bash
# ~/.ssh/config è¿æ¥å¤ç”¨è®¾ç½®
Host *
    ControlMaster auto
    ControlPath ~/.ssh/sockets/%r@%h:%p
    ControlPersist 600

# åˆ›å»ºsocketç›®å½•
mkdir -p ~/.ssh/sockets
chmod 700 ~/.ssh/sockets
```

**ğŸ’¡ å¤ç”¨å¸¦æ¥çš„å¥½å¤„**
- âœ… **é€Ÿåº¦æå‡**ï¼šåç»­è¿æ¥å‡ ä¹ç¬é—´å»ºç«‹
- âœ… **èµ„æºèŠ‚çœ**ï¼šå‡å°‘TCPè¿æ¥å’Œè®¤è¯å¼€é”€
- âœ… **ç¨³å®šæ€§å¢å¼º**ï¼šä¸»è¿æ¥æ–­å¼€åæœ‰ä¸€å®šç¼“å†²æ—¶é—´

### 8.2 å‹ç¼©ä¼˜åŒ–


**ğŸ“¦ å¯ç”¨å‹ç¼©ä¼ è¾“**
```bash
# é’ˆå¯¹æ…¢é€Ÿé“¾è·¯å¯ç”¨å‹ç¼©
Host slow-connection
    HostName remote-server.com
    Compression yes
    CompressionLevel 6
    ProxyJump slow-jumphost
```

### 8.3 keepaliveä¼˜åŒ–


**ğŸ’“ ä¿æŒè¿æ¥æ´»è·ƒ**
```bash
# å®¢æˆ·ç«¯keepaliveè®¾ç½®
Host stable-connection
    HostName target-server
    ServerAliveInterval 60
    ServerAliveCountMax 3
    ProxyJump jumphost
    
# è·³æ¿æœºkeepaliveè®¾ç½®
TCPKeepAlive yes
ClientAliveInterval 60
ClientAliveCountMax 3
```

---

## 9. ğŸ“Š è·³è½¬æ—¥å¿—å®¡è®¡


### 9.1 SSHæ—¥å¿—é…ç½®


**ğŸ“ è¯¦ç»†æ—¥å¿—è®°å½•**
```bash
# /etc/ssh/sshd_config æ—¥å¿—é…ç½®
LogLevel VERBOSE
SyslogFacility AUTHPRIV

# è®°å½•ç”¨æˆ·æ´»åŠ¨
Subsystem sftp /usr/lib/openssh/sftp-server -l INFO
```

**ğŸ” æ—¥å¿—åˆ†æç¤ºä¾‹**
```bash
# æŸ¥çœ‹SSHè¿æ¥æ—¥å¿—
tail -f /var/log/auth.log | grep sshd

# åˆ†æè·³è½¬é“¾è·¯
grep "ProxyJump\|ProxyCommand" /var/log/auth.log
```

### 9.2 ä¼šè¯è®°å½•é…ç½®


**ğŸ“¹ ä¼šè¯å½•åˆ¶è®¾ç½®**
```bash
# ä½¿ç”¨scriptå‘½ä»¤è®°å½•ä¼šè¯
# ~/.bashrc åœ¨è·³æ¿æœºä¸Šæ·»åŠ 
if [ -n "$SSH_CLIENT" ]; then
    script -f /var/log/sessions/$(date +%Y%m%d_%H%M%S)_${USER}_session.log
fi
```

**âš™ï¸ é«˜çº§å®¡è®¡å·¥å…·**
```bash
# å®‰è£…å¹¶é…ç½®auditd
yum install audit -y

# å®¡è®¡SSHç›¸å…³æ–‡ä»¶è®¿é—®
auditctl -w /home -p wa -k ssh_home_access
auditctl -w /etc/ssh/ -p wa -k ssh_config_change
```

### 9.3 é›†ä¸­åŒ–æ—¥å¿—ç®¡ç†


**ğŸ“¡ æ—¥å¿—è½¬å‘é…ç½®**
```bash
# rsyslogé…ç½®è½¬å‘SSHæ—¥å¿—
# /etc/rsyslog.conf
authpriv.*    $$log-server.company.com:514

# logrotateé…ç½®æ—¥å¿—è½®è½¬
# /etc/logrotate.d/ssh-sessions
/var/log/sessions/*.log {
    daily
    missingok
    rotate 30
    compress
    notifempty
    create 644 root root
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è·³æ¿æœºåŸç†ï¼šé€šè¿‡ä¸­é—´æœåŠ¡å™¨ä»£ç†è®¿é—®ç›®æ ‡æœåŠ¡å™¨
ğŸ”¸ ProxyJumpï¼šç°ä»£SSHå¤šçº§è·³è½¬çš„é¦–é€‰æ–¹æ¡ˆ
ğŸ”¸ ProxyCommandï¼šçµæ´»çš„ä»£ç†å‘½ä»¤é…ç½®æ–¹å¼
ğŸ”¸ é“¾å¼è®¤è¯ï¼šå¤šçº§è·³è½¬ä¸­çš„å¯†é’¥å’Œè®¤è¯ç®¡ç†
ğŸ”¸ å®‰å…¨ç­–ç•¥ï¼šè®¿é—®æ§åˆ¶ã€å‘½ä»¤é™åˆ¶ã€ç½‘ç»œé˜²æŠ¤
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šè¿æ¥å¤ç”¨ã€å‹ç¼©ã€keepalive
ğŸ”¸ å®¡è®¡æ—¥å¿—ï¼šå…¨é“¾è·¯æ“ä½œè®°å½•å’Œåˆ†æ
```

### 10.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ åŸºç¡€é…ç½®æ¨¡æ¿**
```bash
# æ ‡å‡†è·³æ¿æœºé…ç½®æ¨¡æ¿
Host jumphost
    HostName jump.company.com
    User jumpuser
    IdentityFile ~/.ssh/jump_key
    ControlMaster auto
    ControlPath ~/.ssh/sockets/%r@%h:%p
    ControlPersist 600

Host target
    HostName 192.168.1.100
    User admin
    ProxyJump jumphost
    IdentityFile ~/.ssh/target_key
```

**ğŸ”¹ å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•**
- â˜‘ï¸ **å¯†é’¥è®¤è¯**ï¼šç¦ç”¨å¯†ç è®¤è¯ï¼Œä½¿ç”¨å¯†é’¥è®¤è¯
- â˜‘ï¸ **æƒé™æœ€å°åŒ–**ï¼šé™åˆ¶ç”¨æˆ·å’Œå‘½ä»¤æ‰§è¡Œæƒé™
- â˜‘ï¸ **ç½‘ç»œéš”ç¦»**ï¼šé…ç½®é˜²ç«å¢™é™åˆ¶ç½‘ç»œè®¿é—®
- â˜‘ï¸ **æ—¥å¿—å®¡è®¡**ï¼šå¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•
- â˜‘ï¸ **è¿æ¥é™åˆ¶**ï¼šé™åˆ¶å¹¶å‘è¿æ¥æ•°å’Œä¼šè¯æ—¶é—´

### 10.3 å¸¸è§é—®é¢˜æ’æŸ¥


**ğŸ› è¿æ¥é—®é¢˜è¯Šæ–­**
```bash
# è°ƒè¯•SSHè¿æ¥
ssh -vvv -J jumphost target

# æµ‹è¯•è·³æ¿æœºè¿é€šæ€§
ssh -o ConnectTimeout=5 jumphost echo "Connection OK"

# æ£€æŸ¥ç½‘ç»œè·¯å¾„
traceroute jumphost.company.com
```

**âš¡ æ€§èƒ½é—®é¢˜ä¼˜åŒ–**
```bash
# æ£€æŸ¥è¿æ¥å¤ç”¨çŠ¶æ€
ssh -O check jumphost

# ç›‘æ§ç½‘ç»œå»¶è¿Ÿ
ping -c 10 jumphost.company.com

# æµ‹è¯•ä¼ è¾“é€Ÿåº¦
scp -J jumphost test_file target:/tmp/
```

### 10.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ é…ç½®ç®¡ç†**
- ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†SSHé…ç½®æ–‡ä»¶
- å®šæœŸæ›´æ–°å’Œè½®æ¢SSHå¯†é’¥
- æ ‡å‡†åŒ–è·³æ¿æœºé…ç½®æ¨¡æ¿
- å»ºç«‹é…ç½®å˜æ›´å®¡æ‰¹æµç¨‹

**ğŸ”’ å®‰å…¨ç®¡ç†**
- å®æ–½æœ€å°æƒé™åŸåˆ™
- å®šæœŸå®¡è®¡è®¿é—®æ—¥å¿—
- ç›‘æ§å¼‚å¸¸è®¿é—®è¡Œä¸º
- å»ºç«‹åº”æ€¥å“åº”æµç¨‹

**ğŸ“ˆ è¿ç»´ç®¡ç†**
- ç›‘æ§è·³æ¿æœºèµ„æºä½¿ç”¨æƒ…å†µ
- å»ºç«‹è·³æ¿æœºé«˜å¯ç”¨æ¶æ„
- ä¼˜åŒ–ç½‘ç»œè·¯å¾„å’Œæ€§èƒ½
- å®šæœŸè¿›è¡Œç¾éš¾æ¢å¤æ¼”ç»ƒ

**æ ¸å¿ƒè®°å¿†**ï¼š
- SSHè·³æ¿æœºæ˜¯ç½‘ç»œå®‰å…¨è®¿é—®çš„é‡è¦å·¥å…·
- ProxyJumpç®€åŒ–äº†å¤šçº§è·³è½¬é…ç½®
- å®‰å…¨ç­–ç•¥å’Œå®¡è®¡æ—¥å¿—åŒæ ·é‡è¦
- æ€§èƒ½ä¼˜åŒ–èƒ½æ˜¾è‘—æ”¹å–„ç”¨æˆ·ä½“éªŒ