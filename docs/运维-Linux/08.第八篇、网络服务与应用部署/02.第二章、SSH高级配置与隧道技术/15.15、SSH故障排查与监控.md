---
title: 15、SSH故障排查与监控
---
## 📚 目录

1. [SSH故障排查基础](#1-SSH故障排查基础)
2. [连接失败诊断流程](#2-连接失败诊断流程)
3. [网络连通性测试](#3-网络连通性测试)
4. [密钥认证问题排查](#4-密钥认证问题排查)
5. [权限配置错误诊断](#5-权限配置错误诊断)
6. [性能问题定位分析](#6-性能问题定位分析)
7. [日志分析与追踪](#7-日志分析与追踪)
8. [监控指标与告警设置](#8-监控指标与告警设置)
9. [常见问题解决方案](#9-常见问题解决方案)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔍 SSH故障排查基础


### 1.1 SSH故障的基本概念


**什么是SSH故障排查**？
简单来说，就是当SSH连接出现问题时，我们用系统性的方法找出问题根源并解决它。就像医生看病一样，先观察症状，再逐步检查，最后对症下药。

**SSH故障的常见表现**：
- 连接超时或拒绝连接
- 认证失败或权限被拒绝
- 连接速度很慢
- 连接频繁断开
- 无法执行特定命令

### 1.2 故障排查的基本思路


```
SSH连接故障排查思维导图：

问题现象
    ├── 网络层面
    │   ├── 网络不通
    │   ├── 端口不通
    │   └── 防火墙阻止
    ├── 服务层面  
    │   ├── SSH服务未启动
    │   ├── 配置错误
    │   └── 资源不足
    ├── 认证层面
    │   ├── 密码错误
    │   ├── 密钥问题
    │   └── 权限错误
    └── 系统层面
        ├── 磁盘空间不足
        ├── 内存不足
        └── 系统负载过高
```

### 1.3 排查的基本原则


> 💡 **分层排查原则**：从底层网络开始，逐步向上排查到应用层

**排查顺序**：
1. **网络连通性** - 能否ping通目标主机
2. **端口可达性** - SSH端口是否开放
3. **服务状态** - SSH服务是否正常运行
4. **配置正确性** - SSH配置是否正确
5. **认证机制** - 用户认证是否有问题
6. **权限设置** - 文件和目录权限是否正确

---

## 2. 🚨 连接失败诊断流程


### 2.1 SSH连接失败的系统诊断流程


```
SSH连接诊断流程图：

开始连接
    ↓
网络是否可达？ ——No——> 检查网络配置
    ↓ Yes
端口是否开放？ ——No——> 检查防火墙/端口
    ↓ Yes  
SSH服务运行？ ——No——> 启动SSH服务
    ↓ Yes
配置是否正确？ —No——> 检查SSH配置
    ↓ Yes
认证是否成功？ —No——> 检查认证方式
    ↓ Yes
连接成功
```

### 2.2 快速诊断命令


**基础连接测试**：
```bash
# 测试基本连接（带详细输出）
ssh -v username@hostname

# 测试特定端口
ssh -p 2222 username@hostname

# 强制使用密码认证
ssh -o PreferredAuthentications=password username@hostname
```

> ⚠️ **注意**：`-v` 参数会显示详细的连接过程，这是排查问题的重要工具

### 2.3 常见连接错误及含义


| 错误信息 | **含义** | **可能原因** |
|---------|----------|-------------|
| `Connection refused` | `连接被拒绝` | `SSH服务未启动或端口错误` |
| `Connection timed out` | `连接超时` | `网络不通或防火墙阻止` |
| `Permission denied` | `权限被拒绝` | `认证失败或权限配置错误` |
| `Host key verification failed` | `主机密钥验证失败` | `主机密钥发生变化` |
| `No route to host` | `无法到达主机` | `网络路由问题` |

---

## 3. 🌐 网络连通性测试


### 3.1 网络连通性检查的重要性


网络连通性是SSH连接的基础。就像打电话一样，如果电话线都不通，就无法通话。网络连通性测试要检查**物理连接**、**路由配置**和**网络设备状态**。

### 3.2 基本网络测试方法


**ping测试** - 检查主机是否可达：
```bash
# 基本ping测试
ping -c 4 192.168.1.100

# 连续ping测试（查看稳定性）
ping 192.168.1.100

# 指定网络接口ping
ping -I eth0 192.168.1.100
```

**traceroute测试** - 查看网络路径：
```bash
# 追踪网络路径
traceroute 192.168.1.100

# 使用TCP方式追踪
tcptraceroute 192.168.1.100 22
```

### 3.3 端口连通性测试


```bash
# 使用telnet测试端口
telnet 192.168.1.100 22

# 使用nc（netcat）测试端口
nc -zv 192.168.1.100 22

# 使用nmap扫描端口
nmap -p 22 192.168.1.100
```

> 📖 **概念解释**：端口连通性测试是检查目标主机的特定端口是否开放并接受连接

### 3.4 网络问题的解决思路


```
网络问题排查步骤：

1. 本地网络检查
   ├── 检查本机IP配置：ip addr show
   ├── 检查路由表：ip route show  
   └── 检查DNS配置：cat /etc/resolv.conf

2. 目标主机检查
   ├── ping目标IP地址
   ├── ping目标主机名
   └── 检查目标主机网络服务

3. 中间网络检查
   ├── 追踪路由路径
   ├── 检查防火墙规则
   └── 检查网络设备状态
```

---

## 4. 🔑 密钥认证问题排查


### 4.1 SSH密钥认证的工作原理


SSH密钥认证就像是一把特殊的钥匙和锁的关系。你的**私钥**是钥匙，服务器上的**公钥**是锁。只有配对的钥匙才能打开对应的锁。

```
SSH密钥认证流程：

客户端                     服务器
  |                         |
  |--1.请求连接------------->|
  |                         |--2.发送随机数据
  |<-3.返回随机数据----------|
  |                         |
  |--4.用私钥签名数据------->|
  |                         |--5.用公钥验证签名
  |                         |--6.验证成功
  |<-7.允许连接-------------|
```

### 4.2 密钥认证问题的常见症状


- **Private key rejected**：私钥被拒绝
- **Permission denied (publickey)**：公钥认证失败  
- **Load key permission denied**：私钥文件权限错误
- **No such file or directory**：密钥文件不存在

### 4.3 密钥文件权限检查


> ⚠️ **重要**：SSH对密钥文件的权限要求非常严格，权限过松会被拒绝使用

**正确的权限设置**：
```bash
# 检查密钥文件权限
ls -la ~/.ssh/

# 正确的权限应该是：
# ~/.ssh/ 目录：700 (drwx------)
# ~/.ssh/id_rsa 私钥：600 (-rw-------)  
# ~/.ssh/id_rsa.pub 公钥：644 (-rw-r--r--)
# ~/.ssh/authorized_keys：600 (-rw-------)

# 修正权限
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub
chmod 600 ~/.ssh/authorized_keys
```

### 4.4 密钥认证问题排查步骤


**第一步：验证密钥文件存在性**
```bash
# 检查客户端私钥
ls -la ~/.ssh/id_rsa

# 检查服务器端公钥
ls -la ~/.ssh/authorized_keys
```

**第二步：验证密钥匹配性**
```bash
# 比较公钥指纹
ssh-keygen -lf ~/.ssh/id_rsa.pub
ssh-keygen -lf ~/.ssh/authorized_keys
```

**第三步：测试密钥加载**
```bash
# 测试私钥是否可以加载
ssh-keygen -y -f ~/.ssh/id_rsa

# 使用ssh-agent测试
ssh-add ~/.ssh/id_rsa
ssh-add -l
```

---

## 5. 🔐 权限配置错误诊断


### 5.1 SSH权限体系概述


SSH的权限控制涉及多个层面，就像是一道道关卡，每一道都要通过才能最终连接成功：

```
SSH权限检查层次：

系统级权限
    ├── 用户账户是否存在
    ├── 用户是否被锁定
    └── 用户是否在允许登录的组中
        ↓
SSH服务权限  
    ├── SSH配置是否允许该用户
    ├── 是否允许密码/密钥认证
    └── 是否限制登录时间/IP
        ↓
文件系统权限
    ├── 家目录权限
    ├── .ssh目录权限
    └── 密钥文件权限
```

### 5.2 用户账户权限检查


```bash
# 检查用户是否存在
id username
getent passwd username

# 检查用户状态
passwd -S username

# 检查用户组
groups username

# 检查用户登录限制
cat /etc/security/access.conf
```

### 5.3 SSH配置权限检查


**重要的SSH配置选项**：
```bash
# 检查SSH配置文件
sudo cat /etc/ssh/sshd_config | grep -E "(AllowUsers|DenyUsers|AllowGroups|DenyGroups|PermitRootLogin)"

# 常见配置项含义：
# AllowUsers：只允许指定用户登录
# DenyUsers：禁止指定用户登录  
# AllowGroups：只允许指定组的用户登录
# DenyGroups：禁止指定组的用户登录
# PermitRootLogin：是否允许root用户登录
```

### 5.4 文件权限诊断工具


```bash
# SSH权限检查脚本示例
#!/bin/bash
check_ssh_permissions() {
    local user=$1
    local home_dir=$(eval echo ~$user)
    
    echo "检查用户: $user"
    echo "家目录: $home_dir"
    
    # 检查家目录权限
    ls -ld $home_dir
    
    # 检查.ssh目录权限
    ls -ld $home_dir/.ssh 2>/dev/null
    
    # 检查密钥文件权限
    ls -la $home_dir/.ssh/ 2>/dev/null
}
```

---

## 6. ⚡ 性能问题定位分析


### 6.1 SSH性能问题的表现


SSH性能问题通常表现为：
- **连接建立缓慢**：从输入命令到看到提示符需要很长时间
- **命令执行延迟**：输入命令后响应慢
- **文件传输速度慢**：scp/sftp传输速度远低于网络带宽
- **连接频繁断开**：长时间无操作后连接中断

### 6.2 网络性能测试


```bash
# 测试网络延迟
ping -c 10 target_host

# 测试网络带宽（使用iperf3）
# 在服务器端：
iperf3 -s

# 在客户端：
iperf3 -c server_ip

# 测试SSH特定的网络性能
time ssh user@host 'echo "test"'
```

### 6.3 SSH连接性能调优


**客户端优化配置**：
```bash
# ~/.ssh/config 性能优化配置
Host *
    # 启用连接复用
    ControlMaster auto
    ControlPath ~/.ssh/sockets/%r@%h-%p
    ControlPersist 600
    
    # 启用压缩（慢速网络）
    Compression yes
    
    # 加快连接建立
    GSSAPIAuthentication no
    UseDNS no
```

**服务器端优化配置**：
```bash
# /etc/ssh/sshd_config 性能优化
UseDNS no                    # 不进行DNS反向解析
GSSAPIAuthentication no      # 禁用GSSAPI认证
MaxStartups 30:30:100        # 允许更多并发连接
ClientAliveInterval 30       # 保持连接活跃
ClientAliveCountMax 3        # 允许的无响应次数
```

### 6.4 系统资源监控


```bash
# 监控系统负载
top
htop

# 监控网络连接
ss -tulpn | grep :22
netstat -an | grep :22

# 监控SSH进程
ps aux | grep sshd

# 检查系统日志中的性能相关信息
journalctl -u ssh -f
```

---

## 7. 📋 日志分析与追踪


### 7.1 SSH日志系统概述


SSH日志记录了所有的连接尝试、认证过程和错误信息。这些日志就像是SSH服务的"黑匣子"，记录了发生的一切。

**SSH日志的位置**：
- **Ubuntu/Debian**：`/var/log/auth.log`
- **CentOS/RHEL**：`/var/log/secure`
- **系统日志**：`journalctl -u ssh`

### 7.2 日志级别与配置


```bash
# SSH日志级别设置
# /etc/ssh/sshd_config
LogLevel INFO          # 记录级别：QUIET, FATAL, ERROR, INFO, VERBOSE, DEBUG

# 设置详细日志记录
LogLevel VERBOSE       # 记录更多详细信息
```

> 📖 **日志级别说明**：
> - **QUIET**：只记录致命错误
> - **FATAL**：记录致命错误  
> - **ERROR**：记录错误信息
> - **INFO**：记录一般信息（默认）
> - **VERBOSE**：记录详细信息
> - **DEBUG**：记录调试信息

### 7.3 日志分析实用命令


**查看SSH连接日志**：
```bash
# 查看最近的SSH连接
sudo tail -f /var/log/auth.log | grep sshd

# 查看特定用户的连接记录
sudo grep "user_name" /var/log/auth.log

# 查看失败的登录尝试
sudo grep "Failed password" /var/log/auth.log

# 查看成功的登录
sudo grep "Accepted" /var/log/auth.log

# 统计登录失败次数
sudo grep "Failed password" /var/log/auth.log | wc -l
```

### 7.4 日志分析的实际案例


**案例1：密钥认证失败分析**
```bash
# 日志内容示例
Mar 15 10:30:15 server sshd[12345]: Connection from 192.168.1.100 port 54321
Mar 15 10:30:15 server sshd[12345]: Invalid user test from 192.168.1.100
Mar 15 10:30:15 server sshd[12345]: Connection closed by 192.168.1.100

# 分析结果：用户名不存在
```

**案例2：权限问题分析**
```bash
# 日志内容示例  
Mar 15 10:35:20 server sshd[12346]: Authentication refused: bad ownership or modes for directory /home/user

# 分析结果：家目录权限配置错误
```

### 7.5 日志轮转与管理


```bash
# 配置日志轮转（/etc/logrotate.d/ssh）
/var/log/auth.log {
    weekly
    rotate 4
    compress
    delaycompress
    missingok
    notifempty
    create 640 root adm
}
```

---

## 8. 📊 监控指标与告警设置


### 8.1 SSH监控的重要性


SSH服务监控就像是给服务器安装了一个"健康监测器"，能够实时了解SSH服务的运行状态，及时发现和预防问题。

### 8.2 关键监控指标


**连接相关指标**：
- **活跃连接数**：当前SSH连接的数量
- **连接成功率**：成功连接与尝试连接的比率  
- **连接响应时间**：从请求到建立连接的时间
- **连接失败次数**：认证失败或连接被拒绝的次数

**性能相关指标**：
- **CPU使用率**：SSH进程的CPU占用
- **内存使用率**：SSH进程的内存占用
- **网络流量**：SSH连接的网络使用情况
- **磁盘I/O**：日志写入等磁盘操作

### 8.3 监控工具与方法


**系统自带监控命令**：
```bash
# 监控SSH连接数
ss -an | grep :22 | wc -l

# 监控SSH进程状态
systemctl status ssh

# 实时监控SSH连接
watch 'ss -an | grep :22'

# 监控认证失败次数
tail -f /var/log/auth.log | grep "Failed"
```

**脚本化监控示例**：
```bash
#!/bin/bash
# SSH监控脚本
monitor_ssh() {
    # 检查SSH服务状态
    if ! systemctl is-active --quiet ssh; then
        echo "警告：SSH服务未运行"
        return 1
    fi
    
    # 统计当前连接数
    conn_count=$(ss -an | grep :22 | wc -l)
    echo "当前SSH连接数: $conn_count"
    
    # 检查最近的失败登录
    failed_count=$(grep "$(date '+%b %d')" /var/log/auth.log | grep "Failed" | wc -l)
    echo "今日登录失败次数: $failed_count"
    
    # 设置告警阈值
    if [ $conn_count -gt 50 ]; then
        echo "警告：SSH连接数过多"
    fi
    
    if [ $failed_count -gt 100 ]; then
        echo "警告：登录失败次数过多，可能遭受暴力破解"
    fi
}
```

### 8.4 告警设置与响应


**基于系统的告警**：
```bash
# 使用系统的监控和告警
# /etc/systemd/system/ssh-monitor.service
[Unit]
Description=SSH Monitoring Service
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/ssh-monitor.sh
User=root

[Install]
WantedBy=multi-user.target

# 定时执行监控
# /etc/cron.d/ssh-monitor
*/5 * * * * root /usr/local/bin/ssh-monitor.sh
```

**告警响应策略**：
- **连接异常**：检查网络和服务状态
- **认证失败过多**：可能的暴力破解攻击
- **性能下降**：检查系统资源和网络状况
- **服务异常**：自动重启或人工干预

---

## 9. 🛠️ 常见问题解决方案


### 9.1 连接超时问题


**问题描述**：SSH连接时出现"Connection timed out"错误

**解决步骤**：
```bash
# 1. 检查网络连通性
ping target_host

# 2. 检查端口是否开放
telnet target_host 22

# 3. 检查防火墙设置
sudo ufw status
sudo iptables -L

# 4. 检查SSH服务状态
sudo systemctl status ssh
```

### 9.2 权限被拒绝问题


**问题描述**：出现"Permission denied"错误

**解决方案矩阵**：

| 认证方式 | **可能原因** | **解决方法** |
|---------|-------------|-------------|
| **密码认证** | `密码错误` | `确认用户名和密码` |
| **密码认证** | `密码认证被禁用` | `修改SSH配置启用密码认证` |
| **密钥认证** | `公钥未添加` | `将公钥添加到authorized_keys` |
| **密钥认证** | `权限错误` | `修正.ssh目录和文件权限` |
| **密钥认证** | `私钥权限过松` | `chmod 600 私钥文件` |

### 9.3 主机密钥验证失败


**问题描述**：出现"Host key verification failed"错误

```bash
# 解决方法1：移除旧的主机密钥
ssh-keygen -R hostname

# 解决方法2：更新known_hosts文件
ssh-keyscan -H hostname >> ~/.ssh/known_hosts

# 解决方法3：跳过主机密钥检查（不推荐用于生产环境）
ssh -o StrictHostKeyChecking=no user@hostname
```

> ⚠️ **安全提醒**：跳过主机密钥检查会降低安全性，只应在测试环境使用

### 9.4 SSH服务无法启动


**问题排查流程**：
```bash
# 1. 检查配置文件语法
sudo sshd -t

# 2. 查看详细错误信息
sudo systemctl status ssh -l

# 3. 检查端口占用
sudo ss -tulpn | grep :22

# 4. 检查SSH配置权限
ls -la /etc/ssh/sshd_config

# 5. 重新生成主机密钥（如果密钥损坏）
sudo ssh-keygen -A
sudo systemctl restart ssh
```

### 9.5 性能问题解决


**连接速度慢的解决方案**：
```bash
# 1. 禁用DNS查找
# /etc/ssh/sshd_config
UseDNS no

# 2. 禁用GSSAPI认证
GSSAPIAuthentication no

# 3. 使用连接复用
# ~/.ssh/config
ControlMaster auto
ControlPath ~/.ssh/sockets/%r@%h-%p
ControlPersist 600

# 4. 启用压缩（慢速网络）
Compression yes
```

### 9.6 安全问题处理


**发现暴力破解攻击**：
```bash
# 1. 统计失败登录尝试
sudo grep "Failed password" /var/log/auth.log | \
awk '{print $11}' | sort | uniq -c | sort -nr

# 2. 使用fail2ban防护
sudo apt install fail2ban
sudo systemctl enable fail2ban

# 3. 修改默认端口
# /etc/ssh/sshd_config
Port 2222

# 4. 禁用root登录
PermitRootLogin no

# 5. 只允许特定用户登录
AllowUsers username1 username2
```

---

## 10. 📋 核心要点总结


### 10.1 SSH故障排查的核心原则


> 💡 **系统化排查**：按照网络→服务→认证→权限的顺序进行
> 
> 🔧 **工具辅助**：善用日志、监控命令和诊断工具
> 
> 📚 **经验积累**：记录常见问题和解决方案

### 10.2 必须掌握的核心技能


```
SSH故障排查技能树：

基础技能
├── 网络连通性测试 (ping, telnet, nc)
├── SSH服务状态检查 (systemctl, ps)
├── 配置文件检查 (sshd -t, cat)
└── 权限检查 (ls -la, chmod)

进阶技能  
├── 日志分析 (grep, awk, journalctl)
├── 性能分析 (top, ss, iperf3)
├── 安全分析 (fail2ban, 访问控制)
└── 自动化监控 (脚本, cron, systemd)
```

### 10.3 故障排查最佳实践


**排查流程标准化**：
1. **收集信息**：错误现象、环境信息、最近变更
2. **假设验证**：基于经验提出假设并逐一验证
3. **分层排查**：从底层到应用层系统化检查
4. **记录过程**：记录排查步骤和解决方案
5. **预防复发**：建立监控和预防机制

**工具使用建议**：
- **日常监控**：`systemctl status`, `ss -tulpn`, `tail -f /var/log/auth.log`
- **深度诊断**：`ssh -v`, `sshd -t`, `strace`, `tcpdump`  
- **性能分析**：`top`, `iotop`, `iperf3`, `ping`
- **安全检查**：`fail2ban-client status`, `grep "Failed" /var/log/auth.log`

### 10.4 安全与监控要点


**安全配置检查清单**：
- ✅ 使用非默认端口
- ✅ 禁用root登录
- ✅ 使用密钥认证
- ✅ 配置访问控制
- ✅ 启用fail2ban
- ✅ 定期更新系统

**监控指标优先级**：
- 🔥 **高优先级**：服务状态、认证失败次数、连接异常
- ⚡ **中优先级**：性能指标、资源使用、网络质量  
- 📊 **低优先级**：访问统计、历史趋势、容量规划

**应急响应准备**：
- 📱 建立告警通知机制
- 🔧 准备常用排查工具和脚本
- 📚 维护问题解决知识库
- 🔄 定期进行故障演练

**核心记忆要点**：
- SSH故障排查要系统化，从网络到应用分层检查
- 日志是排查问题的重要依据，要善于分析和利用
- 权限配置是SSH常见问题源，要重点关注文件权限
- 监控和预防比故障排查更重要，要建立完善的监控体系