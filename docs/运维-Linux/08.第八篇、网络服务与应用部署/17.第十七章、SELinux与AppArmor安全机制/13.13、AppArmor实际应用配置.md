---
title: 13ã€AppArmorå®é™…åº”ç”¨é…ç½®
---
## ğŸ“š ç›®å½•

1. [AppArmorå®é™…åº”ç”¨æ¦‚è¿°](#1-AppArmorå®é™…åº”ç”¨æ¦‚è¿°)
2. [WebæœåŠ¡å™¨AppArmoré…ç½®](#2-WebæœåŠ¡å™¨AppArmoré…ç½®)
3. [æ•°æ®åº“æœåŠ¡profileç¼–å†™](#3-æ•°æ®åº“æœåŠ¡profileç¼–å†™)
4. [SSHæœåŠ¡å®‰å…¨é…ç½®](#4-SSHæœåŠ¡å®‰å…¨é…ç½®)
5. [é‚®ä»¶æœåŠ¡profileè®¾ç½®](#5-é‚®ä»¶æœåŠ¡profileè®¾ç½®)
6. [è‡ªå®šä¹‰åº”ç”¨ç¨‹åºprofile](#6-è‡ªå®šä¹‰åº”ç”¨ç¨‹åºprofile)
7. [ç½‘ç»œæœåŠ¡è®¿é—®æ§åˆ¶](#7-ç½‘ç»œæœåŠ¡è®¿é—®æ§åˆ¶)
8. [æ–‡ä»¶ç³»ç»Ÿæƒé™é™åˆ¶](#8-æ–‡ä»¶ç³»ç»Ÿæƒé™é™åˆ¶)
9. [ç³»ç»Ÿè°ƒç”¨æƒé™æ§åˆ¶](#9-ç³»ç»Ÿè°ƒç”¨æƒé™æ§åˆ¶)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ AppArmorå®é™…åº”ç”¨æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯AppArmorå®é™…åº”ç”¨é…ç½®


**AppArmorå®é™…åº”ç”¨é…ç½®**å°±æ˜¯ä¸ºçœŸå®è¿è¡Œçš„æœåŠ¡ç¨‹åºåˆ›å»ºå®‰å…¨ç­–ç•¥ï¼Œå°±åƒç»™æ¯ä¸ªç¨‹åºé…å¤‡ä¸€ä¸ªä¸“é—¨çš„"å®‰å…¨ä¿é•–"ã€‚

> **ğŸ’¡ æ ¸å¿ƒç†è§£**
> AppArmoré…ç½® = ç¨‹åºèƒ½åšä»€ä¹ˆ + ä¸èƒ½åšä»€ä¹ˆï¼Œé€šè¿‡profileæ–‡ä»¶ç²¾ç¡®æ§åˆ¶ç¨‹åºæƒé™

**ğŸ”¸ å®é™…åº”ç”¨çš„ä»·å€¼ï¼š**
```
æ²¡æœ‰AppArmorï¼š
ç¨‹åºå¯ä»¥è®¿é—®æ•´ä¸ªç³»ç»Ÿ â†’ å®‰å…¨é£é™©é«˜

æœ‰AppArmorä¿æŠ¤ï¼š
ç¨‹åºåªèƒ½è®¿é—®å¿…éœ€èµ„æº â†’ å³ä½¿è¢«æ”»å‡»ï¼ŒæŸå¤±ä¹Ÿæœ‰é™
```

### 1.2 å¸¸è§æœåŠ¡é…ç½®ç­–ç•¥


**ğŸ“Š æœåŠ¡å®‰å…¨ç­‰çº§åˆ†ç±»ï¼š**

| æœåŠ¡ç±»å‹ | **é£é™©ç­‰çº§** | **é…ç½®ç­–ç•¥** | **é‡ç‚¹é™åˆ¶** |
|---------|-------------|-------------|-------------|
| **WebæœåŠ¡** | `é«˜é£é™©` | `ä¸¥æ ¼é™åˆ¶` | `æ–‡ä»¶è®¿é—®ã€ç½‘ç»œç«¯å£` |
| **æ•°æ®åº“** | `æé«˜é£é™©` | `æœ€ä¸¥æ ¼` | `æ•°æ®æ–‡ä»¶ã€ç½‘ç»œè¿æ¥` |
| **SSHæœåŠ¡** | `é«˜é£é™©` | `ä¸¥æ ¼æ§åˆ¶` | `ç³»ç»Ÿè°ƒç”¨ã€æ–‡ä»¶æƒé™` |
| **é‚®ä»¶æœåŠ¡** | `ä¸­é«˜é£é™©` | `é€‚åº¦é™åˆ¶` | `é‚®ä»¶ç›®å½•ã€ç½‘ç»œé€šä¿¡` |

### 1.3 é…ç½®åŸºæœ¬æµç¨‹


**ğŸ”„ AppArmoré…ç½®å·¥ä½œæµï¼š**
```
åˆ†æç¨‹åºéœ€æ±‚ â†’ åˆ›å»ºåˆå§‹profile â†’ æµ‹è¯•è°ƒè¯• â†’ ä¼˜åŒ–å®Œå–„ â†’ ç”Ÿäº§éƒ¨ç½²

å…·ä½“æ­¥éª¤ï¼š
1. äº†è§£ç¨‹åºåŠŸèƒ½å’Œæ–‡ä»¶è®¿é—®éœ€æ±‚
2. ç¼–å†™profileæ–‡ä»¶å®šä¹‰æƒé™
3. è®¾ç½®ä¸ºcomplainæ¨¡å¼æµ‹è¯•
4. æŸ¥çœ‹æ—¥å¿—è°ƒæ•´æƒé™è®¾ç½®
5. åˆ‡æ¢åˆ°enforceæ¨¡å¼æ­£å¼å¯ç”¨
```

---

## 2. ğŸŒ WebæœåŠ¡å™¨AppArmoré…ç½®


### 2.1 Apache WebæœåŠ¡å™¨é…ç½®


**ApacheæœåŠ¡å™¨**æ˜¯æœ€å¸¸ç”¨çš„WebæœåŠ¡å™¨ï¼Œéœ€è¦è®¿é—®ç½‘ç«™æ–‡ä»¶ã€é…ç½®æ–‡ä»¶å’Œæ—¥å¿—æ–‡ä»¶ï¼Œä½†ä¸åº”è¯¥è®¿é—®ç³»ç»Ÿæ•æ„ŸåŒºåŸŸã€‚

> **âš ï¸ å®‰å…¨è€ƒè™‘**
> WebæœåŠ¡å™¨ç»å¸¸é¢ä¸´ç½‘ç»œæ”»å‡»ï¼Œé™åˆ¶å…¶æ–‡ä»¶è®¿é—®æƒé™èƒ½å¤§å¤§é™ä½è¢«å…¥ä¾µåçš„æŸå¤±

**ğŸ”§ åŸºç¡€Apache profileï¼š**
```bash
# /etc/apparmor.d/usr.sbin.apache2
#include <tunables/global>

/usr/sbin/apache2 {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/web-common>

  # ç¨‹åºæ‰§è¡Œæƒé™
  /usr/sbin/apache2 mr,
  
  # é…ç½®æ–‡ä»¶è®¿é—®
  /etc/apache2/** r,
  /etc/ssl/certs/ r,
  /etc/ssl/certs/** r,
  
  # ç½‘ç«™å†…å®¹ç›®å½•
  /var/www/** r,
  /srv/www/** r,
  
  # æ—¥å¿—æ–‡ä»¶å†™å…¥
  /var/log/apache2/* w,
  
  # è¿è¡Œæ—¶ç›®å½•
  /var/run/apache2.pid w,
  /run/apache2/** rw,
  
  # ç¦æ­¢è®¿é—®æ•æ„Ÿç›®å½•
  deny /etc/shadow r,
  deny /etc/passwd w,
  deny /home/** r,
}
```

### 2.2 Nginx WebæœåŠ¡å™¨é…ç½®


**Nginxé…ç½®è¦ç‚¹ï¼š**
- Nginxé‡‡ç”¨å¤šè¿›ç¨‹æ¨¡å‹ï¼Œéœ€è¦è€ƒè™‘workerè¿›ç¨‹æƒé™
- é™æ€æ–‡ä»¶æœåŠ¡éœ€è¦è¯»å–æƒé™
- åå‘ä»£ç†éœ€è¦ç½‘ç»œè¿æ¥æƒé™

**ğŸ“ å®ç”¨Nginx profileï¼š**
```bash
# /etc/apparmor.d/usr.sbin.nginx
#include <tunables/global>

/usr/sbin/nginx {
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # ä¸»ç¨‹åºæƒé™
  /usr/sbin/nginx mr,
  
  # é…ç½®æ–‡ä»¶
  /etc/nginx/** r,
  
  # ç½‘ç«™æ ¹ç›®å½•
  /var/www/** r,
  /usr/share/nginx/** r,
  
  # æ—¥å¿—å’Œç¼“å­˜
  /var/log/nginx/** w,
  /var/cache/nginx/** rw,
  
  # è¿è¡Œæ—¶æ–‡ä»¶
  /var/run/nginx.pid w,
  /run/nginx.pid w,
  
  # ä¸´æ—¶ç›®å½•
  /tmp/ rw,
  /var/tmp/ rw,
}
```

### 2.3 WebæœåŠ¡å®‰å…¨åŠ å›º


**ğŸ›¡ï¸ é«˜çº§å®‰å…¨é…ç½®ï¼š**
```bash
# é™åˆ¶CGIè„šæœ¬æ‰§è¡Œ
/usr/lib/cgi-bin/** px -> cgi_script,

# CGIè„šæœ¬ä¸“é—¨çš„profile
profile cgi_script {
  #include <abstractions/base>
  
  # åªèƒ½è¯»å–æŒ‡å®šç›®å½•
  /var/www/cgi-data/** r,
  
  # ç¦æ­¢ç½‘ç»œè®¿é—®
  deny network,
  
  # ç¦æ­¢æ‰§è¡Œç³»ç»Ÿå‘½ä»¤
  deny /bin/** x,
  deny /usr/bin/** x,
}
```

---

## 3. ğŸ—„ï¸ æ•°æ®åº“æœåŠ¡profileç¼–å†™


### 3.1 MySQLæ•°æ®åº“é…ç½®


**MySQLæ•°æ®åº“**å­˜å‚¨é‡è¦æ•°æ®ï¼Œæ˜¯æ”»å‡»è€…çš„ä¸»è¦ç›®æ ‡ï¼Œéœ€è¦æœ€ä¸¥æ ¼çš„æƒé™æ§åˆ¶ã€‚

**ğŸ”’ MySQLå®‰å…¨profileï¼š**
```bash
# /etc/apparmor.d/usr.sbin.mysqld
#include <tunables/global>

/usr/sbin/mysqld {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/mysql>

  # ç¨‹åºæœ¬èº«
  /usr/sbin/mysqld mr,
  
  # é…ç½®æ–‡ä»¶ï¼ˆåªè¯»ï¼‰
  /etc/mysql/** r,
  
  # æ•°æ®ç›®å½•ï¼ˆè¯»å†™ï¼‰
  /var/lib/mysql/** rwk,
  /var/lib/mysql-files/** rw,
  
  # æ—¥å¿—æ–‡ä»¶
  /var/log/mysql/** rw,
  /var/log/mysql.log w,
  
  # ä¸´æ—¶æ–‡ä»¶
  /tmp/mysql.sock rw,
  /var/run/mysqld/** rw,
  
  # äºŒè¿›åˆ¶æ—¥å¿—
  /var/log/mysql/mysql-bin.* rw,
  
  # ä¸¥æ ¼ç¦æ­¢
  deny /etc/shadow r,
  deny /home/** rwx,
  deny /root/** rwx,
  deny /usr/bin/** x,
}
```

### 3.2 PostgreSQLæ•°æ®åº“é…ç½®


**PostgreSQLç‰¹ç‚¹ï¼š**
- æ”¯æŒå¤æ‚æŸ¥è¯¢å’Œæ‰©å±•
- å¤šç”¨æˆ·è®¿é—®éœ€è¦æ›´ç»†ç²’åº¦æ§åˆ¶
- éœ€è¦è®¿é—®ç³»ç»Ÿæ—¶åŒºå’Œå­—ç¬¦é›†ä¿¡æ¯

**ğŸ”§ PostgreSQL profileç¤ºä¾‹ï¼š**
```bash
# /etc/apparmor.d/usr.lib.postgresql.bin.postgres
#include <tunables/global>

/usr/lib/postgresql/*/bin/postgres {
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # ä¸»ç¨‹åº
  /usr/lib/postgresql/*/bin/postgres mr,
  
  # é…ç½®æ–‡ä»¶
  /etc/postgresql/** r,
  
  # æ•°æ®é›†ç¾¤ç›®å½•
  /var/lib/postgresql/** rwk,
  
  # æ—¥å¿—æ–‡ä»¶
  /var/log/postgresql/** rw,
  
  # ç³»ç»Ÿä¿¡æ¯ï¼ˆåªè¯»ï¼‰
  /usr/share/zoneinfo/** r,
  /usr/share/locale/** r,
  
  # è¿è¡Œæ—¶æ–‡ä»¶
  /var/run/postgresql/** rw,
}
```

### 3.3 æ•°æ®åº“å®‰å…¨æœ€ä½³å®è·µ


**ğŸ“‹ å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•ï¼š**
- âœ… æ•°æ®æ–‡ä»¶ç›®å½•æƒé™æœ€å°åŒ–
- âœ… ç¦æ­¢è®¿é—®ç³»ç»Ÿæ•æ„Ÿæ–‡ä»¶
- âœ… é™åˆ¶ç½‘ç»œè¿æ¥ç«¯å£
- âœ… æ—¥å¿—æ–‡ä»¶è®¿é—®æ§åˆ¶
- âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†æœºåˆ¶

---

## 4. ğŸ” SSHæœåŠ¡å®‰å…¨é…ç½®


### 4.1 SSHæœåŠ¡å®‰å…¨é‡è¦æ€§


**SSHæœåŠ¡**æ˜¯è¿œç¨‹ç®¡ç†ç³»ç»Ÿçš„ä¸»è¦å…¥å£ï¼Œä¸€æ—¦è¢«æ”»ç ´ï¼Œæ”»å‡»è€…å°±èƒ½å®Œå…¨æ§åˆ¶ç³»ç»Ÿã€‚

> **ğŸ¯ å®‰å…¨ç›®æ ‡**
> SSHåªèƒ½åšå¿…éœ€çš„è®¤è¯å’Œè¿æ¥ç®¡ç†ï¼Œä¸èƒ½è®¿é—®ç”¨æˆ·æ•°æ®æˆ–æ‰§è¡Œå±é™©æ“ä½œ

### 4.2 SSH daemoné…ç½®


**ğŸ›¡ï¸ sshdå®‰å…¨profileï¼š**
```bash
# /etc/apparmor.d/usr.sbin.sshd
#include <tunables/global>

/usr/sbin/sshd {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/authentication>

  # SSHç¨‹åºæœ¬èº«
  /usr/sbin/sshd mr,
  
  # é…ç½®æ–‡ä»¶ï¼ˆåªè¯»ï¼‰
  /etc/ssh/sshd_config r,
  /etc/ssh/ssh_host_*_key r,
  
  # è®¤è¯ç›¸å…³
  /etc/passwd r,
  /etc/group r,
  /etc/shadow r,
  
  # ç”¨æˆ·ä¸»ç›®å½•ï¼ˆé™åˆ¶è®¿é—®ï¼‰
  owner /home/*/.ssh/** r,
  
  # æ—¥å¿—è®°å½•
  /var/log/auth.log w,
  /var/log/secure w,
  
  # è¿è¡Œæ—¶æ–‡ä»¶
  /var/run/sshd.pid w,
  /run/sshd.pid w,
  
  # PAMè®¤è¯
  /lib/security/pam_*.so mr,
  
  # ç¦æ­¢æ‰§è¡Œshellï¼ˆé˜²æ­¢æ”»å‡»ï¼‰
  deny /bin/bash x,
  deny /bin/sh x,
  
  # å­è¿›ç¨‹æ‰§è¡Œæƒé™
  /usr/sbin/sshd px -> sshd_child,
}

# SSHå­è¿›ç¨‹profile
profile sshd_child {
  #include <abstractions/base>
  #include <abstractions/bash>
  
  # å…è®¸æ‰§è¡Œç”¨æˆ·shell
  /bin/bash px,
  /bin/dash px,
  
  # ç”¨æˆ·ç¯å¢ƒ
  owner /home/*/** rw,
}
```

### 4.3 SSHå®¢æˆ·ç«¯é…ç½®


**ğŸ“± sshå®¢æˆ·ç«¯profileï¼š**
```bash
# /etc/apparmor.d/usr.bin.ssh
/usr/bin/ssh {
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # SSHå®¢æˆ·ç«¯ç¨‹åº
  /usr/bin/ssh mr,
  
  # é…ç½®æ–‡ä»¶
  /etc/ssh/ssh_config r,
  owner /home/*/.ssh/** r,
  
  # ä¸»æœºå¯†é’¥
  /etc/ssh/ssh_host_*_key.pub r,
  
  # å·²çŸ¥ä¸»æœº
  owner /home/*/.ssh/known_hosts rw,
  
  # ä¸´æ—¶æ–‡ä»¶
  /tmp/ssh-*/* rw,
}
```

---

## 5. ğŸ“§ é‚®ä»¶æœåŠ¡profileè®¾ç½®


### 5.1 Postfixé‚®ä»¶æœåŠ¡å™¨


**Postfix**æ˜¯æµè¡Œçš„é‚®ä»¶ä¼ è¾“ä»£ç†ï¼Œéœ€è¦å¤„ç†é‚®ä»¶æ”¶å‘ã€é˜Ÿåˆ—ç®¡ç†å’Œç”¨æˆ·è®¤è¯ã€‚

**ğŸ“® Postfixä¸»è¿›ç¨‹é…ç½®ï¼š**
```bash
# /etc/apparmor.d/usr.lib.postfix.sbin.master
/usr/lib/postfix/sbin/master {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/postfix-common>

  # ä¸»ç¨‹åº
  /usr/lib/postfix/sbin/master mr,
  
  # é…ç½®æ–‡ä»¶
  /etc/postfix/** r,
  
  # é‚®ä»¶é˜Ÿåˆ—
  /var/spool/postfix/** rw,
  
  # æ—¥å¿—æ–‡ä»¶
  /var/log/mail.* w,
  
  # è¿è¡Œæ—¶æ–‡ä»¶
  /var/run/postfix.pid w,
  
  # å­è¿›ç¨‹å¯åŠ¨
  /usr/lib/postfix/sbin/* px,
}
```

### 5.2 Dovecot IMAP/POP3æœåŠ¡


**ğŸ”§ Dovecoté…ç½®è¦ç‚¹ï¼š**
- éœ€è¦è®¿é—®ç”¨æˆ·é‚®ç®±ç›®å½•
- å¤„ç†IMAP/POP3è¿æ¥
- ç”¨æˆ·è®¤è¯å’Œæƒé™æ£€æŸ¥

**ğŸ“¥ åŸºç¡€Dovecot profileï¼š**
```bash
# /etc/apparmor.d/usr.sbin.dovecot
/usr/sbin/dovecot {
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # ä¸»ç¨‹åº
  /usr/sbin/dovecot mr,
  
  # é…ç½®æ–‡ä»¶
  /etc/dovecot/** r,
  
  # é‚®ç®±ç›®å½•
  /var/mail/** rw,
  owner /home/*/Maildir/** rw,
  
  # æ—¥å¿—æ–‡ä»¶
  /var/log/dovecot.log w,
  
  # è¿è¡Œæ—¶æ–‡ä»¶
  /var/run/dovecot/** rw,
  
  # SSLè¯ä¹¦
  /etc/ssl/certs/dovecot.pem r,
  /etc/ssl/private/dovecot.pem r,
}
```

---

## 6. ğŸ”§ è‡ªå®šä¹‰åº”ç”¨ç¨‹åºprofile


### 6.1 åˆ†æåº”ç”¨éœ€æ±‚


åˆ›å»ºè‡ªå®šä¹‰åº”ç”¨ç¨‹åºprofileéœ€è¦æ·±å…¥äº†è§£ç¨‹åºçš„å·¥ä½œæ–¹å¼å’Œèµ„æºéœ€æ±‚ã€‚

> **ğŸ“‹ åˆ†ææ­¥éª¤**
> 1. è¿è¡Œç¨‹åºï¼Œè§‚å¯Ÿå…¶è¡Œä¸º
> 2. ä½¿ç”¨ç³»ç»Ÿç›‘æ§å·¥å…·åˆ†ææ–‡ä»¶è®¿é—®
> 3. è¯†åˆ«ç½‘ç»œè¿æ¥å’Œç³»ç»Ÿè°ƒç”¨
> 4. ç¼–å†™æœ€å°æƒé™profile

### 6.2 ä½¿ç”¨å·¥å…·è¾…åŠ©åˆ†æ


**ğŸ” ç¨‹åºè¡Œä¸ºåˆ†æå‘½ä»¤ï¼š**
```bash
# ä½¿ç”¨straceè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨
sudo strace -f -o /tmp/app.trace /path/to/your/app

# ä½¿ç”¨lsofæŸ¥çœ‹æ–‡ä»¶è®¿é—®
sudo lsof -p $(pgrep your-app)

# æŸ¥çœ‹ç½‘ç»œè¿æ¥
sudo netstat -tulpn | grep your-app
```

### 6.3 è‡ªå®šä¹‰Webåº”ç”¨profile


**ğŸŒŸ Node.jsåº”ç”¨ç¤ºä¾‹ï¼š**
```bash
# /etc/apparmor.d/usr.bin.node.myapp
profile myapp /usr/bin/node {
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # Node.jså¯æ‰§è¡Œæ–‡ä»¶
  /usr/bin/node mr,
  
  # åº”ç”¨ç¨‹åºæ–‡ä»¶
  /opt/myapp/** r,
  /opt/myapp/public/** r,
  
  # Nodeæ¨¡å—
  /opt/myapp/node_modules/** r,
  
  # é…ç½®æ–‡ä»¶
  /opt/myapp/config/** r,
  
  # æ—¥å¿—æ–‡ä»¶
  /var/log/myapp/** rw,
  
  # ä¸´æ—¶æ–‡ä»¶
  /tmp/myapp-* rw,
  
  # ç¦æ­¢è®¿é—®ç³»ç»Ÿæ•æ„ŸåŒºåŸŸ
  deny /etc/shadow r,
  deny /home/** r,
  deny /root/** r,
  
  # ç½‘ç»œæƒé™
  network inet stream,
  network inet dgram,
}
```

### 6.4 Pythonåº”ç”¨profile


**ğŸ Python Webåº”ç”¨é…ç½®ï¼š**
```bash
# Python Flaskåº”ç”¨profile
profile flask-app /usr/bin/python3 {
  #include <abstractions/base>
  #include <abstractions/python>

  # Pythonè§£é‡Šå™¨
  /usr/bin/python3 mr,
  
  # åº”ç”¨ä»£ç 
  /var/www/flask-app/** r,
  
  # Pythonåº“
  /usr/lib/python3*/** r,
  /usr/local/lib/python3*/** r,
  
  # ä¸Šä¼ ç›®å½•
  /var/www/flask-app/uploads/** rw,
  
  # æ•°æ®åº“æ–‡ä»¶ï¼ˆSQLiteï¼‰
  /var/www/flask-app/database.db rw,
  
  # ç¦æ­¢æ‰§è¡Œç³»ç»Ÿå‘½ä»¤
  deny /bin/** x,
  deny /usr/bin/** x,
}
```

---

## 7. ğŸŒ ç½‘ç»œæœåŠ¡è®¿é—®æ§åˆ¶


### 7.1 ç½‘ç»œæƒé™åŸºç¡€


**ç½‘ç»œè®¿é—®æ§åˆ¶**é™åˆ¶ç¨‹åºèƒ½å»ºç«‹çš„ç½‘ç»œè¿æ¥ç±»å‹ï¼Œé˜²æ­¢æ¶æ„ç½‘ç»œæ´»åŠ¨ã€‚

**ğŸ“Š ç½‘ç»œæƒé™ç±»å‹ï¼š**

| æƒé™ç±»å‹ | **å«ä¹‰** | **ä½¿ç”¨åœºæ™¯** | **é£é™©çº§åˆ«** |
|---------|----------|-------------|-------------|
| `network inet` | `IPv4ç½‘ç»œ` | `WebæœåŠ¡ã€APIè°ƒç”¨` | `ä¸­ç­‰` |
| `network inet6` | `IPv6ç½‘ç»œ` | `ç°ä»£ç½‘ç»œæœåŠ¡` | `ä¸­ç­‰` |
| `network unix` | `UnixåŸŸå¥—æ¥å­—` | `è¿›ç¨‹é—´é€šä¿¡` | `ä½` |
| `network netlink` | `å†…æ ¸é€šä¿¡` | `ç³»ç»Ÿç®¡ç†å·¥å…·` | `é«˜` |

### 7.2 WebæœåŠ¡ç½‘ç»œæƒé™


**ğŸŒ HTTPæœåŠ¡ç½‘ç»œé…ç½®ï¼š**
```bash
# åŸºç¡€WebæœåŠ¡ç½‘ç»œæƒé™
network inet stream,    # TCPè¿æ¥
network inet6 stream,   # IPv6 TCPè¿æ¥

# ç‰¹å®šç«¯å£ç»‘å®š
network bind tcp port 80,
network bind tcp port 443,

# DNSæŸ¥è¯¢
network inet dgram,     # UDP for DNS

# ç¦æ­¢å…¶ä»–ç½‘ç»œè®¿é—®
deny network raw,       # ç¦æ­¢åŸå§‹å¥—æ¥å­—
deny network packet,    # ç¦æ­¢åŒ…å¥—æ¥å­—
```

### 7.3 æ•°æ®åº“ç½‘ç»œé™åˆ¶


**ğŸ”’ æ•°æ®åº“ç½‘ç»œå®‰å…¨é…ç½®ï¼š**
```bash
# MySQLç½‘ç»œæƒé™
network inet stream,
network bind tcp port 3306,

# åªå…è®¸æœ¬åœ°è¿æ¥
network bind tcp addr 127.0.0.1 port 3306,
network bind tcp addr ::1 port 3306,

# ç¦æ­¢å¯¹å¤–è¿æ¥
deny network connect,
```

---

## 8. ğŸ“ æ–‡ä»¶ç³»ç»Ÿæƒé™é™åˆ¶


### 8.1 æ–‡ä»¶è®¿é—®æƒé™è¯¦è§£


**æ–‡ä»¶ç³»ç»Ÿæƒé™**æ§åˆ¶ç¨‹åºèƒ½è®¿é—®å“ªäº›æ–‡ä»¶å’Œç›®å½•ï¼Œè¿™æ˜¯AppArmoræœ€é‡è¦çš„å®‰å…¨åŠŸèƒ½ã€‚

**ğŸ”¸ æƒé™æ ‡è®°è¯´æ˜ï¼š**
- `r` - è¯»å–æ–‡ä»¶å†…å®¹
- `w` - å†™å…¥æ–‡ä»¶å†…å®¹  
- `x` - æ‰§è¡Œæ–‡ä»¶
- `m` - å†…å­˜æ˜ å°„
- `k` - æ–‡ä»¶é”å®š
- `l` - é“¾æ¥åˆ›å»º

### 8.2 ç›®å½•æƒé™é…ç½®


**ğŸ“‚ å¸¸è§ç›®å½•æƒé™æ¨¡å¼ï¼š**
```bash
# é…ç½®æ–‡ä»¶ï¼ˆåªè¯»ï¼‰
/etc/myapp/** r,

# æ•°æ®ç›®å½•ï¼ˆè¯»å†™ï¼‰
/var/lib/myapp/** rw,

# æ—¥å¿—ç›®å½•ï¼ˆè¿½åŠ å†™å…¥ï¼‰
/var/log/myapp/* w,

# ä¸´æ—¶ç›®å½•ï¼ˆå®Œå…¨è®¿é—®ï¼‰
/tmp/myapp-* rw,

# ç”¨æˆ·ç›®å½•ï¼ˆæ‰€æœ‰è€…è®¿é—®ï¼‰
owner /home/*/.myapp/** rw,

# ç³»ç»Ÿç›®å½•ï¼ˆç¦æ­¢è®¿é—®ï¼‰
deny /etc/shadow r,
deny /etc/ssh/** r,
```

### 8.3 æ–‡ä»¶æƒé™æœ€ä½³å®è·µ


**ğŸ›¡ï¸ å®‰å…¨é…ç½®åŸåˆ™ï¼š**

> **âš ï¸ æœ€å°æƒé™åŸåˆ™**
> ç¨‹åºåªèƒ½è®¿é—®å·¥ä½œå¿…éœ€çš„æ–‡ä»¶ï¼Œå¤šä½™æƒé™éƒ½è¦ç§»é™¤

**ğŸ“‹ æƒé™æ£€æŸ¥æ¸…å•ï¼š**
- âœ… é…ç½®æ–‡ä»¶åªç»™è¯»æƒé™
- âœ… æ•°æ®æ–‡ä»¶æŒ‰éœ€ç»™è¯»å†™æƒé™
- âœ… æ—¥å¿—æ–‡ä»¶åªç»™å†™æƒé™
- âœ… ä¸´æ—¶æ–‡ä»¶é™åˆ¶åœ¨æŒ‡å®šç›®å½•
- âœ… ç³»ç»Ÿæ•æ„Ÿæ–‡ä»¶æ˜ç¡®ç¦æ­¢

**ğŸ”§ å®ç”¨æƒé™æ¨¡æ¿ï¼š**
```bash
# Webåº”ç”¨æ ‡å‡†æƒé™
/var/www/html/** r,           # ç½‘ç«™å†…å®¹ï¼ˆåªè¯»ï¼‰
/var/www/uploads/** rw,       # ä¸Šä¼ ç›®å½•ï¼ˆè¯»å†™ï¼‰
/var/log/webapp/* w,          # æ—¥å¿—æ–‡ä»¶ï¼ˆå†™å…¥ï¼‰
/etc/webapp/config.ini r,     # é…ç½®æ–‡ä»¶ï¼ˆåªè¯»ï¼‰

# å®‰å…¨é™åˆ¶
deny /etc/passwd w,           # ç¦æ­¢ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
deny /etc/shadow rw,          # ç¦æ­¢è®¿é—®å¯†ç æ–‡ä»¶
deny /home/** r,              # ç¦æ­¢è®¿é—®ç”¨æˆ·ç›®å½•
deny /root/** rw,             # ç¦æ­¢è®¿é—®rootç›®å½•
```

---

## 9. âš™ï¸ ç³»ç»Ÿè°ƒç”¨æƒé™æ§åˆ¶


### 9.1 ç³»ç»Ÿè°ƒç”¨å®‰å…¨æ„ä¹‰


**ç³»ç»Ÿè°ƒç”¨**æ˜¯ç¨‹åºä¸æ“ä½œç³»ç»Ÿå†…æ ¸äº¤äº’çš„æ¥å£ï¼Œæ§åˆ¶ç³»ç»Ÿè°ƒç”¨æƒé™èƒ½é˜²æ­¢ç¨‹åºè¿›è¡Œå±é™©æ“ä½œã€‚

> **ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ**
> ç³»ç»Ÿè°ƒç”¨æƒé™ = ç¨‹åºèƒ½å‘å†…æ ¸è¯·æ±‚ä»€ä¹ˆæœåŠ¡ï¼Œæ¯”å¦‚åˆ›å»ºè¿›ç¨‹ã€è®¿é—®ç½‘ç»œã€æ“ä½œæ–‡ä»¶

### 9.2 å¸¸è§å±é™©ç³»ç»Ÿè°ƒç”¨


**âš ï¸ éœ€è¦é™åˆ¶çš„ç³»ç»Ÿè°ƒç”¨ï¼š**

| ç³»ç»Ÿè°ƒç”¨ | **ç”¨é€”** | **é£é™©** | **é™åˆ¶å»ºè®®** |
|---------|----------|----------|-------------|
| `ptrace` | `è¿›ç¨‹è°ƒè¯•` | `å¯ä»¥æ§åˆ¶å…¶ä»–è¿›ç¨‹` | `WebæœåŠ¡ç¦ç”¨` |
| `mount` | `æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ` | `å¯ä»¥ä¿®æ”¹ç³»ç»Ÿç»“æ„` | `ä¸¥æ ¼ç¦æ­¢` |
| `reboot` | `é‡å¯ç³»ç»Ÿ` | `æ‹’ç»æœåŠ¡æ”»å‡»` | `æ™®é€šç¨‹åºç¦ç”¨` |
| `chmod` | `ä¿®æ”¹æ–‡ä»¶æƒé™` | `æƒé™æå‡` | `é™åˆ¶ä½¿ç”¨` |

### 9.3 ç³»ç»Ÿè°ƒç”¨æƒé™é…ç½®


**ğŸ”’ WebæœåŠ¡ç³»ç»Ÿè°ƒç”¨é™åˆ¶ï¼š**
```bash
# WebæœåŠ¡profileä¸­çš„ç³»ç»Ÿè°ƒç”¨æ§åˆ¶
profile webservice {
  # å…è®¸çš„åŸºç¡€è°ƒç”¨
  allow sys_read,
  allow sys_write,
  allow sys_open,
  allow sys_close,
  
  # ç½‘ç»œç›¸å…³è°ƒç”¨
  allow sys_socket,
  allow sys_bind,
  allow sys_listen,
  allow sys_accept,
  
  # ç¦æ­¢å±é™©è°ƒç”¨
  deny sys_ptrace,        # ç¦æ­¢è¿›ç¨‹è°ƒè¯•
  deny sys_mount,         # ç¦æ­¢æŒ‚è½½æ“ä½œ
  deny sys_reboot,        # ç¦æ­¢é‡å¯ç³»ç»Ÿ
  deny sys_module,        # ç¦æ­¢åŠ è½½å†…æ ¸æ¨¡å—
  deny sys_rawio,         # ç¦æ­¢ç›´æ¥ç¡¬ä»¶è®¿é—®
}
```

### 9.4 capabilitiesæƒé™æ§åˆ¶


**ğŸ›ï¸ Linux capabilitiesé…ç½®ï¼š**
```bash
# ç²¾ç¡®æ§åˆ¶ç¨‹åºæƒé™
capability setuid,      # å…è®¸æ”¹å˜ç”¨æˆ·ID
capability setgid,      # å…è®¸æ”¹å˜ç»„ID
capability net_bind_service,  # å…è®¸ç»‘å®šç‰¹æƒç«¯å£

# ç¦æ­¢å±é™©æƒé™
deny capability sys_admin,    # ç¦æ­¢ç³»ç»Ÿç®¡ç†æƒé™
deny capability sys_module,   # ç¦æ­¢æ¨¡å—ç®¡ç†
deny capability sys_rawio,    # ç¦æ­¢åŸå§‹IOè®¿é—®
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ AppArmorå®é™…é…ç½®ï¼šä¸ºçœŸå®æœåŠ¡åˆ›å»ºå®‰å…¨ç­–ç•¥çš„å®è·µè¿‡ç¨‹
ğŸ”¸ æœåŠ¡ç‰¹å®šé…ç½®ï¼šä¸åŒæœåŠ¡æœ‰ä¸åŒçš„å®‰å…¨éœ€æ±‚å’Œæƒé™é…ç½®
ğŸ”¸ æœ€å°æƒé™åŸåˆ™ï¼šç¨‹åºåªèƒ½è®¿é—®å·¥ä½œå¿…éœ€çš„èµ„æº
ğŸ”¸ å¤šå±‚é˜²æŠ¤ç­–ç•¥ï¼šæ–‡ä»¶+ç½‘ç»œ+ç³»ç»Ÿè°ƒç”¨å…¨æ–¹ä½é™åˆ¶
ğŸ”¸ é…ç½®æµ‹è¯•æµç¨‹ï¼šcomplainæ¨¡å¼æµ‹è¯• â†’ è°ƒæ•´ä¼˜åŒ– â†’ enforceæ¨¡å¼éƒ¨ç½²
```

### 10.2 å„ç±»æœåŠ¡é…ç½®è¦ç‚¹


**ğŸ”¹ WebæœåŠ¡å™¨é…ç½®é‡ç‚¹ï¼š**
```
å…³é”®é…ç½®ï¼š
- ç½‘ç«™å†…å®¹ç›®å½•åªè¯»æƒé™
- æ—¥å¿—æ–‡ä»¶å†™å…¥æƒé™  
- ç¦æ­¢è®¿é—®ç³»ç»Ÿæ•æ„Ÿæ–‡ä»¶
- é™åˆ¶ç½‘ç»œç«¯å£ç»‘å®š
```

**ğŸ”¹ æ•°æ®åº“æœåŠ¡é…ç½®é‡ç‚¹ï¼š**
```
å®‰å…¨è¦æ±‚ï¼š
- æ•°æ®æ–‡ä»¶ä¸¥æ ¼è®¿é—®æ§åˆ¶
- é…ç½®æ–‡ä»¶åªè¯»æƒé™
- ç¦æ­¢æ‰§è¡Œç³»ç»Ÿå‘½ä»¤
- ç½‘ç»œè¿æ¥æœ€å°åŒ–
```

**ğŸ”¹ SSHæœåŠ¡é…ç½®é‡ç‚¹ï¼š**
```
æ ¸å¿ƒé™åˆ¶ï¼š
- è®¤è¯æ–‡ä»¶è®¿é—®æƒé™
- ç”¨æˆ·ç›®å½•æœ‰é™è®¿é—®
- ç¦æ­¢æ‰§è¡Œå±é™©å‘½ä»¤
- å­è¿›ç¨‹æƒé™æ§åˆ¶
```

### 10.3 å®é™…æ“ä½œæŒ‡å¯¼


**ğŸš€ é…ç½®å®æ–½æ­¥éª¤ï¼š**
```
1. åˆ†ææœåŠ¡éœ€æ±‚ â†’ äº†è§£ç¨‹åºåŠŸèƒ½å’Œèµ„æºè®¿é—®
2. åˆ›å»ºåŸºç¡€profile â†’ ç¼–å†™åˆå§‹æƒé™é…ç½®
3. Complainæ¨¡å¼æµ‹è¯• â†’ è§‚å¯Ÿç¨‹åºè¡Œä¸ºå’Œæƒé™éœ€æ±‚
4. è°ƒæ•´ä¼˜åŒ–æƒé™ â†’ æ ¹æ®æ—¥å¿—å®Œå–„é…ç½®
5. Enforceæ¨¡å¼éƒ¨ç½² â†’ æ­£å¼å¯ç”¨å®‰å…¨ä¿æŠ¤
```

**ğŸ” å¸¸è§é—®é¢˜æ’æŸ¥ï¼š**
```
æƒé™ä¸è¶³ï¼šæŸ¥çœ‹/var/log/kern.logä¸­çš„DENIEDæ¶ˆæ¯
æœåŠ¡å¯åŠ¨å¤±è´¥ï¼šæ£€æŸ¥profileä¸­æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
ç½‘ç»œè¿æ¥é—®é¢˜ï¼šç¡®è®¤networkæƒé™é…ç½®
æ–‡ä»¶è®¿é—®å¤±è´¥ï¼šéªŒè¯æ–‡ä»¶æƒé™æ ‡è®°ï¼ˆr/w/xï¼‰
```

### 10.4 å®‰å…¨é…ç½®æœ€ä½³å®è·µ


**ğŸ’¡ é…ç½®ä¼˜åŒ–å»ºè®®ï¼š**
- **æ¸è¿›å¼é…ç½®**ï¼šä»å®½æ¾é€æ­¥æ”¶ç´§æƒé™
- **æ—¥å¿—ç›‘æ§**ï¼šæŒç»­ç›‘æ§å®‰å…¨äº‹ä»¶
- **å®šæœŸå®¡æŸ¥**ï¼šæ£€æŸ¥é…ç½®æ˜¯å¦ä»ç„¶é€‚ç”¨
- **æ–‡æ¡£è®°å½•**ï¼šè¯¦ç»†è®°å½•é…ç½®åŸå› å’Œå˜æ›´

**ğŸ¯ è®°å¿†è¦ç‚¹**ï¼š
- WebæœåŠ¡é‡ç‚¹æ§åˆ¶æ–‡ä»¶è®¿é—®å’Œç½‘ç»œç«¯å£
- æ•°æ®åº“æœåŠ¡éœ€è¦æœ€ä¸¥æ ¼çš„æƒé™é™åˆ¶  
- SSHæœåŠ¡è¦é˜²æ­¢æƒé™æå‡æ”»å‡»
- è‡ªå®šä¹‰åº”ç”¨éœ€è¦è¯¦ç»†çš„è¡Œä¸ºåˆ†æ
- ç³»ç»Ÿè°ƒç”¨æ§åˆ¶æ˜¯æœ€åä¸€é“å®‰å…¨é˜²çº¿

**æ ¸å¿ƒç†å¿µ**ï¼šAppArmorå®é™…åº”ç”¨é…ç½®å°±æ˜¯ä¸ºæ¯ä¸ªæœåŠ¡é‡èº«å®šåˆ¶"å®‰å…¨è§„åˆ™"ï¼Œç¡®ä¿ç¨‹åºåªèƒ½åšè¯¥åšçš„äº‹ï¼Œä¸èƒ½åšä¸è¯¥åšçš„äº‹ã€‚