---
title: 3ã€FTPç”¨æˆ·ç®¡ç†ä¸è®¤è¯
---
## ğŸ“š ç›®å½•

1. [FTPç”¨æˆ·ç®¡ç†åŸºç¡€æ¦‚å¿µ](#1-FTPç”¨æˆ·ç®¡ç†åŸºç¡€æ¦‚å¿µ)
2. [æœ¬åœ°ç”¨æˆ·FTPè®¿é—®é…ç½®](#2-æœ¬åœ°ç”¨æˆ·FTPè®¿é—®é…ç½®)
3. [è™šæ‹Ÿç”¨æˆ·åˆ›å»ºä¸ç®¡ç†](#3-è™šæ‹Ÿç”¨æˆ·åˆ›å»ºä¸ç®¡ç†)
4. [åŒ¿åç”¨æˆ·è®¿é—®æ§åˆ¶](#4-åŒ¿åç”¨æˆ·è®¿é—®æ§åˆ¶)
5. [PAMè®¤è¯æ¨¡å—é…ç½®](#5-PAMè®¤è¯æ¨¡å—é…ç½®)
6. [ç”¨æˆ·ç™»å½•æƒé™æ§åˆ¶](#6-ç”¨æˆ·ç™»å½•æƒé™æ§åˆ¶)
7. [ç”¨æˆ·é»‘åå•ä¸ç™½åå•ç®¡ç†](#7-ç”¨æˆ·é»‘åå•ä¸ç™½åå•ç®¡ç†)
8. [ç”¨æˆ·chrootç›‘ç‹±è®¾ç½®](#8-ç”¨æˆ·chrootç›‘ç‹±è®¾ç½®)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ FTPç”¨æˆ·ç®¡ç†åŸºç¡€æ¦‚å¿µ


### 1.1 FTPç”¨æˆ·ç±»å‹è¯¦è§£


FTPæœåŠ¡å™¨æ”¯æŒä¸‰ç§ä¸åŒç±»å‹çš„ç”¨æˆ·è®¿é—®æ–¹å¼ï¼Œæ¯ç§éƒ½æœ‰å…¶ç‰¹å®šçš„ä½¿ç”¨åœºæ™¯å’Œå®‰å…¨è€ƒè™‘ï¼š

**ğŸ”¸ æœ¬åœ°ç”¨æˆ·ï¼ˆSystem Usersï¼‰**
```
å®šä¹‰ï¼šä½¿ç”¨ç³»ç»Ÿä¸­å·²å­˜åœ¨çš„ç”¨æˆ·è´¦æˆ·è¿›è¡ŒFTPç™»å½•
ç‰¹ç‚¹ï¼šè´¦æˆ·ä¿¡æ¯å­˜å‚¨åœ¨/etc/passwdä¸­
ä¼˜åŠ¿ï¼šç®¡ç†ç®€å•ï¼Œä¸ç³»ç»Ÿç”¨æˆ·æƒé™ä¸€è‡´
é£é™©ï¼šå¦‚æœFTPè¢«æ”»ç ´ï¼Œæ”»å‡»è€…å¯èƒ½è·å¾—ç³»ç»Ÿæƒé™
```

**ğŸ”¸ è™šæ‹Ÿç”¨æˆ·ï¼ˆVirtual Usersï¼‰**
```
å®šä¹‰ï¼šä¸“é—¨ä¸ºFTPæœåŠ¡åˆ›å»ºçš„ç”¨æˆ·ï¼Œä¸åœ¨ç³»ç»Ÿç”¨æˆ·åˆ—è¡¨ä¸­
ç‰¹ç‚¹ï¼šè´¦æˆ·ä¿¡æ¯å­˜å‚¨åœ¨ç‹¬ç«‹çš„æ•°æ®åº“æˆ–æ–‡ä»¶ä¸­
ä¼˜åŠ¿ï¼šå®‰å…¨æ€§é«˜ï¼ŒFTPæƒé™ä¸ç³»ç»Ÿæƒé™éš”ç¦»
åº”ç”¨ï¼šæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒçš„FTPæœåŠ¡
```

**ğŸ”¸ åŒ¿åç”¨æˆ·ï¼ˆAnonymous Usersï¼‰**
```
å®šä¹‰ï¼šæ— éœ€è´¦æˆ·å¯†ç å³å¯è®¿é—®çš„ç”¨æˆ·
ç‰¹ç‚¹ï¼šä½¿ç”¨anonymousæˆ–ftpä½œä¸ºç”¨æˆ·å
ä¼˜åŠ¿ï¼šä¾¿äºå…¬å¼€æ–‡ä»¶åˆ†äº«
é£é™©ï¼šå®¹æ˜“è¢«æ»¥ç”¨ï¼Œéœ€è¦ä¸¥æ ¼æƒé™æ§åˆ¶
```

### 1.2 ç”¨æˆ·è®¤è¯æµç¨‹


```
å®¢æˆ·ç«¯è¿æ¥FTPæœåŠ¡å™¨
         â†“
    å‘é€ç”¨æˆ·åå¯†ç 
         â†“
FTPæœåŠ¡å™¨éªŒè¯è®¤è¯ä¿¡æ¯
    â†“        â†“        â†“
æœ¬åœ°ç”¨æˆ·éªŒè¯  è™šæ‹Ÿç”¨æˆ·éªŒè¯  åŒ¿åç”¨æˆ·éªŒè¯
    â†“        â†“        â†“
æ£€æŸ¥æƒé™é…ç½®  æ£€æŸ¥æƒé™é…ç½®  æ£€æŸ¥æƒé™é…ç½®
    â†“        â†“        â†“
        å»ºç«‹è¿æ¥ä¼šè¯
         â†“
    åº”ç”¨chrooté™åˆ¶
```

### 1.3 å®‰å…¨è€ƒè™‘ä¸æœ€ä½³å®è·µ


> âš ï¸ **å®‰å…¨è­¦å‘Š**
> 
> FTPåè®®æœ¬èº«ä¸åŠ å¯†ï¼Œå¯†ç ä»¥æ˜æ–‡ä¼ è¾“ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨SFTPæˆ–FTPS

**ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ**
- ğŸ¯ **æœ€å°æƒé™åŸåˆ™**ï¼šç”¨æˆ·åªèƒ½è®¿é—®å¿…éœ€çš„ç›®å½•
- ğŸ”’ **chrootç›‘ç‹±**ï¼šé™åˆ¶ç”¨æˆ·åœ¨æŒ‡å®šç›®å½•èŒƒå›´å†…æ´»åŠ¨
- ğŸ“‹ **ç”¨æˆ·åˆ—è¡¨ç®¡ç†**ï¼šä½¿ç”¨ç™½åå•æ§åˆ¶å…è®¸ç™»å½•çš„ç”¨æˆ·
- ğŸš« **ç¦ç”¨å±é™©è´¦æˆ·**ï¼šé˜»æ­¢rootç­‰ç‰¹æƒç”¨æˆ·FTPç™»å½•

---

## 2. ğŸ‘¤ æœ¬åœ°ç”¨æˆ·FTPè®¿é—®é…ç½®


### 2.1 å¯ç”¨æœ¬åœ°ç”¨æˆ·FTPè®¿é—®


æœ¬åœ°ç”¨æˆ·FTPè®¿é—®å…è®¸ç³»ç»Ÿä¸­çš„çœŸå®ç”¨æˆ·é€šè¿‡FTPæœåŠ¡è®¿é—®æ–‡ä»¶ã€‚è¿™æ˜¯æœ€ç›´æ¥çš„é…ç½®æ–¹å¼ã€‚

**vsftpd.conf æ ¸å¿ƒé…ç½®**
```bash
# å¯ç”¨æœ¬åœ°ç”¨æˆ·ç™»å½•
local_enable=YES

# å…è®¸æœ¬åœ°ç”¨æˆ·å†™å…¥æƒé™
write_enable=YES

# æœ¬åœ°ç”¨æˆ·é»˜è®¤æƒé™æ©ç 
local_umask=022

# æœ¬åœ°ç”¨æˆ·ç™»å½•åçš„æ ¹ç›®å½•
local_root=/home/ftpuser
```

> ğŸ’¡ **é…ç½®è¯´æ˜**
> 
> - `local_enable=YES` æ˜¯å¯ç”¨æœ¬åœ°ç”¨æˆ·çš„å…³é”®å‚æ•°
> - `local_umask=022` è®¾ç½®æ–°å»ºæ–‡ä»¶æƒé™ä¸º755ï¼ˆç›®å½•ï¼‰å’Œ644ï¼ˆæ–‡ä»¶ï¼‰
> - `local_root` å¯ä»¥ç»Ÿä¸€è®¾ç½®æ‰€æœ‰æœ¬åœ°ç”¨æˆ·çš„æ ¹ç›®å½•

### 2.2 åˆ›å»ºä¸“ç”¨FTPç”¨æˆ·


ä¸ºäº†å®‰å…¨èµ·è§ï¼Œé€šå¸¸ä¸ç›´æ¥ä½¿ç”¨æ™®é€šç³»ç»Ÿç”¨æˆ·è¿›è¡ŒFTPè®¿é—®ï¼Œè€Œæ˜¯åˆ›å»ºä¸“é—¨çš„FTPç”¨æˆ·ï¼š

**åˆ›å»ºFTPä¸“ç”¨ç”¨æˆ·**
```bash
# åˆ›å»ºFTPç”¨æˆ·ç»„
sudo groupadd ftpgroup

# åˆ›å»ºFTPç”¨æˆ·ï¼ŒæŒ‡å®šå®¶ç›®å½•å’Œshell
sudo useradd -g ftpgroup -d /home/ftpuser -s /sbin/nologin ftpuser

# è®¾ç½®ç”¨æˆ·å¯†ç 
sudo passwd ftpuser

# åˆ›å»ºå¹¶è®¾ç½®å®¶ç›®å½•æƒé™
sudo mkdir -p /home/ftpuser/upload
sudo chown ftpuser:ftpgroup /home/ftpuser
sudo chmod 755 /home/ftpuser
sudo chmod 755 /home/ftpuser/upload
```

> ğŸ“Œ **é‡è¦è¯´æ˜**
> 
> ä½¿ç”¨`/sbin/nologin`ä½œä¸ºshellå¯ä»¥é˜²æ­¢ç”¨æˆ·ç›´æ¥ç™»å½•ç³»ç»Ÿï¼Œåªèƒ½é€šè¿‡FTPè®¿é—®

### 2.3 æœ¬åœ°ç”¨æˆ·æƒé™é…ç½®


**ç²¾ç»†åŒ–æƒé™æ§åˆ¶**
```bash
# vsftpd.conf æƒé™é…ç½®
local_enable=YES
write_enable=YES
local_umask=022

# å…è®¸ä¸Šä¼ 
anon_upload_enable=NO
local_upload_enable=YES

# å…è®¸åˆ›å»ºç›®å½•
anon_mkdir_write_enable=NO
local_mkdir_write_enable=YES

# é™åˆ¶ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„å®¶ç›®å½•
chroot_local_user=YES
```

**éªŒè¯æœ¬åœ°ç”¨æˆ·é…ç½®**
```bash
# æµ‹è¯•FTPè¿æ¥
ftp localhost
# è¾“å…¥åˆ›å»ºçš„ç”¨æˆ·åå’Œå¯†ç 
# éªŒè¯æ˜¯å¦èƒ½æ­£å¸¸ç™»å½•å’Œæ“ä½œæ–‡ä»¶
```

---

## 3. ğŸ‘¥ è™šæ‹Ÿç”¨æˆ·åˆ›å»ºä¸ç®¡ç†


### 3.1 è™šæ‹Ÿç”¨æˆ·çš„æ¦‚å¿µä¸ä¼˜åŠ¿


è™šæ‹Ÿç”¨æˆ·æ˜¯FTPæœåŠ¡å™¨ç‹¬æœ‰çš„ç”¨æˆ·ç³»ç»Ÿï¼Œä¸Linuxç³»ç»Ÿç”¨æˆ·å®Œå…¨åˆ†ç¦»ã€‚è¿™ç§æ–¹å¼æä¾›äº†æ›´é«˜çš„å®‰å…¨æ€§å’Œçµæ´»æ€§ã€‚

**ğŸ”¸ è™šæ‹Ÿç”¨æˆ·çš„ç‰¹ç‚¹**
```
âœ… ä¸ç³»ç»Ÿç”¨æˆ·éš”ç¦»ï¼Œæé«˜å®‰å…¨æ€§
âœ… å¯ä»¥æ‰¹é‡åˆ›å»ºå’Œç®¡ç†
âœ… æ”¯æŒä¸åŒçš„æƒé™é…ç½®
âœ… ä¾¿äºç”¨æˆ·ä¿¡æ¯çš„å¤‡ä»½å’Œè¿ç§»
âœ… å¯ä»¥ä½¿ç”¨æ•°æ®åº“å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
```

### 3.2 åŸºäºæ–‡ä»¶çš„è™šæ‹Ÿç”¨æˆ·é…ç½®


**æ­¥éª¤ 1ï¸âƒ£ï¼šåˆ›å»ºè™šæ‹Ÿç”¨æˆ·æ•°æ®æ–‡ä»¶**
```bash
# åˆ›å»ºè™šæ‹Ÿç”¨æˆ·åˆ—è¡¨æ–‡ä»¶
sudo vim /etc/vsftpd/virtual_users.txt

# æ–‡ä»¶å†…å®¹æ ¼å¼ï¼ˆç”¨æˆ·åå’Œå¯†ç äº¤æ›¿å‡ºç°ï¼‰
user1
password1
user2
password2
user3
password3
```

**æ­¥éª¤ 2ï¸âƒ£ï¼šç”Ÿæˆè™šæ‹Ÿç”¨æˆ·æ•°æ®åº“**
```bash
# å®‰è£…db4-utilså·¥å…·åŒ…ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
sudo yum install db4-utils  # CentOS/RHEL
sudo apt install db-util    # Ubuntu/Debian

# å°†æ–‡æœ¬æ–‡ä»¶è½¬æ¢ä¸ºæ•°æ®åº“æ ¼å¼
sudo db_load -T -t hash -f /etc/vsftpd/virtual_users.txt /etc/vsftpd/virtual_users.db

# è®¾ç½®æ•°æ®åº“æ–‡ä»¶æƒé™
sudo chmod 600 /etc/vsftpd/virtual_users.db
```

**æ­¥éª¤ 3ï¸âƒ£ï¼šåˆ›å»ºè™šæ‹Ÿç”¨æˆ·æ˜ å°„çš„ç³»ç»Ÿç”¨æˆ·**
```bash
# åˆ›å»ºè™šæ‹Ÿç”¨æˆ·æ˜ å°„çš„ç³»ç»Ÿç”¨æˆ·
sudo useradd -d /home/ftpvirtual -s /sbin/nologin ftpvirtual

# åˆ›å»ºè™šæ‹Ÿç”¨æˆ·æ ¹ç›®å½•
sudo mkdir -p /home/ftpvirtual
sudo chown ftpvirtual:ftpvirtual /home/ftpvirtual
sudo chmod 755 /home/ftpvirtual
```

### 3.3 PAMé…ç½®æ”¯æŒè™šæ‹Ÿç”¨æˆ·


**åˆ›å»ºPAMé…ç½®æ–‡ä»¶**
```bash
# åˆ›å»ºvsftpdçš„PAMé…ç½®
sudo vim /etc/pam.d/vsftpd.virtual

# æ·»åŠ ä»¥ä¸‹å†…å®¹
auth required pam_userdb.so db=/etc/vsftpd/virtual_users
account required pam_userdb.so db=/etc/vsftpd/virtual_users
session required pam_loginuid.so
```

### 3.4 vsftpdè™šæ‹Ÿç”¨æˆ·é…ç½®


**vsftpd.conf è™šæ‹Ÿç”¨æˆ·é…ç½®**
```bash
# ç¦ç”¨æœ¬åœ°ç”¨æˆ·ï¼Œå¯ç”¨è™šæ‹Ÿç”¨æˆ·
local_enable=NO
anonymous_enable=NO

# å¯ç”¨è™šæ‹Ÿç”¨æˆ·
guest_enable=YES
guest_username=ftpvirtual

# æŒ‡å®šPAMæœåŠ¡åç§°
pam_service_name=vsftpd.virtual

# è™šæ‹Ÿç”¨æˆ·æƒé™
virtual_use_local_privs=YES
write_enable=YES

# è™šæ‹Ÿç”¨æˆ·é…ç½®ç›®å½•
user_config_dir=/etc/vsftpd/virtual_conf
```

### 3.5 ä¸ªæ€§åŒ–è™šæ‹Ÿç”¨æˆ·é…ç½®


ä¸ºä¸åŒçš„è™šæ‹Ÿç”¨æˆ·è®¾ç½®ä¸åŒçš„æƒé™å’Œç›®å½•ï¼š

**åˆ›å»ºè™šæ‹Ÿç”¨æˆ·ä¸ªæ€§åŒ–é…ç½®ç›®å½•**
```bash
sudo mkdir -p /etc/vsftpd/virtual_conf
```

**ä¸ºç‰¹å®šç”¨æˆ·åˆ›å»ºé…ç½®æ–‡ä»¶**
```bash
# ä¸ºuser1åˆ›å»ºä¸“é—¨çš„é…ç½®
sudo vim /etc/vsftpd/virtual_conf/user1

# user1çš„ä¸ªæ€§åŒ–é…ç½®
local_root=/home/ftpvirtual/user1
write_enable=YES
anon_upload_enable=YES
anon_mkdir_write_enable=YES
anon_other_write_enable=YES

# ä¸ºuser2åˆ›å»ºé…ç½®ï¼ˆåªè¯»æƒé™ï¼‰
sudo vim /etc/vsftpd/virtual_conf/user2

# user2çš„ä¸ªæ€§åŒ–é…ç½®  
local_root=/home/ftpvirtual/user2
write_enable=NO
```

**åˆ›å»ºç”¨æˆ·ä¸“ç”¨ç›®å½•**
```bash
sudo mkdir -p /home/ftpvirtual/user1
sudo mkdir -p /home/ftpvirtual/user2
sudo chown ftpvirtual:ftpvirtual /home/ftpvirtual/user*
sudo chmod 755 /home/ftpvirtual/user*
```

---

## 4. ğŸŒ åŒ¿åç”¨æˆ·è®¿é—®æ§åˆ¶


### 4.1 åŒ¿åç”¨æˆ·åŸºæœ¬æ¦‚å¿µ


åŒ¿åç”¨æˆ·è®¿é—®æ˜¯FTPæœåŠ¡çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œå…è®¸ç”¨æˆ·æ— éœ€è´¦æˆ·å³å¯è®¿é—®FTPæœåŠ¡å™¨ã€‚è¿™åœ¨å…¬å…±æ–‡ä»¶åˆ†äº«åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ã€‚

**ğŸ”¸ åŒ¿åç”¨æˆ·ç‰¹ç‚¹**
```
ç”¨æˆ·åï¼šanonymous æˆ– ftp
å¯†ç ï¼šé€šå¸¸ä½¿ç”¨é‚®ç®±åœ°å€ï¼ˆçº¦å®šä¿—æˆï¼‰
ç›®å½•ï¼šé»˜è®¤ä¸º/var/ftpæˆ–æŒ‡å®šçš„åŒ¿åç”¨æˆ·ç›®å½•
æƒé™ï¼šé€šå¸¸åªæœ‰ä¸‹è½½æƒé™ï¼Œä¸Šä¼ éœ€è¦ç‰¹æ®Šé…ç½®
```

### 4.2 å¯ç”¨åŒ¿åç”¨æˆ·è®¿é—®


**åŸºç¡€åŒ¿åç”¨æˆ·é…ç½®**
```bash
# vsftpd.conf åŒ¿åç”¨æˆ·é…ç½®
anonymous_enable=YES

# åŒ¿åç”¨æˆ·æ ¹ç›®å½•
anon_root=/var/ftp

# ä¸è¦æ±‚åŒ¿åç”¨æˆ·å¯†ç 
no_anon_password=YES

# åŒ¿åç”¨æˆ·ç™»å½•æ¬¢è¿ä¿¡æ¯
anon_world_readable_only=NO
```

**åˆ›å»ºåŒ¿åç”¨æˆ·ç›®å½•ç»“æ„**
```bash
# åˆ›å»ºæ ‡å‡†FTPç›®å½•ç»“æ„
sudo mkdir -p /var/ftp/pub
sudo mkdir -p /var/ftp/upload

# è®¾ç½®ç›®å½•æƒé™
sudo chown root:root /var/ftp
sudo chmod 755 /var/ftp
sudo chown ftp:ftp /var/ftp/pub
sudo chmod 755 /var/ftp/pub
```

> âš ï¸ **å®‰å…¨æé†’**
> 
> åŒ¿åç”¨æˆ·æ ¹ç›®å½•ä¸åº”è¯¥å…·æœ‰å†™æƒé™ï¼Œè¿™æ˜¯vsftpdçš„å®‰å…¨è¦æ±‚

### 4.3 åŒ¿åç”¨æˆ·æƒé™æ§åˆ¶


**ğŸ“‹ åŒ¿åç”¨æˆ·æƒé™é…ç½®è¡¨**

| é…ç½®é¡¹ | ä½œç”¨ | æ¨èè®¾ç½® | è¯´æ˜ |
|--------|------|----------|------|
| `anon_upload_enable` | å…è®¸ä¸Šä¼  | `NO` | å¼€å¯éœ€è°¨æ… |
| `anon_mkdir_write_enable` | å…è®¸åˆ›å»ºç›®å½• | `NO` | å®‰å…¨è€ƒè™‘ |
| `anon_other_write_enable` | å…è®¸åˆ é™¤é‡å‘½å | `NO` | é«˜å±æƒé™ |
| `anon_world_readable_only` | åªè¯»å…¨å±€å¯è¯»æ–‡ä»¶ | `YES` | é™åˆ¶è®¿é—®èŒƒå›´ |

**å®‰å…¨çš„åŒ¿åç”¨æˆ·é…ç½®ç¤ºä¾‹**
```bash
# å¯ç”¨åŒ¿åç”¨æˆ·ä½†é™åˆ¶æƒé™
anonymous_enable=YES
anon_root=/var/ftp

# ç¦æ­¢åŒ¿åç”¨æˆ·å†™æ“ä½œ
anon_upload_enable=NO
anon_mkdir_write_enable=NO
anon_other_write_enable=NO

# é™åˆ¶åŒ¿åç”¨æˆ·åªèƒ½è¯»å–å…¨å±€å¯è¯»æ–‡ä»¶
anon_world_readable_only=YES

# åŒ¿åç”¨æˆ·æœ€å¤§ä¼ è¾“é€Ÿåº¦é™åˆ¶ï¼ˆå­—èŠ‚/ç§’ï¼‰
anon_max_rate=1048576  # 1MB/s
```

### 4.4 åŒ¿åä¸Šä¼ åŠŸèƒ½é…ç½®


å¦‚æœä¸šåŠ¡éœ€è¦å…è®¸åŒ¿åç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ï¼Œéœ€è¦ç‰¹æ®Šçš„å®‰å…¨é…ç½®ï¼š

**åˆ›å»ºåŒ¿åä¸Šä¼ ç›®å½•**
```bash
# åˆ›å»ºä¸“é—¨çš„ä¸Šä¼ ç›®å½•
sudo mkdir -p /var/ftp/upload

# è®¾ç½®ç‰¹æ®Šæƒé™ï¼šftpç”¨æˆ·å¯å†™ï¼Œä½†ä¸å¯è¯»å–å…¶ä»–ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶
sudo chown ftp:ftp /var/ftp/upload
sudo chmod 733 /var/ftp/upload
```

**å¯ç”¨åŒ¿åä¸Šä¼ é…ç½®**
```bash
# å…è®¸åŒ¿åç”¨æˆ·ä¸Šä¼ 
anon_upload_enable=YES

# ä¸Šä¼ æ–‡ä»¶çš„æ‰€æœ‰è€…
chown_uploads=YES
chown_username=ftpadmin

# ä¸Šä¼ æ–‡ä»¶æƒé™
anon_umask=022

# ç¦æ­¢åŒ¿åç”¨æˆ·ä¸‹è½½ä¸Šä¼ çš„æ–‡ä»¶
anon_world_readable_only=YES
```

---

## 5. ğŸ” PAMè®¤è¯æ¨¡å—é…ç½®


### 5.1 PAMè®¤è¯æœºåˆ¶è¯¦è§£


PAMï¼ˆPlugable Authentication Modulesï¼‰æ˜¯Linuxç³»ç»Ÿçš„å¯æ’æ‹”è®¤è¯æ¨¡å—ï¼Œä¸ºå„ç§åº”ç”¨ç¨‹åºæä¾›ç»Ÿä¸€çš„è®¤è¯æ¥å£ã€‚

**ğŸ”¸ PAMå·¥ä½œåŸç†**
```
åº”ç”¨ç¨‹åºï¼ˆå¦‚vsftpdï¼‰
        â†“
   è°ƒç”¨PAMæ¥å£
        â†“
PAMæ ¸å¿ƒåº“å¤„ç†è¯·æ±‚
        â†“
è°ƒç”¨ç›¸åº”çš„PAMæ¨¡å—
        â†“
è¿”å›è®¤è¯ç»“æœ
```

**ğŸ”¸ PAMæ¨¡å—ç±»å‹**
```
authï¼š    éªŒè¯ç”¨æˆ·èº«ä»½
accountï¼š æ£€æŸ¥è´¦æˆ·çŠ¶æ€ï¼ˆæ˜¯å¦è¿‡æœŸã€æ˜¯å¦è¢«é”å®šï¼‰
sessionï¼š ç®¡ç†ç”¨æˆ·ä¼šè¯
passwordï¼šå¯†ç ç®¡ç†
```

### 5.2 FTPæœåŠ¡çš„PAMé…ç½®


**æŸ¥çœ‹é»˜è®¤PAMé…ç½®**
```bash
# æŸ¥çœ‹vsftpdçš„PAMé…ç½®æ–‡ä»¶
cat /etc/pam.d/vsftpd
```

**æ ‡å‡†vsftpd PAMé…ç½®è§£æ**
```bash
# /etc/pam.d/vsftpd å†…å®¹ç¤ºä¾‹

# èº«ä»½è®¤è¯æ¨¡å—
auth       required     pam_shells.so
auth       required     pam_listfile.so item=user sense=deny file=/etc/ftpusers onerr=succeed

# è´¦æˆ·éªŒè¯æ¨¡å—  
account    required     pam_unix.so

# ä¼šè¯ç®¡ç†æ¨¡å—
session    required     pam_loginuid.so
```

> ğŸ“š **é…ç½®è§£é‡Š**
> 
> - `pam_shells.so`ï¼šæ£€æŸ¥ç”¨æˆ·shellæ˜¯å¦åœ¨/etc/shellsä¸­
> - `pam_listfile.so`ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨é»‘åå•ä¸­
> - `pam_unix.so`ï¼šä½¿ç”¨ç³»ç»Ÿæ ‡å‡†è®¤è¯æ–¹å¼

### 5.3 è‡ªå®šä¹‰PAMè®¤è¯é…ç½®


**åˆ›å»ºè‡ªå®šä¹‰PAMé…ç½®**
```bash
# å¤‡ä»½åŸé…ç½®
sudo cp /etc/pam.d/vsftpd /etc/pam.d/vsftpd.backup

# åˆ›å»ºæ–°çš„PAMé…ç½®
sudo vim /etc/pam.d/vsftpd.custom
```

**å¢å¼ºå®‰å…¨çš„PAMé…ç½®ç¤ºä¾‹**
```bash
# è‡ªå®šä¹‰vsftpd PAMé…ç½®

# é™åˆ¶ç™»å½•å°è¯•æ¬¡æ•°
auth       required     pam_faillock.so preauth audit deny=3 unlock_time=300

# æ£€æŸ¥ç”¨æˆ·shell
auth       required     pam_shells.so

# æ£€æŸ¥ç”¨æˆ·é»‘åå•
auth       required     pam_listfile.so item=user sense=deny file=/etc/ftpusers

# ç³»ç»Ÿè®¤è¯
auth       required     pam_unix.so

# è®°å½•ç™»å½•å¤±è´¥
auth       required     pam_faillock.so authfail audit

# è´¦æˆ·æ£€æŸ¥
account    required     pam_faillock.so
account    required     pam_unix.so
account    required     pam_time.so

# ä¼šè¯ç®¡ç†
session    required     pam_loginuid.so
session    required     pam_limits.so
```

**åœ¨vsftpdä¸­ä½¿ç”¨è‡ªå®šä¹‰PAMé…ç½®**
```bash
# åœ¨vsftpd.confä¸­æŒ‡å®šPAMæœåŠ¡å
pam_service_name=vsftpd.custom
```

### 5.4 PAMæ¨¡å—å‚æ•°è¯¦è§£


**ğŸ” å¸¸ç”¨PAMæ¨¡å—å‚æ•°**

| æ¨¡å— | å‚æ•° | ä½œç”¨ |
|------|------|------|
| `pam_faillock.so` | `deny=3` | è¿ç»­å¤±è´¥3æ¬¡åé”å®š |
| `pam_faillock.so` | `unlock_time=300` | é”å®š5åˆ†é’Ÿåè§£é” |
| `pam_listfile.so` | `sense=deny` | é»‘åå•æ¨¡å¼ |
| `pam_time.so` | æ—  | åŸºäºæ—¶é—´çš„è®¿é—®æ§åˆ¶ |

---

## 6. ğŸ›ï¸ ç”¨æˆ·ç™»å½•æƒé™æ§åˆ¶


### 6.1 ç™»å½•æƒé™æ§åˆ¶æ¦‚è¿°


ç”¨æˆ·ç™»å½•æƒé™æ§åˆ¶æ˜¯FTPå®‰å…¨çš„é‡è¦ç¯èŠ‚ï¼Œé€šè¿‡å¤šç§æœºåˆ¶ç¡®ä¿åªæœ‰åˆæ³•ç”¨æˆ·èƒ½å¤Ÿè®¿é—®FTPæœåŠ¡ã€‚

**ğŸ”¸ æƒé™æ§åˆ¶å±‚æ¬¡**
```
ç¬¬ä¸€å±‚ï¼šç³»ç»Ÿçº§ç”¨æˆ·é»‘åå•ï¼ˆ/etc/ftpusersï¼‰
ç¬¬äºŒå±‚ï¼švsftpdç”¨æˆ·åˆ—è¡¨æ§åˆ¶ï¼ˆuser_listï¼‰
ç¬¬ä¸‰å±‚ï¼šPAMè®¤è¯æ¨¡å—è¿‡æ»¤
ç¬¬å››å±‚ï¼šIPåœ°å€è®¿é—®æ§åˆ¶
ç¬¬äº”å±‚ï¼šæ—¶é—´åŸºè®¿é—®æ§åˆ¶
```

### 6.2 åŸºäºæ—¶é—´çš„è®¿é—®æ§åˆ¶


**é…ç½®æ—¶é—´è®¿é—®é™åˆ¶**
```bash
# åˆ›å»ºæ—¶é—´è®¿é—®æ§åˆ¶é…ç½®
sudo vim /etc/security/time.conf

# æ·»åŠ FTPæ—¶é—´é™åˆ¶è§„åˆ™
# åªå…è®¸å·¥ä½œæ—¶é—´è®¿é—®FTP
vsftpd;*;*;MoTuWeThFr0800-1800

# ç¦æ­¢å‘¨æœ«è®¿é—®
vsftpd;*;*;!SaSu
```

**åœ¨PAMä¸­å¯ç”¨æ—¶é—´æ§åˆ¶**
```bash
# åœ¨/etc/pam.d/vsftpdä¸­æ·»åŠ 
account    required     pam_time.so
```

### 6.3 åŸºäºIPåœ°å€çš„è®¿é—®æ§åˆ¶


**TCP Wrapperè®¿é—®æ§åˆ¶**
```bash
# é…ç½®å…è®¸è®¿é—®çš„IP
sudo vim /etc/hosts.allow
vsftpd: 192.168.1.0/24
vsftpd: 10.0.0.100

# é…ç½®æ‹’ç»è®¿é—®çš„IP  
sudo vim /etc/hosts.deny
vsftpd: ALL EXCEPT 192.168.1.0/24
```

**vsftpdå†…ç½®IPæ§åˆ¶**
```bash
# vsftpd.conf IPè®¿é—®æ§åˆ¶
tcp_wrappers=YES

# æˆ–è€…ä½¿ç”¨å†…ç½®çš„IPè¿‡æ»¤
deny_file={*.mp3,*.avi,*.exe}
hide_file={.*}
```

### 6.4 è¿æ¥æ•°é‡ä¸é€Ÿåº¦é™åˆ¶


**è¿æ¥æ•°é‡æ§åˆ¶**
```bash
# æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°
max_clients=50

# æ¯ä¸ªIPçš„æœ€å¤§è¿æ¥æ•°
max_per_ip=3

# æœ¬åœ°ç”¨æˆ·æœ€å¤§è¿æ¥æ•°
max_login_fails=3
```

**ä¼ è¾“é€Ÿåº¦é™åˆ¶**
```bash
# æœ¬åœ°ç”¨æˆ·é€Ÿåº¦é™åˆ¶ï¼ˆå­—èŠ‚/ç§’ï¼‰
local_max_rate=1048576  # 1MB/s

# åŒ¿åç”¨æˆ·é€Ÿåº¦é™åˆ¶
anon_max_rate=524288    # 512KB/s
```

**è¿æ¥è¶…æ—¶æ§åˆ¶**
```bash
# ç©ºé—²è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
idle_session_timeout=300

# æ•°æ®è¿æ¥è¶…æ—¶
data_connection_timeout=120

# æ¥å—è¿æ¥è¶…æ—¶
accept_timeout=60
```

---

## 7. ğŸ“ ç”¨æˆ·é»‘åå•ä¸ç™½åå•ç®¡ç†


### 7.1 /etc/ftpusersé»‘åå•é…ç½®


`/etc/ftpusers`æ–‡ä»¶æ˜¯ç³»ç»Ÿçº§çš„FTPé»‘åå•ï¼Œåˆ—å‡ºçš„ç”¨æˆ·å°†è¢«ç¦æ­¢é€šè¿‡FTPç™»å½•ã€‚

**ğŸ”¸ ftpusersæ–‡ä»¶çš„ä½œç”¨æœºåˆ¶**
```
ç”¨æˆ·å°è¯•FTPç™»å½•
        â†“
PAMæ£€æŸ¥/etc/ftpusersæ–‡ä»¶
        â†“
å¦‚æœç”¨æˆ·åœ¨åˆ—è¡¨ä¸­ â†’ æ‹’ç»ç™»å½•
å¦‚æœç”¨æˆ·ä¸åœ¨åˆ—è¡¨ä¸­ â†’ ç»§ç»­è®¤è¯æµç¨‹
```

**æŸ¥çœ‹é»˜è®¤é»‘åå•ç”¨æˆ·**
```bash
cat /etc/ftpusers
```

**å…¸å‹çš„ftpuserså†…å®¹**
```bash
# ç³»ç»Ÿç®¡ç†å‘˜è´¦æˆ·
root
bin
daemon
adm
lp
sync
shutdown
halt
mail
news
uucp
operator
games
nobody

# æœåŠ¡è´¦æˆ·
apache
nginx
mysql
postgres
```

**è‡ªå®šä¹‰é»‘åå•ç®¡ç†**
```bash
# æ·»åŠ ç”¨æˆ·åˆ°é»‘åå•
echo "testuser" | sudo tee -a /etc/ftpusers

# ä¸´æ—¶ç¦ç”¨æŸä¸ªç”¨æˆ·FTPè®¿é—®
echo "temporaryuser" | sudo tee -a /etc/ftpusers

# ä»é»‘åå•ç§»é™¤ç”¨æˆ·ï¼ˆç¼–è¾‘æ–‡ä»¶åˆ é™¤å¯¹åº”è¡Œï¼‰
sudo vim /etc/ftpusers
```

> âš ï¸ **é‡è¦æé†’**
> 
> rootç”¨æˆ·é»˜è®¤åœ¨é»‘åå•ä¸­ï¼Œè¿™æ˜¯é‡è¦çš„å®‰å…¨æªæ–½ï¼Œä¸å»ºè®®ç§»é™¤

### 7.2 user_listç”¨æˆ·åˆ—è¡¨ç®¡ç†


vsftpdçš„`user_list`åŠŸèƒ½æä¾›äº†æ›´çµæ´»çš„ç”¨æˆ·è®¿é—®æ§åˆ¶ï¼Œæ—¢å¯ä»¥ä½œä¸ºé»‘åå•ä¹Ÿå¯ä»¥ä½œä¸ºç™½åå•ä½¿ç”¨ã€‚

**user_listé…ç½®å‚æ•°**
```bash
# å¯ç”¨user_liståŠŸèƒ½
userlist_enable=YES

# è®¾ç½®ä¸ºç™½åå•æ¨¡å¼ï¼ˆYES=é»‘åå•ï¼ŒNO=ç™½åå•ï¼‰
userlist_deny=NO

# æŒ‡å®šuser_listæ–‡ä»¶ä½ç½®
userlist_file=/etc/vsftpd/user_list
```

**ğŸ”¸ ä¸¤ç§å·¥ä½œæ¨¡å¼å¯¹æ¯”**

| æ¨¡å¼ | userlist_denyè®¾ç½® | å·¥ä½œåŸç† | é€‚ç”¨åœºæ™¯ |
|------|-------------------|----------|----------|
| **é»‘åå•æ¨¡å¼** | `YES` | åˆ—è¡¨ä¸­ç”¨æˆ·è¢«æ‹’ç» | ç¦æ­¢ç‰¹å®šç”¨æˆ·è®¿é—® |
| **ç™½åå•æ¨¡å¼** | `NO` | åªæœ‰åˆ—è¡¨ä¸­ç”¨æˆ·å¯ä»¥è®¿é—® | åªå…è®¸ç‰¹å®šç”¨æˆ·è®¿é—® |

### 7.3 åˆ›å»ºå’Œç®¡ç†user_listæ–‡ä»¶


**åˆ›å»ºç™½åå•é…ç½®**
```bash
# åˆ›å»ºuser_listæ–‡ä»¶
sudo vim /etc/vsftpd/user_list

# ç™½åå•ç”¨æˆ·åˆ—è¡¨
ftpuser1
ftpuser2
webuser
backupuser
```

**åˆ›å»ºé»‘åå•é…ç½®**
```bash
# é»‘åå•ç”¨æˆ·åˆ—è¡¨ï¼ˆuserlist_deny=YESæ—¶ï¼‰
testuser
guestuser
tempuser
```

**åŠ¨æ€ç®¡ç†ç”¨æˆ·åˆ—è¡¨**
```bash
# æ·»åŠ ç”¨æˆ·åˆ°ç™½åå•
echo "newuser" | sudo tee -a /etc/vsftpd/user_list

# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨åˆ—è¡¨ä¸­
grep "username" /etc/vsftpd/user_list

# ä»åˆ—è¡¨ä¸­ç§»é™¤ç”¨æˆ·
sudo sed -i '/username/d' /etc/vsftpd/user_list
```

### 7.4 ç”¨æˆ·åˆ—è¡¨ç®¡ç†è„šæœ¬


**è‡ªåŠ¨åŒ–ç”¨æˆ·ç®¡ç†è„šæœ¬**
```bash
#!/bin/bash
# FTPç”¨æˆ·ç®¡ç†è„šæœ¬

USER_LIST="/etc/vsftpd/user_list"
BACKUP_DIR="/etc/vsftpd/backup"

case "$1" in
    add)
        if [ -z "$2" ]; then
            echo "ç”¨æ³•: $0 add <ç”¨æˆ·å>"
            exit 1
        fi
        
        # å¤‡ä»½å½“å‰åˆ—è¡¨
        cp $USER_LIST $BACKUP_DIR/user_list.$(date +%Y%m%d_%H%M%S)
        
        # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
        if grep -q "^$2$" $USER_LIST; then
            echo "ç”¨æˆ· $2 å·²å­˜åœ¨äºåˆ—è¡¨ä¸­"
        else
            echo "$2" >> $USER_LIST
            echo "ç”¨æˆ· $2 å·²æ·»åŠ åˆ°åˆ—è¡¨"
        fi
        ;;
        
    remove)
        if [ -z "$2" ]; then
            echo "ç”¨æ³•: $0 remove <ç”¨æˆ·å>"
            exit 1
        fi
        
        # å¤‡ä»½å½“å‰åˆ—è¡¨
        cp $USER_LIST $BACKUP_DIR/user_list.$(date +%Y%m%d_%H%M%S)
        
        # ç§»é™¤ç”¨æˆ·
        sed -i "/^$2$/d" $USER_LIST
        echo "ç”¨æˆ· $2 å·²ä»åˆ—è¡¨ä¸­ç§»é™¤"
        ;;
        
    list)
        echo "å½“å‰ç”¨æˆ·åˆ—è¡¨ï¼š"
        cat $USER_LIST
        ;;
        
    *)
        echo "ç”¨æ³•: $0 {add|remove|list} [ç”¨æˆ·å]"
        exit 1
        ;;
esac
```

---

## 8. ğŸ”’ ç”¨æˆ·chrootç›‘ç‹±è®¾ç½®


### 8.1 chrootç›‘ç‹±æ¦‚å¿µè¯¦è§£


chrootï¼ˆchange rootï¼‰ç›‘ç‹±æ˜¯ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œå°†ç”¨æˆ·é™åˆ¶åœ¨æŒ‡å®šçš„ç›®å½•æ ‘ä¸­ï¼Œç”¨æˆ·æ— æ³•è®¿é—®è¯¥ç›®å½•ä¹‹å¤–çš„æ–‡ä»¶ç³»ç»Ÿã€‚

**ğŸ”¸ chrootçš„å·¥ä½œåŸç†**
```
æ­£å¸¸æ–‡ä»¶ç³»ç»Ÿè§†å›¾:
/
â”œâ”€â”€ bin/
â”œâ”€â”€ etc/
â”œâ”€â”€ home/
â”‚   â””â”€â”€ ftpuser/
â”œâ”€â”€ usr/
â””â”€â”€ var/

chrootåçš„ç”¨æˆ·è§†å›¾:
/ (å®é™…æ˜¯ /home/ftpuser/)
â”œâ”€â”€ upload/
â”œâ”€â”€ download/
â””â”€â”€ public/
```

**ğŸ”¸ chrootçš„å®‰å…¨ä¼˜åŠ¿**
```
âœ… é˜²æ­¢ç›®å½•éå†æ”»å‡»
âœ… é™åˆ¶ç”¨æˆ·è®¿é—®ç³»ç»Ÿæ•æ„Ÿæ–‡ä»¶
âœ… éš”ç¦»ä¸åŒç”¨æˆ·çš„æ–‡ä»¶ç©ºé—´  
âœ… å‡å°‘ç³»ç»Ÿæš´éœ²é¢
```

### 8.2 å…¨å±€chrooté…ç½®


**å¯ç”¨å…¨å±€chrooté™åˆ¶**
```bash
# vsftpd.conf å…¨å±€chrooté…ç½®
chroot_local_user=YES

# chrootç›®å½•æƒé™è¦æ±‚ï¼ˆç›®å½•ä¸èƒ½æœ‰å†™æƒé™ï¼‰
allow_writeable_chroot=YES
```

> âš ï¸ **é‡è¦å®‰å…¨æ³¨æ„**
> 
> `allow_writeable_chroot=YES`é™ä½äº†å®‰å…¨æ€§ï¼Œå»ºè®®é€šè¿‡æ­£ç¡®çš„ç›®å½•æƒé™é…ç½®é¿å…ä½¿ç”¨

### 8.3 é€‰æ‹©æ€§chrooté…ç½®


**åŸºäºç”¨æˆ·åˆ—è¡¨çš„chrootæ§åˆ¶**
```bash
# åªå¯¹åˆ—è¡¨ä¸­çš„ç”¨æˆ·å¯ç”¨chroot
chroot_local_user=NO
chroot_list_enable=YES
chroot_list_file=/etc/vsftpd/chroot_list

# åˆ›å»ºchrootç”¨æˆ·åˆ—è¡¨
sudo vim /etc/vsftpd/chroot_list

# æ·»åŠ éœ€è¦chrootçš„ç”¨æˆ·
ftpuser1
ftpuser2
webuser
```

**åå‘chrooté…ç½®**
```bash
# å¯¹æ‰€æœ‰ç”¨æˆ·å¯ç”¨chrootï¼Œä½†æ’é™¤åˆ—è¡¨ä¸­çš„ç”¨æˆ·
chroot_local_user=YES
chroot_list_enable=YES
chroot_list_file=/etc/vsftpd/chroot_exception_list

# åˆ›å»ºchrootä¾‹å¤–åˆ—è¡¨ï¼ˆè¿™äº›ç”¨æˆ·ä¸ä¼šè¢«chrootï¼‰
admin
backup
monitor
```

### 8.4 å®‰å…¨çš„chrootç›®å½•ç»“æ„


**åˆ›å»ºç¬¦åˆå®‰å…¨è¦æ±‚çš„ç›®å½•ç»“æ„**
```bash
# åˆ›å»ºç”¨æˆ·æ ¹ç›®å½•ï¼ˆä¸å¯å†™ï¼‰
sudo mkdir -p /home/ftpusers/user1
sudo chown root:root /home/ftpusers/user1
sudo chmod 755 /home/ftpusers/user1

# åˆ›å»ºç”¨æˆ·å¯å†™çš„å­ç›®å½•
sudo mkdir -p /home/ftpusers/user1/upload
sudo mkdir -p /home/ftpusers/user1/download
sudo chown user1:ftpgroup /home/ftpusers/user1/upload
sudo chown user1:ftpgroup /home/ftpusers/user1/download
sudo chmod 755 /home/ftpusers/user1/upload
sudo chmod 755 /home/ftpusers/user1/download
```

**ç›®å½•æƒé™éªŒè¯**
```bash
# æ£€æŸ¥chrootç›®å½•æƒé™
ls -la /home/ftpusers/user1

# åº”è¯¥æ˜¾ç¤ºç±»ä¼¼å¦‚ä¸‹æƒé™ï¼š
# drwxr-xr-x  4 root     root     4096 Jan 15 10:00 .
# drwxr-xr-x  3 root     root     4096 Jan 15 09:55 ..
# drwxr-xr-x  2 user1    ftpgroup 4096 Jan 15 10:00 upload
# drwxr-xr-x  2 user1    ftpgroup 4096 Jan 15 10:00 download
```

### 8.5 chrootæ•…éšœæ’é™¤


**å¸¸è§chrooté—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**

```bash
# é—®é¢˜1ï¼š500 OOPS: vsftpd: refusing to run with writable root inside chroot()
# è§£å†³æ–¹æ¡ˆï¼šè®¾ç½®chrootæ ¹ç›®å½•ä¸ºä¸å¯å†™
sudo chmod 755 /home/ftpuser
sudo chown root:root /home/ftpuser

# é—®é¢˜2ï¼šç”¨æˆ·æ— æ³•ä¸Šä¼ æ–‡ä»¶
# è§£å†³æ–¹æ¡ˆï¼šåœ¨chrootç›®å½•å†…åˆ›å»ºå¯å†™å­ç›®å½•
sudo mkdir /home/ftpuser/upload
sudo chown ftpuser:ftpgroup /home/ftpuser/upload

# é—®é¢˜3ï¼šæ— æ³•è¿›å…¥ç‰¹å®šç›®å½•
# è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥ç›®å½•æƒé™å’Œæ‰€æœ‰è€…
sudo chown -R ftpuser:ftpgroup /home/ftpuser/files
sudo chmod -R 755 /home/ftpuser/files
```

**chrootæµ‹è¯•è„šæœ¬**
```bash
#!/bin/bash
# chrooté…ç½®æµ‹è¯•è„šæœ¬

USER=$1
USER_HOME="/home/ftpusers/$USER"

if [ -z "$USER" ]; then
    echo "ç”¨æ³•: $0 <ç”¨æˆ·å>"
    exit 1
fi

echo "æ£€æŸ¥ç”¨æˆ· $USER çš„chrooté…ç½®..."

# æ£€æŸ¥æ ¹ç›®å½•æƒé™
echo "æ£€æŸ¥æ ¹ç›®å½•æƒé™:"
ls -ld $USER_HOME

# æ£€æŸ¥æ ¹ç›®å½•æ‰€æœ‰è€…
ROOT_OWNER=$(stat -c %U $USER_HOME)
if [ "$ROOT_OWNER" != "root" ]; then
    echo "âš ï¸  è­¦å‘Š: æ ¹ç›®å½•æ‰€æœ‰è€…åº”è¯¥æ˜¯rootï¼Œå½“å‰æ˜¯$ROOT_OWNER"
else
    echo "âœ… æ ¹ç›®å½•æ‰€æœ‰è€…æ­£ç¡®"
fi

# æ£€æŸ¥æ ¹ç›®å½•æƒé™
ROOT_PERM=$(stat -c %a $USER_HOME)
if [ "$ROOT_PERM" -gt "755" ]; then
    echo "âš ï¸  è­¦å‘Š: æ ¹ç›®å½•æƒé™è¿‡é«˜ï¼Œå½“å‰æ˜¯$ROOT_PERM"
else
    echo "âœ… æ ¹ç›®å½•æƒé™æ­£ç¡®"
fi

# æ£€æŸ¥å¯å†™å­ç›®å½•
if [ -d "$USER_HOME/upload" ]; then
    echo "âœ… å‘ç°ä¸Šä¼ ç›®å½•"
    ls -ld $USER_HOME/upload
else
    echo "âš ï¸  å»ºè®®åˆ›å»ºä¸Šä¼ ç›®å½•"
fi
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç”¨æˆ·ç±»å‹ï¼šæœ¬åœ°ç”¨æˆ·ã€è™šæ‹Ÿç”¨æˆ·ã€åŒ¿åç”¨æˆ·çš„ç‰¹ç‚¹å’Œåº”ç”¨åœºæ™¯
ğŸ”¸ è®¤è¯æœºåˆ¶ï¼šPAMè®¤è¯æ¨¡å—çš„å·¥ä½œåŸç†å’Œé…ç½®æ–¹æ³•  
ğŸ”¸ æƒé™æ§åˆ¶ï¼šå¤šå±‚æ¬¡çš„ç”¨æˆ·è®¿é—®æƒé™æ§åˆ¶ä½“ç³»
ğŸ”¸ å®‰å…¨æœºåˆ¶ï¼šchrootç›‘ç‹±ã€ç”¨æˆ·åˆ—è¡¨ã€æ—¶é—´æ§åˆ¶ç­‰å®‰å…¨æªæ–½
ğŸ”¸ é…ç½®ç®¡ç†ï¼šç”¨æˆ·é»‘ç™½åå•çš„åˆ›å»ºå’ŒåŠ¨æ€ç®¡ç†
```

### 9.2 å…³é”®é…ç½®å‚æ•°é€ŸæŸ¥


**ğŸ“Š ç”¨æˆ·ç®¡ç†æ ¸å¿ƒå‚æ•°å¯¹ç…§è¡¨**

| åŠŸèƒ½åˆ†ç±» | é…ç½®å‚æ•° | æ¨èå€¼ | ä½œç”¨è¯´æ˜ |
|---------|----------|--------|----------|
| **æœ¬åœ°ç”¨æˆ·** | `local_enable` | `YES` | å¯ç”¨æœ¬åœ°ç”¨æˆ·ç™»å½• |
| **è™šæ‹Ÿç”¨æˆ·** | `guest_enable` | `YES` | å¯ç”¨è™šæ‹Ÿç”¨æˆ·åŠŸèƒ½ |
| **åŒ¿åç”¨æˆ·** | `anonymous_enable` | `NO` | ä¸€èˆ¬ç¦ç”¨åŒ¿åè®¿é—® |
| **PAMè®¤è¯** | `pam_service_name` | `vsftpd` | PAMæœåŠ¡é…ç½®å |
| **ç”¨æˆ·åˆ—è¡¨** | `userlist_enable` | `YES` | å¯ç”¨ç”¨æˆ·åˆ—è¡¨æ§åˆ¶ |
| **chroot** | `chroot_local_user` | `YES` | å¯ç”¨chrootç›‘ç‹± |

### 9.3 å®‰å…¨æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•


**ğŸ›¡ï¸ FTPç”¨æˆ·å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•**

- â˜‘ï¸ **ç¦ç”¨rootç”¨æˆ·FTPè®¿é—®**
- â˜‘ï¸ **ä½¿ç”¨è™šæ‹Ÿç”¨æˆ·æ›¿ä»£æœ¬åœ°ç”¨æˆ·**
- â˜‘ï¸ **å¯ç”¨chrootç›‘ç‹±é™åˆ¶ç”¨æˆ·ç›®å½•**
- â˜‘ï¸ **é…ç½®ç”¨æˆ·é»‘åå•é˜²æ­¢ç‰¹æƒç”¨æˆ·è®¿é—®**
- â˜‘ï¸ **é™åˆ¶è¿æ¥æ•°å’Œä¼ è¾“é€Ÿåº¦**
- â˜‘ï¸ **é…ç½®PAMè®¤è¯å¢å¼ºå®‰å…¨æ€§**
- â˜‘ï¸ **å®šæœŸå®¡æŸ¥ç”¨æˆ·åˆ—è¡¨å’Œæƒé™**
- â˜‘ï¸ **ç›‘æ§FTPè®¿é—®æ—¥å¿—**

### 9.4 æ•…éšœæ’æŸ¥è¦ç‚¹


**ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­æµç¨‹**

```
ç”¨æˆ·æ— æ³•ç™»å½•FTP
        â†“
æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨é»‘åå•ä¸­(/etc/ftpusers)
        â†“
æ£€æŸ¥ç”¨æˆ·åˆ—è¡¨é…ç½®(user_list)
        â†“
éªŒè¯PAMè®¤è¯é…ç½®
        â†“
æ£€æŸ¥chrootç›®å½•æƒé™
        â†“
æŸ¥çœ‹vsftpdé”™è¯¯æ—¥å¿—
        â†“
æµ‹è¯•ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™
```

**ğŸ“ é…ç½®éªŒè¯å‘½ä»¤**
```bash
# æµ‹è¯•FTPè¿æ¥
ftp localhost

# æ£€æŸ¥vsftpdçŠ¶æ€
systemctl status vsftpd

# æŸ¥çœ‹é…ç½®æ–‡ä»¶
sudo vsftpd -olisten=NO /etc/vsftpd/vsftpd.conf

# æ£€æŸ¥ç«¯å£ç›‘å¬
ss -tlnp | grep :21

# æŸ¥çœ‹FTPæ—¥å¿—
sudo tail -f /var/log/vsftpd.log
```

### 9.5 å®é™…åº”ç”¨å»ºè®®


**ğŸ¯ ä¸åŒåœºæ™¯çš„ç”¨æˆ·ç®¡ç†ç­–ç•¥**

```
ä¼ä¸šå†…éƒ¨æ–‡ä»¶å…±äº«ï¼š
â€¢ ä½¿ç”¨æœ¬åœ°ç”¨æˆ· + chrootç›‘ç‹±
â€¢ å¯ç”¨ç”¨æˆ·åˆ—è¡¨ç™½åå•æ¨¡å¼
â€¢ é…ç½®æ—¶é—´å’ŒIPè®¿é—®é™åˆ¶

Webç«™ç‚¹æ–‡ä»¶ç®¡ç†ï¼š
â€¢ ä½¿ç”¨è™šæ‹Ÿç”¨æˆ·ç³»ç»Ÿ
â€¢ ä¸ºä¸åŒç«™ç‚¹åˆ›å»ºç‹¬ç«‹è™šæ‹Ÿç”¨æˆ·
â€¢ ä¸¥æ ¼çš„ç›®å½•æƒé™æ§åˆ¶

å…¬å…±æ–‡ä»¶åˆ†å‘ï¼š
â€¢ å¯ç”¨åŒ¿åç”¨æˆ·åªè¯»è®¿é—®
â€¢ ä¸¥æ ¼é™åˆ¶åŒ¿åç”¨æˆ·æƒé™
â€¢ é…ç½®ä¼ è¾“é€Ÿåº¦é™åˆ¶

å¼€å‘æµ‹è¯•ç¯å¢ƒï¼š
â€¢ ä½¿ç”¨æœ¬åœ°ç”¨æˆ·å¿«é€Ÿé…ç½®
â€¢ é€‚å½“æ”¾æ¾æƒé™ä¾¿äºå¼€å‘
â€¢ å®šæœŸæ¸…ç†æµ‹è¯•ç”¨æˆ·
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- FTPç”¨æˆ·ç®¡ç†çš„æ ¸å¿ƒæ˜¯å®‰å…¨æ€§ä¸å¯ç”¨æ€§çš„å¹³è¡¡
- è™šæ‹Ÿç”¨æˆ·æä¾›æœ€ä½³çš„å®‰å…¨éš”ç¦»æ•ˆæœ
- chrootç›‘ç‹±æ˜¯é˜²æ­¢ç›®å½•éå†çš„é‡è¦æœºåˆ¶
- å¤šå±‚æ¬¡æƒé™æ§åˆ¶ç¡®ä¿ç³»ç»Ÿå®‰å…¨
- å®šæœŸå®¡æŸ¥å’Œæ¸…ç†ç”¨æˆ·é…ç½®æ˜¯è‰¯å¥½çš„è¿ç»´ä¹ æƒ¯