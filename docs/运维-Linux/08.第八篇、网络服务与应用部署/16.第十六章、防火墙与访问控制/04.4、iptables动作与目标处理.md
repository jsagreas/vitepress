---
title: 4、iptables动作与目标处理
---
## 📚 目录

1. [iptables动作处理概述](#1-iptables动作处理概述)
2. [基础处理动作](#2-基础处理动作)
3. [地址转换动作](#3-地址转换动作)
4. [特殊处理动作](#4-特殊处理动作)
5. [动作参数详解](#5-动作参数详解)
6. [实际应用场景](#6-实际应用场景)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🎯 iptables动作处理概述


### 1.1 什么是iptables动作


**动作（Action）**就是告诉iptables遇到匹配的数据包后该怎么处理。

简单理解：
```
数据包 → 匹配规则 → 执行动作 → 处理结果

就像门卫检查来访者：
- 看到熟人 → ACCEPT（放行）
- 看到可疑人员 → DROP（拒绝，不告知原因）
- 看到推销员 → REJECT（拒绝并说明原因）
```

### 1.2 动作分类概览


| 动作类别 | **常用动作** | **主要用途** | **是否回复** |
|---------|------------|-------------|-------------|
| 🟢 **通行控制** | `ACCEPT` | 允许数据包通过 | 无需回复 |
| 🔴 **拒绝控制** | `DROP`, `REJECT` | 阻止数据包通过 | DROP不回复，REJECT回复 |
| 📝 **记录审计** | `LOG` | 记录数据包信息 | 继续处理 |
| 🔄 **地址转换** | `MASQUERADE`, `DNAT`, `SNAT` | 修改IP地址端口 | 透明处理 |
| 📍 **本地处理** | `REDIRECT` | 重定向到本机端口 | 内部转发 |

### 1.3 动作处理流程


```
数据包到达
     ↓
匹配规则条件
     ↓
[匹配成功] → 执行指定动作 → 停止处理
     ↓
[匹配失败] → 检查下一条规则
     ↓
[无匹配规则] → 执行默认策略
```

💡 **重要理解**：一旦数据包匹配某条规则并执行动作，通常就不会继续检查后续规则了（除了LOG等特殊动作）。

---

## 2. ✅ 基础处理动作


### 2.1 ACCEPT - 允许通过


**作用**：让数据包正常通过防火墙。

**使用场景**：
- 允许特定IP访问
- 放行某些端口的服务
- 建立白名单规则

**基本语法**：
```bash
-j ACCEPT
```

**实用示例**：
```bash
# 允许SSH连接（22端口）
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 允许内网访问
iptables -A INPUT -s 192.168.1.0/24 -j ACCEPT

# 允许已建立的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```

⭐ **理解要点**：ACCEPT就像给数据包开绿灯，让它畅通无阻地通过。

### 2.2 DROP - 静默丢弃


**作用**：直接丢弃数据包，不给发送方任何回复。

**特点**：
- 🔇 **静默处理** - 发送方不知道被拒绝
- ⚡ **节省资源** - 不消耗带宽回复
- 🛡️ **隐藏信息** - 不暴露服务器存在

**基本语法**：
```bash
-j DROP
```

**实用示例**：
```bash
# 丢弃来自恶意IP的数据包
iptables -A INPUT -s 192.168.100.100 -j DROP

# 丢弃所有ICMP ping请求
iptables -A INPUT -p icmp --icmp-type echo-request -j DROP

# 默认丢弃所有其他流量
iptables -P INPUT DROP
```

💡 **使用建议**：对付恶意攻击时使用DROP，让攻击者以为服务器不存在。

### 2.3 REJECT - 拒绝并回复


**作用**：拒绝数据包并向发送方发送错误信息。

**与DROP的区别**：
```
DROP：   客户端 → [数据包] → 防火墙 → [丢弃] → 无回复
REJECT： 客户端 → [数据包] → 防火墙 → [拒绝] → 发送错误信息
```

**基本语法**：
```bash
-j REJECT [--reject-with 错误类型]
```

**回复类型选项**：
- `icmp-net-unreachable` - 网络不可达
- `icmp-host-unreachable` - 主机不可达  
- `icmp-port-unreachable` - 端口不可达（默认）
- `tcp-reset` - TCP连接重置

**实用示例**：
```bash
# 拒绝TCP连接并发送重置信号
iptables -A INPUT -p tcp --dport 23 -j REJECT --reject-with tcp-reset

# 拒绝UDP并回复端口不可达
iptables -A INPUT -p udp --dport 1234 -j REJECT --reject-with icmp-port-unreachable

# 简单拒绝（使用默认回复）
iptables -A INPUT -p tcp --dport 21 -j REJECT
```

🎯 **选择原则**：对正常用户使用REJECT（提供明确反馈），对可疑流量使用DROP。

---

## 3. 🔄 地址转换动作


### 3.1 MASQUERADE - 动态NAT


**作用**：自动将内网IP转换为出口网卡的IP地址。

**适用场景**：
- 🌐 **拨号上网** - IP地址经常变化
- 📱 **移动网络** - 动态获取公网IP
- 🏠 **家庭路由** - ADSL/光纤动态IP

**工作原理**：
```
内网客户端                路由器/网关                 外网服务器
192.168.1.100    →    [MASQUERADE处理]    →    看到的是公网IP
发送请求               自动替换源IP地址              （如：203.0.113.1）
```

**基本语法**：
```bash
-j MASQUERADE [--to-ports 端口范围]
```

**实用示例**：
```bash
# 基本的网络共享设置
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE

# 指定端口范围的MASQUERADE
iptables -t nat -A POSTROUTING -s 10.0.0.0/8 -o ppp0 -j MASQUERADE --to-ports 1024-65535

# 多网卡环境的处理
iptables -t nat -A POSTROUTING -s 192.168.0.0/16 ! -d 192.168.0.0/16 -j MASQUERADE
```

✨ **优势**：无需手动指定IP，适合动态IP环境。

### 3.2 SNAT - 源地址转换


**作用**：将数据包的源IP地址替换为指定的IP地址。

**与MASQUERADE区别**：
```
SNAT：      手动指定转换后的IP地址（适合固定IP）
MASQUERADE：自动使用出口网卡IP（适合动态IP）
```

**基本语法**：
```bash
-j SNAT --to-source IP地址[:端口范围]
```

**实用示例**：
```bash
# 将内网流量的源IP改为固定公网IP
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j SNAT --to-source 203.0.113.100

# 指定端口范围
iptables -t nat -A POSTROUTING -s 10.0.0.0/8 -j SNAT --to-source 203.0.113.100:1024-65535

# 多IP轮换
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j SNAT --to-source 203.0.113.100-203.0.113.110
```

🎯 **使用场景**：服务器有固定公网IP时使用SNAT，性能比MASQUERADE更好。

### 3.3 DNAT - 目标地址转换


**作用**：将数据包的目标IP地址和端口转换为内网服务器地址。

**典型应用**：
- 🌐 **端口映射** - 将公网端口映射到内网服务
- ⚖️ **负载均衡** - 分发请求到多台服务器
- 🔒 **服务隐藏** - 隐藏真实服务器位置

**工作原理**：
```
外网客户端                防火墙/路由器                内网服务器
访问公网IP:80    →    [DNAT处理转换]    →    实际访问192.168.1.10:8080
203.0.113.100:80      改写目标地址           Web服务器响应
```

**基本语法**：
```bash
-j DNAT --to-destination IP地址[:端口]
```

**实用示例**：
```bash
# Web服务端口映射
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.10:8080

# SSH端口映射到内网服务器
iptables -t nat -A PREROUTING -p tcp --dport 2222 -j DNAT --to-destination 192.168.1.20:22

# 负载均衡到多台服务器
iptables -t nat -A PREROUTING -p tcp --dport 80 -m statistic --mode nth --every 3 --packet 0 -j DNAT --to-destination 192.168.1.10
iptables -t nat -A PREROUTING -p tcp --dport 80 -m statistic --mode nth --every 2 --packet 0 -j DNAT --to-destination 192.168.1.11
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.12
```

📋 **配置要点**：使用DNAT时通常需要同时配置SNAT确保回程数据包正确路由。

---

## 4. 📝 特殊处理动作


### 4.1 LOG - 记录日志


**作用**：记录匹配的数据包信息到系统日志，然后继续检查后续规则。

**重要特点**：
- 📝 **不终止处理** - 记录后继续匹配其他规则
- 🔍 **调试利器** - 了解网络流量状况
- 📊 **安全审计** - 记录攻击和异常行为

**基本语法**：
```bash
-j LOG [--log-prefix "前缀"] [--log-level 级别]
```

**日志级别**：
- `0` - emergency（紧急）
- `1` - alert（警报）  
- `2` - critical（严重）
- `3` - error（错误）
- `4` - warning（警告，默认）
- `5` - notice（注意）
- `6` - info（信息）
- `7` - debug（调试）

**实用示例**：
```bash
# 记录被丢弃的数据包
iptables -A INPUT -j LOG --log-prefix "INPUT_DROP: " --log-level 4
iptables -A INPUT -j DROP

# 记录SSH登录尝试
iptables -A INPUT -p tcp --dport 22 -j LOG --log-prefix "SSH_ATTEMPT: "

# 记录端口扫描行为
iptables -A INPUT -p tcp --tcp-flags ALL FIN,URG,PSH -j LOG --log-prefix "PORT_SCAN: "
```

**日志查看**：
```bash
# 查看iptables日志
tail -f /var/log/messages | grep "INPUT_DROP"

# 或者查看内核日志
dmesg | grep "SSH_ATTEMPT"
```

⚠️ **使用注意**：频繁的LOG会产生大量日志，可能影响系统性能。

### 4.2 REDIRECT - 本地重定向


**作用**：将数据包重定向到本机的其他端口。

**典型应用**：
- 🔄 **透明代理** - 将HTTP流量重定向到代理端口
- 🛡️ **端口伪装** - 将标准端口重定向到非标准端口
- 🔧 **流量分析** - 将流量导向分析工具

**工作原理**：
```
客户端请求                本机处理
访问本机:80    →    重定向到本机:8080
数据包目标端口被修改      实际由8080端口的服务处理
```

**基本语法**：
```bash
-j REDIRECT --to-ports 端口号
```

**实用示例**：
```bash
# HTTP流量重定向到透明代理
iptables -t nat -A OUTPUT -p tcp --dport 80 -j REDIRECT --to-ports 8080

# 将特权端口重定向到非特权端口
iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8000

# 重定向DNS查询到本地DNS服务
iptables -t nat -A PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 5353
```

🔧 **配置提示**：REDIRECT只能在nat表的OUTPUT和PREROUTING链中使用。

---

## 5. ⚙️ 动作参数详解


### 5.1 端口范围参数


多个动作都支持端口范围设置：

```bash
# 单个端口
--to-ports 8080

# 端口范围  
--to-ports 1024-65535

# 多个端口（部分动作支持）
--to-destination 192.168.1.10:80,192.168.1.11:8080
```

### 5.2 概率和统计参数


配合`-m statistic`模块实现负载均衡：

```bash
# 每3个数据包中的第1个
-m statistic --mode nth --every 3 --packet 0

# 随机50%概率
-m statistic --mode random --probability 0.5
```

### 5.3 时间和计数限制


配合`-m limit`控制日志频率：

```bash
# 限制LOG频率（每分钟最多5条）
-m limit --limit 5/min --limit-burst 10 -j LOG
```

---

## 6. 🚀 实际应用场景


### 6.1 家庭网络共享


```bash
# 开启IP转发
echo 1 > /proc/sys/net/ipv4/ip_forward

# 内网访问外网（动态IP环境）
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE

# 允许已建立连接的回程流量
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

# 允许内网访问外网
iptables -A FORWARD -s 192.168.1.0/24 -j ACCEPT
```

### 6.2 Web服务器端口映射


```bash
# 将外网80端口映射到内网服务器的8080端口
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:8080

# 确保回程流量正确（如果需要）
iptables -t nat -A POSTROUTING -d 192.168.1.100 -p tcp --dport 8080 -j MASQUERADE
```

### 6.3 SSH防护配置


```bash
# 记录SSH登录尝试
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -j LOG --log-prefix "SSH_NEW: "

# 限制SSH连接频率
iptables -A INPUT -p tcp --dport 22 -m recent --update --seconds 60 --hitcount 4 -j REJECT

# 允许正常SSH连接
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --set -j ACCEPT
```

### 6.4 透明代理设置


```bash
# HTTP流量重定向到代理软件
iptables -t nat -A OUTPUT -p tcp --dport 80 -j REDIRECT --to-ports 8080

# HTTPS流量处理
iptables -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to-ports 8080
```

---

## 7. 📋 核心要点总结


### 7.1 动作选择指南


| 场景 | **推荐动作** | **原因说明** |
|------|-------------|-------------|
| 🟢 **正常服务访问** | `ACCEPT` | 让合法流量通过 |
| 🔴 **恶意攻击防护** | `DROP` | 不暴露服务器信息 |
| ⚠️ **用户错误访问** | `REJECT` | 提供明确错误信息 |
| 🔍 **安全审计需要** | `LOG + 其他动作` | 记录后继续处理 |
| 🌐 **内网共享上网** | `MASQUERADE` | 动态IP环境首选 |
| 📍 **服务端口映射** | `DNAT` | 将外网请求转发到内网 |

### 7.2 关键理解要点


**🔹 动作的终止性**：
```
终止性动作：ACCEPT、DROP、REJECT - 处理后停止检查后续规则
非终止性动作：LOG - 记录后继续检查其他规则
转换性动作：SNAT、DNAT、MASQUERADE - 修改数据包后继续处理
```

**🔹 NAT动作的表和链限制**：
```
SNAT/MASQUERADE：只能在nat表的POSTROUTING链使用
DNAT：只能在nat表的PREROUTING和OUTPUT链使用  
REDIRECT：只能在nat表的OUTPUT和PREROUTING链使用
```

**🔹 日志记录的合理使用**：
```
调试阶段：可以大量使用LOG了解流量情况
生产环境：只记录关键安全事件，避免日志过多
性能考虑：使用limit模块控制日志频率
```

### 7.3 实用配置模式


**🎯 标准防火墙模式**：
```bash
# 1. 默认拒绝策略
iptables -P INPUT DROP
iptables -P FORWARD DROP  
iptables -P OUTPUT ACCEPT

# 2. 允许基础服务
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 3. 记录异常流量
iptables -A INPUT -j LOG --log-prefix "INPUT_DROP: " --log-level 4

# 4. 执行默认策略（DROP）
```

**🌐 路由器NAT模式**：
```bash
# 1. 开启转发
echo 1 > /proc/sys/net/ipv4/ip_forward

# 2. 内网上网
iptables -t nat -A POSTROUTING -s 192.168.0.0/16 -o eth0 -j MASQUERADE

# 3. 允许转发
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -s 192.168.0.0/16 -j ACCEPT
```

**核心记忆**：
- **ACCEPT**放行，**DROP**静默拒绝，**REJECT**明确拒绝
- **MASQUERADE**适合动态IP，**SNAT**适合固定IP  
- **DNAT**做端口映射，**REDIRECT**做本地重定向
- **LOG**记录信息但不终止，要配合limit控制频率
- NAT动作有表和链的限制，不能随意使用