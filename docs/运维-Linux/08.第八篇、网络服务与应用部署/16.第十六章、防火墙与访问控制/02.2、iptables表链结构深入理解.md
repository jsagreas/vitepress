---
title: 2ã€iptablesè¡¨é“¾ç»“æž„æ·±å…¥ç†è§£
---
## ðŸ“š ç›®å½•

1. [iptablesæ ¸å¿ƒæž¶æž„æ¦‚è¿°](#1-iptablesæ ¸å¿ƒæž¶æž„æ¦‚è¿°)
2. [å››å¤§è¡¨è¯¦è§£](#2-å››å¤§è¡¨è¯¦è§£)
3. [äº”æ¡é“¾æ·±å…¥ç†è§£](#3-äº”æ¡é“¾æ·±å…¥ç†è§£)
4. [æ•°æ®åŒ…æµè½¬è·¯å¾„](#4-æ•°æ®åŒ…æµè½¬è·¯å¾„)
5. [è¡¨é“¾ä¼˜å…ˆçº§ä¸ŽåŒ¹é…æœºåˆ¶](#5-è¡¨é“¾ä¼˜å…ˆçº§ä¸ŽåŒ¹é…æœºåˆ¶)
6. [ç”¨æˆ·è‡ªå®šä¹‰é“¾](#6-ç”¨æˆ·è‡ªå®šä¹‰é“¾)
7. [é“¾ç­–ç•¥è®¾ç½®](#7-é“¾ç­–ç•¥è®¾ç½®)
8. [å®žæˆ˜åº”ç”¨ä¸Žæœ€ä½³å®žè·µ](#8-å®žæˆ˜åº”ç”¨ä¸Žæœ€ä½³å®žè·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸ—ï¸ iptablesæ ¸å¿ƒæž¶æž„æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯iptables


**ç®€å•ç†è§£**ï¼šiptableså°±åƒæ˜¯Linuxç³»ç»Ÿçš„"é—¨å«"ï¼Œè´Ÿè´£æ£€æŸ¥è¿›å‡ºç³»ç»Ÿçš„æ‰€æœ‰ç½‘ç»œæ•°æ®åŒ…ï¼Œå†³å®šå“ªäº›å¯ä»¥é€šè¿‡ï¼Œå“ªäº›è¦æ‹¦æˆªã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
```
iptables = è¡¨(Tables) + é“¾(Chains) + è§„åˆ™(Rules)

è¡¨ï¼šä¸åŒåŠŸèƒ½çš„è§„åˆ™é›†åˆï¼Œæ¯”å¦‚è¿‡æ»¤è¡¨ã€åœ°å€è½¬æ¢è¡¨
é“¾ï¼šæ•°æ®åŒ…ç»è¿‡çš„æ£€æŸ¥ç‚¹ï¼Œæ¯”å¦‚è¿›å…¥æ—¶æ£€æŸ¥ã€è½¬å‘æ—¶æ£€æŸ¥
è§„åˆ™ï¼šå…·ä½“çš„å¤„ç†æŒ‡ä»¤ï¼Œæ¯”å¦‚å…è®¸ã€æ‹’ç»ã€è½¬å‘
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è¡¨å’Œé“¾çš„æ¦‚å¿µ


**çŽ°å®žç±»æ¯”**ï¼š
```
æœºåœºå®‰æ£€ç³»ç»Ÿï¼š
- ä¸åŒç±»åž‹æ£€æŸ¥ï¼šè¡ŒæŽæ£€æŸ¥ã€èº«ä»½æ£€æŸ¥ã€å®‰å…¨æ£€æŸ¥
- ä¸åŒæ£€æŸ¥ç‚¹ï¼šè¿›å…¥å€™æœºåŽ…ã€ç™»æœºå£ã€æµ·å…³
- ä¸åŒå¤„ç†æ–¹å¼ï¼šæ”¾è¡Œã€æ‹¦æˆªã€è½¬ç§»

iptablesç³»ç»Ÿï¼š
- ä¸åŒåŠŸèƒ½è¡¨ï¼šfilterè¿‡æ»¤ã€natè½¬æ¢ã€mangleä¿®æ”¹
- ä¸åŒæ£€æŸ¥ç‚¹ï¼šINPUTè¿›å…¥ã€OUTPUTå‡ºåŽ»ã€FORWARDè½¬å‘
- ä¸åŒå¤„ç†åŠ¨ä½œï¼šACCEPTæŽ¥å—ã€DROPä¸¢å¼ƒã€REJECTæ‹’ç»
```

### 1.3 iptablesæ•´ä½“æž¶æž„å›¾


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    iptables æž¶æž„å›¾                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åº”ç”¨ç¨‹åº â† â†’ ç”¨æˆ·ç©ºé—´                                         â”‚
â”‚                â†•                                            â”‚
â”‚  iptableså‘½ä»¤ â† â†’ å†…æ ¸ç©ºé—´                                     â”‚
â”‚                â†•                                            â”‚
â”‚  netfilteræ¡†æž¶ â†’ é’©å­å‡½æ•° â†’ è¡¨å’Œé“¾ â†’ è§„åˆ™åŒ¹é…                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•°æ®åŒ…å¤„ç†æµç¨‹ï¼š
ç½‘ç»œæŽ¥å£ â†’ netfilteré’©å­ â†’ è¡¨é“¾æ£€æŸ¥ â†’ è§„åˆ™åŒ¹é… â†’ æ‰§è¡ŒåŠ¨ä½œ
```

---

## 2. ðŸ“Š å››å¤§è¡¨è¯¦è§£


### 2.1 filterè¡¨ - è¿‡æ»¤å®ˆæŠ¤è€…


**ä½œç”¨**: è¿™æ˜¯æœ€å¸¸ç”¨çš„è¡¨ï¼Œä¸“é—¨è´Ÿè´£**è¿‡æ»¤æ•°æ®åŒ…**ï¼Œå†³å®šæ˜¯å¦å…è®¸æ•°æ®åŒ…é€šè¿‡ã€‚

**åŒ…å«çš„é“¾**: 
- `INPUT` - å¤„ç†è¿›å…¥æœ¬æœºçš„æ•°æ®åŒ…
- `FORWARD` - å¤„ç†ç»è¿‡æœ¬æœºè½¬å‘çš„æ•°æ®åŒ…  
- `OUTPUT` - å¤„ç†ä»Žæœ¬æœºå‘å‡ºçš„æ•°æ®åŒ…

**å®žé™…åº”ç”¨åœºæ™¯**:
```
ðŸ”¸ é˜²æ­¢å¤–éƒ¨æ¶æ„è¿žæŽ¥ï¼šé˜»æ­¢å¯ç–‘IPè®¿é—®SSHç«¯å£
ðŸ”¸ æŽ§åˆ¶æœåŠ¡è®¿é—®ï¼šåªå…è®¸ç‰¹å®šIPè®¿é—®WebæœåŠ¡å™¨
ðŸ”¸ é™åˆ¶å‡ºç«™è¿žæŽ¥ï¼šç¦æ­¢å†…éƒ¨ä¸»æœºè®¿é—®æŸäº›å¤–éƒ¨ç½‘ç«™
```

**ç®€å•ç¤ºä¾‹**:
```bash
# åªå…è®¸22ç«¯å£(SSH)è¢«è®¿é—®
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# æ‹’ç»æ‰€æœ‰å…¶ä»–è¿›å…¥çš„è¿žæŽ¥
iptables -A INPUT -j DROP
```

### 2.2 natè¡¨ - åœ°å€è½¬æ¢ä¸“å®¶


**ä½œç”¨**: è´Ÿè´£**ç½‘ç»œåœ°å€è½¬æ¢**ï¼Œæ”¹å˜æ•°æ®åŒ…çš„æºIPæˆ–ç›®æ ‡IPåœ°å€ã€‚

**åŒ…å«çš„é“¾**:
- `PREROUTING` - æ•°æ®åŒ…åˆšåˆ°è¾¾æ—¶è¿›è¡Œç›®æ ‡åœ°å€è½¬æ¢(DNAT)
- `OUTPUT` - æœ¬æœºäº§ç”Ÿçš„æ•°æ®åŒ…çš„ç›®æ ‡åœ°å€è½¬æ¢
- `POSTROUTING` - æ•°æ®åŒ…å³å°†å‘å‡ºæ—¶è¿›è¡Œæºåœ°å€è½¬æ¢(SNAT)

**å…¸åž‹åº”ç”¨**:
```
ðŸ”¸ å®¶ç”¨è·¯ç”±å™¨ï¼šå°†å†…ç½‘IPè½¬æ¢ä¸ºå…¬ç½‘IPä¸Šç½‘
ðŸ”¸ ç«¯å£è½¬å‘ï¼šå°†å¤–éƒ¨è®¿é—®çš„80ç«¯å£è½¬å‘åˆ°å†…éƒ¨æœåŠ¡å™¨çš„8080ç«¯å£
ðŸ”¸ è´Ÿè½½å‡è¡¡ï¼šå°†è¯·æ±‚åˆ†å‘åˆ°å¤šä¸ªåŽç«¯æœåŠ¡å™¨
```

**å¸¸è§é…ç½®**:
```bash
# æºåœ°å€è½¬æ¢(SNAT) - å†…ç½‘ä¸Šç½‘
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# ç›®æ ‡åœ°å€è½¬æ¢(DNAT) - ç«¯å£è½¬å‘
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:8080
```

### 2.3 mangleè¡¨ - æ•°æ®åŒ…ä¿®æ”¹å¸ˆ


**ä½œç”¨**: ç”¨äºŽ**ä¿®æ”¹æ•°æ®åŒ…çš„å¤´éƒ¨ä¿¡æ¯**ï¼Œæ¯”å¦‚TOSå­—æ®µã€TTLå€¼ç­‰ï¼Œä¸»è¦ç”¨äºŽé«˜çº§è·¯ç”±å’Œæµé‡æŽ§åˆ¶ã€‚

**åŒ…å«çš„é“¾**: åŒ…å«æ‰€æœ‰5æ¡é“¾
- `PREROUTING`ã€`INPUT`ã€`FORWARD`ã€`OUTPUT`ã€`POSTROUTING`

**ä½¿ç”¨åœºæ™¯**:
```
ðŸ”¸ QoSæµé‡æŽ§åˆ¶ï¼šæ ‡è®°ä¸åŒç±»åž‹çš„æ•°æ®åŒ…ï¼Œå®žçŽ°å¸¦å®½åˆ†é…
ðŸ”¸ ä¿®æ”¹TTLå€¼ï¼šé˜²æ­¢æ•°æ®åŒ…è¢«è¿½è¸ªè·¯å¾„
ðŸ”¸ è®¾ç½®DSCPæ ‡è®°ï¼šå®žçŽ°æœåŠ¡è´¨é‡æŽ§åˆ¶
```

**å®žç”¨ç¤ºä¾‹**:
```bash
# æ ‡è®°HTTPæµé‡ï¼Œç”¨äºŽåŽç»­QoSæŽ§åˆ¶
iptables -t mangle -A FORWARD -p tcp --dport 80 -j MARK --set-mark 1
```

### 2.4 rawè¡¨ - è¿žæŽ¥è·Ÿè¸ªæŽ§åˆ¶è€…


**ä½œç”¨**: ä¸»è¦ç”¨äºŽ**æŽ§åˆ¶è¿žæŽ¥è·Ÿè¸ªåŠŸèƒ½**ï¼Œå¯ä»¥è®©æŸäº›æ•°æ®åŒ…è·³è¿‡è¿žæŽ¥è·Ÿè¸ªç³»ç»Ÿï¼Œæé«˜æ€§èƒ½ã€‚

**åŒ…å«çš„é“¾**:
- `PREROUTING` - è¿›å…¥ç³»ç»Ÿæ—¶çš„è¿žæŽ¥è·Ÿè¸ªæŽ§åˆ¶
- `OUTPUT` - è¾“å‡ºæ—¶çš„è¿žæŽ¥è·Ÿè¸ªæŽ§åˆ¶

**åº”ç”¨åœºæ™¯**:
```
ðŸ”¸ é«˜æ€§èƒ½æœåŠ¡å™¨ï¼šè·³è¿‡è¿žæŽ¥è·Ÿè¸ªï¼Œå‡å°‘CPUå¼€é”€
ðŸ”¸ DDoSé˜²æŠ¤ï¼šå¯¹æ”»å‡»æµé‡ä¸è¿›è¡Œè¿žæŽ¥è·Ÿè¸ª
```

### 2.5 å››è¡¨åŠŸèƒ½å¯¹æ¯”


| è¡¨å | **ä¸»è¦åŠŸèƒ½** | **å¸¸ç”¨ç¨‹åº¦** | **ä½¿ç”¨åœºæ™¯** |
|------|-------------|-------------|-------------|
| ðŸ›¡ï¸ **filter** | `æ•°æ®åŒ…è¿‡æ»¤` | ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ | `é˜²ç«å¢™è§„åˆ™ã€è®¿é—®æŽ§åˆ¶` |
| ðŸ”„ **nat** | `åœ°å€è½¬æ¢` | ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ | `è·¯ç”±å™¨ã€ç«¯å£è½¬å‘` |
| ðŸ”§ **mangle** | `åŒ…å¤´ä¿®æ”¹` | ðŸ”¥ðŸ”¥ | `QoSã€é«˜çº§è·¯ç”±` |
| âš¡ **raw** | `è¿žæŽ¥è·Ÿè¸ªæŽ§åˆ¶` | ðŸ”¥ | `é«˜æ€§èƒ½ä¼˜åŒ–` |

---

## 3. ðŸ”— äº”æ¡é“¾æ·±å…¥ç†è§£


### 3.1 æ•°æ®åŒ…çš„"äººç”Ÿæ—…ç¨‹"


**ç†è§£æ–¹å¼**: æŠŠæ•°æ®åŒ…æƒ³è±¡æˆä¸€ä¸ªäººè¦ç©¿è¿‡ä¸€ä¸ªåŸŽå¸‚ï¼Œäº”æ¡é“¾å°±æ˜¯è¿™ä¸ªåŸŽå¸‚çš„äº”ä¸ªæ£€æŸ¥ç«™ã€‚

```
æ•°æ®åŒ…çš„åŸŽå¸‚æ—…è¡Œè·¯çº¿ï¼š
å¤–ç•Œ â†’ [åŸŽé—¨-PREROUTING] â†’ è·¯ç”±å†³ç­– â†’ [å¸‚å†…-INPUT] â†’ æœ¬æœºåº”ç”¨
                              â†“
                         [ä¸­è½¬ç«™-FORWARD] â†’ [å‡ºåŸŽé—¨-POSTROUTING] â†’ å¤–ç•Œ
                              â†‘
                         æœ¬æœºåº”ç”¨ â†’ [å‡ºå‘ç‚¹-OUTPUT]
```

### 3.2 PREROUTINGé“¾ - å…¥åŸŽç¬¬ä¸€å…³


**ä½ç½®**: æ•°æ®åŒ…åˆšåˆšåˆ°è¾¾ç½‘ç»œæŽ¥å£ï¼Œè¿˜æ²¡æœ‰è¿›è¡Œè·¯ç”±å†³ç­–ä¹‹å‰ã€‚

**ä½œç”¨**: 
- ðŸ”¸ **ç›®æ ‡åœ°å€è½¬æ¢(DNAT)**: æ”¹å˜æ•°æ®åŒ…è¦åŽ»å“ªé‡Œ
- ðŸ”¸ **æµé‡æ ‡è®°**: ç»™æ•°æ®åŒ…æ‰“ä¸Šæ ‡ç­¾ï¼Œä¾¿äºŽåŽç»­å¤„ç†
- ðŸ”¸ **è¿žæŽ¥è·Ÿè¸ª**: è®°å½•è¿žæŽ¥çŠ¶æ€

**ç”Ÿæ´»ç±»æ¯”**: å°±åƒæœºåœºçš„ç¬¬ä¸€é“å®‰æ£€ï¼Œæ£€æŸ¥ä½ çš„ç›®çš„åœ°ï¼Œå¯èƒ½ä¼šå‘Šè¯‰ä½ "ä½ è¦åŽ»çš„åœ°æ–¹å˜äº†ï¼Œè¯·åˆ°æ–°åœ°å€"ã€‚

**å…¸åž‹åº”ç”¨**:
```bash
# ç«¯å£è½¬å‘ï¼šå¤–éƒ¨è®¿é—®80ç«¯å£è½¬å‘åˆ°å†…éƒ¨8080ç«¯å£
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:8080

# æ ‡è®°æ¥è‡ªç‰¹å®šç½‘æ®µçš„æ•°æ®åŒ…
iptables -t mangle -A PREROUTING -s 192.168.1.0/24 -j MARK --set-mark 100
```

### 3.3 INPUTé“¾ - æœ¬æœºé—¨å«


**ä½ç½®**: è·¯ç”±å†³ç­–åŽï¼Œç¡®å®šæ•°æ®åŒ…æ˜¯å‘ç»™æœ¬æœºçš„ï¼Œå‡†å¤‡äº¤ç»™æœ¬æœºåº”ç”¨ç¨‹åºä¹‹å‰ã€‚

**ä½œç”¨**:
- ðŸ”¸ **è®¿é—®æŽ§åˆ¶**: å†³å®šå“ªäº›å¤–éƒ¨è¿žæŽ¥å¯ä»¥è¿›å…¥æœ¬æœº
- ðŸ”¸ **æœåŠ¡ä¿æŠ¤**: ä¿æŠ¤æœ¬æœºè¿è¡Œçš„æœåŠ¡ä¸è¢«æ¶æ„è®¿é—®
- ðŸ”¸ **æµé‡è¿‡æ»¤**: è¿‡æ»¤æ¶æ„æµé‡å’Œæ”»å‡»

**ç”Ÿæ´»ç±»æ¯”**: å°±åƒä½ å®¶çš„é—¨å«ï¼Œæ£€æŸ¥æ¯ä¸€ä¸ªæƒ³è¿›å…¥ä½ å®¶çš„è®¿å®¢ã€‚

**å¸¸ç”¨é…ç½®**:
```bash
# å…è®¸å·²å»ºç«‹çš„è¿žæŽ¥ç»§ç»­
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# å…è®¸æœ¬åœ°çŽ¯å›žè¿žæŽ¥
iptables -A INPUT -i lo -j ACCEPT

# åªå…è®¸ç‰¹å®šIPè®¿é—®SSH
iptables -A INPUT -p tcp -s 192.168.1.100 --dport 22 -j ACCEPT

# æ‹’ç»å…¶ä»–æ‰€æœ‰INPUTæµé‡
iptables -A INPUT -j DROP
```

### 3.4 FORWARDé“¾ - äº¤é€šæŒ‡æŒ¥å‘˜


**ä½ç½®**: è·¯ç”±å†³ç­–åŽï¼Œç¡®å®šæ•°æ®åŒ…ä¸æ˜¯å‘ç»™æœ¬æœºçš„ï¼Œéœ€è¦è½¬å‘ç»™å…¶ä»–ä¸»æœºã€‚

**ä½œç”¨**:
- ðŸ”¸ **è½¬å‘æŽ§åˆ¶**: å†³å®šå“ªäº›æ•°æ®åŒ…å¯ä»¥é€šè¿‡æœ¬æœºè½¬å‘
- ðŸ”¸ **ç½‘å…³åŠŸèƒ½**: å®žçŽ°è·¯ç”±å™¨å’Œç½‘å…³çš„è½¬å‘åŠŸèƒ½
- ðŸ”¸ **å†…ç½‘éš”ç¦»**: æŽ§åˆ¶ä¸åŒç½‘æ®µä¹‹é—´çš„é€šä¿¡

**ç”Ÿæ´»ç±»æ¯”**: å°±åƒäº¤é€šè­¦å¯Ÿï¼Œå†³å®šå“ªäº›è½¦è¾†å¯ä»¥é€šè¿‡è¿™ä¸ªè·¯å£ï¼Œå“ªäº›ä¸è¡Œã€‚

**åº”ç”¨åœºæ™¯**:
```bash
# å…è®¸å†…ç½‘è®¿é—®å¤–ç½‘
iptables -A FORWARD -s 192.168.1.0/24 -o eth0 -j ACCEPT

# å…è®¸å¤–ç½‘å“åº”è¿”å›žå†…ç½‘
iptables -A FORWARD -i eth0 -o eth1 -m state --state ESTABLISHED,RELATED -j ACCEPT

# ç¦æ­¢ç‰¹å®šç½‘æ®µäº’ç›¸è®¿é—®
iptables -A FORWARD -s 192.168.1.0/24 -d 192.168.2.0/24 -j DROP
```

### 3.5 OUTPUTé“¾ - å‡ºé—¨æ£€æŸ¥


**ä½ç½®**: æœ¬æœºåº”ç”¨ç¨‹åºäº§ç”Ÿæ•°æ®åŒ…ï¼Œå‡†å¤‡å‘é€å‡ºåŽ»ä¹‹å‰ã€‚

**ä½œç”¨**:
- ðŸ”¸ **å‡ºç«™æŽ§åˆ¶**: æŽ§åˆ¶æœ¬æœºå¯ä»¥è®¿é—®å“ªäº›å¤–éƒ¨èµ„æº
- ðŸ”¸ **åº”ç”¨é™åˆ¶**: é™åˆ¶ç‰¹å®šåº”ç”¨ç¨‹åºçš„ç½‘ç»œè®¿é—®
- ðŸ”¸ **å®‰å…¨å®¡è®¡**: è®°å½•æœ¬æœºçš„å¯¹å¤–è¿žæŽ¥

**ç”Ÿæ´»ç±»æ¯”**: å°±åƒå…¬å¸çš„é—¨å«ï¼Œæ£€æŸ¥æ¯ä¸€ä¸ªè¦å‡ºé—¨çš„å‘˜å·¥å’Œä»–ä»¬è¦å¸¦èµ°çš„ä¸œè¥¿ã€‚

**å®žç”¨ç¤ºä¾‹**:
```bash
# ç¦æ­¢æœ¬æœºè®¿é—®æŸä¸ªæ¶æ„ç½‘ç«™
iptables -A OUTPUT -d 192.168.100.100 -j DROP

# åªå…è®¸rootç”¨æˆ·è¿›è¡ŒSSHè¿žæŽ¥
iptables -A OUTPUT -p tcp --dport 22 -m owner --uid-owner 0 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 22 -j DROP
```

### 3.6 POSTROUTINGé“¾ - å‡ºåŸŽæœ€åŽä¸€å…³


**ä½ç½®**: æ•°æ®åŒ…å·²ç»å®Œæˆè·¯ç”±å†³ç­–ï¼Œå‡†å¤‡ä»Žç½‘ç»œæŽ¥å£å‘å‡ºä¹‹å‰çš„æœ€åŽæ£€æŸ¥ã€‚

**ä½œç”¨**:
- ðŸ”¸ **æºåœ°å€è½¬æ¢(SNAT)**: æ”¹å˜æ•°æ®åŒ…çš„æ¥æºåœ°å€
- ðŸ”¸ **ä¼ªè£…(MASQUERADE)**: åŠ¨æ€çš„æºåœ°å€è½¬æ¢
- ðŸ”¸ **æœ€ç»ˆæ ‡è®°**: å¯¹å³å°†å‘å‡ºçš„æ•°æ®åŒ…è¿›è¡Œæœ€åŽæ ‡è®°

**ç”Ÿæ´»ç±»æ¯”**: å°±åƒå‡ºå›½æ—¶çš„æµ·å…³æ£€æŸ¥ï¼Œå¯èƒ½ä¼šç»™ä½ ç›–ä¸ªå‡ºå¢ƒç« ï¼Œè¯æ˜Žä½ æ˜¯ä»Žå“ªé‡Œå‡ºåŽ»çš„ã€‚

**å…¸åž‹é…ç½®**:
```bash
# å†…ç½‘ä¸Šç½‘çš„åœ°å€ä¼ªè£…
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# å›ºå®šIPçš„æºåœ°å€è½¬æ¢
iptables -t nat -A POSTROUTING -o eth0 -j SNAT --to-source 202.96.128.86
```

---

## 4. ðŸ”„ æ•°æ®åŒ…æµè½¬è·¯å¾„


### 4.1 å®Œæ•´çš„æ•°æ®åŒ…æ—…ç¨‹


**ç†è§£è¦ç‚¹**: æ•°æ®åŒ…åƒååœ°é“ä¸€æ ·ï¼Œè¦æŒ‰ç…§å›ºå®šçš„è·¯çº¿å’Œç«™ç‚¹é€šè¡Œï¼Œä¸èƒ½è·³ç«™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ•°æ®åŒ…å®Œæ•´æµè½¬å›¾                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤–éƒ¨æ•°æ®åŒ…è¿›å…¥ï¼š
ç½‘ç»œæŽ¥å£ â†’ PREROUTINGé“¾ â†’ è·¯ç”±å†³ç­– 
                            â†“
                         INPUTé“¾ â†’ æœ¬åœ°è¿›ç¨‹
                            â†“
                        FORWARDé“¾ â†’ POSTROUTINGé“¾ â†’ å‘å‡ºæŽ¥å£

æœ¬åœ°æ•°æ®åŒ…å‘å‡ºï¼š
æœ¬åœ°è¿›ç¨‹ â†’ OUTPUTé“¾ â†’ è·¯ç”±å†³ç­– â†’ POSTROUTINGé“¾ â†’ å‘å‡ºæŽ¥å£

è½¬å‘æ•°æ®åŒ…ï¼š
è¿›å…¥æŽ¥å£ â†’ PREROUTINGé“¾ â†’ è·¯ç”±å†³ç­– â†’ FORWARDé“¾ â†’ POSTROUTINGé“¾ â†’ å‘å‡ºæŽ¥å£
```

### 4.2 ä¸‰ç§å…¸åž‹åœºæ™¯è¯¦è§£


**åœºæ™¯1: å¤–éƒ¨è®¿é—®æœ¬æœºæœåŠ¡** ðŸŒâž¡ï¸ðŸ–¥ï¸
```
æ­¥éª¤åˆ†æžï¼š
1ï¸âƒ£ æ•°æ®åŒ…åˆ°è¾¾ç½‘ç»œæŽ¥å£
2ï¸âƒ£ ç»è¿‡PREROUTINGé“¾æ£€æŸ¥ï¼ˆå¯èƒ½è¿›è¡ŒDNATï¼‰
3ï¸âƒ£ è·¯ç”±å†³ç­–ï¼šç¡®å®šç›®æ ‡æ˜¯æœ¬æœº
4ï¸âƒ£ ç»è¿‡INPUTé“¾æ£€æŸ¥ï¼ˆè¿‡æ»¤è§„åˆ™ï¼‰
5ï¸âƒ£ äº¤ç»™æœ¬æœºåº”ç”¨ç¨‹åºå¤„ç†

å®žé™…ä¾‹å­ï¼šç”¨æˆ·é€šè¿‡æµè§ˆå™¨è®¿é—®WebæœåŠ¡å™¨
å®¢æˆ·ç«¯:80 â†’ [ç½‘å¡] â†’ [PREROUTING] â†’ [è·¯ç”±] â†’ [INPUT] â†’ WebæœåŠ¡
```

**åœºæ™¯2: æœ¬æœºè®¿é—®å¤–éƒ¨æœåŠ¡** ðŸ–¥ï¸âž¡ï¸ðŸŒ
```
æ­¥éª¤åˆ†æžï¼š
1ï¸âƒ£ æœ¬æœºåº”ç”¨ç¨‹åºäº§ç”Ÿæ•°æ®åŒ…
2ï¸âƒ£ ç»è¿‡OUTPUTé“¾æ£€æŸ¥
3ï¸âƒ£ è·¯ç”±å†³ç­–ï¼šç¡®å®šä»Žå“ªä¸ªæŽ¥å£å‘å‡º
4ï¸âƒ£ ç»è¿‡POSTROUTINGé“¾ï¼ˆå¯èƒ½è¿›è¡ŒSNATï¼‰
5ï¸âƒ£ ä»Žç½‘ç»œæŽ¥å£å‘å‡º

å®žé™…ä¾‹å­ï¼šæœåŠ¡å™¨ä¸»åŠ¨è¿žæŽ¥å¤–éƒ¨API
Webåº”ç”¨ â†’ [OUTPUT] â†’ [è·¯ç”±] â†’ [POSTROUTING] â†’ [ç½‘å¡] â†’ å¤–éƒ¨API
```

**åœºæ™¯3: è½¬å‘æ•°æ®åŒ…ï¼ˆè·¯ç”±åŠŸèƒ½ï¼‰** ðŸŒâž¡ï¸ðŸ–¥ï¸âž¡ï¸ðŸŒ
```
æ­¥éª¤åˆ†æžï¼š
1ï¸âƒ£ æ•°æ®åŒ…ä»Žä¸€ä¸ªæŽ¥å£è¿›å…¥
2ï¸âƒ£ ç»è¿‡PREROUTINGé“¾æ£€æŸ¥
3ï¸âƒ£ è·¯ç”±å†³ç­–ï¼šç¡®å®šéœ€è¦è½¬å‘
4ï¸âƒ£ ç»è¿‡FORWARDé“¾æ£€æŸ¥
5ï¸âƒ£ ç»è¿‡POSTROUTINGé“¾å¤„ç†
6ï¸âƒ£ ä»Žå¦ä¸€ä¸ªæŽ¥å£å‘å‡º

å®žé™…ä¾‹å­ï¼šè·¯ç”±å™¨è½¬å‘å†…ç½‘åˆ°å¤–ç½‘çš„æ•°æ®
å†…ç½‘PC â†’ [eth1] â†’ [PREROUTING] â†’ [è·¯ç”±] â†’ [FORWARD] â†’ [POSTROUTING] â†’ [eth0] â†’ äº’è”ç½‘
```

### 4.3 è¡¨åœ¨é“¾ä¸­çš„æ‰§è¡Œé¡ºåº


**é‡è¦ç†è§£**: åœ¨åŒä¸€ä¸ªé“¾ä¸­ï¼Œä¸åŒçš„è¡¨æœ‰ä¸åŒçš„ä¼˜å…ˆçº§ï¼Œå°±åƒVIPé€šé“ä¸€æ ·ã€‚

```
é“¾ä¸­è¡¨çš„æ‰§è¡Œé¡ºåºï¼ˆä¼˜å…ˆçº§ä»Žé«˜åˆ°ä½Žï¼‰ï¼š
1ï¸âƒ£ rawè¡¨    - æœ€é«˜ä¼˜å…ˆçº§ï¼Œè¿žæŽ¥è·Ÿè¸ªæŽ§åˆ¶
2ï¸âƒ£ mangleè¡¨ - ç¬¬äºŒä¼˜å…ˆçº§ï¼ŒåŒ…å¤´ä¿®æ”¹  
3ï¸âƒ£ natè¡¨    - ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼Œåœ°å€è½¬æ¢
4ï¸âƒ£ filterè¡¨ - æœ€ä½Žä¼˜å…ˆçº§ï¼ŒåŒ…è¿‡æ»¤

ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ
rawè¡¨è¦æœ€å…ˆæ‰§è¡Œï¼Œå†³å®šæ˜¯å¦è·Ÿè¸ªè¿žæŽ¥
mangleè¡¨è¦åœ¨natè¡¨å‰é¢ï¼Œå…ˆä¿®æ”¹å†è½¬æ¢
natè¡¨è¦åœ¨filterè¡¨å‰é¢ï¼Œå…ˆè½¬æ¢åœ°å€å†è¿‡æ»¤
filterè¡¨æœ€åŽæ‰§è¡Œï¼Œæ ¹æ®æœ€ç»ˆçš„åŒ…ä¿¡æ¯å†³å®šæ˜¯å¦é€šè¿‡
```

---

## 5. âš–ï¸ è¡¨é“¾ä¼˜å…ˆçº§ä¸ŽåŒ¹é…æœºåˆ¶


### 5.1 è§„åˆ™åŒ¹é…çš„åŸºæœ¬åŽŸåˆ™


**æ ¸å¿ƒæœºåˆ¶**: iptablesæŒ‰ç…§**ä»Žä¸Šåˆ°ä¸‹**çš„é¡ºåºé€æ¡æ£€æŸ¥è§„åˆ™ï¼Œ**ç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™**å°±æ˜¯æœ€ç»ˆå†³å®šã€‚

**ç”Ÿæ´»ç±»æ¯”**: 
```
å°±åƒçœ‹ç—…æŒ‚å·ï¼š
- å…ˆåˆ°VIPçª—å£çœ‹æœ‰æ²¡æœ‰VIPå·ï¼ˆä¼˜å…ˆçº§é«˜çš„è§„åˆ™ï¼‰
- æ²¡æœ‰VIPå†åˆ°æ™®é€šçª—å£æŽ’é˜Ÿï¼ˆåŽé¢çš„è§„åˆ™ï¼‰  
- æŽ’åˆ°äº†å°±ä¸ç”¨å†å¾€åŽæŽ’äº†ï¼ˆç¬¬ä¸€ä¸ªåŒ¹é…å°±ç”Ÿæ•ˆï¼‰
```

### 5.2 è§„åˆ™ä¼˜å…ˆçº§æœºåˆ¶


**è§„åˆ™ç¼–å·çš„é‡è¦æ€§**:
```bash
# æŸ¥çœ‹è§„åˆ™ç¼–å·
iptables -L INPUT --line-numbers

Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination         
1    ACCEPT     tcp  --  192.168.1.100       anywhere            tcp dpt:ssh
2    DROP       tcp  --  anywhere             anywhere            tcp dpt:ssh  
3    ACCEPT     all  --  anywhere             anywhere            

è§£è¯»ï¼š
ç¼–å·1ï¼šå…è®¸192.168.1.100è®¿é—®SSH
ç¼–å·2ï¼šæ‹’ç»æ‰€æœ‰å…¶ä»–SSHè®¿é—®  
ç¼–å·3ï¼šå…è®¸æ‰€æœ‰å…¶ä»–è¿žæŽ¥

ç»“æžœï¼š192.168.1.100å¯ä»¥SSHï¼Œå…¶ä»–IPä¸èƒ½SSHï¼Œä½†å¯ä»¥è®¿é—®å…¶ä»–æœåŠ¡
```

**æ’å…¥è§„åˆ™çš„æŠ€å·§**:
```bash
# åœ¨ç¬¬1ä½æ’å…¥æ–°è§„åˆ™ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
iptables -I INPUT 1 -p tcp --dport 80 -j ACCEPT

# åœ¨ç¬¬3ä½æ’å…¥è§„åˆ™
iptables -I INPUT 3 -s 192.168.1.200 -j DROP

# è¿½åŠ åˆ°æœ€åŽï¼ˆæœ€ä½Žä¼˜å…ˆçº§ï¼‰
iptables -A INPUT -j DROP
```

### 5.3 åŒ¹é…æ¡ä»¶è¯¦è§£


**å¸¸ç”¨åŒ¹é…æ¡ä»¶å¯¹æ¯”**:

| åŒ¹é…æ¡ä»¶ | **å‚æ•°** | **ç¤ºä¾‹** | **è¯´æ˜Ž** |
|---------|---------|---------|---------|
| ðŸŒ **æºåœ°å€** | `-s` | `-s 192.168.1.100` | `æ¥æºIPåœ°å€` |
| ðŸŽ¯ **ç›®æ ‡åœ°å€** | `-d` | `-d 192.168.1.200` | `ç›®æ ‡IPåœ°å€` |
| ðŸ”Œ **åè®®** | `-p` | `-p tcp` | `åè®®ç±»åž‹` |
| ðŸ“¥ **å…¥æŽ¥å£** | `-i` | `-i eth0` | `æ•°æ®åŒ…è¿›å…¥çš„ç½‘å¡` |
| ðŸ“¤ **å‡ºæŽ¥å£** | `-o` | `-o eth1` | `æ•°æ®åŒ…å‘å‡ºçš„ç½‘å¡` |
| ðŸšª **ç«¯å£** | `--dport` | `--dport 80` | `ç›®æ ‡ç«¯å£å·` |
| ðŸ”„ **è¿žæŽ¥çŠ¶æ€** | `--state` | `--state ESTABLISHED` | `è¿žæŽ¥çŠ¶æ€` |

### 5.4 åŠ¨ä½œç±»åž‹è¯¦è§£


**åŸºæœ¬åŠ¨ä½œå¯¹æ¯”**:

| åŠ¨ä½œ | **å«ä¹‰** | **åº”ç”¨åœºæ™¯** | **ç”¨æˆ·æ„Ÿå—** |
|------|---------|-------------|-------------|
| âœ… **ACCEPT** | `æŽ¥å—å¹¶å…è®¸é€šè¿‡` | `æ­£å¸¸çš„åˆæ³•è®¿é—®` | `æ­£å¸¸è¿žæŽ¥ï¼Œæ— æ„ŸçŸ¥` |
| âŒ **DROP** | `ç›´æŽ¥ä¸¢å¼ƒï¼Œä¸å›žå¤` | `æ¶æ„æ”»å‡»ï¼Œé™é»˜å¤„ç†` | `è¿žæŽ¥è¶…æ—¶ï¼Œæ— å“åº”` |
| ðŸš« **REJECT** | `æ‹’ç»å¹¶å‘é€é”™è¯¯ä¿¡æ¯` | `ä¸å…è®¸ä½†è¦å‘ŠçŸ¥` | `ç«‹å³æ”¶åˆ°æ‹’ç»ä¿¡æ¯` |
| â†—ï¸ **REDIRECT** | `é‡å®šå‘åˆ°æœ¬æœºå…¶ä»–ç«¯å£` | `é€æ˜Žä»£ç†` | `è¢«é‡å®šå‘åˆ°å…¶ä»–æœåŠ¡` |

### 5.5 å¤æ‚è§„åˆ™ç¤ºä¾‹


**å¤šæ¡ä»¶ç»„åˆè§„åˆ™**:
```bash
# åªå…è®¸å·¥ä½œæ—¶é—´(9-18ç‚¹)ï¼Œç‰¹å®šç½‘æ®µ(192.168.1.0/24)è®¿é—®WebæœåŠ¡
iptables -A INPUT -p tcp --dport 80 \
    -s 192.168.1.0/24 \
    -m time --timestart 09:00 --timestop 18:00 \
    -m time --weekdays Mon,Tue,Wed,Thu,Fri \
    -j ACCEPT

# é™åˆ¶æ¯ä¸ªIPæ¯åˆ†é’Ÿæœ€å¤š10ä¸ªæ–°è¿žæŽ¥
iptables -A INPUT -p tcp --dport 80 \
    -m recent --name web_conn --set
iptables -A INPUT -p tcp --dport 80 \
    -m recent --name web_conn --update --seconds 60 --hitcount 10 \
    -j DROP
```

---

## 6. ðŸ”— ç”¨æˆ·è‡ªå®šä¹‰é“¾


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰é“¾


**é—®é¢˜åœºæ™¯**: å½“é˜²ç«å¢™è§„åˆ™å˜å¾—å¤æ‚æ—¶ï¼Œæ‰€æœ‰è§„åˆ™éƒ½æ”¾åœ¨ç³»ç»Ÿé»˜è®¤é“¾é‡Œä¼šå˜å¾—éš¾ä»¥ç®¡ç†ã€‚

**ç”Ÿæ´»ç±»æ¯”**: 
```
å°±åƒæ•´ç†è¡£æŸœï¼š
- æŠŠæ‰€æœ‰è¡£æœå †åœ¨ä¸€èµ· â†’ éš¾æ‰¾ã€éš¾ç®¡ç†
- åˆ†ç±»æ•´ç†ï¼šå¤è£…ä¸€ä¸ªåŒºåŸŸï¼Œå†¬è£…ä¸€ä¸ªåŒºåŸŸ â†’ æ¸…æ™°æ˜“ç®¡ç†

iptablesä¹Ÿä¸€æ ·ï¼š
- æ‰€æœ‰è§„åˆ™éƒ½åœ¨INPUTé“¾ â†’ æ··ä¹±éš¾ç»´æŠ¤
- åˆ›å»ºä¸“é—¨çš„é“¾ï¼šSSH_RULESé“¾ã€WEB_RULESé“¾ â†’ åˆ†ç±»æ¸…æ™°
```

### 6.2 è‡ªå®šä¹‰é“¾çš„åˆ›å»ºä¸Žç®¡ç†


**åŸºæœ¬æ“ä½œ**:
```bash
# åˆ›å»ºè‡ªå®šä¹‰é“¾
iptables -N SSH_RULES
iptables -N WEB_RULES  
iptables -N ANTI_SCAN

# æŸ¥çœ‹æ‰€æœ‰é“¾ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰é“¾ï¼‰
iptables -L

# åˆ é™¤è‡ªå®šä¹‰é“¾ï¼ˆå¿…é¡»å…ˆæ¸…ç©ºè§„åˆ™ï¼‰
iptables -F SSH_RULES    # æ¸…ç©ºè§„åˆ™
iptables -X SSH_RULES    # åˆ é™¤é“¾
```

### 6.3 é“¾è·³è½¬æœºåˆ¶


**è·³è½¬æ¦‚å¿µ**: å½“æ•°æ®åŒ…åŒ¹é…æŸä¸ªè§„åˆ™æ—¶ï¼Œå¯ä»¥"è·³è½¬"åˆ°å¦ä¸€ä¸ªé“¾ç»§ç»­å¤„ç†ï¼Œå°±åƒç¨‹åºä¸­çš„å‡½æ•°è°ƒç”¨ã€‚

```
ä¸»é“¾ â†’ è‡ªå®šä¹‰é“¾ â†’ è¿”å›žä¸»é“¾ æˆ– ç»“æŸå¤„ç†

æ•°æ®åŒ…å¤„ç†æµç¨‹ï¼š
1ï¸âƒ£ æ•°æ®åŒ…è¿›å…¥INPUTé“¾
2ï¸âƒ£ åŒ¹é…åˆ°è·³è½¬è§„åˆ™ï¼š-j SSH_RULES
3ï¸âƒ£ è·³è½¬åˆ°SSH_RULESé“¾å¤„ç†
4ï¸âƒ£ SSH_RULESé“¾å¤„ç†å®Œæ¯•
5ï¸âƒ£ è¿”å›žINPUTé“¾ç»§ç»­åŽç»­è§„åˆ™ æˆ– ç›´æŽ¥æ‰§è¡ŒåŠ¨ä½œç»“æŸ
```

### 6.4 å®žé™…åº”ç”¨ç¤ºä¾‹


**åˆ›å»ºSSHè®¿é—®æŽ§åˆ¶é“¾**:
```bash
# åˆ›å»ºSSHä¸“ç”¨é“¾
iptables -N SSH_ACCESS_CONTROL

# åœ¨SSHé“¾ä¸­æ·»åŠ å…·ä½“è§„åˆ™
iptables -A SSH_ACCESS_CONTROL -s 192.168.1.100 -j ACCEPT    # å…è®¸ç®¡ç†å‘˜IP
iptables -A SSH_ACCESS_CONTROL -s 192.168.1.200 -j ACCEPT    # å…è®¸å¼€å‘è€…IP
iptables -A SSH_ACCESS_CONTROL -m recent --name ssh_attack --set  # è®°å½•å…¶ä»–IP
iptables -A SSH_ACCESS_CONTROL -m recent --name ssh_attack --update --seconds 60 --hitcount 3 -j DROP  # é™åˆ¶å°è¯•æ¬¡æ•°
iptables -A SSH_ACCESS_CONTROL -j LOG --log-prefix "SSH_DENY: "  # è®°å½•æ—¥å¿—
iptables -A SSH_ACCESS_CONTROL -j DROP  # æœ€åŽæ‹’ç»

# åœ¨ä¸»INPUTé“¾ä¸­è°ƒç”¨SSHé“¾
iptables -A INPUT -p tcp --dport 22 -j SSH_ACCESS_CONTROL
```

**åˆ›å»ºWebæœåŠ¡æŽ§åˆ¶é“¾**:
```bash
# åˆ›å»ºWebæœåŠ¡é“¾
iptables -N WEB_SERVICE

# å…è®¸æ­£å¸¸HTTP/HTTPSè®¿é—®
iptables -A WEB_SERVICE -p tcp --dport 80 -j ACCEPT
iptables -A WEB_SERVICE -p tcp --dport 443 -j ACCEPT

# é˜²æ­¢æ‰«æå™¨
iptables -A WEB_SERVICE -p tcp --tcp-flags ALL FIN,URG,PSH -j DROP
iptables -A WEB_SERVICE -p tcp --tcp-flags ALL NONE -j DROP

# é™åˆ¶è¿žæŽ¥é€ŸçŽ‡
iptables -A WEB_SERVICE -p tcp --dport 80 -m limit --limit 25/minute --limit-burst 100 -j ACCEPT

# ä¸»é“¾è°ƒç”¨
iptables -A INPUT -p tcp -m multiport --dports 80,443 -j WEB_SERVICE
```

### 6.5 è‡ªå®šä¹‰é“¾çš„ä¼˜åŠ¿


**ç®¡ç†ä¼˜åŠ¿**:
- âœ… **æ¨¡å—åŒ–ç®¡ç†**: ä¸åŒæœåŠ¡çš„è§„åˆ™åˆ†å¼€ç®¡ç†
- âœ… **é‡å¤åˆ©ç”¨**: ä¸€ä¸ªé“¾å¯ä»¥è¢«å¤šä¸ªè§„åˆ™è°ƒç”¨
- âœ… **æ˜“äºŽç»´æŠ¤**: ä¿®æ”¹æŸä¸ªæœåŠ¡çš„è§„åˆ™åªéœ€ä¿®æ”¹å¯¹åº”é“¾
- âœ… **é€»è¾‘æ¸…æ™°**: è§„åˆ™ç»“æž„æ›´æ¸…æ¥šï¼Œä¾¿äºŽç†è§£å’Œè°ƒè¯•

---

## 7. ðŸ›¡ï¸ é“¾ç­–ç•¥è®¾ç½®


### 7.1 ä»€ä¹ˆæ˜¯é“¾ç­–ç•¥


**åŸºæœ¬æ¦‚å¿µ**: é“¾ç­–ç•¥æ˜¯å½“æ•°æ®åŒ…éåŽ†å®Œé“¾ä¸­æ‰€æœ‰è§„åˆ™éƒ½ä¸åŒ¹é…æ—¶çš„**é»˜è®¤å¤„ç†åŠ¨ä½œ**ã€‚

**ç”Ÿæ´»ç±»æ¯”**: 
```
å°±åƒå…¬å¸çš„é—¨ç¦ç³»ç»Ÿï¼š
- ç™½åå•æ¨¡å¼ï¼šé»˜è®¤æ‹’ç»æ‰€æœ‰äººï¼Œåªæœ‰åå•ä¸Šçš„äººæ‰èƒ½è¿›å…¥
- é»‘åå•æ¨¡å¼ï¼šé»˜è®¤å…è®¸æ‰€æœ‰äººï¼Œåªæ‹’ç»åå•ä¸Šçš„äºº

iptablesé“¾ç­–ç•¥ï¼š
- ACCEPTç­–ç•¥ï¼šé»˜è®¤å…è®¸ï¼Œåªæ‹’ç»æ˜Žç¡®ç¦æ­¢çš„
- DROPç­–ç•¥ï¼šé»˜è®¤æ‹’ç»ï¼Œåªå…è®¸æ˜Žç¡®å…è®¸çš„
```

### 7.2 ä¸‰ç§ç­–ç•¥ç±»åž‹


**ACCEPTç­–ç•¥ - é»˜è®¤é€šè¿‡** âœ…
```bash
# è®¾ç½®INPUTé“¾é»˜è®¤ç­–ç•¥ä¸ºACCEPT
iptables -P INPUT ACCEPT

é€‚ç”¨åœºæ™¯ï¼š
ðŸ”¸ æµ‹è¯•çŽ¯å¢ƒï¼šé˜²æ­¢é…ç½®é”™è¯¯å¯¼è‡´æ— æ³•è¿žæŽ¥
ðŸ”¸ ä¿¡ä»»ç½‘ç»œï¼šå†…ç½‘çŽ¯å¢ƒï¼Œå®‰å…¨é£Žé™©è¾ƒä½Ž
ðŸ”¸ ä¸´æ—¶è°ƒè¯•ï¼šæŽ’æŸ¥é—®é¢˜æ—¶ä¸´æ—¶å¼€æ”¾

é£Žé™©ï¼šå¦‚æžœå¿˜è®°é…ç½®æ‹’ç»è§„åˆ™ï¼Œå¯èƒ½å¯¼è‡´å®‰å…¨æ¼æ´ž
```

**DROPç­–ç•¥ - é»˜è®¤æ‹’ç»** âŒ
```bash
# è®¾ç½®INPUTé“¾é»˜è®¤ç­–ç•¥ä¸ºDROP
iptables -P INPUT DROP

é€‚ç”¨åœºæ™¯ï¼š
ðŸ”¸ ç”Ÿäº§çŽ¯å¢ƒï¼šå®‰å…¨è¦æ±‚é«˜çš„æœåŠ¡å™¨
ðŸ”¸ å…¬ç½‘æœåŠ¡å™¨ï¼šé¢å‘äº’è”ç½‘çš„æœåŠ¡å™¨
ðŸ”¸ é«˜å®‰å…¨è¦æ±‚ï¼šé‡‘èžã€æ”¿åºœç­‰æ•æ„Ÿç³»ç»Ÿ

é£Žé™©ï¼šé…ç½®é”™è¯¯å¯èƒ½å¯¼è‡´è‡ªå·±æ— æ³•è¿žæŽ¥æœåŠ¡å™¨
```

**REJECTç­–ç•¥ - æ‹’ç»å¹¶é€šçŸ¥** ðŸš«
```bash
# REJECTä¸èƒ½ä½œä¸ºé“¾çš„é»˜è®¤ç­–ç•¥ï¼Œåªèƒ½ä½œä¸ºè§„åˆ™åŠ¨ä½œ
iptables -A INPUT -j REJECT

ç‰¹ç‚¹ï¼š
ðŸ”¸ å‘é€ICMPä¸å¯è¾¾æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
ðŸ”¸ å®¢æˆ·ç«¯ç«‹å³çŸ¥é“è¿žæŽ¥è¢«æ‹’ç»
ðŸ”¸ æ¯”DROPæ›´"å‹å¥½"ï¼Œä½†æš´éœ²äº†æœåŠ¡å™¨å­˜åœ¨
```

### 7.3 å®‰å…¨ç­–ç•¥æœ€ä½³å®žè·µ


**æŽ¨èçš„å®‰å…¨é…ç½®æµç¨‹**:

**æ­¥éª¤1: å…ˆä¿è¯è‡ªå·±ä¸è¢«é”å‡º**
```bash
# æ°¸è¿œå…ˆé…ç½®SSHè®¿é—®è§„åˆ™ï¼Œé˜²æ­¢è‡ªå·±è¢«é”å®š
iptables -A INPUT -p tcp -s YOUR_IP --dport 22 -j ACCEPT
iptables -A INPUT -i lo -j ACCEPT  # å…è®¸æœ¬åœ°å›žçŽ¯
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT  # å…è®¸å·²å»ºç«‹è¿žæŽ¥
```

**æ­¥éª¤2: é…ç½®å¿…è¦çš„æœåŠ¡è§„åˆ™**
```bash
# é…ç½®WebæœåŠ¡è®¿é—®
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# é…ç½®å…¶ä»–å¿…è¦æœåŠ¡
iptables -A INPUT -p tcp --dport 25 -j ACCEPT  # é‚®ä»¶æœåŠ¡
```

**æ­¥éª¤3: æœ€åŽè®¾ç½®ä¸¥æ ¼ç­–ç•¥**
```bash
# æœ€åŽè®¾ç½®é»˜è®¤æ‹’ç»ç­–ç•¥
iptables -P INPUT DROP
iptables -P FORWARD DROP  
iptables -P OUTPUT ACCEPT  # è¾“å‡ºé€šå¸¸ä¿æŒå…è®¸
```

### 7.4 ç­–ç•¥é…ç½®å®žä¾‹


**WebæœåŠ¡å™¨å®‰å…¨é…ç½®**:
```bash
#!/bin/bash
# WebæœåŠ¡å™¨é˜²ç«å¢™é…ç½®è„šæœ¬

# æ¸…ç©ºçŽ°æœ‰è§„åˆ™
iptables -F
iptables -t nat -F
iptables -t mangle -F

# å…è®¸æœ¬åœ°å›žçŽ¯å’Œå·²å»ºç«‹è¿žæŽ¥
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# å…è®¸SSHï¼ˆé™åˆ¶IPï¼‰
iptables -A INPUT -p tcp -s 192.168.1.100 --dport 22 -j ACCEPT

# å…è®¸WebæœåŠ¡
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# å…è®¸PINGï¼ˆé™åˆ¶é¢‘çŽ‡ï¼‰
iptables -A INPUT -p icmp -m limit --limit 1/second -j ACCEPT

# è®¾ç½®é»˜è®¤æ‹’ç»ç­–ç•¥
iptables -P INPUT DROP
iptables -P FORWARD DROP

echo "é˜²ç«å¢™é…ç½®å®Œæˆï¼"
```

**å†…ç½‘è·¯ç”±å™¨é…ç½®**:
```bash
#!/bin/bash  
# å†…ç½‘è·¯ç”±å™¨é…ç½®

# å…è®¸å†…ç½‘åˆ°å¤–ç½‘
iptables -A FORWARD -s 192.168.1.0/24 -o eth0 -j ACCEPT
iptables -A FORWARD -i eth0 -o eth1 -m state --state ESTABLISHED,RELATED -j ACCEPT

# NATé…ç½®
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# è®¾ç½®è½¬å‘ç­–ç•¥
iptables -P FORWARD DROP  # é»˜è®¤ä¸å…è®¸è½¬å‘
```

---

## 8. ðŸš€ å®žæˆ˜åº”ç”¨ä¸Žæœ€ä½³å®žè·µ


### 8.1 å¸¸è§åº”ç”¨åœºæ™¯é…ç½®


**åœºæ™¯1: ä¼ä¸šåŠžå…¬ç½‘ç»œé˜²ç«å¢™** ðŸ¢
```bash
# åŸºç¡€å®‰å…¨é…ç½®
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# å…è®¸å†…ç½‘SSHè®¿é—®
iptables -A INPUT -p tcp -s 192.168.0.0/16 --dport 22 -j ACCEPT

# WebæœåŠ¡è®¿é—®æŽ§åˆ¶
iptables -A INPUT -p tcp --dport 80 -m limit --limit 100/minute -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -m limit --limit 100/minute -j ACCEPT

# é‚®ä»¶æœåŠ¡
iptables -A INPUT -p tcp --dport 25 -j ACCEPT
iptables -A INPUT -p tcp --dport 110 -j ACCEPT
iptables -A INPUT -p tcp --dport 143 -j ACCEPT

# é˜²æ­¢ç«¯å£æ‰«æ
iptables -A INPUT -p tcp --tcp-flags ALL FIN,URG,PSH -j DROP
iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP

# æœ€åŽæ‹’ç»å…¶ä»–
iptables -A INPUT -j DROP
```

**åœºæ™¯2: å®¶ç”¨è·¯ç”±å™¨NATé…ç½®** ðŸ 
```bash
# å¼€å¯IPè½¬å‘
echo 1 > /proc/sys/net/ipv4/ip_forward

# å†…ç½‘è®¿é—®å¤–ç½‘çš„NAT
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o ppp0 -j MASQUERADE

# å…è®¸å†…ç½‘è®¿é—®å¤–ç½‘
iptables -A FORWARD -s 192.168.1.0/24 -o ppp0 -j ACCEPT
iptables -A FORWARD -i ppp0 -o eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT

# ç«¯å£è½¬å‘ï¼šå¤–ç½‘80ç«¯å£è½¬å‘åˆ°å†…ç½‘WebæœåŠ¡å™¨
iptables -t nat -A PREROUTING -i ppp0 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:80
iptables -A FORWARD -p tcp -d 192.168.1.100 --dport 80 -j ACCEPT

# é»˜è®¤æ‹’ç»è½¬å‘
iptables -P FORWARD DROP
```

### 8.2 æ€§èƒ½ä¼˜åŒ–æŠ€å·§


**è§„åˆ™ä¼˜åŒ–åŽŸåˆ™**:
- ðŸ”¸ **é¢‘ç¹åŒ¹é…çš„è§„åˆ™æ”¾å‰é¢**: å‡å°‘è§„åˆ™éåŽ†æ¬¡æ•°
- ðŸ”¸ **ä½¿ç”¨è¿žæŽ¥è·Ÿè¸ª**: å‡å°‘é‡å¤æ£€æŸ¥å·²å»ºç«‹çš„è¿žæŽ¥
- ðŸ”¸ **åˆç†ä½¿ç”¨NOTRACK**: å¯¹ä¸éœ€è¦è·Ÿè¸ªçš„è¿žæŽ¥è·³è¿‡è·Ÿè¸ª
- ðŸ”¸ **é¿å…è¿‡äºŽå¤æ‚çš„åŒ¹é…æ¡ä»¶**: ç®€åŒ–åŒ¹é…é€»è¾‘

**é«˜æ€§èƒ½é…ç½®ç¤ºä¾‹**:
```bash
# æœ€å¸¸ç”¨çš„è¿žæŽ¥å…ˆå¤„ç†
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# æœ¬åœ°è¿žæŽ¥ä¸éœ€è¦å¤æ‚æ£€æŸ¥
iptables -A INPUT -i lo -j ACCEPT

# å¯¹äºŽé«˜æµé‡ä½†å®‰å…¨çš„è¿žæŽ¥ï¼Œè·³è¿‡è¿žæŽ¥è·Ÿè¸ª
iptables -t raw -A PREROUTING -p tcp --dport 80 -j NOTRACK
iptables -t raw -A OUTPUT -p tcp --sport 80 -j NOTRACK
iptables -A INPUT -p tcp --dport 80 -m state --state UNTRACKED -j ACCEPT
```

### 8.3 è°ƒè¯•ä¸Žæ•…éšœæŽ’é™¤


**å¸¸ç”¨è°ƒè¯•å‘½ä»¤**:
```bash
# æŸ¥çœ‹è§„åˆ™åŒ¹é…ç»Ÿè®¡
iptables -L -v -n --line-numbers

# å®žæ—¶æŸ¥çœ‹æ•°æ®åŒ…åŒ¹é…æƒ…å†µ  
watch -n 1 'iptables -L -v -n'

# å¯ç”¨æ—¥å¿—è®°å½•
iptables -A INPUT -j LOG --log-prefix "INPUT_DROP: " --log-level 4
tail -f /var/log/messages | grep INPUT_DROP

# ä¸´æ—¶å¼€æ”¾æ‰€æœ‰ç«¯å£ï¼ˆè°ƒè¯•ç”¨ï¼‰
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
```

**å¸¸è§é—®é¢˜è§£å†³**:

| é—®é¢˜çŽ°è±¡ | **å¯èƒ½åŽŸå› ** | **è§£å†³æ–¹æ³•** |
|---------|-------------|-------------|
| ðŸš« **SSHè¿žä¸ä¸Š** | `INPUTé“¾é˜»æ­¢SSH` | `æ£€æŸ¥22ç«¯å£è§„åˆ™å’Œç­–ç•¥` |
| ðŸŒ **ç½‘ç«™æ— æ³•è®¿é—®** | `80/443ç«¯å£è¢«é˜»æ­¢` | `æ£€æŸ¥WebæœåŠ¡è§„åˆ™` |
| ðŸ“¡ **å†…ç½‘æ— æ³•ä¸Šç½‘** | `FORWARDé“¾æˆ–NATé—®é¢˜` | `æ£€æŸ¥è½¬å‘è§„åˆ™å’ŒMASQUERADE` |
| âš¡ **é€Ÿåº¦å¾ˆæ…¢** | `è¿žæŽ¥è·Ÿè¸ªè¡¨æ»¡` | `å¢žåŠ è¿žæŽ¥è·Ÿè¸ªè¡¨å¤§å°æˆ–ä½¿ç”¨NOTRACK` |

### 8.4 è§„åˆ™æŒä¹…åŒ–


**ä¿å­˜å’Œæ¢å¤è§„åˆ™**:
```bash
# CentOS/RHELç³»ç»Ÿ
service iptables save
service iptables restart

# Ubuntu/Debianç³»ç»Ÿ
iptables-save > /etc/iptables/rules.v4
iptables-restore < /etc/iptables/rules.v4

# é€šç”¨æ–¹æ³•ï¼šå†™æˆè„šæœ¬å¼€æœºæ‰§è¡Œ
cat > /etc/init.d/firewall << 'EOF'
#!/bin/bash
# é˜²ç«å¢™åˆå§‹åŒ–è„šæœ¬
iptables -F
iptables -A INPUT -i lo -j ACCEPT
# ... å…¶ä»–è§„åˆ™
iptables -P INPUT DROP
EOF

chmod +x /etc/init.d/firewall
```

---

## 9. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ðŸ”¸ å››è¡¨åŠŸèƒ½ï¼šfilterè¿‡æ»¤ã€natè½¬æ¢ã€mangleä¿®æ”¹ã€rawè·Ÿè¸ªæŽ§åˆ¶
ðŸ”¸ äº”é“¾ä½ç½®ï¼šPREROUTINGå…¥åŸŽã€INPUTæœ¬æœºé—¨å«ã€FORWARDäº¤é€šæŒ‡æŒ¥ã€OUTPUTå‡ºé—¨æ£€æŸ¥ã€POSTROUTINGå‡ºåŸŽ
ðŸ”¸ æ•°æ®æµå‘ï¼šä¸‰ç§å…¸åž‹åœºæ™¯çš„å®Œæ•´è·¯å¾„
ðŸ”¸ åŒ¹é…æœºåˆ¶ï¼šä»Žä¸Šåˆ°ä¸‹é€æ¡åŒ¹é…ï¼Œç¬¬ä¸€ä¸ªåŒ¹é…è§„åˆ™ç”Ÿæ•ˆ
ðŸ”¸ ç­–ç•¥è®¾ç½®ï¼šé»˜è®¤åŠ¨ä½œçš„é‡è¦æ€§å’Œå®‰å…¨é…ç½®
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ è¡¨é“¾å…³ç³»çš„æœ¬è´¨**
```
ç†è§£è¦ç‚¹ï¼š
- è¡¨æ˜¯åŠŸèƒ½åˆ†ç±»ï¼šä¸åŒç±»åž‹çš„è§„åˆ™æ”¾ä¸åŒè¡¨
- é“¾æ˜¯æ£€æŸ¥ä½ç½®ï¼šæ•°æ®åŒ…ç»è¿‡çš„å¿…ç»ä¹‹è·¯
- è§„åˆ™æ˜¯å…·ä½“æŒ‡ä»¤ï¼šå¦‚ä½•å¤„ç†åŒ¹é…çš„æ•°æ®åŒ…
- ç­–ç•¥æ˜¯å…œåº•æ–¹æ¡ˆï¼šæ‰€æœ‰è§„åˆ™éƒ½ä¸åŒ¹é…æ—¶çš„é»˜è®¤åŠ¨ä½œ
```

**ðŸ”¹ æ•°æ®åŒ…æµè½¬çš„å…³é”®**
```
è®°å¿†æŠ€å·§ï¼š
- PREROUTINGï¼šæ•°æ®åŒ…åˆšè¿›é—¨ï¼Œè¿˜æ²¡å†³å®šåŽ»å“ª
- INPUTï¼šç¡®å®šæ¥æ‰¾æœ¬æœºçš„ï¼Œå‡†å¤‡è¿›å…¥åº”ç”¨
- FORWARDï¼šä¸æ˜¯æ‰¾æœ¬æœºçš„ï¼Œéœ€è¦è½¬å‘å‡ºåŽ»
- OUTPUTï¼šæœ¬æœºäº§ç”Ÿçš„ï¼Œå‡†å¤‡å‘é€å‡ºåŽ»
- POSTROUTINGï¼šé©¬ä¸Šå°±è¦å‡ºé—¨äº†ï¼Œæœ€åŽæ£€æŸ¥
```

**ðŸ”¹ å®žé™…åº”ç”¨çš„æ ¸å¿ƒåŽŸåˆ™**
```
å®‰å…¨é…ç½®ä¸‰æ­¥èµ°ï¼š
1ï¸âƒ£ å…ˆä¿è¯è‡ªå·±ä¸è¢«é”å‡ºï¼ˆSSHè§„åˆ™ã€æœ¬åœ°å›žçŽ¯ã€å·²å»ºç«‹è¿žæŽ¥ï¼‰
2ï¸âƒ£ å†é…ç½®ä¸šåŠ¡éœ€è¦çš„è§„åˆ™ï¼ˆWebã€é‚®ä»¶ç­‰æœåŠ¡ï¼‰  
3ï¸âƒ£ æœ€åŽè®¾ç½®ä¸¥æ ¼çš„é»˜è®¤ç­–ç•¥ï¼ˆDROPæ‹’ç»å…¶ä»–ä¸€åˆ‡ï¼‰
```

### 9.3 å®žé™…åº”ç”¨ä»·å€¼


**ä¸šåŠ¡åœºæ™¯åº”ç”¨**:
- ðŸ¢ **ä¼ä¸šç½‘ç»œå®‰å…¨**: æŽ§åˆ¶å†…å¤–ç½‘è®¿é—®ï¼Œä¿æŠ¤æ ¸å¿ƒç³»ç»Ÿ
- ðŸŒ **WebæœåŠ¡å™¨é˜²æŠ¤**: é˜²æ­¢DDoSæ”»å‡»ï¼Œé™åˆ¶è®¿é—®é¢‘çŽ‡
- ðŸ  **å®¶åº­è·¯ç”±å™¨**: å®žçŽ°NATä¸Šç½‘ï¼Œç«¯å£è½¬å‘
- â˜ï¸ **äº‘æœåŠ¡å™¨å®‰å…¨**: ç²¾ç¡®æŽ§åˆ¶æœåŠ¡è®¿é—®æƒé™

**è¿ç»´å®žè·µä»·å€¼**:
- ðŸ”§ **ç³»ç»Ÿå®‰å…¨**: æž„å»ºå¤šå±‚é˜²æŠ¤ä½“ç³»
- ðŸ“Š **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œå¼€é”€
- ðŸš¨ **æ•…éšœæŽ’æŸ¥**: é€šè¿‡è§„åˆ™åŒ¹é…å®šä½ç½‘ç»œé—®é¢˜
- ðŸ“ **åˆè§„å®¡è®¡**: è®°å½•å’Œåˆ†æžç½‘ç»œè®¿é—®è¡Œä¸º

**å­¦ä¹ æå‡å»ºè®®**:
- ðŸ’¡ **ä»Žç®€å•å¼€å§‹**: å…ˆæŽŒæ¡åŸºæœ¬çš„INPUTè§„åˆ™é…ç½®
- ðŸ”„ **å®žè·µéªŒè¯**: æ¯ä¸ªé…ç½®éƒ½è¦æµ‹è¯•æ•ˆæžœ
- ðŸ“š **ç³»ç»Ÿå­¦ä¹ **: ç†è§£netfilteræ¡†æž¶çš„æ•´ä½“æž¶æž„
- ðŸ›¡ï¸ **å®‰å…¨æ„è¯†**: å§‹ç»ˆä»¥å®‰å…¨ä¸ºç¬¬ä¸€åŽŸåˆ™è¿›è¡Œé…ç½®

**æ ¸å¿ƒè®°å¿†å£è¯€**:
- å››è¡¨å„å¸èŒï¼Œfilteræœ€å¸¸ç”¨
- äº”é“¾æœ‰é¡ºåºï¼Œæ•°æ®åŒ…å¿…ç»
- è§„åˆ™ä»Žä¸Šä¸‹ï¼Œç¬¬ä¸€ä¸ªç”Ÿæ•ˆ
- ç­–ç•¥æ˜¯å…œåº•ï¼Œå®‰å…¨è¦ä¸¥æ ¼