---
title: 15ã€å®¹å™¨ç½‘ç»œé˜²ç«å¢™ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [å®¹å™¨ç½‘ç»œé˜²ç«å¢™åŸºç¡€](#1-å®¹å™¨ç½‘ç»œé˜²ç«å¢™åŸºç¡€)
2. [Dockerç½‘ç»œé˜²ç«å¢™è§„åˆ™](#2-Dockerç½‘ç»œé˜²ç«å¢™è§„åˆ™)
3. [å®¹å™¨é—´è®¿é—®æ§åˆ¶](#3-å®¹å™¨é—´è®¿é—®æ§åˆ¶)
4. [Kubernetesç½‘ç»œç­–ç•¥](#4-Kubernetesç½‘ç»œç­–ç•¥)
5. [å®¹å™¨ç«¯å£æš´éœ²ç®¡ç†](#5-å®¹å™¨ç«¯å£æš´éœ²ç®¡ç†)
6. [å¾®æœåŠ¡å®‰å…¨éš”ç¦»](#6-å¾®æœåŠ¡å®‰å…¨éš”ç¦»)
7. [å®¹å™¨ç½‘ç»œç›‘æ§](#7-å®¹å™¨ç½‘ç»œç›‘æ§)
8. [å®¹å™¨å®‰å…¨åˆè§„æ£€æŸ¥](#8-å®¹å™¨å®‰å…¨åˆè§„æ£€æŸ¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ å®¹å™¨ç½‘ç»œé˜²ç«å¢™åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯å®¹å™¨ç½‘ç»œé˜²ç«å¢™


> ğŸ“Œ **æ ¸å¿ƒæ¦‚å¿µ**  
> å®¹å™¨ç½‘ç»œé˜²ç«å¢™æ˜¯ä¸“é—¨ä¸ºå®¹å™¨åŒ–ç¯å¢ƒè®¾è®¡çš„ç½‘ç»œå®‰å…¨é˜²æŠ¤æœºåˆ¶ï¼Œç”¨äºæ§åˆ¶å®¹å™¨ä¹‹é—´ã€å®¹å™¨ä¸å¤–éƒ¨ç½‘ç»œä¹‹é—´çš„é€šä¿¡æµé‡ã€‚

**é€šä¿—ç†è§£**ï¼š
```
ä¼ ç»Ÿé˜²ç«å¢™ = æˆ¿å­çš„å¤§é—¨å®‰æ£€
å®¹å™¨é˜²ç«å¢™ = æ¯ä¸ªæˆ¿é—´éƒ½æœ‰ç‹¬ç«‹çš„é—¨ç¦ç³»ç»Ÿ

ä¼ ç»Ÿç¯å¢ƒï¼šä¸€å°æœåŠ¡å™¨ = ä¸€æ ‹æˆ¿å­
å®¹å™¨ç¯å¢ƒï¼šä¸€å°æœåŠ¡å™¨ = ä¸€æ ‹æ¥¼é‡Œçš„å¾ˆå¤šæˆ¿é—´
```

**ä¸ºä»€ä¹ˆéœ€è¦å®¹å™¨é˜²ç«å¢™**ï¼š
- **éš”ç¦»éœ€æ±‚**ï¼šæ¯ä¸ªå®¹å™¨éƒ½æ˜¯ç‹¬ç«‹çš„åº”ç”¨ï¼Œéœ€è¦ç²¾ç»†åŒ–çš„ç½‘ç»œæ§åˆ¶
- **å®‰å…¨é£é™©**ï¼šå®¹å™¨å¯†åº¦é«˜ï¼Œä¸€ä¸ªè¢«æ”»ç ´å¯èƒ½å½±å“å…¶ä»–å®¹å™¨
- **åˆè§„è¦æ±‚**ï¼šä¼ä¸šå®‰å…¨è§„èŒƒè¦æ±‚å¯¹ç½‘ç»œæµé‡è¿›è¡Œä¸¥æ ¼ç®¡æ§

### 1.2 å®¹å™¨ç½‘ç»œæ¶æ„åŸºç¡€


```
å®¿ä¸»æœºç½‘ç»œæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å®¿ä¸»æœº (Host)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç‰©ç†ç½‘å¡ eth0 â†â†’ æ¡¥æ¥ç½‘ç»œ docker0              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®¹å™¨A (IP: 172.17.0.2) â†â†’ veth0               â”‚
â”‚  å®¹å™¨B (IP: 172.17.0.3) â†â†’ veth1               â”‚
â”‚  å®¹å™¨C (IP: 172.17.0.4) â†â†’ veth2               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®æ¦‚å¿µè§£é‡Š**ï¼š
- **docker0æ¡¥æ¥ç½‘ç»œ**ï¼šç±»ä¼¼äº¤æ¢æœºï¼Œè¿æ¥æ‰€æœ‰å®¹å™¨
- **vethå¯¹**ï¼šè™šæ‹Ÿç½‘ç»œæ¥å£å¯¹ï¼Œè¿æ¥å®¹å™¨å’Œå®¿ä¸»æœº
- **å®¹å™¨IP**ï¼šæ¯ä¸ªå®¹å™¨éƒ½æœ‰ç‹¬ç«‹çš„å†…ç½‘IPåœ°å€

### 1.3 å®¹å™¨é˜²ç«å¢™çš„å·¥ä½œå±‚æ¬¡


```
é˜²ç«å¢™æ§åˆ¶å±‚æ¬¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨å±‚é˜²ç«å¢™   â”‚ â† åº”ç”¨çº§è®¿é—®æ§åˆ¶ (å¦‚ HTTP è§„åˆ™)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç½‘ç»œå±‚é˜²ç«å¢™   â”‚ â† IP/ç«¯å£çº§æ§åˆ¶ (iptables)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®é“¾è·¯å±‚     â”‚ â† MACåœ°å€çº§æ§åˆ¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸŒ± å…¥é—¨çº§ç†è§£**ï¼š
- **ç½‘ç»œå±‚**ï¼šæ§åˆ¶å“ªä¸ªIPå¯ä»¥è®¿é—®å“ªä¸ªç«¯å£
- **åº”ç”¨å±‚**ï¼šæ§åˆ¶å…·ä½“çš„HTTPè¯·æ±‚ã€æ•°æ®åº“æŸ¥è¯¢ç­‰

---

## 2. ğŸ³ Dockerç½‘ç»œé˜²ç«å¢™è§„åˆ™


### 2.1 Dockerçš„é˜²ç«å¢™æœºåˆ¶


**Dockerå¦‚ä½•å®ç°ç½‘ç»œéš”ç¦»**ï¼š

> ğŸ’¡ **å®ç”¨æŠ€å·§**  
> Dockerè‡ªåŠ¨ä¸ºæ¯ä¸ªå®¹å™¨åˆ›å»ºç½‘ç»œå‘½åç©ºé—´ï¼Œç›¸å½“äºç»™æ¯ä¸ªå®¹å™¨åˆ†é…äº†ç‹¬ç«‹çš„ç½‘ç»œç¯å¢ƒã€‚

```
Dockerç½‘ç»œéš”ç¦»åŸç†ï¼š
å®¿ä¸»æœºç½‘ç»œå‘½åç©ºé—´ï¼šeth0, lo (ç‰©ç†ç½‘å¡)
å®¹å™¨Aç½‘ç»œå‘½åç©ºé—´ï¼šeth0, lo (è™šæ‹Ÿç½‘å¡)  
å®¹å™¨Bç½‘ç»œå‘½åç©ºé—´ï¼šeth0, lo (è™šæ‹Ÿç½‘å¡)

æ¯ä¸ªå®¹å™¨çœ‹åˆ°çš„ç½‘ç»œç¯å¢ƒéƒ½æ˜¯ç‹¬ç«‹çš„ï¼
```

### 2.2 Dockerç½‘ç»œæ¨¡å¼ä¸é˜²ç«å¢™


| ğŸ†š ç½‘ç»œæ¨¡å¼ | **å®‰å…¨çº§åˆ«** | **ç”¨é€”åœºæ™¯** | **é˜²ç«å¢™é…ç½®** |
|-------------|-------------|-------------|---------------|
| bridge | ğŸ›¡ï¸ ä¸­ç­‰ | æ™®é€šåº”ç”¨å®¹å™¨ | æ”¯æŒç«¯å£æ˜ å°„è§„åˆ™ |
| host | âš ï¸ ä½ | ç½‘ç»œå¯†é›†å‹åº”ç”¨ | ä¾èµ–å®¿ä¸»æœºé˜²ç«å¢™ |
| none | ğŸ”’ æœ€é«˜ | é«˜å®‰å…¨è¦æ±‚ | å®Œå…¨éš”ç¦»ï¼Œæ— ç½‘ç»œ |
| overlay | ğŸ›¡ï¸ é«˜ | é›†ç¾¤ç¯å¢ƒ | æ”¯æŒåŠ å¯†é€šä¿¡ |

### 2.3 Dockeré˜²ç«å¢™è§„åˆ™é…ç½®


**åŸºæœ¬ç«¯å£æš´éœ²æ§åˆ¶**ï¼š

```bash
# åªæš´éœ²ç»™æœ¬æœºè®¿é—® (æ›´å®‰å…¨)
docker run -p 127.0.0.1:8080:80 nginx

# æš´éœ²ç»™æ‰€æœ‰ç½‘ç»œ (éœ€è°¨æ…)
docker run -p 8080:80 nginx

# æŒ‡å®šåè®®ç±»å‹
docker run -p 3306:3306/tcp mysql
docker run -p 53:53/udp bind9
```

**è‡ªå®šä¹‰ç½‘ç»œä¸éš”ç¦»**ï¼š

```bash
# åˆ›å»ºéš”ç¦»çš„è‡ªå®šä¹‰ç½‘ç»œ
docker network create --driver bridge \
  --subnet=172.20.0.0/16 \
  --ip-range=172.20.240.0/20 \
  secure_network

# åœ¨éš”ç¦»ç½‘ç»œä¸­è¿è¡Œå®¹å™¨
docker run --network=secure_network \
  --name web_server nginx
```

### 2.4 Dockeré˜²ç«å¢™æœ€ä½³å®è·µ


> âš ï¸ **æ³¨æ„äº‹é¡¹**  
> Dockerä¼šè‡ªåŠ¨ä¿®æ”¹iptablesè§„åˆ™ï¼Œå¯èƒ½ä¼šç»•è¿‡ç³»ç»Ÿé˜²ç«å¢™è®¾ç½®ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„é…ç½®é¡ºåºã€‚

**ğŸ”¥ é¢è¯•é‡ç‚¹**ï¼š
- Dockerå¦‚ä½•ä¸iptablesäº¤äº’
- ä¸ºä»€ä¹ˆDockerå®¹å™¨å¯èƒ½ç»•è¿‡é˜²ç«å¢™
- å¦‚ä½•æ­£ç¡®é…ç½®Dockeré˜²ç«å¢™è§„åˆ™

**é˜²ç«å¢™è§„åˆ™ä¼˜å…ˆçº§**ï¼š
```
è§„åˆ™æ‰§è¡Œé¡ºåºï¼š
1. Dockerè‡ªåŠ¨è§„åˆ™ (DOCKERé“¾)
2. ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ (INPUT/FORWARDé“¾)  
3. é»˜è®¤ç­–ç•¥ (DROP/ACCEPT)

Dockerè§„åˆ™ä¼˜å…ˆçº§æœ€é«˜ï¼
```

---

## 3. ğŸ” å®¹å™¨é—´è®¿é—®æ§åˆ¶


### 3.1 å®¹å™¨é—´é€šä¿¡åŸç†


**ğŸŒ¿ è¿›é˜¶çº§ç†è§£**ï¼š
å®¹å™¨é—´é€šä¿¡å®é™…ä¸Šæ˜¯é€šè¿‡å®¿ä¸»æœºçš„ç½‘ç»œæ ˆè¿›è¡Œçš„ï¼Œæ‰€æœ‰æµé‡éƒ½ä¼šç»è¿‡docker0æ¡¥æ¥ç½‘ç»œã€‚

```
å®¹å™¨é—´é€šä¿¡æµç¨‹ï¼š
å®¹å™¨A (172.17.0.2) 
    â†“
veth1 â†’ docker0 â†’ veth2
    â†“
å®¹å™¨B (172.17.0.3)

æµé‡å¿…é¡»ç»è¿‡å®¿ä¸»æœºçš„ç½‘ç»œæ ˆå¤„ç†
```

### 3.2 é»˜è®¤é€šä¿¡ç­–ç•¥


**Dockeré»˜è®¤è¡Œä¸º**ï¼š
- åŒä¸€ç½‘ç»œå†…çš„å®¹å™¨å¯ä»¥äº’ç›¸è®¿é—®
- ä¸åŒç½‘ç»œçš„å®¹å™¨é»˜è®¤éš”ç¦»
- é€šè¿‡å®¹å™¨åç§°å¯ä»¥è¿›è¡ŒDNSè§£æ

```bash
# æŸ¥çœ‹å®¹å™¨ç½‘ç»œä¿¡æ¯
docker network ls
docker network inspect bridge

# æµ‹è¯•å®¹å™¨é—´è¿é€šæ€§
docker exec -it container_a ping container_b
```

### 3.3 å®ç°å®¹å™¨é—´è®¿é—®æ§åˆ¶


**æ–¹æ³•ä¸€ï¼šç½‘ç»œéš”ç¦»ç­–ç•¥**

```bash
# åˆ›å»ºä¸åŒçš„éš”ç¦»ç½‘ç»œ
docker network create frontend_net
docker network create backend_net
docker network create database_net

# å°†å®¹å™¨åˆ†é…åˆ°ä¸åŒç½‘ç»œ
docker run --network=frontend_net nginx
docker run --network=backend_net app_server
docker run --network=database_net mysql

# å…è®¸ç‰¹å®šè¿æ¥
docker network connect backend_net nginx  # å‰ç«¯å¯è®¿é—®åç«¯
docker network connect database_net app_server  # åç«¯å¯è®¿é—®æ•°æ®åº“
```

**æ–¹æ³•äºŒï¼šè‡ªå®šä¹‰iptablesè§„åˆ™**

```bash
# é˜»æ­¢ç‰¹å®šå®¹å™¨é—´é€šä¿¡
iptables -I DOCKER-USER -s 172.17.0.2 -d 172.17.0.3 -j DROP

# å…è®¸ç‰¹å®šç«¯å£é€šä¿¡
iptables -I DOCKER-USER -s 172.17.0.0/16 -d 172.17.0.3 \
  -p tcp --dport 3306 -j ACCEPT
```

### 3.4 å®¹å™¨è®¿é—®æ§åˆ¶å®æˆ˜æ¡ˆä¾‹


**ğŸ“± å®é™…åœºæ™¯**ï¼šWebåº”ç”¨ä¸‰å±‚æ¶æ„çš„å®‰å…¨éš”ç¦»

```
å®‰å…¨ç­–ç•¥è®¾è®¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯å®¹å™¨    â”‚â”€â”€â”€â†’â”‚  åç«¯å®¹å™¨    â”‚â”€â”€â”€â†’â”‚ æ•°æ®åº“å®¹å™¨   â”‚
â”‚ (nginx)    â”‚    â”‚ (app_server)â”‚    â”‚ (mysql)    â”‚
â”‚ ç«¯å£: 80   â”‚    â”‚ ç«¯å£: 8080  â”‚    â”‚ ç«¯å£: 3306  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘                  â†‘                  â†‘
   å¤–ç½‘è®¿é—®           å†…ç½‘è®¿é—®           å†…ç½‘è®¿é—®
```

**é…ç½®ç¤ºä¾‹**ï¼š

```bash
# 1. åˆ›å»ºä¸“ç”¨ç½‘ç»œ
docker network create --driver bridge \
  --subnet=10.0.0.0/16 app_network

# 2. å¯åŠ¨å„å±‚æœåŠ¡
docker run -d --name frontend \
  --network=app_network \
  -p 80:80 nginx

docker run -d --name backend \
  --network=app_network \
  app_server:latest

docker run -d --name database \
  --network=app_network \
  -e MYSQL_ROOT_PASSWORD=secret \
  mysql:8.0

# 3. é…ç½®è®¿é—®æ§åˆ¶è§„åˆ™
# åªå…è®¸å‰ç«¯è®¿é—®åç«¯çš„8080ç«¯å£
iptables -A DOCKER-USER -s frontend_ip -d backend_ip \
  -p tcp --dport 8080 -j ACCEPT

# åªå…è®¸åç«¯è®¿é—®æ•°æ®åº“çš„3306ç«¯å£  
iptables -A DOCKER-USER -s backend_ip -d database_ip \
  -p tcp --dport 3306 -j ACCEPT

# æ‹’ç»å…¶ä»–æ‰€æœ‰è®¿é—®
iptables -A DOCKER-USER -j DROP
```

---

## 4. â˜¸ï¸ Kubernetesç½‘ç»œç­–ç•¥


### 4.1 Kubernetesç½‘ç»œæ¨¡å‹


> ğŸ“Œ **æ ¸å¿ƒæ¦‚å¿µ**  
> Kubernetesé‡‡ç”¨"æ‰å¹³ç½‘ç»œ"æ¨¡å‹ï¼Œé»˜è®¤æƒ…å†µä¸‹é›†ç¾¤å†…æ‰€æœ‰Podéƒ½å¯ä»¥äº’ç›¸é€šä¿¡ï¼Œéœ€è¦é€šè¿‡NetworkPolicyæ¥å®ç°è®¿é—®æ§åˆ¶ã€‚

```
K8sç½‘ç»œé€šä¿¡åŸç†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Kubernetesé›†ç¾¤            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Node1: Pod-A (10.1.1.2)            â”‚
â”‚ Node2: Pod-B (10.1.2.3)            â”‚  
â”‚ Node3: Pod-C (10.1.3.4)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é»˜è®¤ï¼šä»»æ„Podå¯è®¿é—®ä»»æ„Pod           â”‚
â”‚ NetworkPolicyï¼šå®šä¹‰è®¿é—®é™åˆ¶è§„åˆ™      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 NetworkPolicyåŸºæœ¬è¯­æ³•


**NetworkPolicyçš„å·¥ä½œåŸç†**ï¼š
- åŸºäºæ ‡ç­¾é€‰æ‹©å™¨(Label Selector)é€‰æ‹©è¦ä¿æŠ¤çš„Pod
- å®šä¹‰å…è®¸çš„å…¥ç«™(Ingress)å’Œå‡ºç«™(Egress)æµé‡è§„åˆ™
- é»˜è®¤æ‹’ç»ç­–ç•¥ï¼šæœªæ˜ç¡®å…è®¸çš„æµé‡éƒ½è¢«æ‹’ç»

**åŸºç¡€NetworkPolicyç¤ºä¾‹**ï¼š

```yaml
# åŸºç¡€è®¿é—®æ§åˆ¶ç­–ç•¥
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all-ingress
  namespace: production
spec:
  # é€‰æ‹©è¦ä¿æŠ¤çš„Pod
  podSelector:
    matchLabels:
      app: web-server
  
  # ç­–ç•¥ç±»å‹  
  policyTypes:
  - Ingress
  - Egress
  
  # å…è®¸çš„å…¥ç«™æµé‡è§„åˆ™
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    - namespaceSelector:
        matchLabels:
          name: staging
    ports:
    - protocol: TCP
      port: 8080
  
  # å…è®¸çš„å‡ºç«™æµé‡è§„åˆ™
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: database
    ports:
    - protocol: TCP
      port: 3306
```

### 4.3 å¸¸ç”¨NetworkPolicyæ¨¡å¼


**ğŸŒ± å…¥é—¨çº§**ï¼šåŸºç¡€éš”ç¦»ç­–ç•¥

```yaml
# 1. æ‹’ç»æ‰€æœ‰å…¥ç«™æµé‡
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
spec:
  podSelector: {}  # ç©ºé€‰æ‹©å™¨ = é€‰æ‹©æ‰€æœ‰Pod
  policyTypes:
  - Ingress
```

**ğŸŒ¿ è¿›é˜¶çº§**ï¼šå¾®æœåŠ¡è®¿é—®æ§åˆ¶

```yaml
# 2. åªå…è®¸ç‰¹å®šæœåŠ¡è®¿é—®
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-server-netpol
spec:
  podSelector:
    matchLabels:
      app: api-server
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # åªå…è®¸å‰ç«¯æœåŠ¡è®¿é—®
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 8080
  egress:
  # åªå…è®¸è®¿é—®æ•°æ®åº“
  - to:
    - podSelector:
        matchLabels:
          app: mysql
    ports:
    - protocol: TCP
      port: 3306
  # å…è®¸DNSæŸ¥è¯¢
  - to: []
    ports:
    - protocol: UDP
      port: 53
```

### 4.4 NetworkPolicyå®æˆ˜åº”ç”¨


**ğŸ“± å®é™…åœºæ™¯**ï¼šç”µå•†ç³»ç»Ÿçš„å¾®æœåŠ¡å®‰å…¨éš”ç¦»

```
ç³»ç»Ÿæ¶æ„ï¼š
ç”¨æˆ· â†’ ç½‘å…³ â†’ å‰ç«¯æœåŠ¡ â†’ APIæœåŠ¡ â†’ æ•°æ®åº“
            â†“      â†“
          ç¼“å­˜   æ¶ˆæ¯é˜Ÿåˆ—

å®‰å…¨éœ€æ±‚ï¼š
- ç½‘å…³åªèƒ½è®¿é—®å‰ç«¯æœåŠ¡
- å‰ç«¯åªèƒ½è®¿é—®APIå’Œç¼“å­˜  
- APIåªèƒ½è®¿é—®æ•°æ®åº“å’Œæ¶ˆæ¯é˜Ÿåˆ—
- æ•°æ®åº“ä¸æ¥å—ç›´æ¥å¤–éƒ¨è®¿é—®
```

**å®Œæ•´é…ç½®ç¤ºä¾‹**ï¼š

```yaml
# å‰ç«¯æœåŠ¡ç½‘ç»œç­–ç•¥
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-netpol
  namespace: ecommerce
spec:
  podSelector:
    matchLabels:
      tier: frontend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # åªå…è®¸ç½‘å…³è®¿é—®
  - from:
    - podSelector:
        matchLabels:
          tier: gateway
    ports:
    - protocol: TCP
      port: 3000
  egress:
  # åªå…è®¸è®¿é—®APIå’Œç¼“å­˜
  - to:
    - podSelector:
        matchLabels:
          tier: api
    ports:
    - protocol: TCP
      port: 8080
  - to:
    - podSelector:
        matchLabels:
          tier: cache
    ports:
    - protocol: TCP
      port: 6379

# APIæœåŠ¡ç½‘ç»œç­–ç•¥
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy  
metadata:
  name: api-netpol
  namespace: ecommerce
spec:
  podSelector:
    matchLabels:
      tier: api
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # åªå…è®¸å‰ç«¯è®¿é—®
  - from:
    - podSelector:
        matchLabels:
          tier: frontend
    ports:
    - protocol: TCP
      port: 8080
  egress:
  # åªå…è®¸è®¿é—®æ•°æ®åº“å’Œæ¶ˆæ¯é˜Ÿåˆ—
  - to:
    - podSelector:
        matchLabels:
          tier: database
    ports:
    - protocol: TCP
      port: 3306
  - to:
    - podSelector:
        matchLabels:
          tier: mq
    ports:
    - protocol: TCP
      port: 5672
```

**éªŒè¯NetworkPolicyæ•ˆæœ**ï¼š

```bash
# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
kubectl exec -it frontend-pod -- curl api-service:8080  # åº”è¯¥æˆåŠŸ
kubectl exec -it frontend-pod -- curl database:3306     # åº”è¯¥å¤±è´¥

# æŸ¥çœ‹NetworkPolicyçŠ¶æ€
kubectl get networkpolicy -n ecommerce
kubectl describe networkpolicy frontend-netpol -n ecommerce
```

---

## 5. ğŸ”Œ å®¹å™¨ç«¯å£æš´éœ²ç®¡ç†


### 5.1 ç«¯å£æš´éœ²çš„å®‰å…¨é£é™©


> âš ï¸ **æ³¨æ„äº‹é¡¹**  
> å®¹å™¨ç«¯å£æš´éœ²æ˜¯æœ€å¸¸è§çš„å®‰å…¨é£é™©ç‚¹ï¼Œä¸€æ—¦é…ç½®ä¸å½“å¯èƒ½å¯¼è‡´å†…éƒ¨æœåŠ¡ç›´æ¥æš´éœ²åœ¨å…¬ç½‘ä¸Šã€‚

**å¸¸è§ç«¯å£æš´éœ²é—®é¢˜**ï¼š

```
å±é™©é…ç½®ç¤ºä¾‹ï¼š
# âŒ é”™è¯¯ï¼šæš´éœ²æ•°æ®åº“åˆ°å…¬ç½‘
docker run -p 3306:3306 mysql

# âŒ é”™è¯¯ï¼šæš´éœ²ç®¡ç†æ¥å£åˆ°æ‰€æœ‰ç½‘ç»œ  
docker run -p 0.0.0.0:8080:8080 admin_panel

# âŒ é”™è¯¯ï¼šä½¿ç”¨é»˜è®¤å¯†ç æš´éœ²æœåŠ¡
docker run -p 6379:6379 redis
```

**å®‰å…¨å½±å“åˆ†æ**ï¼š
- **æ•°æ®æ³„éœ²**ï¼šæ•°æ®åº“ç›´æ¥æš´éœ²å¯èƒ½å¯¼è‡´æ•°æ®è¢«çªƒå–
- **æœåŠ¡åŠ«æŒ**ï¼šç®¡ç†æ¥å£è¢«æ¶æ„è®¿é—®ï¼ŒæœåŠ¡è¢«æ§åˆ¶
- **æ¨ªå‘æ¸—é€**ï¼šä¸€ä¸ªæœåŠ¡è¢«æ”»ç ´ï¼Œå½±å“å…¶ä»–æœåŠ¡

### 5.2 ç«¯å£æš´éœ²å®‰å…¨ç­–ç•¥


**ğŸ”’ æœ€ä½³å®è·µåŸåˆ™**ï¼š
1. **æœ€å°æš´éœ²åŸåˆ™**ï¼šåªæš´éœ²å¿…é¡»çš„ç«¯å£
2. **ç½‘ç»œéš”ç¦»åŸåˆ™**ï¼šä½¿ç”¨å†…ç½‘IPé™åˆ¶è®¿é—®èŒƒå›´  
3. **è®¤è¯æˆæƒåŸåˆ™**ï¼šæš´éœ²çš„æœåŠ¡å¿…é¡»æœ‰è®¿é—®æ§åˆ¶
4. **ç›‘æ§å®¡è®¡åŸåˆ™**ï¼šè®°å½•æ‰€æœ‰ç«¯å£è®¿é—®æ—¥å¿—

**å®‰å…¨ç«¯å£æš´éœ²é…ç½®**ï¼š

```bash
# âœ… æ­£ç¡®ï¼šåªæš´éœ²ç»™æœ¬æœº
docker run -p 127.0.0.1:3306:3306 mysql

# âœ… æ­£ç¡®ï¼šæš´éœ²ç»™ç‰¹å®šå†…ç½‘
docker run -p 192.168.1.10:8080:8080 web_app

# âœ… æ­£ç¡®ï¼šé€šè¿‡åå‘ä»£ç†æš´éœ²
docker run --network=app_network \
  --name backend_service app:latest

# é€šè¿‡nginxåå‘ä»£ç†å¯¹å¤–æä¾›æœåŠ¡
docker run -p 80:80 --network=app_network nginx
```

### 5.3 åŠ¨æ€ç«¯å£ç®¡ç†


**ç«¯å£æ˜ å°„ç®¡ç†å·¥å…·**ï¼š

```bash
# æŸ¥çœ‹å®¹å™¨ç«¯å£æ˜ å°„
docker port container_name

# åŠ¨æ€æ·»åŠ ç«¯å£æ˜ å°„ (éœ€é‡å¯å®¹å™¨)
docker commit container_name new_image
docker run -p 9090:9090 new_image

# ä½¿ç”¨docker-composeç®¡ç†ç«¯å£
```

**docker-composeç«¯å£ç®¡ç†**ï¼š

```yaml
version: '3.8'
services:
  web:
    image: nginx
    ports:
      - "127.0.0.1:8080:80"  # åªæš´éœ²ç»™æœ¬æœº
    networks:
      - frontend
      
  api:
    image: api_server
    expose:
      - "8080"  # åªåœ¨å®¹å™¨ç½‘ç»œå†…æš´éœ²
    networks:
      - frontend
      - backend
      
  database:
    image: mysql
    # ä¸æš´éœ²ç«¯å£ï¼Œåªå…è®¸å†…ç½‘è®¿é—®
    environment:
      MYSQL_ROOT_PASSWORD: secure_password
    networks:
      - backend

networks:
  frontend:
  backend:
```

### 5.4 ç«¯å£å®‰å…¨ç›‘æ§


**ç«¯å£ä½¿ç”¨ç›‘æ§è„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ£€æŸ¥å®¹å™¨ç«¯å£æš´éœ²æƒ…å†µ

echo "=== æ£€æŸ¥å±é™©ç«¯å£æš´éœ² ==="
docker ps --format "table {{.Names}}\t{{.Ports}}" | grep "0.0.0.0"

echo -e "\n=== æ£€æŸ¥æ•°æ®åº“ç«¯å£æš´éœ² ==="  
docker ps --format "table {{.Names}}\t{{.Ports}}" | grep -E "3306|5432|6379|27017"

echo -e "\n=== å»ºè®® ==="
echo "å‘ç°æš´éœ²çš„æ•°æ®åº“ç«¯å£ï¼Œå»ºè®®ï¼š"
echo "1. é™åˆ¶ç›‘å¬IPä¸º127.0.0.1æˆ–å†…ç½‘IP"
echo "2. ä½¿ç”¨ç½‘ç»œéš”ç¦»ä»£æ›¿ç«¯å£æš´éœ²"
echo "3. æ·»åŠ è®¿é—®è®¤è¯å’Œé˜²ç«å¢™è§„åˆ™"
```

---

## 6. ğŸ—ï¸ å¾®æœåŠ¡å®‰å…¨éš”ç¦»


### 6.1 å¾®æœåŠ¡å®‰å…¨æ¶æ„è®¾è®¡


> ğŸ“Œ **æ ¸å¿ƒæ¦‚å¿µ**  
> å¾®æœåŠ¡å®‰å…¨éš”ç¦»é‡‡ç”¨"é›¶ä¿¡ä»»"æ¶æ„ï¼Œå‡è®¾ç½‘ç»œæœ¬èº«æ˜¯ä¸å®‰å…¨çš„ï¼Œæ¯ä¸ªæœåŠ¡ä¹‹é—´çš„é€šä¿¡éƒ½éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒã€‚

**å¾®æœåŠ¡å®‰å…¨å±‚æ¬¡**ï¼š

```
å¾®æœåŠ¡å®‰å…¨é˜²æŠ¤ä½“ç³»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        APIç½‘å…³å±‚ (è®¤è¯/æˆæƒ)         â”‚ â† ç»Ÿä¸€å…¥å£æ§åˆ¶
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     æœåŠ¡ç½‘æ ¼å±‚ (æµé‡åŠ å¯†/ç­–ç•¥)       â”‚ â† æœåŠ¡é—´é€šä¿¡æ§åˆ¶  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      å®¹å™¨å±‚ (ç½‘ç»œéš”ç¦»/èµ„æºé™åˆ¶)      â”‚ â† è¿è¡Œæ—¶ç¯å¢ƒéš”ç¦»
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       åŸºç¡€è®¾æ–½å±‚ (é˜²ç«å¢™/ç›‘æ§)       â”‚ â† åº•å±‚ç½‘ç»œé˜²æŠ¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 æœåŠ¡ç½‘æ ¼å®‰å…¨ç­–ç•¥


**Istioç½‘ç»œå®‰å…¨é…ç½®**ï¼š

```yaml
# æœåŠ¡é—´é€šä¿¡å®‰å…¨ç­–ç•¥
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: production
spec:
  # è¦æ±‚æ‰€æœ‰æœåŠ¡é—´é€šä¿¡ä½¿ç”¨mTLS
  mtls:
    mode: STRICT

---
# æœåŠ¡è®¿é—®æˆæƒç­–ç•¥  
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: api-access-control
  namespace: production
spec:
  # ä¿æŠ¤APIæœåŠ¡
  selector:
    matchLabels:
      app: api-server
  rules:
  # åªå…è®¸å‰ç«¯æœåŠ¡è®¿é—®
  - from:
    - source:
        principals: ["cluster.local/ns/production/sa/frontend"]
    to:
    - operation:
        methods: ["GET", "POST"]
        paths: ["/api/*"]
  # å…è®¸å¥åº·æ£€æŸ¥
  - from: []
    to:
    - operation:
        methods: ["GET"]
        paths: ["/health"]
```

### 6.3 å¾®æœåŠ¡ç½‘ç»œéš”ç¦»å®è·µ


**ğŸŒ¿ è¿›é˜¶çº§ç†è§£**ï¼šå¾®æœåŠ¡ç½‘ç»œéš”ç¦»éœ€è¦åœ¨å¤šä¸ªå±‚é¢å®ç°

**ç½‘ç»œåˆ†æ®µç­–ç•¥**ï¼š

```
ç¯å¢ƒéš”ç¦»ï¼š
ç”Ÿäº§ç½‘ç»œæ®µ: 10.1.0.0/16
æµ‹è¯•ç½‘ç»œæ®µ: 10.2.0.0/16  
å¼€å‘ç½‘ç»œæ®µ: 10.3.0.0/16

æœåŠ¡å±‚éš”ç¦»ï¼š
å‰ç«¯æœåŠ¡: 10.1.1.0/24
APIæœåŠ¡:  10.1.2.0/24
æ•°æ®æœåŠ¡: 10.1.3.0/24
åŸºç¡€æœåŠ¡: 10.1.4.0/24 (ç›‘æ§ã€æ—¥å¿—ç­‰)
```

**Kuberneteså‘½åç©ºé—´éš”ç¦»**ï¼š

```yaml
# åˆ›å»ºéš”ç¦»çš„å‘½åç©ºé—´
---
apiVersion: v1
kind: Namespace
metadata:
  name: frontend
  labels:
    security-level: "public"
---
apiVersion: v1  
kind: Namespace
metadata:
  name: backend
  labels:
    security-level: "internal"
---
apiVersion: v1
kind: Namespace  
metadata:
  name: database
  labels:
    security-level: "restricted"

---
# å‘½åç©ºé—´é—´ç½‘ç»œç­–ç•¥
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: namespace-isolation
  namespace: database
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  # åªå…è®¸backendå‘½åç©ºé—´è®¿é—®
  - from:
    - namespaceSelector:
        matchLabels:
          security-level: "internal"
```

### 6.4 å¾®æœåŠ¡å®‰å…¨é€šä¿¡


**æœåŠ¡é—´è®¤è¯æœºåˆ¶**ï¼š

```bash
# 1. ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºç‹¬ç«‹çš„Service Account
kubectl create serviceaccount frontend-sa -n frontend
kubectl create serviceaccount api-sa -n backend  
kubectl create serviceaccount db-sa -n database

# 2. é…ç½®RBACæƒé™
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: backend
  name: api-access
rules:
- apiGroups: [""]
  resources: ["services", "endpoints"]
  verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: api-access-binding
  namespace: backend
subjects:
- kind: ServiceAccount
  name: frontend-sa
  namespace: frontend
roleRef:
  kind: Role
  name: api-access
  apiGroup: rbac.authorization.k8s.io
```

**APIå¯†é’¥ç®¡ç†**ï¼š

```yaml
# ä½¿ç”¨Secretå­˜å‚¨APIå¯†é’¥
apiVersion: v1
kind: Secret
metadata:
  name: api-keys
  namespace: backend
type: Opaque
data:
  frontend-api-key: <base64_encoded_key>
  monitoring-api-key: <base64_encoded_key>

---
# åœ¨å®¹å™¨ä¸­ä½¿ç”¨Secret
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-server
spec:
  template:
    spec:
      containers:
      - name: api
        image: api-server:latest
        env:
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: api-keys
              key: frontend-api-key
        # é™åˆ¶å®¹å™¨æƒé™
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
```

---

## 7. ğŸ“Š å®¹å™¨ç½‘ç»œç›‘æ§


### 7.1 å®¹å™¨ç½‘ç»œç›‘æ§ä½“ç³»


> ğŸ’¡ **å®ç”¨æŠ€å·§**  
> å®¹å™¨ç½‘ç»œç›‘æ§éœ€è¦ä»å¤šä¸ªç»´åº¦æ”¶é›†æ•°æ®ï¼šæµé‡ç»Ÿè®¡ã€è¿æ¥çŠ¶æ€ã€å®‰å…¨äº‹ä»¶ã€æ€§èƒ½æŒ‡æ ‡ã€‚

**ç›‘æ§æ¶æ„è®¾è®¡**ï¼š

```
ç›‘æ§æ•°æ®æµå‘ï¼š
å®¹å™¨ç½‘ç»œæ¥å£ â†’ ç›‘æ§Agent â†’ æ•°æ®é‡‡é›† â†’ å­˜å‚¨åˆ†æ â†’ å‘Šè­¦é€šçŸ¥
      â†“              â†“         â†“         â†“         â†“
   æµé‡ç»Ÿè®¡      Prometheus   InfluxDB   Grafana   å‘Šè­¦ç³»ç»Ÿ
   è¿æ¥æ—¥å¿—      Fluentd     ElasticSearch Kibana  é‚®ä»¶/çŸ­ä¿¡
   å®‰å…¨äº‹ä»¶      ç›‘æ§è„šæœ¬     æ—¥å¿—æ–‡ä»¶    åˆ†æè„šæœ¬   Webhook
```

### 7.2 Dockerç½‘ç»œç›‘æ§


**åŸºç¡€ç›‘æ§å‘½ä»¤**ï¼š

```bash
# æŸ¥çœ‹å®¹å™¨ç½‘ç»œç»Ÿè®¡
docker stats --no-stream

# æŸ¥çœ‹å®¹å™¨ç½‘ç»œé…ç½®
docker inspect container_name | grep -A 10 "NetworkMode"

# ç›‘æ§å®¹å™¨ç½‘ç»œæµé‡
docker exec container_name cat /proc/net/dev

# æŸ¥çœ‹å®¹å™¨ç«¯å£ç›‘å¬æƒ…å†µ
docker exec container_name netstat -tlnp
```

**ç½‘ç»œæµé‡ç›‘æ§è„šæœ¬**ï¼š

```bash
#!/bin/bash
# å®¹å™¨ç½‘ç»œæµé‡ç›‘æ§è„šæœ¬

CONTAINER_NAME=$1
INTERVAL=${2:-5}

if [ -z "$CONTAINER_NAME" ]; then
    echo "ç”¨æ³•: $0 <å®¹å™¨åç§°> [ç›‘æ§é—´éš”]"
    exit 1
fi

echo "å¼€å§‹ç›‘æ§å®¹å™¨ $CONTAINER_NAME çš„ç½‘ç»œæµé‡..."
echo "æ—¶é—´                    æ¥æ”¶å­—èŠ‚    å‘é€å­—èŠ‚    æ¥æ”¶åŒ…æ•°    å‘é€åŒ…æ•°"

while true; do
    stats=$(docker exec $CONTAINER_NAME cat /proc/net/dev 2>/dev/null | grep eth0 | awk '{print $2, $10, $3, $11}')
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "$timestamp    $stats"
    sleep $INTERVAL
done
```

### 7.3 Kubernetesç½‘ç»œç›‘æ§


**Podç½‘ç»œç›‘æ§é…ç½®**ï¼š

```yaml
# ä½¿ç”¨sidecarå®¹å™¨ç›‘æ§ç½‘ç»œ
apiVersion: apps/v1
kind: Deployment
metadata:
  name: monitored-app
spec:
  template:
    spec:
      containers:
      # ä¸»åº”ç”¨å®¹å™¨
      - name: app
        image: my-app:latest
        ports:
        - containerPort: 8080
      
      # ç½‘ç»œç›‘æ§sidecar
      - name: network-monitor
        image: network-monitor:latest
        command: ["/monitor.sh"]
        volumeMounts:
        - name: proc
          mountPath: /host/proc
          readOnly: true
        - name: logs
          mountPath: /var/log
        securityContext:
          privileged: true
      
      volumes:
      - name: proc
        hostPath:
          path: /proc
      - name: logs
        emptyDir: {}
```

**Prometheusç½‘ç»œæŒ‡æ ‡æ”¶é›†**ï¼š

```yaml
# ServiceMonitoré…ç½®
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: network-metrics
spec:
  selector:
    matchLabels:
      app: network-monitor
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics

---
# ç½‘ç»œå‘Šè­¦è§„åˆ™
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: network-alerts
spec:
  groups:
  - name: container.network
    rules:
    # ç½‘ç»œæµé‡å¼‚å¸¸å‘Šè­¦
    - alert: HighNetworkTraffic
      expr: rate(container_network_receive_bytes_total[5m]) > 100*1024*1024
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "å®¹å™¨ç½‘ç»œæµé‡è¿‡é«˜"
        description: "å®¹å™¨ {{ $labels.name }} ç½‘ç»œæ¥æ”¶æµé‡è¶…è¿‡100MB/s"
    
    # ç½‘ç»œè¿æ¥æ•°è¿‡å¤šå‘Šè­¦  
    - alert: TooManyConnections
      expr: container_network_tcp_connections > 1000
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "å®¹å™¨ç½‘ç»œè¿æ¥æ•°è¿‡å¤š"
        description: "å®¹å™¨ {{ $labels.name }} TCPè¿æ¥æ•°è¶…è¿‡1000"
```

### 7.4 å®‰å…¨äº‹ä»¶ç›‘æ§


**ç½‘ç»œå®‰å…¨æ—¥å¿—æ”¶é›†**ï¼š

```bash
# ç›‘æ§å¼‚å¸¸ç½‘ç»œè¿æ¥
#!/bin/bash

# ç›‘æ§æœªæˆæƒçš„ç«¯å£è®¿é—®
iptables -I INPUT -j LOG --log-prefix "FIREWALL_DENY: "

# ç›‘æ§å®¹å™¨å¼‚å¸¸ç½‘ç»œè¡Œä¸º
docker events --filter event=connect --format "{{.Time}} {{.Actor.Attributes.name}} {{.Action}}"

# æ£€æµ‹ç«¯å£æ‰«æè¡Œä¸º
tcpdump -i docker0 -n 'tcp[tcpflags] & tcp-syn != 0 and tcp[tcpflags] & tcp-ack = 0' | \
while read line; do
    echo "$(date): æ£€æµ‹åˆ°ç«¯å£æ‰«æ: $line" >> /var/log/port_scan.log
done
```

---

## 8. âœ… å®¹å™¨å®‰å…¨åˆè§„æ£€æŸ¥


### 8.1 å®‰å…¨åˆè§„æ¡†æ¶


> ğŸ“Œ **æ ¸å¿ƒæ¦‚å¿µ**  
> å®¹å™¨å®‰å…¨åˆè§„æ˜¯æŒ‡æŒ‰ç…§è¡Œä¸šæ ‡å‡†å’Œæœ€ä½³å®è·µï¼Œç¡®ä¿å®¹å™¨ç¯å¢ƒçš„é…ç½®å’Œè¿è¡Œç¬¦åˆå®‰å…¨è¦æ±‚ã€‚

**ä¸»è¦åˆè§„æ ‡å‡†**ï¼š
- **CIS Benchmark**ï¼šäº’è”ç½‘å®‰å…¨ä¸­å¿ƒåŸºå‡†
- **NISTæ¡†æ¶**ï¼šç¾å›½å›½å®¶æ ‡å‡†æŠ€æœ¯ç ”ç©¶æ‰€
- **PCI DSS**ï¼šæ”¯ä»˜å¡è¡Œä¸šæ•°æ®å®‰å…¨æ ‡å‡†
- **GDPR**ï¼šæ¬§ç›Ÿé€šç”¨æ•°æ®ä¿æŠ¤æ¡ä¾‹

### 8.2 Dockerå®‰å…¨åˆè§„æ£€æŸ¥


**CIS Docker Benchmarkæ£€æŸ¥é¡¹**ï¼š

```bash
# 1. æ£€æŸ¥Dockerç‰ˆæœ¬æ˜¯å¦ä¸ºæœ€æ–°
docker version

# 2. æ£€æŸ¥Dockerå®ˆæŠ¤è¿›ç¨‹é…ç½®
ps -ef | grep dockerd

# 3. æ£€æŸ¥Dockerç›®å½•æƒé™
ls -la /var/lib/docker
ls -la /etc/docker

# 4. æ£€æŸ¥å®¹å™¨è¿è¡Œç”¨æˆ·
docker ps -q | xargs docker inspect --format '{{ .Id }}: User={{ .Config.User }}'

# 5. æ£€æŸ¥å®¹å™¨ç‰¹æƒæ¨¡å¼
docker ps -q | xargs docker inspect --format '{{ .Id }}: Privileged={{ .HostConfig.Privileged }}'
```

**è‡ªåŠ¨åŒ–åˆè§„æ£€æŸ¥è„šæœ¬**ï¼š

```bash
#!/bin/bash
# Dockerå®‰å…¨åˆè§„æ£€æŸ¥è„šæœ¬

echo "=== Dockerå®‰å…¨åˆè§„æ£€æŸ¥æŠ¥å‘Š ==="
echo "æ£€æŸ¥æ—¶é—´: $(date)"
echo ""

# 1. æ£€æŸ¥å±é™©é…ç½®
echo "1. æ£€æŸ¥ç‰¹æƒå®¹å™¨ï¼š"
privileged_containers=$(docker ps -q | xargs docker inspect --format '{{ .Id }}: {{ .HostConfig.Privileged }}' | grep true)
if [ -n "$privileged_containers" ]; then
    echo "âš ï¸  å‘ç°ç‰¹æƒå®¹å™¨ï¼š"
    echo "$privileged_containers"
else
    echo "âœ… æœªå‘ç°ç‰¹æƒå®¹å™¨"
fi

# 2. æ£€æŸ¥ç½‘ç»œæ¨¡å¼
echo -e "\n2. æ£€æŸ¥ç½‘ç»œæ¨¡å¼ï¼š"
host_network=$(docker ps -q | xargs docker inspect --format '{{ .Id }}: {{ .HostConfig.NetworkMode }}' | grep host)
if [ -n "$host_network" ]; then
    echo "âš ï¸  å‘ç°ä½¿ç”¨hostç½‘ç»œçš„å®¹å™¨ï¼š"
    echo "$host_network"
else
    echo "âœ… æœªå‘ç°ä½¿ç”¨hostç½‘ç»œçš„å®¹å™¨"
fi

# 3. æ£€æŸ¥ç«¯å£æš´éœ²
echo -e "\n3. æ£€æŸ¥ç«¯å£æš´éœ²ï¼š"
exposed_ports=$(docker ps --format "table {{.Names}}\t{{.Ports}}" | grep "0.0.0.0")
if [ -n "$exposed_ports" ]; then
    echo "âš ï¸  å‘ç°æš´éœ²åˆ°å…¬ç½‘çš„ç«¯å£ï¼š"
    echo "$exposed_ports"
else
    echo "âœ… æœªå‘ç°æš´éœ²åˆ°å…¬ç½‘çš„å±é™©ç«¯å£"
fi

# 4. æ£€æŸ¥é•œåƒå®‰å…¨
echo -e "\n4. æ£€æŸ¥é•œåƒæ¥æºï¼š"
unsigned_images=$(docker images --format "table {{.Repository}}\t{{.Tag}}" | grep -v "REPOSITORY")
echo "å½“å‰ä½¿ç”¨çš„é•œåƒï¼š" 
echo "$unsigned_images"
echo "å»ºè®®: ä½¿ç”¨æ¥è‡ªå¯ä¿¡ä»“åº“çš„ç­¾åé•œåƒ"

echo -e "\n=== æ£€æŸ¥å®Œæˆ ==="
```

### 8.3 Kuberneteså®‰å…¨åˆè§„


**Podå®‰å…¨ç­–ç•¥æ£€æŸ¥**ï¼š

```yaml
# Podå®‰å…¨ç­–ç•¥ç¤ºä¾‹
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
spec:
  # ç¦æ­¢ç‰¹æƒæ¨¡å¼
  privileged: false
  
  # é™åˆ¶capabilities
  allowedCapabilities: []
  requiredDropCapabilities:
    - ALL
    
  # é™åˆ¶å·ç±»å‹
  allowedVolumeTypes:
    - configMap
    - secret
    - emptyDir
    - persistentVolumeClaim
    
  # ç¦æ­¢ä¸»æœºç½‘ç»œ
  hostNetwork: false
  hostIPC: false
  hostPID: false
  
  # é™åˆ¶ç”¨æˆ·ID
  runAsUser:
    rule: MustRunAsNonRoot
  
  # é™åˆ¶æ–‡ä»¶ç³»ç»Ÿæƒé™
  readOnlyRootFilesystem: true
  
  # ç¦æ­¢ç‰¹æƒå‡çº§
  allowPrivilegeEscalation: false
```

**å®‰å…¨åˆè§„æ£€æŸ¥å·¥å…·ä½¿ç”¨**ï¼š

```bash
# ä½¿ç”¨kube-benchæ£€æŸ¥K8sé…ç½®
kubectl apply -f https://raw.githubusercontent.com/aquasecurity/kube-bench/main/job.yaml

# ä½¿ç”¨Falcoç›‘æ§è¿è¡Œæ—¶å®‰å…¨
kubectl apply -f https://raw.githubusercontent.com/falcosecurity/falco/master/examples/k8s-with-rbac/falco-account.yaml

# ä½¿ç”¨Trivyæ‰«æé•œåƒæ¼æ´
trivy image nginx:latest

# ä½¿ç”¨kube-scoreè¯„ä¼°é…ç½®è´¨é‡
kube-score score my-deployment.yaml
```

### 8.4 åˆè§„ç›‘æ§ä¸æŠ¥å‘Š


**å®šæœŸåˆè§„æ£€æŸ¥**ï¼š

```yaml
# å®šæ—¶åˆè§„æ£€æŸ¥Job
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: security-compliance-check
spec:
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: compliance-checker
            image: security-tools:latest
            command:
            - /bin/bash
            - -c
            - |
              echo "å¼€å§‹å®‰å…¨åˆè§„æ£€æŸ¥..."
              
              # æ£€æŸ¥ç½‘ç»œç­–ç•¥è¦†ç›–ç‡
              kubectl get networkpolicy --all-namespaces
              
              # æ£€æŸ¥Podå®‰å…¨é…ç½®
              kubectl get pods --all-namespaces -o jsonpath='{.items[*].spec.securityContext}'
              
              # æ£€æŸ¥æœåŠ¡æš´éœ²æƒ…å†µ
              kubectl get services --all-namespaces -o wide
              
              # ç”Ÿæˆåˆè§„æŠ¥å‘Š
              /generate-report.sh > /tmp/compliance-report.json
              
              # å‘é€æŠ¥å‘Šåˆ°ç›‘æ§ç³»ç»Ÿ
              curl -X POST -H "Content-Type: application/json" \
                -d @/tmp/compliance-report.json \
                http://monitoring-api:8080/compliance-report
                
          restartPolicy: OnFailure
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å®¹å™¨ç½‘ç»œé˜²ç«å¢™ï¼šåŸºäºç½‘ç»œå‘½åç©ºé—´çš„éš”ç¦»æœºåˆ¶
ğŸ”¸ Dockeré˜²ç«å¢™ï¼šé€šè¿‡iptablesè§„åˆ™æ§åˆ¶å®¹å™¨ç½‘ç»œè®¿é—®
ğŸ”¸ å®¹å™¨é—´è®¿é—®æ§åˆ¶ï¼šä½¿ç”¨ç½‘ç»œç­–ç•¥é™åˆ¶å®¹å™¨é€šä¿¡
ğŸ”¸ K8s NetworkPolicyï¼šåŸºäºæ ‡ç­¾é€‰æ‹©å™¨çš„ç½‘ç»œè®¿é—®æ§åˆ¶
ğŸ”¸ ç«¯å£æš´éœ²ç®¡ç†ï¼šæœ€å°åŒ–ç«¯å£æš´éœ²ï¼Œé¿å…å®‰å…¨é£é™©
ğŸ”¸ å¾®æœåŠ¡éš”ç¦»ï¼šå¤šå±‚æ¬¡çš„æœåŠ¡é—´å®‰å…¨éš”ç¦»ç­–ç•¥
ğŸ”¸ ç½‘ç»œç›‘æ§ï¼šå®æ—¶ç›‘æ§å®¹å™¨ç½‘ç»œçŠ¶æ€å’Œå®‰å…¨äº‹ä»¶
ğŸ”¸ åˆè§„æ£€æŸ¥ï¼šæŒ‰ç…§å®‰å…¨æ ‡å‡†è¿›è¡Œé…ç½®å’Œè¿è¡Œæ£€æŸ¥
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å®¹å™¨ç½‘ç»œå®‰å…¨çš„ç‰¹ç‚¹**
```
ä¸ä¼ ç»Ÿç½‘ç»œå®‰å…¨çš„åŒºåˆ«ï¼š
- ç½‘ç»œæ‹“æ‰‘æ›´å¤æ‚ï¼šå®¹å™¨ã€Podã€æœåŠ¡å¤šå±‚æŠ½è±¡
- å˜åŒ–æ›´é¢‘ç¹ï¼šå®¹å™¨çš„åŠ¨æ€åˆ›å»ºå’Œé”€æ¯
- éš”ç¦»æ›´ç²¾ç»†ï¼šéœ€è¦æœåŠ¡çº§åˆ«çš„è®¿é—®æ§åˆ¶
- ç›‘æ§æ›´å›°éš¾ï¼šéœ€è¦å®¹å™¨æ„ŸçŸ¥çš„ç›‘æ§å·¥å…·
```

**ğŸ”¹ é˜²ç«å¢™è§„åˆ™è®¾è®¡åŸåˆ™**
```
è®¾è®¡æ€è·¯ï¼š
1. é»˜è®¤æ‹’ç»ï¼šé™¤éæ˜ç¡®å…è®¸ï¼Œå¦åˆ™æ‹’ç»æ‰€æœ‰è®¿é—®
2. æœ€å°æƒé™ï¼šåªç»™å¿…é¡»çš„æœ€å°ç½‘ç»œæƒé™
3. åˆ†å±‚é˜²æŠ¤ï¼šç½‘ç»œå±‚+åº”ç”¨å±‚+è¿è¡Œæ—¶å¤šé‡é˜²æŠ¤
4. åŠ¨æ€ç®¡ç†ï¼šæ”¯æŒç­–ç•¥çš„åŠ¨æ€æ›´æ–°å’Œå›æ»š
```

**ğŸ”¹ å¾®æœåŠ¡ç½‘ç»œå®‰å…¨æ¶æ„**
```
æ ¸å¿ƒè¦ç´ ï¼š
- æœåŠ¡è¯†åˆ«ï¼šæ¯ä¸ªæœåŠ¡éƒ½æœ‰å”¯ä¸€èº«ä»½æ ‡è¯†
- é€šä¿¡åŠ å¯†ï¼šæœåŠ¡é—´é€šä¿¡ä½¿ç”¨TLSåŠ å¯†
- è®¿é—®æ§åˆ¶ï¼šåŸºäºèº«ä»½çš„ç»†ç²’åº¦è®¿é—®ç­–ç•¥
- ç›‘æ§å®¡è®¡ï¼šå®Œæ•´çš„é€šä¿¡æ—¥å¿—å’Œå®‰å…¨äº‹ä»¶è®°å½•
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ**
```
éƒ¨ç½²é˜¶æ®µï¼š
- é•œåƒå®‰å…¨æ‰«æï¼Œç¦ç”¨ç‰¹æƒå®¹å™¨
- ç½‘ç»œç­–ç•¥é¢„è®¾è®¡ï¼Œæœ€å°ç«¯å£æš´éœ²
- å®‰å…¨é…ç½®æ¨¡æ¿åŒ–ï¼Œè‡ªåŠ¨åŒ–åˆè§„æ£€æŸ¥

è¿è¡Œé˜¶æ®µï¼š  
- å®æ—¶ç½‘ç»œç›‘æ§ï¼Œå¼‚å¸¸è¡Œä¸ºå‘Šè­¦
- å®šæœŸå®‰å…¨å·¡æ£€ï¼Œæ¼æ´åŠæ—¶ä¿®å¤
- è®¿é—®æ—¥å¿—å®¡è®¡ï¼Œå®‰å…¨äº‹ä»¶è¿½è¸ª

ç»´æŠ¤é˜¶æ®µï¼š
- ç­–ç•¥å®šæœŸè¯„ä¼°ï¼Œæƒé™é€‚æ—¶å›æ”¶
- å®‰å…¨å·¥å…·å‡çº§ï¼Œåˆè§„æ ‡å‡†æ›´æ–°
- å®‰å…¨åŸ¹è®­æ™®åŠï¼Œæ„è¯†æŒç»­æå‡
```

**ğŸ“± å¸¸è§åº”ç”¨åœºæ™¯**
```
Webåº”ç”¨ï¼šå‰ç«¯-API-æ•°æ®åº“ä¸‰å±‚éš”ç¦»
å¾®æœåŠ¡ï¼šæœåŠ¡ç½‘æ ¼+ç½‘ç»œç­–ç•¥åŒé‡é˜²æŠ¤  
å¤§æ•°æ®ï¼šè®¡ç®—-å­˜å‚¨-ç®¡ç†åˆ†å±‚éš”ç¦»
AI/MLï¼šè®­ç»ƒ-æ¨ç†-æ•°æ®è®¿é—®æ§åˆ¶
```

**ğŸ” æ•…éšœæ’æŸ¥æŒ‡å—**
```
ç½‘ç»œä¸é€šé—®é¢˜ï¼š
1. æ£€æŸ¥NetworkPolicyè§„åˆ™
2. éªŒè¯DNSè§£ææ˜¯å¦æ­£å¸¸
3. ç¡®è®¤é˜²ç«å¢™è§„åˆ™é…ç½®
4. æŸ¥çœ‹å®¹å™¨ç½‘ç»œé…ç½®

å®‰å…¨å‘Šè­¦å¤„ç†ï¼š
1. åˆ†æå‘Šè­¦æ—¥å¿—ç¡®å®šå¨èƒç±»å‹
2. ä¸´æ—¶é˜»æ–­å¯ç–‘æµé‡
3. è¿½è¸ªæ”»å‡»æºå¤´å’Œå½±å“èŒƒå›´
4. æ›´æ–°å®‰å…¨ç­–ç•¥é˜²èŒƒç±»ä¼¼æ”»å‡»
```

**âœ… è‡ªæ£€æ¸…å•**
```
åŸºç¡€é…ç½®ï¼š
- [ ] å®¹å™¨ä¸ä½¿ç”¨ç‰¹æƒæ¨¡å¼è¿è¡Œ
- [ ] ç«¯å£åªæš´éœ²ç»™å¿…è¦çš„ç½‘ç»œèŒƒå›´
- [ ] ç½‘ç»œç­–ç•¥è¦†ç›–æ‰€æœ‰å…³é”®æœåŠ¡
- [ ] æœåŠ¡é—´é€šä¿¡å¯ç”¨åŠ å¯†

ç›‘æ§å‘Šè­¦ï¼š
- [ ] ç½‘ç»œæµé‡ç›‘æ§é…ç½®å®Œæˆ
- [ ] å¼‚å¸¸è¿æ¥å‘Šè­¦è§„åˆ™ç”Ÿæ•ˆ
- [ ] å®‰å…¨äº‹ä»¶æ—¥å¿—æ”¶é›†æ­£å¸¸
- [ ] åˆè§„æ£€æŸ¥å®šæœŸæ‰§è¡Œ

åº”æ€¥å“åº”ï¼š
- [ ] å®‰å…¨äº‹ä»¶å¤„ç†æµç¨‹æ˜ç¡®
- [ ] ç½‘ç»œéš”ç¦»æ“ä½œé¢„æ¼”å®Œæˆ
- [ ] æ—¥å¿—å®¡è®¡å·¥å…·é…ç½®å®Œå–„
- [ ] å®‰å…¨å›¢é˜Ÿè”ç³»æ–¹å¼ç•…é€š
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å®¹å™¨ç½‘ç»œéœ€éš”ç¦»ï¼Œé˜²ç«å¢™è§„åˆ™è¦ç»†è‡´
- ç«¯å£æš´éœ²æœ€å°åŒ–ï¼Œè®¿é—®æ§åˆ¶é¡»ç²¾ç»†
- æœåŠ¡é€šä¿¡è¦åŠ å¯†ï¼Œç›‘æ§å‘Šè­¦ä¸èƒ½ç¼º
- åˆè§„æ£€æŸ¥å¸¸æ€åŒ–ï¼Œå®‰å…¨æ„è¯†è®°å¿ƒé‡Œ