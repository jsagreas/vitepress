---
title: 5ã€iptablesè§„åˆ™ç®¡ç†ä¸æŒä¹…åŒ–
---
## ğŸ“š ç›®å½•

1. [iptablesè§„åˆ™æŸ¥çœ‹æ“ä½œ](#1-iptablesè§„åˆ™æŸ¥çœ‹æ“ä½œ)
2. [è§„åˆ™çš„å¢åˆ æ”¹æ“ä½œ](#2-è§„åˆ™çš„å¢åˆ æ”¹æ“ä½œ)
3. [è§„åˆ™ç¼–å·ä¸ä½ç½®ç®¡ç†](#3-è§„åˆ™ç¼–å·ä¸ä½ç½®ç®¡ç†)
4. [è§„åˆ™ä¿å­˜ä¸æ¢å¤æœºåˆ¶](#4-è§„åˆ™ä¿å­˜ä¸æ¢å¤æœºåˆ¶)
5. [å¼€æœºè‡ªåŠ¨åŠ è½½é…ç½®](#5-å¼€æœºè‡ªåŠ¨åŠ è½½é…ç½®)
6. [è§„åˆ™å¤‡ä»½ä¸ç‰ˆæœ¬ç®¡ç†](#6-è§„åˆ™å¤‡ä»½ä¸ç‰ˆæœ¬ç®¡ç†)
7. [è§„åˆ™æµ‹è¯•ä¸å›æ»šæœºåˆ¶](#7-è§„åˆ™æµ‹è¯•ä¸å›æ»šæœºåˆ¶)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” iptablesè§„åˆ™æŸ¥çœ‹æ“ä½œ


### 1.1 åŸºæœ¬æŸ¥çœ‹å‘½ä»¤


**ä»€ä¹ˆæ˜¯è§„åˆ™æŸ¥çœ‹**ï¼š
è§„åˆ™æŸ¥çœ‹å°±æ˜¯æ˜¾ç¤ºå½“å‰é˜²ç«å¢™ä¸­å·²ç»è®¾ç½®çš„æ‰€æœ‰è¿‡æ»¤è§„åˆ™ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿäº†è§£ç³»ç»Ÿå½“å‰çš„å®‰å…¨ç­–ç•¥é…ç½®æƒ…å†µã€‚

**æ ¸å¿ƒæŸ¥çœ‹å‚æ•°**ï¼š

| å‚æ•° | **å«ä¹‰** | **ä½œç”¨è¯´æ˜** |
|------|---------|-------------|
| `-L` | `Listè§„åˆ™åˆ—è¡¨` | `æ˜¾ç¤ºæŒ‡å®šé“¾æˆ–æ‰€æœ‰é“¾çš„è§„åˆ™` |
| `-n` | `æ•°å­—æ˜¾ç¤º` | `IPåœ°å€å’Œç«¯å£ç”¨æ•°å­—æ˜¾ç¤ºï¼Œä¸è§£æåŸŸå` |
| `-v` | `è¯¦ç»†ä¿¡æ¯` | `æ˜¾ç¤ºæ•°æ®åŒ…å’Œå­—èŠ‚ç»Ÿè®¡ä¿¡æ¯` |
| `--line-numbers` | `æ˜¾ç¤ºè¡Œå·` | `ç»™æ¯æ¡è§„åˆ™åŠ ä¸Šç¼–å·ï¼Œä¾¿äºç®¡ç†` |

### 1.2 å®ç”¨æŸ¥çœ‹ç»„åˆ


**æœ€å¸¸ç”¨çš„æŸ¥çœ‹æ–¹å¼**ï¼š
```bash
# æŸ¥çœ‹æ‰€æœ‰è§„åˆ™ï¼Œæ˜¾ç¤ºè¡Œå·å’Œè¯¦ç»†ä¿¡æ¯
iptables -L -n -v --line-numbers

# åªæŸ¥çœ‹INPUTé“¾çš„è§„åˆ™
iptables -L INPUT -n -v --line-numbers

# ç®€æ´æŸ¥çœ‹ï¼Œåªæ˜¾ç¤ºè§„åˆ™ä¸æ˜¾ç¤ºç»Ÿè®¡
iptables -L -n
```

**æŸ¥çœ‹ç»“æœè§£è¯»**ï¼š
```
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 num  target     prot opt source       destination         
1    ACCEPT     tcp  --  192.168.1.0/24  0.0.0.0/0  tcp dpt:22
2    DROP       tcp  --  0.0.0.0/0       0.0.0.0/0  tcp dpt:80
```

**å­—æ®µå«ä¹‰è§£é‡Š**ï¼š
- **num**ï¼šè§„åˆ™ç¼–å·ï¼Œæ–¹ä¾¿åç»­ç®¡ç†æ“ä½œ
- **target**ï¼šåŠ¨ä½œï¼ˆACCEPTæ¥å—ã€DROPä¸¢å¼ƒã€REJECTæ‹’ç»ï¼‰
- **prot**ï¼šåè®®ç±»å‹ï¼ˆtcpã€udpã€icmpç­‰ï¼‰
- **source**ï¼šæºåœ°å€èŒƒå›´
- **destination**ï¼šç›®æ ‡åœ°å€èŒƒå›´

### 1.3 ç‰¹å®šè¡¨çš„æŸ¥çœ‹


**ä¸åŒè¡¨çš„æŸ¥çœ‹æ–¹æ³•**ï¼š
```bash
# æŸ¥çœ‹filterè¡¨ï¼ˆé»˜è®¤è¡¨ï¼‰
iptables -t filter -L -n -v

# æŸ¥çœ‹natè¡¨
iptables -t nat -L -n -v

# æŸ¥çœ‹mangleè¡¨
iptables -t mangle -L -n -v

# æŸ¥çœ‹rawè¡¨
iptables -t raw -L -n -v
```

> ğŸ’¡ **å®ç”¨æç¤º**  
> ä½¿ç”¨ `-n` å‚æ•°å¯ä»¥å¤§å¤§åŠ å¿«æŸ¥çœ‹é€Ÿåº¦ï¼Œå› ä¸ºä¸éœ€è¦DNSåå‘è§£æ

---

## 2. âœï¸ è§„åˆ™çš„å¢åˆ æ”¹æ“ä½œ


### 2.1 è§„åˆ™æ’å…¥ï¼ˆ-Iï¼‰


**æ’å…¥æ“ä½œçš„å«ä¹‰**ï¼š
æ’å…¥å°±æ˜¯åœ¨æŒ‡å®šä½ç½®æ·»åŠ æ–°è§„åˆ™ã€‚ä¸è¿½åŠ ä¸åŒï¼Œæ’å…¥å¯ä»¥ç²¾ç¡®æ§åˆ¶è§„åˆ™åœ¨é“¾ä¸­çš„ä½ç½®ï¼Œå› ä¸ºiptablesæŒ‰ç…§ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºåŒ¹é…è§„åˆ™ã€‚

**åŸºæœ¬æ’å…¥è¯­æ³•**ï¼š
```bash
# åœ¨INPUTé“¾å¼€å¤´æ’å…¥è§„åˆ™ï¼ˆä½ç½®1ï¼‰
iptables -I INPUT -s 192.168.1.100 -j DROP

# åœ¨INPUTé“¾ç¬¬3ä½æ’å…¥è§„åˆ™
iptables -I INPUT 3 -p tcp --dport 80 -j ACCEPT

# åœ¨æŒ‡å®šé“¾æœ«å°¾æ’å…¥ï¼ˆç­‰åŒäºè¿½åŠ ï¼‰
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```

**æ’å…¥ä½ç½®çš„é‡è¦æ€§**ï¼š
```
è§„åˆ™åŒ¹é…é¡ºåºç¤ºä¾‹ï¼š
1. ACCEPT  tcp  ssh      (å…è®¸SSH)
2. ACCEPT  tcp  http     (å…è®¸HTTP)  
3. DROP    all  0.0.0.0  (æ‹’ç»æ‰€æœ‰) â† è¿™æ¡å¿…é¡»åœ¨æœ€å
```

### 2.2 è§„åˆ™åˆ é™¤ï¼ˆ-Dï¼‰


**åˆ é™¤è§„åˆ™çš„ä¸¤ç§æ–¹å¼**ï¼š

**æ–¹å¼ä¸€ï¼šæŒ‰è§„åˆ™å†…å®¹åˆ é™¤**
```bash
# åˆ é™¤å®Œå…¨åŒ¹é…çš„è§„åˆ™
iptables -D INPUT -s 192.168.1.100 -j DROP

# åˆ é™¤æŒ‡å®šåè®®å’Œç«¯å£çš„è§„åˆ™
iptables -D INPUT -p tcp --dport 80 -j ACCEPT
```

**æ–¹å¼äºŒï¼šæŒ‰ç¼–å·åˆ é™¤**
```bash
# åˆ é™¤INPUTé“¾ç¬¬2æ¡è§„åˆ™
iptables -D INPUT 2

# åˆ é™¤OUTPUTé“¾ç¬¬1æ¡è§„åˆ™  
iptables -D OUTPUT 1
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**  
> åˆ é™¤è§„åˆ™åï¼Œåé¢çš„è§„åˆ™ç¼–å·ä¼šè‡ªåŠ¨å‰ç§»ï¼Œéœ€è¦é‡æ–°æŸ¥çœ‹ç¡®è®¤

### 2.3 è§„åˆ™æ›¿æ¢ï¼ˆ-Rï¼‰


**æ›¿æ¢æ“ä½œçš„ç”¨é€”**ï¼š
å½“éœ€è¦ä¿®æ”¹æŸæ¡è§„åˆ™æ—¶ï¼Œå¯ä»¥ç”¨æ–°è§„åˆ™å®Œå…¨æ›¿æ¢æŒ‡å®šä½ç½®çš„æ—§è§„åˆ™ã€‚

**æ›¿æ¢ç¤ºä¾‹**ï¼š
```bash
# å°†INPUTé“¾ç¬¬2æ¡è§„åˆ™æ›¿æ¢ä¸ºæ–°è§„åˆ™
iptables -R INPUT 2 -p tcp --dport 8080 -j ACCEPT

# æ›¿æ¢OUTPUTé“¾ç¬¬1æ¡è§„åˆ™
iptables -R OUTPUT 1 -d 10.0.0.0/8 -j REJECT
```

**æ›¿æ¢ vs åˆ é™¤+æ’å…¥**ï¼š
- **æ›¿æ¢**ï¼šä¸€æ­¥åˆ°ä½ï¼Œä¿æŒè§„åˆ™æ€»æ•°ä¸å˜
- **åˆ é™¤+æ’å…¥**ï¼šä¸¤æ­¥æ“ä½œï¼Œå¯èƒ½å½±å“ç¼–å·é¡ºåº

---

## 3. ğŸ“‹ è§„åˆ™ç¼–å·ä¸ä½ç½®ç®¡ç†


### 3.1 è§„åˆ™ç¼–å·çš„å·¥ä½œæœºåˆ¶


**ç¼–å·ç³»ç»Ÿè¯´æ˜**ï¼š
iptablesä¸ºæ¯ä¸ªé“¾ä¸­çš„è§„åˆ™åˆ†é…ä»1å¼€å§‹çš„è¿ç»­ç¼–å·ã€‚ç¼–å·ä¼šéšç€è§„åˆ™çš„å¢åˆ è€ŒåŠ¨æ€è°ƒæ•´ã€‚

```
ç¼–å·å˜åŒ–ç¤ºä¾‹ï¼š
åŸå§‹çŠ¶æ€ï¼š
1. ACCEPT ssh
2. ACCEPT http  
3. DROP all

åˆ é™¤ç¬¬2æ¡åï¼š
1. ACCEPT ssh
2. DROP all     â† åŸæ¥çš„ç¬¬3æ¡å˜æˆç¬¬2æ¡

æ’å…¥æ–°è§„åˆ™åˆ°ç¬¬2ä½ï¼š
1. ACCEPT ssh
2. ACCEPT https  â† æ–°æ’å…¥çš„è§„åˆ™
3. DROP all      â† åŸæ¥çš„ç¬¬2æ¡å˜æˆç¬¬3æ¡
```

### 3.2 ä½ç½®ç­–ç•¥ç®¡ç†


**å¸¸è§çš„è§„åˆ™æ’åºåŸåˆ™**ï¼š

**ğŸ”¸ æŒ‰ä¼˜å…ˆçº§æ’åº**
```bash
# 1. å…è®¸æœ¬åœ°å›ç¯ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
iptables -I INPUT 1 -i lo -j ACCEPT

# 2. å…è®¸å·²å»ºç«‹çš„è¿æ¥
iptables -I INPUT 2 -m state --state ESTABLISHED,RELATED -j ACCEPT

# 3. å…·ä½“æœåŠ¡è§„åˆ™
iptables -I INPUT 3 -p tcp --dport 22 -j ACCEPT
iptables -I INPUT 4 -p tcp --dport 80 -j ACCEPT

# 4. é»˜è®¤æ‹’ç»è§„åˆ™ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰
iptables -A INPUT -j DROP
```

**ğŸ”¸ æŒ‰å®‰å…¨çº§åˆ«æ’åº**
- **é«˜å®‰å…¨è§„åˆ™åœ¨å‰**ï¼šç´§æ€¥é˜»æ–­ã€æ¶æ„IPæ‹¦æˆª
- **å¸¸è§„æœåŠ¡è§„åˆ™å±…ä¸­**ï¼šHTTPã€HTTPSã€SSHç­‰
- **é»˜è®¤ç­–ç•¥åœ¨å**ï¼šå…œåº•çš„ACCEPTæˆ–DROPè§„åˆ™

### 3.3 æ‰¹é‡ç®¡ç†æŠ€å·§


**æŸ¥çœ‹è§„åˆ™ç¼–å·**ï¼š
```bash
# æ˜¾ç¤ºæ‰€æœ‰è§„åˆ™çš„ç¼–å·
iptables -L INPUT -n --line-numbers

# åªæ˜¾ç¤ºç¼–å·å’Œç›®æ ‡åŠ¨ä½œ
iptables -L INPUT -n --line-numbers | awk '{print $1, $2}'
```

**æ‰¹é‡åˆ é™¤è§„åˆ™**ï¼š
```bash
# åˆ é™¤INPUTé“¾çš„ç¬¬2åˆ°ç¬¬5æ¡è§„åˆ™ï¼ˆä»åå¾€å‰åˆ ï¼‰
for i in {5..2}; do
    iptables -D INPUT $i
done
```

---

## 4. ğŸ’¾ è§„åˆ™ä¿å­˜ä¸æ¢å¤æœºåˆ¶


### 4.1 iptables-saveå‘½ä»¤è¯¦è§£


**ä¿å­˜å‘½ä»¤çš„ä½œç”¨**ï¼š
`iptables-save` å°†å½“å‰å†…å­˜ä¸­çš„æ‰€æœ‰iptablesè§„åˆ™å¯¼å‡ºä¸ºæ–‡æœ¬æ ¼å¼ï¼Œè¿™äº›è§„åˆ™é‡å¯åä¼šä¸¢å¤±ï¼Œæ‰€ä»¥éœ€è¦ä¿å­˜åˆ°æ–‡ä»¶ã€‚

**åŸºæœ¬ä¿å­˜æ“ä½œ**ï¼š
```bash
# ä¿å­˜æ‰€æœ‰è¡¨çš„è§„åˆ™åˆ°æ–‡ä»¶
iptables-save > /etc/iptables/rules.v4

# åªä¿å­˜filterè¡¨è§„åˆ™
iptables-save -t filter > /etc/iptables/filter-rules

# ä¿å­˜æ—¶æ·»åŠ æ—¶é—´æˆ³æ³¨é‡Š
echo "# Saved on $(date)" > /etc/iptables/rules.v4
iptables-save >> /etc/iptables/rules.v4
```

**ä¿å­˜æ–‡ä»¶æ ¼å¼è§£è¯»**ï¼š
```bash
# Generated by iptables-save v1.8.4 on Mon Jan 21 10:30:00 2025
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0] 
:OUTPUT ACCEPT [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -j DROP
COMMIT
# Completed on Mon Jan 21 10:30:00 2025
```

### 4.2 iptables-restoreå‘½ä»¤è¯¦è§£


**æ¢å¤å‘½ä»¤çš„ä½œç”¨**ï¼š
`iptables-restore` ä»æ–‡ä»¶ä¸­è¯»å–è§„åˆ™æ ¼å¼ï¼Œé‡æ–°åŠ è½½åˆ°iptablesä¸­ï¼Œé€šå¸¸ç”¨äºç³»ç»Ÿå¯åŠ¨æ—¶æ¢å¤é˜²ç«å¢™é…ç½®ã€‚

**åŸºæœ¬æ¢å¤æ“ä½œ**ï¼š
```bash
# ä»æ–‡ä»¶æ¢å¤æ‰€æœ‰è§„åˆ™
iptables-restore < /etc/iptables/rules.v4

# æ¢å¤å‰å…ˆæ¸…ç©ºç°æœ‰è§„åˆ™
iptables-restore --flush < /etc/iptables/rules.v4

# æµ‹è¯•æ¨¡å¼ï¼Œä¸å®é™…åº”ç”¨è§„åˆ™
iptables-restore --test < /etc/iptables/rules.v4
```

### 4.3 ä¿å­˜æ¢å¤çš„æœ€ä½³å®è·µ


**å®‰å…¨ä¿å­˜æµç¨‹**ï¼š
```bash
# 1. å¤‡ä»½å½“å‰è§„åˆ™
cp /etc/iptables/rules.v4 /etc/iptables/rules.v4.backup

# 2. ä¿å­˜æ–°è§„åˆ™  
iptables-save > /etc/iptables/rules.v4

# 3. éªŒè¯ä¿å­˜ç»“æœ
iptables-restore --test < /etc/iptables/rules.v4
```

**æ¢å¤éªŒè¯æ–¹æ³•**ï¼š
```bash
# æ¢å¤è§„åˆ™åç«‹å³æ£€æŸ¥
iptables-restore < /etc/iptables/rules.v4
iptables -L -n -v --line-numbers | head -20
```

---

## 5. ğŸš€ å¼€æœºè‡ªåŠ¨åŠ è½½é…ç½®


### 5.1 ä¸åŒç³»ç»Ÿçš„è‡ªåŠ¨åŠ è½½æ–¹å¼


**Ubuntu/Debianç³»ç»Ÿ**ï¼š

Ubuntuç³»ç»Ÿé»˜è®¤ä¸ä¼šä¿å­˜iptablesè§„åˆ™ï¼Œéœ€è¦å®‰è£…ä¸“é—¨çš„å·¥å…·æ¥å®ç°å¼€æœºè‡ªåŠ¨åŠ è½½ã€‚

```bash
# å®‰è£…iptables-persistentåŒ…
apt-get install iptables-persistent

# ä¿å­˜å½“å‰è§„åˆ™
iptables-save > /etc/iptables/rules.v4
ip6tables-save > /etc/iptables/rules.v6

# æ‰‹åŠ¨é‡æ–°åŠ è½½
systemctl reload netfilter-persistent
```

**CentOS/RHELç³»ç»Ÿ**ï¼š

CentOS 7+ä½¿ç”¨firewalldï¼Œä½†ä»å¯ä»¥ä½¿ç”¨ä¼ ç»Ÿiptablesæ–¹å¼ï¼š

```bash
# åœç”¨firewalldï¼Œå¯ç”¨iptables
systemctl stop firewalld
systemctl disable firewalld
systemctl enable iptables

# ä¿å­˜è§„åˆ™
service iptables save
# è§„åˆ™ä¿å­˜åœ¨ /etc/sysconfig/iptables
```

### 5.2 æ‰‹åŠ¨é…ç½®è‡ªåŠ¨åŠ è½½


**æ–¹æ³•ä¸€ï¼šä½¿ç”¨systemdæœåŠ¡**
```bash
# åˆ›å»ºiptablesåŠ è½½æœåŠ¡
cat > /etc/systemd/system/iptables-restore.service << EOF
[Unit]
Description=Restore iptables rules
After=network.target

[Service]
Type=oneshot
ExecStart=/sbin/iptables-restore /etc/iptables/rules.v4
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# å¯ç”¨æœåŠ¡
systemctl enable iptables-restore.service
systemctl start iptables-restore.service
```

**æ–¹æ³•äºŒï¼šä½¿ç”¨rc.local**
```bash
# ç¼–è¾‘rc.localæ–‡ä»¶
echo 'iptables-restore < /etc/iptables/rules.v4' >> /etc/rc.local
chmod +x /etc/rc.local
```

### 5.3 éªŒè¯è‡ªåŠ¨åŠ è½½æ•ˆæœ


**æµ‹è¯•å¼€æœºåŠ è½½**ï¼š
```bash
# é‡å¯ç³»ç»Ÿå‰ä¿å­˜å½“å‰è§„åˆ™
iptables-save > /etc/iptables/rules.v4

# é‡å¯åæ£€æŸ¥è§„åˆ™æ˜¯å¦æ­£ç¡®åŠ è½½
reboot

# é‡å¯åéªŒè¯
iptables -L -n -v --line-numbers
```

---

## 6. ğŸ“¦ è§„åˆ™å¤‡ä»½ä¸ç‰ˆæœ¬ç®¡ç†


### 6.1 è§„åˆ™å¤‡ä»½ç­–ç•¥


**å¤‡ä»½çš„é‡è¦æ€§**ï¼š
é˜²ç«å¢™è§„åˆ™ç›´æ¥å…³ç³»åˆ°ç³»ç»Ÿå®‰å…¨ï¼Œé”™è¯¯çš„è§„åˆ™å¯èƒ½å¯¼è‡´æœåŠ¡ä¸­æ–­æˆ–å®‰å…¨æ¼æ´ï¼Œå› æ­¤å»ºç«‹å®Œå–„çš„å¤‡ä»½æœºåˆ¶è‡³å…³é‡è¦ã€‚

**å¤‡ä»½å‘½åè§„èŒƒ**ï¼š
```bash
# æŒ‰æ—¥æœŸå¤‡ä»½
iptables-save > /etc/iptables/backup/rules-$(date +%Y%m%d-%H%M%S).v4

# æŒ‰ç‰ˆæœ¬å·å¤‡ä»½  
iptables-save > /etc/iptables/backup/rules-v1.0.backup
iptables-save > /etc/iptables/backup/rules-v1.1.backup

# æŒ‰ç”¨é€”å¤‡ä»½
iptables-save > /etc/iptables/backup/rules-webserver.backup
iptables-save > /etc/iptables/backup/rules-database.backup
```

### 6.2 è‡ªåŠ¨å¤‡ä»½è„šæœ¬


**å®šæœŸå¤‡ä»½è„šæœ¬**ï¼š
```bash
#!/bin/bash
# /usr/local/bin/iptables-backup.sh

BACKUP_DIR="/etc/iptables/backup"
DATE=$(date +%Y%m%d-%H%M%S)
BACKUP_FILE="$BACKUP_DIR/rules-$DATE.v4"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ‰§è¡Œå¤‡ä»½
iptables-save > $BACKUP_FILE

# ä¿ç•™æœ€è¿‘30å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "rules-*.v4" -mtime +30 -delete

echo "Backup completed: $BACKUP_FILE"
```

**è®¾ç½®å®šæ—¶å¤‡ä»½**ï¼š
```bash
# æ·»åŠ åˆ°crontabï¼Œæ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
crontab -e
0 2 * * * /usr/local/bin/iptables-backup.sh
```

### 6.3 ç‰ˆæœ¬å¯¹æ¯”ä¸ç®¡ç†


**å¤‡ä»½æ–‡ä»¶å¯¹æ¯”**ï¼š
```bash
# æ¯”è¾ƒä¸¤ä¸ªå¤‡ä»½æ–‡ä»¶çš„å·®å¼‚
diff /etc/iptables/backup/rules-20250120.v4 \
     /etc/iptables/backup/rules-20250121.v4

# åªæ˜¾ç¤ºä¸åŒçš„è§„åˆ™è¡Œ
diff -u /etc/iptables/backup/rules-v1.0.backup \
        /etc/iptables/backup/rules-v1.1.backup | grep "^[+-]"
```

**å¤‡ä»½æ¢å¤éªŒè¯**ï¼š
```bash
# æ¢å¤å‰æµ‹è¯•å¤‡ä»½æ–‡ä»¶
iptables-restore --test < /etc/iptables/backup/rules-20250120.v4

# å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œå†å®é™…æ¢å¤
iptables-restore < /etc/iptables/backup/rules-20250120.v4
```

---

## 7. ğŸ§ª è§„åˆ™æµ‹è¯•ä¸å›æ»šæœºåˆ¶


### 7.1 å®‰å…¨æµ‹è¯•ç­–ç•¥


**ä¸ºä»€ä¹ˆéœ€è¦æµ‹è¯•**ï¼š
é˜²ç«å¢™è§„åˆ™é”™è¯¯å¯èƒ½å¯¼è‡´ç³»ç»Ÿæ— æ³•è¿œç¨‹è®¿é—®ï¼Œç‰¹åˆ«æ˜¯åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šï¼Œä¸€æ—¦SSHç«¯å£è¢«è¯¯é˜»æ–­ï¼Œå°±éœ€è¦ç‰©ç†æ¥è§¦æœåŠ¡å™¨æ‰èƒ½ä¿®å¤ã€‚

**æµ‹è¯•ç¯å¢ƒæ­å»º**ï¼š
```bash
# 1. åœ¨æµ‹è¯•å‰ç¡®ä¿æœ‰æœ¬åœ°è®¿é—®æƒé™
# 2. è®¾ç½®è§„åˆ™è‡ªåŠ¨å›æ»šæœºåˆ¶
# 3. åœ¨éç”Ÿäº§æ—¶é—´è¿›è¡Œæµ‹è¯•

# è®¾ç½®10åˆ†é’Ÿåè‡ªåŠ¨æ¸…é™¤æ‰€æœ‰è§„åˆ™çš„è®¡åˆ’ä»»åŠ¡
at now + 10 minutes << EOF
iptables -F
iptables -X
iptables -t nat -F
iptables -t mangle -F
EOF
```

### 7.2 ä¸´æ—¶æµ‹è¯•æœºåˆ¶


**ä¸´æ—¶è§„åˆ™æµ‹è¯•**ï¼š
```bash
# æ–¹æ³•1ï¼šä½¿ç”¨atå‘½ä»¤è®¾ç½®è‡ªåŠ¨å›æ»š
echo "iptables-restore < /etc/iptables/rules.v4.backup" | at now + 5 minutes

# åº”ç”¨æ–°è§„åˆ™è¿›è¡Œæµ‹è¯•
iptables-restore < /etc/iptables/rules-new.v4

# å¦‚æœæµ‹è¯•æˆåŠŸï¼Œå–æ¶ˆè‡ªåŠ¨å›æ»š
atq  # æŸ¥çœ‹è®¡åˆ’ä»»åŠ¡ç¼–å·
atrm 1  # åˆ é™¤ç¼–å·ä¸º1çš„ä»»åŠ¡
```

**SSHè¿æ¥ä¿æŒæµ‹è¯•**ï¼š
```bash
# åœ¨å¦ä¸€ä¸ªSSHä¼šè¯ä¸­ä¿æŒè¿æ¥
# ä¸»ä¼šè¯æµ‹è¯•æ–°è§„åˆ™
iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j DROP

# åœ¨ä¿æŒè¿æ¥çš„ä¼šè¯ä¸­éªŒè¯æ–°è¿æ¥æ˜¯å¦æ­£å¸¸
ssh username@server-ip
```

### 7.3 å¿«é€Ÿå›æ»šæ–¹æ¡ˆ


**ä¸€é”®å›æ»šè„šæœ¬**ï¼š
```bash
#!/bin/bash
# /usr/local/bin/iptables-rollback.sh

BACKUP_FILE="/etc/iptables/rules.v4.backup"

if [ -f "$BACKUP_FILE" ]; then
    echo "Rolling back iptables rules..."
    iptables-restore < $BACKUP_FILE
    echo "Rollback completed successfully"
else
    echo "Backup file not found: $BACKUP_FILE"
    exit 1
fi
```

**ç´§æ€¥æ¸…é™¤æ‰€æœ‰è§„åˆ™**ï¼š
```bash
#!/bin/bash
# ç´§æ€¥æƒ…å†µä¸‹æ¸…é™¤æ‰€æœ‰é˜²ç«å¢™è§„åˆ™
iptables -F          # æ¸…ç©ºæ‰€æœ‰è§„åˆ™
iptables -X          # åˆ é™¤ç”¨æˆ·å®šä¹‰é“¾
iptables -t nat -F   # æ¸…ç©ºnatè¡¨
iptables -t mangle -F # æ¸…ç©ºmangleè¡¨

# è®¾ç½®é»˜è®¤ç­–ç•¥ä¸ºACCEPT
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT  
iptables -P OUTPUT ACCEPT

echo "All iptables rules cleared - EMERGENCY MODE"
```

### 7.4 ç”Ÿäº§ç¯å¢ƒæµ‹è¯•æµç¨‹


**æ¨èæµ‹è¯•æµç¨‹**ï¼š

**ğŸ”¸ æµ‹è¯•å‰å‡†å¤‡**
- [x] å¤‡ä»½å½“å‰è§„åˆ™é…ç½®
- [x] ç¡®è®¤æœ‰ç‰©ç†è®¿é—®æƒé™æˆ–IPMI
- [x] è®¾ç½®è‡ªåŠ¨å›æ»šæœºåˆ¶
- [x] é€šçŸ¥ç›¸å…³äººå‘˜æµ‹è¯•æ—¶é—´çª—å£

**ğŸ”¸ æµ‹è¯•æ‰§è¡Œæ­¥éª¤**
```bash
# 1. å¤‡ä»½å½“å‰é…ç½®
iptables-save > /etc/iptables/rules.backup.$(date +%Y%m%d)

# 2. è®¾ç½®5åˆ†é’Ÿè‡ªåŠ¨å›æ»š
echo "iptables-restore < /etc/iptables/rules.backup.$(date +%Y%m%d)" | at now + 5 minutes

# 3. åº”ç”¨æ–°è§„åˆ™
iptables-restore < /etc/iptables/rules-new.v4

# 4. æµ‹è¯•å…³é”®æœåŠ¡è®¿é—®
curl -I http://localhost
ssh localhost -o ConnectTimeout=5

# 5. ç¡®è®¤æ— é—®é¢˜åå–æ¶ˆå›æ»š
atq && atrm $(atq | awk '{print $1}')
```

**ğŸ”¸ æµ‹è¯•åéªŒè¯**
- [x] ç¡®è®¤æ‰€æœ‰æœåŠ¡æ­£å¸¸è®¿é—®
- [x] æ£€æŸ¥æ—¥å¿—ä¸­çš„æ‹’ç»è®°å½•
- [x] éªŒè¯è§„åˆ™æŒ‰é¢„æœŸå·¥ä½œ
- [x] æ›´æ–°æ–‡æ¡£è®°å½•å˜æ›´

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ“ä½œ


```
ğŸ”¸ è§„åˆ™æŸ¥çœ‹ï¼šiptables -L -n -v --line-numbers
ğŸ”¸ è§„åˆ™ç®¡ç†ï¼š-Iæ’å…¥ã€-Dåˆ é™¤ã€-Ræ›¿æ¢
ğŸ”¸ è§„åˆ™ä¿å­˜ï¼šiptables-save > æ–‡ä»¶
ğŸ”¸ è§„åˆ™æ¢å¤ï¼šiptables-restore < æ–‡ä»¶  
ğŸ”¸ å¼€æœºåŠ è½½ï¼šé…ç½®systemdæœåŠ¡æˆ–rc.local
ğŸ”¸ å¤‡ä»½ç®¡ç†ï¼šå®šæœŸå¤‡ä»½ï¼Œç‰ˆæœ¬æ§åˆ¶
ğŸ”¸ å®‰å…¨æµ‹è¯•ï¼šè®¾ç½®å›æ»šæœºåˆ¶ï¼Œè°¨æ…æ“ä½œ
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è§„åˆ™é¡ºåºçš„é‡è¦æ€§**
```
ç†è§£è¦ç‚¹ï¼š
- iptablesæŒ‰ä»ä¸Šåˆ°ä¸‹é¡ºåºåŒ¹é…è§„åˆ™
- ç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™å†³å®šæ•°æ®åŒ…å‘½è¿
- æ’å…¥ä½ç½®ç›´æ¥å½±å“é˜²ç«å¢™æ•ˆæœ
- é€šç”¨è§„åˆ™åº”æ”¾åœ¨å…·ä½“è§„åˆ™ä¹‹å
```

**ğŸ”¹ æŒä¹…åŒ–çš„å¿…è¦æ€§**
```
æ ¸å¿ƒæ¦‚å¿µï¼š
- iptablesè§„åˆ™åªå­˜åœ¨äºå†…å­˜ä¸­
- ç³»ç»Ÿé‡å¯åè§„åˆ™ä¼šå®Œå…¨ä¸¢å¤±
- å¿…é¡»é…ç½®è‡ªåŠ¨åŠ è½½æœºåˆ¶
- ä¿å­˜æ¢å¤æ˜¯æ—¥å¸¸è¿ç»´çš„åŸºç¡€æ“ä½œ
```

**ğŸ”¹ æµ‹è¯•å›æ»šçš„å®‰å…¨æ„è¯†**
```
å®‰å…¨åŸåˆ™ï¼š
- ä»»ä½•è§„åˆ™å˜æ›´éƒ½å¯èƒ½å½±å“è¿œç¨‹è®¿é—®
- å¿…é¡»åœ¨å˜æ›´å‰å»ºç«‹å›æ»šæœºåˆ¶
- æµ‹è¯•ç¯å¢ƒéªŒè¯åå†åº”ç”¨åˆ°ç”Ÿäº§
- ä¿æŒå¤šç§è®¿é—®æ–¹å¼ä»¥åº”å¯¹ç´§æ€¥æƒ…å†µ
```

### 8.3 å®é™…åº”ç”¨åœºæ™¯


**æ—¥å¸¸è¿ç»´åœºæ™¯**ï¼š
- **æœåŠ¡å™¨åˆå§‹åŒ–**ï¼šé…ç½®åŸºç¡€é˜²ç«å¢™è§„åˆ™å¹¶è®¾ç½®æŒä¹…åŒ–
- **å®‰å…¨ç­–ç•¥è°ƒæ•´**ï¼šæ·»åŠ æ–°çš„è®¿é—®æ§åˆ¶è§„åˆ™
- **æ•…éšœæ’æŸ¥**ï¼šä¸´æ—¶è°ƒæ•´è§„åˆ™è¿›è¡Œé—®é¢˜è¯Šæ–­
- **ç³»ç»Ÿç»´æŠ¤**ï¼šè§„åˆ™å¤‡ä»½ã€ç‰ˆæœ¬ç®¡ç†ã€å®šæœŸæ£€æŸ¥

**åº”æ€¥å¤„ç†åœºæ™¯**ï¼š
- **è§„åˆ™é…ç½®é”™è¯¯**ï¼šå¿«é€Ÿå›æ»šåˆ°ä¸Šä¸€ä¸ªå¯ç”¨ç‰ˆæœ¬
- **é­å—æ”»å‡»**ï¼šç´§æ€¥æ·»åŠ é˜»æ–­è§„åˆ™
- **æœåŠ¡è¿ç§»**ï¼šæ‰¹é‡ä¿®æ”¹è§„åˆ™é€‚åº”æ–°ç¯å¢ƒ
- **åˆè§„æ£€æŸ¥**ï¼šå¯¼å‡ºè§„åˆ™é…ç½®ä¾›å®¡è®¡ä½¿ç”¨

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- è§„åˆ™ç®¡ç†ä¸‰å¤§æ“ä½œï¼šæŸ¥çœ‹ã€ä¿®æ”¹ã€æŒä¹…åŒ–
- å®‰å…¨ç¬¬ä¸€åŸåˆ™ï¼šå¤‡ä»½ã€æµ‹è¯•ã€å›æ»š
- ä½ç½®å†³å®šæ•ˆæœï¼šæ’å…¥é¡ºåºå½±å“åŒ¹é…ç»“æœ  
- æŒä¹…åŒ–ä¿è¯è¿ç»­ï¼šé‡å¯åè§„åˆ™è‡ªåŠ¨æ¢å¤