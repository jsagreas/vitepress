---
title: 13ã€WebæœåŠ¡æ—¥å¿—ç®¡ç†ä¸åˆ†æ
---
## ğŸ“š ç›®å½•

1. [WebæœåŠ¡æ—¥å¿—åŸºç¡€æ¦‚å¿µ](#1-WebæœåŠ¡æ—¥å¿—åŸºç¡€æ¦‚å¿µ)
2. [è®¿é—®æ—¥å¿—æ ¼å¼å®šåˆ¶](#2-è®¿é—®æ—¥å¿—æ ¼å¼å®šåˆ¶)
3. [é”™è¯¯æ—¥å¿—çº§åˆ«é…ç½®](#3-é”™è¯¯æ—¥å¿—çº§åˆ«é…ç½®)
4. [æ—¥å¿—è½®è½¬é…ç½®ç®¡ç†](#4-æ—¥å¿—è½®è½¬é…ç½®ç®¡ç†)
5. [æ—¥å¿—åˆ†æå·¥å…·åº”ç”¨](#5-æ—¥å¿—åˆ†æå·¥å…·åº”ç”¨)
6. [æ€§èƒ½æŒ‡æ ‡æå–ä¸ç›‘æ§](#6-æ€§èƒ½æŒ‡æ ‡æå–ä¸ç›‘æ§)
7. [å¼‚å¸¸è®¿é—®æ£€æµ‹é˜²æŠ¤](#7-å¼‚å¸¸è®¿é—®æ£€æµ‹é˜²æŠ¤)
8. [æ—¥å¿—é›†ä¸­æ”¶é›†æ¶æ„](#8-æ—¥å¿—é›†ä¸­æ”¶é›†æ¶æ„)
9. [ç›‘æ§å‘Šè­¦é…ç½®å®è·µ](#9-ç›‘æ§å‘Šè­¦é…ç½®å®è·µ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ WebæœåŠ¡æ—¥å¿—åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯WebæœåŠ¡æ—¥å¿—


**ğŸ’¡ ç®€å•ç†è§£**ï¼šWebæœåŠ¡æ—¥å¿—å°±åƒæ˜¯ç½‘ç«™çš„"è¡Œè½¦è®°å½•ä»ª"ï¼Œè®°å½•æ¯æ¬¡ç”¨æˆ·è®¿é—®çš„è¯¦ç»†ä¿¡æ¯ã€‚

```
ç”¨æˆ·è®¿é—®ç½‘ç«™çš„è¿‡ç¨‹ï¼š
ç”¨æˆ·æµè§ˆå™¨ â†’ å‘èµ·è¯·æ±‚ â†’ WebæœåŠ¡å™¨ â†’ å¤„ç†è¯·æ±‚ â†’ è¿”å›ç»“æœ
             â†“
         è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶
         
å°±åƒå¿«é€’å‘˜æ¯å¤©éƒ½è¦è®°å½•é€è´§å•ä¸€æ ·ï¼Œ
WebæœåŠ¡å™¨ä¹Ÿè¦è®°å½•æ¯ä¸ªè®¿é—®è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯
```

### 1.2 æ—¥å¿—çš„æ ¸å¿ƒä½œç”¨


**ğŸ¯ ä¸»è¦ç”¨é€”**ï¼š
- **æ•…éšœæ’æŸ¥**ï¼šå½“ç½‘ç«™å‡ºé—®é¢˜æ—¶ï¼Œé€šè¿‡æ—¥å¿—æ‰¾åŸå› 
- **æ€§èƒ½åˆ†æ**ï¼šçœ‹å“ªäº›é¡µé¢è®¿é—®æ…¢ï¼Œå“ªé‡Œéœ€è¦ä¼˜åŒ–
- **å®‰å…¨é˜²æŠ¤**ï¼šå‘ç°æ¶æ„æ”»å‡»å’Œå¼‚å¸¸è®¿é—®
- **ä¸šåŠ¡åˆ†æ**ï¼šäº†è§£ç”¨æˆ·è®¿é—®ä¹ æƒ¯ï¼ŒæŒ‡å¯¼äº§å“æ”¹è¿›

**ğŸ“Š å®é™…åº”ç”¨åœºæ™¯**ï¼š
```
åœºæ™¯1ï¼šç½‘ç«™çªç„¶å˜æ…¢
â†’ æŸ¥çœ‹è®¿é—®æ—¥å¿—ï¼Œå‘ç°æŸä¸ªé¡µé¢è¯·æ±‚é‡æš´å¢
â†’ æ£€æŸ¥é”™è¯¯æ—¥å¿—ï¼Œå‘ç°æ•°æ®åº“è¿æ¥è¶…æ—¶
â†’ å®šä½é—®é¢˜å¹¶è§£å†³

åœºæ™¯2ï¼šå‘ç°å¼‚å¸¸æµé‡
â†’ åˆ†æè®¿é—®æ—¥å¿—ï¼Œå‘ç°å¤§é‡ç›¸åŒIPçš„è¯·æ±‚
â†’ è¯†åˆ«ä¸ºçˆ¬è™«æˆ–æ”»å‡»è¡Œä¸º
â†’ é…ç½®é˜²æŠ¤è§„åˆ™
```

### 1.3 å¸¸è§WebæœåŠ¡å™¨çš„æ—¥å¿—ç±»å‹


**ğŸ”§ Nginxæ—¥å¿—ç±»å‹**ï¼š
```
è®¿é—®æ—¥å¿—ï¼ˆaccess.logï¼‰ï¼š
- è®°å½•æ¯ä¸ªç”¨æˆ·è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯
- åŒ…æ‹¬IPã€æ—¶é—´ã€è¯·æ±‚æ–¹æ³•ã€çŠ¶æ€ç ç­‰

é”™è¯¯æ—¥å¿—ï¼ˆerror.logï¼‰ï¼š
- è®°å½•æœåŠ¡å™¨è¿è¡Œä¸­çš„é”™è¯¯ä¿¡æ¯
- åŒ…æ‹¬é…ç½®é”™è¯¯ã€è¿æ¥å¤±è´¥ã€æƒé™é—®é¢˜ç­‰
```

**ğŸ”§ Apacheæ—¥å¿—ç±»å‹**ï¼š
```
è®¿é—®æ—¥å¿—ï¼ˆaccess_logï¼‰ï¼š
- åŠŸèƒ½ç±»ä¼¼Nginxçš„access.log
- å¯ä»¥è‡ªå®šä¹‰è®°å½•æ ¼å¼

é”™è¯¯æ—¥å¿—ï¼ˆerror_logï¼‰ï¼š
- è®°å½•Apacheè¿è¡Œé”™è¯¯
- åŒ…æ‹¬æ¨¡å—åŠ è½½å¤±è´¥ã€è™šæ‹Ÿä¸»æœºé…ç½®é”™è¯¯ç­‰
```

---

## 2. ğŸ“ è®¿é—®æ—¥å¿—æ ¼å¼å®šåˆ¶


### 2.1 ç†è§£è®¿é—®æ—¥å¿—çš„ä½œç”¨


**ğŸ’¡ ç®€å•ç†è§£**ï¼šè®¿é—®æ—¥å¿—å°±åƒé“¶è¡Œæµæ°´è´¦ï¼Œè®°å½•æ¯ç¬”äº¤æ˜“çš„è¯¦ç»†ä¿¡æ¯ã€‚

```
é“¶è¡Œæµæ°´è®°å½•ï¼šæ—¶é—´ | é‡‘é¢ | äº¤æ˜“ç±»å‹ | ä½™é¢
è®¿é—®æ—¥å¿—è®°å½•ï¼šæ—¶é—´ | IPåœ°å€ | è¯·æ±‚å†…å®¹ | å“åº”çŠ¶æ€
```

### 2.2 Nginxè®¿é—®æ—¥å¿—æ ¼å¼é…ç½®


**ğŸ”¸ é»˜è®¤æ—¥å¿—æ ¼å¼ç†è§£**ï¼š
```nginx
# é»˜è®¤çš„combinedæ ¼å¼
log_format combined '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent"';
```

**ğŸ“‹ å„å­—æ®µå«ä¹‰è§£é‡Š**ï¼š
```
$remote_addr     â†’ è®¿é—®è€…çš„IPåœ°å€
$remote_user     â†’ è®¤è¯ç”¨æˆ·åï¼ˆé€šå¸¸ä¸ºç©ºï¼‰
$time_local      â†’ è®¿é—®æ—¶é—´
$request         â†’ è¯·æ±‚æ–¹æ³•å’ŒURL
$status          â†’ HTTPçŠ¶æ€ç 
$body_bytes_sent â†’ å‘é€ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•°
$http_referer    â†’ æ¥æºé¡µé¢
$http_user_agent â†’ ç”¨æˆ·æµè§ˆå™¨ä¿¡æ¯
```

**ğŸ”§ å®é™…æ—¥å¿—ç¤ºä¾‹**ï¼š
```
192.168.1.100 - - [15/Jan/2025:10:30:45 +0800] 
"GET /index.html HTTP/1.1" 200 1234 
"https://www.google.com" "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"

è§£è¯»ï¼š
- IPåœ°å€ï¼š192.168.1.100
- æ—¶é—´ï¼š2025å¹´1æœˆ15æ—¥10:30:45
- è¯·æ±‚ï¼šè·å–index.htmlé¡µé¢
- çŠ¶æ€ï¼š200ï¼ˆæˆåŠŸï¼‰
- å¤§å°ï¼š1234å­—èŠ‚
- æ¥æºï¼šGoogleæœç´¢
- æµè§ˆå™¨ï¼šWindows Chrome
```

### 2.3 è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼


**ğŸ¯ æ ¹æ®éœ€æ±‚å®šåˆ¶æ ¼å¼**ï¼š

```nginx
# æ€§èƒ½ç›‘æ§ä¸“ç”¨æ ¼å¼
log_format performance '$remote_addr [$time_local] "$request" '
                      '$status $body_bytes_sent '
                      '$request_time $upstream_response_time';

# å®‰å…¨ç›‘æ§ä¸“ç”¨æ ¼å¼  
log_format security '$remote_addr [$time_local] "$request" '
                   '$status "$http_user_agent" '
                   '$request_length $bytes_sent';

# APIæ¥å£ä¸“ç”¨æ ¼å¼
log_format api '$remote_addr [$time_local] "$request" '
              '$status $body_bytes_sent $request_time '
              '"$http_x_forwarded_for" "$request_body"';
```

**ğŸ’¡ é€‰æ‹©è®°å½•å­—æ®µçš„åŸåˆ™**ï¼š
- **å¿…è¦æ€§**ï¼šåªè®°å½•çœŸæ­£éœ€è¦çš„ä¿¡æ¯
- **éšç§æ€§**ï¼šé¿å…è®°å½•æ•æ„Ÿä¿¡æ¯
- **æ€§èƒ½æ€§**ï¼šè¿‡å¤šå­—æ®µä¼šå½±å“æ€§èƒ½
- **åˆ†ææ€§**ï¼šä¾¿äºåç»­æ•°æ®åˆ†æ

### 2.4 Apacheè®¿é—®æ—¥å¿—æ ¼å¼é…ç½®


**ğŸ”§ Apache LogFormatæŒ‡ä»¤**ï¼š
```apache
# é€šç”¨æ—¥å¿—æ ¼å¼
LogFormat "%h %l %u %t \"%r\" %>s %b" common

# ç»„åˆæ—¥å¿—æ ¼å¼  
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\"" combined

# è‡ªå®šä¹‰æ ¼å¼
LogFormat "%h %t \"%r\" %>s %b %D" performance
```

**ğŸ“‹ Apacheæ ¼å¼ä»£ç è¯´æ˜**ï¼š
```
%h â†’ å®¢æˆ·ç«¯IPåœ°å€
%l â†’ è¿œç¨‹ç™»å½•å
%u â†’ è®¤è¯ç”¨æˆ·å
%t â†’ è¯·æ±‚æ—¶é—´
%r â†’ è¯·æ±‚è¡Œ
%s â†’ çŠ¶æ€ç 
%b â†’ å“åº”å­—èŠ‚æ•°
%D â†’ å¤„ç†è¯·æ±‚çš„æ—¶é—´ï¼ˆå¾®ç§’ï¼‰
```

---

## 3. âš ï¸ é”™è¯¯æ—¥å¿—çº§åˆ«é…ç½®


### 3.1 ç†è§£é”™è¯¯æ—¥å¿—çš„é‡è¦æ€§


**ğŸ’¡ ç®€å•ç†è§£**ï¼šé”™è¯¯æ—¥å¿—å°±åƒæ±½è½¦çš„æ•…éšœè­¦ç¤ºç¯ï¼Œå‘Šè¯‰ä½ å“ªé‡Œå‡ºäº†é—®é¢˜ã€‚

```
æ±½è½¦æ•…éšœç¯ï¼š
ğŸ”´ çº¢ç¯ â†’ ä¸¥é‡æ•…éšœï¼Œç«‹å³åœè½¦
ğŸŸ¡ é»„ç¯ â†’ è­¦å‘Šä¿¡æ¯ï¼Œéœ€è¦æ³¨æ„
ğŸŸ¢ ç»¿ç¯ â†’ æ­£å¸¸çŠ¶æ€

WebæœåŠ¡é”™è¯¯æ—¥å¿—ï¼š
ğŸ”´ Error â†’ ä¸¥é‡é”™è¯¯ï¼Œå½±å“æœåŠ¡
ğŸŸ¡ Warn  â†’ è­¦å‘Šä¿¡æ¯ï¼Œéœ€è¦å…³æ³¨
ğŸŸ¢ Info  â†’ ä¿¡æ¯è®°å½•ï¼Œæ­£å¸¸è¿è¡Œ
```

### 3.2 Nginxé”™è¯¯æ—¥å¿—çº§åˆ«


**ğŸ“Š æ—¥å¿—çº§åˆ«ä»é«˜åˆ°ä½**ï¼š
```
emerg   â†’ ç´§æ€¥æƒ…å†µï¼Œç³»ç»Ÿä¸å¯ç”¨
alert   â†’ å¿…é¡»ç«‹å³é‡‡å–è¡ŒåŠ¨
crit    â†’ ä¸´ç•Œé”™è¯¯
error   â†’ é”™è¯¯ä¿¡æ¯
warn    â†’ è­¦å‘Šä¿¡æ¯
notice  â†’ é€šçŸ¥ä¿¡æ¯
info    â†’ ä¿¡æ¯è®°å½•
debug   â†’ è°ƒè¯•ä¿¡æ¯
```

**ğŸ”§ é…ç½®ç¤ºä¾‹**ï¼š
```nginx
# å…¨å±€é”™è¯¯æ—¥å¿—é…ç½®
error_log /var/log/nginx/error.log warn;

# ä¸åŒè™šæ‹Ÿä¸»æœºä½¿ç”¨ä¸åŒçº§åˆ«
server {
    listen 80;
    server_name example.com;
    
    # ç”Ÿäº§ç¯å¢ƒä½¿ç”¨warnçº§åˆ«
    error_log /var/log/nginx/example_error.log warn;
}

server {
    listen 80;
    server_name test.example.com;
    
    # æµ‹è¯•ç¯å¢ƒä½¿ç”¨debugçº§åˆ«
    error_log /var/log/nginx/test_error.log debug;
}
```

**ğŸ’¡ çº§åˆ«é€‰æ‹©å»ºè®®**ï¼š
```
ç”Ÿäº§ç¯å¢ƒï¼šwarn æˆ– error
- åªè®°å½•é‡è¦é—®é¢˜ï¼Œé¿å…æ—¥å¿—æ–‡ä»¶è¿‡å¤§

æµ‹è¯•ç¯å¢ƒï¼šinfo æˆ– debug  
- è®°å½•è¯¦ç»†ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•

å¼€å‘ç¯å¢ƒï¼šdebug
- è®°å½•æ‰€æœ‰ä¿¡æ¯ï¼Œä¾¿äºå¼€å‘è°ƒè¯•
```

### 3.3 Apacheé”™è¯¯æ—¥å¿—çº§åˆ«


**ğŸ“Š Apacheæ—¥å¿—çº§åˆ«**ï¼š
```
emerg   â†’ ç³»ç»Ÿæ— æ³•ä½¿ç”¨
alert   â†’ éœ€è¦ç«‹å³è¡ŒåŠ¨
crit    â†’ å…³é”®é”™è¯¯
error   â†’ é”™è¯¯æ¡ä»¶
warn    â†’ è­¦å‘Šæ¡ä»¶
notice  â†’ æ­£å¸¸ä½†é‡è¦çš„æ¡ä»¶
info    â†’ ä¿¡æ¯æ¶ˆæ¯
debug   â†’ è°ƒè¯•çº§åˆ«æ¶ˆæ¯
trace1-8 â†’ è·Ÿè¸ªæ¶ˆæ¯ï¼ˆä¸åŒè¯¦ç»†ç¨‹åº¦ï¼‰
```

**ğŸ”§ é…ç½®ç¤ºä¾‹**ï¼š
```apache
# å…¨å±€é”™è¯¯æ—¥å¿—
ErrorLog /var/log/apache2/error.log
LogLevel warn

# è™šæ‹Ÿä¸»æœºé”™è¯¯æ—¥å¿—
<VirtualHost *:80>
    ServerName example.com
    ErrorLog /var/log/apache2/example_error.log
    LogLevel error
</VirtualHost>
```

### 3.4 é”™è¯¯æ—¥å¿—åˆ†ææŠ€å·§


**ğŸ” å¸¸è§é”™è¯¯ç±»å‹è¯†åˆ«**ï¼š

```bash
# æƒé™é”™è¯¯
[error] 13#0: *1 open() "/var/www/html/file.txt" failed (13: Permission denied)

# æ–‡ä»¶ä¸å­˜åœ¨
[error] 13#0: *1 open() "/var/www/html/notfound.html" failed (2: No such file or directory)

# ä¸Šæ¸¸æœåŠ¡å™¨é”™è¯¯
[error] 13#0: *1 connect() failed (111: Connection refused) while connecting to upstream
```

**ğŸ“‹ é”™è¯¯æ—¥å¿—ç›‘æ§é‡ç‚¹**ï¼š
- **é¢‘ç¹çš„404é”™è¯¯**ï¼šå¯èƒ½æ˜¯çˆ¬è™«æˆ–é“¾æ¥å¤±æ•ˆ
- **5xxé”™è¯¯**ï¼šæœåŠ¡å™¨å†…éƒ¨é—®é¢˜ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨  
- **è¶…æ—¶é”™è¯¯**ï¼šæ€§èƒ½é—®é¢˜ï¼Œéœ€è¦ä¼˜åŒ–
- **æƒé™é”™è¯¯**ï¼šé…ç½®é—®é¢˜ï¼Œéœ€è¦ä¿®å¤

---

## 4. ğŸ”„ æ—¥å¿—è½®è½¬é…ç½®ç®¡ç†


### 4.1 ä»€ä¹ˆæ˜¯æ—¥å¿—è½®è½¬


**ğŸ’¡ ç®€å•ç†è§£**ï¼šæ—¥å¿—è½®è½¬å°±åƒå®šæœŸæ•´ç†æ–‡ä»¶å¤¹ï¼Œé˜²æ­¢å•ä¸ªæ–‡ä»¶è¿‡å¤§å½±å“ç³»ç»Ÿæ€§èƒ½ã€‚

```
æ²¡æœ‰æ—¥å¿—è½®è½¬çš„æƒ…å†µï¼š
access.log â†’ è¶Šæ¥è¶Šå¤§ â†’ å‡ GBç”šè‡³å‡ åGB
é—®é¢˜ï¼šæ–‡ä»¶è¿‡å¤§ï¼Œéš¾ä»¥æ‰“å¼€å’Œåˆ†æ

ä½¿ç”¨æ—¥å¿—è½®è½¬åï¼š
access.log           â† å½“å‰æ—¥å¿—
access.log.1         â† æ˜¨å¤©çš„æ—¥å¿—  
access.log.2.gz      â† å‰å¤©çš„æ—¥å¿—ï¼ˆå·²å‹ç¼©ï¼‰
access.log.3.gz      â† æ›´æ—©çš„æ—¥å¿—ï¼ˆå·²å‹ç¼©ï¼‰
```

### 4.2 logrotateå·¥å…·é…ç½®


**ğŸ”§ åŸºæœ¬æ¦‚å¿µç†è§£**ï¼š
`logrotate`æ˜¯Linuxç³»ç»Ÿè‡ªå¸¦çš„æ—¥å¿—è½®è½¬å·¥å…·ï¼Œå°±åƒå®šæ—¶æ¸…ç†å·¥å…·ä¸€æ ·ã€‚

**ğŸ“ Nginxæ—¥å¿—è½®è½¬é…ç½®**ï¼š
```bash
# åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š/etc/logrotate.d/nginx
/var/log/nginx/*.log {
    daily                # æ¯å¤©è½®è½¬ä¸€æ¬¡
    missingok           # å¦‚æœæ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¸æŠ¥é”™
    rotate 52           # ä¿ç•™52ä¸ªå¤‡ä»½æ–‡ä»¶ï¼ˆçº¦ä¸€å¹´ï¼‰
    compress            # å‹ç¼©æ—§æ—¥å¿—æ–‡ä»¶
    delaycompress       # å»¶è¿Ÿå‹ç¼©ï¼Œç¬¬äºŒæ¬¡è½®è½¬æ—¶æ‰å‹ç¼©
    notifempty          # å¦‚æœæ—¥å¿—æ–‡ä»¶ä¸ºç©ºï¼Œä¸è¿›è¡Œè½®è½¬
    create 0644 www-data www-data  # åˆ›å»ºæ–°æ—¥å¿—æ–‡ä»¶çš„æƒé™å’Œæ‰€æœ‰è€…
    sharedscripts       # å¤šä¸ªæ—¥å¿—æ–‡ä»¶åªæ‰§è¡Œä¸€æ¬¡è„šæœ¬
    postrotate          # è½®è½¬åæ‰§è¡Œçš„å‘½ä»¤
        /bin/kill -USR1 $(cat /var/run/nginx.pid 2>/dev/null) 2>/dev/null || true
    endscript
}
```

**ğŸ“‹ é…ç½®é€‰é¡¹è¯¦è§£**ï¼š
```
daily/weekly/monthly â†’ è½®è½¬é¢‘ç‡
rotate N            â†’ ä¿ç•™Nä¸ªå¤‡ä»½æ–‡ä»¶
size 100M           â†’ æ–‡ä»¶å¤§å°è¶…è¿‡100Må°±è½®è½¬
compress            â†’ å‹ç¼©æ—§æ–‡ä»¶èŠ‚çœç©ºé—´
copytruncate        â†’ å¤åˆ¶åæ¸…ç©ºåŸæ–‡ä»¶ï¼ˆé€‚ç”¨äºæŒç»­å†™å…¥çš„ç¨‹åºï¼‰
create              â†’ åˆ›å»ºæ–°æ–‡ä»¶çš„æƒé™è®¾ç½®
```

### 4.3 æ‰‹åŠ¨æµ‹è¯•æ—¥å¿—è½®è½¬


**ğŸ§ª æµ‹è¯•è½®è½¬é…ç½®**ï¼š
```bash
# æµ‹è¯•é…ç½®æ–‡ä»¶è¯­æ³•
sudo logrotate -d /etc/logrotate.d/nginx

# å¼ºåˆ¶æ‰§è¡Œè½®è½¬ï¼ˆç”¨äºæµ‹è¯•ï¼‰
sudo logrotate -f /etc/logrotate.d/nginx

# æŸ¥çœ‹è½®è½¬çŠ¶æ€
sudo cat /var/lib/logrotate/status
```

### 4.4 ä¸åŒåœºæ™¯çš„è½®è½¬ç­–ç•¥


**ğŸ“Š è½®è½¬ç­–ç•¥å¯¹æ¯”**ï¼š

| ç½‘ç«™ç±»å‹ | è®¿é—®é‡ | è½®è½¬é¢‘ç‡ | ä¿ç•™æ—¶é—´ | å‹ç¼©è®¾ç½® |
|---------|--------|----------|----------|----------|
| **å°å‹ç½‘ç«™** | `<1ä¸‡PV/å¤©` | `weekly` | `4å‘¨` | `ç«‹å³å‹ç¼©` |
| **ä¸­å‹ç½‘ç«™** | `1-10ä¸‡PV/å¤©` | `daily` | `30å¤©` | `å»¶è¿Ÿå‹ç¼©` |
| **å¤§å‹ç½‘ç«™** | `>10ä¸‡PV/å¤©` | `hourly` | `7å¤©` | `ç«‹å³å‹ç¼©` |

**ğŸ’¡ é€‰æ‹©åŸåˆ™**ï¼š
- **è®¿é—®é‡å¤§**ï¼šè½®è½¬é¢‘ç‡è¦é«˜ï¼Œé¿å…å•æ–‡ä»¶è¿‡å¤§
- **å­˜å‚¨ç©ºé—´å°**ï¼šä¿ç•™æ—¶é—´è¦çŸ­ï¼ŒåŠæ—¶åˆ é™¤æ—§æ—¥å¿—
- **åˆ†æéœ€æ±‚é«˜**ï¼šä¿ç•™æ—¶é—´è¦é•¿ï¼Œä¾¿äºå†å²æ•°æ®åˆ†æ

---

## 5. ğŸ” æ—¥å¿—åˆ†æå·¥å…·åº”ç”¨


### 5.1 å‘½ä»¤è¡Œå·¥å…·åˆ†æ


**ğŸ’¡ åŸºç¡€åˆ†ææ€è·¯**ï¼šä½¿ç”¨Linuxè‡ªå¸¦çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå°±åƒç”¨è®¡ç®—å™¨ä¸€æ ·ç®€å•ç›´æ¥ã€‚

**ğŸ”§ å¸¸ç”¨åˆ†æå‘½ä»¤**ï¼š

```bash
# æŸ¥çœ‹è®¿é—®é‡æœ€å¤§çš„IPåœ°å€
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10

# æŸ¥çœ‹æœ€çƒ­é—¨çš„é¡µé¢
awk '{print $7}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10

# æŸ¥çœ‹404é”™è¯¯çš„URL
awk '$9==404 {print $7}' /var/log/nginx/access.log | sort | uniq -c | sort -nr

# ç»Ÿè®¡æ¯å°æ—¶çš„è®¿é—®é‡
awk '{print $4}' /var/log/nginx/access.log | cut -c14-15 | sort | uniq -c
```

**ğŸ“Š åˆ†æç»“æœç¤ºä¾‹**ï¼š
```bash
# IPè®¿é—®ç»Ÿè®¡ç»“æœ
   1247 192.168.1.100    â† è¿™ä¸ªIPè®¿é—®äº†1247æ¬¡
    856 10.0.0.50       â† è¿™ä¸ªIPè®¿é—®äº†856æ¬¡
    234 172.16.1.10     â† è¿™ä¸ªIPè®¿é—®äº†234æ¬¡

# é¡µé¢è®¿é—®ç»Ÿè®¡ç»“æœ  
   2341 /index.html     â† é¦–é¡µè®¿é—®æœ€å¤š
   1205 /api/user      â† APIæ¥å£è®¿é—®é‡å¤§
    567 /contact.html   â† è”ç³»é¡µé¢
```

### 5.2 ä¸“ä¸šæ—¥å¿—åˆ†æå·¥å…·


**ğŸš€ AWStats - Webç»Ÿè®¡åˆ†æå·¥å…·**ï¼š

```bash
# å®‰è£…AWStats
sudo apt install awstats

# é…ç½®AWStats
sudo cp /etc/awstats/awstats.conf /etc/awstats/awstats.example.com.conf

# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /etc/awstats/awstats.example.com.conf
```

**âš™ï¸ AWStatsåŸºæœ¬é…ç½®**ï¼š
```perl
# è®¾ç½®ç½‘ç«™åŸŸå
SiteDomain="example.com"

# æŒ‡å®šæ—¥å¿—æ–‡ä»¶
LogFile="/var/log/nginx/access.log"

# è®¾ç½®æ—¥å¿—æ ¼å¼
LogFormat=1

# è¾“å‡ºç›®å½•
DirData="/var/lib/awstats"
```

**ğŸŒ GoAccess - å®æ—¶æ—¥å¿—åˆ†æå·¥å…·**ï¼š

```bash
# å®‰è£…GoAccess
sudo apt install goaccess

# å®æ—¶åˆ†æNginxæ—¥å¿—
goaccess /var/log/nginx/access.log -c

# ç”ŸæˆHTMLæŠ¥å‘Š
goaccess /var/log/nginx/access.log -o report.html --log-format=COMBINED
```

### 5.3 ELK Stackæ—¥å¿—åˆ†ææ¶æ„


**ğŸ’¡ ELK Stackç®€å•ç†è§£**ï¼š
```
Elasticsearch â†’ æ•°æ®åº“ï¼ˆå­˜å‚¨å’Œæœç´¢æ—¥å¿—ï¼‰
Logstash     â†’ æ•°æ®å¤„ç†å™¨ï¼ˆæ”¶é›†å’Œè½¬æ¢æ—¥å¿—ï¼‰  
Kibana       â†’ å›¾å½¢ç•Œé¢ï¼ˆå±•ç¤ºå’Œåˆ†ææ•°æ®ï¼‰

å°±åƒï¼š
æ”¶é›†æ—¥å¿— â†’ å¤„ç†æ•´ç† â†’ å¯è§†åŒ–å±•ç¤º
```

**ğŸ”§ åŸºç¡€æ¶æ„å›¾**ï¼š
```
WebæœåŠ¡å™¨ â†’ Filebeat â†’ Logstash â†’ Elasticsearch â†’ Kibana
    â†“         â†“          â†“            â†“           â†“
  äº§ç”Ÿæ—¥å¿—   æ”¶é›†æ—¥å¿—   å¤„ç†æ—¥å¿—     å­˜å‚¨æ—¥å¿—    å±•ç¤ºåˆ†æ
```

### 5.4 æ—¥å¿—åˆ†ææœ€ä½³å®è·µ


**ğŸ¯ åˆ†æé‡ç‚¹å…³æ³¨æŒ‡æ ‡**ï¼š

```
æ€§èƒ½æŒ‡æ ‡ï¼š
- å“åº”æ—¶é—´åˆ†å¸ƒ
- é”™è¯¯ç‡ç»Ÿè®¡  
- å¹¶å‘è®¿é—®é‡
- æœåŠ¡å™¨è´Ÿè½½

å®‰å…¨æŒ‡æ ‡ï¼š
- å¼‚å¸¸IPè®¿é—®
- æ”»å‡»è¡Œä¸ºæ£€æµ‹
- ç™»å½•å¤±è´¥ç»Ÿè®¡
- æ•æ„Ÿè·¯å¾„è®¿é—®

ä¸šåŠ¡æŒ‡æ ‡ï¼š
- ç”¨æˆ·è®¿é—®è·¯å¾„
- çƒ­é—¨å†…å®¹æ’è¡Œ
- è½¬åŒ–ç‡åˆ†æ
- ç”¨æˆ·åœ°åŸŸåˆ†å¸ƒ
```

**ğŸ’¡ åˆ†ææŠ¥å‘Šæ¨¡æ¿**ï¼š
```
æ—¥æœŸï¼š2025-01-15
æ€»è®¿é—®é‡ï¼š10,234 æ¬¡
ç‹¬ç«‹IPï¼š2,156 ä¸ª
å¹³å‡å“åº”æ—¶é—´ï¼š0.3ç§’
é”™è¯¯ç‡ï¼š0.2%

é‡ç‚¹å‘ç°ï¼š
âœ… ç½‘ç«™æ€§èƒ½ç¨³å®šï¼Œå“åº”æ—¶é—´æ­£å¸¸
âš ï¸ å‘ç°3ä¸ªIPå¼‚å¸¸è®¿é—®ï¼Œå·²åŠ å…¥ç›‘æ§
ğŸ”¥ /api/productæ¥å£è®¿é—®é‡å¢é•¿50%
```

---

## 6. ğŸ“Š æ€§èƒ½æŒ‡æ ‡æå–ä¸ç›‘æ§


### 6.1 ç†è§£Webæ€§èƒ½æŒ‡æ ‡


**ğŸ’¡ ç®€å•ç†è§£**ï¼šWebæ€§èƒ½æŒ‡æ ‡å°±åƒä½“æ£€æŠ¥å‘Šï¼Œå‘Šè¯‰ä½ ç½‘ç«™çš„å¥åº·çŠ¶å†µã€‚

```
äººä½“ä½“æ£€æŒ‡æ ‡ï¼š
è¡€å‹ã€å¿ƒç‡ã€ä½“é‡ â†’ åæ˜ èº«ä½“å¥åº·çŠ¶å†µ

ç½‘ç«™æ€§èƒ½æŒ‡æ ‡ï¼š  
å“åº”æ—¶é—´ã€ååé‡ã€é”™è¯¯ç‡ â†’ åæ˜ ç½‘ç«™å¥åº·çŠ¶å†µ
```

### 6.2 æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡å®šä¹‰


**ğŸ¯ å…³é”®æ€§èƒ½æŒ‡æ ‡(KPI)**ï¼š

```
å“åº”æ—¶é—´ (Response Time)ï¼š
- å«ä¹‰ï¼šä»å‘èµ·è¯·æ±‚åˆ°æ”¶åˆ°å“åº”çš„æ—¶é—´
- æ­£å¸¸å€¼ï¼š< 1ç§’ï¼ˆåŠ¨æ€é¡µé¢ï¼‰, < 0.1ç§’ï¼ˆé™æ€èµ„æºï¼‰
- å½±å“ï¼šç”¨æˆ·ä½“éªŒçš„ç›´æ¥ä½“ç°

ååé‡ (Throughput)ï¼š  
- å«ä¹‰ï¼šå•ä½æ—¶é—´å†…å¤„ç†çš„è¯·æ±‚æ•°é‡
- å•ä½ï¼šrequests/second (RPS)
- æ„ä¹‰ï¼šæœåŠ¡å™¨å¤„ç†èƒ½åŠ›çš„ä½“ç°

é”™è¯¯ç‡ (Error Rate)ï¼š
- å«ä¹‰ï¼šé”™è¯¯è¯·æ±‚å æ€»è¯·æ±‚çš„æ¯”ä¾‹
- è®¡ç®—ï¼š(4xx+5xxé”™è¯¯æ•°) / æ€»è¯·æ±‚æ•° Ã— 100%
- æ­£å¸¸å€¼ï¼š< 1%

å¹¶å‘ç”¨æˆ·æ•° (Concurrent Users)ï¼š
- å«ä¹‰ï¼šåŒæ—¶è®¿é—®ç½‘ç«™çš„ç”¨æˆ·æ•°é‡
- å½±å“ï¼šæœåŠ¡å™¨èµ„æºæ¶ˆè€—
```

### 6.3 ä»æ—¥å¿—ä¸­æå–æ€§èƒ½æŒ‡æ ‡


**ğŸ”§ å“åº”æ—¶é—´åˆ†æ**ï¼š

```bash
# æå–å“åº”æ—¶é—´ï¼ˆNginxéœ€è¦åœ¨æ—¥å¿—æ ¼å¼ä¸­æ·»åŠ $request_timeï¼‰
awk '{print $NF}' /var/log/nginx/access.log | \
awk '{sum+=$1; count++} END {print "å¹³å‡å“åº”æ—¶é—´:", sum/count "ç§’"}'

# ç»Ÿè®¡å“åº”æ—¶é—´åˆ†å¸ƒ
awk '{print $NF}' /var/log/nginx/access.log | \
awk '{
    if ($1 < 0.1) fast++
    else if ($1 < 0.5) normal++  
    else if ($1 < 1.0) slow++
    else very_slow++
}
END {
    total = fast + normal + slow + very_slow
    printf "å“åº”æ—¶é—´åˆ†å¸ƒ:\n"
    printf "<0.1s: %.1f%%\n", fast/total*100
    printf "0.1-0.5s: %.1f%%\n", normal/total*100  
    printf "0.5-1.0s: %.1f%%\n", slow/total*100
    printf ">1.0s: %.1f%%\n", very_slow/total*100
}'
```

**ğŸ“Š ååé‡ç»Ÿè®¡**ï¼š
```bash
# æŒ‰å°æ—¶ç»Ÿè®¡è¯·æ±‚é‡
awk '{print $4}' /var/log/nginx/access.log | \
cut -c14-15 | sort | uniq -c | \
awk '{printf "%s:00 - %d requests\n", $2, $1}'

# è®¡ç®—æ¯ç§’å¹³å‡è¯·æ±‚æ•°
total_requests=$(wc -l < /var/log/nginx/access.log)
time_span=3600  # å‡è®¾æ—¥å¿—æ¶µç›–1å°æ—¶
rps=$(echo "scale=2; $total_requests / $time_span" | bc)
echo "å¹³å‡RPS: $rps"
```

### 6.4 å®æ—¶æ€§èƒ½ç›‘æ§è„šæœ¬


**ğŸ”§ æ€§èƒ½ç›‘æ§è„šæœ¬ç¤ºä¾‹**ï¼š

```bash
#!/bin/bash
# web_performance_monitor.sh

LOG_FILE="/var/log/nginx/access.log"
ALERT_THRESHOLD=2.0  # å“åº”æ—¶é—´å‘Šè­¦é˜ˆå€¼ï¼ˆç§’ï¼‰

# è·å–æœ€è¿‘5åˆ†é’Ÿçš„æ—¥å¿—
recent_logs=$(tail -n 1000 $LOG_FILE | \
awk -v time=$(date -d '5 minutes ago' +%s) \
'BEGIN{OFS="\t"} {
    # è§£ææ—¶é—´æˆ³
    gsub(/\[|\]/, "", $4)
    split($4, dt, ":")
    timestamp = mktime(gensub(/\//, " ", "g", dt[1]) " " dt[2] " " dt[3] " " dt[4])
    if (timestamp > time) print $0
}')

# è®¡ç®—æ€§èƒ½æŒ‡æ ‡
echo "$recent_logs" | awk -v threshold=$ALERT_THRESHOLD '
{
    total++
    response_time = $NF
    sum_time += response_time
    
    if ($9 >= 400) errors++
    if (response_time > threshold) slow_requests++
}
END {
    if (total > 0) {
        avg_time = sum_time / total
        error_rate = (errors / total) * 100
        slow_rate = (slow_requests / total) * 100
        
        printf "=== æ€§èƒ½æŠ¥å‘Š (æœ€è¿‘5åˆ†é’Ÿ) ===\n"
        printf "æ€»è¯·æ±‚æ•°: %d\n", total
        printf "å¹³å‡å“åº”æ—¶é—´: %.3f ç§’\n", avg_time
        printf "é”™è¯¯ç‡: %.2f%%\n", error_rate
        printf "æ…¢è¯·æ±‚æ¯”ä¾‹: %.2f%%\n", slow_rate
        
        # å‘Šè­¦åˆ¤æ–­
        if (avg_time > threshold) {
            printf "âš ï¸ å‘Šè­¦: å¹³å‡å“åº”æ—¶é—´è¿‡é«˜!\n"
        }
        if (error_rate > 5) {
            printf "âš ï¸ å‘Šè­¦: é”™è¯¯ç‡è¿‡é«˜!\n"  
        }
    }
}'
```

### 6.5 æ€§èƒ½ç›‘æ§å¯è§†åŒ–


**ğŸ“ˆ æ€§èƒ½è¶‹åŠ¿å›¾è¡¨**ï¼š

```bash
# ç”Ÿæˆæ¯å°æ—¶æ€§èƒ½æŠ¥å‘Š
#!/bin/bash
# hourly_performance.sh

for hour in {00..23}; do
    echo "=== $hour:00 æ—¶æ®µ ==="
    
    # æå–è¯¥å°æ—¶çš„æ—¥å¿—
    grep "$(date +%d/%b/%Y):$hour:" /var/log/nginx/access.log | \
    awk '{
        total++
        if ($9 >= 400) errors++
        response_time = $NF
        sum_time += response_time
    }
    END {
        if (total > 0) {
            printf "è¯·æ±‚æ•°: %d, é”™è¯¯ç‡: %.2f%%, å¹³å‡å“åº”æ—¶é—´: %.3fs\n", 
                   total, (errors/total)*100, sum_time/total
        }
    }'
done
```

**ğŸ’¡ ç›‘æ§å‘Šè­¦å»ºè®®**ï¼š
```
å“åº”æ—¶é—´å‘Šè­¦ï¼š
âœ… æ­£å¸¸: < 0.5ç§’
âš ï¸ è­¦å‘Š: 0.5-2ç§’  
ğŸ”´ ä¸¥é‡: > 2ç§’

é”™è¯¯ç‡å‘Šè­¦ï¼š
âœ… æ­£å¸¸: < 1%
âš ï¸ è­¦å‘Š: 1-5%
ğŸ”´ ä¸¥é‡: > 5%

ååé‡ç›‘æ§ï¼š
- å¯¹æ¯”å†å²åŒæœŸæ•°æ®
- è®¾ç½®åŸºçº¿å€¼
- å¼‚å¸¸æ³¢åŠ¨åŠæ—¶å‘Šè­¦
```

---

## 7. ğŸ›¡ï¸ å¼‚å¸¸è®¿é—®æ£€æµ‹é˜²æŠ¤


### 7.1 ç†è§£å¼‚å¸¸è®¿é—®çš„ç±»å‹


**ğŸ’¡ ç®€å•ç†è§£**ï¼šå¼‚å¸¸è®¿é—®å°±åƒå°å·è¸©ç‚¹ï¼Œæœ‰ä¸€äº›å¯ç–‘çš„è¡Œä¸ºæ¨¡å¼ã€‚

```
æ­£å¸¸ç”¨æˆ·è®¿é—®ï¼š
æµè§ˆå‡ ä¸ªé¡µé¢ â†’ åœç•™ä¸€æ®µæ—¶é—´ â†’ æœ‰è§„å¾‹çš„ç‚¹å‡»

å¼‚å¸¸è®¿é—®ç‰¹å¾ï¼š
é¢‘ç¹è¯·æ±‚ â†’ çŸ­æ—¶é—´å¤§é‡è®¿é—® â†’ è®¿é—®æ•æ„Ÿè·¯å¾„
```

### 7.2 å¸¸è§å¼‚å¸¸è®¿é—®æ¨¡å¼


**ğŸ” å¼‚å¸¸è®¿é—®ç±»å‹è¯†åˆ«**ï¼š

```bash
# 1. é«˜é¢‘è®¿é—®æ£€æµ‹ï¼ˆå¯èƒ½æ˜¯çˆ¬è™«æˆ–æ”»å‡»ï¼‰
awk '{print $1}' /var/log/nginx/access.log | \
sort | uniq -c | sort -nr | head -10 | \
awk '$1 > 1000 {printf "âš ï¸ IP %s è®¿é—® %d æ¬¡ï¼ˆå¯ç–‘ï¼‰\n", $2, $1}'

# 2. 404æ‰«ææ£€æµ‹ï¼ˆå¯èƒ½åœ¨å¯»æ‰¾æ¼æ´ï¼‰
awk '$9==404 {print $1, $7}' /var/log/nginx/access.log | \
sort | uniq -c | sort -nr | head -20 | \
awk '$1 > 50 {printf "ğŸ” IP %s äº§ç”Ÿ %d ä¸ª404é”™è¯¯\n", $2, $1}'

# 3. æ•æ„Ÿè·¯å¾„è®¿é—®æ£€æµ‹
grep -E "(admin|login|wp-admin|phpMyAdmin)" /var/log/nginx/access.log | \
awk '{print $1, $7}' | sort | uniq -c | sort -nr | \
awk '{printf "ğŸš¨ IP %s è®¿é—®æ•æ„Ÿè·¯å¾„ %s %d æ¬¡\n", $2, $3, $1}'
```

### 7.3 è‡ªåŠ¨åŒ–å¼‚å¸¸æ£€æµ‹è„šæœ¬


**ğŸ”§ å¼‚å¸¸è®¿é—®æ£€æµ‹è„šæœ¬**ï¼š

```bash
#!/bin/bash
# anomaly_detection.sh

LOG_FILE="/var/log/nginx/access.log"
TEMP_DIR="/tmp/security_check"
DATE=$(date +%Y%m%d)

mkdir -p $TEMP_DIR

echo "ğŸ” å¼€å§‹å¼‚å¸¸è®¿é—®æ£€æµ‹..."

# 1. æ£€æµ‹é«˜é¢‘IPè®¿é—®
echo "=== é«˜é¢‘è®¿é—®IPæ£€æµ‹ ==="
awk '{print $1}' $LOG_FILE | sort | uniq -c | sort -nr | \
awk '$1 > 1000 {
    printf "âš ï¸ IP: %s, è®¿é—®æ¬¡æ•°: %d\n", $2, $1
    print $2 >> "'$TEMP_DIR'/suspicious_ips.txt"
}'

# 2. æ£€æµ‹å¼‚å¸¸User-Agent
echo "=== å¼‚å¸¸User-Agentæ£€æµ‹ ==="
awk -F'"' '{print $6}' $LOG_FILE | sort | uniq -c | sort -nr | \
awk '$1 > 500 && ($2 == "" || length($2) < 10) {
    printf "ğŸ¤– å¯ç–‘User-Agent: %s (å‡ºç°%dæ¬¡)\n", $2, $1
}'

# 3. æ£€æµ‹SQLæ³¨å…¥å°è¯•
echo "=== SQLæ³¨å…¥æ£€æµ‹ ==="
grep -i -E "(union|select|insert|delete|drop|script)" $LOG_FILE | \
awk '{print $1, $7}' | sort | uniq -c | \
awk '{printf "ğŸ’‰ å¯èƒ½çš„SQLæ³¨å…¥: IP %s, URL %s, å°è¯• %d æ¬¡\n", $2, $3, $1}'

# 4. æ£€æµ‹æš´åŠ›ç ´è§£å°è¯•
echo "=== æš´åŠ›ç ´è§£æ£€æµ‹ ==="
grep -E "(login|auth|signin)" $LOG_FILE | awk '$9 >= 400' | \
awk '{print $1}' | sort | uniq -c | sort -nr | \
awk '$1 > 100 {printf "ğŸ”“ æš´åŠ›ç ´è§£å°è¯•: IP %s, å¤±è´¥ %d æ¬¡\n", $2, $1}'

# 5. ç”Ÿæˆå°ç¦IPåˆ—è¡¨
if [ -f "$TEMP_DIR/suspicious_ips.txt" ]; then
    echo "=== å»ºè®®å°ç¦IPåˆ—è¡¨ ==="
    sort -u "$TEMP_DIR/suspicious_ips.txt" | while read ip; do
        echo "iptables -A INPUT -s $ip -j DROP"
    done > "$TEMP_DIR/block_ips.sh"
    
    echo "ğŸ“ å°ç¦å‘½ä»¤å·²ç”Ÿæˆ: $TEMP_DIR/block_ips.sh"
fi
```

### 7.4 å®æ—¶é˜²æŠ¤é…ç½®


**ğŸ›¡ï¸ Nginxé™æµé…ç½®**ï¼š

```nginx
# åœ¨httpå—ä¸­å®šä¹‰é™æµåŒºåŸŸ
http {
    # é™åˆ¶æ¯ä¸ªIPæ¯ç§’æœ€å¤š10ä¸ªè¯·æ±‚
    limit_req_zone $binary_remote_addr zone=login:10m rate=10r/s;
    
    # é™åˆ¶æ¯ä¸ªIPæœ€å¤š100ä¸ªè¿æ¥
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    
    server {
        listen 80;
        server_name example.com;
        
        # å¯¹ç™»å½•é¡µé¢è¿›è¡Œä¸¥æ ¼é™æµ
        location /login {
            limit_req zone=login burst=5 nodelay;
            limit_conn addr 5;
            # å…¶ä»–é…ç½®...
        }
        
        # å¯¹APIæ¥å£è¿›è¡Œé™æµ
        location /api/ {
            limit_req zone=login burst=20 nodelay;
            # å…¶ä»–é…ç½®...
        }
    }
}
```

**ğŸ”§ fail2banè‡ªåŠ¨å°ç¦é…ç½®**ï¼š

```ini
# /etc/fail2ban/jail.local
[nginx-req-limit]
enabled = true
filter = nginx-req-limit
action = iptables-multiport[name=ReqLimit, port="http,https", protocol=tcp]
logpath = /var/log/nginx/error.log
findtime = 600
bantime = 7200
maxretry = 10
```

### 7.5 å®‰å…¨ç›‘æ§æœ€ä½³å®è·µ


**ğŸ“Š å®‰å…¨ç›‘æ§æŒ‡æ ‡**ï¼š

```bash
# æ¯æ—¥å®‰å…¨æŠ¥å‘Šç”Ÿæˆ
#!/bin/bash
# daily_security_report.sh

LOG_FILE="/var/log/nginx/access.log"
REPORT_DATE=$(date +%Y-%m-%d)

cat > "/tmp/security_report_$REPORT_DATE.txt" << EOF
==========================================
ç½‘ç«™å®‰å…¨æŠ¥å‘Š - $REPORT_DATE
==========================================

1. è®¿é—®ç»Ÿè®¡
æ€»è®¿é—®é‡: $(wc -l < $LOG_FILE)
ç‹¬ç«‹IPæ•°: $(awk '{print $1}' $LOG_FILE | sort -u | wc -l)

2. é”™è¯¯ç»Ÿè®¡  
4xxé”™è¯¯: $(awk '$9 >= 400 && $9 < 500' $LOG_FILE | wc -l)
5xxé”™è¯¯: $(awk '$9 >= 500' $LOG_FILE | wc -l)

3. å®‰å…¨äº‹ä»¶
å¯ç–‘IPæ•°é‡: $(awk '{print $1}' $LOG_FILE | sort | uniq -c | awk '$1 > 1000' | wc -l)
SQLæ³¨å…¥å°è¯•: $(grep -i -c -E "(union|select|insert|delete)" $LOG_FILE)
è·¯å¾„æ‰«æ: $(awk '$9==404' $LOG_FILE | wc -l)

4. å»ºè®®
$([ $(awk '{print $1}' $LOG_FILE | sort | uniq -c | awk '$1 > 1000' | wc -l) -gt 0 ] && echo "âš ï¸ å‘ç°å¯ç–‘é«˜é¢‘è®¿é—®IPï¼Œå»ºè®®æ£€æŸ¥" || echo "âœ… æ— å¼‚å¸¸é«˜é¢‘è®¿é—®")
$([ $(grep -i -c -E "(union|select|insert|delete)" $LOG_FILE) -gt 0 ] && echo "ğŸš¨ å‘ç°SQLæ³¨å…¥å°è¯•ï¼Œå»ºè®®åŠ å¼ºé˜²æŠ¤" || echo "âœ… æ— SQLæ³¨å…¥å°è¯•")
==========================================
EOF

echo "ğŸ“Š å®‰å…¨æŠ¥å‘Šå·²ç”Ÿæˆ: /tmp/security_report_$REPORT_DATE.txt"
```

**ğŸ’¡ é˜²æŠ¤ç­–ç•¥å»ºè®®**ï¼š
```
åŸºç¡€é˜²æŠ¤ï¼š
âœ… é…ç½®é˜²ç«å¢™è§„åˆ™
âœ… ä½¿ç”¨fail2banè‡ªåŠ¨å°ç¦
âœ… å®šæœŸæ›´æ–°æœåŠ¡å™¨è½¯ä»¶

é«˜çº§é˜²æŠ¤ï¼š  
ğŸ”’ éƒ¨ç½²Webåº”ç”¨é˜²ç«å¢™(WAF)
ğŸ” ä½¿ç”¨å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ(IDS)
ğŸ“Š å»ºç«‹å®‰å…¨ç›‘æ§å¹³å°
ğŸ¤– ä½¿ç”¨æœºå™¨å­¦ä¹ æ£€æµ‹å¼‚å¸¸
```

---

## 8. ğŸŒ æ—¥å¿—é›†ä¸­æ”¶é›†æ¶æ„


### 8.1 ç†è§£æ—¥å¿—é›†ä¸­æ”¶é›†çš„å¿…è¦æ€§


**ğŸ’¡ ç®€å•ç†è§£**ï¼šæ—¥å¿—é›†ä¸­æ”¶é›†å°±åƒå»ºè®¾å›¾ä¹¦é¦†ï¼ŒæŠŠåˆ†æ•£çš„ä¹¦ç±é›†ä¸­ç®¡ç†ã€‚

```
åˆ†æ•£å­˜å‚¨çš„é—®é¢˜ï¼š
æœåŠ¡å™¨Açš„æ—¥å¿— â†’ åªèƒ½åœ¨Aä¸ŠæŸ¥çœ‹
æœåŠ¡å™¨Bçš„æ—¥å¿— â†’ åªèƒ½åœ¨Bä¸ŠæŸ¥çœ‹  
æœåŠ¡å™¨Cçš„æ—¥å¿— â†’ åªèƒ½åœ¨Cä¸ŠæŸ¥çœ‹
é—®é¢˜ï¼šç®¡ç†å›°éš¾ï¼Œæ— æ³•ç»Ÿä¸€åˆ†æ

é›†ä¸­æ”¶é›†åï¼š
æ‰€æœ‰æœåŠ¡å™¨æ—¥å¿— â†’ ç»Ÿä¸€æ”¶é›† â†’ ä¸­å¤®å­˜å‚¨ â†’ ç»Ÿä¸€åˆ†æ
ä¼˜åŠ¿ï¼šä¾¿äºç®¡ç†ã€åˆ†æã€ç›‘æ§ã€å‘Šè­¦
```

### 8.2 æ—¥å¿—æ”¶é›†æ¶æ„è®¾è®¡


**ğŸ—ï¸ åŸºç¡€æ¶æ„ç»„ä»¶**ï¼š

```
æ—¥å¿—ç”Ÿäº§è€… (Log Producers):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebæœåŠ¡å™¨1  â”‚  â”‚  WebæœåŠ¡å™¨2  â”‚  â”‚  WebæœåŠ¡å™¨3  â”‚
â”‚   Nginx     â”‚  â”‚   Apache    â”‚  â”‚    Nginx    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                â”‚                â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
æ—¥å¿—æ”¶é›†å™¨ (Log Collectors):
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    Filebeat/      â”‚
              â”‚    Fluentd/       â”‚
              â”‚    Logstash       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
æ—¥å¿—å¤„ç†å™¨ (Log Processors):
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    Logstash/      â”‚
              â”‚    Fluentd        â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
æ—¥å¿—å­˜å‚¨ (Log Storage):
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Elasticsearch/   â”‚
              â”‚  MongoDB/         â”‚
              â”‚  InfluxDB         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
å¯è§†åŒ–åˆ†æ (Visualization):
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    Kibana/        â”‚
              â”‚    Grafana        â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 ELK Stackéƒ¨ç½²é…ç½®


**ğŸ”§ Elasticsearché…ç½®**ï¼š

```yaml
# elasticsearch.yml
cluster.name: web-logs-cluster
node.name: node-1
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: 0.0.0.0
http.port: 9200
discovery.type: single-node

# å†…å­˜è®¾ç½®
bootstrap.memory_lock: true
```

**ğŸ”§ Logstashé…ç½®**ï¼š

```ruby
# /etc/logstash/conf.d/nginx.conf
input {
  beats {
    port => 5044
  }
}

filter {
  if [fields][logtype] == "nginx-access" {
    grok {
      match => { 
        "message" => "%{NGINXACCESS}" 
      }
    }
    
    date {
      match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
    }
    
    mutate {
      convert => { 
        "response" => "integer"
        "bytes" => "integer"
        "responsetime" => "float"
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "nginx-logs-%{+YYYY.MM.dd}"
  }
}
```

**ğŸ”§ Filebeaté…ç½®**ï¼š

```yaml
# filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/nginx/access.log
  fields:
    logtype: nginx-access
  fields_under_root: true

- type: log
  enabled: true  
  paths:
    - /var/log/nginx/error.log
  fields:
    logtype: nginx-error
  fields_under_root: true

output.logstash:
  hosts: ["logstash-server:5044"]

processors:
- add_host_metadata:
    when.not.contains.tags: forwarded
```

### 8.4 è½»é‡çº§æ—¥å¿—æ”¶é›†æ–¹æ¡ˆ


**ğŸš€ Rsyslogé›†ä¸­æ”¶é›†**ï¼š

```bash
# åœ¨æ—¥å¿—æœåŠ¡å™¨ä¸Šé…ç½®rsyslogæ¥æ”¶
# /etc/rsyslog.conf
$ModLoad imudp
$UDPServerRun 514
$UDPServerAddress 0.0.0.0

# é…ç½®æ—¥å¿—å­˜å‚¨è·¯å¾„
$template RemoteLogs,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"
*.* ?RemoteLogs
& stop
```

```bash
# åœ¨WebæœåŠ¡å™¨ä¸Šé…ç½®å‘é€æ—¥å¿—
# /etc/rsyslog.d/nginx.conf
$ModLoad imfile

# Nginxè®¿é—®æ—¥å¿—
$InputFileName /var/log/nginx/access.log
$InputFileTag nginx-access:
$InputFileStateFile stat-nginx-access
$InputFileSeverity info
$InputFileFacility local0
$InputRunFileMonitor

# å‘é€åˆ°è¿œç¨‹æœåŠ¡å™¨
local0.* $$log-server:514
```

### 8.5 Dockerç¯å¢ƒæ—¥å¿—æ”¶é›†


**ğŸ³ Docker Composeæ—¥å¿—é…ç½®**ï¼š

```yaml
# docker-compose.yml
version: '3.8'
services:
  nginx:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "nginx.access"

  fluentd:
    build: ./fluentd
    ports:
      - "24224:24224"
    volumes:
      - ./fluentd/conf:/fluentd/etc
    depends_on:
      - elasticsearch

  elasticsearch:
    image: elasticsearch:7.14.0
    environment:
      - discovery.type=single-node
    ports:
      - "9200:9200"

  kibana:
    image: kibana:7.14.0
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
```

**ğŸ”§ Fluentdé…ç½®**ï¼š

```xml
# fluentd/conf/fluent.conf
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<filter nginx.access>
  @type parser
  format nginx
  key_name log
</filter>

<match nginx.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  index_name nginx-logs
  type_name nginx
</match>
```

### 8.6 æ—¥å¿—æ”¶é›†æ€§èƒ½ä¼˜åŒ–


**âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š

```bash
# 1. ä½¿ç”¨SSDå­˜å‚¨æ—¥å¿—
# 2. é…ç½®æ—¥å¿—ç¼“å†²åŒº
# /etc/filebeat/filebeat.yml
output.logstash:
  hosts: ["logstash:5044"]
  bulk_max_size: 2048
  template.settings:
    index.number_of_shards: 1
    index.number_of_replicas: 0

# 3. Logstashæ€§èƒ½è°ƒä¼˜
# /etc/logstash/jvm.options
-Xms2g
-Xmx2g

# /etc/logstash/logstash.yml
pipeline.workers: 4
pipeline.batch.size: 1000
pipeline.batch.delay: 50
```

**ğŸ“Š ç›‘æ§æ”¶é›†çŠ¶æ€**ï¼š

```bash
#!/bin/bash
# monitor_log_collection.sh

echo "=== æ—¥å¿—æ”¶é›†çŠ¶æ€ç›‘æ§ ==="

# æ£€æŸ¥FilebeatçŠ¶æ€
if systemctl is-active --quiet filebeat; then
    echo "âœ… Filebeatè¿è¡Œæ­£å¸¸"
else
    echo "âŒ FilebeatæœåŠ¡å¼‚å¸¸"
fi

# æ£€æŸ¥æ—¥å¿—ä¼ è¾“å»¶è¿Ÿ
last_log_time=$(tail -1 /var/log/nginx/access.log | awk '{print $4}' | tr -d '[]')
current_time=$(date +"%d/%b/%Y:%H:%M:%S")

echo "ğŸ“Š æœ€æ–°æ—¥å¿—æ—¶é—´: $last_log_time"
echo "ğŸ“Š å½“å‰æ—¶é—´: $current_time"

# æ£€æŸ¥ElasticsearchçŠ¶æ€
es_status=$(curl -s "http://localhost:9200/_cluster/health" | jq -r '.status')
echo "ğŸ“Š ElasticsearchçŠ¶æ€: $es_status"

# æ£€æŸ¥ä»Šæ—¥æ—¥å¿—é‡
today=$(date +%Y.%m.%d)
log_count=$(curl -s "http://localhost:9200/nginx-logs-$today/_count" | jq '.count')
echo "ğŸ“Š ä»Šæ—¥æ—¥å¿—é‡: $log_count æ¡"
```

---

## 9. ğŸš¨ ç›‘æ§å‘Šè­¦é…ç½®å®è·µ


### 9.1 ç†è§£ç›‘æ§å‘Šè­¦çš„é‡è¦æ€§


**ğŸ’¡ ç®€å•ç†è§£**ï¼šç›‘æ§å‘Šè­¦å°±åƒå®¶é‡Œçš„çƒŸé›¾æŠ¥è­¦å™¨ï¼ŒåŠæ—¶å‘ç°é—®é¢˜å¹¶é€šçŸ¥ä½ ã€‚

```
æ²¡æœ‰ç›‘æ§å‘Šè­¦ï¼š
é—®é¢˜å‘ç”Ÿ â†’ ç”¨æˆ·æŠ•è¯‰ â†’ è¢«åŠ¨å‘ç° â†’ å½±å“æ‰©å¤§

æœ‰ç›‘æ§å‘Šè­¦ï¼š
é—®é¢˜å‘ç”Ÿ â†’ ç³»ç»Ÿå‘Šè­¦ â†’ ä¸»åŠ¨å‘ç° â†’ å¿«é€Ÿè§£å†³
```

### 9.2 å‘Šè­¦æŒ‡æ ‡ä½“ç³»è®¾è®¡


**ğŸ¯ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**ï¼š

```
å¯ç”¨æ€§æŒ‡æ ‡ï¼š
- æœåŠ¡æ˜¯å¦å¯è®¿é—®
- HTTPçŠ¶æ€ç åˆ†å¸ƒ
- é”™è¯¯ç‡é˜ˆå€¼

æ€§èƒ½æŒ‡æ ‡ï¼š
- å“åº”æ—¶é—´
- ååé‡
- å¹¶å‘è¿æ¥æ•°

èµ„æºæŒ‡æ ‡ï¼š
- CPUä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡  
- ç£ç›˜ç©ºé—´
- ç½‘ç»œå¸¦å®½

ä¸šåŠ¡æŒ‡æ ‡ï¼š
- ç”¨æˆ·è®¿é—®é‡
- å…³é”®ä¸šåŠ¡æµç¨‹
- è½¬åŒ–ç‡
```

### 9.3 åŸºäºæ—¥å¿—çš„å‘Šè­¦é…ç½®


**ğŸ”§ ç®€å•shellè„šæœ¬å‘Šè­¦**ï¼š

```bash
#!/bin/bash
# web_alert.sh

LOG_FILE="/var/log/nginx/access.log"
ERROR_LOG="/var/log/nginx/error.log"
ALERT_EMAIL="admin@example.com"
THRESHOLD_ERROR_RATE=5  # é”™è¯¯ç‡è¶…è¿‡5%å‘Šè­¦
THRESHOLD_RESPONSE_TIME=2.0  # å“åº”æ—¶é—´è¶…è¿‡2ç§’å‘Šè­¦

# æ£€æŸ¥æœ€è¿‘5åˆ†é’Ÿçš„æ—¥å¿—
check_recent_logs() {
    local time_threshold=$(date -d '5 minutes ago' +%s)
    
    # è·å–æœ€è¿‘5åˆ†é’Ÿçš„è®¿é—®æ—¥å¿—
    recent_logs=$(tail -n 1000 $LOG_FILE | awk -v threshold=$time_threshold '
    {
        # ç®€åŒ–æ—¶é—´è§£æï¼Œè¿™é‡Œç”¨è¡Œæ•°ä¼°ç®—
        print $0
    }' | tail -n 200)
    
    # è®¡ç®—é”™è¯¯ç‡
    total_requests=$(echo "$recent_logs" | wc -l)
    error_requests=$(echo "$recent_logs" | awk '$9 >= 400' | wc -l)
    
    if [ $total_requests -gt 0 ]; then
        error_rate=$(echo "scale=2; $error_requests * 100 / $total_requests" | bc)
        
        # æ£€æŸ¥é”™è¯¯ç‡å‘Šè­¦
        if (( $(echo "$error_rate > $THRESHOLD_ERROR_RATE" | bc -l) )); then
            send_alert "é”™è¯¯ç‡å‘Šè­¦" "å½“å‰é”™è¯¯ç‡: ${error_rate}%, è¶…è¿‡é˜ˆå€¼: ${THRESHOLD_ERROR_RATE}%"
        fi
        
        # æ£€æŸ¥å“åº”æ—¶é—´
        avg_response_time=$(echo "$recent_logs" | awk '{sum+=$NF; count++} END {if(count>0) print sum/count; else print 0}')
        
        if (( $(echo "$avg_response_time > $THRESHOLD_RESPONSE_TIME" | bc -l) )); then
            send_alert "å“åº”æ—¶é—´å‘Šè­¦" "å¹³å‡å“åº”æ—¶é—´: ${avg_response_time}s, è¶…è¿‡é˜ˆå€¼: ${THRESHOLD_RESPONSE_TIME}s"
        fi
    fi
}

# å‘é€å‘Šè­¦
send_alert() {
    local subject="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    echo "[$timestamp] ğŸš¨ $subject: $message" | tee -a /var/log/web_alerts.log
    
    # å‘é€é‚®ä»¶å‘Šè­¦ï¼ˆéœ€è¦é…ç½®é‚®ä»¶æœåŠ¡ï¼‰
    echo "$message" | mail -s "[$timestamp] $subject" $ALERT_EMAIL
    
    # å‘é€åˆ°ä¼ä¸šå¾®ä¿¡/é’‰é’‰ç­‰ï¼ˆå¯é€‰ï¼‰
    # curl -X POST "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY" \
    #      -H 'Content-Type: application/json' \
    #      -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"$subject: $message\"}}"
}

# æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§
check_service_availability() {
    local urls=("http://localhost" "http://localhost/api/health")
    
    for url in "${urls[@]}"; do
        if ! curl -f -s --max-time 10 "$url" > /dev/null; then
            send_alert "æœåŠ¡ä¸å¯ç”¨" "æ— æ³•è®¿é—®: $url"
        fi
    done
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space() {
    local usage=$(df /var/log | awk 'NR==2 {print $5}' | sed 's/%//')
    
    if [ $usage -gt 80 ]; then
        send_alert "ç£ç›˜ç©ºé—´å‘Šè­¦" "æ—¥å¿—åˆ†åŒºä½¿ç”¨ç‡: ${usage}%, è¶…è¿‡80%"
    fi
}

# æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
main() {
    echo "ğŸ” å¼€å§‹ç›‘æ§æ£€æŸ¥..."
    check_service_availability
    check_recent_logs
    check_disk_space
    echo "âœ… ç›‘æ§æ£€æŸ¥å®Œæˆ"
}

main
```

### 9.4 Zabbixç›‘æ§é…ç½®


**ğŸ”§ Zabbixç”¨æˆ·å‚æ•°é…ç½®**ï¼š

```bash
# /etc/zabbix/zabbix_agentd.d/nginx.conf
UserParameter=nginx.status[*],curl -s "http://localhost/nginx_status" | grep "$1" | awk '{print $$NF}'
UserParameter=nginx.error.rate,awk 'BEGIN{total=0;errors=0} {total++;if($$9>=400) errors++} END{if(total>0) print errors/total*100; else print 0}' /var/log/nginx/access.log
UserParameter=nginx.response.time,awk '{sum+=$$NF; count++} END {if(count>0) print sum/count; else print 0}' /var/log/nginx/access.log
UserParameter=nginx.requests.per.second,expr $(tail -n 100 /var/log/nginx/access.log | wc -l) / 60
```

**ğŸ“Š Zabbixç›‘æ§é¡¹é…ç½®**ï¼š
```
ç›‘æ§é¡¹åç§°: Nginxé”™è¯¯ç‡
é”®å€¼: nginx.error.rate
ç±»å‹: Zabbixå®¢æˆ·ç«¯
æ•°æ®ç±»å‹: æ•°å­—(æµ®ç‚¹)
å•ä½: %
æ›´æ–°é—´éš”: 1m

è§¦å‘å™¨è¡¨è¾¾å¼: {host:nginx.error.rate.last()}>5
ä¸¥é‡æ€§: é«˜
```

### 9.5 Prometheus + Grafanaç›‘æ§


**ğŸ”§ nginx-prometheus-exporteré…ç½®**ï¼š

```bash
# å®‰è£…nginx-prometheus-exporter
docker run -p 9113:9113 nginx/nginx-prometheus-exporter:latest \
  -nginx.scrape-uri=http://nginx:8080/nginx_status
```

**ğŸ“ˆ Prometheusé…ç½®**ï¼š
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'nginx'
    static_configs:
      - targets: ['nginx-exporter:9113']
    scrape_interval: 10s

rule_files:
  - "nginx_alerts.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - "alertmanager:9093"
```

**ğŸš¨ å‘Šè­¦è§„åˆ™é…ç½®**ï¼š
```yaml
# nginx_alerts.yml
groups:
- name: nginx_alerts
  rules:
  - alert: NginxHighErrorRate
    expr: rate(nginx_http_requests_total{status=~"5.."}[5m]) / rate(nginx_http_requests_total[5m]) * 100 > 5
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Nginx error rate is high"
      description: "Nginx error rate is {{ $value }}% for more than 2 minutes"

  - alert: NginxHighResponseTime
    expr: nginx_http_request_duration_seconds_avg > 2
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "Nginx response time is high"
      description: "Nginx average response time is {{ $value }}s"

  - alert: NginxDown
    expr: up{job="nginx"} == 0
    for: 30s
    labels:
      severity: critical
    annotations:
      summary: "Nginx is down"
      description: "Nginx has been down for more than 30 seconds"
```

### 9.6 æ™ºèƒ½å‘Šè­¦ç­–ç•¥


**ğŸ§  å‘Šè­¦é™å™ªç­–ç•¥**ï¼š

```bash
#!/bin/bash
# smart_alert.sh

ALERT_STATE_FILE="/tmp/alert_states"
ALERT_COOLDOWN=300  # 5åˆ†é’Ÿå†·å´æ—¶é—´

# æ™ºèƒ½å‘Šè­¦å‡½æ•°
smart_alert() {
    local alert_key="$1"
    local alert_message="$2"
    local current_time=$(date +%s)
    
    # æ£€æŸ¥å‘Šè­¦çŠ¶æ€æ–‡ä»¶
    if [ -f "$ALERT_STATE_FILE" ]; then
        last_alert_time=$(grep "^$alert_key:" "$ALERT_STATE_FILE" | cut -d: -f2)
        
        if [ -n "$last_alert_time" ]; then
            time_diff=$((current_time - last_alert_time))
            
            # å¦‚æœåœ¨å†·å´æ—¶é—´å†…ï¼Œä¸å‘é€å‘Šè­¦
            if [ $time_diff -lt $ALERT_COOLDOWN ]; then
                echo "â° å‘Šè­¦ $alert_key åœ¨å†·å´æœŸå†…ï¼Œè·³è¿‡å‘é€"
                return
            fi
        fi
    fi
    
    # å‘é€å‘Šè­¦
    echo "ğŸš¨ $alert_message"
    
    # è®°å½•å‘Šè­¦æ—¶é—´
    grep -v "^$alert_key:" "$ALERT_STATE_FILE" 2>/dev/null > "${ALERT_STATE_FILE}.tmp" || touch "${ALERT_STATE_FILE}.tmp"
    echo "$alert_key:$current_time" >> "${ALERT_STATE_FILE}.tmp"
    mv "${ALERT_STATE_FILE}.tmp" "$ALERT_STATE_FILE"
}

# å‘Šè­¦æ¢å¤é€šçŸ¥
alert_recovery() {
    local alert_key="$1"
    local recovery_message="$2"
    
    if grep -q "^$alert_key:" "$ALERT_STATE_FILE" 2>/dev/null; then
        echo "âœ… $recovery_message"
        grep -v "^$alert_key:" "$ALERT_STATE_FILE" > "${ALERT_STATE_FILE}.tmp"
        mv "${ALERT_STATE_FILE}.tmp" "$ALERT_STATE_FILE"
    fi
}
```

**ğŸ“Š å‘Šè­¦ç»Ÿè®¡å’Œä¼˜åŒ–**ï¼š

```bash
#!/bin/bash
# alert_analysis.sh

ALERT_LOG="/var/log/web_alerts.log"

echo "=== å‘Šè­¦ç»Ÿè®¡åˆ†æ ==="

# ç»Ÿè®¡å‘Šè­¦é¢‘ç‡
echo "ğŸ“Š å‘Šè­¦ç±»å‹ç»Ÿè®¡:"
grep "ğŸš¨" "$ALERT_LOG" | awk '{
    for(i=4; i<=NF; i++) {
        if($i ~ /å‘Šè­¦$/) {
            alerts[$(i-1) " " $i]++
            break
        }
    }
}
END {
    for(alert in alerts) {
        printf "  %s: %d æ¬¡\n", alert, alerts[alert]
    }
}' | sort -k2 -nr

# åˆ†æå‘Šè­¦æ—¶é—´åˆ†å¸ƒ
echo "ğŸ“ˆ å‘Šè­¦æ—¶é—´åˆ†å¸ƒ:"
grep "ğŸš¨" "$ALERT_LOG" | awk '{
    split($2, time, ":")
    hour = time[1]
    hours[hour]++
}
END {
    for(h=0; h<24; h++) {
        printf "  %02d:00-%02d:59: %d æ¬¡\n", h, h, hours[sprintf("%02d", h)]+0
    }
}' | grep -v ": 0 æ¬¡$"

# å»ºè®®ä¼˜åŒ–æ–¹æ¡ˆ
echo "ğŸ’¡ ä¼˜åŒ–å»ºè®®:"
echo "  - è°ƒæ•´å‘Šè­¦é˜ˆå€¼ï¼Œå‡å°‘è¯¯æŠ¥"
echo "  - å¢åŠ å‘Šè­¦å†·å´æ—¶é—´"
echo "  - å…³æ³¨é«˜é¢‘å‘Šè­¦çš„æ ¹æœ¬åŸå› "
echo "  - å»ºç«‹å‘Šè­¦åˆ†çº§å¤„ç†æœºåˆ¶"
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ—¥å¿—ç±»å‹ï¼šè®¿é—®æ—¥å¿—è®°å½•ç”¨æˆ·è¯·æ±‚ï¼Œé”™è¯¯æ—¥å¿—è®°å½•ç³»ç»Ÿé—®é¢˜
ğŸ”¸ æ—¥å¿—æ ¼å¼ï¼šæ ¹æ®éœ€æ±‚å®šåˆ¶ï¼Œå¹³è¡¡è¯¦ç»†ç¨‹åº¦å’Œæ€§èƒ½
ğŸ”¸ æ—¥å¿—è½®è½¬ï¼šé˜²æ­¢æ–‡ä»¶è¿‡å¤§ï¼Œå®šæœŸå‹ç¼©å’Œæ¸…ç†
ğŸ”¸ æ€§èƒ½æŒ‡æ ‡ï¼šå“åº”æ—¶é—´ã€ååé‡ã€é”™è¯¯ç‡æ˜¯å…³é”®æŒ‡æ ‡
ğŸ”¸ å®‰å…¨é˜²æŠ¤ï¼šé€šè¿‡æ—¥å¿—åˆ†æè¯†åˆ«å¼‚å¸¸è®¿é—®å’Œæ”»å‡»è¡Œä¸º
ğŸ”¸ é›†ä¸­æ”¶é›†ï¼šç»Ÿä¸€ç®¡ç†å¤šæœåŠ¡å™¨æ—¥å¿—ï¼Œä¾¿äºåˆ†æ
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šåŠæ—¶å‘ç°é—®é¢˜ï¼Œå¿«é€Ÿå“åº”å’Œå¤„ç†
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ—¥å¿—ç®¡ç†çš„ä»·å€¼**ï¼š
```
æ•…éšœæ’æŸ¥ï¼š
- é€šè¿‡é”™è¯¯æ—¥å¿—å¿«é€Ÿå®šä½é—®é¢˜æ ¹å› 
- é€šè¿‡è®¿é—®æ—¥å¿—åˆ†æç”¨æˆ·è¡Œä¸ºæ¨¡å¼
- é‡ç°é—®é¢˜åœºæ™¯ï¼ŒéªŒè¯è§£å†³æ–¹æ¡ˆ

æ€§èƒ½ä¼˜åŒ–ï¼š
- è¯†åˆ«æ…¢æŸ¥è¯¢å’Œæ€§èƒ½ç“¶é¢ˆ
- åˆ†æè®¿é—®çƒ­ç‚¹ï¼Œä¼˜åŒ–èµ„æºé…ç½®
- ç›‘æ§è¶‹åŠ¿å˜åŒ–ï¼Œé¢„é˜²æ€§èƒ½é—®é¢˜

å®‰å…¨é˜²æŠ¤ï¼š
- æ£€æµ‹æ¶æ„æ”»å‡»å’Œå¼‚å¸¸è®¿é—®
- è¿½è¸ªå®‰å…¨äº‹ä»¶çš„æ¥æºå’Œå½±å“
- å»ºç«‹å®‰å…¨åŸºçº¿ï¼ŒåŠæ—¶å‘ç°å¨èƒ
```

**ğŸ”¹ å·¥å…·é€‰æ‹©åŸåˆ™**ï¼š
```
å°è§„æ¨¡ç½‘ç«™ï¼š
- ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦å·¥å…·ï¼ˆawkã€grepã€tailï¼‰
- é…ç½®ç®€å•çš„è½®è½¬å’Œå‘Šè­¦è„šæœ¬
- æˆæœ¬ä½ï¼Œæ»¡è¶³åŸºæœ¬éœ€æ±‚

ä¸­ç­‰è§„æ¨¡ç½‘ç«™ï¼š
- éƒ¨ç½²ä¸“ä¸šæ—¥å¿—åˆ†æå·¥å…·ï¼ˆAWStatsã€GoAccessï¼‰
- ä½¿ç”¨é›†ä¸­æ”¶é›†æ–¹æ¡ˆï¼ˆELK Stackï¼‰
- å»ºç«‹å®Œå–„çš„ç›‘æ§å‘Šè­¦ä½“ç³»

å¤§è§„æ¨¡ç½‘ç«™ï¼š
- ä½¿ç”¨åˆ†å¸ƒå¼æ—¥å¿—å¤„ç†å¹³å°
- å®ç°å®æ—¶æµå¤„ç†å’Œåˆ†æ
- é›†æˆæœºå™¨å­¦ä¹ å¼‚å¸¸æ£€æµ‹
- å»ºç«‹å¤šå±‚æ¬¡ç›‘æ§ä½“ç³»
```

**ğŸ”¹ é…ç½®ä¼˜åŒ–ç­–ç•¥**ï¼š
```
æ€§èƒ½è€ƒè™‘ï¼š
- åˆç†è®¾ç½®æ—¥å¿—çº§åˆ«ï¼Œé¿å…è¿‡åº¦è®°å½•
- ä½¿ç”¨å¼‚æ­¥å†™å…¥ï¼Œå‡å°‘å¯¹æœåŠ¡æ€§èƒ½çš„å½±å“
- å®šæœŸæ¸…ç†å’Œå‹ç¼©ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´

å®‰å…¨è€ƒè™‘ï¼š
- é¿å…è®°å½•æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€ä¸ªäººä¿¡æ¯ï¼‰
- è®¾ç½®é€‚å½“çš„æ–‡ä»¶æƒé™ï¼Œé˜²æ­¢æœªæˆæƒè®¿é—®
- å¯¹æ—¥å¿—ä¼ è¾“è¿›è¡ŒåŠ å¯†ï¼Œä¿æŠ¤æ•°æ®å®‰å…¨

è¿ç»´è€ƒè™‘ï¼š
- å»ºç«‹æ ‡å‡†åŒ–çš„æ—¥å¿—æ ¼å¼
- ç»Ÿä¸€æ—¶é—´åŒæ­¥ï¼Œä¾¿äºå…³è”åˆ†æ
- åˆ¶å®šåº”æ€¥å“åº”æµç¨‹ï¼Œå¿«é€Ÿå¤„ç†å‘Šè­¦
```

### 10.3 å®æˆ˜åº”ç”¨æŒ‡å¯¼


**ğŸ“Š æ—¥å¿—åˆ†æå®è·µæµç¨‹**ï¼š
```
æ—¥å¸¸ç›‘æ§ï¼š
1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼Œå…³æ³¨å¼‚å¸¸ä¿¡æ¯
2. åˆ†æè®¿é—®è¶‹åŠ¿ï¼Œè¯†åˆ«å¼‚å¸¸æµé‡
3. ç›‘æ§æ€§èƒ½æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
4. æ£€æŸ¥å®‰å…¨äº‹ä»¶ï¼Œé˜²èŒƒæ”»å‡»é£é™©

é—®é¢˜æ’æŸ¥ï¼š
1. æ ¹æ®æ—¶é—´ç‚¹å®šä½ç›¸å…³æ—¥å¿—
2. ç»“åˆè®¿é—®æ—¥å¿—å’Œé”™è¯¯æ—¥å¿—åˆ†æ
3. è¿½è¸ªè¯·æ±‚é“¾è·¯ï¼Œæ‰¾å‡ºé—®é¢˜æ ¹å› 
4. éªŒè¯ä¿®å¤æ•ˆæœï¼Œé˜²æ­¢é—®é¢˜å¤å‘

æ€§èƒ½è°ƒä¼˜ï¼š
1. åˆ†ææ…¢è¯·æ±‚ï¼Œæ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆ
2. ç»Ÿè®¡èµ„æºä½¿ç”¨ï¼Œä¼˜åŒ–é…ç½®å‚æ•°
3. è¯†åˆ«çƒ­ç‚¹æ•°æ®ï¼Œè°ƒæ•´ç¼“å­˜ç­–ç•¥
4. ç›‘æ§ä¼˜åŒ–æ•ˆæœï¼ŒæŒç»­æ”¹è¿›
```

**ğŸ”§ å¸¸ç”¨æ—¥å¿—åˆ†æå‘½ä»¤é€ŸæŸ¥**ï¼š
```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/nginx/access.log

# ç»Ÿè®¡çŠ¶æ€ç åˆ†å¸ƒ
awk '{print $9}' access.log | sort | uniq -c | sort -nr

# æŸ¥æ‰¾ç‰¹å®šæ—¶é—´æ®µçš„æ—¥å¿—
awk '$4 >= "[15/Jan/2025:10:00:00" && $4 <= "[15/Jan/2025:11:00:00"' access.log

# ç»Ÿè®¡è®¿é—®é‡æœ€å¤§çš„IP
awk '{print $1}' access.log | sort | uniq -c | sort -nr | head -10

# æŸ¥æ‰¾404é”™è¯¯æœ€å¤šçš„URL
awk '$9==404 {print $7}' access.log | sort | uniq -c | sort -nr | head -10

# è®¡ç®—å¹³å‡å“åº”æ—¶é—´
awk '{sum+=$NF; count++} END {print "å¹³å‡å“åº”æ—¶é—´:", sum/count "ç§’"}' access.log
```

**ğŸ’¡ æ•…éšœå¤„ç†æœ€ä½³å®è·µ**ï¼š
```
å‘Šè­¦å“åº”æµç¨‹ï¼š
1. ğŸ“± æ”¶åˆ°å‘Šè­¦ â†’ ç«‹å³ç¡®è®¤é—®é¢˜çœŸå®æ€§
2. ğŸ” å¿«é€Ÿå®šä½ â†’ æŸ¥çœ‹ç›¸å…³æ—¥å¿—å’Œç›‘æ§æ•°æ®
3. ğŸš¨ è¯„ä¼°å½±å“ â†’ åˆ¤æ–­é—®é¢˜ä¸¥é‡ç¨‹åº¦å’Œå½±å“èŒƒå›´
4. ğŸ”§ ç´§æ€¥å¤„ç† â†’ é‡‡å–ä¸´æ—¶æªæ–½æ¢å¤æœåŠ¡
5. ğŸ¯ æ ¹å› åˆ†æ â†’ æ·±å…¥åˆ†æé—®é¢˜äº§ç”ŸåŸå› 
6. ğŸ“ æ€»ç»“æ”¹è¿› â†’ è®°å½•å¤„ç†è¿‡ç¨‹ï¼Œå®Œå–„é¢„é˜²æªæ–½

å¸¸è§é—®é¢˜å¤„ç†ï¼š
æœåŠ¡ä¸å¯ç”¨ï¼š
- æ£€æŸ¥è¿›ç¨‹çŠ¶æ€å’Œç«¯å£ç›‘å¬
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—æ‰¾å‡ºå…·ä½“åŸå› 
- é‡å¯æœåŠ¡æˆ–ä¿®å¤é…ç½®é—®é¢˜

å“åº”æ—¶é—´æ…¢ï¼š
- åˆ†ææ…¢è¯·æ±‚çš„å…±åŒç‰¹å¾
- æ£€æŸ¥æ•°æ®åº“å’Œåç«¯æœåŠ¡çŠ¶æ€
- ä¼˜åŒ–åº”ç”¨ä»£ç æˆ–å¢åŠ ç¼“å­˜

é”™è¯¯ç‡é«˜ï¼š
- ç»Ÿè®¡é”™è¯¯ç±»å‹å’Œåˆ†å¸ƒ
- æ£€æŸ¥é…ç½®æ–‡ä»¶å’Œæƒé™è®¾ç½®
- åˆ†ææ˜¯å¦ä¸ºå¤–éƒ¨æ”»å‡»æˆ–ç³»ç»Ÿæ•…éšœ
```

### 10.4 è¿›é˜¶å­¦ä¹ è·¯å¾„


**ğŸ“š æŠ€èƒ½æå‡å»ºè®®**ï¼š
```
åŸºç¡€é˜¶æ®µï¼š
âœ… ç†Ÿç»ƒä½¿ç”¨Linuxå‘½ä»¤è¡Œå·¥å…·åˆ†ææ—¥å¿—
âœ… æŒæ¡Nginx/Apacheæ—¥å¿—é…ç½®å’Œæ ¼å¼
âœ… äº†è§£åŸºæœ¬çš„æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•
âœ… å­¦ä¼šç¼–å†™ç®€å•çš„æ—¥å¿—åˆ†æè„šæœ¬

è¿›é˜¶é˜¶æ®µï¼š
ğŸ”¸ å­¦ä¹ ELK Stackçš„éƒ¨ç½²å’Œé…ç½®
ğŸ”¸ æŒæ¡Prometheuså’ŒGrafanaç›‘æ§
ğŸ”¸ äº†è§£æ—¥å¿—æ•°æ®çš„ç»Ÿè®¡åˆ†ææ–¹æ³•
ğŸ”¸ å­¦ä¹ è‡ªåŠ¨åŒ–è¿ç»´å’Œå‘Šè­¦ç­–ç•¥

é«˜çº§é˜¶æ®µï¼š
ğŸš€ æ·±å…¥ç ”ç©¶å¤§æ•°æ®æ—¥å¿—å¤„ç†æŠ€æœ¯
ğŸš€ å­¦ä¹ æœºå™¨å­¦ä¹ åœ¨å¼‚å¸¸æ£€æµ‹ä¸­çš„åº”ç”¨
ğŸš€ æŒæ¡åˆ†å¸ƒå¼æ—¥å¿—æ”¶é›†å’Œåˆ†ææ¶æ„
ğŸš€ äº†è§£æ—¥å¿—å®‰å…¨å’Œåˆè§„è¦æ±‚
```

**ğŸ¯ å®è·µé¡¹ç›®å»ºè®®**ï¼š
```
é¡¹ç›®ä¸€ï¼šæ­å»ºä¸ªäººç½‘ç«™æ—¥å¿—åˆ†æç³»ç»Ÿ
- éƒ¨ç½²Nginxå¹¶é…ç½®è®¿é—®æ—¥å¿—
- ç¼–å†™è„šæœ¬è‡ªåŠ¨åˆ†æè®¿é—®ç»Ÿè®¡
- é…ç½®æ—¥å¿—è½®è½¬å’Œå‘Šè­¦æœºåˆ¶

é¡¹ç›®äºŒï¼šä¼ä¸šçº§æ—¥å¿—ç›‘æ§å¹³å°
- éƒ¨ç½²ELK Stackæ”¶é›†å¤šæœåŠ¡å™¨æ—¥å¿—
- åˆ›å»ºKibanaä»ªè¡¨æ¿å±•ç¤ºå…³é”®æŒ‡æ ‡
- é…ç½®å‘Šè­¦è§„åˆ™å’Œé€šçŸ¥æœºåˆ¶

é¡¹ç›®ä¸‰ï¼šå®‰å…¨ç›‘æ§é˜²æŠ¤ç³»ç»Ÿ
- å¼€å‘å¼‚å¸¸è®¿é—®æ£€æµ‹è„šæœ¬
- é›†æˆfail2banè‡ªåŠ¨å°ç¦å¯ç–‘IP
- å»ºç«‹å®‰å…¨äº‹ä»¶å“åº”æµç¨‹
```

### 10.5 æ€»ç»“æ ¸å¿ƒè¦ç‚¹


> ğŸ’¡ **å…³é”®è®°å¿†å£è¯€**ï¼š
> 
> **æ—¥å¿—ç®¡ç†ä¸‰è¦ç´ **ï¼šæ”¶é›†ã€åˆ†æã€å‘Šè­¦
> 
> **æ€§èƒ½ç›‘æ§å››æŒ‡æ ‡**ï¼šå“åº”æ—¶é—´ã€ååé‡ã€é”™è¯¯ç‡ã€å¯ç”¨æ€§
> 
> **å®‰å…¨é˜²æŠ¤äº”æ­¥éª¤**ï¼šæ£€æµ‹ã€åˆ†æã€å‘Šè­¦ã€é˜»æ–­ã€å¤ç›˜

**ğŸ¯ å®é™…å·¥ä½œä¸­çš„åº”ç”¨ä»·å€¼**ï¼š
- **è¿ç»´äººå‘˜**ï¼šå¿«é€Ÿå®šä½å’Œè§£å†³ç³»ç»Ÿé—®é¢˜ï¼Œæå‡æœåŠ¡ç¨³å®šæ€§
- **å¼€å‘äººå‘˜**ï¼šåˆ†æåº”ç”¨æ€§èƒ½ï¼Œä¼˜åŒ–ä»£ç å’Œæ¶æ„è®¾è®¡
- **å®‰å…¨äººå‘˜**ï¼šè¯†åˆ«å®‰å…¨å¨èƒï¼Œå»ºç«‹é˜²æŠ¤å’Œå“åº”æœºåˆ¶
- **ä¸šåŠ¡äººå‘˜**ï¼šäº†è§£ç”¨æˆ·è¡Œä¸ºï¼ŒæŒ‡å¯¼äº§å“ä¼˜åŒ–å’Œè¿è¥ç­–ç•¥

**æ ¸å¿ƒè¦è®°ä½çš„æ˜¯**ï¼šæ—¥å¿—ä¸åªæ˜¯è®°å½•ï¼Œæ›´æ˜¯äº†è§£ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ã€å‘ç°é—®é¢˜ã€æŒ‡å¯¼ä¼˜åŒ–çš„é‡è¦æ•°æ®æºã€‚æŒæ¡æ—¥å¿—ç®¡ç†æŠ€èƒ½ï¼Œå°±æŒæ¡äº†WebæœåŠ¡è¿ç»´çš„æ ¸å¿ƒèƒ½åŠ›ã€‚