---
title: 3、Nginx虚拟主机配置
---
## 📚 目录

1. [虚拟主机基础概念](#1-虚拟主机基础概念)
2. [server块虚拟主机配置](#2-server块虚拟主机配置)
3. [三种虚拟主机类型详解](#3-三种虚拟主机类型详解)
4. [server_name域名匹配规则](#4-server_name域名匹配规则)
5. [default_server默认站点配置](#5-default_server默认站点配置)
6. [虚拟主机配置文件组织](#6-虚拟主机配置文件组织)
7. [多站点管理最佳实践](#7-多站点管理最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🌐 虚拟主机基础概念


### 1.1 什么是虚拟主机


**🔸 生活类比**
```
虚拟主机就像一栋公寓楼：
🏢 一台服务器 = 一栋楼
🏠 多个网站 = 多个房间
📮 不同域名 = 不同门牌号

访客通过门牌号找到对应房间，
服务器通过域名找到对应网站
```

**💡 核心定义**
- **虚拟主机**：在一台物理服务器上运行多个独立网站的技术
- **目的**：资源共享、成本降低、管理集中
- **实现原理**：通过不同的标识（域名/IP/端口）区分不同网站

### 1.2 虚拟主机的优势


| 优势类型 | **具体表现** | **实际价值** |
|---------|------------|-------------|
| 💰 **成本节约** | `一台服务器托管多个网站` | `减少硬件采购和维护成本` |
| 🔧 **管理便利** | `统一的服务器管理` | `简化运维工作，降低复杂度` |
| ⚡ **资源高效** | `共享CPU、内存、网络` | `提高服务器资源利用率` |
| 🔄 **扩展灵活** | `快速添加新站点` | `业务扩展时无需额外硬件` |

### 1.3 虚拟主机类型概览


```
虚拟主机分类图：
                虚拟主机
                   |
         ┌─────────┼─────────┐
         |         |         |
    基于域名    基于IP    基于端口
         |         |         |
   www.a.com   192.168.1.10  :8080
   www.b.com   192.168.1.11  :8081
   www.c.com   192.168.1.12  :8082

最常用：基于域名（共享IP，不同域名）
```

---

## 2. 📝 server块虚拟主机配置


### 2.1 server块基本结构


**🔸 核心语法**
```nginx
server {
    listen 80;                    # 监听端口
    server_name example.com;      # 服务器名称
    root /var/www/example;        # 网站根目录
    index index.html index.php;   # 默认首页
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

**🎯 关键参数说明**

| 参数 | **作用** | **示例** | **说明** |
|------|---------|---------|---------|
| `listen` | `指定监听端口和IP` | `listen 80;` | `不指定IP表示监听所有IP` |
| `server_name` | `指定域名匹配规则` | `server_name example.com;` | `支持通配符和正则` |
| `root` | `设置网站根目录` | `root /var/www/html;` | `静态文件存放位置` |
| `index` | `设置默认首页文件` | `index index.html;` | `按顺序查找文件` |

### 2.2 完整配置示例


```nginx
# 完整的虚拟主机配置
server {
    # 基础配置
    listen 80;
    listen [::]:80;  # IPv6支持
    server_name www.example.com example.com;
    
    # 文档根目录
    root /var/www/example.com/public;
    index index.html index.htm index.php;
    
    # 访问日志
    access_log /var/log/nginx/example.com.access.log;
    error_log /var/log/nginx/example.com.error.log;
    
    # 静态文件处理
    location ~* \.(jpg|jpeg|png|gif|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # PHP文件处理
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
    }
    
    # 主要内容处理
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
}
```

---

## 3. 🏗️ 三种虚拟主机类型详解


### 3.1 基于域名的虚拟主机


**🌟 最常用的方式**

```nginx
# 站点1：博客网站
server {
    listen 80;
    server_name blog.example.com;
    root /var/www/blog;
    
    location / {
        try_files $uri $uri/ =404;
    }
}

# 站点2：商城网站
server {
    listen 80;
    server_name shop.example.com;
    root /var/www/shop;
    
    location / {
        try_files $uri $uri/ =404;
    }
}

# 站点3：API服务
server {
    listen 80;
    server_name api.example.com;
    root /var/www/api;
    
    location / {
        proxy_pass http://127.0.0.1:3000;
    }
}
```

**💡 域名虚拟主机的特点**
- ✅ **共享IP地址**：多个域名使用同一个IP
- ✅ **成本最低**：不需要额外IP资源
- ✅ **管理简单**：通过域名区分站点
- ⚠️ **依赖DNS**：需要正确的域名解析

### 3.2 基于IP的虚拟主机


**🔸 适用于需要独立IP的场景**

```nginx
# IP 192.168.1.10 的网站
server {
    listen 192.168.1.10:80;
    server_name _;
    root /var/www/site1;
}

# IP 192.168.1.11 的网站  
server {
    listen 192.168.1.11:80;
    server_name _;
    root /var/www/site2;
}

# IP 192.168.1.12 的网站
server {
    listen 192.168.1.12:80;
    server_name _;
    root /var/www/site3;
}
```

**🎯 IP虚拟主机的应用场景**
- 🔒 **SSL证书需求**：不同站点需要独立证书
- 🏢 **企业隔离**：不同客户的完全隔离
- 📊 **性能监控**：独立IP便于流量统计
- 🔐 **安全需求**：敏感应用的网络隔离

### 3.3 基于端口的虚拟主机


**🔸 通过不同端口区分站点**

```nginx
# 默认80端口的主站
server {
    listen 80;
    server_name example.com;
    root /var/www/main;
}

# 8080端口的测试站
server {
    listen 8080;
    server_name example.com;
    root /var/www/test;
}

# 9000端口的管理后台
server {
    listen 9000;
    server_name example.com;
    root /var/www/admin;
    
    # 添加访问控制
    allow 192.168.1.0/24;
    deny all;
}
```

**⚖️ 端口虚拟主机的优缺点**

| 优点 | 缺点 |
|------|------|
| `配置简单，不依赖域名` | `URL不够友好，需要带端口号` |
| `可以快速部署测试环境` | `防火墙需要开放多个端口` |
| `适合内部系统和调试` | `不适合面向公众的服务` |

---

## 4. 🎯 server_name域名匹配规则


### 4.1 精确匹配


```nginx
# 精确匹配单个域名
server {
    listen 80;
    server_name www.example.com;
    root /var/www/www;
}

# 精确匹配多个域名
server {
    listen 80;
    server_name example.com www.example.com mail.example.com;
    root /var/www/example;
}
```

### 4.2 通配符匹配


**🔸 前置通配符**
```nginx
server {
    listen 80;
    server_name *.example.com;  # 匹配所有子域名
    root /var/www/subdomains;
}
# 匹配：blog.example.com, shop.example.com, api.example.com
# 不匹配：example.com, sub.blog.example.com
```

**🔸 后置通配符**
```nginx
server {
    listen 80;
    server_name www.example.*;   # 匹配所有顶级域
    root /var/www/international;
}
# 匹配：www.example.com, www.example.org, www.example.net
```

### 4.3 正则表达式匹配


```nginx
server {
    listen 80;
    server_name ~^(www\.)?(.+)$;  # 正则匹配
    root /var/www/$2;             # 使用捕获组
}
# 匹配：example.com → /var/www/example.com
# 匹配：www.blog.com → /var/www/blog.com
```

### 4.4 匹配优先级


```
Nginx域名匹配优先级（从高到低）：
┌─────────────────────────┐
│ 1. 精确匹配             │ ← server_name example.com;
├─────────────────────────┤
│ 2. 前置通配符匹配       │ ← server_name *.example.com;
├─────────────────────────┤
│ 3. 后置通配符匹配       │ ← server_name www.example.*;
├─────────────────────────┤
│ 4. 正则表达式匹配       │ ← server_name ~^(.+)\.example\.com$;
├─────────────────────────┤
│ 5. 默认服务器匹配       │ ← default_server
└─────────────────────────┘
```

**🧪 实践验证**
```bash
# 测试不同域名的匹配结果
curl -H "Host: www.example.com" http://localhost/
curl -H "Host: blog.example.com" http://localhost/
curl -H "Host: unknown.domain.com" http://localhost/
```

---

## 5. 🏠 default_server默认站点配置


### 5.1 默认服务器的作用


**🔸 兜底机制**
```
客户端请求 → Nginx匹配server_name → 找到对应虚拟主机
                     ↓ (匹配失败)
                default_server → 提供默认响应
```

**💡 设置默认服务器**
```nginx
server {
    listen 80 default_server;        # 标记为默认服务器
    listen [::]:80 default_server;   # IPv6默认服务器
    server_name _;                   # 下划线表示匹配任意域名
    
    root /var/www/default;
    
    # 返回404页面或重定向到主站
    location / {
        return 404 "Site not found";
    }
}
```

### 5.2 默认服务器的最佳实践


**🔒 安全防护型默认站点**
```nginx
server {
    listen 80 default_server;
    server_name _;
    
    # 记录未授权访问
    access_log /var/log/nginx/default.access.log;
    
    # 返回403禁止访问
    location / {
        return 403 "Access Denied";
    }
    
    # 特殊处理健康检查
    location /health {
        return 200 "OK";
        add_header Content-Type text/plain;
    }
}
```

**🔄 重定向型默认站点**
```nginx
server {
    listen 80 default_server;
    server_name _;
    
    # 重定向到主站
    location / {
        return 301 https://www.example.com$request_uri;
    }
}
```

---

## 6. 📁 虚拟主机配置文件组织


### 6.1 目录结构规划


```
/etc/nginx/
├── nginx.conf              # 主配置文件
├── sites-available/        # 可用站点配置
│   ├── example.com.conf
│   ├── blog.example.com.conf
│   ├── api.example.com.conf
│   └── default.conf
├── sites-enabled/          # 启用站点配置（软链接）
│   ├── example.com.conf -> ../sites-available/example.com.conf
│   ├── blog.example.com.conf -> ../sites-available/blog.example.com.conf
│   └── default.conf -> ../sites-available/default.conf
├── conf.d/                 # 附加配置文件
│   ├── ssl.conf
│   └── security.conf
└── snippets/               # 配置片段
    ├── ssl-params.conf
    └── fastcgi-php.conf
```

### 6.2 主配置文件设置


```nginx
# /etc/nginx/nginx.conf
http {
    # 基础设置
    include /etc/nginx/mime.types;
    include /etc/nginx/conf.d/*.conf;
    
    # 引入所有启用的站点
    include /etc/nginx/sites-enabled/*;
    
    # 全局日志设置
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}
```

### 6.3 单站点配置文件模板


```nginx
# /etc/nginx/sites-available/example.com.conf
server {
    # 基础配置
    listen 80;
    listen [::]:80;
    server_name example.com www.example.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    # HTTPS配置
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name example.com www.example.com;
    
    # SSL证书
    ssl_certificate /etc/ssl/certs/example.com.crt;
    ssl_certificate_key /etc/ssl/private/example.com.key;
    include /etc/nginx/snippets/ssl-params.conf;
    
    # 网站配置
    root /var/www/example.com/public;
    index index.html index.php;
    
    # 日志文件
    access_log /var/log/nginx/example.com.access.log;
    error_log /var/log/nginx/example.com.error.log;
    
    # 包含通用配置
    include /etc/nginx/snippets/fastcgi-php.conf;
    
    # 路由配置
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
}
```

### 6.4 配置管理命令


```bash
# 创建新站点配置
sudo nano /etc/nginx/sites-available/newsite.com.conf

# 启用站点（创建软链接）
sudo ln -s /etc/nginx/sites-available/newsite.com.conf \
           /etc/nginx/sites-enabled/

# 禁用站点（删除软链接）
sudo rm /etc/nginx/sites-enabled/newsite.com.conf

# 测试配置
sudo nginx -t

# 重载配置
sudo systemctl reload nginx

# 查看启用的站点
ls -la /etc/nginx/sites-enabled/
```

---

## 7. 🚀 多站点管理最佳实践


### 7.1 命名规范


**🔸 配置文件命名**
```bash
# 推荐的命名方式
/etc/nginx/sites-available/
├── 001-default.conf          # 数字前缀表示优先级
├── example.com.conf          # 主域名
├── blog.example.com.conf     # 子域名
├── api.example.com.conf      # API服务
└── staging.example.com.conf  # 测试环境
```

**🔸 目录结构命名**
```bash
/var/www/
├── example.com/
│   ├── public/          # 网站根目录
│   ├── logs/           # 站点专用日志
│   └── ssl/            # SSL证书
├── blog.example.com/
└── api.example.com/
```

### 7.2 配置模板化


**🔸 通用配置片段**
```nginx
# /etc/nginx/snippets/common-locations.conf
# 通用location配置

# 静态文件缓存
location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# 隐藏敏感文件
location ~ /\. {
    deny all;
}

# PHP文件处理
location ~ \.php$ {
    include snippets/fastcgi-php.conf;
    fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
}
```

**🔸 站点配置引用**
```nginx
server {
    listen 80;
    server_name blog.example.com;
    root /var/www/blog.example.com/public;
    
    # 引入通用配置
    include /etc/nginx/snippets/common-locations.conf;
    
    # 站点特定配置
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
}
```

### 7.3 自动化管理脚本


```bash
#!/bin/bash
# nginx-site-manager.sh - Nginx站点管理脚本

create_site() {
    local domain=$1
    local root_dir="/var/www/$domain"
    
    # 创建目录结构
    sudo mkdir -p "$root_dir/public"
    sudo mkdir -p "$root_dir/logs"
    
    # 创建配置文件
    cat > "/etc/nginx/sites-available/$domain.conf" << EOF
server {
    listen 80;
    server_name $domain www.$domain;
    root $root_dir/public;
    index index.html index.php;
    
    access_log $root_dir/logs/access.log;
    error_log $root_dir/logs/error.log;
    
    include /etc/nginx/snippets/common-locations.conf;
    
    location / {
        try_files \$uri \$uri/ =404;
    }
}
EOF
    
    # 启用站点
    sudo ln -s "/etc/nginx/sites-available/$domain.conf" \
               "/etc/nginx/sites-enabled/"
    
    # 测试并重载
    sudo nginx -t && sudo systemctl reload nginx
    
    echo "站点 $domain 创建成功！"
}

# 使用示例
# ./nginx-site-manager.sh create newsite.com
```

### 7.4 监控和日志管理


**🔸 日志轮转配置**
```bash
# /etc/logrotate.d/nginx-sites
/var/www/*/logs/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    sharedscripts
    postrotate
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}
```

**🔸 站点监控脚本**
```bash
#!/bin/bash
# 检查所有站点状态
for site in /etc/nginx/sites-enabled/*.conf; do
    domain=$(grep -E "^\s*server_name" "$site" | head -1 | awk '{print $2}' | sed 's/;//')
    status=$(curl -s -o /dev/null -w "%{http_code}" "http://$domain")
    echo "$domain: $status"
done
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 虚拟主机：一台服务器运行多个网站的技术
🔸 三种类型：基于域名（最常用）、基于IP、基于端口
🔸 server块：Nginx虚拟主机的基本配置单元
🔸 server_name：域名匹配规则，支持精确、通配符、正则
🔸 default_server：兜底机制，处理未匹配的请求
🔸 配置组织：sites-available和sites-enabled的管理模式
```

### 8.2 关键理解要点


**🔹 虚拟主机的本质**
```
理解要点：
- 虚拟主机是逻辑概念，不是物理分离
- 通过HTTP Header中的Host字段识别请求目标
- 同一台服务器的不同虚拟主机共享系统资源
```

**🔹 域名匹配的优先级**
```
记忆口诀：
精确 > 前通配 > 后通配 > 正则 > 默认
配置时要考虑匹配顺序，避免配置冲突
```

**🔹 配置文件的管理哲学**
```
核心原则：
- 模块化：功能分离，便于维护
- 标准化：统一命名和结构
- 可复用：通用配置提取为片段
- 可管理：enable/disable机制
```

### 8.3 实际应用价值


**🎯 业务场景应用**
- **企业官网**：主站+博客+API的多站点部署
- **SaaS平台**：为不同客户提供独立子域名
- **开发环境**：生产、测试、开发环境的隔离
- **CDN节点**：同一服务器托管多个源站

**🔧 运维实践**
- **标准化部署**：使用配置模板快速创建新站点
- **安全防护**：通过default_server防止未授权访问
- **日志管理**：独立日志便于问题排查和统计分析
- **证书管理**：SSL证书的统一管理和自动化更新

**✅ 本节检查清单**
- [ ] 能说出虚拟主机的三种类型及适用场景
- [ ] 能编写基本的server块配置
- [ ] 理解server_name的匹配规则和优先级
- [ ] 能配置default_server兜底机制
- [ ] 掌握sites-available/sites-enabled管理方式
- [ ] 能设计多站点的目录结构和命名规范

**🎯 一句话精华**
虚拟主机让一台服务器变身公寓楼，通过域名门牌号精准找到对应网站房间

**🧠 记忆锚点**
看到虚拟主机就想到"一楼多户"，看到server_name就想到"门牌匹配"