---
title: 2ã€Nginxå®‰è£…é…ç½®ä¸ŽåŸºç¡€ç®¡ç†
---
## ðŸ“š ç›®å½•

1. [Nginxæ¦‚è¿°ä¸Žå®‰è£…æ–¹å¼](#1-nginxæ¦‚è¿°ä¸Žå®‰è£…æ–¹å¼)
2. [ä¸»é…ç½®æ–‡ä»¶ç»“æž„è¯¦è§£](#2-ä¸»é…ç½®æ–‡ä»¶ç»“æž„è¯¦è§£)
3. [æœåŠ¡ç®¡ç†ä¸Žæ“ä½œå‘½ä»¤](#3-æœåŠ¡ç®¡ç†ä¸Žæ“ä½œå‘½ä»¤)
4. [æ—¥å¿—ç³»ç»Ÿé…ç½®](#4-æ—¥å¿—ç³»ç»Ÿé…ç½®)
5. [è¿›ç¨‹æ¨¡åž‹ä¸Žæ€§èƒ½è°ƒä¼˜](#5-è¿›ç¨‹æ¨¡åž‹ä¸Žæ€§èƒ½è°ƒä¼˜)
6. [åŸºç¡€å®‰å…¨é…ç½®](#6-åŸºç¡€å®‰å…¨é…ç½®)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸŒ Nginxæ¦‚è¿°ä¸Žå®‰è£…æ–¹å¼


### 1.1 ä»€ä¹ˆæ˜¯Nginx


**ðŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
Nginxï¼šé«˜æ€§èƒ½çš„HTTPæœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨
è¯»éŸ³ï¼šEngine-Xï¼ˆå‘éŸ³ç±»ä¼¼"å¼•æ“Ž-X"ï¼‰
ç‰¹ç‚¹ï¼šè½»é‡çº§ã€é«˜å¹¶å‘ã€ä½Žå†…å­˜æ¶ˆè€—
```

**ðŸ’¡ ä¸ºä»€ä¹ˆé€‰æ‹©Nginx**
```
ä¼ ç»ŸApacheæœåŠ¡å™¨ï¼šæ¯ä¸ªç”¨æˆ·è¿žæŽ¥åˆ›å»ºä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹
é—®é¢˜ï¼š1ä¸‡ä¸ªç”¨æˆ· = 1ä¸‡ä¸ªè¿›ç¨‹ï¼Œå†…å­˜æ¶ˆè€—å·¨å¤§

Nginxè§£å†³æ–¹æ¡ˆï¼šäº‹ä»¶é©±åŠ¨æž¶æž„
ä¼˜åŠ¿ï¼š1ä¸ªworkerè¿›ç¨‹å¯ä»¥å¤„ç†æ•°ä¸‡ä¸ªè¿žæŽ¥
ç»“æžœï¼šç›¸åŒç¡¬ä»¶æ€§èƒ½æå‡10å€ä»¥ä¸Š
```

### 1.2 å®‰è£…æ–¹å¼å¯¹æ¯”åˆ†æž


**ðŸ“Š å®‰è£…æ–¹å¼é€‰æ‹©**

| å®‰è£…æ–¹å¼ | **ä¼˜åŠ¿** | **åŠ£åŠ¿** | **é€‚ç”¨åœºæ™¯** |
|---------|----------|----------|-------------|
| ðŸ”§ **ç³»ç»Ÿæºå®‰è£…** | `é…ç½®ç®€å•ã€ç¨³å®šæ€§å¥½` | `ç‰ˆæœ¬è¾ƒæ—§ã€åŠŸèƒ½å—é™` | `ç”Ÿäº§çŽ¯å¢ƒã€è¿½æ±‚ç¨³å®š` |
| ðŸŒ **å®˜æ–¹æºå®‰è£…** | `ç‰ˆæœ¬æ–°ã€åŠŸèƒ½å®Œæ•´` | `é…ç½®ç¨å¤æ‚` | `éœ€è¦æ–°ç‰¹æ€§ã€å¼€å‘çŽ¯å¢ƒ` |
| ðŸ“¦ **æºç ç¼–è¯‘** | `å®šåˆ¶æ€§å¼ºã€æ€§èƒ½æœ€ä¼˜` | `å¤æ‚åº¦é«˜ã€ç»´æŠ¤å›°éš¾` | `ç‰¹æ®Šéœ€æ±‚ã€é«˜æ€§èƒ½åœºæ™¯` |

### 1.3 ç³»ç»Ÿæºå®‰è£…ï¼ˆæŽ¨èæ–°æ‰‹ï¼‰


**ðŸš€ CentOS/RHELç³»ç»Ÿ**
```bash
# ç¬¬ä¸€æ­¥ï¼šæ›´æ–°ç³»ç»ŸåŒ…
sudo yum update -y

# ç¬¬äºŒæ­¥ï¼šå®‰è£…nginx
sudo yum install nginx -y

# ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl start nginx
sudo systemctl enable nginx
```

**ðŸ§ Ubuntu/Debianç³»ç»Ÿ**
```bash
# ç¬¬ä¸€æ­¥ï¼šæ›´æ–°åŒ…åˆ—è¡¨
sudo apt update

# ç¬¬äºŒæ­¥ï¼šå®‰è£…nginx
sudo apt install nginx -y

# ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨æœåŠ¡
sudo systemctl start nginx
sudo systemctl enable nginx
```

**âœ… å®‰è£…éªŒè¯**
```bash
# æ£€æŸ¥nginxç‰ˆæœ¬
nginx -v

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status nginx

# æµ‹è¯•webè®¿é—®
curl http://localhost
# çœ‹åˆ°"Welcome to nginx!"é¡µé¢è¯´æ˜Žå®‰è£…æˆåŠŸ
```

### 1.4 å®˜æ–¹æºå®‰è£…ï¼ˆèŽ·å–æœ€æ–°ç‰ˆæœ¬ï¼‰


**ðŸ”¸ æ·»åŠ å®˜æ–¹ä»“åº“ï¼ˆCentOSï¼‰**
```bash
# åˆ›å»ºnginxå®˜æ–¹æºé…ç½®
sudo cat > /etc/yum.repos.d/nginx.repo << 'EOF'
[nginx-stable]
name=nginx stable repo
baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
EOF

# å®‰è£…æœ€æ–°ç‰ˆnginx
sudo yum install nginx -y
```

**ðŸ’¡ ç‰ˆæœ¬å·®å¼‚å¯¹æ¯”**
```
ç³»ç»Ÿæºç‰ˆæœ¬ï¼šé€šå¸¸æ˜¯1.18-1.20ï¼ˆè¾ƒç¨³å®šï¼‰
å®˜æ–¹æºç‰ˆæœ¬ï¼š1.24+ï¼ˆåŒ…å«æœ€æ–°ç‰¹æ€§ï¼‰

æ–°ç‰¹æ€§ç¤ºä¾‹ï¼š
- æ›´å¥½çš„HTTP/2æ”¯æŒ
- å¢žå¼ºçš„å®‰å…¨åŠŸèƒ½
- æ€§èƒ½ä¼˜åŒ–æ”¹è¿›
```

---

## 2. ðŸ“‹ ä¸»é…ç½®æ–‡ä»¶ç»“æž„è¯¦è§£


### 2.1 é…ç½®æ–‡ä»¶ä½ç½®ä¸Žå±‚æ¬¡


**ðŸ—‚ï¸ é‡è¦æ–‡ä»¶è·¯å¾„**
```
ä¸»é…ç½®æ–‡ä»¶ï¼š/etc/nginx/nginx.conf
ç½‘ç«™é…ç½®ï¼š/etc/nginx/conf.d/*.conf
é»˜è®¤ç½‘ç«™ï¼š/etc/nginx/sites-available/default (Ubuntu)
ç½‘ç«™æ ¹ç›®å½•ï¼š/usr/share/nginx/html
æ—¥å¿—ç›®å½•ï¼š/var/log/nginx/
```

**ðŸ—ï¸ é…ç½®æ–‡ä»¶å±‚æ¬¡ç»“æž„**
```
nginx.conf (ä¸»é…ç½®)
â”œâ”€â”€ å…¨å±€é…ç½® (workerè¿›ç¨‹ã€ç”¨æˆ·ç­‰)
â”œâ”€â”€ eventsé…ç½® (è¿žæŽ¥å¤„ç†)
â”œâ”€â”€ httpé…ç½® (HTTPæœåŠ¡å™¨è®¾ç½®)
â”‚   â”œâ”€â”€ å…¨å±€httpè®¾ç½®
â”‚   â”œâ”€â”€ upstreamé…ç½® (è´Ÿè½½å‡è¡¡)
â”‚   â””â”€â”€ serveré…ç½® (è™šæ‹Ÿä¸»æœº)
â”‚       â”œâ”€â”€ locationé…ç½® (URLåŒ¹é…)
â”‚       â””â”€â”€ å…¶ä»–serverè®¾ç½®
â””â”€â”€ includeåŒ…å«çš„å…¶ä»–é…ç½®æ–‡ä»¶
```

### 2.2 nginx.confä¸»é…ç½®è¯¦è§£


**ðŸ”§ å®Œæ•´é…ç½®æ–‡ä»¶ç¤ºä¾‹**
```nginx
# ===== å…¨å±€é…ç½®åŒºåŸŸ =====
user nginx;                          # è¿è¡Œç”¨æˆ·
worker_processes auto;               # workerè¿›ç¨‹æ•°ï¼ˆauto=CPUæ ¸å¿ƒæ•°ï¼‰
error_log /var/log/nginx/error.log; # é”™è¯¯æ—¥å¿—ä½ç½®
pid /run/nginx.pid;                 # PIDæ–‡ä»¶ä½ç½®

# ===== äº‹ä»¶å¤„ç†é…ç½® =====
events {
    worker_connections 1024;        # æ¯ä¸ªworkeræœ€å¤§è¿žæŽ¥æ•°
    use epoll;                      # ä½¿ç”¨epolläº‹ä»¶æ¨¡åž‹ï¼ˆLinuxæŽ¨èï¼‰
}

# ===== HTTPæœåŠ¡é…ç½® =====
http {
    # åŸºç¡€è®¾ç½®
    include       /etc/nginx/mime.types;     # æ–‡ä»¶ç±»åž‹æ˜ å°„
    default_type  application/octet-stream;  # é»˜è®¤æ–‡ä»¶ç±»åž‹
    
    # æ—¥å¿—æ ¼å¼å®šä¹‰
    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent"';
    
    # è®¿é—®æ—¥å¿—é…ç½®
    access_log /var/log/nginx/access.log main;
    
    # æ€§èƒ½ä¼˜åŒ–è®¾ç½®
    sendfile on;                    # å¯ç”¨é«˜æ•ˆæ–‡ä»¶ä¼ è¾“
    tcp_nopush on;                 # ä¼˜åŒ–TCPä¼ è¾“
    keepalive_timeout 65;          # é•¿è¿žæŽ¥è¶…æ—¶æ—¶é—´
    
    # åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶
    include /etc/nginx/conf.d/*.conf;
    
    # é»˜è®¤æœåŠ¡å™¨é…ç½®
    server {
        listen 80;                 # ç›‘å¬ç«¯å£
        server_name localhost;     # æœåŠ¡å™¨åç§°
        root /usr/share/nginx/html; # ç½‘ç«™æ ¹ç›®å½•
        
        # é»˜è®¤é¡µé¢é…ç½®
        location / {
            index index.html index.htm;
        }
        
        # é”™è¯¯é¡µé¢é…ç½®
        error_page 404 /404.html;
        error_page 500 502 503 504 /50x.html;
    }
}
```

### 2.3 é…ç½®æŒ‡ä»¤è¯¦è§£


**ðŸ“ é‡è¦æŒ‡ä»¤å«ä¹‰è§£é‡Š**

**worker_processesé…ç½®**
```nginx
worker_processes auto;    # è‡ªåŠ¨æ£€æµ‹CPUæ ¸å¿ƒæ•°
# ç­‰åŒäºŽæ‰‹åŠ¨è®¾ç½®ï¼šworker_processes 4; (4æ ¸CPU)

ä¸ºä»€ä¹ˆè¿™æ ·è®¾ç½®ï¼Ÿ
- 1ä¸ªworkerè¿›ç¨‹ = 1ä¸ªCPUæ ¸å¿ƒï¼Œé¿å…è¿›ç¨‹åˆ‡æ¢å¼€é”€
- autoå‚æ•°è®©nginxè‡ªåŠ¨æ£€æµ‹ï¼ŒçœåŽ»æ‰‹åŠ¨è®¡ç®—
```

**worker_connectionsé…ç½®**
```nginx
worker_connections 1024;  # æ¯ä¸ªworkeræœ€å¤§è¿žæŽ¥æ•°

å®žé™…å«ä¹‰ï¼š
- æ€»å¹¶å‘è¿žæŽ¥æ•° = worker_processes Ã— worker_connections
- 4æ ¸CPUï¼š4 Ã— 1024 = 4096ä¸ªå¹¶å‘è¿žæŽ¥
- å¯¹äºŽå¤§å¤šæ•°ç½‘ç«™å·²ç»è¶³å¤Ÿä½¿ç”¨
```

**sendfileä¼˜åŒ–**
```nginx
sendfile on;  # å¯ç”¨é›¶æ‹·è´æ–‡ä»¶ä¼ è¾“

ä¼ ç»Ÿæ–¹å¼ï¼šç£ç›˜ â†’ å†…æ ¸ç¼“å†²åŒº â†’ ç”¨æˆ·ç©ºé—´ â†’ socketç¼“å†²åŒº
sendfileæ–¹å¼ï¼šç£ç›˜ â†’ å†…æ ¸ç¼“å†²åŒº â†’ socketç¼“å†²åŒº
ç»“æžœï¼šå‡å°‘CPUæ¶ˆè€—ï¼Œæå‡æ–‡ä»¶ä¼ è¾“æ•ˆçŽ‡
```

---

## 3. âš™ï¸ æœåŠ¡ç®¡ç†ä¸Žæ“ä½œå‘½ä»¤


### 3.1 systemctlæœåŠ¡ç®¡ç†


**ðŸ”„ åŸºç¡€æœåŠ¡æ“ä½œ**
```bash
# å¯åŠ¨nginxæœåŠ¡
sudo systemctl start nginx

# åœæ­¢nginxæœåŠ¡  
sudo systemctl stop nginx

# é‡å¯nginxæœåŠ¡
sudo systemctl restart nginx

# é‡æ–°åŠ è½½é…ç½®ï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰
sudo systemctl reload nginx

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status nginx
```

**ðŸ“Š æœåŠ¡çŠ¶æ€è§£è¯»**
```bash
sudo systemctl status nginx
# è¾“å‡ºç¤ºä¾‹ï¼š
â— nginx.service - The nginx HTTP and reverse proxy server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled)
   Active: active (running) since Mon 2024-01-15 10:30:00 CST
   Process: 1234 (/usr/sbin/nginx -t)
   Main PID: 1235 (nginx)
   CGroup: /system.slice/nginx.service
           â”œâ”€1235 nginx: master process /usr/sbin/nginx
           â”œâ”€1236 nginx: worker process
           â””â”€1237 nginx: worker process

å…³é”®ä¿¡æ¯è§£è¯»ï¼š
- Loaded: enabled = å¼€æœºè‡ªå¯åŠ¨å·²å¯ç”¨
- Active: running = æœåŠ¡æ­£åœ¨è¿è¡Œ
- Main PID: ä¸»è¿›ç¨‹ID
- worker process = å·¥ä½œè¿›ç¨‹ï¼ˆå¤„ç†å®žé™…è¯·æ±‚ï¼‰
```

### 3.2 nginxå‘½ä»¤è¡Œå·¥å…·


**ðŸ› ï¸ é…ç½®ç®¡ç†å‘½ä»¤**
```bash
# æµ‹è¯•é…ç½®æ–‡ä»¶è¯­æ³•
nginx -t
# è¾“å‡ºï¼šnginx: configuration file /etc/nginx/nginx.conf test is successful

# æµ‹è¯•å¹¶æ˜¾ç¤ºé…ç½®æ–‡ä»¶è·¯å¾„
nginx -T

# æŸ¥çœ‹nginxç‰ˆæœ¬ä¿¡æ¯
nginx -v

# æŸ¥çœ‹è¯¦ç»†ç‰ˆæœ¬å’Œç¼–è¯‘å‚æ•°
nginx -V
```

**âš¡ ä¿¡å·æŽ§åˆ¶å‘½ä»¤**
```bash
# å¹³æ»‘é‡è½½é…ç½®ï¼ˆæŽ¨èï¼‰
nginx -s reload

# å¿«é€Ÿåœæ­¢æœåŠ¡
nginx -s quit

# ç«‹å³åœæ­¢æœåŠ¡ï¼ˆå¼ºåˆ¶ï¼‰
nginx -s stop

# é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶
nginx -s reopen
```

**ðŸ’¡ reload vs restartåŒºåˆ«**
```
nginx -s reloadï¼ˆå¹³æ»‘é‡è½½ï¼‰ï¼š
1. ä¸ä¸­æ–­çŽ°æœ‰è¿žæŽ¥
2. æ–°è¿žæŽ¥ä½¿ç”¨æ–°é…ç½®
3. è€è¿žæŽ¥ç»§ç»­ä½¿ç”¨æ—§é…ç½®ç›´åˆ°å®Œæˆ
4. 0åœæœºæ—¶é—´

systemctl restartï¼ˆé‡å¯ï¼‰ï¼š
1. ç«‹å³ä¸­æ–­æ‰€æœ‰è¿žæŽ¥
2. æœåŠ¡çŸ­æš‚åœæ­¢
3. æ‰€æœ‰è¿žæŽ¥å¼ºåˆ¶é‡æ–°å»ºç«‹
4. ä¼šæœ‰å‡ ç§’é’Ÿçš„æœåŠ¡ä¸­æ–­
```

### 3.3 é…ç½®æ–‡ä»¶è¯­æ³•æ£€æŸ¥


**ðŸ” è¯­æ³•æ£€æŸ¥å®žä¾‹**
```bash
# ä¿®æ”¹é…ç½®æ–‡ä»¶åŽå…ˆæ£€æŸ¥è¯­æ³•
sudo nginx -t

# æˆåŠŸç¤ºä¾‹ï¼š
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful

# é”™è¯¯ç¤ºä¾‹ï¼š
nginx: [emerg] unexpected "}" in /etc/nginx/nginx.conf:25
nginx: configuration file /etc/nginx/nginx.conf test failed

# é”™è¯¯ä¿®å¤åŽå†æ¬¡æ£€æŸ¥ï¼Œç¡®è®¤æ— è¯¯åŽæ‰é‡è½½
sudo nginx -s reload
```

**âš ï¸ æœ€ä½³å®žè·µæµç¨‹**
```
1. å¤‡ä»½åŽŸé…ç½®ï¼šcp nginx.conf nginx.conf.bak
2. ä¿®æ”¹é…ç½®æ–‡ä»¶
3. è¯­æ³•æ£€æŸ¥ï¼šnginx -t
4. å¦‚æœ‰é”™è¯¯ï¼ŒæŸ¥çœ‹é”™è¯¯ä¿¡æ¯å¹¶ä¿®å¤
5. è¯­æ³•æ­£ç¡®åŽï¼šnginx -s reload
6. æµ‹è¯•æœåŠ¡æ˜¯å¦æ­£å¸¸å·¥ä½œ
```

---

## 4. ðŸ“Š æ—¥å¿—ç³»ç»Ÿé…ç½®


### 4.1 æ—¥å¿—æ–‡ä»¶ç±»åž‹ä¸Žä½ç½®


**ðŸ“ é»˜è®¤æ—¥å¿—ä½ç½®**
```
è®¿é—®æ—¥å¿—ï¼š/var/log/nginx/access.log
é”™è¯¯æ—¥å¿—ï¼š/var/log/nginx/error.log
PIDæ–‡ä»¶ï¼š/var/run/nginx.pid
```

**ðŸ”¸ è®¿é—®æ—¥å¿— vs é”™è¯¯æ—¥å¿—**
```
è®¿é—®æ—¥å¿—ï¼ˆaccess.logï¼‰ï¼š
- è®°å½•æ¯ä¸ªHTTPè¯·æ±‚
- åŒ…å«IPã€æ—¶é—´ã€è¯·æ±‚URLã€çŠ¶æ€ç ç­‰
- ç”¨äºŽåˆ†æžè®¿é—®ç»Ÿè®¡ã€æ€§èƒ½ç›‘æŽ§

é”™è¯¯æ—¥å¿—ï¼ˆerror.logï¼‰ï¼š  
- è®°å½•nginxè¿è¡Œé”™è¯¯
- åŒ…å«å¯åŠ¨å¤±è´¥ã€é…ç½®é”™è¯¯ã€upstreamé”™è¯¯ç­‰
- ç”¨äºŽæ•…éšœæŽ’æŸ¥å’Œé—®é¢˜è¯Šæ–­
```

### 4.2 è®¿é—®æ—¥å¿—æ ¼å¼é…ç½®


**ðŸ“‹ æ—¥å¿—æ ¼å¼å®šä¹‰**
```nginx
# åœ¨httpå—ä¸­å®šä¹‰æ—¥å¿—æ ¼å¼
log_format main '$remote_addr - $remote_user [$time_local] '
                '"$request" $status $body_bytes_sent '
                '"$http_referer" "$http_user_agent"';

# åº”ç”¨æ—¥å¿—æ ¼å¼
access_log /var/log/nginx/access.log main;
```

**ðŸ” æ—¥å¿—å˜é‡å«ä¹‰**
```
$remote_addrï¼šå®¢æˆ·ç«¯IPåœ°å€
$remote_userï¼šè®¤è¯ç”¨æˆ·åï¼ˆé€šå¸¸ä¸ºç©ºï¼‰
$time_localï¼šæœ¬åœ°æ—¶é—´
$requestï¼šHTTPè¯·æ±‚è¡Œï¼ˆæ–¹æ³•+URL+åè®®ç‰ˆæœ¬ï¼‰
$statusï¼šHTTPå“åº”çŠ¶æ€ç 
$body_bytes_sentï¼šå‘é€ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•°
$http_refererï¼šæ¥æºé¡µé¢URL
$http_user_agentï¼šç”¨æˆ·ä»£ç†ï¼ˆæµè§ˆå™¨ä¿¡æ¯ï¼‰
```

**ðŸ“„ æ—¥å¿—è®°å½•ç¤ºä¾‹**
```
192.168.1.100 - - [15/Jan/2024:10:30:45 +0800] "GET /index.html HTTP/1.1" 200 1024 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"

è§£è¯»ï¼š
- IP: 192.168.1.100
- æ—¶é—´: 2024å¹´1æœˆ15æ—¥ 10:30:45
- è¯·æ±‚: GET /index.html HTTP/1.1
- çŠ¶æ€: 200 (æˆåŠŸ)
- å¤§å°: 1024å­—èŠ‚
- æµè§ˆå™¨: Chrome on Windows 10
```

### 4.3 è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼


**ðŸŽ¯ é’ˆå¯¹ä¸åŒéœ€æ±‚çš„æ—¥å¿—æ ¼å¼**
```nginx
# è¯¦ç»†æ—¥å¿—æ ¼å¼ï¼ˆåŒ…å«è¯·æ±‚æ—¶é—´ï¼‰
log_format detailed '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    '$request_time $upstream_response_time';

# JSONæ ¼å¼æ—¥å¿—ï¼ˆä¾¿äºŽç¨‹åºè§£æžï¼‰
log_format json '{'
                '"time": "$time_local",'
                '"ip": "$remote_addr",'
                '"method": "$request_method",'
                '"uri": "$request_uri",'
                '"status": $status,'
                '"size": $body_bytes_sent,'
                '"user_agent": "$http_user_agent"'
                '}';

# åº”ç”¨ä¸åŒæ ¼å¼
server {
    access_log /var/log/nginx/access.log detailed;
    # æˆ–è€…ä½¿ç”¨JSONæ ¼å¼
    # access_log /var/log/nginx/access.json json;
}
```

### 4.4 é”™è¯¯æ—¥å¿—çº§åˆ«é…ç½®


**ðŸ“ˆ é”™è¯¯æ—¥å¿—çº§åˆ«**
```nginx
# å…¨å±€é”™è¯¯æ—¥å¿—é…ç½®
error_log /var/log/nginx/error.log warn;

æ—¥å¿—çº§åˆ«ï¼ˆä»Žè¯¦ç»†åˆ°ç®€å•ï¼‰ï¼š
debug   - è°ƒè¯•ä¿¡æ¯ï¼ˆéžå¸¸è¯¦ç»†ï¼‰
info    - ä¸€èˆ¬ä¿¡æ¯  
notice  - é€šçŸ¥ä¿¡æ¯
warn    - è­¦å‘Šä¿¡æ¯ï¼ˆæŽ¨èï¼‰
error   - é”™è¯¯ä¿¡æ¯
crit    - ä¸¥é‡é”™è¯¯
alert   - è­¦æŠ¥çº§é”™è¯¯
emerg   - ç´§æ€¥é”™è¯¯
```

**ðŸ’¡ æ—¥å¿—çº§åˆ«é€‰æ‹©å»ºè®®**
```
å¼€å‘çŽ¯å¢ƒï¼šä½¿ç”¨ debug æˆ– infoï¼Œä¾¿äºŽè°ƒè¯•
æµ‹è¯•çŽ¯å¢ƒï¼šä½¿ç”¨ notice æˆ– warn
ç”Ÿäº§çŽ¯å¢ƒï¼šä½¿ç”¨ warn æˆ– errorï¼Œå‡å°‘æ—¥å¿—é‡
```

---

## 5. ðŸ”§ è¿›ç¨‹æ¨¡åž‹ä¸Žæ€§èƒ½è°ƒä¼˜


### 5.1 Nginxè¿›ç¨‹æž¶æž„


**ðŸ—ï¸ è¿›ç¨‹æ¨¡åž‹å›¾è§£**
```
nginxè¿›ç¨‹æž¶æž„ï¼š

master process (ä¸»è¿›ç¨‹)
â”œâ”€â”€ worker process 1 (å·¥ä½œè¿›ç¨‹1)
â”œâ”€â”€ worker process 2 (å·¥ä½œè¿›ç¨‹2)
â”œâ”€â”€ worker process 3 (å·¥ä½œè¿›ç¨‹3)
â””â”€â”€ worker process 4 (å·¥ä½œè¿›ç¨‹4)

masterè¿›ç¨‹èŒè´£ï¼š
- è¯»å–é…ç½®æ–‡ä»¶
- ç®¡ç†workerè¿›ç¨‹
- å¤„ç†ä¿¡å·ï¼ˆreloadã€stopç­‰ï¼‰
- ç›‘æŽ§workerè¿›ç¨‹çŠ¶æ€

workerè¿›ç¨‹èŒè´£ï¼š
- å¤„ç†å®¢æˆ·ç«¯è¿žæŽ¥
- æ‰§è¡ŒHTTPè¯·æ±‚
- å¤„ç†é™æ€æ–‡ä»¶
- ä»£ç†è½¬å‘è¯·æ±‚
```

**ðŸ” æŸ¥çœ‹nginxè¿›ç¨‹**
```bash
# æŸ¥çœ‹nginxè¿›ç¨‹
ps aux | grep nginx

# è¾“å‡ºç¤ºä¾‹ï¼š
root     1234  0.0  0.1  nginx: master process /usr/sbin/nginx
nginx    1235  0.0  0.5  nginx: worker process
nginx    1236  0.0  0.5  nginx: worker process
nginx    1237  0.0  0.5  nginx: worker process
nginx    1238  0.0  0.5  nginx: worker process
```

### 5.2 workerè¿›ç¨‹æ•°é‡é…ç½®


**âš¡ æ ¸å¿ƒé…ç½®å‚æ•°**
```nginx
# è‡ªåŠ¨è®¾ç½®workerè¿›ç¨‹æ•°ï¼ˆæŽ¨èï¼‰
worker_processes auto;

# æ‰‹åŠ¨è®¾ç½®ï¼ˆä¸æŽ¨èï¼‰
# worker_processes 4;

# CPUäº²å’Œæ€§é…ç½®ï¼ˆå¯é€‰ï¼‰
worker_cpu_affinity auto;
```

**ðŸ“Š workerè¿›ç¨‹æ•°é‡é€‰æ‹©**
```
æœ€ä½³å®žè·µï¼šworker_processes = CPUæ ¸å¿ƒæ•°

åŽŸå› è§£é‡Šï¼š
- 1ä¸ªworkerè¿›ç¨‹æœ€é€‚åˆç»‘å®š1ä¸ªCPUæ ¸å¿ƒ
- é¿å…è¿›ç¨‹åœ¨ä¸åŒCPUæ ¸å¿ƒé—´åˆ‡æ¢çš„å¼€é”€
- æœ€å¤§åŒ–CPUç¼“å­˜åˆ©ç”¨çŽ‡

æŸ¥çœ‹CPUæ ¸å¿ƒæ•°ï¼š
grep "processor" /proc/cpuinfo | wc -l
# æˆ–è€…
nproc
```

### 5.3 è¿žæŽ¥æ•°é…ç½®ä¼˜åŒ–


**ðŸŽ¯ å…³é”®é…ç½®å‚æ•°**
```nginx
events {
    # æ¯ä¸ªworkerè¿›ç¨‹çš„æœ€å¤§è¿žæŽ¥æ•°
    worker_connections 1024;
    
    # ä½¿ç”¨é«˜æ•ˆçš„äº‹ä»¶æ¨¡åž‹
    use epoll;  # Linuxç³»ç»ŸæŽ¨è
    
    # å…è®¸ä¸€ä¸ªworkerè¿›ç¨‹åŒæ—¶æŽ¥å—å¤šä¸ªæ–°è¿žæŽ¥
    multi_accept on;
}
```

**ðŸ“ˆ è¿žæŽ¥æ•°è®¡ç®—å…¬å¼**
```
ç†è®ºæœ€å¤§å¹¶å‘è¿žæŽ¥æ•° = worker_processes Ã— worker_connections

ç¤ºä¾‹è®¡ç®—ï¼š
- 4æ ¸CPUæœåŠ¡å™¨
- worker_processes auto (è‡ªåŠ¨è®¾ç½®ä¸º4)
- worker_connections 1024
- æœ€å¤§å¹¶å‘ï¼š4 Ã— 1024 = 4096ä¸ªè¿žæŽ¥

æ³¨æ„äº‹é¡¹ï¼š
- è¿™æ˜¯ç†è®ºå€¼ï¼Œå®žé™…è¦è€ƒè™‘ç³»ç»Ÿé™åˆ¶
- åå‘ä»£ç†æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªç”¨æˆ·è¿žæŽ¥éœ€è¦å ç”¨2ä¸ªworkerè¿žæŽ¥
```

### 5.4 ç³»ç»Ÿçº§ä¼˜åŒ–


**ðŸ”§ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶**
```bash
# æŸ¥çœ‹å½“å‰é™åˆ¶
ulimit -n

# ä¸´æ—¶æé«˜é™åˆ¶
ulimit -n 65535

# æ°¸ä¹…é…ç½®ï¼ˆç¼–è¾‘/etc/security/limits.confï¼‰
nginx soft nofile 65535
nginx hard nofile 65535
```

**âš™ï¸ nginxé…ç½®ä¸­çš„ç³»ç»Ÿä¼˜åŒ–**
```nginx
# workerè¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
worker_rlimit_nofile 65535;

events {
    worker_connections 65535;
}

http {
    # å¼€å¯æ–‡ä»¶é«˜æ•ˆä¼ è¾“
    sendfile on;
    
    # TCPä¼˜åŒ–
    tcp_nopush on;
    tcp_nodelay on;
    
    # ä¿æŒè¿žæŽ¥ä¼˜åŒ–
    keepalive_timeout 30;
    keepalive_requests 100;
}
```

---

## 6. ðŸ›¡ï¸ åŸºç¡€å®‰å…¨é…ç½®


### 6.1 è¿è¡Œç”¨æˆ·ä¸Žæƒé™


**ðŸ‘¤ å®‰å…¨ç”¨æˆ·é…ç½®**
```nginx
# å…¨å±€é…ç½®ä¸­æŒ‡å®šè¿è¡Œç”¨æˆ·
user nginx;

# ä¸ºä»€ä¹ˆä¸ç”¨rootç”¨æˆ·ï¼Ÿ
# 1. rootæƒé™è¿‡å¤§ï¼Œå­˜åœ¨å®‰å…¨é£Žé™©
# 2. nginxç”¨æˆ·æƒé™å—é™ï¼Œå³ä½¿è¢«æ”»å‡»å½±å“ä¹Ÿæœ‰é™
# 3. ç¬¦åˆæœ€å°æƒé™åŽŸåˆ™
```

**ðŸ”’ ç”¨æˆ·æƒé™æ£€æŸ¥**
```bash
# æ£€æŸ¥nginxç”¨æˆ·æ˜¯å¦å­˜åœ¨
id nginx

# è¾“å‡ºç¤ºä¾‹ï¼š
uid=995(nginx) gid=993(nginx) groups=993(nginx)

# æ£€æŸ¥nginxç”¨æˆ·æƒé™
sudo -u nginx ls /etc/nginx/
# åº”è¯¥èƒ½å¤Ÿè¯»å–é…ç½®æ–‡ä»¶

sudo -u nginx touch /var/log/nginx/test
# åº”è¯¥èƒ½å¤Ÿå†™å…¥æ—¥å¿—ç›®å½•
```

### 6.2 éšè—ç‰ˆæœ¬ä¿¡æ¯


**ðŸ” éšè—nginxç‰ˆæœ¬**
```nginx
http {
    # éšè—nginxç‰ˆæœ¬å·
    server_tokens off;
    
    server {
        listen 80;
        server_name example.com;
        
        # éšè—ç‰ˆæœ¬åŽï¼ŒHTTPå“åº”å¤´ä¸å†æ˜¾ç¤ºå…·ä½“ç‰ˆæœ¬
        # åŽŸæ¥ï¼šServer: nginx/1.20.1
        # çŽ°åœ¨ï¼šServer: nginx
    }
}
```

**ðŸ” éªŒè¯ç‰ˆæœ¬éšè—æ•ˆæžœ**
```bash
# æµ‹è¯•HTTPå“åº”å¤´
curl -I http://localhost

# éšè—å‰çš„å“åº”ï¼š
HTTP/1.1 200 OK
Server: nginx/1.20.1
...

# éšè—åŽçš„å“åº”ï¼š
HTTP/1.1 200 OK  
Server: nginx
...
```

### 6.3 åŸºç¡€è®¿é—®æŽ§åˆ¶


**ðŸš« IPè®¿é—®é™åˆ¶**
```nginx
server {
    listen 80;
    server_name example.com;
    
    # å…è®¸ç‰¹å®šIPè®¿é—®
    allow 192.168.1.0/24;   # å…è®¸å†…ç½‘
    allow 127.0.0.1;        # å…è®¸æœ¬æœº
    deny all;               # æ‹’ç»å…¶ä»–æ‰€æœ‰IP
    
    # æˆ–è€…æ‹’ç»ç‰¹å®šIP
    # deny 192.168.1.100;
    # allow all;
    
    location /admin {
        # ç®¡ç†é¡µé¢åªå…è®¸å†…ç½‘è®¿é—®
        allow 192.168.1.0/24;
        deny all;
    }
}
```

### 6.4 è¯·æ±‚é™åˆ¶é…ç½®


**âš¡ é™åˆ¶è¯·æ±‚é¢‘çŽ‡**
```nginx
http {
    # å®šä¹‰é™åˆ¶åŒºåŸŸ
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    
    server {
        listen 80;
        server_name api.example.com;
        
        location /api/ {
            # åº”ç”¨è¯·æ±‚é™åˆ¶
            limit_req zone=api burst=20 nodelay;
            
            # å‚æ•°è§£é‡Šï¼š
            # rate=10r/sï¼šæ¯ç§’æœ€å¤š10ä¸ªè¯·æ±‚
            # burst=20ï¼šçªå‘é˜Ÿåˆ—å¯å®¹çº³20ä¸ªè¯·æ±‚
            # nodelayï¼šè¶…å‡ºé™åˆ¶ç«‹å³è¿”å›žé”™è¯¯
        }
    }
}
```

**ðŸ“Š é™åˆ¶è¿žæŽ¥æ•°**
```nginx
http {
    # é™åˆ¶åŒæ—¶è¿žæŽ¥æ•°
    limit_conn_zone $binary_remote_addr zone=perip:10m;
    
    server {
        # æ¯ä¸ªIPæœ€å¤š5ä¸ªå¹¶å‘è¿žæŽ¥
        limit_conn perip 5;
        
        location /download/ {
            # ä¸‹è½½åŒºåŸŸé™åˆ¶æ›´ä¸¥æ ¼
            limit_conn perip 1;
        }
    }
}
```

---

## 7. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ðŸ”¸ Nginxæœ¬è´¨ï¼šé«˜æ€§èƒ½HTTPæœåŠ¡å™¨å’Œåå‘ä»£ç†
ðŸ”¸ å®‰è£…æ–¹å¼ï¼šç³»ç»Ÿæºï¼ˆç¨³å®šï¼‰vs å®˜æ–¹æºï¼ˆæ–°ç‰¹æ€§ï¼‰
ðŸ”¸ é…ç½®ç»“æž„ï¼šå…¨å±€ â†’ events â†’ http â†’ server â†’ location
ðŸ”¸ æœåŠ¡ç®¡ç†ï¼šsystemctlç®¡ç† + nginxä¿¡å·æŽ§åˆ¶
ðŸ”¸ è¿›ç¨‹æ¨¡åž‹ï¼šmasterè¿›ç¨‹ç®¡ç† + workerè¿›ç¨‹å¤„ç†è¯·æ±‚
ðŸ”¸ å®‰å…¨é…ç½®ï¼šéžrootç”¨æˆ· + ç‰ˆæœ¬éšè— + è®¿é—®æŽ§åˆ¶
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ ä¸ºä»€ä¹ˆNginxæ€§èƒ½ä¼˜ç§€**
```
äº‹ä»¶é©±åŠ¨æž¶æž„ï¼š
- ä¸€ä¸ªworkerè¿›ç¨‹å¤„ç†æ•°ä¸‡è¿žæŽ¥
- é¿å…è¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢å¼€é”€
- å†…å­˜å ç”¨æžä½Ž

å¼‚æ­¥éžé˜»å¡žï¼š
- å¤„ç†è¯·æ±‚æ—¶ä¸ä¼šé˜»å¡žç­‰å¾…
- å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚
- å……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æº
```

**ðŸ”¹ é…ç½®æ–‡ä»¶æœ€ä½³å®žè·µ**
```
ä¿®æ”¹é…ç½®çš„å®‰å…¨æµç¨‹ï¼š
1. å¤‡ä»½åŽŸé…ç½®æ–‡ä»¶
2. ä¿®æ”¹é…ç½®
3. nginx -t è¯­æ³•æ£€æŸ¥
4. nginx -s reload å¹³æ»‘é‡è½½
5. éªŒè¯æœåŠ¡æ­£å¸¸è¿è¡Œ
```

**ðŸ”¹ æ€§èƒ½è°ƒä¼˜è¦ç‚¹**
```
æ ¸å¿ƒå‚æ•°è®¾ç½®ï¼š
- worker_processes = CPUæ ¸å¿ƒæ•°
- worker_connections = æ ¹æ®å†…å­˜å’Œéœ€æ±‚è®¾ç½®
- å¯ç”¨sendfileã€tcp_nopushç­‰ä¼˜åŒ–é€‰é¡¹
- åˆç†è®¾ç½®keepalive_timeout
```

### 7.3 å®žé™…åº”ç”¨ä»·å€¼


**ðŸŽ¯ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²**
- **WebæœåŠ¡å™¨**ï¼šé«˜æ€§èƒ½é™æ€æ–‡ä»¶æœåŠ¡
- **åå‘ä»£ç†**ï¼šåŽç«¯åº”ç”¨çš„ç»Ÿä¸€å…¥å£
- **è´Ÿè½½å‡è¡¡**ï¼šå¤šæœåŠ¡å™¨æµé‡åˆ†å‘
- **SSLç»ˆç«¯**ï¼šHTTPSè¯ä¹¦é›†ä¸­ç®¡ç†

**ðŸ”§ è¿ç»´å®žè·µ**
- **æœåŠ¡ç®¡ç†**ï¼šsystemctl + nginxå‘½ä»¤ç»„åˆä½¿ç”¨
- **é…ç½®ç®¡ç†**ï¼šæ¨¡å—åŒ–é…ç½®ï¼Œä¾¿äºŽç»´æŠ¤
- **ç›‘æŽ§æ—¥å¿—**ï¼šaccess.logåˆ†æžè®¿é—®æƒ…å†µï¼Œerror.logæŽ’æŸ¥é—®é¢˜
- **å®‰å…¨é˜²æŠ¤**ï¼šè®¿é—®æŽ§åˆ¶ã€è¯·æ±‚é™åˆ¶ã€ç‰ˆæœ¬éšè—

**ðŸ› ï¸ å¼€å‘çŽ¯å¢ƒ**
- **æœ¬åœ°æµ‹è¯•**ï¼šå¿«é€Ÿæ­å»ºå¼€å‘çŽ¯å¢ƒ
- **é™æ€èµ„æº**ï¼šå‰ç«¯é¡¹ç›®éƒ¨ç½²
- **APIä»£ç†**ï¼šè§£å†³è·¨åŸŸé—®é¢˜
- **HTTPSæµ‹è¯•**ï¼šSSLè¯ä¹¦é…ç½®éªŒè¯

### 7.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ðŸ“š å­¦ä¹ è¿›é˜¶è·¯çº¿**
```
åŸºç¡€é˜¶æ®µï¼š
âœ… æŽŒæ¡å®‰è£…é…ç½®
âœ… ç†è§£åŸºæœ¬æ¦‚å¿µ
âœ… ç†Ÿæ‚‰æœåŠ¡ç®¡ç†

è¿›é˜¶é˜¶æ®µï¼š
ðŸ”¸ è™šæ‹Ÿä¸»æœºé…ç½®
ðŸ”¸ åå‘ä»£ç†è®¾ç½®
ðŸ”¸ è´Ÿè½½å‡è¡¡é…ç½®
ðŸ”¸ SSLè¯ä¹¦éƒ¨ç½²

é«˜çº§é˜¶æ®µï¼š
ðŸš€ æ€§èƒ½è°ƒä¼˜
ðŸš€ æ¨¡å—å¼€å‘
ðŸš€ é›†ç¾¤éƒ¨ç½²
ðŸš€ ç›‘æŽ§è¿ç»´
```

**ðŸ’¡ å®žç”¨æŠ€å·§è®°å¿†**
- **é…ç½®æ£€æŸ¥**ï¼šæ”¹é…ç½®å¿…æ£€æŸ¥ï¼Œnginx -tæ˜¯å¥½ä¹ æƒ¯
- **å¹³æ»‘é‡è½½**ï¼šreloadä¸æ–­è¿žï¼Œrestartä¼šä¸­æ–­
- **æ—¥å¿—åˆ†æž**ï¼šaccessçœ‹è®¿é—®ï¼ŒerroræŸ¥é—®é¢˜
- **è¿›ç¨‹ç®¡ç†**ï¼šmasterç®¡workerï¼Œworkerå¤„ç†è¯·æ±‚
- **å®‰å…¨åŽŸåˆ™**ï¼šæœ€å°æƒé™ï¼Œéšè—ç‰ˆæœ¬ï¼Œé™åˆ¶è®¿é—®

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Nginxè½»é‡é«˜å¹¶å‘ï¼Œäº‹ä»¶é©±åŠ¨æ€§èƒ½å¼º
- å®‰è£…é€‰æ‹©çœ‹éœ€æ±‚ï¼Œç³»ç»Ÿæºç¨³å®˜æ–¹æ–°  
- é…ç½®æ£€æŸ¥å†é‡è½½ï¼Œå¹³æ»‘å‡çº§ä¸ä¸­æ–­
- masterç®¡ç†workerå¹²ï¼Œè¿›ç¨‹æ¨¡åž‹è¦è®°æ¸…
- å®‰å…¨é…ç½®ä¸èƒ½å¿˜ï¼Œç”¨æˆ·æƒé™è®¿é—®æŽ§