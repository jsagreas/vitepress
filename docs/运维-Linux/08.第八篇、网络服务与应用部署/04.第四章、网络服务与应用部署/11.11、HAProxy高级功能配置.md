---
title: 11ã€HAProxyé«˜çº§åŠŸèƒ½é…ç½®
---
## ğŸ“š ç›®å½•

1. [HAProxyé«˜çº§åŠŸèƒ½æ¦‚è¿°](#1-haproxyé«˜çº§åŠŸèƒ½æ¦‚è¿°)
2. [ACLè®¿é—®æ§åˆ¶åˆ—è¡¨](#2-aclè®¿é—®æ§åˆ¶åˆ—è¡¨)
3. [HTTPè¯·æ±‚è·¯ç”±è§„åˆ™](#3-httpè¯·æ±‚è·¯ç”±è§„åˆ™)
4. [åŸºäºå†…å®¹çš„è´Ÿè½½å‡è¡¡](#4-åŸºäºå†…å®¹çš„è´Ÿè½½å‡è¡¡)
5. [SSLç»ˆç«¯é…ç½®](#5-sslç»ˆç«¯é…ç½®)
6. [ç»Ÿè®¡é¡µé¢é…ç½®](#6-ç»Ÿè®¡é¡µé¢é…ç½®)
7. [æ—¥å¿—é…ç½®ä¸åˆ†æ](#7-æ—¥å¿—é…ç½®ä¸åˆ†æ)
8. [æ•…éšœè½¬ç§»é…ç½®](#8-æ•…éšœè½¬ç§»é…ç½®)
9. [æ€§èƒ½è°ƒä¼˜å‚æ•°](#9-æ€§èƒ½è°ƒä¼˜å‚æ•°)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ HAProxyé«˜çº§åŠŸèƒ½æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯HAProxyé«˜çº§åŠŸèƒ½


**HAProxyé«˜çº§åŠŸèƒ½**æ˜¯åœ¨åŸºç¡€è´Ÿè½½å‡è¡¡åŠŸèƒ½ä¹‹ä¸Šçš„å¼ºå¤§æ‰©å±•ï¼Œè®©ä½ èƒ½å¤Ÿç²¾ç¡®æ§åˆ¶æµé‡åˆ†å‘ã€å®‰å…¨é˜²æŠ¤å’Œç›‘æ§ç®¡ç†ã€‚

```
åŸºç¡€åŠŸèƒ½ï¼šç®€å•çš„è´Ÿè½½å‡è¡¡
         å®¢æˆ·ç«¯ â†’ HAProxy â†’ åç«¯æœåŠ¡å™¨

é«˜çº§åŠŸèƒ½ï¼šæ™ºèƒ½çš„æµé‡æ§åˆ¶
         å®¢æˆ·ç«¯ â†’ HAProxy â†’ æ ¹æ®è§„åˆ™ â†’ ä¸åŒåç«¯
                    â†“
               è®¿é—®æ§åˆ¶ã€SSLå¤„ç†ã€ç›‘æ§
```

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ¯ **ç²¾ç»†æ§åˆ¶**ï¼šæ ¹æ®è¯·æ±‚å†…å®¹æ™ºèƒ½è·¯ç”±
- ğŸ”’ **å®‰å…¨å¢å¼º**ï¼šSSLå¤„ç†ã€è®¿é—®æ§åˆ¶
- ğŸ“Š **å¯è§‚æµ‹æ€§**ï¼šè¯¦ç»†ç›‘æ§å’Œæ—¥å¿—
- ğŸ›¡ï¸ **é«˜å¯ç”¨æ€§**ï¼šæ•…éšœè‡ªåŠ¨è½¬ç§»

### 1.2 é«˜çº§åŠŸèƒ½çš„åº”ç”¨åœºæ™¯


**ä¼ä¸šçº§åº”ç”¨åœºæ™¯**ï¼š
```
ç”µå•†ç½‘ç«™ï¼š
- æ‰‹æœºç”¨æˆ· â†’ ç§»åŠ¨ç‰ˆæœåŠ¡å™¨
- PCç”¨æˆ· â†’ æ¡Œé¢ç‰ˆæœåŠ¡å™¨
- VIPç”¨æˆ· â†’ é«˜æ€§èƒ½æœåŠ¡å™¨

APIç½‘å…³ï¼š
- /api/v1/* â†’ æ—§ç‰ˆAPIæœåŠ¡å™¨
- /api/v2/* â†’ æ–°ç‰ˆAPIæœåŠ¡å™¨
- ç®¡ç†å‘˜è¯·æ±‚ â†’ ç®¡ç†APIæœåŠ¡å™¨

å¤šç§Ÿæˆ·SaaSï¼š
- ä¼ä¸šA.com â†’ ä¼ä¸šAä¸“ç”¨æœåŠ¡å™¨
- ä¼ä¸šB.com â†’ ä¼ä¸šBä¸“ç”¨æœåŠ¡å™¨
```

---

## 2. ğŸ” ACLè®¿é—®æ§åˆ¶åˆ—è¡¨


### 2.1 ACLåŸºæœ¬æ¦‚å¿µ


**ACLï¼ˆAccess Control Listï¼‰**ï¼šè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼Œå°±åƒé—¨å«ä¸€æ ·ï¼Œæ ¹æ®ä¸åŒæ¡ä»¶å†³å®šæ˜¯å¦æ”¾è¡Œè¯·æ±‚ã€‚

**å·¥ä½œåŸç†**ï¼š
```
è¯·æ±‚åˆ°è¾¾ â†’ æ£€æŸ¥ACLæ¡ä»¶ â†’ æ»¡è¶³æ¡ä»¶ï¼Ÿ â†’ æ‰§è¡Œå¯¹åº”åŠ¨ä½œ
                         â†“
                    æ˜¯ï¼šå…è®¸/è·¯ç”±
                    å¦ï¼šæ‹’ç»/å…¶ä»–å¤„ç†
```

### 2.2 ACLè¯­æ³•ç»“æ„


**åŸºæœ¬è¯­æ³•**ï¼š
```bash
acl <aclåç§°> <åŒ¹é…æ¡ä»¶> <åŒ¹é…å€¼>
```

**å¸¸ç”¨åŒ¹é…æ¡ä»¶**ï¼š

| æ¡ä»¶ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|------|------|
| `src` | æºIPåœ°å€ | `acl internal_ip src 192.168.1.0/24` |
| `path_beg` | è·¯å¾„å¼€å¤´åŒ¹é… | `acl api_request path_beg /api/` |
| `hdr` | HTTPå¤´éƒ¨åŒ¹é… | `acl mobile_user hdr(User-Agent) -i mobile` |
| `method` | HTTPæ–¹æ³• | `acl post_request method POST` |
| `url_param` | URLå‚æ•° | `acl vip_user url_param(type) vip` |

### 2.3 å®ç”¨ACLé…ç½®ç¤ºä¾‹


```bash
# /etc/haproxy/haproxy.cfg

frontend web_frontend
    bind *:80
    
    # å®šä¹‰ACLè§„åˆ™
    acl is_admin src 10.0.1.100          # ç®¡ç†å‘˜IP
    acl is_api path_beg /api/             # APIè¯·æ±‚
    acl is_static path_end .css .js .png .jpg  # é™æ€æ–‡ä»¶
    acl is_mobile hdr(User-Agent) -i mobile android iphone  # ç§»åŠ¨è®¾å¤‡
    acl office_hours time 09:00-18:00     # å·¥ä½œæ—¶é—´
    
    # æ ¹æ®ACLæ‰§è¡Œä¸åŒåŠ¨ä½œ
    use_backend admin_servers if is_admin
    use_backend api_servers if is_api
    use_backend static_servers if is_static
    use_backend mobile_servers if is_mobile
    
    # å·¥ä½œæ—¶é—´å¤–æ‹’ç»è®¿é—®
    http-request deny if !office_hours !is_admin
    
    default_backend web_servers

backend admin_servers
    server admin1 192.168.1.10:8080 check

backend api_servers
    server api1 192.168.1.20:8080 check
    server api2 192.168.1.21:8080 check

backend mobile_servers
    server mobile1 192.168.1.30:8080 check

backend static_servers
    server static1 192.168.1.40:8080 check

backend web_servers
    server web1 192.168.1.50:8080 check
    server web2 192.168.1.51:8080 check
```

### 2.4 é«˜çº§ACLç»„åˆä½¿ç”¨


**é€»è¾‘è¿ç®—ç¬¦**ï¼š
- `AND`ï¼š`if condition1 condition2`ï¼ˆåŒæ—¶æ»¡è¶³ï¼‰
- `OR`ï¼š`if condition1 || condition2`ï¼ˆæ»¡è¶³ä»»ä¸€ï¼‰
- `NOT`ï¼š`if !condition`ï¼ˆä¸æ»¡è¶³ï¼‰

```bash
# å¤æ‚ACLç»„åˆç¤ºä¾‹
frontend complex_frontend
    bind *:80
    
    # å®šä¹‰åŸºç¡€ACL
    acl is_internal src 192.168.0.0/16
    acl is_https ssl_fc
    acl is_admin path_beg /admin/
    acl is_weekend time Sat,Sun
    
    # ç»„åˆACLï¼šå†…ç½‘ç®¡ç†å‘˜åœ¨å‘¨æœ«é€šè¿‡HTTPSè®¿é—®
    acl secure_admin_access is_internal is_https is_admin
    
    # ä»…å…è®¸å®‰å…¨çš„ç®¡ç†å‘˜è®¿é—®
    use_backend admin_servers if secure_admin_access
    
    # å‘¨æœ«ç¦æ­¢å¤–ç½‘è®¿é—®ç®¡ç†é¡µé¢
    http-request deny if is_admin is_weekend !is_internal
    
    default_backend web_servers
```

---

## 3. ğŸ›£ï¸ HTTPè¯·æ±‚è·¯ç”±è§„åˆ™


### 3.1 è·¯ç”±è§„åˆ™åŸºæœ¬æ¦‚å¿µ


**HTTPè·¯ç”±**ï¼šæ ¹æ®è¯·æ±‚çš„ä¸åŒç‰¹å¾ï¼ˆURLã€å¤´éƒ¨ã€å‚æ•°ç­‰ï¼‰å°†æµé‡åˆ†å‘åˆ°ä¸åŒçš„åç«¯æœåŠ¡ï¼Œå°±åƒäº¤é€šæŒ‡æŒ¥å‘˜æŒ‡å¼•è½¦è¾†èµ°ä¸åŒè·¯çº¿ã€‚

```
è·¯ç”±å†³ç­–æµç¨‹ï¼š
å®¢æˆ·ç«¯è¯·æ±‚ â†’ åˆ†æè¯·æ±‚ç‰¹å¾ â†’ åŒ¹é…è·¯ç”±è§„åˆ™ â†’ é€‰æ‹©ç›®æ ‡åç«¯
    â†“           â†“            â†“            â†“
 /api/users  æ£€æŸ¥URLè·¯å¾„   åŒ¹é…APIè§„åˆ™   è½¬å‘è‡³APIæœåŠ¡å™¨
```

### 3.2 åŸºäºURLè·¯å¾„çš„è·¯ç”±


**è·¯å¾„åŒ¹é…æ–¹å¼**ï¼š

| åŒ¹é…ç±»å‹ | æŒ‡ä»¤ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|------|------|------|
| å‰ç¼€åŒ¹é… | `path_beg` | URLä»¥æŒ‡å®šå­—ç¬¦ä¸²å¼€å¤´ | `/api/` åŒ¹é…æ‰€æœ‰APIè¯·æ±‚ |
| åç¼€åŒ¹é… | `path_end` | URLä»¥æŒ‡å®šå­—ç¬¦ä¸²ç»“å°¾ | `.jpg` åŒ¹é…å›¾ç‰‡æ–‡ä»¶ |
| å®Œå…¨åŒ¹é… | `path` | URLå®Œå…¨ç­‰äºæŒ‡å®šå€¼ | `/login` åªåŒ¹é…ç™»å½•é¡µ |
| æ­£åˆ™åŒ¹é… | `path_reg` | ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ | `^/user/[0-9]+$` åŒ¹é…ç”¨æˆ·ID |

```bash
frontend http_router
    bind *:80
    
    # APIè·¯ç”±ï¼šæ‰€æœ‰/api/å¼€å¤´çš„è¯·æ±‚
    acl is_api_v1 path_beg /api/v1/
    acl is_api_v2 path_beg /api/v2/
    
    # é™æ€èµ„æºè·¯ç”±
    acl is_images path_end .jpg .jpeg .png .gif
    acl is_assets path_beg /assets/ /static/
    
    # ç‰¹æ®Šé¡µé¢è·¯ç”±
    acl is_admin_panel path_beg /admin/
    acl is_health_check path /health
    
    # ç”¨æˆ·ä¸ªäººé¡µé¢ï¼ˆæ­£åˆ™åŒ¹é…ï¼‰
    acl is_user_profile path_reg ^/user/[0-9]+/?$
    
    # è·¯ç”±åˆ°ä¸åŒåç«¯
    use_backend api_v1_servers if is_api_v1
    use_backend api_v2_servers if is_api_v2
    use_backend image_servers if is_images
    use_backend static_servers if is_assets
    use_backend admin_servers if is_admin_panel
    use_backend health_servers if is_health_check
    use_backend user_servers if is_user_profile
    
    default_backend web_servers
```

### 3.3 åŸºäºHTTPå¤´éƒ¨çš„è·¯ç”±


**å¸¸ç”¨å¤´éƒ¨è·¯ç”±**ï¼š

```bash
frontend header_router
    bind *:80
    
    # åŸºäºUser-Agentçš„è®¾å¤‡è¯†åˆ«
    acl is_mobile hdr_sub(User-Agent) Mobile
    acl is_iphone hdr_sub(User-Agent) iPhone
    acl is_android hdr_sub(User-Agent) Android
    acl is_bot hdr_sub(User-Agent) bot crawler spider
    
    # åŸºäºAcceptå¤´çš„å†…å®¹åå•†
    acl wants_json hdr(Accept) -i application/json
    acl wants_xml hdr(Accept) -i application/xml
    
    # åŸºäºHostå¤´çš„å¤šåŸŸåè·¯ç”±
    acl is_api_domain hdr(Host) -i api.example.com
    acl is_admin_domain hdr(Host) -i admin.example.com
    acl is_mobile_domain hdr(Host) -i m.example.com
    
    # åŸºäºè‡ªå®šä¹‰å¤´éƒ¨
    acl is_internal_service hdr(X-Internal-Service) -i true
    acl client_version hdr(X-Client-Version) -i 2.0
    
    # è·¯ç”±å†³ç­–
    use_backend mobile_servers if is_mobile || is_mobile_domain
    use_backend api_servers if is_api_domain || wants_json
    use_backend admin_servers if is_admin_domain
    use_backend bot_servers if is_bot
    use_backend internal_servers if is_internal_service
    
    default_backend web_servers
```

### 3.4 åŸºäºè¯·æ±‚å‚æ•°çš„è·¯ç”±


```bash
frontend param_router
    bind *:80
    
    # URLå‚æ•°è·¯ç”±
    acl is_vip_user url_param(tier) vip premium
    acl is_beta_user url_param(beta) -i true 1 yes
    acl specific_version url_param(v) 2.0
    
    # æŸ¥è¯¢å­—ç¬¦ä¸²åŒ…å«ç‰¹å®šå‚æ•°
    acl has_debug_param urlp(debug)
    acl mobile_app urlp(source) -i mobile-app
    
    # è·¯ç”±åˆ°ä¸åŒåç«¯
    use_backend vip_servers if is_vip_user
    use_backend beta_servers if is_beta_user
    use_backend debug_servers if has_debug_param
    use_backend mobile_api_servers if mobile_app
    
    default_backend web_servers
```

---

## 4. âš–ï¸ åŸºäºå†…å®¹çš„è´Ÿè½½å‡è¡¡


### 4.1 åŸºäºå†…å®¹è´Ÿè½½å‡è¡¡çš„æ¦‚å¿µ


**ä¼ ç»Ÿè´Ÿè½½å‡è¡¡**ï¼šä¸ç®¡è¯·æ±‚å†…å®¹ï¼ŒæŒ‰ç®—æ³•åˆ†å‘ï¼ˆè½®è¯¢ã€æƒé‡ç­‰ï¼‰
**åŸºäºå†…å®¹çš„è´Ÿè½½å‡è¡¡**ï¼šæ ¹æ®è¯·æ±‚å†…å®¹ç‰¹å¾ï¼Œæ™ºèƒ½é€‰æ‹©æœ€é€‚åˆçš„åç«¯æœåŠ¡å™¨

```
ä¼ ç»Ÿæ–¹å¼ï¼š
è¯·æ±‚1 â†’ æœåŠ¡å™¨A
è¯·æ±‚2 â†’ æœåŠ¡å™¨B
è¯·æ±‚3 â†’ æœåŠ¡å™¨C

åŸºäºå†…å®¹ï¼š
å›¾ç‰‡è¯·æ±‚ â†’ å›¾ç‰‡ä¼˜åŒ–æœåŠ¡å™¨
APIè¯·æ±‚ â†’ APIä¸“ç”¨æœåŠ¡å™¨
é™æ€æ–‡ä»¶ â†’ CDNè¾¹ç¼˜æœåŠ¡å™¨
```

### 4.2 åŸºäºç”¨æˆ·ç‰¹å¾çš„è´Ÿè½½å‡è¡¡


```bash
frontend content_aware_lb
    bind *:80
    
    # ç”¨æˆ·åˆ†ç±»ACL
    acl is_premium_user hdr(X-User-Tier) premium
    acl is_enterprise_user hdr(X-User-Type) enterprise
    acl is_new_user hdr(X-Account-Age) -m int lt 30  # è´¦æˆ·å°äº30å¤©
    
    # åœ°ç†ä½ç½®åˆ†ç±»
    acl is_asia_user hdr(X-Country-Code) CN JP KR
    acl is_europe_user hdr(X-Country-Code) DE FR GB
    acl is_america_user hdr(X-Country-Code) US CA
    
    # é«˜ä»·å€¼ç”¨æˆ·ä½¿ç”¨é«˜æ€§èƒ½æœåŠ¡å™¨
    use_backend premium_servers if is_premium_user
    use_backend enterprise_servers if is_enterprise_user
    
    # åœ°ç†ä½ç½®å°±è¿‘åˆ†é…
    use_backend asia_servers if is_asia_user
    use_backend europe_servers if is_europe_user
    use_backend america_servers if is_america_user
    
    # æ–°ç”¨æˆ·å¼•å¯¼æœåŠ¡å™¨
    use_backend onboarding_servers if is_new_user
    
    default_backend standard_servers

# ä¸åŒæ€§èƒ½ç­‰çº§çš„åç«¯æœåŠ¡å™¨
backend premium_servers
    # é«˜æ€§èƒ½æœåŠ¡å™¨ï¼ŒSSDå­˜å‚¨ï¼Œæ›´å¤šCPU
    balance roundrobin
    server premium1 10.0.1.10:8080 check weight 100
    server premium2 10.0.1.11:8080 check weight 100

backend enterprise_servers
    # ä¼ä¸šçº§æœåŠ¡å™¨ï¼Œä¸“ç”¨èµ„æº
    balance leastconn
    server enterprise1 10.0.2.10:8080 check
    server enterprise2 10.0.2.11:8080 check

backend standard_servers
    # æ ‡å‡†æœåŠ¡å™¨
    balance roundrobin
    server std1 10.0.3.10:8080 check weight 50
    server std2 10.0.3.11:8080 check weight 50
    server std3 10.0.3.12:8080 check weight 50
```

### 4.3 åŸºäºè¯·æ±‚ç±»å‹çš„è´Ÿè½½å‡è¡¡


```bash
frontend request_type_lb
    bind *:80
    
    # è¯·æ±‚ç±»å‹åˆ†ç±»
    acl is_read_request method GET HEAD
    acl is_write_request method POST PUT DELETE PATCH
    acl is_upload_request path_beg /upload/
    acl is_search_request path_beg /search/
    acl is_report_request path_beg /report/
    
    # å¤§æ–‡ä»¶ä¸Šä¼ 
    acl is_large_upload hdr(Content-Length) -m int gt 10485760  # >10MB
    
    # è®¡ç®—å¯†é›†å‹è¯·æ±‚
    acl is_compute_heavy path_beg /analytics/ /calculate/
    
    # ä¸åŒç±»å‹è¯·æ±‚åˆ†é…åˆ°ä¸“é—¨æœåŠ¡å™¨
    use_backend upload_servers if is_upload_request || is_large_upload
    use_backend search_servers if is_search_request
    use_backend compute_servers if is_compute_heavy
    use_backend report_servers if is_report_request
    
    # è¯»å†™åˆ†ç¦»
    use_backend read_servers if is_read_request
    use_backend write_servers if is_write_request
    
    default_backend web_servers

backend upload_servers
    # ä¸Šä¼ ä¸“ç”¨ï¼Œå¤§å¸¦å®½ï¼Œå¤§å­˜å‚¨
    balance source  # ä¿æŒä¼šè¯ç²˜æ€§
    server upload1 10.0.4.10:8080 check maxconn 50
    server upload2 10.0.4.11:8080 check maxconn 50

backend search_servers
    # æœç´¢ä¸“ç”¨ï¼Œå†…å­˜ä¼˜åŒ–
    balance leastconn
    server search1 10.0.5.10:8080 check
    server search2 10.0.5.11:8080 check

backend compute_servers
    # è®¡ç®—ä¸“ç”¨ï¼ŒCPUä¼˜åŒ–
    balance roundrobin
    server compute1 10.0.6.10:8080 check maxconn 20
    server compute2 10.0.6.11:8080 check maxconn 20
```

### 4.4 ä¼šè¯ä¿æŒä¸ç²˜æ€§


```bash
# åŸºäºCookieçš„ä¼šè¯ä¿æŒ
backend sticky_sessions
    balance roundrobin
    cookie JSESSIONID prefix nocache
    
    server web1 10.0.7.10:8080 check cookie web1
    server web2 10.0.7.11:8080 check cookie web2
    server web3 10.0.7.12:8080 check cookie web3

# åŸºäºIPçš„ä¼šè¯ä¿æŒ
backend ip_sticky
    balance source
    hash-type consistent  # ä¸€è‡´æ€§å“ˆå¸Œï¼Œå‡å°‘èŠ‚ç‚¹å˜åŒ–å½±å“
    
    server app1 10.0.8.10:8080 check
    server app2 10.0.8.11:8080 check
    server app3 10.0.8.12:8080 check
```

---

## 5. ğŸ”’ SSLç»ˆç«¯é…ç½®


### 5.1 SSL Terminationæ¦‚å¿µ


**SSL Terminationï¼ˆSSLç»ˆæ­¢ï¼‰**ï¼šHAProxyä»£æ›¿åç«¯æœåŠ¡å™¨å¤„ç†SSLåŠ å¯†è§£å¯†å·¥ä½œï¼Œå°±åƒä¸“ä¸šçš„ç¿»è¯‘å‘˜ï¼Œå®¢æˆ·ç«¯è¯´å¯†è¯­ï¼ŒHAProxyç¿»è¯‘æˆæ™®é€šè¯ç»™åç«¯æœåŠ¡å™¨ã€‚

```
SSL Terminationæµç¨‹ï¼š
å®¢æˆ·ç«¯(HTTPS) â†’ HAProxy(SSLå¤„ç†) â†’ åç«¯æœåŠ¡å™¨(HTTP)
    â†“              â†“                    â†“
  åŠ å¯†æ•°æ®      è§£å¯†/é‡æ–°åŠ å¯†          æ˜æ–‡æ•°æ®
```

**ä¼˜åŠ¿**ï¼š
- ğŸš€ **æ€§èƒ½æå‡**ï¼šä¸“ç”¨SSLç¡¬ä»¶åŠ é€Ÿ
- ğŸ”§ **ç®¡ç†ç®€åŒ–**ï¼šè¯ä¹¦é›†ä¸­ç®¡ç†
- ğŸ›¡ï¸ **å®‰å…¨å¢å¼º**ï¼šç»Ÿä¸€SSLç­–ç•¥
- ğŸ’° **æˆæœ¬é™ä½**ï¼šå‡å°‘åç«¯SSLå¼€é”€

### 5.2 åŸºç¡€SSLé…ç½®


```bash
# /etc/haproxy/haproxy.cfg

global
    # SSLä¼˜åŒ–é…ç½®
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    tune.ssl.default-dh-param 2048

frontend https_frontend
    # ç»‘å®š443ç«¯å£ï¼ŒæŒ‡å®šSSLè¯ä¹¦
    bind *:443 ssl crt /etc/ssl/certs/example.com.pem
    
    # HTTPé‡å®šå‘åˆ°HTTPS
    bind *:80
    redirect scheme https if !{ ssl_fc }
    
    # SSLç›¸å…³ACL
    acl is_secure ssl_fc
    acl is_tls12 ssl_fc_protocol -i TLSv1.2
    acl is_tls13 ssl_fc_protocol -i TLSv1.3
    
    # æ·»åŠ å®‰å…¨å¤´éƒ¨
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff
    
    default_backend secure_servers

backend secure_servers
    # åç«¯ä½¿ç”¨HTTPï¼ˆSSLå·²åœ¨å‰ç«¯ç»ˆæ­¢ï¼‰
    balance roundrobin
    server web1 192.168.1.10:8080 check
    server web2 192.168.1.11:8080 check
```

### 5.3 å¤šåŸŸåSSLé…ç½®


```bash
frontend multi_domain_ssl
    # å¤šè¯ä¹¦é…ç½®ï¼Œæ”¯æŒSNI
    bind *:443 ssl crt-list /etc/haproxy/ssl_certs.list
    
    # åŸºäºåŸŸåçš„è·¯ç”±
    acl is_api_domain ssl_fc_sni api.example.com
    acl is_admin_domain ssl_fc_sni admin.example.com
    acl is_shop_domain ssl_fc_sni shop.example.com
    
    # æ ¹æ®åŸŸåè·¯ç”±åˆ°ä¸åŒåç«¯
    use_backend api_servers if is_api_domain
    use_backend admin_servers if is_admin_domain
    use_backend shop_servers if is_shop_domain
    
    default_backend web_servers

# SSLè¯ä¹¦åˆ—è¡¨æ–‡ä»¶ /etc/haproxy/ssl_certs.list
# example.com.pem
# api.example.com.pem
# admin.example.com.pem
# shop.example.com.pem
```

### 5.4 SSL passthroughé…ç½®


**é€‚ç”¨åœºæ™¯**ï¼šåç«¯æœåŠ¡å™¨éœ€è¦ç›´æ¥å¤„ç†SSLï¼ˆå¦‚WebSocketå®‰å…¨è¿æ¥ï¼‰

```bash
frontend ssl_passthrough
    bind *:443
    mode tcp  # TCPæ¨¡å¼ï¼Œä¸è§£æHTTP
    
    # åŸºäºSNIçš„è·¯ç”±ï¼ˆä¸è§£å¯†å†…å®¹ï¼‰
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }
    
    acl is_websocket_domain req_ssl_sni websocket.example.com
    acl is_secure_api_domain req_ssl_sni secure-api.example.com
    
    use_backend websocket_ssl_servers if is_websocket_domain
    use_backend secure_api_ssl_servers if is_secure_api_domain
    
    default_backend default_ssl_servers

backend websocket_ssl_servers
    mode tcp
    balance roundrobin
    server ws1 192.168.1.20:443 check
    server ws2 192.168.1.21:443 check

backend secure_api_ssl_servers
    mode tcp
    balance roundrobin
    server api1 192.168.1.30:443 check
    server api2 192.168.1.31:443 check
```

---

## 6. ğŸ“Š ç»Ÿè®¡é¡µé¢é…ç½®


### 6.1 ç»Ÿè®¡é¡µé¢åŸºæœ¬æ¦‚å¿µ


**HAProxyç»Ÿè®¡é¡µé¢**ï¼šå®æ—¶ç›‘æ§ç•Œé¢ï¼Œæ˜¾ç¤ºè´Ÿè½½å‡è¡¡å™¨å’Œåç«¯æœåŠ¡å™¨çš„è¿è¡ŒçŠ¶æ€ï¼Œå°±åƒæ±½è½¦ä»ªè¡¨ç›˜æ˜¾ç¤ºé€Ÿåº¦ã€æ²¹é‡ã€æ¸©åº¦ç­‰ä¿¡æ¯ã€‚

**æä¾›ä¿¡æ¯**ï¼š
- ğŸ“ˆ **å®æ—¶æµé‡**ï¼šå½“å‰è¿æ¥æ•°ã€è¯·æ±‚ç‡
- ğŸ¥ **å¥åº·çŠ¶æ€**ï¼šæœåŠ¡å™¨åœ¨çº¿/ç¦»çº¿çŠ¶æ€
- âš¡ **æ€§èƒ½æŒ‡æ ‡**ï¼šå“åº”æ—¶é—´ã€é”™è¯¯ç‡
- ğŸ“Š **å†å²ç»Ÿè®¡**ï¼šç´¯è®¡è¯·æ±‚æ•°ã€æ•°æ®ä¼ è¾“é‡

### 6.2 åŸºç¡€ç»Ÿè®¡é¡µé¢é…ç½®


```bash
# å…¨å±€ç»Ÿè®¡é…ç½®
global
    stats socket /var/lib/haproxy/stats

# ç»Ÿè®¡é¡µé¢å‰ç«¯
frontend stats_frontend
    bind *:8404
    stats enable
    stats uri /stats                    # è®¿é—®è·¯å¾„ï¼šhttp://ip:8404/stats
    stats refresh 30s                   # 30ç§’è‡ªåŠ¨åˆ·æ–°
    stats hide-version                  # éšè—HAProxyç‰ˆæœ¬ä¿¡æ¯
    
    # ç®¡ç†å‘˜è®¤è¯
    stats auth admin:secretpassword123
    stats auth monitor:readonly456
    
    # é¡µé¢æ ‡é¢˜å’Œæè¿°
    stats realm HAProxy\ Statistics
    stats admin if TRUE                 # å¯ç”¨ç®¡ç†åŠŸèƒ½

# ç®€åŒ–çš„ä¸“ç”¨ç»Ÿè®¡é…ç½®
listen stats_simple
    bind *:9000
    stats enable
    stats uri /
    stats refresh 10s
    stats show-legends
    stats show-node
```

### 6.3 é«˜çº§ç»Ÿè®¡é…ç½®


```bash
frontend advanced_stats
    bind *:8404
    
    # åŸºäºIPçš„è®¿é—®æ§åˆ¶
    acl allowed_ips src 192.168.1.0/24 10.0.0.0/8
    acl admin_ips src 192.168.1.100 192.168.1.101
    
    # ç»Ÿè®¡é¡µé¢é…ç½®
    stats enable
    stats uri /haproxy-stats
    stats refresh 15s
    stats hide-version
    stats show-legends                  # æ˜¾ç¤ºå›¾ä¾‹è¯´æ˜
    stats show-node                     # æ˜¾ç¤ºèŠ‚ç‚¹åç§°
    
    # å¤šçº§æƒé™æ§åˆ¶
    stats auth admin:admin123 if admin_ips      # ç®¡ç†å‘˜å®Œå…¨æƒé™
    stats auth viewer:view123 if allowed_ips    # æ™®é€šç”¨æˆ·åªè¯»æƒé™
    
    # æ‹’ç»æœªæˆæƒè®¿é—®
    stats http-request deny unless allowed_ips
    
    # ç®¡ç†åŠŸèƒ½ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
    stats admin if admin_ips
    
    # è‡ªå®šä¹‰é¡µé¢æ ·å¼
    stats realm "Production HAProxy Monitoring"
```

### 6.4 ç»Ÿè®¡é¡µé¢åŠŸèƒ½è¯¦è§£


**ä¸»è¦ç›‘æ§æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ç±»å‹ | å«ä¹‰ | å…³æ³¨é‡ç‚¹ |
|---------|------|---------|
| **Session** | å½“å‰æ´»è·ƒè¿æ¥æ•° | é«˜å³°æœŸæ˜¯å¦æ¥è¿‘ä¸Šé™ |
| **Queue** | æ’é˜Ÿç­‰å¾…çš„è¯·æ±‚ | æ˜¯å¦å‡ºç°ç§¯å‹ |
| **Response Time** | å¹³å‡å“åº”æ—¶é—´ | æ€§èƒ½æ˜¯å¦æ­£å¸¸ |
| **Error Rate** | é”™è¯¯è¯·æ±‚æ¯”ä¾‹ | æœåŠ¡è´¨é‡æŒ‡æ ‡ |
| **Health Check** | å¥åº·æ£€æŸ¥çŠ¶æ€ | æœåŠ¡å™¨å¯ç”¨æ€§ |

**ç®¡ç†æ“ä½œåŠŸèƒ½**ï¼š
```bash
# é€šè¿‡ç»Ÿè®¡é¡µé¢å¯æ‰§è¡Œçš„æ“ä½œï¼š
- å¯ç”¨/ç¦ç”¨æœåŠ¡å™¨
- è®¾ç½®æœåŠ¡å™¨æƒé‡
- æ¸…ç©ºç»Ÿè®¡æ•°æ®
- æŸ¥çœ‹è¯¦ç»†ä¼šè¯ä¿¡æ¯
- å¯¼å‡ºç»Ÿè®¡æ•°æ®
```

**ç»Ÿè®¡æ•°æ®å¯¼å‡º**ï¼š
```bash
# é€šè¿‡å‘½ä»¤è¡Œè·å–ç»Ÿè®¡æ•°æ®
echo "show stat" | socat stdio /var/lib/haproxy/stats

# è·å–ç‰¹å®šä¿¡æ¯
echo "show info" | socat stdio /var/lib/haproxy/stats
echo "show sessions" | socat stdio /var/lib/haproxy/stats
```

---

## 7. ğŸ“ æ—¥å¿—é…ç½®ä¸åˆ†æ


### 7.1 HAProxyæ—¥å¿—åŸºæœ¬æ¦‚å¿µ


**HAProxyæ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰é€šè¿‡è´Ÿè½½å‡è¡¡å™¨çš„è¯·æ±‚ä¿¡æ¯ï¼Œå°±åƒé—¨å«çš„ç™»è®°ç°¿ï¼Œè®°å½•è°æ¥äº†ã€ä»€ä¹ˆæ—¶å€™æ¥çš„ã€å»äº†å“ªé‡Œã€‚

**æ—¥å¿—ä»·å€¼**ï¼š
- ğŸ” **æ•…éšœæ’æŸ¥**ï¼šå¿«é€Ÿå®šä½é—®é¢˜æ ¹æº
- ğŸ“Š **æ€§èƒ½åˆ†æ**ï¼šäº†è§£ç³»ç»Ÿè´Ÿè½½æƒ…å†µ  
- ğŸ›¡ï¸ **å®‰å…¨ç›‘æ§**ï¼šå‘ç°å¼‚å¸¸è®¿é—®è¡Œä¸º
- ğŸ“ˆ **ä¸šåŠ¡æ´å¯Ÿ**ï¼šåˆ†æç”¨æˆ·è®¿é—®æ¨¡å¼

### 7.2 æ—¥å¿—ç³»ç»Ÿé…ç½®


**ç³»ç»Ÿæ—¥å¿—é…ç½®**ï¼š
```bash
# 1. é…ç½®rsyslogæ¥æ”¶HAProxyæ—¥å¿—
# /etc/rsyslog.conf
$ModLoad imudp
$UDPServerRun 514
$UDPServerAddress 127.0.0.1

# HAProxyæ—¥å¿—è§„åˆ™
local0.*    /var/log/haproxy/haproxy.log
& stop
```

**HAProxyæ—¥å¿—é…ç½®**ï¼š
```bash
# /etc/haproxy/haproxy.cfg

global
    # æ—¥å¿—é…ç½®
    log 127.0.0.1:514 local0 info
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    
frontend web_frontend
    bind *:80
    
    # å¯ç”¨æ—¥å¿—è®°å½•
    option httplog                      # å¯ç”¨HTTPæ ¼å¼æ—¥å¿—
    option dontlognull                  # ä¸è®°å½•ç©ºè¿æ¥
    option log-health-checks            # è®°å½•å¥åº·æ£€æŸ¥
    
    # è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
    capture request header Host len 32
    capture request header User-Agent len 64
    capture response header Content-Type len 32
    
    default_backend web_servers

backend web_servers
    # åç«¯æ—¥å¿—é…ç½®
    option httplog
    option log-health-checks
    
    server web1 192.168.1.10:8080 check
    server web2 192.168.1.11:8080 check
```

### 7.3 æ—¥å¿—æ ¼å¼è¯¦è§£


**HTTPæ—¥å¿—æ ¼å¼**ï¼š
```
æ—¥å¿—æ—¶é—´æˆ³ è¿›ç¨‹ID frontendåç§°/åç«¯åç§°/æœåŠ¡å™¨åç§° æ—¶é—´æ•°æ® çŠ¶æ€ç  å­—èŠ‚æ•° "è¯·æ±‚" "ç”¨æˆ·ä»£ç†" Cookie è¿æ¥ä¿¡æ¯
```

**å®é™…æ—¥å¿—ç¤ºä¾‹**ï¼š
```bash
Dec 03 14:23:45 localhost haproxy[1234]: 192.168.1.100:45678 [03/Dec/2024:14:23:45.123] web_frontend web_servers/web1 0/0/1/2/3 200 1234 - - ---- 12/11/10/9/0 0/0 "GET /api/users HTTP/1.1" "Mozilla/5.0" JSESSIONID=abc123
```

**å­—æ®µå«ä¹‰è§£æ**ï¼š
```bash
192.168.1.100:45678    # å®¢æˆ·ç«¯IPå’Œç«¯å£
[03/Dec/2024:14:23:45.123]  # è¯·æ±‚æ—¶é—´
web_frontend           # å‰ç«¯åç§°
web_servers/web1       # åç«¯/æœåŠ¡å™¨åç§°
0/0/1/2/3             # æ—¶é—´ç»Ÿè®¡ï¼ˆè¿æ¥/é˜Ÿåˆ—/å¤„ç†/å“åº”/æ€»è®¡ï¼Œæ¯«ç§’ï¼‰
200                   # HTTPçŠ¶æ€ç 
1234                  # å“åº”å­—èŠ‚æ•°
"GET /api/users HTTP/1.1"  # HTTPè¯·æ±‚
"Mozilla/5.0"         # User-Agent
JSESSIONID=abc123     # Cookieä¿¡æ¯
```

### 7.4 æ—¥å¿—åˆ†æå®è·µ


**å¸¸ç”¨æ—¥å¿—åˆ†æå‘½ä»¤**ï¼š
```bash
# åˆ†æè®¿é—®æœ€å¤šçš„IP
awk '{print $6}' /var/log/haproxy/haproxy.log | sort | uniq -c | sort -nr | head -10

# åˆ†æçŠ¶æ€ç åˆ†å¸ƒ
awk '{print $10}' /var/log/haproxy/haproxy.log | sort | uniq -c | sort -nr

# åˆ†æå“åº”æ—¶é—´ï¼ˆæ€»æ—¶é—´å­—æ®µï¼‰
awk '{print $9}' /var/log/haproxy/haproxy.log | awk -F'/' '{print $5}' | sort -n

# åˆ†ææœ€é¢‘ç¹çš„è¯·æ±‚è·¯å¾„
awk '{print $14}' /var/log/haproxy/haproxy.log | sort | uniq -c | sort -nr | head -20

# é”™è¯¯è¯·æ±‚åˆ†æï¼ˆ4xxã€5xxçŠ¶æ€ç ï¼‰
awk '$10 ~ /^[45]/ {print $0}' /var/log/haproxy/haproxy.log

# æ…¢è¯·æ±‚åˆ†æï¼ˆå“åº”æ—¶é—´>1000msï¼‰
awk -F'/' '$9 ~ /[0-9]+$/ && $5 > 1000 {print $0}' /var/log/haproxy/haproxy.log
```

**ä½¿ç”¨GoAccessåˆ†ææ—¥å¿—**ï¼š
```bash
# å®‰è£…GoAccess
apt-get install goaccess

# åˆ†æHAProxyæ—¥å¿—
goaccess /var/log/haproxy/haproxy.log --log-format='%h %^[%d:%t] %^ %b/%s %T %s %B %^ %^ %^ %^ %^ "%r" "%u"' --date-format='%d/%b/%Y' --time-format='%T' -o report.html

# å®æ—¶ç›‘æ§
goaccess /var/log/haproxy/haproxy.log --log-format='...' --real-time-html -o /var/www/html/live-stats.html
```

---

## 8. ğŸ›¡ï¸ æ•…éšœè½¬ç§»é…ç½®


### 8.1 æ•…éšœè½¬ç§»åŸºæœ¬æ¦‚å¿µ


**æ•…éšœè½¬ç§»ï¼ˆFailoverï¼‰**ï¼šå½“ä¸»æœåŠ¡å™¨å‡ºç°æ•…éšœæ—¶ï¼Œè‡ªåŠ¨å°†æµé‡åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡å™¨ï¼Œç¡®ä¿æœåŠ¡è¿ç»­æ€§ï¼Œå°±åƒå¤‡ç”¨è½®èƒåœ¨ä¸»è½®èƒçˆ†èƒæ—¶æ¥æ›¿å·¥ä½œã€‚

```
æ­£å¸¸æƒ…å†µï¼š
å®¢æˆ·ç«¯ â†’ ä¸»æœåŠ¡å™¨ï¼ˆå¤„ç†è¯·æ±‚ï¼‰
        å¤‡ç”¨æœåŠ¡å™¨ï¼ˆå¾…æœºï¼‰

æ•…éšœæƒ…å†µï¼š
å®¢æˆ·ç«¯ â†’ ä¸»æœåŠ¡å™¨ï¼ˆæ•…éšœÃ—ï¼‰
     â†˜  å¤‡ç”¨æœåŠ¡å™¨ï¼ˆæ¥ç®¡âˆšï¼‰
```

**æ•…éšœè½¬ç§»ç±»å‹**ï¼š
- ğŸ”„ **ä¸»å¤‡æ¨¡å¼**ï¼šä¸€ä¸»ä¸€å¤‡ï¼Œä¸»æ•…éšœæ—¶å¤‡ç”¨æ¥ç®¡
- âš–ï¸ **è´Ÿè½½åˆ†æ‹…**ï¼šå¤šæœåŠ¡å™¨åŒæ—¶å·¥ä½œï¼Œæ•…éšœæ—¶é‡æ–°åˆ†é…
- ğŸŒ **å¤šçº§å¤‡ä»½**ï¼šå¤šå±‚å¤‡ç”¨æ–¹æ¡ˆ

### 8.2 å¥åº·æ£€æŸ¥é…ç½®


**åŸºç¡€å¥åº·æ£€æŸ¥**ï¼š
```bash
backend web_servers
    balance roundrobin
    
    # TCPå¥åº·æ£€æŸ¥ï¼ˆæ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾ï¼‰
    server web1 192.168.1.10:8080 check
    server web2 192.168.1.11:8080 check backup    # å¤‡ç”¨æœåŠ¡å™¨
    
    # è‡ªå®šä¹‰æ£€æŸ¥é—´éš”å’Œè¶…æ—¶
    server web3 192.168.1.12:8080 check inter 2000ms fall 3 rise 2
    #                               â†‘        â†‘       â†‘    â†‘
    #                             æ£€æŸ¥é—´éš”  å¤±è´¥æ¬¡æ•°  æ¢å¤æ¬¡æ•°
```

**HTTPå¥åº·æ£€æŸ¥**ï¼š
```bash
backend api_servers
    balance roundrobin
    option httpchk GET /health HTTP/1.1\r\nHost:\ api.example.com
    
    # è¯¦ç»†çš„HTTPæ£€æŸ¥é…ç½®
    server api1 192.168.1.20:8080 check port 8080 inter 5s fall 3 rise 2
    server api2 192.168.1.21:8080 check port 8080 inter 5s fall 3 rise 2
    server api3 192.168.1.22:8080 check port 8080 backup  # å¤‡ç”¨æœåŠ¡å™¨
    
    # æœŸæœ›çš„å“åº”çŠ¶æ€ç 
    http-check expect status 200
    # æˆ–è€…æ£€æŸ¥å“åº”å†…å®¹
    # http-check expect string "OK"
```

**é«˜çº§å¥åº·æ£€æŸ¥**ï¼š
```bash
backend database_servers
    balance leastconn
    
    # å¤šæ­¥éª¤å¥åº·æ£€æŸ¥
    option httpchk
    http-check send meth GET uri /api/health ver HTTP/1.1 hdr Host api.example.com
    http-check expect status 200
    http-check expect string "database:ok"
    
    # ä¸åŒç±»å‹çš„æœåŠ¡å™¨é…ç½®
    server db1 192.168.1.30:3306 check port 8080 inter 10s fall 5 rise 3 weight 100
    server db2 192.168.1.31:3306 check port 8080 inter 10s fall 5 rise 3 weight 100
    server db3 192.168.1.32:3306 check port 8080 inter 10s fall 5 rise 3 backup
    
    # ç»´æŠ¤æ¨¡å¼æœåŠ¡å™¨
    server db4 192.168.1.33:3306 disabled
```

### 8.3 æ•…éšœè½¬ç§»ç­–ç•¥é…ç½®


**ä¸»å¤‡æ¨¡å¼é…ç½®**ï¼š
```bash
backend primary_backup
    # ä¼˜å…ˆä½¿ç”¨ä¸»æœåŠ¡å™¨ï¼Œæ•…éšœæ—¶åˆ‡æ¢åˆ°å¤‡ç”¨
    balance roundrobin
    
    # ä¸»æœåŠ¡å™¨ç»„
    server primary1 192.168.1.40:8080 check weight 100
    server primary2 192.168.1.41:8080 check weight 100
    
    # å¤‡ç”¨æœåŠ¡å™¨ï¼ˆåªæœ‰ä¸»æœåŠ¡å™¨å…¨éƒ¨æ•…éšœæ—¶æ‰ä½¿ç”¨ï¼‰
    server backup1 192.168.1.50:8080 check backup
    server backup2 192.168.1.51:8080 check backup
```

**åˆ†çº§æ•…éšœè½¬ç§»**ï¼š
```bash
# å¤šä¸ªåç«¯å®ç°åˆ†çº§æ•…éšœè½¬ç§»
frontend multi_tier_failover
    bind *:80
    
    # æ£€æŸ¥ä¸»åç«¯æ˜¯å¦å¯ç”¨
    default_backend primary_tier
    
    # ä½¿ç”¨ACLæ£€æŸ¥å„çº§åç«¯çŠ¶æ€
    use_backend secondary_tier if { nbsrv(primary_tier) eq 0 }
    use_backend emergency_tier if { nbsrv(primary_tier) eq 0 } { nbsrv(secondary_tier) eq 0 }

backend primary_tier
    # ä¸»è¦æœåŠ¡å™¨ç¾¤
    server app1 192.168.1.10:8080 check
    server app2 192.168.1.11:8080 check

backend secondary_tier  
    # äºŒçº§å¤‡ç”¨æœåŠ¡å™¨
    server backup1 192.168.1.20:8080 check
    server backup2 192.168.1.21:8080 check

backend emergency_tier
    # ç´§æ€¥å¤‡ç”¨ï¼ˆå¯èƒ½æ˜¯ç®€åŒ–ç‰ˆæœåŠ¡ï¼‰
    server emergency1 192.168.1.30:8080 check
```

### 8.4 è‡ªåŠ¨æ•…éšœæ¢å¤


```bash
backend auto_recovery
    balance roundrobin
    
    # æœåŠ¡å™¨è‡ªåŠ¨æ¢å¤é…ç½®
    server web1 192.168.1.10:8080 check inter 5s fall 3 rise 2
    #                               â†‘         â†‘      â†‘
    #                           æ£€æŸ¥é—´éš”   è¿ç»­3æ¬¡å¤±è´¥ç®—æ•…éšœ
    #                                     è¿ç»­2æ¬¡æˆåŠŸç®—æ¢å¤
    
    server web2 192.168.1.11:8080 check inter 5s fall 3 rise 2
    
    # æ…¢æ¢å¤ç­–ç•¥ï¼ˆé¿å…é›ªå´©ï¼‰
    server web3 192.168.1.12:8080 check inter 5s fall 3 rise 5 slowstart 30s
    #                                                    â†‘        â†‘
    #                                               éœ€è¦5æ¬¡æˆåŠŸ   30ç§’ç¼“æ…¢åŠ æƒ
```

**ç»´æŠ¤æ¨¡å¼ç®¡ç†**ï¼š
```bash
# é€šè¿‡ç»Ÿè®¡é¡µé¢æˆ–å‘½ä»¤è¡Œç®¡ç†æœåŠ¡å™¨çŠ¶æ€

# ä¸´æ—¶ç¦ç”¨æœåŠ¡å™¨ï¼ˆç»´æŠ¤ï¼‰
echo "disable server web_servers/web1" | socat stdio /var/lib/haproxy/stats

# é‡æ–°å¯ç”¨æœåŠ¡å™¨
echo "enable server web_servers/web1" | socat stdio /var/lib/haproxy/stats

# è®¾ç½®æœåŠ¡å™¨æƒé‡ï¼ˆé€æ­¥æ¢å¤æµé‡ï¼‰
echo "set weight web_servers/web1 50%" | socat stdio /var/lib/haproxy/stats
```

---

## 9. âš¡ æ€§èƒ½è°ƒä¼˜å‚æ•°


### 9.1 æ€§èƒ½è°ƒä¼˜æ¦‚è¿°


**æ€§èƒ½è°ƒä¼˜ç›®æ ‡**ï¼š
- ğŸš€ **æé«˜ååé‡**ï¼šæ¯ç§’å¤„ç†æ›´å¤šè¯·æ±‚
- â±ï¸ **é™ä½å»¶è¿Ÿ**ï¼šå‡å°‘å“åº”æ—¶é—´
- ğŸ’¾ **ä¼˜åŒ–èµ„æºä½¿ç”¨**ï¼šCPUã€å†…å­˜ã€ç½‘ç»œæ•ˆç‡
- ğŸ”„ **æé«˜å¹¶å‘èƒ½åŠ›**ï¼šæ”¯æŒæ›´å¤šåŒæ—¶è¿æ¥

### 9.2 å…¨å±€æ€§èƒ½å‚æ•°


```bash
global
    # å·¥ä½œè¿›ç¨‹æ•°ï¼ˆé€šå¸¸ç­‰äºCPUæ ¸å¿ƒæ•°ï¼‰
    nbproc 4
    # æˆ–ä½¿ç”¨çº¿ç¨‹æ¨¡å¼ï¼ˆæ›´ç°ä»£çš„æ–¹æ³•ï¼‰
    nbthread 4
    
    # æœ€å¤§è¿æ¥æ•°
    maxconn 4096
    
    # è¿æ¥é˜Ÿåˆ—å¤§å°
    tune.maxaccept 100
    
    # SSLæ€§èƒ½ä¼˜åŒ–
    tune.ssl.default-dh-param 2048
    tune.ssl.maxrecord 1400
    tune.ssl.cachesize 100000
    
    # å†…å­˜ç¼“å†²åŒºè°ƒä¼˜
    tune.bufsize 32768              # ç¼“å†²åŒºå¤§å°ï¼ˆé»˜è®¤16KBï¼‰
    tune.maxrewrite 2048            # é‡å†™ç¼“å†²åŒºå¤§å°
    
    # TCPè°ƒä¼˜
    tune.tcp.frontend.timeout 5s
    tune.tcp.backend.timeout 5s
    
    # ç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–
    stats maxconn 20
    stats timeout 10s
```

### 9.3 å‰ç«¯æ€§èƒ½ä¼˜åŒ–


```bash
frontend high_performance
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/cert.pem
    
    # è¿æ¥é™åˆ¶
    maxconn 2000                    # å‰ç«¯æœ€å¤§è¿æ¥æ•°
    rate-limit sessions 1000        # æ¯ç§’æœ€å¤§æ–°å»ºè¿æ¥æ•°
    
    # è¶…æ—¶è®¾ç½®
    timeout client 30s              # å®¢æˆ·ç«¯è¶…æ—¶
    timeout http-request 10s        # HTTPè¯·æ±‚è¶…æ—¶
    timeout http-keep-alive 5s      # Keep-Aliveè¶…æ—¶
    
    # HTTPä¼˜åŒ–
    option httpclose                # å…³é—­HTTPæŒä¹…è¿æ¥ï¼ˆé«˜å¹¶å‘æ—¶ï¼‰
    # æˆ–è€…
    option http-keep-alive          # å¯ç”¨HTTPæŒä¹…è¿æ¥ï¼ˆå‡å°‘è¿æ¥å¼€é”€ï¼‰
    
    option dontlognull              # ä¸è®°å½•ç©ºè¿æ¥æ—¥å¿—
    option redispatch               # å¯ç”¨é‡æ–°åˆ†å‘
    
    # å‹ç¼©ä¼˜åŒ–
    compression algo gzip
    compression type text/html text/plain text/css text/javascript application/javascript application/json
    
    default_backend optimized_servers
```

### 9.4 åç«¯æ€§èƒ½ä¼˜åŒ–


```bash
backend optimized_servers
    balance leastconn               # æœ€å°‘è¿æ¥ç®—æ³•
    
    # è¿æ¥æ± ä¼˜åŒ–
    maxconn 500                     # åç«¯æœ€å¤§è¿æ¥æ•°
    
    # è¶…æ—¶ä¼˜åŒ–
    timeout connect 5s              # è¿æ¥è¶…æ—¶
    timeout server 30s              # æœåŠ¡å™¨å“åº”è¶…æ—¶
    timeout queue 10s               # é˜Ÿåˆ—è¶…æ—¶
    
    # å¥åº·æ£€æŸ¥ä¼˜åŒ–
    option httpchk GET /health
    timeout check 3s                # å¥åº·æ£€æŸ¥è¶…æ—¶
    
    # è¿æ¥å¤ç”¨
    option httpclose                # æˆ–æ ¹æ®éœ€è¦é€‰æ‹©keep-alive
    
    # æœåŠ¡å™¨é…ç½®ä¼˜åŒ–
    server web1 192.168.1.10:8080 check maxconn 100 weight 100
    server web2 192.168.1.11:8080 check maxconn 100 weight 100
    server web3 192.168.1.12:8080 check maxconn 100 weight 100
    
    # æ•…éšœå¿«é€Ÿæ£€æµ‹
    server web4 192.168.1.13:8080 check inter 2s fall 2 rise 3
```

### 9.5 ç³»ç»Ÿçº§ä¼˜åŒ–


**æ“ä½œç³»ç»Ÿè°ƒä¼˜**ï¼š
```bash
# /etc/security/limits.conf
haproxy soft nofile 65536
haproxy hard nofile 65536

# /etc/sysctl.conf
# ç½‘ç»œè¿æ¥ä¼˜åŒ–
net.core.somaxconn = 65536
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_max_syn_backlog = 65536
net.ipv4.tcp_syncookies = 1

# TCPå‚æ•°è°ƒä¼˜
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 120
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15

# å†…å­˜ä¼˜åŒ–
vm.swappiness = 10
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
```

### 9.6 ç›‘æ§å’Œè°ƒä¼˜æŒ‡æ ‡


**å…³é”®æ€§èƒ½æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | ä¼˜åŒ–ç›®æ ‡ |
|------|------|----------|
| **Connections/sec** | æ¯ç§’æ–°å»ºè¿æ¥æ•° | æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´ |
| **Request Rate** | æ¯ç§’è¯·æ±‚æ•° | æœ€å¤§åŒ–å¤„ç†èƒ½åŠ› |
| **Response Time** | å¹³å‡å“åº”æ—¶é—´ | < 100ms (web), < 10ms (api) |
| **Queue Length** | æ’é˜Ÿè¯·æ±‚æ•° | æ¥è¿‘0 |
| **Error Rate** | é”™è¯¯ç‡ | < 0.1% |
| **CPU Usage** | CPUä½¿ç”¨ç‡ | < 80% |
| **Memory Usage** | å†…å­˜ä½¿ç”¨ç‡ | < 90% |

**æ€§èƒ½æµ‹è¯•å‘½ä»¤**ï¼š
```bash
# ä½¿ç”¨Apache Benchæµ‹è¯•
ab -n 10000 -c 100 http://localhost/

# ä½¿ç”¨wrkæµ‹è¯•
wrk -t12 -c400 -d30s http://localhost/

# ä½¿ç”¨curlæµ‹è¯•å“åº”æ—¶é—´
curl -w "@curl-format.txt" -o /dev/null -s http://localhost/

# curl-format.txtå†…å®¹ï¼š
#     time_namelookup:  %{time_namelookup}\n
#        time_connect:  %{time_connect}\n
#     time_appconnect:  %{time_appconnect}\n
#    time_pretransfer:  %{time_pretransfer}\n
#       time_redirect:  %{time_redirect}\n
#  time_starttransfer:  %{time_starttransfer}\n
#                     ----------\n
#          time_total:  %{time_total}\n
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ACLè®¿é—®æ§åˆ¶ï¼šåŸºäºæ¡ä»¶çš„æ™ºèƒ½è·¯ç”±å’Œè®¿é—®æ§åˆ¶
ğŸ”¸ åŸºäºå†…å®¹çš„è´Ÿè½½å‡è¡¡ï¼šæ ¹æ®è¯·æ±‚ç‰¹å¾åˆ†é…åˆ°æœ€é€‚åˆçš„æœåŠ¡å™¨
ğŸ”¸ SSLç»ˆç«¯ï¼šé›†ä¸­å¤„ç†SSLåŠ å¯†ï¼Œç®€åŒ–åç«¯é…ç½®
ğŸ”¸ ç»Ÿè®¡ç›‘æ§ï¼šå®æ—¶äº†è§£ç³»ç»ŸçŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡
ğŸ”¸ æ•…éšœè½¬ç§»ï¼šè‡ªåŠ¨æ£€æµ‹æ•…éšœå¹¶åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡å™¨
ğŸ”¸ æ€§èƒ½è°ƒä¼˜ï¼šé€šè¿‡å‚æ•°ä¼˜åŒ–æå‡ç³»ç»Ÿæ€§èƒ½
```

### 10.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ ACLè®¾è®¡åŸåˆ™**ï¼š
```
ç®€å•æ˜ç¡®ï¼šACLæ¡ä»¶è¦æ¸…æ™°æ˜“æ‡‚
æ€§èƒ½ä¼˜å…ˆï¼šå¸¸ç”¨æ¡ä»¶æ”¾åœ¨å‰é¢ï¼Œæé«˜åŒ¹é…æ•ˆç‡
é€»è¾‘åˆç†ï¼šä½¿ç”¨ANDã€ORã€NOTç»„åˆè¦ç¬¦åˆä¸šåŠ¡é€»è¾‘
ç»´æŠ¤æ–¹ä¾¿ï¼šç›¸å…³ACLè§„åˆ™æ”¾åœ¨ä¸€èµ·ï¼Œä¾¿äºç®¡ç†
```

**ğŸ”¹ SSLé…ç½®è¦ç‚¹**ï¼š
```
è¯ä¹¦ç®¡ç†ï¼šä½¿ç”¨è¯ä¹¦åˆ—è¡¨æ–‡ä»¶ç®¡ç†å¤šåŸŸå
å®‰å…¨é…ç½®ï¼šç¦ç”¨å¼±åŠ å¯†ç®—æ³•ï¼Œå¯ç”¨ç°ä»£TLSç‰ˆæœ¬
æ€§èƒ½ä¼˜åŒ–ï¼šåˆç†è®¾ç½®SSLå‚æ•°ï¼Œé¿å…è¿‡åº¦åŠ å¯†
ç›‘æ§å‘Šè­¦ï¼šç›‘æ§è¯ä¹¦è¿‡æœŸæ—¶é—´ï¼ŒåŠæ—¶ç»­æœŸ
```

**ğŸ”¹ å¥åº·æ£€æŸ¥ç­–ç•¥**ï¼š
```
æ£€æŸ¥é¢‘ç‡ï¼šå¹³è¡¡å‡†ç¡®æ€§å’Œå¼€é”€ï¼ˆä¸€èˆ¬2-10ç§’ï¼‰
æ•…éšœé˜ˆå€¼ï¼šè¿ç»­å¤±è´¥æ¬¡æ•°ï¼ˆä¸€èˆ¬2-5æ¬¡ï¼‰
æ¢å¤ç­–ç•¥ï¼šé€æ­¥æ¢å¤æƒé‡ï¼Œé¿å…ç¬é—´å†²å‡»
å¤šæ ·åŒ–æ£€æŸ¥ï¼šHTTPæ£€æŸ¥æ¯”TCPæ£€æŸ¥æ›´å‡†ç¡®
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**é…ç½®æ–‡ä»¶ç»„ç»‡**ï¼š
```bash
# å»ºè®®çš„é…ç½®æ–‡ä»¶ç»“æ„
/etc/haproxy/
â”œâ”€â”€ haproxy.cfg              # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ conf.d/
â”‚   â”œâ”€â”€ 01-global.cfg        # å…¨å±€é…ç½®
â”‚   â”œâ”€â”€ 02-defaults.cfg      # é»˜è®¤é…ç½®
â”‚   â”œâ”€â”€ 10-frontend.cfg      # å‰ç«¯é…ç½®
â”‚   â”œâ”€â”€ 20-backend.cfg       # åç«¯é…ç½®
â”‚   â””â”€â”€ 30-stats.cfg         # ç»Ÿè®¡é…ç½®
â”œâ”€â”€ ssl/
â”‚   â”œâ”€â”€ certs.list           # è¯ä¹¦åˆ—è¡¨
â”‚   â””â”€â”€ certs/              # è¯ä¹¦æ–‡ä»¶ç›®å½•
â””â”€â”€ logs/                   # æ—¥å¿—ç›®å½•
```

**è¿ç»´æœ€ä½³å®è·µ**ï¼š
- ğŸ“Š **ç›‘æ§ä¼˜å…ˆ**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»
- ğŸ”„ **æ¸è¿›å˜æ›´**ï¼šé…ç½®å˜æ›´è¦é€æ­¥è¿›è¡Œï¼Œé¿å…ä¸€æ¬¡æ€§å¤§æ”¹
- ğŸ“ **æ–‡æ¡£è®°å½•**ï¼šé‡è¦é…ç½®è¦æœ‰æ³¨é‡Šå’Œå˜æ›´è®°å½•
- ğŸ§ª **æµ‹è¯•éªŒè¯**ï¼šæ–°é…ç½®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- ğŸ”™ **å›æ»šå‡†å¤‡**ï¼šä¿ç•™é…ç½®å¤‡ä»½ï¼Œç¡®ä¿å¯ä»¥å¿«é€Ÿå›æ»š

### 10.4 æ•…éšœæ’æŸ¥æ€è·¯


```
é—®é¢˜è¯Šæ–­æµç¨‹ï¼š
1. æŸ¥çœ‹ç»Ÿè®¡é¡µé¢ â†’ ç¡®è®¤æœåŠ¡å™¨çŠ¶æ€
2. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ â†’ æŸ¥æ‰¾é”™è¯¯ä¿¡æ¯  
3. éªŒè¯ç½‘ç»œè¿é€šæ€§ â†’ pingã€telnetæµ‹è¯•
4. æ£€æŸ¥åç«¯æœåŠ¡ â†’ ç›´æ¥è®¿é—®åç«¯æœåŠ¡å™¨
5. åˆ†æé…ç½®æ–‡ä»¶ â†’ ç¡®è®¤é…ç½®æ­£ç¡®æ€§
6. ç³»ç»Ÿèµ„æºæ£€æŸ¥ â†’ CPUã€å†…å­˜ã€ç½‘ç»œä½¿ç”¨æƒ…å†µ
```

**å¸¸è§é—®é¢˜åŠè§£å†³**ï¼š
- **503é”™è¯¯**ï¼šæ£€æŸ¥åç«¯æœåŠ¡å™¨çŠ¶æ€å’Œå¥åº·æ£€æŸ¥é…ç½®
- **è¿æ¥è¶…æ—¶**ï¼šè°ƒæ•´timeoutå‚æ•°å’Œmaxconné™åˆ¶
- **SSLé—®é¢˜**ï¼šéªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§å’ŒSSLé…ç½®
- **æ€§èƒ½é—®é¢˜**ï¼šåˆ†æç»Ÿè®¡æ•°æ®ï¼Œè°ƒæ•´ç®—æ³•å’Œå‚æ•°

**æ ¸å¿ƒè®°å¿†**ï¼š
- HAProxyé«˜çº§åŠŸèƒ½è®©è´Ÿè½½å‡è¡¡æ›´æ™ºèƒ½æ›´å®‰å…¨
- ACLæ˜¯æµé‡æ§åˆ¶çš„æ ¸å¿ƒï¼Œè¦ç†Ÿç»ƒæŒæ¡å„ç§æ¡ä»¶
- SSLç»ˆç«¯ç®€åŒ–æ¶æ„ï¼Œç»Ÿè®¡é¡µé¢æä¾›ç›‘æ§èƒ½åŠ›
- æ•…éšœè½¬ç§»ä¿è¯å¯ç”¨æ€§ï¼Œæ€§èƒ½è°ƒä¼˜æå‡æ•ˆç‡
- é…ç½®è¦æ¨¡å—åŒ–ï¼Œè¿ç»´è¦æ ‡å‡†åŒ–ï¼Œé—®é¢˜è¦ç³»ç»ŸåŒ–æ’æŸ¥