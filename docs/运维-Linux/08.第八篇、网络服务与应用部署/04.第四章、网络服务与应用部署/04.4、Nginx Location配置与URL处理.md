---
title: 4、Nginx Location配置与URL处理
---
## 📚 目录

1. [Location基本概念](#1-Location基本概念)
2. [Location匹配规则详解](#2-Location匹配规则详解)
3. [目录指定：root与alias](#3-目录指定：root与alias)
4. [默认文件与查找机制](#4-默认文件与查找机制)
5. [URL重写与跳转](#5-URL重写与跳转)
6. [静态文件服务配置](#6-静态文件服务配置)
7. [访问控制与安全](#7-访问控制与安全)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🎯 Location基本概念


### 1.1 什么是Location


**Location的本质**：Location是Nginx中最核心的配置指令，它决定了如何处理客户端的请求URL。

```
简单理解：
客户端请求 → Nginx接收 → Location匹配 → 决定如何处理

就像快递分拣：
收到包裹 → 看地址 → 按规则分类 → 送到对应部门处理
```

**Location的作用**：
- **URL分发**：根据不同的URL路径，分配给不同的处理方式
- **资源定位**：告诉Nginx去哪里找文件
- **请求处理**：决定是返回静态文件、转发给后端，还是做其他处理

### 1.2 Location在配置中的位置


```nginx
# Nginx配置文件结构
server {
    listen 80;
    server_name example.com;
    
    # 这里就是location配置的地方
    location / {
        # 处理所有请求
    }
    
    location /images/ {
        # 专门处理图片请求
    }
    
    location /api/ {
        # 专门处理API请求
    }
}
```

### 1.3 Location的基本语法


```nginx
location [修饰符] 匹配模式 {
    # 配置指令
}

# 实际例子
location / {                    # 匹配所有请求
    root /var/www/html;
}

location = /login {             # 精确匹配 /login
    proxy_pass http://backend;
}

location ~ \.(jpg|png)$ {       # 正则匹配图片文件
    expires 30d;
}
```

---

## 2. 🔍 Location匹配规则详解


### 2.1 匹配修饰符类型


**四种主要修饰符**：

```
= → 精确匹配（最高优先级）
^~ → 前缀匹配，匹配后停止正则检查
~ → 区分大小写的正则匹配
~* → 不区分大小写的正则匹配
无修饰符 → 普通前缀匹配（最低优先级）
```

### 2.2 精确匹配（=）


**使用场景**：当你需要对特定的URL做专门处理时

```nginx
# 只匹配 http://example.com/login
location = /login {
    proxy_pass http://auth-server;
}

# 只匹配 http://example.com/
location = / {
    return 301 /home;
}
```

**特点说明**：
- ✅ **匹配**：`/login` 
- ❌ **不匹配**：`/login/`、`/login?user=admin`、`/loginpage`

> 💡 **理解要点**：精确匹配就像门牌号，必须完全一致才能匹配

### 2.3 前缀匹配（^~）


**使用场景**：匹配某个路径开头的所有请求，并且不想被正则表达式干扰

```nginx
# 匹配所有以 /static/ 开头的请求
location ^~ /static/ {
    root /var/www;
    expires 1y;
}

# 匹配所有以 /admin/ 开头的请求
location ^~ /admin/ {
    auth_basic "Admin Area";
    auth_basic_user_file /etc/nginx/.htpasswd;
}
```

**匹配示例**：
```
请求 /static/css/style.css → ✅ 匹配
请求 /static/js/app.js → ✅ 匹配  
请求 /static → ❌ 不匹配（缺少尾部斜杠）
请求 /css/static.css → ❌ 不匹配
```

### 2.4 正则匹配（~ 和 ~*）


**区分大小写匹配（~）**：
```nginx
# 匹配所有.php文件
location ~ \.php$ {
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}

# 匹配图片文件
location ~ \.(jpg|jpeg|png|gif)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

**不区分大小写匹配（~*）**：
```nginx
# 匹配各种格式的图片文件（忽略大小写）
location ~* \.(jpg|jpeg|png|gif|webp|JPG|PNG)$ {
    root /var/www/images;
}

# 匹配移动设备访问
location ~* (mobile|android|iphone) {
    proxy_pass http://mobile-backend;
}
```

### 2.5 匹配优先级规则


**优先级从高到低**：

```
1️⃣ 精确匹配 (=)           ← 最高优先级
2️⃣ 前缀匹配 (^~)          ← 匹配后停止检查
3️⃣ 正则匹配 (~ 和 ~*)      ← 按配置顺序检查
4️⃣ 普通前缀匹配            ← 最长匹配原则
```

**实际匹配流程**：
```
步骤1：检查所有精确匹配 (=)
      ↓ 如果匹配，直接使用
步骤2：检查前缀匹配 (^~)  
      ↓ 如果匹配，直接使用，不再检查正则
步骤3：按顺序检查正则匹配 (~ 和 ~*)
      ↓ 找到第一个匹配的就使用
步骤4：使用最长的普通前缀匹配
```

### 2.6 匹配规则实例演示


```nginx
server {
    listen 80;
    server_name example.com;
    
    # 1. 精确匹配首页
    location = / {
        return 200 "首页精确匹配";
    }
    
    # 2. 前缀匹配静态资源
    location ^~ /static/ {
        root /var/www;
    }
    
    # 3. 正则匹配API接口
    location ~ ^/api/v[0-9]+/ {
        proxy_pass http://api-backend;
    }
    
    # 4. 普通前缀匹配（兜底）
    location / {
        proxy_pass http://web-backend;
    }
}
```

**测试各种URL的匹配结果**：
```
http://example.com/           → 匹配规则1（精确匹配）
http://example.com/static/a.js → 匹配规则2（前缀匹配）  
http://example.com/api/v1/users → 匹配规则3（正则匹配）
http://example.com/about      → 匹配规则4（普通前缀）
```

---

## 3. 📁 目录指定：root与alias


### 3.1 root指令详解


**root的工作原理**：将root路径与location路径**拼接**起来形成最终文件路径

```nginx
location /images/ {
    root /var/www;
}

# 请求处理过程：
# 请求：/images/logo.png
# 最终文件路径：/var/www + /images/logo.png = /var/www/images/logo.png
```

**root配置示例**：
```nginx
server {
    listen 80;
    root /var/www/html;  # 全局root设置
    
    location / {
        # 继承全局root：/var/www/html
        # 请求 /index.html → 文件 /var/www/html/index.html
    }
    
    location /downloads/ {
        root /data;      # 局部root设置
        # 请求 /downloads/file.zip → 文件 /data/downloads/file.zip
    }
}
```

### 3.2 alias指令详解


**alias的工作原理**：用alias路径**替换**location路径

```nginx
location /images/ {
    alias /var/www/static/;
}

# 请求处理过程：
# 请求：/images/logo.png
# 最终文件路径：/var/www/static/ + logo.png = /var/www/static/logo.png
```

**alias配置示例**：
```nginx
location /assets/ {
    alias /var/www/public/;
    # 请求 /assets/css/style.css → 文件 /var/www/public/css/style.css
}

location /docs/ {
    alias /usr/share/documentation/;
    # 请求 /docs/manual.pdf → 文件 /usr/share/documentation/manual.pdf
}
```

### 3.3 root vs alias 关键差异


| 特性 | **root** | **alias** |
|------|----------|-----------|
| **路径处理** | `拼接：root + location` | `替换：alias替换location` |
| **尾部斜杠** | `无特殊要求` | `必须与location保持一致` |
| **使用场景** | `目录结构与URL一致` | `目录结构与URL不一致` |
| **性能** | `稍快` | `稍慢` |

**对比示例**：
```nginx
# root方式
location /static/ {
    root /var/www;
    # /static/js/app.js → /var/www/static/js/app.js
}

# alias方式  
location /static/ {
    alias /var/www/assets/;
    # /static/js/app.js → /var/www/assets/js/app.js
}
```

### 3.4 常见配置错误


**错误1：alias路径斜杠不匹配**
```nginx
# ❌ 错误配置
location /images/ {
    alias /var/www/static;  # 缺少尾部斜杠
}

# ✅ 正确配置
location /images/ {
    alias /var/www/static/; # 保持一致的斜杠
}
```

**错误2：混淆root和alias的使用场景**
```nginx
# ❌ 想要的效果：/api/docs/ → /usr/share/api-docs/
location /api/docs/ {
    root /usr/share/api-docs/;  # 错误！会变成 /usr/share/api-docs/api/docs/
}

# ✅ 正确配置
location /api/docs/ {
    alias /usr/share/api-docs/; # 正确！直接替换
}
```

---

## 4. 📋 默认文件与查找机制


### 4.1 index指令详解


**index的作用**：当请求是目录时，自动查找默认文件

```nginx
location / {
    root /var/www/html;
    index index.html index.htm index.php;
}

# 请求处理过程：
# 请求：http://example.com/
# 查找顺序：
# 1. /var/www/html/index.html
# 2. /var/www/html/index.htm  
# 3. /var/www/html/index.php
# 找到第一个存在的文件就返回
```

**多格式支持示例**：
```nginx
server {
    listen 80;
    root /var/www;
    
    # 支持多种默认文件格式
    index index.html index.htm default.html;
    
    location /admin/ {
        index admin.html dashboard.html; # 局部index设置
    }
}
```

### 4.2 try_files指令详解


**try_files的强大之处**：按顺序尝试多个文件或处理方式，实现灵活的回退机制

```nginx
# 基本语法
try_files file1 file2 ... fallback;

# 实际示例
location / {
    try_files $uri $uri/ /index.html;
}
```

**工作流程说明**：
```
try_files $uri $uri/ /index.html;

步骤解析：
1. 尝试请求的URI对应的文件 ($uri)
2. 如果不存在，尝试URI对应的目录 ($uri/)  
3. 如果还不存在，返回 /index.html

实际例子：
请求 /about
1. 检查 /var/www/html/about 文件是否存在
2. 检查 /var/www/html/about/ 目录是否存在  
3. 都不存在则返回 /var/www/html/index.html
```

### 4.3 try_files实际应用场景


**场景1：单页应用（SPA）支持**
```nginx
# Vue.js/React等SPA应用
location / {
    root /var/www/spa;
    try_files $uri $uri/ /index.html;
    
    # 解决SPA路由问题：
    # /user/profile → 找不到文件 → 返回index.html → 前端路由处理
}
```

**场景2：静态文件优先，API兜底**
```nginx
location / {
    try_files $uri $uri/ @backend;
}

# 命名location作为兜底
location @backend {
    proxy_pass http://app-server;
}
```

**场景3：多语言站点支持**
```nginx
location / {
    try_files $uri $uri/ /zh$uri /en$uri /index.html;
    
    # 请求 /about
    # 1. 查找 /about
    # 2. 查找 /about/  
    # 3. 查找 /zh/about
    # 4. 查找 /en/about
    # 5. 返回 /index.html
}
```

### 4.4 autoindex目录浏览


**autoindex功能**：当目录中没有默认文件时，显示目录列表

```nginx
location /downloads/ {
    root /var/www;
    autoindex on;                # 开启目录浏览
    autoindex_exact_size off;    # 显示文件大小用K/M/G单位
    autoindex_localtime on;      # 显示本地时间而不是GMT
    autoindex_format html;       # 输出格式：html/xml/json/jsonp
}
```

**实际效果**：
```
访问 http://example.com/downloads/
显示类似这样的页面：

Index of /downloads/
------------------
📁 software/           2024-09-15 10:30    -
📄 manual.pdf         2024-09-14 15:20    2.3M
📄 installer.exe      2024-09-13 09:45    125M
```

---

## 5. 🔄 URL重写与跳转


### 5.1 return指令：简单跳转


**return的用途**：快速返回状态码或重定向，性能最优

```nginx
# 基本语法
return code [text/URL];

# 实际示例
location = /old-page {
    return 301 /new-page;  # 永久重定向
}

location /maintenance {
    return 503 "网站维护中，请稍后访问";
}

# HTTPS强制跳转
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}
```

**常用状态码**：
```
200 → 成功返回内容
301 → 永久重定向（搜索引擎会更新索引）
302 → 临时重定向（搜索引擎保持原索引）
403 → 禁止访问
404 → 页面不存在
503 → 服务不可用
```

### 5.2 rewrite指令：复杂重写


**rewrite的强大功能**：使用正则表达式进行复杂的URL重写

```nginx
# 基本语法
rewrite 正则表达式 替换内容 [flag];

# 实际示例
location / {
    # 将 /product/123 重写为 /item.php?id=123
    rewrite ^/product/([0-9]+)$ /item.php?id=$1 last;
    
    # 将 /user/john 重写为 /profile.php?name=john  
    rewrite ^/user/(.+)$ /profile.php?name=$1 last;
}
```

**rewrite标志位说明**：
```
last → 停止处理当前rewrite，重新匹配location
break → 停止处理rewrite，继续执行当前location
redirect → 返回302临时重定向
permanent → 返回301永久重定向
```

### 5.3 rewrite实际应用场景


**场景1：SEO友好的URL**
```nginx
# 将动态URL转换为静态URL风格
location / {
    # /category/tech/page/2 → /list.php?cat=tech&page=2
    rewrite ^/category/([^/]+)/page/([0-9]+)$ /list.php?cat=$1&page=$2 last;
    
    # /article/how-to-learn-nginx → /article.php?slug=how-to-learn-nginx
    rewrite ^/article/([^/]+)$ /article.php?slug=$1 last;
}
```

**场景2：移动端适配**
```nginx
# 移动设备重定向到移动站点
location / {
    if ($http_user_agent ~* "(mobile|android|iphone)") {
        rewrite ^(.*)$ http://m.example.com$1 redirect;
    }
}
```

**场景3：去除www前缀**
```nginx
# 统一域名，去除www
server {
    listen 80;
    server_name www.example.com;
    rewrite ^(.*)$ http://example.com$1 permanent;
}
```

### 5.4 常用内置变量


**URL相关变量**：
```nginx
$uri            # 当前请求的URI（不含参数）
$request_uri    # 完整的原始请求URI（含参数）
$args           # URL参数字符串
$arg_name       # 获取特定参数值

# 示例使用
location /debug {
    return 200 "URI: $uri, 完整请求: $request_uri, 参数: $args";
}
```

**请求信息变量**：
```nginx
$host               # 请求的主机名
$server_name        # 服务器名称
$remote_addr        # 客户端IP地址
$http_user_agent    # 用户代理字符串
$request_method     # 请求方法(GET/POST等)
```

---

## 6. 📦 静态文件服务配置


### 6.1 基本静态文件服务


**最简单的静态文件配置**：
```nginx
server {
    listen 80;
    server_name static.example.com;
    root /var/www/static;
    
    location / {
        # 基本静态文件服务，无需额外配置
    }
}
```

### 6.2 按文件类型优化配置


**图片文件优化**：
```nginx
# 图片文件专门处理
location ~* \.(jpg|jpeg|png|gif|webp|svg)$ {
    root /var/www/images;
    expires 30d;                    # 缓存30天
    add_header Cache-Control "public, immutable";
    
    # 压缩传输
    gzip on;
    gzip_vary on;
    gzip_types image/svg+xml;
}
```

**CSS/JS文件优化**：
```nginx
# 样式和脚本文件
location ~* \.(css|js)$ {
    root /var/www/assets;
    expires 1y;                     # 缓存1年
    add_header Cache-Control "public, immutable";
    
    # 启用压缩
    gzip on;
    gzip_types text/css application/javascript;
}
```

**字体文件处理**：
```nginx
# 字体文件需要CORS支持
location ~* \.(woff|woff2|ttf|eot)$ {
    root /var/www/fonts;
    expires 1y;
    add_header Access-Control-Allow-Origin "*";
    add_header Cache-Control "public, immutable";
}
```

### 6.3 文件下载服务


**基本下载配置**：
```nginx
location /downloads/ {
    root /var/www;
    
    # 强制下载而不是在浏览器中打开
    add_header Content-Disposition "attachment";
    
    # 限制下载速度（防止带宽占用过大）
    limit_rate 1m;      # 限制为1MB/s
}
```

**大文件下载优化**：
```nginx
location /files/ {
    root /data;
    
    # 支持断点续传
    add_header Accept-Ranges bytes;
    
    # 大文件分片传输
    chunked_transfer_encoding on;
    
    # 防止超时
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
}
```

### 6.4 防盗链配置


**图片防盗链**：
```nginx
location ~* \.(jpg|jpeg|png|gif)$ {
    # 检查来源域名
    valid_referers none blocked server_names *.example.com example.com;
    
    if ($invalid_referer) {
        return 403;                 # 禁止访问
        # 或者返回替代图片
        # rewrite ^.*$ /images/hotlink-denied.png last;
    }
    
    root /var/www/images;
}
```

**资源访问限制**：
```nginx
location /private/ {
    # 只允许特定IP访问
    allow 192.168.1.0/24;
    allow 10.0.0.0/8;
    deny all;
    
    root /var/www;
}
```

---

## 7. 🔒 访问控制与安全


### 7.1 IP访问控制


**基于IP的访问控制**：
```nginx
location /admin/ {
    # 允许特定IP段
    allow 192.168.1.0/24;      # 内网段
    allow 203.0.113.0/24;      # 办公网段
    allow 127.0.0.1;           # 本机
    
    # 拒绝其他所有IP
    deny all;
    
    root /var/www/admin;
}

# 全局IP黑名单
location / {
    # 拒绝恶意IP
    deny 192.0.2.1;
    deny 198.51.100.0/24;
    
    # 允许其他访问
    allow all;
}
```

### 7.2 HTTP基本认证


**用户名密码认证**：
```nginx
location /secure/ {
    auth_basic "受保护区域";
    auth_basic_user_file /etc/nginx/.htpasswd;
    
    root /var/www/secure;
}

# 生成密码文件命令：
# htpasswd -c /etc/nginx/.htpasswd username
```

**分级权限控制**：
```nginx
# 管理员区域
location /admin/ {
    auth_basic "管理员登录";
    auth_basic_user_file /etc/nginx/admin.passwd;
}

# 用户区域  
location /user/ {
    auth_basic "用户登录";
    auth_basic_user_file /etc/nginx/user.passwd;
}
```

### 7.3 请求限制


**连接数限制**：
```nginx
# 限制单IP并发连接数
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;

server {
    location /download/ {
        limit_conn conn_limit_per_ip 2;  # 每IP最多2个并发下载
    }
}
```

**请求频率限制**：
```nginx
# 限制请求频率
limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=10r/s;

server {
    location /api/ {
        limit_req zone=req_limit_per_ip burst=20 nodelay;
        # 允许突发20个请求，超出部分直接拒绝
    }
}
```

### 7.4 文件类型限制


**危险文件类型禁止**：
```nginx
# 禁止访问可执行文件
location ~* \.(php|php3|php4|php5|phtml|pl|py|jsp|asp|sh|cgi)$ {
    deny all;
}

# 禁止访问隐藏文件
location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
}

# 禁止访问备份文件
location ~* \.(bak|backup|old|tmp)$ {
    deny all;
}
```

**文件上传大小限制**：
```nginx
location /upload/ {
    client_max_body_size 10m;      # 限制上传文件10MB
    
    # 限制请求体大小
    client_body_buffer_size 128k;
}
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 Location本质：URL请求的分发和处理规则
🔸 匹配优先级：= > ^~ > ~ > ~* > 普通前缀
🔸 目录指定：root是拼接，alias是替换  
🔸 文件查找：index设置默认文件，try_files实现回退
🔸 URL处理：return快速跳转，rewrite复杂重写
🔸 静态服务：缓存优化、压缩传输、防盗链保护
🔸 访问控制：IP限制、认证保护、频率控制
```

### 8.2 关键理解要点


**🔹 匹配规则的记忆方法**
```
记忆口诀：
精确最高要记牢，前缀匹配停检查
正则按序找第一，普通前缀选最长

实际应用：
= /login          → 只匹配 /login
^~ /static/       → 匹配 /static/ 开头，不再检查正则
~ \.(jpg|png)$   → 匹配图片文件
/api/             → 普通前缀，最低优先级
```

**🔹 root与alias的选择原则**
```
选择标准：
目录结构与URL一致 → 使用 root
目录结构与URL不一致 → 使用 alias

实例对比：
root: /images/logo.png → /var/www/images/logo.png
alias: /images/logo.png → /var/www/static/logo.png
```

**🔹 try_files的实用价值**
```
核心作用：实现灵活的回退机制
常见模式：
$uri $uri/ /index.html        # SPA应用
$uri $uri/ @backend           # 静态优先，动态兜底
$uri $uri/ =404              # 找不到返回404
```

### 8.3 实际应用指导


**🎯 典型配置模板**

**基础Web站点**：
```nginx
server {
    listen 80;
    server_name example.com;
    root /var/www/html;
    index index.html index.htm;
    
    # 主页面
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # API接口
    location /api/ {
        proxy_pass http://backend;
    }
}
```

**文件服务器**：
```nginx
server {
    listen 80;
    server_name files.example.com;
    
    # 公共下载
    location /public/ {
        root /data;
        autoindex on;
    }
    
    # 私有文件
    location /private/ {
        auth_basic "登录验证";
        auth_basic_user_file /etc/nginx/.htpasswd;
        root /data;
    }
}
```

### 8.4 常见问题解决


**🔧 配置调试技巧**
```
问题排查步骤：
1. 检查location匹配是否正确
2. 验证文件路径是否存在  
3. 确认权限设置是否合理
4. 查看错误日志定位问题

调试方法：
# 临时添加调试信息
location /debug {
    return 200 "URI: $uri, 文件路径: $document_root$uri";
}
```

**🚨 常见错误避免**
```
易错点1：alias路径斜杠不匹配
易错点2：正则表达式转义字符错误
易错点3：try_files最后参数必须是文件或命名location
易错点4：rewrite标志位使用不当造成死循环
```

### 8.5 性能优化建议


**⚡ 性能最佳实践**
```
配置优化：
1. 静态文件使用expires和Cache-Control
2. 启用gzip压缩减少传输量
3. 使用location优先级避免不必要的正则检查
4. 合理设置文件句柄和连接限制

监控要点：
- location匹配命中率
- 静态文件缓存效率  
- 错误页面访问频率
- 安全规则拦截情况
```

**核心记忆**：
- Location配置是Nginx的核心，决定请求如何处理
- 掌握匹配优先级是配置正确性的关键
- root/alias、try_files是文件服务的基础
- 安全配置和性能优化同样重要
- 实际应用中要结合业务需求灵活配置