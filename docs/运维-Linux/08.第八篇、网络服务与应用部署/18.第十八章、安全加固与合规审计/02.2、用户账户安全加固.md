---
title: 2、用户账户安全加固
---
## 📚 目录

1. [密码复杂度策略配置](#1-密码复杂度策略配置)
2. [账户锁定与解锁机制](#2-账户锁定与解锁机制)
3. [用户会话超时设置](#3-用户会话超时设置)
4. [多因素认证配置](#4-多因素认证配置)
5. [特权账户管理策略](#5-特权账户管理策略)
6. [用户权限最小化原则](#6-用户权限最小化原则)
7. [账户生命周期管理](#7-账户生命周期管理)
8. [登录失败审计与告警](#8-登录失败审计与告警)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔐 密码复杂度策略配置


### 1.1 什么是密码复杂度策略

**简单理解**：就像给你家大门设置一把复杂的锁，密码复杂度策略是系统强制用户设置"足够复杂"密码的规则。

**核心作用**：
- 防止用户使用过于简单的密码（如123456、password）
- 增加黑客暴力破解的难度
- 符合企业安全合规要求

### 1.2 PAM密码复杂度配置


**什么是PAM**：`PAM`（Pluggable Authentication Modules）是Linux系统的认证模块，简单说就是专门管理"谁能登录、怎么登录"的组件。

**核心配置文件**：`/etc/pam.d/common-password` 或 `/etc/pam.d/system-auth`

```bash
# 基础密码复杂度配置
password requisite pam_pwquality.so \
    minlen=8 \          # 最短8个字符
    minclass=3 \        # 至少包含3种字符类型
    maxrepeat=2 \       # 相同字符最多重复2次
    dcredit=-1 \        # 至少1个数字
    ucredit=-1 \        # 至少1个大写字母
    lcredit=-1 \        # 至少1个小写字母
    ocredit=-1          # 至少1个特殊字符
```

### 1.3 实用配置示例


**企业级密码策略配置**：
```bash
# 编辑密码质量配置文件
sudo vim /etc/security/pwquality.conf

# 推荐的企业级配置
minlen = 12                    # 最小长度12位
minclass = 4                   # 必须包含4种字符类型
maxrepeat = 2                  # 连续重复字符最多2个
maxsequence = 3                # 连续序列字符最多3个（abc、123）
dictcheck = 1                  # 启用字典检查
usercheck = 1                  # 检查是否包含用户名
```

**配置解释**：
- `minlen`：密码最短长度，12位是比较安全的选择
- `minclass`：字符类型（大写、小写、数字、特殊字符）
- `dictcheck`：防止使用字典中的常见密码
- `usercheck`：防止密码中包含用户名

### 1.4 密码历史记录


**防止重复使用旧密码**：
```bash
# 在 /etc/pam.d/common-password 中添加
password sufficient pam_unix.so remember=5

# 含义：记住最近5次使用过的密码，不允许重复使用
```

**设置密码有效期**：
```bash
# 编辑登录定义文件
sudo vim /etc/login.defs

# 关键配置项
PASS_MAX_DAYS   90          # 密码最长有效期90天
PASS_MIN_DAYS   7           # 密码修改间隔最短7天
PASS_WARN_AGE   14          # 密码过期前14天开始警告
```

---

## 2. 🔒 账户锁定与解锁机制


### 2.1 账户锁定机制的作用

**通俗理解**：就像银行卡连续输错密码会被锁定一样，Linux系统也可以设置用户连续登录失败后自动锁定账户。

**防护目标**：
- 防止暴力破解攻击
- 限制恶意登录尝试
- 保护重要账户安全

### 2.2 使用pam_faillock配置锁定策略


**基础锁定配置**：
```bash
# 编辑认证配置文件
sudo vim /etc/pam.d/common-auth

# 在文件中添加以下配置
auth required pam_faillock.so preauth silent audit deny=3 unlock_time=300
auth [default=die] pam_faillock.so authfail audit deny=3 unlock_time=300
```

**配置参数详解**：
- `deny=3`：连续失败3次后锁定
- `unlock_time=300`：锁定时间300秒（5分钟）
- `audit`：记录失败尝试到审计日志
- `silent`：不显示锁定信息给用户

### 2.3 账户解锁操作


**查看账户锁定状态**：
```bash
# 查看用户锁定信息
sudo faillock --user username

# 显示所有被锁定的账户
sudo faillock
```

**手动解锁账户**：
```bash
# 解锁特定用户
sudo faillock --user username --reset

# 清空所有锁定记录
sudo faillock --reset
```

### 2.4 高级锁定策略


**区分本地和远程登录**：
```bash
# 对SSH登录设置更严格的策略
# 编辑 /etc/pam.d/sshd
auth required pam_faillock.so preauth silent audit deny=2 unlock_time=600

# 对本地控制台登录设置宽松策略  
# 编辑 /etc/pam.d/login
auth required pam_faillock.so preauth silent audit deny=5 unlock_time=300
```

**白名单配置**：某些重要账户（如管理员）可能需要特殊处理：
```bash
# 创建不锁定的用户列表
sudo vim /etc/security/faillock.conf
admin_group = wheel    # wheel组用户不受锁定限制
```

---

## 3. ⏰ 用户会话超时设置


### 3.1 会话超时的重要性

**生活化类比**：就像银行ATM机，如果你操作完忘记退卡，系统会在一段时间后自动退出，防止别人使用你的账户。

**安全价值**：
- 防止用户离开后他人使用其会话
- 减少长时间空闲连接的安全风险
- 节约系统资源

### 3.2 Shell会话超时配置


**系统级超时设置**：
```bash
# 编辑系统环境配置
sudo vim /etc/profile

# 添加超时设置（单位：秒）
export TMOUT=1800          # 30分钟无操作自动退出
readonly TMOUT             # 防止用户修改此设置
```

**用户级超时设置**：
```bash
# 在用户的 ~/.bashrc 或 ~/.bash_profile 中设置
echo "export TMOUT=900" >> ~/.bashrc    # 15分钟超时
```

### 3.3 SSH会话超时配置


**服务端SSH配置**：
```bash
sudo vim /etc/ssh/sshd_config

# 关键超时参数
ClientAliveInterval 300        # 每5分钟发送心跳包
ClientAliveCountMax 2          # 最多允许2次无响应
TCPKeepAlive yes              # 启用TCP保活机制
```

**参数说明**：
- `ClientAliveInterval`：服务器主动检查客户端的间隔时间
- `ClientAliveCountMax`：无响应次数超过此值则断开连接
- 实际超时时间 = 300秒 × 2次 = 10分钟

### 3.4 图形界面会话超时


**GNOME桌面环境**：
```bash
# 使用gsettings配置屏幕保护和自动锁定
gsettings set org.gnome.desktop.screensaver lock-enabled true
gsettings set org.gnome.desktop.screensaver lock-delay 300
gsettings set org.gnome.desktop.session idle-delay 600
```

---

## 4. 🛡️ 多因素认证配置


### 4.1 多因素认证基本概念

**简单理解**：就像取钱需要"银行卡+密码+指纹"三重验证，多因素认证要求用户提供多种证明身份的方式。

**三大认证因素**：
1. **你知道的**：密码、PIN码
2. **你拥有的**：手机、硬件令牌
3. **你是谁**：指纹、人脸识别

### 4.2 Google Authenticator配置


**安装Google Authenticator**：
```bash
# Ubuntu/Debian系统
sudo apt-get install libpam-google-authenticator

# CentOS/RHEL系统
sudo yum install google-authenticator
```

**为用户配置TOTP令牌**：
```bash
# 用户执行初始化配置
google-authenticator

# 按提示回答问题：
# Do you want authentication tokens to be time-based? (y/n) y
# Do you want to disallow multiple uses of the same token? (y/n) y
# Do you want to allow up to 3 extra tokens from future time? (y/n) n
```

### 4.3 PAM模块集成


**配置SSH使用双因素认证**：
```bash
# 1. 编辑PAM配置
sudo vim /etc/pam.d/sshd

# 添加Google Authenticator验证
auth required pam_google_authenticator.so

# 2. 编辑SSH服务配置  
sudo vim /etc/ssh/sshd_config

# 启用质疑响应认证
ChallengeResponseAuthentication yes
AuthenticationMethods publickey,keyboard-interactive
```

### 4.4 实际使用流程


**用户登录体验**：
```
用户连接SSH → 输入密码 → 输入6位动态验证码 → 成功登录
```

**应急访问码**：系统会生成一次性应急代码，防止手机丢失无法登录：
```bash
# 配置时会显示类似信息
Your emergency scratch codes are:
  12345678
  87654321
  # 这些代码只能使用一次，用完就失效
```

---

## 5. 👑 特权账户管理策略


### 5.1 特权账户的定义和风险

**什么是特权账户**：拥有管理员权限或特殊系统访问权限的用户账户，比如root用户、数据库管理员等。

**主要风险**：
- 权限过大，误操作影响整个系统
- 成为黑客的主要攻击目标
- 难以追踪具体操作人员

### 5.2 sudo权限精确控制


**sudo的基本概念**：`sudo`允许普通用户以管理员身份执行特定命令，而不需要知道root密码。

**配置sudo权限**：
```bash
# 使用visudo命令安全编辑sudo配置
sudo visudo

# 基础权限分配示例
# 允许用户执行所有命令
username ALL=(ALL:ALL) ALL

# 允许用户只能重启服务
username ALL=(root) NOPASSWD: /bin/systemctl restart nginx

# 允许组内用户管理用户账户
%admin ALL=(root) /usr/sbin/useradd, /usr/sbin/userdel, /usr/sbin/usermod
```

### 5.3 权限分离策略


**按职能分配权限**：
```bash
# 数据库管理员权限
dbadmin ALL=(postgres) NOPASSWD: /usr/bin/psql, /bin/systemctl restart postgresql

# 网络管理员权限  
netadmin ALL=(root) NOPASSWD: /sbin/iptables, /bin/systemctl restart network

# 备份管理员权限
backup ALL=(root) NOPASSWD: /usr/bin/rsync, /bin/tar
```

### 5.4 特权账户监控


**sudo操作记录**：
```bash
# sudo日志位置
tail -f /var/log/auth.log | grep sudo

# 日志示例：
# Jan 17 10:30:15 server sudo: username : TTY=pts/0 ; PWD=/home/username ; 
# USER=root ; COMMAND=/bin/systemctl restart nginx
```

**定制sudo日志**：
```bash
# 在/etc/sudoers中添加日志配置
Defaults logfile="/var/log/sudo.log"
Defaults log_input, log_output          # 记录命令输入输出
```

---

## 6. 🎯 用户权限最小化原则


### 6.1 最小权限原则的含义

**核心思想**：每个用户只获得完成工作所必需的最小权限，就像给员工发放钥匙，只给他需要进入的房间的钥匙。

### 6.2 文件权限精确控制


**使用ACL进行细粒度控制**：
```bash
# 安装ACL工具
sudo apt-get install acl

# 给特定用户设置文件权限
setfacl -m u:username:r-- /etc/sensitive_config

# 给特定组设置目录权限
setfacl -m g:developers:rwx /opt/project/

# 查看ACL权限
getfacl /etc/sensitive_config
```

### 6.3 系统资源限制


**用户资源配额设置**：
```bash
# 编辑资源限制配置
sudo vim /etc/security/limits.conf

# 限制用户资源使用
username soft nproc 100        # 最多100个进程
username hard nproc 200        # 硬限制200个进程
username soft fsize 100000     # 文件大小限制100MB
username hard memlock 102400   # 内存锁定限制100MB
```

### 6.4 网络访问控制


**使用TCP Wrappers限制网络访问**：
```bash
# 编辑访问控制文件
sudo vim /etc/hosts.allow
# 允许特定用户从特定IP访问SSH
sshd: 192.168.1.100 : spawn (echo "SSH access from %a to %A" | \
    logger -p authpriv.info) : allow

sudo vim /etc/hosts.deny  
# 默认拒绝所有其他访问
sshd: ALL : spawn (echo "SSH denied from %a" | \
    logger -p authpriv.warning) : deny
```

---

## 7. 🔄 账户生命周期管理


### 7.1 账户生命周期概念

**账户生命周期**：用户账户从创建、使用、维护到删除的完整过程，就像员工从入职到离职的全过程管理。

**关键阶段**：
- 📋 **账户创建**：新用户入职
- 🔧 **权限调整**：职位变动
- ⏸️ **账户暂停**：临时离职
- 🗑️ **账户删除**：员工离职

### 7.2 标准化账户创建流程


**账户创建脚本模板**：
```bash
#!/bin/bash
# 用户创建标准流程

USER_NAME=$1
USER_GROUP=$2
HOME_DIR="/home/${USER_NAME}"

# 1. 创建用户账户
useradd -m -g ${USER_GROUP} -s /bin/bash ${USER_NAME}

# 2. 设置初始密码（要求首次登录修改）
echo "${USER_NAME}:TempPass123!" | chpasswd
chage -d 0 ${USER_NAME}  # 强制首次登录修改密码

# 3. 创建个人目录并设置权限
mkdir -p ${HOME_DIR}
chown ${USER_NAME}:${USER_GROUP} ${HOME_DIR}
chmod 750 ${HOME_DIR}

# 4. 记录账户创建日志
echo "$(date): User ${USER_NAME} created" >> /var/log/user_lifecycle.log
```

### 7.3 账户状态监控


**定期检查不活跃账户**：
```bash
# 查找30天未登录的用户
lastlog -b 30 | grep -v "Never"

# 查找密码即将过期的用户
sudo chage -l username | grep "Password expires"

# 批量检查账户状态
for user in $(cat /etc/passwd | cut -d: -f1); do
    echo -n "$user: "
    chage -l $user | grep "Account expires" | cut -d: -f2
done
```

### 7.4 自动化账户清理


**定期清理脚本**：
```bash
#!/bin/bash
# 自动清理长期不活跃账户

INACTIVE_DAYS=90
LOG_FILE="/var/log/account_cleanup.log"

# 查找长期未登录用户
lastlog -b ${INACTIVE_DAYS} | while read line; do
    username=$(echo $line | awk '{print $1}')
    
    # 排除系统账户和管理员账户
    if [[ $username != "root" && $username != "admin" ]]; then
        echo "$(date): Found inactive user: $username" >> $LOG_FILE
        
        # 锁定账户（不删除，以便审计）
        usermod -L $username
        echo "$(date): Locked inactive user: $username" >> $LOG_FILE
    fi
done
```

---

## 8. 📊 登录失败审计与告警


### 8.1 审计日志的重要性

**审计日志作用**：记录所有安全相关事件，就像监控摄像头记录所有进出记录，帮助发现安全问题和攻击行为。

### 8.2 关键日志文件位置


**重要日志文件汇总**：
```bash
# 认证相关日志
/var/log/auth.log          # Ubuntu/Debian认证日志
/var/log/secure           # CentOS/RHEL安全日志

# 系统登录记录
/var/log/wtmp             # 成功登录记录
/var/log/btmp             # 失败登录记录
/var/log/lastlog          # 用户最后登录时间

# SSH连接日志
/var/log/sshd.log         # SSH服务日志
```

### 8.3 实用的日志分析命令


**查看登录失败记录**：
```bash
# 查看最近的失败登录
lastb | head -20

# 统计失败登录次数最多的IP
lastb | awk '{print $3}' | sort | uniq -c | sort -nr | head -10

# 查看特定用户的失败登录
lastb username

# 实时监控认证日志
tail -f /var/log/auth.log | grep "Failed password"
```

**分析SSH攻击模式**：
```bash
# 统计SSH攻击源IP
grep "Failed password" /var/log/auth.log | \
awk '{print $(NF-3)}' | sort | uniq -c | sort -nr

# 查看暴力破解尝试的用户名
grep "Failed password" /var/log/auth.log | \
awk '{print $(NF-5)}' | sort | uniq -c | sort -nr
```

### 8.4 自动告警系统配置


**基于日志的简单告警脚本**：
```bash
#!/bin/bash
# 登录失败告警脚本

THRESHOLD=10              # 告警阈值：10次失败
TIME_WINDOW=300          # 时间窗口：5分钟
ALERT_EMAIL="admin@company.com"

# 检查最近5分钟的失败登录
RECENT_FAILURES=$(journalctl -u ssh --since "5 minutes ago" | \
grep "Failed password" | wc -l)

if [ $RECENT_FAILURES -gt $THRESHOLD ]; then
    # 发送告警邮件
    echo "WARNING: $RECENT_FAILURES failed login attempts in last 5 minutes" | \
    mail -s "SSH Brute Force Alert" $ALERT_EMAIL
    
    # 记录告警日志
    echo "$(date): Alert sent - $RECENT_FAILURES failures" >> /var/log/security_alerts.log
fi
```

### 8.5 日志轮转和保留策略


**配置日志轮转**：
```bash
# 编辑日志轮转配置
sudo vim /etc/logrotate.d/auth

/var/log/auth.log {
    daily                   # 每天轮转
    rotate 90              # 保留90天
    compress               # 压缩旧日志
    delaycompress          # 延迟一天压缩
    notifempty             # 空文件不轮转
    missingok              # 文件不存在时不报错
    postrotate
        systemctl reload rsyslog
    endscript
}
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔐 密码复杂度策略：通过PAM模块强制执行密码安全规则
🔒 账户锁定机制：防止暴力破解，自动锁定多次失败的账户  
⏰ 会话超时设置：防止用户离开后账户被他人使用
🛡️ 多因素认证：密码+动态令牌双重验证保护
👑 特权账户管理：sudo精确控制管理员权限
🎯 最小权限原则：用户只获得完成工作必需的权限
🔄 生命周期管理：账户从创建到删除的全过程控制
📊 审计告警系统：记录和监控所有安全相关事件
```

### 9.2 关键配置文件总览


| **安全功能** | **主要配置文件** | **作用说明** |
|------------|----------------|-------------|
| **密码复杂度** | `/etc/security/pwquality.conf` | `设置密码强度要求` |
| **账户锁定** | `/etc/pam.d/common-auth` | `配置登录失败锁定策略` |
| **会话超时** | `/etc/profile`, `/etc/ssh/sshd_config` | `设置shell和SSH超时` |
| **sudo权限** | `/etc/sudoers` | `精确控制管理员权限` |
| **资源限制** | `/etc/security/limits.conf` | `限制用户系统资源使用` |
| **日志审计** | `/var/log/auth.log` | `记录认证和安全事件` |

### 9.3 实际应用的最佳实践


**🔹 密码安全策略**
- 最小长度12位，包含4种字符类型
- 启用密码历史记录，防止重复使用
- 设置合理的密码有效期（90天）

**🔹 账户管理策略**  
- 连续3次失败锁定5-10分钟
- 定期检查和清理不活跃账户
- 为所有特权操作配置sudo记录

**🔹 监控告警策略**
- 实时监控登录失败和异常访问
- 建立自动告警机制，及时响应威胁
- 定期分析日志，识别攻击模式

### 9.4 安全加固检查清单


**☑️ 基础安全配置**
- [ ] 配置密码复杂度策略
- [ ] 启用账户锁定机制  
- [ ] 设置会话超时时间
- [ ] 配置sudo权限控制

**☑️ 高级安全功能**
- [ ] 部署多因素认证
- [ ] 实施权限最小化原则
- [ ] 建立账户生命周期流程
- [ ] 配置日志审计告警

**☑️ 持续监控维护**
- [ ] 定期检查账户状态
- [ ] 分析安全日志
- [ ] 更新安全策略
- [ ] 进行安全评估

**核心记忆**：
- 用户账户安全是系统防护的第一道防线
- 多层防护比单一措施更有效
- 日志审计是发现问题的重要手段  
- 自动化工具可以提高管理效率
- 定期评估和改进安全策略是必要的