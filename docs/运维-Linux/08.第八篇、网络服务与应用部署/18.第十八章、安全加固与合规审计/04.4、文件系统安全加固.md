---
title: 4、文件系统安全加固
---
## 📚 目录

1. [关键目录权限设置](#1-关键目录权限设置)
2. [敏感文件访问控制](#2-敏感文件访问控制)
3. [文件完整性监控配置](#3-文件完整性监控配置)
4. [临时文件安全清理](#4-临时文件安全清理)
5. [磁盘加密配置](#5-磁盘加密配置)
6. [文件系统挂载安全选项](#6-文件系统挂载安全选项)
7. [重要文件备份与保护](#7-重要文件备份与保护)
8. [文件访问审计配置](#8-文件访问审计配置)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔐 关键目录权限设置


### 1.1 Linux权限基础概念


**什么是文件权限？**
简单说就是控制谁能对文件做什么操作。Linux用数字和字母两种方式表示权限：

```
权限表示方法：
数字方式：755, 644, 600
字母方式：rwxr-xr-x, rw-r--r--, rw-------

权限含义：
r(read)=4    ：读取文件内容
w(write)=2   ：修改文件内容  
x(execute)=1 ：执行文件或进入目录
```

**权限对象**：
- **所有者(owner)**：文件的创建者
- **用户组(group)**：一组用户的集合
- **其他人(others)**：除了所有者和用户组外的所有用户

### 1.2 系统关键目录权限标准


**📋 重要目录权限配置表**

| 目录路径 | **推荐权限** | **所有者:组** | **说明** |
|---------|-------------|--------------|----------|
| `/` | `755` | `root:root` | 根目录，所有人可读可执行 |
| `/boot` | `700` | `root:root` | 启动文件，只有root可访问 |
| `/etc` | `755` | `root:root` | 配置目录，允许读取配置 |
| `/home` | `755` | `root:root` | 用户主目录容器 |
| `/root` | `700` | `root:root` | root用户主目录 |
| `/tmp` | `1777` | `root:root` | 临时文件，粘滞位保护 |
| `/var/log` | `755` | `root:root` | 日志目录 |
| `/usr/bin` | `755` | `root:root` | 系统命令目录 |
| `/sbin` | `755` | `root:root` | 系统管理命令 |

**🔧 权限设置命令**

```bash
# 设置关键目录权限
chmod 700 /root
chmod 755 /etc
chmod 1777 /tmp

# 批量设置系统目录权限
find /etc -type d -exec chmod 755 {} \;
find /etc -type f -exec chmod 644 {} \;
```

### 1.3 用户目录权限管理


**个人目录安全设置**：
- 用户主目录：`750` (只有用户和同组可访问)
- 私人文件：`600` (只有用户可读写)
- 可执行脚本：`700` (只有用户可执行)

```bash
# 设置用户目录安全权限
chmod 750 /home/username
chmod 600 /home/username/.ssh/id_rsa
chmod 644 /home/username/.ssh/id_rsa.pub
chmod 700 /home/username/.ssh
```

---

## 2. 🛡️ 敏感文件访问控制


### 2.1 敏感文件识别


**系统敏感文件清单**：

```
🔴 高度敏感文件：
/etc/shadow          # 用户密码哈希
/etc/gshadow         # 组密码哈希  
/root/.ssh/          # root SSH密钥
/etc/ssh/ssh_host_*  # SSH主机密钥

🟡 中度敏感文件：
/etc/passwd          # 用户账户信息
/etc/group           # 用户组信息
/etc/sudoers         # sudo配置
/var/log/secure      # 安全日志

🟢 一般敏感文件：
/etc/hosts           # 主机名解析
/etc/fstab          # 文件系统挂载
/etc/crontab        # 计划任务
```

### 2.2 访问控制配置


**🔒 敏感文件权限设置**

```bash
# 密码文件权限（只有root可读）
chmod 600 /etc/shadow
chmod 600 /etc/gshadow
chown root:root /etc/shadow /etc/gshadow

# SSH密钥文件权限
chmod 600 /etc/ssh/ssh_host_*_key
chmod 644 /etc/ssh/ssh_host_*_key.pub

# sudo配置文件
chmod 440 /etc/sudoers
visudo  # 安全编辑sudoers文件
```

### 2.3 扩展属性控制


**什么是扩展属性？**
Linux的扩展属性是文件的额外保护机制，比普通权限更强大。

**常用扩展属性**：

```bash
# 设置文件不可变（连root都无法修改）
chattr +i /etc/passwd
chattr +i /etc/shadow

# 设置文件只能追加（适用于日志文件）
chattr +a /var/log/messages

# 查看文件属性
lsattr /etc/passwd
```

> 💡 **提示**：扩展属性比chmod权限更严格，即使root用户也会受到限制！

### 2.4 ACL访问控制列表


**ACL是什么？**
ACL允许你对特定用户或组设置更精细的权限，超越了传统的用户/组/其他人权限模式。

```bash
# 安装ACL工具
yum install acl -y  # CentOS/RHEL
apt install acl -y  # Ubuntu/Debian

# 给特定用户设置文件权限
setfacl -m u:alice:r-- /etc/sensitive_file

# 给特定组设置权限  
setfacl -m g:developers:rw- /project/code

# 查看ACL权限
getfacl /etc/sensitive_file
```

---

## 3. 🔍 文件完整性监控配置


### 3.1 什么是文件完整性监控


**基本概念**：
文件完整性监控就像给重要文件拍"指纹照片"，如果文件被篡改，立即发现变化。

**工作原理**：
```
第一步：扫描系统，记录文件的"指纹"（哈希值、权限、时间戳）
第二步：定期检查，对比现在的"指纹"和之前的记录
第三步：发现不匹配，立即报警
```

### 3.2 AIDE工具配置


**AIDE简介**：
AIDE是Linux上最常用的文件完整性检查工具，就像给系统做"体检"。

**📦 安装和初始配置**

```bash
# 安装AIDE
yum install aide -y        # CentOS/RHEL
apt install aide -y        # Ubuntu/Debian

# 初始化数据库（第一次扫描）
aide --init

# 将初始数据库移动到正式位置
mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz
```

**⚙️ 配置监控规则**

AIDE配置文件：`/etc/aide.conf`

```bash
# 监控关键系统目录
/bin        NORMAL
/sbin       NORMAL  
/etc        NORMAL
/root       NORMAL

# 监控用户目录（排除临时文件）
/home       NORMAL
!/home/*/tmp
!/home/*/.cache

# 自定义监控规则
NORMAL = p+i+n+u+g+s+m+c+md5+sha1
# p=权限 i=inode n=链接数 u=用户 g=组 s=大小 m=时间 c=变化时间
```

**🔄 定期检查**

```bash
# 手动检查
aide --check

# 设置定时检查
echo "0 2 * * * root /usr/sbin/aide --check" >> /etc/crontab

# 检查结果会显示：
# 添加的文件：Added entries
# 删除的文件：Removed entries  
# 修改的文件：Changed entries
```

### 3.3 Tripwire替代方案


**简化版监控脚本**

```bash
#!/bin/bash
# 文件完整性简单监控脚本

MONITOR_DIRS="/etc /root /home"
HASH_FILE="/var/lib/file_integrity.db"

# 生成文件哈希
generate_hashes() {
    find $MONITOR_DIRS -type f -exec md5sum {} \; > $HASH_FILE.new
}

# 检查变化
check_integrity() {
    if [ -f $HASH_FILE ]; then
        diff $HASH_FILE $HASH_FILE.new > /tmp/integrity_diff.txt
        if [ $? -ne 0 ]; then
            echo "⚠️ 发现文件变化！" | mail -s "文件完整性警告" admin@company.com
            cat /tmp/integrity_diff.txt
        fi
    fi
    mv $HASH_FILE.new $HASH_FILE
}
```

---

## 4. 🗑️ 临时文件安全清理


### 4.1 临时文件的安全风险


**为什么要清理临时文件？**
- **隐私泄露**：临时文件可能包含敏感信息
- **磁盘空间**：占用大量存储空间
- **安全隐患**：旧文件可能被恶意利用

**常见临时文件位置**：
```
/tmp/           # 系统临时目录
/var/tmp/       # 长期临时文件
/home/*/.cache/ # 用户缓存目录
/var/log/       # 旧日志文件
/var/spool/     # 邮件队列等
```

### 4.2 自动清理配置


**🔧 设置tmpfs临时文件系统**

```bash
# 编辑fstab，将/tmp挂载为内存文件系统
echo "tmpfs /tmp tmpfs defaults,noexec,nosuid,size=2G 0 0" >> /etc/fstab

# 重新挂载
mount -a

# 验证挂载
df -h /tmp
```

> 💡 **tmpfs优势**：重启后自动清空，速度快，安全性高

**📅 定时清理脚本**

```bash
#!/bin/bash
# 临时文件清理脚本

# 清理7天前的临时文件
find /tmp -type f -mtime +7 -delete
find /var/tmp -type f -mtime +30 -delete

# 清理用户缓存（保留最近3天）
find /home/*/.cache -type f -mtime +3 -delete

# 清理旧日志文件
find /var/log -name "*.log.*.gz" -mtime +30 -delete

# 清理系统垃圾
apt autoclean  # Ubuntu/Debian
yum clean all  # CentOS/RHEL

echo "$(date): 临时文件清理完成" >> /var/log/cleanup.log
```

### 4.3 安全删除技术


**普通删除 vs 安全删除**：

```bash
# 普通删除（文件内容仍在磁盘上）
rm sensitive_file.txt

# 安全删除（覆盖磁盘数据）
shred -vfz -n 3 sensitive_file.txt

# 安装wipe工具进行安全删除
yum install wipe -y
wipe -rf /path/to/sensitive/directory
```

**🔒 安全删除选项说明**：
- `-v`：显示删除过程
- `-f`：强制删除
- `-z`：最后用零覆盖
- `-n 3`：覆盖3次

---

## 5. 🔐 磁盘加密配置


### 5.1 磁盘加密基础概念


**什么是磁盘加密？**
磁盘加密就像给你的硬盘上一把锁，即使有人偷走你的硬盘，没有密钥也无法读取数据。

**加密方式对比**：

```
🏠 全盘加密：
优点：保护所有数据，开机输入密码
缺点：性能开销，忘记密码数据丢失

📁 文件夹加密：  
优点：灵活选择，性能影响小
缺点：部分保护，配置复杂

📄 文件级加密：
优点：精确控制，便于传输
缺点：管理繁琐，容易遗漏
```

### 5.2 LUKS全盘加密


**LUKS简介**：
LUKS是Linux标准的磁盘加密方案，就像给硬盘分区装了一个密码锁。

**🔧 新磁盘加密配置**

```bash
# 1. 安装cryptsetup工具
yum install cryptsetup -y

# 2. 创建加密分区
cryptsetup luksFormat /dev/sdb1
# 输入YES确认，然后设置密码

# 3. 打开加密分区
cryptsetup luksOpen /dev/sdb1 encrypted_disk

# 4. 创建文件系统
mkfs.ext4 /dev/mapper/encrypted_disk

# 5. 挂载使用
mkdir /mnt/secure
mount /dev/mapper/encrypted_disk /mnt/secure
```

**📝 自动挂载配置**

```bash
# 编辑crypttab文件
echo "encrypted_disk /dev/sdb1 none luks" >> /etc/crypttab

# 编辑fstab文件
echo "/dev/mapper/encrypted_disk /mnt/secure ext4 defaults 0 2" >> /etc/fstab
```

### 5.3 文件级加密解决方案


**使用GPG加密文件**：

```bash
# 加密单个文件
gpg -c important_file.txt
# 生成important_file.txt.gpg

# 解密文件  
gpg -d important_file.txt.gpg > important_file.txt

# 使用公钥加密（更安全）
gpg --encrypt -r user@email.com important_file.txt
```

**EncFS目录加密**：

```bash
# 安装encfs
yum install encfs -y

# 创建加密目录
mkdir /encrypted/raw /encrypted/mount
encfs /encrypted/raw /encrypted/mount

# 使用：文件存放在/encrypted/mount，自动加密保存在/encrypted/raw
# 卸载：fusermount -u /encrypted/mount
```

---

## 6. ⚙️ 文件系统挂载安全选项


### 6.1 挂载选项安全原则


**什么是挂载选项？**
挂载选项就像给文件系统定规矩，决定这个分区能做什么、不能做什么。

**🔒 关键安全选项**

| 选项 | **作用** | **使用场景** |
|-----|---------|-------------|
| `noexec` | 禁止执行文件 | /tmp, /var, /home |
| `nosuid` | 禁用SUID权限 | /tmp, /var |
| `nodev` | 禁止设备文件 | /tmp, /home |
| `ro` | 只读挂载 | /boot, 备份分区 |
| `noatime` | 不更新访问时间 | 提升性能 |

### 6.2 安全挂载配置实例


**📝 /etc/fstab安全配置**

```bash
# 系统分区（基本安全选项）
/dev/sda1 /boot ext4 defaults,ro 0 2

# 用户分区（禁用危险功能）  
/dev/sda2 /home ext4 defaults,nodev,nosuid 0 2

# 临时分区（最严格限制）
/dev/sda3 /tmp ext4 defaults,noexec,nodev,nosuid 0 2

# 变量分区（日志和缓存）
/dev/sda4 /var ext4 defaults,nodev,nosuid 0 2

# 内存临时文件系统
tmpfs /dev/shm tmpfs defaults,noexec,nodev,nosuid,size=1G 0 0
```

**🔧 动态重新挂载**

```bash
# 重新挂载为只读（紧急保护）
mount -o remount,ro /home

# 临时添加安全选项
mount -o remount,noexec /tmp

# 验证挂载选项
mount | grep "/tmp"
```

### 6.3 特殊分区安全配置


**网络文件系统安全挂载**：

```bash
# NFS安全挂载
server:/path /mnt/nfs nfs defaults,nodev,nosuid,soft,intr 0 0

# CIFS/SMB安全挂载  
//server/share /mnt/smb cifs username=user,password=pass,nodev,nosuid,iocharset=utf8 0 0
```

**USB设备自动挂载限制**：

```bash
# 编辑udev规则限制USB设备
echo 'SUBSYSTEMS=="usb", ACTION=="add", RUN+="/bin/chmod o-rwx /media/%k"' > /etc/udev/rules.d/99-usb-security.rules

# 重新加载udev规则
udevadm control --reload-rules
```

---

## 7. 💾 重要文件备份与保护


### 7.1 备份策略规划


**3-2-1备份原则**：
- **3份拷贝**：原文件 + 2份备份
- **2种介质**：本地硬盘 + 远程存储
- **1份异地**：防止灾难性损失

**备份分类**：
```
🔴 热备份：数据库运行时备份
🟡 温备份：服务暂停时备份  
🔵 冷备份：系统关闭时完整备份
```

### 7.2 重要文件识别与备份


**📋 关键文件清单**

```bash
#!/bin/bash
# 系统关键文件备份脚本

BACKUP_DIR="/backup/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# 系统配置文件
tar -czf $BACKUP_DIR/etc_backup.tar.gz /etc/

# 用户数据
tar -czf $BACKUP_DIR/home_backup.tar.gz /home/ --exclude="*/tmp" --exclude="*/.cache"

# 系统信息
dpkg --get-selections > $BACKUP_DIR/package_list.txt  # Ubuntu
rpm -qa > $BACKUP_DIR/package_list.txt                # CentOS

# 服务配置
systemctl list-enabled > $BACKUP_DIR/services.txt

# 计划任务
crontab -l > $BACKUP_DIR/crontab_backup.txt

echo "备份完成：$BACKUP_DIR"
```

### 7.3 自动化备份方案


**rsync增量备份**：

```bash
#!/bin/bash
# 增量备份脚本

SOURCE_DIR="/important/data"
BACKUP_DIR="/backup/incremental"
REMOTE_SERVER="backup-server.com"

# 本地增量备份
rsync -avz --delete $SOURCE_DIR/ $BACKUP_DIR/

# 远程备份同步
rsync -avz --delete $BACKUP_DIR/ user@$REMOTE_SERVER:/backup/

# 备份验证
if [ $? -eq 0 ]; then
    echo "$(date): 备份成功" >> /var/log/backup.log
else  
    echo "$(date): 备份失败！" >> /var/log/backup.log
    mail -s "备份失败警告" admin@company.com < /var/log/backup.log
fi
```

**数据库专用备份**：

```bash
# MySQL数据库备份
mysqldump -u root -p --all-databases --single-transaction > backup_$(date +%Y%m%d).sql

# PostgreSQL数据库备份
pg_dumpall -U postgres > backup_$(date +%Y%m%d).sql
```

### 7.4 备份恢复测试


**为什么要测试恢复？**
备份不能恢复等于没有备份！定期测试确保数据可以正常恢复。

```bash
# 创建恢复测试环境
mkdir /restore_test

# 测试文件恢复
tar -xzf /backup/20250121/etc_backup.tar.gz -C /restore_test/

# 验证恢复结果
diff -r /etc/ /restore_test/etc/ > /tmp/restore_diff.txt

# 检查差异
if [ -s /tmp/restore_diff.txt ]; then
    echo "恢复测试发现差异，需要检查备份"
else
    echo "恢复测试通过"
fi
```

---

## 8. 📊 文件访问审计配置


### 8.1 审计系统基础


**什么是文件访问审计？**
就像给文件系统安装"监控摄像头"，记录谁在什么时候对哪个文件做了什么操作。

**审计的价值**：
- **安全调查**：发现入侵痕迹
- **合规要求**：满足法规要求
- **行为分析**：了解用户操作模式
- **故障排查**：定位问题原因

### 8.2 auditd系统配置


**📦 安装和启用auditd**

```bash
# 安装audit工具
yum install audit -y        # CentOS/RHEL
apt install auditd -y       # Ubuntu/Debian

# 启动审计服务
systemctl enable auditd
systemctl start auditd

# 查看审计状态
auditctl -s
```

**⚙️ 审计规则配置**

```bash
# 监控敏感文件访问
auditctl -w /etc/passwd -p wa -k passwd_changes
auditctl -w /etc/shadow -p wa -k shadow_changes
auditctl -w /etc/sudoers -p wa -k sudo_changes

# 监控目录访问
auditctl -w /root -p rwxa -k root_access
auditctl -w /tmp -p rwxa -k tmp_access

# 监控系统调用
auditctl -a always,exit -F arch=b64 -S open,openat -k file_access
auditctl -a always,exit -F arch=b64 -S unlink,unlinkat -k file_delete

# 保存规则到配置文件
auditctl -l > /etc/audit/audit.rules
```

**🔍 审计规则说明**：
- `-w`：监控文件或目录
- `-p`：监控权限（r读取 w写入 x执行 a属性修改）
- `-k`：关键字标签，便于搜索
- `-S`：监控系统调用

### 8.3 日志分析与查询


**📋 基本查询命令**

```bash
# 查看所有审计日志
ausearch -ts today

# 查看特定文件的访问记录
ausearch -f /etc/passwd

# 查看特定用户的操作
ausearch -ui 1000

# 查看特定关键字的事件
ausearch -k passwd_changes

# 生成汇总报告
aureport --summary
aureport --auth    # 认证报告
aureport --file    # 文件访问报告
```

**📊 日志分析脚本**

```bash
#!/bin/bash
# 审计日志分析脚本

echo "=== 文件访问审计报告 ==="
echo "生成时间：$(date)"
echo

echo "1. 敏感文件访问统计："
ausearch -k passwd_changes -i | grep -c "type=SYSCALL"

echo "2. 最近24小时文件删除操作："
ausearch -k file_delete -ts yesterday -te now

echo "3. 异常登录尝试："
ausearch --message AVC -ts today

echo "4. 权限提升操作："
ausearch -k sudo_changes -i
```

### 8.4 实时监控与告警


**inotify实时文件监控**：

```bash
# 安装inotify工具
yum install inotify-tools -y

# 实时监控脚本
#!/bin/bash
WATCH_DIR="/etc /root"

inotifywait -m -r -e create,delete,modify,move $WATCH_DIR |
while read path action file; do
    echo "$(date): $action detected on $path$file" >> /var/log/file_monitor.log
    
    # 关键文件变化立即告警
    if [[ "$file" == "passwd" ]] || [[ "$file" == "shadow" ]]; then
        echo "⚠️ 关键文件 $path$file 发生 $action 操作！" | 
        mail -s "文件安全警告" admin@company.com
    fi
done
```

**集中化日志管理**：

```bash
# 配置rsyslog转发审计日志
echo "*.* $$log-server.company.com:514" >> /etc/rsyslog.conf
systemctl restart rsyslog

# 审计日志轮转配置
cat > /etc/logrotate.d/audit << EOF
/var/log/audit/audit.log {
    daily
    rotate 30  
    compress
    delaycompress
    missingok
    notifempty
    create 0600 root root
    postrotate
        /sbin/service auditd restart > /dev/null 2>&1 || true
    endscript
}
EOF
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的关键概念


```
🔸 权限管理：数字权限(755)和字母权限(rwxr-xr-x)的含义
🔸 访问控制：传统权限、扩展属性(chattr)、ACL的区别和应用
🔸 文件监控：AIDE完整性检查和实时监控的配置方法
🔸 安全清理：临时文件定期清理和安全删除技术
🔸 磁盘加密：LUKS全盘加密和文件级加密的选择
🔸 挂载安全：noexec、nosuid、nodev等选项的实际作用
🔸 备份策略：3-2-1原则和增量备份的实现
🔸 审计配置：auditd系统的规则设置和日志分析
```

### 9.2 实际应用要点


**🔹 权限设置最佳实践**
```
系统目录：严格控制，最小权限原则
用户目录：适度开放，保护隐私文件  
临时目录：严格限制执行权限
日志目录：只允许追加，定期轮转
```

**🔹 监控配置优先级**
```
高优先级：系统关键文件(/etc/passwd, /etc/shadow)
中优先级：用户敏感数据(/home用户目录)
低优先级：临时文件和缓存目录
```

**🔹 备份恢复策略**
```
重要性评估：区分关键数据和一般数据
备份频率：根据数据变化频率确定
恢复测试：定期验证备份可用性
```

### 9.3 安全加固检查清单


**📝 日常安全检查**

```bash
# 权限检查脚本
#!/bin/bash
echo "🔍 文件系统安全检查"

# 1. 检查关键文件权限
echo "检查关键文件权限..."
ls -la /etc/passwd /etc/shadow /etc/sudoers

# 2. 检查SUID文件
echo "检查SUID文件..."
find / -perm -4000 -type f 2>/dev/null

# 3. 检查临时目录权限
echo "检查临时目录..."
ls -ld /tmp /var/tmp

# 4. 检查挂载选项
echo "检查挂载选项..."
mount | grep -E "(noexec|nosuid|nodev)"

# 5. 检查审计状态
echo "检查审计服务..."
systemctl status auditd
```

### 9.4 常见问题解决


**❓ 文件权限问题**
```
问题：用户无法访问自己的文件
检查：ls -la 查看权限设置
解决：chmod 750 恢复正确权限

问题：SSH密钥无法使用
检查：ls -la ~/.ssh/
解决：chmod 600 ~/.ssh/id_rsa
```

**❓ 监控配置问题**  
```
问题：AIDE检查报告大量误报
原因：监控规则过于严格
解决：排除变化频繁的目录和文件

问题：审计日志增长过快
原因：监控规则过于宽泛  
解决：精确设置监控范围和关键字
```

### 9.5 进阶学习方向


**🚀 深入安全加固**
- **SELinux/AppArmor**：强制访问控制系统
- **容器安全**：Docker/Podman容器文件系统保护
- **网络文件系统**：NFS/CIFS的安全配置
- **数据库安全**：MySQL/PostgreSQL文件级保护

**🛠️ 自动化工具**
- **Ansible**：自动化安全配置部署
- **OSSEC/Wazuh**：主机入侵检测系统  
- **Tripwire**：商业级文件完整性监控
- **Lynis**：系统安全审计工具

**核心记忆**：
- 文件系统安全是Linux安全的基础
- 权限控制遵循最小权限原则
- 监控和审计提供安全可见性  
- 备份和恢复是最后的安全保障
- 定期检查和测试确保配置有效