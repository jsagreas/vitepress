---
title: 3ã€SSHæœåŠ¡å®‰å…¨åŠ å›º
---
## ğŸ“š ç›®å½•

1. [SSHå®‰å…¨åŠ å›ºæ¦‚è¿°](#1-SSHå®‰å…¨åŠ å›ºæ¦‚è¿°)
2. [SSHé…ç½®æ–‡ä»¶å®‰å…¨ä¼˜åŒ–](#2-SSHé…ç½®æ–‡ä»¶å®‰å…¨ä¼˜åŒ–)
3. [ç”¨æˆ·æƒé™ä¸è®¤è¯å¼ºåŒ–](#3-ç”¨æˆ·æƒé™ä¸è®¤è¯å¼ºåŒ–)
4. [ç½‘ç»œè®¿é—®æ§åˆ¶](#4-ç½‘ç»œè®¿é—®æ§åˆ¶)
5. [ä¼šè¯ç®¡ç†ä¸ç›‘æ§](#5-ä¼šè¯ç®¡ç†ä¸ç›‘æ§)
6. [æ—¥å¿—å®¡è®¡ä¸å¼‚å¸¸æ£€æµ‹](#6-æ—¥å¿—å®¡è®¡ä¸å¼‚å¸¸æ£€æµ‹)
7. [å®æˆ˜é…ç½®æ¡ˆä¾‹](#7-å®æˆ˜é…ç½®æ¡ˆä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ SSHå®‰å…¨åŠ å›ºæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯SSHå®‰å…¨åŠ å›º


**SSHå®‰å…¨åŠ å›º**æ˜¯æŒ‡é€šè¿‡ä¿®æ”¹SSHæœåŠ¡é…ç½®ã€ä¼˜åŒ–è®¤è¯æ–¹å¼ã€é™åˆ¶è®¿é—®æƒé™ç­‰æ‰‹æ®µï¼Œæé«˜SSHæœåŠ¡çš„å®‰å…¨æ€§ï¼Œé˜²æ­¢æ¶æ„æ”»å‡»å’Œæœªæˆæƒè®¿é—®ã€‚

```
SSHå®‰å…¨å¨èƒç¤ºæ„å›¾ï¼š
æ”»å‡»è€… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SSHæœåŠ¡å™¨
   â”‚                        â”‚
   â”œâ”€â”€ æš´åŠ›ç ´è§£å¯†ç          â”œâ”€â”€ å¼±å¯†ç è´¦æˆ·
   â”œâ”€â”€ ç«¯å£æ‰«ææ¢æµ‹         â”œâ”€â”€ é»˜è®¤é…ç½®
   â”œâ”€â”€ å­—å…¸æ”»å‡»             â”œâ”€â”€ rootç›´æ¥ç™»å½•
   â””â”€â”€ æ¶æ„ç™»å½•å°è¯•         â””â”€â”€ æ— è®¿é—®é™åˆ¶

åŠ å›ºåçš„é˜²æŠ¤ï¼š
æ”»å‡»è€… â”€â”€Xâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SSHæœåŠ¡å™¨
   â”‚        é˜²æŠ¤æªæ–½          â”‚
   â”œâ”€â”€ å¯†é’¥è®¤è¯é˜»æ–­         â”œâ”€â”€ å¼ºå¯†ç ç­–ç•¥
   â”œâ”€â”€ ç«¯å£ä¼ªè£…éšè—         â”œâ”€â”€ ä¼˜åŒ–é…ç½®
   â”œâ”€â”€ IPç™½åå•è¿‡æ»¤         â”œâ”€â”€ ç¦ç”¨rootç™»å½•
   â””â”€â”€ ç™»å½•å°è¯•é™åˆ¶         â””â”€â”€ ä¸¥æ ¼æƒé™æ§åˆ¶
```

### 1.2 ä¸ºä»€ä¹ˆè¦è¿›è¡ŒSSHå®‰å…¨åŠ å›º


**ğŸ”¸ é¢ä¸´çš„ä¸»è¦å¨èƒ**
- **æš´åŠ›ç ´è§£æ”»å‡»**ï¼šè‡ªåŠ¨åŒ–å·¥å…·ä¸æ–­å°è¯•ç”¨æˆ·åå¯†ç ç»„åˆ
- **ç«¯å£æ‰«æ**ï¼šæ¶æ„ç”¨æˆ·æ‰«æé»˜è®¤SSHç«¯å£22
- **æƒé™æå‡**ï¼šæ”»å‡»è€…é€šè¿‡SSHè·å¾—ç³»ç»Ÿè®¿é—®æƒåæå‡æƒé™
- **å†…ç½‘æ¨ªå‘ç§»åŠ¨**ï¼šåˆ©ç”¨SSHåœ¨å†…ç½‘ä¸­æ‰©æ•£æ”»å‡»

**ğŸ”¸ å®‰å…¨åŠ å›ºçš„ä»·å€¼**
```
æœªåŠ å›ºé£é™©ï¼š
ğŸ“Š æ”»å‡»æˆåŠŸç‡ï¼š60-80%
ğŸ“Š å‘ç°æ—¶é—´ï¼šæ•°å¤©åˆ°æ•°æœˆ
ğŸ“Š æŸå¤±ç¨‹åº¦ï¼šæ•°æ®æ³„éœ²ã€ç³»ç»Ÿç˜«ç—ª

åŠ å›ºåæ•ˆæœï¼š
ğŸ“Š æ”»å‡»æˆåŠŸç‡ï¼š<5%
ğŸ“Š å‘ç°æ—¶é—´ï¼šåˆ†é’Ÿçº§åˆ«
ğŸ“Š æŸå¤±ç¨‹åº¦ï¼šæ˜¾è‘—é™ä½
```

### 1.3 SSHå®‰å…¨åŠ å›ºçš„æ ¸å¿ƒåŸåˆ™


**ğŸ¯ æœ€å°æƒé™åŸåˆ™**ï¼šåªç»™ç”¨æˆ·æœ€å°å¿…è¦æƒé™
**ğŸ¯ å¤šå±‚é˜²æŠ¤åŸåˆ™**ï¼šè®¾ç½®å¤šé“å®‰å…¨é˜²çº¿
**ğŸ¯ ç›‘æ§å®¡è®¡åŸåˆ™**ï¼šè®°å½•æ‰€æœ‰å…³é”®æ“ä½œ
**ğŸ¯ å®šæœŸæ›´æ–°åŸåˆ™**ï¼šåŠæ—¶ä¿®è¡¥å®‰å…¨æ¼æ´

---

## 2. âš™ï¸ SSHé…ç½®æ–‡ä»¶å®‰å…¨ä¼˜åŒ–


### 2.1 SSHä¸»é…ç½®æ–‡ä»¶ä½ç½®


SSHæœåŠ¡çš„ä¸»é…ç½®æ–‡ä»¶ä½äº `/etc/ssh/sshd_config`ï¼Œè¿™æ˜¯è¿›è¡Œå®‰å…¨åŠ å›ºçš„æ ¸å¿ƒæ–‡ä»¶ã€‚

```
SSHé…ç½®æ–‡ä»¶ç»“æ„ï¼š
/etc/ssh/
â”œâ”€â”€ ğŸ“„ sshd_config      â† æœåŠ¡ç«¯é…ç½®ï¼ˆé‡ç‚¹ï¼‰
â”œâ”€â”€ ğŸ“„ ssh_config       â† å®¢æˆ·ç«¯é…ç½®
â”œâ”€â”€ ğŸ“„ ssh_host_*_key   â† æœåŠ¡å™¨å¯†é’¥æ–‡ä»¶
â””â”€â”€ ğŸ“ ssh_config.d/    â† é…ç½®ç‰‡æ®µç›®å½•
```

### 2.2 åŸºç¡€å®‰å…¨é…ç½®é¡¹


#### ğŸ”§ ç«¯å£ä¿®æ”¹ä¸éšè—


**ä¸ºä»€ä¹ˆè¦ä¿®æ”¹ç«¯å£ï¼Ÿ**
- é»˜è®¤ç«¯å£22æ˜¯æ”»å‡»è€…é¦–é€‰ç›®æ ‡
- ä¿®æ”¹ç«¯å£å¯ä»¥å‡å°‘è‡ªåŠ¨åŒ–æ‰«ææ”»å‡»
- èµ·åˆ°"å®‰å…¨é€šè¿‡æ¨¡ç³Š"çš„ä½œç”¨

```bash
# ç¼–è¾‘SSHé…ç½®æ–‡ä»¶
sudo vi /etc/ssh/sshd_config

# ä¿®æ”¹ç«¯å£é…ç½®
Port 22334  # ä½¿ç”¨1024-65535ä¹‹é—´çš„ç«¯å£

# é‡å¯SSHæœåŠ¡
sudo systemctl restart sshd
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**
> ä¿®æ”¹ç«¯å£åï¼Œè¿æ¥æ—¶éœ€è¦æŒ‡å®šæ–°ç«¯å£ï¼š`ssh -p 22334 user@server`

#### ğŸ”§ åè®®ç‰ˆæœ¬é™åˆ¶


SSHæœ‰ä¸¤ä¸ªä¸»è¦ç‰ˆæœ¬ï¼ŒSSH-1å­˜åœ¨å®‰å…¨æ¼æ´ï¼Œåº”å¼ºåˆ¶ä½¿ç”¨SSH-2ã€‚

```bash
# åªå…è®¸SSHåè®®ç‰ˆæœ¬2
Protocol 2
```

#### ğŸ”§ ç™»å½•è¶…æ—¶é…ç½®


è®¾ç½®åˆç†çš„ç™»å½•è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢ç©ºé—²è¿æ¥å ç”¨èµ„æºã€‚

```bash
# ç™»å½•è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
LoginGraceTime 60

# å®¢æˆ·ç«¯è¿æ¥å­˜æ´»æ£€æµ‹
ClientAliveInterval 600    # æ¯600ç§’å‘é€ä¸€æ¬¡å­˜æ´»åŒ…
ClientAliveCountMax 3      # æœ€å¤š3æ¬¡æ— å“åº”åæ–­å¼€
```

**é…ç½®å«ä¹‰è§£é‡Šï¼š**
- `LoginGraceTime`ï¼šç”¨æˆ·ä»è¿æ¥åˆ°å®Œæˆè®¤è¯çš„æœ€å¤§æ—¶é—´
- `ClientAliveInterval`ï¼šæœåŠ¡å™¨ä¸»åŠ¨æ£€æµ‹å®¢æˆ·ç«¯å­˜æ´»çš„é—´éš”
- `ClientAliveCountMax`ï¼šè¿ç»­æ— å“åº”çš„æœ€å¤§æ¬¡æ•°

### 2.3 è®¤è¯å®‰å…¨é…ç½®


#### ğŸ”‘ å¯†ç è®¤è¯å¼ºåŒ–


```bash
# å…è®¸å¯†ç è®¤è¯ï¼ˆå»ºè®®åç»­æ”¹ä¸ºå¯†é’¥è®¤è¯ï¼‰
PasswordAuthentication yes

# å¼ºåˆ¶ä½¿ç”¨å¼ºå¯†ç 
# é…åˆPAMæ¨¡å—ä½¿ç”¨
UsePAM yes

# ç¦ç”¨ç©ºå¯†ç ç™»å½•
PermitEmptyPasswords no

# ç¦ç”¨åŸºäºä¸»æœºçš„è®¤è¯
HostbasedAuthentication no
```

#### ğŸ”‘ è®¤è¯å°è¯•é™åˆ¶


```bash
# æœ€å¤§è®¤è¯å°è¯•æ¬¡æ•°
MaxAuthTries 3

# æ¯ä¸ªè¿æ¥çš„æœ€å¤§ä¼šè¯æ•°
MaxSessions 2

# åŒæ—¶è¿›è¡Œè®¤è¯çš„è¿æ¥æ•°
MaxStartups 10:30:60
```

**MaxStartupså‚æ•°è§£é‡Šï¼š**
```
æ ¼å¼ï¼šstart:rate:full
start=10  - å¼€å§‹é™åˆ¶çš„è¿æ¥æ•°
rate=30   - æ‹’ç»ç‡30%ï¼ˆ30%çš„æ–°è¿æ¥è¢«æ‹’ç»ï¼‰
full=60   - å®Œå…¨æ‹’ç»æ–°è¿æ¥çš„æ•°é‡
```

---

## 3. ğŸ‘¤ ç”¨æˆ·æƒé™ä¸è®¤è¯å¼ºåŒ–


### 3.1 ç¦ç”¨rootè¿œç¨‹ç™»å½•


**ä¸ºä»€ä¹ˆè¦ç¦ç”¨rootè¿œç¨‹ç™»å½•ï¼Ÿ**
- rootè´¦æˆ·æ˜¯æ”»å‡»è€…çš„é¦–è¦ç›®æ ‡
- rootæƒé™è¿‡å¤§ï¼Œä¸€æ—¦è¢«æ”»ç ´åæœä¸¥é‡
- æ— æ³•è¿½è¸ªå…·ä½“æ“ä½œäººå‘˜

```bash
# ç¦ç”¨rootè¿œç¨‹ç™»å½•
PermitRootLogin no
```

**ğŸ”¸ æ›¿ä»£æ–¹æ¡ˆï¼šä½¿ç”¨sudoæœºåˆ¶**

```bash
# 1. åˆ›å»ºæ™®é€šç”¨æˆ·
sudo useradd -m -s /bin/bash admin_user

# 2. è®¾ç½®å¯†ç 
sudo passwd admin_user

# 3. æ·»åŠ åˆ°sudoç»„
sudo usermod -aG sudo admin_user

# 4. é…ç½®sudoå…å¯†ï¼ˆå¯é€‰ï¼‰
echo "admin_user ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/admin_user
```

### 3.2 å¯†é’¥è®¤è¯å¼ºåˆ¶é…ç½®


å¯†é’¥è®¤è¯æ¯”å¯†ç è®¤è¯æ›´å®‰å…¨ï¼Œå› ä¸ºç§é’¥å¾ˆéš¾è¢«æš´åŠ›ç ´è§£ã€‚

#### ğŸ” ç”ŸæˆSSHå¯†é’¥å¯¹


```bash
# åœ¨å®¢æˆ·ç«¯ç”Ÿæˆå¯†é’¥å¯¹
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# å‚æ•°è¯´æ˜ï¼š
# -t rsa     : ä½¿ç”¨RSAç®—æ³•
# -b 4096    : å¯†é’¥é•¿åº¦4096ä½
# -C         : æ³¨é‡Šä¿¡æ¯
```

**å¯†é’¥ç”Ÿæˆè¿‡ç¨‹ï¼š**
```
ç”Ÿæˆå¯†é’¥å¯¹æµç¨‹ï¼š
1. é€‰æ‹©ä¿å­˜ä½ç½®ï¼ˆé»˜è®¤ï¼š~/.ssh/id_rsaï¼‰
2. è®¾ç½®passphraseï¼ˆå¯é€‰ï¼Œå»ºè®®è®¾ç½®ï¼‰
3. ç”Ÿæˆå…¬é’¥å’Œç§é’¥æ–‡ä»¶

ç»“æœæ–‡ä»¶ï¼š
~/.ssh/id_rsa     â† ç§é’¥ï¼ˆä¸¥æ ¼ä¿å¯†ï¼‰
~/.ssh/id_rsa.pub â† å…¬é’¥ï¼ˆå¯ä»¥åˆ†äº«ï¼‰
```

#### ğŸ” éƒ¨ç½²å…¬é’¥åˆ°æœåŠ¡å™¨


```bash
# æ–¹æ³•1ï¼šä½¿ç”¨ssh-copy-idï¼ˆæ¨èï¼‰
ssh-copy-id -i ~/.ssh/id_rsa.pub user@server

# æ–¹æ³•2ï¼šæ‰‹åŠ¨å¤åˆ¶
cat ~/.ssh/id_rsa.pub | ssh user@server "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"

# æ–¹æ³•3ï¼šç›´æ¥ç¼–è¾‘æ–‡ä»¶
# ç™»å½•æœåŠ¡å™¨åç¼–è¾‘ ~/.ssh/authorized_keys
```

#### ğŸ” å¼ºåˆ¶å¯†é’¥è®¤è¯


```bash
# ç¦ç”¨å¯†ç è®¤è¯ï¼Œå¼ºåˆ¶ä½¿ç”¨å¯†é’¥
PasswordAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
```

> ğŸ’¡ **æœ€ä½³å®è·µ**
> 1. å…ˆç¡®ä¿å¯†é’¥è®¤è¯æ­£å¸¸å·¥ä½œ
> 2. å†ç¦ç”¨å¯†ç è®¤è¯
> 3. ä¿ç•™ä¸€ä¸ªç»ˆç«¯è¿æ¥ï¼Œé¿å…é…ç½®é”™è¯¯å¯¼è‡´æ— æ³•ç™»å½•

### 3.3 ç”¨æˆ·è®¿é—®é™åˆ¶


#### ğŸ‘¥ å…è®¸/æ‹’ç»ç‰¹å®šç”¨æˆ·


```bash
# åªå…è®¸ç‰¹å®šç”¨æˆ·ç™»å½•
AllowUsers user1 user2 admin@192.168.1.100

# æ‹’ç»ç‰¹å®šç”¨æˆ·ç™»å½•  
DenyUsers guest nobody

# åªå…è®¸ç‰¹å®šç»„ç™»å½•
AllowGroups sshusers admin

# æ‹’ç»ç‰¹å®šç»„ç™»å½•
DenyGroups games users
```

**é…ç½®ä¼˜å…ˆçº§ï¼š**
```
é…ç½®ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
1. DenyUsers   - æ‹’ç»ç”¨æˆ·
2. AllowUsers  - å…è®¸ç”¨æˆ·  
3. DenyGroups  - æ‹’ç»ç»„
4. AllowGroups - å…è®¸ç»„
```

---

## 4. ğŸŒ ç½‘ç»œè®¿é—®æ§åˆ¶


### 4.1 SSHç«¯å£ä¿®æ”¹ä¸é˜²æ‰«æ


#### ğŸšª ç«¯å£ä¼ªè£…ç­–ç•¥


```bash
# ä½¿ç”¨éæ ‡å‡†ç«¯å£
Port 22334

# å¤šç«¯å£ç›‘å¬ï¼ˆå¢åŠ è¿·æƒ‘æ€§ï¼‰
Port 22334
Port 2233
```

**ç«¯å£é€‰æ‹©å»ºè®®ï¼š**
- âœ… **é¿å…ä½¿ç”¨**ï¼š22, 2222, 22222ï¼ˆå¤ªæ˜æ˜¾ï¼‰
- âœ… **æ¨èä½¿ç”¨**ï¼š10000-65535èŒƒå›´å†…çš„éšæœºç«¯å£
- âœ… **æ£€æŸ¥å†²çª**ï¼šç¡®ä¿ç«¯å£æœªè¢«å…¶ä»–æœåŠ¡å ç”¨

```bash
# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
sudo netstat -tlnp | grep :22334
sudo ss -tlnp | grep :22334
```

#### ğŸšª é˜²æ‰«æé…ç½®


```bash
# é™åˆ¶è¿æ¥é¢‘ç‡
MaxStartups 3:50:10

# è®¾ç½®ç™»å½•æ¨ªå¹…ï¼ˆè¯¯å¯¼æ”»å‡»è€…ï¼‰
Banner /etc/ssh/banner.txt
```

**åˆ›å»ºè¯¯å¯¼æ¨ªå¹…ï¼š**
```bash
sudo vi /etc/ssh/banner.txt
```
```
====================================================
WARNING: This is a Windows Server 2019 system
Unauthorized access is strictly prohibited
All activities are monitored and logged
====================================================
```

### 4.2 ç™»å½•IPç™½åå•é™åˆ¶


#### ğŸ” åŸºäºIPçš„è®¿é—®æ§åˆ¶


**æ–¹æ³•1ï¼šSSHé…ç½®æ–‡ä»¶é™åˆ¶**
```bash
# å…è®¸ç‰¹å®šIPç™»å½•
AllowUsers user@192.168.1.100
AllowUsers admin@10.0.0.0/24

# ä»ç‰¹å®šIPæ‹’ç»ç™»å½•
DenyUsers *@192.168.1.50
```

**æ–¹æ³•2ï¼šä½¿ç”¨é˜²ç«å¢™è§„åˆ™**
```bash
# iptablesè§„åˆ™
sudo iptables -A INPUT -p tcp --dport 22334 -s 192.168.1.100 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 22334 -j DROP

# UFWè§„åˆ™ï¼ˆUbuntuï¼‰
sudo ufw allow from 192.168.1.100 to any port 22334
sudo ufw deny 22334
```

**æ–¹æ³•3ï¼šTCP Wrappers**
```bash
# ç¼–è¾‘ /etc/hosts.allow
echo "sshd: 192.168.1.100 10.0.0.0/24" | sudo tee -a /etc/hosts.allow

# ç¼–è¾‘ /etc/hosts.deny  
echo "sshd: ALL" | sudo tee -a /etc/hosts.deny
```

### 4.3 ç›‘å¬åœ°å€é™åˆ¶


```bash
# åªç›‘å¬ç‰¹å®šç½‘ç»œæ¥å£
ListenAddress 192.168.1.10:22334
ListenAddress 10.0.0.10:22334

# ä¸ç›‘å¬æ‰€æœ‰æ¥å£ï¼ˆé»˜è®¤ä¸º0.0.0.0ï¼‰
# ListenAddress 0.0.0.0:22334  # æ³¨é‡Šæ‰æ­¤è¡Œ
```

**ç½‘ç»œæ¥å£æŸ¥çœ‹ï¼š**
```bash
# æŸ¥çœ‹ç½‘ç»œæ¥å£
ip addr show
ifconfig

# é€‰æ‹©åˆé€‚çš„IPåœ°å€è¿›è¡Œç›‘å¬
```

---

## 5. â° ä¼šè¯ç®¡ç†ä¸ç›‘æ§


### 5.1 SSHä¼šè¯è¶…æ—¶é…ç½®


#### â±ï¸ è‡ªåŠ¨æ–­çº¿è®¾ç½®


```bash
# å®¢æˆ·ç«¯å­˜æ´»æ£€æµ‹
ClientAliveInterval 300    # 5åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡
ClientAliveCountMax 2      # æœ€å¤š2æ¬¡æ— å“åº”åæ–­å¼€

# ç™»å½•å®½é™æ—¶é—´
LoginGraceTime 30         # 30ç§’å†…å¿…é¡»å®Œæˆè®¤è¯
```

**è¶…æ—¶è®¡ç®—ï¼š**
```
æ€»è¶…æ—¶æ—¶é—´ = ClientAliveInterval Ã— ClientAliveCountMax
ç¤ºä¾‹ï¼š300ç§’ Ã— 2æ¬¡ = 600ç§’ï¼ˆ10åˆ†é’Ÿæ— æ“ä½œè‡ªåŠ¨æ–­å¼€ï¼‰
```

#### â±ï¸ ä¼šè¯æ•°é‡é™åˆ¶


```bash
# æ¯ä¸ªç”¨æˆ·çš„æœ€å¤§ä¼šè¯æ•°
MaxSessions 3

# æ¯ä¸ªç½‘ç»œè¿æ¥çš„æœ€å¤§ä¼šè¯æ•°  
MaxStartups 5:30:10
```

### 5.2 ç™»å½•æ¨ªå¹…ä¸è­¦å‘Šä¿¡æ¯


#### ğŸ“¢ æ³•å¾‹è­¦å‘Šæ¨ªå¹…


```bash
# SSHé…ç½®ä¸­å¯ç”¨æ¨ªå¹…
Banner /etc/ssh/legal_banner.txt
```

**åˆ›å»ºæ³•å¾‹æ¨ªå¹…æ–‡ä»¶ï¼š**
```bash
sudo vi /etc/ssh/legal_banner.txt
```
```
*********************************************************************
*                        AUTHORIZED USE ONLY                       *
*********************************************************************
*                                                                   *
* This system is for authorized users only. All activities on      *
* this system are monitored and recorded. By using this system,    *
* you consent to such monitoring and recording.                    *
*                                                                   *
* Unauthorized access or use is strictly prohibited and may be     *
* subject to civil and criminal penalties.                         *
*                                                                   *
*********************************************************************
```

#### ğŸ“¢ ç™»å½•åä¿¡æ¯æ˜¾ç¤º


```bash
# ç¼–è¾‘ç™»å½•åæ˜¾ç¤ºä¿¡æ¯
sudo vi /etc/motd
```
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘            Production Server             â•‘
â•‘          Last Login Information          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ” Security Notice:
   â€¢ All activities are logged and monitored
   â€¢ Unauthorized access is prohibited
   â€¢ Report security incidents immediately

ğŸ“Š System Status: [âœ… NORMAL]
ğŸ• Current Time: $(date)
```

---

## 6. ğŸ“Š æ—¥å¿—å®¡è®¡ä¸å¼‚å¸¸æ£€æµ‹


### 6.1 SSHæ—¥å¿—é…ç½®


#### ğŸ“ æ—¥å¿—çº§åˆ«è®¾ç½®


```bash
# SSHé…ç½®ä¸­çš„æ—¥å¿—è®¾ç½®
LogLevel VERBOSE
SyslogFacility AUTHPRIV
```

**æ—¥å¿—çº§åˆ«è¯´æ˜ï¼š**
```
æ—¥å¿—çº§åˆ«ï¼ˆä»ä½åˆ°é«˜ï¼‰ï¼š
QUIET    - æ— æ—¥å¿—
FATAL    - åªè®°å½•è‡´å‘½é”™è¯¯
ERROR    - è®°å½•é”™è¯¯ä¿¡æ¯
INFO     - è®°å½•ä¸€èˆ¬ä¿¡æ¯
VERBOSE  - è¯¦ç»†æ—¥å¿—ï¼ˆæ¨èï¼‰
DEBUG    - è°ƒè¯•ä¿¡æ¯ï¼ˆæ’é”™æ—¶ä½¿ç”¨ï¼‰
```

#### ğŸ“ æ—¥å¿—å­˜å‚¨ä½ç½®


SSHæ—¥å¿—é€šå¸¸å­˜å‚¨åœ¨ç³»ç»Ÿæ—¥å¿—ä¸­ï¼š

```bash
# ä¸åŒç³»ç»Ÿçš„SSHæ—¥å¿—ä½ç½®
Ubuntu/Debian: /var/log/auth.log
CentOS/RHEL:   /var/log/secure
é€šç”¨ç³»ç»Ÿ:       /var/log/messages

# æŸ¥çœ‹SSHç›¸å…³æ—¥å¿—
sudo tail -f /var/log/auth.log | grep ssh
sudo journalctl -u sshd -f
```

### 6.2 æ—¥å¿—åˆ†æä¸ç›‘æ§


#### ğŸ” å…³é”®æ—¥å¿—äº‹ä»¶


**æˆåŠŸç™»å½•æ—¥å¿—ï¼š**
```
Jan 17 10:30:15 server sshd[1234]: Accepted publickey for admin from 192.168.1.100 port 54321 ssh2
```

**å¤±è´¥ç™»å½•æ—¥å¿—ï¼š**
```
Jan 17 10:32:20 server sshd[1235]: Failed password for root from 192.168.1.200 port 12345 ssh2
```

**æš´åŠ›ç ´è§£æ”»å‡»ï¼š**
```
Jan 17 10:35:10 server sshd[1236]: Invalid user hack from 192.168.1.200
Jan 17 10:35:15 server sshd[1237]: Failed password for hack from 192.168.1.200 port 23456 ssh2
```

#### ğŸ” è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬


```bash
#!/bin/bash
# SSHå®‰å…¨ç›‘æ§è„šæœ¬ /usr/local/bin/ssh_monitor.sh

LOG_FILE="/var/log/auth.log"
ALERT_EMAIL="admin@company.com"

# æ£€æŸ¥å¤±è´¥ç™»å½•æ¬¡æ•°
failed_attempts=$(tail -n 1000 $LOG_FILE | grep "Failed password" | wc -l)

if [ $failed_attempts -gt 10 ]; then
    echo "è­¦å‘Šï¼šæ£€æµ‹åˆ° $failed_attempts æ¬¡SSHç™»å½•å¤±è´¥" | \
    mail -s "SSHå®‰å…¨è­¦å‘Š" $ALERT_EMAIL
fi

# æ£€æŸ¥å¼‚å¸¸IP
suspicious_ips=$(tail -n 1000 $LOG_FILE | grep "Failed password" | \
    awk '{print $(NF-3)}' | sort | uniq -c | sort -nr | head -5)

echo "å¯ç–‘IPç»Ÿè®¡ï¼š" | mail -s "SSHå®‰å…¨æŠ¥å‘Š" $ALERT_EMAIL
echo "$suspicious_ips" | mail -s "SSHå®‰å…¨æŠ¥å‘Š" $ALERT_EMAIL
```

**è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼š**
```bash
# æ·»åŠ åˆ°crontab
crontab -e

# æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
0 * * * * /usr/local/bin/ssh_monitor.sh
```

### 6.3 é›†æˆfail2bané˜²æŠ¤


#### ğŸ›¡ï¸ å®‰è£…å’Œé…ç½®fail2ban


```bash
# å®‰è£…fail2ban
sudo apt update && sudo apt install fail2ban  # Debian/Ubuntu
sudo yum install epel-release && sudo yum install fail2ban  # CentOS

# å¯åŠ¨æœåŠ¡
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

#### ğŸ›¡ï¸ SSHé˜²æŠ¤é…ç½®


```bash
# åˆ›å»ºæœ¬åœ°é…ç½®æ–‡ä»¶
sudo vi /etc/fail2ban/jail.local
```

```ini
[DEFAULT]
# é»˜è®¤ç¦å°æ—¶é—´ï¼ˆç§’ï¼‰
bantime = 3600

# æ£€æŸ¥æ—¶é—´çª—å£ï¼ˆç§’ï¼‰  
findtime = 600

# æœ€å¤§é‡è¯•æ¬¡æ•°
maxretry = 3

# å¿½ç•¥çš„IPï¼ˆç™½åå•ï¼‰
ignoreip = 127.0.0.1/8 192.168.1.0/24

[sshd]
enabled = true
port = 22334
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 7200
```

**é…ç½®å‚æ•°è§£é‡Šï¼š**
- `bantime`ï¼šIPè¢«ç¦å°çš„æ—¶é—´é•¿åº¦
- `findtime`ï¼šç»Ÿè®¡æ—¶é—´çª—å£
- `maxretry`ï¼šæ—¶é—´çª—å£å†…æœ€å¤§å¤±è´¥æ¬¡æ•°
- `ignoreip`ï¼šæ°¸ä¸å°ç¦çš„IPåœ°å€

#### ğŸ›¡ï¸ fail2banç®¡ç†å‘½ä»¤


```bash
# æŸ¥çœ‹çŠ¶æ€
sudo fail2ban-client status sshd

# è§£é™¤IPå°ç¦
sudo fail2ban-client set sshd unbanip 192.168.1.200

# æ‰‹åŠ¨å°ç¦IP
sudo fail2ban-client set sshd banip 192.168.1.200

# é‡æ–°åŠ è½½é…ç½®
sudo fail2ban-client reload
```

---

## 7. ğŸ› ï¸ å®æˆ˜é…ç½®æ¡ˆä¾‹


### 7.1 é«˜å®‰å…¨ç­‰çº§SSHé…ç½®


```bash
# å®Œæ•´çš„é«˜å®‰å…¨SSHé…ç½®ç¤ºä¾‹
# /etc/ssh/sshd_config

# åŸºç¡€å®‰å…¨è®¾ç½®
Port 22334
Protocol 2
ListenAddress 192.168.1.10:22334

# è®¤è¯è®¾ç½®
PubkeyAuthentication yes
PasswordAuthentication no
PermitEmptyPasswords no
PermitRootLogin no
AuthorizedKeysFile .ssh/authorized_keys

# è¿æ¥é™åˆ¶
MaxAuthTries 3
MaxSessions 2
MaxStartups 3:50:5
LoginGraceTime 30

# ä¼šè¯ç®¡ç†
ClientAliveInterval 300
ClientAliveCountMax 2

# ç”¨æˆ·é™åˆ¶
AllowUsers admin@192.168.1.0/24 user@10.0.0.100
DenyUsers guest nobody

# åŠŸèƒ½ç¦ç”¨
X11Forwarding no
AllowTcpForwarding no
GatewayPorts no
PermitTunnel no

# æ—¥å¿—è®°å½•
LogLevel VERBOSE
SyslogFacility AUTHPRIV

# å®‰å…¨æ¨ªå¹…
Banner /etc/ssh/security_banner.txt

# å…¶ä»–å®‰å…¨è®¾ç½®
StrictModes yes
HostbasedAuthentication no
IgnoreRhosts yes
UsePAM yes
```

### 7.2 é…ç½®éªŒè¯ä¸æµ‹è¯•


#### âœ… é…ç½®è¯­æ³•æ£€æŸ¥


```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
sudo sshd -t

# è¯¦ç»†æ£€æŸ¥
sudo sshd -T | head -20

# å¦‚æœæœ‰é”™è¯¯ä¼šæç¤ºå…·ä½“è¡Œå·
```

#### âœ… æ¸è¿›å¼éƒ¨ç½²ç­–ç•¥


```
éƒ¨ç½²æ­¥éª¤å»ºè®®ï¼š

ç¬¬ä¸€æ­¥ï¼šğŸ”§ ä¿®æ”¹ç«¯å£ï¼Œä¿æŒå¤šä¸ªç»ˆç«¯è¿æ¥
ç¬¬äºŒæ­¥ï¼šğŸ”‘ é…ç½®å¯†é’¥è®¤è¯ï¼Œç¡®ä¿æ­£å¸¸å·¥ä½œ
ç¬¬ä¸‰æ­¥ï¼šğŸš« ç¦ç”¨å¯†ç è®¤è¯
ç¬¬å››æ­¥ï¼šğŸ‘¤ ç¦ç”¨rootç™»å½•
ç¬¬äº”æ­¥ï¼šğŸŒ æ·»åŠ IPé™åˆ¶
ç¬¬å…­æ­¥ï¼šğŸ“Š å¯ç”¨è¯¦ç»†æ—¥å¿—
ç¬¬ä¸ƒæ­¥ï¼šğŸ›¡ï¸ é…ç½®fail2ban

æ¯ä¸€æ­¥éƒ½è¦éªŒè¯é…ç½®ç”Ÿæ•ˆä¸”åŠŸèƒ½æ­£å¸¸ï¼
```

#### âœ… è¿æ¥æµ‹è¯•è„šæœ¬


```bash
#!/bin/bash
# SSHè¿æ¥æµ‹è¯•è„šæœ¬

SSH_HOST="192.168.1.10"
SSH_PORT="22334"
SSH_USER="admin"

echo "ğŸ” æµ‹è¯•SSHè¿æ¥..."

# æµ‹è¯•è¿æ¥
if ssh -o ConnectTimeout=10 -p $SSH_PORT $SSH_USER@$SSH_HOST "echo 'Connection successful'"; then
    echo "âœ… SSHè¿æ¥æ­£å¸¸"
else
    echo "âŒ SSHè¿æ¥å¤±è´¥"
    exit 1
fi

echo "ğŸ”‘ æµ‹è¯•å¯†é’¥è®¤è¯..."
ssh -o PreferredAuthentications=publickey -p $SSH_PORT $SSH_USER@$SSH_HOST "whoami"

echo "ğŸš« æµ‹è¯•å¯†ç è®¤è¯ï¼ˆåº”è¯¥å¤±è´¥ï¼‰..."
ssh -o PreferredAuthentications=password -p $SSH_PORT $SSH_USER@$SSH_HOST "whoami" || echo "âœ… å¯†ç è®¤è¯å·²æ­£ç¡®ç¦ç”¨"
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„å®‰å…¨æªæ–½


```
ğŸ”’ è®¤è¯å®‰å…¨ï¼š
â€¢ ç¦ç”¨rootè¿œç¨‹ç™»å½•
â€¢ å¼ºåˆ¶ä½¿ç”¨å¯†é’¥è®¤è¯
â€¢ é™åˆ¶è®¤è¯å°è¯•æ¬¡æ•°
â€¢ è®¾ç½®åˆç†çš„è®¤è¯è¶…æ—¶

ğŸŒ ç½‘ç»œå®‰å…¨ï¼š
â€¢ ä¿®æ”¹é»˜è®¤SSHç«¯å£
â€¢ é™åˆ¶ç›‘å¬åœ°å€
â€¢ é…ç½®IPç™½åå•
â€¢ ä½¿ç”¨é˜²ç«å¢™è§„åˆ™

ğŸ“Š ç›‘æ§å®¡è®¡ï¼š
â€¢ å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•
â€¢ é…ç½®è‡ªåŠ¨åŒ–ç›‘æ§
â€¢ é›†æˆfail2bané˜²æŠ¤
â€¢ å®šæœŸå®¡è®¡æ—¥å¿—

âš™ï¸ é…ç½®ä¼˜åŒ–ï¼š
â€¢ ç¦ç”¨ä¸å¿…è¦åŠŸèƒ½
â€¢ è®¾ç½®ä¼šè¯è¶…æ—¶
â€¢ é…ç½®è­¦å‘Šæ¨ªå¹…
â€¢ å®šæœŸæ›´æ–°é…ç½®
```

### 8.2 å®‰å…¨åŠ å›ºæ£€æŸ¥æ¸…å•


**ğŸ¯ é…ç½®å‰æ£€æŸ¥ï¼š**
- [ ] å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶
- [ ] ä¿æŒç®¡ç†å‘˜ç»ˆç«¯è¿æ¥
- [ ] å‡†å¤‡åº”æ€¥è®¿é—®æ–¹æ¡ˆ
- [ ] ç¡®è®¤ç½‘ç»œè¿æ¥ç¨³å®š

**ğŸ¯ åŸºç¡€å®‰å…¨é…ç½®ï¼š**
- [ ] ä¿®æ”¹SSHç«¯å£åˆ°éæ ‡å‡†ç«¯å£
- [ ] ç¦ç”¨SSHåè®®ç‰ˆæœ¬1
- [ ] ç¦ç”¨rootè¿œç¨‹ç™»å½•
- [ ] é…ç½®å¼ºå¯†ç ç­–ç•¥

**ğŸ¯ è®¤è¯å¼ºåŒ–é…ç½®ï¼š**
- [ ] ç”Ÿæˆå¹¶éƒ¨ç½²SSHå¯†é’¥
- [ ] ç¦ç”¨å¯†ç è®¤è¯
- [ ] é™åˆ¶è®¤è¯å°è¯•æ¬¡æ•°
- [ ] é…ç½®è®¤è¯è¶…æ—¶æ—¶é—´

**ğŸ¯ è®¿é—®æ§åˆ¶é…ç½®ï¼š**
- [ ] è®¾ç½®ç”¨æˆ·è®¿é—®é™åˆ¶
- [ ] é…ç½®IPåœ°å€ç™½åå•
- [ ] é™åˆ¶å¹¶å‘è¿æ¥æ•°
- [ ] é…ç½®ä¼šè¯è¶…æ—¶

**ğŸ¯ ç›‘æ§å®¡è®¡é…ç½®ï¼š**
- [ ] å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•
- [ ] é…ç½®æ—¥å¿—è½®è½¬
- [ ] éƒ¨ç½²fail2bané˜²æŠ¤
- [ ] è®¾ç½®å¼‚å¸¸å‘Šè­¦

### 8.3 å¸¸è§é…ç½®é”™è¯¯é¿å…


**âŒ å±é™©æ“ä½œï¼š**
```
â€¢ ç›´æ¥ç¦ç”¨å¯†ç è®¤è¯è€Œä¸å…ˆæµ‹è¯•å¯†é’¥è®¤è¯
â€¢ ä¿®æ”¹ç«¯å£åå¿˜è®°æ›´æ–°é˜²ç«å¢™è§„åˆ™  
â€¢ é…ç½®IPç™½åå•æ—¶æ’é™¤äº†è‡ªå·±çš„IP
â€¢ è®¾ç½®è¿‡çŸ­çš„è®¤è¯è¶…æ—¶å¯¼è‡´æ­£å¸¸ç”¨æˆ·æ— æ³•ç™»å½•
```

**âœ… å®‰å…¨å®è·µï¼š**
```
â€¢ å§‹ç»ˆä¿æŒä¸€ä¸ªç®¡ç†å‘˜è¿æ¥
â€¢ æ¯æ¬¡ä¿®æ”¹åç«‹å³æµ‹è¯•
â€¢ ä½¿ç”¨é…ç½®ç®¡ç†å·¥å…·æ‰¹é‡éƒ¨ç½²
â€¢ å®šæœŸå®¡æŸ¥å’Œæ›´æ–°å®‰å…¨é…ç½®
```

### 8.4 åº”æ€¥å¤„ç†æ–¹æ¡ˆ


**ğŸš¨ æ— æ³•SSHè¿æ¥æ—¶çš„å¤„ç†ï¼š**

1. **ç‰©ç†è®¿é—®**ï¼šä½¿ç”¨æœåŠ¡å™¨æ§åˆ¶å°ç›´æ¥ç™»å½•
2. **å¸¦å¤–ç®¡ç†**ï¼šé€šè¿‡IPMIã€iLOç­‰ç®¡ç†æ¥å£
3. **æ•‘æ´æ¨¡å¼**ï¼šä½¿ç”¨rescue CDæˆ–USBå¯åŠ¨
4. **äº‘å¹³å°**ï¼šä½¿ç”¨äº‘æœåŠ¡å•†æä¾›çš„æ§åˆ¶å°

**ğŸ”§ æ¢å¤é…ç½®æ­¥éª¤ï¼š**
```bash
# 1. æ¢å¤å¤‡ä»½é…ç½®
sudo cp /etc/ssh/sshd_config.bak /etc/ssh/sshd_config

# 2. é‡å¯SSHæœåŠ¡
sudo systemctl restart sshd

# 3. æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status sshd

# 4. é‡æ–°è¿›è¡Œé…ç½®
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹ï¼š**
- SSHå®‰å…¨åŠ å›ºæ˜¯ç³»ç»Ÿå®‰å…¨çš„ç¬¬ä¸€é“é˜²çº¿
- è®¤è¯å¼ºåŒ–å’Œè®¿é—®æ§åˆ¶æ˜¯æ ¸å¿ƒæªæ–½
- ç›‘æ§å®¡è®¡èƒ½åŠæ—¶å‘ç°å®‰å…¨å¨èƒ
- æ¸è¿›å¼é…ç½®å’Œå……åˆ†æµ‹è¯•é¿å…æ„å¤–
- å‡†å¤‡åº”æ€¥æ–¹æ¡ˆåº”å¯¹é…ç½®é”™è¯¯