---
title: 13ã€æ—¥å¿—ç®¡ç†ä¸ç›‘æ§é…ç½®
---
## ğŸ“š ç›®å½•

1. [æ—¥å¿—ç®¡ç†åŸºç¡€æ¦‚å¿µ](#1-æ—¥å¿—ç®¡ç†åŸºç¡€æ¦‚å¿µ)
2. [è®¿é—®æ—¥å¿—æ ¼å¼å®šåˆ¶](#2-è®¿é—®æ—¥å¿—æ ¼å¼å®šåˆ¶)
3. [é”™è¯¯æ—¥å¿—çº§åˆ«è®¾ç½®](#3-é”™è¯¯æ—¥å¿—çº§åˆ«è®¾ç½®)
4. [æ—¥å¿—è½®è½¬é…ç½®](#4-æ—¥å¿—è½®è½¬é…ç½®)
5. [æ—¥å¿—åˆ†æå·¥å…·åº”ç”¨](#5-æ—¥å¿—åˆ†æå·¥å…·åº”ç”¨)
6. [å®æ—¶ç›‘æ§é…ç½®](#6-å®æ—¶ç›‘æ§é…ç½®)
7. [æ€§èƒ½æŒ‡æ ‡é‡‡é›†](#7-æ€§èƒ½æŒ‡æ ‡é‡‡é›†)
8. [å‘Šè­¦é…ç½®ä½“ç³»](#8-å‘Šè­¦é…ç½®ä½“ç³»)
9. [æ—¥å¿—é›†ä¸­åŒ–ç®¡ç†](#9-æ—¥å¿—é›†ä¸­åŒ–ç®¡ç†)
10. [å®‰å…¨å®¡è®¡æ—¥å¿—](#10-å®‰å…¨å®¡è®¡æ—¥å¿—)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“Š æ—¥å¿—ç®¡ç†åŸºç¡€æ¦‚å¿µ


### 1.1 æ—¥å¿—ç®¡ç†çš„æœ¬è´¨ä¸ä»·å€¼


**ğŸ’¡ ä»€ä¹ˆæ˜¯æ—¥å¿—ç®¡ç†**

> æ—¥å¿—ç®¡ç†å°±åƒæ˜¯ç»™WebæœåŠ¡å™¨å®‰è£…ä¸€ä¸ª"é»‘åŒ£å­"ï¼Œè®°å½•ä¸‹æ‰€æœ‰é‡è¦çš„è¿è¡Œä¿¡æ¯ã€‚å°±åƒé£æœºçš„é»‘åŒ£å­èƒ½å¸®åŠ©åˆ†æäº‹æ•…åŸå› ä¸€æ ·ï¼ŒæœåŠ¡å™¨æ—¥å¿—èƒ½å¸®æˆ‘ä»¬äº†è§£ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ã€å‘ç°é—®é¢˜ã€ä¼˜åŒ–æ€§èƒ½ã€‚

**ğŸ¯ æ—¥å¿—ç®¡ç†çš„æ ¸å¿ƒä»·å€¼**

```
æ—¥å¿—ç®¡ç†ä»·å€¼é“¾ï¼š

ç”¨æˆ·è®¿é—® â†’ æœåŠ¡å™¨å¤„ç† â†’ äº§ç”Ÿæ—¥å¿— â†’ åˆ†ææ—¥å¿— â†’ å‘ç°é—®é¢˜/ä¼˜åŒ–
    â†“           â†“          â†“         â†“         â†“
  çœŸå®è¡Œä¸º     ç³»ç»Ÿå“åº”    æ•°æ®è®°å½•   æ·±åº¦æ´å¯Ÿ   æŒç»­æ”¹è¿›
```

| **ä½œç”¨ç±»åˆ«** | **å…·ä½“ä»·å€¼** | **å®é™…æ•ˆæœ** |
|-------------|-------------|-------------|
| **ğŸ” é—®é¢˜è¯Šæ–­** | `å¿«é€Ÿå®šä½æ•…éšœåŸå› ` | `ä»å‡ å°æ—¶ç¼©çŸ­åˆ°å‡ åˆ†é’Ÿæ‰¾åˆ°é—®é¢˜` |
| **ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–** | `è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ` | `å‘ç°æ…¢æŸ¥è¯¢ã€èµ„æºå ç”¨å¼‚å¸¸` |
| **ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤** | `æ£€æµ‹å¼‚å¸¸è®¿é—®` | `åŠæ—¶å‘ç°æ”»å‡»è¡Œä¸ºå’Œå…¥ä¾µå°è¯•` |
| **ğŸ“Š ä¸šåŠ¡åˆ†æ** | `äº†è§£ç”¨æˆ·è¡Œä¸º` | `åˆ†æè®¿é—®æ¨¡å¼ã€çƒ­é—¨å†…å®¹` |
| **âš–ï¸ åˆè§„å®¡è®¡** | `æ»¡è¶³æ³•è§„è¦æ±‚` | `æä¾›æ“ä½œè®°å½•å’Œè´£ä»»è¿½æº¯` |

### 1.2 WebæœåŠ¡å™¨æ—¥å¿—åˆ†ç±»ä½“ç³»


**ğŸ“‹ æ—¥å¿—ç±»å‹å…¨æ™¯å›¾**

```
WebæœåŠ¡å™¨æ—¥å¿—åˆ†ç±»ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                WebæœåŠ¡å™¨æ—¥å¿—                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    è®¿é—®æ—¥å¿—      â”‚    é”™è¯¯æ—¥å¿—      â”‚   ç³»ç»Ÿæ—¥å¿—   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚â€¢ è®¿é—®è®°å½•       â”‚â€¢ é”™è¯¯ä¿¡æ¯       â”‚â€¢ æœåŠ¡çŠ¶æ€   â”‚
â”‚â€¢ å“åº”çŠ¶æ€       â”‚â€¢ è­¦å‘Šä¿¡æ¯       â”‚â€¢ èµ„æºä½¿ç”¨   â”‚
â”‚â€¢ è¯·æ±‚æ—¶é—´       â”‚â€¢ è°ƒè¯•ä¿¡æ¯       â”‚â€¢ å¯åŠ¨åœæ­¢   â”‚
â”‚â€¢ å®¢æˆ·ç«¯ä¿¡æ¯     â”‚â€¢ å´©æºƒæ—¥å¿—       â”‚â€¢ é…ç½®å˜æ›´   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ è®¿é—®æ—¥å¿— (Access Log)**
- **ä½œç”¨**ï¼šè®°å½•æ¯ä¸€ä¸ªåˆ°è¾¾æœåŠ¡å™¨çš„HTTPè¯·æ±‚
- **å†…å®¹**ï¼šå®¢æˆ·ç«¯IPã€è¯·æ±‚æ—¶é—´ã€è¯·æ±‚æ–¹æ³•ã€URLã€å“åº”çŠ¶æ€ç ã€æ•°æ®å¤§å°ç­‰
- **ç”¨é€”**ï¼šåˆ†æè®¿é—®æ¨¡å¼ã€ç›‘æ§æµé‡ã€ç»Ÿè®¡çƒ­é—¨é¡µé¢

**ğŸ”¸ é”™è¯¯æ—¥å¿— (Error Log)**
- **ä½œç”¨**ï¼šè®°å½•æœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­çš„é”™è¯¯å’Œå¼‚å¸¸
- **å†…å®¹**ï¼šé”™è¯¯çº§åˆ«ã€å‘ç”Ÿæ—¶é—´ã€é”™è¯¯æè¿°ã€å½±å“æ¨¡å—
- **ç”¨é€”**ï¼šæ•…éšœè¯Šæ–­ã€ç³»ç»Ÿè°ƒä¼˜ã€é¢„é˜²æ€§ç»´æŠ¤

**ğŸ”¸ ç³»ç»Ÿæ—¥å¿— (System Log)**
- **ä½œç”¨**ï¼šè®°å½•æœåŠ¡å™¨ç³»ç»Ÿçº§åˆ«çš„è¿è¡Œä¿¡æ¯
- **å†…å®¹**ï¼šæœåŠ¡å¯åœã€é…ç½®åŠ è½½ã€èµ„æºçŠ¶æ€ã€æ€§èƒ½æŒ‡æ ‡
- **ç”¨é€”**ï¼šç³»ç»Ÿç›‘æ§ã€å®¹é‡è§„åˆ’ã€æ€§èƒ½ä¼˜åŒ–

### 1.3 æ—¥å¿—ç®¡ç†çš„æŒ‘æˆ˜ä¸è§£å†³æ€è·¯


**âš ï¸ å¸¸è§æŒ‘æˆ˜**

```
æ—¥å¿—ç®¡ç†é¢ä¸´çš„æŒ‘æˆ˜ï¼š

æ•°æ®é‡å¤§ â†’ å­˜å‚¨å‹åŠ› â†’ æŸ¥è¯¢ç¼“æ…¢ â†’ åˆ†æå›°éš¾
    â†“         â†“         â†“         â†“
æ—¥å¿—è½®è½¬   å‹ç¼©å½’æ¡£   ç´¢å¼•ä¼˜åŒ–   å·¥å…·è¾…åŠ©
```

| **æŒ‘æˆ˜** | **å½±å“** | **è§£å†³æ€è·¯** |
|---------|---------|-------------|
| **ğŸ“ˆ æ•°æ®é‡æ¿€å¢** | `å­˜å‚¨ç©ºé—´ä¸è¶³` | `æ—¥å¿—è½®è½¬ + å‹ç¼© + å½’æ¡£` |
| **ğŸ” æŸ¥è¯¢æ•ˆç‡ä½** | `é—®é¢˜å®šä½æ…¢` | `ç»“æ„åŒ–å­˜å‚¨ + ç´¢å¼•` |
| **ğŸ¯ ä¿¡æ¯åˆ†æ•£** | `åˆ†æå¤æ‚` | `é›†ä¸­åŒ–ç®¡ç† + ç»Ÿä¸€æ ¼å¼` |
| **â° å®æ—¶æ€§è¦æ±‚** | `å“åº”ä¸åŠæ—¶` | `å®æ—¶ç›‘æ§ + è‡ªåŠ¨å‘Šè­¦` |

---

## 2. ğŸ“ è®¿é—®æ—¥å¿—æ ¼å¼å®šåˆ¶


### 2.1 è®¿é—®æ—¥å¿—çš„æ ¸å¿ƒä½œç”¨


**ğŸ¯ è®¿é—®æ—¥å¿—å°±åƒç½‘ç«™çš„"è®¿å®¢è®°å½•æœ¬"**

æƒ³è±¡ä½ ç»è¥ä¸€å®¶å•†åº—ï¼Œè®¿é—®æ—¥å¿—å°±åƒæ˜¯é—¨å£çš„è®¿å®¢ç™»è®°å†Œã€‚æ¯å½“æœ‰é¡¾å®¢è¿›åº—ï¼Œç™»è®°å†Œéƒ½ä¼šè®°å½•ï¼š
- é¡¾å®¢ä»€ä¹ˆæ—¶å€™æ¥çš„
- ä»å“ªé‡Œæ¥çš„
- åœ¨åº—é‡Œå¾…äº†å¤šä¹…
- ä¹°äº†ä»€ä¹ˆä¸œè¥¿
- æ˜¯å¦æ»¡æ„ï¼ˆæœ‰æ²¡æœ‰æŠ•è¯‰ï¼‰

WebæœåŠ¡å™¨çš„è®¿é—®æ—¥å¿—ä½œç”¨å®Œå…¨ä¸€æ ·ï¼Œè®°å½•æ¯ä¸ªç”¨æˆ·çš„è®¿é—®è¯¦æƒ…ã€‚

### 2.2 Apacheè®¿é—®æ—¥å¿—æ ¼å¼é…ç½®


**ğŸ”§ Apacheæ—¥å¿—æ ¼å¼çš„çµæ´»å®šåˆ¶**

Apacheä½¿ç”¨`LogFormat`æŒ‡ä»¤æ¥å®šä¹‰æ—¥å¿—æ ¼å¼ï¼Œå°±åƒè®¾è®¡ä¸€ä¸ªè¡¨æ ¼çš„åˆ—æ ‡é¢˜ã€‚

```apache
# åœ¨httpd.confæˆ–è™šæ‹Ÿä¸»æœºé…ç½®ä¸­
# åŸºç¡€æ ¼å¼ - è®°å½•æœ€åŸºæœ¬çš„è®¿é—®ä¿¡æ¯
LogFormat "%h %l %u %t \"%r\" %>s %O" common

# è¯¦ç»†æ ¼å¼ - åŒ…å«æ›´å¤šæœ‰ç”¨ä¿¡æ¯
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" combined

# è‡ªå®šä¹‰æ ¼å¼ - æ ¹æ®éœ€è¦æ·»åŠ ç‰¹å®šå­—æ®µ
LogFormat "%{X-Forwarded-For}i %h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D" custom
```

**ğŸ“Š æ—¥å¿—æ ¼å¼å˜é‡è¯´æ˜**

| **å˜é‡** | **å«ä¹‰** | **ä½œç”¨** | **ç¤ºä¾‹å€¼** |
|---------|---------|---------|-----------|
| `%h` | å®¢æˆ·ç«¯IPåœ°å€ | è¯†åˆ«è®¿é—®æ¥æº | `192.168.1.100` |
| `%l` | è¿œç¨‹ç”¨æˆ·æ ‡è¯† | ç”¨æˆ·è¯†åˆ«ï¼ˆé€šå¸¸ä¸º-ï¼‰ | `-` |
| `%u` | è®¤è¯ç”¨æˆ·å | å·²è®¤è¯ç”¨æˆ· | `admin` æˆ– `-` |
| `%t` | è¯·æ±‚æ—¶é—´ | è®¿é—®æ—¶é—´æˆ³ | `[25/Dec/2023:10:00:00 +0800]` |
| `%r` | è¯·æ±‚è¡Œ | å®Œæ•´HTTPè¯·æ±‚ | `GET /index.html HTTP/1.1` |
| `%s` | å“åº”çŠ¶æ€ç  | è¯·æ±‚å¤„ç†ç»“æœ | `200`, `404`, `500` |
| `%O` | å‘é€å­—èŠ‚æ•° | å“åº”æ•°æ®å¤§å° | `2048` |
| `%{Referer}i` | æ¥æºé¡µé¢ | ç”¨æˆ·ä»å“ªä¸ªé¡µé¢æ¥ | `https://google.com` |
| `%{User-Agent}i` | ç”¨æˆ·ä»£ç† | æµè§ˆå™¨ç±»å‹ | `Mozilla/5.0...` |
| `%D` | å¤„ç†æ—¶é—´ | å“åº”è€—æ—¶ï¼ˆå¾®ç§’ï¼‰ | `50000` |

**ğŸ’¡ å®é™…é…ç½®ç¤ºä¾‹**

```apache
# ä¸ºä¸åŒéœ€æ±‚å®šåˆ¶ä¸åŒçš„æ—¥å¿—æ ¼å¼

# 1. æ€§èƒ½ç›‘æ§æ ¼å¼ - é‡ç‚¹å…³æ³¨å“åº”æ—¶é—´
LogFormat "%h %t \"%r\" %>s %O %D \"%{Referer}i\"" performance

# 2. å®‰å…¨å®¡è®¡æ ¼å¼ - é‡ç‚¹å…³æ³¨å®‰å…¨ç›¸å…³ä¿¡æ¯
LogFormat "%{X-Forwarded-For}i %h %u %t \"%r\" %>s \"%{User-Agent}i\" \"%{Cookie}i\"" security

# 3. è¥é”€åˆ†ææ ¼å¼ - é‡ç‚¹å…³æ³¨ç”¨æˆ·è¡Œä¸º
LogFormat "%h %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" \"%{Accept-Language}i\"" marketing

# åº”ç”¨åˆ°è™šæ‹Ÿä¸»æœº
<VirtualHost *:80>
    DocumentRoot /var/www/html
    CustomLog /var/log/apache2/access.log combined
    ErrorLog /var/log/apache2/error.log
</VirtualHost>
```

### 2.3 Nginxè®¿é—®æ—¥å¿—æ ¼å¼é…ç½®


**ğŸ”§ Nginxæ—¥å¿—æ ¼å¼çš„ç²¾ç¡®æ§åˆ¶**

Nginxä½¿ç”¨`log_format`æŒ‡ä»¤å®šä¹‰æ—¥å¿—æ ¼å¼ï¼Œè¯­æ³•æ›´åŠ ç›´è§‚ã€‚

```nginx
# åœ¨nginx.confçš„httpå—ä¸­å®šä¹‰æ—¥å¿—æ ¼å¼

# åŸºç¡€æ ¼å¼
log_format basic '$remote_addr - $remote_user [$time_local] '
                '"$request" $status $body_bytes_sent';

# è¯¦ç»†æ ¼å¼ - åŒ…å«æ›´å¤šåˆ†æç»´åº¦
log_format detailed '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   '$request_time $upstream_response_time';

# JSONæ ¼å¼ - ä¾¿äºç¨‹åºå¤„ç†
log_format json '{"timestamp":"$time_iso8601",'
                '"remote_addr":"$remote_addr",'
                '"method":"$request_method",'
                '"uri":"$uri",'
                '"status":$status,'
                '"body_bytes_sent":$body_bytes_sent,'
                '"request_time":$request_time,'
                '"referer":"$http_referer",'
                '"user_agent":"$http_user_agent"}';
```

**ğŸ“‹ Nginxå¸¸ç”¨æ—¥å¿—å˜é‡**

| **å˜é‡** | **è¯´æ˜** | **ç”¨é€”** |
|---------|---------|---------|
| `$remote_addr` | å®¢æˆ·ç«¯çœŸå®IP | è®¿é—®æ¥æºåˆ†æ |
| `$time_local` | æœ¬åœ°æ—¶é—´ | æ—¶é—´ç»Ÿè®¡ |
| `$request` | å®Œæ•´è¯·æ±‚è¡Œ | è¯·æ±‚åˆ†æ |
| `$status` | HTTPçŠ¶æ€ç  | æˆåŠŸç‡ç»Ÿè®¡ |
| `$body_bytes_sent` | å‘é€ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•° | æµé‡ç»Ÿè®¡ |
| `$request_time` | è¯·æ±‚å¤„ç†æ€»æ—¶é—´ | æ€§èƒ½åˆ†æ |
| `$upstream_response_time` | åç«¯å“åº”æ—¶é—´ | åç«¯æ€§èƒ½ç›‘æ§ |
| `$http_x_forwarded_for` | ä»£ç†é“¾IP | çœŸå®IPè·å– |

**ğŸ¯ å®é™…åº”ç”¨é…ç½®**

```nginx
http {
    # å®šä¹‰å¤šç§æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for"';
    
    log_format performance '$time_local $remote_addr $request_time $upstream_response_time '
                          '$status "$request" $body_bytes_sent';
    
    server {
        listen 80;
        server_name example.com;
        
        # ä½¿ç”¨ä¸åŒæ ¼å¼è®°å½•åˆ°ä¸åŒæ–‡ä»¶
        access_log /var/log/nginx/access.log main;
        access_log /var/log/nginx/performance.log performance;
        
        location / {
            root /var/www/html;
            index index.html;
        }
    }
}
```

### 2.4 æ—¥å¿—æ ¼å¼ä¼˜åŒ–å»ºè®®


**ğŸ† æœ€ä½³å®è·µæŒ‡å¯¼**

> **âš ï¸ æ³¨æ„äº‹é¡¹**
> 
> æ—¥å¿—æ ¼å¼è®¾è®¡è¦å¹³è¡¡**è¯¦ç»†ç¨‹åº¦**å’Œ**æ€§èƒ½å½±å“**ã€‚è®°å½•è¿‡å¤šä¿¡æ¯ä¼šå½±å“æœåŠ¡å™¨æ€§èƒ½ï¼Œè®°å½•è¿‡å°‘ä¿¡æ¯ä¼šå½±å“é—®é¢˜åˆ†æã€‚

**ğŸ“Š å­—æ®µé€‰æ‹©åŸåˆ™**

| **å¿…é¡»è®°å½•** | **å»ºè®®è®°å½•** | **å¯é€‰è®°å½•** |
|-------------|-------------|-------------|
| `IPåœ°å€` | `å“åº”æ—¶é—´` | `Cookieä¿¡æ¯` |
| `è®¿é—®æ—¶é—´` | `User-Agent` | `è¯·æ±‚å¤´è¯¦æƒ…` |
| `è¯·æ±‚URL` | `Referer` | `åœ°ç†ä½ç½®` |
| `çŠ¶æ€ç ` | `æ•°æ®å¤§å°` | `è®¾å¤‡ä¿¡æ¯` |

---

## 3. âš ï¸ é”™è¯¯æ—¥å¿—çº§åˆ«è®¾ç½®


### 3.1 é”™è¯¯æ—¥å¿—çš„é‡è¦æ€§


**ğŸš¨ é”™è¯¯æ—¥å¿—æ˜¯æœåŠ¡å™¨çš„"å¥åº·æ£€æŸ¥æŠ¥å‘Š"**

å¦‚æœæŠŠWebæœåŠ¡å™¨æ¯”ä½œä¸€ä¸ªäººï¼Œé”™è¯¯æ—¥å¿—å°±åƒæ˜¯è¿™ä¸ªäººçš„å¥åº·æ£€æŸ¥æŠ¥å‘Šã€‚ä¸åŒçº§åˆ«çš„é”™è¯¯å°±åƒä¸åŒä¸¥é‡ç¨‹åº¦çš„å¥åº·é—®é¢˜ï¼š
- **Emergency**ï¼šç”Ÿå‘½å±é™©ï¼Œéœ€è¦ç«‹å³æŠ¢æ•‘
- **Critical**ï¼šé‡ç—…ï¼Œéœ€è¦ç´§æ€¥æ²»ç–—  
- **Error**ï¼šæ˜æ˜¾ç–¾ç—…ï¼Œéœ€è¦åŠæ—¶å¤„ç†
- **Warning**ï¼šäºšå¥åº·çŠ¶æ€ï¼Œéœ€è¦æ³¨æ„
- **Notice**ï¼šæ­£å¸¸ä½†éœ€è¦å…³æ³¨çš„æŒ‡æ ‡
- **Info**ï¼šä¸€èˆ¬å¥åº·ä¿¡æ¯
- **Debug**ï¼šè¯¦ç»†ä½“æ£€æ•°æ®

### 3.2 Apacheé”™è¯¯æ—¥å¿—çº§åˆ«é…ç½®


**ğŸ”§ Apacheé”™è¯¯æ—¥å¿—çº§åˆ«ä½“ç³»**

```apache
# åœ¨httpd.confæˆ–è™šæ‹Ÿä¸»æœºé…ç½®ä¸­è®¾ç½®é”™è¯¯æ—¥å¿—çº§åˆ«
LogLevel warn

# ä¸åŒçº§åˆ«çš„å«ä¹‰å’Œé€‚ç”¨åœºæ™¯
# emerg   - ç³»ç»Ÿæ— æ³•ä½¿ç”¨ï¼ˆæœ€ä¸¥é‡ï¼‰
# alert   - éœ€è¦ç«‹å³é‡‡å–è¡ŒåŠ¨
# crit    - å…³é”®é”™è¯¯æ¡ä»¶
# error   - é”™è¯¯æ¡ä»¶ï¼ˆé»˜è®¤çº§åˆ«ï¼‰
# warn    - è­¦å‘Šæ¡ä»¶
# notice  - æ­£å¸¸ä½†é‡è¦çš„æ¡ä»¶
# info    - ä¿¡æ¯æ€§æ¶ˆæ¯
# debug   - è°ƒè¯•çº§åˆ«ä¿¡æ¯ï¼ˆæœ€è¯¦ç»†ï¼‰
```

**ğŸ“Š Apacheæ—¥å¿—çº§åˆ«è¯¦è§£**

| **çº§åˆ«** | **æ•°å€¼** | **å«ä¹‰** | **å…¸å‹åœºæ™¯** | **æ˜¯å¦éœ€è¦ç«‹å³å¤„ç†** |
|---------|---------|---------|-------------|-------------------|
| **emerg** | `0` | ç³»ç»Ÿå´©æºƒ | æœåŠ¡å™¨æ— æ³•å¯åŠ¨ | âœ… ç«‹å³ |
| **alert** | `1` | éœ€è¦ç«‹å³è¡ŒåŠ¨ | æ•°æ®åº“è¿æ¥å®Œå…¨å¤±è´¥ | âœ… ç«‹å³ |
| **crit** | `2` | ä¸¥é‡é”™è¯¯ | ç£ç›˜ç©ºé—´è€—å°½ | âœ… ç´§æ€¥ |
| **error** | `3` | ä¸€èˆ¬é”™è¯¯ | 404é¡µé¢ã€è„šæœ¬é”™è¯¯ | ğŸŸ¡ åŠæ—¶ |
| **warn** | `4` | è­¦å‘Šä¿¡æ¯ | é…ç½®é—®é¢˜ã€æ€§èƒ½é—®é¢˜ | ğŸŸ¡ å…³æ³¨ |
| **notice** | `5` | æ­£å¸¸ä½†é‡è¦ | æœåŠ¡é‡å¯ã€é…ç½®é‡è½½ | ğŸŸ¢ äº†è§£ |
| **info** | `6` | ä¿¡æ¯æ¶ˆæ¯ | è¿æ¥å»ºç«‹ã€è¯·æ±‚å¤„ç† | ğŸŸ¢ å¯é€‰ |
| **debug** | `7` | è°ƒè¯•ä¿¡æ¯ | è¯¦ç»†çš„å¤„ç†è¿‡ç¨‹ | ğŸŸ¢ å¼€å‘ç”¨ |

**ğŸ’¡ ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®**

```apache
# ç”Ÿäº§ç¯å¢ƒé€šå¸¸ä½¿ç”¨warnçº§åˆ«ï¼Œå¹³è¡¡ä¿¡æ¯è¯¦ç»†åº¦å’Œæ—¥å¿—é‡
LogLevel warn

# å¼€å‘ç¯å¢ƒå¯ä»¥ä½¿ç”¨æ›´è¯¦ç»†çš„çº§åˆ«
LogLevel info

# è°ƒè¯•ç‰¹å®šé—®é¢˜æ—¶ä¸´æ—¶è°ƒæ•´
LogLevel debug

# é’ˆå¯¹ç‰¹å®šæ¨¡å—è®¾ç½®ä¸åŒçº§åˆ«
LogLevel warn ssl:info rewrite:trace1
```

### 3.3 Nginxé”™è¯¯æ—¥å¿—çº§åˆ«é…ç½®


**ğŸ”§ Nginxé”™è¯¯æ—¥å¿—çš„ç²¾ç»†æ§åˆ¶**

```nginx
# å…¨å±€é”™è¯¯æ—¥å¿—é…ç½®ï¼ˆåœ¨mainé…ç½®å—ï¼‰
error_log /var/log/nginx/error.log warn;

# è™šæ‹Ÿä¸»æœºçº§åˆ«çš„é”™è¯¯æ—¥å¿—ï¼ˆåœ¨serveré…ç½®å—ï¼‰
server {
    listen 80;
    server_name example.com;
    error_log /var/log/nginx/example_error.log error;
    
    location / {
        root /var/www/html;
        # ä½ç½®çº§åˆ«çš„é”™è¯¯æ—¥å¿—é…ç½®
        error_log /var/log/nginx/specific_error.log debug;
    }
}
```

**ğŸ“‹ Nginxé”™è¯¯æ—¥å¿—çº§åˆ«è¯´æ˜**

| **çº§åˆ«** | **å«ä¹‰** | **è®°å½•å†…å®¹** | **ä½¿ç”¨å»ºè®®** |
|---------|---------|-------------|-------------|
| **debug** | è°ƒè¯•ä¿¡æ¯ | è¯¦ç»†çš„è¯·æ±‚å¤„ç†è¿‡ç¨‹ | ä»…å¼€å‘è°ƒè¯•æ—¶ä½¿ç”¨ |
| **info** | ä¿¡æ¯æ¶ˆæ¯ | ä¸€èˆ¬æ€§æ“ä½œä¿¡æ¯ | å¼€å‘ç¯å¢ƒå¯é€‰ |
| **notice** | æ³¨æ„æ¶ˆæ¯ | é‡è¦ä½†æ­£å¸¸çš„äº‹ä»¶ | ç”Ÿäº§ç¯å¢ƒå¯é€‰ |
| **warn** | è­¦å‘Šæ¶ˆæ¯ | æ½œåœ¨é—®é¢˜ | **ç”Ÿäº§ç¯å¢ƒæ¨è** |
| **error** | é”™è¯¯æ¶ˆæ¯ | å¤„ç†å¤±è´¥çš„è¯·æ±‚ | ç”Ÿäº§ç¯å¢ƒå¿…é¡» |
| **crit** | ä¸¥é‡é”™è¯¯ | ä¸¥é‡çš„ç³»ç»Ÿé”™è¯¯ | å¿…é¡»ç›‘æ§ |
| **alert** | è­¦æŠ¥æ¶ˆæ¯ | éœ€è¦ç«‹å³å¤„ç† | å¿…é¡»ç›‘æ§ |
| **emerg** | ç´§æ€¥æ¶ˆæ¯ | ç³»ç»Ÿä¸å¯ç”¨ | å¿…é¡»ç›‘æ§ |

### 3.4 é”™è¯¯æ—¥å¿—é…ç½®æœ€ä½³å®è·µ


**ğŸ† ç”Ÿäº§ç¯å¢ƒé…ç½®å»ºè®®**

```bash
# 1. æ ¹æ®ç¯å¢ƒé€‰æ‹©åˆé€‚çš„æ—¥å¿—çº§åˆ«

# ç”Ÿäº§ç¯å¢ƒ - å¹³è¡¡æ€§èƒ½å’Œé—®é¢˜è¯Šæ–­
error_log /var/log/nginx/error.log warn;

# æµ‹è¯•ç¯å¢ƒ - æ›´å¤šä¿¡æ¯ç”¨äºé—®é¢˜å‘ç°
error_log /var/log/nginx/error.log info;

# å¼€å‘ç¯å¢ƒ - è¯¦ç»†ä¿¡æ¯ç”¨äºè°ƒè¯•
error_log /var/log/nginx/error.log debug;
```

**ğŸ“Š ä¸åŒåœºæ™¯çš„çº§åˆ«é€‰æ‹©ç­–ç•¥**

| **ç¯å¢ƒç±»å‹** | **æ¨èçº§åˆ«** | **åŸå› ** | **æƒè¡¡è€ƒè™‘** |
|-------------|-------------|---------|-------------|
| **ç”Ÿäº§ç¯å¢ƒ** | `warn` | åŠæ—¶å‘ç°é—®é¢˜ï¼Œä¸äº§ç”Ÿè¿‡å¤šæ—¥å¿— | æ€§èƒ½ vs ä¿¡æ¯å®Œæ•´æ€§ |
| **æµ‹è¯•ç¯å¢ƒ** | `info` | æ›´å…¨é¢çš„æµ‹è¯•ä¿¡æ¯ | å­˜å‚¨ vs æµ‹è¯•è¦†ç›– |
| **å¼€å‘ç¯å¢ƒ** | `debug` | è¯¦ç»†è°ƒè¯•ä¿¡æ¯ | ç£ç›˜ç©ºé—´ vs è°ƒè¯•æ•ˆç‡ |
| **é—®é¢˜æ’æŸ¥** | `debug` | ä¸´æ—¶æå‡è·å–è¯¦ç»†ä¿¡æ¯ | ä¸´æ—¶æ€§èƒ½å½±å“ |

---

## 4. ğŸ”„ æ—¥å¿—è½®è½¬é…ç½®


### 4.1 æ—¥å¿—è½®è½¬çš„å¿…è¦æ€§


**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦æ—¥å¿—è½®è½¬**

æƒ³è±¡ä½ çš„æ—¥è®°æœ¬ï¼Œå¦‚æœä¸€ç›´å¾€åŒä¸€ä¸ªæœ¬å­é‡Œå†™ï¼Œæ€»æœ‰ä¸€å¤©ä¼šå†™æ»¡ã€‚æ—¥å¿—è½®è½¬å°±åƒæ˜¯å®šæœŸæ¢æ–°çš„æ—¥è®°æœ¬ï¼ŒæŠŠæ—§çš„æ—¥è®°æœ¬æ•´ç†ä¿å­˜èµ·æ¥ã€‚

```
æ—¥å¿—è½®è½¬çš„ä»·å€¼ï¼š

å•ä¸€æ—¥å¿—æ–‡ä»¶ â†’ æ— é™å¢é•¿ â†’ ç£ç›˜ç©ºé—´è€—å°½ â†’ ç³»ç»Ÿæ•…éšœ
     â†“            â†“           â†“            â†“
   æ–‡ä»¶å·¨å¤§     æŸ¥æ‰¾å›°éš¾    å¤‡ä»½å›°éš¾      ç»´æŠ¤å›°éš¾

æ—¥å¿—è½®è½¬è§£å†³æ–¹æ¡ˆï¼š
å®šæœŸåˆ‡åˆ† â†’ å‹ç¼©å½’æ¡£ â†’ æ¸…ç†è¿‡æœŸ â†’ ä¿æŒç³»ç»Ÿå¥åº·
```

**ğŸ¯ æ—¥å¿—è½®è½¬çš„æ ¸å¿ƒä½œç”¨**

| **é—®é¢˜** | **æ—¥å¿—è½®è½¬çš„è§£å†³æ–¹æ¡ˆ** | **å®é™…æ•ˆæœ** |
|---------|---------------------|-------------|
| **ğŸ’¾ ç£ç›˜ç©ºé—´** | å®šæœŸæ¸…ç†æ—§æ—¥å¿— | æ§åˆ¶æ—¥å¿—å ç”¨ç©ºé—´åœ¨åˆç†èŒƒå›´ |
| **ğŸ” æŸ¥æ‰¾æ•ˆç‡** | æŒ‰æ—¶é—´åˆ†å‰²æ–‡ä»¶ | å¿«é€Ÿå®šä½ç‰¹å®šæ—¶é—´æ®µçš„æ—¥å¿— |
| **ğŸ“¦ å¤‡ä»½ç®¡ç†** | å‹ç¼©å†å²æ–‡ä»¶ | èŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œä¾¿äºé•¿æœŸä¿å­˜ |
| **âš¡ å¤„ç†æ€§èƒ½** | ä¿æŒæ–‡ä»¶å¤§å°é€‚ä¸­ | é¿å…å•ä¸ªæ–‡ä»¶è¿‡å¤§å½±å“å¤„ç†é€Ÿåº¦ |

### 4.2 logrotateåŸºç¡€é…ç½®


**ğŸ”§ logrotateçš„å·¥ä½œåŸç†**

logrotateæ˜¯Linuxç³»ç»Ÿè‡ªå¸¦çš„æ—¥å¿—è½®è½¬å·¥å…·ï¼Œé€šè¿‡cronå®šæ—¶ä»»åŠ¡è‡ªåŠ¨è¿è¡Œã€‚

```bash
# logrotateé…ç½®æ–‡ä»¶ä½ç½®
/etc/logrotate.conf          # ä¸»é…ç½®æ–‡ä»¶
/etc/logrotate.d/            # å„ä¸ªæœåŠ¡çš„é…ç½®ç›®å½•

# æŸ¥çœ‹logrotateé…ç½®
cat /etc/logrotate.conf

# æ‰‹åŠ¨æ‰§è¡Œæ—¥å¿—è½®è½¬ï¼ˆæµ‹è¯•é…ç½®ï¼‰
logrotate -f /etc/logrotate.d/nginx

# æŸ¥çœ‹è½®è½¬çŠ¶æ€
cat /var/lib/logrotate/status
```

**ğŸ“ åŸºç¡€é…ç½®è¯­æ³•**

```bash
# /etc/logrotate.d/nginx
/var/log/nginx/*.log {
    daily                    # æ¯å¤©è½®è½¬
    missingok               # å¦‚æœæ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¸æŠ¥é”™
    rotate 30               # ä¿ç•™30ä¸ªè½®è½¬åçš„æ–‡ä»¶
    compress                # å‹ç¼©è½®è½¬åçš„æ–‡ä»¶
    delaycompress          # å»¶è¿Ÿå‹ç¼©ï¼Œä¸‹æ¬¡è½®è½¬æ—¶æ‰å‹ç¼©
    notifempty             # ç©ºæ–‡ä»¶ä¸è½®è½¬
    create 0644 nginx nginx # åˆ›å»ºæ–°æ–‡ä»¶çš„æƒé™å’Œæ‰€æœ‰è€…
    sharedscripts          # å¤šä¸ªæ–‡ä»¶å…±äº«è„šæœ¬
    postrotate             # è½®è½¬åæ‰§è¡Œçš„è„šæœ¬
        /bin/kill -USR1 `cat /var/run/nginx.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
```

### 4.3 Apacheæ—¥å¿—è½®è½¬é…ç½®


**ğŸ”§ Apacheä¸“å±é…ç½®**

```bash
# /etc/logrotate.d/apache2
/var/log/apache2/*.log {
    weekly                  # æ¯å‘¨è½®è½¬
    missingok
    rotate 52              # ä¿ç•™52å‘¨ï¼ˆä¸€å¹´ï¼‰çš„æ—¥å¿—
    compress
    delaycompress
    notifempty
    create 644 root adm    # æ–‡ä»¶æƒé™è®¾ç½®
    sharedscripts
    postrotate
        # é‡æ–°åŠ è½½Apacheé…ç½®ï¼Œè®©å…¶é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶
        if /bin/systemctl is-active apache2 > /dev/null ; then \
            /bin/systemctl reload apache2 > /dev/null; \
        fi;
    endscript
    prerotate
        # è½®è½¬å‰çš„å¤„ç†ï¼Œæ¯”å¦‚å‘é€é€šçŸ¥
        if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
            run-parts /etc/logrotate.d/httpd-prerotate; \
        fi; \
    endscript
}
```

### 4.4 Nginxæ—¥å¿—è½®è½¬é…ç½®


**ğŸ”§ Nginxä¸“å±ä¼˜åŒ–é…ç½®**

```bash
# /etc/logrotate.d/nginx
/var/log/nginx/*.log {
    daily                   # æ¯æ—¥è½®è½¬ï¼Œé€‚åˆé«˜æµé‡ç½‘ç«™
    missingok
    rotate 30              # ä¿ç•™30å¤©çš„æ—¥å¿—
    compress               # å‹ç¼©èŠ‚çœç©ºé—´
    delaycompress          # ä¿æŒæœ€æ–°çš„è½®è½¬æ–‡ä»¶ä¸å‹ç¼©
    notifempty
    create 0644 www-data www-data
    sharedscripts
    postrotate
        # é€šçŸ¥Nginxé‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}

# é«˜æµé‡ç½‘ç«™çš„é…ç½®ç¤ºä¾‹
/var/log/nginx/access.log {
    hourly                 # æŒ‰å°æ—¶è½®è½¬
    missingok
    rotate 168            # ä¿ç•™7å¤©ï¼ˆ7Ã—24å°æ—¶ï¼‰
    compress
    delaycompress
    notifempty
    create 0644 www-data www-data
    postrotate
        kill -USR1 `cat /var/run/nginx.pid`
    endscript
}
```

### 4.5 è‡ªå®šä¹‰è½®è½¬ç­–ç•¥


**ğŸ¯ æ ¹æ®ä¸šåŠ¡éœ€æ±‚å®šåˆ¶è½®è½¬ç­–ç•¥**

```bash
# å¤§å‹ç½‘ç«™çš„åˆ†çº§æ—¥å¿—è½®è½¬ç­–ç•¥

# 1. è®¿é—®æ—¥å¿— - æ•°æ®é‡å¤§ï¼Œä¿ç•™æ—¶é—´çŸ­
/var/log/nginx/access.log {
    hourly
    rotate 72              # ä¿ç•™3å¤©
    compress
    delaycompress
    notifempty
    create 0644 www-data www-data
    postrotate
        kill -USR1 `cat /var/run/nginx.pid`
    endscript
}

# 2. é”™è¯¯æ—¥å¿— - æ•°æ®é‡å°ï¼Œä¿ç•™æ—¶é—´é•¿
/var/log/nginx/error.log {
    weekly
    rotate 52              # ä¿ç•™1å¹´
    compress
    delaycompress
    notifempty
    create 0644 www-data www-data
    postrotate
        kill -USR1 `cat /var/run/nginx.pid`
    endscript
}

# 3. åº”ç”¨æ—¥å¿— - æ ¹æ®é‡è¦æ€§åˆ†çº§å¤„ç†
/var/log/myapp/*.log {
    size 100M              # æ–‡ä»¶è¶…è¿‡100Må°±è½®è½¬
    rotate 10
    compress
    delaycompress
    notifempty
    create 0644 app app
    copytruncate          # å¤åˆ¶å¹¶æˆªæ–­ï¼Œé€‚åˆæŒç»­å†™å…¥çš„åº”ç”¨
}
```

**ğŸ“Š è½®è½¬ç­–ç•¥é€‰æ‹©æŒ‡å—**

| **æ—¥å¿—ç±»å‹** | **è½®è½¬é¢‘ç‡** | **ä¿ç•™æ—¶é—´** | **å‹ç¼©ç­–ç•¥** | **é€‚ç”¨åœºæ™¯** |
|-------------|-------------|-------------|-------------|-------------|
| **è®¿é—®æ—¥å¿—** | `hourly/daily` | `3-7å¤©` | `ç«‹å³å‹ç¼©` | é«˜æµé‡ç½‘ç«™ |
| **é”™è¯¯æ—¥å¿—** | `weekly` | `1-3ä¸ªæœˆ` | `å»¶è¿Ÿå‹ç¼©` | é—®é¢˜è¯Šæ–­éœ€è¦ |
| **åº”ç”¨æ—¥å¿—** | `size-based` | `æ ¹æ®é‡è¦æ€§` | `ç«‹å³å‹ç¼©` | ä¸šåŠ¡åº”ç”¨ |
| **å®‰å…¨æ—¥å¿—** | `daily` | `6ä¸ªæœˆ-1å¹´` | `å»¶è¿Ÿå‹ç¼©` | åˆè§„è¦æ±‚ |

---

## 5. ğŸ“Š æ—¥å¿—åˆ†æå·¥å…·åº”ç”¨


### 5.1 æ—¥å¿—åˆ†æå·¥å…·æ¦‚è¿°


**ğŸ’¡ æ—¥å¿—åˆ†æå·¥å…·çš„ä»·å€¼**

åŸå§‹æ—¥å¿—å°±åƒä¸€å †æ•£ä¹±çš„æ‹¼å›¾ç¢ç‰‡ï¼Œæ—¥å¿—åˆ†æå·¥å…·å°±æ˜¯å¸®ä½ æŠŠè¿™äº›ç¢ç‰‡æ‹¼æˆå®Œæ•´å›¾ç”»çš„å·¥å…·ã€‚é€šè¿‡åˆ†æå·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥ä»æ¯ç‡¥çš„æ—¥å¿—æ•°æ®ä¸­å‘ç°æœ‰ä»·å€¼çš„ä¿¡æ¯ã€‚

```
æ—¥å¿—åˆ†æä»·å€¼é“¾ï¼š

åŸå§‹æ—¥å¿— â†’ æ•°æ®å¤„ç† â†’ ç»Ÿè®¡åˆ†æ â†’ å¯è§†åŒ–å±•ç¤º â†’ ä¸šåŠ¡æ´å¯Ÿ
   â†“         â†“         â†“         â†“         â†“
æµ·é‡æ•°æ®   ç»“æ„åŒ–    è¶‹åŠ¿å‘ç°   ç›´è§‚å±•ç¤º   å†³ç­–æ”¯æŒ
```

### 5.2 GoAccesså®æ—¶æ—¥å¿—åˆ†æ


**ğŸš€ GoAccessçš„å¼ºå¤§åŠŸèƒ½**

GoAccessæ˜¯ä¸€ä¸ªå®æ—¶çš„Webæ—¥å¿—åˆ†æå·¥å…·ï¼Œèƒ½å¤Ÿå¿«é€Ÿç”Ÿæˆç¾è§‚çš„HTMLæŠ¥å‘Šã€‚

**å®‰è£…GoAccess**

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install goaccess

# CentOS/RHEL
sudo yum install epel-release
sudo yum install goaccess

# éªŒè¯å®‰è£…
goaccess --version
```

**ğŸ”§ åŸºç¡€ä½¿ç”¨æ–¹æ³•**

```bash
# 1. å®æ—¶åˆ†æå½“å‰æ—¥å¿—
sudo goaccess /var/log/nginx/access.log -c

# 2. ç”ŸæˆHTMLæŠ¥å‘Š
sudo goaccess /var/log/nginx/access.log -o /var/www/html/report.html --log-format=COMBINED

# 3. å®æ—¶HTMLæŠ¥å‘Šï¼ˆä¼šè‡ªåŠ¨æ›´æ–°ï¼‰
sudo goaccess /var/log/nginx/access.log -o /var/www/html/report.html --log-format=COMBINED --real-time-html

# 4. åˆ†æå¤šä¸ªæ—¥å¿—æ–‡ä»¶
sudo goaccess /var/log/nginx/access.log* -o /var/www/html/report.html --log-format=COMBINED
```

**ğŸ“Š GoAccessé…ç½®æ–‡ä»¶å®šåˆ¶**

```bash
# åˆ›å»ºé…ç½®æ–‡ä»¶ ~/.goaccessrc
cat > ~/.goaccessrc << EOF
# æ—¥å¿—æ ¼å¼è®¾ç½®
log-format COMBINED

# å¿½ç•¥çš„æ–‡ä»¶æ‰©å±•å
ignore-panel REQUESTS_STATIC
ignore-panel NOT_FOUND

# åŒ…å«çš„çŠ¶æ€ç 
ignore-status 400
ignore-status 404

# åœ°ç†ä½ç½®æ•°æ®åº“
geoip-database /usr/share/GeoIP/GeoLite2-Country.mmdb

# HTMLè¾“å‡ºè®¾ç½®
html-prefs {"theme":"bright","layout":"horizontal"}

# æ’é™¤IPåœ°å€
exclude-ip 127.0.0.1
exclude-ip 192.168.1.0/24
EOF
```

**ğŸ¯ GoAccesså®ç”¨æŠ¥å‘Šç¤ºä¾‹**

```bash
# 1. ç”Ÿæˆæ€§èƒ½åˆ†ææŠ¥å‘Š
goaccess /var/log/nginx/access.log \
  --log-format=COMBINED \
  -o performance_report.html \
  --html-prefs='{"theme":"dark"}' \
  --ignore-panel=NOT_FOUND

# 2. ç§»åŠ¨ç«¯è®¿é—®åˆ†æ
goaccess /var/log/nginx/access.log \
  --log-format=COMBINED \
  -o mobile_report.html \
  --browsers-file=/etc/goaccess/browsers.list

# 3. å®‰å…¨å®¡è®¡æŠ¥å‘Š
goaccess /var/log/nginx/access.log \
  --log-format=COMBINED \
  -o security_report.html \
  --ignore-status=200,201,301,302
```

### 5.3 AWStatsè¯¦ç»†ç»Ÿè®¡åˆ†æ


**ğŸ“ˆ AWStatsçš„ä¸“ä¸šç»Ÿè®¡åŠŸèƒ½**

AWStatsæä¾›æ›´è¯¦ç»†çš„ç½‘ç«™è®¿é—®ç»Ÿè®¡ï¼Œç‰¹åˆ«é€‚åˆéœ€è¦æ·±åº¦åˆ†æçš„åœºæ™¯ã€‚

**å®‰è£…å’Œé…ç½®AWStats**

```bash
# å®‰è£…AWStats
sudo apt install awstats

# åˆ›å»ºç½‘ç«™é…ç½®æ–‡ä»¶
sudo cp /etc/awstats/awstats.conf /etc/awstats/awstats.example.com.conf

# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /etc/awstats/awstats.example.com.conf
```

**ğŸ”§ AWStatsé…ç½®æ–‡ä»¶å…³é”®è®¾ç½®**

```perl
# /etc/awstats/awstats.example.com.conf

# æ—¥å¿—æ–‡ä»¶è·¯å¾„
LogFile="/var/log/nginx/access.log"

# æ—¥å¿—æ ¼å¼ï¼ˆNginx combinedæ ¼å¼ï¼‰
LogFormat=1

# ç½‘ç«™åŸŸå
SiteDomain="example.com"

# æ•°æ®ç›®å½•
DirData="/var/lib/awstats"

# å…è®¸æ›´æ–°
AllowToUpdateStatsFromBrowser=1

# åœ°ç†ä½ç½®æ•°æ®åº“
LoadPlugin="geoip GEOIP_STANDARD /usr/share/GeoIP/GeoIP.dat"
LoadPlugin="geoipfree"

# æœç´¢å¼•æ“æ£€æµ‹
LoadPlugin="decodeutfkeys"

# æ’é™¤IP
SkipHosts="127.0.0.1 192.168.1.0/24"

# æ’é™¤æ–‡ä»¶ç±»å‹
NotPageList="css js class gif jpg jpeg png bmp ico mp3 mp4 zip pdf"
```

**âš¡ AWStatsæ•°æ®æ›´æ–°å’ŒæŠ¥å‘Šç”Ÿæˆ**

```bash
# æ‰‹åŠ¨æ›´æ–°ç»Ÿè®¡æ•°æ®
sudo /usr/lib/cgi-bin/awstats.pl -config=example.com -update

# ç”Ÿæˆé™æ€HTMLæŠ¥å‘Š
sudo /usr/lib/cgi-bin/awstats.pl -config=example.com -output -staticlinks > /var/www/html/awstats.html

# è®¾ç½®å®šæ—¶æ›´æ–°
cat > /etc/cron.d/awstats << EOF
0 */6 * * * www-data /usr/lib/cgi-bin/awstats.pl -config=example.com -update >/dev/null 2>&1
0 2 * * * www-data /usr/lib/cgi-bin/awstats.pl -config=example.com -output -staticlinks > /var/www/html/awstats.html
EOF
```

### 5.4 è‡ªå®šä¹‰æ—¥å¿—åˆ†æè„šæœ¬


**ğŸ”§ Shellè„šæœ¬å¿«é€Ÿåˆ†æ**

```bash
#!/bin/bash
# simple_log_analyzer.sh - ç®€å•çš„æ—¥å¿—åˆ†æè„šæœ¬

LOG_FILE="/var/log/nginx/access.log"
REPORT_FILE="/tmp/log_analysis_$(date +%Y%m%d).txt"

echo "=== WebæœåŠ¡å™¨æ—¥å¿—åˆ†ææŠ¥å‘Š ===" > $REPORT_FILE
echo "åˆ†ææ—¶é—´: $(date)" >> $REPORT_FILE
echo "æ—¥å¿—æ–‡ä»¶: $LOG_FILE" >> $REPORT_FILE
echo "================================" >> $REPORT_FILE

# 1. æ€»è®¿é—®é‡
echo "æ€»è®¿é—®é‡: $(wc -l < $LOG_FILE)" >> $REPORT_FILE

# 2. ç‹¬ç«‹IPæ•°é‡
echo "ç‹¬ç«‹IPæ•°: $(awk '{print $1}' $LOG_FILE | sort | uniq | wc -l)" >> $REPORT_FILE

# 3. æœ€å—æ¬¢è¿çš„é¡µé¢
echo -e "\n=== æœ€å—æ¬¢è¿çš„é¡µé¢ ===" >> $REPORT_FILE
awk '{print $7}' $LOG_FILE | sort | uniq -c | sort -nr | head -10 >> $REPORT_FILE

# 4. è®¿é—®æœ€å¤šçš„IP
echo -e "\n=== è®¿é—®æœ€å¤šçš„IP ===" >> $REPORT_FILE
awk '{print $1}' $LOG_FILE | sort | uniq -c | sort -nr | head -10 >> $REPORT_FILE

# 5. HTTPçŠ¶æ€ç ç»Ÿè®¡
echo -e "\n=== HTTPçŠ¶æ€ç ç»Ÿè®¡ ===" >> $REPORT_FILE
awk '{print $9}' $LOG_FILE | sort | uniq -c | sort -nr >> $REPORT_FILE

# 6. æ¯å°æ—¶è®¿é—®é‡ç»Ÿè®¡
echo -e "\n=== æ¯å°æ—¶è®¿é—®é‡ ===" >> $REPORT_FILE
awk '{print substr($4,14,2)}' $LOG_FILE | sort | uniq -c >> $REPORT_FILE

echo "åˆ†æå®Œæˆï¼ŒæŠ¥å‘Šä¿å­˜åœ¨: $REPORT_FILE"
```

**ğŸ“Š Pythoné«˜çº§åˆ†æè„šæœ¬**

```python
#!/usr/bin/env python3
# advanced_log_analyzer.py

import re
from collections import Counter, defaultdict
from datetime import datetime
import sys

def analyze_nginx_log(log_file):
    """åˆ†æNginxæ—¥å¿—æ–‡ä»¶"""
    
    # æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…Nginxæ—¥å¿—æ ¼å¼
    log_pattern = re.compile(
        r'(\d+\.\d+\.\d+\.\d+) - - \[(.*?)\] "(.*?)" (\d+) (\d+) "(.*?)" "(.*?)"'
    )
    
    stats = {
        'total_requests': 0,
        'unique_ips': set(),
        'status_codes': Counter(),
        'request_methods': Counter(),
        'popular_pages': Counter(),
        'user_agents': Counter(),
        'hourly_requests': defaultdict(int),
        'daily_requests': defaultdict(int)
    }
    
    with open(log_file, 'r') as f:
        for line in f:
            match = log_pattern.match(line)
            if match:
                ip, timestamp, request, status, size, referer, user_agent = match.groups()
                
                stats['total_requests'] += 1
                stats['unique_ips'].add(ip)
                stats['status_codes'][status] += 1
                
                # è§£æè¯·æ±‚æ–¹æ³•å’ŒURL
                request_parts = request.split()
                if len(request_parts) >= 2:
                    method, url = request_parts[0], request_parts[1]
                    stats['request_methods'][method] += 1
                    stats['popular_pages'][url] += 1
                
                # è§£ææ—¶é—´
                try:
                    dt = datetime.strptime(timestamp, "%d/%b/%Y:%H:%M:%S %z")
                    hour_key = dt.strftime("%H")
                    day_key = dt.strftime("%Y-%m-%d")
                    stats['hourly_requests'][hour_key] += 1
                    stats['daily_requests'][day_key] += 1
                except:
                    pass
                
                # ç”¨æˆ·ä»£ç†ç»Ÿè®¡
                if user_agent != '-':
                    stats['user_agents'][user_agent] += 1
    
    return stats

def generate_report(stats):
    """ç”Ÿæˆåˆ†ææŠ¥å‘Š"""
    
    print("=== WebæœåŠ¡å™¨æ—¥å¿—åˆ†ææŠ¥å‘Š ===")
    print(f"æ€»è¯·æ±‚æ•°: {stats['total_requests']:,}")
    print(f"ç‹¬ç«‹IPæ•°: {len(stats['unique_ips']):,}")
    
    print("\n=== HTTPçŠ¶æ€ç åˆ†å¸ƒ ===")
    for status, count in stats['status_codes'].most_common():
        percentage = (count / stats['total_requests']) * 100
        print(f"{status}: {count:,} ({percentage:.1f}%)")
    
    print("\n=== æœ€å—æ¬¢è¿çš„é¡µé¢ ===")
    for page, count in stats['popular_pages'].most_common(10):
        print(f"{page}: {count:,}")
    
    print("\n=== æ¯å°æ—¶è¯·æ±‚åˆ†å¸ƒ ===")
    for hour in sorted(stats['hourly_requests'].keys()):
        count = stats['hourly_requests'][hour]
        print(f"{hour}:00 - {count:,}")

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("ä½¿ç”¨æ–¹æ³•: python3 advanced_log_analyzer.py <log_file>")
        sys.exit(1)
    
    log_file = sys.argv[1]
    stats = analyze_nginx_log(log_file)
    generate_report(stats)
```

---

## 6. ğŸ“± å®æ—¶ç›‘æ§é…ç½®


### 6.1 å®æ—¶ç›‘æ§çš„é‡è¦æ€§


**ğŸ’¡ å®æ—¶ç›‘æ§å°±åƒç½‘ç«™çš„"å¿ƒç”µå›¾"**

å®æ—¶ç›‘æ§å°±åƒåŒ»é™¢é‡Œçš„å¿ƒç”µå›¾ç›‘æŠ¤ä»ªï¼Œèƒ½å¤Ÿå®æ—¶æ˜¾ç¤ºç½‘ç«™çš„"ç”Ÿå‘½ä½“å¾"ã€‚å½“å‡ºç°å¼‚å¸¸æ—¶ï¼Œèƒ½å¤Ÿç«‹å³å‘ç°å¹¶å‘Šè­¦ï¼Œé¿å…å°é—®é¢˜æ¼”å˜æˆå¤§æ•…éšœã€‚

```
å®æ—¶ç›‘æ§ä»·å€¼é“¾ï¼š

å®æ—¶æ•°æ®é‡‡é›† â†’ å¼‚å¸¸æ£€æµ‹ â†’ è‡ªåŠ¨å‘Šè­¦ â†’ å¿«é€Ÿå“åº” â†’ é—®é¢˜è§£å†³
     â†“            â†“         â†“         â†“         â†“
  ç§’çº§ç›‘æ§      æ™ºèƒ½åˆ†æ    å¤šæ¸ é“é€šçŸ¥   ç¼©çŸ­MTTR   ä¿éšœå¯ç”¨æ€§
```

### 6.2 tailå‘½ä»¤å®æ—¶ç›‘æ§


**ğŸ”§ åŸºç¡€å®æ—¶ç›‘æ§å‘½ä»¤**

```bash
# 1. å®æ—¶æŸ¥çœ‹è®¿é—®æ—¥å¿—
tail -f /var/log/nginx/access.log

# 2. å®æ—¶æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log

# 3. åŒæ—¶ç›‘æ§å¤šä¸ªæ—¥å¿—æ–‡ä»¶
tail -f /var/log/nginx/access.log /var/log/nginx/error.log

# 4. æ˜¾ç¤ºæœ€è¿‘Nè¡Œå¹¶ç»§ç»­ç›‘æ§
tail -n 100 -f /var/log/nginx/access.log

# 5. è¿‡æ»¤ç‰¹å®šå†…å®¹å®æ—¶ç›‘æ§
tail -f /var/log/nginx/access.log | grep "404"
tail -f /var/log/nginx/access.log | grep -E "(404|500|502)"
```

**ğŸ¯ å®ç”¨ç›‘æ§è„šæœ¬**

```bash
#!/bin/bash
# real_time_monitor.sh - å®æ—¶ç›‘æ§è„šæœ¬

LOG_FILE="/var/log/nginx/access.log"

echo "å¼€å§‹å®æ—¶ç›‘æ§WebæœåŠ¡å™¨..."
echo "æŒ‰Ctrl+Cåœæ­¢ç›‘æ§"

# å®æ—¶ç»Ÿè®¡å¹¶æ˜¾ç¤ºå…³é”®æŒ‡æ ‡
tail -f $LOG_FILE | while read line; do
    # æå–çŠ¶æ€ç 
    status=$(echo $line | awk '{print $9}')
    
    # æå–IPåœ°å€
    ip=$(echo $line | awk '{print $1}')
    
    # æå–è¯·æ±‚URL
    url=$(echo $line | awk '{print $7}')
    
    # å½“å‰æ—¶é—´
    current_time=$(date '+%H:%M:%S')
    
    # æ ¹æ®çŠ¶æ€ç æ˜¾ç¤ºä¸åŒé¢œè‰²
    case $status in
        200) echo "[$current_time] âœ… $ip -> $url (OK)" ;;
        404) echo "[$current_time] âš ï¸  $ip -> $url (Not Found)" ;;
        500|502|503) echo "[$current_time] ğŸš¨ $ip -> $url (Server Error: $status)" ;;
        *) echo "[$current_time] â„¹ï¸  $ip -> $url ($status)" ;;
    esac
done
```

### 6.3 multitailé«˜çº§ç›‘æ§


**ğŸš€ multitailå¤šçª—å£ç›‘æ§**

multitailå¯ä»¥åœ¨ä¸€ä¸ªç»ˆç«¯çª—å£ä¸­åŒæ—¶ç›‘æ§å¤šä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œéå¸¸é€‚åˆå¤æ‚çš„ç›‘æ§éœ€æ±‚ã€‚

```bash
# å®‰è£…multitail
sudo apt install multitail

# åŒæ—¶ç›‘æ§è®¿é—®æ—¥å¿—å’Œé”™è¯¯æ—¥å¿—
multitail /var/log/nginx/access.log /var/log/nginx/error.log

# æŒ‰é¢œè‰²åŒºåˆ†ä¸åŒç±»å‹çš„æ—¥å¿—
multitail -ci red /var/log/nginx/error.log -ci green /var/log/nginx/access.log

# ä½¿ç”¨é…ç½®æ–‡ä»¶å®šåˆ¶æ˜¾ç¤º
multitail -f /etc/multitail.conf /var/log/nginx/access.log
```

**ğŸ“Š multitailé…ç½®æ–‡ä»¶ç¤ºä¾‹**

```bash
# ~/.multitailrc
# ä¸ºä¸åŒçŠ¶æ€ç è®¾ç½®é¢œè‰²

# æˆåŠŸè¯·æ±‚ - ç»¿è‰²
colorscheme:nginx_access:HTTP 200
cs_re_s:green: 200 

# é”™è¯¯è¯·æ±‚ - çº¢è‰²
cs_re_s:red: [45][0-9][0-9] 

# é‡å®šå‘ - é»„è‰²
cs_re_s:yellow: [3][0-9][0-9] 

# IPåœ°å€ - è“è‰²
cs_re_s:blue:\d+\.\d+\.\d+\.\d+
```

### 6.4 GoAccesså®æ—¶HTMLç›‘æ§


**ğŸŒ åŸºäºWebçš„å®æ—¶ç›‘æ§**

```bash
# å¯åŠ¨GoAccesså®æ—¶HTMLç›‘æ§
goaccess /var/log/nginx/access.log \
  -o /var/www/html/report.html \
  --log-format=COMBINED \
  --real-time-html \
  --ws-url=wss://example.com:7890 \
  --port=7890

# åå°è¿è¡Œå®æ—¶ç›‘æ§
nohup goaccess /var/log/nginx/access.log \
  -o /var/www/html/realtime.html \
  --log-format=COMBINED \
  --real-time-html \
  --daemonize \
  --pid-file=/var/run/goaccess.pid &
```

**ğŸ”§ Nginxé…ç½®æ”¯æŒå®æ—¶ç›‘æ§**

```nginx
# ä¸ºå®æ—¶ç›‘æ§é…ç½®WebSocketä»£ç†
location /ws {
    proxy_pass http://127.0.0.1:7890;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
}

# ç›‘æ§é¡µé¢è®¿é—®é…ç½®
location /monitor {
    alias /var/www/html/realtime.html;
    index realtime.html;
}
```

---

## 7. ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡é‡‡é›†


### 7.1 æ€§èƒ½æŒ‡æ ‡ä½“ç³»


**ğŸ¯ WebæœåŠ¡å™¨æ€§èƒ½æŒ‡æ ‡å…¨æ™¯**

WebæœåŠ¡å™¨çš„æ€§èƒ½å°±åƒæ±½è½¦çš„ä»ªè¡¨ç›˜ï¼Œéœ€è¦ç›‘æ§å¤šä¸ªå…³é”®æŒ‡æ ‡æ¥äº†è§£æ•´ä½“è¿è¡ŒçŠ¶å†µã€‚

```
æ€§èƒ½æŒ‡æ ‡å±‚æ¬¡ç»“æ„ï¼š

                    WebæœåŠ¡å™¨æ€§èƒ½
                   /       |       \
              å“åº”æ€§èƒ½    ååæ€§èƒ½    èµ„æºæ€§èƒ½
             /      \    /      \    /      \
        å“åº”æ—¶é—´  å¯ç”¨æ€§  QPS  å¹¶å‘æ•°  CPU  å†…å­˜  ç£ç›˜
```

| **æŒ‡æ ‡ç±»åˆ«** | **æ ¸å¿ƒæŒ‡æ ‡** | **æ­£å¸¸èŒƒå›´** | **ç›‘æ§ç›®çš„** |
|-------------|-------------|-------------|-------------|
| **ğŸš€ å“åº”æ€§èƒ½** | å“åº”æ—¶é—´ | `< 200ms` | ç”¨æˆ·ä½“éªŒ |
| **ğŸ“Š ååæ€§èƒ½** | QPS | `æ ¹æ®ä¸šåŠ¡éœ€æ±‚` | å¤„ç†èƒ½åŠ› |
| **ğŸ’» èµ„æºæ€§èƒ½** | CPUä½¿ç”¨ç‡ | `< 80%` | ç³»ç»Ÿè´Ÿè½½ |
| **ğŸ” å¯ç”¨æ€§** | é”™è¯¯ç‡ | `< 1%` | æœåŠ¡ç¨³å®šæ€§ |

### 7.2 å“åº”æ—¶é—´ç›‘æ§


**â±ï¸ å“åº”æ—¶é—´åˆ†æé…ç½®**

```bash
# Nginxé…ç½®è®°å½•å“åº”æ—¶é—´
log_format performance '$remote_addr - $remote_user [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      'rt=$request_time uct="$upstream_connect_time" '
                      'uht="$upstream_header_time" urt="$upstream_response_time"';

access_log /var/log/nginx/performance.log performance;
```

**ğŸ“Š å“åº”æ—¶é—´åˆ†æè„šæœ¬**

```bash
#!/bin/bash
# response_time_analyzer.sh - å“åº”æ—¶é—´åˆ†æ

LOG_FILE="/var/log/nginx/performance.log"

echo "=== å“åº”æ—¶é—´åˆ†ææŠ¥å‘Š ==="

# 1. å¹³å‡å“åº”æ—¶é—´
echo "å¹³å‡å“åº”æ—¶é—´:"
awk -F'rt=' '{if($2) print $2}' $LOG_FILE | awk '{print $1}' | \
awk '{sum+=$1; count++} END {printf "%.3f ç§’\n", sum/count}'

# 2. å“åº”æ—¶é—´åˆ†å¸ƒ
echo -e "\nå“åº”æ—¶é—´åˆ†å¸ƒ:"
awk -F'rt=' '{if($2) print $2}' $LOG_FILE | awk '{print $1}' | \
awk '{
    if ($1 < 0.1) fast++
    else if ($1 < 0.5) normal++
    else if ($1 < 1.0) slow++
    else very_slow++
    total++
}
END {
    printf "å¿«é€Ÿ (<0.1s): %d (%.1f%%)\n", fast, fast/total*100
    printf "æ­£å¸¸ (0.1-0.5s): %d (%.1f%%)\n", normal, normal/total*100
    printf "æ…¢ (0.5-1.0s): %d (%.1f%%)\n", slow, slow/total*100
    printf "å¾ˆæ…¢ (>1.0s): %d (%.1f%%)\n", very_slow, very_slow/total*100
}'

# 3. æœ€æ…¢çš„10ä¸ªè¯·æ±‚
echo -e "\næœ€æ…¢çš„10ä¸ªè¯·æ±‚:"
awk -F'rt=' '{if($2) {time=$2; gsub(/ .*/, "", time); print time, $0}}' $LOG_FILE | \
sort -nr | head -10 | awk '{print "å“åº”æ—¶é—´:", $1"s", "è¯·æ±‚:", substr($0, index($0,$3))}'
```

### 7.3 QPSå’Œå¹¶å‘ç›‘æ§


**ğŸ“Š QPS(æ¯ç§’è¯·æ±‚æ•°)å®æ—¶ç»Ÿè®¡**

```bash
#!/bin/bash
# qps_monitor.sh - QPSå®æ—¶ç›‘æ§

LOG_FILE="/var/log/nginx/access.log"

echo "QPSå®æ—¶ç›‘æ§ (æŒ‰Ctrl+Cåœæ­¢)"
echo "æ—¶é—´        QPS    ç´¯è®¡è¯·æ±‚"

# åˆå§‹åŒ–è®¡æ•°å™¨
total_requests=0
last_time=$(date +%s)
last_count=$(wc -l < $LOG_FILE)

while true; do
    sleep 5  # æ¯5ç§’ç»Ÿè®¡ä¸€æ¬¡
    
    current_time=$(date +%s)
    current_count=$(wc -l < $LOG_FILE)
    
    # è®¡ç®—æ—¶é—´å·®å’Œè¯·æ±‚å·®
    time_diff=$((current_time - last_time))
    request_diff=$((current_count - last_count))
    
    # è®¡ç®—QPS
    if [ $time_diff -gt 0 ]; then
        qps=$((request_diff / time_diff))
        total_requests=$((total_requests + request_diff))
        
        timestamp=$(date '+%H:%M:%S')
        printf "%-8s %6d %10d\n" $timestamp $qps $total_requests
    fi
    
    last_time=$current_time
    last_count=$current_count
done
```

**âš¡ Apache abå‹åŠ›æµ‹è¯•**

```bash
# ä½¿ç”¨abå·¥å…·æµ‹è¯•æœåŠ¡å™¨æ€§èƒ½
# 100ä¸ªå¹¶å‘ç”¨æˆ·ï¼Œæ€»å…±1000ä¸ªè¯·æ±‚
ab -n 1000 -c 100 http://example.com/

# å¸¦è®¤è¯çš„æµ‹è¯•
ab -n 1000 -c 50 -A username:password http://example.com/admin/

# æµ‹è¯•POSTè¯·æ±‚
ab -n 100 -c 10 -p post_data.txt -T application/x-www-form-urlencoded http://example.com/api/
```

### 7.4 ç³»ç»Ÿèµ„æºç›‘æ§


**ğŸ’» ç»¼åˆèµ„æºç›‘æ§è„šæœ¬**

```bash
#!/bin/bash
# system_monitor.sh - ç³»ç»Ÿèµ„æºç›‘æ§

OUTPUT_FILE="/var/log/system_performance.log"

while true; do
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # CPUä½¿ç”¨ç‡
    cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
    
    # å†…å­˜ä½¿ç”¨æƒ…å†µ
    memory_info=$(free | grep Mem)
    total_mem=$(echo $memory_info | awk '{print $2}')
    used_mem=$(echo $memory_info | awk '{print $3}')
    mem_usage=$(awk "BEGIN {printf \"%.1f\", $used_mem/$total_mem*100}")
    
    # ç£ç›˜ä½¿ç”¨ç‡
    disk_usage=$(df /var/log | tail -1 | awk '{print $5}' | cut -d'%' -f1)
    
    # ç½‘ç»œè¿æ¥æ•°
    connections=$(netstat -an | grep :80 | grep ESTABLISHED | wc -l)
    
    # è´Ÿè½½å¹³å‡å€¼
    load_avg=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | cut -d',' -f1)
    
    # è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶
    echo "$timestamp,CPU:${cpu_usage}%,MEM:${mem_usage}%,DISK:${disk_usage}%,CONN:$connections,LOAD:$load_avg" >> $OUTPUT_FILE
    
    # å±å¹•æ˜¾ç¤º
    printf "%-19s CPU:%5s%% MEM:%5s%% DISK:%3s%% CONN:%4d LOAD:%s\n" \
           "$timestamp" "$cpu_usage" "$mem_usage" "$disk_usage" "$connections" "$load_avg"
    
    sleep 10
done
```

**ğŸ“Š æ€§èƒ½æ•°æ®å¯è§†åŒ–**

```python
#!/usr/bin/env python3
# performance_visualizer.py - æ€§èƒ½æ•°æ®å¯è§†åŒ–

import matplotlib.pyplot as plt
import pandas as pd
from datetime import datetime
import sys

def plot_performance_data(log_file):
    """ç»˜åˆ¶æ€§èƒ½æ•°æ®å›¾è¡¨"""
    
    data = []
    with open(log_file, 'r') as f:
        for line in f:
            parts = line.strip().split(',')
            if len(parts) >= 6:
                timestamp = parts[0]
                cpu = float(parts[1].split(':')[1].rstrip('%'))
                memory = float(parts[2].split(':')[1].rstrip('%'))
                disk = float(parts[3].split(':')[1].rstrip('%'))
                connections = int(parts[4].split(':')[1])
                load = float(parts[5].split(':')[1])
                
                data.append({
                    'timestamp': datetime.strptime(timestamp, '%Y-%m-%d %H:%M:%S'),
                    'cpu': cpu,
                    'memory': memory,
                    'disk': disk,
                    'connections': connections,
                    'load': load
                })
    
    df = pd.DataFrame(data)
    
    # åˆ›å»ºå¤šå­å›¾
    fig, axes = plt.subplots(2, 2, figsize=(15, 10))
    fig.suptitle('WebæœåŠ¡å™¨æ€§èƒ½ç›‘æ§æŠ¥å‘Š', fontsize=16)
    
    # CPUä½¿ç”¨ç‡
    axes[0,0].plot(df['timestamp'], df['cpu'], 'b-', linewidth=2)
    axes[0,0].set_title('CPUä½¿ç”¨ç‡ (%)')
    axes[0,0].set_ylabel('ä½¿ç”¨ç‡')
    axes[0,0].grid(True, alpha=0.3)
    
    # å†…å­˜ä½¿ç”¨ç‡
    axes[0,1].plot(df['timestamp'], df['memory'], 'g-', linewidth=2)
    axes[0,1].set_title('å†…å­˜ä½¿ç”¨ç‡ (%)')
    axes[0,1].set_ylabel('ä½¿ç”¨ç‡')
    axes[0,1].grid(True, alpha=0.3)
    
    # ç½‘ç»œè¿æ¥æ•°
    axes[1,0].plot(df['timestamp'], df['connections'], 'r-', linewidth=2)
    axes[1,0].set_title('ç½‘ç»œè¿æ¥æ•°')
    axes[1,0].set_ylabel('è¿æ¥æ•°')
    axes[1,0].grid(True, alpha=0.3)
    
    # ç³»ç»Ÿè´Ÿè½½
    axes[1,1].plot(df['timestamp'], df['load'], 'm-', linewidth=2)
    axes[1,1].set_title('ç³»ç»Ÿè´Ÿè½½')
    axes[1,1].set_ylabel('è´Ÿè½½å€¼')
    axes[1,1].grid(True, alpha=0.3)
    
    plt.tight_layout()
    plt.savefig('performance_report.png', dpi=300, bbox_inches='tight')
    print("æ€§èƒ½æŠ¥å‘Šå·²ä¿å­˜ä¸º performance_report.png")

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("ä½¿ç”¨æ–¹æ³•: python3 performance_visualizer.py <log_file>")
        sys.exit(1)
    
    plot_performance_data(sys.argv[1])
```

---

## 8. ğŸš¨ å‘Šè­¦é…ç½®ä½“ç³»


### 8.1 å‘Šè­¦ç³»ç»Ÿçš„è®¾è®¡åŸåˆ™


**ğŸ’¡ å‘Šè­¦ç³»ç»Ÿå°±åƒæ™ºèƒ½å®‰ä¿ç³»ç»Ÿ**

å¥½çš„å‘Šè­¦ç³»ç»Ÿå°±åƒä¸€ä¸ªæ™ºèƒ½çš„å®‰ä¿ç³»ç»Ÿï¼Œæ—¢è¦èƒ½åŠæ—¶å‘ç°é—®é¢˜ï¼Œåˆä¸èƒ½é¢‘ç¹è¯¯æŠ¥å¹²æ‰°æ­£å¸¸å·¥ä½œã€‚å…³é”®æ˜¯è¦è®¾ç½®åˆç†çš„é˜ˆå€¼å’Œå‘Šè­¦ç­–ç•¥ã€‚

```
å‘Šè­¦ç³»ç»Ÿè®¾è®¡åŸåˆ™ï¼š

åŠæ—¶æ€§ â†’ å‡†ç¡®æ€§ â†’ å¯æ“ä½œæ€§ â†’ å¯è¿½æº¯æ€§
  â†“       â†“        â†“         â†“
å¿«é€Ÿé€šçŸ¥  å‡å°‘è¯¯æŠ¥  æ˜ç¡®æŒ‡å¯¼   å®Œæ•´è®°å½•
```

**ğŸ¯ å‘Šè­¦çº§åˆ«åˆ†ç±»**

| **å‘Šè­¦çº§åˆ«** | **ä¸¥é‡ç¨‹åº¦** | **å“åº”æ—¶é—´** | **é€šçŸ¥æ–¹å¼** | **å…¸å‹åœºæ™¯** |
|-------------|-------------|-------------|-------------|-------------|
| **ğŸ”´ Critical** | ç³»ç»Ÿä¸å¯ç”¨ | `ç«‹å³` | ç”µè¯+çŸ­ä¿¡+é‚®ä»¶ | æœåŠ¡å®Œå…¨å®•æœº |
| **ğŸŸ  Warning** | æ€§èƒ½ä¸‹é™ | `5åˆ†é’Ÿå†…` | çŸ­ä¿¡+é‚®ä»¶ | å“åº”æ—¶é—´è¿‡é•¿ |
| **ğŸŸ¡ Notice** | éœ€è¦å…³æ³¨ | `30åˆ†é’Ÿå†…` | é‚®ä»¶ | ç£ç›˜ä½¿ç”¨ç‡é«˜ |
| **ğŸ”µ Info** | ä¸€èˆ¬ä¿¡æ¯ | `ä¸é™åˆ¶` | æ—¥å¿—è®°å½• | æ­£å¸¸çŠ¶æ€å˜åŒ– |

### 8.2 åŸºäºé˜ˆå€¼çš„å‘Šè­¦é…ç½®


**ğŸ”§ CPUå’Œå†…å­˜å‘Šè­¦è„šæœ¬**

```bash
#!/bin/bash
# threshold_monitor.sh - åŸºäºé˜ˆå€¼çš„ç›‘æ§å‘Šè­¦

# é…ç½®å‘Šè­¦é˜ˆå€¼
CPU_WARNING=70
CPU_CRITICAL=90
MEM_WARNING=80
MEM_CRITICAL=95
DISK_WARNING=85
DISK_CRITICAL=95

# é…ç½®é€šçŸ¥æ–¹å¼
ADMIN_EMAIL="admin@example.com"
ADMIN_PHONE="13800138000"

# å‘é€é‚®ä»¶å‡½æ•°
send_email() {
    local subject="$1"
    local message="$2"
    echo "$message" | mail -s "$subject" $ADMIN_EMAIL
}

# å‘é€çŸ­ä¿¡å‡½æ•°ï¼ˆéœ€è¦é…ç½®çŸ­ä¿¡APIï¼‰
send_sms() {
    local message="$1"
    # è¿™é‡Œè°ƒç”¨çŸ­ä¿¡API
    # curl -X POST "https://sms-api.example.com/send" -d "phone=$ADMIN_PHONE&message=$message"
    echo "çŸ­ä¿¡å‘Šè­¦: $message"
}

# æ£€æŸ¥CPUä½¿ç”¨ç‡
check_cpu() {
    cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1 | cut -d' ' -f1)
    cpu_int=${cpu_usage%.*}  # å–æ•´æ•°éƒ¨åˆ†
    
    if [ $cpu_int -ge $CPU_CRITICAL ]; then
        alert_msg="ğŸ”´ CRITICAL: CPUä½¿ç”¨ç‡ ${cpu_usage}% (é˜ˆå€¼: ${CPU_CRITICAL}%)"
        send_email "ç´§æ€¥å‘Šè­¦: CPUä½¿ç”¨ç‡è¿‡é«˜" "$alert_msg"
        send_sms "$alert_msg"
        echo "$(date): $alert_msg" >> /var/log/alerts.log
    elif [ $cpu_int -ge $CPU_WARNING ]; then
        alert_msg="ğŸŸ  WARNING: CPUä½¿ç”¨ç‡ ${cpu_usage}% (é˜ˆå€¼: ${CPU_WARNING}%)"
        send_email "è­¦å‘Š: CPUä½¿ç”¨ç‡åé«˜" "$alert_msg"
        echo "$(date): $alert_msg" >> /var/log/alerts.log
    fi
}

# æ£€æŸ¥å†…å­˜ä½¿ç”¨ç‡
check_memory() {
    memory_info=$(free | grep Mem)
    total_mem=$(echo $memory_info | awk '{print $2}')
    used_mem=$(echo $memory_info | awk '{print $3}')
    mem_usage=$(awk "BEGIN {printf \"%.0f\", $used_mem/$total_mem*100}")
    
    if [ $mem_usage -ge $MEM_CRITICAL ]; then
        alert_msg="ğŸ”´ CRITICAL: å†…å­˜ä½¿ç”¨ç‡ ${mem_usage}% (é˜ˆå€¼: ${MEM_CRITICAL}%)"
        send_email "ç´§æ€¥å‘Šè­¦: å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜" "$alert_msg"
        send_sms "$alert_msg"
        echo "$(date): $alert_msg" >> /var/log/alerts.log
    elif [ $mem_usage -ge $MEM_WARNING ]; then
        alert_msg="ğŸŸ  WARNING: å†…å­˜ä½¿ç”¨ç‡ ${mem_usage}% (é˜ˆå€¼: ${MEM_WARNING}%)"
        send_email "è­¦å‘Š: å†…å­˜ä½¿ç”¨ç‡åé«˜" "$alert_msg"
        echo "$(date): $alert_msg" >> /var/log/alerts.log
    fi
}

# æ£€æŸ¥ç£ç›˜ä½¿ç”¨ç‡
check_disk() {
    disk_usage=$(df /var/log | tail -1 | awk '{print $5}' | cut -d'%' -f1)
    
    if [ $disk_usage -ge $DISK_CRITICAL ]; then
        alert_msg="ğŸ”´ CRITICAL: ç£ç›˜ä½¿ç”¨ç‡ ${disk_usage}% (é˜ˆå€¼: ${DISK_CRITICAL}%)"
        send_email "ç´§æ€¥å‘Šè­¦: ç£ç›˜ç©ºé—´ä¸è¶³" "$alert_msg"
        send_sms "$alert_msg"
        echo "$(date): $alert_msg" >> /var/log/alerts.log
    elif [ $disk_usage -ge $DISK_WARNING ]; then
        alert_msg="ğŸŸ  WARNING: ç£ç›˜ä½¿ç”¨ç‡ ${disk_usage}% (é˜ˆå€¼: ${DISK_WARNING}%)"
        send_email "è­¦å‘Š: ç£ç›˜ç©ºé—´åé«˜" "$alert_msg"
        echo "$(date): $alert_msg" >> /var/log/alerts.log
    fi
}

# ä¸»ç›‘æ§å¾ªç¯
main() {
    echo "ç³»ç»Ÿç›‘æ§å‘Šè­¦æœåŠ¡å¯åŠ¨ - $(date)"
    
    while true; do
        check_cpu
        check_memory
        check_disk
        sleep 60  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    done
}

# å¯åŠ¨ç›‘æ§
main
```

### 8.3 æœåŠ¡çŠ¶æ€ç›‘æ§å‘Šè­¦


**ğŸ”§ WebæœåŠ¡å¯ç”¨æ€§æ£€æµ‹**

```bash
#!/bin/bash
# service_monitor.sh - æœåŠ¡çŠ¶æ€ç›‘æ§å‘Šè­¦

# é…ç½®å‚æ•°
SERVICES=("nginx" "apache2" "mysql")
WEB_URLS=("http://localhost" "http://example.com")
CHECK_INTERVAL=30
MAX_RESPONSE_TIME=5

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_service_status() {
    local service_name="$1"
    
    if systemctl is-active --quiet $service_name; then
        echo "âœ… $service_name æœåŠ¡æ­£å¸¸è¿è¡Œ"
        return 0
    else
        alert_msg="ğŸ”´ CRITICAL: $service_name æœåŠ¡å·²åœæ­¢"
        send_email "ç´§æ€¥å‘Šè­¦: æœåŠ¡æ•…éšœ" "$alert_msg"
        send_sms "$alert_msg"
        echo "$(date): $alert_msg" >> /var/log/service_alerts.log
        
        # å°è¯•è‡ªåŠ¨é‡å¯æœåŠ¡
        echo "å°è¯•é‡å¯ $service_name æœåŠ¡..."
        systemctl restart $service_name
        sleep 10
        
        if systemctl is-active --quiet $service_name; then
            recovery_msg="âœ… $service_name æœåŠ¡å·²è‡ªåŠ¨æ¢å¤"
            send_email "æœåŠ¡æ¢å¤é€šçŸ¥" "$recovery_msg"
            echo "$(date): $recovery_msg" >> /var/log/service_alerts.log
        fi
        return 1
    fi
}

# æ£€æŸ¥ç½‘ç«™å¯è®¿é—®æ€§
check_website_availability() {
    local url="$1"
    
    response=$(curl -s -o /dev/null -w "%{http_code}:%{time_total}" --max-time $MAX_RESPONSE_TIME "$url")
    http_code=$(echo $response | cut -d':' -f1)
    response_time=$(echo $response | cut -d':' -f2)
    
    if [ "$http_code" = "200" ]; then
        if (( $(echo "$response_time > 3.0" | bc -l) )); then
            alert_msg="ğŸŸ  WARNING: $url å“åº”ç¼“æ…¢ (${response_time}s)"
            send_email "æ€§èƒ½è­¦å‘Š" "$alert_msg"
            echo "$(date): $alert_msg" >> /var/log/website_alerts.log
        else
            echo "âœ… $url è®¿é—®æ­£å¸¸ (${response_time}s)"
        fi
    else
        alert_msg="ğŸ”´ CRITICAL: $url æ— æ³•è®¿é—® (HTTP: $http_code)"
        send_email "ç´§æ€¥å‘Šè­¦: ç½‘ç«™æ•…éšœ" "$alert_msg"
        send_sms "$alert_msg"
        echo "$(date): $alert_msg" >> /var/log/website_alerts.log
    fi
}

# ä¸»ç›‘æ§å¾ªç¯
while true; do
    echo "=== æœåŠ¡çŠ¶æ€æ£€æŸ¥ $(date) ==="
    
    # æ£€æŸ¥ç³»ç»ŸæœåŠ¡
    for service in "${SERVICES[@]}"; do
        check_service_status $service
    done
    
    # æ£€æŸ¥ç½‘ç«™å¯ç”¨æ€§
    for url in "${WEB_URLS[@]}"; do
        check_website_availability $url
    done
    
    echo "ç­‰å¾… $CHECK_INTERVAL ç§’..."
    sleep $CHECK_INTERVAL
done
```

### 8.4 æ—¥å¿—å¼‚å¸¸æ¨¡å¼å‘Šè­¦


**ğŸ” åŸºäºæ—¥å¿—æ¨¡å¼çš„æ™ºèƒ½å‘Šè­¦**

```bash
#!/bin/bash
# log_pattern_monitor.sh - æ—¥å¿—å¼‚å¸¸æ¨¡å¼ç›‘æ§

LOG_FILE="/var/log/nginx/access.log"
ERROR_LOG="/var/log/nginx/error.log"
ALERT_LOG="/var/log/pattern_alerts.log"

# å®šä¹‰å¼‚å¸¸æ¨¡å¼
declare -A ALERT_PATTERNS=(
    ["æ”»å‡»å°è¯•"]="(sql|script|select|union|drop|insert|update|delete|exec|script)"
    ["404è¿‡å¤š"]="404"
    ["æœåŠ¡å™¨é”™è¯¯"]="(500|502|503|504)"
    ["å¯ç–‘æ‰«æ"]="(admin|wp-admin|phpmyadmin|config|backup)"
)

# å®šä¹‰é˜ˆå€¼ï¼ˆæ¯åˆ†é’Ÿè§¦å‘æ¬¡æ•°ï¼‰
declare -A THRESHOLDS=(
    ["æ”»å‡»å°è¯•"]=5
    ["404è¿‡å¤š"]=50
    ["æœåŠ¡å™¨é”™è¯¯"]=10
    ["å¯ç–‘æ‰«æ"]=20
)

monitor_log_patterns() {
    local current_time=$(date +%s)
    local one_minute_ago=$((current_time - 60))
    
    # è·å–æœ€è¿‘ä¸€åˆ†é’Ÿçš„æ—¥å¿—
    recent_logs=$(awk -v start_time="$one_minute_ago" '
        BEGIN {
            # è½¬æ¢æ—¥å¿—æ—¶é—´æ ¼å¼
        }
        {
            # æå–æ—¶é—´æˆ³å¹¶è½¬æ¢
            match($4, /\[([0-9]{2}\/[A-Za-z]{3}\/[0-9]{4}:[0-9]{2}:[0-9]{2}:[0-9]{2})/, time_parts)
            if (time_parts[1]) {
                cmd = "date -d \"" time_parts[1] "\" +%s"
                cmd | getline log_timestamp
                close(cmd)
                
                if (log_timestamp >= start_time) {
                    print $0
                }
            }
        }
    ' $LOG_FILE)
    
    # æ£€æŸ¥å„ç§å¼‚å¸¸æ¨¡å¼
    for pattern_name in "${!ALERT_PATTERNS[@]}"; do
        pattern="${ALERT_PATTERNS[$pattern_name]}"
        threshold="${THRESHOLDS[$pattern_name]}"
        
        count=$(echo "$recent_logs" | grep -ciE "$pattern" | head -1)
        
        if [ "$count" -ge "$threshold" ]; then
            alert_msg="ğŸš¨ å¼‚å¸¸æ¨¡å¼æ£€æµ‹: $pattern_name åœ¨è¿‡å»1åˆ†é’Ÿå†…å‡ºç° $count æ¬¡ (é˜ˆå€¼: $threshold)"
            
            # æå–ç›¸å…³æ—¥å¿—æ ·ä¾‹
            samples=$(echo "$recent_logs" | grep -iE "$pattern" | head -3)
            
            full_alert="$alert_msg\n\næ ·ä¾‹æ—¥å¿—:\n$samples"
            
            send_email "æ—¥å¿—å¼‚å¸¸å‘Šè­¦: $pattern_name" "$full_alert"
            echo "$(date): $alert_msg" >> $ALERT_LOG
            
            # è®°å½•è¯¦ç»†ä¿¡æ¯ç”¨äºåˆ†æ
            echo "=== $pattern_name å¼‚å¸¸è¯¦æƒ… $(date) ===" >> $ALERT_LOG
            echo "$samples" >> $ALERT_LOG
            echo "=======================================" >> $ALERT_LOG
        fi
    done
}

# æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
while true; do
    monitor_log_patterns
    sleep 60
done
```

### 8.5 é›†æˆå‘Šè­¦é€šçŸ¥ç³»ç»Ÿ


**ğŸ“± å¤šæ¸ é“å‘Šè­¦é€šçŸ¥é…ç½®**

```bash
#!/bin/bash
# alert_notification.sh - é›†æˆå‘Šè­¦é€šçŸ¥ç³»ç»Ÿ

# é…ç½®æ–‡ä»¶
source /etc/alert_config.conf

# é‚®ä»¶é€šçŸ¥å‡½æ•°
send_email_alert() {
    local level="$1"
    local title="$2"
    local message="$3"
    local priority=""
    
    case $level in
        "CRITICAL") priority="High" ;;
        "WARNING") priority="Normal" ;;
        "INFO") priority="Low" ;;
    esac
    
    # ç”ŸæˆHTMLæ ¼å¼é‚®ä»¶
    cat > /tmp/alert_email.html << EOF
<!DOCTYPE html>
<html>
<head>
    <style>
        .alert-critical { background-color: #ff4444; color: white; }
        .alert-warning { background-color: #ffaa00; color: white; }
        .alert-info { background-color: #4444ff; color: white; }
        .content { padding: 20px; font-family: Arial, sans-serif; }
    </style>
</head>
<body>
    <div class="content">
        <div class="alert-$(echo $level | tr '[:upper:]' '[:lower:]')">
            <h2>$level: $title</h2>
        </div>
        <p><strong>æ—¶é—´:</strong> $(date)</p>
        <p><strong>æœåŠ¡å™¨:</strong> $(hostname)</p>
        <p><strong>è¯¦æƒ…:</strong></p>
        <pre>$message</pre>
        <hr>
        <p><small>æ­¤é‚®ä»¶ç”±ç›‘æ§ç³»ç»Ÿè‡ªåŠ¨å‘é€</small></p>
    </div>
</body>
</html>
EOF
    
    # å‘é€é‚®ä»¶
    mail -s "[$level] $title" -a "Content-Type: text/html" $ADMIN_EMAIL < /tmp/alert_email.html
}

# å¾®ä¿¡/é’‰é’‰é€šçŸ¥å‡½æ•°
send_webhook_alert() {
    local level="$1"
    local title="$2"
    local message="$3"
    
    # é’‰é’‰æœºå™¨äººé€šçŸ¥
    if [ -n "$DINGTALK_WEBHOOK" ]; then
        curl -X POST "$DINGTALK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
                \"msgtype\": \"text\",
                \"text\": {
                    \"content\": \"ã€$levelã€‘$title\\næ—¶é—´: $(date)\\næœåŠ¡å™¨: $(hostname)\\nè¯¦æƒ…: $message\"
                }
            }"
    fi
    
    # ä¼ä¸šå¾®ä¿¡é€šçŸ¥
    if [ -n "$WECHAT_WEBHOOK" ]; then
        curl -X POST "$WECHAT_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
                \"msgtype\": \"text\",
                \"text\": {
                    \"content\": \"ã€$levelã€‘$title\\næ—¶é—´: $(date)\\næœåŠ¡å™¨: $(hostname)\\nè¯¦æƒ…: $message\"
                }
            }"
    fi
}

# çŸ­ä¿¡é€šçŸ¥å‡½æ•°ï¼ˆé˜¿é‡Œäº‘çŸ­ä¿¡ç¤ºä¾‹ï¼‰
send_sms_alert() {
    local level="$1"
    local title="$2"
    local message="$3"
    
    # åªæœ‰CRITICALçº§åˆ«æ‰å‘é€çŸ­ä¿¡
    if [ "$level" = "CRITICAL" ]; then
        # è°ƒç”¨çŸ­ä¿¡API
        curl -X POST "https://dysmsapi.aliyuncs.com/" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "PhoneNumbers=$ADMIN_PHONE" \
            -d "SignName=ç›‘æ§ç³»ç»Ÿ" \
            -d "TemplateCode=SMS_TEMPLATE_ID" \
            -d "TemplateParam={\"level\":\"$level\",\"title\":\"$title\"}"
    fi
}

# ç»Ÿä¸€å‘Šè­¦æ¥å£
send_alert() {
    local level="$1"
    local title="$2"
    local message="$3"
    
    # è®°å½•åˆ°å‘Šè­¦æ—¥å¿—
    echo "$(date): [$level] $title - $message" >> /var/log/alerts.log
    
    # æ ¹æ®çº§åˆ«é€‰æ‹©é€šçŸ¥æ–¹å¼
    case $level in
        "CRITICAL")
            send_email_alert "$level" "$title" "$message"
            send_webhook_alert "$level" "$title" "$message"
            send_sms_alert "$level" "$title" "$message"
            ;;
        "WARNING")
            send_email_alert "$level" "$title" "$message"
            send_webhook_alert "$level" "$title" "$message"
            ;;
        "INFO")
            send_email_alert "$level" "$title" "$message"
            ;;
    esac
}

# ä½¿ç”¨ç¤ºä¾‹
# send_alert "CRITICAL" "WebæœåŠ¡å™¨å®•æœº" "NginxæœåŠ¡æ— å“åº”"
# send_alert "WARNING" "CPUä½¿ç”¨ç‡è¿‡é«˜" "å½“å‰CPUä½¿ç”¨ç‡: 85%"
```

---

## 9. ğŸ“ æ—¥å¿—é›†ä¸­åŒ–ç®¡ç†


### 9.1 æ—¥å¿—é›†ä¸­åŒ–çš„å¿…è¦æ€§


**ğŸ’¡ æ—¥å¿—é›†ä¸­åŒ–å°±åƒå»ºç«‹"ä¿¡æ¯æŒ‡æŒ¥ä¸­å¿ƒ"**

æƒ³è±¡ç®¡ç†ä¸€ä¸ªå¤§å‹è´­ç‰©ä¸­å¿ƒï¼Œå¦‚æœæ¯ä¸ªåº—é“ºçš„ç›‘æ§å½•åƒéƒ½åˆ†åˆ«å­˜å‚¨ï¼Œå‡ºç°é—®é¢˜æ—¶éœ€è¦è·‘éæ‰€æœ‰åº—é“ºæŸ¥çœ‹å½•åƒã€‚æ—¥å¿—é›†ä¸­åŒ–å°±æ˜¯æŠŠæ‰€æœ‰"ç›‘æ§å½•åƒ"ç»Ÿä¸€å­˜å‚¨åˆ°å®‰å…¨ä¸­å¿ƒï¼Œæ–¹ä¾¿ç»Ÿä¸€ç®¡ç†å’Œåˆ†æã€‚

```
æ—¥å¿—åˆ†æ•£å­˜å‚¨çš„é—®é¢˜ï¼š

æœåŠ¡å™¨Aæ—¥å¿— â†’ æœ¬åœ°å­˜å‚¨ â†’ æŸ¥è¯¢å›°éš¾ â†’ åˆ†æä½æ•ˆ
æœåŠ¡å™¨Bæ—¥å¿— â†’ æœ¬åœ°å­˜å‚¨ â†’ å®¹é‡é™åˆ¶ â†’ æ•°æ®ä¸¢å¤±  
æœåŠ¡å™¨Cæ—¥å¿— â†’ æœ¬åœ°å­˜å‚¨ â†’ æ ¼å¼ä¸ä¸€ â†’ æ— æ³•å…³è”

é›†ä¸­åŒ–è§£å†³æ–¹æ¡ˆï¼š
æ‰€æœ‰æœåŠ¡å™¨ â†’ ç»Ÿä¸€æ”¶é›† â†’ ä¸­å¤®å­˜å‚¨ â†’ ç»Ÿä¸€åˆ†æ â†’ å…¨å±€è§†å›¾
```

**ğŸ¯ é›†ä¸­åŒ–ç®¡ç†çš„æ ¸å¿ƒä»·å€¼**

| **ä»·å€¼ç»´åº¦** | **å…·ä½“æ”¶ç›Š** | **å®é™…æ•ˆæœ** |
|-------------|-------------|-------------|
| **ğŸ” ç»Ÿä¸€æŸ¥è¯¢** | ä¸€ä¸ªç•Œé¢æŸ¥çœ‹æ‰€æœ‰æ—¥å¿— | é—®é¢˜å®šä½æ•ˆç‡æå‡10å€ |
| **ğŸ“Š å…³è”åˆ†æ** | è·¨æœåŠ¡å™¨æ—¥å¿—å…³è” | å‘ç°åˆ†å¸ƒå¼ç³»ç»Ÿé—®é¢˜ |
| **ğŸ’¾ ç»Ÿä¸€å­˜å‚¨** | é›†ä¸­å¤‡ä»½å’Œå½’æ¡£ | é™ä½å­˜å‚¨æˆæœ¬30% |
| **âš¡ å®æ—¶ç›‘æ§** | å…¨å±€å®æ—¶å‘Šè­¦ | æ•…éšœå“åº”æ—¶é—´ç¼©çŸ­80% |

### 9.2 ELK Stackæ—¥å¿—ç®¡ç†


**ğŸ”§ ELKæ¶æ„ç»„ä»¶è¯´æ˜**

ELKæ˜¯ç›®å‰æœ€æµè¡Œçš„æ—¥å¿—ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œç”±ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ç»„æˆï¼š

```
ELKæ¶æ„å›¾ï¼š

WebæœåŠ¡å™¨ç¾¤ â†’ Logstash/Beats â†’ Elasticsearch â†’ Kibana
     â†“              â†“              â†“           â†“
   äº§ç”Ÿæ—¥å¿—        æ”¶é›†å¤„ç†        å­˜å‚¨ç´¢å¼•     å¯è§†åŒ–åˆ†æ
```

**ğŸ“‹ ELKç»„ä»¶è¯¦è§£**

| **ç»„ä»¶** | **ä½œç”¨** | **æ ¸å¿ƒåŠŸèƒ½** | **ç±»æ¯”** |
|---------|---------|-------------|---------|
| **Elasticsearch** | å­˜å‚¨å’Œç´¢å¼• | åˆ†å¸ƒå¼æœç´¢å¼•æ“ | å›¾ä¹¦é¦†çš„ç´¢å¼•ç³»ç»Ÿ |
| **Logstash** | æ•°æ®å¤„ç† | æ”¶é›†ã€è½¬æ¢ã€å‘é€ | é‚®å±€çš„åˆ†æ‹£ç³»ç»Ÿ |
| **Kibana** | æ•°æ®å¯è§†åŒ– | å›¾è¡¨å’Œä»ªè¡¨æ¿ | æ•°æ®åˆ†æå¤§å± |
| **Beats** | è½»é‡çº§é‡‡é›† | é«˜æ•ˆæ—¥å¿—é‡‡é›† | æ•°æ®æ”¶é›†å‘˜ |

**ğŸ› ï¸ Filebeaté…ç½®ç¤ºä¾‹**

```yaml
# /etc/filebeat/filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/nginx/access.log
  fields:
    service: nginx
    log_type: access
  fields_under_root: true
  multiline.pattern: '^\d{4}-\d{2}-\d{2}'
  multiline.negate: true
  multiline.match: after

- type: log
  enabled: true
  paths:
    - /var/log/nginx/error.log
  fields:
    service: nginx
    log_type: error
  fields_under_root: true

# è¾“å‡ºåˆ°Logstash
output.logstash:
  hosts: ["logstash-server:5044"]

# æˆ–è€…ç›´æ¥è¾“å‡ºåˆ°Elasticsearch
# output.elasticsearch:
#   hosts: ["elasticsearch-server:9200"]
#   index: "nginx-logs-%{+yyyy.MM.dd}"

# æ—¥å¿—çº§åˆ«
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat.log
  keepfiles: 7
  permissions: 0644
```

### 9.3 Logstashæ•°æ®å¤„ç†é…ç½®


**ğŸ”§ Logstashå¤„ç†ç®¡é“é…ç½®**

```ruby
# /etc/logstash/conf.d/nginx.conf
input {
  beats {
    port => 5044
  }
}

filter {
  # å¤„ç†Nginxè®¿é—®æ—¥å¿—
  if [service] == "nginx" and [log_type] == "access" {
    grok {
      match => { 
        "message" => "%{IPORHOST:client_ip} - %{DATA:user_name} \[%{HTTPDATE:timestamp}\] \"%{WORD:http_method} %{URIPATH:url}(?:%{URIPARAM:url_params})? HTTP/%{NUMBER:http_version}\" %{INT:response_code} %{INT:body_sent} \"%{DATA:referer}\" \"%{DATA:user_agent}\"" 
      }
    }
    
    # è§£ææ—¶é—´æˆ³
    date {
      match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
    }
    
    # è½¬æ¢æ•°æ®ç±»å‹
    mutate {
      convert => { 
        "response_code" => "integer"
        "body_sent" => "integer"
      }
    }
    
    # åœ°ç†ä½ç½®è§£æ
    geoip {
      source => "client_ip"
      target => "geoip"
    }
    
    # ç”¨æˆ·ä»£ç†è§£æ
    useragent {
      source => "user_agent"
      target => "ua"
    }
  }
  
  # å¤„ç†Nginxé”™è¯¯æ—¥å¿—
  if [service] == "nginx" and [log_type] == "error" {
    grok {
      match => { 
        "message" => "%{DATESTAMP:timestamp} \[%{DATA:log_level}\] %{INT:pid}#%{INT:tid}: (?:\*%{INT:connection_id} )?%{GREEDYDATA:error_message}" 
      }
    }
    
    date {
      match => [ "timestamp", "yyyy/MM/dd HH:mm:ss" ]
    }
  }
  
  # æ·»åŠ æœåŠ¡å™¨ä¿¡æ¯
  mutate {
    add_field => { "server_name" => "%{[@metadata][beat]}" }
  }
}

output {
  # æ ¹æ®æ—¥å¿—ç±»å‹è¾“å‡ºåˆ°ä¸åŒç´¢å¼•
  if [log_type] == "access" {
    elasticsearch {
      hosts => ["elasticsearch-server:9200"]
      index => "nginx-access-%{+yyyy.MM.dd}"
    }
  } else if [log_type] == "error" {
    elasticsearch {
      hosts => ["elasticsearch-server:9200"]
      index => "nginx-error-%{+yyyy.MM.dd}"
    }
  }
  
  # è°ƒè¯•è¾“å‡º
  # stdout { codec => rubydebug }
}
```

### 9.4 è½»é‡çº§æ—¥å¿—ç®¡ç†æ–¹æ¡ˆ


**ğŸ”§ åŸºäºrsyslogçš„ç®€å•é›†ä¸­åŒ–**

å¯¹äºä¸­å°è§„æ¨¡çš„ç¯å¢ƒï¼Œå¯ä»¥ä½¿ç”¨rsyslogå®ç°ç®€å•çš„æ—¥å¿—é›†ä¸­åŒ–ï¼š

```bash
# æ—¥å¿—æœåŠ¡å™¨é…ç½® /etc/rsyslog.conf
# å¯ç”¨TCPæ¥æ”¶
$ModLoad imtcp
$InputTCPServerRun 514

# å¯ç”¨UDPæ¥æ”¶  
$ModLoad imudp
$UDPServerRun 514

# æ ¹æ®ä¸»æœºååˆ†åˆ«å­˜å‚¨
$template RemoteLogs,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"
*.* ?RemoteLogs
& stop

# å®¢æˆ·ç«¯é…ç½®
# å‘é€æ—¥å¿—åˆ°ä¸­å¤®æœåŠ¡å™¨
*.* $$log-server:514

# é‡å¯rsyslogæœåŠ¡
systemctl restart rsyslog
```

**ğŸ“Š è‡ªå»ºæ—¥å¿—åˆ†æWebç•Œé¢**

```python
#!/usr/bin/env python3
# simple_log_viewer.py - ç®€å•çš„Webæ—¥å¿—æŸ¥çœ‹å™¨

from flask import Flask, render_template, request, jsonify
import os
import re
from datetime import datetime, timedelta
import json

app = Flask(__name__)

class LogAnalyzer:
    def __init__(self, log_dir="/var/log/remote"):
        self.log_dir = log_dir
    
    def get_server_list(self):
        """è·å–æœåŠ¡å™¨åˆ—è¡¨"""
        servers = []
        if os.path.exists(self.log_dir):
            servers = [d for d in os.listdir(self.log_dir) 
                      if os.path.isdir(os.path.join(self.log_dir, d))]
        return sorted(servers)
    
    def get_log_files(self, server):
        """è·å–æŒ‡å®šæœåŠ¡å™¨çš„æ—¥å¿—æ–‡ä»¶åˆ—è¡¨"""
        server_dir = os.path.join(self.log_dir, server)
        if not os.path.exists(server_dir):
            return []
        
        files = [f for f in os.listdir(server_dir) if f.endswith('.log')]
        return sorted(files)
    
    def search_logs(self, server, log_file, keyword, start_time=None, end_time=None):
        """æœç´¢æ—¥å¿—å†…å®¹"""
        log_path = os.path.join(self.log_dir, server, log_file)
        if not os.path.exists(log_path):
            return []
        
        results = []
        with open(log_path, 'r') as f:
            for line_no, line in enumerate(f, 1):
                if keyword.lower() in line.lower():
                    results.append({
                        'line_number': line_no,
                        'content': line.strip(),
                        'timestamp': self.extract_timestamp(line)
                    })
                
                # é™åˆ¶ç»“æœæ•°é‡é¿å…é¡µé¢è¿‡å¤§
                if len(results) >= 1000:
                    break
        
        return results
    
    def extract_timestamp(self, line):
        """ä»æ—¥å¿—è¡Œä¸­æå–æ—¶é—´æˆ³"""
        patterns = [
            r'\[(.*?)\]',  # [timestamp]æ ¼å¼
            r'(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})',  # YYYY-MM-DD HH:MM:SS
            r'(\w{3} \d{2} \d{2}:\d{2}:\d{2})'  # MMM DD HH:MM:SS
        ]
        
        for pattern in patterns:
            match = re.search(pattern, line)
            if match:
                return match.group(1)
        return None

analyzer = LogAnalyzer()

@app.route('/')
def index():
    """ä¸»é¡µ"""
    servers = analyzer.get_server_list()
    return render_template('index.html', servers=servers)

@app.route('/api/logs/<server>')
def get_log_files(server):
    """è·å–æŒ‡å®šæœåŠ¡å™¨çš„æ—¥å¿—æ–‡ä»¶"""
    files = analyzer.get_log_files(server)
    return jsonify(files)

@app.route('/api/search')
def search_logs():
    """æœç´¢æ—¥å¿—"""
    server = request.args.get('server')
    log_file = request.args.get('file')
    keyword = request.args.get('keyword', '')
    
    if not all([server, log_file, keyword]):
        return jsonify([])
    
    results = analyzer.search_logs(server, log_file, keyword)
    return jsonify(results)

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
```

---

## 10. ğŸ”’ å®‰å…¨å®¡è®¡æ—¥å¿—


### 10.1 å®‰å…¨å®¡è®¡æ—¥å¿—çš„é‡è¦æ€§


**ğŸ’¡ å®‰å…¨å®¡è®¡æ—¥å¿—æ˜¯ç½‘ç«™çš„"å®‰å…¨å½•åƒ"**

å®‰å…¨å®¡è®¡æ—¥å¿—å°±åƒé“¶è¡Œçš„ç›‘æ§å½•åƒï¼Œè®°å½•ä¸‹æ‰€æœ‰å¯ç–‘æ´»åŠ¨å’Œå®‰å…¨äº‹ä»¶ã€‚å½“å‘ç”Ÿå®‰å…¨äº‹ä»¶æ—¶ï¼Œè¿™äº›è®°å½•èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬ï¼š
- è¿½è¸ªæ”»å‡»æ¥æºå’Œè¿‡ç¨‹
- è¯„ä¼°æŸå¤±ç¨‹åº¦  
- æ”¹è¿›å®‰å…¨é˜²æŠ¤ç­–ç•¥
- æ»¡è¶³åˆè§„è¦æ±‚

```
å®‰å…¨å®¡è®¡æ—¥å¿—ä½“ç³»ï¼š

ç”¨æˆ·è®¿é—® â†’ è¡Œä¸ºè®°å½• â†’ å¼‚å¸¸æ£€æµ‹ â†’ å®‰å…¨åˆ†æ â†’ é£é™©è¯„ä¼°
    â†“         â†“         â†“         â†“         â†“
èº«ä»½éªŒè¯   æ“ä½œæ—¥å¿—   æ¨¡å¼è¯†åˆ«   å¨èƒæƒ…æŠ¥   é˜²æŠ¤ç­–ç•¥
```

**ğŸ¯ å®‰å…¨å®¡è®¡çš„æ ¸å¿ƒè¦ç´ **

| **å®¡è®¡ç»´åº¦** | **è®°å½•å†…å®¹** | **åˆ†æç›®çš„** | **å…¸å‹åº”ç”¨** |
|-------------|-------------|-------------|-------------|
| **ğŸ” èº«ä»½è®¤è¯** | ç™»å½•å°è¯•ã€å¤±è´¥æ¬¡æ•° | æ£€æµ‹æš´åŠ›ç ´è§£ | ç”¨æˆ·è´¦å·å®‰å…¨ |
| **ğŸ“ æ“ä½œè¡Œä¸º** | æ–‡ä»¶è®¿é—®ã€å‘½ä»¤æ‰§è¡Œ | è¿½è¸ªæ“ä½œè½¨è¿¹ | å†…éƒ¨å¨èƒæ£€æµ‹ |
| **ğŸŒ ç½‘ç»œè®¿é—®** | IPæ¥æºã€è®¿é—®æ¨¡å¼ | è¯†åˆ«å¼‚å¸¸æµé‡ | å¤–éƒ¨æ”»å‡»é˜²æŠ¤ |
| **ğŸ“Š æ•°æ®è®¿é—®** | æ•æ„Ÿæ•°æ®æ“ä½œ | æ•°æ®æ³„éœ²æ£€æµ‹ | åˆè§„æ€§å®¡è®¡ |

### 10.2 Webè®¿é—®å®‰å…¨æ—¥å¿—é…ç½®


**ğŸ”§ Nginxå®‰å…¨æ—¥å¿—æ ¼å¼å®šåˆ¶**

```nginx
# å®šä¹‰å®‰å…¨å®¡è®¡æ—¥å¿—æ ¼å¼
log_format security '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   '"$http_x_forwarded_for" "$http_x_real_ip" '
                   '$request_time $upstream_response_time '
                   '"$request_body" "$args"';

# è®°å½•æ‰€æœ‰è¯·æ±‚åˆ°å®‰å…¨å®¡è®¡æ—¥å¿—
access_log /var/log/nginx/security_audit.log security;

# å•ç‹¬è®°å½•å¯ç–‘è¯·æ±‚
map $request_uri $suspicious {
    default 0;
    ~*\.(php|asp|jsp)$ 1;  # å¯ç–‘æ–‡ä»¶ç±»å‹
    ~*(union|select|drop|insert|update|delete) 1;  # SQLæ³¨å…¥å°è¯•
    ~*(script|alert|prompt|confirm) 1;  # XSSå°è¯•
    ~*(admin|config|backup|db) 1;  # æ•æ„Ÿè·¯å¾„è®¿é—®
}

# è®°å½•å¯ç–‘è¯·æ±‚
access_log /var/log/nginx/suspicious.log security if=$suspicious;

# è®°å½•é”™è¯¯è¯·æ±‚
error_log /var/log/nginx/security_errors.log warn;
```

**ğŸ” Apacheå®‰å…¨æ—¥å¿—é…ç½®**

```apache
# å¯ç”¨è¯¦ç»†çš„å®‰å…¨æ—¥å¿—
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-Forwarded-For}i\" %D \"%{Cookie}i\"" security

# è®°å½•æ‰€æœ‰è®¿é—®
CustomLog /var/log/apache2/security_audit.log security

# ä½¿ç”¨mod_securityè®°å½•å®‰å…¨äº‹ä»¶
<IfModule mod_security2.c>
    SecAuditEngine On
    SecAuditLogType Serial
    SecAuditLog /var/log/apache2/modsec_audit.log
    
    # è®°å½•æ‰€æœ‰é”™è¯¯å’Œæ”»å‡»
    SecAuditLogParts ABIJDEFHZ
    
    # è®¾ç½®å®¡è®¡è§„åˆ™
    SecRule REQUEST_URI "@detectSQLi" \
        "id:1001,phase:2,block,msg:'SQL Injection Attack Detected',\
        logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}'"
</IfModule>
```

### 10.3 ç³»ç»Ÿå®‰å…¨å®¡è®¡é…ç½®


**ğŸ”§ auditdç³»ç»Ÿå®¡è®¡é…ç½®**

```bash
# å®‰è£…auditd
sudo apt install auditd audispd-plugins

# é…ç½®å®¡è®¡è§„åˆ™ /etc/audit/rules.d/audit.rules

# 1. ç›‘æ§æ–‡ä»¶ç³»ç»Ÿå˜åŒ–
-w /etc/passwd -p wa -k identity
-w /etc/group -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/sudoers -p wa -k privilege_escalation

# 2. ç›‘æ§é‡è¦é…ç½®æ–‡ä»¶
-w /etc/nginx/ -p wa -k webserver_config
-w /etc/apache2/ -p wa -k webserver_config
-w /etc/ssh/sshd_config -p wa -k ssh_config

# 3. ç›‘æ§ç™»å½•äº‹ä»¶
-w /var/log/auth.log -p wa -k authentication
-w /var/log/secure -p wa -k authentication

# 4. ç›‘æ§ç‰¹æƒå‘½ä»¤æ‰§è¡Œ
-a always,exit -F arch=b64 -S execve -F euid=0 -k root_commands
-a always,exit -F arch=b32 -S execve -F euid=0 -k root_commands

# 5. ç›‘æ§ç½‘ç»œé…ç½®å˜åŒ–
-a always,exit -F arch=b64 -S sethostname -S setdomainname -k network_config
-a always,exit -F arch=b32 -S sethostname -S setdomainname -k network_config

# 6. ç›‘æ§æ–‡ä»¶æƒé™å˜åŒ–
-a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -F auid>=1000 -k perm_mod
-a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -F auid>=1000 -k perm_mod

# é‡å¯auditdæœåŠ¡
sudo systemctl restart auditd
```

**ğŸ“Š auditdæ—¥å¿—åˆ†æè„šæœ¬**

```bash
#!/bin/bash
# audit_analysis.sh - ç³»ç»Ÿå®¡è®¡æ—¥å¿—åˆ†æ

AUDIT_LOG="/var/log/audit/audit.log"
REPORT_FILE="/var/log/security_report_$(date +%Y%m%d).txt"

echo "=== ç³»ç»Ÿå®‰å…¨å®¡è®¡æŠ¥å‘Š ===" > $REPORT_FILE
echo "ç”Ÿæˆæ—¶é—´: $(date)" >> $REPORT_FILE
echo "================================" >> $REPORT_FILE

# 1. ç»Ÿè®¡ç™»å½•äº‹ä»¶
echo -e "\n=== ç™»å½•äº‹ä»¶ç»Ÿè®¡ ===" >> $REPORT_FILE
ausearch -k authentication --start today --raw | \
audit2allow -M login_events 2>/dev/null
ausearch -k authentication --start today | \
grep -c "type=USER_LOGIN" >> $REPORT_FILE

# 2. ç‰¹æƒå‘½ä»¤æ‰§è¡Œ
echo -e "\n=== ç‰¹æƒå‘½ä»¤æ‰§è¡Œ ===" >> $REPORT_FILE
ausearch -k root_commands --start today --format text | \
head -20 >> $REPORT_FILE

# 3. æ–‡ä»¶ç³»ç»Ÿå˜åŒ–
echo -e "\n=== é‡è¦æ–‡ä»¶å˜åŒ– ===" >> $REPORT_FILE
ausearch -k identity --start today --format text >> $REPORT_FILE

# 4. ç½‘ç»œé…ç½®å˜åŒ–
echo -e "\n=== ç½‘ç»œé…ç½®å˜åŒ– ===" >> $REPORT_FILE
ausearch -k network_config --start today --format text >> $REPORT_FILE

# 5. å¤±è´¥çš„ç™»å½•å°è¯•
echo -e "\n=== å¤±è´¥çš„ç™»å½•å°è¯• ===" >> $REPORT_FILE
ausearch -m USER_LOGIN --start today --success no --format text >> $REPORT_FILE

echo "å®‰å…¨å®¡è®¡æŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_FILE"
```

### 10.4 å®‰å…¨äº‹ä»¶è‡ªåŠ¨æ£€æµ‹


**ğŸš¨ åŸºäºæ—¥å¿—çš„å…¥ä¾µæ£€æµ‹è„šæœ¬**

```bash
#!/bin/bash
# security_detector.sh - å®‰å…¨äº‹ä»¶è‡ªåŠ¨æ£€æµ‹

LOG_FILE="/var/log/nginx/access.log"
SECURITY_LOG="/var/log/security_events.log"
ALERT_THRESHOLD=10

# æ£€æµ‹SQLæ³¨å…¥å°è¯•
detect_sql_injection() {
    sql_patterns=("union" "select" "drop" "insert" "update" "delete" "exec" "script")
    
    for pattern in "${sql_patterns[@]}"; do
        count=$(grep -ci "$pattern" $LOG_FILE | tail -1000 | grep -c "$pattern")
        if [ $count -gt $ALERT_THRESHOLD ]; then
            alert_msg="ğŸš¨ SQLæ³¨å…¥æ”»å‡»æ£€æµ‹: å‘ç° $count æ¬¡ '$pattern' å°è¯•"
            echo "$(date): $alert_msg" >> $SECURITY_LOG
            send_security_alert "SQLæ³¨å…¥æ”»å‡»" "$alert_msg"
        fi
    done
}

# æ£€æµ‹XSSæ”»å‡»å°è¯•
detect_xss_attacks() {
    xss_patterns=("script" "javascript:" "onload" "onerror" "alert(" "prompt(" "confirm(")
    
    for pattern in "${xss_patterns[@]}"; do
        count=$(grep -ci "$pattern" $LOG_FILE | tail -1000 | grep -c "$pattern")
        if [ $count -gt 5 ]; then
            alert_msg="ğŸš¨ XSSæ”»å‡»æ£€æµ‹: å‘ç° $count æ¬¡ '$pattern' å°è¯•"
            echo "$(date): $alert_msg" >> $SECURITY_LOG
            send_security_alert "XSSæ”»å‡»" "$alert_msg"
        fi
    done
}

# æ£€æµ‹æš´åŠ›ç ´è§£å°è¯•
detect_brute_force() {
    # ç»Ÿè®¡æ¯ä¸ªIPçš„404å’Œ401é”™è¯¯æ¬¡æ•°
    suspicious_ips=$(awk '$9 ~ /^(404|401|403)$/ {print $1}' $LOG_FILE | \
                    sort | uniq -c | awk '$1 > 50 {print $2, $1}')
    
    if [ -n "$suspicious_ips" ]; then
        echo "$suspicious_ips" | while read ip count; do
            alert_msg="ğŸš¨ æš´åŠ›ç ´è§£æ£€æµ‹: IP $ip äº§ç”Ÿ $count æ¬¡é”™è¯¯è¯·æ±‚"
            echo "$(date): $alert_msg" >> $SECURITY_LOG
            send_security_alert "æš´åŠ›ç ´è§£æ”»å‡»" "$alert_msg"
            
            # è‡ªåŠ¨å°ç¦IPï¼ˆå¯é€‰ï¼‰
            # iptables -A INPUT -s $ip -j DROP
        done
    fi
}

# æ£€æµ‹ç›®å½•æ‰«æ
detect_directory_scan() {
    scan_patterns=("admin" "wp-admin" "phpmyadmin" "config" "backup" "test" ".env")
    
    for pattern in "${scan_patterns[@]}"; do
        scanning_ips=$(grep -i "$pattern" $LOG_FILE | awk '{print $1}' | \
                      sort | uniq -c | awk '$1 > 20 {print $2, $1}')
        
        if [ -n "$scanning_ips" ]; then
            echo "$scanning_ips" | while read ip count; do
                alert_msg="ğŸš¨ ç›®å½•æ‰«ææ£€æµ‹: IP $ip æ‰«æ '$pattern' $count æ¬¡"
                echo "$(date): $alert_msg" >> $SECURITY_LOG
                send_security_alert "ç›®å½•æ‰«ææ”»å‡»" "$alert_msg"
            done
        fi
    done
}

# å‘é€å®‰å…¨å‘Šè­¦
send_security_alert() {
    local attack_type="$1"
    local message="$2"
    
    # å‘é€é‚®ä»¶å‘Šè­¦
    echo "$message" | mail -s "å®‰å…¨å‘Šè­¦: $attack_type" admin@example.com
    
    # å‘é€åˆ°å®‰å…¨å›¢é˜Ÿ
    curl -X POST "https://hooks.slack.com/services/SECURITY/WEBHOOK" \
         -H 'Content-type: application/json' \
         -d "{\"text\":\"$message\"}"
}

# ä¸»æ£€æµ‹å¾ªç¯
main() {
    echo "å®‰å…¨æ£€æµ‹æœåŠ¡å¯åŠ¨ - $(date)"
    
    while true; do
        detect_sql_injection
        detect_xss_attacks
        detect_brute_force
        detect_directory_scan
        
        sleep 300  # æ¯5åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡
    done
}

# å¯åŠ¨æ£€æµ‹
main
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ—¥å¿—ç®¡ç†ï¼šWebæœåŠ¡å™¨çš„"é»‘åŒ£å­"ï¼Œè®°å½•ç³»ç»Ÿè¿è¡Œçš„å®Œæ•´ä¿¡æ¯
ğŸ”¸ æ—¥å¿—åˆ†ç±»ï¼šè®¿é—®æ—¥å¿—ã€é”™è¯¯æ—¥å¿—ã€ç³»ç»Ÿæ—¥å¿—å„æœ‰ä¸åŒç”¨é€”å’Œä»·å€¼
ğŸ”¸ æ ¼å¼å®šåˆ¶ï¼šæ ¹æ®åˆ†æéœ€æ±‚å®šåˆ¶æ—¥å¿—æ ¼å¼ï¼Œå¹³è¡¡è¯¦ç»†åº¦ä¸æ€§èƒ½
ğŸ”¸ æ—¥å¿—è½®è½¬ï¼šé€šè¿‡logrotateç®¡ç†æ—¥å¿—æ–‡ä»¶å¤§å°å’Œä¿ç•™æ—¶é—´
ğŸ”¸ åˆ†æå·¥å…·ï¼šGoAccessã€AWStatsç­‰å·¥å…·å¿«é€Ÿç”Ÿæˆåˆ†ææŠ¥å‘Š
ğŸ”¸ å®æ—¶ç›‘æ§ï¼štailã€multitailç­‰å®ç°æ—¥å¿—å®æ—¶æŸ¥çœ‹å’Œç›‘æ§
ğŸ”¸ æ€§èƒ½æŒ‡æ ‡ï¼šå“åº”æ—¶é—´ã€QPSã€èµ„æºä½¿ç”¨ç‡ç­‰å…³é”®æ€§èƒ½æŒ‡æ ‡
ğŸ”¸ å‘Šè­¦ç³»ç»Ÿï¼šåŸºäºé˜ˆå€¼å’Œæ¨¡å¼çš„å¤šçº§å‘Šè­¦é€šçŸ¥æœºåˆ¶
ğŸ”¸ é›†ä¸­ç®¡ç†ï¼šELK Stackå®ç°åˆ†å¸ƒå¼æ—¥å¿—ç»Ÿä¸€ç®¡ç†
ğŸ”¸ å®‰å…¨å®¡è®¡ï¼šè®°å½•å’Œåˆ†æå®‰å…¨ç›¸å…³äº‹ä»¶ï¼Œé˜²èŒƒå®‰å…¨å¨èƒ
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ—¥å¿—ç®¡ç†çš„æœ¬è´¨ä»·å€¼**
```
æ—¥å¿—ä¸æ˜¯è´Ÿæ‹…ï¼Œè€Œæ˜¯å®è´µèµ„äº§ï¼š
- é—®é¢˜è¯Šæ–­çš„çº¿ç´¢æ¥æº
- æ€§èƒ½ä¼˜åŒ–çš„æ•°æ®åŸºç¡€  
- å®‰å…¨é˜²æŠ¤çš„é¢„è­¦ç³»ç»Ÿ
- ä¸šåŠ¡åˆ†æçš„æ•°æ®æ”¯æ’‘
- åˆè§„å®¡è®¡çš„è¯æ®ææ–™
```

**ğŸ”¹ æ—¥å¿—æ ¼å¼è®¾è®¡åŸåˆ™**
```
å¹³è¡¡è¯¦ç»†ç¨‹åº¦ä¸ç³»ç»Ÿæ€§èƒ½ï¼š
- è®°å½•å…³é”®ä¿¡æ¯ï¼šIPã€æ—¶é—´ã€è¯·æ±‚ã€å“åº”çŠ¶æ€
- æ·»åŠ åˆ†æç»´åº¦ï¼šå“åº”æ—¶é—´ã€ç”¨æˆ·ä»£ç†ã€æ¥æºé¡µé¢
- è€ƒè™‘æ€§èƒ½å½±å“ï¼šé¿å…è¿‡åº¦è¯¦ç»†å½±å“æœåŠ¡å™¨æ€§èƒ½
- æ ‡å‡†åŒ–æ ¼å¼ï¼šä¾¿äºå·¥å…·è§£æå’Œè‡ªåŠ¨åŒ–å¤„ç†
```

**ğŸ”¹ ç›‘æ§å‘Šè­¦çš„æ™ºèƒ½åŒ–**
```
å‘Šè­¦ç³»ç»Ÿè¦æ™ºèƒ½ï¼Œä¸è¦æ‰°æ°‘ï¼š
- åˆç†è®¾ç½®é˜ˆå€¼ï¼šé¿å…é¢‘ç¹è¯¯æŠ¥
- åˆ†çº§é€šçŸ¥æœºåˆ¶ï¼šæ ¹æ®ä¸¥é‡ç¨‹åº¦é€‰æ‹©é€šçŸ¥æ–¹å¼
- æ¨¡å¼è¯†åˆ«èƒ½åŠ›ï¼šè¯†åˆ«å¼‚å¸¸æ¨¡å¼è€Œéå•ç‚¹äº‹ä»¶
- è‡ªåŠ¨å¤„ç†èƒ½åŠ›ï¼šç®€å•é—®é¢˜è‡ªåŠ¨ä¿®å¤
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¼ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ**

| **åœºæ™¯ç±»å‹** | **æ—¥å¿—ç­–ç•¥** | **ç›‘æ§é‡ç‚¹** | **å‘Šè­¦é…ç½®** |
|-------------|-------------|-------------|-------------|
| **å°å‹ç½‘ç«™** | `åŸºç¡€æ ¼å¼ + æ¯æ—¥è½®è½¬` | `å¯ç”¨æ€§ + é”™è¯¯ç‡` | `é‚®ä»¶å‘Šè­¦` |
| **ä¸­å‹ç½‘ç«™** | `è¯¦ç»†æ ¼å¼ + å°æ—¶è½®è½¬` | `æ€§èƒ½æŒ‡æ ‡ + å®‰å…¨äº‹ä»¶` | `å¤šæ¸ é“å‘Šè­¦` |
| **å¤§å‹ç½‘ç«™** | `é›†ä¸­åŒ–ç®¡ç† + å®æ—¶åˆ†æ` | `å…¨æ–¹ä½ç›‘æ§` | `æ™ºèƒ½å‘Šè­¦` |
| **ä¼ä¸šçº§** | `åˆè§„å®¡è®¡ + é•¿æœŸå½’æ¡£` | `å®‰å…¨åˆè§„ + ä¸šåŠ¡æŒ‡æ ‡` | `é›†æˆå‘Šè­¦` |

**ğŸ”§ æŠ€æœ¯é€‰å‹å»ºè®®**

```
å·¥å…·é€‰æ‹©å†³ç­–æ ‘ï¼š

æ—¥å¿—é‡ < 1GB/å¤© â†’ åŸºç¡€å·¥å…·(tail, grep, awk)
æ—¥å¿—é‡ 1-10GB/å¤© â†’ ä¸­çº§å·¥å…·(GoAccess, ç®€å•è„šæœ¬)  
æ—¥å¿—é‡ > 10GB/å¤© â†’ ä¸“ä¸šå·¥å…·(ELK Stack)
å¤šæœåŠ¡å™¨ç¯å¢ƒ â†’ é›†ä¸­åŒ–æ–¹æ¡ˆ(ELK, rsyslog)
```

**âš¡ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**

```
æ—¥å¿—æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š
1. åˆç†çš„æ—¥å¿—çº§åˆ«ï¼šç”Ÿäº§ç¯å¢ƒé¿å…debugçº§åˆ«
2. å¼‚æ­¥å†™å…¥ï¼šå‡å°‘æ—¥å¿—I/Oå¯¹æœåŠ¡æ€§èƒ½çš„å½±å“  
3. å®šæœŸæ¸…ç†ï¼šåŠæ—¶åˆ é™¤è¿‡æœŸæ—¥å¿—é‡Šæ”¾ç£ç›˜ç©ºé—´
4. å‹ç¼©å­˜å‚¨ï¼šå†å²æ—¥å¿—å‹ç¼©å­˜å‚¨èŠ‚çœç©ºé—´
5. åˆ†ç¦»å­˜å‚¨ï¼šæ—¥å¿—å­˜å‚¨ä¸åº”ç”¨å­˜å‚¨åˆ†ç¦»
```

### 11.4 æ•…éšœæ’é™¤æŒ‡å—


**ğŸ” å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ**

| **é—®é¢˜ç°è±¡** | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ³•** |
|-------------|-------------|-------------|
| **æ—¥å¿—æ–‡ä»¶è¿‡å¤§** | è½®è½¬é…ç½®é—®é¢˜ | æ£€æŸ¥logrotateé…ç½® |
| **ç£ç›˜ç©ºé—´ä¸è¶³** | æ¸…ç†ç­–ç•¥ç¼ºå¤± | è®¾ç½®è‡ªåŠ¨æ¸…ç†è§„åˆ™ |
| **æ—¥å¿—æ ¼å¼è§£æå¤±è´¥** | æ ¼å¼å®šä¹‰é”™è¯¯ | éªŒè¯æ—¥å¿—æ ¼å¼æ­£åˆ™ |
| **ç›‘æ§å‘Šè­¦è¿‡å¤š** | é˜ˆå€¼è®¾ç½®ä¸å½“ | è°ƒæ•´å‘Šè­¦é˜ˆå€¼ |
| **æ—¥å¿—ä¸¢å¤±** | æœåŠ¡é‡å¯é—®é¢˜ | æ£€æŸ¥æœåŠ¡é…ç½® |

**ğŸ› ï¸ æ—¥å¸¸ç»´æŠ¤æ£€æŸ¥æ¸…å•**

```
âœ… æ¯æ—¥æ£€æŸ¥ï¼š
- ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ
- æ—¥å¿—è½®è½¬æ˜¯å¦æ­£å¸¸
- å‘Šè­¦æ˜¯å¦æœ‰å¼‚å¸¸

âœ… æ¯å‘¨æ£€æŸ¥ï¼š
- æ—¥å¿—åˆ†ææŠ¥å‘Šreview
- ç›‘æ§é˜ˆå€¼æ˜¯å¦åˆç†
- æ¸…ç†è¿‡æœŸæ—¥å¿—æ–‡ä»¶

âœ… æ¯æœˆæ£€æŸ¥ï¼š
- æ—¥å¿—ç®¡ç†ç­–ç•¥è¯„ä¼°
- å·¥å…·æ€§èƒ½ä¼˜åŒ–
- å®‰å…¨å®¡è®¡æŠ¥å‘Šreview
```

### 11.5 å‘å±•è¶‹åŠ¿ä¸æ‰©å±•


**ğŸš€ æŠ€æœ¯å‘å±•æ–¹å‘**

```
æ—¥å¿—ç®¡ç†æŠ€æœ¯æ¼”è¿›ï¼š
ä¼ ç»Ÿæ–‡æœ¬æ—¥å¿— â†’ ç»“æ„åŒ–æ—¥å¿— â†’ å®æ—¶æµå¤„ç† â†’ AIæ™ºèƒ½åˆ†æ
     â†“            â†“           â†“           â†“
  äººå·¥åˆ†æ    å·¥å…·è¾…åŠ©     è‡ªåŠ¨åŒ–ç›‘æ§   æ™ºèƒ½é¢„æµ‹
```

**ğŸ¯ å­¦ä¹ è¿›é˜¶è·¯å¾„**

```
å…¥é—¨çº§ â†’ ç†Ÿç»ƒçº§ â†’ ä¸“å®¶çº§
  â†“        â†“       â†“
åŸºç¡€æ¦‚å¿µ  å·¥å…·åº”ç”¨  æ¶æ„è®¾è®¡
æ—¥å¿—æ ¼å¼  åˆ†æè„šæœ¬  æ€§èƒ½ä¼˜åŒ–  
ç®€å•ç›‘æ§  å‘Šè­¦é…ç½®  å®‰å…¨å®¡è®¡
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æ—¥å¿—ç®¡ç†ä¸‰è¦ç´ ï¼šæ”¶é›†å­˜å‚¨å’Œåˆ†æ
æ ¼å¼è®¾è®¡è¦åˆç†ï¼šè¯¦ç»†é€‚åº¦é‡æ€§èƒ½  
è½®è½¬æ¸…ç†è¦åŠæ—¶ï¼šç©ºé—´ç®¡ç†ä¸å¿½è§†
ç›‘æ§å‘Šè­¦è¦æ™ºèƒ½ï¼šå‡†ç¡®åŠæ—¶ä¸æ‰°æ°‘
å®‰å…¨å®¡è®¡è¦å…¨é¢ï¼šæ”»å‡»æ£€æµ‹ä¿å¹³å®‰
é›†ä¸­ç®¡ç†æ˜¯è¶‹åŠ¿ï¼šç»Ÿä¸€åˆ†ææ•ˆç‡é«˜
```