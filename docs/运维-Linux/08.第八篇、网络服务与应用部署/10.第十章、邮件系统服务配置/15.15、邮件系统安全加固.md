---
title: 15ã€é‚®ä»¶ç³»ç»Ÿå®‰å…¨åŠ å›º
---
## ğŸ“š ç›®å½•

1. [é‚®ä»¶ç³»ç»Ÿå®‰å…¨æ¦‚è¿°](#1-é‚®ä»¶ç³»ç»Ÿå®‰å…¨æ¦‚è¿°)
2. [é˜²æ­¢å¼€æ”¾ä¸­ç»§é…ç½®](#2-é˜²æ­¢å¼€æ”¾ä¸­ç»§é…ç½®)
3. [æš´åŠ›ç ´è§£é˜²æŠ¤æªæ–½](#3-æš´åŠ›ç ´è§£é˜²æŠ¤æªæ–½)
4. [fail2bané›†æˆé…ç½®](#4-fail2bané›†æˆé…ç½®)
5. [è¯ä¹¦å®‰å…¨é…ç½®](#5-è¯ä¹¦å®‰å…¨é…ç½®)
6. [å¼±å¯†ç ç­–ç•¥é˜²æŠ¤](#6-å¼±å¯†ç ç­–ç•¥é˜²æŠ¤)
7. [æ•æ„Ÿä¿¡æ¯ä¿æŠ¤](#7-æ•æ„Ÿä¿¡æ¯ä¿æŠ¤)
8. [å®¡è®¡æ—¥å¿—é…ç½®](#8-å®¡è®¡æ—¥å¿—é…ç½®)
9. [å®‰å…¨æ›´æ–°ç­–ç•¥](#9-å®‰å…¨æ›´æ–°ç­–ç•¥)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“§ é‚®ä»¶ç³»ç»Ÿå®‰å…¨æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯é‚®ä»¶ç³»ç»Ÿå®‰å…¨


**ğŸ’¡ é€šä¿—ç†è§£**
> é‚®ä»¶ç³»ç»Ÿå®‰å…¨å°±åƒç»™ä½ å®¶çš„é‚®ç®±åŠ æŠŠé”ï¼Œç¡®ä¿åªæœ‰è¯¥æ”¶åˆ°é‚®ä»¶çš„äººèƒ½æ”¶åˆ°ï¼Œä¸è¯¥å‘é‚®ä»¶çš„äººå‘ä¸å‡ºå»ï¼Œè€Œä¸”é‚®ä»¶åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸ä¼šè¢«å·çœ‹æˆ–ç¯¡æ”¹ã€‚

**ğŸ¯ æ ¸å¿ƒå®‰å…¨ç›®æ ‡**
```
æœºå¯†æ€§ï¼šé‚®ä»¶å†…å®¹ä¸è¢«æœªæˆæƒäººå‘˜æŸ¥çœ‹
å®Œæ•´æ€§ï¼šé‚®ä»¶åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸è¢«ç¯¡æ”¹
å¯ç”¨æ€§ï¼šé‚®ä»¶æœåŠ¡æ­£å¸¸è¿è¡Œï¼Œç”¨æˆ·å¯ä»¥æ­£å¸¸æ”¶å‘é‚®ä»¶
èº«ä»½è®¤è¯ï¼šç¡®è®¤å‘ä»¶äººå’Œæ”¶ä»¶äººçš„çœŸå®èº«ä»½
ä¸å¯å¦è®¤ï¼šå‘ä»¶äººæ— æ³•å¦è®¤å·²å‘é€çš„é‚®ä»¶
```

### 1.2 é‚®ä»¶ç³»ç»Ÿé¢ä¸´çš„ä¸»è¦å¨èƒ


**ğŸš¨ å¸¸è§å®‰å…¨å¨èƒ**

| å¨èƒç±»å‹ | **å¨èƒæè¿°** | **å±å®³ç¨‹åº¦** | **é˜²æŠ¤é‡ç‚¹** |
|---------|------------|-------------|-------------|
| ğŸ”“ **å¼€æ”¾ä¸­ç»§** | `é‚®ä»¶æœåŠ¡å™¨è¢«æ¶æ„åˆ©ç”¨å‘é€åƒåœ¾é‚®ä»¶` | `â­â­â­â­â­` | `ä¸¥æ ¼çš„ä¸­ç»§æ§åˆ¶` |
| ğŸ”¨ **æš´åŠ›ç ´è§£** | `æ”»å‡»è€…å°è¯•ç ´è§£ç”¨æˆ·å¯†ç ` | `â­â­â­â­` | `ç™»å½•é™åˆ¶å’Œç›‘æ§` |
| ğŸ“Š **é‚®ä»¶çªƒå¬** | `ä¼ è¾“è¿‡ç¨‹ä¸­é‚®ä»¶è¢«æˆªè·` | `â­â­â­â­` | `åŠ å¯†ä¼ è¾“` |
| ğŸ­ **èº«ä»½ä¼ªé€ ** | `ä¼ªé€ å‘ä»¶äººèº«ä»½` | `â­â­â­` | `SPF/DKIMéªŒè¯` |
| ğŸ’€ **æ¶æ„è½¯ä»¶** | `é€šè¿‡é‚®ä»¶ä¼ æ’­ç—…æ¯’` | `â­â­â­â­` | `é‚®ä»¶è¿‡æ»¤` |

### 1.3 å®‰å…¨é˜²æŠ¤æ¶æ„


**ğŸ—ï¸ åˆ†å±‚é˜²æŠ¤ä½“ç³»**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç”¨æˆ·ç«¯å®‰å…¨               â”‚ â† å¯†ç ç­–ç•¥ã€å®¢æˆ·ç«¯é…ç½®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           ä¼ è¾“å±‚å®‰å…¨               â”‚ â† TLS/SSLåŠ å¯†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           åº”ç”¨å±‚å®‰å…¨               â”‚ â† è®¤è¯ã€æˆæƒã€è¿‡æ»¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           æœåŠ¡å™¨å®‰å…¨               â”‚ â† é…ç½®åŠ å›ºã€è¡¥ä¸æ›´æ–°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           ç½‘ç»œå±‚å®‰å…¨               â”‚ â† é˜²ç«å¢™ã€å…¥ä¾µæ£€æµ‹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸš« é˜²æ­¢å¼€æ”¾ä¸­ç»§é…ç½®


### 2.1 ä»€ä¹ˆæ˜¯å¼€æ”¾ä¸­ç»§


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> å¼€æ”¾ä¸­ç»§å°±åƒä½ å®¶çš„é‚®ç®±æ²¡æœ‰é”ï¼Œä»»ä½•äººéƒ½å¯ä»¥å¾€é‡Œé¢æŠ•é€’é‚®ä»¶ï¼Œç„¶åè¿™äº›é‚®ä»¶ä¼šè¢«è‡ªåŠ¨è½¬å‘åˆ°å…¶ä»–åœ°å€ã€‚è¿™æ ·ä½ çš„é‚®ç®±å°±æˆäº†åƒåœ¾é‚®ä»¶çš„"ä¸­è½¬ç«™"ã€‚

**âš ï¸ å¼€æ”¾ä¸­ç»§çš„å±å®³**
- **åƒåœ¾é‚®ä»¶æ³›æ»¥**ï¼šä½ çš„æœåŠ¡å™¨è¢«ç”¨æ¥å‘é€å¤§é‡åƒåœ¾é‚®ä»¶
- **IPè¢«åˆ—å…¥é»‘åå•**ï¼šå…¶ä»–é‚®ä»¶æœåŠ¡å•†ä¼šæ‹’æ”¶ä½ çš„é‚®ä»¶
- **èµ„æºæ¶ˆè€—**ï¼šå¤§é‡å ç”¨æœåŠ¡å™¨å¸¦å®½å’Œè®¡ç®—èµ„æº
- **æ³•å¾‹é£é™©**ï¼šå¯èƒ½æ‰¿æ‹…åƒåœ¾é‚®ä»¶çš„æ³•å¾‹è´£ä»»

### 2.2 Postfixä¸­ç»§æ§åˆ¶é…ç½®


**ğŸ”§ åŸºç¡€ä¸­ç»§é™åˆ¶**

ç¼–è¾‘ `/etc/postfix/main.cf`ï¼š

```bash
# é™åˆ¶ä¸­ç»§æƒé™ - åªå…è®¸ç‰¹å®šç½‘ç»œä¸­ç»§
mynetworks = 127.0.0.0/8, 192.168.1.0/24

# è¦æ±‚SASLè®¤è¯æ‰èƒ½ä¸­ç»§
smtpd_relay_restrictions = permit_mynetworks,
                          permit_sasl_authenticated,
                          defer_unauth_destination

# ç¦ç”¨ä¸å®‰å…¨çš„è®¤è¯æ–¹æ³•
smtpd_sasl_security_options = noanonymous, noplaintext
smtpd_sasl_tls_security_options = noanonymous
```

**ğŸ’¡ é…ç½®è§£é‡Š**
- `mynetworks`ï¼šå®šä¹‰å¯ä¿¡ç½‘ç»œèŒƒå›´ï¼Œåªæœ‰è¿™äº›ç½‘ç»œå¯ä»¥ç›´æ¥ä¸­ç»§
- `permit_mynetworks`ï¼šå…è®¸å¯ä¿¡ç½‘ç»œä¸­ç»§
- `permit_sasl_authenticated`ï¼šå…è®¸é€šè¿‡è®¤è¯çš„ç”¨æˆ·ä¸­ç»§
- `defer_unauth_destination`ï¼šæ‹’ç»æœªç»æˆæƒçš„ç›®æ ‡åœ°å€

### 2.3 é«˜çº§ä¸­ç»§é˜²æŠ¤


**ğŸ›¡ï¸ ä¸¥æ ¼çš„æ”¶ä»¶äººéªŒè¯**

```bash
# å¯ç”¨æ”¶ä»¶äººéªŒè¯
smtpd_recipient_restrictions = permit_mynetworks,
                              permit_sasl_authenticated,
                              reject_unauth_destination,
                              reject_unknown_recipient_domain,
                              reject_non_fqdn_recipient

# å‘ä»¶äººéªŒè¯
smtpd_sender_restrictions = permit_mynetworks,
                           permit_sasl_authenticated,
                           reject_unknown_sender_domain,
                           reject_non_fqdn_sender
```

**ğŸ“‹ ä¸­ç»§æµ‹è¯•æ–¹æ³•**

æµ‹è¯•ä½ çš„é‚®ä»¶æœåŠ¡å™¨æ˜¯å¦å­˜åœ¨å¼€æ”¾ä¸­ç»§ï¼š

```bash
# ä½¿ç”¨telnetæµ‹è¯•
telnet your-mail-server.com 25

# åœ¨SMTPä¼šè¯ä¸­å°è¯•ä¸­ç»§
HELO test.com
MAIL FROM: test@external.com
RCPT TO: victim@somewhere.com
```

å¦‚æœæœåŠ¡å™¨æ¥å—äº†è¿™ä¸ªè¯·æ±‚ï¼Œè¯´æ˜å­˜åœ¨å¼€æ”¾ä¸­ç»§é—®é¢˜ã€‚

### 2.4 ä¸­ç»§ç›‘æ§


**ğŸ“Š ç›‘æ§é…ç½®**

åˆ›å»ºç›‘æ§è„šæœ¬ `/usr/local/bin/relay_monitor.sh`ï¼š

```bash
#!/bin/bash
# ç›‘æ§å¯ç–‘çš„ä¸­ç»§è¡Œä¸º

LOG_FILE="/var/log/mail.log"
ALERT_EMAIL="admin@yourdomain.com"

# æ£€æŸ¥çŸ­æ—¶é—´å†…å¤§é‡å¤–å‘é‚®ä»¶
EXTERNAL_MAILS=$(grep "$(date '+%b %d %H:')" $LOG_FILE | \
                grep "status=sent" | \
                grep -v "@yourdomain.com" | wc -l)

if [ $EXTERNAL_MAILS -gt 100 ]; then
    echo "è­¦å‘Šï¼šæ£€æµ‹åˆ°å¤§é‡å¤–å‘é‚®ä»¶ï¼Œå¯èƒ½å­˜åœ¨ä¸­ç»§æ»¥ç”¨" | \
    mail -s "é‚®ä»¶ä¸­ç»§è­¦å‘Š" $ALERT_EMAIL
fi
```

---

## 3. ğŸ”’ æš´åŠ›ç ´è§£é˜²æŠ¤æªæ–½


### 3.1 æš´åŠ›ç ´è§£æ”»å‡»åŸç†


**ğŸ¯ æ”»å‡»æ–¹å¼**
> å°±åƒå°å·ç”¨ä¸åŒçš„é’¥åŒ™ä¸€ä¸ªä¸ªè¯•å¼€ä½ å®¶çš„é”ï¼Œæš´åŠ›ç ´è§£å°±æ˜¯æ”»å‡»è€…ç”¨å¤§é‡çš„ç”¨æˆ·åå’Œå¯†ç ç»„åˆæ¥å°è¯•ç™»å½•é‚®ä»¶æœåŠ¡å™¨ã€‚

**ğŸš¨ æ”»å‡»ç‰¹å¾**
- **çŸ­æ—¶é—´å¤šæ¬¡ç™»å½•å¤±è´¥**ï¼šåŒä¸€IPåœ¨çŸ­æ—¶é—´å†…å¤šæ¬¡è®¤è¯å¤±è´¥
- **å­—å…¸æ”»å‡»**ï¼šä½¿ç”¨å¸¸ç”¨å¯†ç åˆ—è¡¨è¿›è¡Œå°è¯•
- **åˆ†å¸ƒå¼æ”»å‡»**ï¼šä»å¤šä¸ªIPåœ°å€åŒæ—¶å‘èµ·æ”»å‡»

### 3.2 Postfixç™»å½•é™åˆ¶é…ç½®


**â±ï¸ è¿æ¥é€Ÿç‡é™åˆ¶**

åœ¨ `/etc/postfix/main.cf` ä¸­æ·»åŠ ï¼š

```bash
# é™åˆ¶åŒä¸€IPçš„è¿æ¥é¢‘ç‡
anvil_rate_time_unit = 60s
smtpd_client_connection_rate_limit = 10
smtpd_client_message_rate_limit = 20
smtpd_client_recipient_rate_limit = 50

# é™åˆ¶é”™è¯¯æ¬¡æ•°
smtpd_error_sleep_time = 1s
smtpd_soft_error_limit = 10
smtpd_hard_error_limit = 20
```

**ğŸ” è®¤è¯å¤±è´¥å¤„ç†**

```bash
# è®¤è¯å¤±è´¥å»¶è¿Ÿ
smtpd_sasl_auth_enable = yes
smtpd_sasl_security_options = noanonymous
broken_sasl_auth_clients = yes

# è®°å½•è®¤è¯å¤±è´¥
smtpd_sasl_local_domain = $myhostname
smtpd_sasl_authenticated_header = yes
```

### 3.3 Dovecotæš´åŠ›ç ´è§£é˜²æŠ¤


**ğŸ›¡ï¸ Dovecotè®¤è¯é™åˆ¶**

ç¼–è¾‘ `/etc/dovecot/conf.d/10-auth.conf`ï¼š

```bash
# è®¤è¯å¤±è´¥æƒ©ç½š
auth_failure_delay = 2s

# æœ€å¤§è®¤è¯å°è¯•æ¬¡æ•°
auth_max_worker_requests = 30

# ç¦ç”¨æ˜æ–‡è®¤è¯ï¼ˆé™¤éä½¿ç”¨SSLï¼‰
disable_plaintext_auth = yes
```

**ğŸ“ åˆ›å»ºè®¤è¯ç­–ç•¥**

åœ¨ `/etc/dovecot/conf.d/90-quota.conf` ä¸­ï¼š

```bash
# é˜²æ­¢æš´åŠ›ç ´è§£çš„IPå°ç¦ç­–ç•¥
protocol imap {
  auth_policy_server_url = http://127.0.0.1:9191/
  auth_policy_server_api_header = Authorization: Bearer secret
  auth_policy_request_attributes = login=%{requested_username} pwhash=%{hashed_password} remote=%{rip}
}
```

### 3.4 å®æ—¶ç›‘æ§ä¸å“åº”


**ğŸ“Š ç™»å½•ç›‘æ§è„šæœ¬**

åˆ›å»º `/usr/local/bin/auth_monitor.sh`ï¼š

```bash
#!/bin/bash
# ç›‘æ§è®¤è¯å¤±è´¥

LOGFILE="/var/log/mail.log"
THRESHOLD=5
TIME_WINDOW=300  # 5åˆ†é’Ÿ

# æŸ¥æ‰¾æœ€è¿‘5åˆ†é’Ÿå†…è®¤è¯å¤±è´¥è¶…è¿‡é˜ˆå€¼çš„IP
SUSPICIOUS_IPS=$(awk -v threshold=$THRESHOLD -v window=$TIME_WINDOW '
    /authentication failed/ {
        ip = gensub(/.*\[([0-9.]+)\].*/, "\\1", "g", $0)
        timestamp = systime()
        failures[ip]++
        times[ip] = timestamp
    }
    END {
        for (ip in failures) {
            if (failures[ip] >= threshold && (systime() - times[ip]) <= window) {
                print ip
            }
        }
    }' $LOGFILE)

# è‡ªåŠ¨å°ç¦å¯ç–‘IP
for ip in $SUSPICIOUS_IPS; do
    iptables -A INPUT -s $ip -j DROP
    echo "$(date): å°ç¦å¯ç–‘IP $ip" >> /var/log/security_actions.log
done
```

---

## 4. ğŸ”¥ fail2bané›†æˆé…ç½®


### 4.1 fail2banå·¥ä½œåŸç†


**ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ**
> fail2banå°±åƒä¸€ä¸ªèªæ˜çš„é—¨å«ï¼Œå®ƒä¼šç›¯ç€é—¨å£çš„ç›‘æ§å½•åƒï¼ˆæ—¥å¿—æ–‡ä»¶ï¼‰ï¼Œä¸€æ—¦å‘ç°æœ‰äººå¤šæ¬¡è¯•å›¾ç”¨é”™è¯¯çš„é’¥åŒ™å¼€é—¨ï¼ˆç™»å½•å¤±è´¥ï¼‰ï¼Œå°±ä¼šæŠŠè¿™ä¸ªäººæš‚æ—¶æ‹‰å…¥é»‘åå•ã€‚

**âš™ï¸ å·¥ä½œæµç¨‹**
```
ç›‘æ§æ—¥å¿— â†’ åŒ¹é…æ¨¡å¼ â†’ è§¦å‘æ¡ä»¶ â†’ æ‰§è¡ŒåŠ¨ä½œ â†’ è®°å½•äº‹ä»¶
    â†“         â†“         â†“         â†“         â†“
  tail -f   æ­£åˆ™è¡¨è¾¾å¼  å¤±è´¥æ¬¡æ•°   iptables   ban.log
```

### 4.2 å®‰è£…å’ŒåŸºç¡€é…ç½®


**ğŸ“¦ å®‰è£…fail2ban**

```bash
# CentOS/RHEL
yum install fail2ban -y

# Ubuntu/Debian  
apt-get install fail2ban -y

# å¯åŠ¨æœåŠ¡
systemctl enable fail2ban
systemctl start fail2ban
```

**âš™ï¸ ä¸»é…ç½®æ–‡ä»¶**

ç¼–è¾‘ `/etc/fail2ban/jail.local`ï¼š

```ini
[DEFAULT]
# å°ç¦æ—¶é—´ï¼ˆç§’ï¼‰
bantime = 3600

# ç›‘æ§æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
findtime = 600

# æœ€å¤§å°è¯•æ¬¡æ•°
maxretry = 3

# å¿½ç•¥çš„IPåœ°å€ï¼ˆç™½åå•ï¼‰
ignoreip = 127.0.0.1/8 192.168.1.0/24

# å°ç¦åŠ¨ä½œ
banaction = iptables-multiport
```

### 4.3 é‚®ä»¶æœåŠ¡ä¸“ç”¨é…ç½®


**ğŸ“§ Postfixä¿æŠ¤é…ç½®**

åœ¨ `/etc/fail2ban/jail.local` ä¸­æ·»åŠ ï¼š

```ini
[postfix-sasl]
enabled = true
port = smtp,465,submission
filter = postfix-sasl
logpath = /var/log/mail.log
maxretry = 3
bantime = 3600

[postfix-rbl]
enabled = true
port = smtp,465,submission  
filter = postfix-rbl
logpath = /var/log/mail.log
maxretry = 1
bantime = 3600
```

**ğŸ“¬ Dovecotä¿æŠ¤é…ç½®**

```ini
[dovecot]
enabled = true
port = pop3,pop3s,imap,imaps
filter = dovecot
logpath = /var/log/mail.log
maxretry = 3
bantime = 3600

[dovecot-pop3imap]
enabled = true
port = pop3,pop3s,imap,imaps
filter = dovecot
logpath = /var/log/dovecot.log
maxretry = 3
bantime = 3600
```

### 4.4 è‡ªå®šä¹‰è¿‡æ»¤è§„åˆ™


**ğŸ” åˆ›å»ºè‡ªå®šä¹‰è¿‡æ»¤å™¨**

åˆ›å»º `/etc/fail2ban/filter.d/postfix-bruteforce.conf`ï¼š

```ini
[Definition]
# æ£€æµ‹Postfixæš´åŠ›ç ´è§£
failregex = postfix/smtpd\[\d+\]: warning: .*\[<HOST>\]: SASL .* authentication failed
            postfix/smtpd\[\d+\]: lost connection after AUTH from .*\[<HOST>\]

# å¿½ç•¥çš„æ­£å¸¸æƒ…å†µ
ignoreregex = 

# æ—¥å¿—æ—¶é—´æ ¼å¼
datepattern = ^%%b\s+%%d\s+%%H:%%M:%%S
```

**ğŸ“Š ç›‘æ§æ•ˆæœ**

æ£€æŸ¥fail2bançŠ¶æ€ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰jailçŠ¶æ€
fail2ban-client status

# æŸ¥çœ‹ç‰¹å®šjailçš„è¯¦ç»†ä¿¡æ¯
fail2ban-client status postfix-sasl

# æŸ¥çœ‹è¢«å°ç¦çš„IP
fail2ban-client get postfix-sasl banip

# æ‰‹åŠ¨è§£å°IP
fail2ban-client set postfix-sasl unbanip 192.168.1.100
```

---

## 5. ğŸ” è¯ä¹¦å®‰å…¨é…ç½®


### 5.1 TLS/SSLåŠ å¯†åŸç†


**ğŸ”’ åŠ å¯†é€šä¿¡å¿…è¦æ€§**
> å°±åƒä½ å¯„ä¿¡æ—¶æŠŠä¿¡ä»¶æ”¾åœ¨å¯†å°çš„ä¿¡å°é‡Œï¼ŒTLS/SSLåŠ å¯†ç¡®ä¿é‚®ä»¶åœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­ä¸ä¼šè¢«å·çœ‹æˆ–ç¯¡æ”¹ã€‚

**ğŸ“Š åŠ å¯†æ•ˆæœå¯¹æ¯”**

| é€šä¿¡æ–¹å¼ | **å®‰å…¨æ€§** | **æ€§èƒ½å½±å“** | **é…ç½®å¤æ‚åº¦** | **æ¨èç¨‹åº¦** |
|---------|-----------|-------------|---------------|-------------|
| æ˜æ–‡ä¼ è¾“ | `ğŸ”´ æå±é™©` | `ğŸŸ¢ æ— å½±å“` | `ğŸŸ¢ ç®€å•` | `âŒ ç¦æ­¢ä½¿ç”¨` |
| STARTTLS | `ğŸŸ¡ ä¸€èˆ¬` | `ğŸŸ¡ è½»å¾®å½±å“` | `ğŸŸ¡ ä¸­ç­‰` | `âš ï¸ å¯é€‰åŠ å¯†` |
| å¼ºåˆ¶TLS | `ğŸŸ¢ å®‰å…¨` | `ğŸŸ¡ è½»å¾®å½±å“` | `ğŸŸ¡ ä¸­ç­‰` | `âœ… æ¨è` |
| åŒå‘è®¤è¯ | `ğŸŸ¢ å¾ˆå®‰å…¨` | `ğŸŸ  ä¸€å®šå½±å“` | `ğŸ”´ å¤æ‚` | `ğŸ† æœ€ä½³å®è·µ` |

### 5.2 Let's Encryptå…è´¹è¯ä¹¦


**ğŸ†“ è·å–å…è´¹SSLè¯ä¹¦**

```bash
# å®‰è£…certbot
yum install certbot -y  # CentOS
apt install certbot -y  # Ubuntu

# è·å–è¯ä¹¦
certbot certonly --standalone -d mail.yourdomain.com

# è¯ä¹¦å°†ä¿å­˜åœ¨ï¼š
# /etc/letsencrypt/live/mail.yourdomain.com/fullchain.pem
# /etc/letsencrypt/live/mail.yourdomain.com/privkey.pem
```

**ğŸ”„ è‡ªåŠ¨ç»­æœŸé…ç½®**

åˆ›å»ºç»­æœŸè„šæœ¬ `/usr/local/bin/renew_certificates.sh`ï¼š

```bash
#!/bin/bash
# è‡ªåŠ¨ç»­æœŸLet's Encryptè¯ä¹¦

DOMAIN="mail.yourdomain.com"
CERT_PATH="/etc/letsencrypt/live/$DOMAIN"

# ç»­æœŸè¯ä¹¦
certbot renew --quiet

# æ£€æŸ¥è¯ä¹¦æ˜¯å¦æ›´æ–°
if [ $? -eq 0 ]; then
    # é‡å¯æœåŠ¡ä»¥åŠ è½½æ–°è¯ä¹¦
    systemctl reload postfix
    systemctl reload dovecot
    
    echo "$(date): è¯ä¹¦ç»­æœŸæˆåŠŸ" >> /var/log/cert_renewal.log
else
    echo "$(date): è¯ä¹¦ç»­æœŸå¤±è´¥" >> /var/log/cert_renewal.log
fi
```

æ·»åŠ åˆ°crontabï¼š
```bash
# æ¯å¤©æ£€æŸ¥ä¸€æ¬¡è¯ä¹¦ç»­æœŸ
0 2 * * * /usr/local/bin/renew_certificates.sh
```

### 5.3 Postfix TLSé…ç½®


**ğŸ”’ Postfix SSL/TLSè®¾ç½®**

åœ¨ `/etc/postfix/main.cf` ä¸­é…ç½®ï¼š

```bash
# TLSåŸºç¡€é…ç½®
smtpd_use_tls = yes
smtpd_tls_cert_file = /etc/letsencrypt/live/mail.yourdomain.com/fullchain.pem
smtpd_tls_key_file = /etc/letsencrypt/live/mail.yourdomain.com/privkey.pem

# å¼ºåˆ¶ä½¿ç”¨TLS
smtpd_tls_security_level = may
smtpd_tls_auth_only = yes

# TLSåè®®ç‰ˆæœ¬å’ŒåŠ å¯†å¥—ä»¶
smtpd_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtpd_tls_ciphers = high
smtpd_tls_mandatory_ciphers = high

# å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯
smtpd_tls_ask_ccert = yes
smtpd_tls_loglevel = 1
```

**ğŸ“® SMTPæäº¤ç«¯å£é…ç½®**

ç¼–è¾‘ `/etc/postfix/master.cf`ï¼š

```bash
# 587ç«¯å£ - æäº¤ç«¯å£ï¼ˆSTARTTLSï¼‰
submission inet n       -       n       -       -       smtpd
  -o syslog_name=postfix/submission
  -o smtpd_tls_security_level=encrypt
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_client_restrictions=permit_sasl_authenticated,reject

# 465ç«¯å£ - SMTPSï¼ˆSSLåŒ…è£…ï¼‰
smtps     inet  n       -       n       -       -       smtpd
  -o syslog_name=postfix/smtps
  -o smtpd_tls_wrappermode=yes
  -o smtpd_sasl_auth_enable=yes
```

### 5.4 Dovecot TLSé…ç½®


**ğŸ” Dovecot SSLè®¾ç½®**

ç¼–è¾‘ `/etc/dovecot/conf.d/10-ssl.conf`ï¼š

```bash
# å¯ç”¨SSL
ssl = required

# è¯ä¹¦æ–‡ä»¶è·¯å¾„
ssl_cert = </etc/letsencrypt/live/mail.yourdomain.com/fullchain.pem
ssl_key = </etc/letsencrypt/live/mail.yourdomain.com/privkey.pem

# SSLåè®®å’ŒåŠ å¯†è®¾ç½®
ssl_protocols = !SSLv2 !SSLv3 !TLSv1 !TLSv1.1
ssl_cipher_list = ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS
ssl_prefer_server_ciphers = yes

# DHå‚æ•°
ssl_dh = </etc/dovecot/dh.pem
```

**ğŸ”‘ ç”ŸæˆDHå‚æ•°**

```bash
# ç”Ÿæˆå¼ºDHå‚æ•°ï¼ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰
openssl dhparam -out /etc/dovecot/dh.pem 4096
chown dovecot:dovecot /etc/dovecot/dh.pem
chmod 600 /etc/dovecot/dh.pem
```

---

## 6. ğŸ›¡ï¸ å¼±å¯†ç ç­–ç•¥é˜²æŠ¤


### 6.1 å¯†ç ç­–ç•¥çš„é‡è¦æ€§


**ğŸ”‘ å¯†ç å®‰å…¨åŸºç¡€**
> å¯†ç å°±åƒä½ å®¶çš„é’¥åŒ™ï¼Œå¦‚æœç”¨çš„æ˜¯ç®€å•çš„123456ï¼Œå°±ç­‰äºæŠŠä¸€æŠŠä¸‡èƒ½é’¥åŒ™ç»™äº†æ‰€æœ‰çš„å°å·ã€‚å¼ºå¯†ç ç­–ç•¥ç¡®ä¿æ¯ä¸ªç”¨æˆ·éƒ½æœ‰ä¸€æŠŠç‹¬ç‰¹ä¸”å¤æ‚çš„"é’¥åŒ™"ã€‚

**âš ï¸ å¼±å¯†ç çš„å±å®³**
- **æš´åŠ›ç ´è§£æ˜“æˆåŠŸ**ï¼šç®€å•å¯†ç å¾ˆå¿«è¢«ç ´è§£
- **æ’åº“æ”»å‡»**ï¼šå…¶ä»–ç½‘ç«™æ³„éœ²çš„å¯†ç è¢«ç”¨æ¥æ”»å‡»é‚®ä»¶è´¦æˆ·
- **ç¤¾ä¼šå·¥ç¨‹å­¦**ï¼šå®¹æ˜“è¢«çŒœæµ‹çš„ä¸ªäººä¿¡æ¯å¯†ç 

### 6.2 ç³»ç»Ÿçº§å¯†ç ç­–ç•¥


**ğŸ”’ PAMå¯†ç å¼ºåº¦è®¾ç½®**

ç¼–è¾‘ `/etc/pam.d/passwd`ï¼š

```bash
# å¯†ç å¤æ‚åº¦è¦æ±‚
password requisite pam_pwquality.so retry=3 \
    minlen=12 \
    dcredit=-1 \
    ucredit=-1 \
    ocredit=-1 \
    lcredit=-1 \
    difok=3 \
    maxrepeat=2
```

**ğŸ“‹ é…ç½®å‚æ•°è¯´æ˜**
- `minlen=12`ï¼šæœ€å°é•¿åº¦12ä½
- `dcredit=-1`ï¼šè‡³å°‘åŒ…å«1ä¸ªæ•°å­—
- `ucredit=-1`ï¼šè‡³å°‘åŒ…å«1ä¸ªå¤§å†™å­—æ¯
- `lcredit=-1`ï¼šè‡³å°‘åŒ…å«1ä¸ªå°å†™å­—æ¯
- `ocredit=-1`ï¼šè‡³å°‘åŒ…å«1ä¸ªç‰¹æ®Šå­—ç¬¦
- `difok=3`ï¼šä¸æ—§å¯†ç è‡³å°‘3ä¸ªå­—ç¬¦ä¸åŒ
- `maxrepeat=2`ï¼šç›¸åŒå­—ç¬¦æœ€å¤šè¿ç»­å‡ºç°2æ¬¡

### 6.3 å¯†ç æœ‰æ•ˆæœŸç®¡ç†


**â° å¯†ç è¿‡æœŸç­–ç•¥**

ç¼–è¾‘ `/etc/login.defs`ï¼š

```bash
# å¯†ç æœ€å¤§æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
PASS_MAX_DAYS   90

# å¯†ç æœ€å°æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
PASS_MIN_DAYS   7

# å¯†ç è¿‡æœŸè­¦å‘ŠæœŸï¼ˆå¤©ï¼‰
PASS_WARN_AGE   7

# å¯†ç æœ€å°é•¿åº¦
PASS_MIN_LEN    12
```

**ğŸ‘¤ ç”¨æˆ·å¯†ç ç­–ç•¥ç®¡ç†**

```bash
# æŸ¥çœ‹ç”¨æˆ·å¯†ç ç­–ç•¥
chage -l username

# è®¾ç½®å¯†ç æœ‰æ•ˆæœŸ
chage -M 90 username

# å¼ºåˆ¶ç”¨æˆ·ä¸‹æ¬¡ç™»å½•ä¿®æ”¹å¯†ç 
chage -d 0 username

# è®¾ç½®è´¦æˆ·è¿‡æœŸæ—¶é—´
chage -E 2024-12-31 username
```

### 6.4 å¯†ç è´¨é‡æ£€æŸ¥å·¥å…·


**ğŸ” å¯†ç å¼ºåº¦æ£€æµ‹è„šæœ¬**

åˆ›å»º `/usr/local/bin/check_password_strength.py`ï¼š

```python
#!/usr/bin/env python3
import re
import sys

def check_password_strength(password):
    """æ£€æŸ¥å¯†ç å¼ºåº¦"""
    score = 0
    feedback = []
    
    # é•¿åº¦æ£€æŸ¥
    if len(password) >= 12:
        score += 2
    elif len(password) >= 8:
        score += 1
    else:
        feedback.append("å¯†ç é•¿åº¦è‡³å°‘éœ€è¦8ä½ï¼Œå»ºè®®12ä½ä»¥ä¸Š")
    
    # å­—ç¬¦ç§ç±»æ£€æŸ¥
    if re.search(r'[a-z]', password):
        score += 1
    else:
        feedback.append("ç¼ºå°‘å°å†™å­—æ¯")
        
    if re.search(r'[A-Z]', password):
        score += 1
    else:
        feedback.append("ç¼ºå°‘å¤§å†™å­—æ¯")
        
    if re.search(r'\d', password):
        score += 1
    else:
        feedback.append("ç¼ºå°‘æ•°å­—")
        
    if re.search(r'[!@#$%^&*(),.?":{}|<>]', password):
        score += 1
    else:
        feedback.append("ç¼ºå°‘ç‰¹æ®Šå­—ç¬¦")
    
    # å¸¸è§å¼±å¯†ç æ£€æŸ¥
    weak_patterns = [
        r'123456', r'password', r'admin', r'qwerty',
        r'(.)\1{2,}',  # è¿ç»­ç›¸åŒå­—ç¬¦
        r'(012|123|234|345|456|567|678|789|890)',  # è¿ç»­æ•°å­—
    ]
    
    for pattern in weak_patterns:
        if re.search(pattern, password.lower()):
            score -= 2
            feedback.append("åŒ…å«å¸¸è§å¼±å¯†ç æ¨¡å¼")
            break
    
    # è¯„åˆ†
    if score >= 6:
        strength = "å¼º"
    elif score >= 4:
        strength = "ä¸­ç­‰"
    else:
        strength = "å¼±"
    
    return strength, score, feedback

if __name__ == "__main__":
    password = input("è¯·è¾“å…¥å¯†ç ï¼š")
    strength, score, feedback = check_password_strength(password)
    
    print(f"å¯†ç å¼ºåº¦ï¼š{strength} (å¾—åˆ†ï¼š{score})")
    if feedback:
        print("æ”¹è¿›å»ºè®®ï¼š")
        for item in feedback:
            print(f"  - {item}")
```

### 6.5 å¸¸ç”¨å¯†ç é»‘åå•


**ğŸ“ åˆ›å»ºå¯†ç é»‘åå•**

åˆ›å»º `/etc/security/blacklist_passwords.txt`ï¼š

```text
# å¸¸è§å¼±å¯†ç åˆ—è¡¨
123456
password
123456789
qwerty
abc123
password123
admin
root
user
guest
welcome
login
```

**ğŸ”’ é›†æˆåˆ°PAM**

ç¼–è¾‘ `/etc/pam.d/passwd`ï¼Œæ·»åŠ ï¼š

```bash
password requisite pam_pwquality.so \
    dictpath=/etc/security/blacklist_passwords.txt \
    reject_username
```

---

## 7. ğŸ” æ•æ„Ÿä¿¡æ¯ä¿æŠ¤


### 7.1 æ•æ„Ÿä¿¡æ¯è¯†åˆ«


**ğŸ¯ é‚®ä»¶ç³»ç»Ÿä¸­çš„æ•æ„Ÿä¿¡æ¯**

| ä¿¡æ¯ç±»å‹ | **å­˜å‚¨ä½ç½®** | **é£é™©ç­‰çº§** | **ä¿æŠ¤æªæ–½** |
|---------|-------------|-------------|-------------|
| ğŸ”‘ **ç”¨æˆ·å¯†ç ** | `æ•°æ®åº“/é…ç½®æ–‡ä»¶` | `ğŸ”´ æé«˜` | `å“ˆå¸Œå­˜å‚¨+ç›å€¼` |
| ğŸ“§ **é‚®ä»¶å†…å®¹** | `é‚®ç®±ç›®å½•` | `ğŸŸ  é«˜` | `æ–‡ä»¶ç³»ç»ŸåŠ å¯†` |
| ğŸ” **SSLç§é’¥** | `è¯ä¹¦ç›®å½•` | `ğŸ”´ æé«˜` | `æƒé™é™åˆ¶+å¤‡ä»½åŠ å¯†` |
| ğŸ“ **é…ç½®æ–‡ä»¶** | `ç³»ç»Ÿç›®å½•` | `ğŸŸ¡ ä¸­` | `æƒé™æ§åˆ¶+ç‰ˆæœ¬ç®¡ç†` |
| ğŸ“Š **æ—¥å¿—æ–‡ä»¶** | `æ—¥å¿—ç›®å½•` | `ğŸŸ¡ ä¸­` | `æ•æ„Ÿä¿¡æ¯è¿‡æ»¤` |

### 7.2 å¯†ç å­˜å‚¨å®‰å…¨


**ğŸ”’ Dovecotå¯†ç å“ˆå¸Œé…ç½®**

ç¼–è¾‘ `/etc/dovecot/conf.d/auth-passwdfile.conf.ext`ï¼š

```bash
# ä½¿ç”¨å¼ºå“ˆå¸Œç®—æ³•
passdb {
  driver = passwd-file
  args = scheme=ARGON2ID username_format=%u /etc/dovecot/users
}

userdb {
  driver = passwd-file
  args = username_format=%u /etc/dovecot/users
}
```

**ğŸ§‚ åˆ›å»ºç”¨æˆ·æ—¶ä½¿ç”¨å¼ºå“ˆå¸Œ**

```bash
# ç”ŸæˆARGON2IDå“ˆå¸Œå¯†ç 
doveadm pw -s ARGON2ID -p userpassword

# ç¤ºä¾‹è¾“å‡ºï¼š{ARGON2ID}$argon2id$v=19$m=65536,t=3,p=4$...

# æ·»åŠ åˆ°ç”¨æˆ·æ–‡ä»¶
echo "username:{ARGON2ID}$argon2id$..." >> /etc/dovecot/users
```

### 7.3 æ–‡ä»¶ç³»ç»ŸåŠ å¯†


**ğŸ’¾ é‚®ç®±ç›®å½•åŠ å¯†**

ä½¿ç”¨ `encfs` åŠ å¯†é‚®ç®±å­˜å‚¨ï¼š

```bash
# å®‰è£…encfs
yum install fuse-encfs -y  # CentOS
apt install encfs -y       # Ubuntu

# åˆ›å»ºåŠ å¯†é‚®ç®±ç›®å½•
mkdir /encrypted/mailboxes
mkdir /decrypted/mailboxes

# è®¾ç½®åŠ å¯†
encfs /encrypted/mailboxes /decrypted/mailboxes
```

**ğŸ” è‡ªåŠ¨æŒ‚è½½è„šæœ¬**

åˆ›å»º `/usr/local/bin/mount_mailboxes.sh`ï¼š

```bash
#!/bin/bash
# è‡ªåŠ¨æŒ‚è½½åŠ å¯†é‚®ç®±ç›®å½•

ENCRYPTED_DIR="/encrypted/mailboxes"
DECRYPTED_DIR="/decrypted/mailboxes"
PASSWORD_FILE="/root/.encfs_password"

# æ£€æŸ¥æ˜¯å¦å·²æŒ‚è½½
if ! mountpoint -q "$DECRYPTED_DIR"; then
    # ä»å®‰å…¨æ–‡ä»¶è¯»å–å¯†ç å¹¶æŒ‚è½½
    cat "$PASSWORD_FILE" | encfs -S "$ENCRYPTED_DIR" "$DECRYPTED_DIR"
    
    if [ $? -eq 0 ]; then
        echo "$(date): é‚®ç®±ç›®å½•åŠ å¯†æŒ‚è½½æˆåŠŸ" >> /var/log/encryption.log
        # è®¾ç½®æ­£ç¡®çš„æƒé™
        chown -R vmail:vmail "$DECRYPTED_DIR"
    else
        echo "$(date): é‚®ç®±ç›®å½•åŠ å¯†æŒ‚è½½å¤±è´¥" >> /var/log/encryption.log
    fi
fi
```

### 7.4 é…ç½®æ–‡ä»¶å®‰å…¨


**ğŸ”’ æ•æ„Ÿé…ç½®æ–‡ä»¶æƒé™**

```bash
# è®¾ç½®é…ç½®æ–‡ä»¶æƒé™
chmod 600 /etc/postfix/main.cf
chmod 600 /etc/dovecot/dovecot.conf
chmod 600 /etc/postfix/mysql_*.cf

# è®¾ç½®æ‰€æœ‰è€…
chown root:root /etc/postfix/main.cf
chown root:dovecot /etc/dovecot/dovecot.conf

# SSLè¯ä¹¦æƒé™
chmod 400 /etc/letsencrypt/live/*/privkey.pem
chown root:root /etc/letsencrypt/live/*/privkey.pem
```

**ğŸ“ é…ç½®æ–‡ä»¶å¤‡ä»½åŠ å¯†**

åˆ›å»ºåŠ å¯†å¤‡ä»½è„šæœ¬ `/usr/local/bin/backup_configs.sh`ï¼š

```bash
#!/bin/bash
# åŠ å¯†å¤‡ä»½é…ç½®æ–‡ä»¶

BACKUP_DIR="/backup/mail_configs"
DATE=$(date +%Y%m%d_%H%M%S)
ARCHIVE_NAME="mail_config_${DATE}.tar.gz"
GPG_RECIPIENT="admin@yourdomain.com"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# æ‰“åŒ…é…ç½®æ–‡ä»¶
tar -czf "/tmp/$ARCHIVE_NAME" \
    /etc/postfix/ \
    /etc/dovecot/ \
    /etc/fail2ban/jail.local

# GPGåŠ å¯†å¤‡ä»½
gpg --trust-model always \
    --encrypt \
    --recipient "$GPG_RECIPIENT" \
    --output "$BACKUP_DIR/${ARCHIVE_NAME}.gpg" \
    "/tmp/$ARCHIVE_NAME"

# åˆ é™¤ä¸´æ—¶æ–‡ä»¶
rm "/tmp/$ARCHIVE_NAME"

echo "$(date): é…ç½®æ–‡ä»¶å¤‡ä»½å®Œæˆ: ${ARCHIVE_NAME}.gpg" >> /var/log/backup.log
```

### 7.5 æ—¥å¿—æ•æ„Ÿä¿¡æ¯è¿‡æ»¤


**ğŸ” Postfixæ—¥å¿—è¿‡æ»¤**

ç¼–è¾‘ `/etc/rsyslog.d/postfix.conf`ï¼š

```bash
# è¿‡æ»¤æ•æ„Ÿä¿¡æ¯çš„æ—¥å¿—è§„åˆ™
:msg, contains, "SASL" ~
:msg, regex, ".*password.*" ~
:msg, regex, ".*login.*" /var/log/mail_auth.log
& stop
```

**ğŸ“Š æ—¥å¿—æ¸…ç†è„šæœ¬**

åˆ›å»º `/usr/local/bin/sanitize_logs.sh`ï¼š

```bash
#!/bin/bash
# æ¸…ç†æ—¥å¿—ä¸­çš„æ•æ„Ÿä¿¡æ¯

LOG_FILES=(
    "/var/log/mail.log"
    "/var/log/dovecot.log"
)

for log_file in "${LOG_FILES[@]}"; do
    if [ -f "$log_file" ]; then
        # æ›¿æ¢å¯èƒ½çš„å¯†ç ä¿¡æ¯
        sed -i 's/password=[^[:space:]]*/password=***FILTERED***/g' "$log_file"
        
        # æ›¿æ¢è®¤è¯token
        sed -i 's/auth=[^[:space:]]*/auth=***FILTERED***/g' "$log_file"
        
        echo "$(date): å·²æ¸…ç† $log_file ä¸­çš„æ•æ„Ÿä¿¡æ¯" >> /var/log/log_sanitization.log
    fi
done
```

---

## 8. ğŸ“Š å®¡è®¡æ—¥å¿—é…ç½®


### 8.1 å®¡è®¡æ—¥å¿—çš„é‡è¦æ€§


**ğŸ” ä¸ºä»€ä¹ˆéœ€è¦å®¡è®¡æ—¥å¿—**
> å®¡è®¡æ—¥å¿—å°±åƒç›‘æ§æ‘„åƒå¤´ï¼Œè®°å½•é‚®ä»¶ç³»ç»Ÿä¸­å‘ç”Ÿçš„æ‰€æœ‰é‡è¦äº‹ä»¶ã€‚å½“å‡ºç°å®‰å…¨é—®é¢˜æ—¶ï¼Œå®ƒèƒ½å¸®ä½ æ‰¾åˆ°"è°åœ¨ä»€ä¹ˆæ—¶å€™åšäº†ä»€ä¹ˆ"ã€‚

**ğŸ“‹ å…³é”®å®¡è®¡äº‹ä»¶**
- **ç”¨æˆ·è®¤è¯**ï¼šç™»å½•æˆåŠŸ/å¤±è´¥ã€å¯†ç ä¿®æ”¹
- **é‚®ä»¶æ“ä½œ**ï¼šå‘é€ã€æ¥æ”¶ã€åˆ é™¤ã€ç§»åŠ¨é‚®ä»¶
- **ç®¡ç†æ“ä½œ**ï¼šé…ç½®ä¿®æ”¹ã€ç”¨æˆ·ç®¡ç†ã€æƒé™å˜æ›´
- **å®‰å…¨äº‹ä»¶**ï¼šæ”»å‡»å°è¯•ã€å¼‚å¸¸è¡Œä¸ºã€ç³»ç»Ÿé”™è¯¯

### 8.2 ç³»ç»Ÿçº§å®¡è®¡é…ç½®


**ğŸ”§ auditdå®¡è®¡é…ç½®**

ç¼–è¾‘ `/etc/audit/rules.d/mail.rules`ï¼š

```bash
# ç›‘æ§é‚®ä»¶é…ç½®æ–‡ä»¶ä¿®æ”¹
-w /etc/postfix/ -p wa -k postfix_config
-w /etc/dovecot/ -p wa -k dovecot_config

# ç›‘æ§é‚®ä»¶äºŒè¿›åˆ¶æ–‡ä»¶
-w /usr/sbin/postfix -p x -k postfix_exec
-w /usr/sbin/dovecot -p x -k dovecot_exec

# ç›‘æ§é‚®ç®±ç›®å½•è®¿é—®
-w /var/mail/ -p rwa -k mailbox_access
-w /home/vmail/ -p rwa -k vmail_access

# ç›‘æ§SSLè¯ä¹¦æ–‡ä»¶
-w /etc/letsencrypt/ -p wa -k ssl_certs

# ç›‘æ§ç”¨æˆ·è®¤è¯
-w /etc/passwd -p wa -k user_modification
-w /etc/shadow -p wa -k password_modification
```

**ğŸ”„ é‡æ–°åŠ è½½å®¡è®¡è§„åˆ™**

```bash
# é‡æ–°åŠ è½½è§„åˆ™
augenrules --load

# é‡å¯auditdæœåŠ¡
systemctl restart auditd

# æ£€æŸ¥è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆ
auditctl -l
```

### 8.3 Postfixè¯¦ç»†æ—¥å¿—é…ç½®


**ğŸ“ å¯ç”¨è¯¦ç»†æ—¥å¿—**

åœ¨ `/etc/postfix/main.cf` ä¸­æ·»åŠ ï¼š

```bash
# è¯¦ç»†æ—¥å¿—çº§åˆ«
debug_peer_level = 2
debug_peer_list = 

# è®°å½•æ‰€æœ‰SMTPå¯¹è¯
smtpd_tls_loglevel = 2
smtp_tls_loglevel = 2

# è®°å½•SASLè®¤è¯è¯¦æƒ…
smtpd_sasl_auth_enable = yes
smtpd_sasl_authenticated_header = yes

# è®°å½•å®¢æˆ·ç«¯ä¿¡æ¯
smtpd_client_restrictions = permit_mynetworks,
                           warn_if_reject reject_unknown_client_hostname,
                           permit
```

**ğŸ“Š è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼**

åˆ›å»º `/etc/rsyslog.d/mail_audit.conf`ï¼š

```bash
# åˆ›å»ºä¸“é—¨çš„å®¡è®¡æ—¥å¿—
$template MailAuditFormat,"%timegenerated% %HOSTNAME% %syslogtag% %msg%\n"

# Postfixå®¡è®¡æ—¥å¿—
mail.info /var/log/mail_audit.log;MailAuditFormat
& stop

# è®¤è¯å®¡è®¡æ—¥å¿—
auth,authpriv.* /var/log/auth_audit.log;MailAuditFormat
& stop
```

### 8.4 Dovecotå®¡è®¡é…ç½®


**ğŸ” Dovecotè¯¦ç»†å®¡è®¡**

ç¼–è¾‘ `/etc/dovecot/conf.d/10-logging.conf`ï¼š

```bash
# è¯¦ç»†æ—¥å¿—çº§åˆ«
log_debug = category=all

# å®¡è®¡æ—¥å¿—æ ¼å¼
log_timestamp = "%Y-%m-%d %H:%M:%S "

# è®°å½•é‚®ä»¶æ“ä½œ
mail_log_events = delete undelete expunge copy mailbox_delete mailbox_rename
mail_log_fields = uid box msgid size

# è®¤è¯å®¡è®¡
auth_verbose = yes
auth_verbose_passwords = plain
auth_debug = yes
auth_debug_passwords = yes
```

**ğŸ“§ IMAP/POP3æ“ä½œå®¡è®¡**

åœ¨ `/etc/dovecot/conf.d/20-imap.conf` ä¸­ï¼š

```bash
protocol imap {
  # è®°å½•IMAPå‘½ä»¤
  imap_logout_format = in=%i out=%o
  
  # å®¡è®¡æ’ä»¶
  mail_plugins = $mail_plugins audit
}
```

### 8.5 æ—¥å¿—åˆ†æå’Œç›‘æ§


**ğŸ“Š åˆ›å»ºæ—¥å¿—åˆ†æè„šæœ¬**

åˆ›å»º `/usr/local/bin/mail_log_analyzer.sh`ï¼š

```bash
#!/bin/bash
# é‚®ä»¶æ—¥å¿—åˆ†æè„šæœ¬

LOG_FILE="/var/log/mail_audit.log"
REPORT_FILE="/var/log/mail_security_report.txt"
DATE=$(date +%Y-%m-%d)

echo "é‚®ä»¶ç³»ç»Ÿå®‰å…¨æŠ¥å‘Š - $DATE" > $REPORT_FILE
echo "=================================" >> $REPORT_FILE

# ç»Ÿè®¡è®¤è¯å¤±è´¥
echo "è®¤è¯å¤±è´¥ç»Ÿè®¡:" >> $REPORT_FILE
grep "authentication failed" $LOG_FILE | \
    awk '{print $6}' | sort | uniq -c | sort -rn | head -10 >> $REPORT_FILE

echo "" >> $REPORT_FILE

# ç»Ÿè®¡å‘é€é‚®ä»¶æœ€å¤šçš„ç”¨æˆ·
echo "å‘é€é‚®ä»¶æœ€å¤šçš„ç”¨æˆ·:" >> $REPORT_FILE
grep "status=sent" $LOG_FILE | \
    grep -o "from=<[^>]*>" | sort | uniq -c | sort -rn | head -10 >> $REPORT_FILE

echo "" >> $REPORT_FILE

# ç»Ÿè®¡å¤–éƒ¨è¿æ¥æœ€å¤šçš„IP
echo "å¤–éƒ¨è¿æ¥æœ€å¤šçš„IP:" >> $REPORT_FILE
grep "connect from" $LOG_FILE | \
    grep -o "\[[0-9.]*\]" | sort | uniq -c | sort -rn | head -10 >> $REPORT_FILE

# å‘é€æŠ¥å‘Šé‚®ä»¶
mail -s "é‚®ä»¶ç³»ç»Ÿå®‰å…¨æŠ¥å‘Š - $DATE" admin@yourdomain.com < $REPORT_FILE
```

**â° å®šæ—¶æ‰§è¡Œåˆ†æ**

æ·»åŠ åˆ°crontabï¼š

```bash
# æ¯å¤©æ—©ä¸Š8ç‚¹ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
0 8 * * * /usr/local/bin/mail_log_analyzer.sh

# æ¯å°æ—¶æ£€æŸ¥å¼‚å¸¸æ´»åŠ¨
0 * * * * /usr/local/bin/check_mail_anomalies.sh
```

**ğŸš¨ å®æ—¶ç›‘æ§è„šæœ¬**

åˆ›å»º `/usr/local/bin/mail_realtime_monitor.sh`ï¼š

```bash
#!/bin/bash
# å®æ—¶ç›‘æ§é‚®ä»¶å®‰å…¨äº‹ä»¶

LOG_FILE="/var/log/mail.log"
ALERT_EMAIL="security@yourdomain.com"

# ç›‘æ§è®¤è¯å¤±è´¥
tail -f $LOG_FILE | while read line; do
    # æ£€æµ‹æš´åŠ›ç ´è§£
    if echo "$line" | grep -q "authentication failed"; then
        IP=$(echo "$line" | grep -o "\[[0-9.]*\]" | tr -d '[]')
        
        # æ£€æŸ¥æœ€è¿‘5åˆ†é’Ÿå†…çš„å¤±è´¥æ¬¡æ•°
        FAILURES=$(grep "authentication failed" $LOG_FILE | \
                  grep "$IP" | \
                  grep "$(date '+%b %d %H:%M')" | wc -l)
        
        if [ $FAILURES -gt 5 ]; then
            echo "è­¦å‘Šï¼šIP $IP åœ¨5åˆ†é’Ÿå†…è®¤è¯å¤±è´¥ $FAILURES æ¬¡" | \
            mail -s "é‚®ä»¶ç³»ç»Ÿå®‰å…¨è­¦æŠ¥" $ALERT_EMAIL
        fi
    fi
    
    # æ£€æµ‹å¯ç–‘çš„å¤§é‡å‘é€
    if echo "$line" | grep -q "status=sent"; then
        USER=$(echo "$line" | grep -o "from=<[^>]*>" | tr -d '<>')
        
        # æ£€æŸ¥ç”¨æˆ·åœ¨1å°æ—¶å†…çš„å‘é€é‡
        SENT_COUNT=$(grep "status=sent" $LOG_FILE | \
                    grep "$USER" | \
                    grep "$(date '+%b %d %H:')" | wc -l)
        
        if [ $SENT_COUNT -gt 100 ]; then
            echo "è­¦å‘Šï¼šç”¨æˆ· $USER åœ¨1å°æ—¶å†…å‘é€äº† $SENT_COUNT å°é‚®ä»¶" | \
            mail -s "é‚®ä»¶ç³»ç»Ÿå¼‚å¸¸å‘é€è­¦æŠ¥" $ALERT_EMAIL
        fi
    fi
done
```

---

## 9. ğŸ”„ å®‰å…¨æ›´æ–°ç­–ç•¥


### 9.1 æ›´æ–°ç­–ç•¥çš„é‡è¦æ€§


**ğŸ›¡ï¸ ä¸ºä»€ä¹ˆéœ€è¦åŠæ—¶æ›´æ–°**
> è½¯ä»¶æ›´æ–°å°±åƒç»™æˆ¿å­ä¿®è¡¥æ¼æ´ï¼Œé»‘å®¢æ€»æ˜¯åœ¨å¯»æ‰¾æ–°çš„"ç ´é—¨è€Œå…¥"çš„æ–¹æ³•ï¼Œè€Œè½¯ä»¶å‚å•†åˆ™ä¸æ–­ä¿®è¡¥è¿™äº›"æ¼æ´"ã€‚åŠæ—¶æ›´æ–°ç¡®ä¿ä½ çš„é‚®ä»¶ç³»ç»Ÿæœ‰æœ€æ–°çš„"é˜²æŠ¤æªæ–½"ã€‚

**âš ï¸ ä¸æ›´æ–°çš„é£é™©**
- **å·²çŸ¥æ¼æ´æš´éœ²**ï¼šæ”»å‡»è€…åˆ©ç”¨å…¬å¼€çš„æ¼æ´ä¿¡æ¯
- **é›¶æ—¥æ”»å‡»**ï¼šæ–°å‘ç°çš„æ¼æ´è¢«æ¶æ„åˆ©ç”¨
- **åˆè§„é—®é¢˜**ï¼šä¸ç¬¦åˆå®‰å…¨æ ‡å‡†å’Œæ³•è§„è¦æ±‚
- **åŠŸèƒ½ç¼ºé™·**ï¼šé”™å¤±æ€§èƒ½æ”¹è¿›å’Œæ–°åŠŸèƒ½

### 9.2 è‡ªåŠ¨æ›´æ–°é…ç½®


**ğŸ”§ CentOS/RHELè‡ªåŠ¨æ›´æ–°**

å®‰è£…å¹¶é…ç½®yum-cronï¼š

```bash
# å®‰è£…yum-cron
yum install yum-cron -y

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vi /etc/yum/yum-cron.conf
```

é…ç½®å†…å®¹ï¼š

```ini
[commands]
# è‡ªåŠ¨æ›´æ–°çº§åˆ«ï¼šdefault, security, minimal
update_cmd = security

# æ˜¯å¦è‡ªåŠ¨ä¸‹è½½æ›´æ–°
download_updates = yes

# æ˜¯å¦è‡ªåŠ¨åº”ç”¨æ›´æ–°ï¼ˆå»ºè®®è®¾ä¸ºnoï¼Œæ‰‹åŠ¨åº”ç”¨ï¼‰
apply_updates = no

[emitters]
# æ›´æ–°é€šçŸ¥æ–¹å¼
system_name = mail.yourdomain.com
emit_via = email

[email]
# é‚®ä»¶é€šçŸ¥è®¾ç½®
email_from = yum-cron@yourdomain.com
email_to = admin@yourdomain.com
email_host = localhost
```

**ğŸ”„ Ubuntu/Debianè‡ªåŠ¨æ›´æ–°**

é…ç½®unattended-upgradesï¼š

```bash
# å®‰è£…è‡ªåŠ¨æ›´æ–°å·¥å…·
apt install unattended-upgrades -y

# é…ç½®è‡ªåŠ¨æ›´æ–°
dpkg-reconfigure -plow unattended-upgrades
```

ç¼–è¾‘ `/etc/apt/apt.conf.d/50unattended-upgrades`ï¼š

```bash
// å…è®¸è‡ªåŠ¨æ›´æ–°çš„åŒ…æ¥æº
Unattended-Upgrade::Allowed-Origins {
    "${distro_id}:${distro_codename}-security";
    "${distro_id}ESMApps:${distro_codename}-apps-security";
};

// é‚®ä»¶é€šçŸ¥
Unattended-Upgrade::Mail "admin@yourdomain.com";
Unattended-Upgrade::MailReport "on-change";

// è‡ªåŠ¨é‡å¯ï¼ˆå¦‚éœ€è¦ï¼‰
Unattended-Upgrade::Automatic-Reboot "false";
Unattended-Upgrade::Automatic-Reboot-Time "02:00";
```

### 9.3 æ‰‹åŠ¨æ›´æ–°æµç¨‹


**ğŸ“‹ æ›´æ–°å‰æ£€æŸ¥æ¸…å•**

åˆ›å»ºæ›´æ–°æ£€æŸ¥è„šæœ¬ `/usr/local/bin/pre_update_check.sh`ï¼š

```bash
#!/bin/bash
# æ›´æ–°å‰ç³»ç»Ÿæ£€æŸ¥

echo "é‚®ä»¶ç³»ç»Ÿæ›´æ–°å‰æ£€æŸ¥æŠ¥å‘Š - $(date)"
echo "======================================="

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "1. æœåŠ¡çŠ¶æ€æ£€æŸ¥:"
systemctl is-active postfix dovecot fail2ban | \
while read service; do
    echo "  $service: $(systemctl is-active $service)"
done

# æ£€æŸ¥ç£ç›˜ç©ºé—´
echo -e "\n2. ç£ç›˜ç©ºé—´æ£€æŸ¥:"
df -h | grep -E "(/$|/var|/home)"

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
echo -e "\n3. å†…å­˜ä½¿ç”¨æƒ…å†µ:"
free -h

# æ£€æŸ¥å½“å‰ç‰ˆæœ¬
echo -e "\n4. å½“å‰è½¯ä»¶ç‰ˆæœ¬:"
postconf mail_version
dovecot --version

# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
echo -e "\n5. é…ç½®æ–‡ä»¶è¯­æ³•æ£€æŸ¥:"
postfix check && echo "  Postfixé…ç½®: OK" || echo "  Postfixé…ç½®: ERROR"
dovecot -n > /dev/null 2>&1 && echo "  Dovecoté…ç½®: OK" || echo "  Dovecoté…ç½®: ERROR"

# å¤‡ä»½å…³é”®é…ç½®
echo -e "\n6. åˆ›å»ºé…ç½®å¤‡ä»½:"
BACKUP_DIR="/backup/pre_update_$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR
cp -r /etc/postfix $BACKUP_DIR/
cp -r /etc/dovecot $BACKUP_DIR/
echo "  å¤‡ä»½ä¿å­˜è‡³: $BACKUP_DIR"
```

**ğŸ”„ å®‰å…¨æ›´æ–°æ‰§è¡Œæµç¨‹**

åˆ›å»ºæ›´æ–°è„šæœ¬ `/usr/local/bin/safe_mail_update.sh`ï¼š

```bash
#!/bin/bash
# å®‰å…¨é‚®ä»¶ç³»ç»Ÿæ›´æ–°æµç¨‹

# è®¾ç½®å˜é‡
LOG_FILE="/var/log/mail_updates.log"
EMAIL="admin@yourdomain.com"

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S'): $1" | tee -a $LOG_FILE
}

# 1. æ›´æ–°å‰æ£€æŸ¥
log_message "å¼€å§‹æ›´æ–°å‰æ£€æŸ¥"
/usr/local/bin/pre_update_check.sh > /tmp/pre_update_report.txt

# 2. åœæ­¢éå…³é”®æœåŠ¡
log_message "åœæ­¢éå…³é”®æœåŠ¡"
systemctl stop fail2ban

# 3. æ‰§è¡Œæ›´æ–°
log_message "å¼€å§‹ç³»ç»Ÿæ›´æ–°"
if [ -f /etc/redhat-release ]; then
    yum update -y postfix dovecot fail2ban
elif [ -f /etc/debian_version ]; then
    apt update && apt upgrade -y postfix dovecot fail2ban
fi

UPDATE_STATUS=$?

# 4. é‡å¯æœåŠ¡
log_message "é‡å¯é‚®ä»¶æœåŠ¡"
systemctl restart postfix
systemctl restart dovecot
systemctl restart fail2ban

# 5. éªŒè¯æœåŠ¡çŠ¶æ€
log_message "éªŒè¯æœåŠ¡çŠ¶æ€"
SERVICES_OK=true

for service in postfix dovecot fail2ban; do
    if ! systemctl is-active --quiet $service; then
        log_message "è­¦å‘Š: $service æœåŠ¡æœªæ­£å¸¸å¯åŠ¨"
        SERVICES_OK=false
    fi
done

# 6. å‘é€æ›´æ–°æŠ¥å‘Š
if [ $UPDATE_STATUS -eq 0 ] && [ "$SERVICES_OK" = true ]; then
    log_message "æ›´æ–°æˆåŠŸå®Œæˆ"
    echo "é‚®ä»¶ç³»ç»Ÿæ›´æ–°æˆåŠŸå®Œæˆ" | mail -s "æ›´æ–°æˆåŠŸ" $EMAIL
else
    log_message "æ›´æ–°è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜"
    echo "é‚®ä»¶ç³»ç»Ÿæ›´æ–°å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ—¥å¿—" | mail -s "æ›´æ–°è­¦å‘Š" $EMAIL
fi
```

### 9.4 æ¼æ´ç›‘æ§å’Œå“åº”


**ğŸ” æ¼æ´ä¿¡æ¯ç›‘æ§**

åˆ›å»ºæ¼æ´æ£€æŸ¥è„šæœ¬ `/usr/local/bin/vulnerability_monitor.sh`ï¼š

```bash
#!/bin/bash
# ç›‘æ§é‚®ä»¶ç³»ç»Ÿç›¸å…³æ¼æ´

# CVEæ•°æ®åº“æŸ¥è¯¢ï¼ˆéœ€è¦å®‰è£…ç›¸å…³å·¥å…·ï¼‰
PACKAGES=("postfix" "dovecot" "openssl")
ALERT_EMAIL="security@yourdomain.com"

for package in "${PACKAGES[@]}"; do
    # è·å–å½“å‰ç‰ˆæœ¬
    CURRENT_VERSION=$(rpm -qa | grep $package | head -1)  # CentOS
    # CURRENT_VERSION=$(dpkg -l | grep $package | head -1)  # Ubuntu
    
    echo "æ£€æŸ¥ $package çš„å®‰å…¨æ›´æ–°..."
    
    # æ£€æŸ¥å®‰å…¨æ›´æ–°ï¼ˆCentOSï¼‰
    SECURITY_UPDATES=$(yum --security check-update $package 2>/dev/null | grep $package)
    
    if [ -n "$SECURITY_UPDATES" ]; then
        echo "å‘ç° $package å®‰å…¨æ›´æ–°:" > /tmp/security_alert.txt
        echo "$SECURITY_UPDATES" >> /tmp/security_alert.txt
        
        mail -s "å®‰å…¨æ›´æ–°è­¦æŠ¥: $package" $ALERT_EMAIL < /tmp/security_alert.txt
    fi
done
```

**ğŸ“Š æ›´æ–°å†å²è·Ÿè¸ª**

åˆ›å»ºæ›´æ–°å†å²è®°å½• `/usr/local/bin/track_updates.sh`ï¼š

```bash
#!/bin/bash
# è·Ÿè¸ªç³»ç»Ÿæ›´æ–°å†å²

UPDATE_LOG="/var/log/mail_update_history.log"

# è®°å½•æ›´æ–°å‰çŠ¶æ€
echo "=== æ›´æ–°å¼€å§‹ $(date) ===" >> $UPDATE_LOG
echo "æ›´æ–°å‰ç‰ˆæœ¬ä¿¡æ¯:" >> $UPDATE_LOG
postconf mail_version >> $UPDATE_LOG
dovecot --version >> $UPDATE_LOG

# è®°å½•å¯ç”¨æ›´æ–°
echo "å¯ç”¨æ›´æ–°åˆ—è¡¨:" >> $UPDATE_LOG
if [ -f /etc/redhat-release ]; then
    yum check-update postfix dovecot >> $UPDATE_LOG 2>&1
elif [ -f /etc/debian_version ]; then
    apt list --upgradable | grep -E "(postfix|dovecot)" >> $UPDATE_LOG 2>&1
fi

echo "=== æ›´æ–°è®°å½•ç»“æŸ ===" >> $UPDATE_LOG
```

### 9.5 å›æ»šç­–ç•¥


**ğŸ”™ é…ç½®æ–‡ä»¶å›æ»š**

åˆ›å»ºå›æ»šè„šæœ¬ `/usr/local/bin/rollback_mail_config.sh`ï¼š

```bash
#!/bin/bash
# é‚®ä»¶é…ç½®å›æ»šè„šæœ¬

if [ $# -ne 1 ]; then
    echo "ç”¨æ³•: $0 <å¤‡ä»½ç›®å½•è·¯å¾„>"
    exit 1
fi

BACKUP_DIR=$1
LOG_FILE="/var/log/mail_rollback.log"

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S'): $1" | tee -a $LOG_FILE
}

if [ ! -d "$BACKUP_DIR" ]; then
    log_message "é”™è¯¯: å¤‡ä»½ç›®å½• $BACKUP_DIR ä¸å­˜åœ¨"
    exit 1
fi

log_message "å¼€å§‹é…ç½®å›æ»šï¼Œå¤‡ä»½ç›®å½•: $BACKUP_DIR"

# åœæ­¢æœåŠ¡
log_message "åœæ­¢é‚®ä»¶æœåŠ¡"
systemctl stop postfix dovecot

# å¤‡ä»½å½“å‰é…ç½®
CURRENT_BACKUP="/backup/rollback_backup_$(date +%Y%m%d_%H%M%S)"
mkdir -p $CURRENT_BACKUP
cp -r /etc/postfix $CURRENT_BACKUP/
cp -r /etc/dovecot $CURRENT_BACKUP/
log_message "å½“å‰é…ç½®å·²å¤‡ä»½åˆ°: $CURRENT_BACKUP"

# æ¢å¤æ—§é…ç½®
log_message "æ¢å¤é…ç½®æ–‡ä»¶"
cp -r $BACKUP_DIR/postfix/* /etc/postfix/
cp -r $BACKUP_DIR/dovecot/* /etc/dovecot/

# éªŒè¯é…ç½®
log_message "éªŒè¯é…ç½®æ–‡ä»¶"
if postfix check && dovecot -n > /dev/null 2>&1; then
    log_message "é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡"
    
    # é‡å¯æœåŠ¡
    systemctl start postfix
    systemctl start dovecot
    
    log_message "é…ç½®å›æ»šå®Œæˆ"
else
    log_message "é”™è¯¯: é…ç½®æ–‡ä»¶éªŒè¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
    exit 1
fi
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é‚®ä»¶ç³»ç»Ÿå®‰å…¨æœ¬è´¨ï¼šç¡®ä¿æœºå¯†æ€§ã€å®Œæ•´æ€§ã€å¯ç”¨æ€§ã€èº«ä»½è®¤è¯
ğŸ”¸ å¼€æ”¾ä¸­ç»§å±å®³ï¼šæˆä¸ºåƒåœ¾é‚®ä»¶ä¸­è½¬ç«™ï¼ŒIPè¢«åˆ—å…¥é»‘åå•
ğŸ”¸ æš´åŠ›ç ´è§£é˜²æŠ¤ï¼šé™åˆ¶è®¤è¯é¢‘ç‡ï¼Œfail2banè‡ªåŠ¨å°ç¦
ğŸ”¸ TLS/SSLåŠ å¯†ï¼šä¿æŠ¤ä¼ è¾“è¿‡ç¨‹ä¸­çš„é‚®ä»¶å†…å®¹å®‰å…¨
ğŸ”¸ å®¡è®¡æ—¥å¿—é‡è¦æ€§ï¼šè®°å½•æ‰€æœ‰å®‰å…¨ç›¸å…³äº‹ä»¶ï¼Œä¾¿äºè¿½æº¯
ğŸ”¸ åŠæ—¶æ›´æ–°å¿…è¦æ€§ï¼šä¿®è¡¥å·²çŸ¥æ¼æ´ï¼Œé˜²èŒƒå®‰å…¨å¨èƒ
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å®‰å…¨é˜²æŠ¤çš„å±‚æ¬¡æ€§**
```
ç”¨æˆ·å±‚ï¼šå¼ºå¯†ç ç­–ç•¥ã€å®¢æˆ·ç«¯å®‰å…¨é…ç½®
ä¼ è¾“å±‚ï¼šTLS/SSLåŠ å¯†ã€è¯ä¹¦ç®¡ç†
åº”ç”¨å±‚ï¼šè®¤è¯æˆæƒã€è®¿é—®æ§åˆ¶ã€é‚®ä»¶è¿‡æ»¤
ç³»ç»Ÿå±‚ï¼šé…ç½®åŠ å›ºã€æƒé™ç®¡ç†ã€è¡¥ä¸æ›´æ–°
ç½‘ç»œå±‚ï¼šé˜²ç«å¢™ã€å…¥ä¾µæ£€æµ‹ã€æµé‡ç›‘æ§
```

**ğŸ”¹ é…ç½®çš„å¹³è¡¡æ€§**
```
å®‰å…¨æ€§ vs å¯ç”¨æ€§ï¼šè¿‡ä¸¥çš„é™åˆ¶å¯èƒ½å½±å“æ­£å¸¸ä½¿ç”¨
æ€§èƒ½ vs å®‰å…¨ï¼šåŠ å¯†å’Œè®¤è¯ä¼šå¸¦æ¥æ€§èƒ½å¼€é”€
å¤æ‚æ€§ vs ç»´æŠ¤ï¼šå¤æ‚çš„å®‰å…¨é…ç½®å¢åŠ ç»´æŠ¤éš¾åº¦
æˆæœ¬ vs æ•ˆç›Šï¼šå®‰å…¨æŠ•å…¥è¦ä¸ä¿æŠ¤çš„èµ„äº§ä»·å€¼åŒ¹é…
```

**ğŸ”¹ æŒç»­æ”¹è¿›çš„é‡è¦æ€§**
```
å¨èƒåœ¨å˜åŒ–ï¼šæ–°çš„æ”»å‡»æ–¹æ³•ä¸æ–­å‡ºç°
æŠ€æœ¯åœ¨å‘å±•ï¼šæ–°çš„é˜²æŠ¤æŠ€æœ¯æŒç»­æ¶Œç°
ç¯å¢ƒåœ¨æ”¹å˜ï¼šä¸šåŠ¡éœ€æ±‚å’Œç½‘ç»œç¯å¢ƒå˜åŒ–
æ ‡å‡†åœ¨æå‡ï¼šå®‰å…¨æ ‡å‡†å’Œæ³•è§„è¦æ±‚ä¸æ–­æé«˜
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡ä¿æŠ¤ä»·å€¼**
- **æ•°æ®å®‰å…¨**ï¼šä¿æŠ¤é‚®ä»¶å†…å®¹ä¸è¢«æ³„éœ²æˆ–ç¯¡æ”¹
- **ä¸šåŠ¡è¿ç»­æ€§**ï¼šç¡®ä¿é‚®ä»¶æœåŠ¡ç¨³å®šå¯é è¿è¡Œ
- **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³ç›¸å…³æ³•è§„å’Œæ ‡å‡†è¦æ±‚
- **å“ç‰Œä¿æŠ¤**ï¼šé¿å…æˆä¸ºåƒåœ¾é‚®ä»¶å‘é€æºæŸå®³å£°èª‰

**ğŸ”§ è¿ç»´å®è·µä»·å€¼**
- **è‡ªåŠ¨åŒ–ç›‘æ§**ï¼šå‡å°‘äººå·¥ç›‘æ§å·¥ä½œé‡
- **å¿«é€Ÿå“åº”**ï¼šåŠæ—¶å‘ç°å’Œå¤„ç†å®‰å…¨äº‹ä»¶
- **è¯æ®ä¿å…¨**ï¼šå®Œæ•´çš„æ—¥å¿—è®°å½•ä¾¿äºé—®é¢˜è¿½æº¯
- **é£é™©æ§åˆ¶**ï¼šä¸»åŠ¨å‘ç°å’Œä¿®è¡¥å®‰å…¨æ¼æ´

### 10.4 æœ€ä½³å®è·µæ¸…å•


**ğŸ“‹ éƒ¨ç½²é˜¶æ®µ**
- [ ] ç¦ç”¨å¼€æ”¾ä¸­ç»§ï¼Œä¸¥æ ¼é…ç½®ä¸­ç»§æƒé™
- [ ] å¯ç”¨å¼ºåˆ¶TLSåŠ å¯†ï¼Œé…ç½®å®‰å…¨çš„è¯ä¹¦
- [ ] éƒ¨ç½²fail2banï¼Œé…ç½®é‚®ä»¶æœåŠ¡é˜²æŠ¤è§„åˆ™
- [ ] è®¾ç½®å¼ºå¯†ç ç­–ç•¥ï¼Œå®šæœŸæ›´æ–°å¯†ç 
- [ ] é…ç½®è¯¦ç»†çš„å®¡è®¡æ—¥å¿—è®°å½•

**ğŸ“‹ è¿ç»´é˜¶æ®µ**
- [ ] å®šæœŸæ£€æŸ¥å’Œæ›´æ–°å®‰å…¨é…ç½®
- [ ] ç›‘æ§æ—¥å¿—ä¸­çš„å¼‚å¸¸æ´»åŠ¨
- [ ] åŠæ—¶åº”ç”¨å®‰å…¨æ›´æ–°å’Œè¡¥ä¸
- [ ] å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶å’Œæ•°æ®
- [ ] è¿›è¡Œå®‰å…¨è¯„ä¼°å’Œæ¸—é€æµ‹è¯•

**ğŸ“‹ åº”æ€¥å“åº”**
- [ ] åˆ¶å®šå®‰å…¨äº‹ä»¶å“åº”æµç¨‹
- [ ] å‡†å¤‡é…ç½®å›æ»šæ–¹æ¡ˆ
- [ ] å»ºç«‹å®‰å…¨äº‹ä»¶é€šçŸ¥æœºåˆ¶
- [ ] å®šæœŸæ¼”ç»ƒåº”æ€¥å“åº”æµç¨‹

### 10.5 å­¦ä¹ è¿›é˜¶å»ºè®®


**ğŸš€ æŠ€èƒ½æå‡è·¯å¾„**
```
åˆçº§ï¼šåŸºç¡€é…ç½® â†’ ç†è§£åŸç† â†’ é…ç½®ä¼˜åŒ–
ä¸­çº§ï¼šç›‘æ§å‘Šè­¦ â†’ è‡ªåŠ¨åŒ–è„šæœ¬ â†’ æ€§èƒ½è°ƒä¼˜
é«˜çº§ï¼šå®‰å…¨åŠ å›º â†’ åˆè§„å®¡è®¡ â†’ æ¶æ„è®¾è®¡
ä¸“å®¶ï¼šå¨èƒåˆ†æ â†’ å®‰å…¨ç ”ç©¶ â†’ æ ‡å‡†åˆ¶å®š
```

**ğŸ“š æ‰©å±•å­¦ä¹ èµ„æº**
- **å®˜æ–¹æ–‡æ¡£**ï¼šPostfixã€Dovecotå®˜æ–¹å®‰å…¨æŒ‡å—
- **å®‰å…¨æ ‡å‡†**ï¼šCISåŸºå‡†ã€NISTç½‘ç»œå®‰å…¨æ¡†æ¶
- **ç¤¾åŒºèµ„æº**ï¼šé‚®ä»¶å®‰å…¨ç›¸å…³çš„å¼€æºé¡¹ç›®å’Œè®ºå›
- **è®¤è¯åŸ¹è®­**ï¼šç½‘ç»œå®‰å…¨ç›¸å…³çš„ä¸“ä¸šè®¤è¯

**ğŸ’¡ æŒç»­æ”¹è¿›å»ºè®®**
- å…³æ³¨é‚®ä»¶å®‰å…¨ç›¸å…³çš„CVEå…¬å‘Š
- å‚ä¸é‚®ä»¶ç³»ç»Ÿå®‰å…¨ç¤¾åŒºè®¨è®º
- å®šæœŸè¯„ä¼°å’Œæ›´æ–°å®‰å…¨ç­–ç•¥
- å­¦ä¹ æ–°çš„å®‰å…¨æŠ€æœ¯å’Œæœ€ä½³å®è·µ

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ä¸­ç»§è¦é™åˆ¶ï¼Œé˜²æ­¢æˆè‚‰é¸¡
- å¯†ç è¦å¤æ‚ï¼Œæš´åŠ›ç ´è§£éš¾
- ä¼ è¾“è¦åŠ å¯†ï¼Œçªƒå¬æ— æ‰€è·
- æ—¥å¿—è¦è¯¦ç»†ï¼Œè¿½æº¯æœ‰ä¾æ®
- æ›´æ–°è¦åŠæ—¶ï¼Œæ¼æ´æ—©ä¿®è¡¥

### 10.6 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**ğŸ¤” è‡ªæˆ‘æ£€æµ‹**

Q1: å¦‚ä½•å¿«é€Ÿæ£€æµ‹é‚®ä»¶æœåŠ¡å™¨æ˜¯å¦å­˜åœ¨å¼€æ”¾ä¸­ç»§ï¼Ÿ
A1: ä½¿ç”¨telnetè¿æ¥25ç«¯å£ï¼Œå°è¯•å‘é€å¤–éƒ¨é‚®ä»¶åˆ°å¤–éƒ¨åœ°å€ï¼Œå¦‚æœæ¥å—åˆ™å­˜åœ¨å¼€æ”¾ä¸­ç»§ã€‚

Q2: fail2banå°ç¦äº†æ­£å¸¸ç”¨æˆ·çš„IPæ€ä¹ˆåŠï¼Ÿ
A2: ä½¿ç”¨ `fail2ban-client set jailåç§° unbanip IPåœ°å€` æ‰‹åŠ¨è§£å°ï¼Œå¹¶å°†è¯¥IPåŠ å…¥ç™½åå•ã€‚

Q3: å¦‚ä½•åˆ¤æ–­TLSé…ç½®æ˜¯å¦ç”Ÿæ•ˆï¼Ÿ
A3: ä½¿ç”¨ `openssl s_client -connect yourdomain.com:587 -starttls smtp` æµ‹è¯•SMTP TLSè¿æ¥ã€‚

**ğŸ’ª å®è·µæŒ‘æˆ˜**

å°è¯•ç”¨å­¦åˆ°çš„çŸ¥è¯†è§£å†³è¿™äº›å®é™…é—®é¢˜ï¼š

1. **åœºæ™¯**ï¼šå‘ç°å¤§é‡æ¥è‡ªåŒä¸€IPçš„è®¤è¯å¤±è´¥
   **ä»»åŠ¡**ï¼šé…ç½®fail2banè§„åˆ™è‡ªåŠ¨å°ç¦è¯¥IP

2. **åœºæ™¯**ï¼šç”¨æˆ·åé¦ˆæ— æ³•å‘é€é‚®ä»¶åˆ°æŸäº›åŸŸå
   **ä»»åŠ¡**ï¼šæ£€æŸ¥æ˜¯å¦è¢«åˆ—å…¥RBLé»‘åå•ï¼Œé…ç½®SPF/DKIMè®°å½•

3. **åœºæ™¯**ï¼šå®¡è®¡è¦æ±‚è®°å½•æ‰€æœ‰é‚®ä»¶æ“ä½œ
   **ä»»åŠ¡**ï¼šé…ç½®è¯¦ç»†çš„å®¡è®¡æ—¥å¿—ï¼ŒåŒ…æ‹¬ç”¨æˆ·æ“ä½œå’Œé‚®ä»¶æµè½¬

**ğŸ“š æ‰©å±•é˜…è¯»**

- ğŸ“– æ·±å…¥å­¦ä¹ ï¼š[Postfixå®‰å…¨é…ç½®æœ€ä½³å®è·µ](http://www.postfix.org/SECURITY_README.html)
- ğŸ¥ è§†é¢‘æ•™ç¨‹ï¼š[Dovecotå®‰å…¨åŠ å›ºæŒ‡å—](https://www.dovecot.org/security/)
- ğŸ’» å®æˆ˜é¡¹ç›®ï¼šæ­å»ºå®Œæ•´çš„å®‰å…¨é‚®ä»¶ç³»ç»Ÿ

**ğŸ¯ å­¦ä¹ æˆæœéªŒæ”¶**

å®Œæˆè¿™ä»½ç¬”è®°å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

âœ… **ç†è§£** é‚®ä»¶ç³»ç»Ÿé¢ä¸´çš„ä¸»è¦å®‰å…¨å¨èƒ
âœ… **é…ç½®** é˜²æ­¢å¼€æ”¾ä¸­ç»§çš„Postfixè®¾ç½®
âœ… **éƒ¨ç½²** fail2bané˜²æŠ¤æš´åŠ›ç ´è§£æ”»å‡»
âœ… **å®æ–½** TLS/SSLåŠ å¯†ä¿æŠ¤ä¼ è¾“å®‰å…¨
âœ… **å»ºç«‹** å®Œæ•´çš„å®¡è®¡æ—¥å¿—ä½“ç³»
âœ… **åˆ¶å®š** ç³»ç»Ÿå®‰å…¨æ›´æ–°å’Œç»´æŠ¤ç­–ç•¥
âœ… **å¤„ç†** å¸¸è§çš„é‚®ä»¶å®‰å…¨é—®é¢˜

é€šè¿‡ä»¥ä¸Šå…¨é¢çš„å®‰å…¨åŠ å›ºæªæ–½ï¼Œä½ çš„é‚®ä»¶ç³»ç»Ÿå°†å…·å¤‡å¼ºå¤§çš„å®‰å…¨é˜²æŠ¤èƒ½åŠ›ï¼Œæ—¢èƒ½æŠµå¾¡å¸¸è§çš„ç½‘ç»œæ”»å‡»ï¼Œåˆèƒ½æ»¡è¶³ä¼ä¸šçº§çš„å®‰å…¨åˆè§„è¦æ±‚ã€‚è®°ä½ï¼Œé‚®ä»¶å®‰å…¨ä¸æ˜¯ä¸€æ¬¡æ€§çš„é…ç½®å·¥ä½œï¼Œè€Œæ˜¯éœ€è¦æŒç»­å…³æ³¨å’Œæ”¹è¿›çš„ç³»ç»Ÿå·¥ç¨‹ã€‚

---

> ğŸ’¡ **å…³é”®æ´å¯Ÿ**: é‚®ä»¶ç³»ç»Ÿå®‰å…¨çš„æ ¸å¿ƒåœ¨äº"çºµæ·±é˜²å¾¡"â€”â€”é€šè¿‡å¤šå±‚æ¬¡ã€å¤šç»´åº¦çš„å®‰å…¨æªæ–½ï¼Œæ„å»ºå®Œæ•´çš„å®‰å…¨é˜²æŠ¤ä½“ç³»ã€‚å•ä¸€çš„å®‰å…¨æªæ–½å¯èƒ½è¢«ç»•è¿‡ï¼Œä½†å®Œæ•´çš„å®‰å…¨ä½“ç³»èƒ½å¤Ÿæä¾›å¯é çš„ä¿æŠ¤ã€‚

> âš ï¸ **æ³¨æ„äº‹é¡¹**: åœ¨å®æ–½å®‰å…¨åŠ å›ºæ—¶ï¼ŒåŠ¡å¿…å…ˆåœ¨æµ‹è¯•ç¯å¢ƒä¸­éªŒè¯é…ç½®çš„æ­£ç¡®æ€§ï¼Œé¿å…å½±å“ç”Ÿäº§ç¯å¢ƒçš„æ­£å¸¸æœåŠ¡ã€‚åŒæ—¶ï¼Œè¦å¹³è¡¡å®‰å…¨æ€§å’Œå¯ç”¨æ€§ï¼Œè¿‡åº¦çš„å®‰å…¨é™åˆ¶å¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒã€‚