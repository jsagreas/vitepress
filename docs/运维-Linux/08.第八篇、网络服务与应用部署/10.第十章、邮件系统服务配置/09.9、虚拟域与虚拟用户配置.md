---
title: 9ã€è™šæ‹ŸåŸŸä¸è™šæ‹Ÿç”¨æˆ·é…ç½®
---
## ğŸ“š ç›®å½•

1. [è™šæ‹ŸåŸŸä¸è™šæ‹Ÿç”¨æˆ·æ¦‚è¿°](#1-è™šæ‹ŸåŸŸä¸è™šæ‹Ÿç”¨æˆ·æ¦‚è¿°)
2. [virtual_mailbox_domainsé…ç½®](#2-virtual_mailbox_domainsé…ç½®)
3. [virtual_mailbox_mapsç”¨æˆ·æ˜ å°„](#3-virtual_mailbox_mapsç”¨æˆ·æ˜ å°„)
4. [virtual_alias_mapsåˆ«åæ˜ å°„](#4-virtual_alias_mapsåˆ«åæ˜ å°„)
5. [æ•°æ®åº“åç«¯é…ç½®](#5-æ•°æ®åº“åç«¯é…ç½®)
6. [è™šæ‹Ÿç”¨æˆ·ç®¡ç†è„šæœ¬](#6-è™šæ‹Ÿç”¨æˆ·ç®¡ç†è„šæœ¬)
7. [åŸŸåçº§åˆ«é…ç½®](#7-åŸŸåçº§åˆ«é…ç½®)
8. [ç”¨æˆ·çº§åˆ«æƒé™æ§åˆ¶](#8-ç”¨æˆ·çº§åˆ«æƒé™æ§åˆ¶)
9. [æ‰¹é‡ç”¨æˆ·å¯¼å…¥ç®¡ç†](#9-æ‰¹é‡ç”¨æˆ·å¯¼å…¥ç®¡ç†)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ è™šæ‹ŸåŸŸä¸è™šæ‹Ÿç”¨æˆ·æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯è™šæ‹ŸåŸŸå’Œè™šæ‹Ÿç”¨æˆ·


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µç†è§£**
```
ä¼ ç»Ÿé‚®ä»¶ç³»ç»Ÿï¼š
â€¢ æ¯ä¸ªé‚®ç®±ç”¨æˆ·éƒ½éœ€è¦åœ¨ç³»ç»Ÿä¸­æœ‰çœŸå®çš„Linuxç”¨æˆ·è´¦å·
â€¢ ç”¨æˆ·å¯†ç å­˜å‚¨åœ¨/etc/passwdæ–‡ä»¶ä¸­
â€¢ é‚®ä»¶å­˜å‚¨åœ¨ç”¨æˆ·çš„å®¶ç›®å½•ä¸‹

è™šæ‹ŸåŸŸé‚®ä»¶ç³»ç»Ÿï¼š
â€¢ é‚®ç®±ç”¨æˆ·ä¸éœ€è¦ç³»ç»Ÿè´¦å·ï¼Œç‹¬ç«‹äºLinuxç”¨æˆ·
â€¢ ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨æ•°æ®åº“æˆ–é…ç½®æ–‡ä»¶ä¸­
â€¢ æ‰€æœ‰é‚®ä»¶ç”±ä¸“é—¨çš„é‚®ä»¶ç”¨æˆ·ç»Ÿä¸€ç®¡ç†
â€¢ å¯ä»¥è½»æ¾ç®¡ç†æˆåƒä¸Šä¸‡ä¸ªé‚®ç®±è´¦å·
```

**ğŸ’¡ ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è™šæ‹ŸåŸŸ**
```
è§£å†³çš„æ ¸å¿ƒé—®é¢˜ï¼š
1ï¸âƒ£ å®‰å…¨æ€§ï¼šè™šæ‹Ÿç”¨æˆ·æ— æ³•ç™»å½•ç³»ç»Ÿï¼Œæ›´å®‰å…¨
2ï¸âƒ£ å¯æ‰©å±•æ€§ï¼šæ”¯æŒå¤§é‡é‚®ç®±ç”¨æˆ·è€Œä¸æ¶ˆè€—ç³»ç»Ÿèµ„æº
3ï¸âƒ£ ç®¡ç†ä¾¿æ·ï¼šé€šè¿‡æ•°æ®åº“ç»Ÿä¸€ç®¡ç†ç”¨æˆ·ä¿¡æ¯
4ï¸âƒ£ å¤šåŸŸæ”¯æŒï¼šä¸€å°æœåŠ¡å™¨å¯ä»¥æœåŠ¡å¤šä¸ªé‚®ä»¶åŸŸå
```

### 1.2 è™šæ‹ŸåŸŸæ¶æ„ç»„æˆ


**ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é‚®ä»¶å®¢æˆ·ç«¯     â”‚    â”‚   Postfix MTA   â”‚    â”‚   Dovecot IMAP  â”‚
â”‚ user@domain.com  â”‚ â†’  â”‚   é‚®ä»¶æŠ•é€’      â”‚ â†’  â”‚   é‚®ä»¶å­˜å‚¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“                        â†“
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   MySQLæ•°æ®åº“   â”‚    â”‚   æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨   â”‚
                       â”‚ ç”¨æˆ·ä¿¡æ¯/å¯†ç    â”‚    â”‚   /var/mail/    â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯´æ˜**
```
Postfixé…ç½®é¡¹ï¼š
â€¢ virtual_mailbox_domainsï¼šå®šä¹‰è™šæ‹ŸåŸŸå
â€¢ virtual_mailbox_mapsï¼šç”¨æˆ·é‚®ç®±æ˜ å°„
â€¢ virtual_alias_mapsï¼šé‚®ä»¶åˆ«åæ˜ å°„
â€¢ virtual_mailbox_baseï¼šé‚®ä»¶å­˜å‚¨åŸºç¡€è·¯å¾„

Dovecotç»„ä»¶ï¼š
â€¢ è´Ÿè´£ç”¨æˆ·è®¤è¯å’Œé‚®ä»¶æ£€ç´¢
â€¢ æ”¯æŒIMAP/POP3åè®®
â€¢ ä¸Postfixå…±äº«ç”¨æˆ·æ•°æ®åº“
```

---

## 2. ğŸŒ virtual_mailbox_domainsé…ç½®


### 2.1 åŸŸåé…ç½®åŸºç¡€


**ğŸ“‹ virtual_mailbox_domainsä½œç”¨**
```
åŠŸèƒ½è¯´æ˜ï¼š
â€¢ å‘Šè¯‰Postfixå“ªäº›åŸŸåä½¿ç”¨è™šæ‹Ÿé‚®ç®±ç³»ç»Ÿ
â€¢ åŒºåˆ†æœ¬åœ°åŸŸåå’Œè™šæ‹ŸåŸŸå
â€¢ å†³å®šé‚®ä»¶çš„å¤„ç†æ–¹å¼

é…ç½®æ–¹å¼ï¼š
æ–¹å¼1ï¼šç›´æ¥åœ¨main.cfä¸­é…ç½®
æ–¹å¼2ï¼šä½¿ç”¨å¤–éƒ¨æ–‡ä»¶é…ç½®
æ–¹å¼3ï¼šä½¿ç”¨æ•°æ®åº“é…ç½®ï¼ˆæ¨èï¼‰
```

### 2.2 é™æ€æ–‡ä»¶é…ç½®æ–¹å¼


**ğŸ“ ç›´æ¥é…ç½®ç¤ºä¾‹**
```bash
# /etc/postfix/main.cf
virtual_mailbox_domains = example.com, company.org, test.net

# æˆ–è€…ä½¿ç”¨æ–‡ä»¶æ–¹å¼
virtual_mailbox_domains = /etc/postfix/virtual_domains
```

**ğŸ“„ è™šæ‹ŸåŸŸåæ–‡ä»¶é…ç½®**
```bash
# /etc/postfix/virtual_domains
example.com    OK
company.org    OK
test.net       OK
mail.sample.com OK

# é‡æ–°åŠ è½½é…ç½®
sudo postmap /etc/postfix/virtual_domains
sudo systemctl reload postfix
```

### 2.3 æ•°æ®åº“é…ç½®æ–¹å¼


**ğŸ—„ï¸ MySQLè¡¨ç»“æ„è®¾è®¡**
```sql
-- åˆ›å»ºè™šæ‹ŸåŸŸåè¡¨
CREATE TABLE virtual_domains (
    id INT AUTO_INCREMENT PRIMARY KEY,
    domain VARCHAR(255) NOT NULL UNIQUE,
    description VARCHAR(500),
    active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- æ’å…¥ç¤ºä¾‹åŸŸå
INSERT INTO virtual_domains (domain, description) VALUES
('example.com', 'ä¸»è¦ä¸šåŠ¡åŸŸå'),
('company.org', 'å…¬å¸å®˜æ–¹åŸŸå'),
('test.net', 'æµ‹è¯•ç¯å¢ƒåŸŸå');
```

**âš™ï¸ Postfixæ•°æ®åº“é…ç½®**
```bash
# /etc/postfix/mysql-virtual-domains.cf
user = postfix_user
password = secure_password
hosts = localhost
dbname = postfix_db
query = SELECT domain FROM virtual_domains WHERE domain='%s' AND active=1
```

**ğŸ”§ main.cfä¸­çš„é…ç½®**
```bash
# /etc/postfix/main.cf
virtual_mailbox_domains = mysql:/etc/postfix/mysql-virtual-domains.cf
```

---

## 3. ğŸ“¬ virtual_mailbox_mapsç”¨æˆ·æ˜ å°„


### 3.1 ç”¨æˆ·æ˜ å°„æœºåˆ¶ç†è§£


**ğŸ”¸ æ˜ å°„æœºåˆ¶è¯´æ˜**
```
ç”¨æˆ·æ˜ å°„çš„ä½œç”¨ï¼š
â€¢ å°†è™šæ‹Ÿé‚®ç®±åœ°å€æ˜ å°„åˆ°å…·ä½“çš„å­˜å‚¨è·¯å¾„
â€¢ å‘Šè¯‰Postfixé‚®ä»¶åº”è¯¥å­˜å‚¨åœ¨å“ªé‡Œ
â€¢ éªŒè¯é‚®ç®±åœ°å€æ˜¯å¦æœ‰æ•ˆ

æ˜ å°„æ ¼å¼ï¼š
user@domain.com â†’ ç›¸å¯¹å­˜å‚¨è·¯å¾„
ä¾‹å¦‚ï¼šjohn@example.com â†’ example.com/john/
```

### 3.2 é™æ€æ–‡ä»¶æ˜ å°„é…ç½®


**ğŸ“„ æ–‡ä»¶é…ç½®ç¤ºä¾‹**
```bash
# /etc/postfix/virtual_mailboxes
john@example.com     example.com/john/
mary@example.com     example.com/mary/
admin@company.org    company.org/admin/
sales@company.org    company.org/sales/

# åº”ç”¨é…ç½®
sudo postmap /etc/postfix/virtual_mailboxes
```

**âš™ï¸ main.cfé…ç½®**
```bash
# /etc/postfix/main.cf
virtual_mailbox_maps = hash:/etc/postfix/virtual_mailboxes
virtual_mailbox_base = /var/mail/virtual
virtual_minimum_uid = 1000
virtual_uid_maps = static:5000
virtual_gid_maps = static:5000
```

### 3.3 æ•°æ®åº“æ˜ å°„é…ç½®


**ğŸ—„ï¸ ç”¨æˆ·è¡¨ç»“æ„**
```sql
-- åˆ›å»ºè™šæ‹Ÿç”¨æˆ·è¡¨
CREATE TABLE virtual_users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    domain_id INT NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    maildir VARCHAR(255) NOT NULL,
    quota BIGINT DEFAULT 0,
    active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE
);

-- æ’å…¥ç¤ºä¾‹ç”¨æˆ·
INSERT INTO virtual_users (domain_id, email, password, maildir) VALUES
(1, 'john@example.com', '{SHA256-CRYPT}$5$...', 'example.com/john/'),
(1, 'mary@example.com', '{SHA256-CRYPT}$5$...', 'example.com/mary/'),
(2, 'admin@company.org', '{SHA256-CRYPT}$5$...', 'company.org/admin/');
```

**ğŸ“ æ•°æ®åº“æŸ¥è¯¢é…ç½®**
```bash
# /etc/postfix/mysql-virtual-mailboxes.cf
user = postfix_user
password = secure_password
hosts = localhost
dbname = postfix_db
query = SELECT maildir FROM virtual_users WHERE email='%s' AND active=1
```

---

## 4. ğŸ”„ virtual_alias_mapsåˆ«åæ˜ å°„


### 4.1 åˆ«åæ˜ å°„æ¦‚å¿µ


**ğŸ”¸ åˆ«åæ˜ å°„ä½œç”¨**
```
åˆ«åçš„ç”¨é€”ï¼š
1ï¸âƒ£ é‚®ä»¶è½¬å‘ï¼šå°†ä¸€ä¸ªåœ°å€çš„é‚®ä»¶è½¬å‘åˆ°å¦ä¸€ä¸ªåœ°å€
2ï¸âƒ£ ç¾¤å‘åˆ—è¡¨ï¼šä¸€ä¸ªåœ°å€å¯¹åº”å¤šä¸ªæ¥æ”¶è€…
3ï¸âƒ£ é€šç”¨é‚®ç®±ï¼šå¦‚ info@ã€support@ã€sales@ ç­‰
4ï¸âƒ£ ç”¨æˆ·å‹å¥½ï¼šæä¾›å®¹æ˜“è®°å¿†çš„é‚®ç®±åœ°å€
```

**ğŸ’¡ åˆ«åæ˜ å°„ç±»å‹**
```
ä¸€å¯¹ä¸€æ˜ å°„ï¼š
sales@company.org â†’ john@company.org

ä¸€å¯¹å¤šæ˜ å°„ï¼š
support@company.org â†’ john@company.org, mary@company.org, admin@company.org

å¤–éƒ¨è½¬å‘ï¼š
backup@company.org â†’ external@gmail.com
```

### 4.2 é™æ€åˆ«åé…ç½®


**ğŸ“„ æ–‡ä»¶é…ç½®ç¤ºä¾‹**
```bash
# /etc/postfix/virtual_aliases
# æ ¼å¼ï¼šåˆ«ååœ°å€ â†’ çœŸå®åœ°å€

# ä¸€å¯¹ä¸€åˆ«å
sales@example.com         john@example.com
info@example.com          admin@example.com
webmaster@example.com     tech@example.com

# ä¸€å¯¹å¤šåˆ«å
support@example.com       john@example.com, mary@example.com
all@example.com           john@example.com, mary@example.com, admin@example.com

# å¤–éƒ¨è½¬å‘
backup@example.com        backup@external-service.com

# åº”ç”¨é…ç½®
sudo postmap /etc/postfix/virtual_aliases
```

### 4.3 æ•°æ®åº“åˆ«åé…ç½®


**ğŸ—„ï¸ åˆ«åè¡¨ç»“æ„**
```sql
-- åˆ›å»ºåˆ«åè¡¨
CREATE TABLE virtual_aliases (
    id INT AUTO_INCREMENT PRIMARY KEY,
    domain_id INT NOT NULL,
    source VARCHAR(255) NOT NULL,
    destination TEXT NOT NULL,
    active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE
);

-- æ’å…¥åˆ«åç¤ºä¾‹
INSERT INTO virtual_aliases (domain_id, source, destination) VALUES
(1, 'sales@example.com', 'john@example.com'),
(1, 'support@example.com', 'john@example.com,mary@example.com'),
(1, 'info@example.com', 'admin@example.com'),
(2, 'contact@company.org', 'admin@company.org');
```

**ğŸ“ åˆ«åæŸ¥è¯¢é…ç½®**
```bash
# /etc/postfix/mysql-virtual-aliases.cf
user = postfix_user
password = secure_password
hosts = localhost
dbname = postfix_db
query = SELECT destination FROM virtual_aliases WHERE source='%s' AND active=1
```

---

## 5. ğŸ—„ï¸ æ•°æ®åº“åç«¯é…ç½®


### 5.1 MySQLæ•°æ®åº“é…ç½®


**ğŸ”§ æ•°æ®åº“ç”¨æˆ·åˆ›å»º**
```sql
-- åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
CREATE DATABASE postfix_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'postfix_user'@'localhost' IDENTIFIED BY 'secure_password';
GRANT SELECT ON postfix_db.* TO 'postfix_user'@'localhost';
FLUSH PRIVILEGES;
```

**ğŸ“Š å®Œæ•´æ•°æ®åº“ç»“æ„**
```sql
-- å®Œæ•´çš„æ•°æ®åº“ç»“æ„è„šæœ¬
USE postfix_db;

-- åŸŸåè¡¨
CREATE TABLE virtual_domains (
    id INT AUTO_INCREMENT PRIMARY KEY,
    domain VARCHAR(255) NOT NULL UNIQUE,
    description VARCHAR(500),
    max_users INT DEFAULT 0,
    max_quota BIGINT DEFAULT 0,
    active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_domain (domain),
    INDEX idx_active (active)
);

-- ç”¨æˆ·è¡¨
CREATE TABLE virtual_users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    domain_id INT NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    maildir VARCHAR(255) NOT NULL,
    quota BIGINT DEFAULT 1073741824, -- 1GBé»˜è®¤é…é¢
    active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE,
    INDEX idx_email (email),
    INDEX idx_domain_id (domain_id),
    INDEX idx_active (active)
);

-- åˆ«åè¡¨
CREATE TABLE virtual_aliases (
    id INT AUTO_INCREMENT PRIMARY KEY,
    domain_id INT NOT NULL,
    source VARCHAR(255) NOT NULL,
    destination TEXT NOT NULL,
    active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE,
    INDEX idx_source (source),
    INDEX idx_domain_id (domain_id)
);
```

### 5.2 PostgreSQLé…ç½®é€‰é¡¹


**ğŸ˜ PostgreSQLè¡¨ç»“æ„**
```sql
-- PostgreSQLæ•°æ®åº“é…ç½®
CREATE DATABASE postfix_db WITH ENCODING 'UTF8';
CREATE USER postfix_user WITH PASSWORD 'secure_password';
GRANT CONNECT ON DATABASE postfix_db TO postfix_user;

-- åˆ›å»ºè¡¨ç»“æ„ï¼ˆPostgreSQLè¯­æ³•ï¼‰
\c postfix_db;

CREATE TABLE virtual_domains (
    id SERIAL PRIMARY KEY,
    domain VARCHAR(255) NOT NULL UNIQUE,
    description TEXT,
    active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE virtual_users (
    id SERIAL PRIMARY KEY,
    domain_id INTEGER REFERENCES virtual_domains(id) ON DELETE CASCADE,
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    maildir VARCHAR(255) NOT NULL,
    quota BIGINT DEFAULT 1073741824,
    active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

GRANT SELECT ON ALL TABLES IN SCHEMA public TO postfix_user;
```

**ğŸ“ PostgreSQLæŸ¥è¯¢é…ç½®**
```bash
# /etc/postfix/pgsql-virtual-domains.cf
hosts = localhost
user = postfix_user
password = secure_password
dbname = postfix_db
query = SELECT domain FROM virtual_domains WHERE domain='%s' AND active=true
```

---

## 6. ğŸ”§ è™šæ‹Ÿç”¨æˆ·ç®¡ç†è„šæœ¬


### 6.1 ç”¨æˆ·ç®¡ç†è„šæœ¬åŸºç¡€


**ğŸ“‹ è„šæœ¬åŠŸèƒ½éœ€æ±‚**
```
åŸºæœ¬åŠŸèƒ½ï¼š
â€¢ æ·»åŠ æ–°ç”¨æˆ·
â€¢ åˆ é™¤ç”¨æˆ·
â€¢ ä¿®æ”¹ç”¨æˆ·å¯†ç 
â€¢ æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯
â€¢ æ‰¹é‡æ“ä½œ

é«˜çº§åŠŸèƒ½ï¼š
â€¢ é…é¢ç®¡ç†
â€¢ ç”¨æˆ·çŠ¶æ€ç®¡ç†
â€¢ é‚®ç®±ä½¿ç”¨ç»Ÿè®¡
â€¢ å¤‡ä»½å’Œæ¢å¤
```

### 6.2 ç”¨æˆ·ç®¡ç†è„šæœ¬å®ç°


**ğŸ› ï¸ åŸºç¡€ç®¡ç†è„šæœ¬**
```bash
#!/bin/bash
# /usr/local/bin/postfix-user-manager.sh

# é…ç½®å˜é‡
DB_HOST="localhost"
DB_USER="postfix_user"
DB_PASS="secure_password"
DB_NAME="postfix_db"
MAIL_BASE="/var/mail/virtual"

# æ•°æ®åº“è¿æ¥å‡½æ•°
db_query() {
    mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASS" "$DB_NAME" -e "$1"
}

# æ·»åŠ ç”¨æˆ·å‡½æ•°
add_user() {
    local email="$1"
    local password="$2"
    local domain="${email#*@}"
    local username="${email%@*}"
    
    # æ£€æŸ¥åŸŸåæ˜¯å¦å­˜åœ¨
    domain_id=$(db_query "SELECT id FROM virtual_domains WHERE domain='$domain' AND active=1;" | tail -n 1)
    
    if [ -z "$domain_id" ]; then
        echo "é”™è¯¯ï¼šåŸŸå $domain ä¸å­˜åœ¨æˆ–æœªæ¿€æ´»"
        return 1
    fi
    
    # ç”Ÿæˆå¯†ç å“ˆå¸Œ
    password_hash=$(doveadm pw -s SHA256-CRYPT -p "$password")
    
    # ç”Ÿæˆé‚®ç®±ç›®å½•
    maildir="$domain/$username/"
    
    # æ’å…¥ç”¨æˆ·æ•°æ®
    db_query "INSERT INTO virtual_users (domain_id, email, password, maildir) VALUES ($domain_id, '$email', '$password_hash', '$maildir');"
    
    # åˆ›å»ºé‚®ç®±ç›®å½•
    mkdir -p "$MAIL_BASE/$maildir"
    chown -R vmail:vmail "$MAIL_BASE/$maildir"
    chmod -R 700 "$MAIL_BASE/$maildir"
    
    echo "ç”¨æˆ· $email åˆ›å»ºæˆåŠŸ"
}

# åˆ é™¤ç”¨æˆ·å‡½æ•°
delete_user() {
    local email="$1"
    
    # è·å–ç”¨æˆ·ä¿¡æ¯
    user_info=$(db_query "SELECT maildir FROM virtual_users WHERE email='$email';")
    
    if [ -z "$user_info" ]; then
        echo "é”™è¯¯ï¼šç”¨æˆ· $email ä¸å­˜åœ¨"
        return 1
    fi
    
    # åˆ é™¤æ•°æ®åº“è®°å½•
    db_query "DELETE FROM virtual_users WHERE email='$email';"
    
    # åˆ é™¤é‚®ç®±ç›®å½•ï¼ˆå¯é€‰ï¼‰
    read -p "æ˜¯å¦åˆ é™¤é‚®ç®±æ–‡ä»¶ï¼Ÿ[y/N]: " confirm
    if [[ $confirm =~ ^[Yy]$ ]]; then
        maildir=$(echo "$user_info" | tail -n 1)
        rm -rf "$MAIL_BASE/$maildir"
        echo "é‚®ç®±æ–‡ä»¶å·²åˆ é™¤"
    fi
    
    echo "ç”¨æˆ· $email åˆ é™¤æˆåŠŸ"
}

# ä¿®æ”¹å¯†ç å‡½æ•°
change_password() {
    local email="$1"
    local new_password="$2"
    
    # ç”Ÿæˆæ–°å¯†ç å“ˆå¸Œ
    password_hash=$(doveadm pw -s SHA256-CRYPT -p "$new_password")
    
    # æ›´æ–°å¯†ç 
    db_query "UPDATE virtual_users SET password='$password_hash' WHERE email='$email';"
    
    echo "ç”¨æˆ· $email å¯†ç ä¿®æ”¹æˆåŠŸ"
}

# ä¸»ç¨‹åº
case "$1" in
    add)
        if [ $# -ne 3 ]; then
            echo "ç”¨æ³•: $0 add <email> <password>"
            exit 1
        fi
        add_user "$2" "$3"
        ;;
    delete)
        if [ $# -ne 2 ]; then
            echo "ç”¨æ³•: $0 delete <email>"
            exit 1
        fi
        delete_user "$2"
        ;;
    passwd)
        if [ $# -ne 3 ]; then
            echo "ç”¨æ³•: $0 passwd <email> <new_password>"
            exit 1
        fi
        change_password "$2" "$3"
        ;;
    list)
        echo "å½“å‰è™šæ‹Ÿç”¨æˆ·åˆ—è¡¨ï¼š"
        db_query "SELECT u.email, d.domain, u.active, u.created_at FROM virtual_users u JOIN virtual_domains d ON u.domain_id=d.id ORDER BY d.domain, u.email;"
        ;;
    *)
        echo "ç”¨æ³•: $0 {add|delete|passwd|list}"
        echo "  add <email> <password>     - æ·»åŠ ç”¨æˆ·"
        echo "  delete <email>             - åˆ é™¤ç”¨æˆ·"
        echo "  passwd <email> <password>  - ä¿®æ”¹å¯†ç "
        echo "  list                       - åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·"
        exit 1
        ;;
esac
```

---

## 7. ğŸ¢ åŸŸåçº§åˆ«é…ç½®


### 7.1 åŸŸåçº§åˆ«æƒé™æ§åˆ¶


**ğŸ”¸ åŸŸåé…ç½®å±‚çº§**
```
å…¨å±€é…ç½®ï¼š
â€¢ å½±å“æ‰€æœ‰è™šæ‹ŸåŸŸåçš„é€šç”¨è®¾ç½®
â€¢ åŸºç¡€å®‰å…¨ç­–ç•¥å’Œé™åˆ¶

åŸŸåçº§é…ç½®ï¼š
â€¢ æ¯ä¸ªåŸŸåçš„ç‹¬ç«‹é…ç½®
â€¢ ç”¨æˆ·æ•°é‡é™åˆ¶
â€¢ å­˜å‚¨é…é¢é™åˆ¶
â€¢ ç‰¹å®šå®‰å…¨ç­–ç•¥
```

### 7.2 åŸŸåé…é¢å’Œé™åˆ¶


**ğŸ“Š åŸŸåé…é¢è¡¨è®¾è®¡**
```sql
-- æ‰©å±•è™šæ‹ŸåŸŸåè¡¨
ALTER TABLE virtual_domains ADD COLUMN max_users INT DEFAULT 0;
ALTER TABLE virtual_domains ADD COLUMN max_quota BIGINT DEFAULT 0;
ALTER TABLE virtual_domains ADD COLUMN max_aliases INT DEFAULT 0;
ALTER TABLE virtual_domains ADD COLUMN spam_policy VARCHAR(50) DEFAULT 'normal';
ALTER TABLE virtual_domains ADD COLUMN virus_policy VARCHAR(50) DEFAULT 'normal';

-- æ›´æ–°ç¤ºä¾‹é…ç½®
UPDATE virtual_domains SET 
    max_users = 100,
    max_quota = 107374182400,  -- 100GB
    max_aliases = 50
WHERE domain = 'example.com';
```

**ğŸ”§ åŸŸåçº§åˆ«æ£€æŸ¥è„šæœ¬**
```bash
#!/bin/bash
# åŸŸåçº§åˆ«æ£€æŸ¥å‡½æ•°

check_domain_limits() {
    local domain="$1"
    
    # è·å–åŸŸåé…ç½®
    domain_config=$(db_query "SELECT max_users, max_quota, max_aliases FROM virtual_domains WHERE domain='$domain';")
    
    if [ -z "$domain_config" ]; then
        echo "åŸŸå $domain ä¸å­˜åœ¨"
        return 1
    fi
    
    # å½“å‰ç”¨æˆ·æ•°é‡
    current_users=$(db_query "SELECT COUNT(*) FROM virtual_users u JOIN virtual_domains d ON u.domain_id=d.id WHERE d.domain='$domain';" | tail -n 1)
    
    # å½“å‰åˆ«åæ•°é‡
    current_aliases=$(db_query "SELECT COUNT(*) FROM virtual_aliases a JOIN virtual_domains d ON a.domain_id=d.id WHERE d.domain='$domain';" | tail -n 1)
    
    echo "åŸŸå $domain çŠ¶æ€æŠ¥å‘Šï¼š"
    echo "  å½“å‰ç”¨æˆ·æ•°: $current_users"
    echo "  å½“å‰åˆ«åæ•°: $current_aliases"
}
```

---

## 8. ğŸ‘¤ ç”¨æˆ·çº§åˆ«æƒé™æ§åˆ¶


### 8.1 ç”¨æˆ·æƒé™è®¾è®¡


**ğŸ”¸ ç”¨æˆ·æƒé™å±‚æ¬¡**
```
ç”¨æˆ·çŠ¶æ€ç®¡ç†ï¼š
â€¢ activeï¼šç”¨æˆ·æ˜¯å¦æ¿€æ´»
â€¢ suspendedï¼šä¸´æ—¶æš‚åœ
â€¢ quota_exceededï¼šè¶…å‡ºé…é¢

æƒé™çº§åˆ«ï¼š
â€¢ normalï¼šæ™®é€šç”¨æˆ·
â€¢ adminï¼šåŸŸåç®¡ç†å‘˜
â€¢ super_adminï¼šè¶…çº§ç®¡ç†å‘˜
```

### 8.2 ç”¨æˆ·é…é¢ç®¡ç†


**ğŸ“Š ç”¨æˆ·é…é¢è¡¨è®¾è®¡**
```sql
-- æ‰©å±•ç”¨æˆ·è¡¨
ALTER TABLE virtual_users ADD COLUMN user_type ENUM('normal', 'admin', 'super_admin') DEFAULT 'normal';
ALTER TABLE virtual_users ADD COLUMN quota_used BIGINT DEFAULT 0;
ALTER TABLE virtual_users ADD COLUMN last_login TIMESTAMP NULL;
ALTER TABLE virtual_users ADD COLUMN login_count INT DEFAULT 0;
ALTER TABLE virtual_users ADD COLUMN suspended TINYINT(1) DEFAULT 0;
ALTER TABLE virtual_users ADD COLUMN suspend_reason VARCHAR(255) NULL;

-- åˆ›å»ºé…é¢ä½¿ç”¨ç»Ÿè®¡è¡¨
CREATE TABLE quota_usage (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    used_bytes BIGINT NOT NULL,
    checked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES virtual_users(id) ON DELETE CASCADE
);
```

**ğŸ”§ é…é¢æ£€æŸ¥è„šæœ¬**
```bash
#!/bin/bash
# é…é¢æ£€æŸ¥å’Œæ›´æ–°è„šæœ¬

update_quota_usage() {
    local email="$1"
    local maildir_path="$MAIL_BASE/$(db_query "SELECT maildir FROM virtual_users WHERE email='$email';" | tail -n 1)"
    
    if [ -d "$maildir_path" ]; then
        # è®¡ç®—ç›®å½•å¤§å°
        used_bytes=$(du -sb "$maildir_path" | cut -f1)
        
        # æ›´æ–°æ•°æ®åº“
        db_query "UPDATE virtual_users SET quota_used=$used_bytes WHERE email='$email';"
        
        echo "ç”¨æˆ· $email é…é¢ä½¿ç”¨: $(($used_bytes/1024/1024))MB"
    fi
}

# æ£€æŸ¥æ‰€æœ‰ç”¨æˆ·é…é¢
check_all_quotas() {
    users=$(db_query "SELECT email FROM virtual_users WHERE active=1;" | tail -n +2)
    
    while read -r email; do
        if [ -n "$email" ]; then
            update_quota_usage "$email"
        fi
    done <<< "$users"
}
```

---

## 9. ğŸ“¥ æ‰¹é‡ç”¨æˆ·å¯¼å…¥ç®¡ç†


### 9.1 æ‰¹é‡å¯¼å…¥æ ¼å¼è®¾è®¡


**ğŸ“„ CSVæ ¼å¼è§„èŒƒ**
```csv
# users.csv æ ¼å¼
email,password,domain,quota,active,user_type
john@example.com,password123,example.com,1073741824,1,normal
mary@example.com,password456,example.com,2147483648,1,admin
sales@company.org,salespass,company.org,1073741824,1,normal
```

### 9.2 æ‰¹é‡å¯¼å…¥è„šæœ¬


**ğŸ”§ æ‰¹é‡å¯¼å…¥å®ç°**
```bash
#!/bin/bash
# æ‰¹é‡ç”¨æˆ·å¯¼å…¥è„šæœ¬

batch_import_users() {
    local csv_file="$1"
    local import_log="/tmp/user_import_$(date +%Y%m%d_%H%M%S).log"
    
    echo "å¼€å§‹æ‰¹é‡å¯¼å…¥ç”¨æˆ·..." | tee "$import_log"
    
    # è·³è¿‡CSVå¤´è¡Œï¼Œé€è¡Œå¤„ç†
    tail -n +2 "$csv_file" | while IFS=',' read -r email password domain quota active user_type; do
        echo "å¤„ç†ç”¨æˆ·: $email" | tee -a "$import_log"
        
        # éªŒè¯åŸŸåå­˜åœ¨
        domain_id=$(db_query "SELECT id FROM virtual_domains WHERE domain='$domain' AND active=1;" | tail -n 1)
        
        if [ -z "$domain_id" ]; then
            echo "  é”™è¯¯ï¼šåŸŸå $domain ä¸å­˜åœ¨ï¼Œè·³è¿‡ç”¨æˆ· $email" | tee -a "$import_log"
            continue
        fi
        
        # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
        existing_user=$(db_query "SELECT id FROM virtual_users WHERE email='$email';" | tail -n 1)
        
        if [ -n "$existing_user" ]; then
            echo "  è­¦å‘Šï¼šç”¨æˆ· $email å·²å­˜åœ¨ï¼Œè·³è¿‡" | tee -a "$import_log"
            continue
        fi
        
        # ç”Ÿæˆå¯†ç å“ˆå¸Œ
        password_hash=$(doveadm pw -s SHA256-CRYPT -p "$password")
        
        # ç”Ÿæˆé‚®ç®±ç›®å½•
        username="${email%@*}"
        maildir="$domain/$username/"
        
        # æ’å…¥ç”¨æˆ·æ•°æ®
        insert_sql="INSERT INTO virtual_users (domain_id, email, password, maildir, quota, active, user_type) VALUES ($domain_id, '$email', '$password_hash', '$maildir', $quota, $active, '$user_type');"
        
        if db_query "$insert_sql" 2>/dev/null; then
            # åˆ›å»ºé‚®ç®±ç›®å½•
            mkdir -p "$MAIL_BASE/$maildir"
            chown -R vmail:vmail "$MAIL_BASE/$maildir"
            chmod -R 700 "$MAIL_BASE/$maildir"
            
            echo "  æˆåŠŸï¼šç”¨æˆ· $email åˆ›å»ºå®Œæˆ" | tee -a "$import_log"
        else
            echo "  é”™è¯¯ï¼šç”¨æˆ· $email åˆ›å»ºå¤±è´¥" | tee -a "$import_log"
        fi
    done
    
    echo "æ‰¹é‡å¯¼å…¥å®Œæˆï¼Œè¯¦ç»†æ—¥å¿—ï¼š$import_log"
}

# æ‰¹é‡å¯¼å‡ºç”¨æˆ·
batch_export_users() {
    local domain="$1"
    local export_file="/tmp/users_export_$(date +%Y%m%d_%H%M%S).csv"
    
    echo "email,domain,quota,active,user_type,created_at" > "$export_file"
    
    if [ -n "$domain" ]; then
        db_query "SELECT u.email, d.domain, u.quota, u.active, u.user_type, u.created_at FROM virtual_users u JOIN virtual_domains d ON u.domain_id=d.id WHERE d.domain='$domain' ORDER BY u.email;" | tail -n +2 | sed 's/\t/,/g' >> "$export_file"
    else
        db_query "SELECT u.email, d.domain, u.quota, u.active, u.user_type, u.created_at FROM virtual_users u JOIN virtual_domains d ON u.domain_id=d.id ORDER BY d.domain, u.email;" | tail -n +2 | sed 's/\t/,/g' >> "$export_file"
    fi
    
    echo "ç”¨æˆ·æ•°æ®å·²å¯¼å‡ºåˆ°: $export_file"
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 è™šæ‹ŸåŸŸé…ç½®æ ¸å¿ƒè¦ç‚¹


```
ğŸ”¸ virtual_mailbox_domainsï¼šå®šä¹‰è™šæ‹ŸåŸŸååˆ—è¡¨
ğŸ”¸ virtual_mailbox_mapsï¼šç”¨æˆ·é‚®ç®±åˆ°å­˜å‚¨è·¯å¾„çš„æ˜ å°„
ğŸ”¸ virtual_alias_mapsï¼šé‚®ä»¶åˆ«åè½¬å‘é…ç½®
ğŸ”¸ æ•°æ®åº“åç«¯ï¼šæ¨èä½¿ç”¨MySQL/PostgreSQLç®¡ç†å¤§é‡ç”¨æˆ·
ğŸ”¸ è™šæ‹Ÿç”¨æˆ·ç®¡ç†ï¼šç‹¬ç«‹äºç³»ç»Ÿç”¨æˆ·çš„é‚®ç®±è´¦å·ç³»ç»Ÿ
ğŸ”¸ æ‰¹é‡ç®¡ç†ï¼šæ”¯æŒå¤§è§„æ¨¡ç”¨æˆ·çš„æ‰¹é‡å¯¼å…¥å¯¼å‡º
```

### 10.2 é…ç½®æœ€ä½³å®è·µ


**ğŸ”§ å®‰å…¨é…ç½®è¦ç‚¹**
```
å¯†ç å®‰å…¨ï¼š
â€¢ ä½¿ç”¨å¼ºå¯†ç å“ˆå¸Œç®—æ³•ï¼ˆSHA256-CRYPTï¼‰
â€¢ å®šæœŸå¯†ç è¿‡æœŸç­–ç•¥
â€¢ ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶

æƒé™æ§åˆ¶ï¼š
â€¢ æœ€å°æƒé™åŸåˆ™
â€¢ ç”¨æˆ·çŠ¶æ€ç®¡ç†
â€¢ é…é¢é™åˆ¶ç›‘æ§

æ•°æ®ä¿æŠ¤ï¼š
â€¢ å®šæœŸæ•°æ®å¤‡ä»½
â€¢ æ•°æ®åº“è¿æ¥åŠ å¯†
â€¢ æ–‡ä»¶æƒé™æ§åˆ¶
```

**ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```
æ•°æ®åº“ä¼˜åŒ–ï¼š
â€¢ åˆ›å»ºé€‚å½“çš„ç´¢å¼•
â€¢ å®šæœŸæ¸…ç†æ—¥å¿—
â€¢ è¿æ¥æ± ç®¡ç†

å­˜å‚¨ä¼˜åŒ–ï¼š
â€¢ åˆç†çš„ç›®å½•ç»“æ„
â€¢ å®šæœŸé…é¢æ£€æŸ¥
â€¢ ç£ç›˜ç©ºé—´ç›‘æ§

ç¼“å­˜ç­–ç•¥ï¼š
â€¢ PostfixæŸ¥è¯¢ç¼“å­˜
â€¢ æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
â€¢ å†…å­˜ä½¿ç”¨ç›‘æ§
```

### 10.3 è¿ç»´ç®¡ç†è¦ç‚¹


**ğŸ” ç›‘æ§æ£€æŸ¥é¡¹**
- [ ] åŸŸåé…ç½®æœ‰æ•ˆæ€§
- [ ] ç”¨æˆ·è®¤è¯åŠŸèƒ½æ­£å¸¸
- [ ] é‚®ä»¶æŠ•é€’çŠ¶æ€
- [ ] é…é¢ä½¿ç”¨æƒ…å†µ
- [ ] æ•°æ®åº“è¿æ¥çŠ¶æ€
- [ ] æ–‡ä»¶æƒé™æ­£ç¡®æ€§

**ğŸ’¡ æ•…éšœæ’æŸ¥æ–¹å‘**
```
å¸¸è§é—®é¢˜ï¼š
â€¢ ç”¨æˆ·æ— æ³•æ¥æ”¶é‚®ä»¶ â†’ æ£€æŸ¥virtual_mailbox_mapsé…ç½®
â€¢ åˆ«åè½¬å‘å¤±è´¥ â†’ æ£€æŸ¥virtual_alias_mapsé…ç½®
â€¢ è®¤è¯å¤±è´¥ â†’ æ£€æŸ¥å¯†ç å“ˆå¸Œå’ŒDovecoté…ç½®
â€¢ å­˜å‚¨ç©ºé—´é—®é¢˜ â†’ æ£€æŸ¥é…é¢è®¾ç½®å’Œç£ç›˜ç©ºé—´
```

**ğŸ§  è®°å¿†è¦ç‚¹**
- è™šæ‹ŸåŸŸè®©ä¸€å°æœåŠ¡å™¨ç®¡ç†å¤šä¸ªé‚®ä»¶åŸŸå
- ä¸‰ä¸ªæ ¸å¿ƒé…ç½®ï¼šdomainsã€mailboxesã€aliases
- æ•°æ®åº“åç«¯æä¾›çµæ´»çš„ç”¨æˆ·ç®¡ç†
- é…é¢å’Œæƒé™æ§åˆ¶ä¿è¯ç³»ç»Ÿç¨³å®šæ€§
- æ‰¹é‡ç®¡ç†å·¥å…·æé«˜è¿ç»´æ•ˆç‡