---
title: 6ã€Dovecotå®‰è£…ä¸åŸºç¡€é…ç½®
---
## ğŸ“š ç›®å½•

1. [Dovecotè½¯ä»¶åŒ…å®‰è£…](#1-Dovecotè½¯ä»¶åŒ…å®‰è£…)
2. [dovecot.confä¸»é…ç½®æ–‡ä»¶è¯¦è§£](#2-dovecot.confä¸»é…ç½®æ–‡ä»¶è¯¦è§£)
3. [protocolsåè®®å¯ç”¨è®¾ç½®](#3-protocolsåè®®å¯ç”¨è®¾ç½®)
4. [listenç›‘å¬åœ°å€é…ç½®](#4-listenç›‘å¬åœ°å€é…ç½®)
5. [mail_locationé‚®ä»¶å­˜å‚¨ä½ç½®](#5-mail_locationé‚®ä»¶å­˜å‚¨ä½ç½®)
6. [ç”¨æˆ·è®¤è¯æ•°æ®åº“é…ç½®](#6-ç”¨æˆ·è®¤è¯æ•°æ®åº“é…ç½®)
7. [SSL/TLSè¯ä¹¦é…ç½®](#7-SSL/TLSè¯ä¹¦é…ç½®)
8. [æœåŠ¡è¿›ç¨‹ç®¡ç†é…ç½®](#8-æœåŠ¡è¿›ç¨‹ç®¡ç†é…ç½®)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“¦ Dovecotè½¯ä»¶åŒ…å®‰è£…


### 1.1 ä»€ä¹ˆæ˜¯Dovecot

ğŸ¯ **ç®€å•ç†è§£**ï¼šDovecotå°±åƒé‚®å±€çš„"å–ä»¶çª—å£"ï¼Œä¸“é—¨è´Ÿè´£è®©ç”¨æˆ·æ”¶å–é‚®ä»¶

```
é‚®ä»¶ç³»ç»Ÿåˆ†å·¥ï¼š
Postfixï¼ˆé‚®é€’å‘˜ï¼‰â†’ è´Ÿè´£é‚®ä»¶æŠ•é€’å’Œè½¬å‘
Dovecotï¼ˆå–ä»¶çª—å£ï¼‰â†’ è´Ÿè´£ç”¨æˆ·æ”¶å–é‚®ä»¶

ç”¨æˆ·ä½“éªŒï¼š
å‘é‚®ä»¶ â†’ é€šè¿‡Postfixçš„SMTPæœåŠ¡
æ”¶é‚®ä»¶ â†’ é€šè¿‡Dovecotçš„IMAP/POP3æœåŠ¡
```

**ğŸ”¸ Dovecotçš„æ ¸å¿ƒåŠŸèƒ½**
- **IMAPæœåŠ¡**ï¼šæ”¯æŒå¤šè®¾å¤‡åŒæ­¥çš„ç°ä»£æ”¶ä»¶åè®®
- **POP3æœåŠ¡**ï¼šä¼ ç»Ÿçš„é‚®ä»¶ä¸‹è½½åè®®
- **ç”¨æˆ·è®¤è¯**ï¼šéªŒè¯ç”¨æˆ·èº«ä»½å’Œæƒé™
- **é‚®ä»¶å­˜å‚¨**ï¼šç®¡ç†é‚®ä»¶æ–‡ä»¶çš„å­˜æ”¾å’Œè®¿é—®

### 1.2 ä¸åŒç³»ç»Ÿçš„å®‰è£…æ–¹æ³•

**ğŸ“Š ä¸»æµLinuxå‘è¡Œç‰ˆå®‰è£…å¯¹æ¯”**

| ç³»ç»Ÿç±»å‹ | **å®‰è£…å‘½ä»¤** | **ä¸»è¦è½¯ä»¶åŒ…** | **é…ç½®è·¯å¾„** |
|---------|-------------|--------------|-------------|
| ğŸ”¸ **Ubuntu/Debian** | `apt install dovecot-core dovecot-imapd` | `dovecot-core, dovecot-imapd, dovecot-pop3d` | `/etc/dovecot/` |
| ğŸ”¸ **CentOS/RHEL** | `yum install dovecot` | `dovecot` | `/etc/dovecot/` |
| ğŸ”¸ **Fedora** | `dnf install dovecot` | `dovecot` | `/etc/dovecot/` |
| ğŸ”¸ **openSUSE** | `zypper install dovecot` | `dovecot` | `/etc/dovecot/` |

### 1.3 Ubuntuç³»ç»Ÿè¯¦ç»†å®‰è£…æ­¥éª¤

**ğŸ”§ å®Œæ•´çš„å®‰è£…å’Œåˆå§‹åŒ–æµç¨‹**

```bash
# 1. æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•
sudo apt update

# 2. å®‰è£…æ ¸å¿ƒè½¯ä»¶åŒ…
sudo apt install dovecot-core dovecot-imapd dovecot-pop3d dovecot-lmtpd

# 3. éªŒè¯å®‰è£…ç»“æœ
dpkg -l | grep dovecot
dovecot --version
```

**ğŸ’¡ è½¯ä»¶åŒ…è¯´æ˜**
- **dovecot-core**: Dovecotæ ¸å¿ƒç¨‹åº
- **dovecot-imapd**: IMAPåè®®æ”¯æŒ
- **dovecot-pop3d**: POP3åè®®æ”¯æŒ  
- **dovecot-lmtpd**: æœ¬åœ°é‚®ä»¶ä¼ è¾“åè®®æ”¯æŒ

### 1.4 CentOSç³»ç»Ÿå®‰è£…é…ç½®

**ğŸ”§ RedHatç³»åˆ—ç³»ç»Ÿçš„å®‰è£…æµç¨‹**

```bash
# 1. å®‰è£…Dovecotè½¯ä»¶åŒ…
sudo yum install dovecot -y
# æˆ–è€…è¾ƒæ–°ç‰ˆæœ¬ä½¿ç”¨ï¼šsudo dnf install dovecot -y

# 2. å¯ç”¨æœåŠ¡
sudo systemctl enable dovecot
sudo systemctl start dovecot

# 3. æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status dovecot
```

### 1.5 å®‰è£…ååˆå§‹éªŒè¯

**âœ… ç¡®è®¤å®‰è£…æˆåŠŸçš„æ£€æŸ¥é¡¹ç›®**

```bash
# 1. æ£€æŸ¥Dovecotç‰ˆæœ¬ä¿¡æ¯
dovecot --version

# 2. éªŒè¯é…ç½®æ–‡ä»¶å­˜åœ¨
ls -la /etc/dovecot/
ls -la /etc/dovecot/dovecot.conf

# 3. æ£€æŸ¥é»˜è®¤ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep dovecot
# åº”è¯¥çœ‹åˆ°143(IMAP)å’Œ993(IMAPS)ç«¯å£

# 4. æŸ¥çœ‹Dovecotè¿›ç¨‹
ps aux | grep dovecot
```

**ğŸŸ¢ å®‰è£…æˆåŠŸæŒ‡æ ‡**
- Dovecotç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤ºæ­£å¸¸
- é…ç½®æ–‡ä»¶è·¯å¾„ `/etc/dovecot/` å­˜åœ¨
- æœåŠ¡å¯ä»¥æ­£å¸¸å¯åŠ¨
- ç›¸å…³ç½‘ç»œç«¯å£å¼€å§‹ç›‘å¬

---

## 2. âš™ï¸ dovecot.confä¸»é…ç½®æ–‡ä»¶è¯¦è§£


### 2.1 é…ç½®æ–‡ä»¶ç»“æ„æ¦‚è§ˆ

ğŸ¯ **é…ç½®æ–‡ä»¶çš„ç»„ç»‡æ–¹å¼**ï¼šDovecoté‡‡ç”¨æ¨¡å—åŒ–é…ç½®ï¼Œä¸»é…ç½®æ–‡ä»¶åŒ…å«å…¶ä»–ä¸“é—¨é…ç½®

```
Dovecoté…ç½®æ–‡ä»¶å±‚æ¬¡ç»“æ„ï¼š
/etc/dovecot/
â”œâ”€â”€ dovecot.conf           â† ä¸»é…ç½®æ–‡ä»¶ï¼ˆæ€»è°ƒåº¦ï¼‰
â”œâ”€â”€ conf.d/                â† æ¨¡å—é…ç½®ç›®å½•
â”‚   â”œâ”€â”€ 10-auth.conf       â† è®¤è¯é…ç½®
â”‚   â”œâ”€â”€ 10-mail.conf       â† é‚®ä»¶å­˜å‚¨é…ç½®
â”‚   â”œâ”€â”€ 10-ssl.conf        â† SSL/TLSé…ç½®
â”‚   â”œâ”€â”€ 20-imap.conf       â† IMAPåè®®é…ç½®
â”‚   â””â”€â”€ 20-pop3.conf       â† POP3åè®®é…ç½®
â””â”€â”€ users                  â† ç”¨æˆ·æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰
```

### 2.2 ä¸»é…ç½®æ–‡ä»¶åŸºæœ¬ç»“æ„

**ğŸ“‹ dovecot.confçš„æ ¸å¿ƒé…ç½®é¡¹**

```bash
# æŸ¥çœ‹å½“å‰é…ç½®æ–‡ä»¶
sudo cat /etc/dovecot/dovecot.conf

# ä¸»è¦é…ç½®æ®µè½
protocols = imap pop3 lmtp          # å¯ç”¨çš„åè®®
!include conf.d/*.conf              # åŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶
!include_try /usr/share/dovecot/protocols.d/*.conf
```

**ğŸ”¸ é…ç½®æ–‡ä»¶çš„é‡è¦ç‰¹æ€§**
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šä¸åŒåŠŸèƒ½åˆ†åˆ«é…ç½®
- **includeæœºåˆ¶**ï¼šä¸»é…ç½®åŒ…å«å­é…ç½®
- **æ³¨é‡Šæ”¯æŒ**ï¼šä½¿ç”¨ `#` è¿›è¡Œæ³¨é‡Š
- **å˜é‡æ›¿æ¢**ï¼šæ”¯æŒé…ç½®å˜é‡

### 2.3 é…ç½®æ–‡ä»¶è¯­æ³•è§„åˆ™

**ğŸ“ Dovecoté…ç½®çš„åŸºæœ¬è¯­æ³•**

```
åŸºæœ¬è¯­æ³•è§„åˆ™ï¼š

1. å‚æ•°è®¾ç½®æ ¼å¼
   parameter = value

2. å­—ç¬¦ä¸²å€¼å¤„ç†
   å¸¦ç©ºæ ¼çš„å€¼éœ€è¦å¼•å·ï¼šmail_location = "maildir:~/Maildir"
   
3. å¸ƒå°”å€¼è¡¨ç¤º
   yes/noã€true/falseã€1/0

4. åˆ—è¡¨å€¼è¡¨ç¤º
   protocols = imap pop3 lmtp

5. é…ç½®æ®µè½ï¼ˆsectionï¼‰
   protocol imap {
     # IMAPç‰¹å®šé…ç½®
   }
```

### 2.4 é…ç½®æ–‡ä»¶å¤‡ä»½å’Œç®¡ç†

**ğŸ’¾ é…ç½®æ–‡ä»¶çš„å®‰å…¨ç®¡ç†å®è·µ**

```bash
# 1. å¤‡ä»½åŸå§‹é…ç½®
sudo cp /etc/dovecot/dovecot.conf /etc/dovecot/dovecot.conf.original
sudo cp -r /etc/dovecot/conf.d /etc/dovecot/conf.d.backup

# 2. åˆ›å»ºé…ç½®ç‰ˆæœ¬æ§åˆ¶
sudo mkdir -p /etc/dovecot/backups
sudo tar czf /etc/dovecot/backups/dovecot-config-$(date +%Y%m%d).tar.gz /etc/dovecot/

# 3. é…ç½®æ–‡ä»¶æƒé™è®¾ç½®
sudo chmod 644 /etc/dovecot/dovecot.conf
sudo chown root:root /etc/dovecot/dovecot.conf
```

**âš ï¸ é…ç½®ä¿®æ”¹æœ€ä½³å®è·µ**
- ä¿®æ”¹å‰å§‹ç»ˆå¤‡ä»½é…ç½®æ–‡ä»¶
- ä½¿ç”¨ `doveconf -n` æ£€æŸ¥é…ç½®è¯­æ³•
- é€æ­¥ä¿®æ”¹å¹¶æµ‹è¯•ï¼Œé¿å…ä¸€æ¬¡å¤§æ”¹
- è®°å½•æ¯æ¬¡ä¿®æ”¹çš„åŸå› å’Œæ—¥æœŸ

---

## 3. ğŸŒ protocolsåè®®å¯ç”¨è®¾ç½®


### 3.1 é‚®ä»¶åè®®åŸºç¡€çŸ¥è¯†

ğŸ¯ **ç†è§£ä¸åŒé‚®ä»¶åè®®çš„ä½œç”¨**ï¼šå°±åƒä¸åŒçš„å–ä»¶æ–¹å¼ï¼Œå„æœ‰ç‰¹ç‚¹

```
é‚®ä»¶æ”¶å–åè®®å¯¹æ¯”ï¼š

POP3ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰ï¼š
ç±»æ¯”ï¼šå»é‚®å±€å–åŒ…è£¹ï¼Œæ‹¿èµ°å°±æ²¡äº†
ç‰¹ç‚¹ï¼šä¸‹è½½åˆ°æœ¬åœ°ï¼ŒæœåŠ¡å™¨åˆ é™¤
é€‚ç”¨ï¼šå•è®¾å¤‡ä½¿ç”¨ï¼ŒèŠ‚çœæœåŠ¡å™¨ç©ºé—´

IMAPï¼ˆç°ä»£æ–¹å¼ï¼‰ï¼š
ç±»æ¯”ï¼šé“¶è¡Œä¿é™©ç®±ï¼Œéšæ—¶å¯ä»¥æŸ¥çœ‹
ç‰¹ç‚¹ï¼šé‚®ä»¶ä¿å­˜åœ¨æœåŠ¡å™¨ï¼Œå¤šè®¾å¤‡åŒæ­¥
é€‚ç”¨ï¼šå¤šè®¾å¤‡è®¿é—®ï¼Œé‚®ä»¶é›†ä¸­ç®¡ç†

LMTPï¼ˆå†…éƒ¨åè®®ï¼‰ï¼š
ç±»æ¯”ï¼šå†…éƒ¨è¿è¾“è½¦ï¼Œä¸å¯¹å¤–å¼€æ”¾
ç‰¹ç‚¹ï¼šæœåŠ¡å™¨é—´çš„é‚®ä»¶ä¼ è¾“
é€‚ç”¨ï¼šä¸Postfixç­‰MTAé…åˆ
```

### 3.2 åè®®å¯ç”¨é…ç½®

**ğŸ”§ åœ¨dovecot.confä¸­å¯ç”¨æ‰€éœ€åè®®**

```bash
# ç¼–è¾‘ä¸»é…ç½®æ–‡ä»¶
sudo nano /etc/dovecot/dovecot.conf

# åè®®é…ç½®ç¤ºä¾‹
protocols = imap pop3 lmtp
```

**ğŸ“Š åè®®é€‰æ‹©ç­–ç•¥**

| ä½¿ç”¨åœºæ™¯ | **æ¨èåè®®** | **é…ç½®å»ºè®®** | **æ³¨æ„äº‹é¡¹** |
|---------|-------------|-------------|-------------|
| ğŸ”¸ **ç°ä»£é‚®ä»¶ç³»ç»Ÿ** | `imap` | `protocols = imap` | `å¤šè®¾å¤‡åŒæ­¥å‹å¥½` |
| ğŸ”¸ **å…¼å®¹è€ç³»ç»Ÿ** | `imap pop3` | `protocols = imap pop3` | `åŒæ—¶æ”¯æŒæ–°æ—§å®¢æˆ·ç«¯` |
| ğŸ”¸ **ä¸Postfixé›†æˆ** | `imap lmtp` | `protocols = imap lmtp` | `LMTPæé«˜æŠ•é€’æ•ˆç‡` |
| ğŸ”¸ **æœ€å°åŒ–éƒ¨ç½²** | `pop3` | `protocols = pop3` | `é€‚åˆç®€å•éœ€æ±‚` |

### 3.3 IMAPåè®®è¯¦ç»†é…ç½®

**ğŸ“§ IMAPæœåŠ¡çš„ä¸“é—¨é…ç½®**

```bash
# ç¼–è¾‘IMAPé…ç½®æ–‡ä»¶
sudo nano /etc/dovecot/conf.d/20-imap.conf

# IMAPåè®®é…ç½®ç¤ºä¾‹
protocol imap {
  # IMAPç©ºé—²è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
  imap_idle_notify_interval = 2 mins
  
  # æœ€å¤§IMAPè¿æ¥æ•°
  imap_max_line_length = 64k
  
  # IMAPå®¢æˆ·ç«¯è¶…æ—¶
  imap_client_workarounds = delay-newmail tb-extra-mailbox-sep
}
```

**ğŸ’¡ IMAPé…ç½®å‚æ•°è¯´æ˜**
- **imap_idle_notify_interval**: ç©ºé—²çŠ¶æ€ä¸‹çš„é€šçŸ¥é—´éš”
- **imap_max_line_length**: IMAPå‘½ä»¤è¡Œæœ€å¤§é•¿åº¦
- **imap_client_workarounds**: é’ˆå¯¹ç‰¹å®šå®¢æˆ·ç«¯çš„å…¼å®¹æ€§ä¿®æ­£

### 3.4 POP3åè®®é…ç½®ä¼˜åŒ–

**ğŸ“® POP3æœåŠ¡çš„é…ç½®è°ƒä¼˜**

```bash
# ç¼–è¾‘POP3é…ç½®æ–‡ä»¶
sudo nano /etc/dovecot/conf.d/20-pop3.conf

# POP3åè®®é…ç½®ç¤ºä¾‹
protocol pop3 {
  # POP3 UIDLsæ ¼å¼ï¼ˆé‚®ä»¶å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰
  pop3_uidl_format = %08Xu%08Xv
  
  # ä¿ç•™å·²åˆ é™¤é‚®ä»¶ï¼ˆä¸ç«‹å³åˆ é™¤ï¼‰
  pop3_deleted_flag = \Deleted
  
  # å®¢æˆ·ç«¯å…¼å®¹æ€§è®¾ç½®
  pop3_client_workarounds = outlook-no-nuls oe-ns-eoh
}
```

### 3.5 åè®®å®‰å…¨è®¾ç½®

**ğŸ”’ åè®®çº§åˆ«çš„å®‰å…¨é…ç½®**

```bash
# ç¦ç”¨ä¸å®‰å…¨çš„æ˜æ–‡è®¤è¯ï¼ˆæ¨èï¼‰
disable_plaintext_auth = yes

# SSL/TLSè¦æ±‚è®¾ç½®
ssl = required

# ä»…å…è®¸åŠ å¯†è¿æ¥
ssl_min_protocol = TLSv1.2
```

**ğŸ›¡ï¸ å®‰å…¨é…ç½®æœ€ä½³å®è·µ**
- ç”Ÿäº§ç¯å¢ƒå¿…é¡»ç¦ç”¨æ˜æ–‡è®¤è¯
- å¼ºåˆ¶ä½¿ç”¨SSL/TLSåŠ å¯†è¿æ¥
- å®šæœŸæ›´æ–°TLSåè®®ç‰ˆæœ¬
- ç›‘æ§å¼‚å¸¸è¿æ¥å°è¯•

---

## 4. ğŸŒ listenç›‘å¬åœ°å€é…ç½®


### 4.1 ç›‘å¬åœ°å€çš„åŸºæœ¬æ¦‚å¿µ

ğŸ¯ **ç›‘å¬åœ°å€å†³å®šäº†Dovecotåœ¨å“ªäº›ç½‘ç»œæ¥å£ä¸Šæä¾›æœåŠ¡**

```
ç½‘ç»œæ¥å£ç±»å‹ï¼š

æœ¬åœ°å›ç¯æ¥å£ï¼ˆ127.0.0.1ï¼‰ï¼š
ç”¨é€”ï¼šåªå…è®¸æœ¬æœºè®¿é—®
åœºæ™¯ï¼šæµ‹è¯•ç¯å¢ƒã€æœ¬åœ°æœåŠ¡

å†…ç½‘æ¥å£ï¼ˆ192.168.x.xï¼‰ï¼š
ç”¨é€”ï¼šå…è®¸å±€åŸŸç½‘è®¿é—®
åœºæ™¯ï¼šå†…éƒ¨é‚®ä»¶ç³»ç»Ÿ

å¤–ç½‘æ¥å£ï¼ˆå…¬ç½‘IPï¼‰ï¼š
ç”¨é€”ï¼šå…è®¸äº’è”ç½‘è®¿é—®
åœºæ™¯ï¼šå…¬å…±é‚®ä»¶æœåŠ¡

å…¨æ¥å£ç›‘å¬ï¼ˆ*ï¼‰ï¼š
ç”¨é€”ï¼šç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£
åœºæ™¯ï¼šå¤šç½‘å¡æœåŠ¡å™¨
```

### 4.2 åŸºæœ¬ç›‘å¬é…ç½®

**ğŸ”§ é…ç½®Dovecotçš„ç›‘å¬åœ°å€å’Œç«¯å£**

```bash
# ç¼–è¾‘ä¸»é…ç½®æ–‡ä»¶
sudo nano /etc/dovecot/dovecot.conf

# åŸºæœ¬ç›‘å¬é…ç½®ç¤ºä¾‹
# ç›‘å¬æ‰€æœ‰IPv4æ¥å£
listen = *

# åŒæ—¶ç›‘å¬IPv4å’ŒIPv6
listen = *, ::

# ç›‘å¬ç‰¹å®šIPåœ°å€
listen = 192.168.1.100

# ç›‘å¬å¤šä¸ªç‰¹å®šåœ°å€
listen = 192.168.1.100, 10.0.0.50
```

### 4.3 ç«¯å£é…ç½®è¯¦è§£

**ğŸŒ é‚®ä»¶åè®®çš„æ ‡å‡†ç«¯å£è®¾ç½®**

```bash
# æŸ¥çœ‹é»˜è®¤ç«¯å£é…ç½®
sudo nano /etc/dovecot/conf.d/10-master.conf

# ç«¯å£é…ç½®ç¤ºä¾‹
service imap-login {
  inet_listener imap {
    port = 143                    # IMAPæ ‡å‡†ç«¯å£
    address = *                   # ç›‘å¬æ‰€æœ‰æ¥å£
  }
  inet_listener imaps {
    port = 993                    # IMAPS(åŠ å¯†)ç«¯å£
    ssl = yes                     # å¯ç”¨SSL
    address = *
  }
}

service pop3-login {
  inet_listener pop3 {
    port = 110                    # POP3æ ‡å‡†ç«¯å£
    address = *
  }
  inet_listener pop3s {
    port = 995                    # POP3S(åŠ å¯†)ç«¯å£
    ssl = yes
    address = *
  }
}
```

**ğŸ“Š é‚®ä»¶åè®®ç«¯å£å¯¹ç…§è¡¨**

| åè®®ç±»å‹ | **æ ‡å‡†ç«¯å£** | **åŠ å¯†ç«¯å£** | **ç”¨é€”è¯´æ˜** |
|---------|-------------|-------------|-------------|
| ğŸ”¸ **IMAP** | `143` | `993 (IMAPS)` | `ç°ä»£é‚®ä»¶æ”¶å–åè®®` |
| ğŸ”¸ **POP3** | `110` | `995 (POP3S)` | `ä¼ ç»Ÿé‚®ä»¶ä¸‹è½½åè®®` |
| ğŸ”¸ **SMTP** | `25/587` | `465/587` | `é‚®ä»¶å‘é€åè®®ï¼ˆPostfixï¼‰` |
| ğŸ”¸ **LMTP** | `24` | `æ— ` | `æœ¬åœ°é‚®ä»¶ä¼ è¾“åè®®` |

### 4.4 ç½‘ç»œå®‰å…¨é…ç½®

**ğŸ›¡ï¸ ç›‘å¬é…ç½®çš„å®‰å…¨è€ƒè™‘**

```bash
# å®‰å…¨çš„ç›‘å¬é…ç½®ç¤ºä¾‹
# 1. ä»…å†…ç½‘ç›‘å¬ï¼ˆæ¨èç”¨äºå†…éƒ¨é‚®ä»¶ç³»ç»Ÿï¼‰
listen = 192.168.1.0/24

# 2. ç¦ç”¨ä¸å®‰å…¨ç«¯å£ï¼ˆä»…ä¿ç•™åŠ å¯†ç«¯å£ï¼‰
service imap-login {
  inet_listener imap {
    port = 0                      # 0è¡¨ç¤ºç¦ç”¨æ­¤ç«¯å£
  }
  inet_listener imaps {
    port = 993
    ssl = yes
  }
}

# 3. é™åˆ¶è¿æ¥æ•°
service imap-login {
  process_limit = 500             # æœ€å¤§è¿›ç¨‹æ•°
  process_min_avail = 5           # æœ€å°å¯ç”¨è¿›ç¨‹
}
```

### 4.5 é˜²ç«å¢™é…ç½®

**ğŸ”¥ é…åˆé˜²ç«å¢™çš„ç½‘ç»œè®¿é—®æ§åˆ¶**

```bash
# Ubuntu UFWé˜²ç«å¢™é…ç½®
sudo ufw allow 993/tcp           # å…è®¸IMAPS
sudo ufw allow 995/tcp           # å…è®¸POP3S
sudo ufw allow from 192.168.1.0/24 to any port 143  # å†…ç½‘IMAP

# CentOS FirewallDé…ç½®
sudo firewall-cmd --permanent --add-service=imaps
sudo firewall-cmd --permanent --add-service=pop3s
sudo firewall-cmd --reload

# æˆ–è€…è‡ªå®šä¹‰ç«¯å£
sudo firewall-cmd --permanent --add-port=993/tcp
sudo firewall-cmd --permanent --add-port=995/tcp
```

**âš ï¸ ç½‘ç»œå®‰å…¨æœ€ä½³å®è·µ**
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ç¦ç”¨æ˜æ–‡ç«¯å£ï¼ˆ143, 110ï¼‰
- ä½¿ç”¨é˜²ç«å¢™é™åˆ¶è®¿é—®æ¥æº
- å®šæœŸæ£€æŸ¥ç½‘ç»œè¿æ¥æ—¥å¿—
- è€ƒè™‘ä½¿ç”¨VPNæˆ–ä¸“ç½‘è®¿é—®

---

## 5. ğŸ“ mail_locationé‚®ä»¶å­˜å‚¨ä½ç½®


### 5.1 é‚®ä»¶å­˜å‚¨æ ¼å¼åŸºç¡€

ğŸ¯ **ç†è§£ä¸åŒçš„é‚®ä»¶å­˜å‚¨æ–¹å¼**ï¼šå°±åƒä¸åŒçš„æ–‡ä»¶æ•´ç†æ–¹æ³•

```
é‚®ä»¶å­˜å‚¨æ ¼å¼å¯¹æ¯”ï¼š

Maildiræ ¼å¼ï¼ˆæ¨èï¼‰ï¼š
ç±»æ¯”ï¼šæ¯å°é‚®ä»¶æ˜¯å•ç‹¬çš„æ–‡ä»¶ï¼Œæ”¾åœ¨ä¸åŒæ–‡ä»¶å¤¹
ä¼˜ç‚¹ï¼šå®‰å…¨æ€§é«˜ï¼Œæ”¯æŒå¹¶å‘è®¿é—®ï¼Œä¾¿äºå¤‡ä»½
ç¼ºç‚¹ï¼šæ–‡ä»¶æ•°é‡å¤šï¼Œå¯èƒ½å½±å“æ–‡ä»¶ç³»ç»Ÿæ€§èƒ½

mboxæ ¼å¼ï¼ˆä¼ ç»Ÿï¼‰ï¼š
ç±»æ¯”ï¼šæ‰€æœ‰é‚®ä»¶æ”¾åœ¨ä¸€ä¸ªå¤§æ–‡ä»¶é‡Œ
ä¼˜ç‚¹ï¼šæ–‡ä»¶æ•°å°‘ï¼Œç®€å•
ç¼ºç‚¹ï¼šå¹¶å‘è®¿é—®å›°éš¾ï¼Œå®¹æ˜“æŸå

dboxæ ¼å¼ï¼ˆç°ä»£ï¼‰ï¼š
ç±»æ¯”ï¼šä»‹äºä¸¤è€…ä¹‹é—´ï¼Œåˆ†ç»„å­˜å‚¨
ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½ï¼ŒèŠ‚çœç©ºé—´
ç¼ºç‚¹ï¼šè¾ƒæ–°ï¼Œå…¼å®¹æ€§éœ€è¦è€ƒè™‘
```

### 5.2 mail_locationåŸºæœ¬é…ç½®

**ğŸ”§ é…ç½®é‚®ä»¶å­˜å‚¨ä½ç½®å’Œæ ¼å¼**

```bash
# ç¼–è¾‘é‚®ä»¶å­˜å‚¨é…ç½®
sudo nano /etc/dovecot/conf.d/10-mail.conf

# å¸¸ç”¨mail_locationé…ç½®ç¤ºä¾‹
# Maildiræ ¼å¼ï¼ˆæ¨èï¼‰
mail_location = maildir:~/Maildir

# æŒ‡å®šå®Œæ•´è·¯å¾„çš„Maildir
mail_location = maildir:/var/mail/vhosts/%d/%n

# mboxæ ¼å¼ï¼ˆä¼ ç»Ÿï¼‰
mail_location = mbox:~/mail:INBOX=/var/mail/%u

# dboxæ ¼å¼ï¼ˆç°ä»£ï¼‰
mail_location = dbox:~/dbox
```

**ğŸ’¡ mail_locationå‚æ•°è¯¦è§£**
- **maildir**: ä½¿ç”¨Maildiræ ¼å¼
- **~**: ç”¨æˆ·å®¶ç›®å½•
- **%u**: å®Œæ•´ç”¨æˆ·å (user@domain.com)
- **%n**: ç”¨æˆ·åéƒ¨åˆ† (user)
- **%d**: åŸŸåéƒ¨åˆ† (domain.com)

### 5.3 Maildiræ ¼å¼è¯¦ç»†é…ç½®

**ğŸ“‚ Maildirå­˜å‚¨çš„ç›®å½•ç»“æ„å’Œé…ç½®**

```
Maildirç›®å½•ç»“æ„ï¼š
~/Maildir/
â”œâ”€â”€ cur/              â† å½“å‰é‚®ä»¶ï¼ˆå·²è¯»ï¼‰
â”œâ”€â”€ new/              â† æ–°é‚®ä»¶ï¼ˆæœªè¯»ï¼‰
â”œâ”€â”€ tmp/              â† ä¸´æ—¶æ–‡ä»¶
â”œâ”€â”€ .INBOX.Sent/      â† å·²å‘é€é‚®ä»¶æ–‡ä»¶å¤¹
â”œâ”€â”€ .INBOX.Trash/     â† åƒåœ¾ç®±æ–‡ä»¶å¤¹
â””â”€â”€ .INBOX.Drafts/    â† è‰ç¨¿æ–‡ä»¶å¤¹
```

```bash
# Maildirè¯¦ç»†é…ç½®ç¤ºä¾‹
sudo nano /etc/dovecot/conf.d/10-mail.conf

# åŸºæœ¬Maildiré…ç½®
mail_location = maildir:~/Maildir

# å¸¦å‘½åç©ºé—´çš„é…ç½®
namespace inbox {
  type = private
  separator = /
  prefix = 
  inbox = yes
  
  mailbox Drafts {
    special_use = \Drafts
  }
  mailbox Junk {
    special_use = \Junk
  }
  mailbox Trash {
    special_use = \Trash
  }
  mailbox Sent {
    special_use = \Sent
  }
}
```

### 5.4 è™šæ‹Ÿç”¨æˆ·é‚®ä»¶å­˜å‚¨

**ğŸ‘¥ å¤šåŸŸåç¯å¢ƒä¸‹çš„é‚®ä»¶å­˜å‚¨ç­–ç•¥**

```bash
# è™šæ‹Ÿç”¨æˆ·é‚®ä»¶å­˜å‚¨é…ç½®
mail_location = maildir:/var/mail/vhosts/%d/%n/Maildir

# åˆ›å»ºé‚®ä»¶å­˜å‚¨ç›®å½•ç»“æ„
sudo mkdir -p /var/mail/vhosts
sudo groupadd -g 5000 vmail
sudo useradd -g vmail -u 5000 vmail -d /var/mail/vhosts
sudo chown -R vmail:vmail /var/mail/vhosts

# æƒé™è®¾ç½®
sudo chmod -R 770 /var/mail/vhosts
```

**ğŸ¢ ä¼ä¸šçº§é‚®ä»¶å­˜å‚¨ç­–ç•¥**
```
å­˜å‚¨è·¯å¾„è§„åˆ’ï¼š

å•åŸŸåç¯å¢ƒï¼š
/var/mail/users/username/Maildir

å¤šåŸŸåç¯å¢ƒï¼š
/var/mail/vhosts/domain.com/username/Maildir
/var/mail/vhosts/company.com/username/Maildir

å¤§è§„æ¨¡ç¯å¢ƒï¼š
/var/mail/vhosts/d/domain.com/u/username/Maildir
ï¼ˆæŒ‰åŸŸåå’Œç”¨æˆ·åé¦–å­—æ¯åˆ†çº§ï¼‰
```

### 5.5 é‚®ä»¶å­˜å‚¨ä¼˜åŒ–é…ç½®

**âš¡ æå‡é‚®ä»¶å­˜å‚¨æ€§èƒ½çš„é…ç½®**

```bash
# é‚®ä»¶å­˜å‚¨æ€§èƒ½ä¼˜åŒ–é…ç½®
sudo nano /etc/dovecot/conf.d/10-mail.conf

# é‚®ä»¶é…é¢è®¾ç½®
mail_plugins = $mail_plugins quota

# ç´¢å¼•ä¼˜åŒ–
mail_cache_min_mail_count = 10
mail_cache_compress_percentage = 90

# é‚®ä»¶é”å®šè®¾ç½®
mbox_write_locks = fcntl
mbox_read_locks = fcntl

# é‚®ä»¶è®¿é—®æ—¶é—´ä¼˜åŒ–
mail_save_crlf = no
mail_full_filesystem_access = no
```

**ğŸ—‚ï¸ é‚®ä»¶å½’æ¡£å’Œå¤‡ä»½ç­–ç•¥**
```bash
# è‡ªåŠ¨å½’æ¡£è„šæœ¬ç¤ºä¾‹
#!/bin/bash
# mail_archive.sh

MAIL_ROOT="/var/mail/vhosts"
ARCHIVE_ROOT="/backup/mail/archive"
DAYS_OLD=365

# æŸ¥æ‰¾è¶…è¿‡ä¸€å¹´çš„é‚®ä»¶è¿›è¡Œå½’æ¡£
find $MAIL_ROOT -name "*.eml" -mtime +$DAYS_OLD -exec mv {} $ARCHIVE_ROOT/ \;

# å‹ç¼©å½’æ¡£æ–‡ä»¶
tar czf $ARCHIVE_ROOT/mail_archive_$(date +%Y%m%d).tar.gz $ARCHIVE_ROOT/*.eml
rm $ARCHIVE_ROOT/*.eml
```

---

## 6. ğŸ” ç”¨æˆ·è®¤è¯æ•°æ®åº“é…ç½®


### 6.1 è®¤è¯æœºåˆ¶åŸºç¡€

ğŸ¯ **ç”¨æˆ·è®¤è¯å°±åƒé—¨ç¦ç³»ç»Ÿï¼Œå†³å®šè°èƒ½è¿›å…¥é‚®ç®±**

```
è®¤è¯æ•°æ®æ¥æºç±»å‹ï¼š

ç³»ç»Ÿç”¨æˆ·è®¤è¯ï¼š
åŸç†ï¼šä½¿ç”¨Linuxç³»ç»Ÿç”¨æˆ·è´¦å·
ä¼˜ç‚¹ï¼šé…ç½®ç®€å•ï¼Œä¸ç³»ç»Ÿé›†æˆ
ç¼ºç‚¹ï¼šé‚®ä»¶ç”¨æˆ·=ç³»ç»Ÿç”¨æˆ·ï¼Œå®‰å…¨é£é™©

è™šæ‹Ÿç”¨æˆ·è®¤è¯ï¼š
åŸç†ï¼šä½¿ç”¨ç‹¬ç«‹çš„ç”¨æˆ·æ•°æ®åº“
ä¼˜ç‚¹ï¼šå®‰å…¨éš”ç¦»ï¼Œçµæ´»ç®¡ç†
ç¼ºç‚¹ï¼šé…ç½®å¤æ‚ï¼Œéœ€è¦é¢å¤–ç®¡ç†

LDAPè®¤è¯ï¼š
åŸç†ï¼šä½¿ç”¨LDAPç›®å½•æœåŠ¡
ä¼˜ç‚¹ï¼šä¼ä¸šçº§ï¼Œç»Ÿä¸€è®¤è¯
ç¼ºç‚¹ï¼šéœ€è¦LDAPæœåŠ¡å™¨

SQLæ•°æ®åº“è®¤è¯ï¼š
åŸç†ï¼šä½¿ç”¨MySQL/PostgreSQLç­‰æ•°æ®åº“
ä¼˜ç‚¹ï¼šçµæ´»å¼ºå¤§ï¼Œæ”¯æŒWebç®¡ç†
ç¼ºç‚¹ï¼šéœ€è¦æ•°æ®åº“æœåŠ¡å™¨
```

### 6.2 ç³»ç»Ÿç”¨æˆ·è®¤è¯é…ç½®

**ğŸ‘¤ ä½¿ç”¨Linuxç³»ç»Ÿç”¨æˆ·çš„è®¤è¯è®¾ç½®**

```bash
# ç¼–è¾‘è®¤è¯é…ç½®æ–‡ä»¶
sudo nano /etc/dovecot/conf.d/10-auth.conf

# å¯ç”¨ç³»ç»Ÿç”¨æˆ·è®¤è¯
auth_mechanisms = plain login
disable_plaintext_auth = no        # æµ‹è¯•æ—¶å¯ä»¥å…è®¸ï¼Œç”Ÿäº§ç¯å¢ƒåº”è¯¥ç¦ç”¨

# ç³»ç»Ÿç”¨æˆ·è®¤è¯é…ç½®
!include auth-system.conf.ext
```

```bash
# æŸ¥çœ‹ç³»ç»Ÿç”¨æˆ·è®¤è¯è¯¦ç»†é…ç½®
sudo nano /etc/dovecot/conf.d/auth-system.conf.ext

# ç³»ç»Ÿç”¨æˆ·è®¤è¯è®¾ç½®
passdb {
  driver = pam                     # ä½¿ç”¨PAMè®¤è¯
  args = dovecot                   # PAMæœåŠ¡åç§°
}

userdb {
  driver = passwd                  # ä½¿ç”¨ç³»ç»Ÿpasswdæ•°æ®åº“
  args = blocking=no               # éé˜»å¡æŸ¥è¯¢
}
```

### 6.3 è™šæ‹Ÿç”¨æˆ·è®¤è¯é…ç½®

**ğŸ—‚ï¸ åŸºäºæ–‡ä»¶çš„è™šæ‹Ÿç”¨æˆ·ç®¡ç†**

```bash
# åˆ›å»ºè™šæ‹Ÿç”¨æˆ·è®¤è¯é…ç½®
sudo nano /etc/dovecot/conf.d/auth-passwdfile.conf.ext

# è™šæ‹Ÿç”¨æˆ·å¯†ç æ•°æ®åº“
passdb {
  driver = passwd-file
  args = scheme=CRYPT username_format=%u /etc/dovecot/users
}

userdb {
  driver = passwd-file
  args = username_format=%u /etc/dovecot/users
  
  # è¦†ç›–ç”¨æˆ·æ•°æ®åº“è®¾ç½®
  override_fields = uid=vmail gid=vmail home=/var/mail/vhosts/%d/%n
}
```

```bash
# åˆ›å»ºè™šæ‹Ÿç”¨æˆ·æ–‡ä»¶
sudo nano /etc/dovecot/users

# ç”¨æˆ·æ–‡ä»¶æ ¼å¼ï¼šusername:password:uid:gid:gecos:home:shell
user1@example.com:{CRYPT}$6$salt$hash:5000:5000::/var/mail/vhosts/example.com/user1:/bin/false
user2@example.com:{CRYPT}$6$salt$hash:5000:5000::/var/mail/vhosts/example.com/user2:/bin/false

# è®¾ç½®æ–‡ä»¶æƒé™
sudo chmod 600 /etc/dovecot/users
sudo chown root:root /etc/dovecot/users
```

### 6.4 MySQLæ•°æ®åº“è®¤è¯é…ç½®

**ğŸ—„ï¸ ä½¿ç”¨MySQLä½œä¸ºç”¨æˆ·æ•°æ®åº“**

```bash
# å®‰è£…MySQLæ”¯æŒ
sudo apt install dovecot-mysql    # Ubuntu/Debian
sudo yum install dovecot-mysql    # CentOS/RHEL

# åˆ›å»ºMySQLè®¤è¯é…ç½®
sudo nano /etc/dovecot/conf.d/auth-sql.conf.ext

# MySQLè®¤è¯é…ç½®
passdb {
  driver = sql
  args = /etc/dovecot/dovecot-sql.conf.ext
}

userdb {
  driver = sql
  args = /etc/dovecot/dovecot-sql.conf.ext
}
```

```bash
# MySQLè¿æ¥é…ç½®
sudo nano /etc/dovecot/dovecot-sql.conf.ext

# æ•°æ®åº“è¿æ¥å‚æ•°
driver = mysql
connect = host=localhost dbname=mailserver user=mailuser password=securepass

# é»˜è®¤å¯†ç åŠ å¯†æ–¹æ¡ˆ
default_pass_scheme = SHA512-CRYPT

# å¯†ç æŸ¥è¯¢SQL
password_query = SELECT username as user, password, '/var/mail/vhosts/%d/%n' as userdb_home, \
  'maildir:/var/mail/vhosts/%d/%n/Maildir' as userdb_mail, 5000 as userdb_uid, 5000 as userdb_gid \
  FROM virtual_users WHERE username = '%u'

# ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢SQL  
user_query = SELECT '/var/mail/vhosts/%d/%n' as home, \
  'maildir:/var/mail/vhosts/%d/%n/Maildir' as mail, 5000 as uid, 5000 as gid \
  FROM virtual_users WHERE username = '%u'
```

### 6.5 è®¤è¯è°ƒè¯•å’Œæ•…éšœæ’é™¤

**ğŸ” è®¤è¯é—®é¢˜çš„è¯Šæ–­æ–¹æ³•**

```bash
# å¯ç”¨è®¤è¯è°ƒè¯•
sudo nano /etc/dovecot/conf.d/10-logging.conf

# è°ƒè¯•æ—¥å¿—é…ç½®
auth_verbose = yes
auth_verbose_passwords = no       # å®‰å…¨è€ƒè™‘ï¼Œä¸è®°å½•å¯†ç 
auth_debug = yes
auth_debug_passwords = no

# é‚®ä»¶è°ƒè¯•
mail_debug = yes
verbose_ssl = yes
```

**ğŸ”§ å¸¸è§è®¤è¯é—®é¢˜è¯Šæ–­**
```bash
# 1. æµ‹è¯•ç”¨æˆ·è®¤è¯
doveadm auth test user@example.com password123

# 2. æŸ¥çœ‹è®¤è¯æ—¥å¿—
sudo tail -f /var/log/dovecot.log | grep auth

# 3. æ‰‹åŠ¨æµ‹è¯•IMAPç™»å½•
telnet localhost 143
a01 login user@example.com password123

# 4. æ£€æŸ¥ç”¨æˆ·æ•°æ®åº“
doveadm user user@example.com
```

**âš ï¸ è®¤è¯å®‰å…¨æœ€ä½³å®è·µ**
- ç”Ÿäº§ç¯å¢ƒå¿…é¡»ç¦ç”¨æ˜æ–‡è®¤è¯
- ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥
- å®šæœŸè½®æ¢æ•°æ®åº“å¯†ç 
- ç›‘æ§å¼‚å¸¸ç™»å½•å°è¯•
- å¯ç”¨ç™»å½•å¤±è´¥é”å®šæœºåˆ¶

---

## 7. ğŸ”’ SSL/TLSè¯ä¹¦é…ç½®


### 7.1 SSL/TLSåŸºç¡€æ¦‚å¿µ

ğŸ¯ **SSL/TLSåŠ å¯†å°±åƒç»™é‚®ä»¶ç©¿ä¸Šå¯†ç é”çš„ç›”ç”²**

```
é‚®ä»¶ä¼ è¾“å®‰å…¨å±‚æ¬¡ï¼š

æ˜æ–‡ä¼ è¾“ï¼ˆä¸å®‰å…¨ï¼‰ï¼š
ç±»æ¯”ï¼šæ˜ä¿¡ç‰‡ï¼Œä»»ä½•äººéƒ½èƒ½çœ‹åˆ°å†…å®¹
é£é™©ï¼šå¯†ç å’Œé‚®ä»¶å†…å®¹å¯èƒ½è¢«çªƒå–

SSL/TLSåŠ å¯†ï¼ˆå®‰å…¨ï¼‰ï¼š
ç±»æ¯”ï¼šå¯†å°ä¿¡å°ï¼Œåªæœ‰æ”¶ä»¶äººèƒ½æ‰“å¼€
ä¿æŠ¤ï¼šç”¨æˆ·åã€å¯†ç ã€é‚®ä»¶å†…å®¹å…¨éƒ¨åŠ å¯†

è¯ä¹¦ç±»å‹ï¼š
è‡ªç­¾åè¯ä¹¦ â†’ å…è´¹ï¼Œä½†æµè§ˆå™¨ä¼šè­¦å‘Š
å•†ä¸šè¯ä¹¦ â†’ ä»˜è´¹ï¼Œæµè§ˆå™¨ä¿¡ä»»
Let's Encrypt â†’ å…è´¹ï¼Œè‡ªåŠ¨åŒ–ï¼Œå¹¿æ³›ä¿¡ä»»
```

### 7.2 è·å–SSLè¯ä¹¦

**ğŸ“œ ä¸åŒç±»å‹è¯ä¹¦çš„è·å–æ–¹æ³•**

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨Let's Encryptï¼ˆæ¨èï¼‰
# å®‰è£…certbot
sudo apt install certbot

# è·å–è¯ä¹¦
sudo certbot certonly --standalone -d mail.example.com

# è¯ä¹¦ä½ç½®
/etc/letsencrypt/live/mail.example.com/fullchain.pem    # è¯ä¹¦æ–‡ä»¶
/etc/letsencrypt/live/mail.example.com/privkey.pem      # ç§é’¥æ–‡ä»¶
```

```bash
# æ–¹æ³•2ï¼šç”Ÿæˆè‡ªç­¾åè¯ä¹¦ï¼ˆä»…æµ‹è¯•ç”¨ï¼‰
# åˆ›å»ºç§é’¥
sudo openssl genrsa -out /etc/ssl/private/dovecot.key 2048

# åˆ›å»ºè¯ä¹¦ç”³è¯·
sudo openssl req -new -key /etc/ssl/private/dovecot.key -out /etc/ssl/certs/dovecot.csr

# ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
sudo openssl x509 -req -days 365 -in /etc/ssl/certs/dovecot.csr \
  -signkey /etc/ssl/private/dovecot.key -out /etc/ssl/certs/dovecot.crt
```

### 7.3 Dovecot SSLé…ç½®

**ğŸ”§ é…ç½®Dovecotä½¿ç”¨SSLè¯ä¹¦**

```bash
# ç¼–è¾‘SSLé…ç½®æ–‡ä»¶
sudo nano /etc/dovecot/conf.d/10-ssl.conf

# SSLåŸºæœ¬é…ç½®
ssl = required                    # å¼ºåˆ¶ä½¿ç”¨SSL
ssl_cert = </etc/letsencrypt/live/mail.example.com/fullchain.pem
ssl_key = </etc/letsencrypt/live/mail.example.com/privkey.pem

# SSLå®‰å…¨è®¾ç½®
ssl_min_protocol = TLSv1.2       # æœ€ä½TLSç‰ˆæœ¬
ssl_cipher_list = ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS
ssl_prefer_server_ciphers = yes   # ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨ç«¯åŠ å¯†å¥—ä»¶

# SSLæ€§èƒ½ä¼˜åŒ–
ssl_dh_parameters_length = 2048   # DHå‚æ•°é•¿åº¦
```

### 7.4 SSLè¯ä¹¦è‡ªåŠ¨ç»­æœŸ

**ğŸ”„ Let's Encryptè¯ä¹¦çš„è‡ªåŠ¨ç»­æœŸé…ç½®**

```bash
# åˆ›å»ºè¯ä¹¦ç»­æœŸè„šæœ¬
sudo nano /usr/local/bin/renew-dovecot-cert.sh

#!/bin/bash
# renew-dovecot-cert.sh

# ç»­æœŸè¯ä¹¦
certbot renew --quiet

# æ£€æŸ¥æ˜¯å¦æœ‰è¯ä¹¦æ›´æ–°
if [ $? -eq 0 ]; then
    # é‡æ–°åŠ è½½Dovecoté…ç½®
    systemctl reload dovecot
    echo "Dovecot SSLè¯ä¹¦å·²æ›´æ–°å¹¶é‡æ–°åŠ è½½"
else
    echo "è¯ä¹¦ç»­æœŸå¤±è´¥æˆ–æ— éœ€æ›´æ–°"
fi

# è®¾ç½®æ‰§è¡Œæƒé™
sudo chmod +x /usr/local/bin/renew-dovecot-cert.sh

# æ·»åŠ åˆ°crontabï¼ˆæ¯æœˆæ£€æŸ¥ä¸€æ¬¡ï¼‰
echo "0 3 1 * * /usr/local/bin/renew-dovecot-cert.sh" | sudo crontab -
```

### 7.5 SSLé…ç½®éªŒè¯å’Œè°ƒè¯•

**âœ… éªŒè¯SSLé…ç½®æ˜¯å¦æ­£ç¡®**

```bash
# 1. æ£€æŸ¥SSLè¯ä¹¦ä¿¡æ¯
openssl s_client -connect mail.example.com:993 -servername mail.example.com

# 2. éªŒè¯è¯ä¹¦æœ‰æ•ˆæœŸ
openssl x509 -in /etc/letsencrypt/live/mail.example.com/fullchain.pem -text -noout

# 3. æµ‹è¯•SSLè¿æ¥
openssl s_client -connect localhost:993 -quiet

# 4. æ£€æŸ¥Dovecot SSLé…ç½®
doveconf -n | grep ssl
```

**ğŸ” SSLé—®é¢˜è¯Šæ–­**
```bash
# å¸¸è§SSLé—®é¢˜æ£€æŸ¥

# 1. è¯ä¹¦æ–‡ä»¶æƒé™æ£€æŸ¥
ls -la /etc/letsencrypt/live/mail.example.com/

# 2. è¯ä¹¦é“¾å®Œæ•´æ€§æ£€æŸ¥
openssl verify -CAfile /etc/ssl/certs/ca-certificates.crt \
  /etc/letsencrypt/live/mail.example.com/fullchain.pem

# 3. SSLæ—¥å¿—æ£€æŸ¥
sudo tail -f /var/log/dovecot.log | grep -i ssl

# 4. ç«¯å£ç›‘å¬æ£€æŸ¥
sudo netstat -tlnp | grep -E "(993|995)"
```

**âš ï¸ SSLå®‰å…¨æœ€ä½³å®è·µ**
- ä½¿ç”¨Let's Encryptç­‰å¯ä¿¡CAç­¾å‘çš„è¯ä¹¦
- ç¦ç”¨è¿‡æ—¶çš„SSL/TLSç‰ˆæœ¬ï¼ˆSSLv3, TLSv1.0, TLSv1.1ï¼‰
- å®šæœŸæ›´æ–°åŠ å¯†å¥—ä»¶é…ç½®
- ç›‘æ§è¯ä¹¦è¿‡æœŸæ—¶é—´
- ä½¿ç”¨HSTSå¢å¼ºå®‰å…¨æ€§

---

## 8. âš™ï¸ æœåŠ¡è¿›ç¨‹ç®¡ç†é…ç½®


### 8.1 DovecotæœåŠ¡æ¶æ„

ğŸ¯ **ç†è§£Dovecotçš„å¤šè¿›ç¨‹æ¶æ„**ï¼šå°±åƒé‚®å±€çš„ä¸åŒå·¥ä½œå²—ä½

```
Dovecotè¿›ç¨‹æ¶æ„ï¼š

ä¸»è¿›ç¨‹ï¼ˆdovecotï¼‰ï¼š
ä½œç”¨ï¼šæ€»è°ƒåº¦å‘˜ï¼Œç®¡ç†æ‰€æœ‰å­è¿›ç¨‹
èŒè´£ï¼šé…ç½®ç®¡ç†ã€è¿›ç¨‹ç›‘æ§ã€æ—¥å¿—å¤„ç†

ç™»å½•è¿›ç¨‹ï¼ˆimap-login/pop3-loginï¼‰ï¼š
ä½œç”¨ï¼šé—¨å«ï¼Œå¤„ç†ç”¨æˆ·ç™»å½•
èŒè´£ï¼šSSLç»ˆæ­¢ã€è®¤è¯ã€è¿æ¥è½¬å‘

é‚®ä»¶è¿›ç¨‹ï¼ˆimap/pop3ï¼‰ï¼š
ä½œç”¨ï¼šé‚®ä»¶æœåŠ¡å‘˜ï¼Œå¤„ç†é‚®ä»¶æ“ä½œ
èŒè´£ï¼šé‚®ä»¶è¯»å–ã€æœç´¢ã€ç§»åŠ¨ã€åˆ é™¤

è®¤è¯è¿›ç¨‹ï¼ˆauthï¼‰ï¼š
ä½œç”¨ï¼šèº«ä»½éªŒè¯ä¸“å‘˜
èŒè´£ï¼šç”¨æˆ·è®¤è¯ã€æƒé™æ£€æŸ¥
```

### 8.2 åŸºæœ¬æœåŠ¡ç®¡ç†

**ğŸ”§ DovecotæœåŠ¡çš„å¯åŠ¨ã€åœæ­¢å’ŒçŠ¶æ€ç®¡ç†**

```bash
# åŸºæœ¬æœåŠ¡æ§åˆ¶å‘½ä»¤
sudo systemctl start dovecot      # å¯åŠ¨æœåŠ¡
sudo systemctl stop dovecot       # åœæ­¢æœåŠ¡
sudo systemctl restart dovecot    # é‡å¯æœåŠ¡
sudo systemctl reload dovecot     # é‡æ–°åŠ è½½é…ç½®
sudo systemctl status dovecot     # æŸ¥çœ‹æœåŠ¡çŠ¶æ€

# è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
sudo systemctl enable dovecot     # å¯ç”¨å¼€æœºè‡ªå¯
sudo systemctl disable dovecot    # ç¦ç”¨å¼€æœºè‡ªå¯

# æŸ¥çœ‹æœåŠ¡å¯åŠ¨å¤±è´¥åŸå› 
sudo systemctl status dovecot -l
sudo journalctl -u dovecot -f     # å®æ—¶æŸ¥çœ‹æ—¥å¿—
```

### 8.3 è¿›ç¨‹æ•°é‡å’Œæ€§èƒ½é…ç½®

**âš¡ ä¼˜åŒ–Dovecotçš„è¿›ç¨‹ç®¡ç†å’Œæ€§èƒ½**

```bash
# ç¼–è¾‘æœåŠ¡é…ç½®æ–‡ä»¶
sudo nano /etc/dovecot/conf.d/10-master.conf

# è¿›ç¨‹æ•°é‡é…ç½®ç¤ºä¾‹
service imap-login {
  inet_listener imap {
    port = 143
  }
  inet_listener imaps {
    port = 993
    ssl = yes
  }
  
  # è¿›ç¨‹ç®¡ç†é…ç½®
  process_limit = 500             # æœ€å¤§è¿›ç¨‹æ•°
  process_min_avail = 5           # æœ€å°å¯ç”¨è¿›ç¨‹æ•°
  service_count = 1               # æ¯ä¸ªè¿›ç¨‹å¤„ç†çš„è¿æ¥æ•°
  client_limit = 1000             # æ¯ä¸ªè¿›ç¨‹çš„å®¢æˆ·ç«¯é™åˆ¶
}

service imap {
  # IMAPè¿›ç¨‹é…ç½®
  process_limit = 1024
  process_min_avail = 0
  service_count = 1
  client_limit = 1
  
  # è¿›ç¨‹ç©ºé—²è¶…æ—¶
  process_idle_timeout = 1 hour
}
```

### 8.4 å†…å­˜å’Œèµ„æºé™åˆ¶

**ğŸ’¾ é…ç½®è¿›ç¨‹èµ„æºä½¿ç”¨é™åˆ¶**

```bash
# å†…å­˜å’Œèµ„æºé™åˆ¶é…ç½®
sudo nano /etc/dovecot/conf.d/10-master.conf

# å…¨å±€èµ„æºé™åˆ¶
default_process_limit = 1000
default_client_limit = 1000
default_vsz_limit = 256M           # è™šæ‹Ÿå†…å­˜é™åˆ¶

# è®¤è¯è¿›ç¨‹é…ç½®
service auth {
  unix_listener auth-userdb {
    mode = 0666
    user = vmail
    group = vmail
  }
  
  # è®¤è¯è¿›ç¨‹èµ„æºé™åˆ¶
  process_limit = 1
  client_limit = 4096
  service_count = 0                # 0 = æ— é™åˆ¶
}

# æ—¥å¿—è¿›ç¨‹é…ç½®
service log {
  process_limit = 1
  service_count = 0
}
```

### 8.5 ç›‘æ§å’Œæ—¥å¿—é…ç½®

**ğŸ“Š è®¾ç½®æœåŠ¡ç›‘æ§å’Œæ—¥å¿—è®°å½•**

```bash
# ç¼–è¾‘æ—¥å¿—é…ç½®
sudo nano /etc/dovecot/conf.d/10-logging.conf

# æ—¥å¿—é…ç½®
log_path = /var/log/dovecot.log
info_log_path = /var/log/dovecot-info.log
debug_log_path = /var/log/dovecot-debug.log

# ç³»ç»Ÿæ—¥å¿—é…ç½®
syslog_facility = mail

# æ—¥å¿—è½®è½¬é…ç½®
log_timestamp = "%Y-%m-%d %H:%M:%S "
login_log_format_elements = user=<%u> method=%m rip=%r lip=%l mpid=%e %c

# æ€§èƒ½ç›‘æ§é…ç½®
mail_log_prefix = "%s(%u): "
```

**ğŸ“ˆ æ€§èƒ½ç›‘æ§è„šæœ¬ç¤ºä¾‹**
```bash
#!/bin/bash
# dovecot_monitor.sh

# æ£€æŸ¥Dovecotè¿›ç¨‹çŠ¶æ€
echo "=== Dovecotè¿›ç¨‹çŠ¶æ€ ==="
ps aux | grep dovecot

echo "=== è¿æ¥ç»Ÿè®¡ ==="
# ç»Ÿè®¡å½“å‰è¿æ¥æ•°
netstat -an | grep -E ":143|:993|:110|:995" | wc -l

echo "=== å†…å­˜ä½¿ç”¨ ==="
# æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
ps -o pid,vsz,rss,comm -C dovecot

echo "=== æœ€è¿‘çš„é”™è¯¯æ—¥å¿— ==="
# æ˜¾ç¤ºæœ€è¿‘çš„é”™è¯¯
tail -20 /var/log/dovecot.log | grep -i error

# å‘é€æŠ¥å‘Šï¼ˆå¯é€‰ï¼‰
# mail -s "DovecotçŠ¶æ€æŠ¥å‘Š" admin@example.com < /tmp/dovecot_status.txt
```

### 8.6 é«˜å¯ç”¨å’Œæ•…éšœæ¢å¤

**ğŸ›¡ï¸ æœåŠ¡é«˜å¯ç”¨é…ç½®**

```bash
# åˆ›å»ºæœåŠ¡ç›‘æ§è„šæœ¬
sudo nano /usr/local/bin/dovecot-watchdog.sh

#!/bin/bash
# dovecot-watchdog.sh

# æ£€æŸ¥DovecotæœåŠ¡çŠ¶æ€
if ! systemctl is-active --quiet dovecot; then
    echo "$(date): DovecotæœåŠ¡å¼‚å¸¸ï¼Œå°è¯•é‡å¯" >> /var/log/dovecot-watchdog.log
    
    # é‡å¯æœåŠ¡
    systemctl restart dovecot
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 10
    
    # å†æ¬¡æ£€æŸ¥
    if systemctl is-active --quiet dovecot; then
        echo "$(date): DovecotæœåŠ¡é‡å¯æˆåŠŸ" >> /var/log/dovecot-watchdog.log
    else
        echo "$(date): DovecotæœåŠ¡é‡å¯å¤±è´¥ï¼Œå‘é€å‘Šè­¦" >> /var/log/dovecot-watchdog.log
        # å‘é€å‘Šè­¦é‚®ä»¶æˆ–çŸ­ä¿¡
        mail -s "DovecotæœåŠ¡æ•…éšœ" admin@example.com < /dev/null
    fi
fi

# è®¾ç½®æ‰§è¡Œæƒé™å¹¶æ·»åŠ åˆ°crontab
sudo chmod +x /usr/local/bin/dovecot-watchdog.sh
echo "*/5 * * * * /usr/local/bin/dovecot-watchdog.sh" | sudo crontab -
```

**ğŸ”„ å¤‡ä»½å’Œæ¢å¤é…ç½®**
```bash
# é…ç½®å¤‡ä»½è„šæœ¬
#!/bin/bash
# backup_dovecot_config.sh

BACKUP_DIR="/backup/dovecot"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½é…ç½®æ–‡ä»¶
tar czf $BACKUP_DIR/dovecot_config_$DATE.tar.gz /etc/dovecot/

# å¤‡ä»½ç”¨æˆ·æ•°æ®åº“ï¼ˆå¦‚æœä½¿ç”¨æ–‡ä»¶è®¤è¯ï¼‰
if [ -f /etc/dovecot/users ]; then
    cp /etc/dovecot/users $BACKUP_DIR/users_$DATE
fi

# æ¸…ç†7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "Dovecoté…ç½®å¤‡ä»½å®Œæˆ: $BACKUP_DIR/dovecot_config_$DATE.tar.gz"
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Dovecotæœ¬è´¨ï¼šIMAP/POP3é‚®ä»¶æ”¶å–æœåŠ¡å™¨ï¼Œè´Ÿè´£ç”¨æˆ·æ”¶ä»¶åŠŸèƒ½
ğŸ”¸ è½¯ä»¶åŒ…å®‰è£…ï¼šé€‰æ‹©åˆé€‚çš„è½¯ä»¶åŒ…ï¼Œé…ç½®åŸºæœ¬çš„ç³»ç»Ÿç¯å¢ƒ
ğŸ”¸ ä¸»é…ç½®æ–‡ä»¶ï¼šdovecot.confæ˜¯æ€»é…ç½®ï¼Œconf.d/ç›®å½•æ˜¯æ¨¡å—é…ç½®
ğŸ”¸ åè®®é…ç½®ï¼šIMAPç°ä»£åŒæ­¥ã€POP3ä¼ ç»Ÿä¸‹è½½ã€LMTPå†…éƒ¨ä¼ è¾“
ğŸ”¸ ç›‘å¬é…ç½®ï¼šç½‘ç»œæ¥å£ã€ç«¯å£ã€å®‰å…¨è®¿é—®æ§åˆ¶
ğŸ”¸ é‚®ä»¶å­˜å‚¨ï¼šMaildiræ¨èæ ¼å¼ï¼Œmail_locationè·¯å¾„é…ç½®
ğŸ”¸ ç”¨æˆ·è®¤è¯ï¼šç³»ç»Ÿç”¨æˆ·ã€è™šæ‹Ÿç”¨æˆ·ã€æ•°æ®åº“è®¤è¯å¤šç§æ–¹å¼
ğŸ”¸ SSLåŠ å¯†ï¼šå¿…é¡»é…ç½®ï¼Œä¿æŠ¤ç”¨æˆ·å‡­æ®å’Œé‚®ä»¶å†…å®¹å®‰å…¨
ğŸ”¸ è¿›ç¨‹ç®¡ç†ï¼šæ€§èƒ½ä¼˜åŒ–ã€èµ„æºé™åˆ¶ã€ç›‘æ§å‘Šè­¦
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Dovecotåœ¨é‚®ä»¶ç³»ç»Ÿä¸­çš„è§’è‰²**
```
é‚®ä»¶ç³»ç»Ÿåˆ†å·¥ï¼š
- Postfix: è´Ÿè´£é‚®ä»¶çš„å‘é€å’ŒæŠ•é€’ï¼ˆSMTPï¼‰
- Dovecot: è´Ÿè´£ç”¨æˆ·çš„é‚®ä»¶æ”¶å–ï¼ˆIMAP/POP3ï¼‰
- ä¸¤è€…é…åˆ: ç»„æˆå®Œæ•´çš„é‚®ä»¶æœåŠ¡ç³»ç»Ÿ

ç”¨æˆ·ä½¿ç”¨åœºæ™¯ï¼š
- å‘é‚®ä»¶: å®¢æˆ·ç«¯ â†’ Postfix SMTP â†’ ç›®æ ‡é‚®ä»¶æœåŠ¡å™¨
- æ”¶é‚®ä»¶: å®¢æˆ·ç«¯ â†’ Dovecot IMAP/POP3 â†’ æœ¬åœ°é‚®ä»¶å­˜å‚¨
```

**ğŸ”¹ é…ç½®æ–‡ä»¶çš„æ¨¡å—åŒ–è®¾è®¡**
```
è®¾è®¡ç†å¿µï¼š
- ä¸»é…ç½®æ–‡ä»¶: åŒ…å«åŸºæœ¬è®¾ç½®å’Œæ¨¡å—å¼•ç”¨
- ä¸“é¡¹é…ç½®: æ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹é…ç½®æ–‡ä»¶
- ä¾¿äºç®¡ç†: ä¿®æ”¹ç‰¹å®šåŠŸèƒ½ä¸å½±å“å…¶ä»–éƒ¨åˆ†

å®é™…å¥½å¤„ï¼š
- é™ä½é”™è¯¯é£é™©: ä¸“é¡¹ä¿®æ”¹ä¸“é¡¹æ–‡ä»¶
- ä¾¿äºç‰ˆæœ¬æ§åˆ¶: å¯ä»¥ç‹¬ç«‹è·Ÿè¸ªæ¨¡å—å˜æ›´
- å›¢é˜Ÿåä½œ: ä¸åŒäººå‘˜è´Ÿè´£ä¸åŒé…ç½®æ¨¡å—
```

**ğŸ”¹ é‚®ä»¶å­˜å‚¨æ ¼å¼çš„é€‰æ‹©**
```
Maildir vs mboxï¼š
- ç°ä»£æ¨è: Maildiræ ¼å¼ï¼Œæ¯å°é‚®ä»¶ç‹¬ç«‹æ–‡ä»¶
- å®‰å…¨æ€§: å•ä¸ªé‚®ä»¶æŸåä¸å½±å“å…¶ä»–é‚®ä»¶
- æ€§èƒ½: æ”¯æŒå¹¶å‘è®¿é—®ï¼Œé€‚åˆå¤šç”¨æˆ·ç¯å¢ƒ
- å¤‡ä»½: å¢é‡å¤‡ä»½æ›´å®¹æ˜“å®ç°

è™šæ‹Ÿç”¨æˆ·ç­–ç•¥ï¼š
- å®‰å…¨éš”ç¦»: é‚®ä»¶ç”¨æˆ·ä¸ç­‰äºç³»ç»Ÿç”¨æˆ·
- é›†ä¸­ç®¡ç†: ç»Ÿä¸€çš„ç”¨æˆ·æ•°æ®åº“ç®¡ç†
- æ‰©å±•æ€§: æ”¯æŒå¤§è§„æ¨¡ç”¨æˆ·ç®¡ç†
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒåº”ç”¨åœºæ™¯**
- **ä¼ä¸šé‚®ä»¶ç³»ç»Ÿ**ï¼šå†…éƒ¨å‘˜å·¥é‚®ä»¶æ”¶å‘æœåŠ¡
- **ISPé‚®ä»¶æœåŠ¡**ï¼šä¸ºå®¢æˆ·æä¾›é‚®ä»¶æ”¶å–æœåŠ¡
- **å¤šåŸŸåé‚®å±€**ï¼šç®¡ç†å¤šä¸ªåŸŸåçš„é‚®ä»¶æœåŠ¡
- **ä¸ªäººé‚®ä»¶æœåŠ¡å™¨**ï¼šæ­å»ºç§äººé‚®ä»¶ç³»ç»Ÿ

**ğŸ”§ è¿ç»´å®è·µå»ºè®®**
- **é€æ­¥é…ç½®**ï¼šå…ˆåŸºç¡€åŠŸèƒ½ï¼Œåé«˜çº§ç‰¹æ€§
- **å®‰å…¨ä¼˜å…ˆ**ï¼šSSL/TLSåŠ å¯†æ˜¯å¿…é¡»é…ç½®é¡¹
- **æ€§èƒ½è°ƒä¼˜**ï¼šæ ¹æ®ç”¨æˆ·è§„æ¨¡è°ƒæ•´è¿›ç¨‹å‚æ•°
- **ç›‘æ§å‘Šè­¦**ï¼šå»ºç«‹å®Œå–„çš„æœåŠ¡ç›‘æ§ä½“ç³»
- **å¤‡ä»½ç­–ç•¥**ï¼šå®šæœŸå¤‡ä»½é…ç½®å’Œç”¨æˆ·æ•°æ®

**ğŸ“ˆ æ‰©å±•å‘å±•æ–¹å‘**
- **é«˜å¯ç”¨é›†ç¾¤**ï¼šå¤šæœåŠ¡å™¨è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»
- **å­˜å‚¨ä¼˜åŒ–**ï¼šå¤§å®¹é‡å­˜å‚¨å’Œå½’æ¡£ç­–ç•¥
- **å®‰å…¨å¢å¼º**ï¼šååƒåœ¾é‚®ä»¶ã€ç—…æ¯’æ‰«æé›†æˆ
- **Webç•Œé¢**ï¼šWebç«¯é‚®ä»¶ç®¡ç†å’Œç”¨æˆ·è‡ªæœåŠ¡

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Dovecotæ”¶ä»¶ä¸“å®¶ï¼ŒIMAPåŒæ­¥POPä¸‹è½½
- é…ç½®æ¨¡å—åŒ–è®¾è®¡ï¼Œå®‰å…¨SSLæ˜¯å¿…é¡»
- Maildirå­˜å‚¨æ¨èï¼Œè™šæ‹Ÿç”¨æˆ·æ›´å®‰å…¨
- è¿›ç¨‹ä¼˜åŒ–æ€§èƒ½ï¼Œç›‘æ§å‘Šè­¦ä¿ç¨³å®š