---
title: 7、Dovecot用户认证配置
---
## 📚 目录

1. [Dovecot认证系统概述](#1-Dovecot认证系统概述)
2. [系统用户认证(auth-system)](#2-系统用户认证)
3. [数据库认证(auth-sql)](#3-数据库认证)
4. [LDAP认证(auth-ldap)](#4-LDAP认证)
5. [密码数据库(passdb)配置](#5-密码数据库配置)
6. [用户数据库(userdb)配置](#6-用户数据库配置)
7. [虚拟用户配置实战](#7-虚拟用户配置实战)
8. [认证机制与加密方式](#8-认证机制与加密方式)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 📋 Dovecot认证系统概述


### 1.1 认证系统的作用


**什么是Dovecot认证系统？**
```
简单理解：就是验证"你是谁"和"你能访问什么"的门卫系统

日常类比：
- 银行取款：验证身份(密码) + 查询账户信息(余额、权限)
- 邮件系统：验证用户身份 + 确定邮箱位置和权限

核心任务：
1. 身份验证：用户名+密码是否正确？
2. 用户信息：邮箱存储在哪里？用户ID是什么？
3. 权限控制：这个用户能做什么操作？
```

### 1.2 认证系统架构


**Dovecot认证的双数据库模式**：
```
┌─────────────────┐    ┌─────────────────┐
│   用户登录请求   │    │   邮件客户端     │
│  user@domain.com│    │ (Outlook/手机)   │
└─────────────────┘    └─────────────────┘
          │                       │
          ▼                       ▼
┌─────────────────────────────────────────┐
│           Dovecot认证系统                │
├─────────────────┬───────────────────────┤
│   passdb        │      userdb           │
│  (密码数据库)    │   (用户数据库)         │
│                 │                       │
│ • 验证密码       │ • 用户ID映射           │
│ • 检查用户存在   │ • 邮箱存储路径         │
│ • 权限检查       │ • 用户组权限           │
└─────────────────┴───────────────────────┘
```

**为什么要分两个数据库？**
- **passdb**：专门负责"能不能进门"
- **userdb**：专门负责"进门后去哪个房间"

### 1.3 支持的认证后端


| 认证类型 | **适用场景** | **优势** | **复杂度** |
|---------|------------|----------|-----------|
| 🖥️ **system** | `小型服务器，用户不多` | `配置简单，利用系统用户` | `⭐☆☆` |
| 🗄️ **sql** | `中大型企业，用户管理灵活` | `扩展性强，易于管理` | `⭐⭐⭐` |
| 🌐 **ldap** | `企业环境，统一认证` | `集中管理，与AD集成` | `⭐⭐⭐⭐` |
| 📁 **passwd-file** | `简单环境，静态用户` | `轻量级，易于理解` | `⭐⭐☆` |

---

## 2. 🖥️ 系统用户认证(auth-system)


### 2.1 系统认证基本概念


**什么是系统用户认证？**
```
原理：直接使用Linux系统的用户账户作为邮件用户

实际场景：
系统用户：zhang、li、wang
邮件账户：zhang@company.com、li@company.com、wang@company.com

验证过程：
1. 用户输入 zhang@company.com + 密码
2. Dovecot去检查系统用户zhang的密码
3. 验证通过后，邮件存储在/home/zhang/Maildir/
```

### 2.2 系统认证配置


**主配置文件：`/etc/dovecot/conf.d/10-auth.conf`**
```bash
# 启用系统认证，禁用其他认证
auth_mechanisms = plain login

# 包含系统认证配置
!include auth-system.conf.ext

# 注释掉其他认证方式
#!include auth-sql.conf.ext
#!include auth-ldap.conf.ext
```

**系统认证配置：`/etc/dovecot/conf.d/auth-system.conf.ext`**
```bash
# 密码数据库：使用系统密码文件
passdb {
  driver = pam
  # 使用PAM进行密码验证
}

# 用户数据库：使用系统用户信息
userdb {
  driver = passwd
  # 从/etc/passwd获取用户信息
}

# 如果需要覆盖默认设置
userdb {
  driver = passwd
  # 自定义邮件存储路径
  args = username_format=%n
  default_fields = mail=maildir:~/Maildir
}
```

### 2.3 系统认证的邮箱路径


**默认邮箱位置**：
```
用户：zhang (系统用户)
邮箱路径：/home/zhang/Maildir/

目录结构：
/home/zhang/
├── Maildir/
│   ├── cur/      # 已读邮件
│   ├── new/      # 新邮件  
│   ├── tmp/      # 临时文件
│   └── .Sent/    # 发送邮件文件夹
│       ├── cur/
│       ├── new/
│       └── tmp/
```

> 💡 **提示**：系统认证最适合小型团队，每个员工都有服务器账户的情况

---

## 3. 🗄️ 数据库认证(auth-sql)


### 3.1 SQL认证的优势


**为什么选择数据库认证？**
```
传统方式问题：
- 每个邮件用户都要创建系统账户 → 安全风险
- 用户管理分散 → 维护困难
- 无法灵活设置邮箱配额 → 功能受限

数据库认证优势：
✅ 虚拟用户：邮件用户与系统用户分离
✅ 集中管理：所有用户信息在数据库中
✅ 灵活配置：可以设置配额、权限等
✅ 易于扩展：支持Web管理界面
```

### 3.2 数据库认证配置


**启用SQL认证：`/etc/dovecot/conf.d/10-auth.conf`**
```bash
# 禁用系统认证
#!include auth-system.conf.ext

# 启用SQL认证
!include auth-sql.conf.ext

# 认证机制
auth_mechanisms = plain login cram-md5
```

**SQL认证配置：`/etc/dovecot/conf.d/auth-sql.conf.ext`**
```bash
# 密码数据库：从SQL查询密码
passdb {
  driver = sql
  args = /etc/dovecot/dovecot-sql.conf.ext
}

# 用户数据库：从SQL查询用户信息
userdb {
  driver = sql  
  args = /etc/dovecot/dovecot-sql.conf.ext
}
```

### 3.3 SQL连接配置


**数据库连接文件：`/etc/dovecot/dovecot-sql.conf.ext`**
```bash
# 数据库驱动（MySQL）
driver = mysql

# 数据库连接信息
connect = host=localhost dbname=mailserver user=mailuser password=secretpass

# 默认密码加密方式
default_pass_scheme = SHA256-CRYPT

# 密码查询语句
password_query = \
  SELECT username, domain, password \
  FROM users WHERE username = '%n' AND domain = '%d' AND active = 1

# 用户信息查询语句  
user_query = \
  SELECT \
    username AS user, \
    domain, \
    concat('/var/mail/vhosts/', domain, '/', username) AS home, \
    concat('maildir:/var/mail/vhosts/', domain, '/', username, '/Maildir') AS mail, \
    5000 AS uid, 5000 AS gid \
  FROM users WHERE username = '%n' AND domain = '%d' AND active = 1
```

### 3.4 数据库表结构


**用户表设计示例**：
```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(64) NOT NULL,           -- 用户名部分
    domain VARCHAR(64) NOT NULL,             -- 域名部分  
    password VARCHAR(255) NOT NULL,          -- 加密后的密码
    quota BIGINT DEFAULT 1073741824,         -- 邮箱配额(字节)
    active TINYINT(1) DEFAULT 1,             -- 是否启用
    created DATETIME DEFAULT CURRENT_TIMESTAMP,
    modified DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY email (username, domain)
);

-- 示例数据
INSERT INTO users (username, domain, password) VALUES
('zhang', 'company.com', '{SHA256-CRYPT}$5$rounds=5000$salt$hash...'),
('li', 'company.com', '{SHA256-CRYPT}$5$rounds=5000$salt$hash...'),
('wang', 'company.com', '{SHA256-CRYPT}$5$rounds=5000$salt$hash...');
```

> ⚠️ **注意**：密码必须使用加密存储，明文密码存在严重安全风险

---

## 4. 🌐 LDAP认证(auth-ldap)


### 4.1 LDAP认证应用场景


**什么是LDAP认证？**
```
LDAP = Lightweight Directory Access Protocol (轻量级目录访问协议)

企业场景：
公司有1000名员工，已经使用Active Directory管理用户账户
现在要部署邮件系统，不想重复创建用户信息

解决方案：
邮件系统直接连接到AD/LDAP服务器验证用户
用户使用公司域账户密码收发邮件
```

**LDAP认证流程**：
```
用户登录                    Dovecot服务器              LDAP/AD服务器
    |                           |                          |
    |--[邮件客户端登录]--------->|                          |
    |  zhang@company.com        |                          |
    |  password123              |                          |
    |                           |--[LDAP查询用户]--------->|
    |                           |  查询：zhang@company.com  |
    |                           |<--[返回用户信息]---------|
    |                           |  DN: cn=zhang,ou=users... |
    |                           |                          |
    |                           |--[验证密码]------------->|
    |                           |  bind操作验证密码         |
    |                           |<--[验证结果]-------------|
    |<--[登录成功]---------------|                          |
```

### 4.2 LDAP认证配置


**启用LDAP认证：`/etc/dovecot/conf.d/10-auth.conf`**
```bash
# 启用LDAP认证
!include auth-ldap.conf.ext

# 认证机制
auth_mechanisms = plain login
```

**LDAP认证配置：`/etc/dovecot/conf.d/auth-ldap.conf.ext`**
```bash
# LDAP密码数据库
passdb {
  driver = ldap
  args = /etc/dovecot/dovecot-ldap.conf.ext
}

# LDAP用户数据库
userdb {
  driver = ldap
  args = /etc/dovecot/dovecot-ldap.conf.ext
}
```

### 4.3 LDAP连接配置


**LDAP配置文件：`/etc/dovecot/dovecot-ldap.conf.ext`**
```bash
# LDAP服务器地址
hosts = ldap.company.com:389

# 连接安全设置
tls = yes
tls_require_cert = demand

# 管理员绑定信息（用于搜索用户）
dn = cn=dovecot,ou=services,dc=company,dc=com
dnpass = service_password

# 搜索基础DN
base = ou=users,dc=company,dc=com

# 用户搜索过滤器
user_filter = (&(objectClass=person)(mail=%u))

# 密码验证属性
pass_attrs = mail=user,userPassword=password

# 用户信息属性映射
user_attrs = \
  =home=/var/mail/vhosts/%d/%n, \
  =mail=maildir:/var/mail/vhosts/%d/%n/Maildir, \
  uidNumber=uid, \
  gidNumber=gid
```

### 4.4 Active Directory集成


**AD环境特殊配置**：
```bash
# AD服务器通常使用636端口(LDAPS)
hosts = ad.company.com:636
tls = yes

# AD用户搜索
base = cn=users,dc=company,dc=com
user_filter = (&(objectClass=user)(userPrincipalName=%u))

# AD属性映射
pass_attrs = userPrincipalName=user,unicodePwd=password
user_attrs = \
  userPrincipalName=user, \
  =home=/var/mail/%d/%n, \
  =mail=maildir:/var/mail/%d/%n/Maildir
```

---

## 5. 🔐 密码数据库(passdb)配置


### 5.1 passdb的作用


**密码数据库是什么？**
```
作用：专门负责验证用户身份的数据源

具体任务：
1. 检查用户是否存在
2. 验证密码是否正确  
3. 检查用户是否被禁用
4. 返回额外的用户属性（如权限）

类比：门卫的花名册，记录谁能进入以及他们的权限
```

### 5.2 passdb配置参数


**通用配置格式**：
```bash
passdb {
  driver = 认证驱动类型
  args = 驱动参数
  deny = yes/no          # 是否为拒绝规则
  master = yes/no        # 是否为主密码
  pass = yes/no          # 是否传递给下一个passdb
  skip = never/authenticated/unauthenticated
}
```

**常见驱动类型对比**：

| 驱动类型 | **说明** | **适用场景** |
|---------|----------|-------------|
| `pam` | `系统PAM认证` | `使用系统用户` |
| `passwd` | `系统密码文件` | `简单系统用户认证` |
| `sql` | `SQL数据库` | `虚拟用户，灵活管理` |
| `ldap` | `LDAP目录服务` | `企业环境，统一认证` |
| `passwd-file` | `文本文件` | `小规模，静态用户` |
| `static` | `静态密码` | `测试或特殊需求` |

### 5.3 多重密码数据库


**为什么需要多个passdb？**
```
实际需求：
- 普通用户：使用SQL数据库认证
- 管理员：使用系统账户认证  
- 临时用户：使用静态密码

解决方案：配置多个passdb，按顺序验证
```

**多passdb配置示例**：
```bash
# 第一个：管理员账户（系统用户）
passdb {
  driver = pam
  # 只对admin域的用户生效
  args = session=yes dovecot
  skip = authenticated
}

# 第二个：普通虚拟用户（SQL数据库）
passdb {
  driver = sql
  args = /etc/dovecot/dovecot-sql.conf.ext
}

# 第三个：拒绝特定用户
passdb {
  driver = passwd-file
  args = /etc/dovecot/denied-users
  deny = yes
}
```

### 5.4 密码验证流程


**认证流程图示**：
```
用户登录请求
    |
    ▼
┌─────────────┐
│  passdb #1  │ ──┐
│  (系统用户)  │   │
└─────────────┘   │
    │             │
    ▼             │
 匹配? ────No─────┘
    │Yes           │
    ▼             │
 验证通过 ←────────┘
    │
    ▼
┌─────────────┐
│  passdb #2  │ 
│  (SQL用户)  │ 
└─────────────┘
    │
    ▼
 匹配并验证?
    │Yes
    ▼
  登录成功
```

---

## 6. 👤 用户数据库(userdb)配置


### 6.1 userdb的职责


**用户数据库是什么？**
```
作用：提供用户的详细信息和系统属性

关键信息：
- 用户ID和组ID (uid/gid)
- 邮箱存储路径 (home/mail)
- 系统权限和限制
- 配额设置

类比：员工档案室，记录每个人的详细信息和工作安排
```

**passdb vs userdb 区别**：
```
passdb（门卫）：
❓ 你是谁？密码对吗？
✅ 身份验证通过，可以进入

userdb（档案管理）：  
📋 你的工位在哪里？
📂 你的文件柜在哪里？
⚖️ 你有多少存储空间？
🔧 你有哪些权限？
```

### 6.2 userdb配置格式


**基本配置结构**：
```bash
userdb {
  driver = 数据源类型
  args = 驱动参数
  default_fields = 默认字段设置
  override_fields = 强制覆盖字段
  skip = never/found/notfound
}
```

**关键字段说明**：

| 字段名 | **含义** | **示例值** |
|-------|----------|-----------|
| `user` | `用户名` | `zhang@company.com` |
| `uid` | `系统用户ID` | `5000` |
| `gid` | `系统组ID` | `5000` |
| `home` | `用户主目录` | `/var/mail/company.com/zhang` |
| `mail` | `邮件存储位置` | `maildir:~/Maildir` |
| `quota_rule` | `配额规则` | `*:storage=1G` |

### 6.3 不同驱动的userdb配置


**SQL驱动配置**：
```bash
userdb {
  driver = sql
  args = /etc/dovecot/dovecot-sql.conf.ext
}

# SQL查询示例（在dovecot-sql.conf.ext中）
user_query = \
  SELECT \
    username AS user, \
    5000 AS uid, \
    5000 AS gid, \
    concat('/var/mail/', domain, '/', username) AS home, \
    concat('maildir:/var/mail/', domain, '/', username, '/Maildir') AS mail, \
    concat('*:storage=', quota, 'B') AS quota_rule \
  FROM users \
  WHERE username = '%n' AND domain = '%d' AND active = 1
```

**静态用户配置**：
```bash
userdb {
  driver = static
  args = \
    uid=vmail \
    gid=vmail \
    home=/var/mail/vhosts/%d/%n \
    mail=maildir:~/Maildir
}
```

### 6.4 虚拟用户的系统权限


**为什么需要虚拟用户？**
```
问题：如果每个邮件用户都创建系统账户
❌ 服务器有1000个系统用户 → 安全风险大
❌ 每个用户都有shell权限 → 可能误操作
❌ 用户管理复杂 → 维护困难

解决方案：虚拟用户
✅ 所有邮件文件归属于一个系统用户(vmail)
✅ 通过数据库管理邮件用户，与系统用户分离
✅ 更安全，更易管理
```

**虚拟用户配置示例**：
```bash
# 创建专门的系统用户
sudo useradd -r -u 5000 -g mail -d /var/mail -s /sbin/nologin vmail

# userdb配置
userdb {
  driver = sql
  args = /etc/dovecot/dovecot-sql.conf.ext
  
  # 为所有虚拟用户设置相同的系统权限
  default_fields = \
    uid=vmail \
    gid=mail \
    home=/var/mail/vhosts/%d/%n
}
```

---

## 7. 🏢 虚拟用户配置实战


### 7.1 虚拟用户系统设计


**虚拟用户架构**：
```
邮件系统用户层：
zhang@company.com ──┐
li@company.com    ──┼─── 映射到 ───┐
wang@company.com  ──┘             │
                                  ▼
                           系统用户层：
                           vmail (uid:5000)
                               │
                               ▼
                          文件系统：
                    /var/mail/vhosts/
                    ├── company.com/
                    │   ├── zhang/Maildir/
                    │   ├── li/Maildir/
                    │   └── wang/Maildir/
                    └── example.org/
                        └── admin/Maildir/
```

### 7.2 系统环境准备


**创建虚拟邮件用户**：
```bash
# 创建vmail系统用户和组
sudo groupadd -g 5000 vmail
sudo useradd -g vmail -u 5000 -d /var/mail -s /sbin/nologin vmail

# 创建邮件存储目录
sudo mkdir -p /var/mail/vhosts
sudo chown -R vmail:vmail /var/mail/vhosts
sudo chmod -R 750 /var/mail/vhosts
```

**目录权限设置**：
```bash
# 查看权限设置
ls -la /var/mail/
# drwxr-x--- vmail vmail vhosts/

# 设置正确的SELinux上下文（如果启用）
sudo setsebool -P allow_postfix_local_write_mail_spool 1
```

### 7.3 数据库配置


**创建邮件数据库**：
```sql
-- 创建数据库
CREATE DATABASE mailserver CHARACTER SET utf8mb4;

-- 创建数据库用户
CREATE USER 'mailuser'@'localhost' IDENTIFIED BY 'secure_password';
GRANT SELECT ON mailserver.* TO 'mailuser'@'localhost';

-- 使用数据库
USE mailserver;

-- 域名表
CREATE TABLE domains (
    id INT AUTO_INCREMENT PRIMARY KEY,
    domain VARCHAR(255) NOT NULL UNIQUE,
    active TINYINT(1) DEFAULT 1,
    created DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 用户表
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(64) NOT NULL,
    domain VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,
    quota BIGINT DEFAULT 1073741824,  -- 1GB默认配额
    active TINYINT(1) DEFAULT 1,
    created DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY email (username, domain),
    FOREIGN KEY (domain) REFERENCES domains(domain) ON DELETE CASCADE
);

-- 别名表（可选）
CREATE TABLE aliases (
    id INT AUTO_INCREMENT PRIMARY KEY,
    source VARCHAR(255) NOT NULL,
    destination VARCHAR(255) NOT NULL,
    active TINYINT(1) DEFAULT 1
);
```

**插入测试数据**：
```sql
-- 添加域名
INSERT INTO domains (domain) VALUES ('company.com'), ('example.org');

-- 添加用户（密码使用doveadm pw生成）
INSERT INTO users (username, domain, password, quota) VALUES
('zhang', 'company.com', '{SHA256-CRYPT}$5$rounds=5000$...', 2147483648),
('li', 'company.com', '{SHA256-CRYPT}$5$rounds=5000$...', 1073741824),
('admin', 'example.org', '{SHA256-CRYPT}$5$rounds=5000$...', 5368709120);
```

### 7.4 Dovecot SQL配置


**完整的SQL配置文件**：
```bash
# /etc/dovecot/dovecot-sql.conf.ext
driver = mysql
connect = host=localhost dbname=mailserver user=mailuser password=secure_password

# 密码加密方式
default_pass_scheme = SHA256-CRYPT

# 密码验证查询
password_query = \
  SELECT \
    concat(username, '@', domain) AS user, \
    password \
  FROM users \
  WHERE username = '%n' AND domain = '%d' AND active = 1

# 用户信息查询
user_query = \
  SELECT \
    concat(username, '@', domain) AS user, \
    concat('/var/mail/vhosts/', domain, '/', username) AS home, \
    concat('maildir:/var/mail/vhosts/', domain, '/', username, '/Maildir') AS mail, \
    5000 AS uid, \
    5000 AS gid, \
    concat('*:storage=', quota, 'B') AS quota_rule \
  FROM users \
  WHERE username = '%n' AND domain = '%d' AND active = 1

# 遍历查询（可选，用于doveadm等工具）
iterate_query = \
  SELECT username, domain \
  FROM users \
  WHERE active = 1
```

### 7.5 测试虚拟用户配置


**生成测试密码**：
```bash
# 使用doveadm生成加密密码
doveadm pw -s SHA256-CRYPT
# 输入密码：password123
# 输出：{SHA256-CRYPT}$5$rounds=5000$randomsalt$hashedpassword...
```

**测试认证**：
```bash
# 测试用户认证
doveadm auth test zhang@company.com password123

# 测试用户查询
doveadm user zhang@company.com

# 检查用户邮箱目录
sudo ls -la /var/mail/vhosts/company.com/zhang/
```

---

## 8. 🔐 认证机制与加密方式


### 8.1 认证机制概述


**认证机制是什么？**
```
认证机制 = 客户端和服务器之间传递密码的方式

安全级别从低到高：
📤 PLAIN：明文传输（需要TLS保护）
📤 LOGIN：Base64编码（仍是明文，需要TLS）
🔐 CRAM-MD5：挑战响应，密码不传输
🔐 DIGEST-MD5：更安全的摘要认证
🔒 SCRAM-SHA-1：最新的安全认证机制
```

### 8.2 常用认证机制配置


**认证机制选择原则**：
```
客户端兼容性：
✅ PLAIN/LOGIN：所有客户端都支持
⚠️ CRAM-MD5：大部分客户端支持
❓ DIGEST-MD5/SCRAM：较新客户端支持

安全性要求：
🔒 高安全：SCRAM-SHA-1 + TLS
⚖️ 平衡：CRAM-MD5 + TLS  
⚠️ 基础：PLAIN + TLS
❌ 不推荐：无TLS的任何方式
```

**配置示例**：
```bash
# /etc/dovecot/conf.d/10-auth.conf

# 推荐配置：多种机制支持
auth_mechanisms = plain login cram-md5

# 高安全环境
auth_mechanisms = scram-sha-1 cram-md5 plain

# 简单环境（确保有TLS）
auth_mechanisms = plain login

# 禁用不安全的机制（在没有TLS时）
auth_allow_cleartext = no
```

### 8.3 密码加密方式


**为什么需要密码加密？**
```
数据库安全：
❌ 明文存储：数据库泄露 = 所有密码泄露
⚠️ 简单MD5：彩虹表攻击，容易破解
✅ 加盐哈希：每个密码都有唯一salt，难以破解
🔒 强加密：使用现代加密算法
```

**常用密码加密方式**：

| 加密方式 | **安全级别** | **兼容性** | **推荐度** |
|---------|-------------|-----------|-----------|
| `PLAIN` | `❌ 极低` | `✅ 完美` | `❌ 仅测试用` |
| `MD5` | `❌ 低` | `✅ 很好` | `❌ 不推荐` |
| `SHA1` | `⚠️ 一般` | `✅ 很好` | `⚠️ 勉强可用` |
| `SHA256-CRYPT` | `✅ 高` | `✅ 很好` | `✅ 推荐` |
| `SHA512-CRYPT` | `✅ 很高` | `✅ 很好` | `✅ 强烈推荐` |
| `ARGON2` | `🔒 极高` | `⚠️ 较新` | `🔒 未来趋势` |

### 8.4 密码加密配置


**设置默认加密方式**：
```bash
# /etc/dovecot/dovecot-sql.conf.ext
default_pass_scheme = SHA512-CRYPT

# 支持多种加密方式（自动检测）
# default_pass_scheme = CRYPT
```

**生成不同加密方式的密码**：
```bash
# SHA256-CRYPT（推荐）
doveadm pw -s SHA256-CRYPT -p password123
# {SHA256-CRYPT}$5$rounds=5000$randomsalt$hashedvalue...

# SHA512-CRYPT（更安全）
doveadm pw -s SHA512-CRYPT -p password123
# {SHA512-CRYPT}$6$rounds=5000$randomsalt$hashedvalue...

# ARGON2（最新）
doveadm pw -s ARGON2 -p password123
# {ARGON2}$argon2i$v=19$m=65536,t=2,p=1$randomsalt$hashedvalue...
```

**密码查询时的处理**：
```sql
-- 在数据库查询中指定加密方式
password_query = \
  SELECT \
    username, \
    domain, \
    password, \
    'SHA512-CRYPT' as scheme \
  FROM users \
  WHERE username = '%n' AND domain = '%d'
```

### 8.5 安全配置建议


**TLS/SSL配置**：
```bash
# /etc/dovecot/conf.d/10-ssl.conf

# 强制使用TLS
ssl = required

# SSL证书配置
ssl_cert = </etc/ssl/certs/dovecot.pem
ssl_key = </etc/ssl/private/dovecot.pem

# 安全协议版本
ssl_min_protocol = TLSv1.2
ssl_protocols = !SSLv2 !SSLv3 !TLSv1 !TLSv1.1

# 安全加密套件
ssl_cipher_list = ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS
```

**认证安全设置**：
```bash
# /etc/dovecot/conf.d/10-auth.conf

# 禁用明文认证（除非有TLS）
disable_plaintext_auth = yes

# 认证缓存设置
auth_cache_size = 10M
auth_cache_ttl = 1h
auth_cache_negative_ttl = 5m

# 防暴力破解
auth_failure_delay = 2s
auth_max_failures = 3
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 认证双数据库：passdb验证身份，userdb提供用户信息
🔸 三种认证方式：system(系统用户)、sql(数据库)、ldap(目录服务)  
🔸 虚拟用户优势：安全性高、管理方便、扩展性强
🔸 认证机制选择：plain+TLS(兼容)、cram-md5(安全)、scram(最新)
🔸 密码加密方式：SHA256/512-CRYPT推荐，避免明文和弱加密
```

### 9.2 配置选择指南


**🔹 认证方式选择**
```
小型团队（<20人）：
→ system认证，直接使用系统用户

中型企业（20-500人）：  
→ sql认证，数据库管理用户

大型企业（>500人）：
→ ldap认证，与AD/LDAP集成

混合环境：
→ 多重认证，支持不同用户类型
```

**🔹 安全级别配置**
```
测试环境：
auth_mechanisms = plain
ssl = no (仅内网测试)

生产环境：
auth_mechanisms = plain login cram-md5
ssl = required
disable_plaintext_auth = yes

高安全环境：
auth_mechanisms = scram-sha-1 cram-md5
密码加密：SHA512-CRYPT或ARGON2
```

### 9.3 常见问题排查


**🔧 认证失败排查步骤**：
```
1. 检查用户是否存在：
   doveadm user username@domain.com

2. 测试密码认证：
   doveadm auth test username@domain.com password

3. 查看认证日志：
   tail -f /var/log/dovecot.log

4. 检查数据库连接：
   mysql -u mailuser -p -e "SELECT * FROM users WHERE username='test'"

5. 验证文件权限：
   ls -la /etc/dovecot/dovecot-sql.conf.ext
```

**⚠️ 权限问题解决**：
```
邮件目录权限：
sudo chown -R vmail:vmail /var/mail/vhosts
sudo chmod -R 750 /var/mail/vhosts

配置文件权限：
sudo chown root:dovecot /etc/dovecot/dovecot-sql.conf.ext  
sudo chmod 640 /etc/dovecot/dovecot-sql.conf.ext
```

### 9.4 实际应用价值


**💼 企业部署建议**：
- **小公司**：system认证，快速部署，成本低
- **成长企业**：sql认证，便于管理和扩展
- **大企业**：ldap认证，与现有AD系统集成
- **ISP服务商**：sql认证+web管理界面

**🚀 性能优化建议**：
- 启用认证缓存减少数据库查询
- 使用连接池管理数据库连接
- 定期清理过期用户和日志
- 监控认证成功率和响应时间

**核心记忆口诀**：
> 双库分工很重要，passdb验证userdb信息找  
> 系统简单sql灵活，ldap企业少不了  
> 虚拟用户更安全，加密认证要做好  
> TLS保护不能少，日志监控问题早知道