---
title: 8ã€PostgreSQLæ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜
---
## ğŸ“š ç›®å½•

1. [PostgreSQLæ€§èƒ½ç›‘æ§åŸºç¡€](#1-PostgreSQLæ€§èƒ½ç›‘æ§åŸºç¡€)
2. [æ€§èƒ½ç»Ÿè®¡è§†å›¾pg_statç³»åˆ—](#2-æ€§èƒ½ç»Ÿè®¡è§†å›¾pg_statç³»åˆ—)
3. [æŸ¥è¯¢è®¡åˆ’åˆ†æä¸EXPLAIN](#3-æŸ¥è¯¢è®¡åˆ’åˆ†æä¸EXPLAIN)
4. [æ…¢æŸ¥è¯¢è¯†åˆ«ä¸pg_stat_statements](#4-æ…¢æŸ¥è¯¢è¯†åˆ«ä¸pg_stat_statements)
5. [å†…å­˜å‚æ•°è°ƒä¼˜ç­–ç•¥](#5-å†…å­˜å‚æ•°è°ƒä¼˜ç­–ç•¥)
6. [æ£€æŸ¥ç‚¹ä¸WALé…ç½®ä¼˜åŒ–](#6-æ£€æŸ¥ç‚¹ä¸WALé…ç½®ä¼˜åŒ–)
7. [è¿æ¥æ•°ä¸å·¥ä½œè¿›ç¨‹é…ç½®](#7-è¿æ¥æ•°ä¸å·¥ä½œè¿›ç¨‹é…ç½®)
8. [è‡ªåŠ¨vacuumä¸ç»Ÿè®¡æ”¶é›†](#8-è‡ªåŠ¨vacuumä¸ç»Ÿè®¡æ”¶é›†)
9. [æ‰©å±•ç›‘æ§å·¥å…·ä¸æ’ä»¶](#9-æ‰©å±•ç›‘æ§å·¥å…·ä¸æ’ä»¶)
10. [æ€§èƒ½åŸºå‡†æµ‹è¯•pgbench](#10-æ€§èƒ½åŸºå‡†æµ‹è¯•pgbench)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” PostgreSQLæ€§èƒ½ç›‘æ§åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯PostgreSQLæ€§èƒ½ç›‘æ§


**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
> ğŸ’¡ **æ€§èƒ½ç›‘æ§**ï¼šå°±åƒç»™æ•°æ®åº“è£…ä¸ª"ä½“æ£€ä»ªå™¨"ï¼Œå®æ—¶è§‚å¯Ÿæ•°æ®åº“çš„è¿è¡ŒçŠ¶æ€ï¼Œå‘ç°æ€§èƒ½ç“¶é¢ˆå’Œé—®é¢˜

PostgreSQLæ€§èƒ½ç›‘æ§çš„æœ¬è´¨æ˜¯é€šè¿‡æ”¶é›†å’Œåˆ†ææ•°æ®åº“è¿è¡Œæ—¶çš„å„ç§æŒ‡æ ‡ï¼Œæ¥äº†è§£ï¼š
- **æ•°æ®åº“å¿™ä¸å¿™**ï¼šCPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨æƒ…å†µ
- **æŸ¥è¯¢å¿«ä¸å¿«**ï¼šå“ªäº›SQLæ‰§è¡Œæ…¢ï¼Œä¸ºä»€ä¹ˆæ…¢
- **èµ„æºå¤Ÿä¸å¤Ÿ**ï¼šç¼“å†²åŒºå‘½ä¸­ç‡ã€è¿æ¥æ•°æ˜¯å¦åˆç†

### 1.2 æ€§èƒ½ç›‘æ§çš„é‡è¦æ€§


**ğŸ¯ ä¸ºä»€ä¹ˆè¦åšæ€§èƒ½ç›‘æ§**

```
æ²¡æœ‰ç›‘æ§çš„æ•°æ®åº“ = é—­ç€çœ¼ç›å¼€è½¦

å¸¸è§é—®é¢˜ï¼š
âŒ ç”¨æˆ·åé¦ˆ"ç³»ç»Ÿæ…¢äº†"æ‰çŸ¥é“æœ‰é—®é¢˜
âŒ ä¸çŸ¥é“æ˜¯å“ªä¸ªæŸ¥è¯¢å¯¼è‡´çš„æ€§èƒ½é—®é¢˜  
âŒ æœåŠ¡å™¨èµ„æºæµªè´¹ï¼Œé…ç½®ä¸åˆç†
âŒ æ•°æ®åº“çªç„¶å®•æœºï¼Œæ‰¾ä¸åˆ°åŸå› 

æœ‰äº†ç›‘æ§çš„å¥½å¤„ï¼š
âœ… æå‰å‘ç°æ€§èƒ½ç“¶é¢ˆ
âœ… ç²¾ç¡®å®šä½é—®é¢˜SQL
âœ… åˆç†é…ç½®æœåŠ¡å™¨èµ„æº
âœ… é¢„é˜²æ€§èƒ½æ•…éšœ
```

### 1.3 PostgreSQLæ€§èƒ½ç›‘æ§æ¶æ„


**ğŸ—ï¸ ç›‘æ§ä½“ç³»ç»“æ„**

```
PostgreSQLç›‘æ§ä½“ç³»ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åº”ç”¨ç¨‹åºå±‚                 â”‚ â† åº”ç”¨æ€§èƒ½ç›‘æ§
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        PostgreSQLæ•°æ®åº“å±‚           â”‚ â† æ•°æ®åº“æ€§èƒ½ç›‘æ§
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æŸ¥è¯¢ç›‘æ§     â”‚ ç³»ç»Ÿè§†å›¾ç›‘æ§     â”‚   â”‚
â”‚  â”‚ EXPLAIN     â”‚ pg_stat_*      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           æ“ä½œç³»ç»Ÿå±‚                 â”‚ â† ç³»ç»Ÿèµ„æºç›‘æ§
â”‚     CPU / å†…å­˜ / ç£ç›˜ / ç½‘ç»œ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ“Š æ€§èƒ½ç»Ÿè®¡è§†å›¾pg_statç³»åˆ—


### 2.1 pg_statç³»åˆ—è§†å›¾æ¦‚è¿°


**ğŸ”¸ ä»€ä¹ˆæ˜¯pg_statè§†å›¾**

PostgreSQLå†…ç½®äº†ä¸€å¥—ç»Ÿè®¡ä¿¡æ¯æ”¶é›†ç³»ç»Ÿï¼Œå°±åƒæ•°æ®åº“çš„"ä»ªè¡¨ç›˜"ï¼Œå±•ç¤ºå„ç§è¿è¡ŒæŒ‡æ ‡ï¼š

```sql
-- æŸ¥çœ‹æ‰€æœ‰pg_statå¼€å¤´çš„è§†å›¾
SELECT schemaname, viewname 
FROM pg_views 
WHERE viewname LIKE 'pg_stat%' 
ORDER BY viewname;
```

### 2.2 æ ¸å¿ƒç»Ÿè®¡è§†å›¾è¯¦è§£


#### ğŸ”¹ æ•°æ®åº“çº§åˆ«ç»Ÿè®¡ - pg_stat_database


**ä½œç”¨**ï¼šæŸ¥çœ‹æ¯ä¸ªæ•°æ®åº“çš„æ•´ä½“ç»Ÿè®¡ä¿¡æ¯

```sql
-- æŸ¥çœ‹æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
SELECT 
    datname AS "æ•°æ®åº“å",
    numbackends AS "å½“å‰è¿æ¥æ•°",
    xact_commit AS "æäº¤äº‹åŠ¡æ•°",
    xact_rollback AS "å›æ»šäº‹åŠ¡æ•°",
    blks_read AS "ç£ç›˜å—è¯»å–",
    blks_hit AS "ç¼“å­˜å‘½ä¸­",
    round(blks_hit * 100.0 / (blks_hit + blks_read), 2) AS "ç¼“å­˜å‘½ä¸­ç‡%"
FROM pg_stat_database 
WHERE datname = current_database();
```

**ğŸ” å…³é”®æŒ‡æ ‡è§£è¯»**
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼šåº”è¯¥åœ¨95%ä»¥ä¸Šï¼Œä½äº†è¯´æ˜å†…å­˜ä¸å¤Ÿ
- **è¿æ¥æ•°**ï¼šä¸åº”è¯¥æ¥è¿‘max_connectionsé™åˆ¶
- **äº‹åŠ¡æ¯”ä¾‹**ï¼šå›æ»šäº‹åŠ¡å¤ªå¤šå¯èƒ½æœ‰é—®é¢˜

#### ğŸ”¹ è¡¨çº§åˆ«ç»Ÿè®¡ - pg_stat_user_tables


**ä½œç”¨**ï¼šæŸ¥çœ‹æ¯å¼ è¡¨çš„è®¿é—®ç»Ÿè®¡

```sql
-- æŸ¥çœ‹è¡¨çš„è¯»å†™ç»Ÿè®¡
SELECT 
    relname AS "è¡¨å",
    seq_scan AS "é¡ºåºæ‰«ææ¬¡æ•°",
    seq_tup_read AS "é¡ºåºè¯»å–è¡Œæ•°",
    idx_scan AS "ç´¢å¼•æ‰«ææ¬¡æ•°",
    idx_tup_fetch AS "ç´¢å¼•è·å–è¡Œæ•°",
    n_tup_ins AS "æ’å…¥è¡Œæ•°",
    n_tup_upd AS "æ›´æ–°è¡Œæ•°",
    n_tup_del AS "åˆ é™¤è¡Œæ•°"
FROM pg_stat_user_tables
ORDER BY seq_scan DESC;
```

**âš ï¸ æ³¨æ„ä¿¡å·**
- **seq_scanå¾ˆé«˜ä½†idx_scanå¾ˆä½**ï¼šå¯èƒ½ç¼ºå°‘ç´¢å¼•
- **seq_tup_readå¾ˆå¤§**ï¼šè¯´æ˜ç»å¸¸å…¨è¡¨æ‰«æï¼Œæ€§èƒ½å·®

#### ğŸ”¹ ç´¢å¼•ç»Ÿè®¡ - pg_stat_user_indexes


**ä½œç”¨**ï¼šæŸ¥çœ‹ç´¢å¼•çš„ä½¿ç”¨æƒ…å†µ

```sql
-- æŸ¥çœ‹æœªä½¿ç”¨çš„ç´¢å¼•
SELECT 
    schemaname AS "æ¨¡å¼",
    relname AS "è¡¨å", 
    indexrelname AS "ç´¢å¼•å",
    idx_scan AS "ä½¿ç”¨æ¬¡æ•°",
    pg_size_pretty(pg_relation_size(indexrelid)) AS "ç´¢å¼•å¤§å°"
FROM pg_stat_user_indexes 
WHERE idx_scan = 0
ORDER BY pg_relation_size(indexrelid) DESC;
```

### 2.3 å®æ—¶æ´»åŠ¨ç›‘æ§


#### ğŸ”¹ å½“å‰æ´»åŠ¨æŸ¥è¯¢ - pg_stat_activity


**ä½œç”¨**ï¼šæŸ¥çœ‹å½“å‰æ­£åœ¨æ‰§è¡Œçš„SQLå’Œè¿æ¥çŠ¶æ€

```sql
-- æŸ¥çœ‹å½“å‰æ´»åŠ¨è¿æ¥
SELECT 
    pid AS "è¿›ç¨‹ID",
    usename AS "ç”¨æˆ·",
    application_name AS "åº”ç”¨",
    client_addr AS "å®¢æˆ·ç«¯IP", 
    state AS "çŠ¶æ€",
    query_start AS "æŸ¥è¯¢å¼€å§‹æ—¶é—´",
    now() - query_start AS "æ‰§è¡Œæ—¶é•¿",
    query AS "å½“å‰SQL"
FROM pg_stat_activity 
WHERE state = 'active'
AND query != '<IDLE>'
ORDER BY query_start;
```

**ğŸš¨ é—®é¢˜è¯Šæ–­**
- **æ‰§è¡Œæ—¶é—´å¾ˆé•¿çš„æŸ¥è¯¢**ï¼šå¯èƒ½æ˜¯æ…¢SQL
- **å¤§é‡idle in transaction**ï¼šåº”ç”¨æ²¡æœ‰åŠæ—¶æäº¤äº‹åŠ¡
- **waitingçŠ¶æ€å¤š**ï¼šå¯èƒ½æœ‰é”ç­‰å¾…é—®é¢˜

---

## 3. ğŸ” æŸ¥è¯¢è®¡åˆ’åˆ†æä¸EXPLAIN


### 3.1 ä»€ä¹ˆæ˜¯æŸ¥è¯¢è®¡åˆ’


**ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ**
> ğŸ’¡ **æŸ¥è¯¢è®¡åˆ’**ï¼šå°±åƒGPSå¯¼èˆªä¸€æ ·ï¼ŒPostgreSQLä¸ºæ¯ä¸ªSQLæŸ¥è¯¢åˆ¶å®šçš„"æ‰§è¡Œè·¯çº¿å›¾"

å½“ä½ æ‰§è¡Œä¸€ä¸ªSQLæŸ¥è¯¢æ—¶ï¼ŒPostgreSQLä¸æ˜¯ç›´æ¥å»æ‰§è¡Œï¼Œè€Œæ˜¯å…ˆåˆ†æï¼š
- **æ€ä¹ˆæ‰¾æ•°æ®æœ€å¿«**ï¼šç”¨ç´¢å¼•è¿˜æ˜¯å…¨è¡¨æ‰«æï¼Ÿ
- **å¤šè¡¨å…³è”æ€ä¹ˆè¿**ï¼šå…ˆè¿å“ªå¼ è¡¨æ•ˆç‡æ›´é«˜ï¼Ÿ
- **æ•°æ®æ€ä¹ˆæ’åº**ï¼šåœ¨å†…å­˜æ’åºè¿˜æ˜¯ç”¨ä¸´æ—¶æ–‡ä»¶ï¼Ÿ

### 3.2 EXPLAINå‘½ä»¤è¯¦è§£


#### ğŸ”¹ åŸºç¡€EXPLAINç”¨æ³•


```sql
-- åŸºç¡€è¯­æ³•ï¼šåªçœ‹æ‰§è¡Œè®¡åˆ’ï¼Œä¸çœŸæ­£æ‰§è¡Œ
EXPLAIN SELECT * FROM users WHERE age > 25;

-- è¯¦ç»†ä¿¡æ¯ï¼šæ˜¾ç¤ºæ›´å¤šæ‰§è¡Œç»†èŠ‚
EXPLAIN (ANALYZE, BUFFERS) 
SELECT u.name, o.total 
FROM users u 
JOIN orders o ON u.id = o.user_id 
WHERE u.age > 25;
```

#### ğŸ”¹ EXPLAINè¾“å‡ºè§£è¯»


**ğŸ“Š æ‰§è¡Œè®¡åˆ’ç¤ºä¾‹**

```
Nested Loop  (cost=0.29..16.89 rows=5 width=68) (actual time=0.034..0.089 rows=3 loops=1)
  Buffers: shared hit=8
  ->  Seq Scan on users u  (cost=0.00..10.75 rows=5 width=36) (actual time=0.018..0.039 rows=3 loops=1)
        Filter: (age > 25)
        Rows Removed by Filter: 2
        Buffers: shared hit=1
  ->  Index Scan using orders_user_id_idx on orders o  (cost=0.29..1.23 rows=1 width=36) (actual time=0.012..0.015 rows=1 loops=3)
        Index Cond: (user_id = u.id)
        Buffers: shared hit=7
Planning Time: 0.234 ms
Execution Time: 0.123 ms
```

**ğŸ” å…³é”®ä¿¡æ¯è§£è¯»**

| å­—æ®µ | å«ä¹‰ | è¯´æ˜ |
|------|------|------|
| **cost** | ğŸ’° **æ‰§è¡Œæˆæœ¬** | `å¯åŠ¨æˆæœ¬..æ€»æˆæœ¬`ï¼Œæ•°å€¼è¶Šå°è¶Šå¥½ |
| **rows** | ğŸ“Š **é¢„ä¼°è¡Œæ•°** | ä¼˜åŒ–å™¨é¢„æµ‹ä¼šè¿”å›å¤šå°‘è¡Œ |
| **actual time** | â±ï¸ **å®é™…æ—¶é—´** | `å¯åŠ¨æ—¶é—´..æ€»æ—¶é—´`ï¼ˆæ¯«ç§’ï¼‰ |
| **loops** | ğŸ”„ **å¾ªç¯æ¬¡æ•°** | è¿™ä¸ªèŠ‚ç‚¹æ‰§è¡Œäº†å‡ æ¬¡ |
| **Buffers** | ğŸ’¾ **ç¼“å†²åŒº** | å†…å­˜å‘½ä¸­ï¼ˆhitï¼‰å’Œç£ç›˜è¯»å–ï¼ˆreadï¼‰ |

### 3.3 å¸¸è§æ‰§è¡ŒèŠ‚ç‚¹ç±»å‹


**ğŸ¯ æ‰§è¡ŒèŠ‚ç‚¹è§£è¯»**

```
æ‰«æèŠ‚ç‚¹ï¼š
â”œâ”€â”€ Seq Scan      # å…¨è¡¨æ‰«æï¼ˆæœ€æ…¢ï¼‰
â”œâ”€â”€ Index Scan    # ç´¢å¼•æ‰«æï¼ˆå¿«ï¼‰  
â”œâ”€â”€ Index Only Scan # ä»…ç´¢å¼•æ‰«æï¼ˆæœ€å¿«ï¼‰
â””â”€â”€ Bitmap Scan   # ä½å›¾æ‰«æï¼ˆä¸­ç­‰ï¼‰

è¿æ¥èŠ‚ç‚¹ï¼š
â”œâ”€â”€ Nested Loop   # åµŒå¥—å¾ªç¯ï¼ˆå°è¡¨ï¼‰
â”œâ”€â”€ Hash Join     # å“ˆå¸Œè¿æ¥ï¼ˆå¤§è¡¨ï¼‰
â””â”€â”€ Merge Join    # å½’å¹¶è¿æ¥ï¼ˆå·²æ’åºï¼‰

å…¶ä»–èŠ‚ç‚¹ï¼š
â”œâ”€â”€ Sort          # æ’åºæ“ä½œ
â”œâ”€â”€ Aggregate     # èšåˆæ“ä½œï¼ˆCOUNTã€SUMç­‰ï¼‰
â””â”€â”€ Filter        # è¿‡æ»¤æ¡ä»¶
```

### 3.4 æ€§èƒ½é—®é¢˜è¯†åˆ«


**ğŸš¨ å¸¸è§æ€§èƒ½é—®é¢˜ä¿¡å·**

```sql
-- è¯†åˆ«å…¨è¡¨æ‰«æé—®é¢˜
EXPLAIN (ANALYZE, BUFFERS) 
SELECT * FROM large_table WHERE some_column = 'value';

-- é—®é¢˜ä¿¡å·ï¼š
-- âŒ Seq Scan on large_table (cost=0.00..50000.00 rows=1000000)
-- âœ… Index Scan using idx_some_column (cost=0.29..8.32 rows=1)
```

> âš ï¸ **æ€§èƒ½è­¦å‘Š**ï¼š
> - Seq Scanåœ¨å¤§è¡¨ä¸Šå‡ºç°
> - costå€¼è¶…è¿‡1000
> - actual timeè¶…è¿‡é¢„æœŸ
> - Buffersæ˜¾ç¤ºå¤§é‡ç£ç›˜è¯»å–

---

## 4. ğŸŒ æ…¢æŸ¥è¯¢è¯†åˆ«ä¸pg_stat_statements


### 4.1 ä»€ä¹ˆæ˜¯pg_stat_statements


**ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ**
> ğŸ’¡ **pg_stat_statements**ï¼šPostgreSQLçš„"æ…¢æŸ¥è¯¢æ—¥å¿—å¢å¼ºç‰ˆ"ï¼Œè‡ªåŠ¨æ”¶é›†æ‰€æœ‰SQLçš„æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯

è¿™ä¸ªæ‰©å±•å°±åƒç»™æ•°æ®åº“è£…äº†ä¸ª"è¡Œè½¦è®°å½•ä»ª"ï¼Œè®°å½•æ¯ä¸ªSQLçš„ï¼š
- **æ‰§è¡Œäº†å¤šå°‘æ¬¡**
- **æ€»å…±ç”¨äº†å¤šé•¿æ—¶é—´**  
- **å¹³å‡æ‰§è¡Œæ—¶é—´**
- **æ¶ˆè€—äº†å¤šå°‘èµ„æº**

### 4.2 å¯ç”¨pg_stat_statements


#### ğŸ”¹ å®‰è£…å’Œé…ç½®


```bash
# 1. ä¿®æ”¹postgresql.conf
echo "shared_preload_libraries = 'pg_stat_statements'" >> /etc/postgresql/13/main/postgresql.conf
echo "pg_stat_statements.track = all" >> /etc/postgresql/13/main/postgresql.conf
echo "pg_stat_statements.max = 10000" >> /etc/postgresql/13/main/postgresql.conf

# 2. é‡å¯PostgreSQL
sudo systemctl restart postgresql

# 3. åœ¨æ•°æ®åº“ä¸­åˆ›å»ºæ‰©å±•
psql -U postgres -c "CREATE EXTENSION pg_stat_statements;"
```

#### ğŸ”¹ é…ç½®å‚æ•°è¯´æ˜


| å‚æ•° | å«ä¹‰ | æ¨èå€¼ |
|------|------|--------|
| **track** | è·Ÿè¸ªçº§åˆ« | `all`ï¼ˆè·Ÿè¸ªæ‰€æœ‰SQLï¼‰ |
| **max** | æœ€å¤§è®°å½•æ•° | `10000`ï¼ˆè®°å½•1ä¸‡æ¡SQLï¼‰ |
| **track_utility** | è·Ÿè¸ªDDLè¯­å¥ | `on`ï¼ˆå»ºè®®å¼€å¯ï¼‰ |

### 4.3 æ…¢æŸ¥è¯¢åˆ†æå®æˆ˜


#### ğŸ”¹ æ‰¾å‡ºæœ€æ…¢çš„SQL


```sql
-- æŒ‰å¹³å‡æ‰§è¡Œæ—¶é—´æ’åºï¼Œæ‰¾å‡ºæœ€æ…¢çš„æŸ¥è¯¢
SELECT 
    round(total_exec_time::numeric, 2) AS "æ€»æ‰§è¡Œæ—¶é—´(ms)",
    calls AS "æ‰§è¡Œæ¬¡æ•°",
    round(mean_exec_time::numeric, 2) AS "å¹³å‡æ—¶é—´(ms)",
    round((total_exec_time/sum(total_exec_time) OVER())*100, 2) AS "æ—¶é—´å æ¯”%",
    query AS "SQLè¯­å¥"
FROM pg_stat_statements 
ORDER BY mean_exec_time DESC 
LIMIT 10;
```

#### ğŸ”¹ æ‰¾å‡ºæ‰§è¡Œæ¬¡æ•°æœ€å¤šçš„SQL


```sql
-- æŒ‰æ‰§è¡Œæ¬¡æ•°æ’åºï¼Œæ‰¾å‡ºæœ€é¢‘ç¹çš„æŸ¥è¯¢
SELECT 
    calls AS "æ‰§è¡Œæ¬¡æ•°",
    round(total_exec_time::numeric, 2) AS "æ€»æ—¶é—´(ms)",
    round(mean_exec_time::numeric, 2) AS "å¹³å‡æ—¶é—´(ms)",
    substring(query, 1, 100) AS "SQLè¯­å¥(å‰100å­—ç¬¦)"
FROM pg_stat_statements 
ORDER BY calls DESC 
LIMIT 10;
```

#### ğŸ”¹ æ‰¾å‡ºIOæ¶ˆè€—æœ€å¤§çš„SQL


```sql
-- æŒ‰ç£ç›˜è¯»å–é‡æ’åº
SELECT 
    shared_blks_read AS "ç£ç›˜è¯»å–å—æ•°",
    shared_blks_hit AS "ç¼“å­˜å‘½ä¸­å—æ•°",
    round(shared_blks_hit * 100.0 / (shared_blks_hit + shared_blks_read), 2) AS "ç¼“å­˜å‘½ä¸­ç‡%",
    calls AS "æ‰§è¡Œæ¬¡æ•°",
    substring(query, 1, 80) AS "SQLè¯­å¥"
FROM pg_stat_statements 
WHERE shared_blks_read > 0
ORDER BY shared_blks_read DESC 
LIMIT 10;
```

### 4.4 æ…¢æŸ¥è¯¢ä¼˜åŒ–æµç¨‹


**ğŸ”§ ç³»ç»ŸåŒ–ä¼˜åŒ–æ­¥éª¤**

```
æ…¢æŸ¥è¯¢ä¼˜åŒ–æµç¨‹ï¼š

1ï¸âƒ£ è¯†åˆ«é—®é¢˜
   â”œâ”€â”€ æ‰¾å‡ºæ‰§è¡Œæ—¶é—´é•¿çš„SQL
   â”œâ”€â”€ æ‰¾å‡ºæ‰§è¡Œé¢‘ç‡é«˜çš„SQL
   â””â”€â”€ æ‰¾å‡ºèµ„æºæ¶ˆè€—å¤§çš„SQL

2ï¸âƒ£ åˆ†æåŸå›   
   â”œâ”€â”€ ä½¿ç”¨EXPLAINåˆ†ææ‰§è¡Œè®¡åˆ’
   â”œâ”€â”€ æ£€æŸ¥æ˜¯å¦ç¼ºå°‘ç´¢å¼•
   â””â”€â”€ æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯æ˜¯å¦è¿‡æœŸ

3ï¸âƒ£ åˆ¶å®šæ–¹æ¡ˆ
   â”œâ”€â”€ æ·»åŠ åˆé€‚çš„ç´¢å¼•
   â”œâ”€â”€ é‡å†™SQLè¯­å¥
   â””â”€â”€ è°ƒæ•´ç›¸å…³å‚æ•°

4ï¸âƒ£ éªŒè¯æ•ˆæœ
   â”œâ”€â”€ å¯¹æ¯”ä¼˜åŒ–å‰åçš„æ‰§è¡Œæ—¶é—´
   â”œâ”€â”€ æ£€æŸ¥æ‰§è¡Œè®¡åˆ’å˜åŒ–
   â””â”€â”€ ç›‘æ§ç³»ç»Ÿæ•´ä½“æ€§èƒ½
```

---

## 5. ğŸ’¾ å†…å­˜å‚æ•°è°ƒä¼˜ç­–ç•¥


### 5.1 PostgreSQLå†…å­˜æ¶æ„


**ğŸ—ï¸ å†…å­˜ä½¿ç”¨ç»“æ„**

```
PostgreSQLå†…å­˜æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å…±äº«å†…å­˜åŒºåŸŸ              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      shared_buffers             â”‚ â”‚ â† æ•°æ®é¡µç¼“å­˜
â”‚  â”‚      (æœ€é‡è¦çš„å†…å­˜å‚æ•°)           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  
â”‚  â”‚      WAL buffers               â”‚ â”‚ â† é¢„å†™æ—¥å¿—ç¼“å­˜
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            è¿›ç¨‹ç§æœ‰å†…å­˜              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      work_mem                  â”‚ â”‚ â† æ’åº/è¿æ¥å†…å­˜
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      maintenance_work_mem      â”‚ â”‚ â† ç»´æŠ¤æ“ä½œå†…å­˜
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 shared_buffersè°ƒä¼˜


**ğŸ“‹ ä»€ä¹ˆæ˜¯shared_buffers**
> ğŸ’¡ **shared_buffers**ï¼šPostgreSQLæœ€é‡è¦çš„å†…å­˜å‚æ•°ï¼Œå°±åƒæ•°æ®åº“çš„"å†…å­˜ä»“åº“"ï¼Œå­˜æ”¾ç»å¸¸è®¿é—®çš„æ•°æ®é¡µ

#### ğŸ”¹ è®¾ç½®åŸåˆ™å’Œå»ºè®®


```bash
# æŸ¥çœ‹å½“å‰è®¾ç½®
SHOW shared_buffers;

# åŸºæœ¬è®¾ç½®åŸåˆ™ï¼š
# ğŸ“Š å°å‹ç³»ç»Ÿï¼ˆ<4GBå†…å­˜ï¼‰ï¼šè®¾ç½®ä¸ºæ€»å†…å­˜çš„25%
# ğŸ“Š ä¸­å‹ç³»ç»Ÿï¼ˆ4-32GBå†…å­˜ï¼‰ï¼šè®¾ç½®ä¸ºæ€»å†…å­˜çš„25%-40%  
# ğŸ“Š å¤§å‹ç³»ç»Ÿï¼ˆ>32GBå†…å­˜ï¼‰ï¼šè®¾ç½®ä¸º8GB-16GB
```

**ğŸ’¡ å®é™…é…ç½®ç¤ºä¾‹**

| æœåŠ¡å™¨å†…å­˜ | shared_buffersæ¨èå€¼ | é…ç½®ç¤ºä¾‹ |
|-----------|---------------------|----------|
| **4GB** | `1GB` | `shared_buffers = 1GB` |
| **8GB** | `2GB` | `shared_buffers = 2GB` |
| **16GB** | `4GB` | `shared_buffers = 4GB` |
| **32GB+** | `8GB-16GB` | `shared_buffers = 8GB` |

#### ğŸ”¹ ç›‘æ§shared_buffersæ•ˆæœ


```sql
-- æŸ¥çœ‹ç¼“å†²åŒºå‘½ä¸­ç‡
SELECT 
    'shared_bufferså‘½ä¸­ç‡' AS "æŒ‡æ ‡",
    round(
        blks_hit * 100.0 / (blks_hit + blks_read), 2
    ) AS "å‘½ä¸­ç‡%"
FROM pg_stat_database 
WHERE datname = current_database();

-- å‘½ä¸­ç‡åº”è¯¥ä¿æŒåœ¨95%ä»¥ä¸Š
-- å¦‚æœä½äº95%ï¼Œå¯èƒ½éœ€è¦å¢åŠ shared_buffers
```

### 5.3 work_memè°ƒä¼˜


**ğŸ“‹ ä»€ä¹ˆæ˜¯work_mem**
> ğŸ’¡ **work_mem**ï¼šæ¯ä¸ªæŸ¥è¯¢æ“ä½œï¼ˆæ’åºã€è¿æ¥ã€åˆ†ç»„ï¼‰å¯ä»¥ä½¿ç”¨çš„å†…å­˜å¤§å°

```sql
-- æŸ¥çœ‹å½“å‰è®¾ç½®
SHOW work_mem;

-- è®¾ç½®åŸåˆ™ï¼š
-- ğŸ”¸ é»˜è®¤å€¼é€šå¸¸æ˜¯4MBï¼Œå¯¹äºå¤æ‚æŸ¥è¯¢å¯èƒ½ä¸å¤Ÿ
-- ğŸ”¸ è®¡ç®—å…¬å¼ï¼š(æ€»å†…å­˜ - shared_buffers) / max_connections / 4
-- ğŸ”¸ å¯ä»¥é’ˆå¯¹ä¼šè¯ä¸´æ—¶è°ƒæ•´
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
- work_memè®¾ç½®è¿‡å°ï¼šå¤æ‚æŸ¥è¯¢ä¼šä½¿ç”¨ç£ç›˜ä¸´æ—¶æ–‡ä»¶ï¼Œå¾ˆæ…¢
- work_memè®¾ç½®è¿‡å¤§ï¼šå¯èƒ½å¯¼è‡´å†…å­˜ä¸è¶³ï¼Œç³»ç»Ÿswap

#### ğŸ”¹ åŠ¨æ€è°ƒæ•´work_mem


```sql
-- é’ˆå¯¹å¤æ‚æŸ¥è¯¢ä¸´æ—¶å¢åŠ work_mem
SET work_mem = '256MB';
SELECT /* å¤æ‚çš„åˆ†ææŸ¥è¯¢ */;
RESET work_mem;

-- æŸ¥çœ‹æ˜¯å¦ä½¿ç”¨äº†ä¸´æ—¶æ–‡ä»¶
EXPLAIN (ANALYZE, BUFFERS) 
SELECT user_id, COUNT(*) 
FROM large_table 
GROUP BY user_id 
ORDER BY COUNT(*) DESC;

-- å¦‚æœçœ‹åˆ° "Disk:" è¯´æ˜ä½¿ç”¨äº†ç£ç›˜ä¸´æ—¶æ–‡ä»¶
```

### 5.4 å…¶ä»–é‡è¦å†…å­˜å‚æ•°


#### ğŸ”¹ maintenance_work_mem


```bash
# ç»´æŠ¤æ“ä½œï¼ˆVACUUMã€CREATE INDEXï¼‰ä½¿ç”¨çš„å†…å­˜
# æ¨èè®¾ç½®ä¸ºæ€»å†…å­˜çš„5%-10%
maintenance_work_mem = 1GB

# å½±å“çš„æ“ä½œï¼š
# âœ… åˆ›å»ºç´¢å¼•é€Ÿåº¦
# âœ… VACUUMæ•ˆç‡  
# âœ… å¤–é”®æ£€æŸ¥é€Ÿåº¦
```

#### ğŸ”¹ effective_cache_size


```bash
# å‘Šè¯‰ä¼˜åŒ–å™¨ç³»ç»Ÿæœ‰å¤šå°‘å†…å­˜å¯ç”¨äºç¼“å­˜
# è¿™ä¸ªå‚æ•°ä¸å®é™…åˆ†é…å†…å­˜ï¼Œåªæ˜¯ç»™ä¼˜åŒ–å™¨çš„"å»ºè®®"
# æ¨èè®¾ç½®ä¸ºæ€»å†…å­˜çš„75%
effective_cache_size = 12GB
```

### 5.5 å†…å­˜è°ƒä¼˜å®æˆ˜æ£€æŸ¥


```sql
-- å†…å­˜ä½¿ç”¨æƒ…å†µæ£€æŸ¥è„šæœ¬
WITH memory_stats AS (
    SELECT 
        setting AS shared_buffers_mb,
        (setting::int * 8192 / 1024 / 1024) AS shared_buffers_actual_mb
    FROM pg_settings WHERE name = 'shared_buffers'
),
cache_hit AS (
    SELECT round(
        sum(blks_hit) * 100.0 / (sum(blks_hit) + sum(blks_read)), 2
    ) AS hit_ratio
    FROM pg_stat_database
)
SELECT 
    m.shared_buffers_mb AS "shared_buffersè®¾ç½®",
    m.shared_buffers_actual_mb AS "å®é™…MB",
    c.hit_ratio AS "ç¼“å­˜å‘½ä¸­ç‡%",
    CASE 
        WHEN c.hit_ratio >= 95 THEN 'âœ… è‰¯å¥½'
        WHEN c.hit_ratio >= 90 THEN 'âš ï¸ éœ€è¦å…³æ³¨'  
        ELSE 'âŒ éœ€è¦ä¼˜åŒ–'
    END AS "çŠ¶æ€è¯„ä¼°"
FROM memory_stats m, cache_hit c;
```

---

## 6. ğŸš€ æ£€æŸ¥ç‚¹ä¸WALé…ç½®ä¼˜åŒ–


### 6.1 ä»€ä¹ˆæ˜¯æ£€æŸ¥ç‚¹å’ŒWAL


**ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ**
> ğŸ’¡ **WALï¼ˆWrite-Ahead Loggingï¼‰**ï¼šé¢„å†™æ—¥å¿—ï¼Œå°±åƒæ•°æ®åº“çš„"é»‘åŒ£å­"ï¼Œå…ˆè®°å½•è¦åšä»€ä¹ˆæ“ä½œï¼Œå†æ‰§è¡Œæ“ä½œ

> ğŸ’¡ **æ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰**ï¼šå®šæœŸæŠŠå†…å­˜ä¸­çš„è„æ•°æ®å†™å…¥ç£ç›˜ï¼Œå°±åƒå®šæœŸ"ä¿å­˜æ¸¸æˆè¿›åº¦"

**ğŸ”„ WALå’Œæ£€æŸ¥ç‚¹çš„å…³ç³»**

```
WALå’Œæ£€æŸ¥ç‚¹å·¥ä½œæµç¨‹ï¼š

1ï¸âƒ£ æ•°æ®ä¿®æ”¹
   â”œâ”€â”€ å…ˆå†™WALæ—¥å¿—ï¼ˆè®°å½•è¦åšä»€ä¹ˆï¼‰
   â”œâ”€â”€ å†ä¿®æ”¹å†…å­˜ä¸­çš„æ•°æ®é¡µ
   â””â”€â”€ æš‚æ—¶ä¸å†™ç£ç›˜ï¼ˆæé«˜æ€§èƒ½ï¼‰

2ï¸âƒ£ æ£€æŸ¥ç‚¹è§¦å‘
   â”œâ”€â”€ å®šæ—¶è§¦å‘ï¼ˆcheckpoint_timeoutï¼‰
   â”œâ”€â”€ WALæ—¥å¿—é‡è¾¾åˆ°é˜ˆå€¼
   â””â”€â”€ æ‰‹åŠ¨æ‰§è¡ŒCHECKPOINTå‘½ä»¤

3ï¸âƒ£ æ£€æŸ¥ç‚¹æ‰§è¡Œ
   â”œâ”€â”€ æŠŠæ‰€æœ‰è„é¡µå†™å…¥ç£ç›˜
   â”œâ”€â”€ æ›´æ–°æ§åˆ¶æ–‡ä»¶
   â””â”€â”€ æ¸…ç†æ—§çš„WALæ–‡ä»¶
```

### 6.2 WALç›¸å…³å‚æ•°ä¼˜åŒ–


#### ğŸ”¹ wal_buffersè°ƒä¼˜


```bash
# WALç¼“å†²åŒºå¤§å°ï¼Œå­˜æ”¾è¿˜æœªå†™å…¥ç£ç›˜çš„WALè®°å½•
# æ¨èè®¾ç½®ä¸ºshared_buffersçš„3%-10%
wal_buffers = 16MB

# è®¾ç½®åŸåˆ™ï¼š
# ğŸ”¸ é»˜è®¤-1è¡¨ç¤ºè‡ªåŠ¨è°ƒæ•´
# ğŸ”¸ é«˜å¹¶å‘å†™å…¥åœºæ™¯å¯ä»¥é€‚å½“å¢å¤§
# ğŸ”¸ ä¸€èˆ¬ä¸éœ€è¦è¶…è¿‡64MB
```

#### ğŸ”¹ wal_writer_delayè°ƒä¼˜


```bash
# WALå†™å…¥å™¨çš„å”¤é†’é—´éš”
# é»˜è®¤200msï¼Œé«˜å¹¶å‘å¯ä»¥è°ƒå°
wal_writer_delay = 100ms

# å½±å“ï¼š
# âœ… å€¼è¶Šå°ï¼ŒWALå†™å…¥è¶ŠåŠæ—¶ï¼Œäº‹åŠ¡å»¶è¿Ÿè¶Šä½
# âŒ å€¼å¤ªå°ï¼Œå¯èƒ½å¢åŠ ç³»ç»Ÿè°ƒç”¨å¼€é”€
```

### 6.3 æ£€æŸ¥ç‚¹å‚æ•°ä¼˜åŒ–


#### ğŸ”¹ checkpoint_timeout


```bash
# æ£€æŸ¥ç‚¹æ—¶é—´é—´éš”
# é»˜è®¤5åˆ†é’Ÿï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡è°ƒæ•´
checkpoint_timeout = 15min

# è®¾ç½®è€ƒè™‘ï¼š
# ğŸ”¸ é—´éš”å¤ªçŸ­ï¼šé¢‘ç¹çš„ç£ç›˜å†™å…¥ï¼Œå½±å“æ€§èƒ½
# ğŸ”¸ é—´éš”å¤ªé•¿ï¼šæ•…éšœæ¢å¤æ—¶é—´é•¿ï¼ŒWALæ–‡ä»¶å ç”¨ç©ºé—´å¤§
```

#### ğŸ”¹ max_wal_sizeå’Œmin_wal_size


```bash
# WALæ–‡ä»¶çš„æœ€å¤§å’Œæœ€å°å¤§å°
max_wal_size = 4GB      # WALæ–‡ä»¶æ€»å¤§å°è¶…è¿‡æ­¤å€¼ä¼šè§¦å‘æ£€æŸ¥ç‚¹
min_wal_size = 1GB      # ä¿ç•™çš„æœ€å°WALæ–‡ä»¶å¤§å°

# è°ƒä¼˜å»ºè®®ï¼š
# ğŸ“Š å†™å…¥é‡å¤§çš„ç³»ç»Ÿï¼šå¢åŠ max_wal_sizeåˆ°8GB-16GB
# ğŸ“Š ç£ç›˜ç©ºé—´å……è¶³ï¼šé€‚å½“å¢å¤§å¯ä»¥å‡å°‘æ£€æŸ¥ç‚¹é¢‘ç‡
```

#### ğŸ”¹ checkpoint_completion_target


```bash
# æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡ï¼Œæ§åˆ¶æ£€æŸ¥ç‚¹çš„å†™å…¥é€Ÿåº¦
checkpoint_completion_target = 0.9

# å«ä¹‰ï¼š
# ğŸ”¸ 0.9è¡¨ç¤ºåœ¨90%çš„æ£€æŸ¥ç‚¹é—´éš”å†…å®Œæˆå†™å…¥
# ğŸ”¸ é¿å…æ£€æŸ¥ç‚¹é›†ä¸­å†™å…¥é€ æˆIOå³°å€¼
# ğŸ”¸ æ¨èå€¼0.7-0.9
```

### 6.4 ç›‘æ§æ£€æŸ¥ç‚¹æ€§èƒ½


#### ğŸ”¹ æ£€æŸ¥ç‚¹ç»Ÿè®¡ä¿¡æ¯


```sql
-- æŸ¥çœ‹æ£€æŸ¥ç‚¹ç»Ÿè®¡
SELECT 
    checkpoints_timed AS "å®šæ—¶æ£€æŸ¥ç‚¹",
    checkpoints_req AS "è¯·æ±‚æ£€æŸ¥ç‚¹", 
    checkpoint_write_time AS "å†™å…¥æ—¶é—´(ms)",
    checkpoint_sync_time AS "åŒæ­¥æ—¶é—´(ms)",
    buffers_checkpoint AS "æ£€æŸ¥ç‚¹å†™å…¥é¡µæ•°",
    buffers_clean AS "åå°å†™å…¥é¡µæ•°",
    buffers_backend AS "åç«¯è¿›ç¨‹å†™å…¥é¡µæ•°"
FROM pg_stat_bgwriter;
```

**ğŸ” æŒ‡æ ‡åˆ†æ**
- **checkpoints_reqè¾ƒé«˜**ï¼šWALæ–‡ä»¶å¢é•¿å¤ªå¿«ï¼Œè€ƒè™‘å¢åŠ max_wal_size
- **å†™å…¥/åŒæ­¥æ—¶é—´é•¿**ï¼šIOæ€§èƒ½ç“¶é¢ˆï¼Œè€ƒè™‘è°ƒæ•´checkpoint_completion_target
- **buffers_backendè¾ƒé«˜**ï¼šåå°å†™å…¥è·Ÿä¸ä¸Šï¼Œè€ƒè™‘è°ƒæ•´bgwriterå‚æ•°

#### ğŸ”¹ WALæ–‡ä»¶ç›‘æ§


```bash
# æŸ¥çœ‹WALæ–‡ä»¶æ•°é‡å’Œå¤§å°
ls -la /var/lib/postgresql/13/main/pg_wal/ | wc -l
du -sh /var/lib/postgresql/13/main/pg_wal/

# WALæ®µå¤§å°ï¼ˆé€šå¸¸æ˜¯16MBï¼‰
SHOW wal_segment_size;
```

### 6.5 WALé…ç½®ä¼˜åŒ–æ¡ˆä¾‹


**ğŸ¯ ä¸åŒåœºæ™¯çš„ä¼˜åŒ–ç­–ç•¥**

```bash
# é«˜å¹¶å‘OLTPç³»ç»Ÿ
wal_buffers = 32MB
checkpoint_timeout = 10min  
max_wal_size = 8GB
checkpoint_completion_target = 0.9

# æ‰¹é‡æ•°æ®å¤„ç†ç³»ç»Ÿ  
wal_buffers = 64MB
checkpoint_timeout = 30min
max_wal_size = 16GB
checkpoint_completion_target = 0.8

# åªè¯»æˆ–è½»é‡çº§ç³»ç»Ÿ
wal_buffers = 16MB  
checkpoint_timeout = 15min
max_wal_size = 2GB
checkpoint_completion_target = 0.7
```

---

## 7. ğŸ‘¥ è¿æ¥æ•°ä¸å·¥ä½œè¿›ç¨‹é…ç½®


### 7.1 è¿æ¥æ•°é…ç½®åŸºç¡€


**ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ**
> ğŸ’¡ **è¿æ¥æ•°é…ç½®**ï¼šæ§åˆ¶PostgreSQLèƒ½åŒæ—¶å¤„ç†å¤šå°‘ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œå°±åƒé¤å…çš„"åº§ä½æ•°"ç®¡ç†

PostgreSQLä½¿ç”¨è¿›ç¨‹æ¨¡å‹ï¼Œæ¯ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªåç«¯è¿›ç¨‹ï¼Œæ‰€ä»¥è¿æ¥æ•°ç›´æ¥å½±å“ï¼š
- **å†…å­˜ä½¿ç”¨é‡**ï¼šæ¯ä¸ªè¿æ¥æ¶ˆè€—å‡ MBå†…å­˜
- **ç³»ç»Ÿæ€§èƒ½**ï¼šè¿æ¥æ•°è¿‡å¤šä¼šæ‹–å®ç³»ç»Ÿ
- **å¹¶å‘èƒ½åŠ›**ï¼šè¿æ¥æ•°è¿‡å°‘ä¼šé™åˆ¶å¹¶å‘

### 7.2 max_connectionså‚æ•°è¯¦è§£


#### ğŸ”¹ max_connectionsè®¾ç½®åŸåˆ™


```bash
# æŸ¥çœ‹å½“å‰æœ€å¤§è¿æ¥æ•°
SHOW max_connections;

# åŸºæœ¬è®¾ç½®åŸåˆ™
max_connections = 200

# è®¡ç®—å…¬å¼ï¼š
# ğŸ“Š Webåº”ç”¨ï¼šå¹¶å‘ç”¨æˆ·æ•° Ã— 2-4
# ğŸ“Š APIæœåŠ¡ï¼šé¢„ä¼°å¹¶å‘è¯·æ±‚ Ã— 1.5  
# ğŸ“Š æ•°æ®åˆ†æï¼šé€šå¸¸50-100å³å¯
# ğŸ“Š é«˜å¹¶å‘ç³»ç»Ÿï¼šé…åˆè¿æ¥æ± ï¼Œè®¾ç½®300-500
```

**ğŸ’¡ ä¸åŒåœºæ™¯çš„æ¨èå€¼**

| åº”ç”¨ç±»å‹ | æ¨èè¿æ¥æ•° | è¯´æ˜ |
|----------|-----------|------|
| **å°å‹Webåº”ç”¨** | `100-200` | ä¸­å°ä¼ä¸šå®˜ç½‘ã€åšå®¢ç³»ç»Ÿ |
| **ç”µå•†ç³»ç»Ÿ** | `300-500` | é«˜å¹¶å‘äº¤æ˜“ï¼Œé…åˆè¿æ¥æ±  |
| **æ•°æ®åˆ†æ** | `50-100` | é•¿æ—¶é—´è¿è¡Œçš„åˆ†ææŸ¥è¯¢ |
| **å¾®æœåŠ¡æ¶æ„** | `200-300` | å¤šä¸ªæœåŠ¡å…±äº«æ•°æ®åº“ |

#### ğŸ”¹ è¿æ¥æ•°ç›‘æ§


```sql
-- æŸ¥çœ‹å½“å‰è¿æ¥çŠ¶æ€
SELECT 
    count(*) AS "æ€»è¿æ¥æ•°",
    count(*) FILTER (WHERE state = 'active') AS "æ´»è·ƒè¿æ¥",
    count(*) FILTER (WHERE state = 'idle') AS "ç©ºé—²è¿æ¥",
    count(*) FILTER (WHERE state = 'idle in transaction') AS "äº‹åŠ¡ä¸­ç©ºé—²",
    round(count(*) * 100.0 / (SELECT setting::int FROM pg_settings WHERE name = 'max_connections'), 2) AS "è¿æ¥ä½¿ç”¨ç‡%"
FROM pg_stat_activity;
```

**ğŸš¨ è¿æ¥é—®é¢˜è¯Šæ–­**

```sql
-- æ‰¾å‡ºé•¿æ—¶é—´è¿è¡Œçš„è¿æ¥
SELECT 
    pid,
    usename AS "ç”¨æˆ·",
    application_name AS "åº”ç”¨",
    state AS "çŠ¶æ€", 
    now() - state_change AS "çŠ¶æ€æŒç»­æ—¶é—´",
    now() - query_start AS "æŸ¥è¯¢è¿è¡Œæ—¶é—´",
    substring(query, 1, 100) AS "SQL"
FROM pg_stat_activity 
WHERE state != 'idle'
AND now() - state_change > interval '5 minutes'
ORDER BY state_change;
```

### 7.3 å·¥ä½œè¿›ç¨‹é…ç½®


#### ğŸ”¹ max_worker_processes


```bash
# æœ€å¤§å·¥ä½œè¿›ç¨‹æ•°ï¼Œå½±å“å¹¶è¡ŒæŸ¥è¯¢å’Œç»´æŠ¤æ“ä½œ
max_worker_processes = 16

# è®¾ç½®å»ºè®®ï¼š
# ğŸ”¸ é€šå¸¸è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°çš„2-4å€
# ğŸ”¸ 4æ ¸CPUï¼šè®¾ç½®ä¸º8-16
# ğŸ”¸ 8æ ¸CPUï¼šè®¾ç½®ä¸º16-32
```

#### ğŸ”¹ max_parallel_workers


```bash
# å¹¶è¡ŒæŸ¥è¯¢çš„æœ€å¤§å·¥ä½œè¿›ç¨‹æ•°
max_parallel_workers = 8

# è®¾ç½®åŸåˆ™ï¼š
# ğŸ”¸ ä¸è¶…è¿‡max_worker_processes  
# ğŸ”¸ é€šå¸¸è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°
# ğŸ”¸ OLTPç³»ç»Ÿå¯ä»¥è®¾ç½®å°ä¸€äº›ï¼ŒOLAPç³»ç»Ÿå¯ä»¥è®¾ç½®å¤§ä¸€äº›
```

#### ğŸ”¹ max_parallel_workers_per_gather


```bash
# å•ä¸ªæŸ¥è¯¢æœ€å¤šä½¿ç”¨çš„å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•°
max_parallel_workers_per_gather = 4

# å½±å“ï¼š
# âœ… å¤æ‚æŸ¥è¯¢å¯ä»¥åˆ©ç”¨å¤šæ ¸å¿ƒå¹¶è¡Œæ‰§è¡Œ
# âŒ è®¾ç½®è¿‡å¤§å¯èƒ½å¯¼è‡´èµ„æºäº‰æŠ¢
```

### 7.4 è¿æ¥æ± é…ç½®


**ğŸ”§ ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æ± **

```
ä¸ä½¿ç”¨è¿æ¥æ± çš„é—®é¢˜ï¼š

Webåº”ç”¨æœåŠ¡å™¨
â”œâ”€â”€ è¿æ¥1 â”€â”€â”€â”€â”€â”€â”€â”€â”
â”œâ”€â”€ è¿æ¥2 â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”œâ”€â”€ è¿æ¥3 â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â†’ PostgreSQL (max_connections=200)
â”œâ”€â”€ ...          â”‚
â””â”€â”€ è¿æ¥200 â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
âŒ æ¯ä¸ªè¿æ¥æ¶ˆè€—4-8MBå†…å­˜
âŒ è¿æ¥åˆ›å»º/é”€æ¯å¼€é”€å¤§
âŒ ç©ºé—²è¿æ¥æµªè´¹èµ„æº
```

#### ğŸ”¹ PgBouncerè¿æ¥æ± é…ç½®


```bash
# å®‰è£…PgBouncer
sudo apt install pgbouncer

# é…ç½®æ–‡ä»¶ /etc/pgbouncer/pgbouncer.ini
[databases]
myapp = host=localhost port=5432 dbname=myapp

[pgbouncer]
listen_addr = 127.0.0.1
listen_port = 6432
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt
pool_mode = transaction        # äº‹åŠ¡çº§è¿æ¥æ± 
max_client_conn = 1000        # æœ€å¤§å®¢æˆ·ç«¯è¿æ¥
default_pool_size = 25        # æ¯ä¸ªæ•°æ®åº“çš„è¿æ¥æ± å¤§å°
```

**ğŸ“Š è¿æ¥æ± æ•ˆæœå¯¹æ¯”**

| é…ç½®æ–¹å¼ | æ•°æ®åº“è¿æ¥æ•° | åº”ç”¨è¿æ¥æ•° | å†…å­˜ä½¿ç”¨ |
|----------|-------------|-----------|----------|
| **æ— è¿æ¥æ± ** | `1000` | `1000` | `4-8GB` |
| **æœ‰è¿æ¥æ± ** | `25` | `1000` | `100-200MB` |

---

## 8. ğŸ§¹ è‡ªåŠ¨vacuumä¸ç»Ÿè®¡æ”¶é›†


### 8.1 ä»€ä¹ˆæ˜¯VACUUM


**ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ**
> ğŸ’¡ **VACUUM**ï¼šPostgreSQLçš„"åƒåœ¾æ¸…ç†å‘˜"ï¼Œæ¸…ç†åˆ é™¤å’Œæ›´æ–°æ“ä½œç•™ä¸‹çš„"åƒåœ¾"æ•°æ®

PostgreSQLé‡‡ç”¨MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ï¼Œåˆ é™¤æ•°æ®æ—¶ä¸æ˜¯çœŸæ­£åˆ é™¤ï¼Œè€Œæ˜¯æ ‡è®°ä¸º"å·²åˆ é™¤"ï¼š

```
MVCCå·¥ä½œåŸç†ç¤ºä¾‹ï¼š

åŸå§‹æ•°æ®ï¼š
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID  â”‚ Name â”‚ Status  â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1   â”‚ Tom  â”‚ Active  â”‚ â† æ´»è·ƒæ•°æ®
â”‚ 2   â”‚ John â”‚ Active  â”‚ â† æ´»è·ƒæ•°æ®  
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰§è¡ŒDELETE FROM users WHERE id = 1åï¼š
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID  â”‚ Name â”‚ Status  â”‚ çŠ¶æ€     â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1   â”‚ Tom  â”‚ Active  â”‚ å·²åˆ é™¤   â”‚ â† æ­»å…ƒç»„
â”‚ 2   â”‚ John â”‚ Active  â”‚ æ´»è·ƒ     â”‚ â† æ´»è·ƒæ•°æ®
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VACUUMåï¼š
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID  â”‚ Name â”‚ Status  â”‚  
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2   â”‚ John â”‚ Active  â”‚ â† æ­»å…ƒç»„è¢«æ¸…ç†
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 è‡ªåŠ¨VACUUMé…ç½®


#### ğŸ”¹ autovacuumåŸºæœ¬å‚æ•°


```bash
# å¯ç”¨è‡ªåŠ¨vacuumï¼ˆé»˜è®¤å¼€å¯ï¼‰
autovacuum = on

# è‡ªåŠ¨vacuumè¿›ç¨‹æ•°é‡
autovacuum_max_workers = 3

# æ£€æŸ¥é—´éš”
autovacuum_naptime = 1min

# è§¦å‘vacuumçš„æ¡ä»¶
autovacuum_vacuum_threshold = 50        # æœ€å°‘æ­»å…ƒç»„æ•°
autovacuum_vacuum_scale_factor = 0.2    # æ­»å…ƒç»„æ¯”ä¾‹é˜ˆå€¼

# è®¡ç®—å…¬å¼ï¼š
# vacuumè§¦å‘æ¡ä»¶ = autovacuum_vacuum_threshold + è¡¨å¤§å° Ã— autovacuum_vacuum_scale_factor
```

**ğŸ’¡ è§¦å‘æ¡ä»¶è§£é‡Š**

å‡è®¾ä¸€å¼ è¡¨æœ‰1000è¡Œæ•°æ®ï¼š
- æ­»å…ƒç»„é˜ˆå€¼ = 50 + 1000 Ã— 0.2 = 250
- å½“æ­»å…ƒç»„æ•°é‡è¾¾åˆ°250æ—¶ï¼Œè‡ªåŠ¨è§¦å‘VACUUM

#### ğŸ”¹ è‡ªåŠ¨ANALYZEé…ç½®


```bash
# ANALYZEç”¨äºæ›´æ–°è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¸®åŠ©ä¼˜åŒ–å™¨é€‰æ‹©æ›´å¥½çš„æ‰§è¡Œè®¡åˆ’
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.1

# è®¡ç®—å…¬å¼ç±»ä¼¼ï¼Œä½†é˜ˆå€¼æ›´å°ï¼Œå› ä¸ºç»Ÿè®¡ä¿¡æ¯æ›´æ–°æ›´é‡è¦
```

### 8.3 ç›‘æ§VACUUMçŠ¶æ€


#### ğŸ”¹ æŸ¥çœ‹VACUUMæ´»åŠ¨


```sql
-- æŸ¥çœ‹å½“å‰æ­£åœ¨è¿›è¡Œçš„VACUUMæ“ä½œ
SELECT 
    pid,
    datname AS "æ•°æ®åº“",
    usename AS "ç”¨æˆ·",  
    state AS "çŠ¶æ€",
    query AS "å½“å‰æ“ä½œ"
FROM pg_stat_activity 
WHERE query LIKE '%vacuum%' OR query LIKE '%autovacuum%';
```

#### ğŸ”¹ æŸ¥çœ‹è¡¨çš„VACUUMç»Ÿè®¡


```sql
-- æŸ¥çœ‹è¡¨çš„vacuumå’Œanalyzeå†å²
SELECT 
    schemaname AS "æ¨¡å¼",
    relname AS "è¡¨å",
    last_vacuum AS "æœ€åvacuumæ—¶é—´",
    last_autovacuum AS "æœ€åè‡ªåŠ¨vacuumæ—¶é—´", 
    last_analyze AS "æœ€åanalyzeæ—¶é—´",
    last_autoanalyze AS "æœ€åè‡ªåŠ¨analyzeæ—¶é—´",
    vacuum_count AS "vacuumæ¬¡æ•°",
    autovacuum_count AS "è‡ªåŠ¨vacuumæ¬¡æ•°"
FROM pg_stat_user_tables
ORDER BY last_autovacuum DESC NULLS LAST;
```

#### ğŸ”¹ æ£€æŸ¥è¡¨çš„è†¨èƒ€æƒ…å†µ


```sql
-- æŸ¥çœ‹è¡¨çš„ç©ºé—´ä½¿ç”¨å’Œè†¨èƒ€æƒ…å†µ
SELECT 
    schemaname AS "æ¨¡å¼",
    tablename AS "è¡¨å",
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS "æ€»å¤§å°",
    n_dead_tup AS "æ­»å…ƒç»„æ•°é‡",
    n_live_tup AS "æ´»è·ƒå…ƒç»„æ•°é‡",
    round(n_dead_tup * 100.0 / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS "æ­»å…ƒç»„æ¯”ä¾‹%"
FROM pg_stat_user_tables 
WHERE n_dead_tup > 0
ORDER BY n_dead_tup DESC;
```

### 8.4 VACUUMè°ƒä¼˜ç­–ç•¥


#### ğŸ”¹ é’ˆå¯¹é«˜æ›´æ–°é¢‘ç‡è¡¨çš„ä¼˜åŒ–


```sql
-- ä¸ºé¢‘ç¹æ›´æ–°çš„è¡¨è®¾ç½®æ›´æ¿€è¿›çš„autovacuumå‚æ•°
ALTER TABLE high_update_table SET (
    autovacuum_vacuum_threshold = 100,
    autovacuum_vacuum_scale_factor = 0.1,
    autovacuum_analyze_threshold = 50,
    autovacuum_analyze_scale_factor = 0.05
);
```

#### ğŸ”¹ é’ˆå¯¹å¤§è¡¨çš„ä¼˜åŒ–


```sql
-- ä¸ºå¤§è¡¨è®¾ç½®æ›´å¤šçš„vacuumå·¥ä½œå†…å­˜
ALTER TABLE large_table SET (
    autovacuum_vacuum_cost_limit = 2000,    # å¢åŠ costé™åˆ¶
    autovacuum_vacuum_cost_delay = 10       # å‡å°‘å»¶è¿Ÿ
);
```

#### ğŸ”¹ æ‰‹åŠ¨VACUUMæ“ä½œ


```sql
-- åŸºç¡€VACUUMï¼ˆæ¸…ç†æ­»å…ƒç»„ï¼‰
VACUUM table_name;

-- VACUUM ANALYZEï¼ˆæ¸…ç†+æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼‰
VACUUM ANALYZE table_name;

-- VACUUM FULLï¼ˆå®Œå…¨é‡å»ºè¡¨ï¼Œä¼šé”è¡¨ï¼‰
-- âš ï¸ æ³¨æ„ï¼šVACUUM FULLä¼šé”è¡¨ï¼Œç”Ÿäº§ç¯å¢ƒæ…ç”¨
VACUUM FULL table_name;

-- æŸ¥çœ‹VACUUMè¿›åº¦ï¼ˆPostgreSQL 9.6+ï¼‰
SELECT 
    pid,
    datname,
    relid::regclass AS "è¡¨å",
    phase AS "é˜¶æ®µ",
    heap_blks_total AS "æ€»é¡µæ•°",
    heap_blks_scanned AS "å·²æ‰«æé¡µæ•°",
    heap_blks_vacuumed AS "å·²æ¸…ç†é¡µæ•°"
FROM pg_stat_progress_vacuum;
```

### 8.5 ç»Ÿè®¡ä¿¡æ¯ç®¡ç†


#### ğŸ”¹ ç»Ÿè®¡ä¿¡æ¯çš„é‡è¦æ€§


> ğŸ’¡ **ç»Ÿè®¡ä¿¡æ¯**ï¼šå‘Šè¯‰ä¼˜åŒ–å™¨è¡¨ä¸­æ•°æ®çš„åˆ†å¸ƒæƒ…å†µï¼Œå¸®åŠ©é€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’

```sql
-- æŸ¥çœ‹è¡¨çš„ç»Ÿè®¡ä¿¡æ¯
SELECT 
    tablename AS "è¡¨å",
    attname AS "åˆ—å", 
    n_distinct AS "ä¸åŒå€¼æ•°é‡",
    most_common_vals AS "æœ€å¸¸è§å€¼",
    most_common_freqs AS "æœ€å¸¸è§å€¼é¢‘ç‡"
FROM pg_stats 
WHERE tablename = 'your_table_name';
```

#### ğŸ”¹ æ‰‹åŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯


```sql
-- æ›´æ–°å•ä¸ªè¡¨çš„ç»Ÿè®¡ä¿¡æ¯
ANALYZE table_name;

-- æ›´æ–°æ•´ä¸ªæ•°æ®åº“çš„ç»Ÿè®¡ä¿¡æ¯
ANALYZE;

-- æ›´æ–°ç‰¹å®šåˆ—çš„ç»Ÿè®¡ä¿¡æ¯
ANALYZE table_name (column1, column2);
```

---

## 9. ğŸ”§ æ‰©å±•ç›‘æ§å·¥å…·ä¸æ’ä»¶


### 9.1 PostgreSQLç›‘æ§ç”Ÿæ€æ¦‚è§ˆ


**ğŸ› ï¸ ç›‘æ§å·¥å…·åˆ†ç±»**

```
PostgreSQLç›‘æ§å·¥å…·ç”Ÿæ€ï¼š

å†…ç½®å·¥å…·ï¼š
â”œâ”€â”€ pg_stat_* ç³»åˆ—è§†å›¾          # åŸºç¡€ç»Ÿè®¡ä¿¡æ¯
â”œâ”€â”€ pg_stat_statements          # SQLæ‰§è¡Œç»Ÿè®¡  
â””â”€â”€ EXPLAIN æ‰§è¡Œè®¡åˆ’åˆ†æ        # æŸ¥è¯¢æ€§èƒ½åˆ†æ

è½»é‡çº§å·¥å…·ï¼š
â”œâ”€â”€ pgAdmin                     # å›¾å½¢åŒ–ç®¡ç†ç•Œé¢
â”œâ”€â”€ pg_top                      # å®æ—¶è¿›ç¨‹ç›‘æ§
â””â”€â”€ pg_stat_kcache             # å†…æ ¸çº§ç¼“å­˜ç»Ÿè®¡

ä¸“ä¸šç›‘æ§å¹³å°ï¼š
â”œâ”€â”€ Prometheus + Grafana        # å¼€æºç›‘æ§æ–¹æ¡ˆ
â”œâ”€â”€ pgMonitor                   # PostgreSQLä¸“ç”¨ç›‘æ§
â””â”€â”€ CloudWatch (AWS RDS)        # äº‘å¹³å°ç›‘æ§
```

### 9.2 pg_stat_kcacheæ‰©å±•


**ğŸ“‹ ä»€ä¹ˆæ˜¯pg_stat_kcache**
> ğŸ’¡ **pg_stat_kcache**ï¼šæ”¶é›†æ“ä½œç³»ç»Ÿçº§åˆ«çš„ç¼“å­˜å’ŒIOç»Ÿè®¡ä¿¡æ¯ï¼Œè¡¥å……pg_stat_statementsçš„ä¸è¶³

#### ğŸ”¹ å®‰è£…å’Œé…ç½®


```bash
# å®‰è£…pg_stat_kcache
sudo apt install postgresql-13-pg-stat-kcache

# é…ç½®postgresql.conf
echo "shared_preload_libraries = 'pg_stat_statements,pg_stat_kcache'" >> /etc/postgresql/13/main/postgresql.conf

# é‡å¯å¹¶åˆ›å»ºæ‰©å±•
sudo systemctl restart postgresql
psql -U postgres -c "CREATE EXTENSION pg_stat_kcache;"
```

#### ğŸ”¹ ä½¿ç”¨pg_stat_kcacheåˆ†æIO


```sql
-- æŸ¥çœ‹SQLçš„ç³»ç»Ÿçº§IOç»Ÿè®¡
SELECT 
    query,
    calls AS "æ‰§è¡Œæ¬¡æ•°",
    round(total_exec_time::numeric, 2) AS "æ€»æ‰§è¡Œæ—¶é—´(ms)",
    reads AS "ç³»ç»Ÿè¯»å–æ¬¡æ•°", 
    writes AS "ç³»ç»Ÿå†™å…¥æ¬¡æ•°",
    user_time AS "ç”¨æˆ·CPUæ—¶é—´",
    system_time AS "ç³»ç»ŸCPUæ—¶é—´"
FROM pg_stat_statements s
JOIN pg_stat_kcache k ON s.queryid = k.queryid
ORDER BY reads DESC
LIMIT 10;
```

### 9.3 pg_topå®æ—¶ç›‘æ§


**ğŸ“Š ä»€ä¹ˆæ˜¯pg_top**
> ğŸ’¡ **pg_top**ï¼šPostgreSQLç‰ˆçš„topå‘½ä»¤ï¼Œå®æ—¶æ˜¾ç¤ºæ•°æ®åº“è¿›ç¨‹æ´»åŠ¨

```bash
# å®‰è£…pg_top
sudo apt install pgtop

# åŸºæœ¬ä½¿ç”¨
pg_top -h localhost -U postgres -d your_database

# å¸¸ç”¨å‚æ•°
pg_top -h localhost -U postgres -d mydb -s 5  # æ¯5ç§’åˆ·æ–°
```

**ğŸ” pg_topæ˜¾ç¤ºä¿¡æ¯è§£è¯»**

```
pg_topè¾“å‡ºç¤ºä¾‹ï¼š

last pid:  1234;  load averages:  0.50,  0.40,  0.30
5 processes:  2 running, 2 idle, 1 waiting

  PID USERNAME SIZE   RES STATE   TIME     CPU  COMMAND
  123 postgres 45M   32M  running  0:05.23  2.5%  SELECT COUNT(*) FROM orders
  124 postgres 28M   20M  idle     0:00.45  0.1%  <IDLE>
  125 postgres 31M   22M  waiting  0:12.34  1.2%  UPDATE users SET last_login...

å…³é”®ä¿¡æ¯ï¼š
ğŸ”¸ SIZE: è¿›ç¨‹è™šæ‹Ÿå†…å­˜å¤§å°
ğŸ”¸ RES: è¿›ç¨‹å®é™…å†…å­˜ä½¿ç”¨  
ğŸ”¸ STATE: è¿›ç¨‹çŠ¶æ€ï¼ˆrunning/idle/waitingï¼‰
ğŸ”¸ CPU: CPUä½¿ç”¨ç‡
```

### 9.4 Prometheus + Grafanaç›‘æ§æ–¹æ¡ˆ


#### ğŸ”¹ å®‰è£…postgres_exporter


```bash
# ä¸‹è½½postgres_exporter
wget https://github.com/prometheus-community/postgres_exporter/releases/download/v0.10.1/postgres_exporter-0.10.1.linux-amd64.tar.gz
tar xzf postgres_exporter-0.10.1.linux-amd64.tar.gz

# åˆ›å»ºç›‘æ§ç”¨æˆ·
psql -U postgres -c "CREATE USER postgres_exporter WITH PASSWORD 'password';"
psql -U postgres -c "GRANT CONNECT ON DATABASE postgres TO postgres_exporter;"
psql -U postgres -c "GRANT pg_monitor TO postgres_exporter;"

# é…ç½®ç¯å¢ƒå˜é‡
export DATA_SOURCE_NAME="postgresql://postgres_exporter:password@localhost/postgres?sslmode=disable"

# å¯åŠ¨exporter
./postgres_exporter
```

#### ğŸ”¹ Prometheusé…ç½®


```yaml
# prometheus.ymlé…ç½®
scrape_configs:
  - job_name: 'postgresql'
    static_configs:
      - targets: ['localhost:9187']
    scrape_interval: 15s
    metrics_path: /metrics
```

#### ğŸ”¹ Grafanaä»ªè¡¨æ¿


```json
# å…³é”®æŒ‡æ ‡é¢æ¿é…ç½®
{
  "title": "PostgreSQL Performance",
  "panels": [
    {
      "title": "è¿æ¥æ•°",
      "targets": [
        {
          "expr": "pg_stat_database_numbackends{datname=\"$database\"}"
        }
      ]
    },
    {
      "title": "ç¼“å­˜å‘½ä¸­ç‡", 
      "targets": [
        {
          "expr": "rate(pg_stat_database_blks_hit{datname=\"$database\"}[5m]) / (rate(pg_stat_database_blks_hit{datname=\"$database\"}[5m]) + rate(pg_stat_database_blks_read{datname=\"$database\"}[5m])) * 100"
        }
      ]
    },
    {
      "title": "äº‹åŠ¡ç‡",
      "targets": [
        {
          "expr": "rate(pg_stat_database_xact_commit{datname=\"$database\"}[5m])"
        }
      ]
    }
  ]
}
```

### 9.5 è‡ªå®šä¹‰ç›‘æ§è„šæœ¬


#### ğŸ”¹ æ•°æ®åº“å¥åº·æ£€æŸ¥è„šæœ¬


```bash
#!/bin/bash
# pg_health_check.sh - PostgreSQLå¥åº·æ£€æŸ¥è„šæœ¬

DB_NAME="your_database"
ALERT_THRESHOLD=90

# æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
cache_hit_ratio=$(psql -t -c "
SELECT round(
    sum(blks_hit) * 100.0 / (sum(blks_hit) + sum(blks_read)), 2
) FROM pg_stat_database WHERE datname = '$DB_NAME';
")

echo "ç¼“å­˜å‘½ä¸­ç‡: ${cache_hit_ratio}%"
if (( $(echo "$cache_hit_ratio < 95" | bc -l) )); then
    echo "âš ï¸  è­¦å‘Š: ç¼“å­˜å‘½ä¸­ç‡ä½äº95%"
fi

# æ£€æŸ¥è¿æ¥æ•°ä½¿ç”¨ç‡
connection_usage=$(psql -t -c "
SELECT round(
    count(*) * 100.0 / (SELECT setting::int FROM pg_settings WHERE name = 'max_connections'), 2
) FROM pg_stat_activity;
")

echo "è¿æ¥ä½¿ç”¨ç‡: ${connection_usage}%"
if (( $(echo "$connection_usage > $ALERT_THRESHOLD" | bc -l) )); then
    echo "ğŸš¨ è­¦å‘Š: è¿æ¥ä½¿ç”¨ç‡è¶…è¿‡${ALERT_THRESHOLD}%"
fi

# æ£€æŸ¥é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
long_queries=$(psql -t -c "
SELECT count(*) FROM pg_stat_activity 
WHERE state = 'active' 
AND now() - query_start > interval '5 minutes';
")

echo "é•¿æ—¶é—´è¿è¡ŒæŸ¥è¯¢æ•°: $long_queries"
if [ "$long_queries" -gt 0 ]; then
    echo "âš ï¸  å‘ç° $long_queries ä¸ªé•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢"
fi
```

#### ğŸ”¹ å®šæœŸè¿è¡Œç›‘æ§è„šæœ¬


```bash
# æ·»åŠ åˆ°crontabï¼Œæ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
*/5 * * * * /path/to/pg_health_check.sh >> /var/log/postgresql/health_check.log 2>&1
```

---

## 10. ğŸƒâ€â™‚ï¸ æ€§èƒ½åŸºå‡†æµ‹è¯•pgbench


### 10.1 ä»€ä¹ˆæ˜¯pgbench


**ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ**
> ğŸ’¡ **pgbench**ï¼šPostgreSQLå®˜æ–¹æä¾›çš„æ€§èƒ½åŸºå‡†æµ‹è¯•å·¥å…·ï¼Œå°±åƒç»™æ•°æ®åº“åš"ä½“èƒ½æµ‹è¯•"

pgbenchå¯ä»¥å¸®ä½ äº†è§£ï¼š
- **æ•°æ®åº“çš„å¤„ç†èƒ½åŠ›**ï¼šæ¯ç§’èƒ½å¤„ç†å¤šå°‘äº‹åŠ¡
- **ä¸åŒé…ç½®çš„æ€§èƒ½å·®å¼‚**ï¼šè°ƒä¼˜å‰åçš„æ•ˆæœå¯¹æ¯”
- **ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆ**ï¼šCPUã€å†…å­˜ã€ç£ç›˜å“ªä¸ªæ˜¯é™åˆ¶å› ç´ 

### 10.2 pgbenchåŸºç¡€ä½¿ç”¨


#### ğŸ”¹ åˆå§‹åŒ–æµ‹è¯•æ•°æ®


```bash
# åŸºæœ¬åˆå§‹åŒ–ï¼ˆåˆ›å»º4å¼ æµ‹è¯•è¡¨ï¼‰
pgbench -i -s 10 your_database

# å‚æ•°è¯´æ˜ï¼š
# -i: åˆå§‹åŒ–æ¨¡å¼
# -s 10: ç¼©æ”¾å› å­ï¼Œåˆ›å»º10ä¸‡è¡Œæ•°æ®ï¼ˆ10 Ã— 100,000ï¼‰
# æ•°æ®å¤§å°çº¦: scale Ã— 15MB

# æ£€æŸ¥åˆ›å»ºçš„è¡¨
psql your_database -c "\dt pgbench_*"
```

**ğŸ” pgbenchåˆ›å»ºçš„è¡¨ç»“æ„**

```sql
-- pgbenchåˆ›å»ºçš„4å¼ è¡¨ï¼š
pgbench_accounts   -- è´¦æˆ·è¡¨ï¼ˆä¸»è¦æµ‹è¯•è¡¨ï¼‰
pgbench_branches   -- åˆ†æ”¯è¡¨
pgbench_tellers    -- å‡ºçº³å‘˜è¡¨  
pgbench_history    -- å†å²è®°å½•è¡¨

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT 
    tablename AS "è¡¨å",
    pg_size_pretty(pg_total_relation_size('pgbench_'||tablename)) AS "å¤§å°"
FROM unnest(ARRAY['accounts','branches','tellers','history']) AS tablename;
```

#### ğŸ”¹ åŸºæœ¬æ€§èƒ½æµ‹è¯•


```bash
# åŸºç¡€æµ‹è¯•ï¼š10ä¸ªå®¢æˆ·ç«¯ï¼Œè¿è¡Œ60ç§’
pgbench -c 10 -T 60 your_database

# å‚æ•°è¯´æ˜ï¼š
# -c 10: æ¨¡æ‹Ÿ10ä¸ªå¹¶å‘å®¢æˆ·ç«¯
# -T 60: è¿è¡Œ60ç§’
# -j 4: ä½¿ç”¨4ä¸ªçº¿ç¨‹ï¼ˆé€šå¸¸è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°ï¼‰

# å®Œæ•´æµ‹è¯•å‘½ä»¤
pgbench -c 10 -j 4 -T 60 -P 5 your_database
# -P 5: æ¯5ç§’è¾“å‡ºä¸€æ¬¡è¿›åº¦æŠ¥å‘Š
```

### 10.3 pgbenchæµ‹è¯•ç»“æœè§£è¯»


#### ğŸ”¹ è¾“å‡ºç»“æœç¤ºä¾‹


```
pgbenchè¾“å‡ºç»“æœï¼š

progress: 5.0 s, 423.2 tps, lat 23.590 ms stddev 15.420
progress: 10.0 s, 445.8 tps, lat 22.421 ms stddev 14.230  
progress: 15.0 s, 439.1 tps, lat 22.765 ms stddev 13.890
...

transaction type: <builtin: TPC-B (sort of)>
scaling factor: 10
query mode: simple
number of clients: 10
number of threads: 4
duration: 60 s
number of transactions actually processed: 26534
latency average = 22.590 ms
latency stddev = 14.126 ms
tps = 442.233333 (including connections establishing)
tps = 442.501245 (excluding connections establishing)
```

**ğŸ“Š å…³é”®æŒ‡æ ‡è§£è¯»**

| æŒ‡æ ‡ | å«ä¹‰ | å¥½ååˆ¤æ–­ |
|------|------|----------|
| **TPS** | æ¯ç§’äº‹åŠ¡æ•° | è¶Šé«˜è¶Šå¥½ï¼Œä¸»è¦æ€§èƒ½æŒ‡æ ‡ |
| **Latency** | å¹³å‡å»¶è¿Ÿ | è¶Šä½è¶Šå¥½ï¼Œç”¨æˆ·ä½“éªŒæŒ‡æ ‡ |
| **stddev** | å»¶è¿Ÿæ ‡å‡†å·® | è¶Šå°è¶Šå¥½ï¼Œæ€§èƒ½ç¨³å®šæ€§æŒ‡æ ‡ |

#### ğŸ”¹ æ€§èƒ½åŸºå‡†å‚è€ƒ


```
ä¸åŒç¡¬ä»¶é…ç½®çš„TPSå‚è€ƒå€¼ï¼š

ğŸ’» è™šæ‹Ÿæœºï¼ˆ2æ ¸4GBï¼‰:     100-300 TPS
ğŸ–¥ï¸  æ™®é€šæœåŠ¡å™¨ï¼ˆ4æ ¸8GBï¼‰:  300-800 TPS  
ğŸš€ é«˜æ€§èƒ½æœåŠ¡å™¨ï¼ˆ8æ ¸16GBï¼‰: 800-2000 TPS
âš¡ SSD+é«˜ç«¯æœåŠ¡å™¨:       2000+ TPS

æ³¨æ„ï¼šå…·ä½“å€¼å—å¤šç§å› ç´ å½±å“ï¼Œä¸»è¦ç”¨äºå¯¹æ¯”æµ‹è¯•
```

### 10.4 è‡ªå®šä¹‰æµ‹è¯•åœºæ™¯


#### ğŸ”¹ åªè¯»æµ‹è¯•


```bash
# çº¯æŸ¥è¯¢æµ‹è¯•ï¼Œè¯„ä¼°è¯»å–æ€§èƒ½
pgbench -c 10 -T 60 -S your_database

# -S: åªè¯»æ¨¡å¼ï¼Œåªæ‰§è¡ŒSELECTæŸ¥è¯¢
# é€‚åˆæµ‹è¯•ï¼šç¼“å­˜æ•ˆæœã€æŸ¥è¯¢ä¼˜åŒ–æ•ˆæœ
```

#### ğŸ”¹ è‡ªå®šä¹‰SQLæµ‹è¯•


```bash
# åˆ›å»ºè‡ªå®šä¹‰æµ‹è¯•è„šæœ¬
cat > custom_test.sql << EOF
\set userid random(1, 100000)
SELECT * FROM users WHERE id = :userid;
UPDATE users SET last_login = now() WHERE id = :userid;
EOF

# ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬æµ‹è¯•
pgbench -c 10 -T 60 -f custom_test.sql your_database
```

#### ğŸ”¹ æ··åˆè´Ÿè½½æµ‹è¯•


```bash
# åˆ›å»ºå¤šä¸ªæµ‹è¯•è„šæœ¬ï¼Œæ¨¡æ‹ŸçœŸå®ä¸šåŠ¡åœºæ™¯
cat > read_heavy.sql << EOF
\set userid random(1, 100000)
SELECT * FROM users WHERE id = :userid;
EOF

cat > write_heavy.sql << EOF  
\set userid random(1, 100000)
\set amount random(1, 1000)
UPDATE accounts SET balance = balance + :amount WHERE id = :userid;
EOF

# æŒ‰æ¯”ä¾‹æ‰§è¡Œï¼ˆ80%è¯»ï¼Œ20%å†™ï¼‰
pgbench -c 10 -T 60 -f read_heavy.sql@80 -f write_heavy.sql@20 your_database
```

### 10.5 æ€§èƒ½è°ƒä¼˜å®æˆ˜æ¡ˆä¾‹


#### ğŸ”¹ è°ƒä¼˜å‰åå¯¹æ¯”æµ‹è¯•


```bash
# 1. è°ƒä¼˜å‰åŸºå‡†æµ‹è¯•
echo "=== è°ƒä¼˜å‰æµ‹è¯• ===" 
pgbench -c 10 -T 60 -P 10 your_database > before_tuning.log

# 2. åº”ç”¨è°ƒä¼˜å‚æ•°
psql your_database -c "ALTER SYSTEM SET shared_buffers = '2GB';"
psql your_database -c "ALTER SYSTEM SET work_mem = '64MB';"
sudo systemctl restart postgresql

# 3. è°ƒä¼˜åæµ‹è¯•
echo "=== è°ƒä¼˜åæµ‹è¯• ==="
pgbench -c 10 -T 60 -P 10 your_database > after_tuning.log

# 4. å¯¹æ¯”ç»“æœ
echo "è°ƒä¼˜å‰TPS:" $(grep "tps.*excluding" before_tuning.log | awk '{print $3}')
echo "è°ƒä¼˜åTPS:" $(grep "tps.*excluding" after_tuning.log | awk '{print $3}')
```

#### ğŸ”¹ ä¸åŒå¹¶å‘æ•°æµ‹è¯•


```bash
#!/bin/bash
# æµ‹è¯•ä¸åŒå¹¶å‘æ•°çš„æ€§èƒ½è¡¨ç°

for clients in 1 5 10 20 50 100; do
    echo "Testing with $clients clients..."
    pgbench -c $clients -T 30 your_database | grep "tps.*excluding" >> concurrent_test.log
done

# åˆ†æç»“æœï¼Œæ‰¾å‡ºæœ€ä¼˜å¹¶å‘æ•°
cat concurrent_test.log
```

### 10.6 pgbenché«˜çº§ç‰¹æ€§


#### ğŸ”¹ ç”ŸæˆHTMLæŠ¥å‘Š


```bash
# å®‰è£…pgbench-toolsï¼ˆå¦‚æœéœ€è¦å›¾å½¢åŒ–æŠ¥å‘Šï¼‰
git clone https://github.com/gregs1104/pgbench-tools.git

# è¿è¡Œè¯¦ç»†æµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š
pgbench -c 10 -T 300 -P 30 --log --aggregate-interval=10 your_database

# ç»“åˆsarå·¥å…·ç›‘æ§ç³»ç»Ÿèµ„æº
sar -u 1 300 > cpu_usage.log &  # ç›‘æ§CPU
pgbench -c 10 -T 300 your_database
```

#### ğŸ”¹ å‹åŠ›æµ‹è¯•ä¸æé™æµ‹è¯•


```bash
# é€æ­¥å¢åŠ è´Ÿè½½ï¼Œæ‰¾å‡ºç³»ç»Ÿæé™
for load in 10 25 50 75 100 150 200; do
    echo "Testing with $load clients..."
    timeout 60 pgbench -c $load -T 60 your_database 2>/dev/null | \
    grep "tps.*excluding" | \
    awk -v clients=$load '{print clients, $3}' >> load_test.results
done

# åˆ†æç»“æœï¼Œç»˜åˆ¶è´Ÿè½½-æ€§èƒ½æ›²çº¿
echo "Clients TPS" 
cat load_test.results
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ€§èƒ½ç›‘æ§åŸºç¡€ï¼špg_stat_*ç³»åˆ—è§†å›¾æ˜¯PostgreSQLçš„"ä»ªè¡¨ç›˜"
ğŸ”¸ æŸ¥è¯¢è®¡åˆ’åˆ†æï¼šEXPLAINæ˜¯è¯Šæ–­æ…¢æŸ¥è¯¢çš„"Xå…‰ç‰‡"
ğŸ”¸ æ…¢æŸ¥è¯¢è¯†åˆ«ï¼špg_stat_statementsæ˜¯æ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆçš„"ä¾¦æ¢"
ğŸ”¸ å†…å­˜å‚æ•°è°ƒä¼˜ï¼šshared_buffersæ˜¯å½±å“æ€§èƒ½æœ€å…³é”®çš„å‚æ•°
ğŸ”¸ WALå’Œæ£€æŸ¥ç‚¹ï¼šå¹³è¡¡å†™å…¥æ€§èƒ½å’Œæ•°æ®å®‰å…¨çš„é‡è¦æœºåˆ¶
ğŸ”¸ è¿æ¥æ•°é…ç½®ï¼šåˆç†æ§åˆ¶å¹¶å‘è¿æ¥ï¼Œé…åˆè¿æ¥æ± ä½¿ç”¨
ğŸ”¸ è‡ªåŠ¨VACUUMï¼šä¿æŒæ•°æ®åº“"æ¸…æ´"ï¼Œé˜²æ­¢æ€§èƒ½é€€åŒ–
ğŸ”¸ ç›‘æ§å·¥å…·ï¼šé€‰æ‹©é€‚åˆçš„å·¥å…·ï¼Œå»ºç«‹å®Œæ•´ç›‘æ§ä½“ç³»
ğŸ”¸ åŸºå‡†æµ‹è¯•ï¼špgbenchæä¾›ç§‘å­¦çš„æ€§èƒ½è¯„ä¼°æ–¹æ³•
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ€§èƒ½ç›‘æ§çš„æœ¬è´¨**
```
æ€§èƒ½ç›‘æ§ = ä½“æ£€ + é¢„è­¦ + è¯Šæ–­

ä½“æ£€ï¼šå®šæœŸæ£€æŸ¥å„é¡¹æŒ‡æ ‡æ˜¯å¦æ­£å¸¸
- ç¼“å­˜å‘½ä¸­ç‡åº”è¯¥>95%
- è¿æ¥ä½¿ç”¨ç‡åº”è¯¥<90% 
- æ²¡æœ‰é•¿æ—¶é—´è¿è¡Œçš„å¼‚å¸¸æŸ¥è¯¢

é¢„è­¦ï¼šè®¾ç½®åˆç†çš„é˜ˆå€¼å’Œå‘Šè­¦
- å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼åŠæ—¶å‘Šè­¦
- èµ„æºä½¿ç”¨ç‡æ¥è¿‘æé™æå‰é€šçŸ¥
- é”™è¯¯ç‡å¼‚å¸¸ç«‹å³æŠ¥è­¦

è¯Šæ–­ï¼šå¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜
- é€šè¿‡pg_stat_statementsæ‰¾å‡ºæ…¢SQL
- ç”¨EXPLAINåˆ†æå…·ä½“çš„æ€§èƒ½ç“¶é¢ˆ
- ç»“åˆç³»ç»Ÿç›‘æ§æ‰¾å‡ºæ ¹æœ¬åŸå› 
```

**ğŸ”¹ å†…å­˜è°ƒä¼˜çš„æ ¸å¿ƒåŸåˆ™**
```
å†…å­˜é…ç½®çš„å¹³è¡¡è‰ºæœ¯ï¼š

shared_buffersï¼š
âœ… å¤ªå°ï¼šé¢‘ç¹ç£ç›˜IOï¼Œæ€§èƒ½å·®
âŒ å¤ªå¤§ï¼šæŒ¤å ç³»ç»Ÿå†…å­˜ï¼Œå¯èƒ½swap
ğŸ’¡ æœ€ä½³å®è·µï¼šæ€»å†…å­˜çš„25%-40%

work_memï¼š
âœ… å¤ªå°ï¼šå¤æ‚æŸ¥è¯¢ä½¿ç”¨ç£ç›˜ä¸´æ—¶æ–‡ä»¶
âŒ å¤ªå¤§ï¼šå¤šä¸ªæŸ¥è¯¢åŒæ—¶è¿è¡Œå¯èƒ½å†…å­˜ä¸è¶³
ğŸ’¡ æœ€ä½³å®è·µï¼šæ ¹æ®æŸ¥è¯¢å¤æ‚åº¦åŠ¨æ€è°ƒæ•´

è®°ä½ï¼šå†…å­˜è°ƒä¼˜ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œè€Œæ˜¯è¦è¾¾åˆ°å¹³è¡¡
```

**ğŸ”¹ VACUUMçš„é‡è¦ä½œç”¨**
```
ä¸ºä»€ä¹ˆVACUUMå¦‚æ­¤é‡è¦ï¼š

æ²¡æœ‰VACUUMçš„åæœï¼š
âŒ æ­»å…ƒç»„è¶Šæ¥è¶Šå¤šï¼Œè¡¨è¶Šæ¥è¶Šå¤§
âŒ æŸ¥è¯¢æ€§èƒ½æŒç»­ä¸‹é™
âŒ ç£ç›˜ç©ºé—´æµªè´¹ä¸¥é‡
âŒ ç»Ÿè®¡ä¿¡æ¯è¿‡æ—¶ï¼Œæ‰§è¡Œè®¡åˆ’ä¸å‡†ç¡®

æœ‰äº†è‡ªåŠ¨VACUUMï¼š
âœ… å®šæœŸæ¸…ç†æ­»å…ƒç»„ï¼Œä¿æŒè¡¨"è‹—æ¡"
âœ… åŠæ—¶æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œä¼˜åŒ–å™¨å†³ç­–å‡†ç¡®
âœ… é‡Šæ”¾å¯é‡ç”¨ç©ºé—´ï¼ŒèŠ‚çº¦ç£ç›˜
âœ… ç»´æŠ¤ç³»ç»Ÿæ•´ä½“æ€§èƒ½ç¨³å®š

æ ¸å¿ƒç†å¿µï¼šVACUUMä¸æ˜¯"é¢å¤–å¼€é”€"ï¼Œè€Œæ˜¯"å¿…è¦æŠ•èµ„"
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š ä¸åŒåœºæ™¯çš„è°ƒä¼˜ç­–ç•¥**

```
OLTPç³»ç»Ÿï¼ˆåœ¨çº¿äº¤æ˜“ï¼‰ï¼š
ğŸ¯ ç‰¹ç‚¹ï¼šé«˜å¹¶å‘ã€çŸ­äº‹åŠ¡ã€å¿«å“åº”
ğŸ”§ ä¼˜åŒ–é‡ç‚¹ï¼š
   - è¿æ¥æ± ï¼šå‡å°‘è¿æ¥å¼€é”€
   - ç´¢å¼•ä¼˜åŒ–ï¼šä¿è¯æŸ¥è¯¢å¿«é€Ÿå‘½ä¸­
   - shared_buffersé€‚ä¸­ï¼šé¿å…é•¿æ—¶é—´é”å®š
   - é¢‘ç¹VACUUMï¼šä¿æŒæ•°æ®æ–°é²œ

OLAPç³»ç»Ÿï¼ˆæ•°æ®åˆ†æï¼‰ï¼š
ğŸ¯ ç‰¹ç‚¹ï¼šå¤æ‚æŸ¥è¯¢ã€å¤§æ•°æ®é‡ã€é•¿æ—¶é—´è¿è¡Œ
ğŸ”§ ä¼˜åŒ–é‡ç‚¹ï¼š
   - work_memå¢å¤§ï¼šæ”¯æŒå¤æ‚æ’åºå’Œè¿æ¥
   - å¹¶è¡ŒæŸ¥è¯¢ï¼šåˆ©ç”¨å¤šæ ¸å¿ƒåŠ é€Ÿ
   - maintenance_work_memå¢å¤§ï¼šåŠ å¿«ç´¢å¼•åˆ›å»º
   - checkpointé—´éš”é•¿ï¼šå‡å°‘å†™å…¥å¹²æ‰°

æ··åˆè´Ÿè½½ç³»ç»Ÿï¼š
ğŸ¯ ç‰¹ç‚¹ï¼šæ—¢æœ‰åœ¨çº¿äº¤æ˜“åˆæœ‰æ•°æ®åˆ†æ
ğŸ”§ ä¼˜åŒ–é‡ç‚¹ï¼š
   - è¯»å†™åˆ†ç¦»ï¼šä¸»ä»æ¶æ„
   - åˆ†æ—¶è°ƒä¼˜ï¼šä¸šåŠ¡é«˜å³°å’Œä½å³°é‡‡ç”¨ä¸åŒå‚æ•°
   - èµ„æºéš”ç¦»ï¼šä¸ºä¸åŒç±»å‹æŸ¥è¯¢åˆ†é…ä¸åŒèµ„æº
```

**ğŸ”§ æ€§èƒ½é—®é¢˜è¯Šæ–­æµç¨‹**

```
é—®é¢˜è¯Šæ–­çš„ç³»ç»ŸåŒ–æ–¹æ³•ï¼š

ç¬¬1æ­¥ï¼šç¡®å®šé—®é¢˜èŒƒå›´
â”œâ”€â”€ æ•´ä¸ªç³»ç»Ÿæ…¢ï¼Ÿè¿˜æ˜¯ç‰¹å®šåŠŸèƒ½æ…¢ï¼Ÿ
â”œâ”€â”€ æŒç»­æ€§é—®é¢˜ï¼Ÿè¿˜æ˜¯é—´æ­‡æ€§é—®é¢˜ï¼Ÿ
â””â”€â”€ ä»ä»€ä¹ˆæ—¶å€™å¼€å§‹å‡ºç°é—®é¢˜ï¼Ÿ

ç¬¬2æ­¥ï¼šæ”¶é›†åŸºç¡€æ•°æ®
â”œâ”€â”€ æŸ¥çœ‹pg_stat_activityï¼ˆå½“å‰æ´»åŠ¨ï¼‰
â”œâ”€â”€ æ£€æŸ¥pg_stat_databaseï¼ˆæ•°æ®åº“çº§ç»Ÿè®¡ï¼‰
â””â”€â”€ åˆ†æpg_stat_statementsï¼ˆSQLæ‰§è¡Œç»Ÿè®¡ï¼‰

ç¬¬3æ­¥ï¼šæ·±å…¥åˆ†æ
â”œâ”€â”€ ç”¨EXPLAINåˆ†æå…·ä½“æ…¢SQL
â”œâ”€â”€ æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
â””â”€â”€ æŸ¥çœ‹é”™è¯¯æ—¥å¿—å’Œè­¦å‘Šä¿¡æ¯

ç¬¬4æ­¥ï¼šåˆ¶å®šè§£å†³æ–¹æ¡ˆ
â”œâ”€â”€ çŸ­æœŸæ–¹æ¡ˆï¼šç»ˆæ­¢å¼‚å¸¸æŸ¥è¯¢ã€ä¸´æ—¶è°ƒæ•´å‚æ•°
â”œâ”€â”€ ä¸­æœŸæ–¹æ¡ˆï¼šä¼˜åŒ–SQLã€æ·»åŠ ç´¢å¼•ã€è°ƒæ•´é…ç½®
â””â”€â”€ é•¿æœŸæ–¹æ¡ˆï¼šæ¶æ„è°ƒæ•´ã€ç¡¬ä»¶å‡çº§

ç¬¬5æ­¥ï¼šéªŒè¯æ•ˆæœ
â”œâ”€â”€ å¯¹æ¯”ä¼˜åŒ–å‰åçš„å…³é”®æŒ‡æ ‡
â”œâ”€â”€ æŒç»­ç›‘æ§ä¸€æ®µæ—¶é—´
â””â”€â”€ æ ¹æ®æ•ˆæœè°ƒæ•´ä¼˜åŒ–ç­–ç•¥
```

### 11.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ ç›‘æ§ä½“ç³»å»ºè®¾**
```
å»ºç«‹åˆ†å±‚ç›‘æ§ä½“ç³»ï¼š

åº”ç”¨å±‚ç›‘æ§ï¼š
- å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€ååé‡
- ä¸šåŠ¡å…³é”®æŒ‡æ ‡ç›‘æ§

æ•°æ®åº“å±‚ç›‘æ§ï¼š
- è¿æ¥æ•°ã€äº‹åŠ¡æ•°ã€ç¼“å­˜å‘½ä¸­ç‡
- æ…¢æŸ¥è¯¢ã€é”ç­‰å¾…ã€æ­»é”
- è¡¨å’Œç´¢å¼•ç»Ÿè®¡ä¿¡æ¯

ç³»ç»Ÿå±‚ç›‘æ§ï¼š  
- CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
- è¿›ç¨‹çŠ¶æ€ã€ç³»ç»Ÿè°ƒç”¨
- ç¡¬ä»¶å¥åº·çŠ¶å†µ

å‘Šè­¦ç­–ç•¥ï¼š
ğŸš¨ ä¸¥é‡ï¼šæ•°æ®åº“æ— æ³•è¿æ¥ã€å¤§é‡é•¿æ—¶é—´æŸ¥è¯¢
âš ï¸ è­¦å‘Šï¼šç¼“å­˜å‘½ä¸­ç‡ä½ã€è¿æ¥æ•°è¿‡å¤š
ğŸ“ æç¤ºï¼šç»Ÿè®¡ä¿¡æ¯è¿‡æ—¶ã€VACUUMå»¶è¿Ÿ
```

**ğŸ”§ è¿ç»´è‡ªåŠ¨åŒ–**
```
è‡ªåŠ¨åŒ–è¿ç»´çš„å…³é”®ç¯èŠ‚ï¼š

ç›‘æ§è‡ªåŠ¨åŒ–ï¼š
- è‡ªåŠ¨æ”¶é›†å’Œåˆ†ææ€§èƒ½æŒ‡æ ‡
- æ™ºèƒ½å‘Šè­¦ï¼Œå‡å°‘è¯¯æŠ¥
- ç”Ÿæˆå®šæœŸæ€§èƒ½æŠ¥å‘Š

ä¼˜åŒ–è‡ªåŠ¨åŒ–ï¼š
- æ ¹æ®è´Ÿè½½æ¨¡å¼è‡ªåŠ¨è°ƒæ•´å‚æ•°
- è‡ªåŠ¨æ‰§è¡ŒVACUUMå’ŒANALYZE
- æ™ºèƒ½ç´¢å¼•å»ºè®®

æ•…éšœå¤„ç†è‡ªåŠ¨åŒ–ï¼š
- è‡ªåŠ¨é‡å¯å¼‚å¸¸è¿›ç¨‹
- è‡ªåŠ¨æ¸…ç†é•¿æ—¶é—´è¿è¡ŒæŸ¥è¯¢
- è‡ªåŠ¨æ•…éšœè½¬ç§»å’Œæ¢å¤
```

### 11.5 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š PostgreSQLæ€§èƒ½ä¼˜åŒ–å­¦ä¹ è·¯çº¿**

```
åˆçº§é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰ï¼š
â”œâ”€â”€ æŒæ¡åŸºæœ¬çš„pg_stat_*è§†å›¾ä½¿ç”¨
â”œâ”€â”€ å­¦ä¼šä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢è®¡åˆ’
â”œâ”€â”€ äº†è§£ä¸»è¦é…ç½®å‚æ•°çš„å«ä¹‰
â””â”€â”€ èƒ½å¤Ÿè¿›è¡Œç®€å•çš„æ€§èƒ½é—®é¢˜è¯Šæ–­

ä¸­çº§é˜¶æ®µï¼ˆ3-6ä¸ªæœˆï¼‰ï¼š
â”œâ”€â”€ ç†Ÿç»ƒä½¿ç”¨pg_stat_statements
â”œâ”€â”€ æŒæ¡å†…å­˜å’ŒWALå‚æ•°è°ƒä¼˜
â”œâ”€â”€ äº†è§£VACUUMå’Œç»Ÿè®¡ä¿¡æ¯ç®¡ç†
â””â”€â”€ èƒ½å¤Ÿå»ºç«‹åŸºæœ¬çš„ç›‘æ§ä½“ç³»

é«˜çº§é˜¶æ®µï¼ˆ6ä¸ªæœˆä»¥ä¸Šï¼‰ï¼š
â”œâ”€â”€ æ·±å…¥ç†è§£PostgreSQLå†…éƒ¨æœºåˆ¶
â”œâ”€â”€ èƒ½å¤Ÿè¿›è¡Œå¤æ‚çš„æ€§èƒ½è°ƒä¼˜
â”œâ”€â”€ æŒæ¡å¤šç§ç›‘æ§å·¥å…·å’Œæ–¹æ³•
â””â”€â”€ èƒ½å¤Ÿè®¾è®¡é«˜æ€§èƒ½çš„æ•°æ®åº“æ¶æ„
```

**ğŸ’¡ æŒç»­å­¦ä¹ å»ºè®®**
- **å®è·µä¸ºä¸»**ï¼šåœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨å­¦åˆ°çš„çŸ¥è¯†
- **æ–‡æ¡£ä¼˜å…ˆ**ï¼šPostgreSQLå®˜æ–¹æ–‡æ¡£æ˜¯æœ€æƒå¨çš„èµ„æ–™
- **ç¤¾åŒºå‚ä¸**ï¼šå…³æ³¨PostgreSQLç¤¾åŒºçš„æœ€æ–°åŠ¨æ€
- **ç»éªŒåˆ†äº«**ï¼šå¤šä¸åŒè¡Œäº¤æµï¼Œå­¦ä¹ ä»–äººçš„ä¼˜åŒ–ç»éªŒ

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ç›‘æ§å…ˆè¡Œæ‰¾ç“¶é¢ˆï¼Œç»Ÿè®¡è§†å›¾æ˜¯åŸºç¡€
æ‰§è¡Œè®¡åˆ’çœ‹å¾—å‡†ï¼Œæ…¢æŸ¥è¯¢æ— å¤„èº²
å†…å­˜é…ç½®è¦å¹³è¡¡ï¼Œç¼“å­˜å‘½ä¸­æ˜¯å…³é”®  
è‡ªåŠ¨æ¸…ç†ä¸èƒ½åœï¼Œæ€§èƒ½ç¨³å®šé VACUUM
åŸºå‡†æµ‹è¯•éªŒæ•ˆæœï¼Œpgbenchæ¥å¸®å¿™
å·¥å…·æ’ä»¶é€‰æ‹©å¤šï¼Œç›‘æ§ä½“ç³»è¦å®Œå–„
```

---

> ğŸ“ **å­¦ä¹ å»ºè®®**ï¼šPostgreSQLæ€§èƒ½è°ƒä¼˜æ˜¯ä¸€ä¸ªç³»ç»Ÿå·¥ç¨‹ï¼Œéœ€è¦ç†è®ºä¸å®è·µç›¸ç»“åˆã€‚å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒä¸­ç†Ÿæ‚‰å„ç§å·¥å…·å’Œæ–¹æ³•ï¼Œå†é€æ­¥åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒã€‚è®°ä½ï¼Œæ€§èƒ½ä¼˜åŒ–æ²¡æœ‰é“¶å¼¹ï¼Œè¦æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„ç­–ç•¥ã€‚

> âš ï¸ **å®‰å…¨æé†’**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒè¿›è¡Œæ€§èƒ½è°ƒä¼˜æ—¶ï¼ŒåŠ¡å¿…å…ˆå¤‡ä»½é‡è¦æ•°æ®ï¼Œåœ¨ç»´æŠ¤çª—å£æœŸè¿›è¡Œå‚æ•°è°ƒæ•´ï¼Œå¹¶æŒç»­ç›‘æ§è°ƒæ•´åçš„æ•ˆæœã€‚ä»»ä½•å‚æ•°ä¿®æ”¹éƒ½å¯èƒ½å¯¹ç³»ç»Ÿç¨³å®šæ€§äº§ç”Ÿå½±å“ã€‚