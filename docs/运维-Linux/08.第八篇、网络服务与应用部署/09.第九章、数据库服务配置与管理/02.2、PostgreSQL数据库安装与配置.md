---
title: 2、PostgreSQL数据库安装与配置
---
## 📚 目录

1. [PostgreSQL概述与版本选择](#1-PostgreSQL概述与版本选择)
2. [软件包安装方法](#2-软件包安装方法)
3. [数据库集群初始化](#3-数据库集群初始化)
4. [核心配置文件详解](#4-核心配置文件详解)
5. [服务管理与启动控制](#5-服务管理与启动控制)
6. [用户权限与安全配置](#6-用户权限与安全配置)
7. [网络配置与连接管理](#7-网络配置与连接管理)
8. [常见问题与故障排除](#8-常见问题与故障排除)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🐘 PostgreSQL概述与版本选择


### 1.1 什么是PostgreSQL


**PostgreSQL**是一个**开源的对象关系型数据库管理系统**，简单来说就是一个用来存储和管理数据的软件，就像一个超级智能的电子档案柜。

> **通俗理解**：如果把数据比作书籍，PostgreSQL就是一个非常聪明的图书管理员，不仅能帮你分类存放书籍，还能快速找到你要的任何一本书，甚至能分析书籍之间的关系。

**核心特点**：
- **ACID事务支持** ★★★ - 保证数据的完整性和一致性
- **强大的数据类型** ★★★ - 支持JSON、数组、几何类型等
- **高度可扩展** ★★☆ - 可以自定义函数和数据类型
- **开源免费** ★★★ - 没有许可费用，社区活跃

### 1.2 版本选择策略


```
PostgreSQL版本发布规律：
每年一个大版本    PostgreSQL 15 (2022年)
                 PostgreSQL 16 (2023年)
                 PostgreSQL 17 (2024年)

支持周期：每个大版本支持5年
```

**版本选择建议**：

| 使用场景 | 推荐版本 | 选择理由 |
|---------|----------|----------|
| **生产环境** | PostgreSQL 15/16 | 稳定性好，长期支持 |
| **学习测试** | 最新版本 | 体验新特性 |
| **企业环境** | LTS版本 | 长期维护保障 |

### 1.3 与MySQL的简单对比


```
MySQL特点：
✅ 使用简单，上手快
✅ 生态丰富，资料多
❌ 功能相对基础

PostgreSQL特点：
✅ 功能强大，标准兼容性好
✅ 数据类型丰富
❌ 学习成本略高
```

---

## 2. 📦 软件包安装方法


### 2.1 安装前的系统准备


**系统要求检查**：
```bash
# 检查系统版本
cat /etc/os-release

# 检查可用内存（建议至少1GB）
free -h

# 检查磁盘空间（建议至少5GB）
df -h
```

**更新系统软件包**：
```bash
# CentOS/RHEL系统
sudo yum update -y

# Ubuntu/Debian系统
sudo apt update && sudo apt upgrade -y
```

### 2.2 CentOS/RHEL系统安装


#### 🔸 方法一：官方仓库安装（推荐）


```bash
# 1. 安装PostgreSQL官方仓库
sudo yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm

# 2. 安装PostgreSQL 15
sudo yum install -y postgresql15-server postgresql15

# 3. 验证安装
rpm -qa | grep postgresql
```

#### 🔸 方法二：系统默认仓库


```bash
# 安装系统仓库中的PostgreSQL
sudo yum install -y postgresql-server postgresql
```

> **📝 注意**：系统默认仓库的版本通常较老，建议使用官方仓库获取最新版本。

### 2.3 Ubuntu/Debian系统安装


```bash
# 1. 安装必要工具
sudo apt install -y wget ca-certificates

# 2. 添加PostgreSQL官方仓库签名
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -

# 3. 添加仓库地址
echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list

# 4. 更新并安装
sudo apt update
sudo apt install -y postgresql postgresql-contrib
```

### 2.4 安装验证


```bash
# 检查PostgreSQL版本
sudo -u postgres psql -c "SELECT version();"

# 查看安装的文件位置
which psql
which pg_config
```

**安装成功标志**：
- ✅ 能够执行`psql`命令
- ✅ `postgres`用户已创建
- ✅ PostgreSQL服务已安装

---

## 3. 🏗️ 数据库集群初始化


### 3.1 什么是数据库集群初始化


**initdb**是PostgreSQL的数据库集群初始化命令，**通俗来说就是给PostgreSQL准备一个工作空间**。

> **生活类比**：就像搬进新房子前，你需要先布置房间、整理家具、设定规则一样，initdb就是在为PostgreSQL"装修房子"。

**初始化做了什么**：
- 创建数据存储目录
- 建立系统数据库（template0、template1、postgres）
- 设置默认配置文件
- 创建postgres超级用户

### 3.2 CentOS/RHEL系统初始化


```bash
# PostgreSQL 15 初始化
sudo /usr/pgsql-15/bin/postgresql-15-setup initdb

# 或者通用版本初始化
sudo postgresql-setup initdb
```

### 3.3 Ubuntu/Debian系统初始化


```bash
# Ubuntu系统通常安装后自动初始化
# 如果需要手动初始化：
sudo -u postgres /usr/lib/postgresql/15/bin/initdb -D /var/lib/postgresql/15/main
```

### 3.4 手动初始化过程


**手动初始化的完整步骤**：

```bash
# 1. 切换到postgres用户
sudo su - postgres

# 2. 创建数据目录
mkdir -p /var/lib/postgresql/data

# 3. 执行初始化
/usr/bin/initdb -D /var/lib/postgresql/data --locale=en_US.UTF-8

# 4. 查看初始化结果
ls -la /var/lib/postgresql/data/
```

**初始化输出解读**：
```
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default database encoding has therefore been set to "UTF8".

Success. You can now start the database server using:
    pg_ctl -D /var/lib/postgresql/data start
```

### 3.5 初始化参数说明


```bash
# 常用初始化参数
initdb \
  -D /path/to/data          # 数据目录位置
  --encoding=UTF8           # 字符编码
  --locale=zh_CN.UTF-8      # 区域设置
  --auth-method=md5         # 认证方法
  --pwprompt               # 设置超级用户密码
```

---

## 4. 📝 核心配置文件详解


### 4.1 配置文件概览


PostgreSQL有**两个最重要的配置文件**，它们就像数据库的"身份证"和"门禁卡"：

```
配置文件位置（通常在数据目录下）：
├── postgresql.conf      ← 数据库主配置文件（身份证）
├── pg_hba.conf         ← 客户端认证配置（门禁卡）
├── pg_ident.conf       ← 用户映射配置
└── postgresql.auto.conf ← 自动生成的配置
```

### 4.2 postgresql.conf 主配置文件


**这个文件控制PostgreSQL的运行方式**，就像汽车的控制面板，决定数据库怎么工作。

#### 🔸 连接和认证设置


```bash
# 监听地址设置
listen_addresses = 'localhost'        # 只允许本地连接
listen_addresses = '*'               # 允许所有IP连接
listen_addresses = '192.168.1.100'   # 只允许特定IP

# 端口设置
port = 5432                          # 默认端口

# 最大连接数
max_connections = 100                # 同时最多100个连接
```

> **💡 新手提醒**：`listen_addresses`决定谁能连到你的数据库，`*`表示任何人都能尝试连接（但还需要通过认证）。

#### 🔸 内存设置


```bash
# 共享内存缓冲区（推荐为系统内存的25%）
shared_buffers = 256MB               # 4GB内存系统推荐值

# 工作内存（每个查询操作可用的内存）
work_mem = 4MB                       # 单个查询的工作内存

# 维护工作内存（用于维护操作）
maintenance_work_mem = 64MB          # 维护操作的内存
```

#### 🔸 日志设置


```bash
# 开启日志记录
logging_collector = on               # 启用日志收集器

# 日志文件位置
log_directory = 'log'                # 日志目录

# 记录哪些语句
log_statement = 'all'                # 记录所有SQL语句
log_statement = 'none'               # 不记录SQL语句
log_statement = 'ddl'                # 只记录DDL语句
```

### 4.3 pg_hba.conf 认证配置文件


**这个文件是数据库的"门卫"**，决定谁能进来，用什么方式验证身份。

#### 🔸 配置格式说明


```
# 配置行格式：
# TYPE  DATABASE  USER  ADDRESS  METHOD
```

**字段含义**：
- `TYPE`: 连接类型（local/host/hostssl等）
- `DATABASE`: 允许访问的数据库名
- `USER`: 允许访问的用户名
- `ADDRESS`: 允许的IP地址范围
- `METHOD`: 认证方法

#### 🔸 常用配置示例


```bash
# 本地连接配置
local   all             all                                     peer
local   all             all                                     md5

# 网络连接配置
host    all             all             127.0.0.1/32            md5
host    all             all             192.168.1.0/24          md5
host    all             all             0.0.0.0/0               md5
```

**认证方法说明**：

| 认证方法 | 含义 | 适用场景 |
|---------|------|----------|
| `peer` | 使用操作系统用户认证 | 本地连接 |
| `md5` | 密码加密认证 | 网络连接 |
| `trust` | 无需密码认证 | 测试环境 |
| `reject` | 拒绝连接 | 安全限制 |

#### 🔸 安全配置建议


```bash
# 生产环境推荐配置
local   all             postgres                                peer
local   all             all                                     md5
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5
host    all             all             192.168.1.0/24          md5
```

---

## 5. 🎛️ 服务管理与启动控制


### 5.1 systemd服务管理


**systemd是现代Linux系统的服务管理工具**，就像手机上的应用管理器，可以启动、停止、重启PostgreSQL服务。

#### 🔸 基本服务操作


```bash
# 启动PostgreSQL服务
sudo systemctl start postgresql

# 停止PostgreSQL服务
sudo systemctl stop postgresql

# 重启PostgreSQL服务
sudo systemctl restart postgresql

# 重新加载配置（不重启服务）
sudo systemctl reload postgresql

# 查看服务状态
sudo systemctl status postgresql
```

#### 🔸 开机自启动设置


```bash
# 设置开机自启动
sudo systemctl enable postgresql

# 取消开机自启动
sudo systemctl disable postgresql

# 查看是否设置了自启动
sudo systemctl is-enabled postgresql
```

### 5.2 手动服务控制


**有时候你可能需要更精细的控制**，这时可以使用PostgreSQL自带的工具。

```bash
# 切换到postgres用户
sudo su - postgres

# 启动数据库
pg_ctl start -D /var/lib/postgresql/data

# 停止数据库
pg_ctl stop -D /var/lib/postgresql/data

# 重启数据库
pg_ctl restart -D /var/lib/postgresql/data

# 重新加载配置
pg_ctl reload -D /var/lib/postgresql/data

# 查看状态
pg_ctl status -D /var/lib/postgresql/data
```

### 5.3 服务状态检查


```bash
# 检查服务运行状态
sudo systemctl status postgresql

# 查看服务日志
sudo journalctl -u postgresql -f

# 查看端口监听情况
sudo netstat -tlnp | grep 5432
sudo ss -tlnp | grep 5432

# 测试连接
sudo -u postgres psql -c "SELECT now();"
```

**服务正常运行的标志**：
- ✅ systemctl status显示active (running)
- ✅ 端口5432在监听
- ✅ 能够正常连接数据库

---

## 6. 👤 用户权限与安全配置


### 6.1 理解PostgreSQL用户体系


**PostgreSQL有两套用户系统**：
- **操作系统用户** - 管理PostgreSQL服务的系统用户
- **数据库用户** - 在数据库内部使用的用户

```
用户关系图：
┌─────────────────┐
│  操作系统层面    │
│  postgres用户   │ ← 管理PostgreSQL服务
└─────────────────┘
         ↓
┌─────────────────┐
│   数据库层面     │
│  postgres角色   │ ← 数据库超级用户
│  普通角色        │ ← 业务用户
└─────────────────┘
```

### 6.2 postgres系统用户管理


**postgres用户是PostgreSQL服务的"管家"**，负责管理整个数据库系统。

```bash
# 查看postgres用户信息
id postgres

# 切换到postgres用户
sudo su - postgres

# 查看postgres用户的家目录
ls -la /var/lib/postgresql/
```

**重要注意事项**：
- 🔐 postgres用户拥有数据目录的完全控制权
- 🛡️ 不要给postgres用户设置shell登录权限
- 📁 数据目录权限应该是700（只有postgres用户可读写）

### 6.3 数据库角色管理


#### 🔸 超级用户postgres


```bash
# 连接到数据库
sudo -u postgres psql

# 查看当前用户
SELECT current_user;

# 查看所有角色
\du
```

#### 🔸 创建普通用户


```sql
-- 创建普通用户
CREATE USER myuser WITH PASSWORD 'mypassword';

-- 创建具有创建数据库权限的用户
CREATE USER dbadmin WITH PASSWORD 'adminpass' CREATEDB;

-- 创建具有登录权限的角色
CREATE ROLE approle WITH LOGIN PASSWORD 'apppass';
```

#### 🔸 权限管理


```sql
-- 授予数据库访问权限
GRANT CONNECT ON DATABASE mydb TO myuser;

-- 授予表的查询权限
GRANT SELECT ON ALL TABLES IN SCHEMA public TO myuser;

-- 授予表的完全权限
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO myuser;

-- 回收权限
REVOKE ALL PRIVILEGES ON DATABASE mydb FROM myuser;
```

### 6.4 安全配置建议


#### 🔸 密码安全设置


```sql
-- 设置密码复杂度要求
ALTER SYSTEM SET password_encryption = 'scram-sha-256';

-- 设置密码过期时间
ALTER USER myuser VALID UNTIL '2024-12-31';
```

#### 🔸 连接安全限制


```bash
# 在pg_hba.conf中限制连接
# 只允许特定IP连接
host    mydb    myuser    192.168.1.100/32    md5

# 限制连接数（在postgresql.conf中）
max_connections = 100
```

---

## 7. 🌐 网络配置与连接管理


### 7.1 监听地址配置


**监听地址决定PostgreSQL在哪些网络接口上接受连接**，就像决定你的房子在哪些门上装门铃。

#### 🔸 本地连接配置


```bash
# 只允许本地连接（默认设置）
listen_addresses = 'localhost'
```

**适用场景**：
- 📱 开发测试环境
- 🔒 单机应用部署
- 🛡️ 高安全要求的环境

#### 🔸 网络连接配置


```bash
# 允许所有网络接口连接
listen_addresses = '*'

# 允许特定IP连接
listen_addresses = '192.168.1.100,10.0.0.50'
```

**配置后重启服务**：
```bash
sudo systemctl restart postgresql
```

### 7.2 端口配置


```bash
# 修改监听端口（postgresql.conf）
port = 5432                    # 默认端口
port = 5433                    # 自定义端口
```

**端口选择建议**：
- **5432** - PostgreSQL默认端口
- **5433-5435** - 常用的备用端口
- **避免使用** - 系统保留端口（1-1023）

### 7.3 防火墙配置


#### 🔸 CentOS/RHEL防火墙设置


```bash
# 开放PostgreSQL端口
sudo firewall-cmd --permanent --add-port=5432/tcp
sudo firewall-cmd --reload

# 或者添加服务
sudo firewall-cmd --permanent --add-service=postgresql
sudo firewall-cmd --reload

# 查看开放的端口
sudo firewall-cmd --list-ports
```

#### 🔸 Ubuntu防火墙设置


```bash
# 使用ufw开放端口
sudo ufw allow 5432/tcp

# 允许特定IP访问
sudo ufw allow from 192.168.1.0/24 to any port 5432

# 查看防火墙状态
sudo ufw status
```

### 7.4 连接测试


#### 🔸 本地连接测试


```bash
# 使用psql连接
sudo -u postgres psql

# 指定端口连接
psql -h localhost -p 5432 -U postgres

# 连接特定数据库
psql -h localhost -U myuser -d mydb
```

#### 🔸 远程连接测试


```bash
# 从其他机器连接
psql -h 192.168.1.100 -p 5432 -U myuser -d mydb

# 测试网络连通性
telnet 192.168.1.100 5432
nc -zv 192.168.1.100 5432
```

**连接成功的标志**：
```
psql (15.x)
Type "help" for help.

postgres=#
```

---

## 8. 🔧 常见问题与故障排除


### 8.1 服务启动失败


#### 🔸 问题现象

```bash
sudo systemctl start postgresql
Job for postgresql.service failed because the control process exited with error code.
```

#### 🔸 故障排查步骤


```bash
# 1. 查看详细错误信息
sudo systemctl status postgresql -l
sudo journalctl -u postgresql -n 20

# 2. 检查配置文件语法
sudo -u postgres /usr/bin/postgres --check-config -D /var/lib/postgresql/data

# 3. 检查数据目录权限
ls -ld /var/lib/postgresql/data
# 应该显示：drwx------ postgres postgres
```

**常见解决方案**：
```bash
# 修复数据目录权限
sudo chown -R postgres:postgres /var/lib/postgresql/
sudo chmod 700 /var/lib/postgresql/data
```

### 8.2 连接被拒绝


#### 🔸 问题现象

```
psql: error: could not connect to server: Connection refused
```

#### 🔸 排查步骤


```bash
# 1. 检查服务是否运行
sudo systemctl status postgresql

# 2. 检查端口监听
sudo netstat -tlnp | grep 5432

# 3. 检查配置文件
grep listen_addresses /var/lib/postgresql/data/postgresql.conf
```

**解决方案**：
```bash
# 修改监听地址
echo "listen_addresses = '*'" >> /var/lib/postgresql/data/postgresql.conf
sudo systemctl restart postgresql
```

### 8.3 认证失败


#### 🔸 问题现象

```
psql: error: FATAL: authentication failed for user "myuser"
```

#### 🔸 解决方案


```bash
# 1. 检查pg_hba.conf配置
sudo cat /var/lib/postgresql/data/pg_hba.conf

# 2. 确保有正确的认证配置
echo "host all all 0.0.0.0/0 md5" >> /var/lib/postgresql/data/pg_hba.conf

# 3. 重新加载配置
sudo systemctl reload postgresql
```

### 8.4 内存不足问题


#### 🔸 问题现象

```
FATAL: could not create shared memory segment
```

#### 🔸 解决方案


```bash
# 1. 检查系统内存
free -h

# 2. 调整shared_buffers参数
echo "shared_buffers = 128MB" >> /var/lib/postgresql/data/postgresql.conf

# 3. 重启服务
sudo systemctl restart postgresql
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 PostgreSQL本质：开源的对象关系型数据库管理系统
🔸 初始化过程：initdb创建数据集群，准备工作环境
🔸 核心配置：postgresql.conf控制运行方式，pg_hba.conf管理访问权限
🔸 用户体系：系统用户postgres + 数据库角色postgres
🔸 服务管理：systemctl控制服务启停，pg_ctl精细化管理
```

### 9.2 安装配置检查清单


**✅ 安装验证**：
- [ ] PostgreSQL软件包安装完成
- [ ] postgres系统用户已创建
- [ ] 能够执行psql命令

**✅ 初始化验证**：
- [ ] 数据目录已创建并初始化
- [ ] 系统数据库（postgres、template0、template1）存在
- [ ] 配置文件postgresql.conf和pg_hba.conf已生成

**✅ 服务验证**：
- [ ] PostgreSQL服务能够正常启动
- [ ] 端口5432正在监听
- [ ] 能够本地连接数据库

**✅ 安全验证**：
- [ ] 数据目录权限设置为700
- [ ] postgres用户无shell登录权限
- [ ] pg_hba.conf配置了适当的认证方法

### 9.3 关键配置参数速查


```bash
# postgresql.conf 核心参数
listen_addresses = '*'              # 监听地址
port = 5432                        # 监听端口
max_connections = 100              # 最大连接数
shared_buffers = 256MB             # 共享缓冲区
work_mem = 4MB                     # 工作内存
log_statement = 'all'              # 日志记录级别

# pg_hba.conf 认证配置
local   all   all                     peer
host    all   all   127.0.0.1/32     md5
host    all   all   192.168.1.0/24   md5
```

### 9.4 实际应用场景


**🎯 开发环境配置**：
- 使用默认配置即可
- 关注pg_hba.conf的本地连接设置
- 开启详细日志方便调试

**🏢 生产环境配置**：
- 调整内存参数提升性能
- 严格配置网络访问权限
- 设置合适的连接数限制
- 配置SSL加密连接

**🔧 运维管理要点**：
- 定期备份配置文件
- 监控服务运行状态
- 及时应用安全更新
- 建立故障处理流程

### 9.5 学习路径建议


```
学习阶段规划：
📚 基础阶段 → 完成安装配置，能够启动服务
🔧 进阶阶段 → 理解配置参数，优化性能设置  
🚀 实战阶段 → 搭建生产环境，处理实际问题
💡 提升阶段 → 深入内核机制，自定义扩展
```

**💡 学习建议**：
- 在虚拟机中反复练习安装过程
- 尝试不同的配置参数组合
- 模拟各种故障场景并学会排除
- 阅读官方文档加深理解

**核心记忆**：
- PostgreSQL安装重在配置，配置重在理解
- 两大配置文件各司其职：postgresql.conf管运行，pg_hba.conf管访问
- 服务管理要熟练：systemctl日常使用，pg_ctl精确控制
- 安全第一原则：最小权限、网络隔离、定期更新