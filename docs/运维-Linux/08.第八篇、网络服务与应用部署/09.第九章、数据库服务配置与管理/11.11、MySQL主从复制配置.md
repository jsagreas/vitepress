---
title: 11、MySQL主从复制配置
---
## 📚 目录

1. [主从复制基本概念](#1-主从复制基本概念)
2. [复制原理与架构详解](#2-复制原理与架构详解)
3. [主服务器配置](#3-主服务器配置)
4. [从服务器配置](#4-从服务器配置)
5. [复制用户权限管理](#5-复制用户权限管理)
6. [binlog与GTID配置](#6-binlog与GTID配置)
7. [复制状态监控](#7-复制状态监控)
8. [故障处理与切换](#8-故障处理与切换)
9. [读写分离应用](#9-读写分离应用)
10. [性能优化与最佳实践](#10-性能优化与最佳实践)
11. [核心要点总结](#11-核心要点总结)

---

## 1. 🔄 主从复制基本概念


### 1.1 什么是主从复制


**主从复制**是MySQL数据库的一种数据同步技术，简单说就是：**一台主数据库的数据变化，会自动同步到一台或多台从数据库上**。

```
主从复制的本质：
📝 主库：负责写入数据，记录所有数据变化
📖 从库：从主库复制数据，主要负责查询读取
🔄 同步：主库数据变化自动传递给从库
```

### 1.2 为什么需要主从复制


**🎯 解决的核心问题**：
- **数据备份**：从库作为主库的实时备份
- **读写分离**：主库写入，从库查询，提升性能
- **负载均衡**：多个从库分担查询压力
- **高可用性**：主库故障时从库可以接管

> 💡 **通俗理解**：就像老师（主库）讲课，学生（从库）做笔记。老师说什么，学生就记什么，这样多个学生都有相同的笔记内容。

### 1.3 主从复制的应用场景


**📊 典型应用场景**：

| 场景 | 主库作用 | 从库作用 | 优势 |
|------|---------|---------|------|
| **电商网站** | 处理订单、支付 | 商品查询、搜索 | 读写分离，性能提升 |
| **新闻网站** | 发布文章 | 文章浏览 | 大量读取请求分散 |
| **数据备份** | 正常业务 | 实时备份 | 数据安全保障 |
| **地域分布** | 总部数据库 | 分公司数据库 | 就近访问，减少延迟 |

---

## 2. ⚙️ 复制原理与架构详解


### 2.1 复制工作原理


**🔍 复制过程三个关键步骤**：

```
步骤1：主库记录变化
主库执行：INSERT、UPDATE、DELETE
↓
写入二进制日志（binlog）

步骤2：从库读取日志  
从库IO线程：连接主库
↓
读取主库binlog内容
↓
写入本地中继日志（relay log）

步骤3：从库应用变化
从库SQL线程：读取relay log
↓
执行相同的SQL语句
↓
数据同步完成
```

### 2.2 复制架构图解


```
主从复制架构：

    应用程序
   /         \
写操作        读操作
  ↓            ↓
主库(Master)   从库(Slave)
  │              ↑
  │─── binlog ───┘
  │   (二进制日志)
  └─ 数据文件

详细流程：
主库 → binlog → 网络传输 → 从库relay log → 从库数据文件
```

### 2.3 复制的三个重要线程


**🔧 三个核心线程的作用**：

```
🔸 主库 - binlog dump线程
作用：向从库发送binlog内容
工作：当从库连接时启动，持续发送日志

🔸 从库 - IO线程  
作用：从主库读取binlog
工作：连接主库，接收binlog，写入relay log

🔸 从库 - SQL线程
作用：执行relay log中的SQL
工作：读取relay log，重放SQL语句，更新数据
```

---

## 3. 🖥️ 主服务器配置


### 3.1 启用二进制日志


**📝 修改主库配置文件** `/etc/mysql/mysql.conf.d/mysqld.cnf`：

```ini
[mysqld]
# 服务器ID（集群中唯一）
server-id = 1

# 启用二进制日志
log-bin = mysql-bin

# 二进制日志格式
binlog-format = ROW

# 需要复制的数据库（可选）
binlog-do-db = myapp

# 不复制的数据库（可选）  
binlog-ignore-db = mysql
binlog-ignore-db = information_schema
```

> 💡 **配置说明**：
> - `server-id`：每台服务器必须不同，用于区分服务器
> - `log-bin`：启用二进制日志，记录所有数据变化
> - `binlog-format`：建议使用ROW格式，最安全可靠

### 3.2 重启MySQL服务


```bash
# 重启MySQL使配置生效
sudo systemctl restart mysql

# 检查服务状态
sudo systemctl status mysql
```

### 3.3 验证配置


```sql
-- 检查二进制日志是否启用
SHOW VARIABLES LIKE 'log_bin';

-- 查看当前binlog文件
SHOW MASTER STATUS;
```

**🔍 正常输出示例**：
```
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000001 |      154 | myapp        | mysql            |
+------------------+----------+--------------+------------------+
```

---

## 4. 📱 从服务器配置


### 4.1 配置从库参数


**📝 修改从库配置文件**：

```ini
[mysqld]
# 从库服务器ID（与主库不同）
server-id = 2

# 启用中继日志
relay-log = mysql-relay-bin

# 只读模式（防止误写入）
read-only = 1

# 从库更新日志
log-slave-updates = 1
```

### 4.2 配置复制连接


**🔗 连接到从库MySQL**：

```sql
-- 设置主库连接信息
CHANGE MASTER TO
    MASTER_HOST='192.168.1.100',        -- 主库IP地址
    MASTER_PORT=3306,                   -- 主库端口
    MASTER_USER='repl_user',            -- 复制用户
    MASTER_PASSWORD='repl_password',     -- 复制密码
    MASTER_LOG_FILE='mysql-bin.000001', -- binlog文件名
    MASTER_LOG_POS=154;                 -- binlog位置
```

> ⚠️ **重要提醒**：`MASTER_LOG_FILE` 和 `MASTER_LOG_POS` 必须与主库的 `SHOW MASTER STATUS` 结果一致！

### 4.3 启动从库复制


```sql
-- 启动复制进程
START SLAVE;

-- 检查复制状态
SHOW SLAVE STATUS\G
```

**✅ 复制成功的关键指标**：
```
Slave_IO_Running: Yes      ← IO线程运行正常
Slave_SQL_Running: Yes     ← SQL线程运行正常
Seconds_Behind_Master: 0   ← 复制延迟（秒）
```

---

## 5. 👤 复制用户权限管理


### 5.1 创建专用复制用户


**🔐 在主库创建复制用户**：

```sql
-- 创建复制用户
CREATE USER 'repl_user'@'%' IDENTIFIED BY 'strong_password';

-- 授予复制权限
GRANT REPLICATION SLAVE ON *.* TO 'repl_user'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 5.2 权限安全配置


**🛡️ 最小权限原则**：

| 权限类型 | 权限名称 | 说明 | 必需性 |
|---------|---------|------|--------|
| **复制权限** | `REPLICATION SLAVE` | 读取主库binlog | ✅ 必需 |
| **连接权限** | 基本连接权限 | 连接到主库 | ✅ 必需 |
| **其他权限** | SELECT、INSERT等 | 业务操作权限 | ❌ 不需要 |

```sql
-- 查看用户权限
SHOW GRANTS FOR 'repl_user'@'%';

-- 验证权限设置
SELECT user, host FROM mysql.user WHERE user='repl_user';
```

### 5.3 密码安全管理


> 🔒 **安全建议**：
> - 使用强密码（包含大小写字母、数字、特殊字符）
> - 定期更换复制用户密码
> - 限制复制用户的来源IP地址
> - 使用SSL加密复制连接（生产环境推荐）

---

## 6. 📋 binlog与GTID配置


### 6.1 二进制日志格式详解


**📊 三种binlog格式对比**：

| 格式 | 记录内容 | 优点 | 缺点 | 适用场景 |
|------|---------|------|------|----------|
| **STATEMENT** | SQL语句 | 日志小，网络传输快 | 可能数据不一致 | 简单查询 |
| **ROW** | 数据行变化 | 数据一致性好 | 日志大，传输慢 | **推荐使用** |
| **MIXED** | 自动选择 | 平衡性能和一致性 | 复杂度高 | 特殊需求 |

**🎯 推荐配置**：
```ini
# 推荐使用ROW格式
binlog-format = ROW

# 记录完整的行信息
binlog-row-image = FULL
```

### 6.2 GTID全局事务标识符


**🏷️ GTID是什么**：
- **Global Transaction Identifier**：全局事务标识符
- **作用**：给每个事务分配唯一ID，简化主从切换
- **格式**：`服务器UUID:事务序号`

**🔧 启用GTID配置**：

```ini
[mysqld]
# 启用GTID
gtid-mode = ON
enforce-gtid-consistency = ON

# 二进制日志相关
log-bin = mysql-bin
log-slave-updates = ON
```

**✅ GTID的优势**：
- 🎯 **自动定位**：无需手动指定binlog文件和位置
- 🔄 **简化切换**：主从切换更简单可靠
- 🛡️ **数据一致性**：避免重复执行事务

### 6.3 使用GTID配置复制


```sql
-- 使用GTID方式配置从库
CHANGE MASTER TO
    MASTER_HOST='192.168.1.100',
    MASTER_PORT=3306,
    MASTER_USER='repl_user',
    MASTER_PASSWORD='repl_password',
    MASTER_AUTO_POSITION=1;  -- 自动定位，无需指定文件和位置
```

---

## 7. 📊 复制状态监控


### 7.1 基本状态检查命令


**🔍 主库状态监控**：

```sql
-- 查看主库状态
SHOW MASTER STATUS;

-- 查看连接的从库
SHOW SLAVE HOSTS;

-- 查看二进制日志列表
SHOW BINARY LOGS;
```

**🔍 从库状态监控**：

```sql
-- 查看从库详细状态
SHOW SLAVE STATUS\G

-- 关键字段含义：
-- Slave_IO_Running: IO线程状态
-- Slave_SQL_Running: SQL线程状态  
-- Seconds_Behind_Master: 复制延迟
-- Last_Error: 最后错误信息
```

### 7.2 复制延迟监控


**⏱️ 延迟监控的重要指标**：

```sql
-- 检查复制延迟
SELECT 
    CASE 
        WHEN Seconds_Behind_Master IS NULL THEN '复制未运行'
        WHEN Seconds_Behind_Master = 0 THEN '无延迟'
        WHEN Seconds_Behind_Master < 5 THEN '延迟较小'
        WHEN Seconds_Behind_Master < 30 THEN '延迟中等'
        ELSE '延迟较大'
    END AS delay_status,
    Seconds_Behind_Master as delay_seconds
FROM (SELECT Seconds_Behind_Master FROM SHOW SLAVE STATUS) t;
```

### 7.3 监控脚本示例


**📝 简单的监控脚本**：

```bash
#!/bin/bash
# MySQL复制状态检查脚本

MYSQL_USER="monitor_user"
MYSQL_PASS="monitor_pass"

# 检查从库状态
mysql -u$MYSQL_USER -p$MYSQL_PASS -e "
SELECT 
    IF(Slave_IO_Running='Yes' AND Slave_SQL_Running='Yes', 
       '复制正常', '复制异常') as replication_status,
    Seconds_Behind_Master as delay_seconds,
    Last_Error as error_message
FROM SHOW SLAVE STATUS\G
"
```

---

## 8. 🚨 故障处理与切换


### 8.1 常见复制故障


**🔧 故障类型与解决方案**：

| 故障现象 | 可能原因 | 解决方法 |
|---------|---------|----------|
| **IO线程停止** | 网络中断、权限问题 | 检查网络和用户权限 |
| **SQL线程停止** | 数据冲突、磁盘满 | 跳过错误或修复数据 |
| **复制延迟严重** | 从库性能差、大事务 | 优化从库配置 |
| **主库崩溃** | 硬件故障、软件错误 | 主从切换 |

### 8.2 跳过复制错误


**⚠️ 当从库遇到错误时**：

```sql
-- 查看错误信息
SHOW SLAVE STATUS\G

-- 跳过一个错误（谨慎使用）
STOP SLAVE;
SET GLOBAL sql_slave_skip_counter = 1;
START SLAVE;

-- 或者停止复制并重新开始
STOP SLAVE;
RESET SLAVE;
-- 重新配置复制...
```

### 8.3 主从切换流程


**🔄 计划内主从切换步骤**：

```
步骤1：停止应用写入
↓
步骤2：等待从库同步完成
SHOW SLAVE STATUS; (确认延迟为0)
↓
步骤3：在从库上停止复制
STOP SLAVE;
↓
步骤4：将从库改为可写
SET GLOBAL read_only = 0;
↓
步骤5：应用切换到新的主库
↓
步骤6：原主库配置为新的从库
```

---

## 9. 🔀 读写分离应用


### 9.1 读写分离原理


**🎯 读写分离的核心思想**：
- **写操作**：全部发送到主库
- **读操作**：分发到从库
- **目标**：减轻主库压力，提高系统性能

```
应用程序读写分离：

写请求 → 主库 (Master)
  ↓
数据同步
  ↓  
读请求 → 从库 (Slave 1, Slave 2, Slave 3)
```

### 9.2 应用层实现读写分离


**💻 简单的读写分离逻辑**：

```python
class DatabaseRouter:
    def __init__(self):
        self.master_db = "192.168.1.100:3306"  # 主库
        self.slave_dbs = [                       # 从库列表
            "192.168.1.101:3306",
            "192.168.1.102:3306"
        ]
    
    def get_connection(self, operation_type):
        if operation_type in ['INSERT', 'UPDATE', 'DELETE']:
            return self.connect_to_master()
        else:  # SELECT操作
            return self.connect_to_slave()
    
    def connect_to_slave(self):
        # 简单的负载均衡：随机选择从库
        import random
        slave_db = random.choice(self.slave_dbs)
        return connect_database(slave_db)
```

### 9.3 中间件方案


**🔧 常用的读写分离中间件**：

| 中间件 | 类型 | 优点 | 适用场景 |
|--------|------|------|----------|
| **ProxySQL** | 数据库代理 | 功能强大，配置灵活 | 生产环境推荐 |
| **MaxScale** | MariaDB代理 | 专门优化 | MariaDB环境 |
| **MyCAT** | 分库分表中间件 | 支持分片 | 大型系统 |
| **应用层** | 代码实现 | 控制精确 | 小型项目 |

---

## 10. ⚡ 性能优化与最佳实践


### 10.1 复制性能优化


**🚀 主库优化配置**：

```ini
[mysqld]
# 二进制日志缓冲区
binlog_cache_size = 1M

# 同步策略（性能与安全的平衡）
sync_binlog = 1              # 安全但慢
# sync_binlog = 0            # 快但有风险

# 事务提交策略
innodb_flush_log_at_trx_commit = 1  # 安全
# innodb_flush_log_at_trx_commit = 2  # 性能
```

**🚀 从库优化配置**：

```ini
[mysqld]
# 并行复制（MySQL 5.7+）
slave-parallel-type = LOGICAL_CLOCK
slave-parallel-workers = 4

# 中继日志缓冲
relay_log_info_repository = TABLE
relay_log_recovery = ON
```

### 10.2 监控关键指标


**📈 需要重点关注的指标**：

| 指标类别 | 具体指标 | 正常范围 | 异常处理 |
|---------|---------|----------|----------|
| **延迟监控** | Seconds_Behind_Master | < 5秒 | 检查网络和性能 |
| **线程状态** | IO/SQL Running | Yes | 重启复制线程 |
| **错误监控** | Last_Error | 空 | 分析并修复错误 |
| **日志大小** | binlog文件大小 | 合理范围 | 调整轮转策略 |

### 10.3 最佳实践总结


**✅ 生产环境建议**：

```
🔸 配置建议
- 使用ROW格式的binlog
- 启用GTID模式
- 从库设置为只读
- 配置合适的server-id

🔸 安全建议  
- 创建专用复制用户
- 使用强密码
- 启用SSL连接（如果需要）
- 定期备份和测试

🔸 监控建议
- 监控复制延迟
- 监控复制状态
- 设置告警机制
- 定期检查日志

🔸 维护建议
- 定期清理旧的binlog
- 测试故障切换流程
- 监控磁盘空间
- 定期更新密码
```

---

## 11. 📋 核心要点总结


### 11.1 必须掌握的基本概念


```
🔸 主从复制：主库数据变化自动同步到从库
🔸 复制原理：binlog → relay log → 数据同步
🔸 三个线程：binlog dump、IO线程、SQL线程
🔸 读写分离：主库写入，从库查询
🔸 GTID模式：全局事务标识符，简化管理
```

### 11.2 关键配置要点


**🔹 主库必备配置**：
```ini
server-id = 1
log-bin = mysql-bin
binlog-format = ROW
```

**🔹 从库必备配置**：
```ini
server-id = 2
relay-log = mysql-relay-bin  
read-only = 1
```

**🔹 复制连接设置**：
```sql
CHANGE MASTER TO
    MASTER_HOST='主库IP',
    MASTER_USER='复制用户',
    MASTER_PASSWORD='密码',
    MASTER_AUTO_POSITION=1;  -- GTID模式
```

### 11.3 监控与故障处理


**🔹 关键监控命令**：
- `SHOW MASTER STATUS;` - 查看主库状态
- `SHOW SLAVE STATUS\G` - 查看从库状态
- 重点关注：`Slave_IO_Running`、`Slave_SQL_Running`、`Seconds_Behind_Master`

**🔹 常见问题解决**：
- 复制停止 → 检查错误日志，重启复制
- 延迟过大 → 优化从库性能，检查网络
- 主库故障 → 执行主从切换流程

### 11.4 实际应用价值


- **🎯 高可用性**：主库故障时从库可以接管
- **📈 性能提升**：读写分离减轻主库压力  
- **🛡️ 数据安全**：实时数据备份
- **🌐 扩展性**：支持多个从库，水平扩展

**核心记忆**：
- 主从复制就是数据的自动备份和同步
- 配置核心是启用binlog和设置复制连接
- 监控重点是复制状态和延迟时间
- 读写分离是主从复制的重要应用