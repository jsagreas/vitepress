---
title: 11ã€SSHè®¿é—®æ§åˆ¶ç­–ç•¥
---
## ğŸ“š ç›®å½•


1. [SSHè®¿é—®æ§åˆ¶åŸºç¡€æ¦‚å¿µ](#1-SSHè®¿é—®æ§åˆ¶åŸºç¡€æ¦‚å¿µ)
2. [IPç™½åå•ä¸é»‘åå•](#2-IPç™½åå•ä¸é»‘åå•)
3. [fail2bané˜²æš´åŠ›ç ´è§£](#3-fail2bané˜²æš´åŠ›ç ´è§£)
4. [ç”¨æˆ·ç»„è®¿é—®æ§åˆ¶](#4-ç”¨æˆ·ç»„è®¿é—®æ§åˆ¶)
5. [æ—¶é—´çª—å£è®¿é—®é™åˆ¶](#5-æ—¶é—´çª—å£è®¿é—®é™åˆ¶)
6. [åœ°ç†ä½ç½®è®¿é—®æ§åˆ¶](#6-åœ°ç†ä½ç½®è®¿é—®æ§åˆ¶)
7. [å¤šå› ç´ è®¤è¯é…ç½®](#7-å¤šå› ç´ è®¤è¯é…ç½®)
8. [è¯ä¹¦è®¤è¯æœºåˆ¶](#8-è¯ä¹¦è®¤è¯æœºåˆ¶)
9. [ç»¼åˆå®‰å…¨ç­–ç•¥](#9-ç»¼åˆå®‰å…¨ç­–ç•¥)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

# ğŸ¯ **å­¦ä¹ è·¯å¾„å¯¼èˆª**


**å‰ç½®çŸ¥è¯†**ï¼šéœ€è¦æŒæ¡SSHåŸºç¡€é…ç½®ã€Linuxç”¨æˆ·ç®¡ç† â†’ **å½“å‰å†…å®¹**ï¼šSSHè®¿é—®æ§åˆ¶ç­–ç•¥ â†’ **åç»­å­¦ä¹ **ï¼šå»ºè®®å­¦ä¹ ç½‘ç»œé˜²ç«å¢™é…ç½®ã€å®‰å…¨å®¡è®¡

â±ï¸ **é¢„è®¡å­¦ä¹ æ—¶é—´**ï¼šæœ¬ç« é¢„è®¡90åˆ†é’Ÿ | å®è·µé…ç½®45åˆ†é’Ÿ

ğŸ·ï¸ **çŸ¥è¯†åˆ†çº§**: ğŸŸ¡ è¿›é˜¶çº§ - ç³»ç»Ÿç®¡ç†å¿…å¤‡æŠ€èƒ½

---

## 1. ğŸ” SSHè®¿é—®æ§åˆ¶åŸºç¡€æ¦‚å¿µ



### 1.1 ä»€ä¹ˆæ˜¯SSHè®¿é—®æ§åˆ¶



**æ ¸å¿ƒå®šä¹‰**
```
SSHè®¿é—®æ§åˆ¶ï¼šé™åˆ¶å’Œç®¡ç†SSHè¿æ¥çš„å®‰å…¨æœºåˆ¶
ç›®çš„ï¼šç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·èƒ½å¤Ÿå®‰å…¨è®¿é—®ç³»ç»Ÿ
åŸç†ï¼šé€šè¿‡å¤šå±‚é˜²æŠ¤ç­–ç•¥è¿‡æ»¤æ¶æ„è®¿é—®
```

**ğŸ’¡ é€šä¿—ç†è§£**
SSHè®¿é—®æ§åˆ¶å°±åƒå…¬å¸çš„é—¨ç¦ç³»ç»Ÿï¼š
- **èº«ä»½éªŒè¯**ï¼šç¡®è®¤ä½ æ˜¯è°ï¼ˆå¯†ç ã€å¯†é’¥ï¼‰
- **æƒé™æ£€æŸ¥**ï¼šç¡®è®¤ä½ èƒ½è¿›å“ªé‡Œï¼ˆç”¨æˆ·ç»„ã€IPé™åˆ¶ï¼‰
- **è¡Œä¸ºç›‘æ§**ï¼šè§‚å¯Ÿä½ åœ¨åšä»€ä¹ˆï¼ˆæ—¥å¿—ã€å¼‚å¸¸æ£€æµ‹ï¼‰
- **æ—¶é—´æ§åˆ¶**ï¼šé™åˆ¶ä½ ä»€ä¹ˆæ—¶å€™èƒ½è¿›ï¼ˆæ—¶é—´çª—å£ï¼‰

### 1.2 è®¿é—®æ§åˆ¶çš„é‡è¦æ€§



**ğŸ›¡ï¸ å®‰å…¨å¨èƒ**
```
å¸¸è§æ”»å‡»æ–¹å¼ï¼š
â€¢ æš´åŠ›ç ´è§£ï¼šè‡ªåŠ¨åŒ–å°è¯•å¯†ç ç»„åˆ
â€¢ å­—å…¸æ”»å‡»ï¼šä½¿ç”¨å¸¸è§å¯†ç åˆ—è¡¨
â€¢ ç¤¾ä¼šå·¥ç¨‹ï¼šè·å–ç”¨æˆ·å‡­æ®ä¿¡æ¯
â€¢ å†…éƒ¨å¨èƒï¼šåˆæ³•ç”¨æˆ·çš„æ¶æ„è¡Œä¸º
```

### 1.3 è®¿é—®æ§åˆ¶å±‚æ¬¡



**ğŸ—ï¸ å¤šå±‚é˜²æŠ¤ç»“æ„**
```
ç½‘ç»œå±‚é˜²æŠ¤
â”œâ”€â”€ é˜²ç«å¢™è§„åˆ™
â”œâ”€â”€ IPç™½åå•/é»‘åå•
â””â”€â”€ DDoSé˜²æŠ¤

åº”ç”¨å±‚é˜²æŠ¤  
â”œâ”€â”€ SSHé…ç½®é™åˆ¶
â”œâ”€â”€ ç”¨æˆ·æƒé™æ§åˆ¶
â””â”€â”€ è®¤è¯æœºåˆ¶

è¡Œä¸ºå±‚é˜²æŠ¤
â”œâ”€â”€ ç™»å½•ç›‘æ§
â”œâ”€â”€ å¼‚å¸¸æ£€æµ‹
â””â”€â”€ è‡ªåŠ¨å“åº”
```

---

## 2. ğŸŒ IPç™½åå•ä¸é»‘åå•



### 2.1 SSHé…ç½®ä¸­çš„IPæ§åˆ¶



**âš™ï¸ sshd_configé…ç½®**

SSHæœåŠ¡å™¨å¯ä»¥ç›´æ¥åœ¨é…ç½®æ–‡ä»¶ä¸­é™åˆ¶è®¿é—®IPï¼š

| **é…ç½®é¡¹** | **ä½œç”¨** | **è¯­æ³•ç¤ºä¾‹** |
|-----------|---------|-------------|
| `AllowUsers` | å…è®¸ç‰¹å®šç”¨æˆ·ä»ç‰¹å®šIPç™»å½• | `AllowUsers admin@192.168.1.*` |
| `DenyUsers` | æ‹’ç»ç‰¹å®šç”¨æˆ·ä»ç‰¹å®šIPç™»å½• | `DenyUsers guest@*` |
| `Match Address` | åŸºäºIPåœ°å€çš„æ¡ä»¶é…ç½® | `Match Address 192.168.1.0/24` |

**å®é™…é…ç½®ç¤ºä¾‹**
```bash
# /etc/ssh/sshd_config


# åªå…è®¸å†…ç½‘IPè®¿é—®

AllowUsers admin@192.168.1.*,admin@10.0.0.*

# æ‹’ç»ä»å¤–ç½‘è®¿é—®root

DenyUsers root@!192.168.1.0/24

# é’ˆå¯¹ç‰¹å®šç½‘æ®µçš„é…ç½®

Match Address 192.168.1.100,192.168.1.101
    PasswordAuthentication no
    PubkeyAuthentication yes
```

### 2.2 é˜²ç«å¢™å±‚é¢çš„IPæ§åˆ¶



**ğŸ”¥ iptablesè§„åˆ™é…ç½®**

æ›´å¸¸ç”¨çš„åšæ³•æ˜¯åœ¨é˜²ç«å¢™å±‚é¢æ§åˆ¶SSHè®¿é—®ï¼š

```bash
# æ¸…ç©ºç°æœ‰è§„åˆ™

iptables -F INPUT

# å…è®¸æœ¬åœ°å›ç¯

iptables -A INPUT -i lo -j ACCEPT

# å…è®¸å·²å»ºç«‹çš„è¿æ¥

iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# SSHç™½åå• - åªå…è®¸ç‰¹å®šIP

iptables -A INPUT -p tcp --dport 22 -s 192.168.1.100 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -s 192.168.1.101 -j ACCEPT

# SSHé»‘åå• - æ‹’ç»ç‰¹å®šIP  

iptables -A INPUT -p tcp --dport 22 -s 203.0.113.0/24 -j DROP

# é»˜è®¤æ‹’ç»å…¶ä»–SSHè¿æ¥

iptables -A INPUT -p tcp --dport 22 -j DROP

# ä¿å­˜è§„åˆ™

iptables-save > /etc/iptables/rules.v4
```

### 2.3 åŠ¨æ€IPç®¡ç†è„šæœ¬



**ğŸ”„ è‡ªåŠ¨åŒ–IPç®¡ç†**

å¯¹äºéœ€è¦åŠ¨æ€è°ƒæ•´IPè®¿é—®çš„åœºæ™¯ï¼š

```bash
#!/bin/bash

# ssh-ip-manager.sh - SSH IPè®¿é—®ç®¡ç†è„šæœ¬


IP_WHITELIST="/etc/ssh/whitelist.txt"
IP_BLACKLIST="/etc/ssh/blacklist.txt"

add_whitelist() {
    local ip="$1"
    echo "ğŸ“ æ·»åŠ IPåˆ°ç™½åå•: $ip"
    
#    # æ·»åŠ åˆ°æ–‡ä»¶
    echo "$ip" >> "$IP_WHITELIST"
    
#    # æ·»åŠ é˜²ç«å¢™è§„åˆ™
    iptables -I INPUT -p tcp --dport 22 -s "$ip" -j ACCEPT
    
    echo "âœ… IP $ip å·²åŠ å…¥ç™½åå•"
}

remove_whitelist() {
    local ip="$1"
    echo "ğŸ—‘ï¸ ä»ç™½åå•ç§»é™¤IP: $ip"
    
#    # ä»æ–‡ä»¶åˆ é™¤
    sed -i "/$ip/d" "$IP_WHITELIST"
    
#    # åˆ é™¤é˜²ç«å¢™è§„åˆ™
    iptables -D INPUT -p tcp --dport 22 -s "$ip" -j ACCEPT 2>/dev/null
    
    echo "âœ… IP $ip å·²ä»ç™½åå•ç§»é™¤"
}

# ä½¿ç”¨ç¤ºä¾‹

case "$1" in
    add)
        add_whitelist "$2"
        ;;
    remove)
        remove_whitelist "$2"
        ;;
    list)
        echo "ğŸ“‹ å½“å‰ç™½åå•:"
        cat "$IP_WHITELIST" 2>/dev/null || echo "æš‚æ— ç™½åå•IP"
        ;;
    *)
        echo "ç”¨æ³•: $0 {add|remove|list} [IPåœ°å€]"
        ;;
esac
```

---

## 3. ğŸš« fail2bané˜²æš´åŠ›ç ´è§£



### 3.1 fail2banå·¥ä½œåŸç†



**ğŸ” æ£€æµ‹æœºåˆ¶**
```
fail2ban = æ—¥å¿—ç›‘æ§ + è§„åˆ™åŒ¹é… + è‡ªåŠ¨å°ç¦

å·¥ä½œæµç¨‹ï¼š
1. ç›‘æ§æ—¥å¿—æ–‡ä»¶ (/var/log/auth.log)
2. åŒ¹é…å¤±è´¥ç™»å½•æ¨¡å¼
3. ç»Ÿè®¡å¤±è´¥æ¬¡æ•°
4. è¾¾åˆ°é˜ˆå€¼åè‡ªåŠ¨å°ç¦IP
5. è®¾å®šæ—¶é—´åè‡ªåŠ¨è§£å°
```

### 3.2 å®‰è£…å’ŒåŸºç¡€é…ç½®



**ğŸ“¦ å®‰è£…fail2ban**
```bash
# Ubuntu/Debian

sudo apt-get update
sudo apt-get install fail2ban

# CentOS/RHEL  

sudo yum install epel-release
sudo yum install fail2ban

# å¯åŠ¨æœåŠ¡

sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

**âš™ï¸ åŸºç¡€é…ç½®æ–‡ä»¶**

åˆ›å»ºæœ¬åœ°é…ç½®æ–‡ä»¶ `/etc/fail2ban/jail.local`ï¼š

```ini
[DEFAULT]
# å°ç¦æ—¶é—´ï¼ˆç§’ï¼‰

bantime = 3600

# æ£€æŸ¥æ—¶é—´çª—å£ï¼ˆç§’ï¼‰

findtime = 600

# æœ€å¤§é‡è¯•æ¬¡æ•°

maxretry = 3

# å¿½ç•¥çš„IPï¼ˆç™½åå•ï¼‰

ignoreip = 127.0.0.1/8 ::1 192.168.1.0/24

[sshd]
enabled = true
port = 22
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 1800
```

### 3.3 é«˜çº§é…ç½®ç­–ç•¥



**ğŸ¯ åˆ†çº§å°ç¦ç­–ç•¥**

ä¸åŒç±»å‹çš„æ”»å‡»é‡‡ç”¨ä¸åŒçš„å°ç¦ç­–ç•¥ï¼š

```ini
# /etc/fail2ban/jail.local


# è½»åº¦æ”»å‡» - çŸ­æœŸå°ç¦

[sshd-light]
enabled = true
port = 22
filter = sshd
logpath = /var/log/auth.log
maxretry = 5
bantime = 300
findtime = 300

# ä¸­åº¦æ”»å‡» - ä¸­æœŸå°ç¦  

[sshd-medium]
enabled = true
port = 22
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 1800
findtime = 600

# é‡åº¦æ”»å‡» - é•¿æœŸå°ç¦

[sshd-heavy]
enabled = true
port = 22
filter = sshd
logpath = /var/log/auth.log
maxretry = 1
bantime = 86400
findtime = 3600
```

### 3.4 è‡ªå®šä¹‰è¿‡æ»¤è§„åˆ™



**ğŸ” åˆ›å»ºè‡ªå®šä¹‰è¿‡æ»¤å™¨**

åˆ›å»º `/etc/fail2ban/filter.d/sshd-custom.conf`ï¼š

```ini
[Definition]
# åŒ¹é…SSHç™»å½•å¤±è´¥

failregex = ^%(__prefix_line)s(?:error: PAM: )?[aA]uthentication (?:failure|error|failed) for .* from <HOST>( via \S+)?\s*$
            ^%(__prefix_line)s(?:error: )?Received disconnect from <HOST>: 3: .*: Auth fail$
            ^%(__prefix_line)sUser .+ from <HOST> not allowed because not listed in AllowUsers$
            ^%(__prefix_line)sauthentication failure; logname=\S* uid=\S* euid=\S* tty=\S* ruser=\S* rhost=<HOST>(?:\s+user=.*)?\s*$

# å¿½ç•¥æˆåŠŸç™»å½•

ignoreregex = ^%(__prefix_line)sAccepted
```

### 3.5 fail2banç®¡ç†å‘½ä»¤



**ğŸ› ï¸ å¸¸ç”¨ç®¡ç†æ“ä½œ**

```bash
# æŸ¥çœ‹çŠ¶æ€

sudo fail2ban-client status

# æŸ¥çœ‹ç‰¹å®šç›‘ç‹±çŠ¶æ€

sudo fail2ban-client status sshd

# æ‰‹åŠ¨å°ç¦IP

sudo fail2ban-client set sshd banip 192.168.1.100

# æ‰‹åŠ¨è§£å°IP

sudo fail2ban-client set sshd unbanip 192.168.1.100

# é‡æ–°åŠ è½½é…ç½®

sudo fail2ban-client reload

# æŸ¥çœ‹å°ç¦åˆ—è¡¨

sudo fail2ban-client get sshd banip
```

---

## 4. ğŸ‘¥ ç”¨æˆ·ç»„è®¿é—®æ§åˆ¶



### 4.1 AllowUsersä¸DenyUsers



**ğŸ‘¤ ç”¨æˆ·çº§åˆ«æ§åˆ¶**

SSHå¯ä»¥ç²¾ç¡®æ§åˆ¶å“ªäº›ç”¨æˆ·å¯ä»¥ç™»å½•ï¼š

```bash
# /etc/ssh/sshd_config


# åªå…è®¸ç‰¹å®šç”¨æˆ·ç™»å½•

AllowUsers admin developer@192.168.1.* backup@localhost

# æ‹’ç»ç‰¹å®šç”¨æˆ·ç™»å½•

DenyUsers guest temp nobody

# ç»„åˆä½¿ç”¨ç¤ºä¾‹

AllowUsers admin@192.168.1.0/24 developer@10.0.0.0/8
DenyUsers root@!127.0.0.1
```

**è¯­æ³•æ ¼å¼è¯´æ˜**ï¼š
- `ç”¨æˆ·å`ï¼šå…è®¸ä»ä»»ä½•åœ°å€ç™»å½•
- `ç”¨æˆ·å@IP`ï¼šåªå…è®¸ä»ç‰¹å®šIPç™»å½•
- `ç”¨æˆ·å@!IP`ï¼šé™¤äº†ç‰¹å®šIPå¤–éƒ½å…è®¸

### 4.2 AllowGroupsä¸DenyGroups



**ğŸ‘¥ ç»„çº§åˆ«æ§åˆ¶**

åŸºäºç”¨æˆ·ç»„è¿›è¡Œè®¿é—®æ§åˆ¶æ›´ä¾¿äºç®¡ç†ï¼š

```bash
# åˆ›å»ºSSHè®¿é—®ä¸“ç”¨ç»„

sudo groupadd ssh-users
sudo groupadd ssh-admins

# å°†ç”¨æˆ·åŠ å…¥ç»„

sudo usermod -a -G ssh-users developer
sudo usermod -a -G ssh-admins admin

# SSHé…ç½®

# /etc/ssh/sshd_config

AllowGroups ssh-users ssh-admins
DenyGroups guest-users temp-users
```

### 4.3 æ¡ä»¶è®¿é—®æ§åˆ¶



**ğŸ¯ MatchæŒ‡ä»¤é«˜çº§ç”¨æ³•**

SSHæ”¯æŒåŸºäºå¤šç§æ¡ä»¶çš„ç²¾ç»†æ§åˆ¶ï¼š

```bash
# /etc/ssh/sshd_config


# å†…ç½‘ç”¨æˆ·å¯ä»¥ä½¿ç”¨å¯†ç 

Match Address 192.168.1.0/24
    PasswordAuthentication yes
    PermitRootLogin yes

# å¤–ç½‘åªèƒ½ç”¨å¯†é’¥è®¤è¯

Match Address !192.168.1.0/24
    PasswordAuthentication no
    PermitRootLogin no
    PubkeyAuthentication yes

# ç‰¹å®šç”¨æˆ·ç»„çš„é™åˆ¶

Match Group developers
    AllowTcpForwarding no
    X11Forwarding no
    ForceCommand /usr/bin/restricted-shell

# ç‰¹å®šç”¨æˆ·çš„chrootç¯å¢ƒ

Match User sandboxuser
    ChrootDirectory /var/chroot/sandbox
    ForceCommand internal-sftp
    AllowTcpForwarding no
```

---

## 5. â° æ—¶é—´çª—å£è®¿é—®é™åˆ¶



### 5.1 åŸºäºæ—¶é—´çš„è®¿é—®æ§åˆ¶



Linuxç³»ç»Ÿæœ¬èº«æ²¡æœ‰å†…ç½®çš„SSHæ—¶é—´é™åˆ¶åŠŸèƒ½ï¼Œä½†å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å®ç°ã€‚

**â³ ä½¿ç”¨PAMæ¨¡å—æ§åˆ¶**

ç¼–è¾‘ `/etc/security/time.conf`ï¼š

```bash
# æ ¼å¼ï¼šæœåŠ¡;tty;ç”¨æˆ·;æ—¶é—´

# åªå…è®¸å·¥ä½œæ—¶é—´ç™»å½•

sshd;*;*;MoTuWeThFr0800-1800

# ç®¡ç†å‘˜24å°æ—¶å¯è®¿é—®

sshd;*;admin;Al0000-2400

# å¼€å‘è€…å·¥ä½œæ—¥è®¿é—®

sshd;*;developer;MoTuWeThFr0900-1700
```

ç„¶ååœ¨ `/etc/pam.d/sshd` ä¸­å¯ç”¨ï¼š

```bash
# åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ 

account required pam_time.so
```

### 5.2 è„šæœ¬åŒ–æ—¶é—´æ§åˆ¶



**ğŸ• å®šæ—¶ä»»åŠ¡ç®¡ç†SSHè®¿é—®**

åˆ›å»ºæ—¶é—´æ§åˆ¶è„šæœ¬ï¼š

```bash
#!/bin/bash

# ssh-time-control.sh


CURRENT_HOUR=$(date +%H)
CURRENT_DAY=$(date +%u)  # 1-7 (Monday-Sunday)

# å·¥ä½œæ—¶é—´å®šä¹‰ (8:00-18:00, å‘¨ä¸€åˆ°å‘¨äº”)

WORK_START=8
WORK_END=18
WORK_DAYS="1 2 3 4 5"

is_work_time() {
    if [[ $WORK_DAYS =~ $CURRENT_DAY ]] && 
       [[ $CURRENT_HOUR -ge $WORK_START ]] && 
       [[ $CURRENT_HOUR -lt $WORK_END ]]; then
        return 0  # æ˜¯å·¥ä½œæ—¶é—´
    else
        return 1  # éå·¥ä½œæ—¶é—´
    fi
}

# æ ¹æ®æ—¶é—´è°ƒæ•´SSHè®¿é—®ç­–ç•¥

if is_work_time; then
#    # å·¥ä½œæ—¶é—´ - å…è®¸æ™®é€šç”¨æˆ·ç™»å½•
    iptables -A INPUT -p tcp --dport 22 -s 192.168.1.0/24 -j ACCEPT
    echo "âœ… å·¥ä½œæ—¶é—´ï¼šSSHè®¿é—®å·²å¼€æ”¾"
else
#    # éå·¥ä½œæ—¶é—´ - åªå…è®¸ç®¡ç†å‘˜
    iptables -D INPUT -p tcp --dport 22 -s 192.168.1.0/24 -j ACCEPT 2>/dev/null
    iptables -A INPUT -p tcp --dport 22 -s 192.168.1.10 -j ACCEPT  # ç®¡ç†å‘˜IP
    echo "ğŸ”’ éå·¥ä½œæ—¶é—´ï¼šé™åˆ¶SSHè®¿é—®"
fi
```

è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼š

```bash
# æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡

0 * * * * /path/to/ssh-time-control.sh
```

---

## 6. ğŸŒ åœ°ç†ä½ç½®è®¿é—®æ§åˆ¶



### 6.1 GeoIPæ•°æ®åº“



**ğŸ—ºï¸ åŸºäºåœ°ç†ä½ç½®çš„è¿‡æ»¤**

å®‰è£…GeoIPå·¥å…·ï¼š

```bash
# Ubuntu/Debian

sudo apt-get install geoip-bin geoip-database

# æµ‹è¯•GeoIPåŠŸèƒ½

geoiplookup 8.8.8.8
# è¾“å‡º: GeoIP Country Edition: US, United States

```

### 6.2 ç»“åˆiptablesçš„åœ°ç†è¿‡æ»¤



**ğŸŒ å›½å®¶çº§è®¿é—®æ§åˆ¶**

ä½¿ç”¨xtables-addonså®ç°åœ°ç†ä½ç½®è¿‡æ»¤ï¼š

```bash
# å®‰è£…xtables-addons

sudo apt-get install xtables-addons-common

# ä¸‹è½½GeoIPæ•°æ®

sudo mkdir -p /usr/share/xt_geoip
sudo wget -O /tmp/GeoLite2-Country-CSV.zip \
    "https://dev.maxmind.com/geoip/geoip2/geolite2/"

# åªå…è®¸ä¸­å›½IPè®¿é—®SSH

iptables -A INPUT -p tcp --dport 22 -m geoip --src-cc CN -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j DROP
```

### 6.3 ç®€åŒ–çš„åœ°ç†ä½ç½®æ§åˆ¶



**ğŸ¯ å®ç”¨çš„è„šæœ¬æ–¹æ¡ˆ**

åˆ›å»ºç®€å•çš„åœ°ç†ä½ç½®æ£€æŸ¥è„šæœ¬ï¼š

```bash
#!/bin/bash

# geo-ssh-filter.sh


check_country() {
    local ip="$1"
    local country=$(geoiplookup "$ip" | cut -d' ' -f4 | cut -d',' -f1)
    echo "$country"
}

# å…è®¸çš„å›½å®¶åˆ—è¡¨

ALLOWED_COUNTRIES=("CN" "US" "JP")

# æ£€æŸ¥SSHè¿æ¥çš„IP

SSH_CLIENT_IP=${SSH_CLIENT%% *}

if [[ -n "$SSH_CLIENT_IP" ]]; then
    CLIENT_COUNTRY=$(check_country "$SSH_CLIENT_IP")
    
    if [[ " ${ALLOWED_COUNTRIES[*]} " =~ " ${CLIENT_COUNTRY} " ]]; then
        echo "âœ… å…è®¸æ¥è‡ª $CLIENT_COUNTRY çš„è¿æ¥"
        exit 0
    else
        echo "âŒ æ‹’ç»æ¥è‡ª $CLIENT_COUNTRY çš„è¿æ¥"
        exit 1
    fi
fi
```

---

## 7. ğŸ” å¤šå› ç´ è®¤è¯é…ç½®



### 7.1 Google Authenticatoré…ç½®



**ğŸ“± æ‰‹æœºä»¤ç‰Œè®¤è¯**

å®‰è£…Google Authenticator PAMæ¨¡å—ï¼š

```bash
sudo apt-get install libpam-google-authenticator
```

ä¸ºç”¨æˆ·é…ç½®TOTPï¼š

```bash
# åˆ‡æ¢åˆ°ç›®æ ‡ç”¨æˆ·

su - admin

# è¿è¡Œé…ç½®å‘å¯¼

google-authenticator

# é…ç½®é€‰é¡¹å»ºè®®:

# Time-based tokens: y

# Update .google_authenticator file: y  

# Disallow multiple uses: y

# Increase window: n

# Enable rate-limiting: y

```

**âš™ï¸ PAMé…ç½®**

ç¼–è¾‘ `/etc/pam.d/sshd`ï¼Œæ·»åŠ ï¼š

```bash
# åœ¨@include common-authä¹‹å‰æ·»åŠ 

auth required pam_google_authenticator.so
```

ç¼–è¾‘SSHé…ç½® `/etc/ssh/sshd_config`ï¼š

```bash
ChallengeResponseAuthentication yes
AuthenticationMethods publickey,keyboard-interactive
```

### 7.2 ç¡¬ä»¶ä»¤ç‰Œæ”¯æŒ



**ğŸ”‘ FIDO2/WebAuthnæ”¯æŒ**

ç°ä»£Linuxå‘è¡Œç‰ˆæ”¯æŒç¡¬ä»¶å®‰å…¨å¯†é’¥ï¼š

```bash
# å®‰è£…libfido2

sudo apt-get install libfido2-1 libfido2-dev

# æ·»åŠ ç”¨æˆ·åˆ°fidoç»„

sudo usermod -a -G fido admin
```

### 7.3 å¤šå› ç´ è®¤è¯ç­–ç•¥



**ğŸ›¡ï¸ åˆ†å±‚è®¤è¯é…ç½®**

| **ç”¨æˆ·ç±»å‹** | **è®¤è¯è¦æ±‚** | **é…ç½®æ–¹å¼** |
|-------------|-------------|-------------|
| **ç®¡ç†å‘˜** | å¯†é’¥ + TOTP + ç¡¬ä»¶ä»¤ç‰Œ | ä¸‰é‡è®¤è¯ |
| **å¼€å‘è€…** | å¯†é’¥ + TOTP | åŒé‡è®¤è¯ |
| **åªè¯»ç”¨æˆ·** | å¯†é’¥è®¤è¯ | å•ä¸€è®¤è¯ |

```bash
# /etc/ssh/sshd_config åˆ†ç”¨æˆ·é…ç½®

Match User admin
    AuthenticationMethods publickey,keyboard-interactive:pam

Match User developer  
    AuthenticationMethods publickey,keyboard-interactive

Match User readonly
    AuthenticationMethods publickey
```

---

## 8. ğŸ“œ è¯ä¹¦è®¤è¯æœºåˆ¶



### 8.1 SSHè¯ä¹¦è®¤è¯åŸç†



**ğŸ” è¯ä¹¦ vs å¯†é’¥**
```
ä¼ ç»Ÿå¯†é’¥è®¤è¯ï¼š
â€¢ æ¯å°æœåŠ¡å™¨ç»´æŠ¤authorized_keys
â€¢ ç”¨æˆ·ç®¡ç†å¤æ‚ï¼Œéš¾ä»¥æ’¤é”€
â€¢ æ— æ³•è®¾ç½®è¿‡æœŸæ—¶é—´

è¯ä¹¦è®¤è¯ï¼š
â€¢ ä¸­å¿ƒåŒ–ç­¾åæœºæ„(CA)
â€¢ å¯ä»¥è®¾ç½®æœ‰æ•ˆæœŸ
â€¢ æ”¯æŒç»†ç²’åº¦æƒé™æ§åˆ¶
â€¢ æ˜“äºå¤§è§„æ¨¡ç®¡ç†
```

### 8.2 å»ºç«‹SSH CA



**ğŸ¢ åˆ›å»ºè¯ä¹¦ç­¾åæœºæ„**

```bash
# 1. ç”ŸæˆCAå¯†é’¥

ssh-keygen -t rsa -b 4096 -f ssh_ca_key
# ä¸è®¾ç½®å¯†ç çŸ­è¯­ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ç½®ï¼‰


# 2. åˆ›å»ºCAå…¬é’¥å‰¯æœ¬ç”¨äºåˆ†å‘

cp ssh_ca_key.pub ssh_ca_key_pub.pem

# 3. è®¾ç½®ä¸¥æ ¼æƒé™

chmod 600 ssh_ca_key
chmod 644 ssh_ca_key.pub
```

### 8.3 ç­¾å‘ç”¨æˆ·è¯ä¹¦



**ğŸ‘¤ ä¸ºç”¨æˆ·ç­¾å‘è¯ä¹¦**

```bash
# ç”¨æˆ·ç”Ÿæˆå¯†é’¥å¯¹

ssh-keygen -t rsa -b 4096 -f ~/.ssh/user_key

# CAç­¾å‘ç”¨æˆ·è¯ä¹¦

ssh-keygen -s ssh_ca_key \
    -I "user_admin" \
    -n admin,developer \
    -V +52w \
    ~/.ssh/user_key.pub

# å‚æ•°è¯´æ˜ï¼š

# -s: CAç§é’¥

# -I: è¯ä¹¦èº«ä»½æ ‡è¯†

# -n: å…è®¸çš„ç”¨æˆ·åï¼ˆprincipalsï¼‰

# -V: æœ‰æ•ˆæœŸï¼ˆ52å‘¨ï¼‰

```

### 8.4 é…ç½®æœåŠ¡å™¨æ”¯æŒè¯ä¹¦



**âš™ï¸ æœåŠ¡å™¨ç«¯é…ç½®**

```bash
# /etc/ssh/sshd_config


# å¯ç”¨è¯ä¹¦è®¤è¯

TrustedUserCAKeys /etc/ssh/ssh_ca_key.pub

# è¯ä¹¦è®¤è¯é…ç½®

AuthorizedPrincipalsFile /etc/ssh/auth_principals/%u

# ä¸ºç”¨æˆ·åˆ›å»ºprincipalsæ–‡ä»¶

echo "admin" > /etc/ssh/auth_principals/admin
echo "developer" > /etc/ssh/auth_principals/developer

# é‡å¯SSHæœåŠ¡

sudo systemctl reload ssh
```

### 8.5 è¯ä¹¦ç®¡ç†æœ€ä½³å®è·µ



**ğŸ¯ ç”Ÿäº§ç¯å¢ƒå»ºè®®**

è¯ä¹¦ç®¡ç†ç­–ç•¥ï¼š
- **çŸ­æœŸè¯ä¹¦**ï¼šç”¨æˆ·è¯ä¹¦æœ‰æ•ˆæœŸä¸è¶…è¿‡1å‘¨
- **å®šæœŸè½®æ¢**ï¼šCAå¯†é’¥å®šæœŸæ›´æ–°
- **æƒé™æœ€å°åŒ–**ï¼šè¯ä¹¦åªåŒ…å«å¿…éœ€çš„principals
- **å®¡è®¡è·Ÿè¸ª**ï¼šè®°å½•æ‰€æœ‰è¯ä¹¦ç­¾å‘æ“ä½œ

```bash
# è¯ä¹¦ä¿¡æ¯æŸ¥çœ‹

ssh-keygen -L -f ~/.ssh/user_key-cert.pub

# è¾“å‡ºåŒ…å«ï¼š

# - è¯ä¹¦ç±»å‹å’Œåºåˆ—å·

# - æœ‰æ•ˆæœŸ

# - Principalsï¼ˆå…è®¸çš„ç”¨æˆ·åï¼‰

# - ç­¾å‘æœºæ„æŒ‡çº¹

```

---

## 9. ğŸ›¡ï¸ ç»¼åˆå®‰å…¨ç­–ç•¥



### 9.1 åˆ†å±‚é˜²æŠ¤ä½“ç³»



**ğŸ—ï¸ å®Œæ•´å®‰å…¨æ¶æ„**

```
ç¬¬ä¸€å±‚ï¼šç½‘ç»œé˜²æŠ¤
â”œâ”€â”€ é˜²ç«å¢™è§„åˆ™ (iptables/firewall)
â”œâ”€â”€ IPç™½åå•æ§åˆ¶
â”œâ”€â”€ DDoSé˜²æŠ¤
â””â”€â”€ ç½‘ç»œéš”ç¦»

ç¬¬äºŒå±‚ï¼šåº”ç”¨é˜²æŠ¤
â”œâ”€â”€ SSHç«¯å£ä¿®æ”¹
â”œâ”€â”€ åè®®ç‰ˆæœ¬é™åˆ¶  
â”œâ”€â”€ åŠ å¯†ç®—æ³•é€‰æ‹©
â””â”€â”€ è¿æ¥é™åˆ¶

ç¬¬ä¸‰å±‚ï¼šè®¤è¯é˜²æŠ¤
â”œâ”€â”€ ç¦ç”¨å¯†ç è®¤è¯
â”œâ”€â”€ å¯†é’¥è®¤è¯
â”œâ”€â”€ å¤šå› ç´ è®¤è¯
â””â”€â”€ è¯ä¹¦è®¤è¯

ç¬¬å››å±‚ï¼šè¡Œä¸ºé˜²æŠ¤
â”œâ”€â”€ fail2ban
â”œâ”€â”€ æ—¥å¿—ç›‘æ§
â”œâ”€â”€ å¼‚å¸¸æ£€æµ‹
â””â”€â”€ è‡ªåŠ¨å“åº”
```

### 9.2 å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•



**ğŸ“‹ SSHå®‰å…¨é…ç½®æ£€æŸ¥**

- [ ] **åŸºç¡€å®‰å…¨**
  - [ ] ä¿®æ”¹é»˜è®¤ç«¯å£22
  - [ ] ç¦ç”¨rootç›´æ¥ç™»å½•
  - [ ] ç¦ç”¨å¯†ç è®¤è¯
  - [ ] å¯ç”¨å¯†é’¥è®¤è¯

- [ ] **è®¿é—®æ§åˆ¶**  
  - [ ] é…ç½®AllowUsers/AllowGroups
  - [ ] è®¾ç½®IPè®¿é—®é™åˆ¶
  - [ ] å¯ç”¨fail2bané˜²æŠ¤
  - [ ] é…ç½®æ—¶é—´çª—å£é™åˆ¶

- [ ] **é«˜çº§å®‰å…¨**
  - [ ] å¤šå› ç´ è®¤è¯
  - [ ] è¯ä¹¦è®¤è¯æœºåˆ¶
  - [ ] åœ°ç†ä½ç½®è¿‡æ»¤
  - [ ] ä¼šè¯è¶…æ—¶è®¾ç½®

### 9.3 ç›‘æ§å’Œå‘Šè­¦



**ğŸ“Š SSHå®‰å…¨ç›‘æ§**

åˆ›å»ºç›‘æ§è„šæœ¬ï¼š

```bash
#!/bin/bash

# ssh-security-monitor.sh


LOG_FILE="/var/log/auth.log"
ALERT_EMAIL="admin@company.com"

# æ£€æŸ¥å¯ç–‘ç™»å½•

check_suspicious_logins() {
    local today=$(date +%Y-%m-%d)
    local failed_attempts=$(grep "$today" $LOG_FILE | grep "Failed password" | wc -l)
    local success_logins=$(grep "$today" $LOG_FILE | grep "Accepted" | wc -l)
    
    echo "ğŸ“Š ä»Šæ—¥SSHç»Ÿè®¡:"
    echo "  æˆåŠŸç™»å½•: $success_logins æ¬¡"  
    echo "  å¤±è´¥å°è¯•: $failed_attempts æ¬¡"
    
    if [ $failed_attempts -gt 100 ]; then
        echo "âš ï¸ è­¦å‘Šï¼šå¤±è´¥ç™»å½•æ¬¡æ•°å¼‚å¸¸ ($failed_attempts)"
#        # å‘é€å‘Šè­¦é‚®ä»¶
        echo "æ£€æµ‹åˆ°SSHæš´åŠ›ç ´è§£æ”»å‡»ï¼Œå¤±è´¥æ¬¡æ•°: $failed_attempts" | \
            mail -s "SSHå®‰å…¨è­¦å‘Š" $ALERT_EMAIL
    fi
}

# æ£€æŸ¥å¼‚å¸¸IP

check_unusual_ips() {
    echo "ğŸŒ ä»Šæ—¥ç™»å½•IPåˆ†æ:"
    grep "$(date +%Y-%m-%d)" $LOG_FILE | \
        grep "Accepted" | \
        awk '{print $(NF-3)}' | \
        sort | uniq -c | sort -nr | head -10
}

# æ‰§è¡Œç›‘æ§

check_suspicious_logins
check_unusual_ips
```

è®¾ç½®æ¯å°æ—¶æ‰§è¡Œï¼š

```bash
# crontab -e

0 * * * * /path/to/ssh-security-monitor.sh
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ SSHè®¿é—®æ§åˆ¶ï¼šé€šè¿‡å¤šå±‚æœºåˆ¶é™åˆ¶SSHè¿æ¥çš„å®‰å…¨ä½“ç³»
ğŸ”¸ IPè¿‡æ»¤ï¼šç™½åå•å…è®¸å¯ä¿¡IPï¼Œé»‘åå•æ‹’ç»æ¶æ„IP  
ğŸ”¸ fail2banï¼šè‡ªåŠ¨ç›‘æ§æ—¥å¿—å¹¶å°ç¦æš´åŠ›ç ´è§£IP
ğŸ”¸ ç”¨æˆ·ç»„æ§åˆ¶ï¼šåŸºäºç”¨æˆ·å’Œç»„çš„ç²¾ç»†è®¿é—®æƒé™ç®¡ç†
ğŸ”¸ å¤šå› ç´ è®¤è¯ï¼šå¯†é’¥+ä»¤ç‰Œ+ç”Ÿç‰©ç‰¹å¾ç­‰å¤šé‡éªŒè¯
ğŸ”¸ è¯ä¹¦è®¤è¯ï¼šä¸­å¿ƒåŒ–ç®¡ç†çš„å¯æ’¤é”€è®¤è¯æœºåˆ¶
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦å¤šå±‚é˜²æŠ¤**
```
å•ä¸€é˜²æŠ¤çš„è„†å¼±æ€§ï¼š
- å¯†ç å¯èƒ½è¢«ç ´è§£
- å¯†é’¥å¯èƒ½è¢«çªƒå–  
- IPé™åˆ¶å¯èƒ½è¢«ç»•è¿‡

å¤šå±‚é˜²æŠ¤çš„ä¼˜åŠ¿ï¼š
- æ”»å‡»è€…éœ€è¦çªç ´å¤šä¸ªé˜²çº¿
- å•ç‚¹å¤±æ•ˆä¸ä¼šå¯¼è‡´æ•´ä½“æ²¦é™·
- æä¾›å¤šä¸ªæ£€æµ‹å’Œå“åº”æœºä¼š
```

**ğŸ”¹ è®¿é—®æ§åˆ¶çš„å¹³è¡¡åŸåˆ™**
```
å®‰å…¨æ€§ vs ä¾¿åˆ©æ€§ï¼š
- è¿‡ä¸¥æ ¼å½±å“æ­£å¸¸å·¥ä½œæ•ˆç‡
- è¿‡å®½æ¾å­˜åœ¨å®‰å…¨é£é™©
- éœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚å¹³è¡¡

å†…éƒ¨ vs å¤–éƒ¨è®¿é—®ï¼š
- å†…ç½‘å¯ä»¥ç›¸å¯¹å®½æ¾
- å¤–ç½‘å¿…é¡»ä¸¥æ ¼æ§åˆ¶
- ä½¿ç”¨VPNä½œä¸ºä¸­é—´æ–¹æ¡ˆ
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼



**ğŸ¯ ä¸åŒåœºæ™¯çš„åº”ç”¨**
- **ä¼ä¸šç¯å¢ƒ**ï¼šåŸºäºç»„ç»‡æ¶æ„çš„ç”¨æˆ·ç»„ç®¡ç†
- **äº‘æœåŠ¡å™¨**ï¼šIPç™½åå•+è¯ä¹¦è®¤è¯
- **å¼€å‘å›¢é˜Ÿ**ï¼šæ—¶é—´çª—å£+å¤šå› ç´ è®¤è¯
- **ç”Ÿäº§ç³»ç»Ÿ**ï¼šæœ€ä¸¥æ ¼çš„å¤šå±‚é˜²æŠ¤ç­–ç•¥

**ğŸ› ï¸ é…ç½®ä¼˜å…ˆçº§å»ºè®®**
```
å¿…é¡»é…ç½®ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰ï¼š
1. ä¿®æ”¹é»˜è®¤ç«¯å£
2. ç¦ç”¨rootå’Œå¯†ç è®¤è¯  
3. é…ç½®fail2ban
4. è®¾ç½®IPè®¿é—®é™åˆ¶

æ¨èé…ç½®ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰ï¼š
5. ç”¨æˆ·ç»„è®¿é—®æ§åˆ¶
6. æ—¶é—´çª—å£é™åˆ¶
7. å¤šå› ç´ è®¤è¯

é«˜çº§é…ç½®ï¼ˆä½ä¼˜å…ˆçº§ï¼‰ï¼š
8. åœ°ç†ä½ç½®è¿‡æ»¤
9. è¯ä¹¦è®¤è¯ç³»ç»Ÿ
10. é«˜çº§ç›‘æ§å‘Šè­¦
```

### 10.4 å­¦ä¹ æ£€æŸ¥æ¸…å•



**ğŸ“ æŠ€èƒ½æŒæ¡æ£€æŸ¥**
- [ ] èƒ½å¤Ÿé…ç½®åŸºç¡€çš„IPç™½åå•é»‘åå•
- [ ] ä¼šå®‰è£…é…ç½®fail2bané˜²æš´åŠ›ç ´è§£
- [ ] ç†è§£SSHç”¨æˆ·ç»„è®¿é—®æ§åˆ¶æœºåˆ¶
- [ ] æŒæ¡å¤šå› ç´ è®¤è¯çš„é…ç½®æ–¹æ³•
- [ ] äº†è§£SSHè¯ä¹¦è®¤è¯çš„å·¥ä½œåŸç†
- [ ] èƒ½å¤Ÿè®¾è®¡ç»¼åˆå®‰å…¨é˜²æŠ¤ç­–ç•¥

**ğŸª å®æˆ˜ç»ƒä¹ å»ºè®®**
```
åŸºç¡€ç»ƒä¹ ï¼š
1. æ­å»ºæµ‹è¯•ç¯å¢ƒï¼Œé…ç½®IPè®¿é—®æ§åˆ¶
2. å®‰è£…fail2banï¼Œæ¨¡æ‹Ÿæš´åŠ›ç ´è§£æ”»å‡»
3. åˆ›å»ºä¸åŒç”¨æˆ·ç»„ï¼Œæµ‹è¯•è®¿é—®æƒé™

è¿›é˜¶ç»ƒä¹ ï¼š  
4. é…ç½®Google Authenticatorå¤šå› ç´ è®¤è¯
5. å»ºç«‹SSH CAï¼Œç­¾å‘ç”¨æˆ·è¯ä¹¦
6. ç¼–å†™å®‰å…¨ç›‘æ§è„šæœ¬ï¼Œå®ç°å‘Šè­¦åŠŸèƒ½
```

**ğŸ”‘ æ ¸å¿ƒè®°å¿†è¦ç‚¹**
> SSHå®‰å…¨å±‚å±‚é˜²ï¼ŒIPç”¨æˆ·æ—¶é—´ç®¡
> fail2banè‡ªåŠ¨å°ï¼Œè¯ä¹¦è®¤è¯æœ€å®‰å…¨
> ç›‘æ§å‘Šè­¦ä¸å¯å°‘ï¼Œå¹³è¡¡å®‰å…¨ä¸ä¾¿åˆ©

**ğŸ’¡ å»¶ä¼¸å­¦ä¹ æ–¹å‘**
- å­¦ä¹ ç½‘ç»œå…¥ä¾µæ£€æµ‹ç³»ç»Ÿ(IDS/IPS)
- ç ”ç©¶é›¶ä¿¡ä»»ç½‘ç»œå®‰å…¨æ¶æ„  
- äº†è§£SIEMæ—¥å¿—åˆ†æå¹³å°
- æŒæ¡å®¹å™¨åŒ–ç¯å¢ƒçš„SSHå®‰å…¨