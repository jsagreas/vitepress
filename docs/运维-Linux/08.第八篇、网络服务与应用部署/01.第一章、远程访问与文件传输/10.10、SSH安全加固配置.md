---
title: 10、SSH安全加固配置
---
## 📚 目录

1. [SSH安全加固概述](#1-SSH安全加固概述)
2. [核心安全配置项](#2-核心安全配置项)
3. [用户访问控制](#3-用户访问控制)
4. [连接安全策略](#4-连接安全策略)
5. [加密与协议安全](#5-加密与协议安全)
6. [日志与监控配置](#6-日志与监控配置)
7. [实战配置示例](#7-实战配置示例)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔒 SSH安全加固概述


### 1.1 为什么要加固SSH


**🎯 SSH的重要性**
```
SSH = 服务器的"大门钥匙"
• 远程管理Linux服务器的主要途径
• 攻击者的首要目标
• 配置不当 = 给黑客留后门
• 默认配置 ≠ 安全配置
```

> 💡 **核心理解**：SSH就像你家的大门，默认配置就像用简单门锁，加固配置就像安装防盗门+监控+密码锁

### 1.2 常见安全威胁


**⚠️ 主要攻击方式**
- **暴力破解**：尝试各种用户名密码组合
- **字典攻击**：使用常见密码列表
- **SSH扫描**：批量扫描开放SSH的服务器
- **Root直接登录**：获取最高权限
- **弱密码利用**：利用简单密码

**📊 攻击统计**
```
常见攻击目标：
🎯 root用户     (90%的攻击)
🎯 admin用户    (60%的攻击)  
🎯 默认端口22   (95%的扫描)
🎯 密码认证     (80%的暴力破解)
```

---

## 2. ⚙️ 核心安全配置项


### 2.1 禁用root登录配置


**🚫 为什么要禁用root登录**
```
风险分析：
• root = 系统最高权限，无限制
• 攻击者首选目标
• 一旦被破解 = 系统完全沦陷
• 无法追踪具体操作人员
```

**🔧 配置方法**
```bash
# 编辑SSH配置文件
sudo vi /etc/ssh/sshd_config

# 找到并修改以下行
PermitRootLogin no
```

**✅ 最佳实践**
```
替代方案：
1. 创建普通用户账号
2. 配置sudo权限
3. 需要管理权限时使用 sudo 命令
4. 记录所有sudo操作日志
```

### 2.2 密码认证禁用设置


**🔐 密钥认证 vs 密码认证**

| 认证方式 | **安全性** | **便利性** | **暴力破解风险** |
|---------|-----------|-----------|-----------------|
| 🔑 **密钥认证** | `极高` | `高（一次配置）` | `几乎为0` |
| 🔢 **密码认证** | `中等` | `高（记住即可）` | `极高` |

**🔧 禁用密码认证**
```bash
# 在/etc/ssh/sshd_config中配置
PasswordAuthentication no
ChallengeResponseAuthentication no
UsePAM no
```

> ⚠️ **重要提醒**：禁用密码认证前，必须先配置好密钥认证，否则会锁定自己

### 2.3 密钥认证配置流程


**📋 完整配置步骤**

**第一步：生成密钥对**
```bash
# 在客户端生成密钥
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# 密钥文件位置
~/.ssh/id_rsa      # 私钥（绝对保密）
~/.ssh/id_rsa.pub  # 公钥（可以分享）
```

**第二步：上传公钥**
```bash
# 方法1：使用ssh-copy-id（推荐）
ssh-copy-id username@server_ip

# 方法2：手动复制
cat ~/.ssh/id_rsa.pub | ssh username@server_ip "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

**第三步：设置权限**
```bash
# 在服务器端设置正确权限
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
```

---

## 3. 👥 用户访问控制


### 3.1 允许用户与组限制


**🎯 精确控制访问权限**

**允许特定用户**
```bash
# 只允许指定用户登录
AllowUsers alice bob charlie

# 允许用户从特定IP登录
AllowUsers alice@192.168.1.100 bob@192.168.1.*
```

**允许特定用户组**
```bash
# 只允许ssh-users组成员登录
AllowGroups ssh-users admin-group

# 创建专用组
sudo groupadd ssh-users
sudo usermod -aG ssh-users alice
```

**拒绝特定用户**
```bash
# 明确拒绝某些用户
DenyUsers guest anonymous test

# 拒绝某些用户组
DenyGroups disabled-users temp-users
```

### 3.2 用户管理最佳实践


**📊 权限分层策略**
```
管理员层：
🔴 admin-group → 完整sudo权限
使用场景：系统管理、服务维护

开发者层：
🟡 dev-group → 受限sudo权限
使用场景：应用部署、日志查看

普通用户层：
🟢 user-group → 基础权限
使用场景：文件操作、基本命令
```

**🔧 创建分层用户示例**
```bash
# 创建用户组
sudo groupadd admin-ssh
sudo groupadd dev-ssh
sudo groupadd user-ssh

# 创建用户并分配组
sudo useradd -m -G admin-ssh admin1
sudo useradd -m -G dev-ssh dev1
sudo useradd -m -G user-ssh user1

# SSH配置中限制组
AllowGroups admin-ssh dev-ssh user-ssh
```

---

## 4. 🔗 连接安全策略


### 4.1 连接超时与重试限制


**⏰ 超时配置的重要性**
```
问题场景：
• 用户忘记关闭SSH连接
• 网络异常导致僵尸连接
• 恶意用户占用连接资源
• 系统资源被无谓消耗
```

**🔧 超时参数配置**
```bash
# 客户端存活检测间隔（秒）
ClientAliveInterval 300

# 最大无响应次数
ClientAliveCountMax 2

# 实际超时 = 300秒 × 2次 = 10分钟无操作自动断开
```

**🚫 登录重试限制**
```bash
# 每个连接最多尝试次数
MaxAuthTries 3

# 同时未完成认证的连接数
MaxStartups 10:30:60
# 含义：10个连接后开始随机拒绝，30%拒绝率，60个连接后全部拒绝
```

### 4.2 连接数量控制


**📊 连接限制配置**
```bash
# 单个IP最大连接数
MaxSessions 4

# 总的SSH连接数
# 通过iptables配合限制
iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 10 -j REJECT
```

**💡 实际场景应用**
```
小型服务器：MaxSessions 2-4
中型服务器：MaxSessions 8-10  
大型服务器：MaxSessions 20+

考虑因素：
• 管理员数量
• 同时维护需求
• 服务器性能
• 安全风险控制
```

---

## 5. 🔐 加密与协议安全


### 5.1 协议版本限制


**🔢 SSH协议版本对比**

| 协议版本 | **安全性** | **功能** | **推荐度** |
|---------|-----------|---------|-----------|
| **SSH-1** | `很差，已废弃` | `基础功能` | `❌ 禁用` |
| **SSH-2** | `强加密，安全` | `完整功能` | `✅ 推荐` |

**🔧 强制使用SSH-2**
```bash
# 只允许协议版本2
Protocol 2
```

### 5.2 加密算法选择


**🔒 现代化加密配置**

**推荐的加密算法**
```bash
# 密钥交换算法（推荐）
KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512

# 加密算法（推荐）  
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr

# MAC算法（推荐）
MACs hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com,hmac-sha2-256,hmac-sha2-512
```

**⚠️ 禁用弱加密算法**
```bash
# 明确禁用的算法（不安全）
# 3des-cbc, aes128-cbc, aes192-cbc, aes256-cbc
# arcfour, arcfour128, arcfour256
# hmac-md5, hmac-sha1
```

> 💡 **选择原则**：优先选择现代化、经过验证的加密算法，淘汰已知有安全漏洞的老旧算法

### 5.3 主机密钥管理


**🔑 主机密钥类型选择**
```bash
# 生成现代化主机密钥
ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key
ssh-keygen -t ecdsa -b 521 -f /etc/ssh/ssh_host_ecdsa_key  
ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key

# 在sshd_config中指定使用的密钥
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_ecdsa_key
HostKey /etc/ssh/ssh_host_ed25519_key
```

---

## 6. 📊 日志与监控配置


### 6.1 SSH Banner配置


**📢 登录横幅的作用**
```
法律警告：
• 明确告知系统仅供授权用户使用
• 警告非法访问的法律后果
• 为法律追责提供依据

心理威慑：
• 让攻击者知道系统受到监控
• 降低恶意尝试的意愿
```

**🔧 Banner配置方法**
```bash
# 在sshd_config中启用Banner
Banner /etc/ssh/banner.txt

# 创建banner文件
sudo vi /etc/ssh/banner.txt
```

**📝 Banner内容示例**
```
*******************************************************************
*                      警告 WARNING                             *
*******************************************************************
* 本系统仅供授权用户使用                                          *
* This system is for authorized users only                       *
*                                                                 *
* 所有活动将被记录和监控                                          *
* All activities are logged and monitored                        *
*                                                                 *
* 未经授权的访问将被追究法律责任                                   *
* Unauthorized access will be prosecuted                         *
*******************************************************************
```

### 6.2 日志级别设置


**📋 SSH日志级别说明**

| 级别 | **记录内容** | **适用场景** |
|------|-------------|-------------|
| `QUIET` | `几乎不记录` | `不推荐` |
| `FATAL` | `仅致命错误` | `极简环境` |
| `ERROR` | `错误信息` | `基本监控` |
| `INFO` | `基本信息` | `**推荐**` |
| `VERBOSE` | `详细信息` | `调试分析` |
| `DEBUG` | `调试信息` | `问题诊断` |

**🔧 推荐日志配置**
```bash
# 设置合适的日志级别
LogLevel INFO

# 指定日志设施
SyslogFacility AUTHPRIV
```

**📊 日志查看命令**
```bash
# 查看SSH登录日志
sudo tail -f /var/log/secure        # RedHat系
sudo tail -f /var/log/auth.log      # Debian系

# 查看失败登录尝试
sudo grep "Failed password" /var/log/secure

# 查看成功登录
sudo grep "Accepted" /var/log/secure
```

---

## 7. 🛠️ 实战配置示例


### 7.1 生产环境安全配置模板


```bash
# /etc/ssh/sshd_config - 生产环境安全配置

#=== 基础安全设置 ===
Protocol 2
Port 2022                    # 修改默认端口
PermitRootLogin no          # 禁用root登录
PasswordAuthentication no    # 禁用密码认证
ChallengeResponseAuthentication no
UsePAM no

#=== 用户访问控制 ===
AllowGroups ssh-users admin-ssh
MaxAuthTries 3
MaxSessions 4
MaxStartups 10:30:60

#=== 连接管理 ===
ClientAliveInterval 300     # 5分钟检测间隔
ClientAliveCountMax 2       # 最多2次无响应
LoginGraceTime 60          # 登录超时60秒

#=== 加密安全 ===
KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group16-sha512
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes256-ctr
MACs hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com

#=== 功能限制 ===
AllowTcpForwarding no       # 禁用端口转发
X11Forwarding no           # 禁用X11转发
AllowAgentForwarding no    # 禁用SSH代理转发
PermitTunnel no           # 禁用隧道

#=== 日志监控 ===
LogLevel INFO
SyslogFacility AUTHPRIV
Banner /etc/ssh/banner.txt

#=== 主机密钥 ===
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_ecdsa_key
HostKey /etc/ssh/ssh_host_ed25519_key
```

### 7.2 配置应用流程


**📋 安全加固步骤**

**第一步：备份原配置**
```bash
# 备份原始配置
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.$(date +%Y%m%d)
```

**第二步：逐步应用配置**
```bash
# 先配置密钥认证（重要！）
ssh-copy-id your_username@server_ip

# 测试密钥登录正常后再禁用密码认证
# 编辑配置文件
sudo vi /etc/ssh/sshd_config
```

**第三步：验证配置语法**
```bash
# 检查配置文件语法
sudo sshd -t

# 如果有错误，会显示具体行号和问题
```

**第四步：重启服务**
```bash
# 重启SSH服务
sudo systemctl restart sshd

# 检查服务状态
sudo systemctl status sshd
```

> ⚠️ **安全提醒**：配置过程中保持现有SSH连接不要断开，用新窗口测试新配置是否生效

### 7.3 配置验证测试


**🔍 测试检查清单**

**基础连接测试**
```bash
# 测试新端口连接
ssh -p 2022 username@server_ip

# 测试密钥认证
ssh -i ~/.ssh/id_rsa username@server_ip
```

**安全限制测试**
```bash
# 测试root登录是否被拒绝
ssh root@server_ip

# 测试密码认证是否被禁用
ssh -o PreferredAuthentications=password username@server_ip
```

**连接限制测试**
```bash
# 测试多次认证失败
# 故意输错密码多次，观察是否被断开连接

# 测试连接超时
# 建立连接后保持不活动，观察是否自动断开
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的安全要点


```
🔸 **禁用root登录**：root权限过大，禁用后使用sudo
🔸 **密钥认证替代密码**：防暴力破解的最有效方法
🔸 **用户组访问控制**：精确控制谁可以SSH登录
🔸 **连接超时设置**：防止僵尸连接占用资源
🔸 **现代加密算法**：淘汰弱加密，使用强加密
🔸 **日志监控配置**：记录所有访问行为便于审计
🔸 **修改默认端口**：减少自动化攻击扫描
🔸 **Banner警告**：法律威慑和心理威慑作用
```

### 8.2 关键配置理解


**🔹 安全与便利性的平衡**
```
高安全策略：
• 密钥认证 + 禁用密码
• 严格用户组控制
• 短超时时间
• 详细日志记录

适中策略：
• 密钥+密码双重认证
• 部分用户组限制  
• 中等超时时间
• 基本日志记录
```

**🔹 配置优先级**
```
最高优先级：
1. 禁用root登录
2. 配置密钥认证
3. 禁用密码认证

高优先级：
4. 用户访问控制
5. 连接超时限制
6. 修改默认端口

中优先级：
7. 加密算法优化
8. 日志监控配置
```

### 8.3 实际应用指导


**🎯 不同环境的配置策略**

**生产环境**
```
安全要求：★★★★★
• 最严格的安全配置
• 禁用所有不必要功能
• 详细审计日志
• 定期安全检查
```

**开发环境**
```
安全要求：★★★☆☆
• 基础安全配置
• 保留必要便利功能
• 基础日志记录
• 权限适度宽松
```

**个人学习环境**
```
安全要求：★★☆☆☆
• 基本安全措施
• 保持学习便利性
• 简化配置流程
```

**🔧 维护最佳实践**
- **定期检查**：每月检查SSH日志，发现异常登录
- **密钥更新**：每年更新SSH密钥对
- **配置审计**：季度检查配置文件是否被意外修改
- **安全扫描**：使用工具扫描SSH配置安全性

### 8.4 常见问题与解决


**🚨 紧急情况处理**
```
锁定自己怎么办：
1. 通过控制台访问（物理/VNC）
2. 恢复备份配置文件
3. 重启SSH服务
4. 重新配置密钥认证

忘记密钥怎么办：
1. 通过其他已配置的密钥登录
2. 控制台访问重新配置
3. 临时开启密码认证
4. 配置新密钥后再禁用密码
```

**核心记忆口诀**：
```
SSH安全八要素：
禁root改端口，密钥替密码
组控超时限，加密日志好
Banner来警告，测试不可少
```

**核心理解**：
- SSH安全加固是服务器安全的第一道防线
- 配置要循序渐进，避免锁定自己
- 安全性和便利性需要根据环境平衡
- 持续监控和维护比一次性配置更重要