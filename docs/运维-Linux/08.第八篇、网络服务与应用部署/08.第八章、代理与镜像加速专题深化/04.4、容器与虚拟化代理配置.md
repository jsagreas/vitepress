---
title: 4ã€å®¹å™¨ä¸è™šæ‹ŸåŒ–ä»£ç†é…ç½®
---
## ğŸ“š ç›®å½•

1. [Dockerä»£ç†é…ç½®è¯¦è§£](#1-Dockerä»£ç†é…ç½®è¯¦è§£)
2. [Kubernetesé›†ç¾¤ä»£ç†é…ç½®](#2-Kubernetesé›†ç¾¤ä»£ç†é…ç½®)
3. [å®¹å™¨é•œåƒæ„å»ºä»£ç†ä¼˜åŒ–](#3-å®¹å™¨é•œåƒæ„å»ºä»£ç†ä¼˜åŒ–)
4. [ç§æœ‰ä»“åº“ä»£ç†è®¿é—®ç­–ç•¥](#4-ç§æœ‰ä»“åº“ä»£ç†è®¿é—®ç­–ç•¥)
5. [å®¹å™¨ç½‘ç»œä»£ç†è·¯ç”±é…ç½®](#5-å®¹å™¨ç½‘ç»œä»£ç†è·¯ç”±é…ç½®)
6. [è™šæ‹Ÿæœºä»£ç†é…ç½®ä¼ é€’](#6-è™šæ‹Ÿæœºä»£ç†é…ç½®ä¼ é€’)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ³ Dockerä»£ç†é…ç½®è¯¦è§£


### 1.1 Docker Daemonä»£ç†é…ç½®


**ğŸ”¸ ä»€ä¹ˆæ˜¯Docker Daemonä»£ç†**
```
Docker Daemonï¼šDockerçš„åå°æœåŠ¡ç¨‹åº
ä½œç”¨ï¼šè´Ÿè´£ç®¡ç†å®¹å™¨ã€é•œåƒã€ç½‘ç»œç­‰èµ„æº
ä»£ç†éœ€æ±‚ï¼šDaemonéœ€è¦è®¿é—®å¤–ç½‘æ‹‰å–é•œåƒæ—¶ä½¿ç”¨ä»£ç†
```

**ğŸ’¡ Daemonä»£ç†é…ç½®æ–¹æ³•**

> ğŸ“ **é…ç½®è¯´æ˜**  
> Docker Daemonè¿è¡Œæ—¶éœ€è¦ä»Docker Hubç­‰é•œåƒä»“åº“æ‹‰å–é•œåƒï¼Œå¦‚æœæœåŠ¡å™¨åœ¨å†…ç½‘ç¯å¢ƒï¼Œå°±éœ€è¦é…ç½®ä»£ç†æ‰èƒ½è®¿é—®å¤–ç½‘

**æ–¹æ³•ä¸€ï¼šsystemdæœåŠ¡é…ç½®**
```bash
# åˆ›å»ºDockeræœåŠ¡é…ç½®ç›®å½•
sudo mkdir -p /etc/systemd/system/docker.service.d

# åˆ›å»ºä»£ç†é…ç½®æ–‡ä»¶
sudo cat > /etc/systemd/system/docker.service.d/http-proxy.conf << EOF
[Service]
Environment="HTTP_PROXY=http://proxy.company.com:8080"
Environment="HTTPS_PROXY=http://proxy.company.com:8080"
Environment="NO_PROXY=localhost,127.0.0.1,::1,192.168.0.0/16,10.0.0.0/8"
EOF

# é‡æ–°åŠ è½½é…ç½®å¹¶é‡å¯Docker
sudo systemctl daemon-reload
sudo systemctl restart docker
```

**æ–¹æ³•äºŒï¼šdaemon.jsoné…ç½®**
```json
{
  "proxies": {
    "default": {
      "httpProxy": "http://proxy.company.com:8080",
      "httpsProxy": "http://proxy.company.com:8080",
      "noProxy": "localhost,127.0.0.1,*.company.com"
    }
  }
}
```

### 1.2 Dockerå®¢æˆ·ç«¯ä»£ç†è®¾ç½®


**ğŸ”¸ å®¢æˆ·ç«¯ä»£ç†çš„ä½œç”¨**
```
å®¢æˆ·ç«¯ä»£ç†ï¼šå½±å“docker pullã€docker pushç­‰å‘½ä»¤
ä¸Daemonä»£ç†åŒºåˆ«ï¼š
- Daemonä»£ç†ï¼šæœåŠ¡ç«¯æ‹‰å–é•œåƒ
- å®¢æˆ·ç«¯ä»£ç†ï¼šç”¨æˆ·æ‰§è¡Œå‘½ä»¤æ—¶çš„ç½‘ç»œè®¿é—®
```

**é…ç½®æ–¹æ³•**
```bash
# ä¸´æ—¶è®¾ç½®ï¼ˆå½“å‰ä¼šè¯æœ‰æ•ˆï¼‰
export HTTP_PROXY=http://proxy.company.com:8080
export HTTPS_PROXY=http://proxy.company.com:8080
export NO_PROXY=localhost,127.0.0.1,company.com

# æ°¸ä¹…è®¾ç½®ï¼ˆå†™å…¥ç”¨æˆ·é…ç½®æ–‡ä»¶ï¼‰
echo 'export HTTP_PROXY=http://proxy.company.com:8080' >> ~/.bashrc
echo 'export HTTPS_PROXY=http://proxy.company.com:8080' >> ~/.bashrc
source ~/.bashrc
```

**ä»£ç†é…ç½®éªŒè¯**
```bash
# éªŒè¯Docker Daemonä»£ç†æ˜¯å¦ç”Ÿæ•ˆ
docker info | grep -i proxy

# æµ‹è¯•é•œåƒæ‹‰å–
docker pull nginx:latest
```

### 1.3 å®¹å™¨è¿è¡Œæ—¶ä»£ç†ä¼ é€’


**ğŸ¯ è¿è¡Œæ—¶ä»£ç†ä¼ é€’åœºæ™¯**
```
åº”ç”¨åœºæ™¯ï¼š
- å®¹å™¨å†…åº”ç”¨éœ€è¦è®¿é—®å¤–ç½‘API
- å®¹å™¨å†…ä¸‹è½½æ–‡ä»¶æˆ–æ›´æ–°è½¯ä»¶åŒ…
- å¾®æœåŠ¡ä¹‹é—´é€šè¿‡ä»£ç†é€šä¿¡
```

**ä¼ é€’æ–¹æ³•å¯¹æ¯”è¡¨**

| æ–¹æ³• | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|------|------------|---------|---------|
| ç¯å¢ƒå˜é‡ä¼ é€’ | `ä¸´æ—¶è¿è¡Œï¼Œç®€å•åº”ç”¨` | `ç®€å•ç›´æ¥ï¼Œå³æ—¶ç”Ÿæ•ˆ` | `å®¹å™¨é‡å¯å¤±æ•ˆï¼Œå®‰å…¨æ€§å·®` |
| Dockerfileé…ç½® | `é•œåƒæ„å»ºæ—¶å›ºåŒ–` | `æ°¸ä¹…ç”Ÿæ•ˆï¼Œè‡ªåŠ¨åŒ–` | `é•œåƒç»‘å®šä»£ç†ï¼Œä¸å¤Ÿçµæ´»` |
| Docker Compose | `å¤šå®¹å™¨ç¼–æ’` | `é›†ä¸­ç®¡ç†ï¼Œç¯å¢ƒåˆ†ç¦»` | `éœ€è¦é¢å¤–é…ç½®æ–‡ä»¶` |
| ç½‘ç»œä»£ç†å®¹å™¨ | `ä¼ä¸šçº§éƒ¨ç½²` | `å®‰å…¨å¯æ§ï¼Œé›†ä¸­ç®¡ç†` | `æ¶æ„å¤æ‚ï¼Œè¿ç»´æˆæœ¬é«˜` |

**ç¯å¢ƒå˜é‡ä¼ é€’ç¤ºä¾‹**
```bash
# è¿è¡Œæ—¶ä¼ é€’ä»£ç†
docker run -d \
  --name my-app \
  -e HTTP_PROXY=http://proxy.company.com:8080 \
  -e HTTPS_PROXY=http://proxy.company.com:8080 \
  -e NO_PROXY=localhost,127.0.0.1 \
  nginx:latest
```

**Docker Composeé…ç½®**
```yaml
version: '3.8'
services:
  web:
    image: nginx:latest
    environment:
      - HTTP_PROXY=http://proxy.company.com:8080
      - HTTPS_PROXY=http://proxy.company.com:8080
      - NO_PROXY=localhost,127.0.0.1,*.local
    ports:
      - "80:80"
```

---

## 2. â˜¸ï¸ Kubernetesé›†ç¾¤ä»£ç†é…ç½®


### 2.1 Kubernetesä»£ç†é…ç½®å±‚æ¬¡


**ğŸ—ï¸ K8sä»£ç†é…ç½®æ¶æ„å›¾**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Kubernetesé›†ç¾¤              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MasterèŠ‚ç‚¹ä»£ç† â”‚ WorkerèŠ‚ç‚¹ä»£ç†é…ç½®     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   API Server    â”‚   kubeletä»£ç†          â”‚
â”‚   etcdè®¿é—®      â”‚   å®¹å™¨è¿è¡Œæ—¶ä»£ç†       â”‚
â”‚   Controller    â”‚   Podç½‘ç»œä»£ç†          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 MasterèŠ‚ç‚¹ä»£ç†é…ç½®


**ğŸ”§ Masterç»„ä»¶ä»£ç†è®¾ç½®**

> âš ï¸ **é‡è¦æé†’**  
> MasterèŠ‚ç‚¹çš„ä»£ç†é…ç½®å½±å“æ•´ä¸ªé›†ç¾¤çš„è¿è¡Œï¼Œé…ç½®é”™è¯¯å¯èƒ½å¯¼è‡´é›†ç¾¤ä¸å¯ç”¨

**API Serverä»£ç†é…ç½®**
```yaml
# /etc/kubernetes/manifests/kube-apiserver.yaml
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kube-apiserver
    env:
    - name: HTTP_PROXY
      value: "http://proxy.company.com:8080"
    - name: HTTPS_PROXY
      value: "http://proxy.company.com:8080"
    - name: NO_PROXY
      value: "localhost,127.0.0.1,10.0.0.0/8,cluster.local"
```

**Controller Managerä»£ç†**
```bash
# /etc/systemd/system/kubelet.service.d/http-proxy.conf
[Service]
Environment="HTTP_PROXY=http://proxy.company.com:8080"
Environment="HTTPS_PROXY=http://proxy.company.com:8080"
Environment="NO_PROXY=localhost,127.0.0.1,10.96.0.0/16,192.168.0.0/16"
```

### 2.3 WorkerèŠ‚ç‚¹ä»£ç†é…ç½®


**kubeletä»£ç†é…ç½®**
```bash
# ä¿®æ”¹kubeletæœåŠ¡é…ç½®
sudo mkdir -p /etc/systemd/system/kubelet.service.d

# åˆ›å»ºä»£ç†é…ç½®
cat > /etc/systemd/system/kubelet.service.d/http-proxy.conf << EOF
[Service]
Environment="HTTP_PROXY=http://proxy.company.com:8080"
Environment="HTTPS_PROXY=http://proxy.company.com:8080"
Environment="NO_PROXY=localhost,127.0.0.1,10.96.0.0/16"
EOF

# é‡å¯kubelet
sudo systemctl daemon-reload
sudo systemctl restart kubelet
```

**containerdä»£ç†é…ç½®**
```toml
# /etc/systemd/system/containerd.service.d/http-proxy.conf
[Service]
Environment="HTTP_PROXY=http://proxy.company.com:8080"
Environment="HTTPS_PROXY=http://proxy.company.com:8080"
Environment="NO_PROXY=localhost,127.0.0.1,registry.k8s.io"
```

### 2.4 Podçº§åˆ«ä»£ç†é…ç½®


**Podä»£ç†é…ç½®ç¤ºä¾‹**
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: proxy-demo
spec:
  containers:
  - name: app
    image: nginx:latest
    env:
    - name: HTTP_PROXY
      value: "http://proxy.company.com:8080"
    - name: HTTPS_PROXY
      value: "http://proxy.company.com:8080"
    - name: NO_PROXY
      value: "localhost,127.0.0.1,*.cluster.local"
```

**Deploymentçº§åˆ«ä»£ç†**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: web
        image: my-app:latest
        env:
        - name: HTTP_PROXY
          valueFrom:
            configMapKeyRef:
              name: proxy-config
              key: http_proxy
```

---

## 3. ğŸ—ï¸ å®¹å™¨é•œåƒæ„å»ºä»£ç†ä¼˜åŒ–


### 3.1 Dockerfileæ„å»ºæ—¶ä»£ç†é…ç½®


**ğŸ”¸ é•œåƒæ„å»ºä»£ç†çš„é‡è¦æ€§**
```
æ„å»ºè¿‡ç¨‹ç½‘ç»œéœ€æ±‚ï¼š
- ä¸‹è½½åŸºç¡€é•œåƒï¼šéœ€è¦è®¿é—®é•œåƒä»“åº“
- å®‰è£…è½¯ä»¶åŒ…ï¼šéœ€è¦è®¿é—®è½¯ä»¶æº
- ä¸‹è½½åº”ç”¨ä¾èµ–ï¼šéœ€è¦è®¿é—®å¤–éƒ¨èµ„æº
```

**æ„å»ºæ—¶ä»£ç†é…ç½®æ–¹æ³•**

> ğŸ’¡ **æœ€ä½³å®è·µ**  
> ä½¿ç”¨ARGå‚æ•°ä½¿ä»£ç†é…ç½®æ›´çµæ´»ï¼Œé¿å…å°†ä»£ç†ä¿¡æ¯ç¡¬ç¼–ç åˆ°é•œåƒä¸­

**æ–¹æ³•ä¸€ï¼šARGå‚æ•°é…ç½®**
```dockerfile
FROM ubuntu:20.04

# å®šä¹‰ä»£ç†å‚æ•°
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG NO_PROXY

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆæ„å»ºæ—¶ä½¿ç”¨ï¼‰
ENV HTTP_PROXY=${HTTP_PROXY}
ENV HTTPS_PROXY=${HTTPS_PROXY}
ENV NO_PROXY=${NO_PROXY}

# æ›´æ–°è½¯ä»¶åŒ…
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    && rm -rf /var/lib/apt/lists/*

# æ¸…é™¤ä»£ç†ç¯å¢ƒå˜é‡ï¼ˆè¿è¡Œæ—¶ä¸éœ€è¦ï¼‰
ENV HTTP_PROXY=""
ENV HTTPS_PROXY=""
ENV NO_PROXY=""
```

**æ„å»ºå‘½ä»¤**
```bash
# ä½¿ç”¨ä»£ç†æ„å»ºé•œåƒ
docker build \
  --build-arg HTTP_PROXY=http://proxy.company.com:8080 \
  --build-arg HTTPS_PROXY=http://proxy.company.com:8080 \
  --build-arg NO_PROXY=localhost,127.0.0.1 \
  -t my-app:latest .
```

### 3.2 å¤šé˜¶æ®µæ„å»ºä»£ç†ä¼˜åŒ–


**å¤šé˜¶æ®µæ„å»ºä»£ç†ç­–ç•¥**
```dockerfile
# æ„å»ºé˜¶æ®µ - éœ€è¦ä»£ç†
FROM node:16 AS builder
ARG HTTP_PROXY
ARG HTTPS_PROXY
ENV HTTP_PROXY=${HTTP_PROXY}
ENV HTTPS_PROXY=${HTTPS_PROXY}

WORKDIR /app
COPY package*.json ./
RUN npm install

COPY . .
RUN npm run build

# è¿è¡Œé˜¶æ®µ - ä¸éœ€è¦ä»£ç†
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
# è¿è¡Œæ—¶ä¸æºå¸¦ä»£ç†ä¿¡æ¯
```

### 3.3 æ„å»ºç¼“å­˜ä¸ä»£ç†ä¼˜åŒ–


**æ„å»ºç¼“å­˜ä¼˜åŒ–ç­–ç•¥**
```dockerfile
# ä¼˜åŒ–å±‚ç¼“å­˜ï¼Œå‡å°‘ä»£ç†è®¿é—®
FROM python:3.9-slim

ARG HTTP_PROXY
ARG HTTPS_PROXY

# å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼ˆå……åˆ†åˆ©ç”¨ç¼“å­˜ï¼‰
COPY requirements.txt .

# è®¾ç½®ä»£ç†å¹¶å®‰è£…ä¾èµ–
ENV HTTP_PROXY=${HTTP_PROXY}
ENV HTTPS_PROXY=${HTTPS_PROXY}
RUN pip install -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç ï¼ˆä»£ç å˜åŒ–ä¸å½±å“ä¾èµ–ç¼“å­˜ï¼‰
COPY . .

# æ¸…é™¤ä»£ç†è®¾ç½®
ENV HTTP_PROXY=""
ENV HTTPS_PROXY=""
```

---

## 4. ğŸ“¦ ç§æœ‰ä»“åº“ä»£ç†è®¿é—®ç­–ç•¥


### 4.1 ç§æœ‰é•œåƒä»“åº“ä»£ç†é…ç½®


**ğŸ”¸ ç§æœ‰ä»“åº“è®¿é—®åœºæ™¯**
```
ä¼ä¸šç¯å¢ƒå¸¸è§æƒ…å†µï¼š
- å†…ç½‘ç§æœ‰é•œåƒä»“åº“ï¼šharbor, nexusç­‰
- å¤–ç½‘å…¬å…±ä»“åº“ï¼šDocker Hub, é˜¿é‡Œäº‘ç­‰
- æ··åˆè®¿é—®ï¼šéƒ¨åˆ†èµ°ä»£ç†ï¼Œéƒ¨åˆ†ç›´è¿
```

**ä»“åº“è®¿é—®è·¯ç”±å›¾**
```
åº”ç”¨å®¹å™¨
    â”‚
    â”œâ”€â”€â”€ ç§æœ‰ä»“åº“ â”€â”€â”€â”€â†’ ç›´è¿è®¿é—®ï¼ˆå†…ç½‘ï¼‰
    â”‚    harbor.company.com
    â”‚
    â””â”€â”€â”€ å…¬å…±ä»“åº“ â”€â”€â”€â”€â†’ ä»£ç†è®¿é—®ï¼ˆå¤–ç½‘ï¼‰
         docker.io
         gcr.io
```

### 4.2 Dockeré…ç½®ç§æœ‰ä»“åº“ä»£ç†


**daemon.jsoné«˜çº§é…ç½®**
```json
{
  "registry-mirrors": [
    "https://harbor.company.com"
  ],
  "insecure-registries": [
    "harbor.company.com:5000"
  ],
  "proxies": {
    "default": {
      "httpProxy": "http://proxy.company.com:8080",
      "httpsProxy": "http://proxy.company.com:8080",
      "noProxy": "harbor.company.com,*.company.com,localhost"
    }
  }
}
```

**åˆ†ä»“åº“ä»£ç†é…ç½®**
```bash
# ä¸ºä¸åŒä»“åº“é…ç½®ä¸åŒä»£ç†ç­–ç•¥
mkdir -p ~/.docker/config.json

cat > ~/.docker/config.json << EOF
{
  "proxies": {
    "docker.io": {
      "httpProxy": "http://external-proxy.com:8080",
      "httpsProxy": "http://external-proxy.com:8080"
    },
    "gcr.io": {
      "httpProxy": "http://gcr-proxy.com:8080"
    }
  },
  "auths": {
    "harbor.company.com": {
      "auth": "base64-encoded-credentials"
    }
  }
}
EOF
```

### 4.3 Kubernetesç§æœ‰ä»“åº“é…ç½®


**ImagePullSecretsé…ç½®**
```yaml
# åˆ›å»ºç§æœ‰ä»“åº“è®¤è¯Secret
apiVersion: v1
kind: Secret
metadata:
  name: private-registry-secret
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: |
    {
      "auths": {
        "harbor.company.com": {
          "username": "admin",
          "password": "password",
          "auth": "YWRtaW46cGFzc3dvcmQ="
        }
      },
      "proxies": {
        "default": {
          "httpProxy": "http://proxy.company.com:8080"
        }
      }
    }
```

**Podä½¿ç”¨ç§æœ‰ä»“åº“**
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: private-image-pod
spec:
  containers:
  - name: app
    image: harbor.company.com/myproject/app:latest
  imagePullSecrets:
  - name: private-registry-secret
```

---

## 5. ğŸŒ å®¹å™¨ç½‘ç»œä»£ç†è·¯ç”±é…ç½®


### 5.1 å®¹å™¨ç½‘ç»œä»£ç†æ¶æ„


**ğŸ—ï¸ å®¹å™¨ç½‘ç»œä»£ç†å±‚æ¬¡å›¾**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å®¿ä¸»æœºç½‘ç»œå±‚                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  iptablesè§„åˆ™  â”‚  è·¯ç”±è¡¨  â”‚  ä»£ç†æœåŠ¡   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Dockerç½‘ç»œå±‚ï¼ˆbridge/overlayï¼‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®¹å™¨1    â”‚   å®¹å™¨2   â”‚   ä»£ç†å®¹å™¨      â”‚
â”‚  ä¸šåŠ¡åº”ç”¨  â”‚  æ•°æ®åº“   â”‚   Proxy       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ç½‘ç»œä»£ç†è·¯ç”±è§„åˆ™


**iptablesä»£ç†è·¯ç”±é…ç½®**
```bash
# åˆ›å»ºä»£ç†é“¾
iptables -t nat -N DOCKER_PROXY

# é‡å®šå‘HTTPæµé‡åˆ°ä»£ç†
iptables -t nat -A DOCKER_PROXY -p tcp --dport 80 \
  -j REDIRECT --to-port 8080

# é‡å®šå‘HTTPSæµé‡åˆ°ä»£ç†  
iptables -t nat -A DOCKER_PROXY -p tcp --dport 443 \
  -j REDIRECT --to-port 8443

# åº”ç”¨åˆ°Dockerå®¹å™¨
iptables -t nat -A OUTPUT -j DOCKER_PROXY
```

**é€æ˜ä»£ç†å®¹å™¨é…ç½®**
```yaml
# ä»£ç†å®¹å™¨é…ç½®
version: '3.8'
services:
  transparent-proxy:
    image: squid:latest
    container_name: proxy
    ports:
      - "3128:3128"
    volumes:
      - ./squid.conf:/etc/squid/squid.conf
    cap_add:
      - NET_ADMIN
    networks:
      - proxy-network

  web-app:
    image: nginx:latest
    depends_on:
      - transparent-proxy
    environment:
      - HTTP_PROXY=http://transparent-proxy:3128
    networks:
      - proxy-network

networks:
  proxy-network:
    driver: bridge
```

### 5.3 æœåŠ¡ç½‘æ ¼ä»£ç†é…ç½®


**Istio Sidecarä»£ç†é…ç½®**
```yaml
# Service Meshä»£ç†æ³¨å…¥
apiVersion: v1
kind: Pod
metadata:
  name: app-with-sidecar
  annotations:
    sidecar.istio.io/inject: "true"
    traffic.sidecar.istio.io/proxyMetadata: |
      PROXY_CONFIG:
        proxyStatsMatcher:
          inclusionRegexps:
          - ".*circuit_breakers.*"
          - ".*upstream_rq_retry.*"
spec:
  containers:
  - name: app
    image: my-app:latest
    env:
    - name: HTTP_PROXY
      value: "http://127.0.0.1:15001"
```

---

## 6. ğŸ–¥ï¸ è™šæ‹Ÿæœºä»£ç†é…ç½®ä¼ é€’


### 6.1 è™šæ‹ŸåŒ–å¹³å°ä»£ç†é…ç½®


**ğŸ”¸ è™šæ‹Ÿæœºä»£ç†é…ç½®åœºæ™¯**
```
è™šæ‹ŸåŒ–ç¯å¢ƒä»£ç†éœ€æ±‚ï¼š
- VMåˆ›å»ºæ—¶è‡ªåŠ¨é…ç½®ä»£ç†
- VMæ¨¡æ¿ä¸­é¢„ç½®ä»£ç†è®¾ç½®
- åŠ¨æ€ä»£ç†é…ç½®æ¨é€
- æ‰¹é‡VMä»£ç†ç®¡ç†
```

**VMwareè™šæ‹Ÿæœºä»£ç†é…ç½®**

> ğŸ“ **é…ç½®è¯´æ˜**  
> VMwareç¯å¢ƒä¸‹ï¼Œå¯ä»¥é€šè¿‡VMware Toolsæˆ–è€…cloud-initæ¥è‡ªåŠ¨é…ç½®ä»£ç†

```bash
# cloud-inité…ç½®æ–‡ä»¶
cat > /etc/cloud/cloud.cfg.d/proxy.cfg << EOF
#cloud-config
write_files:
  - path: /etc/environment
    content: |
      HTTP_PROXY=http://proxy.company.com:8080
      HTTPS_PROXY=http://proxy.company.com:8080
      NO_PROXY=localhost,127.0.0.1,*.company.com
    permissions: '0644'

runcmd:
  - source /etc/environment
  - echo "Proxy configured"
EOF
```

### 6.2 KVM/QEMUä»£ç†é…ç½®


**libvirtè™šæ‹Ÿæœºä»£ç†ä¼ é€’**
```xml
<!-- VMå®šä¹‰æ–‡ä»¶ä¸­çš„ä»£ç†é…ç½® -->
<domain type='kvm'>
  <name>proxy-vm</name>
  <os>
    <cmdline>
      proxy.http=http://proxy.company.com:8080
      proxy.https=http://proxy.company.com:8080
    </cmdline>
  </os>
</domain>
```

**è„šæœ¬åŒ–ä»£ç†é…ç½®**
```bash
#!/bin/bash
# VMä»£ç†é…ç½®è„šæœ¬

VM_NAME="test-vm"
PROXY_SERVER="http://proxy.company.com:8080"

# é€šè¿‡SSHé…ç½®è™šæ‹Ÿæœºä»£ç†
ssh root@${VM_NAME} << EOF
  # é…ç½®ç³»ç»Ÿä»£ç†
  echo "export HTTP_PROXY=${PROXY_SERVER}" >> /etc/profile
  echo "export HTTPS_PROXY=${PROXY_SERVER}" >> /etc/profile
  
  # é…ç½®Dockerä»£ç†
  mkdir -p /etc/systemd/system/docker.service.d
  cat > /etc/systemd/system/docker.service.d/http-proxy.conf << EOL
[Service]
Environment="HTTP_PROXY=${PROXY_SERVER}"
Environment="HTTPS_PROXY=${PROXY_SERVER}"
EOL

  # é‡å¯æœåŠ¡
  systemctl daemon-reload
  systemctl restart docker
EOF
```

### 6.3 å®¹å™¨åŒ–è™šæ‹Ÿæœºä»£ç†


**KubeVirtè™šæ‹Ÿæœºä»£ç†é…ç½®**
```yaml
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: proxy-vm
spec:
  template:
    spec:
      domain:
        devices:
          disks:
          - name: cloudinit
            disk:
              bus: virtio
      volumes:
      - name: cloudinit
        cloudInitNoCloud:
          userData: |
            #cloud-config
            write_files:
            - path: /etc/environment
              content: |
                HTTP_PROXY=http://proxy.company.com:8080
                HTTPS_PROXY=http://proxy.company.com:8080
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Dockerä»£ç†å±‚æ¬¡ï¼šDaemonä»£ç† vs å®¢æˆ·ç«¯ä»£ç† vs å®¹å™¨è¿è¡Œæ—¶ä»£ç†
ğŸ”¸ K8sä»£ç†é…ç½®ï¼šMasterèŠ‚ç‚¹ã€WorkerèŠ‚ç‚¹ã€Podçº§åˆ«çš„ä¸åŒé…ç½®æ–¹æ³•
ğŸ”¸ é•œåƒæ„å»ºä»£ç†ï¼šARGå‚æ•°ã€å¤šé˜¶æ®µæ„å»ºã€ç¼“å­˜ä¼˜åŒ–ç­–ç•¥
ğŸ”¸ ç§æœ‰ä»“åº“è®¿é—®ï¼šæ··åˆä»£ç†é…ç½®ã€è®¤è¯ä¸ä»£ç†ç»“åˆ
ğŸ”¸ ç½‘ç»œä»£ç†è·¯ç”±ï¼šé€æ˜ä»£ç†ã€æœåŠ¡ç½‘æ ¼ã€æµé‡åŠ«æŒ
ğŸ”¸ è™šæ‹Ÿæœºä»£ç†ä¼ é€’ï¼šcloud-initã€è„šæœ¬åŒ–é…ç½®ã€å®¹å™¨åŒ–VM
```

### 7.2 å…³é”®é…ç½®åŸåˆ™


**ğŸ”¹ ä»£ç†é…ç½®åˆ†å±‚ç®¡ç†**
```
ç³»ç»Ÿçº§ä»£ç† â†’ æœåŠ¡çº§ä»£ç† â†’ åº”ç”¨çº§ä»£ç†
- ç³»ç»Ÿçº§ï¼šå½±å“æ•´ä¸ªä¸»æœºçš„ç½‘ç»œè®¿é—®
- æœåŠ¡çº§ï¼šå½±å“ç‰¹å®šæœåŠ¡ï¼ˆå¦‚Dockerã€K8sï¼‰
- åº”ç”¨çº§ï¼šå½±å“å•ä¸ªå®¹å™¨æˆ–Pod
```

**ğŸ”¹ å®‰å…¨ä¸çµæ´»æ€§å¹³è¡¡**
```
å®‰å…¨è€ƒè™‘ï¼š
- é¿å…åœ¨é•œåƒä¸­ç¡¬ç¼–ç ä»£ç†ä¿¡æ¯
- ä½¿ç”¨ARGå‚æ•°å’Œç¯å¢ƒå˜é‡
- é…ç½®NO_PROXYé¿å…å†…ç½‘æµé‡èµ°ä»£ç†

çµæ´»æ€§è€ƒè™‘ï¼š
- æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€é…ç½®
- ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒä»£ç†
- æ”¯æŒä»£ç†çš„å¯ç”¨/ç¦ç”¨åˆ‡æ¢
```

### 7.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**ğŸ”¹ ä»£ç†é…ç½®ä¸ç”Ÿæ•ˆ**
```
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥ä»£ç†æœåŠ¡æ˜¯å¦å¯è¾¾
2. éªŒè¯NO_PROXYé…ç½®æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤æœåŠ¡é‡å¯ç”Ÿæ•ˆ
4. æ£€æŸ¥é˜²ç«å¢™å’Œç½‘ç»œç­–ç•¥
```

**ğŸ”¹ é•œåƒæ„å»ºç¼“æ…¢**
```
ä¼˜åŒ–ç­–ç•¥ï¼š
- ä½¿ç”¨é•œåƒåŠ é€Ÿå™¨
- åˆç†è®¾è®¡Dockerfileå±‚ç¼“å­˜
- é…ç½®æ„å»ºæ—¶ä»£ç†
- ä½¿ç”¨å¤šé˜¶æ®µæ„å»º
```

**ğŸ”¹ å®¹å™¨ç½‘ç»œè®¿é—®å¼‚å¸¸**
```
è§£å†³æ–¹æ³•ï¼š
- æ£€æŸ¥å®¹å™¨DNSé…ç½®
- éªŒè¯ä»£ç†å®¹å™¨ç½‘ç»œè¿é€šæ€§
- ç¡®è®¤iptablesè§„åˆ™æ­£ç¡®
- æ£€æŸ¥æœåŠ¡å‘ç°é…ç½®
```

### 7.4 æœ€ä½³å®è·µæ€»ç»“


> ğŸ’¡ **æ ¸å¿ƒè®°å¿†**  
> å®¹å™¨ä»£ç†é…ç½®è¦åˆ†å±‚æ€è€ƒï¼šåŸºç¡€è®¾æ–½å±‚ã€å¹³å°å±‚ã€åº”ç”¨å±‚ã€‚æ¯å±‚éƒ½æœ‰ç‹¬ç«‹çš„é…ç½®æ–¹æ³•ï¼Œè¦æ ¹æ®å®é™…åœºæ™¯é€‰æ‹©åˆé€‚çš„é…ç½®ç­–ç•¥

**é…ç½®ä¼˜å…ˆçº§**
```
ç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > é»˜è®¤è®¾ç½®
è¿è¡Œæ—¶é…ç½® > æ„å»ºæ—¶é…ç½®
åº”ç”¨çº§é…ç½® > ç³»ç»Ÿçº§é…ç½®
```

**ç”Ÿäº§ç¯å¢ƒå»ºè®®**
- âœ… ä½¿ç”¨é…ç½®ç®¡ç†å·¥å…·ç»Ÿä¸€ç®¡ç†ä»£ç†é…ç½®
- âœ… å®ç°ä»£ç†é…ç½®çš„ç‰ˆæœ¬æ§åˆ¶å’Œå›æ»š
- âœ… å»ºç«‹ä»£ç†é…ç½®çš„ç›‘æ§å’Œå‘Šè­¦
- âœ… å®šæœŸæ£€æŸ¥å’Œæ›´æ–°ä»£ç†é…ç½®
- âœ… åšå¥½ä»£ç†æ•…éšœçš„å¤‡ç”¨æ–¹æ¡ˆ

**å­¦ä¹ è·¯å¾„å»ºè®®**
1. **åŸºç¡€é˜¶æ®µ**ï¼šæŒæ¡DockeråŸºæœ¬ä»£ç†é…ç½®
2. **è¿›é˜¶é˜¶æ®µ**ï¼šå­¦ä¹ Kubernetesä»£ç†é…ç½®
3. **é«˜çº§é˜¶æ®µ**ï¼šæŒæ¡ç½‘ç»œä»£ç†è·¯ç”±å’ŒæœåŠ¡ç½‘æ ¼
4. **ä¸“å®¶é˜¶æ®µ**ï¼šè®¾è®¡ä¼ä¸šçº§ä»£ç†æ¶æ„æ–¹æ¡ˆ