---
title: 11ã€chrootç”Ÿäº§çŽ¯å¢ƒå®žæ–½
---
## ðŸ“š ç›®å½•

1. [ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²è§„åˆ’](#1-ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²è§„åˆ’)
2. [æ€§èƒ½å½±å“è¯„ä¼°ä¸Žä¼˜åŒ–](#2-æ€§èƒ½å½±å“è¯„ä¼°ä¸Žä¼˜åŒ–)
3. [ç›‘æŽ§å‘Šè­¦ä½“ç³»å»ºè®¾](#3-ç›‘æŽ§å‘Šè­¦ä½“ç³»å»ºè®¾)
4. [å¤‡ä»½æ¢å¤ç­–ç•¥](#4-å¤‡ä»½æ¢å¤ç­–ç•¥)
5. [å®‰å…¨å®¡è®¡ä¸Žåˆè§„](#5-å®‰å…¨å®¡è®¡ä¸Žåˆè§„)
6. [è¿ç»´ç®¡ç†æµç¨‹](#6-è¿ç»´ç®¡ç†æµç¨‹)
7. [åº”æ€¥å¤„ç†é¢„æ¡ˆ](#7-åº”æ€¥å¤„ç†é¢„æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸ—ï¸ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²è§„åˆ’


### 1.1 ä»€ä¹ˆæ˜¯chrootç”Ÿäº§éƒ¨ç½²


**ðŸ’¡ é€šä¿—ç†è§£**ï¼š
chrootç”Ÿäº§éƒ¨ç½²å°±åƒç»™é‡è¦ç¨‹åºå®‰æŽ’"VIPåŒ…é—´"ï¼š
- **çŽ¯å¢ƒéš”ç¦»**ï¼šç¨‹åºåªèƒ½çœ‹åˆ°è‡ªå·±çš„ç›®å½•ç©ºé—´
- **å®‰å…¨é˜²æŠ¤**ï¼šå³ä½¿ç¨‹åºå‡ºé—®é¢˜ä¹Ÿå½±å“ä¸åˆ°ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†
- **èµ„æºç®¡æŽ§**ï¼šå¯ä»¥ç²¾ç¡®æŽ§åˆ¶ç¨‹åºèƒ½ä½¿ç”¨çš„ç³»ç»Ÿèµ„æº
- **æ•…éšœéš”ç¦»**ï¼šä¸€ä¸ªæœåŠ¡æ•…éšœä¸ä¼šæ‹–åž®æ•´ä¸ªç³»ç»Ÿ

```
ç”Ÿäº§çŽ¯å¢ƒç±»æ¯”ï¼š
æ™®é€šéƒ¨ç½² = å¤§é€šé“ºå®¿èˆ
â€¢ æ‰€æœ‰ç¨‹åºå…±äº«åŒä¸€ç©ºé—´
â€¢ ä¸€ä¸ªç¨‹åºå‡ºé—®é¢˜å½±å“å…¨éƒ¨
â€¢ éš¾ä»¥ç®¡ç†å’Œç›‘æŽ§

chrootéƒ¨ç½² = ç‹¬ç«‹å•é—´
â€¢ æ¯ä¸ªç¨‹åºæœ‰è‡ªå·±çš„ç©ºé—´
â€¢ ç›¸äº’éš”ç¦»ï¼Œæ•…éšœä¸ä¼ æ’­
â€¢ ä¾¿äºŽç®¡ç†å’Œå®‰å…¨æŽ§åˆ¶
```

### 1.2 éƒ¨ç½²æž¶æž„è§„åˆ’


**ðŸ¢ åˆ†å±‚æž¶æž„è®¾è®¡**ï¼š
```
ç”Ÿäº§çŽ¯å¢ƒæž¶æž„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          è´Ÿè½½å‡è¡¡å™¨              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    WebæœåŠ¡å™¨å±‚(chrootéš”ç¦»)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚nginx-1  â”‚  â”‚nginx-2  â”‚      â”‚
â”‚  â”‚chroot   â”‚  â”‚chroot   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åº”ç”¨æœåŠ¡å™¨å±‚(chrootéš”ç¦»)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚tomcat-1 â”‚  â”‚node-1   â”‚      â”‚
â”‚  â”‚chroot   â”‚  â”‚chroot   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      æ•°æ®åº“å±‚(ä¼ ç»Ÿéƒ¨ç½²)          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚     â”‚   MySQLä¸»ä»Ž     â”‚        â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ðŸ“Š æœåŠ¡åˆ†ç±»è§„åˆ’**ï¼š

| **æœåŠ¡ç±»åž‹** | **æ˜¯å¦chroot** | **éš”ç¦»çº§åˆ«** | **å…¸åž‹åº”ç”¨** |
|-------------|---------------|-------------|-------------|
| ðŸŒ **WebæœåŠ¡** | å¼ºçƒˆæŽ¨è â­â­â­ | é«˜åº¦éš”ç¦» | nginxã€apache |
| ðŸ”§ **åº”ç”¨æœåŠ¡** | æŽ¨è â­â­ | ä¸­åº¦éš”ç¦» | tomcatã€node.js |
| ðŸ—„ï¸ **æ•°æ®åº“** | è§†æƒ…å†µè€Œå®š â­ | è½»åº¦éš”ç¦» | mysqlã€redis |
| ðŸ“Š **ç›‘æŽ§æœåŠ¡** | ä¸æŽ¨è âŒ | éœ€è¦ç³»ç»Ÿçº§è®¿é—® | prometheusã€zabbix |

### 1.3 éƒ¨ç½²çŽ¯å¢ƒå‡†å¤‡


**ðŸ”¢ éƒ¨ç½²å‡†å¤‡æ­¥éª¤**ï¼š

1ï¸âƒ£ **ç³»ç»ŸçŽ¯å¢ƒæ£€æŸ¥**ï¼š
```bash
# æ£€æŸ¥ç³»ç»Ÿç‰ˆæœ¬å’Œå†…æ ¸
uname -a
cat /etc/os-release

# æ£€æŸ¥å¯ç”¨ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
free -h

# æ£€æŸ¥ç½‘ç»œé…ç½®
ip addr show
```

2ï¸âƒ£ **ç›®å½•ç»“æž„è§„åˆ’**ï¼š
```bash
# åˆ›å»ºchrootæ ¹ç›®å½•ç»“æž„
sudo mkdir -p /opt/chroot/{web,app,shared}

# WebæœåŠ¡chrootçŽ¯å¢ƒ
sudo mkdir -p /opt/chroot/web/{nginx1,nginx2}

# åº”ç”¨æœåŠ¡chrootçŽ¯å¢ƒ  
sudo mkdir -p /opt/chroot/app/{tomcat,nodejs}

# å…±äº«ç›®å½•(æ—¥å¿—ã€é…ç½®ç­‰)
sudo mkdir -p /opt/chroot/shared/{logs,config,backup}
```

3ï¸âƒ£ **åŸºç¡€çŽ¯å¢ƒæž„å»ºè„šæœ¬**ï¼š
```bash
#!/bin/bash
# build_chroot_env.sh - æž„å»ºchrootåŸºç¡€çŽ¯å¢ƒ

CHROOT_DIR="/opt/chroot/web/nginx1"
ARCH=$(uname -m)

# åˆ›å»ºåŸºç¡€ç›®å½•ç»“æž„
create_base_dirs() {
    mkdir -p $CHROOT_DIR/{bin,sbin,lib,lib64,usr,etc,dev,proc,sys,tmp,var}
    mkdir -p $CHROOT_DIR/var/{log,run,tmp}
    chmod 1777 $CHROOT_DIR/tmp
}

# å¤åˆ¶å¿…è¦çš„ç³»ç»Ÿæ–‡ä»¶
copy_system_files() {
    # å¤åˆ¶åŸºç¡€å‘½ä»¤
    cp /bin/bash $CHROOT_DIR/bin/
    cp /bin/ls $CHROOT_DIR/bin/
    cp /bin/cat $CHROOT_DIR/bin/
    
    # å¤åˆ¶åº“æ–‡ä»¶
    ldd /bin/bash | awk '/=>/{print $3}' | xargs -I{} cp {} $CHROOT_DIR/lib64/
    
    # å¤åˆ¶é…ç½®æ–‡ä»¶
    cp /etc/passwd $CHROOT_DIR/etc/
    cp /etc/group $CHROOT_DIR/etc/
    cp /etc/resolv.conf $CHROOT_DIR/etc/
}

create_base_dirs
copy_system_files
echo "chrootçŽ¯å¢ƒæž„å»ºå®Œæˆï¼š$CHROOT_DIR"
```

---

## 2. âš¡ æ€§èƒ½å½±å“è¯„ä¼°ä¸Žä¼˜åŒ–


### 2.1 æ€§èƒ½å½±å“åˆ†æž


**ðŸ’¡ é€šä¿—ç†è§£**ï¼š
chrootå¯¹æ€§èƒ½çš„å½±å“å°±åƒ"æˆ¿é—´éš”å¢™"ï¼š
- **å¥½å¤„**ï¼šæ¯ä¸ªæˆ¿é—´ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°
- **ä»£ä»·**ï¼šéœ€è¦ä¸ºæ¯ä¸ªæˆ¿é—´å‡†å¤‡ç‹¬ç«‹çš„è®¾æ–½
- **å…³é”®**ï¼šåˆç†è§„åˆ’é¿å…èµ„æºæµªè´¹

**ðŸ“Š æ€§èƒ½å½±å“å¯¹æ¯”è¡¨**ï¼š

| **æ€§èƒ½æŒ‡æ ‡** | **æ— chroot** | **æœ‰chroot** | **å½±å“ç¨‹åº¦** |
|-------------|-------------|-------------|-------------|
| **å†…å­˜å ç”¨** | åŸºå‡†å€¼ 100% | 110-130% | è½»åº¦å½±å“ ðŸŸ¡ |
| **å¯åŠ¨æ—¶é—´** | åŸºå‡†å€¼ 100% | 105-115% | è½»åº¦å½±å“ ðŸŸ¡ |
| **æ–‡ä»¶è®¿é—®** | åŸºå‡†å€¼ 100% | 100-105% | å‡ ä¹Žæ— å½±å“ ðŸŸ¢ |
| **ç½‘ç»œæ€§èƒ½** | åŸºå‡†å€¼ 100% | 100% | æ— å½±å“ ðŸŸ¢ |
| **CPUä½¿ç”¨** | åŸºå‡†å€¼ 100% | 100-102% | å‡ ä¹Žæ— å½±å“ ðŸŸ¢ |

### 2.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ðŸ”¢ ä¼˜åŒ–æ ¸å¿ƒåŽŸåˆ™**ï¼š

1ï¸âƒ£ **å…±äº«èµ„æºä¼˜åŒ–**ï¼š
```bash
# ä½¿ç”¨ç»‘å®šæŒ‚è½½å‡å°‘æ–‡ä»¶å¤åˆ¶
mount --bind /usr/lib64 /opt/chroot/web/nginx1/lib64
mount --bind /usr/bin /opt/chroot/web/nginx1/bin

# å…±äº«åªè¯»ç³»ç»Ÿæ–‡ä»¶
mount --bind -o ro /etc/ssl /opt/chroot/web/nginx1/etc/ssl
```

2ï¸âƒ£ **å†…å­˜ä½¿ç”¨ä¼˜åŒ–**ï¼š
```bash
# ç›‘æŽ§chrootçŽ¯å¢ƒå†…å­˜ä½¿ç”¨
ps aux | grep nginx
pmap -x $(pgrep nginx)

# ä¼˜åŒ–nginxé…ç½®å‡å°‘å†…å­˜å ç”¨
worker_processes auto;
worker_connections 1024;
worker_rlimit_nofile 2048;
```

3ï¸âƒ£ **ç£ç›˜I/Oä¼˜åŒ–**ï¼š
```bash
# ä½¿ç”¨tmpfsåŠ é€Ÿä¸´æ—¶æ–‡ä»¶è®¿é—®
mount -t tmpfs -o size=100M tmpfs /opt/chroot/web/nginx1/tmp
mount -t tmpfs -o size=50M tmpfs /opt/chroot/web/nginx1/var/run
```

### 2.3 æ€§èƒ½ç›‘æŽ§æŒ‡æ ‡


**ðŸ“Š å…³é”®ç›‘æŽ§æŒ‡æ ‡**ï¼š
```bash
#!/bin/bash
# chroot_performance_monitor.sh

CHROOT_DIR="/opt/chroot/web/nginx1"

# ç›‘æŽ§chrootçŽ¯å¢ƒèµ„æºä½¿ç”¨
monitor_resources() {
    echo "=== chrootçŽ¯å¢ƒèµ„æºä½¿ç”¨æƒ…å†µ ==="
    
    # CPUä½¿ç”¨çŽ‡
    ps -eo pid,ppid,cmd,%mem,%cpu | grep $CHROOT_DIR
    
    # å†…å­˜ä½¿ç”¨è¯¦æƒ…
    pmap -x $(pgrep -f $CHROOT_DIR) | tail -1
    
    # ç£ç›˜ä½¿ç”¨æƒ…å†µ
    du -sh $CHROOT_DIR
    
    # æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨
    lsof | grep $CHROOT_DIR | wc -l
}

monitor_resources
```

---

## 3. ðŸ“Š ç›‘æŽ§å‘Šè­¦ä½“ç³»å»ºè®¾


### 3.1 ç›‘æŽ§ä½“ç³»æž¶æž„


**ðŸ’¡ é€šä¿—ç†è§£**ï¼š
ç›‘æŽ§chrootçŽ¯å¢ƒå°±åƒç»™æ¯ä¸ª"åŒ…é—´"å®‰è£…ç›‘æŽ§æ‘„åƒå¤´ï¼š
- **å®žæ—¶ç›‘æŽ§**ï¼šéšæ—¶çŸ¥é“æœåŠ¡è¿è¡ŒçŠ¶æ€
- **å¼‚å¸¸å‘Šè­¦**ï¼šå‡ºé—®é¢˜ç¬¬ä¸€æ—¶é—´é€šçŸ¥
- **æ•°æ®æ”¶é›†**ï¼šä¸ºä¼˜åŒ–å†³ç­–æä¾›æ•°æ®æ”¯æŒ

```
ç›‘æŽ§æž¶æž„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   chrootçŽ¯å¢ƒ    â”‚â”€â”€â”€â–¶â”‚    ç›‘æŽ§ä»£ç†     â”‚â”€â”€â”€â–¶â”‚   ç›‘æŽ§ä¸­å¿ƒ      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   nginx   â”‚  â”‚    â”‚  â”‚   agent   â”‚  â”‚    â”‚  â”‚Prometheus â”‚  â”‚
â”‚  â”‚   è¿›ç¨‹    â”‚  â”‚    â”‚  â”‚   æ”¶é›†    â”‚  â”‚    â”‚  â”‚  Grafana  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒç›‘æŽ§æŒ‡æ ‡é…ç½®


**ðŸ“Š Prometheusé…ç½®ç¤ºä¾‹**ï¼š
```yaml
# prometheus-chroot.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'chroot-nginx'
    static_configs:
      - targets: ['localhost:8080']
    relabel_configs:
      - source_labels: [__address__]
        target_label: chroot_env
        replacement: 'nginx-chroot'

  - job_name: 'chroot-system'
    static_configs:
      - targets: ['localhost:9100']
    metrics_path: /metrics
    params:
      'module': ['chroot_metrics']
```

**ðŸ”§ è‡ªå®šä¹‰ç›‘æŽ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# chroot_metrics_collector.sh

CHROOT_ENV="/opt/chroot/web/nginx1"
METRICS_FILE="/var/lib/prometheus/chroot_metrics.prom"

collect_chroot_metrics() {
    # chrootè¿›ç¨‹æ•°é‡
    PROCESS_COUNT=$(ps aux | grep -c $CHROOT_ENV)
    echo "chroot_process_count{env=\"nginx1\"} $PROCESS_COUNT" > $METRICS_FILE
    
    # chrootå†…å­˜ä½¿ç”¨(MB)
    MEMORY_USAGE=$(ps -eo pid,cmd,rss | grep $CHROOT_ENV | awk '{sum+=$3}END{print sum/1024}')
    echo "chroot_memory_usage_mb{env=\"nginx1\"} $MEMORY_USAGE" >> $METRICS_FILE
    
    # chrootç£ç›˜ä½¿ç”¨(GB)
    DISK_USAGE=$(du -s $CHROOT_ENV | awk '{print $1/1024/1024}')
    echo "chroot_disk_usage_gb{env=\"nginx1\"} $DISK_USAGE" >> $METRICS_FILE
    
    # æœåŠ¡å“åº”çŠ¶æ€
    HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health || echo "000")
    echo "chroot_service_status{env=\"nginx1\"} $HTTP_STATUS" >> $METRICS_FILE
}

collect_chroot_metrics
```

### 3.3 å‘Šè­¦è§„åˆ™é…ç½®


**âš ï¸ å…³é”®å‘Šè­¦è§„åˆ™**ï¼š
```yaml
# alerting-rules.yml
groups:
  - name: chroot-alerts
    rules:
      - alert: ChrootServiceDown
        expr: chroot_service_status != 200
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "chrootæœåŠ¡å¼‚å¸¸"
          description: "{{ $labels.env }} çŽ¯å¢ƒæœåŠ¡å“åº”å¼‚å¸¸"

      - alert: ChrootHighMemoryUsage
        expr: chroot_memory_usage_mb > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "chrootå†…å­˜ä½¿ç”¨è¿‡é«˜"
          description: "{{ $labels.env }} å†…å­˜ä½¿ç”¨è¶…è¿‡1GB"

      - alert: ChrootDiskSpaceLow
        expr: chroot_disk_usage_gb > 5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "chrootç£ç›˜ç©ºé—´ä¸è¶³"
          description: "{{ $labels.env }} ç£ç›˜ä½¿ç”¨è¶…è¿‡5GB"
```

---

## 4. ðŸ’¾ å¤‡ä»½æ¢å¤ç­–ç•¥


### 4.1 å¤‡ä»½ç­–ç•¥è®¾è®¡


**ðŸ’¡ é€šä¿—ç†è§£**ï¼š
chrootçŽ¯å¢ƒå¤‡ä»½å°±åƒç»™"åŒ…é—´"æ‹ç…§å­˜æ¡£ï¼š
- **é…ç½®å¤‡ä»½**ï¼šè®°å½•æˆ¿é—´å¸ƒå±€(é…ç½®æ–‡ä»¶)
- **æ•°æ®å¤‡ä»½**ï¼šä¿å­˜é‡è¦ç‰©å“(åº”ç”¨æ•°æ®)
- **çŽ¯å¢ƒå¤‡ä»½**ï¼šæ•´ä¸ªæˆ¿é—´å¿«ç…§(å®Œæ•´é•œåƒ)

**ðŸ”¢ åˆ†å±‚å¤‡ä»½ç­–ç•¥**ï¼š

1ï¸âƒ£ **é…ç½®æ–‡ä»¶å¤‡ä»½**ï¼š
```bash
#!/bin/bash
# backup_chroot_config.sh

CHROOT_DIR="/opt/chroot/web/nginx1"
BACKUP_DIR="/backup/chroot/config/$(date +%Y%m%d)"

backup_configs() {
    mkdir -p $BACKUP_DIR
    
    # å¤‡ä»½nginxé…ç½®
    cp -r $CHROOT_DIR/etc/nginx $BACKUP_DIR/
    
    # å¤‡ä»½ç³»ç»Ÿé…ç½®æ–‡ä»¶
    cp $CHROOT_DIR/etc/{passwd,group,hosts} $BACKUP_DIR/
    
    # åˆ›å»ºé…ç½®æ¸…å•
    find $CHROOT_DIR -name "*.conf" -o -name "*.cfg" | \
        xargs md5sum > $BACKUP_DIR/config_checksums.txt
    
    echo "é…ç½®æ–‡ä»¶å¤‡ä»½å®Œæˆï¼š$BACKUP_DIR"
}

backup_configs
```

2ï¸âƒ£ **æ•°æ®åŒæ­¥å¤‡ä»½**ï¼š
```bash
#!/bin/bash
# sync_chroot_data.sh

SOURCE_DIR="/opt/chroot/web/nginx1"
BACKUP_DIR="/backup/chroot/data"
REMOTE_HOST="backup-server"

# ä½¿ç”¨rsyncè¿›è¡Œå¢žé‡å¤‡ä»½
rsync -avz --delete \
    --exclude='proc/*' \
    --exclude='sys/*' \
    --exclude='dev/*' \
    --exclude='tmp/*' \
    $SOURCE_DIR/ $REMOTE_HOST:$BACKUP_DIR/nginx1/

# æœ¬åœ°å¿«ç…§å¤‡ä»½
tar -czf /backup/chroot/snapshots/nginx1-$(date +%Y%m%d-%H%M).tar.gz \
    -C /opt/chroot/web nginx1
```

### 4.2 æ¢å¤æµç¨‹è®¾è®¡


**ðŸ”§ æ ‡å‡†æ¢å¤æµç¨‹**ï¼š

```bash
#!/bin/bash
# restore_chroot_env.sh

BACKUP_DIR="/backup/chroot"
RESTORE_DIR="/opt/chroot/web"
ENV_NAME="nginx1"

restore_environment() {
    echo "å¼€å§‹æ¢å¤chrootçŽ¯å¢ƒï¼š$ENV_NAME"
    
    # 1. åœæ­¢æœåŠ¡
    systemctl stop nginx-chroot
    
    # 2. å¤‡ä»½å½“å‰çŽ¯å¢ƒ
    mv $RESTORE_DIR/$ENV_NAME $RESTORE_DIR/${ENV_NAME}.backup.$(date +%Y%m%d)
    
    # 3. æ¢å¤çŽ¯å¢ƒæ–‡ä»¶
    tar -xzf $BACKUP_DIR/snapshots/${ENV_NAME}-latest.tar.gz -C $RESTORE_DIR/
    
    # 4. æ¢å¤é…ç½®æƒé™
    chown -R nginx:nginx $RESTORE_DIR/$ENV_NAME
    chmod -R 755 $RESTORE_DIR/$ENV_NAME
    
    # 5. é‡å»ºå¿…è¦çš„æŒ‚è½½ç‚¹
    mount --bind /proc $RESTORE_DIR/$ENV_NAME/proc
    mount --bind /sys $RESTORE_DIR/$ENV_NAME/sys
    mount --bind /dev $RESTORE_DIR/$ENV_NAME/dev
    
    # 6. å¯åŠ¨æœåŠ¡
    systemctl start nginx-chroot
    
    echo "æ¢å¤å®Œæˆï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€"
}

restore_environment
```

### 4.3 å¤‡ä»½ç­–ç•¥é…ç½®


**ðŸ“… å¤‡ä»½è®¡åˆ’è¡¨**ï¼š

| **å¤‡ä»½ç±»åž‹** | **é¢‘çŽ‡** | **ä¿ç•™æœŸ** | **å­˜å‚¨ä½ç½®** |
|-------------|----------|-----------|-------------|
| ðŸ“„ **é…ç½®æ–‡ä»¶** | æ¯æ—¥ | 30å¤© | æœ¬åœ°+è¿œç¨‹ |
| ðŸ’½ **å¢žé‡æ•°æ®** | æ¯4å°æ—¶ | 7å¤© | è¿œç¨‹å­˜å‚¨ |
| ðŸ“¦ **å®Œæ•´å¿«ç…§** | æ¯å‘¨ | 4å‘¨ | æœ¬åœ°+äº‘å­˜å‚¨ |
| ðŸ”„ **å½’æ¡£å¤‡ä»½** | æ¯æœˆ | 12ä¸ªæœˆ | å†·å­˜å‚¨ |

```bash
# crontabé…ç½®ç¤ºä¾‹
# æ¯æ—¥é…ç½®å¤‡ä»½
0 2 * * * /scripts/backup_chroot_config.sh

# æ¯4å°æ—¶å¢žé‡å¤‡ä»½  
0 */4 * * * /scripts/sync_chroot_data.sh

# æ¯å‘¨å®Œæ•´å¿«ç…§
0 1 * * 0 /scripts/full_chroot_backup.sh

# æ¯æœˆå½’æ¡£å¤‡ä»½
0 0 1 * * /scripts/archive_chroot_backup.sh
```

---

## 5. ðŸ”’ å®‰å…¨å®¡è®¡ä¸Žåˆè§„


### 5.1 å®‰å…¨å®¡è®¡ä½“ç³»


**ðŸ’¡ é€šä¿—ç†è§£**ï¼š
å®‰å…¨å®¡è®¡å°±åƒç»™"åŒ…é—´"å®‰è£…å®‰æ£€è®¾å¤‡ï¼š
- **è®¿é—®è®°å½•**ï¼šè°è¿›è¿‡æˆ¿é—´ï¼Œåšäº†ä»€ä¹ˆ
- **æƒé™æ£€æŸ¥**ï¼šç¡®ä¿åªæœ‰æŽˆæƒäººå‘˜èƒ½è¿›å…¥
- **å¼‚å¸¸ç›‘æµ‹**ï¼šå‘çŽ°å¯ç–‘æ´»åŠ¨ç«‹å³æŠ¥å‘Š

```
å®‰å…¨å®¡è®¡æž¶æž„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   chrootçŽ¯å¢ƒ    â”‚â”€â”€â”€â–¶â”‚   å®¡è®¡æ—¥å¿—      â”‚â”€â”€â”€â–¶â”‚   åˆ†æžæŠ¥å‘Š      â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚   è®¿é—®è®°å½•  â”‚ â”‚    â”‚ â”‚  auditd     â”‚ â”‚    â”‚ â”‚ è¿è§„ç»Ÿè®¡    â”‚ â”‚
â”‚ â”‚   æ“ä½œæ—¥å¿—  â”‚ â”‚    â”‚ â”‚  syslog     â”‚ â”‚    â”‚ â”‚ é£Žé™©è¯„ä¼°    â”‚ â”‚
â”‚ â”‚   æƒé™å˜æ›´  â”‚ â”‚    â”‚ â”‚  è‡ªå®šä¹‰log  â”‚ â”‚    â”‚ â”‚ åˆè§„æŠ¥å‘Š    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å®¡è®¡æ—¥å¿—é…ç½®


**ðŸ”§ auditdå®¡è®¡è§„åˆ™**ï¼š
```bash
# /etc/audit/rules.d/chroot.rules

# ç›‘æŽ§chrootç›®å½•è®¿é—®
-w /opt/chroot -p wa -k chroot_access

# ç›‘æŽ§chrootå‘½ä»¤æ‰§è¡Œ
-a always,exit -F arch=b64 -S execve -F path=/usr/sbin/chroot -k chroot_exec

# ç›‘æŽ§æ–‡ä»¶æƒé™å˜æ›´
-w /opt/chroot -p a -k chroot_permission

# ç›‘æŽ§ç½‘ç»œè¿žæŽ¥
-a always,exit -F arch=b64 -S socket -F a0=2 -k chroot_network

# ç›‘æŽ§ç³»ç»Ÿè°ƒç”¨
-a always,exit -F arch=b64 -S mount -S umount2 -k chroot_mount
```

**ðŸ“Š æ—¥å¿—åˆ†æžè„šæœ¬**ï¼š
```bash
#!/bin/bash
# chroot_audit_analysis.sh

AUDIT_LOG="/var/log/audit/audit.log"
REPORT_DIR="/var/log/chroot-audit"
DATE=$(date +%Y%m%d)

analyze_chroot_activities() {
    mkdir -p $REPORT_DIR
    
    echo "=== chrootå®‰å…¨å®¡è®¡æŠ¥å‘Š $(date) ===" > $REPORT_DIR/report_$DATE.txt
    
    # ç»Ÿè®¡è®¿é—®é¢‘æ¬¡
    echo "è®¿é—®é¢‘æ¬¡ç»Ÿè®¡ï¼š" >> $REPORT_DIR/report_$DATE.txt
    grep "chroot_access" $AUDIT_LOG | \
        awk '{print $5}' | sort | uniq -c | \
        sort -nr >> $REPORT_DIR/report_$DATE.txt
    
    # æ£€æŸ¥å¼‚å¸¸æ“ä½œ
    echo -e "\nå¼‚å¸¸æ“ä½œæ£€æµ‹ï¼š" >> $REPORT_DIR/report_$DATE.txt
    grep -E "(DENIED|FAILED)" $AUDIT_LOG | \
        grep chroot >> $REPORT_DIR/report_$DATE.txt
    
    # æƒé™å˜æ›´è®°å½•
    echo -e "\næƒé™å˜æ›´è®°å½•ï¼š" >> $REPORT_DIR/report_$DATE.txt
    grep "chroot_permission" $AUDIT_LOG | \
        tail -20 >> $REPORT_DIR/report_$DATE.txt
}

analyze_chroot_activities
```

### 5.3 åˆè§„æ€§è¦æ±‚å®žæ–½


**ðŸ“‹ åˆè§„æ£€æŸ¥æ¸…å•**ï¼š

| **åˆè§„é¡¹ç›®** | **æ£€æŸ¥å†…å®¹** | **å®žæ–½çŠ¶æ€** | **è´Ÿè´£äºº** |
|-------------|-------------|-------------|-----------|
| ðŸ” **è®¿é—®æŽ§åˆ¶** | ç”¨æˆ·æƒé™æœ€å°åŒ– | âœ… å·²å®žæ–½ | å®‰å…¨ç®¡ç†å‘˜ |
| ðŸ“ **æ—¥å¿—è®°å½•** | å®Œæ•´æ“ä½œæ—¥å¿— | âœ… å·²å®žæ–½ | è¿ç»´å·¥ç¨‹å¸ˆ |
| ðŸ”„ **å®šæœŸå®¡æ ¸** | æœˆåº¦å®‰å…¨æ£€æŸ¥ | ðŸ”„ æ‰§è¡Œä¸­ | å®‰å…¨å›¢é˜Ÿ |
| ðŸ“Š **åˆè§„æŠ¥å‘Š** | å­£åº¦åˆè§„æŠ¥å‘Š | ðŸ“… è®¡åˆ’ä¸­ | åˆè§„ä¸“å‘˜ |

**ðŸ›¡ï¸ å®‰å…¨åŠ å›ºæŽªæ–½**ï¼š
```bash
#!/bin/bash
# chroot_security_hardening.sh

CHROOT_DIR="/opt/chroot/web/nginx1"

security_hardening() {
    # 1. è®¾ç½®ä¸¥æ ¼çš„æ–‡ä»¶æƒé™
    chmod 750 $CHROOT_DIR
    chown root:nginx $CHROOT_DIR
    
    # 2. ç¦ç”¨ä¸å¿…è¦çš„SUIDç¨‹åº
    find $CHROOT_DIR -type f -perm -4000 -delete
    
    # 3. åˆ›å»ºä¸“ç”¨ç”¨æˆ·å’Œç»„
    useradd -r -s /sbin/nologin -d $CHROOT_DIR nginx-chroot
    
    # 4. è®¾ç½®èµ„æºé™åˆ¶
    cat >> /etc/security/limits.d/nginx-chroot.conf << EOF
nginx-chroot soft nproc 100
nginx-chroot hard nproc 200
nginx-chroot soft nofile 1024
nginx-chroot hard nofile 2048
EOF
    
    # 5. é…ç½®SELinuxç­–ç•¥(å¦‚æžœå¯ç”¨)
    if getenforce | grep -q Enforcing; then
        setsebool -P httpd_enable_cgi on
        semanage fcontext -a -t httpd_t "$CHROOT_DIR(/.*)?"
        restorecon -R $CHROOT_DIR
    fi
    
    echo "å®‰å…¨åŠ å›ºå®Œæˆ"
}

security_hardening
```

---

## 6. ðŸ”„ è¿ç»´ç®¡ç†æµç¨‹


### 6.1 æ ‡å‡†è¿ç»´æµç¨‹


**ðŸ’¡ é€šä¿—ç†è§£**ï¼š
è¿ç»´ç®¡ç†æµç¨‹å°±åƒé…’åº—çš„"æœåŠ¡æ ‡å‡†"ï¼š
- **æ—¥å¸¸å·¡æ£€**ï¼šæ¯å¤©æ£€æŸ¥æˆ¿é—´çŠ¶æ€
- **é—®é¢˜å¤„ç†**ï¼šå‘çŽ°é—®é¢˜åŠæ—¶è§£å†³
- **å®šæœŸç»´æŠ¤**ï¼šå®šæœŸå‡çº§å’Œä¼˜åŒ–
- **åº”æ€¥å“åº”**ï¼šç´§æ€¥æƒ…å†µå¿«é€Ÿå¤„ç†

**ðŸ”¢ è¿ç»´æµç¨‹å›¾**ï¼š
```
æ—¥å¸¸è¿ç»´æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç›‘æŽ§å‘Šè­¦  â”‚â”€â”€â”€â–¶â”‚   é—®é¢˜åˆ†æž  â”‚â”€â”€â”€â–¶â”‚   å¤„ç†æ–¹æ¡ˆ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                    â”‚
         â–¼                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ—¥å¸¸å·¡æ£€  â”‚    â”‚   æ‰§è¡Œå¤„ç†  â”‚    â”‚   æ•ˆæžœéªŒè¯  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                 â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   è®°å½•å½’æ¡£  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬


**ðŸ”§ æ—¥å¸¸å·¡æ£€è„šæœ¬**ï¼š
```bash
#!/bin/bash
# chroot_daily_check.sh

CHROOT_ENVS=("/opt/chroot/web/nginx1" "/opt/chroot/app/tomcat")
LOG_FILE="/var/log/chroot-check.log"

daily_check() {
    echo "=== chrootçŽ¯å¢ƒæ—¥å¸¸æ£€æŸ¥ $(date) ===" >> $LOG_FILE
    
    for env in "${CHROOT_ENVS[@]}"; do
        echo "æ£€æŸ¥çŽ¯å¢ƒï¼š$env" >> $LOG_FILE
        
        # 1. æ£€æŸ¥æŒ‚è½½ç‚¹
        if ! mountpoint -q $env/proc; then
            echo "è­¦å‘Šï¼š$env/proc æœªæŒ‚è½½" >> $LOG_FILE
            mount --bind /proc $env/proc
        fi
        
        # 2. æ£€æŸ¥ç£ç›˜ç©ºé—´
        DISK_USAGE=$(df $env | tail -1 | awk '{print $5}' | sed 's/%//')
        if [ $DISK_USAGE -gt 80 ]; then
            echo "è­¦å‘Šï¼š$env ç£ç›˜ä½¿ç”¨çŽ‡ ${DISK_USAGE}%" >> $LOG_FILE
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            find $env/tmp -type f -mtime +7 -delete
        fi
        
        # 3. æ£€æŸ¥æœåŠ¡çŠ¶æ€
        if pgrep -f $env > /dev/null; then
            echo "æ­£å¸¸ï¼š$env æœåŠ¡è¿è¡Œä¸­" >> $LOG_FILE
        else
            echo "å¼‚å¸¸ï¼š$env æœåŠ¡æœªè¿è¡Œ" >> $LOG_FILE
        fi
        
        # 4. æ£€æŸ¥æ—¥å¿—é”™è¯¯
        ERROR_COUNT=$(grep -c ERROR $env/var/log/*.log 2>/dev/null || echo 0)
        echo "é”™è¯¯æ—¥å¿—æ•°é‡ï¼š$ERROR_COUNT" >> $LOG_FILE
        
        echo "---" >> $LOG_FILE
    done
}

daily_check
```

### 6.3 ç»´æŠ¤çª—å£ç®¡ç†


**ðŸ“… ç»´æŠ¤è®¡åˆ’ç®¡ç†**ï¼š
```bash
#!/bin/bash
# maintenance_window.sh

MAINTENANCE_CONFIG="/etc/chroot-maintenance.conf"

# ç»´æŠ¤çª—å£é…ç½®
WINDOW_START="02:00"
WINDOW_END="04:00"
MAINTENANCE_DAY="Sunday"

check_maintenance_window() {
    CURRENT_TIME=$(date +%H:%M)
    CURRENT_DAY=$(date +%A)
    
    if [[ "$CURRENT_DAY" == "$MAINTENANCE_DAY" ]] && \
       [[ "$CURRENT_TIME" > "$WINDOW_START" ]] && \
       [[ "$CURRENT_TIME" < "$WINDOW_END" ]]; then
        return 0  # åœ¨ç»´æŠ¤çª—å£å†…
    else
        return 1  # ä¸åœ¨ç»´æŠ¤çª—å£å†…
    fi
}

perform_maintenance() {
    if check_maintenance_window; then
        echo "å¼€å§‹æ‰§è¡Œç»´æŠ¤ä»»åŠ¡..."
        
        # 1. æ›´æ–°ç³»ç»ŸåŒ…
        yum update -y
        
        # 2. æ¸…ç†æ—¥å¿—æ–‡ä»¶
        find /opt/chroot/*/var/log -name "*.log" -mtime +30 -delete
        
        # 3. ä¼˜åŒ–æ•°æ®åº“(å¦‚æžœæœ‰)
        
        # 4. é‡å¯æœåŠ¡
        systemctl restart nginx-chroot
        
        echo "ç»´æŠ¤ä»»åŠ¡å®Œæˆ"
    else
        echo "å½“å‰ä¸åœ¨ç»´æŠ¤çª—å£å†…ï¼Œè·³è¿‡ç»´æŠ¤ä»»åŠ¡"
    fi
}

perform_maintenance
```

---

## 7. ðŸš¨ åº”æ€¥å¤„ç†é¢„æ¡ˆ


### 7.1 åº”æ€¥å“åº”ä½“ç³»


**ðŸ’¡ é€šä¿—ç†è§£**ï¼š
åº”æ€¥å¤„ç†é¢„æ¡ˆå°±åƒåŒ»é™¢çš„"æ€¥æ•‘æµç¨‹"ï¼š
- **å¿«é€Ÿè¯Šæ–­**ï¼šè¿…é€Ÿåˆ¤æ–­é—®é¢˜ç±»åž‹å’Œä¸¥é‡ç¨‹åº¦
- **ç´§æ€¥å¤„ç†**ï¼šæŒ‰é¢„å®šæ–¹æ¡ˆå¿«é€Ÿå“åº”
- **åŽç»­è·Ÿè¸ª**ï¼šç¡®ä¿é—®é¢˜å½»åº•è§£å†³
- **æ€»ç»“æ”¹è¿›**ï¼šå¸å–ç»éªŒé˜²æ­¢å†æ¬¡å‘ç”Ÿ

```
åº”æ€¥å“åº”æµç¨‹ï¼š
æ•…éšœå‘ç”Ÿ â†’ å‘Šè­¦è§¦å‘ â†’ é—®é¢˜åˆ†ç±» â†’ åº”æ€¥å¤„ç† â†’ æ•ˆæžœéªŒè¯ â†’ æ€»ç»“æ”¹è¿›
    â†“           â†“           â†“           â†“           â†“           â†“
  ç›‘æŽ§å‘çŽ°   ç«‹å³é€šçŸ¥   å¿«é€Ÿè¯Šæ–­   æ‰§è¡Œé¢„æ¡ˆ   çŠ¶æ€ç¡®è®¤   ç»éªŒç§¯ç´¯
```

### 7.2 å¸¸è§æ•…éšœå¤„ç†é¢„æ¡ˆ


**ðŸš¨ æ•…éšœåˆ†çº§å®šä¹‰**ï¼š

| **æ•…éšœçº§åˆ«** | **å½±å“èŒƒå›´** | **å“åº”æ—¶é—´** | **å¤„ç†ä¼˜å…ˆçº§** |
|-------------|-------------|-------------|---------------|
| ðŸ”´ **P0ä¸¥é‡** | æœåŠ¡å®Œå…¨ä¸å¯ç”¨ | 5åˆ†é’Ÿå†… | æœ€é«˜ä¼˜å…ˆçº§ |
| ðŸŸ¡ **P1é‡è¦** | æœåŠ¡éƒ¨åˆ†å¼‚å¸¸ | 30åˆ†é’Ÿå†… | é«˜ä¼˜å…ˆçº§ |
| ðŸŸ¢ **P2ä¸€èˆ¬** | æ€§èƒ½è½»å¾®ä¸‹é™ | 2å°æ—¶å†… | æ­£å¸¸ä¼˜å…ˆçº§ |

**ðŸ”§ P0çº§æ•…éšœå¤„ç†è„šæœ¬**ï¼š
```bash
#!/bin/bash
# emergency_p0_handler.sh

CHROOT_ENV="/opt/chroot/web/nginx1"
LOG_FILE="/var/log/emergency.log"

p0_emergency_handler() {
    echo "=== P0çº§æ•…éšœåº”æ€¥å¤„ç† $(date) ===" | tee -a $LOG_FILE
    
    # 1. ç«‹å³åˆ‡æ¢åˆ°å¤‡ç”¨çŽ¯å¢ƒ
    echo "åˆ‡æ¢åˆ°å¤‡ç”¨çŽ¯å¢ƒ..." | tee -a $LOG_FILE
    systemctl stop nginx-chroot
    systemctl start nginx-backup
    
    # 2. å¿«é€Ÿè¯Šæ–­ä¸»çŽ¯å¢ƒé—®é¢˜
    echo "è¯Šæ–­ä¸»çŽ¯å¢ƒé—®é¢˜..." | tee -a $LOG_FILE
    
    # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
    if ! pgrep -f $CHROOT_ENV; then
        echo "è¿›ç¨‹å·²æ­»ï¼Œå°è¯•é‡å¯" | tee -a $LOG_FILE
        systemctl start nginx-chroot
        sleep 10
        
        if pgrep -f $CHROOT_ENV; then
            echo "é‡å¯æˆåŠŸï¼Œåˆ‡å›žä¸»çŽ¯å¢ƒ" | tee -a $LOG_FILE
            systemctl stop nginx-backup
        else
            echo "é‡å¯å¤±è´¥ï¼Œä¿æŒå¤‡ç”¨çŽ¯å¢ƒ" | tee -a $LOG_FILE
        fi
    fi
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    DISK_FREE=$(df $CHROOT_ENV | tail -1 | awk '{print $4}')
    if [ $DISK_FREE -lt 1000000 ]; then  # å°äºŽ1GB
        echo "ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæ¸…ç†ä¸´æ—¶æ–‡ä»¶" | tee -a $LOG_FILE
        find $CHROOT_ENV/tmp -type f -delete
        find $CHROOT_ENV/var/log -name "*.log.*" -delete
    fi
    
    # 3. å‘é€ç´§æ€¥é€šçŸ¥
    send_emergency_notification "P0æ•…éšœå·²å¤„ç†ï¼Œå½“å‰ä½¿ç”¨å¤‡ç”¨çŽ¯å¢ƒ"
}

send_emergency_notification() {
    local message="$1"
    
    # å‘é€é‚®ä»¶é€šçŸ¥
    echo "$message" | mail -s "ã€ç´§æ€¥ã€‘chrootçŽ¯å¢ƒæ•…éšœ" admin@company.com
    
    # å‘é€çŸ­ä¿¡é€šçŸ¥(å¦‚æžœé…ç½®äº†)
    # curl -X POST "https://sms.api.com/send" -d "message=$message&phone=13800000000"
    
    # è®°å½•åˆ°æ—¥å¿—
    echo "é€šçŸ¥å·²å‘é€ï¼š$message" | tee -a $LOG_FILE
}

p0_emergency_handler
```

### 7.3 æ•…éšœæ¢å¤éªŒè¯


**âœ… æ¢å¤éªŒè¯æ¸…å•**ï¼š
```bash
#!/bin/bash
# recovery_verification.sh

verify_recovery() {
    echo "=== æ•…éšœæ¢å¤éªŒè¯ $(date) ==="
    
    # 1. æœåŠ¡å¯ç”¨æ€§éªŒè¯
    echo "1. æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
    if systemctl is-active nginx-chroot | grep -q active; then
        echo "âœ… æœåŠ¡çŠ¶æ€æ­£å¸¸"
    else
        echo "âŒ æœåŠ¡çŠ¶æ€å¼‚å¸¸"
        return 1
    fi
    
    # 2. åŠŸèƒ½éªŒè¯
    echo "2. æ£€æŸ¥æœåŠ¡å“åº”..."
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health)
    if [ "$HTTP_CODE" = "200" ]; then
        echo "âœ… HTTPå“åº”æ­£å¸¸"
    else
        echo "âŒ HTTPå“åº”å¼‚å¸¸: $HTTP_CODE"
        return 1
    fi
    
    # 3. æ€§èƒ½éªŒè¯
    echo "3. æ£€æŸ¥å“åº”æ—¶é—´..."
    RESPONSE_TIME=$(curl -w "%{time_total}" -o /dev/null -s http://localhost:8080/)
    if (( $(echo "$RESPONSE_TIME < 1.0" | bc -l) )); then
        echo "âœ… å“åº”æ—¶é—´æ­£å¸¸: ${RESPONSE_TIME}s"
    else
        echo "âš ï¸ å“åº”æ—¶é—´åæ…¢: ${RESPONSE_TIME}s"
    fi
    
    # 4. èµ„æºä½¿ç”¨éªŒè¯
    echo "4. æ£€æŸ¥èµ„æºä½¿ç”¨..."
    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
    MEM_USAGE=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
    
    echo "CPUä½¿ç”¨çŽ‡: ${CPU_USAGE}%"
    echo "å†…å­˜ä½¿ç”¨çŽ‡: ${MEM_USAGE}%"
    
    echo "æ•…éšœæ¢å¤éªŒè¯å®Œæˆ"
    return 0
}

verify_recovery
```

---

## 8. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 ç”Ÿäº§çŽ¯å¢ƒå®žæ–½è¦ç‚¹


**ðŸ”¸ éƒ¨ç½²è§„åˆ’æ ¸å¿ƒ**ï¼š
- **åˆ†å±‚éš”ç¦»**ï¼šWebã€åº”ç”¨ã€æ•°æ®åˆ†å±‚éƒ¨ç½²
- **èµ„æºè§„åˆ’**ï¼šåˆç†åˆ†é…CPUã€å†…å­˜ã€ç£ç›˜èµ„æº
- **ç½‘ç»œè®¾è®¡**ï¼šå†…å¤–ç½‘éš”ç¦»ï¼Œå®‰å…¨é€šä¿¡é€šé“
- **æ‰©å±•æ€§è€ƒè™‘**ï¼šæ”¯æŒæ°´å¹³æ‰©å±•å’Œè´Ÿè½½å‡è¡¡

**ðŸ”¸ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**ï¼š
- **å…±äº«ä¼˜åŒ–**ï¼šåˆç†ä½¿ç”¨ç»‘å®šæŒ‚è½½å‡å°‘èµ„æºæµªè´¹
- **ç¼“å­˜ç­–ç•¥**ï¼šä½¿ç”¨tmpfsåŠ é€Ÿä¸´æ—¶æ–‡ä»¶è®¿é—®
- **ç›‘æŽ§è°ƒä¼˜**ï¼šåŸºäºŽç›‘æŽ§æ•°æ®æŒç»­ä¼˜åŒ–é…ç½®
- **èµ„æºé™åˆ¶**ï¼šè®¾ç½®åˆç†çš„èµ„æºé™åˆ¶é˜²æ­¢å¼‚å¸¸æ¶ˆè€—

### 8.2 è¿ç»´ç®¡ç†è¦ç‚¹


**ðŸ”¸ ç›‘æŽ§å‘Šè­¦ä½“ç³»**ï¼š
- **å…¨æ–¹ä½ç›‘æŽ§**ï¼šæœåŠ¡çŠ¶æ€ã€èµ„æºä½¿ç”¨ã€æ€§èƒ½æŒ‡æ ‡
- **åˆ†çº§å‘Šè­¦**ï¼šæ ¹æ®ä¸¥é‡ç¨‹åº¦è®¾ç½®ä¸åŒå“åº”æ—¶é—´
- **è‡ªåŠ¨åŒ–å¤„ç†**ï¼šå¸¸è§é—®é¢˜è‡ªåŠ¨ä¿®å¤
- **è¶‹åŠ¿åˆ†æž**ï¼šé€šè¿‡åŽ†å²æ•°æ®é¢„æµ‹æ½œåœ¨é—®é¢˜

**ðŸ”¸ å®‰å…¨åˆè§„è¦æ±‚**ï¼š
- **æœ€å°æƒé™åŽŸåˆ™**ï¼šåªæŽˆäºˆå¿…è¦çš„æœ€å°æƒé™
- **å®Œæ•´å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰å…³é”®æ“ä½œ
- **å®šæœŸå®‰å…¨æ£€æŸ¥**ï¼šå®šæœŸè¯„ä¼°å®‰å…¨é£Žé™©
- **åˆè§„æ€§æŠ¥å‘Š**ï¼šæ»¡è¶³è¡Œä¸šåˆè§„è¦æ±‚

### 8.3 åº”æ€¥å¤„ç†è¦ç‚¹


**ðŸ”¸ åº”æ€¥å“åº”åŽŸåˆ™**ï¼š
- **å¿«é€Ÿå“åº”**ï¼šå»ºç«‹å¿«é€Ÿå“åº”æœºåˆ¶
- **é¢„æ¡ˆé©±åŠ¨**ï¼šæŒ‰é¢„å®šæ–¹æ¡ˆæ‰§è¡Œï¼Œå‡å°‘åˆ¤æ–­æ—¶é—´
- **å¤‡ç”¨åˆ‡æ¢**ï¼šå…³é”®æœåŠ¡è¦æœ‰å¤‡ç”¨æ–¹æ¡ˆ
- **éªŒè¯ç¡®è®¤**ï¼šå¤„ç†åŽå¿…é¡»éªŒè¯æ•ˆæžœ

**ðŸ”¸ æŒç»­æ”¹è¿›æœºåˆ¶**ï¼š
- **æ•…éšœå¤ç›˜**ï¼šæ¯æ¬¡æ•…éšœåŽéƒ½è¦æ€»ç»“ç»éªŒ
- **é¢„æ¡ˆæ›´æ–°**ï¼šæ ¹æ®å®žé™…æƒ…å†µæ›´æ–°åº”æ€¥é¢„æ¡ˆ
- **æŠ€èƒ½åŸ¹è®­**ï¼šå®šæœŸåŸ¹è®­è¿ç»´äººå‘˜åº”æ€¥æŠ€èƒ½
- **å·¥å…·å®Œå–„**ï¼šæŒç»­å®Œå–„è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·

### 8.4 å®žæ–½å»ºè®®


**ðŸŽ¯ åˆ†é˜¶æ®µå®žæ–½**ï¼š
```
å®žæ–½è·¯çº¿å›¾ï¼š
ç¬¬1é˜¶æ®µï¼šåŸºç¡€çŽ¯å¢ƒæ­å»ºå’Œæµ‹è¯•éªŒè¯
ç¬¬2é˜¶æ®µï¼šç›‘æŽ§å‘Šè­¦ä½“ç³»å»ºè®¾
ç¬¬3é˜¶æ®µï¼šè‡ªåŠ¨åŒ–è¿ç»´å·¥å…·å¼€å‘
ç¬¬4é˜¶æ®µï¼šå®‰å…¨å®¡è®¡å’Œåˆè§„å®Œå–„
ç¬¬5é˜¶æ®µï¼šåº”æ€¥é¢„æ¡ˆåˆ¶å®šå’Œæ¼”ç»ƒ
```

**âš¡ æˆåŠŸå…³é”®å› ç´ **ï¼š
- **å›¢é˜Ÿåä½œ**ï¼šå¼€å‘ã€è¿ç»´ã€å®‰å…¨å›¢é˜Ÿå¯†åˆ‡é…åˆ
- **æ ‡å‡†åŒ–**ï¼šå»ºç«‹ç»Ÿä¸€çš„éƒ¨ç½²å’Œè¿ç»´æ ‡å‡†
- **æ–‡æ¡£åŒ–**ï¼šå®Œæ•´çš„æŠ€æœ¯æ–‡æ¡£å’Œæ“ä½œæ‰‹å†Œ
- **æŒç»­å­¦ä¹ **ï¼šè·Ÿè¸ªæ–°æŠ€æœ¯å‘å±•ï¼ŒæŒç»­æ”¹è¿›

**æ ¸å¿ƒè®°å¿†**ï¼š
- ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²è¦å……åˆ†è§„åˆ’ï¼Œè€ƒè™‘æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§
- ç›‘æŽ§å‘Šè­¦æ˜¯è¿ç»´çš„çœ¼ç›ï¼Œå¿…é¡»å»ºè®¾å®Œå–„çš„ç›‘æŽ§ä½“ç³»
- å¤‡ä»½æ¢å¤æ˜¯ä¿é™©ï¼Œåº”æ€¥é¢„æ¡ˆæ˜¯æ•‘å‘½ç¨»è‰
- å®‰å…¨åˆè§„ä¸æ˜¯è´Ÿæ‹…ï¼Œæ˜¯å¯¹ä¸šåŠ¡çš„æœ‰åŠ›ä¿æŠ¤