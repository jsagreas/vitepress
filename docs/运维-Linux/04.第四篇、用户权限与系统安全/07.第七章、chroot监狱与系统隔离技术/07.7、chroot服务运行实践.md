---
title: 7ã€chrootæœåŠ¡è¿è¡Œå®è·µ
---
## ğŸ“š ç›®å½•

1. [WebæœåŠ¡å™¨chrooté…ç½®](#1-WebæœåŠ¡å™¨chrooté…ç½®)
2. [DNSæœåŠ¡å™¨ç›‘ç‹±ç¯å¢ƒ](#2-DNSæœåŠ¡å™¨ç›‘ç‹±ç¯å¢ƒ)
3. [FTPæœåŠ¡å™¨éš”ç¦»éƒ¨ç½²](#3-FTPæœåŠ¡å™¨éš”ç¦»éƒ¨ç½²)
4. [SSHæœåŠ¡chrooté™åˆ¶](#4-SSHæœåŠ¡chrooté™åˆ¶)
5. [æ•°æ®åº“æœåŠ¡éš”ç¦»](#5-æ•°æ®åº“æœåŠ¡éš”ç¦»)
6. [åº”ç”¨ç¨‹åºé€‚é…æ”¹é€ ](#6-åº”ç”¨ç¨‹åºé€‚é…æ”¹é€ )
7. [æœåŠ¡å¯åŠ¨è„šæœ¬ç¼–å†™](#7-æœåŠ¡å¯åŠ¨è„šæœ¬ç¼–å†™)
8. [å¤šæœåŠ¡éš”ç¦»æ¶æ„](#8-å¤šæœåŠ¡éš”ç¦»æ¶æ„)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ WebæœåŠ¡å™¨chrooté…ç½®


### 1.1 ä»€ä¹ˆæ˜¯WebæœåŠ¡å™¨chrootéš”ç¦»


**ğŸ”¸ ç®€å•ç†è§£**
```
æ™®é€šWebæœåŠ¡å™¨ï¼šå¯ä»¥è®¿é—®æ•´ä¸ªç³»ç»Ÿçš„æ–‡ä»¶
éš”ç¦»åçš„WebæœåŠ¡å™¨ï¼šåªèƒ½çœ‹åˆ°æŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œå°±åƒè¢«å…³åœ¨"ç¬¼å­"é‡Œ

å¥½å¤„ï¼š
- å³ä½¿ç½‘ç«™è¢«é»‘å®¢æ”»ç ´ï¼Œä¹Ÿæ— æ³•è®¿é—®ç³»ç»Ÿé‡è¦æ–‡ä»¶
- é™åˆ¶äº†æ”»å‡»è€…çš„æ´»åŠ¨èŒƒå›´
- ä¿æŠ¤ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†çš„å®‰å…¨
```

### 1.2 Apache WebæœåŠ¡å™¨chrooté…ç½®


**ğŸ”§ åŸºç¡€ç¯å¢ƒå‡†å¤‡**
```bash
# åˆ›å»ºchrootç›‘ç‹±ç›®å½•
mkdir -p /var/chroot/apache
cd /var/chroot/apache

# åˆ›å»ºåŸºæœ¬ç›®å½•ç»“æ„
mkdir -p {bin,lib,lib64,etc,dev,tmp,var/www,usr/lib}
mkdir -p var/log/apache2

# è®¾ç½®æƒé™
chmod 755 /var/chroot/apache
chmod 1777 /var/chroot/apache/tmp
```

**ğŸ“ ç›®å½•ç»“æ„è¯´æ˜**
```
/var/chroot/apache/           # chrootç›‘ç‹±æ ¹ç›®å½•
â”œâ”€â”€ bin/                      # å¿…è¦çš„ç³»ç»Ÿå‘½ä»¤
â”œâ”€â”€ lib/                      # 32ä½åº“æ–‡ä»¶
â”œâ”€â”€ lib64/                    # 64ä½åº“æ–‡ä»¶  
â”œâ”€â”€ etc/                      # é…ç½®æ–‡ä»¶
â”œâ”€â”€ dev/                      # è®¾å¤‡æ–‡ä»¶
â”œâ”€â”€ tmp/                      # ä¸´æ—¶ç›®å½•
â”œâ”€â”€ var/www/                  # ç½‘ç«™æ–‡ä»¶ç›®å½•
â””â”€â”€ usr/lib/                  # é¢å¤–åº“æ–‡ä»¶
```

**ğŸ”¨ å¤åˆ¶å¿…è¦æ–‡ä»¶**
```bash
# å¤åˆ¶ApacheäºŒè¿›åˆ¶æ–‡ä»¶
cp /usr/sbin/apache2 /var/chroot/apache/bin/

# å¤åˆ¶å¿…è¦çš„åº“æ–‡ä»¶ï¼ˆä½¿ç”¨lddå‘½ä»¤æŸ¥çœ‹ä¾èµ–ï¼‰
ldd /usr/sbin/apache2
# æ ¹æ®è¾“å‡ºå¤åˆ¶æ‰€éœ€çš„.soæ–‡ä»¶åˆ°å¯¹åº”libç›®å½•

# å¤åˆ¶åŸºæœ¬é…ç½®æ–‡ä»¶
cp /etc/passwd /var/chroot/apache/etc/
cp /etc/group /var/chroot/apache/etc/
cp /etc/hosts /var/chroot/apache/etc/
cp /etc/resolv.conf /var/chroot/apache/etc/

# åˆ›å»ºè®¾å¤‡æ–‡ä»¶
mknod /var/chroot/apache/dev/null c 1 3
mknod /var/chroot/apache/dev/zero c 1 5
mknod /var/chroot/apache/dev/random c 1 8
```

**âš™ï¸ Apacheé…ç½®ä¿®æ”¹**
```apache
# /etc/apache2/apache2.conf æ·»åŠ é…ç½®
# ä¿®æ”¹DocumentRootæŒ‡å‘ç›‘ç‹±å†…ç›®å½•
DocumentRoot /var/www

# ä¿®æ”¹æ—¥å¿—æ–‡ä»¶è·¯å¾„
ErrorLog /var/log/apache2/error.log
CustomLog /var/log/apache2/access.log combined

# æ·»åŠ chrootå¯åŠ¨è„šæœ¬
# /etc/init.d/apache2-chroot
#!/bin/bash
chroot /var/chroot/apache /bin/apache2 -D FOREGROUND
```

### 1.3 Nginx chrooté…ç½®


**ğŸ”§ Nginxç›‘ç‹±ç¯å¢ƒ**
```bash
# åˆ›å»ºnginx chrootç¯å¢ƒ
mkdir -p /var/chroot/nginx/{bin,lib,lib64,etc,dev,tmp,var/www,var/log}

# å¤åˆ¶nginxäºŒè¿›åˆ¶æ–‡ä»¶
cp /usr/sbin/nginx /var/chroot/nginx/bin/

# å¤åˆ¶åº“ä¾èµ–
ldd /usr/sbin/nginx | awk '{print $3}' | grep -v '^(' | xargs -I {} cp {} /var/chroot/nginx/lib/

# nginxé…ç½®æ–‡ä»¶
cat > /var/chroot/nginx/etc/nginx.conf << 'EOF'
worker_processes 2;
error_log /var/log/nginx/error.log;

events {
    worker_connections 1024;
}

http {
    include       /etc/mime.types;
    default_type  application/octet-stream;
    
    server {
        listen 80;
        server_name localhost;
        root /var/www;
        index index.html;
        
        location / {
            try_files $uri $uri/ =404;
        }
    }
}
EOF
```

**ğŸ“ æµ‹è¯•ç½‘é¡µ**
```html
<!-- /var/chroot/nginx/var/www/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Nginx Chroot Test</title>
</head>
<body>
    <h1>Nginxè¿è¡Œåœ¨chrootç¯å¢ƒä¸­ï¼</h1>
    <p>è¿™æ˜¯ä¸€ä¸ªéš”ç¦»çš„WebæœåŠ¡å™¨</p>
</body>
</html>
```

---

## 2. ğŸŒ DNSæœåŠ¡å™¨ç›‘ç‹±ç¯å¢ƒ


### 2.1 DNSæœåŠ¡éš”ç¦»çš„é‡è¦æ€§


**âš ï¸ ä¸ºä»€ä¹ˆéœ€è¦éš”ç¦»DNSæœåŠ¡**
```
DNSæœåŠ¡å™¨ç‰¹ç‚¹ï¼š
- é¢å‘å…¬ç½‘ï¼Œå®¹æ˜“è¢«æ”»å‡»
- è¿è¡Œåœ¨53ç«¯å£ï¼Œéœ€è¦rootæƒé™å¯åŠ¨
- å¤„ç†å¤§é‡å¤–éƒ¨è¯·æ±‚ï¼Œå®‰å…¨é£é™©é«˜

éš”ç¦»å¥½å¤„ï¼š
- é™åˆ¶æ”»å‡»è€…è®¿é—®ç³»ç»Ÿæ–‡ä»¶
- å³ä½¿DNSæœåŠ¡è¢«æ”»ç ´ï¼Œä¹Ÿæ— æ³•å½±å“å…¶ä»–æœåŠ¡
- ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ
```

### 2.2 BIND DNSæœåŠ¡å™¨chrooté…ç½®


**ğŸ”§ åˆ›å»ºBINDç›‘ç‹±ç¯å¢ƒ**
```bash
# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p /var/chroot/named/{bin,lib,lib64,etc,dev,var/log,var/run}
mkdir -p /var/chroot/named/etc/bind

# å¤åˆ¶namedäºŒè¿›åˆ¶æ–‡ä»¶
cp /usr/sbin/named /var/chroot/named/bin/

# å¤åˆ¶åº“æ–‡ä»¶ä¾èµ–
for lib in $(ldd /usr/sbin/named | awk '{print $3}' | grep -v '^('); do
    cp $lib /var/chroot/named/lib/
done

# åˆ›å»ºè®¾å¤‡æ–‡ä»¶
mknod /var/chroot/named/dev/null c 1 3
mknod /var/chroot/named/dev/random c 1 8
```

**ğŸ“‹ BINDé…ç½®æ–‡ä»¶**
```bash
# /var/chroot/named/etc/bind/named.conf
options {
    directory "/etc/bind";
    listen-on { any; };
    listen-on-v6 { any; };
    allow-query { any; };
    
    # å®‰å…¨é€‰é¡¹
    recursion no;
    allow-transfer { none; };
    
    # åœ¨chrootç¯å¢ƒä¸­çš„è·¯å¾„
    pid-file "/var/run/named.pid";
};

# å®šä¹‰æœ¬åœ°åŸŸå
zone "example.local" {
    type master;
    file "/etc/bind/example.local.zone";
};
```

**ğŸ—‚ï¸ åŸŸåè§£ææ–‡ä»¶**
```bash
# /var/chroot/named/etc/bind/example.local.zone
$TTL    604800
@       IN      SOA     ns1.example.local. admin.example.local. (
                        2023091401      ; Serial
                        604800          ; Refresh
                        86400           ; Retry
                        2419200         ; Expire
                        604800 )        ; Negative Cache TTL

@       IN      NS      ns1.example.local.
ns1     IN      A       192.168.1.10
www     IN      A       192.168.1.20
ftp     IN      A       192.168.1.30
```

**ğŸš€ å¯åŠ¨è„šæœ¬**
```bash
#!/bin/bash
# /etc/init.d/named-chroot

start_named_chroot() {
    echo "å¯åŠ¨chrootç¯å¢ƒä¸‹çš„DNSæœåŠ¡..."
    chroot /var/chroot/named /bin/named -g -u named
}

stop_named_chroot() {
    echo "åœæ­¢chroot DNSæœåŠ¡..."
    pkill -f "chroot.*named"
}

case "$1" in
    start)
        start_named_chroot
        ;;
    stop)
        stop_named_chroot
        ;;
    restart)
        stop_named_chroot
        sleep 2
        start_named_chroot
        ;;
esac
```

---

## 3. ğŸ“ FTPæœåŠ¡å™¨éš”ç¦»éƒ¨ç½²


### 3.1 FTPæœåŠ¡éš”ç¦»åŸç†


**ğŸ”¸ FTPæœåŠ¡çš„å®‰å…¨éšæ‚£**
```
ä¼ ç»ŸFTPé—®é¢˜ï¼š
- æ˜æ–‡ä¼ è¾“ç”¨æˆ·åå’Œå¯†ç 
- å®¹æ˜“è¢«æš´åŠ›ç ´è§£
- ç”¨æˆ·å¯èƒ½è®¿é—®ç³»ç»Ÿç›®å½•

chrootéš”ç¦»è§£å†³ï¼š
- é™åˆ¶ç”¨æˆ·åªèƒ½è®¿é—®æŒ‡å®šç›®å½•
- æ— æ³•è·³å‡º"ç›‘ç‹±"è®¿é—®ç³»ç»Ÿæ–‡ä»¶
- æé«˜æœåŠ¡å™¨æ•´ä½“å®‰å…¨æ€§
```

### 3.2 vsftpd chrooté…ç½®


**âš™ï¸ vsftpdåŸºç¡€é…ç½®**
```bash
# å®‰è£…vsftpd
apt-get install vsftpd

# ç¼–è¾‘é…ç½®æ–‡ä»¶ /etc/vsftpd.conf
cat > /etc/vsftpd.conf << 'EOF'
# åŸºæœ¬è®¾ç½®
listen=YES
anonymous_enable=NO
local_enable=YES
write_enable=YES

# chrootéš”ç¦»è®¾ç½®
chroot_local_user=YES
chroot_list_enable=YES
chroot_list_file=/etc/vsftpd.chroot_list

# å®‰å…¨è®¾ç½®
allow_writeable_chroot=YES
secure_chroot_dir=/var/run/vsftpd/empty
pam_service_name=vsftpd
userlist_enable=YES
tcp_wrappers=YES

# æ—¥å¿—è®¾ç½®
xferlog_enable=YES
xferlog_file=/var/log/vsftpd.log
EOF
```

**ğŸ‘¥ åˆ›å»ºFTPç”¨æˆ·**
```bash
# åˆ›å»ºFTPä¸“ç”¨ç”¨æˆ·
useradd -d /home/ftpuser -s /bin/bash ftpuser
echo "ftpuser:password123" | chpasswd

# åˆ›å»ºç”¨æˆ·ä¸»ç›®å½•ç»“æ„
mkdir -p /home/ftpuser/{upload,download}
chown ftpuser:ftpuser /home/ftpuser/{upload,download}
chmod 755 /home/ftpuser

# è®¾ç½®chrootç”¨æˆ·åˆ—è¡¨
echo "ftpuser" > /etc/vsftpd.chroot_list
```

**ğŸ”’ ç›®å½•æƒé™è®¾ç½®**
```bash
# è®¾ç½®chrootç›®å½•æƒé™ï¼ˆé‡è¦ï¼ï¼‰
chmod 755 /home/ftpuser
chown root:root /home/ftpuser

# ç”¨æˆ·åªèƒ½åœ¨å­ç›®å½•ä¸­æ“ä½œ
chown ftpuser:ftpuser /home/ftpuser/upload
chown ftpuser:ftpuser /home/ftpuser/download
```

**âœ… æµ‹è¯•é…ç½®**
```bash
# é‡å¯vsftpdæœåŠ¡
systemctl restart vsftpd

# æµ‹è¯•FTPè¿æ¥
ftp localhost
# è¾“å…¥ç”¨æˆ·åï¼šftpuser
# è¾“å…¥å¯†ç ï¼špassword123
# å°è¯•åˆ‡æ¢åˆ°æ ¹ç›®å½•ï¼Œåº”è¯¥è¢«é™åˆ¶
```

### 3.3 ProFTPD chrooté…ç½®


**âš™ï¸ ProFTPDé…ç½®ç¤ºä¾‹**
```apache
# /etc/proftpd/proftpd.conf
ServerName "ProFTPD chroot server"
ServerType standalone
DefaultServer on

Port 21
UseIPv6 off

# chrooté…ç½®
DefaultRoot ~ !adm
DefaultChdir /upload

# å®‰å…¨è®¾ç½®
RootLogin off
RequireValidShell off

# ç”¨æˆ·è®¤è¯
AuthUserFile /etc/proftpd/ftpd.passwd
AuthGroupFile /etc/proftpd/ftpd.group

<Directory />
  AllowOverwrite yes
  <Limit WRITE>
    DenyAll
  </Limit>
</Directory>

<Directory ~/upload>
  <Limit WRITE>
    AllowAll
  </Limit>
</Directory>
```

---

## 4. ğŸ” SSHæœåŠ¡chrooté™åˆ¶


### 4.1 SSH chrootçš„åº”ç”¨åœºæ™¯


**ğŸ¯ é€‚ç”¨æƒ…å†µ**
```
é€‚åˆchrootçš„SSHåœºæ™¯ï¼š
- åªéœ€è¦æ–‡ä»¶ä¼ è¾“åŠŸèƒ½çš„ç”¨æˆ·ï¼ˆSFTPï¼‰
- ç¬¬ä¸‰æ–¹å¼€å‘äººå‘˜çš„ä¸´æ—¶è®¿é—®
- å®¢æˆ·ç«¯ç”¨æˆ·çš„å—é™è®¿é—®
- æµ‹è¯•ç¯å¢ƒçš„éš”ç¦»è®¿é—®

ä¸é€‚åˆçš„åœºæ™¯ï¼š
- éœ€è¦ç³»ç»Ÿç®¡ç†æƒé™çš„ç”¨æˆ·
- éœ€è¦è®¿é—®å¤šä¸ªç³»ç»Ÿç›®å½•çš„æ“ä½œ
- éœ€è¦è¿è¡Œç³»ç»Ÿçº§å‘½ä»¤çš„åœºæ™¯
```

### 4.2 OpenSSHå†…ç½®chrooté…ç½®


**âš™ï¸ SSHæœåŠ¡å™¨é…ç½®**
```bash
# ç¼–è¾‘ /etc/ssh/sshd_config
cat >> /etc/ssh/sshd_config << 'EOF'

# SFTP chrooté…ç½®
Subsystem sftp internal-sftp

# åŒ¹é…ç‰¹å®šç”¨æˆ·ç»„è¿›è¡Œchroot
Match Group sftponly
    ChrootDirectory %h
    ForceCommand internal-sftp
    AllowTcpForwarding no
    X11Forwarding no
EOF
```

**ğŸ‘¥ åˆ›å»ºSFTPä¸“ç”¨ç”¨æˆ·**
```bash
# åˆ›å»ºç”¨æˆ·ç»„
groupadd sftponly

# åˆ›å»ºç”¨æˆ·
useradd -g sftponly -d /home/sftpuser -s /bin/false sftpuser
echo "sftpuser:securepass123" | chpasswd

# è®¾ç½®ç›®å½•æƒé™ï¼ˆå…³é”®æ­¥éª¤ï¼‰
chown root:root /home/sftpuser
chmod 755 /home/sftpuser

# åˆ›å»ºç”¨æˆ·å¯å†™ç›®å½•
mkdir /home/sftpuser/upload
chown sftpuser:sftponly /home/sftpuser/upload
chmod 755 /home/sftpuser/upload
```

**ğŸ”’ ç›®å½•ç»“æ„å’Œæƒé™**
```
/home/sftpuser/              # å±ä¸»ï¼šrootï¼Œæƒé™ï¼š755
â”œâ”€â”€ upload/                  # å±ä¸»ï¼šsftpuserï¼Œæƒé™ï¼š755
â”œâ”€â”€ download/                # å±ä¸»ï¼šsftpuserï¼Œæƒé™ï¼š755  
â””â”€â”€ shared/                  # å±ä¸»ï¼šrootï¼Œæƒé™ï¼š755
```

**âœ… æµ‹è¯•SSH chroot**
```bash
# é‡å¯SSHæœåŠ¡
systemctl restart sshd

# æµ‹è¯•SFTPè¿æ¥
sftp sftpuser@localhost
# å°è¯•åˆ‡æ¢åˆ°æ ¹ç›®å½•ï¼Œåº”è¯¥è¢«é™åˆ¶åœ¨/home/sftpuserå†…

# æµ‹è¯•SSHè¿æ¥ï¼ˆåº”è¯¥è¢«æ‹’ç»ï¼‰
ssh sftpuser@localhost
```

### 4.3 é«˜çº§SSH chrooté…ç½®


**ğŸ”§ é’ˆå¯¹ä¸åŒç”¨æˆ·çš„é…ç½®**
```bash
# /etc/ssh/sshd_config å¤šç”¨æˆ·é…ç½®
Match Group developers
    ChrootDirectory /var/chroot/dev
    ForceCommand internal-sftp
    
Match Group customers  
    ChrootDirectory /var/chroot/customer
    ForceCommand internal-sftp
    AllowTcpForwarding no
    
Match User backup
    ChrootDirectory /var/chroot/backup
    ForceCommand internal-sftp
    ClientAliveInterval 300
```

---

## 5. ğŸ’¾ æ•°æ®åº“æœåŠ¡éš”ç¦»


### 5.1 æ•°æ®åº“æœåŠ¡éš”ç¦»çš„æ„ä¹‰


**ğŸ›¡ï¸ ä¸ºä»€ä¹ˆè¦éš”ç¦»æ•°æ®åº“**
```
æ•°æ®åº“å®‰å…¨é£é™©ï¼š
- å­˜å‚¨é‡è¦ä¸šåŠ¡æ•°æ®
- ç½‘ç»œç«¯å£æš´éœ²
- SQLæ³¨å…¥ç­‰æ”»å‡»é£é™©
- æƒé™å‡çº§é£é™©

éš”ç¦»å¸¦æ¥çš„å¥½å¤„ï¼š
- é™åˆ¶æ”»å‡»è€…è®¿é—®ç³»ç»Ÿæ–‡ä»¶
- ä¿æŠ¤æ•°æ®åº“é…ç½®æ–‡ä»¶
- å‡å°‘æƒé™å‡çº§çš„å¯èƒ½æ€§
- ç¬¦åˆå®‰å…¨åˆè§„è¦æ±‚
```

### 5.2 MySQL/MariaDB chrooté…ç½®


**ğŸ”§ åˆ›å»ºMySQLç›‘ç‹±ç¯å¢ƒ**
```bash
# åˆ›å»ºåŸºç¡€ç›®å½•ç»“æ„
mkdir -p /var/chroot/mysql/{bin,lib,lib64,etc,var/lib/mysql,var/run/mysqld,tmp}

# å¤åˆ¶MySQLäºŒè¿›åˆ¶æ–‡ä»¶
cp /usr/sbin/mysqld /var/chroot/mysql/bin/
cp /usr/bin/mysql /var/chroot/mysql/bin/

# å¤åˆ¶åº“æ–‡ä»¶ä¾èµ–
ldd /usr/sbin/mysqld | awk '{print $3}' | grep -v '^(' | while read lib; do
    [ -f "$lib" ] && cp "$lib" /var/chroot/mysql/lib/
done

# åˆ›å»ºå¿…è¦çš„è®¾å¤‡æ–‡ä»¶
mknod /var/chroot/mysql/dev/null c 1 3
mknod /var/chroot/mysql/dev/zero c 1 5

# è®¾ç½®æƒé™
chmod 1777 /var/chroot/mysql/tmp
```

**ğŸ“ MySQLé…ç½®æ–‡ä»¶**
```ini
# /var/chroot/mysql/etc/my.cnf
[mysqld]
user = mysql
pid-file = /var/run/mysqld/mysqld.pid
socket = /var/run/mysqld/mysqld.sock
port = 3306
basedir = /
datadir = /var/lib/mysql
tmpdir = /tmp

# å®‰å…¨è®¾ç½®
bind-address = 127.0.0.1
skip-networking = false
skip-name-resolve

# æ—¥å¿—è®¾ç½®
log-error = /var/lib/mysql/error.log
general_log = 1
general_log_file = /var/lib/mysql/general.log

[client]
socket = /var/run/mysqld/mysqld.sock
```

**ğŸš€ å¯åŠ¨è„šæœ¬**
```bash
#!/bin/bash
# /etc/init.d/mysql-chroot

CHROOT_DIR="/var/chroot/mysql"
MYSQL_USER="mysql"

start_mysql_chroot() {
    echo "åˆå§‹åŒ–MySQL chrootç¯å¢ƒ..."
    
    # ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨å¹¶æœ‰æ­£ç¡®æƒé™
    chown -R $MYSQL_USER:$MYSQL_USER $CHROOT_DIR/var/lib/mysql
    
    # å¯åŠ¨MySQL
    chroot $CHROOT_DIR /bin/mysqld --defaults-file=/etc/my.cnf &
    
    echo "MySQLå·²åœ¨chrootç¯å¢ƒä¸­å¯åŠ¨"
}

stop_mysql_chroot() {
    echo "åœæ­¢chroot MySQLæœåŠ¡..."
    pkill -f "chroot.*mysqld"
}

case "$1" in
    start)
        start_mysql_chroot
        ;;
    stop)
        stop_mysql_chroot
        ;;
esac
```

### 5.3 PostgreSQL chrooté…ç½®


**ğŸ”§ PostgreSQLéš”ç¦»ç¯å¢ƒ**
```bash
# åˆ›å»ºPostgreSQL chrootç›®å½•
mkdir -p /var/chroot/postgres/{bin,lib,lib64,etc,var/lib/postgresql,tmp}

# å¤åˆ¶å¿…è¦æ–‡ä»¶
cp /usr/lib/postgresql/*/bin/postgres /var/chroot/postgres/bin/
cp /usr/lib/postgresql/*/bin/initdb /var/chroot/postgres/bin/

# åˆå§‹åŒ–æ•°æ®åº“
chroot /var/chroot/postgres /bin/initdb -D /var/lib/postgresql/data
```

---

## 6. ğŸ”§ åº”ç”¨ç¨‹åºé€‚é…æ”¹é€ 


### 6.1 åº”ç”¨ç¨‹åºchrooté€‚é…åŸåˆ™


**ğŸ“‹ é€‚é…æ£€æŸ¥æ¸…å•**
- [ ] **ä¾èµ–åº“æ£€æŸ¥**ï¼šç¡®ä¿æ‰€æœ‰åŠ¨æ€åº“éƒ½å¤åˆ¶åˆ°ç›‘ç‹±ä¸­
- [ ] **é…ç½®æ–‡ä»¶è·¯å¾„**ï¼šä¿®æ”¹ä¸ºç›‘ç‹±å†…çš„ç»å¯¹è·¯å¾„
- [ ] **æ—¥å¿—æ–‡ä»¶è·¯å¾„**ï¼šç¡®ä¿æ—¥å¿—ç›®å½•åœ¨ç›‘ç‹±å†…å¯å†™
- [ ] **ä¸´æ—¶æ–‡ä»¶ç›®å½•**ï¼š/tmpç›®å½•å¿…é¡»å­˜åœ¨ä¸”å¯å†™
- [ ] **ç”¨æˆ·å’Œç»„ä¿¡æ¯**ï¼šå¤åˆ¶å¿…è¦çš„/etc/passwdå’Œ/etc/group
- [ ] **è®¾å¤‡æ–‡ä»¶**ï¼šåˆ›å»ºå¿…è¦çš„/devè®¾å¤‡æ–‡ä»¶

### 6.2 è‡ªå®šä¹‰åº”ç”¨ç¨‹åºæ”¹é€ 


**ğŸ”¨ Webåº”ç”¨æ”¹é€ ç¤ºä¾‹**
```bash
#!/bin/bash
# åº”ç”¨ç¨‹åºchrooté€‚é…è„šæœ¬

APP_NAME="mywebapp"
CHROOT_DIR="/var/chroot/$APP_NAME"
APP_DIR="/opt/$APP_NAME"

# åˆ›å»ºåŸºç¡€ç›®å½•ç»“æ„
create_chroot_structure() {
    mkdir -p $CHROOT_DIR/{bin,lib,lib64,etc,tmp,opt/$APP_NAME}
    chmod 1777 $CHROOT_DIR/tmp
}

# å¤åˆ¶åº”ç”¨ç¨‹åºæ–‡ä»¶
copy_application() {
    cp -r $APP_DIR/* $CHROOT_DIR/opt/$APP_NAME/
    
    # å¤åˆ¶åº”ç”¨ç¨‹åºçš„ä¾èµ–åº“
    for binary in $(find $CHROOT_DIR/opt/$APP_NAME -type f -executable); do
        ldd $binary 2>/dev/null | awk '{print $3}' | grep -v '^(' | while read lib; do
            [ -f "$lib" ] && cp "$lib" $CHROOT_DIR/lib/
        done
    done
}

# å¤åˆ¶ç³»ç»Ÿæ–‡ä»¶
copy_system_files() {
    # å¤åˆ¶å¿…è¦çš„ç³»ç»Ÿæ–‡ä»¶
    cp /etc/passwd $CHROOT_DIR/etc/
    cp /etc/group $CHROOT_DIR/etc/
    cp /etc/hosts $CHROOT_DIR/etc/
    cp /etc/resolv.conf $CHROOT_DIR/etc/
    
    # åˆ›å»ºè®¾å¤‡æ–‡ä»¶
    mknod $CHROOT_DIR/dev/null c 1 3
    mknod $CHROOT_DIR/dev/zero c 1 5
    mknod $CHROOT_DIR/dev/urandom c 1 9
}

# ä¿®æ”¹é…ç½®æ–‡ä»¶
update_config() {
    # ä¿®æ”¹åº”ç”¨é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„
    sed -i 's|/var/log/mywebapp|/tmp|g' $CHROOT_DIR/opt/$APP_NAME/config.conf
    sed -i 's|/etc/mywebapp|/opt/mywebapp|g' $CHROOT_DIR/opt/$APP_NAME/config.conf
}

# æ‰§è¡Œæ‰€æœ‰æ­¥éª¤
create_chroot_structure
copy_application
copy_system_files
update_config

echo "åº”ç”¨ç¨‹åº $APP_NAME å·²æˆåŠŸé€‚é…chrootç¯å¢ƒ"
```

### 6.3 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ


**âš ï¸ å¸¸è§é€‚é…é—®é¢˜**

| é—®é¢˜ | è¡¨ç° | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **åº“æ–‡ä»¶ç¼ºå¤±** | `ç¨‹åºå¯åŠ¨å¤±è´¥ï¼Œæ‰¾ä¸åˆ°.soæ–‡ä»¶` | ä½¿ç”¨lddæ£€æŸ¥ä¾èµ–ï¼Œå¤åˆ¶æ‰€æœ‰åº“æ–‡ä»¶ |
| **é…ç½®æ–‡ä»¶è·¯å¾„é”™è¯¯** | `æ— æ³•æ‰¾åˆ°é…ç½®æ–‡ä»¶` | ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸ºç›‘ç‹±å†…è·¯å¾„ |
| **æƒé™é—®é¢˜** | `æ— æ³•å†™å…¥æ—¥å¿—æˆ–ä¸´æ—¶æ–‡ä»¶` | æ­£ç¡®è®¾ç½®ç›®å½•æƒé™ï¼Œç¡®ä¿å¯å†™ |
| **ç”¨æˆ·ä¿¡æ¯ç¼ºå¤±** | `ç”¨æˆ·åè§£æå¤±è´¥` | å¤åˆ¶/etc/passwdå’Œ/etc/group |
| **DNSè§£æå¤±è´¥** | `æ— æ³•è§£æåŸŸå` | å¤åˆ¶/etc/resolv.confå’Œ/etc/hosts |

**ğŸ” è°ƒè¯•æŠ€å·§**
```bash
# ä½¿ç”¨straceè°ƒè¯•ç¨‹åºåœ¨chrootä¸­çš„ç³»ç»Ÿè°ƒç”¨
strace -e file chroot /var/chroot/myapp /bin/myapp 2>&1 | grep -E "(ENOENT|No such file)"

# æ£€æŸ¥ç¨‹åºçš„åº“ä¾èµ–
ldd /path/to/binary | grep "not found"

# æµ‹è¯•chrootç¯å¢ƒ
chroot /var/chroot/myapp /bin/sh
# æ‰‹åŠ¨æ‰§è¡Œç¨‹åºï¼Œè§‚å¯Ÿé”™è¯¯ä¿¡æ¯
```

---

## 7. ğŸ“œ æœåŠ¡å¯åŠ¨è„šæœ¬ç¼–å†™


### 7.1 æ ‡å‡†åŒ–å¯åŠ¨è„šæœ¬æ¨¡æ¿


**ğŸ”§ é€šç”¨å¯åŠ¨è„šæœ¬æ¡†æ¶**
```bash
#!/bin/bash
# chrootæœåŠ¡é€šç”¨å¯åŠ¨è„šæœ¬æ¨¡æ¿

# è„šæœ¬é…ç½®åŒºåŸŸ
SERVICE_NAME="myservice"
CHROOT_DIR="/var/chroot/$SERVICE_NAME"
PIDFILE="/var/run/$SERVICE_NAME-chroot.pid"
USER="serviceuser"
BINARY="/bin/$SERVICE_NAME"

# æ—¥å¿—å‡½æ•°
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$SERVICE_NAME] $1"
}

# æ£€æŸ¥chrootç¯å¢ƒ
check_chroot_env() {
    if [ ! -d "$CHROOT_DIR" ]; then
        log_message "é”™è¯¯ï¼šchrootç›®å½• $CHROOT_DIR ä¸å­˜åœ¨"
        exit 1
    fi
    
    if [ ! -f "$CHROOT_DIR$BINARY" ]; then
        log_message "é”™è¯¯ï¼šæœåŠ¡äºŒè¿›åˆ¶æ–‡ä»¶ $CHROOT_DIR$BINARY ä¸å­˜åœ¨"
        exit 1
    fi
}

# å¯åŠ¨æœåŠ¡
start_service() {
    log_message "å¯åŠ¨ $SERVICE_NAME æœåŠ¡..."
    
    check_chroot_env
    
    # æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²ç»åœ¨è¿è¡Œ
    if [ -f "$PIDFILE" ]; then
        local pid=$(cat "$PIDFILE")
        if kill -0 "$pid" 2>/dev/null; then
            log_message "æœåŠ¡å·²ç»åœ¨è¿è¡Œ (PID: $pid)"
            return 1
        else
            rm -f "$PIDFILE"
        fi
    fi
    
    # å¯åŠ¨æœåŠ¡
    chroot "$CHROOT_DIR" "$BINARY" &
    local service_pid=$!
    
    # ä¿å­˜PID
    echo $service_pid > "$PIDFILE"
    log_message "æœåŠ¡å·²å¯åŠ¨ (PID: $service_pid)"
}

# åœæ­¢æœåŠ¡
stop_service() {
    log_message "åœæ­¢ $SERVICE_NAME æœåŠ¡..."
    
    if [ ! -f "$PIDFILE" ]; then
        log_message "æœåŠ¡æœªåœ¨è¿è¡Œ"
        return 1
    fi
    
    local pid=$(cat "$PIDFILE")
    
    # å°è¯•ä¼˜é›…åœæ­¢
    if kill "$pid" 2>/dev/null; then
        sleep 5
        
        # æ£€æŸ¥æ˜¯å¦è¿˜åœ¨è¿è¡Œ
        if kill -0 "$pid" 2>/dev/null; then
            log_message "å¼ºåˆ¶åœæ­¢æœåŠ¡..."
            kill -9 "$pid"
        fi
        
        rm -f "$PIDFILE"
        log_message "æœåŠ¡å·²åœæ­¢"
    else
        log_message "æ— æ³•åœæ­¢æœåŠ¡ (PID: $pid)"
        return 1
    fi
}

# é‡å¯æœåŠ¡
restart_service() {
    stop_service
    sleep 2
    start_service
}

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
status_service() {
    if [ -f "$PIDFILE" ]; then
        local pid=$(cat "$PIDFILE")
        if kill -0 "$pid" 2>/dev/null; then
            log_message "æœåŠ¡æ­£åœ¨è¿è¡Œ (PID: $pid)"
            return 0
        else
            log_message "æœåŠ¡å·²åœæ­¢ï¼ˆPIDæ–‡ä»¶å­˜åœ¨ä½†è¿›ç¨‹ä¸å­˜åœ¨ï¼‰"
            rm -f "$PIDFILE"
            return 1
        fi
    else
        log_message "æœåŠ¡å·²åœæ­¢"
        return 1
    fi
}

# ä¸»é€»è¾‘
case "$1" in
    start)
        start_service
        ;;
    stop)
        stop_service
        ;;
    restart)
        restart_service
        ;;
    status)
        status_service
        ;;
    *)
        echo "ç”¨æ³•: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac
```

### 7.2 systemdæœåŠ¡æ–‡ä»¶


**âš™ï¸ systemdæœåŠ¡å•å…ƒæ–‡ä»¶**
```ini
# /etc/systemd/system/myservice-chroot.service
[Unit]
Description=My Service in chroot environment
After=network.target
Wants=network.target

[Service]
Type=forking
User=root
Group=root
WorkingDirectory=/var/chroot/myservice
ExecStartPre=/usr/local/bin/check-chroot-env.sh myservice
ExecStart=/usr/bin/chroot /var/chroot/myservice /bin/myservice --daemon
ExecStop=/bin/kill -TERM $MAINPID
PIDFile=/var/run/myservice-chroot.pid
Restart=on-failure
RestartSec=5

# å®‰å…¨è®¾ç½®
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ReadWritePaths=/var/chroot/myservice

[Install]
WantedBy=multi-user.target
```

**ğŸ” ç¯å¢ƒæ£€æŸ¥è„šæœ¬**
```bash
#!/bin/bash
# /usr/local/bin/check-chroot-env.sh

SERVICE=$1
CHROOT_DIR="/var/chroot/$SERVICE"

# æ£€æŸ¥chrootç›®å½•
if [ ! -d "$CHROOT_DIR" ]; then
    echo "é”™è¯¯ï¼šchrootç›®å½•ä¸å­˜åœ¨"
    exit 1
fi

# æ£€æŸ¥å…³é”®æ–‡ä»¶
REQUIRED_FILES=(
    "bin/$SERVICE"
    "lib/libc.so.6"
    "etc/passwd"
    "dev/null"
)

for file in "${REQUIRED_FILES[@]}"; do
    if [ ! -e "$CHROOT_DIR/$file" ]; then
        echo "è­¦å‘Šï¼šç¼ºå¤±æ–‡ä»¶ $file"
    fi
done

echo "chrootç¯å¢ƒæ£€æŸ¥å®Œæˆ"
```

---

## 8. ğŸ—ï¸ å¤šæœåŠ¡éš”ç¦»æ¶æ„


### 8.1 å¤šæœåŠ¡éš”ç¦»æ¶æ„è®¾è®¡


**ğŸ¯ æ¶æ„è®¾è®¡åŸåˆ™**
```
éš”ç¦»åŸåˆ™ï¼š
- æ¯ä¸ªæœåŠ¡ç‹¬ç«‹çš„chrootç¯å¢ƒ
- æœåŠ¡é—´é€šè¿‡ç½‘ç»œé€šä¿¡
- å…±äº«èµ„æºæœ€å°åŒ–
- ç»Ÿä¸€ç®¡ç†å’Œç›‘æ§

ç›®å½•ç»“æ„ï¼š
/var/chroot/
â”œâ”€â”€ web/          # WebæœåŠ¡å™¨
â”œâ”€â”€ database/     # æ•°æ®åº“æœåŠ¡
â”œâ”€â”€ cache/        # ç¼“å­˜æœåŠ¡
â”œâ”€â”€ api/          # APIæœåŠ¡
â””â”€â”€ shared/       # å…±äº«èµ„æºï¼ˆåªè¯»ï¼‰
```

### 8.2 æœåŠ¡é—´é€šä¿¡è®¾è®¡


**ğŸŒ ç½‘ç»œé€šä¿¡æ¶æ„**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web Service   â”‚    â”‚   API Service   â”‚
â”‚  (chroot: web)  â”‚    â”‚  (chroot: api)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ HTTP                 â”‚ HTTP
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚    Load Balancer     â”‚
     â”‚   (Host System)      â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   Database Service   â”‚    â”‚  Cache Service  â”‚
     â”‚ (chroot: database)   â”‚    â”‚ (chroot: cache) â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš™ï¸ æœåŠ¡é…ç½®ç®¡ç†**
```bash
#!/bin/bash
# å¤šæœåŠ¡chrootç®¡ç†è„šæœ¬

SERVICES=("web" "api" "database" "cache")
CHROOT_BASE="/var/chroot"

# åˆå§‹åŒ–æ‰€æœ‰æœåŠ¡çš„chrootç¯å¢ƒ
init_all_services() {
    for service in "${SERVICES[@]}"; do
        echo "åˆå§‹åŒ– $service æœåŠ¡çš„chrootç¯å¢ƒ..."
        
        # åˆ›å»ºåŸºç¡€ç›®å½•
        mkdir -p "$CHROOT_BASE/$service"/{bin,lib,lib64,etc,tmp,var/log}
        
        # è®¾ç½®æƒé™
        chmod 755 "$CHROOT_BASE/$service"
        chmod 1777 "$CHROOT_BASE/$service/tmp"
        
        # å¤åˆ¶åŸºç¡€ç³»ç»Ÿæ–‡ä»¶
        cp /etc/passwd "$CHROOT_BASE/$service/etc/"
        cp /etc/group "$CHROOT_BASE/$service/etc/"
        cp /etc/hosts "$CHROOT_BASE/$service/etc/"
        
        # åˆ›å»ºè®¾å¤‡æ–‡ä»¶
        mknod "$CHROOT_BASE/$service/dev/null" c 1 3
        mknod "$CHROOT_BASE/$service/dev/zero" c 1 5
        
        echo "$service æœåŠ¡ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
    done
}

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
start_all_services() {
    for service in "${SERVICES[@]}"; do
        echo "å¯åŠ¨ $service æœåŠ¡..."
        systemctl start "$service-chroot.service"
    done
}

# åœæ­¢æ‰€æœ‰æœåŠ¡
stop_all_services() {
    for service in "${SERVICES[@]}"; do
        echo "åœæ­¢ $service æœåŠ¡..."
        systemctl stop "$service-chroot.service"
    done
}

# æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
status_all_services() {
    for service in "${SERVICES[@]}"; do
        echo "=== $service æœåŠ¡çŠ¶æ€ ==="
        systemctl status "$service-chroot.service" --no-pager -l
        echo ""
    done
}

case "$1" in
    init)
        init_all_services
        ;;
    start)
        start_all_services
        ;;
    stop)
        stop_all_services
        ;;
    status)
        status_all_services
        ;;
    *)
        echo "ç”¨æ³•: $0 {init|start|stop|status}"
        exit 1
        ;;
esac
```

### 8.3 ç»Ÿä¸€ç›‘æ§å’Œæ—¥å¿—


**ğŸ“Š ç›‘æ§é…ç½®**
```bash
# /etc/systemd/system/chroot-monitor.service
[Unit]
Description=Chroot Services Monitor
After=multi-user.target

[Service]
Type=simple
ExecStart=/usr/local/bin/chroot-monitor.sh
Restart=always
RestartSec=30

[Install]
WantedBy=multi-user.target
```

**ğŸ” ç›‘æ§è„šæœ¬**
```bash
#!/bin/bash
# /usr/local/bin/chroot-monitor.sh

SERVICES=("web" "api" "database" "cache")
LOG_FILE="/var/log/chroot-monitor.log"

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" | tee -a "$LOG_FILE"
}

check_service() {
    local service=$1
    local chroot_dir="/var/chroot/$service"
    
    # æ£€æŸ¥chrootç›®å½•æ˜¯å¦å­˜åœ¨
    if [ ! -d "$chroot_dir" ]; then
        log_message "WARNING: $service chrootç›®å½•ä¸å­˜åœ¨"
        return 1
    fi
    
    # æ£€æŸ¥æœåŠ¡è¿›ç¨‹
    if ! systemctl is-active --quiet "$service-chroot.service"; then
        log_message "WARNING: $service æœåŠ¡æœªè¿è¡Œ"
        return 1
    fi
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    local disk_usage=$(df "$chroot_dir" | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ "$disk_usage" -gt 80 ]; then
        log_message "WARNING: $service chrootç›®å½•ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: $disk_usage%"
    fi
    
    return 0
}

# ä¸»ç›‘æ§å¾ªç¯
while true; do
    all_ok=true
    
    for service in "${SERVICES[@]}"; do
        if ! check_service "$service"; then
            all_ok=false
        fi
    done
    
    if [ "$all_ok" = true ]; then
        log_message "INFO: æ‰€æœ‰chrootæœåŠ¡è¿è¡Œæ­£å¸¸"
    fi
    
    sleep 60
done
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ WebæœåŠ¡å™¨éš”ç¦»ï¼šApache/Nginxåœ¨å—é™ç¯å¢ƒä¸­å®‰å…¨è¿è¡Œ
ğŸ”¸ DNSæœåŠ¡éš”ç¦»ï¼šBINDç­‰DNSæœåŠ¡çš„ç›‘ç‹±ç¯å¢ƒé…ç½®
ğŸ”¸ FTPæœåŠ¡éš”ç¦»ï¼švsftpdç­‰FTPæœåŠ¡çš„ç”¨æˆ·ç›®å½•é™åˆ¶
ğŸ”¸ SSHæœåŠ¡é™åˆ¶ï¼šSFTPç”¨æˆ·çš„ç›®å½•è®¿é—®æ§åˆ¶
ğŸ”¸ æ•°æ®åº“éš”ç¦»ï¼šMySQL/PostgreSQLçš„å®‰å…¨è¿è¡Œç¯å¢ƒ
ğŸ”¸ åº”ç”¨é€‚é…ï¼šè‡ªå®šä¹‰ç¨‹åºçš„chrootç¯å¢ƒé€‚é…æ–¹æ³•
ğŸ”¸ è„šæœ¬ç¼–å†™ï¼šæ ‡å‡†åŒ–çš„æœåŠ¡å¯åŠ¨å’Œç®¡ç†è„šæœ¬
ğŸ”¸ æ¶æ„è®¾è®¡ï¼šå¤šæœåŠ¡éš”ç¦»çš„æ•´ä½“æ¶æ„è§„åˆ’
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æœåŠ¡éš”ç¦»çš„æ ¸å¿ƒä»·å€¼**
```
å®‰å…¨é˜²æŠ¤ï¼š
- é™åˆ¶æ”»å‡»è€…çš„æ´»åŠ¨èŒƒå›´
- ä¿æŠ¤ç³»ç»Ÿé‡è¦æ–‡ä»¶ä¸è¢«è®¿é—®
- å‡å°‘æƒé™å‡çº§çš„é£é™©
- ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ

è¿ç»´ä¾¿åˆ©ï¼š
- ä¾¿äºæœåŠ¡çš„ç‹¬ç«‹ç®¡ç†
- ç®€åŒ–å®‰å…¨é…ç½®
- ä¾¿äºé—®é¢˜å®šä½å’Œè°ƒè¯•
- æ”¯æŒæœåŠ¡çš„ç‹¬ç«‹å‡çº§
```

**ğŸ”¹ å¸¸è§é…ç½®é™·é˜±**
```
ç›®å½•æƒé™é—®é¢˜ï¼š
- chrootç›®å½•å¿…é¡»ç”±rootæ‹¥æœ‰
- å­ç›®å½•æ‰èƒ½ç»™æœåŠ¡ç”¨æˆ·å†™æƒé™
- /tmpç›®å½•å¿…é¡»è®¾ç½®ç²˜æ»ä½(1777)

ä¾èµ–æ–‡ä»¶ç¼ºå¤±ï¼š
- åŠ¨æ€åº“æ–‡ä»¶å¿…é¡»å®Œæ•´å¤åˆ¶
- é…ç½®æ–‡ä»¶è·¯å¾„å¿…é¡»æ­£ç¡®
- è®¾å¤‡æ–‡ä»¶(/dev/nullç­‰)å¿…é¡»å­˜åœ¨

ç”¨æˆ·æƒé™é…ç½®ï¼š
- /etc/passwdå’Œ/etc/groupå¿…é¡»å¤åˆ¶
- æœåŠ¡ç”¨æˆ·åœ¨ç›‘ç‹±å†…å¿…é¡»å­˜åœ¨
- ç»„æƒé™è®¾ç½®è¦æ­£ç¡®
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¼ä¸šåº”ç”¨åœºæ™¯**
- **Webæ‰˜ç®¡æœåŠ¡**ï¼šä¸ºå®¢æˆ·æä¾›å®‰å…¨çš„Webè¿è¡Œç¯å¢ƒ
- **å¤šç§Ÿæˆ·ç³»ç»Ÿ**ï¼šä¸åŒå®¢æˆ·çš„æœåŠ¡å®Œå…¨éš”ç¦»
- **å¼€å‘æµ‹è¯•ç¯å¢ƒ**ï¼šå®‰å…¨çš„ä»£ç æµ‹è¯•å’Œè°ƒè¯•ç¯å¢ƒ
- **ç¬¬ä¸‰æ–¹æœåŠ¡æ¥å…¥**ï¼šé™åˆ¶å¤–éƒ¨æœåŠ¡çš„ç³»ç»Ÿè®¿é—®æƒé™

**ğŸ”§ è¿ç»´æœ€ä½³å®è·µ**
- **æ ‡å‡†åŒ–éƒ¨ç½²**ï¼šä½¿ç”¨è„šæœ¬è‡ªåŠ¨åŒ–chrootç¯å¢ƒåˆ›å»º
- **ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶ç›‘æ§éš”ç¦»æœåŠ¡çš„è¿è¡ŒçŠ¶æ€
- **å®šæœŸç»´æŠ¤**ï¼šåŠæ—¶æ›´æ–°ç›‘ç‹±ç¯å¢ƒä¸­çš„ç³»ç»Ÿæ–‡ä»¶
- **æ–‡æ¡£ç®¡ç†**ï¼šè¯¦ç»†è®°å½•æ¯ä¸ªæœåŠ¡çš„éš”ç¦»é…ç½®

### 9.4 å­¦ä¹ å»ºè®®


**ğŸ“š å¾ªåºæ¸è¿›çš„å­¦ä¹ è·¯å¾„**
1. **ä»ç®€å•æœåŠ¡å¼€å§‹**ï¼šå…ˆé…ç½®FTPæˆ–WebæœåŠ¡çš„chroot
2. **ç†è§£ç›®å½•æƒé™**ï¼šæŒæ¡chrootç¯å¢ƒçš„æƒé™è®¾ç½®è§„åˆ™
3. **å­¦ä¼šè°ƒè¯•æŠ€å·§**ï¼šä½¿ç”¨straceç­‰å·¥å…·æ’æŸ¥é—®é¢˜
4. **ç¼–å†™æ ‡å‡†è„šæœ¬**ï¼šåˆ›å»ºå¯é‡ç”¨çš„æœåŠ¡ç®¡ç†è„šæœ¬
5. **è®¾è®¡æ•´ä½“æ¶æ„**ï¼šè§„åˆ’å¤šæœåŠ¡çš„éš”ç¦»éƒ¨ç½²æ–¹æ¡ˆ

**âš ï¸ æ³¨æ„äº‹é¡¹**
- chrootä¸æ˜¯ä¸‡èƒ½çš„å®‰å…¨è§£å†³æ–¹æ¡ˆï¼Œéœ€è¦é…åˆå…¶ä»–å®‰å…¨æªæ–½
- æŸäº›ç³»ç»Ÿè°ƒç”¨å¯èƒ½è®©è¿›ç¨‹è·³å‡ºchrootç›‘ç‹±
- å®šæœŸæ£€æŸ¥å’Œæ›´æ–°ç›‘ç‹±ç¯å¢ƒä¸­çš„æ–‡ä»¶
- ç›‘æ§æœåŠ¡æ€§èƒ½ï¼Œéš”ç¦»å¯èƒ½å¸¦æ¥ä¸€å®šå¼€é”€

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- ğŸ” chrootéš”ç¦» = å®‰å…¨ç›‘ç‹± + æœ‰é™è®¿é—®
- ğŸ“ ç›®å½•æƒé™ = rootæ‹¥æœ‰ç›‘ç‹± + ç”¨æˆ·æ‹¥æœ‰å­ç›®å½•  
- ğŸ”§ ä¾èµ–å®Œæ•´ = åº“æ–‡ä»¶ + é…ç½®æ–‡ä»¶ + è®¾å¤‡æ–‡ä»¶
- ğŸ“œ è„šæœ¬æ ‡å‡† = å¯åŠ¨åœæ­¢ + çŠ¶æ€æ£€æŸ¥ + é”™è¯¯å¤„ç†
- ğŸ—ï¸ æ¶æ„è®¾è®¡ = æœåŠ¡éš”ç¦» + ç½‘ç»œé€šä¿¡ + ç»Ÿä¸€ç®¡ç†