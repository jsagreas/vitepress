---
title: 12ã€é«˜çº§éš”ç¦»æŠ€æœ¯ç»„åˆ
---
## ğŸ“š ç›®å½•

1. [chrootä¸SELinuxç»„åˆ](#1-chrootä¸SELinuxç»„åˆ)
2. [chrootä¸AppArmoré…åˆ](#2-chrootä¸AppArmoré…åˆ)
3. [chrootä¸iptablesé˜²ç«å¢™](#3-chrootä¸iptablesé˜²ç«å¢™)
4. [chrootä¸èµ„æºé™åˆ¶](#4-chrootä¸èµ„æºé™åˆ¶)
5. [å¤šå±‚éš”ç¦»æ¶æ„è®¾è®¡](#5-å¤šå±‚éš”ç¦»æ¶æ„è®¾è®¡)
6. [çºµæ·±é˜²å¾¡ç­–ç•¥](#6-çºµæ·±é˜²å¾¡ç­–ç•¥)
7. [ç»¼åˆå®‰å…¨è¯„ä¼°](#7-ç»¼åˆå®‰å…¨è¯„ä¼°)
8. [æœ€ä½³å®è·µæ€»ç»“](#8-æœ€ä½³å®è·µæ€»ç»“)

---

## 1. ğŸ”’ chrootä¸SELinuxç»„åˆ


### 1.1 SELinuxåŸºç¡€æ¦‚å¿µå›é¡¾


**ä»€ä¹ˆæ˜¯SELinux**

> æƒ³è±¡ä¸€ä¸ªä¸¥æ ¼çš„å…¬å¸å®‰ä¿ç³»ç»Ÿï¼Œä¸ä»…è¦æ£€æŸ¥ä½ çš„å·¥ä½œè¯ï¼ˆä¼ ç»Ÿæƒé™ï¼‰ï¼Œè¿˜è¦æ ¹æ®ä½ çš„èŒåŠ¡ï¼ˆSELinuxæ ‡ç­¾ï¼‰å†³å®šä½ èƒ½è¿›å…¥å“ªäº›åŠå…¬å®¤ã€èƒ½æ“ä½œä»€ä¹ˆè®¾å¤‡ã€‚

```
ä¼ ç»Ÿæƒé™ vs SELinuxå¯¹æ¯”ï¼š

ä¼ ç»Ÿæƒé™ç³»ç»Ÿï¼š                    SELinuxå¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·: alice     â”‚             â”‚ ç”¨æˆ·: alice_u                   â”‚
â”‚ æƒé™: rwx       â”‚      +      â”‚ è§’è‰²: user_r                    â”‚
â”‚ æ–‡ä»¶: /home/... â”‚             â”‚ ç±»å‹: user_home_t               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚ çº§åˆ«: s0                        â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

SELinuxçš„æ ¸å¿ƒè¦ç´ ï¼š
- **ç”¨æˆ·ï¼ˆUserï¼‰**ï¼šSELinuxç”¨æˆ·èº«ä»½
- **è§’è‰²ï¼ˆRoleï¼‰**ï¼šç”¨æˆ·å¯ä»¥æ‹…ä»»çš„è§’è‰²
- **ç±»å‹ï¼ˆTypeï¼‰**ï¼šå¯¹è±¡çš„å®‰å…¨ç±»å‹æ ‡ç­¾
- **çº§åˆ«ï¼ˆLevelï¼‰**ï¼šå¤šçº§å®‰å…¨ç­‰çº§

### 1.2 chroot + SELinuxç»„åˆé…ç½®


**å®é™…é…ç½®æ­¥éª¤**

```bash
# 1. åˆ›å»ºchrootç¯å¢ƒ
mkdir -p /var/chroot/webserver/{bin,lib,lib64,etc,var,tmp,usr}

# 2. è®¾ç½®SELinuxä¸Šä¸‹æ–‡æ ‡ç­¾
# ä¸ºchrootç›®å½•è®¾ç½®ç‰¹æ®Šçš„SELinuxç±»å‹
semanage fcontext -a -t chroot_exec_t "/var/chroot/webserver(/.*)?"
restorecon -R /var/chroot/webserver

# 3. åˆ›å»ºè‡ªå®šä¹‰SELinuxç­–ç•¥
# å…è®¸webæœåŠ¡åœ¨chrootç¯å¢ƒä¸­è¿è¡Œ
cat > webserver_chroot.te << 'EOF'
policy_module(webserver_chroot, 1.0)

type webserver_chroot_t;
type webserver_chroot_exec_t;

# å…è®¸åŸŸè½¬æ¢åˆ°chrootç¯å¢ƒ
domain_auto_trans(unconfined_t, webserver_chroot_exec_t, webserver_chroot_t)

# å…è®¸åœ¨chrootç¯å¢ƒå†…çš„åŸºæœ¬æ“ä½œ
allow webserver_chroot_t self:process { fork signal };
allow webserver_chroot_t chroot_exec_t:file { read execute };
allow webserver_chroot_t tmp_t:dir { read write add_name };
EOF

# 4. ç¼–è¯‘å¹¶å®‰è£…SELinuxç­–ç•¥
make -f /usr/share/selinux/devel/Makefile webserver_chroot.pp
semodule -i webserver_chroot.pp
```

**é…ç½®æ–‡ä»¶ç¤ºä¾‹**

```bash
# å¯åŠ¨è„šæœ¬é…åˆSELinux
#!/bin/bash
# /usr/local/bin/secure_chroot_web.sh

# è®¾ç½®SELinuxä¸Šä¸‹æ–‡
runcon -t webserver_chroot_t -- \
    chroot /var/chroot/webserver \
    /usr/sbin/nginx -g "daemon off;"
```

### 1.3 ç»„åˆä¼˜åŠ¿åˆ†æ


**åŒé‡é˜²æŠ¤æ•ˆæœ**

| **æ”»å‡»åœºæ™¯** | **ä»…chroot** | **ä»…SELinux** | **chroot+SELinux** |
|-------------|-------------|--------------|-------------------|
| **è·¯å¾„éå†æ”»å‡»** | ğŸŸ¡ `éƒ¨åˆ†é˜²æŠ¤` | ğŸŸ¡ `ä¾èµ–ç­–ç•¥` | ğŸŸ¢ `å¼ºåŠ›é˜²æŠ¤` |
| **æƒé™æå‡** | ğŸ”´ `æ— æ³•é˜²æŠ¤` | ğŸŸ¢ `æœ‰æ•ˆé˜²æŠ¤` | ğŸŸ¢ `åŒé‡é˜²æŠ¤` |
| **æ–‡ä»¶è®¿é—®æ§åˆ¶** | ğŸŸ¡ `è·¯å¾„é™åˆ¶` | ğŸŸ¢ `ç±»å‹æ§åˆ¶` | ğŸŸ¢ `å…¨é¢æ§åˆ¶` |
| **ç½‘ç»œè®¿é—®** | ğŸ”´ `æ— é™åˆ¶` | ğŸŸ¢ `ç­–ç•¥æ§åˆ¶` | ğŸŸ¢ `ç­–ç•¥æ§åˆ¶` |

---

## 2. ğŸ›¡ï¸ chrootä¸AppArmoré…åˆ


### 2.1 AppArmorå·¥ä½œåŸç†


**AppArmor vs SELinuxå¯¹æ¯”**

> AppArmorå°±åƒç»™æ¯ä¸ªç¨‹åºåˆ¶å®šä¸€ä»½"è¡Œä¸ºå®ˆåˆ™"ï¼Œæ˜ç¡®è§„å®šå®ƒèƒ½è®¿é—®å“ªäº›æ–‡ä»¶ã€èƒ½æ‰§è¡Œä»€ä¹ˆæ“ä½œã€‚ç›¸æ¯”SELinuxçš„å¤æ‚æ ‡ç­¾ç³»ç»Ÿï¼ŒAppArmoræ›´ç›´è§‚æ˜“æ‡‚ã€‚

```
AppArmoré…ç½®æ–‡ä»¶ç»“æ„ï¼š

/etc/apparmor.d/nginx_chroot
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ #include <tunables/global>              â”‚
â”‚                                         â”‚
â”‚ /var/chroot/webserver/usr/sbin/nginx {  â”‚
â”‚   #include <abstractions/base>          â”‚
â”‚                                         â”‚
â”‚   # å…è®¸çš„æ–‡ä»¶è®¿é—®                      â”‚
â”‚   /var/chroot/webserver/** r,           â”‚
â”‚   /var/chroot/webserver/var/log/** w,   â”‚
â”‚   /var/chroot/webserver/tmp/** rw,      â”‚
â”‚                                         â”‚
â”‚   # ç½‘ç»œæƒé™                           â”‚
â”‚   network inet tcp,                     â”‚
â”‚   network inet udp,                     â”‚
â”‚                                         â”‚
â”‚   # ç³»ç»Ÿè°ƒç”¨é™åˆ¶                        â”‚
â”‚   capability setgid,                    â”‚
â”‚   capability setuid,                    â”‚
â”‚ }                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å®é™…é…ç½®ç¤ºä¾‹


**å®Œæ•´çš„AppArmor + chrooté…ç½®**

```bash
# 1. åˆ›å»ºAppArmoré…ç½®æ–‡ä»¶
cat > /etc/apparmor.d/chroot.web.server << 'EOF'
#include <tunables/global>

/usr/local/bin/chroot_wrapper {
  #include <abstractions/base>
  #include <abstractions/bash>

  # å…è®¸æ‰§è¡Œchrootå‘½ä»¤
  /usr/sbin/chroot ix,
  
  # chrootç¯å¢ƒè·¯å¾„
  /var/chroot/webserver/ r,
  /var/chroot/webserver/** r,
  /var/chroot/webserver/var/log/** w,
  /var/chroot/webserver/tmp/** rw,
  /var/chroot/webserver/var/run/** rw,

  # ç¦æ­¢è®¿é—®æ•æ„Ÿç³»ç»Ÿç›®å½•
  deny /etc/shadow r,
  deny /etc/passwd w,
  deny /proc/*/mem r,
  deny /sys/** w,

  # ç½‘ç»œè®¿é—®é™åˆ¶
  network inet stream,
  network inet dgram,

  # è¿›ç¨‹æ§åˆ¶èƒ½åŠ›
  capability setuid,
  capability setgid,
  capability chroot,
}

# ä¸ºchrootå†…çš„ç¨‹åºåˆ›å»ºé…ç½®
/var/chroot/webserver/usr/sbin/nginx {
  #include <abstractions/base>
  
  # ä¸¥æ ¼é™åˆ¶åªèƒ½è®¿é—®chrootç¯å¢ƒå†…çš„æ–‡ä»¶
  /var/chroot/webserver/etc/nginx/** r,
  /var/chroot/webserver/usr/share/nginx/** r,
  /var/chroot/webserver/var/log/nginx/** w,
  /var/chroot/webserver/var/run/nginx.pid w,

  # ç½‘ç»œç»‘å®š
  network inet tcp,
  
  # ç¦æ­¢æ‰€æœ‰å…¶ä»–è®¿é—®
  deny /** w,
}
EOF

# 2. å¯ç”¨AppArmoré…ç½®
apparmor_parser -r /etc/apparmor.d/chroot.web.server

# 3. æ£€æŸ¥é…ç½®çŠ¶æ€
aa-status | grep chroot
```

### 2.3 ç›‘æ§å’Œè°ƒè¯•


**AppArmoræ—¥å¿—ç›‘æ§**

```bash
# å®æ—¶ç›‘æ§AppArmoræ‹’ç»äº‹ä»¶
tail -f /var/log/audit/audit.log | grep -i apparmor

# æŸ¥çœ‹è¢«æ‹’ç»çš„æ“ä½œ
aa-logprof

# å…¸å‹çš„æ‹’ç»æ—¥å¿—ç¤ºä¾‹ï¼š
# audit: type=1400 audit: apparmor="DENIED" operation="open" 
# profile="/usr/sbin/nginx" name="/etc/passwd" pid=1234 comm="nginx"
```

---

## 3. ğŸ”¥ chrootä¸iptablesé˜²ç«å¢™


### 3.1 ç½‘ç»œéš”ç¦»ç­–ç•¥


**ä¸ºä»€ä¹ˆéœ€è¦ç½‘ç»œéš”ç¦»**

> chrootåªèƒ½é™åˆ¶æ–‡ä»¶ç³»ç»Ÿè®¿é—®ï¼Œå°±åƒæŠŠäººé”åœ¨æˆ¿é—´é‡Œï¼Œä½†å¦‚æœæˆ¿é—´é‡Œæœ‰ç”µè¯ï¼Œä»–è¿˜æ˜¯èƒ½å¯¹å¤–è”ç³»ã€‚iptablesé˜²ç«å¢™å°±æ˜¯è¦æŠŠè¿™ä¸ª"ç”µè¯çº¿"ä¹Ÿç®¡æ§èµ·æ¥ã€‚

```
ç½‘ç»œè®¿é—®æ§åˆ¶å±‚æ¬¡ï¼š

åº”ç”¨ç¨‹åºç½‘ç»œè¯·æ±‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      iptablesè§„åˆ™æ£€æŸ¥        â”‚
â”‚  â€¢ æºIPåœ°å€æ£€æŸ¥             â”‚
â”‚  â€¢ ç›®æ ‡ç«¯å£æ£€æŸ¥             â”‚  
â”‚  â€¢ åè®®ç±»å‹æ£€æŸ¥             â”‚
â”‚  â€¢ è¿æ¥çŠ¶æ€æ£€æŸ¥             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      chrootç¯å¢ƒæ£€æŸ¥         â”‚
â”‚  â€¢ æ–‡ä»¶ç³»ç»Ÿéš”ç¦»             â”‚
â”‚  â€¢ ç³»ç»Ÿè°ƒç”¨é™åˆ¶             â”‚
â”‚  â€¢ è¿›ç¨‹ç©ºé—´éš”ç¦»             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
      å…è®¸/æ‹’ç»è¯·æ±‚
```

### 3.2 iptablesè§„åˆ™é…ç½®


**å…·ä½“çš„é˜²ç«å¢™è§„åˆ™**

```bash
#!/bin/bash
# chroot_firewall.sh - ä¸ºchrootç¯å¢ƒé…ç½®ä¸“ç”¨é˜²ç«å¢™è§„åˆ™

# 1. åˆ›å»ºä¸“ç”¨é“¾
iptables -t filter -N CHROOT_INPUT
iptables -t filter -N CHROOT_OUTPUT
iptables -t nat -N CHROOT_NAT

# 2. è¯†åˆ«chrootè¿›ç¨‹çš„ç½‘ç»œæµé‡
# ä½¿ç”¨cgroupæˆ–è€…è¿›ç¨‹æ ‡è®°æ¥è¯†åˆ«chrootè¿›ç¨‹
# å‡è®¾chrootè¿›ç¨‹è¿è¡Œåœ¨ç‰¹å®šçš„ç”¨æˆ·IDä¸‹

CHROOT_UID=1001  # chrootç¯å¢ƒä¸“ç”¨ç”¨æˆ·ID

# 3. å…¥ç«™è§„åˆ™ - é™åˆ¶chrootè¿›ç¨‹èƒ½æ¥æ”¶çš„è¿æ¥
iptables -A INPUT -m owner --uid-owner $CHROOT_UID -j CHROOT_INPUT

# åªå…è®¸HTTPå’ŒHTTPSç«¯å£
iptables -A CHROOT_INPUT -p tcp --dport 80 -j ACCEPT
iptables -A CHROOT_INPUT -p tcp --dport 443 -j ACCEPT
iptables -A CHROOT_INPUT -j LOG --log-prefix "CHROOT_DENIED_IN: "
iptables -A CHROOT_INPUT -j DROP

# 4. å‡ºç«™è§„åˆ™ - é™åˆ¶chrootè¿›ç¨‹çš„å¯¹å¤–è¿æ¥
iptables -A OUTPUT -m owner --uid-owner $CHROOT_UID -j CHROOT_OUTPUT

# å…è®¸DNSæŸ¥è¯¢
iptables -A CHROOT_OUTPUT -p udp --dport 53 -j ACCEPT
# å…è®¸HTTP/HTTPSå‡ºç«™ï¼ˆç”¨äºæ›´æ–°ç­‰ï¼‰
iptables -A CHROOT_OUTPUT -p tcp --dport 80 -j ACCEPT
iptables -A CHROOT_OUTPUT -p tcp --dport 443 -j ACCEPT
# æ‹’ç»å…¶ä»–æ‰€æœ‰å‡ºç«™è¿æ¥
iptables -A CHROOT_OUTPUT -j LOG --log-prefix "CHROOT_DENIED_OUT: "
iptables -A CHROOT_OUTPUT -j DROP

# 5. NATè§„åˆ™ - å¦‚æœéœ€è¦ç«¯å£è½¬å‘
iptables -t nat -A PREROUTING -p tcp --dport 8080 \
    -j DNAT --to-destination 127.0.0.1:80
```

### 3.3 é«˜çº§ç½‘ç»œéš”ç¦»


**ä½¿ç”¨ç½‘ç»œå‘½åç©ºé—´å¢å¼ºéš”ç¦»**

```bash
#!/bin/bash
# åˆ›å»ºç½‘ç»œå‘½åç©ºé—´é…åˆchrootä½¿ç”¨

# 1. åˆ›å»ºç½‘ç»œå‘½åç©ºé—´
ip netns add chroot_web

# 2. åˆ›å»ºè™šæ‹Ÿç½‘å¡å¯¹
ip link add veth_host type veth peer name veth_chroot

# 3. å°†ä¸€ç«¯ç§»åŠ¨åˆ°å‘½åç©ºé—´
ip link set veth_chroot netns chroot_web

# 4. é…ç½®IPåœ°å€
ip addr add 192.168.100.1/24 dev veth_host
ip netns exec chroot_web ip addr add 192.168.100.2/24 dev veth_chroot

# 5. å¯ç”¨æ¥å£
ip link set veth_host up
ip netns exec chroot_web ip link set veth_chroot up
ip netns exec chroot_web ip link set lo up

# 6. é…ç½®è·¯ç”±
ip netns exec chroot_web ip route add default via 192.168.100.1

# 7. åœ¨ç½‘ç»œå‘½åç©ºé—´ä¸­å¯åŠ¨chroot
ip netns exec chroot_web \
    chroot /var/chroot/webserver \
    /usr/sbin/nginx -g "daemon off;"
```

---

## 4. ğŸ“Š chrootä¸èµ„æºé™åˆ¶


### 4.1 systemdèµ„æºæ§åˆ¶


**ä½¿ç”¨systemdç®¡ç†chrootè¿›ç¨‹èµ„æº**

> å°±åƒç»™æ¯ä¸ªéƒ¨é—¨åˆ†é…å›ºå®šçš„é¢„ç®—ä¸€æ ·ï¼Œæˆ‘ä»¬è¦ç»™chrootç¯å¢ƒåˆ†é…å›ºå®šçš„ç³»ç»Ÿèµ„æºï¼Œé˜²æ­¢å®ƒæ¶ˆè€—è¿‡å¤šèµ„æºå½±å“æ•´ä¸ªç³»ç»Ÿã€‚

```bash
# åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶
cat > /etc/systemd/system/chroot-web.service << 'EOF'
[Unit]
Description=Chroot Web Server with Resource Limits
After=network.target

[Service]
Type=forking
User=chroot_web
Group=chroot_web
ExecStart=/usr/local/bin/start_chroot_web.sh
ExecStop=/usr/local/bin/stop_chroot_web.sh

# CPUé™åˆ¶ - æœ€å¤šä½¿ç”¨50%çš„CPU
CPUQuota=50%

# å†…å­˜é™åˆ¶ - æœ€å¤šä½¿ç”¨512MBå†…å­˜
MemoryLimit=512M
MemoryMax=512M

# è¿›ç¨‹æ•°é™åˆ¶
TasksMax=100

# æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
LimitNOFILE=1024

# ç¦æ­¢è®¿é—®æŸäº›ç³»ç»Ÿè°ƒç”¨
SystemCallFilter=@system-service
SystemCallFilter=~@debug @mount @cpu-emulation @obsolete

# æ–‡ä»¶ç³»ç»Ÿéš”ç¦»å¢å¼º
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
NoNewPrivileges=true

# ç½‘ç»œéš”ç¦»
PrivateNetwork=false
RestrictAddressFamilies=AF_INET AF_INET6

[Install]
WantedBy=multi-user.target
EOF
```

### 4.2 cgroupsè¯¦ç»†é…ç½®


**æ‰‹åŠ¨é…ç½®cgroupsèµ„æºé™åˆ¶**

```bash
#!/bin/bash
# æ‰‹åŠ¨åˆ›å»ºå’Œé…ç½®cgroups

# 1. åˆ›å»ºä¸“ç”¨çš„cgroup
mkdir -p /sys/fs/cgroup/memory/chroot_web
mkdir -p /sys/fs/cgroup/cpu/chroot_web
mkdir -p /sys/fs/cgroup/pids/chroot_web

# 2. è®¾ç½®å†…å­˜é™åˆ¶ï¼ˆ512MBï¼‰
echo 536870912 > /sys/fs/cgroup/memory/chroot_web/memory.limit_in_bytes
echo 1 > /sys/fs/cgroup/memory/chroot_web/memory.oom_kill_disable

# 3. è®¾ç½®CPUé™åˆ¶ï¼ˆ50%ï¼‰
echo 50000 > /sys/fs/cgroup/cpu/chroot_web/cpu.cfs_quota_us
echo 100000 > /sys/fs/cgroup/cpu/chroot_web/cpu.cfs_period_us

# 4. è®¾ç½®è¿›ç¨‹æ•°é™åˆ¶
echo 100 > /sys/fs/cgroup/pids/chroot_web/pids.max

# 5. å¯åŠ¨è¿›ç¨‹å¹¶åŠ å…¥cgroup
chroot /var/chroot/webserver /usr/sbin/nginx &
NGINX_PID=$!

# å°†è¿›ç¨‹åŠ å…¥å„ä¸ªcgroup
echo $NGINX_PID > /sys/fs/cgroup/memory/chroot_web/cgroup.procs
echo $NGINX_PID > /sys/fs/cgroup/cpu/chroot_web/cgroup.procs
echo $NGINX_PID > /sys/fs/cgroup/pids/chroot_web/cgroup.procs
```

### 4.3 èµ„æºç›‘æ§è„šæœ¬


**å®æ—¶ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ**

```bash
#!/bin/bash
# ç›‘æ§chrootç¯å¢ƒèµ„æºä½¿ç”¨æƒ…å†µ

monitor_chroot_resources() {
    local chroot_path="/var/chroot/webserver"
    local cgroup_path="/sys/fs/cgroup"
    
    while true; do
        echo "=== Chrootèµ„æºä½¿ç”¨æŠ¥å‘Š $(date) ==="
        
        # å†…å­˜ä½¿ç”¨æƒ…å†µ
        local mem_usage=$(cat $cgroup_path/memory/chroot_web/memory.usage_in_bytes)
        local mem_limit=$(cat $cgroup_path/memory/chroot_web/memory.limit_in_bytes)
        local mem_percent=$((mem_usage * 100 / mem_limit))
        echo "å†…å­˜ä½¿ç”¨: $(($mem_usage / 1024 / 1024))MB / $(($mem_limit / 1024 / 1024))MB ($mem_percent%)"
        
        # CPUä½¿ç”¨æƒ…å†µ
        local cpu_usage=$(cat $cgroup_path/cpu/chroot_web/cpuacct.usage)
        echo "CPUç´¯è®¡ä½¿ç”¨æ—¶é—´: $(($cpu_usage / 1000000000))ç§’"
        
        # è¿›ç¨‹æ•°é‡
        local pid_current=$(cat $cgroup_path/pids/chroot_web/pids.current 2>/dev/null || echo "0")
        local pid_max=$(cat $cgroup_path/pids/chroot_web/pids.max 2>/dev/null || echo "unlimited")
        echo "è¿›ç¨‹æ•°: $pid_current / $pid_max"
        
        # ç£ç›˜ä½¿ç”¨æƒ…å†µ
        echo "ç£ç›˜ä½¿ç”¨:"
        du -sh $chroot_path
        
        echo "=========================="
        sleep 10
    done
}

# å¯åŠ¨ç›‘æ§
monitor_chroot_resources
```

---

## 5. ğŸ—ï¸ å¤šå±‚éš”ç¦»æ¶æ„è®¾è®¡


### 5.1 åˆ†å±‚éš”ç¦»æ¨¡å‹


**å®Œæ•´çš„éš”ç¦»æ¶æ„å›¾**

```
å¤šå±‚éš”ç¦»å®‰å…¨æ¶æ„ï¼š

                    å¤–éƒ¨ç½‘ç»œè¯·æ±‚
                          â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           ç¬¬1å±‚ï¼šç½‘ç»œéš”ç¦»                â”‚
    â”‚  â€¢ iptablesé˜²ç«å¢™è§„åˆ™                   â”‚
    â”‚  â€¢ ç½‘ç»œå‘½åç©ºé—´                         â”‚
    â”‚  â€¢ ç«¯å£è®¿é—®æ§åˆ¶                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           ç¬¬2å±‚ï¼šç³»ç»Ÿéš”ç¦»                â”‚
    â”‚  â€¢ chrootæ–‡ä»¶ç³»ç»Ÿéš”ç¦»                   â”‚
    â”‚  â€¢ ç”¨æˆ·æƒé™éš”ç¦»                         â”‚
    â”‚  â€¢ è¿›ç¨‹ç©ºé—´éš”ç¦»                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           ç¬¬3å±‚ï¼šè®¿é—®æ§åˆ¶                â”‚
    â”‚  â€¢ SELinux/AppArmorç­–ç•¥                â”‚
    â”‚  â€¢ å¼ºåˆ¶è®¿é—®æ§åˆ¶                         â”‚
    â”‚  â€¢ ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           ç¬¬4å±‚ï¼šèµ„æºæ§åˆ¶                â”‚
    â”‚  â€¢ cgroupsèµ„æºé™åˆ¶                     â”‚
    â”‚  â€¢ å†…å­˜/CPU/è¿›ç¨‹é™åˆ¶                    â”‚
    â”‚  â€¢ I/Oå¸¦å®½æ§åˆ¶                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
                    åº”ç”¨ç¨‹åºè¿è¡Œ
```

### 5.2 å®Œæ•´éƒ¨ç½²è„šæœ¬


**ä¸€é”®éƒ¨ç½²å¤šå±‚éš”ç¦»ç¯å¢ƒ**

```bash
#!/bin/bash
# deploy_secure_chroot.sh - éƒ¨ç½²å®Œæ•´çš„å¤šå±‚éš”ç¦»ç¯å¢ƒ

set -e

# é…ç½®å˜é‡
CHROOT_PATH="/var/chroot/webserver"
CHROOT_USER="chroot_web"
CHROOT_UID=1001

echo "å¼€å§‹éƒ¨ç½²å¤šå±‚éš”ç¦»chrootç¯å¢ƒ..."

# 1. åˆ›å»ºchrootç”¨æˆ·å’Œç›®å½•
setup_chroot_environment() {
    echo "1. è®¾ç½®chrootç¯å¢ƒ..."
    
    # åˆ›å»ºä¸“ç”¨ç”¨æˆ·
    useradd -u $CHROOT_UID -r -s /bin/false $CHROOT_USER
    
    # åˆ›å»ºchrootç›®å½•ç»“æ„
    mkdir -p $CHROOT_PATH/{bin,lib,lib64,etc,var,tmp,usr,proc,sys,dev}
    
    # è®¾ç½®åŸºæœ¬æƒé™
    chown -R $CHROOT_USER:$CHROOT_USER $CHROOT_PATH
    chmod 755 $CHROOT_PATH
    chmod 1777 $CHROOT_PATH/tmp
}

# 2. é…ç½®SELinux/AppArmor
setup_access_control() {
    echo "2. é…ç½®è®¿é—®æ§åˆ¶..."
    
    if command -v semanage >/dev/null 2>&1; then
        # SELinuxé…ç½®
        semanage fcontext -a -t chroot_exec_t "$CHROOT_PATH(/.*)?"
        restorecon -R $CHROOT_PATH
    elif command -v apparmor_parser >/dev/null 2>&1; then
        # AppArmoré…ç½®
        cat > /etc/apparmor.d/chroot.webserver << 'EOF'
/usr/local/bin/chroot_web {
  #include <abstractions/base>
  capability setuid,
  capability setgid,
  capability chroot,
  /var/chroot/webserver/** r,
  /var/chroot/webserver/var/** rw,
  /var/chroot/webserver/tmp/** rw,
}
EOF
        apparmor_parser -r /etc/apparmor.d/chroot.webserver
    fi
}

# 3. é…ç½®é˜²ç«å¢™è§„åˆ™
setup_firewall() {
    echo "3. é…ç½®é˜²ç«å¢™è§„åˆ™..."
    
    # åˆ›å»ºä¸“ç”¨é“¾
    iptables -t filter -N CHROOT_WEB 2>/dev/null || true
    
    # é…ç½®è§„åˆ™
    iptables -A OUTPUT -m owner --uid-owner $CHROOT_UID -j CHROOT_WEB
    iptables -A CHROOT_WEB -p tcp --dport 80 -j ACCEPT
    iptables -A CHROOT_WEB -p tcp --dport 443 -j ACCEPT
    iptables -A CHROOT_WEB -p udp --dport 53 -j ACCEPT
    iptables -A CHROOT_WEB -j LOG --log-prefix "CHROOT_WEB_BLOCKED: "
    iptables -A CHROOT_WEB -j DROP
    
    # ä¿å­˜è§„åˆ™
    service iptables save 2>/dev/null || true
}

# 4. é…ç½®èµ„æºé™åˆ¶
setup_resource_limits() {
    echo "4. é…ç½®èµ„æºé™åˆ¶..."
    
    # åˆ›å»ºsystemdæœåŠ¡
    cat > /etc/systemd/system/chroot-web.service << EOF
[Unit]
Description=Secure Chroot Web Server
After=network.target

[Service]
Type=forking
User=$CHROOT_USER
Group=$CHROOT_USER
ExecStart=/usr/local/bin/start_chroot_web.sh
CPUQuota=50%
MemoryLimit=512M
TasksMax=100
PrivateTmp=true
ProtectSystem=strict
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF
    
    systemctl daemon-reload
}

# 5. åˆ›å»ºå¯åŠ¨è„šæœ¬
create_start_script() {
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    
    cat > /usr/local/bin/start_chroot_web.sh << 'EOF'
#!/bin/bash
# å¯åŠ¨è„šæœ¬ï¼Œé›†æˆæ‰€æœ‰å®‰å…¨æªæ–½

# æŒ‚è½½å¿…è¦çš„æ–‡ä»¶ç³»ç»Ÿ
mount -t proc proc /var/chroot/webserver/proc
mount -t sysfs sysfs /var/chroot/webserver/sys
mount -t tmpfs tmpfs /var/chroot/webserver/tmp

# å¯åŠ¨æœåŠ¡
chroot /var/chroot/webserver /usr/sbin/nginx -g "daemon off;" &
echo $! > /var/run/chroot-web.pid
EOF
    
    chmod +x /usr/local/bin/start_chroot_web.sh
}

# æ‰§è¡Œæ‰€æœ‰è®¾ç½®æ­¥éª¤
setup_chroot_environment
setup_access_control
setup_firewall
setup_resource_limits
create_start_script

echo "å¤šå±‚éš”ç¦»ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
echo "ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨æœåŠ¡ï¼š"
echo "systemctl start chroot-web"
echo "systemctl enable chroot-web"
```

---

## 6. ğŸ›¡ï¸ çºµæ·±é˜²å¾¡ç­–ç•¥


### 6.1 é˜²å¾¡å±‚æ¬¡åˆ†æ


**çºµæ·±é˜²å¾¡çš„æ ¸å¿ƒæ€æƒ³**

> çºµæ·±é˜²å¾¡å°±åƒå¤ä»£åŸå ¡çš„é˜²æŠ¤ä½“ç³»ï¼šæœ€å¤–å±‚æœ‰æŠ¤åŸæ²³ï¼ˆç½‘ç»œé˜²ç«å¢™ï¼‰ï¼Œç„¶åæ˜¯åŸå¢™ï¼ˆç³»ç»Ÿéš”ç¦»ï¼‰ï¼ŒåŸå†…æœ‰é‡å…µæŠŠå®ˆï¼ˆè®¿é—®æ§åˆ¶ï¼‰ï¼Œæœ€æ ¸å¿ƒçš„åœ°æ–¹è¿˜æœ‰å†…å«ï¼ˆèµ„æºç›‘æ§ï¼‰ã€‚

**å„å±‚é˜²å¾¡èƒ½åŠ›å¯¹æ¯”**

| **é˜²å¾¡å±‚æ¬¡** | **é˜²æŠ¤å¯¹è±¡** | **æ”»å‡»ç±»å‹** | **å¤±æ•ˆåœºæ™¯** | **è¡¥å¼ºæªæ–½** |
|-------------|-------------|-------------|-------------|-------------|
| **ç½‘ç»œå±‚** | `ç½‘ç»œæµé‡` | ç½‘ç»œæ”»å‡»ã€DDoS | å†…éƒ¨æ”»å‡» | ä¸»æœºé˜²ç«å¢™ |
| **ç³»ç»Ÿå±‚** | `æ–‡ä»¶ç³»ç»Ÿ` | è·¯å¾„éå†ã€ææƒ | å†…æ ¸æ¼æ´ | è®¿é—®æ§åˆ¶å¢å¼º |
| **åº”ç”¨å±‚** | `ç¨‹åºè¡Œä¸º` | ä»£ç æ‰§è¡Œã€æ³¨å…¥ | ç­–ç•¥ç»•è¿‡ | è¡Œä¸ºç›‘æ§ |
| **èµ„æºå±‚** | `ç³»ç»Ÿèµ„æº` | èµ„æºè€—å°½æ”»å‡» | é…ç½®ä¸å½“ | å®æ—¶ç›‘æ§å‘Šè­¦ |

### 6.2 æ”»å‡»é“¾é˜»æ–­ç­–ç•¥


**å¸¸è§æ”»å‡»è·¯å¾„åŠé˜»æ–­ç‚¹**

```
Webåº”ç”¨æ”»å‡»é“¾åŠé˜²æŠ¤ç‚¹ï¼š

åˆå§‹å…¥ä¾µ â†’ æƒé™æå‡ â†’ æ¨ªå‘ç§»åŠ¨ â†’ æ•°æ®çªƒå–
    â†“          â†“          â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç½‘ç»œè¿‡æ»¤ â”‚ â”‚è®¿é—®æ§åˆ¶ â”‚ â”‚ç½‘ç»œéš”ç¦» â”‚ â”‚æ•°æ®ä¿æŠ¤ â”‚
â”‚iptables â”‚ â”‚SELinux  â”‚ â”‚Network  â”‚ â”‚åŠ å¯†å­˜å‚¨ â”‚
â”‚è§„åˆ™     â”‚ â”‚ç­–ç•¥     â”‚ â”‚Namespaceâ”‚ â”‚è®¿é—®å®¡è®¡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 ç›‘æ§å’Œå“åº”æœºåˆ¶


**ç»¼åˆç›‘æ§è„šæœ¬**

```bash
#!/bin/bash
# security_monitor.sh - ç»¼åˆå®‰å…¨ç›‘æ§è„šæœ¬

# é…ç½®
LOG_FILE="/var/log/chroot_security.log"
ALERT_EMAIL="admin@example.com"
CHROOT_PATH="/var/chroot/webserver"

# æ—¥å¿—å‡½æ•°
log_event() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

# æ£€æŸ¥chrootå®Œæ•´æ€§
check_chroot_integrity() {
    # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹
    find $CHROOT_PATH -name "*.conf" -newer /tmp/last_check 2>/dev/null | while read file; do
        log_event "WARNING: é…ç½®æ–‡ä»¶è¢«ä¿®æ”¹: $file"
    done
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„å¯æ‰§è¡Œæ–‡ä»¶
    find $CHROOT_PATH -type f -perm /u+x -newer /tmp/last_check 2>/dev/null | while read file; do
        log_event "WARNING: å‘ç°æ–°çš„å¯æ‰§è¡Œæ–‡ä»¶: $file"
    done
    
    touch /tmp/last_check
}

# æ£€æŸ¥å¼‚å¸¸ç½‘ç»œè¿æ¥
check_network_connections() {
    # æ£€æŸ¥chrootè¿›ç¨‹çš„ç½‘ç»œè¿æ¥
    local chroot_uid=$(id -u chroot_web)
    netstat -tulpn | awk -v uid=$chroot_uid '$7 ~ uid {print $1, $4, $5}' | while read line; do
        log_event "INFO: chrootç½‘ç»œè¿æ¥: $line"
    done
}

# æ£€æŸ¥èµ„æºä½¿ç”¨å¼‚å¸¸
check_resource_usage() {
    # æ£€æŸ¥CPUä½¿ç”¨ç‡
    local cpu_usage=$(top -bn1 | grep "chroot_web" | awk '{print $9}' | head -1)
    if (( $(echo "$cpu_usage > 80" | bc -l) )); then
        log_event "ALERT: CPUä½¿ç”¨ç‡å¼‚å¸¸: $cpu_usage%"
        echo "chrootç¯å¢ƒCPUä½¿ç”¨ç‡è¶…è¿‡80%: $cpu_usage%" | mail -s "å®‰å…¨å‘Šè­¦" $ALERT_EMAIL
    fi
    
    # æ£€æŸ¥å†…å­˜ä½¿ç”¨
    local mem_usage=$(cat /sys/fs/cgroup/memory/chroot_web/memory.usage_in_bytes 2>/dev/null || echo "0")
    local mem_limit=$(cat /sys/fs/cgroup/memory/chroot_web/memory.limit_in_bytes 2>/dev/null || echo "1")
    local mem_percent=$((mem_usage * 100 / mem_limit))
    
    if [ $mem_percent -gt 90 ]; then
        log_event "ALERT: å†…å­˜ä½¿ç”¨ç‡å¼‚å¸¸: $mem_percent%"
    fi
}

# æ£€æŸ¥å®‰å…¨æ—¥å¿—
check_security_logs() {
    # æ£€æŸ¥AppArmor/SELinuxæ‹’ç»äº‹ä»¶
    tail -n 100 /var/log/audit/audit.log | grep -i "denied\|avc" | while read line; do
        log_event "SECURITY: $line"
    done
    
    # æ£€æŸ¥é˜²ç«å¢™æ‹’ç»äº‹ä»¶
    tail -n 100 /var/log/messages | grep "CHROOT_WEB_BLOCKED" | while read line; do
        log_event "FIREWALL: $line"
    done
}

# ä¸»ç›‘æ§å¾ªç¯
main_monitor_loop() {
    while true; do
        check_chroot_integrity
        check_network_connections
        check_resource_usage
        check_security_logs
        
        sleep 60  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    done
}

# å¯åŠ¨ç›‘æ§
log_event "INFO: å¼€å§‹å®‰å…¨ç›‘æ§"
main_monitor_loop
```

---

## 7. ğŸ” ç»¼åˆå®‰å…¨è¯„ä¼°


### 7.1 å®‰å…¨è¯„ä¼°æ¡†æ¶


**è¯„ä¼°ç»´åº¦å’Œæ ‡å‡†**

| **è¯„ä¼°ç»´åº¦** | **è¯„ä¼°æŒ‡æ ‡** | **æ»¡åˆ†** | **è¯„åˆ†æ ‡å‡†** |
|-------------|-------------|---------|-------------|
| **éš”ç¦»å¼ºåº¦** | æ–‡ä»¶ç³»ç»Ÿéš”ç¦»å®Œæ•´æ€§ | 25åˆ† | å®Œå…¨éš”ç¦»(25)ï¼Œéƒ¨åˆ†éš”ç¦»(15)ï¼ŒåŸºç¡€éš”ç¦»(10) |
| **è®¿é—®æ§åˆ¶** | MACç­–ç•¥å®Œå–„ç¨‹åº¦ | 25åˆ† | å…¨ç­–ç•¥(25)ï¼Œéƒ¨åˆ†ç­–ç•¥(15)ï¼Œæ— ç­–ç•¥(0) |
| **ç½‘ç»œå®‰å…¨** | ç½‘ç»œè®¿é—®æ§åˆ¶ | 20åˆ† | ä¸¥æ ¼æ§åˆ¶(20)ï¼ŒåŸºæœ¬æ§åˆ¶(10)ï¼Œæ— æ§åˆ¶(0) |
| **èµ„æºç®¡ç†** | èµ„æºé™åˆ¶å’Œç›‘æ§ | 15åˆ† | å®Œå–„(15)ï¼ŒåŸºç¡€(8)ï¼Œæ— é™åˆ¶(0) |
| **ç›‘æ§å“åº”** | å®‰å…¨ç›‘æ§èƒ½åŠ› | 15åˆ† | å®æ—¶ç›‘æ§(15)ï¼Œå®šæœŸæ£€æŸ¥(8)ï¼Œæ— ç›‘æ§(0) |

### 7.2 å®‰å…¨æµ‹è¯•å·¥å…·


**è‡ªåŠ¨åŒ–å®‰å…¨æµ‹è¯•è„šæœ¬**

```bash
#!/bin/bash
# chroot_security_test.sh - chrootå®‰å…¨æ€§æµ‹è¯•å·¥å…·

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æµ‹è¯•ç»“æœç»Ÿè®¡
TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0

# æµ‹è¯•å‡½æ•°
run_test() {
    local test_name="$1"
    local test_command="$2"
    local expected_result="$3"  # "pass" æˆ– "fail"
    
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    echo -n "æµ‹è¯• $TOTAL_TESTS: $test_name ... "
    
    # æ‰§è¡Œæµ‹è¯•å‘½ä»¤
    eval $test_command >/dev/null 2>&1
    local result=$?
    
    if [[ "$expected_result" == "fail" ]]; then
        # æœŸæœ›å¤±è´¥çš„æµ‹è¯•ï¼ˆå®‰å…¨æªæ–½ç”Ÿæ•ˆï¼‰
        if [ $result -ne 0 ]; then
            echo -e "${GREEN}é€šè¿‡${NC} (å®‰å…¨æªæ–½ç”Ÿæ•ˆ)"
            PASSED_TESTS=$((PASSED_TESTS + 1))
        else
            echo -e "${RED}å¤±è´¥${NC} (å®‰å…¨æ¼æ´)"
            FAILED_TESTS=$((FAILED_TESTS + 1))
        fi
    else
        # æœŸæœ›æˆåŠŸçš„æµ‹è¯•
        if [ $result -eq 0 ]; then
            echo -e "${GREEN}é€šè¿‡${NC}"
            PASSED_TESTS=$((PASSED_TESTS + 1))
        else
            echo -e "${RED}å¤±è´¥${NC}"
            FAILED_TESTS=$((FAILED_TESTS + 1))
        fi
    fi
}

# å…·ä½“æµ‹è¯•é¡¹ç›®
echo "å¼€å§‹chrootç¯å¢ƒå®‰å…¨æµ‹è¯•..."
echo "================================="

# 1. æ–‡ä»¶ç³»ç»Ÿéš”ç¦»æµ‹è¯•
echo "1. æ–‡ä»¶ç³»ç»Ÿéš”ç¦»æµ‹è¯•"
run_test "è®¿é—®ç³»ç»Ÿå…³é”®æ–‡ä»¶" \
    "chroot /var/chroot/webserver /bin/cat /etc/shadow" \
    "fail"

run_test "å°è¯•è®¿é—®ä¸Šçº§ç›®å½•" \
    "chroot /var/chroot/webserver /bin/ls ../../../../etc" \
    "fail"

# 2. ç½‘ç»œè®¿é—®æµ‹è¯•
echo -e "\n2. ç½‘ç»œè®¿é—®æµ‹è¯•"
run_test "è¿æ¥å¤–éƒ¨ä¸å…è®¸ç«¯å£" \
    "timeout 5 su - chroot_web -c 'nc -z 8.8.8.8 22'" \
    "fail"

run_test "DNSè§£æåŠŸèƒ½æ­£å¸¸" \
    "su - chroot_web -c 'nslookup google.com'" \
    "pass"

# 3. æƒé™æå‡æµ‹è¯•
echo -e "\n3. æƒé™æå‡æµ‹è¯•"
run_test "å°è¯•åˆ›å»ºè®¾å¤‡æ–‡ä»¶" \
    "chroot /var/chroot/webserver mknod /tmp/testdev c 1 1" \
    "fail"

run_test "å°è¯•æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ" \
    "chroot /var/chroot/webserver mount -t tmpfs tmpfs /mnt" \
    "fail"

# 4. èµ„æºé™åˆ¶æµ‹è¯•
echo -e "\n4. èµ„æºé™åˆ¶æµ‹è¯•"
run_test "å†…å­˜ä½¿ç”¨é™åˆ¶" \
    "timeout 10 su - chroot_web -c 'python3 -c \"a=[0]*1000000000\"'" \
    "fail"

# 5. MACç­–ç•¥æµ‹è¯•ï¼ˆå¦‚æœå¯ç”¨ï¼‰
echo -e "\n5. å¼ºåˆ¶è®¿é—®æ§åˆ¶æµ‹è¯•"
if command -v getenforce >/dev/null 2>&1 && [[ $(getenforce) == "Enforcing" ]]; then
    run_test "SELinuxç­–ç•¥é™åˆ¶" \
        "runcon -t unconfined_t chroot /var/chroot/webserver /bin/bash -c 'echo test > /tmp/selinux_test'" \
        "fail"
fi

if command -v aa-status >/dev/null 2>&1; then
    run_test "AppArmorç­–ç•¥é™åˆ¶" \
        "chroot /var/chroot/webserver /bin/bash -c 'echo test > /etc/test'" \
        "fail"
fi

# è¾“å‡ºæµ‹è¯•ç»“æœ
echo "================================="
echo "æµ‹è¯•å®Œæˆç»Ÿè®¡:"
echo -e "æ€»æµ‹è¯•æ•°: $TOTAL_TESTS"
echo -e "é€šè¿‡æµ‹è¯•: ${GREEN}$PASSED_TESTS${NC}"
echo -e "å¤±è´¥æµ‹è¯•: ${RED}$FAILED_TESTS${NC}"

# è®¡ç®—å®‰å…¨å¾—åˆ†
SECURITY_SCORE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
echo -e "\nå®‰å…¨è¯„åˆ†: $SECURITY_SCORE/100"

if [ $SECURITY_SCORE -ge 90 ]; then
    echo -e "å®‰å…¨ç­‰çº§: ${GREEN}ä¼˜ç§€${NC}"
elif [ $SECURITY_SCORE -ge 70 ]; then
    echo -e "å®‰å…¨ç­‰çº§: ${YELLOW}è‰¯å¥½${NC}"
else
    echo -e "å®‰å…¨ç­‰çº§: ${RED}éœ€è¦æ”¹è¿›${NC}"
fi
```

---

## 8. ğŸ“‹ æœ€ä½³å®è·µæ€»ç»“


### 8.1 éƒ¨ç½²åŸåˆ™


**å®‰å…¨ç¬¬ä¸€åŸåˆ™**

> åœ¨éƒ¨ç½²chrootéš”ç¦»ç¯å¢ƒæ—¶ï¼Œè¦å§‹ç»ˆéµå¾ª"æœ€å°æƒé™åŸåˆ™"å’Œ"çºµæ·±é˜²å¾¡åŸåˆ™"ï¼Œä¸è¦ä¸ºäº†ä¾¿åˆ©æ€§è€Œç‰ºç‰²å®‰å…¨æ€§ã€‚

**ğŸ”¸ æ ¸å¿ƒéƒ¨ç½²åŸåˆ™**ï¼š

1. **æœ€å°åŒ–åŸåˆ™**
   - åªå®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…
   - åªå¼€æ”¾å¿…è¦çš„ç½‘ç»œç«¯å£
   - åªæˆäºˆå¿…è¦çš„ç³»ç»Ÿæƒé™

2. **åˆ†å±‚é˜²æŠ¤åŸåˆ™**
   - ç½‘ç»œå±‚ï¼šé˜²ç«å¢™è§„åˆ™
   - ç³»ç»Ÿå±‚ï¼šchrootéš”ç¦»
   - åº”ç”¨å±‚ï¼šMACç­–ç•¥
   - èµ„æºå±‚ï¼šcgroupsé™åˆ¶

3. **ç›‘æ§å‘Šè­¦åŸåˆ™**
   - å®æ—¶ç›‘æ§èµ„æºä½¿ç”¨
   - è®°å½•æ‰€æœ‰å®‰å…¨äº‹ä»¶
   - å¼‚å¸¸æƒ…å†µåŠæ—¶å‘Šè­¦

### 8.2 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ


**éƒ¨ç½²å’Œè¿ç»´ä¸­çš„å…¸å‹é—®é¢˜**

| **é—®é¢˜ç±»å‹** | **ç—‡çŠ¶** | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|-------------|---------|-------------|-------------|
| **æœåŠ¡æ— æ³•å¯åŠ¨** | chrootè¿›ç¨‹å¯åŠ¨å¤±è´¥ | ç¼ºå°‘å¿…è¦åº“æ–‡ä»¶ | ä½¿ç”¨lddæ£€æŸ¥ä¾èµ–ï¼Œå¤åˆ¶ç¼ºå¤±æ–‡ä»¶ |
| **ç½‘ç»œè¿æ¥å¼‚å¸¸** | æ— æ³•è®¿é—®å¤–éƒ¨èµ„æº | é˜²ç«å¢™è§„åˆ™è¿‡ä¸¥ | æ£€æŸ¥iptablesè§„åˆ™ï¼Œé€‚å½“æ”¾å®½ |
| **æƒé™é”™è¯¯** | MACç­–ç•¥é˜»æ­¢æ“ä½œ | SELinux/AppArmoré…ç½®é”™è¯¯ | æŸ¥çœ‹auditæ—¥å¿—ï¼Œè°ƒæ•´ç­–ç•¥ |
| **èµ„æºä¸è¶³** | åº”ç”¨è¿è¡Œç¼“æ…¢ | cgroupsé™åˆ¶è¿‡ä¸¥ | ç›‘æ§èµ„æºä½¿ç”¨ï¼Œè°ƒæ•´é™åˆ¶å‚æ•° |

### 8.3 ç»´æŠ¤æ£€æŸ¥æ¸…å•


**æ—¥å¸¸ç»´æŠ¤ä»»åŠ¡**

```bash
# æ¯æ—¥æ£€æŸ¥æ¸…å•
daily_maintenance() {
    echo "=== æ¯æ—¥å®‰å…¨æ£€æŸ¥ $(date) ==="
    
    # 1. æ£€æŸ¥chrootç¯å¢ƒå®Œæ•´æ€§
    echo "1. æ£€æŸ¥chrootç›®å½•æƒé™..."
    ls -la /var/chroot/webserver/ | head -10
    
    # 2. æ£€æŸ¥è¿è¡ŒçŠ¶æ€
    echo -e "\n2. æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€..."
    systemctl status chroot-web --no-pager
    
    # 3. æ£€æŸ¥èµ„æºä½¿ç”¨
    echo -e "\n3. æ£€æŸ¥èµ„æºä½¿ç”¨æƒ…å†µ..."
    echo "å†…å­˜ä½¿ç”¨:"
    cat /sys/fs/cgroup/memory/chroot_web/memory.usage_in_bytes 2>/dev/null || echo "cgroupæœªé…ç½®"
    
    # 4. æ£€æŸ¥ç½‘ç»œè¿æ¥
    echo -e "\n4. æ£€æŸ¥ç½‘ç»œè¿æ¥..."
    ss -tulpn | grep chroot_web || echo "æ— ç½‘ç»œè¿æ¥"
    
    # 5. æ£€æŸ¥å®‰å…¨æ—¥å¿—
    echo -e "\n5. æ£€æŸ¥å®‰å…¨äº‹ä»¶..."
    grep -i "denied\|blocked\|failed" /var/log/chroot_security.log 2>/dev/null | tail -5 || echo "æ— å®‰å…¨äº‹ä»¶"
    
    echo "================================="
}

# æ¯å‘¨æ£€æŸ¥æ¸…å•
weekly_maintenance() {
    echo "=== æ¯å‘¨å®‰å…¨æ£€æŸ¥ $(date) ==="
    
    # 1. è¿è¡Œå®‰å…¨æµ‹è¯•
    echo "1. è¿è¡Œè‡ªåŠ¨åŒ–å®‰å…¨æµ‹è¯•..."
    /usr/local/bin/chroot_security_test.sh
    
    # 2. æ›´æ–°å®‰å…¨ç­–ç•¥
    echo -e "\n2. æ£€æŸ¥å®‰å…¨ç­–ç•¥æ›´æ–°..."
    if command -v semanage >/dev/null 2>&1; then
        echo "SELinuxç­–ç•¥çŠ¶æ€: $(getenforce)"
    fi
    
    # 3. å¤‡ä»½é…ç½®
    echo -e "\n3. å¤‡ä»½å®‰å…¨é…ç½®..."
    tar -czf "/backup/chroot-config-$(date +%Y%m%d).tar.gz" \
        /etc/systemd/system/chroot-web.service \
        /etc/apparmor.d/chroot* \
        /usr/local/bin/*chroot* 2>/dev/null
    
    echo "æ¯å‘¨æ£€æŸ¥å®Œæˆ"
}
```

### 8.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**æå‡æ€§èƒ½çš„é…ç½®è°ƒä¼˜**

```bash
# æ€§èƒ½ä¼˜åŒ–é…ç½®ç¤ºä¾‹

# 1. æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–
# ä½¿ç”¨noatimeæŒ‚è½½é€‰é¡¹å‡å°‘ç£ç›˜I/O
echo "/dev/sda1 /var/chroot/webserver ext4 defaults,noatime,user_xattr 0 2" >> /etc/fstab

# 2. å†…å­˜ä¼˜åŒ–
# è°ƒæ•´cgroupså†…å­˜å›æ”¶ç­–ç•¥
echo 1 > /sys/fs/cgroup/memory/chroot_web/memory.use_hierarchy
echo 60 > /sys/fs/cgroup/memory/chroot_web/memory.swappiness

# 3. ç½‘ç»œä¼˜åŒ–
# è°ƒæ•´ç½‘ç»œè¿æ¥è·Ÿè¸ª
echo 'net.netfilter.nf_conntrack_max = 262144' >> /etc/sysctl.conf
echo 'net.core.netdev_max_backlog = 5000' >> /etc/sysctl.conf

# 4. CPUä¼˜åŒ–
# è®¾ç½®CPUäº²å’Œæ€§
echo 0-1 > /sys/fs/cgroup/cpuset/chroot_web/cpuset.cpus
echo 0 > /sys/fs/cgroup/cpuset/chroot_web/cpuset.mems
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
```
chrootéš”ç¦»ä¸å•ç‹¬ï¼Œå¤šå±‚é˜²æŠ¤æ‰å®‰å…¨
ç½‘ç»œç³»ç»Ÿåº”ç”¨å±‚ï¼Œèµ„æºç›‘æ§è¦è·Ÿä¸Š  
SELinuxé…AppArmorï¼Œé˜²ç«å¢™é™åˆ¶è¦åˆ°ä½
æµ‹è¯•ç›‘æ§ä¸èƒ½å°‘ï¼Œç»´æŠ¤æ£€æŸ¥è¦å®šæœŸ
æœ€å°æƒé™çºµæ·±é˜²ï¼Œå®‰å…¨ç¬¬ä¸€æ˜¯ç‹é“
```
