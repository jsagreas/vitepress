---
title: 8ã€ç³»ç»Ÿè°ƒç”¨å®‰å…¨æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [ç³»ç»Ÿè°ƒç”¨å®‰å…¨æœºåˆ¶æ¦‚è¿°](#1-ç³»ç»Ÿè°ƒç”¨å®‰å…¨æœºåˆ¶æ¦‚è¿°)
2. [ç³»ç»Ÿè°ƒç”¨æƒé™æ£€æŸ¥æœºåˆ¶](#2-ç³»ç»Ÿè°ƒç”¨æƒé™æ£€æŸ¥æœºåˆ¶)
3. [å‚æ•°éªŒè¯ä¸è¿‡æ»¤](#3-å‚æ•°éªŒè¯ä¸è¿‡æ»¤)
4. [ç³»ç»Ÿè°ƒç”¨å®¡è®¡æœºåˆ¶](#4-ç³»ç»Ÿè°ƒç”¨å®¡è®¡æœºåˆ¶)
5. [å±é™©ç³»ç»Ÿè°ƒç”¨é™åˆ¶](#5-å±é™©ç³»ç»Ÿè°ƒç”¨é™åˆ¶)
6. [ç³»ç»Ÿè°ƒç”¨é¢‘ç‡æ§åˆ¶](#6-ç³»ç»Ÿè°ƒç”¨é¢‘ç‡æ§åˆ¶)
7. [å†…æ ¸æ€ç”¨æˆ·æ€åˆ‡æ¢å®‰å…¨](#7-å†…æ ¸æ€ç”¨æˆ·æ€åˆ‡æ¢å®‰å…¨)
8. [ç³»ç»Ÿè°ƒç”¨è¡¨ä¿æŠ¤](#8-ç³»ç»Ÿè°ƒç”¨è¡¨ä¿æŠ¤)
9. [æ¶æ„ç³»ç»Ÿè°ƒç”¨æ£€æµ‹](#9-æ¶æ„ç³»ç»Ÿè°ƒç”¨æ£€æµ‹)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ç³»ç»Ÿè°ƒç”¨å®‰å…¨æœºåˆ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ç³»ç»Ÿè°ƒç”¨å®‰å…¨æœºåˆ¶


**é€šä¿—ç†è§£**ï¼šç³»ç»Ÿè°ƒç”¨å°±åƒæ˜¯æ™®é€šç”¨æˆ·å‘ç³»ç»Ÿç®¡ç†å‘˜æå‡ºè¯·æ±‚çš„è¿‡ç¨‹

```
æ—¥å¸¸ç”Ÿæ´»ç±»æ¯”ï¼š
æ™®é€šå‘˜å·¥(ç”¨æˆ·ç¨‹åº) â†’ å‘ç»ç†(å†…æ ¸)ç”³è¯· â†’ ä½¿ç”¨å…¬å¸èµ„æº(ç³»ç»ŸåŠŸèƒ½)

ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹ï¼š
ç”¨æˆ·ç¨‹åº â†’ å‘èµ·ç³»ç»Ÿè°ƒç”¨ â†’ å†…æ ¸æ£€æŸ¥æƒé™ â†’ æ‰§è¡Œæ“ä½œ â†’ è¿”å›ç»“æœ
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- ç³»ç»Ÿè°ƒç”¨æ˜¯ç”¨æˆ·ç¨‹åºä¸å†…æ ¸äº¤äº’çš„**å”¯ä¸€é€šé“**
- å†…æ ¸å¿…é¡»å¯¹æ¯ä¸ªç³»ç»Ÿè°ƒç”¨è¯·æ±‚è¿›è¡Œ**ä¸¥æ ¼å®‰å…¨æ£€æŸ¥**
- é˜²æ­¢æ¶æ„ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨**æ”»å‡»ç³»ç»Ÿ**æˆ–**è·å–éæ³•æƒé™**

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç³»ç»Ÿè°ƒç”¨å®‰å…¨æœºåˆ¶


**å®‰å…¨å¨èƒç¤ºä¾‹**ï¼š
```
ğŸš¨ æ¶æ„ç¨‹åºå¯èƒ½å°è¯•ï¼š
- è¯»å–å…¶ä»–ç”¨æˆ·çš„ç§å¯†æ–‡ä»¶
- ä¿®æ”¹ç³»ç»Ÿå…³é”®é…ç½®æ–‡ä»¶
- æ¶ˆè€—å¤§é‡ç³»ç»Ÿèµ„æºå¯¼è‡´æ‹’ç»æœåŠ¡
- æå‡è‡ªå·±çš„æƒé™çº§åˆ«
- ç ´åç³»ç»Ÿç¨³å®šæ€§
```

**ä¿æŠ¤ç›®æ ‡**ï¼š
- âœ… **æ•°æ®å®‰å…¨**ï¼šä¿æŠ¤ç”¨æˆ·æ•°æ®ä¸è¢«éæ³•è®¿é—®
- âœ… **ç³»ç»Ÿç¨³å®š**ï¼šé˜²æ­¢æ¶æ„ç¨‹åºç ´åç³»ç»Ÿ
- âœ… **æƒé™éš”ç¦»**ï¼šç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è¢«æˆæƒçš„èµ„æº
- âœ… **å®¡è®¡è¿½è¸ª**ï¼šè®°å½•ç³»ç»Ÿè°ƒç”¨æ´»åŠ¨ä¾¿äºå®‰å…¨åˆ†æ

### 1.3 ç³»ç»Ÿè°ƒç”¨å®‰å…¨æ¶æ„


```
ç”¨æˆ·ç©ºé—´ç¨‹åº
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç³»ç»Ÿè°ƒç”¨æ¥å£   â”‚ â† æ ‡å‡†APIæ¥å£
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æƒé™æ£€æŸ¥å±‚     â”‚ â† éªŒè¯è°ƒç”¨è€…èº«ä»½å’Œæƒé™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å‚æ•°éªŒè¯å±‚     â”‚ â† æ£€æŸ¥å‚æ•°åˆæ³•æ€§
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   é¢‘ç‡æ§åˆ¶å±‚     â”‚ â† é˜²æ­¢èµ„æºæ»¥ç”¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å®¡è®¡è®°å½•å±‚     â”‚ â† è®°å½•è°ƒç”¨æ´»åŠ¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å†…æ ¸æ‰§è¡Œå±‚     â”‚ â† å®é™…æ‰§è¡Œç³»ç»ŸåŠŸèƒ½
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ‘® ç³»ç»Ÿè°ƒç”¨æƒé™æ£€æŸ¥æœºåˆ¶


### 2.1 åŸºäºç”¨æˆ·èº«ä»½çš„æƒé™æ£€æŸ¥


**æ ¸å¿ƒåŸç†**ï¼šæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰æ˜ç¡®çš„èº«ä»½æ ‡è¯†ï¼Œå†…æ ¸æ ¹æ®èº«ä»½å†³å®šæƒé™

```bash
# æŸ¥çœ‹å½“å‰è¿›ç¨‹çš„ç”¨æˆ·èº«ä»½ä¿¡æ¯
id
# è¾“å‡ºï¼šuid=1000(alice) gid=1000(alice) groups=1000(alice),27(sudo)

# è¿›ç¨‹èº«ä»½ä¿¡æ¯åŒ…å«ï¼š
# - çœŸå®ç”¨æˆ·ID (Real UID)ï¼šè¿›ç¨‹çš„å®é™…æ‹¥æœ‰è€…
# - æœ‰æ•ˆç”¨æˆ·ID (Effective UID)ï¼šæƒé™æ£€æŸ¥ä½¿ç”¨çš„ID  
# - ä¿å­˜ç”¨æˆ·ID (Saved UID)ï¼šç”¨äºæƒé™åˆ‡æ¢
```

**æƒé™æ£€æŸ¥æµç¨‹**ï¼š

```
ç”¨æˆ·è°ƒç”¨ open("/etc/passwd", O_RDWR)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è·å–è°ƒç”¨è¿›ç¨‹çš„EUID    â”‚ â† æœ‰æ•ˆç”¨æˆ·ID
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. è·å–ç›®æ ‡æ–‡ä»¶çš„æƒé™   â”‚ â† æ–‡ä»¶æ‰€æœ‰è€…ã€ç»„ã€å…¶ä»–
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. åŒ¹é…æƒé™è§„åˆ™        â”‚ â† æ¯”è¾ƒEUIDä¸æ–‡ä»¶æƒé™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. å†³å®šæ˜¯å¦å…è®¸è®¿é—®    â”‚ â† å…è®¸/æ‹’ç»
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ–‡ä»¶æƒé™æ£€æŸ¥å®ä¾‹


**å®é™…æ¡ˆä¾‹**ï¼šæ™®é€šç”¨æˆ·å°è¯•ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶

```bash
# æ™®é€šç”¨æˆ·å°è¯•ä¿®æ”¹å…³é”®ç³»ç»Ÿæ–‡ä»¶
echo "hacker" >> /etc/passwd

# å†…æ ¸æƒé™æ£€æŸ¥è¿‡ç¨‹ï¼š
# 1. è°ƒç”¨è¿›ç¨‹EUID = 1000 (æ™®é€šç”¨æˆ·)
# 2. /etc/passwd æ–‡ä»¶æƒé™ï¼š
#    æ‰€æœ‰è€…ï¼šroot(0)ï¼Œæƒé™ï¼šrw-
#    ç»„ï¼šroot(0)ï¼Œæƒé™ï¼šr--  
#    å…¶ä»–ï¼šæƒé™ï¼šr--
# 3. EUID(1000) â‰  æ–‡ä»¶æ‰€æœ‰è€…(0)ï¼Œä¸åœ¨æ–‡ä»¶ç»„ä¸­
# 4. åªæœ‰è¯»æƒé™ï¼Œå†™æ“ä½œè¢«æ‹’ç»
# ç»“æœï¼šPermission denied
```

**ç‰¹æƒç¨‹åºç¤ºä¾‹**ï¼š

```c
// setuidç¨‹åºç¤ºä¾‹ï¼špasswdå‘½ä»¤
// æ–‡ä»¶æƒé™ï¼š-rwsr-xr-x root root /usr/bin/passwd

// æ‰§è¡Œæµç¨‹ï¼š
// 1. æ™®é€šç”¨æˆ·æ‰§è¡Œpasswd
// 2. è¿›ç¨‹Real UID = 1000 (æ™®é€šç”¨æˆ·)
// 3. è¿›ç¨‹Effective UID = 0 (rootï¼Œå› ä¸ºsetuidä½)
// 4. å¯ä»¥ä¿®æ”¹/etc/shadowæ–‡ä»¶ï¼ˆä»…rootå¯å†™ï¼‰
```

### 2.3 èƒ½åŠ›(Capabilities)æƒé™æ¨¡å‹


**ä¼ ç»Ÿé—®é¢˜**ï¼šrootæƒé™è¿‡äºå¼ºå¤§ï¼Œè¦ä¹ˆå…¨æœ‰è¦ä¹ˆå…¨æ— 

```bash
# æŸ¥çœ‹è¿›ç¨‹çš„èƒ½åŠ›é›†åˆ
getpcaps $$
# æˆ–è€…æŸ¥çœ‹ç‰¹å®šè¿›ç¨‹
cat /proc/self/status | grep Cap

# å¸¸è§èƒ½åŠ›ç±»å‹ï¼š
# CAP_DAC_OVERRIDE    - ç»•è¿‡æ–‡ä»¶æƒé™æ£€æŸ¥
# CAP_NET_ADMIN       - ç½‘ç»œç®¡ç†æƒé™
# CAP_SYS_ADMIN       - ç³»ç»Ÿç®¡ç†æƒé™
# CAP_KILL           - å‘é€ä¿¡å·ç»™å…¶ä»–è¿›ç¨‹
```

**èƒ½åŠ›æ§åˆ¶ç¤ºä¾‹**ï¼š

```bash
# ç»™ç¨‹åºåˆ†é…ç‰¹å®šèƒ½åŠ›è€Œéå®Œæ•´rootæƒé™
# ä¾‹ï¼šç»™pingç¨‹åºç½‘ç»œåŸå§‹å¥—æ¥å­—æƒé™
sudo setcap cap_net_raw=ep /bin/ping

# æ£€æŸ¥ç¨‹åºèƒ½åŠ›
getcap /bin/ping
# è¾“å‡ºï¼š/bin/ping = cap_net_raw+ep
```

---

## 3. ğŸ” å‚æ•°éªŒè¯ä¸è¿‡æ»¤


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦å‚æ•°éªŒè¯


**å®‰å…¨é£é™©**ï¼šç”¨æˆ·ç¨‹åºå¯èƒ½ä¼ é€’æ¶æ„å‚æ•°

```c
// å±é™©ç¤ºä¾‹ï¼šæœªéªŒè¯çš„ç³»ç»Ÿè°ƒç”¨å‚æ•°
// ç”¨æˆ·ç¨‹åºå¯èƒ½ä¼ é€’ï¼š
char *malicious_path = "/../../../../etc/passwd";
int fd = open(malicious_path, O_RDWR);

// æˆ–è€…ä¼ é€’æ— æ•ˆæŒ‡é’ˆï¼š
char *null_ptr = NULL;
int result = write(fd, null_ptr, 1000); // å¯èƒ½å¯¼è‡´å†…æ ¸å´©æºƒ
```

### 3.2 å‚æ•°éªŒè¯æœºåˆ¶


**éªŒè¯å†…å®¹**ï¼š

```
ğŸ”¸ åœ°å€æœ‰æ•ˆæ€§éªŒè¯
- æ£€æŸ¥æŒ‡é’ˆæ˜¯å¦æŒ‡å‘æœ‰æ•ˆç”¨æˆ·ç©ºé—´åœ°å€
- é˜²æ­¢è®¿é—®å†…æ ¸ç©ºé—´æˆ–æ— æ•ˆåœ°å€

ğŸ”¸ ç¼“å†²åŒºé•¿åº¦éªŒè¯  
- æ£€æŸ¥è¯»å†™é•¿åº¦æ˜¯å¦åˆç†
- é˜²æ­¢ç¼“å†²åŒºæº¢å‡ºæ”»å‡»

ğŸ”¸ æ–‡ä»¶è·¯å¾„éªŒè¯
- æ£€æŸ¥è·¯å¾„æ˜¯å¦è¶…å‡ºå…è®¸èŒƒå›´
- é˜²æ­¢ç›®å½•éå†æ”»å‡»

ğŸ”¸ æ•°å€¼èŒƒå›´éªŒè¯
- æ£€æŸ¥æ•°å€¼å‚æ•°æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…
- é˜²æ­¢æ•´æ•°æº¢å‡ºæˆ–è´Ÿæ•°æ”»å‡»
```

**å®é™…éªŒè¯ç¤ºä¾‹**ï¼š

```c
// å†…æ ¸ä¸­writeç³»ç»Ÿè°ƒç”¨çš„å‚æ•°éªŒè¯
SYSCALL_DEFINE3(write, unsigned int, fd, const char __user *, buf, size_t, count)
{
    // 1. éªŒè¯æ–‡ä»¶æè¿°ç¬¦æœ‰æ•ˆæ€§
    if (fd >= current->files->max_fds)
        return -EBADF;
        
    // 2. éªŒè¯ç¼“å†²åŒºåœ°å€æœ‰æ•ˆæ€§
    if (!access_ok(VERIFY_READ, buf, count))
        return -EFAULT;
        
    // 3. éªŒè¯å†™å…¥é•¿åº¦åˆç†æ€§
    if (count > MAX_RW_COUNT)
        count = MAX_RW_COUNT;
        
    // 4. æ‰§è¡Œå®é™…å†™æ“ä½œ
    return vfs_write(file, buf, count, &pos);
}
```

### 3.3 è·¯å¾„éå†é˜²æŠ¤


**æ”»å‡»ç¤ºä¾‹**ï¼š

```bash
# æ¶æ„ç¨‹åºå°è¯•ç›®å½•éå†æ”»å‡»
./malicious_program "../../../etc/passwd"

# ç¨‹åºå†…éƒ¨å¯èƒ½æ„é€ ï¼š
# /home/user/data/../../../etc/passwd
# ç®€åŒ–åå˜æˆï¼š/etc/passwd
```

**é˜²æŠ¤æœºåˆ¶**ï¼š

```c
// å†…æ ¸è·¯å¾„è§£æå®‰å…¨æ£€æŸ¥
int path_walk(const char *pathname, struct nameidata *nd)
{
    // 1. è§„èŒƒåŒ–è·¯å¾„ï¼Œå¤„ç† . å’Œ .. 
    // 2. æ£€æŸ¥æ¯ä¸ªè·¯å¾„ç»„ä»¶çš„æƒé™
    // 3. é˜²æ­¢ç¬¦å·é“¾æ¥æ”»å‡»
    // 4. éªŒè¯æœ€ç»ˆè·¯å¾„æ˜¯å¦åœ¨å…è®¸èŒƒå›´å†…
    
    if (may_follow_link(&link, nd) == 0) {
        return -EACCES; // ç¦æ­¢ç¬¦å·é“¾æ¥æ”»å‡»
    }
}
```

---

## 4. ğŸ“‹ ç³»ç»Ÿè°ƒç”¨å®¡è®¡æœºåˆ¶


### 4.1 ä»€ä¹ˆæ˜¯ç³»ç»Ÿè°ƒç”¨å®¡è®¡


**é€šä¿—ç†è§£**ï¼šå°±åƒé“¶è¡Œè®°å½•æ¯ç¬”äº¤æ˜“ä¸€æ ·ï¼Œç³»ç»Ÿè®°å½•æ¯ä¸ªé‡è¦çš„ç³»ç»Ÿè°ƒç”¨

```
é“¶è¡Œäº¤æ˜“è®°å½•ï¼š         ç³»ç»Ÿè°ƒç”¨å®¡è®¡ï¼š
æ—¶é—´ï¼š2025-01-15       æ—¶é—´ï¼š2025-01-15 10:30:25
ç”¨æˆ·ï¼šå¼ ä¸‰            ç”¨æˆ·ï¼šalice (uid=1000)
æ“ä½œï¼šå–æ¬¾            æ“ä½œï¼šopen()ç³»ç»Ÿè°ƒç”¨
é‡‘é¢ï¼š500å…ƒ           æ–‡ä»¶ï¼š/etc/passwd
ç»“æœï¼šæˆåŠŸ            ç»“æœï¼šæˆåŠŸ(è¿”å›fd=5)
```

### 4.2 Linuxå®¡è®¡ç³»ç»Ÿ(auditd)


**å®‰è£…ä¸é…ç½®**ï¼š

```bash
# å®‰è£…å®¡è®¡ç³»ç»Ÿ
sudo apt install auditd audispd-plugins

# å¯åŠ¨å®¡è®¡æœåŠ¡
sudo systemctl start auditd
sudo systemctl enable auditd

# æŸ¥çœ‹å®¡è®¡çŠ¶æ€
sudo auditctl -s
```

**é…ç½®å®¡è®¡è§„åˆ™**ï¼š

```bash
# ç›‘æ§æ–‡ä»¶è®¿é—®
sudo auditctl -w /etc/passwd -p rwxa -k passwd_access

# ç›‘æ§ç³»ç»Ÿè°ƒç”¨
sudo auditctl -a always,exit -F arch=b64 -S openat -k file_open

# ç›‘æ§ç‰¹æƒæ“ä½œ
sudo auditctl -a always,exit -F arch=b64 -S setuid -F a0=0 -k privilege_escalation

# æŸ¥çœ‹å½“å‰è§„åˆ™
sudo auditctl -l
```

### 4.3 å®¡è®¡æ—¥å¿—åˆ†æ


**æŸ¥çœ‹å®¡è®¡æ—¥å¿—**ï¼š

```bash
# æŸ¥çœ‹åŸå§‹å®¡è®¡æ—¥å¿—
sudo tail -f /var/log/audit/audit.log

# ä½¿ç”¨ausearchæŸ¥è¯¢ç‰¹å®šäº‹ä»¶
sudo ausearch -k passwd_access
sudo ausearch -ui 1000  # æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„æ´»åŠ¨
sudo ausearch -sc open  # æŸ¥çœ‹openç³»ç»Ÿè°ƒç”¨

# ç”Ÿæˆå¯è¯»æŠ¥å‘Š
sudo aureport --summary
sudo aureport --file
```

**æ—¥å¿—åˆ†æç¤ºä¾‹**ï¼š

```
# åŸå§‹æ—¥å¿—ï¼š
type=SYSCALL msg=audit(1640995825.123:456): arch=c000003e syscall=257 success=yes exit=5 a0=ffffff9c a1=7fff12345678 a2=0 a3=0 items=1 ppid=1234 pid=5678 auid=1000 uid=1000 gid=1000 euid=1000 suid=1000 fsuid=1000 egid=1000 sgid=1000 fsgid=1000 tty=pts0 ses=3 comm="cat" exe="/bin/cat" key="passwd_access"

# è§£æå«ä¹‰ï¼š
# - ç³»ç»Ÿè°ƒç”¨ï¼šopenat (syscall=257)
# - æ‰§è¡Œç»“æœï¼šæˆåŠŸ (success=yes)
# - è¿”å›å€¼ï¼š5 (exit=5ï¼Œå³æ–‡ä»¶æè¿°ç¬¦)
# - è¿›ç¨‹IDï¼š5678 (pid=5678)
# - ç”¨æˆ·IDï¼š1000 (uid=1000)
# - æ‰§è¡Œç¨‹åºï¼š/bin/cat
# - å®¡è®¡æ ‡ç­¾ï¼špasswd_access
```

---

## 5. âš ï¸ å±é™©ç³»ç»Ÿè°ƒç”¨é™åˆ¶


### 5.1 è¯†åˆ«å±é™©ç³»ç»Ÿè°ƒç”¨


**é«˜é£é™©ç³»ç»Ÿè°ƒç”¨åˆ†ç±»**ï¼š

```
ğŸš¨ æƒé™æå‡ç±»ï¼š
- setuid(), setgid()        # æ”¹å˜ç”¨æˆ·/ç»„èº«ä»½
- setresuid(), setresgid()  # è®¾ç½®ç”¨æˆ·/ç»„ID
- execve()                  # æ‰§è¡Œç¨‹åº(å¯èƒ½ææƒ)

ğŸš¨ ç³»ç»Ÿé…ç½®ç±»ï¼š
- mount(), umount()         # æŒ‚è½½/å¸è½½æ–‡ä»¶ç³»ç»Ÿ
- swapon(), swapoff()       # ç®¡ç†äº¤æ¢ç©ºé—´
- stime(), settimeofday()   # ä¿®æ”¹ç³»ç»Ÿæ—¶é—´

ğŸš¨ è¿›ç¨‹æ§åˆ¶ç±»ï¼š
- ptrace()                  # è¿›ç¨‹è°ƒè¯•(å¯æ³¨å…¥ä»£ç )
- kill()                    # å‘é€ä¿¡å·
- clone()                   # åˆ›å»ºè¿›ç¨‹

ğŸš¨ ç½‘ç»œå®‰å…¨ç±»ï¼š
- socket() with RAW         # åŸå§‹å¥—æ¥å­—
- bind() to privileged port # ç»‘å®šç‰¹æƒç«¯å£(<1024)
```

### 5.2 seccompå®‰å…¨æœºåˆ¶


**ä»€ä¹ˆæ˜¯seccomp**ï¼šå®‰å…¨è®¡ç®—æ¨¡å¼ï¼Œé™åˆ¶è¿›ç¨‹å¯ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨

```bash
# æŸ¥çœ‹è¿›ç¨‹çš„seccompçŠ¶æ€
cat /proc/self/status | grep Seccomp
# Seccomp: 0 (disabled)
# Seccomp: 1 (strict mode)
# Seccomp: 2 (filter mode)
```

**seccompä½¿ç”¨ç¤ºä¾‹**ï¼š

```c
#include <sys/prctl.h>
#include <linux/seccomp.h>
#include <linux/filter.h>

// ä¸¥æ ¼æ¨¡å¼ï¼šåªå…è®¸read, write, exit, sigreturn
void enable_strict_seccomp() {
    if (prctl(PR_SET_SECCOMP, SECCOMP_MODE_STRICT) == -1) {
        perror("prctl(PR_SET_SECCOMP)");
        exit(1);
    }
    // ç°åœ¨åªèƒ½ä½¿ç”¨read, write, exit, sigreturn
    // ä»»ä½•å…¶ä»–ç³»ç»Ÿè°ƒç”¨éƒ½ä¼šç»ˆæ­¢è¿›ç¨‹
}

// è¿‡æ»¤æ¨¡å¼ï¼šè‡ªå®šä¹‰å…è®¸çš„ç³»ç»Ÿè°ƒç”¨
void enable_filter_seccomp() {
    struct sock_filter filter[] = {
        // å…è®¸readç³»ç»Ÿè°ƒç”¨
        BPF_STMT(BPF_LD | BPF_W | BPF_ABS, offsetof(struct seccomp_data, nr)),
        BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, __NR_read, 0, 1),
        BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ALLOW),
        
        // å…è®¸writeç³»ç»Ÿè°ƒç”¨  
        BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, __NR_write, 0, 1),
        BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ALLOW),
        
        // å…¶ä»–ç³»ç»Ÿè°ƒç”¨éƒ½è¢«æ‹’ç»
        BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_KILL)
    };
    
    struct sock_fprog prog = {
        .len = sizeof(filter) / sizeof(filter[0]),
        .filter = filter
    };
    
    if (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &prog) == -1) {
        perror("prctl(PR_SET_SECCOMP)");
        exit(1);
    }
}
```

### 5.3 å®¹å™¨åŒ–å®‰å…¨é™åˆ¶


**Dockeré»˜è®¤seccompé…ç½®**ï¼š

```json
// Dockeré»˜è®¤ç¦ç”¨çš„å±é™©ç³»ç»Ÿè°ƒç”¨
{
  "defaultAction": "SCMP_ACT_ERRNO",
  "syscalls": [
    {
      "names": [
        "acct", "add_key", "bpf", "clock_adjtime",
        "clock_settime", "clone", "create_module",
        "delete_module", "finit_module", "get_kernel_syms",
        "get_mempolicy", "init_module", "ioperm",
        "iopl", "kcmp", "kexec_file_load", "kexec_load",
        "keyctl", "lookup_dcookie", "mbind", "mount",
        "move_pages", "name_to_handle_at", "nfsservctl",
        "open_by_handle_at", "perf_event_open", "personality",
        "pivot_root", "process_vm_readv", "process_vm_writev",
        "ptrace", "reboot", "remap_file_pages", "request_key",
        "restart_syscall", "set_mempolicy", "setdomainname",
        "sethostname", "setns", "settimeofday", "stime",
        "swapoff", "swapon", "sysfs", "syslog", "tuxcall",
        "umount2", "umount", "unshare", "uselib", "userfaultfd",
        "ustat", "vm86", "vm86old"
      ],
      "action": "SCMP_ACT_ERRNO"
    }
  ]
}
```

---

## 6. â±ï¸ ç³»ç»Ÿè°ƒç”¨é¢‘ç‡æ§åˆ¶


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦é¢‘ç‡æ§åˆ¶


**æ”»å‡»åœºæ™¯**ï¼šæ¶æ„ç¨‹åºç–¯ç‹‚è°ƒç”¨ç³»ç»Ÿè°ƒç”¨å¯¼è‡´ç³»ç»Ÿæ‹’ç»æœåŠ¡

```bash
# æ¶æ„ç¨‹åºç¤ºä¾‹ï¼šforkç‚¸å¼¹
#!/bin/bash
:(){ :|:& };:

# è§£é‡Šï¼šè¿™æ˜¯ä¸€ä¸ªé€’å½’å‡½æ•°
# :(){ ... } å®šä¹‰åä¸º:çš„å‡½æ•°  
# :|: è°ƒç”¨è‡ªå·±å¹¶é€šè¿‡ç®¡é“è¿æ¥åˆ°å¦ä¸€ä¸ªè‡ªå·±
# & æ”¾åˆ°åå°æ‰§è¡Œ
# ; åˆ†éš”å‘½ä»¤
# : æ‰§è¡Œè¿™ä¸ªå‡½æ•°

# æ•ˆæœï¼šæ— é™åˆ¶åˆ›å»ºè¿›ç¨‹ï¼Œç›´åˆ°ç³»ç»Ÿèµ„æºè€—å°½
```

### 6.2 ulimitèµ„æºé™åˆ¶


**æŸ¥çœ‹å½“å‰é™åˆ¶**ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰èµ„æºé™åˆ¶
ulimit -a

# å¸¸è§é™åˆ¶é¡¹ï¼š
# -c: core file size (blocks, -c) 0
# -f: file size (blocks, -f) unlimited  
# -n: file descriptors (-n) 1024
# -p: pipe size (512 bytes, -p) 8
# -u: max user processes (-u) 4096
# -v: virtual memory (kbytes, -v) unlimited
```

**è®¾ç½®èµ„æºé™åˆ¶**ï¼š

```bash
# ä¸´æ—¶è®¾ç½®å½“å‰shellçš„é™åˆ¶
ulimit -n 2048     # æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°
ulimit -u 1000     # æœ€å¤§è¿›ç¨‹æ•°
ulimit -f 100000   # æœ€å¤§æ–‡ä»¶å¤§å°(å—)

# æ°¸ä¹…è®¾ç½®ï¼šç¼–è¾‘ /etc/security/limits.conf
echo "alice hard nproc 500" | sudo tee -a /etc/security/limits.conf
echo "alice soft nproc 400" | sudo tee -a /etc/security/limits.conf
```

### 6.3 cgroupsèµ„æºæ§åˆ¶


**ä»€ä¹ˆæ˜¯cgroups**ï¼šæ§åˆ¶ç»„ï¼ŒLinuxå†…æ ¸æä¾›çš„èµ„æºç®¡æ§æœºåˆ¶

```bash
# æŸ¥çœ‹å½“å‰è¿›ç¨‹æ‰€åœ¨çš„cgroup
cat /proc/self/cgroup

# åˆ›å»ºè‡ªå®šä¹‰cgroup
sudo mkdir /sys/fs/cgroup/memory/my_limit
sudo mkdir /sys/fs/cgroup/cpu/my_limit

# è®¾ç½®å†…å­˜é™åˆ¶(100MB)
echo 104857600 | sudo tee /sys/fs/cgroup/memory/my_limit/memory.limit_in_bytes

# è®¾ç½®CPUä½¿ç”¨é™åˆ¶(50%)
echo 50000 | sudo tee /sys/fs/cgroup/cpu/my_limit/cpu.cfs_quota_us
echo 100000 | sudo tee /sys/fs/cgroup/cpu/my_limit/cpu.cfs_period_us

# å°†è¿›ç¨‹æ·»åŠ åˆ°cgroup
echo $$ | sudo tee /sys/fs/cgroup/memory/my_limit/cgroup.procs
echo $$ | sudo tee /sys/fs/cgroup/cpu/my_limit/cgroup.procs
```

### 6.4 systemdæœåŠ¡èµ„æºé™åˆ¶


**æœåŠ¡é…ç½®ç¤ºä¾‹**ï¼š

```ini
# /etc/systemd/system/my-service.service
[Unit]
Description=My Limited Service

[Service]
Type=simple
ExecStart=/usr/bin/my-program
User=alice

# èµ„æºé™åˆ¶
LimitNOFILE=1024        # æœ€å¤§æ–‡ä»¶æè¿°ç¬¦
LimitNPROC=100          # æœ€å¤§è¿›ç¨‹æ•°
MemoryLimit=128M        # å†…å­˜é™åˆ¶
CPUQuota=50%           # CPUä½¿ç”¨é™åˆ¶

# ç³»ç»Ÿè°ƒç”¨é™åˆ¶
SystemCallFilter=@system-service
SystemCallFilter=~@privileged @resources

[Install]
WantedBy=multi-user.target
```

---

## 7. ğŸ”„ å†…æ ¸æ€ç”¨æˆ·æ€åˆ‡æ¢å®‰å…¨


### 7.1 ç‰¹æƒçº§åˆ«åˆ‡æ¢åŸç†


**CPUç‰¹æƒçº§åˆ«**ï¼š

```
Ring 0 (å†…æ ¸æ€)ï¼š
- æœ€é«˜ç‰¹æƒçº§åˆ«
- å¯æ‰§è¡Œæ‰€æœ‰æŒ‡ä»¤
- å¯è®¿é—®æ‰€æœ‰å†…å­˜
- è¿è¡Œæ“ä½œç³»ç»Ÿå†…æ ¸

Ring 3 (ç”¨æˆ·æ€)ï¼š  
- æœ€ä½ç‰¹æƒçº§åˆ«
- å—é™æŒ‡ä»¤é›†
- å—é™å†…å­˜è®¿é—®
- è¿è¡Œç”¨æˆ·ç¨‹åº

ç‰¹æƒçº§åˆ«åˆ‡æ¢ï¼š
ç”¨æˆ·ç¨‹åº(Ring 3) â†’ ç³»ç»Ÿè°ƒç”¨ â†’ å†…æ ¸(Ring 0) â†’ è¿”å› â†’ ç”¨æˆ·ç¨‹åº(Ring 3)
```

**åˆ‡æ¢è¿‡ç¨‹å®‰å…¨æ£€æŸ¥**ï¼š

```
1. ä¸­æ–­/å¼‚å¸¸æ£€æŸ¥ï¼š
   â”œâ”€ éªŒè¯ä¸­æ–­å‘é‡æœ‰æ•ˆæ€§
   â”œâ”€ æ£€æŸ¥ä¸­æ–­å¤„ç†ç¨‹åºåœ°å€
   â””â”€ éªŒè¯è°ƒç”¨è€…æƒé™

2. æ ˆåˆ‡æ¢å®‰å…¨ï¼š
   â”œâ”€ ä¿å­˜ç”¨æˆ·æ€å¯„å­˜å™¨çŠ¶æ€
   â”œâ”€ åˆ‡æ¢åˆ°å†…æ ¸æ ˆ
   â””â”€ éªŒè¯æ ˆæŒ‡é’ˆæœ‰æ•ˆæ€§

3. æƒé™æå‡éªŒè¯ï¼š
   â”œâ”€ æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨å·æœ‰æ•ˆæ€§
   â”œâ”€ éªŒè¯å‚æ•°åœ°å€èŒƒå›´
   â””â”€ ç¡®è®¤è°ƒç”¨è€…èº«ä»½
```

### 7.2 ç³»ç»Ÿè°ƒç”¨å…¥å£ç‚¹ä¿æŠ¤


**ä¸­æ–­æè¿°ç¬¦è¡¨(IDT)ä¿æŠ¤**ï¼š

```c
// å†…æ ¸ä¸­çš„IDTä¿æŠ¤æœºåˆ¶
static void protect_idt(void) {
    // 1. å°†IDTè®¾ä¸ºåªè¯»
    set_idt_readonly();
    
    // 2. å¯ç”¨SMEP (Supervisor Mode Execution Prevention)
    // é˜²æ­¢å†…æ ¸æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç 
    if (cpu_has_smep) {
        cr4_set_bits(X86_CR4_SMEP);
    }
    
    // 3. å¯ç”¨SMAP (Supervisor Mode Access Prevention)  
    // é˜²æ­¢å†…æ ¸ç›´æ¥è®¿é—®ç”¨æˆ·ç©ºé—´æ•°æ®
    if (cpu_has_smap) {
        cr4_set_bits(X86_CR4_SMAP);
    }
}
```

### 7.3 è¿”å›åœ°å€éªŒè¯


**ROPæ”»å‡»é˜²æŠ¤**ï¼š

```c
// ç³»ç»Ÿè°ƒç”¨è¿”å›æ—¶çš„å®‰å…¨æ£€æŸ¥
asmlinkage long syscall_return(struct pt_regs *regs) {
    // 1. éªŒè¯è¿”å›åœ°å€æ˜¯å¦åœ¨ç”¨æˆ·ç©ºé—´
    if (!user_mode(regs)) {
        force_sig(SIGSEGV, current);
        return -EFAULT;
    }
    
    // 2. æ£€æŸ¥æ ˆæŒ‡é’ˆæœ‰æ•ˆæ€§
    if (!access_ok(VERIFY_WRITE, regs->sp, sizeof(long))) {
        force_sig(SIGSEGV, current);
        return -EFAULT;
    }
    
    // 3. æ§åˆ¶æµå®Œæ•´æ€§æ£€æŸ¥
    if (cfi_enabled && !valid_return_address(regs->ip)) {
        force_sig(SIGSEGV, current);
        return -EFAULT;
    }
    
    return 0;
}
```

---

## 8. ğŸ›¡ï¸ ç³»ç»Ÿè°ƒç”¨è¡¨ä¿æŠ¤


### 8.1 ä»€ä¹ˆæ˜¯ç³»ç»Ÿè°ƒç”¨è¡¨


**ç³»ç»Ÿè°ƒç”¨è¡¨**ï¼šå†…æ ¸ä¸­å­˜å‚¨æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•°åœ°å€çš„æ•°ç»„

```c
// ç®€åŒ–çš„ç³»ç»Ÿè°ƒç”¨è¡¨ç»“æ„
const sys_call_ptr_t sys_call_table[__NR_syscall_max+1] = {
    [0] = sys_read,
    [1] = sys_write, 
    [2] = sys_open,
    [3] = sys_close,
    [4] = sys_stat,
    // ... æ›´å¤šç³»ç»Ÿè°ƒç”¨
};

// ç³»ç»Ÿè°ƒç”¨åˆ†å‘è¿‡ç¨‹ï¼š
// 1. ç”¨æˆ·ç¨‹åºæ‰§è¡Œ syscall æŒ‡ä»¤
// 2. CPUåˆ‡æ¢åˆ°å†…æ ¸æ€
// 3. æ ¹æ®ç³»ç»Ÿè°ƒç”¨å·æŸ¥æ‰¾ sys_call_table[nr]
// 4. è·³è½¬åˆ°å¯¹åº”å¤„ç†å‡½æ•°æ‰§è¡Œ
```

### 8.2 ç³»ç»Ÿè°ƒç”¨è¡¨æ”»å‡»ä¸é˜²æŠ¤


**æ”»å‡»æ‰‹æ®µ**ï¼šæ¶æ„å†…æ ¸æ¨¡å—ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨

```c
// æ¶æ„ä»£ç ç¤ºä¾‹(rootkitå¸¸ç”¨æ‰‹æ³•)
asmlinkage long (*original_sys_open)(const char*, int, umode_t);

// æ¶æ„çš„openç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•°
asmlinkage long malicious_sys_open(const char *filename, int flags, umode_t mode) {
    // å¦‚æœæ˜¯è®¿é—®æ•æ„Ÿæ–‡ä»¶ï¼Œéšè—æˆ–è¿”å›å‡ä¿¡æ¯
    if (strstr(filename, "secret")) {
        return -ENOENT; // å‡è£…æ–‡ä»¶ä¸å­˜åœ¨
    }
    
    // å¦åˆ™è°ƒç”¨åŸå§‹å‡½æ•°
    return original_sys_open(filename, flags, mode);
}

// Hookç³»ç»Ÿè°ƒç”¨è¡¨
void hook_syscall_table(void) {
    // ä¿å­˜åŸå§‹å‡½æ•°æŒ‡é’ˆ
    original_sys_open = sys_call_table[__NR_open];
    
    // æ›¿æ¢ä¸ºæ¶æ„å‡½æ•°
    sys_call_table[__NR_open] = malicious_sys_open;
}
```

**ç°ä»£é˜²æŠ¤æœºåˆ¶**ï¼š

```c
// 1. å†™ä¿æŠ¤ - ç³»ç»Ÿè°ƒç”¨è¡¨åªè¯»
static void protect_syscall_table(void) {
    // è®¾ç½®ç³»ç»Ÿè°ƒç”¨è¡¨æ‰€åœ¨é¡µé¢ä¸ºåªè¯»
    set_memory_ro((unsigned long)sys_call_table, 
                  (sizeof(sys_call_table) + PAGE_SIZE - 1) / PAGE_SIZE);
}

// 2. æ§åˆ¶æµå®Œæ•´æ€§ (CFI)
// ç¼–è¯‘æ—¶æ’å…¥æ£€æŸ¥ä»£ç ï¼ŒéªŒè¯é—´æ¥è°ƒç”¨ç›®æ ‡
__cfi_check void syscall_dispatch(int nr, ...) {
    if (nr < 0 || nr > __NR_syscall_max) {
        BUG(); // æ— æ•ˆç³»ç»Ÿè°ƒç”¨å·
    }
    
    // CFIæ£€æŸ¥ï¼šéªŒè¯è°ƒç”¨ç›®æ ‡æ˜¯å¦ä¸ºåˆæ³•çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°
    if (!cfi_is_valid_syscall(sys_call_table[nr])) {
        BUG(); // ç³»ç»Ÿè°ƒç”¨è¡¨è¢«ç¯¡æ”¹
    }
}

// 3. å†…æ ¸åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ– (KASLR)
// ç³»ç»Ÿè°ƒç”¨è¡¨åœ°å€éšæœºåŒ–ï¼Œå¢åŠ æ”»å‡»éš¾åº¦
```

### 8.3 ç³»ç»Ÿè°ƒç”¨è¡¨å®Œæ•´æ€§æ£€æŸ¥


**è¿è¡Œæ—¶å®Œæ•´æ€§ç›‘æ§**ï¼š

```bash
# æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨è¡¨å®Œæ•´æ€§çš„è„šæœ¬
#!/bin/bash

# è·å–ç³»ç»Ÿè°ƒç”¨è¡¨åœ°å€
SYSCALL_TABLE_ADDR=$(cat /proc/kallsyms | grep "sys_call_table" | cut -d' ' -f1)

# è®¡ç®—ç³»ç»Ÿè°ƒç”¨è¡¨å“ˆå¸Œå€¼
CURRENT_HASH=$(dd if=/dev/kmem bs=1 count=4096 skip=$((0x$SYSCALL_TABLE_ADDR)) 2>/dev/null | sha256sum)

# ä¸å·²çŸ¥å¥½çš„å“ˆå¸Œå€¼æ¯”è¾ƒ
EXPECTED_HASH="a1b2c3d4e5f6..."

if [ "$CURRENT_HASH" != "$EXPECTED_HASH" ]; then
    echo "âš ï¸ ç³»ç»Ÿè°ƒç”¨è¡¨å¯èƒ½è¢«ç¯¡æ”¹ï¼"
    echo "å½“å‰å“ˆå¸Œ: $CURRENT_HASH"
    echo "æœŸæœ›å“ˆå¸Œ: $EXPECTED_HASH"
fi
```

---

## 9. ğŸš¨ æ¶æ„ç³»ç»Ÿè°ƒç”¨æ£€æµ‹


### 9.1 å¼‚å¸¸è¡Œä¸ºæ¨¡å¼è¯†åˆ«


**å¸¸è§æ¶æ„æ¨¡å¼**ï¼š

```
ğŸ”¸ é¢‘ç‡å¼‚å¸¸ï¼š
- çŸ­æ—¶é—´å†…å¤§é‡ç³»ç»Ÿè°ƒç”¨
- è°ƒç”¨é¢‘ç‡è¶…å‡ºæ­£å¸¸èŒƒå›´
- èµ„æºæ¶ˆè€—å‹æ”»å‡»

ğŸ”¸ åºåˆ—å¼‚å¸¸ï¼š
- ä¸å¸¸è§çš„ç³»ç»Ÿè°ƒç”¨ç»„åˆ
- å±é™©æ“ä½œçš„ç‰¹å®šåºåˆ—
- æƒé™æå‡å°è¯•æ¨¡å¼

ğŸ”¸ å‚æ•°å¼‚å¸¸ï¼š
- å‚æ•°å€¼å¼‚å¸¸ï¼ˆè¿‡å¤§ã€è¿‡å°ã€ç‰¹æ®Šå€¼ï¼‰
- è·¯å¾„éå†æ”»å‡»ç‰¹å¾
- ç¼“å†²åŒºæº¢å‡ºå°è¯•

ğŸ”¸ æ—¶æœºå¼‚å¸¸ï¼š
- åœ¨ä¸åº”è¯¥çš„æ—¶é—´è¿›è¡Œæ•æ„Ÿæ“ä½œ
- è¿›ç¨‹çŠ¶æ€ä¸ç³»ç»Ÿè°ƒç”¨ä¸åŒ¹é…
- å¼‚å¸¸çš„è¿›ç¨‹é—´é€šä¿¡æ¨¡å¼
```

### 9.2 åŸºäºæœºå™¨å­¦ä¹ çš„æ£€æµ‹


**è¡Œä¸ºå»ºæ¨¡æ–¹æ³•**ï¼š

```python
# ç³»ç»Ÿè°ƒç”¨åºåˆ—å¼‚å¸¸æ£€æµ‹ç¤ºä¾‹ï¼ˆæ¦‚å¿µä»£ç ï¼‰
import numpy as np
from sklearn.ensemble import IsolationForest

# ç‰¹å¾æå–ï¼šå°†ç³»ç»Ÿè°ƒç”¨åºåˆ—è½¬æ¢ä¸ºç‰¹å¾å‘é‡
def extract_features(syscall_sequence):
    features = []
    
    # 1. ç³»ç»Ÿè°ƒç”¨é¢‘æ¬¡ç‰¹å¾
    syscall_counts = np.bincount(syscall_sequence, minlength=400)
    features.extend(syscall_counts[:50])  # å–å‰50ä¸ªæœ€å¸¸ç”¨çš„
    
    # 2. ç³»ç»Ÿè°ƒç”¨è½¬ç§»ç‰¹å¾ (n-gram)
    for i in range(len(syscall_sequence)-1):
        transition = (syscall_sequence[i], syscall_sequence[i+1])
        # è®°å½•è½¬ç§»æ¨¡å¼...
    
    # 3. æ—¶é—´é—´éš”ç‰¹å¾
    # è®°å½•ç³»ç»Ÿè°ƒç”¨ä¹‹é—´çš„æ—¶é—´é—´éš”åˆ†å¸ƒ
    
    return np.array(features)

# è®­ç»ƒæ­£å¸¸è¡Œä¸ºæ¨¡å‹
def train_anomaly_detector(normal_traces):
    # ä»æ­£å¸¸ç¨‹åºè¿è¡Œè½¨è¿¹ä¸­æå–ç‰¹å¾
    X_normal = [extract_features(trace) for trace in normal_traces]
    
    # ä½¿ç”¨éš”ç¦»æ£®æ—æ£€æµ‹å¼‚å¸¸
    detector = IsolationForest(contamination=0.1)
    detector.fit(X_normal)
    
    return detector

# å®æ—¶æ£€æµ‹
def detect_anomaly(detector, current_trace):
    features = extract_features(current_trace)
    anomaly_score = detector.decision_function([features])[0]
    
    if anomaly_score < -0.5:  # é˜ˆå€¼å¯è°ƒ
        return True  # æ£€æµ‹åˆ°å¼‚å¸¸
    return False
```

### 9.3 å®æ—¶ç›‘æ§ç³»ç»Ÿ


**åŸºäºeBPFçš„ç›‘æ§**ï¼š

```c
// eBPFç¨‹åºï¼šç›‘æ§ç³»ç»Ÿè°ƒç”¨å¼‚å¸¸
#include <linux/bpf.h>
#include <bpf/bpf_helpers.h>

// å­˜å‚¨è¿›ç¨‹ç³»ç»Ÿè°ƒç”¨ç»Ÿè®¡ä¿¡æ¯
struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, 10240);
    __type(key, __u32);    // PID
    __type(value, struct syscall_stats);
} process_stats SEC(".maps");

struct syscall_stats {
    __u64 total_calls;
    __u64 last_call_time;
    __u32 recent_calls[10];  // æœ€è¿‘10ä¸ªç³»ç»Ÿè°ƒç”¨
    __u8 recent_index;
};

// ç³»ç»Ÿè°ƒç”¨å…¥å£ç‚¹æ¢é’ˆ
SEC("tp/syscalls/sys_enter_openat")
int trace_syscall_enter(struct trace_event_raw_sys_enter* ctx) {
    __u32 pid = bpf_get_current_pid_tgid() >> 32;
    __u64 now = bpf_ktime_get_ns();
    
    struct syscall_stats *stats = bpf_map_lookup_elem(&process_stats, &pid);
    if (!stats) {
        struct syscall_stats new_stats = {0};
        bpf_map_update_elem(&process_stats, &pid, &new_stats, BPF_ANY);
        stats = bpf_map_lookup_elem(&process_stats, &pid);
        if (!stats) return 0;
    }
    
    stats->total_calls++;
    
    // æ£€æµ‹é¢‘ç‡å¼‚å¸¸
    if (stats->last_call_time > 0) {
        __u64 interval = now - stats->last_call_time;
        if (interval < 1000000) {  // å°äº1ms
            // å¯èƒ½çš„å¼‚å¸¸é¢‘ç‡ï¼Œè®°å½•äº‹ä»¶
            bpf_printk("High frequency syscalls detected for PID %d", pid);
        }
    }
    
    stats->last_call_time = now;
    
    // æ›´æ–°æœ€è¿‘è°ƒç”¨è®°å½•
    stats->recent_calls[stats->recent_index] = ctx->id;
    stats->recent_index = (stats->recent_index + 1) % 10;
    
    return 0;
}
```

**ç”¨æˆ·æ€ç›‘æ§ç¨‹åº**ï¼š

```python
#!/usr/bin/env python3
from bcc import BPF
import time

# åŠ è½½eBPFç¨‹åº
bpf_program = """
// ä¸Šé¢çš„eBPFä»£ç 
"""

b = BPF(text=bpf_program)

print("ç›‘æ§ç³»ç»Ÿè°ƒç”¨å¼‚å¸¸è¡Œä¸º...")

try:
    while True:
        time.sleep(1)
        
        # æ£€æŸ¥å¼‚å¸¸è¿›ç¨‹
        process_stats = b["process_stats"]
        for pid, stats in process_stats.items():
            if stats.total_calls > 1000:  # 1ç§’å†…è¶…è¿‡1000æ¬¡è°ƒç”¨
                print(f"âš ï¸ è¿›ç¨‹ {pid} ç³»ç»Ÿè°ƒç”¨é¢‘ç‡å¼‚å¸¸: {stats.total_calls}")
                
                # å¯ä»¥é‡‡å–è¿›ä¸€æ­¥è¡ŒåŠ¨ï¼š
                # - é™åˆ¶è¿›ç¨‹èµ„æº
                # - å‘é€å‘Šè­¦
                # - ç»ˆæ­¢è¿›ç¨‹
                
except KeyboardInterrupt:
    print("åœæ­¢ç›‘æ§")
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç³»ç»Ÿè°ƒç”¨å®‰å…¨æœ¬è´¨ï¼šç”¨æˆ·ç¨‹åºä¸å†…æ ¸äº¤äº’çš„å®‰å…¨æ£€æŸ¥ç‚¹
ğŸ”¸ æƒé™æ£€æŸ¥æœºåˆ¶ï¼šåŸºäºç”¨æˆ·èº«ä»½ã€æ–‡ä»¶æƒé™ã€èƒ½åŠ›æ¨¡å‹çš„å¤šå±‚éªŒè¯
ğŸ”¸ å‚æ•°éªŒè¯é‡è¦æ€§ï¼šé˜²æ­¢æ¶æ„å‚æ•°æ”»å‡»å†…æ ¸æˆ–è·å–éæ³•è®¿é—®
ğŸ”¸ å®¡è®¡è¿½è¸ªä»·å€¼ï¼šè®°å½•ç³»ç»Ÿæ´»åŠ¨ï¼Œä¾¿äºå®‰å…¨åˆ†æå’Œäº‹ä»¶è¿½æº¯
ğŸ”¸ èµ„æºé™åˆ¶å¿…è¦æ€§ï¼šé˜²æ­¢æ¶æ„ç¨‹åºæ¶ˆè€—ç³»ç»Ÿèµ„æºå¯¼è‡´æ‹’ç»æœåŠ¡
ğŸ”¸ ç‰¹æƒåˆ‡æ¢å®‰å…¨ï¼šå†…æ ¸æ€ç”¨æˆ·æ€åˆ‡æ¢è¿‡ç¨‹ä¸­çš„å®‰å…¨æ£€æŸ¥æœºåˆ¶
ğŸ”¸ ç³»ç»Ÿè°ƒç”¨è¡¨ä¿æŠ¤ï¼šé˜²æ­¢å†…æ ¸çº§åˆ«çš„æ”»å‡»å’Œç¯¡æ”¹
ğŸ”¸ å¼‚å¸¸æ£€æµ‹ä»·å€¼ï¼šåŠæ—¶å‘ç°å’Œé˜»æ­¢æ¶æ„ç³»ç»Ÿè°ƒç”¨è¡Œä¸º
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¤šå±‚é˜²æŠ¤ä½“ç³»**
```
ç³»ç»Ÿè°ƒç”¨å®‰å…¨ä¸æ˜¯å•ä¸€æœºåˆ¶ï¼Œè€Œæ˜¯å¤šå±‚é˜²æŠ¤ï¼š

ç¬¬ä¸€å±‚ï¼šèº«ä»½éªŒè¯ (è°åœ¨è°ƒç”¨)
ç¬¬äºŒå±‚ï¼šæƒé™æ£€æŸ¥ (æ˜¯å¦å…è®¸)
ç¬¬ä¸‰å±‚ï¼šå‚æ•°éªŒè¯ (å‚æ•°æ˜¯å¦åˆæ³•)
ç¬¬å››å±‚ï¼šèµ„æºæ§åˆ¶ (æ˜¯å¦è¶…å‡ºé™åˆ¶)
ç¬¬äº”å±‚ï¼šè¡Œä¸ºç›‘æ§ (æ˜¯å¦å¼‚å¸¸)
ç¬¬å…­å±‚ï¼šå®¡è®¡è®°å½• (ç•™ä¸‹ç—•è¿¹)
```

**ğŸ”¹ å¹³è¡¡å®‰å…¨ä¸æ€§èƒ½**
```
å®‰å…¨æœºåˆ¶è®¾è®¡åŸåˆ™ï¼š
âœ… å¿…è¦æ€§ï¼šåªæ£€æŸ¥å¿…è¦çš„å®‰å…¨é¡¹ç›®
âœ… æ•ˆç‡æ€§ï¼šæ£€æŸ¥è¿‡ç¨‹è¦å°½å¯èƒ½å¿«é€Ÿ
âœ… å®Œå¤‡æ€§ï¼šè¦†ç›–æ‰€æœ‰å¯èƒ½çš„æ”»å‡»é¢
âœ… å¯ç»´æŠ¤æ€§ï¼šè§„åˆ™è¦æ¸…æ™°æ˜“äºç®¡ç†
```

**ğŸ”¹ å®é™…åº”ç”¨è¦ç‚¹**
```
æ—¥å¸¸è¿ç»´ä¸­çš„å®‰å…¨å®è·µï¼š

ç›‘æ§æ–¹é¢ï¼š
- å®šæœŸæ£€æŸ¥å®¡è®¡æ—¥å¿—
- å…³æ³¨å¼‚å¸¸ç³»ç»Ÿè°ƒç”¨æ¨¡å¼
- ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ

é…ç½®æ–¹é¢ï¼š
- åˆç†è®¾ç½®ulimité™åˆ¶
- é…ç½®seccompè¿‡æ»¤è§„åˆ™
- ä½¿ç”¨cgroupsæ§åˆ¶èµ„æº

é˜²æŠ¤æ–¹é¢ï¼š
- åŠæ—¶æ›´æ–°ç³»ç»Ÿè¡¥ä¸
- ä½¿ç”¨å®¹å™¨åŒ–æŠ€æœ¯éš”ç¦»
- éƒ¨ç½²å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


- **ç³»ç»Ÿç®¡ç†å‘˜**ï¼šç†è§£å¦‚ä½•é…ç½®å’Œç›‘æ§ç³»ç»Ÿå®‰å…¨æœºåˆ¶
- **å¼€å‘äººå‘˜**ï¼šäº†è§£å®‰å…¨ç¼–ç¨‹å®è·µï¼Œé¿å…å¸¸è§æ¼æ´
- **å®‰å…¨å·¥ç¨‹å¸ˆ**ï¼šæŒæ¡å†…æ ¸çº§åˆ«çš„å®‰å…¨é˜²æŠ¤åŸç†
- **è¿ç»´å·¥ç¨‹å¸ˆ**ï¼šå­¦ä¼šä½¿ç”¨å„ç§å·¥å…·è¿›è¡Œå®‰å…¨ç›‘æ§

### 10.4 è®°å¿†è¦ç‚¹


> ğŸ’¡ **æ ¸å¿ƒè®°å¿†**ï¼š
> - ç³»ç»Ÿè°ƒç”¨æ˜¯å†…æ ¸å®‰å…¨çš„ç¬¬ä¸€é“é˜²çº¿
> - èº«ä»½éªŒè¯ã€æƒé™æ£€æŸ¥ã€å‚æ•°éªŒè¯ç¼ºä¸€ä¸å¯  
> - èµ„æºé™åˆ¶å’Œè¡Œä¸ºç›‘æ§é˜²æ­¢æ‹’ç»æœåŠ¡æ”»å‡»
> - å®¡è®¡æ—¥å¿—æ˜¯å®‰å…¨åˆ†æçš„é‡è¦ä¾æ®
> - å¤šå±‚é˜²æŠ¤æ¯”å•ä¸€æœºåˆ¶æ›´æœ‰æ•ˆ

**å®‰å…¨å£è¯€**ï¼š
```
ç³»ç»Ÿè°ƒç”¨é—¨å‰ç«™ï¼Œèº«ä»½æƒé™è¦æ£€éªŒ
å‚æ•°åˆæ³•æ‰æ”¾è¡Œï¼Œé¢‘ç‡å¼‚å¸¸è¦æŠ¥è­¦  
å®¡è®¡è®°å½•ä¸å¯å°‘ï¼Œå¼‚å¸¸è¡Œä¸ºæ—©å‘ç°
å¤šå±‚é˜²æŠ¤ä¿å®‰å…¨ï¼Œæ”»é˜²å¹¶é‡ç³»ç»Ÿç¨³
```