---
title: 7ã€ç‰¹æƒæ“ä½œä¸Žæƒé™æå‡
---
## ðŸ“š ç›®å½•

1. [sudoæƒé™å§”æ´¾æœºåˆ¶](#1-sudoæƒé™å§”æ´¾æœºåˆ¶)
2. [SUID/SGIDç¨‹åºå®‰å…¨](#2-suid-sgidç¨‹åºå®‰å…¨)
3. [ç‰¹æƒè¿›ç¨‹ç®¡ç†](#3-ç‰¹æƒè¿›ç¨‹ç®¡ç†)
4. [rootæƒé™æœ€å°åŒ–åŽŸåˆ™](#4-rootæƒé™æœ€å°åŒ–åŽŸåˆ™)
5. [æƒé™æå‡æ”»å‡»é˜²æŠ¤](#5-æƒé™æå‡æ”»å‡»é˜²æŠ¤)
6. [ç‰¹æƒæ“ä½œå®¡è®¡](#6-ç‰¹æƒæ“ä½œå®¡è®¡)
7. [å®‰å…¨ä¸Šä¸‹æ–‡åˆ‡æ¢](#7-å®‰å…¨ä¸Šä¸‹æ–‡åˆ‡æ¢)
8. [ä¸´æ—¶æƒé™æå‡æŽ§åˆ¶](#8-ä¸´æ—¶æƒé™æå‡æŽ§åˆ¶)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸ” sudoæƒé™å§”æ´¾æœºåˆ¶


### 1.1 sudoçš„æœ¬è´¨å«ä¹‰


**ä»€ä¹ˆæ˜¯sudoï¼Ÿ**
```
sudo = "switch user do" æˆ– "substitute user do"
æœ¬è´¨ï¼šå…è®¸æ™®é€šç”¨æˆ·ä»¥å…¶ä»–ç”¨æˆ·èº«ä»½ï¼ˆé€šå¸¸æ˜¯rootï¼‰æ‰§è¡Œç‰¹å®šå‘½ä»¤
ç›®çš„ï¼šåœ¨ä¸ç»™ç”¨æˆ·å®Œæ•´rootæƒé™çš„æƒ…å†µä¸‹ï¼Œè®©å…¶æ‰§è¡Œéœ€è¦ç‰¹æƒçš„æ“ä½œ
```

**ä¸ºä»€ä¹ˆéœ€è¦sudoï¼Ÿ**
- **å®‰å…¨æ€§**ï¼šé¿å…ç›´æŽ¥ä½¿ç”¨rootè´¦æˆ·çš„é£Žé™©
- **å¯æŽ§æ€§**ï¼šç²¾ç¡®æŽ§åˆ¶ç”¨æˆ·èƒ½æ‰§è¡Œå“ªäº›ç‰¹æƒå‘½ä»¤
- **å®¡è®¡æ€§**ï¼šè®°å½•æ‰€æœ‰ç‰¹æƒæ“ä½œï¼Œä¾¿äºŽè¿½è¸ª

### 1.2 sudoå·¥ä½œåŽŸç†


**åŸºæœ¬å·¥ä½œæµç¨‹**
```
ç”¨æˆ·æ‰§è¡Œå‘½ä»¤ï¼šsudo command
         â†“
æ£€æŸ¥/etc/sudoersæ–‡ä»¶æƒé™é…ç½®
         â†“
éªŒè¯ç”¨æˆ·å¯†ç ï¼ˆé»˜è®¤æ˜¯ç”¨æˆ·è‡ªå·±çš„å¯†ç ï¼‰
         â†“
ä¸´æ—¶åˆ‡æ¢åˆ°ç›®æ ‡ç”¨æˆ·èº«ä»½
         â†“
æ‰§è¡Œå‘½ä»¤
         â†“
æ¢å¤åŽŸæ¥çš„ç”¨æˆ·èº«ä»½
```

**sudoä¸Žsuçš„åŒºåˆ«**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ç‰¹æ€§     â”‚     sudo     â”‚      su      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯†ç éªŒè¯    â”‚ ç”¨æˆ·è‡ªå·±å¯†ç  â”‚   ç›®æ ‡ç”¨æˆ·å¯†ç  â”‚
â”‚ æƒé™èŒƒå›´    â”‚ ç‰¹å®šå‘½ä»¤     â”‚   å®Œæ•´shell   â”‚
â”‚ ä¼šè¯ä¿æŒ    â”‚ å•æ¬¡å‘½ä»¤     â”‚   æŒç»­ä¼šè¯    â”‚
â”‚ å®‰å…¨å®¡è®¡    â”‚ è¯¦ç»†è®°å½•     â”‚   åŸºæœ¬è®°å½•    â”‚
â”‚ é…ç½®å¤æ‚åº¦  â”‚ è¾ƒå¤æ‚       â”‚   ç®€å•        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 sudoersé…ç½®æ–‡ä»¶è¯¦è§£


**é…ç½®æ–‡ä»¶ä½ç½®ä¸Žç¼–è¾‘**
```bash
# é…ç½®æ–‡ä»¶ä½ç½®
/etc/sudoers

# æ­£ç¡®çš„ç¼–è¾‘æ–¹å¼ï¼ˆä¼šæ£€æŸ¥è¯­æ³•é”™è¯¯ï¼‰
sudo visudo

# âš ï¸ é”™è¯¯æ–¹å¼ï¼šç›´æŽ¥ç¼–è¾‘å¯èƒ½å¯¼è‡´è¯­æ³•é”™è¯¯é”æ­»ç³»ç»Ÿ
# sudo vi /etc/sudoers  # ä¸è¦è¿™æ ·åšï¼
```

**åŸºæœ¬é…ç½®è¯­æ³•**
```
# åŸºæœ¬æ ¼å¼ï¼šç”¨æˆ· ä¸»æœº=(è¿è¡Œèº«ä»½) å‘½ä»¤
# user host=(runas) command

# å®žä¾‹è§£é‡Š
alice ALL=(ALL) ALL
â”‚     â”‚   â”‚     â”‚
â”‚     â”‚   â”‚     â””â”€â”€ å¯æ‰§è¡Œæ‰€æœ‰å‘½ä»¤
â”‚     â”‚   â””â”€â”€â”€â”€â”€â”€â”€ å¯ä»¥ä»»ä½•ç”¨æˆ·èº«ä»½è¿è¡Œ
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åœ¨æ‰€æœ‰ä¸»æœºä¸Šç”Ÿæ•ˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç”¨æˆ·åalice
```

**å¸¸è§é…ç½®ç¤ºä¾‹**
```bash
# å…è®¸aliceæ‰§è¡Œæ‰€æœ‰å‘½ä»¤
alice ALL=(ALL) ALL

# å…è®¸bobåªèƒ½é‡å¯ç½‘ç»œæœåŠ¡
bob ALL=(root) /sbin/service network restart

# å…è®¸charlieæ‰§è¡Œç³»ç»Ÿæ›´æ–°ï¼Œæ— éœ€å¯†ç 
charlie ALL=(root) NOPASSWD: /usr/bin/yum update

# å…è®¸devç»„æˆå‘˜ç®¡ç†apacheæœåŠ¡
%dev ALL=(root) /sbin/service httpd *

# ç¦æ­¢æŸäº›å±é™©å‘½ä»¤
alice ALL=(root) ALL, !/bin/su, !/usr/bin/passwd root
```

### 1.4 sudoå®žç”¨æŠ€å·§


**å¸¸ç”¨sudoé€‰é¡¹**
```bash
# ä»¥å…¶ä»–ç”¨æˆ·èº«ä»½æ‰§è¡Œ
sudo -u username command

# åˆ‡æ¢åˆ°root shell
sudo -i    # å®Œæ•´çš„rootçŽ¯å¢ƒ
sudo -s    # å½“å‰çŽ¯å¢ƒä¸‹çš„root shell

# åˆ—å‡ºå½“å‰ç”¨æˆ·å¯æ‰§è¡Œçš„sudoå‘½ä»¤
sudo -l

# éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•
sudo visudo -c

# æ›´æ–°sudoæ—¶é—´æˆ³ï¼ˆå»¶é•¿å…å¯†æ—¶é—´ï¼‰
sudo -v
```

**sudoå®‰å…¨é…ç½®**
```bash
# åœ¨sudoersä¸­æ·»åŠ å®‰å…¨é€‰é¡¹
Defaults    requiretty          # è¦æ±‚çœŸå®žç»ˆç«¯
Defaults    !visiblepw          # ä¸æ˜¾ç¤ºå¯†ç æç¤º
Defaults    always_set_home     # è®¾ç½®HOMEçŽ¯å¢ƒå˜é‡
Defaults    match_group_by_gid  # æŒ‰GIDåŒ¹é…ç»„
Defaults    always_query_group_plugin  # æŸ¥è¯¢ç»„æ’ä»¶
Defaults    env_reset           # é‡ç½®çŽ¯å¢ƒå˜é‡
Defaults    env_keep="COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR"
```

---

## 2. ðŸ”’ SUID/SGIDç¨‹åºå®‰å…¨


### 2.1 SUID/SGIDæ¦‚å¿µè§£æž


**ä»€ä¹ˆæ˜¯SUIDï¼Ÿ**
```
SUID = Set User ID
å«ä¹‰ï¼šç¨‹åºè¿è¡Œæ—¶ï¼Œè¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ·IDå˜ä¸ºæ–‡ä»¶æ‰€æœ‰è€…çš„ç”¨æˆ·ID
ç®€å•è¯´ï¼šæ™®é€šç”¨æˆ·æ‰§è¡ŒSUIDç¨‹åºæ—¶ï¼Œä¸´æ—¶èŽ·å¾—æ–‡ä»¶æ‰€æœ‰è€…çš„æƒé™
```

**ä¸ºä»€ä¹ˆéœ€è¦SUIDï¼Ÿ**
```
å®žé™…éœ€æ±‚ï¼šæ™®é€šç”¨æˆ·éœ€è¦æ‰§è¡ŒæŸäº›éœ€è¦ç‰¹æƒçš„æ“ä½œ
ä¾‹å¦‚ï¼š
- ä¿®æ”¹è‡ªå·±çš„å¯†ç ï¼ˆéœ€è¦å†™/etc/shadowæ–‡ä»¶ï¼‰
- æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ
- è®¿é—®ç½‘ç»œæŽ¥å£
```

**SUIDæ ‡å¿—è¯†åˆ«**
```bash
# æŸ¥çœ‹æ–‡ä»¶æƒé™ï¼ŒSUIDç”¨'s'è¡¨ç¤º
ls -l /usr/bin/passwd
-rwsr-xr-x 1 root root 68208 2023-01-01 12:00 /usr/bin/passwd
   ^
   è¿™ä¸ª's'å°±æ˜¯SUIDæ ‡å¿—

# æ•°å­—æƒé™è¡¨ç¤ºï¼š4è¡¨ç¤ºSUID
chmod 4755 filename  # è®¾ç½®SUID
```

### 2.2 SUID/SGIDå·¥ä½œæœºåˆ¶


**æƒé™æå‡è¿‡ç¨‹å›¾ç¤º**
```
æ™®é€šç”¨æˆ·aliceæ‰§è¡Œ/usr/bin/passwdï¼š

æ‰§è¡Œå‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   aliceç”¨æˆ·   â”‚    â”‚ passwdç¨‹åº   â”‚
â”‚   UID: 1001  â”‚    â”‚ æ‰€æœ‰è€…: root â”‚
â”‚   GID: 1001  â”‚    â”‚ SUID: è®¾ç½®   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰§è¡Œæ—¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¿›ç¨‹çŠ¶æ€    â”‚
â”‚ å®žé™…UID: 1001â”‚  â† aliceçš„èº«ä»½
â”‚ æœ‰æ•ˆUID: 0   â”‚  â† rootçš„æƒé™
â”‚ ä¿å­˜UID: 0   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“æžœï¼šaliceå¯ä»¥ä¿®æ”¹å¯†ç æ–‡ä»¶ï¼Œä½†ä»ç„¶æ˜¯aliceåœ¨æ“ä½œ
```

**SGIDçš„å·¥ä½œåŽŸç†**
```
SGID = Set Group ID
ä½œç”¨ï¼š
1. å¯¹æ–‡ä»¶ï¼šè¿›ç¨‹èŽ·å¾—æ–‡ä»¶æ‰€å±žç»„çš„æƒé™
2. å¯¹ç›®å½•ï¼šæ–°å»ºæ–‡ä»¶ç»§æ‰¿ç›®å½•çš„ç»„å±žæ€§

å®žä¾‹ï¼š
drwxrwsr-x 2 root staff 4096 2023-01-01 /shared/
          ^
          è¿™ä¸ª's'è¡¨ç¤ºSGID
```

### 2.3 å¸¸è§SUIDç¨‹åºåˆ†æž


**ç³»ç»Ÿä¸­çš„SUIDç¨‹åº**
```bash
# æŸ¥æ‰¾ç³»ç»Ÿä¸­æ‰€æœ‰SUIDç¨‹åº
find / -perm -4000 -type f 2>/dev/null

# å¸¸è§çš„SUIDç¨‹åºåŠå…¶ç”¨é€”
/usr/bin/passwd   # ä¿®æ”¹å¯†ç 
/usr/bin/su       # åˆ‡æ¢ç”¨æˆ·
/usr/bin/sudo     # æƒé™å§”æ´¾
/bin/ping         # ç½‘ç»œpingï¼ˆéœ€è¦åŽŸå§‹å¥—æŽ¥å­—ï¼‰
/usr/bin/mount    # æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ
/usr/bin/umount   # å¸è½½æ–‡ä»¶ç³»ç»Ÿ
```

**SUIDå®‰å…¨é£Žé™©**
```bash
# ðŸš¨ å±é™©ï¼šä¸å½“çš„SUIDè®¾ç½®
# å¦‚æžœç»™shellè®¾ç½®SUIDï¼Œæ™®é€šç”¨æˆ·å°±èƒ½èŽ·å¾—root shell
chmod 4755 /bin/bash  # âš ï¸ ç»å¯¹ä¸è¦è¿™æ ·åšï¼

# ðŸš¨ å±é™©ï¼šå¯è¢«åˆ©ç”¨çš„SUIDç¨‹åº
# æŸäº›ç¨‹åºå¦‚æžœè®¾ç½®SUIDï¼Œå¯èƒ½è¢«åˆ©ç”¨æå‡æƒé™
/usr/bin/vim       # å¯ä»¥ç¼–è¾‘ä»»ä½•æ–‡ä»¶
/usr/bin/find      # å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤
/usr/bin/less      # å¯ä»¥æŸ¥çœ‹ä»»ä½•æ–‡ä»¶
```

### 2.4 SUIDç¨‹åºå®‰å…¨é˜²æŠ¤


**å®‰å…¨æ£€æŸ¥æ¸…å•**
```bash
# âœ… å®šæœŸå®¡è®¡SUIDç¨‹åº
find / -perm -4000 -type f -ls 2>/dev/null > suid_audit.log

# âœ… ç§»é™¤ä¸å¿…è¦çš„SUIDæƒé™
chmod u-s /path/to/file

# âœ… ä½¿ç”¨ä¸“ç”¨çš„å®‰å…¨å·¥å…·
# å®‰è£…å¹¶è¿è¡Œrkhunteræ£€æŸ¥
yum install rkhunter
rkhunter --check --sk
```

**SUIDæ›¿ä»£æ–¹æ¡ˆ**
```bash
# 1. ä½¿ç”¨sudoæ›¿ä»£SUIDï¼ˆæŽ¨èï¼‰
# ä¸è®¾ç½®ç¨‹åºSUIDï¼Œè€Œæ˜¯é…ç½®sudoè§„åˆ™
alice ALL=(root) /usr/local/bin/myprogram

# 2. ä½¿ç”¨capabilitiesï¼ˆLinuxç‰¹æœ‰ï¼‰
# ç»™ç¨‹åºç‰¹å®šæƒé™è€Œä¸æ˜¯å®Œæ•´rootæƒé™
setcap cap_net_raw+ep /usr/bin/ping

# 3. ä½¿ç”¨ä¸“ç”¨æœåŠ¡è´¦æˆ·
# ç¨‹åºè¿è¡Œåœ¨ä¸“é—¨çš„ä½Žæƒé™ç”¨æˆ·ä¸‹
```

---

## 3. âš™ï¸ ç‰¹æƒè¿›ç¨‹ç®¡ç†


### 3.1 ç‰¹æƒè¿›ç¨‹çš„è¯†åˆ«


**ä»€ä¹ˆæ˜¯ç‰¹æƒè¿›ç¨‹ï¼Ÿ**
```
ç‰¹æƒè¿›ç¨‹ï¼šä»¥rootæˆ–å…¶ä»–ç‰¹æ®Šç”¨æˆ·èº«ä»½è¿è¡Œçš„è¿›ç¨‹
ç‰¹ç‚¹ï¼š
- æ‹¥æœ‰ç³»ç»Ÿçº§æƒé™
- å¯ä»¥è®¿é—®å—é™èµ„æº
- èƒ½å¤Ÿå½±å“ç³»ç»Ÿå®‰å…¨
```

**è¯†åˆ«ç‰¹æƒè¿›ç¨‹çš„æ–¹æ³•**
```bash
# æŸ¥çœ‹æ‰€æœ‰rootè¿›ç¨‹
ps aux | grep "^root"

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„è¿›ç¨‹
ps -u root -f

# æŒ‰æœ‰æ•ˆç”¨æˆ·IDæŸ¥çœ‹
ps -eo pid,euid,cmd | grep "^ *[0-9]* *0"

# ä½¿ç”¨pgrepæŸ¥æ‰¾
pgrep -u root
```

### 3.2 è¿›ç¨‹æƒé™çŠ¶æ€åˆ†æž


**è¿›ç¨‹æƒé™çš„ä¸‰ç§ID**
```bash
# æŸ¥çœ‹è¿›ç¨‹çš„è¯¦ç»†æƒé™ä¿¡æ¯
cat /proc/PID/status | grep -E "(Uid|Gid|Groups)"

ä¾‹å¦‚è¾“å‡ºï¼š
Uid:    1001    0    0    1001
Gid:    1001    0    0    1001
Groups: 1001 0 4 24 27 30 46 108 124 999

è§£é‡Šï¼š
Uid: çœŸå®žUID æœ‰æ•ˆUID ä¿å­˜UID æ–‡ä»¶ç³»ç»ŸUID
â”œâ”€â”€ 1001: å®žé™…ç”¨æˆ·alice
â”œâ”€â”€ 0:    æœ‰æ•ˆæƒé™ä¸ºroot
â”œâ”€â”€ 0:    ä¿å­˜çš„æƒé™ä¸ºroot  
â””â”€â”€ 1001: æ–‡ä»¶ç³»ç»Ÿæ“ä½œç”¨aliceæƒé™
```

**æƒé™æ£€æŸ¥å®žä¾‹**
```bash
# æ£€æŸ¥sudoè¿›ç¨‹çš„æƒé™çŠ¶æ€
pgrep sudo | head -1 | xargs -I {} cat /proc/{}/status | grep Uid

# æ£€æŸ¥SSHå®ˆæŠ¤è¿›ç¨‹
pgrep sshd | head -1 | xargs -I {} cat /proc/{}/status | grep Uid
```

### 3.3 ç‰¹æƒè¿›ç¨‹ç›‘æŽ§


**å®žæ—¶ç›‘æŽ§ç‰¹æƒè¿›ç¨‹**
```bash
# ä½¿ç”¨topç›‘æŽ§rootè¿›ç¨‹
top -u root

# ä½¿ç”¨htopï¼ˆæ›´ç›´è§‚ï¼‰
htop -u root

# ç›‘æŽ§æ–°å¯åŠ¨çš„rootè¿›ç¨‹
watch 'ps aux | grep "^root" | tail -10'
```

**ç‰¹æƒè¿›ç¨‹å®¡è®¡è„šæœ¬**
```bash
#!/bin/bash
# ç‰¹æƒè¿›ç¨‹ç›‘æŽ§è„šæœ¬
echo "=== ç‰¹æƒè¿›ç¨‹æŠ¥å‘Š $(date) ==="

# ç»Ÿè®¡å„ç”¨æˆ·è¿›ç¨‹æ•°é‡
echo "æŒ‰ç”¨æˆ·ç»Ÿè®¡è¿›ç¨‹ï¼š"
ps aux | awk '{print $1}' | sort | uniq -c | sort -nr

# æŸ¥æ‰¾å¼‚å¸¸çš„rootè¿›ç¨‹
echo -e "\nå¯ç–‘çš„rootè¿›ç¨‹ï¼š"
ps aux | grep "^root" | grep -v "\[" | awk '$11 !~ /^\/(bin|sbin|usr)/ {print $0}'

# æ£€æŸ¥SUIDè¿›ç¨‹
echo -e "\nå½“å‰SUIDè¿›ç¨‹ï¼š"
ps aux | while read line; do
    pid=$(echo $line | awk '{print $2}')
    if [ -f "/proc/$pid/exe" ]; then
        if ls -l "/proc/$pid/exe" 2>/dev/null | grep -q "^-rws"; then
            echo $line
        fi
    fi
done 2>/dev/null
```

---

## 4. ðŸ›¡ï¸ rootæƒé™æœ€å°åŒ–åŽŸåˆ™


### 4.1 æœ€å°åŒ–åŽŸåˆ™çš„æ ¸å¿ƒæ€æƒ³


**ä»€ä¹ˆæ˜¯æƒé™æœ€å°åŒ–ï¼Ÿ**
```
å®šä¹‰ï¼šç»™ç”¨æˆ·å’Œç¨‹åºåˆ†é…å®Œæˆä»»åŠ¡æ‰€éœ€çš„æœ€å°æƒé™é›†åˆ
ç›®æ ‡ï¼š
- å‡å°‘æ”»å‡»é¢
- é™åˆ¶æ½œåœ¨æŸå®³
- æé«˜ç³»ç»Ÿå®‰å…¨æ€§
```

**æƒé™åˆ†çº§ç­–ç•¥**
```
æƒé™é‡‘å­—å¡”ï¼š
           root (ç³»ç»Ÿç®¡ç†å‘˜)
          /              \
    æ™®é€šç®¡ç†å‘˜           æœåŠ¡è´¦æˆ·
   (å¤‡ä»½ã€ç›‘æŽ§)         (apacheã€mysql)
      /                        \
  æ™®é€šç”¨æˆ·                    å—é™æœåŠ¡
 (å¼€å‘äººå‘˜)                  (nobodyã€daemon)
```

### 4.2 é¿å…ç›´æŽ¥ä½¿ç”¨root


**ä¸ºä»€ä¹ˆä¸ç›´æŽ¥ç”¨rootï¼Ÿ**
```
ðŸš¨ é£Žé™©åˆ†æžï¼š
1. è¯¯æ“ä½œé£Žé™©ï¼šrm -rf / ç­‰è‡´å‘½å‘½ä»¤
2. æƒé™è¿‡åº¦ï¼šæ‰€æœ‰æ“ä½œéƒ½æœ‰æœ€é«˜æƒé™
3. å®¡è®¡å›°éš¾ï¼šæ— æ³•åŒºåˆ†ä¸åŒç®¡ç†å‘˜çš„æ“ä½œ
4. å®‰å…¨æ¼æ´žï¼šä¸€æ—¦è¢«æ”»ç ´ï¼Œæ•´ä¸ªç³»ç»Ÿæ²¦é™·
```

**æ›¿ä»£æ–¹æ¡ˆè®¾è®¡**
```bash
# 1. åˆ›å»ºä¸“é—¨çš„ç®¡ç†è´¦æˆ·
useradd -m -s /bin/bash admin
usermod -aG wheel admin  # åŠ å…¥sudoç»„

# 2. é…ç½®sudoè§„åˆ™ï¼ŒæŒ‰èŒè´£åˆ†é…æƒé™
# ç³»ç»Ÿç®¡ç†å‘˜
admin ALL=(ALL) ALL

# ç½‘ç»œç®¡ç†å‘˜  
netadmin ALL=(root) /sbin/iptables, /usr/sbin/tcpdump

# å¤‡ä»½ç®¡ç†å‘˜
backupadmin ALL=(root) /bin/tar, /usr/bin/rsync

# ç›‘æŽ§ç®¡ç†å‘˜
monitor ALL=(root) /bin/ps, /usr/bin/top, /var/log/*
```

### 4.3 æœåŠ¡æƒé™æœ€å°åŒ–


**æœåŠ¡è´¦æˆ·è®¾è®¡åŽŸåˆ™**
```bash
# åˆ›å»ºä¸“ç”¨æœåŠ¡è´¦æˆ·ï¼ˆä¸èƒ½ç™»å½•ï¼‰
useradd -r -s /sbin/nologin -d /var/lib/myservice myservice

# è®¾ç½®åˆé€‚çš„æ–‡ä»¶æƒé™
chown myservice:myservice /var/lib/myservice
chmod 750 /var/lib/myservice

# é…ç½®æœåŠ¡ä»¥éžrootç”¨æˆ·è¿è¡Œ
# åœ¨systemdæœåŠ¡æ–‡ä»¶ä¸­ï¼š
[Service]
User=myservice
Group=myservice
```

**å®žé™…é…ç½®ç¤ºä¾‹**
```bash
# ApacheæœåŠ¡æƒé™é…ç½®
# /etc/httpd/conf/httpd.conf
User apache
Group apache

# MySQLæœåŠ¡æƒé™
# /etc/my.cnf
[mysqld]
user = mysql

# Nginxæƒé™é…ç½®  
# /etc/nginx/nginx.conf
user nginx nginx;
```

### 4.4 æƒé™å®¡è®¡ä¸Žæ£€æŸ¥


**å®šæœŸæƒé™å®¡è®¡**
```bash
#!/bin/bash
# æƒé™å®¡è®¡è„šæœ¬

echo "=== ç³»ç»Ÿæƒé™å®¡è®¡æŠ¥å‘Š ==="

# æ£€æŸ¥ç©ºå¯†ç è´¦æˆ·
echo "ç©ºå¯†ç è´¦æˆ·ï¼š"
awk -F: '($2 == "") {print $1}' /etc/shadow

# æ£€æŸ¥UIDä¸º0çš„è´¦æˆ·ï¼ˆåº”è¯¥åªæœ‰rootï¼‰
echo "UIDä¸º0çš„è´¦æˆ·ï¼š"
awk -F: '($3 == 0) {print $1}' /etc/passwd

# æ£€æŸ¥æ— å½’å±žçš„æ–‡ä»¶
echo "æ— å½’å±žæ–‡ä»¶ï¼ˆå‰10ä¸ªï¼‰ï¼š"
find / -nouser -o -nogroup 2>/dev/null | head -10

# æ£€æŸ¥world-writableæ–‡ä»¶
echo "å…¨å±€å¯å†™æ–‡ä»¶ï¼š"
find / -perm -002 -type f 2>/dev/null | head -10
```

---

## 5. ðŸ” æƒé™æå‡æ”»å‡»é˜²æŠ¤


### 5.1 å¸¸è§æƒé™æå‡æ”»å‡»æ‰‹æ³•


**æœ¬åœ°æƒé™æå‡æ”»å‡»ç±»åž‹**
```
1. SUIDç¨‹åºåˆ©ç”¨
   - åˆ©ç”¨æœ‰æ¼æ´žçš„SUIDç¨‹åº
   - ä¾‹ï¼šç¼“å†²åŒºæº¢å‡ºã€å‘½ä»¤æ³¨å…¥

2. å†…æ ¸æ¼æ´žåˆ©ç”¨  
   - åˆ©ç”¨å†…æ ¸bugèŽ·å¾—rootæƒé™
   - ä¾‹ï¼šè„ç‰›(Dirty COW)æ¼æ´ž

3. é…ç½®é”™è¯¯åˆ©ç”¨
   - sudoé…ç½®é”™è¯¯
   - æ–‡ä»¶æƒé™è®¾ç½®ä¸å½“

4. æœåŠ¡æ¼æ´žåˆ©ç”¨
   - è¿è¡Œåœ¨rootæƒé™ä¸‹çš„æœåŠ¡æ¼æ´ž
   - ä¾‹ï¼šWebæœåŠ¡ã€æ•°æ®åº“æœåŠ¡æ¼æ´ž
```

**æ”»å‡»æ£€æµ‹æ–¹æ³•**
```bash
# ç›‘æŽ§å¼‚å¸¸çš„æƒé™å˜åŒ–
auditctl -w /etc/passwd -p wa -k passwd_changes
auditctl -w /etc/shadow -p wa -k shadow_changes

# ç›‘æŽ§SUIDç¨‹åºæ‰§è¡Œ
auditctl -a always,exit -F arch=b64 -S execve -F euid=0 -F uid!=0

# ç›‘æŽ§sudoä½¿ç”¨
tail -f /var/log/secure | grep sudo

# æ£€æŸ¥å¼‚å¸¸è¿›ç¨‹
ps aux | awk '$1 != "root" && $2 ~ /^[0-9]+$/ && $11 ~ /^\// {print}'
```

### 5.2 é˜²æŠ¤é…ç½®ç­–ç•¥


**ç³»ç»ŸåŠ å›ºæŽªæ–½**
```bash
# 1. ç¦ç”¨ä¸å¿…è¦çš„SUIDç¨‹åº
find /usr/bin -perm -4000 -exec chmod u-s {} \; 2>/dev/null

# 2. é™åˆ¶/tmpç›®å½•æ‰§è¡Œæƒé™
mount -o remount,noexec /tmp

# 3. å¯ç”¨åœ°å€ç©ºé—´éšæœºåŒ–
echo 2 > /proc/sys/kernel/randomize_va_space

# 4. é…ç½®å†…æ ¸å‚æ•°
# /etc/sysctl.conf
kernel.dmesg_restrict = 1        # é™åˆ¶dmesgè®¿é—®
kernel.kptr_restrict = 2         # éšè—å†…æ ¸æŒ‡é’ˆ
net.ipv4.ip_forward = 0          # ç¦ç”¨IPè½¬å‘
```

**sudoå®‰å…¨é…ç½®å¢žå¼º**
```bash
# /etc/sudoers å®‰å…¨é…ç½®
Defaults    requiretty           # è¦æ±‚çœŸå®žTTY
Defaults    !visiblepw           # éšè—å¯†ç 
Defaults    always_set_home      # é‡ç½®HOME
Defaults    match_group_by_gid   # ä¸¥æ ¼ç»„åŒ¹é…
Defaults    always_query_group_plugin

# é™åˆ¶å±é™©å‘½ä»¤
%admin ALL=(ALL) ALL, !/bin/su -, !/usr/bin/passwd root, !/usr/bin/visudo

# è®¾ç½®ä¼šè¯è¶…æ—¶
Defaults    timestamp_timeout=5  # 5åˆ†é’ŸåŽé‡æ–°éªŒè¯
```

### 5.3 å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ


**åŸºäºŽæ—¥å¿—çš„æ£€æµ‹**
```bash
# ç›‘æŽ§sudoæ»¥ç”¨
grep "COMMAND" /var/log/secure | grep -v "usual_commands" 

# æ£€æµ‹æƒé™æå‡å°è¯•
grep -E "su:|sudo:" /var/log/secure | grep -E "FAILED|incorrect"

# ç›‘æŽ§å¼‚å¸¸ç™»å½•
grep "session opened for user root" /var/log/secure | grep -v "expected_sources"
```

**å®žæ—¶ç›‘æŽ§è„šæœ¬**
```bash
#!/bin/bash
# æƒé™æå‡ç›‘æŽ§è„šæœ¬

LOG_FILE="/var/log/privilege_monitor.log"

while true; do
    # æ£€æµ‹æ–°çš„rootè¿›ç¨‹
    NEW_ROOT_PROCS=$(ps aux | grep "^root" | wc -l)
    
    if [ $NEW_ROOT_PROCS -gt $LAST_COUNT ]; then
        echo "$(date): æ£€æµ‹åˆ°æ–°çš„rootè¿›ç¨‹" >> $LOG_FILE
        ps aux | grep "^root" | tail -5 >> $LOG_FILE
    fi
    
    LAST_COUNT=$NEW_ROOT_PROCS
    sleep 10
done
```

---

## 6. ðŸ“Š ç‰¹æƒæ“ä½œå®¡è®¡


### 6.1 å®¡è®¡ç³»ç»Ÿæ¦‚è¿°


**ä¸ºä»€ä¹ˆéœ€è¦å®¡è®¡ï¼Ÿ**
```
æ³•è§„è¦æ±‚ï¼šå¾ˆå¤šè¡Œä¸šæ ‡å‡†è¦æ±‚å®¡è®¡ç‰¹æƒæ“ä½œ
å®‰å…¨éœ€è¦ï¼šè¿½è¸ªæ”»å‡»è·¯å¾„ï¼Œåˆ†æžå®‰å…¨äº‹ä»¶
ç®¡ç†éœ€è¦ï¼šäº†è§£ç³»ç»Ÿä½¿ç”¨æƒ…å†µï¼Œä¼˜åŒ–æƒé™é…ç½®
é—®è´£éœ€è¦ï¼šæ˜Žç¡®æ“ä½œè´£ä»»ï¼Œé˜²æ­¢å†…éƒ¨å¨èƒ
```

**Linuxå®¡è®¡æž¶æž„**
```
åº”ç”¨å±‚ï¼šsudo, su, sshç­‰
    â†“
å®¡è®¡æ¡†æž¶ï¼šauditd (Linux Audit Framework)
    â†“  
å†…æ ¸å±‚ï¼šaudit subsystem
    â†“
å­˜å‚¨å±‚ï¼š/var/log/audit/audit.log
```

### 6.2 auditdé…ç½®ä¸Žä½¿ç”¨


**å®‰è£…å’Œå¯åŠ¨auditd**
```bash
# å®‰è£…auditåŒ…
yum install audit audit-libs

# å¯åŠ¨å¹¶å¯ç”¨æœåŠ¡
systemctl start auditd
systemctl enable auditd

# æŸ¥çœ‹å®¡è®¡çŠ¶æ€
auditctl -s
```

**åŸºç¡€å®¡è®¡è§„åˆ™é…ç½®**
```bash
# ç›‘æŽ§passwdæ–‡ä»¶å˜åŒ–
auditctl -w /etc/passwd -p wa -k passwd_changes

# ç›‘æŽ§shadowæ–‡ä»¶
auditctl -w /etc/shadow -p wa -k shadow_changes

# ç›‘æŽ§sudoersæ–‡ä»¶
auditctl -w /etc/sudoers -p wa -k sudoers_changes

# ç›‘æŽ§æ‰€æœ‰sudoæ‰§è¡Œ
auditctl -a always,exit -F arch=b64 -S execve -F euid=0 -F auid>=1000 -k sudo_exec

# ç›‘æŽ§suå‘½ä»¤
auditctl -w /bin/su -p x -k su_usage
```

**æ°¸ä¹…ä¿å­˜å®¡è®¡è§„åˆ™**
```bash
# ç¼–è¾‘å®¡è®¡è§„åˆ™æ–‡ä»¶
vi /etc/audit/rules.d/audit.rules

# æ·»åŠ è§„åˆ™
-w /etc/passwd -p wa -k passwd_changes
-w /etc/shadow -p wa -k shadow_changes  
-w /etc/sudoers -p wa -k sudoers_changes
-a always,exit -F arch=b64 -S execve -F euid=0 -F auid>=1000 -k privilege_escalation

# é‡å¯å®¡è®¡æœåŠ¡ç”Ÿæ•ˆ
service auditd restart
```

### 6.3 å®¡è®¡æ—¥å¿—åˆ†æž


**å®¡è®¡æ—¥å¿—æ ¼å¼è§£è¯»**
```bash
# æŸ¥çœ‹å®¡è®¡æ—¥å¿—
tail -f /var/log/audit/audit.log

# æ—¥å¿—ç¤ºä¾‹åŠè§£è¯»
type=SYSCALL msg=audit(1642678800.123:456): arch=c000003e syscall=59 success=yes exit=0 a0=7fff12345678 a1=7fff23456789 a2=7fff34567890 a3=0 items=2 ppid=1234 pid=5678 auid=1001 uid=1001 gid=1001 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts0 ses=3 comm="sudo" exe="/usr/bin/sudo"

è§£è¯»ï¼š
- type=SYSCALL: ç³»ç»Ÿè°ƒç”¨å®¡è®¡è®°å½•
- auid=1001: å®¡è®¡ç”¨æˆ·IDï¼ˆå®žé™…ç™»å½•ç”¨æˆ·ï¼‰
- euid=0: æœ‰æ•ˆç”¨æˆ·IDï¼ˆæ‰§è¡Œæ—¶æƒé™ï¼‰
- comm="sudo": æ‰§è¡Œçš„å‘½ä»¤
- exe="/usr/bin/sudo": ç¨‹åºè·¯å¾„
```

**å®žç”¨å®¡è®¡æŸ¥è¯¢å‘½ä»¤**
```bash
# æŸ¥è¯¢ç‰¹å®šç”¨æˆ·çš„sudoæ“ä½œ
ausearch -i -k sudo_exec -ua alice

# æŸ¥è¯¢å¤±è´¥çš„æƒé™æ“ä½œ
ausearch -i -m USER_AUTH -sv no

# æŸ¥è¯¢æ–‡ä»¶è®¿é—®è®°å½•
ausearch -i -f /etc/passwd

# ç”Ÿæˆå®¡è®¡æŠ¥å‘Š
aureport --summary
aureport --auth  # è®¤è¯æŠ¥å‘Š
aureport --exec  # æ‰§è¡ŒæŠ¥å‘Š
```

### 6.4 å®¡è®¡æ—¥å¿—ç®¡ç†


**æ—¥å¿—è½®è½¬é…ç½®**
```bash
# é…ç½®auditæ—¥å¿—è½®è½¬
vi /etc/logrotate.d/audit

å†…å®¹ï¼š
/var/log/audit/audit.log {
    daily
    rotate 30
    compress
    delaycompress  
    missingok
    notifempty
    create 0600 root root
    postrotate
        /sbin/service auditd restart > /dev/null 2>&1 || true
    endrotate
}
```

**å®¡è®¡ç­–ç•¥ä¼˜åŒ–**
```bash
# é¿å…å®¡è®¡é£Žæš´ï¼ˆè¿‡å¤šæ—¥å¿—ï¼‰
# åªå®¡è®¡å…³é”®æ“ä½œï¼Œä¸è¦å®¡è®¡æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨

# æŽ¨èçš„æœ€å°å®¡è®¡é›†
-w /etc/passwd -p wa -k identity_changes
-w /etc/group -p wa -k identity_changes  
-w /etc/shadow -p wa -k identity_changes
-w /etc/sudoers -p wa -k privilege_changes
-a always,exit -F arch=b64 -S execve -F euid=0 -F auid!=0 -k privilege_escalation
```

---

## 7. ðŸ”„ å®‰å…¨ä¸Šä¸‹æ–‡åˆ‡æ¢


### 7.1 ç”¨æˆ·èº«ä»½åˆ‡æ¢æœºåˆ¶


**èº«ä»½åˆ‡æ¢çš„å‡ ç§æ–¹å¼**
```
1. su (switch user)
   - å®Œå…¨åˆ‡æ¢åˆ°å¦ä¸€ä¸ªç”¨æˆ·
   - éœ€è¦ç›®æ ‡ç”¨æˆ·å¯†ç 
   
2. sudo (substitute user do)  
   - ä»¥å…¶ä»–ç”¨æˆ·èº«ä»½æ‰§è¡Œå‘½ä»¤
   - ä½¿ç”¨è‡ªå·±çš„å¯†ç 
   
3. runuser
   - rootä¸“ç”¨çš„ç”¨æˆ·åˆ‡æ¢å‘½ä»¤
   - ä¸éœ€è¦å¯†ç éªŒè¯
```

**suå‘½ä»¤è¯¦è§£**
```bash
# åŸºæœ¬ç”¨æ³•
su username          # åˆ‡æ¢ç”¨æˆ·ï¼Œä¿æŒå½“å‰çŽ¯å¢ƒ
su - username        # å®Œæ•´åˆ‡æ¢ï¼ˆæŽ¨èï¼‰
su -l username       # åŒä¸Šï¼Œå®Œæ•´ç™»å½•

# å®žä¾‹å¯¹æ¯”
su alice             # éƒ¨åˆ†çŽ¯å¢ƒåˆ‡æ¢
env | grep HOME      # HOMEä»ç„¶æ˜¯åŽŸç”¨æˆ·
pwd                  # ç›®å½•ä¸å˜

su - alice           # å®Œæ•´çŽ¯å¢ƒåˆ‡æ¢  
env | grep HOME      # HOMEå˜ä¸ºaliceçš„å®¶ç›®å½•
pwd                  # åˆ‡æ¢åˆ°aliceçš„å®¶ç›®å½•
```

### 7.2 çŽ¯å¢ƒå˜é‡å®‰å…¨


**çŽ¯å¢ƒå˜é‡çš„å®‰å…¨é£Žé™©**
```bash
# ðŸš¨ å±é™©ï¼šæ¶æ„çŽ¯å¢ƒå˜é‡
export PATH="/tmp:$PATH"     # åŠ«æŒå‘½ä»¤è·¯å¾„
export LD_PRELOAD="/tmp/evil.so"  # åŠ«æŒåº“åŠ è½½

# æŸ¥çœ‹å½“å‰çŽ¯å¢ƒå˜é‡
env | sort

# sudoçš„çŽ¯å¢ƒå˜é‡å¤„ç†
sudo env              # æŸ¥çœ‹sudoåŽçš„çŽ¯å¢ƒ
sudo -i env           # å®Œæ•´rootçŽ¯å¢ƒ
```

**å®‰å…¨çš„çŽ¯å¢ƒå˜é‡é…ç½®**
```bash
# sudoå®‰å…¨çŽ¯å¢ƒé…ç½®ï¼ˆ/etc/sudoersï¼‰
Defaults env_reset                    # é‡ç½®çŽ¯å¢ƒå˜é‡
Defaults env_keep="LANG LC_* HOME"    # ä¿ç•™å®‰å…¨å˜é‡
Defaults secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# æ£€æŸ¥PATHå®‰å…¨æ€§
echo $PATH | tr ':' '\n' | while read dir; do
    [ -w "$dir" ] && echo "è­¦å‘Šï¼š$dir ç›®å½•å¯å†™ï¼"
done
```

### 7.3 ä¼šè¯ç®¡ç†ä¸Žå®‰å…¨


**ä¼šè¯è¶…æ—¶æŽ§åˆ¶**
```bash
# è®¾ç½®shellè¶…æ—¶ï¼ˆç§’ï¼‰
export TMOUT=300     # 5åˆ†é’Ÿæ— æ“ä½œè‡ªåŠ¨é€€å‡º

# sudoä¼šè¯è¶…æ—¶
# /etc/sudoersä¸­è®¾ç½®
Defaults timestamp_timeout=5  # 5åˆ†é’ŸåŽé‡æ–°éªŒè¯å¯†ç 

# SSHä¼šè¯è¶…æ—¶
# /etc/ssh/sshd_config
ClientAliveInterval 300
ClientAliveCountMax 2
```

**ä¼šè¯å®¡è®¡å¢žå¼º**
```bash
# è®°å½•æ‰€æœ‰å‘½ä»¤åˆ°æ—¥å¿—
export PROMPT_COMMAND='history -a; logger -p local1.notice "$(whoami) [$$]: $(history 1 | sed "s/^[ ]*[0-9]\+[ ]*//" )"'

# æˆ–è€…ä½¿ç”¨scriptå‘½ä»¤è®°å½•ä¼šè¯
script -a /var/log/user_sessions/$(whoami)-$(date +%Y%m%d-%H%M%S).log
```

---

## 8. â° ä¸´æ—¶æƒé™æå‡æŽ§åˆ¶


### 8.1 ä¸´æ—¶æƒé™çš„è®¾è®¡åŽŸåˆ™


**ä¸ºä»€ä¹ˆéœ€è¦ä¸´æ—¶æƒé™ï¼Ÿ**
```
å®žé™…éœ€æ±‚ï¼š
- ç´§æ€¥ç»´æŠ¤æ“ä½œ
- ä¸´æ—¶é¡¹ç›®éœ€è¦  
- çŸ­æœŸæƒé™å§”æ´¾
- æ•…éšœæŽ’é™¤éœ€è¦

é£Žé™©æŽ§åˆ¶ï¼š
- æ—¶é—´é™åˆ¶
- æ“ä½œé™åˆ¶
- å®¡è®¡è¿½è¸ª
- è‡ªåŠ¨å›žæ”¶
```

**ä¸´æ—¶æƒé™æž¶æž„**
```
è¯·æ±‚æƒé™ â†’ å®¡æ‰¹æµç¨‹ â†’ æƒé™æŽˆäºˆ â†’ ä½¿ç”¨ç›‘æŽ§ â†’ è‡ªåŠ¨å›žæ”¶
    â†“           â†“           â†“           â†“           â†“
  ç”¨æˆ·ç”³è¯·   ç®¡ç†å‘˜æ‰¹å‡†   ç³»ç»Ÿé…ç½®   å®žæ—¶å®¡è®¡   å®šæ—¶æ¸…ç†
```

### 8.2 åŸºäºŽæ—¶é—´çš„æƒé™æŽ§åˆ¶


**ä½¿ç”¨atå‘½ä»¤å®žçŽ°å®šæ—¶æƒé™å›žæ”¶**
```bash
# ä¸´æ—¶ç»™ç”¨æˆ·alice sudoæƒé™
echo "alice ALL=(ALL) ALL" >> /etc/sudoers.d/temp_alice

# è®¾ç½®1å°æ—¶åŽè‡ªåŠ¨åˆ é™¤æƒé™
echo "rm -f /etc/sudoers.d/temp_alice" | at now + 1 hour

# æŸ¥çœ‹å¾…æ‰§è¡Œçš„atä½œä¸š
atq

# å–æ¶ˆå®šæ—¶ä½œä¸šï¼ˆå¦‚æžœéœ€è¦æå‰æ’¤é”€ï¼‰
atrm ä½œä¸šå·
```

**ä¸´æ—¶æƒé™ç®¡ç†è„šæœ¬**
```bash
#!/bin/bash
# ä¸´æ—¶æƒé™ç®¡ç†è„šæœ¬

grant_temp_sudo() {
    local username=$1
    local duration_hours=$2
    local temp_file="/etc/sudoers.d/temp_${username}"
    
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    if ! id "$username" &>/dev/null; then
        echo "é”™è¯¯ï¼šç”¨æˆ· $username ä¸å­˜åœ¨"
        return 1
    fi
    
    # æŽˆäºˆæƒé™
    echo "$username ALL=(ALL) ALL" > "$temp_file"
    echo "å·²ç»™ç”¨æˆ· $username æŽˆäºˆä¸´æ—¶sudoæƒé™"
    
    # è®¾ç½®å®šæ—¶å›žæ”¶
    echo "rm -f $temp_file; echo 'å·²å›žæ”¶ç”¨æˆ· $username çš„ä¸´æ—¶æƒé™' | mail admin@company.com" | at now + ${duration_hours} hours
    
    # è®°å½•æ“ä½œ
    logger "ä¸´æ—¶æƒé™æŽˆäºˆï¼šç”¨æˆ·=$usernameï¼Œæ—¶é•¿=${duration_hours}å°æ—¶"
}

# ä½¿ç”¨ç¤ºä¾‹
grant_temp_sudo alice 4  # ç»™alice 4å°æ—¶çš„sudoæƒé™
```

### 8.3 åŸºäºŽæ¡ä»¶çš„æƒé™æŽ§åˆ¶


**IPåœ°å€é™åˆ¶çš„ä¸´æ—¶æƒé™**
```bash
# sudoersä¸­åŸºäºŽä¸»æœºçš„æƒé™æŽ§åˆ¶
alice 192.168.1.10=(ALL) ALL          # åªèƒ½ä»Žç‰¹å®šIPä½¿ç”¨
alice LOCAL=(ALL) /usr/bin/systemctl   # åªèƒ½åœ¨æœ¬åœ°ä½¿ç”¨ç‰¹å®šå‘½ä»¤

# ä½¿ç”¨è„šæœ¬æ£€æŸ¥æ¥æºIP
#!/bin/bash
# check_ip_sudo.sh
ALLOWED_IP="192.168.1.100"
CLIENT_IP=$SSH_CLIENT

if [[ $CLIENT_IP =~ ^$ALLOWED_IP ]]; then
    exec sudo "$@"
else
    echo "é”™è¯¯ï¼šä¸å…è®¸ä»ŽIP $CLIENT_IP ä½¿ç”¨sudo"
    exit 1
fi
```

**åŸºäºŽæ—¶é—´æ®µçš„æƒé™æŽ§åˆ¶**
```bash
#!/bin/bash
# å·¥ä½œæ—¶é—´æƒé™æ£€æŸ¥
CURRENT_HOUR=$(date +%H)
CURRENT_DAY=$(date +%u)  # 1-7 (Monday-Sunday)

# åªå…è®¸å·¥ä½œæ—¶é—´ï¼ˆå‘¨ä¸€åˆ°å‘¨äº”ï¼Œ9-18ç‚¹ï¼‰ä½¿ç”¨sudo
if [ $CURRENT_DAY -ge 1 ] && [ $CURRENT_DAY -le 5 ] && [ $CURRENT_HOUR -ge 9 ] && [ $CURRENT_HOUR -lt 18 ]; then
    exec sudo "$@"
else
    echo "é”™è¯¯ï¼šå½“å‰æ—¶é—´ä¸å…è®¸ä½¿ç”¨sudoæƒé™"
    echo "å…è®¸æ—¶é—´ï¼šå‘¨ä¸€è‡³å‘¨äº” 09:00-18:00"
    exit 1
fi
```

### 8.4 æƒé™è¯·æ±‚ä¸Žå®¡æ‰¹æµç¨‹


**ç®€å•çš„æƒé™è¯·æ±‚ç³»ç»Ÿ**
```bash
#!/bin/bash
# æƒé™è¯·æ±‚è„šæœ¬

request_privilege() {
    local username=$1
    local reason="$2"
    local duration=$3
    
    # åˆ›å»ºè¯·æ±‚è®°å½•
    cat >> /var/log/privilege_requests.log << EOF
æ—¶é—´: $(date)
ç”¨æˆ·: $username
åŽŸå› : $reason  
æ—¶é•¿: $duration å°æ—¶
çŠ¶æ€: å¾…å®¡æ‰¹
è¯·æ±‚ID: $(date +%s)
EOF
    
    # å‘é€é‚®ä»¶é€šçŸ¥ç®¡ç†å‘˜
    echo "ç”¨æˆ· $username è¯·æ±‚ä¸´æ—¶æƒé™ï¼ŒåŽŸå› ï¼š$reasonï¼Œæ—¶é•¿ï¼š$duration å°æ—¶" | \
    mail -s "æƒé™æå‡è¯·æ±‚" admin@company.com
    
    echo "æƒé™è¯·æ±‚å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹"
}

# ç®¡ç†å‘˜å®¡æ‰¹è„šæœ¬
approve_request() {
    local request_id=$1
    local username=$2
    local duration=$3
    
    # æŽˆäºˆæƒé™
    grant_temp_sudo "$username" "$duration"
    
    # æ›´æ–°è¯·æ±‚çŠ¶æ€
    sed -i "/$request_id/,+5s/çŠ¶æ€: å¾…å®¡æ‰¹/çŠ¶æ€: å·²æ‰¹å‡†/" /var/log/privilege_requests.log
    
    # é€šçŸ¥ç”¨æˆ·
    echo "æ‚¨çš„æƒé™è¯·æ±‚å·²æ‰¹å‡†ï¼Œæœ‰æ•ˆæœŸ $duration å°æ—¶" | mail "$username@company.com"
}
```

---

## 9. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ðŸ”¸ sudoæœºåˆ¶ï¼šæƒé™å§”æ´¾çš„æ ¸å¿ƒå·¥å…·ï¼Œæ¯”ç›´æŽ¥ä½¿ç”¨rootæ›´å®‰å…¨
ðŸ”¸ SUID/SGIDï¼šç¨‹åºè¿è¡Œæ—¶çš„æƒé™æå‡æœºåˆ¶ï¼Œéœ€è¦è°¨æ…Žç®¡ç†
ðŸ”¸ ç‰¹æƒè¿›ç¨‹ï¼šç³»ç»Ÿä¸­è¿è¡Œçš„é«˜æƒé™è¿›ç¨‹ï¼Œéœ€è¦ç›‘æŽ§å’Œç®¡ç†
ðŸ”¸ æœ€å°æƒé™ï¼šç»™äºˆç”¨æˆ·å®Œæˆä»»åŠ¡æ‰€éœ€çš„æœ€å°æƒé™é›†åˆ
ðŸ”¸ æƒé™å®¡è®¡ï¼šè®°å½•å’Œåˆ†æžæ‰€æœ‰ç‰¹æƒæ“ä½œï¼Œç”¨äºŽå®‰å…¨å’Œåˆè§„
ðŸ”¸ å®‰å…¨åˆ‡æ¢ï¼šå®‰å…¨åœ°åœ¨ä¸åŒç”¨æˆ·èº«ä»½é—´åˆ‡æ¢
ðŸ”¸ ä¸´æ—¶æƒé™ï¼šæœ‰æ—¶é—´é™åˆ¶çš„æƒé™æŽˆäºˆï¼Œé™ä½Žé•¿æœŸé£Žé™©
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ sudo vs su vs ç›´æŽ¥rootçš„åŒºåˆ«**
```
sudoä¼˜åŠ¿ï¼š
âœ… ç”¨è‡ªå·±å¯†ç ï¼Œä¸éœ€è¦çŸ¥é“rootå¯†ç 
âœ… å¯ä»¥ç²¾ç¡®æŽ§åˆ¶æƒé™èŒƒå›´
âœ… è¯¦ç»†çš„æ“ä½œå®¡è®¡æ—¥å¿—
âœ… æ”¯æŒæ—¶é—´é™åˆ¶å’Œæ¡ä»¶é™åˆ¶

sué€‚ç”¨åœºæ™¯ï¼š
âœ… éœ€è¦é•¿æ—¶é—´ä»¥å…¶ä»–ç”¨æˆ·èº«ä»½å·¥ä½œ
âœ… æ‰§è¡Œå¤šä¸ªè¿žç»­çš„ç‰¹æƒå‘½ä»¤
âœ… ç®¡ç†å‘˜ç»´æŠ¤æ“ä½œ

ç›´æŽ¥rootçš„é—®é¢˜ï¼š
âŒ æƒé™è¿‡å¤§ï¼Œè¯¯æ“ä½œé£Žé™©é«˜
âŒ æ— æ³•åŒºåˆ†ä¸åŒæ“ä½œè€…
âŒ å®‰å…¨æ¼æ´žå½±å“æ•´ä¸ªç³»ç»Ÿ
```

**ðŸ”¹ SUIDç¨‹åºçš„åŒåˆƒå‰‘æ•ˆåº”**
```
å¿…è¦æ€§ï¼š
âœ… æ™®é€šç”¨æˆ·æ‰§è¡Œç‰¹æƒæ“ä½œçš„å”¯ä¸€é€”å¾„
âœ… ç³»ç»Ÿæ­£å¸¸è¿è¡Œçš„åŸºç¡€æœºåˆ¶
âœ… ç²¾ç¡®çš„æƒé™æŽ§åˆ¶æ‰‹æ®µ

å±é™©æ€§ï¼š  
âš ï¸ å¯èƒ½è¢«æ¶æ„åˆ©ç”¨æå‡æƒé™
âš ï¸ ç¨‹åºæ¼æ´žå½±å“ä¸¥é‡
âš ï¸ é…ç½®é”™è¯¯å¸¦æ¥å®‰å…¨é£Žé™©

ç®¡ç†åŽŸåˆ™ï¼š
ðŸ”§ å®šæœŸå®¡è®¡æ‰€æœ‰SUIDç¨‹åº
ðŸ”§ ç§»é™¤ä¸å¿…è¦çš„SUIDæƒé™
ðŸ”§ ä½¿ç”¨sudoç­‰æ›¿ä»£æ–¹æ¡ˆ
```

**ðŸ”¹ æƒé™æå‡æ”»å‡»çš„é˜²æŠ¤æ€è·¯**
```
æ£€æµ‹å±‚é¢ï¼š
ðŸ‘€ ç›‘æŽ§å¼‚å¸¸çš„æƒé™å˜åŒ–
ðŸ‘€ å®¡è®¡ç‰¹æƒç¨‹åºæ‰§è¡Œ
ðŸ‘€ åˆ†æžç³»ç»Ÿè°ƒç”¨æ¨¡å¼

é¢„é˜²å±‚é¢ï¼š
ðŸ›¡ï¸ æœ€å°æƒé™åŽŸåˆ™
ðŸ›¡ï¸ å®šæœŸå®‰å…¨æ›´æ–°
ðŸ›¡ï¸ ç³»ç»ŸåŠ å›ºé…ç½®

å“åº”å±‚é¢ï¼š
ðŸš¨ å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ
ðŸš¨ è‡ªåŠ¨åŒ–å“åº”æœºåˆ¶  
ðŸš¨ äº‹ä»¶åˆ†æžå’Œæº¯æº
```

### 9.3 å®žé™…åº”ç”¨æŒ‡å¯¼


**ðŸŽ¯ ä¼ä¸šçŽ¯å¢ƒæœ€ä½³å®žè·µ**
- **ç¦ç”¨rootç›´æŽ¥ç™»å½•**ï¼šé€šè¿‡sudoç®¡ç†ç‰¹æƒæ“ä½œ
- **åˆ†å±‚æƒé™ç®¡ç†**ï¼šæŒ‰èŒè´£åˆ†é…ä¸åŒçº§åˆ«çš„æƒé™  
- **å¼ºåˆ¶å®¡è®¡**ï¼šè®°å½•æ‰€æœ‰ç‰¹æƒæ“ä½œç”¨äºŽåˆè§„
- **å®šæœŸæƒé™å®¡æŸ¥**ï¼šæ¸…ç†ä¸å¿…è¦çš„æƒé™æŽˆäºˆ
- **åº”æ€¥å“åº”é¢„æ¡ˆ**ï¼šæƒé™æ³„éœ²æ—¶çš„å¤„ç†æµç¨‹

**ðŸ”§ æŠ€æœ¯å®žçŽ°è¦ç‚¹**
- **sudoé…ç½®**ï¼šä½¿ç”¨visudoç¼–è¾‘ï¼Œé¿å…è¯­æ³•é”™è¯¯
- **SUIDç®¡ç†**ï¼šå®šæœŸæ‰«æï¼ŒåŠæ—¶æ¸…ç†å¼‚å¸¸ç¨‹åº
- **å®¡è®¡é…ç½®**ï¼šå¹³è¡¡å®‰å…¨éœ€æ±‚å’Œæ€§èƒ½å½±å“
- **çŽ¯å¢ƒå®‰å…¨**ï¼šé‡ç½®çŽ¯å¢ƒå˜é‡ï¼Œé˜²æ­¢è·¯å¾„åŠ«æŒ
- **ä¼šè¯ç®¡ç†**ï¼šè®¾ç½®è¶…æ—¶ï¼Œé™åˆ¶å¹¶å‘ä¼šè¯

**âš ï¸ å¸¸è§é”™è¯¯é¿å…**
- **é…ç½®é”™è¯¯**ï¼šsudoersè¯­æ³•é”™è¯¯å¯èƒ½é”æ­»ç³»ç»Ÿ
- **æƒé™è¿‡åº¦**ï¼šç»™äºˆç”¨æˆ·è¶…è¿‡éœ€è¦çš„æƒé™
- **å®¡è®¡ç›²åŒº**ï¼šå¿½ç•¥æŸäº›é‡è¦çš„ç‰¹æƒæ“ä½œ
- **åº”æ€¥è´¦æˆ·**ï¼šå¿˜è®°è®¾ç½®ç´§æ€¥rootè®¿é—®æ–¹å¼
- **æƒé™æ¸…ç†**ï¼šä¸´æ—¶æƒé™å¿˜è®°åŠæ—¶å›žæ”¶

**ðŸš€ è¿›é˜¶å­¦ä¹ æ–¹å‘**
- **SELinux/AppArmor**ï¼šæ›´ç²¾ç»†çš„å¼ºåˆ¶è®¿é—®æŽ§åˆ¶
- **å®¹å™¨å®‰å…¨**ï¼šDockerç­‰å®¹å™¨çŽ¯å¢ƒçš„æƒé™ç®¡ç†  
- **äº‘çŽ¯å¢ƒæƒé™**ï¼šIAMè§’è‰²å’Œç­–ç•¥ç®¡ç†
- **é›¶ä¿¡ä»»æž¶æž„**ï¼šåŠ¨æ€æƒé™éªŒè¯å’ŒæŽˆäºˆ
- **è‡ªåŠ¨åŒ–è¿ç»´**ï¼šæƒé™ç®¡ç†çš„è‡ªåŠ¨åŒ–å’Œç¼–æŽ’

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- sudoè®©æƒé™ä½¿ç”¨æ›´å®‰å…¨å¯æŽ§
- SUIDæ˜¯å¿…éœ€ä½†éœ€è¦è°¨æ…Žç®¡ç†çš„æœºåˆ¶  
- æœ€å°æƒé™åŽŸåˆ™æ˜¯å®‰å…¨çš„åŸºç¡€
- å®¡è®¡è®©æ‰€æœ‰æ“ä½œå¯è¿½æº¯
- ä¸´æ—¶æƒé™å¹³è¡¡äº†çµæ´»æ€§å’Œå®‰å…¨æ€§
- æ”»å‡»é˜²æŠ¤éœ€è¦æ£€æµ‹ã€é¢„é˜²ã€å“åº”å¹¶é‡