---
title: 3、本地密码策略配置
---
## 📚 目录

1. [密码策略基本概念](#1-密码策略基本概念)
2. [全局登录策略配置](#2-全局登录策略配置)
3. [密码复杂度控制](#3-密码复杂度控制)
4. [PAM密码质量模块](#4-PAM密码质量模块)
5. [密码策略管理命令](#5-密码策略管理命令)
6. [实际配置案例](#6-实际配置案例)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔐 密码策略基本概念


### 1.1 什么是本地密码策略


**密码策略**就是系统管理员制定的关于用户密码的规则，用来保证系统安全。简单说就是**规定用户的密码应该怎么设置**。

```
为什么需要密码策略？

❌ 弱密码问题：
用户名: admin    密码: 123456
用户名: root     密码: password
用户名: test     密码: test

✅ 密码策略保护：
- 密码最短8位
- 必须包含大小写字母
- 必须包含数字和特殊字符
- 定期更换密码
```

### 1.2 密码策略的作用范围


**本地密码策略**主要管理这些方面：

```
🔸 密码复杂度：密码应该多复杂
🔸 密码长度：最短和最长限制
🔸 密码历史：不能重复使用以前的密码
🔸 密码过期：多长时间必须更换
🔸 登录限制：登录失败几次锁定账户
```

### 1.3 Linux密码策略架构


```
Linux密码策略体系架构：

用户登录
    ↓
PAM认证系统 ←→ /etc/login.defs (全局策略)
    ↓             ↓
密码检查模块 ←→ /etc/security/pwquality.conf
    ↓
密码验证通过 → 允许登录/修改密码
```

---

## 2. 📋 全局登录策略配置


### 2.1 /etc/login.defs文件详解


**login.defs**是Linux系统的**全局登录策略配置文件**，控制用户登录和密码的基本行为。

```bash
# 查看当前login.defs配置
sudo cat /etc/login.defs | grep -v ^# | grep -v ^$
```

### 2.2 核心配置参数详解


**密码过期相关配置：**

```bash
# /etc/login.defs 中的关键配置

# 密码最大有效期（天）
PASS_MAX_DAYS    90

# 密码最小有效期（天）- 密码修改后多久才能再次修改
PASS_MIN_DAYS    1

# 密码过期前警告天数
PASS_WARN_AGE    7

# 密码最小长度
PASS_MIN_LEN     8
```

**通俗解释：**
- `PASS_MAX_DAYS 90`：密码90天后过期，必须更换
- `PASS_MIN_DAYS 1`：改密码后1天内不能再改，防止用户改回原密码
- `PASS_WARN_AGE 7`：密码到期前7天开始提醒用户
- `PASS_MIN_LEN 8`：密码最少8个字符

**用户账户相关配置：**

```bash
# 用户ID范围配置
UID_MIN         1000    # 普通用户UID起始值
UID_MAX         60000   # 普通用户UID最大值
SYS_UID_MIN     201     # 系统用户UID起始值
SYS_UID_MAX     999     # 系统用户UID最大值

# 组ID范围配置  
GID_MIN         1000
GID_MAX         60000

# 用户主目录设置
CREATE_HOME     yes     # 创建用户时自动创建主目录
```

### 2.3 实际配置示例


```bash
# 编辑全局策略配置
sudo vim /etc/login.defs

# 推荐的安全配置
PASS_MAX_DAYS    90      # 密码90天过期
PASS_MIN_DAYS    1       # 修改密码后1天内不能再改
PASS_WARN_AGE    7       # 过期前7天警告
PASS_MIN_LEN     12      # 密码最短12位

# 登录失败处理
LOGIN_RETRIES    3       # 登录重试3次
LOGIN_TIMEOUT    60      # 登录超时60秒

# 用户会话管理
UMASK           027      # 默认文件权限掩码
```

---

## 3. 🛠️ 密码复杂度控制


### 3.1 passwd命令的密码检查


**passwd命令**在用户修改密码时会进行基本的复杂度检查：

```bash
# 普通用户修改自己的密码
passwd

# 管理员修改其他用户密码
sudo passwd username
```

**passwd命令的内置检查：**

```
✅ 检查项目：
- 密码长度是否足够
- 密码是否太简单（如123456）
- 密码是否与用户名相同
- 密码是否是常见弱密码

❌ 常见错误提示：
"BAD PASSWORD: The password is too simple"
"BAD PASSWORD: The password is shorter than 8 characters"
"BAD PASSWORD: The password is the same as the old one"
```

### 3.2 系统内置密码检查机制


**Linux系统的密码检查流程：**

```
用户输入新密码
    ↓
检查最小长度 (/etc/login.defs中的PASS_MIN_LEN)
    ↓
检查是否为常见弱密码
    ↓
检查是否与用户名相关
    ↓
检查历史密码重复
    ↓
密码验证通过 → 更新密码
```

### 3.3 提高密码安全性的建议


**好的密码示例：**

```
❌ 弱密码：
- 123456
- password
- admin
- 用户名相同

✅ 强密码：
- MyP@ssw0rd2024!
- Secure#123$Linux
- Strong&P@ss9876

强密码特征：
🔸 长度至少12位
🔸 包含大写字母
🔸 包含小写字母  
🔸 包含数字
🔸 包含特殊字符
🔸 不包含个人信息
```

---

## 4. ⚙️ PAM密码质量模块


### 4.1 什么是PAM密码质量模块


**PAM（Pluggable Authentication Modules）**是Linux的认证框架，**pam_pwquality**是专门用来检查密码质量的模块。

```
PAM工作原理：

应用程序(如passwd) → PAM框架 → pam_pwquality模块 → 密码检查
                              ↓
                         配置文件：/etc/security/pwquality.conf
```

### 4.2 安装pam_pwquality模块


```bash
# Ubuntu/Debian系统
sudo apt update
sudo apt install libpam-pwquality

# CentOS/RHEL系统  
sudo yum install libpwquality
# 或者 RHEL 8+
sudo dnf install libpwquality
```

### 4.3 pwquality.conf配置文件详解


**主要配置文件：**`/etc/security/pwquality.conf`

```bash
# 查看当前配置
sudo cat /etc/security/pwquality.conf | grep -v ^# | grep -v ^$

# 编辑配置文件
sudo vim /etc/security/pwquality.conf
```

**核心配置参数：**

```bash
# /etc/security/pwquality.conf 配置示例

# 密码长度要求
minlen = 12                    # 最小长度12位
maxrepeat = 2                  # 相同字符最多连续2个

# 字符类型要求
minclass = 3                   # 至少包含3种字符类型
dcredit = -1                   # 至少包含1个数字 
ucredit = -1                   # 至少包含1个大写字母
lcredit = -1                   # 至少包含1个小写字母
ocredit = -1                   # 至少包含1个特殊字符

# 字典检查
dictcheck = 1                  # 启用字典检查，避免常见单词
```

**配置参数详细说明：**

| 参数 | 含义 | 示例值 | 说明 |
|------|------|--------|------|
| `minlen` | **密码最小长度** | `12` | 密码不能少于12位 |
| `maxrepeat` | **重复字符限制** | `2` | 相同字符不能连续超过2个 |
| `minclass` | **字符类型数量** | `3` | 至少包含3种类型（数字、大小写、特殊字符） |
| `dcredit` | **数字字符要求** | `-1` | 负数表示至少包含几个，正数表示最多包含几个 |
| `ucredit` | **大写字母要求** | `-1` | 至少包含1个大写字母 |
| `lcredit` | **小写字母要求** | `-1` | 至少包含1个小写字母 |
| `ocredit` | **特殊字符要求** | `-1` | 至少包含1个特殊字符 |

### 4.4 PAM模块配置


**配置PAM使用pwquality模块：**

```bash
# 编辑PAM配置文件
sudo vim /etc/pam.d/common-password

# 添加或修改以下行
password requisite pam_pwquality.so retry=3

# 参数说明：
# requisite: 必须通过检查
# retry=3: 密码检查失败可以重试3次
```

---

## 5. 🔧 密码策略管理命令


### 5.1 chage命令详解


**chage命令**用于管理用户密码的**过期时间和策略**，是密码策略管理的核心工具。

```bash
# 查看用户密码策略信息
sudo chage -l username

# 示例输出：
Last password change                    : Dec 15, 2024
Password expires                        : Mar 15, 2025
Password inactive                       : never
Account expires                         : never
Minimum number of days between password change : 1
Maximum number of days between password change : 90
Number of days of warning before password expires : 7
```

### 5.2 chage命令常用参数


**设置密码过期策略：**

```bash
# 设置密码最大有效期为90天
sudo chage -M 90 username

# 设置密码最小间隔为1天（防止立即改回原密码）
sudo chage -m 1 username

# 设置过期前7天开始警告
sudo chage -W 7 username

# 强制用户下次登录时修改密码
sudo chage -d 0 username

# 设置账户过期日期
sudo chage -E 2025-12-31 username
```

**参数详细说明：**

| 参数 | 含义 | 示例 | 说明 |
|------|------|------|------|
| `-M days` | **密码最大有效期** | `-M 90` | 密码90天后过期 |
| `-m days` | **密码最小间隔期** | `-m 1` | 改密码后1天内不能再改 |
| `-W days` | **过期警告期** | `-W 7` | 过期前7天开始警告 |
| `-d date` | **最后修改日期** | `-d 0` | 强制下次登录修改密码 |
| `-E date` | **账户过期日期** | `-E 2025-12-31` | 账户2025年12月31日过期 |
| `-I days` | **密码过期后宽限期** | `-I 30` | 密码过期后30天内仍可登录 |

### 5.3 passwd命令的策略选项


```bash
# 锁定用户账户
sudo passwd -l username

# 解锁用户账户  
sudo passwd -u username

# 删除用户密码（无密码登录，危险操作）
sudo passwd -d username

# 查看密码状态
sudo passwd -S username

# 输出示例：
# testuser PS 2024-12-15 1 90 7 -1 (Password set, SHA512 crypt)
# 状态说明：PS=密码已设置, LK=账户锁定, NP=无密码
```

### 5.4 密码历史记录管理


**限制密码重复使用：**

```bash
# 编辑PAM配置
sudo vim /etc/pam.d/common-password

# 添加密码历史记录限制
password sufficient pam_unix.so remember=5

# remember=5 表示不能重复使用最近5次的密码
```

---

## 6. 📝 实际配置案例


### 6.1 企业级密码策略配置


**场景：**为公司配置安全的密码策略

**第一步：配置全局策略**

```bash
sudo vim /etc/login.defs

# 企业级密码策略配置
PASS_MAX_DAYS    90      # 密码90天过期
PASS_MIN_DAYS    1       # 修改后1天内不能再改
PASS_WARN_AGE    7       # 过期前7天警告  
PASS_MIN_LEN     12      # 最短12位
LOGIN_RETRIES    3       # 最多重试3次
LOGIN_TIMEOUT    60      # 登录超时60秒
```

**第二步：配置密码复杂度**

```bash
sudo vim /etc/security/pwquality.conf

# 企业级复杂度要求
minlen = 12              # 最短12位
minclass = 4             # 必须包含4种字符类型
dcredit = -2             # 至少2个数字
ucredit = -1             # 至少1个大写字母
lcredit = -1             # 至少1个小写字母  
ocredit = -1             # 至少1个特殊字符
maxrepeat = 2            # 相同字符不超过2个连续
dictcheck = 1            # 启用字典检查
```

**第三步：配置PAM模块**

```bash
sudo vim /etc/pam.d/common-password

# 启用密码质量检查和历史记录
password requisite pam_pwquality.so retry=3
password sufficient pam_unix.so remember=5 sha512
```

### 6.2 批量设置用户密码策略


```bash
#!/bin/bash
# 批量设置密码策略脚本

# 用户列表
users=("alice" "bob" "charlie" "david")

for user in "${users[@]}"; do
    echo "设置用户 $user 的密码策略..."
    
    # 设置密码过期策略
    sudo chage -M 90 -m 1 -W 7 $user
    
    # 强制下次登录修改密码
    sudo chage -d 0 $user
    
    echo "用户 $user 策略设置完成"
done
```

### 6.3 密码策略检查脚本


```bash
#!/bin/bash
# 检查系统密码策略配置

echo "=== 系统密码策略检查报告 ==="
echo

echo "1. 全局登录策略 (/etc/login.defs):"
echo "密码最大有效期: $(grep ^PASS_MAX_DAYS /etc/login.defs | awk '{print $2}') 天"
echo "密码最小间隔: $(grep ^PASS_MIN_DAYS /etc/login.defs | awk '{print $2}') 天"
echo "过期警告期: $(grep ^PASS_WARN_AGE /etc/login.defs | awk '{print $2}') 天"
echo

echo "2. 密码复杂度策略:"
if [ -f /etc/security/pwquality.conf ]; then
    echo "最小长度: $(grep ^minlen /etc/security/pwquality.conf | cut -d= -f2 | tr -d ' ')"
    echo "字符类型要求: $(grep ^minclass /etc/security/pwquality.conf | cut -d= -f2 | tr -d ' ')"
else
    echo "未配置pwquality模块"
fi
echo

echo "3. 用户密码状态检查:"
echo "用户名    状态    最后修改    过期时间"
echo "----------------------------------------"
for user in $(cut -d: -f1 /etc/passwd | grep -v "^root$" | head -5); do
    status=$(sudo passwd -S $user 2>/dev/null | awk '{print $2}')
    if [ "$status" = "PS" ]; then
        echo "$user    正常    $(sudo chage -l $user | grep 'Last password change' | cut -d: -f2)"
    fi
done
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心概念


```
🔸 密码策略本质：制定用户密码安全规则，保护系统安全
🔸 配置文件层次：/etc/login.defs(全局) → /etc/security/pwquality.conf(复杂度)
🔸 PAM认证框架：Linux统一认证系统，pam_pwquality负责密码检查
🔸 chage命令：密码策略管理的核心工具
🔸 三个关键时间：最大有效期、最小间隔期、过期警告期
```

### 7.2 关键理解要点


**🔹 密码策略的三个层次**
```
系统层：/etc/login.defs - 基础策略配置
模块层：PAM + pwquality - 复杂度检查  
用户层：chage命令 - 个人策略管理
```

**🔹 密码安全的平衡**
```
安全性 vs 用户体验：
- 太复杂：用户难记住，可能写在纸上（更不安全）
- 太简单：容易被破解
- 合理策略：12位+复杂度要求+定期更换
```

**🔹 策略执行的时机**
```
设置时检查：passwd命令修改密码时
登录时检查：账户过期、密码过期检查
周期性提醒：过期前警告用户
```

### 7.3 实际应用建议


**企业环境推荐配置：**
```
密码长度：12位以上
复杂度：包含4种字符类型
过期时间：90天
历史记录：不能重复最近5次密码
登录限制：3次失败后锁定
```

**个人用户推荐配置：**
```
密码长度：8位以上  
复杂度：包含3种字符类型
过期时间：180天（可选）
定期检查：手动检查弱密码
```

**常见问题处理：**
```
密码过于复杂用户抱怨：
→ 提供密码管理器使用培训
→ 设置合理的复杂度要求

用户忘记密码频繁：
→ 加强密码策略宣传教育
→ 建立密码重置流程

系统登录缓慢：  
→ 检查PAM模块配置是否合理
→ 优化认证流程
```

**核心记忆要点：**
- 密码策略三要素：长度、复杂度、时效性
- 配置文件两个：login.defs全局，pwquality.conf复杂度
- 管理命令一个：chage设置用户策略
- 安全原则：既要安全，也要实用