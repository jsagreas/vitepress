---
title: 13ã€åº”ç”¨éƒ¨ç½²ä¸CICDé›†æˆ
---
## ğŸ“š ç›®å½•

1. [HelmåŒ…ç®¡ç†å™¨æ·±å…¥ä½¿ç”¨](#1-helmåŒ…ç®¡ç†å™¨æ·±å…¥ä½¿ç”¨)
2. [Kustomizeé…ç½®ç®¡ç†å·¥å…·](#2-kustomizeé…ç½®ç®¡ç†å·¥å…·)
3. [GitOpså·¥ä½œæµç¨‹è®¾è®¡](#3-gitopså·¥ä½œæµç¨‹è®¾è®¡)
4. [é•œåƒæ„å»ºä¸æ¨é€æµæ°´çº¿](#4-é•œåƒæ„å»ºä¸æ¨é€æµæ°´çº¿)
5. [æ»šåŠ¨å‘å¸ƒä¸è“ç»¿éƒ¨ç½²](#5-æ»šåŠ¨å‘å¸ƒä¸è“ç»¿éƒ¨ç½²)
6. [é‡‘ä¸é›€å‘å¸ƒç­–ç•¥å®ç°](#6-é‡‘ä¸é›€å‘å¸ƒç­–ç•¥å®ç°)
7. [åº”ç”¨å¥åº·æ£€æŸ¥é…ç½®](#7-åº”ç”¨å¥åº·æ£€æŸ¥é…ç½®)
8. [å‘å¸ƒå›æ»šä¸ç‰ˆæœ¬ç®¡ç†](#8-å‘å¸ƒå›æ»šä¸ç‰ˆæœ¬ç®¡ç†)
9. [å¤šç¯å¢ƒéƒ¨ç½²ç®¡é“è®¾è®¡](#9-å¤šç¯å¢ƒéƒ¨ç½²ç®¡é“è®¾è®¡)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“¦ HelmåŒ…ç®¡ç†å™¨æ·±å…¥ä½¿ç”¨


### 1.1 ä»€ä¹ˆæ˜¯Helmï¼Ÿ


> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šæŠŠHelmæƒ³è±¡æˆæ‰‹æœºçš„åº”ç”¨å•†åº—ï¼Œè€ŒKubernetesåº”ç”¨å°±æ˜¯APPã€‚Helmè®©ä½ ä¸€é”®å®‰è£…ã€å‡çº§ã€ç®¡ç†å¤æ‚çš„K8såº”ç”¨ã€‚

**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **Chart**ï¼šåº”ç”¨åŒ…ï¼ˆç›¸å½“äºå®‰è£…åŒ…ï¼‰
- **Release**ï¼šChartçš„ä¸€ä¸ªè¿è¡Œå®ä¾‹ï¼ˆç›¸å½“äºå·²å®‰è£…çš„APPï¼‰
- **Repository**ï¼šChartä»“åº“ï¼ˆç›¸å½“äºåº”ç”¨å•†åº—ï¼‰

```
ä¼ ç»Ÿéƒ¨ç½²æ–¹å¼ï¼š
kubectl apply -f deployment.yaml
kubectl apply -f service.yaml  
kubectl apply -f configmap.yaml
...ï¼ˆéœ€è¦ç®¡ç†å¾ˆå¤šæ–‡ä»¶ï¼‰

ä½¿ç”¨Helmï¼š
helm install myapp ./mychart
ï¼ˆä¸€æ¡å‘½ä»¤æå®šæ‰€æœ‰èµ„æºï¼‰
```

### 1.2 Helm Chartç»“æ„


**ğŸ“ Chartç›®å½•ç»“æ„**ï¼š
```
mychart/
â”œâ”€â”€ Chart.yaml          # Chartå…ƒä¿¡æ¯
â”œâ”€â”€ values.yaml         # é»˜è®¤é…ç½®å€¼
â”œâ”€â”€ templates/          # æ¨¡æ¿æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â”œâ”€â”€ configmap.yaml
â”‚   â””â”€â”€ _helpers.tpl    # è¾…åŠ©æ¨¡æ¿
â”œâ”€â”€ charts/            # ä¾èµ–çš„å­Chart
â””â”€â”€ README.md          # è¯´æ˜æ–‡æ¡£
```

**ğŸ”§ Chart.yamlç¤ºä¾‹**ï¼š
```yaml
apiVersion: v2
name: webapp
description: ä¸€ä¸ªç®€å•çš„Webåº”ç”¨Chart
version: 0.1.0          # Chartç‰ˆæœ¬
appVersion: "1.0"       # åº”ç”¨ç‰ˆæœ¬
dependencies:           # ä¾èµ–é¡¹
  - name: mysql
    version: "9.4.0"
    repository: "https://charts.bitnami.com/bitnami"
```

### 1.3 æ¨¡æ¿è¯­æ³•ä¸é…ç½®ç®¡ç†


**ğŸ¯ æ¨¡æ¿è¯­æ³•åŸºç¡€**ï¼š
```yaml
# templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.appName }}
  labels:
    app: {{ .Values.appName }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: {{ .Values.appName }}
  template:
    spec:
      containers:
      - name: {{ .Values.appName }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        ports:
        - containerPort: {{ .Values.service.port }}
```

**âš™ï¸ values.yamlé…ç½®**ï¼š
```yaml
# é»˜è®¤é…ç½®å€¼
appName: webapp
replicaCount: 3

image:
  repository: nginx
  tag: "1.20"
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 80

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi
```

### 1.4 Helmå¸¸ç”¨æ“ä½œå‘½ä»¤


| æ“ä½œ | **å‘½ä»¤** | **è¯´æ˜** |
|------|---------|---------|
| ğŸ” **æœç´¢Chart** | `helm search repo nginx` | åœ¨ä»“åº“ä¸­æœç´¢Chart |
| ğŸ“¦ **å®‰è£…åº”ç”¨** | `helm install webapp ./mychart` | å®‰è£…Chartåˆ°é›†ç¾¤ |
| ğŸ”„ **å‡çº§åº”ç”¨** | `helm upgrade webapp ./mychart` | å‡çº§å·²å®‰è£…çš„Release |
| ğŸ“Š **æŸ¥çœ‹çŠ¶æ€** | `helm status webapp` | æŸ¥çœ‹ReleaseçŠ¶æ€ |
| ğŸ“‹ **åˆ—å‡ºåº”ç”¨** | `helm list` | åˆ—å‡ºæ‰€æœ‰Release |
| ğŸ—‘ï¸ **å¸è½½åº”ç”¨** | `helm uninstall webapp` | å¸è½½Release |
| ğŸ“œ **æŸ¥çœ‹å†å²** | `helm history webapp` | æŸ¥çœ‹ç‰ˆæœ¬å†å² |

**ğŸ”¸ å®ç”¨æŠ€å·§**ï¼š
```bash
# å¹²è¿è¡Œï¼ŒæŸ¥çœ‹ä¼šç”Ÿæˆä»€ä¹ˆèµ„æº
helm install webapp ./mychart --dry-run --debug

# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
helm install webapp ./mychart -f custom-values.yaml

# è®¾ç½®å•ä¸ªé…ç½®é¡¹
helm install webapp ./mychart --set replicaCount=5
```

---

## 2. ğŸ”§ Kustomizeé…ç½®ç®¡ç†å·¥å…·


### 2.1 Kustomizeæ˜¯ä»€ä¹ˆï¼Ÿ


> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ æœ‰ä¸€ä¸ªåŸºç¡€çš„æˆ¿å­è®¾è®¡å›¾ï¼ŒKustomizeå°±æ˜¯è®©ä½ åœ¨ä¸ä¿®æ”¹åŸå›¾çš„æƒ…å†µä¸‹ï¼Œä¸ºä¸åŒç¯å¢ƒï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰"è´´è¡¥ä¸"å®šåˆ¶æˆ¿å­ã€‚

**ğŸ¯ è®¾è®¡ç†å¿µ**ï¼š
- **æ— æ¨¡æ¿**ï¼šä¸ä½¿ç”¨å¤æ‚çš„æ¨¡æ¿è¯­æ³•
- **å£°æ˜å¼**ï¼šé€šè¿‡è¡¥ä¸æ–¹å¼ä¿®æ”¹é…ç½®
- **ç»§æ‰¿å¼**ï¼šåŸºäºåŸºç¡€é…ç½®è¿›è¡Œå®šåˆ¶

### 2.2 ç›®å½•ç»“æ„è®¾è®¡


```
kustomize-example/
â”œâ”€â”€ base/                    # åŸºç¡€é…ç½®
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â”œâ”€â”€ configmap.yaml
â”‚   â””â”€â”€ kustomization.yaml   # åŸºç¡€é…ç½®æ¸…å•
â””â”€â”€ overlays/               # ç¯å¢ƒå®šåˆ¶
    â”œâ”€â”€ dev/                # å¼€å‘ç¯å¢ƒ
    â”‚   â”œâ”€â”€ patch-replica.yaml
    â”‚   â””â”€â”€ kustomization.yaml
    â”œâ”€â”€ staging/            # æµ‹è¯•ç¯å¢ƒ
    â”‚   â”œâ”€â”€ patch-replica.yaml
    â”‚   â”œâ”€â”€ patch-resource.yaml
    â”‚   â””â”€â”€ kustomization.yaml
    â””â”€â”€ prod/               # ç”Ÿäº§ç¯å¢ƒ
        â”œâ”€â”€ patch-replica.yaml
        â”œâ”€â”€ patch-hpa.yaml
        â””â”€â”€ kustomization.yaml
```

### 2.3 åŸºç¡€é…ç½®å®šä¹‰


**ğŸ”¸ base/kustomization.yaml**ï¼š
```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# åŸºç¡€èµ„æºåˆ—è¡¨
resources:
  - deployment.yaml
  - service.yaml
  - configmap.yaml

# é€šç”¨æ ‡ç­¾
commonLabels:
  app: webapp
  version: v1.0

# åç§°å‰ç¼€
namePrefix: myapp-

# é•œåƒæ›¿æ¢
images:
  - name: nginx
    newTag: 1.20-alpine
```

**ğŸ”¸ base/deployment.yaml**ï¼š
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 1  # åŸºç¡€å‰¯æœ¬æ•°
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      containers:
      - name: webapp
        image: nginx:latest
        ports:
        - containerPort: 80
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
```

### 2.4 ç¯å¢ƒå®šåˆ¶é…ç½®


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒå®šåˆ¶**ï¼š
```yaml
# overlays/prod/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# ç»§æ‰¿åŸºç¡€é…ç½®
bases:
  - ../../base

# ç”Ÿäº§ç¯å¢ƒè¡¥ä¸
patchesStrategicMerge:
  - patch-replica.yaml      # ä¿®æ”¹å‰¯æœ¬æ•°
  - patch-resources.yaml    # ä¿®æ”¹èµ„æºé™åˆ¶

# ç”Ÿäº§ç¯å¢ƒæ ‡ç­¾
commonLabels:
  env: production

# é•œåƒæ ‡ç­¾
images:
  - name: nginx
    newTag: 1.20-stable

# æ·»åŠ ç”Ÿäº§ç¯å¢ƒä¸“æœ‰èµ„æº
resources:
  - hpa.yaml               # æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹
```

**ğŸ”¸ patch-replica.yaml**ï¼š
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 5  # ç”Ÿäº§ç¯å¢ƒ5ä¸ªå‰¯æœ¬
```

### 2.5 Kustomizeä½¿ç”¨æ–¹æ³•


| æ“ä½œ | **å‘½ä»¤** | **è¯´æ˜** |
|------|---------|---------|
| ğŸ” **é¢„è§ˆé…ç½®** | `kubectl kustomize overlays/prod` | æŸ¥çœ‹ç”Ÿæˆçš„YAML |
| ğŸš€ **ç›´æ¥éƒ¨ç½²** | `kubectl apply -k overlays/prod` | éƒ¨ç½²åˆ°æŒ‡å®šç¯å¢ƒ |
| ğŸ“‹ **æ„å»ºè¾“å‡º** | `kustomize build overlays/prod > prod.yaml` | è¾“å‡ºæœ€ç»ˆé…ç½® |

---

## 3. ğŸ”„ GitOpså·¥ä½œæµç¨‹è®¾è®¡


### 3.1 GitOpsæ ¸å¿ƒç†å¿µ


> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šæŠŠGitä»“åº“å½“ä½œ"å”¯ä¸€çœŸç†æº"ï¼Œæ‰€æœ‰çš„éƒ¨ç½²å’Œé…ç½®å˜æ›´éƒ½é€šè¿‡Gitæ¥é©±åŠ¨ã€‚å°±åƒç”¨é¥æ§å™¨æ§åˆ¶ç”µè§†ä¸€æ ·ï¼ŒGitå°±æ˜¯æ§åˆ¶Kubernetesçš„"é¥æ§å™¨"ã€‚

**ğŸ¯ æ ¸å¿ƒåŸåˆ™**ï¼š
- **å£°æ˜å¼**ï¼šæè¿°æœŸæœ›çŠ¶æ€ï¼Œè€Œéæ‰§è¡Œæ­¥éª¤
- **ç‰ˆæœ¬åŒ–**ï¼šæ‰€æœ‰é…ç½®éƒ½åœ¨Gitä¸­ç‰ˆæœ¬ç®¡ç†
- **è‡ªåŠ¨åŒ–**ï¼šç³»ç»Ÿè‡ªåŠ¨åŒæ­¥GitçŠ¶æ€åˆ°é›†ç¾¤
- **å¯è§‚æµ‹**ï¼šå¯ä»¥çœ‹åˆ°å½“å‰çŠ¶æ€å’ŒæœŸæœ›çŠ¶æ€çš„å·®å¼‚

### 3.2 GitOpsæ¶æ„è®¾è®¡


```
å¼€å‘æµç¨‹æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¼€å‘äººå‘˜    â”‚â”€â”€â”€â–¶â”‚   Gitä»“åº“    â”‚â”€â”€â”€â–¶â”‚  GitOpså·¥å…·  â”‚
â”‚  æäº¤ä»£ç     â”‚    â”‚   é…ç½®æ–‡ä»¶   â”‚    â”‚ (ArgoCDç­‰)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                    â”‚
                           â–¼                    â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   CIæµæ°´çº¿   â”‚    â”‚ Kubernetes  â”‚
                   â”‚  æ„å»ºé•œåƒ    â”‚    â”‚    é›†ç¾¤     â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 ä»“åº“ç»“æ„è®¾è®¡


**ğŸ“ GitOpsä»“åº“ç»„ç»‡**ï¼š
```
gitops-repo/
â”œâ”€â”€ apps/                    # åº”ç”¨é…ç½®
â”‚   â”œâ”€â”€ webapp/
â”‚   â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â””â”€â”€ overlays/
â”‚   â””â”€â”€ database/
â”œâ”€â”€ infrastructure/          # åŸºç¡€è®¾æ–½é…ç½®
â”‚   â”œâ”€â”€ ingress-nginx/
â”‚   â”œâ”€â”€ cert-manager/
â”‚   â””â”€â”€ monitoring/
â”œâ”€â”€ clusters/               # é›†ç¾¤é…ç½®
â”‚   â”œâ”€â”€ dev/
â”‚   â”œâ”€â”€ staging/
â”‚   â””â”€â”€ production/
â””â”€â”€ scripts/               # è¾…åŠ©è„šæœ¬
    â”œâ”€â”€ deploy.sh
    â””â”€â”€ rollback.sh
```

### 3.4 ArgoCDé…ç½®ç¤ºä¾‹


**ğŸ”¸ Applicationå®šä¹‰**ï¼š
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: webapp-prod
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/company/gitops-repo
    targetRevision: main
    path: apps/webapp/overlays/production
  destination:
    server: https://kubernetes.default.svc
    namespace: webapp-prod
  syncPolicy:
    automated:              # è‡ªåŠ¨åŒæ­¥
      prune: true          # åˆ é™¤å¤šä½™èµ„æº
      selfHeal: true       # è‡ªæˆ‘ä¿®å¤
    syncOptions:
    - CreateNamespace=true  # è‡ªåŠ¨åˆ›å»ºå‘½åç©ºé—´
```

### 3.5 GitOpså·¥ä½œæµç¨‹


```
å®Œæ•´å·¥ä½œæµç¨‹ï¼š
å¼€å‘è€… â”€â”€[1]æäº¤ä»£ç â”€â”€â–¶ æºç ä»“åº“
                        â”‚
                        â–¼
                   [2]è§¦å‘CIæµæ°´çº¿
                        â”‚
                        â–¼
                   [3]æ„å»º&æ¨é€é•œåƒ
                        â”‚
                        â–¼
                   [4]æ›´æ–°é…ç½®ä»“åº“
                        â”‚
                        â–¼
ArgoCD â—€â”€â”€[5]æ£€æµ‹å˜æ›´â”€â”€â”€â”€â”€â”€ GitOpsä»“åº“
   â”‚
   â–¼
[6]åŒæ­¥åˆ°K8sé›†ç¾¤ â”€â”€â–¶ ç”Ÿäº§ç¯å¢ƒ
```

**âš™ï¸ è‡ªåŠ¨åŒ–æ›´æ–°è„šæœ¬**ï¼š
```bash
#!/bin/bash
# update-image.sh - æ›´æ–°é•œåƒæ ‡ç­¾çš„è„šæœ¬

NEW_IMAGE_TAG=$1
APP_PATH="apps/webapp/overlays/production"

# ä½¿ç”¨kustomizeæ›´æ–°é•œåƒæ ‡ç­¾
cd $APP_PATH
kustomize edit set image webapp:$NEW_IMAGE_TAG

# æäº¤å˜æ›´
git add .
git commit -m "Update webapp image to $NEW_IMAGE_TAG"
git push origin main

echo "é•œåƒæ›´æ–°å·²æäº¤ï¼ŒArgoCDå°†è‡ªåŠ¨åŒæ­¥"
```

---

## 4. ğŸ—ï¸ é•œåƒæ„å»ºä¸æ¨é€æµæ°´çº¿


### 4.1 CI/CDæµæ°´çº¿æ¦‚è¿°


> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šæƒ³è±¡æˆå·¥å‚çš„ç”Ÿäº§çº¿ï¼Œä»£ç è¿›å»ï¼Œæœ€ç»ˆäº§å“ï¼ˆéƒ¨ç½²å¥½çš„åº”ç”¨ï¼‰å‡ºæ¥ï¼Œä¸­é—´æ‰€æœ‰æ­¥éª¤éƒ½è‡ªåŠ¨åŒ–å®Œæˆã€‚

**ğŸ”¸ æµæ°´çº¿é˜¶æ®µ**ï¼š
```
ä»£ç æäº¤ â†’ æ„å»ºæµ‹è¯• â†’ é•œåƒæ„å»º â†’ å®‰å…¨æ‰«æ â†’ æ¨é€ä»“åº“ â†’ éƒ¨ç½²åº”ç”¨
    â†“         â†“         â†“         â†“         â†“         â†“
  Webhook   å•å…ƒæµ‹è¯•   Docker    æ¼æ´æ‰«æ   Registry   K8s
```

### 4.2 Dockerfileæœ€ä½³å®è·µ


**ğŸ¯ å¤šé˜¶æ®µæ„å»ºç¤ºä¾‹**ï¼š
```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:16-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

# è¿è¡Œé˜¶æ®µ
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

# å®‰å…¨é…ç½®
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nextjs -u 1001
USER 1001

EXPOSE 3000
CMD ["nginx", "-g", "daemon off;"]
```

**âœ… å®‰å…¨æœ€ä½³å®è·µ**ï¼š
- **érootç”¨æˆ·**ï¼šé¿å…ä½¿ç”¨rootè¿è¡Œåº”ç”¨
- **æœ€å°é•œåƒ**ï¼šä½¿ç”¨alpineæˆ–scratchåŸºç¡€é•œåƒ
- **åˆ†å±‚ä¼˜åŒ–**ï¼šåˆç†æ’åºæŒ‡ä»¤ï¼Œåˆ©ç”¨ç¼“å­˜
- **æ‰«ææ¼æ´**ï¼šé›†æˆå®‰å…¨æ‰«æå·¥å…·

### 4.3 GitHub Actionsæµæ°´çº¿


```yaml
# .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test
      
    - name: Run security audit
      run: npm audit --audit-level high

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push image
      uses: docker/build-push-action@v4
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ghcr.io/${{ github.repository }}:latest
          ghcr.io/${{ github.repository }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
```

### 4.4 é•œåƒç‰ˆæœ¬ç®¡ç†ç­–ç•¥


| ç­–ç•¥ | **æ ‡ç­¾æ ¼å¼** | **ä½¿ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|------|-------------|-------------|-----------|
| ğŸ·ï¸ **è¯­ä¹‰ç‰ˆæœ¬** | `v1.2.3` | æ­£å¼å‘å¸ƒç‰ˆæœ¬ | âœ…æ˜ç¡®ç‰ˆæœ¬ âŒéœ€è¦æ‰‹åŠ¨ç®¡ç† |
| ğŸ“… **æ—¶é—´æˆ³** | `2024-01-15-142030` | æŒç»­é›†æˆ | âœ…è‡ªåŠ¨ç”Ÿæˆ âŒä¸ç›´è§‚ |
| ğŸ”¢ **Git SHA** | `abc123f` | å¼€å‘æµ‹è¯• | âœ…å¯è¿½æº¯ âŒä¸å‹å¥½ |
| ğŸŒ¿ **åˆ†æ”¯å** | `feature-auth` | åŠŸèƒ½åˆ†æ”¯ | âœ…å¯¹åº”åŠŸèƒ½ âŒå¯èƒ½å†²çª |

---

## 5. ğŸ”„ æ»šåŠ¨å‘å¸ƒä¸è“ç»¿éƒ¨ç½²


### 5.1 æ»šåŠ¨å‘å¸ƒï¼ˆRolling Updateï¼‰


> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒé¤å…æ¢å¨å¸ˆï¼Œä¸æ˜¯ä¸€ä¸‹å­æŠŠæ‰€æœ‰å¨å¸ˆéƒ½æ¢äº†ï¼Œè€Œæ˜¯ä¸€ä¸ªä¸€ä¸ªæ¢ï¼Œä¿è¯é¤å…ä¸€ç›´èƒ½æ­£å¸¸è¥ä¸šã€‚

**ğŸ¯ å·¥ä½œåŸç†**ï¼š
```
æ»šåŠ¨æ›´æ–°è¿‡ç¨‹ï¼š
æ—§ç‰ˆæœ¬: [Pod1] [Pod2] [Pod3]  â†â”€â”€ 3ä¸ªæ—§ç‰ˆæœ¬Pod
         â†“
æ­¥éª¤1:  [Pod1] [Pod2] [æ–°Pod3] â†â”€â”€ æ›¿æ¢ä¸€ä¸ª
         â†“
æ­¥éª¤2:  [Pod1] [æ–°Pod2] [æ–°Pod3] â†â”€â”€ å†æ›¿æ¢ä¸€ä¸ª  
         â†“
æ­¥éª¤3:  [æ–°Pod1] [æ–°Pod2] [æ–°Pod3] â†â”€â”€ å…¨éƒ¨å®Œæˆ
```

**âš™ï¸ æ»šåŠ¨æ›´æ–°é…ç½®**ï¼š
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1      # æœ€å¤š1ä¸ªPodä¸å¯ç”¨
      maxSurge: 1           # æœ€å¤šå¤šå‡º1ä¸ªPod
  template:
    spec:
      containers:
      - name: webapp
        image: webapp:v2.0
        readinessProbe:      # å°±ç»ªæ¢é’ˆ
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
```

**ğŸ“Š æ»šåŠ¨æ›´æ–°ä¼˜ç¼ºç‚¹**ï¼š

| ä¼˜åŠ¿ âœ… | åŠ£åŠ¿ âŒ |
|---------|---------|
| é›¶åœæœºæ—¶é—´ | æ›´æ–°æ—¶é—´è¾ƒé•¿ |
| èµ„æºæ¶ˆè€—å°‘ | ç‰ˆæœ¬å…±å­˜æœŸé—´å¯èƒ½æœ‰é—®é¢˜ |
| å¯éšæ—¶å›æ»š | ä¸é€‚åˆæ•°æ®åº“ç»“æ„å˜æ›´ |

### 5.2 è“ç»¿éƒ¨ç½²


> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒæœ‰ä¸¤ä¸ªå®Œå…¨ä¸€æ ·çš„é¤å…ï¼ˆè“é¤å…å’Œç»¿é¤å…ï¼‰ï¼Œå®¢äººåœ¨è“é¤å…åƒé¥­æ—¶ï¼Œç»¿é¤å…å‡†å¤‡æ–°èœå•ï¼Œå‡†å¤‡å¥½åç¬é—´è®©å®¢äººè½¬åˆ°ç»¿é¤å…ã€‚

**ğŸ¯ éƒ¨ç½²æ¶æ„**ï¼š
```
è“ç»¿éƒ¨ç½²æ¶æ„ï¼š
    ç”¨æˆ·æµé‡
        â†“
   [è´Ÿè½½å‡è¡¡å™¨]
        â†“
    é€‰æ‹©ç¯å¢ƒ
   â•­â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â•®
   â–¼           â–¼
[è“ç¯å¢ƒ]    [ç»¿ç¯å¢ƒ]
è¿è¡Œv1.0    å‡†å¤‡v2.0
```

**ğŸ”§ è“ç»¿éƒ¨ç½²å®ç°**ï¼š
```yaml
# è“è‰²ç¯å¢ƒï¼ˆå½“å‰è¿è¡Œï¼‰
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp-blue
  labels:
    app: webapp
    version: blue
spec:
  replicas: 3
  selector:
    matchLabels:
      app: webapp
      version: blue
  template:
    metadata:
      labels:
        app: webapp
        version: blue
    spec:
      containers:
      - name: webapp
        image: webapp:v1.0

---
# ç»¿è‰²ç¯å¢ƒï¼ˆæ–°ç‰ˆæœ¬ï¼‰
apiVersion: apps/v1  
kind: Deployment
metadata:
  name: webapp-green
  labels:
    app: webapp
    version: green
spec:
  replicas: 3
  selector:
    matchLabels:
      app: webapp
      version: green
  template:
    metadata:
      labels:
        app: webapp
        version: green
    spec:
      containers:
      - name: webapp
        image: webapp:v2.0
```

**ğŸ›ï¸ æµé‡åˆ‡æ¢Service**ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
  name: webapp-service
spec:
  selector:
    app: webapp
    version: blue    # åˆ‡æ¢åˆ°greenå³å¯å®Œæˆéƒ¨ç½²
  ports:
  - port: 80
    targetPort: 8080
```

### 5.3 éƒ¨ç½²ç­–ç•¥å¯¹æ¯”


| ç­–ç•¥ | **åœæœºæ—¶é—´** | **èµ„æºéœ€æ±‚** | **é£é™©çº§åˆ«** | **é€‚ç”¨åœºæ™¯** |
|------|-------------|-------------|-------------|-------------|
| ğŸ”„ **æ»šåŠ¨æ›´æ–°** | æ—  | ä½ï¼ˆ+20%ï¼‰ | ä¸­ç­‰ | ä¸€èˆ¬Webåº”ç”¨ |
| ğŸ”µ **è“ç»¿éƒ¨ç½²** | æ—  | é«˜ï¼ˆ100%ï¼‰ | ä½ | å…³é”®ä¸šåŠ¡ç³»ç»Ÿ |
| ğŸ¦ **é‡‘ä¸é›€** | æ—  | ä¸­ç­‰ï¼ˆ+10%ï¼‰ | æœ€ä½ | å¤§å‹ç”¨æˆ·ç³»ç»Ÿ |

---

## 6. ğŸ¦ é‡‘ä¸é›€å‘å¸ƒç­–ç•¥å®ç°


### 6.1 é‡‘ä¸é›€å‘å¸ƒåŸç†


> ğŸ’¡ **å†å²å…¸æ•…**ï¼šçŸ¿å·¥ä¸‹äº•å‰å…ˆæ”¾é‡‘ä¸é›€æµ‹è¯•ç©ºæ°”è´¨é‡ï¼Œé‡‘ä¸é›€å®‰å…¨æ‰ä¸‹äº•ã€‚è½¯ä»¶å‘å¸ƒä¹Ÿæ˜¯å…ˆè®©å°‘é‡ç”¨æˆ·è¯•ç”¨æ–°ç‰ˆæœ¬ï¼Œå®‰å…¨åå†å…¨é¢æ¨å¹¿ã€‚

**ğŸ¯ å‘å¸ƒè¿‡ç¨‹**ï¼š
```
é‡‘ä¸é›€å‘å¸ƒé˜¶æ®µï¼š
é˜¶æ®µ1: 90%ç”¨æˆ· â†’ v1.0,  10%ç”¨æˆ· â†’ v2.0
         â†“ï¼ˆè§‚å¯ŸæŒ‡æ ‡ï¼Œæ²¡é—®é¢˜ç»§ç»­ï¼‰
é˜¶æ®µ2: 70%ç”¨æˆ· â†’ v1.0,  30%ç”¨æˆ· â†’ v2.0
         â†“ï¼ˆç»§ç»­è§‚å¯Ÿï¼‰
é˜¶æ®µ3: 50%ç”¨æˆ· â†’ v1.0,  50%ç”¨æˆ· â†’ v2.0
         â†“ï¼ˆæœ€åç¡®è®¤ï¼‰
å®Œæˆ:  100%ç”¨æˆ· â†’ v2.0
```

### 6.2 åŸºäºIstioçš„é‡‘ä¸é›€éƒ¨ç½²


**ğŸ”§ æµé‡åˆ†å‰²é…ç½®**ï¼š
```yaml
# VirtualService - æµé‡è·¯ç”±è§„åˆ™
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: webapp-canary
spec:
  http:
  - match:
    - headers:
        canary:
          exact: "true"     # ç‰¹æ®Šç”¨æˆ·ç›´æ¥è®¿é—®é‡‘ä¸é›€ç‰ˆæœ¬
    route:
    - destination:
        host: webapp
        subset: canary
      weight: 100
  - route:                  # æ™®é€šç”¨æˆ·æŒ‰æ¯”ä¾‹åˆ†é…
    - destination:
        host: webapp
        subset: stable
      weight: 90            # 90%æµé‡åˆ°ç¨³å®šç‰ˆ
    - destination:
        host: webapp  
        subset: canary
      weight: 10            # 10%æµé‡åˆ°é‡‘ä¸é›€ç‰ˆ

---
# DestinationRule - å®šä¹‰ç‰ˆæœ¬å­é›†
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: webapp
spec:
  host: webapp
  subsets:
  - name: stable
    labels:
      version: stable
  - name: canary
    labels:
      version: canary
```

### 6.3 åŸºäºNginx Ingressçš„å®ç°


**ğŸ›ï¸ åŸºäºæƒé‡çš„åˆ†æµ**ï¼š
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: webapp-canary
  annotations:
    # é‡‘ä¸é›€å‘å¸ƒé…ç½®
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "10"    # 10%æµé‡
    # æˆ–è€…åŸºäºè¯·æ±‚å¤´
    # nginx.ingress.kubernetes.io/canary-by-header: "canary"
    # nginx.ingress.kubernetes.io/canary-by-cookie: "canary"
spec:
  rules:
  - host: webapp.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: webapp-canary    # é‡‘ä¸é›€ç‰ˆæœ¬æœåŠ¡
            port:
              number: 80
```

### 6.4 è‡ªåŠ¨åŒ–é‡‘ä¸é›€éƒ¨ç½²


**ğŸ“Š ç›‘æ§æŒ‡æ ‡è¯„ä¼°**ï¼š
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: webapp-rollout
spec:
  replicas: 10
  strategy:
    canary:
      steps:
      - setWeight: 10        # ç¬¬ä¸€æ­¥ï¼š10%æµé‡
      - pause: {duration: 2m} # æš‚åœ2åˆ†é’Ÿè§‚å¯Ÿ
      - setWeight: 30        # ç¬¬äºŒæ­¥ï¼š30%æµé‡  
      - pause: {duration: 5m} # æš‚åœ5åˆ†é’Ÿè§‚å¯Ÿ
      - setWeight: 60        # ç¬¬ä¸‰æ­¥ï¼š60%æµé‡
      - pause: {duration: 10m} # æš‚åœ10åˆ†é’Ÿè§‚å¯Ÿ
      - setWeight: 100       # å®Œå…¨åˆ‡æ¢
      # åˆ†æé…ç½®
      analysis:
        templates:
        - templateName: success-rate
        args:
        - name: service-name
          value: webapp
      # è‡ªåŠ¨å›æ»šæ¡ä»¶  
      abortScaleDownDelaySeconds: 30
      scaleDownDelaySeconds: 60
  template:
    spec:
      containers:
      - name: webapp
        image: webapp:latest
```

**âš ï¸ è‡ªåŠ¨å›æ»šç­–ç•¥**ï¼š
```yaml
# åˆ†ææ¨¡æ¿
apiVersion: argoproj.io/v1alpha1  
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    successCondition: result[0] >= 0.95  # æˆåŠŸç‡ä¸ä½äº95%
    provider:
      prometheus:
        address: http://prometheus:9090
        query: |
          sum(rate(http_requests_total{job="{{args.service-name}}",code!~"5.."}[5m])) /
          sum(rate(http_requests_total{job="{{args.service-name}}"}[5m]))
```

---

## 7. ğŸ¥ åº”ç”¨å¥åº·æ£€æŸ¥é…ç½®


### 7.1 å¥åº·æ£€æŸ¥ç±»å‹è¯´æ˜


> ğŸ’¡ **åŒ»å­¦ç±»æ¯”**ï¼šå°±åƒäººè¦å®šæœŸä½“æ£€ï¼Œåº”ç”¨ä¹Ÿéœ€è¦å®šæœŸæ£€æŸ¥ã€‚ä¸åŒçš„æ£€æŸ¥æœ‰ä¸åŒç”¨é€”ï¼šå¯åŠ¨æ£€æŸ¥ã€å°±ç»ªæ£€æŸ¥ã€å­˜æ´»æ£€æŸ¥ã€‚

**ğŸ”¸ ä¸‰ç§æ¢é’ˆå¯¹æ¯”**ï¼š

| æ¢é’ˆç±»å‹ | **æ£€æŸ¥æ—¶æœº** | **å¤±è´¥åæœ** | **ä½¿ç”¨åœºæ™¯** |
|----------|-------------|-------------|-------------|
| ğŸš€ **Startup** | åº”ç”¨å¯åŠ¨æ—¶ | é‡å¯å®¹å™¨ | æ…¢å¯åŠ¨åº”ç”¨ |
| âœ… **Readiness** | è¿è¡ŒæœŸé—´ | åœæ­¢æ¥æ”¶æµé‡ | æœåŠ¡å°±ç»ªæ£€æŸ¥ |
| â¤ï¸ **Liveness** | è¿è¡ŒæœŸé—´ | é‡å¯å®¹å™¨ | åº”ç”¨æ­»é”æ£€æµ‹ |

### 7.2 æ¢é’ˆé…ç½®è¯¦è§£


**ğŸ”§ HTTPå¥åº·æ£€æŸ¥**ï¼š
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  template:
    spec:
      containers:
      - name: webapp
        image: webapp:latest
        ports:
        - containerPort: 8080
        
        # å¯åŠ¨æ¢é’ˆ - åº”ç”¨å¯åŠ¨é˜¶æ®µ
        startupProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          failureThreshold: 30    # å¤±è´¥30æ¬¡æ‰è®¤ä¸ºå¤±è´¥
          periodSeconds: 10       # æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
          timeoutSeconds: 5       # è¶…æ—¶æ—¶é—´5ç§’
          
        # å°±ç»ªæ¢é’ˆ - æ˜¯å¦å‡†å¤‡æ¥æ”¶æµé‡  
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
            httpHeaders:
            - name: Custom-Header
              value: health-check
          initialDelaySeconds: 15  # å¯åŠ¨15ç§’åå¼€å§‹æ£€æŸ¥
          periodSeconds: 5        # æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
          timeoutSeconds: 3       # è¶…æ—¶3ç§’
          successThreshold: 1     # æˆåŠŸ1æ¬¡å°±è®¤ä¸ºå°±ç»ª
          failureThreshold: 3     # å¤±è´¥3æ¬¡è®¤ä¸ºæœªå°±ç»ª
          
        # å­˜æ´»æ¢é’ˆ - åº”ç”¨æ˜¯å¦è¿˜æ´»ç€
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness  
            port: 8080
          initialDelaySeconds: 30  # å¯åŠ¨30ç§’åå¼€å§‹æ£€æŸ¥
          periodSeconds: 15       # æ¯15ç§’æ£€æŸ¥ä¸€æ¬¡
          timeoutSeconds: 5       # è¶…æ—¶5ç§’
          failureThreshold: 3     # å¤±è´¥3æ¬¡é‡å¯å®¹å™¨
```

### 7.3 å…¶ä»–æ¢é’ˆç±»å‹


**ğŸ”§ TCPç«¯å£æ£€æŸ¥**ï¼š
```yaml
readinessProbe:
  tcpSocket:
    port: 3306        # æ•°æ®åº“ç«¯å£æ£€æŸ¥
  initialDelaySeconds: 5
  periodSeconds: 10
```

**ğŸ”§ å‘½ä»¤æ‰§è¡Œæ£€æŸ¥**ï¼š  
```yaml
livenessProbe:
  exec:
    command:
    - /bin/sh
    - -c
    - "pgrep java"    # æ£€æŸ¥Javaè¿›ç¨‹æ˜¯å¦å­˜åœ¨
  periodSeconds: 30
  failureThreshold: 3
```

### 7.4 å¥åº·æ£€æŸ¥æœ€ä½³å®è·µ


**âœ… é…ç½®å»ºè®®**ï¼š
```bash
# æ¢é’ˆç«¯ç‚¹è®¾è®¡åŸåˆ™ï¼š
/health          # åŸºç¡€å¥åº·æ£€æŸ¥
/health/ready    # å°±ç»ªçŠ¶æ€æ£€æŸ¥ï¼ˆåŒ…å«ä¾èµ–æœåŠ¡ï¼‰
/health/live     # å­˜æ´»çŠ¶æ€æ£€æŸ¥ï¼ˆä»…æ£€æŸ¥åº”ç”¨æœ¬èº«ï¼‰

# æ—¶é—´å‚æ•°å»ºè®®ï¼š
å¯åŠ¨æ¢é’ˆï¼šå®½æ¾é…ç½®ï¼ˆå¤±è´¥æ¬¡æ•°å¤šï¼Œé—´éš”é•¿ï¼‰
å°±ç»ªæ¢é’ˆï¼šæ•æ„Ÿé…ç½®ï¼ˆå¿«é€Ÿå‘ç°é—®é¢˜ï¼‰
å­˜æ´»æ¢é’ˆï¼šä¿å®ˆé…ç½®ï¼ˆé¿å…è¯¯æ€ï¼‰
```

**âš ï¸ å¸¸è§é”™è¯¯**ï¼š
- **è¿‡äºæ•æ„Ÿ**ï¼šæ¢é’ˆå¤±è´¥é˜ˆå€¼å¤ªä½ï¼Œé€ æˆé¢‘ç¹é‡å¯
- **æ£€æŸ¥è¿‡é‡**ï¼šå¥åº·æ£€æŸ¥æœ¬èº«æ¶ˆè€—å¤ªå¤šèµ„æº
- **ä¾èµ–æ£€æŸ¥**ï¼šå­˜æ´»æ¢é’ˆæ£€æŸ¥å¤–éƒ¨ä¾èµ–ï¼ˆåº”è¯¥åªæ£€æŸ¥åº”ç”¨è‡ªèº«ï¼‰
- **è¶…æ—¶è¿‡çŸ­**ï¼šç½‘ç»œå»¶è¿Ÿå¯¼è‡´è¯¯åˆ¤

---

## 8. â†©ï¸ å‘å¸ƒå›æ»šä¸ç‰ˆæœ¬ç®¡ç†


### 8.1 ç‰ˆæœ¬ç®¡ç†ç­–ç•¥


> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šå°±åƒæ‰‹æœºç³»ç»Ÿæ›´æ–°ï¼Œå¦‚æœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå¯ä»¥å›åˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬ã€‚ç‰ˆæœ¬ç®¡ç†å°±æ˜¯è®°å½•æ¯ä¸ª"å¿«ç…§"ï¼Œæ–¹ä¾¿éšæ—¶å›é€€ã€‚

**ğŸ·ï¸ ç‰ˆæœ¬æ ‡ç­¾è§„èŒƒ**ï¼š
```
è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼šv1.2.3
â”œâ”€â”€ 1: ä¸»ç‰ˆæœ¬å·ï¼ˆé‡å¤§å˜æ›´ï¼‰
â”œâ”€â”€ 2: æ¬¡ç‰ˆæœ¬å·ï¼ˆæ–°åŠŸèƒ½ï¼‰  
â””â”€â”€ 3: ä¿®è®¢å·ï¼ˆBugä¿®å¤ï¼‰

Gitæ ‡ç­¾ç¤ºä¾‹ï¼š
v1.0.0      # é¦–æ¬¡å‘å¸ƒ
v1.0.1      # Bugä¿®å¤
v1.1.0      # æ–°åŠŸèƒ½
v2.0.0      # é‡å¤§æ›´æ–°
```

### 8.2 KubernetesåŸç”Ÿå›æ»š


**ğŸ“œ æŸ¥çœ‹å‘å¸ƒå†å²**ï¼š
```bash
# æŸ¥çœ‹Deploymentçš„å‘å¸ƒå†å²
kubectl rollout history deployment/webapp

# æŸ¥çœ‹ç‰¹å®šç‰ˆæœ¬è¯¦æƒ…
kubectl rollout history deployment/webapp --revision=2

# å®æ—¶æŸ¥çœ‹å‘å¸ƒçŠ¶æ€
kubectl rollout status deployment/webapp
```

**â†©ï¸ æ‰§è¡Œå›æ»šæ“ä½œ**ï¼š
```bash
# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
kubectl rollout undo deployment/webapp

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
kubectl rollout undo deployment/webapp --to-revision=2

# æš‚åœå½“å‰å‘å¸ƒ
kubectl rollout pause deployment/webapp

# æ¢å¤æš‚åœçš„å‘å¸ƒ
kubectl rollout resume deployment/webapp
```

### 8.3 Helmç‰ˆæœ¬ç®¡ç†


**ğŸ“Š Helm Releaseç®¡ç†**ï¼š
```bash
# æŸ¥çœ‹Releaseå†å²
helm history webapp

# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
helm rollback webapp

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
helm rollback webapp 2

# æŸ¥çœ‹ReleaseçŠ¶æ€
helm status webapp
```

**ğŸ”§ Helmå›æ»šé…ç½®**ï¼š
```yaml
# values.yamlä¸­çš„å›æ»šé…ç½®
replicaCount: 3
image:
  repository: webapp
  tag: "v1.2.3"
  
# å›æ»šç­–ç•¥é…ç½®  
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 25%
    maxSurge: 25%

# ä¿ç•™å†å²ç‰ˆæœ¬æ•°
revisionHistoryLimit: 10
```

### 8.4 è‡ªåŠ¨åŒ–å›æ»šæœºåˆ¶


**ğŸ¤– åŸºäºæŒ‡æ ‡çš„è‡ªåŠ¨å›æ»š**ï¼š
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: webapp
spec:
  replicas: 5
  strategy:
    canary:
      analysis:
        templates:
        - templateName: error-rate-analysis
        startingStep: 1
        args:
        - name: service-name
          value: webapp
      steps:
      - setWeight: 20
      - pause: {duration: 5m}
      - setWeight: 50  
      - pause: {duration: 10m}
      
  # è‡ªåŠ¨å›æ»šé…ç½®
  abortScaleDownDelaySeconds: 30
  progressDeadlineSeconds: 600
```

**ğŸ“Š ç›‘æ§æŒ‡æ ‡åˆ†æ**ï¼š
```yaml
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate  
metadata:
  name: error-rate-analysis
spec:
  metrics:
  - name: error-rate
    successCondition: result[0] < 0.05  # é”™è¯¯ç‡ä½äº5%
    failureLimit: 3                     # å¤±è´¥3æ¬¡è‡ªåŠ¨å›æ»š
    provider:
      prometheus:
        address: http://prometheus:9090
        query: |
          sum(rate(http_requests_total{job="webapp",code=~"5.."}[5m])) /
          sum(rate(http_requests_total{job="webapp"}[5m]))
```

### 8.5 å›æ»šé¢„æ¡ˆåˆ¶åº¦


**ğŸ“‹ å›æ»šæ“ä½œæ‰‹å†Œ**ï¼š
```bash
#!/bin/bash
# rollback-playbook.sh - åº”æ€¥å›æ»šè„šæœ¬

APP_NAME=$1
ENVIRONMENT=$2  
ROLLBACK_VERSION=${3:-"previous"}

echo "=== åº”æ€¥å›æ»šå¼€å§‹ ==="
echo "åº”ç”¨: $APP_NAME"
echo "ç¯å¢ƒ: $ENVIRONMENT"
echo "ç›®æ ‡ç‰ˆæœ¬: $ROLLBACK_VERSION"

# ç¬¬ä¸€æ­¥ï¼šæš‚åœå½“å‰å‘å¸ƒ
echo "1. æš‚åœå½“å‰å‘å¸ƒ..."
kubectl rollout pause deployment/$APP_NAME -n $ENVIRONMENT

# ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œå›æ»š
echo "2. æ‰§è¡Œå›æ»š..."
if [ "$ROLLBACK_VERSION" = "previous" ]; then
    kubectl rollout undo deployment/$APP_NAME -n $ENVIRONMENT
else
    kubectl rollout undo deployment/$APP_NAME --to-revision=$ROLLBACK_VERSION -n $ENVIRONMENT
fi

# ç¬¬ä¸‰æ­¥ï¼šç­‰å¾…å›æ»šå®Œæˆ
echo "3. ç­‰å¾…å›æ»šå®Œæˆ..."
kubectl rollout status deployment/$APP_NAME -n $ENVIRONMENT --timeout=300s

# ç¬¬å››æ­¥ï¼šéªŒè¯æœåŠ¡çŠ¶æ€
echo "4. éªŒè¯æœåŠ¡çŠ¶æ€..."
kubectl get pods -l app=$APP_NAME -n $ENVIRONMENT

echo "=== å›æ»šå®Œæˆ ==="
```

---

## 9. ğŸŒ å¤šç¯å¢ƒéƒ¨ç½²ç®¡é“è®¾è®¡


### 9.1 ç¯å¢ƒåˆ†å±‚æ¶æ„


> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šå°±åƒäº§å“ä»å®éªŒå®¤â†’å°æ‰¹é‡ç”Ÿäº§â†’å¤§è§„æ¨¡ç”Ÿäº§çš„è¿‡ç¨‹ï¼Œè½¯ä»¶ä¹Ÿè¦ç»è¿‡å¼€å‘â†’æµ‹è¯•â†’ç”Ÿäº§ç¯å¢ƒçš„éªŒè¯è¿‡ç¨‹ã€‚

**ğŸ—ï¸ ç¯å¢ƒæ¶æ„è®¾è®¡**ï¼š
```
éƒ¨ç½²æµæ°´çº¿æ¶æ„ï¼š
å¼€å‘ä»£ç  â”€â”€â–¶ [å¼€å‘ç¯å¢ƒ] â”€â”€â–¶ [æµ‹è¯•ç¯å¢ƒ] â”€â”€â–¶ [é¢„å‘å¸ƒç¯å¢ƒ] â”€â”€â–¶ [ç”Ÿäº§ç¯å¢ƒ]
             Dev          Test         Staging        Production
             â†“             â†“             â†“              â†“
           å¿«é€Ÿè¿­ä»£      åŠŸèƒ½æµ‹è¯•      ç”Ÿäº§éªŒè¯      æ­£å¼æœåŠ¡
           ä¸ç¨³å®š        ä¸­ç­‰ç¨³å®š      é«˜ç¨³å®š        æœ€é«˜ç¨³å®š
```

### 9.2 ç¯å¢ƒé…ç½®å·®å¼‚ç®¡ç†


**ğŸ“ Kustomizeç¯å¢ƒé…ç½®**ï¼š
```
multi-env-config/
â”œâ”€â”€ base/                    # åŸºç¡€é…ç½®
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â””â”€â”€ kustomization.yaml
â””â”€â”€ overlays/               # ç¯å¢ƒå·®å¼‚é…ç½®
    â”œâ”€â”€ dev/                # å¼€å‘ç¯å¢ƒ
    â”‚   â”œâ”€â”€ kustomization.yaml
    â”‚   â”œâ”€â”€ patch-resources.yaml  # èµ„æºé…ç½®è¾ƒå°
    â”‚   â””â”€â”€ configmap.yaml        # å¼€å‘é…ç½®
    â”œâ”€â”€ test/               # æµ‹è¯•ç¯å¢ƒ
    â”‚   â”œâ”€â”€ kustomization.yaml  
    â”‚   â”œâ”€â”€ patch-replicas.yaml   # å¤šå‰¯æœ¬æµ‹è¯•
    â”‚   â””â”€â”€ configmap.yaml
    â”œâ”€â”€ staging/            # é¢„å‘å¸ƒç¯å¢ƒ
    â”‚   â”œâ”€â”€ kustomization.yaml
    â”‚   â”œâ”€â”€ patch-resources.yaml  # ç”Ÿäº§çº§èµ„æº
    â”‚   â”œâ”€â”€ configmap.yaml
    â”‚   â””â”€â”€ hpa.yaml             # è‡ªåŠ¨æ‰©ç¼©å®¹
    â””â”€â”€ prod/               # ç”Ÿäº§ç¯å¢ƒ  
        â”œâ”€â”€ kustomization.yaml
        â”œâ”€â”€ patch-resources.yaml
        â”œâ”€â”€ configmap.yaml
        â”œâ”€â”€ hpa.yaml
        â””â”€â”€ pdb.yaml             # Podä¸­æ–­é¢„ç®—
```

### 9.3 ç¯å¢ƒå·®å¼‚é…ç½®ç¤ºä¾‹


**ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½®**ï¼š
```yaml
# overlays/dev/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

bases:
  - ../../base

namePrefix: dev-
namespace: webapp-dev

commonLabels:
  env: development

images:
  - name: webapp
    newTag: latest  # å¼€å‘ç¯å¢ƒç”¨æœ€æ–°é•œåƒ

patchesStrategicMerge:
  - patch-resources.yaml

resources:
  - configmap.yaml

# å¼€å‘ç¯å¢ƒèµ„æºé…ç½®
---
# patch-resources.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 1        # å¼€å‘ç¯å¢ƒå•å‰¯æœ¬
  template:
    spec:
      containers:
      - name: webapp
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
```

**ğŸ­ ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š
```yaml
# overlays/prod/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

bases:
  - ../../base

namePrefix: prod-
namespace: webapp-prod

commonLabels:
  env: production

images:
  - name: webapp
    newTag: v1.2.3    # ç”Ÿäº§ç¯å¢ƒç”¨ç¨³å®šç‰ˆæœ¬

patchesStrategicMerge:
  - patch-resources.yaml

resources:
  - configmap.yaml
  - hpa.yaml         # æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹
  - pdb.yaml         # Podä¸­æ–­é¢„ç®—

# ç”Ÿäº§ç¯å¢ƒèµ„æºé…ç½®
---
# patch-resources.yaml  
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 5        # ç”Ÿäº§ç¯å¢ƒå¤šå‰¯æœ¬
  template:
    spec:
      containers:
      - name: webapp
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 1000m
            memory: 2Gi
```

### 9.4 éƒ¨ç½²æµæ°´çº¿è®¾è®¡


**ğŸ”„ GitLab CI/CD Pipeline**ï¼š
```yaml
# .gitlab-ci.yml
stages:
  - build
  - deploy-dev
  - test  
  - deploy-staging
  - deploy-prod

variables:
  DOCKER_DRIVER: overlay2
  KUBECONFIG: /etc/deploy/config

build:
  stage: build
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  only:
    - main
    - develop

deploy-dev:
  stage: deploy-dev
  script:
    - kubectl apply -k overlays/dev/
    - kubectl set image deployment/dev-webapp webapp=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA -n webapp-dev
  environment:
    name: development
    url: https://dev.webapp.company.com
  only:
    - develop

deploy-staging:
  stage: deploy-staging  
  script:
    - kubectl apply -k overlays/staging/
    - kubectl set image deployment/staging-webapp webapp=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA -n webapp-staging
    - kubectl rollout status deployment/staging-webapp -n webapp-staging
  environment:
    name: staging
    url: https://staging.webapp.company.com
  only:
    - main

deploy-prod:
  stage: deploy-prod
  script:
    - kubectl apply -k overlays/prod/ 
    - kubectl set image deployment/prod-webapp webapp=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA -n webapp-prod
    - kubectl rollout status deployment/prod-webapp -n webapp-prod
  environment:
    name: production
    url: https://webapp.company.com
  when: manual        # ç”Ÿäº§ç¯å¢ƒéœ€è¦æ‰‹åŠ¨ç¡®è®¤
  only:
    - main
```

### 9.5 ç¯å¢ƒç®¡ç†æœ€ä½³å®è·µ


**âœ… é…ç½®ç®¡ç†åŸåˆ™**ï¼š

| åŸåˆ™ | **è¯´æ˜** | **å®ç°æ–¹å¼** |
|------|---------|-------------|
| ğŸ”’ **é…ç½®å¤–éƒ¨åŒ–** | æ•æ„Ÿä¿¡æ¯ä¸å†™åœ¨é•œåƒé‡Œ | ConfigMap + Secret |
| ğŸ·ï¸ **ç¯å¢ƒæ ‡è¯†** | æ˜ç¡®æ ‡è¯†æ¯ä¸ªç¯å¢ƒ | Namespace + Label |
| ğŸ“Š **èµ„æºéš”ç¦»** | ä¸åŒç¯å¢ƒèµ„æºç‹¬ç«‹ | ResourceQuota + LimitRange |
| ğŸ”„ **è‡ªåŠ¨åŒ–éƒ¨ç½²** | å‡å°‘äººå·¥æ“ä½œé”™è¯¯ | CI/CD Pipeline |
| ğŸ“‹ **ç¯å¢ƒä¸€è‡´æ€§** | ç¯å¢ƒå·®å¼‚æœ€å°åŒ– | Infrastructure as Code |

**ğŸ›¡ï¸ ç¯å¢ƒå®‰å…¨ç­–ç•¥**ï¼š
```yaml
# ç”Ÿäº§ç¯å¢ƒç½‘ç»œç­–ç•¥
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy  
metadata:
  name: webapp-prod-policy
  namespace: webapp-prod
spec:
  podSelector:
    matchLabels:
      app: webapp
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: database
    ports:
    - protocol: TCP
      port: 5432
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ¯ å·¥å…·é“¾ç†è§£**ï¼š
- **Helm**ï¼šK8sçš„"åº”ç”¨å•†åº—"ï¼Œæ‰“åŒ…å’Œç®¡ç†å¤æ‚åº”ç”¨
- **Kustomize**ï¼šé…ç½®ç®¡ç†å·¥å…·ï¼Œé€šè¿‡"è¡¥ä¸"æ–¹å¼å®šåˆ¶ç¯å¢ƒ
- **GitOps**ï¼šä»¥Gitä¸ºå•ä¸€çœŸç†æºçš„éƒ¨ç½²å“²å­¦
- **CI/CD**ï¼šä»ä»£ç åˆ°éƒ¨ç½²çš„è‡ªåŠ¨åŒ–æµæ°´çº¿

**ğŸ”¸ éƒ¨ç½²ç­–ç•¥é€‰æ‹©**ï¼š
- **æ»šåŠ¨å‘å¸ƒ**ï¼šé›¶åœæœºï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯
- **è“ç»¿éƒ¨ç½²**ï¼šå¿«é€Ÿåˆ‡æ¢ï¼Œèµ„æºæ¶ˆè€—å¤§
- **é‡‘ä¸é›€å‘å¸ƒ**ï¼šé£é™©æœ€å°ï¼Œé€‚åˆå¤§ç”¨æˆ·é‡ç³»ç»Ÿ

**ğŸ¥ å¥åº·æ£€æŸ¥ä¸‰å‰‘å®¢**ï¼š
- **å¯åŠ¨æ¢é’ˆ**ï¼šæ…¢å¯åŠ¨åº”ç”¨çš„å®ˆæŠ¤ç¥
- **å°±ç»ªæ¢é’ˆ**ï¼šæµé‡åˆ†å‘çš„æ§åˆ¶å¼€å…³  
- **å­˜æ´»æ¢é’ˆ**ï¼šåº”ç”¨æ­»é”çš„æ£€æµ‹å™¨

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›å·¥å…·ï¼Ÿ**
```
é—®é¢˜ï¼šæ‰‹å·¥ç®¡ç†K8sèµ„æºå¤æ‚æ˜“é”™
è§£å†³ï¼šHelm + Kustomize æ ‡å‡†åŒ–æ‰“åŒ…å’Œé…ç½®

é—®é¢˜ï¼šéƒ¨ç½²è¿‡ç¨‹ä¸å¯è¿½è¸ªå’Œå›æ»š
è§£å†³ï¼šGitOps ç‰ˆæœ¬åŒ–ç®¡ç†æ‰€æœ‰å˜æ›´

é—®é¢˜ï¼šå‘å¸ƒæ–°ç‰ˆæœ¬é£é™©é«˜
è§£å†³ï¼šæ¸è¿›å¼å‘å¸ƒç­–ç•¥é™ä½é£é™©

é—®é¢˜ï¼šæœåŠ¡ä¸ç¨³å®šå½±å“ç”¨æˆ·ä½“éªŒ
è§£å†³ï¼šå¥åº·æ£€æŸ¥ä¿éšœæœåŠ¡è´¨é‡
```

**ğŸ”¹ å·¥å…·é€‰æ‹©åŸåˆ™**ï¼š
```
ç®€å•åº”ç”¨ï¼šKustomize + kubectl
å¤æ‚åº”ç”¨ï¼šHelm + ArgoCD
å¤§è§„æ¨¡ç³»ç»Ÿï¼šHelm + Istio + ArgoCD
ä¼ä¸šçº§ï¼šå…¨å¥—å·¥å…·é“¾ + è‡ªåŠ¨åŒ–æµæ°´çº¿
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- **åˆåˆ›å…¬å¸**ï¼šHelm + æ»šåŠ¨å‘å¸ƒï¼Œå¿«é€Ÿè¿­ä»£
- **ä¸­å‹ä¼ä¸š**ï¼šGitOps + é‡‘ä¸é›€å‘å¸ƒï¼Œç¨³å®šå¯é   
- **å¤§å‹ä¼ä¸š**ï¼šå…¨å¥—å·¥å…·é“¾ï¼Œå¤šç¯å¢ƒç®¡æ§
- **é‡‘èè¡Œä¸š**ï¼šè“ç»¿éƒ¨ç½²ï¼Œé£é™©æ§åˆ¶

**ğŸ› ï¸ è¿ç»´å®è·µæŒ‡å¯¼**ï¼š
- **ç¯å¢ƒç®¡ç†**ï¼šç»Ÿä¸€å·¥å…·ï¼Œå·®å¼‚é…ç½®
- **å‘å¸ƒç­–ç•¥**ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚ç­–ç•¥
- **ç›‘æ§å‘Šè­¦**ï¼šå®Œå–„çš„å¥åº·æ£€æŸ¥å’ŒæŒ‡æ ‡ç›‘æ§
- **åº”æ€¥é¢„æ¡ˆ**ï¼šå¿«é€Ÿå›æ»šæœºåˆ¶å’Œæ“ä½œæ‰‹å†Œ

**ğŸ”¥ æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- **Helmç®¡åŒ…ï¼ŒKustomizeé…ç½®ï¼ŒGitOpsç‰ˆæœ¬åŒ–**
- **æ»šåŠ¨æ›´æ–°ä¿ç¨³å®šï¼Œè“ç»¿éƒ¨ç½²å¿«åˆ‡æ¢ï¼Œé‡‘ä¸é›€å‘å¸ƒæœ€å®‰å…¨**  
- **ä¸‰ç§æ¢é’ˆä¿å¥åº·ï¼Œå¯åŠ¨å°±ç»ªåŠ å­˜æ´»**
- **å¤šç¯å¢ƒç®¡é“ä¿ƒåä½œï¼ŒCI/CDè‡ªåŠ¨åŒ–**

> ğŸ“ **å­¦ä¹ å»ºè®®**ï¼šå…ˆç†è§£æ¦‚å¿µå’ŒåŸç†ï¼Œå†åŠ¨æ‰‹å®è·µï¼Œæœ€åç»“åˆå®é™…ä¸šåŠ¡åœºæ™¯æ·±å…¥ä¼˜åŒ–ã€‚æ¯ç§å·¥å…·éƒ½æœ‰å…¶é€‚ç”¨åœºæ™¯ï¼Œå…³é”®æ˜¯æ ¹æ®å›¢é˜Ÿè§„æ¨¡å’Œä¸šåŠ¡éœ€æ±‚åšå‡ºåˆé€‚çš„æŠ€æœ¯é€‰å‹ã€‚