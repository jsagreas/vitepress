---
title: 8ã€æŒä¹…åŒ–å­˜å‚¨ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [æŒä¹…åŒ–å­˜å‚¨æ ¸å¿ƒæ¦‚å¿µ](#1-æŒä¹…åŒ–å­˜å‚¨æ ¸å¿ƒæ¦‚å¿µ)
2. [PersistentVolumeå­˜å‚¨å·è¯¦è§£](#2-PersistentVolumeå­˜å‚¨å·è¯¦è§£)
3. [PersistentVolumeClaimå­˜å‚¨å£°æ˜](#3-PersistentVolumeClaimå­˜å‚¨å£°æ˜)
4. [StorageClassåŠ¨æ€ä¾›åº”](#4-StorageClassåŠ¨æ€ä¾›åº”)
5. [å­˜å‚¨è®¿é—®æ¨¡å¼æ·±å…¥ç†è§£](#5-å­˜å‚¨è®¿é—®æ¨¡å¼æ·±å…¥ç†è§£)
6. [å­˜å‚¨å›æ”¶ç­–ç•¥ç®¡ç†](#6-å­˜å‚¨å›æ”¶ç­–ç•¥ç®¡ç†)
7. [CSIå­˜å‚¨é©±åŠ¨å®æˆ˜](#7-CSIå­˜å‚¨é©±åŠ¨å®æˆ˜)
8. [å­˜å‚¨ç±»å‹é€‰æ‹©æŒ‡å—](#8-å­˜å‚¨ç±»å‹é€‰æ‹©æŒ‡å—)
9. [å­˜å‚¨æ‰©å®¹ä¸å¿«ç…§ç®¡ç†](#9-å­˜å‚¨æ‰©å®¹ä¸å¿«ç…§ç®¡ç†)
10. [æ•°æ®å¤‡ä»½ä¸æ¢å¤ç­–ç•¥](#10-æ•°æ®å¤‡ä»½ä¸æ¢å¤ç­–ç•¥)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ƒï¸ æŒä¹…åŒ–å­˜å‚¨æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦æŒä¹…åŒ–å­˜å‚¨


ğŸ’¡ **é—®é¢˜èƒŒæ™¯**
> å®¹å™¨æœ¬è´¨ä¸Šæ˜¯ä¸´æ—¶çš„ï¼Œå½“Podé‡å¯æˆ–åˆ é™¤æ—¶ï¼Œå®¹å™¨å†…çš„æ•°æ®ä¼šä¸¢å¤±ã€‚ä½†å¾ˆå¤šåº”ç”¨éœ€è¦æ•°æ®æŒä¹…ä¿å­˜ã€‚

ğŸ  **ç”Ÿæ´»ç±»æ¯”**
```
å°±åƒç§Ÿæˆ¿å­ï¼š
- å®¹å™¨ = ä¸´æ—¶ä½æ‰€ï¼Œæ¬å®¶æ—¶ä¸œè¥¿ä¼šä¸¢
- æŒä¹…åŒ–å­˜å‚¨ = é“¶è¡Œä¿é™©ç®±ï¼Œæ— è®ºæ¬åˆ°å“ªéƒ½èƒ½è®¿é—®
```

**æ ¸å¿ƒéœ€æ±‚åœºæ™¯**ï¼š
- **æ•°æ®åº“åº”ç”¨**ï¼šMySQLã€PostgreSQLéœ€è¦æ•°æ®æŒä¹…åŒ–
- **æ–‡ä»¶å­˜å‚¨**ï¼šWebåº”ç”¨çš„ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
- **æ—¥å¿—æ”¶é›†**ï¼šåº”ç”¨æ—¥å¿—éœ€è¦é•¿æœŸä¿å­˜
- **é…ç½®ç®¡ç†**ï¼šåº”ç”¨é…ç½®æ–‡ä»¶çš„æŒä¹…åŒ–

### 1.2 Kuberneteså­˜å‚¨ä½“ç³»æ¶æ„


```
å­˜å‚¨æ¶æ„å…¨æ™¯å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Pod        â”‚    â”‚   PVC (ç”³è¯·)      â”‚    â”‚   PV (èµ„æº)     â”‚
â”‚                 â”‚    â”‚                  â”‚    â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â—„â”€â”€â–ºâ”‚  å­˜å‚¨éœ€æ±‚å£°æ˜     â”‚â—„â”€â”€â–ºâ”‚  å…·ä½“å­˜å‚¨èµ„æº   â”‚
â”‚  â”‚ Container â”‚  â”‚    â”‚  â€¢ å¤§å°è¦æ±‚      â”‚    â”‚  â€¢ NFS/iSCSI    â”‚
â”‚  â”‚           â”‚  â”‚    â”‚  â€¢ è®¿é—®æ¨¡å¼      â”‚    â”‚  â€¢ äº‘å­˜å‚¨       â”‚
â”‚  â”‚  Volume   â”‚  â”‚    â”‚  â€¢ æ€§èƒ½è¦æ±‚      â”‚    â”‚  â€¢ æœ¬åœ°ç£ç›˜     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚                  â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–²                        â–²                        â–²
          â”‚                        â”‚                        â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚  åº”ç”¨ä½¿ç”¨   â”‚          â”‚  ç®¡ç†å‘˜é…ç½®   â”‚        â”‚ StorageClass â”‚
    â”‚            â”‚          â”‚              â”‚        â”‚  åŠ¨æ€ä¾›åº”    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å­˜å‚¨æŠ½è±¡å±‚æ¬¡ç†è§£


**ä¸‰å±‚æŠ½è±¡æ¨¡å‹**ï¼š
```
åº”ç”¨å±‚ï¼šPodä¸­çš„Volume    â† åº”ç”¨ç›´æ¥ä½¿ç”¨çš„æŒ‚è½½ç‚¹
å£°æ˜å±‚ï¼šPVC             â† "æˆ‘éœ€è¦10GBçš„é«˜é€Ÿå­˜å‚¨"
èµ„æºå±‚ï¼šPV              â† "è¿™é‡Œæœ‰å—50GBçš„NFSå­˜å‚¨"
```

ğŸ“ **å­¦ä¹ æ£€æŸ¥ç‚¹**
- [ ] ç†è§£å®¹å™¨æ•°æ®ä¸¢å¤±é—®é¢˜
- [ ] æŒæ¡PVã€PVCã€StorageClassä¸‰è€…å…³ç³»
- [ ] æ˜ç™½å­˜å‚¨æŠ½è±¡çš„å¿…è¦æ€§

---

## 2. ğŸ“¦ PersistentVolumeå­˜å‚¨å·è¯¦è§£


### 2.1 PVåŸºæœ¬æ¦‚å¿µ


**PVæœ¬è´¨ç†è§£**ï¼š
```
PV = é›†ç¾¤ä¸­çš„ä¸€å—å­˜å‚¨èµ„æº
å°±åƒï¼šæœºæˆ¿é‡Œçš„ä¸€å—ç¡¬ç›˜ï¼Œå·²ç»æ ¼å¼åŒ–å¥½ï¼Œç­‰å¾…è¢«ä½¿ç”¨
```

**PVç”Ÿå‘½å‘¨æœŸ**ï¼š
```
åˆ›å»º â†’ å¯ç”¨(Available) â†’ ç»‘å®š(Bound) â†’ é‡Šæ”¾(Released) â†’ åˆ é™¤/ä¿ç•™
```

### 2.2 PVé…ç½®è¯¦è§£


**åŸºç¡€NFSå­˜å‚¨PVç¤ºä¾‹**ï¼š
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nfs-pv-01
  labels:
    type: nfs
    environment: production
spec:
  capacity:
    storage: 10Gi                    # å­˜å‚¨å®¹é‡
  accessModes:
    - ReadWriteMany                  # è®¿é—®æ¨¡å¼
  persistentVolumeReclaimPolicy: Retain   # å›æ”¶ç­–ç•¥
  storageClassName: nfs-storage     # å­˜å‚¨ç±»
  nfs:
    server: 192.168.1.100          # NFSæœåŠ¡å™¨IP
    path: /data/k8s-volumes        # å…±äº«è·¯å¾„
```

**æœ¬åœ°å­˜å‚¨PVç¤ºä¾‹**ï¼š
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: local-pv-01
spec:
  capacity:
    storage: 50Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  storageClassName: local-storage
  local:
    path: /mnt/data                 # æœ¬åœ°è·¯å¾„
  nodeAffinity:                     # èŠ‚ç‚¹äº²å’Œæ€§
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - worker-node-01
```

### 2.3 PVé‡è¦å±æ€§è¯¦è§£


**å®¹é‡è§„æ ¼**ï¼š
```yaml
capacity:
  storage: 100Gi    # æ”¯æŒå•ä½ï¼šKi, Mi, Gi, Ti, Pi
```

**èŠ‚ç‚¹äº²å’Œæ€§é…ç½®**ï¼š
```yaml
nodeAffinity:
  required:
    nodeSelectorTerms:
    - matchExpressions:
      - key: zone
        operator: In
        values: ["zone-a", "zone-b"]
```

> ğŸ’¡ **å…³é”®æ´å¯Ÿ**
> PVæ˜¯é›†ç¾¤çº§åˆ«çš„èµ„æºï¼Œä¸å±äºä»»ä½•namespaceï¼Œä½†å¯ä»¥è¢«ä¸åŒnamespaceçš„PVCç»‘å®š

### 2.4 PVçŠ¶æ€ç®¡ç†


**PVçŠ¶æ€å«ä¹‰**ï¼š
- **Available**ï¼šå¯ç”¨çŠ¶æ€ï¼Œç­‰å¾…è¢«PVCç»‘å®š
- **Bound**ï¼šå·²è¢«PVCç»‘å®šï¼Œæ­£åœ¨ä½¿ç”¨ä¸­
- **Released**ï¼šPVCåˆ é™¤åï¼Œç­‰å¾…å›æ”¶
- **Failed**ï¼šå›æ”¶å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†

```bash
# æŸ¥çœ‹PVçŠ¶æ€
kubectl get pv
kubectl describe pv <pv-name>
```

---

## 3. ğŸ“‹ PersistentVolumeClaimå­˜å‚¨å£°æ˜


### 3.1 PVCæ ¸å¿ƒæ¦‚å¿µ


ğŸ¯ **PVCæœ¬è´¨**
```
PVC = å­˜å‚¨éœ€æ±‚ç”³è¯·å•
å°±åƒï¼šå‘ITéƒ¨é—¨ç”³è¯·åŠå…¬ç”¨å“ï¼Œè¯´æ˜éœ€è¦ä»€ä¹ˆè§„æ ¼ã€å¤šå°‘æ•°é‡
```

**PVCä¸Podå…³ç³»**ï¼š
```
Podä½¿ç”¨PVCæµç¨‹ï¼š
Podåˆ›å»º â†’ å¼•ç”¨PVC â†’ PVCè‡ªåŠ¨ç»‘å®šåˆé€‚çš„PV â†’ Podè·å¾—å­˜å‚¨
```

### 3.2 PVCé…ç½®å®ä¾‹


**åŸºç¡€PVCé…ç½®**ï¼š
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: webapp-storage
  namespace: default
spec:
  accessModes:
    - ReadWriteOnce              # è®¿é—®æ¨¡å¼åŒ¹é…
  storageClassName: fast-ssd     # æŒ‡å®šå­˜å‚¨ç±»
  resources:
    requests:
      storage: 20Gi              # ç”³è¯·å­˜å‚¨å¤§å°
  selector:                      # é€‰æ‹©å™¨ï¼ˆå¯é€‰ï¼‰
    matchLabels:
      type: ssd
      zone: east
```

**Podä¸­ä½¿ç”¨PVC**ï¼š
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: web-app
spec:
  containers:
  - name: app
    image: nginx:1.20
    volumeMounts:
    - name: storage-volume
      mountPath: /var/www/html    # å®¹å™¨å†…æŒ‚è½½è·¯å¾„
  volumes:
  - name: storage-volume
    persistentVolumeClaim:
      claimName: webapp-storage   # å¼•ç”¨PVCåç§°
```

### 3.3 PVCç»‘å®šæœºåˆ¶


**è‡ªåŠ¨ç»‘å®šæ¡ä»¶**ï¼š
```
PVCä¸PVç»‘å®šéœ€è¦æ»¡è¶³ï¼š
âœ… å­˜å‚¨å®¹é‡ï¼šPVå®¹é‡ >= PVCè¯·æ±‚
âœ… è®¿é—®æ¨¡å¼ï¼šå®Œå…¨åŒ¹é…
âœ… å­˜å‚¨ç±»ï¼šStorageClassNameä¸€è‡´
âœ… é€‰æ‹©å™¨ï¼šæ ‡ç­¾åŒ¹é…ï¼ˆå¦‚æœæœ‰ï¼‰
```

**ç»‘å®šä¼˜å…ˆçº§**ï¼š
1. **ç²¾ç¡®åŒ¹é…**ï¼šå®¹é‡ç›¸ç­‰çš„PVä¼˜å…ˆ
2. **æœ€å°æ»¡è¶³**ï¼šèƒ½æ»¡è¶³éœ€æ±‚çš„æœ€å°PV
3. **æ ‡ç­¾åŒ¹é…**ï¼šselectoræ ‡ç­¾åŒ¹é…çš„PV

ğŸ“Š **PVCçŠ¶æ€å¯¹æ¯”**
| çŠ¶æ€ | **å«ä¹‰** | **Podèƒ½å¦ä½¿ç”¨** | **è§£å†³æ–¹æ³•** |
|------|---------|----------------|-------------|
| `Pending` | `ç­‰å¾…ç»‘å®šåˆé€‚çš„PV` | âŒ | `åˆ›å»ºæ»¡è¶³æ¡ä»¶çš„PV` |
| `Bound` | `å·²æˆåŠŸç»‘å®šPV` | âœ… | `æ­£å¸¸ä½¿ç”¨` |
| `Lost` | `ç»‘å®šçš„PVä¸¢å¤±` | âŒ | `æ¢å¤PVæˆ–é‡æ–°ç”³è¯·` |

### 3.4 PVCå®æˆ˜æŠ€å·§


**åŠ¨æ€æ‰©å®¹ç¤ºä¾‹**ï¼š
```yaml
# ä¿®æ”¹PVCé…ç½®æ‰©å®¹
spec:
  resources:
    requests:
      storage: 50Gi    # ä»20Giæ‰©å±•åˆ°50Gi
```

âš ï¸ **æ³¨æ„äº‹é¡¹**
- PVCåˆ é™¤æ—¶ï¼ŒPodå¿…é¡»å…ˆåœæ­¢ä½¿ç”¨
- æ‰©å®¹åªèƒ½å¢å¤§ï¼Œä¸èƒ½ç¼©å°
- æŸäº›å­˜å‚¨ç±»å‹ä¸æ”¯æŒåœ¨çº¿æ‰©å®¹

---

## 4. ğŸ­ StorageClassåŠ¨æ€ä¾›åº”


### 4.1 StorageClassåŸºæœ¬ç†è§£


ğŸ’¡ **æ ¸å¿ƒæ¦‚å¿µ**
```
StorageClass = å­˜å‚¨æ¨¡æ¿ + è‡ªåŠ¨åŒ–å·¥å‚
å°±åƒï¼šé¢„è®¾å¥½è§„æ ¼çš„"å­˜å‚¨è®¢å•æ¨¡æ¿"ï¼Œéœ€è¦æ—¶è‡ªåŠ¨ç”Ÿäº§PV
```

**åŠ¨æ€ä¾›åº”æµç¨‹**ï¼š
```
ç”¨æˆ·åˆ›å»ºPVC â†’ æŒ‡å®šStorageClass â†’ è‡ªåŠ¨åˆ›å»ºPV â†’ ç»‘å®šå®Œæˆ
     â†“              â†“                â†“         â†“
   ç”³è¯·å­˜å‚¨      é€‰æ‹©å­˜å‚¨ç±»å‹      åŠ¨æ€åˆ†é…     ç«‹å³å¯ç”¨
```

### 4.2 StorageClassé…ç½®å®ä¾‹


**NFSåŠ¨æ€ä¾›åº”é…ç½®**ï¼š
```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-dynamic
provisioner: nfs.csi.k8s.io          # CSIé©±åŠ¨
parameters:
  server: 192.168.1.100              # NFSæœåŠ¡å™¨
  share: /data/dynamic-volumes       # å…±äº«è·¯å¾„
  storageClass: nfs-dynamic          # å­˜å‚¨ç±»åç§°
reclaimPolicy: Delete                # å›æ”¶ç­–ç•¥
allowVolumeExpansion: true           # å…è®¸æ‰©å®¹
volumeBindingMode: Immediate         # ç»‘å®šæ¨¡å¼
```

**äº‘å­˜å‚¨StorageClassç¤ºä¾‹**ï¼š
```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: kubernetes.io/aws-ebs   # AWS EBSé©±åŠ¨
parameters:
  type: gp3                          # ç£ç›˜ç±»å‹
  iops: "3000"                       # IOPSæ€§èƒ½
  encrypted: "true"                  # åŠ å¯†å­˜å‚¨
reclaimPolicy: Delete
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer  # å»¶è¿Ÿç»‘å®š
```

### 4.3 ä¾›åº”å™¨(Provisioner)è¯¦è§£


**å¸¸ç”¨Provisionerç±»å‹**ï¼š
```
å†…ç½®ä¾›åº”å™¨ï¼š
â€¢ kubernetes.io/aws-ebs     â† AWSå¼¹æ€§å—å­˜å‚¨
â€¢ kubernetes.io/gce-pd      â† GoogleæŒä¹…ç£ç›˜
â€¢ kubernetes.io/azure-disk  â† Azureç£ç›˜

å¤–éƒ¨ä¾›åº”å™¨ï¼š
â€¢ nfs.csi.k8s.io           â† NFS CSIé©±åŠ¨
â€¢ ceph.rook.io/block       â† Cephå—å­˜å‚¨
â€¢ longhorn.io              â† Longhornåˆ†å¸ƒå¼å­˜å‚¨
```

### 4.4 ç»‘å®šæ¨¡å¼ç†è§£


**Immediate vs WaitForFirstConsumer**ï¼š

```
Immediateæ¨¡å¼ï¼š
PVCåˆ›å»º â†’ ç«‹å³åˆ›å»ºPV â†’ ç«‹å³ç»‘å®š
ä¼˜ç‚¹ï¼šå¿«é€Ÿå¯ç”¨
ç¼ºç‚¹ï¼šå¯èƒ½åœ¨é”™è¯¯çš„èŠ‚ç‚¹åˆ›å»º

WaitForFirstConsumeræ¨¡å¼ï¼š
PVCåˆ›å»º â†’ ç­‰å¾…Podè°ƒåº¦ â†’ åœ¨Podæ‰€åœ¨èŠ‚ç‚¹åˆ›å»ºPV
ä¼˜ç‚¹ï¼šä½ç½®ä¼˜åŒ–
ç¼ºç‚¹ï¼šé¦–æ¬¡å¯åŠ¨æ…¢
```

ğŸ¯ **é€‰æ‹©å»ºè®®**
- **æœ¬åœ°å­˜å‚¨**ï¼šä½¿ç”¨WaitForFirstConsumer
- **ç½‘ç»œå­˜å‚¨**ï¼šä½¿ç”¨Immediate
- **æ€§èƒ½æ•æ„Ÿ**ï¼šä½¿ç”¨WaitForFirstConsumer

---

## 5. ğŸ” å­˜å‚¨è®¿é—®æ¨¡å¼æ·±å…¥ç†è§£


### 5.1 ä¸‰ç§è®¿é—®æ¨¡å¼è¯¦è§£


**è®¿é—®æ¨¡å¼å¯¹æ¯”è¡¨**ï¼š
| æ¨¡å¼ | **ç®€ç§°** | **å«ä¹‰** | **å…¸å‹åœºæ™¯** | **æ”¯æŒå­˜å‚¨ç±»å‹** |
|------|---------|---------|--------------|----------------|
| `ReadWriteOnce` | `RWO` | `å•èŠ‚ç‚¹è¯»å†™` | `æ•°æ®åº“ã€å•å®ä¾‹åº”ç”¨` | `å¤§å¤šæ•°å—å­˜å‚¨` |
| `ReadOnlyMany` | `ROX` | `å¤šèŠ‚ç‚¹åªè¯»` | `é…ç½®æ–‡ä»¶å…±äº«` | `NFSã€å¯¹è±¡å­˜å‚¨` |
| `ReadWriteMany` | `RWX` | `å¤šèŠ‚ç‚¹è¯»å†™` | `å…±äº«æ–‡ä»¶ç³»ç»Ÿ` | `NFSã€CephFS` |

### 5.2 è®¿é—®æ¨¡å¼å®é™…åº”ç”¨


ğŸ  **ç”Ÿæ´»ç±»æ¯”ç†è§£**
```
RWO = ä¸ªäººä¿é™©ç®±ï¼šåªæœ‰ä½ ä¸€ä¸ªäººèƒ½å­˜å–
ROX = å›¾ä¹¦é¦†ä¹¦ç±ï¼šå¾ˆå¤šäººèƒ½çœ‹ï¼Œä½†ä¸èƒ½ä¿®æ”¹
RWX = å…±äº«ç™½æ¿ï¼šå¤šäººåŒæ—¶å†™å­—ç”»ç”»
```

**MySQLæ•°æ®åº“é…ç½®(RWO)**ï¼š
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-storage
spec:
  accessModes:
    - ReadWriteOnce     # æ•°æ®åº“é€šå¸¸åªéœ€å•èŠ‚ç‚¹è®¿é—®
  resources:
    requests:
      storage: 20Gi
  storageClassName: fast-ssd
```

**Nginxé™æ€æ–‡ä»¶å…±äº«(RWX)**ï¼š
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nginx-static-content
spec:
  accessModes:
    - ReadWriteMany     # å¤šä¸ªNginx Podå…±äº«é™æ€æ–‡ä»¶
  resources:
    requests:
      storage: 5Gi
  storageClassName: nfs-storage
```

### 5.3 è®¿é—®æ¨¡å¼é™åˆ¶ä¸è§£å†³æ–¹æ¡ˆ


**å¸¸è§é—®é¢˜åŠè§£å†³**ï¼š

âš ï¸ **é—®é¢˜1ï¼šRWOæ¨¡å¼Podæ— æ³•è¿ç§»**
```
ç°è±¡ï¼šPodå¡åœ¨PendingçŠ¶æ€
åŸå› ï¼šRWOå·åªèƒ½æŒ‚è½½åˆ°ä¸€ä¸ªèŠ‚ç‚¹
è§£å†³ï¼šä½¿ç”¨æ”¯æŒRWXçš„å­˜å‚¨æˆ–é‡æ–°è®¾è®¡åº”ç”¨æ¶æ„
```

âš ï¸ **é—®é¢˜2ï¼šRWXæ€§èƒ½é—®é¢˜**
```
ç°è±¡ï¼šå¤šPodå†™å…¥æ—¶æ€§èƒ½ä¸‹é™
åŸå› ï¼šå¹¶å‘å†™å…¥å†²çªå’Œç½‘ç»œå¼€é”€
è§£å†³ï¼šä½¿ç”¨åº”ç”¨å±‚é”æœºåˆ¶æˆ–åˆ†ç‰‡å­˜å‚¨
```

ğŸ’ª **æœ€ä½³å®è·µå»ºè®®**
- **æ•°æ®åº“**ï¼šä¼˜å…ˆä½¿ç”¨RWO + é«˜æ€§èƒ½å­˜å‚¨
- **ç¼“å­˜åº”ç”¨**ï¼šè€ƒè™‘RWO + æœ¬åœ°SSD
- **æ–‡ä»¶å…±äº«**ï¼šä½¿ç”¨RWX + NFS
- **æ—¥å¿—æ”¶é›†**ï¼šä½¿ç”¨RWO + å®šæœŸè½®è½¬

---

## 6. â™»ï¸ å­˜å‚¨å›æ”¶ç­–ç•¥ç®¡ç†


### 6.1 ä¸‰ç§å›æ”¶ç­–ç•¥è¯¦è§£


ğŸ“Š **å›æ”¶ç­–ç•¥å¯¹æ¯”**
| ç­–ç•¥ | **PVCåˆ é™¤åè¡Œä¸º** | **æ•°æ®çŠ¶æ€** | **PVçŠ¶æ€** | **ä½¿ç”¨åœºæ™¯** |
|------|------------------|-------------|-----------|-------------|
| `Retain` | `ä¿ç•™æ•°æ®å’ŒPV` | `âœ… ä¿ç•™` | `Released` | `é‡è¦æ•°æ®` |
| `Delete` | `åˆ é™¤PVå’Œæ•°æ®` | `âŒ åˆ é™¤` | `åˆ é™¤` | `ä¸´æ—¶æ•°æ®` |
| `Recycle` | `æ¸…ç©ºæ•°æ®ï¼ŒPVå¯é‡ç”¨` | `ğŸ”„ æ¸…ç©º` | `Available` | `å·²åºŸå¼ƒ` |

### 6.2 å›æ”¶ç­–ç•¥å®æˆ˜åº”ç”¨


**ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“å­˜å‚¨**ï¼š
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: production-db-pv
spec:
  capacity:
    storage: 100Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain    # ä¿ç•™ç­–ç•¥
  storageClassName: production-ssd
  # ... å­˜å‚¨é…ç½®
```

**å¼€å‘æµ‹è¯•ç¯å¢ƒå­˜å‚¨**ï¼š
```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: dev-storage
provisioner: kubernetes.io/aws-ebs
reclaimPolicy: Delete              # è‡ªåŠ¨åˆ é™¤ç­–ç•¥
parameters:
  type: gp2
```

### 6.3 æ‰‹åŠ¨å›æ”¶ç®¡ç†


**ReleasedçŠ¶æ€PVå¤„ç†**ï¼š
```bash
# æŸ¥çœ‹ReleasedçŠ¶æ€çš„PV
kubectl get pv | grep Released

# æ‰‹åŠ¨æ¸…ç†PVæ•°æ®åï¼Œç§»é™¤claimRefä½¿å…¶å˜ä¸ºAvailable
kubectl patch pv <pv-name> -p '{"spec":{"claimRef":null}}'

# æˆ–è€…ç›´æ¥åˆ é™¤PV
kubectl delete pv <pv-name>
```

**æ•°æ®å¤‡ä»½åå›æ”¶**ï¼š
```bash
# 1. å¤‡ä»½æ•°æ®
tar -czf backup-$(date +%Y%m%d).tar.gz /path/to/data

# 2. éªŒè¯å¤‡ä»½å®Œæ•´æ€§
tar -tzf backup-$(date +%Y%m%d).tar.gz

# 3. å®‰å…¨åˆ é™¤PV
kubectl delete pv <pv-name>
```

ğŸ¯ **å›æ”¶ç­–ç•¥é€‰æ‹©æŒ‡å¯¼**
- **ç”Ÿäº§æ•°æ®**ï¼šä½¿ç”¨Retainï¼Œæ‰‹åŠ¨ç®¡ç†
- **æµ‹è¯•ç¯å¢ƒ**ï¼šä½¿ç”¨Deleteï¼Œè‡ªåŠ¨æ¸…ç†
- **å…±äº«ç¼“å­˜**ï¼šä½¿ç”¨Deleteï¼Œå®šæœŸé‡å»º
- **æ—¥å¿—æ–‡ä»¶**ï¼šä½¿ç”¨Deleteï¼Œé…åˆæ—¥å¿—è½®è½¬

---

## 7. ğŸ”Œ CSIå­˜å‚¨é©±åŠ¨å®æˆ˜


### 7.1 CSIæ¶æ„ç†è§£


ğŸ’¡ **CSIæ ¸å¿ƒæ¦‚å¿µ**
```
CSI = Container Storage Interface
ä½œç”¨ï¼šæ ‡å‡†åŒ–å­˜å‚¨æ¥å£ï¼Œè®©ä¸åŒå­˜å‚¨ç³»ç»Ÿéƒ½èƒ½æ¥å…¥K8s
å°±åƒï¼šUSBæ¥å£æ ‡å‡†ï¼Œä¸åŒè®¾å¤‡éƒ½èƒ½é€šè¿‡USBè¿æ¥ç”µè„‘
```

**CSIç»„ä»¶æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Node Plugin   â”‚    â”‚Controller Pluginâ”‚    â”‚  External Comp  â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ æŒ‚è½½/å¸è½½     â”‚    â”‚ â€¢ åˆ›å»º/åˆ é™¤å·   â”‚    â”‚ â€¢ Provisioner   â”‚
â”‚ â€¢ æ ¼å¼åŒ–        â”‚    â”‚ â€¢ å¿«ç…§ç®¡ç†      â”‚    â”‚ â€¢ Attacher      â”‚
â”‚ â€¢ å¥åº·æ£€æŸ¥      â”‚    â”‚ â€¢ æ‰©å®¹æ“ä½œ      â”‚    â”‚ â€¢ Snapshotter   â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                        â–²                        â–²
         â”‚                        â”‚                        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚    kubelet        â”‚
                        â”‚                   â”‚
                        â”‚ â€¢ è°ƒç”¨CSIæ¥å£     â”‚
                        â”‚ â€¢ ç®¡ç†å·ç”Ÿå‘½å‘¨æœŸ  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 å¸¸ç”¨CSIé©±åŠ¨éƒ¨ç½²


**NFS CSIé©±åŠ¨éƒ¨ç½²**ï¼š
```bash
# å®‰è£…NFS CSIé©±åŠ¨
kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/csi-driver-nfs/master/deploy/example/nfs-provisioner/nfs-server.yaml

# åˆ›å»ºStorageClass
kubectl apply -f - <<EOF
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-csi
provisioner: nfs.csi.k8s.io
parameters:
  server: nfs-server.default.svc.cluster.local
  share: /
reclaimPolicy: Delete
volumeBindingMode: Immediate
mountOptions:
  - hard
  - nfsvers=4.1
EOF
```

**æœ¬åœ°å­˜å‚¨CSIé…ç½®**ï¼š
```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage
provisioner: rancher.io/local-path
reclaimPolicy: Delete
volumeBindingMode: WaitForFirstConsumer
```

### 7.3 CSIåŠŸèƒ½ç‰¹æ€§


**å·å¿«ç…§åŠŸèƒ½**ï¼š
```yaml
# åˆ›å»ºå·å¿«ç…§ç±»
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: csi-snapshot-class
driver: nfs.csi.k8s.io
deletionPolicy: Delete

---
# åˆ›å»ºå¿«ç…§
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: webapp-snapshot
spec:
  volumeSnapshotClassName: csi-snapshot-class
  source:
    persistentVolumeClaimName: webapp-storage
```

**å·æ‰©å®¹æ“ä½œ**ï¼š
```yaml
# StorageClasså¯ç”¨æ‰©å®¹
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: expandable-storage
provisioner: nfs.csi.k8s.io
allowVolumeExpansion: true    # å…³é”®é…ç½®
```

### 7.4 CSIé©±åŠ¨é€‰æ‹©æŒ‡å—


**é©±åŠ¨ç‰¹æ€§å¯¹æ¯”**ï¼š
```
NFS CSI:
âœ… æ”¯æŒRWXè®¿é—®æ¨¡å¼
âœ… ç®€å•æ˜“é…ç½®
âŒ æ€§èƒ½å—ç½‘ç»œå½±å“

Local Path CSI:
âœ… æœ¬åœ°æ€§èƒ½ä¼˜å¼‚
âœ… é›¶ç½‘ç»œå»¶è¿Ÿ
âŒ ä»…æ”¯æŒRWOæ¨¡å¼

Ceph CSI:
âœ… ä¼ä¸šçº§å¯é æ€§
âœ… ä¸°å¯Œçš„åŠŸèƒ½ç‰¹æ€§
âŒ é…ç½®å¤æ‚åº¦é«˜
```

---

## 8. ğŸ“Š å­˜å‚¨ç±»å‹é€‰æ‹©æŒ‡å—


### 8.1 æœ¬åœ°å­˜å‚¨vsç½‘ç»œå­˜å‚¨


ğŸ  **é€šä¿—å¯¹æ¯”**
```
æœ¬åœ°å­˜å‚¨ = å®¶é‡Œçš„ä¿é™©ç®±ï¼š
â€¢ é€Ÿåº¦å¿«ï¼Œç«‹å³å¯ç”¨
â€¢ æ¬å®¶æ—¶éœ€è¦é‡æ–°é…ç½®

ç½‘ç»œå­˜å‚¨ = é“¶è¡Œä¿é™©ç®±ï¼š
â€¢ ä»»ä½•åœ°æ–¹éƒ½èƒ½è®¿é—®
â€¢ é€Ÿåº¦å—ç½‘ç»œå½±å“
```

**æ€§èƒ½å¯¹æ¯”è¡¨**ï¼š
| æŒ‡æ ‡ | **æœ¬åœ°å­˜å‚¨** | **NFSç½‘ç»œå­˜å‚¨** | **å—å­˜å‚¨(iSCSI)** | **å¯¹è±¡å­˜å‚¨** |
|------|-------------|----------------|------------------|-------------|
| `è¯»å†™å»¶è¿Ÿ` | `â­â­â­â­â­` | `â­â­â­` | `â­â­â­â­` | `â­â­` |
| `ååé‡` | `â­â­â­â­â­` | `â­â­â­` | `â­â­â­â­` | `â­â­â­` |
| `å¯ç”¨æ€§` | `â­â­` | `â­â­â­â­` | `â­â­â­â­` | `â­â­â­â­â­` |
| `æ‰©å±•æ€§` | `â­â­` | `â­â­â­â­` | `â­â­â­` | `â­â­â­â­â­` |
| `æˆæœ¬` | `â­â­â­â­â­` | `â­â­â­` | `â­â­` | `â­â­â­` |

### 8.2 åº”ç”¨åœºæ™¯åŒ¹é…


**æ•°æ®åº“åº”ç”¨å­˜å‚¨é€‰æ‹©**ï¼š
```
MySQL/PostgreSQL:
æ¨èï¼šæœ¬åœ°SSD + ReadWriteOnce
ç†ç”±ï¼šé«˜IOPSéœ€æ±‚ï¼Œå•å®ä¾‹è®¿é—®

Redisé›†ç¾¤:
æ¨èï¼šæœ¬åœ°NVMe + å¤šå®ä¾‹éƒ¨ç½²
ç†ç”±ï¼šæä½å»¶è¿Ÿéœ€æ±‚

MongoDB:
æ¨èï¼šé«˜æ€§èƒ½å—å­˜å‚¨ + å‰¯æœ¬é›†
ç†ç”±ï¼šå¹³è¡¡æ€§èƒ½å’Œå¯ç”¨æ€§
```

**Webåº”ç”¨å­˜å‚¨ç­–ç•¥**ï¼š
```yaml
# åº”ç”¨ä»£ç (åªè¯»)
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-code

# ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶(è¯»å†™)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: user-uploads
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: nfs-storage

# åº”ç”¨æ—¥å¿—(å†™å…¥)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: app-logs
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: local-ssd
```

### 8.3 å­˜å‚¨æ€§èƒ½è°ƒä¼˜


**æœ¬åœ°å­˜å‚¨ä¼˜åŒ–**ï¼š
```yaml
# ä½¿ç”¨èŠ‚ç‚¹äº²å’Œæ€§ç»‘å®šé«˜æ€§èƒ½èŠ‚ç‚¹
apiVersion: v1
kind: PersistentVolume
metadata:
  name: high-perf-local
spec:
  capacity:
    storage: 100Gi
  accessModes:
    - ReadWriteOnce
  storageClassName: local-nvme
  local:
    path: /mnt/nvme-ssd
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: storage-type
          operator: In
          values: ["nvme"]
```

**ç½‘ç»œå­˜å‚¨ä¼˜åŒ–**ï¼š
```yaml
# NFSæŒ‚è½½ä¼˜åŒ–å‚æ•°
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-optimized
provisioner: nfs.csi.k8s.io
parameters:
  server: 192.168.1.100
  share: /data/high-perf
mountOptions:
  - hard                    # ç¡¬æŒ‚è½½
  - nfsvers=4.1            # ä½¿ç”¨NFS 4.1
  - rsize=1048576          # è¯»ç¼“å†²åŒºå¤§å°
  - wsize=1048576          # å†™ç¼“å†²åŒºå¤§å°
  - timeo=600              # è¶…æ—¶æ—¶é—´
```

---

## 9. ğŸ“ˆ å­˜å‚¨æ‰©å®¹ä¸å¿«ç…§ç®¡ç†


### 9.1 åœ¨çº¿æ‰©å®¹å®æˆ˜


ğŸ’¡ **æ‰©å®¹åŸºæœ¬åŸç†**
```
æ‰©å®¹è¿‡ç¨‹ï¼š
1. ä¿®æ”¹PVCå®¹é‡è¯·æ±‚
2. CSIé©±åŠ¨æ‰©å±•åº•å±‚å­˜å‚¨
3. æ–‡ä»¶ç³»ç»Ÿè‡ªåŠ¨æ‰©å±•
4. Podæ— éœ€é‡å¯å³å¯ä½¿ç”¨æ–°å®¹é‡
```

**PVCæ‰©å®¹æ“ä½œ**ï¼š
```bash
# 1. æ£€æŸ¥StorageClassæ˜¯å¦æ”¯æŒæ‰©å®¹
kubectl get storageclass -o=jsonpath='{.items[*].allowVolumeExpansion}'

# 2. ç¼–è¾‘PVCå¢åŠ å®¹é‡
kubectl edit pvc webapp-storage
# ä¿®æ”¹ spec.resources.requests.storage: 50Gi

# 3. æŸ¥çœ‹æ‰©å®¹çŠ¶æ€
kubectl get pvc webapp-storage
kubectl describe pvc webapp-storage
```

**æ‰©å®¹çŠ¶æ€ç›‘æ§**ï¼š
```bash
# æŸ¥çœ‹æ‰©å®¹è¿›åº¦
kubectl get events --field-selector involvedObject.name=webapp-storage

# æ£€æŸ¥Podå†…å¯ç”¨ç©ºé—´
kubectl exec -it webapp-pod -- df -h /var/www/html
```

### 9.2 å·å¿«ç…§ç®¡ç†


**å¿«ç…§åˆ›å»ºæµç¨‹**ï¼š
```yaml
# 1. ç¡®ä¿æœ‰VolumeSnapshotClass
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: nfs-snapshot-class
driver: nfs.csi.k8s.io
deletionPolicy: Delete

---
# 2. åˆ›å»ºå¿«ç…§
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: webapp-backup-20231201
  namespace: default
spec:
  volumeSnapshotClassName: nfs-snapshot-class
  source:
    persistentVolumeClaimName: webapp-storage
```

**ä»å¿«ç…§æ¢å¤æ•°æ®**ï¼š
```yaml
# ä»å¿«ç…§åˆ›å»ºæ–°PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: webapp-restored
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: nfs-storage
  resources:
    requests:
      storage: 20Gi
  dataSource:
    name: webapp-backup-20231201    # å¿«ç…§åç§°
    kind: VolumeSnapshot
    apiGroup: snapshot.storage.k8s.io
```

### 9.3 è‡ªåŠ¨åŒ–å¿«ç…§ç­–ç•¥


**å®šæ—¶å¿«ç…§é…ç½®**ï¼š
```yaml
# ä½¿ç”¨CronJobè‡ªåŠ¨åˆ›å»ºå¿«ç…§
apiVersion: batch/v1
kind: CronJob
metadata:
  name: daily-snapshot
spec:
  schedule: "0 2 * * *"              # æ¯å¤©å‡Œæ™¨2ç‚¹
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: snapshot-creator
            image: bitnami/kubectl:latest
            command:
            - /bin/sh
            - -c
            - |
              kubectl create -f - <<EOF
              apiVersion: snapshot.storage.k8s.io/v1
              kind: VolumeSnapshot
              metadata:
                name: auto-snapshot-$(date +%Y%m%d-%H%M)
              spec:
                volumeSnapshotClassName: nfs-snapshot-class
                source:
                  persistentVolumeClaimName: webapp-storage
              EOF
          restartPolicy: OnFailure
```

ğŸ¯ **å¿«ç…§ç®¡ç†æœ€ä½³å®è·µ**
- **ä¿ç•™ç­–ç•¥**ï¼šç”Ÿäº§ç¯å¢ƒä¿ç•™30å¤©ï¼Œå¼€å‘ç¯å¢ƒ7å¤©
- **å‘½åè§„èŒƒ**ï¼šåŒ…å«åº”ç”¨åã€æ—¥æœŸæ—¶é—´
- **è‡ªåŠ¨æ¸…ç†**ï¼šé…ç½®å®šæœŸåˆ é™¤è¿‡æœŸå¿«ç…§
- **ç›‘æ§å‘Šè­¦**ï¼šå¿«ç…§åˆ›å»ºå¤±è´¥æ—¶åŠæ—¶é€šçŸ¥

---

## 10. ğŸ’¾ æ•°æ®å¤‡ä»½ä¸æ¢å¤ç­–ç•¥


### 10.1 å¤‡ä»½ç­–ç•¥è®¾è®¡


**åˆ†å±‚å¤‡ä»½æ–¹æ¡ˆ**ï¼š
```
L1: å¿«ç…§å¤‡ä»½ (å°æ—¶çº§)
â”œâ”€â”€ ç”¨é€”ï¼šå¿«é€Ÿæ¢å¤ï¼Œè¿‘æœŸæ•°æ®
â”œâ”€â”€ ä¿ç•™ï¼š24å°æ—¶
â””â”€â”€ RPOï¼š1å°æ—¶

L2: å¢é‡å¤‡ä»½ (æ—¥çº§)  
â”œâ”€â”€ ç”¨é€”ï¼šæ—¥å¸¸æ¢å¤ï¼Œå†å²æ•°æ®
â”œâ”€â”€ ä¿ç•™ï¼š30å¤©
â””â”€â”€ RPOï¼š1å¤©

L3: å…¨é‡å¤‡ä»½ (å‘¨/æœˆçº§)
â”œâ”€â”€ ç”¨é€”ï¼šé•¿æœŸä¿å­˜ï¼Œåˆè§„è¦æ±‚
â”œâ”€â”€ ä¿ç•™ï¼š1å¹´
â””â”€â”€ RPOï¼š1å‘¨
```

### 10.2 åº”ç”¨æ•°æ®å¤‡ä»½å®æˆ˜


**æ•°æ®åº“å¤‡ä»½ç¤ºä¾‹**ï¼š
```yaml
# MySQLå¤‡ä»½Job
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mysql-backup
spec:
  schedule: "0 1 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: mysql-backup
            image: mysql:8.0
            env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secret
                  key: password
            command:
            - /bin/bash
            - -c
            - |
              mysqldump -h mysql-service -u root -p$MYSQL_ROOT_PASSWORD \
                --single-transaction --routines --triggers \
                --all-databases > /backup/mysql-$(date +%Y%m%d).sql
              
              # å‹ç¼©å¤‡ä»½æ–‡ä»¶
              gzip /backup/mysql-$(date +%Y%m%d).sql
              
              # æ¸…ç†7å¤©å‰çš„å¤‡ä»½
              find /backup -name "mysql-*.sql.gz" -mtime +7 -delete
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: backup-pvc
          restartPolicy: OnFailure
```

### 10.3 è·¨é›†ç¾¤æ•°æ®è¿ç§»


**Veleroå¤‡ä»½å·¥å…·é…ç½®**ï¼š
```bash
# å®‰è£…Velero
curl -fsSL -o velero-v1.12.0-linux-amd64.tar.gz \
  https://github.com/vmware-tanzu/velero/releases/download/v1.12.0/velero-v1.12.0-linux-amd64.tar.gz

tar -xvf velero-v1.12.0-linux-amd64.tar.gz
sudo mv velero-v1.12.0-linux-amd64/velero /usr/local/bin/

# é…ç½®å¤‡ä»½å­˜å‚¨
velero install \
  --provider aws \
  --plugins velero/velero-plugin-for-aws:v1.8.0 \
  --bucket my-backup-bucket \
  --backup-location-config region=us-east-1 \
  --snapshot-location-config region=us-east-1
```

**åˆ›å»ºåº”ç”¨å¤‡ä»½**ï¼š
```bash
# å¤‡ä»½æ•´ä¸ªå‘½åç©ºé—´
velero backup create webapp-backup \
  --include-namespaces webapp \
  --storage-location default

# å¤‡ä»½ç‰¹å®šèµ„æº
velero backup create db-backup \
  --include-resources persistentvolumeclaims,persistentvolumes \
  --selector app=mysql
```

### 10.4 ç¾éš¾æ¢å¤æ¼”ç»ƒ


**æ¢å¤æµç¨‹éªŒè¯**ï¼š
```bash
# 1. æ¨¡æ‹Ÿç¾éš¾ï¼ˆåˆ é™¤åº”ç”¨ï¼‰
kubectl delete namespace webapp

# 2. ä»å¤‡ä»½æ¢å¤
velero restore create webapp-restore \
  --from-backup webapp-backup

# 3. éªŒè¯æ¢å¤ç»“æœ
kubectl get pods -n webapp
kubectl get pvc -n webapp

# 4. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
kubectl exec -it webapp-pod -- ls -la /var/www/html
```

ğŸ“‹ **å¤‡ä»½æ¢å¤æ£€æŸ¥æ¸…å•**
- [ ] å¤‡ä»½ä»»åŠ¡æ­£å¸¸æ‰§è¡Œ
- [ ] å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§éªŒè¯
- [ ] æ¢å¤æµç¨‹æµ‹è¯•é€šè¿‡
- [ ] æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å®Œæˆ
- [ ] æ¢å¤æ—¶é—´æ»¡è¶³RTOè¦æ±‚
- [ ] å¤‡ä»½ç›‘æ§å‘Šè­¦æ­£å¸¸

ğŸš¨ **æ³¨æ„äº‹é¡¹**
- å®šæœŸè¿›è¡Œç¾éš¾æ¢å¤æ¼”ç»ƒ
- å¤‡ä»½å­˜å‚¨ä¸ç”Ÿäº§ç¯å¢ƒç‰©ç†éš”ç¦»
- åŠ å¯†æ•æ„Ÿæ•°æ®å¤‡ä»½
- æ–‡æ¡£åŒ–æ¢å¤æµç¨‹å’Œè”ç³»äºº

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å­˜å‚¨ä¸‰ä»¶å¥—ï¼šPV(èµ„æº) + PVC(ç”³è¯·) + StorageClass(æ¨¡æ¿)
ğŸ”¸ è®¿é—®æ¨¡å¼ï¼šRWO(å•èŠ‚ç‚¹) + ROX(å¤šèŠ‚ç‚¹åªè¯») + RWX(å¤šèŠ‚ç‚¹è¯»å†™)  
ğŸ”¸ å›æ”¶ç­–ç•¥ï¼šRetain(ä¿ç•™) + Delete(åˆ é™¤) + Recycle(å·²åºŸå¼ƒ)
ğŸ”¸ CSIæ ‡å‡†ï¼šå®¹å™¨å­˜å‚¨æ¥å£ï¼Œç»Ÿä¸€å­˜å‚¨é©±åŠ¨æ ‡å‡†
ğŸ”¸ åŠ¨æ€ä¾›åº”ï¼šStorageClassè‡ªåŠ¨åˆ›å»ºPVçš„æœºåˆ¶
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å­˜å‚¨æŠ½è±¡çš„ä»·å€¼**
```
åˆ†å±‚è®¾è®¡çš„å¥½å¤„ï¼š
- åº”ç”¨å¼€å‘è€…ï¼šåªéœ€å…³å¿ƒPVCï¼Œå£°æ˜å­˜å‚¨éœ€æ±‚
- é›†ç¾¤ç®¡ç†å‘˜ï¼šç®¡ç†PVå’ŒStorageClassï¼Œæä¾›å­˜å‚¨èµ„æº  
- å­˜å‚¨ç®¡ç†å‘˜ï¼šä¸“æ³¨åº•å±‚å­˜å‚¨ç³»ç»Ÿç»´æŠ¤
```

**ğŸ”¹ è®¿é—®æ¨¡å¼çš„é€‰æ‹©åŸåˆ™**
```
ä¸šåŠ¡ç‰¹ç‚¹å†³å®šè®¿é—®æ¨¡å¼ï¼š
- æ•°æ®åº“ç±»ï¼šé€‰æ‹©RWOï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
- é™æ€æ–‡ä»¶ï¼šé€‰æ‹©RWXï¼Œæ”¯æŒå¤šå®ä¾‹å…±äº«
- é…ç½®æ–‡ä»¶ï¼šé€‰æ‹©ROXï¼Œé˜²æ­¢æ„å¤–ä¿®æ”¹
```

**ğŸ”¹ å­˜å‚¨æ€§èƒ½ä¼˜åŒ–æ€è·¯**
```
æ€§èƒ½ä¼˜åŒ–å±‚æ¬¡ï¼š
- ç¡¬ä»¶å±‚ï¼šé€‰æ‹©åˆé€‚çš„å­˜å‚¨ä»‹è´¨(SSD/NVMe)
- ç½‘ç»œå±‚ï¼šä¼˜åŒ–ç½‘ç»œå¸¦å®½å’Œå»¶è¿Ÿ
- æ–‡ä»¶ç³»ç»Ÿï¼šè°ƒæ•´æŒ‚è½½å‚æ•°å’Œç¼“å­˜ç­–ç•¥
- åº”ç”¨å±‚ï¼šä¼˜åŒ–IOæ¨¡å¼å’Œè®¿é—®æ¨¡å¼
```

### 11.3 å®æˆ˜åº”ç”¨æŒ‡å¯¼


**ğŸ¯ å­˜å‚¨æ–¹æ¡ˆé€‰æ‹©**
```
é€‰æ‹©å†³ç­–æ ‘ï¼š
é«˜æ€§èƒ½éœ€æ±‚ï¼Ÿ
â”œâ”€ æ˜¯ â†’ æœ¬åœ°å­˜å‚¨ + RWO
â””â”€ å¦ â†’ ç½‘ç»œå­˜å‚¨
    â”œâ”€ éœ€è¦å…±äº«ï¼Ÿ
    â”‚   â”œâ”€ æ˜¯ â†’ NFS + RWX  
    â”‚   â””â”€ å¦ â†’ å—å­˜å‚¨ + RWO
    â””â”€ é¢„ç®—æœ‰é™ï¼Ÿ
        â”œâ”€ æ˜¯ â†’ æœ¬åœ°å­˜å‚¨
        â””â”€ å¦ â†’ äº‘å­˜å‚¨
```

**ğŸ’ª è¿ç»´æœ€ä½³å®è·µ**
```
æ—¥å¸¸è¿ç»´è¦ç‚¹ï¼š
- ç›‘æ§å­˜å‚¨ä½¿ç”¨ç‡ï¼Œæå‰é¢„è­¦
- å®šæœŸæ‰§è¡Œæ‰©å®¹å’Œå¿«ç…§æ“ä½œ
- å»ºç«‹å®Œå–„çš„å¤‡ä»½æ¢å¤æµç¨‹
- æµ‹è¯•å­˜å‚¨æ•…éšœåº”æ€¥é¢„æ¡ˆ
- ä¼˜åŒ–å­˜å‚¨æˆæœ¬å’Œæ€§èƒ½å¹³è¡¡
```

**ğŸ”§ æ•…éšœæ’æŸ¥æ€è·¯**
```
å¸¸è§é—®é¢˜è¯Šæ–­ï¼š
Podä¸€ç›´Pending â†’ æ£€æŸ¥PVCç»‘å®šçŠ¶æ€
å­˜å‚¨æŒ‚è½½å¤±è´¥ â†’ æŸ¥çœ‹CSIé©±åŠ¨æ—¥å¿—
æ€§èƒ½é—®é¢˜ â†’ åˆ†æIOæ¨¡å¼å’Œç½‘ç»œå»¶è¿Ÿ
æ•°æ®ä¸¢å¤± â†’ æ£€æŸ¥å›æ”¶ç­–ç•¥å’Œå¤‡ä»½
```

### 11.4 å­¦ä¹ è¿›é˜¶è·¯çº¿


**ğŸ“š æ·±å…¥å­¦ä¹ å»ºè®®**
```
å…¥é—¨é˜¶æ®µï¼š
- æŒæ¡PV/PVCåŸºæœ¬æ“ä½œ
- ç†è§£è®¿é—®æ¨¡å¼åŒºåˆ«
- å®è·µæœ¬åœ°å­˜å‚¨é…ç½®

è¿›é˜¶é˜¶æ®µï¼š  
- å­¦ä¹ CSIé©±åŠ¨åŸç†
- æŒæ¡åŠ¨æ€ä¾›åº”é…ç½®
- å®è·µå­˜å‚¨æ€§èƒ½è°ƒä¼˜

é«˜çº§é˜¶æ®µï¼š
- ç ”ç©¶å­˜å‚¨æ‰©å±•å’Œå¿«ç…§
- è®¾è®¡å¤‡ä»½æ¢å¤æ–¹æ¡ˆ
- ä¼˜åŒ–å¤šé›†ç¾¤å­˜å‚¨ç®¡ç†
```

**ğŸ¯ å®è·µé¡¹ç›®æ¨è**
- **ä¸ªäººåšå®¢ç³»ç»Ÿ**ï¼šç»ƒä¹ åŸºç¡€PV/PVCé…ç½®
- **MySQLä¸»ä»å¤åˆ¶**ï¼šç†è§£ä¸åŒè®¿é—®æ¨¡å¼åº”ç”¨
- **æ–‡ä»¶å…±äº«æœåŠ¡**ï¼šæŒæ¡NFSå­˜å‚¨é…ç½®
- **ç›‘æ§ç³»ç»Ÿéƒ¨ç½²**ï¼šå­¦ä¹ æ—¶åºæ•°æ®å­˜å‚¨ä¼˜åŒ–
- **CI/CDæµæ°´çº¿**ï¼šå®è·µæ„å»ºç¼“å­˜å’Œåˆ¶å“å­˜å‚¨

### 11.5 å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥


**ğŸ”§ æ—¥å¸¸è¿ç»´å‘½ä»¤**
```bash
# å­˜å‚¨èµ„æºæŸ¥çœ‹
kubectl get pv,pvc,storageclass
kubectl describe pv <pv-name>
kubectl get events --field-selector involvedObject.kind=PersistentVolume

# å­˜å‚¨æ‰©å®¹æ“ä½œ
kubectl patch pvc <pvc-name> -p '{"spec":{"resources":{"requests":{"storage":"50Gi"}}}}'

# å¿«ç…§ç®¡ç†
kubectl get volumesnapshot
kubectl create -f snapshot.yaml

# æ•…éšœæ’æŸ¥
kubectl logs -n kube-system -l app=csi-driver
kubectl get pods -n kube-system | grep csi
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
> PVæä¾›èµ„æºï¼ŒPVCå£°æ˜éœ€æ±‚ï¼ŒSCåŠ¨æ€ä¾›åº”
> RWOå•èŠ‚ç‚¹ï¼ŒRWXå¤šèŠ‚ç‚¹ï¼Œè®¿é—®æ¨¡å¼è¦é€‰å¯¹  
> æœ¬åœ°é«˜æ€§èƒ½ï¼Œç½‘ç»œé«˜å¯ç”¨ï¼Œå­˜å‚¨é€‰å‹çœ‹åœºæ™¯
> å¿«ç…§å‹¤å¤‡ä»½ï¼Œæ‰©å®¹è¦æµ‹è¯•ï¼Œæ•°æ®å®‰å…¨ç¬¬ä¸€ä½

**ğŸ“ å­¦ä¹ æˆæœæ£€éªŒ**
- [ ] èƒ½å¤Ÿç‹¬ç«‹é…ç½®PVã€PVCã€StorageClass
- [ ] ç†è§£ä¸åŒè®¿é—®æ¨¡å¼çš„é€‚ç”¨åœºæ™¯
- [ ] æŒæ¡CSIé©±åŠ¨çš„éƒ¨ç½²å’Œé…ç½®
- [ ] ä¼šè¿›è¡Œå­˜å‚¨æ‰©å®¹å’Œå¿«ç…§æ“ä½œ
- [ ] èƒ½è®¾è®¡å®Œæ•´çš„å¤‡ä»½æ¢å¤æ–¹æ¡ˆ
- [ ] å…·å¤‡å­˜å‚¨æ€§èƒ½è°ƒä¼˜èƒ½åŠ›

é€šè¿‡æŒæ¡è¿™äº›çŸ¥è¯†ç‚¹ï¼Œä½ å°†èƒ½å¤Ÿåœ¨Kubernetesç¯å¢ƒä¸­é«˜æ•ˆç®¡ç†å„ç§å­˜å‚¨éœ€æ±‚ï¼Œä¸ºåº”ç”¨æä¾›å¯é çš„æ•°æ®æŒä¹…åŒ–è§£å†³æ–¹æ¡ˆï¼