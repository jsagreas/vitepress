---
title: 15ã€é›†ç¾¤ç»´æŠ¤ä¸å‡çº§
---
## ğŸ“š ç›®å½•

1. [é›†ç¾¤ç‰ˆæœ¬å‡çº§ç­–ç•¥è§„åˆ’](#1-é›†ç¾¤ç‰ˆæœ¬å‡çº§ç­–ç•¥è§„åˆ’)
2. [æ§åˆ¶å¹³é¢ç»„ä»¶å‡çº§æµç¨‹](#2-æ§åˆ¶å¹³é¢ç»„ä»¶å‡çº§æµç¨‹)
3. [WorkerèŠ‚ç‚¹æ»šåŠ¨å‡çº§](#3-WorkerèŠ‚ç‚¹æ»šåŠ¨å‡çº§)
4. [etcdæ•°æ®å¤‡ä»½ä¸æ¢å¤](#4-etcdæ•°æ®å¤‡ä»½ä¸æ¢å¤)
5. [è¯ä¹¦ç»­æœŸä¸è½®æ¢ç®¡ç†](#5-è¯ä¹¦ç»­æœŸä¸è½®æ¢ç®¡ç†)
6. [é›†ç¾¤é…ç½®å¤‡ä»½ç­–ç•¥](#6-é›†ç¾¤é…ç½®å¤‡ä»½ç­–ç•¥)
7. [èŠ‚ç‚¹ç»´æŠ¤ä¸é©±é€ç®¡ç†](#7-èŠ‚ç‚¹ç»´æŠ¤ä¸é©±é€ç®¡ç†)
8. [ç¾éš¾æ¢å¤é¢„æ¡ˆåˆ¶å®š](#8-ç¾éš¾æ¢å¤é¢„æ¡ˆåˆ¶å®š)
9. [å‡çº§å›æ»šä¸åº”æ€¥å¤„ç†](#9-å‡çº§å›æ»šä¸åº”æ€¥å¤„ç†)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ é›†ç¾¤ç‰ˆæœ¬å‡çº§ç­–ç•¥è§„åˆ’


### 1.1 ç‰ˆæœ¬å‡çº§åŸºæœ¬åŸåˆ™


**ğŸ”¸ Kubernetesç‰ˆæœ¬æ”¯æŒç­–ç•¥**
```
ç‰ˆæœ¬æ”¯æŒå‘¨æœŸï¼š
- æ¯ä¸ªç‰ˆæœ¬æ”¯æŒçº¦14ä¸ªæœˆ
- åŒæ—¶ç»´æŠ¤3ä¸ªç‰ˆæœ¬ï¼šå½“å‰ç‰ˆæœ¬ + 2ä¸ªå†å²ç‰ˆæœ¬
- å»ºè®®ä¿æŒåœ¨æ”¯æŒçš„ç‰ˆæœ¬èŒƒå›´å†…

å‡çº§è·¯å¾„åŸåˆ™ï¼š
- åªèƒ½é€ä¸ªå°ç‰ˆæœ¬å‡çº§ï¼š1.25 â†’ 1.26 â†’ 1.27
- ä¸èƒ½è·¨è¶Šå¤§ç‰ˆæœ¬ï¼šä¸èƒ½ä»1.24ç›´æ¥å‡åˆ°1.27
- æ§åˆ¶å¹³é¢å¿…é¡»å…ˆäºWorkerèŠ‚ç‚¹å‡çº§
```

**ğŸ’¡ å‡çº§å‰é£é™©è¯„ä¼°**

å‡çº§å‰éœ€è¦è€ƒè™‘çš„å…³é”®å› ç´ ï¼š

| è¯„ä¼°é¡¹ç›® | **æ£€æŸ¥è¦ç‚¹** | **é£é™©ç­‰çº§** |
|---------|-------------|-------------|
| **åº”ç”¨å…¼å®¹æ€§** | `APIç‰ˆæœ¬å¼ƒç”¨ã€åŠŸèƒ½å˜æ›´` | ğŸ”´ é«˜ |
| **æ’ä»¶å…¼å®¹æ€§** | `CNIã€CSIã€Ingressæ§åˆ¶å™¨ç‰ˆæœ¬` | ğŸŸ¡ ä¸­ |
| **é›†ç¾¤è§„æ¨¡** | `èŠ‚ç‚¹æ•°é‡ã€Podå¯†åº¦` | ğŸŸ¡ ä¸­ |
| **ä¸šåŠ¡çª—å£** | `ç»´æŠ¤æ—¶é—´ã€ç”¨æˆ·å½±å“` | ğŸ”´ é«˜ |

### 1.2 å‡çº§ç­–ç•¥åˆ¶å®š


**ğŸª ä¸‰ç§ä¸»è¦å‡çº§ç­–ç•¥**

**è“ç»¿éƒ¨ç½²ç­–ç•¥**ï¼š
```
ä¼˜ç‚¹ï¼š
âœ… é£é™©æœ€ä½ï¼Œå¯ä»¥å¿«é€Ÿå›æ»š
âœ… å‡çº§è¿‡ç¨‹ä¸­ä¸šåŠ¡ä¸ä¸­æ–­
âœ… å……åˆ†éªŒè¯åå†åˆ‡æ¢æµé‡

ç¼ºç‚¹ï¼š
âŒ æˆæœ¬æœ€é«˜ï¼Œéœ€è¦åŒå€èµ„æº
âŒ æ•°æ®åŒæ­¥å¤æ‚
âŒ é€‚åˆæœ‰å……è¶³èµ„æºçš„ç¯å¢ƒ

é€‚ç”¨åœºæ™¯ï¼š
ğŸ¯ ç”Ÿäº§ç¯å¢ƒå…³é”®ä¸šåŠ¡
ğŸ¯ æœ‰è¶³å¤Ÿç¡¬ä»¶èµ„æº
ğŸ¯ å¯¹å¯ç”¨æ€§è¦æ±‚æé«˜
```

**æ»šåŠ¨å‡çº§ç­–ç•¥**ï¼š
```
ä¼˜ç‚¹ï¼š
âœ… èµ„æºåˆ©ç”¨ç‡é«˜
âœ… æˆæœ¬ç›¸å¯¹è¾ƒä½
âœ… å®˜æ–¹æ¨èçš„æ ‡å‡†åšæ³•

ç¼ºç‚¹ï¼š
âŒ å‡çº§è¿‡ç¨‹è¾ƒé•¿
âŒ å¯èƒ½å‡ºç°ç‰ˆæœ¬ä¸ä¸€è‡´
âŒ å›æ»šç›¸å¯¹å¤æ‚

é€‚ç”¨åœºæ™¯ï¼š
ğŸ¯ å¤§éƒ¨åˆ†ç”Ÿäº§ç¯å¢ƒ
ğŸ¯ èµ„æºæœ‰é™çš„åœºæ™¯
ğŸ¯ å¯ä»¥å®¹å¿çŸ­æš‚ä¸ä¸€è‡´
```

**åŸåœ°å‡çº§ç­–ç•¥**ï¼š
```
ä¼˜ç‚¹ï¼š
âœ… å‡çº§é€Ÿåº¦æœ€å¿«
âœ… èµ„æºæ¶ˆè€—æœ€å°‘

ç¼ºç‚¹ï¼š
âŒ é£é™©æœ€é«˜
âŒ å›æ»šå›°éš¾
âŒ å¯èƒ½å¯¼è‡´æœåŠ¡ä¸­æ–­

é€‚ç”¨åœºæ™¯ï¼š
ğŸ¯ æµ‹è¯•å¼€å‘ç¯å¢ƒ
ğŸ¯ éå…³é”®ä¸šåŠ¡
ğŸ¯ ç´§æ€¥å®‰å…¨è¡¥ä¸
```

### 1.3 å‡çº§è®¡åˆ’æ¨¡æ¿


**ğŸ“‹ å‡çº§æ‰§è¡Œè®¡åˆ’**

```
é˜¶æ®µä¸€ï¼šå‡çº§å‡†å¤‡ï¼ˆæå‰1-2å‘¨ï¼‰
â–¡ ç¡®è®¤ç›®æ ‡ç‰ˆæœ¬å’Œå˜æ›´è¯´æ˜
â–¡ éªŒè¯åº”ç”¨å’Œæ’ä»¶å…¼å®¹æ€§
â–¡ åˆ›å»ºå®Œæ•´é›†ç¾¤å¤‡ä»½
â–¡ å‡†å¤‡å›æ»šè®¡åˆ’
â–¡ é€šçŸ¥ç›¸å…³å›¢é˜Ÿå’Œç”¨æˆ·

é˜¶æ®µäºŒï¼šæµ‹è¯•ç¯å¢ƒéªŒè¯ï¼ˆæå‰3-5å¤©ï¼‰
â–¡ åœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œå‡çº§
â–¡ éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
â–¡ æ€§èƒ½æµ‹è¯•å’Œå‹åŠ›æµ‹è¯•
â–¡ æ–‡æ¡£åŒ–é‡åˆ°çš„é—®é¢˜

é˜¶æ®µä¸‰ï¼šç”Ÿäº§ç¯å¢ƒå‡çº§
â–¡ ç»´æŠ¤çª—å£å¼€å§‹é€šçŸ¥
â–¡ æ‰§è¡Œetcdå¤‡ä»½
â–¡ å‡çº§æ§åˆ¶å¹³é¢ç»„ä»¶
â–¡ å‡çº§WorkerèŠ‚ç‚¹
â–¡ åŠŸèƒ½éªŒè¯å’Œç›‘æ§æ£€æŸ¥

é˜¶æ®µå››ï¼šå‡çº§åéªŒè¯
â–¡ å…¨é¢åŠŸèƒ½æµ‹è¯•
â–¡ æ€§èƒ½ç›‘æ§æ£€æŸ¥
â–¡ ç”¨æˆ·åé¦ˆæ”¶é›†
â–¡ å‡çº§æŠ¥å‘Šç¼–å†™
```

---

## 2. ğŸ—ï¸ æ§åˆ¶å¹³é¢ç»„ä»¶å‡çº§æµç¨‹


### 2.1 æ§åˆ¶å¹³é¢å‡çº§é¡ºåº


**ğŸ”§ ç»„ä»¶å‡çº§çš„æ­£ç¡®é¡ºåº**

æ§åˆ¶å¹³é¢ç»„ä»¶å¿…é¡»æŒ‰ç…§ç‰¹å®šé¡ºåºå‡çº§ï¼š

```
å‡çº§é¡ºåºï¼š
1. etcdé›†ç¾¤ï¼ˆå¦‚æœéœ€è¦ï¼‰
2. kube-apiserver
3. kube-controller-manager  
4. kube-scheduler
5. é›†ç¾¤æ’ä»¶ï¼ˆkube-proxyã€CNIç­‰ï¼‰

é¡ºåºé‡è¦æ€§ï¼š
â€¢ API Serveræ˜¯å…¶ä»–ç»„ä»¶çš„ä¾èµ–
â€¢ Controller Managerå’ŒSchedulerä¾èµ–API Server
â€¢ æ’ä»¶ç»„ä»¶ä¾èµ–æ ¸å¿ƒç»„ä»¶ç¨³å®šè¿è¡Œ
```

### 2.2 ä½¿ç”¨kubeadmå‡çº§æ§åˆ¶å¹³é¢


**âš™ï¸ kubeadmå‡çº§æ­¥éª¤**

**æ­¥éª¤1ï¼šå‡çº§kubeadmå·¥å…·**
```bash
# æŸ¥çœ‹å½“å‰ç‰ˆæœ¬
kubeadm version
kubectl version

# æ›´æ–°è½¯ä»¶æºï¼ˆUbuntu/Debianï¼‰
sudo apt update
sudo apt-cache madison kubeadm

# å‡çº§kubeadmåˆ°ç›®æ ‡ç‰ˆæœ¬
sudo apt-mark unhold kubeadm
sudo apt install -y kubeadm=1.28.0-00
sudo apt-mark hold kubeadm
```

**æ­¥éª¤2ï¼šéªŒè¯å‡çº§è®¡åˆ’**
```bash
# æ£€æŸ¥å‡çº§è®¡åˆ’
sudo kubeadm upgrade plan

# è¾“å‡ºä¼šæ˜¾ç¤ºï¼š
# - å½“å‰ç‰ˆæœ¬ä¿¡æ¯
# - å¯å‡çº§çš„ç‰ˆæœ¬
# - å„ç»„ä»¶çš„ç‰ˆæœ¬å˜åŒ–
# - å‡çº§æ³¨æ„äº‹é¡¹
```

**æ­¥éª¤3ï¼šæ‰§è¡Œæ§åˆ¶å¹³é¢å‡çº§**
```bash
# å‡çº§ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹
sudo kubeadm upgrade apply v1.28.0

# å‡çº§å…¶ä»–æ§åˆ¶å¹³é¢èŠ‚ç‚¹
sudo kubeadm upgrade node
```

### 2.3 æ‰‹åŠ¨å‡çº§æ§åˆ¶å¹³é¢ç»„ä»¶


**ğŸ”§ æ‰‹åŠ¨å‡çº§çš„è¯¦ç»†è¿‡ç¨‹**

å¯¹äºä¸ä½¿ç”¨kubeadmçš„é›†ç¾¤ï¼Œéœ€è¦æ‰‹åŠ¨å‡çº§å„ä¸ªç»„ä»¶ï¼š

**API Serverå‡çº§**ï¼š
```bash
# å¤‡ä»½å½“å‰é…ç½®
sudo cp /etc/kubernetes/manifests/kube-apiserver.yaml \
    /etc/kubernetes/kube-apiserver.yaml.backup

# æ›´æ–°é•œåƒç‰ˆæœ¬
sudo sed -i 's/v1.27.0/v1.28.0/g' \
    /etc/kubernetes/manifests/kube-apiserver.yaml

# ç­‰å¾…Podé‡æ–°å¯åŠ¨
kubectl get pods -n kube-system | grep apiserver
```

**Controller Managerå’ŒSchedulerå‡çº§**ï¼š
```bash
# ç±»ä¼¼åœ°æ›´æ–°å…¶ä»–ç»„ä»¶
sudo sed -i 's/v1.27.0/v1.28.0/g' \
    /etc/kubernetes/manifests/kube-controller-manager.yaml
    
sudo sed -i 's/v1.27.0/v1.28.0/g' \
    /etc/kubernetes/manifests/kube-scheduler.yaml
```

### 2.4 å‡çº§è¿‡ç¨‹ç›‘æ§


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**

å‡çº§è¿‡ç¨‹ä¸­éœ€è¦å¯†åˆ‡ç›‘æ§ï¼š

| ç›‘æ§é¡¹ç›® | **æ£€æŸ¥å‘½ä»¤** | **æ­£å¸¸çŠ¶æ€** |
|---------|-------------|-------------|
| **PodçŠ¶æ€** | `kubectl get pods -n kube-system` | `Running` |
| **èŠ‚ç‚¹çŠ¶æ€** | `kubectl get nodes` | `Ready` |
| **ç»„ä»¶å¥åº·** | `kubectl get componentstatuses` | `Healthy` |
| **APIå“åº”** | `kubectl cluster-info` | `æ­£å¸¸å“åº”` |

**å®æ—¶ç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# upgrade-monitor.sh
while true; do
    clear
    echo "=== Kuberneteså‡çº§ç›‘æ§ ==="
    echo "æ—¶é—´: $(date)"
    echo
    
    echo "æ§åˆ¶å¹³é¢PodsçŠ¶æ€:"
    kubectl get pods -n kube-system | grep -E "(apiserver|controller|scheduler|etcd)"
    
    echo -e "\nèŠ‚ç‚¹çŠ¶æ€:"
    kubectl get nodes
    
    echo -e "\nç­‰å¾…5ç§’ååˆ·æ–°..."
    sleep 5
done
```

---

## 3. ğŸ”„ WorkerèŠ‚ç‚¹æ»šåŠ¨å‡çº§


### 3.1 WorkerèŠ‚ç‚¹å‡çº§ç­–ç•¥


**ğŸ¯ èŠ‚ç‚¹å‡çº§çš„æ ¸å¿ƒæ€è·¯**

WorkerèŠ‚ç‚¹å‡çº§éµå¾ª"é©±é€â†’å‡çº§â†’æ¢å¤"çš„æµç¨‹ï¼š

```
å‡çº§æµç¨‹ï¼š
1. æ ‡è®°èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦ï¼ˆcordonï¼‰
2. é©±é€èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰Podï¼ˆdrainï¼‰
3. å‡çº§èŠ‚ç‚¹ä¸Šçš„Kubernetesç»„ä»¶
4. é‡æ–°å¯åŠ¨kubeletå’Œkube-proxy
5. æ¢å¤èŠ‚ç‚¹è°ƒåº¦ï¼ˆuncordonï¼‰
6. éªŒè¯èŠ‚ç‚¹å’ŒPodçŠ¶æ€
```

### 3.2 èŠ‚ç‚¹é©±é€æ“ä½œè¯¦è§£


**âš ï¸ å®‰å…¨é©±é€Podçš„æ–¹æ³•**

**åŸºæœ¬é©±é€å‘½ä»¤**ï¼š
```bash
# æ ‡è®°èŠ‚ç‚¹ä¸å¯è°ƒåº¦
kubectl cordon node01

# å®‰å…¨é©±é€Podï¼ˆæ¨èï¼‰
kubectl drain node01 \
    --ignore-daemonsets \
    --delete-emptydir-data \
    --force \
    --grace-period=300
```

**é©±é€å‚æ•°è¯¦è§£**ï¼š

| å‚æ•° | **ä½œç”¨** | **ä½¿ç”¨åœºæ™¯** |
|------|---------|-------------|
| `--ignore-daemonsets` | `å¿½ç•¥DaemonSet Pod` | `å¿…éœ€ï¼Œå› ä¸ºDaemonSetä¼šé‡å»º` |
| `--delete-emptydir-data` | `åˆ é™¤emptyDiræ•°æ®` | `æ¥å—ä¸´æ—¶æ•°æ®ä¸¢å¤±` |
| `--force` | `å¼ºåˆ¶é©±é€æŸäº›Pod` | `å¤„ç†ä¸å—æ§åˆ¶çš„Pod` |
| `--grace-period=300` | `ç­‰å¾…Podä¼˜é›…ç»ˆæ­¢` | `ç»™åº”ç”¨å……åˆ†æ—¶é—´ä¿å­˜çŠ¶æ€` |

**ç‰¹æ®Šæƒ…å†µå¤„ç†**ï¼š
```bash
# å¦‚æœæœ‰æœ¬åœ°å­˜å‚¨çš„Podéœ€è¦ç‰¹æ®Šå¤„ç†
kubectl drain node01 \
    --ignore-daemonsets \
    --delete-local-data \
    --force

# å¦‚æœé‡åˆ°PDBé˜»æ­¢é©±é€
kubectl get pdb
kubectl drain node01 --disable-eviction
```

### 3.3 å‡çº§kubeletå’Œkube-proxy


**ğŸ”§ ç»„ä»¶å‡çº§å…·ä½“æ­¥éª¤**

**æ­¥éª¤1ï¼šå‡çº§è½¯ä»¶åŒ…**
```bash
# è¿æ¥åˆ°ç›®æ ‡èŠ‚ç‚¹
ssh user@node01

# å‡çº§kubeletå’Œkubectl
sudo apt-mark unhold kubelet kubectl
sudo apt install -y kubelet=1.28.0-00 kubectl=1.28.0-00
sudo apt-mark hold kubelet kubectl
```

**æ­¥éª¤2ï¼šé‡å¯æœåŠ¡**
```bash
# é‡æ–°åŠ è½½systemdé…ç½®
sudo systemctl daemon-reload

# é‡å¯kubelet
sudo systemctl restart kubelet

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status kubelet
```

**æ­¥éª¤3ï¼šéªŒè¯å‡çº§ç»“æœ**
```bash
# æ£€æŸ¥kubeletç‰ˆæœ¬
kubelet --version

# æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
kubectl get node node01 -o wide

# æ£€æŸ¥èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
kubectl describe node node01
```

### 3.4 æ‰¹é‡èŠ‚ç‚¹å‡çº§è‡ªåŠ¨åŒ–


**ğŸ¤– å‡çº§è‡ªåŠ¨åŒ–è„šæœ¬ç¤ºä¾‹**

```bash
#!/bin/bash
# worker-upgrade.sh
NODES=$(kubectl get nodes --no-headers | grep -v master | awk '{print $1}')
TARGET_VERSION="1.28.0-00"

for NODE in $NODES; do
    echo "å¼€å§‹å‡çº§èŠ‚ç‚¹: $NODE"
    
    # é©±é€èŠ‚ç‚¹
    echo "é©±é€èŠ‚ç‚¹ $NODE..."
    kubectl cordon $NODE
    kubectl drain $NODE --ignore-daemonsets --delete-emptydir-data --force
    
    # å‡çº§èŠ‚ç‚¹
    echo "å‡çº§èŠ‚ç‚¹ $NODE çš„ç»„ä»¶..."
    ssh $NODE << EOF
        sudo apt-mark unhold kubelet kubectl
        sudo apt install -y kubelet=$TARGET_VERSION kubectl=$TARGET_VERSION
        sudo apt-mark hold kubelet kubectl
        sudo systemctl daemon-reload
        sudo systemctl restart kubelet
EOF
    
    # æ¢å¤è°ƒåº¦
    echo "æ¢å¤èŠ‚ç‚¹ $NODE è°ƒåº¦..."
    kubectl uncordon $NODE
    
    # ç­‰å¾…èŠ‚ç‚¹å°±ç»ª
    echo "ç­‰å¾…èŠ‚ç‚¹ $NODE å°±ç»ª..."
    kubectl wait --for=condition=Ready node/$NODE --timeout=300s
    
    echo "èŠ‚ç‚¹ $NODE å‡çº§å®Œæˆ"
    echo "----------------------------------------"
done
```

---

## 4. ğŸ’¾ etcdæ•°æ®å¤‡ä»½ä¸æ¢å¤


### 4.1 etcdå¤‡ä»½é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆetcdå¤‡ä»½è‡³å…³é‡è¦**

```
etcdå­˜å‚¨çš„å…³é”®æ•°æ®ï¼š
- æ‰€æœ‰Kuberneteså¯¹è±¡å®šä¹‰
- é›†ç¾¤é…ç½®ä¿¡æ¯  
- Secretå’ŒConfigMapæ•°æ®
- ç½‘ç»œå’Œå­˜å‚¨é…ç½®
- RBACæƒé™è®¾ç½®

æ•°æ®ä¸¢å¤±çš„åæœï¼š
âŒ é›†ç¾¤å®Œå…¨ä¸å¯ç”¨
âŒ æ‰€æœ‰å·¥ä½œè´Ÿè½½ä¿¡æ¯ä¸¢å¤±
âŒ éœ€è¦é‡æ–°éƒ¨ç½²æ•´ä¸ªé›†ç¾¤
âŒ ä¸šåŠ¡æ•°æ®å¯èƒ½æ— æ³•æ¢å¤
```

### 4.2 etcdå¤‡ä»½æ“ä½œ


**ğŸ“¦ ä½¿ç”¨etcdctlå¤‡ä»½**

**å‡†å¤‡å·¥ä½œ**ï¼š
```bash
# å®‰è£…etcdå®¢æˆ·ç«¯
sudo apt install etcd-client

# æˆ–è€…ä»etcd Podä¸­è·å–etcdctl
kubectl cp etcd-pod:/usr/local/bin/etcdctl /usr/local/bin/etcdctl
```

**æ‰§è¡Œå¤‡ä»½**ï¼š
```bash
# è®¾ç½®etcdè¿æ¥å‚æ•°
ETCDCTL_API=3
ETCD_ENDPOINTS="https://127.0.0.1:2379"
ETCD_CACERT="/etc/kubernetes/pki/etcd/ca.crt"
ETCD_CERT="/etc/kubernetes/pki/etcd/peer.crt"
ETCD_KEY="/etc/kubernetes/pki/etcd/peer.key"

# åˆ›å»ºå¤‡ä»½
sudo etcdctl --endpoints=$ETCD_ENDPOINTS \
    --cacert=$ETCD_CACERT \
    --cert=$ETCD_CERT \
    --key=$ETCD_KEY \
    snapshot save /backup/etcd-$(date +%Y%m%d-%H%M%S).db

# éªŒè¯å¤‡ä»½
sudo etcdctl --write-out=table snapshot status /backup/etcd-*.db
```

### 4.3 è‡ªåŠ¨åŒ–å¤‡ä»½ç­–ç•¥


**â° å®šæœŸå¤‡ä»½è„šæœ¬**

```bash
#!/bin/bash
# etcd-backup.sh
BACKUP_DIR="/backup/etcd"
BACKUP_RETENTION_DAYS=30

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# è®¾ç½®å¤‡ä»½æ–‡ä»¶å
BACKUP_FILE="$BACKUP_DIR/etcd-backup-$(date +%Y%m%d-%H%M%S).db"

# æ‰§è¡Œå¤‡ä»½
ETCDCTL_API=3 etcdctl \
    --endpoints=https://127.0.0.1:2379 \
    --cacert=/etc/kubernetes/pki/etcd/ca.crt \
    --cert=/etc/kubernetes/pki/etcd/peer.crt \
    --key=/etc/kubernetes/pki/etcd/peer.key \
    snapshot save $BACKUP_FILE

# éªŒè¯å¤‡ä»½æ–‡ä»¶
if [ -f "$BACKUP_FILE" ]; then
    echo "å¤‡ä»½æˆåŠŸ: $BACKUP_FILE"
    ls -lh $BACKUP_FILE
else
    echo "å¤‡ä»½å¤±è´¥!"
    exit 1
fi

# æ¸…ç†æ—§å¤‡ä»½
find $BACKUP_DIR -name "etcd-backup-*.db" -mtime +$BACKUP_RETENTION_DAYS -delete

# å‘é€å¤‡ä»½çŠ¶æ€é€šçŸ¥
echo "etcdå¤‡ä»½å®Œæˆ: $(date)" | mail -s "Kubernetes etcdå¤‡ä»½" admin@company.com
```

**æ·»åŠ åˆ°crontab**ï¼š
```bash
# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå¤‡ä»½
0 2 * * * /opt/scripts/etcd-backup.sh
```

### 4.4 etcdæ¢å¤æ“ä½œ


**ğŸ”„ æ•°æ®æ¢å¤æµç¨‹**

**ç´§æ€¥æ¢å¤æ­¥éª¤**ï¼š
```bash
# åœæ­¢etcdæœåŠ¡
sudo systemctl stop etcd

# æ¸…ç†ç°æœ‰æ•°æ®ç›®å½•
sudo rm -rf /var/lib/etcd

# ä»å¤‡ä»½æ¢å¤
sudo etcdctl snapshot restore /backup/etcd-backup-20240915-020000.db \
    --data-dir /var/lib/etcd

# ä¿®å¤æƒé™
sudo chown -R etcd:etcd /var/lib/etcd

# é‡å¯etcd
sudo systemctl start etcd
```

**é›†ç¾¤æ¢å¤éªŒè¯**ï¼š
```bash
# æ£€æŸ¥etcdé›†ç¾¤çŠ¶æ€
kubectl get nodes
kubectl get pods --all-namespaces

# éªŒè¯å…³é”®èµ„æº
kubectl get deployments --all-namespaces
kubectl get services --all-namespaces
```

---

## 5. ğŸ” è¯ä¹¦ç»­æœŸä¸è½®æ¢ç®¡ç†


### 5.1 Kubernetesè¯ä¹¦ä½“ç³»


**ğŸ”¸ è¯ä¹¦ç±»å‹å’Œæœ‰æ•ˆæœŸ**

Kubernetesé›†ç¾¤ä¸­çš„å…³é”®è¯ä¹¦ï¼š

| è¯ä¹¦ç±»å‹ | **ç”¨é€”** | **é»˜è®¤æœ‰æ•ˆæœŸ** | **å½±å“èŒƒå›´** |
|---------|---------|---------------|-------------|
| **CAæ ¹è¯ä¹¦** | `ç­¾å‘å…¶ä»–è¯ä¹¦` | `10å¹´` | `æ•´ä¸ªé›†ç¾¤` |
| **API Serverè¯ä¹¦** | `HTTPSé€šä¿¡` | `1å¹´` | `å®¢æˆ·ç«¯è¿æ¥` |
| **kubeletè¯ä¹¦** | `èŠ‚ç‚¹èº«ä»½è®¤è¯` | `1å¹´` | `èŠ‚ç‚¹é€šä¿¡` |
| **etcdè¯ä¹¦** | `etcdé›†ç¾¤é€šä¿¡` | `1å¹´` | `æ•°æ®å­˜å‚¨` |
| **Service Account** | `Podèº«ä»½è®¤è¯` | `1å¹´` | `åº”ç”¨æœåŠ¡` |

### 5.2 è¯ä¹¦çŠ¶æ€æ£€æŸ¥


**ğŸ” è¯ä¹¦åˆ°æœŸæ—¶é—´æ£€æŸ¥**

**æ£€æŸ¥æ‰€æœ‰è¯ä¹¦**ï¼š
```bash
# ä½¿ç”¨kubeadmæ£€æŸ¥è¯ä¹¦çŠ¶æ€
sudo kubeadm certs check-expiration

# è¾“å‡ºç¤ºä¾‹ï¼š
# CERTIFICATE                EXPIRES                  RESIDUAL TIME
# admin.conf                 Sep 15, 2025 02:00 UTC   364d
# apiserver                  Sep 15, 2025 02:00 UTC   364d
# apiserver-etcd-client      Sep 15, 2025 02:00 UTC   364d
# apiserver-kubelet-client   Sep 15, 2025 02:00 UTC   364d
```

**æ‰‹åŠ¨æ£€æŸ¥ç‰¹å®šè¯ä¹¦**ï¼š
```bash
# æ£€æŸ¥API Serverè¯ä¹¦
openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout | grep "Not After"

# æ£€æŸ¥kubeletè¯ä¹¦
openssl x509 -in /var/lib/kubelet/pki/kubelet.crt -text -noout | grep "Not After"
```

### 5.3 è¯ä¹¦ç»­æœŸæ“ä½œ


**ğŸ”„ ä½¿ç”¨kubeadmç»­æœŸè¯ä¹¦**

**ç»­æœŸæ‰€æœ‰è¯ä¹¦**ï¼š
```bash
# å¤‡ä»½ç°æœ‰è¯ä¹¦
sudo cp -r /etc/kubernetes/pki /etc/kubernetes/pki.backup

# ç»­æœŸæ‰€æœ‰è¯ä¹¦
sudo kubeadm certs renew all

# é‡å¯æ§åˆ¶å¹³é¢ç»„ä»¶
sudo systemctl restart kubelet
```

**å•ç‹¬ç»­æœŸç‰¹å®šè¯ä¹¦**ï¼š
```bash
# ç»­æœŸAPI Serverè¯ä¹¦
sudo kubeadm certs renew apiserver

# ç»­æœŸAdminå®¢æˆ·ç«¯è¯ä¹¦
sudo kubeadm certs renew admin.conf

# ç»­æœŸkubeletè¯ä¹¦
sudo kubeadm certs renew apiserver-kubelet-client
```

### 5.4 è¯ä¹¦è½®æ¢ç›‘æ§


**ğŸ“Š è‡ªåŠ¨åŒ–è¯ä¹¦ç›‘æ§**

```bash
#!/bin/bash
# cert-monitor.sh
ALERT_DAYS=30

check_cert_expiry() {
    local cert_file=$1
    local cert_name=$2
    
    if [[ -f "$cert_file" ]]; then
        expiry_date=$(openssl x509 -in "$cert_file" -text -noout | grep "Not After" | cut -d: -f2-)
        expiry_epoch=$(date -d "$expiry_date" +%s)
        current_epoch=$(date +%s)
        days_left=$(( ($expiry_epoch - $current_epoch) / 86400 ))
        
        echo "$cert_name: $days_left å¤©ååˆ°æœŸ"
        
        if [[ $days_left -lt $ALERT_DAYS ]]; then
            echo "âš ï¸ è­¦å‘Š: $cert_name å°†åœ¨ $days_left å¤©ååˆ°æœŸ!"
            # å‘é€å‘Šè­¦
            echo "$cert_name certificate expires in $days_left days" | \
                mail -s "Certificate Expiry Alert" admin@company.com
        fi
    fi
}

# æ£€æŸ¥ä¸»è¦è¯ä¹¦
check_cert_expiry "/etc/kubernetes/pki/ca.crt" "CAè¯ä¹¦"
check_cert_expiry "/etc/kubernetes/pki/apiserver.crt" "API Serverè¯ä¹¦"  
check_cert_expiry "/etc/kubernetes/pki/etcd/ca.crt" "etcd CAè¯ä¹¦"
```

---

## 6. ğŸ“ é›†ç¾¤é…ç½®å¤‡ä»½ç­–ç•¥


### 6.1 é…ç½®å¤‡ä»½èŒƒå›´


**ğŸ”¸ éœ€è¦å¤‡ä»½çš„é…ç½®ç±»å‹**

```
æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼š
/etc/kubernetes/           # Kubernetesé…ç½®ç›®å½•
â”œâ”€â”€ manifests/            # é™æ€Podé…ç½®
â”œâ”€â”€ pki/                  # è¯ä¹¦æ–‡ä»¶
â”œâ”€â”€ admin.conf            # ç®¡ç†å‘˜é…ç½®
â”œâ”€â”€ kubelet.conf          # kubeleté…ç½®
â””â”€â”€ controller-manager.conf # æ§åˆ¶å™¨é…ç½®

ç³»ç»Ÿé…ç½®ï¼š
/var/lib/kubelet/config.yaml  # kubeletè¿è¡Œæ—¶é…ç½®
/etc/systemd/system/kubelet.service.d/  # systemdé…ç½®
/etc/cni/net.d/              # ç½‘ç»œæ’ä»¶é…ç½®

åº”ç”¨é…ç½®ï¼š
kubectl get all --all-namespaces -o yaml  # æ‰€æœ‰Kuberneteså¯¹è±¡
```

### 6.2 é…ç½®å¤‡ä»½è„šæœ¬


**ğŸ’¾ å…¨é¢é…ç½®å¤‡ä»½**

```bash
#!/bin/bash
# k8s-config-backup.sh
BACKUP_BASE="/backup/k8s-config"
DATE=$(date +%Y%m%d-%H%M%S)
BACKUP_DIR="$BACKUP_BASE/$DATE"

mkdir -p $BACKUP_DIR

echo "å¼€å§‹Kubernetesé…ç½®å¤‡ä»½..."

# å¤‡ä»½é…ç½®æ–‡ä»¶
echo "å¤‡ä»½é…ç½®æ–‡ä»¶..."
sudo tar -czf $BACKUP_DIR/kubernetes-config.tar.gz /etc/kubernetes/
sudo tar -czf $BACKUP_DIR/kubelet-config.tar.gz /var/lib/kubelet/config.yaml

# å¤‡ä»½æ‰€æœ‰Kuberneteså¯¹è±¡
echo "å¤‡ä»½é›†ç¾¤å¯¹è±¡..."
kubectl get all --all-namespaces -o yaml > $BACKUP_DIR/all-objects.yaml
kubectl get pv -o yaml > $BACKUP_DIR/persistent-volumes.yaml
kubectl get storageclass -o yaml > $BACKUP_DIR/storage-classes.yaml

# å¤‡ä»½RBACé…ç½®
echo "å¤‡ä»½RBACé…ç½®..."
kubectl get clusterroles -o yaml > $BACKUP_DIR/cluster-roles.yaml
kubectl get clusterrolebindings -o yaml > $BACKUP_DIR/cluster-role-bindings.yaml
kubectl get roles --all-namespaces -o yaml > $BACKUP_DIR/roles.yaml

# å¤‡ä»½ç½‘ç»œé…ç½®
echo "å¤‡ä»½ç½‘ç»œé…ç½®..."
kubectl get networkpolicies --all-namespaces -o yaml > $BACKUP_DIR/network-policies.yaml

# åˆ›å»ºå¤‡ä»½æ¸…å•
echo "åˆ›å»ºå¤‡ä»½æ¸…å•..."
cat > $BACKUP_DIR/backup-info.txt << EOF
å¤‡ä»½æ—¶é—´: $(date)
é›†ç¾¤ç‰ˆæœ¬: $(kubectl version --short)
èŠ‚ç‚¹ä¿¡æ¯:
$(kubectl get nodes -o wide)

å¤‡ä»½å†…å®¹:
- Kubernetesé…ç½®æ–‡ä»¶
- æ‰€æœ‰é›†ç¾¤å¯¹è±¡
- RBACé…ç½®
- ç½‘ç»œç­–ç•¥
- å­˜å‚¨é…ç½®
EOF

echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
ls -lh $BACKUP_DIR/
```

### 6.3 é…ç½®æ¢å¤æµç¨‹


**ğŸ”„ é…ç½®æ¢å¤æ­¥éª¤**

```bash
#!/bin/bash
# k8s-config-restore.sh
BACKUP_DIR="/backup/k8s-config/20240915-020000"

if [[ ! -d "$BACKUP_DIR" ]]; then
    echo "é”™è¯¯: å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $BACKUP_DIR"
    exit 1
fi

echo "å¼€å§‹æ¢å¤Kubernetesé…ç½®..."

# æ¢å¤é…ç½®æ–‡ä»¶
echo "æ¢å¤é…ç½®æ–‡ä»¶..."
sudo tar -xzf $BACKUP_DIR/kubernetes-config.tar.gz -C /
sudo tar -xzf $BACKUP_DIR/kubelet-config.tar.gz -C /

# é‡å¯æœåŠ¡
echo "é‡å¯KubernetesæœåŠ¡..."
sudo systemctl daemon-reload
sudo systemctl restart kubelet

# ç­‰å¾…é›†ç¾¤å¯ç”¨
echo "ç­‰å¾…é›†ç¾¤å°±ç»ª..."
sleep 30

# æ¢å¤é›†ç¾¤å¯¹è±¡
echo "æ¢å¤é›†ç¾¤å¯¹è±¡..."
kubectl apply -f $BACKUP_DIR/all-objects.yaml
kubectl apply -f $BACKUP_DIR/persistent-volumes.yaml
kubectl apply -f $BACKUP_DIR/storage-classes.yaml

echo "é…ç½®æ¢å¤å®Œæˆ"
```

---

## 7. ğŸ”§ èŠ‚ç‚¹ç»´æŠ¤ä¸é©±é€ç®¡ç†


### 7.1 è®¡åˆ’æ€§èŠ‚ç‚¹ç»´æŠ¤


**ğŸ¯ ç»´æŠ¤å‰çš„å‡†å¤‡å·¥ä½œ**

```
ç»´æŠ¤å‰æ£€æŸ¥æ¸…å•ï¼š
â–¡ ç¡®è®¤èŠ‚ç‚¹ä¸Šè¿è¡Œçš„å…³é”®æœåŠ¡
â–¡ æ£€æŸ¥Podçš„å‰¯æœ¬æ•°å’Œåäº²å’Œæ€§è®¾ç½®
â–¡ éªŒè¯PodDisruptionBudgeté…ç½®
â–¡ ç¡®ä¿å…¶ä»–èŠ‚ç‚¹æœ‰è¶³å¤Ÿå®¹é‡
â–¡ å‡†å¤‡ç»´æŠ¤æ—¶é—´çª—å£
â–¡ é€šçŸ¥ç›¸å…³å›¢é˜Ÿ
```

**æŸ¥çœ‹èŠ‚ç‚¹è´Ÿè½½åˆ†å¸ƒ**ï¼š
```bash
# æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µ
kubectl top nodes

# æŸ¥çœ‹èŠ‚ç‚¹ä¸Šçš„Podåˆ†å¸ƒ
kubectl get pods --all-namespaces -o wide | grep node01

# æ£€æŸ¥å…³é”®åº”ç”¨çš„å‰¯æœ¬åˆ†å¸ƒ
kubectl get deployment nginx -o wide
kubectl get pods -l app=nginx -o wide
```

### 7.2 ä¼˜é›…é©±é€ç­–ç•¥


**âš™ï¸ ä¸åŒåœºæ™¯çš„é©±é€æ–¹æ³•**

**æ ‡å‡†é©±é€æµç¨‹**ï¼š
```bash
# 1. æ ‡è®°èŠ‚ç‚¹ä¸å¯è°ƒåº¦
kubectl cordon node01

# 2. æ£€æŸ¥PodDisruptionBudget
kubectl get pdb --all-namespaces

# 3. ä¼˜é›…é©±é€
kubectl drain node01 \
    --ignore-daemonsets \
    --delete-emptydir-data \
    --grace-period=300 \
    --timeout=600s
```

**å¤„ç†ç‰¹æ®ŠPodç±»å‹**ï¼š

| Podç±»å‹ | **é©±é€æ–¹æ³•** | **æ³¨æ„äº‹é¡¹** |
|---------|-------------|-------------|
| **StatefulSet** | `--force` | `å¯èƒ½éœ€è¦æ‰‹åŠ¨å¤„ç†PV` |
| **DaemonSet** | `--ignore-daemonsets` | `ä¼šåœ¨å…¶ä»–èŠ‚ç‚¹é‡å»º` |
| **æœ¬åœ°å­˜å‚¨Pod** | `--delete-local-data` | `æ•°æ®ä¼šä¸¢å¤±` |
| **ä¸å—æ§åˆ¶Pod** | `--force` | `éœ€è¦æ‰‹åŠ¨é‡å»º` |

### 7.3 PodDisruptionBudgeté…ç½®


**ğŸ›¡ï¸ ä¿æŠ¤å…³é”®åº”ç”¨ä¸è¢«è¯¯åˆ **

**PDBé…ç½®ç¤ºä¾‹**ï¼š
```yaml
# nginx-pdb.yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: nginx-pdb
spec:
  minAvailable: 2  # è‡³å°‘ä¿æŒ2ä¸ªPodè¿è¡Œ
  selector:
    matchLabels:
      app: nginx
---
# æˆ–è€…ä½¿ç”¨ç™¾åˆ†æ¯”
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: web-app-pdb
spec:
  maxUnavailable: "25%"  # æœ€å¤š25%çš„Podä¸å¯ç”¨
  selector:
    matchLabels:
      app: web-app
```

### 7.4 èŠ‚ç‚¹ç»´æŠ¤è‡ªåŠ¨åŒ–


**ğŸ¤– ç»´æŠ¤ä»»åŠ¡è‡ªåŠ¨åŒ–è„šæœ¬**

```bash
#!/bin/bash
# node-maintenance.sh
NODE_NAME=$1
MAINTENANCE_TYPE=$2

if [[ -z "$NODE_NAME" || -z "$MAINTENANCE_TYPE" ]]; then
    echo "ç”¨æ³•: $0 <èŠ‚ç‚¹å> <ç»´æŠ¤ç±»å‹:update|reboot|hardware>"
    exit 1
fi

echo "å¼€å§‹èŠ‚ç‚¹ç»´æŠ¤: $NODE_NAME (ç±»å‹: $MAINTENANCE_TYPE)"

# é¢„æ£€æŸ¥
echo "æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€..."
kubectl get node $NODE_NAME
if [[ $? -ne 0 ]]; then
    echo "é”™è¯¯: èŠ‚ç‚¹ä¸å­˜åœ¨"
    exit 1
fi

# é©±é€Pod
echo "é©±é€èŠ‚ç‚¹ä¸Šçš„Pod..."
kubectl cordon $NODE_NAME
kubectl drain $NODE_NAME --ignore-daemonsets --delete-emptydir-data --force --grace-period=300

# æ‰§è¡Œç»´æŠ¤æ“ä½œ
case $MAINTENANCE_TYPE in
    "update")
        echo "æ‰§è¡Œç³»ç»Ÿæ›´æ–°..."
        ssh $NODE_NAME "sudo apt update && sudo apt upgrade -y"
        ;;
    "reboot")
        echo "é‡å¯èŠ‚ç‚¹..."
        ssh $NODE_NAME "sudo reboot"
        sleep 180  # ç­‰å¾…é‡å¯å®Œæˆ
        ;;
    "hardware")
        echo "ç¡¬ä»¶ç»´æŠ¤æ¨¡å¼ï¼ŒèŠ‚ç‚¹å°†ä¿æŒcordonedçŠ¶æ€"
        echo "ç»´æŠ¤å®Œæˆåè¯·æ‰‹åŠ¨æ‰§è¡Œ: kubectl uncordon $NODE_NAME"
        exit 0
        ;;
esac

# ç­‰å¾…èŠ‚ç‚¹é‡æ–°å°±ç»ª
echo "ç­‰å¾…èŠ‚ç‚¹é‡æ–°å°±ç»ª..."
kubectl wait --for=condition=Ready node/$NODE_NAME --timeout=600s

# æ¢å¤è°ƒåº¦
echo "æ¢å¤èŠ‚ç‚¹è°ƒåº¦..."
kubectl uncordon $NODE_NAME

echo "èŠ‚ç‚¹ç»´æŠ¤å®Œæˆ: $NODE_NAME"
```

---

## 8. ğŸš¨ ç¾éš¾æ¢å¤é¢„æ¡ˆåˆ¶å®š


### 8.1 ç¾éš¾åœºæ™¯åˆ†ç±»


**ğŸ”¸ å¸¸è§ç¾éš¾åœºæ™¯**

```
ç¡¬ä»¶æ•…éšœï¼š
- ä¸»èŠ‚ç‚¹ç¡¬ç›˜æŸå
- ç½‘ç»œè®¾å¤‡æ•…éšœ
- æœºæˆ¿æ–­ç”µæˆ–ç«ç¾

è½¯ä»¶æ•…éšœï¼š
- etcdæ•°æ®æŸå
- æ§åˆ¶å¹³é¢ç»„ä»¶å¤±æ•ˆ
- ç½‘ç»œæ’ä»¶æ•…éšœ

äººä¸ºé”™è¯¯ï¼š
- è¯¯åˆ å…³é”®èµ„æº
- é”™è¯¯çš„é…ç½®å˜æ›´
- è¯ä¹¦è¿‡æœŸæœªç»­æœŸ

å¤–éƒ¨ä¾èµ–ï¼š
- DNSæœåŠ¡æ•…éšœ
- å­˜å‚¨ç³»ç»Ÿæ•…éšœ
- è´Ÿè½½å‡è¡¡å™¨æ•…éšœ
```

### 8.2 ç¾éš¾æ¢å¤ç­‰çº§å®šä¹‰


**ğŸ¯ æ¢å¤æ—¶é—´ç›®æ ‡(RTO)å’Œæ¢å¤ç‚¹ç›®æ ‡(RPO)**

| ç¾éš¾ç­‰çº§ | **RTO** | **RPO** | **æ¢å¤ç­–ç•¥** |
|---------|---------|---------|-------------|
| **è½»å¾®** | `< 30åˆ†é’Ÿ` | `< 15åˆ†é’Ÿ` | `è‡ªåŠ¨æ•…éšœè½¬ç§»` |
| **ä¸­ç­‰** | `< 2å°æ—¶` | `< 1å°æ—¶` | `å¤‡ä»½æ¢å¤ + æ‰‹åŠ¨å¹²é¢„` |
| **ä¸¥é‡** | `< 8å°æ—¶` | `< 4å°æ—¶` | `å®Œå…¨é‡å»ºé›†ç¾¤` |
| **ç¾éš¾æ€§** | `< 24å°æ—¶` | `< 12å°æ—¶` | `å¼‚åœ°æ¢å¤` |

### 8.3 å®Œæ•´æ¢å¤æµç¨‹


**ğŸ“‹ é›†ç¾¤å®Œå…¨é‡å»ºæµç¨‹**

**é˜¶æ®µ1ï¼šè¯„ä¼°å’Œå‡†å¤‡**
```bash
# è¯„ä¼°æŸåç¨‹åº¦
kubectl cluster-info
kubectl get nodes
kubectl get pods --all-namespaces

# å¦‚æœæ§åˆ¶å¹³é¢å®Œå…¨ä¸å¯ç”¨ï¼Œå‡†å¤‡é‡å»º
```

**é˜¶æ®µ2ï¼šæ¢å¤etcdæ•°æ®**
```bash
# åœæ­¢æ‰€æœ‰KubernetesæœåŠ¡
sudo systemctl stop kubelet
sudo systemctl stop docker

# æ¸…ç†æ—§æ•°æ®
sudo rm -rf /var/lib/etcd
sudo rm -rf /etc/kubernetes

# ä»å¤‡ä»½æ¢å¤etcd
sudo etcdctl snapshot restore /backup/etcd-latest.db \
    --data-dir /var/lib/etcd-restore

# é‡æ–°åˆå§‹åŒ–é›†ç¾¤
sudo kubeadm init --ignore-preflight-errors=DirAvailable--var-lib-etcd
```

**é˜¶æ®µ3ï¼šæ¢å¤é›†ç¾¤é…ç½®**
```bash
# æ¢å¤é…ç½®æ–‡ä»¶
sudo tar -xzf /backup/kubernetes-config-latest.tar.gz -C /

# æ¢å¤è¯ä¹¦
sudo tar -xzf /backup/kubernetes-pki-latest.tar.gz -C /

# é‡å¯æœåŠ¡
sudo systemctl start kubelet
```

**é˜¶æ®µ4ï¼šæ¢å¤å·¥ä½œè´Ÿè½½**
```bash
# æ¢å¤æ‰€æœ‰Kuberneteså¯¹è±¡
kubectl apply -f /backup/all-objects-latest.yaml

# éªŒè¯å…³é”®æœåŠ¡
kubectl get deployments --all-namespaces
kubectl get services --all-namespaces
```

### 8.4 ç¾éš¾æ¢å¤æ¼”ç»ƒ


**ğŸ­ å®šæœŸæ¼”ç»ƒè®¡åˆ’**

```bash
#!/bin/bash
# disaster-recovery-drill.sh
DRILL_DATE=$(date +%Y%m%d)
DRILL_LOG="/var/log/dr-drill-$DRILL_DATE.log"

echo "ç¾éš¾æ¢å¤æ¼”ç»ƒå¼€å§‹: $(date)" | tee $DRILL_LOG

# æ¨¡æ‹Ÿç¾éš¾åœºæ™¯
echo "æ¨¡æ‹Ÿetcdæ•°æ®ä¸¢å¤±..." | tee -a $DRILL_LOG
sudo systemctl stop etcd
sudo mv /var/lib/etcd /var/lib/etcd.drill-backup

# è®¡æ—¶å¼€å§‹
START_TIME=$(date +%s)

# æ‰§è¡Œæ¢å¤æµç¨‹
echo "å¼€å§‹æ¢å¤æµç¨‹..." | tee -a $DRILL_LOG
# ... æ‰§è¡Œå®é™…æ¢å¤æ­¥éª¤ ...

# è®¡æ—¶ç»“æŸ
END_TIME=$(date +%s)
RECOVERY_TIME=$((END_TIME - START_TIME))

echo "æ¢å¤è€—æ—¶: ${RECOVERY_TIME}ç§’" | tee -a $DRILL_LOG

# éªŒè¯æ¢å¤ç»“æœ
echo "éªŒè¯é›†ç¾¤çŠ¶æ€..." | tee -a $DRILL_LOG
kubectl cluster-info | tee -a $DRILL_LOG
kubectl get nodes | tee -a $DRILL_LOG

# æ¢å¤åŸå§‹çŠ¶æ€
sudo mv /var/lib/etcd.drill-backup /var/lib/etcd
sudo systemctl start etcd

echo "ç¾éš¾æ¢å¤æ¼”ç»ƒå®Œæˆ: $(date)" | tee -a $DRILL_LOG
```

---

## 9. âª å‡çº§å›æ»šä¸åº”æ€¥å¤„ç†


### 9.1 å‡çº§å‰ç½®æ¡ä»¶æ£€æŸ¥


**âœ… å‡çº§å¯è¡Œæ€§è¯„ä¼°**

```bash
#!/bin/bash
# pre-upgrade-check.sh
echo "=== Kuberneteså‡çº§å‰æ£€æŸ¥ ==="

# æ£€æŸ¥é›†ç¾¤å¥åº·çŠ¶æ€
echo "1. æ£€æŸ¥é›†ç¾¤åŸºæœ¬çŠ¶æ€ï¼š"
kubectl get nodes
kubectl get pods --all-namespaces | grep -v Running | grep -v Completed

# æ£€æŸ¥èµ„æºä½¿ç”¨æƒ…å†µ
echo -e "\n2. æ£€æŸ¥èµ„æºä½¿ç”¨æƒ…å†µï¼š"
kubectl top nodes
kubectl top pods --all-namespaces | head -10

# æ£€æŸ¥æŒä¹…åŒ–å­˜å‚¨
echo -e "\n3. æ£€æŸ¥å­˜å‚¨çŠ¶æ€ï¼š"
kubectl get pv
kubectl get pvc --all-namespaces

# æ£€æŸ¥å…³é”®ç»„ä»¶
echo -e "\n4. æ£€æŸ¥æ ¸å¿ƒç»„ä»¶ï¼š"
kubectl get componentstatuses

# æ£€æŸ¥etcdå¥åº·çŠ¶æ€
echo -e "\n5. æ£€æŸ¥etcdçŠ¶æ€ï¼š"
kubectl get pods -n kube-system | grep etcd

echo -e "\n=== æ£€æŸ¥å®Œæˆ ==="
```

### 9.2 å‡çº§å›æ»šç­–ç•¥


**ğŸ”„ ä¸åŒåœºæ™¯çš„å›æ»šæ–¹æ³•**

**æ§åˆ¶å¹³é¢å›æ»š**ï¼š
```bash
# å¦‚æœæ§åˆ¶å¹³é¢å‡çº§å¤±è´¥ï¼Œå›æ»šæ­¥éª¤ï¼š

# 1. åœæ­¢å‡çº§è¿‡ç¨‹
sudo systemctl stop kubelet

# 2. æ¢å¤é…ç½®æ–‡ä»¶å¤‡ä»½
sudo cp -r /etc/kubernetes.backup/* /etc/kubernetes/

# 3. é™çº§kubeadmç‰ˆæœ¬
sudo apt install -y kubeadm=1.27.0-00 --allow-downgrades

# 4. é‡æ–°å¯åŠ¨æœåŠ¡
sudo systemctl start kubelet

# 5. éªŒè¯å›æ»šç»“æœ
kubectl version
kubectl get nodes
```

**WorkerèŠ‚ç‚¹å›æ»š**ï¼š
```bash
# WorkerèŠ‚ç‚¹å›æ»šç›¸å¯¹ç®€å•

# 1. è¿æ¥åˆ°é—®é¢˜èŠ‚ç‚¹
ssh node01

# 2. é™çº§kubeletç‰ˆæœ¬
sudo apt install -y kubelet=1.27.0-00 --allow-downgrades

# 3. é‡å¯kubelet
sudo systemctl restart kubelet

# 4. åœ¨masterä¸ŠéªŒè¯èŠ‚ç‚¹çŠ¶æ€
kubectl get node node01
```

### 9.3 åº”æ€¥å“åº”æµç¨‹


**ğŸš¨ åº”æ€¥å¤„ç†å†³ç­–æ ‘**

```
å‡çº§æ•…éšœåº”æ€¥æµç¨‹ï¼š

ç¬¬1æ­¥ï¼šå¿«é€Ÿè¯„ä¼°
â”œâ”€ æ§åˆ¶å¹³é¢å¯ç”¨ï¼Ÿ
â”‚  â”œâ”€ æ˜¯ â†’ å¯èƒ½æ˜¯WorkerèŠ‚ç‚¹é—®é¢˜ï¼Œç»§ç»­è¯Šæ–­
â”‚  â””â”€ å¦ â†’ ä¸¥é‡æ•…éšœï¼Œå¯åŠ¨ç´§æ€¥æ¢å¤
â”‚
ç¬¬2æ­¥ï¼šç¡®å®šå½±å“èŒƒå›´  
â”œâ”€ éƒ¨åˆ†èŠ‚ç‚¹æ•…éšœï¼Ÿ
â”‚  â”œâ”€ æ˜¯ â†’ éš”ç¦»æ•…éšœèŠ‚ç‚¹ï¼Œç»§ç»­å›æ»š
â”‚  â””â”€ å¦ â†’ å…¨é›†ç¾¤æ•…éšœï¼Œè€ƒè™‘å®Œæ•´å›æ»š
â”‚
ç¬¬3æ­¥ï¼šæ‰§è¡Œæ¢å¤æ“ä½œ
â”œâ”€ èƒ½å¦å¿«é€Ÿä¿®å¤ï¼Ÿ
â”‚  â”œâ”€ æ˜¯ â†’ åœ¨çº¿ä¿®å¤ï¼Œç›‘æ§æ¢å¤
â”‚  â””â”€ å¦ â†’ å¯åŠ¨å›æ»šæµç¨‹
```

### 9.4 å‡çº§å¤±è´¥è¯Šæ–­


**ğŸ” å¸¸è§å‡çº§å¤±è´¥åŸå› å’Œè§£å†³æ–¹æ³•**

| å¤±è´¥ç°è±¡ | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ³•** |
|---------|-------------|-------------|
| **kubeletå¯åŠ¨å¤±è´¥** | `é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯` | `æ¢å¤å¤‡ä»½é…ç½®` |
| **Podæ— æ³•è°ƒåº¦** | `èŠ‚ç‚¹èµ„æºä¸è¶³` | `æ‰©å®¹æˆ–æ¸…ç†èµ„æº` |
| **ç½‘ç»œä¸é€š** | `CNIæ’ä»¶ä¸å…¼å®¹` | `å‡çº§æˆ–å›æ»šCNI` |
| **API Serveré”™è¯¯** | `è¯ä¹¦è¿‡æœŸæˆ–é…ç½®é”™è¯¯` | `æ£€æŸ¥è¯ä¹¦å’Œé…ç½®` |

**è¯¦ç»†è¯Šæ–­è„šæœ¬**ï¼š
```bash
#!/bin/bash
# upgrade-troubleshoot.sh
echo "=== Kuberneteså‡çº§æ•…éšœè¯Šæ–­ ==="

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "1. æ£€æŸ¥ç³»ç»ŸæœåŠ¡ï¼š"
sudo systemctl status kubelet
sudo systemctl status docker

# æ£€æŸ¥æ—¥å¿—
echo -e "\n2. æ£€æŸ¥å…³é”®æ—¥å¿—ï¼š"
echo "kubeletæ—¥å¿—ï¼š"
sudo journalctl -u kubelet --no-pager | tail -20

echo -e "\nå®¹å™¨è¿è¡Œæ—¶æ—¥å¿—ï¼š"
sudo journalctl -u docker --no-pager | tail -10

# æ£€æŸ¥é…ç½®æ–‡ä»¶
echo -e "\n3. æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼š"
echo "kubeleté…ç½®ï¼š"
sudo cat /var/lib/kubelet/config.yaml | head -10

# æ£€æŸ¥ç½‘ç»œè¿æ¥
echo -e "\n4. æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼š"
ping -c 3 8.8.8.8
nslookup kubernetes.default.svc.cluster.local

# æ£€æŸ¥å­˜å‚¨æŒ‚è½½
echo -e "\n5. æ£€æŸ¥å­˜å‚¨æŒ‚è½½ï¼š"
df -h | grep -E "(var|opt|tmp)"
mount | grep -E "(var|opt|tmp)"

echo -e "\n=== è¯Šæ–­å®Œæˆ ==="
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ å‡çº§ç­–ç•¥ï¼šè“ç»¿ã€æ»šåŠ¨ã€åŸåœ°ä¸‰ç§ç­–ç•¥çš„é€‰æ‹©åŸåˆ™
ğŸ”¸ å‡çº§é¡ºåºï¼šæ§åˆ¶å¹³é¢å¿…é¡»å…ˆäºWorkerèŠ‚ç‚¹å‡çº§
ğŸ”¸ etcdå¤‡ä»½ï¼šé›†ç¾¤æœ€é‡è¦çš„æ•°æ®ä¿æŠ¤æªæ–½
ğŸ”¸ è¯ä¹¦ç®¡ç†ï¼šå®šæœŸæ£€æŸ¥å’Œç»­æœŸï¼Œé¿å…é›†ç¾¤ä¸å¯ç”¨
ğŸ”¸ èŠ‚ç‚¹ç»´æŠ¤ï¼šå®‰å…¨é©±é€Podï¼Œä¿è¯ä¸šåŠ¡è¿ç»­æ€§
```

### 10.2 å…³é”®æ“ä½œè¦ç‚¹


**ğŸ”¹ å‡çº§å‰çš„å‡†å¤‡å·¥ä½œ**
```
é£é™©è¯„ä¼°ï¼š
âœ… å…¼å®¹æ€§æµ‹è¯•ï¼šåº”ç”¨ã€æ’ä»¶ã€APIç‰ˆæœ¬
âœ… èµ„æºæ£€æŸ¥ï¼šèŠ‚ç‚¹å®¹é‡ã€å­˜å‚¨ç©ºé—´
âœ… å¤‡ä»½å‡†å¤‡ï¼šetcdã€é…ç½®æ–‡ä»¶ã€è¯ä¹¦

ç¯å¢ƒå‡†å¤‡ï¼š
âœ… æµ‹è¯•ç¯å¢ƒéªŒè¯å®Œæ•´å‡çº§æµç¨‹
âœ… ç»´æŠ¤çª—å£å®‰æ’å’Œé€šçŸ¥
âœ… å›æ»šè®¡åˆ’å’Œåº”æ€¥è”ç³»äºº
```

**ğŸ”¹ å‡çº§è¿‡ç¨‹çš„ç›‘æ§**
```
å…³é”®æŒ‡æ ‡ï¼š
ğŸ“Š PodçŠ¶æ€ï¼šç¡®ä¿æœåŠ¡ä¸ä¸­æ–­
ğŸ“Š èŠ‚ç‚¹çŠ¶æ€ï¼šç›‘æ§èŠ‚ç‚¹å¥åº·
ğŸ“Š APIå“åº”ï¼šéªŒè¯é›†ç¾¤åŠŸèƒ½
ğŸ“Š èµ„æºä½¿ç”¨ï¼šé¿å…èµ„æºè€—å°½
```

### 10.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ’¡ å®‰å…¨å‡çº§åŸåˆ™**
```
æ¸è¿›å‡çº§ï¼š
- æµ‹è¯•ç¯å¢ƒå…ˆè¡Œ
- å°è§„æ¨¡èŠ‚ç‚¹è¯•ç‚¹
- é€æ­¥æ‰©å±•åˆ°å…¨é›†ç¾¤

å……åˆ†å¤‡ä»½ï¼š
- etcdæ•°æ®å®šæœŸå¤‡ä»½
- é…ç½®æ–‡ä»¶å®Œæ•´å¤‡ä»½
- è¯ä¹¦æ–‡ä»¶å®‰å…¨å¤‡ä»½

ç›‘æ§é¢„è­¦ï¼š
- è¯ä¹¦åˆ°æœŸæå‰é¢„è­¦
- èµ„æºä½¿ç”¨é˜ˆå€¼ç›‘æ§
- å‡çº§è¿‡ç¨‹å®æ—¶ç›‘æ§
```

**ğŸ”§ è¿ç»´å·¥å…·åŒ–**
```
è‡ªåŠ¨åŒ–è„šæœ¬ï¼š
âœ… å‡çº§å‰æ£€æŸ¥è„šæœ¬
âœ… å¤‡ä»½æ¢å¤è‡ªåŠ¨åŒ–
âœ… è¯ä¹¦ç»­æœŸè‡ªåŠ¨åŒ–
âœ… èŠ‚ç‚¹ç»´æŠ¤è‡ªåŠ¨åŒ–

ç›‘æ§å‘Šè­¦ï¼š
âœ… è¯ä¹¦åˆ°æœŸç›‘æ§
âœ… é›†ç¾¤å¥åº·ç›‘æ§
âœ… å‡çº§è¿›åº¦è·Ÿè¸ª
âœ… æ•…éšœè‡ªåŠ¨é€šçŸ¥
```

### 10.4 åº”æ€¥å¤„ç†å‡†åˆ™


```
æ•…éšœå“åº”ä¼˜å…ˆçº§ï¼š
1. ä¿è¯æ ¸å¿ƒä¸šåŠ¡ä¸ä¸­æ–­
2. å¿«é€Ÿå®šä½æ•…éšœåŸå› 
3. é€‰æ‹©æœ€å¿«çš„æ¢å¤æ–¹å¼
4. è¯¦ç»†è®°å½•å¤„ç†è¿‡ç¨‹

æ¢å¤å†³ç­–åŸåˆ™ï¼š
â€¢ RTO < 30åˆ†é’Ÿï¼šä¼˜å…ˆå¿«é€Ÿä¿®å¤
â€¢ RTO > 30åˆ†é’Ÿï¼šè€ƒè™‘å›æ»šæ“ä½œ  
â€¢ æ•°æ®å®Œæ•´æ€§ï¼šä¼˜å…ˆä¿è¯æ•°æ®å®‰å…¨
â€¢ ä¸šåŠ¡è¿ç»­æ€§ï¼šæœ€å°åŒ–æœåŠ¡ä¸­æ–­
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Kubernetesé›†ç¾¤ç»´æŠ¤éœ€è¦ç³»ç»Ÿæ€§è§„åˆ’å’Œæ‰§è¡Œ
- å¤‡ä»½æ˜¯ä¸€åˆ‡ç»´æŠ¤æ“ä½œçš„å®‰å…¨åŸºç¡€
- å‡çº§å¿…é¡»éµå¾ªæ­£ç¡®çš„é¡ºåºå’ŒèŠ‚å¥
- è¯ä¹¦ç®¡ç†å…³ä¹é›†ç¾¤çš„åŸºæœ¬å¯ç”¨æ€§
- åº”æ€¥å¤„ç†éœ€è¦æ˜ç¡®çš„æµç¨‹å’Œå†³ç­–æ ‡å‡†