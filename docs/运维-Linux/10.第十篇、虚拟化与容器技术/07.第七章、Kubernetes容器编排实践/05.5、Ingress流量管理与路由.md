---
title: 5ã€Ingressæµé‡ç®¡ç†ä¸è·¯ç”±
---
## ğŸ“š ç›®å½•

1. [IngressåŸºç¡€æ¦‚å¿µ](#1-IngressåŸºç¡€æ¦‚å¿µ)
2. [Ingress Controlleræ§åˆ¶å™¨](#2-Ingress-Controlleræ§åˆ¶å™¨)
3. [åŸºç¡€è·¯ç”±é…ç½®](#3-åŸºç¡€è·¯ç”±é…ç½®)
4. [HTTPSä¸TLSé…ç½®](#4-HTTPSä¸TLSé…ç½®)
5. [é«˜çº§æµé‡ç®¡ç†](#5-é«˜çº§æµé‡ç®¡ç†)
6. [å¤šæ§åˆ¶å™¨ç®¡ç†](#6-å¤šæ§åˆ¶å™¨ç®¡ç†)
7. [å®è·µæ¡ˆä¾‹](#7-å®è·µæ¡ˆä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ IngressåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Ingress


**ğŸ”¸ é€šä¿—ç†è§£**
```
æŠŠKubernetesæƒ³è±¡æˆä¸€ä¸ªå¤§å‹è´­ç‰©ä¸­å¿ƒï¼š
- Podæ˜¯å„ä¸ªå•†åº—
- Serviceæ˜¯å•†åº—çš„å†…éƒ¨é€šé“
- Ingresså°±æ˜¯è´­ç‰©ä¸­å¿ƒçš„æ€»å…¥å£å’Œå¯¼è´­å°

å®¢æˆ·ä»å¤–é¢è¿›æ¥ï¼ŒIngressè´Ÿè´£ï¼š
"æ‚¨è¦æ‰¾æœè£…åº—å—ï¼Ÿè¯·å¾€å·¦èµ°"
"æ‚¨è¦æ‰¾é¤å…å—ï¼Ÿè¯·å¾€å³èµ°äºŒæ¥¼"
```

**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
- **Ingress**ï¼šKubernetesçš„APIå¯¹è±¡ï¼Œç®¡ç†é›†ç¾¤å¤–éƒ¨è®¿é—®å†…éƒ¨æœåŠ¡çš„HTTPå’ŒHTTPSè·¯ç”±
- **ä½œç”¨**ï¼šç›¸å½“äºé›†ç¾¤çš„"æ™ºèƒ½é—¨å«"ï¼Œæ ¹æ®è¯·æ±‚çš„åŸŸåå’Œè·¯å¾„ï¼Œå°†æµé‡å¯¼å‘æ­£ç¡®çš„æœåŠ¡
- **æœ¬è´¨**ï¼šä¸ƒå±‚(åº”ç”¨å±‚)è´Ÿè½½å‡è¡¡å™¨çš„é…ç½®è§„åˆ™

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Ingress


**ğŸ¤” ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**
```
ä¼ ç»ŸServiceæš´éœ²æ–¹å¼ï¼š
NodePort â†’ æ¯ä¸ªæœåŠ¡å ç”¨ä¸€ä¸ªç«¯å£ï¼Œç«¯å£ç®¡ç†æ··ä¹±
LoadBalancer â†’ æ¯ä¸ªæœåŠ¡éœ€è¦ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ï¼Œæˆæœ¬é«˜æ˜‚

ç°å®åœºæ™¯ï¼š
- å…¬å¸æœ‰10ä¸ªå¾®æœåŠ¡
- ç”¨NodePortéœ€è¦è®°ä½10ä¸ªä¸åŒç«¯å£
- ç”¨LoadBalanceréœ€è¦10ä¸ªäº‘å‚å•†è´Ÿè½½å‡è¡¡å™¨ï¼ˆæ¯æœˆå‡ ç™¾å…ƒï¼‰
```

**âœ… Ingressçš„ä¼˜åŠ¿**
```
ä¸€ä¸ªå…¥å£ç®¡ç†æ‰€æœ‰æœåŠ¡ï¼š
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
å¤–éƒ¨æµé‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  Ingresså…¥å£     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   è·¯ç”±è§„åˆ™       â”‚
                    â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
                      â”‚             â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
               â”‚ ç”¨æˆ·æœåŠ¡     â”‚ â”‚ è®¢å•æœåŠ¡ â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¥½å¤„ï¼š
â€¢ ç»Ÿä¸€å…¥å£ï¼šåªéœ€ä¸€ä¸ªå…¬ç½‘IP
â€¢ æ™ºèƒ½è·¯ç”±ï¼šæ ¹æ®åŸŸå/è·¯å¾„è‡ªåŠ¨åˆ†å‘
â€¢ æˆæœ¬èŠ‚çº¦ï¼šä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨è§£å†³æ‰€æœ‰é—®é¢˜
```

### 1.3 Ingressçš„å·¥ä½œåŸç†


**ğŸ”„ è¯·æ±‚å¤„ç†æµç¨‹**
```
ç”¨æˆ·è¯·æ±‚æµç¨‹å›¾ï¼š

æµè§ˆå™¨                    Ingress Controller              åç«¯Pod
   â”‚                           â”‚                          â”‚
   â”‚â”€â”€[1]GET api.demo.comâ”€â”€â”€â”€â”€â–¶â”‚                          â”‚
   â”‚                           â”‚â”€â”€[2]æŸ¥æ‰¾è·¯ç”±è§„åˆ™â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                           â”‚                          â”‚
   â”‚                           â”‚â”€â”€[3]è½¬å‘åˆ°user-serviceâ”€â”€â”€â–¶â”‚ç”¨æˆ·æœåŠ¡Pod
   â”‚                           â”‚                          â”‚
   â”‚â—€â”€[4]è¿”å›å“åº”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—€â”€[5]æœåŠ¡å“åº”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

**ğŸ“Š æ ¸å¿ƒç»„ä»¶å…³ç³»**
```
Ingressç”Ÿæ€ç³»ç»Ÿï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Ingressèµ„æº    â”‚â”€â”€â”€â”€â”‚ Ingress Controller â”‚â”€â”€â”€â”€â”‚   Service   â”‚
â”‚  (è·¯ç”±è§„åˆ™é…ç½®)   â”‚    â”‚   (è§„åˆ™è§£é‡Šå™¨)      â”‚    â”‚  (æœåŠ¡å‘ç°)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚                       â”‚
         â–¼                        â–¼                       â–¼
  å®šä¹‰"è°å»å“ªé‡Œ"              å®ç°è·¯ç”±åŠŸèƒ½              è¿æ¥å…·ä½“Pod
```

---

## 2. ğŸš€ Ingress Controlleræ§åˆ¶å™¨


### 2.1 æ§åˆ¶å™¨é€‰æ‹©å¯¹æ¯”


**ğŸ”§ ä¸»æµIngress Controllerå¯¹æ¯”**

| æ§åˆ¶å™¨ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **ä¼˜åŠ¿** | **ç¼ºç‚¹** |
|-----------|-------------|----------|----------|
| ğŸŒ **Nginx Ingress** | `ä¸­å°å‹é¡¹ç›®` | ç®€å•æ˜“ç”¨ï¼Œæ–‡æ¡£ä¸°å¯Œ | åŠŸèƒ½ç›¸å¯¹åŸºç¡€ |
| âš¡ **Traefik** | `å¾®æœåŠ¡æ¶æ„` | è‡ªåŠ¨æœåŠ¡å‘ç°ï¼ŒUIå‹å¥½ | é…ç½®å¤æ‚åº¦ä¸­ç­‰ |
| ğŸ¢ **HAProxy** | `ä¼ä¸šçº§åº”ç”¨` | æ€§èƒ½æä½³ï¼Œç¨³å®šæ€§é«˜ | å­¦ä¹ æ›²çº¿é™¡å³­ |
| ğŸŒ **Kong** | `APIç½‘å…³éœ€æ±‚` | æ’ä»¶ä¸°å¯Œï¼ŒAPIç®¡ç†å¼º | èµ„æºæ¶ˆè€—è¾ƒå¤§ |
| â˜ï¸ **äº‘å‚å•†** | `äº‘åŸç”Ÿç¯å¢ƒ` | ä¸äº‘æœåŠ¡é›†æˆå¥½ | å‚å•†ç»‘å®š |

### 2.2 Nginx Ingresséƒ¨ç½²


**ğŸ“¦ å¿«é€Ÿéƒ¨ç½²æ–¹æ¡ˆ**

**â‘  å®˜æ–¹éƒ¨ç½²(æ¨èæ–°æ‰‹)**
```bash
# éƒ¨ç½²Nginx Ingress Controller
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml

# ç­‰å¾…Podå°±ç»ª
kubectl wait --namespace ingress-nginx \
  --for=condition=ready pod \
  --selector=app.kubernetes.io/component=controller \
  --timeout=120s
```

**â‘¡ æ£€æŸ¥éƒ¨ç½²çŠ¶æ€**
```bash
# æŸ¥çœ‹Ingress ControllerçŠ¶æ€
kubectl get pods -n ingress-nginx

# æŸ¥çœ‹ServiceçŠ¶æ€
kubectl get svc -n ingress-nginx
```

**â‘¢ æœ¬åœ°ç¯å¢ƒé…ç½®**
```yaml
# æœ¬åœ°æµ‹è¯•ç”¨çš„NodePorté…ç½®
apiVersion: v1
kind: Service
metadata:
  name: ingress-nginx-controller
  namespace: ingress-nginx
spec:
  type: NodePort
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30080    # HTTPè®¿é—®ç«¯å£
  - port: 443
    targetPort: 443
    nodePort: 30443    # HTTPSè®¿é—®ç«¯å£
  selector:
    app.kubernetes.io/name: ingress-nginx
```

### 2.3 éªŒè¯æ§åˆ¶å™¨å·¥ä½œ


**ğŸ” å¥åº·æ£€æŸ¥**
```bash
# æ£€æŸ¥æ§åˆ¶å™¨æ—¥å¿—
kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx

# è®¿é—®æ§åˆ¶å™¨çŠ¶æ€é¡µé¢
curl -I http://èŠ‚ç‚¹IP:30080/healthz
```

---

## 3. ğŸ›£ï¸ åŸºç¡€è·¯ç”±é…ç½®


### 3.1 åŸºäºä¸»æœºåçš„è·¯ç”±


**ğŸ  åŸŸåè·¯ç”±åŸç†**
```
åŸŸåè·¯ç”±å°±åƒé‚®å±€åˆ†æ‹£ä¿¡ä»¶ï¼š
- api.demo.com çš„è¯·æ±‚ â†’ å‘å¾€APIæœåŠ¡
- web.demo.com çš„è¯·æ±‚ â†’ å‘å¾€å‰ç«¯æœåŠ¡  
- admin.demo.com çš„è¯·æ±‚ â†’ å‘å¾€ç®¡ç†åå°

ä¸€ä¸ªIPåœ°å€ï¼Œå¤šä¸ªåŸŸåï¼Œå„è‡ªæ‰¾åˆ°è‡ªå·±çš„æœåŠ¡
```

**ğŸ“‹ é…ç½®ç¤ºä¾‹**
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: host-based-routing
  annotations:
    kubernetes.io/ingress.class: nginx    # æŒ‡å®šä½¿ç”¨nginxæ§åˆ¶å™¨
spec:
  rules:
  - host: api.demo.com                    # APIæœåŠ¡åŸŸå
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 8080
              
  - host: web.demo.com                    # å‰ç«¯æœåŠ¡åŸŸå  
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: web-service
            port:
              number: 80
```

### 3.2 åŸºäºè·¯å¾„çš„è·¯ç”±


**ğŸ—‚ï¸ è·¯å¾„è·¯ç”±åŸç†**
```
è·¯å¾„è·¯ç”±åƒå¤§æ¥¼çš„æ¥¼å±‚æŒ‡å¼•ï¼š
demo.com/api/     â†’ åç«¯APIæœåŠ¡(å¦‚3æ¥¼)
demo.com/web/     â†’ å‰ç«¯èµ„æº(å¦‚1æ¥¼) 
demo.com/admin/   â†’ ç®¡ç†ç•Œé¢(å¦‚2æ¥¼)

åŒä¸€ä¸ªåŸŸåï¼Œä¸åŒè·¯å¾„ï¼Œåˆ†å‘åˆ°ä¸åŒæœåŠ¡
```

**ğŸ“‹ é…ç½®ç¤ºä¾‹**
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: path-based-routing
spec:
  rules:
  - host: demo.com
    http:
      paths:
      - path: /api                        # APIè·¯å¾„
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 8080
              
      - path: /web                        # å‰ç«¯è·¯å¾„
        pathType: Prefix  
        backend:
          service:
            name: web-service
            port:
              number: 80
              
      - path: /admin                      # ç®¡ç†åå°è·¯å¾„
        pathType: Prefix
        backend:
          service:
            name: admin-service
            port:
              number: 3000
```

### 3.3 è·¯å¾„åŒ¹é…ç±»å‹è¯¦è§£


**ğŸ¯ PathTypeé…ç½®è¯´æ˜**

| åŒ¹é…ç±»å‹ | **å«ä¹‰** | **ç¤ºä¾‹** | **åŒ¹é…ç»“æœ** |
|---------|----------|----------|-------------|
| **Prefix** | å‰ç¼€åŒ¹é… | `/api` | âœ… `/api/users`<br/>âœ… `/api/orders`<br/>âŒ `/app` |
| **Exact** | ç²¾ç¡®åŒ¹é… | `/api` | âœ… `/api`<br/>âŒ `/api/`<br/>âŒ `/api/users` |
| **ImplementationSpecific** | æ§åˆ¶å™¨ç‰¹å®š | å–å†³äºå…·ä½“å®ç° | ç”±Ingress Controllerå†³å®š |

**ğŸ’¡ å®ç”¨å»ºè®®**
```
é€‰æ‹©åŸåˆ™ï¼š
â€¢ å¾®æœåŠ¡API â†’ ç”¨ Prefixï¼Œæ–¹ä¾¿æ‰©å±•è·¯å¾„
â€¢ é™æ€æ–‡ä»¶ â†’ ç”¨ Exactï¼Œç²¾ç¡®æ§åˆ¶
â€¢ å¤æ‚è·¯ç”± â†’ ç”¨æ­£åˆ™è¡¨è¾¾å¼æ³¨è§£
```

---

## 4. ğŸ”’ HTTPSä¸TLSé…ç½®


### 4.1 TLSè¯ä¹¦ç®¡ç†


**ğŸ›¡ï¸ HTTPSå·¥ä½œåŸç†**
```
HTTPSå¤„ç†æµç¨‹ï¼š

å®¢æˆ·ç«¯                 Ingress Controller              åç«¯æœåŠ¡
   â”‚                        â”‚                           â”‚
   â”‚â”€â”€[1]HTTPSè¯·æ±‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                           â”‚
   â”‚                        â”‚â”€â”€[2]TLSç»ˆæ­¢â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                        â”‚   (è§£å¯†è¯·æ±‚)               â”‚
   â”‚                        â”‚                           â”‚
   â”‚                        â”‚â”€â”€[3]HTTPè½¬å‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                        â”‚   (å†…éƒ¨æ˜æ–‡é€šä¿¡)            â”‚
   â”‚                        â”‚                           â”‚
   â”‚â—€â”€[4]HTTPSå“åº”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—€â”€[5]HTTPå“åº”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚   (åŠ å¯†å“åº”)            â”‚   (æ˜æ–‡å“åº”)               â”‚

ä¼˜åŠ¿ï¼šSSLç»ˆæ­¢åœ¨Ingresså±‚ï¼Œåç«¯æœåŠ¡æ— éœ€å¤„ç†åŠ å¯†
```

### 4.2 åˆ›å»ºTLSè¯ä¹¦


**ğŸ“œ è‡ªç­¾åè¯ä¹¦(æµ‹è¯•ç”¨)**
```bash
# ç”Ÿæˆç§é’¥
openssl genrsa -out tls.key 2048

# ç”Ÿæˆè¯ä¹¦
openssl req -new -x509 -key tls.key -out tls.crt -days 365 \
  -subj "/CN=demo.com"

# åˆ›å»ºKubernetes Secret
kubectl create secret tls demo-tls \
  --cert=tls.crt \
  --key=tls.key
```

**ğŸŒ Let's Encryptè¯ä¹¦(ç”Ÿäº§ç”¨)**
```yaml
# ä½¿ç”¨cert-managerè‡ªåŠ¨è·å–è¯ä¹¦
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: demo-com-cert
spec:
  secretName: demo-tls
  dnsNames:
  - demo.com
  - www.demo.com
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
```

### 4.3 é…ç½®HTTPS Ingress


**ğŸ” å®Œæ•´HTTPSé…ç½®**
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: https-ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    # å¼ºåˆ¶HTTPSé‡å®šå‘
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # æ·»åŠ å®‰å…¨å¤´
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
spec:
  tls:
  - hosts:
    - demo.com
    - www.demo.com
    secretName: demo-tls                  # å¼•ç”¨TLSè¯ä¹¦
  rules:
  - host: demo.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: web-service
            port:
              number: 80
```

---

## 5. âš–ï¸ é«˜çº§æµé‡ç®¡ç†


### 5.1 è´Ÿè½½å‡è¡¡é…ç½®


**ğŸ”„ è´Ÿè½½å‡è¡¡ç®—æ³•**

**â‘  åŸºç¡€é…ç½®**
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: load-balance-ingress
  annotations:
    # è´Ÿè½½å‡è¡¡ç®—æ³•
    nginx.ingress.kubernetes.io/load-balance: "round_robin"    # è½®è¯¢(é»˜è®¤)
    # nginx.ingress.kubernetes.io/load-balance: "least_conn"   # æœ€å°‘è¿æ¥
    # nginx.ingress.kubernetes.io/load-balance: "ip_hash"     # IPå“ˆå¸Œ
    
    # ä¼šè¯ä¿æŒ
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/affinity-mode: "persistent"
    nginx.ingress.kubernetes.io/session-cookie-name: "SERVERID"
    nginx.ingress.kubernetes.io/session-cookie-expires: "86400"
```

**â‘¡ ç®—æ³•é€‰æ‹©æŒ‡å—**
```
ğŸ¯ é€‰æ‹©å»ºè®®ï¼š
â€¢ æ— çŠ¶æ€æœåŠ¡ â†’ round_robin (è½®è¯¢)
â€¢ é•¿è¿æ¥æœåŠ¡ â†’ least_conn (æœ€å°‘è¿æ¥)  
â€¢ æœ‰çŠ¶æ€æœåŠ¡ â†’ ip_hash (IPå“ˆå¸Œ)
â€¢ éœ€è¦ä¼šè¯ä¿æŒ â†’ å¯ç”¨cookie affinity
```

### 5.2 å¥åº·æ£€æŸ¥é…ç½®


**ğŸ¥ å¥åº·æ£€æŸ¥è®¾ç½®**
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: health-check-ingress
  annotations:
    # ä¸Šæ¸¸å¥åº·æ£€æŸ¥
    nginx.ingress.kubernetes.io/upstream-hash-by: "$request_uri"
    
    # ä»£ç†è¶…æ—¶è®¾ç½®
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"  
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    
    # é‡è¯•é…ç½®
    nginx.ingress.kubernetes.io/proxy-next-upstream: "error timeout http_502 http_503 http_504"
```

### 5.3 æµé‡åˆ†å‰²ä¸é‡‘ä¸é›€å‘å¸ƒ


**ğŸ¦ é‡‘ä¸é›€å‘å¸ƒåŸç†**
```
é‡‘ä¸é›€å‘å¸ƒå°±åƒè¯•åƒï¼š
- 90%ç”¨æˆ·ç»§ç»­ç”¨ç¨³å®šç‰ˆæœ¬ (v1)
- 10%ç”¨æˆ·è¯•ç”¨æ–°ç‰ˆæœ¬ (v2)  
- å¦‚æœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œåªå½±å“å°‘éƒ¨åˆ†ç”¨æˆ·
- é€æ­¥å¢åŠ æ–°ç‰ˆæœ¬æ¯”ä¾‹ï¼Œç›´åˆ°å®Œå…¨åˆ‡æ¢

æµé‡åˆ†å‰²ç¤ºæ„ï¼š
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    100%æµé‡ â”€â”€â”€â”€â–¶ â”‚   Ingress   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
                    â”‚ æµé‡åˆ†å‰² â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                     â–¼
         90%æµé‡                10%æµé‡
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
    â”‚   ç¨³å®šç‰ˆv1   â”‚         â”‚   æ–°ç‰ˆæœ¬v2   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“‹ é‡‘ä¸é›€é…ç½®å®ä¾‹**
```yaml
# ä¸»æœåŠ¡Ingress (90%æµé‡)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: main-ingress
spec:
  rules:
  - host: demo.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: app-v1-service        # ç¨³å®šç‰ˆæœ¬æœåŠ¡
            port:
              number: 8080

---
# é‡‘ä¸é›€æœåŠ¡Ingress (10%æµé‡)  
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: canary-ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    # å¯ç”¨é‡‘ä¸é›€å‘å¸ƒ
    nginx.ingress.kubernetes.io/canary: "true"
    # 10%æµé‡åˆ†é…åˆ°é‡‘ä¸é›€ç‰ˆæœ¬
    nginx.ingress.kubernetes.io/canary-weight: "10"
    
    # é«˜çº§æ¡ä»¶æ§åˆ¶(å¯é€‰)
    # nginx.ingress.kubernetes.io/canary-by-header: "canary"
    # nginx.ingress.kubernetes.io/canary-by-cookie: "canary-user"
spec:
  rules:
  - host: demo.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: app-v2-service        # æ–°ç‰ˆæœ¬æœåŠ¡
            port:
              number: 8080
```

**ğŸ›ï¸ é‡‘ä¸é›€æ§åˆ¶æ–¹å¼**

| æ§åˆ¶æ–¹å¼ | **æ³¨è§£** | **ç”¨é€”** | **ç¤ºä¾‹** |
|---------|----------|----------|----------|
| **æƒé‡** | `canary-weight` | æŒ‰æ¯”ä¾‹åˆ†æµ | `"10"` (10%æµé‡) |
| **è¯·æ±‚å¤´** | `canary-by-header` | ç‰¹å®šç”¨æˆ·æµ‹è¯• | `"canary"` |
| **Cookie** | `canary-by-cookie` | ç”¨æˆ·æ ‡è¯†åˆ†æµ | `"beta-user"` |

---

## 6. ğŸ”§ å¤šæ§åˆ¶å™¨ç®¡ç†


### 6.1 IngressClassèµ„æº


**ğŸ“‹ æ§åˆ¶å™¨ç±»åˆ«ç®¡ç†**
```yaml
# å®šä¹‰Nginxæ§åˆ¶å™¨ç±»åˆ«
apiVersion: networking.k8s.io/v1
kind: IngressClass  
metadata:
  name: nginx-internal                    # å†…éƒ¨Nginxæ§åˆ¶å™¨
spec:
  controller: k8s.io/ingress-nginx

---
# å®šä¹‰Traefikæ§åˆ¶å™¨ç±»åˆ«  
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: traefik-external                  # å¤–éƒ¨Traefikæ§åˆ¶å™¨
spec:
  controller: traefik.io/ingress-controller
```

### 6.2 å¤šæ§åˆ¶å™¨åœºæ™¯é…ç½®


**ğŸ¢ ä¼ä¸šçº§å¤šæ§åˆ¶å™¨æ¶æ„**
```
å¤šæ§åˆ¶å™¨ä½¿ç”¨åœºæ™¯ï¼š

å¤–ç½‘è®¿é—® â”€â”€â”€â”€â”    â”Œâ”€â”€â–¶ Nginx (å¤–éƒ¨æµé‡)
            â–¼    â–¼    
         Internet   
            â–²    â–²    
å†…ç½‘è®¿é—® â”€â”€â”€â”€â”˜    â””â”€â”€â–¶ Traefik (å†…éƒ¨æµé‡)

é€‚ç”¨åœºæ™¯ï¼š
â€¢ å¤–éƒ¨ç”¨æˆ·è®¿é—® â†’ ç”¨Nginx (æ€§èƒ½å¼º)  
â€¢ å†…éƒ¨æœåŠ¡è°ƒç”¨ â†’ ç”¨Traefik (åŠŸèƒ½ä¸°å¯Œ)
â€¢ ä¸åŒç¯å¢ƒéš”ç¦» â†’ ç”¨ä¸åŒæ§åˆ¶å™¨
```

**ğŸ“‹ æŒ‡å®šæ§åˆ¶å™¨ä½¿ç”¨**
```yaml
# ä½¿ç”¨Nginxæ§åˆ¶å™¨çš„Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: external-ingress
spec:
  ingressClassName: nginx-internal        # æŒ‡å®šä½¿ç”¨çš„æ§åˆ¶å™¨ç±»åˆ«
  rules:
  - host: api.demo.com
    http:
      paths:
      - path: /
        pathType: Prefix  
        backend:
          service:
            name: api-service
            port:
              number: 8080

---
# ä½¿ç”¨Traefikæ§åˆ¶å™¨çš„Ingress
apiVersion: networking.k8s.io/v1  
kind: Ingress
metadata:
  name: internal-ingress
spec:
  ingressClassName: traefik-external      # æŒ‡å®šä½¿ç”¨çš„æ§åˆ¶å™¨ç±»åˆ«
  rules:
  - host: internal.demo.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: internal-service
            port:
              number: 8080
```

---

## 7. ğŸ’¼ å®è·µæ¡ˆä¾‹


### 7.1 ç”µå•†ç½‘ç«™æµé‡ç®¡ç†


**ğŸ›ï¸ ä¸šåŠ¡åœºæ™¯**
```
ç”µå•†ç½‘ç«™æ¶æ„ï¼š
â€¢ www.shop.com â†’ ç”¨æˆ·è´­ç‰©å‰ç«¯
â€¢ api.shop.com â†’ åç«¯APIæœåŠ¡  
â€¢ admin.shop.com â†’ ç®¡ç†åå°
â€¢ static.shop.com â†’ é™æ€èµ„æº(å›¾ç‰‡ç­‰)

éœ€æ±‚ï¼š
âœ… å…¨ç«™HTTPS
âœ… é™æ€èµ„æºç¼“å­˜ä¼˜åŒ–
âœ… APIæ¥å£é™æµä¿æŠ¤
âœ… ç®¡ç†åå°IPç™½åå•
```

**ğŸ“‹ å®Œæ•´é…ç½®ç¤ºä¾‹**
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ecommerce-ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    # å…¨ç«™HTTPSé‡å®šå‘
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    
    # é™æ€èµ„æºç¼“å­˜(é’ˆå¯¹static.shop.com)
    nginx.ingress.kubernetes.io/configuration-snippet: |
      if ($host = "static.shop.com") {
        expires 30d;
        add_header Cache-Control "public, immutable";
      }
      
    # APIé™æµ(é’ˆå¯¹api.shop.com)  
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    
    # ç®¡ç†åå°IPç™½åå•(é’ˆå¯¹admin.shop.com)
    nginx.ingress.kubernetes.io/whitelist-source-range: "192.168.1.0/24,10.0.0.0/8"

spec:
  tls:
  - hosts:
    - www.shop.com
    - api.shop.com  
    - admin.shop.com
    - static.shop.com
    secretName: shop-com-tls
    
  rules:
  # ç”¨æˆ·è´­ç‰©å‰ç«¯
  - host: www.shop.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80
              
  # APIæœåŠ¡              
  - host: api.shop.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 8080
              
  # ç®¡ç†åå°
  - host: admin.shop.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: admin-service
            port:
              number: 3000
              
  # é™æ€èµ„æºæœåŠ¡
  - host: static.shop.com  
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: static-service
            port:
              number: 80
```

### 7.2 å¾®æœåŠ¡APIç½‘å…³


**ğŸ”— å¾®æœåŠ¡è·¯ç”±åœºæ™¯**
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: microservices-gateway
  annotations:
    kubernetes.io/ingress.class: nginx
    # APIç‰ˆæœ¬è·¯ç”±
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    # CORSè·¨åŸŸæ”¯æŒ  
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://app.demo.com"
    
spec:
  rules:
  - host: gateway.demo.com
    http:
      paths:
      # ç”¨æˆ·æœåŠ¡ v1
      - path: /v1/user(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: user-service-v1
            port:
              number: 8080
              
      # ç”¨æˆ·æœåŠ¡ v2        
      - path: /v2/user(/|$)(.*)
        pathType: Prefix  
        backend:
          service:
            name: user-service-v2
            port:
              number: 8080
              
      # è®¢å•æœåŠ¡
      - path: /v1/order(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: order-service
            port:
              number: 8080
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„åŸºç¡€æ¦‚å¿µ


```
ğŸ”¸ Ingressæœ¬è´¨ï¼šä¸ƒå±‚è´Ÿè½½å‡è¡¡å™¨çš„é…ç½®è§„åˆ™ï¼Œé›†ç¾¤å¤–éƒ¨æµé‡çš„ç»Ÿä¸€å…¥å£
ğŸ”¸ Controllerä½œç”¨ï¼šçœŸæ­£æ‰§è¡Œè·¯ç”±åŠŸèƒ½çš„ç»„ä»¶ï¼ŒIngressåªæ˜¯é…ç½®
ğŸ”¸ è·¯ç”±ç±»å‹ï¼šåŸºäºä¸»æœºåè·¯ç”±ã€åŸºäºè·¯å¾„è·¯ç”±ã€ç»„åˆè·¯ç”±
ğŸ”¸ TLSç»ˆæ­¢ï¼šHTTPSåœ¨Ingresså±‚è§£å¯†ï¼Œåç«¯æœåŠ¡å¤„ç†HTTPæ˜æ–‡
ğŸ”¸ æ³¨è§£åŠŸèƒ½ï¼šé€šè¿‡annotationså®ç°é«˜çº§åŠŸèƒ½é…ç½®
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Ingress vs Serviceçš„åŒºåˆ«**
```
Serviceï¼š
â€¢ é›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
â€¢ å››å±‚(ä¼ è¾“å±‚)è´Ÿè½½å‡è¡¡  
â€¢ IP:Port çš„ç®€å•è½¬å‘

Ingressï¼š  
â€¢ é›†ç¾¤å¤–éƒ¨è®¿é—®çš„ç»Ÿä¸€å…¥å£
â€¢ ä¸ƒå±‚(åº”ç”¨å±‚)è´Ÿè½½å‡è¡¡
â€¢ åŸºäºHTTPåè®®çš„æ™ºèƒ½è·¯ç”±
```

**ğŸ”¹ æ§åˆ¶å™¨é€‰æ‹©åŸåˆ™**
```
é€‰æ‹©è€ƒè™‘å› ç´ ï¼š
â€¢ æ€§èƒ½éœ€æ±‚ï¼šNginx > HAProxy > Traefik  
â€¢ åŠŸèƒ½ä¸°å¯Œåº¦ï¼šTraefik > Kong > Nginx
â€¢ æ˜“ç”¨æ€§ï¼šNginx > Traefik > HAProxy
â€¢ ä¼ä¸šæ”¯æŒï¼šHAProxy > Nginx > Traefik
```

**ğŸ”¹ è·¯å¾„åŒ¹é…ç­–ç•¥**
```
å®ç”¨å»ºè®®ï¼š
â€¢ APIæ¥å£ â†’ ç”¨PrefixåŒ¹é…ï¼Œæ–¹ä¾¿ç‰ˆæœ¬æ‰©å±•
â€¢ é™æ€æ–‡ä»¶ â†’ ç”¨ExactåŒ¹é…ï¼Œç²¾ç¡®æ§åˆ¶  
â€¢ å¤æ‚è·¯ç”± â†’ ç”¨æ­£åˆ™è¡¨è¾¾å¼æ³¨è§£
â€¢ é»˜è®¤è·¯ç”± â†’ æ”¾åœ¨è§„åˆ™åˆ—è¡¨æœ€å
```

### 8.3 ç”Ÿäº§ç¯å¢ƒå®è·µè¦ç‚¹


**ğŸš€ æ€§èƒ½ä¼˜åŒ–**
```
ä¼˜åŒ–ç­–ç•¥ï¼š
â‘  åˆç†è®¾ç½®è¶…æ—¶å‚æ•°
â‘¡ å¯ç”¨è¿æ¥æ± å’Œkeep-alive  
â‘¢ é…ç½®åˆé€‚çš„ç¼“å­˜ç­–ç•¥
â‘£ ä½¿ç”¨ä¼šè¯ä¿æŒå‡å°‘é‡å¤è®¤è¯
â‘¤ é™æµä¿æŠ¤åç«¯æœåŠ¡
```

**ğŸ”’ å®‰å…¨é…ç½®**
```
å®‰å…¨æ£€æŸ¥æ¸…å•ï¼š
â–¡ å¼ºåˆ¶HTTPSé‡å®šå‘
â–¡ é…ç½®å®‰å…¨å“åº”å¤´  
â–¡ è®¾ç½®IPç™½åå•(æ•æ„ŸæœåŠ¡)
â–¡ å¯ç”¨è¯·æ±‚å¤§å°é™åˆ¶
â–¡ é…ç½®è®¿é—®æ—¥å¿—å®¡è®¡
```

**ğŸ“Š ç›‘æ§å‘Šè­¦**  
```
å…³é”®æŒ‡æ ‡ï¼š
â€¢ è¯·æ±‚é‡å’Œå“åº”æ—¶é—´
â€¢ é”™è¯¯ç‡(4xx/5xx)
â€¢ ä¸Šæ¸¸æœåŠ¡å¥åº·çŠ¶æ€  
â€¢ TLSè¯ä¹¦è¿‡æœŸæ—¶é—´
â€¢ æ§åˆ¶å™¨èµ„æºä½¿ç”¨ç‡
```

### 8.4 å¸¸è§é—®é¢˜æ’æŸ¥


**â— æ•…éšœè¯Šæ–­æ€è·¯**
```
é—®é¢˜åˆ†ææ­¥éª¤ï¼š
â‘  æ£€æŸ¥Ingressèµ„æºé…ç½®
â‘¡ ç¡®è®¤Controllerè¿è¡ŒçŠ¶æ€  
â‘¢ éªŒè¯Serviceå’ŒPodè¿é€šæ€§
â‘£ æŸ¥çœ‹Controlleræ—¥å¿—
â‘¤ æµ‹è¯•DNSè§£æå’Œè¯ä¹¦
```

**ğŸ’¡ å®ç”¨æ’æŸ¥å‘½ä»¤**
```bash
# æ£€æŸ¥Ingressé…ç½®
kubectl describe ingress åç§°

# æŸ¥çœ‹Controlleræ—¥å¿—  
kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx

# æµ‹è¯•æœåŠ¡è¿é€šæ€§
kubectl exec -it podåç§° -- curl serviceåç§°:ç«¯å£

# éªŒè¯DNSè§£æ
nslookup åŸŸå

# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
openssl x509 -in è¯ä¹¦æ–‡ä»¶ -text -noout
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Ingressæ˜¯K8sçš„æ™ºèƒ½é—¨å«ï¼ŒControlleræ˜¯æ‰§è¡Œè€…
- åŸŸåè·¯ç”±çœ‹Hostï¼Œè·¯å¾„è·¯ç”±çœ‹Path  
- HTTPSåœ¨Ingressç»ˆæ­¢ï¼Œåç«¯ç”¨HTTPé€šä¿¡
- æ³¨è§£é…ç½®é«˜çº§åŠŸèƒ½ï¼Œç”Ÿäº§å¿…é…å®‰å…¨ç­–ç•¥
- å¤šæ§åˆ¶å™¨æŒ‰éœ€é€‰æ‹©ï¼Œé‡‘ä¸é›€å‘å¸ƒé™ä½é£é™©