---
title: 5ã€ç”¨æˆ·è´¦æˆ·è‡ªåŠ¨åŒ–é…ç½®
---
## ğŸ“š ç›®å½•

1. [cloud-initç”¨æˆ·é…ç½®æ¦‚è¿°](#1-cloud-initç”¨æˆ·é…ç½®æ¦‚è¿°)
2. [usersæ¨¡å—æ ¸å¿ƒåŠŸèƒ½](#2-usersæ¨¡å—æ ¸å¿ƒåŠŸèƒ½)
3. [SSHå¯†é’¥è‡ªåŠ¨æ³¨å…¥æœºåˆ¶](#3-SSHå¯†é’¥è‡ªåŠ¨æ³¨å…¥æœºåˆ¶)
4. [é»˜è®¤ç”¨æˆ·é…ç½®è¯¦è§£](#4-é»˜è®¤ç”¨æˆ·é…ç½®è¯¦è§£)
5. [sudoæƒé™è‡ªåŠ¨é…ç½®](#5-sudoæƒé™è‡ªåŠ¨é…ç½®)
6. [å¯†ç è®¾ç½®ä¸è¿‡æœŸç­–ç•¥](#6-å¯†ç è®¾ç½®ä¸è¿‡æœŸç­–ç•¥)
7. [ç”¨æˆ·ç»„è‡ªåŠ¨åˆ†é…](#7-ç”¨æˆ·ç»„è‡ªåŠ¨åˆ†é…)
8. [ç”¨æˆ·shellç¯å¢ƒé…ç½®](#8-ç”¨æˆ·shellç¯å¢ƒé…ç½®)
9. [å¤šç”¨æˆ·æ‰¹é‡åˆ›å»º](#9-å¤šç”¨æˆ·æ‰¹é‡åˆ›å»º)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŸ cloud-initç”¨æˆ·é…ç½®æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯cloud-initç”¨æˆ·é…ç½®


**ğŸ’¡ åŸºæœ¬æ¦‚å¿µ**ï¼š
cloud-initçš„ç”¨æˆ·é…ç½®æ˜¯äº‘ä¸»æœºåˆå§‹åŒ–è¿‡ç¨‹ä¸­**è‡ªåŠ¨åˆ›å»ºå’Œç®¡ç†ç”¨æˆ·è´¦æˆ·**çš„æ ¸å¿ƒåŠŸèƒ½ã€‚å®ƒè®©æˆ‘ä»¬å¯ä»¥åœ¨äº‘ä¸»æœºç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œå°±è‡ªåŠ¨å®Œæˆç”¨æˆ·åˆ›å»ºã€æƒé™é…ç½®ã€SSHè®¿é—®ç­‰æ‰€æœ‰ç”¨æˆ·ç›¸å…³çš„è®¾ç½®ã€‚

```
ä¼ ç»Ÿæ–¹å¼ vs cloud-initæ–¹å¼ï¼š

ä¼ ç»Ÿæ‰‹åŠ¨é…ç½®ï¼š
1. äº‘ä¸»æœºå¯åŠ¨ â†’ 2. æ‰‹åŠ¨ç™»å½• â†’ 3. åˆ›å»ºç”¨æˆ· â†’ 4. é…ç½®SSH â†’ 5. è®¾ç½®æƒé™

cloud-initè‡ªåŠ¨åŒ–ï¼š
1. ç¼–å†™é…ç½®æ–‡ä»¶ â†’ 2. äº‘ä¸»æœºå¯åŠ¨ â†’ 3. æ‰€æœ‰ç”¨æˆ·é…ç½®è‡ªåŠ¨å®Œæˆï¼
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç”¨æˆ·è‡ªåŠ¨åŒ–é…ç½®


**ğŸ¯ æ ¸å¿ƒä»·å€¼**ï¼š
- **æ‰¹é‡éƒ¨ç½²**ï¼šåŒæ—¶é…ç½®æˆç™¾ä¸Šåƒå°æœåŠ¡å™¨çš„ç”¨æˆ·
- **æ ‡å‡†åŒ–ç®¡ç†**ï¼šç¡®ä¿æ‰€æœ‰æœåŠ¡å™¨çš„ç”¨æˆ·é…ç½®ä¸€è‡´
- **å®‰å…¨æ€§æå‡**ï¼šè‡ªåŠ¨æ³¨å…¥SSHå¯†é’¥ï¼Œé¿å…å¯†ç ç™»å½•é£é™©
- **è¿ç»´æ•ˆç‡**ï¼šä»æ‰‹åŠ¨é…ç½®å‡ åˆ†é’Ÿå˜æˆè‡ªåŠ¨åŒ–å‡ ç§’é’Ÿ

> ğŸ’­ **å®é™…åœºæ™¯**ï¼šå‡è®¾ä½ è¦éƒ¨ç½²100å°WebæœåŠ¡å™¨ï¼Œä¼ ç»Ÿæ–¹å¼éœ€è¦é€å°ç™»å½•é…ç½®ç”¨æˆ·ï¼Œè€Œcloud-initå¯ä»¥è®©æ‰€æœ‰æœåŠ¡å™¨å¯åŠ¨æ—¶å°±è‡ªåŠ¨å®Œæˆç”¨æˆ·é…ç½®ã€‚

### 1.3 cloud-initç”¨æˆ·é…ç½®çš„å·¥ä½œåŸç†


**ğŸ”„ æ‰§è¡Œæµç¨‹å›¾**ï¼š
```
äº‘ä¸»æœºå¯åŠ¨
    â†“
cloud-initè¯»å–ç”¨æˆ·é…ç½®
    â†“
è§£æusersæ¨¡å—é…ç½®
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¹¶è¡Œæ‰§è¡Œé…ç½®   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ åˆ›å»ºç”¨æˆ·è´¦æˆ·  â”‚
â”‚ â€¢ æ³¨å…¥SSHå¯†é’¥   â”‚
â”‚ â€¢ é…ç½®sudoæƒé™  â”‚
â”‚ â€¢ è®¾ç½®ç”¨æˆ·ç»„    â”‚
â”‚ â€¢ é…ç½®shellç¯å¢ƒ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç”¨æˆ·é…ç½®å®Œæˆï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
```

---

## 2. âš™ï¸ usersæ¨¡å—æ ¸å¿ƒåŠŸèƒ½


### 2.1 usersæ¨¡å—æ˜¯ä»€ä¹ˆ


**ğŸ“‹ æ¨¡å—å®šä¹‰**ï¼š
`users`æ˜¯cloud-initä¸­ä¸“é—¨è´Ÿè´£**ç”¨æˆ·è´¦æˆ·ç®¡ç†**çš„é…ç½®æ¨¡å—ã€‚å®ƒå¯ä»¥åˆ›å»ºæ–°ç”¨æˆ·ã€ä¿®æ”¹ç°æœ‰ç”¨æˆ·ã€é…ç½®ç”¨æˆ·å±æ€§ç­‰ã€‚

### 2.2 usersæ¨¡å—çš„åŸºæœ¬è¯­æ³•ç»“æ„


**åŸºç¡€é…ç½®æ ¼å¼**ï¼š
```yaml
users:
  - name: ç”¨æˆ·å
    groups: ç”¨æˆ·ç»„åˆ—è¡¨
    sudo: sudoæƒé™é…ç½®
    shell: ç™»å½•shell
    ssh_authorized_keys: SSHå…¬é’¥åˆ—è¡¨
    passwd: å¯†ç ï¼ˆåŠ å¯†åï¼‰
    lock_passwd: æ˜¯å¦é”å®šå¯†ç ç™»å½•
```

### 2.3 å®Œæ•´çš„usersé…ç½®ç¤ºä¾‹


```yaml
#cloud-config
users:
  # åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
  - name: admin
    groups: [wheel, docker, sudo]
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ... admin@company.com
    lock_passwd: true
    
  # åˆ›å»ºå¼€å‘ç”¨æˆ·
  - name: developer
    groups: [developers, docker]
    sudo: ['ALL=(ALL) PASSWD:/usr/bin/systemctl', '/usr/bin/docker']
    shell: /bin/zsh
    passwd: '$6$rounds=4096$aQ7lQ...'  # åŠ å¯†å¯†ç 
    lock_passwd: false
```

> ğŸ”§ **é…ç½®è§£é‡Š**ï¼š
> - `groups`ï¼šç”¨æˆ·æ‰€å±çš„ç»„
> - `sudo`ï¼šsudoæƒé™è§„åˆ™
> - `lock_passwd`ï¼štrueè¡¨ç¤ºç¦ç”¨å¯†ç ç™»å½•ï¼Œåªèƒ½ç”¨SSHå¯†é’¥

### 2.4 usersæ¨¡å—æ”¯æŒçš„ç”¨æˆ·å±æ€§


| å±æ€§å | ä½œç”¨ | ç¤ºä¾‹å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| **name** | ç”¨æˆ·å | `admin` | å¿…å¡«å­—æ®µï¼Œç³»ç»Ÿç”¨æˆ·å |
| **groups** | ç”¨æˆ·ç»„ | `[sudo, docker]` | ç”¨æˆ·æ‰€å±çš„ç»„åˆ—è¡¨ |
| **sudo** | sudoæƒé™ | `ALL=(ALL) NOPASSWD:ALL` | sudoå‘½ä»¤æƒé™é…ç½® |
| **shell** | ç™»å½•shell | `/bin/bash` | ç”¨æˆ·é»˜è®¤çš„shell |
| **ssh_authorized_keys** | SSHå…¬é’¥ | `ssh-rsa AAAA...` | SSHç™»å½•å…¬é’¥åˆ—è¡¨ |
| **passwd** | å¯†ç  | `$6$rounds=...` | åŠ å¯†åçš„å¯†ç  |
| **lock_passwd** | é”å®šå¯†ç  | `true/false` | æ˜¯å¦ç¦ç”¨å¯†ç ç™»å½• |
| **home** | å®¶ç›®å½• | `/home/admin` | ç”¨æˆ·å®¶ç›®å½•è·¯å¾„ |
| **uid** | ç”¨æˆ·ID | `1001` | æŒ‡å®šç”¨æˆ·ID |

---

## 3. ğŸ” SSHå¯†é’¥è‡ªåŠ¨æ³¨å…¥æœºåˆ¶


### 3.1 ä»€ä¹ˆæ˜¯SSHå¯†é’¥æ³¨å…¥


**ğŸ”‘ æ¦‚å¿µè§£é‡Š**ï¼š
SSHå¯†é’¥æ³¨å…¥æ˜¯æŒ‡åœ¨äº‘ä¸»æœºå¯åŠ¨æ—¶ï¼Œ**è‡ªåŠ¨å°†SSHå…¬é’¥å†™å…¥ç”¨æˆ·çš„æˆæƒå¯†é’¥æ–‡ä»¶**ä¸­ï¼Œè®©ç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨ç§é’¥ç™»å½•ï¼Œæ— éœ€è¾“å…¥å¯†ç ã€‚

```
SSHå¯†é’¥ç™»å½•åŸç†ï¼š
å®¢æˆ·ç«¯ï¼ˆç§é’¥ï¼‰â†â†’ æœåŠ¡å™¨ï¼ˆå…¬é’¥ï¼‰

ä¼ ç»Ÿæ–¹å¼ï¼šæ‰‹åŠ¨å°†å…¬é’¥å¤åˆ¶åˆ° ~/.ssh/authorized_keys
cloud-initï¼šè‡ªåŠ¨æ³¨å…¥å…¬é’¥åˆ°authorized_keysæ–‡ä»¶
```

### 3.2 SSHå¯†é’¥é…ç½®æ–¹æ³•


**æ–¹æ³•ä¸€ï¼šå•ä¸ªå¯†é’¥æ³¨å…¥**
```yaml
users:
  - name: admin
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC7... admin@laptop
```

**æ–¹æ³•äºŒï¼šå¤šä¸ªå¯†é’¥æ³¨å…¥**
```yaml
users:
  - name: devops
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC7... devops@laptop
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQD9... devops@desktop
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... devops@mobile
```

**æ–¹æ³•ä¸‰ï¼šä»å…ƒæ•°æ®è·å–å¯†é’¥**
```yaml
users:
  - name: admin
    ssh_import_id: 
      - gh:username        # ä»GitHubå¯¼å…¥
      - lp:username        # ä»Launchpadå¯¼å…¥
```

### 3.3 SSHå¯†é’¥æ³¨å…¥çš„å®‰å…¨ä¼˜åŠ¿


**ğŸ›¡ï¸ å®‰å…¨å¯¹æ¯”**ï¼š

| è®¤è¯æ–¹å¼ | å®‰å…¨æ€§ | ä¾¿åˆ©æ€§ | é£é™©ç‚¹ |
|----------|--------|--------|--------|
| **å¯†ç ç™»å½•** | â­â­ | â­â­â­ | æš´åŠ›ç ´è§£ã€å¯†ç æ³„éœ² |
| **SSHå¯†é’¥** | â­â­â­â­â­ | â­â­â­â­ | ç§é’¥æ³„éœ²ï¼ˆæ¦‚ç‡æä½ï¼‰ |

> âš ï¸ **æœ€ä½³å®è·µ**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®`lock_passwd: true`ï¼Œå®Œå…¨ç¦ç”¨å¯†ç ç™»å½•

### 3.4 SSHå¯†é’¥æ ¼å¼è¦æ±‚


**æ”¯æŒçš„å¯†é’¥ç±»å‹**ï¼š
- **RSAå¯†é’¥**ï¼š`ssh-rsa AAAAB3NzaC1yc2E...`
- **Ed25519å¯†é’¥**ï¼š`ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...`ï¼ˆæ¨èï¼‰
- **ECDSAå¯†é’¥**ï¼š`ecdsa-sha2-nistp256 AAAAE2VjZHNh...`

**ç”ŸæˆSSHå¯†é’¥ç¤ºä¾‹**ï¼š
```bash
# ç”ŸæˆEd25519å¯†é’¥ï¼ˆæ¨èï¼‰
ssh-keygen -t ed25519 -C "your_email@example.com"

# ç”ŸæˆRSAå¯†é’¥
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
```

---

## 4. ğŸ‘¤ é»˜è®¤ç”¨æˆ·é…ç½®è¯¦è§£


### 4.1 ä»€ä¹ˆæ˜¯é»˜è®¤ç”¨æˆ·


**ğŸ  æ¦‚å¿µè¯´æ˜**ï¼š
é»˜è®¤ç”¨æˆ·æ˜¯äº‘å¹³å°ä¸ºæ¯ä¸ªäº‘ä¸»æœº**è‡ªåŠ¨åˆ›å»ºçš„åˆå§‹ç”¨æˆ·**ï¼Œé€šå¸¸å…·æœ‰ç®¡ç†å‘˜æƒé™ã€‚ä¸åŒäº‘å¹³å°çš„é»˜è®¤ç”¨æˆ·åä¸åŒï¼š

```
å¸¸è§äº‘å¹³å°é»˜è®¤ç”¨æˆ·ï¼š
â€¢ Ubuntuç³»ç»Ÿï¼šubuntu
â€¢ CentOSç³»ç»Ÿï¼šcentos æˆ– ec2-user
â€¢ Amazon Linuxï¼šec2-user
â€¢ Debianç³»ç»Ÿï¼šdebian
```

### 4.2 é»˜è®¤ç”¨æˆ·çš„é…ç½®æ–¹å¼


**æ–¹æ³•ä¸€ï¼šä¿®æ”¹é»˜è®¤ç”¨æˆ·å±æ€§**
```yaml
#cloud-config
system_info:
  default_user:
    name: ubuntu          # é»˜è®¤ç”¨æˆ·å
    groups: [sudo, docker]
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: true     # ç¦ç”¨å¯†ç ç™»å½•
```

**æ–¹æ³•äºŒï¼šä¸ºé»˜è®¤ç”¨æˆ·æ·»åŠ SSHå¯†é’¥**
```yaml
ssh_authorized_keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC... admin@company.com
  - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... admin@laptop
```

> ğŸ’¡ **æ³¨æ„åŒºåˆ«**ï¼š
> - `ssh_authorized_keys`åœ¨é¡¶çº§é…ç½®ï¼šä¸ºé»˜è®¤ç”¨æˆ·æ·»åŠ å¯†é’¥
> - `ssh_authorized_keys`åœ¨usersé…ç½®ï¼šä¸ºæŒ‡å®šç”¨æˆ·æ·»åŠ å¯†é’¥

### 4.3 é»˜è®¤ç”¨æˆ·ä¸è‡ªå®šä¹‰ç”¨æˆ·çš„å…³ç³»


**ğŸ‘¥ ç”¨æˆ·ç®¡ç†ç­–ç•¥**ï¼š

```yaml
#cloud-config
# ç­–ç•¥1ï¼šä¿ç•™é»˜è®¤ç”¨æˆ·ï¼Œæ·»åŠ è‡ªå®šä¹‰ç”¨æˆ·
users:
  - default  # ä¿ç•™é»˜è®¤ç”¨æˆ·ï¼ˆå¦‚ubuntuï¼‰
  - name: admin
    groups: [sudo]
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2E...

# ç­–ç•¥2ï¼šç¦ç”¨é»˜è®¤ç”¨æˆ·ï¼Œåªä½¿ç”¨è‡ªå®šä¹‰ç”¨æˆ·
users:
  - name: admin
    groups: [sudo]
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2E...
# ä¸åŒ…å«defaultï¼Œé»˜è®¤ç”¨æˆ·ä¸ä¼šè¢«åˆ›å»º
```

### 4.4 é»˜è®¤ç”¨æˆ·çš„æœ€ä½³å®è·µ


**ğŸ¯ æ¨èé…ç½®**ï¼š
```yaml
#cloud-config
# ä¸ºé»˜è®¤ç”¨æˆ·é…ç½®SSHå¯†é’¥
ssh_authorized_keys:
  - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... admin@company.com

# ç¦ç”¨å¯†ç ç™»å½•
ssh_pwauth: false

# ç¦ç”¨rootç™»å½•
disable_root: true

# è‡ªå®šä¹‰ç®¡ç†ç”¨æˆ·
users:
  - default  # ä¿ç•™é»˜è®¤ç”¨æˆ·ä½œä¸ºå¤‡ç”¨
  - name: admin
    groups: [sudo, docker]
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... admin@company.com
    lock_passwd: true
```

---

## 5. ğŸ”“ sudoæƒé™è‡ªåŠ¨é…ç½®


### 5.1 ä»€ä¹ˆæ˜¯sudoæƒé™


**âš¡ æ¦‚å¿µè§£é‡Š**ï¼š
sudoï¼ˆSuper User Doï¼‰æ˜¯Linuxç³»ç»Ÿä¸­è®©**æ™®é€šç”¨æˆ·ä¸´æ—¶è·å¾—ç®¡ç†å‘˜æƒé™**çš„æœºåˆ¶ã€‚é€šè¿‡sudoï¼Œç”¨æˆ·å¯ä»¥æ‰§è¡Œéœ€è¦rootæƒé™çš„å‘½ä»¤ï¼Œè€Œæ— éœ€çŸ¥é“rootå¯†ç ã€‚

```
sudoæƒé™å·¥ä½œåŸç†ï¼š
æ™®é€šç”¨æˆ· â†’ sudoå‘½ä»¤ â†’ ä¸´æ—¶è·å¾—rootæƒé™ â†’ æ‰§è¡Œç®¡ç†å‘˜æ“ä½œ

ä¼ ç»Ÿé…ç½®ï¼šæ‰‹åŠ¨ç¼–è¾‘ /etc/sudoers æ–‡ä»¶
cloud-initï¼šè‡ªåŠ¨é…ç½®sudoæƒé™è§„åˆ™
```

### 5.2 sudoæƒé™é…ç½®è¯­æ³•


**åŸºæœ¬é…ç½®æ ¼å¼**ï¼š
```yaml
users:
  - name: username
    sudo: sudoæƒé™è§„åˆ™
```

**å¸¸ç”¨sudoæƒé™é…ç½®**ï¼š

```yaml
users:
  # å®Œå…¨ç®¡ç†å‘˜æƒé™ï¼ˆæ— éœ€å¯†ç ï¼‰
  - name: admin
    sudo: ALL=(ALL) NOPASSWD:ALL
    
  # å®Œå…¨ç®¡ç†å‘˜æƒé™ï¼ˆéœ€è¦å¯†ç ï¼‰
  - name: manager
    sudo: ALL=(ALL:ALL) ALL
    
  # é™åˆ¶ç‰¹å®šå‘½ä»¤æƒé™
  - name: developer
    sudo: 
      - ALL=(ALL) NOPASSWD:/usr/bin/systemctl
      - ALL=(ALL) NOPASSWD:/usr/bin/docker
      - ALL=(ALL) PASSWD:/usr/sbin/reboot
    
  # é™åˆ¶ç”¨æˆ·å’Œå‘½ä»¤
  - name: webadmin
    sudo: ALL=(www-data) NOPASSWD:/usr/bin/nginx
```

### 5.3 sudoæƒé™è§„åˆ™è¯¦è§£


**ğŸ” æƒé™è§„åˆ™æ ¼å¼**ï¼š
```
ç”¨æˆ· ä¸»æœº=(è¿è¡Œç”¨æˆ·:è¿è¡Œç»„) æ˜¯å¦éœ€è¦å¯†ç :å‘½ä»¤åˆ—è¡¨

ç¤ºä¾‹è§£æï¼š
ALL=(ALL) NOPASSWD:ALL
â†‘   â†‘    â†‘        â†‘
â”‚   â”‚    â”‚        â””â”€ å¯æ‰§è¡Œæ‰€æœ‰å‘½ä»¤
â”‚   â”‚    â””â”€ æ— éœ€è¾“å…¥å¯†ç 
â”‚   â””â”€ å¯ä»¥ä»¥ä»»ä½•ç”¨æˆ·èº«ä»½è¿è¡Œ
â””â”€ åœ¨ä»»ä½•ä¸»æœºä¸Šæœ‰æ•ˆ
```

**å¸¸ç”¨æƒé™ç»„åˆ**ï¼š

| é…ç½® | å«ä¹‰ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `ALL=(ALL) NOPASSWD:ALL` | å®Œå…¨ç®¡ç†å‘˜æƒé™ï¼Œå…å¯†ç  | è‡ªåŠ¨åŒ–è„šæœ¬ã€è¿ç»´è´¦æˆ· |
| `ALL=(ALL:ALL) ALL` | å®Œå…¨ç®¡ç†å‘˜æƒé™ï¼Œéœ€å¯†ç  | äººå·¥æ“ä½œçš„ç®¡ç†å‘˜ |
| `ALL=(ALL) NOPASSWD:/usr/bin/systemctl` | åªèƒ½ç®¡ç†ç³»ç»ŸæœåŠ¡ | åº”ç”¨éƒ¨ç½²è´¦æˆ· |
| `ALL=(www-data) NOPASSWD:ALL` | ä»¥www-dataç”¨æˆ·èº«ä»½è¿è¡Œ | Webåº”ç”¨ç®¡ç† |

### 5.4 sudoæƒé™çš„å®‰å…¨è€ƒè™‘


**ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ**ï¼š

```yaml
# å®‰å…¨é…ç½®ç¤ºä¾‹
users:
  # è¿ç»´ç®¡ç†å‘˜ï¼šå®Œå…¨æƒé™ä½†éœ€è¦å¯†ç ç¡®è®¤
  - name: sysadmin
    sudo: ALL=(ALL:ALL) ALL
    ssh_authorized_keys: [...]
    lock_passwd: true
    
  # åº”ç”¨éƒ¨ç½²ï¼šä»…é™å¿…è¦çš„æœåŠ¡ç®¡ç†æƒé™
  - name: deployer
    sudo: 
      - ALL=(ALL) NOPASSWD:/usr/bin/systemctl start myapp
      - ALL=(ALL) NOPASSWD:/usr/bin/systemctl stop myapp
      - ALL=(ALL) NOPASSWD:/usr/bin/systemctl restart myapp
      - ALL=(ALL) NOPASSWD:/usr/bin/systemctl status myapp
    
  # å¼€å‘è€…ï¼šé™åˆ¶å±é™©æ“ä½œ
  - name: developer
    sudo:
      - ALL=(ALL) PASSWD:/usr/sbin/reboot
      - ALL=(ALL) NOPASSWD:/usr/bin/docker
```

> âš ï¸ **å®‰å…¨æé†’**ï¼š
> - ç”Ÿäº§ç¯å¢ƒé¿å…ä½¿ç”¨`NOPASSWD:ALL`
> - æŒ‰æœ€å°æƒé™åŸåˆ™åˆ†é…sudoæƒé™
> - å®šæœŸå®¡è®¡sudoæƒé™é…ç½®

---

## 6. ğŸ”’ å¯†ç è®¾ç½®ä¸è¿‡æœŸç­–ç•¥


### 6.1 ç”¨æˆ·å¯†ç é…ç½®


**ğŸ” å¯†ç è®¾ç½®æ¦‚å¿µ**ï¼š
åœ¨cloud-initä¸­ï¼Œç”¨æˆ·å¯†ç éœ€è¦ä½¿ç”¨**åŠ å¯†åçš„å¯†ç å“ˆå¸Œ**ï¼Œè€Œä¸æ˜¯æ˜æ–‡å¯†ç ã€‚è¿™ç¡®ä¿äº†é…ç½®æ–‡ä»¶çš„å®‰å…¨æ€§ã€‚

### 6.2 å¯†ç å“ˆå¸Œç”Ÿæˆæ–¹æ³•


**ç”ŸæˆåŠ å¯†å¯†ç çš„æ–¹æ³•**ï¼š

**æ–¹æ³•ä¸€ï¼šä½¿ç”¨mkpasswdå‘½ä»¤**
```bash
# å®‰è£…mkpasswdï¼ˆUbuntu/Debianï¼‰
sudo apt-get install whois

# ç”ŸæˆSHA-512å¯†ç å“ˆå¸Œ
mkpasswd -m sha-512 "ä½ çš„å¯†ç "
# è¾“å‡ºï¼š$6$rounds=4096$aQ7lQ...[é•¿å­—ç¬¦ä¸²]
```

**æ–¹æ³•äºŒï¼šä½¿ç”¨Pythonç”Ÿæˆ**
```bash
python3 -c "import crypt; print(crypt.crypt('ä½ çš„å¯†ç ', crypt.mksalt(crypt.METHOD_SHA512)))"
```

**æ–¹æ³•ä¸‰ï¼šä½¿ç”¨opensslç”Ÿæˆ**
```bash
openssl passwd -6 "ä½ çš„å¯†ç "
```

### 6.3 å¯†ç é…ç½®ç¤ºä¾‹


**åŸºæœ¬å¯†ç é…ç½®**ï¼š
```yaml
users:
  - name: developer
    passwd: '$6$rounds=4096$aQ7lQ2x.$Z8dN...'  # åŠ å¯†åçš„å¯†ç 
    lock_passwd: false                          # å…è®¸å¯†ç ç™»å½•
    
  - name: admin  
    passwd: '$6$rounds=4096$bR8mS3y.$A9fM...'  # åŠ å¯†åçš„å¯†ç 
    lock_passwd: true                           # ç¦ç”¨å¯†ç ç™»å½•ï¼Œåªèƒ½SSHå¯†é’¥
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...
```

### 6.4 å¯†ç è¿‡æœŸç­–ç•¥é…ç½®


**ğŸ—“ï¸ å¯†ç è¿‡æœŸè®¾ç½®**ï¼š
```yaml
users:
  - name: employee
    passwd: '$6$rounds=4096$...'
    lock_passwd: false
    # å¯†ç è¿‡æœŸé…ç½®
    inactive: 30        # å¯†ç è¿‡æœŸ30å¤©åè´¦æˆ·é”å®š
    expire: '2024-12-31' # è´¦æˆ·åœ¨æŒ‡å®šæ—¥æœŸè¿‡æœŸ
```

**é«˜çº§å¯†ç ç­–ç•¥é…ç½®**ï¼š
```yaml
#cloud-config
users:
  - name: contractor
    passwd: '$6$rounds=4096$...'
    lock_passwd: false
    # é¦–æ¬¡ç™»å½•å¼ºåˆ¶ä¿®æ”¹å¯†ç 
    passwd_expire: true

# å…¨å±€å¯†ç ç­–ç•¥é…ç½®
write_files:
  - path: /etc/login.defs
    content: |
      PASS_MAX_DAYS 90      # å¯†ç æœ€é•¿æœ‰æ•ˆæœŸ90å¤©
      PASS_MIN_DAYS 1       # å¯†ç æœ€çŸ­æœ‰æ•ˆæœŸ1å¤©
      PASS_WARN_AGE 7       # å¯†ç è¿‡æœŸå‰7å¤©è­¦å‘Š
    append: true
```

### 6.5 å¯†ç å®‰å…¨æœ€ä½³å®è·µ


**ğŸ¯ å®‰å…¨å»ºè®®**ï¼š

> ğŸ’¡ **å¯†ç vs SSHå¯†é’¥é€‰æ‹©æŒ‡å—**ï¼š
> - **ç”Ÿäº§ç¯å¢ƒ**ï¼šæ¨èSSHå¯†é’¥ + `lock_passwd: true`
> - **å¼€å‘ç¯å¢ƒ**ï¼šå¯ä»¥ä½¿ç”¨å¯†ç ï¼Œä½†è¦è®¾ç½®å¤æ‚å¯†ç 
> - **ä¸´æ—¶è®¿é—®**ï¼šå¯†ç  + è¿‡æœŸç­–ç•¥
> - **æœåŠ¡è´¦æˆ·**ï¼šå®Œå…¨ç¦ç”¨å¯†ç ç™»å½•

```yaml
# æ¨èçš„å®‰å…¨é…ç½®
users:
  # ç®¡ç†å‘˜ï¼šåªå…è®¸SSHå¯†é’¥ç™»å½•
  - name: admin
    groups: [sudo]
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...
    lock_passwd: true                    # å®Œå…¨ç¦ç”¨å¯†ç 
    
  # ä¸´æ—¶ç”¨æˆ·ï¼šå¯†ç +è¿‡æœŸ
  - name: temp_user
    passwd: '$6$rounds=4096$...'
    lock_passwd: false
    expire: '2024-03-31'                 # ä¸´æ—¶è®¿é—®æœŸé™
    inactive: 7                          # è¿‡æœŸ7å¤©åé”å®š
```

---

## 7. ğŸ‘¥ ç”¨æˆ·ç»„è‡ªåŠ¨åˆ†é…


### 7.1 ä»€ä¹ˆæ˜¯ç”¨æˆ·ç»„


**ğŸ“‚ ç”¨æˆ·ç»„æ¦‚å¿µ**ï¼š
ç”¨æˆ·ç»„æ˜¯Linuxç³»ç»Ÿä¸­**ç®¡ç†ç”¨æˆ·æƒé™çš„é‡è¦æœºåˆ¶**ã€‚é€šè¿‡å°†ç”¨æˆ·åˆ†é…åˆ°ä¸åŒçš„ç»„ï¼Œå¯ä»¥æ‰¹é‡ç®¡ç†ç”¨æˆ·çš„æ–‡ä»¶è®¿é—®æƒé™å’Œç³»ç»ŸåŠŸèƒ½æƒé™ã€‚

```
ç”¨æˆ·ç»„æƒé™ç®¡ç†åŸç†ï¼š
ä¸ªäººæƒé™ + ç»„æƒé™ = ç”¨æˆ·æœ€ç»ˆæƒé™

ä¸¾ä¾‹ï¼š
developerç”¨æˆ· â†’ developersç»„ â†’ å¯ä»¥è®¿é—®/opt/projectsç›®å½•
developerç”¨æˆ· â†’ dockerç»„ â†’ å¯ä»¥è¿è¡Œdockerå‘½ä»¤
```

### 7.2 å¸¸è§ç³»ç»Ÿç”¨æˆ·ç»„


**ğŸ”§ é‡è¦ç³»ç»Ÿç»„è¯´æ˜**ï¼š

| ç”¨æˆ·ç»„ | ä½œç”¨ | å…¸å‹æƒé™ | ä½¿ç”¨åœºæ™¯ |
|--------|------|----------|----------|
| **sudo** | ç®¡ç†å‘˜ç»„ | æ‰§è¡Œsudoå‘½ä»¤ | ç³»ç»Ÿç®¡ç†å‘˜ |
| **wheel** | ç®¡ç†å‘˜ç»„ï¼ˆCentOSï¼‰ | æ‰§è¡Œsudoå‘½ä»¤ | CentOSç³»ç»Ÿç®¡ç† |
| **docker** | Dockerç»„ | è¿è¡Œdockerå‘½ä»¤ | å®¹å™¨ç®¡ç† |
| **www-data** | WebæœåŠ¡ç»„ | è®¿é—®webæ–‡ä»¶ | Webåº”ç”¨éƒ¨ç½² |
| **systemd-journal** | æ—¥å¿—ç»„ | æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿— | æ—¥å¿—åˆ†æ |
| **adm** | ç³»ç»Ÿç›‘æ§ç»„ | æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿— | ç³»ç»Ÿç›‘æ§ |

### 7.3 ç”¨æˆ·ç»„é…ç½®æ–¹æ³•


**åŸºæœ¬ç»„åˆ†é…é…ç½®**ï¼š
```yaml
users:
  # ç®¡ç†å‘˜ç”¨æˆ·ï¼šå¤šä¸ªç®¡ç†æƒé™ç»„
  - name: sysadmin
    groups: [sudo, adm, systemd-journal, docker]
    
  # å¼€å‘ç”¨æˆ·ï¼šå¼€å‘ç›¸å…³ç»„
  - name: developer
    groups: [developers, docker, www-data]
    
  # Webéƒ¨ç½²ç”¨æˆ·ï¼šWebç›¸å…³ç»„
  - name: webdeploy
    groups: [www-data, systemd-journal]
```

**æŒ‡å®šä¸»ç»„å’Œé™„åŠ ç»„**ï¼š
```yaml
users:
  - name: appuser
    primary_group: applications    # ä¸»ç»„
    groups: [docker, monitoring]   # é™„åŠ ç»„
```

### 7.4 è‡ªåŠ¨åˆ›å»ºç”¨æˆ·ç»„


**åˆ›å»ºè‡ªå®šä¹‰ç”¨æˆ·ç»„**ï¼š
```yaml
#cloud-config
# å…ˆåˆ›å»ºç”¨æˆ·ç»„
groups:
  - developers: [developer1, developer2]
  - operations: [ops1, ops2]
  - monitoring: []

# å†åˆ†é…ç”¨æˆ·åˆ°ç»„
users:
  - name: developer1
    groups: [developers, docker]
    
  - name: ops1
    groups: [operations, sudo, systemd-journal]
```

### 7.5 ç”¨æˆ·ç»„æƒé™å®è·µ


**ğŸ¯ å…¸å‹å›¢é˜Ÿæƒé™åˆ†é…**ï¼š

```yaml
#cloud-config
# åˆ›å»ºé¡¹ç›®ç›¸å…³çš„ç”¨æˆ·ç»„
groups:
  - devteam: []
  - opstteam: []
  - readonly: []

users:
  # å¼€å‘å›¢é˜Ÿ
  - name: dev1
    groups: [devteam, docker, www-data]
    sudo: ['ALL=(ALL) NOPASSWD:/usr/bin/systemctl restart myapp']
    
  - name: dev2  
    groups: [devteam, docker]
    sudo: ['ALL=(ALL) NOPASSWD:/usr/bin/docker']
    
  # è¿ç»´å›¢é˜Ÿ
  - name: ops1
    groups: [opsteam, sudo, adm, systemd-journal]
    sudo: 'ALL=(ALL) NOPASSWD:ALL'
    
  # åªè¯»æƒé™ç”¨æˆ·
  - name: monitor
    groups: [readonly, systemd-journal]
    # æ— sudoæƒé™ï¼Œåªèƒ½æŸ¥çœ‹
```

**æ–‡ä»¶æƒé™é…ç½®**ï¼š
```yaml
write_files:
  # ä¸ºå¼€å‘ç»„åˆ›å»ºé¡¹ç›®ç›®å½•
  - path: /opt/projects
    owner: root:devteam
    permissions: '0775'    # ç»„æˆå‘˜å¯å†™
    
  # ä¸ºè¿ç»´ç»„åˆ›å»ºæ—¥å¿—ç›®å½•  
  - path: /var/log/myapp
    owner: root:opsteam
    permissions: '0770'    # åªæœ‰è¿ç»´ç»„å¯è®¿é—®
```

---

## 8. ğŸš ç”¨æˆ·shellç¯å¢ƒé…ç½®


### 8.1 ä»€ä¹ˆæ˜¯ç”¨æˆ·shell


**ğŸ’» shellæ¦‚å¿µè¯´æ˜**ï¼š
shellæ˜¯ç”¨æˆ·ä¸Linuxç³»ç»Ÿ**äº¤äº’çš„å‘½ä»¤è¡Œç•Œé¢ç¨‹åº**ã€‚ä¸åŒçš„shellæä¾›ä¸åŒçš„åŠŸèƒ½å’Œä½¿ç”¨ä½“éªŒï¼Œå¸¸è§çš„æœ‰bashã€zshã€fishç­‰ã€‚

```
å¸¸è§shellå¯¹æ¯”ï¼š
â€¢ bashï¼šé»˜è®¤shellï¼Œå…¼å®¹æ€§æœ€å¥½ï¼ŒåŠŸèƒ½å®Œæ•´
â€¢ zshï¼šå¢å¼ºåŠŸèƒ½ï¼Œæ™ºèƒ½è¡¥å…¨ï¼Œä¸»é¢˜ä¸°å¯Œ  
â€¢ fishï¼šç”¨æˆ·å‹å¥½ï¼Œè¯­æ³•é«˜äº®ï¼Œè‡ªåŠ¨å»ºè®®
â€¢ dashï¼šè½»é‡çº§ï¼Œå¯åŠ¨å¿«ï¼Œè„šæœ¬æ‰§è¡Œå¿«
```

### 8.2 shellé…ç½®æ–¹æ³•


**åŸºæœ¬shellé…ç½®**ï¼š
```yaml
users:
  # ä½¿ç”¨bash shell
  - name: admin
    shell: /bin/bash
    
  # ä½¿ç”¨zsh shell  
  - name: developer
    shell: /bin/zsh
    
  # ä½¿ç”¨fish shell
  - name: designer
    shell: /usr/bin/fish
```

**å®‰è£…å¹¶é…ç½®zshç¤ºä¾‹**ï¼š
```yaml
#cloud-config
# å®‰è£…zshå’Œoh-my-zsh
packages:
  - zsh
  - git
  - curl

users:
  - name: developer
    shell: /bin/zsh
    groups: [sudo, docker]
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...

# å®‰è£…oh-my-zshæ¡†æ¶
runcmd:
  - su - developer -c 'sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"'
```

### 8.3 shellç¯å¢ƒå˜é‡é…ç½®


**ç¯å¢ƒå˜é‡è®¾ç½®**ï¼š
```yaml
write_files:
  # bashç¯å¢ƒé…ç½®
  - path: /home/admin/.bashrc
    owner: admin:admin
    permissions: '0644'
    content: |
      # è‡ªå®šä¹‰ç¯å¢ƒå˜é‡
      export PATH=$PATH:/opt/myapp/bin
      export JAVA_HOME=/usr/lib/jvm/java-11-openjdk
      export NODE_ENV=production
      
      # å‘½ä»¤åˆ«å
      alias ll='ls -la'
      alias grep='grep --color=auto'
      alias ..='cd ..'
      
      # å‘½ä»¤æç¤ºç¬¦è‡ªå®šä¹‰
      PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
    append: true
    
  # zshç¯å¢ƒé…ç½®  
  - path: /home/developer/.zshrc
    owner: developer:developer
    permissions: '0644'
    content: |
      # zshä¸»é¢˜
      ZSH_THEME="robbyrussell"
      
      # zshæ’ä»¶
      plugins=(git docker kubectl npm)
      
      # è‡ªå®šä¹‰ç¯å¢ƒå˜é‡
      export PATH=$PATH:/opt/tools/bin
      export EDITOR=vim
    append: true
```

### 8.4 shellé…ç½®æ–‡ä»¶ç®¡ç†


**ğŸ“„ é…ç½®æ–‡ä»¶è¯´æ˜**ï¼š

| é…ç½®æ–‡ä»¶ | ä½œç”¨èŒƒå›´ | æ‰§è¡Œæ—¶æœº | é€‚ç”¨shell |
|----------|----------|----------|-----------|
| **~/.bashrc** | å½“å‰ç”¨æˆ· | æ¯æ¬¡bashå¯åŠ¨ | bash |
| **~/.zshrc** | å½“å‰ç”¨æˆ· | æ¯æ¬¡zshå¯åŠ¨ | zsh |
| **~/.profile** | å½“å‰ç”¨æˆ· | ç™»å½•æ—¶æ‰§è¡Œ | æ‰€æœ‰shell |
| **/etc/profile** | å…¨éƒ¨ç”¨æˆ· | ç™»å½•æ—¶æ‰§è¡Œ | æ‰€æœ‰shell |
| **/etc/bash.bashrc** | å…¨éƒ¨ç”¨æˆ· | bashå¯åŠ¨æ—¶ | bash |

**ç»Ÿä¸€é…ç½®å¤šç”¨æˆ·shellç¯å¢ƒ**ï¼š
```yaml
write_files:
  # å…¨å±€bashé…ç½®
  - path: /etc/bash.bashrc
    content: |
      # å…¬å¸ç»Ÿä¸€é…ç½®
      export COMPANY_ENV=production
      export PATH=$PATH:/opt/company/bin
      
      # ç»Ÿä¸€åˆ«å
      alias company-deploy='/opt/company/bin/deploy.sh'
      alias company-logs='tail -f /var/log/company/app.log'
    append: true
    
  # å…¨å±€ç¯å¢ƒå˜é‡
  - path: /etc/environment
    content: |
      JAVA_HOME=/usr/lib/jvm/java-11-openjdk
      NODE_ENV=production
      COMPANY_CONFIG=/etc/company/config
    append: true
```

---

## 9. ğŸ‘« å¤šç”¨æˆ·æ‰¹é‡åˆ›å»º


### 9.1 æ‰¹é‡åˆ›å»ºç”¨æˆ·çš„åœºæ™¯


**ğŸ¢ å®é™…åº”ç”¨åœºæ™¯**ï¼š
- **å›¢é˜Ÿå¼€å‘ç¯å¢ƒ**ï¼šä¸ºæ•´ä¸ªå¼€å‘å›¢é˜Ÿåˆ›å»ºç”¨æˆ·è´¦æˆ·
- **åŸ¹è®­ç¯å¢ƒ**ï¼šä¸ºå­¦å‘˜æ‰¹é‡åˆ›å»ºä¸´æ—¶è´¦æˆ·  
- **å¤šç§Ÿæˆ·ç³»ç»Ÿ**ï¼šä¸ºä¸åŒå®¢æˆ·åˆ›å»ºéš”ç¦»çš„ç”¨æˆ·ç¯å¢ƒ
- **å¾®æœåŠ¡æ¶æ„**ï¼šä¸ºä¸åŒæœåŠ¡åˆ›å»ºä¸“ç”¨çš„è¿è¡Œç”¨æˆ·

### 9.2 æ‰¹é‡ç”¨æˆ·é…ç½®æ¨¡æ¿


**å¼€å‘å›¢é˜Ÿæ‰¹é‡é…ç½®**ï¼š
```yaml
#cloud-config
# åˆ›å»ºç”¨æˆ·ç»„
groups:
  - developers: []
  - testers: []
  - devops: []

users:
  # å¼€å‘å›¢é˜Ÿç”¨æˆ·
  - name: dev-alice
    groups: [developers, docker]
    shell: /bin/zsh
    sudo: ['ALL=(ALL) NOPASSWD:/usr/bin/systemctl restart myapp']
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... alice@company.com
    lock_passwd: true
    
  - name: dev-bob
    groups: [developers, docker]  
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:/usr/bin/systemctl restart myapp']
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ... bob@company.com
    lock_passwd: true
    
  # æµ‹è¯•å›¢é˜Ÿç”¨æˆ·
  - name: test-carol
    groups: [testers, systemd-journal]
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:/usr/bin/systemctl status myapp']
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... carol@company.com
    lock_passwd: true
    
  # è¿ç»´å›¢é˜Ÿç”¨æˆ·
  - name: ops-dave
    groups: [devops, sudo, adm]
    shell: /bin/bash
    sudo: 'ALL=(ALL) NOPASSWD:ALL'
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... dave@company.com
    lock_passwd: true
```

### 9.3 æ¨¡æ¿åŒ–ç”¨æˆ·é…ç½®


**ä½¿ç”¨YAMLé”šç‚¹ç®€åŒ–é…ç½®**ï¼š
```yaml
#cloud-config
# å®šä¹‰é€šç”¨é…ç½®æ¨¡æ¿
x-common-config: &common-config
  lock_passwd: true
  shell: /bin/bash
  groups: [docker]

# å®šä¹‰å¼€å‘è€…é…ç½®æ¨¡æ¿  
x-developer-config: &developer-config
  <<: *common-config
  groups: [developers, docker]
  sudo: ['ALL=(ALL) NOPASSWD:/usr/bin/systemctl restart myapp']

users:
  # ä½¿ç”¨æ¨¡æ¿å¿«é€Ÿé…ç½®å¤šä¸ªå¼€å‘è€…
  - name: dev1
    <<: *developer-config
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5... dev1@company.com
      
  - name: dev2
    <<: *developer-config
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5... dev2@company.com
      
  - name: dev3
    <<: *developer-config
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5... dev3@company.com
```

### 9.4 æœåŠ¡è´¦æˆ·æ‰¹é‡åˆ›å»º


**å¾®æœåŠ¡ç”¨æˆ·é…ç½®**ï¼š
```yaml
#cloud-config
# ä¸ºä¸åŒå¾®æœåŠ¡åˆ›å»ºä¸“ç”¨ç”¨æˆ·
users:
  # Webå‰ç«¯æœåŠ¡ç”¨æˆ·
  - name: web-frontend
    system: true           # ç³»ç»Ÿç”¨æˆ·ï¼Œä¸èƒ½ç™»å½•
    shell: /usr/sbin/nologin
    home: /opt/frontend
    groups: [www-data]
    
  # APIåç«¯æœåŠ¡ç”¨æˆ·  
  - name: api-backend
    system: true
    shell: /usr/sbin/nologin
    home: /opt/backend
    groups: [www-data]
    
  # æ•°æ®åº“æœåŠ¡ç”¨æˆ·
  - name: db-service
    system: true
    shell: /usr/sbin/nologin
    home: /opt/database
    groups: [database]
    
  # ç¼“å­˜æœåŠ¡ç”¨æˆ·
  - name: cache-service
    system: true
    shell: /usr/sbin/nologin
    home: /opt/cache
    groups: [cache]

# åˆ›å»ºå¯¹åº”çš„ç›®å½•å’Œæƒé™
write_files:
  - path: /opt/frontend
    owner: web-frontend:www-data
    permissions: '0755'
    
  - path: /opt/backend  
    owner: api-backend:www-data
    permissions: '0755'
```

### 9.5 ç”¨æˆ·é…ç½®çš„åŠ¨æ€ç®¡ç†


**é…ç½®è„šæœ¬åŒ–ç®¡ç†**ï¼š
```yaml
#cloud-config
write_files:
  # ç”¨æˆ·ç®¡ç†è„šæœ¬
  - path: /opt/scripts/user-manager.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      # æ‰¹é‡ç”¨æˆ·ç®¡ç†è„šæœ¬
      
      # æ‰¹é‡åˆ›å»ºå¼€å‘ç”¨æˆ·
      create_developers() {
          local users=("alice" "bob" "charlie" "diana")
          for user in "${users[@]}"; do
              useradd -m -s /bin/bash -G developers,docker "dev-$user"
              mkdir -p "/home/dev-$user/.ssh"
              # ä»å…¬å¸å¯†é’¥æœåŠ¡å™¨è·å–å…¬é’¥
              curl -s "https://keys.company.com/$user.pub" > "/home/dev-$user/.ssh/authorized_keys"
              chown -R "dev-$user:dev-$user" "/home/dev-$user/.ssh"
              chmod 700 "/home/dev-$user/.ssh"
              chmod 600 "/home/dev-$user/.ssh/authorized_keys"
          done
      }
      
      # æ ¹æ®å‚æ•°æ‰§è¡Œæ“ä½œ
      case "$1" in
          "create-dev") create_developers ;;
          *) echo "Usage: $0 {create-dev}" ;;
      esac

runcmd:
  # æ‰§è¡Œç”¨æˆ·åˆ›å»ºè„šæœ¬
  - /opt/scripts/user-manager.sh create-dev
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ cloud-initç”¨æˆ·é…ç½®ï¼šäº‘ä¸»æœºå¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºå’Œé…ç½®ç”¨æˆ·è´¦æˆ·
ğŸ”¸ usersæ¨¡å—ï¼šä¸“é—¨è´Ÿè´£ç”¨æˆ·è´¦æˆ·ç®¡ç†çš„é…ç½®æ¨¡å—
ğŸ”¸ SSHå¯†é’¥æ³¨å…¥ï¼šè‡ªåŠ¨å°†å…¬é’¥æ·»åŠ åˆ°ç”¨æˆ·æˆæƒæ–‡ä»¶ï¼Œå®ç°å…å¯†ç™»å½•
ğŸ”¸ sudoæƒé™é…ç½®ï¼šä¸ºç”¨æˆ·åˆ†é…ç®¡ç†å‘˜æƒé™ï¼Œæ”¯æŒç»†ç²’åº¦æƒé™æ§åˆ¶
ğŸ”¸ ç”¨æˆ·ç»„ç®¡ç†ï¼šé€šè¿‡ç»„æƒé™æ‰¹é‡ç®¡ç†ç”¨æˆ·çš„ç³»ç»Ÿè®¿é—®æƒé™
ğŸ”¸ shellç¯å¢ƒé…ç½®ï¼šä¸ºç”¨æˆ·é…ç½®å‘½ä»¤è¡Œäº¤äº’ç¯å¢ƒå’Œä¸ªæ€§åŒ–è®¾ç½®
```

### 10.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ å®‰å…¨é…ç½®åŸåˆ™**ï¼š
```
SSHå¯†é’¥ä¼˜äºå¯†ç ï¼š
â€¢ ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ lock_passwd: true
â€¢ SSHå¯†é’¥è‡ªåŠ¨æ³¨å…¥ï¼Œé¿å…æ‰‹åŠ¨é…ç½®
â€¢ æ”¯æŒå¤šå¯†é’¥ç®¡ç†ï¼Œæ–¹ä¾¿å›¢é˜Ÿåä½œ

sudoæƒé™æœ€å°åŒ–ï¼š
â€¢ æŒ‰éœ€åˆ†é…sudoæƒé™ï¼Œé¿å…è¿‡åº¦æˆæƒ
â€¢ åŒºåˆ†NOPASSWDå’ŒPASSWDæƒé™
â€¢ é™åˆ¶ç‰¹å®šå‘½ä»¤çš„æ‰§è¡Œæƒé™

ç”¨æˆ·åˆ†ç»„ç®¡ç†ï¼š
â€¢ é€šè¿‡ç”¨æˆ·ç»„å®ç°æƒé™æ‰¹é‡ç®¡ç†
â€¢ åˆ›å»ºä¸šåŠ¡ç›¸å…³çš„è‡ªå®šä¹‰ç”¨æˆ·ç»„
â€¢ åˆç†åˆ†é…ç³»ç»Ÿç»„æƒé™
```

**ğŸ”¹ é…ç½®æ¨¡æ¿åŒ–**ï¼š
```
ä½¿ç”¨YAMLé”šç‚¹ï¼š
â€¢ å®šä¹‰é€šç”¨é…ç½®æ¨¡æ¿ï¼Œå‡å°‘é‡å¤
â€¢ æ”¯æŒé…ç½®ç»§æ‰¿å’Œè¦†ç›–
â€¢ æé«˜é…ç½®çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§

æ‰¹é‡ç”¨æˆ·ç®¡ç†ï¼š
â€¢ å›¢é˜Ÿç”¨æˆ·ç»Ÿä¸€é…ç½®è§„èŒƒ
â€¢ æœåŠ¡è´¦æˆ·æ ‡å‡†åŒ–åˆ›å»º
â€¢ åŠ¨æ€ç”¨æˆ·ç®¡ç†è„šæœ¬
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- **å¼€å‘ç¯å¢ƒ**ï¼šå¿«é€Ÿä¸ºå¼€å‘å›¢é˜Ÿé…ç½®ç»Ÿä¸€çš„ç”¨æˆ·ç¯å¢ƒ
- **ç”Ÿäº§éƒ¨ç½²**ï¼šè‡ªåŠ¨åŒ–åˆ›å»ºè¿ç»´å’Œåº”ç”¨ç”¨æˆ·ï¼Œç¡®ä¿å®‰å…¨æ€§
- **åŸ¹è®­ç¯å¢ƒ**ï¼šæ‰¹é‡åˆ›å»ºå­¦å‘˜è´¦æˆ·ï¼Œç»Ÿä¸€æƒé™ç®¡ç†
- **å¾®æœåŠ¡æ¶æ„**ï¼šä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºä¸“ç”¨ç”¨æˆ·ï¼Œå®ç°æƒé™éš”ç¦»

**ğŸ”§ è¿ç»´å®è·µä»·å€¼**ï¼š
- **æ ‡å‡†åŒ–**ï¼šç¡®ä¿æ‰€æœ‰æœåŠ¡å™¨çš„ç”¨æˆ·é…ç½®ä¸€è‡´
- **è‡ªåŠ¨åŒ–**ï¼šä»æ‰‹åŠ¨é…ç½®è½¬å‘è‡ªåŠ¨åŒ–éƒ¨ç½²
- **å®‰å…¨æ€§**ï¼šç»Ÿä¸€çš„SSHå¯†é’¥ç®¡ç†å’Œæƒé™æ§åˆ¶
- **å¯å®¡è®¡**ï¼šé…ç½®å³ä»£ç ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶å’Œå®¡è®¡

> ğŸ§  **æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
> - cloud-initç”¨æˆ·é…ç½®æ˜¯äº‘ä¸»æœºè‡ªåŠ¨åŒ–ç®¡ç†çš„åŸºç¡€
> - SSHå¯†é’¥ + lock_passwdæ˜¯ç”Ÿäº§ç¯å¢ƒçš„å®‰å…¨æ ‡é…
> - sudoæƒé™è¦æŒ‰æœ€å°æƒé™åŸåˆ™åˆ†é…
> - ç”¨æˆ·ç»„æ˜¯æ‰¹é‡æƒé™ç®¡ç†çš„å…³é”®æœºåˆ¶
> - æ¨¡æ¿åŒ–é…ç½®èƒ½å¤§å¹…æé«˜è¿ç»´æ•ˆç‡

**æœ€ä½³å®è·µæ€»ç»“**ï¼š
1. **å®‰å…¨ä¼˜å…ˆ**ï¼šSSHå¯†é’¥è®¤è¯ + ç¦ç”¨å¯†ç ç™»å½•
2. **æƒé™æœ€å°åŒ–**ï¼šæŒ‰éœ€åˆ†é…sudoæƒé™ï¼Œé¿å…è¿‡åº¦æˆæƒ  
3. **åˆ†ç»„ç®¡ç†**ï¼šä½¿ç”¨ç”¨æˆ·ç»„å®ç°æƒé™çš„æ‰¹é‡å’Œå±‚æ¬¡åŒ–ç®¡ç†
4. **æ¨¡æ¿åŒ–**ï¼šä½¿ç”¨YAMLé”šç‚¹å’Œæ¨¡æ¿ç®€åŒ–æ‰¹é‡é…ç½®
5. **æ–‡æ¡£åŒ–**ï¼šé…ç½®å³ä»£ç ï¼Œä¾¿äºç‰ˆæœ¬ç®¡ç†å’Œå›¢é˜Ÿåä½œ