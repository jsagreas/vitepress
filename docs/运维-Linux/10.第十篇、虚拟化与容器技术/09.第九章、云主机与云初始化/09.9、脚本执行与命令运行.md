---
title: 9ã€è„šæœ¬æ‰§è¡Œä¸å‘½ä»¤è¿è¡Œ
---
## ğŸ“š ç›®å½•

1. [cloud-initè„šæœ¬æ‰§è¡Œæ¦‚è¿°](#1-cloud-initè„šæœ¬æ‰§è¡Œæ¦‚è¿°)
2. [runcmdå‘½ä»¤æ‰§è¡Œæ¨¡å—](#2-runcmdå‘½ä»¤æ‰§è¡Œæ¨¡å—)
3. [bootcmdå¯åŠ¨å‘½ä»¤æ‰§è¡Œ](#3-bootcmdå¯åŠ¨å‘½ä»¤æ‰§è¡Œ)
4. [è„šæœ¬æ‰§è¡Œæ—¶æœºæ§åˆ¶](#4-è„šæœ¬æ‰§è¡Œæ—¶æœºæ§åˆ¶)
5. [ç¯å¢ƒå˜é‡ä¸ç”¨æˆ·è®¾ç½®](#5-ç¯å¢ƒå˜é‡ä¸ç”¨æˆ·è®¾ç½®)
6. [é”™è¯¯å¤„ç†ä¸æ—¥å¿—è®°å½•](#6-é”™è¯¯å¤„ç†ä¸æ—¥å¿—è®°å½•)
7. [å¤šé˜¶æ®µè„šæœ¬æ‰§è¡Œç­–ç•¥](#7-å¤šé˜¶æ®µè„šæœ¬æ‰§è¡Œç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ cloud-initè„šæœ¬æ‰§è¡Œæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯cloud-initè„šæœ¬æ‰§è¡Œ


**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
```
cloud-initè„šæœ¬æ‰§è¡Œï¼šåœ¨äº‘ä¸»æœºå¯åŠ¨è¿‡ç¨‹ä¸­è‡ªåŠ¨è¿è¡Œå‘½ä»¤å’Œè„šæœ¬çš„æœºåˆ¶
ç›®çš„ï¼šå®ç°äº‘ä¸»æœºçš„è‡ªåŠ¨åŒ–é…ç½®å’Œåˆå§‹åŒ–
æœ¬è´¨ï¼šå°†æ‰‹åŠ¨æ“ä½œè½¬æ¢ä¸ºè‡ªåŠ¨åŒ–è„šæœ¬ï¼Œå®ç°"åŸºç¡€è®¾æ–½å³ä»£ç "
```

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šå°±åƒç»™æ–°ä¹°çš„ç”µè„‘å†™ä¸€ä¸ª"å¼€æœºè‡ªåŠ¨å®‰è£…è½¯ä»¶æ¸…å•"ï¼Œcloud-initå¸®ä½ åœ¨äº‘ä¸»æœºç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œè¿™äº›å®‰è£…å’Œé…ç½®ä»»åŠ¡ã€‚

### 1.2 è„šæœ¬æ‰§è¡Œçš„ä»·å€¼æ„ä¹‰


**ğŸ¯ æ ¸å¿ƒä»·å€¼**
```
è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼š
â€¢ æ¶ˆé™¤æ‰‹åŠ¨é…ç½®çš„ç¹çæ­¥éª¤
â€¢ ç¡®ä¿ç¯å¢ƒé…ç½®çš„ä¸€è‡´æ€§
â€¢ å‡å°‘äººä¸ºæ“ä½œé”™è¯¯

æ‰¹é‡ç®¡ç†ï¼š
â€¢ åŒæ—¶é…ç½®å¤§é‡äº‘ä¸»æœº
â€¢ ç»Ÿä¸€çš„æ ‡å‡†åŒ–ç¯å¢ƒ
â€¢ å¿«é€Ÿæ‰©å±•æœåŠ¡èƒ½åŠ›

ç‰ˆæœ¬æ§åˆ¶ï¼š
â€¢ é…ç½®å³ä»£ç ï¼Œå¯ä»¥ç‰ˆæœ¬ç®¡ç†
â€¢ é…ç½®å˜æ›´å¯è¿½è¸ª
â€¢ ä¾¿äºå›æ»šå’Œä¿®æ”¹
```

### 1.3 cloud-initæ‰§è¡Œé˜¶æ®µæ¦‚è§ˆ


**â±ï¸ æ‰§è¡Œæ—¶æœºå›¾ç¤º**
```
äº‘ä¸»æœºå¯åŠ¨æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç³»ç»Ÿå¼•å¯¼   â”‚â”€â”€â†’â”‚  ç½‘ç»œé…ç½®   â”‚â”€â”€â†’â”‚  ç”¨æˆ·åˆ›å»º   â”‚â”€â”€â†’â”‚  è„šæœ¬æ‰§è¡Œ   â”‚
â”‚  (boot)     â”‚   â”‚ (network)   â”‚   â”‚  (config)   â”‚   â”‚ (final)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                â†“                â†“                â†“
   bootcmd          ç½‘ç»œåˆå§‹åŒ–        ç”¨æˆ·é…ç½®          runcmd
  (æœ€æ—©æ‰§è¡Œ)        (è·å–å…ƒæ•°æ®)      (SSHå¯†é’¥)        (æœ€ç»ˆé…ç½®)
```

---

## 2. âš¡ runcmdå‘½ä»¤æ‰§è¡Œæ¨¡å—


### 2.1 runcmdåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
runcmdï¼šcloud-initçš„ä¸»è¦å‘½ä»¤æ‰§è¡Œæ¨¡å—
æ‰§è¡Œæ—¶æœºï¼šåœ¨ç³»ç»Ÿé…ç½®çš„æœ€åé˜¶æ®µè¿è¡Œ
ç‰¹ç‚¹ï¼šé€‚åˆå®‰è£…è½¯ä»¶ã€é…ç½®æœåŠ¡ã€éƒ¨ç½²åº”ç”¨
ç”¨æˆ·ç¯å¢ƒï¼šä»¥rootç”¨æˆ·èº«ä»½æ‰§è¡Œ
```

> ğŸ“Œ **é‡ç‚¹ç†è§£**ï¼šruncmdç›¸å½“äºä½ ç™»å½•äº‘ä¸»æœºåæ‰‹åŠ¨è¾“å…¥çš„å‘½ä»¤ï¼Œä½†å®ƒä¼šåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚

### 2.2 runcmdåŸºç¡€è¯­æ³•


**ğŸ’» åŸºæœ¬é…ç½®æ ¼å¼**
```yaml
#cloud-config
runcmd:
  # æ–¹å¼1ï¼šå­—ç¬¦ä¸²æ ¼å¼ï¼ˆshellè§£é‡Šæ‰§è¡Œï¼‰
  - "echo 'Hello World' > /tmp/hello.txt"
  
  # æ–¹å¼2ï¼šæ•°ç»„æ ¼å¼ï¼ˆç›´æ¥æ‰§è¡Œï¼Œæ›´å®‰å…¨ï¼‰
  - [ echo, "Hello World" ]
  
  # æ–¹å¼3ï¼šå¤šè¡Œå‘½ä»¤
  - |
    echo "å¼€å§‹é…ç½®ç³»ç»Ÿ"
    systemctl enable nginx
    systemctl start nginx
```

**ğŸ” è¯­æ³•å¯¹æ¯”è¯´æ˜**
```
å­—ç¬¦ä¸²æ ¼å¼ï¼š
- "apt update && apt install -y nginx"
ä¼˜ç‚¹ï¼šå†™æ³•ç®€å•ï¼Œæ”¯æŒshellç‰¹æ€§ï¼ˆç®¡é“ã€é‡å®šå‘ï¼‰
ç¼ºç‚¹ï¼šéœ€è¦shellè§£é‡Šï¼Œå¯èƒ½æœ‰å®‰å…¨é£é™©

æ•°ç»„æ ¼å¼ï¼š
- [ apt, update ]
- [ apt, install, -y, nginx ]
ä¼˜ç‚¹ï¼šç›´æ¥æ‰§è¡Œï¼Œæ›´å®‰å…¨ï¼Œå‚æ•°æ¸…æ™°
ç¼ºç‚¹ï¼šä¸æ”¯æŒshellç‰¹æ€§ï¼Œæ¯ä¸ªå‘½ä»¤éœ€è¦å•ç‹¬å†™
```

### 2.3 runcmdå®é™…åº”ç”¨ç¤ºä¾‹


**ğŸš€ WebæœåŠ¡å™¨è‡ªåŠ¨éƒ¨ç½²**
```yaml
#cloud-config
runcmd:
  # ç³»ç»Ÿæ›´æ–°
  - apt update
  - apt upgrade -y
  
  # å®‰è£…WebæœåŠ¡å™¨
  - apt install -y nginx
  
  # åˆ›å»ºç½‘ç«™ç›®å½•
  - mkdir -p /var/www/mysite
  
  # åˆ›å»ºç®€å•ç½‘é¡µ
  - |
    cat > /var/www/mysite/index.html << EOF
    <html>
    <head><title>æˆ‘çš„ç½‘ç«™</title></head>
    <body><h1>æ¬¢è¿è®¿é—®æˆ‘çš„äº‘ä¸»æœºï¼</h1></body>
    </html>
    EOF
  
  # é…ç½®nginx
  - |
    cat > /etc/nginx/sites-available/mysite << EOF
    server {
        listen 80;
        root /var/www/mysite;
        index index.html;
    }
    EOF
  
  # å¯ç”¨é…ç½®
  - ln -s /etc/nginx/sites-available/mysite /etc/nginx/sites-enabled/
  - systemctl reload nginx
```

**ğŸ“Š æ•°æ®åº“æœåŠ¡é…ç½®**
```yaml
runcmd:
  # å®‰è£…MySQL
  - apt install -y mysql-server
  
  # è®¾ç½®MySQL rootå¯†ç 
  - |
    mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'MyPassword123!';"
  
  # åˆ›å»ºåº”ç”¨æ•°æ®åº“
  - |
    mysql -u root -pMyPassword123! -e "
    CREATE DATABASE myapp;
    CREATE USER 'appuser'@'localhost' IDENTIFIED BY 'AppPass123!';
    GRANT ALL PRIVILEGES ON myapp.* TO 'appuser'@'localhost';
    FLUSH PRIVILEGES;
    "
  
  # å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
  - systemctl enable mysql
  - systemctl start mysql
```

---

## 3. ğŸ”„ bootcmdå¯åŠ¨å‘½ä»¤æ‰§è¡Œ


### 3.1 bootcmdåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
bootcmdï¼šcloud-initçš„æ—©æœŸå‘½ä»¤æ‰§è¡Œæ¨¡å—
æ‰§è¡Œæ—¶æœºï¼šåœ¨ç³»ç»Ÿå¯åŠ¨çš„æœ€æ—©é˜¶æ®µè¿è¡Œ
ç‰¹ç‚¹ï¼šé€‚åˆä¿®æ”¹ç³»ç»ŸåŸºç¡€é…ç½®ã€å‡†å¤‡ç¯å¢ƒ
é™åˆ¶ï¼šç½‘ç»œå¯èƒ½æœªé…ç½®ï¼Œç”¨æˆ·å¯èƒ½æœªåˆ›å»º
```

> âš ï¸ **é‡è¦åŒºåˆ«**ï¼šbootcmdåœ¨ç³»ç»Ÿåˆšå¯åŠ¨æ—¶æ‰§è¡Œï¼Œæ­¤æ—¶ç½‘ç»œå’Œç”¨æˆ·éƒ½å¯èƒ½è¿˜æ²¡å‡†å¤‡å¥½ï¼›runcmdåœ¨ç³»ç»Ÿé…ç½®å®Œæˆåæ‰§è¡Œï¼ŒåŠŸèƒ½æ›´å®Œæ•´ã€‚

### 3.2 bootcmdä¸runcmdå¯¹æ¯”


**ğŸ“‹ æ‰§è¡Œæ—¶æœºå¯¹æ¯”è¡¨**

| **ç‰¹æ€§** | **bootcmd** | **runcmd** |
|---------|------------|-----------|
| **æ‰§è¡Œæ—¶æœº** | `ç³»ç»Ÿå¯åŠ¨æ—©æœŸ` | `ç³»ç»Ÿé…ç½®å®Œæˆå` |
| **ç½‘ç»œçŠ¶æ€** | `å¯èƒ½æœªé…ç½®` | `å·²é…ç½®å®Œæˆ` |
| **ç”¨æˆ·ç¯å¢ƒ** | `å¯èƒ½æœªåˆ›å»º` | `ç”¨æˆ·å·²åˆ›å»º` |
| **é€‚ç”¨åœºæ™¯** | `ç³»ç»Ÿçº§åŸºç¡€é…ç½®` | `åº”ç”¨è½¯ä»¶å®‰è£…é…ç½®` |
| **æ‰§è¡Œé¢‘ç‡** | `æ¯æ¬¡å¯åŠ¨éƒ½æ‰§è¡Œ` | `é€šå¸¸åªæ‰§è¡Œä¸€æ¬¡` |

### 3.3 bootcmdå®é™…åº”ç”¨


**ğŸ”§ ç³»ç»ŸåŸºç¡€é…ç½®ç¤ºä¾‹**
```yaml
#cloud-config
bootcmd:
  # ä¿®æ”¹ç³»ç»Ÿæ—¶åŒºï¼ˆéœ€è¦åœ¨æ—©æœŸæ‰§è¡Œï¼‰
  - timedatectl set-timezone Asia/Shanghai
  
  # è®¾ç½®ç³»ç»Ÿä¸»æœºå
  - hostnamectl set-hostname myserver
  
  # é…ç½®å†…æ ¸å‚æ•°
  - echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf
  
  # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
  - mkdir -p /opt/myapp/logs
  - mkdir -p /opt/myapp/config
  
  # è®¾ç½®ç›®å½•æƒé™
  - chmod 755 /opt/myapp
```

**ğŸ›¡ï¸ å®‰å…¨é…ç½®ç¤ºä¾‹**
```yaml
bootcmd:
  # ç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡
  - systemctl disable bluetooth
  - systemctl disable cups
  
  # é…ç½®é˜²ç«å¢™åŸºç¡€è§„åˆ™
  - ufw --force enable
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  
  # ä¿®æ”¹SSHé…ç½®ï¼ˆæé«˜å®‰å…¨æ€§ï¼‰
  - sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
```

---

## 4. â° è„šæœ¬æ‰§è¡Œæ—¶æœºæ§åˆ¶


### 4.1 cloud-initæ‰§è¡Œé˜¶æ®µè¯¦è§£


**ğŸ”„ å®Œæ•´æ‰§è¡Œæµç¨‹**
```
Phase 1: Local
â”œâ”€ æ£€æµ‹æ•°æ®æº
â”œâ”€ è·å–æœ¬åœ°é…ç½®
â””â”€ åŸºç¡€ç½‘ç»œé…ç½®

Phase 2: Network  
â”œâ”€ è·å–ç½‘ç»œå…ƒæ•°æ®
â”œâ”€ åº”ç”¨ç½‘ç»œé…ç½®
â””â”€ å‡†å¤‡ç”¨æˆ·ç¯å¢ƒ

Phase 3: Config
â”œâ”€ åˆ›å»ºç”¨æˆ·è´¦æˆ·
â”œâ”€ é…ç½®SSHå¯†é’¥
â”œâ”€ å®‰è£…è½¯ä»¶åŒ…
â””â”€ æ‰§è¡Œé…ç½®å‘½ä»¤

Phase 4: Final
â”œâ”€ è¿è¡Œæœ€ç»ˆè„šæœ¬
â”œâ”€ è®¾ç½®å¼€æœºå¯åŠ¨
â””â”€ æ ‡è®°åˆå§‹åŒ–å®Œæˆ
```

### 4.2 ç²¾ç¡®æ§åˆ¶æ‰§è¡Œæ—¶æœº


**âš™ï¸ æ¡ä»¶æ‰§è¡Œé…ç½®**
```yaml
#cloud-config
# ä»…åœ¨é¦–æ¬¡å¯åŠ¨æ—¶æ‰§è¡Œ
cloud_final_modules:
  - scripts-user
  - final-message

# è®¾ç½®æ‰§è¡Œæ¡ä»¶
runcmd:
  # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œé¿å…é‡å¤æ‰§è¡Œ
  - |
    if [ ! -f /var/log/first-boot-complete ]; then
      echo "æ‰§è¡Œé¦–æ¬¡å¯åŠ¨é…ç½®..."
      # è¿™é‡Œæ”¾ç½®åªéœ€è¦æ‰§è¡Œä¸€æ¬¡çš„å‘½ä»¤
      apt update && apt upgrade -y
      # åˆ›å»ºæ ‡è®°æ–‡ä»¶
      touch /var/log/first-boot-complete
    fi
```

**ğŸ• å»¶è¿Ÿæ‰§è¡Œæ§åˆ¶**
```yaml
runcmd:
  # ç­‰å¾…ç½‘ç»œå®Œå…¨å°±ç»ª
  - |
    while ! ping -c 1 8.8.8.8 >/dev/null 2>&1; do
      echo "ç­‰å¾…ç½‘ç»œè¿æ¥..."
      sleep 5
    done
    echo "ç½‘ç»œå·²å°±ç»ªï¼Œå¼€å§‹ä¸‹è½½è½¯ä»¶"
  
  # ç­‰å¾…ç‰¹å®šæœåŠ¡å¯åŠ¨
  - |
    while ! systemctl is-active docker >/dev/null 2>&1; do
      echo "ç­‰å¾…DockeræœåŠ¡å¯åŠ¨..."
      sleep 3
    done
    echo "Dockerå·²å¯åŠ¨ï¼Œå¼€å§‹éƒ¨ç½²å®¹å™¨"
```

---

## 5. ğŸ” ç¯å¢ƒå˜é‡ä¸ç”¨æˆ·è®¾ç½®


### 5.1 ç¯å¢ƒå˜é‡é…ç½®


**ğŸŒ ç³»ç»Ÿç¯å¢ƒå˜é‡è®¾ç½®**
```yaml
#cloud-config
runcmd:
  # æ–¹å¼1ï¼šä¸´æ—¶è®¾ç½®ï¼ˆä»…å½“å‰æ‰§è¡Œæœ‰æ•ˆï¼‰
  - export MY_APP_ENV=production
  - echo "å½“å‰ç¯å¢ƒï¼š$MY_APP_ENV"
  
  # æ–¹å¼2ï¼šæ°¸ä¹…è®¾ç½®ï¼ˆå†™å…¥é…ç½®æ–‡ä»¶ï¼‰
  - echo 'export MY_APP_ENV=production' >> /etc/environment
  - echo 'export MY_APP_PORT=8080' >> /etc/environment
  
  # æ–¹å¼3ï¼šä¸ºç‰¹å®šç”¨æˆ·è®¾ç½®
  - echo 'export NODE_ENV=production' >> /home/ubuntu/.bashrc
  - echo 'export PATH=$PATH:/opt/myapp/bin' >> /home/ubuntu/.bashrc
```

**ğŸ“ ç¯å¢ƒå˜é‡éªŒè¯**
```yaml
runcmd:
  # é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡
  - source /etc/environment
  
  # éªŒè¯ç¯å¢ƒå˜é‡è®¾ç½®
  - |
    echo "=== ç¯å¢ƒå˜é‡æ£€æŸ¥ ==="
    echo "APP_ENV: $MY_APP_ENV"
    echo "APP_PORT: $MY_APP_PORT"
    echo "PATH: $PATH"
    echo "====================="
```

### 5.2 è„šæœ¬æ‰§è¡Œç”¨æˆ·æŒ‡å®š


**ğŸ‘¤ ç”¨æˆ·åˆ‡æ¢æ‰§è¡Œ**
```yaml
runcmd:
  # æ–¹å¼1ï¼šä½¿ç”¨sudoåˆ‡æ¢ç”¨æˆ·
  - sudo -u ubuntu mkdir /home/ubuntu/myproject
  - sudo -u ubuntu git clone https://github.com/user/repo.git /home/ubuntu/myproject
  
  # æ–¹å¼2ï¼šä½¿ç”¨suåˆ‡æ¢ç”¨æˆ·
  - su - ubuntu -c "cd /home/ubuntu && npm install"
  
  # æ–¹å¼3ï¼šç»„åˆä½¿ç”¨ï¼ˆæ¨èï¼‰
  - |
    # ä»¥ubuntuç”¨æˆ·èº«ä»½æ‰§è¡Œåº”ç”¨éƒ¨ç½²
    sudo -u ubuntu bash << 'EOF'
    cd /home/ubuntu
    git clone https://github.com/myuser/myapp.git
    cd myapp
    npm install
    npm run build
    EOF
```

**ğŸ”‘ æƒé™ç®¡ç†ç¤ºä¾‹**
```yaml
runcmd:
  # åˆ›å»ºåº”ç”¨ç›®å½•å¹¶è®¾ç½®æƒé™
  - mkdir -p /opt/myapp
  - chown ubuntu:ubuntu /opt/myapp
  - chmod 755 /opt/myapp
  
  # ä»¥æ™®é€šç”¨æˆ·èº«ä»½éƒ¨ç½²åº”ç”¨
  - |
    sudo -u ubuntu bash << 'EOF'
    cd /opt/myapp
    # ä¸‹è½½åº”ç”¨æ–‡ä»¶
    wget https://releases.example.com/myapp-v1.0.tar.gz
    tar -xzf myapp-v1.0.tar.gz
    # è®¾ç½®é…ç½®æ–‡ä»¶
    cp config.example.yml config.yml
    EOF
  
  # åˆ›å»ºç³»ç»ŸæœåŠ¡ï¼ˆéœ€è¦rootæƒé™ï¼‰
  - |
    cat > /etc/systemd/system/myapp.service << EOF
    [Unit]
    Description=My Application
    After=network.target
    
    [Service]
    Type=simple
    User=ubuntu
    WorkingDirectory=/opt/myapp
    ExecStart=/opt/myapp/bin/myapp
    Restart=always
    
    [Install]
    WantedBy=multi-user.target
    EOF
  
  # å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
  - systemctl daemon-reload
  - systemctl enable myapp
  - systemctl start myapp
```

---

## 6. ğŸ› ï¸ é”™è¯¯å¤„ç†ä¸æ—¥å¿—è®°å½•


### 6.1 é”™è¯¯å¤„ç†ç­–ç•¥


**âš ï¸ åŸºç¡€é”™è¯¯å¤„ç†**
```yaml
runcmd:
  # æ–¹å¼1ï¼šè®¾ç½®ä¸¥æ ¼æ¨¡å¼
  - set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
  - set -x  # æ˜¾ç¤ºæ‰§è¡Œçš„å‘½ä»¤
  
  # æ–¹å¼2ï¼šå•å‘½ä»¤é”™è¯¯å¤„ç†
  - apt update || echo "æ›´æ–°å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
  - apt install -y nginx || (echo "Nginxå®‰è£…å¤±è´¥" && exit 1)
  
  # æ–¹å¼3ï¼šå¤åˆå‘½ä»¤é”™è¯¯å¤„ç†
  - |
    if ! systemctl start nginx; then
      echo "Nginxå¯åŠ¨å¤±è´¥ï¼Œå°è¯•é‡æ–°å®‰è£…"
      apt remove -y nginx
      apt install -y nginx
      systemctl start nginx
    fi
```

**ğŸ”„ é‡è¯•æœºåˆ¶å®ç°**
```yaml
runcmd:
  # ç½‘ç»œæ“ä½œé‡è¯•
  - |
    for i in {1..3}; do
      if apt update; then
        echo "è½¯ä»¶æºæ›´æ–°æˆåŠŸ"
        break
      else
        echo "ç¬¬ $i æ¬¡å°è¯•å¤±è´¥ï¼Œç­‰å¾…é‡è¯•..."
        sleep 10
      fi
    done
  
  # æœåŠ¡å¯åŠ¨é‡è¯•
  - |
    retry_count=0
    max_retries=5
    while [ $retry_count -lt $max_retries ]; do
      if systemctl start docker; then
        echo "Dockerå¯åŠ¨æˆåŠŸ"
        break
      else
        retry_count=$((retry_count + 1))
        echo "Dockerå¯åŠ¨å¤±è´¥ï¼Œç¬¬ $retry_count æ¬¡é‡è¯•..."
        sleep 5
      fi
    done
```

### 6.2 æ—¥å¿—è®°å½•é…ç½®


**ğŸ“‹ è¯¦ç»†æ—¥å¿—è®°å½•**
```yaml
runcmd:
  # åˆ›å»ºæ—¥å¿—ç›®å½•
  - mkdir -p /var/log/cloud-init-custom
  
  # è®°å½•æ‰§è¡Œå¼€å§‹æ—¶é—´
  - echo "=== Cloud-initè‡ªå®šä¹‰è„šæœ¬å¼€å§‹ $(date) ===" >> /var/log/cloud-init-custom/setup.log
  
  # æ‰§è¡Œå‘½ä»¤å¹¶è®°å½•æ—¥å¿—
  - |
    {
      echo "å¼€å§‹å®‰è£…Docker..."
      apt update
      apt install -y docker.io
      systemctl enable docker
      systemctl start docker
      echo "Dockerå®‰è£…å®Œæˆ"
    } >> /var/log/cloud-init-custom/setup.log 2>&1
  
  # éªŒè¯å®‰è£…ç»“æœå¹¶è®°å½•
  - |
    if docker --version; then
      echo "Dockerå®‰è£…éªŒè¯æˆåŠŸ: $(docker --version)" >> /var/log/cloud-init-custom/setup.log
    else
      echo "Dockerå®‰è£…éªŒè¯å¤±è´¥" >> /var/log/cloud-init-custom/setup.log
    fi
  
  # è®°å½•æ‰§è¡Œç»“æŸæ—¶é—´
  - echo "=== Cloud-initè‡ªå®šä¹‰è„šæœ¬ç»“æŸ $(date) ===" >> /var/log/cloud-init-custom/setup.log
```

**ğŸ“Š çŠ¶æ€ç›‘æ§å’Œé€šçŸ¥**
```yaml
runcmd:
  # åˆ›å»ºçŠ¶æ€æ£€æŸ¥è„šæœ¬
  - |
    cat > /usr/local/bin/setup-status.sh << 'EOF'
    #!/bin/bash
    LOG_FILE="/var/log/cloud-init-custom/setup.log"
    STATUS_FILE="/var/log/cloud-init-status"
    
    if [ -f "$LOG_FILE" ]; then
      if grep -q "å®‰è£…éªŒè¯æˆåŠŸ" "$LOG_FILE"; then
        echo "SUCCESS" > "$STATUS_FILE"
        echo "äº‘ä¸»æœºåˆå§‹åŒ–æˆåŠŸå®Œæˆ"
      else
        echo "FAILED" > "$STATUS_FILE" 
        echo "äº‘ä¸»æœºåˆå§‹åŒ–å­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
      fi
    else
      echo "PENDING" > "$STATUS_FILE"
      echo "äº‘ä¸»æœºåˆå§‹åŒ–ä»åœ¨è¿›è¡Œä¸­"
    fi
    EOF
  
  - chmod +x /usr/local/bin/setup-status.sh
  
  # è®¾ç½®å®šæ—¶æ£€æŸ¥
  - echo "*/5 * * * * root /usr/local/bin/setup-status.sh" >> /etc/crontab
```

---

## 7. ğŸ¯ å¤šé˜¶æ®µè„šæœ¬æ‰§è¡Œç­–ç•¥


### 7.1 åˆ†é˜¶æ®µæ‰§è¡Œè®¾è®¡


**ğŸ“ˆ å¤šé˜¶æ®µæ‰§è¡Œæ¶æ„**
```
é˜¶æ®µè®¾è®¡æ€è·¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿå‡†å¤‡   â”‚â”€â”€â†’â”‚  è½¯ä»¶å®‰è£…   â”‚â”€â”€â†’â”‚  åº”ç”¨éƒ¨ç½²   â”‚â”€â”€â†’â”‚  æœåŠ¡å¯åŠ¨   â”‚
â”‚   Phase 1   â”‚   â”‚   Phase 2   â”‚   â”‚   Phase 3   â”‚   â”‚   Phase 4   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“               â†“               â†“               â†“
  åŸºç¡€é…ç½®          ä¾èµ–å®‰è£…        ä»£ç éƒ¨ç½²        æœåŠ¡è¿è¡Œ
  ç½‘ç»œè®¾ç½®          ç³»ç»Ÿå·¥å…·        é…ç½®æ–‡ä»¶        å¥åº·æ£€æŸ¥
```

### 7.2 å®é™…åˆ†é˜¶æ®µå®ç°


**ğŸ”§ å®Œæ•´çš„Webåº”ç”¨éƒ¨ç½²**
```yaml
#cloud-config
runcmd:
  # === Phase 1: ç³»ç»Ÿå‡†å¤‡ ===
  - echo "=== Phase 1: ç³»ç»Ÿç¯å¢ƒå‡†å¤‡ ===" >> /var/log/deployment.log
  
  # æ›´æ–°ç³»ç»Ÿ
  - apt update && apt upgrade -y
  
  # è®¾ç½®æ—¶åŒºå’ŒåŸºç¡€é…ç½®
  - timedatectl set-timezone Asia/Shanghai
  - hostnamectl set-hostname web-server-01
  
  # åˆ›å»ºå¿…è¦ç›®å½•
  - mkdir -p /opt/webapp/{app,logs,config,backup}
  - mkdir -p /var/log/webapp
  
  # === Phase 2: è½¯ä»¶å®‰è£… ===
  - echo "=== Phase 2: è½¯ä»¶ä¾èµ–å®‰è£… ===" >> /var/log/deployment.log
  
  # å®‰è£…WebæœåŠ¡å™¨å’Œæ•°æ®åº“
  - apt install -y nginx mysql-server
  
  # å®‰è£…Node.js (ç”¨äºç¤ºä¾‹åº”ç”¨)
  - curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
  - apt install -y nodejs
  
  # å®‰è£…è¿›ç¨‹ç®¡ç†å·¥å…·
  - npm install -g pm2
  
  # === Phase 3: åº”ç”¨éƒ¨ç½² ===
  - echo "=== Phase 3: åº”ç”¨ä»£ç éƒ¨ç½² ===" >> /var/log/deployment.log
  
  # ä¸‹è½½åº”ç”¨ä»£ç 
  - |
    cd /opt/webapp/app
    git clone https://github.com/example/my-web-app.git .
    npm install --production
  
  # é…ç½®åº”ç”¨
  - |
    cat > /opt/webapp/config/app.json << EOF
    {
      "port": 3000,
      "database": {
        "host": "localhost",
        "user": "webapp",
        "password": "WebApp123!",
        "database": "webappdb"
      }
    }
    EOF
  
  # é…ç½®Nginxåå‘ä»£ç†
  - |
    cat > /etc/nginx/sites-available/webapp << EOF
    server {
        listen 80;
        server_name _;
        
        location / {
            proxy_pass http://localhost:3000;
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
        }
    }
    EOF
  
  - ln -s /etc/nginx/sites-available/webapp /etc/nginx/sites-enabled/
  - rm -f /etc/nginx/sites-enabled/default
  
  # === Phase 4: æœåŠ¡å¯åŠ¨å’Œé…ç½® ===
  - echo "=== Phase 4: æœåŠ¡å¯åŠ¨é…ç½® ===" >> /var/log/deployment.log
  
  # é…ç½®æ•°æ®åº“
  - |
    mysql -e "
    CREATE DATABASE webappdb;
    CREATE USER 'webapp'@'localhost' IDENTIFIED BY 'WebApp123!';
    GRANT ALL PRIVILEGES ON webappdb.* TO 'webapp'@'localhost';
    FLUSH PRIVILEGES;
    "
  
  # å¯åŠ¨åº”ç”¨æœåŠ¡
  - |
    cd /opt/webapp/app
    pm2 start app.js --name webapp
    pm2 startup
    pm2 save
  
  # å¯åŠ¨WebæœåŠ¡å™¨
  - systemctl enable nginx
  - systemctl start nginx
  
  # === æœ€ç»ˆéªŒè¯å’Œæ¸…ç† ===
  - echo "=== éƒ¨ç½²å®ŒæˆéªŒè¯ ===" >> /var/log/deployment.log
  
  # éªŒè¯æœåŠ¡çŠ¶æ€
  - |
    sleep 10  # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
    if curl -f http://localhost/ >/dev/null 2>&1; then
      echo "Webåº”ç”¨éƒ¨ç½²æˆåŠŸï¼è®¿é—®åœ°å€: http://$(curl -s ifconfig.me)" >> /var/log/deployment.log
    else
      echo "Webåº”ç”¨éƒ¨ç½²å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ—¥å¿—" >> /var/log/deployment.log
    fi
  
  # è®¾ç½®æ—¥å¿—è½®è½¬
  - |
    cat > /etc/logrotate.d/webapp << EOF
    /var/log/webapp/*.log {
        daily
        rotate 7
        compress
        missingok
        notifempty
        create 644 www-data www-data
    }
    EOF
```

### 7.3 é˜¶æ®µé—´ä¾èµ–ç®¡ç†


**ğŸ”— ä¾èµ–æ£€æŸ¥æœºåˆ¶**
```yaml
runcmd:
  # é˜¶æ®µæ£€æŸ¥ç‚¹æœºåˆ¶
  - |
    check_phase_completion() {
      phase_name=$1
      check_command=$2
      
      echo "æ£€æŸ¥é˜¶æ®µ: $phase_name"
      if eval "$check_command"; then
        echo "âœ“ $phase_name å®Œæˆ" >> /var/log/phase-status.log
        return 0
      else
        echo "âœ— $phase_name å¤±è´¥" >> /var/log/phase-status.log
        return 1
      fi
    }
  
  # æ£€æŸ¥å„é˜¶æ®µå®ŒæˆçŠ¶æ€
  - |
    # æ£€æŸ¥ç³»ç»Ÿå‡†å¤‡é˜¶æ®µ
    check_phase_completion "ç³»ç»Ÿå‡†å¤‡" "[ -d /opt/webapp ]"
    
    # æ£€æŸ¥è½¯ä»¶å®‰è£…é˜¶æ®µ
    check_phase_completion "è½¯ä»¶å®‰è£…" "command -v nginx && command -v node"
    
    # æ£€æŸ¥åº”ç”¨éƒ¨ç½²é˜¶æ®µ
    check_phase_completion "åº”ç”¨éƒ¨ç½²" "[ -f /opt/webapp/app/package.json ]"
    
    # æ£€æŸ¥æœåŠ¡å¯åŠ¨é˜¶æ®µ
    check_phase_completion "æœåŠ¡å¯åŠ¨" "systemctl is-active nginx && pm2 list | grep -q webapp"
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ runcmd vs bootcmdï¼šç†è§£ä¸¤è€…çš„æ‰§è¡Œæ—¶æœºå’Œé€‚ç”¨åœºæ™¯å·®å¼‚
ğŸ”¸ å‘½ä»¤æ ¼å¼ï¼šæŒæ¡å­—ç¬¦ä¸²æ ¼å¼å’Œæ•°ç»„æ ¼å¼çš„ä½¿ç”¨æ–¹æ³•
ğŸ”¸ æ‰§è¡Œæ—¶æœºï¼šäº†è§£cloud-initçš„å››ä¸ªä¸»è¦æ‰§è¡Œé˜¶æ®µ
ğŸ”¸ ç”¨æˆ·æƒé™ï¼šç†è§£è„šæœ¬æ‰§è¡Œçš„ç”¨æˆ·ç¯å¢ƒå’Œæƒé™åˆ‡æ¢
ğŸ”¸ é”™è¯¯å¤„ç†ï¼šå…·å¤‡åŸºæœ¬çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶èƒ½åŠ›
ğŸ”¸ æ—¥å¿—è®°å½•ï¼šå…»æˆè¯¦ç»†è®°å½•æ‰§è¡Œæ—¥å¿—çš„ä¹ æƒ¯
ğŸ”¸ åˆ†é˜¶æ®µæ‰§è¡Œï¼šå¤æ‚éƒ¨ç½²ä»»åŠ¡çš„åˆ†è§£å’Œä¾èµ–ç®¡ç†
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ‰§è¡Œæ—¶æœºçš„é€‰æ‹©åŸåˆ™**
```
ä½¿ç”¨bootcmdçš„åœºæ™¯ï¼š
â€¢ ç³»ç»Ÿçº§åŸºç¡€é…ç½®ï¼ˆä¸»æœºåã€æ—¶åŒºï¼‰
â€¢ å†…æ ¸å‚æ•°ä¿®æ”¹
â€¢ åŸºç¡€ç›®å½•ç»“æ„åˆ›å»º
â€¢ å®‰å…¨ç­–ç•¥è®¾ç½®

ä½¿ç”¨runcmdçš„åœºæ™¯ï¼š
â€¢ è½¯ä»¶åŒ…å®‰è£…å’Œé…ç½®
â€¢ åº”ç”¨ç¨‹åºéƒ¨ç½²
â€¢ æœåŠ¡å¯åŠ¨å’Œç®¡ç†
â€¢ ç”¨æˆ·æ•°æ®å¤„ç†
```

**ğŸ”¹ è„šæœ¬å¯é æ€§ä¿éšœ**
```
é”™è¯¯å¤„ç†ç­–ç•¥ï¼š
â€¢ å…³é”®æ“ä½œä½¿ç”¨é‡è¯•æœºåˆ¶
â€¢ è®¾ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´
â€¢ è®°å½•è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—
â€¢ å®ç°çŠ¶æ€æ£€æŸ¥å’ŒéªŒè¯

æ€§èƒ½ä¼˜åŒ–è€ƒè™‘ï¼š
â€¢ é¿å…ä¸å¿…è¦çš„ç½‘ç»œä¸‹è½½
â€¢ åˆç†å®‰æ’æ‰§è¡Œé¡ºåº
â€¢ ä½¿ç”¨æ¡ä»¶åˆ¤æ–­é¿å…é‡å¤æ‰§è¡Œ
â€¢ åŠæ—¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶
```

**ğŸ”¹ å®‰å…¨æœ€ä½³å®è·µ**
```
æƒé™ç®¡ç†ï¼š
â€¢ æœ€å°æƒé™åŸåˆ™ï¼Œé¿å…ä¸å¿…è¦çš„rootæ“ä½œ
â€¢ æ•æ„Ÿä¿¡æ¯ä½¿ç”¨äº‘æœåŠ¡å•†çš„å¯†é’¥ç®¡ç†
â€¢ å®šæœŸè½®æ¢è®¿é—®å‡­è¯
â€¢ é™åˆ¶ç½‘ç»œè®¿é—®å’Œç«¯å£å¼€æ”¾

ä»£ç å®‰å…¨ï¼š
â€¢ é¿å…åœ¨è„šæœ¬ä¸­ç¡¬ç¼–ç å¯†ç 
â€¢ éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§
â€¢ ä½¿ç”¨HTTPSè¿›è¡Œç½‘ç»œé€šä¿¡
â€¢ å®šæœŸæ›´æ–°è½¯ä»¶åŒ…ç‰ˆæœ¬
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **WebæœåŠ¡éƒ¨ç½²**ï¼šè‡ªåŠ¨åŒ–Webåº”ç”¨çš„å®Œæ•´éƒ¨ç½²æµç¨‹
- **å¼€å‘ç¯å¢ƒ**ï¼šå¿«é€Ÿæ­å»ºæ ‡å‡†åŒ–çš„å¼€å‘æµ‹è¯•ç¯å¢ƒ
- **ç›‘æ§ç³»ç»Ÿ**ï¼šè‡ªåŠ¨éƒ¨ç½²ç›‘æ§ä»£ç†å’Œé…ç½®
- **æ•°æ®å¤„ç†**ï¼šæ‰¹é‡å¤„ç†å’Œåˆ†ææœåŠ¡å™¨çš„åˆå§‹åŒ–

**ğŸ”§ è¿ç»´å®è·µ**
- **æ ‡å‡†åŒ–éƒ¨ç½²**ï¼šç¡®ä¿æ‰€æœ‰æœåŠ¡å™¨é…ç½®çš„ä¸€è‡´æ€§
- **æ•…éšœæ¢å¤**ï¼šå¿«é€Ÿé‡å»ºå‡ºç°é—®é¢˜çš„æœåŠ¡å™¨
- **å¼¹æ€§æ‰©å®¹**ï¼šè‡ªåŠ¨åŒ–æ–°å¢æœåŠ¡å™¨çš„é…ç½®è¿‡ç¨‹
- **åˆè§„ç®¡ç†**ï¼šç»Ÿä¸€åº”ç”¨å®‰å…¨ç­–ç•¥å’Œç›‘æ§é…ç½®

> ğŸ’¡ **æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
> - bootcmdæ—©æ‰§è¡Œï¼Œç³»ç»ŸåŸºç¡€é…ç½®è¡Œ
> - runcmdåŠŸèƒ½å…¨ï¼Œåº”ç”¨éƒ¨ç½²æœåŠ¡ç®¡
> - é”™è¯¯å¤„ç†è¦å‘¨å…¨ï¼Œæ—¥å¿—è®°å½•ä¾¿æ’æŸ¥
> - åˆ†é˜¶æ®µæ¥æ‰§è¡Œï¼Œå¤æ‚éƒ¨ç½²æ›´å¯é 

**â­ å­¦ä¹ å»ºè®®**ï¼š
1. **å¾ªåºæ¸è¿›**ï¼šä»ç®€å•çš„å‘½ä»¤æ‰§è¡Œå¼€å§‹ï¼Œé€æ­¥æŒæ¡å¤æ‚çš„å¤šé˜¶æ®µéƒ¨ç½²
2. **å®è·µéªŒè¯**ï¼šåœ¨æµ‹è¯•ç¯å¢ƒä¸­éªŒè¯è„šæœ¬çš„å¯é æ€§å’Œæ•ˆæœ
3. **æ—¥å¿—åˆ†æ**ï¼šå­¦ä¼šé€šè¿‡æ—¥å¿—å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜
4. **ç‰ˆæœ¬ç®¡ç†**ï¼šå°†é…ç½®è„šæœ¬çº³å…¥ç‰ˆæœ¬æ§åˆ¶ï¼Œä¾¿äºç»´æŠ¤å’Œå›æ»š