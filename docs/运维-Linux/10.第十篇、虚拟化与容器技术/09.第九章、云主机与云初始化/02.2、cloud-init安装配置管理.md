---
title: 2ã€cloud-initå®‰è£…é…ç½®ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [cloud-initè½¯ä»¶åŒ…å®‰è£…](#1-cloud-initè½¯ä»¶åŒ…å®‰è£…)
2. [/etc/cloud/é…ç½®ç›®å½•ç»“æ„](#2-etc-cloudé…ç½®ç›®å½•ç»“æ„)
3. [cloud.cfgä¸»é…ç½®æ–‡ä»¶](#3-cloud-cfgä¸»é…ç½®æ–‡ä»¶)
4. [cloud.cfg.dé…ç½®æ–‡ä»¶ä¼˜å…ˆçº§](#4-cloud-cfg-dé…ç½®æ–‡ä»¶ä¼˜å…ˆçº§)
5. [datasourceé…ç½®é€‰æ‹©](#5-datasourceé…ç½®é€‰æ‹©)
6. [æ¨¡å—å¯ç”¨ç¦ç”¨é…ç½®](#6-æ¨¡å—å¯ç”¨ç¦ç”¨é…ç½®)
7. [æ—¥å¿—é…ç½®ä¸è°ƒè¯•å¼€å¯](#7-æ—¥å¿—é…ç½®ä¸è°ƒè¯•å¼€å¯)
8. [systemdæœåŠ¡å•å…ƒç®¡ç†](#8-systemdæœåŠ¡å•å…ƒç®¡ç†)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“¦ cloud-initè½¯ä»¶åŒ…å®‰è£…


### 1.1 ä»€ä¹ˆæ˜¯cloud-init


**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
cloud-initæ˜¯ä¸€ä¸ª**äº‘å®ä¾‹åˆå§‹åŒ–å·¥å…·**ï¼Œä¸“é—¨ä¸ºäº‘ç¯å¢ƒä¸­çš„è™šæ‹Ÿæœºæä¾›è‡ªåŠ¨åŒ–é…ç½®æœåŠ¡ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒå°±æ˜¯è®©ä½ çš„äº‘ä¸»æœºåœ¨å¯åŠ¨æ—¶èƒ½å¤Ÿ**è‡ªåŠ¨å®Œæˆå„ç§åˆå§‹åŒ–è®¾ç½®**ã€‚

**ğŸ’¡ ä¸»è¦ä½œç”¨**
```
ä¼ ç»Ÿæ–¹å¼ï¼šæ‰‹åŠ¨ç™»å½• â†’ ä¿®æ”¹hostname â†’ é…ç½®ç½‘ç»œ â†’ æ·»åŠ ç”¨æˆ· â†’ å®‰è£…è½¯ä»¶
cloud-initï¼šäº‘å¹³å°æä¾›é…ç½® â†’ è™šæ‹Ÿæœºè‡ªåŠ¨æ‰§è¡Œ â†’ å¼€æœºå³å¯ç”¨

æ ¸å¿ƒä»·å€¼ï¼š
â€¢ è‡ªåŠ¨åŒ–ï¼šæ— éœ€äººå·¥å¹²é¢„
â€¢ æ ‡å‡†åŒ–ï¼šç»Ÿä¸€çš„é…ç½®æ–¹å¼
â€¢ çµæ´»æ€§ï¼šæ”¯æŒå¤šç§äº‘å¹³å°
â€¢ å¯é‡å¤ï¼šç›¸åŒé…ç½®å¯æ‰¹é‡éƒ¨ç½²
```

### 1.2 å„å‘è¡Œç‰ˆå®‰è£…æ–¹æ³•


**ğŸ”§ Ubuntu/Debianç³»åˆ—**
```bash
# æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
sudo apt update

# å®‰è£…cloud-init
sudo apt install cloud-init

# éªŒè¯å®‰è£…
cloud-init --version
```

**ğŸ”§ CentOS/RHEL/Rocky Linuxç³»åˆ—**
```bash
# CentOS 7/8 å’Œ RHEL 7/8
sudo yum install cloud-init

# Rocky Linux 9 å’Œæ–°ç‰ˆæœ¬ä½¿ç”¨dnf
sudo dnf install cloud-init

# éªŒè¯å®‰è£…
cloud-init --version
```

**ğŸ”§ SUSE/openSUSEç³»åˆ—**
```bash
# ä½¿ç”¨zypperåŒ…ç®¡ç†å™¨
sudo zypper install cloud-init

# éªŒè¯å®‰è£…
cloud-init --version
```

### 1.3 å®‰è£…ååŸºæœ¬éªŒè¯


**âœ… æ£€æŸ¥å®‰è£…çŠ¶æ€**
```bash
# æŸ¥çœ‹è½¯ä»¶åŒ…ä¿¡æ¯
dpkg -l | grep cloud-init    # Debian/Ubuntu
rpm -qa | grep cloud-init    # RedHatç³»åˆ—

# æŸ¥çœ‹å®‰è£…çš„æ–‡ä»¶
dpkg -L cloud-init           # Debian/Ubuntu
rpm -ql cloud-init           # RedHatç³»åˆ—

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status cloud-init
```

---

## 2. ğŸ“‚ /etc/cloud/é…ç½®ç›®å½•ç»“æ„


### 2.1 ç›®å½•ç»“æ„æ¦‚è§ˆ


**ğŸ—ï¸ æ ‡å‡†ç›®å½•å¸ƒå±€**
```
/etc/cloud/
â”œâ”€â”€ cloud.cfg              â† ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ cloud.cfg.d/           â† æ‰©å±•é…ç½®ç›®å½•
â”‚   â”œâ”€â”€ 05_logging.cfg     â† æ—¥å¿—é…ç½®
â”‚   â”œâ”€â”€ 10_datasource.cfg  â† æ•°æ®æºé…ç½®
â”‚   â””â”€â”€ 90_custom.cfg      â† è‡ªå®šä¹‰é…ç½®
â”œâ”€â”€ datasources/           â† æ•°æ®æºç›¸å…³é…ç½®
â”œâ”€â”€ templates/             â† æ¨¡æ¿æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ hosts.debian.tmpl  â† hostsæ–‡ä»¶æ¨¡æ¿
â”‚   â”œâ”€â”€ sources.list.tmpl  â† aptæºæ¨¡æ¿
â”‚   â””â”€â”€ ...
â””â”€â”€ cloud.cfg.d.bak/       â† é…ç½®å¤‡ä»½ç›®å½•
```

### 2.2 å„ç›®å½•è¯¦ç»†è¯´æ˜


**ğŸ“‹ ä¸»è¦ç›®å½•åŠŸèƒ½**

| ç›®å½•/æ–‡ä»¶ | **ä½œç”¨è¯´æ˜** | **ä¼˜å…ˆçº§** |
|----------|-------------|-----------|
| `cloud.cfg` | **ä¸»é…ç½®æ–‡ä»¶**ï¼Œå®šä¹‰åŸºç¡€è®¾ç½® | `æœ€ä½` |
| `cloud.cfg.d/` | **æ‰©å±•é…ç½®ç›®å½•**ï¼Œè¦†ç›–ä¸»é…ç½® | `é«˜` |
| `datasources/` | **æ•°æ®æºé…ç½®**ï¼Œå®šä¹‰æ•°æ®è·å–æ–¹å¼ | `ä¸­` |
| `templates/` | **æ¨¡æ¿æ–‡ä»¶**ï¼Œç”¨äºç”Ÿæˆç³»ç»Ÿæ–‡ä»¶ | `è¾…åŠ©` |

**ğŸ”¸ ç†è§£é…ç½®å±‚æ¬¡**
```
é…ç½®ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
å‘½ä»¤è¡Œå‚æ•° > cloud.cfg.d/*.cfg > cloud.cfg > é»˜è®¤å€¼

å®é™…åº”ç”¨ï¼š
â€¢ cloud.cfgï¼šæ”¾ç½®é€šç”¨çš„åŸºç¡€é…ç½®
â€¢ cloud.cfg.d/ï¼šæ”¾ç½®ç‰¹å®šç¯å¢ƒçš„è¦†ç›–é…ç½®
â€¢ æ•°å­—å‰ç¼€ï¼šæ§åˆ¶cloud.cfg.då†…éƒ¨çš„åŠ è½½é¡ºåº
```

### 2.3 ç›®å½•æƒé™è¦æ±‚


**ğŸ”’ å®‰å…¨æ€§é…ç½®**
```bash
# è®¾ç½®æ­£ç¡®çš„ç›®å½•æƒé™
sudo chmod 755 /etc/cloud/
sudo chmod 644 /etc/cloud/cloud.cfg
sudo chmod 755 /etc/cloud/cloud.cfg.d/
sudo chmod 644 /etc/cloud/cloud.cfg.d/*.cfg

# æ£€æŸ¥æ–‡ä»¶æ‰€æœ‰è€…
ls -la /etc/cloud/
# åº”è¯¥æ˜¾ç¤º root:root ä½œä¸ºæ‰€æœ‰è€…
```

---

## 3. âš™ï¸ cloud.cfgä¸»é…ç½®æ–‡ä»¶


### 3.1 ä¸»é…ç½®æ–‡ä»¶ç»“æ„


**ğŸ“‹ é…ç½®æ–‡ä»¶ç»„æˆ**
cloud.cfgæ˜¯ä¸€ä¸ª**YAMLæ ¼å¼**çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«å››ä¸ªä¸»è¦éƒ¨åˆ†ï¼š

```yaml
# 1. ç³»ç»Ÿç”¨æˆ·é…ç½®
users:
  - default

# 2. SSHé…ç½®
ssh_pwauth: false
disable_root: true

# 3. äº‘æ¨¡å—é…ç½®  
cloud_init_modules:
  - migrator
  - seed_random
  - bootcmd

# 4. ç³»ç»Ÿé…ç½®
system_info:
  default_user:
    name: ubuntu
    shell: /bin/bash
```

### 3.2 å…³é”®é…ç½®æ®µè¯¦è§£


**ğŸ‘¤ ç”¨æˆ·é…ç½®æ®µ**
```yaml
# é»˜è®¤ç”¨æˆ·è®¾ç½®
users:
  - default                    # ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ç”¨æˆ·é…ç½®
  - name: admin               # åˆ›å»ºé¢å¤–ç”¨æˆ·
    groups: [wheel, docker]   # ç”¨æˆ·ç»„
    shell: /bin/bash          # é»˜è®¤shell
    sudo: ['ALL=(ALL) NOPASSWD:ALL']  # sudoæƒé™
```

**ğŸ”‘ SSHå®‰å…¨é…ç½®**
```yaml
# SSHè®¿é—®æ§åˆ¶
ssh_pwauth: false             # ç¦ç”¨å¯†ç è®¤è¯
disable_root: true            # ç¦ç”¨rootç™»å½•
ssh_authorized_keys:          # æˆæƒå¯†é’¥
  - ssh-rsa AAAAB3NzaC1yc2E... user@example.com

# SSHæœåŠ¡é…ç½®
ssh:
  emit_keys_to_console: false # ä¸åœ¨æ§åˆ¶å°æ˜¾ç¤ºå¯†é’¥
```

**ğŸ  ç³»ç»Ÿä¿¡æ¯é…ç½®**
```yaml
system_info:
  default_user:
    name: ubuntu              # é»˜è®¤ç”¨æˆ·å
    lock_passwd: true         # é”å®šå¯†ç ç™»å½•
    gecos: Ubuntu             # ç”¨æˆ·æè¿°
    groups: [adm, audio, cdrom, dialout, dip, floppy, lxd, netdev, plugdev, sudo, video]
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    shell: /bin/bash
    home: /home/ubuntu        # å®¶ç›®å½•
```

### 3.3 æ¨¡å—åŠ è½½é…ç½®


**ğŸ”§ äº‘åˆå§‹åŒ–é˜¶æ®µ**
```yaml
# äº‘åˆå§‹åŒ–é˜¶æ®µæ¨¡å—
cloud_init_modules:
  - migrator                  # æ•°æ®è¿ç§»
  - seed_random              # éšæœºæ•°ç§å­
  - bootcmd                  # å¯åŠ¨å‘½ä»¤
  - write-files              # å†™å…¥æ–‡ä»¶
  - growpart                 # åˆ†åŒºæ‰©å±•
  - resizefs                 # æ–‡ä»¶ç³»ç»Ÿè°ƒæ•´

# äº‘é…ç½®é˜¶æ®µæ¨¡å—  
cloud_config_modules:
  - disk_setup               # ç£ç›˜è®¾ç½®
  - mounts                   # æŒ‚è½½ç‚¹
  - ssh-import-id            # SSHå¯†é’¥å¯¼å…¥
  - locale                   # è¯­è¨€ç¯å¢ƒ
  - set-passwords            # å¯†ç è®¾ç½®
  - timezone                 # æ—¶åŒºè®¾ç½®
  - update_etc_hosts         # hostsæ–‡ä»¶æ›´æ–°

# äº‘æœ€ç»ˆé˜¶æ®µæ¨¡å—
cloud_final_modules:
  - package-update-upgrade-install  # è½¯ä»¶åŒ…ç®¡ç†
  - puppet                   # Puppeté…ç½®
  - chef                     # Chefé…ç½®  
  - scripts-vendor           # å‚å•†è„šæœ¬
  - scripts-per-once         # ä¸€æ¬¡æ€§è„šæœ¬
  - scripts-per-boot         # æ¯æ¬¡å¯åŠ¨è„šæœ¬
  - scripts-per-instance     # æ¯å®ä¾‹è„šæœ¬
  - scripts-user             # ç”¨æˆ·è„šæœ¬
  - ssh-authkey-fingerprints # SSHå¯†é’¥æŒ‡çº¹
  - keys-to-console          # å¯†é’¥åˆ°æ§åˆ¶å°
  - phone-home               # å›è°ƒé€šçŸ¥
  - final-message            # æœ€ç»ˆæ¶ˆæ¯
```

---

## 4. ğŸ“Š cloud.cfg.dé…ç½®æ–‡ä»¶ä¼˜å…ˆçº§


### 4.1 ä¼˜å…ˆçº§æœºåˆ¶åŸç†


**ğŸ”¢ æ•°å­—å‰ç¼€æ’åº**
cloud.cfg.dç›®å½•ä¸­çš„é…ç½®æ–‡ä»¶æŒ‰ç…§**æ–‡ä»¶åçš„æ•°å­—å‰ç¼€**è¿›è¡Œæ’åºåŠ è½½ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚

```
åŠ è½½é¡ºåºç¤ºä¾‹ï¼š
/etc/cloud/cloud.cfg.d/
â”œâ”€â”€ 05_logging.cfg          â† ç¬¬1ä¸ªåŠ è½½
â”œâ”€â”€ 10_datasource.cfg       â† ç¬¬2ä¸ªåŠ è½½  
â”œâ”€â”€ 20_network.cfg          â† ç¬¬3ä¸ªåŠ è½½
â”œâ”€â”€ 50_custom.cfg           â† ç¬¬4ä¸ªåŠ è½½
â””â”€â”€ 90_local.cfg            â† æœ€ååŠ è½½
```

**âš–ï¸ é…ç½®è¦†ç›–è§„åˆ™**
```
è¦†ç›–å±‚æ¬¡ï¼ˆä»ä½åˆ°é«˜ï¼‰ï¼š
cloud.cfg â†’ 05_*.cfg â†’ 10_*.cfg â†’ ... â†’ 90_*.cfg

å®é™…æ•ˆæœï¼š
â€¢ ååŠ è½½çš„é…ç½®ä¼šè¦†ç›–å…ˆåŠ è½½çš„ç›¸åŒé…ç½®é¡¹
â€¢ ä¸åŒé…ç½®é¡¹ä¼šåˆå¹¶ï¼Œè€Œä¸æ˜¯æ›¿æ¢æ•´ä¸ªé…ç½®æ®µ
â€¢ åˆ—è¡¨ç±»å‹é…ç½®é¡¹ä¼šè¿›è¡Œåˆå¹¶è€Œéè¦†ç›–
```

### 4.2 æ ‡å‡†é…ç½®æ–‡ä»¶è¯´æ˜


**ğŸ“ å¸¸è§é…ç½®æ–‡ä»¶ç”¨é€”**

| æ–‡ä»¶å | **ç”¨é€”è¯´æ˜** | **å…¸å‹å†…å®¹** |
|--------|-------------|-------------|
| `05_logging.cfg` | **æ—¥å¿—é…ç½®** | æ—¥å¿—çº§åˆ«ã€è¾“å‡ºä½ç½® |
| `10_datasource.cfg` | **æ•°æ®æºè®¾ç½®** | äº‘å¹³å°ç±»å‹ã€å…ƒæ•°æ®æº |
| `20_network.cfg` | **ç½‘ç»œé…ç½®** | ç½‘ç»œæ¥å£ã€DNSè®¾ç½® |
| `50_curtin.cfg` | **å®‰è£…å™¨é…ç½®** | ç£ç›˜åˆ†åŒºã€å®‰è£…è®¾ç½® |
| `90_custom.cfg` | **è‡ªå®šä¹‰é…ç½®** | ç”¨æˆ·ç‰¹å®šè®¾ç½® |

### 4.3 é…ç½®æ–‡ä»¶ç®¡ç†æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**
```bash
# 1. å¤‡ä»½åŸå§‹é…ç½®
sudo cp -r /etc/cloud/cloud.cfg.d /etc/cloud/cloud.cfg.d.backup

# 2. åˆ›å»ºè‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼ˆä½¿ç”¨é«˜ä¼˜å…ˆçº§æ•°å­—ï¼‰
sudo vim /etc/cloud/cloud.cfg.d/99_custom.cfg

# 3. éªŒè¯é…ç½®è¯­æ³•
cloud-init devel schema --config-file /etc/cloud/cloud.cfg.d/99_custom.cfg

# 4. æµ‹è¯•é…ç½®æ•ˆæœ
sudo cloud-init clean
sudo cloud-init init
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
- æ–‡ä»¶åå¿…é¡»ä»¥ `.cfg` ç»“å°¾
- ä½¿ç”¨YAMLæ ¼å¼ï¼Œæ³¨æ„ç¼©è¿›
- æ•°å­—å‰ç¼€èŒƒå›´ï¼š00-99
- é¿å…ä¿®æ”¹ç³»ç»Ÿé»˜è®¤çš„é…ç½®æ–‡ä»¶

---

## 5. ğŸŒ datasourceé…ç½®é€‰æ‹©


### 5.1 datasourceæ¦‚å¿µè§£æ


**ğŸ”¸ ä»€ä¹ˆæ˜¯datasource**
datasourceï¼ˆæ•°æ®æºï¼‰æ˜¯cloud-initè·å–**é…ç½®ä¿¡æ¯å’Œå…ƒæ•°æ®**çš„æ¥æºã€‚ç®€å•ç†è§£å°±æ˜¯ï¼šäº‘ä¸»æœºä»å“ªé‡Œè·å–å®ƒçš„åˆå§‹åŒ–é…ç½®ä¿¡æ¯ã€‚

**ğŸ’¡ æ•°æ®æºç±»å‹**
```
å¸¸è§æ•°æ®æºï¼š
â€¢ EC2ï¼šAmazon Web Services
â€¢ OpenStackï¼šå¼€æºäº‘å¹³å°
â€¢ Azureï¼šå¾®è½¯äº‘å¹³å°
â€¢ GCEï¼šGoogleäº‘å¹³å°
â€¢ VMwareï¼šVMwareè™šæ‹ŸåŒ–å¹³å°
â€¢ NoCloudï¼šæœ¬åœ°é…ç½®æ–‡ä»¶
â€¢ ConfigDriveï¼šé…ç½®é©±åŠ¨å™¨
```

### 5.2 æ•°æ®æºé…ç½®æ–¹æ³•


**ğŸ”§ åœ¨cloud.cfgä¸­é…ç½®**
```yaml
# æŒ‡å®šæ•°æ®æºåˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
datasource_list:
  - EC2           # ä¼˜å…ˆå°è¯•EC2
  - OpenStack     # å…¶æ¬¡å°è¯•OpenStack
  - NoCloud       # æœ€åå°è¯•æœ¬åœ°é…ç½®
  
# æ•°æ®æºç‰¹å®šé…ç½®
datasource:
  EC2:
    timeout: 50   # è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    max_wait: 120 # æœ€å¤§ç­‰å¾…æ—¶é—´
    metadata_urls:
      - http://169.254.169.254  # å…ƒæ•°æ®æœåŠ¡åœ°å€
```

**ğŸ”§ NoCloudæ•°æ®æºé…ç½®**
```yaml
# é€‚ç”¨äºæœ¬åœ°æµ‹è¯•æˆ–ç¦»çº¿ç¯å¢ƒ
datasource:
  NoCloud:
    # ä»æœ¬åœ°æ–‡ä»¶è¯»å–é…ç½®
    fs_label: cidata        # æ–‡ä»¶ç³»ç»Ÿæ ‡ç­¾
    # æˆ–è€…ä»ç½‘ç»œè¯»å–
    seedfrom: http://10.10.0.1/  # ç§å­æ•°æ®URL
```

### 5.3 æ•°æ®æºæ£€æµ‹é¡ºåº


**ğŸ” è‡ªåŠ¨æ£€æµ‹æœºåˆ¶**
```
æ£€æµ‹æµç¨‹ï¼š
1. è¯»å–datasource_listé…ç½®
2. æŒ‰é¡ºåºå°è¯•æ¯ä¸ªæ•°æ®æº
3. æ£€æŸ¥æ•°æ®æºæ˜¯å¦å¯ç”¨ï¼ˆç½‘ç»œè¿é€šæ€§ã€å…ƒæ•°æ®å¯ç”¨æ€§ï¼‰
4. ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„æ•°æ®æº
5. å¦‚æœéƒ½ä¸å¯ç”¨ï¼Œä½¿ç”¨Noneæ•°æ®æºï¼ˆæœ€å°åŒ–é…ç½®ï¼‰

æ£€æµ‹æ—¥å¿—ï¼š
/var/log/cloud-init.log ä¸­ä¼šè®°å½•è¯¦ç»†çš„æ£€æµ‹è¿‡ç¨‹
```

### 5.4 å¸¸ç”¨æ•°æ®æºé…ç½®ç¤ºä¾‹


**â˜ï¸ OpenStackç¯å¢ƒ**
```yaml
datasource_list: ['OpenStack']
datasource:
  OpenStack:
    metadata_urls: ['http://169.254.169.254']
    max_wait: 60
    timeout: 10
    retries: 5
```

**ğŸ”’ VMwareç¯å¢ƒ**
```yaml
datasource_list: ['VMware']
datasource:
  VMware:
    allow_raw_data: true        # å…è®¸åŸå§‹æ•°æ®
    vmware_cust_file_max_wait: 15  # è‡ªå®šä¹‰æ–‡ä»¶æœ€å¤§ç­‰å¾…æ—¶é—´
```

---

## 6. ğŸ§© æ¨¡å—å¯ç”¨ç¦ç”¨é…ç½®


### 6.1 æ¨¡å—ç³»ç»Ÿæ¦‚è¿°


**ğŸ”¸ æ¨¡å—çš„ä½œç”¨**
cloud-initçš„åŠŸèƒ½æ˜¯é€šè¿‡**æ¨¡å—åŒ–**å®ç°çš„ï¼Œæ¯ä¸ªæ¨¡å—è´Ÿè´£ç‰¹å®šçš„åˆå§‹åŒ–ä»»åŠ¡ã€‚ä½ å¯ä»¥æ ¹æ®éœ€è¦**å¯ç”¨æˆ–ç¦ç”¨**ç‰¹å®šæ¨¡å—ã€‚

**ğŸ“‹ æ¨¡å—æ‰§è¡Œé˜¶æ®µ**
```
å››ä¸ªæ‰§è¡Œé˜¶æ®µï¼š
cloud-init-local    â†’ æœ¬åœ°é˜¶æ®µï¼ˆç½‘ç»œå‰ï¼‰
cloud-init          â†’ äº‘åˆå§‹åŒ–é˜¶æ®µï¼ˆç½‘ç»œåï¼‰
cloud-config        â†’ äº‘é…ç½®é˜¶æ®µ
cloud-final         â†’ æœ€ç»ˆé˜¶æ®µ
```

### 6.2 æŸ¥çœ‹å¯ç”¨æ¨¡å—


**ğŸ” åˆ—å‡ºæ‰€æœ‰æ¨¡å—**
```bash
# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨æ¨¡å—
cloud-init list-modules --all

# æŸ¥çœ‹ç‰¹å®šé˜¶æ®µçš„æ¨¡å—
cloud-init list-modules cloud-init
cloud-init list-modules cloud-config
cloud-init list-modules cloud-final
```

**ğŸ“Š å¸¸ç”¨æ¨¡å—è¯´æ˜**

| æ¨¡å—åç§° | **åŠŸèƒ½è¯´æ˜** | **æ‰§è¡Œé˜¶æ®µ** |
|---------|-------------|-------------|
| `ssh` | SSHå¯†é’¥é…ç½® | cloud-config |
| `users-groups` | ç”¨æˆ·å’Œç»„ç®¡ç† | cloud-config |
| `write-files` | å†™å…¥æ–‡ä»¶ | cloud-init |
| `runcmd` | æ‰§è¡Œå‘½ä»¤ | cloud-final |
| `package-update-upgrade-install` | è½¯ä»¶åŒ…ç®¡ç† | cloud-final |
| `timezone` | æ—¶åŒºè®¾ç½® | cloud-config |
| `locale` | è¯­è¨€ç¯å¢ƒ | cloud-config |

### 6.3 å¯ç”¨å’Œç¦ç”¨æ¨¡å—


**âœ… å¯ç”¨æ¨¡å—**
```yaml
# åœ¨cloud.cfgæˆ–cloud.cfg.d/*.cfgä¸­é…ç½®
cloud_config_modules:
  - ssh
  - users-groups  
  - write-files
  - locale
  - timezone

cloud_final_modules:
  - runcmd
  - scripts-user
  - package-update-upgrade-install
```

**âŒ ç¦ç”¨æ¨¡å—**
```yaml
# æ–¹æ³•1ï¼šä»åˆ—è¡¨ä¸­ç§»é™¤æ¨¡å—å
cloud_config_modules:
  - ssh
  - users-groups
  # ç§»é™¤äº†write-filesæ¨¡å—

# æ–¹æ³•2ï¼šä½¿ç”¨undefineæ˜ç¡®ç¦ç”¨
undefine:
  cloud_config_modules:
    - write-files    # æ˜ç¡®ç¦ç”¨æ­¤æ¨¡å—
```

### 6.4 æ¨¡å—é…ç½®ç¤ºä¾‹


**ğŸ”§ è‡ªå®šä¹‰æ¨¡å—é…ç½®**
```yaml
# åªå¯ç”¨å¿…è¦çš„æ¨¡å—ï¼ˆç²¾ç®€é…ç½®ï¼‰
cloud_init_modules:
  - seed_random
  - write-files

cloud_config_modules:
  - ssh
  - users-groups
  - locale

cloud_final_modules:
  - runcmd
  - final-message

# ç¦ç”¨æ‰€æœ‰è½¯ä»¶åŒ…ç›¸å…³æ¨¡å—ï¼ˆç¦»çº¿ç¯å¢ƒï¼‰
undefine:
  cloud_final_modules:
    - package-update-upgrade-install
    - snap
```

---

## 7. ğŸ“ æ—¥å¿—é…ç½®ä¸è°ƒè¯•å¼€å¯


### 7.1 æ—¥å¿—ç³»ç»Ÿæ¦‚è¿°


**ğŸ“‹ æ—¥å¿—æ–‡ä»¶ä½ç½®**
```
ä¸»è¦æ—¥å¿—æ–‡ä»¶ï¼š
/var/log/cloud-init.log          â† ä¸»æ—¥å¿—æ–‡ä»¶ï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰
/var/log/cloud-init-output.log   â† è¾“å‡ºæ—¥å¿—ï¼ˆè„šæœ¬æ‰§è¡Œç»“æœï¼‰
/run/cloud-init/                 â† è¿è¡Œæ—¶çŠ¶æ€æ–‡ä»¶
â”œâ”€â”€ status.json                  â† æ‰§è¡ŒçŠ¶æ€
â”œâ”€â”€ instance-data.json           â† å®ä¾‹æ•°æ®
â””â”€â”€ datasource                   â† æ•°æ®æºä¿¡æ¯
```

### 7.2 é…ç½®æ—¥å¿—çº§åˆ«


**ğŸ”§ æ—¥å¿—çº§åˆ«è®¾ç½®**
```yaml
# åœ¨cloud.cfgæˆ–05_logging.cfgä¸­é…ç½®
output:
  all: '| tee -a /var/log/cloud-init-output.log'  # æ‰€æœ‰è¾“å‡º
  init: '> /var/log/cloud-init.log'               # åˆå§‹åŒ–æ—¥å¿—

# è¯¦ç»†æ—¥å¿—é…ç½®
logging:
  version: 1
  disable_existing_loggers: false
  formatters:
    default:
      format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  handlers:
    console:
      class: logging.StreamHandler
      level: WARNING
      formatter: default
      stream: ext://sys.stdout
    file:
      class: logging.FileHandler
      level: DEBUG
      formatter: default
      filename: /var/log/cloud-init.log
  root:
    level: DEBUG
    handlers: [console, file]
```

### 7.3 è°ƒè¯•æ¨¡å¼é…ç½®


**ğŸ› å¯ç”¨è°ƒè¯•åŠŸèƒ½**
```yaml
# å¼€å¯è°ƒè¯•æ¨¡å¼
debug: true

# è¯¦ç»†çš„è°ƒè¯•é…ç½®
log_cfgs:
  - |
    [loggers]
    keys=root,cloudinit
    
    [handlers]  
    keys=consoleHandler,cloudLogHandler
    
    [formatters]
    keys=simpleFormatter,arg0Formatter
    
    [logger_root]
    level=DEBUG
    handlers=consoleHandler,cloudLogHandler
    
    [logger_cloudinit]
    level=DEBUG
    qualname=cloudinit
    handlers=cloudLogHandler
    propagate=1
```

### 7.4 è°ƒè¯•å‘½ä»¤å’ŒæŠ€å·§


**ğŸ”§ è°ƒè¯•å‘½ä»¤**
```bash
# æŸ¥çœ‹å½“å‰çŠ¶æ€
cloud-init status --long

# é‡æ–°è¿è¡Œå¹¶æŸ¥çœ‹è¯¦ç»†è¾“å‡º
sudo cloud-init clean --logs
sudo cloud-init init --local
sudo cloud-init init  
sudo cloud-init modules --mode=config
sudo cloud-init modules --mode=final

# åˆ†æé…ç½®æ–‡ä»¶
cloud-init devel schema --config-file /etc/cloud/cloud.cfg

# æŸ¥çœ‹æ”¶é›†çš„å®ä¾‹æ•°æ®
sudo cloud-init query --all
```

**ğŸ“Š æ—¥å¿—åˆ†ææŠ€å·§**
```bash
# æœç´¢é”™è¯¯ä¿¡æ¯
grep -i error /var/log/cloud-init.log

# æŸ¥çœ‹ç‰¹å®šæ¨¡å—çš„æ‰§è¡Œæƒ…å†µ
grep "modules-init" /var/log/cloud-init.log

# ç›‘æ§å®æ—¶æ—¥å¿—
tail -f /var/log/cloud-init.log
```

---

## 8. ğŸ”§ systemdæœåŠ¡å•å…ƒç®¡ç†


### 8.1 cloud-initæœåŠ¡å•å…ƒ


**ğŸ”¸ æœåŠ¡å•å…ƒæ¦‚è¿°**
cloud-inité€šè¿‡**å¤šä¸ªsystemdæœåŠ¡**æ¥ç®¡ç†ä¸åŒé˜¶æ®µçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œæ¯ä¸ªæœåŠ¡è´Ÿè´£ç‰¹å®šçš„åˆå§‹åŒ–ä»»åŠ¡ã€‚

**ğŸ“‹ ä¸»è¦æœåŠ¡å•å…ƒ**
```
cloud-init-local.service     â† æœ¬åœ°åˆå§‹åŒ–ï¼ˆç½‘ç»œå‰ï¼‰
cloud-init.service           â† ç½‘ç»œåˆå§‹åŒ– 
cloud-config.service         â† é…ç½®åº”ç”¨
cloud-final.service          â† æœ€ç»ˆå¤„ç†

ç›¸å…³æœåŠ¡ï¼š
cloud-init-hotplugd.service  â† çƒ­æ’æ‹”æ£€æµ‹
cloud-config.target          â† é…ç½®ç›®æ ‡
```

### 8.2 æœåŠ¡çŠ¶æ€ç®¡ç†


**ğŸ” æŸ¥çœ‹æœåŠ¡çŠ¶æ€**
```bash
# æŸ¥çœ‹æ‰€æœ‰cloud-initç›¸å…³æœåŠ¡çŠ¶æ€
systemctl status cloud-init-local
systemctl status cloud-init  
systemctl status cloud-config
systemctl status cloud-final

# æŸ¥çœ‹æœåŠ¡å¯åŠ¨é¡ºåºå’Œä¾èµ–å…³ç³»
systemctl list-dependencies cloud-config.target

# æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯ç”¨
systemctl is-enabled cloud-init-local.service
```

**ğŸ”§ æœåŠ¡æ§åˆ¶å‘½ä»¤**
```bash
# å¯ç”¨æœåŠ¡ï¼ˆå¼€æœºè‡ªå¯ï¼‰
sudo systemctl enable cloud-init-local.service
sudo systemctl enable cloud-init.service
sudo systemctl enable cloud-config.service  
sudo systemctl enable cloud-final.service

# ç¦ç”¨æœåŠ¡
sudo systemctl disable cloud-init.service

# é‡å¯æœåŠ¡
sudo systemctl restart cloud-init.service

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
journalctl -u cloud-init.service
journalctl -u cloud-init.service --since today
```

### 8.3 æœåŠ¡ä¾èµ–å…³ç³»


**ğŸ”— å¯åŠ¨é¡ºåºå’Œä¾èµ–**
```
å¯åŠ¨é¡ºåºï¼š
1. cloud-init-local.service   â† æœ€æ—©å¯åŠ¨ï¼Œç½‘ç»œå‰
2. network.target             â† ç½‘ç»œå¯åŠ¨
3. cloud-init.service         â† ç½‘ç»œååˆå§‹åŒ–
4. cloud-config.service       â† é…ç½®åº”ç”¨
5. cloud-final.service        â† æœ€åå¤„ç†

ä¾èµ–å…³ç³»ï¼š
cloud-init-local â†’ æ— ç½‘ç»œä¾èµ–
cloud-init â†’ éœ€è¦ç½‘ç»œ
cloud-config â†’ ä¾èµ–cloud-initå®Œæˆ
cloud-final â†’ ä¾èµ–cloud-configå®Œæˆ
```

### 8.4 æœåŠ¡é…ç½®æ–‡ä»¶


**ğŸ“„ æŸ¥çœ‹æœåŠ¡é…ç½®**
```bash
# æŸ¥çœ‹æœåŠ¡å•å…ƒæ–‡ä»¶
cat /lib/systemd/system/cloud-init.service

# å…¸å‹çš„æœåŠ¡å•å…ƒå†…å®¹ï¼š
[Unit]
Description=Initial cloud-init job (metadata service crawler)
DefaultDependencies=false  
Wants=cloud-init-local.service
After=cloud-init-local.service
After=systemd-networkd-wait-online.service
Before=network-online.target
Before=sshd-keygen.service

[Service]
Type=oneshot
ExecStart=/usr/bin/cloud-init init
RemainAfterExit=yes
TimeoutSec=0

[Install]
WantedBy=cloud-init.target
```

**ğŸ”§ è‡ªå®šä¹‰æœåŠ¡è¡Œä¸º**
```bash
# åˆ›å»ºæœåŠ¡è¦†ç›–é…ç½®
sudo mkdir -p /etc/systemd/system/cloud-init.service.d/
sudo vim /etc/systemd/system/cloud-init.service.d/override.conf

# ç¤ºä¾‹è¦†ç›–é…ç½®ï¼š
[Service]
TimeoutSec=300    # å¢åŠ è¶…æ—¶æ—¶é—´åˆ°5åˆ†é’Ÿ
Environment="DEBUG=1"  # å¯ç”¨è°ƒè¯•ç¯å¢ƒå˜é‡

# é‡æ–°åŠ è½½systemdé…ç½®
sudo systemctl daemon-reload
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ cloud-initæœ¬è´¨ï¼šäº‘å®ä¾‹è‡ªåŠ¨åŒ–åˆå§‹åŒ–å·¥å…·
ğŸ”¸ é…ç½®å±‚æ¬¡ï¼šcloud.cfg < cloud.cfg.d/*.cfgï¼ˆæ•°å­—å‰ç¼€æ’åºï¼‰
ğŸ”¸ æ•°æ®æºæ¦‚å¿µï¼šcloud-initè·å–é…ç½®ä¿¡æ¯çš„æ¥æº
ğŸ”¸ æ¨¡å—ç³»ç»Ÿï¼šåŠŸèƒ½æ¨¡å—åŒ–ï¼Œå¯é€‰æ‹©å¯ç”¨/ç¦ç”¨
ğŸ”¸ æœåŠ¡å•å…ƒï¼šå››ä¸ªä¸»è¦æœåŠ¡ç®¡ç†ä¸åŒåˆå§‹åŒ–é˜¶æ®µ
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§**
```
è®°å¿†è¦ç‚¹ï¼š
â€¢ æ•°å­—å°çš„å…ˆåŠ è½½ï¼Œæ•°å­—å¤§çš„ååŠ è½½
â€¢ ååŠ è½½çš„é…ç½®è¦†ç›–å…ˆåŠ è½½çš„ç›¸åŒé…ç½®é¡¹
â€¢ cloud.cfg.d/ä¼˜å…ˆçº§é«˜äºcloud.cfg
â€¢ 99_å¼€å¤´çš„æ–‡ä»¶å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§
```

**ğŸ”¹ æ•°æ®æºé€‰æ‹©é€»è¾‘**
```
ç†è§£è¦ç‚¹ï¼š
â€¢ datasource_listå®šä¹‰æ£€æµ‹é¡ºåº
â€¢ cloud-initæŒ‰é¡ºåºå°è¯•æ¯ä¸ªæ•°æ®æº
â€¢ ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„æ•°æ®æº
â€¢ NoCloudé€‚åˆæœ¬åœ°æµ‹è¯•ç¯å¢ƒ
```

**ğŸ”¹ æœåŠ¡æ‰§è¡Œé˜¶æ®µ**
```
æ‰§è¡Œé¡ºåºï¼š
localï¼ˆç½‘ç»œå‰ï¼‰â†’ initï¼ˆç½‘ç»œåï¼‰â†’ configï¼ˆé…ç½®ï¼‰â†’ finalï¼ˆæœ€ç»ˆï¼‰
æ¯ä¸ªé˜¶æ®µæœ‰ç‰¹å®šçš„ç”¨é€”å’Œæ¨¡å—
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… æ—¥å¸¸ç®¡ç†æ“ä½œ**
- **æŸ¥çœ‹çŠ¶æ€**ï¼š`cloud-init status --long`
- **é‡æ–°åˆå§‹åŒ–**ï¼š`cloud-init clean && cloud-init init`
- **é…ç½®éªŒè¯**ï¼š`cloud-init devel schema --config-file`
- **è°ƒè¯•é—®é¢˜**ï¼šæŸ¥çœ‹ `/var/log/cloud-init.log`

**ğŸ”§ é…ç½®æœ€ä½³å®è·µ**
- ä½¿ç”¨cloud.cfg.d/ç›®å½•è¿›è¡Œè‡ªå®šä¹‰é…ç½®
- å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶
- æµ‹è¯•é…ç½®å‰å…ˆéªŒè¯YAMLè¯­æ³•
- ä½¿ç”¨é«˜æ•°å­—å‰ç¼€ï¼ˆ90-99ï¼‰é¿å…è¢«è¦†ç›–

**âš ï¸ å¸¸è§æ³¨æ„äº‹é¡¹**
- é…ç½®æ–‡ä»¶å¿…é¡»æ˜¯æœ‰æ•ˆçš„YAMLæ ¼å¼
- ä¿®æ”¹é…ç½®åéœ€è¦é‡æ–°åˆå§‹åŒ–æ‰èƒ½ç”Ÿæ•ˆ
- æŸäº›æ¨¡å—åªåœ¨ç‰¹å®šæ•°æ®æºä¸‹å·¥ä½œ
- æœåŠ¡ä¾èµ–å…³ç³»å½±å“å¯åŠ¨é¡ºåº

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- cloud-initäº‘åˆå§‹åŒ–ï¼Œé…ç½®è‡ªåŠ¨ä¸è´¹åŠ›
- ç›®å½•ç»“æ„è¦æ¸…æ¥šï¼Œä¼˜å…ˆçº§åˆ«æ•°å­—åº
- æ•°æ®æºå¤´è¦é€‰å¯¹ï¼Œæ¨¡å—å¯ç¦éšå¿ƒé…
- æ—¥å¿—è°ƒè¯•å¸®æ’é”™ï¼ŒæœåŠ¡ç®¡ç†systemdåš