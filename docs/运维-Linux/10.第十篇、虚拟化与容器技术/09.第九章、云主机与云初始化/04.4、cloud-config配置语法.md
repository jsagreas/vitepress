---
title: 4ã€cloud-configé…ç½®è¯­æ³•
---
## ğŸ“š ç›®å½•

1. [YAMLé…ç½®æ–‡ä»¶è¯­æ³•åŸºç¡€](#1-YAMLé…ç½®æ–‡ä»¶è¯­æ³•åŸºç¡€)
2. [cloud-configé­”æ³•å­—ç¬¦ä¸²](#2-cloud-configé­”æ³•å­—ç¬¦ä¸²)
3. [é…ç½®é¡¹åˆ†ç±»ä¸æ¨¡å—](#3-é…ç½®é¡¹åˆ†ç±»ä¸æ¨¡å—)
4. [æ¡ä»¶æ‰§è¡Œé…ç½®](#4-æ¡ä»¶æ‰§è¡Œé…ç½®)
5. [å¤šæ–‡æ¡£åˆå¹¶è§„åˆ™](#5-å¤šæ–‡æ¡£åˆå¹¶è§„åˆ™)
6. [é…ç½®éªŒè¯ä¸è¯­æ³•æ£€æŸ¥](#6-é…ç½®éªŒè¯ä¸è¯­æ³•æ£€æŸ¥)
7. [å˜é‡æ›¿æ¢æœºåˆ¶](#7-å˜é‡æ›¿æ¢æœºåˆ¶)
8. [é…ç½®æ–‡ä»¶è°ƒè¯•æŠ€å·§](#8-é…ç½®æ–‡ä»¶è°ƒè¯•æŠ€å·§)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“ YAMLé…ç½®æ–‡ä»¶è¯­æ³•åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯YAML

ğŸ¯ **ç®€å•ç†è§£**ï¼šYAMLå°±åƒä¸€ç§"äººè¯ç‰ˆ"çš„é…ç½®æ–‡ä»¶æ ¼å¼

```
é…ç½®æ–‡ä»¶æ ¼å¼å¯¹æ¯”ï¼š

JSONæ ¼å¼ (æœºå™¨å‹å¥½):
{"users": [{"name": "admin", "groups": ["sudo"]}]}

XMLæ ¼å¼ (æ ‡ç­¾ç¹ç):
<users><user><name>admin</name><groups><group>sudo</group></groups></user></users>

YAMLæ ¼å¼ (äººç±»å‹å¥½):
users:
  - name: admin
    groups:
      - sudo

ä¼˜åŠ¿ï¼šç®€æ´æ˜“è¯»ï¼Œå±‚æ¬¡æ¸…æ™°ï¼Œç¼–å†™ç®€å•
```

**ğŸ”¸ YAMLçš„æ ¸å¿ƒç‰¹å¾**
- **ç¼©è¿›æ•æ„Ÿ**ï¼šç”¨ç©ºæ ¼è¡¨ç¤ºå±‚çº§å…³ç³»ï¼Œä¸èƒ½ç”¨Tabé”®
- **æ•°æ®ç±»å‹ä¸°å¯Œ**ï¼šæ”¯æŒå­—ç¬¦ä¸²ã€æ•°å­—ã€å¸ƒå°”å€¼ã€åˆ—è¡¨ã€å­—å…¸
- **æ³¨é‡Šå‹å¥½**ï¼šä½¿ç”¨#å·æ·»åŠ æ³¨é‡Šè¯´æ˜
- **Unicodeæ”¯æŒ**ï¼šåŸç”Ÿæ”¯æŒä¸­æ–‡ç­‰å¤šè¯­è¨€å­—ç¬¦

### 1.2 YAMLåŸºæœ¬è¯­æ³•è§„åˆ™

**ğŸ“‹ åŸºç¡€è¯­æ³•è¦ç‚¹**

```yaml
# 1. é”®å€¼å¯¹æ ¼å¼
hostname: cloud-server-01
timezone: Asia/Shanghai

# 2. åˆ—è¡¨æ ¼å¼
packages:
  - curl
  - wget
  - git

# 3. åµŒå¥—ç»“æ„
user:
  name: admin
  groups:
    - sudo
    - docker
  shell: /bin/bash

# 4. å¤šè¡Œå­—ç¬¦ä¸²
runcmd:
  - |
    echo "è¿™æ˜¯å¤šè¡Œå‘½ä»¤"
    apt update
    apt upgrade -y

# 5. å¸ƒå°”å€¼å’Œæ•°å­—
ssh_pwauth: false
port: 22
```

**âš ï¸ å¸¸è§è¯­æ³•é™·é˜±**
```yaml
# é”™è¯¯ç¤ºä¾‹ - æ··ç”¨ç©ºæ ¼å’ŒTab
users:
    name: admin    # 4ä¸ªç©ºæ ¼
	shell: /bin/bash   # Tabé”® âŒ è¿™ä¼šå¯¼è‡´è§£æé”™è¯¯

# æ­£ç¡®ç¤ºä¾‹ - ç»Ÿä¸€ä½¿ç”¨ç©ºæ ¼
users:
  name: admin      # 2ä¸ªç©ºæ ¼
  shell: /bin/bash # 2ä¸ªç©ºæ ¼

# å­—ç¬¦ä¸²å¼•å·ä½¿ç”¨
password: "123456"     # å»ºè®®åŠ å¼•å·
special: "user@host"   # ç‰¹æ®Šå­—ç¬¦å¿…é¡»åŠ å¼•å·
simple: hello          # ç®€å•å­—ç¬¦ä¸²å¯ä¸åŠ å¼•å·
```

### 1.3 YAMLæ•°æ®ç±»å‹è¯¦è§£

**ğŸ”¢ æ”¯æŒçš„æ•°æ®ç±»å‹**

| ç±»å‹ | **è¯­æ³•ç¤ºä¾‹** | **è¯´æ˜** |
|------|-------------|---------|
| ğŸ”¸ **å­—ç¬¦ä¸²** | `name: "John"` | `å¯åŠ å¯ä¸åŠ å¼•å·` |
| ğŸ”¸ **æ•°å­—** | `port: 80` | `æ•´æ•°æˆ–æµ®ç‚¹æ•°` |
| ğŸ”¸ **å¸ƒå°”å€¼** | `enabled: true` | `true/falseæˆ–yes/no` |
| ğŸ”¸ **ç©ºå€¼** | `value: null` | `ç©ºå€¼æˆ–~ç¬¦å·` |
| ğŸ”¸ **åˆ—è¡¨** | `- item1` | `ç”¨çŸ­æ¨ªçº¿è¡¨ç¤º` |
| ğŸ”¸ **å­—å…¸** | `key: value` | `é”®å€¼å¯¹å½¢å¼` |

**ğŸ’¡ å®é™…åº”ç”¨ç¤ºä¾‹**
```yaml
# æ··åˆæ•°æ®ç±»å‹çš„å®é™…é…ç½®
cloud_config:
  # å­—ç¬¦ä¸²ç±»å‹
  hostname: web-server-01
  
  # æ•°å­—ç±»å‹
  ssh_port: 2222
  memory_limit: 1024.5
  
  # å¸ƒå°”ç±»å‹
  ssh_password_auth: false
  auto_update: yes
  
  # ç©ºå€¼ç±»å‹
  custom_script: null
  
  # åˆ—è¡¨ç±»å‹
  packages:
    - nginx
    - mysql-server
    - php-fpm
  
  # åµŒå¥—å­—å…¸
  users:
    admin:
      password: "secret123"
      groups: [sudo, docker]
      ssh_authorized_keys:
        - "ssh-rsa AAAAB3NzaC1yc2E..."
```

---

## 2. ğŸ­ cloud-configé­”æ³•å­—ç¬¦ä¸²


### 2.1 é­”æ³•å­—ç¬¦ä¸²çš„ä½œç”¨

ğŸ”® **ç®€å•ç†è§£**ï¼šé­”æ³•å­—ç¬¦ä¸²å°±åƒ"æš—å·"ï¼Œå‘Šè¯‰ç³»ç»Ÿè¿™æ˜¯cloud-configæ–‡ä»¶

```
æ–‡ä»¶è¯†åˆ«æœºåˆ¶ï¼š

æ™®é€šæ–‡æœ¬æ–‡ä»¶ï¼š
Hello World

Shellè„šæœ¬ï¼š
#!/bin/bash
echo "Hello"

cloud-configæ–‡ä»¶ï¼š
#cloud-config
hostname: myserver

ä½œç”¨å¯¹æ¯”ï¼š
- Shellçš„#!/bin/bash â†’ å‘Šè¯‰ç³»ç»Ÿç”¨bashæ‰§è¡Œ
- cloud-configçš„#cloud-config â†’ å‘Šè¯‰cloud-initè¿™æ˜¯é…ç½®æ–‡ä»¶
```

### 2.2 é­”æ³•å­—ç¬¦ä¸²çš„æ ‡å‡†æ ¼å¼

**ğŸ“ æ­£ç¡®çš„é­”æ³•å­—ç¬¦ä¸²å†™æ³•**

```yaml
#cloud-config

# âœ… æ­£ç¡®å†™æ³• - ç¬¬ä¸€è¡Œï¼Œé¡¶æ ¼å†™ï¼Œåé¢è·Ÿæ¢è¡Œ
hostname: myserver
```

**âŒ å¸¸è§é”™è¯¯å†™æ³•**
```yaml
# cloud-config    âŒ ä¸­é—´æœ‰ç©ºæ ¼
#cloud-config     âŒ å‰é¢æœ‰ç©ºæ ¼
# #cloud-config   âŒ ä¸¤ä¸ª#å·
#CLOUD-CONFIG     âŒ å¤§å†™å­—æ¯

# æ­£ç¡®ç¤ºä¾‹å¿…é¡»æ˜¯ï¼š
#cloud-config
```

### 2.3 å…¶ä»–æ”¯æŒçš„é­”æ³•å­—ç¬¦ä¸²

**ğŸ”§ cloud-initæ”¯æŒçš„æ–‡ä»¶ç±»å‹**

```bash
# 1. Shellè„šæœ¬
#!/bin/bash
apt update && apt upgrade -y

# 2. cloud-configæ–‡ä»¶
#cloud-config
hostname: server01

# 3. cloud-boothookè„šæœ¬
#cloud-boothook
#!/bin/bash
echo "åœ¨æ¯æ¬¡å¯åŠ¨æ—¶éƒ½æ‰§è¡Œ"

# 4. upstartä»»åŠ¡
#upstart-job
description "custom service"
start on started networking

# 5. includeæ–‡ä»¶
#include
http://example.com/additional-config.yaml
```

**ğŸ’¡ ä½¿ç”¨åœºæ™¯å¯¹æ¯”**

| ç±»å‹ | **æ‰§è¡Œæ—¶æœº** | **é€‚ç”¨åœºæ™¯** |
|------|-------------|-------------|
| ğŸ”¸ **#cloud-config** | `é¦–æ¬¡å¯åŠ¨` | `ç³»ç»Ÿåˆå§‹åŒ–é…ç½®` |
| ğŸ”¸ **#!/bin/bash** | `é¦–æ¬¡å¯åŠ¨` | `ä¸€æ¬¡æ€§è„šæœ¬æ‰§è¡Œ` |
| ğŸ”¸ **#cloud-boothook** | `æ¯æ¬¡å¯åŠ¨` | `æŒç»­æ€§æ£€æŸ¥ä»»åŠ¡` |
| ğŸ”¸ **#include** | `é¦–æ¬¡å¯åŠ¨` | `å¼•ç”¨å¤–éƒ¨é…ç½®` |

---

## 3. ğŸ“¦ é…ç½®é¡¹åˆ†ç±»ä¸æ¨¡å—


### 3.1 cloud-configæ¨¡å—åŒ–è®¾è®¡

ğŸ¯ **æ¨¡å—åŒ–ç†å¿µ**ï¼šcloud-configæŒ‰åŠŸèƒ½åˆ’åˆ†ä¸åŒæ¨¡å—ï¼Œå„å¸å…¶èŒ

```
æ¨¡å—åˆ†ç±»ä½“ç³»ï¼š

ç³»ç»Ÿé…ç½®æ¨¡å—ï¼š
â”œâ”€â”€ ä¸»æœºåå’Œç½‘ç»œ
â”œâ”€â”€ ç”¨æˆ·å’Œæƒé™ç®¡ç†  
â”œâ”€â”€ è½¯ä»¶åŒ…ç®¡ç†
â””â”€â”€ æ–‡ä»¶ç³»ç»Ÿæ“ä½œ

æœåŠ¡é…ç½®æ¨¡å—ï¼š
â”œâ”€â”€ SSHæœåŠ¡é…ç½®
â”œâ”€â”€ ç³»ç»ŸæœåŠ¡ç®¡ç†
â”œâ”€â”€ é˜²ç«å¢™è®¾ç½®
â””â”€â”€ å®šæ—¶ä»»åŠ¡é…ç½®

æ‰©å±•åŠŸèƒ½æ¨¡å—ï¼š
â”œâ”€â”€ è„šæœ¬æ‰§è¡Œ
â”œâ”€â”€ å¤–éƒ¨èµ„æºä¸‹è½½
â”œâ”€â”€ ç›‘æ§å’Œæ—¥å¿—
â””â”€â”€ äº‘å¹³å°ç‰¹å®šåŠŸèƒ½
```

### 3.2 ç³»ç»ŸåŸºç¡€é…ç½®æ¨¡å—

**ğŸ–¥ï¸ ç³»ç»Ÿçº§åˆ«çš„åŸºç¡€è®¾ç½®**

```yaml
#cloud-config

# ä¸»æœºåé…ç½®
hostname: web-server-prod-01
fqdn: web-server-prod-01.company.com

# æ—¶åŒºè®¾ç½®
timezone: Asia/Shanghai

# è¯­è¨€ç¯å¢ƒ
locale: en_US.UTF-8

# é”®ç›˜å¸ƒå±€
keyboard:
  layout: us
  variant: ""

# ç½‘ç»œé…ç½®
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: false
      addresses:
        - 192.168.1.100/24
      gateway4: 192.168.1.1
      nameservers:
        addresses:
          - 8.8.8.8
          - 114.114.114.114
```

### 3.3 ç”¨æˆ·ç®¡ç†é…ç½®æ¨¡å—

**ğŸ‘¥ ç”¨æˆ·è´¦æˆ·å’Œæƒé™é…ç½®**

```yaml
#cloud-config

# é»˜è®¤ç”¨æˆ·é…ç½®
system_info:
  default_user:
    name: ubuntu
    groups: [adm, audio, cdrom, dialout, dip, floppy, lxd, netdev, plugdev, sudo, video]
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    shell: /bin/bash

# åˆ›å»ºæ–°ç”¨æˆ·
users:
  - name: admin
    gecos: "System Administrator"
    groups: [sudo, docker]
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    shell: /bin/bash
    # è®¾ç½®å¯†ç  (éœ€è¦å…ˆç”Ÿæˆhash)
    passwd: "$6$rounds=4096$..."
    # SSHå…¬é’¥
    ssh_authorized_keys:
      - "ssh-rsa AAAAB3NzaC1yc2EAAAA..."
    
  - name: developer
    groups: [docker, www-data]
    shell: /bin/bash
    # ç¦ç”¨å¯†ç ç™»å½•
    lock_passwd: true
    ssh_authorized_keys:
      - "ssh-rsa AAAAB3NzaC1yc2EBBBB..."

# SSHæœåŠ¡é…ç½®
ssh_pwauth: false
ssh_authorized_keys:
  - "ssh-rsa AAAAB3NzaC1yc2ECCCC..."

# ç¦ç”¨rootç™»å½•
disable_root: true
```

### 3.4 è½¯ä»¶åŒ…ç®¡ç†æ¨¡å—

**ğŸ“¦ è½¯ä»¶å®‰è£…å’Œä»“åº“é…ç½®**

```yaml
#cloud-config

# é…ç½®è½¯ä»¶ä»“åº“
apt:
  # æ›´æ–°æºåˆ—è¡¨
  sources:
    docker:
      source: "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"
      keyid: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88
    
    nodejs:
      source: "deb https://deb.nodesource.com/node_16.x focal main"
      key: |
        -----BEGIN PGP PUBLIC KEY BLOCK-----
        mQINBF...
        -----END PGP PUBLIC KEY BLOCK-----

# ç³»ç»Ÿæ›´æ–°ç­–ç•¥
package_update: true
package_upgrade: true
package_reboot_if_required: false

# å®‰è£…è½¯ä»¶åŒ…
packages:
  - curl
  - wget
  - git
  - vim
  - htop
  - nginx
  - docker.io
  - nodejs
  - python3-pip

# ç§»é™¤ä¸éœ€è¦çš„è½¯ä»¶åŒ…
package_removal:
  - snapd
  - cloud-guest-utils
```

### 3.5 æœåŠ¡å’Œè„šæœ¬æ‰§è¡Œæ¨¡å—

**âš™ï¸ ç³»ç»ŸæœåŠ¡å’Œè‡ªå®šä¹‰è„šæœ¬ç®¡ç†**

```yaml
#cloud-config

# ç³»ç»ŸæœåŠ¡ç®¡ç†
bootcmd:
  # åœ¨å¯åŠ¨earlyé˜¶æ®µæ‰§è¡Œ
  - echo "System boot starting..." >> /var/log/cloud-init.log
  - systemctl stop ufw

runcmd:
  # åœ¨ç³»ç»Ÿé…ç½®å®Œæˆåæ‰§è¡Œ
  - systemctl enable nginx
  - systemctl start nginx
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable
  - docker run hello-world

# å†™å…¥æ–‡ä»¶
write_files:
  - path: /etc/nginx/sites-available/default
    content: |
      server {
          listen 80 default_server;
          server_name _;
          root /var/www/html;
          index index.html;
          
          location / {
              try_files $uri $uri/ =404;
          }
      }
    permissions: "0644"
    owner: root:root

  - path: /var/www/html/index.html
    content: |
      <!DOCTYPE html>
      <html>
      <head><title>Welcome</title></head>
      <body><h1>Cloud Server Ready!</h1></body>
      </html>
    permissions: "0644"
    owner: www-data:www-data

# ç”µæºç®¡ç†
power_state:
  delay: "now"
  mode: reboot
  message: "System configured, rebooting..."
  timeout: 30
  condition: true
```

---

## 4. âš™ï¸ æ¡ä»¶æ‰§è¡Œé…ç½®


### 4.1 æ¡ä»¶æ‰§è¡Œçš„åŸºæœ¬æ¦‚å¿µ

ğŸ¯ **æ ¸å¿ƒæ€æƒ³**ï¼šæ ¹æ®ç³»ç»Ÿç¯å¢ƒæˆ–å˜é‡å€¼å†³å®šæ˜¯å¦æ‰§è¡ŒæŸäº›é…ç½®

```
æ¡ä»¶æ‰§è¡Œçš„åº”ç”¨åœºæ™¯ï¼š

ç¯å¢ƒåŒºåˆ†ï¼š
- å¼€å‘ç¯å¢ƒå®‰è£…è°ƒè¯•å·¥å…·
- ç”Ÿäº§ç¯å¢ƒå¯ç”¨å®‰å…¨ç­–ç•¥

ç¡¬ä»¶é€‚é…ï¼š
- GPUæœåŠ¡å™¨å®‰è£…NVIDIAé©±åŠ¨
- é«˜å†…å­˜æœåŠ¡å™¨è°ƒæ•´å‚æ•°

äº‘å¹³å°å·®å¼‚ï¼š
- AWSç‰¹å®šé…ç½®
- Azureç‰¹å®šè®¾ç½®
```

### 4.2 åŸºäºå˜é‡çš„æ¡ä»¶é…ç½®

**ğŸ”§ ä½¿ç”¨å…ƒæ•°æ®å®ç°æ¡ä»¶åˆ¤æ–­**

```yaml
#cloud-config

# åŸºäºå®ä¾‹å…ƒæ•°æ®çš„æ¡ä»¶é…ç½®
merge_how: dict(recurse_array)+list(append)

# å¼€å‘ç¯å¢ƒç‰¹å®šé…ç½®
development_packages: &dev_packages
  - curl
  - wget
  - git
  - vim
  - htop
  - nodejs
  - npm

# ç”Ÿäº§ç¯å¢ƒç‰¹å®šé…ç½®  
production_packages: &prod_packages
  - curl
  - wget
  - git
  - vim
  - htop
  - nginx
  - docker.io

# æ ¹æ®ç¯å¢ƒå˜é‡é€‰æ‹©åŒ…åˆ—è¡¨
packages:
  # è¿™é‡Œéœ€è¦é€šè¿‡æ¨¡æ¿å¼•æ“æˆ–å¤–éƒ¨è„šæœ¬å®ç°æ¡ä»¶é€»è¾‘
  - curl
  - wget
  - git
```

### 4.3 ä½¿ç”¨å¤–éƒ¨è„šæœ¬å®ç°å¤æ‚æ¡ä»¶

**ğŸ“ é€šè¿‡shellè„šæœ¬å®ç°æ¡ä»¶åˆ¤æ–­**

```yaml
#cloud-config

bootcmd:
  # è®¾ç½®ç¯å¢ƒæ ‡è¯†
  - echo "ENVIRONMENT=${ENVIRONMENT:-production}" >> /etc/environment
  
runcmd:
  # æ¡ä»¶å®‰è£…è„šæœ¬
  - |
    source /etc/environment
    if [ "$ENVIRONMENT" = "development" ]; then
      apt install -y nodejs npm build-essential
      npm install -g nodemon pm2
      echo "å¼€å‘ç¯å¢ƒé…ç½®å®Œæˆ"
    elif [ "$ENVIRONMENT" = "production" ]; then
      apt install -y nginx certbot
      systemctl enable nginx
      echo "ç”Ÿäº§ç¯å¢ƒé…ç½®å®Œæˆ"
    fi
  
  # åŸºäºç¡¬ä»¶æ¡ä»¶çš„é…ç½®
  - |
    # æ£€æŸ¥GPU
    if lspci | grep -i nvidia; then
      echo "æ£€æµ‹åˆ°NVIDIA GPUï¼Œå®‰è£…é©±åŠ¨..."
      apt install -y nvidia-driver-470
    fi
    
    # æ£€æŸ¥å†…å­˜å¤§å°
    MEMORY_GB=$(free -g | awk '/^Mem:/{print $2}')
    if [ $MEMORY_GB -gt 16 ]; then
      echo "vm.swappiness=1" >> /etc/sysctl.conf
      echo "é«˜å†…å­˜ç³»ç»Ÿï¼Œè°ƒæ•´swapç­–ç•¥"
    fi

write_files:
  - path: /usr/local/bin/conditional-setup.sh
    content: |
      #!/bin/bash
      
      # è¯»å–äº‘å¹³å°ä¿¡æ¯
      CLOUD_PROVIDER=$(curl -s http://169.254.169.254/latest/meta-data/services/domain 2>/dev/null || echo "unknown")
      
      case $CLOUD_PROVIDER in
        "amazonaws.com")
          echo "AWSç¯å¢ƒé…ç½®"
          # AWSç‰¹å®šé…ç½®
          yum install -y aws-cli
          ;;
        "azure")
          echo "Azureç¯å¢ƒé…ç½®"  
          # Azureç‰¹å®šé…ç½®
          ;;
        *)
          echo "é€šç”¨äº‘ç¯å¢ƒé…ç½®"
          ;;
      esac
    permissions: "0755"
```

### 4.4 æ¨¡æ¿å˜é‡æ›¿æ¢

**ğŸ”„ ä½¿ç”¨Jinja2æ¨¡æ¿è¯­æ³•å®ç°æ¡ä»¶é…ç½®**

```yaml
#cloud-config

# æ³¨æ„ï¼šè¿™éœ€è¦æ”¯æŒæ¨¡æ¿å¼•æ“çš„cloud-initç‰ˆæœ¬

{% if environment == 'development' %}
packages:
  - curl
  - wget
  - git
  - nodejs
  - npm
  - build-essential

users:
  - name: developer
    groups: [sudo, docker]
    shell: /bin/bash
{% elif environment == 'production' %}
packages:
  - curl
  - wget
  - git
  - nginx
  - docker.io

users:
  - name: operator
    groups: [docker]
    shell: /bin/bash
    lock_passwd: true
{% endif %}

# ä½¿ç”¨å˜é‡æ›¿æ¢
hostname: {{ instance_name | default('cloud-server') }}
timezone: {{ timezone | default('UTC') }}

write_files:
  - path: /etc/motd
    content: |
      Welcome to {{ hostname }}
      Environment: {{ environment }}
      Deployed: {{ ansible_date_time.iso8601 }}
```

---

## 5. ğŸ”— å¤šæ–‡æ¡£åˆå¹¶è§„åˆ™


### 5.1 å¤šæ–‡æ¡£åˆå¹¶çš„å·¥ä½œåŸç†

ğŸ¯ **æ ¸å¿ƒæ¦‚å¿µ**ï¼šcloud-initå¯ä»¥ä»å¤šä¸ªæ¥æºè·å–é…ç½®ï¼Œå¹¶æŒ‰è§„åˆ™åˆå¹¶

```
é…ç½®æ¥æºä¼˜å…ˆçº§ï¼š

1. ç”¨æˆ·æ•°æ® (User Data)           - æœ€é«˜ä¼˜å…ˆçº§
2. å®ä¾‹å…ƒæ•°æ® (Instance Metadata) - ä¸­ç­‰ä¼˜å…ˆçº§  
3. æ•°æ®æºé…ç½® (Datasource Config) - é»˜è®¤é…ç½®
4. å‘è¡Œç‰ˆé…ç½® (Distro Config)     - æœ€ä½ä¼˜å…ˆçº§

åˆå¹¶æµç¨‹ï¼š
åŸºç¡€é…ç½® + æ•°æ®æºé…ç½® + å…ƒæ•°æ®é…ç½® + ç”¨æˆ·é…ç½® = æœ€ç»ˆé…ç½®
```

### 5.2 åˆå¹¶ç­–ç•¥é…ç½®

**âš™ï¸ æ§åˆ¶ä¸åŒæ•°æ®ç±»å‹çš„åˆå¹¶æ–¹å¼**

```yaml
#cloud-config

# åˆå¹¶ç­–ç•¥å£°æ˜
merge_how:
  # å­—å…¸ç±»å‹ï¼šé€’å½’åˆå¹¶ + åˆ—è¡¨è¿½åŠ 
  - name: list
    settings: [append]
  - name: dict  
    settings: [no_replace, recurse_list]

# æˆ–è€…ä½¿ç”¨ç®€åŒ–è¯­æ³•
merge_how: dict(recurse_array)+list(append)

# ç¤ºä¾‹é…ç½® - åŸºç¡€é…ç½®
packages:
  - curl
  - wget

users:
  - name: admin
    groups: [sudo]

# ç¤ºä¾‹é…ç½® - é™„åŠ é…ç½®
packages:
  - git
  - vim

users:
  - name: developer
    groups: [docker]

# åˆå¹¶ç»“æœï¼š
# packages: [curl, wget, git, vim]
# users: [admin, developer]
```

### 5.3 å¤æ‚åˆå¹¶åœºæ™¯å¤„ç†

**ğŸ”§ å¤„ç†é…ç½®å†²çªå’Œè¦†ç›–**

```yaml
#cloud-config

# åœºæ™¯1ï¼šå®Œå…¨æ›¿æ¢ç­–ç•¥
merge_how: list(replace)+dict(replace)

# åŸé…ç½®
ssh_authorized_keys:
  - "ssh-rsa AAAA...old-key"

# æ–°é…ç½®  
ssh_authorized_keys:
  - "ssh-rsa BBBB...new-key"

# ç»“æœï¼šåªä¿ç•™æ–°é…ç½®çš„key

# åœºæ™¯2ï¼šé€’å½’åˆå¹¶ç­–ç•¥
merge_how: dict(recurse_array,no_replace)+list(append)

# é…ç½®A
write_files:
  - path: /etc/hosts
    content: "127.0.0.1 localhost"
    permissions: "0644"

# é…ç½®B
write_files:
  - path: /etc/hosts
    content: "192.168.1.100 myserver"  # ä¼šè¦†ç›–content
    owner: root:root                   # ä¼šæ·»åŠ owner

# ç»“æœï¼šcontentè¢«æ›¿æ¢ï¼Œpermissionså’Œowneréƒ½ä¿ç•™
```

### 5.4 åˆ†æ¨¡å—é…ç½®ç®¡ç†

**ğŸ“ ä½¿ç”¨includeå®ç°æ¨¡å—åŒ–é…ç½®**

```yaml
#cloud-config

# ä¸»é…ç½®æ–‡ä»¶
merge_how: dict(recurse_array)+list(append)

# å¼•ç”¨å…¶ä»–é…ç½®æ–‡ä»¶
cloud_config_modules:
  - include

# åŒ…å«å¤–éƒ¨é…ç½®
#include
- http://config-server.com/base-config.yaml
- http://config-server.com/app-specific.yaml

# æœ¬åœ°é…ç½®è¦†ç›–
hostname: custom-hostname

packages:
  - custom-package

# é…ç½®æ–‡ä»¶ç»“æ„ç¤ºä¾‹
base-config.yaml:
  packages:
    - curl
    - wget
    - git
  
  users:
    - name: admin
      groups: [sudo]

app-specific.yaml:
  packages:
    - nginx
    - docker.io
  
  write_files:
    - path: /etc/nginx/nginx.conf
      content: |
        # Nginxé…ç½®å†…å®¹
```

---

## 6. âœ… é…ç½®éªŒè¯ä¸è¯­æ³•æ£€æŸ¥


### 6.1 äº‘é…ç½®éªŒè¯å·¥å…·

ğŸ” **cloud-initå†…ç½®éªŒè¯åŠŸèƒ½**

```bash
# 1. è¯­æ³•éªŒè¯
cloud-init schema --config-file user-data.yaml

# 2. è¯¦ç»†éªŒè¯è¾“å‡º
cloud-init schema --config-file user-data.yaml --annotate

# 3. éªŒè¯æŒ‡å®šæ¨¡å—
cloud-init schema --config-file user-data.yaml --system

# 4. æ‰¹é‡éªŒè¯å¤šä¸ªæ–‡ä»¶
for file in *.yaml; do
  echo "éªŒè¯æ–‡ä»¶: $file"
  cloud-init schema --config-file "$file"
done
```

### 6.2 YAMLè¯­æ³•æ£€æŸ¥

**ğŸ“ ä½¿ç”¨å¤–éƒ¨å·¥å…·éªŒè¯YAMLæ ¼å¼**

```bash
# ä½¿ç”¨yamllintæ£€æŸ¥YAMLè¯­æ³•
sudo apt install yamllint

# åŸºæœ¬è¯­æ³•æ£€æŸ¥
yamllint user-data.yaml

# è¯¦ç»†æ ¼å¼æ£€æŸ¥
yamllint -d relaxed user-data.yaml

# è‡ªå®šä¹‰æ£€æŸ¥è§„åˆ™
cat > .yamllint << EOF
rules:
  line-length:
    max: 120
  indentation:
    spaces: 2
  comments:
    min-spaces-from-content: 1
EOF

yamllint -c .yamllint user-data.yaml

# ä½¿ç”¨PythonéªŒè¯YAML
python3 -c "
import yaml
import sys

try:
    with open('user-data.yaml', 'r') as f:
        yaml.safe_load(f)
    print('YAMLè¯­æ³•æ­£ç¡®')
except yaml.YAMLError as e:
    print(f'YAMLè¯­æ³•é”™è¯¯: {e}')
    sys.exit(1)
"
```

### 6.3 é…ç½®é€»è¾‘éªŒè¯

**ğŸ§  éªŒè¯é…ç½®çš„é€»è¾‘åˆç†æ€§**

```bash
# åˆ›å»ºé…ç½®éªŒè¯è„šæœ¬
cat > validate-cloud-config.sh << 'EOF'
#!/bin/bash

CONFIG_FILE="$1"
ERRORS=0

# æ£€æŸ¥é­”æ³•å­—ç¬¦ä¸²
if ! head -1 "$CONFIG_FILE" | grep -q "^#cloud-config$"; then
    echo "é”™è¯¯: ç¼ºå°‘æˆ–é”™è¯¯çš„é­”æ³•å­—ç¬¦ä¸²"
    ERRORS=$((ERRORS + 1))
fi

# æ£€æŸ¥å¿…éœ€çš„é…ç½®é¡¹
if ! grep -q "^hostname:" "$CONFIG_FILE"; then
    echo "è­¦å‘Š: æœªè®¾ç½®hostname"
fi

# æ£€æŸ¥ç”¨æˆ·é…ç½®
if grep -q "^users:" "$CONFIG_FILE"; then
    if ! grep -A 10 "^users:" "$CONFIG_FILE" | grep -q "ssh_authorized_keys:"; then
        echo "è­¦å‘Š: ç”¨æˆ·é…ç½®ä¸­ç¼ºå°‘SSHå…¬é’¥"
    fi
fi

# æ£€æŸ¥åŒ…ç®¡ç†é…ç½®
if grep -q "^packages:" "$CONFIG_FILE"; then
    echo "æ£€æŸ¥è½¯ä»¶åŒ…é…ç½®..."
    # æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤åŒ…
    packages=$(grep -A 50 "^packages:" "$CONFIG_FILE" | grep "^  -" | sort)
    duplicates=$(echo "$packages" | uniq -d)
    if [ -n "$duplicates" ]; then
        echo "è­¦å‘Š: å‘ç°é‡å¤çš„è½¯ä»¶åŒ…é…ç½®"
        echo "$duplicates"
    fi
fi

# æ£€æŸ¥æ–‡ä»¶å†™å…¥æƒé™
if grep -q "^write_files:" "$CONFIG_FILE"; then
    echo "æ£€æŸ¥æ–‡ä»¶å†™å…¥é…ç½®..."
    # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šæ£€æŸ¥é€»è¾‘
fi

if [ $ERRORS -eq 0 ]; then
    echo "é…ç½®éªŒè¯é€šè¿‡"
    exit 0
else
    echo "å‘ç° $ERRORS ä¸ªé”™è¯¯"
    exit 1
fi
EOF

chmod +x validate-cloud-config.sh
./validate-cloud-config.sh user-data.yaml
```

### 6.4 æµ‹è¯•ç¯å¢ƒéªŒè¯

**ğŸ§ª åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯é…ç½®æ•ˆæœ**

```bash
# ä½¿ç”¨multipassåˆ›å»ºæµ‹è¯•å®ä¾‹
multipass launch --name test-cloud-config --cloud-init user-data.yaml

# éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆ
multipass exec test-cloud-config -- hostname
multipass exec test-cloud-config -- cat /etc/hosts
multipass exec test-cloud-config -- systemctl status nginx

# æ£€æŸ¥cloud-initæ—¥å¿—
multipass exec test-cloud-config -- cat /var/log/cloud-init.log
multipass exec test-cloud-config -- cat /var/log/cloud-init-output.log

# æ¸…ç†æµ‹è¯•å®ä¾‹
multipass delete test-cloud-config
multipass purge

# ä½¿ç”¨Dockeræµ‹è¯•cloud-init
docker run -it --rm \
  -v $(pwd)/user-data.yaml:/user-data.yaml \
  ubuntu:20.04 \
  bash -c "
    apt update && apt install -y cloud-init
    cloud-init schema --config-file /user-data.yaml
  "
```

---

## 7. ğŸ”„ å˜é‡æ›¿æ¢æœºåˆ¶


### 7.1 å˜é‡æ›¿æ¢çš„åŸºæœ¬æ¦‚å¿µ

ğŸ¯ **æ ¸å¿ƒä»·å€¼**ï¼šè®©é…ç½®æ–‡ä»¶æ”¯æŒåŠ¨æ€å†…å®¹ï¼Œæé«˜å¤ç”¨æ€§

```
å˜é‡æ›¿æ¢çš„ä¼˜åŠ¿ï¼š

æ¨¡æ¿åŒ–é…ç½®ï¼š
- ä¸€ä»½é…ç½®é€‚ç”¨å¤šä¸ªç¯å¢ƒ
- å‡å°‘é‡å¤é…ç½®å†…å®¹
- æé«˜é…ç½®ç®¡ç†æ•ˆç‡

åŠ¨æ€é…ç½®ï¼š
- æ ¹æ®å®ä¾‹ä¿¡æ¯è‡ªåŠ¨è°ƒæ•´
- æ”¯æŒè¿è¡Œæ—¶å‚æ•°ä¼ å…¥
- å®ç°ä¸ªæ€§åŒ–å®šåˆ¶
```

### 7.2 å†…ç½®å˜é‡ç³»ç»Ÿ

**ğŸ—ï¸ cloud-initæä¾›çš„å†…ç½®å˜é‡**

```yaml
#cloud-config

# ä½¿ç”¨å†…ç½®å˜é‡
hostname: ${instance_id}
fqdn: ${instance_id}.${region}.compute.internal

write_files:
  - path: /etc/motd
    content: |
      Welcome to ${hostname}
      Instance ID: ${instance_id}
      Region: ${region}
      Availability Zone: ${availability_zone}
      Instance Type: ${instance_type}
      Local IPv4: ${local_ipv4}
      Public IPv4: ${public_ipv4}

runcmd:
  - echo "Instance metadata:" > /var/log/instance-info.log
  - echo "ID: ${instance_id}" >> /var/log/instance-info.log
  - echo "Type: ${instance_type}" >> /var/log/instance-info.log
  - echo "Region: ${region}" >> /var/log/instance-info.log
```

### 7.3 è‡ªå®šä¹‰å˜é‡å®šä¹‰

**ğŸ“ å®šä¹‰å’Œä½¿ç”¨è‡ªå®šä¹‰å˜é‡**

```yaml
#cloud-config

# æ–¹å¼1ï¼šåœ¨é…ç½®å¼€å¤´å®šä¹‰å˜é‡
variables:
  app_name: "myapp"
  app_version: "1.0.0"
  environment: "production"
  admin_email: "admin@company.com"

# ä½¿ç”¨è‡ªå®šä¹‰å˜é‡
hostname: ${app_name}-${environment}-01

users:
  - name: ${app_name}
    gecos: "${app_name} service account"
    shell: /bin/bash

write_files:
  - path: /opt/${app_name}/config.json
    content: |
      {
        "app_name": "${app_name}",
        "version": "${app_version}",
        "environment": "${environment}",
        "contact": "${admin_email}"
      }

  - path: /etc/systemd/system/${app_name}.service
    content: |
      [Unit]
      Description=${app_name} Service
      After=network.target
      
      [Service]
      Type=simple
      User=${app_name}
      WorkingDirectory=/opt/${app_name}
      ExecStart=/opt/${app_name}/start.sh
      
      [Install]
      WantedBy=multi-user.target
```

### 7.4 é«˜çº§å˜é‡å¤„ç†

**âš™ï¸ å¤æ‚çš„å˜é‡æ“ä½œå’Œå‡½æ•°**

```yaml
#cloud-config

# å˜é‡è®¡ç®—å’Œå¤„ç†
variables:
  base_name: "webserver"
  instance_num: "01"
  # å­—ç¬¦ä¸²æ‹¼æ¥
  full_hostname: "${base_name}-${instance_num}"
  # æ¡ä»¶å˜é‡
  nginx_user: "${environment == 'production' ? 'www-data' : 'nginx'}"

# ç¯å¢ƒå˜é‡å¼•ç”¨
hostname: ${HOSTNAME:-default-host}
timezone: ${TZ:-UTC}

# ä½¿ç”¨å¤–éƒ¨å‘½ä»¤ç»“æœ
runcmd:
  # è·å–ç³»ç»Ÿä¿¡æ¯ä½œä¸ºå˜é‡
  - MEMORY_GB=$(free -g | awk '/^Mem:/{print $2}')
  - CPU_CORES=$(nproc)
  - echo "System: ${CPU_CORES}C/${MEMORY_GB}G" > /etc/system-info

write_files:
  - path: /usr/local/bin/setup-${app_name}.sh
    content: |
      #!/bin/bash
      
      # ç¯å¢ƒå˜é‡è®¾ç½®
      export APP_NAME="${app_name}"
      export APP_VERSION="${app_version}"
      export ENVIRONMENT="${environment}"
      
      # æ ¹æ®ç¯å¢ƒè°ƒæ•´é…ç½®
      if [ "$ENVIRONMENT" = "production" ]; then
        WORKERS=4
        DEBUG=false
      else
        WORKERS=2
        DEBUG=true
      fi
      
      echo "APP_NAME=$APP_NAME" > /opt/${app_name}/.env
      echo "WORKERS=$WORKERS" >> /opt/${app_name}/.env
      echo "DEBUG=$DEBUG" >> /opt/${app_name}/.env
    permissions: "0755"
```

---

## 8. ğŸ› é…ç½®æ–‡ä»¶è°ƒè¯•æŠ€å·§


### 8.1 cloud-initè°ƒè¯•åŸºç¡€

ğŸ” **æŒæ¡è°ƒè¯•cloud-initçš„åŸºæœ¬æ–¹æ³•**

```bash
# 1. æŸ¥çœ‹cloud-initçŠ¶æ€
cloud-init status
cloud-init status --long

# 2. é‡æ–°è¿è¡Œcloud-init (è°ƒè¯•æ—¶æœ‰ç”¨)
sudo cloud-init clean --logs
sudo cloud-init init
sudo cloud-init modules --mode config
sudo cloud-init modules --mode final

# 3. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
sudo cat /var/log/cloud-init.log
sudo cat /var/log/cloud-init-output.log

# 4. åˆ†æé…ç½®å¤„ç†è¿‡ç¨‹
sudo cloud-init query --all
sudo cloud-init query userdata
sudo cloud-init query merged_cfg
```

### 8.2 æ—¥å¿—åˆ†ææŠ€å·§

**ğŸ“Š é«˜æ•ˆåˆ†æcloud-initæ—¥å¿—**

```bash
# è¿‡æ»¤ç‰¹å®šé˜¶æ®µçš„æ—¥å¿—
grep "config-" /var/log/cloud-init.log

# æŸ¥çœ‹é”™è¯¯å’Œè­¦å‘Š
grep -E "(ERROR|WARNING)" /var/log/cloud-init.log

# æŸ¥çœ‹ç‰¹å®šæ¨¡å—æ‰§è¡Œæƒ…å†µ
grep "cc_" /var/log/cloud-init.log

# åˆ†æé…ç½®åˆå¹¶è¿‡ç¨‹
grep -A 5 -B 5 "merging" /var/log/cloud-init.log

# æŸ¥çœ‹ç”¨æˆ·æ•°æ®å¤„ç†
grep -A 10 "user-data" /var/log/cloud-init.log

# è„šæœ¬æ‰§è¡Œç»“æœ
grep -A 20 "runcmd" /var/log/cloud-init-output.log

# åˆ›å»ºæ—¥å¿—åˆ†æè„šæœ¬
cat > analyze-cloud-init.sh << 'EOF'
#!/bin/bash

LOG_FILE="/var/log/cloud-init.log"
OUTPUT_LOG="/var/log/cloud-init-output.log"

echo "=== Cloud-Init è°ƒè¯•åˆ†æ ==="
echo "æ—¶é—´: $(date)"
echo "çŠ¶æ€: $(cloud-init status --long)"
echo

echo "=== æ‰§è¡Œé˜¶æ®µåˆ†æ ==="
for stage in init config final; do
    count=$(grep -c "stage-$stage" $LOG_FILE)
    echo "$stage é˜¶æ®µæ‰§è¡Œæ¬¡æ•°: $count"
done

echo -e "\n=== é”™è¯¯å’Œè­¦å‘Š ==="
grep -E "(ERROR|WARNING|FAIL)" $LOG_FILE | tail -10

echo -e "\n=== æœ€è¿‘æ‰§è¡Œçš„æ¨¡å— ==="
grep "cc_" $LOG_FILE | tail -10 | awk '{print $1, $2, $6}'

echo -e "\n=== ç”¨æˆ·è„šæœ¬è¾“å‡º ==="
if [ -f "$OUTPUT_LOG" ]; then
    tail -20 $OUTPUT_LOG
else
    echo "æ— è¾“å‡ºæ—¥å¿—æ–‡ä»¶"
fi
EOF

chmod +x analyze-cloud-init.sh
sudo ./analyze-cloud-init.sh
```

### 8.3 é…ç½®è°ƒè¯•ç­–ç•¥

**ğŸ”§ ç³»ç»ŸåŒ–çš„è°ƒè¯•æ–¹æ³•**

```yaml
#cloud-config

# è°ƒè¯•æŠ€å·§1ï¼šæ·»åŠ è°ƒè¯•è¾“å‡º
bootcmd:
  - echo "=== è°ƒè¯•: bootcmdé˜¶æ®µå¼€å§‹ ===" >> /var/log/debug.log
  - date >> /var/log/debug.log

runcmd:
  - echo "=== è°ƒè¯•: runcmdé˜¶æ®µå¼€å§‹ ===" >> /var/log/debug.log
  - echo "å½“å‰ç”¨æˆ·: $(whoami)" >> /var/log/debug.log
  - echo "å½“å‰ç›®å½•: $(pwd)" >> /var/log/debug.log
  - echo "ç¯å¢ƒå˜é‡:" >> /var/log/debug.log
  - env >> /var/log/debug.log
  
  # å…³é”®å‘½ä»¤æ·»åŠ é”™è¯¯å¤„ç†
  - |
    if ! systemctl start nginx; then
      echo "é”™è¯¯: nginxå¯åŠ¨å¤±è´¥" >> /var/log/debug.log
      systemctl status nginx >> /var/log/debug.log
    fi

# è°ƒè¯•æŠ€å·§2ï¼šåˆ†é˜¶æ®µéªŒè¯
write_files:
  - path: /usr/local/bin/verify-config.sh
    content: |
      #!/bin/bash
      echo "=== é…ç½®éªŒè¯å¼€å§‹ ===" | tee -a /var/log/verify.log
      
      # æ£€æŸ¥ç½‘ç»œ
      if ping -c 1 8.8.8.8 >/dev/null 2>&1; then
        echo "âœ“ ç½‘ç»œè¿æ¥æ­£å¸¸" | tee -a /var/log/verify.log
      else
        echo "âœ— ç½‘ç»œè¿æ¥å¼‚å¸¸" | tee -a /var/log/verify.log
      fi
      
      # æ£€æŸ¥æœåŠ¡
      for service in nginx ssh; do
        if systemctl is-active $service >/dev/null 2>&1; then
          echo "âœ“ $service æœåŠ¡è¿è¡Œæ­£å¸¸" | tee -a /var/log/verify.log
        else
          echo "âœ— $service æœåŠ¡å¼‚å¸¸" | tee -a /var/log/verify.log
        fi
      done
      
      # æ£€æŸ¥ç”¨æˆ·
      if id admin >/dev/null 2>&1; then
        echo "âœ“ ç”¨æˆ·adminåˆ›å»ºæˆåŠŸ" | tee -a /var/log/verify.log
      else
        echo "âœ— ç”¨æˆ·adminåˆ›å»ºå¤±è´¥" | tee -a /var/log/verify.log
      fi
    permissions: "0755"

  # è°ƒè¯•æŠ€å·§3ï¼šä¿å­˜é…ç½®å¿«ç…§
  - path: /usr/local/bin/save-config-snapshot.sh
    content: |
      #!/bin/bash
      SNAPSHOT_DIR="/var/log/config-snapshot"
      mkdir -p $SNAPSHOT_DIR
      
      # ä¿å­˜å…³é”®é…ç½®æ–‡ä»¶
      cp /etc/hostname $SNAPSHOT_DIR/
      cp /etc/hosts $SNAPSHOT_DIR/
      cp -r /etc/ssh $SNAPSHOT_DIR/ssh-config
      
      # ä¿å­˜ç³»ç»ŸçŠ¶æ€
      systemctl list-units --state=active > $SNAPSHOT_DIR/active-services.txt
      dpkg -l > $SNAPSHOT_DIR/installed-packages.txt
      
      echo "é…ç½®å¿«ç…§ä¿å­˜å®Œæˆ: $SNAPSHOT_DIR"
    permissions: "0755"

# æ‰§è¡ŒéªŒè¯è„šæœ¬
runcmd:
  - /usr/local/bin/verify-config.sh
  - /usr/local/bin/save-config-snapshot.sh
```

### 8.4 å¸¸è§é—®é¢˜æ’æŸ¥

**ğŸš¨ å…¸å‹é—®é¢˜çš„è¯Šæ–­å’Œè§£å†³**

```bash
# é—®é¢˜1ï¼šYAMLæ ¼å¼é”™è¯¯
# ç—‡çŠ¶ï¼šcloud-initæ— æ³•è§£æé…ç½®
# æ£€æŸ¥æ–¹æ³•ï¼š
cloud-init schema --config-file user-data.yaml
yamllint user-data.yaml

# é—®é¢˜2ï¼šæ¨¡å—æ‰§è¡Œå¤±è´¥  
# ç—‡çŠ¶ï¼šç‰¹å®šåŠŸèƒ½ä¸ç”Ÿæ•ˆ
# æ£€æŸ¥æ–¹æ³•ï¼š
grep "cc_users" /var/log/cloud-init.log
grep "ERROR" /var/log/cloud-init.log

# é—®é¢˜3ï¼šç½‘ç»œé…ç½®é—®é¢˜
# ç—‡çŠ¶ï¼šç½‘ç»œä¸é€šæˆ–é…ç½®é”™è¯¯
# æ£€æŸ¥æ–¹æ³•ï¼š
sudo netplan get
ip addr show
ip route show

# é—®é¢˜4ï¼šæƒé™é—®é¢˜
# ç—‡çŠ¶ï¼šæ–‡ä»¶åˆ›å»ºå¤±è´¥æˆ–æœåŠ¡å¯åŠ¨å¤±è´¥
# æ£€æŸ¥æ–¹æ³•ï¼š
ls -la /var/log/cloud-init*
sudo tail -f /var/log/cloud-init.log

# åˆ›å»ºä¸€é”®è¯Šæ–­è„šæœ¬
cat > diagnose-cloud-init.sh << 'EOF'
#!/bin/bash

echo "=== Cloud-Init é—®é¢˜è¯Šæ–­ ==="
echo "æ—¶é—´: $(date)"
echo

echo "1. Cloud-InitçŠ¶æ€:"
cloud-init status --long
echo

echo "2. æœ€æ–°é”™è¯¯ä¿¡æ¯:"
grep -E "(ERROR|FAIL)" /var/log/cloud-init.log | tail -5
echo

echo "3. é…ç½®æ–‡ä»¶æ£€æŸ¥:"
if [ -f "/var/lib/cloud/instance/user-data.txt" ]; then
    echo "ç”¨æˆ·æ•°æ®æ–‡ä»¶å­˜åœ¨"
    head -5 /var/lib/cloud/instance/user-data.txt
else
    echo "æœªæ‰¾åˆ°ç”¨æˆ·æ•°æ®æ–‡ä»¶"
fi
echo

echo "4. ç½‘ç»œçŠ¶æ€:"
ip addr show | grep "inet " | grep -v "127.0.0.1"
echo

echo "5. ç£ç›˜ç©ºé—´:"
df -h | grep -E "(Filesystem|/dev/)"
echo

echo "6. ç³»ç»Ÿè´Ÿè½½:"
uptime
echo

echo "=== è¯Šæ–­å®Œæˆ ==="
EOF

chmod +x diagnose-cloud-init.sh
sudo ./diagnose-cloud-init.sh
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ YAMLè¯­æ³•ï¼šç¼©è¿›æ•æ„Ÿã€æ•°æ®ç±»å‹ä¸°å¯Œã€æ³¨é‡Šå‹å¥½çš„é…ç½®æ ¼å¼
ğŸ”¸ é­”æ³•å­—ç¬¦ä¸²ï¼š#cloud-configæ ‡è¯†ç¬¦ï¼Œå‘Šè¯‰ç³»ç»Ÿè¿™æ˜¯äº‘é…ç½®æ–‡ä»¶
ğŸ”¸ æ¨¡å—åŒ–è®¾è®¡ï¼šæŒ‰åŠŸèƒ½åˆ†ç±»çš„é…ç½®æ¨¡å—ï¼Œå„å¸å…¶èŒ
ğŸ”¸ æ¡ä»¶æ‰§è¡Œï¼šæ ¹æ®ç¯å¢ƒæˆ–æ¡ä»¶åŠ¨æ€è°ƒæ•´é…ç½®å†…å®¹
ğŸ”¸ å¤šæ–‡æ¡£åˆå¹¶ï¼šå¤šä¸ªé…ç½®æºçš„åˆå¹¶ç­–ç•¥å’Œä¼˜å…ˆçº§è§„åˆ™
ğŸ”¸ é…ç½®éªŒè¯ï¼šè¯­æ³•æ£€æŸ¥ã€é€»è¾‘éªŒè¯ã€æµ‹è¯•ç¯å¢ƒéªŒè¯
ğŸ”¸ å˜é‡æ›¿æ¢ï¼šæ¨¡æ¿åŒ–é…ç½®ï¼Œæ”¯æŒåŠ¨æ€å†…å®¹å’Œå‚æ•°åŒ–
ğŸ”¸ è°ƒè¯•æŠ€å·§ï¼šæ—¥å¿—åˆ†æã€é—®é¢˜æ’æŸ¥ã€ç³»ç»ŸåŒ–è°ƒè¯•æ–¹æ³•
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ YAMLè¯­æ³•çš„æ ¸å¿ƒç‰¹ç‚¹**
```
äººæ€§åŒ–è®¾è®¡ï¼š
- æ¯”JSONæ›´æ˜“è¯»å†™
- æ”¯æŒæ³¨é‡Šå’Œå¤šè¡Œæ–‡æœ¬
- å±‚æ¬¡ç»“æ„æ¸…æ™°ç›´è§‚

è¯­æ³•ä¸¥æ ¼æ€§ï¼š
- ç¼©è¿›å¿…é¡»ä½¿ç”¨ç©ºæ ¼
- é”®å€¼å¯¹æ ¼å¼å›ºå®š
- æ•°æ®ç±»å‹è‡ªåŠ¨è¯†åˆ«

å®é™…åº”ç”¨ï¼š
- é€‚åˆé…ç½®æ–‡ä»¶ç¼–å†™
- ä¾¿äºç‰ˆæœ¬æ§åˆ¶ç®¡ç†
- æ”¯æŒå¤æ‚æ•°æ®ç»“æ„
```

**ğŸ”¹ cloud-configçš„æ¨¡å—åŒ–ä¼˜åŠ¿**
```
åŠŸèƒ½åˆ†ç¦»ï¼š
- ç³»ç»Ÿé…ç½®ä¸åº”ç”¨é…ç½®åˆ†ç¦»
- åŸºç¡€è®¾ç½®ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
- ä¸åŒç”Ÿå‘½å‘¨æœŸçš„é…ç½®åˆ†ç¦»

å¤ç”¨æ€§å¼ºï¼š
- æ¨¡å—å¯ç‹¬ç«‹é…ç½®
- æ”¯æŒé…ç½®æ¨¡æ¿åŒ–
- ä¾¿äºæ ‡å‡†åŒ–ç®¡ç†

ç»´æŠ¤ä¾¿åˆ©ï¼š
- é—®é¢˜å®šä½ç²¾ç¡®
- é…ç½®ä¿®æ”¹å½±å“èŒƒå›´å°
- æ”¯æŒå¢é‡æ›´æ–°
```

**ğŸ”¹ é…ç½®è°ƒè¯•çš„ç³»ç»Ÿæ–¹æ³•**
```
é¢„é˜²æ€§è°ƒè¯•ï¼š
- é…ç½®è¯­æ³•é¢„æ£€æŸ¥
- é€»è¾‘åˆç†æ€§éªŒè¯
- æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯

é—®é¢˜è¯Šæ–­ï¼š
- æ—¥å¿—åˆ†æå®šä½é—®é¢˜
- åˆ†é˜¶æ®µéªŒè¯æ‰§è¡Œç»“æœ
- ç³»ç»ŸçŠ¶æ€æ£€æŸ¥

è§£å†³ç­–ç•¥ï¼š
- æœ€å°åŒ–é…ç½®æµ‹è¯•
- æ¸è¿›å¼é…ç½®åº”ç”¨
- å®Œæ•´çš„å›æ»šæ–¹æ¡ˆ
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒåº”ç”¨åœºæ™¯**
- **è‡ªåŠ¨åŒ–éƒ¨ç½²**ï¼šäº‘ä¸»æœºè‡ªåŠ¨åˆå§‹åŒ–å’Œåº”ç”¨éƒ¨ç½²
- **æ ‡å‡†åŒ–é…ç½®**ï¼šä¼ä¸šçº§æœåŠ¡å™¨é…ç½®æ ‡å‡†åŒ–
- **å¤šç¯å¢ƒç®¡ç†**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒçš„å·®å¼‚åŒ–é…ç½®
- **æ‰¹é‡è¿ç»´**ï¼šå¤§è§„æ¨¡äº‘ä¸»æœºçš„ç»Ÿä¸€é…ç½®ç®¡ç†

**ğŸ”§ è¿ç»´æœ€ä½³å®è·µ**
- **é…ç½®å³ä»£ç **ï¼šå°†åŸºç¡€è®¾æ–½é…ç½®çº³å…¥ç‰ˆæœ¬æ§åˆ¶
- **æ¨¡æ¿åŒ–ç®¡ç†**ï¼šå»ºç«‹å¯å¤ç”¨çš„é…ç½®æ¨¡æ¿åº“
- **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼šé…ç½®å˜æ›´çš„è‡ªåŠ¨åŒ–éªŒè¯æµç¨‹
- **ç›‘æ§å‘Šè­¦**ï¼šäº‘ä¸»æœºåˆå§‹åŒ–çŠ¶æ€çš„å®æ—¶ç›‘æ§

**ğŸ“ˆ æŠ€æœ¯å‘å±•è¶‹åŠ¿**
- **äº‘åŸç”Ÿæ”¯æŒ**ï¼šæ›´å¥½çš„å®¹å™¨å’ŒKubernetesé›†æˆ
- **AIè¾…åŠ©é…ç½®**ï¼šæ™ºèƒ½åŒ–çš„é…ç½®ç”Ÿæˆå’Œä¼˜åŒ–å»ºè®®
- **å®‰å…¨å¢å¼º**ï¼šæ›´ä¸¥æ ¼çš„é…ç½®å®‰å…¨éªŒè¯å’Œå®¡è®¡
- **è·¨äº‘å…¼å®¹**ï¼šç»Ÿä¸€çš„å¤šäº‘å¹³å°é…ç½®æ ‡å‡†

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- YAMLè¯­æ³•è¦è§„èŒƒï¼Œç¼©è¿›ç©ºæ ¼ä¸èƒ½ä¹±
- é­”æ³•å­—ç¬¦æ˜¯å…³é”®ï¼Œæ¨¡å—åˆ†ç±»èŒè´£æ˜
- æ¡ä»¶æ‰§è¡Œçµæ´»ç”¨ï¼Œå¤šæ–‡æ¡£åˆå¹¶æœ‰ç­–ç•¥
- éªŒè¯è°ƒè¯•ä¸å¯å°‘ï¼Œå˜é‡æ›¿æ¢ææ•ˆç‡