---
title: 6、Docker Swarm服务部署
---
## 📚 目录

1. [Docker Swarm服务部署概述](#1-docker-swarm服务部署概述)
2. [服务创建与基础配置](#2-服务创建与基础配置)
3. [服务副本与扩缩容管理](#3-服务副本与扩缩容管理)
4. [服务更新与回滚操作](#4-服务更新与回滚操作)
5. [负载均衡与流量分发](#5-负载均衡与流量分发)
6. [服务约束与节点调度](#6-服务约束与节点调度)
7. [端口发布与网络配置](#7-端口发布与网络配置)
8. [配置与密钥管理](#8-配置与密钥管理)
9. [服务日志收集查看](#9-服务日志收集查看)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🐳 Docker Swarm服务部署概述


### 1.1 什么是Docker Swarm服务


> **💡 核心理解**
> Docker Swarm中的"服务"就像是一个智能管家，它不仅帮你运行应用程序，还会自动管理多个副本、处理故障恢复、分发流量等工作。

**服务 vs 容器的区别**：
```
传统容器运行：
你手动启动 → 容器运行 → 容器崩溃 → 你手动重启

Swarm服务运行：
你定义服务 → Swarm自动管理 → 容器崩溃 → Swarm自动重启
```

**服务的核心优势**：
- 🔄 **自动恢复**：容器崩溃自动重启
- ⚖️ **负载均衡**：流量自动分发到不同副本
- 📈 **弹性扩缩容**：根据需求调整副本数量
- 🔄 **滚动更新**：不停机更新应用版本

### 1.2 服务部署的整体流程


```
服务部署完整流程：
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  定义服务   │ →  │  创建服务   │ →  │  监控服务   │
│ (规格配置)  │    │ (部署执行)  │    │ (运维管理)  │
└─────────────┘    └─────────────┘    └─────────────┘
       ↓                  ↓                  ↓
   服务定义          Swarm调度         健康检查
   资源需求          容器分发          日志收集
   网络配置          负载均衡          故障处理
```

---

## 2. 🚀 服务创建与基础配置


### 2.1 docker service create基础语法


**基本命令结构**：
```bash
docker service create [选项] 镜像名 [命令]
```

> **📌 新手必知**
> `docker service create`是整个服务管理的入口命令，就像盖房子时的地基，所有后续操作都基于这个命令创建的服务。

**最简单的服务创建**：
```bash
# 创建一个nginx服务，名称为web-server
docker service create --name web-server nginx

# 查看服务状态
docker service ls
```

### 2.2 核心参数详解


**服务命名与镜像**：
```bash
# 指定服务名称（强烈推荐）
docker service create --name my-web-app nginx:1.21

# 不指定名称，系统自动生成随机名称
docker service create nginx
```

> **⚠️ 实践建议**
> 总是为服务指定有意义的名称，这样便于后续管理和识别，特别是在生产环境中。

**环境变量配置**：
```bash
# 单个环境变量
docker service create \
  --name mysql-db \
  --env MYSQL_ROOT_PASSWORD=secretpass \
  mysql:8.0

# 多个环境变量
docker service create \
  --name web-app \
  --env NODE_ENV=production \
  --env PORT=3000 \
  --env DB_HOST=mysql-db \
  node:16-alpine
```

### 2.3 实际部署示例


**部署Web应用服务**：
```bash
# 创建一个完整的web服务
docker service create \
  --name frontend-app \
  --replicas 3 \
  --publish 8080:80 \
  --env BACKEND_URL=http://api-server:3000 \
  nginx:alpine

# 验证服务创建结果
docker service inspect frontend-app --pretty
```

---

## 3. 📊 服务副本与扩缩容管理


### 3.1 副本数量的概念理解


> **💡 生活化理解**
> 副本就像餐厅里的服务员，客人少时1个服务员够用，客人多时需要3-5个服务员同时工作，这样才能保证服务质量。

**副本的作用**：
- 🏃 **提高性能**：多个副本并行处理请求
- 🛡️ **增强可靠性**：一个副本故障不影响整体服务  
- ⚖️ **负载分散**：请求自动分配到不同副本

### 3.2 副本数量配置


**创建时指定副本数量**：
```bash
# 创建3个副本的服务
docker service create \
  --name web-cluster \
  --replicas 3 \
  --publish 80:80 \
  nginx

# 创建单副本服务（默认）
docker service create --name single-app redis
```

**运行时调整副本数量**：
```bash
# 扩容到5个副本
docker service scale web-cluster=5

# 缩容到2个副本  
docker service scale web-cluster=2

# 同时调整多个服务
docker service scale web-cluster=3 api-server=4
```

### 3.3 扩缩容最佳实践


**扩容策略**：
```bash
# 渐进式扩容（推荐）
docker service scale web-app=2    # 先扩到2个
# 观察性能和资源使用
docker service scale web-app=4    # 再扩到4个
```

> **🔍 深入思考**
> 扩容不是越多越好，要考虑：
> - 节点资源是否充足
> - 数据库连接数限制
> - 网络带宽是否足够

**缩容注意事项**：
```bash
# 缓慢缩容，避免服务中断
docker service scale web-app=3    # 从5个缩到3个
# 监控服务响应时间
docker service scale web-app=1    # 最后缩到1个
```

---

## 4. 🔄 服务更新与回滚操作


### 4.1 服务更新的基本概念


> **💡 核心理解** 
> 服务更新就像装修房子，你不能一下子把整个房子拆掉重建，而是一个房间一个房间地装修，这样家人还能继续住。

**更新类型**：
- 🖼️ **镜像更新**：升级应用版本
- ⚙️ **配置更新**：修改环境变量、资源限制
- 🌐 **网络更新**：调整端口映射、网络配置

### 4.2 滚动更新配置


**基本更新命令**：
```bash
# 更新服务镜像版本
docker service update --image nginx:1.22 web-server

# 更新环境变量
docker service update --env-add NEW_FEATURE=enabled web-app

# 更新资源限制
docker service update --limit-memory 512m web-app
```

**滚动更新策略配置**：
```bash
# 创建服务时配置更新策略
docker service create \
  --name web-app \
  --replicas 4 \
  --update-delay 30s \
  --update-parallelism 1 \
  --update-failure-action rollback \
  nginx:1.20
```

**更新参数详解**：
- `--update-delay`：每批次更新之间的等待时间
- `--update-parallelism`：同时更新的副本数量
- `--update-failure-action`：更新失败时的处理方式

### 4.3 回滚操作


**快速回滚到上一个版本**：
```bash
# 回滚到上一个版本
docker service rollback web-app

# 查看回滚进度
docker service ps web-app
```

**手动回滚到指定版本**：
```bash
# 先查看历史版本
docker service inspect web-app --pretty

# 回滚到特定镜像版本
docker service update --image nginx:1.20 web-app
```

---

## 5. ⚖️ 负载均衡与流量分发


### 5.1 Swarm内置负载均衡原理


> **💡 通俗解释**
> Swarm的负载均衡就像智能交通信号灯，它会自动判断哪条路最畅通，然后把车辆（请求）引导到最合适的路线（副本）上。

**负载均衡架构**：
```
外部请求 → Swarm入口网络 → 内部负载均衡器 → 选择副本 → 处理请求
    ↓             ↓              ↓           ↓         ↓
  用户访问      路由网格       算法分发     健康副本   返回响应
```

### 5.2 负载均衡算法


**内置负载均衡特点**：
- 🎯 **轮询分发**：请求依次分发到各个副本
- 🏥 **健康检查**：只向健康的副本发送请求
- 🔄 **自动恢复**：故障副本恢复后自动加入负载均衡
- 🌐 **会话保持**：支持基于IP的会话绑定

### 5.3 流量分发验证


**测试负载均衡效果**：
```bash
# 创建带标识的测试服务
docker service create \
  --name lb-test \
  --replicas 3 \
  --publish 8080:80 \
  nginx

# 多次访问测试分发效果
for i in {1..10}; do
  curl http://swarm-node:8080
  sleep 1
done
```

---

## 6. 🎯 服务约束与节点调度


### 6.1 调度约束的作用


> **💡 生活化理解**
> 调度约束就像餐厅的座位安排，有的客人要坐靠窗位置（特定节点），有的要坐包间（标签节点），有的要分开坐（分散部署）。

**约束类型**：
- 🏷️ **节点标签约束**：根据节点特性调度
- 🌍 **地域约束**：按地理位置分布
- 🔧 **资源约束**：根据节点资源情况调度

### 6.2 节点标签管理


**为节点添加标签**：
```bash
# 给节点添加角色标签
docker node update --label-add role=database node1
docker node update --label-add role=frontend node2
docker node update --label-add role=backend node3

# 添加地域标签
docker node update --label-add zone=east node1
docker node update --label-add zone=west node2
```

**查看节点标签**：
```bash
# 查看所有节点信息
docker node ls

# 查看特定节点详细信息
docker node inspect node1 --pretty
```

### 6.3 基于约束的服务调度


**按节点标签调度**：
```bash
# 数据库服务只在database角色节点运行
docker service create \
  --name mysql-db \
  --constraint 'node.labels.role==database' \
  mysql:8.0

# 前端服务只在frontend节点运行
docker service create \
  --name web-frontend \
  --constraint 'node.labels.role==frontend' \
  --replicas 2 \
  nginx
```

**组合约束条件**：
```bash
# 多个约束条件
docker service create \
  --name api-service \
  --constraint 'node.labels.zone==east' \
  --constraint 'node.labels.role!=database' \
  --replicas 3 \
  node:16-alpine
```

---

## 7. 🌐 端口发布与网络配置


### 7.1 端口发布原理


> **💡 核心理解**
> 端口发布就像为大楼设置前台，外面的访客通过前台（发布端口）才能找到楼内的具体房间（容器端口）。

**端口发布模式**：
```
模式对比：
┌──────────────┬────────────────┬──────────────────┐
│   发布模式   │     访问方式   │      使用场景    │
├──────────────┼────────────────┼──────────────────┤
│  ingress     │  任意节点IP    │   生产环境推荐   │
│   host       │  特定节点IP    │   调试和测试     │
└──────────────┴────────────────┴──────────────────┘
```

### 7.2 端口发布配置


**基本端口发布**：
```bash
# 发布端口（默认ingress模式）
docker service create \
  --name web-service \
  --publish 8080:80 \
  nginx

# 明确指定ingress模式
docker service create \
  --name web-service \
  --publish published=8080,target=80,mode=ingress \
  nginx
```

**host模式端口发布**：
```bash
# host模式（仅在运行容器的节点可访问）
docker service create \
  --name debug-service \
  --publish published=8080,target=80,mode=host \
  nginx
```

### 7.3 入口网络详解


**入口网络的优势**：
- 🌍 **集群级访问**：通过任意节点IP都能访问服务
- ⚖️ **自动负载均衡**：请求自动分发到不同副本
- 🔄 **故障转移**：节点故障时自动路由到其他节点

**网络流量路径**：
```
客户端请求 → 任意Swarm节点 → 入口网络路由 → 目标副本 → 响应返回
     ↓            ↓             ↓          ↓        ↓
   外部访问      集群入口       智能路由   实际处理   结果返回
```

---

## 8. 🔐 配置与密钥管理


### 8.1 配置管理概念


> **💡 生活化理解**  
> 配置管理就像管家统一管理家里的各种设置（温度、灯光、音响），每个房间需要时就从管家那里获取，不用每个房间都单独存储。

**配置管理的优势**：
- 🔄 **集中管理**：配置统一存储和版本控制
- 🔒 **安全性**：配置加密存储在Swarm集群中
- 🚀 **便于更新**：修改配置无需重建镜像

### 8.2 创建和使用配置


**创建配置对象**：
```bash
# 从文件创建配置
echo "server_name=prod-server" > app.conf
docker config create app-config app.conf

# 从命令行创建配置
echo "database_url=mysql://db:3306/app" | \
docker config create db-config -
```

**在服务中使用配置**：
```bash
# 将配置挂载到容器
docker service create \
  --name web-app \
  --config source=app-config,target=/app/config/app.conf \
  --config source=db-config,target=/app/config/db.conf \
  nginx
```

### 8.3 密钥管理


**创建密钥对象**：
```bash
# 创建数据库密码密钥
echo "super_secret_password" | \
docker secret create db-password -

# 从文件创建SSL证书密钥
docker secret create ssl-cert ./cert.pem
docker secret create ssl-key ./key.pem
```

**在服务中使用密钥**：
```bash
# 密钥自动挂载到/run/secrets/
docker service create \
  --name secure-app \
  --secret db-password \
  --secret ssl-cert \
  --secret ssl-key \
  nginx
```

**配置与密钥的区别**：

| 特性 | 配置(Config) | 密钥(Secret) |
|------|-------------|-------------|
| **用途** | 非敏感配置信息 | 敏感信息（密码、证书） |
| **挂载位置** | 可自定义路径 | 固定在`/run/secrets/` |
| **权限** | 可读可写 | 只读 |
| **加密** | 不加密 | 加密存储 |

---

## 9. 📋 服务日志收集查看


### 9.1 日志查看基础


> **💡 核心理解**
> 服务日志就像医生的诊断记录，它记录了应用运行过程中的所有重要信息，帮助我们了解服务状态和排查问题。

**基本日志查看命令**：
```bash
# 查看服务日志
docker service logs web-service

# 实时查看日志（类似tail -f）
docker service logs -f web-service

# 查看最近100条日志
docker service logs --tail 100 web-service
```

### 9.2 日志查看选项


**时间范围过滤**：
```bash
# 查看最近1小时的日志
docker service logs --since 1h web-service

# 查看指定时间后的日志
docker service logs --since 2023-01-01T10:00:00 web-service

# 查看指定时间范围内的日志
docker service logs \
  --since 2023-01-01T10:00:00 \
  --until 2023-01-01T12:00:00 \
  web-service
```

**日志格式控制**：
```bash
# 显示时间戳
docker service logs --timestamps web-service

# 不显示日志前缀
docker service logs --no-trunc web-service

# 原始格式输出
docker service logs --raw web-service
```

### 9.3 多副本日志聚合


**查看所有副本日志**：
```bash
# 默认显示所有副本的日志
docker service logs web-cluster

# 日志会标识来源副本
web-cluster.1.abc123    | 2023-01-01 10:00:01 GET /api/users
web-cluster.2.def456    | 2023-01-01 10:00:02 POST /api/login  
web-cluster.3.ghi789    | 2023-01-01 10:00:03 GET /api/status
```

> **📌 实践提示**
> 在生产环境中，建议使用专门的日志收集系统（如ELK Stack、Fluentd等）来管理大规模的服务日志。

### 9.4 日志故障排查


**常见日志分析场景**：

**查找错误日志**：
```bash
# 查看包含ERROR的日志
docker service logs web-service 2>&1 | grep ERROR

# 查看最近的错误日志
docker service logs --since 1h web-service | grep -i error
```

**分析服务启动问题**：
```bash
# 查看服务启动日志
docker service logs --since 10m web-service

# 检查特定副本的日志
docker logs <容器ID>
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 服务本质：Swarm中的服务是容器集群的抽象管理单元
🔸 核心命令：docker service create是所有服务部署的起点
🔸 副本管理：通过副本数量实现高可用和负载分担
🔸 滚动更新：不停机升级是生产环境的必备能力
🔸 调度约束：合理的约束配置确保服务部署在合适节点
🔸 网络发布：ingress网络提供集群级别的负载均衡
🔸 配置管理：配置和密钥的统一管理提高安全性
🔸 日志查看：日志是排查问题和监控服务的重要手段
```

### 10.2 关键理解要点


**🔹 服务 vs 传统容器的本质区别**
```
传统容器部署：
- 手动管理每个容器
- 容器故障需人工处理  
- 负载均衡需额外配置
- 更新需要停机维护

Swarm服务部署：
- 声明式定义，自动管理
- 自动故障恢复和重启
- 内置负载均衡和服务发现
- 滚动更新，零停机时间
```

**🔹 副本数量的选择策略**
```
业务特点决定副本数量：
- CPU密集型：副本数 = CPU核心数
- I/O密集型：副本数可以超过CPU核心数
- 高可用要求：至少3个副本，奇数个更好
- 资源限制：根据内存和存储容量决定上限
```

**🔹 更新和回滚的最佳实践**
```
安全更新策略：
1. 小批量更新（parallelism=1或2）
2. 增加延迟时间（delay=30s-60s）
3. 配置失败自动回滚
4. 更新前进行充分测试
5. 准备快速回滚方案
```

### 10.3 实际应用指导


**🎯 生产环境部署清单**
- [ ] **资源规划**：确定节点数量和资源配置
- [ ] **网络设计**：规划端口分配和网络隔离
- [ ] **存储方案**：配置持久化存储卷
- [ ] **监控告警**：设置服务监控和日志收集
- [ ] **备份策略**：配置数据备份和恢复方案
- [ ] **安全加固**：使用密钥管理敏感信息

**🚀 常见部署场景**

**Web应用集群**：
```bash
# 高可用Web服务部署
docker service create \
  --name web-cluster \
  --replicas 3 \
  --publish 80:80 \
  --update-delay 30s \
  --update-parallelism 1 \
  --constraint 'node.labels.role==web' \
  nginx:alpine
```

**数据库服务**：
```bash  
# 单副本数据库（有状态服务）
docker service create \
  --name database \
  --replicas 1 \
  --constraint 'node.labels.role==database' \
  --mount type=volume,source=db-data,target=/var/lib/mysql \
  --secret db-root-password \
  mysql:8.0
```

**微服务架构**：
```bash
# API网关
docker service create --name api-gateway --replicas 2 --publish 443:443 nginx

# 用户服务  
docker service create --name user-service --replicas 3 user-app:v1.0

# 订单服务
docker service create --name order-service --replicas 3 order-app:v1.0
```

### 10.4 故障排查指南


**服务无法启动**：
1. 检查镜像是否存在：`docker images`
2. 查看服务事件：`docker service ps service-name`
3. 检查节点资源：`docker node ls`
4. 查看详细错误：`docker service logs service-name`

**服务更新失败**：
1. 查看更新历史：`docker service inspect service-name`
2. 检查更新进度：`docker service ps service-name`
3. 手动回滚：`docker service rollback service-name`
4. 分析失败原因：`docker service logs service-name`

**网络访问问题**：
1. 确认端口发布：`docker service inspect service-name`
2. 测试集群内访问：`docker exec -it container curl service-name`
3. 检查防火墙设置
4. 验证负载均衡：多次访问观察响应

> **🔑 核心记忆口诀**
> ```
> 服务创建先定义，副本数量要合理
> 滚动更新保稳定，约束调度选节点  
> 端口发布用ingress，配置密钥要分离
> 日志监控常查看，故障排查有章法
> ```

**最终理解**：Docker Swarm服务部署的核心是**声明式管理** + **自动化运维**，通过合理的配置和约束，让集群自动处理大部分运维工作，从而实现高可用、可扩展的容器化应用部署。