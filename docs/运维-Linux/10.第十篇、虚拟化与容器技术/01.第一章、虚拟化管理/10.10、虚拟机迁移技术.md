---
title: 10、虚拟机迁移技术
---
## 📚 目录

1. [虚拟机迁移概述](#1-虚拟机迁移概述)
2. [冷迁移与热迁移详解](#2-冷迁移与热迁移详解)
3. [virsh migrate命令使用](#3-virsh-migrate命令使用)
4. [实时迁移前置条件](#4-实时迁移前置条件)
5. [迁移过程监控与故障处理](#5-迁移过程监控与故障处理)
6. [存储迁移与在线块迁移](#6-存储迁移与在线块迁移)
7. [迁移性能优化配置](#7-迁移性能优化配置)
8. [跨主机迁移网络配置](#8-跨主机迁移网络配置)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔄 虚拟机迁移概述


### 1.1 什么是虚拟机迁移


**虚拟机迁移**就是把一台正在运行的虚拟机从一台物理服务器转移到另一台物理服务器上。就像搬家一样，把虚拟机的"家"从一个地方搬到另一个地方。

**迁移的本质含义**：
- **数据转移**：虚拟机的内存、磁盘、配置信息都要搬过去
- **状态保持**：迁移后虚拟机要能正常继续工作
- **服务连续性**：尽量不影响虚拟机里运行的应用

### 1.2 为什么需要虚拟机迁移


```
实际应用场景：

🔧 硬件维护：
服务器A需要维修 → 把虚拟机迁移到服务器B → 维修完成后再迁回

⚡ 负载均衡：
服务器A负载过高 → 把部分虚拟机迁移到服务器B → 平衡资源使用

🛡️ 故障恢复：
服务器A出现故障 → 自动把虚拟机迁移到健康服务器 → 保证业务连续性

💰 资源优化：
根据业务需求 → 动态调整虚拟机分布 → 提高硬件利用率
```

### 1.3 迁移技术的发展历程


```
传统物理机时代：
应用故障 → 停机 → 修复 → 重启 → 恢复服务
停机时间：几小时到几天

虚拟化时代：
应用故障 → 迁移虚拟机 → 在新主机继续运行
停机时间：几秒到几分钟

现代云计算时代：
应用故障 → 实时热迁移 → 用户无感知
停机时间：接近零
```

---

## 2. ❄️🔥 冷迁移与热迁移详解


### 2.1 冷迁移（Cold Migration）


**冷迁移**就是先把虚拟机关机，然后把它的文件复制到新的服务器上，再在新服务器上启动。

**冷迁移工作原理**：
```
原理流程：
虚拟机运行中 → 关闭虚拟机 → 复制磁盘文件 → 复制配置文件 → 在目标主机启动

类比理解：
就像搬家时先把所有东西打包，运到新房子后再开箱整理
```

**冷迁移的特点**：

| 特点 | 说明 | 影响 |
|------|------|------|
| **有停机时间** | 虚拟机需要完全关机 | 业务会中断 |
| **数据一致性好** | 关机状态下数据不变 | 迁移结果可靠 |
| **操作简单** | 就是文件复制过程 | 技术门槛低 |
| **网络要求低** | 不需要实时同步 | 普通网络即可 |

### 2.2 热迁移（Live Migration）


**热迁移**是在虚拟机继续运行的情况下，把它从一台服务器迁移到另一台服务器，用户几乎感觉不到中断。

**热迁移工作原理**：
```
核心思想：边运行边复制

步骤1：预复制阶段
┌─────────────┐    复制内存页    ┌─────────────┐
│   源主机    │ ─────────────→ │   目标主机   │
│  虚拟机运行  │                │   准备接收   │
└─────────────┘                └─────────────┘

步骤2：停机复制阶段（很短，几秒）
┌─────────────┐   停机复制剩余   ┌─────────────┐
│   源主机    │ ─────────────→ │   目标主机   │
│  虚拟机暂停  │    内存和状态    │   启动虚拟机  │
└─────────────┘                └─────────────┘
```

**热迁移的特点**：

| 特点 | 说明 | 优势 |
|------|------|------|
| **停机时间极短** | 通常几秒钟 | 业务基本不受影响 |
| **用户无感知** | 应用继续运行 | 用户体验好 |
| **技术复杂** | 需要复杂同步机制 | 对环境要求高 |
| **网络要求高** | 需要高带宽低延迟 | 硬件成本高 |

### 2.3 冷迁移vs热迁移选择


**适用场景对比**：

```
🔥 选择热迁移的场景：
✅ 关键业务系统，不允许长时间停机
✅ 24x7在线服务
✅ 有大量用户连接的应用
✅ 负载均衡和故障恢复

❄️ 选择冷迁移的场景：
✅ 可以接受停机的维护窗口
✅ 开发测试环境
✅ 网络条件不支持热迁移
✅ 需要更改虚拟机硬件配置
```

---

## 3. 🛠️ virsh migrate命令使用


### 3.1 virsh migrate基本语法


`virsh migrate` 是管理虚拟机迁移的核心命令，就像是虚拟机迁移的"指挥官"。

**基本语法结构**：
```bash
virsh migrate [选项] <虚拟机名称> <目标URI>
```

### 3.2 常用迁移命令示例


**🔥 热迁移命令**：
```bash
# 基本热迁移
virsh migrate --live vm1 qemu+ssh://target-host/system

# 详细参数说明：
# --live        : 热迁移模式
# vm1          : 虚拟机名称  
# qemu+ssh://  : 连接协议
# target-host  : 目标主机
# /system      : libvirt系统连接
```

**❄️ 冷迁移命令**：
```bash
# 冷迁移（不使用--live参数）
virsh migrate vm1 qemu+ssh://target-host/system
```

**📂 带存储迁移的命令**：
```bash
# 同时迁移存储和虚拟机
virsh migrate --live --copy-storage-all vm1 qemu+ssh://target-host/system
```

### 3.3 重要命令参数详解


| 参数 | 含义 | 使用场景 |
|------|------|----------|
| `--live` | 热迁移模式 | 业务不能停机时使用 |
| `--persistent` | 迁移配置信息 | 让迁移后的虚拟机配置永久保存 |
| `--undefinesource` | 删除源端定义 | 迁移完成后清理源端 |
| `--copy-storage-all` | 复制所有存储 | 没有共享存储时使用 |
| `--verbose` | 显示详细信息 | 监控迁移进度 |

### 3.4 实际操作示例


**完整的热迁移操作**：
```bash
# 第1步：检查虚拟机状态
virsh list --all
# 确认虚拟机正在运行

# 第2步：执行热迁移
virsh migrate --live --persistent --verbose \
  vm1 qemu+ssh://192.168.1.100/system

# 第3步：验证迁移结果
# 在目标主机上检查
virsh list --all
```

> **💡 小技巧**：使用 `--verbose` 参数可以看到迁移的详细过程，帮助你了解迁移进度。

---

## 4. 🎯 实时迁移前置条件


### 4.1 共享存储要求


**为什么需要共享存储**：
想象虚拟机的磁盘文件就像一本书，如果这本书只放在服务器A上，当虚拟机迁移到服务器B时，服务器B就找不到这本"书"了。

**共享存储的作用**：
```
没有共享存储的情况：
服务器A: 虚拟机 + 磁盘文件
服务器B: 只有虚拟机（找不到磁盘文件）
结果: 迁移失败

有共享存储的情况：
服务器A: 虚拟机 ─┐
                ├─→ 共享存储（磁盘文件）
服务器B: 虚拟机 ─┘
结果: 迁移成功
```

**常见共享存储方案**：

| 存储类型 | 特点 | 适用场景 |
|----------|------|----------|
| **NFS** | 网络文件系统，配置简单 | 小规模环境，测试环境 |
| **iSCSI** | 块级别存储，性能较好 | 中等规模生产环境 |
| **GlusterFS** | 分布式存储，扩展性好 | 大规模分布式环境 |
| **Ceph** | 高可用分布式存储 | 企业级云环境 |

### 4.2 网络配置要求


**网络连通性检查**：
```bash
# 检查主机间网络连通性
ping target-host

# 检查SSH连接
ssh root@target-host

# 检查libvirt服务
virsh -c qemu+ssh://target-host/system list
```

**网络配置核心要点**：
- **🔗 管理网络**：用于libvirt通信和控制命令
- **📡 数据网络**：用于传输虚拟机内存和状态数据  
- **🌐 业务网络**：虚拟机的网络配置要在两台主机上保持一致

### 4.3 CPU兼容性要求


**CPU兼容性的重要性**：
虚拟机在不同CPU上运行，就像一个程序在不同的电脑上运行，需要确保指令集兼容。

**检查CPU兼容性**：
```bash
# 查看CPU型号和特性
cat /proc/cpuinfo | grep "model name"

# 使用libvirt检查兼容性
virsh capabilities | grep -A 5 "<cpu>"
```

**解决CPU不兼容的方法**：
```xml
<!-- 在虚拟机配置中使用通用CPU模式 -->
<cpu mode='host-passthrough'/>
<!-- 或者使用特定的CPU型号 -->
<cpu mode='custom' match='exact'>
  <model fallback='allow'>Westmere</model>
</cpu>
```

### 4.4 前置条件检查清单


**📋 迁移前必检项目**：

```
✅ 网络连通性
□ ping 目标主机成功
□ SSH无密码登录配置完成
□ libvirt服务正常运行

✅ 存储配置
□ 共享存储挂载成功
□ 目标主机能访问虚拟机磁盘文件
□ 存储路径在两台主机上一致

✅ 系统配置  
□ libvirt版本兼容
□ QEMU版本兼容
□ CPU型号兼容或已配置CPU模式

✅ 权限配置
□ root用户或相应权限配置
□ libvirt用户组配置正确
```

---

## 5. 👀 迁移过程监控与故障处理


### 5.1 迁移进度监控


**实时监控迁移过程**：
```bash
# 监控迁移进度
virsh domjobinfo vm1

# 输出示例：
Job type:         None
Operation:        Live migration
Time elapsed:     30 sec
Data processed:   1024 MB
Data remaining:   256 MB
Memory processed: 2048 MB
```

**监控信息含义解释**：
- **Job type**：当前任务类型（迁移、快照等）
- **Time elapsed**：已花费时间
- **Data processed**：已传输数据量
- **Data remaining**：剩余数据量

### 5.2 迁移状态查看


**查看迁移状态的多种方法**：
```bash
# 方法1：查看虚拟机列表状态
virsh list --all
# 迁移中的虚拟机会显示特殊状态

# 方法2：查看详细迁移信息  
virsh domjobinfo vm1

# 方法3：查看系统日志
tail -f /var/log/libvirt/libvirtd.log
```

### 5.3 常见故障及处理


**🚫 网络连接失败**：
```
错误信息：Unable to connect to server
原因分析：目标主机网络不通或SSH配置问题
解决方法：
1. 检查网络连通性：ping target-host
2. 检查SSH配置：ssh root@target-host  
3. 检查防火墙设置
```

**💾 存储访问失败**：
```
错误信息：Cannot access storage file
原因分析：共享存储配置问题
解决方法：
1. 检查存储挂载：df -h
2. 检查文件权限：ls -l /path/to/vm/disk
3. 检查存储路径一致性
```

**🔄 迁移中断处理**：
```bash
# 取消正在进行的迁移
virsh migrate-setspeed vm1 0  # 暂停迁移
virsh domjobabort vm1         # 取消迁移

# 清理残留状态
virsh managedsave-remove vm1  # 清理保存状态
```

### 5.4 故障排查流程图


```
迁移失败
    ↓
检查错误日志
    ↓
网络问题? ─── 是 → 检查网络连通性、SSH配置
    ↓ 否
存储问题? ─── 是 → 检查共享存储、权限配置  
    ↓ 否
CPU兼容性? ── 是 → 调整CPU模式配置
    ↓ 否
查看详细错误日志，联系技术支持
```

---

## 6. 💿 存储迁移与在线块迁移


### 6.1 存储迁移的概念


**什么是存储迁移**：
除了把虚拟机从一台服务器迁移到另一台服务器，还要把虚拟机的磁盘文件也一起迁移过去。

**存储迁移的必要性**：
```
场景1：没有共享存储
服务器A有虚拟机和磁盘文件 → 需要把磁盘文件也复制到服务器B

场景2：更换存储系统
旧存储系统 → 新存储系统，需要迁移数据

场景3：性能优化
慢速存储 → 快速存储，提升虚拟机性能
```

### 6.2 在线块迁移（Block Migration）


**在线块迁移**就是在虚拟机运行的同时，把磁盘数据从源主机复制到目标主机。

**工作原理图解**：
```
在线块迁移过程：

阶段1：开始迁移
源主机: [虚拟机运行] + [磁盘A: ████████████████]
目标主机: [准备接收] + [磁盘B: ________________]

阶段2：数据复制中
源主机: [虚拟机运行] + [磁盘A: ████████████████]
        数据流 ↓↓↓↓↓↓↓↓↓
目标主机: [准备中]     + [磁盘B: ████████________]

阶段3：迁移完成
源主机: [已清理]      + [磁盘A: 已删除]
目标主机: [虚拟机运行] + [磁盘B: ████████████████]
```

### 6.3 存储迁移命令使用


**完整存储迁移命令**：
```bash
# 同时迁移虚拟机和存储
virsh migrate --live --copy-storage-all \
  --persistent --verbose \
  vm1 qemu+ssh://target-host/system
```

**分步骤的存储迁移**：
```bash
# 第1步：开始块迁移
virsh blockcopy vm1 /path/to/source.qcow2 \
  /path/to/destination.qcow2 --wait --verbose

# 第2步：切换到新磁盘
virsh blockjob vm1 /path/to/source.qcow2 --pivot

# 第3步：清理旧磁盘
rm /path/to/source.qcow2
```

### 6.4 存储迁移监控


**监控块迁移进度**：
```bash
# 查看块任务信息
virsh blockjob vm1 /path/to/disk.qcow2

# 输出示例：
Block job: copy
Bandwidth: 100 MB/s
Cur: 1024 MB
End: 4096 MB
```

**块迁移性能调优**：
```bash
# 设置迁移带宽限制（避免影响业务）
virsh migrate-setspeed vm1 100  # 限制为100MB/s

# 调整块复制带宽
virsh blockjob vm1 /path/to/disk.qcow2 --bandwidth 200
```

---

## 7. 🚀 迁移性能优化配置


### 7.1 网络带宽优化


**网络带宽的重要性**：
迁移速度主要受限于网络带宽。带宽越大，迁移越快，停机时间越短。

**带宽配置优化**：
```bash
# 设置迁移带宽限制
virsh migrate-setspeed vm1 1000  # 设置为1GB/s

# 查看当前带宽设置
virsh migrate-getspeed vm1

# 动态调整带宽
virsh migrate-setspeed vm1 500   # 业务高峰期降低带宽
virsh migrate-setspeed vm1 2000  # 业务低峰期提高带宽
```

**网络配置建议**：
```
🔸 使用万兆网络：10Gbps网络比千兆网络快10倍
🔸 专用迁移网络：避免与业务流量竞争
🔸 调整网络缓冲区：增加TCP缓冲区大小
```

### 7.2 内存压缩配置


**内存压缩的作用**：
在迁移过程中压缩内存数据，减少网络传输量，加快迁移速度。

**启用内存压缩**：
```bash
# 在libvirt配置中启用压缩
virsh edit vm1
```

```xml
<!-- 添加内存压缩配置 -->
<domain type='kvm'>
  ...
  <features>
    <acpi/>
    <compression state='on'/>
  </features>
  ...
</domain>
```

### 7.3 并行迁移优化


**多线程迁移配置**：
```bash
# 设置迁移并行线程数
virsh migrate-setparameters vm1 \
  --compression-mt-threads 4 \
  --compression-mt-level 1
```

**参数说明**：
- `compression-mt-threads`：压缩线程数量
- `compression-mt-level`：压缩级别（1-9，越高压缩率越好但CPU消耗越大）

### 7.4 性能优化对比


| 优化方案 | 迁移时间改善 | 资源消耗 | 适用场景 |
|----------|-------------|----------|----------|
| **增加网络带宽** | 50-80% | 低 | 所有场景 |
| **启用内存压缩** | 20-40% | 中等 | 内存较大的虚拟机 |
| **多线程压缩** | 30-50% | 高 | CPU资源充足时 |
| **专用迁移网络** | 30-60% | 低 | 生产环境 |

---

## 8. 🌐 跨主机迁移网络配置


### 8.1 网络配置架构


**跨主机迁移的网络需求**：
```
迁移网络架构图：

管理网络: 192.168.1.0/24
┌──────────────┐    SSH/libvirt    ┌──────────────┐
│   源主机      │ ←──────────────→ │   目标主机    │
│ 192.168.1.10 │                  │ 192.168.1.20  │
└──────────────┘                  └──────────────┘
       │                                  │
       └──────────── 存储网络 ─────────────┘
              172.16.1.0/24

业务网络: 10.0.0.0/24
┌──────────────┐                  ┌──────────────┐
│   虚拟机1     │                  │   虚拟机1     │
│  10.0.0.100   │ ──迁移后───→     │  10.0.0.100   │
└──────────────┘                  └──────────────┘
```

### 8.2 网络桥接配置


**确保网络桥接配置一致**：
```bash
# 查看网络桥接配置
brctl show

# 输出应该在两台主机上一致：
bridge name     bridge id           STP enabled     interfaces
virbr0          8000.52540012345a   yes             virbr0-nic
br0             8000.000c29123456   no              eth0
```

**创建一致的网络桥接**：
```bash
# 在两台主机上执行相同配置
brctl addbr br0
brctl addif br0 eth0
ip addr add 192.168.1.10/24 dev br0  # 源主机
ip addr add 192.168.1.20/24 dev br0  # 目标主机
```

### 8.3 防火墙配置


**开放必要的网络端口**：
```bash
# libvirt默认端口范围：16509-16599
firewall-cmd --permanent --add-port=16509/tcp
firewall-cmd --permanent --add-port=49152-49215/tcp

# SSH端口（如果非默认）
firewall-cmd --permanent --add-port=22/tcp

# 重新加载防火墙配置
firewall-cmd --reload
```

**端口说明**：
- **16509**：libvirt TLS连接端口
- **49152-49215**：QEMU迁移数据传输端口范围
- **22**：SSH管理连接端口

### 8.4 网络测试验证


**网络连通性测试**：
```bash
# 基本连通性测试
ping -c 4 target-host

# 带宽测试（需要安装iperf3）
# 在目标主机运行服务端：
iperf3 -s

# 在源主机运行客户端：
iperf3 -c target-host -t 30
# 结果应该显示可用带宽
```

**libvirt连接测试**：
```bash
# 测试libvirt连接
virsh -c qemu+ssh://target-host/system list

# 测试虚拟机查看权限
virsh -c qemu+ssh://target-host/system capabilities
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 迁移类型：冷迁移适合维护窗口，热迁移适合在线业务
🔸 virsh migrate：虚拟机迁移的核心命令工具
🔸 前置条件：共享存储、网络连通、CPU兼容性三大要素
🔸 监控处理：实时监控迁移进度，及时处理故障
🔸 存储迁移：解决无共享存储环境的迁移需求
🔸 性能优化：带宽、压缩、并行等多维度优化方案
🔸 网络配置：管理网络、存储网络、业务网络的统一规划
```

### 9.2 关键理解要点


**🔹 迁移本质理解**
```
虚拟机迁移不是简单的文件复制，而是：
- 运行状态的完整转移
- 网络连接的无缝切换  
- 存储访问的路径调整
- 系统资源的重新分配
```

**🔹 技术选择原则**
```
冷迁移 vs 热迁移：
- 业务重要性：关键业务选热迁移
- 停机窗口：有维护窗口可选冷迁移
- 技术条件：网络和存储条件决定可行性
- 成本考虑：热迁移需要更高的基础设施投入
```

**🔹 故障处理思路**
```
故障排查优先级：
1. 网络连通性（最常见问题）
2. 存储配置（数据安全相关）
3. CPU兼容性（影响运行稳定性）
4. 权限配置（操作权限问题）
```

### 9.3 实际应用价值


**🎯 业务场景应用**
- **数据中心维护**：硬件维修时的业务连续性保障
- **负载均衡**：动态调整资源分布，优化性能
- **灾难恢复**：故障时快速恢复业务运行
- **成本优化**：根据业务量动态调整资源分配

**🔧 运维实践要点**
- **规划先行**：提前规划网络、存储架构
- **测试验证**：生产环境使用前充分测试
- **监控告警**：建立完善的迁移监控体系
- **应急预案**：制定迁移失败的回滚方案

### 9.4 进阶学习方向


```
🚀 高级特性：
- 跨数据中心迁移
- 容器化虚拟机迁移  
- 自动化迁移调度
- 迁移性能调优

🔧 相关技术：
- OpenStack Nova实时迁移
- VMware vMotion技术对比
- 容器编排中的Pod迁移
- 云原生应用的无状态化设计
```

**核心记忆**：
- 热迁移保业务，冷迁移保数据
- 共享存储是基础，网络配置是关键
- virsh migrate是工具，监控排错是保障
- 性能优化看场景，网络规划要统一