---
title: 12、虚拟化故障排查
---
## 📚 目录

1. [虚拟机启动失败诊断](#1-虚拟机启动失败诊断)
2. [libvirt日志分析](#2-libvirt日志分析)
3. [QEMU日志分析与调试](#3-QEMU日志分析与调试)
4. [虚拟机性能问题排查](#4-虚拟机性能问题排查)
5. [网络连接故障诊断](#5-网络连接故障诊断)
6. [存储访问问题排查](#6-存储访问问题排查)
7. [常见错误解决方案](#7-常见错误解决方案)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🚫 虚拟机启动失败诊断


### 1.1 什么是虚拟机启动失败


**简单理解**：就像你的电脑开不了机一样，虚拟机也会遇到各种启动问题。可能是"硬件"配置有问题，可能是"系统"出错，也可能是资源不够用。

**常见启动失败现象**：
- 🔸 虚拟机根本启动不了
- 🔸 启动过程中卡住不动
- 🔸 启动后立即崩溃
- 🔸 能启动但无法正常工作

### 1.2 启动失败的常见原因


```
启动失败原因分析：

硬件资源问题：
├── 内存不足 → 物理机剩余内存小于虚拟机需求
├── CPU核心不够 → 分配的CPU核心数超出物理限制
└── 存储空间满 → 磁盘空间不足，无法创建临时文件

配置问题：
├── XML配置错误 → libvirt配置文件语法错误
├── 镜像路径错误 → 找不到虚拟机镜像文件
└── 网络配置错误 → 网桥或网络接口配置问题

权限问题：
├── 文件权限不足 → libvirt无法访问镜像文件
├── SELinux阻止 → 安全策略限制虚拟机操作
└── 用户权限不够 → 当前用户无虚拟化操作权限
```

### 1.3 基础诊断步骤


**第一步：检查基础状态**
```bash
# 检查KVM模块是否加载
lsmod | grep kvm

# 检查libvirt服务状态
systemctl status libvirtd

# 检查虚拟机列表
virsh list --all
```

**第二步：尝试启动并观察**
```bash
# 尝试启动虚拟机（替换vm-name为实际名称）
virsh start vm-name

# 如果失败，查看详细错误信息
virsh start vm-name --debug
```

**第三步：检查资源使用情况**
```bash
# 检查内存使用
free -h

# 检查磁盘空间
df -h

# 检查CPU使用率
top
```

### 1.4 启动失败的排查流程


```
启动失败排查流程图：

虚拟机启动失败
        ↓
检查错误信息 → 有明确错误 → 根据错误类型处理
        ↓
检查系统资源 → 资源不足 → 释放资源或增加硬件
        ↓
检查配置文件 → 配置错误 → 修正XML配置
        ↓
检查文件权限 → 权限问题 → 修改文件权限
        ↓
检查日志文件 → 查找详细错误原因
        ↓
解决问题并重新启动
```

---

## 2. 📋 libvirt日志分析


### 2.1 libvirt日志系统概述


**什么是libvirt日志**：libvirt是虚拟化管理的"大管家"，它把所有操作都详细记录下来，就像医院的病历一样，记录了虚拟机的每一个"生命体征"。

**日志的作用**：
- 🎯 **故障诊断** - 出问题时知道哪里出错了
- 🎯 **操作追踪** - 谁在什么时候做了什么操作
- 🎯 **性能分析** - 系统运行是否正常
- 🎯 **安全审计** - 检查是否有异常操作

### 2.2 libvirt日志文件位置


**主要日志文件**：
```
/var/log/libvirt/ 目录结构：
├── libvirtd.log          ← 主服务日志（最重要）
├── qemu/                 ← QEMU相关日志目录  
│   ├── vm1.log          ← 具体虚拟机日志
│   └── vm2.log          ← 另一个虚拟机日志
└── lxc/                  ← 容器日志（如果使用LXC）
```

**各日志文件的含义**：
- **libvirtd.log** - 记录libvirt守护进程的所有活动
- **qemu/虚拟机名.log** - 记录特定虚拟机的详细运行信息
- **audit.log** - 记录审计相关信息（如果启用）

### 2.3 查看和分析libvirt日志


**基本查看方法**：
```bash
# 查看主要日志文件（最近100行）
tail -100 /var/log/libvirt/libvirtd.log

# 实时监控日志（类似看直播）
tail -f /var/log/libvirt/libvirtd.log

# 查看特定虚拟机日志
tail -50 /var/log/libvirt/qemu/your-vm-name.log
```

**日志内容解读**：
```
典型日志条目格式：
2024-09-17 10:30:15.123+0800: 12345: info : libvirt version: 8.0.0
│                              │      │      │
时间戳                          进程ID  级别   具体信息

日志级别含义：
• ERROR - 错误，需要立即关注
• WARN  - 警告，可能有问题
• INFO  - 信息，正常操作记录
• DEBUG - 调试，详细技术信息
```

### 2.4 常见日志错误分析


**内存不足错误**：
```
错误信息：Cannot allocate memory for domain
解读：物理机内存不够，无法为虚拟机分配所需内存
解决：释放内存或减少虚拟机内存配置
```

**权限错误**：
```
错误信息：Permission denied accessing '/path/to/vm.img'
解读：libvirt没有权限访问虚拟机镜像文件
解决：修改文件权限或SELinux设置
```

**配置错误**：
```
错误信息：XML error: Missing required attribute 'type'
解读：虚拟机XML配置文件中缺少必需的属性
解决：检查并修正XML配置文件
```

---

## 3. 🔍 QEMU日志分析与调试


### 3.1 QEMU日志系统理解


**QEMU的角色**：如果说libvirt是"管理员"，那么QEMU就是真正的"执行者"。它负责模拟硬件，运行虚拟机。QEMU日志记录的是虚拟机内部的"硬件"工作情况。

**QEMU日志 vs libvirt日志的区别**：
```
libvirt日志：管理层面
├── "要启动哪个虚拟机"
├── "分配了多少资源"  
└── "执行了什么命令"

QEMU日志：执行层面
├── "虚拟CPU运行情况"
├── "模拟硬件状态"
└── "虚拟机内部错误"
```

### 3.2 启用详细QEMU日志


**临时启用调试模式**：
```bash
# 设置环境变量启用详细日志
export LIBVIRT_DEBUG=1
export LIBVIRT_LOG_OUTPUTS="1:stderr"

# 然后启动虚拟机
virsh start your-vm-name
```

**永久配置QEMU日志**：
编辑 `/etc/libvirt/qemu.conf` 文件：
```
# 启用详细日志
log_level = 1
log_outputs = "1:file:/var/log/libvirt/qemu-debug.log"
```

### 3.3 QEMU调试参数


**手动启动QEMU进行调试**：
```bash
# 查看libvirt生成的QEMU命令
virsh domxml-to-native qemu-argv your-vm-name

# 手动运行QEMU with调试参数
qemu-system-x86_64 \
    -enable-kvm \
    -m 2048 \
    -smp 2 \
    -monitor stdio \
    -D /tmp/qemu-debug.log \
    /path/to/vm.img
```

**重要调试选项说明**：
- `-monitor stdio` - 启用QEMU监控控制台
- `-D logfile` - 指定日志文件位置
- `-d cpu,exec` - 记录CPU执行详情
- `-serial file:serial.log` - 记录串口输出

### 3.4 QEMU性能监控


**监控QEMU进程**：
```bash
# 找到QEMU进程
ps aux | grep qemu

# 监控QEMU资源使用
top -p $(pgrep qemu)

# 查看QEMU进程详细信息
cat /proc/$(pgrep qemu)/status
```

**QEMU内置监控命令**：
通过QEMU monitor可以实时查看虚拟机状态：
```
# 连接到QEMU monitor
virsh qemu-monitor-command your-vm-name --hmp "info status"

# 查看CPU状态
virsh qemu-monitor-command your-vm-name --hmp "info cpus"

# 查看内存使用
virsh qemu-monitor-command your-vm-name --hmp "info memory"
```

---

## 4. 📊 虚拟机性能问题排查


### 4.1 性能问题的表现


**用户感受层面**：
- 🐌 虚拟机运行很慢，就像老电脑一样卡顿
- 🐌 应用程序响应缓慢
- 🐌 文件传输速度很慢
- 🐌 网络访问延迟高

**系统层面指标**：
- CPU使用率异常（过高或过低）
- 内存使用不合理
- 磁盘I/O性能差
- 网络吞吐量低

### 4.2 性能监控工具与方法


**主机端监控**：
```bash
# 实时查看系统整体性能
htop

# 监控虚拟机进程资源使用
ps aux | grep qemu | head -5

# 查看磁盘I/O情况  
iostat -x 1

# 监控网络流量
iftop
```

**虚拟机性能统计**：
```bash
# 查看虚拟机CPU使用统计
virsh cpu-stats your-vm-name

# 查看内存使用统计
virsh memstat your-vm-name

# 查看磁盘I/O统计
virsh domblkstat your-vm-name
```

### 4.3 常见性能瓶颈分析


**CPU性能问题**：

| 现象 | 可能原因 | 解决方案 |
|------|----------|----------|
| `CPU使用率100%` | `虚拟机CPU不够用` | `增加vCPU数量或升级物理CPU` |
| `CPU使用率很低但很慢` | `CPU频率被限制` | `检查电源管理设置，启用性能模式` |
| `CPU等待时间高` | `I/O瓶颈导致` | `优化存储性能或增加内存` |

**内存性能问题**：
```
内存问题诊断流程：

检查内存分配：
├── 虚拟机是否分配了足够内存？
├── 物理机是否有足够可用内存？
└── 是否存在内存交换到磁盘？

内存使用模式：
├── 应用程序内存泄漏？
├── 缓存占用过多内存？
└── 内存碎片化严重？
```

**存储性能问题**：
- **磁盘格式选择** - qcow2 vs raw格式的性能差异
- **存储位置** - 本地存储 vs 网络存储
- **缓存策略** - 不同缓存模式的性能影响

### 4.4 性能优化策略


**CPU优化**：
```bash
# 设置CPU亲和性（绑定特定CPU核心）
virsh vcpupin your-vm-name 0 1
virsh vcpupin your-vm-name 1 2

# 启用CPU性能模式
cpupower frequency-set -g performance
```

**内存优化**：
```bash
# 启用内存大页支持
echo 1024 > /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages

# 在虚拟机配置中启用hugepages
# 编辑虚拟机XML配置，添加：
# <memoryBacking>
#   <hugepages/>
# </memoryBacking>
```

**磁盘I/O优化**：
```bash
# 修改磁盘缓存策略
virsh edit your-vm-name
# 找到disk配置，修改为：
# <driver name='qemu' type='qcow2' cache='writeback'/>
```

---

## 5. 🌐 网络连接故障诊断


### 5.1 虚拟化网络架构理解


**网络连接的"路径"**：
```
虚拟机网络数据流向图：

虚拟机内部应用
        ↓
虚拟网卡(eth0)
        ↓  
虚拟交换机/网桥(virbr0)
        ↓
物理网卡(ens32)
        ↓
外部网络

每一层都可能出现问题！
```

**网络组件作用说明**：
- **虚拟网卡** - 虚拟机的"网线接口"
- **网桥(Bridge)** - 像现实中的交换机，连接多个设备
- **NAT** - 网络地址转换，让内网访问外网
- **物理网卡** - 连接到真实网络的接口

### 5.2 网络故障分层诊断


**第一层：虚拟机内部检查**
```bash
# 在虚拟机内部执行
ping 127.0.0.1          # 检查本机网络栈
ip addr show            # 查看网卡配置
ip route show           # 查看路由表
```

**第二层：虚拟网络检查**
```bash
# 在物理主机执行
virsh net-list          # 查看虚拟网络列表
virsh net-info default  # 查看默认网络信息
brctl show              # 查看网桥状态
```

**第三层：物理网络检查**
```bash
# 检查物理网卡状态
ip link show
# 检查外部网络连通性  
ping 8.8.8.8
# 查看防火墙规则
iptables -L -n
```

### 5.3 常见网络问题解决


**虚拟机无法获取IP地址**：
```
问题现象：虚拟机启动后网卡显示为未连接状态
排查步骤：
1. 检查DHCP服务是否运行
   systemctl status libvirtd
   
2. 查看默认网络是否启动
   virsh net-start default
   
3. 检查网桥是否正常
   brctl show virbr0
```

**虚拟机无法访问外网**：
```
解决思路：

检查路由配置：
├── 虚拟机默认网关是否正确？
├── 物理机是否能正常上网？
└── NAT规则是否生效？

检查防火墙设置：
├── iptables是否阻止了转发？
├── firewalld规则是否正确？
└── SELinux是否限制网络访问？
```

**网络性能差的排查**：
```bash
# 测试网络带宽
iperf3 -s  # 在一台机器上启动服务器
iperf3 -c server-ip  # 在另一台机器测试

# 检查网络延迟
ping -c 10 target-ip

# 查看网络接口统计
cat /proc/net/dev
```

### 5.4 网络配置验证


**验证网络连接完整性**：
```bash
# 完整的网络测试流程
echo "=== 网络诊断开始 ==="

# 1. 检查虚拟机网卡
virsh domiflist your-vm-name

# 2. 检查网桥连接
brctl show

# 3. 测试内网连通性
ping -c 3 192.168.122.1

# 4. 测试外网连通性  
ping -c 3 8.8.8.8

# 5. 测试DNS解析
nslookup google.com

echo "=== 网络诊断结束 ==="
```

---

## 6. 💾 存储访问问题排查


### 6.1 虚拟化存储架构


**存储层次理解**：
```
虚拟机存储架构图：

虚拟机操作系统
        ↓
虚拟磁盘文件(qcow2/raw)
        ↓  
文件系统(ext4/xfs)
        ↓
物理磁盘(SSD/HDD)

问题可能出现在任何一层！
```

**存储类型对比**：

| 存储类型 | **特点** | **适用场景** | **可能问题** |
|----------|----------|-------------|-------------|
| `qcow2格式` | `支持快照，动态扩展` | `开发测试环境` | `性能相对较低` |
| `raw格式` | `性能好，兼容性强` | `生产环境` | `占用空间大` |
| `LVM存储` | `管理灵活，性能好` | `企业环境` | `配置相对复杂` |

### 6.2 存储问题诊断方法


**磁盘空间问题**：
```bash
# 检查物理主机磁盘空间
df -h

# 检查虚拟机镜像大小
qemu-img info /path/to/vm.img

# 查看目录占用情况
du -sh /var/lib/libvirt/images/*
```

**磁盘I/O性能问题**：
```bash
# 监控磁盘I/O使用率
iostat -x 1 5

# 查看磁盘队列情况
cat /proc/diskstats

# 测试磁盘读写速度
hdparm -t /dev/sda  # 测试读取速度
dd if=/dev/zero of=/tmp/testfile bs=1G count=1  # 测试写入速度
```

**文件权限问题**：
```bash
# 检查镜像文件权限
ls -la /var/lib/libvirt/images/

# 检查文件所属用户组
stat /path/to/vm.img

# 修复权限问题
chown qemu:qemu /path/to/vm.img
chmod 644 /path/to/vm.img
```

### 6.3 存储故障恢复


**虚拟机镜像损坏**：
```bash
# 检查qcow2文件完整性
qemu-img check /path/to/vm.img

# 尝试修复损坏的镜像
qemu-img check -r all /path/to/vm.img

# 如果无法修复，从备份恢复
cp /backup/path/vm.img /var/lib/libvirt/images/
```

**存储空间不足处理**：
```
处理步骤：

紧急处理：
├── 删除不必要的快照
├── 清理临时文件
└── 移动虚拟机到其他存储

长期解决：
├── 增加物理磁盘容量
├── 使用精简置备
└── 配置存储监控告警
```

### 6.4 存储性能优化


**选择合适的存储格式**：
```bash
# 转换存储格式（qcow2转raw以提高性能）
qemu-img convert -f qcow2 -O raw vm.qcow2 vm.raw

# 预分配磁盘空间（避免动态扩展的性能损失）
qemu-img create -f qcow2 -o preallocation=full vm.qcow2 20G
```

**优化缓存设置**：
```xml
<!-- 在虚拟机XML配置中优化磁盘设置 -->
<disk type='file' device='disk'>
    <driver name='qemu' type='qcow2' cache='writeback' io='threads'/>
    <source file='/var/lib/libvirt/images/vm.qcow2'/>
    <target dev='vda' bus='virtio'/>
</disk>
```

---

## 7. ⚠️ 常见错误解决方案


### 7.1 启动类错误


**错误：`Cannot access storage file`**
```
错误含义：找不到或无法访问虚拟机镜像文件
常见原因：
• 文件路径错误
• 文件权限不够
• SELinux策略限制

解决步骤：
1. 确认文件是否存在
   ls -la /path/to/vm.img
   
2. 检查权限设置
   chown qemu:qemu /path/to/vm.img
   
3. 检查SELinux标签
   restorecon -R /var/lib/libvirt/images/
```

**错误：`Domain not found`**
```
错误含义：找不到指定的虚拟机
解决方法：
• 检查虚拟机名称是否正确
• 查看虚拟机列表：virsh list --all  
• 重新定义虚拟机：virsh define /path/to/vm.xml
```

### 7.2 资源类错误


**错误：`Unable to reserve memory`**
```
错误含义：无法为虚拟机分配所需内存
解决思路：

检查内存使用：
├── free -h 查看可用内存
├── 关闭不必要的虚拟机释放内存
└── 减少虚拟机内存配置

调整内存分配：
virsh edit your-vm-name
# 修改memory配置为更小值
```

**错误：`CPU feature not supported`**
```
错误含义：虚拟机要求的CPU特性物理机不支持
解决方法：
• 修改CPU配置为兼容模式
• 在XML中使用host-passthrough模式要谨慎
• 检查物理CPU是否支持虚拟化扩展
```

### 7.3 网络类错误


**错误：`Cannot create bridge virbr0`**
```
错误含义：无法创建虚拟网桥
排查步骤：

1. 检查网桥工具是否安装
   yum install bridge-utils
   
2. 检查内核模块
   modprobe bridge
   
3. 重启libvirt服务
   systemctl restart libvirtd
```

### 7.4 权限类错误


**错误：`Permission denied`**
```
这是最常见的问题之一，通常是权限设置不当

系统性解决方案：

1. 文件权限检查
   ls -la /var/lib/libvirt/images/
   chown -R qemu:qemu /var/lib/libvirt/images/
   
2. SELinux设置检查  
   getenforce  # 查看SELinux状态
   setsebool -P virt_use_execmem 1
   
3. 用户组权限检查
   usermod -a -G libvirt your-username
```

---

## 8. 📋 核心要点总结


### 8.1 故障排查思维框架


**分层排查法**：
```
虚拟化故障排查层次：

应用层问题 → 虚拟机内部系统问题
    ↓
虚拟机层问题 → 配置、资源、权限问题  
    ↓
Hypervisor层问题 → QEMU/KVM运行问题
    ↓
物理层问题 → 硬件、网络、存储问题

从上到下逐层排查，找到根本原因
```

### 8.2 必备排查工具


**日志分析工具**：
- `tail -f` - 实时监控日志变化
- `grep` - 过滤关键错误信息
- `journalctl` - 系统日志查看

**性能监控工具**：
- `htop/top` - 系统资源监控
- `iostat` - 磁盘I/O监控  
- `iftop` - 网络流量监控

**虚拟化专用工具**：
- `virsh` - libvirt管理命令
- `qemu-img` - 镜像文件操作
- `virt-top` - 虚拟机性能监控

### 8.3 关键理解要点


**🔹 故障排查的核心思路**
```
问题定位三步法：
1. 现象描述 → 具体表现是什么？
2. 原因分析 → 可能的原因有哪些？
3. 解决验证 → 如何解决并验证效果？

记住：症状不等于原因，要找到根本问题
```

**🔹 预防胜于治疗**
```
预防措施：
• 定期备份虚拟机镜像和配置
• 监控系统资源使用情况  
• 保持系统和软件更新
• 建立标准化的配置模板
```

### 8.4 实践建议


**日常维护清单**：
- ✅ 每日检查系统资源使用情况
- ✅ 每周查看libvirt和QEMU日志
- ✅ 每月清理不必要的快照和临时文件
- ✅ 定期测试备份恢复流程

**应急响应流程**：
- 🚨 **第一时间** - 记录故障现象和错误信息
- 🚨 **快速判断** - 区分是紧急问题还是可以延后处理
- 🚨 **分层排查** - 按照网络→存储→计算的顺序排查
- 🚨 **记录总结** - 解决后记录问题原因和解决方法

**核心记忆要点**：
- 虚拟化故障排查需要系统性思维，分层分类处理
- 日志是排查问题的最重要信息来源
- 权限问题是虚拟化环境中最常见的问题类型  
- 预防和监控比被动排查更重要
- 掌握基本的排查工具和命令是基础技能