---
title: 5、虚拟机安装与配置
---
## 📚 目录

1. [虚拟化基础概念](#1-虚拟化基础概念)
2. [virt-install命令详解](#2-virt-install命令详解)
3. [ISO镜像引导安装](#3-ISO镜像引导安装)
4. [网络安装配置](#4-网络安装配置)
5. [虚拟机硬件规格配置](#5-虚拟机硬件规格配置)
6. [启动模式配置](#6-启动模式配置)
7. [操作系统优化配置](#7-操作系统优化配置)
8. [半虚拟化驱动安装](#8-半虚拟化驱动安装)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🖥️ 虚拟化基础概念


### 1.1 什么是虚拟机安装与配置


**虚拟机**就像在你的电脑里再造了一台"假"电脑。这台假电脑有自己的CPU、内存、硬盘，可以装操作系统，运行程序，但实际上都是用你真实电脑的资源模拟出来的。

```
物理机架构：
┌─────────────────────────────────────┐
│           物理硬件               │
├─────────────────────────────────────┤
│         宿主操作系统             │
├─────────────────────────────────────┤
│    虚拟化管理软件(KVM/QEMU)        │
├─────────────────────────────────────┤
│ 虚拟机1 | 虚拟机2 | 虚拟机3        │
│  OS1   |  OS2   |  OS3          │
└─────────────────────────────────────┘
```

**🔸 核心组件说明**：
- **KVM**：Linux内核的虚拟化模块，负责CPU和内存虚拟化
- **QEMU**：硬件模拟器，模拟各种硬件设备
- **libvirt**：虚拟化管理接口，提供统一的管理方式
- **virt-install**：命令行虚拟机创建工具

### 1.2 虚拟机安装的几种方式


**💡 常见安装方式对比**：

| 安装方式 | **说明** | **适用场景** | **难度** |
|---------|---------|-------------|---------|
| **ISO安装** | 用光盘镜像文件安装 | 单台虚拟机，有图形界面 | `🌟 简单` |
| **PXE网络安装** | 通过网络启动安装 | 批量部署，企业环境 | `🔥 中等` |
| **HTTP网络安装** | 从HTTP服务器获取安装文件 | 快速部署，节省带宽 | `🔥 中等` |
| **模板克隆** | 复制现有虚拟机 | 快速部署相同系统 | `🌟 简单` |

---

## 2. ⚙️ virt-install命令详解


### 2.1 virt-install是什么


**virt-install**是创建虚拟机的命令行工具，就像装机师傅用的"一键装机"工具，但更灵活更强大。它能帮你：
- 创建虚拟机的"硬件配置"
- 指定从哪里安装系统
- 设置网络连接方式
- 配置各种启动参数

### 2.2 基本语法结构


```bash
virt-install \
  --name 虚拟机名称 \
  --memory 内存大小 \
  --vcpus CPU核心数 \
  --disk 磁盘配置 \
  --cdrom ISO镜像路径 \
  --network 网络配置 \
  --graphics 显示配置
```

**🔸 常用参数分类**：

| 参数类型 | **主要参数** | **作用说明** |
|---------|-------------|-------------|
| **基本信息** | `--name`, `--description` | 虚拟机名称和描述 |
| **硬件配置** | `--memory`, `--vcpus`, `--disk` | 内存、CPU、存储配置 |
| **安装源** | `--cdrom`, `--location`, `--pxe` | 指定系统安装来源 |
| **网络配置** | `--network`, `--bridge` | 网络连接方式 |
| **显示配置** | `--graphics`, `--noautoconsole` | 图形显示和控制台 |

### 2.3 实用参数详解


**🎯 内存配置**：
```bash
--memory 2048          # 固定2GB内存
--memory 2048,maxmemory=4096  # 初始2GB，最大可扩展到4GB
```

**🎯 CPU配置**：
```bash
--vcpus 2              # 2个虚拟CPU核心
--vcpus 2,maxvcpus=4   # 初始2核，最大可扩展到4核
--cpu host-model       # 使用宿主机CPU型号特性
```

**🎯 磁盘配置**：
```bash
--disk size=20                    # 创建20GB虚拟磁盘
--disk path=/var/lib/libvirt/images/vm1.qcow2,size=20,format=qcow2
--disk /dev/sdb                   # 直接使用物理磁盘
```

---

## 3. 💿 ISO镜像引导安装


### 3.1 ISO安装原理


**ISO镜像**就是把光盘内容打包成一个文件，虚拟机把这个文件当作"虚拟光驱"来读取。就像你把系统安装盘放进电脑的光驱一样。

```
ISO安装流程：
宿主机ISO文件 → QEMU模拟光驱 → 虚拟机读取 → 启动安装程序
```

### 3.2 准备ISO镜像


**📝 获取ISO镜像**：
- **CentOS**: `https://mirrors.aliyun.com/centos/`
- **Ubuntu**: `https://releases.ubuntu.com/`  
- **Debian**: `https://www.debian.org/distrib/`

**⚠️ 注意事项**：
- ISO文件要完整下载，不能损坏
- 检查文件MD5或SHA256校验值
- 确保有足够磁盘空间存放ISO

### 3.3 ISO安装实例


**🔧 基础ISO安装命令**：
```bash
virt-install \
  --name centos7-vm \
  --memory 2048 \
  --vcpus 2 \
  --disk size=20 \
  --cdrom /home/isos/CentOS-7-x86_64-DVD.iso \
  --network network=default \
  --graphics vnc,listen=0.0.0.0 \
  --os-variant centos7.0
```

**💡 参数解释**：
- `--name centos7-vm`：虚拟机叫"centos7-vm"
- `--memory 2048`：分配2GB内存
- `--vcpus 2`：分配2个CPU核心  
- `--disk size=20`：创建20GB虚拟硬盘
- `--cdrom`：指定ISO镜像位置
- `--network network=default`：使用默认网络
- `--graphics vnc`：使用VNC图形显示
- `--os-variant`：告诉系统这是什么操作系统，便于优化

### 3.4 图形界面安装过程


**🖱️ 连接虚拟机控制台**：
```bash
# 方法1：使用virt-viewer
virt-viewer centos7-vm

# 方法2：使用VNC客户端
# 连接到宿主机IP:5900端口

# 方法3：使用virsh控制台
virsh console centos7-vm
```

**📋 安装步骤**：
1. **启动虚拟机** → 从ISO启动
2. **选择安装选项** → Install CentOS 7
3. **配置安装参数** → 语言、时区、分区
4. **等待安装完成** → 自动安装系统文件
5. **首次启动配置** → 创建用户、网络等

---

## 4. 🌐 网络安装配置


### 4.1 网络安装的优势


**网络安装**就像在线下载系统，不需要ISO文件，直接从网上获取安装包。就像手机系统OTA升级一样。

**✅ 优势对比**：

| 特点 | **ISO安装** | **网络安装** |
|-----|------------|-------------|
| **存储需求** | 需要下载完整ISO | 只下载需要的包 |
| **安装速度** | 本地读取快 | 取决于网络速度 |
| **系统更新** | 可能不是最新 | 安装最新版本 |
| **定制化** | 标准安装 | 可选择组件 |

### 4.2 PXE网络安装


**PXE**是"预启动执行环境"，简单说就是让电脑从网络启动，而不是从硬盘或光盘启动。

**🏗️ PXE安装架构**：
```
客户端虚拟机     DHCP服务器     TFTP服务器     HTTP服务器
     |              |             |             |
     |--获取IP------>|             |             |
     |<--返回IP------|             |             |
     |              |             |             |
     |--请求启动文件-------------->|             |
     |<--返回启动文件--------------|             |
     |              |             |             |
     |--下载安装包---------------------------->|
```

**🔧 PXE安装命令**：
```bash
virt-install \
  --name pxe-vm \
  --memory 2048 \
  --vcpus 2 \
  --disk size=20 \
  --pxe \
  --network bridge=br0 \
  --graphics vnc
```

**📋 PXE服务器配置要点**：
- **DHCP服务**：分配IP地址和启动文件位置
- **TFTP服务**：提供启动引导文件
- **HTTP/FTP服务**：提供安装包下载

### 4.3 HTTP网络安装


**HTTP安装**是指从HTTP服务器下载安装文件，比PXE配置简单。

**🔧 HTTP安装命令**：
```bash
virt-install \
  --name http-vm \
  --memory 2048 \
  --vcpus 2 \
  --disk size=20 \
  --location http://mirrors.aliyun.com/centos/7/os/x86_64/ \
  --network network=default \
  --graphics vnc \
  --extra-args="console=tty0 console=ttyS0,115200"
```

**💡 关键参数**：
- `--location`：指定HTTP安装源地址
- `--extra-args`：传递给内核的额外参数
- `console=ttyS0,115200`：启用串口控制台

---

## 5. 🔧 虚拟机硬件规格配置


### 5.1 CPU配置详解


**CPU配置**决定虚拟机的计算能力，就像给电脑配多少核心的处理器。

**🎯 CPU核心数配置**：
```bash
# 基础配置
--vcpus 4                    # 4个虚拟CPU核心

# 高级配置
--vcpus 4,maxvcpus=8,sockets=2,cores=2,threads=1
```

**📊 CPU拓扑结构**：
- **sockets**：CPU插槽数量（物理CPU数）
- **cores**：每个CPU的核心数
- **threads**：每个核心的线程数
- **总虚拟CPU = sockets × cores × threads**

**🔸 CPU型号配置**：
```bash
--cpu host-model             # 使用宿主机CPU特性
--cpu host-passthrough       # 完全透传宿主机CPU
--cpu Westmere               # 指定特定CPU型号
```

### 5.2 内存配置详解


**内存配置**就像给虚拟机装多少内存条，影响系统运行速度。

**🎯 内存大小配置**：
```bash
--memory 4096                # 4GB固定内存
--memory 2048,maxmemory=8192 # 初始2GB，最大8GB
--memory 4096,hugepages=yes  # 使用大页内存优化性能
```

**💡 内存配置建议**：

| 用途 | **推荐内存** | **最小内存** |
|-----|-------------|-------------|
| **轻量级服务** | 1-2GB | 512MB |
| **Web服务器** | 2-4GB | 1GB |
| **数据库服务器** | 4-8GB | 2GB |
| **开发环境** | 4-8GB | 2GB |

### 5.3 磁盘配置详解


**磁盘配置**决定虚拟机的存储空间和性能，就像给电脑装硬盘。

**🎯 磁盘基本配置**：
```bash
# 创建新磁盘
--disk size=50                # 50GB qcow2格式磁盘
--disk size=50,format=raw     # 50GB raw格式磁盘

# 指定磁盘位置
--disk path=/var/lib/libvirt/images/vm.qcow2,size=50

# 使用现有磁盘
--disk /var/lib/libvirt/images/existing.qcow2
```

**📊 磁盘格式对比**：

| 格式 | **特点** | **性能** | **功能** |
|-----|---------|---------|---------|
| **qcow2** | 动态分配，支持快照 | 中等 | 功能丰富 |
| **raw** | 固定大小，性能好 | 最佳 | 功能简单 |
| **vmdk** | VMware兼容 | 中等 | 跨平台 |

**🔸 高级磁盘配置**：
```bash
# virtio接口，缓存模式
--disk size=50,bus=virtio,cache=writeback

# 多磁盘配置
--disk size=20,bus=virtio \
--disk size=100,bus=virtio,cache=none
```

### 5.4 网络配置详解


**网络配置**决定虚拟机如何连接网络，就像给电脑插网线。

**🎯 网络模式对比**：

| 模式 | **说明** | **适用场景** |
|-----|---------|-------------|
| **NAT** | 共享宿主机网络 | 简单上网需求 |
| **Bridge** | 独立网络地址 | 服务器部署 |
| **Host-only** | 只与宿主机通信 | 隔离测试环境 |

**🔧 网络配置示例**：
```bash
# 默认NAT网络
--network network=default

# 桥接网络
--network bridge=br0

# 指定MAC地址
--network network=default,mac=52:54:00:12:34:56

# 多网卡配置
--network network=default \
--network bridge=br1
```

---

## 6. 🚀 启动模式配置


### 6.1 BIOS vs UEFI


**BIOS和UEFI**是两种不同的启动方式，就像老式汽车和新式汽车的启动系统。

```
启动流程对比：

BIOS启动：
开机 → BIOS初始化 → 读取MBR → 启动引导程序 → 加载系统

UEFI启动：  
开机 → UEFI固件 → 读取GPT → EFI启动程序 → 加载系统
```

**📊 BIOS vs UEFI对比**：

| 特性 | **BIOS** | **UEFI** |
|-----|---------|---------|
| **磁盘支持** | 最大2TB | 支持大于2TB |
| **分区表** | MBR | GPT |
| **启动速度** | 较慢 | 较快 |
| **安全性** | 基础 | 支持安全启动 |
| **图形界面** | 文本模式 | 支持图形界面 |

### 6.2 启动模式配置


**🔧 BIOS模式配置**：
```bash
virt-install \
  --name bios-vm \
  --boot loader=/usr/share/seabios/bios.bin \
  # 其他配置...
```

**🔧 UEFI模式配置**：
```bash
virt-install \
  --name uefi-vm \
  --boot uefi \
  # 或者指定UEFI固件
  --boot loader=/usr/share/OVMF/OVMF_CODE.fd \
  # 其他配置...
```

**💡 选择建议**：
- **新系统部署**：推荐使用UEFI
- **旧系统兼容**：使用BIOS
- **大磁盘支持**：必须使用UEFI
- **安全要求高**：使用UEFI安全启动

### 6.3 启动顺序配置


**启动顺序**决定虚拟机从哪个设备启动，就像设置电脑的启动优先级。

```bash
# 从光盘启动（安装系统时）
--boot cdrom,hd

# 从硬盘启动（正常运行时）
--boot hd

# 从网络启动（PXE安装）
--boot network
```

---

## 7. ⚡ 操作系统优化配置


### 7.1 操作系统变体


**os-variant参数**告诉KVM这是什么操作系统，让虚拟机针对特定系统进行优化，就像给不同品牌的汽车用专门的机油。

**🔍 查看支持的系统**：
```bash
# 列出所有支持的操作系统
osinfo-query os

# 搜索特定系统
osinfo-query os | grep -i centos
osinfo-query os | grep -i ubuntu
```

**📋 常用系统变体**：
```bash
# Red Hat系列
--os-variant rhel7.0
--os-variant centos7.0  
--os-variant fedora28

# Debian系列
--os-variant ubuntu18.04
--os-variant debian9

# Windows系列
--os-variant win10
--os-variant win2k16
```

### 7.2 时间同步配置


**时间同步**确保虚拟机时间准确，避免时间漂移问题。

**🔧 时间同步设置**：
```bash
# 安装时配置时区
--extra-args="ks=... timezone=Asia/Shanghai"

# 启用时间同步
--features kvm_hidden=on,hyperv_relaxed=on,hyperv_time=on
```

**📝 虚拟机内时间同步**：
```bash
# 安装时间同步工具
yum install -y chrony

# 配置时间服务器
echo "server time.aliyun.com iburst" >> /etc/chrony.conf
systemctl enable chronyd
systemctl start chronyd
```

### 7.3 内存优化配置


**内存优化**能提高虚拟机性能，减少内存开销。

**🎯 内存优化选项**：
```bash
# 启用内存气球
--memballoon virtio

# 使用大页内存
--memory 4096,hugepages=yes

# 内存共享优化
--memory 4096,locked=yes
```

**🔸 大页内存配置**：
```bash
# 宿主机配置大页内存
echo 1024 > /proc/sys/vm/nr_hugepages

# 永久配置
echo "vm.nr_hugepages = 1024" >> /etc/sysctl.conf
```

---

## 8. 🚄 半虚拟化驱动安装


### 8.1 什么是半虚拟化驱动


**半虚拟化驱动（virtio）**就像给虚拟机装上"专用跑道"，让数据传输更快更高效。

```
性能对比：
全虚拟化：虚拟机 → 模拟硬件 → 宿主机 （慢）
半虚拟化：虚拟机 → virtio驱动 → 宿主机 （快）
```

**💡 virtio的优势**：
- **网络性能**：提升网络吞吐量50-80%
- **磁盘性能**：提升磁盘I/O性能30-50%  
- **CPU开销**：减少CPU虚拟化开销
- **延迟降低**：减少网络和磁盘延迟

### 8.2 virtio设备类型


**📊 virtio设备对比**：

| 设备类型 | **作用** | **性能提升** |
|---------|---------|-------------|
| **virtio-net** | 网络设备 | 网络性能大幅提升 |
| **virtio-blk** | 块设备 | 磁盘I/O性能提升 |
| **virtio-scsi** | SCSI设备 | 支持更多磁盘特性 |
| **virtio-balloon** | 内存气球 | 动态内存管理 |
| **virtio-rng** | 随机数生成器 | 提供熵源 |

### 8.3 在virt-install中配置virtio


**🔧 创建时配置virtio**：
```bash
virt-install \
  --name virtio-vm \
  --memory 2048 \
  --vcpus 2 \
  --disk size=20,bus=virtio,cache=writeback \
  --network network=default,model=virtio \
  --cdrom /path/to/os.iso \
  --graphics vnc \
  --rng /dev/urandom \
  --memballoon virtio
```

**💡 参数说明**：
- `bus=virtio`：磁盘使用virtio驱动
- `model=virtio`：网卡使用virtio驱动
- `--rng /dev/urandom`：虚拟随机数生成器
- `--memballoon virtio`：内存气球设备

### 8.4 Linux系统virtio驱动安装


**🐧 现代Linux发行版**：
大部分现代Linux发行版（CentOS 7+、Ubuntu 16.04+）已经内置virtio驱动，安装时自动启用。

**🔍 检查virtio驱动状态**：
```bash
# 检查virtio模块是否加载
lsmod | grep virtio

# 查看virtio设备
ls /sys/bus/virtio/devices/

# 查看网络设备
ip link show
```

**📝 手动安装virtio驱动**：
```bash
# CentOS/RHEL系统
yum groupinstall -y "Development Tools"
yum install -y kernel-devel

# Ubuntu/Debian系统  
apt-get update
apt-get install -y build-essential linux-headers-$(uname -r)
```

### 8.5 Windows系统virtio驱动安装


**Windows虚拟机**需要单独安装virtio驱动程序。

**🔧 Windows virtio驱动获取**：
```bash
# 下载Windows virtio驱动ISO
wget https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso

# 创建Windows虚拟机时挂载驱动盘
virt-install \
  --name windows-vm \
  --memory 4096 \
  --vcpus 2 \
  --disk size=40,bus=virtio \
  --network model=virtio \
  --cdrom /path/to/windows.iso \
  --disk /path/to/virtio-win.iso,device=cdrom \
  --graphics vnc
```

**📋 Windows驱动安装步骤**：
1. **安装过程中**：选择"加载驱动程序"
2. **浏览驱动盘**：选择对应系统版本的驱动
3. **安装存储驱动**：先安装virtio-blk驱动
4. **系统启动后**：安装网络和其他设备驱动

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 虚拟化原理：KVM+QEMU+libvirt协同工作
🔸 virt-install：命令行虚拟机创建工具
🔸 安装方式：ISO、PXE、HTTP三种主要方式
🔸 硬件配置：CPU、内存、磁盘、网络的合理配置
🔸 启动模式：BIOS和UEFI的区别和选择
🔸 virtio驱动：半虚拟化驱动的重要性
```

### 9.2 关键理解要点


**🔹 为什么需要虚拟化**：
- **资源利用率**：一台物理机运行多个系统
- **环境隔离**：不同系统互不影响
- **快速部署**：几分钟创建新系统
- **成本节约**：减少硬件采购成本

**🔹 虚拟机配置的平衡点**：
- **性能 vs 资源**：分配足够资源但不浪费
- **兼容性 vs 性能**：新特性与旧系统兼容
- **安全性 vs 便利性**：安全配置与易用性平衡

**🔹 virtio的重要性**：
```
没有virtio：虚拟机性能只有物理机的50-70%
使用virtio：虚拟机性能可达物理机的85-95%
```

### 9.3 实际应用场景


**🎯 典型应用场景**：

| 场景 | **配置建议** | **注意事项** |
|-----|-------------|-------------|
| **开发测试** | 2-4GB内存，virtio驱动 | 快照功能，快速恢复 |
| **Web服务器** | 4-8GB内存，bridge网络 | 网络性能，负载均衡 |
| **数据库服务器** | 8GB+内存，多磁盘 | I/O性能，数据备份 |
| **虚拟桌面** | 4GB+内存，GPU直通 | 图形性能，用户体验 |

### 9.4 常见问题和解决方案


**❗ 安装失败常见原因**：
- **硬件虚拟化未启用**：检查CPU虚拟化支持
- **内存不足**：至少512MB，推荐2GB+
- **存储空间不足**：确保足够磁盘空间
- **网络配置错误**：检查网络连接和防火墙

**🔧 性能优化检查清单**：
- ☑ **启用virtio驱动**：所有设备使用virtio
- ☑ **合理分配CPU**：不超过物理CPU核心数
- ☑ **充足内存配置**：避免内存交换
- ☑ **网络模式选择**：根据需求选择bridge或NAT
- ☑ **时间同步配置**：避免时间漂移问题

### 9.5 最佳实践建议


**📝 虚拟机创建最佳实践**：
1. **规划先行**：先确定用途再配置硬件
2. **逐步调优**：先基础配置，再根据需求调整
3. **监控性能**：定期检查资源使用情况
4. **备份策略**：重要虚拟机定期备份
5. **文档记录**：记录配置参数便于维护

**⚠️ 安全注意事项**：
- **网络隔离**：生产环境使用独立网络
- **权限控制**：限制虚拟机管理权限
- **定期更新**：保持系统和驱动程序更新
- **监控审计**：记录虚拟机操作日志

**核心记忆口诀**：
```
虚拟机安装有三招：ISO光盘最常见，
PXE网络批量装，HTTP在线更方便。
CPU内存要合理，virtio驱动性能好，
UEFI启动支持大盘，时间同步不能忘。
```