---
title: 11ã€KVMå®‰å…¨é…ç½®
---
## ğŸ“š ç›®å½•

1. [è™šæ‹ŸåŒ–å®‰å…¨åŸºç¡€æ¦‚å¿µ](#1-è™šæ‹ŸåŒ–å®‰å…¨åŸºç¡€æ¦‚å¿µ)
2. [è™šæ‹Ÿæœºå®‰å…¨éš”ç¦»æœºåˆ¶](#2-è™šæ‹Ÿæœºå®‰å…¨éš”ç¦»æœºåˆ¶)
3. [SELinuxè™šæ‹ŸåŒ–å®‰å…¨ç­–ç•¥](#3-selinuxè™šæ‹ŸåŒ–å®‰å…¨ç­–ç•¥)
4. [AppArmorè™šæ‹ŸåŒ–å®‰å…¨é…ç½®](#4-apparmorè™šæ‹ŸåŒ–å®‰å…¨é…ç½®)
5. [è™šæ‹Ÿæœºæƒé™æœ€å°åŒ–é…ç½®](#5-è™šæ‹Ÿæœºæƒé™æœ€å°åŒ–é…ç½®)
6. [è™šæ‹Ÿç£ç›˜åŠ å¯†é…ç½®](#6-è™šæ‹Ÿç£ç›˜åŠ å¯†é…ç½®)
7. [è™šæ‹Ÿæœºç½‘ç»œå®‰å…¨é…ç½®](#7-è™šæ‹Ÿæœºç½‘ç»œå®‰å…¨é…ç½®)
8. [è™šæ‹Ÿæœºé€ƒé€¸é˜²æŠ¤æªæ–½](#8-è™šæ‹Ÿæœºé€ƒé€¸é˜²æŠ¤æªæ–½)
9. [libvirtç”¨æˆ·æƒé™ç®¡ç†](#9-libvirtç”¨æˆ·æƒé™ç®¡ç†)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” è™šæ‹ŸåŒ–å®‰å…¨åŸºç¡€æ¦‚å¿µ


### 1.1 è™šæ‹ŸåŒ–å®‰å…¨çš„æ ¸å¿ƒç†å¿µ


**ä»€ä¹ˆæ˜¯è™šæ‹ŸåŒ–å®‰å…¨**ï¼š
è™šæ‹ŸåŒ–å®‰å…¨å°±æ˜¯ç¡®ä¿è™šæ‹Ÿæœºç¯å¢ƒä¸­çš„å„ç§å®‰å…¨é˜²æŠ¤æªæ–½ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯è®©è™šæ‹Ÿæœºå’Œå®¿ä¸»æœºéƒ½èƒ½å®‰å…¨è¿è¡Œï¼Œäº’ä¸å¹²æ‰°ï¼Œé˜²æ­¢æ¶æ„æ”»å‡»ã€‚

```
ä¼ ç»Ÿç‰©ç†æœåŠ¡å™¨å®‰å…¨ï¼š
ç¡¬ä»¶ â†’ æ“ä½œç³»ç»Ÿ â†’ åº”ç”¨ç¨‹åº
      â†‘
    å®‰å…¨è¾¹ç•Œ

è™šæ‹ŸåŒ–ç¯å¢ƒå®‰å…¨ï¼š
ç¡¬ä»¶ â†’ Hypervisor â†’ è™šæ‹Ÿæœº â†’ åº”ç”¨ç¨‹åº
      â†‘           â†‘
    å®‰å…¨è¾¹ç•Œ    å®‰å…¨è¾¹ç•Œ
```

### 1.2 è™šæ‹ŸåŒ–å®‰å…¨å¨èƒç±»å‹


**ğŸ”¸ ä¸»è¦å®‰å…¨å¨èƒ**

| å¨èƒç±»å‹ | **å¨èƒæè¿°** | **å½±å“èŒƒå›´** | **é£é™©ç­‰çº§** |
|---------|-------------|-------------|-------------|
| ğŸšª **è™šæ‹Ÿæœºé€ƒé€¸** | `è™šæ‹Ÿæœºçªç ´éš”ç¦»è®¿é—®å®¿ä¸»æœº` | `æ•´ä¸ªå®¿ä¸»æœº` | `ğŸ”´ æé«˜` |
| ğŸ•µï¸ **è™šæ‹Ÿæœºçª¥æ¢** | `è™šæ‹Ÿæœºé—´äº’ç›¸ç›‘å¬æ•°æ®` | `å…¶ä»–è™šæ‹Ÿæœº` | `ğŸŸ¡ ä¸­ç­‰` |
| ğŸ’¾ **èµ„æºæ»¥ç”¨** | `æ¶æ„è™šæ‹Ÿæœºæ¶ˆè€—è¿‡å¤šèµ„æº` | `åŒä¸»æœºè™šæ‹Ÿæœº` | `ğŸŸ¡ ä¸­ç­‰` |
| ğŸŒ **ç½‘ç»œæ”»å‡»** | `é€šè¿‡è™šæ‹Ÿç½‘ç»œè¿›è¡Œæ”»å‡»` | `è™šæ‹Ÿç½‘ç»œæ®µ` | `ğŸŸ  è¾ƒé«˜` |

### 1.3 KVMå®‰å…¨æ¶æ„


**KVMä¸‰å±‚å®‰å…¨é˜²æŠ¤**ï¼š

```
ç”¨æˆ·ç©ºé—´åº”ç”¨
    â†“ (ç³»ç»Ÿè°ƒç”¨)
å†…æ ¸ç©ºé—´ KVM æ¨¡å—
    â†“ (ç¡¬ä»¶æ‰©å±•)
ç¡¬ä»¶è™šæ‹ŸåŒ–æ”¯æŒ

å®‰å…¨è¾¹ç•Œï¼š
ğŸ”¸ ç”¨æˆ·æ€ QEMU è¿›ç¨‹éš”ç¦»
ğŸ”¸ å†…æ ¸æ€ KVM æ¨¡å—ä¿æŠ¤  
ğŸ”¸ ç¡¬ä»¶çº§åˆ«è™šæ‹ŸåŒ–éš”ç¦»
```

> ğŸ’¡ **æ ¸å¿ƒç†è§£**ï¼šKVMé‡‡ç”¨å¤šå±‚é˜²æŠ¤ï¼Œæ¯ä¸€å±‚éƒ½æœ‰ç‹¬ç«‹çš„å®‰å…¨æœºåˆ¶ï¼Œè¿™æ ·å³ä½¿æŸä¸€å±‚è¢«çªç ´ï¼Œå…¶ä»–å±‚è¿˜èƒ½æä¾›ä¿æŠ¤ã€‚

---

## 2. ğŸ›¡ï¸ è™šæ‹Ÿæœºå®‰å…¨éš”ç¦»æœºåˆ¶


### 2.1 è¿›ç¨‹çº§éš”ç¦»


**æ¯ä¸ªè™šæ‹Ÿæœºå°±æ˜¯ä¸€ä¸ªQEMUè¿›ç¨‹**ï¼š

```bash
# æŸ¥çœ‹è™šæ‹Ÿæœºå¯¹åº”çš„è¿›ç¨‹
ps aux | grep qemu
# è¾“å‡ºç¤ºä¾‹ï¼š
# qemu    1234  ... qemu-kvm -name vm1 ...
# qemu    5678  ... qemu-kvm -name vm2 ...
```

**ğŸ”¸ è¿›ç¨‹éš”ç¦»çš„å¥½å¤„**ï¼š
- æ¯ä¸ªè™šæ‹Ÿæœºæœ‰ç‹¬ç«‹çš„è¿›ç¨‹ID
- æ“ä½œç³»ç»Ÿè‡ªåŠ¨æä¾›è¿›ç¨‹é—´éš”ç¦»
- ä¸€ä¸ªè™šæ‹Ÿæœºå´©æºƒä¸å½±å“å…¶ä»–è™šæ‹Ÿæœº
- å¯ä»¥ä¸ºæ¯ä¸ªè¿›ç¨‹è®¾ç½®ä¸åŒçš„æƒé™

### 2.2 å†…å­˜éš”ç¦»é…ç½®


**é…ç½®è™šæ‹Ÿæœºå†…å­˜éš”ç¦»**ï¼š

```xml
<!-- è™šæ‹ŸæœºXMLé…ç½®ä¸­çš„å†…å­˜è®¾ç½® -->
<domain type='kvm'>
  <memory unit='KiB'>2097152</memory>
  <currentMemory unit='KiB'>2097152</currentMemory>
  
  <!-- å†…å­˜å®‰å…¨é…ç½® -->
  <memoryBacking>
    <locked/>              <!-- é”å®šå†…å­˜ï¼Œé˜²æ­¢äº¤æ¢åˆ°ç£ç›˜ -->
    <nosharepages/>        <!-- ç¦ç”¨å†…å­˜é¡µå…±äº« -->
  </memoryBacking>
</domain>
```

> âš ï¸ **æ³¨æ„**ï¼šç¦ç”¨å†…å­˜é¡µå…±äº«ä¼šå¢åŠ å†…å­˜ä½¿ç”¨é‡ï¼Œä½†æé«˜äº†å®‰å…¨æ€§ã€‚

### 2.3 CPUéš”ç¦»é…ç½®


**CPUèµ„æºéš”ç¦»**ï¼š

```xml
<!-- CPUéš”ç¦»é…ç½® -->
<domain type='kvm'>
  <vcpu placement='static' cpuset='2-3'>2</vcpu>
  
  <!-- CPUåŠŸèƒ½é™åˆ¶ -->
  <cpu mode='host-model' check='partial'>
    <feature policy='disable' name='hypervisor'/>
    <feature policy='disable' name='x2apic'/>
  </cpu>
</domain>
```

**ğŸ”¸ é…ç½®è¯´æ˜**ï¼š
- `cpuset='2-3'`ï¼šé™åˆ¶è™šæ‹Ÿæœºåªèƒ½ä½¿ç”¨CPUæ ¸å¿ƒ2å’Œ3
- `feature policy='disable'`ï¼šç¦ç”¨æŸäº›CPUç‰¹æ€§ï¼Œå‡å°‘æ”»å‡»é¢

### 2.4 æ–‡ä»¶ç³»ç»Ÿéš”ç¦»


**è™šæ‹Ÿæœºæ–‡ä»¶ç³»ç»Ÿæƒé™**ï¼š

```bash
# è®¾ç½®è™šæ‹Ÿæœºç£ç›˜æ–‡ä»¶æƒé™
chown qemu:qemu /var/lib/libvirt/images/vm1.qcow2
chmod 600 /var/lib/libvirt/images/vm1.qcow2

# è®¾ç½®ç›®å½•æƒé™
chmod 711 /var/lib/libvirt/images
```

**ğŸ”¸ æƒé™è¯´æ˜**ï¼š
- `600`ï¼šåªæœ‰æ‰€æœ‰è€…å¯ä»¥è¯»å†™ï¼Œå…¶ä»–äººæ— æƒé™
- `711`ï¼šç›®å½•æ‰€æœ‰è€…å¯ä»¥è¿›å…¥ï¼Œå…¶ä»–äººåªèƒ½æ‰§è¡Œï¼ˆæ— æ³•åˆ—å‡ºæ–‡ä»¶ï¼‰

---

## 3. ğŸ”’ SELinuxè™šæ‹ŸåŒ–å®‰å…¨ç­–ç•¥


### 3.1 SELinuxè™šæ‹ŸåŒ–å®‰å…¨æ¨¡å‹


**SELinuxå¦‚ä½•ä¿æŠ¤è™šæ‹ŸåŒ–**ï¼š

```
ä¼ ç»Ÿæƒé™æ§åˆ¶ï¼š
ç”¨æˆ· â†’ æ–‡ä»¶æƒé™ â†’ è®¿é—®æ§åˆ¶

SELinuxå¢å¼ºæ§åˆ¶ï¼š
è¿›ç¨‹(ä¸Šä¸‹æ–‡) â†’ æ–‡ä»¶(æ ‡ç­¾) â†’ å¼ºåˆ¶è®¿é—®æ§åˆ¶
```

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šä¼ ç»Ÿæƒé™åƒé—¨é”ï¼ŒSELinuxåƒä¿å®‰ï¼Œä¸ä»…è¦æœ‰é’¥åŒ™ï¼Œè¿˜è¦ä¿å®‰ç¡®è®¤ä½ çš„èº«ä»½å’Œè®¿é—®ç›®çš„ã€‚

### 3.2 æŸ¥çœ‹SELinuxè™šæ‹ŸåŒ–ç­–ç•¥


**æ£€æŸ¥SELinuxè™šæ‹ŸåŒ–æ”¯æŒ**ï¼š

```bash
# æŸ¥çœ‹SELinuxçŠ¶æ€
getenforce
# è¾“å‡ºï¼šEnforcingï¼ˆå¼ºåˆ¶æ¨¡å¼ï¼‰

# æŸ¥çœ‹è™šæ‹ŸåŒ–ç›¸å…³çš„SELinuxç­–ç•¥
getsebool -a | grep virt
# è¾“å‡ºç¤ºä¾‹ï¼š
# virt_use_nfs --> off
# virt_use_samba --> off
# virt_use_usb --> on
```

### 3.3 é…ç½®è™šæ‹ŸæœºSELinuxä¸Šä¸‹æ–‡


**è®¾ç½®è™šæ‹Ÿæœºè¿›ç¨‹ä¸Šä¸‹æ–‡**ï¼š

```xml
<!-- åœ¨è™šæ‹ŸæœºXMLä¸­é…ç½®SELinux -->
<domain type='kvm'>
  <seclabel type='dynamic' model='selinux' relabel='yes'>
    <label>system_u:system_r:svirt_t:s0:c123,c456</label>
  </seclabel>
</domain>
```

**æŸ¥çœ‹è¿è¡Œä¸­è™šæ‹Ÿæœºçš„SELinuxä¸Šä¸‹æ–‡**ï¼š

```bash
# æŸ¥çœ‹QEMUè¿›ç¨‹çš„SELinuxä¸Šä¸‹æ–‡
ps -eZ | grep qemu
# è¾“å‡ºï¼šsystem_u:system_r:svirt_t:s0:c123,c456 qemu-kvm
```

### 3.4 SELinuxè™šæ‹ŸåŒ–å¸ƒå°”å€¼é…ç½®


**å¸¸ç”¨è™šæ‹ŸåŒ–SELinuxå¸ƒå°”å€¼**ï¼š

```bash
# å…è®¸è™šæ‹Ÿæœºä½¿ç”¨NFSå­˜å‚¨
setsebool -P virt_use_nfs on

# å…è®¸è™šæ‹Ÿæœºä½¿ç”¨Sambaå­˜å‚¨
setsebool -P virt_use_samba on

# å…è®¸è™šæ‹Ÿæœºä½¿ç”¨USBè®¾å¤‡
setsebool -P virt_use_usb on

# å…è®¸è™šæ‹Ÿæœºæ‰§è¡Œå†…å­˜ç›¸å…³æ“ä½œ
setsebool -P virt_use_execmem on
```

> ğŸ”¥ **é‡ç‚¹**ï¼š`-P`å‚æ•°è¡¨ç¤ºæ°¸ä¹…è®¾ç½®ï¼Œé‡å¯åä»ç„¶æœ‰æ•ˆã€‚

---

## 4. ğŸ›¡ï¸ AppArmorè™šæ‹ŸåŒ–å®‰å…¨é…ç½®


### 4.1 AppArmorè™šæ‹ŸåŒ–é˜²æŠ¤æœºåˆ¶


**AppArmorä¸SELinuxçš„åŒºåˆ«**ï¼š

| ç‰¹æ€§ | **SELinux** | **AppArmor** |
|------|-------------|-------------|
| ğŸ¯ **ç­–ç•¥åŸºç¡€** | `åŸºäºæ ‡ç­¾çš„å¼ºåˆ¶è®¿é—®æ§åˆ¶` | `åŸºäºè·¯å¾„çš„è®¿é—®æ§åˆ¶` |
| ğŸ“ **é…ç½®å¤æ‚åº¦** | `è¾ƒå¤æ‚ï¼ŒåŠŸèƒ½å¼ºå¤§` | `ç›¸å¯¹ç®€å•ï¼Œæ˜“äºç†è§£` |
| ğŸ”§ **é…ç½®æ–¹å¼** | `ä¸Šä¸‹æ–‡å’Œç­–ç•¥è§„åˆ™` | `é…ç½®æ–‡ä»¶å’Œè·¯å¾„è§„åˆ™` |
| ğŸŒ **é€‚ç”¨ç³»ç»Ÿ** | `Red Hatç³»åˆ—` | `Debian/Ubuntuç³»åˆ—` |

### 4.2 æŸ¥çœ‹AppArmorè™šæ‹ŸåŒ–é…ç½®


**æ£€æŸ¥AppArmorè™šæ‹ŸåŒ–ç­–ç•¥**ï¼š

```bash
# æŸ¥çœ‹AppArmorçŠ¶æ€
apparmor_status

# æŸ¥çœ‹è™šæ‹ŸåŒ–ç›¸å…³çš„AppArmoré…ç½®æ–‡ä»¶
ls /etc/apparmor.d/ | grep libvirt
# è¾“å‡ºï¼š
# usr.sbin.libvirtd
# usr.lib.libvirt.virt-aa-helper
```

### 4.3 é…ç½®è™šæ‹ŸæœºAppArmorç­–ç•¥


**è™šæ‹ŸæœºAppArmoré…ç½®ç¤ºä¾‹**ï¼š

```bash
# ç¼–è¾‘libvirtçš„AppArmoré…ç½®
sudo nano /etc/apparmor.d/usr.sbin.libvirtd

# æ·»åŠ è™šæ‹Ÿæœºç‰¹å®šè·¯å¾„æƒé™
/var/lib/libvirt/images/** rwk,
/var/lib/libvirt/qemu/** rw,
/run/libvirt/qemu/** rw,
```

**é‡æ–°åŠ è½½AppArmorç­–ç•¥**ï¼š

```bash
# é‡æ–°åŠ è½½é…ç½®
sudo apparmor_parser -r /etc/apparmor.d/usr.sbin.libvirtd

# æ£€æŸ¥ç­–ç•¥æ˜¯å¦ç”Ÿæ•ˆ
sudo aa-status | grep libvirt
```

### 4.4 è™šæ‹ŸæœºAppArmoréš”ç¦»


**ä¸ºç‰¹å®šè™šæ‹Ÿæœºåˆ›å»ºAppArmoré…ç½®æ–‡ä»¶**ï¼š

```bash
# åˆ›å»ºè™šæ‹Ÿæœºä¸“ç”¨çš„AppArmoré…ç½®
sudo nano /etc/apparmor.d/libvirt-qemu-vm1

# é…ç½®å†…å®¹
/usr/bin/qemu-system-x86_64 {
  capability dac_override,
  capability sys_resource,
  
  /var/lib/libvirt/images/vm1.qcow2 rw,
  /var/lib/libvirt/qemu/vm1.xml r,
  
  # æ‹’ç»è®¿é—®å…¶ä»–è™šæ‹Ÿæœºæ–‡ä»¶
  deny /var/lib/libvirt/images/vm2.qcow2 rwmx,
}
```

---

## 5. âš–ï¸ è™šæ‹Ÿæœºæƒé™æœ€å°åŒ–é…ç½®


### 5.1 ç”¨æˆ·æƒé™æœ€å°åŒ–


**åˆ›å»ºä¸“ç”¨çš„è™šæ‹Ÿæœºç”¨æˆ·**ï¼š

```bash
# åˆ›å»ºè™šæ‹Ÿæœºä¸“ç”¨ç”¨æˆ·ç»„
groupadd vmuser

# åˆ›å»ºè™šæ‹Ÿæœºç”¨æˆ·
useradd -g vmuser -s /sbin/nologin -d /var/lib/libvirt vmqemu

# è®¾ç½®ç”¨æˆ·æƒé™
usermod -G kvm,libvirt vmqemu
```

**é…ç½®libvirtä½¿ç”¨ä¸“ç”¨ç”¨æˆ·**ï¼š

```bash
# ç¼–è¾‘libvirté…ç½®
sudo nano /etc/libvirt/qemu.conf

# è®¾ç½®è¿è¡Œç”¨æˆ·å’Œç»„
user = "vmqemu"
group = "vmuser"

# é‡å¯libvirtæœåŠ¡
systemctl restart libvirtd
```

### 5.2 æ–‡ä»¶ç³»ç»Ÿæƒé™æœ€å°åŒ–


**è™šæ‹Ÿæœºæ–‡ä»¶æƒé™é…ç½®**ï¼š

```bash
# è™šæ‹Ÿæœºé•œåƒæ–‡ä»¶æƒé™
chmod 640 /var/lib/libvirt/images/*.qcow2
chown vmqemu:vmuser /var/lib/libvirt/images/*.qcow2

# è™šæ‹Ÿæœºé…ç½®æ–‡ä»¶æƒé™
chmod 600 /etc/libvirt/qemu/*.xml
chown root:root /etc/libvirt/qemu/*.xml

# è¿è¡Œæ—¶æ–‡ä»¶æƒé™
chmod 755 /var/run/libvirt/qemu/
chown vmqemu:vmuser /var/run/libvirt/qemu/
```

### 5.3 ç½‘ç»œæƒé™æœ€å°åŒ–


**è™šæ‹Ÿæœºç½‘ç»œæƒé™é…ç½®**ï¼š

```xml
<!-- é™åˆ¶è™šæ‹Ÿæœºç½‘ç»œæƒé™ -->
<domain type='kvm'>
  <interface type='bridge'>
    <source bridge='br0'/>
    <filterref filter='clean-traffic'>
      <parameter name='IP' value='192.168.1.100'/>
    </filterref>
  </interface>
</domain>
```

**åˆ›å»ºç½‘ç»œè¿‡æ»¤è§„åˆ™**ï¼š

```bash
# åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œè¿‡æ»¤å™¨
cat > /tmp/vm-filter.xml << EOF
<filter name='vm-restricted' chain='ipv4'>
  <rule action='accept' direction='out' priority='100'>
    <tcp dstportstart='80' dstportend='80'/>
  </rule>
  <rule action='accept' direction='out' priority='100'>
    <tcp dstportstart='443' dstportend='443'/>
  </rule>
  <rule action='drop' direction='out' priority='1000'/>
</filter>
EOF

# åº”ç”¨è¿‡æ»¤å™¨
virsh nwfilter-define /tmp/vm-filter.xml
```

---

## 6. ğŸ” è™šæ‹Ÿç£ç›˜åŠ å¯†é…ç½®


### 6.1 LUKSç£ç›˜åŠ å¯†


**ä»€ä¹ˆæ˜¯LUKSç£ç›˜åŠ å¯†**ï¼š
LUKSå°±åƒç»™ç¡¬ç›˜åŠ äº†ä¸€ä¸ªå¯†ç é”ï¼Œæ²¡æœ‰å¯†ç å°±æ— æ³•è¯»å–ç¡¬ç›˜å†…å®¹ã€‚å³ä½¿æœ‰äººæ‹¿åˆ°äº†è™šæ‹Ÿæœºçš„ç£ç›˜æ–‡ä»¶ï¼Œæ²¡æœ‰å¯†ç ä¹Ÿçœ‹ä¸åˆ°é‡Œé¢çš„æ•°æ®ã€‚

**åˆ›å»ºåŠ å¯†çš„è™šæ‹Ÿç£ç›˜**ï¼š

```bash
# åˆ›å»ºåŠ å¯†ç£ç›˜é•œåƒ
qemu-img create -f qcow2 \
  --object secret,id=sec0,data=$(echo -n "mypassword" | base64) \
  -o encrypt.format=luks,encrypt.key-secret=sec0 \
  /var/lib/libvirt/images/encrypted-vm.qcow2 20G
```

### 6.2 é…ç½®è™šæ‹Ÿæœºä½¿ç”¨åŠ å¯†ç£ç›˜


**è™šæ‹ŸæœºXMLé…ç½®**ï¼š

```xml
<domain type='kvm'>
  <devices>
    <disk type='file' device='disk'>
      <driver name='qemu' type='qcow2'/>
      <source file='/var/lib/libvirt/images/encrypted-vm.qcow2'/>
      <encryption format='luks'>
        <secret type='passphrase' uuid='12345678-1234-1234-1234-123456789012'/>
      </encryption>
      <target dev='vda' bus='virtio'/>
    </disk>
  </devices>
</domain>
```

### 6.3 ç®¡ç†åŠ å¯†å¯†é’¥


**åˆ›å»ºå¯†é’¥æ–‡ä»¶**ï¼š

```bash
# åˆ›å»ºå¯†é’¥æ–‡ä»¶
echo "mypassword" > /etc/libvirt/secrets/vm-key.txt
chmod 600 /etc/libvirt/secrets/vm-key.txt

# åœ¨libvirtä¸­å®šä¹‰å¯†é’¥
cat > /tmp/secret.xml << EOF
<secret ephemeral='no' private='yes'>
  <uuid>12345678-1234-1234-1234-123456789012</uuid>
  <description>VM disk encryption key</description>
</secret>
EOF

virsh secret-define /tmp/secret.xml
virsh secret-set-value 12345678-1234-1234-1234-123456789012 \
  $(cat /etc/libvirt/secrets/vm-key.txt | base64 -w 0)
```

### 6.4 åŠ å¯†ä¼ è¾“é…ç½®


**é…ç½®è™šæ‹ŸæœºVNCåŠ å¯†**ï¼š

```xml
<!-- VNCåŠ å¯†é…ç½® -->
<domain type='kvm'>
  <devices>
    <graphics type='vnc' port='-1' autoport='yes' listen='0.0.0.0'>
      <listen type='address' address='0.0.0.0'/>
      <tls port='5901'/>
    </graphics>
  </devices>
</domain>
```

---

## 7. ğŸŒ è™šæ‹Ÿæœºç½‘ç»œå®‰å…¨é…ç½®


### 7.1 è™šæ‹Ÿç½‘ç»œéš”ç¦»


**åˆ›å»ºéš”ç¦»çš„è™šæ‹Ÿç½‘ç»œ**ï¼š

```xml
<!-- åˆ›å»ºéš”ç¦»ç½‘ç»œé…ç½® -->
<network>
  <name>isolated-net</name>
  <bridge name='virbr1' stp='on' delay='0'/>
  <ip address='192.168.100.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.100.10' end='192.168.100.100'/>
    </dhcp>
  </ip>
</network>
```

```bash
# å®šä¹‰å¹¶å¯åŠ¨éš”ç¦»ç½‘ç»œ
virsh net-define /tmp/isolated-net.xml
virsh net-start isolated-net
virsh net-autostart isolated-net
```

### 7.2 ç½‘ç»œè®¿é—®æ§åˆ¶


**é…ç½®é˜²ç«å¢™è§„åˆ™**ï¼š

```bash
# åˆ›å»ºè™šæ‹Ÿæœºç½‘ç»œé˜²ç«å¢™è§„åˆ™
iptables -t filter -A FORWARD -i virbr1 -o virbr1 -j ACCEPT
iptables -t filter -A FORWARD -i virbr1 -j DROP
iptables -t filter -A FORWARD -o virbr1 -j DROP

# ä¿å­˜é˜²ç«å¢™è§„åˆ™
iptables-save > /etc/iptables/rules.v4
```

### 7.3 è™šæ‹ŸæœºMACåœ°å€ç®¡ç†


**å›ºå®šè™šæ‹ŸæœºMACåœ°å€**ï¼š

```xml
<!-- è™šæ‹Ÿæœºç½‘ç»œé…ç½® -->
<domain type='kvm'>
  <devices>
    <interface type='bridge'>
      <mac address='52:54:00:12:34:56'/>
      <source bridge='br0'/>
      <model type='virtio'/>
    </interface>
  </devices>
</domain>
```

> ğŸ’¡ **å®‰å…¨è€ƒè™‘**ï¼šå›ºå®šMACåœ°å€ä¾¿äºç½‘ç»œç›‘æ§å’Œè®¿é—®æ§åˆ¶ï¼Œé˜²æ­¢è™šæ‹Ÿæœºéšæ„æ›´æ”¹ç½‘ç»œèº«ä»½ã€‚

### 7.4 ç½‘ç»œç›‘æ§é…ç½®


**é…ç½®ç½‘ç»œæµé‡ç›‘æ§**ï¼š

```bash
# å®‰è£…ç½‘ç»œç›‘æ§å·¥å…·
apt install iftop nethogs

# ç›‘æ§è™šæ‹Ÿç½‘æ¡¥æµé‡
iftop -i virbr0

# ç›‘æ§ç‰¹å®šè™šæ‹Ÿæœºç½‘ç»œä½¿ç”¨
nethogs -d 1 virbr0
```

---

## 8. ğŸš« è™šæ‹Ÿæœºé€ƒé€¸é˜²æŠ¤æªæ–½


### 8.1 ä»€ä¹ˆæ˜¯è™šæ‹Ÿæœºé€ƒé€¸


**è™šæ‹Ÿæœºé€ƒé€¸çš„å«ä¹‰**ï¼š
è™šæ‹Ÿæœºé€ƒé€¸å°±åƒå›šçŠ¯è¶Šç‹±ä¸€æ ·ï¼Œè™šæ‹Ÿæœºçªç ´äº†è™šæ‹ŸåŒ–çš„"å›´å¢™"ï¼Œè·å¾—äº†å®¿ä¸»æœºçš„è®¿é—®æƒé™ã€‚è¿™æ˜¯è™šæ‹ŸåŒ–ç¯å¢ƒä¸­æœ€ä¸¥é‡çš„å®‰å…¨å¨èƒã€‚

```
æ­£å¸¸æƒ…å†µï¼š
è™šæ‹Ÿæœº â†’ è™šæ‹ŸåŒ–å±‚ â†’ å®¿ä¸»æœº
        â†‘
      å®‰å…¨è¾¹ç•Œ

é€ƒé€¸æ”»å‡»ï¼š
è™šæ‹Ÿæœº â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â†’ å®¿ä¸»æœº
     (ç»•è¿‡è™šæ‹ŸåŒ–å±‚)
```

### 8.2 Hypervisorå®‰å…¨åŠ å›º


**KVMå†…æ ¸æ¨¡å—å®‰å…¨é…ç½®**ï¼š

```bash
# æ£€æŸ¥KVMå†…æ ¸æ¨¡å—
lsmod | grep kvm
# è¾“å‡ºï¼š
# kvm_intel    245760  0
# kvm          667648  1 kvm_intel

# æ£€æŸ¥KVMå®‰å…¨ç‰¹æ€§
cat /sys/module/kvm/parameters/ignore_msrs
# è¾“å‡ºï¼šNï¼ˆæ¨èè®¾ç½®ï¼Œæ‹’ç»æœªçŸ¥MSRè®¿é—®ï¼‰

# æ£€æŸ¥ç¡¬ä»¶è™šæ‹ŸåŒ–æ”¯æŒ
cat /proc/cpuinfo | grep -E '(vmx|svm)'
```

### 8.3 QEMUå®‰å…¨é…ç½®


**QEMUè¿›ç¨‹å®‰å…¨é™åˆ¶**ï¼š

```bash
# ç¼–è¾‘libvirté…ç½®
sudo nano /etc/libvirt/qemu.conf

# å®‰å…¨é…ç½®é¡¹
security_driver = "selinux"
security_default_confined = 1
security_require_confined = 1

# ç”¨æˆ·æƒé™é…ç½®
user = "qemu"
group = "qemu"
dynamic_ownership = 1

# å†…å­˜å®‰å…¨é…ç½®
memory_backing_dir = "/var/lib/libvirt/qemu/ram"
```

### 8.4 è®¾å¤‡ç›´é€šå®‰å…¨


**é™åˆ¶è®¾å¤‡ç›´é€š**ï¼š

```xml
<!-- å®‰å…¨çš„è®¾å¤‡ç›´é€šé…ç½® -->
<domain type='kvm'>
  <devices>
    <!-- USBè®¾å¤‡è¿‡æ»¤ -->
    <redirdev bus='usb' type='spicevmc'>
      <usbdev class='09' vendor='0x1234' product='0x5678'/>
    </redirdev>
    
    <!-- PCIè®¾å¤‡éš”ç¦» -->
    <hostdev mode='subsystem' type='pci' managed='yes'>
      <source>
        <address domain='0x0000' bus='0x02' slot='0x00' function='0x0'/>
      </source>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>
    </hostdev>
  </devices>
</domain>
```

### 8.5 å†…æ ¸é˜²æŠ¤æªæ–½


**å¯ç”¨å†…æ ¸é˜²æŠ¤åŠŸèƒ½**ï¼š

```bash
# æ£€æŸ¥å†…æ ¸é˜²æŠ¤åŠŸèƒ½
grep -E '(SMEP|SMAP|KPTI)' /proc/cpuinfo

# æ£€æŸ¥åœ°å€ç©ºé—´éšæœºåŒ–
cat /proc/sys/kernel/randomize_va_space
# è¾“å‡ºï¼š2ï¼ˆå®Œå…¨éšæœºåŒ–ï¼Œæ¨èè®¾ç½®ï¼‰

# æ£€æŸ¥å†…æ ¸æŒ‡é’ˆä¿æŠ¤
cat /proc/sys/kernel/kptr_restrict
# è¾“å‡ºï¼š2ï¼ˆå®Œå…¨é™åˆ¶ï¼Œæ¨èè®¾ç½®ï¼‰
```

---

## 9. ğŸ‘¥ libvirtç”¨æˆ·æƒé™ç®¡ç†


### 9.1 libvirtç”¨æˆ·ç»„ç®¡ç†


**libvirtç”¨æˆ·æƒé™ä½“ç³»**ï¼š

```
rootç”¨æˆ·ï¼š
  â†“ (å®Œå…¨æƒé™)
libvirtç»„ç”¨æˆ·ï¼š
  â†“ (ç®¡ç†æƒé™)
æ™®é€šç”¨æˆ·ï¼š
  â†“ (åªè¯»æƒé™)
```

**æ·»åŠ ç”¨æˆ·åˆ°libvirtç»„**ï¼š

```bash
# å°†ç”¨æˆ·æ·»åŠ åˆ°libvirtç»„
usermod -a -G libvirt username

# æŸ¥çœ‹ç”¨æˆ·ç»„æˆå‘˜
getent group libvirt
# è¾“å‡ºï¼šlibvirt:x:117:username

# éªŒè¯ç”¨æˆ·æƒé™
su - username
virsh list --all
```

### 9.2 åŸºäºç­–ç•¥çš„è®¿é—®æ§åˆ¶


**é…ç½®libvirtè®¿é—®ç­–ç•¥**ï¼š

```bash
# ç¼–è¾‘libvirtè®¿é—®æ§åˆ¶é…ç½®
sudo nano /etc/libvirt/libvirtd.conf

# ç”¨æˆ·è®¤è¯é…ç½®
auth_unix_ro = "polkit"        # åªè¯»è®¿é—®éœ€è¦polkitè®¤è¯
auth_unix_rw = "polkit"        # è¯»å†™è®¿é—®éœ€è¦polkitè®¤è¯

# TCPè¿æ¥é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
listen_tcp = 1
auth_tcp = "sasl"              # TCPè¿æ¥ä½¿ç”¨SASLè®¤è¯
```

### 9.3 åˆ›å»ºè‡ªå®šä¹‰æƒé™ç­–ç•¥


**åˆ›å»ºpolkitç­–ç•¥æ–‡ä»¶**ï¼š

```javascript
// åˆ›å»º /etc/polkit-1/rules.d/50-libvirt.rules
polkit.addRule(function(action, subject) {
    if (action.id == "org.libvirt.unix.manage" &&
        subject.user == "vmadmin") {
        return polkit.Result.YES;
    }
});

// é™åˆ¶ç”¨æˆ·åªèƒ½ç®¡ç†ç‰¹å®šè™šæ‹Ÿæœº
polkit.addRule(function(action, subject) {
    if (action.id == "org.libvirt.unix.manage" &&
        subject.user == "user1") {
        if (action.lookup("domain_name") == "vm1") {
            return polkit.Result.YES;
        }
        return polkit.Result.NO;
    }
});
```

### 9.4 ç”¨æˆ·ä¼šè¯éš”ç¦»


**é…ç½®ç”¨æˆ·ä¼šè¯è™šæ‹Ÿæœº**ï¼š

```bash
# å¯åŠ¨ç”¨æˆ·ä¼šè¯libvirtæœåŠ¡
systemctl --user enable libvirtd.socket
systemctl --user start libvirtd.socket

# ç”¨æˆ·ä¼šè¯ä¸­ç®¡ç†è™šæ‹Ÿæœº
export LIBVIRT_DEFAULT_URI="qemu:///session"
virsh list --all

# æŸ¥çœ‹ç”¨æˆ·ä¼šè¯è™šæ‹Ÿæœºå­˜å‚¨ä½ç½®
ls ~/.local/share/libvirt/images/
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„å®‰å…¨æ¦‚å¿µ


```
ğŸ”¸ è™šæ‹ŸåŒ–å®‰å…¨ï¼šå¤šå±‚é˜²æŠ¤ï¼Œè¿›ç¨‹éš”ç¦»ï¼Œæƒé™æœ€å°åŒ–
ğŸ”¸ SELinux/AppArmorï¼šå¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼ŒåŸºäºä¸Šä¸‹æ–‡çš„å®‰å…¨ç­–ç•¥
ğŸ”¸ ç£ç›˜åŠ å¯†ï¼šLUKSåŠ å¯†ï¼Œä¿æŠ¤é™æ€æ•°æ®å®‰å…¨
ğŸ”¸ ç½‘ç»œéš”ç¦»ï¼šè™šæ‹Ÿç½‘ç»œåˆ†æ®µï¼Œé˜²ç«å¢™è§„åˆ™æ§åˆ¶
ğŸ”¸ é€ƒé€¸é˜²æŠ¤ï¼šHypervisoråŠ å›ºï¼Œè®¾å¤‡ç›´é€šé™åˆ¶
ğŸ”¸ æƒé™ç®¡ç†ï¼šç”¨æˆ·ç»„ç®¡ç†ï¼ŒåŸºäºç­–ç•¥çš„è®¿é—®æ§åˆ¶
```

### 10.2 å…³é”®å®‰å…¨é…ç½®è¦ç‚¹


**ğŸ”¹ å®‰å…¨é…ç½®ä¼˜å…ˆçº§**
```
1. å¯ç”¨SELinux/AppArmorå¼ºåˆ¶æ¨¡å¼
2. é…ç½®è™šæ‹Ÿæœºè¿›ç¨‹ç”¨æˆ·æƒé™æœ€å°åŒ–
3. å¯ç”¨è™šæ‹Ÿç£ç›˜åŠ å¯†ä¿æŠ¤é™æ€æ•°æ®
4. é…ç½®ç½‘ç»œéš”ç¦»å’Œè®¿é—®æ§åˆ¶
5. å®šæœŸæ›´æ–°è™šæ‹ŸåŒ–è½¯ä»¶ç‰ˆæœ¬
```

**ğŸ”¹ å®‰å…¨ç›‘æ§æ£€æŸ¥åˆ—è¡¨**
```
âœ… å®šæœŸæ£€æŸ¥è™šæ‹Ÿæœºè¿›ç¨‹æƒé™
âœ… ç›‘æ§è™šæ‹Ÿæœºç½‘ç»œæµé‡å¼‚å¸¸
âœ… æ£€æŸ¥SELinux/AppArmorç­–ç•¥è¿è§„
âœ… éªŒè¯ç£ç›˜åŠ å¯†é…ç½®æœ‰æ•ˆæ€§
âœ… å®¡æŸ¥ç”¨æˆ·è®¿é—®æƒé™å˜æ›´
```

### 10.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ¯ ä¼ä¸šç¯å¢ƒå®‰å…¨é…ç½®**
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šå¯ç”¨æ‰€æœ‰å®‰å…¨ç‰¹æ€§ï¼Œä¸¥æ ¼æƒé™æ§åˆ¶
- **å¼€å‘ç¯å¢ƒ**ï¼šå¹³è¡¡å®‰å…¨æ€§å’Œæ˜“ç”¨æ€§ï¼Œé€‚åº¦æƒé™å¼€æ”¾
- **æµ‹è¯•ç¯å¢ƒ**ï¼šé‡ç‚¹å…³æ³¨ç½‘ç»œéš”ç¦»ï¼Œé˜²æ­¢å½±å“ç”Ÿäº§

**ğŸ¯ äº‘å¹³å°å®‰å…¨è¦æ±‚**
- **å¤šç§Ÿæˆ·éš”ç¦»**ï¼šä¸¥æ ¼çš„è™šæ‹Ÿæœºé—´éš”ç¦»
- **æ•°æ®ä¿æŠ¤**ï¼šå¼ºåˆ¶ç£ç›˜åŠ å¯†å’Œç½‘ç»œåŠ å¯†
- **è®¿é—®å®¡è®¡**ï¼šå®Œæ•´çš„ç”¨æˆ·æ“ä½œæ—¥å¿—è®°å½•

**ğŸ¯ å®‰å…¨åˆè§„è¦æ±‚**
- **ç­‰ä¿åˆè§„**ï¼šæ»¡è¶³ç­‰çº§ä¿æŠ¤å®‰å…¨è¦æ±‚
- **è¡Œä¸šæ ‡å‡†**ï¼šç¬¦åˆç‰¹å®šè¡Œä¸šå®‰å…¨è§„èŒƒ
- **å®¡è®¡è¦æ±‚**ï¼šæä¾›å®Œæ•´çš„å®‰å…¨é…ç½®è¯æ®

### 10.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ”§ æ—¥å¸¸å®‰å…¨ç»´æŠ¤**
```bash
# å®šæœŸå®‰å…¨æ£€æŸ¥è„šæœ¬ç¤ºä¾‹
#!/bin/bash
echo "=== KVMå®‰å…¨æ£€æŸ¥ ==="
echo "1. SELinuxçŠ¶æ€: $(getenforce)"
echo "2. libvirtæƒé™: $(ls -l /var/run/libvirt/libvirt-sock)"
echo "3. è™šæ‹Ÿæœºè¿›ç¨‹: $(ps aux | grep qemu | wc -l)"
echo "4. ç½‘ç»œéš”ç¦»: $(virsh net-list)"
```

**æ ¸å¿ƒå®‰å…¨è®°å¿†**ï¼š
- è™šæ‹ŸåŒ–å®‰å…¨é‡åœ¨éš”ç¦»ï¼Œæ¯ä¸€å±‚éƒ½è¦è®¾é˜²æŠ¤
- æƒé™æœ€å°åŒ–åŸåˆ™ï¼Œç»™å¤šå°‘æƒé™åŠå¤šå°‘äº‹  
- åŠ å¯†ä¿æŠ¤é™æ€æ•°æ®ï¼Œç›‘æ§é˜²èŒƒåŠ¨æ€å¨èƒ
- å®šæœŸæ£€æŸ¥é…ç½®çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°å®‰å…¨é—®é¢˜