---
title: 4、libvirt管理框架
---
## 📚 目录

1. [libvirt概述与架构](#1-libvirt概述与架构)
2. [libvirtd守护进程详解](#2-libvirtd守护进程详解)
3. [virsh命令行工具完整使用](#3-virsh命令行工具完整使用)
4. [libvirt XML配置文件结构](#4-libvirt-xml配置文件结构)
5. [虚拟机定义与管理](#5-虚拟机定义与管理)
6. [连接URI配置详解](#6-连接uri配置详解)
7. [libvirt存储池与卷管理](#7-libvirt存储池与卷管理)
8. [libvirt网络配置与管理](#8-libvirt网络配置与管理)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🏗️ libvirt概述与架构


### 1.1 什么是libvirt


**简单理解**：libvirt就像是虚拟机的"万能遥控器"
```
现实类比：
电视机 → 虚拟机
遥控器 → libvirt
不同品牌电视 → 不同虚拟化技术(KVM、QEMU、Xen等)

无论什么品牌的电视，用一个万能遥控器就能控制
无论什么虚拟化技术，用libvirt就能统一管理
```

**核心作用**：
- **统一接口**：不管底层用什么虚拟化技术，都用同样的方式管理
- **抽象层**：把复杂的虚拟化操作变成简单的命令
- **标准化**：提供统一的配置格式和管理方式

### 1.2 libvirt架构组成


**整体架构图**：
```
┌─────────────────────────────────────────┐
│            管理工具层                    │
├─────────────┬─────────────┬─────────────┤
│   virsh     │  virt-mgr   │  其他工具    │ ← 用户界面
├─────────────┴─────────────┴─────────────┤
│              libvirt API                │ ← 统一接口
├─────────────────────────────────────────┤
│             libvirtd                    │ ← 核心守护进程
├─────────────┬─────────────┬─────────────┤
│    KVM      │    QEMU     │     Xen     │ ← 虚拟化驱动
└─────────────┴─────────────┴─────────────┘
```

**关键组件**：

🔸 **libvirtd守护进程**
- 作用：核心服务进程，负责实际的虚拟机管理
- 运行方式：后台服务，开机自启动
- 通信方式：通过Socket与客户端通信

🔸 **libvirt API**
- 作用：提供编程接口，供上层工具调用
- 语言支持：C、Python、Java等多种语言
- 功能范围：虚拟机、网络、存储全生命周期管理

🔸 **管理工具**
- virsh：命令行工具，功能最全面
- virt-manager：图形界面工具
- 第三方工具：OpenStack、oVirt等

### 1.3 为什么要用libvirt


**解决的问题**：

```
没有libvirt的时代：
KVM虚拟机 → 直接用qemu命令 → 命令复杂，难记忆
Xen虚拟机 → 用xl命令 → 语法不同，需要重新学习
VMware → 用vmrun命令 → 又是另一套语法

有了libvirt之后：
所有虚拟机 → 统一用virsh命令 → 一套语法走天下
```

**实际价值**：
- **学习成本低**：只需掌握一套命令
- **迁移容易**：配置文件标准化，可跨平台
- **自动化友好**：API丰富，便于脚本化管理
- **生态完善**：大量工具基于libvirt开发

---

## 2. ⚙️ libvirtd守护进程详解


### 2.1 libvirtd是什么


**通俗理解**：libvirtd就像虚拟机的"管家"
```
类比家政服务：
你（用户）→ 发指令 → 管家（libvirtd）→ 干活（管理虚拟机）

你说"开空调"，管家去操作空调
你说"启动虚拟机"，libvirtd去启动虚拟机

管家在后台24小时待命，随时响应你的需求
```

### 2.2 libvirtd的工作方式


**服务状态管理**：
```bash
# 查看libvirtd状态
systemctl status libvirtd

# 启动libvirtd
systemctl start libvirtd

# 设置开机自启
systemctl enable libvirtd
```

**运行模式**：

🔸 **系统模式（System Mode）**
- 以root权限运行
- 管理系统级虚拟机
- 可以使用所有系统资源
- 默认模式，适合服务器环境

🔸 **会话模式（Session Mode）**
- 以普通用户权限运行
- 只能管理用户级虚拟机
- 资源受限但更安全
- 适合桌面环境

### 2.3 libvirtd配置文件


**主配置文件**：`/etc/libvirt/libvirtd.conf`

**重要配置项**：
```bash
# 监听地址（默认只监听本地）
listen_addr = "0.0.0.0"

# TCP端口（默认16509）
tcp_port = "16509"

# 认证方式
auth_tcp = "sasl"

# 日志级别
log_level = 2
```

**配置修改后重启**：
```bash
systemctl restart libvirtd
```

### 2.4 libvirtd的通信机制


**通信方式图解**：
```
客户端工具                    libvirtd守护进程
┌──────────┐                ┌─────────────┐
│   virsh  │◄──Socket────►│  libvirtd   │
├──────────┤                ├─────────────┤
│virt-mgr  │◄──TCP/TLS───►│    API      │
├──────────┤                ├─────────────┤
│  Python  │◄──Unix域───►│   处理器     │
│  脚本    │                │             │
└──────────┘                └─────────────┘
```

**本地通信**：
- Unix域Socket：`/var/run/libvirt/libvirt-sock`
- 性能最好，适合本地管理

**远程通信**：
- TCP：适合网络管理，需要配置认证
- TLS：加密传输，生产环境推荐

---

## 3. 🔧 virsh命令行工具完整使用


### 3.1 virsh基础概念


**什么是virsh**：
```
virsh = VIRtualization SHell
就像Linux的bash shell，但专门用来管理虚拟机

bash → 管理Linux系统
virsh → 管理虚拟机系统
```

**使用方式**：
```bash
# 交互模式：进入virsh环境
virsh
Welcome to virsh, the virtualization interactive terminal.
virsh # 

# 命令模式：直接执行单个命令
virsh list --all
```

### 3.2 虚拟机基本操作


#### 🔍 查看虚拟机


**查看所有虚拟机**：
```bash
# 查看运行中的虚拟机
virsh list

# 查看所有虚拟机（包括关闭的）
virsh list --all
```

**输出解释**：
```
 Id   Name       State
--------------------------
 1    centos7    running     ← 运行中
 -    ubuntu20   shut off    ← 已关闭
```

**查看虚拟机详细信息**：
```bash
# 查看虚拟机基本信息
virsh dominfo centos7

# 查看虚拟机配置
virsh dumpxml centos7
```

#### ⚡ 虚拟机电源管理


**启动虚拟机**：
```bash
# 启动虚拟机
virsh start centos7

# 开机自启动设置
virsh autostart centos7           # 启用自启动
virsh autostart --disable centos7 # 禁用自启动
```

**关闭虚拟机**：
```bash
# 优雅关机（推荐）
virsh shutdown centos7

# 强制关机（相当于拔电源）
virsh destroy centos7

# 重启虚拟机
virsh reboot centos7
```

**暂停与恢复**：
```bash
# 暂停虚拟机（挂起到内存）
virsh suspend centos7

# 恢复虚拟机
virsh resume centos7
```

### 3.3 虚拟机资源管理


#### 💾 内存管理


**查看内存使用**：
```bash
# 查看虚拟机内存信息
virsh dominfo centos7 | grep -i memory
```

**动态调整内存**：
```bash
# 在线增加内存（临时，重启失效）
virsh setmem centos7 2048M

# 永久修改内存配置
virsh setmem centos7 2048M --config

# 同时修改当前和配置
virsh setmem centos7 2048M --live --config
```

#### 🖥️ CPU管理


**查看CPU信息**：
```bash
# 查看虚拟机CPU配置
virsh vcpuinfo centos7

# 查看CPU使用统计
virsh cpu-stats centos7
```

**调整CPU数量**：
```bash
# 在线增加CPU（如果虚拟机支持）
virsh setvcpus centos7 4 --live

# 永久修改CPU配置
virsh setvcpus centos7 4 --config
```

### 3.4 虚拟机监控与调试


**性能监控**：
```bash
# 查看虚拟机状态统计
virsh domstats centos7

# 查看网络接口统计
virsh domifstat centos7 vnet0

# 查看磁盘统计
virsh domblkstat centos7 vda
```

**控制台访问**：
```bash
# 连接虚拟机控制台
virsh console centos7

# 断开控制台：Ctrl + ]
```

**快照管理**：
```bash
# 创建快照
virsh snapshot-create-as centos7 snap1 "安装完成后的快照"

# 查看快照列表
virsh snapshot-list centos7

# 恢复快照
virsh snapshot-revert centos7 snap1

# 删除快照
virsh snapshot-delete centos7 snap1
```

### 3.5 批量操作技巧


**批量管理示例**：
```bash
# 启动所有关闭的虚拟机
for vm in $(virsh list --name --state-shutoff); do
    virsh start "$vm"
done

# 关闭所有运行的虚拟机
virsh list --name | while read vm; do
    [ -n "$vm" ] && virsh shutdown "$vm"
done
```

---

## 4. 📄 libvirt XML配置文件结构


### 4.1 XML配置文件概述


**为什么用XML**：
```
类比：XML配置文件就像电器的"说明书"

电器说明书：详细描述电器的各种参数和功能
XML配置：详细描述虚拟机的各种配置和资源

有了这个"说明书"，libvirt就知道怎么创建和配置虚拟机
```

**XML文件作用**：
- **定义虚拟机**：CPU、内存、磁盘、网络等所有配置
- **持久化配置**：保存配置，重启后不丢失
- **跨平台移植**：标准格式，可在不同环境使用

### 4.2 XML文件基本结构


**完整的XML结构框架**：
```xml
<domain type='kvm'>                    ← 虚拟机类型
  <name>centos7</name>                 ← 虚拟机名称
  <uuid>...</uuid>                     ← 唯一标识
  <memory unit='KiB'>2097152</memory>  ← 内存配置
  <vcpu placement='static'>2</vcpu>    ← CPU配置
  
  <os>                                 ← 操作系统配置
    <type arch='x86_64'>hvm</type>
    <boot dev='hd'/>
  </os>
  
  <devices>                            ← 设备配置
    <disk>...</disk>                   ← 磁盘设备
    <interface>...</interface>         ← 网络设备
    <graphics>...</graphics>           ← 显示设备
  </devices>
</domain>
```

### 4.3 核心配置段详解


#### 🔧 基本信息配置


```xml
<domain type='kvm'>
  <name>my-vm</name>                    <!-- 虚拟机名称，必须唯一 -->
  <uuid>a1b2c3d4-e5f6-7890-abcd-ef1234567890</uuid>  <!-- 自动生成 -->
  <description>我的测试虚拟机</description>           <!-- 描述信息 -->
  <metadata>                            <!-- 元数据，可选 -->
    <app:custom xmlns:app="http://example.com">
      <app:owner>admin</app:owner>
    </app:custom>
  </metadata>
</domain>
```

#### 💾 内存与CPU配置


```xml
<!-- 内存配置 -->
<memory unit='KiB'>4194304</memory>     <!-- 最大内存：4GB -->
<currentMemory unit='KiB'>2097152</currentMemory>  <!-- 当前内存：2GB -->

<!-- CPU配置 -->
<vcpu placement='static'>4</vcpu>       <!-- 虚拟CPU数量 -->
<cpu mode='host-passthrough'>           <!-- CPU模式 -->
  <topology sockets='1' cores='4' threads='1'/>  <!-- CPU拓扑 -->
</cpu>
```

**内存单位说明**：
- `KiB`：1024字节（推荐）
- `MiB`：1024 KiB
- `GiB`：1024 MiB

#### 🖥️ 操作系统配置


```xml
<os>
  <type arch='x86_64' machine='pc-q35-4.2'>hvm</type>
  <loader readonly='yes' type='pflash'>/usr/share/OVMF/OVMF_CODE.fd</loader>
  <boot dev='hd'/>          <!-- 硬盘启动 -->
  <boot dev='cdrom'/>       <!-- 光盘启动（备用） -->
  <bootmenu enable='yes'/>  <!-- 启用启动菜单 -->
</os>
```

**启动设备说明**：
- `hd`：硬盘启动
- `cdrom`：光盘启动
- `network`：网络启动（PXE）
- `fd`：软盘启动（很少用）

### 4.4 设备配置详解


#### 💿 磁盘设备配置


```xml
<devices>
  <!-- 系统盘 -->
  <disk type='file' device='disk'>
    <driver name='qemu' type='qcow2' cache='writeback'/>
    <source file='/var/lib/libvirt/images/centos7.qcow2'/>
    <target dev='vda' bus='virtio'/>
    <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>
  </disk>
  
  <!-- 数据盘 -->
  <disk type='file' device='disk'>
    <driver name='qemu' type='raw'/>
    <source file='/var/lib/libvirt/images/data.img'/>
    <target dev='vdb' bus='virtio'/>
  </disk>
  
  <!-- ISO光盘 -->
  <disk type='file' device='cdrom'>
    <driver name='qemu' type='raw'/>
    <source file='/path/to/centos7.iso'/>
    <target dev='hdc' bus='ide'/>
    <readonly/>
  </disk>
</devices>
```

**磁盘类型说明**：
- `file`：使用文件作为磁盘
- `block`：使用块设备（如/dev/sdb）
- `network`：网络存储（如iSCSI）

#### 🌐 网络设备配置


```xml
<!-- 桥接网络 -->
<interface type='bridge'>
  <mac address='52:54:00:12:34:56'/>     <!-- MAC地址 -->
  <source bridge='br0'/>                 <!-- 桥接到br0 -->
  <model type='virtio'/>                 <!-- 网卡型号 -->
  <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>
</interface>

<!-- NAT网络 -->
<interface type='network'>
  <mac address='52:54:00:12:34:57'/>
  <source network='default'/>            <!-- 使用默认NAT网络 -->
  <model type='virtio'/>
</interface>
```

#### 🖱️ 输入输出设备


```xml
<!-- VNC显示 -->
<graphics type='vnc' port='5900' autoport='yes' listen='0.0.0.0'>
  <listen type='address' address='0.0.0.0'/>
</graphics>

<!-- 键盘鼠标 -->
<input type='keyboard' bus='ps2'/>
<input type='mouse' bus='ps2'/>

<!-- 串口控制台 -->
<serial type='pty'>
  <target type='isa-serial' port='0'/>
</serial>
<console type='pty'>
  <target type='serial' port='0'/>
</console>
```

### 4.5 XML文件操作


**导出XML配置**：
```bash
# 导出当前配置
virsh dumpxml centos7 > centos7.xml

# 导出非活动配置
virsh dumpxml --inactive centos7 > centos7-inactive.xml
```

**验证XML文件**：
```bash
# 验证XML语法
virt-xml-validate centos7.xml domain
```

**从XML创建虚拟机**：
```bash
# 临时创建（重启失效）
virsh create centos7.xml

# 永久定义（重启有效）
virsh define centos7.xml
```

---

## 5. 📋 虚拟机定义与管理


### 5.1 虚拟机生命周期管理


**虚拟机状态图**：
```
        define              start
未定义 ---------> 已定义 ---------> 运行中
  ↑                ↑                  ↓
  |             undefine          shutdown
  |                ↑                  ↓
  └──────────────── 已关闭 ←──────────┘
                      ↑
                   destroy
                   （强制关闭）
```

### 5.2 define操作详解


**什么是define**：
```
类比理解：
define = 在"虚拟机花名册"上登记

就像新员工入职要登记个人信息一样
define就是把虚拟机的配置信息登记到libvirt中
登记后，libvirt就认识这个虚拟机了
```

**define命令使用**：
```bash
# 从XML文件定义虚拟机
virsh define /path/to/vm.xml

# 查看定义结果
virsh list --all
```

**define的作用**：
- **配置持久化**：重启libvirtd后配置不丢失
- **纳入管理**：可以用virsh命令管理
- **资源分配**：为虚拟机分配UUID等标识

### 5.3 undefine操作详解


**什么是undefine**：
```
undefine = 从"虚拟机花名册"上注销

员工离职要注销登记信息
undefine就是把虚拟机从libvirt中注销
注销后，libvirt就不认识这个虚拟机了
```

**undefine使用方法**：
```bash
# 注销虚拟机定义
virsh undefine centos7

# 同时删除存储
virsh undefine centos7 --remove-all-storage

# 删除NVRAM（UEFI虚拟机需要）
virsh undefine centos7 --nvram
```

**注意事项**：
- undefine不会删除磁盘文件
- 运行中的虚拟机需要先关闭
- 删除配置信息，但虚拟机文件还在

### 5.4 start操作详解


**启动虚拟机**：
```bash
# 启动已定义的虚拟机
virsh start centos7

# 启动时连接控制台
virsh start centos7 --console

# 从XML文件直接启动（临时）
virsh create vm.xml
```

**启动过程**：
```
1. 读取XML配置
2. 检查资源可用性
3. 分配硬件资源
4. 启动QEMU进程
5. 初始化虚拟硬件
6. 引导操作系统
```

### 5.5 shutdown操作详解


**关闭虚拟机的方式**：

🔸 **优雅关机（shutdown）**
```bash
# 发送关机信号
virsh shutdown centos7

# 指定关机方式
virsh shutdown centos7 --mode acpi    # ACPI关机
virsh shutdown centos7 --mode agent   # 通过guest agent
```

🔸 **强制关机（destroy）**
```bash
# 立即终止虚拟机进程
virsh destroy centos7
```

**关机方式对比**：

| 方式 | **优点** | **缺点** | **适用场景** |
|------|---------|---------|-------------|
| `shutdown` | `安全，数据不丢失` | `可能失败，耗时较长` | `正常关机` |
| `destroy` | `立即生效，100%成功` | `可能数据丢失` | `应急情况` |

### 5.6 虚拟机管理最佳实践


**创建虚拟机标准流程**：
```bash
# 1. 准备磁盘镜像
qemu-img create -f qcow2 /var/lib/libvirt/images/new-vm.qcow2 20G

# 2. 编写XML配置文件
vi new-vm.xml

# 3. 定义虚拟机
virsh define new-vm.xml

# 4. 启动虚拟机
virsh start new-vm

# 5. 设置自启动
virsh autostart new-vm
```

**删除虚拟机标准流程**：
```bash
# 1. 关闭虚拟机
virsh shutdown vm-name

# 2. 等待关机完成
virsh list --all | grep vm-name

# 3. 注销定义并删除存储
virsh undefine vm-name --remove-all-storage

# 4. 清理相关文件（如果有）
rm -f /etc/libvirt/qemu/vm-name.xml
```

---

## 6. 🔗 连接URI配置详解


### 6.1 什么是连接URI


**URI概念理解**：
```
URI = Uniform Resource Identifier（统一资源标识符）

类比理解：
URI就像"地址"，告诉virsh要连接到哪里

邮寄地址：北京市朝阳区xxx街道xxx号
连接URI：qemu:///system
```

**URI的作用**：
- **指定连接目标**：连接本地还是远程
- **选择驱动类型**：使用哪种虚拟化技术
- **确定权限级别**：系统级还是用户级

### 6.2 qemu:///system详解


**系统级连接**：
```bash
# 明确指定系统级连接
virsh -c qemu:///system list

# 默认就是系统级（可省略）
virsh list
```

**qemu:///system特点**：

🔸 **权限级别**
```
运行身份：root或sudo权限用户
管理范围：整个系统的虚拟机
资源访问：可使用所有系统资源
```

🔸 **适用场景**
- **服务器环境**：生产服务器的虚拟机管理
- **多用户环境**：系统管理员统一管理
- **高性能需求**：需要使用全部硬件资源

🔸 **存储位置**
```bash
# 虚拟机定义文件
/etc/libvirt/qemu/

# 磁盘镜像文件
/var/lib/libvirt/images/

# 网络配置
/etc/libvirt/qemu/networks/
```

### 6.3 qemu:///session详解


**用户级连接**：
```bash
# 连接用户级libvirt
virsh -c qemu:///session list

# 切换到session模式
export LIBVIRT_DEFAULT_URI=qemu:///session
virsh list
```

**qemu:///session特点**：

🔸 **权限级别**
```
运行身份：当前普通用户
管理范围：仅当前用户的虚拟机
资源限制：受用户权限限制
```

🔸 **适用场景**
- **桌面环境**：个人开发测试
- **安全要求高**：隔离不同用户的虚拟机
- **学习环境**：学生练习使用

🔸 **存储位置**
```bash
# 虚拟机定义文件
~/.config/libvirt/qemu/

# 磁盘镜像文件
~/.local/share/libvirt/images/

# 日志文件
~/.cache/libvirt/qemu/log/
```

### 6.4 system vs session对比


**详细对比表**：

| 特性 | **qemu:///system** | **qemu:///session** |
|------|-------------------|---------------------|
| **运行权限** | `root/sudo` | `普通用户` |
| **虚拟机范围** | `全系统` | `当前用户` |
| **资源访问** | `无限制` | `受用户限制` |
| **网络功能** | `完整桥接功能` | `用户模式网络` |
| **存储位置** | `/var/lib/libvirt/` | `~/.local/share/libvirt/` |
| **开机自启** | `支持` | `不支持` |
| **硬件直通** | `支持` | `不支持` |
| **适用环境** | `服务器/生产` | `桌面/开发` |

### 6.5 远程连接URI


**远程连接格式**：
```bash
# SSH连接远程libvirt
virsh -c qemu+ssh://user@remote-host/system list

# TCP连接（需要配置认证）
virsh -c qemu+tcp://remote-host/system list

# TLS加密连接
virsh -c qemu+tls://remote-host/system list
```

**SSH连接示例**：
```bash
# 连接远程服务器的系统级libvirt
virsh -c qemu+ssh://root@192.168.1.100/system list

# 连接时指定SSH端口
virsh -c "qemu+ssh://root@192.168.1.100:2222/system" list

# 使用SSH密钥认证
virsh -c qemu+ssh://user@server/system list
```

**远程连接配置**：

🔸 **服务端配置**
```bash
# 编辑libvirtd配置
vi /etc/libvirt/libvirtd.conf

# 启用TCP监听
listen_tls = 0
listen_tcp = 1
tcp_port = "16509"
listen_addr = "0.0.0.0"
auth_tcp = "none"  # 仅测试环境

# 重启服务
systemctl restart libvirtd
```

🔸 **客户端使用**
```bash
# 设置默认URI
export LIBVIRT_DEFAULT_URI=qemu+ssh://server/system

# 或在配置文件中设置
echo 'uri_default = "qemu+ssh://server/system"' > ~/.config/libvirt/libvirt.conf
```

### 6.6 URI使用技巧


**环境变量设置**：
```bash
# 临时设置
export LIBVIRT_DEFAULT_URI=qemu:///session

# 永久设置（添加到~/.bashrc）
echo 'export LIBVIRT_DEFAULT_URI=qemu:///session' >> ~/.bashrc
source ~/.bashrc
```

**配置文件方式**：
```bash
# 创建配置文件
mkdir -p ~/.config/libvirt
cat > ~/.config/libvirt/libvirt.conf << EOF
uri_default = "qemu:///session"
EOF
```

**多环境管理**：
```bash
# 定义别名
alias virsh-sys='virsh -c qemu:///system'
alias virsh-user='virsh -c qemu:///session'
alias virsh-remote='virsh -c qemu+ssh://server/system'

# 使用别名
virsh-sys list
virsh-user list
virsh-remote list
```

---

## 7. 💾 libvirt存储池与卷管理


### 7.1 存储概念理解


**存储池（Storage Pool）是什么**：
```
类比理解：
存储池 = 大型仓库
存储卷 = 仓库中的货架

仓库（存储池）：
- 划分存储空间的区域
- 可以是目录、LVM、NFS等

货架（存储卷）：
- 仓库中具体的存储单元
- 就是虚拟机的磁盘文件
```

**为什么要用存储池**：
- **统一管理**：所有存储在一个地方管理
- **资源分配**：自动分配存储空间
- **权限控制**：统一的访问控制
- **性能优化**：针对不同存储类型优化

### 7.2 存储池类型与创建


**常见存储池类型**：

🔸 **目录型存储池（dir）**
```bash
# 创建目录存储池
virsh pool-define-as mypool dir --target /var/lib/libvirt/mypool

# 创建目录
mkdir -p /var/lib/libvirt/mypool

# 启动存储池
virsh pool-start mypool

# 设置自动启动
virsh pool-autostart mypool
```

🔸 **文件系统存储池（fs）**
```bash
# 挂载外部文件系统作为存储池
virsh pool-define-as fspool fs --source-dev /dev/sdb1 --target /mnt/storage
virsh pool-build fspool
virsh pool-start fspool
```

🔸 **LVM存储池（logical）**
```bash
# 使用LVM卷组作为存储池
virsh pool-define-as lvmpool logical --source-name vg_storage --target /dev/vg_storage
virsh pool-start lvmpool
```

🔸 **NFS存储池（netfs）**
```bash
# 挂载NFS共享作为存储池
virsh pool-define-as nfspool netfs --source-host 192.168.1.200 --source-path /export/storage --target /mnt/nfs
virsh pool-start nfspool
```

### 7.3 存储池管理操作


**查看存储池**：
```bash
# 查看所有存储池
virsh pool-list --all

# 查看存储池详细信息
virsh pool-info default

# 查看存储池XML配置
virsh pool-dumpxml default
```

**存储池状态管理**：
```bash
# 启动存储池
virsh pool-start mypool

# 停止存储池
virsh pool-destroy mypool

# 删除存储池定义
virsh pool-undefine mypool

# 刷新存储池（重新扫描内容）
virsh pool-refresh mypool
```

**存储池路径结构**：
```
默认存储池结构：
/var/lib/libvirt/images/
├── centos7.qcow2          ← 虚拟机系统盘
├── ubuntu20.qcow2         ← 另一个虚拟机
├── data-disk.img          ← 数据盘
└── iso/                   ← ISO镜像目录
    └── centos7.iso
```

### 7.4 存储卷管理


**什么是存储卷**：
```
存储卷 = 虚拟机的"硬盘"

就像给电脑买硬盘一样：
- 物理机：买一块SSD装进电脑
- 虚拟机：创建一个存储卷当作硬盘
```

**创建存储卷**：
```bash
# 在指定存储池中创建卷
virsh vol-create-as mypool vm1-disk1.qcow2 20G --format qcow2

# 创建原始格式的卷
virsh vol-create-as mypool vm1-disk2.img 10G --format raw

# 从模板克隆卷
virsh vol-clone template.qcow2 new-vm.qcow2 --pool mypool
```

**查看存储卷**：
```bash
# 查看存储池中的所有卷
virsh vol-list mypool

# 查看卷的详细信息
virsh vol-info vm1-disk1.qcow2 --pool mypool

# 查看卷的路径
virsh vol-path vm1-disk1.qcow2 --pool mypool
```

**存储卷操作**：
```bash
# 调整卷大小
virsh vol-resize vm1-disk1.qcow2 30G --pool mypool

# 删除存储卷
virsh vol-delete vm1-disk1.qcow2 --pool mypool

# 上传文件到卷
virsh vol-upload vm1-disk1.qcow2 /path/to/source.img --pool mypool

# 下载卷到文件
virsh vol-download vm1-disk1.qcow2 /path/to/backup.img --pool mypool
```

### 7.5 存储格式对比


**磁盘格式选择**：

| 格式 | **特点** | **优势** | **劣势** | **适用场景** |
|------|---------|---------|---------|-------------|
| **qcow2** | `动态增长，支持快照` | `节省空间，功能丰富` | `性能略低` | `开发测试环境` |
| **raw** | `原始格式，性能最好` | `速度快，兼容性好` | `占用空间大` | `生产环境` |
| **vmdk** | `VMware格式` | `兼容VMware` | `功能受限` | `迁移场景` |
| **vdi** | `VirtualBox格式` | `兼容VirtualBox` | `性能一般` | `桌面虚拟化` |

**格式转换**：
```bash
# qcow2转raw
qemu-img convert -f qcow2 -O raw source.qcow2 target.img

# raw转qcow2
qemu-img convert -f raw -O qcow2 source.img target.qcow2

# 压缩qcow2文件
qemu-img convert -f qcow2 -O qcow2 -c source.qcow2 compressed.qcow2
```

### 7.6 存储性能优化


**缓存策略配置**：
```xml
<!-- 在虚拟机XML中配置 -->
<disk type='file' device='disk'>
  <driver name='qemu' type='qcow2' cache='writeback'/>
  <source file='/var/lib/libvirt/images/vm.qcow2'/>
  <target dev='vda' bus='virtio'/>
</disk>
```

**缓存模式对比**：

| 模式 | **特点** | **性能** | **安全性** | **适用场景** |
|------|---------|---------|-----------|-------------|
| `none` | `直接写入，不缓存` | `低` | `最高` | `关键数据` |
| `writethrough` | `同时写缓存和磁盘` | `中` | `高` | `一般应用` |
| `writeback` | `先写缓存，延迟写盘` | `高` | `低` | `性能优先` |
| `unsafe` | `不保证数据一致性` | `最高` | `最低` | `测试环境` |

---

## 8. 🌐 libvirt网络配置与管理


### 8.1 虚拟网络基础概念


**虚拟网络是什么**：
```
类比理解：
物理网络 = 真实的网线、交换机、路由器
虚拟网络 = 软件模拟的网络设备

就像搭积木一样：
- 物理网络：用真的积木搭建
- 虚拟网络：在电脑里用软件"搭建"网络
```

**libvirt网络架构**：
```
宿主机网络环境：
┌─────────────────────────────────────────┐
│              宿主机                      │
│  ┌─────────┐    ┌──────────────────┐   │
│  │  VM1    │    │    虚拟网络      │   │
│  │ eth0    │◄───┤   (virbr0)       │   │
│  └─────────┘    │                  │   │
│  ┌─────────┐    │   ┌──────────┐   │   │
│  │  VM2    │    │   │   NAT    │   │   │
│  │ eth0    │◄───┤   │  DHCP    │   │◄──┼──► 外网
│  └─────────┘    │   │  DNS     │   │   │
│                 └───┴──────────┴───┘   │
└─────────────────────────────────────────┘
```

### 8.2 网络类型详解


#### 🔌 NAT网络（默认网络）


**什么是NAT网络**：
```
NAT = Network Address Translation（网络地址转换）

类比理解：
NAT网络 = 公司内网

公司内部：员工用内网IP（192.168.1.x）
对外访问：通过公司网关统一出去
外部访问：需要端口转发才能进来

虚拟机内网IP：192.168.122.x
对外访问：通过宿主机IP出去
外部访问：需要配置端口转发
```

**查看默认NAT网络**：
```bash
# 查看网络列表
virsh net-list --all

# 查看默认网络配置
virsh net-dumpxml default

# 查看网络信息
virsh net-info default
```

**默认网络配置解析**：
```xml
<network>
  <name>default</name>
  <bridge name='virbr0' stp='on' delay='0'/>
  <ip address='192.168.122.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.122.2' end='192.168.122.254'/>
    </dhcp>
  </ip>
</network>
```

**NAT网络特点**：
- ✅ **虚拟机可上网**：通过宿主机访问外网
- ✅ **自动分配IP**：DHCP自动分配IP地址
- ✅ **安全隔离**：外网无法直接访问虚拟机
- ❌ **外部访问困难**：需要端口转发

#### 🌉 桥接网络


**什么是桥接网络**：
```
桥接网络 = 虚拟机直接接入物理网络

类比理解：
物理网络 = 真实的网线
桥接 = 网线分接器

虚拟机就像直接插网线到路由器上
获得和宿主机同级别的网络地址
```

**创建桥接网络**：

🔸 **1. 创建网桥设备**
```bash
# 创建网桥配置文件
cat > /etc/sysconfig/network-scripts/ifcfg-br0 << EOF
TYPE=Bridge
BOOTPROTO=dhcp
DEVICE=br0
ONBOOT=yes
EOF

# 修改物理网卡配置
cat > /etc/sysconfig/network-scripts/ifcfg-eth0 << EOF
TYPE=Ethernet
BOOTPROTO=none
DEVICE=eth0
ONBOOT=yes
BRIDGE=br0
EOF

# 重启网络
systemctl restart network
```

🔸 **2. 创建libvirt桥接网络**
```bash
# 创建桥接网络XML
cat > bridge-network.xml << EOF
<network>
  <name>bridge-net</name>
  <forward mode='bridge'/>
  <bridge name='br0'/>
</network>
EOF

# 定义并启动网络
virsh net-define bridge-network.xml
virsh net-start bridge-net
virsh net-autostart bridge-net
```

**桥接网络特点**：
- ✅ **外部可直接访问**：虚拟机获得公网IP
- ✅ **性能最好**：网络性能接近物理机
- ✅ **配置简单**：虚拟机网络配置和物理机一样
- ❌ **IP地址消耗多**：每个虚拟机占用一个IP

#### 🔗 仅主机网络


**创建仅主机网络**：
```xml
<network>
  <name>host-only</name>
  <bridge name='virbr1'/>
  <ip address='192.168.100.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.100.2' end='192.168.100.254'/>
    </dhcp>
  </ip>
</network>
```

**仅主机网络特点**：
- ✅ **虚拟机间通信**：虚拟机可以互相访问
- ✅ **主机可访问虚拟机**：宿主机可以访问虚拟机
- ❌ **无法访问外网**：虚拟机无法上网
- ✅ **安全隔离**：完全隔离的内部网络

### 8.3 网络管理操作


**基本网络操作**：
```bash
# 启动网络
virsh net-start default

# 停止网络
virsh net-destroy default

# 设置网络自启动
virsh net-autostart default

# 禁用网络自启动
virsh net-autostart --disable default

# 删除网络定义
virsh net-undefine custom-net
```

**查看网络状态**：
```bash
# 查看网络列表
virsh net-list --all

# 查看网络详细信息
virsh net-info default

# 查看连接到网络的虚拟机
virsh net-dhcp-leases default

# 查看网络XML配置
virsh net-dumpxml default
```

**网络配置修改**：
```bash
# 编辑网络配置
virsh net-edit default

# 导出网络配置
virsh net-dumpxml default > default-net.xml

# 从XML重新定义网络
virsh net-define default-net.xml
```

### 8.4 DHCP与DNS配置


**DHCP配置详解**：
```xml
<network>
  <name>custom-net</name>
  <bridge name='virbr2'/>
  <ip address='192.168.200.1' netmask='255.255.255.0'>
    <dhcp>
      <!-- DHCP地址池 -->
      <range start='192.168.200.100' end='192.168.200.200'/>
      
      <!-- 静态IP分配 -->
      <host mac='52:54:00:12:34:56' name='server1' ip='192.168.200.10'/>
      <host mac='52:54:00:12:34:57' name='server2' ip='192.168.200.11'/>
      
      <!-- DHCP选项 -->
      <bootp file='/pxelinux.0' server='192.168.200.1'/>
    </dhcp>
  </ip>
</network>
```

**DNS配置**：
```xml
<network>
  <name>dns-net</name>
  <bridge name='virbr3'/>
  <dns>
    <!-- 自定义DNS记录 -->
    <host ip='192.168.200.10'>
      <hostname>server1.local</hostname>
      <hostname>web.local</hostname>
    </host>
    
    <!-- 转发DNS查询 -->
    <forwarder addr='8.8.8.8'/>
    <forwarder addr='8.8.4.4'/>
  </dns>
  <ip address='192.168.200.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.200.2' end='192.168.200.254'/>
    </dhcp>
  </ip>
</network>
```

### 8.5 端口转发配置


**NAT网络端口转发**：
```bash
# 添加iptables规则转发端口
# 将宿主机8080端口转发到虚拟机192.168.122.10的80端口
iptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to-destination 192.168.122.10:80
iptables -A FORWARD -p tcp -d 192.168.122.10 --dport 80 -j ACCEPT

# 保存iptables规则
service iptables save
```

**使用firewalld配置端口转发**：
```bash
# 启用IP转发
echo 1 > /proc/sys/net/ipv4/ip_forward
echo 'net.ipv4.ip_forward = 1' >> /etc/sysctl.conf

# 添加firewalld端口转发规则
firewall-cmd --permanent --add-forward-port=port=8080:proto=tcp:toaddr=192.168.122.10:toport=80
firewall-cmd --reload
```

### 8.6 虚拟机网卡配置


**虚拟机XML中的网络配置**：
```xml
<devices>
  <!-- NAT网络接口 -->
  <interface type='network'>
    <mac address='52:54:00:12:34:56'/>
    <source network='default'/>
    <model type='virtio'/>
  </interface>
  
  <!-- 桥接网络接口 -->
  <interface type='bridge'>
    <mac address='52:54:00:12:34:57'/>
    <source bridge='br0'/>
    <model type='virtio'/>
  </interface>
  
  <!-- 直连网络接口 -->
  <interface type='direct'>
    <mac address='52:54:00:12:34:58'/>
    <source dev='eth0' mode='bridge'/>
    <model type='virtio'/>
  </interface>
</devices>
```

**网卡模型选择**：

| 模型 | **特点** | **性能** | **兼容性** | **适用场景** |
|------|---------|---------|-----------|-------------|
| `virtio` | `半虚拟化，性能最好` | `高` | `需要驱动支持` | `Linux虚拟机` |
| `e1000` | `模拟Intel网卡` | `中` | `兼容性最好` | `Windows虚拟机` |
| `rtl8139` | `模拟Realtek网卡` | `低` | `所有系统支持` | `老旧系统` |

**在线修改网络配置**：
```bash
# 给运行中的虚拟机添加网卡
virsh attach-interface centos7 --type network --source default --model virtio --live --config

# 删除网卡
virsh detach-interface centos7 --type network --mac 52:54:00:12:34:56 --live --config

# 修改网卡链接状态
virsh domif-setlink centos7 52:54:00:12:34:56 up
virsh domif-setlink centos7 52:54:00:12:34:56 down
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 libvirt架构：统一虚拟化管理框架，提供标准API接口
🔸 libvirtd守护进程：核心服务进程，负责虚拟机实际管理
🔸 virsh工具：命令行管理工具，功能最全面
🔸 XML配置：标准化虚拟机定义格式，跨平台兼容
🔸 连接URI：指定管理范围和权限级别
🔸 存储管理：池和卷的两级存储架构
🔸 网络管理：支持NAT、桥接、仅主机等多种网络模式
```

### 9.2 关键理解要点


**🔹 libvirt的价值**
```
统一性：一套工具管理所有虚拟化技术
标准化：XML配置格式，便于迁移和自动化
抽象化：简化复杂的虚拟化操作
生态化：丰富的工具和API支持
```

**🔹 系统级vs用户级的选择**
```
生产环境 → qemu:///system
- 完整功能，高性能
- 需要root权限管理

开发环境 → qemu:///session  
- 安全隔离，权限受限
- 普通用户即可使用
```

**🔹 存储和网络的设计思路**
```
存储：池（管理） + 卷（使用）
- 池提供统一管理接口
- 卷是实际的存储单元

网络：多种模式适应不同场景
- NAT：安全但需端口转发
- 桥接：性能好但消耗IP
- 仅主机：隔离但无外网
```

### 9.3 实际应用指导


**🎯 日常管理流程**
```bash
# 虚拟机生命周期
1. 定义虚拟机：virsh define vm.xml
2. 启动虚拟机：virsh start vm-name  
3. 日常管理：virsh list, virsh console
4. 关闭虚拟机：virsh shutdown vm-name
5. 删除虚拟机：virsh undefine vm-name
```

**🔧 故障排查步骤**
```bash
# 检查服务状态
systemctl status libvirtd

# 检查虚拟机状态  
virsh list --all
virsh domstate vm-name

# 查看日志
journalctl -u libvirtd
tail -f /var/log/libvirt/qemu/vm-name.log
```

**⚡ 性能优化建议**
```
存储优化：
- 生产环境使用raw格式
- 合理配置缓存策略
- 使用SSD存储

网络优化：
- 使用virtio网卡模型
- 桥接网络性能最佳
- 避免网络瓶颈

资源优化：
- CPU绑定提升性能
- 内存大页减少延迟
- NUMA拓扑优化
```

### 9.4 最佳实践建议


**🏗️ 环境规划**
- **开发测试**：使用session模式，NAT网络
- **生产部署**：使用system模式，桥接网络
- **存储规划**：分离系统盘和数据盘
- **网络规划**：合理设计IP地址段

**🔒 安全考虑**
- 启用SELinux/AppArmor增强安全
- 定期更新libvirt和QEMU版本
- 使用TLS加密远程连接
- 备份重要虚拟机配置

**📈 监控运维**
- 监控libvirtd服务状态
- 定期检查存储池使用情况
- 监控虚拟机资源使用
- 建立虚拟机备份策略

**核心记忆**：
- libvirt是虚拟化的统一管理平台
- virsh是最重要的命令行工具
- XML配置是虚拟机的"身份证"
- 连接URI决定管理范围和权限
- 存储池管理空间，存储卷提供磁盘
- 网络模式要根据实际需求选择