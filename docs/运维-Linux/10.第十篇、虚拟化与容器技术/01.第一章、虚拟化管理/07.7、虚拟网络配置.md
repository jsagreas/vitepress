---
title: 7、虚拟网络配置
---
## 📚 目录

1. [虚拟网络概述](#1-虚拟网络概述)
2. [libvirt虚拟网络类型详解](#2-libvirt虚拟网络类型详解)
3. [Linux bridge网桥配置与管理](#3-linux-bridge网桥配置与管理)
4. [TAP/TUN接口创建与配置](#4-tap-tun接口创建与配置)
5. [虚拟机网络隔离与VLAN配置](#5-虚拟机网络隔离与vlan配置)
6. [virtio-net网络性能优化](#6-virtio-net网络性能优化)
7. [网络QoS限速配置](#7-网络qos限速配置)
8. [虚拟机间网络通信配置](#8-虚拟机间网络通信配置)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🌐 虚拟网络概述


### 1.1 什么是虚拟网络


**虚拟网络**就像在一台物理机器上搭建了多个"假的"网络环境，让虚拟机能够像真实的计算机一样进行网络通信。

```
物理世界的网络：
电脑 ←→ 网线 ←→ 路由器 ←→ 互联网

虚拟世界的网络：
虚拟机 ←→ 虚拟网卡 ←→ 虚拟交换机 ←→ 物理网卡 ←→ 外部网络
```

**为什么需要虚拟网络？**
- **隔离性**：不同虚拟机之间网络互不影响
- **灵活性**：可以随意创建、删除、修改网络配置
- **安全性**：可以控制虚拟机的网络访问权限
- **测试便利**：模拟复杂网络环境进行测试

### 1.2 虚拟网络架构


```
┌─────────────────────────────────────────────────┐
│                宿主机系统                         │
├─────────────────────────────────────────────────┤
│  虚拟机1      虚拟机2      虚拟机3               │
│    │           │           │                   │
│  虚拟网卡    虚拟网卡    虚拟网卡               │
│    │           │           │                   │
│    └───────────┼───────────┘                   │
│                │                               │
│          虚拟交换机/网桥                        │
│                │                               │
│          物理网卡接口                          │
└─────────────────────────────────────────────────┘
                 │
            物理网络/互联网
```

**核心组件说明：**
- **虚拟网卡**：虚拟机的网络接口，相当于真实电脑的网卡
- **虚拟交换机/网桥**：连接多个虚拟网卡的设备，类似物理交换机
- **物理网卡**：宿主机的真实网卡，连接外部网络

---

## 2. 🔀 libvirt虚拟网络类型详解


### 2.1 NAT网络模式


**什么是NAT网络？**
NAT（Network Address Translation，网络地址转换）就像家用路由器一样，虚拟机通过宿主机的IP地址访问外网。

```
外部网络视角：
互联网 ←→ 宿主机IP(192.168.1.100) 

内部网络视角：
虚拟机1(192.168.122.10) ┐
虚拟机2(192.168.122.11) ├→ NAT设备 ←→ 宿主机网卡
虚拟机3(192.168.122.12) ┘
```

**🎯 NAT网络特点：**
- ✅ **虚拟机能上网**：可以访问互联网
- ✅ **安全性好**：外部无法直接访问虚拟机
- ❌ **外部不可访问**：需要端口转发才能从外部访问虚拟机服务
- 🔸 **适用场景**：个人学习、开发测试环境

**创建NAT网络：**

```bash
# 查看默认NAT网络
virsh net-list

# 查看默认网络详情
virsh net-dumpxml default
```

**默认NAT网络配置示例：**
```xml
<network>
  <name>default</name>
  <forward mode='nat'/>
  <bridge name='virbr0'/>
  <ip address='192.168.122.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.122.2' end='192.168.122.254'/>
    </dhcp>
  </ip>
</network>
```

### 2.2 Bridge桥接模式


**什么是Bridge桥接？**
桥接模式就像把虚拟机直接连到物理网络上，虚拟机获得和宿主机同一网段的IP地址。

```
网络拓扑：
路由器(192.168.1.1) ←→ 物理交换机
                         ↓
    ┌─────────────────────────────────────┐
    │  宿主机(192.168.1.100)              │
    │      ↓                             │
    │  Linux Bridge                      │
    │      ↓                             │
    │  虚拟机(192.168.1.101/102/103)      │
    └─────────────────────────────────────┘
```

**🎯 Bridge网络特点：**
- ✅ **完全网络访问**：虚拟机就像独立的物理机
- ✅ **外部可直接访问**：可以直接SSH到虚拟机
- ✅ **性能好**：网络性能接近物理机
- ❌ **占用IP地址**：需要消耗路由器的IP地址池
- 🔸 **适用场景**：生产环境、服务器虚拟化

**创建Bridge网络：**

```bash
# 创建桥接网络配置文件
cat > bridge-network.xml << EOF
<network>
  <name>br0</name>
  <forward mode="bridge"/>
  <bridge name="br0"/>
</network>
EOF

# 定义并启动网络
virsh net-define bridge-network.xml
virsh net-start br0
virsh net-autostart br0
```

### 2.3 Host-only仅主机模式


**什么是Host-only？**
仅主机模式创建一个只有宿主机和虚拟机参与的封闭网络，虚拟机无法访问外部网络。

```
网络隔离示意：
┌─────────────────────────────────────┐
│           宿主机                    │
│                                     │
│  虚拟机1 ←→ 虚拟机2 ←→ 虚拟机3       │
│     ↑         ↑         ↑          │
│     └─────────┼─────────┘          │
│               ↓                     │
│        Host-only网络                │
│      (192.168.56.0/24)             │
└─────────────────────────────────────┘
    ↑
外部网络访问被阻断
```

**🎯 Host-only网络特点：**
- ✅ **完全隔离**：虚拟机无法访问外网，外网也无法访问虚拟机
- ✅ **内部通信**：宿主机和虚拟机之间可以通信
- ✅ **安全性极高**：适合敏感环境测试
- ❌ **无外网访问**：无法下载软件或更新
- 🔸 **适用场景**：安全测试、恶意软件分析

**创建Host-only网络：**

```bash
cat > hostonly-network.xml << EOF
<network>
  <name>isolated</name>
  <bridge name='virbr1'/>
  <ip address='192.168.56.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.56.2' end='192.168.56.254'/>
    </dhcp>
  </ip>
</network>
EOF

virsh net-define hostonly-network.xml
virsh net-start isolated
```

### 2.4 网络类型对比


| 网络类型 | **外网访问** | **外部访问VM** | **VM间通信** | **IP地址** | **适用场景** |
|---------|------------|--------------|------------|-----------|------------|
| 🌐 **NAT** | `✅可以访问` | `❌需端口转发` | `✅同网段可通信` | `私有IP` | `学习开发` |
| 🌉 **Bridge** | `✅可以访问` | `✅直接访问` | `✅可通信` | `公网IP` | `生产环境` |
| 🏠 **Host-only** | `❌无法访问` | `❌无法访问` | `✅可通信` | `私有IP` | `安全测试` |

---

## 3. 🌉 Linux bridge网桥配置与管理


### 3.1 什么是Linux网桥


**Linux网桥**就像一个虚拟的交换机，可以连接多个网络接口，让数据在它们之间转发。

```
传统交换机：
设备1 ←→ [物理交换机] ←→ 设备2

Linux网桥：
虚拟机1 ←→ [软件网桥] ←→ 虚拟机2
              ↓
            物理网卡
```

### 3.2 网桥基本操作


**查看现有网桥：**
```bash
# 查看所有网桥
brctl show

# 查看详细网桥信息
ip link show type bridge
```

**创建和配置网桥：**

```bash
# 创建网桥
sudo brctl addbr br0

# 将物理网卡添加到网桥
sudo brctl addif br0 eth0

# 启用网桥
sudo ip link set dev br0 up

# 配置网桥IP地址
sudo ip addr add 192.168.1.100/24 dev br0
```

**删除网桥：**
```bash
# 从网桥移除接口
sudo brctl delif br0 eth0

# 关闭网桥
sudo ip link set dev br0 down

# 删除网桥
sudo brctl delbr br0
```

### 3.3 永久性网桥配置


**Ubuntu/Debian系统配置文件：**
```bash
# 编辑网络配置
sudo vim /etc/netplan/01-network-manager-all.yaml
```

```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: no
  bridges:
    br0:
      dhcp4: yes
      interfaces:
        - eth0
```

**CentOS/RHEL系统配置：**
```bash
# 物理网卡配置
cat > /etc/sysconfig/network-scripts/ifcfg-eth0 << EOF
DEVICE=eth0
ONBOOT=yes
BRIDGE=br0
EOF

# 网桥配置
cat > /etc/sysconfig/network-scripts/ifcfg-br0 << EOF
DEVICE=br0
TYPE=Bridge
ONBOOT=yes
BOOTPROTO=dhcp
EOF
```

### 3.4 网桥高级配置


**STP（生成树协议）配置：**
```bash
# 启用STP防止网络环路
sudo brctl stp br0 on

# 设置网桥优先级
sudo brctl setbridgeprio br0 32768

# 设置端口开销
sudo brctl setpathcost br0 eth0 100
```

**网桥转发延迟配置：**
```bash
# 设置转发延迟（秒）
sudo brctl setfd br0 0

# 设置最大存活时间
sudo brctl setmaxage br0 20
```

---

## 4. 🔌 TAP/TUN接口创建与配置


### 4.1 TAP和TUN的区别


**TUN接口**：工作在网络层（第3层），处理IP数据包
**TAP接口**：工作在数据链路层（第2层），处理以太网帧

```
网络层次对比：
应用层数据
    ↓
[TUN接口] → IP数据包 → 用户空间程序
    ↓
[TAP接口] → 以太网帧 → 用户空间程序
```

简单理解：
- **TUN**：像一个虚拟的路由器接口
- **TAP**：像一个虚拟的网卡接口

### 4.2 创建TAP接口


**手动创建TAP接口：**
```bash
# 创建TAP接口
sudo ip tuntap add dev tap0 mode tap

# 启用接口
sudo ip link set tap0 up

# 配置IP地址
sudo ip addr add 192.168.10.1/24 dev tap0

# 查看接口状态
ip link show tap0
```

**将TAP接口添加到网桥：**
```bash
# 创建网桥
sudo brctl addbr br0

# 将TAP接口添加到网桥
sudo brctl addif br0 tap0

# 启用网桥
sudo ip link set br0 up
```

### 4.3 TUN接口配置


**创建TUN接口：**
```bash
# 创建TUN接口
sudo ip tuntap add dev tun0 mode tun

# 配置TUN接口
sudo ip addr add 10.0.0.1/24 dev tun0
sudo ip link set tun0 up

# 添加路由
sudo ip route add 10.0.0.0/24 dev tun0
```

### 4.4 持久化配置


**systemd服务配置：**
```bash
# 创建服务文件
sudo cat > /etc/systemd/system/tap0.service << EOF
[Unit]
Description=TAP interface tap0
After=network.target

[Service]
Type=oneshot
ExecStart=/sbin/ip tuntap add dev tap0 mode tap
ExecStart=/sbin/ip link set tap0 up
ExecStop=/sbin/ip link set tap0 down
ExecStop=/sbin/ip tuntap del dev tap0 mode tap
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# 启用服务
sudo systemctl enable tap0.service
sudo systemctl start tap0.service
```

---

## 5. 🔒 虚拟机网络隔离与VLAN配置


### 5.1 网络隔离的重要性


**为什么需要网络隔离？**
- **安全性**：防止不同部门的虚拟机互相访问
- **性能**：避免网络广播风暴影响性能
- **管理**：便于网络流量监控和管理

```
隔离前：
VM1 ←→ VM2 ←→ VM3 ←→ VM4   # 所有虚拟机在同一网络

隔离后：
VM1 ←→ VM2    [开发环境]
VM3 ←→ VM4    [测试环境]
```

### 5.2 VLAN基础概念


**VLAN（Virtual LAN，虚拟局域网）** 就像在一个物理交换机上创建多个逻辑上独立的交换机。

```
物理网络：
┌─────────────────────────────────┐
│        物理交换机                │
│  ┌─────────┐    ┌─────────┐     │
│  │ VLAN 10 │    │ VLAN 20 │     │
│  │ VM1-VM2 │    │ VM3-VM4 │     │
│  └─────────┘    └─────────┘     │
└─────────────────────────────────┘
```

**VLAN的作用：**
- **逻辑隔离**：同一VLAN内的设备可以通信，不同VLAN之间隔离
- **广播域控制**：限制广播包的传播范围
- **安全性提升**：网络分段减少攻击面

### 5.3 libvirt中的VLAN配置


**虚拟机网卡VLAN标签配置：**

```xml
<interface type='bridge'>
  <mac address='52:54:00:12:34:56'/>
  <source bridge='br0'/>
  <vlan>
    <tag id='100'/>
  </vlan>
  <model type='virtio'/>
</interface>
```

**多VLAN标签配置：**
```xml
<interface type='bridge'>
  <source bridge='br0'/>
  <vlan trunk='yes'>
    <tag id='100'/>
    <tag id='200'/>
    <tag id='300'/>
  </vlan>
</interface>
```

### 5.4 基于iptables的网络隔离


**创建隔离规则：**
```bash
# 创建自定义链
sudo iptables -N VM_ISOLATION

# 禁止VLAN 100和VLAN 200之间通信
sudo iptables -A VM_ISOLATION -s 192.168.100.0/24 -d 192.168.200.0/24 -j DROP
sudo iptables -A VM_ISOLATION -s 192.168.200.0/24 -d 192.168.100.0/24 -j DROP

# 应用隔离规则
sudo iptables -A FORWARD -j VM_ISOLATION
```

**允许特定服务通信：**
```bash
# 允许VLAN 100访问VLAN 200的HTTP服务
sudo iptables -I VM_ISOLATION -s 192.168.100.0/24 -d 192.168.200.0/24 -p tcp --dport 80 -j ACCEPT
```

---

## 6. ⚡ virtio-net网络性能优化


### 6.1 什么是virtio-net


**virtio-net** 是专门为虚拟化环境设计的高性能网络驱动程序，相比传统的模拟网卡（如e1000），性能提升显著。

```
传统网卡模拟：
虚拟机 → 模拟硬件层 → 宿主机内核 → 物理网卡
       (性能损耗大)

virtio-net：
虚拟机 → virtio驱动 → 宿主机内核 → 物理网卡
       (直接通信，性能好)
```

### 6.2 virtio-net配置


**在虚拟机配置中启用virtio-net：**

```xml
<interface type='bridge'>
  <mac address='52:54:00:12:34:56'/>
  <source bridge='br0'/>
  <model type='virtio'/>
  <driver name='vhost' txmode='iothread' ioeventfd='on' event_idx='off' queues='4'/>
</interface>
```

**配置参数说明：**
- `txmode='iothread'`：使用IO线程处理发送队列
- `ioeventfd='on'`：启用事件文件描述符，减少虚拟化开销
- `event_idx='off'`：关闭事件索引（某些情况下提升性能）
- `queues='4'`：启用多队列（根据虚拟机CPU核数配置）

### 6.3 多队列网络优化


**为什么需要多队列？**
- **并行处理**：多个CPU核心可以同时处理网络数据
- **减少锁竞争**：每个队列独立处理，减少CPU之间的竞争

```bash
# 查看网卡队列数
ethtool -l eth0

# 设置网卡队列数（在虚拟机内）
ethtool -L eth0 combined 4
```

**在虚拟机内优化网络：**
```bash
# 调整网卡缓冲区大小
ethtool -G eth0 rx 1024 tx 1024

# 启用网卡的卸载功能
ethtool -K eth0 gso on tso on
```

### 6.4 宿主机网络优化


**调整网络缓冲区：**
```bash
# 增大接收缓冲区
echo 'net.core.rmem_max = 16777216' >> /etc/sysctl.conf
echo 'net.core.rmem_default = 262144' >> /etc/sysctl.conf

# 增大发送缓冲区  
echo 'net.core.wmem_max = 16777216' >> /etc/sysctl.conf
echo 'net.core.wmem_default = 262144' >> /etc/sysctl.conf

# 应用设置
sysctl -p
```

**CPU亲和性设置：**
```bash
# 将网卡中断绑定到特定CPU
echo 2 > /proc/irq/24/smp_affinity

# 或使用irqbalance自动平衡
systemctl enable irqbalance
systemctl start irqbalance
```

---

## 7. 🚦 网络QoS限速配置


### 7.1 什么是网络QoS


**QoS（Quality of Service，服务质量）** 就像交通管制，控制不同虚拟机的网络带宽使用，确保重要服务获得足够的网络资源。

```
无QoS限制：
VM1: ████████████████████ (占用大量带宽)
VM2: ██                   (带宽不足)
VM3: █                    (几乎无带宽)

有QoS限制：
VM1: ████████             (限制在合理范围)
VM2: ████████             (保证基础带宽)
VM3: ████████             (保证基础带宽)
```

### 7.2 libvirt网络QoS配置


**在虚拟机网卡上配置带宽限制：**

```xml
<interface type='bridge'>
  <source bridge='br0'/>
  <bandwidth>
    <inbound average='1000' peak='5000' burst='5120'/>
    <outbound average='128' peak='256' burst='256'/>
  </bandwidth>
</interface>
```

**参数说明：**
- `average`：平均速率（KB/s）
- `peak`：峰值速率（KB/s）  
- `burst`：突发大小（KB）

**在网络上配置整体QoS：**
```xml
<network>
  <name>limited</name>
  <forward mode='nat'/>
  <bridge name='virbr1'/>
  <bandwidth>
    <inbound average='1000' peak='2000'/>
    <outbound average='1000' peak='2000'/>
  </bandwidth>
  <ip address='192.168.100.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.100.2' end='192.168.100.254'/>
    </dhcp>
  </ip>
</network>
```

### 7.3 使用tc工具进行流量控制


**基本的限速配置：**
```bash
# 为网卡添加根队列规则
sudo tc qdisc add dev tap0 root handle 1: htb default 10

# 创建根类
sudo tc class add dev tap0 parent 1: classid 1:1 htb rate 10mbit

# 创建子类（限速到1Mbit）
sudo tc class add dev tap0 parent 1:1 classid 1:10 htb rate 1mbit ceil 2mbit

# 添加过滤规则
sudo tc filter add dev tap0 protocol ip parent 1: prio 1 u32 match ip dst 192.168.1.100 flowid 1:10
```

**查看和删除规则：**
```bash
# 查看队列规则
sudo tc qdisc show dev tap0

# 查看类规则
sudo tc class show dev tap0

# 删除所有规则
sudo tc qdisc del dev tap0 root
```

### 7.4 网络流量监控


**实时监控网络使用：**
```bash
# 监控网卡流量
iftop -i br0

# 查看详细网络统计
cat /proc/net/dev

# 使用vnstat长期监控
vnstat -i br0 -h
```

---

## 8. 🤝 虚拟机间网络通信配置


### 8.1 同网段虚拟机通信


**基本配置要求：**
- 虚拟机连接到同一个虚拟网络
- IP地址在同一网段
- 防火墙允许相互通信

```bash
# 创建共享网络
cat > shared-network.xml << EOF
<network>
  <name>vmnet</name>
  <forward mode='nat'/>
  <bridge name='virbr2'/>
  <ip address='10.0.0.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='10.0.0.10' end='10.0.0.100'/>
    </dhcp>
  </ip>
</network>
EOF

virsh net-define shared-network.xml
virsh net-start vmnet
```

**虚拟机网络配置：**
```xml
<!-- VM1配置 -->
<interface type='network'>
  <source network='vmnet'/>
  <model type='virtio'/>
</interface>

<!-- VM2配置 -->
<interface type='network'>
  <source network='vmnet'/>
  <model type='virtio'/>
</interface>
```

### 8.2 跨网段虚拟机通信


**配置路由转发：**
```bash
# 在宿主机上启用IP转发
echo 1 > /proc/sys/net/ipv4/ip_forward
echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf

# 添加路由规则
sudo iptables -A FORWARD -i virbr1 -o virbr2 -j ACCEPT
sudo iptables -A FORWARD -i virbr2 -o virbr1 -j ACCEPT
```

**在虚拟机中添加路由：**
```bash
# VM1中添加到VM2网段的路由
sudo ip route add 192.168.200.0/24 via 192.168.100.1

# VM2中添加到VM1网段的路由  
sudo ip route add 192.168.100.0/24 via 192.168.200.1
```

### 8.3 配置虚拟机集群网络


**创建多个网络接口：**
```xml
<interface type='network'>
  <source network='management'/>  <!-- 管理网络 -->
  <model type='virtio'/>
</interface>
<interface type='network'>
  <source network='storage'/>     <!-- 存储网络 -->
  <model type='virtio'/>
</interface>
<interface type='network'>
  <source network='cluster'/>     <!-- 集群通信网络 -->
  <model type='virtio'/>
</interface>
```

**网络规划示例：**
```
管理网络：192.168.1.0/24   (SSH、监控)
存储网络：10.0.1.0/24      (数据传输)
集群网络：10.0.2.0/24      (心跳、同步)
```

### 8.4 网络故障排查


**常用排查命令：**
```bash
# 检查网络连通性
ping 192.168.1.100

# 检查路由表
ip route show

# 检查网桥状态
brctl show

# 检查防火墙规则
iptables -L -n

# 检查网卡状态
ip link show

# 抓取网络包
tcpdump -i br0 -n
```

**🔧 常见问题解决：**

> **问题1**：虚拟机无法获取IP地址
> 
> **解决方案**：检查DHCP服务是否运行，网络是否正确启动

```bash
virsh net-list --all
virsh net-start default
```

> **问题2**：虚拟机之间无法通信
> 
> **解决方案**：检查防火墙和路由配置

```bash
# 临时关闭防火墙测试
systemctl stop firewalld
```

> **问题3**：网络性能差
> 
> **解决方案**：检查是否使用了virtio网络驱动

```bash
# 在虚拟机中查看网卡类型
lspci | grep -i ethernet
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 虚拟网络本质：软件模拟的网络环境，提供网络隔离和管理能力
🔸 网络类型选择：NAT适合学习，Bridge适合生产，Host-only适合隔离测试
🔸 网桥作用：连接多个虚拟网络接口的虚拟交换机
🔸 TAP/TUN区别：TAP工作在链路层，TUN工作在网络层
🔸 virtio-net优势：专为虚拟化优化的高性能网络驱动
```

### 9.2 关键配置要点


**🔹 网络类型选择原则：**
```
学习环境：使用NAT网络，安全简单
开发测试：使用Bridge网络，方便外部访问  
生产环境：使用Bridge网络配合VLAN隔离
安全测试：使用Host-only网络完全隔离
```

**🔹 性能优化关键点：**
```
网卡驱动：优先选择virtio-net
多队列：根据CPU核数配置网络队列
缓冲区：适当增大网络缓冲区大小
CPU绑定：避免网络中断和虚拟机CPU冲突
```

**🔹 网络安全考虑：**
```
网络隔离：使用VLAN或iptables规则隔离不同业务
访问控制：配置防火墙规则限制网络访问
流量监控：定期检查网络流量和异常连接
定期更新：保持虚拟化软件和网络驱动最新
```

### 9.3 实际应用指导


**🎯 典型应用场景：**

- **开发环境**：NAT网络 + 端口转发，安全且便于管理
- **测试集群**：Bridge网络 + VLAN隔离，模拟生产环境
- **生产服务**：Bridge网络 + QoS限速，保证服务质量
- **安全研究**：Host-only网络 + 流量分析，完全隔离

**🔧 运维最佳实践：**

```
网络规划：
- 提前规划IP地址分配和VLAN设计
- 预留足够的网络带宽和IP地址空间
- 文档记录网络拓扑和配置信息

性能监控：
- 定期监控网络带宽使用情况
- 关注虚拟机网络延迟和丢包率  
- 及时调整QoS配置和网络参数

故障处理：
- 建立网络故障排查流程
- 准备网络配置备份和恢复方案
- 训练团队掌握基本网络排查技能
```

**核心记忆要点：**
- 虚拟网络是软件定义的网络环境，灵活性强但需要合理规划
- 网络类型选择要根据安全性、性能和管理需求综合考虑
- virtio-net是虚拟化网络性能优化的关键技术
- 网络隔离和QoS配置是多租户环境的必备技能
- 网络故障排查需要系统性的方法和丰富的实践经验