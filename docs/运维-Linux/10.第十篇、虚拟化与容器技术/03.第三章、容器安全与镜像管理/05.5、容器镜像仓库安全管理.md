---
title: 5ã€å®¹å™¨é•œåƒä»“åº“å®‰å…¨ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [ç§æœ‰é•œåƒä»“åº“å®‰å…¨é…ç½®](#1-ç§æœ‰é•œåƒä»“åº“å®‰å…¨é…ç½®)
2. [é•œåƒè®¿é—®æƒé™æ§åˆ¶](#2-é•œåƒè®¿é—®æƒé™æ§åˆ¶)
3. [é•œåƒä¼ è¾“åŠ å¯†é…ç½®](#3-é•œåƒä¼ è¾“åŠ å¯†é…ç½®)
4. [é•œåƒä»“åº“èº«ä»½è®¤è¯æœºåˆ¶](#4-é•œåƒä»“åº“èº«ä»½è®¤è¯æœºåˆ¶)
5. [é•œåƒå®Œæ•´æ€§éªŒè¯](#5-é•œåƒå®Œæ•´æ€§éªŒè¯)
6. [é•œåƒä»“åº“å®¡è®¡æ—¥å¿—](#6-é•œåƒä»“åº“å®¡è®¡æ—¥å¿—)
7. [é•œåƒæ¸…ç†ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†](#7-é•œåƒæ¸…ç†ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†)
8. [é•œåƒä»“åº“é«˜å¯ç”¨å®‰å…¨æ¶æ„](#8-é•œåƒä»“åº“é«˜å¯ç”¨å®‰å…¨æ¶æ„)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ ç§æœ‰é•œåƒä»“åº“å®‰å…¨é…ç½®


### 1.1 ç§æœ‰ä»“åº“åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯ç§æœ‰é•œåƒä»“åº“ï¼Ÿ**
> ç§æœ‰é•œåƒä»“åº“å°±åƒä¼ä¸šå†…éƒ¨çš„"è½¯ä»¶å•†åº—"ï¼Œåªæœ‰å…¬å¸å†…éƒ¨å‘˜å·¥å¯ä»¥è¿›å…¥ï¼Œå­˜æ”¾ç€ä¼ä¸šä¸“æœ‰çš„åº”ç”¨ç¨‹åº"å•†å“"ï¼Œå¤–äººæ— æ³•è®¿é—®ã€‚

```
å…¬æœ‰ä»“åº“ vs ç§æœ‰ä»“åº“å¯¹æ¯”ï¼š

å…¬æœ‰ä»“åº“(Docker Hub)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    äº’è”ç½‘ç”¨æˆ·    â”‚ â†’ ä»»ä½•äººéƒ½èƒ½è®¿é—®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å¼€æºé•œåƒåº“     â”‚ â†’ nginxã€mysqlç­‰å…¬å¼€é•œåƒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç§æœ‰ä»“åº“(ä¼ä¸šå†…éƒ¨)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¼ä¸šå‘˜å·¥only   â”‚ â†’ éœ€è¦è®¤è¯æ‰èƒ½è®¿é—®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¼ä¸šä¸“æœ‰é•œåƒ    â”‚ â†’ å…¬å¸å†…éƒ¨ä¸šåŠ¡é•œåƒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç§æœ‰ä»“åº“çš„æ ¸å¿ƒä»·å€¼ï¼š**
- ğŸ” **å®‰å…¨éš”ç¦»**ï¼šæ•æ„Ÿä»£ç ä¸ä¼šæš´éœ²åˆ°å…¬ç½‘
- ğŸ“ˆ **ç‰ˆæœ¬æ§åˆ¶**ï¼šç»Ÿä¸€ç®¡ç†ä¼ä¸šåº”ç”¨ç‰ˆæœ¬
- ğŸš€ **éƒ¨ç½²æ•ˆç‡**ï¼šå†…ç½‘ä¼ è¾“é€Ÿåº¦å¿«
- ğŸ›¡ï¸ **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³ä¼ä¸šå®‰å…¨æ”¿ç­–

### 1.2 Harborç§æœ‰ä»“åº“éƒ¨ç½²


**Harboré€‰æ‹©ç†ç”±**
> Harboræ˜¯ç›®å‰æœ€æˆç†Ÿçš„ä¼ä¸šçº§ç§æœ‰ä»“åº“è§£å†³æ–¹æ¡ˆï¼Œå°±åƒ"é“¶è¡Œçº§åˆ«çš„ä¿é™©ç®±"ï¼Œæä¾›å®Œæ•´çš„å®‰å…¨åŠŸèƒ½ã€‚

#### ğŸ”§ HarboråŸºç¡€éƒ¨ç½²


```bash
# ä¸‹è½½Harborå®‰è£…åŒ…
wget https://github.com/goharbor/harbor/releases/download/v2.8.0/harbor-offline-installer-v2.8.0.tgz

# è§£å‹å¹¶é…ç½®
tar -xzf harbor-offline-installer-v2.8.0.tgz
cd harbor/
cp harbor.yml.tmpl harbor.yml
```

**æ ¸å¿ƒé…ç½®æ–‡ä»¶è¯´æ˜ï¼š**

```yaml
# harbor.yml å…³é”®é…ç½®
hostname: harbor.company.com

# HTTPSé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰
https:
  port: 443
  certificate: /data/cert/server.crt
  private_key: /data/cert/server.key

# ç®¡ç†å‘˜å¯†ç 
harbor_admin_password: StrongPassword123!

# æ•°æ®åº“é…ç½®
database:
  password: DatabasePassword123!
  max_idle_conns: 100
  max_open_conns: 900
```

#### ğŸ›¡ï¸ å®‰å…¨åŠ å›ºé…ç½®


**ç½‘ç»œå®‰å…¨é…ç½®ï¼š**
```bash
# é˜²ç«å¢™é…ç½® - åªå…è®¸å¿…è¦ç«¯å£
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-port=80/tcp  # é‡å®šå‘åˆ°HTTPS
firewall-cmd --reload

# ç¦ç”¨HTTPï¼Œå¼ºåˆ¶HTTPS
# åœ¨harbor.ymlä¸­æ³¨é‡Šæ‰httpéƒ¨åˆ†
```

**ç³»ç»Ÿçº§å®‰å…¨åŠ å›ºï¼š**
```bash
# åˆ›å»ºä¸“ç”¨ç”¨æˆ·è¿è¡ŒHarbor
useradd -r -s /bin/false harbor
chown -R harbor:harbor /opt/harbor

# è®¾ç½®é€‚å½“çš„æ–‡ä»¶æƒé™
chmod 600 /opt/harbor/harbor.yml
chmod 700 /opt/harbor/
```

### 1.3 ä»“åº“å®‰å…¨ç­–ç•¥é…ç½®


#### ğŸ“‹ é¡¹ç›®å®‰å…¨ç­–ç•¥


**Harboré¡¹ç›®å®‰å…¨è®¾ç½®ï¼š**

| å®‰å…¨ç­–ç•¥ | **é…ç½®è¯´æ˜** | **æ¨èè®¾ç½®** |
|---------|-------------|-------------|
| ğŸ”’ **é•œåƒæ‰«æ** | `è‡ªåŠ¨æ‰«æä¸Šä¼ çš„é•œåƒæ¼æ´` | `å¼€å¯ï¼Œé˜»æ­¢ä¸¥é‡æ¼æ´é•œåƒ` |
| âœï¸ **å†…å®¹ä¿¡ä»»** | `è¦æ±‚é•œåƒç­¾åéªŒè¯` | `å¼€å¯ï¼Œç¡®ä¿é•œåƒå®Œæ•´æ€§` |
| ğŸš« **æ¼æ´é˜»æ–­** | `é˜»æ­¢åŒ…å«æ¼æ´çš„é•œåƒæ‹‰å–` | `ä¸­ç­‰åŠä»¥ä¸Šæ¼æ´é˜»æ–­` |
| ğŸ“ **é•œåƒé…é¢** | `é™åˆ¶é¡¹ç›®å­˜å‚¨ç©ºé—´` | `æ ¹æ®é¡¹ç›®éœ€æ±‚è®¾ç½®` |

**é¡¹ç›®è®¿é—®æ§åˆ¶é…ç½®ï¼š**
```
é¡¹ç›®è§’è‰²æƒé™è®¾è®¡ï¼š

é¡¹ç›®ç®¡ç†å‘˜ (Project Admin)ï¼š
âœ… ç®¡ç†é¡¹ç›®æˆå‘˜
âœ… é…ç½®é¡¹ç›®ç­–ç•¥  
âœ… åˆ é™¤é•œåƒ
âœ… æŸ¥çœ‹å®¡è®¡æ—¥å¿—

å¼€å‘äººå‘˜ (Developer)ï¼š
âœ… æ¨é€/æ‹‰å–é•œåƒ
âœ… æŸ¥çœ‹é•œåƒä¿¡æ¯
âŒ åˆ é™¤é•œåƒ
âŒ ä¿®æ”¹é¡¹ç›®é…ç½®

åªè¯»ç”¨æˆ· (Guest)ï¼š
âœ… æ‹‰å–é•œåƒ
âŒ æ¨é€é•œåƒ
âŒ ä»»ä½•ç®¡ç†æ“ä½œ
```

#### ğŸ” é•œåƒå®‰å…¨æ‰«æ


**Trivyæ‰«æå™¨é›†æˆï¼š**
> Trivyå°±åƒ"Xå…‰æœº"ï¼Œèƒ½é€è§†é•œåƒå†…éƒ¨ï¼Œå‘ç°éšè—çš„å®‰å…¨æ¼æ´ã€‚

```bash
# Harborå†…ç½®Trivyæ‰«æå™¨é…ç½®
# åœ¨Harborç®¡ç†ç•Œé¢ -> é…ç½®ç®¡ç† -> æ¼æ´æ‰«æå™¨

æ¼æ´æ‰«æç­–ç•¥ï¼š
- è‡ªåŠ¨æ‰«æï¼šé•œåƒæ¨é€æ—¶è‡ªåŠ¨è§¦å‘
- å®šæœŸæ‰«æï¼šæ¯æ—¥å‡Œæ™¨2ç‚¹æ‰«ææ‰€æœ‰é•œåƒ
- é˜»æ–­ç­–ç•¥ï¼šå‘ç°é«˜å±æ¼æ´æ—¶é˜»æ­¢æ‹‰å–
```

**æ‰«æç»“æœè§£è¯»ï¼š**
```
æ¼æ´ç­‰çº§åˆ†ç±»ï¼š
ğŸ”´ Critical (ä¸¥é‡)ï¼šç«‹å³ä¿®å¤ï¼Œé˜»æ­¢éƒ¨ç½²
ğŸŸ  High (é«˜å±)ï¼šå°½å¿«ä¿®å¤ï¼Œè­¦å‘Šæç¤º
ğŸŸ¡ Medium (ä¸­å±)ï¼šè®¡åˆ’ä¿®å¤ï¼Œå…è®¸éƒ¨ç½²
ğŸŸ¢ Low (ä½å±)ï¼šå¯é€‰ä¿®å¤ï¼Œæ­£å¸¸éƒ¨ç½²
```

---

## 2. ğŸ‘¥ é•œåƒè®¿é—®æƒé™æ§åˆ¶


### 2.1 åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)


**ä»€ä¹ˆæ˜¯RBACï¼Ÿ**
> RBACå°±åƒå…¬å¸çš„"é—¨ç¦å¡ç³»ç»Ÿ"ï¼Œä¸åŒèŒä½çš„å‘˜å·¥æœ‰ä¸åŒçš„é—¨ç¦æƒé™ï¼ŒCEOèƒ½è¿›æ‰€æœ‰æˆ¿é—´ï¼Œå®ä¹ ç”Ÿåªèƒ½è¿›æŒ‡å®šåŒºåŸŸã€‚

```
RBACæƒé™æ¨¡å‹ï¼š
ç”¨æˆ·(User) â†’ è§’è‰²(Role) â†’ æƒé™(Permission) â†’ èµ„æº(Resource)

å®é™…ä¾‹å­ï¼š
å¼ ä¸‰(å¼€å‘) â†’ Developerè§’è‰² â†’ Pushæƒé™ â†’ project-aä»“åº“
æå››(æµ‹è¯•) â†’ Testerè§’è‰² â†’ Pullæƒé™ â†’ project-aä»“åº“  
ç‹äº”(è¿ç»´) â†’ DevOpsè§’è‰² â†’ å…¨éƒ¨æƒé™ â†’ æ‰€æœ‰ä»“åº“
```

### 2.2 ç”¨æˆ·ç®¡ç†ä¸è®¤è¯


#### ğŸ”‘ æœ¬åœ°ç”¨æˆ·ç®¡ç†


**Harboræœ¬åœ°ç”¨æˆ·åˆ›å»ºï¼š**
```
ç”¨æˆ·åˆ›å»ºæœ€ä½³å®è·µï¼š

ç”¨æˆ·åè§„èŒƒï¼š
- æ ¼å¼ï¼šéƒ¨é—¨.å§“å (å¦‚ï¼šdev.zhangsan)
- é¿å…ç‰¹æ®Šå­—ç¬¦ï¼Œä½¿ç”¨å°å†™å­—æ¯
- ä¾¿äºè¯†åˆ«å’Œç®¡ç†

å¯†ç ç­–ç•¥ï¼š
- æœ€å°‘12ä½å­—ç¬¦
- åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šç¬¦å·
- å®šæœŸæ›´æ¢(å»ºè®®90å¤©)
- ä¸èƒ½é‡å¤ä½¿ç”¨æœ€è¿‘5æ¬¡å¯†ç 
```

#### ğŸ¢ ä¼ä¸šçº§èº«ä»½è®¤è¯é›†æˆ


**LDAPé›†æˆé…ç½®ï¼š**
> LDAPé›†æˆå°±åƒ"ç»Ÿä¸€èº«ä»½è¯"ï¼Œå‘˜å·¥ç”¨å…¬å¸è´¦å·å°±èƒ½è®¿é—®æ‰€æœ‰ç³»ç»Ÿï¼Œä¸éœ€è¦è®°ä½å¤šå¥—å¯†ç ã€‚

```yaml
# Harbor LDAPé…ç½®ç¤ºä¾‹
auth_mode: ldap_auth
ldap:
  url: ldaps://ldap.company.com:636
  search_dn: cn=harbor,ou=services,dc=company,dc=com
  search_password: LdapServicePassword
  base_dn: ou=users,dc=company,dc=com
  uid: uid
  filter: (objectClass=person)
  scope: 2
  timeout: 5
```

**å•ç‚¹ç™»å½•(SSO)é…ç½®ï¼š**
```yaml
# OIDCé…ç½®ï¼ˆæ”¯æŒGoogleã€Azure ADç­‰ï¼‰
auth_mode: oidc_auth
oidc:
  name: CompanySSO
  endpoint: https://sso.company.com
  client_id: harbor-client
  client_secret: OidcClientSecret
  scope: openid,profile,email
```

### 2.3 é¡¹ç›®çº§æƒé™æ§åˆ¶


#### ğŸ“ é¡¹ç›®æƒé™æ¨¡å‹


**é¡¹ç›®æƒé™è®¾è®¡åŸåˆ™ï¼š**
```
æœ€å°æƒé™åŸåˆ™ï¼š
åªç»™ç”¨æˆ·å®Œæˆå·¥ä½œæ‰€éœ€çš„æœ€ä½æƒé™

æƒé™åˆ†ç¦»åŸåˆ™ï¼š
å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒæƒé™åˆ†ç¦»

å®¡æ‰¹æµç¨‹ï¼š
é‡è¦æƒé™å˜æ›´éœ€è¦å®¡æ‰¹ç¡®è®¤

å®šæœŸå®¡æŸ¥ï¼š
æ¯å­£åº¦å®¡æŸ¥æƒé™åˆç†æ€§
```

**å¤šç¯å¢ƒæƒé™çŸ©é˜µï¼š**

| ç¯å¢ƒ/è§’è‰² | **å¼€å‘è€…** | **æµ‹è¯•å‘˜** | **è¿ç»´å·¥ç¨‹å¸ˆ** | **é¡¹ç›®ç»ç†** |
|----------|-----------|-----------|---------------|-------------|
| ğŸ› ï¸ **å¼€å‘ç¯å¢ƒ** | `Push/Pull` | `Pull only` | `Full access` | `View only` |
| ğŸ§ª **æµ‹è¯•ç¯å¢ƒ** | `Pull only` | `Push/Pull` | `Full access` | `View only` |
| ğŸš€ **ç”Ÿäº§ç¯å¢ƒ** | `No access` | `Pull only` | `Pull only` | `View only` |

#### ğŸ·ï¸ åŸºäºæ ‡ç­¾çš„æƒé™æ§åˆ¶


**é•œåƒæ ‡ç­¾æƒé™ç­–ç•¥ï¼š**
```bash
# æ ‡ç­¾æƒé™è§„åˆ™ç¤ºä¾‹
å¼€å‘åˆ†æ”¯ï¼šdev-*
- å¼€å‘è€…ï¼šå¯æ¨é€å¯æ‹‰å–
- æµ‹è¯•å‘˜ï¼šåªèƒ½æ‹‰å–
- å…¶ä»–ï¼šæ— æƒé™

å‘å¸ƒåˆ†æ”¯ï¼šrelease-*  
- åªæœ‰CI/CDç³»ç»Ÿå¯æ¨é€
- è¿ç»´å¯æ‹‰å–
- å…¶ä»–è§’è‰²åªè¯»

ç”Ÿäº§æ ‡ç­¾ï¼šlatest, v1.*, stable
- åªæœ‰å‘å¸ƒæµæ°´çº¿å¯æ¨é€
- ä¸¥æ ¼çš„å®¡æ‰¹æµç¨‹
- å®Œæ•´çš„å®¡è®¡è®°å½•
```

### 2.4 APIè®¿é—®æ§åˆ¶


#### ğŸ”§ Robotè´¦æˆ·ç®¡ç†


**ä»€ä¹ˆæ˜¯Robotè´¦æˆ·ï¼Ÿ**
> Robotè´¦æˆ·å°±åƒ"æœºå™¨äººå‘˜å·¥"ï¼Œä¸“é—¨ç»™è‡ªåŠ¨åŒ–ç³»ç»Ÿä½¿ç”¨ï¼Œæœ‰å›ºå®šçš„æƒé™ï¼Œä¸ä¼šå› ä¸ºäººå‘˜å˜åŠ¨è€Œå¤±æ•ˆã€‚

```
Robotè´¦æˆ·ä½¿ç”¨åœºæ™¯ï¼š
CI/CDæµæ°´çº¿ï¼šè‡ªåŠ¨æ¨é€æ„å»ºé•œåƒ
ç›‘æ§ç³»ç»Ÿï¼šæ‹‰å–é•œåƒæ£€æŸ¥çŠ¶æ€
è‡ªåŠ¨éƒ¨ç½²ï¼šæ‹‰å–æœ€æ–°é•œåƒéƒ¨ç½²

Robotè´¦æˆ·å®‰å…¨é…ç½®ï¼š
- ä½¿ç”¨å¼ºéšæœºå¯†ç ï¼ˆTokenï¼‰
- è®¾ç½®è´¦æˆ·æœ‰æ•ˆæœŸ
- æœ€å°æƒé™åŸåˆ™
- å®šæœŸè½®æ¢Token
```

**Robotè´¦æˆ·åˆ›å»ºä¸ç®¡ç†ï¼š**
```bash
# é€šè¿‡Harbor UIåˆ›å»ºRobotè´¦æˆ·
é¡¹ç›®è®¾ç½® â†’ Robotè´¦æˆ· â†’ æ–°å»º

é…ç½®é¡¹ï¼š
åç§°ï¼šci-robot-é¡¹ç›®å
æè¿°ï¼šç”¨äºCI/CDæµæ°´çº¿
æƒé™ï¼šPushå’ŒPullæŒ‡å®šä»“åº“
æœ‰æ•ˆæœŸï¼š365å¤©
```

#### ğŸ” API Tokenç®¡ç†


**Tokenå®‰å…¨æœ€ä½³å®è·µï¼š**
```
Tokenç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š
åˆ›å»º â†’ åˆ†å‘ â†’ ä½¿ç”¨ â†’ è½®æ¢ â†’ é”€æ¯

å®‰å…¨å­˜å‚¨ï¼š
- ä½¿ç”¨å¯†é’¥ç®¡ç†ç³»ç»Ÿï¼ˆå¦‚HashiCorp Vaultï¼‰
- ä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç 
- ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶åŠ å¯†å­˜å‚¨

æƒé™æ§åˆ¶ï¼š
- ä¸€ä¸ªTokenåªç”¨äºä¸€ä¸ªç”¨é€”
- å®šæœŸå®¡æŸ¥Tokenä½¿ç”¨æƒ…å†µ
- åŠæ—¶æ’¤é”€ä¸éœ€è¦çš„Token
```

---

## 3. ğŸ” é•œåƒä¼ è¾“åŠ å¯†é…ç½®


### 3.1 HTTPSä¼ è¾“åŠ å¯†


**ä¸ºä»€ä¹ˆéœ€è¦ä¼ è¾“åŠ å¯†ï¼Ÿ**
> æ²¡æœ‰åŠ å¯†çš„ç½‘ç»œä¼ è¾“å°±åƒ"æ˜ä¿¡ç‰‡"ï¼Œå†…å®¹è°éƒ½èƒ½çœ‹åˆ°ã€‚åŠ å¯†ä¼ è¾“å°±åƒ"å¯†å°ä¿¡ä»¶"ï¼Œåªæœ‰æ”¶ä»¶äººèƒ½æ‰“å¼€é˜…è¯»ã€‚

```
HTTPä¼ è¾“é£é™©ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   æ˜æ–‡ä¼ è¾“   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   ä»»ä½•äººéƒ½èƒ½   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  ç½‘ç»œ   â”‚ â†â”€â”€çªƒå¬â”€â”€â”€â”€â”€â”€ â”‚ æ”»å‡»è€…  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†‘                         â†‘
  â””â”€â”€ ç”¨æˆ·åå¯†ç æš´éœ² â”€â”€â”€â”€â”€â”€â”€â”€â”˜

HTTPSä¼ è¾“å®‰å…¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   åŠ å¯†ä¼ è¾“   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   æ— æ³•è§£å¯†   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  ç½‘ç»œ   â”‚ â†â”€â”€Ã—â”€â”€â”€â”€â”€â”€ â”‚ æ”»å‡»è€…  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘                     â†‘
      â””â”€â”€ SSL/TLSä¿æŠ¤ â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 SSL/TLSè¯ä¹¦é…ç½®


#### ğŸ“œ è¯ä¹¦ç±»å‹é€‰æ‹©


**è¯ä¹¦ç±»å‹å¯¹æ¯”ï¼š**

| è¯ä¹¦ç±»å‹ | **å®‰å…¨çº§åˆ«** | **éªŒè¯æ–¹å¼** | **é€‚ç”¨åœºæ™¯** | **ä»·æ ¼** |
|---------|-------------|-------------|-------------|---------|
| ğŸ”’ **åŸŸåéªŒè¯(DV)** | `åŸºç¡€` | `åŸŸåæ‰€æœ‰æƒéªŒè¯` | `å¼€å‘æµ‹è¯•ç¯å¢ƒ` | `å…è´¹/ä½ä»·` |
| ğŸ¢ **ç»„ç»‡éªŒè¯(OV)** | `ä¸­ç­‰` | `åŸŸå+ç»„ç»‡éªŒè¯` | `ä¼ä¸šå†…éƒ¨ç³»ç»Ÿ` | `ä¸­ç­‰ä»·æ ¼` |
| ğŸ›¡ï¸ **æ‰©å±•éªŒè¯(EV)** | `æœ€é«˜` | `ä¸¥æ ¼èº«ä»½éªŒè¯` | `å¯¹å¤–æœåŠ¡ç³»ç»Ÿ` | `è¾ƒé«˜ä»·æ ¼` |

#### ğŸ”§ Let's Encryptå…è´¹è¯ä¹¦é…ç½®


```bash
# å®‰è£…certbotå·¥å…·
yum install -y epel-release
yum install -y certbot

# ç”³è¯·è¯ä¹¦ï¼ˆåœæœºç”³è¯·æ–¹å¼ï¼‰
certbot certonly --standalone -d harbor.company.com

# è¯ä¹¦æ–‡ä»¶ä½ç½®
ls -la /etc/letsencrypt/live/harbor.company.com/
# cert.pem      - æœåŠ¡å™¨è¯ä¹¦
# chain.pem     - ä¸­é—´è¯ä¹¦
# fullchain.pem - å®Œæ•´è¯ä¹¦é“¾ï¼ˆæ¨èä½¿ç”¨ï¼‰
# privkey.pem   - ç§é’¥æ–‡ä»¶
```

**è¯ä¹¦è‡ªåŠ¨ç»­æœŸé…ç½®ï¼š**
```bash
# åˆ›å»ºç»­æœŸè„šæœ¬
cat > /opt/renew-harbor-cert.sh << 'EOF'
#!/bin/bash
certbot renew --quiet
if [ $? -eq 0 ]; then
    docker-compose -f /opt/harbor/docker-compose.yml restart proxy
    echo "Harborè¯ä¹¦ç»­æœŸæˆåŠŸ: $(date)" >> /var/log/cert-renew.log
fi
EOF

# è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æœˆæ£€æŸ¥ï¼‰
echo "0 2 1 * * /opt/renew-harbor-cert.sh" | crontab -
```

#### ğŸ¢ ä¼ä¸šçº§è¯ä¹¦ç®¡ç†


**è¯ä¹¦ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š**
```
è¯ä¹¦ç®¡ç†æµç¨‹ï¼š
ç”³è¯· â†’ éƒ¨ç½² â†’ ç›‘æ§ â†’ ç»­æœŸ â†’ æ›´æ–°

å…³é”®æ—¶é—´èŠ‚ç‚¹ï¼š
è¯ä¹¦åˆ°æœŸå‰90å¤©ï¼šå¼€å§‹å‡†å¤‡ç»­æœŸ
è¯ä¹¦åˆ°æœŸå‰30å¤©ï¼šå®Œæˆç»­æœŸç”³è¯·
è¯ä¹¦åˆ°æœŸå‰7å¤©ï¼šéƒ¨ç½²æ–°è¯ä¹¦
è¯ä¹¦åˆ°æœŸå‰1å¤©ï¼šæœ€åæ£€æŸ¥ç¡®è®¤
```

**è¯ä¹¦ç›‘æ§è„šæœ¬ï¼š**
```bash
#!/bin/bash
# è¯ä¹¦åˆ°æœŸç›‘æ§è„šæœ¬

DOMAIN="harbor.company.com"
EXPIRE_DAYS=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null | openssl x509 -noout -dates | grep notAfter | cut -d= -f2 | xargs -I {} date -d {} +%s)
CURRENT_TIME=$(date +%s)
DAYS_LEFT=$(( ($EXPIRE_DAYS - $CURRENT_TIME) / 86400 ))

if [ $DAYS_LEFT -lt 30 ]; then
    echo "è­¦å‘Šï¼šHarborè¯ä¹¦å°†åœ¨${DAYS_LEFT}å¤©ååˆ°æœŸï¼" | mail -s "è¯ä¹¦åˆ°æœŸå‘Šè­¦" admin@company.com
fi
```

### 3.3 Dockerå®¢æˆ·ç«¯TLSé…ç½®


#### ğŸ”§ å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯


**åŒå‘TLSè®¤è¯é…ç½®ï¼š**
> åŒå‘TLSå°±åƒ"åŒé‡èº«ä»½éªŒè¯"ï¼ŒæœåŠ¡å™¨éªŒè¯å®¢æˆ·ç«¯èº«ä»½ï¼Œå®¢æˆ·ç«¯ä¹ŸéªŒè¯æœåŠ¡å™¨èº«ä»½ï¼Œç¡®ä¿é€šä¿¡åŒæ–¹éƒ½æ˜¯å¯ä¿¡çš„ã€‚

```bash
# ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦
openssl genrsa -out client.key 4096
openssl req -new -x509 -text -key client.key -out client.cert -days 365

# Docker daemoné…ç½®æ–‡ä»¶
cat > /etc/docker/daemon.json << 'EOF'
{
    "hosts": ["unix:///var/run/docker.sock", "tcp://0.0.0.0:2376"],
    "tls": true,
    "tlscert": "/etc/docker/certs/server.pem",
    "tlskey": "/etc/docker/certs/server-key.pem",
    "tlsverify": true,
    "tlscacert": "/etc/docker/certs/ca.pem"
}
EOF
```

#### ğŸ–¥ï¸ å®¢æˆ·ç«¯è®¿é—®é…ç½®


**Dockerå®¢æˆ·ç«¯è¿æ¥é…ç½®ï¼š**
```bash
# æ–¹å¼1ï¼šç¯å¢ƒå˜é‡é…ç½®
export DOCKER_HOST=tcp://harbor.company.com:2376
export DOCKER_TLS_VERIFY=1
export DOCKER_CERT_PATH=/home/user/.docker/certs

# æ–¹å¼2ï¼šå‘½ä»¤è¡Œå‚æ•°
docker --tlsverify --tlscacert=ca.pem --tlscert=cert.pem --tlskey=key.pem \
  -H=harbor.company.com:2376 pull myapp:latest

# æ–¹å¼3ï¼šé…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰
mkdir -p ~/.docker/certs.d/harbor.company.com/
cp ca.crt ~/.docker/certs.d/harbor.company.com/
cp client.cert ~/.docker/certs.d/harbor.company.com/
cp client.key ~/.docker/certs.d/harbor.company.com/
```

### 3.4 ç½‘ç»œä¼ è¾“å®‰å…¨åŠ å›º


#### ğŸ›¡ï¸ ç½‘ç»œå±‚å®‰å…¨


**VPNéš§é“é…ç½®ï¼š**
```
ä¼ä¸šç½‘ç»œå®‰å…¨æ¶æ„ï¼š

å¤–ç½‘ç”¨æˆ· â†’ VPNç½‘å…³ â†’ ä¼ä¸šå†…ç½‘ â†’ Harborä»“åº“
     â†‘           â†‘             â†‘
   èº«ä»½è®¤è¯    éš§é“åŠ å¯†      å†…ç½‘éš”ç¦»

å®‰å…¨å±‚æ¬¡ï¼š
ç¬¬ä¸€å±‚ï¼šVPNèº«ä»½è®¤è¯å’Œæˆæƒ
ç¬¬äºŒå±‚ï¼šç½‘ç»œéš§é“åŠ å¯†ä¼ è¾“  
ç¬¬ä¸‰å±‚ï¼šHarboråº”ç”¨å±‚è®¤è¯
ç¬¬å››å±‚ï¼šé•œåƒå†…å®¹å®Œæ•´æ€§éªŒè¯
```

**é˜²ç«å¢™è§„åˆ™é…ç½®ï¼š**
```bash
# åªå…è®¸æŒ‡å®šIPè®¿é—®Harbor
iptables -A INPUT -p tcp --dport 443 -s 192.168.1.0/24 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j DROP

# é™åˆ¶è¿æ¥é¢‘ç‡ï¼ˆé˜²æ­¢æš´åŠ›ç ´è§£ï¼‰
iptables -A INPUT -p tcp --dport 443 -m limit --limit 25/minute --limit-burst 100 -j ACCEPT
```

#### ğŸ”’ ä¼ è¾“å†…å®¹ä¿æŠ¤


**é•œåƒå±‚åŠ å¯†ä¼ è¾“ï¼š**
```bash
# éªŒè¯HTTPSä¼ è¾“
curl -v https://harbor.company.com/v2/

# è¾“å‡ºåº”åŒ…å«ï¼š
# * TLSv1.3 (IN), TLS handshake
# * SSL connection using TLSv1.3
# * Server certificate verified
```

**ä¼ è¾“å®Œæ•´æ€§éªŒè¯ï¼š**
```bash
# Docker pullæ—¶çš„å®Œæ•´æ€§éªŒè¯
docker pull harbor.company.com/project/app:v1.0

# Dockerä¼šè‡ªåŠ¨éªŒè¯ï¼š
# 1. é•œåƒæ¸…å•(manifest)çš„æ•°å­—ç­¾å
# 2. å„å±‚æ•°æ®çš„SHA256å“ˆå¸Œå€¼
# 3. æ•´ä½“é•œåƒçš„å†…å®¹åœ°å€æ ¡éªŒ
```

---

## 4. ğŸ”‘ é•œåƒä»“åº“èº«ä»½è®¤è¯æœºåˆ¶


### 4.1 è®¤è¯æœºåˆ¶æ¦‚è¿°


**èº«ä»½è®¤è¯çš„é‡è¦æ€§**
> èº«ä»½è®¤è¯å°±åƒ"é—¨å«æ£€æŸ¥èº«ä»½è¯"ï¼Œç¡®ä¿åªæœ‰æœ‰æƒé™çš„äººæ‰èƒ½è¿›å…¥é•œåƒä»“åº“ï¼Œé˜²æ­¢æœªæˆæƒè®¿é—®ã€‚

```
è®¤è¯æœºåˆ¶çš„ä¸‰ä¸ªå±‚æ¬¡ï¼š

èº«ä»½è¯†åˆ« (Who you are)ï¼š
ç”¨æˆ·åã€é‚®ç®±ã€å‘˜å·¥IDç­‰å”¯ä¸€æ ‡è¯†

èº«ä»½éªŒè¯ (Prove who you are)ï¼š
å¯†ç ã€Tokenã€è¯ä¹¦ã€ç”Ÿç‰©è¯†åˆ«

æˆæƒæ§åˆ¶ (What you can do)ï¼š  
åŸºäºèº«ä»½åˆ†é…ç›¸åº”çš„æƒé™
```

### 4.2 å¤šç§è®¤è¯æ–¹å¼å¯¹æ¯”


#### ğŸ“Š è®¤è¯æ–¹å¼é€‰æ‹©æŒ‡å—


| è®¤è¯æ–¹å¼ | **å®‰å…¨ç­‰çº§** | **å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** | **ç»´æŠ¤æˆæœ¬** |
|---------|-------------|-----------|-------------|-------------|
| ğŸ” **ç”¨æˆ·åå¯†ç ** | `ä¸­ç­‰` | `ç®€å•` | `å°å‹å›¢é˜Ÿ` | `ä½` |
| ğŸ« **Tokenè®¤è¯** | `é«˜` | `ä¸­ç­‰` | `APIè‡ªåŠ¨åŒ–` | `ä¸­ç­‰` |
| ğŸ“± **åŒå› ç´ è®¤è¯** | `å¾ˆé«˜` | `ä¸­ç­‰` | `æ•æ„Ÿæ“ä½œ` | `ä¸­ç­‰` |
| ğŸ¢ **LDAPé›†æˆ** | `é«˜` | `å¤æ‚` | `ä¼ä¸šç¯å¢ƒ` | `é«˜` |
| ğŸ”„ **SSOå•ç‚¹ç™»å½•** | `é«˜` | `å¤æ‚` | `å¤šç³»ç»Ÿé›†æˆ` | `é«˜` |

#### ğŸ”’ åŸºç¡€è®¤è¯é…ç½®


**ç”¨æˆ·åå¯†ç è®¤è¯ï¼š**
```bash
# Dockerç™»å½•Harbor
docker login harbor.company.com
# è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 

# å‡­æ®å­˜å‚¨ä½ç½®
cat ~/.docker/config.json
{
    "auths": {
        "harbor.company.com": {
            "auth": "dXNlcjpwYXNzd29yZA=="  # base64ç¼–ç çš„ç”¨æˆ·å:å¯†ç 
        }
    }
}
```

**Tokenè®¤è¯æ–¹å¼ï¼š**
```bash
# ä½¿ç”¨ä¸ªäººè®¿é—®ä»¤ç‰Œç™»å½•
echo $HARBOR_TOKEN | docker login harbor.company.com -u robot-user --password-stdin

# CI/CDç¯å¢ƒä¸­çš„Tokenä½¿ç”¨
export DOCKER_REGISTRY_USER="robot-ci"
export DOCKER_REGISTRY_TOKEN="eyJhbGciOiJSUzI1NiJ9..."
echo $DOCKER_REGISTRY_TOKEN | docker login $DOCKER_REGISTRY -u $DOCKER_REGISTRY_USER --password-stdin
```

### 4.3 ä¼ä¸šçº§è®¤è¯é›†æˆ


#### ğŸ¢ LDAP/ADé›†æˆæ·±å…¥é…ç½®


**LDAPè®¤è¯æµç¨‹ï¼š**
```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š
ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç  â†’ HarboréªŒè¯è¯·æ±‚ â†’ æŸ¥è¯¢LDAPæœåŠ¡å™¨ â†’ éªŒè¯ç”¨æˆ·ä¿¡æ¯ â†’ è¿”å›è®¤è¯ç»“æœ

LDAPæŸ¥è¯¢è¿‡ç¨‹ï¼š
1. è¿æ¥LDAPæœåŠ¡å™¨
2. ä½¿ç”¨æœåŠ¡è´¦å·ç»‘å®š
3. æœç´¢ç”¨æˆ·DN(Distinguished Name)  
4. å°è¯•ç”¨ç”¨æˆ·å¯†ç ç»‘å®šéªŒè¯
5. è·å–ç”¨æˆ·å±æ€§ä¿¡æ¯ï¼ˆéƒ¨é—¨ã€é‚®ç®±ç­‰ï¼‰
```

**é«˜çº§LDAPé…ç½®ï¼š**
```yaml
# harbor.ymlä¸­çš„è¯¦ç»†LDAPé…ç½®
ldap:
  url: ldaps://dc1.company.com:636,ldaps://dc2.company.com:636  # å¤šæœåŠ¡å™¨æ”¯æŒ
  search_dn: cn=harborsvc,ou=ServiceAccounts,dc=company,dc=com
  search_password: ServiceAccountPassword
  base_dn: ou=employees,dc=company,dc=com
  
  # ç”¨æˆ·å±æ€§æ˜ å°„
  uid: sAMAccountName          # Windows ADç”¨æˆ·å
  filter: (&(objectClass=user)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))  # æ’é™¤ç¦ç”¨è´¦æˆ·
  scope: 2                     # å­æ ‘æœç´¢
  
  # ç»„æ˜ å°„é…ç½®
  group_base_dn: ou=groups,dc=company,dc=com
  group_filter: (objectClass=group)
  group_uid: cn
  group_scope: 2
```

#### ğŸ”„ å•ç‚¹ç™»å½•(SSO)é›†æˆ


**OIDC(OpenID Connect)é…ç½®ï¼š**
> OIDCå°±åƒ"ä¸‡èƒ½é’¥åŒ™"ï¼Œä¸€æŠŠé’¥åŒ™å¯ä»¥å¼€å¯å…¬å¸æ‰€æœ‰ç³»ç»Ÿçš„é—¨ï¼Œç”¨æˆ·åªéœ€è¦ç™»å½•ä¸€æ¬¡ã€‚

```yaml
# OIDCé…ç½®ç¤ºä¾‹ï¼ˆAzure ADï¼‰
oidc:
  name: AzureAD
  endpoint: https://login.microsoftonline.com/{tenant-id}/v2.0
  client_id: harbor-app-id
  client_secret: client-secret-value
  redirect_uri: https://harbor.company.com/c/oidc/callback
  scope: openid email profile
  
  # ç”¨æˆ·ä¿¡æ¯æ˜ å°„
  username_claim: preferred_username
  email_claim: email
  group_claim: groups
```

**SAML 2.0é›†æˆé…ç½®ï¼š**
```xml
<!-- SAMLé…ç½®ç¤ºä¾‹ -->
<saml:AuthnRequest>
    <saml:Issuer>https://harbor.company.com</saml:Issuer>
    <saml:NameIDPolicy Format="urn:oasis:names:tc:SAML:2.0:nameid-format:emailAddress"/>
</saml:AuthnRequest>
```

### 4.4 åŒå› ç´ è®¤è¯(2FA)


#### ğŸ“± TOTPåŒå› ç´ è®¤è¯


**2FAå·¥ä½œåŸç†ï¼š**
```
åŒå› ç´ è®¤è¯ç»„æˆï¼š
ç¬¬ä¸€å› ç´ ï¼šçŸ¥è¯†å› ç´ ï¼ˆç”¨æˆ·åå¯†ç ï¼‰
ç¬¬äºŒå› ç´ ï¼šæŒæœ‰å› ç´ ï¼ˆæ‰‹æœºAPPç”Ÿæˆçš„6ä½æ•°å­—ï¼‰

è®¤è¯æµç¨‹ï¼š
1. ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå¯†ç 
2. ç³»ç»ŸéªŒè¯ç¬¬ä¸€å› ç´ 
3. è¦æ±‚è¾“å…¥åŠ¨æ€éªŒè¯ç   
4. ç”¨æˆ·æ‰“å¼€æ‰‹æœºAPPè·å–6ä½æ•°å­—
5. è¾“å…¥éªŒè¯ç å®Œæˆç™»å½•
```

**Harbor 2FAé…ç½®ï¼š**
```
å¯ç”¨æ­¥éª¤ï¼š
1. ç”¨æˆ·ç™»å½•Harbor Webç•Œé¢
2. ä¸ªäººè®¾ç½® â†’ åŒå› ç´ è®¤è¯
3. æ‰«æQRç æ·»åŠ åˆ°è®¤è¯APP
4. è¾“å…¥éªŒè¯ç ç¡®è®¤å¯ç”¨

æ”¯æŒçš„è®¤è¯APPï¼š
- Google Authenticator
- Microsoft Authenticator  
- Authy
- 1Password
```

#### ğŸ” ç¡¬ä»¶å®‰å…¨å¯†é’¥


**FIDO2/WebAuthnæ”¯æŒï¼š**
```
ç¡¬ä»¶å¯†é’¥ä¼˜åŠ¿ï¼š
- ç‰©ç†éš”ç¦»ï¼Œæ›´éš¾è¢«ç ´è§£
- é˜²é’“é±¼æ”»å‡»
- æ— éœ€æ‰‹æœºç½‘ç»œ
- æ›´å¿«çš„è®¤è¯é€Ÿåº¦

æ”¯æŒçš„ç¡¬ä»¶ï¼š
- YubiKeyç³»åˆ—
- Google Titan Key
- Microsoft Surface Authenticator
```

### 4.5 APIè®¤è¯ä¸æˆæƒ


#### ğŸ¤– Robotè´¦æˆ·è¯¦ç»†ç®¡ç†


**Robotè´¦æˆ·æƒé™è®¾è®¡ï¼š**
```
Robotè´¦æˆ·å‘½åè§„èŒƒï¼š
æ ¼å¼ï¼šrobot-{ç”¨é€”}-{ç¯å¢ƒ}-{é¡¹ç›®}
ç¤ºä¾‹ï¼šrobot-ci-prod-webapi

æƒé™çº§åˆ«è®¾è®¡ï¼š
ç³»ç»Ÿçº§Robotï¼šå¯è®¿é—®å¤šä¸ªé¡¹ç›®
é¡¹ç›®çº§Robotï¼šåªèƒ½è®¿é—®æŒ‡å®šé¡¹ç›®
èµ„æºçº§Robotï¼šåªèƒ½è®¿é—®ç‰¹å®šé•œåƒ

ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š
åˆ›å»º â†’ é…ç½®æƒé™ â†’ ç”ŸæˆToken â†’ åˆ†å‘ä½¿ç”¨ â†’ å®šæœŸè½®æ¢ â†’ åˆ°æœŸåˆ é™¤
```

**Robot Tokenå®‰å…¨å­˜å‚¨ï¼š**
```bash
# ä½¿ç”¨HashiCorp Vaultå­˜å‚¨Token
vault kv put secret/harbor/robot-ci \
  username="robot-ci-prod" \
  token="eyJhbGciOiJSUzI1NiJ9..."

# CI/CDä¸­å®‰å…¨è·å–Token
ROBOT_TOKEN=$(vault kv get -field=token secret/harbor/robot-ci)
echo $ROBOT_TOKEN | docker login harbor.company.com -u robot-ci-prod --password-stdin
```

#### ğŸ”‘ JWT Tokenæ·±å…¥ç†è§£


**JWT Tokenç»“æ„åˆ†æï¼š**
```
JWT Tokenç»„æˆï¼š
Header.Payload.Signature

Headerï¼ˆå¤´éƒ¨ï¼‰ï¼š
{
  "alg": "RS256",      # ç­¾åç®—æ³•
  "typ": "JWT"         # Tokenç±»å‹
}

Payloadï¼ˆè½½è·ï¼‰ï¼š
{
  "iss": "harbor",           # å‘è¡Œè€…
  "sub": "robot-ci",         # ä¸»é¢˜ï¼ˆç”¨æˆ·ï¼‰
  "aud": "harbor-service",   # å—ä¼—
  "exp": 1640995200,         # è¿‡æœŸæ—¶é—´
  "iat": 1640908800,         # ç­¾å‘æ—¶é—´
  "access": [...]            # æƒé™ä¿¡æ¯
}

Signatureï¼ˆç­¾åï¼‰ï¼š
ä½¿ç”¨ç§é’¥å¯¹Headerå’ŒPayloadç­¾åï¼Œç¡®ä¿Tokenæ²¡æœ‰è¢«ç¯¡æ”¹
```

---

## 5. âœ… é•œåƒå®Œæ•´æ€§éªŒè¯


### 5.1 é•œåƒå®Œæ•´æ€§åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯é•œåƒå®Œæ•´æ€§ï¼Ÿ**
> é•œåƒå®Œæ•´æ€§å°±åƒ"äº§å“é˜²ä¼ªæ ‡ç­¾"ï¼Œç¡®ä¿ä½ ä¸‹è½½çš„é•œåƒç¡®å®æ˜¯åŸå‚å‘å¸ƒçš„ï¼Œæ²¡æœ‰è¢«ç¯¡æ”¹æˆ–æ›¿æ¢ã€‚

```
å®Œæ•´æ€§å¨èƒåœºæ™¯ï¼š

ä¸­é—´äººæ”»å‡»ï¼š
åŸå§‹é•œåƒ â†’ ç½‘ç»œä¼ è¾“ â†’ æ¶æ„ç¯¡æ”¹ â†’ ç”¨æˆ·æ¥æ”¶åˆ°æœ‰å®³é•œåƒ

ä»“åº“å…¥ä¾µï¼š
æ”»å‡»è€…å…¥ä¾µä»“åº“ â†’ æ›¿æ¢æ­£å¸¸é•œåƒ â†’ æ¤å…¥æ¶æ„ä»£ç 

ä¾›åº”é“¾æ”»å‡»ï¼š
æ¶æ„å¼€å‘è€… â†’ å‘å¸ƒæœ‰å®³é•œåƒ â†’ ä¼ªè£…æˆæ­£å¸¸åº”ç”¨

å®Œæ•´æ€§éªŒè¯é˜²æŠ¤ï¼š
æ•°å­—ç­¾åéªŒè¯ + å†…å®¹å“ˆå¸Œæ ¡éªŒ = ç¡®ä¿é•œåƒå¯ä¿¡
```

### 5.2 Docker Content Trust (DCT)


#### ğŸ”’ DCTåŸºæœ¬æ¦‚å¿µ


**Docker Content Trustå·¥ä½œåŸç†ï¼š**
> DCTå°±åƒ"æ•°å­—å°ç« "ï¼Œå‘å¸ƒé•œåƒæ—¶ç”¨ç§é’¥ç›–ç« ï¼Œç”¨æˆ·æ‹‰å–æ—¶ç”¨å…¬é’¥éªŒå°ï¼Œç¡®ä¿é•œåƒæ¥æºå¯ä¿¡ã€‚

```
DCTç­¾åéªŒè¯æµç¨‹ï¼š

é•œåƒå‘å¸ƒæ–¹ï¼š
1. ä½¿ç”¨ç§é’¥å¯¹é•œåƒç­¾å
2. å°†ç­¾åä¿¡æ¯ä¸Šä¼ åˆ°NotaryæœåŠ¡å™¨
3. å…¬é’¥ä¿¡æ¯å…¬å¼€å¯éªŒè¯

é•œåƒä½¿ç”¨æ–¹ï¼š
1. æ‹‰å–é•œåƒæ—¶åŒæ—¶è·å–ç­¾å
2. ä½¿ç”¨å‘å¸ƒè€…å…¬é’¥éªŒè¯ç­¾å
3. éªŒè¯é€šè¿‡æ‰å…è®¸ä½¿ç”¨é•œåƒ
```

#### ğŸ”§ DCTé…ç½®ä¸ä½¿ç”¨


**å¯ç”¨Docker Content Trustï¼š**
```bash
# å…¨å±€å¯ç”¨DCT
export DOCKER_CONTENT_TRUST=1

# æˆ–è€…åœ¨ç‰¹å®šå‘½ä»¤ä¸­å¯ç”¨
docker pull --disable-content-trust=false myapp:v1.0

# æŸ¥çœ‹ä¿¡ä»»ç­–ç•¥
docker trust inspect myapp:v1.0

# è¾“å‡ºç¤ºä¾‹ï¼š
[
    {
        "Name": "myapp:v1.0",
        "SignedTags": [
            {
                "SignedTag": "v1.0",
                "Digest": "sha256:abcd1234...",
                "Signers": [
                    "Repo Admin"
                ]
            }
        ]
    }
]
```

**é•œåƒç­¾åå‘å¸ƒï¼š**
```bash
# ç”Ÿæˆç­¾åå¯†é’¥
docker trust key generate mykey
# ç”Ÿæˆ mykey.pubï¼ˆå…¬é’¥ï¼‰å’Œ private key

# æ·»åŠ ç­¾åè€…
docker trust signer add --key mykey.pub myuser myapp

# ç­¾åå¹¶æ¨é€é•œåƒ
docker trust sign myapp:v1.0
# éœ€è¦è¾“å…¥å¯†é’¥å¯†ç 
```

### 5.3 Notaryç­¾åæœåŠ¡


#### ğŸ›ï¸ Notaryæ¶æ„ç†è§£


**Notaryç»„ä»¶æ¶æ„ï¼š**
```
Notaryæ¶æ„å›¾ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Notary      â”‚    â”‚ Notary      â”‚    â”‚ TUF         â”‚
â”‚ Server      â”‚â†â†’  â”‚ Signer      â”‚â†â†’  â”‚ Metadata    â”‚
â”‚(ç­¾åéªŒè¯)    â”‚    â”‚(ç§é’¥ç®¡ç†)    â”‚    â”‚(ä¿¡ä»»æ•°æ®)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘                   â†‘                   â†‘
       â”‚                   â”‚                   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Docker Client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**TUF(The Update Framework)è§’è‰²ï¼š**
```
Root Keyï¼šæ ¹å¯†é’¥ï¼Œæœ€é«˜æƒé™ï¼Œç¦»çº¿ä¿å­˜
Targets Keyï¼šç›®æ ‡å¯†é’¥ï¼Œç­¾åå…·ä½“é•œåƒç‰ˆæœ¬
Snapshot Keyï¼šå¿«ç…§å¯†é’¥ï¼Œç­¾åä»“åº“çŠ¶æ€
Timestamp Keyï¼šæ—¶é—´æˆ³å¯†é’¥ï¼Œé˜²é‡æ”¾æ”»å‡»
```

#### âš™ï¸ Harboré›†æˆNotaryé…ç½®


```yaml
# harbor.ymlä¸­çš„Notaryé…ç½®
external_notary:
  enabled: true
  url: https://notary.company.com
  auth_mode: token
  token_service:
    issuer: harbor-token-issuer
    realm: https://harbor.company.com/service/token
    service: harbor-notary
```

**Notaryæ•°æ®åº“é…ç½®ï¼š**
```bash
# Notaryéœ€è¦ç‹¬ç«‹çš„MySQL/PostgreSQLæ•°æ®åº“
# docker-compose.notary.yml
version: '3'
services:
  notary-server:
    image: goharbor/notary-server-photon:v2.8.0
    environment:
      - NOTARY_SERVER_STORAGE_TYPE=mysql
      - NOTARY_SERVER_MYSQL_URL=notary:password@tcp(mysql:3306)/notaryserver
      - NOTARY_SERVER_AUTH_TYPE=token
```

### 5.4 é•œåƒç­¾åæœ€ä½³å®è·µ


#### ğŸ” å¯†é’¥ç®¡ç†ç­–ç•¥


**å¤šçº§å¯†é’¥ç®¡ç†ï¼š**
```
å¯†é’¥å®‰å…¨ç­‰çº§ï¼š

Root Key (æ ¹å¯†é’¥)ï¼š
- æœ€é«˜å®‰å…¨çº§åˆ«
- ç¦»çº¿å­˜å‚¨ï¼ˆç¡¬ä»¶å®‰å…¨æ¨¡å—æˆ–ç¦»çº¿è®¾å¤‡ï¼‰
- æå°‘ä½¿ç”¨ï¼Œåªåœ¨å¯†é’¥è½®æ¢æ—¶ä½¿ç”¨
- å¤šäººä¿ç®¡ï¼Œéœ€è¦å¤šé‡æˆæƒ

Repository Key (ä»“åº“å¯†é’¥)ï¼š
- é«˜å®‰å…¨çº§åˆ«  
- åœ¨çº¿å­˜å‚¨ä½†åŠ å¯†ä¿æŠ¤
- ç”¨äºæ—¥å¸¸é•œåƒç­¾å
- å®šæœŸè½®æ¢ï¼ˆå»ºè®®90å¤©ï¼‰

Timestamp Key (æ—¶é—´æˆ³å¯†é’¥)ï¼š
- ä¸­ç­‰å®‰å…¨çº§åˆ«
- è‡ªåŠ¨åŒ–ç³»ç»Ÿç®¡ç†
- ç”¨äºé˜²é‡æ”¾æ”»å‡»
- é¢‘ç¹è½®æ¢ï¼ˆå»ºè®®7å¤©ï¼‰
```

**å¯†é’¥è½®æ¢æµç¨‹ï¼š**
```bash
# å¯†é’¥è½®æ¢è„šæœ¬ç¤ºä¾‹
#!/bin/bash

# å¤‡ä»½å½“å‰å¯†é’¥
cp ~/.docker/trust/private/* /secure-backup/$(date +%Y%m%d)/

# ç”Ÿæˆæ–°å¯†é’¥
docker trust key generate new-repo-key

# æ›´æ–°ä»“åº“å¯†é’¥
docker trust signer add --key new-repo-key.pub admin myapp

# é‡æ–°ç­¾åç°æœ‰é•œåƒ
for tag in v1.0 v1.1 latest; do
    docker trust sign myapp:$tag
done

# éªŒè¯æ–°ç­¾å
docker trust inspect myapp --pretty
```

#### ğŸ“‹ ç­¾åç­–ç•¥é…ç½®


**ä¼ä¸šç­¾åç­–ç•¥ï¼š**
```yaml
# é•œåƒç­¾åç­–ç•¥ç¤ºä¾‹
signature_policy:
  # ç”Ÿäº§é•œåƒå¿…é¡»æœ‰ç­¾å
  production:
    - required_signatures: 2
    - signers: ["release-manager", "security-team"]
    - key_type: "ecdsa"
    - min_key_bits: 256
  
  # å¼€å‘é•œåƒå¯é€‰ç­¾å
  development:
    - required_signatures: 0
    - allow_unsigned: true
    
  # ç¬¬ä¸‰æ–¹é•œåƒä¿¡ä»»åˆ—è¡¨
  third_party:
    - trusted_registries: ["docker.io", "gcr.io"]
    - signature_verification: "warn"  # è­¦å‘Šä½†ä¸é˜»æ­¢
```

### 5.5 æ¼æ´æ‰«æä¸å®‰å…¨éªŒè¯


#### ğŸ” è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æ


**Trivyæ‰«æå™¨é›†æˆï¼š**
```bash
# å‘½ä»¤è¡Œä½¿ç”¨Trivyæ‰«æ
trivy image harbor.company.com/project/app:v1.0

# è¾“å‡ºç¤ºä¾‹ï¼š
2023-09-17T10:30:00.000Z    INFO    Detecting OS and Package Managers...
2023-09-17T10:30:01.000Z    INFO    Number of language-specific files: 1
2023-09-17T10:30:01.000Z    INFO    Detecting node.js vulnerabilities...

harbor.company.com/project/app:v1.0 (alpine 3.16.2)
====================================================
Total: 2 (UNKNOWN: 0, LOW: 1, MEDIUM: 0, HIGH: 1, CRITICAL: 0)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Library   â”‚ Vulnerability  â”‚ Severity â”‚ Installed Version â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ openssl     â”‚ CVE-2022-2097  â”‚ HIGH     â”‚ 1.1.1q-r0        â”‚
â”‚ zlib        â”‚ CVE-2022-37434 â”‚ LOW      â”‚ 1.2.12-r3        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ‰«æç­–ç•¥é…ç½®ï¼š**
```yaml
# Harboré¡¹ç›®æ‰«æç­–ç•¥
scan_policy:
  # è‡ªåŠ¨æ‰«æè§¦å‘æ¡ä»¶
  triggers:
    - on_push: true           # æ¨é€æ—¶æ‰«æ
    - on_schedule: "0 2 * * *" # æ¯æ—¥å‡Œæ™¨2ç‚¹æ‰«æ
  
  # æ¼æ´é˜»æ–­ç­–ç•¥
  vulnerability_allowlist:
    - cve_id: "CVE-2022-2097"
      expiration_date: "2024-01-01"  # ä¸´æ—¶å…è®¸ç‰¹å®šCVE
  
  # ä¸¥é‡ç¨‹åº¦é˜»æ–­
  severity_levels:
    - CRITICAL: block    # é˜»æ­¢éƒ¨ç½²
    - HIGH: warn        # è­¦å‘Šä½†å…è®¸
    - MEDIUM: ignore    # å¿½ç•¥
```

#### ğŸ›¡ï¸ è¿è¡Œæ—¶å®‰å…¨éªŒè¯


**å‡†å…¥æ§åˆ¶å™¨é…ç½®ï¼š**
```yaml
# Kuberneteså‡†å…¥æ§åˆ¶å™¨é…ç½®
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionWebhook
metadata:
  name: harbor-image-policy
webhooks:
- name: image.policy.harbor.io
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: [""]
    resources: ["pods"]
  admissionReviewVersions: ["v1", "v1beta1"]
  sideEffects: None
  failurePolicy: Fail  # éªŒè¯å¤±è´¥æ—¶æ‹’ç»éƒ¨ç½²
  clientConfig:
    service:
      name: harbor-policy-webhook
      namespace: harbor-system
      path: "/validate"
```

**é•œåƒç­–ç•¥éªŒè¯ï¼š**
```go
// å‡†å…¥æ§åˆ¶å™¨éªŒè¯é€»è¾‘ç¤ºä¾‹
func validateImage(image string) error {
    // 1. æ£€æŸ¥é•œåƒæ˜¯å¦æ¥è‡ªå¯ä¿¡ä»“åº“
    if !isTrustedRegistry(image) {
        return fmt.Errorf("é•œåƒæ¥æºä¸å¯ä¿¡: %s", image)
    }
    
    // 2. éªŒè¯é•œåƒç­¾å
    if !hasValidSignature(image) {
        return fmt.Errorf("é•œåƒç¼ºå°‘æœ‰æ•ˆç­¾å: %s", image)
    }
    
    // 3. æ£€æŸ¥æ¼æ´æ‰«æç»“æœ
    scanResult := getScanResult(image)
    if scanResult.HasCriticalVulnerabilities() {
        return fmt.Errorf("é•œåƒåŒ…å«ä¸¥é‡æ¼æ´: %s", image)
    }
    
    return nil
}
```

---

## 6. ğŸ“Š é•œåƒä»“åº“å®¡è®¡æ—¥å¿—


### 6.1 å®¡è®¡æ—¥å¿—åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯å®¡è®¡æ—¥å¿—ï¼Ÿ**
> å®¡è®¡æ—¥å¿—å°±åƒ"ç›‘æ§æ‘„åƒå¤´çš„å½•åƒ"ï¼Œè®°å½•è°åœ¨ä»€ä¹ˆæ—¶å€™åšäº†ä»€ä¹ˆæ“ä½œï¼Œç¡®ä¿æ‰€æœ‰æ´»åŠ¨éƒ½æœ‰è¿¹å¯æŸ¥ã€‚

```
å®¡è®¡çš„é‡è¦æ€§ï¼š

åˆè§„è¦æ±‚ï¼š
æ»¡è¶³ä¼ä¸šå®‰å…¨è§„èŒƒå’Œæ³•å¾‹æ³•è§„è¦æ±‚

å®‰å…¨è°ƒæŸ¥ï¼š  
å‘ç”Ÿå®‰å…¨äº‹ä»¶æ—¶å¯ä»¥è¿½æº¯åˆ†æ

è´£ä»»è¿½è¸ªï¼š
æ˜ç¡®æ“ä½œè´£ä»»ï¼Œé¿å…è¯¯æ“ä½œ

è¡Œä¸ºåˆ†æï¼š
å‘ç°å¼‚å¸¸è¡Œä¸ºæ¨¡å¼ï¼Œé¢„é˜²å®‰å…¨é£é™©
```

### 6.2 Harborå®¡è®¡åŠŸèƒ½é…ç½®


#### ğŸ“‹ å®¡è®¡äº‹ä»¶ç±»å‹


**Harborè®°å½•çš„å®¡è®¡äº‹ä»¶ï¼š**

| äº‹ä»¶ç±»å‹ | **å…·ä½“æ“ä½œ** | **è®°å½•ä¿¡æ¯** | **é£é™©ç­‰çº§** |
|---------|-------------|-------------|-------------|
| ğŸ” **è®¤è¯äº‹ä»¶** | `ç™»å½•ã€ç™»å‡ºã€è®¤è¯å¤±è´¥` | `ç”¨æˆ·ã€æ—¶é—´ã€IPã€ç»“æœ` | `é«˜` |
| ğŸ“¦ **é•œåƒæ“ä½œ** | `æ¨é€ã€æ‹‰å–ã€åˆ é™¤é•œåƒ` | `é•œåƒåã€ç‰ˆæœ¬ã€æ“ä½œè€…` | `ä¸­` |
| ğŸ‘¥ **æƒé™ç®¡ç†** | `ç”¨æˆ·åˆ›å»ºã€è§’è‰²å˜æ›´` | `æ“ä½œè€…ã€è¢«æ“ä½œç”¨æˆ·ã€æƒé™` | `é«˜` |
| âš™ï¸ **é…ç½®å˜æ›´** | `ç­–ç•¥ä¿®æ”¹ã€ç³»ç»Ÿé…ç½®` | `é…ç½®é¡¹ã€æ—§å€¼ã€æ–°å€¼` | `é«˜` |
| ğŸ” **å®‰å…¨æ‰«æ** | `æ¼æ´æ‰«æã€ç­–ç•¥æ£€æŸ¥` | `æ‰«æç»“æœã€è§¦å‘æ¡ä»¶` | `ä¸­` |

#### ğŸ“Š å®¡è®¡æ—¥å¿—æ ¼å¼


**æ ‡å‡†å®¡è®¡æ—¥å¿—æ ¼å¼ï¼š**
```json
{
  "timestamp": "2023-09-17T10:30:15.123Z",
  "level": "INFO",
  "event_type": "IMAGE_PUSH",
  "user": {
    "username": "developer1",
    "email": "dev1@company.com",
    "ip_address": "192.168.1.100"
  },
  "resource": {
    "type": "repository",
    "name": "project-web/frontend",
    "tag": "v2.1.0"
  },
  "operation": {
    "action": "PUSH",
    "result": "SUCCESS",
    "duration_ms": 5420
  },
  "metadata": {
    "user_agent": "Docker/20.10.17",
    "request_id": "req-123456",
    "project_id": 42
  }
}
```

### 6.3 æ—¥å¿—æ”¶é›†ä¸å­˜å‚¨


#### ğŸ“ æœ¬åœ°æ—¥å¿—ç®¡ç†


**Harboræ—¥å¿—é…ç½®ï¼š**
```yaml
# harbor.ymlä¸­çš„æ—¥å¿—é…ç½®
log:
  level: info                    # debug, info, warning, error, fatal
  local:
    rotate_count: 50            # ä¿ç•™æ—¥å¿—æ–‡ä»¶æ•°é‡
    rotate_size: 200M           # å•ä¸ªæ—¥å¿—æ–‡ä»¶å¤§å°
    location: /var/log/harbor   # æ—¥å¿—å­˜å‚¨ä½ç½®
  
  # å¤–éƒ¨æ—¥å¿—ç³»ç»Ÿé…ç½®
  external_endpoint:
    protocol: syslog            # syslog, fluentd
    host: logserver.company.com
    port: 514
```

**æ—¥å¿—è½®è½¬é…ç½®ï¼š**
```bash
# logrotateé…ç½®æ–‡ä»¶
cat > /etc/logrotate.d/harbor << 'EOF'
/var/log/harbor/*.log {
    daily                  # æ¯æ—¥è½®è½¬
    rotate 30             # ä¿ç•™30å¤©
    compress              # å‹ç¼©æ—§æ—¥å¿—
    delaycompress         # å»¶è¿Ÿå‹ç¼©
    missingok             # æ–‡ä»¶ä¸å­˜åœ¨ä¸æŠ¥é”™
    notifempty            # ç©ºæ–‡ä»¶ä¸è½®è½¬
    copytruncate          # å¤åˆ¶åæˆªæ–­ï¼Œé¿å…é‡å¯æœåŠ¡
}
EOF
```

#### ğŸ”„ é›†ä¸­å¼æ—¥å¿—ç®¡ç†


**ELK Stacké›†æˆï¼š**
```yaml
# docker-compose.ymlæ·»åŠ æ—¥å¿—é©±åŠ¨
version: '3'
services:
  registry:
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "harbor.registry"
        
  core:
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "harbor.core"
```

**Fluentdé…ç½®ç¤ºä¾‹ï¼š**
```xml
<!-- fluent.conf -->
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<match harbor.**>
  @type elasticsearch
  host elasticsearch.company.com
  port 9200
  index_name harbor-audit
  type_name _doc
  
  <buffer>
    flush_interval 10s
    chunk_limit_size 32MB
  </buffer>
</match>
```

### 6.4 æ—¥å¿—åˆ†æä¸ç›‘æ§


#### ğŸ“Š å…³é”®æŒ‡æ ‡ç›‘æ§


**å®¡è®¡æŒ‡æ ‡ä»ªè¡¨æ¿ï¼š**
```
å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š

è®¤è¯å®‰å…¨æŒ‡æ ‡ï¼š
- ç™»å½•å¤±è´¥æ¬¡æ•°/å°æ—¶
- å¼‚å¸¸IPç™»å½•å‘Šè­¦  
- ç”¨æˆ·æƒé™å˜æ›´é¢‘ç‡
- æ–°ç”¨æˆ·åˆ›å»ºè¶‹åŠ¿

é•œåƒæ“ä½œæŒ‡æ ‡ï¼š
- é•œåƒæ¨é€/æ‹‰å–é¢‘ç‡
- å¤§é•œåƒæ“ä½œå‘Šè­¦ï¼ˆ>1GBï¼‰
- åˆ é™¤æ“ä½œå®¡è®¡
- éå·¥ä½œæ—¶é—´æ“ä½œ

ç³»ç»Ÿå®‰å…¨æŒ‡æ ‡ï¼š
- é…ç½®å˜æ›´é¢‘ç‡
- é«˜å±æ¼æ´é•œåƒæ¨é€
- ç­–ç•¥è¿è§„äº‹ä»¶
- ç³»ç»Ÿé”™è¯¯ç‡è¶‹åŠ¿
```

**Prometheusç›‘æ§é…ç½®ï¼š**
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'harbor-audit'
    static_configs:
      - targets: ['harbor.company.com:8080']
    metrics_path: /api/v2.0/metrics
    scrape_interval: 30s
    
    # å®¡è®¡ç›¸å…³metrics
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: 'harbor_audit_.*'
        target_label: component
        replacement: audit
```

#### ğŸš¨ å¼‚å¸¸æ£€æµ‹ä¸å‘Šè­¦


**å¼‚å¸¸è¡Œä¸ºæ£€æµ‹è§„åˆ™ï¼š**
```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
- name: harbor-security
  rules:
  
  # çŸ­æ—¶é—´å†…å¤šæ¬¡ç™»å½•å¤±è´¥
  - alert: HarborBruteForceAttack
    expr: rate(harbor_login_failed_total[5m]) > 0.5
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Harborç–‘ä¼¼æš´åŠ›ç ´è§£æ”»å‡»"
      description: "IP {{ $labels.client_ip }} åœ¨5åˆ†é’Ÿå†…ç™»å½•å¤±è´¥è¶…è¿‡{{ $value }}æ¬¡"
  
  # éå·¥ä½œæ—¶é—´å¤§é‡é•œåƒæ“ä½œ
  - alert: HarborOffHoursActivity
    expr: rate(harbor_image_push_total[1h]) > 10 and hour() < 8 or hour() > 18
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Harboréå·¥ä½œæ—¶é—´å¼‚å¸¸æ´»åŠ¨"
      description: "éå·¥ä½œæ—¶é—´é•œåƒæ¨é€é¢‘ç‡å¼‚å¸¸ï¼š{{ $value }}æ¬¡/å°æ—¶"
```

**è‡ªåŠ¨åŒ–å“åº”é…ç½®ï¼š**
```bash
#!/bin/bash
# å¼‚å¸¸å“åº”è„šæœ¬

case "$1" in
  "brute_force")
    # æš´åŠ›ç ´è§£å“åº”
    ATTACKER_IP="$2"
    
    # ä¸´æ—¶å°ç¦IP
    iptables -A INPUT -s $ATTACKER_IP -j DROP
    
    # å‘é€å‘Šè­¦é‚®ä»¶
    echo "æ£€æµ‹åˆ°æ¥è‡ª$ATTACKER_IPçš„æš´åŠ›ç ´è§£æ”»å‡»ï¼Œå·²è‡ªåŠ¨å°ç¦" | \
      mail -s "Harborå®‰å…¨å‘Šè­¦" security@company.com
    
    # è®°å½•åˆ°å®‰å…¨æ—¥å¿—
    logger -t harbor-security "AUTO-BLOCK: $ATTACKER_IP brute force attack"
    ;;
    
  "privilege_escalation")
    # æƒé™æå‡å¼‚å¸¸
    USER="$2"
    
    # æš‚åœç”¨æˆ·è´¦æˆ·
    curl -X PUT "https://harbor.company.com/api/v2.0/users/$USER" \
      -H "Authorization: Basic $(echo -n admin:password | base64)" \
      -d '{"disabled": true}'
    
    # é€šçŸ¥ç®¡ç†å‘˜
    echo "ç”¨æˆ·$USERç–‘ä¼¼æƒé™æ»¥ç”¨ï¼Œå·²æš‚åœè´¦æˆ·" | \
      mail -s "Harboræƒé™å¼‚å¸¸" admin@company.com
    ;;
esac
```

### 6.5 åˆè§„æ€§å®¡è®¡


#### ğŸ“‹ åˆè§„æ€§è¦æ±‚


**å¸¸è§åˆè§„æ ‡å‡†ï¼š**
```
SOXåˆè§„è¦æ±‚ï¼š
- æ‰€æœ‰ITç³»ç»Ÿæ“ä½œéƒ½è¦è®°å½•
- å®¡è®¡æ—¥å¿—ä¸å¯ç¯¡æ”¹
- å®šæœŸå®¡è®¡æŠ¥å‘Š

ISO 27001è¦æ±‚ï¼š
- è®¿é—®æ§åˆ¶å®¡è®¡
- å®‰å…¨äº‹ä»¶è®°å½•
- æ—¥å¿—ä¿æŠ¤æªæ–½

PCI DSSè¦æ±‚ï¼š
- ç³»ç»Ÿè®¿é—®ç›‘æ§
- æ—¥å¿—å®šæœŸå®¡æŸ¥
- å¼‚å¸¸æ´»åŠ¨æ£€æµ‹
```

**å®¡è®¡æŠ¥å‘Šè‡ªåŠ¨ç”Ÿæˆï¼š**
```python
#!/usr/bin/env python3
# è‡ªåŠ¨å®¡è®¡æŠ¥å‘Šç”Ÿæˆè„šæœ¬

import json
import datetime
from elasticsearch import Elasticsearch

def generate_monthly_audit_report():
    es = Elasticsearch(['elasticsearch.company.com:9200'])
    
    # æŸ¥è¯¢ä¸Šæœˆå®¡è®¡æ•°æ®
    last_month = datetime.datetime.now() - datetime.timedelta(days=30)
    
    query = {
        "query": {
            "range": {
                "timestamp": {
                    "gte": last_month.isoformat(),
                    "lte": datetime.datetime.now().isoformat()
                }
            }
        },
        "aggs": {
            "by_event_type": {
                "terms": {"field": "event_type"}
            },
            "by_user": {
                "terms": {"field": "user.username", "size": 20}
            },
            "failed_logins": {
                "filter": {"term": {"event_type": "LOGIN_FAILED"}},
                "aggs": {
                    "by_ip": {"terms": {"field": "user.ip_address"}}
                }
            }
        }
    }
    
    result = es.search(index="harbor-audit-*", body=query)
    
    # ç”ŸæˆæŠ¥å‘Š
    report = {
        "period": f"{last_month.strftime('%Y-%m')}",
        "total_events": result['hits']['total']['value'],
        "event_breakdown": result['aggregations']['by_event_type']['buckets'],
        "top_users": result['aggregations']['by_user']['buckets'],
        "security_incidents": result['aggregations']['failed_logins']['by_ip']['buckets']
    }
    
    # ä¿å­˜æŠ¥å‘Š
    with open(f"harbor_audit_report_{last_month.strftime('%Y%m')}.json", 'w') as f:
        json.dump(report, f, indent=2)
    
    return report

if __name__ == "__main__":
    report = generate_monthly_audit_report()
    print(f"å®¡è®¡æŠ¥å‘Šå·²ç”Ÿæˆï¼Œå…±è®°å½•{report['total_events']}ä¸ªäº‹ä»¶")
```

#### ğŸ”’ å®¡è®¡æ•°æ®ä¿æŠ¤


**æ—¥å¿—å®Œæ•´æ€§ä¿æŠ¤ï¼š**
```bash
# ä½¿ç”¨æ•°å­—ç­¾åä¿æŠ¤æ—¥å¿—å®Œæ•´æ€§
#!/bin/bash

LOG_FILE="/var/log/harbor/audit.log"
SIGNATURE_FILE="${LOG_FILE}.sig"
PRIVATE_KEY="/etc/harbor/audit-sign.key"

# å¯¹æ—¥å¿—æ–‡ä»¶ç­¾å
openssl dgst -sha256 -sign $PRIVATE_KEY -out $SIGNATURE_FILE $LOG_FILE

# éªŒè¯æ—¥å¿—å®Œæ•´æ€§
verify_log_integrity() {
    PUBLIC_KEY="/etc/harbor/audit-verify.pub"
    
    if openssl dgst -sha256 -verify $PUBLIC_KEY -signature $SIGNATURE_FILE $LOG_FILE; then
        echo "æ—¥å¿—å®Œæ•´æ€§éªŒè¯é€šè¿‡"
        return 0
    else
        echo "è­¦å‘Šï¼šæ—¥å¿—å®Œæ•´æ€§éªŒè¯å¤±è´¥ï¼å¯èƒ½è¢«ç¯¡æ”¹"
        # å‘é€å‘Šè­¦
        logger -p local0.crit "AUDIT LOG INTEGRITY COMPROMISED"
        return 1
    fi
}

# å®šæ—¶éªŒè¯ï¼ˆæ¯å°æ—¶ï¼‰
echo "0 * * * * /opt/scripts/verify_log_integrity.sh" | crontab -
```

---

## 7. ğŸ—‘ï¸ é•œåƒæ¸…ç†ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†


### 7.1 é•œåƒç”Ÿå‘½å‘¨æœŸæ¦‚è¿°


**é•œåƒç”Ÿå‘½å‘¨æœŸé˜¶æ®µ**
> é•œåƒçš„ç”Ÿå‘½å‘¨æœŸå°±åƒ"äº§å“ä»ç”Ÿäº§åˆ°æŠ¥åºŸ"çš„è¿‡ç¨‹ï¼Œéœ€è¦åœ¨åˆé€‚çš„æ—¶æœºè¿›è¡Œæ¸…ç†ï¼Œé¿å…ä»“åº“"å›¤ç§¯è¿‡å¤šåº“å­˜"ã€‚

```
é•œåƒç”Ÿå‘½å‘¨æœŸé˜¶æ®µï¼š

åˆ›å»ºé˜¶æ®µ â†’ ä½¿ç”¨é˜¶æ®µ â†’ ç»´æŠ¤é˜¶æ®µ â†’ åºŸå¼ƒé˜¶æ®µ â†’ æ¸…ç†é˜¶æ®µ
   â†“         â†“         â†“         â†“         â†“
 æ„å»ºæ¨é€   é¢‘ç¹æ‹‰å–   å¶å°”ä½¿ç”¨   ä¸å†ä½¿ç”¨   åˆ é™¤é‡Šæ”¾

æ¸…ç†å†³ç­–å› ç´ ï¼š
â€¢ é•œåƒå¤§å°å’Œå­˜å‚¨æˆæœ¬
â€¢ æœ€åä½¿ç”¨æ—¶é—´
â€¢ ç‰ˆæœ¬é‡è¦æ€§
â€¢ åˆè§„ä¿ç•™è¦æ±‚
```

### 7.2 è‡ªåŠ¨åŒ–æ¸…ç†ç­–ç•¥


#### ğŸ“‹ æ¸…ç†è§„åˆ™è®¾è®¡


**åŸºäºæ—¶é—´çš„æ¸…ç†ç­–ç•¥ï¼š**
```yaml
# Harboræ¸…ç†ç­–ç•¥é…ç½®
retention_policy:
  # ä¿ç•™ç­–ç•¥è§„åˆ™
  rules:
    # ä¿ç•™æœ€è¿‘çš„ç¨³å®šç‰ˆæœ¬
    - priority: 1
      disabled: false
      action: retain
      template: latestPushedK
      params:
        latestPushedK: 5  # ä¿ç•™æœ€è¿‘æ¨é€çš„5ä¸ªç‰ˆæœ¬
      tag_selectors:
        - kind: doublestar
          pattern: "v*.*.*"  # åªåŒ¹é…ç‰ˆæœ¬æ ‡ç­¾
    
    # åˆ é™¤æ—§çš„å¼€å‘ç‰ˆæœ¬
    - priority: 2
      disabled: false
      action: retain
      template: nDayssSinceLastPush
      params:
        nDayssSinceLastPush: 7  # ä¿ç•™7å¤©å†…çš„ç‰ˆæœ¬
      tag_selectors:
        - kind: doublestar
          pattern: "dev-*"
    
    # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
    - priority: 3
      disabled: false
      action: retain
      template: nDayssSinceLastPull
      params:
        nDayssSinceLastPull: 30  # 30å¤©æœªæ‹‰å–çš„é•œåƒ
```

#### âš™ï¸ è‡ªåŠ¨åŒ–æ¸…ç†é…ç½®


**å®šæ—¶æ¸…ç†ä»»åŠ¡ï¼š**
```bash
#!/bin/bash
# é•œåƒè‡ªåŠ¨æ¸…ç†è„šæœ¬

HARBOR_URL="https://harbor.company.com"
HARBOR_USER="admin"
HARBOR_PASSWORD="password"

# è·å–æ‰€æœ‰é¡¹ç›®
projects=$(curl -s -u "$HARBOR_USER:$HARBOR_PASSWORD" \
  "$HARBOR_URL/api/v2.0/projects" | jq -r '.[].name')

for project in $projects; do
    echo "å¤„ç†é¡¹ç›®: $project"
    
    # æ‰§è¡Œæ¸…ç†ç­–ç•¥
    curl -X POST \
      -u "$HARBOR_USER:$HARBOR_PASSWORD" \
      -H "Content-Type: application/json" \
      "$HARBOR_URL/api/v2.0/projects/$project/repositories/*/artifacts" \
      -d '{
        "retention_policy": {
          "dry_run": false
        }
      }'
done

# æ¸…ç†orphaned layersï¼ˆå­¤ç«‹å±‚ï¼‰
echo "æ¸…ç†å­¤ç«‹çš„é•œåƒå±‚..."
curl -X POST \
  -u "$HARBOR_USER:$HARBOR_PASSWORD" \
  "$HARBOR_URL/api/v2.0/system/gc/schedule" \
  -d '{
    "schedule": {
      "type": "Manual"
    },
    "delete_untagged": true
  }'
```

### 7.3 å­˜å‚¨ç©ºé—´ä¼˜åŒ–


#### ğŸ“Š å­˜å‚¨åˆ†æ


**å­˜å‚¨ä½¿ç”¨æƒ…å†µåˆ†æï¼š**
```bash
#!/bin/bash
# Harborå­˜å‚¨åˆ†æè„šæœ¬

HARBOR_DATA_DIR="/data/harbor"

echo "=== Harborå­˜å‚¨ä½¿ç”¨æƒ…å†µåˆ†æ ==="
echo "æ€»å­˜å‚¨ç©ºé—´ä½¿ç”¨:"
df -h $HARBOR_DATA_DIR

echo -e "\nå„ç»„ä»¶å­˜å‚¨å ç”¨:"
du -sh $HARBOR_DATA_DIR/registry/docker/registry/v2/repositories/* | \
  sort -rh | head -20

echo -e "\nå¤§é•œåƒTOP 10:"
find $HARBOR_DATA_DIR -name "data" -type f -exec ls -lh {} \; | \
  sort -k5 -rh | head -10

echo -e "\nå­¤ç«‹å±‚ç»Ÿè®¡:"
# æŸ¥æ‰¾æ²¡æœ‰è¢«ä»»ä½•manifestå¼•ç”¨çš„layer
orphaned_layers=$(find $HARBOR_DATA_DIR/registry/docker/registry/v2/blobs -name "data" | wc -l)
echo "ç–‘ä¼¼å­¤ç«‹å±‚æ•°é‡: $orphaned_layers"
```

#### ğŸ—‚ï¸ é•œåƒå±‚å»é‡ä¼˜åŒ–


**é•œåƒå±‚å…±äº«åˆ†æï¼š**
```python
#!/usr/bin/env python3
import os
import hashlib
import json
from collections import defaultdict

def analyze_layer_deduplication(registry_path):
    """åˆ†æé•œåƒå±‚å»é‡æƒ…å†µ"""
    
    layer_usage = defaultdict(list)
    total_size = 0
    deduplicated_size = 0
    
    # éå†æ‰€æœ‰é•œåƒä»“åº“
    repositories_path = os.path.join(registry_path, "docker/registry/v2/repositories")
    
    for repo in os.listdir(repositories_path):
        repo_path = os.path.join(repositories_path, repo)
        manifests_path = os.path.join(repo_path, "_manifests/tags")
        
        if os.path.exists(manifests_path):
            for tag in os.listdir(manifests_path):
                manifest_file = os.path.join(manifests_path, tag, "current/link")
                if os.path.exists(manifest_file):
                    with open(manifest_file, 'r') as f:
                        layer_hash = f.read().strip().replace('sha256:', '')
                        layer_usage[layer_hash].append(f"{repo}:{tag}")
    
    # ç»Ÿè®¡å»é‡æ•ˆæœ
    for layer_hash, usage_list in layer_usage.items():
        usage_count = len(usage_list)
        if usage_count > 1:
            print(f"å±‚ {layer_hash[:12]}... è¢« {usage_count} ä¸ªé•œåƒå…±äº«")
            print(f"  ä½¿ç”¨çš„é•œåƒ: {', '.join(usage_list[:5])}")
            if len(usage_list) > 5:
                print(f"  ...è¿˜æœ‰ {len(usage_list) - 5} ä¸ªé•œåƒ")
    
    return layer_usage

if __name__ == "__main__":
    registry_path = "/data/harbor/registry"
    layer_analysis = analyze_layer_deduplication(registry_path)
    
    shared_layers = {k: v for k, v in layer_analysis.items() if len(v) > 1}
    total_layers = len(layer_analysis)
    shared_count = len(shared_layers)
    
    print(f"\n=== å»é‡åˆ†æç»“æœ ===")
    print(f"æ€»é•œåƒå±‚æ•°: {total_layers}")
    print(f"å…±äº«å±‚æ•°: {shared_count}")
    print(f"å»é‡æ•ˆç‡: {shared_count/total_layers*100:.1f}%")
```

### 7.4 åƒåœ¾å›æ”¶æœºåˆ¶


#### ğŸ—‘ï¸ Harbor GCé…ç½®


**åƒåœ¾å›æ”¶å·¥ä½œåŸç†ï¼š**
```
Harboråƒåœ¾å›æ”¶è¿‡ç¨‹ï¼š

1. æ ‡è®°é˜¶æ®µï¼ˆMarkï¼‰ï¼š
   - æ‰«ææ‰€æœ‰manifestæ–‡ä»¶
   - æ ‡è®°è¢«å¼•ç”¨çš„é•œåƒå±‚
   - è¯†åˆ«å­¤ç«‹çš„blobæ•°æ®

2. æ¸…ç†é˜¶æ®µï¼ˆSweepï¼‰ï¼š
   - åˆ é™¤æœªè¢«æ ‡è®°çš„é•œåƒå±‚
   - æ¸…ç†è¿‡æœŸçš„å…ƒæ•°æ®
   - é‡Šæ”¾å­˜å‚¨ç©ºé—´

3. å‹ç¼©é˜¶æ®µï¼ˆCompactï¼‰ï¼š
   - é‡æ–°ç»„ç»‡å­˜å‚¨å¸ƒå±€
   - ä¼˜åŒ–å­˜å‚¨æ•ˆç‡
```

**GCç­–ç•¥é…ç½®ï¼š**
```yaml
# Harbor GCé…ç½®
garbage_collection:
  # GCè°ƒåº¦è®¾ç½®
  schedule:
    type: "Daily"        # Daily, Weekly, Custom
    cron: "0 2 * * *"   # æ¯æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œ
  
  # GCé€‰é¡¹
  delete_untagged: true      # åˆ é™¤æ— æ ‡ç­¾é•œåƒ
  dry_run: false            # æ˜¯å¦ä¸ºè¯•è¿è¡Œæ¨¡å¼
  
  # å¹¶å‘æ§åˆ¶
  workers: 3                # å¹¶å‘å·¥ä½œçº¿ç¨‹æ•°
  
  # ä¿æŠ¤è®¾ç½®
  exclude_readonly: true    # æ’é™¤åªè¯»é¡¹ç›®
```

#### âš™ï¸ æ‰‹åŠ¨æ¸…ç†æ“ä½œ


**æ‰‹åŠ¨è§¦å‘GCï¼š**
```bash
# é€šè¿‡APIè§¦å‘GC
curl -X POST \
  -u "admin:password" \
  -H "Content-Type: application/json" \
  "https://harbor.company.com/api/v2.0/system/gc" \
  -d '{
    "schedule": {
      "type": "Manual"
    },
    "delete_untagged": true,
    "dry_run": false
  }'

# ç›‘æ§GCè¿›åº¦
gc_id=$(curl -s -u "admin:password" \
  "https://harbor.company.com/api/v2.0/system/gc" | \
  jq -r '.[] | select(.job_status=="Running") | .id')

# æŸ¥çœ‹GCè¯¦ç»†æ—¥å¿—
curl -s -u "admin:password" \
  "https://harbor.company.com/api/v2.0/system/gc/$gc_id/log"
```

**ç©ºé—´å›æ”¶éªŒè¯ï¼š**
```bash
#!/bin/bash
# GCå‰åç©ºé—´å¯¹æ¯”è„šæœ¬

HARBOR_DATA="/data/harbor"

echo "=== GCç©ºé—´å›æ”¶åˆ†æ ==="

# GCå‰ç©ºé—´ç»Ÿè®¡
before_size=$(du -sb $HARBOR_DATA | cut -f1)
echo "GCå‰æ€»ç©ºé—´: $(numfmt --to=iec $before_size)"

# æ‰§è¡ŒGCï¼ˆè¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„GC APIï¼‰
echo "æ­£åœ¨æ‰§è¡Œåƒåœ¾å›æ”¶..."

# ç­‰å¾…GCå®Œæˆ
sleep 60

# GCåç©ºé—´ç»Ÿè®¡  
after_size=$(du -sb $HARBOR_DATA | cut -f1)
echo "GCåæ€»ç©ºé—´: $(numfmt --to=iec $after_size)"

# è®¡ç®—å›æ”¶æ•ˆæœ
freed_space=$((before_size - after_size))
percentage=$(echo "scale=2; $freed_space * 100 / $before_size" | bc)

echo "å›æ”¶ç©ºé—´: $(numfmt --to=iec $freed_space)"
echo "å›æ”¶æ¯”ä¾‹: ${percentage}%"
```

### 7.5 åˆè§„æ€§æ¸…ç†ç®¡ç†


#### ğŸ“‹ æ³•è§„è¦æ±‚ä¸ä¿ç•™ç­–ç•¥


**ä¸åŒè¡Œä¸šçš„ä¿ç•™è¦æ±‚ï¼š**
```
é‡‘èè¡Œä¸šï¼š
- ç”Ÿäº§é•œåƒï¼šä¿ç•™7å¹´
- å®¡è®¡é•œåƒï¼šæ°¸ä¹…ä¿ç•™
- å¼€å‘é•œåƒï¼šä¿ç•™1å¹´

åŒ»ç–—è¡Œä¸šï¼š
- æ‚£è€…æ•°æ®ç›¸å…³ï¼šä¿ç•™30å¹´
- ä¸´åºŠè¯•éªŒé•œåƒï¼šä¿ç•™25å¹´
- ä¸€èˆ¬ä¸šåŠ¡é•œåƒï¼šä¿ç•™5å¹´

ä¸€èˆ¬ä¼ä¸šï¼š
- å‘å¸ƒç‰ˆæœ¬ï¼šä¿ç•™3å¹´
- å¼€å‘ç‰ˆæœ¬ï¼šä¿ç•™6ä¸ªæœˆ
- æµ‹è¯•é•œåƒï¼šä¿ç•™3ä¸ªæœˆ
```

**åˆè§„ä¿ç•™ç­–ç•¥é…ç½®ï¼š**
```yaml
# åˆè§„ä¿ç•™ç­–ç•¥
compliance_retention:
  # æŒ‰é•œåƒç±»å‹åˆ†ç±»ä¿ç•™
  policies:
    production:
      pattern: "v*.*.*"
      retention_days: 2555  # 7å¹´
      compliance_level: "critical"
      
    audit:
      pattern: "*-audit-*"
      retention_days: -1    # æ°¸ä¹…ä¿ç•™
      compliance_level: "critical"
      
    development:
      pattern: "dev-*, feature-*"
      retention_days: 365   # 1å¹´
      compliance_level: "normal"
      
    testing:
      pattern: "test-*, qa-*"  
      retention_days: 90    # 3ä¸ªæœˆ
      compliance_level: "low"
```

#### ğŸ”’ å®‰å…¨åˆ é™¤ä¸æ•°æ®é”€æ¯


**å®‰å…¨åˆ é™¤å®ç°ï¼š**
```bash
#!/bin/bash
# å®‰å…¨åˆ é™¤è„šæœ¬ï¼ˆç¬¦åˆæ•°æ®é”€æ¯æ ‡å‡†ï¼‰

secure_delete_image() {
    local repo="$1"
    local tag="$2"
    local data_path="/data/harbor/registry"
    
    echo "å¼€å§‹å®‰å…¨åˆ é™¤é•œåƒ: $repo:$tag"
    
    # 1. è®°å½•åˆ é™¤æ“ä½œåˆ°å®¡è®¡æ—¥å¿—
    logger -t harbor-secure-delete \
        "SECURE DELETE: User=$(whoami), Image=$repo:$tag, Time=$(date -Iseconds)"
    
    # 2. è·å–é•œåƒçš„æ‰€æœ‰blobå¼•ç”¨
    manifest_path="$data_path/docker/registry/v2/repositories/$repo/_manifests/tags/$tag"
    
    if [ -d "$manifest_path" ]; then
        # 3. æ ‡è®°ä¸ºå¾…åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰
        mv "$manifest_path" "${manifest_path}.deleted.$(date +%s)"
        
        # 4. å¤šæ¬¡è¦†å†™å­˜å‚¨ç©ºé—´ï¼ˆé˜²æ­¢æ•°æ®æ¢å¤ï¼‰
        find "${manifest_path}.deleted.*" -type f -exec shred -vfz -n 3 {} \;
        
        # 5. æœ€ç»ˆåˆ é™¤
        rm -rf "${manifest_path}.deleted.*"
        
        echo "å®‰å…¨åˆ é™¤å®Œæˆ: $repo:$tag"
        
        # 6. è®°å½•å®ŒæˆçŠ¶æ€
        logger -t harbor-secure-delete \
            "SECURE DELETE COMPLETED: Image=$repo:$tag"
    else
        echo "é”™è¯¯ï¼šé•œåƒä¸å­˜åœ¨ $repo:$tag"
    fi
}

# æ‰¹é‡å®‰å…¨åˆ é™¤
secure_delete_batch() {
    local deletion_list="$1"
    
    while IFS=':' read -r repo tag; do
        secure_delete_image "$repo" "$tag"
        sleep 1  # é¿å…IOè¿‡è½½
    done < "$deletion_list"
}

# ä½¿ç”¨ç¤ºä¾‹
# echo "myproject/app:v1.0" > deletion_list.txt  
# secure_delete_batch deletion_list.txt
```

---

## 8. ğŸ—ï¸ é•œåƒä»“åº“é«˜å¯ç”¨å®‰å…¨æ¶æ„


### 8.1 é«˜å¯ç”¨æ¶æ„è®¾è®¡


**ä»€ä¹ˆæ˜¯é«˜å¯ç”¨æ¶æ„ï¼Ÿ**
> é«˜å¯ç”¨å°±åƒ"å¤šæ¡è·¯å¾„åˆ°è¾¾ç›®çš„åœ°"ï¼Œå³ä½¿æŸæ¡è·¯å‡ºç°é—®é¢˜ï¼Œå…¶ä»–è·¯å¾„ä»èƒ½ä¿è¯æœåŠ¡æ­£å¸¸è¿è¡Œã€‚

```
é«˜å¯ç”¨æ¶æ„åŸåˆ™ï¼š

æ— å•ç‚¹æ•…éšœï¼š
ä»»ä½•å•ä¸ªç»„ä»¶å¤±æ•ˆéƒ½ä¸ä¼šå¯¼è‡´æ•´ä½“æœåŠ¡ä¸­æ–­

æ•…éšœè‡ªåŠ¨åˆ‡æ¢ï¼š
æ£€æµ‹åˆ°æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨ç³»ç»Ÿ

æ•°æ®ä¸€è‡´æ€§ï¼š
å¤šä¸ªèŠ‚ç‚¹é—´çš„æ•°æ®ä¿æŒåŒæ­¥

æœåŠ¡é™çº§ï¼š
åœ¨éƒ¨åˆ†åŠŸèƒ½å—é™æ—¶ä»èƒ½æä¾›æ ¸å¿ƒæœåŠ¡
```

### 8.2 Harboré›†ç¾¤æ¶æ„


#### ğŸ›ï¸ å¤šèŠ‚ç‚¹éƒ¨ç½²æ¶æ„


**Harbor HAæ¶æ„å›¾ï¼š**
```
Harboré«˜å¯ç”¨æ¶æ„ï¼š

                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   Load Balancer  â”‚ â† HAProxy/Nginx
                  â”‚   (VIP)         â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            â”‚            â”‚
         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”
         â”‚Harbor-1â”‚   â”‚Harbor-2â”‚   â”‚Harbor-3â”‚ â† HarborèŠ‚ç‚¹
         â”‚        â”‚   â”‚        â”‚   â”‚        â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
              â”‚            â”‚            â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  Shared Storage â”‚ â† å…±äº«å­˜å‚¨
                  â”‚  (NFS/Ceph)    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   Database HA   â”‚ â† æ•°æ®åº“é›†ç¾¤
                  â”‚ (MySQL Cluster) â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### âš™ï¸ è´Ÿè½½å‡è¡¡å™¨é…ç½®


**HAProxyé…ç½®ç¤ºä¾‹ï¼š**
```haproxy
# /etc/haproxy/haproxy.cfg
global
    daemon
    user haproxy
    group haproxy
    
defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    
# Harbor Webç•Œé¢è´Ÿè½½å‡è¡¡
frontend harbor_web
    bind *:443 ssl crt /etc/ssl/certs/harbor.pem
    redirect scheme https unless { ssl_fc }
    default_backend harbor_web_servers
    
backend harbor_web_servers
    balance roundrobin
    option httpchk GET /api/v2.0/health
    
    server harbor1 192.168.1.101:443 check ssl verify none
    server harbor2 192.168.1.102:443 check ssl verify none  
    server harbor3 192.168.1.103:443 check ssl verify none
    
# Docker Registry APIè´Ÿè½½å‡è¡¡
frontend harbor_registry
    bind *:5000 ssl crt /etc/ssl/certs/harbor.pem
    default_backend harbor_registry_servers
    
backend harbor_registry_servers
    balance source  # åŸºäºæºIPçš„ä¼šè¯ä¿æŒ
    option httpchk GET /v2/
    
    server registry1 192.168.1.101:5000 check ssl verify none
    server registry2 192.168.1.102:5000 check ssl verify none
    server registry3 192.168.1.103:5000 check ssl verify none
```

**Nginxé…ç½®æ–¹æ¡ˆï¼š**
```nginx
upstream harbor_backend {
    least_conn;  # æœ€å°‘è¿æ¥æ•°ç®—æ³•
    
    server 192.168.1.101:443 weight=1 max_fails=3 fail_timeout=30s;
    server 192.168.1.102:443 weight=1 max_fails=3 fail_timeout=30s;
    server 192.168.1.103:443 weight=1 max_fails=3 fail_timeout=30s;
}

server {
    listen 443 ssl http2;
    server_name harbor.company.com;
    
    ssl_certificate /etc/nginx/ssl/harbor.crt;
    ssl_certificate_key /etc/nginx/ssl/harbor.key;
    
    # å¥åº·æ£€æŸ¥
    location /health {
        proxy_pass https://harbor_backend/api/v2.0/health;
        proxy_set_header Host $host;
    }
    
    # ä¸»è¦ä»£ç†é…ç½®
    location / {
        proxy_pass https://harbor_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        
        # ä¸Šä¼ å¤§é•œåƒæ”¯æŒ
        client_max_body_size 0;
        proxy_request_buffering off;
    }
}
```

### 8.3 æ•°æ®å±‚é«˜å¯ç”¨


#### ğŸ—„ï¸ æ•°æ®åº“é›†ç¾¤é…ç½®


**MySQLä¸»ä»å¤åˆ¶é…ç½®ï¼š**
```sql
-- ä¸»åº“é…ç½® (my.cnf)
[mysqld]
server-id=1
log-bin=mysql-bin
binlog-format=ROW
gtid-mode=ON
enforce-gtid-consistency=ON

-- åˆ›å»ºå¤åˆ¶ç”¨æˆ·
CREATE USER 'repl'@'192.168.1.%' IDENTIFIED BY 'ReplicationPassword123!';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'192.168.1.%';

-- ä»åº“é…ç½®
[mysqld]
server-id=2
read-only=1
relay-log=mysql-relay-bin

-- é…ç½®å¤åˆ¶
CHANGE MASTER TO
  MASTER_HOST='192.168.1.101',
  MASTER_USER='repl',
  MASTER_PASSWORD='ReplicationPassword123!',
  MASTER_AUTO_POSITION=1;

START SLAVE;
```

**PostgreSQLæµå¤åˆ¶é…ç½®ï¼š**
```postgresql
-- postgresql.conf (ä¸»åº“)
wal_level = replica
max_wal_senders = 3
max_replication_slots = 3
hot_standby = on

-- pg_hba.conf
host replication repl 192.168.1.0/24 md5

-- å¤‡åº“é…ç½®
standby_mode = 'on'
primary_conninfo = 'host=192.168.1.101 port=5432 user=repl password=xxx'
```

#### ğŸ“ å­˜å‚¨é«˜å¯ç”¨æ–¹æ¡ˆ


**å…±äº«å­˜å‚¨é€‰é¡¹å¯¹æ¯”ï¼š**

| å­˜å‚¨æ–¹æ¡ˆ | **å¯ç”¨æ€§** | **æ€§èƒ½** | **å¤æ‚åº¦** | **æˆæœ¬** | **æ¨èåœºæ™¯** |
|---------|-----------|---------|-----------|---------|-------------|
| ğŸ”„ **NFS** | `ä¸­ç­‰` | `ä¸­ç­‰` | `ç®€å•` | `ä½` | `å°è§„æ¨¡éƒ¨ç½²` |
| ğŸ—ï¸ **Ceph** | `å¾ˆé«˜` | `é«˜` | `å¤æ‚` | `ä¸­ç­‰` | `å¤§è§„æ¨¡ä¼ä¸š` |
| â˜ï¸ **äº‘å­˜å‚¨** | `å¾ˆé«˜` | `é«˜` | `ç®€å•` | `é«˜` | `äº‘ç¯å¢ƒéƒ¨ç½²` |
| ğŸ“¦ **GlusterFS** | `é«˜` | `ä¸­ç­‰` | `ä¸­ç­‰` | `ä½` | `æ··åˆç¯å¢ƒ` |

**Cephå­˜å‚¨é›†ç¾¤é…ç½®ï¼š**
```yaml
# ceph.conf
[global]
fsid = 12345678-1234-1234-1234-123456789012
mon_initial_members = ceph1,ceph2,ceph3
mon_host = 192.168.1.201,192.168.1.202,192.168.1.203
auth_cluster_required = cephx
auth_service_required = cephx
auth_client_required = cephx

[client.harbor]
key = AQBxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx==
```

```bash
# Harborä½¿ç”¨Cephå­˜å‚¨é…ç½®
mkdir -p /mnt/harbor-ceph
mount -t ceph 192.168.1.201:6789:/ /mnt/harbor-ceph \
  -o name=harbor,secret=AQBxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx==

# Harboré…ç½®ä½¿ç”¨å…±äº«å­˜å‚¨
# harbor.yml
data_volume: /mnt/harbor-ceph
```

### 8.4 ç½‘ç»œå®‰å…¨ä¸éš”ç¦»


#### ğŸ”’ ç½‘ç»œåˆ†æ®µè®¾è®¡


**ç½‘ç»œå®‰å…¨æ¶æ„ï¼š**
```
ç½‘ç»œåˆ†æ®µå®‰å…¨è®¾è®¡ï¼š

DMZåŒºåŸŸ (å¯¹å¤–æœåŠ¡)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Load Balancer + WAF               â”‚ â† å…¬ç½‘è®¿é—®å…¥å£
â”‚  IP: å…¬ç½‘IP                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ é˜²ç«å¢™è§„åˆ™
              â–¼
åº”ç”¨åŒºåŸŸ (HarborèŠ‚ç‚¹)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Harbor-1  Harbor-2  Harbor-3     â”‚ â† å†…ç½‘IPæ®µ
â”‚  192.168.1.101-103                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ æ•°æ®åº“é˜²ç«å¢™
              â–¼
æ•°æ®åŒºåŸŸ (æ•°æ®åº“+å­˜å‚¨)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MySQL Cluster  +  Shared Storage  â”‚ â† é«˜å®‰å…¨å†…ç½‘
â”‚  172.16.1.0/24                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é˜²ç«å¢™è§„åˆ™é…ç½®ï¼š**
```bash
#!/bin/bash
# Harborç½‘ç»œå®‰å…¨è§„åˆ™

# æ¸…ç©ºç°æœ‰è§„åˆ™
iptables -F
iptables -X
iptables -Z

# è®¾ç½®é»˜è®¤ç­–ç•¥
iptables -P INPUT DROP
iptables -P FORWARD DROP  
iptables -P OUTPUT ACCEPT

# å…è®¸ç¯å›æ¥å£
iptables -A INPUT -i lo -j ACCEPT

# å…è®¸å·²å»ºç«‹çš„è¿æ¥
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# å…è®¸æ¥è‡ªè´Ÿè½½å‡è¡¡å™¨çš„è¿æ¥
iptables -A INPUT -s 192.168.1.100 -p tcp --dport 443 -j ACCEPT
iptables -A INPUT -s 192.168.1.100 -p tcp --dport 5000 -j ACCEPT

# å…è®¸HarborèŠ‚ç‚¹é—´é€šä¿¡
iptables -A INPUT -s 192.168.1.101/24 -p tcp --dport 5432 -j ACCEPT  # PostgreSQL
iptables -A INPUT -s 192.168.1.101/24 -p tcp --dport 6379 -j ACCEPT  # Redis

# å…è®¸ç®¡ç†ç½‘ç»œè®¿é—®
iptables -A INPUT -s 10.0.0.0/8 -p tcp --dport 22 -j ACCEPT  # SSH

# è®°å½•æ‹’ç»çš„è¿æ¥
iptables -A INPUT -j LOG --log-prefix "HARBOR-DENY: "
iptables -A INPUT -j DROP

# ä¿å­˜è§„åˆ™
iptables-save > /etc/iptables/rules.v4
```

#### ğŸ›¡ï¸ WAFä¸DDoSé˜²æŠ¤


**ModSecurity WAFè§„åˆ™ï¼š**
```apache
# Harbor WAFè§„åˆ™
<IfModule mod_security2.c>
    SecRuleEngine On
    SecDataDir /var/cache/modsecurity/
    
    # åŸºç¡€å®‰å…¨è§„åˆ™
    SecRule REQUEST_METHOD "@streq GET" \
        "id:1001,phase:1,block,msg:'Only GET allowed',logdata:'Method: %{REQUEST_METHOD}'"
    
    # é˜²æ­¢SQLæ³¨å…¥
    SecRule ARGS "@detectSQLi" \
        "id:1002,phase:2,block,msg:'SQL Injection Attack',logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}'"
    
    # é™åˆ¶è¯·æ±‚å¤§å°ï¼ˆé•œåƒä¸Šä¼ é™¤å¤–ï¼‰
    SecRule REQUEST_URI "!@beginsWith /v2/" \
        "id:1003,phase:1,t:none,pass,setvar:'tx.max_file_size=1048576'"
        
    # Harborç‰¹å®šè§„åˆ™ - ä¿æŠ¤ç®¡ç†æ¥å£
    SecRule REQUEST_URI "@beginsWith /api/v2.0/users" \
        "id:2001,phase:1,block,msg:'Admin API access blocked',logdata:'URI: %{REQUEST_URI}'"
        
    # é˜²æ­¢é•œåƒåæ³¨å…¥
    SecRule REQUEST_URI "@rx /v2/([^/]+)/manifests/.*[\<\>\"'&]" \
        "id:2002,phase:1,block,msg:'Invalid manifest path'"
</IfModule>
```

**DDoSé˜²æŠ¤é…ç½®ï¼š**
```bash
# ä½¿ç”¨iptablesè¿›è¡ŒåŸºç¡€DDoSé˜²æŠ¤

# é™åˆ¶è¿æ¥é¢‘ç‡
iptables -A INPUT -p tcp --dport 443 -m limit --limit 25/minute --limit-burst 100 -j ACCEPT

# SYN floodé˜²æŠ¤
echo 1 > /proc/sys/net/ipv4/tcp_syncookies
echo 2048 > /proc/sys/net/ipv4/tcp_max_syn_backlog
echo 3 > /proc/sys/net/ipv4/tcp_synack_retries

# é™åˆ¶å¹¶å‘è¿æ¥æ•°
iptables -A INPUT -p tcp --dport 443 -m connlimit --connlimit-above 50 -j REJECT

# ä½¿ç”¨fail2bané˜²æŠ¤
cat > /etc/fail2ban/jail.d/harbor.conf << 'EOF'
[harbor-auth]
enabled = true
filter = harbor-auth
logpath = /var/log/harbor/core.log
maxretry = 5
bantime = 3600
findtime = 600
action = iptables[name=harbor, port=443, protocol=tcp]

[harbor-registry]  
enabled = true
filter = harbor-registry
logpath = /var/log/harbor/registry.log
maxretry = 10
bantime = 1800
EOF
```

### 8.5 ç¾éš¾æ¢å¤ä¸å¤‡ä»½


#### ğŸ’¾ å¤‡ä»½ç­–ç•¥è®¾è®¡


**3-2-1å¤‡ä»½åŸåˆ™ï¼š**
```
3-2-1å¤‡ä»½åŸåˆ™ï¼š
3ä»½æ•°æ®å‰¯æœ¬ï¼šç”Ÿäº§æ•°æ® + 2ä»½å¤‡ä»½
2ç§ä¸åŒå­˜å‚¨ä»‹è´¨ï¼šæœ¬åœ°å­˜å‚¨ + ç½‘ç»œå­˜å‚¨
1ä»½å¼‚åœ°å¤‡ä»½ï¼šé˜²èŒƒç¾éš¾æ€§äº‹æ•…

Harborå¤‡ä»½å†…å®¹ï¼š
â€¢ é•œåƒæ•°æ®ï¼ˆregistryå­˜å‚¨ï¼‰
â€¢ æ•°æ®åº“æ•°æ®ï¼ˆç”¨æˆ·ã€é¡¹ç›®ã€é…ç½®ï¼‰
â€¢ é…ç½®æ–‡ä»¶ï¼ˆharbor.ymlç­‰ï¼‰
â€¢ SSLè¯ä¹¦å’Œå¯†é’¥
â€¢ å®¡è®¡æ—¥å¿—
```

**è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬ï¼š**
```bash
#!/bin/bash
# Harborå…¨é‡å¤‡ä»½è„šæœ¬

BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/harbor/$BACKUP_DATE"
HARBOR_DIR="/opt/harbor"
DATA_DIR="/data/harbor"

echo "å¼€å§‹Harborå¤‡ä»½: $BACKUP_DATE"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# 1. åœæ­¢HarboræœåŠ¡ï¼ˆå¯é€‰ï¼Œå–å†³äºæ˜¯å¦éœ€è¦ä¸€è‡´æ€§ï¼‰
# cd $HARBOR_DIR && docker-compose down

# 2. å¤‡ä»½é…ç½®æ–‡ä»¶
echo "å¤‡ä»½é…ç½®æ–‡ä»¶..."
cp -r $HARBOR_DIR/harbor.yml "$BACKUP_DIR/"
cp -r $HARBOR_DIR/docker-compose.yml "$BACKUP_DIR/"

# 3. å¤‡ä»½æ•°æ®åº“
echo "å¤‡ä»½æ•°æ®åº“..."
docker exec harbor-db pg_dump -U postgres registry > "$BACKUP_DIR/database.sql"

# 4. å¤‡ä»½é•œåƒæ•°æ®ï¼ˆå¢é‡å¤‡ä»½ï¼‰
echo "å¤‡ä»½é•œåƒæ•°æ®..."
rsync -avz --link-dest="/backup/harbor/latest/registry" \
  "$DATA_DIR/registry/" "$BACKUP_DIR/registry/"

# 5. å¤‡ä»½è¯ä¹¦
echo "å¤‡ä»½è¯ä¹¦..."
cp -r $HARBOR_DIR/ssl "$BACKUP_DIR/" 2>/dev/null || true

# 6. åˆ›å»ºæœ€æ–°å¤‡ä»½è½¯é“¾æ¥
rm -f /backup/harbor/latest
ln -s "$BACKUP_DIR" /backup/harbor/latest

# 7. å‹ç¼©å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
# cd /backup/harbor && tar -czf "harbor_backup_$BACKUP_DATE.tar.gz" "$BACKUP_DATE"

# 8. é‡å¯HarboræœåŠ¡
# cd $HARBOR_DIR && docker-compose up -d

# 9. æ¸…ç†è€å¤‡ä»½ï¼ˆä¿ç•™30å¤©ï¼‰
find /backup/harbor -maxdepth 1 -type d -mtime +30 -exec rm -rf {} \;

echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR"

# 10. å‘é€å¤‡ä»½çŠ¶æ€é€šçŸ¥
echo "Harborå¤‡ä»½å·²å®Œæˆ: $BACKUP_DATE" | \
  mail -s "Harborå¤‡ä»½æŠ¥å‘Š" admin@company.com
```

#### ğŸ”„ ç¾éš¾æ¢å¤æµç¨‹


**æ¢å¤æµç¨‹SOPï¼š**
```bash
#!/bin/bash
# Harborç¾éš¾æ¢å¤æ ‡å‡†æµç¨‹

RESTORE_POINT="$1"  # æ¢å¤ç‚¹ç›®å½•

if [ -z "$RESTORE_POINT" ]; then
    echo "ç”¨æ³•: $0 <æ¢å¤ç‚¹ç›®å½•>"
    echo "å¯ç”¨æ¢å¤ç‚¹:"
    ls -la /backup/harbor/ | grep "^d"
    exit 1
fi

echo "=== Harborç¾éš¾æ¢å¤æµç¨‹ ==="
echo "æ¢å¤ç‚¹: $RESTORE_POINT"
echo "å¼€å§‹æ—¶é—´: $(date)"

# 1. ç¡®è®¤æ¢å¤æ“ä½œ
read -p "ç¡®è®¤è¦æ¢å¤åˆ° $RESTORE_POINT å—? [y/N]: " confirm
if [ "$confirm" != "y" ]; then
    echo "å–æ¶ˆæ¢å¤æ“ä½œ"
    exit 0
fi

# 2. åœæ­¢ç°æœ‰HarboræœåŠ¡
echo "æ­¥éª¤1: åœæ­¢HarboræœåŠ¡"
cd /opt/harbor && docker-compose down

# 3. æ¢å¤é…ç½®æ–‡ä»¶
echo "æ­¥éª¤2: æ¢å¤é…ç½®æ–‡ä»¶"
cp "/backup/harbor/$RESTORE_POINT/harbor.yml" /opt/harbor/
cp "/backup/harbor/$RESTORE_POINT/docker-compose.yml" /opt/harbor/

# 4. æ¢å¤æ•°æ®åº“
echo "æ­¥éª¤3: æ¢å¤æ•°æ®åº“"
# å¯åŠ¨ä¸´æ—¶æ•°æ®åº“å®¹å™¨è¿›è¡Œæ¢å¤
docker run --name temp-db -e POSTGRES_PASSWORD=password -d postgres:13
sleep 10

# æ¢å¤æ•°æ®åº“æ•°æ®
docker exec -i temp-db psql -U postgres -c "CREATE DATABASE registry;"
docker exec -i temp-db psql -U postgres registry < "/backup/harbor/$RESTORE_POINT/database.sql"

# 5. æ¢å¤é•œåƒæ•°æ®
echo "æ­¥éª¤4: æ¢å¤é•œåƒæ•°æ®"  
rm -rf /data/harbor/registry
cp -r "/backup/harbor/$RESTORE_POINT/registry" /data/harbor/

# 6. æ¢å¤è¯ä¹¦æ–‡ä»¶
echo "æ­¥éª¤5: æ¢å¤è¯ä¹¦"
cp -r "/backup/harbor/$RESTORE_POINT/ssl" /opt/harbor/ 2>/dev/null || true

# 7. å¯åŠ¨HarboræœåŠ¡
echo "æ­¥éª¤6: å¯åŠ¨HarboræœåŠ¡"
cd /opt/harbor && ./install.sh

# 8. éªŒè¯æ¢å¤ç»“æœ
echo "æ­¥éª¤7: éªŒè¯æ¢å¤"
sleep 30

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
if curl -k -s https://harbor.company.com/api/v2.0/health | grep -q "healthy"; then
    echo "âœ“ HarboræœåŠ¡æ¢å¤æˆåŠŸ"
else
    echo "âœ— HarboræœåŠ¡æ¢å¤å¤±è´¥"
    exit 1
fi

# æ¸…ç†ä¸´æ—¶èµ„æº
docker stop temp-db && docker rm temp-db

echo "=== æ¢å¤å®Œæˆ ==="
echo "å®Œæˆæ—¶é—´: $(date)"
echo "è¯·éªŒè¯ä»¥ä¸‹åŠŸèƒ½:"
echo "- Webç•Œé¢è®¿é—®"
echo "- é•œåƒæ¨é€æ‹‰å–"
echo "- ç”¨æˆ·è®¤è¯"
echo "- é¡¹ç›®æƒé™"
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç§æœ‰ä»“åº“ï¼šä¼ä¸šçº§é•œåƒå­˜å‚¨ä¸ç®¡ç†çš„å®‰å…¨ä¿éšœ
ğŸ”¸ æƒé™æ§åˆ¶ï¼šåŸºäºRBACçš„ç»†ç²’åº¦è®¿é—®æ§åˆ¶ä½“ç³»
ğŸ”¸ ä¼ è¾“åŠ å¯†ï¼šHTTPS/TLSç¡®ä¿æ•°æ®ä¼ è¾“å®‰å…¨
ğŸ”¸ èº«ä»½è®¤è¯ï¼šå¤šå±‚æ¬¡è®¤è¯æœºåˆ¶ä¿æŠ¤ä»“åº“è®¿é—®
ğŸ”¸ å®Œæ•´æ€§éªŒè¯ï¼šæ•°å­—ç­¾åä¸å†…å®¹æ ¡éªŒç¡®ä¿é•œåƒå¯ä¿¡
ğŸ”¸ å®¡è®¡æ—¥å¿—ï¼šå…¨é¢è®°å½•æ“ä½œè¡Œä¸ºï¼Œæ”¯æŒåˆè§„è¦æ±‚
ğŸ”¸ ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šè‡ªåŠ¨åŒ–æ¸…ç†ä¸å­˜å‚¨ä¼˜åŒ–
ğŸ”¸ é«˜å¯ç”¨æ¶æ„ï¼šç¡®ä¿æœåŠ¡æŒç»­ç¨³å®šè¿è¡Œ
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å®‰å…¨æ˜¯å¤šå±‚é˜²æŠ¤**
```
ç½‘ç»œå±‚å®‰å…¨ï¼šé˜²ç«å¢™ã€VPNã€ç½‘ç»œéš”ç¦»
ä¼ è¾“å±‚å®‰å…¨ï¼šTLSåŠ å¯†ã€è¯ä¹¦éªŒè¯
åº”ç”¨å±‚å®‰å…¨ï¼šè®¤è¯æˆæƒã€APIå®‰å…¨
æ•°æ®å±‚å®‰å…¨ï¼šé•œåƒç­¾åã€å®Œæ•´æ€§æ ¡éªŒ
è¿ç»´å±‚å®‰å…¨ï¼šå®¡è®¡æ—¥å¿—ã€ç›‘æ§å‘Šè­¦
```

**ğŸ”¹ æƒé™è®¾è®¡åŸåˆ™**
```
æœ€å°æƒé™ï¼šåªç»™å¿…éœ€çš„æœ€å°æƒé™
èŒè´£åˆ†ç¦»ï¼šä¸åŒè§’è‰²æ‰¿æ‹…ä¸åŒèŒè´£
å®šæœŸå®¡æŸ¥ï¼šæƒé™å®šæœŸæ¸…ç†å’Œç¡®è®¤
å®¡æ‰¹æµç¨‹ï¼šé‡è¦æƒé™å˜æ›´éœ€è¦å®¡æ‰¹
```

**ğŸ”¹ é«˜å¯ç”¨ä¸åªæ˜¯æŠ€æœ¯**
```
æŠ€æœ¯å±‚é¢ï¼šå†—ä½™éƒ¨ç½²ã€æ•…éšœåˆ‡æ¢
æµç¨‹å±‚é¢ï¼šå˜æ›´ç®¡ç†ã€åº”æ€¥å“åº”
äººå‘˜å±‚é¢ï¼šæŠ€èƒ½åŸ¹è®­ã€è´£ä»»åˆ†å·¥
ç›‘æ§å±‚é¢ï¼šå…¨æ–¹ä½ç›‘æ§ã€é¢„è­¦æœºåˆ¶
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä¸åŒè§„æ¨¡ä¼ä¸šçš„éƒ¨ç½²å»ºè®®**

```
å°å‹ä¼ä¸šï¼ˆ<50äººï¼‰ï¼š
â€¢ å•èŠ‚ç‚¹Harbor + å¤–éƒ¨æ•°æ®åº“
â€¢ åŸºç¡€HTTPS + ç”¨æˆ·åå¯†ç è®¤è¯
â€¢ ç®€å•çš„ä¿ç•™ç­–ç•¥
â€¢ åŸºç¡€ç›‘æ§å‘Šè­¦

ä¸­å‹ä¼ä¸šï¼ˆ50-500äººï¼‰ï¼š
â€¢ HarboråŒèŠ‚ç‚¹HA + è´Ÿè½½å‡è¡¡  
â€¢ LDAPé›†æˆ + åŒå› ç´ è®¤è¯
â€¢ è‡ªåŠ¨åŒ–æ¸…ç† + æ¼æ´æ‰«æ
â€¢ ELKæ—¥å¿—åˆ†æ

å¤§å‹ä¼ä¸šï¼ˆ>500äººï¼‰ï¼š
â€¢ å¤šèŠ‚ç‚¹é›†ç¾¤ + å…±äº«å­˜å‚¨
â€¢ SSOé›†æˆ + è¯ä¹¦è®¤è¯
â€¢ å®Œæ•´å®¡è®¡ + åˆè§„ç®¡ç†
â€¢ å¤šåœ°åŸŸç¾å¤‡
```

**ğŸ¯ å®‰å…¨æˆç†Ÿåº¦æ¼”è¿›è·¯å¾„**

```
åŸºç¡€çº§ï¼ˆLevel 1ï¼‰ï¼š
âœ“ HTTPSä¼ è¾“åŠ å¯†
âœ“ åŸºç¡€ç”¨æˆ·è®¤è¯
âœ“ ç®€å•æƒé™æ§åˆ¶

è¿›é˜¶çº§ï¼ˆLevel 2ï¼‰ï¼š
âœ“ ä¼ä¸šè®¤è¯é›†æˆ
âœ“ é•œåƒæ¼æ´æ‰«æ  
âœ“ å®¡è®¡æ—¥å¿—è®°å½•
âœ“ è‡ªåŠ¨åŒ–å¤‡ä»½

ä¸“å®¶çº§ï¼ˆLevel 3ï¼‰ï¼š
âœ“ é•œåƒç­¾åéªŒè¯
âœ“ é«˜çº§å¨èƒæ£€æµ‹
âœ“ è‡ªåŠ¨åŒ–å“åº”
âœ“ é›¶ä¿¡ä»»æ¶æ„
```

### 9.4 è¿ç»´æœ€ä½³å®è·µ


**ğŸ”§ æ—¥å¸¸è¿ç»´æ£€æŸ¥æ¸…å•**

```
æ¯æ—¥æ£€æŸ¥ï¼š
â–¡ æœåŠ¡çŠ¶æ€ç›‘æ§
â–¡ å­˜å‚¨ç©ºé—´ä½¿ç”¨
â–¡ é”™è¯¯æ—¥å¿—æŸ¥çœ‹
â–¡ å¤‡ä»½çŠ¶æ€ç¡®è®¤

æ¯å‘¨æ£€æŸ¥ï¼š  
â–¡ æƒé™è®¿é—®å®¡æŸ¥
â–¡ é•œåƒæ¼æ´æ‰«æ
â–¡ æ€§èƒ½æŒ‡æ ‡åˆ†æ
â–¡ å®‰å…¨å‘Šè­¦å¤„ç†

æ¯æœˆæ£€æŸ¥ï¼š
â–¡ ç”¨æˆ·æƒé™æ¸…ç†
â–¡ é•œåƒæ¸…ç†ç­–ç•¥æ‰§è¡Œ
â–¡ å®¡è®¡æŠ¥å‘Šç”Ÿæˆ
â–¡ ç¾å¤‡æ¼”ç»ƒ

æ¯å­£åº¦æ£€æŸ¥ï¼š
â–¡ å®‰å…¨ç­–ç•¥æ›´æ–°
â–¡ æƒé™æ¨¡å‹ä¼˜åŒ–
â–¡ æ¶æ„å®¹é‡è§„åˆ’
â–¡ åˆè§„æ€§å®¡è®¡
```

**ğŸš¨ åº”æ€¥å“åº”æµç¨‹**

```
å®‰å…¨äº‹ä»¶å“åº”ï¼š
1. äº‹ä»¶å‘ç° â†’ 2. å½±å“è¯„ä¼° â†’ 3. åº”æ€¥å¤„ç½® â†’ 4. æ ¹å› åˆ†æ â†’ 5. æ”¹è¿›æªæ–½

å…·ä½“æ­¥éª¤ï¼š
å‘ç°å¼‚å¸¸ â†’ ç«‹å³éš”ç¦» â†’ ä¿æŠ¤ç°åœº â†’ é€šçŸ¥ç›¸å…³æ–¹ â†’ åˆ†æåŸå›  â†’ ä¿®å¤æ¼æ´ â†’ æ€»ç»“æ”¹è¿›
```

### 9.5 å‘å±•è¶‹åŠ¿ä¸å»ºè®®


**ğŸš€ æŠ€æœ¯å‘å±•è¶‹åŠ¿**

```
å®¹å™¨å®‰å…¨è¶‹åŠ¿ï¼š
â€¢ é›¶ä¿¡ä»»ç½‘ç»œæ¶æ„
â€¢ è¿è¡Œæ—¶å®‰å…¨é˜²æŠ¤
â€¢ AIè¾…åŠ©å¨èƒæ£€æµ‹
â€¢ è‡ªåŠ¨åŒ–å®‰å…¨å“åº”

å»ºè®®å…³æ³¨æŠ€æœ¯ï¼š
â€¢ OPA(Open Policy Agent)ç­–ç•¥å¼•æ“
â€¢ Falcoè¿è¡Œæ—¶å®‰å…¨ç›‘æ§
â€¢ Sigstoreä¾›åº”é“¾å®‰å…¨
â€¢ SPIFFE/SPIREèº«ä»½éªŒè¯
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹ï¼š**
- é•œåƒä»“åº“å®‰å…¨æ˜¯å®¹å™¨å®‰å…¨çš„åŸºç¡€ç¯èŠ‚
- å¤šå±‚é˜²æŠ¤æ¯”å•ç‚¹é˜²æŠ¤æ›´åŠ å¯é æœ‰æ•ˆ
- è‡ªåŠ¨åŒ–æ˜¯å¤§è§„æ¨¡ç¯å¢ƒå®‰å…¨ç®¡ç†çš„å¿…ç„¶é€‰æ‹©
- åˆè§„æ€§è¦æ±‚éœ€è¦ä»è®¾è®¡é˜¶æ®µå°±å¼€å§‹è€ƒè™‘
- é«˜å¯ç”¨ä¸ä»…æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œæ›´æ˜¯ç®¡ç†é—®é¢˜