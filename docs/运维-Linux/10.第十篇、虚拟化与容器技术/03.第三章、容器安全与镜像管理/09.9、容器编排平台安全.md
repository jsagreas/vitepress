---
title: 9ã€å®¹å™¨ç¼–æ’å¹³å°å®‰å…¨
---
## ğŸ“š ç›®å½•


1. [å®¹å™¨ç¼–æ’å¹³å°å®‰å…¨æ¦‚è¿°](#1-å®¹å™¨ç¼–æ’å¹³å°å®‰å…¨æ¦‚è¿°)
2. [Kubernetesé›†ç¾¤å®‰å…¨åŠ å›º](#2-kubernetesé›†ç¾¤å®‰å…¨åŠ å›º)
3. [RBACæƒé™ç®¡ç†é…ç½®](#3-rbacæƒé™ç®¡ç†é…ç½®)
4. [Podå®‰å…¨ç­–ç•¥é…ç½®](#4-podå®‰å…¨ç­–ç•¥é…ç½®)
5. [æœåŠ¡è´¦æˆ·å®‰å…¨ç®¡ç†](#5-æœåŠ¡è´¦æˆ·å®‰å…¨ç®¡ç†)
6. [API Serverå®‰å…¨é…ç½®](#6-api-serverå®‰å…¨é…ç½®)
7. [etcdæ•°æ®åŠ å¯†ä¿æŠ¤](#7-etcdæ•°æ®åŠ å¯†ä¿æŠ¤)
8. [é›†ç¾¤ç½‘ç»œå®‰å…¨ç­–ç•¥](#8-é›†ç¾¤ç½‘ç»œå®‰å…¨ç­–ç•¥)
9. [å·¥ä½œè´Ÿè½½å®‰å…¨å‡†å…¥æ§åˆ¶](#9-å·¥ä½œè´Ÿè½½å®‰å…¨å‡†å…¥æ§åˆ¶)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

# ğŸ¯ **å­¦ä¹ è·¯å¾„å¯¼èˆª**


**å‰ç½®çŸ¥è¯†**ï¼šéœ€è¦æŒæ¡KubernetesåŸºç¡€æ¦‚å¿µã€å®¹å™¨å®‰å…¨åŸºç¡€ â†’ **å½“å‰å†…å®¹**ï¼šå®¹å™¨ç¼–æ’å¹³å°å®‰å…¨ â†’ **åç»­å­¦ä¹ **ï¼šå»ºè®®å­¦ä¹ å®¹å™¨è¿è¡Œæ—¶å®‰å…¨ã€æœåŠ¡ç½‘æ ¼å®‰å…¨

â±ï¸ **é¢„è®¡å­¦ä¹ æ—¶é—´**ï¼šæœ¬ç« é¢„è®¡90åˆ†é’Ÿ | å®è·µé…ç½®45åˆ†é’Ÿ

---

## 1. ğŸ›¡ï¸ å®¹å™¨ç¼–æ’å¹³å°å®‰å…¨æ¦‚è¿°



### 1.1 ä»€ä¹ˆæ˜¯å®¹å™¨ç¼–æ’å¹³å°å®‰å…¨



**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
å®¹å™¨ç¼–æ’å¹³å°å®‰å…¨ï¼šä¿æŠ¤Kubernetesç­‰ç¼–æ’å¹³å°å…å—æ”»å‡»çš„ç»¼åˆé˜²æŠ¤ä½“ç³»
ç›®çš„ï¼šç¡®ä¿é›†ç¾¤ã€å·¥ä½œè´Ÿè½½ã€æ•°æ®çš„å®‰å…¨æ€§
èŒƒå›´ï¼šä»é›†ç¾¤åŸºç¡€è®¾æ–½åˆ°åº”ç”¨å±‚çš„å…¨æ ˆå®‰å…¨
```

**ğŸ’¡ é€šä¿—ç†è§£**
æƒ³è±¡Kubernetesé›†ç¾¤æ˜¯ä¸€åº§å¤§å‹å·¥å‚ï¼š
- **ç‰©ç†å®‰å…¨**ï¼šå·¥å‚å›´å¢™ã€é—¨ç¦ç³»ç»Ÿ = é›†ç¾¤ç½‘ç»œéš”ç¦»
- **äººå‘˜ç®¡ç†**ï¼šå‘˜å·¥èº«ä»½éªŒè¯ã€æƒé™åˆ†é… = RBACæƒé™æ§åˆ¶
- **ç”Ÿäº§ç›‘æ§**ï¼šè´¨é‡æ£€æŸ¥ã€å®‰å…¨å·¡æ£€ = å®‰å…¨ç­–ç•¥å’Œç›‘æ§
- **æ•°æ®ä¿æŠ¤**ï¼šé‡è¦æ–‡ä»¶åŠ å¯†å­˜å‚¨ = etcdæ•°æ®ä¿æŠ¤

### 1.2 å®¹å™¨ç¼–æ’å®‰å…¨å¨èƒåˆ†æ



**ğŸ¯ ä¸»è¦å¨èƒç±»å‹**

| **å¨èƒç±»åˆ«** | **å…·ä½“é£é™©** | **å½±å“ç¨‹åº¦** | **é˜²æŠ¤é‡ç‚¹** |
|-------------|-------------|-------------|-------------|
| **é›†ç¾¤åŠ«æŒ** | è·å–é›†ç¾¤ç®¡ç†æƒé™ | â­â­â­â­â­ | API ServeråŠ å›º |
| **æƒé™æå‡** | æ™®é€šç”¨æˆ·è·å¾—ç®¡ç†å‘˜æƒé™ | â­â­â­â­ | RBACç²¾ç»†åŒ–é…ç½® |
| **å®¹å™¨é€ƒé€¸** | çªç ´å®¹å™¨è¾¹ç•Œè®¿é—®ä¸»æœº | â­â­â­â­ | Podå®‰å…¨ç­–ç•¥ |
| **ç½‘ç»œæ”»å‡»** | è·¨Podã€è·¨å‘½åç©ºé—´æ”»å‡» | â­â­â­ | ç½‘ç»œç­–ç•¥éš”ç¦» |
| **æ•°æ®æ³„éœ²** | æ•æ„Ÿé…ç½®ã€å¯†é’¥æš´éœ² | â­â­â­â­â­ | åŠ å¯†å’Œè®¿é—®æ§åˆ¶ |

### 1.3 å®¹å™¨ç¼–æ’å®‰å…¨é˜²æŠ¤å±‚æ¬¡



**ğŸ—ï¸ å¤šå±‚é˜²æŠ¤æ¶æ„**
```
åº”ç”¨å®‰å…¨å±‚
    â†‘
Podå®‰å…¨å±‚ â† å®‰å…¨ç­–ç•¥ã€å‡†å…¥æ§åˆ¶
    â†‘
èŠ‚ç‚¹å®‰å…¨å±‚ â† ä¸»æœºåŠ å›ºã€è¿è¡Œæ—¶é˜²æŠ¤  
    â†‘
ç½‘ç»œå®‰å…¨å±‚ â† ç½‘ç»œç­–ç•¥ã€æµé‡åŠ å¯†
    â†‘
é›†ç¾¤å®‰å…¨å±‚ â† èº«ä»½è®¤è¯ã€æƒé™ç®¡ç†
    â†‘
åŸºç¡€è®¾æ–½å±‚ â† ç‰©ç†å®‰å…¨ã€äº‘å¹³å°å®‰å…¨
```

---

## 2. ğŸ”’ Kubernetesé›†ç¾¤å®‰å…¨åŠ å›º



### 2.1 é›†ç¾¤ç»„ä»¶å®‰å…¨é…ç½®



**ğŸ› ï¸ MasterèŠ‚ç‚¹å®‰å…¨åŠ å›º**

**API Serverå®‰å…¨å‚æ•°**
```bash
# å…³é”®å®‰å…¨å‚æ•°é…ç½®

--anonymous-auth=false              # ç¦ç”¨åŒ¿åè®¿é—®
--basic-auth-file=""               # ç¦ç”¨åŸºæœ¬è®¤è¯
--enable-admission-plugins=NodeRestriction,PodSecurityStandard
--audit-log-path=/var/log/audit.log
--audit-policy-file=/etc/kubernetes/audit-policy.yaml
--tls-cert-file=/etc/kubernetes/pki/apiserver.crt
--tls-private-key-file=/etc/kubernetes/pki/apiserver.key
```

**etcdå®‰å…¨é…ç½®**
```yaml
# etcdé›†ç¾¤å®‰å…¨é…ç½®

client-transport-security:
  cert-file: /etc/kubernetes/pki/etcd/server.crt
  key-file: /etc/kubernetes/pki/etcd/server.key
  trusted-ca-file: /etc/kubernetes/pki/etcd/ca.crt
  auto-tls: false

peer-transport-security:
  cert-file: /etc/kubernetes/pki/etcd/peer.crt  
  key-file: /etc/kubernetes/pki/etcd/peer.key
  trusted-ca-file: /etc/kubernetes/pki/etcd/ca.crt
```

### 2.2 èŠ‚ç‚¹å®‰å…¨åŠ å›º



**ğŸ”§ WorkerèŠ‚ç‚¹å®‰å…¨é…ç½®**

**kubeletå®‰å…¨å‚æ•°**
```bash
# kubeletå…³é”®å®‰å…¨é…ç½®

--anonymous-auth=false
--authorization-mode=Webhook
--read-only-port=0                 # ç¦ç”¨åªè¯»ç«¯å£
--protect-kernel-defaults=true     # ä¿æŠ¤å†…æ ¸å‚æ•°
--make-iptables-util-chains=true   # ç®¡ç†iptablesé“¾
--event-qps=0                      # é™åˆ¶äº‹ä»¶é¢‘ç‡
```

**å®¹å™¨è¿è¡Œæ—¶å®‰å…¨**
```yaml
# containerdå®‰å…¨é…ç½®ç¤ºä¾‹

[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
  SystemdCgroup = true
  
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
  runtime_type = "io.containerd.runc.v2"
  
# é™åˆ¶å®¹å™¨èµ„æº

[plugins."io.containerd.grpc.v1.cri".containerd]
  default_runtime_name = "runc"
```

### 2.3 é›†ç¾¤é€šä¿¡åŠ å¯†



**ğŸ” TLSè¯ä¹¦ç®¡ç†**
```bash
# ç”Ÿæˆé›†ç¾¤è¯ä¹¦

# 1. åˆ›å»ºCAè¯ä¹¦

openssl genrsa -out ca.key 4096
openssl req -new -x509 -key ca.key -sha256 -subj "/C=CN/ST=BJ/O=K8s" -days 3650 -out ca.crt

# 2. ç”ŸæˆAPI Serverè¯ä¹¦  

openssl genrsa -out apiserver.key 4096
openssl req -new -key apiserver.key -out apiserver.csr -config apiserver.conf
openssl x509 -req -in apiserver.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out apiserver.crt -days 365
```

---

## 3. ğŸ‘¥ RBACæƒé™ç®¡ç†é…ç½®



### 3.1 RBACåŸºç¡€æ¦‚å¿µ



**ğŸ”‘ æƒé™ç®¡ç†ä¸‰è¦ç´ **
- **Subjectä¸»ä½“**ï¼šç”¨æˆ·(User)ã€ç»„(Group)ã€æœåŠ¡è´¦æˆ·(ServiceAccount)
- **Resourceèµ„æº**ï¼šPodã€Serviceã€ConfigMapç­‰Kuberneteså¯¹è±¡
- **VerbåŠ¨ä½œ**ï¼šgetã€listã€createã€updateã€deleteç­‰æ“ä½œ

**æƒé™ç»‘å®šæµç¨‹**
```
User/ServiceAccount â†’ RoleBinding â†’ Role â†’ Resources
                          â†“
                    ClusterRoleBinding â†’ ClusterRole â†’ Cluster Resources
```

### 3.2 è§’è‰²å®šä¹‰ä¸é…ç½®



**ğŸ¯ è§’è‰²æƒé™åˆ†çº§è®¾è®¡**

**å¼€å‘äººå‘˜è§’è‰²**
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: development
  name: developer
rules:
- apiGroups: [""]
  resources: ["pods", "pods/log", "pods/exec"]
  verbs: ["get", "list", "create", "delete"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets"]  
  verbs: ["get", "list", "create", "update", "delete"]
- apiGroups: [""]
  resources: ["configmaps", "secrets"]
  verbs: ["get", "list"]  # åªè¯»æƒé™
```

**è¿ç»´äººå‘˜è§’è‰²**
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: operator
rules:
- apiGroups: [""]
  resources: ["nodes", "persistentvolumes"]
  verbs: ["get", "list", "patch"]
- apiGroups: ["apps"]
  resources: ["deployments", "daemonsets"]
  verbs: ["*"]  # å®Œå…¨æƒé™
- apiGroups: ["extensions", "networking.k8s.io"]
  resources: ["networkpolicies"]
  verbs: ["get", "list", "create", "update", "delete"]
```

### 3.3 æƒé™ç»‘å®šé…ç½®



**ğŸ‘¤ ç”¨æˆ·æƒé™ç»‘å®š**
```yaml
# ç»‘å®šå¼€å‘äººå‘˜è§’è‰²

apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: developer-binding
  namespace: development
subjects:
- kind: User
  name: john@company.com
  apiGroup: rbac.authorization.k8s.io
- kind: Group
  name: dev-team
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: developer
  apiGroup: rbac.authorization.k8s.io
```

### 3.4 æœ€å°æƒé™åŸåˆ™å®æ–½



**ğŸ”’ æƒé™æœ€å°åŒ–ç­–ç•¥**

| **è§’è‰²ç±»å‹** | **æƒé™èŒƒå›´** | **èµ„æºé™åˆ¶** | **æ“ä½œé™åˆ¶** |
|-------------|-------------|-------------|-------------|
| **åªè¯»ç”¨æˆ·** | ç‰¹å®šå‘½åç©ºé—´ | åŸºç¡€èµ„æºæŸ¥çœ‹ | getã€list |
| **å¼€å‘äººå‘˜** | å¼€å‘å‘½åç©ºé—´ | åº”ç”¨èµ„æºç®¡ç† | CRUD(é™¤é›†ç¾¤çº§) |
| **è¿ç»´äººå‘˜** | ç”Ÿäº§å‘½åç©ºé—´ | åŸºç¡€è®¾æ–½ç®¡ç† | å®Œæ•´æƒé™ |
| **ç®¡ç†å‘˜** | å…¨é›†ç¾¤ | æ‰€æœ‰èµ„æº | å®Œæ•´æƒé™ |

---

## 4. ğŸ›¡ï¸ Podå®‰å…¨ç­–ç•¥é…ç½®



### 4.1 Podå®‰å…¨æ ‡å‡†



**ğŸ¯ Podå®‰å…¨çº§åˆ«åˆ†ç±»**
- **Privilegedç‰¹æƒçº§**ï¼šä¸é™åˆ¶ï¼Œå…è®¸æ‰€æœ‰æ“ä½œ
- **BaselineåŸºå‡†çº§**ï¼šæœ€å°é™åˆ¶ï¼Œé˜²æ­¢å·²çŸ¥æƒé™æå‡  
- **Restrictedé™åˆ¶çº§**ï¼šä¸¥æ ¼é™åˆ¶ï¼Œéµå¾ªPodå®‰å…¨æœ€ä½³å®è·µ

### 4.2 Podå®‰å…¨ç­–ç•¥é…ç½®



**ğŸ”’ é™åˆ¶æ€§å®‰å…¨ç­–ç•¥**
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: secure-namespace
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
```

**å®‰å…¨å®¹å™¨é…ç½®ç¤ºä¾‹**
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secure-pod
spec:
  securityContext:
    runAsNonRoot: true      # ç¦æ­¢rootç”¨æˆ·è¿è¡Œ
    runAsUser: 1000         # æŒ‡å®šç”¨æˆ·ID
    runAsGroup: 1000        # æŒ‡å®šç»„ID
    fsGroup: 1000           # æ–‡ä»¶ç³»ç»Ÿç»„
  containers:
  - name: app
    image: nginx:1.20
    securityContext:
      allowPrivilegeEscalation: false  # ç¦æ­¢æƒé™æå‡
      readOnlyRootFilesystem: true     # åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
      capabilities:
        drop:
        - ALL                          # ç§»é™¤æ‰€æœ‰Linuxèƒ½åŠ›
      runAsNonRoot: true
```

### 4.3 èµ„æºé™åˆ¶ä¸é…é¢



**ğŸ“Š èµ„æºå®‰å…¨é…é¢**
```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: security-quota
  namespace: production
spec:
  hard:
    requests.cpu: "4"
    requests.memory: 8Gi
    limits.cpu: "8"  
    limits.memory: 16Gi
    pods: "10"
    persistentvolumeclaims: "4"
```

**å®¹å™¨èµ„æºé™åˆ¶**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: secure-app
spec:
  template:
    spec:
      containers:
      - name: app
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m       # é˜²æ­¢CPUè¿‡åº¦æ¶ˆè€—
            memory: 512Mi   # é˜²æ­¢å†…å­˜æ³„éœ²æ”»å‡»
```

---

## 5. ğŸ”‘ æœåŠ¡è´¦æˆ·å®‰å…¨ç®¡ç†



### 5.1 æœåŠ¡è´¦æˆ·æƒé™åŸåˆ™



**ğŸ¯ æœåŠ¡è´¦æˆ·å®‰å…¨é…ç½®**
```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: app-service-account
  namespace: production
automountServiceAccountToken: false  # é»˜è®¤ä¸æŒ‚è½½token
```

**é™åˆ¶æœåŠ¡è´¦æˆ·æƒé™**
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: app-role
  namespace: production
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get"]
  resourceNames: ["app-config"]  # é™åˆ¶ç‰¹å®šèµ„æº
```

### 5.2 Tokenå®‰å…¨ç®¡ç†



**ğŸ” Tokenç”Ÿå‘½å‘¨æœŸç®¡ç†**
```yaml
# æœ‰é™æœŸé™çš„Token

apiVersion: v1
kind: Secret
metadata:
  name: app-token
  namespace: production
  annotations:
    kubernetes.io/service-account.name: app-service-account
type: kubernetes.io/service-account-token
data:
  token: <base64-encoded-token>
```

**Tokenè½®æ¢ç­–ç•¥**
```bash
# å®šæœŸè½®æ¢æœåŠ¡è´¦æˆ·Token

kubectl create token app-service-account \
  --duration=1h \
  --namespace=production
```

---

## 6. ğŸŒ API Serverå®‰å…¨é…ç½®



### 6.1 è®¿é—®æ§åˆ¶é…ç½®



**ğŸšª å¤šé‡èº«ä»½éªŒè¯**
```yaml
# API Serverè®¤è¯é…ç½®

authentication:
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt
  serviceAccount:
    keyFiles:
    - /etc/kubernetes/pki/sa.pub
  oidc:
    issuerURL: https://accounts.google.com
    clientID: kubernetes
    usernameClaim: email
    groupsClaim: groups
```

### 6.2 å‡†å…¥æ§åˆ¶å™¨é…ç½®



**ğŸ›¡ï¸ å…³é”®å‡†å…¥æ§åˆ¶å™¨**
```bash
# æ¨èçš„å‡†å…¥æ§åˆ¶å™¨ç»„åˆ

--enable-admission-plugins=\
NamespaceLifecycle,\
LimitRanger,\
ServiceAccount,\
DefaultStorageClass,\
ResourceQuota,\
NodeRestriction,\
PodSecurityStandard,\
AlwaysPullImages
```

### 6.3 APIå®¡è®¡é…ç½®



**ğŸ“ å®¡è®¡ç­–ç•¥é…ç½®**
```yaml
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
- level: Metadata
  resources:
  - group: ""
    resources: ["secrets", "configmaps"]
- level: RequestResponse  
  resources:
  - group: "rbac.authorization.k8s.io"
    resources: ["roles", "rolebindings"]
```

---

## 7. ğŸ”’ etcdæ•°æ®åŠ å¯†ä¿æŠ¤



### 7.1 é™æ€æ•°æ®åŠ å¯†



**ğŸ” etcdåŠ å¯†é…ç½®**
```yaml
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
- resources:
  - secrets
  - configmaps
  providers:
  - aescbc:
      keys:
      - name: key1
        secret: <32å­—èŠ‚base64ç¼–ç å¯†é’¥>
  - identity: {}  # æ˜æ–‡å­˜å‚¨ï¼ˆå‘åå…¼å®¹ï¼‰
```

**å¯ç”¨åŠ å¯†é…ç½®**
```bash
# API Serverå¯åŠ¨å‚æ•°

--encryption-provider-config=/etc/kubernetes/encryption-config.yaml
```

### 7.2 etcdå¤‡ä»½å®‰å…¨



**ğŸ’¾ å®‰å…¨å¤‡ä»½ç­–ç•¥**
```bash
# åŠ å¯†å¤‡ä»½etcdæ•°æ®

ETCDCTL_API=3 etcdctl snapshot save backup.db \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key

# åŠ å¯†å¤‡ä»½æ–‡ä»¶

gpg --cipher-algo AES256 --compress-algo 1 --s2k-mode 3 \
    --s2k-digest-algo SHA512 --s2k-count 65536 --symmetric backup.db
```

---

## 8. ğŸŒ é›†ç¾¤ç½‘ç»œå®‰å…¨ç­–ç•¥



### 8.1 ç½‘ç»œéš”ç¦»ç­–ç•¥



**ğŸš§ å‘½åç©ºé—´éš”ç¦»**
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
  namespace: production
spec:
  podSelector: {}  # åº”ç”¨åˆ°æ‰€æœ‰Pod
  policyTypes:
  - Ingress
  - Egress
#  # é»˜è®¤æ‹’ç»æ‰€æœ‰æµé‡
```

**é€‰æ‹©æ€§å…è®¸é€šä¿¡**
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend-to-backend
  namespace: production
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 8080
```

### 8.2 é›†ç¾¤é—´é€šä¿¡åŠ å¯†



**ğŸ” æœåŠ¡ç½‘æ ¼å®‰å…¨**
```yaml
# Istioå®‰å…¨ç­–ç•¥ç¤ºä¾‹

apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: strict-mtls
  namespace: production
spec:
  mtls:
    mode: STRICT  # å¼ºåˆ¶mTLS
```

---

## 9. ğŸš¦ å·¥ä½œè´Ÿè½½å®‰å…¨å‡†å…¥æ§åˆ¶



### 9.1 OPA Gatekeeperé…ç½®



**âš–ï¸ ç­–ç•¥å¼•æ“é…ç½®**
```yaml
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8srequiredsecuritycontext
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredSecurityContext
      validation:
        properties:
          runAsNonRoot:
            type: boolean
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredsecuritycontext
        
        violation[{"msg": msg}] {
          input.review.object.spec.securityContext.runAsNonRoot != true
          msg := "å®¹å™¨å¿…é¡»ä»¥érootç”¨æˆ·è¿è¡Œ"
        }
```

### 9.2 å®‰å…¨æ‰«æé›†æˆ



**ğŸ” é•œåƒæ‰«æå‡†å…¥**
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: security-admission-config
data:
  config.yaml: |
    imageScanning:
      enabled: true
      severity: HIGH
      action: reject
    vulnerabilityThreshold:
      critical: 0
      high: 3
      medium: 10
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ å®¹å™¨ç¼–æ’å®‰å…¨ï¼šå¤šå±‚æ¬¡é˜²æŠ¤ä½“ç³»ï¼Œä»åŸºç¡€è®¾æ–½åˆ°åº”ç”¨å…¨è¦†ç›–
ğŸ”¸ RBACæƒé™ç®¡ç†ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œå®ç°æœ€å°æƒé™åŸåˆ™
ğŸ”¸ Podå®‰å…¨ç­–ç•¥ï¼šé™åˆ¶å®¹å™¨æƒé™ï¼Œé˜²æ­¢ç‰¹æƒæå‡å’Œç³»ç»Ÿé€ƒé€¸
ğŸ”¸ æœåŠ¡è´¦æˆ·ç®¡ç†ï¼šæ§åˆ¶åº”ç”¨é—´é€šä¿¡æƒé™ï¼Œå®šæœŸè½®æ¢è®¿é—®å‡­æ®
ğŸ”¸ API ServeråŠ å›ºï¼šå¤šé‡è®¤è¯ã€å‡†å…¥æ§åˆ¶ã€å®¡è®¡æ—¥å¿—
ğŸ”¸ æ•°æ®åŠ å¯†ä¿æŠ¤ï¼šé™æ€æ•°æ®åŠ å¯†ã€ä¼ è¾“è¿‡ç¨‹åŠ å¯†ã€å¤‡ä»½åŠ å¯†
ğŸ”¸ ç½‘ç»œå®‰å…¨éš”ç¦»ï¼šç½‘ç»œç­–ç•¥æ§åˆ¶æµé‡ï¼ŒæœåŠ¡ç½‘æ ¼æä¾›é›¶ä¿¡ä»»
ğŸ”¸ å‡†å…¥æ§åˆ¶ç­–ç•¥ï¼šè‡ªåŠ¨åŒ–å®‰å…¨æ£€æŸ¥ï¼Œé˜»æ­¢ä¸å®‰å…¨å·¥ä½œè´Ÿè½½
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦å¤šå±‚é˜²æŠ¤**
```
å•ä¸€é˜²æŠ¤çš„é—®é¢˜ï¼š
- ä¸€æ—¦è¢«çªç ´å°±å…¨ç›˜å¤±å®ˆ
- æ— æ³•åº”å¯¹ä¸åŒç±»å‹çš„å¨èƒ
- ç¼ºä¹æ·±åº¦é˜²å¾¡èƒ½åŠ›

å¤šå±‚é˜²æŠ¤çš„ä»·å€¼ï¼š
- å³ä½¿æŸå±‚è¢«çªç ´ï¼Œå…¶ä»–å±‚ä»èƒ½é˜²æŠ¤
- ä¸åŒå±‚æ¬¡åº”å¯¹ä¸åŒå¨èƒ
- æä¾›æ”»å‡»æ£€æµ‹å’Œå“åº”æ—¶é—´
```

**ğŸ”¹ æƒé™ç®¡ç†çš„æ ¸å¿ƒåŸåˆ™**
```
æœ€å°æƒé™åŸåˆ™ï¼š
- åªç»™å¿…éœ€çš„æœ€å°æƒé™
- å®šæœŸå®¡æŸ¥å’Œå›æ”¶æƒé™
- åŸºäºä¸šåŠ¡éœ€è¦åŠ¨æ€è°ƒæ•´

èŒè´£åˆ†ç¦»åŸåˆ™ï¼š
- å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒéš”ç¦»
- ä¸åŒè§’è‰²æƒé™æ˜ç¡®åˆ’åˆ†
- å…³é”®æ“ä½œéœ€è¦å¤šäººå®¡æ‰¹
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼



**ğŸ¯ ä¼ä¸šåº”ç”¨åœºæ™¯**
- **é‡‘èè¡Œä¸š**ï¼šä¸¥æ ¼çš„æ•°æ®ä¿æŠ¤å’Œè®¿é—®æ§åˆ¶
- **åŒ»ç–—è¡Œä¸š**ï¼šæ‚£è€…æ•°æ®éšç§å’Œåˆè§„æ€§è¦æ±‚
- **ç”µå•†å¹³å°**ï¼šå¤§è§„æ¨¡é›†ç¾¤çš„å®‰å…¨è¿è¥ç®¡ç†
- **æ”¿åºœæœºæ„**ï¼šå…³é”®ä¿¡æ¯åŸºç¡€è®¾æ–½ä¿æŠ¤

**ğŸ› ï¸ å®‰å…¨è¿è¥å»ºè®®**
```
å®‰å…¨ç­–ç•¥åˆ¶å®šï¼š
- åŸºäºä¸šåŠ¡é£é™©è¯„ä¼°åˆ¶å®šå®‰å…¨ç­–ç•¥
- å®šæœŸæ›´æ–°å®‰å…¨åŸºçº¿å’Œé…ç½®
- å»ºç«‹å®‰å…¨äº‹ä»¶å“åº”æµç¨‹

ç›‘æ§å’Œå®¡è®¡ï¼š
- å®æ—¶ç›‘æ§é›†ç¾¤å®‰å…¨çŠ¶æ€
- å®šæœŸè¿›è¡Œå®‰å…¨åˆè§„æ£€æŸ¥
- ä¿å­˜å®Œæ•´çš„å®¡è®¡æ—¥å¿—

æŒç»­æ”¹è¿›ï¼š
- è·Ÿè¸ªæœ€æ–°å®‰å…¨å¨èƒå’Œé˜²æŠ¤æŠ€æœ¯
- å®šæœŸè¿›è¡Œæ¸—é€æµ‹è¯•å’Œå®‰å…¨æ¼”ç»ƒ
- åŸ¹è®­å›¢é˜Ÿå®‰å…¨æ„è¯†å’ŒæŠ€èƒ½
```

### 10.4 å­¦ä¹ æ£€æŸ¥æ¸…å•



**ğŸ¯ æ ¸å¿ƒæŠ€èƒ½æ£€æŸ¥**
- [ ] èƒ½å¤Ÿé…ç½®Kubernetes RBACæƒé™ä½“ç³»
- [ ] ç†è§£Podå®‰å…¨ç­–ç•¥çš„é…ç½®åŸç†
- [ ] æŒæ¡API Serverå®‰å…¨åŠ å›ºæ–¹æ³•
- [ ] ä¼šé…ç½®ç½‘ç»œå®‰å…¨ç­–ç•¥
- [ ] äº†è§£etcdæ•°æ®åŠ å¯†ä¿æŠ¤
- [ ] èƒ½å¤Ÿå®æ–½å·¥ä½œè´Ÿè½½å‡†å…¥æ§åˆ¶
- [ ] æŒæ¡å®¹å™¨é•œåƒå®‰å…¨æ‰«æ
- [ ] ç†è§£æœåŠ¡ç½‘æ ¼å®‰å…¨æœºåˆ¶

**ğŸ’¡ å®‰å…¨é˜²æŠ¤é‡ç‚¹**
- **èº«ä»½è®¤è¯**ï¼šç¡®ä¿è®¿é—®è€…èº«ä»½å¯ä¿¡
- **æƒé™æ§åˆ¶**ï¼šé™åˆ¶è®¿é—®èŒƒå›´å’Œæ“ä½œæƒé™
- **æ•°æ®ä¿æŠ¤**ï¼šåŠ å¯†å­˜å‚¨å’Œä¼ è¾“ä¸­çš„æ•æ„Ÿæ•°æ®
- **ç½‘ç»œéš”ç¦»**ï¼šæ§åˆ¶æœåŠ¡é—´é€šä¿¡æµé‡
- **æŒç»­ç›‘æ§**ï¼šå®æ—¶æ£€æµ‹å’Œå“åº”å®‰å…¨å¨èƒ

**ğŸ”‘ æ ¸å¿ƒè®°å¿†å£è¯€**
> ç¼–æ’å®‰å…¨å¤šå±‚é˜²ï¼Œèº«ä»½æƒé™è¦ç®¡ä¸¥
> å®¹å™¨ç­–ç•¥æ§ç‰¹æƒï¼Œç½‘ç»œéš”ç¦»ç­‘å±éšœ
> æ•°æ®åŠ å¯†æŠ¤æœºå¯†ï¼Œç›‘æ§å®¡è®¡ä¸é—´æ–­

**ğŸ“š å»¶ä¼¸å­¦ä¹ å»ºè®®**
- æ·±å…¥å­¦ä¹ é›¶ä¿¡ä»»å®‰å…¨æ¶æ„
- äº†è§£äº‘åŸç”Ÿå®‰å…¨å·¥å…·é“¾(Falcoã€Twistlockç­‰)
- ç ”ç©¶æœåŠ¡ç½‘æ ¼å®‰å…¨å®ç°(Istioã€Linkerd)
- å­¦ä¹ å®¹å™¨è¿è¡Œæ—¶å®‰å…¨é˜²æŠ¤æŠ€æœ¯