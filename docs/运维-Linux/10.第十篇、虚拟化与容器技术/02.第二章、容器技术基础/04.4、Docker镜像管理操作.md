---
title: 4、Docker镜像管理操作
---
## 📚 目录

1. [Docker镜像基础概念](#1-docker镜像基础概念)
2. [镜像分层存储机制](#2-镜像分层存储机制)
3. [镜像拉取与下载](#3-镜像拉取与下载)
4. [本地镜像查看管理](#4-本地镜像查看管理)
5. [镜像删除与清理](#5-镜像删除与清理)
6. [镜像标签管理](#6-镜像标签管理)
7. [镜像仓库Registry详解](#7-镜像仓库registry详解)
8. [镜像搜索与版本选择策略](#8-镜像搜索与版本选择策略)
9. [镜像存储空间管理](#9-镜像存储空间管理)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🐳 Docker镜像基础概念


### 1.1 什么是Docker镜像


**🔸 镜像的本质理解**
```
简单理解：Docker镜像就像是"应用程序的安装包"
- 包含了运行应用所需的一切：代码、库、依赖、配置
- 是一个只读的模板，用来创建容器
- 类比：镜像像光盘，容器像从光盘安装的软件
```

**💡 镜像与虚拟机的区别**
```
传统虚拟机镜像：
┌─────────────────────┐
│   应用程序          │
├─────────────────────┤
│   完整操作系统       │  ← 包含整个OS，体积庞大
├─────────────────────┤
│   虚拟化层          │
└─────────────────────┘

Docker镜像：
┌─────────────────────┐
│   应用程序          │
├─────────────────────┤  ← 只包含应用和必要组件
│   必要库和依赖       │     体积小，启动快
└─────────────────────┘
```

### 1.2 镜像的核心特点


**🌟 关键特性**
- **只读性**：镜像创建后不能修改，保证一致性
- **可移植性**：在任何支持Docker的环境中运行
- **版本化**：通过标签管理不同版本
- **共享性**：可以上传到仓库供他人使用

**📦 镜像命名规则**
```
完整镜像名称格式：
[仓库地址/]命名空间/镜像名[:标签]

示例解析：
docker.io/library/nginx:1.20
│       │  │      │     │
│       │  │      │     └─ 版本标签
│       │  │      └─ 镜像名
│       │  └─ 命名空间(官方镜像用library)
│       └─ 仓库地址
└─ 默认Docker Hub

常见简写：
nginx = docker.io/library/nginx:latest
```

---

## 2. 🏗️ 镜像分层存储机制


### 2.1 分层存储的核心概念


**🔸 什么是分层存储**
```
传统存储方式：整个应用打包成一个文件
Docker分层方式：将镜像分成多个层次

镜像层次结构示例：
┌─────────────────┐ ← 应用层 (可写)
├─────────────────┤ ← Nginx配置层
├─────────────────┤ ← Nginx程序层  
├─────────────────┤ ← 系统工具层
├─────────────────┤ ← 基础库层
└─────────────────┘ ← 基础系统层 (只读)
```

### 2.2 分层存储的优势


**⚡ 核心优势解析**

**存储空间节省**
```
场景：有3个应用都基于Ubuntu镜像

传统方式：
App1镜像 = Ubuntu + App1  (500MB)
App2镜像 = Ubuntu + App2  (500MB)  
App3镜像 = Ubuntu + App3  (500MB)
总计：1500MB

Docker分层方式：
Ubuntu基础层：200MB (共享)
App1层：100MB
App2层：100MB  
App3层：100MB
总计：500MB (节省66%空间)
```

**传输效率提升**
- **增量传输**：只下载变化的层
- **并行下载**：多层可以并行传输
- **缓存利用**：相同层只下载一次

### 2.3 分层存储的工作原理


**🔧 Union FS联合文件系统**
```
底层技术：Union FS (联合文件系统)
工作原理：将多个只读层联合挂载成一个文件系统

实际存储位置：
/var/lib/docker/overlay2/  ← Docker数据目录
├── layer1/               ← 各层数据
├── layer2/
├── layer3/
└── merged/              ← 合并后的视图
```

---

## 3. 📥 镜像拉取与下载


### 3.1 docker pull命令详解


**🔸 基本拉取操作**

```bash
# 基本语法
docker pull [OPTIONS] NAME[:TAG]

# 最常用形式
docker pull nginx                    # 默认拉取latest标签
docker pull nginx:1.20              # 拉取指定版本
docker pull ubuntu:20.04            # 拉取Ubuntu 20.04
```

**📊 拉取过程解析**
```
执行：docker pull nginx:1.20

输出解析：
1.20: Pulling from library/nginx
a2abf6c4d29d: Pull complete         ← 第1层下载完成
a9edb18cadd1: Pull complete         ← 第2层下载完成  
589b7251471a: Pull complete         ← 第3层下载完成
186b1aaa4aa6: Pull complete         ← 第4层下载完成
b4df32aa5a72: Pull complete         ← 第5层下载完成
a0bcbecc962e: Pull complete         ← 第6层下载完成
Digest: sha256:0d17b565c37bcbd...     ← 镜像指纹
Status: Downloaded newer image...    ← 下载状态
docker.io/library/nginx:1.20        ← 完整镜像名
```

### 3.2 拉取选项与技巧


**🎯 常用拉取选项**

| 选项 | 作用 | 示例 |
|------|------|------|
| `--all-tags` | 拉取所有标签 | `docker pull --all-tags nginx` |
| `--platform` | 指定平台架构 | `docker pull --platform linux/amd64 nginx` |
| `--quiet` | 静默模式 | `docker pull --quiet nginx` |

**💡 拉取最佳实践**
- **指定具体版本**：避免使用`latest`标签
- **验证镜像来源**：确认镜像的官方性和安全性
- **网络优化**：使用镜像加速器提高下载速度

---

## 4. 👀 本地镜像查看管理


### 4.1 docker images命令详解


**🔸 基本查看操作**

```bash
# 查看所有本地镜像
docker images

# 常见输出格式：
REPOSITORY    TAG       IMAGE ID       CREATED        SIZE
nginx         1.20      d1a364dc548d   2 weeks ago    133MB
nginx         latest    605c77e624dd   3 weeks ago    141MB
ubuntu        20.04     ba6acccedd29   4 weeks ago    72.8MB
```

**📋 输出字段解释**
- **REPOSITORY**：镜像仓库名称
- **TAG**：镜像标签（版本）
- **IMAGE ID**：镜像唯一标识符（前12位）
- **CREATED**：镜像创建时间
- **SIZE**：镜像大小

### 4.2 镜像查看的高级用法


**🔧 筛选和格式化**

```bash
# 查看特定镜像
docker images nginx                  # 查看nginx相关镜像
docker images nginx:1.20            # 查看特定版本

# 使用过滤器
docker images --filter "dangling=true"     # 查看悬空镜像
docker images --filter "before=nginx:1.20" # 查看指定镜像之前的镜像

# 自定义输出格式
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
```

**📊 常用查看组合**

| 需求 | 命令 | 说明 |
|------|------|------|
| 查看镜像大小 | `docker images --format "{{.Repository}}:{{.Tag}} {{.Size}}"` | 只显示名称和大小 |
| 查看镜像ID | `docker images -q` | 只显示IMAGE ID |
| 查看悬空镜像 | `docker images -f dangling=true` | 显示无标签镜像 |

---

## 5. 🗑️ 镜像删除与清理


### 5.1 docker rmi命令详解


**🔸 基本删除操作**

```bash
# 删除单个镜像
docker rmi nginx:1.20               # 通过名称和标签删除
docker rmi d1a364dc548d             # 通过IMAGE ID删除

# 删除多个镜像
docker rmi nginx:1.20 ubuntu:20.04  # 删除多个指定镜像
docker rmi $(docker images -q)      # 删除所有镜像(危险操作)
```

**⚠️ 删除注意事项**
```
删除限制条件：
1. 不能删除正在运行容器使用的镜像
2. 有多个标签的镜像，只会删除指定标签
3. 有依赖关系的镜像需要先删除子镜像

错误示例：
Error: cannot delete image xxx: image is being used by running container yyy
解决：先停止并删除容器，再删除镜像
```

### 5.2 强制删除与批量清理


**💪 强制删除选项**

```bash
# 强制删除(跳过检查)
docker rmi -f nginx:1.20            # 强制删除单个镜像
docker rmi -f $(docker images -q)   # 强制删除所有镜像
```

**🧹 智能清理命令**
```bash
# 清理悬空镜像(最安全)
docker image prune                  # 删除悬空镜像
docker image prune -a               # 删除所有未使用镜像
docker image prune -f               # 强制清理，不询问确认

# 系统级清理
docker system prune                 # 清理所有未使用资源
docker system prune -a              # 更彻底的清理
```

---

## 6. 🏷️ 镜像标签管理


### 6.1 docker tag命令详解


**🔸 标签的作用与意义**
```
标签的本质：给同一个镜像起不同的"别名"
实际情况：多个标签指向同一个镜像文件

示例理解：
nginx:1.20    ─┐
               ├─ 指向同一个镜像文件
nginx:stable  ─┘
```

**🎯 标签操作基础**

```bash
# 给镜像打标签
docker tag nginx:1.20 nginx:stable          # 创建新标签
docker tag nginx:1.20 myregistry/nginx:v1   # 为推送到私有仓库准备

# 查看标签效果
docker images nginx
# 输出：
REPOSITORY   TAG      IMAGE ID      CREATED      SIZE
nginx        1.20     d1a364dc548d  2 weeks ago  133MB
nginx        stable   d1a364dc548d  2 weeks ago  133MB  ← 相同IMAGE ID
```

### 6.2 标签管理策略


**📋 标签命名最佳实践**

| 标签类型 | 格式示例 | 用途说明 |
|----------|----------|----------|
| **版本标签** | `v1.0.0`, `1.20.1` | 明确版本号 |
| **环境标签** | `dev`, `staging`, `prod` | 区分部署环境 |
| **功能标签** | `alpine`, `slim` | 标识特殊功能 |
| **时间标签** | `2024-01-17` | 按构建时间标识 |

**💡 标签管理技巧**
- **避免latest**：生产环境不要使用latest标签
- **语义化版本**：遵循版本号规范(major.minor.patch)
- **环境隔离**：不同环境使用不同标签
- **及时清理**：定期清理不需要的标签

---

## 7. 🏪 镜像仓库Registry详解


### 7.1 Registry仓库概念


**🔸 什么是Registry**
```
Registry = 镜像的"应用商店"
作用：存储、管理、分发Docker镜像

仓库层级结构：
Registry (仓库服务)
├── Namespace (命名空间)
│   ├── Repository (镜像仓库)
│   │   ├── Tag1 (标签1)
│   │   ├── Tag2 (标签2)
│   │   └── TagN (标签N)
│   └── ...
└── ...

示例：
docker.io/library/nginx:1.20
│        │       │       │
Registry Namespace Repo  Tag
```

### 7.2 主要Registry服务商


**🌐 公共Registry对比**

| Registry | 特点 | 访问地址 | 适用场景 |
|----------|------|----------|----------|
| **Docker Hub** | 官方仓库，镜像最全 | `docker.io` | 个人学习，小项目 |
| **阿里云** | 国内访问快 | `registry.cn-hangzhou.aliyuncs.com` | 国内用户 |
| **腾讯云** | 国内访问稳定 | `ccr.ccs.tencentyun.com` | 企业用户 |
| **华为云** | 功能丰富 | `swr.cn-north-1.myhuaweicloud.com` | 企业级应用 |

**🔧 配置Registry镜像源**
```bash
# 配置Docker Hub镜像加速
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://registry.docker-cn.com",
    "https://docker.mirrors.ustc.edu.cn"
  ]
}
EOF

# 重启Docker服务
sudo systemctl daemon-reload
sudo systemctl restart docker
```

---

## 8. 🔍 镜像搜索与版本选择策略


### 8.1 docker search命令详解


**🔸 基本搜索操作**

```bash
# 搜索镜像
docker search nginx

# 典型输出：
NAME                     DESCRIPTION                   STARS    OFFICIAL   AUTOMATED
nginx                    Official build of Nginx.      15000    [OK]       
jwilder/nginx-proxy      Automated reverse proxy...     2100                [OK]
richarvey/nginx-php-fpm  Container running Nginx...     800                 [OK]
```

**📊 搜索结果字段解释**
- **NAME**：镜像名称
- **DESCRIPTION**：镜像描述
- **STARS**：用户点赞数（受欢迎程度）
- **OFFICIAL**：是否官方镜像
- **AUTOMATED**：是否自动构建

### 8.2 版本选择策略


**🎯 选择标准**

```
优先级排序：
1. 官方镜像 > 第三方镜像
2. 高STARS数 > 低STARS数  
3. 明确版本号 > latest标签
4. 活跃维护 > 长期未更新

安全考虑：
✅ 优先选择官方OFFICIAL标记的镜像
✅ 查看镜像的更新频率和维护状态  
✅ 阅读镜像的文档和使用说明
❌ 避免来源不明的第三方镜像
```

**📋 版本标签含义**

| 标签类型 | 示例 | 含义说明 |
|----------|------|----------|
| **数字版本** | `nginx:1.20.2` | 精确版本号，推荐生产使用 |
| **主版本** | `nginx:1.20` | 主版本，会自动更新补丁版本 |
| **别名标签** | `nginx:stable` | 稳定版本别名 |
| **特殊构建** | `nginx:alpine` | 基于Alpine Linux的轻量版本 |
| **latest** | `nginx:latest` | 最新版本，不推荐生产使用 |

---

## 9. 💾 镜像存储空间管理


### 9.1 镜像存储空间分析


**🔸 查看存储空间使用情况**

```bash
# 查看Docker空间使用总览
docker system df

# 典型输出：
TYPE            TOTAL    ACTIVE   SIZE      RECLAIMABLE
Images          10       5        2.1GB     1.2GB (57%)
Containers      8        3        1.5MB     1.2MB (80%)  
Local Volumes   3        1        0.5GB     0.3GB (60%)
Build Cache     15       0        1.8GB     1.8GB (100%)

# 详细信息
docker system df -v
```

**📊 存储空间类型解析**
- **Images**：镜像占用空间
- **Containers**：容器层占用空间  
- **Local Volumes**：数据卷占用空间
- **Build Cache**：构建缓存占用空间

### 9.2 空间清理策略


**🧹 清理策略对比**

| 清理级别 | 命令 | 清理内容 | 安全性 |
|----------|------|----------|--------|
| **保守清理** | `docker image prune` | 仅悬空镜像 | ⭐⭐⭐ 很安全 |
| **标准清理** | `docker image prune -a` | 未使用镜像 | ⭐⭐ 较安全 |
| **全面清理** | `docker system prune -a` | 所有未使用资源 | ⭐ 需谨慎 |

**💡 清理最佳实践**
```bash
# 定期维护脚本
#!/bin/bash
echo "开始清理Docker存储空间..."

# 1. 清理悬空镜像
docker image prune -f

# 2. 清理停止的容器
docker container prune -f

# 3. 清理未使用的网络
docker network prune -f

# 4. 清理构建缓存
docker builder prune -f

echo "清理完成！"
docker system df  # 显示清理后的空间使用情况
```

### 9.3 镜像大小优化


**📏 镜像大小对比**

```
常见基础镜像大小对比：
ubuntu:20.04        ≈ 72MB
debian:bullseye     ≈ 124MB  
centos:8           ≈ 231MB
alpine:latest      ≈ 5MB    ← 最小化镜像

应用镜像大小示例：
nginx:alpine       ≈ 23MB
nginx:latest       ≈ 133MB
node:alpine        ≈ 110MB
node:latest        ≈ 993MB
```

**⚡ 镜像选择建议**
- **生产环境**：优先选择alpine版本（体积小、安全）
- **开发环境**：可以选择完整版本（调试工具齐全）
- **特殊需求**：根据应用依赖选择合适的基础镜像

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 镜像本质：只读的应用程序模板，包含运行所需的一切
🔸 分层存储：通过Union FS技术实现空间共享和增量传输
🔸 镜像命名：[registry/]namespace/repository[:tag] 的完整格式
🔸 标签管理：同一镜像可以有多个标签，指向相同的IMAGE ID
🔸 Registry：镜像的存储和分发中心，类似应用商店
```

### 10.2 关键命令速查


**📝 常用命令总结**

| 功能 | 命令 | 说明 |
|------|------|------|
| **拉取镜像** | `docker pull nginx:1.20` | 从仓库下载镜像 |
| **查看镜像** | `docker images` | 显示本地所有镜像 |
| **删除镜像** | `docker rmi nginx:1.20` | 删除指定镜像 |
| **打标签** | `docker tag nginx:1.20 nginx:stable` | 给镜像添加标签 |
| **搜索镜像** | `docker search nginx` | 在仓库中搜索镜像 |
| **清理镜像** | `docker image prune` | 清理悬空镜像 |

### 10.3 实际应用指导


**🎯 生产环境最佳实践**

1. **镜像选择原则**
   - ✅ 优先选择官方镜像
   - ✅ 使用具体版本标签而非latest
   - ✅ 选择alpine版本减少体积
   - ✅ 定期更新镜像版本

2. **标签管理策略**
   - 🏷️ 使用语义化版本号
   - 🏷️ 区分不同环境的标签
   - 🏷️ 定期清理无用标签
   - 🏷️ 建立标签命名规范

3. **存储空间管理**
   - 📦 定期执行空间清理
   - 📦 监控镜像存储使用情况
   - 📦 删除不再使用的旧版本镜像
   - 📦 使用轻量化基础镜像

### 10.4 故障排查要点


**🔧 常见问题与解决方案**

```
问题1：拉取镜像速度慢
解决：配置国内镜像加速器

问题2：删除镜像提示正在使用
解决：先停止并删除相关容器

问题3：存储空间不足  
解决：执行docker system prune清理

问题4：镜像标签混乱
解决：建立标签管理规范和清理机制
```

**核心记忆口诀**：
- 镜像分层省空间，拉取共享效率高
- 标签管理要规范，版本明确最重要  
- 定期清理释空间，生产环境选官方
- Registry如商店，搜索下载很方便