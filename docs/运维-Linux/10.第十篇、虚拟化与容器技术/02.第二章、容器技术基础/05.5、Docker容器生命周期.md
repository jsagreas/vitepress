---
title: 5、Docker容器生命周期
---
## 📚 目录

1. [Docker容器生命周期概述](#1-Docker容器生命周期概述)
2. [容器创建与运行](#2-容器创建与运行)
3. [容器运行模式详解](#3-容器运行模式详解)
4. [容器状态管理](#4-容器状态管理)
5. [容器交互与监控](#5-容器交互与监控)
6. [容器清理与删除](#6-容器清理与删除)
7. [容器重启策略](#7-容器重启策略)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔄 Docker容器生命周期概述


### 1.1 什么是容器生命周期


**🎯 生活中的类比**
想象一下我们使用家电的过程：买回家(创建) → 插电开机(启动) → 正常使用(运行) → 暂时关闭(停止) → 再次开机(重启) → 最终丢弃(删除)。Docker容器的生命周期就像这样！

**📋 容器的核心状态**
```
容器生命周期状态图：

创建阶段    运行阶段    管理阶段    清理阶段
   ↓         ↓         ↓         ↓
[镜像] → [容器] → [运行中] → [已停止] → [已删除]
         ↑         ↕           ↕
      docker run  start/stop  restart    docker rm
```

### 1.2 容器生命周期的重要性


**💡 为什么要了解生命周期？**
- **资源管理**：合理控制服务器资源占用
- **服务稳定**：确保应用服务持续可用
- **运维效率**：快速定位和解决容器问题
- **成本控制**：避免不必要的资源浪费

---

## 2. 🚀 容器创建与运行


### 2.1 docker run：一步到位的魔法


**🔸 基本概念**
`docker run`是Docker中最重要的命令，它把"创建容器"和"启动容器"两个步骤合并成一步。就像我们买了新手机直接开机使用，而不是先买手机、再单独开机。

**⚡ 基础使用语法**
```bash
docker run [选项] 镜像名 [命令]
```

**🎯 最简单的例子**
```bash
# 运行一个简单的hello world
docker run hello-world

# 运行Ubuntu系统并进入交互模式
docker run -it ubuntu bash
```

### 2.2 常用的run选项详解


**📋 核心选项对照表**

| 选项 | 作用 | 生活类比 | 实际用途 |
|------|------|----------|----------|
| `-d` | 后台运行 | 开启后台音乐播放 | 运行Web服务器 |
| `-it` | 交互模式 | 面对面聊天 | 进入系统调试 |
| `--name` | 给容器命名 | 给宠物起名字 | 方便管理识别 |
| `-p` | 端口映射 | 门牌号对应 | 访问容器服务 |
| `-v` | 挂载数据卷 | 共享文件夹 | 数据持久化 |

### 2.3 创建容器的实际场景


**🌟 场景一：运行Web服务器**
```bash
# 启动一个nginx服务器，映射到本机8080端口
docker run -d --name my-nginx -p 8080:80 nginx

# 解释：
# -d: 在后台运行，不占用终端
# --name: 给容器起个好记的名字
# -p 8080:80: 把容器的80端口映射到主机8080端口
```

**🌟 场景二：临时使用Linux系统**
```bash
# 启动一个临时的Ubuntu系统进行测试
docker run -it --rm ubuntu bash

# 解释：
# -it: 可以与容器进行交互
# --rm: 容器停止后自动删除
# bash: 启动时运行bash命令
```

---

## 3. 🎭 容器运行模式详解


### 3.1 前台模式 vs 后台模式


**🔸 前台模式（默认）**
就像在电脑上直接运行一个程序，你能看到它的输出，但终端被它"占用"了。

```bash
# 前台运行nginx（会看到日志输出）
docker run nginx

# 特点：
# ✅ 能直接看到程序输出日志
# ✅ 适合调试和测试
# ❌ 终端被占用，按Ctrl+C会停止容器
```

**🔸 后台模式（-d选项）**
就像把程序"最小化"运行，它在后台工作，不影响你使用终端做其他事情。

```bash
# 后台运行nginx
docker run -d nginx

# 特点：
# ✅ 终端不被占用，可以继续执行其他命令
# ✅ 适合生产环境的长期服务
# ❌ 看不到直接输出，需要用其他命令查看日志
```

### 3.2 交互模式详解


**💭 什么是交互模式？**
交互模式就像远程登录到另一台电脑，你可以在里面执行命令、查看文件、修改设置等。

**🔧 交互模式选项组合**
```bash
# 完整的交互模式
docker run -it ubuntu bash

# 选项解释：
# -i (--interactive): 保持标准输入打开
# -t (--tty): 分配一个伪终端
# 组合使用: 就像通过SSH登录服务器一样
```

**📝 实用示例**
```bash
# 进入容器调试问题
docker run -it --name debug-container ubuntu bash
root@container:/# ls          # 可以执行Linux命令
root@container:/# ps aux      # 查看进程
root@container:/# exit        # 退出容器
```

---

## 4. 🎛️ 容器状态管理


### 4.1 docker ps：容器状态查看


**🔍 查看运行中的容器**
```bash
# 查看正在运行的容器
docker ps

# 输出示例：
CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS                  NAMES
abc123def456   nginx     "/docker-entrypoint.…"   2 minutes ago   Up 2 minutes   0.0.0.0:8080->80/tcp   my-nginx
```

**📊 输出信息解读**
- **CONTAINER ID**：容器的唯一标识符（简短版）
- **IMAGE**：使用的镜像名称
- **COMMAND**：容器启动时执行的命令
- **CREATED**：容器创建时间
- **STATUS**：当前状态（Up表示运行中）
- **PORTS**：端口映射情况
- **NAMES**：容器名称

**🔍 查看所有容器（包括已停止的）**
```bash
# 查看所有容器状态
docker ps -a

# 常见状态说明：
# Up X minutes        - 正在运行
# Exited (0) X ago    - 正常退出
# Exited (1) X ago    - 异常退出
```

### 4.2 容器启停操作详解


**⭐ docker start：启动已创建的容器**
```bash
# 启动一个已经停止的容器
docker start my-nginx

# 同时启动多个容器
docker start container1 container2

# 启动并进入交互模式
docker start -i my-ubuntu
```

**⭐ docker stop：优雅停止容器**
```bash
# 优雅停止容器（发送SIGTERM信号）
docker stop my-nginx

# 强制停止（等待10秒后发送SIGKILL）
docker stop -t 10 my-nginx

# 停止所有运行中的容器
docker stop $(docker ps -q)
```

**⭐ docker restart：重启容器**
```bash
# 重启容器（相当于stop + start）
docker restart my-nginx

# 快速重启（适用于服务更新）
docker restart -t 5 my-nginx
```

### 4.3 容器状态转换图示


```
容器状态转换流程：

    [docker run]
         ↓
    ┌─────────┐     [docker stop]     ┌─────────┐
    │ 运行中  │ ─────────────────────→ │ 已停止  │
    │(Running)│                       │(Exited) │
    └─────────┘     [docker start]    └─────────┘
         ↑          ←─────────────────      ↓
         │                               [docker rm]
         │     [docker restart]            ↓
         └─────────────────────────→  ┌─────────┐
                                     │ 已删除  │
                                     │(Removed)│
                                     └─────────┘
```

---

## 5. 🔧 容器交互与监控


### 5.1 docker exec：进入运行中的容器


**🚪 进入容器的"后门"**
`docker exec`就像是给正在运行的容器开了一扇"后门"，让你能够进入容器内部执行命令，而不影响容器原本的运行。

**⚡ 基础语法**
```bash
docker exec [选项] 容器名 命令
```

**🎯 常用场景示例**
```bash
# 进入正在运行的容器调试
docker exec -it my-nginx bash

# 在容器中执行单个命令
docker exec my-nginx ls -la /etc/

# 查看容器内进程状态
docker exec my-nginx ps aux

# 在容器中编辑配置文件
docker exec -it my-nginx vi /etc/nginx/nginx.conf
```

**💡 exec与run的区别**
```
docker run：创建新容器并运行
├─ 好比：买一台新电脑并开机使用

docker exec：在现有容器中执行命令  
├─ 好比：远程连接到正在使用的电脑
```

### 5.2 docker logs：查看容器日志


**📋 日志查看的重要性**
日志就像是容器的"黑匣子"，记录了容器内程序的运行情况，是排查问题的重要工具。

**🔍 基础日志查看**
```bash
# 查看容器的所有日志
docker logs my-nginx

# 查看最近的50行日志
docker logs --tail 50 my-nginx

# 实时跟踪日志（类似tail -f）
docker logs -f my-nginx
```

**⚡ 高级日志操作**
```bash
# 查看带时间戳的日志
docker logs -t my-nginx

# 查看指定时间段的日志
docker logs --since "2024-01-01T10:00:00" my-nginx

# 组合使用：实时查看最新20行日志
docker logs -f --tail 20 my-nginx
```

### 5.3 容器监控实用技巧


**📊 容器资源使用情况**
```bash
# 查看容器实时资源使用情况（类似top命令）
docker stats

# 查看特定容器的资源使用
docker stats my-nginx

# 输出示例：
CONTAINER ID   NAME       CPU %     MEM USAGE / LIMIT     MEM %     NET I/O       BLOCK I/O
abc123def456   my-nginx   0.00%     2.5MiB / 7.775GiB     0.03%     1.2kB / 0B    0B / 0B
```

**🔍 容器详细信息**
```bash
# 查看容器的详细配置信息
docker inspect my-nginx

# 只查看特定信息（比如IP地址）
docker inspect --format='{{.NetworkSettings.IPAddress}}' my-nginx
```

---

## 6. 🗑️ 容器清理与删除


### 6.1 docker rm：删除容器


**⚠️ 删除前的重要提醒**
删除容器就像格式化硬盘，容器内的所有数据都会消失！除非你把重要数据保存在数据卷中。

**🔥 基础删除操作**
```bash
# 删除已停止的容器
docker rm my-nginx

# 强制删除运行中的容器
docker rm -f my-nginx

# 删除多个容器
docker rm container1 container2 container3
```

**⚡ 批量清理技巧**
```bash
# 删除所有已停止的容器
docker rm $(docker ps -a -q)

# 或者使用更现代的命令
docker container prune

# 删除所有容器（包括运行中的）
docker rm -f $(docker ps -a -q)
```

### 6.2 自动删除策略


**🎯 临时容器的自动清理**
如果你只是想临时使用一个容器，用完就扔，可以使用`--rm`选项：

```bash
# 容器停止后自动删除
docker run --rm -it ubuntu bash

# 适用场景：
# ✅ 临时测试和调试
# ✅ 一次性脚本执行
# ✅ 数据处理任务
```

### 6.3 清理最佳实践


**📋 定期清理检查清单**
- **🔍 检查**：`docker ps -a` 查看所有容器
- **🧹 清理已停止容器**：`docker container prune`  
- **📊 监控磁盘使用**：`docker system df`
- **🗑️ 深度清理**：`docker system prune`（谨慎使用）

---

## 7. 🔄 容器重启策略


### 7.1 重启策略的重要性


**💭 为什么需要重启策略？**
想象一下你的手机偶尔会死机，重启后又能正常工作。容器也是如此，有时候会因为各种原因停止运行，重启策略就是让容器能够"自动复活"。

### 7.2 四种重启策略详解


**📋 重启策略对照表**

| 策略 | 说明 | 使用场景 | 生活类比 |
|------|------|----------|----------|
| `no` | 永不重启(默认) | 一次性任务 | 用完即弃的纸巾 |
| `always` | 总是重启 | 关键服务 | 24小时营业的便利店 |
| `unless-stopped` | 除非手动停止 | 常规服务 | 自动续费的会员服务 |
| `on-failure` | 失败时重启 | 不稳定服务 | 有保险的设备 |

**🎯 实际配置示例**
```bash
# 总是重启（服务器重启后容器也会自动启动）
docker run -d --restart always --name my-nginx nginx

# 只在失败时重启，最多重试3次
docker run -d --restart on-failure:3 --name my-app my-application

# 除非手动停止，否则都重启
docker run -d --restart unless-stopped --name my-database mysql
```

### 7.3 重启策略的行为差异


**⚡ always vs unless-stopped 的区别**
```
场景：服务器重启后

always策略：
├─ 容器会自动启动 ✅
├─ 即使之前手动停止过

unless-stopped策略：  
├─ 如果容器在运行中 → 自动启动 ✅
├─ 如果之前手动停止 → 不会启动 ❌
```

**🔧 修改已存在容器的重启策略**
```bash
# 修改现有容器的重启策略
docker update --restart unless-stopped my-nginx

# 批量修改多个容器
docker update --restart always container1 container2
```

### 7.4 重启策略最佳实践


**🎯 选择建议**
- **Web服务器、数据库**：使用`always`或`unless-stopped`
- **定时任务、数据处理**：使用`no`
- **测试中的不稳定应用**：使用`on-failure:3`

**⚠️ 重要注意事项**
- 重启策略只在容器异常退出时生效
- 手动`docker stop`停止的容器不会触发重启
- 重启过于频繁可能表明应用本身有问题

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心命令


```
🔸 容器创建运行：docker run [选项] 镜像名
🔸 查看容器状态：docker ps / docker ps -a  
🔸 启动停止容器：docker start/stop/restart 容器名
🔸 进入运行容器：docker exec -it 容器名 命令
🔸 查看容器日志：docker logs 容器名
🔸 删除容器：docker rm 容器名
🔸 设置重启策略：--restart 策略名
```

### 8.2 关键概念理解


**🔹 生命周期状态转换**
```
创建 → 运行 → 停止 → 删除
  ↓      ↕      ↕      ↑
docker  start  stop   rm
 run   restart
```

**🔹 运行模式选择**
```
前台模式：适合调试测试，能看到实时输出
后台模式：适合生产服务，不占用终端
交互模式：适合进入容器内部操作
```

**🔹 重启策略选择**
```
always：重要服务，需要高可用
unless-stopped：常规服务，手动控制
on-failure：不稳定服务，失败重试
no：一次性任务，用完即停
```

### 8.3 实际应用价值


**🎯 典型使用场景**
- **开发测试**：快速创建隔离的测试环境
- **服务部署**：部署Web应用和数据库服务
- **问题排查**：通过exec进入容器调试问题
- **运维监控**：通过logs和stats监控服务状态

**🔧 操作技巧总结**
- 使用有意义的容器名称，便于管理
- 合理选择运行模式和重启策略
- 定期清理不需要的容器，释放资源
- 重要数据使用数据卷持久化存储

**核心记忆口诀**：
```
run创建容器启动快，ps查看状态一目了然
start stop restart控制好，exec进入logs来排障  
rm删除容器要小心，重启策略保稳定
前台后台选模式，交互调试更方便
```

**🏆 掌握容器生命周期的价值**
- 提高Docker使用效率和操作熟练度
- 具备基本的容器运维和问题排查能力  
- 为后续学习容器编排和微服务奠定基础
- 在实际项目中能够合理规划容器资源