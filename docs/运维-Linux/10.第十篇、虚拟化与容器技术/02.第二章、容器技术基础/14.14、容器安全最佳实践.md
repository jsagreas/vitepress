---
title: 14ã€å®¹å™¨å®‰å…¨æœ€ä½³å®è·µ
---
## ğŸ“š ç›®å½•

1. [å®¹å™¨å®‰å…¨æ¦‚è¿°](#1-å®¹å™¨å®‰å…¨æ¦‚è¿°)
2. [æœ€å°æƒé™åŸåˆ™å®æ–½](#2-æœ€å°æƒé™åŸåˆ™å®æ–½)
3. [érootç”¨æˆ·è¿è¡Œå®¹å™¨](#3-érootç”¨æˆ·è¿è¡Œå®¹å™¨)
4. [åªè¯»æ–‡ä»¶ç³»ç»Ÿé…ç½®](#4-åªè¯»æ–‡ä»¶ç³»ç»Ÿé…ç½®)
5. [æ•æ„Ÿä¿¡æ¯ç®¡ç†ç­–ç•¥](#5-æ•æ„Ÿä¿¡æ¯ç®¡ç†ç­–ç•¥)
6. [ç½‘ç»œéš”ç¦»ä¸é˜²æŠ¤](#6-ç½‘ç»œéš”ç¦»ä¸é˜²æŠ¤)
7. [èµ„æºé™åˆ¶é…ç½®](#7-èµ„æºé™åˆ¶é…ç½®)
8. [å®‰å…¨æ‰«æå·¥å…·ä½¿ç”¨](#8-å®‰å…¨æ‰«æå·¥å…·ä½¿ç”¨)
9. [å®¹å™¨è¿è¡Œæ—¶å®‰å…¨](#9-å®¹å™¨è¿è¡Œæ—¶å®‰å…¨)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ å®¹å™¨å®‰å…¨æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å®¹å™¨å®‰å…¨


**ç®€å•ç†è§£**ï¼šå®¹å™¨å®‰å…¨å°±åƒç»™æˆ¿å­è£…é˜²ç›—é—¨å’Œç›‘æ§ç³»ç»Ÿä¸€æ ·ï¼Œä¿æŠ¤å®¹å™¨é‡Œçš„åº”ç”¨ä¸å—æ”»å‡»å’Œç ´åã€‚

```
ä¼ ç»ŸæœåŠ¡å™¨å®‰å…¨ vs å®¹å™¨å®‰å…¨ï¼š

ä¼ ç»ŸæœåŠ¡å™¨ï¼š
ğŸ  ä¸€æ ‹ç‹¬ç«‹æˆ¿å­
â”œâ”€â”€ ğŸšª ä¸€é“å¤§é—¨ï¼ˆé˜²ç«å¢™ï¼‰
â”œâ”€â”€ ğŸ”’ æˆ¿é—´é—¨é”ï¼ˆç”¨æˆ·æƒé™ï¼‰
â””â”€â”€ ğŸ“¹ ç›‘æ§ç³»ç»Ÿï¼ˆæ—¥å¿—å®¡è®¡ï¼‰

å®¹å™¨ç¯å¢ƒï¼š
ğŸ¢ ä¸€æ ‹å…¬å¯“æ¥¼
â”œâ”€â”€ ğŸšª æ¥¼å±‚å¤§é—¨ï¼ˆå®¿ä¸»æœºå®‰å…¨ï¼‰
â”œâ”€â”€ ğŸ”’ å„ä¸ªæˆ¿é—´ï¼ˆå®¹å™¨éš”ç¦»ï¼‰
â”œâ”€â”€ ğŸš¦ æ¥¼å±‚ç®¡ç†ï¼ˆå®¹å™¨ç¼–æ’ï¼‰
â””â”€â”€ ğŸ“¹ å…¨æ¥¼ç›‘æ§ï¼ˆé›†ä¸­æ—¥å¿—ï¼‰
```

### 1.2 å®¹å™¨å®‰å…¨é¢ä¸´çš„ä¸»è¦å¨èƒ


**ğŸ”¥ å¸¸è§å®‰å…¨é£é™©**ï¼š

| å¨èƒç±»å‹ | **å…·ä½“è¡¨ç°** | **å½±å“ç¨‹åº¦** | **é˜²æŠ¤é‡ç‚¹** |
|---------|-------------|-------------|-------------|
| ğŸ› **é•œåƒæ¼æ´** | `åŸºç¡€é•œåƒåŒ…å«å·²çŸ¥æ¼æ´` | âš¡ é«˜å± | å®šæœŸæ‰«ææ›´æ–° |
| ğŸ”“ **æƒé™æ»¥ç”¨** | `å®¹å™¨ä»¥rootæƒé™è¿è¡Œ` | ğŸ”¥ ä¸¥é‡ | æœ€å°æƒé™åŸåˆ™ |
| ğŸ“Š **èµ„æºæ»¥ç”¨** | `æ¶æ„å®¹å™¨å ç”¨æ‰€æœ‰CPU` | âš ï¸ ä¸­ç­‰ | èµ„æºé™åˆ¶é…ç½® |
| ğŸŒ **ç½‘ç»œæ”»å‡»** | `å®¹å™¨é—´æ¶æ„é€šä¿¡` | ğŸ”¥ ä¸¥é‡ | ç½‘ç»œéš”ç¦»ç­–ç•¥ |
| ğŸ—ƒï¸ **æ•°æ®æ³„éœ²** | `æ•æ„Ÿä¿¡æ¯ç¡¬ç¼–ç ` | âš¡ é«˜å± | å¯†é’¥ç®¡ç†æœºåˆ¶ |

### 1.3 å®¹å™¨å®‰å…¨é˜²æŠ¤ä½“ç³»


**ğŸ—ï¸ å¤šå±‚é˜²æŠ¤æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          åº”ç”¨å±‚å®‰å…¨                  â”‚ â† ä»£ç å®¡è®¡ã€ä¾èµ–æ£€æŸ¥
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          å®¹å™¨å±‚å®‰å…¨                  â”‚ â† é•œåƒæ‰«æã€è¿è¡Œæ—¶é˜²æŠ¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          ç¼–æ’å±‚å®‰å…¨                  â”‚ â† K8sç­–ç•¥ã€RBACæƒé™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          å®¿ä¸»æœºå®‰å…¨                  â”‚ â† OSåŠ å›ºã€å†…æ ¸é˜²æŠ¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          ç½‘ç»œå±‚å®‰å…¨                  â”‚ â† ç½‘ç»œéš”ç¦»ã€æµé‡ç›‘æ§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ” æœ€å°æƒé™åŸåˆ™å®æ–½


### 2.1 ä»€ä¹ˆæ˜¯æœ€å°æƒé™åŸåˆ™


> ğŸ“Œ **æ ¸å¿ƒæ¦‚å¿µ**  
> æœ€å°æƒé™åŸåˆ™å°±åƒé“¶è¡Œçš„é‡‘åº“ç®¡ç†ï¼šæ¯ä¸ªäººåªèƒ½è®¿é—®è‡ªå·±å·¥ä½œéœ€è¦çš„åŒºåŸŸï¼Œä¸ç»™å¤šä½™çš„æƒé™ã€‚

**å®é™…åº”ç”¨åœºæ™¯**ï¼š
```
âŒ åä¾‹å­ï¼šç»™æ‰€æœ‰å‘˜å·¥é‡‘åº“é’¥åŒ™
âœ… å¥½ä¾‹å­ï¼šå‡ºçº³åªèƒ½è¿›å‡ºçº³å®¤ï¼Œç»ç†åªèƒ½è¿›åŠå…¬å®¤

âŒ å®¹å™¨åä¾‹å­ï¼šæ‰€æœ‰å®¹å™¨éƒ½ç”¨rootæƒé™
âœ… å®¹å™¨å¥½ä¾‹å­ï¼šåº”ç”¨å®¹å™¨ç”¨æ™®é€šç”¨æˆ·ï¼Œæ•°æ®åº“å®¹å™¨æœ‰é™åˆ¶æƒé™
```

### 2.2 Linuxèƒ½åŠ›(Capabilities)æ§åˆ¶


**ğŸ” ä»€ä¹ˆæ˜¯Linuxèƒ½åŠ›**ï¼š
- ä¼ ç»Ÿï¼šè¦ä¹ˆæ˜¯`root`ï¼ˆè¶…çº§æƒé™ï¼‰ï¼Œè¦ä¹ˆæ˜¯`æ™®é€šç”¨æˆ·`ï¼ˆå—é™æƒé™ï¼‰
- ç°ä»£ï¼šå°†rootæƒé™**æ‹†åˆ†**æˆå¤šä¸ªå°æƒé™ï¼ŒæŒ‰éœ€åˆ†é…

**å¸¸ç”¨èƒ½åŠ›åˆ—è¡¨**ï¼š

| èƒ½åŠ›åç§° | **ä½œç”¨è¯´æ˜** | **ä½¿ç”¨åœºæ™¯** | **é£é™©ç­‰çº§** |
|---------|-------------|-------------|-------------|
| `CAP_NET_BIND_SERVICE` | ç»‘å®š1024ä»¥ä¸‹ç«¯å£ | WebæœåŠ¡å™¨ | ğŸŸ¡ ä¸­ç­‰ |
| `CAP_CHOWN` | ä¿®æ”¹æ–‡ä»¶æ‰€æœ‰è€… | æ–‡ä»¶ç®¡ç†åº”ç”¨ | ğŸŸ¡ ä¸­ç­‰ |
| `CAP_DAC_OVERRIDE` | ç»•è¿‡æ–‡ä»¶æƒé™æ£€æŸ¥ | å¤‡ä»½å·¥å…· | ğŸ”´ é«˜å± |
| `CAP_NET_ADMIN` | ç½‘ç»œç®¡ç†æƒé™ | ç½‘ç»œå·¥å…· | ğŸ”´ é«˜å± |
| `CAP_SYS_ADMIN` | ç³»ç»Ÿç®¡ç†æƒé™ | å‡ ä¹ç­‰äºroot | âš« æå± |

**ğŸ› ï¸ å®é™…é…ç½®ç¤ºä¾‹**ï¼š
```bash
# åªç»™WebæœåŠ¡å™¨ç»‘å®š80ç«¯å£çš„æƒé™
docker run -d \
  --cap-drop=ALL \
  --cap-add=NET_BIND_SERVICE \
  --user 1000:1000 \
  nginx:alpine

# æŸ¥çœ‹å®¹å™¨å½“å‰æ‹¥æœ‰çš„èƒ½åŠ›
docker exec container_name capsh --print
```

### 2.3 æ–‡ä»¶ç³»ç»Ÿæƒé™æ§åˆ¶


**ğŸ“ ç›®å½•æƒé™æœ€ä½³å®è·µ**ï¼š
```bash
# åº”ç”¨ç¨‹åºç›®å½•è®¾ç½®
/app/                    # åº”ç”¨æ ¹ç›®å½•
â”œâ”€â”€ bin/          755    # å¯æ‰§è¡Œæ–‡ä»¶ç›®å½•ï¼ˆåªè¯»+æ‰§è¡Œï¼‰
â”œâ”€â”€ config/       644    # é…ç½®æ–‡ä»¶ç›®å½•ï¼ˆåªè¯»ï¼‰
â”œâ”€â”€ data/         755    # æ•°æ®ç›®å½•ï¼ˆè¯»å†™ï¼Œé™åˆ¶ç”¨æˆ·ï¼‰
â”œâ”€â”€ logs/         755    # æ—¥å¿—ç›®å½•ï¼ˆè¯»å†™ï¼‰
â””â”€â”€ tmp/          1777   # ä¸´æ—¶ç›®å½•ï¼ˆå—é™å†™å…¥ï¼‰
```

> ğŸ’¡ **å®ç”¨æŠ€å·§**  
> ç”¨`chmod`è®¾ç½®æƒé™æ—¶è®°ä½ï¼š7=è¯»å†™æ‰§è¡Œï¼Œ6=è¯»å†™ï¼Œ5=è¯»æ‰§è¡Œï¼Œ4=åªè¯»

---

## 3. ğŸ‘¤ érootç”¨æˆ·è¿è¡Œå®¹å™¨


### 3.1 ä¸ºä»€ä¹ˆä¸èƒ½ç”¨rootç”¨æˆ·


**ğŸš¨ rootç”¨æˆ·çš„å±é™©**ï¼š
```
å®¹å™¨å†…root = å®¿ä¸»æœºrootï¼Ÿ

ç†è®ºä¸Šï¼šå®¹å™¨åº”è¯¥éš”ç¦»ï¼Œrootæƒé™è¢«é™åˆ¶
å®é™…ä¸Šï¼šå¦‚æœå®¹å™¨é€ƒé€¸ï¼Œrootæƒé™å¯èƒ½å½±å“å®¿ä¸»æœº

å°±åƒé…’åº—æˆ¿é—´ï¼š
âŒ ç»™å®¢äººä¸‡èƒ½é’¥åŒ™ï¼ˆrootï¼‰â†’ å¯ä»¥è¿›å…¥æ‰€æœ‰æˆ¿é—´
âœ… ç»™å®¢äººæˆ¿å¡ï¼ˆæ™®é€šç”¨æˆ·ï¼‰â†’ åªèƒ½è¿›å…¥è‡ªå·±æˆ¿é—´
```

### 3.2 åˆ›å»ºä¸“ç”¨ç”¨æˆ·çš„æ–¹æ³•


**ğŸ”§ æ–¹æ³•ä¸€ï¼šDockerfileä¸­åˆ›å»ºç”¨æˆ·**
```dockerfile
FROM alpine:latest

# åˆ›å»ºä¸“ç”¨ç”¨æˆ·å’Œç»„
RUN addgroup -g 1001 appgroup && \
    adduser -D -u 1001 -G appgroup appuser

# åˆ›å»ºåº”ç”¨ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p /app && \
    chown -R appuser:appgroup /app

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER appuser

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶åº”ç”¨æ–‡ä»¶
COPY --chown=appuser:appgroup ./app .

CMD ["./start.sh"]
```

**ğŸ”§ æ–¹æ³•äºŒï¼šè¿è¡Œæ—¶æŒ‡å®šç”¨æˆ·**
```bash
# ä½¿ç”¨æ•°å­—UID/GIDï¼ˆæ¨èï¼‰
docker run -d --user 1001:1001 myapp:latest

# ä½¿ç”¨ç”¨æˆ·åï¼ˆéœ€è¦å®¹å™¨å†…å­˜åœ¨è¯¥ç”¨æˆ·ï¼‰
docker run -d --user appuser myapp:latest

# ä¸´æ—¶åˆ›å»ºç”¨æˆ·å¹¶è¿è¡Œ
docker run -d --user $(id -u):$(id -g) myapp:latest
```

### 3.3 å¸¸è§ç”¨æˆ·é…ç½®é—®é¢˜


**â— é—®é¢˜1ï¼šæƒé™ä¸è¶³**
```bash
# é”™è¯¯ç°è±¡ï¼šPermission denied
# åŸå› ï¼šæ™®é€šç”¨æˆ·æ— æ³•å†™å…¥ç›®å½•

# è§£å†³æ–¹æ¡ˆï¼šæ­£ç¡®è®¾ç½®ç›®å½•æƒé™
RUN mkdir -p /app/logs && \
    chown 1001:1001 /app/logs
```

**â— é—®é¢˜2ï¼šç«¯å£ç»‘å®šå¤±è´¥**
```bash
# é”™è¯¯ç°è±¡ï¼šCannot bind to port 80
# åŸå› ï¼šérootç”¨æˆ·æ— æ³•ç»‘å®š1024ä»¥ä¸‹ç«¯å£

# è§£å†³æ–¹æ¡ˆ1ï¼šä½¿ç”¨é«˜ç«¯å£
EXPOSE 8080

# è§£å†³æ–¹æ¡ˆ2ï¼šæ·»åŠ èƒ½åŠ›
docker run --cap-add=NET_BIND_SERVICE myapp
```

---

## 4. ğŸ“ åªè¯»æ–‡ä»¶ç³»ç»Ÿé…ç½®


### 4.1 ä»€ä¹ˆæ˜¯åªè¯»æ–‡ä»¶ç³»ç»Ÿ


> ğŸ“Œ **æ ¸å¿ƒæ¦‚å¿µ**  
> åªè¯»æ–‡ä»¶ç³»ç»Ÿå°±åƒå›¾ä¹¦é¦†çš„ä¹¦ç±ï¼šå¯ä»¥é˜…è¯»ï¼Œä½†ä¸èƒ½ä¿®æ”¹ã€‚è¿™æ ·å³ä½¿è¢«æ”»å‡»ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•ç¯¡æ”¹ç³»ç»Ÿæ–‡ä»¶ã€‚

**åªè¯» vs å¯å†™å¯¹æ¯”**ï¼š
```
å¯å†™æ–‡ä»¶ç³»ç»Ÿï¼ˆé»˜è®¤ï¼‰ï¼š
â”œâ”€â”€ /app/           â† å¯ä»¥ä¿®æ”¹åº”ç”¨æ–‡ä»¶
â”œâ”€â”€ /tmp/           â† å¯ä»¥åˆ›å»ºä¸´æ—¶æ–‡ä»¶  
â”œâ”€â”€ /var/log/       â† å¯ä»¥å†™å…¥æ—¥å¿—
â””â”€â”€ /etc/           â† å¯ä»¥ä¿®æ”¹é…ç½®ï¼ˆå±é™©ï¼ï¼‰

åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼š
â”œâ”€â”€ /app/           â† ğŸ”’ åªè¯»ï¼Œæ— æ³•ç¯¡æ”¹
â”œâ”€â”€ /tmp/           â† âœ… æŒ‚è½½ä¸ºtmpfsï¼ˆå†…å­˜ä¸­ï¼‰
â”œâ”€â”€ /var/log/       â† âœ… å•ç‹¬æŒ‚è½½å·
â””â”€â”€ /etc/           â† ğŸ”’ åªè¯»ï¼Œé…ç½®å®‰å…¨
```

### 4.2 é…ç½®åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ


**ğŸ”§ åŸºæœ¬é…ç½®æ–¹æ³•**ï¼š
```bash
# å¯ç”¨åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
docker run -d \
  --read-only \
  --tmpfs /tmp \
  --tmpfs /run \
  -v logs_volume:/app/logs \
  myapp:latest
```

**ğŸ“ éœ€è¦ç‰¹æ®Šå¤„ç†çš„ç›®å½•**ï¼š

| ç›®å½• | **ç”¨é€”** | **å¤„ç†æ–¹å¼** | **åŸå› ** |
|------|---------|-------------|---------|
| `/tmp` | ä¸´æ—¶æ–‡ä»¶ | `--tmpfs /tmp` | åº”ç”¨éœ€è¦åˆ›å»ºä¸´æ—¶æ–‡ä»¶ |
| `/var/log` | æ—¥å¿—æ–‡ä»¶ | æŒ‚è½½å¤–éƒ¨å· | æ—¥å¿—éœ€è¦æŒä¹…åŒ– |
| `/run` | è¿è¡Œæ—¶æ•°æ® | `--tmpfs /run` | è¿›ç¨‹éœ€è¦åˆ›å»ºsocket |
| `/var/cache` | ç¼“å­˜æ•°æ® | `--tmpfs /var/cache` | ç¼“å­˜å¯ä»¥ä¸¢å¤± |

### 4.3 åªè¯»æ–‡ä»¶ç³»ç»Ÿå®è·µæ¡ˆä¾‹


**ğŸŒ Webåº”ç”¨é…ç½®ç¤ºä¾‹**ï¼š
```bash
# Nginxåªè¯»é…ç½®
docker run -d \
  --name nginx-readonly \
  --read-only \
  --tmpfs /var/cache/nginx \
  --tmpfs /var/run \
  --tmpfs /tmp \
  -v ./nginx.conf:/etc/nginx/nginx.conf:ro \
  -v ./html:/usr/share/nginx/html:ro \
  -v logs:/var/log/nginx \
  -p 8080:80 \
  nginx:alpine
```

**ğŸ”— å¤šé˜¶æ®µæ„å»ºæ”¯æŒåªè¯»**ï¼š
```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:16 AS builder
WORKDIR /build
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# è¿è¡Œé˜¶æ®µ
FROM nginx:alpine
# åˆ›å»ºérootç”¨æˆ·
RUN adduser -D -u 1001 nginx-user

# å¤åˆ¶æ„å»ºç»“æœï¼ˆåªè¯»ï¼‰
COPY --from=builder /build/dist /usr/share/nginx/html

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /var/cache/nginx /var/run /tmp && \
    chown -R nginx-user:nginx-user /var/cache/nginx /var/run

USER nginx-user
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**  
> å¯ç”¨åªè¯»æ–‡ä»¶ç³»ç»Ÿå‰ï¼Œå…ˆæµ‹è¯•åº”ç”¨æ˜¯å¦ä¼šå‘æ ¹æ–‡ä»¶ç³»ç»Ÿå†™å…¥æ•°æ®ï¼Œå¦åˆ™å®¹å™¨å¯èƒ½æ— æ³•å¯åŠ¨

---

## 5. ğŸ”‘ æ•æ„Ÿä¿¡æ¯ç®¡ç†ç­–ç•¥


### 5.1 æ•æ„Ÿä¿¡æ¯æ³„éœ²çš„å±å®³


**ä»€ä¹ˆæ˜¯æ•æ„Ÿä¿¡æ¯**ï¼š
- ğŸ”‘ **æ•°æ®åº“å¯†ç **ï¼š`mysql_password=admin123`
- ğŸŒ **APIå¯†é’¥**ï¼š`aws_access_key=AKIA...`  
- ğŸ“œ **ç§é’¥è¯ä¹¦**ï¼š`-----BEGIN PRIVATE KEY-----`
- ğŸ« **è®¿é—®ä»¤ç‰Œ**ï¼š`bearer_token=eyJhbGciOi...`

**æ³„éœ²é€”å¾„ä¸é£é™©**ï¼š
```
å¸¸è§æ³„éœ²æ–¹å¼ï¼š

1. ç¡¬ç¼–ç åœ¨æºç ä¸­
   âŒ config.py: password = "admin123"
   â†’ é£é™©ï¼šæºç æ³„éœ² = å¯†ç æ³„éœ²

2. å†™åœ¨Dockerfileä¸­  
   âŒ ENV DB_PASSWORD=admin123
   â†’ é£é™©ï¼šé•œåƒåˆ†äº« = å¯†ç å…¬å¼€

3. é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’
   âŒ docker run -e PASSWORD=admin123 myapp
   â†’ é£é™©ï¼špså‘½ä»¤å¯è§å¯†ç 

4. å­˜å‚¨åœ¨å®¹å™¨æ–‡ä»¶ä¸­
   âŒ echo "admin123" > /app/password.txt  
   â†’ é£é™©ï¼šå®¹å™¨å¤‡ä»½åŒ…å«æ˜æ–‡å¯†ç 
```

### 5.2 Docker Secretsç®¡ç†


**ğŸ” Docker Swarm Secretsï¼ˆæ¨èï¼‰**ï¼š
```bash
# 1. åˆ›å»ºå¯†é’¥
echo "my_db_password" | docker secret create db_password -

# 2. åœ¨æœåŠ¡ä¸­ä½¿ç”¨å¯†é’¥
docker service create \
  --name myapp \
  --secret db_password \
  myapp:latest

# 3. åº”ç”¨ä¸­è¯»å–å¯†é’¥ï¼ˆå¯†é’¥æŒ‚è½½åœ¨ /run/secrets/ï¼‰
cat /run/secrets/db_password
```

**åœ¨åº”ç”¨ä»£ç ä¸­å®‰å…¨è¯»å–**ï¼š
```python
# Pythonç¤ºä¾‹ï¼šå®‰å…¨è¯»å–å¯†é’¥
import os

def get_secret(secret_name):
    """ä»Docker Secretä¸­è¯»å–æ•æ„Ÿä¿¡æ¯"""
    secret_path = f"/run/secrets/{secret_name}"
    try:
        with open(secret_path, 'r') as f:
            return f.read().strip()
    except FileNotFoundError:
        # å¼€å‘ç¯å¢ƒå›é€€åˆ°ç¯å¢ƒå˜é‡
        return os.getenv(secret_name.upper())

# ä½¿ç”¨æ–¹å¼
db_password = get_secret("db_password")
```

### 5.3 ç¯å¢ƒå˜é‡å®‰å…¨ä½¿ç”¨


**âœ… å®‰å…¨çš„ç¯å¢ƒå˜é‡å®è·µ**ï¼š
```bash
# æ–¹æ³•1ï¼šä½¿ç”¨æ–‡ä»¶ä¼ é€’æ•æ„Ÿä¿¡æ¯
docker run -d \
  --env-file ./app.env \
  -v ./secrets:/app/secrets:ro \
  myapp:latest

# app.env å†…å®¹ï¼ˆéæ•æ„Ÿé…ç½®ï¼‰
APP_NAME=myapp
LOG_LEVEL=info
DB_HOST=localhost

# secretsç›®å½•åŒ…å«æ•æ„Ÿä¿¡æ¯æ–‡ä»¶
```

**ğŸ”§ åŠ¨æ€å¯†é’¥è·å–æ¨¡å¼**ï¼š
```bash
#!/bin/bash
# å¯åŠ¨è„šæœ¬ï¼šä»å¤–éƒ¨ç³»ç»Ÿè·å–å¯†é’¥

# ä»å¯†é’¥ç®¡ç†ç³»ç»Ÿè·å–
export DB_PASSWORD=$(vault kv get -field=password secret/db)

# å¯åŠ¨åº”ç”¨
exec /app/start.sh
```

### 5.4 ç¬¬ä¸‰æ–¹å¯†é’¥ç®¡ç†é›†æˆ


**ğŸ¢ ä¼ä¸šçº§å¯†é’¥ç®¡ç†æ–¹æ¡ˆ**ï¼š

| æ–¹æ¡ˆ | **ç‰¹ç‚¹** | **é€‚ç”¨åœºæ™¯** | **é›†æˆéš¾åº¦** |
|------|---------|-------------|-------------|
| **HashiCorp Vault** | åŠ¨æ€å¯†é’¥ã€å®¡è®¡æ—¥å¿— | å¤§å‹ä¼ä¸š | ğŸ”´ å¤æ‚ |
| **AWS Secrets Manager** | äº‘åŸç”Ÿã€è‡ªåŠ¨è½®æ¢ | AWSç¯å¢ƒ | ğŸŸ¡ ä¸­ç­‰ |
| **Kubernetes Secrets** | å®¹å™¨ç¼–æ’é›†æˆ | K8sé›†ç¾¤ | ğŸŸ¢ ç®€å• |
| **Azure Key Vault** | å¾®è½¯ç”Ÿæ€ | Azureç¯å¢ƒ | ğŸŸ¡ ä¸­ç­‰ |

**ğŸ”— Vaulté›†æˆç¤ºä¾‹**ï¼š
```bash
# å¯åŠ¨æ—¶ä»Vaultè·å–å¯†é’¥
docker run -d \
  -e VAULT_ADDR=https://vault.company.com \
  -e VAULT_TOKEN=$(cat ~/.vault-token) \
  --entrypoint /scripts/vault-init.sh \
  myapp:latest
```

---

## 6. ğŸŒ ç½‘ç»œéš”ç¦»ä¸é˜²æŠ¤


### 6.1 å®¹å™¨ç½‘ç»œå®‰å…¨åŸºç¡€


**ğŸŒ ç†è§£å®¹å™¨ç½‘ç»œæ¨¡å‹**ï¼š
```
å®¿ä¸»æœºç½‘ç»œè§†å›¾ï¼š
å®¿ä¸»æœº (192.168.1.100)
â”œâ”€â”€ docker0 ç½‘æ¡¥ (172.17.0.1)
â”‚   â”œâ”€â”€ å®¹å™¨A (172.17.0.2) 
â”‚   â”œâ”€â”€ å®¹å™¨B (172.17.0.3)
â”‚   â””â”€â”€ å®¹å™¨C (172.17.0.4)
â”œâ”€â”€ è‡ªå®šä¹‰ç½‘æ¡¥ (172.20.0.1)  
â”‚   â”œâ”€â”€ å®¹å™¨D (172.20.0.2)
â”‚   â””â”€â”€ å®¹å™¨E (172.20.0.3)
â””â”€â”€ ä¸»æœºç½‘ç»œ (ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºIP)
```

**ç½‘ç»œéš”ç¦»å±‚æ¬¡**ï¼š
- ğŸ”µ **å®Œå…¨éš”ç¦»**ï¼šä¸åŒç½‘ç»œæ— æ³•é€šä¿¡
- ğŸŸ¡ **æœ‰é™é€šä¿¡**ï¼šåªå…è®¸ç‰¹å®šç«¯å£
- ğŸŸ¢ **å®Œå…¨äº’é€š**ï¼šåŒä¸€ç½‘ç»œå†…è‡ªç”±é€šä¿¡

### 6.2 è‡ªå®šä¹‰ç½‘ç»œéš”ç¦»


**ğŸ”§ åˆ›å»ºéš”ç¦»ç½‘ç»œ**ï¼š
```bash
# 1. åˆ›å»ºå‰ç«¯ç½‘ç»œï¼ˆWebæœåŠ¡ï¼‰
docker network create \
  --driver bridge \
  --subnet=172.20.0.0/16 \
  frontend_network

# 2. åˆ›å»ºåç«¯ç½‘ç»œï¼ˆæ•°æ®åº“æœåŠ¡ï¼‰  
docker network create \
  --driver bridge \
  --subnet=172.21.0.0/16 \
  --internal \
  backend_network

# 3. è¿è¡Œéš”ç¦»çš„å®¹å™¨
docker run -d \
  --name web \
  --network frontend_network \
  -p 8080:80 \
  nginx:alpine

docker run -d \
  --name database \
  --network backend_network \
  postgres:13
```

**ğŸ”— è·¨ç½‘ç»œé€šä¿¡æ§åˆ¶**ï¼š
```bash
# ä¸­é—´å±‚æœåŠ¡è¿æ¥ä¸¤ä¸ªç½‘ç»œ
docker run -d \
  --name api_server \
  --network frontend_network \
  myapi:latest

# å°†APIæœåŠ¡å™¨ä¹Ÿè¿æ¥åˆ°åç«¯ç½‘ç»œ
docker network connect backend_network api_server

# ç°åœ¨APIæœåŠ¡å™¨å¯ä»¥ï¼š
# âœ… é€šè¿‡frontend_networkæ¥æ”¶Webè¯·æ±‚
# âœ… é€šè¿‡backend_networkè®¿é—®æ•°æ®åº“
# âŒ Webå®¹å™¨æ— æ³•ç›´æ¥è®¿é—®æ•°æ®åº“
```

### 6.3 é˜²ç«å¢™è§„åˆ™é…ç½®


**ğŸ›¡ï¸ iptablesé˜²ç«å¢™è§„åˆ™**ï¼š
```bash
# ç¦æ­¢å®¹å™¨è®¿é—®å®¿ä¸»æœºæ•æ„ŸæœåŠ¡
iptables -I DOCKER-USER \
  -i docker0 -d 192.168.1.100/32 -p tcp --dport 22 \
  -j DROP

# é™åˆ¶å®¹å™¨å¯¹å¤–è®¿é—®
iptables -I DOCKER-USER \
  -i docker0 ! -d 172.17.0.0/16 \
  -j DROP

# æŸ¥çœ‹DOCKER-USERé“¾è§„åˆ™
iptables -L DOCKER-USER -n -v
```

**ğŸ“Š ç½‘ç»œè®¿é—®æ§åˆ¶ç¤ºä¾‹**ï¼š
```
è®¿é—®æ§åˆ¶ç­–ç•¥ï¼š

Internet
    â†“ (å…è®¸80,443)
Load Balancer 
    â†“ (åªèƒ½è®¿é—®Webå±‚)  
Web Servers (frontend_network)
    â†“ (åªèƒ½è®¿é—®APIå±‚)
API Servers (è¿æ¥ä¸¤ä¸ªç½‘ç»œ)
    â†“ (åªèƒ½è®¿é—®æ•°æ®åº“)
Database (backend_network, internal)
```

### 6.4 å®¹å™¨ç½‘ç»œç›‘æ§


**ğŸ” ç½‘ç»œæµé‡ç›‘æ§**ï¼š
```bash
# å®æ—¶æŸ¥çœ‹å®¹å™¨ç½‘ç»œè¿æ¥
docker exec container_name netstat -tulpn

# æŸ¥çœ‹å®¹å™¨ç½‘ç»œç»Ÿè®¡
docker exec container_name ss -s

# ç›‘æ§ç‰¹å®šå®¹å™¨çš„ç½‘ç»œæµé‡
docker exec container_name iftop -i eth0
```

---

## 7. âš¡ èµ„æºé™åˆ¶é…ç½®


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦èµ„æºé™åˆ¶


> ğŸ“Œ **æ ¸å¿ƒæ¦‚å¿µ**  
> èµ„æºé™åˆ¶å°±åƒå…¬å¯“çš„æ°´ç”µä½¿ç”¨é™åˆ¶ï¼šé˜²æ­¢æŸä¸ªä½æˆ·è¿‡åº¦ä½¿ç”¨èµ„æºå½±å“å…¶ä»–ä½æˆ·ã€‚

**ğŸš¨ æ— é™åˆ¶èµ„æºçš„å±å®³**ï¼š
```
åœºæ™¯ï¼šæ¶æ„æˆ–æœ‰bugçš„å®¹å™¨

CPUæ— é™åˆ¶ï¼š
ğŸ“ˆ ä¸€ä¸ªå®¹å™¨å ç”¨100% CPU
â†’ å®¿ä¸»æœºå…¶ä»–å®¹å™¨å“åº”ç¼“æ…¢
â†’ ç³»ç»Ÿå¯èƒ½æ­»æœº

å†…å­˜æ— é™åˆ¶ï¼š  
ğŸ’¾ å®¹å™¨å†…å­˜æ³„éœ²æŒç»­å¢é•¿
â†’ è§¦å‘å®¿ä¸»æœºOOM Killer
â†’ é‡è¦å®¹å™¨å¯èƒ½è¢«æ€æ­»

ç£ç›˜æ— é™åˆ¶ï¼š
ğŸ’¿ å®¹å™¨ç–¯ç‹‚å†™å…¥æ—¥å¿—æ–‡ä»¶
â†’ ç£ç›˜ç©ºé—´è¢«è€—å°½
â†’ æ•´ä¸ªç³»ç»Ÿæ— æ³•æ­£å¸¸å·¥ä½œ
```

### 7.2 CPUèµ„æºé™åˆ¶


**ğŸ”§ CPUé™åˆ¶é…ç½®**ï¼š
```bash
# é™åˆ¶CPUä½¿ç”¨æ ¸æ•°
docker run -d \
  --cpus="1.5" \
  --name cpu_limited \
  stress_test_app

# é™åˆ¶CPUä½¿ç”¨ç™¾åˆ†æ¯”ï¼ˆæ¨èï¼‰
docker run -d \
  --cpu-quota=50000 \
  --cpu-period=100000 \
  stress_test_app
# è§£é‡Šï¼š50000/100000 = 50% CPUä½¿ç”¨ç‡

# è®¾ç½®CPUä¼˜å…ˆçº§æƒé‡
docker run -d \
  --cpu-shares=512 \
  low_priority_app

docker run -d \
  --cpu-shares=1024 \
  high_priority_app
# è§£é‡Šï¼šé«˜ä¼˜å…ˆçº§åº”ç”¨è·å¾—2å€CPUæ—¶é—´
```

**ğŸ“Š CPUé™åˆ¶æ•ˆæœéªŒè¯**ï¼š
```bash
# æŸ¥çœ‹å®¹å™¨CPUä½¿ç”¨æƒ…å†µ
docker stats container_name

# è¯¦ç»†çš„CPUç»Ÿè®¡
docker exec container_name cat /sys/fs/cgroup/cpu/cpuacct.usage
```

### 7.3 å†…å­˜èµ„æºé™åˆ¶


**ğŸ§  å†…å­˜é™åˆ¶æœ€ä½³å®è·µ**ï¼š
```bash
# åŸºæœ¬å†…å­˜é™åˆ¶
docker run -d \
  --memory="256m" \
  --memory-swap="512m" \
  web_app

# ç¦ç”¨swapä½¿ç”¨ï¼ˆæ¨èï¼‰
docker run -d \
  --memory="256m" \
  --memory-swap="256m" \
  web_app
# memory-swap = memory è¡¨ç¤ºç¦ç”¨swap

# å†…å­˜é¢„ç•™ï¼ˆä¿è¯æœ€å°å¯ç”¨å†…å­˜ï¼‰
docker run -d \
  --memory="512m" \
  --memory-reservation="256m" \
  database_app
```

**ğŸ’¡ å†…å­˜é™åˆ¶è§„åˆ’æŒ‡å—**ï¼š

| åº”ç”¨ç±»å‹ | **æ¨èå†…å­˜é™åˆ¶** | **è¯´æ˜** |
|---------|-----------------|---------|
| ğŸŒ **é™æ€WebæœåŠ¡** | 64M - 128M | Nginxã€Apache |
| ğŸ”— **APIåº”ç”¨** | 256M - 512M | Node.jsã€Pythonåº”ç”¨ |
| ğŸ—„ï¸ **ç¼“å­˜æœåŠ¡** | 1G - 4G | Redisã€Memcached |
| ğŸ—ƒï¸ **æ•°æ®åº“** | 2G - 8G | MySQLã€PostgreSQL |
| âš™ï¸ **å¤§æ•°æ®å¤„ç†** | 4G - 16G | Sparkã€Hadoopç»„ä»¶ |

### 7.4 ç£ç›˜I/Oé™åˆ¶


**ğŸ’¿ ç£ç›˜é™åˆ¶é…ç½®**ï¼š
```bash
# é™åˆ¶ç£ç›˜è¯»å†™é€Ÿåº¦
docker run -d \
  --device-read-bps /dev/sda:50mb \
  --device-write-bps /dev/sda:10mb \
  heavy_io_app

# é™åˆ¶IOPSï¼ˆæ¯ç§’è¯»å†™æ¬¡æ•°ï¼‰
docker run -d \
  --device-read-iops /dev/sda:1000 \
  --device-write-iops /dev/sda:500 \
  database_app
```

**ğŸ“ å­˜å‚¨ç©ºé—´é™åˆ¶**ï¼š
```bash
# é™åˆ¶å®¹å™¨å¯å†™å±‚å¤§å°
docker run -d \
  --storage-opt size=1G \
  temp_processing_app

# ä½¿ç”¨å¤–éƒ¨å·é™åˆ¶ï¼ˆæ¨èï¼‰
docker run -d \
  -v limited_volume:/data \
  --tmpfs /tmp:size=100m \
  processing_app
```

---

## 8. ğŸ” å®‰å…¨æ‰«æå·¥å…·ä½¿ç”¨


### 8.1 é•œåƒæ¼æ´æ‰«æ


**ğŸ” ä¸ºä»€ä¹ˆéœ€è¦é•œåƒæ‰«æ**ï¼š
```
é•œåƒæ¼æ´æ¥æºï¼š

åŸºç¡€é•œåƒæ¼æ´ï¼š
ğŸ“¦ ubuntu:18.04 â†’ åŒ…å«å·²çŸ¥CVEæ¼æ´
ğŸ“¦ node:14 â†’ OpenSSLç‰ˆæœ¬è¿‡ä½
ğŸ“¦ python:3.8 â†’ åŒ…ç®¡ç†å™¨æœ‰å®‰å…¨é—®é¢˜

åº”ç”¨ä¾èµ–æ¼æ´ï¼š
ğŸ“š npmåŒ…å«æœ‰æ¼æ´çš„ä¾èµ–
ğŸ“š pipå®‰è£…äº†ä¸å®‰å…¨çš„åº“
ğŸ“š Mavenä¾èµ–å­˜åœ¨å®‰å…¨é—®é¢˜

é…ç½®å®‰å…¨é—®é¢˜ï¼š
âš™ï¸ ä½¿ç”¨rootç”¨æˆ·è¿è¡Œ
âš™ï¸ æš´éœ²ä¸å¿…è¦çš„ç«¯å£
âš™ï¸ åŒ…å«è°ƒè¯•å·¥å…·å’Œå¯†é’¥
```

### 8.2 å¸¸ç”¨æ‰«æå·¥å…·


**ğŸ› ï¸ Trivyæ‰«æå·¥å…·**ï¼š
```bash
# å®‰è£…Trivy
curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

# æ‰«ææœ¬åœ°é•œåƒ
trivy image nginx:latest

# æ‰«æå¹¶æ˜¾ç¤ºè¯¦ç»†æŠ¥å‘Š
trivy image --format table --severity HIGH,CRITICAL nginx:latest

# æ‰«æDockerfile
trivy config Dockerfile

# CI/CDé›†æˆæ‰«æ
trivy image --exit-code 1 --severity CRITICAL myapp:$BUILD_ID
```

**ğŸ”§ Clairæ‰«æé›†æˆ**ï¼š
```bash
# ä½¿ç”¨Dockerè¿è¡ŒClair
docker run -d \
  --name clair \
  -p 6060:6060 \
  -v clair_config:/config \
  quay.io/coreos/clair:latest

# æ‰«æé•œåƒ
clairctl analyze myapp:latest
clairctl report myapp:latest
```

### 8.3 è‡ªåŠ¨åŒ–æ‰«ææµç¨‹


**ğŸ”„ CI/CDç®¡é“é›†æˆ**ï¼š
```yaml
# GitLab CIç¤ºä¾‹
security_scan:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy image --exit-code 0 --severity HIGH,CRITICAL $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - trivy image --format template --template "@contrib/sarif.tpl" --output trivy-report.sarif $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  artifacts:
    reports:
      sast: trivy-report.sarif
  only:
    - master
    - merge_requests
```

**ğŸ“Š æ‰«æç»“æœå¤„ç†**ï¼š
```bash
#!/bin/bash
# æ‰«æç»“æœå¤„ç†è„šæœ¬

# æ‰§è¡Œæ‰«æ
trivy image --format json --output scan_result.json myapp:latest

# è§£æå…³é”®æŒ‡æ ‡
CRITICAL_COUNT=$(jq '.Results[].Vulnerabilities[]|select(.Severity=="CRITICAL")|.Severity' scan_result.json | wc -l)
HIGH_COUNT=$(jq '.Results[].Vulnerabilities[]|select(.Severity=="HIGH")|.Severity' scan_result.json | wc -l)

# å®‰å…¨é—¨ç¦åˆ¤æ–­
if [ $CRITICAL_COUNT -gt 0 ]; then
    echo "âŒ å‘ç° $CRITICAL_COUNT ä¸ªä¸¥é‡æ¼æ´ï¼Œç¦æ­¢å‘å¸ƒ"
    exit 1
elif [ $HIGH_COUNT -gt 5 ]; then
    echo "âš ï¸  å‘ç° $HIGH_COUNT ä¸ªé«˜å±æ¼æ´ï¼Œéœ€è¦ä¿®å¤"
    exit 1
else
    echo "âœ… å®‰å…¨æ‰«æé€šè¿‡"
    exit 0
fi
```

### 8.4 è¿è¡Œæ—¶å®‰å…¨ç›‘æ§


**ğŸ“± Falcoè¿è¡Œæ—¶æ£€æµ‹**ï¼š
```yaml
# Falcoè§„åˆ™ç¤ºä¾‹
- rule: Shell in Container
  desc: åœ¨å®¹å™¨ä¸­æ£€æµ‹åˆ°shellæ´»åŠ¨
  condition: >
    spawned_process and container and
    shell_procs and proc.tty != 0
  output: >
    æ£€æµ‹åˆ°å®¹å™¨ä¸­çš„shellæ´»åŠ¨ (user=%user.name container_id=%container.id 
    container_name=%container.name shell=%proc.name parent=%proc.pname)
  priority: WARNING

- rule: Write Below Root
  desc: å‘æ ¹ç›®å½•å†™å…¥æ–‡ä»¶
  condition: >
    write and container and fd.typechar='f' and fd.num>=0 and fd.name startswith /
  output: >
    å®¹å™¨å‘æ ¹ç›®å½•å†™å…¥æ–‡ä»¶ (user=%user.name container_id=%container.id 
    file=%fd.name)
  priority: ERROR
```

---

## 9. ğŸƒ å®¹å™¨è¿è¡Œæ—¶å®‰å…¨


### 9.1 å®¹å™¨è¿è¡Œæ—¶æ¦‚è¿°


**ä»€ä¹ˆæ˜¯å®¹å™¨è¿è¡Œæ—¶**ï¼š
```
å®¹å™¨æŠ€æœ¯æ ˆï¼š

Docker CLI/API
     â†“ (è°ƒç”¨)
containerd (å®¹å™¨ç®¡ç†å™¨)  
     â†“ (è°ƒç”¨)
runc (å®¹å™¨è¿è¡Œæ—¶)
     â†“ (åˆ›å»º)
Linuxå®¹å™¨ (namespaces + cgroups)
```

> ğŸ“Œ **æ ¸å¿ƒæ¦‚å¿µ**  
> å®¹å™¨è¿è¡Œæ—¶å°±åƒæ“ä½œç³»ç»Ÿçš„"ä¿å§†"ï¼šè´Ÿè´£åˆ›å»ºã€ç®¡ç†å’Œç›‘æ§å®¹å™¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚

### 9.2 å®‰å…¨å®¹å™¨è¿è¡Œæ—¶


**ğŸ”’ gVisorå®‰å…¨æ²™ç®±**ï¼š
```bash
# å®‰è£…gVisorè¿è¡Œæ—¶
curl -fsSL https://gvisor.dev/archive.key | sudo apt-key add -
echo "deb https://storage.googleapis.com/gvisor/releases release main" | sudo tee /etc/apt/sources.list.d/gvisor.list
sudo apt-get update && sudo apt-get install -y runsc

# é…ç½®Dockerä½¿ç”¨gVisor
sudo vi /etc/docker/daemon.json
{
  "runtimes": {
    "runsc": {
      "path": "/usr/bin/runsc"
    }
  }
}

# ä½¿ç”¨å®‰å…¨è¿è¡Œæ—¶å¯åŠ¨å®¹å™¨
docker run --runtime=runsc -d nginx:alpine
```

**ğŸ›¡ï¸ Kata Containersè½»é‡è™šæ‹ŸåŒ–**ï¼š
```bash
# å®‰è£…Kata Containers
sudo sh -c "echo 'deb http://download.opensuse.org/repositories/home:/katacontainers:/releases:/$(arch):/stable-2.0/xUbuntu_$(lsb_release -rs)/ /' > /etc/apt/sources.list.d/kata-containers.list"
curl -sL  http://download.opensuse.org/repositories/home:/katacontainers:/releases:/$(arch):/stable-2.0/xUbuntu_$(lsb_release -rs)/Release.key | sudo apt-key add -
sudo apt-get update && sudo apt-get install -y kata-runtime

# ä½¿ç”¨Kataè¿è¡Œæ—¶
docker run --runtime=kata-runtime -d suspicious_app:latest
```

### 9.3 è¿è¡Œæ—¶å®‰å…¨ç­–ç•¥


**ğŸš¦ AppArmorå®‰å…¨é…ç½®**ï¼š
```bash
# æŸ¥çœ‹AppArmorçŠ¶æ€
sudo aa-status

# ä¸ºå®¹å™¨åˆ›å»ºAppArmoré…ç½®æ–‡ä»¶
sudo vi /etc/apparmor.d/docker-nginx
```

```apparmor
#include <tunables/global>
profile docker-nginx flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  
  # å…è®¸çš„ç½‘ç»œè®¿é—®
  network inet tcp,
  network inet udp,
  
  # å…è®¸çš„æ–‡ä»¶è®¿é—®
  /usr/share/nginx/html/** r,
  /var/log/nginx/** w,
  /tmp/** rw,
  
  # ç¦æ­¢çš„ç³»ç»Ÿè°ƒç”¨
  deny /proc/sys/** w,
  deny /sys/** w,
  deny mount,
  deny umount,
  
  # ç¦æ­¢æ‰§è¡Œshell
  deny /bin/bash x,
  deny /bin/sh x,
}
```

```bash
# åŠ è½½é…ç½®æ–‡ä»¶
sudo apparmor_parser -r /etc/apparmor.d/docker-nginx

# ä½¿ç”¨AppArmorè¿è¡Œå®¹å™¨
docker run -d \
  --security-opt apparmor=docker-nginx \
  nginx:alpine
```

### 9.4 è¿è¡Œæ—¶ç›‘æ§ä¸å“åº”


**ğŸ“Š å®æ—¶å¨èƒæ£€æµ‹**ï¼š
```bash
# å®‰è£…è¿è¡Œæ—¶å®‰å…¨ç›‘æ§
docker run -d \
  --name falco \
  --privileged \
  -v /var/run/docker.sock:/host/var/run/docker.sock \
  -v /dev:/host/dev \
  -v /proc:/host/proc:ro \
  -v /boot:/host/boot:ro \
  -v /lib/modules:/host/lib/modules:ro \
  -v /usr:/host/usr:ro \
  falcosecurity/falco:latest

# æŸ¥çœ‹å®‰å…¨äº‹ä»¶
docker logs falco
```

**ğŸš¨ è‡ªåŠ¨å“åº”æœºåˆ¶**ï¼š
```bash
#!/bin/bash
# å®‰å…¨äº‹ä»¶è‡ªåŠ¨å“åº”è„šæœ¬

# ç›‘æ§Falcoæ—¥å¿—
tail -f /var/log/falco.log | while read line; do
    if echo "$line" | grep -q "Shell in Container"; then
        CONTAINER_ID=$(echo "$line" | grep -o 'container_id=[^ ]*' | cut -d= -f2)
        echo "ğŸš¨ æ£€æµ‹åˆ°å®¹å™¨ $CONTAINER_ID ä¸­çš„å¯ç–‘shellæ´»åŠ¨"
        
        # è‡ªåŠ¨éš”ç¦»å®¹å™¨
        docker network disconnect bridge $CONTAINER_ID
        
        # å‘é€å‘Šè­¦
        curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"å®‰å…¨å‘Šè­¦ï¼šå®¹å™¨'$CONTAINER_ID'æ£€æµ‹åˆ°å¯ç–‘æ´»åŠ¨ï¼Œå·²è‡ªåŠ¨éš”ç¦»"}' \
          $SLACK_WEBHOOK_URL
          
        # ä¿å­˜å®¹å™¨çŠ¶æ€ä¾›åç»­åˆ†æ
        docker logs $CONTAINER_ID > /tmp/security_incident_$CONTAINER_ID.log
    fi
done
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„å®‰å…¨åŸºç¡€


```
ğŸ”¸ å®¹å™¨å®‰å…¨æœ¬è´¨ï¼šå¤šå±‚é˜²æŠ¤ï¼Œæ·±åº¦é˜²å¾¡ç­–ç•¥
ğŸ”¸ æœ€å°æƒé™åŸåˆ™ï¼šåªç»™å¿…éœ€çš„æƒé™ï¼Œèƒ½åŠ›ç»†åŒ–æ§åˆ¶  
ğŸ”¸ ç”¨æˆ·æƒé™ç®¡ç†ï¼šérootè¿è¡Œï¼Œä¸“ç”¨ç”¨æˆ·éš”ç¦»
ğŸ”¸ æ–‡ä»¶ç³»ç»Ÿå®‰å…¨ï¼šåªè¯»æ ¹ç›®å½•ï¼Œæ•æ„Ÿç›®å½•ä¿æŠ¤
ğŸ”¸ å¯†é’¥ç®¡ç†ç­–ç•¥ï¼šå¤–éƒ¨åŒ–å­˜å‚¨ï¼ŒåŠ¨æ€è·å–æœºåˆ¶
ğŸ”¸ ç½‘ç»œéš”ç¦»é˜²æŠ¤ï¼šè‡ªå®šä¹‰ç½‘ç»œï¼Œè®¿é—®æ§åˆ¶è§„åˆ™
ğŸ”¸ èµ„æºé™åˆ¶æ§åˆ¶ï¼šCPU/å†…å­˜/ç£ç›˜åˆç†é™åˆ¶
ğŸ”¸ å®‰å…¨æ‰«ææ£€æµ‹ï¼šé•œåƒæ‰«æï¼Œè¿è¡Œæ—¶ç›‘æ§
```

### 10.2 å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•


**âœ… é•œåƒå®‰å…¨æ£€æŸ¥**ï¼š
- [ ] ä½¿ç”¨å®˜æ–¹æˆ–å¯ä¿¡çš„åŸºç¡€é•œåƒ
- [ ] å®šæœŸæ›´æ–°åŸºç¡€é•œåƒç‰ˆæœ¬  
- [ ] æ‰«æé•œåƒæ¼æ´å¹¶åŠæ—¶ä¿®å¤
- [ ] ç§»é™¤ä¸å¿…è¦çš„å·¥å…·å’ŒåŒ…
- [ ] ä¸åœ¨é•œåƒä¸­åŒ…å«æ•æ„Ÿä¿¡æ¯

**âœ… è¿è¡Œæ—¶å®‰å…¨æ£€æŸ¥**ï¼š
- [ ] ä½¿ç”¨érootç”¨æˆ·è¿è¡Œå®¹å™¨
- [ ] å¯ç”¨åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
- [ ] é…ç½®é€‚å½“çš„Linuxèƒ½åŠ›é™åˆ¶
- [ ] è®¾ç½®åˆç†çš„èµ„æºä½¿ç”¨é™åˆ¶
- [ ] ä½¿ç”¨è‡ªå®šä¹‰ç½‘ç»œè¿›è¡Œéš”ç¦»

**âœ… ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥**ï¼š
- [ ] å¯ç”¨å®¹å™¨æ—¥å¿—æ”¶é›†å’Œç›‘æ§
- [ ] é…ç½®å®‰å…¨ç­–ç•¥å’Œè®¿é—®æ§åˆ¶
- [ ] å»ºç«‹åº”æ€¥å“åº”å’Œäº‹ä»¶å¤„ç†æµç¨‹
- [ ] å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡å’Œæ¸—é€æµ‹è¯•
- [ ] ä¿æŒå®‰å…¨å·¥å…·å’Œç­–ç•¥çš„æ›´æ–°

### 10.3 å¸¸è§å®‰å…¨è¯¯åŒºé¿å…


**âŒ é”™è¯¯åšæ³• vs âœ… æ­£ç¡®åšæ³•**ï¼š

```
æƒé™ç®¡ç†ï¼š
âŒ æ‰€æœ‰å®¹å™¨éƒ½ç”¨rootè¿è¡Œ "ç®€å•æ–¹ä¾¿"
âœ… ä¸ºæ¯ä¸ªåº”ç”¨åˆ›å»ºä¸“ç”¨ç”¨æˆ· "å®‰å…¨éš”ç¦»"

å¯†é’¥ç®¡ç†ï¼š
âŒ å¯†ç å†™åœ¨Dockerfileä¸­ "éƒ¨ç½²ç®€å•"  
âœ… ä½¿ç”¨å¤–éƒ¨å¯†é’¥ç®¡ç†ç³»ç»Ÿ "åŠ¨æ€å®‰å…¨"

ç½‘ç»œé…ç½®ï¼š
âŒ æ‰€æœ‰å®¹å™¨ä½¿ç”¨é»˜è®¤ç½‘ç»œ "é…ç½®ç®€å•"
âœ… æŒ‰åŠŸèƒ½åˆ’åˆ†ç½‘ç»œéš”ç¦» "æœ€å°æš´éœ²"

èµ„æºæ§åˆ¶ï¼š
âŒ ä¸è®¾ç½®ä»»ä½•èµ„æºé™åˆ¶ "æ€§èƒ½æœ€å¤§åŒ–"
âœ… æ ¹æ®åº”ç”¨éœ€æ±‚åˆç†é™åˆ¶ "ç¨³å®šå¯é "
```

### 10.4 ä¼ä¸šçº§å®‰å…¨å®è·µè·¯çº¿


**ğŸ“ˆ å®‰å…¨æˆç†Ÿåº¦å‘å±•è·¯å¾„**ï¼š

```
ğŸŒ± åˆçº§é˜¶æ®µï¼ˆåŸºç¡€å®‰å…¨ï¼‰ï¼š
â”œâ”€â”€ ä½¿ç”¨érootç”¨æˆ·
â”œâ”€â”€ åŸºæœ¬èµ„æºé™åˆ¶  
â”œâ”€â”€ ç®€å•ç½‘ç»œéš”ç¦»
â””â”€â”€ å®šæœŸé•œåƒæ›´æ–°

ğŸŒ¿ ä¸­çº§é˜¶æ®µï¼ˆè§„èŒƒåŒ–ï¼‰ï¼š
â”œâ”€â”€ è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æ
â”œâ”€â”€ ç»Ÿä¸€å¯†é’¥ç®¡ç†
â”œâ”€â”€ ç½‘ç»œç­–ç•¥è§„åˆ’
â””â”€â”€ å®‰å…¨ç›‘æ§å‘Šè­¦

ğŸŒ³ é«˜çº§é˜¶æ®µï¼ˆä½“ç³»åŒ–ï¼‰ï¼š
â”œâ”€â”€ é›¶ä¿¡ä»»ç½‘ç»œæ¶æ„
â”œâ”€â”€ è¿è¡Œæ—¶å¨èƒæ£€æµ‹  
â”œâ”€â”€ è‡ªåŠ¨å®‰å…¨å“åº”
â””â”€â”€ åˆè§„å®¡è®¡ä½“ç³»
```

**ğŸ¯ å®‰å…¨æŠ•å…¥ä¼˜å…ˆçº§**ï¼š
1. **é«˜ä¼˜å…ˆçº§**ï¼šç”¨æˆ·æƒé™ã€å¯†é’¥ç®¡ç†ã€ç½‘ç»œéš”ç¦»
2. **ä¸­ä¼˜å…ˆçº§**ï¼šé•œåƒæ‰«æã€èµ„æºé™åˆ¶ã€ç›‘æ§å‘Šè­¦
3. **ä½ä¼˜å…ˆçº§**ï¼šé«˜çº§è¿è¡Œæ—¶ã€é›¶ä¿¡ä»»æ¶æ„

> ğŸ’¡ **è®°å¿†å£è¯€**  
> å®¹å™¨å®‰å…¨è®°å¿ƒé—´ï¼šæƒé™æœ€å°è«å·æ‡’ï¼Œå¯†é’¥ç®¡ç†è¦å¤–åŒ–ï¼Œç½‘ç»œéš”ç¦»é˜²æ”»å‡»ï¼Œ  
> èµ„æºé™åˆ¶ä¿ç¨³å®šï¼Œæ‰«æç›‘æ§ä¸å¯å°‘ï¼Œè¿è¡Œå®‰å…¨é å¤§å®¶ï¼

**å®è·µå»ºè®®**ï¼š
- ä»åŸºç¡€å®‰å…¨é…ç½®å¼€å§‹ï¼Œé€æ­¥å®Œå–„
- å»ºç«‹å®‰å…¨è§„èŒƒå’Œæ“ä½œæ‰‹å†Œ
- å®šæœŸè¿›è¡Œå®‰å…¨åŸ¹è®­å’Œæ¼”ç»ƒ
- æŒç»­å…³æ³¨å®‰å…¨å¨èƒå’Œæœ€ä½³å®è·µæ›´æ–°