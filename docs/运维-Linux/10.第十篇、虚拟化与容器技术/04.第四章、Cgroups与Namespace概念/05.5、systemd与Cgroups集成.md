---
title: 5ã€systemdä¸Cgroupsé›†æˆ
---
## ğŸ“š ç›®å½•

1. [systemdç»Ÿä¸€cgroupsç®¡ç†æœºåˆ¶](#1-systemdç»Ÿä¸€cgroupsç®¡ç†æœºåˆ¶)
2. [serviceå•å…ƒèµ„æºé™åˆ¶é…ç½®](#2-serviceå•å…ƒèµ„æºé™åˆ¶é…ç½®)
3. [CPUQuotaä¸MemoryLimitå‚æ•°è¯¦è§£](#3-CPUQuotaä¸MemoryLimitå‚æ•°è¯¦è§£)
4. [systemctlåŠ¨æ€èµ„æºè°ƒæ•´](#4-systemctlåŠ¨æ€èµ„æºè°ƒæ•´)
5. [systemd sliceæ¦‚å¿µä¸åº”ç”¨](#5-systemd-sliceæ¦‚å¿µä¸åº”ç”¨)
6. [user sliceä¸sessionç®¡ç†](#6-usersliceä¸sessionç®¡ç†)
7. [systemd-runä¸´æ—¶æœåŠ¡åˆ›å»º](#7-systemd-runä¸´æ—¶æœåŠ¡åˆ›å»º)
8. [cgroups v2åœ¨systemdä¸­çš„åº”ç”¨](#8-cgroupsv2åœ¨systemdä¸­çš„åº”ç”¨)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ systemdç»Ÿä¸€cgroupsç®¡ç†æœºåˆ¶


### 1.1 systemdä¸cgroupsçš„å…³ç³»


**ğŸ”¸ ä»€ä¹ˆæ˜¯systemdçš„cgroupsç®¡ç†**
systemdæ˜¯ç°ä»£Linuxç³»ç»Ÿçš„åˆå§‹åŒ–ç³»ç»Ÿï¼Œå®ƒæŠŠcgroupsæŠ€æœ¯å®Œå…¨é›†æˆåˆ°è‡ªå·±çš„æœåŠ¡ç®¡ç†ä½“ç³»ä¸­ã€‚ç®€å•æ¥è¯´ï¼Œsystemdå°±åƒä¸€ä¸ª**èµ„æºç®¡ç†å‘˜**ï¼Œå®ƒä¸ºæ¯ä¸ªæœåŠ¡è‡ªåŠ¨åˆ›å»ºå’Œç®¡ç†cgroupsï¼Œè®©æˆ‘ä»¬ä¸éœ€è¦æ‰‹åŠ¨å»æ“ä½œå¤æ‚çš„cgroupsæ–‡ä»¶ç³»ç»Ÿã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼šæ‰‹åŠ¨ç®¡ç†cgroups
å¼€å‘è€… â†’ æ‰‹åŠ¨åˆ›å»º/proc/cgroupç›®å½• â†’ æ‰‹åŠ¨å†™å…¥é™åˆ¶ â†’ ç®¡ç†è¿›ç¨‹

systemdæ–¹å¼ï¼šè‡ªåŠ¨åŒ–ç®¡ç†
å¼€å‘è€… â†’ é…ç½®systemdæœåŠ¡ â†’ systemdè‡ªåŠ¨åˆ›å»ºcgroups â†’ è‡ªåŠ¨åº”ç”¨é™åˆ¶
```

### 1.2 systemd cgroupså±‚çº§ç»“æ„


**ğŸ“Š systemdçš„å±‚çº§ç®¡ç†**
```
ç³»ç»Ÿæ ¹cgroup
â”œâ”€â”€ system.slice          â† ç³»ç»ŸæœåŠ¡
â”‚   â”œâ”€â”€ ssh.service
â”‚   â”œâ”€â”€ nginx.service
â”‚   â””â”€â”€ mysql.service
â”œâ”€â”€ user.slice             â† ç”¨æˆ·æœåŠ¡  
â”‚   â”œâ”€â”€ user-1000.slice    â† ç”¨æˆ·ID 1000
â”‚   â””â”€â”€ user-1001.slice    â† ç”¨æˆ·ID 1001
â””â”€â”€ machine.slice          â† è™šæ‹Ÿæœº/å®¹å™¨
    â”œâ”€â”€ docker-xxx.scope
    â””â”€â”€ libvirt-xxx.scope
```

**ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µè§£é‡Š**ï¼š
- **sliceï¼ˆç‰‡æ®µï¼‰**ï¼šå°±åƒæ˜¯ä¸€ä¸ª**èµ„æºæ± **ï¼ŒæŠŠç›¸å…³çš„æœåŠ¡ç»„ç»‡åœ¨ä¸€èµ·
- **serviceï¼ˆæœåŠ¡ï¼‰**ï¼šå…·ä½“çš„åº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚nginxã€mysql
- **scopeï¼ˆèŒƒå›´ï¼‰**ï¼šå¤–éƒ¨å¯åŠ¨çš„è¿›ç¨‹ç»„ï¼Œæ¯”å¦‚ç”¨æˆ·ç™»å½•session

### 1.3 systemdç®¡ç†ä¼˜åŠ¿


| ç®¡ç†æ–¹å¼ | **æ‰‹åŠ¨cgroups** | **systemdé›†æˆ** |
|---------|----------------|----------------|
| ğŸ› ï¸ **é…ç½®å¤æ‚åº¦** | é«˜ï¼Œéœ€è¦ç†è§£æ–‡ä»¶ç³»ç»Ÿ | ä½ï¼Œé…ç½®æ–‡ä»¶å³å¯ |
| ğŸ”„ **æŒä¹…åŒ–** | éœ€æ‰‹åŠ¨å¤„ç† | è‡ªåŠ¨æŒä¹…åŒ– |
| ğŸ“Š **ç›‘æ§** | éœ€è¦è‡ªå·±å®ç° | å†…ç½®çŠ¶æ€ç›‘æ§ |
| ğŸš€ **å¯åŠ¨ç®¡ç†** | åˆ†ç¦»çš„ | ç»Ÿä¸€ç®¡ç† |
| ğŸ”§ **åŠ¨æ€è°ƒæ•´** | å¤æ‚ | ç®€å•å‘½ä»¤ |

**ğŸ’¡ å®é™…æ„ä¹‰**ï¼š
ä½¿ç”¨systemdç®¡ç†cgroupså°±åƒä½¿ç”¨**è‡ªåŠ¨æŒ¡æ±½è½¦**ï¼Œæˆ‘ä»¬åªéœ€è¦å‘Šè¯‰å®ƒ"é™åˆ¶CPUåˆ°50%"ï¼Œå®ƒå°±ä¼šè‡ªåŠ¨å¤„ç†æ‰€æœ‰åº•å±‚ç»†èŠ‚ã€‚

---

## 2. âš™ï¸ serviceå•å…ƒèµ„æºé™åˆ¶é…ç½®


### 2.1 serviceæ–‡ä»¶åŸºæœ¬ç»“æ„


**ğŸ“‹ serviceæ–‡ä»¶ä½ç½®**
```bash
/etc/systemd/system/          # è‡ªå®šä¹‰æœåŠ¡é…ç½®
/lib/systemd/system/          # ç³»ç»Ÿé»˜è®¤æœåŠ¡
/run/systemd/system/          # è¿è¡Œæ—¶ä¸´æ—¶é…ç½®
```

### 2.2 èµ„æºé™åˆ¶é…ç½®è¯­æ³•


**ğŸ”§ åŸºæœ¬é…ç½®æ ¼å¼**
```ini
[Unit]
Description=æˆ‘çš„WebæœåŠ¡
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/my-web-app
Restart=always

# ğŸ¯ èµ„æºé™åˆ¶é…ç½®éƒ¨åˆ†
CPUQuota=50%              # CPUé™åˆ¶ä¸º50%
MemoryHigh=500M           # å†…å­˜è½¯é™åˆ¶500MB
MemoryMax=1G              # å†…å­˜ç¡¬é™åˆ¶1GB
TasksMax=100              # æœ€å¤§ä»»åŠ¡æ•°100ä¸ª

[Install]
WantedBy=multi-user.target
```

### 2.3 å¸¸ç”¨èµ„æºé™åˆ¶å‚æ•°


**ğŸ“Š CPUç›¸å…³é™åˆ¶**
```ini
# CPUä½¿ç”¨ç‡é™åˆ¶
CPUQuota=50%                    # é™åˆ¶ä½¿ç”¨50%çš„CPU
CPUShares=1024                  # CPUæƒé‡(ç›¸å¯¹å€¼)

# CPUäº²å’Œæ€§
CPUAffinity=0 1                 # åªèƒ½åœ¨CPUæ ¸å¿ƒ0å’Œ1ä¸Šè¿è¡Œ
```

**ğŸ’¾ å†…å­˜ç›¸å…³é™åˆ¶**
```ini
# å†…å­˜é™åˆ¶
MemoryHigh=500M                 # è½¯é™åˆ¶ï¼šè¶…è¿‡æ—¶å¼€å§‹å›æ”¶
MemoryMax=1G                    # ç¡¬é™åˆ¶ï¼šè¶…è¿‡æ—¶æ€æ­»è¿›ç¨‹
MemorySwapMax=2G                # swapä½¿ç”¨é™åˆ¶
```

**ğŸ”¢ è¿›ç¨‹å’Œä»»åŠ¡é™åˆ¶**
```ini
# è¿›ç¨‹æ•°é™åˆ¶
TasksMax=50                     # æœ€å¤§ä»»åŠ¡æ•°
LimitNPROC=100                  # æœ€å¤§è¿›ç¨‹æ•°ï¼ˆä¼ ç»Ÿulimitï¼‰
```

### 2.4 é…ç½®ç¤ºä¾‹ï¼šWebæœåŠ¡é™åˆ¶


**ğŸ’¼ å®é™…åº”ç”¨åœºæ™¯**
å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªWebæœåŠ¡ï¼Œéœ€è¦é™åˆ¶å®ƒä¸èƒ½å ç”¨å¤ªå¤šç³»ç»Ÿèµ„æºï¼š

```ini
# /etc/systemd/system/my-webapp.service
[Unit]
Description=æˆ‘çš„Webåº”ç”¨
After=network.target
Wants=network-online.target

[Service]
Type=simple
User=webapp
Group=webapp
ExecStart=/opt/webapp/bin/server
WorkingDirectory=/opt/webapp
Restart=always
RestartSec=10

# ğŸ“Š èµ„æºé™åˆ¶é…ç½®
CPUQuota=30%              # æœ€å¤šä½¿ç”¨30%CPU
MemoryHigh=256M           # å†…å­˜è¶…è¿‡256Må¼€å§‹æ¸…ç†
MemoryMax=512M            # å†…å­˜ç»å¯¹ä¸èƒ½è¶…è¿‡512M
TasksMax=50               # æœ€å¤š50ä¸ªä»»åŠ¡

# ğŸ“ I/Oé™åˆ¶  
IOAccounting=true         # å¯ç”¨I/Oç»Ÿè®¡
IOWeight=100              # I/Oæƒé‡

[Install]
WantedBy=multi-user.target
```

**âœ… å¯ç”¨å’ŒéªŒè¯**
```bash
# é‡æ–°åŠ è½½systemdé…ç½®
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start my-webapp

# æ£€æŸ¥èµ„æºä½¿ç”¨æƒ…å†µ
systemctl status my-webapp
systemctl show my-webapp --property=CPUQuotaPerSecUSec
systemctl show my-webapp --property=MemoryHigh
```

---

## 3. ğŸ›ï¸ CPUQuotaä¸MemoryLimitå‚æ•°è¯¦è§£


### 3.1 CPUQuotaæ·±åº¦è§£æ


**ğŸ”¸ CPUQuotaå·¥ä½œåŸç†**
CPUQuotaæ§åˆ¶æœåŠ¡å¯ä»¥ä½¿ç”¨å¤šå°‘CPUèµ„æºï¼Œå®ƒåŸºäºLinuxå†…æ ¸çš„**CFSè°ƒåº¦å™¨**ï¼ˆå®Œå…¨å…¬å¹³è°ƒåº¦å™¨ï¼‰å·¥ä½œã€‚

```
å·¥ä½œæœºåˆ¶ï¼š
100msæ—¶é—´çª—å£å†…
â”œâ”€â”€ CPUQuota=50%  â†’ å¯ä»¥ä½¿ç”¨50ms CPUæ—¶é—´
â”œâ”€â”€ CPUQuota=100% â†’ å¯ä»¥ä½¿ç”¨100ms CPUæ—¶é—´  
â””â”€â”€ CPUQuota=200% â†’ å¯ä»¥ä½¿ç”¨200ms CPUæ—¶é—´ï¼ˆå¤šæ ¸ï¼‰
```

**â­â­â­ é‡è¦ç†è§£**ï¼š
- `CPUQuota=50%` ä¸æ˜¯è¯´åªèƒ½ç”¨ä¸€ä¸ªCPUæ ¸å¿ƒçš„50%
- è€Œæ˜¯è¯´åœ¨ä»»æ„100mså†…ï¼Œæœ€å¤šåªèƒ½ä½¿ç”¨50msçš„CPUæ—¶é—´
- åœ¨å¤šæ ¸ç³»ç»Ÿä¸Šï¼Œå¯ä»¥è·¨æ ¸å¿ƒä½¿ç”¨è¿™50ms

**ğŸ“ˆ å®é™…æµ‹è¯•ç¤ºä¾‹**
```bash
# åˆ›å»ºCPUå¯†é›†å‹ä»»åŠ¡
sudo systemd-run --unit=cpu-test --slice=test \
  --property=CPUQuota=25% \
  /bin/bash -c 'while true; do :; done'

# æŸ¥çœ‹CPUä½¿ç”¨ç‡
htop  # å¯ä»¥çœ‹åˆ°è¿›ç¨‹CPUä½¿ç”¨ç‡è¢«é™åˆ¶åœ¨25%å·¦å³
```

### 3.2 CPUQuotaé…ç½®æŠ€å·§


**ğŸ¯ ä¸åŒåœºæ™¯çš„é…ç½®å»ºè®®**ï¼š

| åº”ç”¨ç±»å‹ | **æ¨èCPUQuota** | **è¯´æ˜** |
|---------|------------------|----------|
| ğŸŒ **WebæœåŠ¡å™¨** | 50-80% | éœ€è¦å“åº”ç”¨æˆ·è¯·æ±‚ |
| ğŸ“Š **æ•°æ®åº“** | 60-90% | CPUå¯†é›†ï¼Œä½†è¦ç•™ä½™é‡ |
| ğŸ”„ **å¤‡ä»½ä»»åŠ¡** | 20-30% | åå°ä»»åŠ¡ï¼Œä¸å½±å“ä¸»ä¸šåŠ¡ |
| ğŸ® **æ¸¸æˆæœåŠ¡å™¨** | 80-100% | éœ€è¦ä½å»¶è¿Ÿ |

### 3.3 MemoryLimitå‚æ•°è¯¦è§£


**ğŸ§  å†…å­˜é™åˆ¶çš„ä¸¤ä¸ªå±‚æ¬¡**
systemdæä¾›äº†ä¸¤ç§å†…å­˜é™åˆ¶æœºåˆ¶ï¼Œå°±åƒæ±½è½¦çš„**è½¯åˆ¹è½¦**å’Œ**ç¡¬åˆ¹è½¦**ï¼š

```
å†…å­˜ä½¿ç”¨è¿‡ç¨‹ï¼š
æ­£å¸¸è¿è¡Œ â†’ MemoryHigh(è½¯é™åˆ¶) â†’ å¼€å§‹å›æ”¶å†…å­˜ â†’ MemoryMax(ç¡¬é™åˆ¶) â†’ æ€æ­»è¿›ç¨‹
    â†“              â†“                    â†“                â†“
  æ— å½±å“          è½»å¾®å½±å“              æ€§èƒ½ä¸‹é™         æœåŠ¡ä¸­æ–­
```

**ğŸ“Š MemoryHigh vs MemoryMax**

| å‚æ•° | **ä½œç”¨æœºåˆ¶** | **è§¦å‘åæœ** | **é€‚ç”¨åœºæ™¯** |
|------|------------|-------------|-------------|
| **MemoryHigh** | è½¯é™åˆ¶ï¼Œè§¦å‘å†…å­˜å›æ”¶ | æ€§èƒ½å˜æ…¢ | é¢„è­¦æœºåˆ¶ |
| **MemoryMax** | ç¡¬é™åˆ¶ï¼Œæ€æ­»è¿›ç¨‹ | æœåŠ¡ä¸­æ–­ | ä¿æŠ¤ç³»ç»Ÿ |

### 3.4 å†…å­˜é™åˆ¶é…ç½®å®è·µ


**ğŸ’¡ æ¨èé…ç½®æ¨¡å¼**
```ini
# æ¸è¿›å¼å†…å­˜é™åˆ¶
MemoryHigh=400M        # è½¯é™åˆ¶ï¼šå¼€å§‹å†…å­˜å›æ”¶
MemoryMax=512M         # ç¡¬é™åˆ¶ï¼šæ¯”è½¯é™åˆ¶é«˜20-30%
MemorySwapMax=0        # ç¦ç”¨swapï¼ˆå¯é€‰ï¼‰
```

**âš ï¸ å¸¸è§é…ç½®è¯¯åŒº**ï¼š
âŒ **é”™è¯¯**ï¼šåªè®¾ç½®MemoryMaxï¼Œä¸è®¾ç½®MemoryHigh
```ini
MemoryMax=1G  # å®¹æ˜“çªç„¶è¢«æ€æ­»
```

âœ… **æ­£ç¡®**ï¼šè®¾ç½®æ¸è¿›å¼é™åˆ¶
```ini
MemoryHigh=800M  # æå‰é¢„è­¦
MemoryMax=1G     # ä¿æŠ¤åº•çº¿
```

**ğŸ” ç›‘æ§å†…å­˜ä½¿ç”¨**
```bash
# æŸ¥çœ‹æœåŠ¡å†…å­˜ä½¿ç”¨æƒ…å†µ
systemctl status my-webapp
systemctl show my-webapp --property=MemoryCurrent
systemctl show my-webapp --property=MemoryHigh
systemctl show my-webapp --property=MemoryMax

# å®æ—¶ç›‘æ§
watch -n 1 'systemctl show my-webapp --property=MemoryCurrent'
```

---

## 4. ğŸ›ï¸ systemctlåŠ¨æ€èµ„æºè°ƒæ•´


### 4.1 systemctl set-propertyå‘½ä»¤


**ğŸ”¸ åŠ¨æ€è°ƒæ•´çš„å«ä¹‰**
`systemctl set-property` å‘½ä»¤å¯ä»¥åœ¨**æœåŠ¡è¿è¡Œæ—¶**ä¿®æ”¹èµ„æºé™åˆ¶ï¼Œä¸éœ€è¦é‡å¯æœåŠ¡ã€‚å°±åƒç»™æ­£åœ¨è¡Œé©¶çš„æ±½è½¦è°ƒæ•´**å·¡èˆªå®šé€Ÿ**ä¸€æ ·ã€‚

**åŸºæœ¬è¯­æ³•**ï¼š
```bash
systemctl set-property [æœåŠ¡å] [å‚æ•°]=[å€¼]
```

### 4.2 å¸¸ç”¨åŠ¨æ€è°ƒæ•´æ“ä½œ


**âš¡ CPUé™åˆ¶åŠ¨æ€è°ƒæ•´**
```bash
# å°†nginxæœåŠ¡çš„CPUé™åˆ¶è°ƒæ•´ä¸º30%
sudo systemctl set-property nginx.service CPUQuota=30%

# è°ƒæ•´CPUæƒé‡
sudo systemctl set-property nginx.service CPUShares=2048

# éªŒè¯ä¿®æ”¹ç»“æœ
systemctl show nginx.service --property=CPUQuotaPerSecUSec
```

**ğŸ’¾ å†…å­˜é™åˆ¶åŠ¨æ€è°ƒæ•´**
```bash
# è°ƒæ•´å†…å­˜è½¯é™åˆ¶
sudo systemctl set-property mysql.service MemoryHigh=1G

# è°ƒæ•´å†…å­˜ç¡¬é™åˆ¶
sudo systemctl set-property mysql.service MemoryMax=2G

# æŸ¥çœ‹å½“å‰å†…å­˜ä½¿ç”¨
systemctl status mysql.service
```

### 4.3 ä¸´æ—¶ vs æ°¸ä¹…ä¿®æ”¹


**ğŸ“ ä¿®æ”¹ç±»å‹å¯¹æ¯”**

| ä¿®æ”¹æ–¹å¼ | **å‘½ä»¤é€‰é¡¹** | **ç”Ÿæ•ˆèŒƒå›´** | **é‡å¯å** |
|---------|------------|-------------|-----------|
| ğŸ• **ä¸´æ—¶ä¿®æ”¹** | `--runtime` | å½“å‰è¿è¡Œæ—¶ | æ¢å¤åŸé…ç½® |
| ğŸ’¾ **æ°¸ä¹…ä¿®æ”¹** | é»˜è®¤è¡Œä¸º | æŒä¹…ä¿å­˜ | ä¿æŒä¿®æ”¹ |

**å®é™…ä½¿ç”¨ç¤ºä¾‹**ï¼š
```bash
# ä¸´æ—¶è°ƒæ•´ï¼ˆé‡å¯åæ¢å¤ï¼‰
sudo systemctl set-property --runtime nginx.service CPUQuota=50%

# æ°¸ä¹…è°ƒæ•´ï¼ˆé‡å¯åä¿æŒï¼‰
sudo systemctl set-property nginx.service CPUQuota=50%
```

### 4.4 æ‰¹é‡èµ„æºè°ƒæ•´


**ğŸ”„ æ‰¹é‡è°ƒæ•´å¤šä¸ªæœåŠ¡**
```bash
#!/bin/bash
# ä¸ºæ‰€æœ‰WebæœåŠ¡ç»Ÿä¸€è°ƒæ•´èµ„æºé™åˆ¶

services=("nginx" "apache2" "php-fpm")

for service in "${services[@]}"; do
    echo "è°ƒæ•´ $service èµ„æºé™åˆ¶..."
    sudo systemctl set-property $service.service CPUQuota=40%
    sudo systemctl set-property $service.service MemoryHigh=512M
    echo "$service è°ƒæ•´å®Œæˆ"
done
```

**ğŸ“Š éªŒè¯æ‰¹é‡ä¿®æ”¹ç»“æœ**
```bash
# æŸ¥çœ‹å¤šä¸ªæœåŠ¡çš„èµ„æºé…ç½®
for service in nginx apache2 php-fpm; do
    echo "=== $service ==="
    systemctl show $service --property=CPUQuotaPerSecUSec,MemoryHigh
done
```

---

## 5. ğŸ—ï¸ systemd sliceæ¦‚å¿µä¸åº”ç”¨


### 5.1 sliceæ¦‚å¿µæ·±åº¦ç†è§£


**ğŸ”¸ ä»€ä¹ˆæ˜¯slice**
sliceæ˜¯systemdä¸­çš„**èµ„æºåˆ†ç»„æ¦‚å¿µ**ï¼Œå¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ª**èµ„æºæ± **ã€‚å°±åƒå…¬å¸é‡Œçš„ä¸åŒéƒ¨é—¨ï¼Œæ¯ä¸ªéƒ¨é—¨æœ‰è‡ªå·±çš„é¢„ç®—ï¼ˆèµ„æºé™åˆ¶ï¼‰ï¼Œéƒ¨é—¨å†…çš„å‘˜å·¥ï¼ˆæœåŠ¡ï¼‰å…±äº«è¿™ä¸ªé¢„ç®—ã€‚

```
å…¬å¸ç»„ç»‡ç»“æ„ç±»æ¯”ï¼š
å…¬å¸æ€»èµ„æº
â”œâ”€â”€ æŠ€æœ¯éƒ¨é—¨.sliceï¼ˆåˆ†é…40%èµ„æºï¼‰
â”‚   â”œâ”€â”€ webæœåŠ¡.service
â”‚   â”œâ”€â”€ æ•°æ®åº“.service  
â”‚   â””â”€â”€ ç¼“å­˜.service
â”œâ”€â”€ è¿è¥éƒ¨é—¨.sliceï¼ˆåˆ†é…30%èµ„æºï¼‰
â”‚   â”œâ”€â”€ ç›‘æ§.service
â”‚   â””â”€â”€ æ—¥å¿—.service
â””â”€â”€ ä¸´æ—¶é¡¹ç›®.sliceï¼ˆåˆ†é…30%èµ„æºï¼‰
```

### 5.2 ç³»ç»Ÿé»˜è®¤sliceç»“æ„


**ğŸ“Š systemdé»˜è®¤sliceå±‚çº§**
```
-.slice (æ ¹slice)
â”œâ”€â”€ system.slice          # ç³»ç»ŸæœåŠ¡
â”œâ”€â”€ user.slice           # ç”¨æˆ·æœåŠ¡
â””â”€â”€ machine.slice        # è™šæ‹Ÿæœºå’Œå®¹å™¨
```

**ğŸ” æŸ¥çœ‹å½“å‰sliceç»“æ„**
```bash
# æŸ¥çœ‹æ‰€æœ‰slice
systemctl list-units --type=slice

# ä»¥æ ‘å½¢ç»“æ„æ˜¾ç¤º
systemd-cgls

# æŸ¥çœ‹ç‰¹å®šsliceçš„æœåŠ¡
systemctl status system.slice
```

### 5.3 åˆ›å»ºè‡ªå®šä¹‰slice


**ğŸ› ï¸ åˆ›å»ºWebåº”ç”¨ä¸“ç”¨slice**
```bash
# åˆ›å»ºsliceé…ç½®æ–‡ä»¶
sudo mkdir -p /etc/systemd/system
sudo tee /etc/systemd/system/webapp.slice << EOF
[Unit]
Description=Webåº”ç”¨èµ„æºæ± 
Before=slices.target

[Slice]
# ä¸ºWebåº”ç”¨åˆ†é…30%çš„ç³»ç»ŸCPU
CPUQuota=30%
# æ€»å†…å­˜é™åˆ¶2GB
MemoryHigh=1.5G
MemoryMax=2G
EOF

# é‡æ–°åŠ è½½é…ç½®
sudo systemctl daemon-reload

# å¯åŠ¨slice
sudo systemctl start webapp.slice
```

### 5.4 å°†æœåŠ¡åˆ†é…åˆ°slice


**ğŸ“¦ æ–¹æ³•1ï¼šä¿®æ”¹serviceæ–‡ä»¶**
```ini
[Unit]
Description=æˆ‘çš„WebæœåŠ¡

[Service]
Type=simple
ExecStart=/usr/bin/my-webapp
Slice=webapp.slice        # ğŸ¯ æŒ‡å®šslice

[Install]
WantedBy=multi-user.target
```

**âš¡ æ–¹æ³•2ï¼šåŠ¨æ€åˆ†é…**
```bash
# å°†ç°æœ‰æœåŠ¡ç§»åŠ¨åˆ°æŒ‡å®šslice
sudo systemctl set-property nginx.service Slice=webapp.slice

# éªŒè¯åˆ†é…ç»“æœ
systemctl show nginx.service --property=Slice
```

### 5.5 sliceèµ„æºç®¡ç†å®è·µ


**ğŸ’¼ å®é™…åº”ç”¨ï¼šæœåŠ¡å™¨èµ„æºè§„åˆ’**
```bash
# åˆ›å»ºæ•°æ®åº“ä¸“ç”¨sliceï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
sudo tee /etc/systemd/system/database.slice << EOF
[Slice]
CPUQuota=60%
CPUShares=2048
MemoryHigh=4G
MemoryMax=6G
EOF

# åˆ›å»ºWebæœåŠ¡sliceï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
sudo tee /etc/systemd/system/webapp.slice << EOF
[Slice]
CPUQuota=30%
CPUShares=1024
MemoryHigh=2G
MemoryMax=3G
EOF

# åˆ›å»ºåå°ä»»åŠ¡sliceï¼ˆä½ä¼˜å…ˆçº§ï¼‰
sudo tee /etc/systemd/system/background.slice << EOF
[Slice]
CPUQuota=10%
CPUShares=512
MemoryHigh=512M
MemoryMax=1G
EOF
```

**ğŸ“Š ç›‘æ§sliceèµ„æºä½¿ç”¨**
```bash
# æŸ¥çœ‹sliceå±‚çº§å’Œèµ„æºä½¿ç”¨
systemd-cgtop

# æŸ¥çœ‹ç‰¹å®šsliceçŠ¶æ€
systemctl status webapp.slice

# æŸ¥çœ‹sliceå†…çš„æ‰€æœ‰æœåŠ¡
systemd-cgls webapp.slice
```

---

## 6. ğŸ‘¤ user sliceä¸sessionç®¡ç†


### 6.1 ç”¨æˆ·ä¼šè¯ç®¡ç†æœºåˆ¶


**ğŸ”¸ user sliceçš„ä½œç”¨**
å½“ç”¨æˆ·ç™»å½•ç³»ç»Ÿæ—¶ï¼Œsystemdä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºä¸€ä¸ª**ä¸“ç”¨çš„èµ„æºç©ºé—´**ï¼Œè¿™å°±æ˜¯user sliceã€‚å®ƒçš„å‘½åæ ¼å¼æ˜¯`user-[UID].slice`ã€‚

```
ç”¨æˆ·ç™»å½•è¿‡ç¨‹ï¼š
ç”¨æˆ·ç™»å½• â†’ systemdåˆ›å»ºuser-1000.slice â†’ ç”¨æˆ·çš„æ‰€æœ‰è¿›ç¨‹éƒ½åœ¨è¿™ä¸ªsliceå†…
```

**ğŸ“Š ç”¨æˆ·sliceç»“æ„**
```
user.slice
â”œâ”€â”€ user-1000.slice        # ç”¨æˆ·ID 1000çš„èµ„æºç©ºé—´
â”‚   â”œâ”€â”€ user@1000.service  # ç”¨æˆ·systemdå®ä¾‹
â”‚   â””â”€â”€ session-1.scope    # ç™»å½•ä¼šè¯
â”œâ”€â”€ user-1001.slice        # ç”¨æˆ·ID 1001çš„èµ„æºç©ºé—´
â”‚   â”œâ”€â”€ user@1001.service
â”‚   â””â”€â”€ session-2.scope
```

### 6.2 ç”¨æˆ·èµ„æºé™åˆ¶é…ç½®


**âš™ï¸ å…¨å±€ç”¨æˆ·èµ„æºé™åˆ¶**
é€šè¿‡é…ç½®æ–‡ä»¶`/etc/systemd/system/user-.slice.d/`å¯ä»¥ä¸ºæ‰€æœ‰ç”¨æˆ·è®¾ç½®é»˜è®¤é™åˆ¶ï¼š

```bash
# åˆ›å»ºç”¨æˆ·é»˜è®¤èµ„æºé™åˆ¶
sudo mkdir -p /etc/systemd/system/user-.slice.d/
sudo tee /etc/systemd/system/user-.slice.d/resources.conf << EOF
[Slice]
# æ¯ä¸ªç”¨æˆ·æœ€å¤šä½¿ç”¨20%çš„CPU
CPUQuota=20%
# æ¯ä¸ªç”¨æˆ·å†…å­˜é™åˆ¶1GB
MemoryHigh=800M
MemoryMax=1G
# æ¯ä¸ªç”¨æˆ·æœ€å¤š100ä¸ªä»»åŠ¡
TasksMax=100
EOF

sudo systemctl daemon-reload
```

**ğŸ‘¤ ç‰¹å®šç”¨æˆ·èµ„æºé™åˆ¶**
```bash
# ä¸ºç”¨æˆ·ID 1000è®¾ç½®ç‰¹æ®Šé™åˆ¶ï¼ˆæ¯”å¦‚å¼€å‘è€…ç”¨æˆ·ï¼‰
sudo mkdir -p /etc/systemd/system/user-1000.slice.d/
sudo tee /etc/systemd/system/user-1000.slice.d/resources.conf << EOF
[Slice]
CPUQuota=50%      # å¼€å‘è€…éœ€è¦æ›´å¤šCPU
MemoryMax=4G      # æ›´å¤šå†…å­˜ç”¨äºç¼–è¯‘
TasksMax=200      # æ›´å¤šä»»åŠ¡æ•°
EOF
```

### 6.3 sessionç®¡ç†


**ğŸ–¥ï¸ sessionçš„æ¦‚å¿µ**
æ¯æ¬¡ç”¨æˆ·ç™»å½•éƒ½ä¼šåˆ›å»ºä¸€ä¸ªsessionï¼Œæ¯”å¦‚ï¼š
- SSHç™»å½•åˆ›å»ºä¸€ä¸ªsession
- å›¾å½¢ç•Œé¢ç™»å½•åˆ›å»ºå¦ä¸€ä¸ªsession
- åŒä¸€ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªå¹¶å‘session

**ğŸ” æŸ¥çœ‹ç”¨æˆ·session**
```bash
# æŸ¥çœ‹æ‰€æœ‰æ´»è·ƒçš„ç”¨æˆ·ä¼šè¯
loginctl list-sessions

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„session
loginctl list-sessions --user=username

# æŸ¥çœ‹sessionè¯¦ç»†ä¿¡æ¯
loginctl show-session 1
```

**ğŸ“Š sessionèµ„æºç›‘æ§**
```bash
# æŸ¥çœ‹ç”¨æˆ·èµ„æºä½¿ç”¨
systemctl status user-1000.slice

# æŸ¥çœ‹ç‰¹å®šsessionèµ„æºä½¿ç”¨
systemctl status session-1.scope

# å®æ—¶ç›‘æ§ç”¨æˆ·èµ„æº
systemd-cgtop | grep user-
```

### 6.4 ç”¨æˆ·æœåŠ¡ç®¡ç†


**ğŸ”§ ç”¨æˆ·çº§systemdæœåŠ¡**
æ™®é€šç”¨æˆ·ä¹Ÿå¯ä»¥åˆ›å»ºå’Œç®¡ç†è‡ªå·±çš„systemdæœåŠ¡ï¼š

```bash
# ç”¨æˆ·æœåŠ¡ç›®å½•
mkdir -p ~/.config/systemd/user

# åˆ›å»ºç”¨æˆ·æœåŠ¡
tee ~/.config/systemd/user/my-app.service << EOF
[Unit]
Description=æˆ‘çš„ä¸ªäººåº”ç”¨

[Service]
Type=simple
ExecStart=/home/user/bin/my-app
Restart=always

# ç”¨æˆ·æœåŠ¡ä¹Ÿå¯ä»¥è®¾ç½®èµ„æºé™åˆ¶
CPUQuota=10%
MemoryHigh=100M

[Install]
WantedBy=default.target
EOF

# é‡æ–°åŠ è½½ç”¨æˆ·é…ç½®
systemctl --user daemon-reload

# å¯åŠ¨ç”¨æˆ·æœåŠ¡
systemctl --user start my-app.service
systemctl --user enable my-app.service
```

---

## 7. ğŸš€ systemd-runä¸´æ—¶æœåŠ¡åˆ›å»º


### 7.1 systemd-runåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯systemd-run**
`systemd-run` æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å‘½ä»¤ï¼Œå¯ä»¥**ä¸´æ—¶åˆ›å»º**systemdæœåŠ¡æˆ–scopeï¼Œå¹¶ç«‹å³è¿è¡Œå‘½ä»¤ã€‚å°±åƒæ˜¯ç»™ä»»ä½•å‘½ä»¤**ä¸´æ—¶å¥—ä¸Šsystemdçš„ç®¡ç†å¤–å£³**ã€‚

**ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯**ï¼š
- ğŸ”§ ä¸´æ—¶è¿è¡Œéœ€è¦èµ„æºé™åˆ¶çš„ä»»åŠ¡
- ğŸ§ª æµ‹è¯•èµ„æºé™åˆ¶æ•ˆæœ
- ğŸ“Š è¿è¡Œä¸€æ¬¡æ€§çš„æ‰¹å¤„ç†ä»»åŠ¡
- ğŸ” è°ƒè¯•å’Œæ€§èƒ½åˆ†æ

### 7.2 åŸºæœ¬ä½¿ç”¨è¯­æ³•


**ğŸ“‹ å‘½ä»¤æ ¼å¼**
```bash
systemd-run [é€‰é¡¹] [å‘½ä»¤å’Œå‚æ•°]
```

**â­ ç®€å•ç¤ºä¾‹**
```bash
# åˆ›å»ºä¸´æ—¶æœåŠ¡è¿è¡Œå‘½ä»¤
sudo systemd-run --unit=temp-task echo "Hello systemd"

# å¸¦èµ„æºé™åˆ¶çš„ä¸´æ—¶ä»»åŠ¡
sudo systemd-run --unit=cpu-test --property=CPUQuota=25% stress -c 1
```

### 7.3 èµ„æºé™åˆ¶å‚æ•°


**ğŸ›ï¸ CPUé™åˆ¶ç¤ºä¾‹**
```bash
# é™åˆ¶CPUä½¿ç”¨ç‡
sudo systemd-run --unit=backup-task \
  --property=CPUQuota=20% \
  --property=Nice=19 \
  rsync -av /home/user/ /backup/

# è®¾ç½®CPUäº²å’Œæ€§ï¼ˆåªåœ¨ç‰¹å®šæ ¸å¿ƒè¿è¡Œï¼‰
sudo systemd-run --unit=compile-task \
  --property=CPUAffinity="0 1" \
  make -j2
```

**ğŸ’¾ å†…å­˜é™åˆ¶ç¤ºä¾‹**
```bash
# é™åˆ¶å†…å­˜ä½¿ç”¨
sudo systemd-run --unit=memory-test \
  --property=MemoryHigh=512M \
  --property=MemoryMax=1G \
  python3 memory_intensive_script.py

# ç¦ç”¨swap
sudo systemd-run --unit=no-swap-task \
  --property=MemorySwapMax=0 \
  ./cpu_bound_program
```

### 7.4 é«˜çº§ä½¿ç”¨æŠ€å·§


**ğŸ• åå°è¿è¡Œä¸ç›‘æ§**
```bash
# åå°è¿è¡Œé•¿æ—¶é—´ä»»åŠ¡
sudo systemd-run --unit=long-backup \
  --property=CPUQuota=15% \
  --remain-after-exit \
  /scripts/full_backup.sh

# ç›‘æ§åå°ä»»åŠ¡
systemctl status long-backup
journalctl -u long-backup -f
```

**ğŸ“ å·¥ä½œç›®å½•å’Œç¯å¢ƒå˜é‡**
```bash
# æŒ‡å®šå·¥ä½œç›®å½•å’Œç¯å¢ƒå˜é‡
sudo systemd-run --unit=web-test \
  --working-directory=/var/www \
  --setenv=NODE_ENV=production \
  --property=MemoryMax=512M \
  node server.js
```

**â° å®šæ—¶æ‰§è¡Œï¼ˆé…åˆsystemd timerï¼‰**
```bash
# åˆ›å»ºå®šæ—¶ä»»åŠ¡
sudo systemd-run --unit=cleanup-task \
  --on-calendar="daily" \
  --property=CPUQuota=10% \
  /scripts/cleanup.sh
```

### 7.5 å®é™…åº”ç”¨åœºæ™¯


**ğŸ’¼ åœºæ™¯1ï¼šæ•°æ®å¤‡ä»½ä»»åŠ¡**
```bash
# é™åˆ¶å¤‡ä»½ä»»åŠ¡èµ„æºï¼Œé¿å…å½±å“æ­£å¸¸ä¸šåŠ¡
sudo systemd-run --unit=nightly-backup \
  --slice=background.slice \
  --property=CPUQuota=15% \
  --property=IOWeight=10 \
  --property=Nice=19 \
  /backup/scripts/full_backup.sh
```

**ğŸ§ª åœºæ™¯2ï¼šå‹åŠ›æµ‹è¯•**
```bash
# åˆ›å»ºæ§åˆ¶çš„å‹åŠ›æµ‹è¯•
sudo systemd-run --unit=stress-test \
  --property=CPUQuota=50% \
  --property=MemoryMax=2G \
  --property=TasksMax=50 \
  stress-ng --cpu 4 --vm 2 --timeout 300s
```

**ğŸ“Š åœºæ™¯3ï¼šæ—¥å¿—åˆ†æä»»åŠ¡**
```bash
# åˆ†æå¤§æ—¥å¿—æ–‡ä»¶ï¼Œé™åˆ¶èµ„æºä½¿ç”¨
sudo systemd-run --unit=log-analysis \
  --property=MemoryHigh=1G \
  --property=CPUQuota=30% \
  --working-directory=/var/log \
  python3 /scripts/analyze_logs.py
```

---

## 8. ğŸš€ cgroups v2åœ¨systemdä¸­çš„åº”ç”¨


### 8.1 cgroups v1 vs v2å¯¹æ¯”


**ğŸ”¸ ç‰ˆæœ¬æ¼”è¿›çš„æ„ä¹‰**
cgroups v2æ˜¯å¯¹v1ç‰ˆæœ¬çš„é‡å¤§æ”¹è¿›ï¼Œè§£å†³äº†v1ç‰ˆæœ¬çš„ä¸€äº›è®¾è®¡é—®é¢˜ã€‚systemdä»ç‰ˆæœ¬246å¼€å§‹é»˜è®¤ä½¿ç”¨cgroups v2ã€‚

| ç‰¹æ€§ | **cgroups v1** | **cgroups v2** |
|------|----------------|----------------|
| ğŸ—ï¸ **å±‚çº§ç»“æ„** | å¤šä¸ªç‹¬ç«‹å±‚çº§ | ç»Ÿä¸€å±‚çº§ |
| ğŸ”„ **èµ„æºæ§åˆ¶** | åˆ†æ•£ç®¡ç† | ç»Ÿä¸€æ¥å£ |
| ğŸ“Š **æ€§èƒ½** | è¾ƒä½ | æ˜¾è‘—æå‡ |
| ğŸ›¡ï¸ **å®‰å…¨æ€§** | åŸºç¡€ | å¢å¼º |

### 8.2 æ£€æŸ¥cgroupsç‰ˆæœ¬


**ğŸ” ç¡®è®¤ç³»ç»Ÿä½¿ç”¨çš„ç‰ˆæœ¬**
```bash
# æ£€æŸ¥cgroupsç‰ˆæœ¬
mount | grep cgroup

# å¦‚æœçœ‹åˆ°cgroup2ï¼Œè¯´æ˜ä½¿ç”¨v2
# å¦‚æœçœ‹åˆ°å¤šä¸ªcgroupæŒ‚è½½ï¼Œè¯´æ˜ä½¿ç”¨v1æˆ–æ··åˆæ¨¡å¼

# æŸ¥çœ‹systemdä½¿ç”¨çš„cgroupsç‰ˆæœ¬
systemctl --version

# æŸ¥çœ‹å†…æ ¸æ”¯æŒ
cat /proc/cgroups
```

**âš™ï¸ å¼ºåˆ¶å¯ç”¨cgroups v2**
```bash
# ç¼–è¾‘grubé…ç½®ï¼ˆå¦‚æœç³»ç»Ÿè¿˜åœ¨ä½¿ç”¨v1ï¼‰
sudo nano /etc/default/grub

# æ·»åŠ å†…æ ¸å‚æ•°
GRUB_CMDLINE_LINUX="systemd.unified_cgroup_hierarchy=1"

# æ›´æ–°grub
sudo update-grub
sudo reboot
```

### 8.3 v2ä¸­çš„æ–°ç‰¹æ€§


**ğŸ“Š ç»Ÿä¸€èµ„æºæ¥å£**
åœ¨cgroups v2ä¸­ï¼Œæ‰€æœ‰èµ„æºæ§åˆ¶éƒ½é€šè¿‡ç»Ÿä¸€çš„æ¥å£è¿›è¡Œï¼š

```bash
# v2ä¸­çš„cgroupæ–‡ä»¶ç³»ç»Ÿç»“æ„æ›´ç®€æ´
/sys/fs/cgroup/
â”œâ”€â”€ cgroup.controllers       # å¯ç”¨æ§åˆ¶å™¨
â”œâ”€â”€ cgroup.subtree_control   # å¯ç”¨çš„æ§åˆ¶å™¨  
â”œâ”€â”€ system.slice/
â”‚   â”œâ”€â”€ cgroup.controllers
â”‚   â”œâ”€â”€ cpu.max             # CPUé™åˆ¶
â”‚   â”œâ”€â”€ memory.max          # å†…å­˜é™åˆ¶
â”‚   â””â”€â”€ nginx.service/
â””â”€â”€ user.slice/
```

**ğŸ”§ systemdä¸­çš„v2é…ç½®**
```ini
# v2ä¸­çš„serviceé…ç½®æ›´åŠ ç›´è§‚
[Service]
CPUQuota=50%              # å¯¹åº”cpu.max
MemoryMax=1G              # å¯¹åº”memory.max
IOWeight=100              # å¯¹åº”io.weight
```

### 8.4 v2æ€§èƒ½ä¼˜åŠ¿


**âš¡ æ€§èƒ½æ”¹è¿›å¯¹æ¯”**
```
èµ„æºæ§åˆ¶å»¶è¿Ÿï¼š
v1: å¹³å‡5-10ms
v2: å¹³å‡1-2ms  â†“ æå‡80%

å†…å­˜å¼€é”€ï¼š
v1: æ¯cgroupçº¦1KB
v2: æ¯cgroupçº¦0.2KB â†“ å‡å°‘80%

CPUè°ƒåº¦ç²¾åº¦ï¼š
v1: æ¯«ç§’çº§
v2: å¾®ç§’çº§ â†‘ ç²¾åº¦æå‡1000å€
```

### 8.5 v2å®é™…åº”ç”¨ç¤ºä¾‹


**ğŸ¢ ä¼ä¸šç¯å¢ƒé…ç½®ç¤ºä¾‹**
```bash
# åˆ›å»ºç°ä»£åŒ–çš„sliceé…ç½®
sudo tee /etc/systemd/system/production.slice << EOF
[Unit]
Description=ç”Ÿäº§ç¯å¢ƒæœåŠ¡

[Slice]
# v2ä¸­æ›´ç²¾ç¡®çš„CPUæ§åˆ¶
CPUQuota=70%
CPUWeight=200

# æ›´å¼ºå¤§çš„å†…å­˜ç®¡ç†
MemoryHigh=6G
MemoryMax=8G
MemorySwapMax=1G

# I/Oæ§åˆ¶ï¼ˆv2æ–°ç‰¹æ€§ï¼‰
IOAccounting=true
IOWeight=200

# æ–°å¢çš„è¿›ç¨‹æ•°æ§åˆ¶
TasksAccounting=true
TasksMax=500
EOF
```

**ğŸ“Š ç›‘æ§v2èµ„æºä½¿ç”¨**
```bash
# v2æä¾›æ›´è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯
cat /sys/fs/cgroup/system.slice/production.slice/memory.current
cat /sys/fs/cgroup/system.slice/production.slice/cpu.stat
cat /sys/fs/cgroup/system.slice/production.slice/io.stat

# ä½¿ç”¨systemdå‘½ä»¤æŸ¥çœ‹
systemctl show production.slice --property=MemoryCurrent
systemctl show production.slice --property=CPUUsageNSec
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ¯ systemd+cgroups = ç°ä»£åŒ–èµ„æºç®¡ç†
â€¢ systemdè‡ªåŠ¨åŒ–ç®¡ç†cgroupsï¼Œç®€åŒ–èµ„æºæ§åˆ¶
â€¢ serviceæ–‡ä»¶é…ç½®èµ„æºé™åˆ¶ï¼ŒæŒä¹…åŒ–ä¿å­˜
â€¢ systemctlåŠ¨æ€è°ƒæ•´ï¼Œæ— éœ€é‡å¯æœåŠ¡
â€¢ sliceæä¾›åˆ†ç»„ç®¡ç†ï¼Œå®ç°èµ„æºéš”ç¦»
â€¢ user sliceç®¡ç†ç”¨æˆ·ä¼šè¯ï¼Œé˜²æ­¢èµ„æºæ»¥ç”¨
â€¢ systemd-runåˆ›å»ºä¸´æ—¶æœåŠ¡ï¼Œçµæ´»æµ‹è¯•
â€¢ cgroups v2æä¾›æ›´å¥½çš„æ€§èƒ½å’Œç»Ÿä¸€æ¥å£
```

### 9.2 å…³é”®é…ç½®å‚æ•°è®°å¿†


**â­â­â­ å¿…ä¼šå‚æ•°**ï¼š
```ini
CPUQuota=50%              # CPUä½¿ç”¨ç‡é™åˆ¶
MemoryHigh=500M           # å†…å­˜è½¯é™åˆ¶ï¼ˆå¼€å§‹å›æ”¶ï¼‰
MemoryMax=1G              # å†…å­˜ç¡¬é™åˆ¶ï¼ˆæ€æ­»è¿›ç¨‹ï¼‰
TasksMax=100              # æœ€å¤§ä»»åŠ¡æ•°
Slice=webapp.slice        # æŒ‡å®šæœåŠ¡ç»„
```

### 9.3 å®ç”¨å‘½ä»¤æ¸…å•


**ğŸ”§ æ—¥å¸¸ç®¡ç†å‘½ä»¤**ï¼š
```bash
# é…ç½®ç®¡ç†
systemctl daemon-reload                    # é‡æ–°åŠ è½½é…ç½®
systemctl set-property [service] [param]   # åŠ¨æ€è°ƒæ•´èµ„æº

# ç›‘æ§æŸ¥çœ‹
systemctl status [service]                 # æŸ¥çœ‹æœåŠ¡çŠ¶æ€  
systemctl show [service] --property=[param] # æŸ¥çœ‹å…·ä½“å‚æ•°
systemd-cgtop                             # å®æ—¶èµ„æºç›‘æ§
systemd-cgls                              # æŸ¥çœ‹cgroupå±‚çº§

# ä¸´æ—¶æœåŠ¡
systemd-run --unit=[name] --property=[param] [command]
```

### 9.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ’¡ é…ç½®åŸåˆ™**ï¼š
- âœ… **æ¸è¿›å¼é™åˆ¶**ï¼šè®¾ç½®MemoryHighå’ŒMemoryMax
- âœ… **åˆç†åˆ†ç»„**ï¼šä½¿ç”¨sliceç®¡ç†ç›¸å…³æœåŠ¡
- âœ… **åŠ¨æ€è°ƒæ•´**ï¼šä½¿ç”¨set-propertyæµ‹è¯•æœ€ä½³å€¼
- âœ… **ç›‘æ§ä¸ºå…ˆ**ï¼šé…ç½®åè¦éªŒè¯å’Œç›‘æ§
- âœ… **æ–‡æ¡£è®°å½•**ï¼šé‡è¦é…ç½®è¦è®°å½•åŸå› 

**âš ï¸ å¸¸è§é™·é˜±**ï¼š
- âŒ åªè®¾ç½®ç¡¬é™åˆ¶ï¼Œä¸è®¾ç½®è½¯é™åˆ¶
- âŒ CPUé™åˆ¶è¿‡ä¸¥ï¼Œå½±å“æœåŠ¡å“åº”
- âŒ å¿½ç•¥ç”¨æˆ·èµ„æºç®¡ç†
- âŒ ä¸ç›‘æ§èµ„æºä½¿ç”¨æ•ˆæœ

### 9.5 æ•…éšœæ’æŸ¥æŒ‡å—


**ğŸ” é—®é¢˜è¯Šæ–­æ­¥éª¤**ï¼š
1. **æ£€æŸ¥é…ç½®**ï¼š`systemctl show [service]`
2. **æŸ¥çœ‹çŠ¶æ€**ï¼š`systemctl status [service]` 
3. **ç›‘æ§èµ„æº**ï¼š`systemd-cgtop`
4. **æŸ¥çœ‹æ—¥å¿—**ï¼š`journalctl -u [service]`
5. **æµ‹è¯•è°ƒæ•´**ï¼š`systemctl set-property --runtime`

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- systemdç®¡cgroupï¼Œé…ç½®å°±ç”Ÿæ•ˆ
- CPUå†…å­˜ä»»åŠ¡æ•°ï¼Œsliceåˆ†ç»„æ›´æ¸…æ™°  
- è½¯é™åˆ¶ç¡¬é™åˆ¶ï¼Œæ¸è¿›å¼æ‰å®‰å…¨
- åŠ¨æ€è°ƒæ•´æµ‹è¯•å¥½ï¼Œé‡å¯ä¹‹åä»æœ‰æ•ˆ

**å­¦ä¹ å»ºè®®**ï¼š
ğŸŒ± **å…¥é—¨é˜¶æ®µ**ï¼šæŒæ¡åŸºæœ¬é…ç½®å‚æ•°ï¼Œå­¦ä¼šæŸ¥çœ‹çŠ¶æ€
ğŸŒ¿ **è¿›é˜¶é˜¶æ®µ**ï¼šç†è§£sliceæ¦‚å¿µï¼Œå­¦ä¼šèµ„æºè§„åˆ’
ğŸŒ³ **é«˜çº§é˜¶æ®µ**ï¼šæŒæ¡åŠ¨æ€è°ƒæ•´ï¼Œä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½