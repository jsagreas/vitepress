---
title: 12ã€Cgroupsä¸Namespaceè°ƒè¯•å·¥å…·
---
## ğŸ“š ç›®å½•

1. [namespaceä¿¡æ¯æŸ¥çœ‹å·¥å…·](#1-namespaceä¿¡æ¯æŸ¥çœ‹å·¥å…·)
2. [namespaceç¯å¢ƒæ“ä½œå·¥å…·](#2-namespaceç¯å¢ƒæ“ä½œå·¥å…·)
3. [Cgroupså±‚æ¬¡æŸ¥çœ‹å·¥å…·](#3-cgroupså±‚æ¬¡æŸ¥çœ‹å·¥å…·)
4. [procæ–‡ä»¶ç³»ç»Ÿä¿¡æ¯è§£è¯»](#4-procæ–‡ä»¶ç³»ç»Ÿä¿¡æ¯è§£è¯»)
5. [ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªè°ƒè¯•](#5-ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªè°ƒè¯•)
6. [å®¹å™¨è¿è¡Œæ—¶è°ƒè¯•æŠ€æœ¯](#6-å®¹å™¨è¿è¡Œæ—¶è°ƒè¯•æŠ€æœ¯)
7. [æ•…éšœè¯Šæ–­æµç¨‹](#7-æ•…éšœè¯Šæ–­æµç¨‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” namespaceä¿¡æ¯æŸ¥çœ‹å·¥å…·


### 1.1 lsnså‘½ä»¤è¯¦è§£


**ğŸ”¸ ä»€ä¹ˆæ˜¯lsns**
`lsns`æ˜¯Linuxç³»ç»Ÿä¸­ä¸“é—¨ç”¨æ¥æŸ¥çœ‹namespaceä¿¡æ¯çš„å‘½ä»¤å·¥å…·ã€‚å¯ä»¥æŠŠå®ƒç†è§£ä¸º"åˆ—å‡ºæ‰€æœ‰namespace"çš„æ„æ€ï¼ˆlist namespacesï¼‰ã€‚

**ğŸ’¡ åŸºæœ¬æ¦‚å¿µ**
```
Namespaceå°±åƒæ˜¯ç»™è¿›ç¨‹åˆ›å»ºçš„"ç‹¬ç«‹æˆ¿é—´"
æ¯ä¸ªæˆ¿é—´é‡Œçš„è¿›ç¨‹çœ‹åˆ°çš„ç³»ç»Ÿèµ„æºéƒ½ä¸ä¸€æ ·
lsnså°±æ˜¯ç”¨æ¥æŸ¥çœ‹è¿™äº›"æˆ¿é—´"çš„å·¥å…·
```

**âš¡ å¸¸ç”¨å‘½ä»¤æ ¼å¼**

| å‚æ•° | å«ä¹‰ | ç¤ºä¾‹ |
|------|------|------|
| `lsns` | æ˜¾ç¤ºæ‰€æœ‰namespace | æŸ¥çœ‹ç³»ç»Ÿæ‰€æœ‰namespace |
| `lsns -t <type>` | æ˜¾ç¤ºæŒ‡å®šç±»å‹ | `lsns -t pid` åªçœ‹PID namespace |
| `lsns -p <pid>` | æ˜¾ç¤ºæŒ‡å®šè¿›ç¨‹çš„namespace | `lsns -p 1234` |

### 1.2 namespaceç±»å‹è¯†åˆ«


**ğŸ·ï¸ ä¸ƒç§ä¸»è¦namespaceç±»å‹**

```
ç³»ç»Ÿnamespaceç±»å‹ä¸€è§ˆï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç±»å‹æ ‡è¯†     â”‚ ä½œç”¨è¯´æ˜                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ pid         â”‚ è¿›ç¨‹IDéš”ç¦»                   â”‚
â”‚ net         â”‚ ç½‘ç»œæ¥å£ã€è·¯ç”±è¡¨éš”ç¦»         â”‚
â”‚ mnt         â”‚ æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹éš”ç¦»           â”‚
â”‚ uts         â”‚ ä¸»æœºåå’ŒåŸŸåéš”ç¦»             â”‚
â”‚ ipc         â”‚ è¿›ç¨‹é—´é€šä¿¡å¯¹è±¡éš”ç¦»           â”‚
â”‚ user        â”‚ ç”¨æˆ·å’Œç»„IDéš”ç¦»               â”‚
â”‚ cgroup      â”‚ cgroupsæ ¹ç›®å½•éš”ç¦»            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ å®é™…æŸ¥çœ‹ç¤ºä¾‹**
```bash
# æŸ¥çœ‹æ‰€æœ‰namespace
lsns

# åªæŸ¥çœ‹ç½‘ç»œnamespace
lsns -t net

# æŸ¥çœ‹æŸä¸ªè¿›ç¨‹çš„æ‰€æœ‰namespace
lsns -p 1234
```

### 1.3 è¾“å‡ºä¿¡æ¯è§£è¯»


**ğŸ“Š lsnsè¾“å‡ºæ ¼å¼è¯´æ˜**

```
NS      TYPE   NPROCS   PID   USER   COMMAND
4026531835  pid      156     1   root   /sbin/init
4026531836  net      156     1   root   /sbin/init

å­—æ®µå«ä¹‰ï¼š
NSï¼š    namespaceçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆinodeå·ï¼‰
TYPEï¼š  namespaceç±»å‹
NPROCSï¼šä½¿ç”¨æ­¤namespaceçš„è¿›ç¨‹æ•°é‡  
PIDï¼š   åˆ›å»ºæ­¤namespaceçš„è¿›ç¨‹ID
USERï¼š  åˆ›å»ºè€…ç”¨æˆ·
COMMANDï¼šåˆ›å»ºè¿›ç¨‹çš„å‘½ä»¤
```

---

## 2. ğŸšª namespaceç¯å¢ƒæ“ä½œå·¥å…·


### 2.1 nsenterè¿›å…¥æŒ‡å®šnamespace


**ğŸ”¸ ä»€ä¹ˆæ˜¯nsenter**
`nsenter`å‘½ä»¤çš„æ„æ€æ˜¯"namespace enter"ï¼Œç”¨æ¥è¿›å…¥å·²å­˜åœ¨çš„namespaceç¯å¢ƒã€‚å°±åƒæ˜¯"è¿›å…¥åˆ«äººçš„æˆ¿é—´"çœ‹çœ‹é‡Œé¢æ˜¯ä»€ä¹ˆæ ·å­ã€‚

**ğŸ’¡ å·¥ä½œåŸç†**
```
åŸç†ç¤ºæ„ï¼š

å½“å‰shellè¿›ç¨‹ â”€â”€â”€â”
                 â”‚ nsenter
                 â–¼
          ç›®æ ‡namespaceç¯å¢ƒ
          ï¼ˆè¿›å…¥å®¹å™¨å†…éƒ¨è§†è§’ï¼‰
```

**âš¡ åŸºæœ¬è¯­æ³•æ ¼å¼**

```bash
nsenter [é€‰é¡¹] -t <ç›®æ ‡è¿›ç¨‹PID> [å‘½ä»¤]

å¸¸ç”¨é€‰é¡¹ï¼š
-t  æŒ‡å®šç›®æ ‡è¿›ç¨‹PID
-m  è¿›å…¥mount namespace
-u  è¿›å…¥UTS namespace  
-i  è¿›å…¥IPC namespace
-n  è¿›å…¥network namespace
-p  è¿›å…¥PID namespace
-a  è¿›å…¥æ‰€æœ‰namespace
```

### 2.2 nsenterå®é™…åº”ç”¨


**ğŸ¯ è¿›å…¥å®¹å™¨ç¯å¢ƒè°ƒè¯•**
```bash
# æ‰¾åˆ°å®¹å™¨ä¸»è¿›ç¨‹PID
docker inspect <å®¹å™¨å> | grep Pid

# è¿›å…¥å®¹å™¨çš„æ‰€æœ‰namespace
nsenter -t <PID> -a /bin/bash

# åªè¿›å…¥ç½‘ç»œnamespaceæŸ¥çœ‹ç½‘ç»œé…ç½®
nsenter -t <PID> -n ip addr show
```

**ğŸ”§ ç½‘ç»œæ•…éšœè¯Šæ–­**
```bash
# è¿›å…¥å®¹å™¨ç½‘ç»œç¯å¢ƒ
nsenter -t <å®¹å™¨PID> -n netstat -tlnp

# æŸ¥çœ‹å®¹å™¨å†…çš„è·¯ç”±è¡¨
nsenter -t <å®¹å™¨PID> -n route -n
```

### 2.3 unshareåˆ›å»ºæ–°namespace


**ğŸ”¸ ä»€ä¹ˆæ˜¯unshare**
`unshare`ç”¨æ¥åˆ›å»ºæ–°çš„namespaceç¯å¢ƒã€‚å¯ä»¥ç†è§£ä¸º"åˆ›å»ºä¸€ä¸ªæ–°æˆ¿é—´"ï¼Œç„¶ååœ¨é‡Œé¢æ‰§è¡Œå‘½ä»¤ã€‚

**ğŸ’¡ åˆ›å»ºåŸç†**
```
çˆ¶è¿›ç¨‹namespace â”€â”€â”€â”
                   â”‚ unshare
                   â–¼
            æ–°çš„ç‹¬ç«‹namespace
            ï¼ˆéš”ç¦»çš„æ‰§è¡Œç¯å¢ƒï¼‰
```

**âš¡ å¸¸ç”¨åˆ›å»ºæ–¹å¼**

| å‘½ä»¤ | ä½œç”¨ |
|------|------|
| `unshare -p` | åˆ›å»ºæ–°çš„PID namespace |
| `unshare -n` | åˆ›å»ºæ–°çš„ç½‘ç»œnamespace |
| `unshare -m` | åˆ›å»ºæ–°çš„æŒ‚è½½namespace |
| `unshare -u` | åˆ›å»ºæ–°çš„UTS namespace |

### 2.4 unshareå®é™…åº”ç”¨


**ğŸ¯ æµ‹è¯•ç¯å¢ƒéš”ç¦»**
```bash
# åˆ›å»ºéš”ç¦»çš„ç½‘ç»œç¯å¢ƒ
unshare -n /bin/bash
# åœ¨æ–°ç¯å¢ƒä¸­ï¼Œåªèƒ½çœ‹åˆ°loæ¥å£

# åˆ›å»ºéš”ç¦»çš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç¯å¢ƒ
unshare -m /bin/bash
# åœ¨æ­¤ç¯å¢ƒä¸­çš„æŒ‚è½½æ“ä½œä¸å½±å“ä¸»ç³»ç»Ÿ
```

**ğŸ”§ å®éªŒnamespaceåŠŸèƒ½**
```bash
# åˆ›å»ºæ–°çš„ä¸»æœºånamespace
unshare -u /bin/bash
hostname test-container
# ä¸»æœºåä¿®æ”¹åªåœ¨å½“å‰namespaceç”Ÿæ•ˆ
```

---

## 3. ğŸŒ³ Cgroupså±‚æ¬¡æŸ¥çœ‹å·¥å…·


### 3.1 systemd-cglså±‚æ¬¡æŸ¥çœ‹


**ğŸ”¸ ä»€ä¹ˆæ˜¯systemd-cgls**
`systemd-cgls`æ˜¯æŸ¥çœ‹cgroupså±‚æ¬¡ç»“æ„çš„ä¸“ç”¨å·¥å…·ã€‚æŠŠcgroupsæƒ³è±¡æˆä¸€æ£µ"ç®¡ç†æ ‘"ï¼Œè¿™ä¸ªå‘½ä»¤å¸®ä½ çœ‹æ¸…æ¥šæ ‘çš„ç»“æ„ã€‚

**ğŸ’¡ å±‚æ¬¡ç»“æ„æ¦‚å¿µ**
```
Cgroupså±‚æ¬¡ç»“æ„ç¤ºæ„ï¼š

â”œâ”€system.sliceï¼ˆç³»ç»ŸæœåŠ¡ç»„ï¼‰
â”‚ â”œâ”€systemd-logind.service
â”‚ â””â”€sshd.service  
â”œâ”€user.sliceï¼ˆç”¨æˆ·è¿›ç¨‹ç»„ï¼‰
â”‚ â””â”€user-1000.slice
â”‚   â””â”€session-1.scope
â””â”€machine.sliceï¼ˆè™šæ‹Ÿæœºå®¹å™¨ç»„ï¼‰
  â””â”€docker-abc123.scope
```

**âš¡ åŸºæœ¬ä½¿ç”¨æ–¹æ³•**

```bash
# æŸ¥çœ‹å®Œæ•´cgroupsæ ‘çŠ¶ç»“æ„
systemd-cgls

# åªæŸ¥çœ‹æŒ‡å®šslice
systemd-cgls system.slice

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡çš„èµ„æºç»„ç»‡
systemd-cgls user.slice
```

### 3.2 cgroupsæ–‡ä»¶ç³»ç»Ÿç»“æ„


**ğŸ“ /sys/fs/cgroupç›®å½•ç»“æ„**

```
/sys/fs/cgroup ç›®å½•è§£æï¼š

/sys/fs/cgroup/
â”œâ”€cpu/          # CPUä½¿ç”¨é™åˆ¶
â”œâ”€memory/       # å†…å­˜ä½¿ç”¨é™åˆ¶  
â”œâ”€blkio/        # å—è®¾å¤‡IOé™åˆ¶
â”œâ”€devices/      # è®¾å¤‡è®¿é—®æ§åˆ¶
â”œâ”€freezer/      # è¿›ç¨‹å†»ç»“æ§åˆ¶
â”œâ”€net_cls/      # ç½‘ç»œåˆ†ç±»æ ‡è®°
â””â”€systemd/      # systemdç®¡ç†çš„å±‚æ¬¡
```

**ğŸ” æ‰‹åŠ¨æŸ¥çœ‹cgroupsä¿¡æ¯**
```bash
# æŸ¥çœ‹CPUæ§åˆ¶ç»„
ls /sys/fs/cgroup/cpu/

# æŸ¥çœ‹å†…å­˜æ§åˆ¶ç»„
ls /sys/fs/cgroup/memory/

# æŸ¥çœ‹æŸä¸ªè¿›ç¨‹æ‰€å±çš„æ§åˆ¶ç»„
cat /proc/<PID>/cgroup
```

### 3.3 cgroupsèµ„æºé™åˆ¶æŸ¥çœ‹


**ğŸ“Š èµ„æºä½¿ç”¨ç»Ÿè®¡**

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ
cat /sys/fs/cgroup/memory/docker/<å®¹å™¨ID>/memory.usage_in_bytes

# æŸ¥çœ‹CPUä½¿ç”¨ç»Ÿè®¡
cat /sys/fs/cgroup/cpu/docker/<å®¹å™¨ID>/cpuacct.stat

# æŸ¥çœ‹è¿›ç¨‹åˆ—è¡¨
cat /sys/fs/cgroup/systemd/system.slice/sshd.service/cgroup.procs
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
- Cgroups v1å’Œv2çš„ç›®å½•ç»“æ„ä¸åŒ
- ä¸åŒLinuxå‘è¡Œç‰ˆå¯èƒ½æœ‰å·®å¼‚
- å®¹å™¨è¿è¡Œæ—¶ä¼šåˆ›å»ºä¸“é—¨çš„å­ç›®å½•

---

## 4. ğŸ“‚ procæ–‡ä»¶ç³»ç»Ÿä¿¡æ¯è§£è¯»


### 4.1 /proc/PID/nsç›®å½•


**ğŸ”¸ ä»€ä¹ˆæ˜¯/proc/PID/ns**
è¿™ä¸ªç›®å½•åŒ…å«äº†è¿›ç¨‹æ‰€å±çš„å„ç§namespaceä¿¡æ¯ã€‚å¯ä»¥ç†è§£ä¸ºæ¯ä¸ªè¿›ç¨‹çš„"èº«ä»½è¯"ï¼Œè®°å½•ç€å®ƒä½åœ¨å“ªäº›"æˆ¿é—´"é‡Œã€‚

**ğŸ“‹ namespaceæ–‡ä»¶è¯´æ˜**

```
/proc/<PID>/ns/ ç›®å½•å†…å®¹ï¼š

â”œâ”€cgroup -> cgroup:[4026531835]    # cgroup namespace
â”œâ”€ipc -> ipc:[4026531839]          # IPC namespace  
â”œâ”€mnt -> mnt:[4026531840]          # æŒ‚è½½ namespace
â”œâ”€net -> net:[4026531992]          # ç½‘ç»œ namespace
â”œâ”€pid -> pid:[4026531836]          # PID namespace
â”œâ”€user -> user:[4026531837]        # ç”¨æˆ· namespace
â””â”€uts -> uts:[4026531838]          # UTS namespace

ç¬¦å·é“¾æ¥æŒ‡å‘çš„æ•°å­—å°±æ˜¯namespaceçš„å”¯ä¸€ID
```

**ğŸ” å®é™…æŸ¥çœ‹æ–¹æ³•**
```bash
# æŸ¥çœ‹è¿›ç¨‹1çš„æ‰€æœ‰namespace
ls -la /proc/1/ns/

# æ¯”è¾ƒä¸¤ä¸ªè¿›ç¨‹çš„namespace
ls -la /proc/1234/ns/
ls -la /proc/5678/ns/
```

### 4.2 /proc/PID/cgroupæ–‡ä»¶


**ğŸ“„ cgroupå½’å±ä¿¡æ¯**
```bash
# æŸ¥çœ‹è¿›ç¨‹æ‰€å±çš„cgroup
cat /proc/1234/cgroup

# è¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š
12:devices:/system.slice/sshd.service
11:freezer:/
10:memory:/system.slice/sshd.service
9:cpu,cpuacct:/system.slice/sshd.service

æ ¼å¼è¯´æ˜ï¼š
å±‚æ¬¡ID:å­ç³»ç»Ÿåç§°:cgroupè·¯å¾„
```

### 4.3 namespaceå…±äº«æ£€æŸ¥


**ğŸ”— æ£€æŸ¥è¿›ç¨‹é—´namespaceå…±äº«**

```bash
# æ£€æŸ¥ä¸¤ä¸ªè¿›ç¨‹æ˜¯å¦å…±äº«ç½‘ç»œnamespace
ls -la /proc/1234/ns/net
ls -la /proc/5678/ns/net
# å¦‚æœæŒ‡å‘ç›¸åŒIDï¼Œè¯´æ˜å…±äº«åŒä¸€ä¸ªç½‘ç»œnamespace

# å¿«é€Ÿæ¯”è¾ƒè„šæœ¬
for ns in /proc/1234/ns/*; do
    echo "$(basename $ns): $(readlink $ns)"
done
```

**ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯**
- æ£€æŸ¥å®¹å™¨è¿›ç¨‹æ˜¯å¦æ­£ç¡®éš”ç¦»
- ç¡®è®¤ç½‘ç»œnamespaceæ˜¯å¦å…±äº«
- æ’æŸ¥æƒé™å’Œèµ„æºè®¿é—®é—®é¢˜

---

## 5. ğŸ” ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªè°ƒè¯•


### 5.1 straceè·Ÿè¸ªnamespaceæ“ä½œ


**ğŸ”¸ ä»€ä¹ˆæ˜¯strace**
`strace`æ˜¯ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªå·¥å…·ï¼Œå¯ä»¥çœ‹åˆ°ç¨‹åºè°ƒç”¨äº†å“ªäº›ç³»ç»Ÿå‡½æ•°ã€‚åœ¨namespaceè°ƒè¯•ä¸­ï¼Œå®ƒèƒ½å¸®æˆ‘ä»¬çœ‹åˆ°ç¨‹åºæ˜¯å¦‚ä½•åˆ›å»ºã€è¿›å…¥namespaceçš„ã€‚

**ğŸ’¡ namespaceç›¸å…³ç³»ç»Ÿè°ƒç”¨**

```
ä¸»è¦ç³»ç»Ÿè°ƒç”¨ç±»å‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç³»ç»Ÿè°ƒç”¨     â”‚ ä½œç”¨è¯´æ˜                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ clone()     â”‚ åˆ›å»ºæ–°è¿›ç¨‹æ—¶æŒ‡å®šnamespace    â”‚
â”‚ unshare()   â”‚ å½“å‰è¿›ç¨‹è„±ç¦»namespace        â”‚ 
â”‚ setns()     â”‚ è¿›ç¨‹åŠ å…¥å·²å­˜åœ¨çš„namespace    â”‚
â”‚ mount()     â”‚ æŒ‚è½½ç›¸å…³çš„namespaceæ“ä½œ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 è·Ÿè¸ªnamespaceåˆ›å»ºè¿‡ç¨‹


**ğŸ¯ è·Ÿè¸ªDockerå®¹å™¨å¯åŠ¨**
```bash
# è·Ÿè¸ªdocker runå‘½ä»¤çš„ç³»ç»Ÿè°ƒç”¨
strace -f -e clone,unshare,setns docker run -it ubuntu /bin/bash

# è¿‡æ»¤è¾“å‡ºé‡ç‚¹å…³æ³¨namespaceç›¸å…³è°ƒç”¨
strace -f -e clone,unshare,setns -o trace.log docker run -it ubuntu /bin/bash
```

**ğŸ” å…³é”®è¾“å‡ºè§£è¯»**
```bash
# cloneç³»ç»Ÿè°ƒç”¨ç¤ºä¾‹
clone(child_stack=NULL, flags=CLONE_NEWPID|CLONE_NEWNS|CLONE_NEWNET, ...)

# flagså‚æ•°è¯´æ˜ï¼š
CLONE_NEWPID  # åˆ›å»ºæ–°PID namespace
CLONE_NEWNS   # åˆ›å»ºæ–°æŒ‚è½½namespace  
CLONE_NEWNET  # åˆ›å»ºæ–°ç½‘ç»œnamespace
```

### 5.3 è·Ÿè¸ªnamespaceè¿›å…¥è¿‡ç¨‹


**ğŸšª è·Ÿè¸ªnsenteræ“ä½œ**
```bash
# è·Ÿè¸ªnsenterè¿›å…¥namespaceçš„è¿‡ç¨‹
strace -e setns nsenter -t 1234 -n ip addr

# è¾“å‡ºä¼šæ˜¾ç¤ºï¼š
setns(3, CLONE_NEWNET) = 0
# è¡¨ç¤ºæˆåŠŸè¿›å…¥ç½‘ç»œnamespace
```

**âš¡ è·Ÿè¸ªæŠ€å·§**
```bash
# åªçœ‹æ–‡ä»¶æ“ä½œ
strace -e file nsenter -t 1234 /bin/bash

# çœ‹ç½‘ç»œç›¸å…³è°ƒç”¨  
strace -e network nsenter -t 1234 -n netstat -i

# å®Œæ•´è·Ÿè¸ªå¹¶ä¿å­˜åˆ°æ–‡ä»¶
strace -f -o debug.log nsenter -t 1234 -a /bin/bash
```

---

## 6. ğŸ³ å®¹å™¨è¿è¡Œæ—¶è°ƒè¯•æŠ€æœ¯


### 6.1 Dockerå®¹å™¨è°ƒè¯•


**ğŸ”§ å®¹å™¨namespaceæ£€æŸ¥**
```bash
# è·å–å®¹å™¨ä¸»è¿›ç¨‹PID
docker inspect <å®¹å™¨å> --format '{{.State.Pid}}'

# æŸ¥çœ‹å®¹å™¨çš„namespaceä¿¡æ¯
docker inspect <å®¹å™¨å> | grep -A 10 "Pid"

# è¿›å…¥å®¹å™¨namespaceè°ƒè¯•ç½‘ç»œ
nsenter -t $(docker inspect <å®¹å™¨å> --format '{{.State.Pid}}') -n netstat -i
```

### 6.2 å®¹å™¨èµ„æºé™åˆ¶è°ƒè¯•


**ğŸ“Š æŸ¥çœ‹å®¹å™¨cgroupsè®¾ç½®**
```bash
# æ‰¾åˆ°å®¹å™¨çš„cgroupç›®å½•
docker inspect <å®¹å™¨å> | grep "cgroup"

# æŸ¥çœ‹å†…å­˜é™åˆ¶
cat /sys/fs/cgroup/memory/docker/<å®¹å™¨ID>/memory.limit_in_bytes

# æŸ¥çœ‹CPUé™åˆ¶  
cat /sys/fs/cgroup/cpu/docker/<å®¹å™¨ID>/cpu.shares
```

### 6.3 å®¹å™¨ç½‘ç»œè°ƒè¯•


**ğŸŒ ç½‘ç»œnamespaceé—®é¢˜æ’æŸ¥**

```bash
# æ£€æŸ¥å®¹å™¨ç½‘ç»œé…ç½®
nsenter -t <PID> -n ip route show

# æŸ¥çœ‹å®¹å™¨ç½‘ç»œæ¥å£
nsenter -t <PID> -n ip addr show

# æµ‹è¯•å®¹å™¨ç½‘ç»œè¿é€šæ€§
nsenter -t <PID> -n ping 8.8.8.8
```

**ğŸ”§ ç½‘ç»œé—®é¢˜è¯Šæ–­æµç¨‹**
```
å®¹å™¨ç½‘ç»œé—®é¢˜è¯Šæ–­æ­¥éª¤ï¼š

1. æ£€æŸ¥å®¹å™¨æ˜¯å¦åˆ›å»ºäº†ç‹¬ç«‹ç½‘ç»œnamespace
   â””â”€ lsns -t net | grep <å®¹å™¨PID>

2. æŸ¥çœ‹å®¹å™¨å†…ç½‘ç»œæ¥å£é…ç½®  
   â””â”€ nsenter -t <PID> -n ip addr

3. æ£€æŸ¥è·¯ç”±é…ç½®
   â””â”€ nsenter -t <PID> -n ip route

4. æµ‹è¯•ç½‘ç»œè¿é€šæ€§
   â””â”€ nsenter -t <PID> -n ping <ç›®æ ‡IP>

5. æ£€æŸ¥å®¿ä¸»æœºç½‘ç»œé…ç½®
   â””â”€ docker network ls
```

---

## 7. ğŸ› ï¸ æ•…éšœè¯Šæ–­æµç¨‹


### 7.1 namespaceé—®é¢˜è¯Šæ–­æ­¥éª¤


**ğŸ¯ æ ‡å‡†è¯Šæ–­æµç¨‹**

```
Namespaceé—®é¢˜è¯Šæ–­checklistï¼š

â˜ 1. ç¡®è®¤è¿›ç¨‹æ˜¯å¦åœ¨æ­£ç¡®çš„namespaceä¸­
   â””â”€ lsns -p <PID>

â˜ 2. æ£€æŸ¥namespaceæ˜¯å¦æ­£ç¡®åˆ›å»º
   â””â”€ ls -la /proc/<PID>/ns/

â˜ 3. éªŒè¯namespaceéš”ç¦»æ˜¯å¦ç”Ÿæ•ˆ
   â””â”€ nsenteræµ‹è¯•è¿›å…¥å‰åçš„å·®å¼‚

â˜ 4. è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨æŸ¥æ‰¾é—®é¢˜ç‚¹
   â””â”€ strace -e clone,setns,unshare <å‘½ä»¤>

â˜ 5. æ£€æŸ¥æƒé™å’Œcapabilities
   â””â”€ getpcaps <PID>
```

### 7.2 cgroupsé—®é¢˜è¯Šæ–­æ­¥éª¤


**ğŸ“Š èµ„æºé™åˆ¶é—®é¢˜æ’æŸ¥**

```
Cgroupsé—®é¢˜è¯Šæ–­checklistï¼š

â˜ 1. ç¡®è®¤è¿›ç¨‹æ‰€å±cgroup
   â””â”€ cat /proc/<PID>/cgroup

â˜ 2. æ£€æŸ¥cgroupå±‚æ¬¡ç»“æ„
   â””â”€ systemd-cgls

â˜ 3. éªŒè¯èµ„æºé™åˆ¶è®¾ç½®
   â””â”€ cat /sys/fs/cgroup/*/é™åˆ¶æ–‡ä»¶

â˜ 4. æŸ¥çœ‹å®é™…èµ„æºä½¿ç”¨
   â””â”€ cat /sys/fs/cgroup/*/ä½¿ç”¨ç»Ÿè®¡æ–‡ä»¶

â˜ 5. æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¢«é™åˆ¶
   â””â”€ dmesg | grep -i oom
```

### 7.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**âš ï¸ å¸¸è§é—®é¢˜ç±»å‹**

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ€è·¯ |
|----------|----------|----------|
| è¿›ç¨‹çœ‹ä¸åˆ°å…¶ä»–è¿›ç¨‹ | PID namespaceéš”ç¦» | æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„PID namespace |
| ç½‘ç»œä¸é€š | ç½‘ç»œnamespaceéš”ç¦» | æ£€æŸ¥ç½‘ç»œæ¥å£å’Œè·¯ç”±é…ç½® |
| æ–‡ä»¶ç³»ç»Ÿå¼‚å¸¸ | æŒ‚è½½namespaceé—®é¢˜ | æ£€æŸ¥æŒ‚è½½ç‚¹å’Œæ–‡ä»¶ç³»ç»Ÿæƒé™ |
| å†…å­˜ä¸è¶³é”™è¯¯ | cgroupå†…å­˜é™åˆ¶ | æ£€æŸ¥memory cgroupè®¾ç½® |
| CPUä½¿ç”¨ç‡ä½ | cgroup CPUé™åˆ¶ | æ£€æŸ¥cpu cgroupé…ç½® |

### 7.4 è°ƒè¯•è„šæœ¬ç¤ºä¾‹


**ğŸ”§ è‡ªåŠ¨åŒ–æ£€æŸ¥è„šæœ¬**
```bash
#!/bin/bash
# namespaceå’Œcgroupå¿«é€Ÿæ£€æŸ¥è„šæœ¬

PID=$1
if [ -z "$PID" ]; then
    echo "ç”¨æ³•: $0 <è¿›ç¨‹PID>"
    exit 1
fi

echo "=== è¿›ç¨‹ $PID çš„ Namespace ä¿¡æ¯ ==="
lsns -p $PID

echo -e "\n=== Namespace è¯¦ç»†ä¿¡æ¯ ==="
ls -la /proc/$PID/ns/

echo -e "\n=== Cgroup ä¿¡æ¯ ==="  
cat /proc/$PID/cgroup

echo -e "\n=== ç³»ç»Ÿèµ„æºä½¿ç”¨ ==="
ps -o pid,ppid,cmd,cgroup $PID
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„è°ƒè¯•å·¥å…·


**ğŸ”¸ æŸ¥çœ‹å·¥å…·**
- `lsns`ï¼šæŸ¥çœ‹ç³»ç»Ÿæ‰€æœ‰namespaceä¿¡æ¯
- `systemd-cgls`ï¼šæŸ¥çœ‹cgroupså±‚æ¬¡ç»“æ„
- `/procæ–‡ä»¶ç³»ç»Ÿ`ï¼šè·å–è¿›ç¨‹è¯¦ç»†ä¿¡æ¯

**ğŸ”¸ æ“ä½œå·¥å…·**  
- `nsenter`ï¼šè¿›å…¥æŒ‡å®šè¿›ç¨‹çš„namespaceç¯å¢ƒ
- `unshare`ï¼šåˆ›å»ºæ–°çš„namespaceç¯å¢ƒ
- `strace`ï¼šè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ’¡ namespaceè°ƒè¯•æ€è·¯**
```
è°ƒè¯•namespaceé—®é¢˜çš„æ€ç»´è¿‡ç¨‹ï¼š
1. å…ˆç¡®è®¤è¿›ç¨‹åœ¨å“ªä¸ªnamespace
2. å†æ£€æŸ¥namespaceæ˜¯å¦æ­£ç¡®éš”ç¦»
3. æœ€åéªŒè¯åŠŸèƒ½æ˜¯å¦ç¬¦åˆé¢„æœŸ
```

**ğŸ’¡ cgroupsè°ƒè¯•æ€è·¯**  
```
è°ƒè¯•cgroupsé—®é¢˜çš„æ€ç»´è¿‡ç¨‹ï¼š
1. ç¡®è®¤è¿›ç¨‹å½’å±çš„cgroup
2. æ£€æŸ¥cgroupçš„èµ„æºé™åˆ¶è®¾ç½®
3. å¯¹æ¯”å®é™…ä½¿ç”¨æƒ…å†µå’Œé™åˆ¶å€¼
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ å®¹å™¨æŠ€æœ¯åº”ç”¨**
- **Dockerè°ƒè¯•**ï¼šæ’æŸ¥å®¹å™¨å¯åŠ¨å’Œè¿è¡Œé—®é¢˜
- **ç½‘ç»œéš”ç¦»**ï¼šè§£å†³å®¹å™¨ç½‘ç»œè¿é€šæ€§é—®é¢˜  
- **èµ„æºé™åˆ¶**ï¼šä¼˜åŒ–å®¹å™¨èµ„æºä½¿ç”¨æ•ˆç‡
- **å®‰å…¨éš”ç¦»**ï¼šç¡®ä¿è¿›ç¨‹é—´çš„æ­£ç¡®éš”ç¦»

**ğŸ”§ ç³»ç»Ÿè¿ç»´åº”ç”¨**
- **è¿›ç¨‹ç®¡ç†**ï¼šç†è§£ç³»ç»Ÿè¿›ç¨‹çš„ç»„ç»‡ç»“æ„
- **æ€§èƒ½è°ƒä¼˜**ï¼šåŸºäºcgroupsè¿›è¡Œèµ„æºç®¡ç†
- **æ•…éšœæ’æŸ¥**ï¼šå¿«é€Ÿå®šä½namespaceå’Œcgroupsç›¸å…³é—®é¢˜

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- lsnsæŸ¥çœ‹ç©ºé—´åˆ—è¡¨ï¼Œnsenterè¿›å…¥åšæµ‹è¯•
- systemd-cglsçœ‹å±‚æ¬¡ï¼Œ/procç›®å½•æœ‰è¯¦ç»†  
- straceè·Ÿè¸ªè°ƒç”¨è·¯å¾„ï¼Œé—®é¢˜æ’æŸ¥æœ‰ç« æ³•
- å…ˆæŸ¥å½’å±å†éªŒè¯ï¼Œèµ„æºé™åˆ¶è¦ç¡®è®¤