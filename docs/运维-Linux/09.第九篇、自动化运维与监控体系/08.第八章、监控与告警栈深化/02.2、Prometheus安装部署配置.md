---
title: 2、Prometheus安装部署配置
---
## 📚 目录

1. [Prometheus安装部署概述](#1-Prometheus安装部署概述)
2. [二进制安装与systemd配置](#2-二进制安装与systemd配置)
3. [Docker容器化部署](#3-Docker容器化部署)
4. [Kubernetes Operator部署](#4-Kubernetes-Operator部署)
5. [配置文件prometheus.yml详解](#5-配置文件prometheus.yml详解)
6. [启动参数与命令行选项](#6-启动参数与命令行选项)
7. [数据目录权限配置](#7-数据目录权限配置)
8. [网络端口与防火墙设置](#8-网络端口与防火墙设置)
9. [高可用部署架构](#9-高可用部署架构)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🎯 Prometheus安装部署概述


### 1.1 什么是Prometheus

**🔸 核心定义**
Prometheus是一个开源的系统监控和告警工具，**就像给你的服务器安装了一个"体检医生"**，定期收集各种健康数据，发现问题及时提醒你。

**🔹 Prometheus的本质作用**
- **数据收集器**：定时从各种目标（服务器、应用）收集指标数据
- **时序数据库**：将收集的数据按时间顺序存储
- **查询引擎**：提供强大的PromQL语言查询数据
- **告警触发器**：根据设定规则触发告警

### 1.2 Prometheus工作原理

**🔄 监控流程图**
```
目标服务                Prometheus服务器           告警管理
   │                       │                      │
   │──[指标暴露]──────────→│                      │
   │  /metrics接口         │                      │
   │                       │──[数据收集]─────────→│时序数据库
   │                       │  每15秒拉取一次        │(TSDB)
   │                       │                      │
   │                       │──[规则计算]─────────→│告警规则
   │                       │  检查告警条件          │
   │                       │                      │
   │                       │──[发送告警]─────────→│Alertmanager
```

**💡 工作机制核心理解**
- **拉取模式**：Prometheus主动去目标服务拉取数据，不是被动接收
- **HTTP协议**：通过HTTP GET请求获取`/metrics`端点的数据
- **时间序列**：所有数据都带时间戳，形成时间序列数据
- **标签系统**：通过标签区分不同维度的数据

### 1.3 部署方式对比


| 部署方式 | **适用场景** | **复杂度** | **维护成本** | **扩展性** |
|---------|-------------|----------|-------------|----------|
| 🖥️ **二进制** | `测试环境、小规模部署` | `★☆☆` | `★★☆` | `★☆☆` |
| 🐳 **Docker** | `快速部署、开发环境` | `★★☆` | `★☆☆` | `★★☆` |
| ☸️ **Kubernetes** | `生产环境、大规模集群` | `★★★` | `★★★` | `★★★` |

---

## 2. 🛠️ 二进制安装与systemd配置


### 2.1 下载与安装Prometheus


**📥 获取Prometheus程序**
```bash
# 下载最新版本(以2.47.0为例)
cd /opt
wget https://github.com/prometheus/prometheus/releases/download/v2.47.0/prometheus-2.47.0.linux-amd64.tar.gz

# 解压安装
tar xvf prometheus-2.47.0.linux-amd64.tar.gz
mv prometheus-2.47.0.linux-amd64 prometheus
```

**👤 创建运行用户**
```bash
# 创建专用用户(安全考虑)
useradd --no-create-home --shell /bin/false prometheus

# 创建必要目录
mkdir /etc/prometheus
mkdir /var/lib/prometheus

# 设置目录权限
chown prometheus:prometheus /etc/prometheus
chown prometheus:prometheus /var/lib/prometheus
```

### 2.2 systemd服务配置


**📝 创建systemd服务文件**
```bash
# 创建服务配置文件
cat > /etc/systemd/system/prometheus.service << EOF
[Unit]
Description=Prometheus Server
Documentation=https://prometheus.io/docs/
After=network-online.target

[Service]
User=prometheus
Restart=on-failure
ExecStart=/opt/prometheus/prometheus \\
  --config.file=/etc/prometheus/prometheus.yml \\
  --storage.tsdb.path=/var/lib/prometheus/ \\
  --web.console.templates=/opt/prometheus/consoles \\
  --web.console.libraries=/opt/prometheus/console_libraries \\
  --web.listen-address=0.0.0.0:9090

[Install]
WantedBy=multi-user.target
EOF
```

**🔧 参数说明**
- `--config.file`：指定配置文件路径
- `--storage.tsdb.path`：数据存储目录
- `--web.listen-address`：Web界面监听地址和端口

**🚀 启动服务**
```bash
# 重载systemd配置
systemctl daemon-reload

# 启动并设置开机自启
systemctl start prometheus
systemctl enable prometheus

# 检查服务状态
systemctl status prometheus
```

> 💡 **安装提示**  
> 二进制安装适合小规模环境，配置简单直接，但需要手动管理更新和依赖

### 2.3 基础配置验证


**✅ 安装验证步骤**
```bash
# 1. 检查进程是否运行
ps aux | grep prometheus

# 2. 检查端口是否监听
netstat -tlnp | grep 9090

# 3. 检查Web界面访问
curl http://localhost:9090
```

**🌐 Web界面访问**
打开浏览器访问 `http://your-server-ip:9090`，应该能看到Prometheus的管理界面。

---

## 3. 🐳 Docker容器化部署


### 3.1 Docker单容器部署


**📦 快速启动容器**
```bash
# 拉取官方镜像
docker pull prom/prometheus:latest

# 创建数据目录
mkdir -p /docker/prometheus/{data,config}

# 创建基础配置文件
cat > /docker/prometheus/config/prometheus.yml << EOF
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
EOF

# 启动容器
docker run -d \
  --name prometheus \
  -p 9090:9090 \
  -v /docker/prometheus/config:/etc/prometheus \
  -v /docker/prometheus/data:/prometheus \
  prom/prometheus:latest \
  --config.file=/etc/prometheus/prometheus.yml \
  --storage.tsdb.path=/prometheus \
  --web.console.templates=/etc/prometheus/consoles \
  --web.console.libraries=/etc/prometheus/console_libraries \
  --web.listen-address=0.0.0.0:9090
```

### 3.2 Docker Compose部署


**📝 编写docker-compose.yml**
```yaml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.listen-address=0.0.0.0:9090'
    restart: unless-stopped
    networks:
      - monitoring

volumes:
  prometheus-data:

networks:
  monitoring:
    driver: bridge
```

**🚀 启动服务栈**
```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs prometheus
```

> ⚠️ **容器部署注意**  
> Docker部署适合快速测试和开发环境，但生产环境需要考虑数据持久化和备份

### 3.3 容器健康检查


**🔍 添加健康检查**
```yaml
# 在docker-compose.yml中添加
healthcheck:
  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s
```

---

## 4. ☸️ Kubernetes Operator部署


### 4.1 Prometheus Operator概述


**🎯 Operator的作用**
Prometheus Operator是Kubernetes上部署Prometheus的**"智能管家"**，它能：
- **自动化管理**：自动部署、配置、更新Prometheus
- **CRD支持**：通过自定义资源定义管理监控配置
- **服务发现**：自动发现Kubernetes中的监控目标

**📋 核心资源类型**
- `Prometheus`：定义Prometheus实例
- `ServiceMonitor`：定义监控目标
- `PrometheusRule`：定义告警规则
- `Alertmanager`：定义告警管理器

### 4.2 安装Prometheus Operator


**🛠️ 使用Helm安装**
```bash
# 添加prometheus社区helm仓库
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# 创建命名空间
kubectl create namespace monitoring

# 安装kube-prometheus-stack
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=50Gi \
  --set prometheus.prometheusSpec.retention=30d
```

### 4.3 自定义Prometheus配置


**📝 创建Prometheus实例**
```yaml
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: prometheus-main
  namespace: monitoring
spec:
  replicas: 2
  retention: 30d
  storage:
    volumeClaimTemplate:
      spec:
        resources:
          requests:
            storage: 50Gi
        storageClassName: fast-ssd
  serviceMonitorSelector:
    matchLabels:
      team: frontend
  ruleSelector:
    matchLabels:
      prometheus: main
  resources:
    requests:
      memory: 2Gi
      cpu: 1000m
    limits:
      memory: 4Gi
      cpu: 2000m
```

**📊 创建ServiceMonitor**
```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: my-app-monitor
  namespace: monitoring
  labels:
    team: frontend
spec:
  selector:
    matchLabels:
      app: my-application
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
```

> 🎯 **Operator优势**  
> Kubernetes Operator部署方式适合大规模生产环境，提供了声明式配置和自动化运维能力

---

## 5. 📋 配置文件prometheus.yml详解


### 5.1 配置文件基本结构


**🏗️ 配置文件架构图**
```
prometheus.yml
├── global                 ← 全局配置
├── alerting              ← 告警配置  
├── rule_files            ← 告警规则文件
├── scrape_configs        ← 数据采集配置
└── remote_write/read     ← 远程存储配置
```

### 5.2 global全局配置段


**🌐 基础全局配置**
```yaml
global:
  # 数据采集间隔(默认1分钟)
  scrape_interval: 15s
  
  # 规则评估间隔
  evaluation_interval: 15s
  
  # 添加到所有指标的标签
  external_labels:
    cluster: 'production'
    region: 'us-west-1'
```

**🔧 参数详细说明**

| 配置项 | **作用** | **默认值** | **建议值** |
|-------|---------|-----------|-----------|
| `scrape_interval` | 采集数据的时间间隔 | `1m` | `15s-30s` |
| `evaluation_interval` | 告警规则评估间隔 | `1m` | `15s` |
| `scrape_timeout` | 单次采集超时时间 | `10s` | `10s` |
| `external_labels` | 外部标签(用于联邦) | `无` | `按需设置` |

### 5.3 scrape_configs采集配置


**📊 静态配置示例**
```yaml
scrape_configs:
  # 监控Prometheus自身
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    
  # 监控Node Exporter
  - job_name: 'node-exporter'
    static_configs:
      - targets: 
          - '192.168.1.10:9100'
          - '192.168.1.11:9100'
          - '192.168.1.12:9100'
    scrape_interval: 30s
    metrics_path: /metrics
```

**🔍 服务发现配置**
```yaml
scrape_configs:
  # Kubernetes服务发现
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
            - default
            - monitoring
    
    # 重新标记规则
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)

  # 文件服务发现
  - job_name: 'file-discovery'
    file_sd_configs:
      - files:
          - '/etc/prometheus/targets/*.yml'
        refresh_interval: 5m
```

### 5.4 告警相关配置


**🚨 告警管理器配置**
```yaml
# 告警管理器配置
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - "alertmanager:9093"
      path_prefix: /
      scheme: http

# 告警规则文件
rule_files:
  - "rules/*.yml"
  - "alerts/*.yml"
```

**📜 告警规则示例文件**
```yaml
# /etc/prometheus/rules/node-alerts.yml
groups:
  - name: node-alerts
    rules:
      - alert: HighCPUUsage
        expr: 100 - (avg(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is above 80% for more than 2 minutes"
      
      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High memory usage detected"
```

> 📖 **配置理解要点**  
> prometheus.yml是Prometheus的"大脑"，告诉它从哪里收集数据、如何处理数据、什么时候发送告警

---

## 6. ⚙️ 启动参数与命令行选项


### 6.1 核心启动参数


**🔧 必需参数详解**
```bash
# 完整启动命令示例
./prometheus \
  --config.file=prometheus.yml \           # 配置文件路径
  --storage.tsdb.path=./data \             # 数据存储路径
  --web.listen-address=0.0.0.0:9090 \     # Web界面监听地址
  --web.console.templates=./consoles \      # 控制台模板目录
  --web.console.libraries=./console_libraries  # 控制台库目录
```

### 6.2 存储相关参数


**💾 TSDB存储配置**
```bash
# 存储相关的详细参数
./prometheus \
  --storage.tsdb.path=./data \                    # 数据目录
  --storage.tsdb.retention.time=15d \             # 数据保留时间
  --storage.tsdb.retention.size=50GB \            # 数据保留大小
  --storage.tsdb.min-block-duration=2h \          # 最小块持续时间
  --storage.tsdb.max-block-duration=36h \         # 最大块持续时间
  --storage.tsdb.wal-compression \                # WAL压缩
  --storage.tsdb.allow-overlapping-blocks         # 允许重叠块
```

**📊 存储参数说明表**

| 参数 | **作用** | **默认值** | **推荐设置** |
|-----|---------|-----------|-------------|
| `retention.time` | 数据保留时间 | `15d` | `30d-90d` |
| `retention.size` | 数据保留大小 | `0`(无限制) | `根据磁盘容量` |
| `min-block-duration` | 最小数据块时间 | `2h` | `2h` |
| `max-block-duration` | 最大数据块时间 | `36h` | `36h` |

### 6.3 Web界面相关参数


**🌐 Web配置选项**
```bash
# Web界面详细配置
./prometheus \
  --web.listen-address=0.0.0.0:9090 \        # 监听地址
  --web.external-url=http://prometheus.company.com \  # 外部访问URL
  --web.route-prefix=/ \                       # 路由前缀
  --web.max-connections=512 \                  # 最大连接数
  --web.read-timeout=5m \                      # 读取超时
  --web.enable-lifecycle \                     # 启用生命周期API
  --web.enable-admin-api                       # 启用管理API
```

### 6.4 性能调优参数


**⚡ 性能相关配置**
```bash
# 查询性能优化
./prometheus \
  --query.max-concurrency=20 \              # 最大并发查询数
  --query.timeout=2m \                       # 查询超时时间
  --query.max-samples=50000000 \             # 单次查询最大样本数
  --query.lookback-delta=5m                  # 查询回看时间窗口
```

**🧠 内存与CPU参数**
```bash
# 资源限制配置
export GOMAXPROCS=4                          # 限制CPU核心数
export GOMEMLIMIT=8GiB                       # 内存限制(Go 1.19+)

./prometheus \
  --storage.tsdb.head-chunks-write-queue-size=100000  # 写入队列大小
```

> ⚡ **性能提示**  
> 合理设置启动参数可以显著提升Prometheus性能，特别是在大规模环境中

---

## 7. 🔐 数据目录权限配置


### 7.1 目录结构与权限


**📁 标准目录布局**
```
/var/lib/prometheus/          ← 主数据目录
├── chunks_head/              ← 内存中数据块
├── wal/                      ← 写入日志
├── 01ABCD...XYZ/            ← 数据块目录
│   ├── chunks/              ← 压缩数据块
│   ├── index                ← 索引文件
│   └── meta.json           ← 元数据
└── lock                     ← 锁文件
```

**🔒 权限设置命令**
```bash
# 创建Prometheus用户(如果不存在)
groupadd prometheus
useradd -r -g prometheus -s /bin/false prometheus

# 创建并设置数据目录权限
mkdir -p /var/lib/prometheus
chown -R prometheus:prometheus /var/lib/prometheus
chmod 755 /var/lib/prometheus

# 设置配置目录权限
mkdir -p /etc/prometheus
chown -R prometheus:prometheus /etc/prometheus
chmod 644 /etc/prometheus/prometheus.yml
```

### 7.2 安全权限原则


**🛡️ 最小权限原则**
```bash
# 数据目录权限 - 只有prometheus用户可读写
chmod 700 /var/lib/prometheus

# 配置文件权限 - 只有prometheus用户可读，root可写
chown root:prometheus /etc/prometheus/prometheus.yml
chmod 640 /etc/prometheus/prometheus.yml

# 二进制文件权限 - 所有人可执行
chmod 755 /opt/prometheus/prometheus
```

### 7.3 SELinux与AppArmor配置


**🔐 SELinux配置(RHEL/CentOS)**
```bash
# 设置SELinux标签
semanage fcontext -a -t admin_home_t "/var/lib/prometheus(/.*)?"
restorecon -R /var/lib/prometheus

# 创建SELinux策略(如需要)
setsebool -P prometheus_can_network_connect 1
```

**🛡️ AppArmor配置(Ubuntu/Debian)**
```bash
# 创建AppArmor配置文件
cat > /etc/apparmor.d/prometheus << EOF
#include <tunables/global>

/opt/prometheus/prometheus {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  /opt/prometheus/prometheus mr,
  /etc/prometheus/** r,
  /var/lib/prometheus/** rw,
  /proc/sys/net/core/somaxconn r,
  
  network inet tcp,
  network inet udp,
}
EOF

# 加载配置
apparmor_parser -r /etc/apparmor.d/prometheus
```

> 🔒 **安全建议**  
> 正确的权限配置是系统安全的基础，建议使用专门的用户运行Prometheus，避免使用root权限

---

## 8. 🌐 网络端口与防火墙设置


### 8.1 Prometheus默认端口


**📊 端口使用说明**

| 组件 | **默认端口** | **协议** | **用途** |
|-----|------------|---------|---------|
| Prometheus | `9090` | `HTTP` | Web界面和API |
| Alertmanager | `9093` | `HTTP` | 告警管理界面 |
| Node Exporter | `9100` | `HTTP` | 节点监控指标 |
| Pushgateway | `9091` | `HTTP` | 指标推送网关 |

### 8.2 防火墙配置


**🔥 iptables规则配置**
```bash
# 允许Prometheus Web端口访问
iptables -A INPUT -p tcp --dport 9090 -j ACCEPT

# 允许来自监控网段的访问
iptables -A INPUT -p tcp -s 192.168.1.0/24 --dport 9090 -j ACCEPT

# 保存规则
iptables-save > /etc/iptables/rules.v4
```

**🛡️ firewalld配置(RHEL/CentOS)**
```bash
# 开放Prometheus端口
firewall-cmd --permanent --add-port=9090/tcp
firewall-cmd --reload

# 创建监控服务规则
firewall-cmd --permanent --new-service=prometheus
firewall-cmd --permanent --service=prometheus --set-short="Prometheus Monitoring"
firewall-cmd --permanent --service=prometheus --add-port=9090/tcp
firewall-cmd --permanent --add-service=prometheus
firewall-cmd --reload
```

**🔐 ufw配置(Ubuntu)**
```bash
# 允许Prometheus端口
ufw allow 9090/tcp

# 允许特定来源访问
ufw allow from 192.168.1.0/24 to any port 9090
```

### 8.3 网络连接验证


**✅ 连接测试步骤**
```bash
# 1. 检查端口监听
netstat -tlnp | grep 9090
ss -tlnp | grep 9090

# 2. 本地连接测试
curl -I http://localhost:9090

# 3. 远程连接测试
telnet your-prometheus-server 9090

# 4. HTTP响应测试
curl -s http://your-prometheus-server:9090/api/v1/status/config | jq .
```

**🔍 网络故障排查**
```bash
# 检查进程监听
lsof -i :9090

# 检查防火墙状态
iptables -L -n | grep 9090
firewall-cmd --list-all

# 检查路由和连通性
traceroute your-prometheus-server
ping your-prometheus-server
```

---

## 9. 🏗️ 高可用部署架构


### 9.1 高可用架构设计原理


**🎯 高可用的核心概念**
高可用就是让监控系统**"永不宕机"**，即使单台服务器出问题，整个监控体系依然正常工作。

**📊 HA架构组件图**
```
                    负载均衡器
                   (HAProxy/Nginx)
                         │
        ┌────────────────┼────────────────┐
        │                │                │
   Prometheus-1     Prometheus-2     Prometheus-3
   (Active)         (Active)         (Active)
        │                │                │
        └────────────────┼────────────────┘
                         │
                   共享存储/联邦
                  (NFS/Remote Storage)
```

### 9.2 Prometheus联邦架构


**🔗 联邦部署模式**
```yaml
# 全局Prometheus配置
global:
  scrape_interval: 30s

scrape_configs:
  # 从局部Prometheus联邦数据
  - job_name: 'federate'
    scrape_interval: 15s
    metrics_path: '/federate'
    params:
      'match[]':
        - '{job="prometheus"}'           # 联邦prometheus自身指标
        - '{__name__=~"job:.*"}'        # 联邦聚合指标
        - '{__name__=~"instance:.*"}'   # 联邦实例指标
    static_configs:
      - targets:
        - 'prometheus-region-1:9090'
        - 'prometheus-region-2:9090'
        - 'prometheus-region-3:9090'
```

**🏢 联邦架构层次**
```
            全局Prometheus
           (Global/Central)
                  │
        ┌─────────┼─────────┐
        │         │         │
   区域Prometheus 区域Prometheus 区域Prometheus
   (Region-1)    (Region-2)    (Region-3)
        │         │         │
   ┌────┼────┐ ┌──┼──┐ ┌─────┼─────┐
   │    │    │ │  │  │ │     │     │
  Node Node  │Node │ Node   Node  Node
       App       App        App
```

### 9.3 远程存储高可用


**☁️ 远程存储配置**
```yaml
# Prometheus配置 - 写入远程存储
remote_write:
  - url: "http://thanos-receive:19291/api/v1/receive"
    queue_config:
      max_samples_per_send: 1000
      max_shards: 200
      capacity: 2500
  
  # VictoriaMetrics集群
  - url: "http://vminsert:8480/insert/0/prometheus/"
    queue_config:
      max_samples_per_send: 10000

# 从远程存储读取
remote_read:
  - url: "http://thanos-query:9090/api/v1/query"
    read_recent: true
```

### 9.4 Kubernetes高可用部署


**☸️ StatefulSet部署**
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: prometheus
  namespace: monitoring
spec:
  serviceName: prometheus
  replicas: 3
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - name: prometheus
        image: prom/prometheus:v2.47.0
        args:
          - '--config.file=/etc/prometheus/prometheus.yml'
          - '--storage.tsdb.path=/prometheus'
          - '--web.listen-address=0.0.0.0:9090'
          - '--web.enable-lifecycle'
        ports:
        - containerPort: 9090
        volumeMounts:
        - name: config
          mountPath: /etc/prometheus
        - name: storage
          mountPath: /prometheus
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
      volumes:
      - name: config
        configMap:
          name: prometheus-config
  volumeClaimTemplates:
  - metadata:
      name: storage
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 100Gi
      storageClassName: fast-ssd
```

### 9.5 负载均衡配置


**⚖️ HAProxy配置**
```haproxy
# /etc/haproxy/haproxy.cfg
global
    daemon
    maxconn 4096

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# Prometheus集群负载均衡
frontend prometheus_frontend
    bind *:9090
    default_backend prometheus_backend

backend prometheus_backend
    balance roundrobin
    option httpchk GET /api/v1/status/ready
    server prometheus-1 192.168.1.10:9090 check
    server prometheus-2 192.168.1.11:9090 check
    server prometheus-3 192.168.1.12:9090 check
```

**🌐 Nginx负载均衡**
```nginx
upstream prometheus_cluster {
    server 192.168.1.10:9090 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:9090 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:9090 max_fails=3 fail_timeout=30s;
}

server {
    listen 9090;
    location / {
        proxy_pass http://prometheus_cluster;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # 健康检查
        proxy_connect_timeout 10s;
        proxy_read_timeout 30s;
    }
}
```

> 🏗️ **高可用要点**  
> 高可用不是简单的多实例，需要考虑数据一致性、故障切换、负载分担等多个方面

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


**🔸 部署方式选择**
```
二进制部署：测试环境、简单场景
Docker部署：开发环境、快速验证
Kubernetes部署：生产环境、大规模集群
```

**🔸 配置文件理解**
```
prometheus.yml是核心：定义数据采集、告警、存储规则
global段：全局配置，影响整个系统行为
scrape_configs段：核心业务逻辑，定义监控什么
```

**🔸 权限与安全**
```
专用用户运行：prometheus用户，非root
目录权限：数据目录700，配置文件640
网络安全：防火墙规则，端口访问控制
```

### 10.2 关键理解要点


**🔹 监控数据流向**
```
目标服务 → Prometheus拉取 → TSDB存储 → PromQL查询 → 告警触发
理解这个流程是掌握Prometheus的基础
```

**🔹 配置文件的重要性**
```
prometheus.yml是"大脑"：
- 告诉Prometheus从哪里收集数据
- 如何处理和存储数据  
- 什么时候触发告警
- 如何与其他组件协作
```

**🔹 高可用的本质**
```
不是简单的多实例：
- 需要数据一致性(联邦/远程存储)
- 需要负载分担(负载均衡器)
- 需要故障切换(健康检查)
- 需要数据备份(持久化存储)
```

### 10.3 实际部署指导


**📝 部署前检查清单**
- [ ] 确定部署方式(二进制/Docker/K8s)
- [ ] 规划存储容量和保留策略
- [ ] 设计网络架构和端口规划
- [ ] 配置用户权限和安全策略
- [ ] 准备监控目标和采集配置

**🎯 生产环境建议**
- **存储规划**：按每个采集目标每天100MB估算存储需求
- **性能调优**：根据采集频率和目标数量调整参数
- **监控监控者**：为Prometheus本身设置监控和告警
- **备份策略**：定期备份配置文件和关键数据

**🔧 常见问题处理**
```
启动失败：检查配置文件语法、权限、端口占用
数据丢失：检查存储权限、磁盘空间、TSDB健康状态
查询缓慢：检查时间范围、样本数量、资源限制
告警不触发：检查规则语法、评估间隔、Alertmanager配置
```

**核心记忆口诀**：
- Prometheus部署有三途：二进制、容器、K8s
- 配置文件是关键，权限安全不能忘
- 高可用需设计，联邦存储加均衡
- 监控系统要监控，备份策略保平安