---
title: 4ã€PromQLæŸ¥è¯¢è¯­è¨€ç²¾é€š
---
## ğŸ“š ç›®å½•


1. [PromQLåŸºç¡€æ¦‚å¿µ](#1-promqlåŸºç¡€æ¦‚å¿µ)
2. [åŸºç¡€æŸ¥è¯¢è¯­æ³•ä¸æ“ä½œç¬¦](#2-åŸºç¡€æŸ¥è¯¢è¯­æ³•ä¸æ“ä½œç¬¦)
3. [å³æ—¶å‘é‡ä¸èŒƒå›´å‘é‡æŸ¥è¯¢](#3-å³æ—¶å‘é‡ä¸èŒƒå›´å‘é‡æŸ¥è¯¢)
4. [èšåˆå‡½æ•°ä¸æ—¶é—´å‡½æ•°](#4-èšåˆå‡½æ•°ä¸æ—¶é—´å‡½æ•°)
5. [æ ‡ç­¾åŒ¹é…ä¸è¿‡æ»¤è¯­æ³•](#5-æ ‡ç­¾åŒ¹é…ä¸è¿‡æ»¤è¯­æ³•)
6. [æ•°å­¦è¿ç®—ä¸æ¯”è¾ƒæ“ä½œ](#6-æ•°å­¦è¿ç®—ä¸æ¯”è¾ƒæ“ä½œ)
7. [å­æŸ¥è¯¢ä¸åµŒå¥—æŸ¥è¯¢](#7-å­æŸ¥è¯¢ä¸åµŒå¥—æŸ¥è¯¢)
8. [ç›´æ–¹å›¾ä¸æ‘˜è¦æŒ‡æ ‡æŸ¥è¯¢](#8-ç›´æ–¹å›¾ä¸æ‘˜è¦æŒ‡æ ‡æŸ¥è¯¢)
9. [æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–æŠ€å·§](#9-æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–æŠ€å·§)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

# ğŸ¯ **å­¦ä¹ å¯¼èˆª**


**å‰ç½®çŸ¥è¯†**ï¼šPrometheusåŸºç¡€æ¦‚å¿µã€ç›‘æ§æŒ‡æ ‡ç±»å‹ â†’ **å½“å‰å†…å®¹**ï¼šPromQLæŸ¥è¯¢è¯­è¨€ â†’ **åç»­å­¦ä¹ **ï¼šGrafanaå¯è§†åŒ–ã€Alertmanagerå‘Šè­¦

â±ï¸ **é¢„è®¡å­¦ä¹ æ—¶é—´**ï¼šæœ¬ç« é¢„è®¡90åˆ†é’Ÿ | å®è·µç»ƒä¹ 60åˆ†é’Ÿ

ğŸ·ï¸ **çŸ¥è¯†æ ‡ç­¾**ï¼š`#æ ¸å¿ƒæŠ€èƒ½` `#å¿…æŒæ¡` `#å®æˆ˜å¯¼å‘`

---

## 1. ğŸ” PromQLåŸºç¡€æ¦‚å¿µ



### 1.1 ä»€ä¹ˆæ˜¯PromQL



**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
PromQLï¼ˆPrometheus Query Languageï¼‰æ˜¯Prometheusçš„ä¸“ç”¨æŸ¥è¯¢è¯­è¨€ï¼Œç”¨äºä»æ—¶åºæ•°æ®åº“ä¸­æ£€ç´¢å’Œåˆ†æç›‘æ§æ•°æ®ã€‚

**ğŸ’¡ é€šä¿—ç†è§£**
æƒ³è±¡ä½ æœ‰ä¸€ä¸ªè£…æ»¡å„ç§ä¼ æ„Ÿå™¨æ•°æ®çš„ä»“åº“ï¼š
- **æ™®é€šæŸ¥æ‰¾**ï¼šåœ¨çº¸è´¨è®°å½•ä¸­ç¿»æ‰¾æ¸©åº¦æ•°æ®
- **PromQL**ï¼šç”¨ä¸“ä¸šå·¥å…·å¿«é€Ÿæ‰¾åˆ°"è¿‡å»1å°æ—¶CPUä½¿ç”¨ç‡è¶…è¿‡80%çš„æœåŠ¡å™¨"

### 1.2 PromQLçš„æ ¸å¿ƒç‰¹æ€§



**ğŸŒŸ ä¸»è¦ç‰¹ç‚¹**
```
æ—¶åºæ•°æ®ä¸“ç”¨ï¼šä¸“é—¨ä¸ºæ—¶é—´åºåˆ—æ•°æ®è®¾è®¡
å‘é‡åŒ–è®¡ç®—ï¼šæ”¯æŒæ‰¹é‡æ•°æ®å¤„ç†
å‡½æ•°å¼è¯­è¨€ï¼šé€šè¿‡å‡½æ•°ç»„åˆå®ç°å¤æ‚æŸ¥è¯¢
å®æ—¶æŸ¥è¯¢ï¼šæ”¯æŒå®æ—¶å’Œå†å²æ•°æ®æŸ¥è¯¢
```

### 1.3 æ•°æ®æ¨¡å‹å›é¡¾



**ğŸ“Š Prometheusæ•°æ®ç»“æ„**
```
æŒ‡æ ‡æ ¼å¼ï¼š
metric_name{label1="value1", label2="value2"} value timestamp

å®é™…ä¾‹å­ï¼š
http_requests_total{method="GET", status="200"} 1234 1609459200
cpu_usage_percent{instance="web01", job="nginx"} 85.5 1609459200
```

**ğŸ”¸ æ•°æ®ç±»å‹è¯´æ˜**
- **å³æ—¶å‘é‡**ï¼šæŸä¸€æ—¶åˆ»çš„æ‰€æœ‰æ ·æœ¬ç‚¹
- **èŒƒå›´å‘é‡**ï¼šä¸€æ®µæ—¶é—´å†…çš„æ ·æœ¬ç‚¹é›†åˆ
- **æ ‡é‡**ï¼šå•ä¸ªæ•°å€¼
- **å­—ç¬¦ä¸²**ï¼šæ–‡æœ¬å€¼ï¼ˆè¾ƒå°‘ä½¿ç”¨ï¼‰

---

## 2. ğŸ”¤ åŸºç¡€æŸ¥è¯¢è¯­æ³•ä¸æ“ä½œç¬¦



### 2.1 æœ€ç®€å•çš„æŸ¥è¯¢



**ğŸ“ åŸºç¡€è¯­æ³•**

é€‰æ‹©æŒ‡æ ‡ï¼šç›´æ¥è¾“å…¥æŒ‡æ ‡åç§°
```
up
http_requests_total
cpu_usage_percent
```

è¿™å°±åƒåœ¨ä»“åº“é‡Œå–Šä¸€ä¸ªç‰©å“åç§°ï¼Œæ‰€æœ‰ç›¸å…³çš„éƒ½ä¼šè¢«æ‰¾å‡ºæ¥ã€‚

### 2.2 ç®—æœ¯æ“ä½œç¬¦



**â• æ•°å­¦è®¡ç®—ç¬¦å·**

| **æ“ä½œç¬¦** | **å«ä¹‰** | **ç¤ºä¾‹** | **è¯´æ˜** |
|-----------|----------|----------|----------|
| `+` | åŠ æ³• | `cpu_user + cpu_system` | CPUç”¨æˆ·æ€+ç³»ç»Ÿæ€ |
| `-` | å‡æ³• | `memory_total - memory_used` | è®¡ç®—å¯ç”¨å†…å­˜ |
| `*` | ä¹˜æ³• | `disk_size * 0.8` | è®¡ç®—80%å®¹é‡ |
| `/` | é™¤æ³• | `requests_success / requests_total` | æˆåŠŸç‡è®¡ç®— |
| `%` | å–æ¨¡ | `time() % 3600` | è·å–å°æ—¶å†…ç§’æ•° |
| `^` | å¹‚è¿ç®— | `base_value ^ 2` | å¹³æ–¹è®¡ç®— |

**ğŸ’¡ å®ç”¨ç¤ºä¾‹**
```
# è®¡ç®—å†…å­˜ä½¿ç”¨ç‡

(memory_total - memory_available) / memory_total * 100

# è®¡ç®—ç½‘ç»œIOæ€»é‡

network_receive_bytes + network_transmit_bytes

# è®¡ç®—ç£ç›˜ä½¿ç”¨ç‡

disk_used_bytes / disk_total_bytes * 100
```

### 2.3 æ¯”è¾ƒæ“ä½œç¬¦



**ğŸ” æ¯”è¾ƒåˆ¤æ–­ç¬¦å·**

| **æ“ä½œç¬¦** | **å«ä¹‰** | **è¿”å›å€¼** |
|-----------|----------|-----------|
| `==` | ç­‰äº | 1æˆ–0 |
| `!=` | ä¸ç­‰äº | 1æˆ–0 |
| `>` | å¤§äº | 1æˆ–0 |
| `<` | å°äº | 1æˆ–0 |
| `>=` | å¤§äºç­‰äº | 1æˆ–0 |
| `<=` | å°äºç­‰äº | 1æˆ–0 |

**ğŸ¯ å®é™…åº”ç”¨**
```
# æ‰¾å‡ºCPUä½¿ç”¨ç‡è¶…è¿‡80%çš„å®ä¾‹

cpu_usage_percent > 80

# æ‰¾å‡ºç£ç›˜ä½¿ç”¨ç‡ä½äº20%çš„ç£ç›˜

disk_usage_percent < 20

# æ‰¾å‡ºå†…å­˜ä½¿ç”¨ç­‰äº0çš„å¼‚å¸¸æƒ…å†µ

memory_usage_bytes == 0
```

### 2.4 é€»è¾‘æ“ä½œç¬¦



**ğŸ§® é€»è¾‘ç»„åˆç¬¦å·**

| **æ“ä½œç¬¦** | **å«ä¹‰** | **ç”¨é€”** |
|-----------|----------|----------|
| `and` | é€»è¾‘ä¸ | ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ |
| `or` | é€»è¾‘æˆ– | ä»»ä¸€æ¡ä»¶æ»¡è¶³ |
| `unless` | é€»è¾‘é | æ’é™¤æŸäº›æ¡ä»¶ |

**âš¡ ç»„åˆæŸ¥è¯¢ç¤ºä¾‹**
```
# CPUé«˜ä¸”å†…å­˜ä¹Ÿé«˜çš„æœåŠ¡å™¨

(cpu_usage_percent > 80) and (memory_usage_percent > 85)

# CPUé«˜æˆ–å†…å­˜é«˜çš„æœåŠ¡å™¨

(cpu_usage_percent > 80) or (memory_usage_percent > 85)

# CPUä½¿ç”¨æ­£å¸¸ä½†æ’é™¤æµ‹è¯•ç¯å¢ƒ

cpu_usage_percent unless {job="test"}
```

---

## 3. ğŸ“Š å³æ—¶å‘é‡ä¸èŒƒå›´å‘é‡æŸ¥è¯¢



### 3.1 å³æ—¶å‘é‡æŸ¥è¯¢



**âš¡ å³æ—¶å‘é‡æ¦‚å¿µ**
å³æ—¶å‘é‡è¿”å›æ¯ä¸ªæ—¶åºåœ¨æŸä¸€æ—¶åˆ»çš„æœ€æ–°æ ·æœ¬å€¼ï¼Œå°±åƒæ‹ç…§ä¸€æ ·æŠ“å–å½“å‰çŠ¶æ€ã€‚

**ğŸ“ åŸºç¡€å³æ—¶å‘é‡**
```
# è·å–æ‰€æœ‰å®ä¾‹çš„å½“å‰CPUä½¿ç”¨ç‡

cpu_usage_percent

# è·å–ç‰¹å®šjobçš„HTTPè¯·æ±‚æ€»æ•°

http_requests_total{job="web"}

# è·å–æ‰€æœ‰upçŠ¶æ€

up
```

**ğŸ” å³æ—¶å‘é‡ç‰¹ç‚¹**
- æ¯ä¸ªæ—¶åºåªè¿”å›ä¸€ä¸ªæ•°æ®ç‚¹
- è¿”å›æœ€æ¥è¿‘æŸ¥è¯¢æ—¶é—´çš„æ ·æœ¬
- é€‚åˆå®æ—¶ç›‘æ§å’Œå‘Šè­¦

### 3.2 èŒƒå›´å‘é‡æŸ¥è¯¢



**ğŸ“ˆ èŒƒå›´å‘é‡æ¦‚å¿µ**
èŒƒå›´å‘é‡è¿”å›æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ‰€æœ‰æ ·æœ¬ç‚¹ï¼Œå°±åƒå½•åƒä¸€æ ·è®°å½•å†å²å˜åŒ–ã€‚

**â° æ—¶é—´èŒƒå›´è¯­æ³•**

| **æ—¶é—´å•ä½** | **ç¬¦å·** | **ç¤ºä¾‹** |
|-------------|----------|----------|
| ç§’ | `s` | `30s` |
| åˆ†é’Ÿ | `m` | `5m` |
| å°æ—¶ | `h` | `2h` |
| å¤© | `d` | `7d` |
| å‘¨ | `w` | `2w` |
| å¹´ | `y` | `1y` |

**ğŸ“Š èŒƒå›´å‘é‡ç¤ºä¾‹**
```
# è¿‡å»5åˆ†é’Ÿçš„CPUä½¿ç”¨ç‡æ•°æ®

cpu_usage_percent[5m]

# è¿‡å»1å°æ—¶çš„HTTPè¯·æ±‚æ•°æ®

http_requests_total[1h]

# è¿‡å»24å°æ—¶çš„ç£ç›˜IOæ•°æ®

disk_io_bytes[1d]
```

### 3.3 å‘é‡ç±»å‹è½¬æ¢



**ğŸ”„ å¸¸ç”¨è½¬æ¢åœºæ™¯**

**èŒƒå›´å‘é‡ â†’ å³æ—¶å‘é‡ï¼ˆä½¿ç”¨å‡½æ•°ï¼‰**
```
# è®¡ç®—5åˆ†é’Ÿå†…çš„å¹³å‡CPUä½¿ç”¨ç‡

avg_over_time(cpu_usage_percent[5m])

# è®¡ç®—1å°æ—¶å†…çš„è¯·æ±‚å¢é•¿ç‡

rate(http_requests_total[1h])

# è·å–è¿‡å»10åˆ†é’Ÿçš„æœ€å¤§å€¼

max_over_time(disk_usage_percent[10m])
```

> ğŸ’¡ **è®°å¿†æŠ€å·§**ï¼šèŒƒå›´å‘é‡éœ€è¦ç”¨å‡½æ•°"æŒ¤å‹"æˆå³æ—¶å‘é‡æ‰èƒ½åšç®—æœ¯è¿ç®—å’Œç»˜å›¾

---

## 4. ğŸ§® èšåˆå‡½æ•°ä¸æ—¶é—´å‡½æ•°



### 4.1 èšåˆå‡½æ•°è¯¦è§£



èšåˆå‡½æ•°æŠŠå¤šä¸ªæ—¶åºæ•°æ®"åˆå¹¶"æˆä¸€ä¸ªç»“æœï¼Œå°±åƒæŠŠå¤šä¸ªç­çº§çš„æˆç»©è®¡ç®—å‡ºå¹´çº§å¹³å‡åˆ†ã€‚

**ğŸ“Š å¸¸ç”¨èšåˆå‡½æ•°**

| **å‡½æ•°å** | **ä½œç”¨** | **ç¤ºä¾‹ç”¨æ³•** |
|-----------|----------|-------------|
| `sum()` | æ±‚å’Œ | `sum(cpu_usage_percent)` |
| `avg()` | å¹³å‡å€¼ | `avg(memory_usage_percent)` |
| `max()` | æœ€å¤§å€¼ | `max(disk_usage_percent)` |
| `min()` | æœ€å°å€¼ | `min(network_latency_ms)` |
| `count()` | è®¡æ•° | `count(up == 1)` |

**ğŸ¯ å®é™…åº”ç”¨åœºæ™¯**
```
# è®¡ç®—é›†ç¾¤æ€»CPUä½¿ç”¨é‡

sum(cpu_usage_percent) by (cluster)

# æ‰¾å‡ºå†…å­˜ä½¿ç”¨ç‡æœ€é«˜çš„å®ä¾‹

max(memory_usage_percent) by (instance)

# ç»Ÿè®¡åœ¨çº¿æœåŠ¡å™¨æ•°é‡

count(up == 1)

# è®¡ç®—å¹³å‡å“åº”æ—¶é—´

avg(http_request_duration_seconds)
```

### 4.2 åˆ†ç»„èšåˆï¼ˆby/withoutï¼‰



**ğŸ·ï¸ åˆ†ç»„è¯­æ³•**

**byå­å¥**ï¼šæŒ‰æŒ‡å®šæ ‡ç­¾åˆ†ç»„
```
# æŒ‰jobåˆ†ç»„è®¡ç®—CPUå¹³å‡å€¼

avg(cpu_usage_percent) by (job)

# æŒ‰å®ä¾‹å’Œjobåˆ†ç»„è®¡ç®—å†…å­˜ä½¿ç”¨

sum(memory_usage_bytes) by (instance, job)
```

**withoutå­å¥**ï¼šæ’é™¤æŒ‡å®šæ ‡ç­¾
```
# æ’é™¤instanceæ ‡ç­¾åèšåˆ

sum(http_requests_total) without (instance)

# æ’é™¤å¤šä¸ªæ ‡ç­¾

avg(cpu_usage_percent) without (core, mode)
```

> ğŸ¤” **ç†è§£å·®å¼‚**ï¼š`by`æ˜¯"åªä¿ç•™è¿™äº›æ ‡ç­¾"ï¼Œ`without`æ˜¯"æ’é™¤è¿™äº›æ ‡ç­¾"

### 4.3 æ—¶é—´å‡½æ•°å®¶æ—



æ—¶é—´å‡½æ•°ä¸“é—¨å¤„ç†éšæ—¶é—´å˜åŒ–çš„æ•°æ®ï¼Œå¸®æˆ‘ä»¬åˆ†æè¶‹åŠ¿å’Œå˜åŒ–ç‡ã€‚

**ğŸ“ˆ å˜åŒ–ç‡å‡½æ•°**

**rate() - æ¯ç§’å¹³å‡å˜åŒ–ç‡**
```
# HTTPè¯·æ±‚çš„æ¯ç§’è¯·æ±‚æ•°

rate(http_requests_total[5m])

# ç½‘ç»œæ¥æ”¶å­—èŠ‚çš„æ¯ç§’é€Ÿç‡

rate(network_receive_bytes[1m])
```

**irate() - ç¬æ—¶å˜åŒ–ç‡**
```
# åŸºäºæœ€æ–°ä¸¤ä¸ªæ•°æ®ç‚¹çš„ç¬æ—¶é€Ÿç‡

irate(cpu_seconds_total[5m])
```

**increase() - æ€»å¢é‡**
```
# è¿‡å»1å°æ—¶çš„è¯·æ±‚å¢é•¿æ•°é‡

increase(http_requests_total[1h])
```

**ğŸ“Š æ—¶é—´èŒƒå›´å‡½æ•°**

| **å‡½æ•°** | **ç”¨é€”** | **ç¤ºä¾‹** |
|---------|----------|----------|
| `avg_over_time()` | æ—¶é—´èŒƒå›´å¹³å‡å€¼ | `avg_over_time(cpu_usage[5m])` |
| `max_over_time()` | æ—¶é—´èŒƒå›´æœ€å¤§å€¼ | `max_over_time(memory_usage[10m])` |
| `min_over_time()` | æ—¶é—´èŒƒå›´æœ€å°å€¼ | `min_over_time(disk_free[1h])` |

---

## 5. ğŸ·ï¸ æ ‡ç­¾åŒ¹é…ä¸è¿‡æ»¤è¯­æ³•



### 5.1 æ ‡ç­¾åŒ¹é…åŸºç¡€



æ ‡ç­¾åŒ¹é…æ˜¯PromQLçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œè®©æˆ‘ä»¬èƒ½ç²¾ç¡®å®šä½éœ€è¦çš„ç›‘æ§æ•°æ®ã€‚

**ğŸ¯ åŒ¹é…æ“ä½œç¬¦**

| **æ“ä½œç¬¦** | **å«ä¹‰** | **ç¤ºä¾‹** |
|-----------|----------|----------|
| `=` | å®Œå…¨åŒ¹é… | `{job="nginx"}` |
| `!=` | ä¸åŒ¹é… | `{job!="test"}` |
| `=~` | æ­£åˆ™åŒ¹é… | `{instance=~"web.*"}` |
| `!~` | æ­£åˆ™ä¸åŒ¹é… | `{job!~"test.*"}` |

### 5.2 ç²¾ç¡®è¿‡æ»¤ç¤ºä¾‹



**ğŸ” å•æ¡ä»¶è¿‡æ»¤**
```
# åªçœ‹nginxæœåŠ¡çš„CPUä½¿ç”¨ç‡

cpu_usage_percent{job="nginx"}

# æ’é™¤æµ‹è¯•ç¯å¢ƒçš„æ•°æ®

memory_usage_bytes{environment!="test"}

# æŸ¥çœ‹ç”Ÿäº§ç¯å¢ƒçš„ç£ç›˜ä½¿ç”¨

disk_usage_percent{environment="production"}
```

**ğŸ”— å¤šæ¡ä»¶ç»„åˆ**
```
# åŒæ—¶æ»¡è¶³å¤šä¸ªæ¡ä»¶

cpu_usage_percent{job="nginx", environment="prod", instance!~"test.*"}

# webæœåŠ¡å™¨ä¸”åœ¨åŒ—äº¬æœºæˆ¿

http_requests_total{job=~"web.*", datacenter="beijing"}
```

### 5.3 æ­£åˆ™è¡¨è¾¾å¼é«˜çº§ç”¨æ³•



**ğŸ¨ çµæ´»æ¨¡å¼åŒ¹é…**

**é€šé…ç¬¦æ¨¡å¼**
```
# åŒ¹é…æ‰€æœ‰webå¼€å¤´çš„job

{job=~"web.*"}

# åŒ¹é…å¤šç§çŠ¶æ€ç 

{status_code=~"4..|5.."}  # 4xxæˆ–5xxçŠ¶æ€ç 

# åŒ¹é…ç‰¹å®šå®ä¾‹æ¨¡å¼

{instance=~".*prod.*"}
```

**å¤æ‚æ­£åˆ™ç¤ºä¾‹**
```
# åŒ¹é…ç‰¹å®šç«¯å£çš„å®ä¾‹

{instance=~".*:(80|443|8080)"}

# æ’é™¤æµ‹è¯•å’Œå¼€å‘ç¯å¢ƒ

{environment!~"test|dev|staging"}

# åŒ¹é…å¤šä¸ªæ•°æ®ä¸­å¿ƒ

{datacenter=~"beijing|shanghai|guangzhou"}
```

> ğŸ’¡ **æ­£åˆ™æŠ€å·§**ï¼š`.*`è¡¨ç¤ºä»»æ„å­—ç¬¦ï¼Œ`|`è¡¨ç¤ºæˆ–å…³ç³»ï¼Œ`[]`è¡¨ç¤ºå­—ç¬¦é›†åˆ

---

## 6. ğŸ”¢ æ•°å­¦è¿ç®—ä¸æ¯”è¾ƒæ“ä½œ



### 6.1 å‘é‡é—´è¿ç®—è§„åˆ™



å½“ä¸¤ä¸ªå‘é‡è¿›è¡Œè¿ç®—æ—¶ï¼ŒPromQLéœ€è¦çŸ¥é“å¦‚ä½•åŒ¹é…å¯¹åº”çš„æ—¶åºã€‚

**ğŸ“‹ åŒ¹é…è§„åˆ™**
```
é»˜è®¤åŒ¹é…ï¼šæ ‡ç­¾å®Œå…¨ç›¸åŒçš„æ—¶åºæ‰èƒ½è¿ç®—
ä¸€å¯¹ä¸€ï¼šæ¯ä¸ªæ—¶åºåªä¸ä¸€ä¸ªæ—¶åºåŒ¹é…
å¤šå¯¹ä¸€ï¼šä½¿ç”¨group_left/group_rightä¿®é¥°ç¬¦
```

### 6.2 å®ç”¨è®¡ç®—ç¤ºä¾‹



**ğŸ“Š æ¯”ç‡å’Œç™¾åˆ†æ¯”è®¡ç®—**
```
# HTTPæˆåŠŸç‡è®¡ç®—

(
  sum(rate(http_requests_total{status=~"2.."}[5m])) by (service)
  /
  sum(rate(http_requests_total[5m])) by (service)
) * 100

# é”™è¯¯ç‡è®¡ç®—

(
  sum(rate(http_requests_total{status=~"4..|5.."}[5m])) by (service)
  /
  sum(rate(http_requests_total[5m])) by (service)
) * 100
```

**ğŸ’¾ å­˜å‚¨ç›¸å…³è®¡ç®—**
```
# ç£ç›˜ä½¿ç”¨ç‡

(disk_total_bytes - disk_free_bytes) / disk_total_bytes * 100

# å†…å­˜ä½¿ç”¨ç‡

(memory_total_bytes - memory_available_bytes) / memory_total_bytes * 100

# å‰©ä½™ç£ç›˜ç©ºé—´é¢„æµ‹ï¼ˆåŸºäºå¢é•¿è¶‹åŠ¿ï¼‰

disk_free_bytes - (rate(disk_used_bytes[1h]) * 3600 * 24)
```

### 6.3 æ¡ä»¶åˆ¤æ–­ä¸é˜ˆå€¼å‘Šè­¦



**âš ï¸ å‘Šè­¦æ¡ä»¶æ„å»º**
```
# ç£ç›˜ç©ºé—´ä¸è¶³å‘Šè­¦

disk_usage_percent > 90

# CPUæŒç»­é«˜è´Ÿè½½

avg_over_time(cpu_usage_percent[10m]) > 85

# å†…å­˜ä½¿ç”¨ç‡å¼‚å¸¸

memory_usage_percent > 95 or memory_usage_percent < 5

# æœåŠ¡ä¸å¯ç”¨

up == 0
```

---

## 7. ğŸ”§ å­æŸ¥è¯¢ä¸åµŒå¥—æŸ¥è¯¢



### 7.1 å­æŸ¥è¯¢æ¦‚å¿µ



å­æŸ¥è¯¢å…è®¸æˆ‘ä»¬åœ¨ä¸€ä¸ªæŸ¥è¯¢ä¸­åŒ…å«å¦ä¸€ä¸ªæŸ¥è¯¢ï¼Œå®ç°å¤æ‚çš„æ•°æ®åˆ†æã€‚

**ğŸ“ å­æŸ¥è¯¢è¯­æ³•**
```
# åŸºæœ¬è¯­æ³•æ ¼å¼

<instant_query>[<range>:<resolution>]

# å®é™…ç¤ºä¾‹

max_over_time(cpu_usage_percent[5m])[1h:1m]
```

è¿™è¡¨ç¤ºï¼šæ¯åˆ†é’Ÿè®¡ç®—ä¸€æ¬¡è¿‡å»5åˆ†é’Ÿçš„æœ€å¤§CPUä½¿ç”¨ç‡ï¼ŒæŸ¥è¯¢è¿‡å»1å°æ—¶çš„æ•°æ®ã€‚

### 7.2 å®ç”¨å­æŸ¥è¯¢åœºæ™¯



**ğŸ“ˆ è¶‹åŠ¿åˆ†æ**
```
# æŸ¥çœ‹CPUå³°å€¼çš„å˜åŒ–è¶‹åŠ¿

max_over_time(cpu_usage_percent[10m])[4h:5m]

# åˆ†æå†…å­˜ä½¿ç”¨çš„æ³¢åŠ¨æƒ…å†µ

stddev_over_time(memory_usage_percent[5m])[2h:1m]
```

**ğŸ” å¼‚å¸¸æ£€æµ‹**
```
# æ£€æµ‹CPUä½¿ç”¨ç‡å¼‚å¸¸æ³¢åŠ¨

(
  max_over_time(cpu_usage_percent[5m]) - 
  min_over_time(cpu_usage_percent[5m])
)[1h:1m] > 50
```

### 7.3 å¤æ‚åµŒå¥—æŸ¥è¯¢



**ğŸ¯ å¤šå±‚åµŒå¥—ç¤ºä¾‹**
```
# è®¡ç®—æœåŠ¡å“åº”æ—¶é—´çš„P95åœ¨è¿‡å»4å°æ—¶çš„è¶‹åŠ¿

histogram_quantile(0.95,
  sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
)[4h:10m]

# åˆ†æç½‘ç»œIOçªå‘æƒ…å†µ

rate(
  max_over_time(network_io_bytes[1m])[10m:30s]
)[1h:5m]
```

---

## 8. ğŸ“Š ç›´æ–¹å›¾ä¸æ‘˜è¦æŒ‡æ ‡æŸ¥è¯¢



### 8.1 ç›´æ–¹å›¾æŒ‡æ ‡ç†è§£



ç›´æ–¹å›¾è®°å½•æ•°æ®çš„åˆ†å¸ƒæƒ…å†µï¼Œæ¯”å¦‚"å“åº”æ—¶é—´åœ¨0-100msçš„è¯·æ±‚æœ‰å¤šå°‘ä¸ª"ã€‚

**ğŸ“ˆ ç›´æ–¹å›¾ç»“æ„**
```
# ç›´æ–¹å›¾æŒ‡æ ‡å‘½åè§„åˆ™

http_request_duration_seconds_bucket{le="0.1"}  # å°äºç­‰äº0.1ç§’çš„è®¡æ•°
http_request_duration_seconds_bucket{le="0.5"}  # å°äºç­‰äº0.5ç§’çš„è®¡æ•°
http_request_duration_seconds_bucket{le="+Inf"} # æ€»è®¡æ•°
http_request_duration_seconds_sum              # æ€»å’Œ
http_request_duration_seconds_count            # æ€»æ•°é‡
```

### 8.2 åˆ†ä½æ•°è®¡ç®—



**ğŸ¯ histogram_quantileå‡½æ•°**
```
# è®¡ç®—å“åº”æ—¶é—´çš„P95ï¼ˆ95%çš„è¯·æ±‚å“åº”æ—¶é—´ï¼‰

histogram_quantile(0.95,
  sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
)

# è®¡ç®—ä¸åŒæœåŠ¡çš„P50ã€P90ã€P99

histogram_quantile(0.50,
  sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
)
```

**ğŸ“Š å¸¸ç”¨åˆ†ä½æ•°å«ä¹‰**
- **P50ï¼ˆä¸­ä½æ•°ï¼‰**ï¼šä¸€åŠè¯·æ±‚çš„å“åº”æ—¶é—´
- **P90**ï¼š90%è¯·æ±‚çš„å“åº”æ—¶é—´ä¸Šé™
- **P95**ï¼š95%è¯·æ±‚çš„å“åº”æ—¶é—´ä¸Šé™  
- **P99**ï¼š99%è¯·æ±‚çš„å“åº”æ—¶é—´ä¸Šé™

### 8.3 æ‘˜è¦æŒ‡æ ‡æŸ¥è¯¢



æ‘˜è¦æŒ‡æ ‡æä¾›é¢„è®¡ç®—çš„åˆ†ä½æ•°ï¼ŒæŸ¥è¯¢æ›´ç®€å•ä½†çµæ´»æ€§è¾ƒä½ã€‚

**ğŸ“ æ‘˜è¦æŒ‡æ ‡ç¤ºä¾‹**
```
# ç›´æ¥æŸ¥è¯¢é¢„è®¡ç®—çš„P95

http_request_duration_seconds{quantile="0.95"}

# è®¡ç®—å¹³å‡å“åº”æ—¶é—´

http_request_duration_seconds_sum / http_request_duration_seconds_count
```

---

## 9. âš¡ æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–æŠ€å·§



### 9.1 æŸ¥è¯¢æ•ˆç‡åŸåˆ™



**ğŸ¯ ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™**
1. **å°½æ—©è¿‡æ»¤**ï¼šåœ¨æŸ¥è¯¢å¼€å§‹æ—¶å°±å‡å°‘æ•°æ®é‡
2. **åˆç†èšåˆ**ï¼šé¿å…ä¸å¿…è¦çš„ç»†ç²’åº¦è®¡ç®—
3. **ç¼“å­˜å‹å¥½**ï¼šåˆ©ç”¨Prometheusçš„æŸ¥è¯¢ç¼“å­˜
4. **æ—¶é—´èŒƒå›´**ï¼šä¸è¦æŸ¥è¯¢è¿‡é•¿çš„æ—¶é—´èŒƒå›´

### 9.2 æ ‡ç­¾è¿‡æ»¤ä¼˜åŒ–



**âœ… å¥½çš„åšæ³•**
```
# å…ˆè¿‡æ»¤å†èšåˆ

sum(cpu_usage_percent{job="web", environment="prod"}) by (instance)

# ä½¿ç”¨ç²¾ç¡®åŒ¹é…è€Œä¸æ˜¯æ­£åˆ™

memory_usage_bytes{instance="web01.example.com"}
```

**âŒ é¿å…çš„åšæ³•**
```
# å…ˆèšåˆå†è¿‡æ»¤ï¼ˆæ•ˆç‡ä½ï¼‰

sum(cpu_usage_percent) by (instance, job, environment) and on (job) {job="web"}

# è¿‡åº¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼

cpu_usage_percent{instance=~".*web.*prod.*"}
```

### 9.3 æŸ¥è¯¢å¤æ‚åº¦ç®¡ç†



**ğŸ“ å¤æ‚åº¦è¯„ä¼°æŒ‡æ ‡**
- æ¶‰åŠçš„æ—¶åºæ•°é‡
- æŸ¥è¯¢çš„æ—¶é—´èŒƒå›´  
- èšåˆæ“ä½œçš„å¤æ‚ç¨‹åº¦
- å‡½æ•°åµŒå¥—çš„å±‚æ¬¡

**ğŸ”§ ä¼˜åŒ–ç­–ç•¥**
```
# ä½¿ç”¨recording rulesé¢„è®¡ç®—å¤æ‚æŸ¥è¯¢

# åœ¨prometheus.ymlä¸­å®šä¹‰

groups:
  - name: optimization
    rules:
    - record: job:cpu_usage:avg5m
      expr: avg(cpu_usage_percent) by (job)
      
# ç„¶åç›´æ¥ä½¿ç”¨é¢„è®¡ç®—ç»“æœ

job:cpu_usage:avg5m{job="web"}
```

### 9.4 å†…å­˜å’ŒCPUä½¿ç”¨ä¼˜åŒ–



**ğŸ’¾ èµ„æºä¼˜åŒ–å»ºè®®**

**å‡å°‘å†…å­˜ä½¿ç”¨**
- é™åˆ¶æŸ¥è¯¢ç»“æœçš„åŸºæ•°ï¼ˆæ ‡ç­¾ç»„åˆæ•°é‡ï¼‰
- é¿å…æŸ¥è¯¢è¿‡é•¿çš„æ—¶é—´èŒƒå›´
- ä½¿ç”¨åˆé€‚çš„æ—¶é—´åˆ†è¾¨ç‡

**æå‡æŸ¥è¯¢é€Ÿåº¦**
- åˆ©ç”¨æ ‡ç­¾ç´¢å¼•å¿«é€Ÿå®šä½
- åˆç†ä½¿ç”¨èšåˆå‡å°‘è®¡ç®—é‡
- é¿å…åœ¨é«˜é¢‘æŸ¥è¯¢ä¸­ä½¿ç”¨å¤æ‚å‡½æ•°

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



**ğŸ”¸ PromQLæœ¬è´¨**ï¼šä¸“ä¸ºæ—¶åºæ•°æ®è®¾è®¡çš„å‡½æ•°å¼æŸ¥è¯¢è¯­è¨€
**ğŸ”¸ å‘é‡æ¦‚å¿µ**ï¼šå³æ—¶å‘é‡çœ‹ç°åœ¨ï¼ŒèŒƒå›´å‘é‡çœ‹å†å²
**ğŸ”¸ æ ‡ç­¾è¿‡æ»¤**ï¼šé€šè¿‡æ ‡ç­¾ç²¾ç¡®å®šä½éœ€è¦çš„æ•°æ®  
**ğŸ”¸ èšåˆè®¡ç®—**ï¼šæŠŠå¤šä¸ªæ—¶åºåˆå¹¶æˆæœ‰æ„ä¹‰çš„ç»“æœ
**ğŸ”¸ æ—¶é—´å‡½æ•°**ï¼šåˆ†ææ•°æ®éšæ—¶é—´çš„å˜åŒ–è¶‹åŠ¿

### 10.2 å…³é”®è¯­æ³•è®°å¿†



**ğŸ”¹ åŸºç¡€è¯­æ³•æ¨¡å¼**
```
# åŸºæœ¬æŸ¥è¯¢æ¨¡å¼

metric_name{label_filter}[time_range]

# èšåˆæŸ¥è¯¢æ¨¡å¼  

aggregation_func(metric_name{label_filter}) by (labels)

# è®¡ç®—æŸ¥è¯¢æ¨¡å¼

function(metric_name{label_filter}[time_range])
```

**ğŸ”¹ å¸¸ç”¨æ“ä½œç¬¦é€ŸæŸ¥**
- **ç®—æœ¯**ï¼š`+ - * / % ^`
- **æ¯”è¾ƒ**ï¼š`== != > < >= <=`  
- **é€»è¾‘**ï¼š`and or unless`
- **åŒ¹é…**ï¼š`= != =~ !~`

### 10.3 å®é™…åº”ç”¨ä»·å€¼



**ğŸ¯ ç›‘æ§åœºæ™¯åº”ç”¨**
- **æ€§èƒ½ç›‘æ§**ï¼šCPUã€å†…å­˜ã€ç½‘ç»œä½¿ç”¨ç‡åˆ†æ
- **æœåŠ¡ç›‘æ§**ï¼šHTTPè¯·æ±‚æˆåŠŸç‡ã€å“åº”æ—¶é—´ç›‘æ§
- **å®¹é‡è§„åˆ’**ï¼šåŸºäºå†å²è¶‹åŠ¿é¢„æµ‹èµ„æºéœ€æ±‚
- **æ•…éšœè¯Šæ–­**ï¼šé€šè¿‡æŸ¥è¯¢å¿«é€Ÿå®šä½é—®é¢˜åŸå› 

**ğŸ“Š å‘Šè­¦è§„åˆ™ç¼–å†™**
- **é˜ˆå€¼å‘Šè­¦**ï¼š`cpu_usage > 80`
- **è¶‹åŠ¿å‘Šè­¦**ï¼š`predict_linear(disk_free[1h], 4*3600) < 0`
- **å¼‚å¸¸æ£€æµ‹**ï¼š`abs(cpu_usage - avg_over_time(cpu_usage[1h])) > 30`

### 10.4 å­¦ä¹ å®è·µå»ºè®®



**ğŸ› ï¸ å®è·µæ–¹æ³•**
1. **ä»ç®€å•å¼€å§‹**ï¼šå…ˆæŒæ¡åŸºæœ¬çš„å³æ—¶å‘é‡æŸ¥è¯¢
2. **é€æ­¥å¤æ‚**ï¼šæ·»åŠ æ ‡ç­¾è¿‡æ»¤å’Œæ—¶é—´èŒƒå›´
3. **ç†è§£åŸç†**ï¼šææ¸…æ¥šæ¯ä¸ªå‡½æ•°çš„ä½œç”¨æœºåˆ¶
4. **å¤šç»ƒä¹ **ï¼šåœ¨çœŸå®ç¯å¢ƒä¸­å°è¯•å„ç§æŸ¥è¯¢ç»„åˆ

**ğŸ”§ è°ƒè¯•æŠ€å·§**
- ä½¿ç”¨Prometheus Web UIçš„æŸ¥è¯¢ç•Œé¢
- å…ˆæµ‹è¯•ç®€å•æŸ¥è¯¢å†é€æ­¥å¤æ‚åŒ–
- åˆ©ç”¨`explain`åŠŸèƒ½ç†è§£æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
- è§‚å¯ŸæŸ¥è¯¢çš„æ‰§è¡Œæ—¶é—´å’Œè¿”å›çš„æ•°æ®é‡

### 10.5 å­¦ä¹ æ£€æŸ¥æ¸…å•



- [ ] ç†è§£å³æ—¶å‘é‡å’ŒèŒƒå›´å‘é‡çš„åŒºåˆ«
- [ ] æŒæ¡åŸºæœ¬çš„ç®—æœ¯å’Œæ¯”è¾ƒæ“ä½œ
- [ ] ç†Ÿæ‚‰å¸¸ç”¨èšåˆå‡½æ•°çš„ç”¨æ³•
- [ ] ä¼šä½¿ç”¨æ ‡ç­¾åŒ¹é…ç²¾ç¡®è¿‡æ»¤æ•°æ®
- [ ] ç†è§£rate()å’Œincrease()å‡½æ•°çš„å·®å¼‚
- [ ] èƒ½ç¼–å†™åŸºæœ¬çš„å‘Šè­¦æŸ¥è¯¢è¡¨è¾¾å¼
- [ ] äº†è§£ç›´æ–¹å›¾åˆ†ä½æ•°è®¡ç®—æ–¹æ³•
- [ ] æŒæ¡æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–åŸºæœ¬æŠ€å·§

**ğŸ¯ é¢è¯•è¦ç‚¹**
- â­â­â­ **å¿…é—®**ï¼šrate()å’Œincrease()çš„åŒºåˆ«
- â­â­â­ **å¿…é—®**ï¼šå¦‚ä½•è®¡ç®—æœåŠ¡æˆåŠŸç‡
- â­â­â˜† **å¸¸é—®**ï¼šhistogram_quantile()å‡½æ•°ç”¨æ³•
- â­â­â˜† **å¸¸é—®**ï¼šèšåˆå‡½æ•°byå’Œwithoutçš„åŒºåˆ«
- â­â˜†â˜† **å¶é—®**ï¼šå­æŸ¥è¯¢çš„åº”ç”¨åœºæ™¯

**ğŸ”‘ æ ¸å¿ƒè®°å¿†å£è¯€**
> PromQLæŸ¥æ•°æ®ï¼Œå‘é‡æ˜¯åŸºç¡€  
> æ ‡ç­¾æ¥è¿‡æ»¤ï¼Œå‡½æ•°åšè®¡ç®—
> èšåˆæ±‚ç»Ÿè®¡ï¼Œæ—¶é—´çœ‹è¶‹åŠ¿
> æ€§èƒ½è¦ä¼˜åŒ–ï¼Œå®è·µå‡ºçœŸçŸ¥

**ğŸ’¡ å»¶ä¼¸å­¦ä¹ æ–¹å‘**
- Grafanaä¸­PromQLæŸ¥è¯¢çš„å¯è§†åŒ–åº”ç”¨
- Alertmanagerä¸­å‘Šè­¦è§„åˆ™çš„é«˜çº§é…ç½®
- Recording Rulesçš„ç¼–å†™å’Œä¼˜åŒ–ç­–ç•¥
- è‡ªå®šä¹‰Exporterçš„æŒ‡æ ‡è®¾è®¡