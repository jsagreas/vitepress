---
title: 10ã€ç›‘æ§æŒ‡æ ‡è®¾è®¡ä¸é‡‡é›†
---
## ğŸ“š ç›®å½•

1. [ç›‘æ§æŒ‡æ ‡åŸºç¡€ç†è®º](#1-ç›‘æ§æŒ‡æ ‡åŸºç¡€ç†è®º)
2. [å››å¤§æŒ‡æ ‡ç±»å‹è¯¦è§£](#2-å››å¤§æŒ‡æ ‡ç±»å‹è¯¦è§£)
3. [æŒ‡æ ‡å‘½åè§„èŒƒä¸æ ‡ç­¾è®¾è®¡](#3-æŒ‡æ ‡å‘½åè§„èŒƒä¸æ ‡ç­¾è®¾è®¡)
4. [ä¸šåŠ¡æŒ‡æ ‡å®šä¹‰ä¸é‡‡é›†å®æˆ˜](#4-ä¸šåŠ¡æŒ‡æ ‡å®šä¹‰ä¸é‡‡é›†å®æˆ˜)
5. [SLI/SLOæŒ‡æ ‡ä½“ç³»è®¾è®¡](#5-SLI-SLOæŒ‡æ ‡ä½“ç³»è®¾è®¡)
6. [æŒ‡æ ‡åŸºæ•°æ§åˆ¶ä¸ä¼˜åŒ–ç­–ç•¥](#6-æŒ‡æ ‡åŸºæ•°æ§åˆ¶ä¸ä¼˜åŒ–ç­–ç•¥)
7. [è‡ªå®šä¹‰æŒ‡æ ‡æš´éœ²æ–¹æ³•](#7-è‡ªå®šä¹‰æŒ‡æ ‡æš´éœ²æ–¹æ³•)
8. [æŒ‡æ ‡èšåˆä¸é¢„è®¡ç®—ä¼˜åŒ–](#8-æŒ‡æ ‡èšåˆä¸é¢„è®¡ç®—ä¼˜åŒ–)
9. [ç›‘æ§è¦†ç›–ç‡è¯„ä¼°ä½“ç³»](#9-ç›‘æ§è¦†ç›–ç‡è¯„ä¼°ä½“ç³»)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“Š ç›‘æ§æŒ‡æ ‡åŸºç¡€ç†è®º


### 1.1 ä»€ä¹ˆæ˜¯ç›‘æ§æŒ‡æ ‡


**ç®€å•ç†è§£**ï¼šç›‘æ§æŒ‡æ ‡å°±åƒæ˜¯ç»™ç³»ç»Ÿè£…ä¸Š"ä½“æ£€ä»ªå™¨"ï¼Œé€šè¿‡æ•°å­—æ¥å‘Šè¯‰æˆ‘ä»¬ç³»ç»Ÿçš„å¥åº·çŠ¶å†µã€‚

```
ç±»æ¯”ç†è§£ï¼š
äººä½“ä½“æ£€ â†’ ç³»ç»Ÿç›‘æ§
ä½“æ¸©     â†’ CPUä½¿ç”¨ç‡
å¿ƒç‡     â†’ è¯·æ±‚é¢‘ç‡  
è¡€å‹     â†’ å†…å­˜å‹åŠ›
è¡€ç³–     â†’ é”™è¯¯ç‡
```

**æŒ‡æ ‡çš„æœ¬è´¨ä½œç”¨**ï¼š
- ğŸ” **å‘ç°é—®é¢˜**ï¼šå¼‚å¸¸æ•°æ®æç¤ºç³»ç»Ÿæ•…éšœ
- ğŸ“ˆ **æ€§èƒ½åˆ†æ**ï¼šäº†è§£ç³»ç»Ÿè¿è¡ŒçŠ¶æ€è¶‹åŠ¿
- ğŸ¯ **å®¹é‡è§„åˆ’**ï¼šé¢„æµ‹èµ„æºéœ€æ±‚
- ğŸ“‹ **SLAä¿éšœ**ï¼šç¡®ä¿æœåŠ¡è´¨é‡æ‰¿è¯º

### 1.2 ç›‘æ§æŒ‡æ ‡çš„åˆ†ç±»ç»´åº¦


```
æŒ‰ç”¨é€”åˆ†ç±»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åŸºç¡€è®¾æ–½æŒ‡æ ‡   â”‚ â† CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åº”ç”¨æŒ‡æ ‡      â”‚ â† å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€ååé‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä¸šåŠ¡æŒ‡æ ‡      â”‚ â† è®¢å•é‡ã€ç”¨æˆ·æ´»è·ƒåº¦ã€æ”¶å…¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŒ‰æ•°æ®ç‰¹å¾åˆ†ç±»ï¼š
â€¢ è®¡æ•°ç±»ï¼šç´¯è®¡å€¼ï¼Œåªå¢ä¸å‡ï¼ˆå¦‚è¯·æ±‚æ€»æ•°ï¼‰
â€¢ çŠ¶æ€ç±»ï¼šå½“å‰å€¼ï¼Œå¯å¢å¯å‡ï¼ˆå¦‚åœ¨çº¿ç”¨æˆ·æ•°ï¼‰
â€¢ åˆ†å¸ƒç±»ï¼šæ•°æ®åˆ†å¸ƒæƒ…å†µï¼ˆå¦‚å“åº”æ—¶é—´åˆ†å¸ƒï¼‰
```

### 1.3 ç›‘æ§æŒ‡æ ‡çš„ç”Ÿå‘½å‘¨æœŸ


```
æŒ‡æ ‡ç”Ÿå‘½å‘¨æœŸæµç¨‹ï¼š
å®šä¹‰ â†’ é‡‡é›† â†’ å­˜å‚¨ â†’ æŸ¥è¯¢ â†’ å‘Šè­¦ â†’ åˆ†æ â†’ ä¼˜åŒ–

1. å®šä¹‰é˜¶æ®µï¼šç¡®å®šç›‘æ§ä»€ä¹ˆã€å¦‚ä½•å‘½å
2. é‡‡é›†é˜¶æ®µï¼šä»ç³»ç»Ÿä¸­è·å–æ•°æ®
3. å­˜å‚¨é˜¶æ®µï¼šé«˜æ•ˆå­˜å‚¨æ—¶åºæ•°æ®
4. æŸ¥è¯¢é˜¶æ®µï¼šæ£€ç´¢å’Œå±•ç¤ºæ•°æ®
5. å‘Šè­¦é˜¶æ®µï¼šå¼‚å¸¸æ—¶åŠæ—¶é€šçŸ¥
6. åˆ†æé˜¶æ®µï¼šåŸºäºæ•°æ®åšå†³ç­–
7. ä¼˜åŒ–é˜¶æ®µï¼šæ”¹è¿›æŒ‡æ ‡è´¨é‡å’Œæ•ˆç‡
```

---

## 2. ğŸ¯ å››å¤§æŒ‡æ ‡ç±»å‹è¯¦è§£


### 2.1 Counterï¼ˆè®¡æ•°å™¨ï¼‰- åªå¢ä¸å‡çš„ç´¯è®¡å™¨


**ä»€ä¹ˆæ˜¯Counter**ï¼š
Counterå°±åƒæ±½è½¦çš„é‡Œç¨‹è¡¨ï¼Œåªä¼šä¸æ–­ç´¯åŠ ï¼Œæ°¸è¿œä¸ä¼šå€’é€€ã€‚

**å…¸å‹ç‰¹å¾**ï¼š
- âœ… å•è°ƒé€’å¢ï¼ˆæˆ–é‡ç½®ä¸º0ï¼‰
- âœ… é€‚åˆè®¡ç®—é€Ÿç‡å˜åŒ–
- âœ… é‡å¯æ—¶ä¼šé‡ç½®ä¸º0

**å¸¸è§åº”ç”¨åœºæ™¯**ï¼š

| åœºæ™¯ | æŒ‡æ ‡ç¤ºä¾‹ | è¯´æ˜ |
|------|----------|------|
| **HTTPè¯·æ±‚** | `http_requests_total` | ç´¯è®¡HTTPè¯·æ±‚æ€»æ•° |
| **é”™è¯¯ç»Ÿè®¡** | `http_errors_total` | ç´¯è®¡é”™è¯¯æ¬¡æ•° |
| **å­—èŠ‚ä¼ è¾“** | `network_bytes_total` | ç´¯è®¡ä¼ è¾“å­—èŠ‚æ•° |
| **ä»»åŠ¡å®Œæˆ** | `jobs_completed_total` | ç´¯è®¡å®Œæˆä»»åŠ¡æ•° |

**å®é™…ä»£ç ç¤ºä¾‹**ï¼š
```python
from prometheus_client import Counter

# å®šä¹‰CounteræŒ‡æ ‡
http_requests = Counter('http_requests_total', 
                       'HTTPè¯·æ±‚æ€»æ•°', 
                       ['method', 'endpoint'])

# ä½¿ç”¨Counter
def handle_request(method, endpoint):
    http_requests.labels(method=method, endpoint=endpoint).inc()
    # å¤„ç†è¯·æ±‚é€»è¾‘...
```

**CounteræŸ¥è¯¢æŠ€å·§**ï¼š
```promql
# è®¡ç®—æ¯ç§’è¯·æ±‚ç‡ï¼ˆQPSï¼‰
rate(http_requests_total[5m])

# è®¡ç®—è¿‡å»1å°æ—¶çš„æ€»è¯·æ±‚æ•°
increase(http_requests_total[1h])
```

### 2.2 Gaugeï¼ˆä»ªè¡¨ç›˜ï¼‰- å¯å¢å¯å‡çš„ç¬æ—¶å€¼


**ä»€ä¹ˆæ˜¯Gauge**ï¼š
Gaugeå°±åƒæ¸©åº¦è®¡ï¼Œæ•°å€¼å¯ä»¥ä¸Šå‡ä¹Ÿå¯ä»¥ä¸‹é™ï¼Œåæ˜ å½“å‰æ—¶åˆ»çš„çŠ¶æ€ã€‚

**å…¸å‹ç‰¹å¾**ï¼š
- âœ… æ•°å€¼å¯å¢å¯å‡
- âœ… åæ˜ ç¬æ—¶çŠ¶æ€
- âœ… é€‚åˆå±•ç¤ºå½“å‰å€¼

**å¸¸è§åº”ç”¨åœºæ™¯**ï¼š

| åœºæ™¯ | æŒ‡æ ‡ç¤ºä¾‹ | è¯´æ˜ |
|------|----------|------|
| **èµ„æºä½¿ç”¨** | `cpu_usage_percent` | å½“å‰CPUä½¿ç”¨ç‡ |
| **é˜Ÿåˆ—é•¿åº¦** | `queue_size` | å½“å‰é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•° |
| **è¿æ¥æ•°** | `active_connections` | å½“å‰æ´»è·ƒè¿æ¥æ•° |
| **å†…å­˜ä½¿ç”¨** | `memory_used_bytes` | å½“å‰å†…å­˜ä½¿ç”¨é‡ |

**å®é™…ä»£ç ç¤ºä¾‹**ï¼š
```python
from prometheus_client import Gauge
import psutil

# å®šä¹‰GaugeæŒ‡æ ‡
cpu_usage = Gauge('cpu_usage_percent', 'CPUä½¿ç”¨ç‡')
memory_usage = Gauge('memory_used_bytes', 'å†…å­˜ä½¿ç”¨é‡')

# æ›´æ–°Gaugeå€¼
def update_system_metrics():
    cpu_usage.set(psutil.cpu_percent())
    memory_usage.set(psutil.virtual_memory().used)
```

### 2.3 Histogramï¼ˆç›´æ–¹å›¾ï¼‰- åˆ†å¸ƒç»Ÿè®¡ç¥å™¨


**ä»€ä¹ˆæ˜¯Histogram**ï¼š
Histogramå°±åƒè€ƒè¯•æˆç»©åˆ†å¸ƒå›¾ï¼Œèƒ½å‘Šè¯‰æˆ‘ä»¬æ•°æ®åœ¨ä¸åŒåŒºé—´çš„åˆ†å¸ƒæƒ…å†µã€‚

**Histogramçš„ç¥å¥‡ä¹‹å¤„**ï¼š
ä¸€ä¸ªHistogramæŒ‡æ ‡è‡ªåŠ¨æä¾›ä¸‰ç§æ•°æ®ï¼š
- `_bucket`ï¼šå„åŒºé—´çš„è®¡æ•°
- `_count`ï¼šæ€»æ ·æœ¬æ•°  
- `_sum`ï¼šæ‰€æœ‰æ ·æœ¬å€¼çš„æ€»å’Œ

**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š

| åœºæ™¯ | ç”¨é€” | ä¼˜åŠ¿ |
|------|------|------|
| **å“åº”æ—¶é—´åˆ†æ** | åˆ†æè¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ | æ‰¾å‡ºæ…¢è¯·æ±‚æ¯”ä¾‹ |
| **è¯·æ±‚å¤§å°åˆ†æ** | åˆ†æè¯·æ±‚ä½“å¤§å° | ä¼˜åŒ–ä¼ è¾“æ•ˆç‡ |
| **é˜Ÿåˆ—ç­‰å¾…æ—¶é—´** | åˆ†æä»»åŠ¡ç­‰å¾…åˆ†å¸ƒ | ä¼˜åŒ–é˜Ÿåˆ—ç­–ç•¥ |

**å®é™…ä»£ç ç¤ºä¾‹**ï¼š
```python
from prometheus_client import Histogram
import time

# å®šä¹‰Histogramï¼Œè®¾ç½®åˆç†çš„æ¡¶è¾¹ç•Œ
response_time = Histogram('http_request_duration_seconds',
                         'HTTPè¯·æ±‚å“åº”æ—¶é—´',
                         ['method', 'endpoint'],
                         buckets=[0.1, 0.5, 1.0, 2.5, 5.0, 10.0])

# ä½¿ç”¨è£…é¥°å™¨æ–¹å¼è®°å½•æ—¶é—´
@response_time.labels(method='GET', endpoint='/api/users').time()
def get_users():
    time.sleep(0.3)  # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
    return "user data"
```

**HistogramæŸ¥è¯¢åˆ†æ**ï¼š
```promql
# è®¡ç®—95åˆ†ä½å»¶è¿Ÿ
histogram_quantile(0.95, 
  rate(http_request_duration_seconds_bucket[5m]))

# è®¡ç®—å¹³å‡å“åº”æ—¶é—´
rate(http_request_duration_seconds_sum[5m]) / 
rate(http_request_duration_seconds_count[5m])
```

### 2.4 Summaryï¼ˆæ‘˜è¦ï¼‰- é¢„è®¡ç®—çš„åˆ†ä½æ•°


**ä»€ä¹ˆæ˜¯Summary**ï¼š
Summaryå°±åƒæå‰ç®—å¥½çš„æˆç»©ç»Ÿè®¡è¡¨ï¼Œç›´æ¥ç»™å‡ºå¹³å‡åˆ†å’Œå„ç§åˆ†ä½æ•°ã€‚

**Summary vs Histogramå¯¹æ¯”**ï¼š

| ç‰¹æ€§ | Summary | Histogram |
|------|---------|-----------|
| **è®¡ç®—ä½ç½®** | å®¢æˆ·ç«¯é¢„è®¡ç®— | æœåŠ¡ç«¯è®¡ç®— |
| **èšåˆèƒ½åŠ›** | âŒ ä¸èƒ½è·¨å®ä¾‹èšåˆ | âœ… å¯ä»¥èšåˆè®¡ç®— |
| **å­˜å‚¨å¼€é”€** | è¾ƒå° | è¾ƒå¤§ |
| **çµæ´»æ€§** | å›ºå®šåˆ†ä½æ•° | ä»»æ„åˆ†ä½æ•° |

**ä½¿ç”¨åœºæ™¯é€‰æ‹©**ï¼š
- ğŸ¯ **é€‰æ‹©Summary**ï¼šå•å®ä¾‹åˆ†æã€é¢„è®¾åˆ†ä½æ•°å¤Ÿç”¨
- ğŸ¯ **é€‰æ‹©Histogram**ï¼šå¤šå®ä¾‹èšåˆã€çµæ´»åˆ†ä½æ•°åˆ†æ

---

## 3. ğŸ·ï¸ æŒ‡æ ‡å‘½åè§„èŒƒä¸æ ‡ç­¾è®¾è®¡


### 3.1 æŒ‡æ ‡å‘½åæœ€ä½³å®è·µ


**å‘½åè§„èŒƒæ ¸å¿ƒåŸåˆ™**ï¼š
```
æ ¼å¼ï¼š<namespace>_<subsystem>_<name>_<unit>

ç¤ºä¾‹è§£æï¼š
http_server_requests_duration_seconds
â”‚    â”‚       â”‚         â”‚        â”‚
â”‚    â”‚       â”‚         â”‚        â””â”€ å•ä½
â”‚    â”‚       â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…·ä½“æŒ‡æ ‡å
â”‚    â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å­ç³»ç»Ÿ
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‘½åç©ºé—´
```

**å‘½åè§„èŒƒè¯¦ç»†è¯´æ˜**ï¼š

| ç»„æˆéƒ¨åˆ† | ä½œç”¨ | ç¤ºä¾‹ | æ³¨æ„äº‹é¡¹ |
|----------|------|------|----------|
| **namespace** | åº”ç”¨/ç»„ç»‡æ ‡è¯† | `myapp`, `k8s` | é¿å…ä¸å…¶ä»–ç³»ç»Ÿå†²çª |
| **subsystem** | åŠŸèƒ½æ¨¡å— | `http`, `database` | ä¾¿äºåˆ†ç±»ç®¡ç† |
| **name** | å…·ä½“æŒ‡æ ‡ | `requests`, `connections` | æè¿°æ€§å¼ºï¼Œç®€æ´æ˜äº† |
| **unit** | æ•°æ®å•ä½ | `seconds`, `bytes` | æ˜ç¡®æ•°æ®å«ä¹‰ |

**å¸¸è§å•ä½çº¦å®š**ï¼š
```
æ—¶é—´å•ä½ï¼šsecondsï¼ˆä¸ç”¨msæˆ–usï¼‰
å¤§å°å•ä½ï¼šbytesï¼ˆä¸ç”¨KBæˆ–MBï¼‰
æ¯”ç‡å•ä½ï¼šratioï¼ˆ0-1ä¹‹é—´çš„å°æ•°ï¼‰
ç™¾åˆ†æ¯”ï¼špercentï¼ˆ0-100ä¹‹é—´çš„æ•°å­—ï¼‰
```

### 3.2 æ ‡ç­¾è®¾è®¡ç­–ç•¥


**æ ‡ç­¾çš„ä½œç”¨**ï¼š
æ ‡ç­¾å°±åƒç»™æŒ‡æ ‡è´´ä¸Šä¸åŒé¢œè‰²çš„ä¾¿ç­¾ï¼Œè®©æˆ‘ä»¬èƒ½æŒ‰ä¸åŒç»´åº¦åˆ†ææ•°æ®ã€‚

**æ ‡ç­¾è®¾è®¡åŸåˆ™**ï¼š

```
å¥½çš„æ ‡ç­¾è®¾è®¡ï¼š
âœ… åŸºæ•°å¯æ§ï¼šæ ‡ç­¾å€¼æ•°é‡æœ‰é™
âœ… ç¨³å®šæ€§å¼ºï¼šæ ‡ç­¾å€¼ç›¸å¯¹å›ºå®š
âœ… ä¸šåŠ¡ç›¸å…³ï¼šå¯¹åˆ†ææœ‰å®é™…ä»·å€¼

åçš„æ ‡ç­¾è®¾è®¡ï¼š
âŒ é«˜åŸºæ•°ï¼šç”¨æˆ·IDã€æ—¶é—´æˆ³ä½œä¸ºæ ‡ç­¾å€¼
âŒ åŠ¨æ€æ€§å¼ºï¼šéšæœºç”Ÿæˆçš„å€¼
âŒ è¿‡åº¦ç»†åˆ†ï¼šå¯¹ä¸šåŠ¡åˆ†ææ— æ„ä¹‰
```

**æ ‡ç­¾åŸºæ•°æ§åˆ¶**ï¼š

| æ ‡ç­¾ç±»å‹ | å»ºè®®åŸºæ•° | ç¤ºä¾‹ | é£é™©ç­‰çº§ |
|----------|----------|------|----------|
| **æšä¸¾ç±»å‹** | < 10 | method=['GET','POST'] | ğŸŸ¢ å®‰å…¨ |
| **åˆ†ç±»æ ‡ç­¾** | < 100 | status_code, endpoint | ğŸŸ¡ æ³¨æ„ |
| **åŠ¨æ€æ ‡ç­¾** | > 1000 | user_id, request_id | ğŸ”´ å±é™© |

**å®é™…æ ‡ç­¾è®¾è®¡ç¤ºä¾‹**ï¼š
```python
# è‰¯å¥½çš„æ ‡ç­¾è®¾è®¡
http_requests_total{
    method="GET",           # æšä¸¾ï¼šGET/POST/PUT/DELETE
    status_code="200",      # åˆ†ç±»ï¼š200/404/500ç­‰
    endpoint="/api/users"   # è·¯å¾„ï¼šæœ‰é™çš„APIè·¯å¾„
}

# å±é™©çš„æ ‡ç­¾è®¾è®¡ï¼ˆé¿å…ï¼‰
http_requests_total{
    user_id="12345",        # âŒ é«˜åŸºæ•°
    timestamp="1634567890", # âŒ æ— é™å¢é•¿
    request_id="abc-123"    # âŒ æ¯æ¬¡éƒ½ä¸åŒ
}
```

### 3.3 æ ‡ç­¾å€¼è§„èŒƒåŒ–


**æ ‡ç­¾å€¼å¤„ç†ç­–ç•¥**ï¼š

```python
def normalize_endpoint(path):
    """å°†åŠ¨æ€è·¯å¾„æ ‡å‡†åŒ–ä¸ºé™æ€æ¨¡æ¿"""
    # /api/users/123 â†’ /api/users/{id}
    # /api/orders/456/items/789 â†’ /api/orders/{id}/items/{id}
    
    import re
    # æ›¿æ¢æ•°å­—ID
    path = re.sub(r'/\d+', '/{id}', path)
    # æ›¿æ¢UUID
    path = re.sub(r'/[0-9a-f-]{36}', '/{uuid}', path)
    return path

# ä½¿ç”¨ç¤ºä¾‹
def record_request(method, path, status):
    normalized_path = normalize_endpoint(path)
    http_requests.labels(
        method=method,
        endpoint=normalized_path,
        status_code=str(status)
    ).inc()
```

---

## 4. ğŸ’¼ ä¸šåŠ¡æŒ‡æ ‡å®šä¹‰ä¸é‡‡é›†å®æˆ˜


### 4.1 ä¸šåŠ¡æŒ‡æ ‡çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦ä¸šåŠ¡æŒ‡æ ‡**ï¼š
æŠ€æœ¯æŒ‡æ ‡å‘Šè¯‰æˆ‘ä»¬ç³»ç»Ÿå¥ä¸å¥åº·ï¼Œä¸šåŠ¡æŒ‡æ ‡å‘Šè¯‰æˆ‘ä»¬ä¸šåŠ¡å¥½ä¸å¥½ã€‚

```
æŠ€æœ¯æŒ‡æ ‡ vs ä¸šåŠ¡æŒ‡æ ‡ï¼š

æŠ€æœ¯è§’åº¦ï¼š
â€¢ CPUä½¿ç”¨ç‡: 80%     â†’  ç³»ç»Ÿè´Ÿè½½é«˜
â€¢ å“åº”æ—¶é—´: 200ms    â†’  æ€§èƒ½è‰¯å¥½
â€¢ é”™è¯¯ç‡: 0.1%      â†’  ç³»ç»Ÿç¨³å®š

ä¸šåŠ¡è§’åº¦ï¼š
â€¢ è®¢å•è½¬åŒ–ç‡: ä¸‹é™20%  â†’  å¯èƒ½æœ‰é—®é¢˜
â€¢ ç”¨æˆ·æ´»è·ƒåº¦: å¢é•¿15%  â†’  è¿è¥æ•ˆæœå¥½
â€¢ æ”¶å…¥: æ¯”æ˜¨å¤©å°‘30%   â†’  éœ€è¦ç´§æ€¥å…³æ³¨
```

### 4.2 ä¸šåŠ¡æŒ‡æ ‡åˆ†ç±»ä½“ç³»


**ç”µå•†ä¸šåŠ¡æŒ‡æ ‡ç¤ºä¾‹**ï¼š

| æŒ‡æ ‡ç±»å‹ | å…·ä½“æŒ‡æ ‡ | æŒ‡æ ‡ç±»å‹ | é‡‡é›†æ–¹å¼ |
|----------|----------|----------|----------|
| **ç”¨æˆ·è¡Œä¸º** | é¡µé¢æµè§ˆé‡ | Counter | å‰ç«¯åŸ‹ç‚¹ |
| **ç”¨æˆ·è¡Œä¸º** | ç”¨æˆ·æ³¨å†Œæ•° | Counter | åç«¯API |
| **äº¤æ˜“æŒ‡æ ‡** | è®¢å•é‡‘é¢ | Counter | æ”¯ä»˜å›è°ƒ |
| **äº¤æ˜“æŒ‡æ ‡** | è´­ç‰©è½¦å•†å“æ•° | Gauge | å®šæ—¶ç»Ÿè®¡ |
| **æ€§èƒ½æŒ‡æ ‡** | æœç´¢å»¶è¿Ÿåˆ†å¸ƒ | Histogram | åº”ç”¨ç›‘æ§ |

### 4.3 ä¸šåŠ¡æŒ‡æ ‡é‡‡é›†å®ç°


**æ–¹æ³•ä¸€ï¼šåº”ç”¨å†…åŸ‹ç‚¹**
```python
from prometheus_client import Counter, Gauge, Histogram

# å®šä¹‰ä¸šåŠ¡æŒ‡æ ‡
user_registrations = Counter('business_user_registrations_total', 
                           'ç”¨æˆ·æ³¨å†Œæ€»æ•°',
                           ['source', 'user_type'])

order_amount = Counter('business_order_amount_total',
                      'è®¢å•é‡‘é¢æ€»è®¡',
                      ['currency', 'payment_method'])

search_duration = Histogram('business_search_duration_seconds',
                           'æœç´¢è€—æ—¶åˆ†å¸ƒ',
                           ['category'],
                           buckets=[0.1, 0.5, 1.0, 2.0, 5.0])

# ä¸šåŠ¡é€»è¾‘ä¸­ä½¿ç”¨
class UserService:
    def register_user(self, source, user_type):
        # æ³¨å†Œé€»è¾‘...
        user_registrations.labels(source=source, user_type=user_type).inc()
    
class OrderService:
    def create_order(self, amount, currency, payment_method):
        # è®¢å•é€»è¾‘...
        order_amount.labels(currency=currency, 
                          payment_method=payment_method).inc(amount)
```

**æ–¹æ³•äºŒï¼šæ•°æ®åº“å®šæ—¶ç»Ÿè®¡**
```python
import schedule
from prometheus_client import Gauge

# å®šä¹‰çŠ¶æ€ç±»æŒ‡æ ‡
active_users = Gauge('business_active_users', 'å½“å‰æ´»è·ƒç”¨æˆ·æ•°')
pending_orders = Gauge('business_pending_orders', 'å¾…å¤„ç†è®¢å•æ•°')

def update_business_metrics():
    """å®šæ—¶æ›´æ–°ä¸šåŠ¡æŒ‡æ ‡"""
    # ç»Ÿè®¡æ´»è·ƒç”¨æˆ·ï¼ˆæœ€è¿‘1å°æ—¶æœ‰æ´»åŠ¨ï¼‰
    active_count = db.query("""
        SELECT COUNT(DISTINCT user_id) 
        FROM user_activity 
        WHERE created_at > NOW() - INTERVAL 1 HOUR
    """).scalar()
    
    active_users.set(active_count)
    
    # ç»Ÿè®¡å¾…å¤„ç†è®¢å•
    pending_count = db.query("""
        SELECT COUNT(*) 
        FROM orders 
        WHERE status = 'pending'
    """).scalar()
    
    pending_orders.set(pending_count)

# æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
schedule.every().minute.do(update_business_metrics)
```

### 4.4 ä¸šåŠ¡å¼‚å¸¸æ£€æµ‹


**ä¸šåŠ¡æŒ‡æ ‡å¼‚å¸¸å‘Šè­¦**ï¼š
```yaml
# ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦è§„åˆ™ç¤ºä¾‹
groups:
- name: business.rules
  rules:
  # è®¢å•é‡å¼‚å¸¸ä¸‹é™
  - alert: OrderVolumeDropped
    expr: |
      (
        rate(business_order_amount_total[1h]) 
        < 
        rate(business_order_amount_total[1h] offset 24h) * 0.7
      )
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "è®¢å•é‡å¼‚å¸¸ä¸‹é™"
      description: "è¿‡å»1å°æ—¶è®¢å•é‡æ¯”æ˜¨å¤©åŒæ—¶æ®µä¸‹é™è¶…è¿‡30%"
  
  # ç”¨æˆ·æ³¨å†Œå¼‚å¸¸å¢é•¿ï¼ˆå¯èƒ½æ˜¯åˆ·å•ï¼‰
  - alert: UnusualRegistrationSpike
    expr: |
      rate(business_user_registrations_total[5m]) > 10
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "ç”¨æˆ·æ³¨å†Œå¼‚å¸¸å¢é•¿"
      description: "æ¯åˆ†é’Ÿæ³¨å†Œç”¨æˆ·è¶…è¿‡10äººï¼Œå¯èƒ½å­˜åœ¨å¼‚å¸¸"
```

---

## 5. ğŸ¯ SLI/SLOæŒ‡æ ‡ä½“ç³»è®¾è®¡


### 5.1 SLI/SLOåŸºæœ¬æ¦‚å¿µ


**é€šä¿—ç†è§£**ï¼š
- **SLIï¼ˆService Level Indicatorï¼‰**ï¼šæœåŠ¡æ°´å¹³æŒ‡æ ‡ï¼Œå°±æ˜¯æˆ‘ä»¬ç”¨æ¥è¡¡é‡æœåŠ¡å¥½åçš„"è€ƒè¯•æˆç»©"
- **SLOï¼ˆService Level Objectiveï¼‰**ï¼šæœåŠ¡æ°´å¹³ç›®æ ‡ï¼Œå°±æ˜¯æˆ‘ä»¬è®¾å®šçš„"åŠæ ¼çº¿"
- **SLAï¼ˆService Level Agreementï¼‰**ï¼šæœåŠ¡æ°´å¹³åè®®ï¼Œå°±æ˜¯å¯¹ç”¨æˆ·çš„"æ‰¿è¯ºä¹¦"

```
ç±»æ¯”ç†è§£ï¼š
è€ƒè¯•æˆç»©(SLI) â†’ åŠæ ¼çº¿(SLO) â†’ å­¦æ ¡æ‰¿è¯º(SLA)
95åˆ†          â†’ 90åˆ†åŠæ ¼    â†’ ä¿è¯90%å­¦ç”ŸåŠæ ¼

æœåŠ¡å¯ç”¨æ€§(SLI) â†’ 99.9%ç›®æ ‡(SLO) â†’ 99.5%æ‰¿è¯º(SLA)
99.95%           â†’ è¾¾æ ‡          â†’ è¶…å‡ºæ‰¿è¯º
```

### 5.2 SLIæŒ‡æ ‡é€‰æ‹©ç­–ç•¥


**é»„é‡‘å››å¤§SLIæŒ‡æ ‡**ï¼š

| SLIç±»å‹ | å«ä¹‰ | é€‚ç”¨åœºæ™¯ | è®¡ç®—æ–¹å¼ |
|---------|------|----------|----------|
| **å¯ç”¨æ€§** | æˆåŠŸè¯·æ±‚æ¯”ä¾‹ | æ‰€æœ‰æœåŠ¡ | æˆåŠŸè¯·æ±‚æ•°/æ€»è¯·æ±‚æ•° |
| **å»¶è¿Ÿ** | è¯·æ±‚å“åº”æ—¶é—´ | ç”¨æˆ·é¢å‘æœåŠ¡ | å“åº”æ—¶é—´åˆ†ä½æ•° |
| **ååé‡** | å•ä½æ—¶é—´å¤„ç†é‡ | æ‰¹å¤„ç†ç³»ç»Ÿ | æ¯ç§’å¤„ç†è¯·æ±‚æ•° |
| **é”™è¯¯ç‡** | å¤±è´¥è¯·æ±‚æ¯”ä¾‹ | æ‰€æœ‰æœåŠ¡ | é”™è¯¯è¯·æ±‚æ•°/æ€»è¯·æ±‚æ•° |

**SLIæŒ‡æ ‡å®ç°ç¤ºä¾‹**ï¼š
```python
from prometheus_client import Counter, Histogram

# å®šä¹‰SLIç›¸å…³æŒ‡æ ‡
http_requests_total = Counter('http_requests_total',
                            'HTTPè¯·æ±‚æ€»æ•°',
                            ['method', 'endpoint', 'status_code'])

http_request_duration = Histogram('http_request_duration_seconds',
                                'HTTPè¯·æ±‚å»¶è¿Ÿ',
                                ['method', 'endpoint'])

def record_request(method, endpoint, status_code, duration):
    """è®°å½•è¯·æ±‚æŒ‡æ ‡ç”¨äºSLIè®¡ç®—"""
    http_requests_total.labels(
        method=method,
        endpoint=endpoint, 
        status_code=str(status_code)
    ).inc()
    
    http_request_duration.labels(
        method=method,
        endpoint=endpoint
    ).observe(duration)
```

### 5.3 SLOç›®æ ‡è®¾å®š


**SLOè®¾å®šåŸåˆ™**ï¼š

```
SLOè®¾å®šä¸æ˜¯è¶Šé«˜è¶Šå¥½ï¼

è¿‡é«˜çš„SLOï¼ˆå¦‚99.99%ï¼‰ï¼š
âŒ å¼€å‘é€Ÿåº¦æ…¢ï¼ˆè¿‡åº¦ä¿å®ˆï¼‰
âŒ æˆæœ¬è¿‡é«˜ï¼ˆè¿‡åº¦æŠ•å…¥ï¼‰
âŒ ç”¨æˆ·æ„ŸçŸ¥ä¸åˆ°å·®åˆ«

åˆç†çš„SLOï¼ˆå¦‚99.9%ï¼‰ï¼š
âœ… ç”¨æˆ·æ»¡æ„åº¦é«˜
âœ… å¼€å‘æ•ˆç‡å¹³è¡¡
âœ… æˆæœ¬æŠ•å…¥åˆç†
```

**ä¸åŒæœåŠ¡ç±»å‹çš„SLOå‚è€ƒ**ï¼š

| æœåŠ¡ç±»å‹ | å¯ç”¨æ€§SLO | å»¶è¿ŸSLO | è¯´æ˜ |
|----------|-----------|---------|------|
| **æ ¸å¿ƒAPI** | 99.9% | P95<200ms | ç”¨æˆ·ç›´æ¥æ„ŸçŸ¥ |
| **å†…éƒ¨æœåŠ¡** | 99.5% | P95<500ms | å†…éƒ¨è°ƒç”¨ |
| **æ‰¹å¤„ç†** | 99% | æ— ä¸¥æ ¼è¦æ±‚ | éå®æ—¶å¤„ç† |
| **ç›‘æ§ç³»ç»Ÿ** | 99.95% | P95<100ms | å…³é”®åŸºç¡€è®¾æ–½ |

### 5.4 é”™è¯¯é¢„ç®—ç®¡ç†


**é”™è¯¯é¢„ç®—æ¦‚å¿µ**ï¼š
é”™è¯¯é¢„ç®—å°±æ˜¯æˆ‘ä»¬å…è®¸"çŠ¯é”™"çš„é¢åº¦ï¼Œç”¨å®Œäº†å°±è¦æš‚åœå‘å¸ƒä¸“å¿ƒä¿®å¤ã€‚

```
é”™è¯¯é¢„ç®—è®¡ç®—ï¼š
SLO: 99.9% å¯ç”¨æ€§
é”™è¯¯é¢„ç®—: 1 - 0.999 = 0.1% = 0.001

æœˆåº¦é”™è¯¯é¢„ç®—ï¼š
30å¤© Ã— 24å°æ—¶ Ã— 60åˆ†é’Ÿ Ã— 0.001 = 43.2åˆ†é’Ÿ

æ„æ€æ˜¯ï¼šæ¯æœˆæœ€å¤šå…è®¸43.2åˆ†é’Ÿçš„æ•…éšœæ—¶é—´
```

**é”™è¯¯é¢„ç®—ç›‘æ§**ï¼š
```promql
# è®¡ç®—è¿‡å»30å¤©çš„é”™è¯¯é¢„ç®—æ¶ˆè€—
(
  1 - (
    sum(rate(http_requests_total{status_code!~"5.."}[30d])) /
    sum(rate(http_requests_total[30d]))
  )
) / 0.001 * 100
```

---

## 6. âš–ï¸ æŒ‡æ ‡åŸºæ•°æ§åˆ¶ä¸ä¼˜åŒ–ç­–ç•¥


### 6.1 æŒ‡æ ‡åŸºæ•°é—®é¢˜çš„å±å®³


**ä»€ä¹ˆæ˜¯æŒ‡æ ‡åŸºæ•°**ï¼š
æŒ‡æ ‡åŸºæ•°å°±æ˜¯æŒ‡æ ‡æ‰€æœ‰å¯èƒ½çš„æ ‡ç­¾ç»„åˆæ•°é‡ã€‚

```
ç¤ºä¾‹è¯´æ˜ï¼š
æŒ‡æ ‡ï¼šhttp_requests_total{method, endpoint, status_code}

å¦‚æœæœ‰ï¼š
â€¢ method: 4ç§å€¼ï¼ˆGET,POST,PUT,DELETEï¼‰
â€¢ endpoint: 100ä¸ªæ¥å£
â€¢ status_code: 10ç§çŠ¶æ€ç 

æ€»åŸºæ•° = 4 Ã— 100 Ã— 10 = 4000ä¸ªæ—¶é—´åºåˆ—
```

**é«˜åŸºæ•°çš„å±å®³**ï¼š

| å½±å“æ–¹é¢ | å…·ä½“è¡¨ç° | è§£å†³è¿«åˆ‡æ€§ |
|----------|----------|------------|
| **å†…å­˜æ¶ˆè€—** | æ¯ä¸ªåºåˆ—çº¦1-2KBå†…å­˜ | ğŸ”´ ç«‹å³è§£å†³ |
| **æŸ¥è¯¢æ€§èƒ½** | æŸ¥è¯¢é€Ÿåº¦çº¿æ€§ä¸‹é™ | ğŸŸ¡ é€æ­¥ä¼˜åŒ– |
| **å­˜å‚¨ç©ºé—´** | ç£ç›˜ç©ºé—´å¿«é€Ÿå¢é•¿ | ğŸŸ¡ ä¸­æœŸè§„åˆ’ |
| **ç½‘ç»œä¼ è¾“** | æŠ“å–æ—¶é—´å˜é•¿ | ğŸŸ¢ å¯ä»¥å¿å— |

### 6.2 åŸºæ•°æ§åˆ¶ç­–ç•¥


**ç­–ç•¥ä¸€ï¼šæ ‡ç­¾å€¼æ ‡å‡†åŒ–**
```python
def normalize_labels(endpoint, user_agent):
    """æ ‡ç­¾å€¼æ ‡å‡†åŒ–å¤„ç†"""
    
    # è·¯å¾„å‚æ•°æ ‡å‡†åŒ–
    endpoint = re.sub(r'/\d+', '/{id}', endpoint)
    endpoint = re.sub(r'/[0-9a-f-]{36}', '/{uuid}', endpoint)
    
    # User-Agentæ ‡å‡†åŒ–ï¼ˆåªä¿ç•™ä¸»è¦æµè§ˆå™¨ï¼‰
    if 'Chrome' in user_agent:
        user_agent = 'Chrome'
    elif 'Firefox' in user_agent:
        user_agent = 'Firefox'
    elif 'Safari' in user_agent:
        user_agent = 'Safari'
    else:
        user_agent = 'Other'
    
    return endpoint, user_agent
```

**ç­–ç•¥äºŒï¼šåŠ¨æ€æ ‡ç­¾è¿‡æ»¤**
```python
from prometheus_client import Counter

class SafeCounter:
    """åŸºæ•°å®‰å…¨çš„è®¡æ•°å™¨"""
    def __init__(self, name, description, labelnames, max_cardinality=1000):
        self.counter = Counter(name, description, labelnames)
        self.max_cardinality = max_cardinality
        self.current_cardinality = 0
        self.label_combinations = set()
    
    def labels(self, **labels):
        label_key = tuple(sorted(labels.items()))
        
        # æ£€æŸ¥åŸºæ•°é™åˆ¶
        if (label_key not in self.label_combinations and 
            self.current_cardinality >= self.max_cardinality):
            # ä½¿ç”¨é»˜è®¤æ ‡ç­¾å€¼
            labels = {k: 'other' for k in labels.keys()}
            label_key = tuple(sorted(labels.items()))
        
        if label_key not in self.label_combinations:
            self.label_combinations.add(label_key)
            self.current_cardinality += 1
            
        return self.counter.labels(**labels)
```

### 6.3 åŸºæ•°ç›‘æ§ä¸å‘Šè­¦


**åŸºæ•°ç›‘æ§æŒ‡æ ‡**ï¼š
```python
from prometheus_client import Gauge

# ç›‘æ§æŒ‡æ ‡åŸºæ•°
metrics_cardinality = Gauge('prometheus_metrics_cardinality',
                          'PrometheusæŒ‡æ ‡åŸºæ•°',
                          ['metric_name'])

def monitor_cardinality():
    """ç›‘æ§å„æŒ‡æ ‡çš„åŸºæ•°"""
    for family in REGISTRY.collect():
        if hasattr(family, 'samples'):
            cardinality = len(family.samples)
            metrics_cardinality.labels(
                metric_name=family.name
            ).set(cardinality)
```

**åŸºæ•°å‘Šè­¦è§„åˆ™**ï¼š
```yaml
groups:
- name: cardinality.rules
  rules:
  - alert: HighMetricCardinality
    expr: prometheus_metrics_cardinality > 5000
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "æŒ‡æ ‡åŸºæ•°è¿‡é«˜"
      description: "æŒ‡æ ‡{{ $labels.metric_name }}çš„åŸºæ•°ä¸º{{ $value }}ï¼Œè¶…è¿‡5000"
```

---

## 7. ğŸ”§ è‡ªå®šä¹‰æŒ‡æ ‡æš´éœ²æ–¹æ³•


### 7.1 Prometheus Clientä½¿ç”¨


**Pythonåº”ç”¨é›†æˆç¤ºä¾‹**ï¼š
```python
from prometheus_client import start_http_server, Counter, Gauge, Histogram
import time
import random

# å®šä¹‰æŒ‡æ ‡
REQUEST_COUNT = Counter('app_requests_total', 'è¯·æ±‚æ€»æ•°', ['method', 'endpoint'])
ACTIVE_USERS = Gauge('app_active_users', 'å½“å‰æ´»è·ƒç”¨æˆ·æ•°')
REQUEST_LATENCY = Histogram('app_request_latency_seconds', 'è¯·æ±‚å»¶è¿Ÿ')

class MetricsMiddleware:
    """Flaskä¸­é—´ä»¶ç¤ºä¾‹"""
    def __init__(self, app):
        self.app = app
        
    def __call__(self, environ, start_response):
        start_time = time.time()
        method = environ['REQUEST_METHOD']
        path = environ['PATH_INFO']
        
        # æ‰§è¡Œè¯·æ±‚
        result = self.app(environ, start_response)
        
        # è®°å½•æŒ‡æ ‡
        duration = time.time() - start_time
        REQUEST_COUNT.labels(method=method, endpoint=path).inc()
        REQUEST_LATENCY.observe(duration)
        
        return result

# å¯åŠ¨æŒ‡æ ‡æœåŠ¡å™¨
if __name__ == '__main__':
    start_http_server(8000)  # æŒ‡æ ‡ç«¯å£
    # å¯åŠ¨åº”ç”¨...
```

### 7.2 é…ç½®æ–‡ä»¶æ–¹å¼æš´éœ²


**åŸºäºæ–‡ä»¶çš„æŒ‡æ ‡æ”¶é›†å™¨**ï¼š
```python
import json
import os
from prometheus_client import CollectorRegistry, Gauge
from prometheus_client.core import REGISTRY

class FileBasedCollector:
    """åŸºäºæ–‡ä»¶çš„æŒ‡æ ‡æ”¶é›†å™¨"""
    
    def __init__(self, metrics_dir='/tmp/metrics'):
        self.metrics_dir = metrics_dir
        self.gauges = {}
        
    def collect(self):
        """ä»æ–‡ä»¶ä¸­è¯»å–æŒ‡æ ‡"""
        if not os.path.exists(self.metrics_dir):
            return
            
        for filename in os.listdir(self.metrics_dir):
            if filename.endswith('.json'):
                filepath = os.path.join(self.metrics_dir, filename)
                try:
                    with open(filepath, 'r') as f:
                        metrics_data = json.load(f)
                    
                    for metric_name, metric_value in metrics_data.items():
                        if metric_name not in self.gauges:
                            self.gauges[metric_name] = Gauge(
                                metric_name, 
                                f'ä»æ–‡ä»¶{filename}è¯»å–çš„æŒ‡æ ‡'
                            )
                        
                        if isinstance(metric_value, (int, float)):
                            self.gauges[metric_name].set(metric_value)
                            
                except (json.JSONDecodeError, IOError):
                    continue

# æ³¨å†Œæ”¶é›†å™¨
REGISTRY.register(FileBasedCollector())
```

### 7.3 è„šæœ¬åŒ–æŒ‡æ ‡ç”Ÿæˆ


**å®šæ—¶è„šæœ¬ç”ŸæˆæŒ‡æ ‡**ï¼š
```bash
#!/bin/bash
# metrics_collector.sh

METRICS_FILE="/tmp/metrics/system_metrics.json"
mkdir -p "$(dirname "$METRICS_FILE")"

# æ”¶é›†ç³»ç»ŸæŒ‡æ ‡
cat > "$METRICS_FILE" << EOF
{
  "system_load_1min": $(uptime | awk '{print $(NF-2)}' | sed 's/,//'),
  "system_memory_used_percent": $(free | grep Mem | awk '{printf "%.2f", $3/$2 * 100}'),
  "system_disk_used_percent": $(df -h / | tail -1 | awk '{print $5}' | sed 's/%//'),
  "system_process_count": $(ps aux | wc -l),
  "timestamp": $(date +%s)
}
EOF

echo "ç³»ç»ŸæŒ‡æ ‡å·²æ›´æ–°: $(date)"
```

**å®šæ—¶ä»»åŠ¡é…ç½®**ï¼š
```bash
# crontab -e
# æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡æŒ‡æ ‡æ”¶é›†
* * * * * /path/to/metrics_collector.sh >> /var/log/metrics.log 2>&1
```

---

## 8. ğŸ“ˆ æŒ‡æ ‡èšåˆä¸é¢„è®¡ç®—ä¼˜åŒ–


### 8.1 ä¸ºä»€ä¹ˆéœ€è¦é¢„èšåˆ


**é¢„èšåˆçš„ä»·å€¼**ï¼š
```
å®æ—¶æŸ¥è¯¢ vs é¢„èšåˆå¯¹æ¯”ï¼š

å®æ—¶æŸ¥è¯¢ï¼š
â€¢ æŸ¥è¯¢æ—¶è®¡ç®—ï¼šsum(rate(http_requests_total[5m]))
â€¢ æ¶ˆè€—èµ„æºï¼šæ¯æ¬¡æŸ¥è¯¢éƒ½è¦è®¡ç®—
â€¢ å“åº”å»¶è¿Ÿï¼šå¤æ‚æŸ¥è¯¢å¯èƒ½å¾ˆæ…¢

é¢„èšåˆï¼š
â€¢ å®šæœŸè®¡ç®—ï¼šæ¯åˆ†é’Ÿè®¡ç®—ä¸€æ¬¡å¹¶å­˜å‚¨ç»“æœ
â€¢ èŠ‚çœèµ„æºï¼šæŸ¥è¯¢æ—¶ç›´æ¥è¯»å–ç»“æœ
â€¢ å“åº”å¿«é€Ÿï¼šç®€å•çš„æ•°æ®è¯»å–
```

### 8.2 Recording Ruleså®ç°


**Prometheus Recording Rulesé…ç½®**ï¼š
```yaml
# prometheus.rules.yml
groups:
- name: aggregation.rules
  interval: 30s
  rules:
  # HTTPè¯·æ±‚é€Ÿç‡é¢„èšåˆ
  - record: http:request_rate_5m
    expr: |
      sum(rate(http_requests_total[5m])) by (job, instance, method)
      
  # HTTPé”™è¯¯ç‡é¢„èšåˆ  
  - record: http:error_rate_5m
    expr: |
      sum(rate(http_requests_total{status_code=~"5.."}[5m])) by (job, instance)
      /
      sum(rate(http_requests_total[5m])) by (job, instance)
      
  # ä¸šåŠ¡æŒ‡æ ‡èšåˆ
  - record: business:hourly_revenue
    expr: |
      increase(business_order_amount_total[1h])
      
  # èµ„æºä½¿ç”¨ç‡èšåˆ
  - record: node:cpu_utilization
    expr: |
      100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

### 8.3 åº”ç”¨å±‚é¢„èšåˆ


**åº”ç”¨å†…é¢„èšåˆç¤ºä¾‹**ï¼š
```python
import threading
import time
from collections import defaultdict
from prometheus_client import Gauge

class MetricsAggregator:
    """åº”ç”¨å±‚æŒ‡æ ‡èšåˆå™¨"""
    
    def __init__(self, interval=60):
        self.interval = interval
        self.raw_metrics = defaultdict(list)
        self.aggregated_metrics = {}
        self.lock = threading.Lock()
        
        # é¢„èšåˆç»“æœæŒ‡æ ‡
        self.avg_response_time = Gauge('http_avg_response_time_1m', 
                                     '1åˆ†é’Ÿå¹³å‡å“åº”æ—¶é—´',
                                     ['endpoint'])
        self.request_rate = Gauge('http_request_rate_1m',
                                '1åˆ†é’Ÿè¯·æ±‚é€Ÿç‡', 
                                ['endpoint'])
        
        # å¯åŠ¨èšåˆçº¿ç¨‹
        self.start_aggregation_thread()
    
    def record_request(self, endpoint, response_time):
        """è®°å½•åŸå§‹è¯·æ±‚æ•°æ®"""
        with self.lock:
            self.raw_metrics[endpoint].append({
                'response_time': response_time,
                'timestamp': time.time()
            })
    
    def aggregate_metrics(self):
        """æ‰§è¡ŒæŒ‡æ ‡èšåˆ"""
        now = time.time()
        cutoff_time = now - self.interval
        
        with self.lock:
            for endpoint, requests in self.raw_metrics.items():
                # è¿‡æ»¤æ—¶é—´çª—å£å†…çš„è¯·æ±‚
                recent_requests = [
                    r for r in requests 
                    if r['timestamp'] > cutoff_time
                ]
                
                if recent_requests:
                    # è®¡ç®—å¹³å‡å“åº”æ—¶é—´
                    avg_time = sum(r['response_time'] for r in recent_requests) / len(recent_requests)
                    self.avg_response_time.labels(endpoint=endpoint).set(avg_time)
                    
                    # è®¡ç®—è¯·æ±‚é€Ÿç‡ï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰
                    rate = len(recent_requests) / self.interval
                    self.request_rate.labels(endpoint=endpoint).set(rate)
                
                # æ¸…ç†è¿‡æœŸæ•°æ®
                self.raw_metrics[endpoint] = recent_requests
    
    def start_aggregation_thread(self):
        """å¯åŠ¨èšåˆçº¿ç¨‹"""
        def worker():
            while True:
                self.aggregate_metrics()
                time.sleep(self.interval)
        
        thread = threading.Thread(target=worker, daemon=True)
        thread.start()
```

---

## 9. ğŸ“‹ ç›‘æ§è¦†ç›–ç‡è¯„ä¼°ä½“ç³»


### 9.1 ç›‘æ§è¦†ç›–ç‡å®šä¹‰


**ä»€ä¹ˆæ˜¯ç›‘æ§è¦†ç›–ç‡**ï¼š
ç›‘æ§è¦†ç›–ç‡å°±æ˜¯è¡¡é‡æˆ‘ä»¬çš„ç›‘æ§ç³»ç»Ÿæ˜¯å¦"çœ‹å¾—åˆ°"æ‰€æœ‰é‡è¦çš„ç³»ç»Ÿç»„ä»¶å’Œä¸šåŠ¡æµç¨‹ã€‚

```
ç±»æ¯”ç†è§£ï¼š
ç›‘æ§ç³»ç»Ÿ = å®‰é˜²æ‘„åƒå¤´ç³»ç»Ÿ
è¦†ç›–ç‡ = æ‘„åƒå¤´èƒ½ç›‘æ§åˆ°çš„åŒºåŸŸæ¯”ä¾‹

ç›²åŒºé£é™©ï¼š
â€¢ æŠ€æœ¯ç›²åŒºï¼šæŸäº›æœåŠ¡æ²¡æœ‰ç›‘æ§
â€¢ ä¸šåŠ¡ç›²åŒºï¼šé‡è¦ä¸šåŠ¡æµç¨‹æ²¡æœ‰æŒ‡æ ‡
â€¢ æ—¶é—´ç›²åŒºï¼šæŸäº›æ—¶æ®µç›‘æ§å¤±æ•ˆ
```

### 9.2 è¦†ç›–ç‡è¯„ä¼°ç»´åº¦


**å¤šç»´åº¦è¦†ç›–ç‡è¯„ä¼°**ï¼š

| ç»´åº¦ | è¯„ä¼°å†…å®¹ | ç›®æ ‡è¦†ç›–ç‡ | è¯„ä¼°æ–¹æ³• |
|------|----------|------------|----------|
| **æœåŠ¡è¦†ç›–** | æ‰€æœ‰æœåŠ¡éƒ½æœ‰åŸºç¡€ç›‘æ§ | 100% | æœåŠ¡æ¸…å•å¯¹æ¯” |
| **æ¥å£è¦†ç›–** | é‡è¦APIéƒ½æœ‰ç›‘æ§ | 95% | æ¥å£è°ƒç”¨ç»Ÿè®¡ |
| **é”™è¯¯è¦†ç›–** | æ‰€æœ‰é”™è¯¯ç±»å‹å¯ç›‘æµ‹ | 90% | é”™è¯¯æ—¥å¿—åˆ†æ |
| **ä¸šåŠ¡è¦†ç›–** | å…³é”®ä¸šåŠ¡æµç¨‹æœ‰æŒ‡æ ‡ | 80% | ä¸šåŠ¡æµç¨‹æ¢³ç† |

### 9.3 è¦†ç›–ç‡æ£€æŸ¥å·¥å…·


**è‡ªåŠ¨åŒ–è¦†ç›–ç‡æ£€æŸ¥**ï¼š
```python
import requests
import json
from collections import defaultdict

class MonitoringCoverageChecker:
    """ç›‘æ§è¦†ç›–ç‡æ£€æŸ¥å·¥å…·"""
    
    def __init__(self, prometheus_url, service_registry):
        self.prometheus_url = prometheus_url
        self.service_registry = service_registry
        self.coverage_report = defaultdict(dict)
    
    def check_service_coverage(self):
        """æ£€æŸ¥æœåŠ¡ç›‘æ§è¦†ç›–ç‡"""
        # è·å–æ‰€æœ‰åº”è¯¥ç›‘æ§çš„æœåŠ¡åˆ—è¡¨
        expected_services = set(self.service_registry.get_all_services())
        
        # è·å–å½“å‰æœ‰ç›‘æ§æ•°æ®çš„æœåŠ¡
        query = 'group by (job) ({__name__=~".*"})'
        monitored_services = set(self.query_prometheus(query))
        
        # è®¡ç®—è¦†ç›–ç‡
        coverage_rate = len(monitored_services) / len(expected_services)
        missing_services = expected_services - monitored_services
        
        self.coverage_report['services'] = {
            'total': len(expected_services),
            'monitored': len(monitored_services),
            'coverage_rate': coverage_rate,
            'missing': list(missing_services)
        }
        
        return coverage_rate
    
    def check_endpoint_coverage(self, service_name):
        """æ£€æŸ¥APIç«¯ç‚¹ç›‘æ§è¦†ç›–ç‡"""
        # ä»æœåŠ¡æ³¨å†Œä¸­å¿ƒè·å–æ‰€æœ‰ç«¯ç‚¹
        expected_endpoints = self.service_registry.get_endpoints(service_name)
        
        # ä»ç›‘æ§æ•°æ®ä¸­è·å–å·²ç›‘æ§çš„ç«¯ç‚¹
        query = f'group by (endpoint) (http_requests_total{{job="{service_name}"}})'
        monitored_endpoints = set(self.query_prometheus(query))
        
        coverage_rate = len(monitored_endpoints) / len(expected_endpoints) if expected_endpoints else 0
        
        self.coverage_report['endpoints'][service_name] = {
            'total': len(expected_endpoints),
            'monitored': len(monitored_endpoints), 
            'coverage_rate': coverage_rate
        }
        
        return coverage_rate
    
    def generate_coverage_report(self):
        """ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š"""
        report = {
            'timestamp': time.time(),
            'overall_score': self.calculate_overall_score(),
            'details': dict(self.coverage_report),
            'recommendations': self.get_recommendations()
        }
        
        return json.dumps(report, indent=2, ensure_ascii=False)
    
    def query_prometheus(self, query):
        """æŸ¥è¯¢Prometheus"""
        response = requests.get(
            f'{self.prometheus_url}/api/v1/query',
            params={'query': query}
        )
        
        if response.status_code == 200:
            data = response.json()
            return [item['metric'] for item in data['data']['result']]
        
        return []
```

### 9.4 è¦†ç›–ç‡æå‡ç­–ç•¥


**è¦†ç›–ç‡æå‡è·¯å¾„**ï¼š
```
é˜¶æ®µä¸€ï¼šåŸºç¡€è¦†ç›–(0-60%)
â€¢ éƒ¨ç½²åŸºç¡€ç›‘æ§agent
â€¢ æ·»åŠ åŸºæœ¬çš„æŠ€æœ¯æŒ‡æ ‡
â€¢ è®¾ç½®æ ¸å¿ƒå‘Šè­¦è§„åˆ™

é˜¶æ®µäºŒï¼šæ·±åº¦è¦†ç›–(60-80%)  
â€¢ æ·»åŠ ä¸šåŠ¡æŒ‡æ ‡
â€¢ å®Œå–„åº”ç”¨ç›‘æ§
â€¢ è‡ªå®šä¹‰æ£€æŸ¥è„šæœ¬

é˜¶æ®µä¸‰ï¼šå…¨é¢è¦†ç›–(80-95%)
â€¢ ç”¨æˆ·ä½“éªŒç›‘æ§
â€¢ ç«¯åˆ°ç«¯é“¾è·¯è¿½è¸ª
â€¢ æ™ºèƒ½å¼‚å¸¸æ£€æµ‹

é˜¶æ®µå››ï¼šç²¾ç»†ä¼˜åŒ–(95%+)
â€¢ é¢„æµ‹æ€§ç›‘æ§
â€¢ è‡ªåŠ¨åŒ–ä¿®å¤
â€¢ æŒç»­ä¼˜åŒ–è°ƒæ•´
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å››å¤§æŒ‡æ ‡ç±»å‹ï¼šCounterç´¯è®¡å€¼ã€Gaugeç¬æ—¶å€¼ã€Histogramåˆ†å¸ƒã€Summaryæ‘˜è¦
ğŸ”¸ å‘½åè§„èŒƒï¼šnamespace_subsystem_name_unitæ ¼å¼ï¼Œæ ‡ç­¾è®¾è®¡è¦æ§åˆ¶åŸºæ•°
ğŸ”¸ ä¸šåŠ¡æŒ‡æ ‡ï¼šæŠ€æœ¯æŒ‡æ ‡çœ‹ç³»ç»Ÿå¥åº·ï¼Œä¸šåŠ¡æŒ‡æ ‡çœ‹ä¸šåŠ¡æˆæ•ˆ
ğŸ”¸ SLI/SLOï¼šç”¨æŒ‡æ ‡è¡¡é‡æœåŠ¡è´¨é‡ï¼Œè®¾ç½®åˆç†ç›®æ ‡å’Œé”™è¯¯é¢„ç®—
ğŸ”¸ åŸºæ•°æ§åˆ¶ï¼šé«˜åŸºæ•°æ˜¯æ€§èƒ½æ€æ‰‹ï¼Œå¿…é¡»ä¸¥æ ¼æ§åˆ¶æ ‡ç­¾ç»„åˆæ•°é‡
ğŸ”¸ æŒ‡æ ‡æš´éœ²ï¼šå¤šç§æ–¹å¼é›†æˆç›‘æ§ï¼Œé€‰æ‹©æœ€é€‚åˆçš„æš´éœ²æ–¹æ³•
ğŸ”¸ é¢„èšåˆï¼šå‡å°‘å®æ—¶è®¡ç®—å‹åŠ›ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
ğŸ”¸ ç›‘æ§è¦†ç›–ï¼šè¯„ä¼°ç›‘æ§ç›²åŒºï¼Œç¡®ä¿å…³é”®ç»„ä»¶éƒ½è¢«ç›‘æ§
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æŒ‡æ ‡ç±»å‹é€‰æ‹©ç­–ç•¥**
```
é€‰æ‹©åŸåˆ™ï¼š
â€¢ ç´¯è®¡å€¼é€‰Counterï¼šè¯·æ±‚æ•°ã€å­—èŠ‚æ•°ã€é”™è¯¯æ•°
â€¢ ç¬æ—¶å€¼é€‰Gaugeï¼šCPUä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨é‡ã€è¿æ¥æ•°
â€¢ åˆ†å¸ƒåˆ†æé€‰Histogramï¼šå“åº”æ—¶é—´ã€è¯·æ±‚å¤§å°
â€¢ ç®€å•åˆ†ä½æ•°é€‰Summaryï¼šå•æœºåˆ†æåœºæ™¯
```

**ğŸ”¹ æ ‡ç­¾è®¾è®¡çš„å¹³è¡¡è‰ºæœ¯**
```
æ ‡ç­¾è®¾è®¡è¦å¹³è¡¡ï¼š
â€¢ åˆ†æéœ€æ±‚ vs åŸºæ•°æ§åˆ¶
â€¢ è¯¦ç»†ç¨‹åº¦ vs æ€§èƒ½å½±å“  
â€¢ çµæ´»æ€§ vs æ ‡å‡†åŒ–

è®°ä½ï¼šå®å¯å°‘ä¸€äº›æ ‡ç­¾ï¼Œä¹Ÿä¸è¦åŸºæ•°çˆ†ç‚¸
```

**ğŸ”¹ ä¸šåŠ¡ç›‘æ§çš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆä¸šåŠ¡ç›‘æ§æ›´é‡è¦ï¼š
â€¢ æŠ€æœ¯æ­£å¸¸ä¸ä»£è¡¨ä¸šåŠ¡æ­£å¸¸
â€¢ ä¸šåŠ¡å¼‚å¸¸å¾€å¾€æ¯”æŠ€æœ¯å¼‚å¸¸å½±å“æ›´å¤§
â€¢ ä¸šåŠ¡æŒ‡æ ‡èƒ½æ›´æ—©å‘ç°é—®é¢˜
â€¢ ç›´æ¥å…³è”ä¸šåŠ¡ä»·å€¼å’Œç”¨æˆ·ä½“éªŒ
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š ç›‘æ§æŒ‡æ ‡è®¾è®¡æ£€æŸ¥æ¸…å•**ï¼š
- [ ] **æŒ‡æ ‡å‘½å**ï¼šæ˜¯å¦ç¬¦åˆè§„èŒƒï¼Œå«ä¹‰æ¸…æ™°
- [ ] **æŒ‡æ ‡ç±»å‹**ï¼šæ˜¯å¦é€‰æ‹©äº†æ­£ç¡®çš„æŒ‡æ ‡ç±»å‹
- [ ] **æ ‡ç­¾è®¾è®¡**ï¼šæ˜¯å¦æ§åˆ¶äº†åŸºæ•°ï¼Œæ ‡ç­¾å€¼æ˜¯å¦æ ‡å‡†åŒ–
- [ ] **ä¸šåŠ¡ç›¸å…³**ï¼šæ˜¯å¦åŒ…å«äº†å…³é”®ä¸šåŠ¡æŒ‡æ ‡
- [ ] **SLIå®šä¹‰**ï¼šæ˜¯å¦å®šä¹‰äº†åˆé€‚çš„SLIå’ŒSLO
- [ ] **åŸºæ•°ç›‘æ§**ï¼šæ˜¯å¦æœ‰åŸºæ•°ç›‘æ§å’Œå‘Šè­¦
- [ ] **é¢„èšåˆ**ï¼šå¤æ‚æŸ¥è¯¢æ˜¯å¦ä½¿ç”¨äº†é¢„èšåˆ
- [ ] **è¦†ç›–è¯„ä¼°**ï¼šæ˜¯å¦å®šæœŸè¯„ä¼°ç›‘æ§è¦†ç›–ç‡

**ğŸš€ å®æ–½å»ºè®®**ï¼š
1. **ä»ç®€å•å¼€å§‹**ï¼šå…ˆå®ç°åŸºç¡€çš„æŠ€æœ¯æŒ‡æ ‡ç›‘æ§
2. **é€æ­¥ä¸°å¯Œ**ï¼šå†æ·»åŠ ä¸šåŠ¡æŒ‡æ ‡å’Œè‡ªå®šä¹‰ç›‘æ§  
3. **æŒç»­ä¼˜åŒ–**ï¼šå®šæœŸå®¡æŸ¥æŒ‡æ ‡è´¨é‡å’Œæ€§èƒ½å½±å“
4. **å›¢é˜Ÿå…±è¯†**ï¼šå»ºç«‹å›¢é˜Ÿç»Ÿä¸€çš„ç›‘æ§è§„èŒƒå’Œæµç¨‹

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- æŒ‡æ ‡å››ç±»è¦åˆ†æ¸…ï¼ŒCounterç´¯è®¡Gaugeç¬æ—¶
- æ ‡ç­¾åŸºæ•°éœ€æ§åˆ¶ï¼Œå‘½åè§„èŒƒè¦ç»Ÿä¸€
- ä¸šåŠ¡æŒ‡æ ‡ä¸å¯å¿½ï¼ŒSLIç›®æ ‡å®šåˆç†
- é¢„èšåˆæ¥ææ€§èƒ½ï¼Œè¦†ç›–ç›²åŒºè¦æ£€æŸ¥