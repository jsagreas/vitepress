---
title: 8、防火墙与安全策略故障
---
## 📚 目录

1. [防火墙故障概述](#1-防火墙故障概述)
2. [iptables规则排查](#2-iptables规则排查)
3. [firewalld配置检查](#3-firewalld配置检查)
4. [SELinux网络策略诊断](#4-selinux网络策略诊断)
5. [网络ACL规则验证](#5-网络acl规则验证)
6. [端口访问权限排查](#6-端口访问权限排查)
7. [网络安全组配置](#7-网络安全组配置)
8. [VPN连接问题诊断](#8-vpn连接问题诊断)
9. [网络访问日志分析](#9-网络访问日志分析)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔥 防火墙故障概述


### 1.1 什么是防火墙故障


> 📌 **核心概念**  
> 防火墙故障指的是网络防护机制阻止了正常的网络通信，导致服务无法访问、连接超时或权限被拒绝等问题。

**防火墙的作用机制**：
```
网络请求流程：
客户端 → [防火墙规则检查] → 目标服务器
         ↑
    在这里可能被拦截！
```

**常见故障现象**：
- **连接超时**：客户端无法连接到服务器端口
- **权限拒绝**：连接被明确拒绝
- **部分功能异常**：某些端口可访问，某些不可访问
- **间歇性问题**：有时能连有时不能连

### 1.2 Linux防火墙层次结构


```
Linux网络安全防护体系：
┌─────────────────────────────┐
│        应用层安全           │ ← 应用程序自身的访问控制
├─────────────────────────────┤
│      SELinux网络策略        │ ← 强制访问控制策略
├─────────────────────────────┤
│    firewalld/iptables      │ ← 包过滤防火墙
├─────────────────────────────┤
│      网络ACL规则           │ ← 网络访问控制列表
├─────────────────────────────┤
│      物理网络安全          │ ← 网络设备层面的安全
└─────────────────────────────┘
```

### 1.3 故障诊断基本思路


**🔍 诊断流程**：
1. **确认症状**：具体什么功能不能用
2. **定位层次**：在哪一层被阻止了
3. **检查规则**：相关的安全规则是什么
4. **测试验证**：修改规则后是否恢复
5. **持久化配置**：确保重启后仍然有效

---

## 2. 🛡️ iptables规则排查


### 2.1 iptables工作原理


> 💡 **通俗理解**  
> iptables就像是一个门卫，根据预设的规则决定哪些网络请求可以通过，哪些要被拒绝。每个请求都要经过多道关卡检查。

**iptables表和链的关系**：
```
数据包处理流程：
                    INPUT链
                      ↓
网络请求 → [PREROUTING] → [路由决策] → [FORWARD] → [POSTROUTING] → 转发
                              ↓
                           OUTPUT链
                              ↓
                         本地进程
```

### 2.2 iptables规则查看与分析


#### 🔸 基础规则查看命令


```bash
# 查看所有规则（最常用）
iptables -L -n -v --line-numbers

# 查看特定表的规则
iptables -t filter -L -n -v    # 默认表，处理过滤
iptables -t nat -L -n -v       # NAT表，处理地址转换
iptables -t mangle -L -n -v    # 修改数据包
```

**命令参数解释**：
- `-L`：列出规则
- `-n`：以数字形式显示IP和端口（不解析域名）
- `-v`：详细信息，显示匹配的包数量
- `--line-numbers`：显示行号，方便删除规则

#### 🔸 规则输出解读


```bash
# 示例输出解读
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num  target     prot opt source               destination         
1    ACCEPT     all  --  127.0.0.1            0.0.0.0/0           
2    DROP       tcp  --  0.0.0.0/0            0.0.0.0/0           tcp dpt:22
3    ACCEPT     tcp  --  192.168.1.0/24       0.0.0.0/0           tcp dpt:80

解读说明：
- Chain INPUT：输入链，处理进入本机的数据包
- policy ACCEPT：默认策略是接受
- num 1：本机回环地址全部允许
- num 2：拒绝所有来源的SSH连接（端口22）
- num 3：允许局域网访问80端口
```

### 2.3 常见iptables故障排查


#### 🔸 SSH连接被拒绝问题


**故障现象**：无法SSH连接到服务器

```bash
# 1. 检查是否有拒绝SSH的规则
iptables -L INPUT -n --line-numbers | grep :22

# 常见问题规则示例：
# 2    DROP       tcp  --  0.0.0.0/0            0.0.0.0/0           tcp dpt:22

# 2. 解决方案：允许特定IP的SSH连接
iptables -I INPUT 1 -s 192.168.1.100 -p tcp --dport 22 -j ACCEPT

# 3. 删除有问题的拒绝规则
iptables -D INPUT 2  # 删除第2行规则
```

#### 🔸 Web服务无法访问问题


**故障现象**：浏览器无法访问网站

```bash
# 1. 检查HTTP相关端口规则
iptables -L INPUT -n | grep -E ':80|:443'

# 2. 如果没有允许规则，添加规则
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 3. 检查OUTPUT链是否有限制
iptables -L OUTPUT -n
```

### 2.4 iptables规则管理最佳实践


> ⚠️ **重要提醒**  
> 修改iptables规则时要小心，错误的规则可能导致失去远程连接。建议先在测试环境验证。

**🔧 安全操作步骤**：

```bash
# 1. 备份当前规则
iptables-save > /root/iptables-backup-$(date +%Y%m%d).rules

# 2. 设置临时规则（重启后失效）
iptables -I INPUT -s 你的IP -j ACCEPT  # 确保自己不被锁定

# 3. 测试规则效果
# 如果测试OK，再保存持久化配置

# 4. 持久化规则（CentOS/RHEL）
service iptables save
# 或者（Ubuntu/Debian）
iptables-save > /etc/iptables/rules.v4
```

---

## 3. 🔥 firewalld配置检查


### 3.1 firewalld基本概念


> 📌 **核心概念**  
> firewalld是一个动态防火墙管理工具，通过"区域（Zone）"的概念来管理网络连接，比iptables更容易配置和管理。

**firewalld与iptables的关系**：
```
应用层面：
用户 → firewall-cmd命令 → firewalld服务 → iptables规则

底层实现：
firewalld最终还是调用iptables来实现包过滤
但提供了更友好的管理界面
```

### 3.2 firewalld状态检查


#### 🔸 基础状态查看


```bash
# 检查firewalld服务状态
systemctl status firewalld

# 检查firewalld是否正在运行
firewall-cmd --state

# 查看当前活动的区域
firewall-cmd --get-active-zones

# 查看默认区域
firewall-cmd --get-default-zone
```

#### 🔸 区域配置查看


```bash
# 列出所有可用区域
firewall-cmd --get-zones

# 查看特定区域的详细配置
firewall-cmd --zone=public --list-all

# 示例输出解读：
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: eth0              # 绑定的网络接口
  sources: 
  services: ssh http https      # 允许的服务
  ports: 8080/tcp              # 允许的端口
  protocols: 
  masquerade: no               # 是否启用地址伪装
  forward-ports: 
  source-ports: 
  icmp-blocks: 
  rich-rules:                  # 高级规则
```

### 3.3 常见firewalld故障诊断


#### 🔸 服务无法访问问题


**诊断步骤**：

```bash
# 1. 确认服务是否在防火墙中开放
firewall-cmd --list-services | grep http

# 2. 如果没有，添加服务
firewall-cmd --add-service=http
firewall-cmd --add-service=https

# 3. 或者直接开放端口
firewall-cmd --add-port=80/tcp
firewall-cmd --add-port=443/tcp

# 4. 永久保存配置
firewall-cmd --runtime-to-permanent
```

#### 🔸 特定IP无法访问问题


**场景**：允许特定IP访问某个服务

```bash
# 1. 创建富规则允许特定IP
firewall-cmd --add-rich-rule='rule source address="192.168.1.100" service name="ssh" accept'

# 2. 查看富规则
firewall-cmd --list-rich-rules

# 3. 删除富规则（如果需要）
firewall-cmd --remove-rich-rule='rule source address="192.168.1.100" service name="ssh" accept'
```

### 3.4 firewalld与iptables的冲突处理


> ⚠️ **常见问题**  
> firewalld和iptables不能同时使用，否则会产生冲突。需要选择其中一个。

**冲突解决方案**：

```bash
# 方案1：使用firewalld（推荐）
systemctl stop iptables
systemctl disable iptables
systemctl enable firewalld
systemctl start firewalld

# 方案2：使用iptables
systemctl stop firewalld
systemctl disable firewalld
systemctl enable iptables
systemctl start iptables
```

---

## 4. 🔒 SELinux网络策略诊断


### 4.1 SELinux网络控制机制


> 📌 **通俗理解**  
> SELinux就像是一个更严格的保安，不仅检查"你是谁"，还要检查"你要干什么"，"你有权限这样做吗"。即使防火墙放行了，SELinux也可能阻止网络连接。

**SELinux工作层次**：
```
网络请求处理流程：
网络包 → iptables检查 → SELinux策略检查 → 应用程序
                ↑               ↑
            网络层过滤      应用层权限控制
```

### 4.2 SELinux状态检查


#### 🔸 基础状态查看


```bash
# 查看SELinux当前状态
getenforce
# 输出：Enforcing（强制模式）、Permissive（宽容模式）、Disabled（禁用）

# 查看详细状态
sestatus

# 临时设置为宽容模式（测试用）
setenforce 0  # 0=宽容模式，1=强制模式
```

#### 🔸 网络相关的SELinux策略查看


```bash
# 查看网络相关的布尔值
getsebool -a | grep -i network

# 查看HTTP相关的SELinux策略
getsebool -a | grep httpd

# 常见的网络布尔值：
httpd_can_network_connect → httpd是否可以发起网络连接
httpd_can_network_relay → httpd是否可以作为网络中继
```

### 4.3 SELinux网络故障排查


#### 🔸 HTTP服务SELinux问题


**故障现象**：Apache/Nginx启动正常但无法访问

```bash
# 1. 检查SELinux是否阻止了HTTP服务
sealert -a /var/log/audit/audit.log | grep httpd

# 2. 检查HTTP端口的SELinux标签
semanage port -l | grep http_port_t

# 3. 如果使用非标准端口，需要添加SELinux标签
semanage port -a -t http_port_t -p tcp 8080

# 4. 允许httpd网络连接
setsebool -P httpd_can_network_connect on
```

#### 🔸 SSH服务SELinux问题


```bash
# 1. 检查SSH端口的SELinux上下文
semanage port -l | grep ssh_port_t

# 2. 如果修改了SSH端口，需要更新SELinux策略
semanage port -a -t ssh_port_t -p tcp 2222  # 假设改为2222端口

# 3. 检查相关的SELinux日志
ausearch -m avc -ts recent | grep sshd
```

### 4.4 SELinux日志分析


#### 🔸 audit日志解读


> 💡 **实用技巧**  
> SELinux违规记录在`/var/log/audit/audit.log`中，使用`sealert`工具可以自动分析并给出解决建议。

```bash
# 分析最近的SELinux拒绝事件
sealert -a /var/log/audit/audit.log

# 实时监控SELinux事件
tail -f /var/log/audit/audit.log | grep AVC

# 示例日志解读：
type=AVC msg=audit(1634567890.123:456): avc: denied { name_connect } 
for pid=1234 comm="httpd" dest=3306 
scontext=system_u:system_r:httpd_t:s0 
tcontext=system_u:object_r:mysqld_port_t:s0 
tclass=tcp_socket

解读：httpd进程尝试连接MySQL端口3306被SELinux拒绝
```

---

## 5. 📋 网络ACL规则验证


### 5.1 网络ACL概念理解


> 📌 **核心概念**  
> 网络ACL（Access Control List）是网络设备上的访问控制规则，类似于网络层面的"黑白名单"，可以基于源IP、目标IP、端口等条件控制网络流量。

**ACL在网络中的位置**：
```
网络流量控制层次：
客户端 → [路由器ACL] → [交换机ACL] → [服务器防火墙] → 应用服务
           ↑             ↑              ↑
        网络设备层    网络设备层      操作系统层
```

### 5.2 Linux网络ACL实现


#### 🔸 基于tcpwrappers的访问控制


```bash
# /etc/hosts.allow - 允许访问的规则
# 格式：服务名: 客户端列表

# 示例配置：
sshd: 192.168.1.0/24          # 允许局域网SSH
sshd: .example.com            # 允许特定域名
ALL: 127.0.0.1               # 本机全部服务允许

# /etc/hosts.deny - 拒绝访问的规则
sshd: ALL                    # 拒绝所有其他SSH连接
ALL: ALL                     # 拒绝所有其他连接（谨慎使用）
```

#### 🔸 检查tcpwrappers配置


```bash
# 1. 确认服务是否支持tcpwrappers
ldd /usr/sbin/sshd | grep wrap

# 2. 测试特定IP是否被允许访问
tcpdmatch sshd 192.168.1.100

# 3. 查看访问日志
grep -i "refused" /var/log/secure
```

### 5.3 应用层ACL控制


#### 🔸 Nginx访问控制


```nginx
# nginx.conf中的访问控制示例
server {
    listen 80;
    server_name example.com;
    
    # 允许特定IP访问
    location /admin {
        allow 192.168.1.0/24;    # 允许局域网
        allow 10.0.0.1;          # 允许特定IP
        deny all;                # 拒绝其他所有
    }
    
    # 限制访问频率
    location / {
        limit_req zone=one burst=10 nodelay;
    }
}
```

#### 🔸 Apache访问控制


```apache
# Apache .htaccess访问控制示例
<Directory "/var/www/html/admin">
    # 基于IP的访问控制
    <RequireAll>
        Require ip 192.168.1
        Require ip 10.0.0.1
    </RequireAll>
</Directory>

# 基于用户认证的访问控制
<Directory "/var/www/html/private">
    AuthType Basic
    AuthName "Private Area"
    AuthUserFile /etc/httpd/.htpasswd
    Require valid-user
</Directory>
```

---

## 6. 🔌 端口访问权限排查


### 6.1 端口占用状态检查


#### 🔸 查看端口监听状态


```bash
# 查看所有监听的端口
netstat -tlnp
# 或使用现代工具
ss -tlnp

# 查看特定端口占用情况
netstat -tlnp | grep :80
ss -tlnp | grep :80

# 示例输出解读：
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      1234/nginx
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      5678/mysqld

解读说明：
- 0.0.0.0:80：监听所有接口的80端口
- 127.0.0.1:3306：只监听本机回环接口的3306端口
```

#### 🔸 端口连通性测试


```bash
# 从外部测试端口连通性
telnet 服务器IP 端口号
# 示例：telnet 192.168.1.100 80

# 使用nc命令测试
nc -zv 服务器IP 端口号
# 示例：nc -zv 192.168.1.100 80

# 测试UDP端口
nc -zuv 服务器IP 端口号
```

### 6.2 应用程序绑定问题


#### 🔸 应用只绑定本地回环问题


**故障现象**：服务在本机可以访问，但从其他机器无法访问

```bash
# 问题诊断：检查应用绑定的地址
netstat -tlnp | grep :3306
# 如果显示 127.0.0.1:3306，说明只绑定了本机

# MySQL解决方案：
# 修改 /etc/mysql/mysql.conf.d/mysqld.cnf
bind-address = 0.0.0.0    # 改为监听所有接口

# Redis解决方案：
# 修改 /etc/redis/redis.conf
bind 0.0.0.0              # 改为监听所有接口

# 重启相关服务
systemctl restart mysql
systemctl restart redis
```

#### 🔸 端口冲突问题


```bash
# 查找端口冲突
lsof -i :端口号

# 示例：查看80端口被哪个进程占用
lsof -i :80

# 如果需要更换端口，修改应用配置
# Apache示例：
# 修改 /etc/httpd/conf/httpd.conf
Listen 8080

# Nginx示例：
# 修改 /etc/nginx/nginx.conf
server {
    listen 8080;
    ...
}
```

---

## 7. ☁️ 网络安全组配置


### 7.1 云环境安全组概念


> 📌 **核心概念**  
> 网络安全组是云平台提供的虚拟防火墙，工作在云平台的网络层，在流量到达虚拟机之前就进行过滤。

**安全组与传统防火墙的区别**：
```
传统防火墙：
物理网络 → 硬件防火墙 → 服务器

云环境：
互联网 → 云平台网络 → [安全组过滤] → 虚拟机 → [OS防火墙] → 应用
                         ↑                    ↑
                    云平台层面             操作系统层面
```

### 7.2 安全组配置检查


#### 🔸 入站规则检查


**典型的入站规则配置**：

| 协议 | 端口范围 | 源地址 | 说明 |
|------|---------|--------|------|
| TCP | 22 | `0.0.0.0/0` | SSH访问 |
| TCP | 80 | `0.0.0.0/0` | HTTP服务 |
| TCP | 443 | `0.0.0.0/0` | HTTPS服务 |
| TCP | 3306 | `192.168.0.0/16` | MySQL（仅内网）|
| ICMP | - | `0.0.0.0/0` | Ping测试 |

#### 🔸 出站规则检查


```bash
# 检查是否限制了出站流量
# 大多数情况下，出站规则应该是允许所有：
协议：ALL
端口：0-65535  
目标：0.0.0.0/0

# 如果出站受限，可能导致：
- 软件包无法下载更新
- DNS解析失败
- 与外部API通信失败
```

### 7.3 安全组故障排查


#### 🔸 连接超时问题


> 🔍 **诊断思路**  
> 如果telnet连接显示"连接超时"而不是"连接拒绝"，通常是安全组或网络ACL的问题。

**排查步骤**：
1. **检查安全组入站规则**是否包含相应端口
2. **检查源IP限制**是否过于严格
3. **检查协议类型**（TCP/UDP）是否正确
4. **检查端口范围**是否覆盖目标端口

#### 🔸 DNS解析问题


```bash
# 故障现象：域名无法解析
nslookup google.com
# 如果超时，检查出站规则是否允许UDP 53端口

# 解决方案：添加出站规则
协议：UDP
端口：53
目标：0.0.0.0/0 或者 8.8.8.8/32, 114.114.114.114/32
```

---

## 8. 🌐 VPN连接问题诊断


### 8.1 VPN连接原理


> 📌 **通俗理解**  
> VPN就像在不安全的网络中挖了一条加密隧道，让数据可以安全地在两点之间传输。但这个隧道的建立需要多个条件都满足。

**VPN连接建立过程**：
```
客户端                                    VPN服务器
   |                                         |
   |--[1]发起连接请求------------------>|
   |<--[2]服务器响应认证挑战-------------|
   |--[3]提交用户凭据------------------>|
   |<--[4]认证成功，分配IP---------------|
   |--[5]建立加密隧道------------------>|
   |<====[6]开始加密数据传输===========>|
```

### 8.2 常见VPN连接问题


#### 🔸 OpenVPN连接问题


**故障1：连接超时**
```bash
# 检查OpenVPN服务状态
systemctl status openvpn@server

# 检查监听端口
netstat -unlp | grep :1194

# 检查防火墙规则
iptables -L | grep 1194
firewall-cmd --list-ports | grep 1194

# 检查路由表
route -n
ip route show
```

**故障2：认证失败**
```bash
# 检查用户证书
openssl x509 -in client.crt -text -noout

# 检查服务器日志
tail -f /var/log/openvpn/server.log

# 检查客户端配置
grep -E "(ca|cert|key)" client.ovpn
```

#### 🔸 IPSec/L2TP连接问题


```bash
# 检查strongSwan服务
systemctl status strongswan

# 检查IPSec连接状态
ipsec status

# 检查L2TP服务
systemctl status xl2tpd

# 检查相关端口是否开放
# IPSec需要：UDP 500, 4500
# L2TP需要：UDP 1701
```

### 8.3 VPN网络路由问题


#### 🔸 路由配置检查


```bash
# 查看路由表
route -n
# 或
ip route show

# 检查是否有VPN相关路由
ip route | grep tun0    # OpenVPN通常使用tun接口
ip route | grep ppp+    # L2TP通常使用ppp接口

# 添加缺失的路由（如果需要）
ip route add 192.168.100.0/24 dev tun0
```

#### 🔸 NAT和转发配置


```bash
# 检查IP转发是否启用
cat /proc/sys/net/ipv4/ip_forward
# 应该输出1，如果是0则需要启用：
echo 1 > /proc/sys/net/ipv4/ip_forward

# 检查NAT规则
iptables -t nat -L POSTROUTING

# 添加NAT规则（如果需要）
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
```

---

## 9. 📊 网络访问日志分析


### 9.1 日志文件位置


**主要日志文件**：
```bash
# 系统日志
/var/log/messages          # 一般系统消息
/var/log/secure           # 安全相关日志（SSH等）
/var/log/audit/audit.log  # SELinux审计日志

# 网络服务日志
/var/log/httpd/access_log    # Apache访问日志
/var/log/httpd/error_log     # Apache错误日志
/var/log/nginx/access.log    # Nginx访问日志
/var/log/nginx/error.log     # Nginx错误日志

# 防火墙日志
/var/log/firewalld          # firewalld日志
/var/log/iptables.log       # iptables日志（如果配置了）
```

### 9.2 访问日志分析技巧


#### 🔸 HTTP访问日志分析


```bash
# Apache/Nginx访问日志格式示例：
192.168.1.100 - - [17/Sep/2025:10:30:45 +0800] "GET /index.html HTTP/1.1" 200 1234

# 分析高频访问IP
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10

# 分析访问的页面
awk '{print $7}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10

# 分析HTTP状态码分布
awk '{print $9}' /var/log/nginx/access.log | sort | uniq -c | sort -nr

# 查找特定时间段的访问
grep "17/Sep/2025:10:" /var/log/nginx/access.log
```

#### 🔸 安全日志分析


```bash
# SSH登录失败分析
grep "Failed password" /var/log/secure | awk '{print $11}' | sort | uniq -c | sort -nr

# SSH成功登录分析
grep "Accepted password" /var/log/secure

# 查看防火墙拒绝的连接
grep "DPT=" /var/log/messages | awk '{print $12}' | cut -d'=' -f2 | sort | uniq -c | sort -nr
```

### 9.3 日志监控和告警


#### 🔸 实时日志监控


```bash
# 实时监控访问日志
tail -f /var/log/nginx/access.log

# 实时监控安全事件
tail -f /var/log/secure | grep -E "(Failed|Invalid)"

# 使用multitail同时监控多个日志
multitail /var/log/nginx/access.log /var/log/secure
```

#### 🔸 日志分析脚本示例


```bash
#!/bin/bash
# 简单的安全监控脚本

# 检查最近1小时的SSH失败登录
failed_ssh=$(grep "$(date -d '1 hour ago' '+%b %d %H')" /var/log/secure | grep "Failed password" | wc -l)

if [ $failed_ssh -gt 10 ]; then
    echo "警告：最近1小时SSH失败登录 $failed_ssh 次" | mail -s "安全警告" admin@example.com
fi

# 检查HTTP 4xx/5xx错误
error_count=$(grep "$(date '+%d/%b/%Y:%H')" /var/log/nginx/access.log | awk '$9>=400' | wc -l)

if [ $error_count -gt 50 ]; then
    echo "警告：最近1小时HTTP错误 $error_count 次" | mail -s "Web服务警告" admin@example.com
fi
```

---

## 10. 📋 核心要点总结


### 10.1 故障诊断总体思路


> 🎯 **诊断原则**  
> 网络安全故障诊断要遵循从外到内、从简单到复杂的原则，逐层排查问题。

**🔍 标准诊断流程**：
```
1. 网络连通性测试 (ping, telnet)
   ↓
2. 服务端口检查 (netstat, ss)
   ↓  
3. 防火墙规则检查 (iptables, firewalld)
   ↓
4. SELinux策略检查 (getenforce, sealert)
   ↓
5. 应用配置检查 (nginx.conf, httpd.conf)
   ↓
6. 日志分析 (access.log, error.log, audit.log)
```

### 10.2 必须掌握的核心命令


**📝 快速参考卡**：
```bash
# 网络连通性测试
ping IP地址
telnet IP地址 端口
nc -zv IP地址 端口

# 端口和进程检查
netstat -tlnp | grep 端口
ss -tlnp | grep 端口
lsof -i :端口

# iptables管理
iptables -L -n -v --line-numbers
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables-save > 备份文件

# firewalld管理
firewall-cmd --list-all
firewall-cmd --add-service=http
firewall-cmd --add-port=8080/tcp

# SELinux检查
getenforce
sealert -a /var/log/audit/audit.log
getsebool -a | grep 服务名
```

### 10.3 常见问题解决方案


**⚖️ 问题类型对比**：

| 故障现象 | **可能原因** | **排查方法** | **解决方案** |
|---------|-------------|-------------|-------------|
| 🔌 连接超时 | `防火墙/安全组阻止` | `telnet测试` | `开放相应端口` |
| ❌ 连接拒绝 | `服务未运行/端口冲突` | `netstat检查` | `启动服务/更换端口` |
| 🔐 认证失败 | `用户权限/SELinux策略` | `日志分析` | `调整权限/SELinux策略` |
| 🌐 DNS问题 | `出站规则限制` | `nslookup测试` | `开放UDP 53端口` |

### 10.4 最佳实践建议


**🔒 安全配置原则**：
- **最小权限原则**：只开放必需的端口和服务
- **分层防护**：结合多种安全措施
- **定期审查**：定期检查和清理不必要的规则
- **日志监控**：建立有效的监控和告警机制

**💡 运维建议**：
- **配置备份**：修改前务必备份当前配置
- **测试环境**：先在测试环境验证配置
- **文档记录**：记录所有配置变更和原因
- **应急预案**：准备配置回滚的方案

### 10.5 学习检验清单


✅ **知识掌握自检**：
- [ ] 能够快速判断是哪一层的安全策略阻止了连接
- [ ] 熟练使用iptables和firewalld进行规则管理
- [ ] 理解SELinux对网络服务的影响和配置方法
- [ ] 能够分析网络访问日志发现异常行为
- [ ] 掌握VPN连接问题的基本排查思路
- [ ] 了解云环境安全组的配置和故障排查

**🚀 进阶学习建议**：
- 深入学习网络协议栈的工作原理
- 掌握高级的日志分析工具（ELK、Splunk等）
- 学习网络安全渗透测试技术
- 了解容器网络安全（Docker、Kubernetes）

**核心记忆**：
- 网络安全故障排查要分层诊断，逐步缩小范围
- iptables是底层机制，firewalld是管理工具，两者不能并存
- SELinux工作在应用层，即使网络通了也可能被拒绝
- 日志是排查问题的重要线索，要善于利用日志信息
- 安全配置要平衡安全性和可用性，避免过度限制