---
title: 5、IP地址与路由故障
---
## 📚 目录

1. [IP地址故障诊断基础](#1-IP地址故障诊断基础)
2. [IP地址冲突检测与处理](#2-IP地址冲突检测与处理)
3. [子网掩码配置问题](#3-子网掩码配置问题)
4. [路由配置故障诊断](#4-路由配置故障诊断)
5. [DHCP地址分配问题](#5-DHCP地址分配问题)
6. [多网卡路由优先级管理](#6-多网卡路由优先级管理)
7. [故障排查综合实战](#7-故障排查综合实战)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🌐 IP地址故障诊断基础


### 1.1 IP地址故障的基本概念


**什么是IP地址故障？**
IP地址故障就像房屋地址出了问题 - 邮递员找不到你家，网络数据包也找不到目标主机。

```
网络通信的基本要素：
源IP地址    →    目标IP地址
   |              |
(发送方)         (接收方)

故障现象：
❌ 无法访问网络
❌ 连接超时
❌ 数据包丢失
❌ 网络服务异常
```

### 1.2 常见IP故障类型速览


**🔸 地址层面故障**
- **地址冲突**：两台设备使用相同IP地址
- **地址错误**：IP地址不在正确的网段范围内
- **掩码错误**：子网掩码配置不当

**🔸 路由层面故障**
- **网关错误**：默认网关配置错误
- **路由缺失**：缺少必要的路由条目
- **路由冲突**：存在矛盾的路由规则

### 1.3 故障诊断的基本思路


```
网络故障诊断金字塔：
                应用层
               /       \
            传输层     会话层
           /             \
        网络层(IP)      数据链路层
       /                   \
   物理层               本地连通性

诊断顺序：
1️⃣ 本地网络配置检查
2️⃣ 本地网络连通性测试  
3️⃣ 网关连通性测试
4️⃣ 外网连通性测试
5️⃣ DNS解析测试
```

> 💡 **诊断原则**：从下往上，由近到远，先简单后复杂

---

## 2. 🚨 IP地址冲突检测与处理


### 2.1 什么是IP地址冲突


**通俗理解**：
想象小区里两户人家都用了同一个门牌号，快递员就不知道该送到哪家了。IP地址冲突也是如此 - 网络中两台设备用了相同的IP地址。

```
正常情况：
设备A: 192.168.1.100  ←→  交换机  ←→  设备B: 192.168.1.101
        唯一标识              唯一标识

冲突情况：
设备A: 192.168.1.100  ←→  交换机  ←→  设备C: 192.168.1.100
        相同IP!                    相同IP!
                 ↑
            网络混乱
```

### 2.2 IP冲突的表现症状


**🔸 典型症状**
```
Windows系统提示：
"检测到IP地址冲突，已禁用网络连接"

Linux系统日志：
"duplicate address detected"

网络表现：
• 间歇性断网
• 网络访问时好时坏  
• ARP表条目频繁变化
• 连接异常重置
```

### 2.3 冲突检测命令实战


**手动检测IP冲突**

```bash
# 1. 使用ping检测（发送前先断网）
ping 192.168.1.100

# 如果断网状态下仍有回应，说明存在冲突

# 2. 使用arping精确检测
arping -c 4 192.168.1.100
# 正常：1个MAC地址回应
# 冲突：多个不同MAC地址回应

# 3. 检查ARP表
arp -a | grep 192.168.1.100
# 冲突时会看到相同IP对应不同MAC
```

**📊 ARP表异常示例**
```
正常ARP表：
192.168.1.100    aa:bb:cc:dd:ee:ff    动态

冲突ARP表：
192.168.1.100    aa:bb:cc:dd:ee:ff    动态
192.168.1.100    11:22:33:44:55:66    动态  ← 冲突！
```

### 2.4 IP冲突解决方案


**⚡ 快速解决步骤**

```
步骤1️⃣ 确认冲突设备
# 查看MAC地址对应的设备
nmap -sn 192.168.1.0/24
arp -a

步骤2️⃣ 临时缓解
# 清空ARP缓存
arp -d 192.168.1.100  # Linux
arp -d * # Windows

步骤3️⃣ 永久解决
• 修改其中一台设备的IP地址
• 检查DHCP服务器配置
• 审查静态IP分配记录
```

> ⚠️ **注意**：解决冲突后，所有相关设备都需要清空ARP缓存

---

## 3. 🔧 子网掩码配置问题


### 3.1 子网掩码的作用原理


**通俗解释**：
子网掩码就像邮政编码，它帮助网络设备判断目标IP是在"本地"还是"外地"。

```
IP地址构成：
192.168.1.100/24
│          │  │
│          │  └─ 掩码长度(24位)
│          └─ 主机部分  
└─ 网络部分

子网掩码：255.255.255.0 (24个1)
二进制：  11111111.11111111.11111111.00000000
作用：    网络位    网络位    网络位   主机位
```

### 3.2 掩码配置错误的常见情况


**🔸 掩码过大(主机位不足)**
```
错误配置：192.168.1.10/30
子网掩码：255.255.255.252
可用主机：仅2台 (192.168.1.9, 192.168.1.10)

问题：主机192.168.1.11无法通信
原因：不在同一子网范围内
```

**🔸 掩码过小(广播域过大)**
```
错误配置：192.168.1.10/16  
子网掩码：255.255.0.0
广播域：  整个192.168.x.x网段

问题：广播风暴、安全隐患
```

### 3.3 掩码故障诊断方法


**检查当前掩码配置**
```bash
# Linux查看掩码
ip addr show eth0
ifconfig eth0

# 输出示例
inet 192.168.1.100/24 brd 192.168.1.255

# Windows查看掩码  
ipconfig /all
```

**计算子网范围**
```bash
# 使用ipcalc工具
ipcalc 192.168.1.100/24

# 输出：
Network:   192.168.1.0/24
Broadcast: 192.168.1.255  
HostMin:   192.168.1.1
HostMax:   192.168.1.254
```

### 3.4 掩码问题解决实例


**💼 实战案例：局域网无法通信**

```
故障现象：
主机A (192.168.1.10/30) 无法ping通 主机B (192.168.1.20/24)

诊断过程：
1. 检查主机A的子网范围
   网络地址：192.168.1.8/30
   有效范围：192.168.1.9 - 192.168.1.10
   
2. 主机B地址：192.168.1.20
   判断：不在主机A的子网范围内

解决方案：
统一掩码配置为 /24
主机A：192.168.1.10/24  
主机B：192.168.1.20/24
```

> 🎯 **关键理解**：同一局域网内的设备必须使用相同的子网掩码

---

## 4. 🛣️ 路由配置故障诊断


### 4.1 路由基础概念


**什么是路由？**
路由就像交通指示牌，告诉数据包应该走哪条路到达目的地。

```
路由表结构：
目标网络        网关          接口      跃点数
0.0.0.0/0      192.168.1.1   eth0      100    ← 默认路由
192.168.1.0/24 0.0.0.0       eth0      0      ← 本地网段
10.0.0.0/8     192.168.1.254 eth0      200    ← 静态路由
```

### 4.2 默认网关故障诊断


**🔸 网关配置检查**
```bash
# 查看默认路由
route -n
ip route show

# 典型输出
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    100    0        0 eth0
```

**🔸 网关连通性测试**
```bash
# 测试网关是否可达
ping 192.168.1.1

# 测试外网连通性
ping 8.8.8.8

# 故障判断：
# 网关不通 → 网关设备故障或配置错误
# 网关通但外网不通 → 上级路由问题
```

### 4.3 静态路由配置问题


**添加静态路由**
```bash
# 临时添加路由
route add -net 10.0.0.0/8 gw 192.168.1.254

# 永久添加路由 (CentOS/RHEL)
echo "10.0.0.0/8 via 192.168.1.254" >> /etc/sysconfig/network-scripts/route-eth0

# Ubuntu永久路由
echo "up route add -net 10.0.0.0/8 gw 192.168.1.254" >> /etc/network/interfaces
```

**路由冲突处理**
```bash
# 查看路由表
netstat -rn

# 删除错误路由
route del -net 10.0.0.0/8

# 重新添加正确路由
route add -net 10.0.0.0/8 gw 192.168.1.254
```

### 4.4 路由优先级问题


**🔸 Metric值的作用**
```
路由优先级规则：
Metric值越小 = 优先级越高

示例路由表：
目标网络        网关          Metric
0.0.0.0/0      192.168.1.1   100     ← 优先使用
0.0.0.0/0      192.168.1.2   200     ← 备用路由
```

**调整路由优先级**
```bash
# 删除现有默认路由
route del default

# 添加高优先级路由
route add default gw 192.168.1.1 metric 50

# 添加备用路由  
route add default gw 192.168.1.2 metric 100
```

---

## 5. 🌐 DHCP地址分配问题


### 5.1 DHCP工作原理


**DHCP四步握手过程**
```
客户端                    DHCP服务器
   |                          |
   |─[1]DISCOVER广播────────→|
   |←────[2]OFFER应答────────|
   |─[3]REQUEST请求─────────→|  
   |←────[4]ACK确认─────────|
   |                          |
   获得IP地址和租约信息
```

**DHCP分配的信息**
- IP地址
- 子网掩码  
- 默认网关
- DNS服务器
- 租约时间

### 5.2 DHCP故障现象与诊断


**🔸 无法获取IP地址**
```bash
# 手动释放IP
dhclient -r eth0

# 重新获取IP
dhclient eth0

# 查看DHCP日志
tail -f /var/log/syslog | grep dhcp
```

**常见错误信息**
```
DHCPDISCOVER: no free leases
→ 地址池已满，无可分配地址

DHCPNAK received  
→ 服务器拒绝地址请求

No working leases in persistent database
→ 租约数据库问题
```

### 5.3 IP地址租约管理


**🔸 租约状态检查**
```bash
# 客户端租约信息
cat /var/lib/dhcp/dhclient.leases

# 服务器端租约数据库
cat /var/lib/dhcp/dhcpd.leases
```

**租约冲突处理**
```bash
# 清除客户端租约缓存
rm /var/lib/dhcp/dhclient.leases

# 重启网络服务
systemctl restart network

# 或重启NetworkManager
systemctl restart NetworkManager
```

### 5.4 DHCP服务器配置检查


**基本配置文件检查**
```bash
# 检查DHCP服务器配置
vi /etc/dhcp/dhcpd.conf

# 关键配置项
subnet 192.168.1.0 netmask 255.255.255.0 {
    range 192.168.1.100 192.168.1.200;
    option routers 192.168.1.1;
    option domain-name-servers 8.8.8.8, 8.8.4.4;
    default-lease-time 86400;
    max-lease-time 172800;
}
```

---

## 6. 🔀 多网卡路由优先级管理


### 6.1 多网卡环境的路由原理


**多网卡场景示例**
```
服务器多网卡配置：
eth0: 192.168.1.100/24  (内网)
eth1: 10.0.0.100/24     (管理网)  
eth2: 172.16.0.100/24   (存储网)

路由表：
192.168.1.0/24   eth0   内网流量
10.0.0.0/24      eth1   管理流量
172.16.0.0/24    eth2   存储流量
0.0.0.0/0        eth0   默认路由
```

### 6.2 路由优先级配置


**设置接口优先级**
```bash
# 查看当前路由表
ip route show table main

# 设置默认路由优先级
ip route add default via 192.168.1.1 dev eth0 metric 100
ip route add default via 10.0.0.1 dev eth1 metric 200

# 结果：eth0优先级更高
```

**🔸 基于源地址的路由策略**
```bash
# 创建路由表
echo "100 eth0_table" >> /etc/iproute2/rt_tables
echo "101 eth1_table" >> /etc/iproute2/rt_tables

# 添加策略路由
ip rule add from 192.168.1.100 table eth0_table
ip rule add from 10.0.0.100 table eth1_table

# 在路由表中添加默认路由
ip route add default via 192.168.1.1 table eth0_table
ip route add default via 10.0.0.1 table eth1_table
```

### 6.3 网卡绑定与故障切换


**主备模式配置**
```bash
# 安装bonding模块
modprobe bonding

# 创建绑定接口
echo "alias bond0 bonding" >> /etc/modprobe.conf
echo "options bond0 mode=1 miimon=100" >> /etc/modprobe.conf

# 配置绑定网卡
ifconfig eth0 down
ifconfig eth1 down
ifconfig bond0 192.168.1.100 netmask 255.255.255.0 up
echo "+eth0" > /sys/class/net/bond0/bonding/slaves  
echo "+eth1" > /sys/class/net/bond0/bonding/slaves
```

---

## 7. 🔧 故障排查综合实战


### 7.1 网络故障排查流程


**系统化排查步骤**
```
第1层：物理连通性
├─ 检查网线连接
├─ 查看网卡指示灯
└─ 确认交换机端口状态

第2层：数据链路层  
├─ 检查MAC地址
├─ 查看ARP表
└─ 测试同网段连通性

第3层：网络层
├─ 验证IP配置
├─ 检查路由表
└─ 测试网关连通性

第4层：传输层及以上
├─ 检查端口开放
├─ 测试服务可用性
└─ 验证DNS解析
```

### 7.2 综合诊断命令集合


**🛠️ 常用诊断工具箱**
```bash
# 网络接口状态
ip addr show
ethtool eth0

# 连通性测试
ping -c 4 目标IP
traceroute 目标IP
mtr 目标IP

# 路由信息  
ip route show
netstat -rn

# ARP表检查
arp -a
ip neigh show

# 端口扫描
nmap -p 端口 目标IP
ss -tuln

# DNS测试
nslookup 域名
dig 域名
```

### 7.3 典型故障案例分析


**💼 案例1：无法访问外网**
```
故障现象：可以ping通网关，无法访问互联网

诊断步骤：
1. ping 8.8.8.8 (测试外网IP)
   └─ 不通：路由问题
   
2. nslookup baidu.com
   └─ 无响应：DNS问题

3. 检查DNS配置
   cat /etc/resolv.conf
   
解决方案：
配置正确的DNS服务器
echo "nameserver 8.8.8.8" >> /etc/resolv.conf
```

**💼 案例2：网络时断时续**
```
故障现象：网络连接不稳定，时好时坏

诊断过程：
1. 检查网络统计
   cat /proc/net/dev
   
2. 查看错误包计数
   ethtool -S eth0 | grep error
   
3. 检查IP冲突
   arping -c 5 本机IP
   
解决方案：
发现IP冲突，修改其中一台设备IP地址
```

### 7.4 故障预防与监控


**🔍 网络状态监控脚本**
```bash
#!/bin/bash
# 网络健康检查脚本

# 检查网络接口状态
check_interface() {
    local interface=$1
    if ip link show $interface | grep -q "state UP"; then
        echo "✓ $interface 接口正常"
    else
        echo "✗ $interface 接口异常"
    fi
}

# 检查网关连通性
check_gateway() {
    local gateway=$(ip route | grep default | awk '{print $3}')
    if ping -c 1 $gateway &>/dev/null; then
        echo "✓ 网关 $gateway 连通正常"
    else
        echo "✗ 网关 $gateway 连通异常"
    fi
}

# 检查DNS解析
check_dns() {
    if nslookup baidu.com &>/dev/null; then
        echo "✓ DNS解析正常"
    else
        echo "✗ DNS解析异常"
    fi
}

# 执行检查
echo "=== 网络健康状态检查 ==="
check_interface eth0
check_gateway  
check_dns
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 IP地址故障：冲突检测、掩码配置、地址分配
🔸 路由故障：默认网关、静态路由、优先级管理
🔸 DHCP故障：租约管理、地址池、服务器配置  
🔸 多网卡：路由策略、优先级、故障切换
🔸 诊断工具：ping、traceroute、ip命令、netstat
```

### 8.2 关键排查思路


**🔹 分层诊断法**
```
物理层 → 数据链路层 → 网络层 → 应用层
由下到上，逐层排查，确定故障层次
```

**🔹 由近到远法**  
```
本机配置 → 本地网关 → 外网连通 → 服务可用
先解决本地问题，再排查远程故障
```

**🔹 对比分析法**
```
正常设备 vs 故障设备
工作配置 vs 当前配置
找出差异点，定位问题根源
```

### 8.3 实用诊断清单


**🎯 IP地址问题检查清单**
- [ ] IP地址是否在正确网段
- [ ] 子网掩码是否匹配
- [ ] 是否存在地址冲突  
- [ ] DHCP服务是否正常
- [ ] 静态IP配置是否正确

**🎯 路由问题检查清单**  
- [ ] 默认网关配置是否正确
- [ ] 网关设备是否可达
- [ ] 静态路由是否完整
- [ ] 路由优先级是否合理
- [ ] 是否存在路由环路

**🎯 网络服务检查清单**
- [ ] 网络接口状态是否UP
- [ ] DNS服务器配置是否正确
- [ ] 防火墙规则是否阻断
- [ ] 服务端口是否开放
- [ ] 网络性能是否正常

### 8.4 常用命令速查


| 功能类别 | 命令示例 | 作用说明 |
|---------|----------|----------|
| **IP配置** | `ip addr show` | 查看IP地址配置 |
| **路由查看** | `ip route show` | 显示路由表信息 |
| **连通测试** | `ping -c 4 IP` | 测试网络连通性 |
| **路径跟踪** | `traceroute IP` | 跟踪数据包路径 |
| **ARP查看** | `arp -a` | 显示ARP表信息 |
| **端口检查** | `ss -tuln` | 查看开放端口 |
| **DNS测试** | `nslookup 域名` | 测试域名解析 |
| **网络统计** | `netstat -i` | 显示网络接口统计 |

### 8.5 故障预防建议


**📝 配置管理**
- 建立网络配置文档
- 记录IP地址分配表
- 定期备份配置文件
- 制定变更管理流程

**🔍 监控预警**
- 部署网络监控系统
- 设置连通性检查
- 监控关键指标变化  
- 建立故障报警机制

**🎓 技能提升**
- 熟练掌握诊断命令
- 理解网络协议原理
- 积累故障处理经验
- 建立知识库体系

**核心记忆要点**：
- 网络故障分层查，由近到远不慌乱
- IP地址掩码网关查，路由表里找答案  
- DHCP租约冲突解，多网卡要分优先
- 工具命令要熟练，预防监控是关键