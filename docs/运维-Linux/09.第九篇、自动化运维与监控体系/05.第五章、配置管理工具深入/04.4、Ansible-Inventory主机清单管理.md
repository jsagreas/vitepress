---
title: 4ã€Ansible-Inventoryä¸»æœºæ¸…å•ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [Inventoryä¸»æœºæ¸…å•åŸºæœ¬æ¦‚å¿µ](#1-inventoryä¸»æœºæ¸…å•åŸºæœ¬æ¦‚å¿µ)
2. [é™æ€Inventoryæ–‡ä»¶æ ¼å¼è¯¦è§£](#2-é™æ€inventoryæ–‡ä»¶æ ¼å¼è¯¦è§£)
3. [ä¸»æœºç»„ç»‡ä¸åˆ†ç»„ç­–ç•¥](#3-ä¸»æœºç»„ç»‡ä¸åˆ†ç»„ç­–ç•¥)
4. [ä¸»æœºå˜é‡ä¸ç»„å˜é‡ç®¡ç†](#4-ä¸»æœºå˜é‡ä¸ç»„å˜é‡ç®¡ç†)
5. [åŠ¨æ€Inventoryè„šæœ¬ç¼–å†™](#5-åŠ¨æ€inventoryè„šæœ¬ç¼–å†™)
6. [ä¸»æœºæ¨¡å¼åŒ¹é…è§„åˆ™](#6-ä¸»æœºæ¨¡å¼åŒ¹é…è§„åˆ™)
7. [è¿æ¥å‚æ•°é…ç½®](#7-è¿æ¥å‚æ•°é…ç½®)
8. [å¤§è§„æ¨¡ä¸»æœºç®¡ç†ç­–ç•¥](#8-å¤§è§„æ¨¡ä¸»æœºç®¡ç†ç­–ç•¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“‹ Inventoryä¸»æœºæ¸…å•åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Inventoryï¼Ÿ


**ç®€å•ç†è§£**ï¼šInventoryå°±åƒæ˜¯ä¸€ä¸ªç”µè¯ç°¿ï¼Œè®°å½•ç€ä½ è¦ç®¡ç†çš„æ‰€æœ‰æœåŠ¡å™¨ä¿¡æ¯ã€‚

```
ç±»æ¯”ç†è§£ï¼š
å…¬å¸é€šè®¯å½•               Ansible Inventory
â”œâ”€â”€ ç ”å‘éƒ¨é—¨             â”œâ”€â”€ webæœåŠ¡å™¨ç»„
â”‚   â”œâ”€â”€ å¼ ä¸‰(æ‰‹æœºå·)      â”‚   â”œâ”€â”€ web1.example.com
â”‚   â””â”€â”€ æå››(æ‰‹æœºå·)      â”‚   â””â”€â”€ web2.example.com  
â””â”€â”€ è¿ç»´éƒ¨é—¨             â””â”€â”€ æ•°æ®åº“æœåŠ¡å™¨ç»„
    â”œâ”€â”€ ç‹äº”(æ‰‹æœºå·)          â”œâ”€â”€ db1.example.com
    â””â”€â”€ èµµå…­(æ‰‹æœºå·)          â””â”€â”€ db2.example.com
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ¯ **ä¸»æœºå®šä¹‰**ï¼šå‘Šè¯‰Ansibleè¦ç®¡ç†å“ªäº›æœåŠ¡å™¨
- ğŸ—ï¸ **åˆ†ç»„ç®¡ç†**ï¼šå°†æœåŠ¡å™¨æŒ‰åŠŸèƒ½ã€ç¯å¢ƒç­‰åˆ†ç±»
- âš™ï¸ **å˜é‡å­˜å‚¨**ï¼šå­˜å‚¨ä¸»æœºå’Œç»„çš„é…ç½®å‚æ•°
- ğŸ”— **è¿æ¥ä¿¡æ¯**ï¼šå®šä¹‰å¦‚ä½•è¿æ¥åˆ°ç›®æ ‡ä¸»æœº

### 1.2 Inventoryçš„ç±»å‹


```
é™æ€Inventoryï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [webservers]            â”‚  â† æ‰‹å·¥ç»´æŠ¤çš„é…ç½®æ–‡ä»¶
â”‚ web1.example.com        â”‚
â”‚ web2.example.com        â”‚
â”‚                         â”‚
â”‚ [databases]             â”‚
â”‚ db1.example.com         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŠ¨æ€Inventoryï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ #!/usr/bin/env python   â”‚  â† ç¨‹åºè‡ªåŠ¨ç”Ÿæˆ
â”‚ import json             â”‚
â”‚ # ä»äº‘å¹³å°APIè·å–       â”‚
â”‚ # ä¸»æœºåˆ—è¡¨...           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ“ é™æ€Inventoryæ–‡ä»¶æ ¼å¼è¯¦è§£


### 2.1 åŸºæœ¬INIæ ¼å¼


> ğŸ’¡ **å­¦ä¹ æç¤º**
> INIæ ¼å¼å°±åƒWindowsçš„é…ç½®æ–‡ä»¶ï¼Œç”¨`[ç»„å]`å®šä¹‰åˆ†ç»„ï¼Œä¸‹é¢åˆ—å‡ºç»„å†…æˆå‘˜

**åŸºç¡€æ ¼å¼ç¤ºä¾‹**ï¼š

```ini
# è¿™æ˜¯æ³¨é‡Šï¼Œä»¥#å¼€å¤´

# æœªåˆ†ç»„çš„ä¸»æœºï¼ˆå±äºé»˜è®¤çš„ungroupedç»„ï¼‰
mail.example.com

# WebæœåŠ¡å™¨ç»„
[webservers]
web1.example.com
web2.example.com
web3.example.com

# æ•°æ®åº“æœåŠ¡å™¨ç»„  
[databases]
db1.example.com
db2.example.com

# è´Ÿè½½å‡è¡¡å™¨ç»„
[loadbalancers]
lb1.example.com
lb2.example.com
```

### 2.2 ä¸»æœºåˆ«åå®šä¹‰


**ä¸ºä»€ä¹ˆéœ€è¦åˆ«åï¼Ÿ**
- æ–¹ä¾¿è®°å¿†ï¼šç”¨`web01`ä»£æ›¿`192.168.1.100`
- ç»Ÿä¸€å‘½åï¼šé¿å…IPå˜åŒ–åéœ€è¦ä¿®æ”¹å‰§æœ¬

```ini
[webservers]
# åˆ«å ansible_host=çœŸå®IPåœ°å€
web01 ansible_host=192.168.1.100
web02 ansible_host=192.168.1.101
web03 ansible_host=192.168.1.102

[databases]  
db-master ansible_host=10.0.0.10
db-slave ansible_host=10.0.0.11
```

### 2.3 ç«¯å£èŒƒå›´å’Œä¸»æœºæ¨¡å¼


**è¿ç»­ä¸»æœºå®šä¹‰**ï¼š
```ini
[webservers]
# å®šä¹‰web01åˆ°web05ï¼Œå…±5å°æœåŠ¡å™¨
web[01:05].example.com

# ç­‰åŒäºï¼š
# web01.example.com
# web02.example.com  
# web03.example.com
# web04.example.com
# web05.example.com

[databases]
# å®šä¹‰db-aåˆ°db-fï¼Œå…±6å°æœåŠ¡å™¨
db-[a:f].example.com

# IPèŒƒå›´å®šä¹‰
192.168.1.[100:105]
```

### 2.4 YAMLæ ¼å¼Inventory


> âš¡ **æ€§èƒ½è¦ç‚¹**  
> YAMLæ ¼å¼æ›´é€‚åˆå¤æ‚ç»“æ„ï¼Œä½†è§£æé€Ÿåº¦æ¯”INIç¨æ…¢

```yaml
all:
  children:
    webservers:
      hosts:
        web01:
          ansible_host: 192.168.1.100
        web02:
          ansible_host: 192.168.1.101
    databases:
      hosts:
        db-master:
          ansible_host: 10.0.0.10
          mysql_role: master
        db-slave:
          ansible_host: 10.0.0.11  
          mysql_role: slave
```

---

## 3. ğŸ—ï¸ ä¸»æœºç»„ç»‡ä¸åˆ†ç»„ç­–ç•¥


### 3.1 æŒ‰åŠŸèƒ½åˆ†ç»„


**å¸¸è§åˆ†ç»„ç­–ç•¥**ï¼š

```ini
# æŒ‰æœåŠ¡ç±»å‹åˆ†ç»„
[webservers]
web01.example.com
web02.example.com

[databases]  
db01.example.com
db02.example.com

[cacheservers]
redis01.example.com
redis02.example.com

[messagequeues]
mq01.example.com
mq02.example.com
```

### 3.2 æŒ‰ç¯å¢ƒåˆ†ç»„


```ini
# å¼€å‘ç¯å¢ƒ
[dev]
dev-web01.example.com
dev-db01.example.com

# æµ‹è¯•ç¯å¢ƒ  
[test]
test-web01.example.com
test-db01.example.com

# ç”Ÿäº§ç¯å¢ƒ
[prod]
prod-web01.example.com
prod-web02.example.com
prod-db01.example.com
prod-db02.example.com
```

### 3.3 åµŒå¥—åˆ†ç»„ï¼ˆç»„çš„ç»„ï¼‰


> ğŸ” **æ·±å…¥ç†è§£**
> çˆ¶ç»„ä¼šè‡ªåŠ¨ç»§æ‰¿å­ç»„çš„æ‰€æœ‰ä¸»æœºï¼Œè¿™æ ·å¯ä»¥å¯¹æ•´ä¸ªç¯å¢ƒæˆ–æ•´ä¸ªåŠŸèƒ½æ¨¡å—ç»Ÿä¸€æ“ä½œ

```ini
# å­ç»„å®šä¹‰
[web-dev]
dev-web01.example.com
dev-web02.example.com

[web-prod]
prod-web01.example.com  
prod-web02.example.com
prod-web03.example.com

[db-dev]
dev-db01.example.com

[db-prod]
prod-db01.example.com
prod-db02.example.com

# çˆ¶ç»„å®šä¹‰
[webservers:children]  # childrenå…³é”®å­—è¡¨ç¤ºè¿™æ˜¯ç»„çš„ç»„
web-dev
web-prod

[databases:children]
db-dev  
db-prod

[dev:children]
web-dev
db-dev

[prod:children]
web-prod
db-prod
```

**åˆ†ç»„å±‚æ¬¡å›¾ç¤º**ï¼š
```
all
â”œâ”€â”€ webservers
â”‚   â”œâ”€â”€ web-dev
â”‚   â”‚   â”œâ”€â”€ dev-web01
â”‚   â”‚   â””â”€â”€ dev-web02  
â”‚   â””â”€â”€ web-prod
â”‚       â”œâ”€â”€ prod-web01
â”‚       â”œâ”€â”€ prod-web02
â”‚       â””â”€â”€ prod-web03
â””â”€â”€ databases
    â”œâ”€â”€ db-dev
    â”‚   â””â”€â”€ dev-db01
    â””â”€â”€ db-prod
        â”œâ”€â”€ prod-db01
        â””â”€â”€ prod-db02
```

---

## 4. âš™ï¸ ä¸»æœºå˜é‡ä¸ç»„å˜é‡ç®¡ç†


### 4.1 ä¸»æœºå˜é‡å®šä¹‰


**åœ¨Inventoryæ–‡ä»¶ä¸­ç›´æ¥å®šä¹‰**ï¼š
```ini
[webservers]
web01 ansible_host=192.168.1.100 http_port=8080 server_role=primary
web02 ansible_host=192.168.1.101 http_port=8080 server_role=secondary
web03 ansible_host=192.168.1.102 http_port=8081 server_role=backup
```

**å˜é‡çš„å®é™…ç”¨é€”**ï¼š
- `http_port`ï¼šé…ç½®WebæœåŠ¡å™¨ç›‘å¬ç«¯å£
- `server_role`ï¼šå®šä¹‰æœåŠ¡å™¨è§’è‰²ï¼Œç”¨äºæ¡ä»¶åˆ¤æ–­
- `ansible_host`ï¼šAnsibleè¿æ¥æ—¶ä½¿ç”¨çš„å®é™…IPåœ°å€

### 4.2 ç»„å˜é‡å®šä¹‰


```ini
[databases]
db01 ansible_host=10.0.0.10
db02 ansible_host=10.0.0.11

# ä¸ºæ•´ä¸ªdatabasesç»„å®šä¹‰å˜é‡
[databases:vars]
mysql_version=8.0
backup_schedule="0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
data_dir=/var/lib/mysql
```

### 4.3 å˜é‡æ–‡ä»¶åˆ†ç¦»ç®¡ç†


> ğŸ“– **å»¶ä¼¸é˜…è¯»**
> å¤§å‹é¡¹ç›®å»ºè®®å°†å˜é‡å•ç‹¬å­˜æ”¾åœ¨æ–‡ä»¶ä¸­ï¼Œä¾¿äºç»´æŠ¤å’Œç‰ˆæœ¬æ§åˆ¶

**ç›®å½•ç»“æ„**ï¼š
```
inventory/
â”œâ”€â”€ hosts                    # ä¸»æœºæ¸…å•æ–‡ä»¶
â”œâ”€â”€ group_vars/             # ç»„å˜é‡ç›®å½•
â”‚   â”œâ”€â”€ all.yml             # æ‰€æœ‰ä¸»æœºå…±åŒå˜é‡
â”‚   â”œâ”€â”€ webservers.yml      # webserversç»„å˜é‡
â”‚   â””â”€â”€ databases.yml       # databasesç»„å˜é‡
â””â”€â”€ host_vars/              # ä¸»æœºå˜é‡ç›®å½•  
    â”œâ”€â”€ web01.yml           # web01ä¸»æœºä¸“ç”¨å˜é‡
    â””â”€â”€ db01.yml            # db01ä¸»æœºä¸“ç”¨å˜é‡
```

**group_vars/webservers.ymlç¤ºä¾‹**ï¼š
```yaml
# WebæœåŠ¡å™¨ç»„é€šç”¨é…ç½®
nginx_version: 1.20
document_root: /var/www/html
ssl_enabled: true
max_connections: 1000

# éƒ¨ç½²ç›¸å…³é…ç½®  
deploy_user: webapp
deploy_path: /opt/webapp
```

**host_vars/web01.ymlç¤ºä¾‹**ï¼š
```yaml
# web01ä¸“ç”¨é…ç½®
server_role: primary
backup_enabled: true
monitoring_enabled: true

# ç‰¹æ®Šé…ç½®
custom_modules:
  - mod_rewrite
  - mod_ssl
```

### 4.4 å˜é‡ä¼˜å…ˆçº§


> âš ï¸ **æ³¨æ„äº‹é¡¹**
> å˜é‡ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼šä¸»æœºå˜é‡ > ç»„å˜é‡ > å…¨å±€å˜é‡

```
å˜é‡ä¼˜å…ˆçº§é¡ºåºï¼ˆé«˜â†’ä½ï¼‰ï¼š
1. å‘½ä»¤è¡Œå‚æ•° (-e var=value)
2. host_vars/ä¸»æœºå.yml
3. inventoryæ–‡ä»¶ä¸­çš„ä¸»æœºå˜é‡  
4. group_vars/ç»„å.yml
5. inventoryæ–‡ä»¶ä¸­çš„ç»„å˜é‡
6. group_vars/all.yml
7. è§’è‰²é»˜è®¤å˜é‡
```

---

## 5. ğŸ åŠ¨æ€Inventoryè„šæœ¬ç¼–å†™


### 5.1 åŠ¨æ€InventoryåŸºæœ¬æ¦‚å¿µ


**ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€Inventoryï¼Ÿ**
- **äº‘ç¯å¢ƒ**ï¼šæœåŠ¡å™¨IPç»å¸¸å˜åŒ–ï¼Œæ‰‹åŠ¨ç»´æŠ¤å›°éš¾
- **å¼¹æ€§æ‰©å®¹**ï¼šè‡ªåŠ¨æ‰©ç¼©å®¹çš„æœåŠ¡å™¨æ— æ³•æå‰å®šä¹‰
- **å¤šæ•°æ®æº**ï¼šä»CMDBã€äº‘å¹³å°APIç­‰è·å–æœ€æ–°ä¸»æœºä¿¡æ¯

**å·¥ä½œåŸç†**ï¼š
```
Ansibleå‘½ä»¤æ‰§è¡Œ
       â†“
è°ƒç”¨åŠ¨æ€Inventoryè„šæœ¬
       â†“  
è„šæœ¬ä»å¤–éƒ¨æ•°æ®æºè·å–ä¸»æœºä¿¡æ¯
(äº‘å¹³å°APIã€æ•°æ®åº“ã€æ–‡ä»¶ç­‰)
       â†“
è¿”å›JSONæ ¼å¼çš„ä¸»æœºæ¸…å•
       â†“
Ansibleè§£æå¹¶æ‰§è¡Œä»»åŠ¡
```

### 5.2 åŠ¨æ€Inventoryè„šæœ¬æ ¼å¼è¦æ±‚


**å¿…é¡»æ”¯æŒçš„å‚æ•°**ï¼š
- `--list`ï¼šè¿”å›æ‰€æœ‰ä¸»æœºå’Œç»„ä¿¡æ¯
- `--host <hostname>`ï¼šè¿”å›æŒ‡å®šä¸»æœºçš„å˜é‡ä¿¡æ¯

**è¿”å›JSONæ ¼å¼è§„èŒƒ**ï¼š
```json
{
  "_meta": {
    "hostvars": {
      "web01": {
        "ansible_host": "192.168.1.100",
        "server_role": "primary"
      }
    }
  },
  "webservers": {
    "hosts": ["web01", "web02"],
    "vars": {
      "nginx_version": "1.20"
    }
  },
  "databases": {
    "hosts": ["db01", "db02"]
  }
}
```

### 5.3 ç®€å•çš„åŠ¨æ€Inventoryè„šæœ¬ç¤ºä¾‹


```python
#!/usr/bin/env python3
import json
import sys

def get_inventory():
    """ä»å¤–éƒ¨æ•°æ®æºè·å–ä¸»æœºä¿¡æ¯"""
    # å®é™…åœºæ™¯ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨äº‘å¹³å°APIæˆ–æŸ¥è¯¢æ•°æ®åº“
    inventory = {
        "_meta": {
            "hostvars": {
                "web01": {
                    "ansible_host": "192.168.1.100",
                    "server_role": "primary",
                    "http_port": 80
                },
                "web02": {
                    "ansible_host": "192.168.1.101", 
                    "server_role": "secondary",
                    "http_port": 80
                },
                "db01": {
                    "ansible_host": "10.0.0.10",
                    "mysql_role": "master"
                }
            }
        },
        "webservers": {
            "hosts": ["web01", "web02"],
            "vars": {
                "nginx_version": "1.20",
                "document_root": "/var/www/html"
            }
        },
        "databases": {
            "hosts": ["db01"],
            "vars": {
                "mysql_version": "8.0"
            }
        }
    }
    return inventory

def get_host_vars(hostname):
    """è·å–æŒ‡å®šä¸»æœºçš„å˜é‡"""
    inventory = get_inventory()
    return inventory["_meta"]["hostvars"].get(hostname, {})

if __name__ == "__main__":
    if len(sys.argv) == 2 and sys.argv[1] == "--list":
        print(json.dumps(get_inventory(), indent=2))
    elif len(sys.argv) == 3 and sys.argv[1] == "--host":
        print(json.dumps(get_host_vars(sys.argv[2]), indent=2))
    else:
        print("Usage: %s --list | --host <hostname>" % sys.argv[0])
        sys.exit(1)
```

### 5.4 AWS EC2åŠ¨æ€Inventoryç¤ºä¾‹


```python
#!/usr/bin/env python3
import boto3
import json
import sys

def get_ec2_inventory():
    """ä»AWS EC2è·å–å®ä¾‹ä¿¡æ¯"""
    ec2 = boto3.client('ec2', region_name='us-west-2')
    
    # è·å–æ‰€æœ‰è¿è¡Œä¸­çš„å®ä¾‹
    response = ec2.describe_instances(
        Filters=[{'Name': 'instance-state-name', 'Values': ['running']}]
    )
    
    inventory = {
        "_meta": {"hostvars": {}},
        "all": {"hosts": []},
    }
    
    for reservation in response['Reservations']:
        for instance in reservation['Instances']:
            # è·å–å®ä¾‹åç§°æ ‡ç­¾
            instance_name = None
            for tag in instance.get('Tags', []):
                if tag['Key'] == 'Name':
                    instance_name = tag['Value']
                    break
            
            if not instance_name:
                instance_name = instance['InstanceId']
            
            # æ·»åŠ ä¸»æœºåˆ°æ¸…å•
            inventory["all"]["hosts"].append(instance_name)
            
            # è®¾ç½®ä¸»æœºå˜é‡
            inventory["_meta"]["hostvars"][instance_name] = {
                "ansible_host": instance.get('PublicIpAddress', instance['PrivateIpAddress']),
                "ec2_instance_id": instance['InstanceId'],
                "ec2_instance_type": instance['InstanceType'],
                "ec2_region": instance['Placement']['AvailabilityZone'][:-1]
            }
            
            # æ ¹æ®æ ‡ç­¾åˆ›å»ºç»„
            for tag in instance.get('Tags', []):
                if tag['Key'] == 'Environment':
                    group_name = f"env_{tag['Value']}"
                    if group_name not in inventory:
                        inventory[group_name] = {"hosts": []}
                    inventory[group_name]["hosts"].append(instance_name)
    
    return inventory

if __name__ == "__main__":
    if len(sys.argv) == 2 and sys.argv[1] == "--list":
        print(json.dumps(get_ec2_inventory(), indent=2))
    elif len(sys.argv) == 3 and sys.argv[1] == "--host":
        # å¯¹äºAWSåŠ¨æ€inventoryï¼Œé€šå¸¸åœ¨_metaä¸­å·²åŒ…å«æ‰€æœ‰ä¸»æœºå˜é‡
        print(json.dumps({}))
    else:
        print("Usage: %s --list | --host <hostname>" % sys.argv[0])
```

---

## 6. ğŸ¯ ä¸»æœºæ¨¡å¼åŒ¹é…è§„åˆ™


### 6.1 å•ä¸ªä¸»æœºåŒ¹é…


```bash
# æŒ‡å®šå•ä¸ªä¸»æœº
ansible web01 -m ping

# æŒ‡å®šå¤šä¸ªä¸»æœºï¼Œç”¨é€—å·åˆ†éš”
ansible web01,web02,db01 -m ping  

# ä½¿ç”¨ä¸»æœºçš„å®Œæ•´åŸŸå
ansible web01.example.com -m ping
```

### 6.2 ç»„åŒ¹é…


```bash
# åŒ¹é…æ•´ä¸ªç»„
ansible webservers -m ping

# åŒ¹é…å¤šä¸ªç»„ï¼Œç”¨å†’å·åˆ†éš”
ansible webservers:databases -m ping

# åŒ¹é…æ‰€æœ‰ä¸»æœº
ansible all -m ping
```

### 6.3 é«˜çº§æ¨¡å¼åŒ¹é…


| åŒ¹é…æ¨¡å¼ | å«ä¹‰ | ç¤ºä¾‹ |
|---------|------|------|
| `*` | **é€šé…ç¬¦åŒ¹é…** | `web*`åŒ¹é…æ‰€æœ‰ä»¥webå¼€å¤´çš„ä¸»æœº |
| `!` | **æ’é™¤æ¨¡å¼** | `webservers:!web03`åŒ¹é…webserversç»„ä½†æ’é™¤web03 |
| `&` | **äº¤é›†æ¨¡å¼** | `webservers:&prod`åŒ¹é…æ—¢åœ¨webserversåˆåœ¨prodç»„çš„ä¸»æœº |
| `~` | **æ­£åˆ™è¡¨è¾¾å¼** | `~web[01-03]`ç”¨æ­£åˆ™åŒ¹é…web01åˆ°web03 |

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š
```bash
# åŒ¹é…æ‰€æœ‰webå¼€å¤´çš„ä¸»æœº
ansible 'web*' -m ping

# åŒ¹é…webserversç»„ï¼Œä½†æ’é™¤web03
ansible 'webservers:!web03' -m ping

# åŒ¹é…æ—¢åœ¨webserversç»„åˆåœ¨prodç»„çš„ä¸»æœº  
ansible 'webservers:&prod' -m ping

# æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
ansible '~web[0-9]+' -m ping

# å¤æ‚ç»„åˆï¼šåŒ¹é…ç”Ÿäº§ç¯å¢ƒçš„webæœåŠ¡å™¨ï¼Œä½†æ’é™¤web01
ansible 'webservers:&prod:!web01' -m ping
```

### 6.4 åŸºäºä¸»æœºå˜é‡çš„åŒ¹é…


> ğŸš€ **è¿›é˜¶æŠ€å·§**
> å¯ä»¥æ ¹æ®ä¸»æœºå˜é‡çš„å€¼æ¥åŠ¨æ€é€‰æ‹©ç›®æ ‡ä¸»æœº

```yaml
# åœ¨playbookä¸­ä½¿ç”¨whenæ¡ä»¶
- name: åªåœ¨ä¸»æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
  command: /opt/backup.sh
  when: server_role == "primary"

- name: åªåœ¨ç‰¹å®šç«¯å£çš„æœåŠ¡å™¨ä¸Šæ‰§è¡Œ  
  service:
    name: nginx
    state: restarted
  when: http_port == 8080
```

---

## 7. ğŸ”— è¿æ¥å‚æ•°é…ç½®


### 7.1 å¸¸ç”¨è¿æ¥å‚æ•°


**SSHè¿æ¥å‚æ•°**ï¼š
```ini
[webservers]
web01 ansible_host=192.168.1.100 ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/web01.pem
web02 ansible_host=192.168.1.101 ansible_user=centos ansible_port=2222
web03 ansible_host=192.168.1.102 ansible_user=admin ansible_ssh_pass=password123
```

**å‚æ•°è¯´æ˜**ï¼š
- `ansible_host`ï¼šç›®æ ‡ä¸»æœºçš„çœŸå®IPåœ°å€æˆ–åŸŸå
- `ansible_user`ï¼šSSHç™»å½•ç”¨æˆ·å
- `ansible_port`ï¼šSSHç«¯å£ï¼Œé»˜è®¤22
- `ansible_ssh_private_key_file`ï¼šSSHç§é’¥æ–‡ä»¶è·¯å¾„
- `ansible_ssh_pass`ï¼šSSHå¯†ç ï¼ˆä¸å»ºè®®æ˜æ–‡å­˜å‚¨ï¼‰

### 7.2 SSHå¯†é’¥ç®¡ç†æœ€ä½³å®è·µ


> ğŸ”’ **å®‰å…¨è­¦å‘Š**
> ç”Ÿäº§ç¯å¢ƒä¸­é¿å…ä½¿ç”¨å¯†ç è®¤è¯ï¼Œæ¨èä½¿ç”¨SSHå¯†é’¥

**å¯†é’¥ç”Ÿæˆå’Œåˆ†å‘**ï¼š
```bash
# ç”ŸæˆSSHå¯†é’¥å¯¹
ssh-keygen -t rsa -b 4096 -f ~/.ssh/ansible_key

# å°†å…¬é’¥å¤åˆ¶åˆ°ç›®æ ‡ä¸»æœº
ssh-copy-id -i ~/.ssh/ansible_key.pub user@target_host

# åœ¨inventoryä¸­æŒ‡å®šç§é’¥
[webservers]
web01 ansible_ssh_private_key_file=~/.ssh/ansible_key
```

### 7.3 è¿æ¥è¡Œä¸ºæ§åˆ¶


```ini
[webservers:vars]
# SSHè¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
ansible_ssh_connect_timeout=30

# å¯ç”¨SSHæŒä¹…è¿æ¥  
ansible_ssh_pipelining=true

# SSHå…¬å…±å‚æ•°
ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'

# å¹¶å‘è¿æ¥æ•°é™åˆ¶
ansible_ssh_control_persist=300
```

### 7.4 ç‰¹æ®Šè¿æ¥ç±»å‹


**æœ¬åœ°è¿æ¥**ï¼š
```ini
[local]
localhost ansible_connection=local
```

**Dockerå®¹å™¨è¿æ¥**ï¼š
```ini
[containers]
web-container ansible_connection=docker ansible_host=web_container_name
```

**Windowsä¸»æœºè¿æ¥**ï¼š
```ini
[windows]
win01 ansible_host=192.168.1.200 ansible_user=Administrator ansible_password=password123
win02 ansible_host=192.168.1.201 ansible_connection=winrm ansible_port=5986

[windows:vars]
ansible_connection=winrm
ansible_winrm_transport=ssl
ansible_winrm_server_cert_validation=ignore
```

---

## 8. ğŸ“ˆ å¤§è§„æ¨¡ä¸»æœºç®¡ç†ç­–ç•¥


### 8.1 åˆ†å±‚Inventoryç»“æ„


**æ¨èçš„ç›®å½•ç»“æ„**ï¼š
```
inventories/
â”œâ”€â”€ production/                 # ç”Ÿäº§ç¯å¢ƒ
â”‚   â”œâ”€â”€ hosts                  # ä¸»æœºæ¸…å•æ–‡ä»¶
â”‚   â”œâ”€â”€ group_vars/
â”‚   â”‚   â”œâ”€â”€ all.yml           # å…¨å±€å˜é‡
â”‚   â”‚   â”œâ”€â”€ webservers.yml    # WebæœåŠ¡å™¨ç»„å˜é‡
â”‚   â”‚   â””â”€â”€ databases.yml     # æ•°æ®åº“ç»„å˜é‡
â”‚   â””â”€â”€ host_vars/
â”‚       â”œâ”€â”€ web01.yml         # ä¸»æœºä¸“ç”¨å˜é‡
â”‚       â””â”€â”€ db01.yml
â”œâ”€â”€ staging/                   # æµ‹è¯•ç¯å¢ƒ
â”‚   â”œâ”€â”€ hosts
â”‚   â”œâ”€â”€ group_vars/
â”‚   â””â”€â”€ host_vars/
â””â”€â”€ development/               # å¼€å‘ç¯å¢ƒ
    â”œâ”€â”€ hosts
    â”œâ”€â”€ group_vars/
    â””â”€â”€ host_vars/
```

### 8.2 ä¸»æœºæ¸…å•åˆ†å‰²ç­–ç•¥


**æŒ‰åŠŸèƒ½æ¨¡å—åˆ†å‰²**ï¼š
```
inventories/
â”œâ”€â”€ web-tier/
â”‚   â”œâ”€â”€ hosts                 # Webå±‚ä¸»æœº
â”‚   â””â”€â”€ group_vars/
â”œâ”€â”€ app-tier/  
â”‚   â”œâ”€â”€ hosts                 # åº”ç”¨å±‚ä¸»æœº
â”‚   â””â”€â”€ group_vars/
â”œâ”€â”€ data-tier/
â”‚   â”œâ”€â”€ hosts                 # æ•°æ®å±‚ä¸»æœº
â”‚   â””â”€â”€ group_vars/
â””â”€â”€ infrastructure/
    â”œâ”€â”€ hosts                 # åŸºç¡€è®¾æ–½ä¸»æœº
    â””â”€â”€ group_vars/
```

### 8.3 å¤§è§„æ¨¡éƒ¨ç½²ä¼˜åŒ–


**å¹¶å‘æ§åˆ¶ç­–ç•¥**ï¼š
```ini
[webservers:vars]
# é™åˆ¶å¹¶è¡Œæ‰§è¡Œçš„ä¸»æœºæ•°é‡ï¼Œé¿å…ç½‘ç»œæ‹¥å µ
ansible_ssh_pipelining=true

# æ§åˆ¶æ‰¹æ¬¡å¤§å°
serial=5  # æ¯æ¬¡åªå¯¹5å°ä¸»æœºæ‰§è¡Œï¼Œé€‚ç”¨äºæ»šåŠ¨éƒ¨ç½²
```

**ä½¿ç”¨ansible.cfgä¼˜åŒ–**ï¼š
```ini
[defaults]
# è®¾ç½®åˆé€‚çš„å¹¶å‘æ•°
forks = 20

# å¯ç”¨SSHæŒä¹…è¿æ¥æ± 
control_path = ~/.ansible/cp/%%h-%%p-%%r

# SSHè¿æ¥å¤ç”¨
ssh_args = -o ControlMaster=auto -o ControlPersist=60s

# ç¦ç”¨ä¸»æœºå¯†é’¥æ£€æŸ¥ï¼ˆå†…ç½‘ç¯å¢ƒï¼‰
host_key_checking = False

# å¼€å¯pipeliningæé«˜æ€§èƒ½
pipelining = True
```

### 8.4 ç›‘æ§å’Œæ—¥å¿—ç®¡ç†


**è®°å½•æ“ä½œæ—¥å¿—**ï¼š
```ini
[defaults]
# å¯ç”¨æ—¥å¿—è®°å½•
log_path = /var/log/ansible/ansible.log

# è®°å½•è¯¦ç»†ä¿¡æ¯
display_skipped_hosts = True
display_ok_hosts = True
```

**æ€§èƒ½ç›‘æ§é…ç½®**ï¼š
```yaml
# group_vars/all.yml
ansible_callback_whitelist:
  - timer        # æ˜¾ç¤ºä»»åŠ¡æ‰§è¡Œæ—¶é—´
  - profile_tasks # æ˜¾ç¤ºæœ€è€—æ—¶çš„ä»»åŠ¡
  - log_plays    # è®°å½•playbookæ‰§è¡Œæ—¥å¿—
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ¯ **æ ¸å¿ƒæ¦‚å¿µ**ï¼š
â€¢ Inventory = ä¸»æœºç”µè¯ç°¿ï¼Œè®°å½•è¦ç®¡ç†çš„æ‰€æœ‰æœåŠ¡å™¨
â€¢ é™æ€Inventory = æ‰‹å·¥ç»´æŠ¤çš„é…ç½®æ–‡ä»¶ï¼Œé€‚åˆç¨³å®šç¯å¢ƒ  
â€¢ åŠ¨æ€Inventory = ç¨‹åºè‡ªåŠ¨ç”Ÿæˆï¼Œé€‚åˆäº‘ç¯å¢ƒ
â€¢ ä¸»æœºå˜é‡ = å•ä¸ªæœåŠ¡å™¨çš„ä¸“ç”¨é…ç½®
â€¢ ç»„å˜é‡ = ä¸€ç»„æœåŠ¡å™¨çš„å…±åŒé…ç½®
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ åˆ†ç»„ç­–ç•¥çš„é‡è¦æ€§**
```
åˆç†åˆ†ç»„çš„å¥½å¤„ï¼š
â€¢ æ‰¹é‡æ“ä½œï¼šä¸€æ¬¡æ€§ç®¡ç†åŒç±»æœåŠ¡å™¨
â€¢ å˜é‡ç»§æ‰¿ï¼šç»„å˜é‡è‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰ç»„æˆå‘˜
â€¢ æƒé™æ§åˆ¶ï¼šå¯ä»¥åŸºäºç»„è®¾ç½®æ“ä½œæƒé™
â€¢ ç¯å¢ƒéš”ç¦»ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒåˆ†ç¦»
```

**ğŸ”¹ å˜é‡ä¼˜å…ˆçº§ç†è§£**
```
ä¼˜å…ˆçº§è®°å¿†è¦ç‚¹ï¼š
â€¢ è¶Šå…·ä½“çš„å˜é‡ä¼˜å…ˆçº§è¶Šé«˜
â€¢ ä¸»æœºå˜é‡ > ç»„å˜é‡ > å…¨å±€å˜é‡  
â€¢ æ–‡ä»¶å˜é‡ > inventoryå†…è”å˜é‡
â€¢ å‘½ä»¤è¡Œå‚æ•°ä¼˜å…ˆçº§æœ€é«˜
```

**ğŸ”¹ åŠ¨æ€vsé™æ€é€‰æ‹©åŸåˆ™**
```
é™æ€Inventoryé€‚åˆï¼š
â€¢ æœåŠ¡å™¨é…ç½®ç›¸å¯¹å›ºå®š
â€¢ å°è§„æ¨¡ç¯å¢ƒï¼ˆ<100å°ï¼‰
â€¢ å®‰å…¨è¦æ±‚è¾ƒé«˜çš„ç¯å¢ƒ

åŠ¨æ€Inventoryé€‚åˆï¼š  
â€¢ äº‘ç¯å¢ƒæˆ–å®¹å™¨åŒ–éƒ¨ç½²
â€¢ æœåŠ¡å™¨IPé¢‘ç¹å˜åŒ–
â€¢ å¤§è§„æ¨¡è‡ªåŠ¨åŒ–è¿ç»´
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


ğŸ’¼ **å®é™…åœºæ™¯åº”ç”¨**ï¼š
- **Webæ¶æ„éƒ¨ç½²**ï¼šwebç»„ã€dbç»„ã€cacheç»„åˆ†åˆ«éƒ¨ç½²ä¸åŒè½¯ä»¶
- **ç¯å¢ƒç®¡ç†**ï¼šdevã€testã€prodç»„ä½¿ç”¨ä¸åŒé…ç½®å‚æ•°
- **æ»šåŠ¨æ›´æ–°**ï¼šä½¿ç”¨ä¸»æœºæ¨¡å¼å®ç°åˆ†æ‰¹æ›´æ–°ï¼Œé¿å…æœåŠ¡ä¸­æ–­
- **æ•…éšœå¤„ç†**ï¼šå¿«é€Ÿå®šä½å’Œä¿®å¤ç‰¹å®šç»„æˆ–ä¸»æœºçš„é—®é¢˜

ğŸ”§ **è¿ç»´å®è·µ**ï¼š
- **æ ‡å‡†åŒ–ç®¡ç†**ï¼šé€šè¿‡ç»„å˜é‡ç»Ÿä¸€é…ç½®æ ‡å‡†
- **æƒé™æ§åˆ¶**ï¼šä¸åŒå›¢é˜Ÿç®¡ç†ä¸åŒçš„ä¸»æœºç»„
- **è‡ªåŠ¨åŒ–é›†æˆ**ï¼šä¸CMDBã€ç›‘æ§ç³»ç»Ÿé›†æˆå®ç°å…¨è‡ªåŠ¨åŒ–
- **åˆè§„å®¡è®¡**ï¼šé€šè¿‡inventoryè®°å½•æ‰€æœ‰è¢«ç®¡ç†çš„èµ„äº§

### 9.4 æœ€ä½³å®è·µå»ºè®®


```
ğŸŸ¢ **æ¨èåšæ³•**ï¼š
â€¢ ä½¿ç”¨SSHå¯†é’¥è®¤è¯ï¼Œé¿å…å¯†ç 
â€¢ åˆç†è§„åˆ’åˆ†ç»„ï¼Œä¾¿äºæ‰¹é‡æ“ä½œ
â€¢ æ•æ„Ÿä¿¡æ¯ä½¿ç”¨Ansible VaultåŠ å¯†
â€¢ å®šæœŸå¤‡ä»½inventoryæ–‡ä»¶å’Œå˜é‡
â€¢ ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†inventoryå˜æ›´

ğŸ”´ **é¿å…çš„é”™è¯¯**ï¼š
â€¢ ä¸è¦åœ¨inventoryä¸­å­˜å‚¨æ˜æ–‡å¯†ç 
â€¢ é¿å…è¿‡åº¦å¤æ‚çš„åµŒå¥—åˆ†ç»„
â€¢ ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç¦ç”¨SSHå¯†é’¥æ£€æŸ¥
â€¢ é¿å…åœ¨åŠ¨æ€inventoryä¸­ç¡¬ç¼–ç å‡­æ®
```

ğŸ§  **è®°å¿†å£è¯€**ï¼š
```
"ä¸»æœºæ¸…å•æ˜¯åŸºç¡€ï¼Œé™æ€åŠ¨æ€çœ‹åœºæ™¯
åˆ†ç»„ç­–ç•¥è¦åˆç†ï¼Œå˜é‡ä¼˜å…ˆæœ‰å±‚æ¬¡  
è¿æ¥å‚æ•°é…å®‰å…¨ï¼Œå¤§è§„æ¨¡è¦ä¼˜åŒ–"
```

**ğŸ”‘ å…³é”®å‘½ä»¤é€ŸæŸ¥**ï¼š
```bash
# æŸ¥çœ‹inventoryä¿¡æ¯
ansible-inventory --list                    # æ˜¾ç¤ºæ‰€æœ‰ä¸»æœºå’Œç»„
ansible-inventory --host web01              # æ˜¾ç¤ºæŒ‡å®šä¸»æœºå˜é‡
ansible-inventory --graph                   # æ˜¾ç¤ºåˆ†ç»„å±‚æ¬¡å›¾

# æµ‹è¯•è¿æ¥
ansible all -m ping -i inventory/hosts      # æµ‹è¯•æ‰€æœ‰ä¸»æœºè¿é€šæ€§
ansible webservers -m setup | grep ansible_hostname  # è·å–ä¸»æœºä¿¡æ¯
```