---
title: 14ã€SaltStackæ¶æ„åŸç†
---
## ğŸ“š ç›®å½•

1. [SaltStackæ ¸å¿ƒæ¦‚å¿µ](#1-SaltStackæ ¸å¿ƒæ¦‚å¿µ)
2. [Master-Minionæ¶æ„æ·±å…¥](#2-Master-Minionæ¶æ„æ·±å…¥)
3. [ZeroMQæ¶ˆæ¯æ€»çº¿æœºåˆ¶](#3-ZeroMQæ¶ˆæ¯æ€»çº¿æœºåˆ¶)
4. [äº‹ä»¶é©±åŠ¨æ¶æ„æ¨¡å¼](#4-äº‹ä»¶é©±åŠ¨æ¶æ„æ¨¡å¼)
5. [è®¤è¯ä¸åŠ å¯†ä½“ç³»](#5-è®¤è¯ä¸åŠ å¯†ä½“ç³»)
6. [ä½œä¸šè°ƒåº¦ç³»ç»Ÿ](#6-ä½œä¸šè°ƒåº¦ç³»ç»Ÿ)
7. [è¿”å›ç³»ç»Ÿæœºåˆ¶](#7-è¿”å›ç³»ç»Ÿæœºåˆ¶)
8. [Pillaræ•°æ®ç®¡ç†](#8-Pillaræ•°æ®ç®¡ç†)
9. [Grainç³»ç»Ÿä¿¡æ¯æ”¶é›†](#9-Grainç³»ç»Ÿä¿¡æ¯æ”¶é›†)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ§© SaltStackæ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯SaltStack


**ğŸ“– åŸºæœ¬å®šä¹‰**
SaltStackæ˜¯ä¸€ä¸ªåŸºäºPythonå¼€å‘çš„è‡ªåŠ¨åŒ–é…ç½®ç®¡ç†å’Œè¿œç¨‹æ‰§è¡Œç³»ç»Ÿï¼Œé‡‡ç”¨Master-Minionæ¶æ„ï¼Œé€šè¿‡é«˜æ€§èƒ½çš„æ¶ˆæ¯æ€»çº¿å®ç°å¤§è§„æ¨¡æœåŠ¡å™¨ç®¡ç†ã€‚

**ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ**
```
æ€§èƒ½ä¼˜å…ˆï¼šåŸºäºZeroMQå®ç°é«˜å¹¶å‘é€šä¿¡
ç®€å•æ˜“ç”¨ï¼šYAMLé…ç½®æ–‡ä»¶ï¼Œå­¦ä¹ æˆæœ¬ä½
æ‰©å±•æ€§å¼ºï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒè‡ªå®šä¹‰å¼€å‘
å®æ—¶å“åº”ï¼šäº‹ä»¶é©±åŠ¨ï¼Œæ”¯æŒå®æ—¶ç›‘æ§å’Œå“åº”
```

### 1.2 SaltStack vs å…¶ä»–å·¥å…·


| ç‰¹æ€§å¯¹æ¯” | **SaltStack** | **Ansible** | **Puppet** |
|---------|-------------|------------|-----------|
| `æ¶æ„æ¨¡å¼` | Master-Minion | æ— ä»£ç† | Master-Agent |
| `é€šä¿¡æ–¹å¼` | ZeroMQæ¶ˆæ¯é˜Ÿåˆ— | SSHè¿æ¥ | HTTP/HTTPS |
| `æ‰§è¡Œé€Ÿåº¦` | â­â­â­â­â­ æå¿« | â­â­â­â˜†â˜† ä¸­ç­‰ | â­â­â­â­â˜† è¾ƒå¿« |
| `å­¦ä¹ éš¾åº¦` | â­â­â­â˜†â˜† ä¸­ç­‰ | â­â­â˜†â˜†â˜† ç®€å• | â­â­â­â­â˜† è¾ƒéš¾ |
| `å®æ—¶æ€§` | â­â­â­â­â­ ä¼˜ç§€ | â­â­â˜†â˜†â˜† ä¸€èˆ¬ | â­â­â­â˜†â˜† ä¸­ç­‰ |

### 1.3 é€‚ç”¨åœºæ™¯åˆ¤æ–­


**âœ… æ¨èä½¿ç”¨åœºæ™¯**
- å¤§è§„æ¨¡æœåŠ¡å™¨é›†ç¾¤ç®¡ç†ï¼ˆ1000å°ä»¥ä¸Šï¼‰
- éœ€è¦å®æ—¶ç›‘æ§å’Œå¿«é€Ÿå“åº”çš„ç¯å¢ƒ
- è¦æ±‚é«˜å¹¶å‘æ‰§è¡Œçš„æ‰¹é‡æ“ä½œ
- å¤æ‚çš„åŸºç¡€è®¾æ–½è‡ªåŠ¨åŒ–éœ€æ±‚

**âŒ ä¸æ¨èåœºæ™¯**
- å°è§„æ¨¡ç¯å¢ƒï¼ˆå°‘äº50å°æœåŠ¡å™¨ï¼‰
- ç½‘ç»œç¯å¢ƒä¸ç¨³å®šçš„åˆ†å¸ƒå¼åœºæ™¯
- å›¢é˜ŸPythonæŠ€æœ¯æ ˆè–„å¼±

---

## 2. ğŸ—ï¸ Master-Minionæ¶æ„æ·±å…¥


### 2.1 æ¶æ„ç»„ä»¶æ¦‚è§ˆ


**ğŸ”§ æ ¸å¿ƒç»„ä»¶å…³ç³»**
```
SaltStackæ•´ä½“æ¶æ„å›¾ï¼š

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              Salt Master                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ æ–‡ä»¶æœåŠ¡ â”‚  â”‚ ä½œä¸šç®¡ç† â”‚  â”‚ äº‹ä»¶æ€»çº¿ â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚è®¤è¯ç®¡ç†  â”‚  â”‚ Pillar  â”‚  â”‚ è¿”å›å™¨  â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ ZeroMQæ¶ˆæ¯æ€»çº¿
                   â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚           â”‚           â”‚
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
   â”‚Minion1â”‚   â”‚Minion2â”‚   â”‚MinionNâ”‚
   â”‚       â”‚   â”‚       â”‚   â”‚       â”‚
   â”‚Grain  â”‚   â”‚Grain  â”‚   â”‚Grain  â”‚
   â”‚æ¨¡å—   â”‚   â”‚æ¨¡å—   â”‚   â”‚æ¨¡å—   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Salt Masterè¯¦è§£


**ğŸ¯ Masteræ ¸å¿ƒèŒè´£**
- **å‘½ä»¤åˆ†å‘**ï¼šæ¥æ”¶ç®¡ç†å‘˜æŒ‡ä»¤ï¼Œåˆ†å‘ç»™ç›®æ ‡Minion
- **è®¤è¯ç®¡ç†**ï¼šå¤„ç†Minionè¿æ¥è®¤è¯å’Œå¯†é’¥ç®¡ç†
- **æ–‡ä»¶æœåŠ¡**ï¼šæä¾›é…ç½®æ–‡ä»¶ã€è„šæœ¬ç­‰èµ„æºä¸‹è½½
- **ä½œä¸šè°ƒåº¦**ï¼šç®¡ç†ä»»åŠ¡é˜Ÿåˆ—å’Œæ‰§è¡Œè®¡åˆ’
- **ç»“æœæ”¶é›†**ï¼šæ±‡æ€»Minionæ‰§è¡Œç»“æœå¹¶è¿”å›

**ğŸ’¡ Masteræ ¸å¿ƒé…ç½®ç¤ºä¾‹**
```yaml
# /etc/salt/master æ ¸å¿ƒé…ç½®
interface: 0.0.0.0          # ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£
publish_port: 4505          # å‘å¸ƒç«¯å£ï¼ˆå‘½ä»¤åˆ†å‘ï¼‰
ret_port: 4506              # è¿”å›ç«¯å£ï¼ˆç»“æœæ”¶é›†ï¼‰
worker_threads: 5           # å·¥ä½œçº¿ç¨‹æ•°
timeout: 5                  # å‘½ä»¤è¶…æ—¶æ—¶é—´
keep_jobs: 24               # ä½œä¸šä¿ç•™æ—¶é—´ï¼ˆå°æ—¶ï¼‰
file_roots:                 # æ–‡ä»¶æ ¹ç›®å½•
  base:
    - /srv/salt
pillar_roots:               # Pillaræ•°æ®ç›®å½•
  base:
    - /srv/pillar
```

### 2.3 Salt Minionè¯¦è§£


**ğŸ”§ Minionæ ¸å¿ƒåŠŸèƒ½**
- **è¿æ¥ç»´æŠ¤**ï¼šä¸Masterå»ºç«‹å¹¶ç»´æŒé•¿è¿æ¥
- **å‘½ä»¤æ‰§è¡Œ**ï¼šæ¥æ”¶å¹¶æ‰§è¡ŒMasterä¸‹å‘çš„æŒ‡ä»¤
- **çŠ¶æ€æ±‡æŠ¥**ï¼šå®šæœŸå‘Masteræ±‡æŠ¥ç³»ç»ŸçŠ¶æ€
- **æ¨¡å—åŠ è½½**ï¼šåŠ¨æ€åŠ è½½æ‰§è¡Œæ¨¡å—å’ŒçŠ¶æ€æ¨¡å—

**âš¡ Minionå¯åŠ¨æµç¨‹**
```
Minionå¯åŠ¨åºåˆ—ï¼š

1. è¯»å–é…ç½®æ–‡ä»¶ â†’ /etc/salt/minion
2. ç”Ÿæˆå¯†é’¥å¯¹ â†’ /etc/salt/pki/minion/
3. è¿æ¥Master â†’ ç«¯å£4505/4506
4. å‘é€è®¤è¯è¯·æ±‚ â†’ å…¬é’¥äº¤æ¢
5. ç­‰å¾…Masteræ¥å— â†’ å¯†é’¥éªŒè¯
6. å»ºç«‹åŠ å¯†é€šé“ â†’ AESåŠ å¯†é€šä¿¡
7. æ¥æ”¶å‘½ä»¤å°±ç»ª â†’ è¿›å…¥ç›‘å¬çŠ¶æ€
```

> ğŸ’¡ **å®ç”¨æç¤º**ï¼šMinioné¦–æ¬¡è¿æ¥æ—¶éœ€è¦Masteræ‰‹åŠ¨æ¥å—å…¶å…¬é’¥ï¼Œå¯ä»¥é€šè¿‡ `salt-key -A` æ‰¹é‡æ¥å—æ‰€æœ‰å¾…è®¤è¯çš„Minionã€‚

---

## 3. ğŸ“¡ ZeroMQæ¶ˆæ¯æ€»çº¿æœºåˆ¶


### 3.1 ZeroMQæ ¸å¿ƒæ¦‚å¿µ


**ğŸš€ ä»€ä¹ˆæ˜¯ZeroMQ**
ZeroMQæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½å¼‚æ­¥æ¶ˆæ¯åº“ï¼ŒSaltStacké€‰æ‹©å®ƒä½œä¸ºé€šä¿¡åŸºç¡€çš„åŸå› æ˜¯å…¶**æ— ä»£ç†**ã€**é«˜å¹¶å‘**ã€**ä½å»¶è¿Ÿ**çš„ç‰¹ç‚¹ã€‚

**ğŸ“Š ä¼ ç»ŸTCP vs ZeroMQå¯¹æ¯”**
```
ä¼ ç»ŸTCPé€šä¿¡æ¨¡å¼ï¼š
å®¢æˆ·ç«¯1 â”€â”€â”
å®¢æˆ·ç«¯2 â”€â”€â”¼â”€â”€ æœåŠ¡å™¨ â”€â”€ å¤„ç†é€»è¾‘
å®¢æˆ·ç«¯3 â”€â”€â”˜
é—®é¢˜ï¼šè¿æ¥æ•°é™åˆ¶ï¼Œå¹¶å‘ç“¶é¢ˆ

ZeroMQé€šä¿¡æ¨¡å¼ï¼š
å®¢æˆ·ç«¯1 â”€â”€â”
å®¢æˆ·ç«¯2 â”€â”€â”¼â”€â”€ æ¶ˆæ¯é˜Ÿåˆ— â”€â”€ å¹¶è¡Œå¤„ç†å™¨1
å®¢æˆ·ç«¯3 â”€â”€â”˜              â”œâ”€â”€ å¹¶è¡Œå¤„ç†å™¨2
                        â””â”€â”€ å¹¶è¡Œå¤„ç†å™¨N
ä¼˜åŠ¿ï¼šå¼‚æ­¥å¤„ç†ï¼Œæ— è¿æ¥æ•°é™åˆ¶
```

### 3.2 SaltStackä¸­çš„ZeroMQåº”ç”¨


**ğŸ”Œ åŒç«¯å£é€šä¿¡æœºåˆ¶**
```
Salté€šä¿¡æ¶æ„ï¼š

Master (4505ç«¯å£ - Publisher)
   â”‚
   â”‚ å‘å¸ƒå‘½ä»¤/çŠ¶æ€
   â–¼
Minions (Subscribers)
   â”‚
   â”‚ è¿”å›ç»“æœ
   â–¼
Master (4506ç«¯å£ - Pull Socket)
```

**âš¡ ç«¯å£åŠŸèƒ½è¯¦è§£**
- **ç«¯å£4505**ï¼š`Publisher-Subscriber`æ¨¡å¼ï¼ŒMasterå‘æ‰€æœ‰Minionå‘å¸ƒå‘½ä»¤
- **ç«¯å£4506**ï¼š`Push-Pull`æ¨¡å¼ï¼ŒMinionå‘Masteræ¨é€æ‰§è¡Œç»“æœ

### 3.3 æ¶ˆæ¯ä¼ è¾“ä¼˜åŒ–


**ğŸ¯ æ€§èƒ½ä¼˜åŒ–æœºåˆ¶**
```yaml
# Masterç«¯ä¼˜åŒ–é…ç½®
max_open_files: 100000      # æœ€å¤§æ–‡ä»¶å¥æŸ„æ•°
worker_threads: 10          # å¢åŠ å·¥ä½œçº¿ç¨‹
zmq_backlog: 1000          # ZeroMQæ¶ˆæ¯é˜Ÿåˆ—å¤§å°
zmq_filtering: True        # å¯ç”¨æ¶ˆæ¯è¿‡æ»¤
```

**ğŸ“ˆ å¹¶å‘å¤„ç†èƒ½åŠ›**
- **ç†è®ºä¸Šé™**ï¼šå•Masterå¯ç®¡ç†æ•°ä¸‡Minion
- **å®é™…å»ºè®®**ï¼š1000-5000ä¸ªMinionä¸ºæœ€ä½³æ€§èƒ½åŒºé—´
- **æ‰©å±•æ–¹æ¡ˆ**ï¼šå¤šMasteræ¶æ„æˆ–Syndicä»£ç†æ¨¡å¼

---

## 4. âš¡ äº‹ä»¶é©±åŠ¨æ¶æ„æ¨¡å¼


### 4.1 äº‹ä»¶ç³»ç»Ÿæ¦‚è¿°


**ğŸ”„ ä»€ä¹ˆæ˜¯äº‹ä»¶é©±åŠ¨**
SaltStacké‡‡ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å¼ï¼Œç³»ç»Ÿä¸­çš„æ¯ä¸ªæ“ä½œéƒ½ä¼šäº§ç”Ÿç›¸åº”çš„äº‹ä»¶ï¼Œå…¶ä»–ç»„ä»¶å¯ä»¥ç›‘å¬å’Œå“åº”è¿™äº›äº‹ä»¶ï¼Œå®ç°æ¾è€¦åˆçš„ç³»ç»Ÿæ¶æ„ã€‚

**ğŸ“ äº‹ä»¶ç±»å‹åˆ†ç±»**
```
ç³»ç»Ÿçº§äº‹ä»¶ï¼š
â”œâ”€â”€ salt/minion/start     # Minionå¯åŠ¨äº‹ä»¶
â”œâ”€â”€ salt/auth            # è®¤è¯ç›¸å…³äº‹ä»¶
â”œâ”€â”€ salt/key            # å¯†é’¥ç®¡ç†äº‹ä»¶
â””â”€â”€ salt/job            # ä½œä¸šæ‰§è¡Œäº‹ä»¶

ç”¨æˆ·è‡ªå®šä¹‰äº‹ä»¶ï¼š
â”œâ”€â”€ custom/deploy       # éƒ¨ç½²äº‹ä»¶
â”œâ”€â”€ custom/monitor      # ç›‘æ§äº‹ä»¶
â””â”€â”€ custom/alert        # å‘Šè­¦äº‹ä»¶
```

### 4.2 äº‹ä»¶æ€»çº¿æœºåˆ¶


**ğŸšŒ äº‹ä»¶æ€»çº¿æ¶æ„**
```
äº‹ä»¶æµè½¬è¿‡ç¨‹ï¼š

äº‹ä»¶äº§ç”Ÿè€…                äº‹ä»¶æ€»çº¿                äº‹ä»¶æ¶ˆè´¹è€…
    â”‚                       â”‚                       â”‚
Minionæ‰§è¡Œ â”€â”€â–º äº§ç”Ÿäº‹ä»¶ â”€â”€â–º â”‚ â”€â”€â–º äº‹ä»¶åˆ†å‘ â”€â”€â–º ç›‘å¬ç¨‹åº
    â”‚                  äº‹ä»¶é˜Ÿåˆ—                     â”‚
Masterè°ƒåº¦ â”€â”€â–º äº§ç”Ÿäº‹ä»¶ â”€â”€â–º â”‚ â”€â”€â–º äº‹ä»¶è·¯ç”± â”€â”€â–º å“åº”ç¨‹åº
    â”‚                       â”‚                       â”‚
ç”¨æˆ·æ“ä½œ â”€â”€â–º äº§ç”Ÿäº‹ä»¶ â”€â”€â–º â”‚ â”€â”€â–º äº‹ä»¶å­˜å‚¨ â”€â”€â–º æ—¥å¿—ç³»ç»Ÿ
```

### 4.3 äº‹ä»¶ç›‘å¬ä¸å“åº”


**ğŸ‘‚ ç›‘å¬äº‹ä»¶ç¤ºä¾‹**
```python
# ç®€å•çš„äº‹ä»¶ç›‘å¬ç¨‹åº
import salt.utils.event

# åˆ›å»ºäº‹ä»¶ç›‘å¬å™¨
event = salt.utils.event.get_event('master')

# æŒç»­ç›‘å¬äº‹ä»¶
for edata in event.iter_events():
    if edata['tag'].startswith('salt/job'):
        print(f"ä½œä¸šäº‹ä»¶: {edata['tag']}")
        print(f"æ•°æ®å†…å®¹: {edata['data']}")
```

**ğŸ¯ Reactorå“åº”ç³»ç»Ÿ**
```yaml
# /srv/reactor/deploy.sls - è‡ªåŠ¨å“åº”éƒ¨ç½²äº‹ä»¶
deploy_success:
  - tgt: 'monitoring-server'
    sls:
      - monitor.update_status
    kwarg:
      status: 'deployed'
      timestamp: {{ salt['cmd.run']('date +%s') }}
```

> âš ï¸ **æ³¨æ„**ï¼šäº‹ä»¶ç³»ç»Ÿæ˜¯SaltStackå®æ—¶æ€§çš„æ ¸å¿ƒï¼Œä½†è¿‡å¤šçš„äº‹ä»¶ç›‘å¬å¯èƒ½å½±å“æ€§èƒ½ï¼Œå»ºè®®åˆç†è®¾ç½®äº‹ä»¶è¿‡æ»¤è§„åˆ™ã€‚

---

## 5. ğŸ” è®¤è¯ä¸åŠ å¯†ä½“ç³»


### 5.1 PKIå¯†é’¥ç®¡ç†


**ğŸ—ï¸ å¯†é’¥ä½“ç³»ç»“æ„**
```
Salt PKIå¯†é’¥ç›®å½•ç»“æ„ï¼š

Masterç«¯ (/etc/salt/pki/master/)ï¼š
â”œâ”€â”€ master.pem          # Masterç§é’¥
â”œâ”€â”€ master.pub          # Masterå…¬é’¥
â”œâ”€â”€ minions/            # å·²æ¥å—çš„Minionå…¬é’¥
â”‚   â”œâ”€â”€ web01.pub
â”‚   â””â”€â”€ web02.pub
â”œâ”€â”€ minions_pre/        # å¾…æ¥å—çš„Minionå…¬é’¥
â”œâ”€â”€ minions_denied/     # è¢«æ‹’ç»çš„Minionå…¬é’¥
â””â”€â”€ minions_rejected/   # è¢«æ’¤é”€çš„Minionå…¬é’¥

Minionç«¯ (/etc/salt/pki/minion/)ï¼š
â”œâ”€â”€ minion.pem          # Minionç§é’¥
â”œâ”€â”€ minion.pub          # Minionå…¬é’¥
â””â”€â”€ minion_master.pub   # Masterå…¬é’¥å‰¯æœ¬
```

### 5.2 è®¤è¯æµç¨‹è¯¦è§£


**ğŸ”„ è®¤è¯æ¡æ‰‹è¿‡ç¨‹**
```
Minionè®¤è¯æµç¨‹ï¼š

1. Minionç”Ÿæˆå¯†é’¥å¯¹
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ç”ŸæˆRSAå¯†é’¥å¯¹â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
2. å‘é€è®¤è¯è¯·æ±‚      
   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚å‘é€å…¬é’¥åˆ°Masterâ”‚â”€â”€â”€â”€â–ºâ”‚Masteræ¥æ”¶è¯·æ±‚â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
3. MasteréªŒè¯å¤„ç†             â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ç®¡ç†å‘˜æ‰‹åŠ¨æ¥å—â”‚â—„â”€â”€â”€â”€â”‚å­˜å‚¨åˆ°pendingâ”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
4. å»ºç«‹åŠ å¯†é€šé“
   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
   â”‚AESå¯†é’¥åå•†  â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
5. æ­£å¸¸é€šä¿¡        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚åŠ å¯†å‘½ä»¤ä¼ è¾“ä¸æ‰§è¡Œ    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 å®‰å…¨ç­–ç•¥é…ç½®


**ğŸ›¡ï¸ å®‰å…¨åŠ å›ºå»ºè®®**
```yaml
# å¢å¼ºå®‰å…¨é…ç½®
open_mode: False              # ç¦ç”¨å¼€æ”¾æ¨¡å¼
auto_accept: False            # ç¦ç”¨è‡ªåŠ¨æ¥å—
rotate_aes_key: True          # å¯ç”¨AESå¯†é’¥è½®æ¢
sign_pub_messages: True       # æ¶ˆæ¯ç­¾åéªŒè¯
master_sign_pubkey: True      # Masterå…¬é’¥ç­¾å

# è®¿é—®æ§åˆ¶
client_acl:
  admin_user:
    - .*
  deploy_user:
    - 'web*':
        - pkg.install
        - service.restart
```

**ğŸ”’ æœ€ä½³å®‰å…¨å®è·µ**
- **å®šæœŸè½®æ¢å¯†é’¥**ï¼šå»ºè®®æ¯å­£åº¦æ›´æ–°AESé€šä¿¡å¯†é’¥
- **ç½‘ç»œéš”ç¦»**ï¼šMasterå’ŒMinioné—´ä½¿ç”¨ä¸“ç”¨ç½‘ç»œ
- **è®¿é—®æ§åˆ¶**ï¼šåŸºäºç”¨æˆ·å’Œç›®æ ‡çš„ç»†ç²’åº¦æƒé™æ§åˆ¶
- **å®¡è®¡æ—¥å¿—**ï¼šå¯ç”¨è¯¦ç»†çš„æ“ä½œå®¡è®¡æ—¥å¿—

---

## 6. â° ä½œä¸šè°ƒåº¦ç³»ç»Ÿ


### 6.1 ä½œä¸šç”Ÿå‘½å‘¨æœŸ


**ğŸ“‹ ä½œä¸šæ‰§è¡Œæµç¨‹**
```
ä½œä¸šè°ƒåº¦å®Œæ•´æµç¨‹ï¼š

ç”¨æˆ·æäº¤å‘½ä»¤
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å‘½ä»¤è§£æéªŒè¯ â”‚â”€â”€â”€â–ºâ”‚ç›®æ ‡åŒ¹é…ç­›é€‰  â”‚â”€â”€â”€â–ºâ”‚ä½œä¸šIDç”Ÿæˆ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç»“æœæ±‡æ€»è¿”å› â”‚â—„â”€â”€â”€â”‚Minionæ‰§è¡Œä»»åŠ¡â”‚â—„â”€â”€â”€â”‚ä»»åŠ¡åˆ†å‘å¹¿æ’­  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Jobç®¡ç†æœºåˆ¶


**ğŸ·ï¸ Jobæ ‡è¯†ä¸è¿½è¸ª**
```bash
# æŸ¥çœ‹å½“å‰è¿è¡Œçš„ä½œä¸š
salt-run jobs.active

# æŸ¥çœ‹ä½œä¸šå†å²
salt-run jobs.list_jobs

# æŸ¥çœ‹ç‰¹å®šä½œä¸šè¯¦æƒ…
salt-run jobs.lookup_jid 20231201143022360432
```

**â±ï¸ ä½œä¸šè¶…æ—¶å¤„ç†**
```yaml
# ä½œä¸šè¶…æ—¶é…ç½®
timeout: 30                 # å…¨å±€è¶…æ—¶æ—¶é—´(ç§’)
gather_job_timeout: 10      # ä½œä¸šæ”¶é›†è¶…æ—¶
batch_safe_limit: 10        # æ‰¹å¤„ç†å®‰å…¨é™åˆ¶

# é’ˆå¯¹ç‰¹å®šå‘½ä»¤çš„è¶…æ—¶è®¾ç½®
salt '*' cmd.run 'long_running_script.sh' timeout=300
```

### 6.3 æ‰¹å¤„ç†ä¸å¼‚æ­¥æ‰§è¡Œ


**ğŸ“¦ æ‰¹å¤„ç†æ‰§è¡Œ**
```bash
# æ‰¹é‡æ‰§è¡Œï¼Œæ¯æ¬¡å¤„ç†10å°æœåŠ¡å™¨
salt '*' cmd.run 'systemctl restart nginx' -b 10

# ç™¾åˆ†æ¯”æ‰¹å¤„ç†ï¼Œæ¯æ¬¡å¤„ç†25%çš„æœåŠ¡å™¨
salt '*' pkg.upgrade -b 25%
```

**ğŸ”„ å¼‚æ­¥ä½œä¸šæ¨¡å¼**
```bash
# å¼‚æ­¥æ‰§è¡Œå‘½ä»¤
salt '*' cmd.run 'backup_database.sh' --async

# æŸ¥çœ‹å¼‚æ­¥ä½œä¸šç»“æœ
salt-run jobs.lookup_jid <job_id>
```

> ğŸ“Š **æ€§èƒ½æç¤º**ï¼šå¯¹äºå¤§è§„æ¨¡ç¯å¢ƒï¼Œå»ºè®®ä½¿ç”¨æ‰¹å¤„ç†æ¨¡å¼é¿å…åŒæ—¶å¯¹æ‰€æœ‰æœåŠ¡å™¨æ‰§è¡Œé«˜è´Ÿè½½æ“ä½œï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘ç½‘ç»œæ‹¥å¡å’Œç³»ç»Ÿå‹åŠ›ã€‚

---

## 7. ğŸ“¤ è¿”å›ç³»ç»Ÿæœºåˆ¶


### 7.1 Returneræ¦‚å¿µ


**ğŸ“® ä»€ä¹ˆæ˜¯Returner**
Returneræ˜¯SaltStackçš„ç»“æœå¤„ç†ç³»ç»Ÿï¼Œè´Ÿè´£æ¥æ”¶Minionæ‰§è¡Œç»“æœå¹¶è¿›è¡Œå­˜å‚¨ã€è½¬å‘æˆ–å…¶ä»–å¤„ç†ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç»“æœè¿”å›åˆ°Masterçš„å†…å­˜ä¸­ï¼Œä½†å¯ä»¥é…ç½®å°†ç»“æœå‘é€åˆ°æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰å¤–éƒ¨ç³»ç»Ÿã€‚

**ğŸ¯ Returneræ ¸å¿ƒç”¨é€”**
- **ç»“æœæŒä¹…åŒ–**ï¼šå°†æ‰§è¡Œç»“æœå­˜å‚¨åˆ°æ•°æ®åº“
- **æ—¥å¿—é›†ä¸­åŒ–**ï¼šç»Ÿä¸€æ”¶é›†å’Œç®¡ç†æ—¥å¿—ä¿¡æ¯
- **ç›‘æ§é›†æˆ**ï¼šä¸ç›‘æ§ç³»ç»Ÿå¯¹æ¥
- **æŠ¥å‘Šç”Ÿæˆ**ï¼šä¸ºç®¡ç†æŠ¥å‘Šæä¾›æ•°æ®æº

### 7.2 å¸¸ç”¨Returnerç±»å‹


**ğŸ“Š å†…ç½®Returneræ±‡æ€»**
```
æ•°æ®åº“ç±»ï¼š
â”œâ”€â”€ mysql          # MySQLæ•°æ®åº“å­˜å‚¨
â”œâ”€â”€ postgres       # PostgreSQLå­˜å‚¨
â”œâ”€â”€ redis          # Redisç¼“å­˜å­˜å‚¨
â””â”€â”€ elasticsearch  # ESæœç´¢å¼•æ“å­˜å‚¨

æ¶ˆæ¯é˜Ÿåˆ—ç±»ï¼š
â”œâ”€â”€ kafka          # Kafkaæ¶ˆæ¯é˜Ÿåˆ—
â”œâ”€â”€ rabbitmq       # RabbitMQé˜Ÿåˆ—
â””â”€â”€ zmq            # ZeroMQé˜Ÿåˆ—

æ–‡ä»¶ç³»ç»Ÿç±»ï¼š
â”œâ”€â”€ local          # æœ¬åœ°æ–‡ä»¶å­˜å‚¨
â”œâ”€â”€ syslog         # ç³»ç»Ÿæ—¥å¿—
â””â”€â”€ json           # JSONæ ¼å¼æ–‡ä»¶
```

### 7.3 Returneré…ç½®ç¤ºä¾‹


**ğŸ—„ï¸ MySQL Returneré…ç½®**
```yaml
# Minioné…ç½® - å°†ç»“æœå­˜å‚¨åˆ°MySQL
mysql.host: '192.168.1.100'
mysql.user: 'saltstack'
mysql.pass: 'secure_password'
mysql.db: 'saltstack_results'
mysql.port: 3306

# å…¨å±€å¯ç”¨MySQL returner
return: mysql

# æˆ–è€…é’ˆå¯¹ç‰¹å®šä½œä¸šä½¿ç”¨
salt '*' cmd.run 'uptime' --return mysql
```

**ğŸ“¡ å¤šreturneré…ç½®**
```yaml
# åŒæ—¶ä½¿ç”¨å¤šä¸ªreturner
return:
  - mysql
  - redis
  - syslog

# ä¸ºä¸åŒç±»å‹çš„ä½œä¸šé…ç½®ä¸åŒreturner
returner_config:
  mysql:
    - 'cmd.run'
    - 'pkg.*'
  redis:
    - 'grains.*'
    - 'pillar.*'
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼šå¯ç”¨è¿‡å¤šreturnerä¼šå½±å“æ€§èƒ½ï¼Œå»ºè®®æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„returnerç»„åˆã€‚

---

## 8. ğŸ—„ï¸ Pillaræ•°æ®ç®¡ç†


### 8.1 Pillaræ ¸å¿ƒæ¦‚å¿µ


**ğŸ’ ä»€ä¹ˆæ˜¯Pillar**
Pillaræ˜¯SaltStackçš„æ•æ„Ÿæ•°æ®ç®¡ç†ç³»ç»Ÿï¼Œç”¨äºå­˜å‚¨é…ç½®å‚æ•°ã€å¯†ç ã€å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯ã€‚ä¸Grainsä¸åŒï¼ŒPillaræ•°æ®åªèƒ½ç”±Masterè®¿é—®å’Œåˆ†å‘ï¼Œç¡®ä¿æ•æ„Ÿä¿¡æ¯çš„å®‰å…¨æ€§ã€‚

**ğŸ” Pillar vs å…¶ä»–æ•°æ®ç³»ç»Ÿ**
```
æ•°æ®ç±»å‹å¯¹æ¯”ï¼š

Grainsï¼ˆç³»ç»Ÿä¿¡æ¯ï¼‰ï¼š
â””â”€â”€ ç”±Minionæ”¶é›†ï¼Œæ‰€æœ‰äººå¯è§
    â”œâ”€â”€ ç¡¬ä»¶ä¿¡æ¯ï¼šCPUã€å†…å­˜ã€ç£ç›˜
    â”œâ”€â”€ æ“ä½œç³»ç»Ÿï¼šç‰ˆæœ¬ã€æ¶æ„
    â””â”€â”€ ç½‘ç»œä¿¡æ¯ï¼šIPåœ°å€ã€ä¸»æœºå

Pillarï¼ˆé…ç½®æ•°æ®ï¼‰ï¼š
â””â”€â”€ ç”±Masterç®¡ç†ï¼ŒæŒ‰éœ€åˆ†å‘
    â”œâ”€â”€ åº”ç”¨é…ç½®ï¼šæ•°æ®åº“è¿æ¥ä¸²
    â”œâ”€â”€ æ•æ„Ÿä¿¡æ¯ï¼šå¯†ç ã€APIå¯†é’¥
    â””â”€â”€ éƒ¨ç½²å‚æ•°ï¼šç‰ˆæœ¬å·ã€ç¯å¢ƒå˜é‡

æ™®é€šå˜é‡ï¼š
â””â”€â”€ åœ¨Stateæ–‡ä»¶ä¸­ç›´æ¥å®šä¹‰
    â””â”€â”€ ä¸´æ—¶æ€§ã€éæ•æ„Ÿæ•°æ®
```

### 8.2 Pillarç›®å½•ç»“æ„


**ğŸ“ æ ‡å‡†ç›®å½•å¸ƒå±€**
```
/srv/pillar/                    # Pillaræ ¹ç›®å½•
â”œâ”€â”€ top.sls                     # é¡¶çº§é…ç½®æ–‡ä»¶
â”œâ”€â”€ common/                     # é€šç”¨é…ç½®
â”‚   â”œâ”€â”€ users.sls              # ç”¨æˆ·é…ç½®
â”‚   â”œâ”€â”€ packages.sls           # è½¯ä»¶åŒ…é…ç½®
â”‚   â””â”€â”€ security.sls           # å®‰å…¨é…ç½®
â”œâ”€â”€ environments/               # ç¯å¢ƒåŒºåˆ†
â”‚   â”œâ”€â”€ production.sls         # ç”Ÿäº§ç¯å¢ƒ
â”‚   â”œâ”€â”€ testing.sls            # æµ‹è¯•ç¯å¢ƒ
â”‚   â””â”€â”€ development.sls        # å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ applications/               # åº”ç”¨é…ç½®
â”‚   â”œâ”€â”€ web/                   # Webåº”ç”¨
â”‚   â”‚   â”œâ”€â”€ nginx.sls
â”‚   â”‚   â””â”€â”€ apache.sls
â”‚   â””â”€â”€ database/              # æ•°æ®åº“
â”‚       â”œâ”€â”€ mysql.sls
â”‚       â””â”€â”€ postgresql.sls
â””â”€â”€ secrets/                   # åŠ å¯†æ•°æ®
    â”œâ”€â”€ passwords.sls          # å¯†ç 
    â””â”€â”€ certificates.sls       # è¯ä¹¦
```

### 8.3 Pillaré…ç½®å®ä¾‹


**âš™ï¸ åŸºç¡€Pillaré…ç½®**
```yaml
# /srv/pillar/top.sls - Pillaråˆ†é…è§„åˆ™
base:
  '*':                          # æ‰€æœ‰Minion
    - common.users
    - common.packages
  
  'web*':                       # WebæœåŠ¡å™¨
    - applications.web.nginx
    - environments.production
  
  'db*':                        # æ•°æ®åº“æœåŠ¡å™¨
    - applications.database.mysql
    - secrets.passwords

# /srv/pillar/applications/web/nginx.sls
nginx:
  version: '1.18.0'
  worker_processes: 4
  worker_connections: 1024
  ssl_certificate: '/etc/ssl/certs/server.crt'
  ssl_private_key: '/etc/ssl/private/server.key'
  
  upstream_servers:
    - name: 'app_backend'
      servers:
        - '192.168.1.10:8080'
        - '192.168.1.11:8080'
        - '192.168.1.12:8080'
```

**ğŸ”’ æ•æ„Ÿæ•°æ®ç®¡ç†**
```yaml
# /srv/pillar/secrets/passwords.sls
database:
  mysql:
    root_password: 'MySecureRootPass123!'
    app_user: 'webapp'
    app_password: 'WebApp@2023Secure'
    
api_keys:
  payment_gateway: 'pk_live_51H7z2kL...'
  monitoring_service: 'api_key_monitoring_xyz'
  
ssl_certificates:
  private_key: |
    -----BEGIN PRIVATE KEY-----
    MIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQC...
    -----END PRIVATE KEY-----
```

### 8.4 Pillaræ•°æ®ä½¿ç”¨


**ğŸ“ åœ¨Stateä¸­ä½¿ç”¨Pillar**
```yaml
# /srv/salt/nginx/init.sls
{% set nginx = pillar.get('nginx', {}) %}

nginx_package:
  pkg.installed:
    - name: nginx
    - version: {{ nginx.get('version', 'latest') }}

nginx_config:
  file.managed:
    - name: /etc/nginx/nginx.conf
    - source: salt://nginx/files/nginx.conf.jinja
    - template: jinja
    - context:
        worker_processes: {{ nginx.get('worker_processes', 2) }}
        worker_connections: {{ nginx.get('worker_connections', 512) }}
```

> ğŸ’¡ **å®‰å…¨å»ºè®®**ï¼šæ•æ„Ÿçš„Pillaræ•°æ®åº”è¯¥ä½¿ç”¨GPGåŠ å¯†å­˜å‚¨ï¼Œé¿å…æ˜æ–‡ä¿å­˜å¯†ç å’Œå¯†é’¥ä¿¡æ¯ã€‚å¯ä»¥é€šè¿‡ `salt-run pillar.get` éªŒè¯Pillaræ•°æ®åˆ†å‘æ˜¯å¦æ­£ç¡®ã€‚

---

## 9. ğŸ” Grainç³»ç»Ÿä¿¡æ¯æ”¶é›†


### 9.1 GrainåŸºæœ¬æ¦‚å¿µ


**ğŸ“Š ä»€ä¹ˆæ˜¯Grain**
Grainæ˜¯SaltStackçš„ç³»ç»Ÿä¿¡æ¯æ”¶é›†æœºåˆ¶ï¼Œè¿è¡Œåœ¨æ¯ä¸ªMinionä¸Šï¼Œè´Ÿè´£æ”¶é›†å’Œç¼“å­˜ä¸»æœºçš„é™æ€ä¿¡æ¯ï¼Œå¦‚ç¡¬ä»¶è§„æ ¼ã€æ“ä½œç³»ç»Ÿä¿¡æ¯ã€ç½‘ç»œé…ç½®ç­‰ã€‚è¿™äº›ä¿¡æ¯ç”¨äºç›®æ ‡ç­›é€‰å’Œæ¡ä»¶åˆ¤æ–­ã€‚

**ğŸ¯ Grainçš„æ ¸å¿ƒç‰¹ç‚¹**
- **é™æ€ä¿¡æ¯**ï¼šä¸»è¦æ”¶é›†ä¸ç»å¸¸å˜åŒ–çš„ç³»ç»Ÿä¿¡æ¯
- **æœ¬åœ°ç¼“å­˜**ï¼šä¿¡æ¯å­˜å‚¨åœ¨Minionæœ¬åœ°ï¼Œè®¿é—®é€Ÿåº¦å¿«
- **ç›®æ ‡åŒ¹é…**ï¼šç”¨äºå¤æ‚çš„ç›®æ ‡é€‰æ‹©å’Œåˆ†ç»„
- **æ¡ä»¶åˆ¤æ–­**ï¼šåœ¨Stateå’Œæ¨¡æ¿ä¸­ç”¨ä½œæ¡ä»¶åˆ¤æ–­

### 9.2 å†…ç½®Grainç±»å‹


**ğŸ·ï¸ ç³»ç»Ÿçº§Grainåˆ†ç±»**
```
ç¡¬ä»¶ä¿¡æ¯ï¼š
â”œâ”€â”€ cpuarch          # CPUæ¶æ„ (x86_64)
â”œâ”€â”€ num_cpus         # CPUæ ¸å¿ƒæ•°
â”œâ”€â”€ mem_total        # æ€»å†…å­˜(MB)
â”œâ”€â”€ virtual          # è™šæ‹ŸåŒ–ç±»å‹
â””â”€â”€ manufacturer     # ç¡¬ä»¶å‚å•†

æ“ä½œç³»ç»Ÿï¼š
â”œâ”€â”€ os               # æ“ä½œç³»ç»Ÿå (CentOS)
â”œâ”€â”€ os_family        # ç³»ç»Ÿå®¶æ— (RedHat)
â”œâ”€â”€ osrelease        # ç³»ç»Ÿç‰ˆæœ¬ (7.9.2009)
â”œâ”€â”€ kernel           # å†…æ ¸ç‰ˆæœ¬
â””â”€â”€ kernelrelease    # å†…æ ¸å‘å¸ƒç‰ˆæœ¬

ç½‘ç»œä¿¡æ¯ï¼š
â”œâ”€â”€ fqdn             # å®Œå…¨é™å®šåŸŸå
â”œâ”€â”€ host             # ä¸»æœºå
â”œâ”€â”€ ip4_interfaces   # IPv4æ¥å£ä¿¡æ¯
â”œâ”€â”€ ip6_interfaces   # IPv6æ¥å£ä¿¡æ¯
â””â”€â”€ hwaddr_interfaces # MACåœ°å€ä¿¡æ¯
```

### 9.3 GrainæŸ¥çœ‹ä¸ç®¡ç†


**ğŸ” å¸¸ç”¨GrainæŸ¥è¯¢å‘½ä»¤**
```bash
# æŸ¥çœ‹æ‰€æœ‰Grainä¿¡æ¯
salt 'minion01' grains.items

# æŸ¥çœ‹ç‰¹å®šGrainå€¼
salt '*' grains.get os
salt '*' grains.get ip4_interfaces:eth0

# æŒ‰Grainæ¡ä»¶é€‰æ‹©ç›®æ ‡
salt -G 'os:CentOS' cmd.run 'uptime'
salt -G 'virtual:VMware' grains.get mem_total

# å¤åˆæ¡ä»¶æŸ¥è¯¢
salt -C 'G@os:CentOS and G@virtual:VMware' test.ping
```

**ğŸ“ Grainåœ¨ç›®æ ‡é€‰æ‹©ä¸­çš„åº”ç”¨**
```bash
# åŸºäºæ“ä½œç³»ç»Ÿçš„æ‰¹é‡æ“ä½œ
salt -G 'os_family:RedHat' pkg.install 'htop'
salt -G 'os_family:Debian' pkg.install 'htop'

# åŸºäºç¡¬ä»¶é…ç½®çš„æ“ä½œ
salt -G 'num_cpus:4' cmd.run 'service start high-performance-app'
salt -G 'mem_total:>8000' cmd.run 'enable_memory_intensive_features'

# åŸºäºç½‘ç»œç¯å¢ƒçš„é…ç½®
salt -G 'ip4_interfaces:eth0:192.168.1.*' network.interface_ip eth0
```

### 9.4 è‡ªå®šä¹‰Grainå¼€å‘


**ğŸ› ï¸ é™æ€è‡ªå®šä¹‰Grain**
```yaml
# /etc/salt/grains - Minionç«¯é™æ€Grainå®šä¹‰
environment: production
application_role: webserver
datacenter: beijing-az1
team: backend
cost_center: 'CC-001'

database_config:
  primary_db: 'mysql-master.internal'
  backup_db: 'mysql-slave.internal'
  connection_pool: 20
```

**âš¡ åŠ¨æ€è‡ªå®šä¹‰Grainè„šæœ¬**
```python
# /srv/salt/_grains/custom_info.py
def application_info():
    """
    æ”¶é›†åº”ç”¨ç¨‹åºç›¸å…³ä¿¡æ¯çš„è‡ªå®šä¹‰Grain
    """
    grains = {}
    
    # æ£€æŸ¥åº”ç”¨ç¨‹åºçŠ¶æ€
    try:
        with open('/opt/app/version.txt', 'r') as f:
            grains['app_version'] = f.read().strip()
    except:
        grains['app_version'] = 'unknown'
    
    # æ£€æŸ¥æœåŠ¡ç«¯å£
    import subprocess
    try:
        result = subprocess.run(['netstat', '-tlnp'], capture_output=True, text=True)
        if ':80 ' in result.stdout:
            grains['web_server'] = True
        if ':3306 ' in result.stdout:
            grains['database_server'] = True
    except:
        pass
    
    # ç£ç›˜ä½¿ç”¨æƒ…å†µ
    try:
        result = subprocess.run(['df', '-h', '/'], capture_output=True, text=True)
        lines = result.stdout.split('\n')
        if len(lines) > 1:
            usage = lines[1].split()[4].replace('%', '')
            grains['disk_usage_percent'] = int(usage)
    except:
        grains['disk_usage_percent'] = 0
    
    return grains

# åˆ·æ–°Grainç¼“å­˜
salt '*' saltutil.sync_grains
salt '*' saltutil.refresh_grains
```

**ğŸ”„ Grainç¼“å­˜ç®¡ç†**
```bash
# å¼ºåˆ¶åˆ·æ–°Grainä¿¡æ¯
salt '*' grains.reload

# åŒæ­¥è‡ªå®šä¹‰Grainæ¨¡å—
salt '*' saltutil.sync_grains

# æŸ¥çœ‹Grainç¼“å­˜ä½ç½®
# /var/cache/salt/minion/grains
```

> ğŸ“ˆ **æ€§èƒ½æç¤º**ï¼šè‡ªå®šä¹‰Grainè„šæœ¬ä¼šåœ¨Minionå¯åŠ¨æ—¶æ‰§è¡Œï¼Œåº”é¿å…è€—æ—¶æ“ä½œã€‚å¦‚éœ€å®æ—¶æ•°æ®ï¼Œå»ºè®®ä½¿ç”¨Moduleè€ŒéGrainã€‚

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 æ¶æ„ç†è§£è¦ç‚¹


**ğŸ—ï¸ æ•´ä½“æ¶æ„æŒæ¡**
```
SaltStack = Master-Minion + ZeroMQ + Event-Driven + PKI Security

æ ¸å¿ƒç»„ä»¶å…³ç³»ï¼š
â”Œâ”€ Master â”€â”    â”Œâ”€ ZeroMQ â”€â”    â”Œâ”€ Minion â”€â”
â”‚ æŒ‡ä»¤åˆ†å‘  â”‚â—„â”€â”€â–ºâ”‚æ¶ˆæ¯æ€»çº¿   â”‚â—„â”€â”€â–ºâ”‚ å‘½ä»¤æ‰§è¡Œ  â”‚
â”‚ ç»“æœæ”¶é›†  â”‚    â”‚äº‹ä»¶é©±åŠ¨   â”‚    â”‚ çŠ¶æ€æ±‡æŠ¥  â”‚
â”‚ è®¤è¯ç®¡ç†  â”‚    â”‚åŠ å¯†é€šä¿¡   â”‚    â”‚ ä¿¡æ¯æ”¶é›†  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”‘ å…³é”®æ¦‚å¿µå¯¹æ¯”**
| ç»„ä»¶ | **ç”¨é€”** | **æ•°æ®æµå‘** | **å®‰å…¨çº§åˆ«** |
|------|---------|-------------|-------------|
| `Master` | ä¸­å¤®æ§åˆ¶ | åŒå‘é€šä¿¡ | PKIåŠ å¯† |
| `Minion` | ä»»åŠ¡æ‰§è¡Œ | ä¸»åŠ¨æ±‡æŠ¥ | AESåŠ å¯† |
| `Pillar` | æ•æ„Ÿé…ç½® | Masterâ†’Minion | æƒé™æ§åˆ¶ |
| `Grain` | ç³»ç»Ÿä¿¡æ¯ | Minionæœ¬åœ° | å…¬å¼€å¯è§ |

### 10.2 å®ç”¨æ“ä½œè¦ç‚¹


**âš¡ æ—¥å¸¸ç®¡ç†å‘½ä»¤**
```bash
# è¿æ¥çŠ¶æ€æ£€æŸ¥
salt-key -L                    # æŸ¥çœ‹å¯†é’¥çŠ¶æ€
salt '*' test.ping             # æµ‹è¯•è¿é€šæ€§

# ä¿¡æ¯æ”¶é›†
salt '*' grains.get os         # ç³»ç»Ÿä¿¡æ¯
salt '*' pillar.get environment # é…ç½®ä¿¡æ¯

# ä½œä¸šç®¡ç†
salt-run jobs.active           # å½“å‰è¿è¡Œä½œä¸š
salt-run jobs.list_jobs        # å†å²ä½œä¸šåˆ—è¡¨

# æ€§èƒ½ç›‘æ§
salt '*' status.loadavg        # ç³»ç»Ÿè´Ÿè½½
salt '*' disk.usage            # ç£ç›˜ä½¿ç”¨ç‡
```

**ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ**
- **å®šæœŸå¯†é’¥è½®æ¢**ï¼šæ¯å­£åº¦æ›´æ–°AESé€šä¿¡å¯†é’¥
- **æƒé™æœ€å°åŒ–**ï¼šä¸¥æ ¼æ§åˆ¶Pillaræ•°æ®è®¿é—®æƒé™  
- **ç½‘ç»œéš”ç¦»**ï¼šä½¿ç”¨ä¸“ç”¨ç®¡ç†ç½‘ç»œ
- **å®¡è®¡æ—¥å¿—**ï¼šå¯ç”¨è¯¦ç»†æ“ä½œæ—¥å¿—è®°å½•
- **åŠ å¯†å­˜å‚¨**ï¼šæ•æ„ŸPillaræ•°æ®ä½¿ç”¨GPGåŠ å¯†

### 10.3 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹


**ğŸ“Š å¤§è§„æ¨¡éƒ¨ç½²å»ºè®®**
```yaml
# Masteræ€§èƒ½è°ƒä¼˜
worker_threads: 10             # æ ¹æ®CPUæ ¸æ•°è°ƒæ•´
timeout: 10                    # é€‚å½“å¢åŠ è¶…æ—¶æ—¶é—´
keep_jobs: 6                   # å‡å°‘ä½œä¸šå†å²ä¿ç•™æ—¶é—´
max_open_files: 100000         # å¢åŠ æ–‡ä»¶å¥æŸ„é™åˆ¶

# ç½‘ç»œä¼˜åŒ–
zmq_backlog: 1000             # å¢åŠ æ¶ˆæ¯é˜Ÿåˆ—å¤§å°
tcp_keepalive: True           # å¯ç”¨TCPä¿æ´»
tcp_keepalive_idle: 300       # ä¿æ´»æ¢æµ‹é—´éš”
```

**ğŸš€ æ‰©å±•æ¶æ„æ¨¡å¼**
- **å¤šMasteræ¨¡å¼**ï¼šè´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨
- **Syndicä»£ç†æ¨¡å¼**ï¼šåˆ†å±‚ç®¡ç†å¤§è§„æ¨¡ç¯å¢ƒ  
- **æ— Masteræ¨¡å¼**ï¼šç‚¹å¯¹ç‚¹é€šä¿¡å‡å°‘å•ç‚¹æ•…éšœ
- **ç¼“å­˜ä¼˜åŒ–**ï¼šæœ¬åœ°ç¼“å­˜å‡å°‘ç½‘ç»œæµé‡

### 10.4 æ•…éšœæ’æŸ¥è¦ç‚¹


**ğŸ”§ å¸¸è§é—®é¢˜è¯Šæ–­**
```bash
# è¿æ¥é—®é¢˜
salt-key -d minion_id         # åˆ é™¤é—®é¢˜å¯†é’¥
salt-key -a minion_id         # é‡æ–°æ¥å—å¯†é’¥

# æ€§èƒ½é—®é¢˜  
salt-run manage.status        # æ£€æŸ¥MinionçŠ¶æ€
salt '*' saltutil.refresh_pillar # åˆ·æ–°é…ç½®ç¼“å­˜

# ä½œä¸šå¡æ­»
salt-run jobs.kill_jid <jid>  # å¼ºåˆ¶ç»ˆæ­¢ä½œä¸š
```

**ğŸ“ æ—¥å¿—åˆ†æé‡ç‚¹**
- **Masteræ—¥å¿—**ï¼š`/var/log/salt/master`
- **Minionæ—¥å¿—**ï¼š`/var/log/salt/minion`  
- **å…³é”®äº‹ä»¶**ï¼šè®¤è¯å¤±è´¥ã€ä½œä¸šè¶…æ—¶ã€ç½‘ç»œå¼‚å¸¸
- **æ€§èƒ½æŒ‡æ ‡**ï¼šä½œä¸šæ‰§è¡Œæ—¶é—´ã€ç½‘ç»œå»¶è¿Ÿã€èµ„æºä½¿ç”¨ç‡

**æ ¸å¿ƒè®°å¿†**ï¼š
- SaltStack = é«˜æ€§èƒ½ + å®æ—¶å“åº” + å®‰å…¨åŠ å¯† + å¤§è§„æ¨¡ç®¡ç†
- Master-Minionæ¶æ„é€šè¿‡ZeroMQå®ç°é«˜æ•ˆé€šä¿¡
- Pillarç®¡ç†æ•æ„Ÿé…ç½®ï¼ŒGrainæ”¶é›†ç³»ç»Ÿä¿¡æ¯
- äº‹ä»¶é©±åŠ¨æ¶æ„æ”¯æŒå¤æ‚çš„è‡ªåŠ¨åŒ–åœºæ™¯