---
title: 15ã€SaltçŠ¶æ€ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [SLSæ–‡ä»¶è¯­æ³•è§„åˆ™](#1-SLSæ–‡ä»¶è¯­æ³•è§„åˆ™)
2. [çŠ¶æ€å£°æ˜ä¸æ‰§è¡Œ](#2-çŠ¶æ€å£°æ˜ä¸æ‰§è¡Œ)
3. [çŠ¶æ€ä¾èµ–å…³ç³»](#3-çŠ¶æ€ä¾èµ–å…³ç³»)
4. [Jinja2æ¨¡æ¿å¼•æ“](#4-Jinja2æ¨¡æ¿å¼•æ“)
5. [çŠ¶æ€ç¼–è¯‘è¿‡ç¨‹](#5-çŠ¶æ€ç¼–è¯‘è¿‡ç¨‹)
6. [é«˜çŠ¶æ€æ‰§è¡Œæœºåˆ¶](#6-é«˜çŠ¶æ€æ‰§è¡Œæœºåˆ¶)
7. [çŠ¶æ€æµ‹è¯•ä¸è°ƒè¯•](#7-çŠ¶æ€æµ‹è¯•ä¸è°ƒè¯•)
8. [çŠ¶æ€æ¨¡å—æ‰©å±•](#8-çŠ¶æ€æ¨¡å—æ‰©å±•)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“„ SLSæ–‡ä»¶è¯­æ³•è§„åˆ™


### 1.1 ä»€ä¹ˆæ˜¯SLSæ–‡ä»¶


**SLSæ–‡ä»¶**ï¼šSaltStack Stateæ–‡ä»¶çš„ç¼©å†™ï¼Œæ˜¯Saltç”¨æ¥æè¿°ç³»ç»ŸçŠ¶æ€çš„é…ç½®æ–‡ä»¶ã€‚

```
ç®€å•ç†è§£ï¼š
SLSæ–‡ä»¶ = ç³»ç»Ÿé…ç½®çš„è¯´æ˜ä¹¦
å‘Šè¯‰Saltç³»ç»Ÿåº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­çš„
```

**SLSæ–‡ä»¶çš„æœ¬è´¨**ï¼š
- ç”¨**YAMLæ ¼å¼**ç¼–å†™çš„é…ç½®æ–‡ä»¶
- æè¿°ç³»ç»Ÿçš„**æœŸæœ›çŠ¶æ€**
- ç±»ä¼¼äº"é…ç½®æ¸…å•"ï¼Œåˆ—å‡ºè¦åšä»€ä¹ˆ

### 1.2 SLSæ–‡ä»¶åŸºæœ¬ç»“æ„


```yaml
# /srv/salt/webserver.sls
nginx:                          # çŠ¶æ€IDï¼ˆå¿…é¡»å”¯ä¸€ï¼‰
  pkg.installed:               # çŠ¶æ€æ¨¡å—.å‡½æ•°
    - name: nginx              # å‚æ•°ï¼šè½¯ä»¶åŒ…å
  
  service.running:             # å¦ä¸€ä¸ªçŠ¶æ€
    - enable: True             # å‚æ•°ï¼šå¼€æœºè‡ªå¯
    - require:                 # ä¾èµ–å…³ç³»
      - pkg: nginx             # ä¾èµ–nginxåŒ…å®‰è£…å®Œæˆ
```

**ç»“æ„è§£æ**ï¼š
```
çŠ¶æ€ID:              # ç»™è¿™ä¸ªçŠ¶æ€èµ·ä¸ªåå­—
  æ¨¡å—.å‡½æ•°:          # è¦æ‰§è¡Œçš„æ“ä½œ
    - å‚æ•°1: å€¼1      # å…·ä½“é…ç½®å‚æ•°
    - å‚æ•°2: å€¼2
    - require:       # ä¾èµ–å…³ç³»
      - æ¨¡å—: çŠ¶æ€ID
```

### 1.3 YAMLè¯­æ³•è¦ç‚¹


**ğŸ”¸ ç¼©è¿›è§„åˆ™**
```yaml
# âœ… æ­£ç¡®ï¼šä½¿ç”¨2ä¸ªç©ºæ ¼ç¼©è¿›
nginx:
  pkg.installed:
    - name: nginx

# âŒ é”™è¯¯ï¼šä½¿ç”¨Tabæˆ–ä¸ä¸€è‡´ç¼©è¿›
nginx:
	pkg.installed:          # Tabç¼©è¿›
  - name: nginx            # 2ç©ºæ ¼ç¼©è¿›
```

**ğŸ”¸ æ•°æ®ç±»å‹**
```yaml
# å­—ç¬¦ä¸²
name: nginx
message: "Hello World"

# æ•°å­—
port: 80
timeout: 30

# å¸ƒå°”å€¼
enable: True
debug: False

# åˆ—è¡¨
packages:
  - nginx
  - mysql
  - php

# å­—å…¸
user:
  name: www
  home: /var/www
```

### 1.4 å¸¸è§è¯­æ³•é”™è¯¯é¿å…


| é”™è¯¯ç±»å‹ | **é”™è¯¯ç¤ºä¾‹** | **æ­£ç¡®å†™æ³•** |
|---------|------------|-------------|
| **ç¼©è¿›æ··ä¹±** | `ç”¨Tab+ç©ºæ ¼æ··ç”¨` | `ç»Ÿä¸€ä½¿ç”¨2ä¸ªç©ºæ ¼` |
| **å†’å·åæ— ç©ºæ ¼** | `name:nginx` | `name: nginx` |
| **åˆ—è¡¨æ ¼å¼é”™è¯¯** | `packages: nginx, mysql` | `packages:\n  - nginx\n  - mysql` |
| **å¼•å·ä¸åŒ¹é…** | `name: "nginx'` | `name: "nginx"` |

---

## 2. âš™ï¸ çŠ¶æ€å£°æ˜ä¸æ‰§è¡Œ


### 2.1 çŠ¶æ€çš„æ¦‚å¿µç†è§£


**çŠ¶æ€ï¼ˆStateï¼‰**ï¼šæè¿°ç³»ç»ŸæŸä¸ªç»„ä»¶åº”è¯¥å¤„äºä»€ä¹ˆæ ·çš„æƒ…å†µã€‚

```
ç°å®ç±»æ¯”ï¼š
æˆ¿é—´æ•´ç†æ¸…å• = SLSæ–‡ä»¶
- æ¡Œå­è¦å¹²å‡€
- ä¹¦è¦æ•´é½æ‘†æ”¾  
- åƒåœ¾æ¡¶è¦æ¸…ç©º

Saltæ£€æŸ¥æˆ¿é—´ç°çŠ¶ï¼Œæ‰§è¡Œå¿…è¦æ“ä½œè®©æˆ¿é—´è¾¾åˆ°æ¸…å•è¦æ±‚
```

### 2.2 å¸¸ç”¨çŠ¶æ€æ¨¡å—


**ğŸ”¸ pkg - è½¯ä»¶åŒ…ç®¡ç†**
```yaml
install_nginx:
  pkg.installed:
    - name: nginx              # å®‰è£…nginxåŒ…
    
remove_apache:
  pkg.removed:
    - name: apache2            # ç§»é™¤apache2åŒ…

update_system:
  pkg.uptodate:
    - refresh: True            # æ›´æ–°æ‰€æœ‰åŒ…
```

**ğŸ”¸ service - æœåŠ¡ç®¡ç†**
```yaml
nginx_service:
  service.running:
    - name: nginx              # ç¡®ä¿nginxæœåŠ¡è¿è¡Œ
    - enable: True             # å¼€æœºè‡ªå¯åŠ¨
    - reload: True             # é…ç½®å˜åŒ–æ—¶é‡è½½

stop_apache:
  service.dead:
    - name: apache2            # ç¡®ä¿apache2æœåŠ¡åœæ­¢
    - enable: False            # ç¦ç”¨å¼€æœºè‡ªå¯
```

**ğŸ”¸ file - æ–‡ä»¶ç®¡ç†**
```yaml
nginx_config:
  file.managed:
    - name: /etc/nginx/nginx.conf    # ç®¡ç†é…ç½®æ–‡ä»¶
    - source: salt://files/nginx.conf
    - user: root
    - group: root
    - mode: 644

create_directory:
  file.directory:
    - name: /var/www/html      # åˆ›å»ºç›®å½•
    - user: www-data
    - group: www-data
    - mode: 755
    - makedirs: True           # é€’å½’åˆ›å»ºçˆ¶ç›®å½•
```

### 2.3 çŠ¶æ€æ‰§è¡Œé€»è¾‘


```
SaltçŠ¶æ€æ‰§è¡Œè¿‡ç¨‹ï¼š

â‘ æ£€æŸ¥å½“å‰çŠ¶æ€ â†’ â‘¡å¯¹æ¯”æœŸæœ›çŠ¶æ€ â†’ â‘¢æ‰§è¡Œå¿…è¦æ“ä½œ â†’ â‘£è¿”å›ç»“æœ

ç¤ºä¾‹ï¼šnginxæœåŠ¡çŠ¶æ€æ£€æŸ¥
å½“å‰ï¼šnginxæœªå®‰è£…
æœŸæœ›ï¼šnginxå·²å®‰è£…ä¸”è¿è¡Œ
æ“ä½œï¼šå®‰è£…nginx â†’ å¯åŠ¨æœåŠ¡ â†’ è®¾ç½®å¼€æœºè‡ªå¯
ç»“æœï¼šnginxæ­£å¸¸è¿è¡Œ
```

---

## 3. ğŸ”— çŠ¶æ€ä¾èµ–å…³ç³»


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦ä¾èµ–å…³ç³»


**ä¾èµ–å…³ç³»çš„å¿…è¦æ€§**ï¼š
```
é—®é¢˜åœºæ™¯ï¼š
1. å¯åŠ¨nginxæœåŠ¡
2. å®‰è£…nginxè½¯ä»¶åŒ…

å¦‚æœæ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¯èƒ½å…ˆæ‰§è¡Œ1å†æ‰§è¡Œ2
ç»“æœï¼šå¯åŠ¨å¤±è´¥ï¼ˆè½¯ä»¶åŒ…è¿˜æœªå®‰è£…ï¼‰

è§£å†³æ–¹æ¡ˆï¼š
è®©"å¯åŠ¨æœåŠ¡"ä¾èµ–"å®‰è£…è½¯ä»¶åŒ…"
```

### 3.2 ä¾èµ–å…³ç³»ç±»å‹


**ğŸ”¸ require - å‰ç½®ä¾èµ–**
```yaml
nginx:
  pkg.installed:
    - name: nginx

nginx_service:
  service.running:
    - name: nginx
    - require:                 # éœ€è¦å…ˆå®Œæˆ
      - pkg: nginx            # nginxåŒ…çš„å®‰è£…
```

**ğŸ”¸ require_in - åå‘ä¾èµ–**
```yaml
nginx:
  pkg.installed:
    - name: nginx
    - require_in:             # è¢«åé¢çš„çŠ¶æ€ä¾èµ–
      - service: nginx_service

nginx_service:
  service.running:
    - name: nginx
```

**ğŸ”¸ watch - ç›‘å¬å˜åŒ–**
```yaml
nginx_config:
  file.managed:
    - name: /etc/nginx/nginx.conf
    - source: salt://nginx.conf

nginx_service:
  service.running:
    - name: nginx
    - watch:                  # ç›‘å¬æ–‡ä»¶å˜åŒ–
      - file: nginx_config    # é…ç½®æ–‡ä»¶å˜åŒ–æ—¶é‡å¯æœåŠ¡
```

### 3.3 ä¾èµ–å…³ç³»å›¾ç¤º


```
LAMPç¯å¢ƒå®‰è£…ä¾èµ–å…³ç³»ï¼š

MySQLåŒ… â”€â”
         â”œâ”€â†’ PHPåŒ… â”€â†’ PHPé…ç½® â”€â†’ ApacheæœåŠ¡
ApacheåŒ… â”€â”˜    â†“
              PHPæœåŠ¡

æ‰§è¡Œé¡ºåºï¼š
â‘ å®‰è£…MySQLå’ŒApacheåŒ…ï¼ˆå¹¶è¡Œï¼‰
â‘¡å®‰è£…PHPåŒ…
â‘¢é…ç½®PHP
â‘£å¯åŠ¨Apacheå’ŒPHPæœåŠ¡
```

### 3.4 å¤æ‚ä¾èµ–ç¤ºä¾‹


```yaml
# å®Œæ•´çš„WebæœåŠ¡å™¨é…ç½®
mysql:
  pkg.installed:
    - name: mysql-server

apache:
  pkg.installed:
    - name: apache2

php:
  pkg.installed:
    - name: php
    - require:
      - pkg: mysql
      - pkg: apache

php_config:
  file.managed:
    - name: /etc/php/php.ini
    - source: salt://php.ini
    - require:
      - pkg: php

apache_service:
  service.running:
    - name: apache2
    - enable: True
    - watch:                  # ç›‘å¬é…ç½®å˜åŒ–
      - file: php_config
    - require:
      - pkg: apache
      - pkg: php
```

---

## 4. ğŸ¨ Jinja2æ¨¡æ¿å¼•æ“


### 4.1 ä»€ä¹ˆæ˜¯Jinja2æ¨¡æ¿


**Jinja2**ï¼šPythonçš„æ¨¡æ¿å¼•æ“ï¼Œè®©SLSæ–‡ä»¶å¯ä»¥åŠ¨æ€ç”Ÿæˆå†…å®¹ã€‚

```
ç®€å•ç†è§£ï¼š
æ™®é€šSLS = å†™æ­»çš„é…ç½®
Jinja2æ¨¡æ¿ = å¯å˜çš„é…ç½®æ¨¡æ¿

ç±»æ¯”ï¼š
æ™®é€šé…ç½®ï¼šæœåŠ¡å™¨IPæ˜¯192.168.1.100
æ¨¡æ¿é…ç½®ï¼šæœåŠ¡å™¨IPæ˜¯{{ server_ip }}ï¼ˆå¯æ ¹æ®å®é™…æƒ…å†µå¡«å…¥ï¼‰
```

### 4.2 åŸºæœ¬è¯­æ³•è§„åˆ™


**ğŸ”¸ å˜é‡è¾“å‡º**
```yaml
# ä½¿ç”¨åŒèŠ±æ‹¬å·è¾“å‡ºå˜é‡
server_name: {{ pillar['server_name'] }}
port: {{ grains['port'] }}
```

**ğŸ”¸ æ¡ä»¶åˆ¤æ–­**
```yaml
# æ ¹æ®æ“ä½œç³»ç»Ÿç±»å‹é€‰æ‹©ä¸åŒè½¯ä»¶åŒ…
{% if grains['os_family'] == 'Debian' %}
package_name: nginx
{% elif grains['os_family'] == 'RedHat' %}
package_name: httpd
{% endif %}
```

**ğŸ”¸ å¾ªç¯éå†**
```yaml
# æ‰¹é‡åˆ›å»ºç”¨æˆ·
{% for user in pillar['users'] %}
{{ user }}:
  user.present:
    - name: {{ user }}
    - home: /home/{{ user }}
{% endfor %}
```

### 4.3 å®é™…åº”ç”¨åœºæ™¯


**åœºæ™¯1ï¼šå¤šç¯å¢ƒé…ç½®**
```yaml
# /srv/salt/database.sls
{% set env = pillar.get('environment', 'dev') %}

mysql_config:
  file.managed:
    - name: /etc/mysql/my.cnf
    - source: salt://mysql/{{ env }}.cnf  # æ ¹æ®ç¯å¢ƒé€‰æ‹©é…ç½®
    
{% if env == 'prod' %}
mysql_backup:
  cron.present:
    - name: mysqldump backup
    - minute: 0
    - hour: 2
{% endif %}
```

**åœºæ™¯2ï¼šæ‰¹é‡æ“ä½œ**
```yaml
# æ‰¹é‡å®‰è£…è½¯ä»¶åŒ…
{% set packages = ['nginx', 'mysql', 'php', 'redis'] %}

install_packages:
  pkg.installed:
    - names:
{% for pkg in packages %}
      - {{ pkg }}
{% endfor %}
```

**åœºæ™¯3ï¼šæ¡ä»¶é…ç½®**
```yaml
# æ ¹æ®ç³»ç»Ÿé…ç½®é˜²ç«å¢™
{% if grains['virtual'] == 'physical' %}
firewall:
  service.running:
    - name: ufw
    - enable: True
{% else %}
# è™šæ‹Ÿæœºç¯å¢ƒç¦ç”¨é˜²ç«å¢™
firewall:
  service.dead:
    - name: ufw
    - enable: False
{% endif %}
```

---

## 5. ğŸ”„ çŠ¶æ€ç¼–è¯‘è¿‡ç¨‹


### 5.1 çŠ¶æ€ç¼–è¯‘çš„å«ä¹‰


**çŠ¶æ€ç¼–è¯‘**ï¼šSaltå°†SLSæ–‡ä»¶è½¬æ¢ä¸ºå¯æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹ã€‚

```
ç¼–è¯‘è¿‡ç¨‹ç±»æ¯”ï¼š
SLSæ–‡ä»¶ï¼ˆæºä»£ç ï¼‰â†’ Saltè§£æå™¨ â†’ æ‰§è¡ŒæŒ‡ä»¤ï¼ˆæœºå™¨ç ï¼‰

å…·ä½“æ­¥éª¤ï¼š
â‘ è¯»å–SLSæ–‡ä»¶
â‘¡å¤„ç†Jinja2æ¨¡æ¿
â‘¢è§£æYAMLè¯­æ³•
â‘£ç”ŸæˆçŠ¶æ€æ•°æ®ç»“æ„
â‘¤æ£€æŸ¥ä¾èµ–å…³ç³»
â‘¥ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
```

### 5.2 ç¼–è¯‘è¿‡ç¨‹è¯¦è§£


**ğŸ”¸ ç¬¬ä¸€é˜¶æ®µï¼šæ–‡ä»¶è¯»å–**
```bash
# Salt Masterè¯»å–SLSæ–‡ä»¶
/srv/salt/webserver.sls â†’ Saltå†…å­˜
```

**ğŸ”¸ ç¬¬äºŒé˜¶æ®µï¼šæ¨¡æ¿æ¸²æŸ“**
```yaml
# ç¼–è¯‘å‰
server: {{ pillar['hostname'] }}

# ç¼–è¯‘åï¼ˆå‡è®¾pillar['hostname'] = 'web01'ï¼‰
server: web01
```

**ğŸ”¸ ç¬¬ä¸‰é˜¶æ®µï¼šYAMLè§£æ**
```yaml
# YAMLæ–‡æœ¬è½¬æ¢ä¸ºPythonæ•°æ®ç»“æ„
nginx:
  pkg.installed:
    - name: nginx

# è½¬æ¢ä¸ºï¼š
{
  'nginx': {
    'pkg.installed': [
      {'name': 'nginx'}
    ]
  }
}
```

### 5.3 ç¼–è¯‘é”™è¯¯æ’æŸ¥


**å¸¸è§ç¼–è¯‘é”™è¯¯**ï¼š

| é”™è¯¯ç±»å‹ | **ç—‡çŠ¶** | **è§£å†³æ–¹æ³•** |
|---------|---------|-------------|
| **YAMLè¯­æ³•é”™è¯¯** | `æ— æ³•è§£æSLSæ–‡ä»¶` | `æ£€æŸ¥ç¼©è¿›å’Œè¯­æ³•` |
| **Jinja2æ¨¡æ¿é”™è¯¯** | `æ¨¡æ¿æ¸²æŸ“å¤±è´¥` | `æ£€æŸ¥å˜é‡å’Œè¯­æ³•` |
| **ä¾èµ–å¾ªç¯** | `æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–` | `é‡æ–°è®¾è®¡ä¾èµ–å…³ç³»` |
| **çŠ¶æ€IDé‡å¤** | `é‡å¤çš„çŠ¶æ€ID` | `ç¡®ä¿æ¯ä¸ªIDå”¯ä¸€` |

**è°ƒè¯•å‘½ä»¤**ï¼š
```bash
# æµ‹è¯•çŠ¶æ€ç¼–è¯‘
salt 'minion' state.show_sls webserver

# æŸ¥çœ‹ç¼–è¯‘åçš„ä½çŠ¶æ€æ•°æ®
salt 'minion' state.show_low_sls webserver
```

---

## 6. ğŸš€ é«˜çŠ¶æ€æ‰§è¡Œæœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯é«˜çŠ¶æ€ï¼ˆHighstateï¼‰


**é«˜çŠ¶æ€**ï¼šSaltæ‰§è¡Œæ‰€æœ‰é€‚ç”¨äºminionçš„çŠ¶æ€æ–‡ä»¶çš„æœºåˆ¶ã€‚

```
é«˜çŠ¶æ€æ‰§è¡Œè¿‡ç¨‹ï¼š

â‘ ç¡®å®šç›®æ ‡minion
â‘¡æ”¶é›†æ‰€æœ‰é€‚ç”¨çš„SLSæ–‡ä»¶
â‘¢ç¼–è¯‘æ‰€æœ‰çŠ¶æ€
â‘£è§£æä¾èµ–å…³ç³»
â‘¤æŒ‰ä¾èµ–é¡ºåºæ‰§è¡Œ
â‘¥è¿”å›æ‰§è¡Œç»“æœ
```

### 6.2 Top Fileé…ç½®


**Top File** (`/srv/salt/top.sls`)ï¼šå†³å®šå“ªä¸ªminionæ‰§è¡Œå“ªäº›çŠ¶æ€ã€‚

```yaml
# /srv/salt/top.sls
base:                        # ç¯å¢ƒåç§°
  '*':                       # æ‰€æœ‰minion
    - common                 # æ‰§è¡Œcommon.sls
    
  'web*':                    # webå¼€å¤´çš„minion
    - webserver              # æ‰§è¡Œwebserver.sls
    - ssl                    # æ‰§è¡Œssl.sls
    
  'db*':                     # dbå¼€å¤´çš„minion
    - database               # æ‰§è¡Œdatabase.sls
    - backup                 # æ‰§è¡Œbackup.sls
    
  'roles:frontend':          # æ ¹æ®grainè§’è‰²åŒ¹é…
    - match: grain           # åŒ¹é…æ–¹å¼
    - nginx                  # æ‰§è¡Œnginx.sls
    - php                    # æ‰§è¡Œphp.sls
```

### 6.3 æ‰§è¡Œæ–¹å¼å¯¹æ¯”


```
çŠ¶æ€æ‰§è¡Œæ–¹å¼å¯¹æ¯”ï¼š

å•ä¸ªçŠ¶æ€æ‰§è¡Œï¼š
salt 'web01' state.sls nginx
â†“
åªæ‰§è¡Œnginx.slsæ–‡ä»¶

é«˜çŠ¶æ€æ‰§è¡Œï¼š
salt 'web01' state.highstate  
â†“
æ‰§è¡ŒTop Fileä¸­åŒ¹é…çš„æ‰€æœ‰çŠ¶æ€æ–‡ä»¶
```

### 6.4 é«˜çŠ¶æ€æ‰§è¡Œæµç¨‹å›¾


```
é«˜çŠ¶æ€æ‰§è¡Œæµç¨‹ï¼š

Masterç«¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯»å–Top File â”‚â”€â”€â”€â†’â”‚ åŒ¹é…Minion  â”‚â”€â”€â”€â†’â”‚ æ”¶é›†SLSæ–‡ä»¶ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ å‘é€ç»™Minion â”‚â†â”€â”€â”€â”‚ ç¼–è¯‘çŠ¶æ€    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Minionç«¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¥æ”¶çŠ¶æ€æ•°æ® â”‚â”€â”€â”€â†’â”‚ è§£æä¾èµ–å…³ç³» â”‚â”€â”€â”€â†’â”‚ æŒ‰åºæ‰§è¡ŒçŠ¶æ€ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ è¿”å›æ‰§è¡Œç»“æœ â”‚â†â”€â”€â”€â”‚ è®°å½•æ‰§è¡Œæ—¥å¿— â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. ğŸ” çŠ¶æ€æµ‹è¯•ä¸è°ƒè¯•


### 7.1 çŠ¶æ€æµ‹è¯•çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆè¦æµ‹è¯•**ï¼š
- é¿å…**ç”Ÿäº§ç¯å¢ƒé—®é¢˜**
- éªŒè¯**é…ç½®æ­£ç¡®æ€§**
- æå‰å‘ç°**ä¾èµ–é—®é¢˜**
- ç¡®ä¿**é¢„æœŸç»“æœ**

### 7.2 æµ‹è¯•å‘½ä»¤è¯¦è§£


**ğŸ”¸ dry-runæ¨¡å¼ï¼ˆæµ‹è¯•è¿è¡Œï¼‰**
```bash
# æµ‹è¯•çŠ¶æ€æ‰§è¡Œï¼Œä¸å®é™…æ›´æ”¹ç³»ç»Ÿ
salt 'web01' state.sls nginx test=True

# æµ‹è¯•é«˜çŠ¶æ€æ‰§è¡Œ
salt 'web01' state.highstate test=True
```

**è¾“å‡ºè§£æ**ï¼š
```yaml
# æµ‹è¯•ç»“æœç¤ºä¾‹
nginx:
  ----------
    Function: pkg.installed
        Name: nginx
      Result: None           # Noneè¡¨ç¤ºæµ‹è¯•æ¨¡å¼
     Comment: The following packages would be installed/updated: nginx
     Changes: {}            # æ˜¾ç¤ºå°†è¦è¿›è¡Œçš„æ›´æ”¹
```

**ğŸ”¸ çŠ¶æ€ç¼–è¯‘æµ‹è¯•**
```bash
# æŸ¥çœ‹çŠ¶æ€ç¼–è¯‘ç»“æœ
salt 'web01' state.show_sls nginx

# æŸ¥çœ‹é«˜çŠ¶æ€ç¼–è¯‘ç»“æœ  
salt 'web01' state.show_highstate

# æŸ¥çœ‹ä½çº§çŠ¶æ€æ•°æ®
salt 'web01' state.show_low_sls nginx
```

### 7.3 è°ƒè¯•æŠ€å·§


**ğŸ”¸ å¢åŠ è°ƒè¯•è¾“å‡º**
```yaml
debug_info:
  test.show_notification:
    - text: "å¼€å§‹å®‰è£…nginx"
    
nginx:
  pkg.installed:
    - name: nginx
    - require:
      - test: debug_info

debug_complete:
  test.show_notification:
    - text: "nginxå®‰è£…å®Œæˆ"
    - require:
      - pkg: nginx
```

**ğŸ”¸ åˆ†æ­¥æ‰§è¡Œè°ƒè¯•**
```bash
# åªæ‰§è¡Œç‰¹å®šçŠ¶æ€ID
salt 'web01' state.sls_id nginx webserver

# æ’é™¤æŸäº›çŠ¶æ€
salt 'web01' state.highstate exclude="problematic_state"
```

### 7.4 å¸¸è§é—®é¢˜æ’æŸ¥


**é—®é¢˜æ’æŸ¥æµç¨‹**ï¼š
```
â‘ æ£€æŸ¥è¯­æ³•é”™è¯¯ â†’ salt 'minion' state.show_sls statefile
â‘¡æµ‹è¯•æ¨¡å¼è¿è¡Œ â†’ salt 'minion' state.sls statefile test=True  
â‘¢æ£€æŸ¥ä¾èµ–å…³ç³» â†’ æŸ¥çœ‹çŠ¶æ€è¾“å‡ºä¸­çš„requireä¿¡æ¯
â‘£é€æ­¥æ‰§è¡Œ   â†’ salt 'minion' state.sls_id state_id statefile
â‘¤æŸ¥çœ‹æ—¥å¿—   â†’ /var/log/salt/minion
```

---

## 8. ğŸ”§ çŠ¶æ€æ¨¡å—æ‰©å±•


### 8.1 ä¸ºä»€ä¹ˆéœ€è¦æ‰©å±•æ¨¡å—


**æ‰©å±•æ¨¡å—çš„ä½œç”¨**ï¼š
- å†…ç½®æ¨¡å—**åŠŸèƒ½ä¸å¤Ÿ**æ—¶çš„è¡¥å……
- å®ç°**ç‰¹å®šä¸šåŠ¡éœ€æ±‚**
- é›†æˆ**ç¬¬ä¸‰æ–¹å·¥å…·**
- æä¾›**è‡ªå®šä¹‰åŠŸèƒ½**

### 8.2 è‡ªå®šä¹‰çŠ¶æ€æ¨¡å—ç»“æ„


**çŠ¶æ€æ¨¡å—ç›®å½•ç»“æ„**ï¼š
```
/srv/salt/_states/
â”œâ”€â”€ myapp.py              # è‡ªå®šä¹‰çŠ¶æ€æ¨¡å—
â””â”€â”€ __init__.py

/srv/salt/_modules/
â”œâ”€â”€ myapp.py              # æ‰§è¡Œæ¨¡å—ï¼ˆè¢«çŠ¶æ€æ¨¡å—è°ƒç”¨ï¼‰
â””â”€â”€ __init__.py
```

### 8.3 ç®€å•çŠ¶æ€æ¨¡å—ç¤ºä¾‹


**åˆ›å»ºè‡ªå®šä¹‰çŠ¶æ€æ¨¡å—**ï¼š
```python
# /srv/salt/_states/myapp.py
def installed(name, version=None):
    """
    ç¡®ä¿è‡ªå®šä¹‰åº”ç”¨å·²å®‰è£…
    """
    ret = {
        'name': name,
        'changes': {},
        'result': True,
        'comment': ''
    }
    
    # æ£€æŸ¥å½“å‰çŠ¶æ€
    current = __salt__['myapp.get_version'](name)
    
    if current is None:
        # åº”ç”¨æœªå®‰è£…ï¼Œéœ€è¦å®‰è£…
        if __opts__['test']:
            ret['result'] = None
            ret['comment'] = f'åº”ç”¨ {name} å°†è¢«å®‰è£…'
            return ret
            
        # æ‰§è¡Œå®‰è£…
        result = __salt__['myapp.install'](name, version)
        if result:
            ret['changes']['installed'] = name
            ret['comment'] = f'æˆåŠŸå®‰è£… {name}'
        else:
            ret['result'] = False
            ret['comment'] = f'å®‰è£… {name} å¤±è´¥'
    else:
        ret['comment'] = f'åº”ç”¨ {name} å·²ç»å®‰è£…'
    
    return ret
```

### 8.4 ä½¿ç”¨è‡ªå®šä¹‰çŠ¶æ€


```yaml
# åœ¨SLSæ–‡ä»¶ä¸­ä½¿ç”¨è‡ªå®šä¹‰çŠ¶æ€
my_application:
  myapp.installed:           # ä½¿ç”¨è‡ªå®šä¹‰çŠ¶æ€æ¨¡å—
    - name: myapp
    - version: 1.0.0
```

### 8.5 çŠ¶æ€æ¨¡å—æœ€ä½³å®è·µ


**ğŸ”¸ æ¨¡å—è®¾è®¡åŸåˆ™**
- **å¹‚ç­‰æ€§**ï¼šå¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´
- **å¯æµ‹è¯•**ï¼šæ”¯æŒtest=Trueæ¨¡å¼
- **é”™è¯¯å¤„ç†**ï¼šå¦¥å–„å¤„ç†å¼‚å¸¸æƒ…å†µ
- **æ¸…æ™°åé¦ˆ**ï¼šæä¾›æ˜ç¡®çš„æ‰§è¡Œç»“æœ

**ğŸ”¸ è¿”å›æ•°æ®æ ¼å¼**
```python
# æ ‡å‡†è¿”å›æ ¼å¼
ret = {
    'name': 'çŠ¶æ€åç§°',
    'changes': {},      # è¿›è¡Œçš„æ›´æ”¹
    'result': True,     # æ‰§è¡Œç»“æœï¼šTrue/False/None
    'comment': 'æè¿°ä¿¡æ¯'
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ SLSæ–‡ä»¶ï¼šSaltçŠ¶æ€é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨YAMLæ ¼å¼æè¿°ç³»ç»ŸæœŸæœ›çŠ¶æ€
ğŸ”¸ çŠ¶æ€å£°æ˜ï¼šé€šè¿‡"æ¨¡å—.å‡½æ•°"çš„æ–¹å¼å£°æ˜ç³»ç»Ÿç»„ä»¶åº”è¯¥çš„çŠ¶æ€
ğŸ”¸ ä¾èµ–å…³ç³»ï¼šä½¿ç”¨requireã€watchç­‰ç¡®ä¿çŠ¶æ€æŒ‰æ­£ç¡®é¡ºåºæ‰§è¡Œ
ğŸ”¸ Jinja2æ¨¡æ¿ï¼šè®©é…ç½®æ–‡ä»¶å¯ä»¥åŠ¨æ€ç”Ÿæˆï¼Œæ”¯æŒæ¡ä»¶ã€å¾ªç¯ç­‰
ğŸ”¸ é«˜çŠ¶æ€æœºåˆ¶ï¼šé€šè¿‡Top Fileç»Ÿä¸€ç®¡ç†å’Œæ‰§è¡Œæ‰€æœ‰ç›¸å…³çŠ¶æ€
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ çŠ¶æ€vså‘½ä»¤çš„åŒºåˆ«**
```
å‘½ä»¤æ¨¡å¼ï¼šå‘Šè¯‰ç³»ç»Ÿ"åšä»€ä¹ˆ"
- salt 'web01' cmd.run 'systemctl start nginx'

çŠ¶æ€æ¨¡å¼ï¼šå‘Šè¯‰ç³»ç»Ÿ"è¦ä»€ä¹ˆç»“æœ"  
- nginxæœåŠ¡è¦å¤„äºè¿è¡ŒçŠ¶æ€
- Saltè‡ªåŠ¨åˆ¤æ–­éœ€è¦åšä»€ä¹ˆæ“ä½œæ¥è¾¾åˆ°è¿™ä¸ªçŠ¶æ€
```

**ğŸ”¹ å¹‚ç­‰æ€§çš„é‡è¦æ€§**
```
å¹‚ç­‰æ€§ï¼šå¤šæ¬¡æ‰§è¡ŒåŒä¸€çŠ¶æ€ï¼Œç»“æœä¿æŒä¸€è‡´

å¥½å¤„ï¼š
- å¯ä»¥æ”¾å¿ƒé‡å¤æ‰§è¡Œ
- ç³»ç»Ÿé…ç½®å§‹ç»ˆä¿æŒæœŸæœ›çŠ¶æ€
- é¿å…é‡å¤æ“ä½œå¸¦æ¥çš„é—®é¢˜
```

**ğŸ”¹ ä¾èµ–å…³ç³»çš„ä½œç”¨**
```
ä½œç”¨ï¼šç¡®ä¿æ“ä½œæŒ‰æ­£ç¡®é¡ºåºè¿›è¡Œ

ç±»æ¯”ï¼šåšé¥­çš„æ­¥éª¤
- å…ˆä¹°èœï¼ˆpkg.installedï¼‰
- å†æ´—èœï¼ˆfile.managedï¼‰  
- æœ€åç‚’èœï¼ˆservice.runningï¼‰

å¦‚æœé¡ºåºé”™ä¹±ï¼Œç»“æœå¿…ç„¶æœ‰é—®é¢˜
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ SLSæ–‡ä»¶ç»„ç»‡å»ºè®®**
```
/srv/salt/
â”œâ”€â”€ top.sls              # æ€»å…¥å£æ–‡ä»¶
â”œâ”€â”€ common/              # é€šç”¨é…ç½®
â”‚   â”œâ”€â”€ init.sls
â”‚   â””â”€â”€ users.sls
â”œâ”€â”€ webserver/           # WebæœåŠ¡å™¨é…ç½®
â”‚   â”œâ”€â”€ init.sls
â”‚   â”œâ”€â”€ nginx.sls
â”‚   â””â”€â”€ ssl.sls
â””â”€â”€ database/            # æ•°æ®åº“é…ç½®
    â”œâ”€â”€ init.sls
    â””â”€â”€ mysql.sls
```

**ğŸ”§ è°ƒè¯•æµç¨‹å»ºè®®**
```
å¼€å‘çŠ¶æ€æ—¶çš„æ ‡å‡†æµç¨‹ï¼š

â‘ ç¼–å†™SLSæ–‡ä»¶
â‘¡è¯­æ³•æ£€æŸ¥ï¼šsalt 'minion' state.show_sls statefile
â‘¢æµ‹è¯•è¿è¡Œï¼šsalt 'minion' state.sls statefile test=True
â‘£å®é™…æ‰§è¡Œï¼šsalt 'minion' state.sls statefile
â‘¤éªŒè¯ç»“æœï¼šæ£€æŸ¥ç³»ç»ŸçŠ¶æ€æ˜¯å¦ç¬¦åˆæœŸæœ›
```

**âš ï¸ å¸¸è§è¯¯åŒºé¿å…**
```
è¯¯åŒº1ï¼šæŠŠçŠ¶æ€å½“æˆè„šæœ¬æ¥å†™
æ­£ç¡®ï¼šçŠ¶æ€æè¿°æœŸæœ›ç»“æœï¼Œä¸æ˜¯æ“ä½œæ­¥éª¤

è¯¯åŒº2ï¼šä¸è€ƒè™‘ä¾èµ–å…³ç³»
æ­£ç¡®ï¼šä»”ç»†è®¾è®¡çŠ¶æ€é—´çš„ä¾èµ–å…³ç³»

è¯¯åŒº3ï¼šä¸æµ‹è¯•ç›´æ¥ä¸Šç”Ÿäº§
æ­£ç¡®ï¼šå…ˆç”¨test=Trueæµ‹è¯•ï¼Œç¡®è®¤æ— è¯¯å†æ‰§è¡Œ

è¯¯åŒº4ï¼šçŠ¶æ€æ–‡ä»¶è¿‡äºå¤æ‚
æ­£ç¡®ï¼šåˆç†æ‹†åˆ†ï¼Œæ¯ä¸ªæ–‡ä»¶èŒè´£å•ä¸€
```

### 9.4 å­¦ä¹ è¿›é˜¶å»ºè®®


**ğŸš€ è¿›é˜¶å­¦ä¹ è·¯å¾„**
1. **æŒæ¡åŸºç¡€è¯­æ³•** - YAML + Jinja2æ¨¡æ¿
2. **ç†è§£æ ¸å¿ƒæ¦‚å¿µ** - çŠ¶æ€ã€ä¾èµ–ã€å¹‚ç­‰æ€§
3. **ç†Ÿç»ƒå¸¸ç”¨æ¨¡å—** - pkgã€serviceã€fileç­‰
4. **è®¾è®¡çŠ¶æ€æ¶æ„** - åˆç†çš„æ–‡ä»¶ç»„ç»‡å’Œä¾èµ–è®¾è®¡
5. **å¼€å‘è‡ªå®šä¹‰æ¨¡å—** - æ‰©å±•SaltåŠŸèƒ½æ»¡è¶³ç‰¹å®šéœ€æ±‚

**æ ¸å¿ƒè®°å¿†**ï¼š
- SaltçŠ¶æ€ç®¡ç†æ˜¯æè¿°æœŸæœ›ç»“æœï¼Œä¸æ˜¯æ‰§è¡Œæ­¥éª¤
- ä¾èµ–å…³ç³»ç¡®ä¿æ“ä½œé¡ºåºï¼Œå¹‚ç­‰æ€§ä¿è¯ç»“æœä¸€è‡´  
- æµ‹è¯•æ˜¯å¿…é¡»çš„ï¼Œå…ˆtest=Trueå†å®é™…æ‰§è¡Œ
- æ¨¡å—åŒ–ç»„ç»‡é…ç½®æ–‡ä»¶ï¼ŒèŒè´£åˆ†ç¦»ä¾¿äºç»´æŠ¤