---
title: 17ã€Salt-Pillaræ•°æ®ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [Pillaræ•°æ®ç»“æ„è®¾è®¡](#1-Pillaræ•°æ®ç»“æ„è®¾è®¡)
2. [æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨](#2-æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨)
3. [æ•°æ®ç»§æ‰¿ä¸è¦†ç›–](#3-æ•°æ®ç»§æ‰¿ä¸è¦†ç›–)
4. [å¤–éƒ¨Pillarç³»ç»Ÿé›†æˆ](#4-å¤–éƒ¨Pillarç³»ç»Ÿé›†æˆ)
5. [åŠ¨æ€Pillaræ•°æ®](#5-åŠ¨æ€Pillaræ•°æ®)
6. [æ•°æ®éªŒè¯æœºåˆ¶](#6-æ•°æ®éªŒè¯æœºåˆ¶)
7. [Pillarç¼“å­˜ç®¡ç†](#7-Pillarç¼“å­˜ç®¡ç†)
8. [å®‰å…¨è®¿é—®æ§åˆ¶](#8-å®‰å…¨è®¿é—®æ§åˆ¶)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“Š Pillaræ•°æ®ç»“æ„è®¾è®¡


### 1.1 ä»€ä¹ˆæ˜¯Pillaræ•°æ®


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
Pillaræ˜¯SaltStackä¸­çš„**æ•°æ®å­˜å‚¨ç³»ç»Ÿ**ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªä¸“é—¨å­˜æ”¾**é…ç½®æ•°æ®**å’Œ**æ•æ„Ÿä¿¡æ¯**çš„åœ°æ–¹ã€‚

```
ç®€å•ç±»æ¯”ï¼š
Pillarå°±åƒæ˜¯ä¸€ä¸ªé«˜çº§ä¿é™©ç®±ï¼Œé‡Œé¢åˆ†é—¨åˆ«ç±»å­˜æ”¾ç€ï¼š
â€¢ æœåŠ¡å™¨é…ç½®å‚æ•°
â€¢ æ•°æ®åº“å¯†ç 
â€¢ APIå¯†é’¥
â€¢ ç”¨æˆ·ä¿¡æ¯
â€¢ ç¯å¢ƒå˜é‡

æ¯ä¸ªMinionåªèƒ½çœ‹åˆ°å±äºè‡ªå·±çš„é‚£éƒ¨åˆ†æ•°æ®
```

**ğŸ’¡ Pillar vs GrainsåŒºåˆ«**
```
Grainsï¼ˆç³»ç»Ÿä¿¡æ¯ï¼‰ï¼š
â€¢ ç”±Minionè‡ªåŠ¨æ”¶é›†
â€¢ ç³»ç»Ÿç¡¬ä»¶ã€OSç‰ˆæœ¬ç­‰å›ºæœ‰ä¿¡æ¯
â€¢ åªè¯»ï¼Œä¸èƒ½ä¿®æ”¹

Pillarï¼ˆé…ç½®æ•°æ®ï¼‰ï¼š
â€¢ ç”±Masterä¸»åŠ¨åˆ†å‘
â€¢ é…ç½®å‚æ•°ã€å¯†ç ç­‰å¯å˜ä¿¡æ¯
â€¢ Masteræ§åˆ¶ï¼Œå®‰å…¨å¯é 
```

### 1.2 Pillaræ–‡ä»¶ç»“æ„è®¾è®¡


**ğŸ—ï¸ ç›®å½•ç»„ç»‡ç»“æ„**
```
/srv/pillar/
â”œâ”€â”€ top.sls              # å…¥å£æ–‡ä»¶ï¼Œå®šä¹‰å“ªäº›ä¸»æœºç”¨å“ªäº›é…ç½®
â”œâ”€â”€ common/              # é€šç”¨é…ç½®
â”‚   â”œâ”€â”€ init.sls
â”‚   â”œâ”€â”€ users.sls
â”‚   â””â”€â”€ timezone.sls
â”œâ”€â”€ environments/        # ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ dev.sls
â”‚   â”œâ”€â”€ test.sls
â”‚   â””â”€â”€ prod.sls
â”œâ”€â”€ services/           # æœåŠ¡é…ç½®
â”‚   â”œâ”€â”€ database.sls
â”‚   â”œâ”€â”€ webserver.sls
â”‚   â””â”€â”€ cache.sls
â””â”€â”€ secrets/            # æ•æ„Ÿæ•°æ®
    â”œâ”€â”€ passwords.sls
    â””â”€â”€ certificates.sls
```

**ğŸ“ top.slsé…ç½®ç¤ºä¾‹**
```yaml
base:
  # æ‰€æœ‰ä¸»æœºéƒ½è·å–é€šç”¨é…ç½®
  '*':
    - common

  # WebæœåŠ¡å™¨è·å–Webé…ç½®
  'web*':
    - services.webserver
    - environments.prod

  # æ•°æ®åº“æœåŠ¡å™¨è·å–æ•°æ®åº“é…ç½®
  'db*':
    - services.database
    - secrets.passwords

  # å¼€å‘ç¯å¢ƒçš„ç‰¹æ®Šé…ç½®
  'dev*':
    - environments.dev
    - common.users
```

### 1.3 æ•°æ®ç»“æ„è®¾è®¡æœ€ä½³å®è·µ


**ğŸ¯ å±‚æ¬¡åŒ–è®¾è®¡åŸåˆ™**
```yaml
# /srv/pillar/services/webserver.sls
nginx:
  # åŸºç¡€é…ç½®
  config:
    worker_processes: 4
    worker_connections: 1024
    
  # è™šæ‹Ÿä¸»æœºé…ç½®
  sites:
    default:
      server_name: www.example.com
      root: /var/www/html
      
    api:
      server_name: api.example.com
      root: /var/www/api
      ssl: true
      
  # æ¨¡å—é…ç½®
  modules:
    - ssl
    - gzip
    - rewrite

# ä½¿ç”¨æ—¶åœ¨Stateæ–‡ä»¶ä¸­å¼•ç”¨
{% set nginx = pillar.get('nginx', {}) %}
{% set sites = nginx.get('sites', {}) %}
```

**ğŸ” æ•°æ®ç±»å‹è§„èŒƒ**
```yaml
# å­—ç¬¦ä¸²ç±»å‹
database_host: "192.168.1.100"

# æ•°å­—ç±»å‹
database_port: 3306
max_connections: 100

# å¸ƒå°”ç±»å‹
ssl_enabled: true
debug_mode: false

# åˆ—è¡¨ç±»å‹
allowed_ips:
  - 192.168.1.0/24
  - 10.0.0.0/8

# å­—å…¸ç±»å‹
database:
  host: "192.168.1.100"
  port: 3306
  name: "myapp"
  user: "appuser"
```

---

## 2. ğŸ” æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨


### 2.1 ä¸ºä»€ä¹ˆéœ€è¦åŠ å¯†å­˜å‚¨


**âš ï¸ æ•æ„Ÿæ•°æ®é£é™©**
```
æœªåŠ å¯†å­˜å‚¨çš„é—®é¢˜ï¼š
â€¢ å¯†ç æ˜æ–‡å­˜åœ¨é…ç½®æ–‡ä»¶ä¸­
â€¢ ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­æ³„éœ²æ•æ„Ÿä¿¡æ¯
â€¢ ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥ç›´æ¥æŸ¥çœ‹æ‰€æœ‰å¯†ç 
â€¢ é…ç½®æ–‡ä»¶å¤‡ä»½æ—¶æš´éœ²æ•æ„Ÿæ•°æ®

åŠ å¯†å­˜å‚¨çš„å¥½å¤„ï¼š
â€¢ å³ä½¿é…ç½®æ–‡ä»¶æ³„éœ²ï¼Œå¯†ç ä»ç„¶å®‰å…¨
â€¢ ç¬¦åˆå®‰å…¨åˆè§„è¦æ±‚
â€¢ èŒè´£åˆ†ç¦»ï¼Œä¸åŒäººå‘˜çœ‹åˆ°ä¸åŒçº§åˆ«çš„ä¿¡æ¯
```

### 2.2 GPGåŠ å¯†é…ç½®


**ğŸ”§ GPGå¯†é’¥ç”Ÿæˆä¸é…ç½®**
```bash
# 1. ç”ŸæˆGPGå¯†é’¥å¯¹
gpg --gen-key

# 2. å¯¼å‡ºå…¬é’¥ç»™éœ€è¦åŠ å¯†æ•°æ®çš„ç”¨æˆ·
gpg --export -a "Salt Master" > salt-master-public.key

# 3. åœ¨Masteré…ç½®ä¸­å¯ç”¨GPG
# /etc/salt/master
gpg_keydir: /etc/salt/gpgkeys
```

**ğŸ”’ åŠ å¯†æ•æ„Ÿæ•°æ®**
```bash
# åŠ å¯†å¯†ç 
echo -n "MySecretPassword123" | gpg --armor --encrypt -r "Salt Master"

# ç»“æœç±»ä¼¼ï¼š
-----BEGIN PGP MESSAGE-----
Version: GnuPG v2.0.22

hQEMA5qETcqr2NeaAQgA4KO7pQZBTlX8...
-----END PGP MESSAGE-----
```

**ğŸ“ åœ¨Pillarä¸­ä½¿ç”¨åŠ å¯†æ•°æ®**
```yaml
# /srv/pillar/secrets/database.sls
database_password: |
  -----BEGIN PGP MESSAGE-----
  Version: GnuPG v2.0.22
  
  hQEMA5qETcqr2NeaAQgA4KO7pQZBTlX8GkzDgFHRvJO8/V6Nw7QO...
  -----END PGP MESSAGE-----

# åœ¨Stateä¸­è§£å¯†ä½¿ç”¨
mysql_user:
  mysql_user.present:
    - name: appuser
    - password: {{ pillar['database_password'] }}
```

### 2.3 ä½¿ç”¨Saltçš„å†…ç½®åŠ å¯†


**ğŸ” ä½¿ç”¨pillar.geté…åˆé»˜è®¤å€¼**
```yaml
# Pillaræ–‡ä»¶
secrets:
  api_key: "encrypted_api_key_here"
  db_password: "encrypted_password_here"

# Stateæ–‡ä»¶ä¸­å®‰å…¨è·å–
{% set api_key = salt['pillar.get']('secrets:api_key', 'default_fallback') %}
```

---

## 3. ğŸ”„ æ•°æ®ç»§æ‰¿ä¸è¦†ç›–


### 3.1 ç»§æ‰¿æœºåˆ¶åŸç†


**ğŸ—ï¸ ç»§æ‰¿å…³ç³»å›¾**
```
               åŸºç¡€é…ç½®(base)
                     â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                 â”‚
        ç¯å¢ƒé…ç½®(env)     æœåŠ¡é…ç½®(service)
            â”‚                 â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
               æœ€ç»ˆé…ç½®(final)
```

**ğŸ’¡ ç»§æ‰¿ä¼˜å…ˆçº§è§„åˆ™**
```
ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š
1. å…·ä½“ä¸»æœºé…ç½®      (web01.example.com)
2. ä¸»æœºç»„é…ç½®        (webservers)
3. ç¯å¢ƒé…ç½®          (production)
4. æœåŠ¡é…ç½®          (nginx)
5. åŸºç¡€é…ç½®          (common)

åé¢çš„é…ç½®ä¼šè¦†ç›–å‰é¢çš„é…ç½®
```

### 3.2 å®é™…ç»§æ‰¿é…ç½®ç¤ºä¾‹


**ğŸ“‹ åŸºç¡€é…ç½®å®šä¹‰**
```yaml
# /srv/pillar/common/init.sls
app:
  name: "MyApp"
  version: "1.0.0"
  debug: false
  log_level: "INFO"
  
  database:
    host: "localhost"
    port: 3306
    pool_size: 10
```

**ğŸŒ ç¯å¢ƒç‰¹å®šé…ç½®**
```yaml
# /srv/pillar/environments/dev.sls
app:
  debug: true           # è¦†ç›–åŸºç¡€é…ç½®çš„false
  log_level: "DEBUG"    # è¦†ç›–åŸºç¡€é…ç½®çš„INFO
  
  database:
    host: "dev-db.internal"  # è¦†ç›–localhost
    # portå’Œpool_sizeç»§æ‰¿åŸºç¡€é…ç½®
```

**ğŸ¯ ä¸»æœºç‰¹å®šé…ç½®**
```yaml
# /srv/pillar/hosts/web01.sls  
app:
  database:
    pool_size: 20     # è¯¥ä¸»æœºéœ€è¦æ›´å¤§çš„è¿æ¥æ± 
    # å…¶ä»–é…ç½®ç»§æ‰¿ä¸Šå±‚
```

**ğŸ“Š æœ€ç»ˆç”Ÿæ•ˆé…ç½®å±•ç¤º**
```yaml
# web01ä¸»æœºæœ€ç»ˆçœ‹åˆ°çš„é…ç½®ï¼š
app:
  name: "MyApp"              # æ¥è‡ªåŸºç¡€é…ç½®
  version: "1.0.0"           # æ¥è‡ªåŸºç¡€é…ç½®
  debug: true                # æ¥è‡ªç¯å¢ƒé…ç½®ï¼ˆè¦†ç›–äº†åŸºç¡€é…ç½®ï¼‰
  log_level: "DEBUG"         # æ¥è‡ªç¯å¢ƒé…ç½®ï¼ˆè¦†ç›–äº†åŸºç¡€é…ç½®ï¼‰
  
  database:
    host: "dev-db.internal"  # æ¥è‡ªç¯å¢ƒé…ç½®ï¼ˆè¦†ç›–äº†åŸºç¡€é…ç½®ï¼‰
    port: 3306               # æ¥è‡ªåŸºç¡€é…ç½®ï¼ˆç»§æ‰¿ï¼‰
    pool_size: 20            # æ¥è‡ªä¸»æœºé…ç½®ï¼ˆè¦†ç›–äº†åŸºç¡€é…ç½®ï¼‰
```

### 3.3 è¦†ç›–ç­–ç•¥æ§åˆ¶


**ğŸ”§ å­—å…¸åˆå¹¶ç­–ç•¥**
```yaml
# é»˜è®¤æ˜¯é€’å½’åˆå¹¶ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ§åˆ¶
# /etc/salt/master
pillar_merge_lists: false    # åˆ—è¡¨æ˜¯å¦åˆå¹¶
pillar_opts: true           # æ˜¯å¦åŒ…å«masteré…ç½®
```

**ğŸ“ å®é™…åº”ç”¨åœºæ™¯**
```yaml
# ç”Ÿäº§ç¯å¢ƒéœ€è¦ä¸¥æ ¼çš„å®‰å…¨é…ç½®
production:
  app:
    security:
      ssl_only: true
      csrf_protection: true
      
# å¼€å‘ç¯å¢ƒå¯ä»¥æ”¾æ¾ä¸€äº›é™åˆ¶  
development:
  app:
    security:
      ssl_only: false      # å¼€å‘æ—¶å¯ä»¥ä¸ç”¨HTTPS
      debug_toolbar: true   # å¼€å‘æ—¶æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
```

---

## 4. ğŸ”Œ å¤–éƒ¨Pillarç³»ç»Ÿé›†æˆ


### 4.1 æ”¯æŒçš„å¤–éƒ¨ç³»ç»Ÿ


**ğŸ—„ï¸ æ•°æ®åº“é›†æˆ**
```yaml
# /etc/salt/masteré…ç½®
ext_pillar:
  - mysql:
      host: db.example.com
      user: salt
      password: saltpass
      database: saltdb
      query: "SELECT pillar_key, pillar_value FROM pillars WHERE minion_id = %s"
```

**â˜ï¸ äº‘æœåŠ¡é›†æˆ**
```yaml
# AWS Parameter Storeé›†æˆ
ext_pillar:
  - aws_parameter:
      region: us-east-1
      access_key_id: AKIA...
      secret_access_key: secret...
      parameter_prefix: /myapp/
```

**ğŸ”‘ Vaulté›†æˆ**
```yaml
# HashiCorp Vaulté›†æˆ
ext_pillar:
  - vault:
      url: https://vault.example.com:8200
      auth_method: token
      token: hvs.CAESIJlWh...
      path: secret/myapp
```

### 4.2 å®é™…é›†æˆé…ç½®


**ğŸ¯ å¤šæ•°æ®æºé…ç½®**
```yaml
# /etc/salt/master
ext_pillar:
  # æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
  - file_tree:
      root_dir: /srv/pillar
      follow_dir_links: false
      
  # æ•°æ®åº“ä¸­çš„é…ç½®
  - mysql:
      host: config-db.internal
      user: saltconfig
      database: configurations
      query: "SELECT config_key, config_value FROM host_configs WHERE hostname = %s"
      
  # å¤–éƒ¨é…ç½®ç®¡ç†ç³»ç»Ÿ
  - http_json:
      url: https://config-api.example.com/pillar/%s
      headers:
        Authorization: "Bearer {{token}}"
```

**ğŸ“Š æ•°æ®æºä¼˜å…ˆçº§ç®¡ç†**
```
æ•°æ®åˆå¹¶é¡ºåºï¼ˆä»ä½åˆ°é«˜ï¼‰ï¼š
1. å¤–éƒ¨HTTP API
2. æ•°æ®åº“é…ç½®  
3. æœ¬åœ°Pillaræ–‡ä»¶
4. å‘½ä»¤è¡Œå‚æ•°

åé¢çš„æ•°æ®ä¼šè¦†ç›–å‰é¢çš„æ•°æ®
```

### 4.3 è‡ªå®šä¹‰å¤–éƒ¨Pillaræ¨¡å—


**ğŸ› ï¸ åˆ›å»ºè‡ªå®šä¹‰Pillaræ¨¡å—**
```python
# /srv/salt/_pillar/custom_config.py
def ext_pillar(minion_id, pillar, **kwargs):
    """
    ä»è‡ªå®šä¹‰ç³»ç»Ÿè·å–Pillaræ•°æ®
    """
    import requests
    
    # ä»å¤–éƒ¨APIè·å–é…ç½®
    try:
        response = requests.get(f'https://config-api.com/hosts/{minion_id}')
        if response.status_code == 200:
            return response.json()
    except Exception as e:
        # è¿”å›é»˜è®¤é…ç½®
        return {'error': str(e)}
    
    return {}
```

---

## 5. âš¡ åŠ¨æ€Pillaræ•°æ®


### 5.1 ä»€ä¹ˆæ˜¯åŠ¨æ€Pillar


**ğŸ”„ é™æ€ vs åŠ¨æ€å¯¹æ¯”**
```
é™æ€Pillarï¼š
â€¢ é…ç½®å†™æ­»åœ¨æ–‡ä»¶ä¸­
â€¢ éœ€è¦æ‰‹åŠ¨ä¿®æ”¹æ–‡ä»¶
â€¢ é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆ

åŠ¨æ€Pillarï¼š
â€¢ æ ¹æ®æ¡ä»¶è‡ªåŠ¨ç”Ÿæˆé…ç½®
â€¢ å®æ—¶è®¡ç®—é…ç½®å€¼
â€¢ è‡ªåŠ¨é€‚åº”ç¯å¢ƒå˜åŒ–
```

### 5.2 åŸºäºæ¡ä»¶çš„åŠ¨æ€é…ç½®


**ğŸ¯ æ ¹æ®ä¸»æœºè§’è‰²åŠ¨æ€é…ç½®**
```yaml
# /srv/pillar/dynamic/roles.sls
{% if grains['roles'] is defined %}
  {% if 'database' in grains['roles'] %}
database:
  max_connections: {{ grains['num_cpus'] * 50 }}
  buffer_pool_size: "{{ (grains['mem_total'] * 0.7) | int }}M"
  
  {% elif 'webserver' in grains['roles'] %}
nginx:
  worker_processes: {{ grains['num_cpus'] }}
  worker_connections: {{ grains['num_cpus'] * 1024 }}
  
  {% endif %}
{% endif %}
```

**ğŸ“Š åŸºäºèµ„æºçš„åŠ¨æ€è°ƒä¼˜**
```yaml
# æ ¹æ®å†…å­˜å¤§å°åŠ¨æ€é…ç½®
{% set mem_gb = (grains['mem_total'] / 1024) | int %}

{% if mem_gb < 2 %}
  # å°å†…å­˜æœåŠ¡å™¨é…ç½®
  app:
    max_workers: 2
    cache_size: "128M"
    
{% elif mem_gb < 8 %}
  # ä¸­ç­‰å†…å­˜æœåŠ¡å™¨é…ç½®  
  app:
    max_workers: 4
    cache_size: "512M"
    
{% else %}
  # å¤§å†…å­˜æœåŠ¡å™¨é…ç½®
  app:
    max_workers: 8
    cache_size: "2G"
{% endif %}
```

### 5.3 å®æ—¶æ•°æ®æºé›†æˆ


**â° æ—¶é—´ç›¸å…³çš„åŠ¨æ€é…ç½®**
```yaml
# åŸºäºå½“å‰æ—¶é—´çš„é…ç½®
{% set current_hour = salt['cmd.run']('date +%H') | int %}

maintenance:
  {% if current_hour >= 2 and current_hour <= 4 %}
  mode: true              # å‡Œæ™¨2-4ç‚¹ç»´æŠ¤æ¨¡å¼
  {% else %}
  mode: false
  {% endif %}
  
backup:
  schedule: 
    {% if current_hour == 23 %}
    - "full_backup"       # 23ç‚¹åšå…¨é‡å¤‡ä»½
    {% else %}
    - "incremental"       # å…¶ä»–æ—¶é—´å¢é‡å¤‡ä»½
    {% endif %}
```

**ğŸŒ åŸºäºå¤–éƒ¨APIçš„åŠ¨æ€é…ç½®**
```yaml
# ä»ç›‘æ§ç³»ç»Ÿè·å–å½“å‰è´Ÿè½½
{% set current_load = salt['http.query']('http://monitor.internal/api/load/' + grains['id'], decode=true) %}

{% if current_load['dict']['cpu_usage'] > 80 %}
performance:
  cpu_limit: "2.0"        # é«˜è´Ÿè½½æ—¶é™åˆ¶CPUä½¿ç”¨
  priority: "high"
{% else %}
performance:
  cpu_limit: "4.0"        # æ­£å¸¸è´Ÿè½½æ—¶å¯ä»¥ä½¿ç”¨æ›´å¤šCPU
  priority: "normal"
{% endif %}
```

---

## 6. âœ… æ•°æ®éªŒè¯æœºåˆ¶


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®éªŒè¯


**âš ï¸ æ— éªŒè¯çš„é£é™©**
```
å¸¸è§é—®é¢˜ï¼š
â€¢ é…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£å·å†™æˆäº†å­—ç¬¦ä¸²
â€¢ å¿…å¡«å­—æ®µè¢«é—æ¼
â€¢ IPåœ°å€æ ¼å¼é”™è¯¯
â€¢ å¯†ç ä¸ç¬¦åˆå¤æ‚åº¦è¦æ±‚
â€¢ é…ç½®å€¼è¶…å‡ºåˆç†èŒƒå›´

åæœï¼š
â€¢ æœåŠ¡å¯åŠ¨å¤±è´¥
â€¢ å®‰å…¨æ¼æ´
â€¢ æ€§èƒ½é—®é¢˜
â€¢ éš¾ä»¥æ’æŸ¥çš„é”™è¯¯
```

### 6.2 åŸºç¡€æ•°æ®éªŒè¯


**ğŸ“‹ ç±»å‹éªŒè¯**
```yaml
# /srv/pillar/validation/database.sls
{% set db_port = pillar.get('database:port', 3306) %}
{% if db_port is not number or db_port < 1 or db_port > 65535 %}
  {{ raise('æ•°æ®åº“ç«¯å£å¿…é¡»æ˜¯1-65535ä¹‹é—´çš„æ•°å­—') }}
{% endif %}

database:
  host: {{ pillar.get('database:host', 'localhost') }}
  port: {{ db_port }}
  name: {{ pillar.get('database:name') or raise('æ•°æ®åº“åç§°ä¸èƒ½ä¸ºç©º') }}
```

**ğŸ” æ ¼å¼éªŒè¯**
```yaml
# IPåœ°å€æ ¼å¼éªŒè¯
{% set server_ip = pillar.get('server:ip') %}
{% if server_ip %}
  {% set ip_parts = server_ip.split('.') %}
  {% if ip_parts | length != 4 %}
    {{ raise('IPåœ°å€æ ¼å¼é”™è¯¯: ' + server_ip) }}
  {% endif %}
  
  {% for part in ip_parts %}
    {% if part | int < 0 or part | int > 255 %}
      {{ raise('IPåœ°å€æ•°å€¼è¶…å‡ºèŒƒå›´: ' + server_ip) }}
    {% endif %}
  {% endfor %}
{% endif %}
```

### 6.3 å¤æ‚ä¸šåŠ¡é€»è¾‘éªŒè¯


**ğŸ¯ ä¾èµ–å…³ç³»éªŒè¯**
```yaml
# éªŒè¯SSLé…ç½®çš„å®Œæ•´æ€§
{% if pillar.get('nginx:ssl:enabled', false) %}
  {% set cert_file = pillar.get('nginx:ssl:cert_file') %}
  {% set key_file = pillar.get('nginx:ssl:key_file') %}
  
  {% if not cert_file or not key_file %}
    {{ raise('å¯ç”¨SSLæ—¶å¿…é¡»æä¾›è¯ä¹¦æ–‡ä»¶å’Œå¯†é’¥æ–‡ä»¶') }}
  {% endif %}
  
  # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  {% if not salt['file.file_exists'](cert_file) %}
    {{ raise('SSLè¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨: ' + cert_file) }}
  {% endif %}
  
  {% if not salt['file.file_exists'](key_file) %}
    {{ raise('SSLå¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: ' + key_file) }}
  {% endif %}
{% endif %}
```

**ğŸ“Š é…ç½®åˆç†æ€§éªŒè¯**
```yaml
# èµ„æºé…ç½®åˆç†æ€§æ£€æŸ¥
{% set max_workers = pillar.get('app:max_workers', 4) %}
{% set available_cpus = grains.get('num_cpus', 1) %}

{% if max_workers > available_cpus * 2 %}
è­¦å‘Šæç¤º: |
  é…ç½®çš„å·¥ä½œè¿›ç¨‹æ•°({{ max_workers }})è¶…è¿‡äº†CPUæ ¸å¿ƒæ•°çš„2å€({{ available_cpus * 2 }})
  è¿™å¯èƒ½å¯¼è‡´ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ï¼Œå»ºè®®è°ƒæ•´ä¸º: {{ available_cpus * 2 }}
{% endif %}
```

### 6.4 è‡ªå®šä¹‰éªŒè¯å‡½æ•°


**ğŸ› ï¸ åˆ›å»ºéªŒè¯å·¥å…·**
```python
# /srv/salt/_modules/pillar_validator.py
def validate_database_config(pillar_data):
    """éªŒè¯æ•°æ®åº“é…ç½®"""
    errors = []
    
    db_config = pillar_data.get('database', {})
    
    # æ£€æŸ¥å¿…å¡«å­—æ®µ
    required_fields = ['host', 'port', 'name', 'user']
    for field in required_fields:
        if field not in db_config:
            errors.append(f'æ•°æ®åº“é…ç½®ç¼ºå°‘å¿…å¡«å­—æ®µ: {field}')
    
    # æ£€æŸ¥ç«¯å£èŒƒå›´
    port = db_config.get('port', 0)
    if not (1 <= port <= 65535):
        errors.append(f'æ•°æ®åº“ç«¯å£æ— æ•ˆ: {port}')
    
    return {'valid': len(errors) == 0, 'errors': errors}
```

---

## 7. ğŸ’¾ Pillarç¼“å­˜ç®¡ç†


### 7.1 ç¼“å­˜æœºåˆ¶åŸç†


**ğŸ”„ ç¼“å­˜å·¥ä½œæµç¨‹**
```
1. Minionè¯·æ±‚Pillaræ•°æ®
   â†“
2. Masteræ£€æŸ¥ç¼“å­˜
   â†“ (ç¼“å­˜æœªå‘½ä¸­)
3. é‡æ–°ç¼–è¯‘Pillaræ•°æ®
   â†“
4. å­˜å‚¨åˆ°ç¼“å­˜
   â†“
5. è¿”å›ç»™Minion
   â†“
6. Minionæœ¬åœ°ç¼“å­˜æ•°æ®
```

**ğŸ“Š ç¼“å­˜å±‚çº§ç»“æ„**
```
Masterç«¯ç¼“å­˜ï¼š
â”œâ”€â”€ ç¼–è¯‘åçš„Pillaræ•°æ®
â”œâ”€â”€ å¤–éƒ¨æ•°æ®æºç¼“å­˜
â””â”€â”€ æ¨¡æ¿æ¸²æŸ“ç»“æœ

Minionç«¯ç¼“å­˜ï¼š
â”œâ”€â”€ æ¥æ”¶åˆ°çš„Pillaræ•°æ®
â”œâ”€â”€ Grainsä¿¡æ¯
â””â”€â”€ æ¨¡å—æ‰§è¡Œç»“æœ
```

### 7.2 Masterç«¯ç¼“å­˜é…ç½®


**ğŸ”§ åŸºç¡€ç¼“å­˜é…ç½®**
```yaml
# /etc/salt/master
pillar_cache: true                    # å¯ç”¨Pillarç¼“å­˜
pillar_cache_ttl: 3600               # ç¼“å­˜1å°æ—¶
pillar_cache_backend: "memory"        # ä½¿ç”¨å†…å­˜ç¼“å­˜

# å¤–éƒ¨Pillarç¼“å­˜
ext_pillar_cache: true
ext_pillar_cache_ttl: 1800           # å¤–éƒ¨æ•°æ®ç¼“å­˜30åˆ†é’Ÿ
```

**ğŸ’¾ æŒä¹…åŒ–ç¼“å­˜é…ç½®**
```yaml
# ä½¿ç”¨Redisä½œä¸ºç¼“å­˜åç«¯
cache:
  pillar.cache:
    driver: redis
    host: cache.internal
    port: 6379
    db: 0
    password: "cache_password"
    
# æˆ–ä½¿ç”¨ç£ç›˜ç¼“å­˜
cache:
  pillar.cache:
    driver: disk
    path: /var/cache/salt/pillar
    max_size: 1048576  # 1GBæœ€å¤§ç¼“å­˜
```

### 7.3 ç¼“å­˜ç­–ç•¥ä¼˜åŒ–


**âš¡ ç¼“å­˜å¤±æ•ˆç­–ç•¥**
```bash
# æ‰‹åŠ¨åˆ·æ–°æ‰€æœ‰Minionçš„Pillarç¼“å­˜
salt '*' saltutil.refresh_pillar

# åˆ·æ–°ç‰¹å®šMinionçš„ç¼“å­˜
salt 'web01' saltutil.refresh_pillar

# åˆ·æ–°Masterç«¯çš„Pillarç¼“å­˜
salt-run cache.clear_pillar
```

**ğŸ¯ é€‰æ‹©æ€§ç¼“å­˜**
```yaml
# åªç¼“å­˜ç‰¹å®šçš„Pillaræ•°æ®
pillar_cache_criteria:
  - "database.*"      # ç¼“å­˜æ•°æ®åº“é…ç½®
  - "app.config.*"    # ç¼“å­˜åº”ç”¨é…ç½®
  
# ä¸ç¼“å­˜æ•æ„Ÿæ•°æ®
pillar_no_cache:
  - "secrets.*"       # ä¸ç¼“å­˜æ•æ„Ÿä¿¡æ¯
  - "passwords.*"     # ä¸ç¼“å­˜å¯†ç 
```

### 7.4 ç¼“å­˜ç›‘æ§ä¸è¯Šæ–­


**ğŸ“Š ç¼“å­˜çŠ¶æ€æ£€æŸ¥**
```bash
# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
salt-run cache.pillar_cache_stats

# æ£€æŸ¥ç‰¹å®šMinionçš„ç¼“å­˜çŠ¶æ€
salt 'web01' pillar.items --cached

# å¼ºåˆ¶é‡æ–°ç¼–è¯‘Pillar
salt 'web01' pillar.items --refresh
```

**ğŸ” ç¼“å­˜é—®é¢˜è¯Šæ–­**
```bash
# æ£€æŸ¥Pillarç¼–è¯‘æ—¶é—´
salt-run pillar.show_pillar minion_id --profiling

# æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡
salt-run cache.stats pillar

# æ¸…ç†æŸåçš„ç¼“å­˜
salt-run cache.clear_all
```

---

## 8. ğŸ” å®‰å…¨è®¿é—®æ§åˆ¶


### 8.1 Pillaræ•°æ®å®‰å…¨åŸåˆ™


**ğŸ›¡ï¸ å®‰å…¨è®¾è®¡åŸåˆ™**
```
æœ€å°æƒé™åŸåˆ™ï¼š
â€¢ Minionåªèƒ½è®¿é—®è‡ªå·±éœ€è¦çš„Pillaræ•°æ®
â€¢ ä¸åŒè§’è‰²çš„Minionè·å–ä¸åŒçš„æ•°æ®é›†
â€¢ æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨å’Œä¼ è¾“

æ•°æ®éš”ç¦»åŸåˆ™ï¼š
â€¢ ç”Ÿäº§å’Œæµ‹è¯•ç¯å¢ƒå®Œå…¨éš”ç¦»
â€¢ ä¸åŒé¡¹ç›®çš„é…ç½®æ•°æ®åˆ†ç¦»
â€¢ æ•æ„Ÿå’Œæ™®é€šæ•°æ®åˆ†ç¦»å­˜å‚¨
```

### 8.2 åŸºäºç›®æ ‡çš„è®¿é—®æ§åˆ¶


**ğŸ¯ ç›®æ ‡åŒ¹é…è§„åˆ™**
```yaml
# /srv/pillar/top.sls
base:
  # æ•°æ®åº“æœåŠ¡å™¨åªè·å–æ•°æ®åº“ç›¸å…³é…ç½®
  'G@roles:database':
    - database.config
    - database.credentials
    
  # WebæœåŠ¡å™¨ä¸èƒ½è®¿é—®æ•°æ®åº“å¯†ç 
  'G@roles:webserver':
    - webserver.config
    - webserver.ssl
    - database.config    # åªè·å–è¿æ¥ä¿¡æ¯ï¼Œä¸åŒ…å«å¯†ç 
    
  # åªæœ‰ç‰¹å®šçš„ç®¡ç†æœåŠ¡å™¨èƒ½è·å–æ‰€æœ‰å¯†ç 
  'admin.internal':
    - secrets.all
```

**ğŸ” å¤æ‚åŒ¹é…æ¡ä»¶**
```yaml
# åŸºäºå¤šä¸ªæ¡ä»¶çš„ç²¾ç¡®æ§åˆ¶
'G@os:Ubuntu and G@roles:webserver and G@environment:production':
  - ubuntu.webserver.production
  
# æ’é™¤ç‰¹å®šä¸»æœº
'* and not L@dev01,dev02':
  - production.secrets
```

### 8.3 Pillaræ•°æ®åŠ å¯†ä¼ è¾“


**ğŸ” ä¼ è¾“åŠ å¯†é…ç½®**
```yaml
# /etc/salt/master
# å¯ç”¨AESåŠ å¯†
aes: 'aes'

# ä½¿ç”¨æ›´å¼ºçš„åŠ å¯†ç®—æ³•
master_sign_pubkey: true
master_use_pubkey_signature: true

# é…ç½®è¯ä¹¦è®¤è¯
ssl_cert: /etc/salt/ssl/master.crt
ssl_key: /etc/salt/ssl/master.key
```

**ğŸ—ï¸ Pillarç‰¹å®šåŠ å¯†**
```yaml
# å¯¹ç‰¹å®šPillaræ•°æ®è¿›è¡Œé¢å¤–åŠ å¯†
pillar_enc: gpg

# GPGå¯†é’¥é…ç½®
gpg_keydir: /etc/salt/gpgkeys
gpg_decrypt_must_succeed: true
```

### 8.4 å®¡è®¡å’Œç›‘æ§


**ğŸ“‹ è®¿é—®æ—¥å¿—é…ç½®**
```yaml
# /etc/salt/master
# å¯ç”¨è¯¦ç»†æ—¥å¿—
log_level: debug
log_file: /var/log/salt/master.log

# å¯ç”¨Pillarè®¿é—®å®¡è®¡
pillar_log_access: true
pillar_log_level: info

# æ—¥å¿—è½®è½¬é…ç½®
log_rotate_max_bytes: 104857600  # 100MB
log_rotate_backup_count: 5
```

**ğŸ” å®‰å…¨ç›‘æ§è„šæœ¬**
```bash
#!/bin/bash
# /usr/local/bin/pillar-security-check.sh

# æ£€æŸ¥å¼‚å¸¸çš„Pillarè®¿é—®
echo "æ£€æŸ¥æœ€è¿‘1å°æ—¶çš„Pillarè®¿é—®..."
grep "pillar.show" /var/log/salt/master.log | \
    grep "$(date -d '1 hour ago' '+%Y-%m-%d %H')" | \
    awk '{print $7, $8}' | sort | uniq -c | sort -nr

# æ£€æŸ¥æ•æ„Ÿæ•°æ®è®¿é—®
echo "æ£€æŸ¥æ•æ„Ÿæ•°æ®è®¿é—®..."
grep -E "(password|secret|key)" /var/log/salt/master.log | \
    tail -20

# æ£€æŸ¥å¤±è´¥çš„è®¤è¯
echo "æ£€æŸ¥è®¤è¯å¤±è´¥..."
grep -i "authentication.*fail" /var/log/salt/master.log | tail -10
```

### 8.5 åˆè§„æ€§é…ç½®


**ğŸ“œ ç¬¦åˆå®‰å…¨æ ‡å‡†çš„é…ç½®**
```yaml
# æ»¡è¶³ä¼ä¸šå®‰å…¨è¦æ±‚çš„é…ç½®
security:
  # æ•°æ®åˆ†ç±»
  classification:
    public:
      - "app.name"
      - "app.version"
    internal:
      - "database.host"
      - "cache.servers"
    confidential:
      - "database.password"
      - "api.secret_key"
    restricted:
      - "certificates.private_key"
      - "encryption.master_key"
      
  # è®¿é—®ç­–ç•¥
  access_policy:
    confidential:
      allowed_roles:
        - "database_admin"
        - "security_admin"
      require_2fa: true
      
    restricted:
      allowed_hosts:
        - "security.internal"
      require_approval: true
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Pillaræœ¬è´¨ï¼šMasteræ§åˆ¶çš„é…ç½®æ•°æ®å­˜å‚¨å’Œåˆ†å‘ç³»ç»Ÿ
ğŸ”¸ æ•°æ®ç»“æ„ï¼šå±‚æ¬¡åŒ–YAMLæ ¼å¼ï¼Œæ”¯æŒæ¨¡æ¿å’ŒåŠ¨æ€ç”Ÿæˆ
ğŸ”¸ ç»§æ‰¿æœºåˆ¶ï¼šå¤šå±‚é…ç½®è¦†ç›–ï¼Œåé¢è¦†ç›–å‰é¢çš„åŸåˆ™  
ğŸ”¸ å®‰å…¨ç‰¹æ€§ï¼šåŠ å¯†å­˜å‚¨ã€ä¼ è¾“åŠ å¯†ã€è®¿é—®æ§åˆ¶
ğŸ”¸ åŠ¨æ€èƒ½åŠ›ï¼šåŸºäºæ¡ä»¶ç”Ÿæˆã€å¤–éƒ¨æ•°æ®æºé›†æˆ
ğŸ”¸ ç¼“å­˜ä¼˜åŒ–ï¼šå¤šçº§ç¼“å­˜æå‡æ€§èƒ½ï¼Œæ”¯æŒä¸åŒå­˜å‚¨åç«¯
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Pillar vs GrainsåŒºåˆ«**
```
è®°å¿†æ–¹æ³•ï¼š
Pillar = é…ç½®æŸœï¼ˆä¸»åŠ¨åˆ†å‘çš„é…ç½®å‚æ•°ï¼‰
Grains = èº«ä»½è¯ï¼ˆè¢«åŠ¨æ”¶é›†çš„ç³»ç»Ÿä¿¡æ¯ï¼‰

Pillarï¼šMasterè¯´äº†ç®—ï¼Œç”¨æ¥é…ç½®
Grainsï¼šMinionè‡ªå·±çŸ¥é“ï¼Œç”¨æ¥è¯†åˆ«
```

**ğŸ”¹ æ•°æ®å®‰å…¨çš„é‡è¦æ€§**
```
æ ¸å¿ƒåŸåˆ™ï¼š
â€¢ æ•æ„Ÿæ•°æ®å¿…é¡»åŠ å¯†
â€¢ è®¿é—®æƒé™æœ€å°åŒ–
â€¢ ä¼ è¾“è¿‡ç¨‹è¦ä¿æŠ¤
â€¢ æ“ä½œè¡Œä¸ºè¦å®¡è®¡

å®è·µè¦ç‚¹ï¼š
â€¢ å¯†ç ä¸èƒ½æ˜æ–‡å­˜å‚¨
â€¢ ä¸åŒç¯å¢ƒä¸¥æ ¼éš”ç¦»
â€¢ å®šæœŸæ£€æŸ¥è®¿é—®æ—¥å¿—
â€¢ éµå¾ªä¼ä¸šå®‰å…¨è§„èŒƒ
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```
ä¼˜åŒ–é‡ç‚¹ï¼š
â€¢ åˆç†ä½¿ç”¨ç¼“å­˜å‡å°‘ç¼–è¯‘å¼€é”€
â€¢ å¤–éƒ¨æ•°æ®æºè¦è®¾ç½®åˆé€‚çš„è¶…æ—¶
â€¢ å¤§é‡æ•°æ®è¦åˆ†é¡µæˆ–åˆ†æ‰¹å¤„ç†
â€¢ å¤æ‚æ¨¡æ¿è¦è€ƒè™‘ç¼–è¯‘æ€§èƒ½

ç›‘æ§æŒ‡æ ‡ï¼š
â€¢ Pillarç¼–è¯‘æ—¶é—´
â€¢ ç¼“å­˜å‘½ä¸­ç‡  
â€¢ æ•°æ®ä¼ è¾“å¤§å°
â€¢ Minionå“åº”å»¶è¿Ÿ
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯**
- **é…ç½®ç®¡ç†**ï¼šä¸åŒç¯å¢ƒçš„åº”ç”¨é…ç½®å‚æ•°
- **å¯†é’¥åˆ†å‘**ï¼šæ•°æ®åº“å¯†ç ã€APIå¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯
- **åŠ¨æ€è°ƒä¼˜**ï¼šæ ¹æ®ä¸»æœºé…ç½®è‡ªåŠ¨ä¼˜åŒ–å‚æ•°
- **åˆè§„ç®¡ç†**ï¼šæ»¡è¶³ä¼ä¸šå®‰å…¨å’Œå®¡è®¡è¦æ±‚

**ğŸ”§ æœ€ä½³å®è·µå»ºè®®**
```
è®¾è®¡åŸåˆ™ï¼š
â€¢ é…ç½®å±‚æ¬¡åŒ–ï¼Œé¿å…é‡å¤
â€¢ æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
â€¢ ä½¿ç”¨æ¨¡æ¿æé«˜çµæ´»æ€§
â€¢ å»ºç«‹éªŒè¯æœºåˆ¶é˜²æ­¢é”™è¯¯

è¿ç»´ç­–ç•¥ï¼š
â€¢ å®šæœŸå¤‡ä»½Pillaræ•°æ®
â€¢ ç›‘æ§ç¼“å­˜æ€§èƒ½çŠ¶å†µ
â€¢ å®¡è®¡æ•æ„Ÿæ•°æ®è®¿é—®
â€¢ å»ºç«‹åº”æ€¥å“åº”æœºåˆ¶
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Pillaré…ç½®åˆ†å‘å¼ºï¼Œå±‚æ¬¡ç»“æ„è¦è®¾è®¡å¥½
- æ•æ„Ÿæ•°æ®å¿…åŠ å¯†ï¼Œè®¿é—®æƒé™æ§åˆ¶ä¸¥
- ç¼“å­˜ä¼˜åŒ–ææ€§èƒ½ï¼Œç›‘æ§å®¡è®¡ä¿å®‰å…¨
- åŠ¨æ€ç”Ÿæˆå¾ˆçµæ´»ï¼Œå¤–éƒ¨é›†æˆæ‰©å±•å¹¿