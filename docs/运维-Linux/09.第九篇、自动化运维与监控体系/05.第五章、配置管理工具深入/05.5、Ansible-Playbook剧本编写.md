---
title: 5ã€Ansible-Playbookå‰§æœ¬ç¼–å†™
---
## ğŸ“š ç›®å½•

1. [YAMLè¯­æ³•ä¸æœ€ä½³å®è·µ](#1-YAMLè¯­æ³•ä¸æœ€ä½³å®è·µ)
2. [Playä¸Taskç»“æ„è®¾è®¡](#2-Playä¸Taskç»“æ„è®¾è®¡)
3. [å˜é‡å®šä¹‰ä¸ä½œç”¨åŸŸ](#3-å˜é‡å®šä¹‰ä¸ä½œç”¨åŸŸ)
4. [æ¡ä»¶åˆ¤æ–­ä¸å¾ªç¯æ§åˆ¶](#4-æ¡ä»¶åˆ¤æ–­ä¸å¾ªç¯æ§åˆ¶)
5. [Handlerè§¦å‘æœºåˆ¶](#5-Handlerè§¦å‘æœºåˆ¶)
6. [Includeä¸Importä½¿ç”¨](#6-Includeä¸Importä½¿ç”¨)
7. [é”™è¯¯å¤„ç†ä¸å¤±è´¥ç­–ç•¥](#7-é”™è¯¯å¤„ç†ä¸å¤±è´¥ç­–ç•¥)
8. [Playbookè°ƒè¯•æŠ€å·§](#8-Playbookè°ƒè¯•æŠ€å·§)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“ YAMLè¯­æ³•ä¸æœ€ä½³å®è·µ


### 1.1 ä»€ä¹ˆæ˜¯YAML


**YAMLçš„æœ¬è´¨**ï¼šYAMLæ˜¯ä¸€ç§äººç±»å¯è¯»çš„æ•°æ®åºåˆ—åŒ–æ ‡å‡†ï¼ŒAnsibleé€‰æ‹©å®ƒä½œä¸ºé…ç½®è¯­è¨€æ˜¯å› ä¸ºå®ƒæ¯”JSONæ›´æ˜“è¯»ï¼Œæ¯”XMLæ›´ç®€æ´ã€‚

```
ç®€å•å¯¹æ¯”ï¼š
JSON: {"name": "web-server", "state": "started"}
YAML: name: web-server
      state: started

å¯è¯»æ€§ï¼šYAMLæ˜æ˜¾æ›´æ¸…æ™°ï¼
```

### 1.2 YAMLåŸºç¡€è¯­æ³•è§„åˆ™


**ğŸ”¸ ç¼©è¿›è§„åˆ™**
```yaml
# âœ… æ­£ç¡®çš„ç¼©è¿›ï¼ˆ2ä¸ªç©ºæ ¼ï¼‰
web_servers:
  - name: apache
    port: 80
  - name: nginx  
    port: 8080

# âŒ é”™è¯¯çš„ç¼©è¿›ï¼ˆTabé”®æˆ–ä¸ä¸€è‡´ï¼‰
web_servers:
    - name: apache    # 4ä¸ªç©ºæ ¼
	  port: 80        # Tabé”®
```

**ğŸ’¡ æ ¸å¿ƒç†è§£**ï¼š
- YAMLç”¨**ç¼©è¿›è¡¨ç¤ºå±‚çº§å…³ç³»**ï¼Œå°±åƒPythonä¸€æ ·
- å¿…é¡»ä½¿ç”¨**ç©ºæ ¼**ï¼Œä¸èƒ½ç”¨Tabé”®
- åŒä¸€å±‚çº§çš„å…ƒç´ å¿…é¡»**å¯¹é½**

**ğŸ”¸ æ•°æ®ç±»å‹**
```yaml
# å­—ç¬¦ä¸²ï¼ˆå¯ä»¥ä¸ç”¨å¼•å·ï¼‰
server_name: web-server-01
server_desc: "Web Server for Production"

# æ•°å­—
port: 80
timeout: 30.5

# å¸ƒå°”å€¼
enabled: true
debug_mode: false

# åˆ—è¡¨ï¼ˆä¸¤ç§å†™æ³•ï¼‰
services:
  - apache2
  - mysql
  - php

# æˆ–è€…ï¼šservices: [apache2, mysql, php]

# å­—å…¸
database:
  host: localhost
  port: 3306
  name: myapp
```

### 1.3 Ansibleä¸­çš„YAMLæœ€ä½³å®è·µ


**ğŸ“‹ æ–‡ä»¶ç»“æ„è§„èŒƒ**
```yaml
---  # æ–‡æ¡£å¼€å§‹æ ‡è®°
- name: éƒ¨ç½²Webåº”ç”¨  # Playæè¿°
  hosts: web_servers   # ç›®æ ‡ä¸»æœº
  become: yes         # æå‡æƒé™
  
  vars:              # å˜é‡å®šä¹‰
    app_name: myapp
    app_port: 8080
    
  tasks:             # ä»»åŠ¡åˆ—è¡¨
    - name: å®‰è£…Apache  # ä»»åŠ¡æè¿°
      package:
        name: apache2
        state: present
        
    - name: å¯åŠ¨ApacheæœåŠ¡
      service:
        name: apache2
        state: started
        enabled: yes
...  # æ–‡æ¡£ç»“æŸæ ‡è®°ï¼ˆå¯é€‰ï¼‰
```

**ğŸ¯ å‘½åè§„èŒƒ**
```yaml
# âœ… å¥½çš„å‘½åï¼šæè¿°æ€§ã€æ¸…æ™°
- name: å®‰è£…å¹¶é…ç½®Nginx WebæœåŠ¡å™¨
- name: åˆ›å»ºåº”ç”¨ç”¨æˆ·è´¦æˆ·
- name: å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•

# âŒ å·®çš„å‘½åï¼šæ¨¡ç³Šä¸æ¸…
- name: install stuff
- name: task1
- name: do something
```

**ğŸ” æ³¨é‡Šä½¿ç”¨**
```yaml
---
# è¿™æ˜¯ä¸€ä¸ªWebæœåŠ¡å™¨éƒ¨ç½²çš„Playbook
- name: éƒ¨ç½²WebæœåŠ¡å™¨
  hosts: web_servers
  
  vars:
    # å®šä¹‰åº”ç”¨ç›¸å…³å˜é‡
    app_name: mywebapp      # åº”ç”¨åç§°
    app_port: 8080          # åº”ç”¨ç«¯å£
    # TODO: æ·»åŠ SSLè¯ä¹¦é…ç½®
    
  tasks:
    # ç¬¬ä¸€æ­¥ï¼šå®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…
    - name: å®‰è£…Apache2
      package:
        name: apache2
        state: present
```

---

## 2. ğŸ—ï¸ Playä¸Taskç»“æ„è®¾è®¡


### 2.1 ä»€ä¹ˆæ˜¯Playå’ŒTask


**é€šä¿—ç†è§£**ï¼š
- **Playbook**ï¼šåƒä¸€æœ¬å‰§æœ¬ï¼ŒåŒ…å«å¤šä¸ªå‰§ç›®
- **Play**ï¼šåƒå‰§æœ¬ä¸­çš„ä¸€å¹•ï¼Œé’ˆå¯¹ç‰¹å®šä¸»æœºç»„çš„å®Œæ•´æ“ä½œ
- **Task**ï¼šåƒå‰§ä¸­çš„ä¸€ä¸ªåŠ¨ä½œï¼Œæ‰§è¡Œå…·ä½“çš„æ“ä½œ

```
å‰§æœ¬ç»“æ„ç±»æ¯”ï¼š
Playbookï¼ˆæ•´æœ¬å‰§æœ¬ï¼‰
â”œâ”€â”€ Play 1ï¼ˆç¬¬ä¸€å¹•ï¼šå‡†å¤‡ç¯å¢ƒï¼‰
â”‚   â”œâ”€â”€ Task 1ï¼ˆå®‰è£…è½¯ä»¶ï¼‰
â”‚   â”œâ”€â”€ Task 2ï¼ˆåˆ›å»ºç”¨æˆ·ï¼‰
â”‚   â””â”€â”€ Task 3ï¼ˆè®¾ç½®æƒé™ï¼‰
â”œâ”€â”€ Play 2ï¼ˆç¬¬äºŒå¹•ï¼šéƒ¨ç½²åº”ç”¨ï¼‰
â”‚   â”œâ”€â”€ Task 1ï¼ˆä¸‹è½½ä»£ç ï¼‰
â”‚   â”œâ”€â”€ Task 2ï¼ˆé…ç½®æ–‡ä»¶ï¼‰
â”‚   â””â”€â”€ Task 3ï¼ˆå¯åŠ¨æœåŠ¡ï¼‰
```

### 2.2 Playç»“æ„è¯¦è§£


**ğŸ”¸ åŸºæœ¬Playç»“æ„**
```yaml
- name: WebæœåŠ¡å™¨é…ç½®         # Playåç§°ï¼ˆæè¿°è¿™ä¸€å¹•åšä»€ä¹ˆï¼‰
  hosts: web_servers         # ç›®æ ‡ä¸»æœºç»„
  become: yes               # æ˜¯å¦éœ€è¦sudoæƒé™
  become_user: root         # åˆ‡æ¢åˆ°å“ªä¸ªç”¨æˆ·æ‰§è¡Œ
  gather_facts: yes         # æ˜¯å¦æ”¶é›†ä¸»æœºä¿¡æ¯
  
  vars:                     # è¿™ä¸ªPlayä¸“ç”¨çš„å˜é‡
    app_port: 8080
    
  vars_files:               # ä»æ–‡ä»¶åŠ è½½å˜é‡
    - vars/web_config.yml
    
  pre_tasks:                # ä¸»è¦ä»»åŠ¡ä¹‹å‰æ‰§è¡Œ
    - name: æ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…
      apt: update_cache=yes
      
  tasks:                    # ä¸»è¦ä»»åŠ¡åˆ—è¡¨
    - name: å®‰è£…WebæœåŠ¡å™¨
      package:
        name: apache2
        state: present
        
  post_tasks:               # ä¸»è¦ä»»åŠ¡ä¹‹åæ‰§è¡Œ
    - name: å‘é€éƒ¨ç½²å®Œæˆé€šçŸ¥
      mail:
        subject: "éƒ¨ç½²å®Œæˆ"
        
  handlers:                 # äº‹ä»¶å¤„ç†å™¨
    - name: é‡å¯Apache
      service:
        name: apache2
        state: restarted
```

### 2.3 Taskè®¾è®¡åŸåˆ™


**ğŸ¯ ä»»åŠ¡è®¾è®¡è¦ç‚¹**
```yaml
# âœ… å¥½çš„Taskè®¾è®¡
- name: å®‰è£…MySQLæ•°æ®åº“æœåŠ¡å™¨  # æ¸…æ™°çš„æè¿°
  package:
    name: mysql-server        # å…·ä½“çš„å‚æ•°
    state: present
  register: mysql_install     # ä¿å­˜æ‰§è¡Œç»“æœ
  notify: å¯åŠ¨MySQLæœåŠ¡       # è§¦å‘å¤„ç†å™¨
  tags: 
    - mysql                   # æ·»åŠ æ ‡ç­¾ä¾¿äºç­›é€‰
    - database
  when: ansible_os_family == "Debian"  # æ¡ä»¶æ‰§è¡Œ

# âœ… å¹‚ç­‰æ€§è®¾è®¡ï¼ˆé‡å¤æ‰§è¡Œç»“æœä¸€æ ·ï¼‰
- name: ç¡®ä¿åº”ç”¨ç›®å½•å­˜åœ¨
  file:
    path: /opt/myapp
    state: directory          # ç›®å½•ä¸å­˜åœ¨å°±åˆ›å»ºï¼Œå­˜åœ¨å°±è·³è¿‡
    owner: app
    group: app
    mode: '0755'
```

**ğŸ“Š ä»»åŠ¡æ‰§è¡Œæµç¨‹**
```
ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ï¼š
[å¼€å§‹] â†’ [æ£€æŸ¥æ¡ä»¶] â†’ [æ‰§è¡Œæ¨¡å—] â†’ [æ£€æŸ¥ç»“æœ] â†’ [è§¦å‘Handler] â†’ [ç»“æŸ]
   â†“         â†“           â†“           â†“            â†“
 whenæ¡ä»¶   æ¨¡å—å‚æ•°    è¿”å›çŠ¶æ€    registerå˜é‡   notifyäº‹ä»¶
```

---

## 3. ğŸ”§ å˜é‡å®šä¹‰ä¸ä½œç”¨åŸŸ


### 3.1 å˜é‡æ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼šå˜é‡å°±åƒç¨‹åºä¸­çš„"ä»£åè¯"ï¼Œå¯ä»¥å­˜å‚¨å€¼å¹¶åœ¨ä¸åŒåœ°æ–¹é‡å¤ä½¿ç”¨ï¼Œé¿å…ç¡¬ç¼–ç ã€‚

```yaml
# æ²¡æœ‰å˜é‡ï¼ˆç¡¬ç¼–ç ï¼‰- ä¸å¥½ç»´æŠ¤
- name: åˆ›å»ºç”¨æˆ·
  user:
    name: john
    shell: /bin/bash
    home: /home/john

# ä½¿ç”¨å˜é‡ - çµæ´»å¯å¤ç”¨  
vars:
  app_user: john
  user_shell: /bin/bash
  
- name: åˆ›å»ºç”¨æˆ·
  user:
    name: "{{ app_user }}"
    shell: "{{ user_shell }}"
    home: "/home/{{ app_user }}"
```

### 3.2 å˜é‡å®šä¹‰æ–¹å¼


**ğŸ”¸ åœ¨Playbookä¸­å®šä¹‰**
```yaml
---
- name: WebæœåŠ¡å™¨éƒ¨ç½²
  hosts: web_servers
  
  vars:                    # åœ¨Playçº§åˆ«å®šä¹‰
    app_name: mywebapp
    app_port: 8080
    database_host: 192.168.1.100
    
  vars_files:              # ä»æ–‡ä»¶åŠ è½½
    - vars/common.yml      # é€šç”¨å˜é‡
    - vars/web_config.yml  # Webç›¸å…³å˜é‡
    
  tasks:
    - name: æ˜¾ç¤ºå˜é‡
      debug:
        msg: "åº”ç”¨{{ app_name }}å°†åœ¨ç«¯å£{{ app_port }}ä¸Šè¿è¡Œ"
```

**ğŸ”¸ åœ¨æ¸…å•æ–‡ä»¶ä¸­å®šä¹‰**
```ini
# inventory/hosts
[web_servers]
web1 ansible_host=192.168.1.10 app_env=production
web2 ansible_host=192.168.1.11 app_env=staging

[web_servers:vars]          # ç»„å˜é‡
app_port=8080
database_host=192.168.1.100

[all:vars]                  # å…¨å±€å˜é‡
ansible_user=deploy
ansible_ssh_private_key_file=~/.ssh/id_rsa
```

**ğŸ”¸ ç‹¬ç«‹å˜é‡æ–‡ä»¶**
```yaml
# vars/web_config.yml
app_name: mywebapp
app_port: 8080
app_user: webapp
app_group: webapp

database:
  host: db.example.com
  port: 3306
  name: myapp_prod

ssl:
  enabled: true
  cert_path: /etc/ssl/certs/myapp.crt
  key_path: /etc/ssl/private/myapp.key
```

### 3.3 å˜é‡ä½œç”¨åŸŸä¸ä¼˜å…ˆçº§


**ğŸ“Š ä¼˜å…ˆçº§é¡ºåºï¼ˆä»é«˜åˆ°ä½ï¼‰**
```
å˜é‡ä¼˜å…ˆçº§ï¼š
1. å‘½ä»¤è¡Œå‚æ•°      ansible-playbook -e "app_port=9090"
2. ä»»åŠ¡çº§å˜é‡      vars: app_port: 8080
3. Playçº§å˜é‡      åœ¨playä¸­å®šä¹‰çš„vars
4. æ–‡ä»¶å˜é‡        vars_filesä¸­çš„å˜é‡
5. ä¸»æœºå˜é‡        inventoryä¸­å•ä¸ªä¸»æœºçš„å˜é‡  
6. ç»„å˜é‡          inventoryä¸­ç»„çš„å˜é‡
7. å…¨å±€å˜é‡        [all:vars]ä¸­çš„å˜é‡
```

**ğŸ’¡ å®é™…åº”ç”¨ç¤ºä¾‹**
```yaml
# group_vars/web_servers.ymlï¼ˆåŸºç¡€é…ç½®ï¼‰
app_port: 8080
app_env: production

# host_vars/web1.ymlï¼ˆç‰¹å®šä¸»æœºè¦†ç›–ï¼‰
app_port: 9090        # web1ä½¿ç”¨ç‰¹æ®Šç«¯å£

# playbook.yml
- name: éƒ¨ç½²åº”ç”¨
  hosts: web_servers
  vars:
    app_debug: false   # Playçº§åˆ«å˜é‡
  tasks:
    - name: æ˜¾ç¤ºé…ç½®
      debug:
        msg: "{{ inventory_hostname }}ä¸Šçš„åº”ç”¨ç«¯å£: {{ app_port }}"
      # web1æ˜¾ç¤º9090ï¼Œweb2æ˜¾ç¤º8080
```

**ğŸ”¸ å˜é‡å¼•ç”¨è¯­æ³•**
```yaml
# åŸºæœ¬å¼•ç”¨
app_name: myapp
app_path: "/opt/{{ app_name }}"

# å­—å…¸å˜é‡
database:
  host: localhost
  port: 3306

# å¼•ç”¨å­—å…¸
db_url: "{{ database.host }}:{{ database.port }}"
# æˆ–è€…ï¼šdb_url: "{{ database['host'] }}:{{ database['port'] }}"

# åˆ—è¡¨å˜é‡
packages:
  - nginx
  - mysql-server
  - php

# å¼•ç”¨åˆ—è¡¨
first_package: "{{ packages[0] }}"  # nginx
```

---

## 4. ğŸ”€ æ¡ä»¶åˆ¤æ–­ä¸å¾ªç¯æ§åˆ¶


### 4.1 æ¡ä»¶åˆ¤æ–­ï¼ˆwhenè¯­å¥ï¼‰


**ä»€ä¹ˆæ—¶å€™ç”¨æ¡ä»¶åˆ¤æ–­**ï¼šä¸åŒçš„ç³»ç»Ÿç¯å¢ƒéœ€è¦æ‰§è¡Œä¸åŒçš„æ“ä½œï¼Œæ¯”å¦‚CentOSç”¨yumå®‰è£…è½¯ä»¶ï¼ŒUbuntuç”¨aptå®‰è£…ã€‚

**ğŸ”¸ åŸºæœ¬æ¡ä»¶è¯­æ³•**
```yaml
# æ ¹æ®æ“ä½œç³»ç»Ÿç±»å‹å®‰è£…è½¯ä»¶
- name: åœ¨CentOSä¸Šå®‰è£…Apache
  yum:
    name: httpd
    state: present
  when: ansible_os_family == "RedHat"

- name: åœ¨Ubuntuä¸Šå®‰è£…Apache  
  apt:
    name: apache2
    state: present
  when: ansible_os_family == "Debian"
```

**ğŸ”¸ å¸¸ç”¨æ¡ä»¶åˆ¤æ–­**
```yaml
# æ£€æŸ¥å˜é‡æ˜¯å¦å®šä¹‰
- name: åˆ›å»ºæ•°æ®åº“
  mysql_db:
    name: "{{ db_name }}"
    state: present
  when: db_name is defined

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- name: è¯»å–é…ç½®æ–‡ä»¶
  stat:
    path: /etc/myapp.conf
  register: config_file

- name: å¤‡ä»½ç°æœ‰é…ç½®
  copy:
    src: /etc/myapp.conf
    dest: /etc/myapp.conf.bak
  when: config_file.stat.exists

# å¤šæ¡ä»¶ç»„åˆ
- name: å®‰è£…å¼€å‘å·¥å…·
  package:
    name: "{{ item }}"
    state: present
  loop:
    - gcc
    - make
    - git
  when: 
    - app_env == "development"
    - ansible_architecture == "x86_64"
```

**ğŸ”¸ æ¡ä»¶è¿ç®—ç¬¦**
```yaml
# æ¯”è¾ƒè¿ç®—ç¬¦
when: app_port > 8000           # å¤§äº
when: app_env != "production"   # ä¸ç­‰äº
when: users | length > 0        # åˆ—è¡¨é•¿åº¦å¤§äº0

# é€»è¾‘è¿ç®—ç¬¦
when: app_debug and app_env == "development"     # ä¸
when: app_env == "staging" or app_env == "test"  # æˆ–
when: not ssl_enabled                            # é

# æˆå‘˜æ£€æŸ¥
when: "'web' in group_names"          # ä¸»æœºåœ¨webç»„ä¸­
when: "ansible_eth0 is defined"       # ç½‘å¡eth0å­˜åœ¨
```

### 4.2 å¾ªç¯æ§åˆ¶ï¼ˆloopè¯­å¥ï¼‰


**ä»€ä¹ˆæ˜¯å¾ªç¯**ï¼šå½“éœ€è¦å¯¹å¤šä¸ªç›¸ä¼¼çš„é¡¹ç›®æ‰§è¡Œç›¸åŒæ“ä½œæ—¶ï¼Œç”¨å¾ªç¯é¿å…é‡å¤å†™ä»£ç ã€‚

**ğŸ”¸ åŸºæœ¬å¾ªç¯è¯­æ³•**
```yaml
# å®‰è£…å¤šä¸ªè½¯ä»¶åŒ…
- name: å®‰è£…åŸºç¡€è½¯ä»¶åŒ…
  package:
    name: "{{ item }}"
    state: present
  loop:
    - git
    - curl
    - wget
    - vim
    - htop
```

**ğŸ”¸ å¾ªç¯ç±»å‹è¯¦è§£**
```yaml
# 1. ç®€å•åˆ—è¡¨å¾ªç¯
- name: åˆ›å»ºå¤šä¸ªç”¨æˆ·
  user:
    name: "{{ item }}"
    state: present
  loop:
    - alice
    - bob
    - charlie

# 2. å­—å…¸åˆ—è¡¨å¾ªç¯
- name: åˆ›å»ºç”¨æˆ·å¹¶è®¾ç½®å±æ€§
  user:
    name: "{{ item.name }}"
    shell: "{{ item.shell }}"
    groups: "{{ item.groups }}"
  loop:
    - { name: alice, shell: /bin/bash, groups: "sudo,developers" }
    - { name: bob, shell: /bin/zsh, groups: "developers" }
    - { name: charlie, shell: /bin/bash, groups: "operators" }

# 3. åµŒå¥—å¾ªç¯
- name: ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºå¤šä¸ªç›®å½•
  file:
    path: "/home/{{ item[0] }}/{{ item[1] }}"
    state: directory
    owner: "{{ item[0] }}"
  loop: "{{ users | product(directories) | list }}"
  vars:
    users: [alice, bob]
    directories: [projects, downloads, documents]
```

**ğŸ”¸ å¾ªç¯å˜é‡æ§åˆ¶**
```yaml
# ä½¿ç”¨loop_controlè‡ªå®šä¹‰å¾ªç¯å˜é‡å
- name: éƒ¨ç½²å¤šä¸ªåº”ç”¨
  template:
    src: app.conf.j2
    dest: "/etc/{{ app.name }}.conf"
  loop:
    - { name: web-app, port: 8080 }
    - { name: api-app, port: 9090 }
  loop_control:
    loop_var: app        # ä½¿ç”¨appä»£æ›¿item
    index_var: app_index # è·å–å¾ªç¯ç´¢å¼•
    label: "{{ app.name }}"  # ç®€åŒ–è¾“å‡ºæ˜¾ç¤º
```

**ğŸ”¸ æ¡ä»¶ä¸å¾ªç¯ç»“åˆ**
```yaml
# åªå®‰è£…ç‰¹å®šç¯å¢ƒçš„è½¯ä»¶åŒ…
- name: å®‰è£…ç¯å¢ƒç›¸å…³è½¯ä»¶
  package:
    name: "{{ item.name }}"
    state: present
  loop:
    - { name: nginx, env: all }
    - { name: mysql-server, env: production }
    - { name: redis-server, env: production }
    - { name: sqlite3, env: development }
  when: item.env == "all" or item.env == app_env
```

---

## 5. ğŸ¯ Handlerè§¦å‘æœºåˆ¶


### 5.1 ä»€ä¹ˆæ˜¯Handler


**é€šä¿—ç†è§£**ï¼šHandlerå°±åƒç”Ÿæ´»ä¸­çš„"è¿é”ååº”"ï¼Œå½“æŸä»¶äº‹æƒ…å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè‡ªåŠ¨è§¦å‘ç›¸åº”çš„åç»­åŠ¨ä½œã€‚

```
ç”Ÿæ´»ä¾‹å­ï¼š
æ›´æ¢è½®èƒï¼ˆTaskï¼‰ â†’ æ£€æŸ¥æ°”å‹ï¼ˆHandlerï¼‰
å®‰è£…æ–°è½¯ä»¶ï¼ˆTaskï¼‰ â†’ é‡å¯æœåŠ¡ï¼ˆHandlerï¼‰  
ä¿®æ”¹é…ç½®ï¼ˆTaskï¼‰ â†’ é‡æ–°åŠ è½½é…ç½®ï¼ˆHandlerï¼‰
```

**ğŸ”¸ HandleråŸºæœ¬æ¦‚å¿µ**
```yaml
# Handlerå®šä¹‰ï¼šåœ¨handlerséƒ¨åˆ†å®šä¹‰
handlers:
  - name: é‡å¯Apache
    service:
      name: apache2
      state: restarted
      
  - name: é‡æ–°åŠ è½½é…ç½®
    service:
      name: apache2
      state: reloaded

# Taskè§¦å‘ï¼šä½¿ç”¨notifyè§¦å‘Handler
tasks:
  - name: ä¿®æ”¹Apacheé…ç½®æ–‡ä»¶
    template:
      src: apache.conf.j2
      dest: /etc/apache2/apache2.conf
    notify: é‡å¯Apache    # åªæœ‰é…ç½®æ–‡ä»¶æ”¹å˜æ—¶æ‰é‡å¯
    
  - name: æ·»åŠ è™šæ‹Ÿä¸»æœº
    template:
      src: vhost.conf.j2
      dest: "/etc/apache2/sites-available/{{ app_name }}.conf"
    notify: é‡æ–°åŠ è½½é…ç½®  # åªæœ‰è™šæ‹Ÿä¸»æœºæ”¹å˜æ—¶æ‰é‡è½½
```

### 5.2 Handlerå·¥ä½œæœºåˆ¶


**ğŸ“Š Handleræ‰§è¡Œæµç¨‹**
```
Handleræ‰§è¡Œé¡ºåºï¼š
[Task1] â†’ notify â†’ [è®°å½•å¾…æ‰§è¡ŒHandler]
[Task2] â†’ notify â†’ [è®°å½•å¾…æ‰§è¡ŒHandler]
[Task3] â†’ æ— å˜åŒ– â†’ [è·³è¿‡]
...
[æ‰€æœ‰Taskå®Œæˆ] â†’ [æ‰§è¡Œæ‰€æœ‰Handler] â†’ [æŒ‰å®šä¹‰é¡ºåºæ‰§è¡Œ]
```

**ğŸ”¸ å®Œæ•´ç¤ºä¾‹**
```yaml
---
- name: é…ç½®WebæœåŠ¡å™¨
  hosts: web_servers
  become: yes
  
  tasks:
    # Task 1: å®‰è£…Apacheï¼ˆå¦‚æœå·²å®‰è£…åˆ™è·³è¿‡ï¼Œä¸è§¦å‘Handlerï¼‰
    - name: å®‰è£…Apache2
      package:
        name: apache2
        state: present
    
    # Task 2: ä¿®æ”¹ä¸»é…ç½®ï¼ˆå¦‚æœ‰å˜åŒ–è§¦å‘é‡å¯ï¼‰
    - name: é…ç½®Apacheä¸»é…ç½®æ–‡ä»¶
      template:
        src: apache2.conf.j2
        dest: /etc/apache2/apache2.conf
        backup: yes
      notify: é‡å¯ApacheæœåŠ¡
    
    # Task 3: æ·»åŠ ç«™ç‚¹é…ç½®ï¼ˆå¦‚æœ‰å˜åŒ–è§¦å‘é‡è½½ï¼‰
    - name: é…ç½®è™šæ‹Ÿä¸»æœº
      template:
        src: site.conf.j2
        dest: "/etc/apache2/sites-available/{{ site_name }}.conf"
      notify: 
        - å¯ç”¨ç«™ç‚¹
        - é‡æ–°åŠ è½½Apache
    
    # Task 4: å¯åŠ¨æœåŠ¡ï¼ˆç¡®ä¿è¿è¡ŒçŠ¶æ€ï¼‰
    - name: ç¡®ä¿Apacheæ­£åœ¨è¿è¡Œ
      service:
        name: apache2
        state: started
        enabled: yes

  handlers:
    # HandleræŒ‰å®šä¹‰é¡ºåºæ‰§è¡Œï¼Œä¸æ˜¯æŒ‰notifyé¡ºåº
    - name: é‡å¯ApacheæœåŠ¡
      service:
        name: apache2
        state: restarted
        
    - name: å¯ç”¨ç«™ç‚¹
      command: a2ensite {{ site_name }}
      
    - name: é‡æ–°åŠ è½½Apache
      service:
        name: apache2
        state: reloaded
```

### 5.3 Handleré«˜çº§ç”¨æ³•


**ğŸ”¸ Handlerç»„åˆä½¿ç”¨**
```yaml
# å¤šä¸ªHandlerå¤„ç†å¤æ‚åœºæ™¯
tasks:
  - name: æ›´æ–°SSLè¯ä¹¦
    copy:
      src: "{{ item }}"
      dest: "/etc/ssl/{{ item | basename }}"
    loop:
      - files/ssl/server.crt
      - files/ssl/server.key
    notify:
      - éªŒè¯SSLè¯ä¹¦
      - é‡å¯Apache
      - å‘é€é€šçŸ¥é‚®ä»¶

handlers:
  - name: éªŒè¯SSLè¯ä¹¦
    command: openssl x509 -in /etc/ssl/server.crt -text -noout
    
  - name: é‡å¯Apache
    service:
      name: apache2
      state: restarted
    listen: "é‡å¯webæœåŠ¡"  # ç›‘å¬ç»„å
    
  - name: å‘é€é€šçŸ¥é‚®ä»¶
    mail:
      subject: "SSLè¯ä¹¦å·²æ›´æ–°"
      body: "{{ inventory_hostname }}çš„SSLè¯ä¹¦å·²æˆåŠŸæ›´æ–°"
```

**ğŸ”¸ æ¡ä»¶Handler**
```yaml
handlers:
  - name: é‡å¯ç”Ÿäº§ç¯å¢ƒæœåŠ¡
    service:
      name: myapp
      state: restarted
    when: app_env == "production"
    
  - name: é‡å¯å¼€å‘ç¯å¢ƒæœåŠ¡
    service:
      name: myapp-dev
      state: restarted
    when: app_env == "development"
```

---

## 6. ğŸ“ Includeä¸Importä½¿ç”¨


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦Includeå’ŒImport


**é—®é¢˜åœºæ™¯**ï¼šéšç€Playbookå˜å¤§ï¼Œæ‰€æœ‰ä»£ç å†™åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ä¼šå˜å¾—éš¾ä»¥ç»´æŠ¤ï¼Œå°±åƒæŠŠæ‰€æœ‰å‡½æ•°å†™åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ä¸€æ ·æ··ä¹±ã€‚

```
å¤§å‹é¡¹ç›®ç»„ç»‡ç»“æ„ï¼š
playbooks/
â”œâ”€â”€ site.yml          # ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ web-servers.yml    # WebæœåŠ¡å™¨é…ç½®
â”œâ”€â”€ db-servers.yml     # æ•°æ®åº“æœåŠ¡å™¨é…ç½®
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ common.yml     # å…¬å…±ä»»åŠ¡
â”‚   â”œâ”€â”€ security.yml   # å®‰å…¨é…ç½®
â”‚   â””â”€â”€ backup.yml     # å¤‡ä»½ä»»åŠ¡
â””â”€â”€ handlers/
    â”œâ”€â”€ web.yml        # Webç›¸å…³Handler
    â””â”€â”€ db.yml         # æ•°æ®åº“Handler
```

### 6.2 Include vs Import åŒºåˆ«


**æ ¸å¿ƒå·®å¼‚**ï¼š
- **Import**ï¼šåœ¨è§£æé˜¶æ®µå°±æŠŠå†…å®¹"å¤åˆ¶ç²˜è´´"è¿›æ¥ï¼ˆé™æ€ï¼‰
- **Include**ï¼šåœ¨æ‰§è¡Œé˜¶æ®µæ‰åŠ¨æ€åŠ è½½å†…å®¹ï¼ˆåŠ¨æ€ï¼‰

```yaml
# Import - é™æ€å¯¼å…¥ï¼ˆæ¨èç”¨äºå›ºå®šå†…å®¹ï¼‰
- import_tasks: tasks/common.yml
- import_playbook: playbooks/web-servers.yml

# Include - åŠ¨æ€å¯¼å…¥ï¼ˆæ¨èç”¨äºéœ€è¦å˜é‡æ§åˆ¶çš„å†…å®¹ï¼‰
- include_tasks: "tasks/{{ ansible_os_family | lower }}.yml"
- include_vars: "vars/{{ app_env }}.yml"
```

### 6.3 å®é™…ä½¿ç”¨ç¤ºä¾‹


**ğŸ”¸ ä»»åŠ¡æ¨¡å—åŒ–**
```yaml
# main.yml - ä¸»Playbook
---
- name: éƒ¨ç½²Webåº”ç”¨
  hosts: web_servers
  become: yes
  
  pre_tasks:
    - import_tasks: tasks/preparation.yml
    
  tasks:
    - import_tasks: tasks/install-packages.yml
    - import_tasks: tasks/configure-apache.yml
    - include_tasks: "tasks/deploy-{{ app_type }}.yml"
    
  post_tasks:
    - import_tasks: tasks/cleanup.yml

# tasks/install-packages.yml
---
- name: æ›´æ–°è½¯ä»¶åŒ…ç¼“å­˜
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: å®‰è£…åŸºç¡€è½¯ä»¶åŒ…
  package:
    name: "{{ item }}"
    state: present
  loop:
    - curl
    - git
    - unzip

# tasks/configure-apache.yml  
---
- name: å®‰è£…Apache2
  package:
    name: apache2
    state: present
  notify: å¯åŠ¨Apache

- name: é…ç½®Apacheä¸»é…ç½®æ–‡ä»¶
  template:
    src: apache2.conf.j2
    dest: /etc/apache2/apache2.conf
    backup: yes
  notify: é‡å¯Apache
```

**ğŸ”¸ å˜é‡æ–‡ä»¶å¯¼å…¥**
```yaml
# æ ¹æ®ç¯å¢ƒå¯¼å…¥ä¸åŒé…ç½®
- name: å¯¼å…¥ç¯å¢ƒé…ç½®
  include_vars: "vars/{{ app_env }}.yml"

# vars/production.yml
---
app_debug: false
database_host: prod-db.example.com
cache_servers:
  - redis-1.example.com
  - redis-2.example.com

# vars/development.yml  
---
app_debug: true
database_host: localhost
cache_servers:
  - localhost
```

**ğŸ”¸ Handleræ¨¡å—åŒ–**
```yaml
# handlers/main.yml
---
- import_tasks: web-handlers.yml
- import_tasks: database-handlers.yml

# handlers/web-handlers.yml
---
- name: é‡å¯Apache
  service:
    name: apache2
    state: restarted

- name: é‡æ–°åŠ è½½Apacheé…ç½®
  service:
    name: apache2
    state: reloaded
```

### 6.4 é«˜çº§ç»„ç»‡æŠ€å·§


**ğŸ”¸ æ¡ä»¶å¯¼å…¥**
```yaml
# æ ¹æ®æ“ä½œç³»ç»Ÿå¯¼å…¥ä¸åŒä»»åŠ¡
- name: å¯¼å…¥ç³»ç»Ÿç‰¹å®šä»»åŠ¡
  include_tasks: "{{ ansible_os_family | lower }}.yml"

# redhat.yml
---  
- name: å®‰è£…EPELä»“åº“
  yum:
    name: epel-release
    state: present

- name: ä½¿ç”¨yumå®‰è£…è½¯ä»¶åŒ…
  yum:
    name: "{{ packages }}"
    state: present

# debian.yml
---
- name: æ›´æ–°aptç¼“å­˜
  apt:
    update_cache: yes

- name: ä½¿ç”¨aptå®‰è£…è½¯ä»¶åŒ…
  apt:
    name: "{{ packages }}"
    state: present
```

**ğŸ”¸ å¾ªç¯å¯¼å…¥**
```yaml
# ä¸ºå¤šä¸ªåº”ç”¨éƒ¨ç½²ç›¸åŒé…ç½®
- name: éƒ¨ç½²å¤šä¸ªWebåº”ç”¨
  include_tasks: tasks/deploy-webapp.yml
  vars:
    app_name: "{{ outer_item.name }}"
    app_port: "{{ outer_item.port }}"
    app_repo: "{{ outer_item.repo }}"
  loop:
    - { name: frontend, port: 8080, repo: "git@github.com:company/frontend.git" }
    - { name: api, port: 9000, repo: "git@github.com:company/api.git" }
  loop_control:
    loop_var: outer_item
```

---

## 7. âš ï¸ é”™è¯¯å¤„ç†ä¸å¤±è´¥ç­–ç•¥


### 7.1 é»˜è®¤é”™è¯¯å¤„ç†è¡Œä¸º


**Ansibleçš„é»˜è®¤è¡Œä¸º**ï¼šå½“ä»»åŠ¡å¤±è´¥æ—¶ï¼ŒAnsibleä¼šç«‹å³åœæ­¢å¯¹è¯¥ä¸»æœºçš„åç»­æ“ä½œï¼Œä½†ç»§ç»­å¤„ç†å…¶ä»–ä¸»æœºã€‚

```yaml
# é»˜è®¤è¡Œä¸ºç¤ºä¾‹
tasks:
  - name: ä»»åŠ¡1 - æˆåŠŸæ‰§è¡Œ
    debug:
      msg: "è¿™ä¸ªä»»åŠ¡ä¼šæˆåŠŸ"
      
  - name: ä»»åŠ¡2 - å¯èƒ½å¤±è´¥
    command: /usr/bin/nonexistent-command
    # å¦‚æœè¿™é‡Œå¤±è´¥ï¼Œåç»­ä»»åŠ¡ä¸ä¼šæ‰§è¡Œ
    
  - name: ä»»åŠ¡3 - ä¸ä¼šæ‰§è¡Œ
    debug:
      msg: "å‰é¢ä»»åŠ¡å¤±è´¥ï¼Œè¿™é‡Œä¸ä¼šæ‰§è¡Œ"
```

### 7.2 æ§åˆ¶å¤±è´¥è¡Œä¸º


**ğŸ”¸ å¿½ç•¥é”™è¯¯ç»§ç»­æ‰§è¡Œ**
```yaml
- name: å°è¯•åœæ­¢æœåŠ¡ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰
  service:
    name: someservice
    state: stopped
  ignore_errors: yes      # å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œåç»­ä»»åŠ¡
  
- name: è¿™ä¸ªä»»åŠ¡ä¼šç»§ç»­æ‰§è¡Œ
  debug:
    msg: "å³ä½¿ä¸Šé¢ä»»åŠ¡å¤±è´¥ï¼Œæˆ‘ä¹Ÿä¼šæ‰§è¡Œ"
```

**ğŸ”¸ è‡ªå®šä¹‰å¤±è´¥æ¡ä»¶**
```yaml
- name: æ£€æŸ¥ç£ç›˜ä½¿ç”¨ç‡
  shell: df -h / | tail -1 | awk '{print $5}' | sed 's/%//'
  register: disk_usage
  failed_when: disk_usage.stdout | int > 90  # ç£ç›˜ä½¿ç”¨è¶…è¿‡90%ç®—å¤±è´¥
  
- name: æ£€æŸ¥æœåŠ¡çŠ¶æ€
  command: systemctl is-active myservice
  register: service_status
  failed_when: 
    - service_status.rc != 0           # å‘½ä»¤è¿”å›ç ä¸ä¸º0
    - '"inactive" in service_status.stdout'  # æˆ–è€…æœåŠ¡ä¸æ´»è·ƒ
```

**ğŸ”¸ æ”¹å˜ä»»åŠ¡çŠ¶æ€**
```yaml
- name: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  stat:
    path: /opt/myapp/config.yml
  register: config_file
  
- name: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨æ—¶æ˜¾ç¤ºè­¦å‘Š
  debug:
    msg: "è­¦å‘Šï¼šé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
  changed_when: false              # ä¸ç®—ä½œå˜æ›´
  when: not config_file.stat.exists
```

### 7.3 é”™è¯¯æ¢å¤ç­–ç•¥


**ğŸ”¸ ä½¿ç”¨rescueå’Œalways**
```yaml
- name: éƒ¨ç½²åº”ç”¨ï¼ˆå¸¦é”™è¯¯æ¢å¤ï¼‰
  block:
    # ä¸»è¦ä»»åŠ¡å—
    - name: ä¸‹è½½åº”ç”¨ä»£ç 
      git:
        repo: https://github.com/company/myapp.git
        dest: /opt/myapp
        
    - name: å®‰è£…ä¾èµ–
      pip:
        requirements: /opt/myapp/requirements.txt
        
    - name: å¯åŠ¨åº”ç”¨
      service:
        name: myapp
        state: started
        
  rescue:
    # å‘ç”Ÿé”™è¯¯æ—¶çš„æ¢å¤æ“ä½œ
    - name: æ¢å¤å¤‡ä»½ç‰ˆæœ¬
      command: cp -r /opt/myapp-backup /opt/myapp
      
    - name: å‘é€å¤±è´¥é€šçŸ¥
      mail:
        subject: "åº”ç”¨éƒ¨ç½²å¤±è´¥"
        body: "éƒ¨ç½²è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œå·²æ¢å¤åˆ°å¤‡ä»½ç‰ˆæœ¬"
        
  always:
    # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œçš„æ¸…ç†æ“ä½œ
    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      file:
        path: /tmp/deployment-*
        state: absent
        
    - name: è®°å½•éƒ¨ç½²æ—¥å¿—
      lineinfile:
        path: /var/log/deployment.log
        line: "{{ ansible_date_time.iso8601 }} - éƒ¨ç½²å°è¯•å®Œæˆ"
```

**ğŸ”¸ é‡è¯•æœºåˆ¶**
```yaml
- name: ä¸‹è½½å¤§æ–‡ä»¶ï¼ˆå¸¦é‡è¯•ï¼‰
  get_url:
    url: https://example.com/large-file.tar.gz
    dest: /tmp/large-file.tar.gz
  register: download_result
  until: download_result is succeeded
  retries: 3              # é‡è¯•3æ¬¡
  delay: 10              # æ¯æ¬¡é‡è¯•é—´éš”10ç§’
  
- name: ç­‰å¾…æœåŠ¡å¯åŠ¨
  wait_for:
    host: "{{ app_host }}"
    port: "{{ app_port }}"
    state: started
    timeout: 60           # 60ç§’è¶…æ—¶
  register: service_check
  until: service_check is succeeded
  retries: 5
  delay: 5
```

### 7.4 å…¨å±€é”™è¯¯å¤„ç†ç­–ç•¥


**ğŸ”¸ Playçº§åˆ«é”™è¯¯æ§åˆ¶**
```yaml
- name: å…³é”®æœåŠ¡éƒ¨ç½²
  hosts: production_servers
  become: yes
  any_errors_fatal: true    # ä»»ä½•ä¸»æœºå¤±è´¥éƒ½åœæ­¢æ•´ä¸ªPlay
  max_fail_percentage: 25   # å…è®¸25%çš„ä¸»æœºå¤±è´¥
  
  tasks:
    - name: éƒ¨ç½²å…³é”®æ›´æ–°
      copy:
        src: critical-update.sh
        dest: /tmp/update.sh
        mode: '0755'
      run_once: true         # åªåœ¨ä¸€å°ä¸»æœºä¸Šè¿è¡Œ
      delegate_to: "{{ groups['production_servers'][0] }}"
```

---

## 8. ğŸ” Playbookè°ƒè¯•æŠ€å·§


### 8.1 åŸºæœ¬è°ƒè¯•æ–¹æ³•


**ğŸ”¸ ä½¿ç”¨debugæ¨¡å—æ˜¾ç¤ºä¿¡æ¯**
```yaml
- name: æ˜¾ç¤ºå˜é‡å€¼
  debug:
    msg: "åº”ç”¨åç§°: {{ app_name }}, ç«¯å£: {{ app_port }}"
    
- name: æ˜¾ç¤ºä¸»æœºä¿¡æ¯
  debug:
    var: ansible_all_ipv4_addresses  # æ˜¾ç¤ºå˜é‡å†…å®¹
    
- name: æ¡ä»¶è°ƒè¯•
  debug:
    msg: "è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒ"
  when: app_env == "production"
```

**ğŸ”¸ å‘½ä»¤è¡Œè°ƒè¯•é€‰é¡¹**
```bash
# è¯¦ç»†è¾“å‡ºæ¨¡å¼
ansible-playbook -v site.yml         # åŸºæœ¬è¯¦ç»†ä¿¡æ¯
ansible-playbook -vv site.yml        # æ›´å¤šè¯¦ç»†ä¿¡æ¯  
ansible-playbook -vvv site.yml       # åŒ…å«è¿æ¥è°ƒè¯•
ansible-playbook -vvvv site.yml      # åŒ…å«SSHè°ƒè¯•

# æ£€æŸ¥æ¨¡å¼ï¼ˆä¸å®é™…æ‰§è¡Œï¼‰
ansible-playbook --check site.yml    # æ¨¡æ‹Ÿæ‰§è¡Œ
ansible-playbook --diff site.yml     # æ˜¾ç¤ºæ–‡ä»¶å˜æ›´å·®å¼‚

# è¯­æ³•æ£€æŸ¥
ansible-playbook --syntax-check site.yml

# åˆ—å‡ºä»»åŠ¡
ansible-playbook --list-tasks site.yml

# åˆ—å‡ºä¸»æœº
ansible-playbook --list-hosts site.yml
```

### 8.2 é«˜çº§è°ƒè¯•æŠ€å·§


**ğŸ”¸ ä½¿ç”¨assertéªŒè¯æ¡ä»¶**
```yaml
- name: éªŒè¯å¿…éœ€å˜é‡å·²å®šä¹‰
  assert:
    that:
      - app_name is defined
      - app_port is defined
      - app_port > 1024
      - app_port < 65536
    fail_msg: "åº”ç”¨é…ç½®å‚æ•°ä¸æ­£ç¡®"
    success_msg: "åº”ç”¨é…ç½®éªŒè¯é€šè¿‡"
    
- name: éªŒè¯ç³»ç»Ÿè¦æ±‚
  assert:
    that:
      - ansible_memtotal_mb >= 2048    # è‡³å°‘2GBå†…å­˜
      - ansible_processor_vcpus >= 2   # è‡³å°‘2ä¸ªCPUæ ¸å¿ƒ
    fail_msg: "ç³»ç»Ÿèµ„æºä¸è¶³ï¼Œéœ€è¦è‡³å°‘2GBå†…å­˜å’Œ2ä¸ªCPUæ ¸å¿ƒ"
```

**ğŸ”¸ ä½¿ç”¨registeræ•è·æ‰§è¡Œç»“æœ**
```yaml
- name: æ‰§è¡Œå¤æ‚å‘½ä»¤
  shell: |
    find /var/log -name "*.log" -mtime +7 -exec ls -la {} \;
  register: old_logs
  changed_when: false      # æŸ¥è¯¢æ“ä½œä¸ç®—å˜æ›´
  
- name: æ˜¾ç¤ºæŸ¥æ‰¾ç»“æœ
  debug:
    var: old_logs.stdout_lines
  when: old_logs.stdout_lines | length > 0
  
- name: æ£€æŸ¥å‘½ä»¤æ‰§è¡Œç»“æœ
  debug:
    msg: |
      å‘½ä»¤è¿”å›ç : {{ old_logs.rc }}
      æ ‡å‡†è¾“å‡ºè¡Œæ•°: {{ old_logs.stdout_lines | length }}
      æ ‡å‡†é”™è¯¯: {{ old_logs.stderr }}
```

**ğŸ”¸ åˆ†æ®µæ‰§è¡Œå’Œæµ‹è¯•**
```yaml
# ä½¿ç”¨tagsåˆ†æ®µæ‰§è¡Œ
- name: å‡†å¤‡ç¯å¢ƒ
  package:
    name: git
    state: present
  tags: preparation
  
- name: éƒ¨ç½²åº”ç”¨
  git:
    repo: https://github.com/company/app.git
    dest: /opt/app
  tags: deployment
  
- name: é…ç½®æœåŠ¡
  template:
    src: app.service.j2
    dest: /etc/systemd/system/app.service
  tags: configuration

# åªæ‰§è¡Œç‰¹å®šæ ‡ç­¾
# ansible-playbook --tags "preparation" site.yml
# ansible-playbook --skip-tags "deployment" site.yml
```

### 8.3 è°ƒè¯•å¤æ‚é—®é¢˜


**ğŸ”¸ é€æ­¥è°ƒè¯•ç­–ç•¥**
```yaml
# 1. å…ˆæ£€æŸ¥è¿æ¥
- name: æµ‹è¯•è¿æ¥
  ping:
  
# 2. æ£€æŸ¥åŸºæœ¬ä¿¡æ¯
- name: æ”¶é›†ç³»ç»Ÿä¿¡æ¯
  setup:
  register: system_facts
  
- name: æ˜¾ç¤ºå…³é”®ç³»ç»Ÿä¿¡æ¯
  debug:
    msg: |
      æ“ä½œç³»ç»Ÿ: {{ ansible_distribution }} {{ ansible_distribution_version }}
      å†…å­˜: {{ ansible_memtotal_mb }}MB
      CPU: {{ ansible_processor_vcpus }}æ ¸
      ç£ç›˜ç©ºé—´: {{ ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first | int / (1024*1024*1024) | round(2) }}GBå¯ç”¨

# 3. éªŒè¯å‰ç½®æ¡ä»¶
- name: æ£€æŸ¥å¿…éœ€çš„ç«¯å£æ˜¯å¦å¯ç”¨
  wait_for:
    port: "{{ app_port }}"
    state: stopped
    timeout: 5
  ignore_errors: yes
  register: port_check
  
- name: ç«¯å£å ç”¨æ£€æŸ¥ç»“æœ
  debug:
    msg: "ç«¯å£{{ app_port }}{{ 'å¯ç”¨' if port_check is succeeded else 'è¢«å ç”¨' }}"
```

**ğŸ”¸ é”™è¯¯è¿½è¸ªæ¨¡æ¿**
```yaml
- name: è®°å½•æ“ä½œå¼€å§‹
  debug:
    msg: "å¼€å§‹æ‰§è¡Œ: {{ ansible_play_name }} - {{ ansible_task_name }}"
  
- name: æ‰§è¡Œä¸»è¦æ“ä½œ
  command: "{{ complex_command }}"
  register: operation_result
  failed_when: false  # å…ˆä¸è®©å®ƒå¤±è´¥ï¼Œæˆ‘ä»¬æ‰‹åŠ¨æ£€æŸ¥
  
- name: åˆ†ææ‰§è¡Œç»“æœ
  debug:
    msg: |
      ======= æ‰§è¡Œç»“æœåˆ†æ =======
      å‘½ä»¤: {{ complex_command }}
      è¿”å›ç : {{ operation_result.rc }}
      æ‰§è¡Œæ—¶é—´: {{ operation_result.delta }}
      æ ‡å‡†è¾“å‡º: {{ operation_result.stdout }}
      æ ‡å‡†é”™è¯¯: {{ operation_result.stderr }}
      ========================
      
- name: æ ¹æ®ç»“æœå†³å®šæ˜¯å¦å¤±è´¥
  fail:
    msg: "æ“ä½œå¤±è´¥: {{ operation_result.stderr }}"
  when: 
    - operation_result.rc != 0
    - operation_result.stderr is defined
    - operation_result.stderr != ""
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºç¡€æ¦‚å¿µ


```yaml
æ ¸å¿ƒè¦ç´ :
ğŸ”¸ YAMLè¯­æ³•: ç¼©è¿›è¡¨ç¤ºå±‚çº§ï¼Œå†’å·åè¦ç©ºæ ¼ï¼Œåˆ—è¡¨ç”¨çŸ­æ¨ªçº¿
ğŸ”¸ Playç»“æ„: name-hosts-tasksçš„åŸºæœ¬æ¡†æ¶ï¼Œä¸€ä¸ªPlayé’ˆå¯¹ä¸€ç»„ä¸»æœº
ğŸ”¸ Taskè®¾è®¡: æ¯ä¸ªä»»åŠ¡è¦æœ‰æ¸…æ™°æè¿°ï¼Œå…·å¤‡å¹‚ç­‰æ€§
ğŸ”¸ å˜é‡ä½¿ç”¨: é¿å…ç¡¬ç¼–ç ï¼Œç†è§£ä½œç”¨åŸŸå’Œä¼˜å…ˆçº§
ğŸ”¸ æ¡ä»¶å¾ªç¯: whenåˆ¤æ–­æ‰§è¡Œæ¡ä»¶ï¼Œloopå¤„ç†æ‰¹é‡æ“ä½œ
ğŸ”¸ Handleræœºåˆ¶: åªåœ¨æœ‰å˜åŒ–æ—¶è§¦å‘ï¼Œåœ¨æ‰€æœ‰ä»»åŠ¡åæ‰§è¡Œ
```

### 9.2 æœ€ä½³å®è·µè¦ç‚¹


**ğŸ”¹ ä»£ç ç»„ç»‡åŸåˆ™**
```
ç»“æ„åŒ–åŸåˆ™:
â€¢ ä¸€ä¸ªPlaybookä¸“æ³¨ä¸€ä¸ªç›®æ ‡ï¼ˆéƒ¨ç½²WebæœåŠ¡å™¨ï¼‰
â€¢ æŠŠå¤æ‚é€»è¾‘æ‹†åˆ†åˆ°ç‹¬ç«‹æ–‡ä»¶ï¼ˆtasks/handlers/varsåˆ†ç¦»ï¼‰
â€¢ ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°ï¼ˆä¸è¦task1ã€task2è¿™æ ·å‘½åï¼‰
â€¢ æ·»åŠ é€‚å½“æ³¨é‡Šè¯´æ˜å¤æ‚é€»è¾‘
```

**ğŸ”¹ å˜é‡ç®¡ç†åŸåˆ™**
```
å˜é‡è®¾è®¡:
â€¢ ä½¿ç”¨group_varså’Œhost_varsç»„ç»‡å˜é‡
â€¢ æ•æ„Ÿä¿¡æ¯ç”¨ansible-vaultåŠ å¯†
â€¢ ä¸ºä¸åŒç¯å¢ƒåˆ›å»ºä¸åŒçš„å˜é‡æ–‡ä»¶
â€¢ è®¾ç½®åˆç†çš„é»˜è®¤å€¼é¿å…undefinedé”™è¯¯
```

**ğŸ”¹ é”™è¯¯å¤„ç†åŸåˆ™**
```
å®¹é”™è®¾è®¡:
â€¢ å…³é”®ä»»åŠ¡ä½¿ç”¨block/rescue/alwaysç»“æ„
â€¢ ç½‘ç»œæ“ä½œæ·»åŠ é‡è¯•æœºåˆ¶
â€¢ ä½¿ç”¨assertéªŒè¯é‡è¦å‰ç½®æ¡ä»¶  
â€¢ ä¸ºå¯èƒ½å¤±è´¥çš„ä»»åŠ¡æä¾›å›é€€æ–¹æ¡ˆ
```

### 9.3 è°ƒè¯•ä¸ç»´æŠ¤æŠ€å·§


**ğŸ”¹ å¼€å‘é˜¶æ®µ**
```bash
# å¼€å‘æ—¶çš„è°ƒè¯•æµç¨‹
ansible-playbook --syntax-check playbook.yml  # è¯­æ³•æ£€æŸ¥
ansible-playbook --check playbook.yml         # æ¨¡æ‹Ÿæ‰§è¡Œ  
ansible-playbook -vv playbook.yml             # è¯¦ç»†æ‰§è¡Œ
```

**ğŸ”¹ ç”Ÿäº§ç¯å¢ƒ**
```yaml
# ç”Ÿäº§ç¯å¢ƒçš„å®‰å…¨æªæ–½
- name: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç¡®è®¤
  pause:
    prompt: "ç¡®è®¤åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œéƒ¨ç½²ï¼Ÿ(yes/no)"
  when: app_env == "production"
  
- name: åˆ›å»ºéƒ¨ç½²æ—¥å¿—
  lineinfile:
    path: /var/log/ansible-deployments.log  
    line: "{{ ansible_date_time.iso8601 }} - {{ ansible_user }} - {{ ansible_play_name }}"
```

### 9.4 å­¦ä¹ è¿›é˜¶è·¯å¾„


**ğŸ“š æŒæ¡é¡ºåºå»ºè®®**
```
å­¦ä¹ è·¯å¾„:
1. åŸºç¡€è¯­æ³• â†’ YAML + åŸºæœ¬Playç»“æ„
2. å˜é‡ä½¿ç”¨ â†’ ç†è§£ä½œç”¨åŸŸå’Œä¼˜å…ˆçº§
3. æ¡ä»¶å¾ªç¯ â†’ whenè¯­å¥å’Œloopè¯­å¥  
4. é”™è¯¯å¤„ç† â†’ ignore_errorså’Œblockç»“æ„
5. ä»£ç ç»„ç»‡ â†’ include/importå’Œroles
6. é«˜çº§ç‰¹æ€§ â†’ vaultåŠ å¯†å’ŒåŠ¨æ€æ¸…å•
```

**ğŸ¯ å®è·µé¡¹ç›®å»ºè®®**
```
ç»ƒæ‰‹é¡¹ç›®:
â€¢ åŸºç¡€: éƒ¨ç½²LAMPç¯å¢ƒï¼ˆLinux+Apache+MySQL+PHPï¼‰
â€¢ è¿›é˜¶: å¤šç¯å¢ƒåº”ç”¨éƒ¨ç½²ï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰
â€¢ é«˜çº§: å®¹å™¨åŒ–åº”ç”¨ç¼–æ’å’Œæ»šåŠ¨æ›´æ–°
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Playbookæ˜¯å‰§æœ¬ï¼ŒPlayæ˜¯å‰§ç›®ï¼ŒTaskæ˜¯åŠ¨ä½œ
- å˜é‡è®©é…ç½®çµæ´»ï¼Œæ¡ä»¶è®©æ‰§è¡Œæ™ºèƒ½ï¼Œå¾ªç¯è®©æ“ä½œé«˜æ•ˆ
- Handleråªåœ¨å˜åŒ–æ—¶è§¦å‘ï¼Œé”™è¯¯å¤„ç†ä¿è¯ç¨³å®šæ€§
- æ¨¡å—åŒ–ç»„ç»‡ä»£ç ï¼Œè°ƒè¯•å·¥å…·æ‰¾é—®é¢˜
- å¹‚ç­‰æ€§æ˜¯åŸºç¡€ï¼Œå¯é‡å¤æ‰§è¡Œæ˜¯ç›®æ ‡