---
title: 7ã€Ansible-Roleè§’è‰²ç®¡ç†
---
## ðŸ“š ç›®å½•

1. [Ansible RoleåŸºç¡€æ¦‚å¿µ](#1-ansible-roleåŸºç¡€æ¦‚å¿µ)
2. [Roleç›®å½•ç»“æž„æ ‡å‡†](#2-roleç›®å½•ç»“æž„æ ‡å‡†)
3. [Roleå˜é‡ç®¡ç†ç­–ç•¥](#3-roleå˜é‡ç®¡ç†ç­–ç•¥)
4. [ä¾èµ–å…³ç³»å®šä¹‰ä¸Žç®¡ç†](#4-ä¾èµ–å…³ç³»å®šä¹‰ä¸Žç®¡ç†)
5. [Roleå¤ç”¨ä¸Žç»§æ‰¿æœºåˆ¶](#5-roleå¤ç”¨ä¸Žç»§æ‰¿æœºåˆ¶)
6. [Ansible Galaxyå®žæˆ˜åº”ç”¨](#6-ansible-galaxyå®žæˆ˜åº”ç”¨)
7. [Roleç‰ˆæœ¬æŽ§åˆ¶ç®¡ç†](#7-roleç‰ˆæœ¬æŽ§åˆ¶ç®¡ç†)
8. [Roleæµ‹è¯•ä¸ŽéªŒè¯ä½“ç³»](#8-roleæµ‹è¯•ä¸ŽéªŒè¯ä½“ç³»)
9. [ä¼ä¸šçº§Roleç»„ç»‡æž¶æž„](#9-ä¼ä¸šçº§roleç»„ç»‡æž¶æž„)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸŽ¯ Ansible RoleåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Ansible Role


**Roleæœ¬è´¨ç†è§£**ï¼šRoleï¼ˆè§’è‰²ï¼‰å°±æ˜¯æŠŠç›¸å…³çš„ä»»åŠ¡ã€å˜é‡ã€æ–‡ä»¶ç­‰**æ‰“åŒ…ç»„ç»‡**èµ·æ¥çš„ä¸€ä¸ªåŠŸèƒ½å•å…ƒã€‚

```
ç®€å•ç†è§£ï¼š
æ™®é€šPlaybook = ä¸€ä¸ªè„šæœ¬æ–‡ä»¶ï¼Œæ‰€æœ‰å†…å®¹éƒ½å†™åœ¨ä¸€èµ·
Role = ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼ŒæŠŠåŠŸèƒ½æŒ‰ç±»åž‹åˆ†é—¨åˆ«ç±»å­˜æ”¾

å°±åƒæ•´ç†æˆ¿é—´ï¼š
- è¡£æœæ”¾è¡£æŸœ
- ä¹¦ç±æ”¾ä¹¦æž¶  
- æ–‡ä»¶æ”¾æ–‡ä»¶æŸœ
```

**ðŸ”¸ Roleè§£å†³çš„é—®é¢˜**
- **ä»£ç é‡å¤** â†’ ä¸€æ¬¡ç¼–å†™ï¼Œåˆ°å¤„ä½¿ç”¨
- **ç»“æž„æ··ä¹±** â†’ æ ‡å‡†åŒ–çš„ç›®å½•ç»“æž„
- **ç»´æŠ¤å›°éš¾** â†’ æ¨¡å—åŒ–ç®¡ç†
- **å›¢é˜Ÿåä½œ** â†’ ç»Ÿä¸€çš„å¼€å‘è§„èŒƒ

### 1.2 Role vs Playbookå¯¹æ¯”


| ç‰¹æ€§ | **æ™®é€šPlaybook** | **Roleè§’è‰²** |
|------|-----------------|-------------|
| ðŸ—ï¸ **ç»“æž„** | `å•ä¸ªæ–‡ä»¶ï¼Œå†…å®¹æ··åˆ` | `æ ‡å‡†ç›®å½•ç»“æž„ï¼Œåˆ†ç±»å­˜æ”¾` |
| ðŸ”„ **å¤ç”¨æ€§** | `éš¾ä»¥å¤ç”¨ï¼Œéœ€è¦å¤åˆ¶ç²˜è´´` | `é«˜åº¦å¯å¤ç”¨ï¼Œå¯¼å…¥å³ç”¨` |
| ðŸ‘¥ **åä½œ** | `å¤šäººä¿®æ”¹å®¹æ˜“å†²çª` | `æ¨¡å—åŒ–å¼€å‘ï¼Œç‹¬ç«‹ç»´æŠ¤` |
| ðŸ“Š **ç»´æŠ¤** | `å†…å®¹å¤æ‚æ—¶éš¾ä»¥ç»´æŠ¤` | `èŒè´£å•ä¸€ï¼Œæ˜“äºŽç»´æŠ¤` |
| ðŸŽ¯ **æµ‹è¯•** | `æ•´ä½“æµ‹è¯•ï¼Œå®šä½é—®é¢˜å›°éš¾` | `å•ç‹¬æµ‹è¯•ï¼Œé—®é¢˜éš”ç¦»` |

### 1.3 Roleçš„å·¥ä½œåŽŸç†


```
Roleæ‰§è¡Œæµç¨‹ï¼š

1. åŠ è½½Roleç›®å½• â†’ è¯»å–meta/main.ymlç¡®å®šä¾èµ–
2. æ‰§è¡Œä¾èµ–Role â†’ å…ˆæ‰§è¡Œdependenciesä¸­çš„Role  
3. åŠ è½½å˜é‡ â†’ defaults â†’ vars â†’ group_vars â†’ host_vars
4. æ‰§è¡Œä»»åŠ¡ â†’ tasks/main.ymlä¸­çš„ä»»åŠ¡åˆ—è¡¨
5. è§¦å‘å¤„ç†å™¨ â†’ éœ€è¦æ—¶æ‰§è¡Œhandlersä¸­çš„å¤„ç†å™¨
6. å¤åˆ¶æ–‡ä»¶ â†’ fileså’Œtemplatesä¸­çš„èµ„æºæ–‡ä»¶

æ‰§è¡Œé¡ºåºï¼šä¾èµ–Role â†’ å½“å‰Roleä»»åŠ¡ â†’ å¤„ç†å™¨
```

---

## 2. ðŸ“ Roleç›®å½•ç»“æž„æ ‡å‡†


### 2.1 æ ‡å‡†ç›®å½•ç»“æž„è§£æž


```
my-role/                    â† Roleæ ¹ç›®å½•
â”œâ”€â”€ README.md              â† Roleè¯´æ˜Žæ–‡æ¡£
â”œâ”€â”€ meta/                  â† å…ƒæ•°æ®ç›®å½•
â”‚   â””â”€â”€ main.yml          â† Roleä¾èµ–å’Œä¿¡æ¯å®šä¹‰
â”œâ”€â”€ defaults/              â† é»˜è®¤å˜é‡ç›®å½•  
â”‚   â””â”€â”€ main.yml          â† é»˜è®¤å˜é‡å®šä¹‰
â”œâ”€â”€ vars/                  â† å˜é‡ç›®å½•
â”‚   â””â”€â”€ main.yml          â† Roleå˜é‡å®šä¹‰
â”œâ”€â”€ tasks/                 â† ä»»åŠ¡ç›®å½•
â”‚   â””â”€â”€ main.yml          â† ä¸»ä»»åŠ¡æ–‡ä»¶
â”œâ”€â”€ handlers/              â† å¤„ç†å™¨ç›®å½•
â”‚   â””â”€â”€ main.yml          â† äº‹ä»¶å¤„ç†å™¨å®šä¹‰
â”œâ”€â”€ files/                 â† é™æ€æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ config.conf       â† é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ script.sh         â† è„šæœ¬æ–‡ä»¶
â”œâ”€â”€ templates/             â† æ¨¡æ¿æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ app.conf.j2       â† Jinja2æ¨¡æ¿æ–‡ä»¶
â”œâ”€â”€ library/               â† è‡ªå®šä¹‰æ¨¡å—ç›®å½•
â”œâ”€â”€ module_utils/          â† æ¨¡å—å·¥å…·ç›®å½•
â””â”€â”€ tests/                 â† æµ‹è¯•ç›®å½•
    â”œâ”€â”€ inventory         â† æµ‹è¯•ç”¨ä¸»æœºæ¸…å•
    â””â”€â”€ test.yml          â† æµ‹è¯•Playbook
```

### 2.2 æ ¸å¿ƒç›®å½•è¯¦è§£


**ðŸ”¸ tasksç›®å½• - ä»»åŠ¡æ ¸å¿ƒ**
```yaml
# tasks/main.yml - ä¸»ä»»åŠ¡æ–‡ä»¶
---
- name: ç¡®ä¿è½¯ä»¶åŒ…å·²å®‰è£…
  package:
    name: "{{ app_packages }}"
    state: present

- name: å¯¼å…¥é…ç½®ä»»åŠ¡
  import_tasks: configure.yml

- name: å¯¼å…¥æœåŠ¡ä»»åŠ¡  
  import_tasks: service.yml
```

**ðŸ”¸ defaultsç›®å½• - é»˜è®¤é…ç½®**
```yaml
# defaults/main.yml - å¯è¢«è¦†ç›–çš„é»˜è®¤å€¼
---
app_packages:
  - nginx
  - vim
  
app_user: webapp
app_port: 8080
app_debug: false
```

**ðŸ”¸ varsç›®å½• - å›ºå®šå˜é‡**
```yaml
# vars/main.yml - ä¸åº”è¢«è¦†ç›–çš„å˜é‡
---
app_config_dir: /etc/myapp
app_log_dir: /var/log/myapp
app_service_name: myapp
```

### 2.3 æ–‡ä»¶å‘½åè§„èŒƒ


**ðŸ“‹ å‘½åè§„åˆ™**
- **ä¸»æ–‡ä»¶** â†’ `main.yml`ï¼ˆå¿…é¡»å­˜åœ¨ï¼‰
- **ä»»åŠ¡æ‹†åˆ†** â†’ `install.yml`, `configure.yml`, `service.yml`
- **ç³»ç»ŸåŒºåˆ†** â†’ `RedHat.yml`, `Debian.yml`, `main.yml`
- **æ¨¡æ¿æ–‡ä»¶** â†’ `*.j2`æ‰©å±•å
- **æµ‹è¯•æ–‡ä»¶** â†’ `test_*.yml`

---

## 3. ðŸ”§ Roleå˜é‡ç®¡ç†ç­–ç•¥


### 3.1 å˜é‡ä¼˜å…ˆçº§ç†è§£


**å˜é‡ä¼˜å…ˆçº§æŽ’åº**ï¼ˆæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰ï¼š
```
1. defaults/main.yml           â† æœ€ä½Žä¼˜å…ˆçº§ï¼ˆé»˜è®¤å€¼ï¼‰
2. inventoryæ–‡ä»¶ä¸­çš„å˜é‡
3. inventoryä¸­group_vars
4. inventoryä¸­host_vars  
5. playbookä¸­group_vars
6. playbookä¸­host_vars
7. host factsï¼ˆç³»ç»Ÿä¿¡æ¯ï¼‰
8. registered variablesï¼ˆæ³¨å†Œå˜é‡ï¼‰
9. set_factsï¼ˆè®¾å®šå˜é‡ï¼‰
10. vars/main.yml              â† Roleå†…éƒ¨å˜é‡
11. playbookä¸­vars
12. playbookä¸­vars_prompt
13. playbookä¸­vars_files
14. --extra-vars              â† æœ€é«˜ä¼˜å…ˆçº§ï¼ˆå‘½ä»¤è¡Œï¼‰
```

### 2 å˜é‡åˆ†å±‚ç®¡ç†å®žè·µ


**ðŸŽ¯ ä¸‰å±‚å˜é‡ä½“ç³»**

```yaml
# defaults/main.yml - ç¬¬ä¸€å±‚ï¼šé€šç”¨é»˜è®¤å€¼
---
# åº”ç”¨åŸºç¡€é…ç½®
app_name: myapp
app_version: "1.0.0" 
app_port: 8080
app_user: "{{ app_name }}"

# ç³»ç»Ÿé…ç½®
system_packages:
  - vim
  - curl
  - wget

# å®‰å…¨é…ç½®
security_enabled: true
firewall_enabled: false
```

```yaml
# vars/main.yml - ç¬¬äºŒå±‚ï¼šRoleå†…éƒ¨é€»è¾‘å˜é‡
---
# è·¯å¾„å˜é‡ï¼ˆä¸åº”è¢«ç”¨æˆ·ä¿®æ”¹ï¼‰
app_home: "/opt/{{ app_name }}"
app_config_file: "{{ app_home }}/config/app.conf"
app_log_file: "/var/log/{{ app_name }}/app.log"

# ç³»ç»Ÿç›¸å…³å˜é‡
app_service_file: "/etc/systemd/system/{{ app_name }}.service"
```

```yaml
# ç¬¬ä¸‰å±‚ï¼šçŽ¯å¢ƒç‰¹å®šå˜é‡ï¼ˆé€šè¿‡inventoryæˆ–playbookä¼ å…¥ï¼‰
# group_vars/production.yml
---
app_debug: false
app_log_level: "WARN"
database_host: "prod-db.company.com"

# group_vars/development.yml  
---
app_debug: true
app_log_level: "DEBUG"
database_host: "dev-db.company.com"
```

### 3.3 å˜é‡å‘½åè§„èŒƒ


**ðŸ”¸ å‘½åçº¦å®š**
- **Roleå‰ç¼€** â†’ `rolename_variable_name`
- **åˆ†ç»„å‘½å** â†’ `app_config_*`, `db_connection_*`
- **å¸ƒå°”å˜é‡** â†’ `enabled/disabled`, `with_*/without_*`
- **åˆ—è¡¨å˜é‡** â†’ `*_list`, `*_packages`, `*_users`

```yaml
# è‰¯å¥½çš„å‘½åç¤ºä¾‹
nginx_worker_processes: 4
nginx_client_max_body_size: 10M
nginx_ssl_enabled: true
nginx_upstream_servers:
  - 192.168.1.10:8080
  - 192.168.1.11:8080
```

---

## 4. ðŸ”— ä¾èµ–å…³ç³»å®šä¹‰ä¸Žç®¡ç†


### 4.1 ä¾èµ–å…³ç³»åŸºç¡€


**meta/main.ymlç»“æž„**ï¼š
```yaml
---
# Roleå…ƒä¿¡æ¯
galaxy_info:
  author: "Your Name"
  description: "Webåº”ç”¨éƒ¨ç½²Role"
  company: "Your Company"
  license: "MIT"
  min_ansible_version: 2.9
  
  platforms:
    - name: EL
      versions:
        - 7
        - 8
    - name: Ubuntu
      versions:
        - 18.04
        - 20.04
  
  galaxy_tags:
    - web
    - nginx
    - deployment

# ä¾èµ–å®šä¹‰
dependencies:
  - role: geerlingguy.firewall
    when: firewall_enabled
  - role: common-packages
  - role: user-management
    vars:
      users:
        - name: "{{ app_user }}"
          system: true
```

### 4.2 ä¾èµ–æ‰§è¡Œé¡ºåº


```
ä¾èµ–æ‰§è¡Œæµç¨‹ï¼š

ä¸»Role: web-app
ä¾èµ–: [firewall, common-packages, user-management]

æ‰§è¡Œé¡ºåºï¼š
1. firewall Roleï¼ˆå¦‚æžœfirewall_enabled=trueï¼‰
   â”œâ”€â”€ firewall/tasks/main.yml
   â”œâ”€â”€ firewall/handlers/main.yml
   
2. common-packages Role  
   â”œâ”€â”€ common-packages/tasks/main.yml
   
3. user-management Role
   â”œâ”€â”€ user-management/tasks/main.yml
   
4. web-app Roleï¼ˆä¸»Roleï¼‰
   â”œâ”€â”€ web-app/tasks/main.yml
   â”œâ”€â”€ web-app/handlers/main.yml
```

### 4.3 æ¡ä»¶ä¾èµ–ç®¡ç†


```yaml
# æ™ºèƒ½ä¾èµ–ç®¡ç†ç¤ºä¾‹
dependencies:
  # åŸºç¡€ç³»ç»ŸRole - æ€»æ˜¯æ‰§è¡Œ
  - role: system-basic
    
  # æ•°æ®åº“Role - ä»…å½“éœ€è¦æ•°æ®åº“æ—¶
  - role: mysql
    when: database_type == "mysql"
    
  - role: postgresql  
    when: database_type == "postgresql"
    
  # è´Ÿè½½å‡è¡¡ - ä»…åœ¨ç”Ÿäº§çŽ¯å¢ƒ
  - role: haproxy
    when: 
      - inventory_hostname in groups['loadbalancer']
      - environment_type == "production"
    vars:
      haproxy_backend_servers: "{{ groups['webservers'] }}"
```

---

## 5. ðŸ”„ Roleå¤ç”¨ä¸Žç»§æ‰¿æœºåˆ¶


### 5.1 Roleå¤ç”¨ç­–ç•¥


**ðŸŽ¯ å¤ç”¨åœºæ™¯åˆ†ç±»**ï¼š

```
1. å®Œå…¨å¤ç”¨ï¼šç›´æŽ¥ä½¿ç”¨ï¼Œä¸åšä¿®æ”¹
   - é€šç”¨ç³»ç»Ÿé…ç½®Role
   - æ ‡å‡†è½¯ä»¶å®‰è£…Role
   
2. å‚æ•°åŒ–å¤ç”¨ï¼šé€šè¿‡å˜é‡å®šåˆ¶è¡Œä¸º  
   - WebæœåŠ¡å™¨Roleï¼ˆNginx/Apacheï¼‰
   - æ•°æ®åº“Roleï¼ˆMySQL/PostgreSQLï¼‰
   
3. ç»§æ‰¿æ‰©å±•ï¼šåŸºäºŽåŸºç¡€Roleæ‰©å±•
   - åŸºç¡€Javaåº”ç”¨ â†’ å…·ä½“Spring Bootåº”ç”¨
   - é€šç”¨ç›‘æŽ§ â†’ ç‰¹å®šåº”ç”¨ç›‘æŽ§
```

### 5.2 å‚æ•°åŒ–å¤ç”¨ç¤ºä¾‹


```yaml
# Role: database-server
# defaults/main.yml
---
db_type: mysql              # mysql, postgresql, mariadb
db_version: latest
db_port: 3306
db_root_password: ""
db_databases: []
db_users: []
db_config: {}

# ä½¿ç”¨æ—¶çš„å®šåˆ¶
# playbook.yml
---
- hosts: db-servers
  roles:
    - role: database-server
      vars:
        db_type: postgresql
        db_port: 5432
        db_databases:
          - name: webapp
            owner: webuser
        db_users:
          - name: webuser
            password: "{{ vault_db_password }}"
            privileges: "webapp.*:ALL"
```

### 5.3 Roleç»§æ‰¿å®žçŽ°


**ðŸ”¸ é€šè¿‡include_roleå®žçŽ°ç»§æ‰¿**ï¼š
```yaml
# advanced-web-app Roleç»§æ‰¿basic-web-app
# tasks/main.yml
---
# æ‰§è¡ŒåŸºç¡€Webåº”ç”¨è®¾ç½®
- include_role:
    name: basic-web-app
  vars:
    app_name: "{{ advanced_app_name }}"
    
# æ·»åŠ é«˜çº§åŠŸèƒ½
- name: é…ç½®é«˜çº§ç¼“å­˜
  template:
    src: redis.conf.j2
    dest: /etc/redis/redis.conf
  notify: restart redis

- name: é…ç½®è´Ÿè½½å‡è¡¡
  template:
    src: haproxy.cfg.j2  
    dest: /etc/haproxy/haproxy.cfg
  notify: restart haproxy
```

---

## 6. ðŸŒŸ Ansible Galaxyå®žæˆ˜åº”ç”¨


### 6.1 GalaxyåŸºç¡€æ¦‚å¿µ


**Ansible Galaxy**ï¼šAnsibleå®˜æ–¹çš„Roleåˆ†äº«å¹³å°ï¼Œç±»ä¼¼äºŽç¨‹åºå‘˜çš„GitHubï¼Œä½†ä¸“é—¨ç”¨æ¥åˆ†äº«Ansible Roleã€‚

```
Galaxyä½œç”¨ï¼š
ðŸ“¦ èŽ·å–Role â†’ ansible-galaxy install rolename
ðŸ” æœç´¢Role â†’ ansible-galaxy search keyword  
ðŸ“Š æŸ¥çœ‹ä¿¡æ¯ â†’ ansible-galaxy info rolename
ðŸš€ å‘å¸ƒRole â†’ ansible-galaxy import username repo-name
```

### 6.2 Galaxyå‘½ä»¤å®žæˆ˜


**ðŸ”¸ æœç´¢å’Œå®‰è£…Role**
```bash
# æœç´¢nginxç›¸å…³çš„Role
ansible-galaxy search nginx

# æŸ¥çœ‹Roleè¯¦ç»†ä¿¡æ¯
ansible-galaxy info geerlingguy.nginx

# å®‰è£…Roleåˆ°é»˜è®¤ç›®å½•ï¼ˆ~/.ansible/roles/ï¼‰
ansible-galaxy install geerlingguy.nginx

# å®‰è£…åˆ°æŒ‡å®šç›®å½•
ansible-galaxy install geerlingguy.nginx -p ./roles/

# å®‰è£…æŒ‡å®šç‰ˆæœ¬
ansible-galaxy install geerlingguy.nginx,2.8.0
```

**ðŸ”¸ requirements.ymlæ‰¹é‡ç®¡ç†**
```yaml
# requirements.yml - Roleä¾èµ–æ¸…å•
---
# ä»ŽGalaxyå®‰è£…
- name: geerlingguy.nginx
  version: 2.8.0
  
- name: geerlingguy.mysql
  version: 3.3.0

# ä»ŽGitä»“åº“å®‰è£…  
- src: https://github.com/company/custom-role.git
  name: custom-role
  version: main
  
# ä»Žæœ¬åœ°è·¯å¾„å®‰è£…
- src: /path/to/local/role
  name: local-role

# æ‰¹é‡å®‰è£…å‘½ä»¤
# ansible-galaxy install -r requirements.yml
```

### 6.3 ä¼ä¸šå†…éƒ¨Galaxy


**ðŸ¢ ç§æœ‰Galaxyéƒ¨ç½²**
```yaml
# ansible.cfgé…ç½®ç§æœ‰Galaxy
[galaxy]
server_list = company_galaxy, community_galaxy

[galaxy_server.company_galaxy]
url = https://galaxy.company.com/
username = your_username
password = your_token

[galaxy_server.community_galaxy] 
url = https://galaxy.ansible.com/
```

---

## 7. ðŸ“‹ Roleç‰ˆæœ¬æŽ§åˆ¶ç®¡ç†


### 7.1 ç‰ˆæœ¬æŽ§åˆ¶ç­–ç•¥


**ðŸ”¸ è¯­ä¹‰åŒ–ç‰ˆæœ¬æŽ§åˆ¶**
```
ç‰ˆæœ¬æ ¼å¼ï¼šMAJOR.MINOR.PATCH
- MAJORï¼šä¸å…¼å®¹çš„APIå˜æ›´
- MINORï¼šå‘åŽå…¼å®¹çš„åŠŸèƒ½æ€§æ–°å¢ž  
- PATCHï¼šå‘åŽå…¼å®¹çš„é—®é¢˜ä¿®æ­£

ç¤ºä¾‹ï¼š
1.0.0 â†’ åˆå§‹ç‰ˆæœ¬
1.1.0 â†’ æ–°å¢žé…ç½®é€‰é¡¹ï¼ˆå‘åŽå…¼å®¹ï¼‰
1.1.1 â†’ ä¿®å¤æ¨¡æ¿é”™è¯¯ï¼ˆè¡¥ä¸ç‰ˆæœ¬ï¼‰
2.0.0 â†’ é‡æž„ç›®å½•ç»“æž„ï¼ˆç ´åæ€§å˜æ›´ï¼‰
```

### 7.2 Gitæ ‡ç­¾ç®¡ç†


```bash
# Roleå¼€å‘å·¥ä½œæµ
git add .
git commit -m "feat: æ·»åŠ SSLè¯ä¹¦è‡ªåŠ¨ç»­æœŸåŠŸèƒ½"

# åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
git tag -a v1.2.0 -m "Release version 1.2.0"
git push origin v1.2.0

# æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬
git tag -l

# æ£€å‡ºç‰¹å®šç‰ˆæœ¬
git checkout v1.1.0
```

### 7.3 ç‰ˆæœ¬é”å®šå®žè·µ


```yaml
# ç”Ÿäº§çŽ¯å¢ƒï¼šé”å®šå…·ä½“ç‰ˆæœ¬
- name: geerlingguy.nginx  
  version: 2.8.0           # ç²¾ç¡®ç‰ˆæœ¬

# å¼€å‘çŽ¯å¢ƒï¼šå…è®¸å°ç‰ˆæœ¬æ›´æ–°
- name: geerlingguy.mysql
  version: ">=3.3.0,<4.0.0"  # ç‰ˆæœ¬èŒƒå›´

# æµ‹è¯•çŽ¯å¢ƒï¼šä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
- name: geerlingguy.redis
  # ä¸æŒ‡å®šç‰ˆæœ¬ï¼Œä½¿ç”¨æœ€æ–°
```

---

## 8. ðŸ§ª Roleæµ‹è¯•ä¸ŽéªŒè¯ä½“ç³»


### 8.1 æµ‹è¯•å±‚æ¬¡ç»“æž„


```
Roleæµ‹è¯•é‡‘å­—å¡”ï¼š

ðŸ”º é›†æˆæµ‹è¯•ï¼ˆIntegration Testï¼‰
   â”œâ”€â”€ å¤šRoleåä½œæµ‹è¯•
   â”œâ”€â”€ ç«¯åˆ°ç«¯åŠŸèƒ½éªŒè¯
   â””â”€â”€ æ€§èƒ½æµ‹è¯•
   
ðŸ”º å•å…ƒæµ‹è¯•ï¼ˆUnit Testï¼‰  
   â”œâ”€â”€ å•ä¸ªä»»åŠ¡éªŒè¯
   â”œâ”€â”€ æ¨¡æ¿æ¸²æŸ“æµ‹è¯•
   â””â”€â”€ å˜é‡å¤„ç†æµ‹è¯•
   
ðŸ”º è¯­æ³•æµ‹è¯•ï¼ˆSyntax Testï¼‰
   â”œâ”€â”€ YAMLè¯­æ³•æ£€æŸ¥
   â”œâ”€â”€ Jinja2æ¨¡æ¿è¯­æ³•
   â””â”€â”€ Ansible Lintæ£€æŸ¥
```

### 8.2 Moleculeæµ‹è¯•æ¡†æž¶


**ðŸ”¸ Moleculeå®‰è£…ä¸Žé…ç½®**
```bash
# å®‰è£…Molecule
pip install molecule molecule-docker

# åœ¨Roleç›®å½•ä¸­åˆå§‹åŒ–æµ‹è¯•
cd my-role
molecule init scenario default

# æµ‹è¯•ç›®å½•ç»“æž„
molecule/
â””â”€â”€ default/
    â”œâ”€â”€ converge.yml      # æµ‹è¯•playbook
    â”œâ”€â”€ molecule.yml      # æµ‹è¯•é…ç½®
    â”œâ”€â”€ prepare.yml       # å‰ç½®å‡†å¤‡
    â”œâ”€â”€ verify.yml        # éªŒè¯æµ‹è¯•
    â””â”€â”€ destroy.yml       # æ¸…ç†èµ„æº
```

**ðŸ”¸ Moleculeé…ç½®ç¤ºä¾‹**
```yaml
# molecule/default/molecule.yml
---
dependency:
  name: galaxy
driver:
  name: docker
platforms:
  - name: centos7
    image: centos:7
    command: /sbin/init
    privileged: true
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
  - name: ubuntu20
    image: ubuntu:20.04
    command: /sbin/init
    privileged: true
provisioner:
  name: ansible
  inventory:
    host_vars:
      centos7:
        ansible_python_interpreter: /usr/bin/python
verifier:
  name: ansible
```

### 8.3 æµ‹è¯•æ‰§è¡Œæµç¨‹


```bash
# å®Œæ•´æµ‹è¯•æµç¨‹
molecule test

# åˆ†æ­¥æµ‹è¯•å‘½ä»¤
molecule create      # åˆ›å»ºæµ‹è¯•å®žä¾‹
molecule prepare     # æ‰§è¡Œå‡†å¤‡ä»»åŠ¡
molecule converge    # æ‰§è¡ŒRole
molecule verify      # éªŒè¯ç»“æžœ
molecule destroy     # æ¸…ç†çŽ¯å¢ƒ

# å¼€å‘è°ƒè¯•æ¨¡å¼
molecule converge    # åªæ‰§è¡ŒRoleï¼Œä¸æ¸…ç†çŽ¯å¢ƒ
molecule login       # ç™»å½•æµ‹è¯•å®žä¾‹è¿›è¡Œè°ƒè¯•
```

---

## 9. ðŸ¢ ä¼ä¸šçº§Roleç»„ç»‡æž¶æž„


### 9.1 Roleåˆ†ç±»ç®¡ç†


**ðŸŽ¯ Roleåˆ†å±‚æž¶æž„**

```
ä¼ä¸šRoleç»„ç»‡ç»“æž„ï¼š

ðŸ“ roles/
â”œâ”€â”€ ðŸ”§ infrastructure/          # åŸºç¡€è®¾æ–½å±‚
â”‚   â”œâ”€â”€ system-basic           # ç³»ç»ŸåŸºç¡€é…ç½®
â”‚   â”œâ”€â”€ network-config         # ç½‘ç»œé…ç½®
â”‚   â”œâ”€â”€ security-hardening     # å®‰å…¨åŠ å›º
â”‚   â””â”€â”€ monitoring-base        # åŸºç¡€ç›‘æŽ§
â”‚   
â”œâ”€â”€ ðŸ—„ï¸ middleware/             # ä¸­é—´ä»¶å±‚  
â”‚   â”œâ”€â”€ nginx                  # WebæœåŠ¡å™¨
â”‚   â”œâ”€â”€ mysql                  # æ•°æ®åº“
â”‚   â”œâ”€â”€ redis                  # ç¼“å­˜
â”‚   â””â”€â”€ elasticsearch         # æœç´¢å¼•æ“Ž
â”‚   
â”œâ”€â”€ ðŸ“± application/            # åº”ç”¨å±‚
â”‚   â”œâ”€â”€ webapp-java           # Java Webåº”ç”¨
â”‚   â”œâ”€â”€ webapp-python         # Python Webåº”ç”¨  
â”‚   â”œâ”€â”€ microservice-base     # å¾®æœåŠ¡åŸºç¡€
â”‚   â””â”€â”€ api-gateway           # APIç½‘å…³
â”‚   
â””â”€â”€ ðŸŽ¯ business/              # ä¸šåŠ¡å±‚
    â”œâ”€â”€ ecommerce-platform    # ç”µå•†å¹³å°
    â”œâ”€â”€ payment-system        # æ”¯ä»˜ç³»ç»Ÿ
    â””â”€â”€ user-management       # ç”¨æˆ·ç®¡ç†
```

### 9.2 Roleå‘½åè§„èŒƒ


**ðŸ“‹ ä¼ä¸šå‘½åæ ‡å‡†**
```yaml
# å‘½åæ ¼å¼ï¼š[éƒ¨é—¨]-[ç±»åž‹]-[åŠŸèƒ½]
# ç¤ºä¾‹ï¼š
ops-infra-monitoring     # è¿ç»´éƒ¨-åŸºç¡€è®¾æ–½-ç›‘æŽ§
dev-app-springboot      # å¼€å‘éƒ¨-åº”ç”¨-SpringBoot  
sec-middleware-firewall  # å®‰å…¨éƒ¨-ä¸­é—´ä»¶-é˜²ç«å¢™

# ç‰ˆæœ¬ç®¡ç†
my-role/
â”œâ”€â”€ v1.0/              # ç¨³å®šç‰ˆæœ¬
â”œâ”€â”€ v2.0/              # æ–°ç‰ˆæœ¬
â””â”€â”€ develop/           # å¼€å‘ç‰ˆæœ¬
```

### 9.3 Roleæ²»ç†æµç¨‹


**ðŸ”„ Roleç”Ÿå‘½å‘¨æœŸç®¡ç†**

```
1. éœ€æ±‚æå‡º â†’ ä¸šåŠ¡éƒ¨é—¨æå‡ºRoleå¼€å‘éœ€æ±‚
   â”œâ”€â”€ éœ€æ±‚è¯„ä¼°
   â”œâ”€â”€ æŠ€æœ¯å¯è¡Œæ€§åˆ†æž
   â””â”€â”€ ä¼˜å…ˆçº§æŽ’åº

2. å¼€å‘é˜¶æ®µ â†’ è¿ç»´å›¢é˜Ÿå¼€å‘Role
   â”œâ”€â”€ è®¾è®¡Review
   â”œâ”€â”€ ä»£ç å¼€å‘
   â”œâ”€â”€ å•å…ƒæµ‹è¯•
   â””â”€â”€ æ–‡æ¡£ç¼–å†™

3. æµ‹è¯•éªŒè¯ â†’ è´¨é‡ä¿è¯
   â”œâ”€â”€ é›†æˆæµ‹è¯•
   â”œâ”€â”€ å®‰å…¨æ‰«æ
   â”œâ”€â”€ æ€§èƒ½æµ‹è¯•
   â””â”€â”€ ç”¨æˆ·éªŒæ”¶æµ‹è¯•

4. å‘å¸ƒä¸Šçº¿ â†’ æ­£å¼å‘å¸ƒ
   â”œâ”€â”€ ç‰ˆæœ¬å‘å¸ƒ
   â”œâ”€â”€ æ–‡æ¡£æ›´æ–°
   â”œâ”€â”€ åŸ¹è®­ç”¨æˆ·
   â””â”€â”€ ç›‘æŽ§åé¦ˆ

5. ç»´æŠ¤æ›´æ–° â†’ æŒç»­ç»´æŠ¤
   â”œâ”€â”€ Bugä¿®å¤
   â”œâ”€â”€ åŠŸèƒ½å¢žå¼º
   â”œâ”€â”€ ç‰ˆæœ¬å‡çº§
   â””â”€â”€ åºŸå¼ƒå¤„ç†
```

### 9.4 æƒé™æŽ§åˆ¶ä½“ç³»


**ðŸ” åˆ†çº§æƒé™ç®¡ç†**
```yaml
# Roleæƒé™çŸ©é˜µ
permissions:
  infrastructure_roles:
    - group: ops-team
      access: read-write
    - group: dev-team  
      access: read-only
      
  application_roles:
    - group: dev-team
      access: read-write
    - group: ops-team
      access: read-write
      
  business_roles:
    - group: business-owners
      access: read-write
    - group: ops-team
      access: execute-only
```

---

## 10. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ðŸ”¸ Roleæœ¬è´¨ï¼šæ¨¡å—åŒ–çš„ä»»åŠ¡ç»„ç»‡æ–¹å¼ï¼Œæé«˜ä»£ç å¤ç”¨æ€§
ðŸ”¸ ç›®å½•ç»“æž„ï¼šæ ‡å‡†åŒ–çš„æ–‡ä»¶ç»„ç»‡ï¼Œæ¯ä¸ªç›®å½•æœ‰ç‰¹å®šç”¨é€”
ðŸ”¸ å˜é‡ç®¡ç†ï¼šåˆ†å±‚æ¬¡çš„å˜é‡ä½“ç³»ï¼Œä¼˜å…ˆçº§æ˜Žç¡®
ðŸ”¸ ä¾èµ–å…³ç³»ï¼šRoleé—´çš„ä¾èµ–å®šä¹‰å’Œæ‰§è¡Œé¡ºåºæŽ§åˆ¶
ðŸ”¸ å¤ç”¨ç­–ç•¥ï¼šé€šè¿‡å‚æ•°åŒ–å’Œç»§æ‰¿å®žçŽ°ä»£ç å¤ç”¨
ðŸ”¸ ç‰ˆæœ¬æŽ§åˆ¶ï¼šè¯­ä¹‰åŒ–ç‰ˆæœ¬ç®¡ç†ï¼Œç¡®ä¿çŽ¯å¢ƒä¸€è‡´æ€§
ðŸ”¸ æµ‹è¯•éªŒè¯ï¼šå¤šå±‚æ¬¡æµ‹è¯•ä¿è¯Roleè´¨é‡
ðŸ”¸ ä¼ä¸šæ²»ç†ï¼šè§„èŒƒåŒ–çš„ç»„ç»‡æž¶æž„å’Œæµç¨‹ç®¡ç†
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ Role vs Playbookçš„æœ¬è´¨åŒºåˆ«**
```
æ€ç»´è½¬å˜ï¼š
ä»Ž "å†™è„šæœ¬" â†’ è½¬å‘ "æ­ç§¯æœ¨"
ä»Ž "ä¸€æ¬¡æ€§ä»»åŠ¡" â†’ è½¬å‘ "å¯å¤ç”¨ç»„ä»¶"  
ä»Ž "å•ä½“ç»“æž„" â†’ è½¬å‘ "æ¨¡å—åŒ–æž¶æž„"
```

**ðŸ”¹ å˜é‡ç®¡ç†çš„å±‚æ¬¡æ€ç»´**
```
è®¾è®¡åŽŸåˆ™ï¼š
defaults â†’ æä¾›åˆç†é»˜è®¤å€¼ï¼Œç”¨æˆ·å¯é€‰æ‹©è¦†ç›–
vars â†’ å®šä¹‰Roleå†…éƒ¨é€»è¾‘ï¼Œä¸åº”è¢«å¤–éƒ¨ä¿®æ”¹
å¤–éƒ¨ä¼ å…¥ â†’ çŽ¯å¢ƒç‰¹å®šé…ç½®ï¼Œæ”¯æŒå¤šçŽ¯å¢ƒéƒ¨ç½²
```

**ðŸ”¹ ä¾èµ–å…³ç³»çš„è®¾è®¡æ€è·¯**
```
ä¾èµ–åŽŸåˆ™ï¼š
å•ä¸€èŒè´£ â†’ æ¯ä¸ªRoleåªåšä¸€ä»¶äº‹
æ¾è€¦åˆ â†’ å°½é‡å‡å°‘Roleé—´çš„å¼ºä¾èµ–
é«˜å†…èš â†’ ç›¸å…³åŠŸèƒ½æ”¾åœ¨åŒä¸€ä¸ªRoleä¸­
```

### 10.3 å®žé™…åº”ç”¨ä»·å€¼


- **ðŸŽ¯ æå‡æ•ˆçŽ‡** â†’ ä¸€æ¬¡ç¼–å†™ï¼Œå¤šå¤„å¤ç”¨ï¼Œå‡å°‘é‡å¤å·¥ä½œ
- **ðŸ“Š è§„èŒƒç®¡ç†** â†’ æ ‡å‡†åŒ–ç»“æž„ï¼Œå›¢é˜Ÿåä½œæ›´é¡ºç•…  
- **ðŸ”§ è´¨é‡ä¿è¯** â†’ æµ‹è¯•é©±åŠ¨å¼€å‘ï¼Œå‡å°‘ç”Ÿäº§çŽ¯å¢ƒé—®é¢˜
- **âš¡ å¿«é€Ÿäº¤ä»˜** â†’ ç»„ä»¶åŒ–å¼€å‘ï¼Œç¼©çŸ­é¡¹ç›®å‘¨æœŸ
- **ðŸ¢ ä¼ä¸šæ²»ç†** â†’ è§„èŒƒåŒ–æµç¨‹ï¼Œæ”¯æ’‘å¤§è§„æ¨¡è‡ªåŠ¨åŒ–

### 10.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ðŸ“š å­¦ä¹ æ­¥éª¤**ï¼š
1. **åŸºç¡€å®žè·µ** â†’ åˆ›å»ºç®€å•Roleï¼Œç†è§£ç›®å½•ç»“æž„
2. **å˜é‡æŽŒæ¡** â†’ ç†Ÿç»ƒä½¿ç”¨å„ç§å˜é‡ç±»åž‹å’Œä¼˜å…ˆçº§
3. **ä¾èµ–ç®¡ç†** â†’ å­¦ä¼šè®¾è®¡å’Œä½¿ç”¨Roleä¾èµ–å…³ç³»
4. **Galaxyä½¿ç”¨** â†’ åˆ©ç”¨ç¤¾åŒºèµ„æºï¼Œæé«˜å¼€å‘æ•ˆçŽ‡
5. **æµ‹è¯•é›†æˆ** â†’ å»ºç«‹æµ‹è¯•æµç¨‹ï¼Œä¿è¯ä»£ç è´¨é‡
6. **ä¼ä¸šå®žè·µ** â†’ ç»“åˆå®žé™…ä¸šåŠ¡ï¼Œå»ºç«‹Roleç®¡ç†ä½“ç³»

**ðŸŽ¯ å®žè·µé¡¹ç›®å»ºè®®**ï¼š
- åˆ›å»ºWebåº”ç”¨éƒ¨ç½²Roleå¥—ä»¶
- å»ºç«‹æ•°æ®åº“ç®¡ç†Roleå®¶æ—  
- è®¾è®¡ç›‘æŽ§å‘Šè­¦Roleä½“ç³»
- æž„å»ºCI/CDæµæ°´çº¿Role

**æ ¸å¿ƒè®°å¿†**ï¼š
- Roleè®©Ansibleä»Žè„šæœ¬å·¥å…·å˜æˆæž¶æž„å¹³å°
- æ ‡å‡†åŒ–ç»“æž„æ˜¯å›¢é˜Ÿåä½œçš„åŸºç¡€
- å˜é‡åˆ†å±‚å’Œä¾èµ–ç®¡ç†æ˜¯è®¾è®¡å…³é”®
- æµ‹è¯•é©±åŠ¨å¼€å‘ä¿è¯ä¼ä¸šçº§è´¨é‡