---
title: 2ã€å¹¶å‘æ§åˆ¶ä¸äº’æ–¥é”
---
## ğŸ“š ç›®å½•

1. [å¹¶å‘æ§åˆ¶åŸºç¡€æ¦‚å¿µ](#1-å¹¶å‘æ§åˆ¶åŸºç¡€æ¦‚å¿µ)
2. [flockæ–‡ä»¶é”å®šæœºåˆ¶](#2-flockæ–‡ä»¶é”å®šæœºåˆ¶)
3. [è¿›ç¨‹äº’æ–¥ä¸ç«äº‰æ¡ä»¶](#3-è¿›ç¨‹äº’æ–¥ä¸ç«äº‰æ¡ä»¶)
4. [ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°é‡](#4-ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°é‡)
5. [ä¸´ç•ŒåŒºä¿æŠ¤ç­–ç•¥](#5-ä¸´ç•ŒåŒºä¿æŠ¤ç­–ç•¥)
6. [æ­»é”æ£€æµ‹ä¸é¢„é˜²](#6-æ­»é”æ£€æµ‹ä¸é¢„é˜²)
7. [åŸå­æ“ä½œå®ç°](#7-åŸå­æ“ä½œå®ç°)
8. [å¹¶å‘ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†](#8-å¹¶å‘ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†)
9. [é”è¶…æ—¶ä¸å¼‚å¸¸å¤„ç†](#9-é”è¶…æ—¶ä¸å¼‚å¸¸å¤„ç†)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ å¹¶å‘æ§åˆ¶åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¹¶å‘æ§åˆ¶


**å¹¶å‘æ§åˆ¶**å°±æ˜¯å½“å¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹åŒæ—¶è¿è¡Œæ—¶ï¼Œä¿è¯å®ƒä»¬ä¸ä¼šäº’ç›¸å¹²æ‰°ï¼Œæ•°æ®ä¸ä¼šè¢«æä¹±çš„æŠ€æœ¯ã€‚

```
ç®€å•æ¯”å–»ï¼š
æƒ³è±¡ä¸€ä¸ªé“¶è¡Œè´¦æˆ·ï¼Œæœ‰1000å…ƒ
- è¿›ç¨‹Aè¦å–500å…ƒ
- è¿›ç¨‹Bè¦å–600å…ƒ
- å¦‚æœåŒæ—¶è¿›è¡Œï¼Œå¯èƒ½éƒ½çœ‹åˆ°1000å…ƒï¼Œéƒ½è®¤ä¸ºå¯ä»¥å–é’±
- ç»“æœè´¦æˆ·å˜æˆäº†-100å…ƒï¼

è¿™å°±æ˜¯å…¸å‹çš„å¹¶å‘é—®é¢˜
```

**æ ¸å¿ƒç›®æ ‡**ï¼š
- **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿æ•°æ®ä¸ä¼šå› å¹¶å‘è€Œå‡ºé”™
- **èµ„æºå…±äº«**ï¼šå¤šä¸ªè¿›ç¨‹å®‰å…¨åœ°ä½¿ç”¨åŒä¸€èµ„æº
- **æ€§èƒ½ä¿è¯**ï¼šåœ¨ä¿è¯å®‰å…¨çš„å‰æä¸‹æé«˜æ•ˆç‡

### 1.2 å¸¸è§å¹¶å‘é—®é¢˜


**ğŸ”¸ ç«äº‰æ¡ä»¶ï¼ˆRace Conditionï¼‰**
```
é—®é¢˜åœºæ™¯ï¼š
ä¸¤ä¸ªè„šæœ¬åŒæ—¶ä¿®æ”¹åŒä¸€ä¸ªé…ç½®æ–‡ä»¶
- è„šæœ¬Aè¯»å–é…ç½®ï¼šversion=1
- è„šæœ¬Bè¯»å–é…ç½®ï¼šversion=1  
- è„šæœ¬Aå†™å…¥ï¼šversion=2
- è„šæœ¬Bå†™å…¥ï¼šversion=2
ç»“æœï¼šåº”è¯¥æ˜¯version=3ï¼Œå®é™…æ˜¯version=2
```

**ğŸ”¸ æ•°æ®ä¸ä¸€è‡´**
å¤šä¸ªè¿›ç¨‹åŒæ—¶å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼Œå¯èƒ½å¯¼è‡´æ—¥å¿—å†…å®¹æ··ä¹±äº¤ç»‡ã€‚

**ğŸ”¸ èµ„æºäº‰æŠ¢**
å¤šä¸ªè¿›ç¨‹åŒæ—¶è®¿é—®æ‰“å°æœºã€æ•°æ®åº“è¿æ¥ç­‰æœ‰é™èµ„æºã€‚

### 1.3 å¹¶å‘æ§åˆ¶çš„åŸºæœ¬åŸç†


**äº’æ–¥è®¿é—®**ï¼šåŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªè¿›ç¨‹è®¿é—®å…±äº«èµ„æº

```
ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
å•æ‰€é—¨é” = äº’æ–¥é”
- æœ‰äººåœ¨é‡Œé¢ï¼Œé—¨é”ä¸Šï¼Œå…¶ä»–äººç­‰å¾…
- å‡ºæ¥åå¼€é”ï¼Œä¸‹ä¸€ä¸ªäººå¯ä»¥è¿›å…¥
- ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªäººä½¿ç”¨

ç¨‹åºä¸­ä¹Ÿæ˜¯åŒæ ·é“ç†
```

---

## 2. ğŸ—ƒï¸ flockæ–‡ä»¶é”å®šæœºåˆ¶


### 2.1 flockåŸºæœ¬æ¦‚å¿µ


`flock`æ˜¯Linuxç³»ç»Ÿæä¾›çš„æ–‡ä»¶é”å®šå·¥å…·ï¼Œå¯ä»¥é˜²æ­¢å¤šä¸ªè¿›ç¨‹åŒæ—¶æ“ä½œåŒä¸€ä¸ªæ–‡ä»¶ã€‚

**é”çš„ç±»å‹**ï¼š
- **å…±äº«é”ï¼ˆè¯»é”ï¼‰**ï¼šå¤šä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶è¯»ï¼Œä½†ä¸èƒ½å†™
- **æ’ä»–é”ï¼ˆå†™é”ï¼‰**ï¼šåªæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®ï¼Œå…¶ä»–éƒ½è¦ç­‰å¾…

```bash
# åŸºæœ¬è¯­æ³•
flock [é€‰é¡¹] æ–‡ä»¶æè¿°ç¬¦æˆ–æ–‡ä»¶ å‘½ä»¤

# å¸¸ç”¨é€‰é¡¹
-s    # ç”³è¯·å…±äº«é”ï¼ˆè¯»é”ï¼‰
-x    # ç”³è¯·æ’ä»–é”ï¼ˆå†™é”ï¼‰
-n    # éé˜»å¡æ¨¡å¼ï¼Œè·å–ä¸åˆ°é”ç«‹å³è¿”å›
-w    # ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
```

### 2.2 flockå®é™…åº”ç”¨


**ğŸ”¸ é˜²æ­¢è„šæœ¬é‡å¤æ‰§è¡Œ**

```bash
#!/bin/bash
# backup.sh - å¤‡ä»½è„šæœ¬ï¼Œé˜²æ­¢åŒæ—¶è¿è¡Œå¤šä¸ª

# æ–¹å¼1ï¼šä½¿ç”¨é”æ–‡ä»¶
exec 200>/var/lock/backup.lock
if ! flock -n 200; then
    echo "å¤‡ä»½è„šæœ¬å·²åœ¨è¿è¡Œä¸­ï¼Œé€€å‡º"
    exit 1
fi

echo "å¼€å§‹å¤‡ä»½..."
# å®é™…å¤‡ä»½æ“ä½œ
rsync -av /data/ /backup/
echo "å¤‡ä»½å®Œæˆ"

# è„šæœ¬ç»“æŸæ—¶è‡ªåŠ¨é‡Šæ”¾é”
```

**ğŸ”¸ å®‰å…¨åœ°ä¿®æ”¹é…ç½®æ–‡ä»¶**

```bash
#!/bin/bash
# update_config.sh - å®‰å…¨æ›´æ–°é…ç½®

CONFIG_FILE="/etc/myapp/config.ini"

# ä½¿ç”¨æ–‡ä»¶æœ¬èº«ä½œä¸ºé”
exec 200<"$CONFIG_FILE"
flock -x 200  # è·å–æ’ä»–é”

echo "å¼€å§‹æ›´æ–°é…ç½®..."
# è¯»å–å½“å‰é…ç½®
current_value=$(grep "max_connections" "$CONFIG_FILE" | cut -d'=' -f2)
new_value=$((current_value + 10))

# åˆ›å»ºä¸´æ—¶æ–‡ä»¶
temp_file=$(mktemp)
sed "s/max_connections=.*/max_connections=$new_value/" "$CONFIG_FILE" > "$temp_file"

# åŸå­æ€§æ›¿æ¢
mv "$temp_file" "$CONFIG_FILE"
echo "é…ç½®æ›´æ–°å®Œæˆï¼šmax_connections=$new_value"

# é”è‡ªåŠ¨é‡Šæ”¾
```

### 2.3 flockçš„ä¼˜åŠ¿ä¸é™åˆ¶


**âœ… ä¼˜åŠ¿**ï¼š
- **ç®€å•æ˜“ç”¨**ï¼šå‘½ä»¤è¡Œå·¥å…·ï¼Œå­¦ä¹ æˆæœ¬ä½
- **è‡ªåŠ¨æ¸…ç†**ï¼šè¿›ç¨‹ç»“æŸæ—¶è‡ªåŠ¨é‡Šæ”¾é”
- **è·¨è¿›ç¨‹**ï¼šä¸åŒè„šæœ¬é—´å¯ä»¥äº’æ–¥

**âŒ é™åˆ¶**ï¼š
- **ä»…é™æœ¬æœº**ï¼šæ— æ³•å¤„ç†åˆ†å¸ƒå¼ç¯å¢ƒ
- **æ–‡ä»¶ä¾èµ–**ï¼šéœ€è¦æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
- **ç²’åº¦é™åˆ¶**ï¼šåªèƒ½é”æ•´ä¸ªæ–‡ä»¶ï¼Œæ— æ³•é”æ–‡ä»¶çš„ä¸€éƒ¨åˆ†

---

## 3. âš”ï¸ è¿›ç¨‹äº’æ–¥ä¸ç«äº‰æ¡ä»¶


### 3.1 ä»€ä¹ˆæ˜¯ç«äº‰æ¡ä»¶


ç«äº‰æ¡ä»¶å°±æ˜¯å¤šä¸ªè¿›ç¨‹"æŠ¢å¤º"åŒä¸€èµ„æºæ—¶ï¼Œç”±äºæ‰§è¡Œé¡ºåºçš„ä¸ç¡®å®šæ€§å¯¼è‡´çš„ç»“æœä¸å¯é¢„æµ‹ã€‚

**ç»å…¸ç¤ºä¾‹ï¼šè®¡æ•°å™¨é—®é¢˜**

```bash
#!/bin/bash
# counter_unsafe.sh - ä¸å®‰å…¨çš„è®¡æ•°å™¨

COUNTER_FILE="/tmp/counter"

# åˆå§‹åŒ–è®¡æ•°å™¨
if [ ! -f "$COUNTER_FILE" ]; then
    echo "0" > "$COUNTER_FILE"
fi

# ä¸å®‰å…¨çš„å¢åŠ è®¡æ•°
increase_counter() {
    # æ­¥éª¤1ï¼šè¯»å–å½“å‰å€¼
    current=$(cat "$COUNTER_FILE")
    
    # æ­¥éª¤2ï¼šè®¡ç®—æ–°å€¼ï¼ˆè¿™é‡Œå¯èƒ½è¢«ä¸­æ–­ï¼‰
    new_value=$((current + 1))
    
    # æ­¥éª¤3ï¼šå†™å›æ–°å€¼
    echo "$new_value" > "$COUNTER_FILE"
    
    echo "è¿›ç¨‹ $$ å°†è®¡æ•°å™¨å¢åŠ åˆ°ï¼š$new_value"
}

increase_counter
```

**é—®é¢˜æ¼”ç¤º**ï¼š

```bash
# åŒæ—¶å¯åŠ¨å¤šä¸ªè¿›ç¨‹
for i in {1..5}; do
    ./counter_unsafe.sh &
done
wait

# ç»“æœå¯èƒ½æ˜¯2ã€3ã€4ï¼Œè€Œä¸æ˜¯æœŸæœ›çš„5
cat /tmp/counter
```

### 3.2 ä½¿ç”¨äº’æ–¥é”è§£å†³ç«äº‰æ¡ä»¶


```bash
#!/bin/bash
# counter_safe.sh - å®‰å…¨çš„è®¡æ•°å™¨

COUNTER_FILE="/tmp/counter"
LOCK_FILE="/tmp/counter.lock"

# å®‰å…¨çš„å¢åŠ è®¡æ•°
increase_counter() {
    # è·å–äº’æ–¥é”
    exec 200>"$LOCK_FILE"
    flock 200
    
    # ä¸´ç•ŒåŒºå¼€å§‹
    if [ ! -f "$COUNTER_FILE" ]; then
        echo "0" > "$COUNTER_FILE"
    fi
    
    current=$(cat "$COUNTER_FILE")
    new_value=$((current + 1))
    echo "$new_value" > "$COUNTER_FILE"
    
    echo "è¿›ç¨‹ $$ å®‰å…¨åœ°å°†è®¡æ•°å™¨å¢åŠ åˆ°ï¼š$new_value"
    # ä¸´ç•ŒåŒºç»“æŸ
    
    # é”è‡ªåŠ¨é‡Šæ”¾ï¼ˆå½“æ–‡ä»¶æè¿°ç¬¦å…³é—­æ—¶ï¼‰
}

increase_counter
```

### 3.3 è¿›ç¨‹é—´é€šä¿¡ä¸åŒæ­¥


**ğŸ”¸ ä½¿ç”¨å‘½åç®¡é“ï¼ˆFIFOï¼‰è¿›è¡ŒåŒæ­¥**

```bash
#!/bin/bash
# åˆ›å»ºåŒæ­¥æœºåˆ¶

SYNC_PIPE="/tmp/sync_pipe"

# åˆ›å»ºå‘½åç®¡é“
mkfifo "$SYNC_PIPE" 2>/dev/null || true

# ç”Ÿäº§è€…è¿›ç¨‹
producer() {
    for i in {1..5}; do
        echo "æ•°æ®åŒ…$i" > "$SYNC_PIPE"
        echo "ç”Ÿäº§è€…ï¼šå‘é€æ•°æ®åŒ…$i"
        sleep 1
    done
}

# æ¶ˆè´¹è€…è¿›ç¨‹
consumer() {
    while read -r data < "$SYNC_PIPE"; do
        echo "æ¶ˆè´¹è€…ï¼šæ¥æ”¶åˆ° $data"
        # å¤„ç†æ•°æ®
        sleep 2
    done
}

# å¯åŠ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
producer &
consumer &

wait
```

---

## 4. ğŸ“Š ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°é‡


### 4.1 ä¿¡å·é‡çš„åŸºæœ¬æ¦‚å¿µ


ä¿¡å·é‡å°±åƒåœè½¦åœºçš„è½¦ä½æŒ‡ç¤ºç‰Œï¼Œæ˜¾ç¤ºè¿˜æœ‰å¤šå°‘ä¸ªä½ç½®å¯ç”¨ã€‚å®ƒæ§åˆ¶åŒæ—¶è®¿é—®èµ„æºçš„è¿›ç¨‹æ•°é‡ã€‚

```
åœè½¦åœºæ¯”å–»ï¼š
- æ€»å…±10ä¸ªè½¦ä½ï¼ˆä¿¡å·é‡å€¼=10ï¼‰
- æ¯è¿›ä¸€è¾†è½¦ï¼Œå¯ç”¨è½¦ä½-1
- æ¯å‡ºä¸€è¾†è½¦ï¼Œå¯ç”¨è½¦ä½+1  
- è½¦ä½æ»¡äº†ï¼Œæ–°è½¦å¿…é¡»ç­‰å¾…

ç¨‹åºä¸­ç”¨æ¥é™åˆ¶å¹¶å‘æ•°é‡
```

### 4.2 ä½¿ç”¨named pipeå®ç°ä¿¡å·é‡


```bash
#!/bin/bash
# semaphore.sh - ç®€å•çš„ä¿¡å·é‡å®ç°

SEMAPHORE_PIPE="/tmp/semaphore"
MAX_CONCURRENT=3

# åˆå§‹åŒ–ä¿¡å·é‡
init_semaphore() {
    rm -f "$SEMAPHORE_PIPE"
    mkfifo "$SEMAPHORE_PIPE"
    
    # å‘ç®¡é“ä¸­å†™å…¥ä»¤ç‰Œ
    for ((i=0; i<MAX_CONCURRENT; i++)); do
        echo "token" > "$SEMAPHORE_PIPE" &
    done
}

# è·å–ä¿¡å·é‡ï¼ˆPæ“ä½œï¼‰
acquire_semaphore() {
    read -r token < "$SEMAPHORE_PIPE"
    echo "è¿›ç¨‹ $$ è·å¾—ä»¤ç‰Œï¼Œå¼€å§‹å·¥ä½œ"
}

# é‡Šæ”¾ä¿¡å·é‡ï¼ˆVæ“ä½œï¼‰
release_semaphore() {
    echo "token" > "$SEMAPHORE_PIPE" &
    echo "è¿›ç¨‹ $$ é‡Šæ”¾ä»¤ç‰Œ"
}

# å·¥ä½œå‡½æ•°
do_work() {
    acquire_semaphore
    
    # æ¨¡æ‹Ÿå·¥ä½œ
    echo "è¿›ç¨‹ $$ æ­£åœ¨å¤„ç†ä»»åŠ¡..."
    sleep $((RANDOM % 10 + 5))  # éšæœºå·¥ä½œ5-15ç§’
    
    release_semaphore
}

# åˆå§‹åŒ–ä¿¡å·é‡
init_semaphore

# å¯åŠ¨å¤šä¸ªå·¥ä½œè¿›ç¨‹
for i in {1..8}; do
    do_work &
done

wait
```

### 4.3 å®é™…åº”ç”¨ï¼šé™åˆ¶å¹¶å‘ä¸‹è½½


```bash
#!/bin/bash
# download_manager.sh - é™åˆ¶å¹¶å‘ä¸‹è½½æ•°é‡

MAX_DOWNLOADS=3
DOWNLOAD_LIST="urls.txt"
SEMAPHORE_DIR="/tmp/download_sem"

# åˆå§‹åŒ–ä¿¡å·é‡ç›®å½•
init_download_semaphore() {
    rm -rf "$SEMAPHORE_DIR"
    mkdir -p "$SEMAPHORE_DIR"
    
    # åˆ›å»ºä»¤ç‰Œæ–‡ä»¶
    for ((i=1; i<=MAX_DOWNLOADS; i++)); do
        touch "$SEMAPHORE_DIR/token_$i"
    done
}

# è·å–ä¸‹è½½æ§½ä½
acquire_download_slot() {
    local slot_file
    while true; do
        # å°è¯•è·å–å¯ç”¨æ§½ä½
        for token_file in "$SEMAPHORE_DIR"/token_*; do
            if [ -f "$token_file" ]; then
                # åŸå­æ€§åœ°ç§»åŠ¨æ–‡ä»¶ï¼ˆè·å–ä»¤ç‰Œï¼‰
                slot_file=$(basename "$token_file")
                if mv "$token_file" "$SEMAPHORE_DIR/busy_$slot_file" 2>/dev/null; then
                    echo "$slot_file"
                    return 0
                fi
            fi
        done
        sleep 1  # ç­‰å¾…æ§½ä½é‡Šæ”¾
    done
}

# é‡Šæ”¾ä¸‹è½½æ§½ä½
release_download_slot() {
    local slot=$1
    mv "$SEMAPHORE_DIR/busy_$slot" "$SEMAPHORE_DIR/$slot"
}

# ä¸‹è½½æ–‡ä»¶å‡½æ•°
download_file() {
    local url=$1
    local filename=$(basename "$url")
    
    # è·å–ä¸‹è½½æ§½ä½
    local slot=$(acquire_download_slot)
    echo "å¼€å§‹ä¸‹è½½ $filename (ä½¿ç”¨æ§½ä½: $slot)"
    
    # æ‰§è¡Œä¸‹è½½
    curl -L -o "/tmp/$filename" "$url" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo "ä¸‹è½½å®Œæˆ: $filename"
    else
        echo "ä¸‹è½½å¤±è´¥: $filename"
    fi
    
    # é‡Šæ”¾æ§½ä½
    release_download_slot "$slot"
}

# ä¸»ç¨‹åº
init_download_semaphore

# è¯»å–URLåˆ—è¡¨å¹¶å¯åŠ¨ä¸‹è½½
while read -r url; do
    download_file "$url" &
done < "$DOWNLOAD_LIST"

wait
echo "æ‰€æœ‰ä¸‹è½½ä»»åŠ¡å®Œæˆ"
```

---

## 5. ğŸ›¡ï¸ ä¸´ç•ŒåŒºä¿æŠ¤ç­–ç•¥


### 5.1 ä»€ä¹ˆæ˜¯ä¸´ç•ŒåŒº


ä¸´ç•ŒåŒºæ˜¯è®¿é—®å…±äº«èµ„æºçš„ä»£ç æ®µï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œã€‚

```
é“¶è¡Œè½¬è´¦çš„ä¸´ç•ŒåŒºï¼š
1. æ£€æŸ¥è´¦æˆ·ä½™é¢     â† ä¸´ç•ŒåŒºå¼€å§‹
2. è®¡ç®—è½¬è´¦åä½™é¢
3. æ›´æ–°è´¦æˆ·ä½™é¢     â† ä¸´ç•ŒåŒºç»“æŸ

è¿™ä¸‰æ­¥å¿…é¡»åŸå­æ€§æ‰§è¡Œï¼Œä¸èƒ½è¢«å…¶ä»–è¿›ç¨‹æ‰“æ–­
```

### 5.2 ä¸´ç•ŒåŒºä¿æŠ¤çš„å®ç°æ–¹æ³•


**ğŸ”¸ æ–¹æ³•1ï¼šæ–‡ä»¶é”ä¿æŠ¤**

```bash
#!/bin/bash
# protected_update.sh - ä½¿ç”¨æ–‡ä»¶é”ä¿æŠ¤ä¸´ç•ŒåŒº

DATA_FILE="/tmp/shared_data"
LOCK_FILE="/tmp/data.lock"

# å—ä¿æŠ¤çš„æ›´æ–°å‡½æ•°
protected_update() {
    local operation=$1
    local value=$2
    
    # è¿›å…¥ä¸´ç•ŒåŒº
    exec 200>"$LOCK_FILE"
    flock 200
    
    echo "è¿›ç¨‹ $$ è¿›å…¥ä¸´ç•ŒåŒº"
    
    # ä¸´ç•ŒåŒºä»£ç å¼€å§‹
    if [ ! -f "$DATA_FILE" ]; then
        echo "0" > "$DATA_FILE"
    fi
    
    current=$(cat "$DATA_FILE")
    echo "å½“å‰å€¼: $current"
    
    case "$operation" in
        "add")
            new_value=$((current + value))
            ;;
        "subtract")
            new_value=$((current - value))
            ;;
        *)
            echo "æœªçŸ¥æ“ä½œ: $operation"
            return 1
            ;;
    esac
    
    # æ¨¡æ‹Ÿä¸€äº›å¤„ç†æ—¶é—´
    sleep 2
    
    echo "$new_value" > "$DATA_FILE"
    echo "è¿›ç¨‹ $$ æ›´æ–°å€¼ä¸º: $new_value"
    # ä¸´ç•ŒåŒºä»£ç ç»“æŸ
    
    echo "è¿›ç¨‹ $$ ç¦»å¼€ä¸´ç•ŒåŒº"
    # é”è‡ªåŠ¨é‡Šæ”¾
}

# ä½¿ç”¨ç¤ºä¾‹
protected_update "add" 5
```

**ğŸ”¸ æ–¹æ³•2ï¼šç›®å½•é”ä¿æŠ¤**

```bash
#!/bin/bash
# directory_lock.sh - ä½¿ç”¨ç›®å½•ä½œä¸ºé”

LOCK_DIR="/tmp/process.lock"

# è·å–ç›®å½•é”
acquire_dir_lock() {
    local timeout=${1:-30}  # é»˜è®¤30ç§’è¶…æ—¶
    local count=0
    
    while ! mkdir "$LOCK_DIR" 2>/dev/null; do
        if [ $count -ge $timeout ]; then
            echo "è·å–é”è¶…æ—¶"
            return 1
        fi
        echo "ç­‰å¾…é”é‡Šæ”¾..."
        sleep 1
        ((count++))
    done
    
    # å†™å…¥é”ä¿¡æ¯
    echo "$$" > "$LOCK_DIR/pid"
    echo "$(date)" > "$LOCK_DIR/timestamp"
    return 0
}

# é‡Šæ”¾ç›®å½•é”
release_dir_lock() {
    if [ -d "$LOCK_DIR" ]; then
        rm -rf "$LOCK_DIR"
    fi
}

# ä½¿ç”¨é™·é˜±ç¡®ä¿é”è¢«é‡Šæ”¾
trap 'release_dir_lock; exit' INT TERM EXIT

# ä¸´ç•ŒåŒºæ“ä½œ
critical_section() {
    if acquire_dir_lock 10; then
        echo "è¿›ç¨‹ $$ å¼€å§‹æ‰§è¡Œä¸´ç•ŒåŒºæ“ä½œ"
        
        # è¿™é‡Œæ”¾ç½®éœ€è¦ä¿æŠ¤çš„ä»£ç 
        echo "æ‰§è¡Œé‡è¦æ“ä½œ..."
        sleep 3
        echo "æ“ä½œå®Œæˆ"
        
        release_dir_lock
        echo "è¿›ç¨‹ $$ å®Œæˆä¸´ç•ŒåŒºæ“ä½œ"
    else
        echo "æ— æ³•è·å–é”ï¼Œæ“ä½œå–æ¶ˆ"
        exit 1
    fi
}

critical_section
```

### 5.3 ä¸´ç•ŒåŒºä¿æŠ¤çš„æœ€ä½³å®è·µ


**ğŸ”¸ æœ€å°åŒ–ä¸´ç•ŒåŒº**

```bash
# âŒ é”™è¯¯ï¼šä¸´ç•ŒåŒºè¿‡å¤§
bad_critical_section() {
    flock 200
    echo "å¼€å§‹å¤„ç†..."
    
    # å¤§é‡éå…±äº«èµ„æºæ“ä½œï¼ˆä¸éœ€è¦ä¿æŠ¤ï¼‰
    for i in {1..1000}; do
        echo "å¤„ç† $i"
        sleep 0.1
    done
    
    # çœŸæ­£éœ€è¦ä¿æŠ¤çš„æ“ä½œ
    echo "update" >> shared_file.txt
}

# âœ… æ­£ç¡®ï¼šæœ€å°åŒ–ä¸´ç•ŒåŒº
good_critical_section() {
    echo "å¼€å§‹å¤„ç†..."
    
    # ä¸éœ€è¦ä¿æŠ¤çš„æ“ä½œæ”¾åœ¨å¤–é¢
    result=""
    for i in {1..1000}; do
        result+="processed $i\n"
    done
    
    # åªä¿æŠ¤çœŸæ­£çš„å…±äº«èµ„æºè®¿é—®
    {
        flock 200
        echo -e "$result" >> shared_file.txt
    } 200>/tmp/lock
}
```

---

## 6. âš ï¸ æ­»é”æ£€æµ‹ä¸é¢„é˜²


### 6.1 ä»€ä¹ˆæ˜¯æ­»é”


æ­»é”å°±æ˜¯ä¸¤ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æºï¼Œå¯¼è‡´æ‰€æœ‰è¿›ç¨‹éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œã€‚

```
ç”Ÿæ´»ä¸­çš„æ­»é”ï¼š
- ä¸¤è¾†è½¦åœ¨çª„è·¯ç›¸é‡
- Aè½¦ç­‰Bè½¦è®©è·¯ï¼ŒBè½¦ç­‰Aè½¦è®©è·¯
- ç»“æœï¼šä¸¤è½¦éƒ½åŠ¨ä¸äº†

ç¨‹åºä¸­çš„æ­»é”ï¼š
- è¿›ç¨‹Aé”å®šæ–‡ä»¶1ï¼Œç­‰å¾…æ–‡ä»¶2
- è¿›ç¨‹Bé”å®šæ–‡ä»¶2ï¼Œç­‰å¾…æ–‡ä»¶1
- ç»“æœï¼šä¸¤è¿›ç¨‹éƒ½æ— æ³•ç»§ç»­
```

### 6.2 æ­»é”äº§ç”Ÿçš„æ¡ä»¶


**æ­»é”å¿…é¡»åŒæ—¶æ»¡è¶³å››ä¸ªæ¡ä»¶**ï¼š
1. **äº’æ–¥æ¡ä»¶**ï¼šèµ„æºä¸èƒ½åŒæ—¶è¢«å¤šä¸ªè¿›ç¨‹ä½¿ç”¨
2. **æŒæœ‰ç­‰å¾…**ï¼šè¿›ç¨‹æŒæœ‰èµ„æºçš„åŒæ—¶ç­‰å¾…å…¶ä»–èµ„æº
3. **ä¸å¯å‰¥å¤º**ï¼šä¸èƒ½å¼ºåˆ¶å–èµ°è¿›ç¨‹æŒæœ‰çš„èµ„æº  
4. **ç¯å½¢ç­‰å¾…**ï¼šè¿›ç¨‹é—´å½¢æˆç¯å½¢çš„ç­‰å¾…é“¾

### 6.3 æ­»é”é¢„é˜²ç­–ç•¥


**ğŸ”¸ ç­–ç•¥1ï¼šç»Ÿä¸€çš„é”é¡ºåº**

```bash
#!/bin/bash
# deadlock_prevention.sh - é€šè¿‡å›ºå®šé¡ºåºè·å–é”æ¥é¢„é˜²æ­»é”

LOCK1="/tmp/lock1"
LOCK2="/tmp/lock2"

# âœ… å¥½çš„åšæ³•ï¼šæ€»æ˜¯æŒ‰ç›¸åŒé¡ºåºè·å–é”
safe_dual_lock() {
    echo "è¿›ç¨‹ $$ å°è¯•è·å–é”1"
    exec 200>"$LOCK1"
    flock 200
    echo "è¿›ç¨‹ $$ è·å¾—é”1"
    
    echo "è¿›ç¨‹ $$ å°è¯•è·å–é”2"
    exec 201>"$LOCK2"
    flock 201
    echo "è¿›ç¨‹ $$ è·å¾—é”2"
    
    # ä¸´ç•ŒåŒºæ“ä½œ
    echo "è¿›ç¨‹ $$ åœ¨ä¸´ç•ŒåŒºæ‰§è¡Œ"
    sleep 2
    
    echo "è¿›ç¨‹ $$ é‡Šæ”¾æ‰€æœ‰é”"
    # é”è‡ªåŠ¨é‡Šæ”¾
}

# âŒ å±é™©çš„åšæ³•ï¼šä¸åŒè¿›ç¨‹ä»¥ä¸åŒé¡ºåºè·å–é”
dangerous_process_A() {
    exec 200>"$LOCK1"; flock 200
    sleep 1  # å¢åŠ æ­»é”æ¦‚ç‡
    exec 201>"$LOCK2"; flock 201
    echo "è¿›ç¨‹Aå®Œæˆ"
}

dangerous_process_B() {
    exec 201>"$LOCK2"; flock 201  # æ³¨æ„ï¼šé¡ºåºä¸åŒï¼
    sleep 1  # å¢åŠ æ­»é”æ¦‚ç‡
    exec 200>"$LOCK1"; flock 200
    echo "è¿›ç¨‹Bå®Œæˆ"
}

safe_dual_lock
```

**ğŸ”¸ ç­–ç•¥2ï¼šè¶…æ—¶æœºåˆ¶**

```bash
#!/bin/bash
# timeout_lock.sh - ä½¿ç”¨è¶…æ—¶é¿å…æ— é™ç­‰å¾…

LOCK_FILE="/tmp/timeout_lock"
TIMEOUT=10  # 10ç§’è¶…æ—¶

# å¸¦è¶…æ—¶çš„é”è·å–
acquire_lock_with_timeout() {
    local timeout=$1
    local lock_file=$2
    
    exec 200>"$lock_file"
    
    if flock -w "$timeout" 200; then
        echo "æˆåŠŸè·å–é”"
        return 0
    else
        echo "è·å–é”è¶…æ—¶ï¼Œå¯èƒ½å‘ç”Ÿæ­»é”"
        return 1
    fi
}

# å®‰å…¨çš„æ“ä½œå‡½æ•°
safe_operation() {
    if acquire_lock_with_timeout $TIMEOUT "$LOCK_FILE"; then
        echo "æ‰§è¡Œå®‰å…¨æ“ä½œ..."
        sleep 5
        echo "æ“ä½œå®Œæˆ"
    else
        echo "æ“ä½œå¤±è´¥ï¼šæ— æ³•è·å–é”"
        # å¯ä»¥é€‰æ‹©é‡è¯•æˆ–æŠ¥å‘Šé”™è¯¯
    fi
}

safe_operation
```

### 6.4 æ­»é”æ£€æµ‹å·¥å…·


```bash
#!/bin/bash
# deadlock_detector.sh - ç®€å•çš„æ­»é”æ£€æµ‹

LOCK_INFO_DIR="/tmp/lock_info"

# è®°å½•é”ä¿¡æ¯
record_lock_info() {
    local process_pid=$$
    local lock_file=$1
    local action=$2  # acquire æˆ– release
    
    mkdir -p "$LOCK_INFO_DIR"
    
    if [ "$action" = "acquire" ]; then
        echo "$(date '+%Y-%m-%d %H:%M:%S') PID:$process_pid ACQUIRE $lock_file" >> "$LOCK_INFO_DIR/locks.log"
    else
        echo "$(date '+%Y-%m-%d %H:%M:%S') PID:$process_pid RELEASE $lock_file" >> "$LOCK_INFO_DIR/locks.log"
    fi
}

# æ£€æµ‹å¯èƒ½çš„æ­»é”
detect_deadlock() {
    echo "=== å½“å‰é”çŠ¶æ€ ==="
    
    # æ˜¾ç¤ºæ´»è·ƒçš„é”æ–‡ä»¶
    for lock_file in /tmp/lock*; do
        if [ -f "$lock_file" ]; then
            if lsof "$lock_file" >/dev/null 2>&1; then
                echo "é”æ–‡ä»¶ $lock_file è¢«ä½¿ç”¨ä¸­"
                lsof "$lock_file" | grep -v COMMAND
            fi
        fi
    done
    
    echo "=== é”è·å–å†å² ==="
    if [ -f "$LOCK_INFO_DIR/locks.log" ]; then
        tail -20 "$LOCK_INFO_DIR/locks.log"
    fi
}

# ä½¿ç”¨ç¤ºä¾‹
enhanced_lock_operation() {
    local lock_file="/tmp/enhanced_lock"
    
    record_lock_info "$lock_file" "acquire"
    exec 200>"$lock_file"
    
    if flock -w 5 200; then
        echo "æˆåŠŸè·å–é”ï¼Œæ‰§è¡Œæ“ä½œ"
        sleep 3
        record_lock_info "$lock_file" "release"
    else
        echo "é”è·å–è¶…æ—¶ï¼Œæ£€æµ‹æ­»é”..."
        detect_deadlock
    fi
}

enhanced_lock_operation
```

---

## 7. âš›ï¸ åŸå­æ“ä½œå®ç°


### 7.1 ä»€ä¹ˆæ˜¯åŸå­æ“ä½œ


åŸå­æ“ä½œå°±æ˜¯ä¸å¯åˆ†å‰²çš„æ“ä½œï¼Œè¦ä¹ˆå®Œå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå®Œå…¨ä¸æ‰§è¡Œï¼Œä¸­é—´ä¸ä¼šè¢«å…¶ä»–è¿›ç¨‹æ‰“æ–­ã€‚

```
åŸå­æ“ä½œçš„ç‰¹ç‚¹ï¼š
- ä¸å¯ä¸­æ–­ï¼šæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸èƒ½è¢«æ‰“æ–­
- ä¸å¯åˆ†å‰²ï¼šä¸èƒ½åªæ‰§è¡Œä¸€éƒ¨åˆ†
- ä¸€è‡´æ€§ï¼šæ“ä½œå‰åç³»ç»ŸçŠ¶æ€ä¸€è‡´

å°±åƒä¹°ä¸œè¥¿ä»˜æ¬¾ï¼Œè¦ä¹ˆä»˜æ¬¾æˆåŠŸï¼Œè¦ä¹ˆä»˜æ¬¾å¤±è´¥
ä¸èƒ½å‡ºç°é’±æ‰£äº†ä½†æ˜¯æ²¡ä¹°åˆ°ä¸œè¥¿çš„æƒ…å†µ
```

### 7.2 æ–‡ä»¶æ“ä½œçš„åŸå­æ€§


**ğŸ”¸ åŸå­æ€§æ–‡ä»¶æ›´æ–°**

```bash
#!/bin/bash
# atomic_update.sh - åŸå­æ€§æ–‡ä»¶æ›´æ–°

CONFIG_FILE="/etc/myapp/config.ini"
BACKUP_FILE="/etc/myapp/config.ini.backup"

# åŸå­æ€§æ›´æ–°é…ç½®æ–‡ä»¶
atomic_update_config() {
    local key=$1
    local new_value=$2
    
    # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
    local temp_file=$(mktemp "${CONFIG_FILE}.XXXXXX")
    
    if [ ! -f "$temp_file" ]; then
        echo "æ— æ³•åˆ›å»ºä¸´æ—¶æ–‡ä»¶"
        return 1
    fi
    
    # åœ¨ä¸´æ—¶æ–‡ä»¶ä¸­è¿›è¡Œä¿®æ”¹
    if grep -q "^$key=" "$CONFIG_FILE"; then
        # æ›´æ–°å·²å­˜åœ¨çš„é”®
        sed "s/^$key=.*/$key=$new_value/" "$CONFIG_FILE" > "$temp_file"
    else
        # æ·»åŠ æ–°é”®
        cp "$CONFIG_FILE" "$temp_file"
        echo "$key=$new_value" >> "$temp_file"
    fi
    
    # éªŒè¯æ–°é…ç½®æ–‡ä»¶çš„æœ‰æ•ˆæ€§
    if validate_config "$temp_file"; then
        # å¤‡ä»½åŸæ–‡ä»¶
        cp "$CONFIG_FILE" "$BACKUP_FILE"
        
        # åŸå­æ€§æ›¿æ¢ï¼ˆmoveæ“ä½œåœ¨å¤§å¤šæ•°æ–‡ä»¶ç³»ç»Ÿä¸­æ˜¯åŸå­çš„ï¼‰
        mv "$temp_file" "$CONFIG_FILE"
        echo "é…ç½®æ›´æ–°æˆåŠŸï¼š$key=$new_value"
    else
        echo "é…ç½®æ–‡ä»¶éªŒè¯å¤±è´¥ï¼Œæ›´æ–°å–æ¶ˆ"
        rm -f "$temp_file"
        return 1
    fi
}

# é…ç½®æ–‡ä»¶éªŒè¯å‡½æ•°
validate_config() {
    local config_file=$1
    
    # ç®€å•éªŒè¯ï¼šæ£€æŸ¥å…³é”®é…ç½®é¡¹æ˜¯å¦å­˜åœ¨
    local required_keys=("server_port" "database_host" "log_level")
    
    for key in "${required_keys[@]}"; do
        if ! grep -q "^$key=" "$config_file"; then
            echo "ç¼ºå°‘å¿…éœ€é…ç½®é¡¹ï¼š$key"
            return 1
        fi
    done
    
    return 0
}

# ä½¿ç”¨ç¤ºä¾‹
atomic_update_config "max_connections" "200"
atomic_update_config "timeout" "30"
```

### 7.3 ä½¿ç”¨renameå®ç°åŸå­æ“ä½œ


```bash
#!/bin/bash
# atomic_log.sh - åŸå­æ€§æ—¥å¿—è½®è½¬

LOG_FILE="/var/log/myapp.log"
MAX_SIZE=$((10 * 1024 * 1024))  # 10MB

# åŸå­æ€§æ—¥å¿—è½®è½¬
atomic_log_rotate() {
    if [ ! -f "$LOG_FILE" ]; then
        return 0
    fi
    
    # æ£€æŸ¥æ–‡ä»¶å¤§å°
    local current_size=$(stat -f%z "$LOG_FILE" 2>/dev/null || stat -c%s "$LOG_FILE" 2>/dev/null)
    
    if [ "$current_size" -gt "$MAX_SIZE" ]; then
        echo "æ—¥å¿—æ–‡ä»¶è¿‡å¤§($current_size bytes)ï¼Œå¼€å§‹è½®è½¬..."
        
        # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„å¤‡ä»½æ–‡ä»¶å
        local timestamp=$(date '+%Y%m%d_%H%M%S')
        local backup_file="${LOG_FILE}.${timestamp}"
        
        # åŸå­æ€§ç§»åŠ¨æ–‡ä»¶ï¼ˆrenameæ“ä½œæ˜¯åŸå­çš„ï¼‰
        mv "$LOG_FILE" "$backup_file"
        
        # åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶
        touch "$LOG_FILE"
        chmod 644 "$LOG_FILE"
        
        # å‹ç¼©æ—§æ—¥å¿—æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
        gzip "$backup_file" &
        
        echo "æ—¥å¿—è½®è½¬å®Œæˆï¼š$backup_file"
    fi
}

# åŸå­æ€§è¿½åŠ æ—¥å¿—
atomic_log_append() {
    local message=$1
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ç¡®ä¿åŸå­æ€§
    local temp_file=$(mktemp)
    echo "[$timestamp] $message" > "$temp_file"
    
    # åŸå­æ€§è¿½åŠ ï¼ˆ>>æ“ä½œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯åŸå­çš„ï¼Œä½†ä¸ºäº†æ›´å®‰å…¨ä½¿ç”¨catï¼‰
    cat "$temp_file" >> "$LOG_FILE"
    rm -f "$temp_file"
}

# ä½¿ç”¨ç¤ºä¾‹
atomic_log_rotate
atomic_log_append "åº”ç”¨ç¨‹åºå¯åŠ¨"
atomic_log_append "å¤„ç†ç”¨æˆ·è¯·æ±‚"
```

### 7.4 æ•°æ®åº“å¼çš„åŸå­äº‹åŠ¡


```bash
#!/bin/bash
# atomic_transaction.sh - å®ç°ç®€å•çš„äº‹åŠ¡æœºåˆ¶

TRANSACTION_DIR="/tmp/transaction_$$"
DATA_DIR="/var/lib/myapp"

# å¼€å§‹äº‹åŠ¡
begin_transaction() {
    if [ -d "$TRANSACTION_DIR" ]; then
        echo "äº‹åŠ¡å·²åœ¨è¿›è¡Œä¸­"
        return 1
    fi
    
    mkdir -p "$TRANSACTION_DIR"
    echo "äº‹åŠ¡å¼€å§‹"
}

# äº‹åŠ¡æ€§æ–‡ä»¶æ“ä½œ
transactional_create() {
    local filename=$1
    local content=$2
    
    if [ ! -d "$TRANSACTION_DIR" ]; then
        echo "æ²¡æœ‰æ´»è·ƒçš„äº‹åŠ¡"
        return 1
    fi
    
    # åœ¨äº‹åŠ¡ç›®å½•ä¸­è®°å½•æ“ä½œ
    echo "CREATE:$filename" >> "$TRANSACTION_DIR/operations.log"
    echo "$content" > "$TRANSACTION_DIR/${filename}.new"
}

transactional_update() {
    local filename=$1
    local content=$2
    
    if [ ! -d "$TRANSACTION_DIR" ]; then
        echo "æ²¡æœ‰æ´»è·ƒçš„äº‹åŠ¡"
        return 1
    fi
    
    # å¤‡ä»½åŸæ–‡ä»¶
    if [ -f "$DATA_DIR/$filename" ]; then
        cp "$DATA_DIR/$filename" "$TRANSACTION_DIR/${filename}.backup"
        echo "UPDATE:$filename" >> "$TRANSACTION_DIR/operations.log"
    fi
    
    echo "$content" > "$TRANSACTION_DIR/${filename}.new"
}

# æäº¤äº‹åŠ¡
commit_transaction() {
    if [ ! -d "$TRANSACTION_DIR" ]; then
        echo "æ²¡æœ‰æ´»è·ƒçš„äº‹åŠ¡"
        return 1
    fi
    
    echo "æäº¤äº‹åŠ¡..."
    
    # åº”ç”¨æ‰€æœ‰æ“ä½œ
    while read -r operation; do
        local op_type=${operation%%:*}
        local filename=${operation#*:}
        
        case "$op_type" in
            "CREATE"|"UPDATE")
                mv "$TRANSACTION_DIR/${filename}.new" "$DATA_DIR/$filename"
                echo "åº”ç”¨æ“ä½œï¼š$operation"
                ;;
        esac
    done < "$TRANSACTION_DIR/operations.log"
    
    # æ¸…ç†äº‹åŠ¡ç›®å½•
    rm -rf "$TRANSACTION_DIR"
    echo "äº‹åŠ¡æäº¤æˆåŠŸ"
}

# å›æ»šäº‹åŠ¡
rollback_transaction() {
    if [ ! -d "$TRANSACTION_DIR" ]; then
        echo "æ²¡æœ‰æ´»è·ƒçš„äº‹åŠ¡"
        return 1
    fi
    
    echo "å›æ»šäº‹åŠ¡..."
    
    # æ¢å¤å¤‡ä»½æ–‡ä»¶
    for backup_file in "$TRANSACTION_DIR"/*.backup; do
        if [ -f "$backup_file" ]; then
            local filename=$(basename "$backup_file" .backup)
            mv "$backup_file" "$DATA_DIR/$filename"
            echo "æ¢å¤æ–‡ä»¶ï¼š$filename"
        fi
    done
    
    # æ¸…ç†äº‹åŠ¡ç›®å½•
    rm -rf "$TRANSACTION_DIR"
    echo "äº‹åŠ¡å›æ»šå®Œæˆ"
}

# ä½¿ç”¨ç¤ºä¾‹
begin_transaction

transactional_create "user.txt" "ç”¨æˆ·æ•°æ®"
transactional_update "config.txt" "æ–°é…ç½®"

# æ ¹æ®æ¡ä»¶å†³å®šæäº¤æˆ–å›æ»š
if [ "$?" -eq 0 ]; then
    commit_transaction
else
    rollback_transaction
fi
```

---

## 8. ğŸ“‹ å¹¶å‘ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†


### 8.1 ä»€ä¹ˆæ˜¯ä»»åŠ¡é˜Ÿåˆ—


ä»»åŠ¡é˜Ÿåˆ—å°±åƒé“¶è¡Œçš„æ’é˜Ÿç³»ç»Ÿï¼Œå®¢æˆ·æŒ‰é¡ºåºæ’é˜Ÿï¼ŒæŸœå‘˜æŒ‰é¡ºåºå¤„ç†ï¼Œå¯ä»¥æœ‰å¤šä¸ªæŸœå‘˜åŒæ—¶å·¥ä½œã€‚

```
ä»»åŠ¡é˜Ÿåˆ—çš„ä¼˜åŠ¿ï¼š
1. æœ‰åºå¤„ç†ï¼šä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œ
2. å¹¶å‘æ§åˆ¶ï¼šé™åˆ¶åŒæ—¶å¤„ç†çš„ä»»åŠ¡æ•°
3. è´Ÿè½½å‡è¡¡ï¼šå·¥ä½œè´Ÿè½½å‡åŒ€åˆ†é…
4. é”™è¯¯éš”ç¦»ï¼šä¸€ä¸ªä»»åŠ¡å¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡
```

### 8.2 åŸºäºæ–‡ä»¶çš„ä»»åŠ¡é˜Ÿåˆ—


```bash
#!/bin/bash
# task_queue.sh - ç®€å•çš„æ–‡ä»¶ä»»åŠ¡é˜Ÿåˆ—

QUEUE_DIR="/tmp/task_queue"
PROCESSING_DIR="$QUEUE_DIR/processing"
COMPLETED_DIR="$QUEUE_DIR/completed"
FAILED_DIR="$QUEUE_DIR/failed"
MAX_WORKERS=3

# åˆå§‹åŒ–é˜Ÿåˆ—ç›®å½•
init_queue() {
    mkdir -p "$QUEUE_DIR" "$PROCESSING_DIR" "$COMPLETED_DIR" "$FAILED_DIR"
    echo "ä»»åŠ¡é˜Ÿåˆ—åˆå§‹åŒ–å®Œæˆ"
}

# æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—
enqueue_task() {
    local task_id=$1
    local task_command=$2
    
    local task_file="$QUEUE_DIR/task_${task_id}_$(date +%s)"
    
    cat > "$task_file" << EOF
TASK_ID=$task_id
COMMAND=$task_command
CREATED=$(date)
EOF
    
    echo "ä»»åŠ¡ $task_id å·²åŠ å…¥é˜Ÿåˆ—"
}

# è·å–ä¸‹ä¸€ä¸ªä»»åŠ¡
dequeue_task() {
    local worker_id=$1
    
    # æŸ¥æ‰¾æœ€æ—©çš„ä»»åŠ¡
    local task_file=$(ls -1t "$QUEUE_DIR"/task_* 2>/dev/null | tail -1)
    
    if [ -n "$task_file" ] && [ -f "$task_file" ]; then
        # åŸå­æ€§ç§»åŠ¨åˆ°å¤„ç†ç›®å½•
        local processing_file="$PROCESSING_DIR/$(basename "$task_file")_worker_$worker_id"
        if mv "$task_file" "$processing_file" 2>/dev/null; then
            echo "$processing_file"
            return 0
        fi
    fi
    
    return 1
}

# ä»»åŠ¡å¤„ç†å™¨
process_task() {
    local task_file=$1
    
    # è¯»å–ä»»åŠ¡ä¿¡æ¯
    source "$task_file"
    
    echo "å¼€å§‹å¤„ç†ä»»åŠ¡ï¼š$TASK_ID"
    echo "å‘½ä»¤ï¼š$COMMAND"
    
    # æ‰§è¡Œä»»åŠ¡å‘½ä»¤
    if eval "$COMMAND"; then
        # ä»»åŠ¡æˆåŠŸ
        mv "$task_file" "$COMPLETED_DIR/$(basename "$task_file")"
        echo "ä»»åŠ¡ $TASK_ID å®Œæˆ"
    else
        # ä»»åŠ¡å¤±è´¥
        mv "$task_file" "$FAILED_DIR/$(basename "$task_file")"
        echo "ä»»åŠ¡ $TASK_ID å¤±è´¥"
    fi
}

# å·¥ä½œè¿›ç¨‹
worker() {
    local worker_id=$1
    echo "å·¥ä½œè¿›ç¨‹ $worker_id å¯åŠ¨"
    
    while true; do
        if task_file=$(dequeue_task "$worker_id"); then
            process_task "$task_file"
        else
            # æ²¡æœ‰ä»»åŠ¡æ—¶ç­‰å¾…
            sleep 1
        fi
    done
}

# é˜Ÿåˆ—ç®¡ç†å™¨
queue_manager() {
    init_queue
    
    echo "å¯åŠ¨ $MAX_WORKERS ä¸ªå·¥ä½œè¿›ç¨‹..."
    
    # å¯åŠ¨å·¥ä½œè¿›ç¨‹
    for ((i=1; i<=MAX_WORKERS; i++)); do
        worker "$i" &
    done
    
    # ç­‰å¾…æ‰€æœ‰å·¥ä½œè¿›ç¨‹
    wait
}

# é˜Ÿåˆ—çŠ¶æ€ç›‘æ§
queue_status() {
    echo "=== ä»»åŠ¡é˜Ÿåˆ—çŠ¶æ€ ==="
    echo "ç­‰å¾…ä¸­çš„ä»»åŠ¡: $(ls -1 "$QUEUE_DIR"/task_* 2>/dev/null | wc -l)"
    echo "å¤„ç†ä¸­çš„ä»»åŠ¡: $(ls -1 "$PROCESSING_DIR"/* 2>/dev/null | wc -l)"
    echo "å·²å®Œæˆçš„ä»»åŠ¡: $(ls -1 "$COMPLETED_DIR"/* 2>/dev/null | wc -l)"
    echo "å¤±è´¥çš„ä»»åŠ¡: $(ls -1 "$FAILED_DIR"/* 2>/dev/null | wc -l)"
}

# ä½¿ç”¨ç¤ºä¾‹
case "${1:-}" in
    "start")
        queue_manager
        ;;
    "add")
        enqueue_task "$2" "$3"
        ;;
    "status")
        queue_status
        ;;
    *)
        echo "ä½¿ç”¨æ–¹æ³•ï¼š"
        echo "  $0 start           # å¯åŠ¨é˜Ÿåˆ—ç®¡ç†å™¨"
        echo "  $0 add <id> <cmd>  # æ·»åŠ ä»»åŠ¡"
        echo "  $0 status          # æŸ¥çœ‹çŠ¶æ€"
        ;;
esac
```

### 8.3 ä¼˜å…ˆçº§ä»»åŠ¡é˜Ÿåˆ—


```bash
#!/bin/bash
# priority_queue.sh - ä¼˜å…ˆçº§ä»»åŠ¡é˜Ÿåˆ—

QUEUE_BASE="/tmp/priority_queue"
PRIORITIES=("high" "medium" "low")

# åˆå§‹åŒ–ä¼˜å…ˆçº§é˜Ÿåˆ—
init_priority_queue() {
    for priority in "${PRIORITIES[@]}"; do
        mkdir -p "$QUEUE_BASE/$priority"
    done
    
    mkdir -p "$QUEUE_BASE/processing" "$QUEUE_BASE/completed"
}

# æ·»åŠ ä¼˜å…ˆçº§ä»»åŠ¡
enqueue_priority_task() {
    local task_id=$1
    local priority=$2
    local command=$3
    
    # éªŒè¯ä¼˜å…ˆçº§
    if [[ ! " ${PRIORITIES[*]} " =~ " ${priority} " ]]; then
        echo "æ— æ•ˆçš„ä¼˜å…ˆçº§: $priority"
        echo "å¯ç”¨ä¼˜å…ˆçº§: ${PRIORITIES[*]}"
        return 1
    fi
    
    local task_file="$QUEUE_BASE/$priority/task_${task_id}_$(date +%s)"
    
    cat > "$task_file" << EOF
TASK_ID=$task_id
PRIORITY=$priority
COMMAND=$command
CREATED=$(date)
EOF
    
    echo "ä¼˜å…ˆçº§ä»»åŠ¡å·²æ·»åŠ ï¼š$task_id (ä¼˜å…ˆçº§: $priority)"
}

# æŒ‰ä¼˜å…ˆçº§è·å–ä»»åŠ¡
dequeue_priority_task() {
    local worker_id=$1
    
    # æŒ‰ä¼˜å…ˆçº§é¡ºåºæ£€æŸ¥ä»»åŠ¡
    for priority in "${PRIORITIES[@]}"; do
        local task_file=$(ls -1t "$QUEUE_BASE/$priority"/task_* 2>/dev/null | tail -1)
        
        if [ -n "$task_file" ] && [ -f "$task_file" ]; then
            local processing_file="$QUEUE_BASE/processing/$(basename "$task_file")_worker_$worker_id"
            if mv "$task_file" "$processing_file" 2>/dev/null; then
                echo "$processing_file"
                return 0
            fi
        fi
    done
    
    return 1
}

# ä¼˜å…ˆçº§å·¥ä½œè¿›ç¨‹
priority_worker() {
    local worker_id=$1
    echo "ä¼˜å…ˆçº§å·¥ä½œè¿›ç¨‹ $worker_id å¯åŠ¨"
    
    while true; do
        if task_file=$(dequeue_priority_task "$worker_id"); then
            echo "å·¥ä½œè¿›ç¨‹ $worker_id å¤„ç†é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼š$(basename "$task_file")"
            
            # è¯»å–å¹¶æ‰§è¡Œä»»åŠ¡
            source "$task_file"
            echo "æ‰§è¡Œä»»åŠ¡ $TASK_ID (ä¼˜å…ˆçº§: $PRIORITY)"
            
            if eval "$COMMAND"; then
                mv "$task_file" "$QUEUE_BASE/completed/$(basename "$task_file")"
                echo "ä»»åŠ¡ $TASK_ID å®Œæˆ"
            else
                echo "ä»»åŠ¡ $TASK_ID æ‰§è¡Œå¤±è´¥"
            fi
        else
            sleep 1
        fi
    done
}

# ä½¿ç”¨ç¤ºä¾‹å‡½æ•°
demo_priority_tasks() {
    init_priority_queue
    
    # æ·»åŠ ä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡
    enqueue_priority_task "backup_database" "high" "echo 'æ‰§è¡Œæ•°æ®åº“å¤‡ä»½'; sleep 3"
    enqueue_priority_task "cleanup_temp" "low" "echo 'æ¸…ç†ä¸´æ—¶æ–‡ä»¶'; sleep 1"
    enqueue_priority_task "send_alert" "high" "echo 'å‘é€ç´§æ€¥è­¦æŠ¥'; sleep 2"
    enqueue_priority_task "update_cache" "medium" "echo 'æ›´æ–°ç¼“å­˜'; sleep 2"
    enqueue_priority_task "generate_report" "low" "echo 'ç”ŸæˆæŠ¥å‘Š'; sleep 4"
    
    # å¯åŠ¨å·¥ä½œè¿›ç¨‹
    for ((i=1; i<=2; i++)); do
        priority_worker "$i" &
    done
    
    sleep 15  # è¿è¡Œ15ç§’
    killall -TERM priority_worker 2>/dev/null
}

# æ ¹æ®å‚æ•°æ‰§è¡Œç›¸åº”æ“ä½œ
case "${1:-demo}" in
    "demo")
        demo_priority_tasks
        ;;
    "init")
        init_priority_queue
        ;;
    "add")
        enqueue_priority_task "$2" "$3" "$4"
        ;;
esac
```

---

## 9. â° é”è¶…æ—¶ä¸å¼‚å¸¸å¤„ç†


### 9.1 ä¸ºä»€ä¹ˆéœ€è¦é”è¶…æ—¶


é”è¶…æ—¶æœºåˆ¶é˜²æ­¢ç¨‹åºå› ä¸ºæ— æ³•è·å–é”è€Œæ°¸è¿œç­‰å¾…ï¼Œå°±åƒé“¶è¡Œæ’é˜Ÿæœ‰æœ€é•¿ç­‰å¾…æ—¶é—´ä¸€æ ·ã€‚

```
æ²¡æœ‰è¶…æ—¶çš„é—®é¢˜ï¼š
- è¿›ç¨‹Aè·å–é”åå´©æºƒï¼Œé”æ°¸è¿œä¸é‡Šæ”¾
- è¿›ç¨‹Bç­‰å¾…é”ï¼Œæ°¸è¿œç­‰ä¸åˆ°
- æ•´ä¸ªç³»ç»Ÿå¡ä½

æœ‰è¶…æ—¶çš„å¥½å¤„ï¼š
- è¶…è¿‡æ—¶é—´åæ”¾å¼ƒç­‰å¾…
- å¯ä»¥é€‰æ‹©é‡è¯•æˆ–æŠ¥å‘Šé”™è¯¯
- ç³»ç»Ÿä¿æŒå“åº”
```

### 9.2 å®ç°é”è¶…æ—¶æœºåˆ¶


```bash
#!/bin/bash
# lock_timeout.sh - é”è¶…æ—¶å¤„ç†

LOCK_FILE="/tmp/timeout_demo.lock"
DEFAULT_TIMEOUT=10

# å¸¦è¶…æ—¶çš„é”è·å–
acquire_lock_timeout() {
    local timeout=${1:-$DEFAULT_TIMEOUT}
    local lock_file=${2:-$LOCK_FILE}
    
    exec 200>"$lock_file"
    
    echo "å°è¯•è·å–é” (è¶…æ—¶: ${timeout}ç§’)..."
    
    if flock -w "$timeout" 200; then
        echo "æˆåŠŸè·å–é”"
        return 0
    else
        local exit_code=$?
        case $exit_code in
            1)
                echo "è·å–é”è¶…æ—¶ (${timeout}ç§’)"
                ;;
            2)
                echo "é”è·å–è¢«ä¸­æ–­"
                ;;
            *)
                echo "é”è·å–å¤±è´¥ (é”™è¯¯ä»£ç : $exit_code)"
                ;;
        esac
        return $exit_code
    fi
}

# å¸¦é‡è¯•çš„é”è·å–
acquire_lock_with_retry() {
    local max_retries=${1:-3}
    local retry_interval=${2:-5}
    local timeout=${3:-10}
    
    local retry_count=0
    
    while [ $retry_count -lt $max_retries ]; do
        echo "ç¬¬ $((retry_count + 1)) æ¬¡å°è¯•è·å–é”..."
        
        if acquire_lock_timeout "$timeout"; then
            return 0
        fi
        
        retry_count=$((retry_count + 1))
        
        if [ $retry_count -lt $max_retries ]; then
            echo "ç­‰å¾… ${retry_interval} ç§’åé‡è¯•..."
            sleep "$retry_interval"
        fi
    done
    
    echo "è·å–é”å¤±è´¥ï¼Œå·²å°è¯• $max_retries æ¬¡"
    return 1
}

# å®‰å…¨çš„é”æ“ä½œåŒ…è£…å™¨
safe_locked_operation() {
    local operation_name=$1
    local timeout=${2:-15}
    
    if acquire_lock_timeout "$timeout"; then
        echo "å¼€å§‹æ‰§è¡Œæ“ä½œ: $operation_name"
        
        # è®¾ç½®é™·é˜±ç¡®ä¿é”è¢«é‡Šæ”¾
        trap 'echo "æ“ä½œè¢«ä¸­æ–­ï¼Œé‡Šæ”¾é”"; exit 130' INT TERM
        
        # æ‰§è¡Œå®é™…æ“ä½œ
        case "$operation_name" in
            "backup")
                echo "æ‰§è¡Œå¤‡ä»½æ“ä½œ..."
                sleep 5
                echo "å¤‡ä»½å®Œæˆ"
                ;;
            "update")
                echo "æ‰§è¡Œæ›´æ–°æ“ä½œ..."
                sleep 8
                echo "æ›´æ–°å®Œæˆ"
                ;;
            "cleanup")
                echo "æ‰§è¡Œæ¸…ç†æ“ä½œ..."
                sleep 3
                echo "æ¸…ç†å®Œæˆ"
                ;;
            *)
                echo "æœªçŸ¥æ“ä½œ: $operation_name"
                return 1
                ;;
        esac
        
        echo "æ“ä½œ $operation_name æˆåŠŸå®Œæˆ"
    else
        echo "æ— æ³•è·å–é”ï¼Œæ“ä½œå–æ¶ˆ: $operation_name"
        return 1
    fi
}

# ä½¿ç”¨ç¤ºä¾‹
if [ "${1:-}" = "demo" ]; then
    echo "=== é”è¶…æ—¶æ¼”ç¤º ==="
    
    # ç¬¬ä¸€ä¸ªè¿›ç¨‹è·å–é”å¹¶ä¿æŒ
    (
        acquire_lock_timeout 30
        echo "ç¬¬ä¸€ä¸ªè¿›ç¨‹æŒæœ‰é”ï¼Œç¡çœ 20ç§’..."
        sleep 20
        echo "ç¬¬ä¸€ä¸ªè¿›ç¨‹å®Œæˆ"
    ) &
    
    sleep 2
    
    # ç¬¬äºŒä¸ªè¿›ç¨‹å°è¯•è·å–é”ï¼ˆä¼šè¶…æ—¶ï¼‰
    echo "--- ç¬¬äºŒä¸ªè¿›ç¨‹å°è¯•è·å–é” ---"
    acquire_lock_timeout 5
    
    wait
else
    # æ­£å¸¸ä½¿ç”¨
    safe_locked_operation "${1:-backup}" "${2:-10}"
fi
```

### 9.3 å¼‚å¸¸å¤„ç†ä¸é”æ¸…ç†


```bash
#!/bin/bash
# lock_cleanup.sh - é”çš„å¼‚å¸¸å¤„ç†å’Œæ¸…ç†

LOCK_DIR="/tmp/robust_locks"
STALE_TIMEOUT=300  # 5åˆ†é’Ÿ

# åˆ›å»ºé”ä¿¡æ¯
create_lock_info() {
    local lock_name=$1
    local lock_dir="$LOCK_DIR/$lock_name"
    
    mkdir -p "$lock_dir"
    
    # è®°å½•é”ä¿¡æ¯
    cat > "$lock_dir/info" << EOF
PID=$$
HOSTNAME=$(hostname)
USER=$(whoami)
CREATED=$(date)
TIMESTAMP=$(date +%s)
COMMAND=$(ps -o args= -p $$)
EOF
    
    echo "$lock_dir"
}

# æ£€æŸ¥é”æ˜¯å¦è¿‡æœŸ
is_lock_stale() {
    local lock_dir=$1
    local info_file="$lock_dir/info"
    
    if [ ! -f "$info_file" ]; then
        return 0  # æ²¡æœ‰ä¿¡æ¯æ–‡ä»¶ï¼Œè®¤ä¸ºæ˜¯è¿‡æœŸé”
    fi
    
    # è¯»å–é”ä¿¡æ¯
    local lock_pid lock_timestamp
    lock_pid=$(grep "PID=" "$info_file" | cut -d'=' -f2)
    lock_timestamp=$(grep "TIMESTAMP=" "$info_file" | cut -d'=' -f2)
    
    # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜å­˜åœ¨
    if ! kill -0 "$lock_pid" 2>/dev/null; then
        echo "é”è¿›ç¨‹ $lock_pid å·²ä¸å­˜åœ¨"
        return 0
    fi
    
    # æ£€æŸ¥æ—¶é—´æ˜¯å¦è¿‡æœŸ
    local current_time=$(date +%s)
    local lock_age=$((current_time - lock_timestamp))
    
    if [ $lock_age -gt $STALE_TIMEOUT ]; then
        echo "é”å·²è¿‡æœŸ (å­˜åœ¨æ—¶é—´: ${lock_age}ç§’)"
        return 0
    fi
    
    return 1
}

# æ¸…ç†è¿‡æœŸé”
cleanup_stale_locks() {
    echo "æ£€æŸ¥å¹¶æ¸…ç†è¿‡æœŸé”..."
    
    if [ ! -d "$LOCK_DIR" ]; then
        return 0
    fi
    
    for lock_dir in "$LOCK_DIR"/*; do
        if [ -d "$lock_dir" ]; then
            local lock_name=$(basename "$lock_dir")
            
            if is_lock_stale "$lock_dir"; then
                echo "æ¸…ç†è¿‡æœŸé”: $lock_name"
                rm -rf "$lock_dir"
            else
                echo "é”ä»æœ‰æ•ˆ: $lock_name"
            fi
        fi
    done
}

# å¥å£®çš„é”è·å–
robust_acquire_lock() {
    local lock_name=$1
    local timeout=${2:-30}
    local lock_dir="$LOCK_DIR/$lock_name"
    
    local start_time=$(date +%s)
    
    while true; do
        # å°è¯•åˆ›å»ºé”ç›®å½•
        if mkdir "$lock_dir" 2>/dev/null; then
            # æˆåŠŸåˆ›å»ºé”
            create_lock_info "$lock_name" >/dev/null
            echo "æˆåŠŸè·å–é”: $lock_name"
            return 0
        fi
        
        # æ£€æŸ¥ç°æœ‰é”æ˜¯å¦è¿‡æœŸ
        if is_lock_stale "$lock_dir"; then
            echo "å‘ç°è¿‡æœŸé”ï¼Œå¼ºåˆ¶æ¸…ç†..."
            rm -rf "$lock_dir"
            continue  # é‡æ–°å°è¯•è·å–é”
        fi
        
        # æ£€æŸ¥è¶…æ—¶
        local current_time=$(date +%s)
        local elapsed=$((current_time - start_time))
        
        if [ $elapsed -ge $timeout ]; then
            echo "è·å–é”è¶…æ—¶: $lock_name"
            return 1
        fi
        
        echo "ç­‰å¾…é”é‡Šæ”¾... ($elapsed/$timeout ç§’)"
        sleep 1
    done
}

# é‡Šæ”¾é”
robust_release_lock() {
    local lock_name=$1
    local lock_dir="$LOCK_DIR/$lock_name"
    
    if [ -d "$lock_dir" ]; then
        # éªŒè¯è¿™æ˜¯æˆ‘ä»¬çš„é”
        local lock_pid
        lock_pid=$(grep "PID=" "$lock_dir/info" 2>/dev/null | cut -d'=' -f2)
        
        if [ "$lock_pid" = "$$" ]; then
            rm -rf "$lock_dir"
            echo "é‡Šæ”¾é”: $lock_name"
        else
            echo "è­¦å‘Šï¼šå°è¯•é‡Šæ”¾ä¸å±äºå½“å‰è¿›ç¨‹çš„é”"
            return 1
        fi
    fi
}

# ä½¿ç”¨å¥å£®é”çš„å®‰å…¨æ“ä½œ
robust_operation() {
    local operation_name=$1
    local lock_name="operation_${operation_name}"
    
    # è®¾ç½®ä¿¡å·å¤„ç†å™¨
    trap 'robust_release_lock "$lock_name"; exit 130' INT TERM
    
    if robust_acquire_lock "$lock_name" 20; then
        echo "å¼€å§‹æ‰§è¡Œæ“ä½œ: $operation_name"
        
        # æ¨¡æ‹Ÿå¯èƒ½å¤±è´¥çš„æ“ä½œ
        if [ "$operation_name" = "risky" ]; then
            echo "æ‰§è¡Œé£é™©æ“ä½œ..."
            sleep 3
            # æ¨¡æ‹Ÿéšæœºå¤±è´¥
            if [ $((RANDOM % 3)) -eq 0 ]; then
                echo "æ“ä½œå¤±è´¥ï¼"
                robust_release_lock "$lock_name"
                return 1
            fi
        else
            echo "æ‰§è¡Œå®‰å…¨æ“ä½œ..."
            sleep 2
        fi
        
        echo "æ“ä½œå®Œæˆ: $operation_name"
        robust_release_lock "$lock_name"
    else
        echo "æ— æ³•è·å–é”ï¼Œæ“ä½œå–æ¶ˆ: $operation_name"
        return 1
    fi
}

# é”ç®¡ç†å‘½ä»¤
case "${1:-}" in
    "cleanup")
        cleanup_stale_locks
        ;;
    "status")
        echo "=== å½“å‰é”çŠ¶æ€ ==="
        if [ -d "$LOCK_DIR" ]; then
            for lock_dir in "$LOCK_DIR"/*; do
                if [ -d "$lock_dir" ]; then
                    echo "é”: $(basename "$lock_dir")"
                    if [ -f "$lock_dir/info" ]; then
                        cat "$lock_dir/info" | sed 's/^/  /'
                    fi
                    echo
                fi
            done
        else
            echo "æ²¡æœ‰æ´»è·ƒçš„é”"
        fi
        ;;
    "test")
        robust_operation "${2:-safe}"
        ;;
    *)
        echo "ç”¨æ³•ï¼š"
        echo "  $0 cleanup        # æ¸…ç†è¿‡æœŸé”"
        echo "  $0 status         # æ˜¾ç¤ºé”çŠ¶æ€"
        echo "  $0 test [safe|risky]  # æµ‹è¯•æ“ä½œ"
        ;;
esac
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¹¶å‘æ§åˆ¶ï¼šé˜²æ­¢å¤šè¿›ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºé€ æˆæ•°æ®ä¸ä¸€è‡´
ğŸ”¸ äº’æ–¥é”ï¼šä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¿›ç¨‹è®¿é—®ä¸´ç•ŒåŒº
ğŸ”¸ ç«äº‰æ¡ä»¶ï¼šå¤šè¿›ç¨‹æ‰§è¡Œé¡ºåºä¸ç¡®å®šå¯¼è‡´ç»“æœä¸å¯é¢„æµ‹
ğŸ”¸ æ­»é”ï¼šè¿›ç¨‹é—´ç›¸äº’ç­‰å¾…èµ„æºå¯¼è‡´éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œ
ğŸ”¸ åŸå­æ“ä½œï¼šä¸å¯åˆ†å‰²çš„æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨å®Œæˆè¦ä¹ˆå…¨éƒ¨ä¸åš
ğŸ”¸ ä¸´ç•ŒåŒºï¼šè®¿é—®å…±äº«èµ„æºçš„ä»£ç æ®µï¼Œéœ€è¦äº’æ–¥ä¿æŠ¤
```

### 10.2 å…³é”®å·¥å…·ä¸æŠ€æœ¯


**ğŸ”¹ flockæ–‡ä»¶é”**
```
ä¼˜ç‚¹ï¼šç®€å•æ˜“ç”¨ï¼Œè‡ªåŠ¨æ¸…ç†ï¼Œè·¨è¿›ç¨‹
ä½¿ç”¨åœºæ™¯ï¼šè„šæœ¬é˜²é‡å¤æ‰§è¡Œï¼Œé…ç½®æ–‡ä»¶å®‰å…¨ä¿®æ”¹
æ³¨æ„äº‹é¡¹ï¼šä»…é™æœ¬æœºä½¿ç”¨ï¼Œæ— æ³•å¤„ç†åˆ†å¸ƒå¼åœºæ™¯
```

**ğŸ”¹ ä¿¡å·é‡æ§åˆ¶**
```
ä½œç”¨ï¼šé™åˆ¶åŒæ—¶è®¿é—®èµ„æºçš„è¿›ç¨‹æ•°é‡
å®ç°æ–¹å¼ï¼šå‘½åç®¡é“ã€ç›®å½•è®¡æ•°ã€ä»¤ç‰Œæ–‡ä»¶
åº”ç”¨åœºæ™¯ï¼šé™åˆ¶å¹¶å‘ä¸‹è½½ã€æ•°æ®åº“è¿æ¥æ± 
```

**ğŸ”¹ æ­»é”é¢„é˜²**
```
ç»Ÿä¸€é”é¡ºåºï¼šæ‰€æœ‰è¿›ç¨‹æŒ‰ç›¸åŒé¡ºåºè·å–é”
è¶…æ—¶æœºåˆ¶ï¼šé¿å…æ— é™ç­‰å¾…
èµ„æºé¢„åˆ†é…ï¼šä¸€æ¬¡æ€§è·å–æ‰€éœ€çš„æ‰€æœ‰èµ„æº
```

### 10.3 æœ€ä½³å®è·µåŸåˆ™


**ğŸ¯ å®‰å…¨æ€§ä¼˜å…ˆ**
- **æœ€å°ä¸´ç•ŒåŒº**ï¼šåªä¿æŠ¤çœŸæ­£éœ€è¦çš„ä»£ç æ®µ
- **å¼‚å¸¸å¤„ç†**ï¼šç¡®ä¿å¼‚å¸¸æƒ…å†µä¸‹é”èƒ½è¢«æ­£ç¡®é‡Šæ”¾
- **è¶…æ—¶æœºåˆ¶**ï¼šé¿å…å› é”é—®é¢˜å¯¼è‡´ç³»ç»Ÿå¡æ­»
- **é”æ¸…ç†**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸå’Œåƒµå°¸é”

**ğŸ¯ æ€§èƒ½è€ƒè™‘**
- **é¿å…è¿‡åº¦åŠ é”**ï¼šä¸è¦ä¸ºäº†å®‰å…¨è€Œç‰ºç‰²å¤ªå¤šæ€§èƒ½
- **é€‰æ‹©åˆé€‚çš„é”ç²’åº¦**ï¼šæ–‡ä»¶çº§ vs è®°å½•çº§
- **å‡å°‘é”æŒæœ‰æ—¶é—´**ï¼šå°½å¿«å®Œæˆä¸´ç•ŒåŒºæ“ä½œ
- **è€ƒè™‘æ— é”ç®—æ³•**ï¼šæŸäº›åœºæ™¯å¯ä»¥ç”¨åŸå­æ“ä½œæ›¿ä»£é”

**ğŸ¯ å¯ç»´æŠ¤æ€§**
- **æ¸…æ™°çš„é”å‘½å**ï¼šè®©é”çš„ç”¨é€”ä¸€ç›®äº†ç„¶
- **å®Œæ•´çš„é”™è¯¯å¤„ç†**ï¼šè®°å½•é”æ“ä½œçš„æˆåŠŸå’Œå¤±è´¥
- **ç›‘æ§å’Œæ—¥å¿—**ï¼šè·Ÿè¸ªé”çš„ä½¿ç”¨æƒ…å†µ
- **æ–‡æ¡£åŒ–**ï¼šè¯´æ˜é”çš„ä¿æŠ¤èŒƒå›´å’Œä½¿ç”¨è§„åˆ™

### 10.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**ğŸ”¸ é”ç²’åº¦é€‰æ‹©**
```
ç²—ç²’åº¦é”ï¼š
- ç®€å•æ˜“å®ç°ï¼Œä¸å®¹æ˜“å‡ºé”™
- ä½†ä¼šé™ä½å¹¶å‘æ€§èƒ½
- é€‚åˆç®€å•åœºæ™¯

ç»†ç²’åº¦é”ï¼š
- æé«˜å¹¶å‘æ€§èƒ½
- ä½†å¢åŠ å¤æ‚æ€§ï¼Œå®¹æ˜“æ­»é”
- é€‚åˆé«˜æ€§èƒ½è¦æ±‚åœºæ™¯
```

**ğŸ”¸ æ€§èƒ½ä¼˜åŒ–æŠ€å·§**
```
è¯»å†™é”åˆ†ç¦»ï¼š
- å¤šä¸ªè¯»æ“ä½œå¯ä»¥å¹¶å‘
- å†™æ“ä½œæ’ä»–è®¿é—®
- æé«˜è¯»å¤šå†™å°‘åœºæ™¯çš„æ€§èƒ½

æ‰¹é‡æ“ä½œï¼š
- å‡å°‘è·å–/é‡Šæ”¾é”çš„æ¬¡æ•°
- ä¸€æ¬¡å¤„ç†å¤šä¸ªæ“ä½œ
- æé«˜æ•´ä½“ååé‡
```

### 10.5 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ è„šæœ¬å¼€å‘**
- é˜²æ­¢cronä½œä¸šé‡å¤æ‰§è¡Œ
- ä¿æŠ¤é…ç½®æ–‡ä»¶ä¿®æ”¹
- å®ç°ç®€å•çš„åˆ†å¸ƒå¼åè°ƒ

**ğŸ¯ ç³»ç»Ÿç®¡ç†**
- æ—¥å¿—è½®è½¬çš„åŸå­æ€§
- æœåŠ¡å¯åœçš„äº’æ–¥æ§åˆ¶
- å¤‡ä»½ä»»åŠ¡çš„å¹¶å‘é™åˆ¶

**ğŸ¯ è‡ªåŠ¨åŒ–è¿ç»´**
- éƒ¨ç½²è„šæœ¬çš„å®‰å…¨æ‰§è¡Œ
- ç›‘æ§æ•°æ®çš„ä¸€è‡´æ€§ä¿è¯
- ä»»åŠ¡è°ƒåº¦çš„å†²çªé¿å…

> ğŸ’¡ **è®°å¿†è¦ç‚¹**ï¼š
> - å¹¶å‘ä¸éš¾ï¼Œå…³é”®æ˜¯ä¿æŠ¤å¥½ä¸´ç•ŒåŒº
> - é”æ˜¯å·¥å…·ï¼Œä¸æ˜¯ç›®çš„ï¼Œå®‰å…¨å’Œæ€§èƒ½è¦å¹³è¡¡
> - è¶…æ—¶å’Œå¼‚å¸¸å¤„ç†æ˜¯å¥å£®ç³»ç»Ÿçš„å¿…å¤‡
> - ç®€å•çš„æ–¹æ¡ˆå¾€å¾€æ¯”å¤æ‚çš„æ›´å¯é 

**æ ¸å¿ƒå£è¯€**ï¼š
- å…±äº«èµ„æºè¦ä¿æŠ¤ï¼Œä¸´ç•ŒåŒºå†…ä¸æ‰“æ‰°
- è·å–é¡ºåºè¦ç»Ÿä¸€ï¼Œè¶…æ—¶æœºåˆ¶é˜²å¡æ­»  
- å¼‚å¸¸å¤„ç†è¦å®Œæ•´ï¼Œé”çš„æ¸…ç†ä¸èƒ½å¿˜
- æ€§èƒ½å®‰å…¨ä¸¤å…¼é¡¾ï¼Œç®€å•å¯é æœ€é‡è¦