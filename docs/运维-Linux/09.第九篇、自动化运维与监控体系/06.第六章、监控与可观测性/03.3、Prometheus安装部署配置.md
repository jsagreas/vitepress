---
title: 3ã€Prometheuså®‰è£…éƒ¨ç½²é…ç½®
---
## ğŸ“š ç›®å½•

1. [Prometheusæ¦‚è¿°ä¸æ ¸å¿ƒä»·å€¼](#1-prometheusæ¦‚è¿°ä¸æ ¸å¿ƒä»·å€¼)
2. [äºŒè¿›åˆ¶å®‰è£…éƒ¨ç½²](#2-äºŒè¿›åˆ¶å®‰è£…éƒ¨ç½²)
3. [Dockerå®¹å™¨åŒ–éƒ¨ç½²](#3-dockerå®¹å™¨åŒ–éƒ¨ç½²)
4. [é…ç½®æ–‡ä»¶è¯¦è§£](#4-é…ç½®æ–‡ä»¶è¯¦è§£)
5. [å­˜å‚¨é…ç½®ä¸ä¼˜åŒ–](#5-å­˜å‚¨é…ç½®ä¸ä¼˜åŒ–)
6. [æœåŠ¡å¯åŠ¨ä¸å‚æ•°è°ƒä¼˜](#6-æœåŠ¡å¯åŠ¨ä¸å‚æ•°è°ƒä¼˜)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Prometheusæ¦‚è¿°ä¸æ ¸å¿ƒä»·å€¼


### 1.1 ä»€ä¹ˆæ˜¯Prometheus


**ç®€å•ç†è§£**ï¼šPrometheuså°±åƒä¸€ä¸ª**æ•°æ®æ”¶é›†å™¨**ï¼Œä¸“é—¨è´Ÿè´£ä»å„ç§ç³»ç»Ÿä¸­æ”¶é›†è¿è¡Œæ•°æ®ï¼Œç„¶åå­˜å‚¨èµ·æ¥ä¾›æˆ‘ä»¬æŸ¥è¯¢åˆ†æã€‚

```
ä¼ ç»Ÿç›‘æ§ï¼š           Prometheusç›‘æ§ï¼š
æ‰‹åŠ¨æŸ¥çœ‹æ—¥å¿—    â†’    è‡ªåŠ¨æ”¶é›†æŒ‡æ ‡
å®šæ—¶æ£€æŸ¥çŠ¶æ€    â†’    å®æ—¶ç›‘æ§å‘Šè­¦
è¢«åŠ¨å‘ç°é—®é¢˜    â†’    ä¸»åŠ¨é¢„é˜²æ•…éšœ
```

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- ğŸ”¸ **æ‹‰å–æ¨¡å¼**ï¼šä¸»åŠ¨å»å„ä¸ªç›®æ ‡æ‹‰å–æ•°æ®ï¼Œä¸ç”¨è¢«ç›‘æ§ç«¯ä¸»åŠ¨æ¨é€
- ğŸ”¸ **æ—¶åºæ•°æ®**ï¼šæŒ‰æ—¶é—´å­˜å‚¨æ•°æ®ï¼Œæ–¹ä¾¿çœ‹è¶‹åŠ¿å’Œå˜åŒ–
- ğŸ”¸ **å¤šç»´æ ‡ç­¾**ï¼šç»™æ•°æ®åŠ æ ‡ç­¾ï¼Œæ–¹ä¾¿åˆ†ç±»æŸ¥è¯¢
- ğŸ”¸ **çµæ´»æŸ¥è¯¢**ï¼šç”¨PromQLæŸ¥è¯¢è¯­è¨€ï¼Œæƒ³æŸ¥ä»€ä¹ˆéƒ½èƒ½æŸ¥åˆ°

### 1.2 ç›‘æ§ä½“ç³»æ¶æ„


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨æœåŠ¡    â”‚    â”‚   æ•°æ®åº“     â”‚    â”‚   æœåŠ¡å™¨    â”‚
â”‚  (Exporter) â”‚    â”‚  (Exporter)  â”‚    â”‚ (Node Export)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ (HTTPæ‹‰å–)
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚    Prometheus       â”‚ â† æ ¸å¿ƒç»„ä»¶
               â”‚   (æ•°æ®æ”¶é›†å­˜å‚¨)     â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚     Grafana         â”‚ â† å±•ç¤ºç•Œé¢
               â”‚   (æ•°æ®å¯è§†åŒ–)       â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å·¥ä½œæµç¨‹**ï¼š
1ï¸âƒ£ **Exporteræš´éœ²æŒ‡æ ‡**ï¼šå„ç§æœåŠ¡é€šè¿‡HTTPæ¥å£æš´éœ²ç›‘æ§æ•°æ®  
2ï¸âƒ£ **Prometheusæ‹‰å–**ï¼šå®šæ—¶ä»å„ä¸ªExporteræ‹‰å–æ•°æ®  
3ï¸âƒ£ **æ•°æ®å­˜å‚¨**ï¼šå°†æ”¶é›†çš„æ•°æ®æŒ‰æ—¶é—´åºåˆ—å­˜å‚¨  
4ï¸âƒ£ **æŸ¥è¯¢å±•ç¤º**ï¼šé€šè¿‡Grafanaæˆ–APIæŸ¥è¯¢å±•ç¤ºæ•°æ®  

### 1.3 é€‚ç”¨åœºæ™¯åˆ†æ


| åœºæ™¯ç±»å‹ | **ç›‘æ§å¯¹è±¡** | **å…³é”®æŒ‡æ ‡** | **ä»·å€¼ä½“ç°** |
|---------|------------|-------------|-------------|
| ğŸ–¥ï¸ **æœåŠ¡å™¨ç›‘æ§** | `CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ` | `ç³»ç»Ÿè´Ÿè½½ã€èµ„æºä½¿ç”¨ç‡` | `åŠæ—¶å‘ç°æ€§èƒ½ç“¶é¢ˆ` |
| ğŸŒ **åº”ç”¨ç›‘æ§** | `å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€ååé‡` | `ç”¨æˆ·ä½“éªŒç›¸å…³æŒ‡æ ‡` | `ä¿éšœæœåŠ¡è´¨é‡` |
| ğŸ’¾ **æ•°æ®åº“ç›‘æ§** | `è¿æ¥æ•°ã€æŸ¥è¯¢æ€§èƒ½ã€ç¼“å­˜å‘½ä¸­` | `æ•°æ®åº“å¥åº·çŠ¶å†µ` | `é¢„é˜²æ•°æ®æ•…éšœ` |
| â˜ï¸ **å®¹å™¨ç›‘æ§** | `PodçŠ¶æ€ã€èµ„æºé™åˆ¶ã€ç½‘ç»œ` | `å®¹å™¨è¿è¡ŒçŠ¶æ€` | `ç¡®ä¿å®¹å™¨ç¨³å®š` |

---

## 2. ğŸ“¦ äºŒè¿›åˆ¶å®‰è£…éƒ¨ç½²


### 2.1 ç³»ç»Ÿç¯å¢ƒå‡†å¤‡


**ç¯å¢ƒè¦æ±‚**ï¼š
- ğŸŸ¢ **æ“ä½œç³»ç»Ÿ**ï¼šCentOS 7+/Ubuntu 18.04+
- ğŸŸ¢ **å†…å­˜è¦æ±‚**ï¼šæœ€å°‘2GBï¼Œæ¨è4GBä»¥ä¸Š  
- ğŸŸ¢ **ç£ç›˜ç©ºé—´**ï¼šæ ¹æ®æ•°æ®é‡ï¼Œæ¨è100GBä»¥ä¸Š
- ğŸŸ¢ **ç½‘ç»œè®¿é—®**ï¼šèƒ½è®¿é—®è¢«ç›‘æ§ç›®æ ‡çš„HTTPç«¯å£

**ç”¨æˆ·å‡†å¤‡**ï¼š
```bash
# åˆ›å»ºä¸“ç”¨ç”¨æˆ·ï¼ˆä¸è¦ç”¨rootè¿è¡Œï¼‰
sudo useradd -M -r -s /bin/false prometheus
sudo mkdir -p /etc/prometheus /var/lib/prometheus
sudo chown prometheus:prometheus /etc/prometheus /var/lib/prometheus
```

### 2.2 ä¸‹è½½å®‰è£…æ­¥éª¤


**ç¬¬ä¸€æ­¥ï¼šä¸‹è½½è½¯ä»¶åŒ…**
```bash
# ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ï¼ˆæŸ¥çœ‹å®˜ç½‘è·å–æœ€æ–°ç‰ˆæœ¬å·ï¼‰
cd /tmp
wget https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz

# è§£å‹æ–‡ä»¶
tar -xzf prometheus-2.45.0.linux-amd64.tar.gz
cd prometheus-2.45.0.linux-amd64/
```

**ç¬¬äºŒæ­¥ï¼šå®‰è£…æ–‡ä»¶**
```bash
# å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶åˆ°ç³»ç»Ÿè·¯å¾„
sudo cp prometheus promtool /usr/local/bin/
sudo chown prometheus:prometheus /usr/local/bin/prometheus /usr/local/bin/promtool

# å¤åˆ¶é…ç½®æ–‡ä»¶å’Œæ•°æ®
sudo cp -r consoles console_libraries /etc/prometheus/
sudo chown -R prometheus:prometheus /etc/prometheus/
```

**ç¬¬ä¸‰æ­¥ï¼šéªŒè¯å®‰è£…**
```bash
# æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯
prometheus --version
# è¾“å‡ºï¼šprometheus, version 2.45.0 ...

promtool --help
# æ˜¾ç¤ºå·¥å…·å¸®åŠ©ä¿¡æ¯
```

### 2.3 åˆ›å»ºç³»ç»ŸæœåŠ¡


**ç¼–å†™æœåŠ¡æ–‡ä»¶** `/etc/systemd/system/prometheus.service`ï¼š
```ini
[Unit]
Description=Prometheus Server
Documentation=https://prometheus.io/docs/
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
Restart=on-failure
RestartSec=5s
ExecStart=/usr/local/bin/prometheus \
  --config.file=/etc/prometheus/prometheus.yml \
  --storage.tsdb.path=/var/lib/prometheus/ \
  --web.console.templates=/etc/prometheus/consoles \
  --web.console.libraries=/etc/prometheus/console_libraries \
  --web.listen-address=0.0.0.0:9090 \
  --web.enable-lifecycle

[Install]
WantedBy=multi-user.target
```

**å¯åŠ¨æœåŠ¡**ï¼š
```bash
# é‡æ–°åŠ è½½systemdé…ç½®
sudo systemctl daemon-reload

# å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl start prometheus
sudo systemctl enable prometheus

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status prometheus
```

---

## 3. ğŸ³ Dockerå®¹å™¨åŒ–éƒ¨ç½²


### 3.1 å•å®¹å™¨å¿«é€Ÿéƒ¨ç½²


**æœ€ç®€å•çš„å¯åŠ¨æ–¹å¼**ï¼š
```bash
# ç›´æ¥è¿è¡Œï¼ˆæµ‹è¯•ç”¨ï¼‰
docker run -d \
  --name prometheus \
  -p 9090:9090 \
  prom/prometheus:latest
```

**ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**ï¼ˆæ¨èæ–¹å¼ï¼‰ï¼š
```bash
# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p /opt/prometheus/{config,data}
chmod 777 /opt/prometheus/data

# å¯åŠ¨å®¹å™¨withæŒ‚è½½
docker run -d \
  --name prometheus \
  --restart unless-stopped \
  -p 9090:9090 \
  -v /opt/prometheus/config:/etc/prometheus \
  -v /opt/prometheus/data:/prometheus \
  prom/prometheus:latest \
  --config.file=/etc/prometheus/prometheus.yml \
  --storage.tsdb.path=/prometheus \
  --web.console.templates=/etc/prometheus/consoles \
  --web.console.libraries=/etc/prometheus/console_libraries \
  --web.listen-address=0.0.0.0:9090
```

### 3.2 Docker Composeéƒ¨ç½²


**åˆ›å»ºdocker-compose.ymlæ–‡ä»¶**ï¼š
```yaml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.listen-address=0.0.0.0:9090'
      - '--storage.tsdb.retention.time=15d'

volumes:
  prometheus_data:
```

**ä¸€é”®å¯åŠ¨**ï¼š
```bash
# å¯åŠ¨æœåŠ¡æ ˆ
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f prometheus

# åœæ­¢æœåŠ¡
docker-compose down
```

### 3.3 å®¹å™¨éƒ¨ç½²ä¼˜åŠ¿


âœ… **éƒ¨ç½²ç®€å•**ï¼šä¸€æ¡å‘½ä»¤å³å¯å¯åŠ¨  
âœ… **ç¯å¢ƒéš”ç¦»**ï¼šä¸æ±¡æŸ“å®¿ä¸»æœºç¯å¢ƒ  
âœ… **ç‰ˆæœ¬ç®¡ç†**ï¼šè½»æ¾åˆ‡æ¢ä¸åŒç‰ˆæœ¬  
âœ… **èµ„æºæ§åˆ¶**ï¼šå¯é™åˆ¶CPUå’Œå†…å­˜ä½¿ç”¨  
âœ… **å¿«é€Ÿé‡å»º**ï¼šå‡ºé—®é¢˜å¯å¿«é€Ÿé‡æ–°åˆ›å»º  

---

## 4. âš™ï¸ é…ç½®æ–‡ä»¶è¯¦è§£


### 4.1 é…ç½®æ–‡ä»¶ç»“æ„æ¦‚è§ˆ


**prometheus.yml** æ˜¯Prometheusçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼ŒåŒ…å«å››ä¸ªä¸»è¦éƒ¨åˆ†ï¼š

```yaml
# å…¨å±€é…ç½®
global:
  # å…¨å±€å‚æ•°è®¾ç½®

# è§„åˆ™æ–‡ä»¶é…ç½®  
rule_files:
  # å‘Šè­¦è§„åˆ™æ–‡ä»¶è·¯å¾„

# æŠ“å–é…ç½®
scrape_configs:
  # æ•°æ®é‡‡é›†ç›®æ ‡é…ç½®

# å‘Šè­¦ç®¡ç†å™¨é…ç½®
alerting:
  # å‘Šè­¦å‘é€é…ç½®
```

### 4.2 å…¨å±€é…ç½®è¯¦è§£


```yaml
global:
  # æŠ“å–é—´éš”ï¼ˆå¤šä¹…æ‹‰å–ä¸€æ¬¡æ•°æ®ï¼‰
  scrape_interval: 15s      # é»˜è®¤15ç§’
  
  # è§„åˆ™è¯„ä¼°é—´éš”ï¼ˆå¤šä¹…æ£€æŸ¥ä¸€æ¬¡å‘Šè­¦è§„åˆ™ï¼‰
  evaluation_interval: 15s  # é»˜è®¤15ç§’
  
  # å¤–éƒ¨æ ‡ç­¾ï¼ˆç»™æ‰€æœ‰æ•°æ®åŠ çš„å…¬å…±æ ‡ç­¾ï¼‰
  external_labels:
    monitor: 'my-prometheus'    # ç›‘æ§é›†ç¾¤æ ‡è¯†
    region: 'beijing'           # åœ°åŸŸæ ‡è¯†
    env: 'production'          # ç¯å¢ƒæ ‡è¯†
```

**å‚æ•°å«ä¹‰è§£é‡Š**ï¼š
- ğŸ”¸ **scrape_interval**ï¼šæƒ³è±¡æˆ"ä½“æ£€é—´éš”"ï¼Œå¤šä¹…æ£€æŸ¥ä¸€æ¬¡å¥åº·çŠ¶å†µ
- ğŸ”¸ **evaluation_interval**ï¼šæƒ³è±¡æˆ"æŠ¥è­¦æ£€æŸ¥é—´éš”"ï¼Œå¤šä¹…æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦éœ€è¦æŠ¥è­¦  
- ğŸ”¸ **external_labels**ï¼šç»™æ‰€æœ‰æ•°æ®è´´çš„"èº«ä»½æ ‡ç­¾"ï¼Œæ–¹ä¾¿åŒºåˆ†ä¸åŒç¯å¢ƒ

### 4.3 æŠ“å–é…ç½®è¯¦è§£


**åŸºæœ¬ç»“æ„**ï¼š
```yaml
scrape_configs:
  # ç›‘æ§Prometheusè‡ªå·±
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
```

**å®Œæ•´é…ç½®ç¤ºä¾‹**ï¼š
```yaml
scrape_configs:
  # ç›‘æ§LinuxæœåŠ¡å™¨
  - job_name: 'linux-servers'
    scrape_interval: 10s           # è¦†ç›–å…¨å±€é—´éš”
    metrics_path: '/metrics'       # æŒ‡æ ‡è·å–è·¯å¾„
    static_configs:
      - targets: 
          - '192.168.1.10:9100'    # æœåŠ¡å™¨1
          - '192.168.1.11:9100'    # æœåŠ¡å™¨2
        labels:
          group: 'web-servers'      # è‡ªå®šä¹‰æ ‡ç­¾
          
  # ç›‘æ§æ•°æ®åº“
  - job_name: 'mysql'
    static_configs:
      - targets: ['192.168.1.20:9104']
        labels:
          service: 'mysql'
          role: 'master'
```

**é‡è¦é…ç½®å‚æ•°**ï¼š

| å‚æ•°åç§° | **ä½œç”¨è¯´æ˜** | **é»˜è®¤å€¼** | **ä½¿ç”¨åœºæ™¯** |
|---------|-------------|-----------|-------------|
| `job_name` | `ä»»åŠ¡åç§°ï¼Œç”¨äºæ ‡è¯†` | `å¿…å¡«` | `åŒºåˆ†ä¸åŒç±»å‹ç›‘æ§` |
| `scrape_interval` | `æŠ“å–é—´éš”æ—¶é—´` | `ç»§æ‰¿global` | `é«˜é¢‘ç›‘æ§å¯è®¾ç½®æ›´çŸ­` |
| `metrics_path` | `æŒ‡æ ‡è·å–è·¯å¾„` | `/metrics` | `æŸäº›exporterè·¯å¾„ä¸åŒ` |
| `static_configs` | `é™æ€ç›®æ ‡é…ç½®` | `æ— ` | `å›ºå®šIPçš„æœåŠ¡å™¨` |
| `file_sd_configs` | `æ–‡ä»¶å‘ç°é…ç½®` | `æ— ` | `åŠ¨æ€ç®¡ç†å¤§é‡ç›®æ ‡` |

### 4.4 è§„åˆ™æ–‡ä»¶é…ç½®


```yaml
rule_files:
  - "/etc/prometheus/rules/*.yml"    # åŠ è½½æ‰€æœ‰è§„åˆ™æ–‡ä»¶
  - "/etc/prometheus/alert.yml"      # ç‰¹å®šå‘Šè­¦æ–‡ä»¶
```

**å‘Šè­¦è§„åˆ™ç¤ºä¾‹** `/etc/prometheus/rules/server.yml`ï¼š
```yaml
groups:
  - name: server-alerts
    rules:
      - alert: ServerDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "æœåŠ¡å™¨ {{ $labels.instance }} æ— æ³•è®¿é—®"
          description: "æœåŠ¡å™¨å·²ç»ä¸‹çº¿è¶…è¿‡1åˆ†é’Ÿ"
```

---

## 5. ğŸ’¾ å­˜å‚¨é…ç½®ä¸ä¼˜åŒ–


### 5.1 æ•°æ®å­˜å‚¨æœºåˆ¶


**Prometheusæ•°æ®å­˜å‚¨ç‰¹ç‚¹**ï¼š
- ğŸ”¸ **æ—¶åºæ•°æ®åº“**ï¼šä¸“é—¨å­˜å‚¨å¸¦æ—¶é—´æˆ³çš„æ•°æ®
- ğŸ”¸ **æœ¬åœ°å­˜å‚¨**ï¼šæ•°æ®å­˜åœ¨æœ¬æœºç£ç›˜ï¼Œä¸ä¾èµ–å¤–éƒ¨æ•°æ®åº“
- ğŸ”¸ **å‹ç¼©å­˜å‚¨**ï¼šè‡ªåŠ¨å‹ç¼©å†å²æ•°æ®èŠ‚çœç©ºé—´
- ğŸ”¸ **è‡ªåŠ¨æ¸…ç†**ï¼šè¶…è¿‡ä¿ç•™æœŸçš„æ•°æ®è‡ªåŠ¨åˆ é™¤

### 5.2 å­˜å‚¨ç›¸å…³é…ç½®


```yaml
# åœ¨å¯åŠ¨å‚æ•°ä¸­é…ç½®
--storage.tsdb.path=/var/lib/prometheus/        # æ•°æ®å­˜å‚¨ç›®å½•
--storage.tsdb.retention.time=15d               # æ•°æ®ä¿ç•™15å¤©
--storage.tsdb.retention.size=50GB              # æœ€å¤§å­˜å‚¨50GB
--storage.tsdb.min-block-duration=2h            # æœ€å°æ•°æ®å—æ—¶é—´
--storage.tsdb.max-block-duration=36h           # æœ€å¤§æ•°æ®å—æ—¶é—´
```

**å‚æ•°å«ä¹‰**ï¼š
- ğŸ”¸ **retention.time**ï¼šæ•°æ®ä¿ç•™æ—¶é—´ï¼Œè¿‡æœŸè‡ªåŠ¨åˆ é™¤
- ğŸ”¸ **retention.size**ï¼šå­˜å‚¨ç©ºé—´é™åˆ¶ï¼Œè¶…è¿‡ååˆ é™¤æœ€è€æ•°æ®  
- ğŸ”¸ **block-duration**ï¼šæ•°æ®åˆ†å—å¤§å°ï¼Œå½±å“æŸ¥è¯¢æ€§èƒ½

### 5.3 å­˜å‚¨å®¹é‡è§„åˆ’


**å®¹é‡ä¼°ç®—å…¬å¼**ï¼š
```
æ¯æ—¥å­˜å‚¨é‡ = æŒ‡æ ‡æ•°é‡ Ã— é‡‡æ ·é¢‘ç‡ Ã— æ•°æ®ç‚¹å¤§å°

ç¤ºä¾‹è®¡ç®—ï¼š
- 1000ä¸ªæŒ‡æ ‡
- 15ç§’é‡‡æ ·ä¸€æ¬¡ = 5760æ¬¡/å¤©
- æ¯ä¸ªæ•°æ®ç‚¹çº¦16å­—èŠ‚
- æ¯æ—¥å­˜å‚¨ = 1000 Ã— 5760 Ã— 16 = 92MB/å¤©
- ä¿ç•™15å¤© = 92MB Ã— 15 = 1.4GB
```

**ä¸åŒè§„æ¨¡å­˜å‚¨å»ºè®®**ï¼š

| ç›‘æ§è§„æ¨¡ | **æŒ‡æ ‡æ•°é‡** | **å»ºè®®ä¿ç•™æœŸ** | **é¢„ä¼°å­˜å‚¨** | **ç¡¬ä»¶å»ºè®®** |
|---------|-------------|--------------|-------------|-------------|
| ğŸŸ¢ **å°è§„æ¨¡** | `< 10ä¸‡` | `30å¤©` | `< 50GB` | `æ™®é€šSSDå³å¯` |
| ğŸŸ¡ **ä¸­ç­‰è§„æ¨¡** | `10ä¸‡-100ä¸‡` | `15å¤©` | `100-500GB` | `é«˜é€ŸSSDæ¨è` |
| ğŸ”´ **å¤§è§„æ¨¡** | `> 100ä¸‡` | `7-15å¤©` | `> 500GB` | `ä¼ä¸šçº§SSDå¿…éœ€` |

---

## 6. ğŸš€ æœåŠ¡å¯åŠ¨ä¸å‚æ•°è°ƒä¼˜


### 6.1 æ ¸å¿ƒå¯åŠ¨å‚æ•°


```bash
prometheus \
  --config.file=/etc/prometheus/prometheus.yml \      # é…ç½®æ–‡ä»¶è·¯å¾„
  --storage.tsdb.path=/var/lib/prometheus/ \          # æ•°æ®ç›®å½•
  --web.listen-address=0.0.0.0:9090 \                 # ç›‘å¬åœ°å€
  --web.max-connections=512 \                         # æœ€å¤§è¿æ¥æ•°
  --web.read-timeout=5m \                             # è¯»å–è¶…æ—¶
  --web.enable-lifecycle \                            # å¯ç”¨çƒ­é‡è½½
  --storage.tsdb.retention.time=15d \                 # æ•°æ®ä¿ç•™æœŸ
  --query.max-concurrency=20                          # æœ€å¤§å¹¶å‘æŸ¥è¯¢
```

### 6.2 æ€§èƒ½ä¼˜åŒ–å‚æ•°


**å†…å­˜ç›¸å…³**ï¼š
```bash
# JVMå†…å­˜è®¾ç½®ï¼ˆå¦‚æœä½¿ç”¨Javaç‰ˆæœ¬ï¼‰
-Xms4g -Xmx8g

# ç³»ç»Ÿå‚æ•°ä¼˜åŒ–
--query.max-samples=50000000        # å•æ¬¡æŸ¥è¯¢æœ€å¤§æ ·æœ¬æ•°
--storage.tsdb.head-chunks-write-queue-size=1000  # å†™å…¥é˜Ÿåˆ—å¤§å°
```

**ç½‘ç»œç›¸å…³**ï¼š
```bash
--web.max-connections=1024          # å¢åŠ æœ€å¤§è¿æ¥æ•°
--web.read-timeout=30s               # è°ƒæ•´è¯»å–è¶…æ—¶
--web.route-prefix=/prometheus       # æ·»åŠ URLå‰ç¼€
```

### 6.3 ç”Ÿäº§ç¯å¢ƒå¯åŠ¨è„šæœ¬


**åˆ›å»ºå¯åŠ¨è„šæœ¬** `/opt/prometheus/start.sh`ï¼š
```bash
#!/bin/bash

# è®¾ç½®å˜é‡
PROM_HOME="/opt/prometheus"
PROM_USER="prometheus"
CONFIG_FILE="${PROM_HOME}/prometheus.yml"
DATA_DIR="${PROM_HOME}/data"
LOG_FILE="${PROM_HOME}/prometheus.log"

# æ£€æŸ¥é…ç½®æ–‡ä»¶
echo "æ£€æŸ¥é…ç½®æ–‡ä»¶..."
/usr/local/bin/promtool check config ${CONFIG_FILE}
if [ $? -ne 0 ]; then
    echo "é…ç½®æ–‡ä»¶æ£€æŸ¥å¤±è´¥ï¼"
    exit 1
fi

# å¯åŠ¨Prometheus
echo "å¯åŠ¨Prometheus..."
su - ${PROM_USER} -c "
/usr/local/bin/prometheus \
  --config.file=${CONFIG_FILE} \
  --storage.tsdb.path=${DATA_DIR} \
  --web.listen-address=0.0.0.0:9090 \
  --web.external-url=http://$(hostname):9090 \
  --web.enable-lifecycle \
  --storage.tsdb.retention.time=15d \
  --log.level=info \
  >> ${LOG_FILE} 2>&1 &
"

echo "Prometheuså¯åŠ¨å®Œæˆï¼Œæ—¥å¿—æ–‡ä»¶ï¼š${LOG_FILE}"
echo "è®¿é—®åœ°å€ï¼šhttp://$(hostname):9090"
```

### 6.4 æœåŠ¡çŠ¶æ€æ£€æŸ¥


**æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€**ï¼š
```bash
# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep 9090

# æ£€æŸ¥è¿›ç¨‹
ps aux | grep prometheus

# æ£€æŸ¥Webç•Œé¢
curl -s http://localhost:9090/-/healthy
# è¿”å›"Prometheus is Healthy"è¡¨ç¤ºæ­£å¸¸

# æ£€æŸ¥é…ç½®é‡è½½
curl -X POST http://localhost:9090/-/reload
```

**æ—¥å¿—ç›‘æ§**ï¼š
```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/prometheus.log

# æ£€æŸ¥é”™è¯¯
grep -i error /var/log/prometheus.log
grep -i warning /var/log/prometheus.log
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Prometheusæœ¬è´¨ï¼šåŸºäºæ‹‰å–æ¨¡å¼çš„æ—¶åºæ•°æ®åº“ç›‘æ§ç³»ç»Ÿ
ğŸ”¸ éƒ¨ç½²æ–¹å¼ï¼šäºŒè¿›åˆ¶éƒ¨ç½²çµæ´»å¯æ§ï¼Œå®¹å™¨éƒ¨ç½²ç®€å•å¿«æ·  
ğŸ”¸ é…ç½®æ ¸å¿ƒï¼šprometheus.ymlå®šä¹‰å…¨å±€å‚æ•°ã€æŠ“å–ç›®æ ‡ã€è§„åˆ™æ–‡ä»¶
ğŸ”¸ å­˜å‚¨æœºåˆ¶ï¼šæœ¬åœ°TSDBå­˜å‚¨ï¼Œæ”¯æŒæ•°æ®å‹ç¼©å’Œè‡ªåŠ¨æ¸…ç†
ğŸ”¸ æœåŠ¡ç®¡ç†ï¼šsystemdç®¡ç†æœåŠ¡ï¼Œæ”¯æŒé…ç½®çƒ­é‡è½½
```

### 7.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ é…ç½®æ–‡ä»¶å±‚æ¬¡**ï¼š
```
global: å…¨å±€é»˜è®¤å‚æ•°
  â”œâ”€ scrape_interval: æ•°æ®é‡‡é›†é¢‘ç‡  
  â”œâ”€ evaluation_interval: è§„åˆ™æ£€æŸ¥é¢‘ç‡
  â””â”€ external_labels: å…¬å…±æ ‡ç­¾

scrape_configs: é‡‡é›†ç›®æ ‡é…ç½®
  â”œâ”€ job_name: ä»»åŠ¡æ ‡è¯†
  â”œâ”€ targets: ç›‘æ§ç›®æ ‡åˆ—è¡¨
  â””â”€ labels: è‡ªå®šä¹‰æ ‡ç­¾

rule_files: å‘Šè­¦è§„åˆ™æ–‡ä»¶
storage: å­˜å‚¨ç›¸å…³é…ç½®
```

**ğŸ”¹ æ€§èƒ½è°ƒä¼˜å…³é”®ç‚¹**ï¼š
```
å†…å­˜ä¼˜åŒ–ï¼š
- åˆç†è®¾ç½®æ•°æ®ä¿ç•™æœŸ
- æ§åˆ¶å¹¶å‘æŸ¥è¯¢æ•°é‡
- è°ƒæ•´æ ·æœ¬æ•°é™åˆ¶

å­˜å‚¨ä¼˜åŒ–ï¼š  
- é€‰æ‹©åˆé€‚çš„å­˜å‚¨ç¡¬ä»¶
- å®šæœŸæ¸…ç†å†å²æ•°æ®
- ç›‘æ§ç£ç›˜ä½¿ç”¨æƒ…å†µ

ç½‘ç»œä¼˜åŒ–ï¼š
- å¢åŠ æœ€å¤§è¿æ¥æ•°
- è°ƒæ•´è¶…æ—¶æ—¶é—´
- å¯ç”¨æ•°æ®å‹ç¼©
```

### 7.3 éƒ¨ç½²æ¨¡å¼é€‰æ‹©


| åœºæ™¯ç±»å‹ | **æ¨èæ–¹å¼** | **ä¼˜åŠ¿** | **é€‚ç”¨æƒ…å†µ** |
|---------|-------------|----------|-------------|
| ğŸ§ª **å­¦ä¹ æµ‹è¯•** | `Dockerå•å®¹å™¨` | `å¿«é€Ÿä¸Šæ‰‹ï¼Œå³ç”¨å³åˆ ` | `ä¸ªäººå­¦ä¹ ï¼ŒåŠŸèƒ½éªŒè¯` |
| ğŸ¢ **ç”Ÿäº§ç¯å¢ƒ** | `äºŒè¿›åˆ¶+systemd` | `æ€§èƒ½æœ€ä¼˜ï¼Œæ§åˆ¶ç²¾ç¡®` | `ä¼ä¸šçº§éƒ¨ç½²` |
| â˜ï¸ **äº‘åŸç”Ÿ** | `Docker Compose/K8s` | `å®¹å™¨ç¼–æ’ï¼Œè‡ªåŠ¨åŒ–` | `å¾®æœåŠ¡æ¶æ„` |
| ğŸ”§ **å¼€å‘ç¯å¢ƒ** | `DockeræŒ‚è½½é…ç½®` | `é…ç½®çµæ´»ï¼Œå¿«é€Ÿé‡å¯` | `å¼€å‘è°ƒè¯•` |

### 7.4 å¸¸è§é—®é¢˜ä¸è§£å†³


**â— é…ç½®é—®é¢˜**ï¼š
- **é…ç½®è¯­æ³•é”™è¯¯**ï¼šä½¿ç”¨`promtool check config`æ£€æŸ¥
- **ç›®æ ‡æ— æ³•è®¿é—®**ï¼šæ£€æŸ¥ç½‘ç»œè¿é€šæ€§å’Œç«¯å£å¼€æ”¾
- **æ•°æ®ä¸æ›´æ–°**ï¼šæ£€æŸ¥æŠ“å–é—´éš”å’Œç›®æ ‡æœåŠ¡çŠ¶æ€

**â— æ€§èƒ½é—®é¢˜**ï¼š  
- **å†…å­˜å ç”¨é«˜**ï¼šè°ƒæ•´æ•°æ®ä¿ç•™æœŸå’ŒæŸ¥è¯¢å¹¶å‘æ•°
- **ç£ç›˜ç©ºé—´ä¸è¶³**ï¼šè®¾ç½®å­˜å‚¨å¤§å°é™åˆ¶å’Œæ¸…ç†ç­–ç•¥
- **æŸ¥è¯¢ç¼“æ…¢**ï¼šä¼˜åŒ–æŸ¥è¯¢è¯­å¥å’Œå¢åŠ ç¡¬ä»¶é…ç½®

**â— æœåŠ¡é—®é¢˜**ï¼š
- **æœåŠ¡å¯åŠ¨å¤±è´¥**ï¼šæ£€æŸ¥ç”¨æˆ·æƒé™å’Œç«¯å£å ç”¨
- **é…ç½®é‡è½½å¤±è´¥**ï¼šç¡®è®¤å¯ç”¨`--web.enable-lifecycle`
- **æ•°æ®ä¸¢å¤±**ï¼šæ£€æŸ¥æ•°æ®ç›®å½•æƒé™å’Œç£ç›˜ç©ºé—´

### 7.5 æœ€ä½³å®è·µå»ºè®®


**ğŸ† éƒ¨ç½²å®è·µ**ï¼š
- âœ… ä½¿ç”¨ä¸“ç”¨ç”¨æˆ·è¿è¡ŒæœåŠ¡ï¼Œé¿å…rootæƒé™
- âœ… é…ç½®systemdè‡ªåŠ¨é‡å¯ï¼Œä¿è¯æœåŠ¡å¯ç”¨æ€§  
- âœ… å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶å’Œå…³é”®æ•°æ®
- âœ… ç›‘æ§Prometheusè‡ªèº«çš„è¿è¡ŒçŠ¶æ€

**ğŸ† é…ç½®å®è·µ**ï¼š
- âœ… é‡‡é›†é—´éš”æ ¹æ®ä¸šåŠ¡éœ€è¦è®¾ç½®ï¼Œé¿å…è¿‡é¢‘
- âœ… ä½¿ç”¨æ ‡ç­¾å¯¹ç›‘æ§ç›®æ ‡è¿›è¡Œåˆ†ç±»ç®¡ç†
- âœ… å®šæœŸæ¸…ç†ä¸å†éœ€è¦çš„ç›‘æ§ç›®æ ‡
- âœ… å»ºç«‹é…ç½®æ–‡ä»¶ç‰ˆæœ¬ç®¡ç†æœºåˆ¶

**æ ¸å¿ƒè®°å¿†**ï¼š
- Prometheusæ˜¯æ‹‰å–å¼ç›‘æ§ï¼Œä¸»åŠ¨æ”¶é›†æ•°æ®å­˜å‚¨æŸ¥è¯¢
- é…ç½®æ–‡ä»¶æ˜¯æ ¸å¿ƒï¼Œå®šä¹‰é‡‡é›†ç›®æ ‡å’Œå…¨å±€å‚æ•°  
- å®¹å™¨éƒ¨ç½²ç®€å•å¿«æ·ï¼ŒäºŒè¿›åˆ¶éƒ¨ç½²æ€§èƒ½æœ€ä¼˜
- å­˜å‚¨å®¹é‡éœ€è§„åˆ’ï¼Œæ•°æ®ä¿ç•™æœŸè¦åˆç†è®¾ç½®