---
title: 2ã€Prometheusæ¶æ„ä¸æ ¸å¿ƒæ¦‚å¿µ
---
## ğŸ“š ç›®å½•

1. [Prometheusæ—¶åºæ•°æ®åº“æ¶æ„](#1-Prometheusæ—¶åºæ•°æ®åº“æ¶æ„)
2. [æŒ‡æ ‡ç±»å‹è¯¦è§£](#2-æŒ‡æ ‡ç±»å‹è¯¦è§£)
3. [æ ‡ç­¾ä¸ç»´åº¦è®¾è®¡](#3-æ ‡ç­¾ä¸ç»´åº¦è®¾è®¡)
4. [PromQLæŸ¥è¯¢è¯­è¨€åŸºç¡€](#4-PromQLæŸ¥è¯¢è¯­è¨€åŸºç¡€)
5. [æœåŠ¡å‘ç°æœºåˆ¶](#5-æœåŠ¡å‘ç°æœºåˆ¶)
6. [æ•°æ®é‡‡é›†ä¸ä¿ç•™ç­–ç•¥](#6-æ•°æ®é‡‡é›†ä¸ä¿ç•™ç­–ç•¥)
7. [Prometheusè”é‚¦é›†ç¾¤](#7-Prometheusè”é‚¦é›†ç¾¤)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ Prometheusæ—¶åºæ•°æ®åº“æ¶æ„


### 1.1 ä»€ä¹ˆæ˜¯Prometheus


**æ ¸å¿ƒæ¦‚å¿µ**ï¼šPrometheusæ˜¯ä¸€ä¸ªå¼€æºçš„ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦å·¥å…·åŒ…ï¼Œä¸“é—¨è®¾è®¡ç”¨æ¥æ”¶é›†å’Œå­˜å‚¨**æ—¶åºæ•°æ®**ï¼ˆæŒ‰æ—¶é—´é¡ºåºè®°å½•çš„æ•°æ®ï¼‰ã€‚

```
ç®€å•ç†è§£ï¼š
æƒ³è±¡ä½ è¦ç›‘æ§æœåŠ¡å™¨çš„CPUä½¿ç”¨ç‡
- 10:00 â†’ CPU 30%
- 10:01 â†’ CPU 45% 
- 10:02 â†’ CPU 60%
è¿™äº›æŒ‰æ—¶é—´æ’åˆ—çš„æ•°æ®å°±æ˜¯æ—¶åºæ•°æ®
```

### 1.2 Prometheusæ•´ä½“æ¶æ„


**ğŸ”¸ ç³»ç»Ÿæ¶æ„å›¾**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç›‘æ§ç›®æ ‡       â”‚    â”‚   Prometheus     â”‚    â”‚   å¯è§†åŒ–ç•Œé¢     â”‚
â”‚  (Target)       â”‚    â”‚     Server       â”‚    â”‚  (Grafana)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Node Exporter â”‚â—„â”€â”€â”€ â”‚ â€¢ æ•°æ®æ”¶é›†       â”‚â”€â”€â”€â”€â–ºâ”‚ â€¢ å›¾è¡¨å±•ç¤º      â”‚
â”‚ â€¢ åº”ç”¨ç¨‹åº       â”‚    â”‚ â€¢ æ•°æ®å­˜å‚¨       â”‚    â”‚ â€¢ ä»ªè¡¨æ¿        â”‚
â”‚ â€¢ æ•°æ®åº“        â”‚    â”‚ â€¢ æŸ¥è¯¢å¼•æ“       â”‚    â”‚ â€¢ å‘Šè­¦å±•ç¤º      â”‚
â”‚ â€¢ æœåŠ¡å®ä¾‹      â”‚    â”‚ â€¢ å‘Šè­¦ç®¡ç†       â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚   å‘Šè­¦ç®¡ç†å™¨      â”‚
                      â”‚ (Alertmanager)   â”‚
                      â”‚ â€¢ é‚®ä»¶é€šçŸ¥       â”‚
                      â”‚ â€¢ çŸ­ä¿¡é€šçŸ¥       â”‚
                      â”‚ â€¢ é’‰é’‰é€šçŸ¥       â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 æ ¸å¿ƒç»„ä»¶è§£æ


**ğŸ”¹ Prometheus Server**
```
ä½œç”¨ï¼šç›‘æ§ç³»ç»Ÿçš„å¤§è„‘
ä¸»è¦åŠŸèƒ½ï¼š
â€¢ æ•°æ®æ”¶é›†ï¼šå®šæœŸä»ç›‘æ§ç›®æ ‡æ‹‰å–æ•°æ®
â€¢ æ•°æ®å­˜å‚¨ï¼šå°†æ”¶é›†çš„æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ç£ç›˜
â€¢ æŸ¥è¯¢æœåŠ¡ï¼šæä¾›PromQLæŸ¥è¯¢æ¥å£
â€¢ è§„åˆ™è¯„ä¼°ï¼šæ£€æŸ¥å‘Šè­¦è§„åˆ™å’Œè®°å½•è§„åˆ™
```

**ğŸ”¹ ç›‘æ§ç›®æ ‡ï¼ˆTargetï¼‰**
```
å®šä¹‰ï¼šè¢«ç›‘æ§çš„ç³»ç»Ÿæˆ–æœåŠ¡
å¸¸è§ç±»å‹ï¼š
â€¢ æœåŠ¡å™¨ï¼ˆé€šè¿‡Node Exporterï¼‰
â€¢ åº”ç”¨ç¨‹åºï¼ˆè‡ªå®šä¹‰metricsï¼‰
â€¢ æ•°æ®åº“ï¼ˆMySQL Exporterã€Redis Exporterç­‰ï¼‰
â€¢ ç½‘ç»œè®¾å¤‡ï¼ˆSNMP Exporterï¼‰

æ•°æ®æš´éœ²æ–¹å¼ï¼šHTTPæ¥å£ + ç‰¹å®šæ ¼å¼
```

**ğŸ”¹ Exporter**
```
ä½œç”¨ï¼šæ•°æ®é‡‡é›†å™¨ï¼Œå°†ç³»ç»ŸæŒ‡æ ‡è½¬æ¢ä¸ºPrometheusæ ¼å¼
å·¥ä½œåŸç†ï¼š
1. æ”¶é›†ç³»ç»Ÿä¿¡æ¯ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ç­‰ï¼‰
2. è½¬æ¢ä¸ºPrometheusæŒ‡æ ‡æ ¼å¼
3. é€šè¿‡HTTPæ¥å£æš´éœ²å‡ºæ¥
4. ç­‰å¾…Prometheusæ¥æ‹‰å–

å¸¸ç”¨Exporterï¼š
â€¢ Node Exporterï¼šæœåŠ¡å™¨ç¡¬ä»¶å’Œç³»ç»ŸæŒ‡æ ‡
â€¢ MySQL Exporterï¼šMySQLæ•°æ®åº“æŒ‡æ ‡
â€¢ Redis Exporterï¼šRedisç¼“å­˜æŒ‡æ ‡
```

### 1.4 å·¥ä½œæµç¨‹


**ğŸ“Š ç›‘æ§æ•°æ®æµè½¬è¿‡ç¨‹**
```
æ­¥éª¤1ï¼šç›®æ ‡å‘ç°
Prometheusé€šè¿‡é…ç½®æ–‡ä»¶æˆ–æœåŠ¡å‘ç°æœºåˆ¶æ‰¾åˆ°ç›‘æ§ç›®æ ‡

æ­¥éª¤2ï¼šæ•°æ®æ‹‰å–ï¼ˆPullæ¨¡å¼ï¼‰
Prometheusä¸»åŠ¨å‘ç›®æ ‡å‘é€HTTPè¯·æ±‚ï¼Œè·å–æŒ‡æ ‡æ•°æ®

æ­¥éª¤3ï¼šæ•°æ®è§£æä¸å­˜å‚¨
å°†æ¥æ”¶çš„æ•°æ®è§£æåå­˜å‚¨åˆ°æ—¶åºæ•°æ®åº“ä¸­

æ­¥éª¤4ï¼šè§„åˆ™è¯„ä¼°
å®šæœŸè¯„ä¼°å‘Šè­¦è§„åˆ™ï¼Œæ»¡è¶³æ¡ä»¶æ—¶è§¦å‘å‘Šè­¦

æ­¥éª¤5ï¼šæ•°æ®æŸ¥è¯¢
é€šè¿‡PromQLæä¾›æ•°æ®æŸ¥è¯¢æœåŠ¡

æ­¥éª¤6ï¼šå¯è§†åŒ–å±•ç¤º
Grafanaç­‰å·¥å…·æŸ¥è¯¢æ•°æ®å¹¶ç”Ÿæˆå›¾è¡¨
```

---

## 2. ğŸ“Š æŒ‡æ ‡ç±»å‹è¯¦è§£


### 2.1 æŒ‡æ ‡ç±»å‹æ¦‚è¿°


**ä¸ºä»€ä¹ˆéœ€è¦ä¸åŒç±»å‹çš„æŒ‡æ ‡ï¼Ÿ**
ä¸åŒçš„ä¸šåŠ¡åœºæ™¯éœ€è¦ä¸åŒçš„æ•°æ®ç»Ÿè®¡æ–¹å¼ï¼ŒPrometheusæä¾›äº†4ç§åŸºç¡€æŒ‡æ ‡ç±»å‹æ¥æ»¡è¶³å„ç§ç›‘æ§éœ€æ±‚ã€‚

### 2.2 Counterï¼ˆè®¡æ•°å™¨ï¼‰


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
å®šä¹‰ï¼šåªèƒ½é€’å¢çš„ç´¯è®¡æŒ‡æ ‡
ç‰¹ç‚¹ï¼š
â€¢ æ•°å€¼åªèƒ½å¢åŠ ï¼Œä¸èƒ½å‡å°‘
â€¢ é‡å¯åä¼šé‡ç½®ä¸º0
â€¢ é€‚åˆç»Ÿè®¡æ€»æ•°

ç”Ÿæ´»ä¾‹å­ï¼š
ç½‘ç«™è®¿é—®è®¡æ•°å™¨ã€æ±½è½¦é‡Œç¨‹è¡¨
```

**ğŸ’¡ ä½¿ç”¨åœºæ™¯ä¸ç¤ºä¾‹**
```yaml
# å…¸å‹åº”ç”¨åœºæ™¯
http_requests_total 156789     # HTTPè¯·æ±‚æ€»æ•°
disk_writes_total 45231        # ç£ç›˜å†™å…¥æ€»æ¬¡æ•°
error_count_total 89          # é”™è¯¯æ€»æ•°

# åœ¨åº”ç”¨ä¸­çš„ä½¿ç”¨
from prometheus_client import Counter
request_counter = Counter('http_requests_total', 'Total HTTP requests')

def handle_request():
    request_counter.inc()  # æ¯æ¬¡è¯·æ±‚é€’å¢1
    # å¤„ç†è¯·æ±‚...
```

**âš ï¸ é‡è¦ç‰¹æ€§**
- **é‡å¯é‡ç½®**ï¼šåº”ç”¨é‡å¯åè®¡æ•°å™¨å½’é›¶ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡
- **é€Ÿç‡è®¡ç®—**ï¼šé€šå¸¸å…³å¿ƒçš„æ˜¯å˜åŒ–é€Ÿç‡ï¼Œè€Œéç»å¯¹å€¼
- **æŸ¥è¯¢æ–¹å¼**ï¼š`rate(http_requests_total[5m])` è®¡ç®—5åˆ†é’Ÿå†…çš„å¹³å‡å¢é•¿ç‡

### 2.3 Gaugeï¼ˆä»ªè¡¨ç›˜ï¼‰


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
å®šä¹‰ï¼šå¯ä»¥ä»»æ„å¢å‡çš„ç¬æ—¶æ•°å€¼
ç‰¹ç‚¹ï¼š
â€¢ å¯ä»¥ä¸Šå‡æˆ–ä¸‹é™
â€¢ è¡¨ç¤ºæŸä¸ªæ—¶åˆ»çš„çŠ¶æ€å€¼
â€¢ é€‚åˆç»Ÿè®¡å½“å‰çŠ¶æ€

ç”Ÿæ´»ä¾‹å­ï¼š
æ¸©åº¦è®¡ã€æ±½è½¦é€Ÿåº¦è¡¨ã€æ°´ä½è®¡
```

**ğŸ’¡ ä½¿ç”¨åœºæ™¯ä¸ç¤ºä¾‹**
```yaml
# å…¸å‹åº”ç”¨åœºæ™¯
cpu_usage_percent 75.2         # CPUä½¿ç”¨ç‡
memory_available_bytes 2147483648  # å¯ç”¨å†…å­˜
active_connections 234         # å½“å‰æ´»è·ƒè¿æ¥æ•°
temperature_celsius 38.5       # å½“å‰æ¸©åº¦

# åœ¨åº”ç”¨ä¸­çš„ä½¿ç”¨
from prometheus_client import Gauge
cpu_gauge = Gauge('cpu_usage_percent', 'CPU usage percentage')

def update_cpu_usage():
    current_cpu = get_cpu_usage()  # è·å–å½“å‰CPUä½¿ç”¨ç‡
    cpu_gauge.set(current_cpu)     # è®¾ç½®å½“å‰å€¼
```

**ğŸ” å…³é”®ç†è§£**
- **å³æ—¶å¿«ç…§**ï¼šåæ˜ æŸä¸ªæ—¶é—´ç‚¹çš„ç¡®åˆ‡çŠ¶æ€
- **åŒå‘å˜åŒ–**ï¼šå¯ä»¥å¢åŠ ä¹Ÿå¯ä»¥å‡å°‘
- **ç›´æ¥ä½¿ç”¨**ï¼šé€šå¸¸ç›´æ¥ä½¿ç”¨å½“å‰å€¼ï¼Œä¸éœ€è¦è®¡ç®—å˜åŒ–ç‡

### 2.4 Histogramï¼ˆç›´æ–¹å›¾ï¼‰


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
å®šä¹‰ï¼šå¯¹è§‚å¯Ÿç»“æœè¿›è¡Œé‡‡æ ·ï¼Œå¹¶åœ¨å¯é…ç½®çš„æ¡¶ä¸­è®¡æ•°
ä½œç”¨ï¼šç»Ÿè®¡æ•°æ®çš„åˆ†å¸ƒæƒ…å†µ

ç®€å•ç†è§£ï¼š
æŠŠæ•°æ®æŒ‰å¤§å°åˆ†åˆ°ä¸åŒçš„"æ¡¶"é‡Œ
æ¯”å¦‚å“åº”æ—¶é—´ï¼š
â€¢ 0-10msçš„è¯·æ±‚ï¼š100ä¸ª
â€¢ 10-50msçš„è¯·æ±‚ï¼š500ä¸ª  
â€¢ 50-100msçš„è¯·æ±‚ï¼š200ä¸ª
```

**ğŸ’¡ æ•°æ®ç»“æ„**
```yaml
# Histogramä¼šè‡ªåŠ¨ç”Ÿæˆä¸‰ç§æŒ‡æ ‡
http_request_duration_seconds_bucket{le="0.01"} 100   # å°äºç­‰äº10msçš„è¯·æ±‚æ•°
http_request_duration_seconds_bucket{le="0.05"} 600   # å°äºç­‰äº50msçš„è¯·æ±‚æ•°
http_request_duration_seconds_bucket{le="0.1"} 800    # å°äºç­‰äº100msçš„è¯·æ±‚æ•°
http_request_duration_seconds_bucket{le="+Inf"} 1000  # æ‰€æœ‰è¯·æ±‚æ•°
http_request_duration_seconds_sum 45.67               # æ‰€æœ‰è¯·æ±‚æ—¶é—´æ€»å’Œ
http_request_duration_seconds_count 1000              # è¯·æ±‚æ€»æ•°
```

**ğŸ¯ åº”ç”¨ä»·å€¼**
```
ä¼˜åŠ¿ï¼š
â€¢ å¯ä»¥è®¡ç®—ç™¾åˆ†ä½æ•°ï¼ˆP95ã€P99ï¼‰
â€¢ äº†è§£æ•°æ®åˆ†å¸ƒæƒ…å†µ
â€¢ æœåŠ¡ç«¯èšåˆï¼ŒèŠ‚çœç½‘ç»œä¼ è¾“

é€‚ç”¨åœºæ™¯ï¼š
â€¢ è¯·æ±‚å“åº”æ—¶é—´
â€¢ è¯·æ±‚ä½“å¤§å°
â€¢ ä»»åŠ¡æ‰§è¡Œæ—¶é—´
```

### 2.5 Summaryï¼ˆæ‘˜è¦ï¼‰


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
å®šä¹‰ï¼šç±»ä¼¼Histogramï¼Œä½†åœ¨å®¢æˆ·ç«¯è®¡ç®—ç™¾åˆ†ä½æ•°
ç‰¹ç‚¹ï¼š
â€¢ ç›´æ¥æä¾›ç™¾åˆ†ä½æ•°
â€¢ å®¢æˆ·ç«¯è®¡ç®—ï¼Œå‡†ç¡®æ€§é«˜
â€¢ ç½‘ç»œä¼ è¾“é‡å¤§
```

**ğŸ’¡ æ•°æ®ç»“æ„**
```yaml
# Summaryè‡ªåŠ¨ç”Ÿæˆçš„æŒ‡æ ‡
http_request_duration_seconds{quantile="0.5"} 0.023   # ä¸­ä½æ•°(P50)
http_request_duration_seconds{quantile="0.9"} 0.076   # P90
http_request_duration_seconds{quantile="0.99"} 0.156  # P99
http_request_duration_seconds_sum 45.67               # æ€»å’Œ
http_request_duration_seconds_count 1000              # æ€»æ•°
```

**âš–ï¸ Histogram vs Summaryå¯¹æ¯”**

| ç‰¹æ€§ | **Histogram** | **Summary** |
|------|---------------|-------------|
| **è®¡ç®—ä½ç½®** | `æœåŠ¡ç«¯èšåˆ` | `å®¢æˆ·ç«¯è®¡ç®—` |
| **ç™¾åˆ†ä½æ•°** | `å¯ä»¥é‡æ–°è®¡ç®—` | `é¢„è®¾å›ºå®šå€¼` |
| **ç½‘ç»œå¼€é”€** | `è¾ƒå°` | `è¾ƒå¤§` |
| **å‡†ç¡®æ€§** | `è¿‘ä¼¼å€¼` | `ç²¾ç¡®å€¼` |
| **èšåˆèƒ½åŠ›** | `æ”¯æŒè·¨å®ä¾‹èšåˆ` | `ä¸æ”¯æŒèšåˆ` |
| **é€‚ç”¨åœºæ™¯** | `å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿ` | `å•å®ä¾‹ç²¾ç¡®ç»Ÿè®¡` |

---

## 3. ğŸ·ï¸ æ ‡ç­¾ä¸ç»´åº¦è®¾è®¡


### 3.1 æ ‡ç­¾ç³»ç»ŸåŸºç¡€


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ ‡ç­¾**
```
å®šä¹‰ï¼šé”®å€¼å¯¹å½¢å¼çš„å…ƒæ•°æ®ï¼Œç”¨äºåŒºåˆ†åŒä¸€æŒ‡æ ‡çš„ä¸åŒç»´åº¦

ä¸¾ä¾‹ç†è§£ï¼š
æŒ‡æ ‡åï¼šhttp_requests_total
æ ‡ç­¾ï¼š
â€¢ method="GET"    # è¯·æ±‚æ–¹æ³•
â€¢ status="200"    # å“åº”çŠ¶æ€ç 
â€¢ endpoint="/api" # è¯·æ±‚è·¯å¾„

å®Œæ•´æŒ‡æ ‡ï¼š
http_requests_total{method="GET",status="200",endpoint="/api"} 1234
```

### 3.2 æ ‡ç­¾è®¾è®¡åŸåˆ™


**ğŸ”¹ ç»´åº¦é€‰æ‹©åŸåˆ™**
```
âœ… å¥½çš„æ ‡ç­¾ç»´åº¦ï¼š
â€¢ åŸºæ•°å¯æ§ï¼šæ ‡ç­¾å€¼çš„ç»„åˆæ•°é‡é€‚ä¸­
â€¢ ä¸šåŠ¡ç›¸å…³ï¼šæœ‰å®é™…çš„æŸ¥è¯¢å’Œåˆ†æä»·å€¼
â€¢ ç›¸å¯¹ç¨³å®šï¼šæ ‡ç­¾å€¼ä¸ä¼šé¢‘ç¹å˜åŒ–

âŒ é¿å…çš„æ ‡ç­¾ç»´åº¦ï¼š
â€¢ é«˜åŸºæ•°ï¼šç”¨æˆ·IDã€ä¼šè¯IDç­‰å”¯ä¸€æ ‡è¯†
â€¢ æ— æ„ä¹‰ï¼šæ—¶é—´æˆ³ã€éšæœºæ•°
â€¢ è¿‡åº¦ç»†åˆ†ï¼šè¿‡å¤šçš„æ ‡ç­¾ç»„åˆ
```

**ğŸ“Š æ ‡ç­¾åŸºæ•°å½±å“**
```
ç¤ºä¾‹åˆ†æï¼š
æŒ‡æ ‡ï¼šhttp_requests_total
æ ‡ç­¾ç»´åº¦ï¼š
â€¢ method: 5ä¸ªå€¼ (GET, POST, PUT, DELETE, PATCH)
â€¢ status: 10ä¸ªå€¼ (200, 404, 500ç­‰)
â€¢ endpoint: 20ä¸ªå€¼ (ä¸åŒAPIè·¯å¾„)

æ€»ç»„åˆæ•°ï¼š5 Ã— 10 Ã— 20 = 1000ä¸ªæ—¶åº
å­˜å‚¨æ¶ˆè€—ï¼šæ¯ä¸ªæ—¶åºçº¦1KB/å¤© â†’ 1000KB/å¤©

å¦‚æœåŠ ä¸Šuser_idï¼ˆ100ä¸‡ç”¨æˆ·ï¼‰ï¼š
æ€»ç»„åˆæ•°ï¼š1000 Ã— 1,000,000 = 10äº¿ä¸ªæ—¶åº
å­˜å‚¨æ¶ˆè€—ï¼š1TB/å¤© (ä¸å¯æ¥å—!)
```

### 3.3 å¸¸è§æ ‡ç­¾æ¨¡å¼


**ğŸ”¹ åŸºç¡€æ ‡ç­¾æ¨¡å¼**
```yaml
# æœåŠ¡çº§åˆ«æ ‡ç­¾
job="web-server"           # æœåŠ¡åç§°
instance="192.168.1.10:8080"  # å®ä¾‹åœ°å€

# ä¸šåŠ¡çº§åˆ«æ ‡ç­¾  
service="user-service"     # ä¸šåŠ¡æœåŠ¡
version="v1.2.3"          # ç‰ˆæœ¬ä¿¡æ¯
environment="production"   # ç¯å¢ƒæ ‡è¯†

# æŠ€æœ¯çº§åˆ«æ ‡ç­¾
method="GET"              # HTTPæ–¹æ³•
status_code="200"         # çŠ¶æ€ç 
database="users"          # æ•°æ®åº“å
```

**ğŸ”¹ å±‚æ¬¡åŒ–æ ‡ç­¾è®¾è®¡**
```yaml
# åº”ç”¨å±‚ç›‘æ§
app_requests_total{
    service="order-service",
    version="v2.1.0",
    method="POST",
    endpoint="/orders",
    status="success"
} 156

# åŸºç¡€è®¾æ–½ç›‘æ§  
node_cpu_seconds_total{
    instance="web-01",
    cpu="0",
    mode="user"
} 12345.67
```

### 3.4 æ ‡ç­¾æŸ¥è¯¢æŠ€å·§


**ğŸ” æ ‡ç­¾é€‰æ‹©å™¨è¯­æ³•**
```promql
# ç²¾ç¡®åŒ¹é…
http_requests_total{method="GET"}

# æ­£åˆ™åŒ¹é…
http_requests_total{endpoint=~"/api/v[12]/.*"}

# åå‘åŒ¹é…
http_requests_total{status!="200"}

# å¤šæ¡ä»¶ç»„åˆ
http_requests_total{method="POST",status=~"2..",environment!="test"}
```

---

## 4. ğŸ” PromQLæŸ¥è¯¢è¯­è¨€åŸºç¡€


### 4.1 PromQLæ¦‚è¿°


**ğŸ”¸ ä»€ä¹ˆæ˜¯PromQL**
```
å®šä¹‰ï¼šPrometheus Query Languageï¼Œä¸“é—¨ç”¨äºæŸ¥è¯¢æ—¶åºæ•°æ®çš„å‡½æ•°å¼æŸ¥è¯¢è¯­è¨€
ç‰¹ç‚¹ï¼š
â€¢ è¡¨è¾¾å¼åŒ–ï¼šæ‰€æœ‰æŸ¥è¯¢éƒ½æ˜¯è¡¨è¾¾å¼
â€¢ å¼ºç±»å‹ï¼šæ˜ç¡®çš„æ•°æ®ç±»å‹ç³»ç»Ÿ
â€¢ å‡½æ•°ä¸°å¯Œï¼šå†…ç½®å¤§é‡èšåˆå’Œè½¬æ¢å‡½æ•°
```

### 4.2 åŸºç¡€æŸ¥è¯¢è¯­æ³•


**ğŸ”¹ å³æ—¶å‘é‡æŸ¥è¯¢**
```promql
# è·å–å½“å‰æ—¶åˆ»çš„æŒ‡æ ‡å€¼
cpu_usage_percent

# å¸¦æ ‡ç­¾è¿‡æ»¤
cpu_usage_percent{instance="web-01"}

# å¤šæ ‡ç­¾æ¡ä»¶
http_requests_total{method="GET",status="200"}
```

**ğŸ”¹ èŒƒå›´å‘é‡æŸ¥è¯¢**
```promql
# æŸ¥è¯¢è¿‡å»5åˆ†é’Ÿçš„æ•°æ®
cpu_usage_percent[5m]

# æŸ¥è¯¢è¿‡å»1å°æ—¶çš„æ•°æ®
http_requests_total[1h]
```

### 4.3 å¸¸ç”¨å‡½æ•°è¯¦è§£


**ğŸ“ˆ é€Ÿç‡è®¡ç®—å‡½æ•°**
```promql
# rate(): è®¡ç®—å¹³å‡å¢é•¿ç‡ï¼ˆé€‚ç”¨äºCounterï¼‰
rate(http_requests_total[5m])    # æ¯ç§’å¹³å‡è¯·æ±‚æ•°

# irate(): è®¡ç®—ç¬æ—¶å¢é•¿ç‡ï¼ˆåŸºäºæœ€åä¸¤ä¸ªç‚¹ï¼‰
irate(http_requests_total[5m])   # ç¬æ—¶æ¯ç§’è¯·æ±‚æ•°

# increase(): è®¡ç®—æ—¶é—´æ®µå†…çš„å¢é•¿é‡
increase(http_requests_total[1h]) # 1å°æ—¶å†…æ€»å¢é•¿é‡
```

**ğŸ“Š èšåˆå‡½æ•°**
```promql
# sum(): æ±‚å’Œ
sum(cpu_usage_percent)                    # æ‰€æœ‰å®ä¾‹CPUä½¿ç”¨ç‡æ€»å’Œ
sum by (instance) (cpu_usage_percent)     # æŒ‰å®ä¾‹åˆ†ç»„æ±‚å’Œ

# avg(): å¹³å‡å€¼  
avg(memory_usage_percent)                 # å¹³å‡å†…å­˜ä½¿ç”¨ç‡

# max()/min(): æœ€å¤§å€¼/æœ€å°å€¼
max(disk_usage_percent)                   # æœ€å¤§ç£ç›˜ä½¿ç”¨ç‡

# count(): è®¡æ•°
count(up == 1)                           # åœ¨çº¿å®ä¾‹æ•°é‡
```

**â° æ—¶é—´å‡½æ•°**
```promql
# æ—¶é—´åç§»
cpu_usage_percent offset 1h               # 1å°æ—¶å‰çš„CPUä½¿ç”¨ç‡

# æ—¶é—´èŒƒå›´
cpu_usage_percent[5m] offset 1h          # 1å°æ—¶å‰çš„5åˆ†é’Ÿæ•°æ®
```

### 4.4 å®é™…æŸ¥è¯¢ç¤ºä¾‹


**ğŸ¯ ä¸šåŠ¡ç›‘æ§æŸ¥è¯¢**
```promql
# 1. åº”ç”¨QPS (æ¯ç§’æŸ¥è¯¢æ•°)
sum(rate(http_requests_total[5m])) by (service)

# 2. é”™è¯¯ç‡
sum(rate(http_requests_total{status=~"5.."}[5m])) 
/ 
sum(rate(http_requests_total[5m])) * 100

# 3. å“åº”æ—¶é—´P95
histogram_quantile(0.95, 
  sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
)

# 4. æœåŠ¡å¯ç”¨æ€§
avg(up) by (job) * 100
```

**ğŸ”§ ç³»ç»Ÿç›‘æ§æŸ¥è¯¢**
```promql
# CPUä½¿ç”¨ç‡
100 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100

# å†…å­˜ä½¿ç”¨ç‡  
(1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100

# ç£ç›˜ä½¿ç”¨ç‡
100 - (node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100
```

---

## 5. ğŸ” æœåŠ¡å‘ç°æœºåˆ¶


### 5.1 æœåŠ¡å‘ç°æ¦‚è¿°


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡å‘ç°**
```
ä¼ ç»Ÿé—®é¢˜ï¼š
â€¢ é™æ€é…ç½®ï¼šæ‰‹åŠ¨ç»´æŠ¤ç›‘æ§ç›®æ ‡åˆ—è¡¨
â€¢ æ‰©å®¹å›°éš¾ï¼šæ–°å¢æœåŠ¡å™¨éœ€æ‰‹åŠ¨æ›´æ–°é…ç½®
â€¢ ç»´æŠ¤æˆæœ¬é«˜ï¼šå¤§è§„æ¨¡ç¯å¢ƒé…ç½®ç®¡ç†å¤æ‚

æœåŠ¡å‘ç°è§£å†³æ–¹æ¡ˆï¼š
â€¢ è‡ªåŠ¨å‘ç°ï¼šåŠ¨æ€å‘ç°ç›‘æ§ç›®æ ‡
â€¢ é…ç½®åŒæ­¥ï¼šä¸æœåŠ¡æ³¨å†Œä¸­å¿ƒåŒæ­¥
â€¢ å‡å°‘ç»´æŠ¤ï¼šæ— éœ€æ‰‹åŠ¨ç®¡ç†ç›‘æ§ç›®æ ‡
```

### 5.2 å†…ç½®æœåŠ¡å‘ç°ç±»å‹


**ğŸ”¹ é™æ€é…ç½® (static_configs)**
```yaml
# æœ€ç®€å•çš„é…ç½®æ–¹å¼ï¼Œé€‚åˆå°è§„æ¨¡ç¯å¢ƒ
scrape_configs:
  - job_name: 'web-servers'
    static_configs:
      - targets: ['192.168.1.10:9100', '192.168.1.11:9100']
        labels:
          group: 'production'
          datacenter: 'dc1'
```

**ğŸ”¹ æ–‡ä»¶å‘ç° (file_sd_configs)**
```yaml
# é€šè¿‡æ–‡ä»¶åŠ¨æ€åŠ è½½ç›®æ ‡
scrape_configs:
  - job_name: 'dynamic-nodes'
    file_sd_configs:
      - files: ['/etc/prometheus/targets/*.json']
        refresh_interval: 30s

# targets.json æ–‡ä»¶å†…å®¹ç¤ºä¾‹
[
  {
    "targets": ["192.168.1.10:9100", "192.168.1.11:9100"],
    "labels": {
      "job": "node-exporter",
      "env": "prod"
    }
  }
]
```

**ğŸ”¹ DNSå‘ç° (dns_sd_configs)**
```yaml
# é€šè¿‡DNS SRVè®°å½•å‘ç°æœåŠ¡
scrape_configs:
  - job_name: 'dns-discovery'
    dns_sd_configs:
      - names: ['_prometheus._tcp.example.com']
        type: 'SRV'
        port: 9100
```

### 5.3 äº‘å¹³å°æœåŠ¡å‘ç°


**â˜ï¸ ä¸»æµäº‘å¹³å°æ”¯æŒ**

| äº‘å¹³å° | **é…ç½®ç±»å‹** | **å‘ç°å¯¹è±¡** |
|--------|-------------|-------------|
| **AWS** | `ec2_sd_configs` | `EC2å®ä¾‹` |
| **é˜¿é‡Œäº‘** | `ecs_sd_configs` | `ECSå®ä¾‹` |
| **Azure** | `azure_sd_configs` | `è™šæ‹Ÿæœº` |
| **GCP** | `gce_sd_configs` | `GCEå®ä¾‹` |

**ğŸ”§ AWS EC2å‘ç°ç¤ºä¾‹**
```yaml
scrape_configs:
  - job_name: 'aws-nodes'
    ec2_sd_configs:
      - region: 'us-west-2'
        port: 9100
        filters:
          - name: 'tag:Environment'
            values: ['production']
          - name: 'instance-state-name'
            values: ['running']
    relabel_configs:
      - source_labels: [__meta_ec2_tag_Name]
        target_label: instance_name
```

### 5.4 å®¹å™¨ç¯å¢ƒæœåŠ¡å‘ç°


**ğŸ³ Kuberneteså‘ç°**
```yaml
# Podå‘ç°
scrape_configs:
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        target_label: __metrics_path__
        regex: (.+)
```

**ğŸ”„ Docker Swarmå‘ç°**
```yaml
scrape_configs:
  - job_name: 'dockerswarm'
    dockerswarm_sd_configs:
      - host: unix:///var/run/docker.sock
        role: tasks
        filters:
          - name: 'label'
            values: ['prometheus.enable=true']
```

### 5.5 æ ‡ç­¾é‡å†™æœºåˆ¶


**ğŸ·ï¸ Relabelingé…ç½®**
```yaml
# æ ‡ç­¾é‡å†™ç¤ºä¾‹
relabel_configs:
  # ä¿ç•™åŒ¹é…çš„ç›®æ ‡
  - source_labels: [__meta_ec2_tag_monitoring]
    action: keep
    regex: 'enabled'
    
  # é‡å‘½åæ ‡ç­¾
  - source_labels: [__meta_ec2_tag_Name]
    target_label: instance_name
    
  # ä¿®æ”¹æŠ“å–è·¯å¾„
  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
    target_label: __metrics_path__
    regex: (.+)
    
  # åˆ é™¤ä¸éœ€è¦çš„æ ‡ç­¾
  - regex: '__meta_kubernetes_pod_label_(.+)'
    action: labeldrop
```

---

## 6. âš™ï¸ æ•°æ®é‡‡é›†ä¸ä¿ç•™ç­–ç•¥


### 6.1 æ•°æ®é‡‡é›†é…ç½®


**ğŸ”¸ é‡‡é›†å‘¨æœŸè®¾ç½®**
```yaml
global:
  scrape_interval: 15s      # å…¨å±€é‡‡é›†é—´éš”
  evaluation_interval: 15s  # è§„åˆ™è¯„ä¼°é—´éš”

scrape_configs:
  - job_name: 'high-frequency'
    scrape_interval: 5s     # é«˜é¢‘é‡‡é›†ï¼ˆè¦†ç›–å…¨å±€è®¾ç½®ï¼‰
    static_configs:
      - targets: ['192.168.1.10:9100']
      
  - job_name: 'low-frequency' 
    scrape_interval: 60s    # ä½é¢‘é‡‡é›†
    static_configs:
      - targets: ['192.168.1.20:9100']
```

**âš–ï¸ é‡‡é›†é—´éš”é€‰æ‹©æŒ‡å¯¼**
```
é«˜é¢‘é‡‡é›†(5-10s)ï¼š
âœ… å…³é”®ä¸šåŠ¡æŒ‡æ ‡
âœ… å¿«é€Ÿå˜åŒ–çš„æŒ‡æ ‡
âŒ å­˜å‚¨å’Œç½‘ç»œå¼€é”€å¤§

ä¸­é¢‘é‡‡é›†(15-30s)ï¼š
âœ… å¸¸è§„ç³»ç»ŸæŒ‡æ ‡  
âœ… å¹³è¡¡æ€§èƒ½å’Œç²¾åº¦
âœ… æ¨èçš„é»˜è®¤è®¾ç½®

ä½é¢‘é‡‡é›†(60s+)ï¼š
âœ… ç¼“æ…¢å˜åŒ–çš„æŒ‡æ ‡
âœ… ä¸é‡è¦çš„è¾…åŠ©æŒ‡æ ‡
âœ… èŠ‚çœèµ„æº
```

### 6.2 æ•°æ®ä¿ç•™ç­–ç•¥


**ğŸ”¸ å­˜å‚¨é…ç½®**
```bash
# Prometheuså¯åŠ¨å‚æ•°
prometheus \
  --storage.tsdb.path=/data/prometheus \
  --storage.tsdb.retention.time=30d \     # ä¿ç•™30å¤©
  --storage.tsdb.retention.size=100GB \   # æœ€å¤§100GB
  --config.file=/etc/prometheus/prometheus.yml
```

**ğŸ“Š å­˜å‚¨ç©ºé—´è§„åˆ’**
```
å­˜å‚¨ç©ºé—´ä¼°ç®—å…¬å¼ï¼š
å­˜å‚¨å¤§å° = é‡‡æ ·æ•° Ã— ä¿ç•™å¤©æ•° Ã— æ¯æ ·æœ¬å­—èŠ‚æ•°

ç¤ºä¾‹è®¡ç®—ï¼š
â€¢ 1000ä¸ªæ—¶åº
â€¢ 15ç§’é‡‡é›†é—´éš” = 4æ¬¡/åˆ†é’Ÿ = 5760æ¬¡/å¤©  
â€¢ æ¯æ ·æœ¬çº¦12å­—èŠ‚
â€¢ ä¿ç•™30å¤©

å­˜å‚¨éœ€æ±‚ = 1000 Ã— 5760 Ã— 30 Ã— 12 å­—èŠ‚ â‰ˆ 2GB
```

**ğŸ”§ æ•°æ®å‹ç¼©ä¸æ¸…ç†**
```yaml
# åœ¨prometheus.ymlä¸­é…ç½®
global:
  external_labels:
    cluster: 'production'
    
# å­˜å‚¨ä¼˜åŒ–
storage:
  tsdb:
    min_block_duration: 2h     # æœ€å°å—æŒç»­æ—¶é—´
    max_block_duration: 36h    # æœ€å¤§å—æŒç»­æ—¶é—´
    retention: 30d             # æ•°æ®ä¿ç•™æœŸ
```

### 6.3 æ•°æ®é‡‡é›†æœ€ä½³å®è·µ


**ğŸ“‹ é‡‡é›†é…ç½®ä¼˜åŒ–**
```yaml
scrape_configs:
  - job_name: 'optimized-job'
    scrape_interval: 15s
    scrape_timeout: 10s       # è¶…æ—¶æ—¶é—´
    metrics_path: /metrics    # æŒ‡æ ‡è·¯å¾„
    honor_timestamps: true    # å°Šé‡ç›®æ ‡æ—¶é—´æˆ³
    
    static_configs:
      - targets: ['app:8080']
    
    # æŒ‡æ ‡è¿‡æ»¤
    metric_relabel_configs:
      # åªä¿ç•™éœ€è¦çš„æŒ‡æ ‡
      - source_labels: [__name__]
        regex: 'http_requests_total|cpu_usage_percent'
        action: keep
      
      # åˆ é™¤é«˜åŸºæ•°æ ‡ç­¾
      - regex: 'user_id'
        action: labeldrop
```

**âš ï¸ å¸¸è§é…ç½®é™·é˜±**
```
é¿å…çš„é…ç½®ï¼š
âŒ é‡‡é›†é—´éš”è¿‡çŸ­ï¼ˆ< 5sï¼‰å¢åŠ ç³»ç»Ÿè´Ÿæ‹…
âŒ è¶…æ—¶æ—¶é—´å¤§äºé‡‡é›†é—´éš”
âŒ ä¿ç•™è¿‡å¤šä¸éœ€è¦çš„æŒ‡æ ‡  
âŒ é«˜åŸºæ•°æ ‡ç­¾å¯¼è‡´å­˜å‚¨çˆ†ç‚¸

æ¨èé…ç½®ï¼š
âœ… åˆç†çš„é‡‡é›†é—´éš”ï¼ˆ15-30sï¼‰
âœ… è¶…æ—¶æ—¶é—´ä¸ºé‡‡é›†é—´éš”çš„70%
âœ… å®šæœŸæ¸…ç†æ— ç”¨æŒ‡æ ‡
âœ… æ§åˆ¶æ ‡ç­¾åŸºæ•°
```

---

## 7. ğŸŒ Prometheusè”é‚¦é›†ç¾¤


### 7.1 è”é‚¦é›†ç¾¤æ¦‚è¿°


**ğŸ”¸ ä»€ä¹ˆæ˜¯Prometheusè”é‚¦**
```
å®šä¹‰ï¼šå¤šä¸ªPrometheuså®ä¾‹ä¹‹é—´çš„å±‚æ¬¡åŒ–æ¶æ„
ç›®çš„ï¼šè§£å†³å•å®ä¾‹çš„æ‰©å±•æ€§é™åˆ¶

ç®€å•ç†è§£ï¼š
           å…¨å±€Prometheus
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       â”‚       â”‚
    åŒºåŸŸA   åŒºåŸŸB    åŒºåŸŸC
   Prometheus Prometheus Prometheus
      â”‚       â”‚         â”‚
   â”Œâ”€â”€â”¼â”€â”€â”  â”Œâ”€â”¼â”€â”    â”Œâ”€â”¼â”€â”
  App1 App2 App3 App4 App5 App6
```

### 7.2 è”é‚¦æ¶æ„æ¨¡å¼


**ğŸ”¹ å±‚æ¬¡åŒ–è”é‚¦**
```yaml
# ä¸Šçº§Prometheusé…ç½®
scrape_configs:
  - job_name: 'federation'
    scrape_interval: 30s
    honor_labels: true
    metrics_path: '/federate'
    params:
      'match[]':
        - '{job=~"mysql|redis"}'        # åªæ‹‰å–ç‰¹å®šjob
        - 'up'                          # æ‹‰å–upæŒ‡æ ‡
        - 'job:http_requests:rate5m'    # æ‹‰å–èšåˆæŒ‡æ ‡
    static_configs:
      - targets:
        - 'prometheus-dc1.example.org:9090'
        - 'prometheus-dc2.example.org:9090'
```

**ğŸ”¹ è·¨æœåŠ¡è”é‚¦**
```yaml
# ä¸“ç”¨Prometheusé…ç½®
# æ•°æ®åº“ç›‘æ§å®ä¾‹
scrape_configs:
  - job_name: 'mysql'
    static_configs:
      - targets: ['mysql-1:9104', 'mysql-2:9104']
      
  - job_name: 'redis'  
    static_configs:
      - targets: ['redis-1:9121', 'redis-2:9121']

---
# åº”ç”¨ç›‘æ§å®ä¾‹  
scrape_configs:
  - job_name: 'web-app'
    static_configs:
      - targets: ['app-1:8080', 'app-2:8080']
```

### 7.3 è”é‚¦é…ç½®å®è·µ


**ğŸ”§ æ•°æ®ç­›é€‰ç­–ç•¥**
```yaml
# é€‰æ‹©æ€§æ‹‰å–ï¼Œå‡å°‘æ•°æ®ä¼ è¾“
params:
  'match[]':
    # åªæ‹‰å–èšåˆåçš„æŒ‡æ ‡
    - 'job:cpu_usage:avg5m'
    - 'job:memory_usage:avg5m'
    
    # æ‹‰å–å…³é”®ä¸šåŠ¡æŒ‡æ ‡
    - '{__name__=~"http_requests_total|error_rate"}'
    
    # æ‹‰å–å®ä¾‹çŠ¶æ€
    - 'up{job=~"critical-.*"}'
```

**ğŸ“Š æ•°æ®æµè½¬æ¶æ„**
```
åŸå§‹æ•°æ®æµï¼š
ç›‘æ§ç›®æ ‡ â†’ åŒºåŸŸPrometheus â†’ å…¨å±€Prometheus â†’ Grafana

æ•°æ®å¤„ç†æµç¨‹ï¼š
1. åŒºåŸŸPrometheusæ”¶é›†è¯¦ç»†æŒ‡æ ‡
2. åŒºåŸŸPrometheusè®¡ç®—èšåˆæŒ‡æ ‡  
3. å…¨å±€Prometheusæ‹‰å–èšåˆç»“æœ
4. å…¨å±€Prometheusæä¾›ç»Ÿä¸€æŸ¥è¯¢
```

### 7.4 è”é‚¦é›†ç¾¤ä¼˜åŠ¿


**âœ… è§£å†³çš„é—®é¢˜**
```
æ‰©å±•æ€§ï¼š
â€¢ å•å®ä¾‹ç›‘æ§ç›®æ ‡æ•°é‡é™åˆ¶
â€¢ æ•°æ®å­˜å‚¨å®¹é‡é™åˆ¶  
â€¢ æŸ¥è¯¢æ€§èƒ½ç“¶é¢ˆ

ç®¡ç†æ€§ï¼š
â€¢ æŒ‰ä¸šåŠ¡æˆ–åŒºåŸŸåˆ’åˆ†ç›‘æ§èŒè´£
â€¢ å‡å°‘é…ç½®å¤æ‚åº¦
â€¢ æé«˜æ•…éšœéš”ç¦»èƒ½åŠ›

æ€§èƒ½ï¼š
â€¢ å‡å°‘ç½‘ç»œä¼ è¾“
â€¢ é™ä½å•å®ä¾‹è´Ÿè½½
â€¢ æé«˜æŸ¥è¯¢å“åº”é€Ÿåº¦
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
```
æ•°æ®ä¸€è‡´æ€§ï¼š
â€¢ è”é‚¦æ‹‰å–å¯èƒ½æœ‰å»¶è¿Ÿ
â€¢ æ—¶é—´æˆ³å¯èƒ½ä¸å®Œå…¨åŒæ­¥
â€¢ éœ€è¦è€ƒè™‘æ•°æ®é‡å¤é—®é¢˜

é…ç½®å¤æ‚æ€§ï¼š
â€¢ éœ€è¦ç»´æŠ¤å¤šä¸ªPrometheuså®ä¾‹
â€¢ æ ‡ç­¾å†²çªå¤„ç†
â€¢ ç½‘ç»œè¿é€šæ€§è¦æ±‚

æˆæœ¬è€ƒè™‘ï¼š
â€¢ å¢åŠ äº†åŸºç¡€è®¾æ–½å¤æ‚åº¦
â€¢ éœ€è¦æ›´å¤šè¿ç»´äººåŠ›
â€¢ é€‚åˆå¤§è§„æ¨¡ç¯å¢ƒä½¿ç”¨
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Prometheusæ¶æ„ï¼šPullæ¨¡å¼çš„æ—¶åºæ•°æ®åº“ç³»ç»Ÿ
ğŸ”¸ æŒ‡æ ‡ç±»å‹ï¼šCounteré€’å¢ã€Gaugeç¬æ—¶ã€Histogramåˆ†å¸ƒã€Summaryæ‘˜è¦
ğŸ”¸ æ ‡ç­¾è®¾è®¡ï¼šåˆç†çš„ç»´åº¦åˆ’åˆ†ï¼Œæ§åˆ¶æ ‡ç­¾åŸºæ•°
ğŸ”¸ PromQLåŸºç¡€ï¼šå³æ—¶å‘é‡ã€èŒƒå›´å‘é‡ã€èšåˆå‡½æ•°
ğŸ”¸ æœåŠ¡å‘ç°ï¼šåŠ¨æ€å‘ç°ç›‘æ§ç›®æ ‡ï¼Œå‡å°‘æ‰‹åŠ¨ç»´æŠ¤
ğŸ”¸ æ•°æ®ä¿ç•™ï¼šå¹³è¡¡å­˜å‚¨æˆæœ¬å’Œæ•°æ®éœ€æ±‚
ğŸ”¸ è”é‚¦é›†ç¾¤ï¼šå¤§è§„æ¨¡ç¯å¢ƒçš„æ‰©å±•è§£å†³æ–¹æ¡ˆ
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Pull vs Pushæ¨¡å¼**
```
Prometheusé‡‡ç”¨Pullæ¨¡å¼çš„ä¼˜åŠ¿ï¼š
â€¢ ç›‘æ§ç›®æ ‡æ›´ç®€å•ï¼Œåªéœ€æš´éœ²HTTPæ¥å£
â€¢ Prometheusæ§åˆ¶é‡‡é›†é¢‘ç‡ï¼Œé¿å…è¢«å‹å®
â€¢ æ›´å®¹æ˜“æ£€æµ‹ç›‘æ§ç›®æ ‡çŠ¶æ€ï¼ˆup/downï¼‰
â€¢ é…ç½®é›†ä¸­ç®¡ç†ï¼Œä¾¿äºç»´æŠ¤
```

**ğŸ”¹ æŒ‡æ ‡ç±»å‹é€‰æ‹©åŸåˆ™**
```
Counterï¼šç”¨äºå•è°ƒé€’å¢çš„è®¡æ•°ï¼ˆè¯·æ±‚æ•°ã€é”™è¯¯æ•°ï¼‰
Gaugeï¼šç”¨äºå¯å˜åŒ–çš„çŠ¶æ€å€¼ï¼ˆCPUã€å†…å­˜ã€æ¸©åº¦ï¼‰
Histogramï¼šç”¨äºåˆ†å¸ƒç»Ÿè®¡ï¼ˆå“åº”æ—¶é—´ã€è¯·æ±‚å¤§å°ï¼‰
Summaryï¼šç”¨äºç²¾ç¡®ç™¾åˆ†ä½æ•°ï¼ˆå®¢æˆ·ç«¯è®¡ç®—ï¼‰
```

**ğŸ”¹ æ ‡ç­¾è®¾è®¡æœ€ä½³å®è·µ**
```
åˆç†æ ‡ç­¾ï¼š
âœ… job, instance, method, status_code
âœ… service, version, environment
âœ… åŸºæ•°å¯æ§çš„ä¸šåŠ¡ç»´åº¦

é¿å…æ ‡ç­¾ï¼š
âŒ user_id, session_idç­‰é«˜åŸºæ•°æ ‡ç­¾
âŒ timestamp, request_idç­‰å”¯ä¸€æ ‡è¯†
âŒ æ— ä¸šåŠ¡æ„ä¹‰çš„éšæœºå€¼
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ç›‘æ§è§„åˆ’å»ºè®®**
```
å°è§„æ¨¡ç¯å¢ƒï¼ˆ< 100ä¸ªç›®æ ‡ï¼‰ï¼š
â€¢ å•ä¸€Prometheuså®ä¾‹
â€¢ é™æ€é…ç½®æˆ–æ–‡ä»¶å‘ç°
â€¢ æœ¬åœ°å­˜å‚¨ï¼Œä¿ç•™30å¤©

ä¸­ç­‰è§„æ¨¡ç¯å¢ƒï¼ˆ100-1000ä¸ªç›®æ ‡ï¼‰ï¼š
â€¢ æŒ‰æœåŠ¡åˆ’åˆ†Prometheuså®ä¾‹
â€¢ äº‘å¹³å°æœåŠ¡å‘ç°
â€¢ è€ƒè™‘è¿œç¨‹å­˜å‚¨

å¤§è§„æ¨¡ç¯å¢ƒï¼ˆ> 1000ä¸ªç›®æ ‡ï¼‰ï¼š
â€¢ è”é‚¦æ¶æ„
â€¢ å¤šç§æœåŠ¡å‘ç°æ–¹å¼
â€¢ è¿œç¨‹å­˜å‚¨å’ŒæŸ¥è¯¢ä¼˜åŒ–
```

**ğŸ”§ é…ç½®ä¼˜åŒ–è¦ç‚¹**
```
æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ åˆç†è®¾ç½®é‡‡é›†é—´éš”ï¼ˆ15-30sï¼‰
â€¢ æ§åˆ¶æŒ‡æ ‡æ•°é‡å’Œæ ‡ç­¾åŸºæ•°
â€¢ å®šæœŸæ¸…ç†æ— ç”¨æŒ‡æ ‡

å­˜å‚¨ä¼˜åŒ–ï¼š
â€¢ æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾ç½®ä¿ç•™æœŸ
â€¢ ä½¿ç”¨è¿œç¨‹å­˜å‚¨é•¿æœŸä¿å­˜
â€¢ ç›‘æ§ç£ç›˜ä½¿ç”¨æƒ…å†µ

æŸ¥è¯¢ä¼˜åŒ–ï¼š
â€¢ é¿å…é«˜åŸºæ•°æŸ¥è¯¢
â€¢ ä½¿ç”¨recording rulesé¢„è®¡ç®—
â€¢ åˆç†ä½¿ç”¨èšåˆå‡½æ•°
```

### 8.4 å¸¸è§é—®é¢˜è§£å†³


**â“ æ•°æ®é‡‡é›†é—®é¢˜**
```
targets downï¼š
â€¢ æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
â€¢ éªŒè¯ç«¯å£å’Œè·¯å¾„é…ç½®
â€¢ ç¡®è®¤ç›®æ ‡æœåŠ¡æ˜¯å¦æ­£å¸¸

æŒ‡æ ‡ç¼ºå¤±ï¼š
â€¢ æ£€æŸ¥metric_relabel_configs
â€¢ éªŒè¯æŒ‡æ ‡åç§°æ‹¼å†™
â€¢ ç¡®è®¤æ ‡ç­¾è¿‡æ»¤æ¡ä»¶

æ•°æ®ä¸å‡†ç¡®ï¼š
â€¢ æ£€æŸ¥æ—¶é—´åŒæ­¥
â€¢ éªŒè¯é‡‡é›†é—´éš”è®¾ç½®
â€¢ ç¡®è®¤æŒ‡æ ‡ç±»å‹ä½¿ç”¨æ­£ç¡®
```

**âš¡ æ€§èƒ½é—®é¢˜è§£å†³**
```
æŸ¥è¯¢ç¼“æ…¢ï¼š
â€¢ å‡å°‘æŸ¥è¯¢æ—¶é—´èŒƒå›´
â€¢ ä¼˜åŒ–PromQLè¡¨è¾¾å¼
â€¢ ä½¿ç”¨recording rules

å­˜å‚¨å¢é•¿è¿‡å¿«ï¼š
â€¢ æ£€æŸ¥é«˜åŸºæ•°æŒ‡æ ‡
â€¢ æ¸…ç†æ— ç”¨æ ‡ç­¾
â€¢ è°ƒæ•´ä¿ç•™ç­–ç•¥

å†…å­˜ä½¿ç”¨è¿‡é«˜ï¼š
â€¢ å‡å°‘å¹¶å‘æŸ¥è¯¢æ•°
â€¢ é™ä½é‡‡é›†é¢‘ç‡
â€¢ å¢åŠ å†…å­˜é…ç½®
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Prometheusæ˜¯æ‹‰å–å¼æ—¶åºæ•°æ®åº“ï¼Œä¸“æ³¨ç›‘æ§å’Œå‘Šè­¦
- å››ç§æŒ‡æ ‡ç±»å‹å„æœ‰ç”¨é€”ï¼Œé€‰æ‹©éœ€è¦åŒ¹é…ä¸šåŠ¡åœºæ™¯
- æ ‡ç­¾æ˜¯å¤šç»´åº¦åˆ†æçš„åŸºç¡€ï¼Œä½†è¦æ§åˆ¶åŸºæ•°é¿å…å­˜å‚¨çˆ†ç‚¸
- PromQLæ˜¯å¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€ï¼ŒæŒæ¡åŸºç¡€å‡½æ•°å¯è§£å†³å¤§éƒ¨åˆ†éœ€æ±‚
- æœåŠ¡å‘ç°è®©ç›‘æ§è‡ªåŠ¨åŒ–ï¼Œé€‚åˆåŠ¨æ€ç¯å¢ƒ
- è”é‚¦æ¶æ„è§£å†³å¤§è§„æ¨¡ç›‘æ§çš„æ‰©å±•æ€§é—®é¢˜