---
title: 10ã€æœåŠ¡å‘ç°é…ç½®ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [æœåŠ¡å‘ç°åŸºç¡€æ¦‚å¿µ](#1-æœåŠ¡å‘ç°åŸºç¡€æ¦‚å¿µ)
2. [é™æ€æœåŠ¡å‘ç°é…ç½®](#2-é™æ€æœåŠ¡å‘ç°é…ç½®)
3. [æ–‡ä»¶æœåŠ¡å‘ç°é…ç½®](#3-æ–‡ä»¶æœåŠ¡å‘ç°é…ç½®)
4. [DNSæœåŠ¡å‘ç°](#4-DNSæœåŠ¡å‘ç°)
5. [ConsulæœåŠ¡å‘ç°é›†æˆ](#5-ConsulæœåŠ¡å‘ç°é›†æˆ)
6. [KubernetesæœåŠ¡å‘ç°](#6-KubernetesæœåŠ¡å‘ç°)
7. [Dockerå®¹å™¨æœåŠ¡å‘ç°](#7-Dockerå®¹å™¨æœåŠ¡å‘ç°)
8. [è‡ªå®šä¹‰æœåŠ¡å‘ç°](#8-è‡ªå®šä¹‰æœåŠ¡å‘ç°)
9. [æœåŠ¡å‘ç°æ ‡ç­¾é‡å†™](#9-æœåŠ¡å‘ç°æ ‡ç­¾é‡å†™)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æœåŠ¡å‘ç°åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æœåŠ¡å‘ç°


**ç®€å•ç†è§£**ï¼šå°±åƒç”µè¯é»„é¡µä¸€æ ·ï¼Œå‘Šè¯‰Prometheuså“ªé‡Œèƒ½æ‰¾åˆ°éœ€è¦ç›‘æ§çš„æœåŠ¡ï¼

æƒ³è±¡ä½ æ˜¯ä¸€ä¸ªå¿«é€’å‘˜ï¼ˆPrometheusï¼‰ï¼Œéœ€è¦ç»™å¾ˆå¤šåœ°å€ï¼ˆç›‘æ§ç›®æ ‡ï¼‰é€åŒ…è£¹ï¼ˆæ”¶é›†æŒ‡æ ‡ï¼‰ã€‚ä¼ ç»Ÿæ–¹å¼æ˜¯æ‹¿ç€ä¸€å¼ å›ºå®šçš„åœ°å€æ¸…å•ï¼Œä½†ç°åœ¨çš„ä¸–ç•Œå˜åŒ–å¤ªå¿«äº†ï¼š

```
ä¼ ç»Ÿç›‘æ§çš„é—®é¢˜ï¼š
ğŸ  æœåŠ¡å™¨åœ°å€ç»å¸¸å˜åŒ–
ğŸ”„ æ–°æœåŠ¡ä¸æ–­ä¸Šçº¿å’Œä¸‹çº¿  
ğŸ“± å®¹å™¨åŒ–åº”ç”¨åŠ¨æ€è°ƒåº¦
ğŸŒ å¾®æœåŠ¡æ¶æ„æœåŠ¡ä¼—å¤š

æœåŠ¡å‘ç°è§£å†³æ–¹æ¡ˆï¼š
âœ… è‡ªåŠ¨å‘ç°æ–°æœåŠ¡
âœ… å®æ—¶æ›´æ–°ç›®æ ‡åˆ—è¡¨
âœ… åŠ¨æ€è°ƒæ•´ç›‘æ§é…ç½®
âœ… å‡å°‘æ‰‹åŠ¨ç»´æŠ¤å·¥ä½œ
```

### 1.2 PrometheusæœåŠ¡å‘ç°æœºåˆ¶


**ğŸ” å·¥ä½œåŸç†å›¾ç¤º**ï¼š
```
æœåŠ¡å‘ç°æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æœåŠ¡æ³¨å†Œ   â”‚â”€â”€â”€â–¶â”‚  æœåŠ¡å‘ç°æº   â”‚â”€â”€â”€â–¶â”‚ Prometheus  â”‚
â”‚  (åº”ç”¨å¯åŠ¨)  â”‚    â”‚(Consul/K8s)  â”‚    â”‚ (æ‹‰å–æŒ‡æ ‡)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘                   â†‘                   â†“
   è‡ªåŠ¨æ³¨å†Œ            å®æ—¶æŸ¥è¯¢            åŠ¨æ€æ›´æ–°
```

**ğŸ“Š æœåŠ¡å‘ç°ç±»å‹å¯¹æ¯”**ï¼š

| å‘ç°æ–¹å¼ | **é€‚ç”¨åœºæ™¯** | **å¤æ‚åº¦** | **å®æ—¶æ€§** | **ç»´æŠ¤æˆæœ¬** |
|---------|------------|----------|----------|------------|
| **é™æ€é…ç½®** | `å°è§„æ¨¡å›ºå®šç¯å¢ƒ` | `â­` | `âŒ` | `â­` |
| **æ–‡ä»¶å‘ç°** | `ä¸­ç­‰è§„æ¨¡ç¯å¢ƒ` | `â­â­` | `â­` | `â­â­` |
| **DNSå‘ç°** | `ä¼ ç»ŸåŸºç¡€æ¶æ„` | `â­â­` | `â­â­` | `â­â­` |
| **Consulå‘ç°** | `å¾®æœåŠ¡æ¶æ„` | `â­â­â­` | `â­â­â­â­` | `â­â­â­` |
| **K8så‘ç°** | `å®¹å™¨åŒ–ç¯å¢ƒ` | `â­â­â­â­` | `â­â­â­â­â­` | `â­â­â­â­` |

---

## 2. ğŸ“‹ é™æ€æœåŠ¡å‘ç°é…ç½®


### 2.1 åŸºæœ¬é™æ€é…ç½®


é™æ€é…ç½®å°±åƒæ‰‹å†™é€šè®¯å½•ï¼ŒæŠŠæ‰€æœ‰è¦ç›‘æ§çš„åœ°å€å†™æ­»åœ¨é…ç½®æ–‡ä»¶é‡Œã€‚è™½ç„¶ç®€å•ç²—æš´ï¼Œä½†å¯¹äºå°è§„æ¨¡ç¨³å®šç¯å¢ƒå¾ˆå®ç”¨ã€‚

**ğŸ“ åŸºç¡€é™æ€é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'
          env: 'production'

  - job_name: 'node-exporter'
    static_configs:
      - targets: 
          - '192.168.1.10:9100'
          - '192.168.1.11:9100' 
          - '192.168.1.12:9100'
        labels:
          service: 'node'
          datacenter: 'dc1'
```

### 2.2 åˆ†ç»„é™æ€é…ç½®


**ğŸ¢ æŒ‰ç¯å¢ƒå’ŒæœåŠ¡åˆ†ç»„**ï¼š
```yaml
scrape_configs:
  # ç”Ÿäº§ç¯å¢ƒWebæœåŠ¡å™¨
  - job_name: 'web-prod'
    scrape_interval: 10s
    static_configs:
      - targets:
          - 'web-prod-01:8080'
          - 'web-prod-02:8080'
        labels:
          env: 'production'
          service: 'webapp'
          team: 'frontend'

  # æµ‹è¯•ç¯å¢ƒæ•°æ®åº“
  - job_name: 'mysql-test'
    scrape_interval: 30s
    static_configs:
      - targets:
          - 'mysql-test-01:9104'
        labels:
          env: 'testing'
          service: 'mysql'
          team: 'backend'

  # å¼€å‘ç¯å¢ƒRedis
  - job_name: 'redis-dev'
    static_configs:
      - targets:
          - 'redis-dev:9121'
        labels:
          env: 'development'
          service: 'redis'
```

### 2.3 é™æ€é…ç½®æœ€ä½³å®è·µ


**âœ… é™æ€é…ç½®ä¼˜åŒ–ç­–ç•¥**ï¼š
```yaml
# ä½¿ç”¨æœ‰æ„ä¹‰çš„jobåç§°å’Œæ ‡ç­¾
scrape_configs:
  - job_name: 'backend-api-production'
    static_configs:
      - targets: ['api-01:8080', 'api-02:8080']
        labels:
          component: 'api-server'
          version: 'v2.1.0'
          region: 'us-west-2'
          # é¿å…åœ¨è¿™é‡Œè®¾ç½®instanceæ ‡ç­¾ï¼Œä¼šè¢«è‡ªåŠ¨è¦†ç›–
    
    # è®¾ç½®åˆç†çš„æŠ“å–å‚æ•°
    scrape_interval: 15s
    scrape_timeout: 10s
    metrics_path: '/metrics'
    
    # æ·»åŠ è‡ªå®šä¹‰HTTPå¤´
    params:
      format: ['prometheus']
```

**ğŸ’¡ é™æ€é…ç½®ä½¿ç”¨å»ºè®®**ï¼š
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… æœåŠ¡å™¨æ•°é‡å°‘ä¸”å›ºå®š
âœ… ç½‘ç»œç¯å¢ƒç¨³å®š
âœ… å¿«é€ŸåŸå‹éªŒè¯
âœ… å­¦ä¹ å’Œæµ‹è¯•ç¯å¢ƒ

ä¸é€‚ç”¨åœºæ™¯ï¼š
âŒ é¢‘ç¹å˜æ›´çš„ç¯å¢ƒ
âŒ å®¹å™¨åŒ–åŠ¨æ€éƒ¨ç½²
âŒ å¤§è§„æ¨¡æœåŠ¡é›†ç¾¤
âŒ è‡ªåŠ¨åŒ–è¿ç»´è¦æ±‚é«˜
```

---

## 3. ğŸ“ æ–‡ä»¶æœåŠ¡å‘ç°é…ç½®


### 3.1 æ–‡ä»¶å‘ç°åŸºæœ¬åŸç†


æ–‡ä»¶å‘ç°å°±åƒä¸€ä¸ª"æ™ºèƒ½é€šè®¯å½•"ï¼ŒPrometheusä¼šå®šæœŸæ£€æŸ¥æŒ‡å®šçš„æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å†…å®¹å˜äº†ï¼Œå°±è‡ªåŠ¨æ›´æ–°ç›‘æ§ç›®æ ‡ã€‚

**ğŸ”„ å·¥ä½œæµç¨‹**ï¼š
```
æ–‡ä»¶å‘ç°æµç¨‹ï¼š
é…ç½®æ–‡ä»¶æŒ‡å®šç›®å½• â†’ Prometheuså®šæœŸæ‰«æ â†’ å‘ç°æ–‡ä»¶å˜æ›´ â†’ é‡æ–°åŠ è½½ç›®æ ‡
     â†“                   â†“               â†“            â†“
  targets.json      æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡      æ–‡ä»¶æ—¶é—´æˆ³     çƒ­é‡è½½é…ç½®
```

### 3.2 åŸºç¡€æ–‡ä»¶å‘ç°é…ç½®


**ğŸ“ ä¸»é…ç½®æ–‡ä»¶è®¾ç½®**ï¼š
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'file-discovery-nodes'
    file_sd_configs:
      - files:
          - '/etc/prometheus/targets/*.json'
          - '/etc/prometheus/targets/*.yml'
        refresh_interval: 10s
    
    # è¦†ç›–ä»æ–‡ä»¶ä¸­è¯»å–çš„é…ç½®
    scrape_interval: 15s
    metrics_path: '/metrics'
```

**ğŸ“‹ ç›®æ ‡æ–‡ä»¶æ ¼å¼ï¼ˆJSONï¼‰**ï¼š
```json
[
  {
    "targets": [
      "192.168.1.10:9100",
      "192.168.1.11:9100"
    ],
    "labels": {
      "env": "production",
      "service": "web",
      "region": "us-west"
    }
  },
  {
    "targets": [
      "192.168.1.20:9100",
      "192.168.1.21:9100"
    ],
    "labels": {
      "env": "production", 
      "service": "database",
      "region": "us-east"
    }
  }
]
```

### 3.3 YAMLæ ¼å¼ç›®æ ‡æ–‡ä»¶


**ğŸ“„ YAMLæ ¼å¼ç¤ºä¾‹**ï¼š
```yaml
# /etc/prometheus/targets/web-servers.yml
- targets:
    - 'web-01.example.com:8080'
    - 'web-02.example.com:8080'
    - 'web-03.example.com:8080'
  labels:
    job: 'webapp'
    env: 'production'
    team: 'frontend'
    version: '2.1.0'

- targets:
    - 'api-01.example.com:3000'
    - 'api-02.example.com:3000'
  labels:
    job: 'api-server'
    env: 'production'
    team: 'backend'
```

### 3.4 åŠ¨æ€æ–‡ä»¶ç”Ÿæˆå®è·µ


**ğŸ”§ è‡ªåŠ¨åŒ–è„šæœ¬ç”Ÿæˆç›®æ ‡æ–‡ä»¶**ï¼š
```bash
#!/bin/bash
# generate-targets.sh - åŠ¨æ€ç”Ÿæˆç›‘æ§ç›®æ ‡æ–‡ä»¶

TARGET_DIR="/etc/prometheus/targets"
TEMP_FILE="${TARGET_DIR}/.targets.tmp"

# ç¡®ä¿ç›®å½•å­˜åœ¨
mkdir -p "${TARGET_DIR}"

# å¼€å§‹ç”ŸæˆJSONæ–‡ä»¶
cat > "${TEMP_FILE}" << 'EOF'
[
EOF

# ä»æœåŠ¡æ³¨å†Œä¸­å¿ƒæˆ–CMDBè·å–æœåŠ¡å™¨åˆ—è¡¨
# è¿™é‡Œç”¨ç®€å•ç¤ºä¾‹ï¼šæ‰«æç½‘æ®µä¸­çš„æ´»è·ƒä¸»æœº
for ip in $(nmap -sn 192.168.1.0/24 | grep "Nmap scan" | awk '{print $5}' | grep -E '^192\.168\.1\.[0-9]+$'); do
    # æ£€æŸ¥9100ç«¯å£æ˜¯å¦å¼€æ”¾ï¼ˆnode_exporterï¼‰
    if nc -z "$ip" 9100 2>/dev/null; then
        # è·å–ä¸»æœºå
        hostname=$(nslookup "$ip" | grep "name =" | cut -d= -f2 | xargs)
        [[ -z "$hostname" ]] && hostname="unknown"
        
        # æ·»åŠ åˆ°ç›®æ ‡æ–‡ä»¶
        cat >> "${TEMP_FILE}" << EOF
  {
    "targets": ["${ip}:9100"],
    "labels": {
      "service": "node-exporter",
      "hostname": "${hostname}",
      "network": "192.168.1.0/24",
      "discovered_by": "auto-scan",
      "scan_time": "$(date -Iseconds)"
    }
  },
EOF
    fi
done

# ç§»é™¤æœ€åçš„é€—å·å¹¶å…³é—­JSON
sed -i '$ s/,$//' "${TEMP_FILE}"
echo ']' >> "${TEMP_FILE}"

# åŸå­æ€§æ›¿æ¢ç›®æ ‡æ–‡ä»¶
mv "${TEMP_FILE}" "${TARGET_DIR}/auto-discovered.json"

echo "Generated target file with $(jq length ${TARGET_DIR}/auto-discovered.json) targets"
```

**â° å®šæ—¶ä»»åŠ¡é…ç½®**ï¼š
```bash
# æ·»åŠ åˆ°crontabï¼Œæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
# crontab -e
* * * * * /usr/local/bin/generate-targets.sh >> /var/log/prometheus-discovery.log 2>&1
```

### 3.5 æ–‡ä»¶å‘ç°é«˜çº§ç‰¹æ€§


**ğŸ¨ é«˜çº§é…ç½®é€‰é¡¹**ï¼š
```yaml
scrape_configs:
  - job_name: 'advanced-file-discovery'
    file_sd_configs:
      - files:
          - '/etc/prometheus/targets/prod-*.json'
          - '/etc/prometheus/targets/staging-*.yml'
        refresh_interval: 5s    # å¿«é€Ÿåˆ·æ–°é—´éš”
    
    # é…ç½®é‡å†™å’Œè¿‡æ»¤
    relabel_configs:
      # åªç›‘æ§æ ‡è®°ä¸ºenabledçš„ç›®æ ‡
      - source_labels: [__meta_filepath]
        regex: '.*/prod-.*'
        target_label: environment
        replacement: production
      
      # æ ¹æ®æ–‡ä»¶è·¯å¾„è®¾ç½®ç¯å¢ƒæ ‡ç­¾
      - source_labels: [__meta_filepath] 
        regex: '.*/staging-.*'
        target_label: environment
        replacement: staging
    
    # æŒ‡æ ‡è·¯å¾„å¯ä»¥ä»æ ‡ç­¾ä¸­åŠ¨æ€è·å–
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: 'test_.*'
        action: drop    # ä¸¢å¼ƒæµ‹è¯•æŒ‡æ ‡
```

---

## 4. ğŸŒ DNSæœåŠ¡å‘ç°


### 4.1 DNSå‘ç°åŸç†


DNSæœåŠ¡å‘ç°å°±åƒé€šè¿‡ç”µè¯ç°¿æŸ¥å·ç ï¼ŒPrometheusä¼šå®šæœŸæŸ¥è¯¢DNSè®°å½•æ¥è·å–ç›‘æ§ç›®æ ‡çš„IPåœ°å€ã€‚

**ğŸ“ DNSæŸ¥è¯¢ç±»å‹**ï¼š
```
DNSè®°å½•ç±»å‹ï¼š
Aè®°å½•ï¼šåŸŸåâ†’IPåœ°å€æ˜ å°„
SRVè®°å½•ï¼šæœåŠ¡â†’ç«¯å£+IPæ˜ å°„  
TXTè®°å½•ï¼šå­˜å‚¨é¢å¤–çš„æœåŠ¡ä¿¡æ¯

DNSå‘ç°ä¼˜åŠ¿ï¼š
âœ… åŸºäºæˆç†Ÿçš„DNSåŸºç¡€è®¾æ–½
âœ… è‡ªåŠ¨æ›´æ–°IPåœ°å€å˜æ›´
âœ… æ”¯æŒè´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»
âœ… æ— éœ€é¢å¤–çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒ
```

### 4.2 Aè®°å½•æœåŠ¡å‘ç°


**ğŸ”¤ åŸºäºAè®°å½•çš„å‘ç°**ï¼š
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'dns-a-records'
    dns_sd_configs:
      - names:
          - 'web-servers.internal.com'
          - 'api-servers.internal.com'
        type: A                    # æŸ¥è¯¢Aè®°å½•
        port: 9100                # é»˜è®¤ç«¯å£
        refresh_interval: 30s     # DNSæŸ¥è¯¢é—´éš”
    
    relabel_configs:
      # ä»DNSåç§°ä¸­æå–æœåŠ¡ç±»å‹
      - source_labels: [__meta_dns_name]
        regex: '([^.]+)\..*'
        target_label: service_type
        replacement: '${1}'
```

**ğŸ—ï¸ DNSè®°å½•é…ç½®ç¤ºä¾‹**ï¼š
```bash
# åœ¨DNSæœåŠ¡å™¨ä¸­é…ç½®Aè®°å½•
web-servers.internal.com.    IN  A  192.168.1.10
web-servers.internal.com.    IN  A  192.168.1.11  
web-servers.internal.com.    IN  A  192.168.1.12

api-servers.internal.com.    IN  A  192.168.1.20
api-servers.internal.com.    IN  A  192.168.1.21
```

### 4.3 SRVè®°å½•æœåŠ¡å‘ç°


SRVè®°å½•æ˜¯ä¸“é—¨ä¸ºæœåŠ¡å‘ç°è®¾è®¡çš„ï¼ŒåŒ…å«äº†æœåŠ¡çš„ç«¯å£å’Œä¼˜å…ˆçº§ä¿¡æ¯ï¼š

**âš¡ SRVè®°å½•å‘ç°é…ç½®**ï¼š
```yaml
scrape_configs:
  - job_name: 'dns-srv-records'
    dns_sd_configs:
      - names:
          - '_prometheus._tcp.monitoring.internal.com'
          - '_node-exporter._tcp.infrastructure.internal.com'
        type: SRV
        refresh_interval: 15s
    
    relabel_configs:
      # SRVè®°å½•åŒ…å«ç«¯å£ä¿¡æ¯ï¼Œæ— éœ€æ‰‹åŠ¨æŒ‡å®š
      - source_labels: [__meta_dns_srv_record_target]
        target_label: __address__
      
      # ä»SRVè®°å½•åç§°è§£ææœåŠ¡ä¿¡æ¯
      - source_labels: [__meta_dns_name]
        regex: '_([^.]+)\._tcp\.(.+)'
        target_label: service
        replacement: '${1}'
      
      - source_labels: [__meta_dns_name]
        regex: '_[^.]+\._tcp\.(.+)'
        target_label: domain
        replacement: '${1}'
```

**ğŸ“‹ SRVè®°å½•æ ¼å¼**ï¼š
```bash
# SRVè®°å½•æ ¼å¼ï¼š_service._protocol.domain TTL class SRV priority weight port target
_prometheus._tcp.monitoring.internal.com. 300 IN SRV 10 5 9090 prom-01.internal.com.
_prometheus._tcp.monitoring.internal.com. 300 IN SRV 10 5 9090 prom-02.internal.com.

_node-exporter._tcp.infrastructure.internal.com. 300 IN SRV 10 10 9100 node-01.internal.com.
_node-exporter._tcp.infrastructure.internal.com. 300 IN SRV 10 10 9100 node-02.internal.com.
```

### 4.4 DNSå‘ç°å®é™…åº”ç”¨


**ğŸ¯ å®é™…éƒ¨ç½²ç¤ºä¾‹**ï¼š
```yaml
# é€‚åˆä¼ ç»ŸåŸºç¡€è®¾æ–½çš„DNSå‘ç°é…ç½®
scrape_configs:
  - job_name: 'infrastructure-monitoring'
    dns_sd_configs:
      - names:
          - 'nodes.prod.internal'      # æ‰€æœ‰ç”Ÿäº§èŠ‚ç‚¹
          - 'databases.prod.internal'  # æ•°æ®åº“æœåŠ¡å™¨
          - 'loadbalancers.prod.internal' # è´Ÿè½½å‡è¡¡å™¨
        type: A
        port: 9100
        refresh_interval: 60s
    
    relabel_configs:
      # æ ¹æ®DNSåŸŸåè®¾ç½®ç¯å¢ƒæ ‡ç­¾
      - source_labels: [__meta_dns_name]
        regex: '.*\.prod\..*'
        target_label: environment
        replacement: production
      
      - source_labels: [__meta_dns_name]
        regex: '.*\.staging\..*'
        target_label: environment  
        replacement: staging
        
      # æ ¹æ®å­åŸŸåè®¾ç½®æœåŠ¡ç±»å‹
      - source_labels: [__meta_dns_name]
        regex: '([^.]+)\..*'
        target_label: service_group
        replacement: '${1}'
```

**ğŸ’¡ DNSå‘ç°æœ€ä½³å®è·µ**ï¼š
```
è®¾è®¡åŸåˆ™ï¼š
â€¢ ä½¿ç”¨æœ‰æ„ä¹‰çš„DNSåç§°è§„èŒƒ
â€¢ è®¾ç½®åˆç†çš„TTLå€¼ï¼ˆä¸è¦å¤ªçŸ­ï¼‰
â€¢ è€ƒè™‘DNSç¼“å­˜å¯¹å‘ç°å»¶è¿Ÿçš„å½±å“
â€¢ ä¸ºä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„åŸŸå

æ³¨æ„äº‹é¡¹ï¼š
âš ï¸ DNSæŸ¥è¯¢ä¼šå¢åŠ ç½‘ç»œå¼€é”€
âš ï¸ DNSç¼“å­˜å¯èƒ½å¯¼è‡´å‘ç°å»¶è¿Ÿ
âš ï¸ éœ€è¦ç»´æŠ¤DNSè®°å½•çš„ä¸€è‡´æ€§
âš ï¸ ä¸é€‚åˆé«˜é¢‘å˜æ›´çš„ç¯å¢ƒ
```

---

## 5. ğŸª ConsulæœåŠ¡å‘ç°é›†æˆ


### 5.1 ConsulæœåŠ¡å‘ç°æ¦‚è¿°


Consulå°±åƒä¸€ä¸ª"æ™ºèƒ½æœåŠ¡ç›®å½•"ï¼Œåº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œï¼ŒPrometheuså®šæœŸæŸ¥è¯¢è·å–æœ€æ–°çš„æœåŠ¡åˆ—è¡¨ã€‚

**ğŸ¢ Consulæ¶æ„å›¾**ï¼š
```
ConsulæœåŠ¡å‘ç°æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨æœåŠ¡    â”‚â”€â”€â”€â–¶â”‚   Consul     â”‚â—€â”€â”€â”€â”‚ Prometheus  â”‚
â”‚(è‡ªåŠ¨æ³¨å†Œ)    â”‚    â”‚  (æœåŠ¡ç›®å½•)   â”‚    â”‚ (æŸ¥è¯¢å‘ç°)  â”‚  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†‘
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  å¥åº·æ£€æŸ¥     â”‚
                    â”‚ (è‡ªåŠ¨å‰”é™¤)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ConsulæœåŠ¡å‘ç°é…ç½®


**âš™ï¸ åŸºç¡€Consulå‘ç°é…ç½®**ï¼š
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'consul-discovery'
    consul_sd_configs:
      - server: 'consul.internal.com:8500'  # ConsulæœåŠ¡å™¨åœ°å€
        services: []                         # ç©ºè¡¨ç¤ºå‘ç°æ‰€æœ‰æœåŠ¡
        tags: ['prometheus', 'monitoring']   # åªå‘ç°ç‰¹å®šæ ‡ç­¾çš„æœåŠ¡
        refresh_interval: 30s
        
    relabel_configs:
      # åªç›‘æ§å¥åº·çš„æœåŠ¡å®ä¾‹
      - source_labels: [__meta_consul_health]
        regex: '(passing|warning)'
        action: keep
        
      # ä½¿ç”¨æœåŠ¡åä½œä¸ºjobæ ‡ç­¾
      - source_labels: [__meta_consul_service]
        target_label: job
        
      # æ·»åŠ æ•°æ®ä¸­å¿ƒä¿¡æ¯
      - source_labels: [__meta_consul_dc]
        target_label: datacenter
        
      # ä½¿ç”¨consulæ ‡ç­¾
      - source_labels: [__meta_consul_tags]
        regex: '.*,environment-([^,]+),.*'
        target_label: environment
        replacement: '${1}'
```

### 5.3 æœåŠ¡æ³¨å†Œä¸å¥åº·æ£€æŸ¥


**ğŸ“ åº”ç”¨æœåŠ¡æ³¨å†Œç¤ºä¾‹**ï¼š
```json
{
  "ID": "web-app-01",
  "Name": "web-app",
  "Tags": ["prometheus", "web", "environment-production"],
  "Address": "192.168.1.10",
  "Port": 8080,
  "Check": {
    "HTTP": "http://192.168.1.10:8080/health",
    "Interval": "10s",
    "Timeout": "5s"
  },
  "Meta": {
    "version": "v2.1.0",
    "team": "frontend",
    "prometheus_path": "/metrics"
  }
}
```

**ğŸ”§ ä½¿ç”¨Consul APIæ³¨å†ŒæœåŠ¡**ï¼š
```bash
# æ³¨å†ŒæœåŠ¡åˆ°Consul
curl -X PUT http://consul.internal.com:8500/v1/agent/service/register \
  -d '{
    "ID": "node-exporter-web-01",
    "Name": "node-exporter", 
    "Tags": ["prometheus", "infrastructure", "environment-production"],
    "Address": "192.168.1.10",
    "Port": 9100,
    "Check": {
      "HTTP": "http://192.168.1.10:9100/metrics",
      "Interval": "30s",
      "Timeout": "10s"
    }
  }'

# æŸ¥è¯¢æœåŠ¡çŠ¶æ€
curl http://consul.internal.com:8500/v1/health/service/node-exporter?passing
```

### 5.4 é«˜çº§Consulå‘ç°é…ç½®


**ğŸ¨ å¤šæ•°æ®ä¸­å¿ƒå’Œç¯å¢ƒé…ç½®**ï¼š
```yaml
scrape_configs:
  # ç”Ÿäº§ç¯å¢ƒConsulé›†ç¾¤
  - job_name: 'consul-prod'
    consul_sd_configs:
      - server: 'consul-prod.internal.com:8500'
        datacenter: 'dc1'
        services: ['web-app', 'api-service', 'database']
        tags: ['prometheus', 'production']
        
    relabel_configs:
      # è¿‡æ»¤ç”Ÿäº§ç¯å¢ƒçš„æœåŠ¡
      - source_labels: [__meta_consul_tags]
        regex: '.*environment-production.*'
        action: keep
        
      # è®¾ç½®æŒ‡æ ‡è·¯å¾„
      - source_labels: [__meta_consul_service_metadata_prometheus_path]
        target_label: __metrics_path__
        regex: '(.+)'
        replacement: '${1}'
      
      # é»˜è®¤æŒ‡æ ‡è·¯å¾„
      - target_label: __metrics_path__
        replacement: '/metrics'
        
  # æµ‹è¯•ç¯å¢ƒå•ç‹¬é…ç½®
  - job_name: 'consul-staging'
    consul_sd_configs:
      - server: 'consul-staging.internal.com:8500'
        tags: ['prometheus', 'staging']
        
    relabel_configs:
      - source_labels: [__meta_consul_tags]
        regex: '.*environment-staging.*'
        action: keep
```

**ğŸ’¼ å®é™…åº”ç”¨åœºæ™¯é…ç½®**ï¼š
```yaml
# å¾®æœåŠ¡æ¶æ„çš„Consulå‘ç°
scrape_configs:
  - job_name: 'microservices'
    consul_sd_configs:
      - server: 'consul.microservices.internal:8500'
        services: []  # å‘ç°æ‰€æœ‰æœåŠ¡
        
    relabel_configs:
      # åªç›‘æ§æœ‰prometheusæ ‡ç­¾çš„æœåŠ¡
      - source_labels: [__meta_consul_tags]
        regex: '.*prometheus.*'
        action: keep
        
      # è·³è¿‡Consulè‡ªèº«çš„æœåŠ¡
      - source_labels: [__meta_consul_service]
        regex: 'consul'
        action: drop
        
      # è®¾ç½®æœåŠ¡æ ‡ç­¾
      - source_labels: [__meta_consul_service]
        target_label: service
        
      # ä»æ ‡ç­¾ä¸­æå–å›¢é˜Ÿä¿¡æ¯
      - source_labels: [__meta_consul_tags]
        regex: '.*team-([^,]+).*'
        target_label: team
        replacement: '${1}'
        
      # ä»æ ‡ç­¾ä¸­æå–ç‰ˆæœ¬ä¿¡æ¯
      - source_labels: [__meta_consul_service_metadata_version]
        target_label: version
```

---

## 6. â˜¸ï¸ KubernetesæœåŠ¡å‘ç°


### 6.1 Kuberneteså‘ç°æœºåˆ¶


KubernetesæœåŠ¡å‘ç°æ˜¯ç°ä»£å®¹å™¨ç¯å¢ƒä¸­æœ€å¼ºå¤§çš„æœåŠ¡å‘ç°æ–¹å¼ï¼Œå®ƒèƒ½å¤Ÿè‡ªåŠ¨å‘ç°é›†ç¾¤ä¸­çš„å„ç§èµ„æºå¯¹è±¡ã€‚

**ğŸ›ï¸ K8så‘ç°å¯¹è±¡ç±»å‹**ï¼š
```
Kuberneteså‘ç°ç±»å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Node     â”‚  â”‚     Pod      â”‚  â”‚   Service    â”‚  
â”‚  (èŠ‚ç‚¹ç›‘æ§)   â”‚  â”‚  (å®¹å™¨ç›‘æ§)   â”‚  â”‚  (æœåŠ¡ç›‘æ§)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Endpoint   â”‚  â”‚   Ingress    â”‚  â”‚  EndpointSliceâ”‚
â”‚  (ç«¯ç‚¹ç›‘æ§)   â”‚  â”‚  (å…¥å£ç›‘æ§)   â”‚  â”‚ (ç«¯ç‚¹åˆ‡ç‰‡)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 PodæœåŠ¡å‘ç°é…ç½®


**ğŸš€ Podçº§åˆ«çš„å‘ç°é…ç½®**ï¼š
```yaml
# prometheus.yml - Podå‘ç°é…ç½®
scrape_configs:
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
        api_server: 'https://kubernetes.default.svc:443'
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        
    relabel_configs:
      # åªç›‘æ§æœ‰prometheus.io/scrape=trueæ³¨è§£çš„Pod
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
        
      # ä½¿ç”¨æ³¨è§£ä¸­çš„è·¯å¾„ï¼Œé»˜è®¤ä¸º/metrics
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
        
      # ä½¿ç”¨æ³¨è§£ä¸­çš„ç«¯å£
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: ${1}:${2}
        target_label: __address__
        
      # æ·»åŠ Podç›¸å…³æ ‡ç­¾
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
        
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name
```

### 6.3 ServiceæœåŠ¡å‘ç°


**âš–ï¸ Serviceçº§åˆ«å‘ç°**ï¼š
```yaml
scrape_configs:
  - job_name: 'kubernetes-services'
    kubernetes_sd_configs:
      - role: service
        
    relabel_configs:
      # åªç›‘æ§æœ‰prometheus.io/scrape=trueæ³¨è§£çš„Service
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
        
      # è·³è¿‡æ²¡æœ‰ç«¯ç‚¹çš„Service
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
        
      # è®¾ç½®æŒ‡æ ‡è·¯å¾„
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
        
      # è®¾ç½®æŠ“å–ç«¯å£
      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: ${1}:${2}
        
      # æ·»åŠ Serviceä¿¡æ¯æ ‡ç­¾
      - source_labels: [__meta_kubernetes_service_name]
        action: replace
        target_label: kubernetes_service_name
        
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
```

### 6.4 NodeèŠ‚ç‚¹å‘ç°


**ğŸ–¥ï¸ èŠ‚ç‚¹çº§åˆ«ç›‘æ§**ï¼š
```yaml
scrape_configs:
  - job_name: 'kubernetes-nodes'
    kubernetes_sd_configs:
      - role: node
        
    relabel_configs:
      # è®¾ç½®èŠ‚ç‚¹ç›‘æ§åœ°å€
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
        
      # ä½¿ç”¨èŠ‚ç‚¹å†…éƒ¨IP
      - source_labels: [__meta_kubernetes_node_address_InternalIP]
        target_label: __address__
        replacement: '${1}:9100'  # node_exporteré»˜è®¤ç«¯å£
        
      # æ·»åŠ èŠ‚ç‚¹è§’è‰²æ ‡ç­¾
      - source_labels: [__meta_kubernetes_node_label_kubernetes_io_role]
        action: replace
        target_label: node_role
        
      # æ·»åŠ èŠ‚ç‚¹åç§°
      - source_labels: [__meta_kubernetes_node_name]
        action: replace
        target_label: node_name
```

### 6.5 K8så‘ç°å®Œæ•´å®ä¾‹


**ğŸ”§ ç”Ÿäº§çº§K8sç›‘æ§é…ç½®**ï¼š
```yaml
# å®Œæ•´çš„KubernetesæœåŠ¡å‘ç°é…ç½®
scrape_configs:
  # kubeletç›‘æ§ï¼ˆèŠ‚ç‚¹çº§æŒ‡æ ‡ï¼‰
  - job_name: 'kubernetes-kubelet'
    kubernetes_sd_configs:
      - role: node
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics
        
  # cAdvisorç›‘æ§ï¼ˆå®¹å™¨æŒ‡æ ‡ï¼‰
  - job_name: 'kubernetes-cadvisor'
    kubernetes_sd_configs:
      - role: node
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
        
  # åº”ç”¨Podç›‘æ§
  - job_name: 'kubernetes-pod-monitoring'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      # åªç›‘æ§å¸¦æœ‰ç‰¹å®šæ³¨è§£çš„Pod
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: ${1}:${2}
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name
```

---

## 7. ğŸ³ Dockerå®¹å™¨æœåŠ¡å‘ç°


### 7.1 Dockerå‘ç°åŸºç¡€


DockeræœåŠ¡å‘ç°è®©Prometheusèƒ½å¤Ÿè‡ªåŠ¨å‘ç°è¿è¡Œä¸­çš„å®¹å™¨ï¼Œéå¸¸é€‚åˆå•æœºæˆ–å°è§„æ¨¡å®¹å™¨ç¯å¢ƒã€‚

**ğŸ‹ Dockerå‘ç°å·¥ä½œåŸç†**ï¼š
```
Dockerå‘ç°æµç¨‹ï¼š
Docker Daemon â†’ å®¹å™¨äº‹ä»¶ç›‘å¬ â†’ Prometheuså‘ç° â†’ åŠ¨æ€æ›´æ–°ç›®æ ‡
      â†“              â†“                â†“              â†“
   å®¹å™¨å¯åœ      å®æ—¶äº‹ä»¶æµ       è¿‡æ»¤å®¹å™¨æ ‡ç­¾    æ›´æ–°ç›‘æ§åˆ—è¡¨
```

### 7.2 åŸºç¡€Dockerå‘ç°é…ç½®


**âš™ï¸ Dockerå‘ç°é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'docker-containers'
    dockerswarm_sd_configs:
      - host: unix:///var/run/docker.sock  # Docker socket
        role: tasks                        # å‘ç°ä»»åŠ¡(å®¹å™¨)
        
    relabel_configs:
      # åªç›‘æ§æœ‰prometheusæ ‡ç­¾çš„å®¹å™¨
      - source_labels: [__meta_dockerswarm_task_label_prometheus_monitoring]
        action: keep
        regex: 'true'
        
      # ä½¿ç”¨å®¹å™¨æ ‡ç­¾ä¸­çš„ç«¯å£
      - source_labels: [__meta_dockerswarm_task_label_prometheus_port]
        action: replace
        target_label: __address__
        regex: '(.+)'
        replacement: '${__meta_dockerswarm_task_port_publish_mode}:${1}'
        
      # æ·»åŠ æœåŠ¡åç§°æ ‡ç­¾
      - source_labels: [__meta_dockerswarm_service_name]
        action: replace
        target_label: service_name
        
      # æ·»åŠ å®¹å™¨IDæ ‡ç­¾
      - source_labels: [__meta_dockerswarm_task_container_id]
        action: replace
        target_label: container_id
```

### 7.3 Docker Composeé›†æˆ


**ğŸ“‹ docker-compose.ymlé…ç½®**ï¼š
```yaml
version: '3.8'
services:
  web-app:
    image: nginx:latest
    ports:
      - "8080:80"
    labels:
      - "prometheus.monitoring=true"
      - "prometheus.port=9113"         # nginx-exporterç«¯å£
      - "prometheus.path=/metrics"
      - "service.name=nginx-web"
      - "service.version=1.0.0"
      
  nginx-exporter:
    image: nginx/nginx-prometheus-exporter
    ports:
      - "9113:9113"
    command:
      - '-nginx.scrape-uri=http://web-app/nginx_status'
    labels:
      - "prometheus.monitoring=true"
      - "prometheus.port=9113"
      
  app-backend:
    image: my-app:latest
    ports:
      - "3000:3000"
    labels:
      - "prometheus.monitoring=true"
      - "prometheus.port=3000"
      - "prometheus.path=/api/metrics"
      - "service.name=backend-api"
      - "service.team=backend"
```

### 7.4 å•æœºDockerå‘ç°


å¯¹äºéSwarmç¯å¢ƒçš„å•æœºDockerï¼Œå¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·ï¼š

**ğŸ”§ ä½¿ç”¨docker-sdå·¥å…·**ï¼š
```bash
# å®‰è£…docker-sd (ç¬¬ä¸‰æ–¹å·¥å…·)
curl -L https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz

# å¯åŠ¨docker-sd
docker run -d \
  --name prometheus-docker-sd \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  -v /etc/prometheus/docker-targets:/output \
  prom/container-exporter

# æˆ–è€…ä½¿ç”¨ç®€å•è„šæœ¬ç”Ÿæˆç›®æ ‡æ–‡ä»¶
cat > /usr/local/bin/docker-discovery.sh << 'EOF'
#!/bin/bash
OUTPUT_FILE="/etc/prometheus/targets/docker-targets.json"

# è·å–æ‰€æœ‰å¸¦æœ‰prometheus.monitoring=trueæ ‡ç­¾çš„å®¹å™¨
docker ps --format 'table {{.ID}}\t{{.Names}}\t{{.Ports}}\t{{.Labels}}' \
  | grep "prometheus.monitoring=true" \
  | while read line; do
    # è§£æå®¹å™¨ä¿¡æ¯å¹¶ç”ŸæˆJSON
    # (å…·ä½“è§£æé€»è¾‘ç•¥)
  done > "$OUTPUT_FILE"
EOF

chmod +x /usr/local/bin/docker-discovery.sh
```

### 7.5 Dockerç›‘æ§æœ€ä½³å®è·µ


**ğŸ’¡ å®¹å™¨ç›‘æ§æ ‡ç­¾è§„èŒƒ**ï¼š
```yaml
# æ¨èçš„å®¹å™¨æ ‡ç­¾è§„èŒƒ
services:
  application:
    labels:
      # åŸºç¡€ç›‘æ§æ ‡ç­¾
      - "prometheus.monitoring=true"
      - "prometheus.port=8080"
      - "prometheus.path=/metrics"
      - "prometheus.interval=15s"
      
      # æœåŠ¡ä¿¡æ¯æ ‡ç­¾
      - "service.name=user-service"
      - "service.version=v2.1.0"
      - "service.team=backend"
      - "service.environment=production"
      
      # ä¸šåŠ¡æ ‡ç­¾
      - "business.domain=user-management"
      - "business.criticality=high"
      
      # æŠ€æœ¯æ ‡ç­¾
      - "tech.stack=golang"
      - "tech.database=postgresql"
```

**âš ï¸ Dockerå‘ç°æ³¨æ„äº‹é¡¹**ï¼š
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… å•æœºæˆ–å°è§„æ¨¡Dockeréƒ¨ç½²
âœ… å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ
âœ… ä¸´æ—¶å®¹å™¨ç›‘æ§
âœ… éç¼–æ’ç¯å¢ƒ

é™åˆ¶ï¼š
âŒ ä¸é€‚åˆå¤§è§„æ¨¡å®¹å™¨é›†ç¾¤
âŒ ç¼ºä¹é«˜å¯ç”¨æ€§
âŒ ç½‘ç»œé…ç½®å¤æ‚æ—¶ä¸é€‚ç”¨
âŒ ä¸å¦‚Kuberneteså‘ç°åŠŸèƒ½ä¸°å¯Œ
```

---

## 8. ğŸ› ï¸ è‡ªå®šä¹‰æœåŠ¡å‘ç°


### 8.1 è‡ªå®šä¹‰å‘ç°éœ€æ±‚åœºæ™¯


æœ‰æ—¶å€™ç°æœ‰çš„æœåŠ¡å‘ç°æœºåˆ¶æ— æ³•æ»¡è¶³ç‰¹æ®Šéœ€æ±‚ï¼Œæ¯”å¦‚ä»æ•°æ®åº“ã€APIæˆ–è€…ç‰¹å®šçš„é…ç½®ç®¡ç†ç³»ç»Ÿä¸­è·å–ç›‘æ§ç›®æ ‡ã€‚

**ğŸ¯ å¸¸è§è‡ªå®šä¹‰å‘ç°åœºæ™¯**ï¼š
```
å®é™…éœ€æ±‚ä¾‹å­ï¼š
ğŸ“Š ä»CMDBç³»ç»Ÿè·å–æœåŠ¡å™¨æ¸…å•
ğŸ—„ï¸ ä»æ•°æ®åº“ä¸­è¯»å–åº”ç”¨é…ç½®  
ğŸŒ ä»äº‘å‚å•†APIè·å–å®ä¾‹ä¿¡æ¯
ğŸ“± ä»ä¼ä¸šå†…éƒ¨ç³»ç»Ÿé›†æˆç›‘æ§ç›®æ ‡
ğŸ”„ åŸºäºä¸šåŠ¡é€»è¾‘çš„åŠ¨æ€å‘ç°
```

### 8.2 HTTP APIæœåŠ¡å‘ç°


**ğŸŒ åŸºäºHTTP APIçš„å‘ç°**ï¼š
```yaml
# prometheus.yml - HTTPæœåŠ¡å‘ç°é…ç½®
scrape_configs:
  - job_name: 'http-api-discovery'
    http_sd_configs:
      - url: 'http://discovery-api.internal.com/prometheus/targets'
        refresh_interval: 60s
        
    # é…ç½®HTTPè®¤è¯
    basic_auth:
      username: 'prometheus'
      password: 'discovery-secret'
      
    relabel_configs:
      - source_labels: [__meta_service_type]
        target_label: service_type
      - source_labels: [__meta_datacenter]
        target_label: datacenter
```

**ğŸ”§ APIç«¯ç‚¹å®ç°ç¤ºä¾‹**ï¼š
```python
# discovery-api.py - ç®€å•çš„å‘ç°APIæœåŠ¡
from flask import Flask, jsonify
import sqlite3
import json

app = Flask(__name__)

@app.route('/prometheus/targets')
def get_prometheus_targets():
    # ä»æ•°æ®åº“è·å–æœåŠ¡ä¿¡æ¯
    conn = sqlite3.connect('services.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT hostname, port, service_type, environment, datacenter 
        FROM services 
        WHERE monitoring_enabled = 1 AND status = 'active'
    ''')
    
    targets = []
    for row in cursor.fetchall():
        hostname, port, service_type, env, dc = row
        target_group = {
            "targets": [f"{hostname}:{port}"],
            "labels": {
                "service_type": service_type,
                "environment": env,
                "datacenter": dc,
                "source": "cmdb-api"
            }
        }
        targets.append(target_group)
    
    conn.close()
    return jsonify(targets)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```

### 8.3 è„šæœ¬åŒ–æœåŠ¡å‘ç°


**ğŸ“œ è‡ªå®šä¹‰è„šæœ¬å‘ç°**ï¼š
```bash
#!/bin/bash
# custom-discovery.sh - ä»å¤šä¸ªæ•°æ®æºèšåˆç›®æ ‡

TARGET_FILE="/etc/prometheus/targets/custom-targets.json"
TEMP_FILE="${TARGET_FILE}.tmp"

# åˆå§‹åŒ–JSONæ•°ç»„
echo '[' > "$TEMP_FILE"

# ä»AWS EC2è·å–å®ä¾‹
if command -v aws >/dev/null 2>&1; then
    aws ec2 describe-instances \
        --filters "Name=tag:Monitoring,Values=enabled" \
        --query 'Reservations[*].Instances[*].[PrivateIpAddress,Tags[?Key==`Name`].Value|[0],Tags[?Key==`Environment`].Value|[0]]' \
        --output text | while read ip name env; do
        if [[ -n "$ip" && -n "$name" ]]; then
            cat >> "$TEMP_FILE" << EOF
  {
    "targets": ["${ip}:9100"],
    "labels": {
      "service": "ec2-node",
      "instance_name": "${name}",
      "environment": "${env:-unknown}",
      "cloud_provider": "aws",
      "discovery_method": "aws-api"
    }
  },
EOF
        fi
    done
fi

# ä»æœ¬åœ°é…ç½®æ–‡ä»¶è·å–
if [[ -f "/etc/monitoring/static-targets.conf" ]]; then
    while IFS='|' read -r host port service env; do
        [[ "$host" =~ ^#.*$ ]] && continue  # è·³è¿‡æ³¨é‡Šè¡Œ
        cat >> "$TEMP_FILE" << EOF
  {
    "targets": ["${host}:${port}"],
    "labels": {
      "service": "${service}",
      "environment": "${env}",
      "discovery_method": "static-config"
    }
  },
EOF
    done < "/etc/monitoring/static-targets.conf"
fi

# ä»æ•°æ®åº“æŸ¥è¯¢
if command -v mysql >/dev/null 2>&1; then
    mysql -h db.internal.com -u monitoring -p${DB_PASSWORD} \
          -D infrastructure --batch --skip-column-names \
          -e "SELECT CONCAT(hostname, ':', port), service_name, environment FROM servers WHERE monitoring = 1;" \
    | while read target service env; do
        cat >> "$TEMP_FILE" << EOF
  {
    "targets": ["${target}"],
    "labels": {
      "service": "${service}",
      "environment": "${env}",
      "discovery_method": "database-query"
    }
  },
EOF
    done
fi

# æ¸…ç†æœ€åçš„é€—å·å¹¶å…³é—­JSON
sed -i '$ s/,$//' "$TEMP_FILE"
echo ']' >> "$TEMP_FILE"

# éªŒè¯JSONæ ¼å¼
if jq empty "$TEMP_FILE" 2>/dev/null; then
    mv "$TEMP_FILE" "$TARGET_FILE"
    echo "Generated $(jq length $TARGET_FILE) targets at $(date)"
else
    echo "Invalid JSON generated, keeping previous version"
    rm -f "$TEMP_FILE"
fi
```

### 8.4 ä¼ä¸šé›†æˆå®ä¾‹


**ğŸ¢ ä¸ä¼ä¸šç³»ç»Ÿé›†æˆ**ï¼š
```python
# enterprise-discovery.py - ä¼ä¸šçº§å‘ç°æœåŠ¡
import requests
import json
import yaml
from datetime import datetime
import logging

class EnterpriseDiscovery:
    def __init__(self, config_file):
        with open(config_file, 'r') as f:
            self.config = yaml.safe_load(f)
        self.logger = logging.getLogger(__name__)
        
    def get_cmdb_targets(self):
        """ä»CMDBç³»ç»Ÿè·å–ç›®æ ‡"""
        cmdb_url = self.config['cmdb']['url']
        headers = {
            'Authorization': f"Bearer {self.config['cmdb']['token']}",
            'Content-Type': 'application/json'
        }
        
        try:
            response = requests.get(f"{cmdb_url}/api/servers", headers=headers)
            servers = response.json()
            
            targets = []
            for server in servers:
                if server.get('monitoring_enabled'):
                    target = {
                        "targets": [f"{server['ip']}:{server.get('metrics_port', 9100)}"],
                        "labels": {
                            "server_id": server['id'],
                            "hostname": server['hostname'],
                            "environment": server['environment'],
                            "team": server['team'],
                            "location": server['datacenter'],
                            "source": "cmdb"
                        }
                    }
                    targets.append(target)
            return targets
            
        except Exception as e:
            self.logger.error(f"Failed to fetch CMDB targets: {e}")
            return []
    
    def get_cloud_targets(self):
        """ä»äº‘å‚å•†APIè·å–ç›®æ ‡"""
        # è¿™é‡Œå¯ä»¥é›†æˆé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰API
        pass
    
    def generate_targets(self, output_file):
        """ç”Ÿæˆæœ€ç»ˆçš„ç›®æ ‡æ–‡ä»¶"""
        all_targets = []
        
        # ä»å„ä¸ªæ•°æ®æºèšåˆç›®æ ‡
        all_targets.extend(self.get_cmdb_targets())
        # all_targets.extend(self.get_cloud_targets())
        
        # æ·»åŠ å‘ç°æ—¶é—´æˆ³
        for target_group in all_targets:
            target_group['labels']['discovered_at'] = datetime.now().isoformat()
        
        # å†™å…¥æ–‡ä»¶
        with open(output_file, 'w') as f:
            json.dump(all_targets, f, indent=2)
        
        self.logger.info(f"Generated {len(all_targets)} target groups")

# é…ç½®æ–‡ä»¶ enterprise-config.yml
config_content = """
cmdb:
  url: "https://cmdb.company.com"
  token: "your-api-token"
  
cloud:
  aliyun:
    access_key: "your-access-key"
    secret_key: "your-secret-key"
    region: "cn-hangzhou"
"""

# å®šæ—¶æ‰§è¡Œ
if __name__ == "__main__":
    discovery = EnterpriseDiscovery('enterprise-config.yml')
    discovery.generate_targets('/etc/prometheus/targets/enterprise-targets.json')
```

---

## 9. ğŸ·ï¸ æœåŠ¡å‘ç°æ ‡ç­¾é‡å†™


### 9.1 æ ‡ç­¾é‡å†™åŸºç¡€æ¦‚å¿µ


æ ‡ç­¾é‡å†™å°±åƒç»™ä¿¡ä»¶é‡æ–°æ•´ç†åœ°å€æ ‡ç­¾ï¼Œè®©Prometheusèƒ½æ›´å¥½åœ°ç†è§£å’Œç»„ç»‡ç›‘æ§ç›®æ ‡çš„ä¿¡æ¯ã€‚

**ğŸ”„ é‡å†™æ“ä½œç±»å‹**ï¼š
```
æ ‡ç­¾æ“ä½œç±»å‹ï¼š
âœï¸ replace: æ›¿æ¢æˆ–åˆ›å»ºæ ‡ç­¾
ğŸ—‘ï¸ drop: ä¸¢å¼ƒä¸éœ€è¦çš„ç›®æ ‡
âœ… keep: åªä¿ç•™ç¬¦åˆæ¡ä»¶çš„ç›®æ ‡
ğŸ·ï¸ labelmap: æ‰¹é‡æ ‡ç­¾æ˜ å°„
ğŸ“ labeldrop: åˆ é™¤ç‰¹å®šæ ‡ç­¾
ğŸ“‹ labelkeep: åªä¿ç•™ç‰¹å®šæ ‡ç­¾
```

### 9.2 åŸºç¡€æ ‡ç­¾é‡å†™è§„åˆ™


**ğŸ“‹ å¸¸ç”¨é‡å†™è§„åˆ™ç¤ºä¾‹**ï¼š
```yaml
relabel_configs:
  # 1. åŸºç¡€æ›¿æ¢ï¼šä»æºæ ‡ç­¾åˆ›å»ºæ–°æ ‡ç­¾
  - source_labels: [__meta_consul_service]
    target_label: job
    
  # 2. æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢
  - source_labels: [__meta_kubernetes_pod_name]
    regex: '(.+)-[0-9a-f]+-[0-9a-f]+'  # åŒ¹é…Podåç§°æ¨¡å¼
    target_label: app_name
    replacement: '${1}'                  # æå–åº”ç”¨åç§°éƒ¨åˆ†
    
  # 3. å¤šæºæ ‡ç­¾ç»„åˆ
  - source_labels: [__meta_consul_service, __meta_consul_dc]
    separator: '-'
    target_label: service_location
    replacement: '${1}-${2}'
    
  # 4. æ¡ä»¶è¿‡æ»¤ï¼šåªä¿ç•™ç”Ÿäº§ç¯å¢ƒ
  - source_labels: [environment]
    regex: 'production'
    action: keep
    
  # 5. æ’é™¤ç‰¹å®šç›®æ ‡
  - source_labels: [__meta_kubernetes_pod_name]
    regex: '.*-test-.*'
    action: drop
```

### 9.3 é«˜çº§æ ‡ç­¾é‡å†™æŠ€å·§


**ğŸ¨ å¤æ‚é‡å†™è§„åˆ™**ï¼š
```yaml
scrape_configs:
  - job_name: 'advanced-relabeling'
    kubernetes_sd_configs:
      - role: pod
        
    relabel_configs:
      # ä»æ³¨è§£ä¸­æå–å¤šä¸ªé…ç½®å€¼
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
        
      # åŠ¨æ€è®¾ç½®æŒ‡æ ‡è·¯å¾„
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
        replacement: ${1}
      - target_label: __metrics_path__
        replacement: /metrics  # é»˜è®¤è·¯å¾„
        
      # å¤æ‚çš„ç«¯å£å¤„ç†
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: '([^:]+)(?::\d+)?;(\d+)'
        replacement: ${1}:${2}
        target_label: __address__
        
      # ä»æ ‡ç­¾ä¸­æå–åº”ç”¨ç‰ˆæœ¬
      - source_labels: [__meta_kubernetes_pod_label_version]
        regex: 'v?(.+)'
        target_label: app_version
        replacement: '${1}'
        
      # è®¾ç½®ç›‘æ§çº§åˆ«ï¼ˆä»æ ‡ç­¾æ¨æ–­ï¼‰
      - source_labels: [__meta_kubernetes_pod_label_tier]
        regex: 'frontend|backend'
        target_label: monitoring_level
        replacement: 'standard'
      - source_labels: [__meta_kubernetes_pod_label_tier]
        regex: 'database|cache'
        target_label: monitoring_level
        replacement: 'intensive'
        
      # æ ‡ç­¾æ˜ å°„ï¼šå°†æ‰€æœ‰app.kubernetes.ioå¼€å¤´çš„æ ‡ç­¾æ˜ å°„è¿‡æ¥
      - action: labelmap
        regex: __meta_kubernetes_pod_label_app_kubernetes_io_(.+)
        replacement: k8s_${1}
        
      # æ¸…ç†ä¸éœ€è¦çš„å†…éƒ¨æ ‡ç­¾
      - regex: '__meta_kubernetes_pod_label_pod_template_hash'
        action: labeldrop
```

### 9.4 ç¯å¢ƒç‰¹å®šé‡å†™ç­–ç•¥


**ğŸŒ å¤šç¯å¢ƒæ ‡ç­¾æ ‡å‡†åŒ–**ï¼š
```yaml
# ä¸åŒç¯å¢ƒçš„ç»Ÿä¸€æ ‡ç­¾ç­–ç•¥
relabel_configs:
  # ç¯å¢ƒæ ‡ç­¾æ ‡å‡†åŒ–
  - source_labels: [__meta_consul_tags]
    regex: '.*env-([^,]+).*'
    target_label: environment
    replacement: '${1}'
    
  # å¦‚æœæ²¡æœ‰ç¯å¢ƒæ ‡ç­¾ï¼Œä»æœåŠ¡åæ¨æ–­
  - source_labels: [__meta_consul_service, environment]
    regex: '(.+)-(prod|staging|dev);^$'
    target_label: environment
    replacement: '${2}'
    
  # æ ‡å‡†åŒ–ç¯å¢ƒåç§°
  - source_labels: [environment]
    regex: 'prod|production'
    target_label: environment
    replacement: 'production'
  - source_labels: [environment]
    regex: 'stage|staging|test'
    target_label: environment
    replacement: 'staging'
  - source_labels: [environment]
    regex: 'dev|development'
    target_label: environment
    replacement: 'development'
    
  # è®¾ç½®å‘Šè­¦çº§åˆ«
  - source_labels: [environment]
    regex: 'production'
    target_label: alert_level
    replacement: 'critical'
  - source_labels: [environment]
    regex: 'staging'
    target_label: alert_level
    replacement: 'warning'
  - source_labels: [environment]
    regex: 'development'
    target_label: alert_level
    replacement: 'info'
```

### 9.5 å®é™…åº”ç”¨åœºæ™¯


**ğŸ’¼ ä¼ä¸šçº§æ ‡ç­¾é‡å†™å®ä¾‹**ï¼š
```yaml
# é€‚åˆå¤§å‹ä¼ä¸šçš„å®Œæ•´æ ‡ç­¾é‡å†™ç­–ç•¥
scrape_configs:
  - job_name: 'enterprise-services'
    consul_sd_configs:
      - server: 'consul.internal.com:8500'
        
    relabel_configs:
      # ç¬¬ä¸€é˜¶æ®µï¼šç›®æ ‡è¿‡æ»¤
      - source_labels: [__meta_consul_health]
        regex: 'passing|warning'
        action: keep
      - source_labels: [__meta_consul_tags]
        regex: '.*prometheus.*'
        action: keep
        
      # ç¬¬äºŒé˜¶æ®µï¼šåŸºç¡€æ ‡ç­¾æå–
      - source_labels: [__meta_consul_service]
        target_label: service_name
      - source_labels: [__meta_consul_dc]
        target_label: datacenter
      - source_labels: [__meta_consul_node]
        target_label: consul_node
        
      # ç¬¬ä¸‰é˜¶æ®µï¼šä¸šåŠ¡æ ‡ç­¾è§£æ
      - source_labels: [__meta_consul_tags]
        regex: '.*team-([^,]+).*'
        target_label: team
        replacement: '${1}'
      - source_labels: [__meta_consul_tags]
        regex: '.*environment-([^,]+).*'
        target_label: environment
        replacement: '${1}'
      - source_labels: [__meta_consul_tags]
        regex: '.*version-([^,]+).*'
        target_label: version
        replacement: '${1}'
        
      # ç¬¬å››é˜¶æ®µï¼šæŠ€æœ¯æ ‡ç­¾åˆ†ç±»
      - source_labels: [__meta_consul_service]
        regex: '.*(web|http|nginx).*'
        target_label: service_type
        replacement: 'web'
      - source_labels: [__meta_consul_service]
        regex: '.*(api|service).*'
        target_label: service_type
        replacement: 'api'
      - source_labels: [__meta_consul_service]
        regex: '.*(db|database|mysql|postgres).*'
        target_label: service_type
        replacement: 'database'
        
      # ç¬¬äº”é˜¶æ®µï¼šç›‘æ§é…ç½®
      - source_labels: [__meta_consul_service_metadata_metrics_path]
        target_label: __metrics_path__
        regex: '(.+)'
        replacement: '${1}'
      - target_label: __metrics_path__
        replacement: '/metrics'
        
      # ç¬¬å…­é˜¶æ®µï¼šæ¸…ç†å’Œæ ‡å‡†åŒ–
      - regex: '__meta_consul_.*'
        action: labeldrop  # æ¸…ç†æ‰€æœ‰å†…éƒ¨æ ‡ç­¾
      - source_labels: [environment]
        regex: '^$'
        target_label: environment
        replacement: 'unknown'  # ä¸ºç©ºç¯å¢ƒè®¾ç½®é»˜è®¤å€¼
```

**ğŸ“Š æ ‡ç­¾é‡å†™éªŒè¯**ï¼š
```bash
# éªŒè¯æ ‡ç­¾é‡å†™æ•ˆæœ
curl -s http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | {
  instance: .discoveredLabels.__address__,
  labels: .labels,
  health: .health
}' | head -20

# æŸ¥çœ‹å…·ä½“Jobçš„æ ‡ç­¾
curl -s http://localhost:9090/api/v1/label/__name__/values | jq '.data[]' | grep -E '^up|prometheus_' | head -10
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æœåŠ¡å‘ç°æœ¬è´¨ï¼šè‡ªåŠ¨å‘ç°å’Œç®¡ç†ç›‘æ§ç›®æ ‡ï¼Œå‡å°‘æ‰‹åŠ¨é…ç½®
ğŸ”¸ å‘ç°ç±»å‹é€‰æ‹©ï¼šé™æ€â†’æ–‡ä»¶â†’DNSâ†’Consulâ†’K8sï¼Œå¤æ‚åº¦é€’å¢
ğŸ”¸ æ ‡ç­¾é‡å†™ä½œç”¨ï¼šæ ‡å‡†åŒ–æ ‡ç­¾æ ¼å¼ï¼Œè¿‡æ»¤ç›®æ ‡ï¼Œå¢å¼ºå¯è§‚æµ‹æ€§
ğŸ”¸ é…ç½®çƒ­é‡è½½ï¼šå¤§å¤šæ•°å‘ç°æ–¹å¼æ”¯æŒåŠ¨æ€æ›´æ–°ï¼Œæ— éœ€é‡å¯
ğŸ”¸ å¤šæºé›†æˆï¼šå¯ä»¥åŒæ—¶ä½¿ç”¨å¤šç§å‘ç°æ–¹å¼ï¼Œæ»¡è¶³å¤æ‚ç¯å¢ƒéœ€æ±‚
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¦‚ä½•é€‰æ‹©åˆé€‚çš„æœåŠ¡å‘ç°æ–¹å¼**ï¼š
```
å†³ç­–æ ‡å‡†ï¼š
ç¯å¢ƒè§„æ¨¡ï¼š
â€¢ å°è§„æ¨¡ (<50å°) â†’ é™æ€é…ç½®æˆ–æ–‡ä»¶å‘ç°
â€¢ ä¸­ç­‰è§„æ¨¡ (50-500å°) â†’ DNSæˆ–Consulå‘ç°
â€¢ å¤§è§„æ¨¡ (500+å°) â†’ Kubernetesæˆ–è‡ªå®šä¹‰å‘ç°

åŸºç¡€è®¾æ–½ç±»å‹ï¼š
â€¢ ä¼ ç»Ÿè™šæ‹Ÿæœº â†’ DNSæˆ–Consulå‘ç°
â€¢ å®¹å™¨åŒ–ç¯å¢ƒ â†’ Kubernetesæˆ–Dockerå‘ç°  
â€¢ æ··åˆç¯å¢ƒ â†’ å¤šç§å‘ç°æ–¹å¼ç»“åˆ

å˜æ›´é¢‘ç‡ï¼š
â€¢ å¾ˆå°‘å˜æ›´ â†’ é™æ€é…ç½®
â€¢ å®šæœŸå˜æ›´ â†’ æ–‡ä»¶å‘ç°
â€¢ é¢‘ç¹å˜æ›´ â†’ åŠ¨æ€å‘ç°(Consul/K8s)
```

**ğŸ”¹ æ ‡ç­¾é‡å†™çš„è®¾è®¡åŸåˆ™**ï¼š
```
æ ‡ç­¾è®¾è®¡åŸåˆ™ï¼š
ä¸€è‡´æ€§ï¼šæ‰€æœ‰ç¯å¢ƒä½¿ç”¨ç»Ÿä¸€çš„æ ‡ç­¾è§„èŒƒ
å±‚æ¬¡æ€§ï¼šä»é€šç”¨åˆ°å…·ä½“çš„æ ‡ç­¾å±‚æ¬¡
å¯è¯»æ€§ï¼šæ ‡ç­¾åç§°æ¸…æ™°æ˜äº†
å¯æ‰©å±•æ€§ï¼šé¢„ç•™æ‰©å±•ç©ºé—´

å¸¸ç”¨æ ‡ç­¾ç±»åˆ«ï¼š
â€¢ åŸºç¡€æ ‡ç­¾ï¼šenvironment, service, version
â€¢ ä¸šåŠ¡æ ‡ç­¾ï¼šteam, project, criticality  
â€¢ æŠ€æœ¯æ ‡ç­¾ï¼štechnology, port, protocol
â€¢ ä½ç½®æ ‡ç­¾ï¼šdatacenter, zone, region
```

**ğŸ”¹ æœåŠ¡å‘ç°çš„é«˜å¯ç”¨è®¾è®¡**ï¼š
```
å¯é æ€§ä¿éšœï¼š
â€¢ å¤šä¸ªæœåŠ¡å‘ç°æºï¼šé¿å…å•ç‚¹æ•…éšœ
â€¢ åˆç†çš„åˆ·æ–°é—´éš”ï¼šå¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½
â€¢ å¥åº·æ£€æŸ¥é›†æˆï¼šåªç›‘æ§å¥åº·çš„æœåŠ¡
â€¢ é™çº§ç­–ç•¥ï¼šå‘ç°å¤±è´¥æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ

ç›‘æ§å‘ç°ç³»ç»Ÿï¼š
â€¢ å‘ç°ç›®æ ‡æ•°é‡ç›‘æ§
â€¢ å‘ç°å»¶è¿Ÿå’Œå¤±è´¥ç‡ç›‘æ§
â€¢ é…ç½®å˜æ›´å®¡è®¡æ—¥å¿—
â€¢ ç›®æ ‡çŠ¶æ€å˜åŒ–å‘Šè­¦
```

### 10.3 å®é™…åº”ç”¨æœ€ä½³å®è·µ


**ğŸ’¼ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å»ºè®®**ï¼š
```
éƒ¨ç½²ç­–ç•¥ï¼š
é˜¶æ®µåŒ–å®æ–½ï¼š
1. ä»é™æ€é…ç½®å¼€å§‹éªŒè¯åŸºç¡€åŠŸèƒ½
2. é€æ­¥å¼•å…¥æ–‡ä»¶å‘ç°å¢åŠ çµæ´»æ€§
3. æ ¹æ®åŸºç¡€è®¾æ–½ç‰¹ç‚¹é€‰æ‹©é«˜çº§å‘ç°
4. æœ€åå®æ–½æ ‡ç­¾é‡å†™ä¼˜åŒ–

é…ç½®ç®¡ç†ï¼š
â€¢ ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†é…ç½®æ–‡ä»¶
â€¢ å»ºç«‹é…ç½®å˜æ›´å®¡æ‰¹æµç¨‹
â€¢ å®æ–½é…ç½®è‡ªåŠ¨åŒ–æµ‹è¯•
â€¢ è®¾ç½®é…ç½®å›æ»šæœºåˆ¶

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ åˆç†è®¾ç½®åˆ·æ–°é—´éš”ï¼ˆä¸è¦å¤ªé¢‘ç¹ï¼‰
â€¢ ä½¿ç”¨æ ‡ç­¾è¿‡æ»¤å‡å°‘ä¸å¿…è¦çš„ç›®æ ‡
â€¢ ç›‘æ§Prometheuså†…å­˜å’ŒCPUä½¿ç”¨
â€¢ å®šæœŸæ¸…ç†æ— ç”¨çš„å†å²æ•°æ®
```

**ğŸ›  è¿ç»´ç®¡ç†æŒ‡å—**ï¼š
```
æ—¥å¸¸ç»´æŠ¤ï¼š
ç›‘æ§æ£€æŸ¥ï¼š
âœ… æ¯æ—¥æ£€æŸ¥å‘ç°ç›®æ ‡æ•°é‡
âœ… ç›‘æ§å‘ç°æœåŠ¡çš„å¥åº·çŠ¶æ€
âœ… æŸ¥çœ‹Prometheusæ—¥å¿—é”™è¯¯ä¿¡æ¯
âœ… éªŒè¯æ–°æœåŠ¡æ˜¯å¦è¢«æ­£ç¡®å‘ç°

æ•…éšœæ’æŸ¥ï¼š
ğŸ” ç›®æ ‡æœªè¢«å‘ç° â†’ æ£€æŸ¥æ ‡ç­¾å’Œè¿‡æ»¤è§„åˆ™
ğŸ” å‘ç°å»¶è¿Ÿè¿‡é«˜ â†’ è°ƒæ•´åˆ·æ–°é—´éš”
ğŸ” é‡å¤ç›®æ ‡å‡ºç° â†’ æ£€æŸ¥å¤šä¸ªå‘ç°æºå†²çª
ğŸ” æ ‡ç­¾ä¸æ­£ç¡® â†’ éªŒè¯é‡å†™è§„åˆ™

å®šæœŸä¼˜åŒ–ï¼š
ğŸ“Š åˆ†æç›®æ ‡å‘ç°æ•ˆç‡
ğŸ“Š è¯„ä¼°æ ‡ç­¾ä½¿ç”¨åˆç†æ€§
ğŸ“Š æ¸…ç†åºŸå¼ƒçš„å‘ç°é…ç½®
ğŸ“Š æ›´æ–°å‘ç°è§„åˆ™é€‚åº”ç¯å¢ƒå˜åŒ–
```

### 10.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â“ æœåŠ¡å‘ç°å¸¸è§é—®é¢˜**ï¼š

**é—®é¢˜1ï¼šç›®æ ‡é‡å¤å‡ºç°**
```
åŸå› ï¼šå¤šä¸ªå‘ç°é…ç½®æŒ‡å‘åŒä¸€æœåŠ¡
è§£å†³ï¼š
â€¢ ä½¿ç”¨ä¸åŒçš„job_nameåŒºåˆ†
â€¢ é€šè¿‡æ ‡ç­¾è¿‡æ»¤é¿å…é‡å¤
â€¢ æ£€æŸ¥relabel_configsæ˜¯å¦æœ‰å†²çª

ç¤ºä¾‹ä¿®å¤ï¼š
relabel_configs:
  - source_labels: [__meta_source_type]
    regex: 'consul'
    target_label: discovery_source
  - source_labels: [discovery_source, __meta_consul_service]
    regex: 'consul;(.+)'
    target_label: unique_id
    replacement: 'consul-${1}'
```

**é—®é¢˜2ï¼šæ ‡ç­¾é‡å†™ä¸ç”Ÿæ•ˆ**
```
åŸå› ï¼šé‡å†™è§„åˆ™é¡ºåºé”™è¯¯æˆ–æ­£åˆ™è¡¨è¾¾å¼é—®é¢˜
è§£å†³ï¼š
â€¢ æ£€æŸ¥source_labelsæ˜¯å¦å­˜åœ¨
â€¢ éªŒè¯æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•
â€¢ ç¡®è®¤é‡å†™è§„åˆ™çš„æ‰§è¡Œé¡ºåº

è°ƒè¯•æ–¹æ³•ï¼š
# æŸ¥çœ‹åŸå§‹å‘ç°æ ‡ç­¾
curl -s http://localhost:9090/api/v1/targets | jq '.data.activeTargets[0].discoveredLabels'

# æŸ¥çœ‹æœ€ç»ˆåº”ç”¨æ ‡ç­¾
curl -s http://localhost:9090/api/v1/targets | jq '.data.activeTargets[0].labels'
```

**é—®é¢˜3ï¼šå‘ç°æ€§èƒ½å½±å“**
```
åŸå› ï¼šåˆ·æ–°é—´éš”å¤ªçŸ­æˆ–ç›®æ ‡æ•°é‡è¿‡å¤š
è§£å†³ï¼š
â€¢ å¢åŠ åˆ·æ–°é—´éš”ï¼ˆ30s-5minï¼‰
â€¢ ä½¿ç”¨æ ‡ç­¾è¿‡æ»¤å‡å°‘ç›®æ ‡
â€¢ ä¼˜åŒ–å‘ç°æºçš„æŸ¥è¯¢æ•ˆç‡
â€¢ è€ƒè™‘åˆ†å¸ƒå¼éƒ¨ç½²

æ€§èƒ½ç›‘æ§ï¼š
# Prometheuså†…éƒ¨æŒ‡æ ‡
prometheus_sd_discovered_targets  # å‘ç°çš„ç›®æ ‡æ•°
prometheus_sd_refresh_duration_seconds  # å‘ç°åˆ·æ–°è€—æ—¶
```

### 10.5 æœªæ¥å‘å±•è¶‹åŠ¿


**ğŸš€ æœåŠ¡å‘ç°æŠ€æœ¯å‘å±•**ï¼š
```
æŠ€æœ¯è¶‹åŠ¿ï¼š
AIè¾…åŠ©å‘ç°ï¼š
â€¢ æ™ºèƒ½æœåŠ¡ä¾èµ–åˆ†æ
â€¢ è‡ªåŠ¨ç›‘æ§ç­–ç•¥æ¨è
â€¢ å¼‚å¸¸æœåŠ¡è‡ªåŠ¨å‘ç°

äº‘åŸç”Ÿé›†æˆï¼š
â€¢ å¤šäº‘ç¯å¢ƒç»Ÿä¸€å‘ç°
â€¢ Serverlesså‡½æ•°ç›‘æ§
â€¢ è¾¹ç¼˜è®¡ç®—èŠ‚ç‚¹å‘ç°

å®‰å…¨å¢å¼ºï¼š
â€¢ é›¶ä¿¡ä»»æœåŠ¡å‘ç°
â€¢ åŠ å¯†é€šä¿¡æ ‡å‡†åŒ–
â€¢ èº«ä»½è®¤è¯é›†æˆ

æ•ˆç‡æå‡ï¼š
â€¢ å¢é‡å‘ç°æ›´æ–°
â€¢ é¢„æµ‹æ€§ç›®æ ‡ç®¡ç†
â€¢ è‡ªåŠ¨åŒ–æ•…éšœæ¢å¤
```

**ğŸ“ˆ å­¦ä¹ æå‡è·¯å¾„**ï¼š
```
å­¦ä¹ å»ºè®®ï¼š
åˆçº§é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰ï¼š
â€¢ æŒæ¡é™æ€å’Œæ–‡ä»¶å‘ç°
â€¢ ç†è§£åŸºæœ¬æ ‡ç­¾é‡å†™
â€¢ èƒ½é…ç½®ç®€å•çš„ç›‘æ§ç¯å¢ƒ

ä¸­çº§é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰ï¼š
â€¢ ç†Ÿç»ƒä½¿ç”¨Consul/DNSå‘ç°
â€¢ æŒæ¡å¤æ‚æ ‡ç­¾é‡å†™æŠ€å·§
â€¢ èƒ½è®¾è®¡ä¸­ç­‰è§„æ¨¡ç›‘æ§æ–¹æ¡ˆ

é«˜çº§é˜¶æ®µï¼ˆ3-6ä¸ªæœˆï¼‰ï¼š
â€¢ ç²¾é€šKubernetesæœåŠ¡å‘ç°
â€¢ èƒ½å¼€å‘è‡ªå®šä¹‰å‘ç°æ–¹æ¡ˆ
â€¢ å…·å¤‡å¤§è§„æ¨¡ç¯å¢ƒè®¾è®¡èƒ½åŠ›

ä¸“å®¶é˜¶æ®µï¼ˆæŒç»­å­¦ä¹ ï¼‰ï¼š
â€¢ å…³æ³¨æ–°æŠ€æœ¯å‘å±•è¶‹åŠ¿
â€¢ å‚ä¸å¼€æºé¡¹ç›®è´¡çŒ®
â€¢ åˆ†äº«æœ€ä½³å®è·µç»éªŒ
```

### 10.6 å®æˆ˜ç»ƒä¹ å»ºè®®


**ğŸ¯ åŠ¨æ‰‹å®è·µé¡¹ç›®**ï¼š
```
ç»ƒä¹ é¡¹ç›®ï¼š
é¡¹ç›®1ï¼šå¤šç¯å¢ƒæœåŠ¡å‘ç°
â€¢ æ­å»ºdev/staging/prodä¸‰å¥—ç¯å¢ƒ
â€¢ ä½¿ç”¨æ–‡ä»¶å‘ç°é…ç½®ä¸åŒç¯å¢ƒ
â€¢ å®ç°ç¯å¢ƒæ ‡ç­¾è‡ªåŠ¨åŒ–æ ‡å‡†åŒ–

é¡¹ç›®2ï¼šå¾®æœåŠ¡ç›‘æ§
â€¢ ä½¿ç”¨Docker Composeæ¨¡æ‹Ÿå¾®æœåŠ¡
â€¢ é…ç½®ConsulæœåŠ¡æ³¨å†Œå‘ç°
â€¢ å®ç°æœåŠ¡å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨å‰”é™¤

é¡¹ç›®3ï¼šäº‘ç¯å¢ƒé›†æˆ
â€¢ é›†æˆäº‘å‚å•†APIè·å–å®ä¾‹åˆ—è¡¨
â€¢ å®ç°è‡ªå®šä¹‰HTTPå‘ç°API
â€¢ é…ç½®å¤šæºå‘ç°èšåˆ

é¡¹ç›®4ï¼šä¼ä¸šçº§æ–¹æ¡ˆ
â€¢ è®¾è®¡å®Œæ•´çš„æœåŠ¡å‘ç°æ¶æ„
â€¢ å®ç°é…ç½®ç®¡ç†å’Œç‰ˆæœ¬æ§åˆ¶
â€¢ å»ºç«‹ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- æœåŠ¡å‘ç°è‡ªåŠ¨åŒ–ï¼Œæ‰‹åŠ¨é…ç½®æˆå†å²
- é™æ€æ–‡ä»¶DNS Consulï¼ŒK8så®¹å™¨å„æœ‰é“
- æ ‡ç­¾é‡å†™å¾ˆå…³é”®ï¼Œç»Ÿä¸€è§„èŒƒå¥½ç®¡ç†
- å¤šæºç»“åˆæ±‚ç¨³å®šï¼Œç›‘æ§å‘Šè­¦ä¸å¯å°‘

**ğŸ’¡ æœ€ç»ˆå»ºè®®**ï¼š
æœåŠ¡å‘ç°æ˜¯ç°ä»£ç›‘æ§ç³»ç»Ÿçš„åŸºç¡€è®¾æ–½ï¼Œé€‰æ‹©åˆé€‚çš„å‘ç°æ–¹å¼æ¯”è¿½æ±‚æœ€æ–°æŠ€æœ¯æ›´é‡è¦ã€‚ä»ç®€å•å¼€å§‹ï¼Œé€æ­¥æ¼”è¿›ï¼Œç»“åˆå®é™…éœ€æ±‚åšå‡ºæœ€ä¼˜é€‰æ‹©ã€‚è®°ä½ï¼š**æ²¡æœ‰æœ€å¥½çš„æ–¹æ¡ˆï¼Œåªæœ‰æœ€åˆé€‚çš„æ–¹æ¡ˆï¼**