---
title: 5ã€PromQLæŸ¥è¯¢è¯­è¨€ç²¾é€š
---
## ğŸ“š ç›®å½•

1. [PromQLåŸºç¡€æ¦‚å¿µ](#1-promqlåŸºç¡€æ¦‚å¿µ)
2. [åŸºç¡€è¯­æ³•ç»“æ„](#2-åŸºç¡€è¯­æ³•ç»“æ„)
3. [æŒ‡æ ‡é€‰æ‹©å™¨å’Œè¿‡æ»¤å™¨](#3-æŒ‡æ ‡é€‰æ‹©å™¨å’Œè¿‡æ»¤å™¨)
4. [æ—¶é—´èŒƒå›´æŸ¥è¯¢](#4-æ—¶é—´èŒƒå›´æŸ¥è¯¢)
5. [èšåˆæ“ä½œå‡½æ•°](#5-èšåˆæ“ä½œå‡½æ•°)
6. [æ•°å­¦è¿ç®—å’Œæ¯”è¾ƒæ“ä½œ](#6-æ•°å­¦è¿ç®—å’Œæ¯”è¾ƒæ“ä½œ)
7. [æ ‡ç­¾åŒ¹é…å’Œæ­£åˆ™è¡¨è¾¾å¼](#7-æ ‡ç­¾åŒ¹é…å’Œæ­£åˆ™è¡¨è¾¾å¼)
8. [æ—¶é—´çª—å£å‡½æ•°](#8-æ—¶é—´çª—å£å‡½æ•°)
9. [å¤æ‚æŸ¥è¯¢è¯­å¥æ„å»º](#9-å¤æ‚æŸ¥è¯¢è¯­å¥æ„å»º)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ PromQLåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯PromQL

**PromQL**ï¼ˆPrometheus Query Languageï¼‰æ˜¯Prometheusç›‘æ§ç³»ç»Ÿä¸“ç”¨çš„æŸ¥è¯¢è¯­è¨€ï¼Œå°±åƒSQLç”¨äºæŸ¥è¯¢æ•°æ®åº“ä¸€æ ·ï¼ŒPromQLä¸“é—¨ç”¨æ¥æŸ¥è¯¢å’Œåˆ†ææ—¶é—´åºåˆ—æ•°æ®ã€‚

**ç®€å•ç†è§£**ï¼š
- ğŸ“Š **æ•°æ®åº“æœ‰SQL** â†’ ç›‘æ§ç³»ç»Ÿæœ‰PromQL
- ğŸ” **SQLæŸ¥è¡¨æ ¼æ•°æ®** â†’ PromQLæŸ¥ç›‘æ§æŒ‡æ ‡
- ğŸ“ˆ **ä¸“ä¸ºæ—¶é—´åºåˆ—è®¾è®¡** â†’ å¤©ç„¶æ”¯æŒæ—¶é—´ç»´åº¦åˆ†æ

### 1.2 PromQLçš„æ ¸å¿ƒä½œç”¨


```
ç›‘æ§åœºæ™¯ä¸¾ä¾‹ï¼š
ğŸ–¥ï¸ æœåŠ¡å™¨CPUä½¿ç”¨ç‡è¶‹åŠ¿
ğŸ“Š ç½‘ç«™è®¿é—®é‡ç»Ÿè®¡
âš¡ åº”ç”¨å“åº”æ—¶é—´ç›‘æ§
ğŸ’¾ ç£ç›˜ç©ºé—´ä½¿ç”¨é¢„è­¦
```

**ğŸ’¡ å®é™…åº”ç”¨ä»·å€¼**ï¼š
- **å®æ—¶ç›‘æ§** - æŸ¥çœ‹å½“å‰ç³»ç»ŸçŠ¶æ€
- **å†å²åˆ†æ** - åˆ†æè¿‡å»ä¸€æ®µæ—¶é—´çš„è¶‹åŠ¿  
- **å‘Šè­¦è§„åˆ™** - è®¾å®šç›‘æ§é˜ˆå€¼è§¦å‘æŠ¥è­¦
- **å¯è§†åŒ–å±•ç¤º** - åœ¨Grafanaä¸­åˆ›å»ºå›¾è¡¨

### 1.3 æ—¶é—´åºåˆ—æ•°æ®ç‰¹ç‚¹


**æ—¶é—´åºåˆ—å°±æ˜¯æŒ‰æ—¶é—´é¡ºåºè®°å½•çš„æ•°æ®ç‚¹**ï¼Œæ¯”å¦‚ï¼š

```
CPUä½¿ç”¨ç‡è®°å½•ï¼š
æ—¶é—´                å€¼
2025-09-17 10:00   45%
2025-09-17 10:01   52%  
2025-09-17 10:02   48%
2025-09-17 10:03   61%
```

**ğŸ”¸ æ ¸å¿ƒç»„æˆ**ï¼š
- **æŒ‡æ ‡åç§°** - `cpu_usage_percent`ï¼ˆå‘Šè¯‰ä½ è¿™æ˜¯ä»€ä¹ˆæ•°æ®ï¼‰
- **æ ‡ç­¾** - `{instance="web-01", cpu="0"}`ï¼ˆå‘Šè¯‰ä½ æ•°æ®æ¥æºï¼‰
- **æ—¶é—´æˆ³** - `1695801600`ï¼ˆå‘Šè¯‰ä½ ä»€ä¹ˆæ—¶å€™çš„æ•°æ®ï¼‰
- **æ•°å€¼** - `45.2`ï¼ˆå…·ä½“çš„æµ‹é‡å€¼ï¼‰

---

## 2. ğŸ”§ åŸºç¡€è¯­æ³•ç»“æ„


### 2.1 PromQLæŸ¥è¯¢çš„åŸºæœ¬å½¢å¼


**æœ€ç®€å•çš„æŸ¥è¯¢** - ç›´æ¥å†™æŒ‡æ ‡åï¼š
```promql
# æŸ¥è¯¢CPUä½¿ç”¨ç‡
cpu_usage_percent

# æŸ¥è¯¢HTTPè¯·æ±‚æ€»æ•°
http_requests_total
```

**ğŸ’¡ ç†è§£è¦ç‚¹**ï¼šè¿™å°±åƒé—®"ç»™æˆ‘çœ‹çœ‹CPUä½¿ç”¨ç‡"ï¼ŒPrometheusä¼šè¿”å›æ‰€æœ‰ç›¸å…³çš„æ•°æ®ç‚¹ã€‚

### 2.2 æŸ¥è¯¢ç»“æœçš„æ•°æ®ç±»å‹


PromQLæœ‰å››ç§æ•°æ®ç±»å‹ï¼Œä½†æ–°æ‰‹ä¸»è¦éœ€è¦äº†è§£å‰ä¸¤ç§ï¼š

| ç±»å‹ | è¯´æ˜ | ä¸¾ä¾‹ |
|------|------|------|
| **ç¬æ—¶å‘é‡** | æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ® | `cpu_usage{instance="web-01"}` |
| **åŒºé—´å‘é‡** | ä¸€æ®µæ—¶é—´å†…çš„æ•°æ® | `cpu_usage[5m]` |
| **æ ‡é‡** | å•ä¸ªæ•°å€¼ | `100` |
| **å­—ç¬¦ä¸²** | æ–‡æœ¬å€¼ | `"hello"` |

### 2.3 åŸºæœ¬è¯­æ³•è§„åˆ™


**ğŸ”¸ æŒ‡æ ‡å‘½åè§„èŒƒ**ï¼š
```promql
# æ­£ç¡®çš„æŒ‡æ ‡åï¼ˆå°å†™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰
http_requests_total
node_cpu_seconds_total
disk_usage_bytes

# é”™è¯¯ç¤ºä¾‹ï¼ˆåŒ…å«å¤§å†™å­—æ¯æˆ–ç‰¹æ®Šç¬¦å·ï¼‰
HTTP-Requests-Total  âŒ
node.cpu.usage       âŒ
```

**ğŸ”¸ æ ‡ç­¾è¯­æ³•**ï¼š
```promql
# åŸºæœ¬æ ¼å¼ï¼šæŒ‡æ ‡å{æ ‡ç­¾å="æ ‡ç­¾å€¼"}
http_requests_total{method="GET"}
cpu_usage{instance="web-01", cpu="0"}
```

---

## 3. ğŸ¯ æŒ‡æ ‡é€‰æ‹©å™¨å’Œè¿‡æ»¤å™¨


### 3.1 æ ‡ç­¾åŒ¹é…å™¨


**æ ‡ç­¾åŒ¹é…å™¨å°±æ˜¯è¿‡æ»¤æ¡ä»¶**ï¼Œå¸®ä½ ä»æµ·é‡æ•°æ®ä¸­æ‰¾åˆ°æƒ³è¦çš„æŒ‡æ ‡ã€‚

**ğŸ”¸ ç²¾ç¡®åŒ¹é…** - ä½¿ç”¨ `=`ï¼š
```promql
# åªæŸ¥çœ‹web-01æœåŠ¡å™¨çš„CPUä½¿ç”¨ç‡
cpu_usage{instance="web-01"}

# åªæŸ¥çœ‹GETè¯·æ±‚
http_requests_total{method="GET"}

# å¤šä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³
http_requests_total{method="GET", status="200"}
```

**ğŸ”¸ ä¸ç­‰åŒ¹é…** - ä½¿ç”¨ `!=`ï¼š
```promql
# æ’é™¤é”™è¯¯çŠ¶æ€çš„è¯·æ±‚
http_requests_total{status!="500"}

# æ’é™¤ç‰¹å®šå®ä¾‹
cpu_usage{instance!="test-server"}
```

### 3.2 æ¨¡ç³ŠåŒ¹é…


**ğŸ”¸ æ­£åˆ™åŒ¹é…** - ä½¿ç”¨ `=~`ï¼š
```promql
# åŒ¹é…æ‰€æœ‰webå¼€å¤´çš„æœåŠ¡å™¨
cpu_usage{instance=~"web-.*"}

# åŒ¹é…å¤šç§HTTPæ–¹æ³•
http_requests_total{method=~"GET|POST"}

# åŒ¹é…æ‰€æœ‰5xxé”™è¯¯çŠ¶æ€ç 
http_requests_total{status=~"5.."}
```

**ğŸ”¸ æ­£åˆ™æ’é™¤** - ä½¿ç”¨ `!~`ï¼š
```promql
# æ’é™¤testç¯å¢ƒçš„æœåŠ¡å™¨
cpu_usage{instance!~".*test.*"}

# æ’é™¤å†…éƒ¨APIè°ƒç”¨
http_requests_total{path!~"/internal/.*"}
```

### 3.3 å®ç”¨åŒ¹é…ç¤ºä¾‹


```promql
# ğŸ“Š æŸ¥çœ‹ç”Ÿäº§ç¯å¢ƒæ‰€æœ‰webæœåŠ¡å™¨çš„CPUä½¿ç”¨ç‡
cpu_usage{env="prod", instance=~"web-[0-9]+"}

# ğŸ” æŸ¥çœ‹æ‰€æœ‰æˆåŠŸçš„APIè¯·æ±‚ï¼ˆ2xxçŠ¶æ€ç ï¼‰
api_requests_total{status=~"2.."}

# âš ï¸ æŸ¥çœ‹æ‰€æœ‰é”™è¯¯è¯·æ±‚ï¼ˆ4xxå’Œ5xxï¼‰
http_requests_total{status=~"[45].."}

# ğŸ–¥ï¸ æŸ¥çœ‹é™¤äº†ç›‘æ§ç³»ç»Ÿå¤–çš„æ‰€æœ‰æœåŠ¡å™¨å†…å­˜ä½¿ç”¨
memory_usage{job!="prometheus", job!="grafana"}
```

---

## 4. â° æ—¶é—´èŒƒå›´æŸ¥è¯¢


### 4.1 ç¬æ—¶æŸ¥è¯¢ vs èŒƒå›´æŸ¥è¯¢


**ç¬æ—¶æŸ¥è¯¢** - æŸ¥çœ‹æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®ï¼š
```promql
# æŸ¥çœ‹å½“å‰CPUä½¿ç”¨ç‡
cpu_usage

# æŸ¥çœ‹å½“å‰å†…å­˜ä½¿ç”¨é‡  
memory_usage_bytes
```

**èŒƒå›´æŸ¥è¯¢** - æŸ¥çœ‹ä¸€æ®µæ—¶é—´å†…çš„æ•°æ®ï¼š
```promql
# æŸ¥çœ‹è¿‡å»5åˆ†é’Ÿçš„CPUä½¿ç”¨ç‡å˜åŒ–
cpu_usage[5m]

# æŸ¥çœ‹è¿‡å»1å°æ—¶çš„HTTPè¯·æ±‚é‡
http_requests_total[1h]
```

### 4.2 æ—¶é—´å•ä½è¯´æ˜


| å•ä½ | å«ä¹‰ | ç¤ºä¾‹ |
|------|------|------|
| `s` | ç§’ | `[30s]` - è¿‡å»30ç§’ |
| `m` | åˆ†é’Ÿ | `[5m]` - è¿‡å»5åˆ†é’Ÿ |
| `h` | å°æ—¶ | `[2h]` - è¿‡å»2å°æ—¶ |
| `d` | å¤© | `[7d]` - è¿‡å»7å¤© |
| `w` | å‘¨ | `[2w]` - è¿‡å»2å‘¨ |
| `y` | å¹´ | `[1y]` - è¿‡å»1å¹´ |

### 4.3 æ—¶é—´åç§»æŸ¥è¯¢


**æŸ¥çœ‹å†å²æ•°æ®** - ä½¿ç”¨ `offset`ï¼š
```promql
# æŸ¥çœ‹1å°æ—¶å‰çš„CPUä½¿ç”¨ç‡
cpu_usage offset 1h

# å¯¹æ¯”ç°åœ¨å’Œæ˜¨å¤©åŒä¸€æ—¶é—´çš„è®¿é—®é‡
http_requests_total - http_requests_total offset 1d

# æŸ¥çœ‹ä¸€å‘¨å‰çš„ç³»ç»Ÿè´Ÿè½½
load_average offset 7d
```

### 4.4 å®ç”¨æ—¶é—´æŸ¥è¯¢åœºæ™¯


```promql
# ğŸ“ˆ æŸ¥çœ‹è¿‡å»24å°æ—¶çš„ç£ç›˜IOè¶‹åŠ¿
disk_io_bytes[24h]

# ğŸ”„ å¯¹æ¯”æœ¬å‘¨å’Œä¸Šå‘¨åŒæœŸçš„è®¿é—®é‡
rate(http_requests_total[5m]) / rate(http_requests_total[5m] offset 7d)

# â±ï¸ æŸ¥çœ‹è¿‡å»15åˆ†é’Ÿçš„å¹³å‡å“åº”æ—¶é—´
avg_over_time(response_time[15m])

# ğŸ“Š æŸ¥çœ‹æ˜¨å¤©è¿™ä¸ªæ—¶å€™çš„å†…å­˜ä½¿ç”¨æƒ…å†µ
memory_usage offset 1d
```

---

## 5. ğŸ“Š èšåˆæ“ä½œå‡½æ•°


### 5.1 åŸºç¡€èšåˆå‡½æ•°


èšåˆå‡½æ•°å¸®ä½ **æ±‡æ€»å¤šä¸ªæ•°æ®ç‚¹**ï¼Œå°±åƒExcelä¸­çš„SUMã€AVERAGEå‡½æ•°ã€‚

**ğŸ”¸ sum() - æ±‚å’Œ**ï¼š
```promql
# è®¡ç®—æ‰€æœ‰æœåŠ¡å™¨çš„æ€»CPUä½¿ç”¨é‡
sum(cpu_usage)

# è®¡ç®—æ¯ä¸ªåº”ç”¨çš„æ€»è¯·æ±‚æ•°
sum(http_requests_total) by (app)

# è®¡ç®—é›†ç¾¤æ€»å†…å­˜ä½¿ç”¨é‡
sum(memory_usage_bytes)
```

**ğŸ”¸ avg() - å¹³å‡å€¼**ï¼š
```promql
# è®¡ç®—æ‰€æœ‰æœåŠ¡å™¨çš„å¹³å‡CPUä½¿ç”¨ç‡
avg(cpu_usage)

# è®¡ç®—æ¯ä¸ªæœºæˆ¿çš„å¹³å‡è´Ÿè½½
avg(load_average) by (datacenter)

# è®¡ç®—å¹³å‡å“åº”æ—¶é—´
avg(response_time_seconds)
```

**ğŸ”¸ max()/min() - æœ€å¤§å€¼/æœ€å°å€¼**ï¼š
```promql
# æ‰¾å‡ºCPUä½¿ç”¨ç‡æœ€é«˜çš„æœåŠ¡å™¨
max(cpu_usage)

# æ‰¾å‡ºå†…å­˜ä½¿ç”¨æœ€å°‘çš„å®ä¾‹
min(memory_usage_bytes)

# æ‰¾å‡ºå“åº”æ—¶é—´æœ€é•¿çš„æ¥å£
max(api_response_time) by (endpoint)
```

### 5.2 åˆ†ç»„èšåˆ


**ä½¿ç”¨ `by` å…³é”®å­—**è¿›è¡Œåˆ†ç»„ï¼Œç±»ä¼¼SQLçš„GROUP BYï¼š

```promql
# æŒ‰å®ä¾‹åˆ†ç»„æ±‚å’Œï¼ˆæ¯å°æœåŠ¡å™¨åˆ†åˆ«ç»Ÿè®¡ï¼‰
sum(http_requests_total) by (instance)

# æŒ‰çŠ¶æ€ç åˆ†ç»„ç»Ÿè®¡è¯·æ±‚æ•°
sum(http_requests_total) by (status)

# æŒ‰åº”ç”¨å’Œç¯å¢ƒåˆ†ç»„ç»Ÿè®¡
sum(memory_usage) by (app, env)
```

**ä½¿ç”¨ `without` å…³é”®å­—**æ’é™¤æŸäº›æ ‡ç­¾ï¼š
```promql
# ç»Ÿè®¡æ—¶å¿½ç•¥CPUæ ¸å¿ƒç¼–å·ï¼ŒåªæŒ‰æœåŠ¡å™¨èšåˆ
sum(cpu_usage) without (cpu)

# å¿½ç•¥å…·ä½“çš„podåç§°ï¼ŒæŒ‰æœåŠ¡èšåˆ
avg(memory_usage) without (pod)
```

### 5.3 å®ç”¨èšåˆç¤ºä¾‹


| ä½¿ç”¨åœºæ™¯ | PromQLæŸ¥è¯¢ | è¯´æ˜ |
|----------|------------|------|
| **é›†ç¾¤æ€»è´Ÿè½½** | `sum(cpu_usage)` | æ‰€æœ‰æœåŠ¡å™¨CPUä½¿ç”¨æ€»å’Œ |
| **å¹³å‡å“åº”æ—¶é—´** | `avg(response_time) by (service)` | æ¯ä¸ªæœåŠ¡çš„å¹³å‡å“åº”æ—¶é—´ |
| **æœ€ç¹å¿™æœåŠ¡å™¨** | `topk(5, cpu_usage)` | CPUä½¿ç”¨ç‡æœ€é«˜çš„5å°æœåŠ¡å™¨ |
| **æ•…éšœæœåŠ¡ç»Ÿè®¡** | `count(up == 0)` | ç»Ÿè®¡å®•æœºçš„æœåŠ¡æ•°é‡ |

---

## 6. ğŸ”¢ æ•°å­¦è¿ç®—å’Œæ¯”è¾ƒæ“ä½œ


### 6.1 åŸºç¡€æ•°å­¦è¿ç®—


**å››åˆ™è¿ç®—**ï¼š
```promql
# è®¡ç®—å†…å­˜ä½¿ç”¨ç‡ç™¾åˆ†æ¯”
memory_used_bytes / memory_total_bytes * 100

# è®¡ç®—ç£ç›˜å‰©ä½™ç©ºé—´
disk_total_bytes - disk_used_bytes  

# è®¡ç®—å¹³å‡æ¯ç§’è¯·æ±‚æ•°
http_requests_total / 60

# è®¡ç®—CPUè´Ÿè½½å€æ•°
load_average * 2
```

**ğŸ’¡ å®é™…åº”ç”¨**ï¼š
```promql
# ğŸ”‹ è®¡ç®—ç”µæ± å‰©ä½™ç”µé‡ç™¾åˆ†æ¯”
(battery_capacity_remaining / battery_capacity_total) * 100

# ğŸ“ˆ è®¡ç®—ååé‡å¢é•¿ç‡
(rate(requests[5m]) - rate(requests[5m] offset 1h)) / rate(requests[5m] offset 1h) * 100
```

### 6.2 æ¯”è¾ƒæ“ä½œç¬¦


| æ“ä½œç¬¦ | å«ä¹‰ | ç¤ºä¾‹ |
|--------|------|------|
| `==` | ç­‰äº | `cpu_usage == 50` |
| `!=` | ä¸ç­‰äº | `status != 200` |
| `>` | å¤§äº | `memory_usage > 80` |
| `<` | å°äº | `disk_free < 1000000000` |
| `>=` | å¤§äºç­‰äº | `response_time >= 1.0` |
| `<=` | å°äºç­‰äº | `error_rate <= 0.01` |

### 6.3 å®ç”¨æ¯”è¾ƒæŸ¥è¯¢


**ğŸš¨ å‘Šè­¦åœºæ™¯æŸ¥è¯¢**ï¼š
```promql
# CPUä½¿ç”¨ç‡è¶…è¿‡80%çš„æœåŠ¡å™¨
cpu_usage > 80

# å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡90%çš„å®ä¾‹
(memory_used / memory_total) * 100 > 90

# ç£ç›˜å‰©ä½™ç©ºé—´å°äº10GB
disk_free_bytes < 10 * 1024 * 1024 * 1024

# 5åˆ†é’Ÿå†…å¹³å‡å“åº”æ—¶é—´è¶…è¿‡2ç§’
avg_over_time(response_time[5m]) > 2
```

**ğŸ“Š æ¡ä»¶ç­›é€‰**ï¼š
```promql
# åªæ˜¾ç¤ºæ­£å¸¸è¿è¡Œçš„æœåŠ¡ï¼ˆup=1ï¼‰
cpu_usage and (up == 1)

# æ’é™¤é”™è¯¯çŠ¶æ€çš„æŒ‡æ ‡
http_requests_total and (status != "500")

# åªç»Ÿè®¡é«˜è´Ÿè½½æœåŠ¡å™¨çš„å†…å­˜ä½¿ç”¨
memory_usage and (cpu_usage > 50)
```

---

## 7. ğŸ·ï¸ æ ‡ç­¾åŒ¹é…å’Œæ­£åˆ™è¡¨è¾¾å¼


### 7.1 é«˜çº§æ ‡ç­¾åŒ¹é…æŠ€å·§


**ğŸ”¸ å¤šå€¼åŒ¹é…**ï¼š
```promql
# åŒ¹é…å¤šä¸ªå…·ä½“å€¼
http_requests{method=~"GET|POST|PUT"}

# åŒ¹é…å¤šä¸ªçŠ¶æ€ç 
http_requests{status=~"200|201|202"}

# åŒ¹é…å¤šä¸ªç¯å¢ƒ
cpu_usage{env=~"prod|staging"}
```

**ğŸ”¸ æ¨¡å¼åŒ¹é…**ï¼š
```promql
# åŒ¹é…æ‰€æœ‰webæœåŠ¡å™¨ï¼ˆweb-01, web-02, web-10ç­‰ï¼‰
memory_usage{instance=~"web-[0-9]+"}

# åŒ¹é…æ‰€æœ‰APIè·¯å¾„
http_requests{path=~"/api/v[0-9]+/.*"}

# åŒ¹é…æ•°æ®åº“ç›¸å…³çš„æœåŠ¡
cpu_usage{job=~".*db.*"}
```

### 7.2 å¸¸ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼


| æ¨¡å¼ | å«ä¹‰ | ç¤ºä¾‹ |
|------|------|------|
| `.` | ä»»æ„å•ä¸ªå­—ç¬¦ | `web.01` åŒ¹é… web-01, web_01 |
| `*` | å‰é¢å­—ç¬¦0æ¬¡æˆ–å¤šæ¬¡ | `web-.*` åŒ¹é… web-, web-01, web-server |
| `+` | å‰é¢å­—ç¬¦1æ¬¡æˆ–å¤šæ¬¡ | `web-[0-9]+` åŒ¹é… web-1, web-01, web-123 |
| `[0-9]` | ä»»æ„æ•°å­— | `server-[0-9]` åŒ¹é… server-1, server-5 |
| `[a-z]` | ä»»æ„å°å†™å­—æ¯ | `env-[a-z]+` åŒ¹é… env-prod, env-test |
| `^` | å¼€å§‹ä½ç½® | `^web` ä»¥webå¼€å¤´ |
| `$` | ç»“æŸä½ç½® | `prod$` ä»¥prodç»“å°¾ |

### 7.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ“ ç¯å¢ƒåˆ†ç±»**ï¼š
```promql
# ç”Ÿäº§ç¯å¢ƒæ‰€æœ‰æœåŠ¡
cpu_usage{env="prod"}

# æµ‹è¯•å’Œå¼€å‘ç¯å¢ƒ
memory_usage{env=~"test|dev"}

# æ’é™¤æœ¬åœ°å¼€å‘ç¯å¢ƒ
http_requests{env!~"local|localhost"}
```

**ğŸ–¥ï¸ æœåŠ¡å™¨åˆ†ç»„**ï¼š
```promql
# æ‰€æœ‰webæœåŠ¡å™¨
load_average{role="web"}

# æ•°æ®åº“æœåŠ¡å™¨
disk_usage{role=~".*db.*"}

# ç‰¹å®šæœºæˆ¿çš„æœåŠ¡å™¨
cpu_usage{datacenter="dc1"}
```

**ğŸ” è·¯å¾„è¿‡æ»¤**ï¼š
```promql
# APIè¯·æ±‚ç»Ÿè®¡
http_requests{path=~"/api/.*"}

# é™æ€èµ„æºè¯·æ±‚
http_requests{path=~".*\\.(css|js|png|jpg)$"}

# ç®¡ç†å‘˜æ¥å£è®¿é—®
http_requests{path=~"/admin/.*"}
```

---

## 8. ğŸ“ˆ æ—¶é—´çª—å£å‡½æ•°


### 8.1 é€Ÿç‡è®¡ç®—å‡½æ•°


**ğŸ”¸ rate() - è®¡ç®—æ¯ç§’å¹³å‡å¢é•¿ç‡**ï¼š
```promql
# è®¡ç®—HTTPè¯·æ±‚çš„æ¯ç§’é€Ÿç‡
rate(http_requests_total[5m])

# è®¡ç®—ç½‘ç»œæµé‡é€Ÿç‡ï¼ˆå­—èŠ‚/ç§’ï¼‰
rate(network_bytes_total[1m])

# è®¡ç®—é”™è¯¯è¯·æ±‚çš„æ¯ç§’é€Ÿç‡
rate(http_errors_total[5m])
```

**ğŸ’¡ rate()å‡½æ•°ç†è§£**ï¼šæƒ³è±¡ä¸€ä¸ªè®¡æ•°å™¨ï¼Œrate()å‘Šè¯‰ä½ å¹³å‡æ¯ç§’å¢åŠ å¤šå°‘ã€‚

**ğŸ”¸ irate() - è®¡ç®—ç¬æ—¶å¢é•¿ç‡**ï¼š
```promql
# è®¡ç®—ç¬æ—¶è¯·æ±‚é€Ÿç‡ï¼ˆæ›´æ•æ„Ÿï¼‰
irate(http_requests_total[5m])

# è®¡ç®—ç¬æ—¶CPUä½¿ç”¨å˜åŒ–ç‡
irate(cpu_seconds_total[2m])
```

**ğŸ“Š rate() vs irate() å¯¹æ¯”**ï¼š

| å‡½æ•° | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `rate()` | å¹³æ»‘ï¼Œä¸æ˜“æ³¢åŠ¨ | å‘Šè­¦è§„åˆ™ã€è¶‹åŠ¿åˆ†æ |
| `irate()` | æ•æ„Ÿï¼Œå®æ—¶åæ˜  | å®æ—¶ç›‘æ§ã€ç¬æ—¶çŠ¶æ€ |

### 8.2 æ—¶é—´çª—å£èšåˆå‡½æ•°


**ğŸ”¸ avg_over_time() - æ—¶é—´çª—å£å†…å¹³å‡å€¼**ï¼š
```promql
# è¿‡å»10åˆ†é’Ÿçš„å¹³å‡CPUä½¿ç”¨ç‡
avg_over_time(cpu_usage[10m])

# è¿‡å»1å°æ—¶çš„å¹³å‡å“åº”æ—¶é—´
avg_over_time(response_time[1h])
```

**ğŸ”¸ max_over_time() - æ—¶é—´çª—å£å†…æœ€å¤§å€¼**ï¼š
```promql
# è¿‡å»5åˆ†é’Ÿå†…çš„æœ€å¤§å†…å­˜ä½¿ç”¨é‡
max_over_time(memory_usage[5m])

# è¿‡å»1å°æ—¶å†…çš„æœ€é«˜è´Ÿè½½
max_over_time(load_average[1h])
```

**ğŸ”¸ min_over_time() - æ—¶é—´çª—å£å†…æœ€å°å€¼**ï¼š
```promql
# è¿‡å»15åˆ†é’Ÿå†…çš„æœ€ä½ç£ç›˜å¯ç”¨ç©ºé—´
min_over_time(disk_available[15m])
```

### 8.3 å®ç”¨æ—¶é—´çª—å£æŸ¥è¯¢


**âš¡ æ€§èƒ½ç›‘æ§**ï¼š
```promql
# è¿‡å»5åˆ†é’Ÿå¹³å‡QPS
rate(http_requests_total[5m])

# è¿‡å»10åˆ†é’Ÿæœ€é«˜å“åº”æ—¶é—´
max_over_time(response_time_seconds[10m])

# è¿‡å»1å°æ—¶CPUä½¿ç”¨ç‡è¶‹åŠ¿
avg_over_time(cpu_usage_percent[1h])
```

**ğŸ“Š å®¹é‡è§„åˆ’**ï¼š
```promql
# è¿‡å»24å°æ—¶æœ€é«˜å†…å­˜ä½¿ç”¨
max_over_time(memory_usage_bytes[24h])

# è¿‡å»7å¤©ç£ç›˜å¢é•¿è¶‹åŠ¿
increase(disk_used_bytes[7d])

# è¿‡å»1ä¸ªæœˆå¹³å‡è´Ÿè½½
avg_over_time(load_average[30d])
```

---

## 9. ğŸ—ï¸ å¤æ‚æŸ¥è¯¢è¯­å¥æ„å»º


### 9.1 å¤šå±‚åµŒå¥—æŸ¥è¯¢


**ğŸ”¸ ç»„åˆå‡½æ•°ä½¿ç”¨**ï¼š
```promql
# è®¡ç®—å„æœåŠ¡å™¨CPUä½¿ç”¨ç‡æ’åå‰3
topk(3, avg(cpu_usage) by (instance))

# è®¡ç®—è¿‡å»1å°æ—¶å†…å“åº”æ—¶é—´çš„95%åˆ†ä½æ•°
histogram_quantile(0.95, rate(http_request_duration_bucket[1h]))

# è®¡ç®—å„åº”ç”¨é”™è¯¯ç‡ç™¾åˆ†æ¯”
(rate(http_errors_total[5m]) / rate(http_requests_total[5m])) * 100
```

**ğŸ’¡ ç†è§£å¤æ‚æŸ¥è¯¢**ï¼šæŠŠå¤æ‚æŸ¥è¯¢æ‹†è§£æˆå°æ­¥éª¤ï¼Œä¸€æ­¥æ­¥ç†è§£æ¯ä¸ªéƒ¨åˆ†çš„ä½œç”¨ã€‚

### 9.2 æ¡ä»¶æŸ¥è¯¢å’Œé€»è¾‘è¿ç®—


**ğŸ”¸ é€»è¾‘ANDæ“ä½œ**ï¼š
```promql
# CPUé«˜ä¸”å†…å­˜ä¹Ÿé«˜çš„æœåŠ¡å™¨
cpu_usage > 80 and memory_usage > 80

# æ­£å¸¸æœåŠ¡ä¸­å“åº”æ—¶é—´è¾ƒé•¿çš„
response_time > 2 and up == 1
```

**ğŸ”¸ é€»è¾‘ORæ“ä½œ**ï¼š
```promql
# CPUé«˜æˆ–å†…å­˜é«˜çš„æœåŠ¡å™¨
cpu_usage > 80 or memory_usage > 90

# 4xxæˆ–5xxé”™è¯¯çŠ¶æ€
http_requests{status=~"4..|5.."}
```

**ğŸ”¸ æ¡ä»¶é€‰æ‹©**ï¼š
```promql
# æ ¹æ®ç¯å¢ƒä½¿ç”¨ä¸åŒé˜ˆå€¼
(cpu_usage > 90 and env="prod") or (cpu_usage > 95 and env="test")
```

### 9.3 ä¸šåŠ¡ç›‘æ§æŸ¥è¯¢æ¨¡æ¿


**ğŸ“Š åº”ç”¨æ€§èƒ½ç›‘æ§ï¼ˆAPMï¼‰**ï¼š
```promql
# QPSç›‘æ§
sum(rate(http_requests_total[5m])) by (service)

# é”™è¯¯ç‡ç›‘æ§
sum(rate(http_errors_total[5m])) by (service) / sum(rate(http_requests_total[5m])) by (service) * 100

# å¹³å‡å“åº”æ—¶é—´
avg(rate(http_request_duration_sum[5m]) / rate(http_request_duration_count[5m])) by (service)

# P99å“åº”æ—¶é—´
histogram_quantile(0.99, sum(rate(http_request_duration_bucket[5m])) by (le, service))
```

**ğŸ–¥ï¸ åŸºç¡€è®¾æ–½ç›‘æ§**ï¼š
```promql
# æœåŠ¡å™¨èµ„æºä½¿ç”¨æ¦‚è§ˆ
sum(cpu_usage) by (instance), 
sum(memory_usage) by (instance), 
sum(disk_usage) by (instance)

# ç½‘ç»œæµé‡ç›‘æ§
sum(rate(network_receive_bytes[5m])) by (instance),
sum(rate(network_transmit_bytes[5m])) by (instance)
```

### 9.4 å‘Šè­¦è§„åˆ™æŸ¥è¯¢


**âš ï¸ å…³é”®å‘Šè­¦æŸ¥è¯¢**ï¼š
```promql
# æœåŠ¡å®•æœºå‘Šè­¦
up == 0

# é«˜CPUä½¿ç”¨ç‡å‘Šè­¦ï¼ˆæŒç»­5åˆ†é’Ÿï¼‰
avg_over_time(cpu_usage[5m]) > 85

# ç£ç›˜ç©ºé—´ä¸è¶³å‘Šè­¦
(disk_free_bytes / disk_total_bytes) * 100 < 10

# é”™è¯¯ç‡è¿‡é«˜å‘Šè­¦
(rate(http_errors_total[5m]) / rate(http_requests_total[5m])) > 0.05
```

**ğŸ“ˆ é¢„æµ‹æ€§å‘Šè­¦**ï¼š
```promql
# é¢„æµ‹4å°æ—¶åç£ç›˜å°†æ»¡
predict_linear(disk_free_bytes[1h], 4*3600) < 0

# å†…å­˜ä½¿ç”¨è¶‹åŠ¿å‘Šè­¦
deriv(memory_usage[30m]) > 1000000  # æ¯åˆ†é’Ÿå¢é•¿è¶…è¿‡1MB
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„åŸºç¡€æ¦‚å¿µ


```
ğŸ”¸ PromQLæœ¬è´¨ï¼šä¸“é—¨æŸ¥è¯¢æ—¶é—´åºåˆ—æ•°æ®çš„è¯­è¨€
ğŸ”¸ æ•°æ®ç±»å‹ï¼šç¬æ—¶å‘é‡ã€åŒºé—´å‘é‡ã€æ ‡é‡ã€å­—ç¬¦ä¸²
ğŸ”¸ åŸºç¡€è¯­æ³•ï¼šæŒ‡æ ‡å{æ ‡ç­¾åŒ¹é…å™¨}[æ—¶é—´èŒƒå›´]
ğŸ”¸ èšåˆå‡½æ•°ï¼šsumã€avgã€maxã€minç”¨äºæ•°æ®æ±‡æ€»
ğŸ”¸ æ—¶é—´å‡½æ•°ï¼šrateã€avg_over_timeå¤„ç†æ—¶åºæ•°æ®
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æŸ¥è¯¢æ„å»ºæ€è·¯**ï¼š
```
ç¬¬1æ­¥ï¼šç¡®å®šè¦æŸ¥ä»€ä¹ˆæŒ‡æ ‡ï¼ˆæŒ‡æ ‡åï¼‰
ç¬¬2æ­¥ï¼šç¡®å®šæŸ¥å“ªäº›å®ä¾‹ï¼ˆæ ‡ç­¾è¿‡æ»¤ï¼‰  
ç¬¬3æ­¥ï¼šç¡®å®šæŸ¥ä»€ä¹ˆæ—¶é—´ï¼ˆæ—¶é—´èŒƒå›´ï¼‰
ç¬¬4æ­¥ï¼šç¡®å®šå¦‚ä½•æ±‡æ€»ï¼ˆèšåˆå‡½æ•°ï¼‰
```

**ğŸ”¹ å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼**ï¼š
```
å®æ—¶çŠ¶æ€ï¼šç›´æ¥æŸ¥æŒ‡æ ‡å
å†å²è¶‹åŠ¿ï¼šä½¿ç”¨æ—¶é—´èŒƒå›´[5m]
é€Ÿç‡è®¡ç®—ï¼šrate(æŒ‡æ ‡[æ—¶é—´])
åˆ†ç»„ç»Ÿè®¡ï¼šsum() by (æ ‡ç­¾)
æ¡ä»¶è¿‡æ»¤ï¼šæŒ‡æ ‡ > é˜ˆå€¼
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
```
âœ… ä½¿ç”¨å…·ä½“çš„æ ‡ç­¾è¿‡æ»¤ï¼Œé¿å…å…¨é‡æŸ¥è¯¢
âœ… é€‰æ‹©åˆé€‚çš„æ—¶é—´çª—å£ï¼Œä¸å®œè¿‡é•¿
âœ… å…ˆè¿‡æ»¤å†èšåˆï¼Œå‡å°‘è®¡ç®—é‡
âœ… ä½¿ç”¨rate()è€Œä¸æ˜¯ç›´æ¥æŸ¥counterç±»å‹æŒ‡æ ‡
```

### 10.3 å®é™…åº”ç”¨åœºæ™¯æ˜ å°„


| ç›‘æ§éœ€æ±‚ | PromQLæŸ¥è¯¢æ€è·¯ | å…³é”®å‡½æ•° |
|----------|----------------|----------|
| **å®æ—¶çŠ¶æ€** | ç›´æ¥æŸ¥æŒ‡æ ‡å½“å‰å€¼ | æ— éœ€å‡½æ•° |
| **è¶‹åŠ¿åˆ†æ** | ä½¿ç”¨æ—¶é—´èŒƒå›´æŸ¥è¯¢ | `[5m]`, `avg_over_time()` |
| **å‘Šè­¦è§„åˆ™** | è®¾ç½®é˜ˆå€¼æ¯”è¾ƒ | `>`, `<`, `and`, `or` |
| **å®¹é‡è§„åˆ’** | æŸ¥å†å²æœ€å¤§å€¼ | `max_over_time()`, `increase()` |
| **æ€§èƒ½ä¼˜åŒ–** | è®¡ç®—é€Ÿç‡å’Œåˆ†ä½æ•° | `rate()`, `histogram_quantile()` |

### 10.4 å­¦ä¹ è¿›é˜¶è·¯å¾„


**ğŸ¯ æ–°æ‰‹é˜¶æ®µï¼ˆæŒæ¡æ ¸å¿ƒï¼‰**ï¼š
- åŸºç¡€è¯­æ³•ï¼šæŒ‡æ ‡åå’Œæ ‡ç­¾åŒ¹é…
- æ—¶é—´èŒƒå›´ï¼š[5m]ã€[1h]ç­‰
- åŸºç¡€èšåˆï¼šsumã€avgã€maxã€min
- ç®€å•æ¯”è¾ƒï¼š>ã€<ã€==

**ğŸš€ è¿›é˜¶é˜¶æ®µï¼ˆçµæ´»è¿ç”¨ï¼‰**ï¼š
- æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
- rate()å’Œæ—¶é—´çª—å£å‡½æ•°
- å¤æ‚èšåˆå’Œåˆ†ç»„
- é€»è¾‘è¿ç®—ç»„åˆ

**ğŸ† é«˜çº§é˜¶æ®µï¼ˆä¸šåŠ¡åº”ç”¨ï¼‰**ï¼š
- å¤æ‚åµŒå¥—æŸ¥è¯¢
- é¢„æµ‹å’Œè¶‹åŠ¿åˆ†æ  
- è‡ªå®šä¹‰å‘Šè­¦è§„åˆ™
- æ€§èƒ½è°ƒä¼˜æŸ¥è¯¢

### 10.5 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ


**â“ å¸¸è§é”™è¯¯åŠè§£å†³**ï¼š
```
é—®é¢˜1ï¼šæŸ¥è¯¢æ— ç»“æœ
è§£å†³ï¼šæ£€æŸ¥æŒ‡æ ‡åæ˜¯å¦æ­£ç¡®ï¼Œæ ‡ç­¾åŒ¹é…æ˜¯å¦è¿‡ä¸¥æ ¼

é—®é¢˜2ï¼šæŸ¥è¯¢æ€§èƒ½æ…¢  
è§£å†³ï¼šæ·»åŠ æ ‡ç­¾è¿‡æ»¤ï¼Œç¼©çŸ­æ—¶é—´èŒƒå›´ï¼Œä¼˜åŒ–èšåˆé¡ºåº

é—®é¢˜3ï¼šæ•°æ®ä¸å‡†ç¡®
è§£å†³ï¼šç¡®è®¤ä½¿ç”¨rate()å¤„ç†counterç±»å‹ï¼Œé€‰æ‹©åˆé€‚æ—¶é—´çª—å£

é—®é¢˜4ï¼šå‘Šè­¦é¢‘ç¹è¯¯æŠ¥
è§£å†³ï¼šä½¿ç”¨avg_over_time()å¹³æ»‘æ•°æ®ï¼Œè°ƒæ•´é˜ˆå€¼å’Œæ—¶é—´çª—å£
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- PromQLæ˜¯æŸ¥è¯¢æ—¶é—´åºåˆ—æ•°æ®çš„ä¸“ç”¨è¯­è¨€
- åŸºç¡€è¯­æ³•ï¼š`æŒ‡æ ‡å{æ ‡ç­¾è¿‡æ»¤}[æ—¶é—´èŒƒå›´]`
- èšåˆå‡½æ•°å¸®ä½ æ±‡æ€»åˆ†æå¤šç»´æ•°æ®
- rate()å‡½æ•°æ˜¯å¤„ç†è®¡æ•°å™¨ç±»å‹æŒ‡æ ‡çš„å…³é”®
- å…ˆè¿‡æ»¤å†èšåˆï¼Œæ„å»ºé«˜æ•ˆæŸ¥è¯¢è¯­å¥