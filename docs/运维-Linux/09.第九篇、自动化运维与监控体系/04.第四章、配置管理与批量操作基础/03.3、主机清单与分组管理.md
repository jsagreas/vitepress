---
title: 3ã€ä¸»æœºæ¸…å•ä¸åˆ†ç»„ç®¡ç†
---
## ğŸ“š ç›®å½•


1. [é™æ€ä¸»æœºæ¸…å•æ–‡ä»¶æ ¼å¼](#1-é™æ€ä¸»æœºæ¸…å•æ–‡ä»¶æ ¼å¼)
2. [åŠ¨æ€ä¸»æœºæ¸…å•ç”Ÿæˆ](#2-åŠ¨æ€ä¸»æœºæ¸…å•ç”Ÿæˆ)
3. [ä¸»æœºåˆ†ç»„ç­–ç•¥è®¾è®¡](#3-ä¸»æœºåˆ†ç»„ç­–ç•¥è®¾è®¡)
4. [ä¸»æœºå˜é‡å®šä¹‰ç®¡ç†](#4-ä¸»æœºå˜é‡å®šä¹‰ç®¡ç†)
5. [ç»„å˜é‡ç»§æ‰¿æœºåˆ¶](#5-ç»„å˜é‡ç»§æ‰¿æœºåˆ¶)
6. [ä¸»æœºæ¨¡å¼åŒ¹é…è¯­æ³•](#6-ä¸»æœºæ¨¡å¼åŒ¹é…è¯­æ³•)
7. [æ¸…å•æ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶](#7-æ¸…å•æ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶)
8. [å¤§è§„æ¨¡ä¸»æœºç®¡ç†ç­–ç•¥](#8-å¤§è§„æ¨¡ä¸»æœºç®¡ç†ç­–ç•¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“‹ é™æ€ä¸»æœºæ¸…å•æ–‡ä»¶æ ¼å¼



### 1.1 ä¸»æœºæ¸…å•åŸºæœ¬æ¦‚å¿µ



**ä»€ä¹ˆæ˜¯ä¸»æœºæ¸…å•ï¼Ÿ**
> ä¸»æœºæ¸…å•å°±åƒ"é€šè®¯å½•"ï¼Œè®°å½•äº†ä½ è¦ç®¡ç†çš„æ‰€æœ‰æœåŠ¡å™¨ä¿¡æ¯ã€‚å°±åƒä½ çš„æ‰‹æœºé€šè®¯å½•è®°å½•æœ‹å‹çš„ç”µè¯ä¸€æ ·ï¼ŒAnsibleçš„ä¸»æœºæ¸…å•è®°å½•æœåŠ¡å™¨çš„åœ°å€å’Œè¿æ¥æ–¹å¼ã€‚

```
ä¼ ç»Ÿæ‰‹å·¥ç®¡ç† vs æ¸…å•ç®¡ç†ï¼š

æ‰‹å·¥ç®¡ç†ï¼š
è®°ä½æ¯å°æœåŠ¡å™¨çš„IP â†’ é€ä¸ªSSHç™»å½• â†’ æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤
é—®é¢˜ï¼šå®¹æ˜“å‡ºé”™ï¼Œæ•ˆç‡ä½ï¼Œéš¾ä»¥æ‰¹é‡æ“ä½œ

æ¸…å•ç®¡ç†ï¼š
å®šä¹‰æœåŠ¡å™¨åˆ—è¡¨ â†’ ä¸€é”®æ‰¹é‡æ“ä½œ â†’ ç»Ÿä¸€é…ç½®ç®¡ç†
ä¼˜åŠ¿ï¼šè‡ªåŠ¨åŒ–ï¼Œæ ‡å‡†åŒ–ï¼Œå¯é‡å¤æ‰§è¡Œ
```

### 1.2 INIæ ¼å¼æ¸…å•æ–‡ä»¶



#### ğŸ”¸ åŸºç¡€INIæ ¼å¼è¯­æ³•



æœ€ç®€å•çš„ä¸»æœºæ¸…å•å°±æ˜¯æœåŠ¡å™¨åˆ—è¡¨ï¼š

```ini
# /etc/ansible/hosts - åŸºç¡€æ ¼å¼

192.168.1.10
192.168.1.11
192.168.1.12
web-server-1.example.com
db-server-1.example.com
```

è¿™å°±åƒå†™è´­ç‰©æ¸…å•ä¸€æ ·ç®€å•ï¼šä¸€è¡Œä¸€ä¸ªæœåŠ¡å™¨ã€‚

#### ğŸ”¸ å¸¦åˆ†ç»„çš„æ¸…å•æ ¼å¼



```ini
# æŒ‰åŠŸèƒ½åˆ†ç»„çš„ä¸»æœºæ¸…å•

[webservers]
web1.example.com
web2.example.com
192.168.1.10

[databases]
db1.example.com
db2.example.com

[loadbalancers]
lb.example.com ansible_host=192.168.1.100
```

**åˆ†ç»„çš„å®é™…æ„ä¹‰ï¼š**
- `webservers`ç»„ï¼šæ‰€æœ‰WebæœåŠ¡å™¨ï¼Œå¯ä»¥ç»Ÿä¸€éƒ¨ç½²Webåº”ç”¨
- `databases`ç»„ï¼šæ‰€æœ‰æ•°æ®åº“æœåŠ¡å™¨ï¼Œå¯ä»¥ç»Ÿä¸€é…ç½®æ•°æ®åº“
- `loadbalancers`ç»„ï¼šè´Ÿè½½å‡è¡¡å™¨ï¼Œå¯ä»¥ç»Ÿä¸€é…ç½®è´Ÿè½½ç­–ç•¥

#### ğŸ”¸ ä¸»æœºåˆ«åä¸è¿æ¥å‚æ•°



```ini
# ä½¿ç”¨ä¸»æœºåˆ«åå’Œè¿æ¥å‚æ•°

[production]
web1 ansible_host=192.168.1.10 ansible_user=admin ansible_port=2222
web2 ansible_host=192.168.1.11 ansible_user=root
db1 ansible_host=192.168.1.20 ansible_user=mysql ansible_ssh_private_key_file=/path/to/key

[development]  
dev-web ansible_host=10.0.0.10 ansible_user=developer
dev-db ansible_host=10.0.0.20 ansible_user=developer
```

**å¸¸ç”¨è¿æ¥å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | å«ä¹‰ | ç¤ºä¾‹ |
|------|------|------|
| `ansible_host` | **çœŸå®IPåœ°å€** | `192.168.1.10` |
| `ansible_user` | **SSHç”¨æˆ·å** | `root`, `admin` |  
| `ansible_port` | **SSHç«¯å£** | `22`, `2222` |
| `ansible_ssh_private_key_file` | **ç§é’¥æ–‡ä»¶è·¯å¾„** | `/home/user/.ssh/id_rsa` |
| `ansible_ssh_common_args` | **SSHé¢å¤–å‚æ•°** | `-o StrictHostKeyChecking=no` |

### 1.3 YAMLæ ¼å¼æ¸…å•æ–‡ä»¶



**ä¸ºä»€ä¹ˆä½¿ç”¨YAMLæ ¼å¼ï¼Ÿ**
> YAMLæ ¼å¼æ›´é€‚åˆå¤æ‚çš„é…ç½®ï¼Œå°±åƒä»"è®°äº‹æœ¬"å‡çº§åˆ°"Excelè¡¨æ ¼"ï¼Œèƒ½è¡¨è¾¾æ›´ä¸°å¯Œçš„ä¿¡æ¯ç»“æ„ã€‚

#### ğŸ”¸ åŸºç¡€YAMLæ ¼å¼



```yaml
# inventory.yml - YAMLæ ¼å¼æ¸…å•

all:
  children:
    webservers:
      hosts:
        web1.example.com:
        web2.example.com:
        web3.example.com:
    databases:
      hosts:
        db1.example.com:
          ansible_host: 192.168.1.20
          ansible_user: mysql
        db2.example.com:
          ansible_host: 192.168.1.21
          ansible_user: mysql
```

#### ğŸ”¸ å¸¦å˜é‡çš„YAMLæ ¼å¼



```yaml
# å®Œæ•´çš„YAMLæ¸…å•é…ç½®

all:
  vars:
#    # å…¨å±€å˜é‡
    ntp_server: ntp.example.com
    timezone: Asia/Shanghai
    
  children:
    webservers:
      vars:
#        # WebæœåŠ¡å™¨ç»„å˜é‡
        nginx_port: 80
        ssl_enabled: true
        
      hosts:
        web1:
          ansible_host: 192.168.1.10
          server_role: primary
        web2:
          ansible_host: 192.168.1.11  
          server_role: secondary
          
    databases:
      vars:
        mysql_port: 3306
        backup_enabled: true
        
      hosts:
        mysql-master:
          ansible_host: 192.168.1.20
          mysql_role: master
        mysql-slave:
          ansible_host: 192.168.1.21
          mysql_role: slave
```

### 1.4 æ¸…å•æ–‡ä»¶æœ€ä½³å®è·µ



**ğŸ¯ å‘½åè§„èŒƒå»ºè®®**

```
æ–‡ä»¶å‘½åï¼š
âœ… inventory.ini      - é€šç”¨æ¸…å•
âœ… production.yml     - ç”Ÿäº§ç¯å¢ƒ
âœ… staging.ini        - æµ‹è¯•ç¯å¢ƒ
âœ… development.yaml   - å¼€å‘ç¯å¢ƒ

ä¸»æœºå‘½åï¼š
âœ… web-01, web-02     - æŒ‰åŠŸèƒ½+åºå·
âœ… db-master, db-slave - æŒ‰è§’è‰²å‘½å
âœ… prod-web-1         - ç¯å¢ƒ+åŠŸèƒ½+åºå·

åˆ†ç»„å‘½åï¼š
âœ… webservers, databases  - åŠŸèƒ½åˆ†ç»„
âœ… production, staging    - ç¯å¢ƒåˆ†ç»„
âœ… beijing, shanghai      - åœ°åŸŸåˆ†ç»„
```

**ğŸ“ ç›®å½•ç»“æ„æ¨è**

```
inventory/
â”œâ”€â”€ production/
â”‚   â”œâ”€â”€ hosts.yml          # ç”Ÿäº§ç¯å¢ƒä¸»æœºæ¸…å•
â”‚   â”œâ”€â”€ group_vars/        # ç»„å˜é‡ç›®å½•
â”‚   â””â”€â”€ host_vars/         # ä¸»æœºå˜é‡ç›®å½•
â”œâ”€â”€ staging/
â”‚   â”œâ”€â”€ hosts.yml
â”‚   â”œâ”€â”€ group_vars/
â”‚   â””â”€â”€ host_vars/
â””â”€â”€ development/
    â”œâ”€â”€ hosts.yml
    â”œâ”€â”€ group_vars/
    â””â”€â”€ host_vars/
```

è¿™ç§ç»“æ„çš„å¥½å¤„ï¼š
- **ç¯å¢ƒéš”ç¦»**ï¼šç”Ÿäº§å’Œæµ‹è¯•ç¯å¢ƒå®Œå…¨åˆ†ç¦»
- **é…ç½®ç‹¬ç«‹**ï¼šæ¯ä¸ªç¯å¢ƒæœ‰è‡ªå·±çš„å˜é‡é…ç½®
- **æ˜“äºç»´æŠ¤**ï¼šç»“æ„æ¸…æ™°ï¼Œä¾¿äºå›¢é˜Ÿåä½œ

---

## 2. ğŸ”„ åŠ¨æ€ä¸»æœºæ¸…å•ç”Ÿæˆ



### 2.1 åŠ¨æ€æ¸…å•åŸºæœ¬æ¦‚å¿µ



**ä»€ä¹ˆæ˜¯åŠ¨æ€ä¸»æœºæ¸…å•ï¼Ÿ**
> é™æ€æ¸…å•åƒ"æ‰‹å†™é€šè®¯å½•"ï¼ŒåŠ¨æ€æ¸…å•åƒ"ä»å…¬å¸HRç³»ç»Ÿè‡ªåŠ¨å¯¼å…¥å‘˜å·¥é€šè®¯å½•"ã€‚å½“æœåŠ¡å™¨ç»å¸¸å˜åŒ–æ—¶ï¼ŒåŠ¨æ€æ¸…å•èƒ½è‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€æ‰‹å·¥ç»´æŠ¤ã€‚

```
é™æ€æ¸…å•çš„å±€é™æ€§ï¼š
â€¢ æœåŠ¡å™¨å¢åŠ /åˆ é™¤éœ€è¦æ‰‹åŠ¨ä¿®æ”¹æ–‡ä»¶
â€¢ å®¹å™¨ç¯å¢ƒä¸­IPåœ°å€ç»å¸¸å˜åŒ–  
â€¢ äº‘ç¯å¢ƒä¸­æœåŠ¡å™¨å¯èƒ½åŠ¨æ€åˆ›å»º/é”€æ¯
â€¢ å¤šç¯å¢ƒé…ç½®å®¹æ˜“ä¸ä¸€è‡´

åŠ¨æ€æ¸…å•çš„ä¼˜åŠ¿ï¼š
â€¢ è‡ªåŠ¨ä»å¤–éƒ¨ç³»ç»Ÿè·å–ä¸»æœºä¿¡æ¯
â€¢ å®æ—¶åæ˜ åŸºç¡€è®¾æ–½å˜åŒ–
â€¢ å‡å°‘æ‰‹å·¥ç»´æŠ¤å·¥ä½œ
â€¢ é¿å…é…ç½®æ¼‚ç§»é—®é¢˜
```

### 2.2 äº‘å¹³å°åŠ¨æ€æ¸…å•



#### ğŸ”¸ AWS EC2 åŠ¨æ€æ¸…å•



```python
#!/usr/bin/env python3

# aws_ec2_inventory.py - AWSåŠ¨æ€æ¸…å•è„šæœ¬


import boto3
import json
import sys

def get_ec2_inventory():
    """ä»AWS EC2è·å–ä¸»æœºæ¸…å•"""
    ec2 = boto3.client('ec2', region_name='us-west-2')
    
#    # è·å–æ‰€æœ‰è¿è¡Œä¸­çš„å®ä¾‹
    response = ec2.describe_instances(
        Filters=[
            {'Name': 'instance-state-name', 'Values': ['running']}
        ]
    )
    
    inventory = {
        '_meta': {'hostvars': {}},
        'all': {'children': ['ungrouped']},
        'ungrouped': {'hosts': []}
    }
    
    for reservation in response['Reservations']:
        for instance in reservation['Instances']:
#            # è·å–å®ä¾‹ä¿¡æ¯
            instance_id = instance['InstanceId']
            private_ip = instance['PrivateIpAddress']
            
#            # ä»æ ‡ç­¾è·å–ä¸»æœºåå’Œåˆ†ç»„ä¿¡æ¯
            tags = {tag['Key']: tag['Value'] for tag in instance.get('Tags', [])}
            hostname = tags.get('Name', instance_id)
            environment = tags.get('Environment', 'ungrouped')
            role = tags.get('Role', 'ungrouped')
            
#            # æ·»åŠ åˆ°å¯¹åº”åˆ†ç»„
            if environment not in inventory:
                inventory[environment] = {'hosts': []}
            inventory[environment]['hosts'].append(hostname)
            
            if role not in inventory:
                inventory[role] = {'hosts': []}
            inventory[role]['hosts'].append(hostname)
            
#            # è®¾ç½®ä¸»æœºå˜é‡
            inventory['_meta']['hostvars'][hostname] = {
                'ansible_host': private_ip,
                'ec2_instance_id': instance_id,
                'ec2_instance_type': instance['InstanceType'],
                'ec2_environment': environment,
                'ec2_role': role
            }
    
    return inventory

if __name__ == '__main__':
    if len(sys.argv) == 2 and sys.argv[1] == '--list':
        print(json.dumps(get_ec2_inventory(), indent=2))
    elif len(sys.argv) == 3 and sys.argv[1] == '--host':
#        # è¿”å›ç‰¹å®šä¸»æœºçš„å˜é‡
        print(json.dumps({}))
    else:
        print("Usage: aws_ec2_inventory.py --list")
```

**ä½¿ç”¨AWSåŠ¨æ€æ¸…å•ï¼š**

```bash
# è®¾ç½®æ‰§è¡Œæƒé™

chmod +x aws_ec2_inventory.py

# æµ‹è¯•åŠ¨æ€æ¸…å•

./aws_ec2_inventory.py --list

# åœ¨ansibleä¸­ä½¿ç”¨

ansible-playbook -i aws_ec2_inventory.py site.yml
```

#### ğŸ”¸ Dockerå®¹å™¨åŠ¨æ€æ¸…å•



```python
#!/usr/bin/env python3

# docker_inventory.py - Dockerå®¹å™¨åŠ¨æ€æ¸…å•


import docker
import json
import sys

def get_docker_inventory():
    """ä»Dockerè·å–å®¹å™¨æ¸…å•"""
    client = docker.from_env()
    
    inventory = {
        '_meta': {'hostvars': {}},
        'all': {'children': []},
        'docker_containers': {'hosts': []}
    }
    
#    # è·å–æ‰€æœ‰è¿è¡Œä¸­çš„å®¹å™¨
    containers = client.containers.list(all=True)
    
    for container in containers:
        if container.status != 'running':
            continue
            
        container_name = container.name
        container_id = container.short_id
        
#        # è·å–å®¹å™¨IPåœ°å€
        container_ip = None
        if container.attrs['NetworkSettings']['IPAddress']:
            container_ip = container.attrs['NetworkSettings']['IPAddress']
        
#        # ä»æ ‡ç­¾è·å–åˆ†ç»„ä¿¡æ¯
        labels = container.labels
        service = labels.get('service', 'ungrouped')
        environment = labels.get('environment', 'development')
        
#        # åˆ›å»ºåˆ†ç»„
        for group in [service, environment, 'docker_containers']:
            if group not in inventory:
                inventory[group] = {'hosts': []}
            inventory[group]['hosts'].append(container_name)
            
            if group not in inventory['all']['children']:
                inventory['all']['children'].append(group)
        
#        # è®¾ç½®ä¸»æœºå˜é‡
        inventory['_meta']['hostvars'][container_name] = {
            'ansible_connection': 'docker',
            'ansible_host': container_ip,
            'container_id': container_id,
            'container_image': container.image.tags[0] if container.image.tags else 'unknown',
            'container_service': service,
            'container_environment': environment
        }
    
    return inventory

if __name__ == '__main__':
    if len(sys.argv) == 2 and sys.argv[1] == '--list':
        print(json.dumps(get_docker_inventory(), indent=2))
    else:
        print("Usage: docker_inventory.py --list")
```

### 2.3 æ•°æ®åº“é©±åŠ¨çš„åŠ¨æ€æ¸…å•



```python
#!/usr/bin/env python3

# db_inventory.py - åŸºäºæ•°æ®åº“çš„åŠ¨æ€æ¸…å•


import sqlite3
import json
import sys
import os

DATABASE_PATH = '/etc/ansible/cmdb.db'

def get_db_inventory():
    """ä»CMDBæ•°æ®åº“è·å–ä¸»æœºæ¸…å•"""
    if not os.path.exists(DATABASE_PATH):
        return {'all': {'hosts': []}}
    
    conn = sqlite3.connect(DATABASE_PATH)
    cursor = conn.cursor()
    
#    # æŸ¥è¯¢ä¸»æœºä¿¡æ¯
    cursor.execute('''
        SELECT hostname, ip_address, environment, role, 
               ssh_user, ssh_port, status
        FROM servers 
        WHERE status = 'active'
    ''')
    
    inventory = {
        '_meta': {'hostvars': {}},
        'all': {'children': []}
    }
    
    for row in cursor.fetchall():
        hostname, ip, env, role, user, port, status = row
        
#        # åˆ›å»ºåˆ†ç»„
        for group in [env, role]:
            if group not in inventory:
                inventory[group] = {'hosts': []}
                inventory['all']['children'].append(group)
            inventory[group]['hosts'].append(hostname)
        
#        # è®¾ç½®ä¸»æœºå˜é‡  
        inventory['_meta']['hostvars'][hostname] = {
            'ansible_host': ip,
            'ansible_user': user,
            'ansible_port': port,
            'server_environment': env,
            'server_role': role
        }
    
    conn.close()
    return inventory
```

### 2.4 åŠ¨æ€æ¸…å•é…ç½®ç®¡ç†



**ğŸ“‹ åŠ¨æ€æ¸…å•æ’ä»¶é…ç½®**

Ansible 2.4+æ”¯æŒæ¸…å•æ’ä»¶ï¼Œé…ç½®æ›´ç®€å•ï¼š

```yaml
# inventory_aws.yml - AWSæ¸…å•æ’ä»¶é…ç½®

plugin: amazon.aws.aws_ec2
regions:
  - us-west-1
  - us-west-2
keyed_groups:
#  # æŒ‰ç¯å¢ƒåˆ›å»ºç»„
  - prefix: env
    key: tags.Environment
#  # æŒ‰å®ä¾‹ç±»å‹åˆ›å»ºç»„  
  - prefix: type
    key: instance_type
hostnames:
#  # ä½¿ç”¨æ ‡ç­¾Nameä½œä¸ºä¸»æœºå
  - tag:Name
  - instance-id
compose:
#  # ç»„åˆå˜é‡
  ansible_host: private_ip_address
  ec2_environment: tags.Environment
  ec2_role: tags.Role
```

ä½¿ç”¨æ’ä»¶å¼åŠ¨æ€æ¸…å•ï¼š

```bash
# ç›´æ¥ä½¿ç”¨æ¸…å•é…ç½®æ–‡ä»¶

ansible-inventory -i inventory_aws.yml --list

# åœ¨playbookä¸­ä½¿ç”¨

ansible-playbook -i inventory_aws.yml site.yml
```

**ğŸ”„ æ¸…å•ç¼“å­˜é…ç½®**

åŠ¨æ€æ¸…å•æŸ¥è¯¢å¯èƒ½è¾ƒæ…¢ï¼Œå¯ç”¨ç¼“å­˜æå‡æ€§èƒ½ï¼š

```ini
# ansible.cfg

[inventory]
# å¯ç”¨ç¼“å­˜

cache = True
cache_plugin = jsonfile
cache_timeout = 3600
cache_connection = /tmp/ansible_inventory_cache
```

---

## 3. ğŸ—ï¸ ä¸»æœºåˆ†ç»„ç­–ç•¥è®¾è®¡



### 3.1 åˆ†ç»„è®¾è®¡åŸºæœ¬åŸåˆ™



**ä¸ºä»€ä¹ˆéœ€è¦ä¸»æœºåˆ†ç»„ï¼Ÿ**
> åˆ†ç»„å°±åƒ"æ•´ç†è¡£æŸœ"ï¼ŒæŠŠç›¸ä¼¼çš„ä¸œè¥¿æ”¾åœ¨ä¸€èµ·ã€‚ä¸åŒç±»å‹çš„æœåŠ¡å™¨éœ€è¦ä¸åŒçš„é…ç½®ï¼Œé€šè¿‡åˆ†ç»„å¯ä»¥æ‰¹é‡ç®¡ç†ç›¸åŒè§’è‰²çš„æœåŠ¡å™¨ã€‚

```
æ— åˆ†ç»„çš„é—®é¢˜ï¼š
â€¢ éœ€è¦é€ä¸ªæŒ‡å®šä¸»æœºæ‰§è¡Œä»»åŠ¡
â€¢ ç›¸åŒé…ç½®é‡å¤åº”ç”¨åˆ°å¤šå°æœåŠ¡å™¨
â€¢ éš¾ä»¥ç®¡ç†å¤§é‡ä¸»æœº
â€¢ é…ç½®å®¹æ˜“å‡ºç°ä¸ä¸€è‡´

åˆ†ç»„çš„å¥½å¤„ï¼š  
â€¢ æ‰¹é‡æ“ä½œåŒç±»æœåŠ¡å™¨
â€¢ ç»Ÿä¸€é…ç½®ç®¡ç†  
â€¢ ç®€åŒ–è¿ç»´æ“ä½œ
â€¢ æé«˜è‡ªåŠ¨åŒ–ç¨‹åº¦
```

### 3.2 åŠŸèƒ½è§’è‰²åˆ†ç»„



**æŒ‰æœåŠ¡åŠŸèƒ½åˆ’åˆ†æ˜¯æœ€åŸºç¡€çš„åˆ†ç»„æ–¹å¼**

```ini
# åŸºç¡€åŠŸèƒ½åˆ†ç»„

[webservers]
web1.example.com
web2.example.com
web3.example.com

[databases]  
db-master.example.com
db-slave1.example.com
db-slave2.example.com

[cache]
redis1.example.com  
redis2.example.com

[monitoring]
zabbix.example.com
grafana.example.com

[loadbalancers]
lb1.example.com
lb2.example.com
```

**åˆ†ç»„çš„å®é™…åº”ç”¨åœºæ™¯ï¼š**

| åˆ†ç»„ | ä¸»è¦ç”¨é€” | å…¸å‹ä»»åŠ¡ |
|------|----------|----------|
| **webservers** | Webåº”ç”¨éƒ¨ç½² | éƒ¨ç½²ä»£ç ã€é…ç½®Nginxã€SSLè¯ä¹¦ |
| **databases** | æ•°æ®åº“ç®¡ç† | å¤‡ä»½ã€ä¸»ä»é…ç½®ã€æ€§èƒ½ä¼˜åŒ– |
| **cache** | ç¼“å­˜æœåŠ¡ | Redisé…ç½®ã€é›†ç¾¤æ­å»º |
| **monitoring** | ç›‘æ§ç³»ç»Ÿ | ç›‘æ§é…ç½®ã€å‘Šè­¦è§„åˆ™ |

### 3.3 ç¯å¢ƒç”Ÿå‘½å‘¨æœŸåˆ†ç»„



```yaml
# å¤šç¯å¢ƒåˆ†ç»„ç­–ç•¥

all:
  children:
#    # ç¯å¢ƒåˆ†ç»„
    production:
      children:
        prod_web:
          hosts:
            prod-web-1: {ansible_host: "192.168.1.10"}
            prod-web-2: {ansible_host: "192.168.1.11"}
        prod_db:
          hosts:
            prod-db-master: {ansible_host: "192.168.1.20"}
            prod-db-slave: {ansible_host: "192.168.1.21"}
    
    staging:
      children:
        stage_web:
          hosts:
            stage-web-1: {ansible_host: "192.168.2.10"}
        stage_db:
          hosts:
            stage-db-1: {ansible_host: "192.168.2.20"}
    
    development:
      children:
        dev_web:
          hosts:
            dev-web-1: {ansible_host: "10.0.1.10"}
        dev_db:
          hosts:
            dev-db-1: {ansible_host: "10.0.1.20"}
```

**ç¯å¢ƒåˆ†ç»„çš„é…ç½®å·®å¼‚åŒ–ï¼š**

```yaml
# group_vars/production/main.yml

environment: production
db_pool_size: 100
log_level: warn
backup_enabled: true
monitoring_enabled: true

# group_vars/development/main.yml  

environment: development
db_pool_size: 10
log_level: debug
backup_enabled: false
monitoring_enabled: false
```

### 3.4 åœ°ç†ä½ç½®åˆ†ç»„



**å¤šåœ°åŸŸéƒ¨ç½²çš„åˆ†ç»„ç­–ç•¥ï¼š**

```ini
# åœ°åŸŸåˆ†ç»„

[beijing]
bj-web-1.example.com
bj-web-2.example.com  
bj-db-1.example.com

[shanghai]
sh-web-1.example.com
sh-web-2.example.com
sh-db-1.example.com

[guangzhou]
gz-web-1.example.com
gz-db-1.example.com

# è·¨åœ°åŸŸçš„åŠŸèƒ½åˆ†ç»„

[webservers:children]
beijing_web
shanghai_web
guangzhou_web

[beijing_web]
bj-web-1.example.com
bj-web-2.example.com

[shanghai_web]  
sh-web-1.example.com
sh-web-2.example.com

[guangzhou_web]
gz-web-1.example.com
```

è¿™ç§åˆ†ç»„çš„å®é™…ä»·å€¼ï¼š
- **å°±è¿‘é…ç½®**ï¼šä¸åŒåœ°åŸŸä½¿ç”¨ä¸åŒçš„DNSã€NTPæœåŠ¡å™¨
- **ç¾å¤‡ç­–ç•¥**ï¼šæŒ‰åœ°åŸŸè¿›è¡Œæ•°æ®å¤‡ä»½å’Œæ¢å¤
- **ç½‘ç»œä¼˜åŒ–**ï¼šé…ç½®æœ€ä¼˜çš„ç½‘ç»œè·¯å¾„
- **æ³•è§„éµä»**ï¼šæŸäº›åœ°åŸŸæœ‰ç‰¹æ®Šçš„åˆè§„è¦æ±‚

### 3.5 å¤æ‚åˆ†ç»„ç»§æ‰¿è®¾è®¡



```yaml
# ä¼ä¸šçº§åˆ†ç»„ç»§æ‰¿ç»“æ„

all:
  vars:
#    # å…¨å±€å˜é‡
    company_domain: example.com
    ntp_servers: ["ntp1.example.com", "ntp2.example.com"]
    
  children:
#    # æŒ‰åœ°åŸŸåˆ†ç»„
    datacenters:
      children:
        beijing_dc:
          vars:
            datacenter: beijing
            timezone: Asia/Shanghai
            dns_servers: ["192.168.1.1", "192.168.1.2"]
            
        singapore_dc:
          vars:
            datacenter: singapore  
            timezone: Asia/Singapore
            dns_servers: ["10.0.1.1", "10.0.1.2"]
    
#    # æŒ‰ç¯å¢ƒåˆ†ç»„
    environments:
      children:
        production:
          vars:
            env: prod
            log_level: info
            monitoring: enabled
            
        staging:
          vars:
            env: stage
            log_level: debug
            monitoring: limited
    
#    # æŒ‰åŠŸèƒ½åˆ†ç»„  
    services:
      children:
        web_tier:
          vars:
            service_type: web
            max_connections: 1000
            
        data_tier:
          vars:
            service_type: database
            backup_schedule: "0 2 * * *"
    
#    # å®é™…ä¸»æœºåˆ†é…
    beijing_prod_web:
      vars:
#        # ç»§æ‰¿å¤šä¸ªç»„çš„å˜é‡
        location: "{{ datacenter }}"
        environment_type: "{{ env }}"
        service_role: "{{ service_type }}"
      hosts:
        bj-prod-web-1:
          ansible_host: 192.168.1.10
        bj-prod-web-2:  
          ansible_host: 192.168.1.11
```

**ç»§æ‰¿å…³ç³»å›¾ç¤ºï¼š**

```
å…¨å±€å˜é‡ (all)
    â†“
åœ°åŸŸå˜é‡ (beijing_dc) â†’ æ—¶åŒºã€DNSé…ç½®
    â†“  
ç¯å¢ƒå˜é‡ (production) â†’ æ—¥å¿—çº§åˆ«ã€ç›‘æ§é…ç½®
    â†“
åŠŸèƒ½å˜é‡ (web_tier) â†’ è¿æ¥æ•°ã€æœåŠ¡é…ç½®
    â†“
ä¸»æœºå˜é‡ (bj-prod-web-1) â†’ å…·ä½“IPã€ç‰¹æ®Šé…ç½®
```

### 3.6 åˆ†ç»„ç®¡ç†æœ€ä½³å®è·µ



**ğŸ¯ åˆ†ç»„å‘½åè§„èŒƒ**

```
å‘½åæ¨¡å¼ï¼š{ç¯å¢ƒ}_{åœ°åŸŸ}_{åŠŸèƒ½}

ç¤ºä¾‹ï¼š
âœ… prod_bj_web     - ç”Ÿäº§ç¯å¢ƒåŒ—äº¬WebæœåŠ¡å™¨
âœ… stage_sh_db     - æµ‹è¯•ç¯å¢ƒä¸Šæµ·æ•°æ®åº“  
âœ… dev_local_cache - å¼€å‘ç¯å¢ƒæœ¬åœ°ç¼“å­˜

åˆ†ç»„å±‚çº§ï¼š
ç¬¬1å±‚ï¼šç¯å¢ƒåˆ†ç»„ (production, staging, development)
ç¬¬2å±‚ï¼šåœ°åŸŸåˆ†ç»„ (beijing, shanghai, singapore)  
ç¬¬3å±‚ï¼šåŠŸèƒ½åˆ†ç»„ (web, database, cache, monitor)
ç¬¬4å±‚ï¼šå…·ä½“ä¸»æœº (web-01, db-master, redis-cluster-1)
```

**ğŸ“Š åˆ†ç»„è§„æ¨¡å»ºè®®**

```
å°å‹é¡¹ç›® (< 20å°æœåŠ¡å™¨)ï¼š
â€¢ æŒ‰åŠŸèƒ½ç®€å•åˆ†ç»„
â€¢ webservers, databases, monitoring

ä¸­å‹é¡¹ç›® (20-200å°)ï¼š
â€¢ åŠŸèƒ½ + ç¯å¢ƒåŒé‡åˆ†ç»„  
â€¢ prod_web, stage_web, prod_db

å¤§å‹é¡¹ç›® (> 200å°)ï¼š
â€¢ åœ°åŸŸ + ç¯å¢ƒ + åŠŸèƒ½ä¸‰é‡åˆ†ç»„
â€¢ ä½¿ç”¨ç»„ç»§æ‰¿å‡å°‘é‡å¤é…ç½®
```

---

## 4. ğŸ”§ ä¸»æœºå˜é‡å®šä¹‰ç®¡ç†



### 4.1 ä¸»æœºå˜é‡åŸºæœ¬æ¦‚å¿µ



**ä»€ä¹ˆæ˜¯ä¸»æœºå˜é‡ï¼Ÿ**
> ä¸»æœºå˜é‡å°±åƒæ¯ä¸ªäººçš„"èº«ä»½è¯ä¿¡æ¯"ï¼Œè®°å½•äº†æ¯å°æœåŠ¡å™¨çš„ç‰¹æ®Šé…ç½®ã€‚å°±åƒåŒæ ·æ˜¯å‘˜å·¥ï¼Œä½†æ¯ä¸ªäººçš„å·¥å·ã€éƒ¨é—¨ã€èŒä½ä¸åŒä¸€æ ·ã€‚

```
ä¸ºä»€ä¹ˆéœ€è¦ä¸»æœºå˜é‡ï¼Ÿ

é€šç”¨é…ç½®ï¼šæ‰€æœ‰WebæœåŠ¡å™¨éƒ½éœ€è¦Nginx
ä¸ªæ€§åŒ–é…ç½®ï¼š
â€¢ web1æœåŠ¡å™¨ï¼š4æ ¸8Gï¼Œæ‰¿è½½ä¸»è¦æµé‡
â€¢ web2æœåŠ¡å™¨ï¼š2æ ¸4Gï¼Œæ‰¿è½½å¤‡ç”¨æµé‡  
â€¢ web3æœåŠ¡å™¨ï¼š8æ ¸16Gï¼Œå¤„ç†ç‰¹æ®Šä»»åŠ¡

ä¸»æœºå˜é‡çš„ä½œç”¨ï¼š
â€¢ è®°å½•æœåŠ¡å™¨ç¡¬ä»¶è§„æ ¼
â€¢ å®šä¹‰ç‰¹æ®Šé…ç½®å‚æ•°
â€¢ æ ‡è¯†æœåŠ¡å™¨è§’è‰²å’ŒçŠ¶æ€
â€¢ å­˜å‚¨è¿æ¥è®¤è¯ä¿¡æ¯
```

### 4.2 æ¸…å•æ–‡ä»¶ä¸­å®šä¹‰ä¸»æœºå˜é‡



#### ğŸ”¸ INIæ ¼å¼ä¸»æœºå˜é‡



```ini
# åœ¨ä¸»æœºæ¸…å•ä¸­ç›´æ¥å®šä¹‰å˜é‡

[webservers]
web1.example.com ansible_host=192.168.1.10 server_role=primary max_connections=1000
web2.example.com ansible_host=192.168.1.11 server_role=secondary max_connections=500  
web3.example.com ansible_host=192.168.1.12 server_role=backup max_connections=200

[databases]
db-master ansible_host=192.168.1.20 mysql_role=master mysql_server_id=1
db-slave1 ansible_host=192.168.1.21 mysql_role=slave mysql_server_id=2  
db-slave2 ansible_host=192.168.1.22 mysql_role=slave mysql_server_id=3

# ç‰¹æ®Šè¿æ¥å‚æ•°çš„ä¸»æœº

[jumpservers]
bastion ansible_host=jumpserver.example.com ansible_user=admin ansible_port=2222
```

#### ğŸ”¸ YAMLæ ¼å¼ä¸»æœºå˜é‡



```yaml
# inventory.yml - YAMLæ ¼å¼çš„ä¸»æœºå˜é‡

all:
  children:
    webservers:
      hosts:
        web1.example.com:
          ansible_host: 192.168.1.10
          server_role: primary
          cpu_cores: 4
          memory_gb: 8
          disk_space: "100GB"
          ssl_cert_domain: "*.example.com"
          
        web2.example.com:
          ansible_host: 192.168.1.11
          server_role: secondary  
          cpu_cores: 2
          memory_gb: 4
          disk_space: "50GB"
          ssl_cert_domain: "web2.example.com"
          
    databases:
      hosts:
        mysql-master:
          ansible_host: 192.168.1.20
          mysql_role: master
          mysql_server_id: 1
          innodb_buffer_pool_size: "4G"
          max_connections: 1000
          backup_schedule:
            - time: "02:00"
              type: "full"
            - time: "06:00,10:00,14:00,18:00"  
              type: "incremental"
```

### 4.3 host_varsç›®å½•ç®¡ç†



**ä»€ä¹ˆæ˜¯host_varsç›®å½•ï¼Ÿ**
> host_varså°±åƒ"ä¸ªäººæ¡£æ¡ˆæŸœ"ï¼Œæ¯å°æœåŠ¡å™¨æœ‰ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å¤¹ï¼Œå­˜æ”¾å®ƒçš„è¯¦ç»†é…ç½®ä¿¡æ¯ã€‚

```
é¡¹ç›®ç›®å½•ç»“æ„ï¼š
inventory/
â”œâ”€â”€ hosts.yml                 # ä¸»æœºæ¸…å•
â”œâ”€â”€ group_vars/               # ç»„å˜é‡ç›®å½•
â”‚   â”œâ”€â”€ webservers.yml        # WebæœåŠ¡å™¨ç»„å˜é‡
â”‚   â””â”€â”€ databases.yml         # æ•°æ®åº“ç»„å˜é‡
â””â”€â”€ host_vars/                # ä¸»æœºå˜é‡ç›®å½•
    â”œâ”€â”€ web1.example.com.yml  # web1æœåŠ¡å™¨ä¸“ç”¨é…ç½®
    â”œâ”€â”€ web2.example.com.yml  # web2æœåŠ¡å™¨ä¸“ç”¨é…ç½®  
    â””â”€â”€ mysql-master.yml      # mysqlä¸»åº“ä¸“ç”¨é…ç½®
```

#### ğŸ”¸ host_varsæ–‡ä»¶ç¤ºä¾‹



```yaml
# host_vars/web1.example.com.yml

---
# æœåŠ¡å™¨åŸºæœ¬ä¿¡æ¯

server_role: primary
server_priority: 1
maintenance_window: "02:00-04:00"

# ç¡¬ä»¶é…ç½®

hardware:
  cpu_cores: 4
  memory_gb: 8
  disk_type: "SSD"
  network_bandwidth: "1Gbps"

# Nginxé…ç½®

nginx:
  worker_processes: 4
  worker_connections: 1024
  max_body_size: "10M"
  
# SSLè¯ä¹¦é…ç½®  

ssl:
  cert_file: "/etc/ssl/certs/web1.crt"
  key_file: "/etc/ssl/private/web1.key"
  protocols: ["TLSv1.2", "TLSv1.3"]

# ç›‘æ§é…ç½®

monitoring:
  enabled: true
  alerting: true
  metrics:
    - cpu_usage
    - memory_usage  
    - disk_usage
    - network_traffic

# å¤‡ä»½é…ç½®

backup:
  enabled: true
  schedule: "0 3 * * *"
  retention_days: 30
  backup_path: "/backup/web1"
```

```yaml
# host_vars/mysql-master.yml  

---
# æ•°æ®åº“è§’è‰²é…ç½®

mysql_role: master  
mysql_server_id: 1
mysql_read_only: false

# æ€§èƒ½é…ç½®

mysql_config:
  innodb_buffer_pool_size: "4G"
  innodb_log_file_size: "1G"
  max_connections: 1000
  query_cache_size: "256M"
  tmp_table_size: "256M"

# å¤åˆ¶é…ç½®

replication:
  enabled: true
  slaves:
    - host: "192.168.1.21" 
      user: "repl_user"
    - host: "192.168.1.22"
      user: "repl_user"

# å¤‡ä»½ç­–ç•¥

backup_strategy:
  full_backup:
    schedule: "0 2 * * 0"  # æ¯å‘¨æ—¥2ç‚¹
    retention: 4           # ä¿ç•™4å‘¨
  incremental_backup:  
    schedule: "0 2 * * 1-6" # å‘¨ä¸€åˆ°å‘¨å…­2ç‚¹
    retention: 7            # ä¿ç•™7å¤©
    
# ç›‘æ§å‘Šè­¦

alerts:
  replication_lag_seconds: 300
  connection_usage_percent: 80
  disk_usage_percent: 85
```

### 4.4 å˜é‡çš„ä¼˜å…ˆçº§å’Œè¦†ç›–



**Ansibleå˜é‡ä¼˜å…ˆçº§é¡ºåºï¼š**

```
å˜é‡ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
1. å‘½ä»¤è¡Œå‚æ•° (-e "var=value")
2. ä»»åŠ¡ä¸­çš„å˜é‡ (task vars)
3. å—çº§å˜é‡ (block vars) 
4. è§’è‰²å’ŒåŒ…å«çš„å˜é‡ (role vars)
5. playçº§åˆ«çš„å˜é‡ (play vars)
6. host_vars/ä¸»æœºå.yml
7. group_vars/ç»„å.yml  
8. group_vars/all.yml
9. æ¸…å•æ–‡ä»¶ä¸­çš„ä¸»æœºå˜é‡
10. æ¸…å•æ–‡ä»¶ä¸­çš„ç»„å˜é‡
11. è§’è‰²é»˜è®¤å˜é‡ (role defaults)
```

**å®é™…åº”ç”¨ç¤ºä¾‹ï¼š**

```yaml
# group_vars/all.yml - å…¨å±€é»˜è®¤é…ç½®

---
ntp_server: "pool.ntp.org"
timezone: "UTC"
log_level: "info"

# group_vars/webservers.yml - WebæœåŠ¡å™¨ç»„é…ç½®  

---
log_level: "warn"  # è¦†ç›–å…¨å±€é…ç½®
nginx_worker_processes: "auto"

# host_vars/web1.example.com.yml - ç‰¹å®šä¸»æœºé…ç½®

---  
log_level: "debug"  # è¦†ç›–ç»„é…ç½®
nginx_worker_processes: 4  # è¦†ç›–ç»„é…ç½®

# æœ€ç»ˆweb1.example.comçš„é…ç½®ï¼š

# ntp_server: "pool.ntp.org"        (æ¥è‡ªall)

# timezone: "UTC"                   (æ¥è‡ªall)  

# log_level: "debug"                (æ¥è‡ªhost_vars)

# nginx_worker_processes: 4         (æ¥è‡ªhost_vars)

```

### 4.5 å˜é‡æ¨¡æ¿å’Œæ ‡å‡†åŒ–



**ğŸ¯ æ ‡å‡†åŒ–ä¸»æœºå˜é‡æ¨¡æ¿**

```yaml
# templates/host_vars_template.yml - æ ‡å‡†ä¸»æœºå˜é‡æ¨¡æ¿

---
# === åŸºç¡€ä¿¡æ¯ ===

server_info:
  hostname: "{{ inventory_hostname }}"
  environment: ""           # å¡«å†™ï¼šproduction/staging/development
  role: ""                  # å¡«å†™ï¼šweb/database/cache/monitor
  location: ""              # å¡«å†™ï¼šbeijing/shanghai/singapore
  
# === ç¡¬ä»¶é…ç½® ===  

hardware:
  cpu_cores: 0              # å¡«å†™CPUæ ¸å¿ƒæ•°
  memory_gb: 0              # å¡«å†™å†…å­˜å¤§å°GB
  disk_size_gb: 0           # å¡«å†™ç£ç›˜å¤§å°GB
  disk_type: ""             # å¡«å†™ï¼šSSD/HDD
  
# === ç½‘ç»œé…ç½® ===

network:
  public_ip: ""             # å…¬ç½‘IP
  private_ip: "{{ ansible_host }}"  # å†…ç½‘IP
  domain: ""                # åŸŸå
  
# === æœåŠ¡é…ç½® === 

services:
  enabled: []               # å¯ç”¨çš„æœåŠ¡åˆ—è¡¨
  disabled: []              # ç¦ç”¨çš„æœåŠ¡åˆ—è¡¨
  
# === ç›‘æ§é…ç½® ===

monitoring:
  enabled: true
  agent: "zabbix"           # zabbix/prometheus/nagios
  metrics: []               # ç›‘æ§æŒ‡æ ‡åˆ—è¡¨
  
# === å¤‡ä»½é…ç½® ===

backup:
  enabled: false
  schedule: ""              # cronæ ¼å¼
  retention_days: 30
  
# === å®‰å…¨é…ç½® ===

security:
  firewall_enabled: true
  allowed_ports: []         # å…è®¸çš„ç«¯å£åˆ—è¡¨
  ssh_users: []             # SSHç”¨æˆ·åˆ—è¡¨
```

**ğŸ“‹ å˜é‡éªŒè¯æ£€æŸ¥æ¸…å•**

```yaml
# playbooks/validate_host_vars.yml - å˜é‡éªŒè¯playbook

---
- name: éªŒè¯ä¸»æœºå˜é‡å®Œæ•´æ€§
  hosts: all
  gather_facts: false
  tasks:
    - name: æ£€æŸ¥å¿…éœ€çš„ä¸»æœºå˜é‡
      assert:
        that:
          - server_info.hostname is defined
          - server_info.environment is defined  
          - server_info.role is defined
          - hardware.cpu_cores > 0
          - hardware.memory_gb > 0
        fail_msg: "ä¸»æœº {{ inventory_hostname }} ç¼ºå°‘å¿…éœ€çš„å˜é‡"
        
    - name: éªŒè¯ç¯å¢ƒå˜é‡å–å€¼
      assert:
        that:
          - server_info.environment in ['production', 'staging', 'development']
        fail_msg: "ç¯å¢ƒå˜é‡å¿…é¡»æ˜¯ productionã€staging æˆ– development"
        
    - name: è¾“å‡ºä¸»æœºé…ç½®æ‘˜è¦
      debug:
        msg: |
          ä¸»æœº: {{ inventory_hostname }}
          ç¯å¢ƒ: {{ server_info.environment }}
          è§’è‰²: {{ server_info.role }}
          é…ç½®: {{ hardware.cpu_cores }}C/{{ hardware.memory_gb }}G
```

---

## 5. ğŸ”„ ç»„å˜é‡ç»§æ‰¿æœºåˆ¶



### 5.1 ç»„å˜é‡ç»§æ‰¿åŸºæœ¬æ¦‚å¿µ



**ä»€ä¹ˆæ˜¯ç»„å˜é‡ç»§æ‰¿ï¼Ÿ**
> ç»„å˜é‡ç»§æ‰¿å°±åƒ"å®¶æ—ä¼ æ‰¿"ï¼Œå­©å­ä¼šç»§æ‰¿çˆ¶æ¯çš„ç‰¹å¾ï¼Œä½†ä¹Ÿå¯ä»¥æœ‰è‡ªå·±çš„ä¸ªæ€§ã€‚åœ¨Ansibleä¸­ï¼Œå­ç»„ä¼šç»§æ‰¿çˆ¶ç»„çš„å˜é‡ï¼ŒåŒæ—¶å¯ä»¥è¦†ç›–æˆ–æ·»åŠ è‡ªå·±çš„å˜é‡ã€‚

```
ç»§æ‰¿çš„å®é™…æ„ä¹‰ï¼š

çˆ¶ç»„é…ç½® (webservers)ï¼š
â€¢ nginxç‰ˆæœ¬ï¼š1.20  
â€¢ æ—¥å¿—çº§åˆ«ï¼šinfo
â€¢ ç›‘æ§å¯ç”¨ï¼štrue

å­ç»„é…ç½® (production_web)ï¼š
â€¢ ç»§æ‰¿ï¼šnginxç‰ˆæœ¬ã€ç›‘æ§è®¾ç½®
â€¢ è¦†ç›–ï¼šæ—¥å¿—çº§åˆ« â†’ warn  
â€¢ æ–°å¢ï¼šSSLè¯ä¹¦è·¯å¾„

ç»“æœï¼šproduction_webç»„æ—¢æœ‰é€šç”¨é…ç½®ï¼Œåˆæœ‰ç‰¹æ®Šé…ç½®
```

### 5.2 ç»„ç»§æ‰¿ç»“æ„è®¾è®¡



#### ğŸ”¸ åŸºç¡€ç»§æ‰¿ç»“æ„



```yaml
# inventory.yml - ç»„ç»§æ‰¿ç¤ºä¾‹

all:
  vars:
#    # å…¨å±€å˜é‡ - æ‰€æœ‰ä¸»æœºç»§æ‰¿
    company: "Example Corp"
    ntp_servers: ["ntp1.example.com", "ntp2.example.com"]
    timezone: "Asia/Shanghai"
    
  children:
#    # ç¬¬ä¸€å±‚ï¼šæŒ‰åŠŸèƒ½åˆ†ç»„
    webservers:
      vars:
#        # WebæœåŠ¡å™¨é€šç”¨é…ç½®
        nginx_version: "1.20"
        log_level: "info"
        max_connections: 1024
        
      children:
#        # ç¬¬äºŒå±‚ï¼šæŒ‰ç¯å¢ƒç»†åˆ†
        production_web:
          vars:
#            # ç”Ÿäº§ç¯å¢ƒç‰¹æ®Šé…ç½®
            log_level: "warn"          # è¦†ç›–çˆ¶ç»„é…ç½®
            ssl_enabled: true          # æ–°å¢é…ç½®
            backup_enabled: true       # æ–°å¢é…ç½®
            
          hosts:
            prod-web-1: {ansible_host: "192.168.1.10"}
            prod-web-2: {ansible_host: "192.168.1.11"}
            
        development_web:
          vars:
#            # å¼€å‘ç¯å¢ƒç‰¹æ®Šé…ç½®  
            log_level: "debug"         # è¦†ç›–çˆ¶ç»„é…ç½®
            ssl_enabled: false         # æ–°å¢é…ç½®
            backup_enabled: false      # æ–°å¢é…ç½®
            
          hosts:
            dev-web-1: {ansible_host: "10.0.1.10"}
```

**ç»§æ‰¿ç»“æœåˆ†æï¼š**

```
prod-web-1 æœ€ç»ˆå¾—åˆ°çš„å˜é‡ï¼š
â€¢ company: "Example Corp"        (æ¥è‡ª all)
â€¢ ntp_servers: [...]             (æ¥è‡ª all)  
â€¢ timezone: "Asia/Shanghai"      (æ¥è‡ª all)
â€¢ nginx_version: "1.20"          (æ¥è‡ª webservers)
â€¢ max_connections: 1024          (æ¥è‡ª webservers)
â€¢ log_level: "warn"              (æ¥è‡ª production_webï¼Œè¦†ç›–äº†webserversçš„"info")
â€¢ ssl_enabled: true              (æ¥è‡ª production_web)
â€¢ backup_enabled: true           (æ¥è‡ª production_web)
```

#### ğŸ”¸ å¤æ‚ç»§æ‰¿å±‚æ¬¡



```yaml
# ä¼ä¸šçº§å¤šå±‚ç»§æ‰¿ç»“æ„

all:
  vars:
    global_domain: "example.com"
    
  children:
#    # === åœ°åŸŸåˆ†ç»„ ===
    datacenters:
      children:
        asia_pacific:
          vars:
            region: "asia"
            timezone: "Asia/Shanghai"
            
          children:
            beijing_dc:
              vars:
                datacenter: "beijing"
                dns_servers: ["192.168.1.1", "192.168.1.2"]
                
            singapore_dc:  
              vars:
                datacenter: "singapore"
                dns_servers: ["10.0.1.1", "10.0.1.2"]
    
#    # === ç¯å¢ƒåˆ†ç»„ ===            
    environments:
      children:
        production:
          vars:
            env_type: "prod"
            monitoring_level: "full"
            log_retention_days: 90
            
        staging:
          vars:
            env_type: "stage"  
            monitoring_level: "basic"
            log_retention_days: 30
    
#    # === æœåŠ¡åˆ†ç»„ ===
    services:
      children:
        web_services:
          vars:
            service_category: "web"
            default_port: 80
            
        database_services:
          vars:
            service_category: "database"
            default_port: 3306
    
#    # === å®é™…ä¸»æœºç»„ ===        
    beijing_prod_web:
#      # ç»§æ‰¿å¤šä¸ªçˆ¶ç»„
      parents: [beijing_dc, production, web_services]
      vars:
#        # ç»„åˆç»§æ‰¿çš„ç»“æœ
        cluster_name: "{{ datacenter }}-{{ env_type }}-web"
        
      hosts:
        bj-prod-web-1:
          ansible_host: 192.168.1.10
```

### 5.3 group_varsç›®å½•ç»“æ„



**ğŸ“ æ¨èçš„group_varsç›®å½•ç»“æ„ï¼š**

```
inventory/
â”œâ”€â”€ hosts.yml
â”œâ”€â”€ group_vars/
â”‚   â”œâ”€â”€ all/                    # å…¨å±€å˜é‡ç›®å½•
â”‚   â”‚   â”œâ”€â”€ main.yml           # ä¸»é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ secrets.yml        # æ•æ„Ÿä¿¡æ¯ï¼ˆåŠ å¯†ï¼‰
â”‚   â”‚   â””â”€â”€ network.yml        # ç½‘ç»œé…ç½®
â”‚   â”‚
â”‚   â”œâ”€â”€ webservers/            # WebæœåŠ¡å™¨ç»„å˜é‡
â”‚   â”‚   â”œâ”€â”€ main.yml           # ä¸»é…ç½®
â”‚   â”‚   â”œâ”€â”€ nginx.yml          # Nginxé…ç½®
â”‚   â”‚   â””â”€â”€ ssl.yml            # SSLé…ç½®
â”‚   â”‚
â”‚   â”œâ”€â”€ production/            # ç”Ÿäº§ç¯å¢ƒå˜é‡
â”‚   â”‚   â”œâ”€â”€ main.yml
â”‚   â”‚   â”œâ”€â”€ monitoring.yml
â”‚   â”‚   â””â”€â”€ backup.yml
â”‚   â”‚
â”‚   â””â”€â”€ databases/             # æ•°æ®åº“ç»„å˜é‡
â”‚       â”œâ”€â”€ main.yml
â”‚       â”œâ”€â”€ mysql.yml
â”‚       â””â”€â”€ redis.yml
â””â”€â”€ host_vars/                 # ä¸»æœºå˜é‡ç›®å½•
    â””â”€â”€ ...
```

#### ğŸ”¸ group_varsæ–‡ä»¶ç¤ºä¾‹



```yaml
# group_vars/all/main.yml - å…¨å±€åŸºç¡€é…ç½®

---
# å…¬å¸ä¿¡æ¯

company_name: "Example Corporation"
company_domain: "example.com"

# æ—¶é—´é…ç½®

timezone: "Asia/Shanghai"
ntp_servers:
  - "ntp1.example.com"
  - "ntp2.example.com"  
  - "pool.ntp.org"

# DNSé…ç½®  

dns_search_domains:
  - "example.com"
  - "internal.example.com"

# åŸºç¡€è½¯ä»¶ç‰ˆæœ¬

base_packages:
  - "htop"
  - "vim"
  - "curl" 
  - "wget"
  - "rsync"
```

```yaml
# group_vars/webservers/main.yml - WebæœåŠ¡å™¨é€šç”¨é…ç½®

---
# NginxåŸºç¡€é…ç½®

nginx:
  version: "1.20"
  user: "nginx"
  worker_processes: "auto"
  error_log_level: "warn"
  
# PHPé…ç½®  

php:
  version: "7.4"
  memory_limit: "256M"
  max_execution_time: 300
  
# æ—¥å¿—é…ç½®

logs:
  access_log: "/var/log/nginx/access.log"
  error_log: "/var/log/nginx/error.log"
  rotation_days: 30
  
# æ€§èƒ½é…ç½®

performance:
  max_connections: 1024
  keepalive_timeout: 65
  client_max_body_size: "10M"
```

```yaml
# group_vars/production/main.yml - ç”Ÿäº§ç¯å¢ƒé…ç½®

---
# ç¯å¢ƒæ ‡è¯†

environment: "production"
env_short: "prod"

# å®‰å…¨é…ç½®

security:
  firewall_enabled: true
  fail2ban_enabled: true
  ssh_password_auth: false
  
# ç›‘æ§é…ç½®  

monitoring:
  enabled: true
  agent: "zabbix"
  alerting: true
  metrics_retention_days: 365
  
# å¤‡ä»½é…ç½®

backup:
  enabled: true
  schedule: "0 2 * * *"  # æ¯å¤©2ç‚¹
  retention_days: 30
  remote_backup: true
  
# æ€§èƒ½ä¼˜åŒ–

optimization:
  high_performance: true
  cache_enabled: true
  compression_enabled: true
```

### 5.4 å˜é‡åˆå¹¶ç­–ç•¥



**ğŸ”„ Ansibleå˜é‡åˆå¹¶æœºåˆ¶ï¼š**

```yaml
# ç¤ºä¾‹ï¼šå˜é‡åˆå¹¶è¿‡ç¨‹

# group_vars/all/main.yml

database_config:
  host: "localhost"
  port: 3306
  charset: "utf8"

# group_vars/databases/main.yml  

database_config:
  port: 3307          # è¦†ç›–
  username: "dbuser"  # æ–°å¢
  
# host_vars/mysql-master.yml

database_config:
  host: "mysql-master.example.com"  # è¦†ç›–
  password: "secret123"              # æ–°å¢
  
# æœ€ç»ˆåˆå¹¶ç»“æœï¼š

database_config:
  host: "mysql-master.example.com"   # æ¥è‡ªhost_vars
  port: 3307                         # æ¥è‡ªdatabasesç»„
  charset: "utf8"                    # æ¥è‡ªallç»„  
  username: "dbuser"                 # æ¥è‡ªdatabasesç»„
  password: "secret123"              # æ¥è‡ªhost_vars
```

**âš ï¸ å˜é‡åˆå¹¶çš„æ³¨æ„äº‹é¡¹ï¼š**

```yaml
# é—®é¢˜ï¼šåˆ—è¡¨å˜é‡ä¸ä¼šåˆå¹¶ï¼Œè€Œæ˜¯å®Œå…¨è¦†ç›–

# group_vars/all.yml

allowed_users:
  - "admin"
  - "operator"

# group_vars/webservers.yml  

allowed_users:
  - "webadmin"
  
# ç»“æœï¼šwebserversç»„çš„allowed_usersåªæœ‰["webadmin"]ï¼Œä¸¢å¤±äº†allä¸­çš„ç”¨æˆ·


# è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ä¸åŒçš„å˜é‡å

# group_vars/all.yml

base_users:
  - "admin" 
  - "operator"

# group_vars/webservers.yml

service_users:
  - "webadmin"
  
# åœ¨playbookä¸­åˆå¹¶

all_users: "{{ base_users + service_users }}"
```

### 5.5 ç»§æ‰¿æœºåˆ¶æœ€ä½³å®è·µ



**ğŸ¯ è®¾è®¡åŸåˆ™ï¼š**

```
1. åˆ†å±‚æ¸…æ™°åŸåˆ™
   å…¨å±€ â†’ åœ°åŸŸ â†’ ç¯å¢ƒ â†’ æœåŠ¡ â†’ ä¸»æœº
   
2. èŒè´£å•ä¸€åŸåˆ™  
   æ¯å±‚åªè´Ÿè´£ç›¸å…³çš„é…ç½®
   
3. è¦†ç›–æœ€å°åŸåˆ™
   åªåœ¨å¿…è¦æ—¶è¦†ç›–çˆ¶ç»„å˜é‡
   
4. å‘½åè§„èŒƒåŸåˆ™
   ä½¿ç”¨æ¸…æ™°çš„å‘½åé¿å…å˜é‡å†²çª
```

**ğŸ“‹ ç»§æ‰¿æ£€æŸ¥æ¸…å•ï¼š**

```yaml
# playbooks/check_inheritance.yml - ç»§æ‰¿å…³ç³»æ£€æŸ¥

---
- name: æ£€æŸ¥å˜é‡ç»§æ‰¿å…³ç³»
  hosts: all
  gather_facts: false
  tasks:
    - name: æ˜¾ç¤ºä¸»æœºçš„ç»„æˆå‘˜å…³ç³»
      debug:
        msg: "{{ inventory_hostname }} å±äºç»„: {{ group_names }}"
        
    - name: æ˜¾ç¤ºå˜é‡æ¥æºåˆ†æ
      debug:
        var: hostvars[inventory_hostname]
        
    - name: æ£€æŸ¥å…³é”®é…ç½®ç»§æ‰¿
      debug:
        msg: |
          ä¸»æœº: {{ inventory_hostname }}
          æ—¶åŒº: {{ timezone | default('æœªå®šä¹‰') }}
          ç¯å¢ƒ: {{ environment | default('æœªå®šä¹‰') }}  
          æœåŠ¡ç±»å‹: {{ service_category | default('æœªå®šä¹‰') }}
          æ•°æ®ä¸­å¿ƒ: {{ datacenter | default('æœªå®šä¹‰') }}
```

---

## 6. ğŸ¯ ä¸»æœºæ¨¡å¼åŒ¹é…è¯­æ³•



### 6.1 æ¨¡å¼åŒ¹é…åŸºæœ¬æ¦‚å¿µ



**ä»€ä¹ˆæ˜¯ä¸»æœºæ¨¡å¼åŒ¹é…ï¼Ÿ**
> æ¨¡å¼åŒ¹é…å°±åƒ"æœç´¢åŠŸèƒ½"ï¼Œè®©ä½ èƒ½å¤Ÿç”¨ç®€å•çš„è¡¨è¾¾å¼é€‰æ‹©ä¸€æ‰¹æœåŠ¡å™¨ï¼Œè€Œä¸ç”¨ä¸€ä¸ªä¸ªåˆ—å‡ºæ¥ã€‚å°±åƒåœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­ç”¨`*.txt`é€‰æ‹©æ‰€æœ‰æ–‡æœ¬æ–‡ä»¶ä¸€æ ·ã€‚

```
ä¸ä½¿ç”¨æ¨¡å¼åŒ¹é…çš„é—®é¢˜ï¼š
ansible-playbook -i hosts site.yml -l web1,web2,web3,web4,web5...
# éœ€è¦æ‰‹åŠ¨åˆ—å‡ºæ¯å°æœåŠ¡å™¨ï¼Œå®¹æ˜“å‡ºé”™


ä½¿ç”¨æ¨¡å¼åŒ¹é…çš„ä¾¿åˆ©ï¼š
ansible-playbook -i hosts site.yml -l 'web*'
# è‡ªåŠ¨åŒ¹é…æ‰€æœ‰ä»¥webå¼€å¤´çš„æœåŠ¡å™¨

```

### 6.2 åŸºç¡€æ¨¡å¼è¯­æ³•



#### ğŸ”¸ é€šé…ç¬¦åŒ¹é…



```bash
# æ‰€æœ‰ä¸»æœº

ansible all -m ping

# å•ä¸ªä¸»æœº

ansible web1.example.com -m ping

# é€šé…ç¬¦åŒ¹é…

ansible 'web*' -m ping              # æ‰€æœ‰ä»¥webå¼€å¤´çš„ä¸»æœº
ansible '*.example.com' -m ping     # æ‰€æœ‰example.comåŸŸä¸‹çš„ä¸»æœº
ansible 'db-?' -m ping              # db-1, db-2ç­‰å•å­—ç¬¦åŒ¹é…
ansible 'server[1-5]' -m ping       # server1åˆ°server5
ansible 'web[02-10]' -m ping        # web02åˆ°web10ï¼ˆæ”¯æŒå‰å¯¼é›¶ï¼‰
```

**é€šé…ç¬¦ç¬¦å·è¯´æ˜ï¼š**

| ç¬¦å· | å«ä¹‰ | ç¤ºä¾‹ | åŒ¹é…ç»“æœ |
|------|------|------|----------|
| `*` | **åŒ¹é…ä»»æ„å­—ç¬¦** | `web*` | web1, webserver, web-prod |
| `?` | **åŒ¹é…å•ä¸ªå­—ç¬¦** | `db?` | db1, dba, db2 |
| `[1-5]` | **èŒƒå›´åŒ¹é…** | `server[1-5]` | server1, server2...server5 |
| `[abc]` | **å­—ç¬¦é›†åŒ¹é…** | `web[abc]` | weba, webb, webc |

#### ğŸ”¸ ç»„åŒ¹é…è¯­æ³•



```bash
# å•ä¸ªç»„

ansible webservers -m ping

# å¤šä¸ªç»„ï¼ˆå¹¶é›†ï¼‰

ansible 'webservers:databases' -m ping

# ç»„çš„äº¤é›†

ansible 'webservers:&production' -m ping    # æ—¢å±äºwebserversåˆå±äºproduction

# ç»„çš„å·®é›†  

ansible 'webservers:!staging' -m ping       # å±äºwebserversä½†ä¸å±äºstaging

# å¤æ‚ç»„åˆ

ansible 'webservers:databases:!development' -m ping  # (webæˆ–db) ä¸” ä¸æ˜¯å¼€å‘ç¯å¢ƒ
```

### 6.3 é«˜çº§æ¨¡å¼ç»„åˆ



#### ğŸ”¸ æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…



```bash
# å¯ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼ˆåœ¨æ¨¡å¼å‰åŠ ~ï¼‰

ansible '~web[0-9]+\.prod\..*' -m ping     # åŒ¹é…webæ•°å­—.prod.ä»»æ„åŸŸå
ansible '~db-(master|slave)' -m ping       # åŒ¹é…db-masteræˆ–db-slave
ansible '~.*\.(com|org|net)$' -m ping      # åŒ¹é…ç‰¹å®šé¡¶çº§åŸŸå
```

#### ğŸ”¸ å¤æ‚é€»è¾‘ç»„åˆ



```bash
# å¤æ‚çš„é€»è¾‘è¡¨è¾¾å¼

# ç”Ÿäº§ç¯å¢ƒçš„WebæœåŠ¡å™¨ï¼Œä½†ä¸åŒ…æ‹¬å¤‡ç”¨æœåŠ¡å™¨

ansible 'webservers:&production:!backup' -m ping

# åŒ—äº¬æˆ–ä¸Šæµ·çš„æ•°æ®åº“æœåŠ¡å™¨

ansible '(beijing:shanghai):&databases' -m ping

# æ‰€æœ‰ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨ï¼Œé™¤äº†æ­£åœ¨ç»´æŠ¤çš„

ansible 'production:!maintenance' -m ping

# Webæˆ–ç¼“å­˜æœåŠ¡å™¨ï¼Œä¸”æ˜¯é«˜æ€§èƒ½é…ç½®

ansible '(webservers:cache):&high_performance' -m ping
```

### 6.4 å®é™…åº”ç”¨åœºæ™¯



#### ğŸ”¸ è¿ç»´æ“ä½œåœºæ™¯



```bash
# === æ—¥å¸¸ç»´æŠ¤æ“ä½œ ===


# é‡å¯æ‰€æœ‰WebæœåŠ¡å™¨çš„Nginx

ansible webservers -m service -a "name=nginx state=restarted"

# æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒæ‰€æœ‰æœåŠ¡å™¨çš„ç£ç›˜ä½¿ç”¨æƒ…å†µ  

ansible production -m shell -a "df -h"

# æ›´æ–°åŒ—äº¬æœºæˆ¿çš„æ‰€æœ‰æœåŠ¡å™¨

ansible beijing* -m yum -a "name=* state=latest"

# é‡å¯é™¤äº†ä¸»æ•°æ®åº“å¤–çš„æ‰€æœ‰æ•°æ®åº“æœåŠ¡å™¨

ansible 'databases:!db-master' -m service -a "name=mysql state=restarted"
```

#### ğŸ”¸ åº”æ€¥å“åº”åœºæ™¯



```bash
# === ç´§æ€¥æ•…éšœå¤„ç† ===


# ç´§æ€¥å…³é—­æ‰€æœ‰WebæœåŠ¡å™¨çš„æŸä¸ªæœ‰é—®é¢˜çš„æœåŠ¡

ansible 'webservers:!web-primary' -m service -a "name=problematic-service state=stopped"

# æ£€æŸ¥æ‰€æœ‰ç”Ÿäº§æœåŠ¡å™¨çš„è´Ÿè½½æƒ…å†µ

ansible production -m shell -a "uptime"

# åœ¨æ‰€æœ‰ç¼“å­˜æœåŠ¡å™¨ä¸Šæ¸…ç†ç¼“å­˜

ansible 'cache:redis' -m shell -a "redis-cli flushall"

# æ£€æŸ¥ç‰¹å®šæ—¶é—´æ®µå†…åˆ›å»ºçš„æ‰€æœ‰ä¸´æ—¶æœåŠ¡å™¨

ansible '~temp-.*-202[3-4]' -m ping
```

#### ğŸ”¸ æ‰¹é‡é…ç½®åœºæ™¯



```bash
# === æ‰¹é‡é…ç½®ç®¡ç† ===


# ä¸ºæ‰€æœ‰WebæœåŠ¡å™¨éƒ¨ç½²æ–°çš„SSLè¯ä¹¦

ansible-playbook deploy-ssl.yml -l 'webservers:&production'

# åœ¨æ‰€æœ‰æµ‹è¯•ç¯å¢ƒæœåŠ¡å™¨ä¸Šéƒ¨ç½²æµ‹è¯•ç‰ˆæœ¬

ansible-playbook deploy-app.yml -l 'staging:development' -e "version=test"

# ä¸ºé«˜æ€§èƒ½æœåŠ¡å™¨ä¼˜åŒ–å†…æ ¸å‚æ•°  

ansible-playbook optimize-kernel.yml -l 'high_performance'

# åœ¨é™¤äº†æ•°æ®åº“å¤–çš„æ‰€æœ‰æœåŠ¡å™¨ä¸Šå®‰è£…ç›‘æ§ä»£ç†

ansible-playbook install-monitoring.yml -l 'all:!databases'
```

### 6.5 æ¨¡å¼åŒ¹é…æ€§èƒ½ä¼˜åŒ–



#### ğŸ”¸ æå‡åŒ¹é…æ•ˆç‡



```bash
# âœ… é«˜æ•ˆçš„æ¨¡å¼

ansible webservers -m ping                    # ç›´æ¥ç»„åï¼Œæœ€å¿«
ansible 'web[01-10]' -m ping                  # æ˜ç¡®çš„èŒƒå›´åŒ¹é…

# âŒ ä½æ•ˆçš„æ¨¡å¼  

ansible '~web.*' -m ping                      # æ­£åˆ™è¡¨è¾¾å¼ï¼Œè¾ƒæ…¢
ansible 'all:!databases:!cache:!...' -m ping # å¤æ‚æ’é™¤ï¼Œå¾ˆæ…¢
```

#### ğŸ”¸ ç¼“å­˜å’Œä¼˜åŒ–é…ç½®



```ini
# ansible.cfg - æ€§èƒ½ä¼˜åŒ–é…ç½®

[defaults]
# å¯ç”¨ä¸»æœºæ¸…å•ç¼“å­˜

inventory_cache_enabled = True
inventory_cache_plugin = memory
inventory_cache_timeout = 300

# å¹¶è¡Œè¿æ¥æ•°ä¼˜åŒ–

forks = 20

# SSHè¿æ¥ä¼˜åŒ–

ssh_args = -o ControlMaster=auto -o ControlPersist=60s
```

### 6.6 æ¨¡å¼åŒ¹é…è°ƒè¯•æŠ€å·§



#### ğŸ”¸ æµ‹è¯•åŒ¹é…ç»“æœ



```bash
# åˆ—å‡ºåŒ¹é…çš„ä¸»æœºï¼ˆä¸æ‰§è¡Œä»»åŠ¡ï¼‰

ansible --list-hosts 'webservers:&production'

# æ˜¾ç¤ºåŒ¹é…ä¸»æœºçš„è¯¦ç»†ä¿¡æ¯

ansible-inventory --list -l 'webservers:&production'

# åœ¨æ‰§è¡Œå‰é¢„è§ˆå°†è¦æ“ä½œçš„ä¸»æœº

ansible-playbook site.yml -l 'production' --check --diff --list-hosts
```

#### ğŸ”¸ å¸¸è§åŒ¹é…é”™è¯¯è°ƒè¯•



```bash
# è°ƒè¯•æ¨¡å¼åŒ¹é…é—®é¢˜

export ANSIBLE_DEBUG=1
ansible 'complex:pattern:here' -m ping -vvv

# æ£€æŸ¥ä¸»æœºæ˜¯å¦åœ¨é¢„æœŸçš„ç»„ä¸­

ansible-inventory --host web1.example.com

# éªŒè¯å¤æ‚æ¨¡å¼çš„é€»è¾‘

ansible --list-hosts '(webservers:databases):&production:!maintenance'
```

**ğŸ” åŒ¹é…é—®é¢˜æ’æŸ¥æ¸…å•ï¼š**

```
å¸¸è§é—®é¢˜æ£€æŸ¥ï¼š
â–¡ ä¸»æœºåæ‹¼å†™æ˜¯å¦æ­£ç¡®ï¼Ÿ
â–¡ ç»„åæ˜¯å¦å­˜åœ¨äºæ¸…å•ä¸­ï¼Ÿ
â–¡ å¼•å·æ˜¯å¦æ­£ç¡®ä½¿ç”¨ï¼Ÿ
â–¡ ç‰¹æ®Šå­—ç¬¦æ˜¯å¦éœ€è¦è½¬ä¹‰ï¼Ÿ
â–¡ æ­£åˆ™è¡¨è¾¾å¼è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼Ÿ
â–¡ é€»è¾‘è¿ç®—ç¬¦ä¼˜å…ˆçº§æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Ÿ

è°ƒè¯•æ­¥éª¤ï¼š
1. ä½¿ç”¨--list-hostséªŒè¯åŒ¹é…ç»“æœ
2. ç®€åŒ–æ¨¡å¼ï¼Œé€æ­¥å¢åŠ å¤æ‚åº¦
3. æ£€æŸ¥ansible-inventoryè¾“å‡º
4. å¯ç”¨è¯¦ç»†æ—¥å¿—æ¨¡å¼
```

---

## 7. ğŸ“ æ¸…å•æ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶



### 7.1 ç‰ˆæœ¬æ§åˆ¶åŸºæœ¬æ¦‚å¿µ



**ä¸ºä»€ä¹ˆæ¸…å•æ–‡ä»¶éœ€è¦ç‰ˆæœ¬æ§åˆ¶ï¼Ÿ**
> æ¸…å•æ–‡ä»¶çš„å˜æ›´å°±åƒ"æ¬å®¶è®°å½•"ï¼Œè®°å½•äº†è°æ¬åˆ°äº†å“ªé‡Œã€ä»€ä¹ˆæ—¶å€™æ¬çš„ã€‚æ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶ï¼Œå°±åƒæ²¡æœ‰æ¬å®¶è®°å½•ï¼Œæ‰¾ä¸åˆ°æœåŠ¡å™¨æ”¾åœ¨å“ªé‡Œï¼Œä¹Ÿä¸çŸ¥é“è°æ”¹äº†ä»€ä¹ˆã€‚

```
æ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶çš„é£é™©ï¼š
â€¢ ä¸»æœºé…ç½®è¢«æ„å¤–ä¿®æ”¹ï¼Œæ— æ³•è¿½è¸ª
â€¢ å¤šäººåŒæ—¶ä¿®æ”¹ï¼Œäº§ç”Ÿå†²çª
â€¢ ä¸Šçº¿å‡ºé—®é¢˜ï¼Œæ— æ³•å¿«é€Ÿå›æ»š
â€¢ å˜æ›´å†å²ä¸æ¸…æ¥šï¼Œéš¾ä»¥å®¡è®¡

ç‰ˆæœ¬æ§åˆ¶çš„ä»·å€¼ï¼š
â€¢ è®°å½•æ¯æ¬¡å˜æ›´çš„å†…å®¹å’ŒåŸå› 
â€¢ æ”¯æŒå¤šäººåä½œä¿®æ”¹
â€¢ å¿«é€Ÿå›æ»šåˆ°å†å²ç‰ˆæœ¬
â€¢ æä¾›å®Œæ•´çš„å˜æ›´å®¡è®¡é“¾
```

### 7.2 Gitç‰ˆæœ¬æ§åˆ¶æœ€ä½³å®è·µ



#### ğŸ”¸ ä»“åº“ç»“æ„è®¾è®¡



```
æ¨èçš„Gitä»“åº“ç»“æ„ï¼š
ansible-infrastructure/
â”œâ”€â”€ README.md
â”œâ”€â”€ .gitignore
â”œâ”€â”€ ansible.cfg
â”œâ”€â”€ requirements.yml              # ä¾èµ–çš„è§’è‰²å’Œé›†åˆ
â”‚
â”œâ”€â”€ inventories/                  # æ¸…å•ç›®å½•
â”‚   â”œâ”€â”€ production/              # ç”Ÿäº§ç¯å¢ƒ
â”‚   â”‚   â”œâ”€â”€ hosts.yml
â”‚   â”‚   â”œâ”€â”€ group_vars/
â”‚   â”‚   â”‚   â”œâ”€â”€ all/
â”‚   â”‚   â”‚   â”œâ”€â”€ webservers/
â”‚   â”‚   â”‚   â””â”€â”€ databases/
â”‚   â”‚   â””â”€â”€ host_vars/
â”‚   â”‚
â”‚   â”œâ”€â”€ staging/                 # æµ‹è¯•ç¯å¢ƒ
â”‚   â”‚   â”œâ”€â”€ hosts.yml
â”‚   â”‚   â”œâ”€â”€ group_vars/
â”‚   â”‚   â””â”€â”€ host_vars/
â”‚   â”‚
â”‚   â””â”€â”€ development/             # å¼€å‘ç¯å¢ƒ
â”‚       â”œâ”€â”€ hosts.yml
â”‚       â”œâ”€â”€ group_vars/
â”‚       â””â”€â”€ host_vars/
â”‚
â”œâ”€â”€ playbooks/                   # Playbookç›®å½•
â”œâ”€â”€ roles/                       # è§’è‰²ç›®å½•
â””â”€â”€ scripts/                     # è¾…åŠ©è„šæœ¬
```

#### ğŸ”¸ .gitignoreé…ç½®



```bash
# .gitignore - Ansibleé¡¹ç›®å¿½ç•¥æ–‡ä»¶

# ä¸´æ—¶æ–‡ä»¶

*.tmp
*.swp
*.bak
*~

# å¯†é’¥å’Œè¯ä¹¦æ–‡ä»¶

*.pem
*.key
*.crt
id_rsa*
*.p12

# Ansibleç”Ÿæˆçš„æ–‡ä»¶

*.retry
.ansible/
ansible.log

# æ•æ„Ÿé…ç½®æ–‡ä»¶ï¼ˆä½¿ç”¨åŠ å¯†ç‰ˆæœ¬ï¼‰

**/secrets.yml
**/vault.yml
**/passwords.yml

# ä½†åŒ…å«åŠ å¯†çš„vaultæ–‡ä»¶

!**/secrets.vault.yml
!**/vault.vault.yml

# æœ¬åœ°é…ç½®æ–‡ä»¶

local_settings.yml
.env
.local

# IDEæ–‡ä»¶

.vscode/
.idea/
*.sublime-*
```

### 7.3 åˆ†æ”¯ç®¡ç†ç­–ç•¥



#### ğŸ”¸ ç¯å¢ƒåˆ†æ”¯ç­–ç•¥



```bash
# åˆ†æ”¯ç»“æ„

main              # ä¸»åˆ†æ”¯ï¼Œç¨³å®šç‰ˆæœ¬
â”œâ”€â”€ production    # ç”Ÿäº§ç¯å¢ƒåˆ†æ”¯
â”œâ”€â”€ staging       # æµ‹è¯•ç¯å¢ƒåˆ†æ”¯  
â””â”€â”€ development   # å¼€å‘ç¯å¢ƒåˆ†æ”¯

# å·¥ä½œæµç¨‹

git checkout development      # åœ¨å¼€å‘åˆ†æ”¯å¼€å‘æ–°åŠŸèƒ½
# ç¼–è¾‘æ¸…å•æ–‡ä»¶ï¼Œæ·»åŠ æ–°æœåŠ¡å™¨æˆ–ä¿®æ”¹é…ç½®

git add inventories/development/
git commit -m "feat: æ·»åŠ æ–°çš„å¼€å‘ç¯å¢ƒWebæœåŠ¡å™¨"

# æµ‹è¯•é€šè¿‡åï¼Œåˆå¹¶åˆ°staging

git checkout staging
git merge development
git push origin staging

# ç”Ÿäº§éªŒè¯åï¼Œåˆå¹¶åˆ°production  

git checkout production
git merge staging
git push origin production
```

#### ğŸ”¸ åŠŸèƒ½åˆ†æ”¯ç­–ç•¥



```bash
# åˆ›å»ºåŠŸèƒ½åˆ†æ”¯

git checkout -b feature/add-redis-cluster

# ä¿®æ”¹ç›¸å…³æ¸…å•æ–‡ä»¶

# inventories/*/group_vars/cache/redis.yml

# inventories/*/hosts.yml


# æäº¤å˜æ›´

git add .
git commit -m "feat(cache): æ·»åŠ Redisé›†ç¾¤é…ç½®
- æ–°å¢redis-clusterç»„é…ç½®
- æ·»åŠ 6ä¸ªRedisèŠ‚ç‚¹ä¸»æœº
- é…ç½®é›†ç¾¤ç›¸å…³å˜é‡"

# åˆ›å»ºPull Requestè¿›è¡Œä»£ç å®¡æŸ¥

git push origin feature/add-redis-cluster
```

### 7.4 æ•æ„Ÿä¿¡æ¯ç®¡ç†



#### ğŸ”¸ Ansible Vaulté›†æˆ



```bash
# åŠ å¯†æ•æ„Ÿçš„å˜é‡æ–‡ä»¶

ansible-vault encrypt inventories/production/group_vars/all/secrets.yml

# åœ¨Gitä¸­å­˜å‚¨åŠ å¯†åçš„æ–‡ä»¶

git add inventories/production/group_vars/all/secrets.yml
git commit -m "feat: æ·»åŠ ç”Ÿäº§ç¯å¢ƒå¯†é’¥é…ç½®ï¼ˆå·²åŠ å¯†ï¼‰"

# ç¼–è¾‘åŠ å¯†æ–‡ä»¶  

ansible-vault edit inventories/production/group_vars/all/secrets.yml

# æŸ¥çœ‹åŠ å¯†æ–‡ä»¶å†…å®¹

ansible-vault view inventories/production/group_vars/all/secrets.yml
```

**å¯†ç ç®¡ç†ç­–ç•¥ï¼š**

```yaml
# inventories/production/group_vars/all/secrets.yml (åŠ å¯†å‰)

---
# æ•°æ®åº“å¯†ç 

mysql_root_password: "SuperSecretPassword123"
redis_auth_password: "AnotherSecretKey456"

# APIå¯†é’¥

monitoring_api_key: "zabbix-secret-api-key"
cloud_api_secret: "aws-secret-access-key"

# SSLè¯ä¹¦å¯†ç 

ssl_keystore_password: "keystorePassword789"
```

```bash
# .ansible-vault-passwordæ–‡ä»¶ï¼ˆä¸æäº¤åˆ°Gitï¼‰

echo "your-vault-password" > .ansible-vault-password
chmod 600 .ansible-vault-password

# é…ç½®ansible.cfgä½¿ç”¨å¯†ç æ–‡ä»¶

# ansible.cfg

[defaults]
vault_password_file = ./.ansible-vault-password
```

#### ğŸ”¸ å¤šç¯å¢ƒå¯†é’¥ç®¡ç†



```bash
# ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„vaultå¯†ç 

# ç”Ÿäº§ç¯å¢ƒ

export ANSIBLE_VAULT_PASSWORD_FILE=.vault-prod

# æµ‹è¯•ç¯å¢ƒ  

export ANSIBLE_VAULT_PASSWORD_FILE=.vault-staging

# æˆ–è€…åœ¨è¿è¡Œæ—¶æŒ‡å®š

ansible-playbook site.yml -i inventories/production/ --vault-password-file .vault-prod
```

### 7.5 å˜æ›´ç®¡ç†æµç¨‹



#### ğŸ”¸ æ ‡å‡†å˜æ›´æµç¨‹



```bash
# 1. åˆ›å»ºå˜æ›´åˆ†æ”¯

git checkout -b change/update-web-servers-config

# 2. ä¿®æ”¹æ¸…å•æ–‡ä»¶

vim inventories/production/group_vars/webservers/nginx.yml

# 3. éªŒè¯å˜æ›´

ansible-inventory -i inventories/production/ --list
ansible-playbook --syntax-check -i inventories/production/ site.yml

# 4. æäº¤å˜æ›´

git add .
git commit -m "change(webservers): æ›´æ–°Nginx workerè¿›ç¨‹æ•°é…ç½®

Changes:
- å°†worker_processesä»autoè°ƒæ•´ä¸º4
- å¢åŠ worker_connectionsåˆ°2048
- ä¼˜åŒ–å†…å­˜ä½¿ç”¨é…ç½®

Impact: å½±å“æ‰€æœ‰ç”Ÿäº§ç¯å¢ƒWebæœåŠ¡å™¨
Testing: å·²åœ¨stagingç¯å¢ƒéªŒè¯"

# 5. æ¨é€å¹¶åˆ›å»ºPull Request

git push origin change/update-web-servers-config
```

#### ğŸ”¸ å˜æ›´å®¡æŸ¥æ¸…å•



```markdown
# Pull Request Template

# å˜æ›´è¯´æ˜


- [ ] å˜æ›´ç±»å‹ï¼š[ ] æ–°å¢ä¸»æœº [ ] ä¿®æ”¹é…ç½® [ ] åˆ é™¤ä¸»æœº [ ] å…¶ä»–
- [ ] å½±å“ç¯å¢ƒï¼š[ ] ç”Ÿäº§ [ ] æµ‹è¯• [ ] å¼€å‘ [ ] å…¨éƒ¨
- [ ] å½±å“æœåŠ¡ï¼š[ ] Web [ ] æ•°æ®åº“ [ ] ç¼“å­˜ [ ] ç›‘æ§ [ ] å…¶ä»–

# å˜æ›´å†…å®¹


## ä¿®æ”¹çš„æ–‡ä»¶


- `inventories/production/hosts.yml`
- `group_vars/webservers/nginx.yml`

## å˜æ›´è¯¦æƒ…


1. æ–°å¢2å°WebæœåŠ¡å™¨åˆ°ç”Ÿäº§ç¯å¢ƒ
2. æ›´æ–°Nginxé…ç½®å‚æ•°
3. è°ƒæ•´è´Ÿè½½å‡è¡¡å™¨é…ç½®

# æµ‹è¯•éªŒè¯


- [ ] è¯­æ³•æ£€æŸ¥é€šè¿‡ï¼š`ansible-playbook --syntax-check`
- [ ] æ¸…å•éªŒè¯é€šè¿‡ï¼š`ansible-inventory --list`  
- [ ] æµ‹è¯•ç¯å¢ƒéªŒè¯é€šè¿‡
- [ ] å®‰å…¨å®¡æŸ¥é€šè¿‡

# é£é™©è¯„ä¼°


- [ ] ä½é£é™©ï¼ˆé…ç½®å¾®è°ƒï¼‰
- [ ] ä¸­é£é™©ï¼ˆæ–°å¢æœåŠ¡å™¨ï¼‰
- [ ] é«˜é£é™©ï¼ˆæ¶æ„å˜æ›´ï¼‰

# å›æ»šè®¡åˆ’


å¦‚æœéƒ¨ç½²å‡ºç°é—®é¢˜ï¼š
1. å›æ»šåˆ°commit: `abc123def`
2. æ‰§è¡Œå›æ»šplaybook
3. éªŒè¯æœåŠ¡æ­£å¸¸
```

### 7.6 è‡ªåŠ¨åŒ–é›†æˆ



#### ğŸ”¸ CI/CDé›†æˆé…ç½®



```yaml
# .github/workflows/inventory-validation.yml

name: æ¸…å•æ–‡ä»¶éªŒè¯

on:
  pull_request:
    paths:
      - 'inventories/**'
      - 'group_vars/**'
      - 'host_vars/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: å®‰è£…Ansible
        run: |
          python -m pip install ansible
          
      - name: è¯­æ³•æ£€æŸ¥
        run: |
          for env in production staging development; do
            echo "æ£€æŸ¥ $env ç¯å¢ƒ..."
            ansible-inventory -i inventories/$env/ --list > /dev/null
            ansible-playbook --syntax-check -i inventories/$env/ site.yml
          done
          
      - name: å®‰å…¨æ£€æŸ¥
        run: |
#          # æ£€æŸ¥æ˜¯å¦æœ‰æœªåŠ å¯†çš„æ•æ„Ÿä¿¡æ¯
          if grep -r "password\|secret\|key" inventories/ --include="*.yml" | grep -v vault; then
            echo "å‘ç°æœªåŠ å¯†çš„æ•æ„Ÿä¿¡æ¯ï¼"
            exit 1
          fi
          
      - name: å˜æ›´å½±å“åˆ†æ
        run: |
#          # åˆ†ææ­¤æ¬¡å˜æ›´å½±å“çš„ä¸»æœºæ•°é‡
          python scripts/analyze-inventory-changes.py
```

#### ğŸ”¸ è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬



```bash
#!/bin/bash

# scripts/deploy-inventory-changes.sh


set -e

ENVIRONMENT=${1:-staging}
BRANCH=${2:-main}

echo "=== éƒ¨ç½²æ¸…å•å˜æ›´åˆ° $ENVIRONMENT ç¯å¢ƒ ==="

# 1. æ‹‰å–æœ€æ–°ä»£ç 

git fetch origin
git checkout $BRANCH
git pull origin $BRANCH

# 2. éªŒè¯æ¸…å•æ–‡ä»¶

echo "éªŒè¯æ¸…å•æ–‡ä»¶..."
ansible-inventory -i inventories/$ENVIRONMENT/ --list > /dev/null

# 3. å¤‡ä»½å½“å‰é…ç½®

echo "å¤‡ä»½å½“å‰é…ç½®..."
mkdir -p backups/$(date +%Y%m%d_%H%M%S)
cp -r inventories/$ENVIRONMENT/ backups/$(date +%Y%m%d_%H%M%S)/

# 4. åº”ç”¨å˜æ›´

echo "åº”ç”¨æ¸…å•å˜æ›´..."
ansible-playbook -i inventories/$ENVIRONMENT/ \
    playbooks/update-inventory.yml \
    --check --diff

# 5. ç¡®è®¤éƒ¨ç½²

read -p "ç¡®è®¤è¦åº”ç”¨ä»¥ä¸Šå˜æ›´å—ï¼Ÿ(y/N) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    ansible-playbook -i inventories/$ENVIRONMENT/ \
        playbooks/update-inventory.yml
    echo "éƒ¨ç½²å®Œæˆï¼"
else
    echo "éƒ¨ç½²å·²å–æ¶ˆ"
    exit 1
fi
```

### 7.7 ç‰ˆæœ¬æ§åˆ¶æœ€ä½³å®è·µ



**ğŸ¯ æäº¤ä¿¡æ¯è§„èŒƒ**

```bash
# ä½¿ç”¨çº¦å®šå¼æäº¤æ ¼å¼

feat(hosts): æ·»åŠ æ–°çš„WebæœåŠ¡å™¨åˆ°ç”Ÿäº§ç¯å¢ƒ
fix(vars): ä¿®å¤æ•°æ®åº“è¿æ¥é…ç½®é”™è¯¯  
change(groups): é‡æ„ä¸»æœºåˆ†ç»„ç»“æ„
docs(readme): æ›´æ–°æ¸…å•ç®¡ç†æ–‡æ¡£
```

**ğŸ“‹ ä»£ç å®¡æŸ¥è¦ç‚¹**

```
å®¡æŸ¥æ£€æŸ¥æ¸…å•ï¼š
â–¡ ä¸»æœºåå‘½åæ˜¯å¦ç¬¦åˆè§„èŒƒï¼Ÿ
â–¡ IPåœ°å€æ˜¯å¦æ­£ç¡®ä¸”æ— é‡å¤ï¼Ÿ
â–¡ å˜é‡å®šä¹‰æ˜¯å¦å®Œæ•´ï¼Ÿ
â–¡ æ•æ„Ÿä¿¡æ¯æ˜¯å¦å·²åŠ å¯†ï¼Ÿ
â–¡ åˆ†ç»„é€»è¾‘æ˜¯å¦åˆç†ï¼Ÿ
â–¡ å˜æ›´æ˜¯å¦ç»è¿‡æµ‹è¯•éªŒè¯ï¼Ÿ
â–¡ å½±å“èŒƒå›´æ˜¯å¦æ˜ç¡®ï¼Ÿ
â–¡ å›æ»šæ–¹æ¡ˆæ˜¯å¦å¯è¡Œï¼Ÿ
```

**ğŸ”„ ç‰ˆæœ¬æ ‡ç­¾ç­–ç•¥**

```bash
# å‘å¸ƒç‰ˆæœ¬æ ‡ç­¾

git tag -a v1.0.0 -m "ç”Ÿäº§ç¯å¢ƒæ¸…å•v1.0.0
- å®Œæˆåˆå§‹ä¸»æœºæ¸…å•é…ç½®
- åŒ…å«50å°ç”Ÿäº§æœåŠ¡å™¨
- æ”¯æŒ3ä¸ªç¯å¢ƒçš„å®Œæ•´é…ç½®"

git tag -a v1.1.0 -m "æ¸…å•é…ç½®v1.1.0  
- æ–°å¢Redisé›†ç¾¤é…ç½®
- ä¼˜åŒ–ä¸»æœºåˆ†ç»„ç»“æ„
- å¢åŠ ç›‘æ§æœåŠ¡å™¨ç»„"

# æ¨é€æ ‡ç­¾

git push origin --tags

# åŸºäºæ ‡ç­¾åˆ›å»ºåˆ†æ”¯

git checkout -b hotfix/v1.0.1 v1.0.0
```

---

## 8. ğŸš€ å¤§è§„æ¨¡ä¸»æœºç®¡ç†ç­–ç•¥



### 8.1 å¤§è§„æ¨¡ç®¡ç†åŸºæœ¬æ¦‚å¿µ



**ä»€ä¹ˆæ˜¯å¤§è§„æ¨¡ä¸»æœºç®¡ç†ï¼Ÿ**
> å¤§è§„æ¨¡ä¸»æœºç®¡ç†å°±åƒ"ç®¡ç†ä¸€ä¸ªå¤§åŸå¸‚"ï¼Œéœ€è¦åˆç†çš„åŒºåŸŸè§„åˆ’ã€é«˜æ•ˆçš„äº¤é€šç³»ç»Ÿã€ç»Ÿä¸€çš„ç®¡ç†åˆ¶åº¦ã€‚å½“æœåŠ¡å™¨æ•°é‡è¶…è¿‡å‡ ç™¾å°æ—¶ï¼Œä¼ ç»Ÿçš„ç®¡ç†æ–¹å¼å°±ä¸å¤Ÿç”¨äº†ã€‚

```
è§„æ¨¡å¯¹æ¯”ï¼š
å°è§„æ¨¡ (< 50å°)ï¼š
â€¢ ç®€å•åˆ—è¡¨å³å¯
â€¢ æ‰‹å·¥ç»´æŠ¤å¯è¡Œ
â€¢ å•ä¸€ç®¡ç†å‘˜

ä¸­è§„æ¨¡ (50-500å°)ï¼š
â€¢ éœ€è¦åˆ†ç»„ç®¡ç†
â€¢ åŠè‡ªåŠ¨åŒ–ç»´æŠ¤
â€¢ å°å›¢é˜Ÿåä½œ

å¤§è§„æ¨¡ (> 500å°)ï¼š
â€¢ å¿…é¡»å±‚æ¬¡åŒ–ç®¡ç†
â€¢ å…¨è‡ªåŠ¨åŒ–è¿ç»´
â€¢ å¤šå›¢é˜Ÿåä½œ
â€¢ éœ€è¦ä¸“ä¸šå·¥å…·å’Œæµç¨‹
```

### 8.2 åˆ†å±‚åˆ†åŒºç®¡ç†ç­–ç•¥



#### ğŸ”¸ åœ°ç†åˆ†åŒºç®¡ç†



```yaml
# å…¨çƒåŒ–éƒ¨ç½²çš„åˆ†åŒºæ¸…å•ç»“æ„

all:
  children:
#    # === ä¸€çº§åˆ†åŒºï¼šå¤§æ´² ===
    asia_pacific:
      vars:
        region: "APAC"
        backup_region: "us_west"
      children:
#        # === äºŒçº§åˆ†åŒºï¼šå›½å®¶/åœ°åŒº ===
        china:
          vars:
            country: "CN"
            compliance: "china_cyber_security_law"
          children:
#            # === ä¸‰çº§åˆ†åŒºï¼šåŸå¸‚ ===
            beijing:
              vars:
                city: "beijing"
                datacenter_prefix: "bjdc"
                timezone: "Asia/Shanghai"
              children:
#                # === å››çº§åˆ†åŒºï¼šæœºæˆ¿ ===
                beijing_dc1:
                  vars:
                    datacenter: "bjdc1"
                    rack_prefix: "bj1-rack"
                  children:
#                    # === äº”çº§åˆ†åŒºï¼šæœåŠ¡ç±»å‹ ===
                    bjdc1_web:
                      hosts:
                        bjdc1-web-001: {ansible_host: "192.168.1.10", rack: "bj1-rack-01"}
                        bjdc1-web-002: {ansible_host: "192.168.1.11", rack: "bj1-rack-01"}
#                        # ... æ›´å¤šWebæœåŠ¡å™¨
                    bjdc1_db:
                      hosts:
                        bjdc1-db-001: {ansible_host: "192.168.1.20", rack: "bj1-rack-02"}
#                        # ... æ•°æ®åº“æœåŠ¡å™¨
```

è¿™ç§åˆ†å±‚ç»“æ„çš„ä¼˜åŠ¿ï¼š
- **åœ°åŸŸä¼˜åŒ–**ï¼šä¸åŒåœ°åŒºä½¿ç”¨æœ€ä¼˜é…ç½®
- **åˆè§„ç®¡ç†**ï¼šæ»¡è¶³å½“åœ°æ³•è§„è¦æ±‚  
- **æ•…éšœéš”ç¦»**ï¼šå•ä¸ªåŒºåŸŸæ•…éšœä¸å½±å“å…¨å±€
- **æ‰©å±•æ€§å¼º**ï¼šæ˜“äºæ·»åŠ æ–°çš„åœ°åŒºå’Œæœºæˆ¿

#### ğŸ”¸ ä¸šåŠ¡åˆ†åŒºç®¡ç†



```yaml
# æŒ‰ä¸šåŠ¡çº¿åˆ†åŒºçš„æ¸…å•ç»“æ„  

all:
  children:
#    # === æ ¸å¿ƒä¸šåŠ¡ ===
    core_business:
      vars:
        priority: "critical"
        sla: "99.99%"
        backup_frequency: "every_hour"
      children:
        user_service:
          vars:
            service: "user_management" 
            port: 8080
          hosts:
            user-api-01: {ansible_host: "10.1.1.10"}
            user-api-02: {ansible_host: "10.1.1.11"}
            
        payment_service:
          vars:
            service: "payment_processing"
            port: 8081
            encryption_required: true
          hosts:
            payment-api-01: {ansible_host: "10.1.2.10"}
            payment-api-02: {ansible_host: "10.1.2.11"}
    
#    # === æ”¯æ’‘ä¸šåŠ¡ ===        
    support_business:
      vars:
        priority: "high"
        sla: "99.9%"
      children:
        notification_service:
          hosts:
            notify-01: {ansible_host: "10.2.1.10"}
            notify-02: {ansible_host: "10.2.1.11"}
            
        analytics_service:
          hosts:
            analytics-01: {ansible_host: "10.2.2.10"}
```

### 8.3 åŠ¨æ€æ¸…å•è‡ªåŠ¨åŒ–



#### ğŸ”¸ å¤šæ•°æ®æºèšåˆ



```python
#!/usr/bin/env python3

# scripts/enterprise_inventory.py - ä¼ä¸šçº§åŠ¨æ€æ¸…å•


import json
import yaml
import requests
from concurrent.futures import ThreadPoolExecutor
import logging

class EnterpriseInventory:
    def __init__(self):
        self.inventory = {
            '_meta': {'hostvars': {}},
            'all': {'children': []}
        }
        
    def get_cmdb_hosts(self):
        """ä»CMDBç³»ç»Ÿè·å–ä¸»æœºä¿¡æ¯"""
        try:
            response = requests.get('http://cmdb.example.com/api/servers')
            servers = response.json()
            
            for server in servers:
                self.add_host_to_inventory(
                    hostname=server['hostname'],
                    groups=[server['environment'], server['service_type']],
                    variables={
                        'ansible_host': server['ip_address'],
                        'server_role': server['role'],
                        'datacenter': server['datacenter'],
                        'owner': server['owner_team']
                    }
                )
        except Exception as e:
            logging.error(f"CMDBè·å–å¤±è´¥: {e}")
    
    def get_cloud_hosts(self):
        """ä»äº‘å¹³å°è·å–ä¸»æœºä¿¡æ¯"""
#        # AWS EC2
        self.get_aws_ec2_hosts()
#        # Azure VMs  
        self.get_azure_vm_hosts()
#        # é˜¿é‡Œäº‘ECS
        self.get_aliyun_ecs_hosts()
        
    def get_monitoring_hosts(self):
        """ä»ç›‘æ§ç³»ç»Ÿè·å–åœ¨çº¿ä¸»æœº"""
        try:
#            # ä»Zabbixè·å–åœ¨çº¿ä¸»æœºåˆ—è¡¨
            zabbix_hosts = self.query_zabbix_hosts()
            
#            # æ ‡è®°åœ¨çº¿çŠ¶æ€
            for hostname in zabbix_hosts:
                if hostname in self.inventory['_meta']['hostvars']:
                    self.inventory['_meta']['hostvars'][hostname]['online_status'] = 'active'
                    
        except Exception as e:
            logging.error(f"ç›‘æ§æ•°æ®è·å–å¤±è´¥: {e}")
    
    def add_host_to_inventory(self, hostname, groups, variables):
        """æ·»åŠ ä¸»æœºåˆ°æ¸…å•"""
#        # åˆ›å»ºç»„
        for group in groups:
            if group not in self.inventory:
                self.inventory[group] = {'hosts': []}
                if group not in self.inventory['all']['children']:
                    self.inventory['all']['children'].append(group)
            
            self.inventory[group]['hosts'].append(hostname)
        
#        # æ·»åŠ ä¸»æœºå˜é‡
        self.inventory['_meta']['hostvars'][hostname] = variables
    
    def apply_business_rules(self):
        """åº”ç”¨ä¸šåŠ¡è§„åˆ™è¿›è¡Œåˆ†ç»„"""
#        # æŒ‰æ•°æ®ä¸­å¿ƒåˆ†ç»„
        self.group_by_datacenter()
        
#        # æŒ‰ä¸šåŠ¡çº¿åˆ†ç»„
        self.group_by_business_line()
        
#        # æŒ‰è´Ÿè½½æ°´å¹³åˆ†ç»„
        self.group_by_load_level()
    
    def generate_inventory(self):
        """ç”Ÿæˆå®Œæ•´æ¸…å•"""
        with ThreadPoolExecutor(max_workers=10) as executor:
#            # å¹¶è¡Œè·å–å¤šä¸ªæ•°æ®æº
            futures = [
                executor.submit(self.get_cmdb_hosts),
                executor.submit(self.get_cloud_hosts),
                executor.submit(self.get_monitoring_hosts)
            ]
            
#            # ç­‰å¾…æ‰€æœ‰æ•°æ®æºå®Œæˆ
            for future in futures:
                future.result()
        
#        # åº”ç”¨ä¸šåŠ¡è§„åˆ™
        self.apply_business_rules()
        
        return self.inventory

if __name__ == '__main__':
    inventory = EnterpriseInventory()
    result = inventory.generate_inventory()
    print(json.dumps(result, indent=2))
```

#### ğŸ”¸ æ¸…å•ç¼“å­˜å’Œæ›´æ–°ç­–ç•¥



```yaml
# inventory_config.yml - æ¸…å•é…ç½®æ–‡ä»¶

cache:
  enabled: true
  ttl: 300  # 5åˆ†é’Ÿç¼“å­˜
  backend: "redis"
  redis_url: "redis://cache.example.com:6379/0"

data_sources:
  cmdb:
    url: "http://cmdb.example.com/api"
    timeout: 30
    retry: 3
    
  aws:
    regions: ["us-west-1", "us-west-2", "ap-southeast-1"]
    profile: "ansible"
    
  azure:
    subscription_id: "xxx-xxx-xxx"
    resource_groups: ["production", "staging"]
    
update_schedule:
  full_refresh: "0 */6 * * *"    # æ¯6å°æ—¶å…¨é‡æ›´æ–°
  incremental: "*/5 * * * *"     # æ¯5åˆ†é’Ÿå¢é‡æ›´æ–°
```

### 8.4 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥



#### ğŸ”¸ å¹¶å‘è¿æ¥ä¼˜åŒ–



```ini
# ansible.cfg - å¤§è§„æ¨¡ç¯å¢ƒä¼˜åŒ–é…ç½®

[defaults]
# å¤§å¹…å¢åŠ å¹¶å‘è¿æ¥æ•°

forks = 100

# ä¼˜åŒ–SSHè¿æ¥

ssh_args = -o ControlMaster=auto -o ControlPersist=300s -o ControlPath=/tmp/ansible-ssh-%h-%p-%r

# å¯ç”¨SSHç®¡é“æ¨¡å¼

pipelining = True

# å‡å°‘gather_factså¼€é”€

gathering = smart
fact_caching = redis
fact_caching_connection = redis://localhost:6379/1
fact_caching_timeout = 3600

[ssh_connection]
# SSHè¿æ¥ä¼˜åŒ–

ssh_args = -o PreferredAuthentications=publickey -o ControlMaster=auto -o ControlPersist=300s
control_path_dir = /tmp/ansible-control
retries = 3
```

#### ğŸ”¸ æ‰¹é‡æ“ä½œç­–ç•¥



```bash
#!/bin/bash

# scripts/batch_operations.sh - æ‰¹é‡æ“ä½œè„šæœ¬


# åˆ†æ‰¹æ¬¡æ‰§è¡Œï¼Œé¿å…åŒæ—¶æ“ä½œè¿‡å¤šä¸»æœº

BATCH_SIZE=50
TOTAL_HOSTS=$(ansible all --list-hosts | wc -l)
BATCHES=$((TOTAL_HOSTS / BATCH_SIZE + 1))

echo "æ€»è®¡ $TOTAL_HOSTS å°ä¸»æœºï¼Œåˆ† $BATCHES æ‰¹æ¬¡æ‰§è¡Œ"

for i in $(seq 1 $BATCHES); do
    START=$(((i-1) * BATCH_SIZE + 1))
    END=$((i * BATCH_SIZE))
    
    echo "æ‰§è¡Œç¬¬ $i æ‰¹æ¬¡ (ä¸»æœº $START-$END)..."
    
#    # ä½¿ç”¨--limité™åˆ¶æ‰¹æ¬¡å¤§å°
    ansible all -m ping --limit "all[${START}:${END}]"
    
#    # æ‰¹æ¬¡é—´æš‚åœï¼Œé¿å…ç³»ç»Ÿè¿‡è½½
    sleep 10
done
```

#### ğŸ”¸ æ™ºèƒ½ä»»åŠ¡è°ƒåº¦



```yaml
# playbooks/smart_deployment.yml - æ™ºèƒ½éƒ¨ç½²ç­–ç•¥

---
- name: æ™ºèƒ½æ‰¹é‡éƒ¨ç½²
  hosts: all
  serial: "30%"  # æ¯æ¬¡æ“ä½œ30%çš„ä¸»æœº
  max_fail_percentage: 5  # å¤±è´¥ç‡è¶…è¿‡5%åˆ™åœæ­¢
  
  pre_tasks:
    - name: æ£€æŸ¥ä¸»æœºçŠ¶æ€
      ping:
      register: ping_result
      
    - name: è·³è¿‡ç¦»çº¿ä¸»æœº
      meta: end_host
      when: ping_result is failed
      
  tasks:
    - name: æŒ‰ä¼˜å…ˆçº§åˆ†ç»„éƒ¨ç½²
      include_tasks: "{{ item }}"
      loop:
        - deploy_critical_services.yml
        - deploy_standard_services.yml  
        - deploy_optional_services.yml
      when: 
        - inventory_hostname in groups[item.split('_')[1] + '_servers']
```

### 8.5 ç›‘æ§å’Œå‘Šè­¦



#### ğŸ”¸ æ¸…å•å¥åº·ç›‘æ§



```python
#!/usr/bin/env python3

# scripts/inventory_health_check.py - æ¸…å•å¥åº·æ£€æŸ¥


import ansible.inventory.manager
import ansible.parsing.dataloader
import ansible.vars.manager
from collections import defaultdict
import json

class InventoryHealthChecker:
    def __init__(self, inventory_path):
        self.loader = ansible.parsing.dataloader.DataLoader()
        self.inventory = ansible.inventory.manager.InventoryManager(
            loader=self.loader,
            sources=inventory_path
        )
        self.variable_manager = ansible.vars.manager.VariableManager(
            loader=self.loader,
            inventory=self.inventory
        )
        
    def check_duplicate_hosts(self):
        """æ£€æŸ¥é‡å¤ä¸»æœº"""
        host_counts = defaultdict(int)
        for host in self.inventory.get_hosts():
            host_counts[host.name] += 1
            
        duplicates = {host: count for host, count in host_counts.items() if count > 1}
        return duplicates
        
    def check_missing_variables(self):
        """æ£€æŸ¥ç¼ºå¤±çš„å¿…éœ€å˜é‡"""
        required_vars = ['ansible_host', 'environment', 'role']
        missing_vars = {}
        
        for host in self.inventory.get_hosts():
            host_vars = self.variable_manager.get_vars(host=host)
            missing = [var for var in required_vars if var not in host_vars]
            if missing:
                missing_vars[host.name] = missing
                
        return missing_vars
        
    def check_unreachable_hosts(self):
        """æ£€æŸ¥ä¸å¯è¾¾ä¸»æœº"""
#        # è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„è¿é€šæ€§æµ‹è¯•
        unreachable = []
#        # å®ç°pingæµ‹è¯•æˆ–SSHè¿æ¥æµ‹è¯•
        return unreachable
        
    def generate_health_report(self):
        """ç”Ÿæˆå¥åº·æŠ¥å‘Š"""
        report = {
            'timestamp': datetime.now().isoformat(),
            'total_hosts': len(self.inventory.get_hosts()),
            'total_groups': len(self.inventory.groups),
            'issues': {
                'duplicate_hosts': self.check_duplicate_hosts(),
                'missing_variables': self.check_missing_variables(),
                'unreachable_hosts': self.check_unreachable_hosts()
            }
        }
        return report

# å®šæœŸå¥åº·æ£€æŸ¥

if __name__ == '__main__':
    checker = InventoryHealthChecker('/etc/ansible/hosts')
    report = checker.generate_health_report()
    
#    # å‘é€å‘Šè­¦
    if any(report['issues'].values()):
        send_alert(report)
    
    print(json.dumps(report, indent=2))
```

#### ğŸ”¸ å®¹é‡è§„åˆ’ç›‘æ§



```bash
#!/bin/bash

# scripts/capacity_monitoring.sh - å®¹é‡ç›‘æ§è„šæœ¬


# ç»Ÿè®¡å„ç±»æœåŠ¡å™¨æ•°é‡

echo "=== ä¸»æœºå®¹é‡ç»Ÿè®¡ ==="
echo "WebæœåŠ¡å™¨: $(ansible webservers --list-hosts | wc -l) å°"
echo "æ•°æ®åº“æœåŠ¡å™¨: $(ansible databases --list-hosts | wc -l) å°"  
echo "ç¼“å­˜æœåŠ¡å™¨: $(ansible cache --list-hosts | wc -l) å°"

# æ£€æŸ¥èµ„æºä½¿ç”¨æƒ…å†µ

echo "=== èµ„æºä½¿ç”¨åˆ†æ ==="
ansible all -m setup -a "filter=ansible_memory_mb,ansible_processor_count" | \
grep -E "ansible_memory_mb|ansible_processor_count" | \
awk '{print $2}' | sort -n | tail -10

# é¢„è­¦é˜ˆå€¼æ£€æŸ¥

HIGH_LOAD_THRESHOLD=80
ansible all -m shell -a "top -bn1 | grep 'load average' | awk '{print \$10}'" | \
grep -v "SUCCESS" | \
while read load; do
    if (( $(echo "$load > $HIGH_LOAD_THRESHOLD" | bc -l) )); then
        echo "è­¦å‘Šï¼šå‘ç°é«˜è´Ÿè½½æœåŠ¡å™¨ï¼Œè´Ÿè½½å€¼: $load"
    fi
done
```

### 8.6 å¤§è§„æ¨¡ç®¡ç†æœ€ä½³å®è·µ



**ğŸ¯ æ¶æ„è®¾è®¡åŸåˆ™**

```
åˆ†å±‚ç®¡ç†åŸåˆ™ï¼š
â€¢ åœ°ç†ä½ç½® â†’ ä¸šåŠ¡çº¿ â†’ ç¯å¢ƒ â†’ æœåŠ¡ç±»å‹ â†’ å…·ä½“ä¸»æœº
â€¢ æ¯å±‚èŒè´£æ˜ç¡®ï¼Œé¿å…äº¤å‰è€¦åˆ

è‡ªåŠ¨åŒ–ä¼˜å…ˆåŸåˆ™ï¼š  
â€¢ èƒ½è‡ªåŠ¨åŒ–çš„ç»ä¸æ‰‹å·¥
â€¢ æ•°æ®é©±åŠ¨é…ç½®ç”Ÿæˆ
â€¢ å¼‚å¸¸è‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤

å¯è§‚æµ‹æ€§åŸåˆ™ï¼š
â€¢ å…¨é¢ç›‘æ§æ¸…å•çŠ¶æ€
â€¢ åŠæ—¶å‘ç°å¼‚å¸¸å’Œæ¼‚ç§»
â€¢ å®Œæ•´çš„å˜æ›´å®¡è®¡é“¾

å®¹é”™è®¾è®¡åŸåˆ™ï¼š
â€¢ å•ç‚¹æ•…éšœä¸å½±å“æ•´ä½“
â€¢ åˆ†æ‰¹æ¬¡æ“ä½œé™ä½é£é™©
â€¢ å¿«é€Ÿå›æ»šæœºåˆ¶
```

**ğŸ“Š è§„æ¨¡åŒ–æŒ‡æ ‡**

| è§„æ¨¡ç­‰çº§ | ä¸»æœºæ•°é‡ | æ¨èç­–ç•¥ | å…³é”®å·¥å…· |
|----------|----------|----------|----------|
| **å°è§„æ¨¡** | < 50 | é™æ€æ¸…å• + ç®€å•åˆ†ç»„ | æ‰‹å·¥ç»´æŠ¤ |
| **ä¸­è§„æ¨¡** | 50-500 | åŠåŠ¨æ€æ¸…å• + å±‚æ¬¡åˆ†ç»„ | CMDB + è‡ªåŠ¨åŒ–è„šæœ¬ |
| **å¤§è§„æ¨¡** | 500-5000 | åŠ¨æ€æ¸…å• + æ™ºèƒ½åˆ†ç»„ | å¤šæ•°æ®æºèšåˆ + ä¸“ä¸šç›‘æ§ |
| **è¶…å¤§è§„æ¨¡** | > 5000 | åˆ†å¸ƒå¼ç®¡ç† + AIè¾…åŠ© | å¾®æœåŠ¡æ¶æ„ + æœºå™¨å­¦ä¹  |

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ é™æ€æ¸…å•ï¼šINIå’ŒYAMLæ ¼å¼çš„ä¸»æœºåˆ—è¡¨ï¼Œé€‚åˆç¨³å®šç¯å¢ƒ
ğŸ”¸ åŠ¨æ€æ¸…å•ï¼šä»å¤–éƒ¨ç³»ç»Ÿè‡ªåŠ¨è·å–ä¸»æœºä¿¡æ¯ï¼Œé€‚åˆäº‘ç¯å¢ƒ
ğŸ”¸ ä¸»æœºåˆ†ç»„ï¼šæŒ‰åŠŸèƒ½ã€ç¯å¢ƒã€åœ°åŸŸç­‰ç»´åº¦ç»„ç»‡ä¸»æœº
ğŸ”¸ å˜é‡ç®¡ç†ï¼šä¸»æœºå˜é‡ã€ç»„å˜é‡çš„å®šä¹‰å’Œç»§æ‰¿æœºåˆ¶  
ğŸ”¸ æ¨¡å¼åŒ¹é…ï¼šé€šé…ç¬¦ã€æ­£åˆ™è¡¨è¾¾å¼é€‰æ‹©ä¸»æœºçš„è¯­æ³•
ğŸ”¸ ç‰ˆæœ¬æ§åˆ¶ï¼šæ¸…å•æ–‡ä»¶çš„Gitç®¡ç†å’Œå˜æ›´æµç¨‹
ğŸ”¸ è§„æ¨¡åŒ–ç®¡ç†ï¼šå¤§é‡ä¸»æœºçš„åˆ†å±‚ç®¡ç†å’Œè‡ªåŠ¨åŒ–ç­–ç•¥
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ æ¸…å•æ–‡ä»¶æ ¼å¼é€‰æ‹©**
```
INIæ ¼å¼é€‚ç”¨åœºæ™¯ï¼š
â€¢ ç®€å•çš„ä¸»æœºåˆ—è¡¨
â€¢ ä¼ ç»Ÿè¿ç»´ç¯å¢ƒ
â€¢ å¿«é€Ÿæ­å»ºæµ‹è¯•

YAMLæ ¼å¼é€‚ç”¨åœºæ™¯ï¼š  
â€¢ å¤æ‚çš„å˜é‡ç»“æ„
â€¢ ç°ä»£DevOpsç¯å¢ƒ
â€¢ éœ€è¦è‰¯å¥½å¯è¯»æ€§
```

**ğŸ”¹ åˆ†ç»„ç­–ç•¥è®¾è®¡æ€è·¯**
```
åŠŸèƒ½åˆ†ç»„ï¼šæŒ‰æœåŠ¡è§’è‰²åˆ’åˆ†ï¼ˆwebã€dbã€cacheï¼‰
ç¯å¢ƒåˆ†ç»„ï¼šæŒ‰éƒ¨ç½²é˜¶æ®µåˆ’åˆ†ï¼ˆprodã€stagingã€devï¼‰
åœ°åŸŸåˆ†ç»„ï¼šæŒ‰ç‰©ç†ä½ç½®åˆ’åˆ†ï¼ˆbeijingã€shanghaiï¼‰
ä¸šåŠ¡åˆ†ç»„ï¼šæŒ‰ä¸šåŠ¡çº¿åˆ’åˆ†ï¼ˆuser-serviceã€paymentï¼‰

ç»„åˆä½¿ç”¨ï¼šprod_bj_web = ç”Ÿäº§ç¯å¢ƒ + åŒ—äº¬ + WebæœåŠ¡å™¨
```

**ğŸ”¹ å˜é‡ç»§æ‰¿æœºåˆ¶**
```
å˜é‡ä¼˜å…ˆçº§ï¼ˆé«˜åˆ°ä½ï¼‰ï¼š
ä¸»æœºå˜é‡ â†’ å­ç»„å˜é‡ â†’ çˆ¶ç»„å˜é‡ â†’ å…¨å±€å˜é‡

ç»§æ‰¿åŸåˆ™ï¼š
â€¢ å­ç»„ç»§æ‰¿çˆ¶ç»„å˜é‡
â€¢ åŒåå˜é‡ä¼šè¢«è¦†ç›–
â€¢ åˆ—è¡¨å˜é‡ä¸ä¼šåˆå¹¶
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼



**ğŸ¯ ä¸åŒåœºæ™¯çš„æ¸…å•ç­–ç•¥**

```
åˆ›ä¸šå…¬å¸ï¼ˆ< 20å°ï¼‰ï¼š
â€¢ å•ä¸ªhosts.ymlæ–‡ä»¶
â€¢ ç®€å•çš„åŠŸèƒ½åˆ†ç»„
â€¢ æ‰‹å·¥ç»´æŠ¤å³å¯

æˆé•¿æœŸä¼ä¸šï¼ˆ20-200å°ï¼‰ï¼š
â€¢ å¤šç¯å¢ƒæ¸…å•åˆ†ç¦»
â€¢ group_varsç›®å½•ç®¡ç†  
â€¢ åŠè‡ªåŠ¨åŒ–æ›´æ–°

å¤§å‹ä¼ä¸šï¼ˆ> 200å°ï¼‰ï¼š
â€¢ åŠ¨æ€æ¸…å•ç”Ÿæˆ
â€¢ å¤šæ•°æ®æºé›†æˆ
â€¢ å…¨è‡ªåŠ¨åŒ–ç®¡ç†
```

**ğŸ¯ è¿ç»´æ“ä½œæœ€ä½³å®è·µ**

```bash
æ—¥å¸¸æ“ä½œï¼š
# æ£€æŸ¥ä¸»æœºçŠ¶æ€

ansible all -m ping

# æŸ¥çœ‹ç‰¹å®šç»„çš„ä¸»æœº

ansible webservers --list-hosts

# æ¨¡å¼åŒ¹é…é€‰æ‹©ä¸»æœº

ansible 'prod*:!maintenance' -m shell -a 'uptime'

æ‰¹é‡é…ç½®ï¼š
# æ›´æ–°ç‰¹å®šç¯å¢ƒ

ansible-playbook -i production/ site.yml -l webservers

# ç´§æ€¥æ“ä½œï¼ˆæ’é™¤å…³é”®æœåŠ¡å™¨ï¼‰

ansible 'all:!critical' -m service -a 'name=nginx state=restarted'
```

### 9.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ



**ğŸ”§ å…¸å‹é—®é¢˜å¤„ç†**

```
ä¸»æœºæ— æ³•è¿æ¥ï¼š
1. æ£€æŸ¥ansible_hostæ˜¯å¦æ­£ç¡®
2. éªŒè¯SSHå¯†é’¥é…ç½®
3. ç¡®è®¤ç½‘ç»œè¿é€šæ€§
4. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

å˜é‡ä¸ç”Ÿæ•ˆï¼š
1. ç¡®è®¤å˜é‡å®šä¹‰ä½ç½®
2. æ£€æŸ¥å˜é‡ä¼˜å…ˆçº§  
3. éªŒè¯æ–‡ä»¶æ ¼å¼è¯­æ³•
4. æŸ¥çœ‹å˜é‡ç»§æ‰¿é“¾

åˆ†ç»„ä¸æ­£ç¡®ï¼š
1. éªŒè¯ä¸»æœºæ˜¯å¦åœ¨é¢„æœŸç»„ä¸­
2. æ£€æŸ¥ç»„ç»§æ‰¿å…³ç³»
3. ç¡®è®¤æ¨¡å¼åŒ¹é…è¯­æ³•
4. æŸ¥çœ‹æ¸…å•è§£æç»“æœ
```

### 9.5 è¿›é˜¶ä¼˜åŒ–å»ºè®®



**ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**

```
å°è§„æ¨¡ä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨SSHå¯†é’¥è®¤è¯
â€¢ å¯ç”¨SSHè¿æ¥å¤ç”¨
â€¢ åˆç†è®¾ç½®å¹¶å‘æ•°

å¤§è§„æ¨¡ä¼˜åŒ–ï¼š
â€¢ å®æ–½åŠ¨æ€æ¸…å•
â€¢ å¯ç”¨æ¸…å•ç¼“å­˜
â€¢ åˆ†æ‰¹æ¬¡æ‰§è¡Œæ“ä½œ
â€¢ ç›‘æ§ç³»ç»Ÿæ€§èƒ½

ä¼ä¸šçº§ä¼˜åŒ–ï¼š
â€¢ å¤šæ•°æ®ä¸­å¿ƒéƒ¨ç½²
â€¢ æ™ºèƒ½è´Ÿè½½å‡è¡¡  
â€¢ è‡ªåŠ¨æ•…éšœè½¬ç§»
â€¢ AIè¾…åŠ©å†³ç­–
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹ï¼š**
- ä¸»æœºæ¸…å•æ˜¯Ansibleè‡ªåŠ¨åŒ–çš„åŸºç¡€ï¼Œé€‰æ‹©åˆé€‚çš„æ ¼å¼å’Œç»“æ„
- åˆ†ç»„ç­–ç•¥è¦ç»“åˆä¸šåŠ¡éœ€æ±‚ï¼Œæ”¯æŒçµæ´»çš„æ‰¹é‡æ“ä½œ
- å˜é‡ç®¡ç†éµå¾ªç»§æ‰¿æœºåˆ¶ï¼Œå®ç°é…ç½®çš„å¤ç”¨å’Œå·®å¼‚åŒ–
- æ¨¡å¼åŒ¹é…æä¾›å¼ºå¤§çš„ä¸»æœºé€‰æ‹©èƒ½åŠ›ï¼Œæé«˜è¿ç»´æ•ˆç‡
- ç‰ˆæœ¬æ§åˆ¶ç¡®ä¿é…ç½®å˜æ›´çš„å¯è¿½æº¯å’Œå¯å›æ»š
- å¤§è§„æ¨¡ç¯å¢ƒéœ€è¦è‡ªåŠ¨åŒ–å’Œæ™ºèƒ½åŒ–çš„ç®¡ç†ç­–ç•¥