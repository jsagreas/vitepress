---
title: 11ã€å®‰å…¨é…ç½®æ‰¹é‡éƒ¨ç½²
---
## ğŸ“š ç›®å½•

1. [å®‰å…¨é…ç½®æ‰¹é‡éƒ¨ç½²æ¦‚è¿°](#1-å®‰å…¨é…ç½®æ‰¹é‡éƒ¨ç½²æ¦‚è¿°)
2. [SSHå®‰å…¨é…ç½®ç»Ÿä¸€éƒ¨ç½²](#2-SSHå®‰å…¨é…ç½®ç»Ÿä¸€éƒ¨ç½²)
3. [é˜²ç«å¢™è§„åˆ™æ‰¹é‡é…ç½®](#3-é˜²ç«å¢™è§„åˆ™æ‰¹é‡é…ç½®)
4. [SELinuxç­–ç•¥ç»Ÿä¸€ç®¡ç†](#4-SELinuxç­–ç•¥ç»Ÿä¸€ç®¡ç†)
5. [ç”¨æˆ·æƒé™æ ‡å‡†åŒ–](#5-ç”¨æˆ·æƒé™æ ‡å‡†åŒ–)
6. [å¯†ç ç­–ç•¥æ‰¹é‡è®¾ç½®](#6-å¯†ç ç­–ç•¥æ‰¹é‡è®¾ç½®)
7. [å®¡è®¡é…ç½®ç»Ÿä¸€éƒ¨ç½²](#7-å®¡è®¡é…ç½®ç»Ÿä¸€éƒ¨ç½²)
8. [è¯ä¹¦æ‰¹é‡åˆ†å‘ç®¡ç†](#8-è¯ä¹¦æ‰¹é‡åˆ†å‘ç®¡ç†)
9. [å®‰å…¨åŸºçº¿åˆè§„æ£€æŸ¥](#9-å®‰å…¨åŸºçº¿åˆè§„æ£€æŸ¥)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ å®‰å…¨é…ç½®æ‰¹é‡éƒ¨ç½²æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å®‰å…¨é…ç½®æ‰¹é‡éƒ¨ç½²


**é€šä¿—ç†è§£**ï¼šå°±åƒç»™ä¸€æ ‹å¤§æ¥¼çš„æ‰€æœ‰æˆ¿é—´ç»Ÿä¸€å®‰è£…ç›¸åŒè§„æ ¼çš„é—¨é”ä¸€æ ·ï¼Œå®‰å…¨é…ç½®æ‰¹é‡éƒ¨ç½²å°±æ˜¯å¯¹å¤šå°æœåŠ¡å™¨åŒæ—¶è¿›è¡Œç»Ÿä¸€çš„å®‰å…¨è®¾ç½®ã€‚

```
ç”Ÿæ´»æ¯”å–»ï¼š
è¿é”é…’åº—ç®¡ç† â†’ å®‰å…¨é…ç½®æ‰¹é‡éƒ¨ç½²
ç»Ÿä¸€è£…ä¿®æ ‡å‡† â†’ ç»Ÿä¸€å®‰å…¨é…ç½®æ ‡å‡†
è´¨é‡æ£€æŸ¥å‘˜   â†’ å®‰å…¨åŸºçº¿æ£€æŸ¥å·¥å…·
æ ‡å‡†åŒ–æµç¨‹   â†’ è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
```

**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡éƒ¨ç½²å®‰å…¨é…ç½®**
- **ä¸€è‡´æ€§ä¿è¯**ï¼šç¡®ä¿æ‰€æœ‰æœåŠ¡å™¨æœ‰ç›¸åŒçš„å®‰å…¨é˜²æŠ¤æ°´å¹³
- **æ•ˆç‡æå‡**ï¼šé¿å…é€å°æ‰‹å·¥é…ç½®çš„ç¹çå·¥ä½œ
- **é™ä½é£é™©**ï¼šå‡å°‘äººä¸ºé…ç½®é”™è¯¯å¯¼è‡´çš„å®‰å…¨æ¼æ´
- **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³å®‰å…¨æ ‡å‡†å’Œåˆè§„å®¡è®¡è¦æ±‚

### 1.2 å®‰å…¨é…ç½®éƒ¨ç½²æ¶æ„


**ğŸ—ï¸ å…¸å‹éƒ¨ç½²æ¶æ„**
```
ç®¡ç†æ§åˆ¶èŠ‚ç‚¹                ç›®æ ‡æœåŠ¡å™¨ç¾¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é…ç½®ç®¡ç†å·¥å…· â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  WebæœåŠ¡å™¨   â”‚
â”‚ (Ansible)   â”‚           â”‚  æ•°æ®åº“æœåŠ¡å™¨ â”‚
â”‚             â”‚           â”‚  åº”ç”¨æœåŠ¡å™¨   â”‚
â”‚ å®‰å…¨åŸºçº¿    â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ æ£€æŸ¥å·¥å…·    â”‚                 â†‘
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           ç»Ÿä¸€å®‰å…¨ç­–ç•¥
       â†“                      åº”ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é…ç½®æ¨¡æ¿åº“   â”‚
â”‚ å®‰å…¨ç­–ç•¥åº“   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“‹ ä¸»è¦ç»„ä»¶åŠŸèƒ½**
- **é…ç½®ç®¡ç†å·¥å…·**ï¼šè´Ÿè´£æ‰§è¡Œæ‰¹é‡éƒ¨ç½²ä»»åŠ¡
- **é…ç½®æ¨¡æ¿åº“**ï¼šå­˜å‚¨å„ç§å®‰å…¨é…ç½®æ¨¡æ¿
- **åŸºçº¿æ£€æŸ¥å·¥å…·**ï¼šéªŒè¯é…ç½®æ˜¯å¦ç¬¦åˆå®‰å…¨è¦æ±‚
- **æ—¥å¿—å®¡è®¡ç³»ç»Ÿ**ï¼šè®°å½•æ‰€æœ‰é…ç½®å˜æ›´æ“ä½œ

### 1.3 å®‰å…¨é…ç½®çš„æ ¸å¿ƒè¦ç´ 


**ğŸ”‘ å…³é”®å®‰å…¨åŸŸ**
```
ç½‘ç»œå®‰å…¨å±‚ï¼šé˜²ç«å¢™è§„åˆ™ã€ç«¯å£ç®¡æ§
ç³»ç»Ÿå®‰å…¨å±‚ï¼šç”¨æˆ·æƒé™ã€æ–‡ä»¶æƒé™  
åº”ç”¨å®‰å…¨å±‚ï¼šæœåŠ¡é…ç½®ã€è®¿é—®æ§åˆ¶
æ•°æ®å®‰å…¨å±‚ï¼šåŠ å¯†ä¼ è¾“ã€æ•°æ®ä¿æŠ¤
å®¡è®¡å®‰å…¨å±‚ï¼šæ—¥å¿—è®°å½•ã€è¡Œä¸ºç›‘æ§
```

**âš–ï¸ å®‰å…¨ä¸å¯ç”¨æ€§å¹³è¡¡**

| å®‰å…¨çº§åˆ« | **é…ç½®ä¸¥æ ¼åº¦** | **ç³»ç»Ÿå¯ç”¨æ€§** | **é€‚ç”¨åœºæ™¯** |
|---------|--------------|--------------|-------------|
| ğŸ”’ **é«˜å®‰å…¨** | `ä¸¥æ ¼é™åˆ¶` | `å¯èƒ½å—é™` | `é‡‘èã€æ”¿åºœç³»ç»Ÿ` |
| ğŸ›¡ï¸ **ä¸­ç­‰å®‰å…¨** | `é€‚åº¦é™åˆ¶` | `åŸºæœ¬ä¿è¯` | `ä¼ä¸šå†…éƒ¨ç³»ç»Ÿ` |
| ğŸ”“ **åŸºç¡€å®‰å…¨** | `åŸºæœ¬é˜²æŠ¤` | `å®Œå…¨ä¿è¯` | `å¼€å‘æµ‹è¯•ç¯å¢ƒ` |

---

## 2. ğŸ” SSHå®‰å…¨é…ç½®ç»Ÿä¸€éƒ¨ç½²


### 2.1 SSHå®‰å…¨é…ç½®è¦ç‚¹


**ğŸ’¡ SSHå®‰å…¨çš„é‡è¦æ€§**
SSHæ˜¯Linuxç³»ç»Ÿæœ€ä¸»è¦çš„è¿œç¨‹ç®¡ç†é€šé“ï¼Œå°±åƒæˆ¿å­çš„å¤§é—¨ä¸€æ ·ï¼Œå¦‚æœè¿™é“é—¨ä¸å®‰å…¨ï¼Œæ•´ä¸ªç³»ç»Ÿéƒ½é¢ä¸´é£é™©ã€‚

**ğŸ”¸ æ ¸å¿ƒå®‰å…¨é…ç½®é¡¹**
- **ç¦ç”¨rootç›´æ¥ç™»å½•**ï¼šé¿å…è¶…çº§ç”¨æˆ·ç›´æ¥æš´éœ²
- **ä¿®æ”¹é»˜è®¤ç«¯å£**ï¼šå‡å°‘è‡ªåŠ¨åŒ–æ”»å‡»çš„æˆåŠŸç‡
- **å¯†é’¥è®¤è¯ä¼˜å…ˆ**ï¼šæ¯”å¯†ç è®¤è¯æ›´å®‰å…¨
- **ç™»å½•å¤±è´¥é™åˆ¶**ï¼šé˜²æ­¢æš´åŠ›ç ´è§£æ”»å‡»
- **ä¼šè¯è¶…æ—¶è®¾ç½®**ï¼šé¿å…ä¼šè¯é•¿æ—¶é—´ç©ºé—²

### 2.2 SSHé…ç½®æ¨¡æ¿åˆ¶ä½œ


**ğŸ“ å®‰å…¨SSHé…ç½®æ¨¡æ¿**

åˆ›å»ºé…ç½®æ¨¡æ¿æ–‡ä»¶`sshd_config_template`ï¼š
```
# SSHå®‰å…¨é…ç½®æ¨¡æ¿
Port 22022                          # ä¿®æ”¹é»˜è®¤ç«¯å£
Protocol 2                          # ä½¿ç”¨SSHåè®®ç‰ˆæœ¬2
PermitRootLogin no                  # ç¦æ­¢rootç›´æ¥ç™»å½•
MaxAuthTries 3                      # æœ€å¤§è®¤è¯å°è¯•æ¬¡æ•°
LoginGraceTime 60                   # ç™»å½•å®½é™æ—¶é—´
MaxSessions 4                       # æœ€å¤§ä¼šè¯æ•°

# è®¤è¯é…ç½®
PubkeyAuthentication yes            # å¯ç”¨å…¬é’¥è®¤è¯
AuthorizedKeysFile .ssh/authorized_keys
PasswordAuthentication yes          # æ ¹æ®éœ€è¦å¯ç”¨å¯†ç è®¤è¯
PermitEmptyPasswords no            # ç¦æ­¢ç©ºå¯†ç 

# ä¼šè¯é…ç½®
ClientAliveInterval 300            # å®¢æˆ·ç«¯æ´»è·ƒæ£€æŸ¥é—´éš”
ClientAliveCountMax 2              # æœ€å¤§æ— å“åº”æ¬¡æ•°
TCPKeepAlive yes                   # ä¿æŒTCPè¿æ¥

# è®¿é—®æ§åˆ¶
AllowUsers deploy admin            # å…è®¸ç™»å½•çš„ç”¨æˆ·
DenyUsers guest test               # ç¦æ­¢ç™»å½•çš„ç”¨æˆ·
```

**ğŸš€ æ‰¹é‡éƒ¨ç½²SSHé…ç½®**

ä½¿ç”¨Ansibleæ‰¹é‡éƒ¨ç½²ï¼š
```yaml
---
- name: éƒ¨ç½²SSHå®‰å…¨é…ç½®
  hosts: all
  become: yes
  tasks:
    - name: å¤‡ä»½åŸå§‹SSHé…ç½®
      copy:
        src: /etc/ssh/sshd_config
        dest: /etc/ssh/sshd_config.backup
        remote_src: yes
        
    - name: éƒ¨ç½²æ–°çš„SSHé…ç½®
      template:
        src: sshd_config_template
        dest: /etc/ssh/sshd_config
        backup: yes
        mode: '0600'
      notify: restart_sshd
      
    - name: éªŒè¯SSHé…ç½®è¯­æ³•
      command: /usr/sbin/sshd -t
      register: sshd_syntax_check
      failed_when: sshd_syntax_check.rc != 0
      
  handlers:
    - name: restart_sshd
      service:
        name: sshd
        state: restarted
```

### 2.3 SSHå¯†é’¥æ‰¹é‡åˆ†å‘


**ğŸ”‘ å¯†é’¥åˆ†å‘ç­–ç•¥**
```
å¯†é’¥ç”Ÿæˆ â†’ å…¬é’¥æ”¶é›† â†’ æ‰¹é‡åˆ†å‘ â†’ æƒé™è®¾ç½®

è¯¦ç»†æµç¨‹ï¼š
æ­¥éª¤1ï¼šåœ¨ç®¡ç†èŠ‚ç‚¹ç”ŸæˆSSHå¯†é’¥å¯¹
æ­¥éª¤2ï¼šæ”¶é›†å„æœåŠ¡å™¨ç®¡ç†å‘˜ç”¨æˆ·çš„å…¬é’¥
æ­¥éª¤3ï¼šæ‰¹é‡åˆ†å‘authorized_keysæ–‡ä»¶
æ­¥éª¤4ï¼šè®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
```

**å®æ–½æ–¹æ¡ˆ**ï¼š
```bash
# 1. ç”Ÿæˆç®¡ç†å¯†é’¥
ssh-keygen -t rsa -b 4096 -f ~/.ssh/manage_key -N ""

# 2. æ‰¹é‡åˆ†å‘å…¬é’¥
for server in server1 server2 server3; do
    ssh-copy-id -i ~/.ssh/manage_key.pub admin@$server
done
```

### 2.4 SSHå®‰å…¨ç›‘æ§


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**
- ç™»å½•å¤±è´¥æ¬¡æ•°ç»Ÿè®¡
- å¼‚å¸¸ç™»å½•æ—¶é—´æ£€æµ‹  
- éæˆæƒç”¨æˆ·ç™»å½•å°è¯•
- ç™»å½•æ¥æºIPåœ°å€åˆ†æ

**ğŸš¨ ç›‘æ§å‘Šè­¦é…ç½®**
```bash
# ç›‘æ§SSHç™»å½•å¤±è´¥
tail -f /var/log/auth.log | grep "Failed password" | \
while read line; do
    # æå–å¤±è´¥ç™»å½•ä¿¡æ¯å¹¶å‘Šè­¦
    echo "$line" | mail -s "SSHç™»å½•å¤±è´¥å‘Šè­¦" admin@company.com
done
```

---

## 3. ğŸ”¥ é˜²ç«å¢™è§„åˆ™æ‰¹é‡é…ç½®


### 3.1 é˜²ç«å¢™é…ç½®ç­–ç•¥


**ğŸ›¡ï¸ é˜²ç«å¢™çš„ä½œç”¨**
é˜²ç«å¢™å°±åƒå»ºç­‘ç‰©çš„å®‰ä¿ç³»ç»Ÿï¼Œå†³å®šå“ªäº›äººå¯ä»¥è¿›å…¥ï¼Œå“ªäº›äººå¿…é¡»è¢«æ‹¦æˆªåœ¨å¤–ã€‚åœ¨æœåŠ¡å™¨ä¸Šï¼Œå®ƒæ§åˆ¶ç½‘ç»œæµé‡çš„è¿›å‡ºã€‚

**ğŸ”¸ åŸºæœ¬é˜²æŠ¤åŸåˆ™**
- **é»˜è®¤æ‹’ç»**ï¼šé™¤éæ˜ç¡®å…è®¸ï¼Œå¦åˆ™ä¸€å¾‹æ‹’ç»
- **æœ€å°æƒé™**ï¼šåªå¼€æ”¾å¿…éœ€çš„ç«¯å£å’ŒæœåŠ¡
- **åˆ†å±‚é˜²æŠ¤**ï¼šç½‘ç»œå±‚ã€åº”ç”¨å±‚å¤šé‡é˜²æŠ¤
- **æ—¥å¿—è®°å½•**ï¼šè®°å½•æ‰€æœ‰è¢«æ‹’ç»çš„è¿æ¥å°è¯•

### 3.2 iptablesè§„åˆ™æ ‡å‡†åŒ–


**ğŸ“‹ æ ‡å‡†é˜²ç«å¢™è§„åˆ™æ¨¡æ¿**
```bash
#!/bin/bash
# é˜²ç«å¢™è§„åˆ™æ ‡å‡†é…ç½®è„šæœ¬

# 1. æ¸…ç©ºç°æœ‰è§„åˆ™
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X

# 2. è®¾ç½®é»˜è®¤ç­–ç•¥
iptables -P INPUT DROP      # é»˜è®¤æ‹’ç»å…¥ç«™
iptables -P FORWARD DROP    # é»˜è®¤æ‹’ç»è½¬å‘
iptables -P OUTPUT ACCEPT   # é»˜è®¤å…è®¸å‡ºç«™

# 3. å…è®¸æœ¬åœ°å›ç¯
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# 4. å…è®¸å·²å»ºç«‹çš„è¿æ¥
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 5. å…è®¸SSHè¿æ¥ï¼ˆä¿®æ”¹ç«¯å£ï¼‰
iptables -A INPUT -p tcp --dport 22022 -j ACCEPT

# 6. å…è®¸WebæœåŠ¡
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 7. å…è®¸å†…ç½‘è®¿é—®ï¼ˆæ ¹æ®å®é™…ç½‘æ®µè°ƒæ•´ï¼‰
iptables -A INPUT -s 192.168.1.0/24 -j ACCEPT

# 8. é˜²DDoSåŸºç¡€é˜²æŠ¤
iptables -A INPUT -p tcp --dport 80 -m limit --limit 10/min -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -m limit --limit 10/min -j ACCEPT

# 9. è®°å½•è¢«ä¸¢å¼ƒçš„åŒ…
iptables -A INPUT -j LOG --log-prefix "IPTables-Dropped: "
iptables -A INPUT -j DROP

# 10. ä¿å­˜è§„åˆ™
service iptables save
```

### 3.3 firewalldæ‰¹é‡é…ç½®


**ğŸ”§ ç°ä»£é˜²ç«å¢™ç®¡ç†**
firewalldæ˜¯CentOS 7+å’ŒRHEL 7+çš„é»˜è®¤é˜²ç«å¢™ç®¡ç†å·¥å…·ï¼Œæä¾›äº†æ›´ç®€å•çš„é…ç½®æ–¹å¼ã€‚

**æ‰¹é‡é…ç½®firewalld**ï¼š
```yaml
---
- name: é…ç½®firewalldé˜²ç«å¢™è§„åˆ™
  hosts: web_servers
  become: yes
  tasks:
    - name: å¯åŠ¨å¹¶å¯ç”¨firewalldæœåŠ¡
      systemd:
        name: firewalld
        state: started
        enabled: yes
        
    - name: è®¾ç½®é»˜è®¤zoneä¸ºpublic
      firewalld:
        zone: public
        permanent: yes
        immediate: yes
        state: enabled
        
    - name: å…è®¸SSHæœåŠ¡ï¼ˆè‡ªå®šä¹‰ç«¯å£ï¼‰
      firewalld:
        port: 22022/tcp
        zone: public
        permanent: yes
        immediate: yes
        state: enabled
        
    - name: å…è®¸HTTPå’ŒHTTPS
      firewalld:
        service: "{{ item }}"
        zone: public
        permanent: yes
        immediate: yes
        state: enabled
      loop:
        - http
        - https
        
    - name: é™åˆ¶SSHè®¿é—®æºIP
      firewalld:
        rich_rule: 'rule family="ipv4" source address="192.168.1.0/24" port port="22022" protocol="tcp" accept'
        zone: public
        permanent: yes
        immediate: yes
        state: enabled
```

### 3.4 é˜²ç«å¢™è§„åˆ™æµ‹è¯•éªŒè¯


**ğŸ§ª è§„åˆ™æœ‰æ•ˆæ€§æµ‹è¯•**
```bash
# æµ‹è¯•è„šæœ¬ï¼šéªŒè¯é˜²ç«å¢™è§„åˆ™
#!/bin/bash

# æµ‹è¯•SSHç«¯å£
echo "æµ‹è¯•SSHè¿æ¥..."
nc -zv localhost 22022 && echo "SSHç«¯å£å¼€æ”¾æ­£å¸¸" || echo "SSHç«¯å£è®¿é—®å¤±è´¥"

# æµ‹è¯•Webç«¯å£
echo "æµ‹è¯•WebæœåŠ¡..."
nc -zv localhost 80 && echo "HTTPç«¯å£å¼€æ”¾æ­£å¸¸" || echo "HTTPç«¯å£è®¿é—®å¤±è´¥"
nc -zv localhost 443 && echo "HTTPSç«¯å£å¼€æ”¾æ­£å¸¸" || echo "HTTPSç«¯å£è®¿é—®å¤±è´¥"

# æµ‹è¯•è¢«å°ç¦çš„ç«¯å£
echo "æµ‹è¯•å°ç¦ç«¯å£..."
nc -zv localhost 23 && echo "è­¦å‘Šï¼štelnetç«¯å£æœªè¢«å°ç¦" || echo "telnetç«¯å£å·²æ­£ç¡®å°ç¦"

# æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
firewall-cmd --state && echo "é˜²ç«å¢™è¿è¡Œæ­£å¸¸" || echo "é˜²ç«å¢™çŠ¶æ€å¼‚å¸¸"
```

**ğŸ“ˆ è§„åˆ™æ•ˆæœç›‘æ§**
```bash
# ç›‘æ§é˜²ç«å¢™æ—¥å¿—
tail -f /var/log/messages | grep "IPTables-Dropped" | \
while read line; do
    echo "$(date): $line" >> /var/log/firewall-blocks.log
done
```

---

## 4. ğŸ”’ SELinuxç­–ç•¥ç»Ÿä¸€ç®¡ç†


### 4.1 SELinuxåŸºç¡€ç†è§£


**ğŸ’¡ ä»€ä¹ˆæ˜¯SELinux**
SELinuxå°±åƒä¸€ä¸ªéå¸¸ä¸¥æ ¼çš„é—¨å«ï¼Œä¸ä»…è¦æ£€æŸ¥ä½ çš„èº«ä»½è¯ï¼ˆç”¨æˆ·æƒé™ï¼‰ï¼Œè¿˜è¦æ£€æŸ¥ä½ è¦å»å“ªé‡Œã€åšä»€ä¹ˆäº‹ï¼ˆå¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼‰ï¼Œç¡®ä¿æ¯ä¸ªç¨‹åºéƒ½åªèƒ½åšè‡ªå·±åº”è¯¥åšçš„äº‹æƒ…ã€‚

**ğŸ”¸ SELinuxçš„ä¸‰ç§æ¨¡å¼**
- **Enforcingï¼ˆå¼ºåˆ¶æ¨¡å¼ï¼‰**ï¼šä¸¥æ ¼æ‰§è¡Œæ‰€æœ‰ç­–ç•¥ï¼Œè¿åå°±é˜»æ­¢
- **Permissiveï¼ˆå®½å®¹æ¨¡å¼ï¼‰**ï¼šè®°å½•è¿è§„ä½†ä¸é˜»æ­¢ï¼Œç”¨äºè°ƒè¯•
- **Disabledï¼ˆå…³é—­æ¨¡å¼ï¼‰**ï¼šå®Œå…¨å…³é—­SELinuxåŠŸèƒ½

### 4.2 SELinuxçŠ¶æ€ç»Ÿä¸€è®¾ç½®


**âš™ï¸ æ‰¹é‡è®¾ç½®SELinuxæ¨¡å¼**

æ£€æŸ¥å½“å‰SELinuxçŠ¶æ€ï¼š
```bash
# æŸ¥çœ‹SELinuxçŠ¶æ€
sestatus
getenforce
```

**æ‰¹é‡é…ç½®ç­–ç•¥**ï¼š
```yaml
---
- name: ç»Ÿä¸€é…ç½®SELinuxç­–ç•¥
  hosts: all
  become: yes
  vars:
    selinux_mode: enforcing  # å¯é€‰ï¼šenforcing, permissive, disabled
    
  tasks:
    - name: æ£€æŸ¥å½“å‰SELinuxçŠ¶æ€
      command: getenforce
      register: current_selinux
      changed_when: false
      
    - name: æ˜¾ç¤ºå½“å‰SELinuxçŠ¶æ€
      debug:
        msg: "å½“å‰SELinuxçŠ¶æ€: {{ current_selinux.stdout }}"
        
    - name: è®¾ç½®SELinuxé…ç½®æ–‡ä»¶
      lineinfile:
        path: /etc/selinux/config
        regexp: '^SELINUX='
        line: 'SELINUX={{ selinux_mode }}'
        backup: yes
      when: ansible_selinux.config_mode != selinux_mode
      
    - name: ä¸´æ—¶è®¾ç½®SELinuxæ¨¡å¼ï¼ˆæ— éœ€é‡å¯ï¼‰
      command: setenforce {{ '1' if selinux_mode == 'enforcing' else '0' }}
      when: 
        - selinux_mode != 'disabled'
        - ansible_selinux.status != 'disabled'
        - current_selinux.stdout != selinux_mode
```

### 4.3 SELinuxç­–ç•¥ç®¡ç†


**ğŸ“¦ å¸¸ç”¨ç­–ç•¥åŒ…ç®¡ç†**
```yaml
- name: å®‰è£…SELinuxç®¡ç†å·¥å…·
  package:
    name:
      - policycoreutils
      - policycoreutils-python-utils
      - selinux-policy-targeted
    state: present
    
- name: è®¾ç½®WebæœåŠ¡å™¨SELinuxç­–ç•¥
  seboolean:
    name: "{{ item }}"
    state: yes
    persistent: yes
  loop:
    - httpd_can_network_connect      # å…è®¸HTTPè¿æ¥ç½‘ç»œ
    - httpd_can_network_connect_db   # å…è®¸HTTPè¿æ¥æ•°æ®åº“
    - httpd_read_user_content        # å…è®¸è¯»å–ç”¨æˆ·å†…å®¹
```

**ğŸ› ï¸ è‡ªå®šä¹‰ç­–ç•¥é…ç½®**
```bash
# ä¸ºåº”ç”¨ç¨‹åºåˆ›å»ºè‡ªå®šä¹‰SELinuxç­–ç•¥
# 1. ç”Ÿæˆç­–ç•¥æ¨¡å—
audit2allow -a -M myapp_policy

# 2. å®‰è£…ç­–ç•¥æ¨¡å—  
semodule -i myapp_policy.pp

# 3. éªŒè¯ç­–ç•¥å®‰è£…
semodule -l | grep myapp
```

### 4.4 SELinuxæ•…éšœæ’é™¤


**ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­**

**é—®é¢˜æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# 1. æ£€æŸ¥SELinuxæ—¥å¿—
grep "denied" /var/log/audit/audit.log | tail -10

# 2. ä½¿ç”¨sealertåˆ†æ
sealert -a /var/log/audit/audit.log

# 3. æ£€æŸ¥æ–‡ä»¶æ ‡ç­¾
ls -Z /path/to/file

# 4. æ¢å¤æ–‡ä»¶æ ‡ç­¾
restorecon -Rv /path/to/directory
```

**ğŸ“Š SELinuxç›‘æ§è„šæœ¬**
```bash
#!/bin/bash
# SELinuxçŠ¶æ€ç›‘æ§è„šæœ¬

# æ£€æŸ¥SELinuxçŠ¶æ€å˜åŒ–
current_mode=$(getenforce)
expected_mode="Enforcing"

if [ "$current_mode" != "$expected_mode" ]; then
    echo "è­¦å‘Š: SELinuxæ¨¡å¼å¼‚å¸¸ - å½“å‰: $current_mode, æœŸæœ›: $expected_mode"
    logger "SELinux mode changed to $current_mode"
fi

# æ£€æŸ¥æœ€è¿‘çš„SELinuxæ‹’ç»äº‹ä»¶
recent_denials=$(grep "denied" /var/log/audit/audit.log | tail -5)
if [ -n "$recent_denials" ]; then
    echo "å‘ç°æœ€è¿‘çš„SELinuxæ‹’ç»äº‹ä»¶:"
    echo "$recent_denials"
fi
```

---

## 5. ğŸ‘¥ ç”¨æˆ·æƒé™æ ‡å‡†åŒ–


### 5.1 ç”¨æˆ·æƒé™ç®¡ç†ç­–ç•¥


**ğŸ¯ æƒé™ç®¡ç†çš„é‡è¦æ€§**
ç”¨æˆ·æƒé™å°±åƒå…¬å¸çš„é—¨ç¦å¡ç³»ç»Ÿï¼Œä¸åŒçº§åˆ«çš„å‘˜å·¥åªèƒ½è¿›å…¥ç›¸åº”çš„åŒºåŸŸï¼Œåšç›¸åº”çš„å·¥ä½œã€‚åˆç†çš„æƒé™åˆ†é…å¯ä»¥é˜²æ­¢å†…éƒ¨å¨èƒå’Œè¯¯æ“ä½œã€‚

**ğŸ”¸ æƒé™åˆ†çº§åŸåˆ™**
- **ç³»ç»Ÿç®¡ç†å‘˜**ï¼šå®Œå…¨æƒé™ï¼Œè´Ÿè´£ç³»ç»Ÿç»´æŠ¤
- **åº”ç”¨ç®¡ç†å‘˜**ï¼šç‰¹å®šåº”ç”¨çš„ç®¡ç†æƒé™
- **æ™®é€šç”¨æˆ·**ï¼šåŸºæœ¬ä½¿ç”¨æƒé™
- **æœåŠ¡ç”¨æˆ·**ï¼šç³»ç»ŸæœåŠ¡ä¸“ç”¨è´¦æˆ·

### 5.2 æ ‡å‡†ç”¨æˆ·ç»„è®¾è®¡


**ğŸ‘¥ ç”¨æˆ·ç»„åˆ†ç±»ä½“ç³»**
```
æƒé™å±‚çº§ç»“æ„ï¼š
root (ç³»ç»Ÿè¶…çº§ç”¨æˆ·)
â”œâ”€â”€ sysadmin (ç³»ç»Ÿç®¡ç†å‘˜ç»„)
â”œâ”€â”€ appowner (åº”ç”¨è´Ÿè´£äººç»„)  
â”œâ”€â”€ developer (å¼€å‘äººå‘˜ç»„)
â”œâ”€â”€ operator (è¿ç»´äººå‘˜ç»„)
â””â”€â”€ readonly (åªè¯»æƒé™ç»„)

æ¯ä¸ªç»„çš„æƒé™èŒƒå›´ï¼š
sysadminï¼š  å®Œæ•´ç³»ç»Ÿç®¡ç†æƒé™
appownerï¼š  åº”ç”¨ç›®å½•å’ŒæœåŠ¡ç®¡ç†
developerï¼š å¼€å‘ç¯å¢ƒå’Œæµ‹è¯•æƒé™
operatorï¼š  ç›‘æ§å’Œæ—¥å¿—æŸ¥çœ‹æƒé™
readonlyï¼š  ç³»ç»Ÿä¿¡æ¯æŸ¥çœ‹æƒé™
```

**âš™ï¸ æ‰¹é‡åˆ›å»ºæ ‡å‡†ç”¨æˆ·ç»„**
```yaml
---
- name: åˆ›å»ºæ ‡å‡†ç”¨æˆ·ç»„ä½“ç³»
  hosts: all
  become: yes
  vars:
    standard_groups:
      - name: sysadmin
        gid: 2000
        description: "ç³»ç»Ÿç®¡ç†å‘˜ç»„"
      - name: appowner  
        gid: 2001
        description: "åº”ç”¨è´Ÿè´£äººç»„"
      - name: developer
        gid: 2002
        description: "å¼€å‘äººå‘˜ç»„"
      - name: operator
        gid: 2003
        description: "è¿ç»´æ“ä½œå‘˜ç»„"
      - name: readonly
        gid: 2004
        description: "åªè¯»æƒé™ç»„"
        
  tasks:
    - name: åˆ›å»ºæ ‡å‡†ç”¨æˆ·ç»„
      group:
        name: "{{ item.name }}"
        gid: "{{ item.gid }}"
        state: present
      loop: "{{ standard_groups }}"
      
    - name: è®°å½•ç”¨æˆ·ç»„åˆ›å»ºä¿¡æ¯
      lineinfile:
        path: /etc/group-info
        line: "{{ item.name }}:{{ item.gid }}:{{ item.description }}"
        create: yes
      loop: "{{ standard_groups }}"
```

### 5.3 sudoæƒé™é…ç½®


**ğŸ” sudoæƒé™åˆ†é…ç­–ç•¥**

åˆ›å»ºsudoé…ç½®æ¨¡æ¿ï¼š
```
# /etc/sudoers.d/standard-permissions

# ç³»ç»Ÿç®¡ç†å‘˜ç»„ - å®Œå…¨æƒé™
%sysadmin ALL=(ALL) ALL

# åº”ç”¨è´Ÿè´£äººç»„ - åº”ç”¨ç›¸å…³æƒé™
%appowner ALL=(ALL) /bin/systemctl start app*, \
               /bin/systemctl stop app*, \
               /bin/systemctl restart app*, \
               /bin/systemctl status app*, \
               /usr/bin/tail /var/log/app/*

# å¼€å‘äººå‘˜ç»„ - å¼€å‘ç¯å¢ƒæƒé™  
%developer ALL=(ALL) /bin/systemctl * dev*, \
                /usr/bin/docker *, \
                /usr/bin/git *

# è¿ç»´æ“ä½œå‘˜ç»„ - ç›‘æ§å’ŒåŸºç¡€æ“ä½œæƒé™
%operator ALL=(ALL) /bin/systemctl status *, \
              /usr/bin/tail /var/log/*, \
              /bin/ps aux, \
              /usr/bin/top, \
              /bin/df -h, \
              /usr/bin/free -h

# åªè¯»æƒé™ç»„ - æŸ¥çœ‹æƒé™
%readonly ALL=(ALL) /bin/cat /etc/*, \
              /bin/ls *, \
              /usr/bin/tail /var/log/*, \
              /bin/ps aux
```

**ğŸ“‹ æ‰¹é‡éƒ¨ç½²sudoé…ç½®**
```yaml
- name: éƒ¨ç½²sudoæƒé™é…ç½®
  copy:
    content: |
      {{ sudo_config_content }}
    dest: /etc/sudoers.d/standard-permissions
    mode: '0440'
    validate: '/usr/sbin/visudo -cf %s'
```

### 5.4 æ–‡ä»¶æƒé™æ ‡å‡†åŒ–


**ğŸ“ å…³é”®ç›®å½•æƒé™è®¾ç½®**

| ç›®å½•è·¯å¾„ | **æ‰€æœ‰è€…** | **ç”¨æˆ·ç»„** | **æƒé™** | **è¯´æ˜** |
|---------|-----------|-----------|---------|---------|
| `/etc/` | `root` | `root` | `755` | `ç³»ç»Ÿé…ç½®ç›®å½•` |
| `/var/log/` | `root` | `operator` | `750` | `æ—¥å¿—ç›®å½•` |
| `/opt/app/` | `appuser` | `appowner` | `755` | `åº”ç”¨ç¨‹åºç›®å½•` |
| `/home/shared/` | `root` | `developer` | `775` | `å…±äº«å¼€å‘ç›®å½•` |

**ğŸš€ æ‰¹é‡æƒé™è®¾ç½®**
```yaml
- name: è®¾ç½®æ ‡å‡†ç›®å½•æƒé™
  file:
    path: "{{ item.path }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"  
    mode: "{{ item.mode }}"
    state: directory
  loop:
    - { path: '/var/log', owner: 'root', group: 'operator', mode: '0750' }
    - { path: '/opt/app', owner: 'appuser', group: 'appowner', mode: '0755' }
    - { path: '/home/shared', owner: 'root', group: 'developer', mode: '0775' }
```

---

## 6. ğŸ”‘ å¯†ç ç­–ç•¥æ‰¹é‡è®¾ç½®


### 6.1 å¯†ç ç­–ç•¥è®¾è®¡åŸåˆ™


**ğŸ›¡ï¸ å¼ºå¯†ç ç­–ç•¥çš„é‡è¦æ€§**
å¯†ç å°±åƒå®¶é—¨çš„é’¥åŒ™ï¼Œå¦‚æœé’¥åŒ™å¤ªç®€å•ï¼ˆæ¯”å¦‚123456ï¼‰ï¼Œå°å·å¾ˆå®¹æ˜“å°±èƒ½é…å‡ºä¸€æŠŠã€‚å¼ºå¯†ç ç­–ç•¥ç¡®ä¿æ¯ä¸ª"é’¥åŒ™"éƒ½è¶³å¤Ÿå¤æ‚ï¼Œè®©æ”»å‡»è€…éš¾ä»¥ç ´è§£ã€‚

**ğŸ”¸ å¯†ç ç­–ç•¥è¦ç´ **
- **é•¿åº¦è¦æ±‚**ï¼šæœ€çŸ­8ä½ï¼Œå»ºè®®12ä½ä»¥ä¸Š
- **å¤æ‚åº¦è¦æ±‚**ï¼šåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦
- **æœ‰æ•ˆæœŸç®¡ç†**ï¼šå®šæœŸæ›´æ¢ï¼Œé¿å…é•¿æœŸä¸å˜
- **å†å²è®°å½•**ï¼šé¿å…é‡å¤ä½¿ç”¨æœ€è¿‘çš„å¯†ç 
- **è´¦æˆ·é”å®š**ï¼šå¤šæ¬¡å¤±è´¥åä¸´æ—¶é”å®š

### 6.2 PAMå¯†ç ç­–ç•¥é…ç½®


**âš™ï¸ é…ç½®å¯†ç å¤æ‚åº¦è¦æ±‚**

é…ç½®`/etc/security/pwquality.conf`ï¼š
```
# å¯†ç è´¨é‡é…ç½®æ–‡ä»¶
minlen = 12                    # æœ€å°é•¿åº¦12ä½
minclass = 3                   # æœ€å°‘åŒ…å«3ç±»å­—ç¬¦
maxrepeat = 2                  # ç›¸åŒå­—ç¬¦æœ€å¤šé‡å¤2æ¬¡
maxclasssrepeat = 3           # åŒç±»å­—ç¬¦æœ€å¤šè¿ç»­3ä¸ª
lcredit = -1                  # è‡³å°‘1ä¸ªå°å†™å­—æ¯
ucredit = -1                  # è‡³å°‘1ä¸ªå¤§å†™å­—æ¯  
dcredit = -1                  # è‡³å°‘1ä¸ªæ•°å­—
ocredit = -1                  # è‡³å°‘1ä¸ªç‰¹æ®Šå­—ç¬¦
difok = 8                     # ä¸æ—§å¯†ç è‡³å°‘8ä¸ªå­—ç¬¦ä¸åŒ
```

**æ‰¹é‡éƒ¨ç½²å¯†ç ç­–ç•¥**ï¼š
```yaml
---
- name: é…ç½®ç³»ç»Ÿå¯†ç ç­–ç•¥
  hosts: all
  become: yes
  tasks:
    - name: å®‰è£…å¯†ç è´¨é‡æ£€æŸ¥å·¥å…·
      package:
        name: libpwquality
        state: present
        
    - name: é…ç½®å¯†ç å¤æ‚åº¦è¦æ±‚
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: "^{{ item.key }}"
        line: "{{ item.key }} = {{ item.value }}"
        backup: yes
      loop:
        - { key: 'minlen', value: '12' }
        - { key: 'minclass', value: '3' }
        - { key: 'maxrepeat', value: '2' }
        - { key: 'lcredit', value: '-1' }
        - { key: 'ucredit', value: '-1' }
        - { key: 'dcredit', value: '-1' }
        - { key: 'ocredit', value: '-1' }
```

### 6.3 å¯†ç æœ‰æ•ˆæœŸç®¡ç†


**ğŸ“… é…ç½®å¯†ç ç”Ÿå‘½å‘¨æœŸ**

ä¿®æ”¹`/etc/login.defs`ä¸­çš„è®¾ç½®ï¼š
```bash
# å¯†ç ç”Ÿå‘½å‘¨æœŸè®¾ç½®
PASS_MAX_DAYS   90      # å¯†ç æœ€é•¿æœ‰æ•ˆæœŸ90å¤©
PASS_MIN_DAYS   1       # å¯†ç æœ€çŸ­ä½¿ç”¨æœŸ1å¤©
PASS_MIN_LEN    12      # å¯†ç æœ€å°é•¿åº¦12ä½
PASS_WARN_AGE   7       # è¿‡æœŸå‰7å¤©å¼€å§‹è­¦å‘Š
```

**ğŸ”„ æ‰¹é‡è®¾ç½®ç°æœ‰ç”¨æˆ·å¯†ç ç­–ç•¥**
```bash
#!/bin/bash
# æ‰¹é‡è®¾ç½®ç”¨æˆ·å¯†ç ç­–ç•¥è„šæœ¬

# è·å–æ‰€æœ‰æ™®é€šç”¨æˆ·ï¼ˆUID >= 1000ï¼‰
users=$(awk -F: '$3>=1000 && $3<60000 {print $1}' /etc/passwd)

for user in $users; do
    echo "è®¾ç½®ç”¨æˆ· $user çš„å¯†ç ç­–ç•¥..."
    
    # è®¾ç½®å¯†ç æœ€é•¿æœ‰æ•ˆæœŸ
    chage -M 90 $user
    
    # è®¾ç½®å¯†ç æœ€çŸ­ä½¿ç”¨æœŸ
    chage -m 1 $user  
    
    # è®¾ç½®è¿‡æœŸè­¦å‘ŠæœŸ
    chage -W 7 $user
    
    # æ˜¾ç¤ºè®¾ç½®ç»“æœ
    chage -l $user | grep -E "(Maximum|Minimum|Warning)"
done
```

### 6.4 è´¦æˆ·é”å®šç­–ç•¥


**ğŸ”’ é…ç½®è´¦æˆ·é”å®šæœºåˆ¶**

åœ¨`/etc/pam.d/password-auth`ä¸­é…ç½®ï¼š
```
# åœ¨authæ®µæ·»åŠ è´¦æˆ·é”å®šé…ç½®
auth required pam_faillock.so preauth audit silent deny=3 unlock_time=300
auth [default=die] pam_faillock.so authfail audit deny=3 unlock_time=300

# åœ¨accountæ®µæ·»åŠ 
account required pam_faillock.so
```

**ç›‘æ§å’Œç®¡ç†é”å®šè´¦æˆ·**ï¼š
```bash
# æŸ¥çœ‹é”å®šçš„è´¦æˆ·
faillock --user username

# è§£é”è´¦æˆ·
faillock --user username --reset

# æ‰¹é‡æ£€æŸ¥é”å®šçŠ¶æ€
for user in $(cut -d: -f1 /etc/passwd); do
    locked=$(faillock --user $user 2>/dev/null | grep "When:")
    if [ -n "$locked" ]; then
        echo "ç”¨æˆ· $user è¢«é”å®š: $locked"
    fi
done
```

---

## 7. ğŸ“‹ å®¡è®¡é…ç½®ç»Ÿä¸€éƒ¨ç½²


### 7.1 ç³»ç»Ÿå®¡è®¡çš„é‡è¦æ€§


**ğŸ” ä»€ä¹ˆæ˜¯ç³»ç»Ÿå®¡è®¡**
ç³»ç»Ÿå®¡è®¡å°±åƒå®‰è£…ç›‘æ§æ‘„åƒå¤´ï¼Œè®°å½•ç³»ç»Ÿä¸­å‘ç”Ÿçš„é‡è¦äº‹ä»¶ï¼ŒåŒ…æ‹¬è°åœ¨ä»€ä¹ˆæ—¶é—´åšäº†ä»€ä¹ˆæ“ä½œã€‚è¿™äº›è®°å½•åœ¨å®‰å…¨è°ƒæŸ¥å’Œåˆè§„æ£€æŸ¥æ—¶éå¸¸é‡è¦ã€‚

**ğŸ”¸ å®¡è®¡çš„ä¸»è¦ç”¨é€”**
- **å®‰å…¨è°ƒæŸ¥**ï¼šè¿½è¸ªå®‰å…¨äº‹ä»¶çš„æ¥æºå’Œè¿‡ç¨‹
- **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³è¡Œä¸šè§„èŒƒå’Œæ³•å¾‹è¦æ±‚
- **æ€§èƒ½åˆ†æ**ï¼šäº†è§£ç³»ç»Ÿä½¿ç”¨æ¨¡å¼
- **æ•…éšœæ’æŸ¥**ï¼šåˆ†æç³»ç»Ÿé—®é¢˜çš„åŸå› 

### 7.2 auditdæœåŠ¡é…ç½®


**âš™ï¸ åŸºç¡€å®¡è®¡æœåŠ¡é…ç½®**

`/etc/audit/auditd.conf`ä¸»è¦é…ç½®ï¼š
```
# å®¡è®¡æ—¥å¿—é…ç½®
log_file = /var/log/audit/audit.log
log_format = RAW
log_group = root
priority_boost = 4
flush = INCREMENTAL_ASYNC
freq = 50

# æ—¥å¿—è½®è½¬é…ç½®
num_logs = 10              # ä¿ç•™10ä¸ªæ—¥å¿—æ–‡ä»¶
max_log_file = 100         # æ¯ä¸ªæ–‡ä»¶æœ€å¤§100MB
max_log_file_action = ROTATE # æ–‡ä»¶æ»¡æ—¶è½®è½¬

# ç£ç›˜ç©ºé—´ç®¡ç†
space_left = 500           # å‰©ä½™500MBæ—¶è­¦å‘Š
space_left_action = SYSLOG # ç©ºé—´ä¸è¶³æ—¶è®°å½•ç³»ç»Ÿæ—¥å¿—
admin_space_left = 100     # ç®¡ç†å‘˜ä¿ç•™ç©ºé—´100MB
admin_space_left_action = SUSPEND # ç©ºé—´ä¸¥é‡ä¸è¶³æ—¶æš‚åœ
```

**ğŸš€ æ‰¹é‡éƒ¨ç½²auditæœåŠ¡**
```yaml
---
- name: é…ç½®ç³»ç»Ÿå®¡è®¡æœåŠ¡
  hosts: all
  become: yes
  tasks:
    - name: å®‰è£…auditè½¯ä»¶åŒ…
      package:
        name: 
          - audit
          - audispd-plugins
        state: present
        
    - name: é…ç½®auditdä¸»é…ç½®æ–‡ä»¶
      template:
        src: auditd.conf.j2
        dest: /etc/audit/auditd.conf
        backup: yes
      notify: restart_auditd
      
    - name: å¯åŠ¨å¹¶å¯ç”¨auditæœåŠ¡
      systemd:
        name: auditd
        state: started
        enabled: yes
        
  handlers:
    - name: restart_auditd
      systemd:
        name: auditd
        state: restarted
```

### 7.3 å®¡è®¡è§„åˆ™é…ç½®


**ğŸ“‹ é‡è¦äº‹ä»¶å®¡è®¡è§„åˆ™**

åˆ›å»ºå®¡è®¡è§„åˆ™æ–‡ä»¶`/etc/audit/rules.d/audit.rules`ï¼š
```bash
# åˆ é™¤æ‰€æœ‰ç°æœ‰è§„åˆ™
-D

# è®¾ç½®ç¼“å†²åŒºå¤§å°
-b 8192

# è®¾ç½®å¤±è´¥æ¨¡å¼ï¼ˆ1=æ‰“å°å¤±è´¥ä¿¡æ¯ï¼Œ2=å†…æ ¸panicï¼‰
-f 1

# ç›‘æ§å…³é”®æ–‡ä»¶ä¿®æ”¹
-w /etc/passwd -p wa -k identity
-w /etc/group -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/sudoers -p wa -k privilege_escalation

# ç›‘æ§ç³»ç»Ÿé…ç½®æ–‡ä»¶
-w /etc/ssh/sshd_config -p wa -k ssh_config
-w /etc/audit/ -p wa -k audit_config
-w /etc/crontab -p wa -k cron

# ç›‘æ§ç™»å½•äº‹ä»¶
-w /var/log/lastlog -p wa -k logins
-w /var/log/wtmp -p wa -k logins
-w /var/log/btmp -p wa -k logins

# ç›‘æ§æƒé™æå‡
-a always,exit -F arch=b64 -S setuid -S setgid -S setreuid -S setregid -k privilege
-a always,exit -F arch=b32 -S setuid -S setgid -S setreuid -S setregid -k privilege

# ç›‘æ§æ–‡ä»¶åˆ é™¤æ“ä½œ
-a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -k delete
-a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -k delete

# ç›‘æ§ç½‘ç»œé…ç½®å˜æ›´
-a always,exit -F arch=b64 -S sethostname -S setdomainname -k network
-a always,exit -F arch=b32 -S sethostname -S setdomainname -k network

# ä½¿é…ç½®ä¸å¯æ›´æ”¹
-e 2
```

### 7.4 å®¡è®¡æ—¥å¿—åˆ†æ


**ğŸ” æ—¥å¿—åˆ†æå·¥å…·ä½¿ç”¨**

æŸ¥çœ‹å®¡è®¡æ—¥å¿—çš„å¸¸ç”¨å‘½ä»¤ï¼š
```bash
# æœç´¢ç‰¹å®šç”¨æˆ·çš„æ´»åŠ¨
ausearch -ua username

# æœç´¢ç‰¹å®šæ—¶é—´æ®µçš„äº‹ä»¶
ausearch -ts today -te now

# æœç´¢æ–‡ä»¶è®¿é—®äº‹ä»¶
ausearch -f /etc/passwd

# æœç´¢ç‰¹å®šç±»å‹çš„äº‹ä»¶
ausearch -k identity

# ç”Ÿæˆå®¡è®¡æŠ¥å‘Š
aureport -au      # è®¤è¯æŠ¥å‘Š
aureport -f       # æ–‡ä»¶è®¿é—®æŠ¥å‘Š  
aureport -m       # ä¿®æ”¹æŠ¥å‘Š
aureport -n       # ç½‘ç»œäº‹ä»¶æŠ¥å‘Š
```

**ğŸ“Š è‡ªåŠ¨åŒ–æ—¥å¿—åˆ†æè„šæœ¬**
```bash
#!/bin/bash
# æ¯æ—¥å®¡è®¡æ—¥å¿—åˆ†æè„šæœ¬

DATE=$(date +%Y-%m-%d)
REPORT_FILE="/var/log/audit/daily-report-$DATE.txt"

echo "=== æ¯æ—¥å®¡è®¡æŠ¥å‘Š $DATE ===" > $REPORT_FILE

echo "1. ç™»å½•æ´»åŠ¨ç»Ÿè®¡:" >> $REPORT_FILE
aureport -l -ts today >> $REPORT_FILE

echo "2. æƒé™æå‡äº‹ä»¶:" >> $REPORT_FILE  
ausearch -k privilege -ts today >> $REPORT_FILE

echo "3. æ–‡ä»¶åˆ é™¤äº‹ä»¶:" >> $REPORT_FILE
ausearch -k delete -ts today >> $REPORT_FILE

echo "4. é…ç½®æ–‡ä»¶ä¿®æ”¹:" >> $REPORT_FILE
ausearch -k identity -ts today >> $REPORT_FILE

# å‘é€æŠ¥å‘Šç»™ç®¡ç†å‘˜
mail -s "æ¯æ—¥å®¡è®¡æŠ¥å‘Š $DATE" admin@company.com < $REPORT_FILE
```

---

## 8. ğŸ† è¯ä¹¦æ‰¹é‡åˆ†å‘ç®¡ç†


### 8.1 è¯ä¹¦ç®¡ç†åŸºç¡€


**ğŸ” è¯ä¹¦çš„ä½œç”¨å’Œé‡è¦æ€§**
æ•°å­—è¯ä¹¦å°±åƒèº«ä»½è¯ï¼Œç”¨æ¥è¯æ˜ä¸€ä¸ªç½‘ç«™æˆ–æœåŠ¡çš„èº«ä»½æ˜¯çœŸå®çš„ã€‚åœ¨HTTPSé€šä¿¡ä¸­ï¼Œè¯ä¹¦ç¡®ä¿æ•°æ®ä¼ è¾“çš„å®‰å…¨æ€§å’Œç½‘ç«™èº«ä»½çš„å¯ä¿¡æ€§ã€‚

**ğŸ”¸ è¯ä¹¦ç±»å‹å’Œç”¨é€”**
- **SSL/TLSè¯ä¹¦**ï¼šç”¨äºHTTPSç½‘ç«™åŠ å¯†
- **å®¢æˆ·ç«¯è¯ä¹¦**ï¼šç”¨äºå®¢æˆ·ç«¯èº«ä»½è®¤è¯
- **ä»£ç ç­¾åè¯ä¹¦**ï¼šéªŒè¯è½¯ä»¶çš„å®Œæ•´æ€§
- **CAæ ¹è¯ä¹¦**ï¼šä¿¡ä»»é“¾çš„æ ¹åŸº

### 8.2 è¯ä¹¦åˆ†å‘ç­–ç•¥


**ğŸ—ï¸ è¯ä¹¦åˆ†å‘æ¶æ„**
```
è¯ä¹¦ç®¡ç†ä¸­å¿ƒ              ç›®æ ‡æœåŠ¡å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯ä¹¦å­˜å‚¨åº“      â”‚ â”€â”€â”€â†’ â”‚ WebæœåŠ¡å™¨        â”‚
â”‚ ç§é’¥ä¿æŠ¤        â”‚      â”‚ åº”ç”¨æœåŠ¡å™¨       â”‚
â”‚ è‡ªåŠ¨æ›´æ–°è„šæœ¬    â”‚      â”‚ è´Ÿè½½å‡è¡¡å™¨       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                         â”‚
        â†“                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯ä¹¦æœ‰æ•ˆæœŸç›‘æ§   â”‚      â”‚ æœåŠ¡è‡ªåŠ¨é‡å¯     â”‚
â”‚ æ›´æ–°é€šçŸ¥ç³»ç»Ÿ     â”‚      â”‚ é…ç½®è‡ªåŠ¨ç”Ÿæ•ˆ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“¦ æ‰¹é‡è¯ä¹¦åˆ†å‘playbook**
```yaml
---
- name: æ‰¹é‡åˆ†å‘SSLè¯ä¹¦
  hosts: web_servers
  become: yes
  vars:
    cert_base_path: /etc/ssl/certs
    key_base_path: /etc/ssl/private
    
  tasks:
    - name: åˆ›å»ºè¯ä¹¦ç›®å½•
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      loop:
        - "{{ cert_base_path }}"
        - "{{ key_base_path }}"
        
    - name: åˆ†å‘SSLè¯ä¹¦æ–‡ä»¶
      copy:
        src: "certificates/{{ inventory_hostname }}.crt"
        dest: "{{ cert_base_path }}/{{ inventory_hostname }}.crt"
        mode: '0644'
        owner: root
        group: root
      notify: reload_nginx
      
    - name: åˆ†å‘SSLç§é’¥æ–‡ä»¶
      copy:
        src: "certificates/{{ inventory_hostname }}.key"  
        dest: "{{ key_base_path }}/{{ inventory_hostname }}.key"
        mode: '0600'
        owner: root
        group: root
      notify: reload_nginx
      
    - name: åˆ†å‘CAè¯ä¹¦é“¾
      copy:
        src: "certificates/ca-chain.pem"
        dest: "{{ cert_base_path }}/ca-chain.pem"
        mode: '0644'
        owner: root
        group: root
      notify: reload_nginx
      
  handlers:
    - name: reload_nginx
      systemd:
        name: nginx
        state: reloaded
```

### 8.3 è¯ä¹¦æœ‰æ•ˆæœŸç›‘æ§


**â° è¯ä¹¦è¿‡æœŸæ£€æŸ¥è„šæœ¬**
```bash
#!/bin/bash
# è¯ä¹¦æœ‰æ•ˆæœŸæ£€æŸ¥è„šæœ¬

# æ£€æŸ¥æœ¬åœ°è¯ä¹¦æ–‡ä»¶
check_local_cert() {
    local cert_file=$1
    local warning_days=30
    
    if [ ! -f "$cert_file" ]; then
        echo "è¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨: $cert_file"
        return 1
    fi
    
    # è·å–è¯ä¹¦è¿‡æœŸæ—¶é—´
    expire_date=$(openssl x509 -in "$cert_file" -noout -enddate | cut -d= -f2)
    expire_epoch=$(date -d "$expire_date" +%s)
    current_epoch=$(date +%s)
    
    # è®¡ç®—å‰©ä½™å¤©æ•°
    days_left=$(( (expire_epoch - current_epoch) / 86400 ))
    
    if [ $days_left -lt 0 ]; then
        echo "è­¦å‘Š: è¯ä¹¦å·²è¿‡æœŸ $cert_file (è¿‡æœŸ $((0-days_left)) å¤©)"
        return 2
    elif [ $days_left -lt $warning_days ]; then
        echo "è­¦å‘Š: è¯ä¹¦å³å°†è¿‡æœŸ $cert_file (å‰©ä½™ $days_left å¤©)"
        return 1
    else
        echo "è¯ä¹¦æ­£å¸¸ $cert_file (å‰©ä½™ $days_left å¤©)"
        return 0
    fi
}

# æ£€æŸ¥è¿œç¨‹HTTPSè¯ä¹¦
check_remote_cert() {
    local hostname=$1
    local port=${2:-443}
    local warning_days=30
    
    # è·å–è¿œç¨‹è¯ä¹¦ä¿¡æ¯
    cert_info=$(echo | timeout 10 openssl s_client -connect "$hostname:$port" -servername "$hostname" 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null)
    
    if [ $? -ne 0 ] || [ -z "$cert_info" ]; then
        echo "æ— æ³•è·å– $hostname:$port çš„è¯ä¹¦ä¿¡æ¯"
        return 1
    fi
    
    expire_date=$(echo "$cert_info" | cut -d= -f2)
    expire_epoch=$(date -d "$expire_date" +%s)
    current_epoch=$(date +%s)
    days_left=$(( (expire_epoch - current_epoch) / 86400 ))
    
    if [ $days_left -lt 0 ]; then
        echo "è­¦å‘Š: $hostname:$port è¯ä¹¦å·²è¿‡æœŸ (è¿‡æœŸ $((0-days_left)) å¤©)"
        return 2
    elif [ $days_left -lt $warning_days ]; then
        echo "è­¦å‘Š: $hostname:$port è¯ä¹¦å³å°†è¿‡æœŸ (å‰©ä½™ $days_left å¤©)"
        return 1
    else
        echo "$hostname:$port è¯ä¹¦æ­£å¸¸ (å‰©ä½™ $days_left å¤©)"
        return 0
    fi
}

# ä¸»æ£€æŸ¥æµç¨‹
main() {
    echo "=== è¯ä¹¦æœ‰æ•ˆæœŸæ£€æŸ¥æŠ¥å‘Š $(date) ==="
    
    # æ£€æŸ¥æœ¬åœ°è¯ä¹¦æ–‡ä»¶
    echo "æ£€æŸ¥æœ¬åœ°è¯ä¹¦æ–‡ä»¶:"
    for cert in /etc/ssl/certs/*.crt; do
        [ -f "$cert" ] && check_local_cert "$cert"
    done
    
    echo ""
    
    # æ£€æŸ¥è¿œç¨‹HTTPSæœåŠ¡
    echo "æ£€æŸ¥è¿œç¨‹HTTPSæœåŠ¡:"
    hosts_file="/etc/cert-check-hosts.txt"
    if [ -f "$hosts_file" ]; then
        while read -r hostname port; do
            [ -n "$hostname" ] && check_remote_cert "$hostname" "${port:-443}"
        done < "$hosts_file"
    fi
}

# æ‰§è¡Œæ£€æŸ¥
main
```

### 8.4 è‡ªåŠ¨è¯ä¹¦æ›´æ–°


**ğŸ”„ Let's Encryptè‡ªåŠ¨æ›´æ–°**
```bash
#!/bin/bash
# Let's Encryptè¯ä¹¦è‡ªåŠ¨æ›´æ–°è„šæœ¬

# è¯ä¹¦æ›´æ–°å‡½æ•°
renew_certificate() {
    local domain=$1
    local webroot=$2
    
    echo "æ›´æ–°åŸŸå $domain çš„è¯ä¹¦..."
    
    # ä½¿ç”¨certbotæ›´æ–°è¯ä¹¦
    certbot certonly \
        --webroot \
        --webroot-path="$webroot" \
        --email admin@company.com \
        --agree-tos \
        --no-eff-email \
        --force-renewal \
        -d "$domain"
    
    if [ $? -eq 0 ]; then
        echo "è¯ä¹¦æ›´æ–°æˆåŠŸ: $domain"
        
        # é‡æ–°åŠ è½½WebæœåŠ¡å™¨
        systemctl reload nginx
        
        return 0
    else
        echo "è¯ä¹¦æ›´æ–°å¤±è´¥: $domain"
        return 1
    fi
}

# æ‰¹é‡æ›´æ–°è¯ä¹¦
domains_file="/etc/letsencrypt/domains.txt"
if [ -f "$domains_file" ]; then
    while read -r domain webroot; do
        [ -n "$domain" ] && renew_certificate "$domain" "$webroot"
    done < "$domains_file"
fi
```

---

## 9. âœ… å®‰å…¨åŸºçº¿åˆè§„æ£€æŸ¥


### 9.1 å®‰å…¨åŸºçº¿æ¦‚å¿µ


**ğŸ¯ ä»€ä¹ˆæ˜¯å®‰å…¨åŸºçº¿**
å®‰å…¨åŸºçº¿å°±åƒå»ºç­‘å·¥ç¨‹çš„å®‰å…¨æ ‡å‡†ï¼Œè§„å®šäº†ç³»ç»Ÿå¿…é¡»è¾¾åˆ°çš„æœ€ä½å®‰å…¨è¦æ±‚ã€‚é€šè¿‡åŸºçº¿æ£€æŸ¥ï¼Œå¯ä»¥ç¡®ä¿æ‰€æœ‰ç³»ç»Ÿéƒ½ç¬¦åˆç»Ÿä¸€çš„å®‰å…¨æ ‡å‡†ã€‚

**ğŸ”¸ åŸºçº¿æ£€æŸ¥çš„å†…å®¹**
- **ç³»ç»Ÿé…ç½®**ï¼šæ£€æŸ¥å…³é”®ç³»ç»Ÿå‚æ•°è®¾ç½®
- **æœåŠ¡çŠ¶æ€**ï¼šç¡®è®¤å¿…è¦æœåŠ¡å¯åŠ¨ï¼Œå±é™©æœåŠ¡å…³é—­
- **æƒé™è®¾ç½®**ï¼šéªŒè¯æ–‡ä»¶å’Œç›®å½•æƒé™æ­£ç¡®
- **ç½‘ç»œå®‰å…¨**ï¼šæ£€æŸ¥é˜²ç«å¢™å’Œç½‘ç»œé…ç½®
- **è´¦æˆ·å®‰å…¨**ï¼šå®¡æŸ¥ç”¨æˆ·è´¦æˆ·å’Œæƒé™åˆ†é…

### 9.2 CISåŸºçº¿æ£€æŸ¥


**ğŸ“‹ CIS (Center for Internet Security) åŸºçº¿**
CISæä¾›äº†è¢«å¹¿æ³›é‡‡ç”¨çš„å®‰å…¨é…ç½®åŸºå‡†ï¼Œæ¶µç›–å„ç§æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºã€‚

**åŸºçº¿æ£€æŸ¥è„šæœ¬ç¤ºä¾‹**ï¼š
```bash
#!/bin/bash
# CISåŸºçº¿æ£€æŸ¥è„šæœ¬ï¼ˆç¤ºä¾‹ï¼‰

# æ£€æŸ¥ç»“æœæ–‡ä»¶
REPORT_FILE="/var/log/cis-audit-$(date +%Y%m%d-%H%M%S).txt"
PASS=0
FAIL=0

# æ£€æŸ¥å‡½æ•°
check_item() {
    local test_name="$1"
    local command="$2"
    local expected="$3"
    
    echo "æ£€æŸ¥: $test_name" >> $REPORT_FILE
    
    result=$(eval "$command" 2>/dev/null)
    if [ "$result" = "$expected" ]; then
        echo "  [PASS] $test_name" | tee -a $REPORT_FILE
        ((PASS++))
    else
        echo "  [FAIL] $test_name - æœŸæœ›: $expected, å®é™…: $result" | tee -a $REPORT_FILE
        ((FAIL++))
    fi
    echo "" >> $REPORT_FILE
}

echo "=== CISåŸºçº¿å®‰å…¨æ£€æŸ¥æŠ¥å‘Š $(date) ===" | tee $REPORT_FILE

# 1. æ£€æŸ¥rootå¯†ç æ˜¯å¦è®¾ç½®
check_item "1.1 Rootå¯†ç å·²è®¾ç½®" \
    "passwd -S root | awk '{print \$2}'" \
    "PS"

# 2. æ£€æŸ¥SSH rootç™»å½•æ˜¯å¦ç¦ç”¨
check_item "1.2 SSHç¦æ­¢rootç›´æ¥ç™»å½•" \
    "grep '^PermitRootLogin' /etc/ssh/sshd_config | awk '{print \$2}'" \
    "no"

# 3. æ£€æŸ¥SSHåè®®ç‰ˆæœ¬
check_item "1.3 SSHä½¿ç”¨åè®®ç‰ˆæœ¬2" \
    "grep '^Protocol' /etc/ssh/sshd_config | awk '{print \$2}'" \
    "2"

# 4. æ£€æŸ¥æ˜¯å¦å¯ç”¨é˜²ç«å¢™
check_item "2.1 é˜²ç«å¢™æœåŠ¡å·²å¯åŠ¨" \
    "systemctl is-active firewalld" \
    "active"

# 5. æ£€æŸ¥ä¸å¿…è¦çš„æœåŠ¡æ˜¯å¦å…³é—­
for service in telnet rsh rlogin; do
    check_item "2.2 $service æœåŠ¡å·²å…³é—­" \
        "systemctl is-active $service 2>/dev/null || echo inactive" \
        "inactive"
done

# 6. æ£€æŸ¥å…³é”®æ–‡ä»¶æƒé™
check_item "3.1 /etc/passwd æƒé™æ­£ç¡®" \
    "stat -c '%a' /etc/passwd" \
    "644"

check_item "3.2 /etc/shadow æƒé™æ­£ç¡®" \
    "stat -c '%a' /etc/shadow" \
    "640"

# 7. æ£€æŸ¥ç³»ç»Ÿæ›´æ–°
check_item "4.1 ç³»ç»Ÿå·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬" \
    "yum check-update | wc -l" \
    "0"

# ç”Ÿæˆæ€»ç»“
echo "=== æ£€æŸ¥æ€»ç»“ ===" | tee -a $REPORT_FILE
echo "é€šè¿‡é¡¹ç›®: $PASS" | tee -a $REPORT_FILE
echo "å¤±è´¥é¡¹ç›®: $FAIL" | tee -a $REPORT_FILE
echo "åˆè§„ç‡: $(echo "scale=2; $PASS*100/($PASS+$FAIL)" | bc)%" | tee -a $REPORT_FILE

echo "è¯¦ç»†æŠ¥å‘Šä¿å­˜åœ¨: $REPORT_FILE"
```

### 9.3 ç­‰ä¿åˆè§„æ£€æŸ¥


**ğŸ›ï¸ ç­‰çº§ä¿æŠ¤åˆè§„è¦æ±‚**
ç­‰çº§ä¿æŠ¤æ˜¯ä¸­å›½å›½å®¶ä¿¡æ¯å®‰å…¨ç­‰çº§ä¿æŠ¤åˆ¶åº¦ï¼Œå¯¹ä¸åŒç­‰çº§çš„ä¿¡æ¯ç³»ç»Ÿæå‡ºç›¸åº”çš„å®‰å…¨è¦æ±‚ã€‚

**ç­‰ä¿ä¸‰çº§å¸¸è§æ£€æŸ¥é¡¹**ï¼š
```bash
#!/bin/bash
# ç­‰ä¿ä¸‰çº§åˆè§„æ£€æŸ¥è„šæœ¬

echo "=== ç­‰ä¿ä¸‰çº§åˆè§„æ£€æŸ¥ $(date) ==="

# èº«ä»½é‰´åˆ«
echo "1. èº«ä»½é‰´åˆ«æ£€æŸ¥:"
echo -n "  å¯†ç å¤æ‚åº¦ç­–ç•¥: "
grep -q "minlen.*12" /etc/security/pwquality.conf && echo "ç¬¦åˆ" || echo "ä¸ç¬¦åˆ"

echo -n "  è´¦æˆ·é”å®šç­–ç•¥: "
grep -q "pam_faillock" /etc/pam.d/password-auth && echo "å·²é…ç½®" || echo "æœªé…ç½®"

# è®¿é—®æ§åˆ¶
echo "2. è®¿é—®æ§åˆ¶æ£€æŸ¥:"
echo -n "  sudoæƒé™é…ç½®: "
[ -f /etc/sudoers.d/standard-permissions ] && echo "å·²é…ç½®" || echo "æœªé…ç½®"

echo -n "  å…³é”®ç›®å½•æƒé™: "
wrong_perms=$(find /etc /usr/bin /usr/sbin -type f -perm /o+w 2>/dev/null | wc -l)
[ $wrong_perms -eq 0 ] && echo "æ­£ç¡®" || echo "å­˜åœ¨ $wrong_perms ä¸ªæƒé™é—®é¢˜"

# å®‰å…¨å®¡è®¡
echo "3. å®‰å…¨å®¡è®¡æ£€æŸ¥:"
echo -n "  å®¡è®¡æœåŠ¡çŠ¶æ€: "
systemctl is-active auditd | grep -q "active" && echo "è¿è¡Œä¸­" || echo "æœªè¿è¡Œ"

echo -n "  å®¡è®¡è§„åˆ™é…ç½®: "
[ -f /etc/audit/rules.d/audit.rules ] && echo "å·²é…ç½®" || echo "æœªé…ç½®"

# å…¥ä¾µé˜²èŒƒ
echo "4. å…¥ä¾µé˜²èŒƒæ£€æŸ¥:"
echo -n "  é˜²ç«å¢™çŠ¶æ€: "
systemctl is-active firewalld | grep -q "active" && echo "å·²å¯ç”¨" || echo "æœªå¯ç”¨"

echo -n "  SSHå®‰å…¨é…ç½®: "
grep -q "PermitRootLogin no" /etc/ssh/sshd_config && echo "å·²åŠ å›º" || echo "éœ€è¦åŠ å›º"

# æ•°æ®å®Œæ•´æ€§
echo "5. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥:"
echo -n "  é‡è¦æ–‡ä»¶å®Œæ•´æ€§: "
if command -v aide >/dev/null; then
    echo "å·²å®‰è£…AIDE"
else
    echo "æœªå®‰è£…å®Œæ•´æ€§æ£€æŸ¥å·¥å…·"
fi
```

### 9.4 è‡ªåŠ¨åŒ–åˆè§„ç›‘æ§


**ğŸ”„ æŒç»­åˆè§„ç›‘æ§ç³»ç»Ÿ**
```yaml
---
- name: éƒ¨ç½²å®‰å…¨åŸºçº¿æ£€æŸ¥å®šæ—¶ä»»åŠ¡
  hosts: all
  become: yes
  tasks:
    - name: åˆ›å»ºåŸºçº¿æ£€æŸ¥è„šæœ¬ç›®å½•
      file:
        path: /opt/security-baseline
        state: directory
        mode: '0755'
        
    - name: éƒ¨ç½²åŸºçº¿æ£€æŸ¥è„šæœ¬
      copy:
        src: security-baseline-check.sh
        dest: /opt/security-baseline/check.sh
        mode: '0755'
        
    - name: è®¾ç½®æ¯æ—¥åŸºçº¿æ£€æŸ¥å®šæ—¶ä»»åŠ¡
      cron:
        name: "æ¯æ—¥å®‰å…¨åŸºçº¿æ£€æŸ¥"
        minute: "0"
        hour: "2"
        job: "/opt/security-baseline/check.sh > /var/log/baseline-check.log 2>&1"
        
    - name: è®¾ç½®æ¯å‘¨è¯¦ç»†åˆè§„æ£€æŸ¥
      cron:
        name: "æ¯å‘¨è¯¦ç»†åˆè§„æ£€æŸ¥"
        minute: "0"
        hour: "3"
        weekday: "1"
        job: "/opt/security-baseline/full-compliance-check.sh"
```

**ğŸ“§ åˆè§„æŠ¥å‘Šè‡ªåŠ¨å‘é€**
```bash
#!/bin/bash
# åˆè§„æ£€æŸ¥æŠ¥å‘Šè‡ªåŠ¨å‘é€è„šæœ¬

# è¿è¡ŒåŸºçº¿æ£€æŸ¥
/opt/security-baseline/check.sh > /tmp/baseline-report.txt

# ç»Ÿè®¡åˆè§„æƒ…å†µ
total_checks=$(grep -c "æ£€æŸ¥:" /tmp/baseline-report.txt)
passed_checks=$(grep -c "\[PASS\]" /tmp/baseline-report.txt)
failed_checks=$(grep -c "\[FAIL\]" /tmp/baseline-report.txt)
compliance_rate=$(echo "scale=2; $passed_checks*100/$total_checks" | bc)

# ç”Ÿæˆé‚®ä»¶å†…å®¹
cat > /tmp/compliance-email.txt << EOF
ä¸»é¢˜: $(hostname) æ¯æ—¥å®‰å…¨åˆè§„æ£€æŸ¥æŠ¥å‘Š - $(date +%Y-%m-%d)

æœåŠ¡å™¨: $(hostname)
æ£€æŸ¥æ—¶é—´: $(date)
æ€»æ£€æŸ¥é¡¹: $total_checks
é€šè¿‡é¡¹: $passed_checks  
å¤±è´¥é¡¹: $failed_checks
åˆè§„ç‡: $compliance_rate%

$([ $failed_checks -gt 0 ] && echo "å­˜åœ¨ $failed_checks é¡¹ä¸åˆè§„é—®é¢˜ï¼Œè¯·åŠæ—¶å¤„ç†ã€‚")

è¯¦ç»†æŠ¥å‘Šè§é™„ä»¶ã€‚
EOF

# å‘é€é‚®ä»¶æŠ¥å‘Š
mail -s "$(hostname) å®‰å…¨åˆè§„æ£€æŸ¥æŠ¥å‘Š" \
     -a /tmp/baseline-report.txt \
     security-admin@company.com < /tmp/compliance-email.txt

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -f /tmp/baseline-report.txt /tmp/compliance-email.txt
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å®‰å…¨é…ç½®æ‰¹é‡éƒ¨ç½²ï¼šç»Ÿä¸€ç®¡ç†å¤šå°æœåŠ¡å™¨çš„å®‰å…¨è®¾ç½®
ğŸ”¸ SSHå®‰å…¨åŠ å›ºï¼šä¿®æ”¹ç«¯å£ã€ç¦ç”¨rootç™»å½•ã€å¯ç”¨å¯†é’¥è®¤è¯
ğŸ”¸ é˜²ç«å¢™è§„åˆ™ç®¡ç†ï¼šé»˜è®¤æ‹’ç»ç­–ç•¥ã€æœ€å°æƒé™åŸåˆ™
ğŸ”¸ ç”¨æˆ·æƒé™æ ‡å‡†åŒ–ï¼šåˆ†çº§ç®¡ç†ã€sudoæƒé™åˆç†åˆ†é…  
ğŸ”¸ å¯†ç ç­–ç•¥ï¼šå¤æ‚åº¦è¦æ±‚ã€æœ‰æ•ˆæœŸç®¡ç†ã€è´¦æˆ·é”å®š
ğŸ”¸ ç³»ç»Ÿå®¡è®¡ï¼šè®°å½•å…³é”®æ“ä½œã€åˆè§„è¦æ±‚ã€æ•…éšœæ’æŸ¥
ğŸ”¸ è¯ä¹¦ç®¡ç†ï¼šæ‰¹é‡åˆ†å‘ã€æœ‰æ•ˆæœŸç›‘æ§ã€è‡ªåŠ¨æ›´æ–°
ğŸ”¸ å®‰å…¨åŸºçº¿ï¼šåˆè§„æ£€æŸ¥ã€æŒç»­ç›‘æ§ã€é£é™©è¯„ä¼°
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å®‰å…¨é…ç½®çš„æœ¬è´¨ç›®æ ‡**
```
ç»Ÿä¸€æ€§ï¼šæ‰€æœ‰æœåŠ¡å™¨é‡‡ç”¨ç›¸åŒçš„å®‰å…¨æ ‡å‡†
ä¸€è‡´æ€§ï¼šç¡®ä¿é…ç½®ä¸ä¼šå› äººä¸ºå› ç´ äº§ç”Ÿå·®å¼‚  
å¯æ§æ€§ï¼šé›†ä¸­ç®¡ç†ï¼Œä¾¿äºæ›´æ–°å’Œç»´æŠ¤
åˆè§„æ€§ï¼šæ»¡è¶³è¡Œä¸šæ ‡å‡†å’Œæ³•è§„è¦æ±‚
```

**ğŸ”¹ æ‰¹é‡éƒ¨ç½²çš„æ ¸å¿ƒä»·å€¼**
```
æ•ˆç‡æå‡ï¼šè‡ªåŠ¨åŒ–æ›¿ä»£æ‰‹å·¥æ“ä½œ
è´¨é‡ä¿è¯ï¼šå‡å°‘äººä¸ºé”™è¯¯å’Œé—æ¼
æ ‡å‡†åŒ–ï¼šå»ºç«‹ç»Ÿä¸€çš„å®‰å…¨é…ç½®è§„èŒƒ
å¯è¿½æº¯ï¼šæ‰€æœ‰é…ç½®å˜æ›´éƒ½æœ‰è®°å½•
```

**ğŸ”¹ å®‰å…¨ä¸å¯ç”¨æ€§çš„å¹³è¡¡**
```
è¿‡åº¦é™åˆ¶ï¼šå¯èƒ½å½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
æƒé™ä¸è¶³ï¼šå¯èƒ½å½±å“ä¸šåŠ¡åŠŸèƒ½å®ç°
ç›‘æ§è¿‡åº¦ï¼šå¯èƒ½äº§ç”Ÿè¿‡å¤šå‘Šè­¦å™ªéŸ³
åˆç†é…ç½®ï¼šåœ¨å®‰å…¨å’Œå¯ç”¨æ€§é—´æ‰¾åˆ°å¹³è¡¡ç‚¹
```

### 10.3 å®é™…åº”ç”¨ç­–ç•¥


**ğŸ¯ å®æ–½é¡ºåºå»ºè®®**
```
ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å®‰å…¨é…ç½®
- SSHå®‰å…¨åŠ å›º
- é˜²ç«å¢™è§„åˆ™éƒ¨ç½²
- åŸºç¡€ç”¨æˆ·æƒé™è®¾ç½®

ç¬¬äºŒé˜¶æ®µï¼šæ·±åº¦å®‰å…¨é…ç½®  
- SELinuxç­–ç•¥ç®¡ç†
- å¯†ç ç­–ç•¥ç»Ÿä¸€
- ç³»ç»Ÿå®¡è®¡é…ç½®

ç¬¬ä¸‰é˜¶æ®µï¼šæŒç»­æ”¹è¿›
- è¯ä¹¦è‡ªåŠ¨åŒ–ç®¡ç†
- å®‰å…¨åŸºçº¿ç›‘æ§
- åˆè§„æ€§è‡ªåŠ¨æ£€æŸ¥
```

**ğŸ’¡ æœ€ä½³å®è·µåŸåˆ™**
```
æµ‹è¯•éªŒè¯ï¼šåœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯åå†éƒ¨ç½²ç”Ÿäº§
é€æ­¥å®æ–½ï¼šåˆ†æ‰¹æ¬¡éƒ¨ç½²ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜
ç›‘æ§åé¦ˆï¼šéƒ¨ç½²åæŒç»­ç›‘æ§æ•ˆæœï¼ŒåŠæ—¶è°ƒæ•´
æ–‡æ¡£è®°å½•ï¼šè¯¦ç»†è®°å½•é…ç½®æ ‡å‡†å’Œå˜æ›´å†å²
```

### 10.4 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ


| é—®é¢˜ç±»å‹ | **å¸¸è§ç—‡çŠ¶** | **è§£å†³æ€è·¯** |
|---------|------------|-------------|
| **é…ç½®å†²çª** | `æœåŠ¡æ— æ³•å¯åŠ¨` | `é€æ­¥å›æ»šï¼Œå®šä½å†²çªç‚¹` |
| **æƒé™è¿‡ä¸¥** | `åº”ç”¨åŠŸèƒ½å¼‚å¸¸` | `è°ƒæ•´æƒé™ï¼Œä¿æŒæœ€å°å¿…éœ€` |
| **è¯ä¹¦è¿‡æœŸ** | `HTTPSæœåŠ¡ä¸­æ–­` | `å»ºç«‹ç›‘æ§ï¼Œæå‰æ›´æ–°` |
| **å®¡è®¡æ—¥å¿—æ»¡** | `ç³»ç»Ÿæ€§èƒ½ä¸‹é™` | `é…ç½®æ—¥å¿—è½®è½¬ï¼Œå®šæœŸæ¸…ç†` |

**ğŸš€ æ‰©å±•å­¦ä¹ å»ºè®®**
- æ·±å…¥å­¦ä¹ ç‰¹å®šåˆè§„æ¡†æ¶ï¼ˆå¦‚ISO 27001ã€SOXç­‰ï¼‰
- æŒæ¡æ›´å¤šè‡ªåŠ¨åŒ–å·¥å…·ï¼ˆå¦‚Puppetã€Chefã€SaltStackï¼‰
- ç ”ç©¶äº‘ç¯å¢ƒä¸‹çš„å®‰å…¨é…ç½®ç®¡ç†
- å­¦ä¹ å®‰å…¨é…ç½®çš„ä»£ç åŒ–ç®¡ç†ï¼ˆGitOpsï¼‰

**æ ¸å¿ƒè®°å¿†**ï¼š
- å®‰å…¨é…ç½®æ‰¹é‡éƒ¨ç½²æ˜¯ç°ä»£è¿ç»´çš„å¿…å¤‡æŠ€èƒ½
- ç»Ÿä¸€æ ‡å‡†æ¯”å®Œç¾é…ç½®æ›´é‡è¦
- æŒç»­ç›‘æ§æ¯”ä¸€æ¬¡æ€§é…ç½®æ›´æœ‰ä»·å€¼
- å®‰å…¨ä¸å¯ç”¨æ€§éœ€è¦æŒç»­å¹³è¡¡å’Œä¼˜åŒ–