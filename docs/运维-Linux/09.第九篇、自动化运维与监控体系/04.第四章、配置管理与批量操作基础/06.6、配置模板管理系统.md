---
title: 6ã€é…ç½®æ¨¡æ¿ç®¡ç†ç³»ç»Ÿ
---
## ğŸ“š ç›®å½•


1. [é…ç½®æ¨¡æ¿ç®¡ç†ç³»ç»Ÿæ¦‚è¿°](#1-é…ç½®æ¨¡æ¿ç®¡ç†ç³»ç»Ÿæ¦‚è¿°)
2. [é…ç½®æ–‡ä»¶æ¨¡æ¿è¯­æ³•è¯¦è§£](#2-é…ç½®æ–‡ä»¶æ¨¡æ¿è¯­æ³•è¯¦è§£)
3. [å˜é‡æ›¿æ¢æœºåˆ¶](#3-å˜é‡æ›¿æ¢æœºåˆ¶)
4. [æ¡ä»¶åˆ¤æ–­ä¸å¾ªç¯æ§åˆ¶](#4-æ¡ä»¶åˆ¤æ–­ä¸å¾ªç¯æ§åˆ¶)
5. [æ¨¡æ¿ç»§æ‰¿ä¸åŒ…å«æœºåˆ¶](#5-æ¨¡æ¿ç»§æ‰¿ä¸åŒ…å«æœºåˆ¶)
6. [é…ç½®æ–‡ä»¶ç”Ÿæˆæµç¨‹](#6-é…ç½®æ–‡ä»¶ç”Ÿæˆæµç¨‹)
7. [æ¨¡æ¿ç‰ˆæœ¬æ§åˆ¶](#7-æ¨¡æ¿ç‰ˆæœ¬æ§åˆ¶)
8. [é…ç½®éªŒè¯ä¸æ ¡éªŒ](#8-é…ç½®éªŒè¯ä¸æ ¡éªŒ)
9. [é”™è¯¯é…ç½®å›æ»šæœºåˆ¶](#9-é”™è¯¯é…ç½®å›æ»šæœºåˆ¶)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ é…ç½®æ¨¡æ¿ç®¡ç†ç³»ç»Ÿæ¦‚è¿°



### 1.1 ä»€ä¹ˆæ˜¯é…ç½®æ¨¡æ¿ç®¡ç†ç³»ç»Ÿ



**ğŸ”¸ ç®€å•ç†è§£**
æƒ³è±¡ä½ è¦ç»™100å°æœåŠ¡å™¨é…ç½®ç›¸åŒçš„è½¯ä»¶ï¼Œä½†æ¯å°æœåŠ¡å™¨çš„IPã€ä¸»æœºåéƒ½ä¸ä¸€æ ·ã€‚å¦‚æœæ‰‹å·¥ä¸€å°å°æ”¹é…ç½®æ–‡ä»¶ï¼Œé‚£è¦ç´¯æ­»äººã€‚é…ç½®æ¨¡æ¿ç®¡ç†ç³»ç»Ÿå°±åƒä¸€ä¸ª"é…ç½®æ–‡ä»¶ç”Ÿäº§å·¥å‚"ï¼Œä½ åªéœ€è¦åšä¸€ä¸ªæ¨¡æ¿ï¼Œå‘Šè¯‰ç³»ç»Ÿæ¯å°æœåŠ¡å™¨çš„å…·ä½“å‚æ•°ï¼Œå®ƒå°±èƒ½è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰æœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶ã€‚

```
ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š
æœåŠ¡å™¨1: server_name = web01, ip = 192.168.1.10
æœåŠ¡å™¨2: server_name = web02, ip = 192.168.1.11  
æœåŠ¡å™¨3: server_name = web03, ip = 192.168.1.12
...éœ€è¦æ‰‹å·¥ä¿®æ”¹100ä¸ªé…ç½®æ–‡ä»¶

æ¨¡æ¿æ–¹å¼çš„ä¼˜åŠ¿ï¼š
æ¨¡æ¿æ–‡ä»¶: server_name = {{hostname}}, ip = {{server_ip}}
æ•°æ®æ–‡ä»¶: å®šä¹‰æ¯å°æœåŠ¡å™¨çš„hostnameå’Œserver_ip
ç»“æœ: è‡ªåŠ¨ç”Ÿæˆ100ä¸ªæ­£ç¡®çš„é…ç½®æ–‡ä»¶
```

### 1.2 æ ¸å¿ƒç»„æˆéƒ¨åˆ†



**ğŸ“‹ ç³»ç»Ÿæ¶æ„å›¾**
```
è¾“å…¥å±‚                å¤„ç†å±‚                è¾“å‡ºå±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¨¡æ¿æ–‡ä»¶    â”‚    â”‚                 â”‚    â”‚ å®é™…é…ç½®    â”‚
â”‚ å˜é‡æ•°æ®    â”‚ -> â”‚ æ¨¡æ¿å¼•æ“å¤„ç†    â”‚ -> â”‚ æ–‡ä»¶ç”Ÿæˆ    â”‚
â”‚ æ¡ä»¶è§„åˆ™    â”‚    â”‚                 â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ æ ¸å¿ƒç»„ä»¶è¯´æ˜**

**æ¨¡æ¿æ–‡ä»¶(Template Files)**ï¼š
- ä½œç”¨ï¼šå®šä¹‰é…ç½®æ–‡ä»¶çš„ç»“æ„æ¡†æ¶
- ç‰¹ç‚¹ï¼šåŒ…å«å ä½ç¬¦å˜é‡ï¼Œå¯å¤ç”¨
- ä¸¾ä¾‹ï¼šnginxé…ç½®æ¨¡æ¿ã€æ•°æ®åº“é…ç½®æ¨¡æ¿

**å˜é‡æ•°æ®(Variable Data)**ï¼š
- ä½œç”¨ï¼šæä¾›å…·ä½“çš„é…ç½®å€¼
- æ¥æºï¼šé…ç½®æ–‡ä»¶ã€æ•°æ®åº“ã€ç¯å¢ƒå˜é‡
- ä¸¾ä¾‹ï¼šæœåŠ¡å™¨IPã€ç«¯å£å·ã€ç”¨æˆ·å

**æ¨¡æ¿å¼•æ“(Template Engine)**ï¼š
- ä½œç”¨ï¼šè§£ææ¨¡æ¿ï¼Œæ›¿æ¢å˜é‡ï¼Œç”Ÿæˆæœ€ç»ˆé…ç½®
- å¸¸ç”¨å¼•æ“ï¼šJinja2ã€Go Templateã€Mustache
- åŠŸèƒ½ï¼šæ”¯æŒå˜é‡æ›¿æ¢ã€æ¡ä»¶åˆ¤æ–­ã€å¾ªç¯ç­‰

### 1.3 åº”ç”¨åœºæ™¯ä¸ä»·å€¼



| åœºæ™¯ | **ä¼ ç»Ÿæ–¹å¼é—®é¢˜** | **æ¨¡æ¿ç®¡ç†ä¼˜åŠ¿** | **å®é™…ä»·å€¼** |
|------|-----------------|-----------------|-------------|
| ğŸŒ **WebæœåŠ¡é›†ç¾¤** | `æ‰‹å·¥é…ç½®100å°nginx` | `ä¸€ä¸ªæ¨¡æ¿ç”Ÿæˆ100ä¸ªé…ç½®` | `æ•ˆç‡æå‡95%` |
| ğŸ—„ï¸ **æ•°æ®åº“é›†ç¾¤** | `ä¸»ä»é…ç½®å®¹æ˜“å‡ºé”™` | `æ¨¡æ¿ç¡®ä¿é…ç½®ä¸€è‡´æ€§` | `æ•…éšœç‡é™ä½80%` |
| ğŸš€ **å¾®æœåŠ¡éƒ¨ç½²** | `é…ç½®æ–‡ä»¶ç®¡ç†æ··ä¹±` | `ç»Ÿä¸€æ¨¡æ¿ç‰ˆæœ¬ç®¡ç†` | `éƒ¨ç½²æ—¶é—´ç¼©çŸ­70%` |
| ğŸ”§ **ç¯å¢ƒè¿ç§»** | `å¼€å‘æµ‹è¯•ç”Ÿäº§é…ç½®ä¸åŒæ­¥` | `åŒä¸€æ¨¡æ¿å¤šç¯å¢ƒé€‚é…` | `é…ç½®é”™è¯¯å‡å°‘90%` |

### 1.4 å¸¸è§çš„é…ç½®æ¨¡æ¿å·¥å…·



**ğŸ› ï¸ ä¸»æµå·¥å…·å¯¹æ¯”**

| å·¥å…·åç§° | **å¤æ‚åº¦** | **å­¦ä¹ æˆæœ¬** | **é€‚ç”¨åœºæ™¯** | **æ¨èæŒ‡æ•°** |
|---------|-----------|-------------|-------------|-------------|
| **Ansible Template** | `â˜…â˜…â˜†â˜†â˜†` | `ä½` | `ä¸­å°è§„æ¨¡è¿ç»´` | `â˜…â˜…â˜…â˜…â˜…` |
| **Helm Charts** | `â˜…â˜…â˜…â˜†â˜†` | `ä¸­` | `Kuberneteséƒ¨ç½²` | `â˜…â˜…â˜…â˜…â˜†` |
| **Terraform** | `â˜…â˜…â˜…â˜…â˜†` | `é«˜` | `åŸºç¡€è®¾æ–½ç®¡ç†` | `â˜…â˜…â˜…â˜…â˜†` |
| **SaltStack** | `â˜…â˜…â˜…â˜†â˜†` | `ä¸­` | `å¤§è§„æ¨¡é…ç½®ç®¡ç†` | `â˜…â˜…â˜…â˜†â˜†` |

---

## 2. ğŸ“ é…ç½®æ–‡ä»¶æ¨¡æ¿è¯­æ³•è¯¦è§£



### 2.1 åŸºæœ¬è¯­æ³•ç»“æ„



**ğŸ”¸ æ¨¡æ¿è¯­æ³•çš„æœ¬è´¨**
æ¨¡æ¿è¯­æ³•å°±åƒå¡«ç©ºé¢˜ï¼Œä½ åœ¨é…ç½®æ–‡ä»¶ä¸­ç•™å‡ºç©ºç™½ï¼Œç”¨ç‰¹æ®Šç¬¦å·æ ‡è®°ï¼Œç„¶åè®©ç³»ç»Ÿè‡ªåŠ¨å¡«å…¥æ­£ç¡®ç­”æ¡ˆã€‚

**å¸¸ç”¨è¯­æ³•æ ¼å¼å¯¹æ¯”**ï¼š
```
Jinja2è¯­æ³• (Ansibleä½¿ç”¨)ï¼š
server_name {{ hostname }}
port {{ web_port | default(80) }}

Go Templateè¯­æ³•ï¼š
server_name {{.hostname}}
port {{.web_port}}

Mustacheè¯­æ³•ï¼š
server_name {{hostname}}
port {{#web_port}}{{web_port}}{{/web_port}}
```

### 2.2 Jinja2æ¨¡æ¿è¯­æ³•è¯¦è§£



> ğŸ’¡ **ä¸ºä»€ä¹ˆé€‰æ‹©Jinja2**ï¼šAnsibleä½¿ç”¨ï¼Œè¯­æ³•ç®€æ´ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œå­¦ä¼šä¸€ä¸ªå°±èƒ½åº”å¯¹å¤§éƒ¨åˆ†åœºæ™¯

**ğŸ”¸ åŸºæœ¬å˜é‡æ›¿æ¢**
```jinja2
# ç®€å•å˜é‡

server_name: {{ hostname }}
listen_port: {{ port }}

# å­—å…¸å˜é‡  

database_host: {{ db.host }}
database_port: {{ db.port }}

# åˆ—è¡¨å˜é‡

upstream_servers: {{ web_servers[0] }}
```

**ğŸ”¸ å˜é‡è¿‡æ»¤å™¨**
è¿‡æ»¤å™¨å°±åƒç»™å˜é‡"åŠ å·¥å¤„ç†"ï¼Œè®©å®ƒå˜æˆä½ æƒ³è¦çš„æ ¼å¼ï¼š

```jinja2
# é»˜è®¤å€¼å¤„ç†

port: {{ web_port | default(80) }}
# æ„æ€ï¼šå¦‚æœweb_portæœ‰å€¼å°±ç”¨web_portï¼Œæ²¡å€¼å°±ç”¨80


# å­—ç¬¦ä¸²å¤„ç†

hostname: {{ server_name | upper }}
# æ„æ€ï¼šæŠŠserver_nameè½¬æ¢ä¸ºå¤§å†™


# åˆ—è¡¨å¤„ç†  

server_list: {{ servers | join(',') }}
# æ„æ€ï¼šæŠŠserversåˆ—è¡¨ç”¨é€—å·è¿æ¥æˆå­—ç¬¦ä¸²

```

**ğŸ“‹ å¸¸ç”¨è¿‡æ»¤å™¨ä¸€è§ˆè¡¨**

| è¿‡æ»¤å™¨ | **ä½œç”¨** | **ç¤ºä¾‹** | **ç»“æœ** |
|-------|---------|---------|---------|
| `default(value)` | `è®¾ç½®é»˜è®¤å€¼` | `{{ port \| default(80) }}` | `ç«¯å£ä¸ºç©ºæ—¶ä½¿ç”¨80` |
| `upper` | `è½¬å¤§å†™` | `{{ name \| upper }}` | `WEBSERVER` |
| `lower` | `è½¬å°å†™` | `{{ NAME \| lower }}` | `webserver` |
| `join(sep)` | `åˆ—è¡¨è¿æ¥` | `{{ list \| join(',') }}` | `a,b,c` |
| `length` | `è·å–é•¿åº¦` | `{{ servers \| length }}` | `3` |

### 2.3 å®é™…åº”ç”¨ç¤ºä¾‹



**ğŸŒ Nginxé…ç½®æ¨¡æ¿ç¤ºä¾‹**
```nginx
# nginx.conf.j2 æ¨¡æ¿æ–‡ä»¶

user {{ nginx_user | default('nginx') }};
worker_processes {{ worker_processes | default('auto') }};

server {
    listen {{ listen_port | default(80) }};
    server_name {{ server_name }};
    root {{ web_root | default('/var/www/html') }};
    
#    # æ—¥å¿—é…ç½®
    access_log {{ log_path }}/{{ server_name }}_access.log;
    error_log {{ log_path }}/{{ server_name }}_error.log;
}
```

**å¯¹åº”çš„å˜é‡æ•°æ®æ–‡ä»¶**ï¼š
```yaml
# variables.yml

nginx_user: www-data
worker_processes: 4
listen_port: 8080
server_name: mywebsite.com
web_root: /home/www/mysite
log_path: /var/log/nginx
```

**ç”Ÿæˆçš„æœ€ç»ˆé…ç½®**ï¼š
```nginx
user www-data;
worker_processes 4;

server {
    listen 8080;
    server_name mywebsite.com;
    root /home/www/mysite;
    
    access_log /var/log/nginx/mywebsite.com_access.log;
    error_log /var/log/nginx/mywebsite.com_error.log;
}
```

---

## 3. ğŸ”„ å˜é‡æ›¿æ¢æœºåˆ¶



### 3.1 å˜é‡æ›¿æ¢çš„å·¥ä½œåŸç†



**ğŸ”¸ å˜é‡æ›¿æ¢è¿‡ç¨‹å›¾è§£**
```
ç¬¬1æ­¥ï¼šæ¨¡æ¿æ‰«æ
{{ hostname }} -> å‘ç°å˜é‡æ ‡è®°

ç¬¬2æ­¥ï¼šå˜é‡æŸ¥æ‰¾  
hostname -> åœ¨å˜é‡æ•°æ®ä¸­æŸ¥æ‰¾å€¼

ç¬¬3æ­¥ï¼šå€¼æ›¿æ¢
{{ hostname }} -> web01.example.com

ç¬¬4æ­¥ï¼šè¾“å‡ºç»“æœ
æœ€ç»ˆç”Ÿæˆå®Œæ•´çš„é…ç½®æ–‡ä»¶
```

**ğŸ’¡ æ ¸å¿ƒç†è§£**
å˜é‡æ›¿æ¢å°±åƒ"æŸ¥å­—å…¸"ï¼š
- æ¨¡æ¿æ–‡ä»¶æ˜¯"å¥å­"ï¼Œé‡Œé¢æœ‰ä¸è®¤è¯†çš„"è¯"ï¼ˆå˜é‡ï¼‰
- å˜é‡æ•°æ®æ˜¯"å­—å…¸"ï¼Œå‘Šè¯‰ä½ æ¯ä¸ªè¯çš„æ„æ€  
- æ¨¡æ¿å¼•æ“æ˜¯"ç¿»è¯‘å‘˜"ï¼ŒæŠŠå¥å­ç¿»è¯‘æˆå®Œæ•´å†…å®¹

### 3.2 å˜é‡æ•°æ®çš„æ¥æº



**ğŸ“Š å˜é‡æ•°æ®æ¥æºå±‚æ¬¡å›¾**
```
ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤è¡Œå‚æ•°      â”‚ <- æœ€é«˜ä¼˜å…ˆçº§
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¯å¢ƒå˜é‡        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ é…ç½®æ–‡ä»¶        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é»˜è®¤å€¼          â”‚ <- æœ€ä½ä¼˜å…ˆçº§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ å®é™…ç¤ºä¾‹è¯´æ˜**

**æ–¹å¼1ï¼šé…ç½®æ–‡ä»¶å®šä¹‰**
```yaml
# config.yml

web_servers:
  - name: web01
    ip: 192.168.1.10
    port: 8080
  - name: web02  
    ip: 192.168.1.11
    port: 8080

database:
  host: db.example.com
  port: 3306
  user: webapp
```

**æ–¹å¼2ï¼šç¯å¢ƒå˜é‡å®šä¹‰**
```bash
export DB_HOST=192.168.1.100
export DB_PORT=3306
export WEB_PORT=80
```

**æ–¹å¼3ï¼šå‘½ä»¤è¡Œå‚æ•°**
```bash
ansible-playbook site.yml -e "web_port=8080" -e "db_host=mysql.local"
```

### 3.3 å˜é‡ä½œç”¨åŸŸä¸ç»§æ‰¿



**ğŸ”¸ å˜é‡ä½œç”¨åŸŸç†è§£**
å°±åƒç¼–ç¨‹è¯­è¨€ä¸­çš„å˜é‡ä¸€æ ·ï¼Œæ¨¡æ¿å˜é‡ä¹Ÿæœ‰ä½œç”¨åŸŸï¼š

```
å…¨å±€å˜é‡ï¼šæ•´ä¸ªç³»ç»Ÿéƒ½èƒ½ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»„å˜é‡ï¼šæŸä¸€ç»„æœåŠ¡å™¨èƒ½ç”¨         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ä¸»æœºå˜é‡ï¼šå•å°æœåŠ¡å™¨èƒ½ç”¨    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“‹ å˜é‡ä¼˜å…ˆçº§å®ä¾‹**
```yaml
# å…¨å±€å˜é‡ (group_vars/all.yml)

nginx_port: 80
log_level: info

# ç»„å˜é‡ (group_vars/webservers.yml)  

nginx_port: 8080  # è¦†ç›–å…¨å±€å˜é‡

# ä¸»æœºå˜é‡ (host_vars/web01.yml)

nginx_port: 9080  # è¦†ç›–ç»„å˜é‡
log_level: debug  # è¦†ç›–å…¨å±€å˜é‡

# æœ€ç»ˆweb01æœåŠ¡å™¨çš„å˜é‡å€¼ï¼š

# nginx_port = 9080 (ä¸»æœºå˜é‡ä¼˜å…ˆ)

# log_level = debug (ä¸»æœºå˜é‡ä¼˜å…ˆ)

```

### 3.4 å˜é‡æ›¿æ¢çš„é«˜çº§æŠ€å·§



**ğŸ”¸ æ¡ä»¶å˜é‡æ›¿æ¢**
```jinja2
# æ ¹æ®ç¯å¢ƒè®¾ç½®ä¸åŒçš„æ•°æ®åº“

database_host: {{ 'prod-db.com' if env == 'production' else 'test-db.com' }}

# æ ¹æ®æœåŠ¡å™¨ç±»å‹è®¾ç½®ä¸åŒçš„ç«¯å£

listen_port: {{ 443 if server_type == 'web' else 80 }}
```

**ğŸ”¸ å˜é‡è®¡ç®—**
```jinja2
# æ ¹æ®CPUæ ¸æ•°è®¡ç®—workerè¿›ç¨‹æ•°

worker_processes: {{ ansible_processor_vcpus * 2 }}

# æ ¹æ®å†…å­˜å¤§å°è®¡ç®—ç¼“å­˜å¤§å°

cache_size: {{ (ansible_memtotal_mb * 0.1) | int }}m
```

---

## 4. ğŸ›ï¸ æ¡ä»¶åˆ¤æ–­ä¸å¾ªç¯æ§åˆ¶



### 4.1 æ¡ä»¶åˆ¤æ–­çš„åŸºæœ¬æ¦‚å¿µ



**ğŸ”¸ ä»€ä¹ˆæ—¶å€™éœ€è¦æ¡ä»¶åˆ¤æ–­**
åœ¨å®é™…è¿ç»´ä¸­ï¼Œä¸åŒç¯å¢ƒã€ä¸åŒæœåŠ¡å™¨ç±»å‹éœ€è¦ä¸åŒçš„é…ç½®ã€‚æ¡ä»¶åˆ¤æ–­å°±åƒ"å¦‚æœ...é‚£ä¹ˆ..."çš„é€»è¾‘ï¼Œè®©æ¨¡æ¿èƒ½å¤Ÿæ™ºèƒ½åœ°ç”Ÿæˆä¸åŒçš„é…ç½®ã€‚

```
å®é™…åœºæ™¯ä¸¾ä¾‹ï¼š
- å¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œå¼€å¯SSLè¯ä¹¦
- å¦‚æœæ˜¯WebæœåŠ¡å™¨ï¼Œç›‘å¬80ç«¯å£  
- å¦‚æœå†…å­˜å¤§äº8GBï¼Œå¼€å¯æŸäº›ä¼˜åŒ–é€‰é¡¹
```

### 4.2 æ¡ä»¶åˆ¤æ–­è¯­æ³•è¯¦è§£



**ğŸ”¸ åŸºæœ¬ifè¯­å¥**
```jinja2
{% if env == 'production' %}
# ç”Ÿäº§ç¯å¢ƒé…ç½®

ssl_certificate /etc/ssl/certs/prod.crt;
ssl_certificate_key /etc/ssl/private/prod.key;
{% else %}
# å¼€å‘ç¯å¢ƒé…ç½®  

# SSL disabled for development

{% endif %}
```

**ğŸ”¸ å¤šé‡æ¡ä»¶åˆ¤æ–­**
```jinja2
{% if server_type == 'web' %}
    listen 80;
    root /var/www/html;
{% elif server_type == 'api' %}
    listen 8080;  
    root /var/api;
{% elif server_type == 'admin' %}
    listen 9000;
    root /var/admin;
{% else %}
    listen 8000;
    root /var/default;
{% endif %}
```

**ğŸ”¸ å¤æ‚æ¡ä»¶ç»„åˆ**
```jinja2
{% if env == 'production' and enable_ssl == true %}
# ç”Ÿäº§ç¯å¢ƒä¸”å¼€å¯SSL

server {
    listen 443 ssl;
    ssl_certificate {{ ssl_cert_path }};
}
{% endif %}

{% if memory_gb >= 8 and cpu_cores >= 4 %}  
# é«˜é…ç½®æœåŠ¡å™¨çš„ä¼˜åŒ–è®¾ç½®

worker_connections 2048;
keepalive_timeout 65;
{% endif %}
```

### 4.3 å¾ªç¯æ§åˆ¶è¯­æ³•



**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦å¾ªç¯**
å½“ä½ æœ‰å¤šå°æœåŠ¡å™¨ã€å¤šä¸ªæ•°æ®åº“ã€å¤šä¸ªç«™ç‚¹æ—¶ï¼Œä¸å¯èƒ½ä¸€ä¸ªä¸ªæ‰‹å†™é…ç½®ã€‚å¾ªç¯å°±åƒ"æ‰¹é‡ç”Ÿäº§"ï¼Œä¸€æ¬¡æ€§ç”Ÿæˆå¤šä¸ªç›¸ä¼¼çš„é…ç½®å—ã€‚

**åŸºæœ¬forå¾ªç¯**ï¼š
```jinja2
# ä¸ºå¤šä¸ªupstreamæœåŠ¡å™¨ç”Ÿæˆé…ç½®

upstream backend {
{% for server in web_servers %}
    server {{ server.ip }}:{{ server.port }};
{% endfor %}
}
```

**å¯¹åº”çš„å˜é‡æ•°æ®**ï¼š
```yaml
web_servers:
  - ip: 192.168.1.10
    port: 8080
  - ip: 192.168.1.11  
    port: 8080
  - ip: 192.168.1.12
    port: 8081
```

**ç”Ÿæˆçš„ç»“æœ**ï¼š
```nginx
upstream backend {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8081;
}
```

### 4.4 å¾ªç¯çš„é«˜çº§ç”¨æ³•



**ğŸ”¸ å¾ªç¯ä¸­çš„æ¡ä»¶åˆ¤æ–­**
```jinja2
# åªä¸ºactiveçŠ¶æ€çš„æœåŠ¡å™¨ç”Ÿæˆé…ç½®

upstream backend {
{% for server in web_servers %}
  {% if server.status == 'active' %}
    server {{ server.ip }}:{{ server.port }};
  {% endif %}
{% endfor %}
}
```

**ğŸ”¸ å¾ªç¯å˜é‡çš„ä½¿ç”¨**
```jinja2
# ç”Ÿæˆå¸¦ç¼–å·çš„é…ç½®

{% for db in databases %}
# Database {{ loop.index }}: {{ db.name }}

[database{{ loop.index }}]  
host = {{ db.host }}
port = {{ db.port }}
{% if not loop.last %}

{% endif %}
{% endfor %}
```

**ğŸ“‹ å¾ªç¯å˜é‡å‚è€ƒè¡¨**

| å¾ªç¯å˜é‡ | **å«ä¹‰** | **ç¤ºä¾‹å€¼** | **ç”¨é€”** |
|---------|---------|-----------|---------|
| `loop.index` | `å½“å‰å¾ªç¯æ¬¡æ•°(ä»1å¼€å§‹)` | `1, 2, 3` | `ç”Ÿæˆç¼–å·` |
| `loop.index0` | `å½“å‰å¾ªç¯æ¬¡æ•°(ä»0å¼€å§‹)` | `0, 1, 2` | `æ•°ç»„ä¸‹æ ‡` |
| `loop.first` | `æ˜¯å¦ç¬¬ä¸€æ¬¡å¾ªç¯` | `true/false` | `ç‰¹æ®Šå¤„ç†é¦–é¡¹` |
| `loop.last` | `æ˜¯å¦æœ€åä¸€æ¬¡å¾ªç¯` | `true/false` | `ç‰¹æ®Šå¤„ç†æœ«é¡¹` |

### 4.5 å®é™…åº”ç”¨æ¡ˆä¾‹



**ğŸŒ å®Œæ•´çš„Nginxè´Ÿè½½å‡è¡¡é…ç½®æ¨¡æ¿**
```jinja2
# nginx-lb.conf.j2

{% for upstream_name, servers in upstreams.items() %}
upstream {{ upstream_name }} {
    {% for server in servers %}
        {% if server.status == 'active' %}
    server {{ server.ip }}:{{ server.port }}{% if server.weight %} weight={{ server.weight }}{% endif %};
        {% endif %}
    {% endfor %}
}

{% endfor %}

{% for site in sites %}
server {
    listen {{ site.port | default(80) }};
    server_name {{ site.domain }};
    
    {% if site.ssl_enabled %}
    listen {{ site.ssl_port | default(443) }} ssl;
    ssl_certificate {{ ssl_cert_dir }}/{{ site.domain }}.crt;
    ssl_certificate_key {{ ssl_cert_dir }}/{{ site.domain }}.key;
    {% endif %}
    
    location / {
        proxy_pass http://{{ site.upstream }};
        {% for header_name, header_value in site.proxy_headers.items() %}
        proxy_set_header {{ header_name }} {{ header_value }};
        {% endfor %}
    }
}

{% endfor %}
```

**å¯¹åº”é…ç½®æ•°æ®**ï¼š
```yaml
upstreams:
  web_backend:
    - ip: 192.168.1.10
      port: 8080
      status: active
      weight: 3
    - ip: 192.168.1.11
      port: 8080  
      status: active
      weight: 1

sites:
  - domain: www.example.com
    port: 80
    ssl_enabled: true
    ssl_port: 443
    upstream: web_backend
    proxy_headers:
      Host: $host
      X-Real-IP: $remote_addr
```

---

## 5. ğŸ—ï¸ æ¨¡æ¿ç»§æ‰¿ä¸åŒ…å«æœºåˆ¶



### 5.1 æ¨¡æ¿ç»§æ‰¿çš„æ ¸å¿ƒæ¦‚å¿µ



**ğŸ”¸ ä»€ä¹ˆæ˜¯æ¨¡æ¿ç»§æ‰¿**
æ¨¡æ¿ç»§æ‰¿å°±åƒ"æ­ç§¯æœ¨"æˆ–è€…"å¥—å¨ƒ"ã€‚ä½ å…ˆåšä¸€ä¸ªåŸºç¡€æ¨¡æ¿ï¼ˆçˆ¶æ¨¡æ¿ï¼‰ï¼Œå®šä¹‰é€šç”¨çš„ç»“æ„ï¼Œç„¶åè®©å…·ä½“çš„æ¨¡æ¿ï¼ˆå­æ¨¡æ¿ï¼‰ç»§æ‰¿è¿™ä¸ªç»“æ„ï¼Œåªéœ€è¦å¡«å†™è‡ªå·±ç‰¹æœ‰çš„éƒ¨åˆ†ã€‚

```
ç±»æ¯”ç†è§£ï¼š
çˆ¶æ¨¡æ¿ = æˆ¿å±‹ç»“æ„å›¾ï¼ˆæœ‰å®¢å…ã€å§å®¤ã€å¨æˆ¿çš„åŸºæœ¬å¸ƒå±€ï¼‰
å­æ¨¡æ¿ = å…·ä½“è£…ä¿®æ–¹æ¡ˆï¼ˆæ¬§å¼é£æ ¼ã€ä¸­å¼é£æ ¼ã€ç°ä»£é£æ ¼ï¼‰
æœ€ç»ˆç»“æœ = å®Œæ•´çš„è£…ä¿®åæˆ¿å±‹
```

**ğŸ”¸ ç»§æ‰¿çš„ä¼˜åŠ¿**

| ä¼˜åŠ¿ | **ä¼ ç»Ÿæ–¹å¼** | **ç»§æ‰¿æ–¹å¼** | **æ•ˆæœå¯¹æ¯”** |
|------|-------------|-------------|-------------|
| **ç»´æŠ¤æ€§** | `ä¿®æ”¹éœ€è¦æ”¹Nä¸ªæ–‡ä»¶` | `åªæ”¹çˆ¶æ¨¡æ¿å³å¯` | `ç»´æŠ¤é‡å‡å°‘90%` |
| **ä¸€è‡´æ€§** | `å®¹æ˜“å‡ºç°é…ç½®ä¸ä¸€è‡´` | `è‡ªåŠ¨ä¿æŒä¸€è‡´` | `é”™è¯¯ç‡é™ä½80%` |
| **å¤ç”¨æ€§** | `é‡å¤ä»£ç å¾ˆå¤š` | `å…¬å…±éƒ¨åˆ†é«˜åº¦å¤ç”¨` | `ä»£ç é‡å‡å°‘70%` |

### 5.2 åŸºç¡€æ¨¡æ¿(çˆ¶æ¨¡æ¿)è®¾è®¡



**ğŸ”¸ åŸºç¡€æ¨¡æ¿ç¤ºä¾‹**
```jinja2
{# base.conf.j2 - åŸºç¡€é…ç½®æ¨¡æ¿ #}
# {{ ansible_managed }}

# Generated on {{ ansible_date_time.iso8601 }}


{% block global_settings %}
user {{ app_user | default('www-data') }};
worker_processes {{ worker_processes | default('auto') }};
pid {{ pid_file | default('/var/run/app.pid') }};
{% endblock %}

{% block events %}
events {
    worker_connections {{ worker_connections | default(1024) }};
}
{% endblock %}

{% block http %}
http {
    include /etc/mime.types;
    default_type application/octet-stream;
    
    {% block logging %}
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log {{ access_log | default('/var/log/access.log') }} main;
    error_log {{ error_log | default('/var/log/error.log') }};
    {% endblock %}
    
    {% block servers %}
#    # å­æ¨¡æ¿åœ¨è¿™é‡Œå®šä¹‰å…·ä½“çš„serveré…ç½®
    {% endblock %}
}
{% endblock %}
```

**ğŸ’¡ å…³é”®ç†è§£**
- `{% block åç§° %}...{% endblock %}`ï¼šå®šä¹‰å¯è¢«å­æ¨¡æ¿è¦†ç›–çš„åŒºå—
- çˆ¶æ¨¡æ¿å®šä¹‰æ•´ä½“ç»“æ„å’Œé»˜è®¤å†…å®¹
- å­æ¨¡æ¿åªéœ€è¦è¦†ç›–éœ€è¦æ”¹å˜çš„block

### 5.3 å­æ¨¡æ¿å®ç°



**ğŸ”¸ WebæœåŠ¡å™¨æ¨¡æ¿**
```jinja2
{# web-server.conf.j2 #}
{% extends "base.conf.j2" %}

{% block servers %}
server {
    listen {{ web_port | default(80) }};
    server_name {{ server_name }};
    root {{ web_root | default('/var/www/html') }};
    index index.html index.php;
    
    {% if enable_php %}
    location ~ \.php$ {
        fastcgi_pass {{ php_fpm_socket | default('127.0.0.1:9000') }};
        fastcgi_index index.php;
        include fastcgi_params;
    }
    {% endif %}
    
    {% if enable_ssl %}
    listen {{ ssl_port | default(443) }} ssl;
    ssl_certificate {{ ssl_cert }};
    ssl_certificate_key {{ ssl_key }};
    {% endif %}
}
{% endblock %}
```

**ğŸ”¸ APIæœåŠ¡å™¨æ¨¡æ¿**
```jinja2
{# api-server.conf.j2 #}
{% extends "base.conf.j2" %}

{% block servers %}
upstream api_backend {
    {% for server in api_servers %}
    server {{ server.ip }}:{{ server.port }};
    {% endfor %}
}

server {
    listen {{ api_port | default(8080) }};
    server_name {{ api_domain }};
    
    location /api/ {
        proxy_pass http://api_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    {% if enable_rate_limit %}
    location /api/ {
        limit_req zone=api burst={{ rate_limit_burst | default(10) }} nodelay;
    }
    {% endif %}
}
{% endblock %}
```

### 5.4 æ¨¡æ¿åŒ…å«æœºåˆ¶



**ğŸ”¸ ä»€ä¹ˆæ˜¯æ¨¡æ¿åŒ…å«**
å¦‚æœè¯´ç»§æ‰¿æ˜¯"å‚ç›´"çš„ç»“æ„å¤ç”¨ï¼Œé‚£ä¹ˆåŒ…å«å°±æ˜¯"æ°´å¹³"çš„ä»£ç ç‰‡æ®µå¤ç”¨ã€‚æŠŠå¸¸ç”¨çš„é…ç½®ç‰‡æ®µå•ç‹¬å†™æˆå°æ¨¡æ¿ï¼Œç„¶ååœ¨éœ€è¦çš„åœ°æ–¹åŒ…å«è¿›æ¥ã€‚

**å¸¸ç”¨ä»£ç ç‰‡æ®µæ¨¡æ¿**ï¼š
```jinja2
{# ssl-config.j2 - SSLé…ç½®ç‰‡æ®µ #}
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers HIGH:!aNULL:!MD5;
ssl_prefer_server_ciphers on;
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;
```

```jinja2
{# security-headers.j2 - å®‰å…¨å¤´é…ç½®ç‰‡æ®µ #}
add_header X-Frame-Options DENY;
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection "1; mode=block";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
```

**åœ¨ä¸»æ¨¡æ¿ä¸­åŒ…å«**ï¼š
```jinja2
server {
    listen 443 ssl;
    server_name {{ domain }};
    
#    # åŒ…å«SSLé…ç½®
    {% include "ssl-config.j2" %}
    
#    # åŒ…å«å®‰å…¨å¤´é…ç½®  
    {% include "security-headers.j2" %}
    
    location / {
        root {{ web_root }};
    }
}
```

### 5.5 ç»§æ‰¿ä¸åŒ…å«çš„æœ€ä½³å®è·µ



**ğŸ”¸ æ–‡ä»¶ç»„ç»‡ç»“æ„**
```
templates/
â”œâ”€â”€ base/                    # åŸºç¡€æ¨¡æ¿ç›®å½•
â”‚   â”œâ”€â”€ base.conf.j2         # åŸºç¡€é…ç½®æ¨¡æ¿
â”‚   â””â”€â”€ common-vars.j2       # é€šç”¨å˜é‡
â”œâ”€â”€ includes/                # åŒ…å«ç‰‡æ®µç›®å½•  
â”‚   â”œâ”€â”€ ssl-config.j2        # SSLé…ç½®ç‰‡æ®µ
â”‚   â”œâ”€â”€ security-headers.j2  # å®‰å…¨å¤´ç‰‡æ®µ
â”‚   â””â”€â”€ logging.j2           # æ—¥å¿—é…ç½®ç‰‡æ®µ
â”œâ”€â”€ services/                # æœåŠ¡æ¨¡æ¿ç›®å½•
â”‚   â”œâ”€â”€ nginx-web.j2         # WebæœåŠ¡å™¨æ¨¡æ¿
â”‚   â”œâ”€â”€ nginx-api.j2         # APIæœåŠ¡å™¨æ¨¡æ¿  
â”‚   â””â”€â”€ nginx-lb.j2          # è´Ÿè½½å‡è¡¡æ¨¡æ¿
â””â”€â”€ environments/            # ç¯å¢ƒç‰¹å®šæ¨¡æ¿
    â”œâ”€â”€ production.j2        # ç”Ÿäº§ç¯å¢ƒæ¨¡æ¿
    â”œâ”€â”€ staging.j2           # æµ‹è¯•ç¯å¢ƒæ¨¡æ¿
    â””â”€â”€ development.j2       # å¼€å‘ç¯å¢ƒæ¨¡æ¿
```

**ğŸ¯ é€‰æ‹©åŸåˆ™**

> âœ… **ä½¿ç”¨ç»§æ‰¿çš„åœºæ™¯**ï¼š
> - å¤šä¸ªæ¨¡æ¿æœ‰ç›¸åŒçš„åŸºæœ¬ç»“æ„
> - åªæ˜¯æŸäº›åŒºå—å†…å®¹ä¸åŒ
> - éœ€è¦ç»Ÿä¸€ç®¡ç†å…¬å…±é…ç½®

> âœ… **ä½¿ç”¨åŒ…å«çš„åœºæ™¯**ï¼š
> - æœ‰é€šç”¨çš„é…ç½®ç‰‡æ®µ
> - å¤šä¸ªåœ°æ–¹éƒ½è¦ç”¨åˆ°ç›¸åŒé…ç½®
> - æƒ³è¦æ¨¡å—åŒ–ç®¡ç†é…ç½®

---

## 6. âš™ï¸ é…ç½®æ–‡ä»¶ç”Ÿæˆæµç¨‹



### 6.1 ç”Ÿæˆæµç¨‹æ¦‚è¿°



**ğŸ”¸ æ•´ä½“æµç¨‹å›¾**
```
å‡†å¤‡é˜¶æ®µ          å¤„ç†é˜¶æ®µ          è¾“å‡ºé˜¶æ®µ          éƒ¨ç½²é˜¶æ®µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ”¶é›†æ¨¡æ¿   â”‚    â”‚è§£ææ¨¡æ¿   â”‚    â”‚ç”Ÿæˆé…ç½®   â”‚    â”‚åˆ†å‘éƒ¨ç½²   â”‚
â”‚æ”¶é›†å˜é‡   â”‚ -> â”‚æ›¿æ¢å˜é‡   â”‚ -> â”‚éªŒè¯é…ç½®   â”‚ -> â”‚é‡å¯æœåŠ¡   â”‚
â”‚ç¯å¢ƒæ£€æŸ¥   â”‚    â”‚æ¡ä»¶åˆ¤æ–­   â”‚    â”‚å¤‡ä»½åŸé…ç½® â”‚    â”‚ç›‘æ§éªŒè¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 å‡†å¤‡é˜¶æ®µè¯¦è§£



**ğŸ”¸ æ¨¡æ¿æ–‡ä»¶å‡†å¤‡**
```bash
# æ¨¡æ¿æ–‡ä»¶ç»“æ„æ£€æŸ¥

find templates/ -name "*.j2" | head -5

templates/nginx/base.conf.j2
templates/nginx/web-server.conf.j2  
templates/mysql/my.cnf.j2
templates/redis/redis.conf.j2
templates/php/php.ini.j2
```

**ğŸ”¸ å˜é‡æ•°æ®æ”¶é›†**
```yaml
# group_vars/all.yml - å…¨å±€å˜é‡

environment: production
log_level: info
backup_retention: 7

# group_vars/webservers.yml - WebæœåŠ¡å™¨ç»„å˜é‡  

nginx_user: www-data
nginx_worker_processes: auto
web_port: 80
ssl_enabled: true

# host_vars/web01.yml - ä¸»æœºç‰¹å®šå˜é‡

hostname: web01.example.com
server_ip: 192.168.1.10
ssl_cert: /etc/ssl/certs/web01.crt
```

**ğŸ”¸ ç¯å¢ƒæ£€æŸ¥æ¸…å•**

| æ£€æŸ¥é¡¹ç›® | **æ£€æŸ¥å†…å®¹** | **æ£€æŸ¥å‘½ä»¤** | **å¤„ç†æ–¹å¼** |
|---------|-------------|-------------|-------------|
| **æ¨¡æ¿å­˜åœ¨æ€§** | `æ¨¡æ¿æ–‡ä»¶æ˜¯å¦å­˜åœ¨` | `test -f template.j2` | `æŠ¥é”™åœæ­¢` |
| **å˜é‡å®Œæ•´æ€§** | `å¿…éœ€å˜é‡æ˜¯å¦å®šä¹‰` | `æ£€æŸ¥å˜é‡å­—å…¸` | `ä½¿ç”¨é»˜è®¤å€¼æˆ–æŠ¥é”™` |
| **è¯­æ³•æ­£ç¡®æ€§** | `æ¨¡æ¿è¯­æ³•æ˜¯å¦æ­£ç¡®` | `æ¨¡æ¿å¼•æ“é¢„æ£€æŸ¥` | `æŠ¥é”™å¹¶æ˜¾ç¤ºè¡Œå·` |
| **æƒé™æ£€æŸ¥** | `ç›®æ ‡ç›®å½•æ˜¯å¦å¯å†™` | `test -w /etc/nginx/` | `æç¤ºæƒé™ä¸è¶³` |

### 6.3 å¤„ç†é˜¶æ®µè¯¦è§£



**ğŸ”¸ æ¨¡æ¿è§£æè¿‡ç¨‹**
```python
# ç®€åŒ–çš„å¤„ç†æµç¨‹ä¼ªä»£ç 

def generate_config(template_file, variables):
#    # ç¬¬1æ­¥ï¼šåŠ è½½æ¨¡æ¿
    template = load_template(template_file)
    
#    # ç¬¬2æ­¥ï¼šéªŒè¯å˜é‡  
    validate_required_vars(template, variables)
    
#    # ç¬¬3æ­¥ï¼šå¤„ç†ç»§æ‰¿å’ŒåŒ…å«
    template = resolve_inheritance(template)
    template = resolve_includes(template)
    
#    # ç¬¬4æ­¥ï¼šå˜é‡æ›¿æ¢
    config_content = template.render(variables)
    
#    # ç¬¬5æ­¥ï¼šåå¤„ç†
    config_content = post_process(config_content)
    
    return config_content
```

**ğŸ”¸ å˜é‡æ›¿æ¢é¡ºåº**
```
å˜é‡æŸ¥æ‰¾é¡ºåºï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š
1. å‘½ä»¤è¡Œå‚æ•° (-e var=value)
2. ä»»åŠ¡ä¸­å®šä¹‰çš„å˜é‡  
3. ä¸»æœºå˜é‡ (host_vars/)
4. ç»„å˜é‡ (group_vars/)
5. è§’è‰²é»˜è®¤å˜é‡ (roles/*/defaults/)
6. æ¨¡æ¿ä¸­çš„defaultè¿‡æ»¤å™¨
```

### 6.4 ç”Ÿæˆä¸éªŒè¯é˜¶æ®µ



**ğŸ”¸ é…ç½®æ–‡ä»¶ç”Ÿæˆ**
```bash
# ä½¿ç”¨Ansibleç”Ÿæˆé…ç½®æ–‡ä»¶

ansible-playbook -i inventory site.yml --tags=config

# ç”Ÿæˆè¿‡ç¨‹æ—¥å¿—ç¤ºä¾‹

TASK [Generate nginx config] 
changed: [web01] => {
    "backup_file": "/etc/nginx/nginx.conf.backup.20231201-143022",
    "checksum": "a1b2c3d4e5f6...",
    "dest": "/etc/nginx/nginx.conf",
    "diff": {
        "after": "user www-data;\nworker_processes 4;\n...",
        "before": "user nginx;\nworker_processes auto;\n..."
    }
}
```

**ğŸ”¸ é…ç½®éªŒè¯æœºåˆ¶**
```yaml
# é…ç½®éªŒè¯ä»»åŠ¡ç¤ºä¾‹

- name: Validate nginx config
  command: nginx -t
  register: nginx_syntax_check
  failed_when: nginx_syntax_check.rc != 0
  
- name: Show validation result
  debug:
    msg: "Nginx config validation: {{ 'PASSED' if nginx_syntax_check.rc == 0 else 'FAILED' }}"

- name: Backup current config before applying
  copy:
    src: "{{ nginx_conf_path }}"
    dest: "{{ nginx_conf_path }}.backup.{{ ansible_date_time.epoch }}"
    backup: yes
  when: nginx_syntax_check.rc == 0
```

### 6.5 æ‰¹é‡ç”Ÿæˆå®æˆ˜æ¡ˆä¾‹



**ğŸ”¸ WebæœåŠ¡å™¨é›†ç¾¤é…ç½®ç”Ÿæˆ**
```yaml
# site.yml - ä¸»playbook

- hosts: webservers
  vars:
    nginx_sites:
      - name: main_site
        domain: www.example.com  
        root: /var/www/main
        ssl_enabled: true
      - name: api_site
        domain: api.example.com
        root: /var/www/api  
        upstream: api_backend
        
  tasks:
    - name: Generate nginx main config
      template:
        src: nginx/nginx.conf.j2
        dest: /etc/nginx/nginx.conf
        backup: yes
      notify: reload nginx
      
    - name: Generate site configs
      template:
        src: nginx/site.conf.j2  
        dest: "/etc/nginx/sites-available/{{ item.name }}.conf"
      loop: "{{ nginx_sites }}"
      notify: reload nginx
      
    - name: Enable sites
      file:
        src: "/etc/nginx/sites-available/{{ item.name }}.conf"
        dest: "/etc/nginx/sites-enabled/{{ item.name }}.conf"  
        state: link
      loop: "{{ nginx_sites }}"
      
  handlers:
    - name: reload nginx
      systemd:
        name: nginx
        state: reloaded
```

**ğŸ”¸ æ‰§è¡Œç»“æœç¤ºä¾‹**
```bash
$ ansible-playbook -i inventory site.yml

PLAY [webservers] *************************************************************

TASK [Generate nginx main config] ********************************************
changed: [web01]  
changed: [web02]
changed: [web03]

TASK [Generate site configs] *************************************************
changed: [web01] => (item={'name': 'main_site', 'domain': 'www.example.com'})
changed: [web01] => (item={'name': 'api_site', 'domain': 'api.example.com'}) 
changed: [web02] => (item={'name': 'main_site', 'domain': 'www.example.com'})
...

RUNNING HANDLER [reload nginx] ***********************************************
ok: [web01]
ok: [web02]  
ok: [web03]

PLAY RECAP ********************************************************************
web01     : ok=4  changed=2  unreachable=0  failed=0
web02     : ok=4  changed=2  unreachable=0  failed=0
web03     : ok=4  changed=2  unreachable=0  failed=0
```

---

## 7. ğŸ“š æ¨¡æ¿ç‰ˆæœ¬æ§åˆ¶



### 7.1 ç‰ˆæœ¬æ§åˆ¶çš„é‡è¦æ€§



**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬æ§åˆ¶**
é…ç½®æ¨¡æ¿å°±åƒè½¯ä»¶ä»£ç ä¸€æ ·ï¼Œéœ€è¦ç‰ˆæœ¬ç®¡ç†ã€‚æƒ³è±¡ä¸€ä¸‹ï¼š
- ä½ æ”¹äº†ä¸€ä¸ªæ¨¡æ¿ï¼Œç»“æœæœåŠ¡å™¨å…¨æŒ‚äº†ï¼Œä½†æ˜¯ä¸è®°å¾—æ”¹äº†ä»€ä¹ˆ
- å¤šä¸ªè¿ç»´åŒæ—¶ä¿®æ”¹æ¨¡æ¿ï¼Œä¸çŸ¥é“è°æ”¹äº†ä»€ä¹ˆ
- éœ€è¦å›é€€åˆ°ä¸Šä¸ªæœˆçš„é…ç½®ï¼Œä½†æ‰¾ä¸åˆ°å†å²ç‰ˆæœ¬

```
æ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶çš„é—®é¢˜ï¼š
æ—¶é—´: 2023-12-01  -> æ¨¡æ¿å·¥ä½œæ­£å¸¸
æ—¶é—´: 2023-12-15  -> æŸäººä¿®æ”¹äº†æ¨¡æ¿
æ—¶é—´: 2023-12-20  -> å‘ç°æœåŠ¡å¼‚å¸¸
é—®é¢˜: ä¸çŸ¥é“è°æ”¹äº†ä»€ä¹ˆï¼Œæ€ä¹ˆæ¢å¤ï¼Ÿ

æœ‰ç‰ˆæœ¬æ§åˆ¶çš„è§£å†³ï¼š
git log --oneline templates/nginx.conf.j2
abc123 Fix worker_processes configuration  
def456 Add SSL configuration support
ghi789 Update upstream server list
```

### 7.2 Gitç‰ˆæœ¬æ§åˆ¶å®è·µ



**ğŸ”¸ æ¨¡æ¿ä»“åº“ç»“æ„**
```
config-templates/
â”œâ”€â”€ .git/                    # Gitç‰ˆæœ¬æ§åˆ¶
â”œâ”€â”€ README.md               # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ CHANGELOG.md            # ç‰ˆæœ¬å˜æ›´æ—¥å¿—
â”œâ”€â”€ templates/              # æ¨¡æ¿æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ nginx/
â”‚   â”‚   â”œâ”€â”€ nginx.conf.j2
â”‚   â”‚   â”œâ”€â”€ site.conf.j2
â”‚   â”‚   â””â”€â”€ upstream.conf.j2
â”‚   â”œâ”€â”€ mysql/
â”‚   â”‚   â””â”€â”€ my.cnf.j2
â”‚   â””â”€â”€ redis/
â”‚       â””â”€â”€ redis.conf.j2
â”œâ”€â”€ vars/                   # å˜é‡æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ production/
â”‚   â”œâ”€â”€ staging/
â”‚   â””â”€â”€ development/
â”œâ”€â”€ scripts/                # éƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ deploy.sh
â”‚   â””â”€â”€ validate.sh
â””â”€â”€ docs/                   # æ–‡æ¡£ç›®å½•
    â”œâ”€â”€ template-guide.md
    â””â”€â”€ deployment-guide.md
```

**ğŸ”¸ ç‰ˆæœ¬ç®¡ç†æœ€ä½³å®è·µ**

| å®è·µ | **è¯´æ˜** | **ç¤ºä¾‹** | **å¥½å¤„** |
|------|---------|---------|---------|
| **è¯­ä¹‰åŒ–ç‰ˆæœ¬** | `ä½¿ç”¨æœ‰æ„ä¹‰çš„ç‰ˆæœ¬å·` | `v1.2.3 (ä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬)` | `ä¸€çœ¼çœ‹å‡ºå½±å“èŒƒå›´` |
| **æ¸…æ™°çš„æäº¤ä¿¡æ¯** | `æè¿°æ”¹äº†ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆæ”¹` | `feat: add SSL support for nginx template` | `å¿«é€Ÿäº†è§£å˜æ›´å†…å®¹` |
| **åˆ†æ”¯ç­–ç•¥** | `ä¸åŒç¯å¢ƒç”¨ä¸åŒåˆ†æ”¯` | `main/production/staging` | `ç¯å¢ƒéš”ç¦»ï¼Œé™ä½é£é™©` |
| **æ ‡ç­¾ç®¡ç†** | `é‡è¦ç‰ˆæœ¬æ‰“æ ‡ç­¾` | `git tag -a v1.0.0 -m "Production ready"` | `å¿«é€Ÿå›é€€åˆ°ç¨³å®šç‰ˆæœ¬` |

### 7.3 ç‰ˆæœ¬æ§åˆ¶å·¥ä½œæµç¨‹



**ğŸ”¸ å¼€å‘-æµ‹è¯•-ç”Ÿäº§æµç¨‹**
```
å¼€å‘åˆ†æ”¯ (develop)
    â”‚
    â”œâ”€ åŠŸèƒ½åˆ†æ”¯ (feature/add-ssl-config)  
    â”‚     â”‚
    â”‚     â””â”€ å¼€å‘æ–°åŠŸèƒ½
    â”‚
    â”œâ”€ åˆå¹¶åˆ°æµ‹è¯• (staging)
    â”‚     â”‚  
    â”‚     â””â”€ æµ‹è¯•ç¯å¢ƒéªŒè¯
    â”‚
    â””â”€ åˆå¹¶åˆ°ç”Ÿäº§ (main/production)
          â”‚
          â””â”€ ç”Ÿäº§ç¯å¢ƒå‘å¸ƒ
```

**ğŸ”¸ å®é™…æ“ä½œç¤ºä¾‹**
```bash
# 1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯å¼€å‘æ–°åŠŸèƒ½

git checkout -b feature/add-ssl-config

# 2. ä¿®æ”¹æ¨¡æ¿æ–‡ä»¶

vim templates/nginx/nginx.conf.j2

# 3. æäº¤å˜æ›´

git add templates/nginx/nginx.conf.j2
git commit -m "feat: add SSL configuration support for nginx

- Add SSL certificate configuration
- Add HTTP to HTTPS redirect  
- Add security headers for SSL"

# 4. åˆå¹¶åˆ°æµ‹è¯•åˆ†æ”¯

git checkout staging
git merge feature/add-ssl-config

# 5. åœ¨æµ‹è¯•ç¯å¢ƒéƒ¨ç½²éªŒè¯

ansible-playbook -i inventory/staging site.yml

# 6. æµ‹è¯•é€šè¿‡ååˆå¹¶åˆ°ç”Ÿäº§åˆ†æ”¯  

git checkout main
git merge staging

# 7. æ‰“æ ‡ç­¾å‘å¸ƒ

git tag -a v1.1.0 -m "Release v1.1.0: Add SSL support"
git push origin main --tags
```

### 7.4 æ¨¡æ¿å˜æ›´ç®¡ç†



**ğŸ”¸ å˜æ›´å®¡æ‰¹æµç¨‹**
```
å˜æ›´ç”³è¯· -> ä»£ç å®¡æŸ¥ -> æµ‹è¯•éªŒè¯ -> ç”Ÿäº§å‘å¸ƒ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æäº¤Pull     â”‚    â”‚åŒäº‹Review   â”‚    â”‚æµ‹è¯•ç¯å¢ƒ     â”‚    â”‚ç”Ÿäº§ç¯å¢ƒ     â”‚
â”‚Request      â”‚ -> â”‚ä»£ç å˜æ›´     â”‚ -> â”‚è‡ªåŠ¨åŒ–æµ‹è¯•   â”‚ -> â”‚è®¡åˆ’å‘å¸ƒ     â”‚
â”‚è¯´æ˜å˜æ›´åŸå›  â”‚    â”‚æ‰¹å‡†æˆ–æ‹’ç»   â”‚    â”‚åŠŸèƒ½éªŒè¯     â”‚    â”‚ç›‘æ§ç»“æœ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ å˜æ›´è®°å½•ç¤ºä¾‹**
```markdown
# CHANGELOG.md


# [1.1.0] - 2023-12-01


## Added


- SSL configuration support for nginx template
- Automatic HTTP to HTTPS redirect
- Security headers for enhanced security

## Changed  


- Updated worker_processes calculation logic
- Improved upstream server health check configuration

## Fixed


- Fixed log rotation configuration bug
- Corrected PHP-FPM socket path

# [1.0.1] - 2023-11-15  


## Fixed


- Fixed nginx worker_connections syntax error
- Corrected SSL certificate path variable name

# [1.0.0] - 2023-11-01


## Added


- Initial release of nginx configuration template
- Basic web server configuration support
- Load balancing configuration support
```

### 7.5 é…ç½®ç‰ˆæœ¬å›æ»šç­–ç•¥



**ğŸ”¸ å¿«é€Ÿå›æ»šæœºåˆ¶**
```bash
#!/bin/bash

# rollback.sh - é…ç½®å›æ»šè„šæœ¬


ROLLBACK_VERSION=${1:-"previous"}
BACKUP_DIR="/var/backups/configs"

echo "å¼€å§‹å›æ»šåˆ°ç‰ˆæœ¬: $ROLLBACK_VERSION"

# 1. è·å–æŒ‡å®šç‰ˆæœ¬çš„æ¨¡æ¿

git checkout tags/$ROLLBACK_VERSION -- templates/

# 2. é‡æ–°ç”Ÿæˆé…ç½®æ–‡ä»¶  

ansible-playbook -i inventory/production rollback.yml -e "target_version=$ROLLBACK_VERSION"

# 3. éªŒè¯é…ç½®æ­£ç¡®æ€§

if nginx -t; then
    echo "é…ç½®éªŒè¯æˆåŠŸï¼Œé‡è½½æœåŠ¡"
    systemctl reload nginx
    echo "å›æ»šå®Œæˆï¼"
else
    echo "é…ç½®éªŒè¯å¤±è´¥ï¼Œæ¢å¤åŸé…ç½®"  
    git checkout main -- templates/
    exit 1
fi
```

**ğŸ”¸ å›æ»šéªŒè¯æ¸…å•**

| éªŒè¯é¡¹ | **éªŒè¯æ–¹æ³•** | **æœŸæœ›ç»“æœ** | **å¤±è´¥å¤„ç†** |
|-------|-------------|-------------|-------------|
| **é…ç½®è¯­æ³•** | `nginx -t` | `syntax is ok` | `åœæ­¢å›æ»šï¼Œæ¢å¤åŸçŠ¶` |
| **æœåŠ¡å¯åŠ¨** | `systemctl status nginx` | `active (running)` | `é‡å¯æœåŠ¡ï¼Œæ£€æŸ¥æ—¥å¿—` |
| **ç«¯å£ç›‘å¬** | `netstat -tlnp \| grep :80` | `æ˜¾ç¤ºç›‘å¬ç«¯å£` | `æ£€æŸ¥é…ç½®æ–‡ä»¶ç«¯å£è®¾ç½®` |
| **é¡µé¢è®¿é—®** | `curl -I http://localhost` | `200 OK` | `æ£€æŸ¥upstreamå’Œlocationé…ç½®` |

---

## 8. âœ… é…ç½®éªŒè¯ä¸æ ¡éªŒ



### 8.1 é…ç½®éªŒè¯çš„é‡è¦æ€§



**ğŸ”¸ ä¸ºä»€ä¹ˆå¿…é¡»éªŒè¯é…ç½®**
é…ç½®æ–‡ä»¶å°±åƒ"è¯´æ˜ä¹¦"ï¼Œå¦‚æœè¯´æ˜ä¹¦æœ‰é”™ï¼Œè½»åˆ™åŠŸèƒ½ä¸æ­£å¸¸ï¼Œé‡åˆ™ç³»ç»Ÿå´©æºƒã€‚éªŒè¯é…ç½®å°±æ˜¯åœ¨"ä¸Šçº¿å‰æ£€æŸ¥è¯´æ˜ä¹¦æ˜¯å¦æ­£ç¡®"ã€‚

```
ä¸éªŒè¯é…ç½®çš„é£é™©ï¼š
âŒ è¯­æ³•é”™è¯¯ -> æœåŠ¡å¯åŠ¨å¤±è´¥ -> æ•´ä¸ªç½‘ç«™æŒ‚æ‰  
âŒ é€»è¾‘é”™è¯¯ -> åŠŸèƒ½å¼‚å¸¸ -> ç”¨æˆ·æ— æ³•è®¿é—®
âŒ æ€§èƒ½é…ç½®ä¸å½“ -> ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ -> æœåŠ¡å™¨å¡æ­»

éªŒè¯é…ç½®çš„å¥½å¤„ï¼š
âœ… æå‰å‘ç°é”™è¯¯ï¼Œé¿å…ç”Ÿäº§ç¯å¢ƒæ•…éšœ
âœ… ç¡®ä¿é…ç½®ç¬¦åˆæœ€ä½³å®è·µ
âœ… æé«˜ç³»ç»Ÿç¨³å®šæ€§å’Œå¯é æ€§
```

### 8.2 å¤šå±‚æ¬¡éªŒè¯ç­–ç•¥



**ğŸ”¸ éªŒè¯å±‚æ¬¡å›¾**
```
ç¬¬1å±‚ï¼šè¯­æ³•éªŒè¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•æ˜¯å¦æ­£ç¡®         â”‚  <- åŸºç¡€éªŒè¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬2å±‚ï¼šé€»è¾‘éªŒè¯  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥é…ç½®é€»è¾‘æ˜¯å¦åˆç†            â”‚  <- åŠŸèƒ½éªŒè¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬3å±‚ï¼šå®‰å…¨éªŒè¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
â”‚ æ£€æŸ¥æ˜¯å¦å­˜åœ¨å®‰å…¨é£é™©            â”‚  <- å®‰å…¨éªŒè¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬4å±‚ï¼šæ€§èƒ½éªŒè¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥æ€§èƒ½é…ç½®æ˜¯å¦åˆç†            â”‚  <- ä¼˜åŒ–éªŒè¯  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 è¯­æ³•éªŒè¯å®ç°



**ğŸ”¸ å¸¸ç”¨æœåŠ¡çš„è¯­æ³•éªŒè¯å‘½ä»¤**

| æœåŠ¡ | **éªŒè¯å‘½ä»¤** | **æˆåŠŸè¾“å‡º** | **å¤±è´¥å¤„ç†** |
|------|-------------|-------------|-------------|
| **Nginx** | `nginx -t` | `syntax is ok` | `æ˜¾ç¤ºé”™è¯¯è¡Œå·å’ŒåŸå› ` |
| **Apache** | `httpd -t` | `Syntax OK` | `æ£€æŸ¥é…ç½®æ–‡ä»¶è·¯å¾„` |
| **MySQL** | `mysqld --help --verbose > /dev/null` | `æ— æŠ¥é”™ä¿¡æ¯` | `æŸ¥çœ‹é”™è¯¯è¯¦æƒ…` |
| **Redis** | `redis-server /path/to/redis.conf --test-memory 1` | `æ— æŠ¥é”™ä¿¡æ¯` | `æ£€æŸ¥é…ç½®é¡¹æ‹¼å†™` |

**ğŸ”¸ è‡ªåŠ¨åŒ–è¯­æ³•éªŒè¯è„šæœ¬**
```bash
#!/bin/bash

# config-validator.sh - é…ç½®éªŒè¯è„šæœ¬


validate_nginx() {
    echo "éªŒè¯Nginxé…ç½®..."
    if nginx -t; then
        echo "âœ… Nginxé…ç½®è¯­æ³•æ­£ç¡®"
        return 0
    else
        echo "âŒ Nginxé…ç½®è¯­æ³•é”™è¯¯"
        return 1
    fi
}

validate_mysql() {
    echo "éªŒè¯MySQLé…ç½®..."
    if mysqld --defaults-file=/etc/mysql/my.cnf --help --verbose > /dev/null 2>&1; then
        echo "âœ… MySQLé…ç½®è¯­æ³•æ­£ç¡®"  
        return 0
    else
        echo "âŒ MySQLé…ç½®è¯­æ³•é”™è¯¯"
        return 1
    fi
}

# ä¸»éªŒè¯æµç¨‹

main() {
    local errors=0
    
    validate_nginx || ((errors++))
    validate_mysql || ((errors++))
    
    if [[ $errors -eq 0 ]]; then
        echo "ğŸ‰ æ‰€æœ‰é…ç½®éªŒè¯é€šè¿‡ï¼"
        exit 0
    else
        echo "ğŸ’¥ å‘ç° $errors ä¸ªé…ç½®é”™è¯¯ï¼Œè¯·ä¿®å¤åé‡è¯•"
        exit 1
    fi
}

main "$@"
```

### 8.4 é€»è¾‘éªŒè¯ä¸æœ€ä½³å®è·µæ£€æŸ¥



**ğŸ”¸ é…ç½®é€»è¾‘éªŒè¯æ¸…å•**

```yaml
# nginxé…ç½®é€»è¾‘éªŒè¯è§„åˆ™

nginx_validation_rules:
  port_conflicts:
    - check: "åŒä¸€IPä¸èƒ½ç»‘å®šç›¸åŒç«¯å£"
    - method: "è§£ææ‰€æœ‰listenæŒ‡ä»¤ï¼Œæ£€æŸ¥å†²çª"
    
  upstream_health:
    - check: "upstreamä¸­è‡³å°‘è¦æœ‰ä¸€ä¸ªactiveæœåŠ¡å™¨"  
    - method: "æ£€æŸ¥upstreamå—ä¸­çš„serveræŒ‡ä»¤"
    
  ssl_completeness:
    - check: "å¯ç”¨SSLå¿…é¡»åŒæ—¶é…ç½®è¯ä¹¦å’Œç§é’¥"
    - method: "æ£€æŸ¥ssl_certificateå’Œssl_certificate_keyé…å¯¹"
    
  proxy_settings:
    - check: "proxy_passå¿…é¡»æŒ‡å‘æœ‰æ•ˆçš„upstreamæˆ–URL"
    - method: "éªŒè¯proxy_passç›®æ ‡çš„æœ‰æ•ˆæ€§"
```

**ğŸ”¸ è‡ªå®šä¹‰éªŒè¯è§„åˆ™å®ç°**
```python
#!/usr/bin/env python3

# nginx_logic_validator.py


import re
from pathlib import Path

class NginxValidator:
    def __init__(self, config_file):
        self.config_file = config_file
        self.errors = []
        
    def validate_port_conflicts(self):
        """æ£€æŸ¥ç«¯å£å†²çª"""
        ports = {}
        with open(self.config_file) as f:
            content = f.read()
            
#        # æŸ¥æ‰¾æ‰€æœ‰listenæŒ‡ä»¤
        listen_pattern = r'listen\s+(?:(\d+\.\d+\.\d+\.\d+):)?(\d+)'
        matches = re.findall(listen_pattern, content)
        
        for ip, port in matches:
            key = f"{ip or '0.0.0.0'}:{port}"
            if key in ports:
                self.errors.append(f"ç«¯å£å†²çª: {key} è¢«å¤šæ¬¡ç»‘å®š")
            ports[key] = True
            
    def validate_upstream_health(self):
        """æ£€æŸ¥upstreamå¥åº·çŠ¶æ€"""
        with open(self.config_file) as f:
            content = f.read()
            
#        # æŸ¥æ‰¾upstreamå—
        upstream_pattern = r'upstream\s+(\w+)\s*{([^}]+)}'
        upstreams = re.findall(upstream_pattern, content, re.DOTALL)
        
        for name, block in upstreams:
            servers = re.findall(r'server\s+([^;]+);', block)
            if not servers:
                self.errors.append(f"Upstream '{name}' æ²¡æœ‰é…ç½®ä»»ä½•æœåŠ¡å™¨")
                
    def validate_ssl_configuration(self):
        """æ£€æŸ¥SSLé…ç½®å®Œæ•´æ€§"""
        with open(self.config_file) as f:
            content = f.read()
            
#        # æŸ¥æ‰¾serverå—ä¸­çš„SSLé…ç½®
        server_blocks = re.findall(r'server\s*{([^}]+)}', content, re.DOTALL)
        
        for block in server_blocks:
            if 'listen' in block and 'ssl' in block:
                has_cert = 'ssl_certificate ' in block
                has_key = 'ssl_certificate_key' in block
                
                if not (has_cert and has_key):
                    self.errors.append("SSLæœåŠ¡å™¨ç¼ºå°‘è¯ä¹¦æˆ–ç§é’¥é…ç½®")
                    
    def run_validation(self):
        """è¿è¡Œæ‰€æœ‰éªŒè¯"""
        self.validate_port_conflicts()
        self.validate_upstream_health() 
        self.validate_ssl_configuration()
        
        if self.errors:
            print("å‘ç°ä»¥ä¸‹é…ç½®é—®é¢˜:")
            for error in self.errors:
                print(f"âŒ {error}")
            return False
        else:
            print("âœ… é…ç½®é€»è¾‘éªŒè¯é€šè¿‡")
            return True

# ä½¿ç”¨ç¤ºä¾‹            

if __name__ == "__main__":
    validator = NginxValidator("/etc/nginx/nginx.conf")
    if not validator.run_validation():
        exit(1)
```

### 8.5 å®‰å…¨éªŒè¯



**ğŸ”¸ å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•**

| å®‰å…¨é¡¹ | **æ£€æŸ¥å†…å®¹** | **æœŸæœ›é…ç½®** | **é£é™©ç­‰çº§** |
|-------|-------------|-------------|-------------|
| **æœåŠ¡å™¨ä¿¡æ¯æ³„éœ²** | `server_tokensé…ç½®` | `server_tokens off` | `ğŸŸ¡ ä¸­ç­‰` |
| **SSLå®‰å…¨æ€§** | `SSLåè®®ç‰ˆæœ¬` | `åªå…è®¸TLSv1.2+` | `ğŸ”´ é«˜` |
| **HTTPå®‰å…¨å¤´** | `å®‰å…¨å“åº”å¤´` | `X-Frame-Optionsç­‰` | `ğŸŸ¡ ä¸­ç­‰` |
| **ç›®å½•éå†** | `autoindexé…ç½®` | `autoindex off` | `ğŸŸ  è¾ƒé«˜` |
| **æ•æ„Ÿæ–‡ä»¶ä¿æŠ¤** | `éšè—æ–‡ä»¶è®¿é—®` | `æ‹’ç».å¼€å¤´æ–‡ä»¶è®¿é—®` | `ğŸŸ  è¾ƒé«˜` |

**ğŸ”¸ å®‰å…¨éªŒè¯è„šæœ¬**
```bash
#!/bin/bash

# security_checker.sh


check_server_tokens() {
    if grep -q "server_tokens off" /etc/nginx/nginx.conf; then
        echo "âœ… æœåŠ¡å™¨ä¿¡æ¯éšè—: å·²é…ç½®"
    else
        echo "âš ï¸  æœåŠ¡å™¨ä¿¡æ¯éšè—: å»ºè®®æ·»åŠ  'server_tokens off'"
    fi
}

check_ssl_security() {
    if grep -q "ssl_protocols.*TLSv1.3" /etc/nginx/nginx.conf; then
        echo "âœ… SSLåè®®: ä½¿ç”¨å®‰å…¨ç‰ˆæœ¬"
    else
        echo "ğŸ”´ SSLåè®®: å»ºè®®å‡çº§åˆ°TLSv1.2+ç‰ˆæœ¬"
    fi
}

check_security_headers() {
    local headers=("X-Frame-Options" "X-Content-Type-Options" "X-XSS-Protection")
    local found=0
    
    for header in "${headers[@]}"; do
        if grep -q "$header" /etc/nginx/nginx.conf; then
            ((found++))
        fi
    done
    
    if [[ $found -ge 2 ]]; then
        echo "âœ… å®‰å…¨å“åº”å¤´: é…ç½®è‰¯å¥½ ($found/3)"
    else
        echo "âš ï¸  å®‰å…¨å“åº”å¤´: å»ºè®®æ·»åŠ æ›´å¤šå®‰å…¨å¤´ ($found/3)"
    fi
}

echo "ğŸ”’ å¼€å§‹å®‰å…¨é…ç½®æ£€æŸ¥..."
check_server_tokens
check_ssl_security  
check_security_headers
echo "ğŸ”’ å®‰å…¨æ£€æŸ¥å®Œæˆ"
```

### 8.6 æ€§èƒ½éªŒè¯



**ğŸ”¸ æ€§èƒ½é…ç½®å»ºè®®æ£€æŸ¥**
```yaml
# æ€§èƒ½é…ç½®éªŒè¯è§„åˆ™

performance_checks:
  worker_processes:
    recommended: "auto æˆ– ç­‰äºCPUæ ¸æ•°"
    check_method: "æ¯”è¾ƒé…ç½®å€¼ä¸ nproc è¾“å‡º"
    
  worker_connections:
    recommended: "1024 æˆ–æ›´é«˜"
    max_safe: "65535"
    
  keepalive_timeout:
    recommended: "65ç§’"
    range: "30-75ç§’ä¹‹é—´"
    
  gzip_compression:
    recommended: "å¯ç”¨gzipå‹ç¼©"
    check_items: ["gzip on", "gzip_vary on"]
```

**ğŸ”¸ æ€§èƒ½éªŒè¯å®ç°**
```bash
#!/bin/bash

# performance_checker.sh


check_worker_processes() {
    local configured=$(grep "worker_processes" /etc/nginx/nginx.conf | awk '{print $2}' | tr -d ';')
    local cpu_cores=$(nproc)
    
    if [[ "$configured" == "auto" ]]; then
        echo "âœ… Workerè¿›ç¨‹æ•°: auto (æ¨èé…ç½®)"
    elif [[ "$configured" -eq "$cpu_cores" ]]; then
        echo "âœ… Workerè¿›ç¨‹æ•°: $configured (åŒ¹é…CPUæ ¸æ•°)"
    else
        echo "âš ï¸  Workerè¿›ç¨‹æ•°: $configured (CPUæ ¸æ•°: $cpu_coresï¼Œå»ºè®®è®¾ç½®ä¸ºautoæˆ–$cpu_cores)"
    fi
}

check_worker_connections() {
    local connections=$(grep "worker_connections" /etc/nginx/nginx.conf | awk '{print $2}' | tr -d ';')
    
    if [[ $connections -ge 1024 ]]; then
        echo "âœ… Workerè¿æ¥æ•°: $connections (é…ç½®åˆç†)"
    else
        echo "âš ï¸  Workerè¿æ¥æ•°: $connections (å»ºè®®è‡³å°‘1024)"
    fi
}

check_gzip_compression() {
    if grep -q "gzip on" /etc/nginx/nginx.conf; then
        echo "âœ… Gzipå‹ç¼©: å·²å¯ç”¨"
    else
        echo "âš ï¸  Gzipå‹ç¼©: å»ºè®®å¯ç”¨ä»¥æå‡æ€§èƒ½"
    fi
}

echo "ğŸš€ å¼€å§‹æ€§èƒ½é…ç½®æ£€æŸ¥..."
check_worker_processes
check_worker_connections
check_gzip_compression
echo "ğŸš€ æ€§èƒ½æ£€æŸ¥å®Œæˆ"
```

---

## 9. ğŸ”„ é”™è¯¯é…ç½®å›æ»šæœºåˆ¶



### 9.1 å›æ»šæœºåˆ¶çš„å¿…è¦æ€§



**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦å›æ»šæœºåˆ¶**
ä»»ä½•äººéƒ½å¯èƒ½å‡ºé”™ï¼ŒåŒ…æ‹¬ç»éªŒä¸°å¯Œçš„è¿ç»´å·¥ç¨‹å¸ˆã€‚å›æ»šæœºåˆ¶å°±åƒ"åæ‚”è¯"ï¼Œå½“å‘ç°é…ç½®æœ‰é—®é¢˜æ—¶ï¼Œèƒ½å¿«é€Ÿæ¢å¤åˆ°ä¹‹å‰çš„æ­£å¸¸çŠ¶æ€ã€‚

```
å…¸å‹æ•…éšœåœºæ™¯ï¼š
æ—¶é—´ 14:00 - éƒ¨ç½²æ–°çš„nginxé…ç½®
æ—¶é—´ 14:05 - ç½‘ç«™è®¿é—®ç¼“æ…¢
æ—¶é—´ 14:10 - ç½‘ç«™å®Œå…¨æ— æ³•è®¿é—®  
æ—¶é—´ 14:15 - å®¢æˆ·å¼€å§‹æŠ•è¯‰
æ—¶é—´ 14:20 - ç´§æ€¥å›æ»šé…ç½®
æ—¶é—´ 14:25 - æœåŠ¡æ¢å¤æ­£å¸¸

å›æ»šä»·å€¼ï¼š
- æ•…éšœæŒç»­æ—¶é—´ï¼šä»æ•°å°æ—¶ç¼©çŸ­åˆ°å‡ åˆ†é’Ÿ
- ä¸šåŠ¡å½±å“ï¼šä»ä¸¥é‡å½±å“åˆ°è½»å¾®å½±å“  
- ç”¨æˆ·ä½“éªŒï¼šä»å¤§é‡æŠ•è¯‰åˆ°å‡ ä¹æ— æ„ŸçŸ¥
```

### 9.2 å¤‡ä»½ç­–ç•¥è®¾è®¡



**ğŸ”¸ å¤šå±‚å¤‡ä»½ç­–ç•¥**
```
å®æ—¶å¤‡ä»½å±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é…ç½®å˜æ›´å‰è‡ªåŠ¨å¤‡ä»½              â”‚  <- æ¯æ¬¡å˜æ›´éƒ½å¤‡ä»½
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®šæœŸå¤‡ä»½å±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
â”‚ æ¯æ—¥å®šæ—¶å¤‡ä»½å½“å‰é…ç½®            â”‚  <- å®šæœŸä¿å­˜å¿«ç…§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰ˆæœ¬æ§åˆ¶å±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Gitä»“åº“ä¿å­˜æ‰€æœ‰å†å²ç‰ˆæœ¬         â”‚  <- é•¿æœŸç‰ˆæœ¬ç®¡ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å†·å¤‡ä»½å±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é‡è¦ç‰ˆæœ¬å¼‚åœ°å¤‡ä»½                â”‚  <- ç¾éš¾æ¢å¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ å¤‡ä»½æ–‡ä»¶å‘½åè§„èŒƒ**
```bash
# å¤‡ä»½æ–‡ä»¶å‘½åæ ¼å¼: åŸæ–‡ä»¶å.backup.æ—¶é—´æˆ³

nginx.conf.backup.20231201-143022
my.cnf.backup.20231201-143055  
redis.conf.backup.20231201-143120

# ç‰ˆæœ¬æ ‡è®°å¤‡ä»½: åŸæ–‡ä»¶å.ç‰ˆæœ¬å·.backup

nginx.conf.v1.2.0.backup
nginx.conf.v1.1.9.backup
nginx.conf.v1.1.8.backup
```

### 9.3 è‡ªåŠ¨å¤‡ä»½å®ç°



**ğŸ”¸ é…ç½®å˜æ›´å‰è‡ªåŠ¨å¤‡ä»½**
```bash
#!/bin/bash

# auto_backup.sh - è‡ªåŠ¨å¤‡ä»½è„šæœ¬


backup_config() {
    local config_file="$1"
    local service_name="$2"
    local timestamp=$(date +%Y%m%d-%H%M%S)
    local backup_dir="/var/backups/configs/$service_name"
    
#    # åˆ›å»ºå¤‡ä»½ç›®å½•
    mkdir -p "$backup_dir"
    
#    # æ£€æŸ¥åŸé…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [[ ! -f "$config_file" ]]; then
        echo "è­¦å‘Š: é…ç½®æ–‡ä»¶ $config_file ä¸å­˜åœ¨"
        return 1
    fi
    
#    # æ‰§è¡Œå¤‡ä»½
    local backup_file="$backup_dir/$(basename $config_file).backup.$timestamp"
    
    if cp "$config_file" "$backup_file"; then
        echo "âœ… é…ç½®å¤‡ä»½æˆåŠŸ: $backup_file"
        
#        # è®°å½•å¤‡ä»½ä¿¡æ¯
        echo "$(date '+%Y-%m-%d %H:%M:%S') - $config_file -> $backup_file" >> "$backup_dir/backup.log"
        
#        # æ¸…ç†æ—§å¤‡ä»½(ä¿ç•™æœ€è¿‘10ä¸ª)
        ls -t "$backup_dir"/*.backup.* 2>/dev/null | tail -n +11 | xargs -r rm
        
        return 0
    else
        echo "âŒ é…ç½®å¤‡ä»½å¤±è´¥: $config_file"
        return 1
    fi
}

# ä½¿ç”¨ç¤ºä¾‹

backup_config "/etc/nginx/nginx.conf" "nginx"
backup_config "/etc/mysql/my.cnf" "mysql"
```

**ğŸ”¸ Ansibleé›†æˆçš„è‡ªåŠ¨å¤‡ä»½**
```yaml
# backup-and-deploy.yml

- name: Deploy configuration with auto backup
  hosts: webservers
  
  tasks:
    - name: Create backup directory
      file:
        path: "/var/backups/configs/{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - nginx
        - php
        - mysql
        
    - name: Backup current nginx config
      copy:
        src: /etc/nginx/nginx.conf
        dest: "/var/backups/configs/nginx/nginx.conf.backup.{{ ansible_date_time.epoch }}"
        backup: yes
      when: ansible_check_mode == false
      
    - name: Deploy new nginx config
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/nginx.conf
        backup: yes
        validate: 'nginx -t -c %s'
      notify: reload nginx
      register: nginx_config_result
      
    - name: Record deployment info
      lineinfile:
        path: "/var/backups/configs/nginx/deploy.log"
        line: "{{ ansible_date_time.iso8601 }} - Deployed by {{ ansible_user }} from {{ inventory_hostname }}"
        create: yes
```

### 9.4 å¿«é€Ÿå›æ»šå®ç°



**ğŸ”¸ ä¸€é”®å›æ»šè„šæœ¬**
```bash
#!/bin/bash

# quick_rollback.sh - å¿«é€Ÿå›æ»šè„šæœ¬


BACKUP_DIR="/var/backups/configs"
LOG_FILE="/var/log/rollback.log"

show_backups() {
    local service="$1"
    echo "å¯ç”¨çš„ $service é…ç½®å¤‡ä»½:"
    echo "----------------------------------------"
    
    local backup_files=($(ls -t "$BACKUP_DIR/$service"/*.backup.* 2>/dev/null))
    
    if [[ ${#backup_files[@]} -eq 0 ]]; then
        echo "æ²¡æœ‰æ‰¾åˆ° $service çš„é…ç½®å¤‡ä»½"
        return 1
    fi
    
    for i in "${!backup_files[@]}"; do
        local file="${backup_files[$i]}"
        local timestamp=$(basename "$file" | sed 's/.*backup\.//')
        local size=$(du -h "$file" | cut -f1)
        local date=$(date -d "@${timestamp:0:8}" +"%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "Unknown")
        
        printf "%2d) %s (%s, %s)\n" $((i+1)) "$(basename "$file")" "$size" "$date"
    done
    
    return 0
}

rollback_config() {
    local service="$1"
    local backup_choice="$2"
    
#    # è·å–é…ç½®æ–‡ä»¶è·¯å¾„
    case "$service" in
        "nginx")
            local config_file="/etc/nginx/nginx.conf"
            local test_command="nginx -t"
            local reload_command="systemctl reload nginx"
            ;;
        "mysql")
            local config_file="/etc/mysql/my.cnf"
            local test_command="mysqld --help --verbose >/dev/null"
            local reload_command="systemctl restart mysql"
            ;;
        "apache")
            local config_file="/etc/apache2/apache2.conf"
            local test_command="apache2ctl configtest"
            local reload_command="systemctl reload apache2"
            ;;
        *)
            echo "ä¸æ”¯æŒçš„æœåŠ¡: $service"
            return 1
            ;;
    esac
    
#    # è·å–å¤‡ä»½æ–‡ä»¶åˆ—è¡¨
    local backup_files=($(ls -t "$BACKUP_DIR/$service"/*.backup.* 2>/dev/null))
    
    if [[ $backup_choice -lt 1 || $backup_choice -gt ${#backup_files[@]} ]]; then
        echo "æ— æ•ˆçš„é€‰æ‹©: $backup_choice"
        return 1
    fi
    
    local selected_backup="${backup_files[$((backup_choice-1))]}"
    
    echo "å‡†å¤‡å›æ»šåˆ°: $(basename "$selected_backup")"
    read -p "ç¡®è®¤æ‰§è¡Œå›æ»š? (y/N): " confirm
    
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        echo "å›æ»šå·²å–æ¶ˆ"
        return 0
    fi
    
#    # å¤‡ä»½å½“å‰é…ç½®
    local current_backup="$BACKUP_DIR/$service/$(basename "$config_file").backup.$(date +%s)"
    cp "$config_file" "$current_backup"
    
#    # æ‰§è¡Œå›æ»š
    if cp "$selected_backup" "$config_file"; then
        echo "âœ… é…ç½®æ–‡ä»¶å·²å›æ»š"
        
#        # éªŒè¯é…ç½®
        if eval "$test_command" >/dev/null 2>&1; then
            echo "âœ… é…ç½®éªŒè¯æˆåŠŸ"
            
#            # é‡è½½æœåŠ¡
            if eval "$reload_command"; then
                echo "âœ… æœåŠ¡é‡è½½æˆåŠŸ"
                
#                # è®°å½•å›æ»šæ—¥å¿—
                echo "$(date '+%Y-%m-%d %H:%M:%S') - $service rollback from $(basename "$selected_backup") - SUCCESS" >> "$LOG_FILE"
                
                return 0
            else
                echo "âŒ æœåŠ¡é‡è½½å¤±è´¥"
#                # å°è¯•æ¢å¤
                cp "$current_backup" "$config_file"
                return 1
            fi
        else
            echo "âŒ å›æ»šåé…ç½®éªŒè¯å¤±è´¥ï¼Œæ­£åœ¨æ¢å¤..."
            cp "$current_backup" "$config_file"
            return 1
        fi
    else
        echo "âŒ é…ç½®æ–‡ä»¶å›æ»šå¤±è´¥"
        return 1
    fi
}

# ä¸»å‡½æ•°

main() {
    local service="$1"
    
    if [[ -z "$service" ]]; then
        echo "ç”¨æ³•: $0 <service> [backup_number]"
        echo "æ”¯æŒçš„æœåŠ¡: nginx, mysql, apache"
        exit 1
    fi
    
    if ! show_backups "$service"; then
        exit 1
    fi
    
    if [[ -n "$2" ]]; then
#        # ç›´æ¥ä½¿ç”¨æŒ‡å®šçš„å¤‡ä»½ç¼–å·
        rollback_config "$service" "$2"
    else
#        # äº¤äº’å¼é€‰æ‹©
        echo ""
        read -p "è¯·é€‰æ‹©è¦å›æ»šçš„é…ç½® (ç¼–å·): " choice
        rollback_config "$service" "$choice"
    fi
}

main "$@"
```

### 9.5 æ‰¹é‡å›æ»šä¸é›†ç¾¤å›æ»š



**ğŸ”¸ Ansibleæ‰¹é‡å›æ»š**
```yaml
# cluster_rollback.yml - é›†ç¾¤å›æ»šplaybook

- name: Cluster Configuration Rollback
  hosts: "{{ target_group | default('all') }}"
  serial: "{{ rollback_batch_size | default(3) }}"  # åˆ†æ‰¹å›æ»šï¼Œé¿å…å…¨éƒ¨æœåŠ¡åŒæ—¶ä¸­æ–­
  
  vars:
    rollback_service: "{{ service_name }}"
    target_backup: "{{ backup_timestamp }}"
    
  tasks:
    - name: Check if backup exists
      stat:
        path: "/var/backups/configs/{{ rollback_service }}/{{ rollback_service }}.conf.backup.{{ target_backup }}"
      register: backup_check
      
    - name: Fail if backup not found
      fail:
        msg: "Backup file not found for timestamp {{ target_backup }}"
      when: not backup_check.stat.exists
      
    - name: Create current config backup
      copy:
        src: "/etc/{{ rollback_service }}/{{ rollback_service }}.conf"
        dest: "/var/backups/configs/{{ rollback_service }}/pre-rollback.backup.{{ ansible_date_time.epoch }}"
        backup: yes
        
    - name: Execute rollback
      copy:
        src: "/var/backups/configs/{{ rollback_service }}/{{ rollback_service }}.conf.backup.{{ target_backup }}"
        dest: "/etc/{{ rollback_service }}/{{ rollback_service }}.conf"
        backup: yes
      register: rollback_result
      
    - name: Validate rolled-back configuration
      command: "{{ item }}"
      loop:
        - "nginx -t"
      when: rollback_service == "nginx"
      register: validation_result
      
    - name: Reload service if validation passed
      systemd:
        name: "{{ rollback_service }}"
        state: reloaded
      when: validation_result is succeeded
      
    - name: Revert rollback if validation failed
      copy:
        src: "/var/backups/configs/{{ rollback_service }}/pre-rollback.backup.{{ ansible_date_time.epoch }}"
        dest: "/etc/{{ rollback_service }}/{{ rollback_service }}.conf"
      when: validation_result is failed
      
    - name: Record rollback status
      lineinfile:
        path: "/var/log/rollback.log"
        line: "{{ ansible_date_time.iso8601 }} - {{ inventory_hostname }} - {{ rollback_service }} - {{ 'SUCCESS' if validation_result is succeeded else 'FAILED' }}"
        
  handlers:
    - name: Send rollback notification
      mail:
        to: ops-team@company.com
        subject: "Configuration Rollback {{ 'Completed' if validation_result is succeeded else 'Failed' }}"
        body: |
          Rollback Details:
          - Service: {{ rollback_service }}
          - Target: {{ target_group }}
          - Backup: {{ target_backup }}
          - Status: {{ 'SUCCESS' if validation_result is succeeded else 'FAILED' }}
          - Time: {{ ansible_date_time.iso8601 }}
```

**ğŸ”¸ å›æ»šæ‰§è¡Œç¤ºä¾‹**
```bash
# å›æ»šå•å°æœåŠ¡å™¨çš„nginxé…ç½®

./quick_rollback.sh nginx 1

# ä½¿ç”¨Ansibleå›æ»šæ•´ä¸ªWebé›†ç¾¤

ansible-playbook cluster_rollback.yml \
  -e "service_name=nginx" \
  -e "target_group=webservers" \
  -e "backup_timestamp=20231201-143022" \
  -e "rollback_batch_size=2"

# ç´§æ€¥å›æ»šæ‰€æœ‰æœåŠ¡å™¨åˆ°æŒ‡å®šæ—¶é—´ç‚¹

ansible-playbook cluster_rollback.yml \
  -e "service_name=nginx" \
  -e "target_group=all" \
  -e "backup_timestamp=20231201-120000" \
  --limit="!database_servers"  # æ’é™¤æ•°æ®åº“æœåŠ¡å™¨
```

### 9.6 å›æ»šç›‘æ§ä¸å‘Šè­¦



**ğŸ”¸ å›æ»šçŠ¶æ€ç›‘æ§**
```bash
#!/bin/bash

# rollback_monitor.sh - å›æ»šç›‘æ§è„šæœ¬


monitor_rollback_health() {
    local service="$1"
    local check_interval=30
    local max_checks=10
    local checks=0
    
    echo "å¼€å§‹ç›‘æ§ $service æœåŠ¡å›æ»šåçŠ¶æ€..."
    
    while [[ $checks -lt $max_checks ]]; do
        case "$service" in
            "nginx")
                if curl -s -o /dev/null -w "%{http_code}" http://localhost | grep -q "200\|301\|302"; then
                    echo "âœ… HTTPæœåŠ¡æ­£å¸¸å“åº”"
                    return 0
                fi
                ;;
            "mysql")
                if mysqladmin ping >/dev/null 2>&1; then
                    echo "âœ… MySQLæœåŠ¡æ­£å¸¸å“åº”"
                    return 0
                fi
                ;;
        esac
        
        ((checks++))
        echo "æ£€æŸ¥ $checks/$max_checks - æœåŠ¡æš‚æœªæ¢å¤ï¼Œç­‰å¾… $check_interval ç§’..."
        sleep $check_interval
    done
    
    echo "âŒ æœåŠ¡åœ¨ $((max_checks * check_interval)) ç§’åä»æœªæ¢å¤æ­£å¸¸"
    return 1
}

# å‘é€å‘Šè­¦é€šçŸ¥

send_rollback_alert() {
    local service="$1"
    local status="$2"
    local message="$3"
    
#    # å‘é€é‚®ä»¶å‘Šè­¦
    echo "$message" | mail -s "ALERT: $service Rollback $status" ops-team@company.com
    
#    # å‘é€Slacké€šçŸ¥(å¦‚æœé…ç½®äº†webhook)
    if [[ -n "$SLACK_WEBHOOK" ]]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš¨ *$service Rollback $status*\n$message\"}" \
            "$SLACK_WEBHOOK"
    fi
}

# ä¸»ç›‘æ§é€»è¾‘

main() {
    local service="$1"
    
    if monitor_rollback_health "$service"; then
        send_rollback_alert "$service" "SUCCESS" "æœåŠ¡ $service å›æ»šæˆåŠŸï¼Œè¿è¡Œæ­£å¸¸"
    else
        send_rollback_alert "$service" "FAILED" "è­¦å‘Šï¼šæœåŠ¡ $service å›æ»šåçŠ¶æ€å¼‚å¸¸ï¼Œéœ€è¦äººå·¥ä»‹å…¥"
        exit 1
    fi
}

main "$@"
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ é…ç½®æ¨¡æ¿ç®¡ç†ç³»ç»Ÿï¼šè‡ªåŠ¨åŒ–ç”Ÿæˆé…ç½®æ–‡ä»¶çš„"ç”Ÿäº§å·¥å‚"
ğŸ”¸ æ¨¡æ¿è¯­æ³•ï¼šJinja2ä¸ºä¸»ï¼Œæ”¯æŒå˜é‡æ›¿æ¢ã€æ¡ä»¶åˆ¤æ–­ã€å¾ªç¯æ§åˆ¶
ğŸ”¸ å˜é‡æœºåˆ¶ï¼šå¤šå±‚æ¬¡å˜é‡å®šä¹‰ï¼Œä¼˜å…ˆçº§ç®¡ç†ï¼Œä½œç”¨åŸŸæ§åˆ¶
ğŸ”¸ ç»§æ‰¿åŒ…å«ï¼šä»£ç å¤ç”¨çš„ä¸¤ç§æ–¹å¼ï¼Œå‚ç›´ç»§æ‰¿+æ°´å¹³åŒ…å«
ğŸ”¸ ç”Ÿæˆæµç¨‹ï¼šå‡†å¤‡-å¤„ç†-è¾“å‡º-éƒ¨ç½²çš„å®Œæ•´è‡ªåŠ¨åŒ–æµç¨‹
ğŸ”¸ ç‰ˆæœ¬æ§åˆ¶ï¼šGitç®¡ç†æ¨¡æ¿ç‰ˆæœ¬ï¼Œæ”¯æŒå›é€€å’Œå˜æ›´è·Ÿè¸ª
ğŸ”¸ é…ç½®éªŒè¯ï¼šè¯­æ³•-é€»è¾‘-å®‰å…¨-æ€§èƒ½çš„å››å±‚éªŒè¯ä½“ç³»
ğŸ”¸ å›æ»šæœºåˆ¶ï¼šå¤šå±‚å¤‡ä»½+å¿«é€Ÿå›æ»š+çŠ¶æ€ç›‘æ§çš„å®Œæ•´ä¿éšœ
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ é…ç½®æ¨¡æ¿çš„æœ¬è´¨ä»·å€¼**
```
æ•ˆç‡æå‡ï¼š
- ä¼ ç»Ÿæ–¹å¼ï¼š100å°æœåŠ¡å™¨ Ã— 30åˆ†é’Ÿ/å° = 50å°æ—¶
- æ¨¡æ¿æ–¹å¼ï¼š1ä¸ªæ¨¡æ¿ + 10åˆ†é’Ÿéƒ¨ç½² = 0.2å°æ—¶
- æ•ˆç‡æå‡ï¼š250å€

è´¨é‡ä¿éšœï¼š
- äººå·¥é…ç½®é”™è¯¯ç‡ï¼š5-10%
- æ¨¡æ¿è‡ªåŠ¨åŒ–é”™è¯¯ç‡ï¼š<1%
- è´¨é‡æå‡ï¼š10å€

ç»´æŠ¤ä¾¿åˆ©ï¼š
- ä¼ ç»Ÿç»´æŠ¤ï¼šä¿®æ”¹100ä¸ªæ–‡ä»¶
- æ¨¡æ¿ç»´æŠ¤ï¼šä¿®æ”¹1ä¸ªæ¨¡æ¿
- ç»´æŠ¤æˆæœ¬ï¼šé™ä½99%
```

**ğŸ”¹ æ¨¡æ¿è¯­æ³•çš„å­¦ä¹ é‡ç‚¹**
```
æ ¸å¿ƒè¯­æ³•ä¼˜å…ˆçº§ï¼š
1. å˜é‡æ›¿æ¢ {{ variable }} - æœ€åŸºç¡€ï¼Œå¿…é¡»æŒæ¡
2. æ¡ä»¶åˆ¤æ–­ {% if %} - ä¸šåŠ¡é€»è¾‘æ§åˆ¶
3. å¾ªç¯æ§åˆ¶ {% for %} - æ‰¹é‡ç”Ÿæˆé…ç½®
4. è¿‡æ»¤å™¨ |default() - å®¹é”™å¤„ç†
5. ç»§æ‰¿åŒ…å« {% extends %} - é«˜çº§å¤ç”¨

å­¦ä¹ å»ºè®®ï¼š
- å…ˆå­¦ä¼šåŸºæœ¬å˜é‡æ›¿æ¢ï¼Œèƒ½è§£å†³80%çš„é—®é¢˜
- å†å­¦æ¡ä»¶å’Œå¾ªç¯ï¼Œèƒ½è§£å†³å¤æ‚åœºæ™¯
- æœ€åå­¦ç»§æ‰¿åŒ…å«ï¼Œæå‡ä»£ç è´¨é‡
```

**ğŸ”¹ ç‰ˆæœ¬æ§åˆ¶çš„é‡è¦æ€§**
```
é£é™©æ§åˆ¶ï¼š
- æ— ç‰ˆæœ¬æ§åˆ¶ï¼šæ”¹é”™äº†ä¸çŸ¥é“æ”¹äº†ä»€ä¹ˆ
- æœ‰ç‰ˆæœ¬æ§åˆ¶ï¼šæ¯æ¬¡å˜æ›´éƒ½æœ‰è®°å½•ï¼Œå¯å¿«é€Ÿå®šä½é—®é¢˜

åä½œæ•ˆç‡ï¼š  
- æ— ç‰ˆæœ¬æ§åˆ¶ï¼šå¤šäººä¿®æ”¹å®¹æ˜“å†²çªè¦†ç›–
- æœ‰ç‰ˆæœ¬æ§åˆ¶ï¼šåˆ†æ”¯å¼€å‘ï¼Œåˆå¹¶ç®¡ç†

è¿ç»´ä¿éšœï¼š
- æ— ç‰ˆæœ¬æ§åˆ¶ï¼šå›æ»šå›°éš¾ï¼Œæ¢å¤æ—¶é—´é•¿
- æœ‰ç‰ˆæœ¬æ§åˆ¶ï¼šä¸€é”®å›æ»šï¼Œç§’çº§æ¢å¤
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼



**ğŸ¯ é€‚ç”¨åœºæ™¯åˆ¤æ–­**
```
âœ… å¼ºçƒˆæ¨èä½¿ç”¨ï¼š
- æœåŠ¡å™¨æ•°é‡ > 5å°
- å¤šç¯å¢ƒéƒ¨ç½²(å¼€å‘/æµ‹è¯•/ç”Ÿäº§)
- é…ç½®ç»å¸¸å˜æ›´
- å›¢é˜Ÿåä½œè¿ç»´

âš ï¸ è°¨æ…è¯„ä¼°ä½¿ç”¨ï¼š
- å•å°æœåŠ¡å™¨ç®€å•åº”ç”¨
- é…ç½®æå°‘å˜æ›´
- è¿ç»´å›¢é˜Ÿåªæœ‰1äºº

âŒ ä¸å»ºè®®ä½¿ç”¨ï¼š
- ä¸€æ¬¡æ€§ä¸´æ—¶éƒ¨ç½²
- é…ç½®éå¸¸ç®€å•(å‡ è¡Œ)
- å­¦ä¹ æˆæœ¬è¶…è¿‡æ”¶ç›Š
```

**ğŸ”§ å®æ–½å»ºè®®**
```
èµ·æ­¥é˜¶æ®µï¼š
1. é€‰æ‹©1-2ä¸ªå¸¸ç”¨æœåŠ¡å¼€å§‹(å¦‚nginx)
2. å­¦ä¹ åŸºæœ¬çš„Jinja2è¯­æ³•
3. å»ºç«‹ç®€å•çš„Gitç‰ˆæœ¬æ§åˆ¶

è¿›é˜¶é˜¶æ®µï¼š
1. å»ºç«‹å®Œæ•´çš„æ¨¡æ¿ä»“åº“ç»“æ„
2. å®æ–½è‡ªåŠ¨åŒ–éªŒè¯å’Œéƒ¨ç½²
3. å®Œå–„å›æ»šå’Œç›‘æ§æœºåˆ¶

æˆç†Ÿé˜¶æ®µï¼š
1. é›†æˆCI/CDæµæ°´çº¿
2. å»ºç«‹é…ç½®ç®¡ç†å¹³å°
3. å®ç°æ™ºèƒ½åŒ–é…ç½®ä¼˜åŒ–
```

**ğŸ“Š æ•ˆæœè¯„ä¼°æŒ‡æ ‡**

| æŒ‡æ ‡ | **è¯„ä¼°æ–¹æ³•** | **ç›®æ ‡å€¼** | **ç›‘æ§å‘¨æœŸ** |
|------|-------------|-----------|-------------|
| **éƒ¨ç½²æ•ˆç‡** | `éƒ¨ç½²æ—¶é—´å¯¹æ¯”` | `å‡å°‘90%+` | `æ¯æœˆç»Ÿè®¡` |
| **é…ç½®é”™è¯¯ç‡** | `æ•…éšœæ•°é‡ç»Ÿè®¡` | `<1%` | `æ¯å‘¨ç»Ÿè®¡` |
| **å›æ»šæˆåŠŸç‡** | `å›æ»šæ“ä½œæˆåŠŸæ¯”ä¾‹` | `>95%` | `æ¯æ¬¡è®°å½•` |
| **å›¢é˜Ÿæ»¡æ„åº¦** | `è¿ç»´å›¢é˜Ÿåé¦ˆ` | `8åˆ†ä»¥ä¸Š(10åˆ†åˆ¶)` | `å­£åº¦è°ƒç ”` |

### 10.4 è¿›é˜¶å­¦ä¹ æ–¹å‘



**ğŸš€ æŠ€æœ¯æ·±å…¥æ–¹å‘**
```
æ¨¡æ¿å¼•æ“æ‰©å±•ï¼š
- å­¦ä¹ Go Templateã€Mustacheç­‰å…¶ä»–å¼•æ“
- è‡ªå®šä¹‰è¿‡æ»¤å™¨å’Œå‡½æ•°å¼€å‘
- æ¨¡æ¿æ€§èƒ½ä¼˜åŒ–æŠ€å·§

é…ç½®ç®¡ç†å¹³å°ï¼š
- é›†æˆé…ç½®ç®¡ç†æ•°æ®åº“(CMDB)
- å¼€å‘Webç•Œé¢ç®¡ç†å¹³å°
- å®ç°é…ç½®å˜æ›´å®¡æ‰¹æµç¨‹

æ™ºèƒ½åŒ–è¿ç»´ï¼š
- åŸºäºæœºå™¨å­¦ä¹ çš„é…ç½®ä¼˜åŒ–
- è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜
- æ™ºèƒ½æ•…éšœé¢„æµ‹å’Œå¤„ç†
```

**ğŸ”— ç”Ÿæ€å·¥å…·æ•´åˆ**
```
CI/CDé›†æˆï¼š
- Jenkins/GitLab CIä¸­é›†æˆæ¨¡æ¿éƒ¨ç½²
- è‡ªåŠ¨åŒ–æµ‹è¯•éªŒè¯
- è“ç»¿éƒ¨ç½²å’Œç°åº¦å‘å¸ƒ

ç›‘æ§å‘Šè­¦é›†æˆï¼š
- Prometheusç›‘æ§æŒ‡æ ‡é‡‡é›†
- Grafanaå¯è§†åŒ–å±•ç¤º
- AlertManagerå‘Šè­¦é€šçŸ¥

å®¹å™¨åŒ–éƒ¨ç½²ï¼š
- Kubernetes ConfigMapç®¡ç†
- Helm Chartæ¨¡æ¿åŒ–
- Dockeré…ç½®æ–‡ä»¶åŠ¨æ€ç”Ÿæˆ
```

> ğŸ’¡ **æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
> - æ¨¡æ¿å˜é‡å·§æ›¿æ¢ï¼Œæ¡ä»¶å¾ªç¯é€»è¾‘å…¨
> - ç»§æ‰¿åŒ…å«æå¤ç”¨ï¼Œç‰ˆæœ¬æ§åˆ¶ä¿å®‰å…¨
> - éªŒè¯å›æ»šåŒä¿é™©ï¼Œè‡ªåŠ¨è¿ç»´æ•ˆç‡å·…

**ğŸ¯ æœ€ç»ˆç›®æ ‡**ï¼šé€šè¿‡é…ç½®æ¨¡æ¿ç®¡ç†ç³»ç»Ÿï¼Œå®ç°"ä¸€å¤„ç¼–å†™ï¼Œå¤„å¤„è¿è¡Œ"çš„é…ç½®ç®¡ç†ç†å¿µï¼Œè®©è¿ç»´å·¥ä½œä»"ä½“åŠ›æ´»"å˜æˆ"è„‘åŠ›æ´»"ï¼Œä»"æ•‘ç«é˜Ÿå‘˜"å˜æˆ"æ¶æ„å¸ˆ"ã€‚