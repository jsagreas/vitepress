---
title: 8ã€systemdå®‰å…¨æœºåˆ¶é…ç½®
---
## ğŸ“š ç›®å½•

1. [systemdå®‰å…¨æœºåˆ¶æ¦‚è¿°](#1-systemdå®‰å…¨æœºåˆ¶æ¦‚è¿°)
2. [ç”¨æˆ·æƒé™éš”ç¦»é…ç½®](#2-ç”¨æˆ·æƒé™éš”ç¦»é…ç½®)
3. [æ–‡ä»¶ç³»ç»Ÿéš”ç¦»æœºåˆ¶](#3-æ–‡ä»¶ç³»ç»Ÿéš”ç¦»æœºåˆ¶)
4. [ç½‘ç»œéš”ç¦»ä¸è®¿é—®æ§åˆ¶](#4-ç½‘ç»œéš”ç¦»ä¸è®¿é—®æ§åˆ¶)
5. [ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤æœºåˆ¶](#5-ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤æœºåˆ¶)
6. [èƒ½åŠ›é™åˆ¶ä¸æƒé™æ§åˆ¶](#6-èƒ½åŠ›é™åˆ¶ä¸æƒé™æ§åˆ¶)
7. [è¿›ç¨‹éš”ç¦»ä¸ç³»ç»Ÿä¿æŠ¤](#7-è¿›ç¨‹éš”ç¦»ä¸ç³»ç»Ÿä¿æŠ¤)
8. [å®‰å…¨é…ç½®æœ€ä½³å®è·µ](#8-å®‰å…¨é…ç½®æœ€ä½³å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” systemdå®‰å…¨æœºåˆ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯systemdå®‰å…¨æœºåˆ¶


**ğŸ’¡ ç®€å•ç†è§£**
```
systemdå®‰å…¨æœºåˆ¶å°±åƒç»™æœåŠ¡ç©¿ä¸Šå¤šå±‚é˜²æŠ¤æœï¼š
- ç¬¬ä¸€å±‚ï¼šé™åˆ¶ç”¨æˆ·æƒé™ï¼ˆè°èƒ½åšä»€ä¹ˆï¼‰
- ç¬¬äºŒå±‚ï¼šéš”ç¦»æ–‡ä»¶è®¿é—®ï¼ˆèƒ½çœ‹åˆ°ä»€ä¹ˆæ–‡ä»¶ï¼‰
- ç¬¬ä¸‰å±‚ï¼šæ§åˆ¶ç½‘ç»œè®¿é—®ï¼ˆèƒ½è®¿é—®å“ªäº›ç½‘ç»œï¼‰
- ç¬¬å››å±‚ï¼šè¿‡æ»¤ç³»ç»Ÿè°ƒç”¨ï¼ˆèƒ½è°ƒç”¨å“ªäº›ç³»ç»ŸåŠŸèƒ½ï¼‰
- ç¬¬äº”å±‚ï¼šé™åˆ¶ç³»ç»Ÿèƒ½åŠ›ï¼ˆæ‹¥æœ‰å“ªäº›ç‰¹æ®Šæƒé™ï¼‰
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦systemdå®‰å…¨æœºåˆ¶


**ğŸ¯ æ ¸å¿ƒä½œç”¨**
```
ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š
WebæœåŠ¡ â†’ ä»¥rootæƒé™è¿è¡Œ â†’ è¢«æ”»å‡»åæ•´ä¸ªç³»ç»Ÿæ²¦é™·

systemdå®‰å…¨æœºåˆ¶ï¼š
WebæœåŠ¡ â†’ å—é™ç”¨æˆ· â†’ éš”ç¦»ç¯å¢ƒ â†’ æœ€å°æƒé™
    â†“
å³ä½¿è¢«æ”»å‡»ï¼Œå½±å“èŒƒå›´ä¹Ÿè¢«ä¸¥æ ¼é™åˆ¶
```

**ğŸ“Š å®‰å…¨å±‚æ¬¡å¯¹æ¯”**
| å®‰å…¨çº§åˆ« | **ä¼ ç»Ÿæ–¹å¼** | **systemdå®‰å…¨æœºåˆ¶** | **é˜²æŠ¤æ•ˆæœ** |
|---------|-------------|-------------------|------------|
| ğŸ”“ **åŸºç¡€** | `rootæƒé™è¿è¡Œ` | `ä¸“ç”¨ç”¨æˆ·è¿è¡Œ` | `é˜²æ­¢æƒé™æ»¥ç”¨` |
| ğŸ”’ **ä¸­çº§** | `è®¿é—®æ‰€æœ‰æ–‡ä»¶` | `æ–‡ä»¶ç³»ç»Ÿéš”ç¦»` | `ä¿æŠ¤æ•æ„Ÿæ–‡ä»¶` |
| ğŸ” **é«˜çº§** | `æ— ç½‘ç»œé™åˆ¶` | `ç½‘ç»œè®¿é—®æ§åˆ¶` | `é˜²æ­¢ç½‘ç»œæ”»å‡»` |
| ğŸ›¡ï¸ **ä¸“ä¸š** | `æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨` | `ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤` | `é˜²æ­¢æ¶æ„æ“ä½œ` |

### 1.3 systemdå®‰å…¨é…ç½®çš„å·¥ä½œåŸç†


**âš™ï¸ åº•å±‚æœºåˆ¶**
```
systemdå®‰å…¨æœºåˆ¶åŸºäºLinuxå†…æ ¸çš„å®‰å…¨ç‰¹æ€§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨æœåŠ¡      â”‚ â† ä½ çš„WebæœåŠ¡ã€æ•°æ®åº“ç­‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   systemd       â”‚ â† å®‰å…¨ç­–ç•¥æ‰§è¡Œå±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Linuxå†…æ ¸     â”‚ â† namespaceã€cgroupã€seccompç­‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç¡¬ä»¶å±‚        â”‚ â† CPUã€å†…å­˜ã€ç£ç›˜ç­‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å·¥ä½œæµç¨‹ï¼š
æœåŠ¡å¯åŠ¨ â†’ systemdè¯»å–å®‰å…¨é…ç½® â†’ è°ƒç”¨å†…æ ¸å®‰å…¨æœºåˆ¶ â†’ åˆ›å»ºéš”ç¦»ç¯å¢ƒ
```

---

## 2. ğŸ‘¤ ç”¨æˆ·æƒé™éš”ç¦»é…ç½®


### 2.1 Userå’ŒGroupåŸºç¡€é…ç½®


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
Userï¼šæŒ‡å®šæœåŠ¡è¿è¡Œçš„ç”¨æˆ·èº«ä»½
Groupï¼šæŒ‡å®šæœåŠ¡è¿è¡Œçš„ç”¨æˆ·ç»„
ä½œç”¨ï¼šé¿å…ä½¿ç”¨rootæƒé™ï¼Œéµå¾ªæœ€å°æƒé™åŸåˆ™
```

**ğŸ› ï¸ åŸºæœ¬é…ç½®ç¤ºä¾‹**
```ini
[Service]
# æŒ‡å®šè¿è¡Œç”¨æˆ·ï¼ˆæ¨èåˆ›å»ºä¸“ç”¨ç”¨æˆ·ï¼‰
User=webapp
# æŒ‡å®šç”¨æˆ·ç»„
Group=webapp
# æœåŠ¡ç±»å‹
Type=simple
# å¯åŠ¨å‘½ä»¤
ExecStart=/usr/local/bin/webapp
```

**ğŸ’» åˆ›å»ºä¸“ç”¨ç”¨æˆ·çš„å®Œæ•´æµç¨‹**
```bash
# 1. åˆ›å»ºç³»ç»Ÿç”¨æˆ·ï¼ˆæ— ç™»å½•shellï¼Œæ— å®¶ç›®å½•ï¼‰
sudo useradd --system --no-create-home --shell /bin/false webapp

# 2. åˆ›å»ºåº”ç”¨ç›®å½•å¹¶è®¾ç½®æƒé™
sudo mkdir -p /opt/webapp
sudo chown webapp:webapp /opt/webapp

# 3. éªŒè¯ç”¨æˆ·åˆ›å»ºæˆåŠŸ
id webapp
# è¾“å‡ºï¼šuid=999(webapp) gid=999(webapp) groups=999(webapp)
```

### 2.2 DynamicUseråŠ¨æ€ç”¨æˆ·


**ğŸ”¸ ä»€ä¹ˆæ˜¯DynamicUser**
```
DynamicUser=yesï¼šè®©systemdè‡ªåŠ¨åˆ›å»ºä¸´æ—¶ç”¨æˆ·
å¥½å¤„ï¼š
â€¢ æ— éœ€æ‰‹åŠ¨åˆ›å»ºç”¨æˆ·
â€¢ æœåŠ¡åœæ­¢åç”¨æˆ·è‡ªåŠ¨æ¶ˆå¤±
â€¢ æ¯æ¬¡å¯åŠ¨å¯èƒ½ä½¿ç”¨ä¸åŒçš„UID
â€¢ æ›´å¥½çš„å®‰å…¨éš”ç¦»
```

**ğŸ“ DynamicUseré…ç½®ç¤ºä¾‹**
```ini
[Service]
# å¯ç”¨åŠ¨æ€ç”¨æˆ·ï¼ˆsystemdè‡ªåŠ¨åˆ†é…UID/GIDï¼‰
DynamicUser=yes
# æœåŠ¡ç±»å‹
Type=simple
# å¯åŠ¨å‘½ä»¤
ExecStart=/usr/local/bin/myapp

# åŠ¨æ€ç”¨æˆ·ç‰¹æ€§ï¼š
# - UIDèŒƒå›´ï¼š61184-65519
# - æœåŠ¡åœæ­¢åç”¨æˆ·æ¶ˆå¤±
# - è‡ªåŠ¨è·å¾—åŸºæœ¬çš„å®‰å…¨éš”ç¦»
```

**âš–ï¸ é™æ€ç”¨æˆ· vs åŠ¨æ€ç”¨æˆ·å¯¹æ¯”**
```
é™æ€ç”¨æˆ·ï¼ˆUser=webappï¼‰ï¼š
âœ… UIDå›ºå®šï¼Œæ–‡ä»¶æƒé™ç¨³å®š
âœ… å¯ä»¥è·¨æœåŠ¡é‡å¯ä¿æŒæ•°æ®
âŒ éœ€è¦æ‰‹åŠ¨ç®¡ç†ç”¨æˆ·

åŠ¨æ€ç”¨æˆ·ï¼ˆDynamicUser=yesï¼‰ï¼š
âœ… æ— éœ€æ‰‹åŠ¨åˆ›å»ºç”¨æˆ·
âœ… è‡ªåŠ¨å®‰å…¨éš”ç¦»
âœ… ç”¨åå³ç„šï¼Œæ›´å®‰å…¨
âŒ UIDå˜åŒ–ï¼Œä¸é€‚åˆæŒä¹…åŒ–æ•°æ®
```

### 2.3 ç”¨æˆ·æƒé™é…ç½®å®è·µ


**ğŸ¯ Webåº”ç”¨æƒé™éš”ç¦»ç¤ºä¾‹**
```ini
# /etc/systemd/system/webapp.service
[Unit]
Description=Web Application Service
After=network.target

[Service]
# === ç”¨æˆ·éš”ç¦»é…ç½® ===
User=webapp
Group=webapp
# ç¦æ­¢è·å¾—æ–°æƒé™
NoNewPrivileges=true

# === åŸºæœ¬æœåŠ¡é…ç½® ===
Type=simple
ExecStart=/opt/webapp/bin/app --config /opt/webapp/config.yml
WorkingDirectory=/opt/webapp
Restart=always

# === ç¯å¢ƒéš”ç¦» ===
Environment="APP_ENV=production"
EnvironmentFile=-/opt/webapp/.env

[Install]
WantedBy=multi-user.target
```

---

## 3. ğŸ“ æ–‡ä»¶ç³»ç»Ÿéš”ç¦»æœºåˆ¶


### 3.1 PrivateTmpä¸´æ—¶ç›®å½•éš”ç¦»


**ğŸ”¸ PrivateTmpçš„ä½œç”¨**
```
PrivateTmp=yesï¼šä¸ºæœåŠ¡åˆ›å»ºç§æœ‰çš„/tmpç›®å½•
åŸç†ï¼šä½¿ç”¨mount namespaceæŠ€æœ¯
æ•ˆæœï¼šæœåŠ¡çœ‹åˆ°çš„/tmpä¸ç³»ç»Ÿ/tmpå®Œå…¨éš”ç¦»

æ²¡æœ‰PrivateTmpï¼š
æœåŠ¡Aå†™å…¥ â†’ /tmp/data â†’ æœåŠ¡Bå¯ä»¥è¯»å–ï¼ˆå®‰å…¨é£é™©ï¼‰

æœ‰PrivateTmpï¼š
æœåŠ¡Aå†™å…¥ â†’ /tmp/dataï¼ˆç§æœ‰ï¼‰ â†’ æœåŠ¡Bçœ‹ä¸åˆ°
æœåŠ¡Bå†™å…¥ â†’ /tmp/dataï¼ˆç§æœ‰ï¼‰ â†’ æœåŠ¡Açœ‹ä¸åˆ°
```

**ğŸ“ ä¸´æ—¶ç›®å½•éš”ç¦»é…ç½®**
```ini
[Service]
# å¯ç”¨ç§æœ‰ä¸´æ—¶ç›®å½•
PrivateTmp=yes
# æœåŠ¡è¿è¡Œç”¨æˆ·
User=webapp
Group=webapp
ExecStart=/opt/webapp/bin/app

# å®é™…æ•ˆæœéªŒè¯ï¼š
# 1. æœåŠ¡å†…æŸ¥çœ‹ï¼šls /tmpï¼ˆæ˜¾ç¤ºç§æœ‰ä¸´æ—¶ç›®å½•å†…å®¹ï¼‰
# 2. ç³»ç»Ÿä¸­æŸ¥çœ‹ï¼šls /tmpï¼ˆæ˜¾ç¤ºç³»ç»Ÿä¸´æ—¶ç›®å½•å†…å®¹ï¼‰
# 3. ä¸¤è€…å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°
```

### 3.2 ProtectHomeå®¶ç›®å½•ä¿æŠ¤


**ğŸ”¸ å®¶ç›®å½•ä¿æŠ¤çº§åˆ«**
```
ProtectHomeçš„ä¸‰ç§æ¨¡å¼ï¼š

noï¼šä¸ä¿æŠ¤ï¼ˆé»˜è®¤ï¼‰
â”œâ”€ æœåŠ¡å¯ä»¥è®¿é—®/homeã€/rootã€/run/user
â””â”€ å®‰å…¨é£é™©ï¼šå¯èƒ½è®¿é—®ç”¨æˆ·ç§äººæ–‡ä»¶

yesï¼šå®Œå…¨éšè—
â”œâ”€ /homeã€/rootã€/run/userå¯¹æœåŠ¡ä¸å¯è§
â””â”€ é€‚åˆï¼šä¸éœ€è¦è®¿é—®ç”¨æˆ·æ–‡ä»¶çš„æœåŠ¡

read-onlyï¼šåªè¯»è®¿é—®
â”œâ”€ å¯ä»¥è¯»å–ä½†ä¸èƒ½ä¿®æ”¹ç”¨æˆ·ç›®å½•
â””â”€ é€‚åˆï¼šéœ€è¦è¯»å–é…ç½®ä½†ä¸ä¿®æ”¹çš„æœåŠ¡
```

**ğŸ›¡ï¸ å®¶ç›®å½•ä¿æŠ¤é…ç½®ç¤ºä¾‹**
```ini
[Service]
# === å®¶ç›®å½•ä¿æŠ¤é…ç½® ===
# å®Œå…¨éšè—ç”¨æˆ·å®¶ç›®å½•
ProtectHome=yes

# === å…¶ä»–éš”ç¦»é…ç½® ===
User=webapp
PrivateTmp=yes
ExecStart=/opt/webapp/bin/app

# æµ‹è¯•éªŒè¯ï¼š
# æœåŠ¡å†…æ‰§è¡Œï¼šls /home
# ç»“æœï¼šPermission denied æˆ–ç›®å½•ä¸å­˜åœ¨
# è¯´æ˜ï¼šå®¶ç›®å½•ä¿æŠ¤ç”Ÿæ•ˆ
```

### 3.3 ReadOnlyPathsåªè¯»è·¯å¾„è®¾ç½®


**ğŸ”¸ åªè¯»è·¯å¾„çš„ä½œç”¨**
```
ReadOnlyPathsï¼šå°†æŒ‡å®šè·¯å¾„è®¾ç½®ä¸ºåªè¯»
åº”ç”¨åœºæ™¯ï¼š
â€¢ ä¿æŠ¤é‡è¦é…ç½®æ–‡ä»¶ä¸è¢«æ„å¤–ä¿®æ”¹
â€¢ å…è®¸è¯»å–ç³»ç»Ÿä¿¡æ¯ä½†ç¦æ­¢ä¿®æ”¹
â€¢ é˜²æ­¢æœåŠ¡ç ´åå…³é”®ç³»ç»Ÿæ–‡ä»¶
```

**ğŸ“‹ åªè¯»è·¯å¾„é…ç½®ç¤ºä¾‹**
```ini
[Service]
# === æ–‡ä»¶ç³»ç»Ÿä¿æŠ¤ ===
# è®¾ç½®é…ç½®ç›®å½•ä¸ºåªè¯»
ReadOnlyPaths=/etc/myapp
# è®¾ç½®ç³»ç»Ÿç›®å½•ä¸ºåªè¯»
ReadOnlyPaths=/usr/share/myapp
# å¯ä»¥è®¾ç½®å¤šä¸ªåªè¯»è·¯å¾„
ReadOnlyPaths=/var/lib/myapp/config

# === åŸºæœ¬é…ç½® ===
User=webapp
ExecStart=/opt/webapp/bin/app
PrivateTmp=yes

# æ•ˆæœéªŒè¯ï¼š
# æœåŠ¡å†…å°è¯•ï¼šecho "test" > /etc/myapp/config.ini
# ç»“æœï¼šPermission deniedï¼ˆå†™å…¥è¢«é˜»æ­¢ï¼‰
# ä½†è¯»å–æ­£å¸¸ï¼šcat /etc/myapp/config.ini
```

### 3.4 InaccessiblePathsè·¯å¾„éšè—


**ğŸ”¸ è·¯å¾„éšè—æœºåˆ¶**
```
InaccessiblePathsï¼šå®Œå…¨éšè—æŒ‡å®šè·¯å¾„
ä¸ReadOnlyPathsåŒºåˆ«ï¼š
â€¢ ReadOnlyPathsï¼šå¯ä»¥çœ‹åˆ°ä½†ä¸èƒ½ä¿®æ”¹
â€¢ InaccessiblePathsï¼šå®Œå…¨çœ‹ä¸åˆ°

å…¸å‹åº”ç”¨ï¼š
â€¢ éšè—æ•æ„Ÿç³»ç»Ÿç›®å½•
â€¢ é˜²æ­¢æœåŠ¡æ¢æµ‹ç³»ç»Ÿç»“æ„
â€¢ å¢å¼ºå®‰å…¨æ€§
```

**ğŸ”’ è·¯å¾„éšè—é…ç½®ç¤ºä¾‹**
```ini
[Service]
# === è·¯å¾„éšè—é…ç½® ===
# éšè—ç³»ç»Ÿå…³é”®ç›®å½•
InaccessiblePaths=/boot
InaccessiblePaths=/root
InaccessiblePaths=/etc/shadow
# éšè—å…¶ä»–æ•æ„Ÿè·¯å¾„
InaccessiblePaths=/proc/sys
InaccessiblePaths=/sys/kernel

# === åŸºæœ¬é…ç½® ===
User=webapp
PrivateTmp=yes
ExecStart=/opt/webapp/bin/app

# éªŒè¯æ•ˆæœï¼š
# æœåŠ¡å†…æ‰§è¡Œï¼šls /boot
# ç»“æœï¼šNo such file or directory
```

### 3.5 æ–‡ä»¶ç³»ç»Ÿéš”ç¦»æœ€ä½³é…ç½®


**ğŸ¯ WebæœåŠ¡æ–‡ä»¶ç³»ç»Ÿå®‰å…¨é…ç½®**
```ini
# /etc/systemd/system/secure-webapp.service
[Unit]
Description=Secure Web Application
After=network.target

[Service]
# === ç”¨æˆ·é…ç½® ===
User=webapp
Group=webapp
DynamicUser=no

# === æ–‡ä»¶ç³»ç»Ÿéš”ç¦» ===
# ç§æœ‰ä¸´æ—¶ç›®å½•
PrivateTmp=yes
# ä¿æŠ¤ç”¨æˆ·å®¶ç›®å½•
ProtectHome=yes
# åº”ç”¨é…ç½®åªè¯»
ReadOnlyPaths=/opt/webapp/config
ReadOnlyPaths=/etc/webapp
# éšè—æ•æ„Ÿç³»ç»Ÿç›®å½•
InaccessiblePaths=/boot
InaccessiblePaths=/root
InaccessiblePaths=/etc/shadow

# === åº”ç”¨é…ç½® ===
Type=simple
ExecStart=/opt/webapp/bin/app
WorkingDirectory=/opt/webapp
Restart=always

[Install]
WantedBy=multi-user.target
```

---

## 4. ğŸŒ ç½‘ç»œéš”ç¦»ä¸è®¿é—®æ§åˆ¶


### 4.1 PrivateNetworkç½‘ç»œéš”ç¦»


**ğŸ”¸ ç§æœ‰ç½‘ç»œçš„æ¦‚å¿µ**
```
PrivateNetwork=yesï¼šä¸ºæœåŠ¡åˆ›å»ºç‹¬ç«‹çš„ç½‘ç»œå‘½åç©ºé—´
æ•ˆæœï¼š
â€¢ æœåŠ¡åªèƒ½çœ‹åˆ°å›ç¯æ¥å£ï¼ˆloï¼‰
â€¢ æ— æ³•è®¿é—®å¤–éƒ¨ç½‘ç»œ
â€¢ æ— æ³•è¢«å¤–éƒ¨ç½‘ç»œè®¿é—®
â€¢ å®Œå…¨çš„ç½‘ç»œéš”ç¦»

é€‚ç”¨åœºæ™¯ï¼š
â€¢ æœ¬åœ°è®¡ç®—æœåŠ¡ï¼ˆä¸éœ€è¦ç½‘ç»œï¼‰
â€¢ æ–‡ä»¶å¤„ç†ç¨‹åº
â€¢ çº¯è®¡ç®—ä»»åŠ¡
```

**ğŸ“ ç½‘ç»œéš”ç¦»é…ç½®ç¤ºä¾‹**
```ini
[Service]
# === ç½‘ç»œéš”ç¦»é…ç½® ===
# å¯ç”¨ç§æœ‰ç½‘ç»œï¼ˆå®Œå…¨éš”ç¦»ï¼‰
PrivateNetwork=yes

# === åŸºæœ¬é…ç½® ===
User=fileprocessor
ExecStart=/opt/myapp/bin/processor
Type=simple

# ç½‘ç»œéš”ç¦»éªŒè¯ï¼š
# æœåŠ¡å†…æ‰§è¡Œï¼šip addr show
# ç»“æœï¼šåªæ˜¾ç¤ºloå›ç¯æ¥å£
# å°è¯•ç½‘ç»œè¿æ¥ï¼šcurl google.com
# ç»“æœï¼šNetwork unreachable
```

### 4.2 IPAddressDenyç½‘ç»œè®¿é—®æ§åˆ¶


**ğŸ”¸ IPåœ°å€è®¿é—®æ§åˆ¶**
```
IPAddressDenyï¼šç¦æ­¢è®¿é—®æŒ‡å®šIPåœ°å€æˆ–ç½‘æ®µ
IPAddressAllowï¼šå…è®¸è®¿é—®æŒ‡å®šIPåœ°å€æˆ–ç½‘æ®µ
è§„åˆ™ï¼š
â€¢ é»˜è®¤å…è®¸æ‰€æœ‰ï¼ˆå¦‚æœæ²¡æœ‰é…ç½®ï¼‰
â€¢ å…ˆåŒ¹é…Allowè§„åˆ™ï¼Œå†åŒ¹é…Denyè§„åˆ™
â€¢ Denyä¼˜å…ˆçº§é«˜äºAllow
```

**ğŸ›¡ï¸ ç½‘ç»œè®¿é—®æ§åˆ¶é…ç½®**
```ini
[Service]
# === ç½‘ç»œè®¿é—®æ§åˆ¶ ===
# ç¦æ­¢è®¿é—®å†…ç½‘åœ°å€ï¼ˆé˜²æ­¢å†…ç½‘æ¸—é€ï¼‰
IPAddressDeny=192.168.0.0/16
IPAddressDeny=10.0.0.0/8
IPAddressDeny=172.16.0.0/12
# ç¦æ­¢è®¿é—®æœ¬åœ°åœ°å€
IPAddressDeny=127.0.0.0/8
# åªå…è®¸è®¿é—®ç‰¹å®šæœåŠ¡å™¨
IPAddressAllow=203.0.113.10
IPAddressAllow=203.0.113.20

# === åŸºæœ¬é…ç½® ===
User=webclient
ExecStart=/opt/myapp/bin/client
Type=simple

# æµ‹è¯•éªŒè¯ï¼š
# è®¿é—®å…è®¸çš„IPï¼šcurl 203.0.113.10 âœ… æˆåŠŸ
# è®¿é—®ç¦æ­¢çš„IPï¼šcurl 192.168.1.1 âŒ è¢«é˜»æ­¢
```

### 4.3 ç½‘ç»œéš”ç¦»é…ç½®æ¡ˆä¾‹


**ğŸ¯ æ•°æ®åº“æœåŠ¡ç½‘ç»œå®‰å…¨é…ç½®**
```ini
# /etc/systemd/system/secure-database.service
[Unit]
Description=Secure Database Service
After=network.target

[Service]
# === ç”¨æˆ·é…ç½® ===
User=database
Group=database

# === ç½‘ç»œå®‰å…¨é…ç½® ===
# ä¸ä½¿ç”¨å®Œå…¨ç½‘ç»œéš”ç¦»ï¼ˆæ•°æ®åº“éœ€è¦ç›‘å¬ç«¯å£ï¼‰
PrivateNetwork=no
# é™åˆ¶ç½‘ç»œè®¿é—®èŒƒå›´
IPAddressAllow=127.0.0.1
IPAddressAllow=192.168.1.0/24
# ç¦æ­¢è®¿é—®å¤–ç½‘
IPAddressDeny=0.0.0.0/0

# === æ–‡ä»¶ç³»ç»Ÿä¿æŠ¤ ===
PrivateTmp=yes
ProtectHome=yes
ReadOnlyPaths=/etc/database

# === åŸºæœ¬é…ç½® ===
Type=notify
ExecStart=/usr/local/bin/database --config /etc/database/db.conf
PIDFile=/var/run/database/database.pid

[Install]
WantedBy=multi-user.target
```

---

## 5. ğŸ”§ ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤æœºåˆ¶


### 5.1 SystemCallFilterç³»ç»Ÿè°ƒç”¨è¿‡æ»¤


**ğŸ”¸ ä»€ä¹ˆæ˜¯ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤**
```
ç³»ç»Ÿè°ƒç”¨ï¼šç¨‹åºè¯·æ±‚å†…æ ¸æœåŠ¡çš„æ–¹å¼
å¸¸è§ç³»ç»Ÿè°ƒç”¨ï¼š
â€¢ read/writeï¼šæ–‡ä»¶è¯»å†™
â€¢ open/closeï¼šæ–‡ä»¶æ‰“å¼€å…³é—­
â€¢ socket/bindï¼šç½‘ç»œæ“ä½œ
â€¢ fork/execï¼šè¿›ç¨‹åˆ›å»º

SystemCallFilterä½œç”¨ï¼š
é™åˆ¶æœåŠ¡åªèƒ½ä½¿ç”¨ç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨
é˜²æ­¢æ¶æ„ç¨‹åºè°ƒç”¨å±é™©çš„ç³»ç»ŸåŠŸèƒ½
```

**ğŸ“ ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤åŸºç¡€é…ç½®**
```ini
[Service]
# === ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤ ===
# ä½¿ç”¨é¢„å®šä¹‰çš„å®‰å…¨ç»„åˆ
SystemCallFilter=@system-service
# æˆ–è€…æ˜ç¡®æŒ‡å®šå…è®¸çš„ç³»ç»Ÿè°ƒç”¨
SystemCallFilter=read write open close socket bind listen accept

# ç³»ç»Ÿè°ƒç”¨ç»„è¯´æ˜ï¼š
# @system-serviceï¼šé€‚åˆç³»ç»ŸæœåŠ¡çš„è°ƒç”¨é›†åˆ
# @network-ioï¼šç½‘ç»œç›¸å…³çš„è°ƒç”¨
# @file-systemï¼šæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„è°ƒç”¨
# @basic-ioï¼šåŸºæœ¬è¾“å…¥è¾“å‡ºè°ƒç”¨

User=webapp
ExecStart=/opt/webapp/bin/app
```

### 5.2 SystemCallArchitecturesæ¶æ„é™åˆ¶


**ğŸ”¸ ç³»ç»Ÿè°ƒç”¨æ¶æ„æ§åˆ¶**
```
SystemCallArchitecturesï¼šé™åˆ¶ç³»ç»Ÿè°ƒç”¨çš„æ¶æ„
ä½œç”¨ï¼šé˜²æ­¢32ä½ä»£ç åœ¨64ä½ç³»ç»Ÿä¸Šè¿è¡Œæ¶æ„è°ƒç”¨
å¸¸è§æ¶æ„ï¼š
â€¢ nativeï¼šç³»ç»ŸåŸç”Ÿæ¶æ„
â€¢ x86-64ï¼š64ä½x86æ¶æ„
â€¢ x32ï¼šx32 ABIï¼ˆ64ä½å†…æ ¸ä¸Šçš„32ä½æ¥å£ï¼‰
```

**ğŸ”’ æ¶æ„é™åˆ¶é…ç½®ç¤ºä¾‹**
```ini
[Service]
# === æ¶æ„å®‰å…¨é™åˆ¶ ===
# åªå…è®¸åŸç”Ÿæ¶æ„çš„ç³»ç»Ÿè°ƒç”¨
SystemCallArchitectures=native
# æˆ–è€…æ˜ç¡®æŒ‡å®šæ¶æ„
SystemCallArchitectures=x86-64

# === ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤ ===
SystemCallFilter=@system-service
SystemCallFilter=~@privileged @resources

# === åŸºæœ¬é…ç½® ===
User=webapp
ExecStart=/opt/webapp/bin/app

# å®‰å…¨æ•ˆæœï¼š
# é˜»æ­¢32ä½shellcodeåœ¨64ä½ç³»ç»Ÿä¸Šæ‰§è¡Œ
# é˜²æ­¢æ¶æ„æ··æ·†æ”»å‡»
```

### 5.3 ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤å®è·µé…ç½®


**ğŸ¯ WebæœåŠ¡ç³»ç»Ÿè°ƒç”¨å®‰å…¨é…ç½®**
```ini
[Service]
# === ç³»ç»Ÿè°ƒç”¨å®‰å…¨é…ç½® ===
# å…è®¸ç³»ç»ŸæœåŠ¡ç›¸å…³è°ƒç”¨
SystemCallFilter=@system-service
# å…è®¸ç½‘ç»œIOè°ƒç”¨
SystemCallFilter=@network-io
# å…è®¸æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨
SystemCallFilter=@file-system
# ç¦æ­¢ç‰¹æƒè°ƒç”¨ï¼ˆ~è¡¨ç¤ºç¦æ­¢ï¼‰
SystemCallFilter=~@privileged
# ç¦æ­¢è°ƒè¯•ç›¸å…³è°ƒç”¨
SystemCallFilter=~@debug
# ç¦æ­¢åŸå§‹IOè°ƒç”¨
SystemCallFilter=~@raw-io
# é™åˆ¶æ¶æ„
SystemCallArchitectures=native

# === å…¶ä»–å®‰å…¨é…ç½® ===
User=webapp
NoNewPrivileges=true
PrivateTmp=yes

# === åŸºæœ¬é…ç½® ===
ExecStart=/opt/webapp/bin/app
Type=simple
```

**ğŸ“Š å¸¸ç”¨ç³»ç»Ÿè°ƒç”¨ç»„å¯¹æ¯”**
| è°ƒç”¨ç»„ | **åŒ…å«çš„è°ƒç”¨** | **é€‚ç”¨åœºæ™¯** | **å®‰å…¨çº§åˆ«** |
|--------|---------------|-------------|-------------|
| `@system-service` | `åŸºç¡€æœåŠ¡è°ƒç”¨` | `WebæœåŠ¡ã€APIæœåŠ¡` | `ğŸŸ¢ å®‰å…¨` |
| `@network-io` | `ç½‘ç»œç›¸å…³è°ƒç”¨` | `ç½‘ç»œæœåŠ¡` | `ğŸŸ¡ ä¸­ç­‰` |
| `@privileged` | `ç‰¹æƒè°ƒç”¨` | `ç³»ç»Ÿç®¡ç†` | `ğŸ”´ å±é™©` |
| `@debug` | `è°ƒè¯•ç›¸å…³è°ƒç”¨` | `å¼€å‘è°ƒè¯•` | `ğŸ”´ å±é™©` |
| `@raw-io` | `åŸå§‹IOè°ƒç”¨` | `åº•å±‚æ“ä½œ` | `ğŸ”´ å±é™©` |

---

## 6. ğŸ›¡ï¸ èƒ½åŠ›é™åˆ¶ä¸æƒé™æ§åˆ¶


### 6.1 CapabilityBoundingSetèƒ½åŠ›è¾¹ç•Œ


**ğŸ”¸ Linux Capabilitiesæ¦‚å¿µ**
```
Linux Capabilitiesï¼šå°†rootæƒé™ç»†åˆ†çš„æœºåˆ¶
ä¼ ç»Ÿæ–¹å¼ï¼šè¦ä¹ˆæ˜¯rootï¼ˆå…¨æƒé™ï¼‰ï¼Œè¦ä¹ˆæ˜¯æ™®é€šç”¨æˆ·ï¼ˆå—é™ï¼‰
Capabilitiesï¼šå¯ä»¥ç»™æ™®é€šç”¨æˆ·ç‰¹å®šçš„æƒé™

å¸¸è§Capabilitiesï¼š
â€¢ CAP_NET_BIND_SERVICEï¼šç»‘å®š1024ä»¥ä¸‹ç«¯å£
â€¢ CAP_NET_ADMINï¼šç½‘ç»œç®¡ç†æƒé™
â€¢ CAP_SYS_ADMINï¼šç³»ç»Ÿç®¡ç†æƒé™
â€¢ CAP_DAC_OVERRIDEï¼šå¿½ç•¥æ–‡ä»¶æƒé™æ£€æŸ¥
```

**ğŸ“ èƒ½åŠ›è¾¹ç•Œè®¾ç½®**
```ini
[Service]
# === èƒ½åŠ›é™åˆ¶é…ç½® ===
# åªä¿ç•™ç»‘å®šä½ç«¯å£çš„èƒ½åŠ›
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
# ç§»é™¤æ‰€æœ‰å…¶ä»–å±é™©èƒ½åŠ›
CapabilityBoundingSet=~CAP_SYS_ADMIN CAP_DAC_OVERRIDE

# === åŸºæœ¬é…ç½® ===
User=webapp
# WebæœåŠ¡éœ€è¦ç»‘å®š80ç«¯å£ï¼Œæ‰€ä»¥éœ€è¦CAP_NET_BIND_SERVICE
ExecStart=/opt/webapp/bin/app --port 80
Type=simple

# æ•ˆæœï¼š
# æ™®é€šç”¨æˆ·webappå¯ä»¥ç»‘å®š80ç«¯å£
# ä½†ä¸èƒ½æ‰§è¡Œå…¶ä»–ç‰¹æƒæ“ä½œ
```

### 6.2 AmbientCapabilitiesç¯å¢ƒèƒ½åŠ›


**ğŸ”¸ ç¯å¢ƒèƒ½åŠ›ä¸ç»§æ‰¿èƒ½åŠ›**
```
AmbientCapabilitiesï¼šç¯å¢ƒèƒ½åŠ›é›†
ä½œç”¨ï¼šå­è¿›ç¨‹å¯ä»¥ç»§æ‰¿è¿™äº›èƒ½åŠ›
åŒºåˆ«ï¼š
â€¢ CapabilityBoundingSetï¼šé™åˆ¶èƒ½åŠ›ä¸Šé™
â€¢ AmbientCapabilitiesï¼šå®é™…æ‹¥æœ‰çš„èƒ½åŠ›

ä½¿ç”¨åœºæ™¯ï¼š
æœåŠ¡éœ€è¦å¯åŠ¨å­è¿›ç¨‹ï¼Œä¸”å­è¿›ç¨‹ä¹Ÿéœ€è¦ç‰¹å®šèƒ½åŠ›
```

**ğŸ› ï¸ ç¯å¢ƒèƒ½åŠ›é…ç½®ç¤ºä¾‹**
```ini
[Service]
# === èƒ½åŠ›é…ç½® ===
# é™åˆ¶èƒ½åŠ›è¾¹ç•Œ
CapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_SETUID CAP_SETGID
# è®¾ç½®ç¯å¢ƒèƒ½åŠ›ï¼ˆå­è¿›ç¨‹å¯ç»§æ‰¿ï¼‰
AmbientCapabilities=CAP_NET_BIND_SERVICE

# === ç”¨æˆ·é…ç½® ===
User=reverseproxy
Group=reverseproxy

# === åŸºæœ¬é…ç½® ===
ExecStart=/opt/nginx/sbin/nginx -g "daemon off;"
Type=forking

# åº”ç”¨åœºæ™¯ï¼š
# Nginxä¸»è¿›ç¨‹ç»‘å®š80/443ç«¯å£
# Workerè¿›ç¨‹ç»§æ‰¿ç»‘å®šç«¯å£çš„èƒ½åŠ›
```

### 6.3 NoNewPrivilegesæƒé™é™åˆ¶


**ğŸ”¸ æ–°æƒé™è·å–é™åˆ¶**
```
NoNewPrivileges=yesï¼šç¦æ­¢è·å¾—æ–°æƒé™
ä½œç”¨ï¼š
â€¢ é˜²æ­¢é€šè¿‡setuidç¨‹åºææƒ
â€¢ é˜»æ­¢capabilityæå‡
â€¢ å¢å¼ºå®‰å…¨è¾¹ç•Œ

å®‰å…¨ä»·å€¼ï¼š
å³ä½¿æœåŠ¡è¢«æ”»å‡»ï¼Œä¹Ÿæ— æ³•é€šè¿‡ç³»ç»Ÿç¨‹åºææƒ
```

**ğŸ”’ æƒé™é™åˆ¶å®Œæ•´é…ç½®**
```ini
[Service]
# === ä¸¥æ ¼æƒé™æ§åˆ¶ ===
# ç¦æ­¢è·å¾—æ–°æƒé™
NoNewPrivileges=yes
# é™åˆ¶èƒ½åŠ›è¾¹ç•Œ
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
# è®¾ç½®ç¯å¢ƒèƒ½åŠ›
AmbientCapabilities=CAP_NET_BIND_SERVICE

# === ç”¨æˆ·éš”ç¦» ===
User=webapp
Group=webapp

# === æ–‡ä»¶ç³»ç»Ÿä¿æŠ¤ ===
PrivateTmp=yes
ProtectHome=yes
ReadOnlyPaths=/etc/webapp

# === åŸºæœ¬é…ç½® ===
Type=simple
ExecStart=/opt/webapp/bin/app
Restart=always

# å®‰å…¨æ•ˆæœï¼š
# æœåŠ¡æ— æ³•é€šè¿‡sudoã€suç­‰ç¨‹åºææƒ
# æ— æ³•è·å¾—è¶…å‡ºé…ç½®çš„èƒ½åŠ›
```

---

## 7. ğŸ” è¿›ç¨‹éš”ç¦»ä¸ç³»ç»Ÿä¿æŠ¤


### 7.1 PrivateDevicesè®¾å¤‡éš”ç¦»


**ğŸ”¸ è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿéš”ç¦»**
```
PrivateDevices=yesï¼šéš”ç¦»/devç›®å½•
æ•ˆæœï¼š
â€¢ æœåŠ¡çœ‹ä¸åˆ°ç‰©ç†è®¾å¤‡ï¼ˆç¡¬ç›˜ã€USBç­‰ï¼‰
â€¢ åªä¿ç•™åŸºæœ¬è®¾å¤‡ï¼ˆ/dev/nullã€/dev/zeroç­‰ï¼‰
â€¢ é˜²æ­¢ç›´æ¥è®¿é—®ç¡¬ä»¶è®¾å¤‡

å®‰å…¨ä»·å€¼ï¼š
é˜²æ­¢æ¶æ„ç¨‹åºè®¿é—®æ•æ„Ÿç¡¬ä»¶
é˜»æ­¢ç»•è¿‡æ–‡ä»¶ç³»ç»Ÿæƒé™çš„æ”»å‡»
```

**ğŸ“ è®¾å¤‡éš”ç¦»é…ç½®**
```ini
[Service]
# === è®¾å¤‡éš”ç¦» ===
# éš”ç¦»è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿ
PrivateDevices=yes

# === åŸºæœ¬é…ç½® ===
User=processor
ExecStart=/opt/myapp/bin/processor
Type=simple

# éš”ç¦»éªŒè¯ï¼š
# æœåŠ¡å†…æ‰§è¡Œï¼šls /dev/
# ç»“æœï¼šåªæ˜¾ç¤ºnullã€zeroã€stdinç­‰åŸºæœ¬è®¾å¤‡
# çœ‹ä¸åˆ°ï¼šsdaã€sdbç­‰ç‰©ç†è®¾å¤‡
```

### 7.2 ProtectKernelTunableså†…æ ¸å‚æ•°ä¿æŠ¤


**ğŸ”¸ å†…æ ¸å‚æ•°ä¿æŠ¤æœºåˆ¶**
```
ProtectKernelTunables=yesï¼šä¿æŠ¤å†…æ ¸å¯è°ƒå‚æ•°
ä¿æŠ¤å¯¹è±¡ï¼š
â€¢ /proc/sys/*ï¼šç³»ç»Ÿå‚æ•°
â€¢ /sys/*ï¼šç³»ç»Ÿä¿¡æ¯
â€¢ å…¶ä»–å†…æ ¸æ¥å£

ä½œç”¨ï¼šé˜²æ­¢æœåŠ¡ä¿®æ”¹ç³»ç»Ÿçº§å‚æ•°
```

**ğŸ›¡ï¸ å†…æ ¸ä¿æŠ¤é…ç½®**
```ini
[Service]
# === å†…æ ¸ä¿æŠ¤ ===
# ä¿æŠ¤å†…æ ¸å¯è°ƒå‚æ•°
ProtectKernelTunables=yes
# ä¿æŠ¤å†…æ ¸æ¨¡å—
ProtectKernelModules=yes

# === è®¾å¤‡å’Œæ–‡ä»¶ç³»ç»Ÿä¿æŠ¤ ===
PrivateDevices=yes
ProtectHome=yes
PrivateTmp=yes

# === åŸºæœ¬é…ç½® ===
User=webapp
ExecStart=/opt/webapp/bin/app

# ä¿æŠ¤æ•ˆæœï¼š
# æ— æ³•ä¿®æ”¹ï¼šecho 1 > /proc/sys/net/ipv4/ip_forward
# ç»“æœï¼šPermission denied
```

### 7.3 ProtectControlGroupsæ§åˆ¶ç»„ä¿æŠ¤


**ğŸ”¸ æ§åˆ¶ç»„ä¿æŠ¤**
```
ProtectControlGroups=yesï¼šä¿æŠ¤cgroupæ–‡ä»¶ç³»ç»Ÿ
ä¿æŠ¤å†…å®¹ï¼š
â€¢ /sys/fs/cgroup/*ï¼šæ§åˆ¶ç»„é…ç½®
â€¢ é˜²æ­¢ä¿®æ”¹èµ„æºé™åˆ¶
â€¢ é˜»æ­¢é€ƒé€¸å®¹å™¨é™åˆ¶

é‡è¦æ€§ï¼š
cgroupæ˜¯å®¹å™¨éš”ç¦»çš„åŸºç¡€
ä¿æŠ¤cgroupé˜²æ­¢å®¹å™¨é€ƒé€¸æ”»å‡»
```

**ğŸ”’ ç»¼åˆè¿›ç¨‹ä¿æŠ¤é…ç½®**
```ini
# /etc/systemd/system/secure-processor.service
[Unit]
Description=Secure Processing Service
After=network.target

[Service]
# === ç”¨æˆ·éš”ç¦» ===
User=processor
Group=processor
DynamicUser=no

# === è¿›ç¨‹å’Œç³»ç»Ÿä¿æŠ¤ ===
# è®¾å¤‡éš”ç¦»
PrivateDevices=yes
# ä¿æŠ¤å†…æ ¸å‚æ•°
ProtectKernelTunables=yes
# ä¿æŠ¤å†…æ ¸æ¨¡å—
ProtectKernelModules=yes
# ä¿æŠ¤æ§åˆ¶ç»„
ProtectControlGroups=yes
# ä¿æŠ¤æ—¶é’Ÿ
ProtectClock=yes

# === æ–‡ä»¶ç³»ç»Ÿéš”ç¦» ===
PrivateTmp=yes
ProtectHome=yes
# ç³»ç»Ÿç›®å½•åªè¯»
ReadOnlyPaths=/usr
ReadOnlyPaths=/boot

# === æƒé™æ§åˆ¶ ===
NoNewPrivileges=yes
CapabilityBoundingSet=

# === åŸºæœ¬é…ç½® ===
Type=simple
ExecStart=/opt/processor/bin/app
WorkingDirectory=/opt/processor
Restart=always

[Install]
WantedBy=multi-user.target
```

---

## 8. ğŸ¯ å®‰å…¨é…ç½®æœ€ä½³å®è·µ


### 8.1 Webåº”ç”¨å®‰å…¨é…ç½®æ¨¡æ¿


**ğŸŒ æ ‡å‡†WebæœåŠ¡å®‰å…¨é…ç½®**
```ini
# /etc/systemd/system/secure-web.service
[Unit]
Description=Secure Web Application
Documentation=https://example.com/docs
After=network.target
Requires=network.target

[Service]
# === ç”¨æˆ·å’Œè¿›ç¨‹é…ç½® ===
Type=simple
User=webapp
Group=webapp
# ç¦ç”¨åŠ¨æ€ç”¨æˆ·ï¼ˆéœ€è¦æŒä¹…åŒ–æ•°æ®ï¼‰
DynamicUser=no
# ç¦æ­¢æƒé™æå‡
NoNewPrivileges=yes

# === æ–‡ä»¶ç³»ç»Ÿå®‰å…¨ ===
# ç§æœ‰ä¸´æ—¶ç›®å½•
PrivateTmp=yes
# ä¿æŠ¤ç”¨æˆ·ç›®å½•
ProtectHome=yes
# è®¾å¤‡éš”ç¦»
PrivateDevices=yes
# åº”ç”¨é…ç½®åªè¯»
ReadOnlyPaths=/etc/webapp /opt/webapp/config
# éšè—æ•æ„Ÿç³»ç»Ÿç›®å½•
InaccessiblePaths=/root /boot /etc/shadow /etc/gshadow

# === ç½‘ç»œå®‰å…¨ ===
# å…è®¸æœ¬åœ°å’Œå†…ç½‘è®¿é—®
IPAddressAllow=127.0.0.1/8 10.0.0.0/8 192.168.0.0/16 172.16.0.0/12
# ç¦æ­¢è®¿é—®å…¶ä»–ç½‘ç»œï¼ˆå¦‚æœä¸éœ€è¦å¤–ç½‘ï¼‰
IPAddressDeny=0.0.0.0/0

# === ç³»ç»Ÿè°ƒç”¨é™åˆ¶ ===
# å…è®¸ç³»ç»ŸæœåŠ¡è°ƒç”¨
SystemCallFilter=@system-service @network-io @file-system
# ç¦æ­¢å±é™©è°ƒç”¨
SystemCallFilter=~@privileged @raw-io @debug @mount @swap
# é™åˆ¶æ¶æ„
SystemCallArchitectures=native

# === æƒé™æ§åˆ¶ ===
# åªä¿ç•™ç»‘å®šä½ç«¯å£æƒé™ï¼ˆå¦‚æœéœ€è¦ï¼‰
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_BIND_SERVICE

# === ç³»ç»Ÿä¿æŠ¤ ===
# ä¿æŠ¤å†…æ ¸å‚æ•°
ProtectKernelTunables=yes
# ä¿æŠ¤å†…æ ¸æ¨¡å—
ProtectKernelModules=yes
# ä¿æŠ¤æ§åˆ¶ç»„
ProtectControlGroups=yes
# ä¿æŠ¤ç³»ç»Ÿæ—¶é’Ÿ
ProtectClock=yes

# === åº”ç”¨é…ç½® ===
ExecStart=/opt/webapp/bin/app --config /etc/webapp/config.yml
WorkingDirectory=/opt/webapp
Environment="APP_ENV=production"
EnvironmentFile=-/opt/webapp/.env

# === è¿è¡Œæ—¶é…ç½® ===
Restart=always
RestartSec=5
TimeoutStartSec=30
TimeoutStopSec=30

# === èµ„æºé™åˆ¶ ===
LimitNOFILE=65536
LimitNPROC=4096

[Install]
WantedBy=multi-user.target
```

### 8.2 æ•°æ®åº“æœåŠ¡å®‰å…¨é…ç½®æ¨¡æ¿


**ğŸ—„ï¸ æ•°æ®åº“æœåŠ¡å®‰å…¨é…ç½®**
```ini
# /etc/systemd/system/secure-database.service
[Unit]
Description=Secure Database Service
After=network.target
Requires=network.target

[Service]
# === ç”¨æˆ·é…ç½® ===
Type=notify
User=database
Group=database
# ä½¿ç”¨å›ºå®šç”¨æˆ·ï¼ˆæ•°æ®åº“éœ€è¦æŒä¹…åŒ–ï¼‰
DynamicUser=no
PIDFile=/var/run/database/database.pid

# === æ–‡ä»¶ç³»ç»Ÿå®‰å…¨ ===
# ç§æœ‰ä¸´æ—¶ç›®å½•
PrivateTmp=yes
# ä¿æŠ¤ç”¨æˆ·ç›®å½•
ProtectHome=yes
# è®¾å¤‡éš”ç¦»ï¼ˆæ•°æ®åº“é€šå¸¸ä¸éœ€è¦ç›´æ¥è®¾å¤‡è®¿é—®ï¼‰
PrivateDevices=yes
# é…ç½®æ–‡ä»¶åªè¯»
ReadOnlyPaths=/etc/database
# æ•°æ®ç›®å½•å¯å†™ï¼ˆä¸è®¾ç½®ReadOnlyï¼‰
# æ—¥å¿—ç›®å½•å¯å†™
# éšè—ä¸éœ€è¦çš„ç³»ç»Ÿç›®å½•
InaccessiblePaths=/boot /root

# === ç½‘ç»œå®‰å…¨ ===
# åªå…è®¸æœ¬åœ°å’Œå†…ç½‘è¿æ¥
IPAddressAllow=127.0.0.1/8 10.0.0.0/8 192.168.0.0/16 172.16.0.0/12
# ç¦æ­¢å¤–ç½‘è®¿é—®
IPAddressDeny=0.0.0.0/0

# === ç³»ç»Ÿè°ƒç”¨å®‰å…¨ ===
# å…è®¸æ–‡ä»¶ç³»ç»Ÿå’Œç½‘ç»œè°ƒç”¨
SystemCallFilter=@system-service @file-system @network-io
# ç¦æ­¢è°ƒè¯•å’Œç‰¹æƒè°ƒç”¨
SystemCallFilter=~@debug @privileged @raw-io @mount
SystemCallArchitectures=native

# === æƒé™é™åˆ¶ ===
NoNewPrivileges=yes
# æ•°æ®åº“é€šå¸¸ä¸éœ€è¦ç‰¹æ®Šcapabilities
CapabilityBoundingSet=

# === ç³»ç»Ÿä¿æŠ¤ ===
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectControlGroups=yes
ProtectClock=yes

# === åº”ç”¨é…ç½® ===
ExecStart=/usr/local/bin/database --config /etc/database/db.conf
ExecReload=/bin/kill -HUP $MAINPID
WorkingDirectory=/var/lib/database

# === è¿è¡Œæ—¶é…ç½® ===
Restart=always
RestartSec=10
TimeoutStartSec=60
TimeoutStopSec=30

[Install]
WantedBy=multi-user.target
```

### 8.3 å®‰å…¨é…ç½®éªŒè¯å’Œæµ‹è¯•


**ğŸ” å®‰å…¨é…ç½®éªŒè¯æ­¥éª¤**
```bash
# 1. è¯­æ³•æ£€æŸ¥
sudo systemd-analyze verify /etc/systemd/system/secure-webapp.service

# 2. å¯åŠ¨æœåŠ¡å¹¶æ£€æŸ¥çŠ¶æ€
sudo systemctl start secure-webapp
sudo systemctl status secure-webapp

# 3. æ£€æŸ¥è¿›ç¨‹éš”ç¦»æ•ˆæœ
sudo systemctl show secure-webapp --property=MainPID
# è·å–PIDåï¼Œè¿›å…¥è¿›ç¨‹çš„å‘½åç©ºé—´æ£€æŸ¥
sudo nsenter -t <PID> -n -p -m /bin/bash

# 4. éªŒè¯ç½‘ç»œéš”ç¦»
# åœ¨æœåŠ¡çš„å‘½åç©ºé—´ä¸­æµ‹è¯•ç½‘ç»œè®¿é—®
curl google.com  # åº”è¯¥è¢«é˜»æ­¢
curl 192.168.1.1  # åº”è¯¥è¢«å…è®¸æˆ–é˜»æ­¢ï¼ˆæ ¹æ®é…ç½®ï¼‰

# 5. éªŒè¯æ–‡ä»¶ç³»ç»Ÿéš”ç¦»
ls /tmp  # æŸ¥çœ‹æ˜¯å¦æ˜¯ç§æœ‰ä¸´æ—¶ç›®å½•
ls /home  # æŸ¥çœ‹æ˜¯å¦è¢«ä¿æŠ¤
touch /etc/webapp/test  # æµ‹è¯•åªè¯»ä¿æŠ¤

# 6. éªŒè¯ç³»ç»Ÿè°ƒç”¨é™åˆ¶
# æŸ¥çœ‹å½“å‰ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤è§„åˆ™
grep Seccomp /proc/<PID>/status
```

**âš ï¸ å®‰å…¨é…ç½®å¸¸è§é—®é¢˜å’Œè§£å†³**
```bash
# é—®é¢˜1ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥ - æƒé™ä¸è¶³
# æ£€æŸ¥æ—¥å¿—
sudo journalctl -u secure-webapp -f
# å¸¸è§åŸå› ï¼šæ–‡ä»¶æƒé™ã€ç«¯å£æƒé™ã€èƒ½åŠ›é…ç½®é”™è¯¯

# é—®é¢˜2ï¼šåŠŸèƒ½å¼‚å¸¸ - è¿‡åº¦é™åˆ¶
# é€æ­¥æ”¾å®½é™åˆ¶ï¼Œæ‰¾åˆ°æœ€å°æƒé™é›†åˆ
# ä»åŸºç¡€é…ç½®å¼€å§‹ï¼Œé€æ­¥æ·»åŠ å®‰å…¨é™åˆ¶

# é—®é¢˜3ï¼šæ€§èƒ½å½±å“
# ä½¿ç”¨systemd-analyze blame æ£€æŸ¥å¯åŠ¨æ—¶é—´
# æµ‹è¯•éš”ç¦»å¯¹æ€§èƒ½çš„å½±å“
```

### 8.4 å®‰å…¨é…ç½®åˆ†çº§ç­–ç•¥


**ğŸ“Š å®‰å…¨çº§åˆ«åˆ†ç±»**
```
ğŸŸ¢ åŸºç¡€å®‰å…¨çº§åˆ«ï¼ˆæ¨èæ‰€æœ‰æœåŠ¡ï¼‰ï¼š
â”œâ”€ User/Group ç”¨æˆ·éš”ç¦»
â”œâ”€ NoNewPrivileges ç¦æ­¢æƒé™æå‡
â”œâ”€ PrivateTmp ç§æœ‰ä¸´æ—¶ç›®å½•
â””â”€ ProtectHome ä¿æŠ¤ç”¨æˆ·ç›®å½•

ğŸŸ¡ æ ‡å‡†å®‰å…¨çº§åˆ«ï¼ˆé¢å‘å…¬ç½‘æœåŠ¡ï¼‰ï¼š
â”œâ”€ åŸºç¡€å®‰å…¨ +
â”œâ”€ SystemCallFilter ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤
â”œâ”€ CapabilityBoundingSet æƒé™é™åˆ¶
â”œâ”€ PrivateDevices è®¾å¤‡éš”ç¦»
â””â”€ ç½‘ç»œè®¿é—®æ§åˆ¶

ğŸ”´ ä¸¥æ ¼å®‰å…¨çº§åˆ«ï¼ˆé«˜å®‰å…¨è¦æ±‚ï¼‰ï¼š
â”œâ”€ æ ‡å‡†å®‰å…¨ +
â”œâ”€ ReadOnlyPaths å…³é”®è·¯å¾„åªè¯»
â”œâ”€ InaccessiblePaths æ•æ„Ÿè·¯å¾„éšè—
â”œâ”€ ProtectKernelTunables å†…æ ¸ä¿æŠ¤
â””â”€ å…¨é¢çš„ç³»ç»Ÿè°ƒç”¨é™åˆ¶
```

**ğŸ¯ åˆ†çº§åº”ç”¨ç¤ºä¾‹**
```ini
# åŸºç¡€å®‰å…¨é…ç½®ï¼ˆé€‚ç”¨äºå†…ç½‘æœåŠ¡ï¼‰
[Service]
User=myapp
NoNewPrivileges=yes
PrivateTmp=yes
ProtectHome=yes

# æ ‡å‡†å®‰å…¨é…ç½®ï¼ˆé€‚ç”¨äºå¯¹å¤–æœåŠ¡ï¼‰
[Service]
User=myapp
NoNewPrivileges=yes
PrivateTmp=yes
ProtectHome=yes
PrivateDevices=yes
SystemCallFilter=@system-service
CapabilityBoundingSet=
IPAddressAllow=192.168.0.0/16

# ä¸¥æ ¼å®‰å…¨é…ç½®ï¼ˆé€‚ç”¨äºå…³é”®æœåŠ¡ï¼‰
[Service]
User=myapp
NoNewPrivileges=yes
PrivateTmp=yes
ProtectHome=yes
PrivateDevices=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
SystemCallFilter=@system-service
SystemCallFilter=~@privileged @debug @raw-io
CapabilityBoundingSet=
ReadOnlyPaths=/etc/myapp
InaccessiblePaths=/boot /root
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„å®‰å…¨é…ç½®


**ğŸ” æ ¸å¿ƒå®‰å…¨æœºåˆ¶**
```
ğŸ”¸ ç”¨æˆ·éš”ç¦»ï¼šUser/Group/DynamicUser - é¿å…rootæƒé™è¿è¡Œ
ğŸ”¸ æ–‡ä»¶ç³»ç»Ÿéš”ç¦»ï¼šPrivateTmp/ProtectHome/ReadOnlyPaths - ä¿æŠ¤æ•æ„Ÿæ–‡ä»¶
ğŸ”¸ ç½‘ç»œæ§åˆ¶ï¼šPrivateNetwork/IPAddressDeny - é™åˆ¶ç½‘ç»œè®¿é—®
ğŸ”¸ ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤ï¼šSystemCallFilter - é˜²æ­¢æ¶æ„ç³»ç»Ÿè°ƒç”¨
ğŸ”¸ æƒé™é™åˆ¶ï¼šCapabilityBoundingSet/NoNewPrivileges - æœ€å°æƒé™åŸåˆ™
ğŸ”¸ è¿›ç¨‹éš”ç¦»ï¼šPrivateDevices/ProtectKernel* - ç³»ç»Ÿçº§ä¿æŠ¤
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ¯ å®‰å…¨é…ç½®çš„æ ¸å¿ƒæ€æƒ³**
```
çºµæ·±é˜²å¾¡ï¼šå¤šå±‚å®‰å…¨æœºåˆ¶ï¼Œä¸€å±‚è¢«çªç ´å…¶ä»–å±‚ç»§ç»­ä¿æŠ¤
æœ€å°æƒé™ï¼šåªç»™æœåŠ¡å¿…éœ€çš„æœ€å°æƒé™ï¼Œå…¶ä»–éƒ½æ‹’ç»
éš”ç¦»åŸåˆ™ï¼šå°†æœåŠ¡ä¸ç³»ç»Ÿã€æœåŠ¡ä¸æœåŠ¡ä¹‹é—´éš”ç¦»
ç™½åå•æ¨¡å¼ï¼šé»˜è®¤æ‹’ç»ï¼Œæ˜ç¡®å…è®¸éœ€è¦çš„åŠŸèƒ½
```

**âš–ï¸ å®‰å…¨ä¸åŠŸèƒ½çš„å¹³è¡¡**
```
è¿‡åº¦é™åˆ¶ï¼š
âŒ æœåŠ¡åŠŸèƒ½å—å½±å“ï¼Œç”¨æˆ·ä½“éªŒå·®
âŒ ç»´æŠ¤æˆæœ¬é«˜ï¼Œæ•…éšœæ’æŸ¥éš¾

é™åˆ¶ä¸è¶³ï¼š
âŒ å®‰å…¨é£é™©é«˜ï¼Œæ”»å‡»é¢å¤§
âŒ ç³»ç»Ÿè¢«å…¥ä¾µåå½±å“èŒƒå›´å¤§

åˆç†å¹³è¡¡ï¼š
âœ… æ ¹æ®æœåŠ¡ç±»å‹é€‰æ‹©åˆé€‚çš„å®‰å…¨çº§åˆ«
âœ… ä»åŸºç¡€é…ç½®å¼€å§‹ï¼Œé€æ­¥å¢å¼º
âœ… å……åˆ†æµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£å¸¸
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“ é…ç½®é€‰æ‹©æŒ‡å—**
```
Webåº”ç”¨æœåŠ¡ï¼š
âœ… å¿…é¡»ï¼šUserã€NoNewPrivilegesã€PrivateTmp
âœ… æ¨èï¼šSystemCallFilterã€PrivateDevicesã€ç½‘ç»œæ§åˆ¶
âœ… å¯é€‰ï¼šæ–‡ä»¶ç³»ç»Ÿåªè¯»ä¿æŠ¤ï¼ˆæ ¹æ®éœ€æ±‚ï¼‰

æ•°æ®åº“æœåŠ¡ï¼š
âœ… å¿…é¡»ï¼šUserã€PrivateTmpã€ç½‘ç»œè®¿é—®æ§åˆ¶
âœ… æ¨èï¼šProtectHomeã€SystemCallFilter
âœ… æ³¨æ„ï¼šä¸è¦è¿‡åº¦é™åˆ¶æ–‡ä»¶ç³»ç»Ÿè®¿é—®

è®¡ç®—æœåŠ¡ï¼ˆæ— ç½‘ç»œéœ€æ±‚ï¼‰ï¼š
âœ… æœ€ä¸¥æ ¼ï¼šPrivateNetworkã€å®Œæ•´æ–‡ä»¶ç³»ç»Ÿéš”ç¦»
âœ… ç³»ç»Ÿè°ƒç”¨ï¼šåªå…è®¸è®¡ç®—ç›¸å…³è°ƒç”¨
âœ… è®¾å¤‡éš”ç¦»ï¼šPrivateDevices=yes
```

**ğŸ”§ é…ç½®å®æ–½æ­¥éª¤**
```
1. åŸºç¡€é…ç½®ï¼š
   â””â”€ è®¾ç½®User/Groupï¼Œå¯ç”¨NoNewPrivileges

2. æ–‡ä»¶ç³»ç»Ÿä¿æŠ¤ï¼š
   â””â”€ æ·»åŠ PrivateTmpã€ProtectHome

3. ç½‘ç»œæ§åˆ¶ï¼š
   â””â”€ æ ¹æ®éœ€æ±‚é…ç½®ç½‘ç»œè®¿é—®é™åˆ¶

4. ç³»ç»Ÿè°ƒç”¨é™åˆ¶ï¼š
   â””â”€ ä»@system-serviceå¼€å§‹ï¼Œé€æ­¥ç²¾ç»†åŒ–

5. é«˜çº§ä¿æŠ¤ï¼š
   â””â”€ æ·»åŠ è®¾å¤‡éš”ç¦»ã€å†…æ ¸ä¿æŠ¤ç­‰

6. æµ‹è¯•éªŒè¯ï¼š
   â””â”€ å…¨é¢æµ‹è¯•åŠŸèƒ½ï¼Œç¡®ä¿å®‰å…¨é…ç½®ç”Ÿæ•ˆ
```

### 9.4 å®‰å…¨é…ç½®è®°å¿†è¦ç‚¹


**ğŸ§  è®°å¿†å£è¯€**
```
"ç”¨æˆ·éš”ç¦»æ˜¯åŸºç¡€ï¼Œæ–‡ä»¶ç½‘ç»œè¦æ§åˆ¶
ç³»ç»Ÿè°ƒç”¨è¦è¿‡æ»¤ï¼Œæƒé™èƒ½åŠ›è¦é™åˆ¶
è®¾å¤‡å†…æ ¸è¦ä¿æŠ¤ï¼Œæµ‹è¯•éªŒè¯ä¸èƒ½å°‘"

æ ¸å¿ƒåŸåˆ™ï¼š
â€¢ æœ€å°æƒé™ï¼šåªç»™å¿…éœ€çš„æƒé™
â€¢ çºµæ·±é˜²å¾¡ï¼šå¤šå±‚ä¿æŠ¤æœºåˆ¶
â€¢ ç™½åå•æ¨¡å¼ï¼šé»˜è®¤æ‹’ç»ï¼Œæ˜ç¡®å…è®¸
â€¢ æŒç»­éªŒè¯ï¼šé…ç½®åè¦å……åˆ†æµ‹è¯•
```

**ğŸ” æ•…éšœæ’æŸ¥æ€è·¯**
```
æœåŠ¡å¯åŠ¨å¤±è´¥ï¼š
1. æ£€æŸ¥ç”¨æˆ·å’Œæ–‡ä»¶æƒé™
2. æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨é™åˆ¶æ˜¯å¦è¿‡ä¸¥
3. ç¡®è®¤ç½‘ç»œé…ç½®æ˜¯å¦æ­£ç¡®
4. éªŒè¯èƒ½åŠ›é…ç½®æ˜¯å¦åˆé€‚

åŠŸèƒ½å¼‚å¸¸ï¼š
1. é€æ­¥ç§»é™¤å®‰å…¨é™åˆ¶å®šä½é—®é¢˜
2. æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿè®¿é—®æƒé™
3. éªŒè¯ç½‘ç»œè®¿é—®æ˜¯å¦è¢«é˜»æ­¢
4. ç¡®è®¤ç³»ç»Ÿè°ƒç”¨æ˜¯å¦è¢«è¿‡æ»¤

æ€§èƒ½é—®é¢˜ï¼š
1. æ£€æŸ¥å‘½åç©ºé—´åˆ›å»ºå¼€é”€
2. è¯„ä¼°ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤å½±å“
3. ç›‘æ§éš”ç¦»æœºåˆ¶çš„èµ„æºæ¶ˆè€—
```

**ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“**
- systemdå®‰å…¨æœºåˆ¶æä¾›äº†å¼ºå¤§çš„æœåŠ¡éš”ç¦»èƒ½åŠ›
- å®‰å…¨é…ç½®éœ€è¦æ ¹æ®å…·ä½“æœåŠ¡ç±»å‹å’Œéœ€æ±‚æ¥å®šåˆ¶
- ä»åŸºç¡€é…ç½®å¼€å§‹ï¼Œé€æ­¥å¢å¼ºå®‰å…¨é™åˆ¶
- å……åˆ†æµ‹è¯•æ˜¯ç¡®ä¿å®‰å…¨é…ç½®æœ‰æ•ˆæ€§çš„å…³é”®
- å¹³è¡¡å®‰å…¨æ€§å’Œå¯ç”¨æ€§ï¼Œé¿å…è¿‡åº¦é…ç½®å½±å“åŠŸèƒ½