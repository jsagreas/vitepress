---
title: 6ã€systemd socketæ¿€æ´»æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [socketæ¿€æ´»æœºåˆ¶æ¦‚è¿°](#1-socketæ¿€æ´»æœºåˆ¶æ¦‚è¿°)
2. [socketæ¿€æ´»å·¥ä½œåŸç†](#2-socketæ¿€æ´»å·¥ä½œåŸç†)
3. [socketå•å…ƒæ–‡ä»¶é…ç½®](#3-socketå•å…ƒæ–‡ä»¶é…ç½®)
4. [å¥—æ¥å­—ç±»å‹è¯¦è§£](#4-å¥—æ¥å­—ç±»å‹è¯¦è§£)
5. [æŒ‰éœ€å¯åŠ¨æœåŠ¡é…ç½®](#5-æŒ‰éœ€å¯åŠ¨æœåŠ¡é…ç½®)
6. [socketæ¿€æ´»è°ƒè¯•ä¸ç›‘æ§](#6-socketæ¿€æ´»è°ƒè¯•ä¸ç›‘æ§)
7. [æ›¿ä»£inetdå®ç°æ–¹æ¡ˆ](#7-æ›¿ä»£inetdå®ç°æ–¹æ¡ˆ)
8. [socketæ¿€æ´»å®‰å…¨è€ƒè™‘](#8-socketæ¿€æ´»å®‰å…¨è€ƒè™‘)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ socketæ¿€æ´»æœºåˆ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯socketæ¿€æ´»


> **ğŸ’¡ æ ¸å¿ƒç†è§£**ï¼šsocketæ¿€æ´»å°±åƒé…’åº—çš„å‰å°æœåŠ¡â€”â€”å‰å°ä¸€ç›´åœ¨é‚£é‡Œç­‰å®¢äººï¼Œä½†åé¢çš„æœåŠ¡äººå‘˜åªæœ‰å®¢äººæ¥äº†æ‰å¼€å§‹å·¥ä½œ

**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
ä¼ ç»Ÿå¯åŠ¨æ–¹å¼ï¼š
ç³»ç»Ÿå¯åŠ¨ â†’ æ‰€æœ‰æœåŠ¡å…¨éƒ¨å¯åŠ¨ â†’ å ç”¨å†…å­˜ç­‰èµ„æº â†’ ç­‰å¾…è¯·æ±‚

socketæ¿€æ´»æ–¹å¼ï¼š
ç³»ç»Ÿå¯åŠ¨ â†’ åªåˆ›å»ºsocketç›‘å¬ â†’ æœ‰è¯·æ±‚æ—¶æ‰å¯åŠ¨å¯¹åº”æœåŠ¡ â†’ èŠ‚çœèµ„æº
```

socketæ¿€æ´»ï¼ˆSocket Activationï¼‰æ˜¯systemdçš„ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼Œå®ƒå…è®¸ç³»ç»Ÿåœ¨æœ‰è¿æ¥è¯·æ±‚æ—¶æ‰å¯åŠ¨ç›¸åº”çš„æœåŠ¡ï¼Œè€Œä¸æ˜¯åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å°±å¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚

**ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿**
- **èµ„æºèŠ‚çº¦**ï¼šæœåŠ¡ä¸ç”¨æ—¶ä¸å ç”¨å†…å­˜å’ŒCPU
- **å¿«é€Ÿå¯åŠ¨**ï¼šç³»ç»Ÿå¯åŠ¨æ—¶åªéœ€åˆ›å»ºsocketï¼Œä¸éœ€è¦å¯åŠ¨å…·ä½“æœåŠ¡
- **é›¶åœæœºæ—¶é—´**ï¼šæœåŠ¡é‡å¯æ—¶è¿æ¥ä¸ä¼šä¸¢å¤±
- **å¹¶å‘å¤„ç†**ï¼šå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªè¿æ¥è¯·æ±‚

### 1.2 å®é™…åº”ç”¨åœºæ™¯


```
ğŸ“Œ å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š

WebæœåŠ¡å™¨ï¼š
â€¢ Apache/Nginxåœ¨æœ‰HTTPè¯·æ±‚æ—¶æ‰å¯åŠ¨
â€¢ å‡å°‘ç³»ç»Ÿå¯åŠ¨æ—¶é—´å’Œå†…å­˜å ç”¨

æ•°æ®åº“æœåŠ¡ï¼š
â€¢ PostgreSQL/MySQLæŒ‰éœ€å¯åŠ¨
â€¢ é¿å…é•¿æœŸå ç”¨å¤§é‡å†…å­˜

å¼€å‘å·¥å…·ï¼š
â€¢ SSHæœåŠ¡ã€FTPæœåŠ¡æŒ‰éœ€å¯åŠ¨
â€¢ æé«˜ç³»ç»Ÿæ•´ä½“æ€§èƒ½
```

---

## 2. âš™ï¸ socketæ¿€æ´»å·¥ä½œåŸç†


### 2.1 å·¥ä½œæœºåˆ¶è¯¦è§£


**ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹**
```
ç¬¬ä¸€æ­¥ï¼šç³»ç»Ÿå¯åŠ¨é˜¶æ®µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ systemdå¯åŠ¨ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    åˆ›å»ºsocketæ–‡ä»¶
â”‚ è¯»å–.socket â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    é…ç½®     â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ ç›‘å¬ç«¯å£/è·¯å¾„â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬äºŒæ­¥ï¼šè¯·æ±‚åˆ°è¾¾é˜¶æ®µ  
å®¢æˆ·ç«¯è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å¯åŠ¨æœåŠ¡
â”‚   socket    â”‚â”€â”€â”€â–¶â”‚  systemd    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥æ”¶è¯·æ±‚   â”‚    â”‚  æ£€æµ‹è¯·æ±‚   â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â–¼
       â”‚                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚           ä¼ é€’socketæè¿°ç¬¦      â”‚ å¯åŠ¨.serviceâ”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    å•å…ƒ     â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 socketä¼ é€’æœºåˆ¶


> **ğŸ” æ·±å…¥ç†è§£**ï¼šsocketæ¿€æ´»çš„å…³é”®æ˜¯"æ–‡ä»¶æè¿°ç¬¦ä¼ é€’"â€”â€”å°±åƒæ¥åŠ›èµ›ä¸€æ ·ï¼ŒsystemdæŠŠsocketçš„"æ¥åŠ›æ£’"ä¼ ç»™å®é™…çš„æœåŠ¡è¿›ç¨‹

**æ–‡ä»¶æè¿°ç¬¦ä¼ é€’è¿‡ç¨‹ï¼š**
```
1. systemdåˆ›å»ºsocketå¹¶ç›‘å¬
2. æœ‰è¿æ¥æ—¶ï¼Œsystemdå¯åŠ¨ç›®æ ‡æœåŠ¡
3. å°†socketçš„æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™æœåŠ¡è¿›ç¨‹
4. æœåŠ¡è¿›ç¨‹æ¥ç®¡socketï¼Œå¼€å§‹å¤„ç†è¯·æ±‚
5. systemdç»§ç»­ç›‘å¬æ–°çš„è¿æ¥è¯·æ±‚
```

---

## 3. ğŸ“‹ socketå•å…ƒæ–‡ä»¶é…ç½®


### 3.1 åŸºæœ¬é…ç½®ç»“æ„


socketå•å…ƒæ–‡ä»¶ï¼ˆ`.socket`ï¼‰çš„åŸºæœ¬ç»“æ„å¦‚ä¸‹ï¼š

```ini
# /etc/systemd/system/myapp.socket
[Unit]
Description=My Application Socket
# åœ¨ç½‘ç»œæœåŠ¡ä¹‹å‰å¯åŠ¨
Before=sockets.target

[Socket]
# ç›‘å¬é…ç½®
ListenStream=8080
# æ¥å—è¿æ¥æ–¹å¼
Accept=false
# å…³è”çš„æœåŠ¡
Service=myapp.service

[Install]
WantedBy=sockets.target
```

### 3.2 æ ¸å¿ƒé…ç½®é€‰é¡¹è¯¦è§£


**ğŸ”¸ ListenStreamï¼ˆTCPæµå¥—æ¥å­—ï¼‰**
```ini
# ç›‘å¬TCPç«¯å£
ListenStream=8080
ListenStream=127.0.0.1:3000
ListenStream=[::]:8080

# ç›‘å¬Unix socket
ListenStream=/run/myapp.sock
```

**ğŸ”¸ Accepté…ç½®**
```ini
# Accept=falseï¼ˆæ¨èæ–¹å¼ï¼‰
# ä¸€ä¸ªæœåŠ¡å®ä¾‹å¤„ç†æ‰€æœ‰è¿æ¥
Accept=false
Service=myapp.service

# Accept=trueï¼ˆç±»ä¼¼inetdï¼‰
# æ¯ä¸ªè¿æ¥å¯åŠ¨ä¸€ä¸ªæœåŠ¡å®ä¾‹
Accept=true
Service=myapp@.service  # ä½¿ç”¨æ¨¡æ¿æœåŠ¡
```

**ğŸ”¸ å…¶ä»–é‡è¦é…ç½®**
```ini
[Socket]
# åŒæ—¶å¤„ç†çš„æœ€å¤§è¿æ¥æ•°
MaxConnections=64

# socketæ–‡ä»¶æƒé™ï¼ˆUnix socketï¼‰
SocketMode=0666
SocketUser=www-data
SocketGroup=www-data

# TCPç›¸å…³è®¾ç½®
KeepAlive=true
NoDelay=true
```

### 3.3 å®Œæ•´é…ç½®ç¤ºä¾‹


```ini
# /etc/systemd/system/webapp.socket
[Unit]
Description=Web Application Socket
Documentation=https://example.com/docs
# ç¡®ä¿ç½‘ç»œå·²å‡†å¤‡å¥½
After=network.target

[Socket]
# ç›‘å¬HTTPç«¯å£
ListenStream=80
ListenStream=443

# è®¾ç½®è¿æ¥é™åˆ¶
MaxConnections=100
MaxConnectionsPerSource=10

# ä¿æŒè¿æ¥æ´»è·ƒ
KeepAlive=true
TriggerLimitIntervalSec=2s
TriggerLimitBurst=20

# å…³è”çš„æœåŠ¡
Service=webapp.service

[Install]
WantedBy=sockets.target
```

---

## 4. ğŸ”Œ å¥—æ¥å­—ç±»å‹è¯¦è§£


### 4.1 TCPå¥—æ¥å­—ï¼ˆListenStreamï¼‰


**ç”¨é€”**ï¼šå¤„ç†TCPè¿æ¥ï¼Œå¦‚WebæœåŠ¡ã€æ•°æ®åº“è¿æ¥ç­‰

```ini
[Socket]
# æ ‡å‡†HTTPç«¯å£
ListenStream=80

# æŒ‡å®šIPåœ°å€å’Œç«¯å£
ListenStream=192.168.1.100:8080

# IPv6æ”¯æŒ
ListenStream=[2001:db8::1]:8080

# æ‰€æœ‰åœ°å€ï¼ˆIPv4å’ŒIPv6ï¼‰
ListenStream=8080
```

**ğŸ“Š TCPé…ç½®å‚æ•°å¯¹æ¯”**

| é…ç½®é¡¹ | **ä½œç”¨** | **æ¨èå€¼** | **è¯´æ˜** |
|---------|----------|-----------|---------|
| `KeepAlive` | `ä¿æŒè¿æ¥æ´»è·ƒ` | `true` | `å®šæœŸæ£€æµ‹è¿æ¥çŠ¶æ€` |
| `NoDelay` | `ç¦ç”¨Nagleç®—æ³•` | `true` | `å‡å°‘å»¶è¿Ÿï¼Œæé«˜å“åº”é€Ÿåº¦` |
| `MaxConnections` | `æœ€å¤§å¹¶å‘è¿æ¥` | `100-1000` | `æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´` |

### 4.2 UDPå¥—æ¥å­—ï¼ˆListenDatagramï¼‰


**ç”¨é€”**ï¼šå¤„ç†UDPæ•°æ®åŒ…ï¼Œå¦‚DNSæœåŠ¡ã€DHCPæœåŠ¡ç­‰

```ini
[Socket]
# DNSæœåŠ¡å™¨
ListenDatagram=53

# æŒ‡å®šæ¥å£
ListenDatagram=eth0:514

# å¤šä¸ªç«¯å£
ListenDatagram=123
ListenDatagram=323
```

### 4.3 Unix Socketï¼ˆæœ¬åœ°å¥—æ¥å­—ï¼‰


**ç”¨é€”**ï¼šè¿›ç¨‹é—´é€šä¿¡ï¼Œæ€§èƒ½æœ€é«˜ï¼Œå¸¸ç”¨äºæœ¬åœ°æœåŠ¡

```ini
[Socket]
# Unix domain socket
ListenStream=/run/myapp/myapp.sock

# è®¾ç½®æƒé™
SocketMode=0660
SocketUser=myapp
SocketGroup=myapp

# è‡ªåŠ¨åˆ é™¤æ—§socketæ–‡ä»¶
RemoveOnStop=true
```

> **ğŸ’­ å®é™…ç±»æ¯”**ï¼šUnix Socketå°±åƒå®¶é‡Œçš„å†…éƒ¨ç”µè¯ï¼ŒTCP Socketåƒå…¬å…±ç”µè¯â€”â€”å†…éƒ¨ç”µè¯é€Ÿåº¦å¿«ä½†åªèƒ½å®¶é‡Œç”¨ï¼Œå…¬å…±ç”µè¯å¯ä»¥æ‰“ç»™ä»»ä½•äººä½†ç¨å¾®æ…¢ä¸€äº›

### 4.4 FIFOï¼ˆå‘½åç®¡é“ï¼‰


**ç”¨é€”**ï¼šç®€å•çš„è¿›ç¨‹é—´æ•°æ®ä¼ è¾“

```ini
[Socket]
# åˆ›å»ºFIFO
ListenFIFO=/run/myapp.fifo

# è®¾ç½®æƒé™
SocketMode=0640
SocketUser=producer
SocketGroup=consumer
```

---

## 5. ğŸš€ æŒ‰éœ€å¯åŠ¨æœåŠ¡é…ç½®


### 5.1 æœåŠ¡å•å…ƒé…ç½®


ä¸ºäº†é…åˆsocketæ¿€æ´»ï¼ŒæœåŠ¡å•å…ƒéœ€è¦ç‰¹æ®Šé…ç½®ï¼š

```ini
# /etc/systemd/system/myapp.service
[Unit]
Description=My Application Service
# ä¸è‡ªåŠ¨å¯åŠ¨ï¼Œç”±socketè§¦å‘
Requires=myapp.socket

[Service]
Type=notify  # æˆ–è€…simpleã€exec
User=myapp
Group=myapp

# æ¥æ”¶socketæ–‡ä»¶æè¿°ç¬¦
StandardInput=socket
StandardOutput=journal
StandardError=journal

# åº”ç”¨ç¨‹åºè·¯å¾„
ExecStart=/usr/local/bin/myapp

# ä¸è¦åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å¯åŠ¨
[Install]
# æ³¨æ„ï¼šä¸è®¾ç½®WantedByï¼Œç”±socketæ§åˆ¶å¯åŠ¨
```

### 5.2 åº”ç”¨ç¨‹åºé€‚é…


**ğŸ”§ ç¨‹åºéœ€è¦æ”¯æŒæ–‡ä»¶æè¿°ç¬¦ä¼ é€’**

Pythonç¤ºä¾‹ï¼š
```python
#!/usr/bin/env python3
import socket
import os

def get_systemd_socket():
    """è·å–systemdä¼ é€’çš„socket"""
    # systemdå°†socketæè¿°ç¬¦è®¾ç½®ä¸ºæ ‡å‡†è¾“å…¥ï¼ˆfd=0ï¼‰
    listen_fds = int(os.environ.get('LISTEN_FDS', 0))
    
    if listen_fds > 0:
        # ç¬¬ä¸€ä¸ªä¼ é€’çš„socketæ˜¯fd=3
        sock = socket.fromfd(3, socket.AF_INET, socket.SOCK_STREAM)
        return sock
    return None

# ä½¿ç”¨socketæ¿€æ´»çš„HTTPæœåŠ¡ç¤ºä¾‹
def run_server():
    sock = get_systemd_socket()
    
    if sock:
        print("ä½¿ç”¨systemdä¼ é€’çš„socket")
    else:
        # å¤‡ç”¨ï¼šè‡ªå·±åˆ›å»ºsocket
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.bind(('localhost', 8080))
        print("åˆ›å»ºæ–°çš„socket")
    
    sock.listen(5)
    
    while True:
        conn, addr = sock.accept()
        # å¤„ç†è¿æ¥...
```

### 5.3 é…ç½®æ¿€æ´»ä¸æµ‹è¯•


```bash
# 1. åˆ›å»ºé…ç½®æ–‡ä»¶
sudo vim /etc/systemd/system/myapp.socket
sudo vim /etc/systemd/system/myapp.service

# 2. é‡è½½é…ç½®
sudo systemctl daemon-reload

# 3. å¯åŠ¨socketï¼ˆä¸å¯åŠ¨æœåŠ¡ï¼‰
sudo systemctl start myapp.socket

# 4. æŸ¥çœ‹socketçŠ¶æ€
sudo systemctl status myapp.socket

# 5. æµ‹è¯•è¿æ¥ï¼ˆè¿™æ—¶æœåŠ¡ä¼šè‡ªåŠ¨å¯åŠ¨ï¼‰
curl http://localhost:8080/

# 6. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status myapp.service
```

---

## 6. ğŸ” socketæ¿€æ´»è°ƒè¯•ä¸ç›‘æ§


### 6.1 è°ƒè¯•å‘½ä»¤é›†åˆ


**ğŸ“‹ åŸºç¡€çŠ¶æ€æ£€æŸ¥**
```bash
# æŸ¥çœ‹æ‰€æœ‰socketå•å…ƒ
systemctl list-units --type=socket

# æŸ¥çœ‹socketè¯¦ç»†çŠ¶æ€
systemctl status myapp.socket

# æŸ¥çœ‹socketç›‘å¬æƒ…å†µ
sudo ss -tlnp | grep :8080

# æŸ¥çœ‹systemd socketæ–‡ä»¶æè¿°ç¬¦
sudo systemctl show myapp.socket -p ListenStream
```

**ğŸ” æ·±åº¦è°ƒè¯•ä¿¡æ¯**
```bash
# æŸ¥çœ‹socketæ¿€æ´»æ—¥å¿—
journalctl -u myapp.socket -f

# æŸ¥çœ‹æœåŠ¡å¯åŠ¨æ—¥å¿—
journalctl -u myapp.service -f

# æŸ¥çœ‹socketæ–‡ä»¶æè¿°ç¬¦ä¼ é€’
systemd-analyze dump | grep -A 20 myapp.socket
```

### 6.2 ç›‘æ§è„šæœ¬ç¤ºä¾‹


```bash
#!/bin/bash
# socket-monitor.sh - socketæ¿€æ´»ç›‘æ§è„šæœ¬

SOCKET_NAME="myapp.socket"
SERVICE_NAME="myapp.service"

echo "=== Socketæ¿€æ´»ç›‘æ§ ==="

# æ£€æŸ¥socketçŠ¶æ€
echo "ğŸ“¡ SocketçŠ¶æ€ï¼š"
systemctl is-active $SOCKET_NAME

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "âš™ï¸ ServiceçŠ¶æ€ï¼š"
systemctl is-active $SERVICE_NAME

# æ£€æŸ¥ç›‘å¬ç«¯å£
echo "ğŸ” ç›‘å¬ç«¯å£ï¼š"
ss -tlnp | grep $(systemctl show $SOCKET_NAME -p ListenStream --value)

# è¿æ¥ç»Ÿè®¡
echo "ğŸ“Š è¿æ¥ç»Ÿè®¡ï¼š"
systemctl show $SOCKET_NAME -p NAccepted,NConnections --value
```

### 6.3 å¸¸è§é—®é¢˜è¯Šæ–­


```
ğŸš¨ é—®é¢˜æ’æŸ¥æ¸…å•ï¼š

Socketæ— æ³•ç»‘å®šç«¯å£ï¼š
1. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼šss -tlnp | grep :ç«¯å£
2. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®ï¼šsudo ufw status
3. æ£€æŸ¥SELinuxï¼šsudo sealert -a /var/log/audit/audit.log

æœåŠ¡å¯åŠ¨å¤±è´¥ï¼š
1. æ£€æŸ¥æœåŠ¡é…ç½®ï¼šsystemctl cat myapp.service
2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼šjournalctl -u myapp.service
3. æµ‹è¯•ç¨‹åºæ˜¯å¦æ”¯æŒfdä¼ é€’ï¼šæ‰‹åŠ¨è¿è¡Œæµ‹è¯•

æ–‡ä»¶æè¿°ç¬¦ä¼ é€’å¤±è´¥ï¼š
1. ç¡®è®¤Type=notifyæˆ–simple
2. æ£€æŸ¥StandardInput=socketè®¾ç½®
3. éªŒè¯ç¨‹åºæ˜¯å¦æ­£ç¡®è¯»å–LISTEN_FDSç¯å¢ƒå˜é‡
```

---

## 7. ğŸ”„ æ›¿ä»£inetdå®ç°æ–¹æ¡ˆ


### 7.1 ä»inetdè¿ç§»åˆ°systemd


> **ğŸ’­ ç®€å•ç±»æ¯”**ï¼šinetdå°±åƒè€å¼ç”µè¯æ€»æœºï¼Œæ¯ä¸ªç”µè¯éƒ½è¦æ¥çº¿å‘˜æ‰‹åŠ¨è½¬æ¥ï¼›systemd socketæ¿€æ´»åƒç°ä»£ç¨‹æ§äº¤æ¢æœºï¼Œæ™ºèƒ½è·¯ç”±æ›´é«˜æ•ˆ

**ğŸ”¸ ä¼ ç»Ÿinetdæ–¹å¼**
```
# /etc/inetd.conf
telnet  stream  tcp  nowait  telnetd  /usr/sbin/tcpd  in.telnetd
ftp     stream  tcp  nowait  root     /usr/sbin/tcpd  in.ftpd
```

**ğŸ”¸ systemdæ›¿ä»£æ–¹æ¡ˆ**
```ini
# telnet.socket
[Socket]
ListenStream=23
Accept=true

# telnet@.serviceï¼ˆæ¨¡æ¿æœåŠ¡ï¼‰
[Service]
Type=simple
ExecStart=/usr/sbin/in.telnetd
StandardInput=socket
```

### 7.2 è¿ç§»æ­¥éª¤è¯¦è§£


**æ­¥éª¤1ï¼šåˆ†æç°æœ‰inetdæœåŠ¡**
```bash
# æŸ¥çœ‹å½“å‰inetdé…ç½®
cat /etc/inetd.conf | grep -v '^#'

# è¯†åˆ«ä½¿ç”¨çš„æœåŠ¡å’Œç«¯å£
netstat -tlnp | grep inetd
```

**æ­¥éª¤2ï¼šåˆ›å»ºå¯¹åº”çš„socketé…ç½®**
```bash
# ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»º.socketæ–‡ä»¶
# ç¤ºä¾‹ï¼šFTPæœåŠ¡è¿ç§»
sudo tee /etc/systemd/system/ftp.socket << 'EOF'
[Unit]
Description=FTP Server Socket

[Socket]
ListenStream=21
Accept=true

[Install]
WantedBy=sockets.target
EOF
```

**æ­¥éª¤3ï¼šåˆ›å»ºæœåŠ¡é…ç½®**
```bash
# åˆ›å»ºå¯¹åº”çš„.serviceæ–‡ä»¶
sudo tee /etc/systemd/system/ftp@.service << 'EOF'
[Unit]
Description=FTP Server

[Service]
Type=simple
ExecStart=/usr/sbin/in.ftpd
StandardInput=socket
StandardOutput=journal
StandardError=journal
EOF
```

### 7.3 æ‰¹é‡è¿ç§»è„šæœ¬


```bash
#!/bin/bash
# inetd-to-systemd.sh - inetdæ‰¹é‡è¿ç§»è„šæœ¬

# è§£æinetd.confå¹¶ç”Ÿæˆsystemdé…ç½®
parse_inetd_config() {
    while IFS=$'\t ' read -r service type protocol wait user server args; do
        [[ $service =~ ^#.*|^$ ]] && continue
        
        echo "è¿ç§»æœåŠ¡: $service"
        
        # åˆ›å»ºsocketæ–‡ä»¶
        cat > "/etc/systemd/system/${service}.socket" << EOF
[Unit]
Description=${service^} Service Socket

[Socket]
Listen${type^}=${protocol}
Accept=true

[Install]
WantedBy=sockets.target
EOF

        # åˆ›å»ºæœåŠ¡æ–‡ä»¶
        cat > "/etc/systemd/system/${service}@.service" << EOF
[Unit]
Description=${service^} Service

[Service]
Type=simple
User=${user}
ExecStart=${server} ${args}
StandardInput=socket
EOF
        
        echo "âœ… å·²åˆ›å»º ${service}.socket å’Œ ${service}@.service"
    done < /etc/inetd.conf
}

# æ‰§è¡Œè¿ç§»
parse_inetd_config
systemctl daemon-reload
echo "ğŸ‰ è¿ç§»å®Œæˆï¼Œè¯·æ‰‹åŠ¨æµ‹è¯•å„ä¸ªæœåŠ¡"
```

---

## 8. ğŸ” socketæ¿€æ´»å®‰å…¨è€ƒè™‘


### 8.1 è®¿é—®æ§åˆ¶é…ç½®


**ğŸ”’ åŸºç¡€å®‰å…¨é…ç½®**
```ini
[Socket]
ListenStream=22

# é™åˆ¶è¿æ¥æ¥æº
BindIPv6Only=ipv6-only
IPAddressAllow=192.168.1.0/24
IPAddressDeny=any

# è¿æ¥é™åˆ¶
MaxConnections=10
MaxConnectionsPerSource=2

# é˜²DDoSè®¾ç½®
TriggerLimitBurst=5
TriggerLimitIntervalSec=10s
```

**ğŸ›¡ï¸ æƒé™æ§åˆ¶**
```ini
[Socket]
ListenStream=/run/secure.sock

# Unix socketæƒé™
SocketMode=0600
SocketUser=secure-user
SocketGroup=secure-group

# åªæœ‰æŒ‡å®šç”¨æˆ·å¯ä»¥è¿æ¥
DirectoryMode=0750
```

### 8.2 èµ„æºé™åˆ¶ä¸ç›‘æ§


```ini
[Socket]
# æ¥æ”¶ç¼“å†²åŒºå¤§å°
ReceiveBuffer=64K
SendBuffer=64K

# è¶…æ—¶è®¾ç½®
KeepAliveTimeSec=30
KeepAliveIntervalSec=5
KeepAliveProbes=3

[Service]
# æœåŠ¡èµ„æºé™åˆ¶
MemoryMax=128M
CPUQuota=50%

# è¿›ç¨‹æ•°é™åˆ¶
TasksMax=20
```

### 8.3 å®‰å…¨ç›‘æ§è„šæœ¬


```bash
#!/bin/bash
# socket-security-monitor.sh

SOCKET_NAME="$1"

if [[ -z "$SOCKET_NAME" ]]; then
    echo "ç”¨æ³•: $0 <socket-name>"
    exit 1
fi

echo "ğŸ”’ Socketå®‰å…¨çŠ¶æ€æ£€æŸ¥: $SOCKET_NAME"

# æ£€æŸ¥è¿æ¥æ•°
echo "ğŸ“Š å½“å‰è¿æ¥ï¼š"
systemctl show "$SOCKET_NAME" -p NAccepted,NConnections,NRefused

# æ£€æŸ¥æ‹’ç»çš„è¿æ¥
echo "âŒ è¢«æ‹’ç»çš„è¿æ¥ï¼š"
journalctl -u "$SOCKET_NAME" | grep -i "refused\|denied\|blocked" | tail -5

# æ£€æŸ¥å¼‚å¸¸è¿æ¥å°è¯•
echo "âš ï¸ å¼‚å¸¸è¿æ¥å°è¯•ï¼š"
journalctl -u "$SOCKET_NAME" --since "1 hour ago" | \
    grep -E "failed|error|timeout" | wc -l

# æ£€æŸ¥èµ„æºä½¿ç”¨
echo "ğŸ’¾ èµ„æºä½¿ç”¨æƒ…å†µï¼š"
SERVICE_NAME="${SOCKET_NAME%.socket}.service"
systemctl show "$SERVICE_NAME" -p MemoryCurrent,CPUUsageNSec 2>/dev/null || \
    echo "æœåŠ¡æœªè¿è¡Œ"
```

### 8.4 å®¡è®¡ä¸æ—¥å¿—


**é…ç½®è¯¦ç»†æ—¥å¿—è®°å½•**
```ini
[Socket]
ListenStream=443

# å¯ç”¨è¯¦ç»†æ—¥å¿—
StandardOutput=journal
StandardError=journal

[Service]
# å®¡è®¡ç›¸å…³é…ç½®
AuditWrite=true
LogLevelMax=info

# è®°å½•æ‰€æœ‰è¿æ¥
StandardOutput=journal+console
StandardError=journal+console
```

**æ—¥å¿—åˆ†æè„šæœ¬**
```bash
#!/bin/bash
# socket-log-analysis.sh

SOCKET_NAME="$1"
HOURS="${2:-24}"

echo "ğŸ“ˆ Socketæ´»åŠ¨åˆ†æ (æœ€è¿‘${HOURS}å°æ—¶)"

# è¿æ¥ç»Ÿè®¡
echo "=== è¿æ¥ç»Ÿè®¡ ==="
journalctl -u "$SOCKET_NAME" --since "${HOURS} hours ago" | \
    grep -E "connection|accept|connect" | \
    awk '{print $3}' | sort | uniq -c | sort -nr

# IPåœ°å€ç»Ÿè®¡
echo "=== æ¥æºIPç»Ÿè®¡ ==="
journalctl -u "$SOCKET_NAME" --since "${HOURS} hours ago" | \
    grep -oE '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | \
    sort | uniq -c | sort -nr | head -10

# é”™è¯¯ç»Ÿè®¡
echo "=== é”™è¯¯ç»Ÿè®¡ ==="
journalctl -u "$SOCKET_NAME" --since "${HOURS} hours ago" -p err | wc -l
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ socketæ¿€æ´»åŸç†ï¼šç›‘å¬socketä¸æœåŠ¡åˆ†ç¦»ï¼ŒæŒ‰éœ€å¯åŠ¨æœåŠ¡
ğŸ”¸ é…ç½®æ–‡ä»¶å…³ç³»ï¼š.socketæ–‡ä»¶ç›‘å¬ï¼Œ.serviceæ–‡ä»¶å¤„ç†
ğŸ”¸ æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ï¼šsystemdå°†socketä¼ ç»™æœåŠ¡è¿›ç¨‹
ğŸ”¸ Acceptæ¨¡å¼åŒºåˆ«ï¼šfalse=å•æœåŠ¡å¤šè¿æ¥ï¼Œtrue=å¤šæœåŠ¡å¤šè¿æ¥
ğŸ”¸ å¥—æ¥å­—ç±»å‹ï¼šTCPã€UDPã€Unix Socketã€FIFOå„æœ‰ç”¨é€”
```

### 9.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ socketå•å…ƒé…ç½®æ ¸å¿ƒ**
```ini
# æœ€å°åŒ–é…ç½®
[Socket]
ListenStream=ç«¯å£
Accept=false
Service=æœåŠ¡å.service

[Install]
WantedBy=sockets.target
```

**ğŸ”¹ æœåŠ¡é€‚é…è¦ç‚¹**
```
âœ… ç¨‹åºæ”¯æŒæ–‡ä»¶æè¿°ç¬¦ä¼ é€’
âœ… æ­£ç¡®è¯»å–LISTEN_FDSç¯å¢ƒå˜é‡  
âœ… StandardInput=socketé…ç½®
âœ… ä¸åœ¨[Install]ä¸­è®¾ç½®WantedBy
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ é€‚ç”¨åœºæ™¯**
- **ä½é¢‘æœåŠ¡**ï¼šå¶å°”ä½¿ç”¨çš„æœåŠ¡ï¼Œå¦‚FTPã€Telnet
- **èµ„æºå—é™ç¯å¢ƒ**ï¼šå†…å­˜æˆ–CPUæœ‰é™çš„ç³»ç»Ÿ
- **å¿«é€Ÿå¯åŠ¨éœ€æ±‚**ï¼šéœ€è¦å¿«é€Ÿç³»ç»Ÿå¯åŠ¨æ—¶é—´
- **é›¶åœæœºæ›´æ–°**ï¼šæœåŠ¡æ›´æ–°æ—¶ä¿æŒè¿æ¥ä¸æ–­

**ğŸ”§ ä¸é€‚ç”¨åœºæ™¯**
- **é«˜é¢‘è®¿é—®æœåŠ¡**ï¼šå¦‚ç¹å¿™çš„WebæœåŠ¡å™¨
- **æœ‰çŠ¶æ€æœåŠ¡**ï¼šéœ€è¦ä¿æŒé•¿æœŸçŠ¶æ€çš„æœåŠ¡
- **å¯åŠ¨æ—¶é—´æ•æ„Ÿ**ï¼šæœåŠ¡å¯åŠ¨å¾ˆæ…¢çš„åº”ç”¨

### 9.4 å®è·µå»ºè®®


**ğŸš€ éƒ¨ç½²å»ºè®®**
```
1. å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯socketæ¿€æ´»åŠŸèƒ½
2. ç›‘æ§æœåŠ¡å¯åŠ¨æ—¶é—´ï¼Œç¡®ä¿ç”¨æˆ·ä½“éªŒ
3. é…ç½®é€‚å½“çš„è¿æ¥é™åˆ¶å’Œè¶…æ—¶
4. å®æ–½å®‰å…¨æ§åˆ¶å’Œç›‘æ§
5. å‡†å¤‡å›é€€æ–¹æ¡ˆï¼ˆä¼ ç»Ÿå¯åŠ¨æ–¹å¼ï¼‰
```

**ğŸ“Š æ€§èƒ½è°ƒä¼˜**
```
â€¢ MaxConnections: æ ¹æ®å¹¶å‘éœ€æ±‚è°ƒæ•´
â€¢ è¶…æ—¶è®¾ç½®: å¹³è¡¡èµ„æºä½¿ç”¨å’Œç”¨æˆ·ä½“éªŒ
â€¢ ç¼“å†²åŒºå¤§å°: æ ¹æ®æ•°æ®ä¼ è¾“ç‰¹ç‚¹ä¼˜åŒ–
â€¢ æ—¥å¿—çº§åˆ«: å¹³è¡¡è°ƒè¯•éœ€æ±‚å’Œæ€§èƒ½å½±å“
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- socketæ¿€æ´»çœèµ„æºï¼ŒæŒ‰éœ€å¯åŠ¨æ›´é«˜æ•ˆ
- é…ç½®åˆ†ç¦»socketæœåŠ¡ï¼Œæ–‡ä»¶æè¿°ç¬¦æ¥ä¼ é€’
- Acceptæ¨¡å¼è¦é€‰å¯¹ï¼Œå®‰å…¨ç›‘æ§ä¸èƒ½å°‘
- é€‚åˆä½é¢‘å°æœåŠ¡ï¼Œé«˜é¢‘æœåŠ¡éœ€æ…é‡

**ğŸ¯ æŒæ¡socketæ¿€æ´»æœºåˆ¶ï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡Linuxç³»ç»Ÿçš„èµ„æºåˆ©ç”¨ç‡å’Œå¯åŠ¨æ€§èƒ½ï¼Œæ˜¯ç°ä»£ç³»ç»Ÿç®¡ç†çš„é‡è¦æŠ€èƒ½ï¼**