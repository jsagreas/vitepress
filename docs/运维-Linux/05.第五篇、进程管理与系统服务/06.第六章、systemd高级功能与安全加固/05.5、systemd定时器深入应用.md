---
title: 5ã€systemdå®šæ—¶å™¨æ·±å…¥åº”ç”¨
---
## ğŸ“š ç›®å½•

1. [systemdå®šæ—¶å™¨æ¦‚è¿°](#1-systemdå®šæ—¶å™¨æ¦‚è¿°)
2. [timerå•å…ƒæ–‡ä»¶é…ç½®è¯¦è§£](#2-timerå•å…ƒæ–‡ä»¶é…ç½®è¯¦è§£)
3. [æ—¶é—´è¡¨è¾¾å¼è¯­æ³•æ·±å…¥](#3-æ—¶é—´è¡¨è¾¾å¼è¯­æ³•æ·±å…¥)
4. [å®šæ—¶å™¨ç±»å‹ä¸ç‰¹æ€§](#4-å®šæ—¶å™¨ç±»å‹ä¸ç‰¹æ€§)
5. [timerä¸serviceé…åˆæœºåˆ¶](#5-timerä¸serviceé…åˆæœºåˆ¶)
6. [å®šæ—¶å™¨ç›‘æ§ä¸è°ƒè¯•](#6-å®šæ—¶å™¨ç›‘æ§ä¸è°ƒè¯•)
7. [systemd vs cronå¯¹æ¯”](#7-systemd-vs-cronå¯¹æ¯”)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. â° systemdå®šæ—¶å™¨æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯systemdå®šæ—¶å™¨


**ç®€å•ç†è§£**ï¼šsystemdå®šæ—¶å™¨å°±æ˜¯Linuxç³»ç»Ÿä¸­çš„"é—¹é’Ÿ"ï¼Œå¯ä»¥è®©ç³»ç»Ÿåœ¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨æ‰§è¡Œä»»åŠ¡ã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
å®šæ—¶å™¨ = æ‰‹æœºé—¹é’Ÿ
- è®¾å®šæ—¶é—´ï¼šä»€ä¹ˆæ—¶å€™å“
- æ‰§è¡ŒåŠ¨ä½œï¼šå“äº†åšä»€ä¹ˆäº‹
- é‡å¤æ¨¡å¼ï¼šæ¯å¤©å“è¿˜æ˜¯åªå“ä¸€æ¬¡

systemdå®šæ—¶å™¨ï¼š
- è®¾å®šæ—¶é—´ï¼šOnCalendaré…ç½®
- æ‰§è¡ŒåŠ¨ä½œï¼šå¯åŠ¨å¯¹åº”çš„service
- é‡å¤æ¨¡å¼ï¼šæ”¯æŒå¤æ‚çš„é‡å¤è§„åˆ™
```

### 1.2 ä¸ºä»€ä¹ˆè¦ç”¨systemdå®šæ—¶å™¨


**ä¼ ç»Ÿcronçš„é—®é¢˜**ï¼š
```
âŒ cronçš„å±€é™æ€§ï¼š
- é…ç½®è¯­æ³•å¤æ‚éš¾è®°
- é”™è¿‡æ‰§è¡Œæ—¶é—´å°±è·³è¿‡ï¼ˆå¦‚å…³æœºæ—¶ï¼‰
- æ²¡æœ‰æ—¥å¿—è®°å½•åŠŸèƒ½
- æ— æ³•åˆ©ç”¨systemdçš„æœåŠ¡ç®¡ç†èƒ½åŠ›
- ä¾èµ–å…³ç³»ç®¡ç†å›°éš¾

âœ… systemdå®šæ—¶å™¨çš„ä¼˜åŠ¿ï¼š
- è¯­æ³•æ›´ç›´è§‚æ˜“æ‡‚
- æ”¯æŒé”™è¿‡æ—¶é—´çš„è¡¥å¿æ‰§è¡Œ
- å®Œæ•´çš„æ—¥å¿—è®°å½•
- ä¸systemdç”Ÿæ€å®Œç¾é›†æˆ
- å¼ºå¤§çš„ä¾èµ–å…³ç³»ç®¡ç†
- æ›´å¥½çš„èµ„æºæ§åˆ¶
```

### 1.3 å®šæ—¶å™¨çš„å·¥ä½œåŸç†


**å·¥ä½œæœºåˆ¶**ï¼š
```
å®šæ—¶å™¨å·¥ä½œæµç¨‹ï¼š
1. è¯»å–timerå•å…ƒæ–‡ä»¶é…ç½®
2. è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
3. ç­‰å¾…æ—¶é—´åˆ°è¾¾
4. è§¦å‘å¯¹åº”çš„serviceå•å…ƒ
5. serviceæ‰§è¡Œå®Œæ¯•åé‡æ–°è®¡ç®—ä¸‹æ¬¡æ—¶é—´

æ ¸å¿ƒç»„ä»¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è§¦å‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  timerå•å…ƒ  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ serviceå•å…ƒ â”‚
â”‚ (æ—¶é—´æ§åˆ¶)   â”‚           â”‚ (å®é™…ä»»åŠ¡)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ“ timerå•å…ƒæ–‡ä»¶é…ç½®è¯¦è§£


### 2.1 timerå•å…ƒæ–‡ä»¶ç»“æ„


**åŸºæœ¬ç»“æ„**ï¼š
```ini
# backup.timer æ–‡ä»¶ç¤ºä¾‹
[Unit]
Description=æ¯æ—¥å¤‡ä»½å®šæ—¶å™¨
Requires=backup.service

[Timer]
OnCalendar=daily
Persistent=true
RandomizedDelaySec=30min

[Install]
WantedBy=timers.target
```

### 2.2 æ ¸å¿ƒé…ç½®å‚æ•°è¯¦è§£


#### OnCalendar - æ—¥å†å®šæ—¶


**ä½œç”¨**ï¼šè®¾ç½®åŸºäºæ—¥å†æ—¶é—´çš„è§¦å‘è§„åˆ™

```ini
# åŸºæœ¬æ—¶é—´æ ¼å¼
OnCalendar=Mon..Fri 09:00    # å‘¨ä¸€åˆ°å‘¨äº”ä¸Šåˆ9ç‚¹
OnCalendar=daily             # æ¯å¤©åˆå¤œ12ç‚¹
OnCalendar=weekly            # æ¯å‘¨æ—¥åˆå¤œ12ç‚¹
OnCalendar=monthly           # æ¯æœˆ1æ—¥åˆå¤œ12ç‚¹

# å¤æ‚æ—¶é—´è¡¨è¾¾å¼
OnCalendar=Mon,Wed,Fri 14:30         # å‘¨ä¸€ä¸‰äº”ä¸‹åˆ2:30
OnCalendar=2024-*-* 08:00:00         # 2024å¹´æ¯å¤©ä¸Šåˆ8ç‚¹
OnCalendar=*-*-01 02:00              # æ¯æœˆ1æ—¥å‡Œæ™¨2ç‚¹
OnCalendar=Sat *-*-* 03:00:00        # æ¯å‘¨å…­å‡Œæ™¨3ç‚¹
```

> ğŸ’¡ **ç†è§£æŠ€å·§**ï¼šOnCalendarå°±åƒè®¾ç½®æ‰‹æœºé—¹é’Ÿï¼Œå¯ä»¥è®¾ç½®å…·ä½“æ—¶é—´ã€é‡å¤æ¨¡å¼ç­‰

#### OnBootSec - å¼€æœºåå®šæ—¶


**ä½œç”¨**ï¼šç³»ç»Ÿå¯åŠ¨åå¤šé•¿æ—¶é—´è§¦å‘

```ini
OnBootSec=15min          # å¼€æœºå15åˆ†é’Ÿæ‰§è¡Œ
OnBootSec=1h 30min       # å¼€æœºå1.5å°æ—¶æ‰§è¡Œ
OnBootSec=2h             # å¼€æœºå2å°æ—¶æ‰§è¡Œ
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç³»ç»Ÿå¯åŠ¨åçš„åˆå§‹åŒ–ä»»åŠ¡
- éœ€è¦ç­‰å¾…ç³»ç»Ÿç¨³å®šåæ‰§è¡Œçš„æ“ä½œ
- å»¶è¿Ÿå¯åŠ¨çš„æœåŠ¡

#### OnUnitActiveSec - æœåŠ¡æ¿€æ´»åå®šæ—¶


**ä½œç”¨**ï¼šä¸Šæ¬¡æœåŠ¡æ‰§è¡Œå®Œæ¯•åå¤šé•¿æ—¶é—´å†æ¬¡è§¦å‘

```ini
OnUnitActiveSec=1h       # æœåŠ¡å®Œæˆå1å°æ—¶å†æ‰§è¡Œ
OnUnitActiveSec=30min    # æœåŠ¡å®Œæˆå30åˆ†é’Ÿå†æ‰§è¡Œ
```

**å…¸å‹åº”ç”¨**ï¼š
- å‘¨æœŸæ€§ç›‘æ§ä»»åŠ¡
- æ•°æ®åŒæ­¥ä»»åŠ¡
- å®šæœŸæ¸…ç†ä»»åŠ¡

### 2.3 é«˜çº§é…ç½®é€‰é¡¹


#### Persistent - æŒä¹…åŒ–æ‰§è¡Œ


```ini
Persistent=true          # é”™è¿‡çš„æ‰§è¡Œæ—¶é—´ä¼šè¡¥å¿æ‰§è¡Œ
Persistent=false         # é”™è¿‡å°±è·³è¿‡ï¼ˆé»˜è®¤å€¼ï¼‰
```

**å®é™…åœºæ™¯**ï¼š
```
åœºæ™¯ï¼šæ¯æ—¥å‡Œæ™¨2ç‚¹å¤‡ä»½æ•°æ®
- Persistent=falseï¼šå¦‚æœ2ç‚¹æ—¶å…³æœºï¼Œå°±è·³è¿‡è¿™æ¬¡å¤‡ä»½
- Persistent=trueï¼šå¼€æœºåä¼šç«‹å³æ‰§è¡Œé”™è¿‡çš„å¤‡ä»½ä»»åŠ¡
```

#### RandomizedDelaySec - éšæœºå»¶è¿Ÿ


```ini
RandomizedDelaySec=30min    # åœ¨è§¦å‘æ—¶é—´åŸºç¡€ä¸Šéšæœºå»¶è¿Ÿ0-30åˆ†é’Ÿ
RandomizedDelaySec=1h       # éšæœºå»¶è¿Ÿ0-60åˆ†é’Ÿ
```

**ç”¨é€”**ï¼š
- é¿å…å¤šä¸ªå®šæ—¶å™¨åŒæ—¶æ‰§è¡Œé€ æˆç³»ç»Ÿè´Ÿè½½è¿‡é«˜
- åˆ†æ•£ç½‘ç»œè¯·æ±‚é¿å…æœåŠ¡å™¨å‹åŠ›
- å¢åŠ æ‰§è¡Œæ—¶é—´çš„ä¸å¯é¢„æµ‹æ€§

### 2.4 å®Œæ•´é…ç½®ç¤ºä¾‹


**ç³»ç»Ÿç»´æŠ¤å®šæ—¶å™¨**ï¼š
```ini
# system-maintenance.timer
[Unit]
Description=ç³»ç»Ÿç»´æŠ¤å®šæ—¶å™¨
Documentation=https://example.com/maintenance-docs

[Timer]
# æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹æ‰§è¡Œ
OnCalendar=Sun 03:00:00
# é”™è¿‡æ—¶é—´ä¼šè¡¥å¿æ‰§è¡Œ
Persistent=true
# éšæœºå»¶è¿Ÿ0-15åˆ†é’Ÿï¼Œé¿å…ä¸å…¶ä»–ä»»åŠ¡å†²çª
RandomizedDelaySec=15min
# æ‰§è¡Œç²¾åº¦ä¸º1åˆ†é’Ÿï¼ˆé»˜è®¤1åˆ†é’Ÿï¼‰
AccuracySec=1min

[Install]
WantedBy=timers.target
```

---

## 3. ğŸ• æ—¶é—´è¡¨è¾¾å¼è¯­æ³•æ·±å…¥


### 3.1 æ—¶é—´æ ¼å¼åŸºç¡€


**æ ‡å‡†æ ¼å¼**ï¼š
```
æ ¼å¼ï¼šæ˜ŸæœŸ å¹´-æœˆ-æ—¥ æ—¶:åˆ†:ç§’
ç¤ºä¾‹ï¼šMon 2024-01-15 14:30:00

ç®€åŒ–æ ¼å¼ï¼š
- åªæœ‰æ—¶é—´ï¼š14:30:00
- æ—¥æœŸ+æ—¶é—´ï¼š2024-01-15 14:30
- æ˜ŸæœŸ+æ—¶é—´ï¼šMon 14:30
```

### 3.2 é€šé…ç¬¦ä¸èŒƒå›´è¡¨ç¤º


**é€šé…ç¬¦ä½¿ç”¨**ï¼š
```ini
# * è¡¨ç¤ºä»»æ„å€¼
OnCalendar=*-*-* 09:00:00        # æ¯å¤©ä¸Šåˆ9ç‚¹
OnCalendar=*-01-01 00:00:00      # æ¯å¹´1æœˆ1æ—¥åˆå¤œ

# èŒƒå›´è¡¨ç¤º
OnCalendar=Mon..Fri 09:00        # å‘¨ä¸€åˆ°å‘¨äº”
OnCalendar=*-01..03-* 12:00      # 1æœˆåˆ°3æœˆæ¯å¤©ä¸­åˆ
OnCalendar=*-*-01..07 08:00      # æ¯æœˆ1-7æ—¥ä¸Šåˆ8ç‚¹
```

**æ­¥è¿›å€¼è¡¨ç¤º**ï¼š
```ini
# /æ­¥è¿›å€¼ è¡¨ç¤ºé—´éš”
OnCalendar=*:0/15                # æ¯15åˆ†é’Ÿï¼ˆ0,15,30,45åˆ†ï¼‰
OnCalendar=*-*-*/2 12:00         # æ¯éš”ä¸€å¤©çš„ä¸­åˆ12ç‚¹
OnCalendar=*/10:00               # æ¯10åˆ†é’Ÿçš„æ•´ç‚¹
```

### 3.3 é¢„å®šä¹‰æ—¶é—´å…³é”®å­—


```ini
# å¸¸ç”¨é¢„å®šä¹‰å…³é”®å­—
OnCalendar=minutely      # æ¯åˆ†é’Ÿï¼ˆ*:*:00ï¼‰
OnCalendar=hourly        # æ¯å°æ—¶ï¼ˆ*:00:00ï¼‰
OnCalendar=daily         # æ¯å¤©ï¼ˆ00:00:00ï¼‰
OnCalendar=monthly       # æ¯æœˆ1æ—¥ï¼ˆ*-*-01 00:00:00ï¼‰
OnCalendar=weekly        # æ¯å‘¨æ—¥ï¼ˆSun 00:00:00ï¼‰
OnCalendar=yearly        # æ¯å¹´1æœˆ1æ—¥ï¼ˆ*-01-01 00:00:00ï¼‰
OnCalendar=quarterly     # æ¯å­£åº¦ï¼ˆ*-01,04,07,10-01 00:00:00ï¼‰
OnCalendar=semiannually  # æ¯åŠå¹´ï¼ˆ*-01,07-01 00:00:00ï¼‰
```

### 3.4 å¤æ‚æ—¶é—´è¡¨è¾¾å¼ç¤ºä¾‹


**ä¸šåŠ¡åœºæ™¯æ—¶é—´è®¾ç½®**ï¼š
```ini
# å·¥ä½œæ—¥æ—©æ™¨æŠ¥å‘Š
OnCalendar=Mon..Fri 08:30

# æœˆæœ«å¤‡ä»½ï¼ˆæ¯æœˆæœ€åä¸€å¤©ï¼‰
OnCalendar=*-*~01 23:00

# å­£åº¦æŠ¥å‘Šï¼ˆæ¯å­£åº¦ç¬¬ä¸€å¤©ï¼‰
OnCalendar=*-01,04,07,10-01 09:00

# è¥ä¸šæ—¶é—´å†…æ¯2å°æ—¶æ£€æŸ¥
OnCalendar=Mon..Fri 09,11,13,15,17:00

# å‘¨æœ«ç»´æŠ¤çª—å£
OnCalendar=Sat,Sun 02:00..06:00
```

**æ—¶é—´éªŒè¯å‘½ä»¤**ï¼š
```bash
# éªŒè¯æ—¶é—´è¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®
systemd-analyze calendar "Mon..Fri 09:00"
systemd-analyze calendar "monthly"
systemd-analyze calendar "*-*-*/2 12:00"
```

---

## 4. ğŸ”„ å®šæ—¶å™¨ç±»å‹ä¸ç‰¹æ€§


### 4.1 å•è°ƒå®šæ—¶å™¨ï¼ˆMonotonic Timerï¼‰


**ç‰¹ç‚¹**ï¼šåŸºäºç³»ç»Ÿè¿è¡Œæ—¶é—´æˆ–äº‹ä»¶è§¦å‘ï¼Œä¸å—ç³»ç»Ÿæ—¶é—´æ›´æ”¹å½±å“

```ini
# ç³»ç»Ÿå¯åŠ¨åå®šæ—¶å™¨
OnBootSec=30min              # å¯åŠ¨å30åˆ†é’Ÿ

# ç³»ç»Ÿæ´»è·ƒåå®šæ—¶å™¨  
OnStartupSec=1h              # systemdå¯åŠ¨å1å°æ—¶

# å•å…ƒæ¿€æ´»åå®šæ—¶å™¨
OnUnitActiveSec=2h           # æœåŠ¡å®Œæˆå2å°æ—¶

# å•å…ƒåœç”¨åå®šæ—¶å™¨
OnUnitInactiveSec=10min      # æœåŠ¡åœæ­¢å10åˆ†é’Ÿ
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ğŸ”¸ **ç³»ç»Ÿåˆå§‹åŒ–**ï¼šå¼€æœºåéœ€è¦å»¶è¿Ÿæ‰§è¡Œçš„ä»»åŠ¡
- ğŸ”¸ **å‘¨æœŸæ€§ä»»åŠ¡**ï¼šå›ºå®šé—´éš”æ‰§è¡Œçš„ç›‘æ§ã€æ¸…ç†ç­‰
- ğŸ”¸ **ä¾èµ–ç­‰å¾…**ï¼šç­‰å¾…å…¶ä»–æœåŠ¡å¯åŠ¨å®Œæˆ

### 4.2 å®æ—¶å®šæ—¶å™¨ï¼ˆRealtime Timerï¼‰


**ç‰¹ç‚¹**ï¼šåŸºäºå®é™…æ—¶é—´ï¼ˆæ—¥å†æ—¶é—´ï¼‰ï¼Œå—ç³»ç»Ÿæ—¶é—´æ›´æ”¹å½±å“

```ini
# æ—¥å†æ—¶é—´å®šæ—¶å™¨
OnCalendar=daily             # æ¯æ—¥æ‰§è¡Œ
OnCalendar=Mon 09:00         # æ¯å‘¨ä¸€9ç‚¹
OnCalendar=*-*-01 02:00      # æ¯æœˆ1æ—¥å‡Œæ™¨2ç‚¹
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ğŸ”¸ **å®šæœŸå¤‡ä»½**ï¼šæ¯æ—¥ã€æ¯å‘¨ã€æ¯æœˆçš„æ•°æ®å¤‡ä»½
- ğŸ”¸ **æŠ¥å‘Šç”Ÿæˆ**ï¼šæŒ‰æ—¥å†å‘¨æœŸç”Ÿæˆä¸šåŠ¡æŠ¥å‘Š
- ğŸ”¸ **ç³»ç»Ÿç»´æŠ¤**ï¼šå®šæœŸçš„ç³»ç»Ÿæ¸…ç†ã€æ›´æ–°ç­‰

### 4.3 æŒä¹…åŒ–ç‰¹æ€§è¯¦è§£


**Persistent=trueçš„å·¥ä½œæœºåˆ¶**ï¼š
```
åœºæ™¯ç¤ºä¾‹ï¼š
è®¾ç½®ï¼šOnCalendar=daily, Persistent=true
æ­£å¸¸æƒ…å†µï¼šæ¯å¤©00:00æ‰§è¡Œ
å¼‚å¸¸æƒ…å†µï¼šæŸå¤©å…³æœºï¼Œé”™è¿‡äº†00:00

Persistent=falseï¼šè·³è¿‡é”™è¿‡çš„æ‰§è¡Œ
Persistent=trueï¼šå¼€æœºåç«‹å³è¡¥å¿æ‰§è¡Œ

å®é™…åº”ç”¨ï¼š
âœ… æ•°æ®å¤‡ä»½ï¼šå¿…é¡»æ‰§è¡Œï¼Œä¸èƒ½è·³è¿‡
âœ… æ—¥å¿—è½®è½¬ï¼šå¿…é¡»å¤„ç†ç§¯ç´¯çš„æ—¥å¿—
âŒ å‘é€æŠ¥å‘Šï¼šé”™è¿‡æ—¶é—´å°±æ²¡æ„ä¹‰äº†
```

### 4.4 ç²¾åº¦æ§åˆ¶


**AccuracySecé…ç½®**ï¼š
```ini
# æ‰§è¡Œç²¾åº¦è®¾ç½®
AccuracySec=1s          # 1ç§’ç²¾åº¦ï¼ˆé«˜ç²¾åº¦ï¼‰
AccuracySec=1min        # 1åˆ†é’Ÿç²¾åº¦ï¼ˆé»˜è®¤å€¼ï¼‰
AccuracySec=1h          # 1å°æ—¶ç²¾åº¦ï¼ˆä½ç²¾åº¦ï¼‰
```

**ç²¾åº¦å¯¹æ€§èƒ½çš„å½±å“**ï¼š
```
é«˜ç²¾åº¦ï¼ˆ1ç§’ï¼‰ï¼š
âœ… æ‰§è¡Œæ—¶é—´å‡†ç¡®
âŒ ç³»ç»Ÿå¼€é”€å¤§ï¼Œé¢‘ç¹å”¤é†’

ä½ç²¾åº¦ï¼ˆ1å°æ—¶ï¼‰ï¼š
âœ… ç³»ç»Ÿå¼€é”€å°ï¼Œçœç”µ
âŒ æ‰§è¡Œæ—¶é—´å¯èƒ½åå·®è¾ƒå¤§

é€‰æ‹©åŸåˆ™ï¼š
- å¯¹æ—¶é—´æ•æ„Ÿçš„ä»»åŠ¡ï¼šé«˜ç²¾åº¦
- ä¸€èˆ¬ç»´æŠ¤ä»»åŠ¡ï¼šé»˜è®¤ç²¾åº¦
- ä¸ç´§æ€¥çš„æ¸…ç†ä»»åŠ¡ï¼šä½ç²¾åº¦
```

---

## 5. ğŸ”— timerä¸serviceé…åˆæœºåˆ¶


### 5.1 é…å¯¹å…³ç³»è§„åˆ™


**è‡ªåŠ¨é…å¯¹è§„åˆ™**ï¼š
```
å‘½åè§„åˆ™ï¼š
backup.timer  â†â†’  backup.service
cleanup.timer â†â†’  cleanup.service

å¦‚æœserviceåç§°ä¸åŒï¼Œéœ€è¦æ˜ç¡®æŒ‡å®šï¼š
[Unit]
Triggers=custom-backup.service
```

### 5.2 å®Œæ•´é…å¯¹ç¤ºä¾‹


**å®šæ—¶å™¨æ–‡ä»¶ï¼ˆbackup.timerï¼‰**ï¼š
```ini
[Unit]
Description=æ•°æ®å¤‡ä»½å®šæ—¶å™¨
Documentation=man:backup(8)
Requires=backup.service

[Timer]
# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
OnCalendar=02:00
# é”™è¿‡æ—¶é—´ä¼šè¡¥å¿æ‰§è¡Œ
Persistent=true
# éšæœºå»¶è¿Ÿ0-30åˆ†é’Ÿ
RandomizedDelaySec=30min

[Install]
WantedBy=timers.target
```

**æœåŠ¡æ–‡ä»¶ï¼ˆbackup.serviceï¼‰**ï¼š
```ini
[Unit]
Description=æ•°æ®å¤‡ä»½æœåŠ¡
Documentation=man:backup(8)
Wants=network-online.target
After=network-online.target

[Service]
Type=oneshot
User=backup
Group=backup
ExecStart=/usr/local/bin/backup-script.sh
StandardOutput=journal
StandardError=journal

# èµ„æºé™åˆ¶
MemoryMax=1G
CPUQuota=50%

# ç¯å¢ƒå˜é‡
Environment=BACKUP_TARGET=/backup/daily
EnvironmentFile=-/etc/default/backup
```

### 5.3 ä¾èµ–å…³ç³»é…ç½®


**å¸¸è§ä¾èµ–é…ç½®**ï¼š
```ini
[Unit]
# è¦æ±‚network-onlineå¯ç”¨
Wants=network-online.target
After=network-online.target

# è¦æ±‚æ•°æ®åº“æœåŠ¡è¿è¡Œ
Wants=postgresql.service
After=postgresql.service

# ä¸å…¶ä»–å®šæ—¶å™¨äº’æ–¥
Conflicts=maintenance.timer
```

### 5.4 å®é™…è„šæœ¬ç¤ºä¾‹


**å¤‡ä»½è„šæœ¬ï¼ˆ/usr/local/bin/backup-script.shï¼‰**ï¼š
```bash
#!/bin/bash
# æ•°æ®å¤‡ä»½è„šæœ¬

# æ—¥å¿—è®°å½•å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >&2
}

# å¤‡ä»½é…ç½®
BACKUP_SOURCE="/important/data"
BACKUP_TARGET="${BACKUP_TARGET:-/backup/daily}"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_TARGET"

log "å¼€å§‹å¤‡ä»½æ•°æ®ä» $BACKUP_SOURCE åˆ° $BACKUP_TARGET"

# æ‰§è¡Œå¤‡ä»½ï¼ˆä½¿ç”¨tarå‹ç¼©ï¼‰
if tar -czf "$BACKUP_TARGET/backup_$DATE.tar.gz" -C "$BACKUP_SOURCE" .; then
    log "å¤‡ä»½æˆåŠŸå®Œæˆï¼šbackup_$DATE.tar.gz"
    
    # æ¸…ç†7å¤©å‰çš„å¤‡ä»½
    find "$BACKUP_TARGET" -name "backup_*.tar.gz" -mtime +7 -delete
    log "æ¸…ç†äº†7å¤©å‰çš„æ—§å¤‡ä»½æ–‡ä»¶"
else
    log "å¤‡ä»½å¤±è´¥ï¼Œé€€å‡ºç ï¼š$?"
    exit 1
fi
```

---

## 6. ğŸ“Š å®šæ—¶å™¨ç›‘æ§ä¸è°ƒè¯•


### 6.1 æŸ¥çœ‹å®šæ—¶å™¨çŠ¶æ€


**åŸºæœ¬æŸ¥çœ‹å‘½ä»¤**ï¼š
```bash
# æŸ¥çœ‹æ‰€æœ‰å®šæ—¶å™¨çŠ¶æ€
systemctl list-timers

# æŸ¥çœ‹æ´»è·ƒçš„å®šæ—¶å™¨
systemctl list-timers --active

# æŸ¥çœ‹æ‰€æœ‰å®šæ—¶å™¨ï¼ˆåŒ…æ‹¬æœªæ¿€æ´»çš„ï¼‰
systemctl list-timers --all
```

**è¾“å‡ºè§£è¯»**ï¼š
```
NEXT                         LEFT          LAST                         PASSED       UNIT                         ACTIVATES
Sun 2024-09-15 02:00:00 CST  11h left      Sat 2024-09-14 02:00:00 CST  12h ago      backup.timer                 backup.service
Sun 2024-09-15 03:00:00 CST  12h left      Sat 2024-09-14 03:00:00 CST  11h ago      maintenance.timer            maintenance.service

å­—æ®µè¯´æ˜ï¼š
- NEXTï¼šä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
- LEFTï¼šè·ç¦»ä¸‹æ¬¡æ‰§è¡Œè¿˜æœ‰å¤šä¹…
- LASTï¼šä¸Šæ¬¡æ‰§è¡Œæ—¶é—´  
- PASSEDï¼šè·ç¦»ä¸Šæ¬¡æ‰§è¡Œè¿‡äº†å¤šä¹…
- UNITï¼šå®šæ—¶å™¨å•å…ƒå
- ACTIVATESï¼šè§¦å‘çš„æœåŠ¡å•å…ƒå
```

### 6.2 è¯¦ç»†çŠ¶æ€æŸ¥è¯¢


**æŸ¥çœ‹ç‰¹å®šå®šæ—¶å™¨è¯¦æƒ…**ï¼š
```bash
# æŸ¥çœ‹å®šæ—¶å™¨è¯¦ç»†çŠ¶æ€
systemctl status backup.timer

# æŸ¥çœ‹å®šæ—¶å™¨é…ç½®
systemctl show backup.timer

# æŸ¥çœ‹å®šæ—¶å™¨å±æ€§
systemctl show backup.timer --property=NextElapseUSecMonotonic,NextElapseUSecRealtime
```

### 6.3 æ—¥å¿—åˆ†æ


**æŸ¥çœ‹å®šæ—¶å™¨æ—¥å¿—**ï¼š
```bash
# æŸ¥çœ‹å®šæ—¶å™¨ç›¸å…³æ—¥å¿—
journalctl -u backup.timer

# æŸ¥çœ‹æœåŠ¡æ‰§è¡Œæ—¥å¿—
journalctl -u backup.service

# å®æ—¶ç›‘æ§æ—¥å¿—
journalctl -u backup.timer -f

# æŸ¥çœ‹æœ€è¿‘çš„æ‰§è¡Œè®°å½•
journalctl -u backup.service --since "1 week ago"
```

**æ—¥å¿—åˆ†ææŠ€å·§**ï¼š
```bash
# æŸ¥çœ‹å®šæ—¶å™¨å¯åŠ¨å’Œè§¦å‘è®°å½•
journalctl -u backup.timer | grep -E "(Started|Triggered)"

# æŸ¥çœ‹æœåŠ¡æ‰§è¡ŒæˆåŠŸ/å¤±è´¥è®°å½•  
journalctl -u backup.service | grep -E "(Succeeded|Failed)"

# åˆ†ææ‰§è¡Œæ—¶é—´ç»Ÿè®¡
journalctl -u backup.service --output=json | jq '.MESSAGE'
```

### 6.4 è°ƒè¯•æŠ€å·§


#### æ‰‹åŠ¨æµ‹è¯•å®šæ—¶å™¨


```bash
# ç«‹å³è§¦å‘å®šæ—¶å™¨ï¼ˆä¸ç­‰å¾…æ—¶é—´ï¼‰
sudo systemctl start backup.timer

# æ‰‹åŠ¨å¯åŠ¨å¯¹åº”çš„æœåŠ¡
sudo systemctl start backup.service

# éªŒè¯æ—¶é—´è¡¨è¾¾å¼
systemd-analyze calendar "Mon..Fri 09:00"
```

#### å¸¸è§é—®é¢˜æ’æŸ¥


```bash
# 1. å®šæ—¶å™¨æœªæ¿€æ´»
systemctl is-enabled backup.timer
systemctl enable backup.timer

# 2. æœåŠ¡æ‰§è¡Œå¤±è´¥
journalctl -u backup.service -p err

# 3. æ—¶é—´è¡¨è¾¾å¼é”™è¯¯
systemd-analyze calendar "ä½ çš„æ—¶é—´è¡¨è¾¾å¼"

# 4. æƒé™é—®é¢˜
ls -la /usr/local/bin/backup-script.sh
systemctl show backup.service -p User,Group
```

### 6.5 æ€§èƒ½ç›‘æ§


**ç›‘æ§æŒ‡æ ‡æ”¶é›†**ï¼š
```bash
# æŸ¥çœ‹å®šæ—¶å™¨æ‰§è¡Œç»Ÿè®¡
systemctl show backup.service -p ExecMainStartTimestamp,ExecMainExitTimestamp

# ç›‘æ§èµ„æºä½¿ç”¨
systemctl status backup.service | grep -E "(Memory|CPU)"

# æŸ¥çœ‹æ‰§è¡Œæ—¶é•¿è¶‹åŠ¿
journalctl -u backup.service --output=json | \
    jq -r '.[].SYSLOG_TIMESTAMP + " " + .[].MESSAGE' | \
    grep -E "(Started|Succeeded)"
```

---

## 7. âš”ï¸ systemd vs cronå¯¹æ¯”


### 7.1 åŠŸèƒ½å¯¹æ¯”è¡¨


| ç‰¹æ€§ | **systemdå®šæ—¶å™¨** | **cron** | **ä¼˜åŠ¿å¯¹æ¯”** |
|------|------------------|----------|-------------|
| ğŸ• **æ—¶é—´è¯­æ³•** | `ç›´è§‚æ˜“æ‡‚ï¼ˆMon..Fri 09:00ï¼‰` | `å¤æ‚éš¾è®°ï¼ˆ0 9 * * 1-5ï¼‰` | `systemdæ›´äººæ€§åŒ–` |
| ğŸ“ **æ—¥å¿—è®°å½•** | `å®Œæ•´æ—¥å¿—é›†æˆjournalctl` | `éœ€è¦æ‰‹åŠ¨é‡å®šå‘` | `systemdæ—¥å¿—æ›´å®Œå–„` |
| âš¡ **é”™è¿‡æ‰§è¡Œ** | `æ”¯æŒPersistentè¡¥å¿` | `é”™è¿‡å°±è·³è¿‡` | `systemdæ›´å¯é ` |
| ğŸ”§ **æœåŠ¡é›†æˆ** | `å®Œç¾é›†æˆsystemdç”Ÿæ€` | `ç‹¬ç«‹è¿è¡Œï¼Œé›†æˆå·®` | `systemdç”Ÿæ€æ›´å¼º` |
| ğŸ“Š **ç›‘æ§è°ƒè¯•** | `systemctlå‘½ä»¤ä¸°å¯Œ` | `ç›‘æ§å·¥å…·æœ‰é™` | `systemdå·¥å…·æ›´å…¨` |
| ğŸ›¡ï¸ **æƒé™æ§åˆ¶** | `ç²¾ç»†çš„æƒé™å’Œèµ„æºæ§åˆ¶` | `åŸºæœ¬æƒé™æ§åˆ¶` | `systemdå®‰å…¨æ€§æ›´é«˜` |
| ğŸ”„ **ä¾èµ–ç®¡ç†** | `å¼ºå¤§çš„ä¾èµ–å…³ç³»æ”¯æŒ` | `æ— ä¾èµ–ç®¡ç†` | `systemdæ›´çµæ´»` |

### 7.2 è¯­æ³•å¯¹æ¯”ç¤ºä¾‹


**ç›¸åŒä»»åŠ¡çš„ä¸åŒå†™æ³•**ï¼š

```bash
# éœ€æ±‚ï¼šæ¯å·¥ä½œæ—¥ä¸Šåˆ9ç‚¹æ‰§è¡Œå¤‡ä»½

# cronè¯­æ³•ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰
0 9 * * 1-5 /usr/local/bin/backup.sh

# systemdè¯­æ³•ï¼ˆç°ä»£æ–¹å¼ï¼‰
OnCalendar=Mon..Fri 09:00
```

```bash
# éœ€æ±‚ï¼šæ¯æœˆ1æ—¥å‡Œæ™¨2ç‚¹æ¸…ç†æ—¥å¿—

# cronè¯­æ³•
0 2 1 * * /usr/local/bin/cleanup.sh

# systemdè¯­æ³•  
OnCalendar=*-*-01 02:00
```

### 7.3 è¿ç§»æŒ‡å—


**ä»cronè¿ç§»åˆ°systemdå®šæ—¶å™¨**ï¼š

**æ­¥éª¤1ï¼šåˆ†æç°æœ‰cronä»»åŠ¡**
```bash
# æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„cronä»»åŠ¡
crontab -l

# æŸ¥çœ‹ç³»ç»Ÿçº§cronä»»åŠ¡
cat /etc/crontab
ls /etc/cron.d/
```

**æ­¥éª¤2ï¼šåˆ›å»ºå¯¹åº”çš„systemdå•å…ƒ**
```bash
# åŸcronä»»åŠ¡
# 0 2 * * * /backup/scripts/daily-backup.sh

# è½¬æ¢ä¸ºsystemd
# 1. åˆ›å»ºserviceæ–‡ä»¶
sudo tee /etc/systemd/system/daily-backup.service << EOF
[Unit]
Description=Daily backup service
[Service]
Type=oneshot
ExecStart=/backup/scripts/daily-backup.sh
User=backup
StandardOutput=journal
EOF

# 2. åˆ›å»ºtimeræ–‡ä»¶
sudo tee /etc/systemd/system/daily-backup.timer << EOF
[Unit]
Description=Daily backup timer
Requires=daily-backup.service
[Timer]
OnCalendar=02:00
Persistent=true
[Install]
WantedBy=timers.target
EOF
```

**æ­¥éª¤3ï¼šæµ‹è¯•å’Œå¯ç”¨**
```bash
# é‡æ–°åŠ è½½é…ç½®
sudo systemctl daemon-reload

# å¯ç”¨å¹¶å¯åŠ¨å®šæ—¶å™¨
sudo systemctl enable daily-backup.timer
sudo systemctl start daily-backup.timer

# éªŒè¯çŠ¶æ€
systemctl status daily-backup.timer
systemctl list-timers daily-backup.timer
```

### 7.4 ä½•æ—¶é€‰æ‹©å“ªä¸ªæ–¹æ¡ˆ


```
é€‰æ‹©systemdå®šæ—¶å™¨çš„åœºæ™¯ï¼š
âœ… ç°ä»£Linuxå‘è¡Œç‰ˆï¼ˆsystemdç³»ç»Ÿï¼‰
âœ… éœ€è¦å®Œæ•´æ—¥å¿—è®°å½•
âœ… è¦æ±‚é«˜å¯é æ€§ï¼ˆé”™è¿‡æ‰§è¡Œèƒ½è¡¥å¿ï¼‰
âœ… éœ€è¦å¤æ‚çš„ä¾èµ–å…³ç³»ç®¡ç†
âœ… è¦æ±‚ç²¾ç»†çš„æƒé™å’Œèµ„æºæ§åˆ¶
âœ… ä¸systemdæœåŠ¡æ·±åº¦é›†æˆ

ä¿ç•™cronçš„åœºæ™¯ï¼š
âœ… ä¼ ç»Ÿç³»ç»Ÿæˆ–ésystemdç¯å¢ƒ
âœ… ç®€å•çš„å®šæ—¶ä»»åŠ¡
âœ… éœ€è¦ä¸ç°æœ‰cronç”Ÿæ€å…¼å®¹
âœ… ç³»ç»Ÿç®¡ç†å‘˜æ›´ç†Ÿæ‚‰cronè¯­æ³•
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ å®šæ—¶å™¨æœ¬è´¨ï¼šsystemdçš„"é—¹é’Ÿ"åŠŸèƒ½ï¼Œåœ¨æŒ‡å®šæ—¶é—´è§¦å‘æœåŠ¡
ğŸ”¸ æ ¸å¿ƒé…ç½®ï¼šOnCalendarã€OnBootSecã€OnUnitActiveSecä¸‰å¤§æ—¶é—´è§¦å‘å™¨
ğŸ”¸ é…å¯¹æœºåˆ¶ï¼štimerå•å…ƒè§¦å‘å¯¹åº”çš„serviceå•å…ƒæ‰§è¡Œå®é™…ä»»åŠ¡
ğŸ”¸ æŒä¹…åŒ–ç‰¹æ€§ï¼šPersistent=trueå¯è¡¥å¿é”™è¿‡çš„æ‰§è¡Œæ—¶é—´
ğŸ”¸ æ—¶é—´è¯­æ³•ï¼šç›´è§‚æ˜“æ‡‚ï¼Œæ”¯æŒå¤æ‚çš„é‡å¤æ¨¡å¼å’Œæ—¶é—´è¡¨è¾¾å¼
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ—¶é—´é…ç½®çš„é€»è¾‘**
```
è®°å¿†æ–¹æ³•ï¼š
- OnCalendarï¼šæŒ‰æ—¥å†æ—¶é—´ï¼Œåƒè®¾ç½®æ‰‹æœºé—¹é’Ÿ
- OnBootSecï¼šå¼€æœºåç­‰å¾…ï¼Œåƒå¼€æœºå¯åŠ¨å»¶è¿Ÿ
- OnUnitActiveSecï¼šä»»åŠ¡å®Œæˆåé—´éš”ï¼Œåƒå·¥ä½œä¼‘æ¯å¾ªç¯

å®é™…åº”ç”¨ï¼š
- æ¯æ—¥å¤‡ä»½ â†’ OnCalendar=daily
- å¼€æœºåˆå§‹åŒ– â†’ OnBootSec=5min  
- å®šæœŸæ£€æŸ¥ â†’ OnUnitActiveSec=1h
```

**ğŸ”¹ ä¸ºä»€ä¹ˆæ¯”cronæ›´å¥½**
```
æ ¸å¿ƒä¼˜åŠ¿ï¼š
è¯­æ³•ç›´è§‚ â†’ Mon..Fri 09:00 vs 0 9 * * 1-5
æ—¥å¿—å®Œæ•´ â†’ journalctl vs éœ€è¦æ‰‹åŠ¨é‡å®šå‘  
é”™è¿‡è¡¥å¿ â†’ Persistent=true vs é”™è¿‡å°±è·³è¿‡
ç”Ÿæ€é›†æˆ â†’ systemdåŸç”Ÿ vs ç‹¬ç«‹è¿è¡Œ
```

**ğŸ”¹ ç›‘æ§è°ƒè¯•çš„æ€è·¯**
```
ç›‘æ§æµç¨‹ï¼š
1. list-timers çœ‹æ•´ä½“çŠ¶æ€
2. status çœ‹å…·ä½“å®šæ—¶å™¨è¯¦æƒ…
3. journalctl çœ‹æ‰§è¡Œæ—¥å¿—
4. æ‰‹åŠ¨æµ‹è¯•éªŒè¯åŠŸèƒ½

å…³é”®å‘½ä»¤è®°å¿†ï¼š
- çœ‹çŠ¶æ€ï¼šsystemctl list-timers
- çœ‹è¯¦æƒ…ï¼šsystemctl status xxx.timer
- çœ‹æ—¥å¿—ï¼šjournalctl -u xxx.service
- æµ‹è¯•ï¼šsystemctl start xxx.service
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ å…¸å‹ä½¿ç”¨åœºæ™¯**
- **æ•°æ®å¤‡ä»½**ï¼šæ¯æ—¥/æ¯å‘¨è‡ªåŠ¨å¤‡ä»½é‡è¦æ•°æ®
- **æ—¥å¿—æ¸…ç†**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸæ—¥å¿—æ–‡ä»¶é‡Šæ”¾ç©ºé—´
- **ç³»ç»Ÿç»´æŠ¤**ï¼šå®šæ—¶æ›´æ–°ç³»ç»Ÿã€æ¸…ç†ç¼“å­˜ç­‰
- **ç›‘æ§æ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥æœåŠ¡çŠ¶æ€ã€ç£ç›˜ä½¿ç”¨ç­‰
- **æŠ¥å‘Šç”Ÿæˆ**ï¼šæŒ‰æ—¶ç”Ÿæˆä¸šåŠ¡æŠ¥å‘Šå’Œç»Ÿè®¡æ•°æ®

**ğŸ› ï¸ è¿ç»´å®è·µæŠ€å·§**
- **å‘½åè§„èŒƒ**ï¼šä½¿ç”¨æ¸…æ™°çš„å‘½åå¦‚`backup.timer`ã€`cleanup.timer`
- **æ—¥å¿—ç®¡ç†**ï¼šåˆç†è®¾ç½®æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
- **èµ„æºæ§åˆ¶**ï¼šä¸ºæœåŠ¡è®¾ç½®å†…å­˜ã€CPUé™åˆ¶é¿å…å½±å“ç³»ç»Ÿ
- **ä¾èµ–å…³ç³»**ï¼šåˆç†é…ç½®ä¾èµ–ç¡®ä¿ç¯å¢ƒå°±ç»ªåå†æ‰§è¡Œ
- **æµ‹è¯•éªŒè¯**ï¼šä¸Šçº¿å‰å……åˆ†æµ‹è¯•æ—¶é—´è¡¨è¾¾å¼å’Œè„šæœ¬é€»è¾‘

**ğŸ¯ å­¦ä¹ å»ºè®®**
- **ä»ç®€å•å¼€å§‹**ï¼šå…ˆæŒæ¡åŸºæœ¬çš„OnCalendaré…ç½®
- **å¤šå®è·µæµ‹è¯•**ï¼šä½¿ç”¨systemd-analyze calendaréªŒè¯æ—¶é—´è¡¨è¾¾å¼
- **å…³æ³¨æ—¥å¿—**ï¼šå…»æˆæŸ¥çœ‹æ‰§è¡Œæ—¥å¿—çš„ä¹ æƒ¯
- **é€æ­¥æ›¿ä»£**ï¼šå¯ä»¥é€æ­¥å°†ç°æœ‰cronä»»åŠ¡è¿ç§»åˆ°systemdå®šæ—¶å™¨

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å®šæ—¶å™¨é…æœåŠ¡ï¼Œtimerè§¦å‘serviceè·‘
- OnCalendarçœ‹æ—¥å†ï¼ŒOnBootSecç­‰å¼€æœº
- Persistentè¡¥é”™è¿‡ï¼ŒRandomDelayé¿æ‹¥å µ  
- list-timersçœ‹çŠ¶æ€ï¼ŒjournalctlæŸ¥æ—¥å¿—