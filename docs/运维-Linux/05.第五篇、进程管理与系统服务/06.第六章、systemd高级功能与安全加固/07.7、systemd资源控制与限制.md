---
title: 7ã€systemdèµ„æºæ§åˆ¶ä¸é™åˆ¶
---
## ğŸ“š ç›®å½•

1. [cgroupsé›†æˆæœºåˆ¶](#1-cgroupsé›†æˆæœºåˆ¶)
2. [èµ„æºé™åˆ¶é…ç½®](#2-èµ„æºé™åˆ¶é…ç½®)
3. [I/Oæ§åˆ¶æœºåˆ¶](#3-ioæ§åˆ¶æœºåˆ¶)
4. [è®¾å¤‡è®¿é—®æ§åˆ¶](#4-è®¾å¤‡è®¿é—®æ§åˆ¶)
5. [sliceå•å…ƒèµ„æºåˆ†ç»„](#5-sliceå•å…ƒèµ„æºåˆ†ç»„)
6. [èµ„æºç›‘æ§ä¸ç®¡ç†](#6-èµ„æºç›‘æ§ä¸ç®¡ç†)
7. [æ•…éšœæ’æŸ¥ä¸ä¼˜åŒ–](#7-æ•…éšœæ’æŸ¥ä¸ä¼˜åŒ–)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ cgroupsé›†æˆæœºåˆ¶


### 1.1 ä»€ä¹ˆæ˜¯cgroups


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
cgroupsï¼ˆControl Groupsï¼‰ï¼šLinuxå†…æ ¸çš„èµ„æºç®¡ç†æœºåˆ¶
ä½œç”¨ï¼šå¯¹è¿›ç¨‹ç»„è¿›è¡Œèµ„æºé™åˆ¶ã€ç›‘æ§å’Œç®¡ç†
systemdé›†æˆï¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºcgroupå±‚æ¬¡ç»“æ„
```

**ğŸ’¡ é€šä¿—ç†è§£**
æƒ³è±¡cgroupså°±åƒæ˜¯ç»™æ¯ä¸ªåº”ç”¨ç¨‹åºåˆ†é…"èµ„æºé…é¢"çš„ç®¡ç†å‘˜ï¼š
- å°±åƒé“¶è¡Œç»™æ¯ä¸ªè´¦æˆ·è®¾ç½®é€æ”¯é™é¢
- æ¯ä¸ªè¿›ç¨‹ç»„éƒ½æœ‰è‡ªå·±çš„"èµ„æºè´¦æˆ·"
- è¶…å‡ºé™é¢å°±ä¼šè¢«é™åˆ¶æˆ–ç»ˆæ­¢

### 1.2 cgroups v1 vs v2


**ğŸ“Š ç‰ˆæœ¬å¯¹æ¯”**

| ç‰¹æ€§ | **cgroups v1** | **cgroups v2** |
|------|-------------|-------------|
| **å±‚æ¬¡ç»“æ„** | å¤šä¸ªç‹¬ç«‹æ ‘å½¢ç»“æ„ | ç»Ÿä¸€æ ‘å½¢ç»“æ„ |
| **æ§åˆ¶å™¨** | å„è‡ªç‹¬ç«‹ç®¡ç† | ç»Ÿä¸€åè°ƒç®¡ç† |
| **æ€§èƒ½** | è¾ƒä½ | æ˜¾è‘—æå‡ |
| **é…ç½®** | å¤æ‚åˆ†æ•£ | ç®€åŒ–ç»Ÿä¸€ |
| **å…¼å®¹æ€§** | ä¼ ç»Ÿæ”¯æŒ | ç°ä»£æ¨è |

### 1.3 systemdçš„cgroupsé›†æˆ


**ğŸ—ï¸ å±‚æ¬¡ç»“æ„ç¤ºä¾‹**
```
systemd cgroupæ ‘å½¢ç»“æ„ï¼š
â”œâ”€â”€ system.slice           â† ç³»ç»ŸæœåŠ¡ç»„
â”‚   â”œâ”€â”€ ssh.service
â”‚   â”œâ”€â”€ nginx.service
â”‚   â””â”€â”€ mysql.service
â”œâ”€â”€ user.slice            â† ç”¨æˆ·ä¼šè¯ç»„
â”‚   â””â”€â”€ user-1000.slice
â”‚       â””â”€â”€ session-1.scope
â””â”€â”€ machine.slice         â† è™šæ‹Ÿæœº/å®¹å™¨ç»„
    â””â”€â”€ libvirt-qemu
```

**ğŸ” æŸ¥çœ‹cgroupä¿¡æ¯**
```bash
# æŸ¥çœ‹æœåŠ¡çš„cgroupè·¯å¾„
systemctl status nginx.service

# æŸ¥çœ‹cgroupæ ‘ç»“æ„
systemd-cgls

# æŸ¥çœ‹ç‰¹å®šcgroupè¯¦æƒ…
systemd-cgls /system.slice/nginx.service
```

---

## 2. âš™ï¸ èµ„æºé™åˆ¶é…ç½®


### 2.1 CPUèµ„æºæ§åˆ¶


**ğŸ”¸ CPUQuota - CPUä½¿ç”¨ç‡é™åˆ¶**

**åŸºæœ¬æ¦‚å¿µ**ï¼š
- `CPUQuota`ï¼šé™åˆ¶æœåŠ¡å¯ä½¿ç”¨çš„CPUæ—¶é—´ç™¾åˆ†æ¯”
- 100% = ä¸€ä¸ªCPUæ ¸å¿ƒçš„å…¨éƒ¨æ—¶é—´
- 200% = ä¸¤ä¸ªCPUæ ¸å¿ƒçš„å…¨éƒ¨æ—¶é—´

```bash
# é™åˆ¶nginxæœ€å¤šä½¿ç”¨50%çš„CPU
[Unit]
Description=Nginx Web Server
After=network.target

[Service]
Type=forking
ExecStart=/usr/sbin/nginx
CPUQuota=50%          # é™åˆ¶CPUä½¿ç”¨ç‡ä¸è¶…è¿‡50%
Restart=always

[Install]
WantedBy=multi-user.target
```

**ğŸ”¸ CPUWeight - CPUæƒé‡åˆ†é…**

```bash
# é«˜ä¼˜å…ˆçº§æœåŠ¡é…ç½®
[Service]
CPUWeight=200         # æƒé‡200ï¼ˆé»˜è®¤100ï¼‰
CPUQuota=150%         # æœ€å¤šä½¿ç”¨1.5ä¸ªæ ¸å¿ƒ

# ä½ä¼˜å…ˆçº§æœåŠ¡é…ç½®  
[Service]
CPUWeight=50          # æƒé‡50
CPUQuota=25%          # æœ€å¤šä½¿ç”¨25%
```

**ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯**
```
WebæœåŠ¡å™¨ï¼šCPUQuota=200%ï¼ˆå…è®¸ä½¿ç”¨2ä¸ªæ ¸å¿ƒï¼‰
æ•°æ®åº“ï¼šCPUQuota=300%ï¼ˆå…è®¸ä½¿ç”¨3ä¸ªæ ¸å¿ƒï¼‰
å¤‡ä»½ä»»åŠ¡ï¼šCPUQuota=50%ï¼ˆé™åˆ¶åœ¨0.5ä¸ªæ ¸å¿ƒï¼‰
```

### 2.2 å†…å­˜èµ„æºæ§åˆ¶


**ğŸ”¸ MemoryMax - å†…å­˜ä½¿ç”¨ä¸Šé™**

```bash
[Service]
# ç¡¬é™åˆ¶ï¼šè¶…è¿‡å°±è¢«æ€æ­»
MemoryMax=1G          # æœ€å¤§ä½¿ç”¨1GBå†…å­˜

# è½¯é™åˆ¶ï¼šå°½é‡ä¸è¶…è¿‡ï¼Œä½†å¿…è¦æ—¶å¯ä»¥
MemoryHigh=800M       # å»ºè®®ä¸è¶…è¿‡800MB

# äº¤æ¢ç©ºé—´é™åˆ¶
MemorySwapMax=2G      # æœ€å¤§ä½¿ç”¨2GBäº¤æ¢ç©ºé—´
```

**ğŸ“Š å†…å­˜é™åˆ¶ç±»å‹å¯¹æ¯”**

| å‚æ•° | **ä½œç”¨** | **è¶…å‡ºåæœ** |
|------|---------|------------|
| `MemoryMax` | ç¡¬é™åˆ¶ | è¿›ç¨‹è¢«æ€æ­»(OOM) |
| `MemoryHigh` | è½¯é™åˆ¶ | ç³»ç»Ÿå°è¯•å›æ”¶å†…å­˜ |
| `MemoryLow` | ä¿æŠ¤é˜ˆå€¼ | å°½é‡ä¸å›æ”¶æ­¤æœåŠ¡å†…å­˜ |

### 2.3 ä»»åŠ¡æ•°é‡æ§åˆ¶


**ğŸ”¸ TasksMax - é™åˆ¶è¿›ç¨‹/çº¿ç¨‹æ•°é‡**

```bash
[Service]
TasksMax=100          # æœ€å¤šåˆ›å»º100ä¸ªä»»åŠ¡(è¿›ç¨‹+çº¿ç¨‹)

# æ— é™åˆ¶(æ…ç”¨)
TasksMax=infinity
```

**å®é™…é…ç½®ç¤ºä¾‹**ï¼š
```bash
# ApacheæœåŠ¡é…ç½®
[Unit]
Description=Apache HTTP Server

[Service]
Type=notify
ExecStart=/usr/sbin/httpd
# èµ„æºé™åˆ¶
CPUQuota=150%         # 1.5ä¸ªæ ¸å¿ƒ
MemoryMax=2G          # æœ€å¤§2GBå†…å­˜
TasksMax=200          # æœ€å¤š200ä¸ªè¿›ç¨‹/çº¿ç¨‹
Restart=always

[Install]
WantedBy=multi-user.target
```

---

## 3. ğŸ’¾ I/Oæ§åˆ¶æœºåˆ¶


### 3.1 I/Oè°ƒåº¦ä¼˜å…ˆçº§


**ğŸ”¸ IOSchedulingClass - I/Oè°ƒåº¦ç±»åˆ«**

```bash
[Service]
# I/Oè°ƒåº¦ç±»åˆ«ï¼š
# 0 - æ— ç±»åˆ«(é»˜è®¤)
# 1 - å®æ—¶ç±»åˆ«(æœ€é«˜ä¼˜å…ˆçº§)
# 2 - å°½åŠ›è€Œä¸ºç±»åˆ«  
# 3 - ç©ºé—²ç±»åˆ«(æœ€ä½ä¼˜å…ˆçº§)
IOSchedulingClass=2

# I/Oä¼˜å…ˆçº§(0-7ï¼Œ0æœ€é«˜)
IOSchedulingPriority=4
```

**ğŸ’¡ å®é™…åº”ç”¨æŒ‡å¯¼**
```
æ•°æ®åº“æœåŠ¡ï¼šIOSchedulingClass=1, Priority=0 (æœ€é«˜ä¼˜å…ˆçº§)
WebæœåŠ¡å™¨ï¼šIOSchedulingClass=2, Priority=2 (æ­£å¸¸ä¼˜å…ˆçº§)  
å¤‡ä»½ä»»åŠ¡ï¼šIOSchedulingClass=3, Priority=7 (æœ€ä½ä¼˜å…ˆçº§)
æ—¥å¿—æœåŠ¡ï¼šIOSchedulingClass=2, Priority=5 (ä¸­ä½ä¼˜å…ˆçº§)
```

### 3.2 å—è®¾å¤‡I/Oæ§åˆ¶


**ğŸ”¸ BlockIOWeight - I/Oæƒé‡åˆ†é…**

```bash
[Service]
# æ•´ä½“I/Oæƒé‡(10-1000ï¼Œé»˜è®¤100)
BlockIOWeight=200

# é’ˆå¯¹ç‰¹å®šè®¾å¤‡çš„æƒé‡
BlockIODeviceWeight=/dev/sda 500
BlockIODeviceWeight=/dev/sdb 50
```

**ğŸ”¸ I/Oå¸¦å®½é™åˆ¶**

```bash
[Service]
# è¯»å–é€Ÿåº¦é™åˆ¶
BlockIOReadBandwidth=/dev/sda 10M    # é™åˆ¶è¯»å–10MB/s
BlockIOReadBandwidth=/dev/sdb 5M

# å†™å…¥é€Ÿåº¦é™åˆ¶  
BlockIOWriteBandwidth=/dev/sda 5M    # é™åˆ¶å†™å…¥5MB/s
BlockIOWriteBandwidth=/dev/sdb 2M
```

### 3.3 å®é™…é…ç½®ç¤ºä¾‹


```bash
# é«˜I/Oéœ€æ±‚çš„æ•°æ®åº“æœåŠ¡
[Unit]
Description=MySQL Database Server

[Service]
Type=notify
ExecStart=/usr/sbin/mysqld
# I/Oä¼˜åŒ–é…ç½®
IOSchedulingClass=1       # å®æ—¶I/Oè°ƒåº¦
IOSchedulingPriority=0    # æœ€é«˜I/Oä¼˜å…ˆçº§
BlockIOWeight=500         # é«˜I/Oæƒé‡
# é’ˆå¯¹æ•°æ®ç›˜ä¼˜åŒ–
BlockIODeviceWeight=/dev/sdb 800
Restart=always

[Install]
WantedBy=multi-user.target
```

---

## 4. ğŸ”’ è®¾å¤‡è®¿é—®æ§åˆ¶


### 4.1 è®¾å¤‡è®¿é—®ç­–ç•¥


**ğŸ”¸ DevicePolicy - è®¾å¤‡è®¿é—®ç­–ç•¥**

```bash
[Service]
# è®¾å¤‡è®¿é—®ç­–ç•¥ï¼š
# strict - ä¸¥æ ¼æ¨¡å¼ï¼Œåªå…è®¸æ˜ç¡®æˆæƒçš„è®¾å¤‡
# closed - å…³é—­æ¨¡å¼ï¼Œç¦æ­¢æ‰€æœ‰è®¾å¤‡è®¿é—®
# auto - è‡ªåŠ¨æ¨¡å¼(é»˜è®¤)
DevicePolicy=strict
```

### 4.2 è®¾å¤‡è®¿é—®æƒé™


**ğŸ”¸ DeviceAllow - å…è®¸è®¿é—®çš„è®¾å¤‡**

```bash
[Service]
DevicePolicy=strict

# å…è®¸è®¿é—®ç‰¹å®šè®¾å¤‡
DeviceAllow=/dev/null rw          # å…è®¸è¯»å†™/dev/null
DeviceAllow=/dev/zero r           # å…è®¸è¯»å–/dev/zero  
DeviceAllow=/dev/sda1 rw          # å…è®¸è¯»å†™ç‰¹å®šç£ç›˜åˆ†åŒº
DeviceAllow=/dev/tty* rw          # å…è®¸è®¿é—®æ‰€æœ‰ttyè®¾å¤‡

# å­—ç¬¦è®¾å¤‡ç±»åˆ«(cè¡¨ç¤ºå­—ç¬¦è®¾å¤‡ï¼Œbè¡¨ç¤ºå—è®¾å¤‡)
DeviceAllow=char-* r              # å…è®¸è¯»å–æ‰€æœ‰å­—ç¬¦è®¾å¤‡
```

### 4.3 å®‰å…¨é…ç½®ç¤ºä¾‹


```bash
# WebæœåŠ¡çš„å®‰å…¨é…ç½®
[Unit]
Description=Secure Web Server

[Service]
Type=forking
ExecStart=/usr/sbin/nginx

# è®¾å¤‡è®¿é—®é™åˆ¶
DevicePolicy=strict
DeviceAllow=/dev/null rw
DeviceAllow=/dev/zero r
DeviceAllow=/dev/urandom r

# ç¦æ­¢è®¿é—®å…¶ä»–è®¾å¤‡
# æé«˜å®‰å…¨æ€§ï¼Œé˜²æ­¢æ¶æ„ä»£ç è®¿é—®æ•æ„Ÿè®¾å¤‡

[Install]
WantedBy=multi-user.target
```

---

## 5. ğŸ—ï¸ sliceå•å…ƒèµ„æºåˆ†ç»„


### 5.1 ä»€ä¹ˆæ˜¯sliceå•å…ƒ


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
sliceå•å…ƒï¼šsystemdä¸­çš„èµ„æºåˆ†ç»„ç®¡ç†å•ä½
ä½œç”¨ï¼šå°†ç›¸å…³æœåŠ¡å½’ç»„ï¼Œç»Ÿä¸€ç®¡ç†èµ„æºé™åˆ¶
å±‚æ¬¡ç»“æ„ï¼šæ”¯æŒåµŒå¥—çš„æ ‘å½¢ç»“æ„
```

**ğŸ’¡ ç”Ÿæ´»åŒ–ç†è§£**
sliceå°±åƒå…¬å¸çš„éƒ¨é—¨é¢„ç®—ç®¡ç†ï¼š
- æ•´ä¸ªå…¬å¸æœ‰æ€»é¢„ç®—ï¼ˆç³»ç»Ÿæ€»èµ„æºï¼‰
- å„éƒ¨é—¨åˆ†é…é¢„ç®—é¢åº¦ï¼ˆsliceèµ„æºé™åˆ¶ï¼‰
- éƒ¨é—¨å†…å„é¡¹ç›®å…±äº«éƒ¨é—¨é¢„ç®—ï¼ˆæœåŠ¡å…±äº«sliceèµ„æºï¼‰

### 5.2 é»˜è®¤sliceç»“æ„


```
systemdé»˜è®¤sliceå±‚æ¬¡ï¼š
â”œâ”€â”€ -.slice (æ ¹slice)
â”œâ”€â”€ system.slice          # ç³»ç»ŸæœåŠ¡slice
â”œâ”€â”€ user.slice           # ç”¨æˆ·ä¼šè¯slice  
â””â”€â”€ machine.slice        # è™šæ‹Ÿæœºå®¹å™¨slice
```

### 5.3 åˆ›å»ºè‡ªå®šä¹‰slice


**ğŸ”§ åˆ›å»ºWebåº”ç”¨slice**

```bash
# /etc/systemd/system/webapps.slice
[Unit]
Description=Web Applications Slice
Before=slices.target

[Slice]
# æ•´ä¸ªWebåº”ç”¨ç»„çš„èµ„æºé™åˆ¶
CPUQuota=300%            # æœ€å¤šä½¿ç”¨3ä¸ªCPUæ ¸å¿ƒ
MemoryMax=4G             # æœ€å¤§ä½¿ç”¨4GBå†…å­˜  
TasksMax=500             # æœ€å¤š500ä¸ªä»»åŠ¡
```

**ğŸ”§ å°†æœåŠ¡åˆ†é…åˆ°slice**

```bash
# /etc/systemd/system/nginx.service
[Unit]
Description=Nginx Web Server

[Service]
Type=forking
ExecStart=/usr/sbin/nginx
Slice=webapps.slice      # åŠ å…¥webapps slice

[Install]
WantedBy=multi-user.target
```

```bash
# /etc/systemd/system/apache.service  
[Unit]
Description=Apache HTTP Server

[Service]
Type=notify
ExecStart=/usr/sbin/httpd
Slice=webapps.slice      # åŒæ ·åŠ å…¥webapps slice

[Install]
WantedBy=multi-user.target
```

### 5.4 å±‚çº§sliceé…ç½®


**ğŸ—ï¸ å¤šå±‚çº§sliceç¤ºä¾‹**

```bash
# åˆ›å»ºåº”ç”¨åˆ†ç±»slice
# /etc/systemd/system/applications.slice
[Unit]
Description=Applications Root Slice

[Slice]
CPUQuota=500%            # åº”ç”¨æ€»å…±æœ€å¤š5ä¸ªæ ¸å¿ƒ
MemoryMax=8G             # åº”ç”¨æ€»å…±æœ€å¤§8GBå†…å­˜

# /etc/systemd/system/applications-web.slice
[Unit]
Description=Web Applications
Requires=applications.slice
After=applications.slice

[Slice]
Slice=applications.slice  # ç»§æ‰¿è‡ªapplications slice
CPUQuota=200%            # Webåº”ç”¨æœ€å¤š2ä¸ªæ ¸å¿ƒ
MemoryMax=3G             # Webåº”ç”¨æœ€å¤§3GBå†…å­˜

# /etc/systemd/system/applications-db.slice  
[Unit]
Description=Database Applications
Requires=applications.slice
After=applications.slice

[Slice]
Slice=applications.slice  # ç»§æ‰¿è‡ªapplications slice
CPUQuota=300%            # æ•°æ®åº“æœ€å¤š3ä¸ªæ ¸å¿ƒ
MemoryMax=5G             # æ•°æ®åº“æœ€å¤§5GBå†…å­˜
```

---

## 6. ğŸ“Š èµ„æºç›‘æ§ä¸ç®¡ç†


### 6.1 systemd-cgtop èµ„æºç›‘æ§


**ğŸ” å®æ—¶èµ„æºç›‘æ§**

```bash
# å®æ—¶æŸ¥çœ‹cgroupèµ„æºä½¿ç”¨æƒ…å†µ
systemd-cgtop

# æ˜¾ç¤ºç»“æœç¤ºä¾‹ï¼š
Control Group                    Tasks   %CPU   Memory  Input/s Output/s
/                                  234   12.5     2.1G        -        -
/system.slice                       45    8.2   890.5M        -        -
/system.slice/nginx.service          4    2.1   145.2M        -        -
/system.slice/mysql.service         12    5.8   654.3M        -        -
/user.slice                         89    4.3     1.2G        -        -
```

**ğŸ”§ å¸¸ç”¨ç›‘æ§é€‰é¡¹**

```bash
# æŒ‰CPUä½¿ç”¨ç‡æ’åº
systemd-cgtop --order=cpu

# æŒ‰å†…å­˜ä½¿ç”¨æ’åº  
systemd-cgtop --order=memory

# æŒ‰ä»»åŠ¡æ•°æ’åº
systemd-cgtop --order=tasks

# æ˜¾ç¤ºI/Oä¿¡æ¯
systemd-cgtop --order=io
```

### 6.2 systemctl statusè¯¦ç»†ä¿¡æ¯


**ğŸ“‹ æŸ¥çœ‹æœåŠ¡èµ„æºçŠ¶æ€**

```bash
# æŸ¥çœ‹æœåŠ¡è¯¦ç»†çŠ¶æ€
systemctl status nginx.service

# è¾“å‡ºç¤ºä¾‹ï¼š
â— nginx.service - Nginx Web Server
   Loaded: loaded (/etc/systemd/system/nginx.service; enabled)
   Active: active (running) since Mon 2025-09-14 10:30:15 CST; 2h 15min ago
   Memory: 145.2M (max: 1.0G)          # å½“å‰å†…å­˜ä½¿ç”¨/æœ€å¤§é™åˆ¶
   CGroup: /system.slice/nginx.service  # cgroupè·¯å¾„
           â”œâ”€1234 nginx: master process
           â”œâ”€1235 nginx: worker process
           â””â”€1236 nginx: worker process
```

### 6.3 èµ„æºä½¿ç”¨ç»Ÿè®¡


**ğŸ“ˆ æŸ¥çœ‹å†å²èµ„æºä½¿ç”¨**

```bash
# æŸ¥çœ‹æœåŠ¡CPUä½¿ç”¨ç»Ÿè®¡
systemctl show nginx.service -p CPUUsageNSec

# æŸ¥çœ‹å†…å­˜å³°å€¼ä½¿ç”¨
systemctl show nginx.service -p MemoryPeak

# æŸ¥çœ‹ä»»åŠ¡ç»Ÿè®¡
systemctl show nginx.service -p TasksCurrent,TasksMax
```

**ğŸ”§ è®¾ç½®èµ„æºä½¿ç”¨å‘Šè­¦**

```bash
# åˆ›å»ºç›‘æ§è„šæœ¬
#!/bin/bash
# /usr/local/bin/resource-monitor.sh

SERVICE="nginx.service"
CPU_THRESHOLD=80
MEM_THRESHOLD=90

# è·å–å½“å‰CPUä½¿ç”¨ç‡
CPU_USAGE=$(systemd-cgtop -1 | grep $SERVICE | awk '{print $3}' | sed 's/%//')
# è·å–å½“å‰å†…å­˜ä½¿ç”¨ç‡  
MEM_USAGE=$(systemctl show $SERVICE -p MemoryUsage --value)
MEM_MAX=$(systemctl show $SERVICE -p MemoryMax --value)
MEM_PERCENT=$((MEM_USAGE * 100 / MEM_MAX))

# æ£€æŸ¥æ˜¯å¦è¶…è¿‡é˜ˆå€¼
if [ $CPU_USAGE -gt $CPU_THRESHOLD ]; then
    echo "è­¦å‘Š: $SERVICE CPUä½¿ç”¨ç‡è¿‡é«˜: ${CPU_USAGE}%"
fi

if [ $MEM_PERCENT -gt $MEM_THRESHOLD ]; then
    echo "è­¦å‘Š: $SERVICE å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${MEM_PERCENT}%"
fi
```

---

## 7. ğŸ› ï¸ æ•…éšœæ’æŸ¥ä¸ä¼˜åŒ–


### 7.1 å¸¸è§é—®é¢˜è¯Šæ–­


**âŒ æœåŠ¡å› èµ„æºé™åˆ¶è¢«æ€æ­»**

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
systemctl status myapp.service

# å¦‚æœçœ‹åˆ° "Main process exited, code=killed, status=9/KILL"
# é€šå¸¸è¡¨ç¤ºå› ä¸ºèµ„æºé™åˆ¶è¢«ç³»ç»Ÿæ€æ­»

# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
journalctl -u myapp.service | grep -i "oom\|kill\|memory"

# æ£€æŸ¥å†…å­˜é™åˆ¶è®¾ç½®
systemctl show myapp.service | grep -i memory
```

**ğŸ”§ è§£å†³æ–¹æ¡ˆ**

```bash
# å¢åŠ å†…å­˜é™åˆ¶
sudo systemctl edit myapp.service

# åœ¨ç¼–è¾‘å™¨ä¸­æ·»åŠ ï¼š
[Service]
MemoryMax=2G              # å¢åŠ åˆ°2GB
MemoryHigh=1.8G           # è½¯é™åˆ¶1.8GB

# é‡æ–°åŠ è½½å¹¶é‡å¯
sudo systemctl daemon-reload
sudo systemctl restart myapp.service
```

### 7.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**âš¡ CPUä¼˜åŒ–é…ç½®**

```bash
# é«˜æ€§èƒ½æœåŠ¡é…ç½®
[Service]
CPUQuota=200%             # å…è®¸ä½¿ç”¨2ä¸ªæ ¸å¿ƒ
CPUWeight=200             # é«˜æƒé‡ä¼˜å…ˆçº§

# ç»‘å®šåˆ°ç‰¹å®šCPUæ ¸å¿ƒ(éœ€è¦cpusetæ§åˆ¶å™¨æ”¯æŒ)
# CPUAffinity=0-3         # ç»‘å®šåˆ°0-3å·CPUæ ¸å¿ƒ
```

**ğŸ’¾ å†…å­˜ä¼˜åŒ–é…ç½®**

```bash
[Service]
# æ¸è¿›å¼å†…å­˜é™åˆ¶
MemoryLow=500M            # å°½é‡ä¿è¯500MBä¸è¢«å›æ”¶
MemoryHigh=1G             # è½¯é™åˆ¶1GB
MemoryMax=1.5G            # ç¡¬é™åˆ¶1.5GB

# äº¤æ¢ç©ºé—´æ§åˆ¶
MemorySwapMax=1G          # é™åˆ¶äº¤æ¢ç©ºé—´ä½¿ç”¨
```

### 7.3 ç›‘æ§è„šæœ¬è‡ªåŠ¨åŒ–


**ğŸ“‹ å®Œæ•´ç›‘æ§è„šæœ¬ç¤ºä¾‹**

```bash
#!/bin/bash
# /usr/local/bin/systemd-resource-monitor.sh

# é…ç½®æ–‡ä»¶
CONFIG="/etc/systemd-monitor.conf"

# è¯»å–é…ç½®
if [ -f "$CONFIG" ]; then
    source "$CONFIG"
else
    # é»˜è®¤é…ç½®
    SERVICES=("nginx.service" "mysql.service" "redis.service")
    CPU_THRESHOLD=80
    MEM_THRESHOLD=85
    TASKS_THRESHOLD=90
fi

# ç›‘æ§å‡½æ•°
monitor_service() {
    local service=$1
    echo "=== ç›‘æ§æœåŠ¡: $service ==="
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if ! systemctl is-active --quiet "$service"; then
        echo "âŒ æœåŠ¡æœªè¿è¡Œ: $service"
        return 1
    fi
    
    # è·å–èµ„æºä½¿ç”¨æƒ…å†µ
    local mem_current=$(systemctl show "$service" -p MemoryUsage --value)
    local mem_max=$(systemctl show "$service" -p MemoryMax --value)
    local tasks_current=$(systemctl show "$service" -p TasksCurrent --value)
    local tasks_max=$(systemctl show "$service" -p TasksMax --value)
    
    # è®¡ç®—ç™¾åˆ†æ¯”
    if [ "$mem_max" != "infinity" ] && [ "$mem_max" -gt 0 ]; then
        local mem_percent=$((mem_current * 100 / mem_max))
        if [ $mem_percent -gt $MEM_THRESHOLD ]; then
            echo "âš ï¸  å†…å­˜ä½¿ç”¨è¿‡é«˜: ${mem_percent}% (${mem_current}/${mem_max})"
        fi
    fi
    
    if [ "$tasks_max" != "infinity" ] && [ "$tasks_max" -gt 0 ]; then
        local tasks_percent=$((tasks_current * 100 / tasks_max))
        if [ $tasks_percent -gt $TASKS_THRESHOLD ]; then
            echo "âš ï¸  ä»»åŠ¡æ•°è¿‡å¤š: ${tasks_percent}% (${tasks_current}/${tasks_max})"
        fi
    fi
    
    echo "âœ… å†…å­˜: ${mem_current} bytes, ä»»åŠ¡: ${tasks_current}"
}

# ä¸»å¾ªç¯
echo "ğŸ” systemdèµ„æºç›‘æ§å¼€å§‹ - $(date)"
for service in "${SERVICES[@]}"; do
    monitor_service "$service"
    echo
done
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ cgroupsé›†æˆï¼šsystemdè‡ªåŠ¨ä¸ºæœåŠ¡åˆ›å»ºèµ„æºæ§åˆ¶ç»„
ğŸ”¸ èµ„æºé™åˆ¶ï¼šCPUã€å†…å­˜ã€ä»»åŠ¡æ•°çš„é‡åŒ–é™åˆ¶é…ç½®
ğŸ”¸ I/Oæ§åˆ¶ï¼šè°ƒåº¦ä¼˜å…ˆçº§ã€å¸¦å®½é™åˆ¶ã€è®¾å¤‡æƒé‡ç®¡ç†
ğŸ”¸ è®¾å¤‡æ§åˆ¶ï¼šä¸¥æ ¼çš„è®¾å¤‡è®¿é—®æƒé™ç®¡ç†
ğŸ”¸ sliceåˆ†ç»„ï¼šæœåŠ¡çš„åˆ†ç»„èµ„æºç®¡ç†æœºåˆ¶
ğŸ”¸ ç›‘æ§å·¥å…·ï¼šsystemd-cgtopå’Œsystemctl status
```

### 8.2 å…³é”®é…ç½®å‚æ•°é€ŸæŸ¥


**ğŸ’» CPUæ§åˆ¶**
```bash
CPUQuota=50%              # CPUä½¿ç”¨ç‡é™åˆ¶
CPUWeight=200             # CPUæƒé‡(10-1000)
```

**ğŸ’¾ å†…å­˜æ§åˆ¶**  
```bash
MemoryMax=1G              # å†…å­˜ç¡¬é™åˆ¶
MemoryHigh=800M           # å†…å­˜è½¯é™åˆ¶
MemoryLow=200M            # å†…å­˜ä¿æŠ¤é˜ˆå€¼
```

**âš¡ I/Oæ§åˆ¶**
```bash
IOSchedulingClass=2       # I/Oè°ƒåº¦ç±»åˆ«
IOSchedulingPriority=4    # I/Oä¼˜å…ˆçº§
BlockIOWeight=200         # å—I/Oæƒé‡
```

### 8.3 å®è·µåº”ç”¨æŒ‡å¯¼


**ğŸ¯ æœåŠ¡åˆ†ç±»èµ„æºé…ç½®**

```
WebæœåŠ¡å™¨ï¼š
- CPUQuota=150%, MemoryMax=2G
- IOSchedulingClass=2, Priority=2

æ•°æ®åº“ï¼š
- CPUQuota=300%, MemoryMax=4G  
- IOSchedulingClass=1, Priority=0

å¤‡ä»½ä»»åŠ¡ï¼š
- CPUQuota=50%, MemoryMax=500M
- IOSchedulingClass=3, Priority=7
```

**ğŸ” ç›‘æ§è¦ç‚¹**
- å®šæœŸæ£€æŸ¥æœåŠ¡æ˜¯å¦å› èµ„æºé™åˆ¶è¢«æ€æ­»
- ç›‘æ§å†…å­˜ä½¿ç”¨ç‡é¿å…OOM
- è§‚å¯ŸI/Oç­‰å¾…æ—¶é—´ä¼˜åŒ–å­˜å‚¨æ€§èƒ½
- ä½¿ç”¨sliceè¿›è¡Œåˆ†ç»„èµ„æºç®¡ç†

**ğŸ› ï¸ æ•…éšœæ’æŸ¥æµç¨‹**
1. æŸ¥çœ‹`systemctl status`ç¡®è®¤æœåŠ¡çŠ¶æ€
2. æ£€æŸ¥`journalctl`æ—¥å¿—æŸ¥æ‰¾é”™è¯¯ä¿¡æ¯  
3. ä½¿ç”¨`systemd-cgtop`ç›‘æ§èµ„æºä½¿ç”¨
4. è°ƒæ•´èµ„æºé™åˆ¶å‚æ•°å¹¶æµ‹è¯•
5. å»ºç«‹ç›‘æ§è„šæœ¬é¢„é˜²é—®é¢˜

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- systemdç®¡èµ„æºï¼Œcgroupsåšåç«¯
- CPUå†…å­˜I/Oæ§ï¼Œsliceåˆ†ç»„æ›´æ–¹ä¾¿
- ç›‘æ§å·¥å…·systemd-cgtopï¼ŒçŠ¶æ€æŸ¥çœ‹statusè§
- èµ„æºä¸å¤Ÿè°ƒå‚æ•°ï¼Œå®‰å…¨ç¬¬ä¸€æ§è®¾å¤‡