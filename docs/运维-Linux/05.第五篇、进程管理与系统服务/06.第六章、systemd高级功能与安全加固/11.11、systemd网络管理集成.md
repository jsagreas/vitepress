---
title: 11、systemd网络管理集成
---
## 📚 目录

1. [systemd-networkd基础配置](#1-systemd-networkd基础配置)
2. [网络单元文件详解](#2-网络单元文件详解)
3. [网络依赖与服务启动顺序](#3-网络依赖与服务启动顺序)
4. [网络状态检查与启动条件](#4-网络状态检查与启动条件)
5. [动态网络配置响应](#5-动态网络配置响应)
6. [NetworkManager与systemd协作](#6-networkmanager与systemd协作)
7. [网络服务依赖最佳实践](#7-网络服务依赖最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🌐 systemd-networkd基础配置


### 1.1 什么是systemd-networkd


**简单理解**：systemd-networkd就是systemd家族中专门负责网络管理的组件，可以理解为**系统自带的网络管家**。

```
传统网络管理 vs systemd-networkd：

传统方式：
/etc/network/interfaces (Debian/Ubuntu)
/etc/sysconfig/network-scripts/ (RHEL/CentOS)
↓ 问题：配置分散，管理复杂

systemd-networkd方式：
统一的配置文件格式
与systemd深度集成
自动化程度更高
```

### 1.2 systemd-networkd的核心优势


**为什么要用systemd-networkd**：

🔸 **统一管理**：所有网络配置都在一个地方
```
配置目录：/etc/systemd/network/
日志集成：journalctl -u systemd-networkd
状态查看：networkctl status
```

🔸 **服务集成**：与其他systemd服务完美配合
- 网络就绪后自动启动依赖服务
- 网络故障时自动重启相关服务
- 启动顺序自动优化

🔸 **现代化特性**：支持容器、虚拟化等新需求

### 1.3 启用systemd-networkd


**操作步骤**：

```bash
# 1. 停用现有网络管理器（如果有）
sudo systemctl stop NetworkManager
sudo systemctl disable NetworkManager

# 2. 启用systemd-networkd
sudo systemctl enable systemd-networkd
sudo systemctl start systemd-networkd

# 3. 启用解析服务（DNS）
sudo systemctl enable systemd-resolved
sudo systemctl start systemd-resolved

# 4. 查看状态
sudo systemctl status systemd-networkd
```

> 💡 **新手提示**：
> NetworkManager和systemd-networkd**不能同时使用**，就像一个厨房不能有两个厨师长一样，会产生冲突。

---

## 2. 📁 网络单元文件详解


systemd-networkd使用三种配置文件来管理网络，就像三个不同的工具箱：

### 2.1 网络文件（.network）- 网络配置的主角


**作用**：定义网络接口的具体配置（IP地址、路由等）

**文件位置**：`/etc/systemd/network/`

**基础示例**：
```ini
# /etc/systemd/network/10-eth0.network
[Match]
Name=eth0

[Network]
DHCP=yes
```

**详细配置示例**：
```ini
# /etc/systemd/network/20-wired.network
[Match]
Name=ens33                    # 匹配网卡名称

[Network]
DHCP=no                       # 不使用DHCP
Address=192.168.1.100/24      # 静态IP地址
Gateway=192.168.1.1           # 网关
DNS=8.8.8.8                   # DNS服务器
DNS=8.8.4.4                   # 备用DNS
Domain=example.com            # 搜索域

[Route]
Destination=10.0.0.0/8        # 目标网络
Gateway=192.168.1.254         # 路由网关
```

### 2.2 网络设备文件（.netdev）- 虚拟设备创建器


**作用**：创建虚拟网络设备（网桥、VLAN、隧道等）

**常见应用场景**：
- 创建网桥供虚拟机使用
- 设置VLAN标签
- 建立VPN隧道

**网桥配置示例**：
```ini
# /etc/systemd/network/br0.netdev
[NetDev]
Name=br0                      # 网桥名称
Kind=bridge                   # 设备类型：网桥
```

**VLAN配置示例**：
```ini
# /etc/systemd/network/vlan100.netdev
[NetDev]
Name=vlan100                  # VLAN接口名
Kind=vlan                     # 设备类型：VLAN

[VLAN]
Id=100                        # VLAN ID
```

### 2.3 链路文件（.link）- 底层网卡属性设置


**作用**：设置网卡的底层属性（MAC地址、网卡名称等）

**使用场景**：
- 固定网卡名称（避免重启后变化）
- 设置特定MAC地址
- 调整网卡参数

**示例配置**：
```ini
# /etc/systemd/network/10-persistent-net.link
[Match]
MACAddress=00:11:22:33:44:55  # 匹配MAC地址

[Link]
Name=eth0                     # 固定网卡名称
MACAddress=00:aa:bb:cc:dd:ee  # 更改MAC地址
```

### 2.4 文件优先级规则


```
文件名排序规则：
10-first.network    ← 优先级最高
20-second.network   
30-third.network    ← 优先级最低

原则：数字越小，优先级越高
就像排队，编号小的先处理
```

---

## 3. 🔗 网络依赖与服务启动顺序


### 3.1 为什么需要网络依赖


**现实问题**：
```
场景：Web服务器启动
┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│ 系统启动    │───▶│ 网络配置     │───▶│ Web服务启动 │
└─────────────┘    └──────────────┘    └─────────────┘

问题：如果Web服务在网络就绪前启动会怎样？
→ 服务启动失败或无法正常工作
```

### 3.2 systemd的网络目标


systemd提供了不同的网络**里程碑**（target），就像火车站的站点：

**network-pre.target**：网络配置前
- 最早期的网络准备阶段
- 适用于网络配置工具启动

**network.target**：基础网络可用
- 网络接口已配置完成
- 适用于大多数网络服务

**network-online.target**：网络完全就绪
- 网络连接已建立且可达外部
- 适用于需要internet连接的服务

### 3.3 服务依赖配置


**基础依赖示例**：
```ini
# /etc/systemd/system/my-web-server.service
[Unit]
Description=My Web Server
After=network.target          # 在网络基础配置后启动
Wants=network.target          # 希望网络目标启动

[Service]
ExecStart=/usr/bin/my-web-server
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

**严格依赖示例**：
```ini
# /etc/systemd/system/backup-service.service
[Unit]
Description=Backup to Cloud Service
After=network-online.target   # 等待网络完全就绪
Wants=network-online.target   # 希望在线网络目标启动
Requires=network-online.target # 强制要求网络在线

[Service]
ExecStart=/usr/bin/cloud-backup
Type=oneshot

[Install]
WantedBy=multi-user.target
```

### 3.4 网络等待工具


**systemd-networkd-wait-online**：
```bash
# 检查网络是否在线
systemd-networkd-wait-online --timeout=30

# 在脚本中使用
if systemd-networkd-wait-online --timeout=10; then
    echo "网络就绪，启动服务"
    start_my_service
else
    echo "网络超时，稍后重试"
fi
```

---

## 4. 🔍 网络状态检查与启动条件


### 4.1 网络状态检查工具


**networkctl命令**：systemd网络管理的**万能钥匙**

```bash
# 查看所有网络接口状态
networkctl status

# 查看特定接口详细信息
networkctl status eth0

# 重新配置网络接口
sudo networkctl reload
sudo networkctl reconfigure eth0
```

**示例输出解读**：
```
● 2: eth0                                                          
       Link File: /usr/lib/systemd/network/99-default.link
    Network File: /etc/systemd/network/10-eth0.network
           State: configured                    ← 配置状态
         Address: 192.168.1.100                ← IP地址
                  fe80::a00:27ff:fe4e:66a1     ← IPv6地址
         Gateway: 192.168.1.1                 ← 网关
             DNS: 8.8.8.8                     ← DNS服务器
```

### 4.2 服务启动条件设置


**ConditionPathExists**：文件存在条件
```ini
[Unit]
Description=Network-dependent Service
ConditionPathExists=/sys/class/net/eth0  # 确保网卡存在

[Service]
ExecStart=/usr/bin/my-service
```

**ConditionHost**：主机名条件
```ini
[Unit]
Description=Server-specific Service  
ConditionHost=webserver               # 仅在特定主机运行

[Service]
ExecStart=/usr/bin/web-service
```

### 4.3 动态服务启动


**网络接口变化时自动启动服务**：
```ini
# /etc/systemd/system/network-monitor.service
[Unit]
Description=Network Interface Monitor
BindsTo=sys-subsystem-net-devices-eth0.device  # 绑定到网卡设备

[Service]
ExecStart=/usr/bin/network-monitor
Restart=always

[Install]
WantedBy=multi-user.target
```

---

## 5. ⚡ 动态网络配置响应


### 5.1 什么是动态网络配置响应


**生活中的类比**：
```
就像手机在不同WiFi环境下的自动适应：
家里WiFi     → 自动连接，启动同步服务
公司WiFi     → 自动连接，启动工作应用  
移动网络     → 自动切换，关闭大流量应用
```

在服务器中，网络环境变化时，相关服务也需要自动调整。

### 5.2 udev规则与网络事件


**udev**是Linux系统的**设备管家**，负责监控硬件变化：

```bash
# 创建网络设备事件规则
# /etc/udev/rules.d/90-network-events.rules

# 网卡插入时启动服务
ACTION=="add", SUBSYSTEM=="net", KERNEL=="eth*", \
  RUN+="/bin/systemctl start network-dependent.service"

# 网卡移除时停止服务  
ACTION=="remove", SUBSYSTEM=="net", KERNEL=="eth*", \
  RUN+="/bin/systemctl stop network-dependent.service"
```

### 5.3 systemd路径单元监控


**监控网络配置文件变化**：
```ini
# /etc/systemd/system/network-config-monitor.path
[Unit]
Description=Network Configuration Monitor

[Path]
PathModified=/etc/systemd/network/      # 监控目录变化
Unit=network-reload.service             # 变化时启动的服务

[Install]
WantedBy=multi-user.target
```

**响应服务**：
```ini
# /etc/systemd/system/network-reload.service  
[Unit]
Description=Reload Network Configuration

[Service]
Type=oneshot
ExecStart=/bin/systemctl reload systemd-networkd
ExecStart=/usr/local/bin/update-dependent-services
```

### 5.4 网络状态脚本示例


**智能网络响应脚本**：
```bash
#!/bin/bash
# /usr/local/bin/network-state-handler.sh

INTERFACE="$1"
ACTION="$2"

case "$ACTION" in
    "up")
        echo "网络接口 $INTERFACE 已启动"
        # 启动网络依赖服务
        systemctl start web-server.service
        systemctl start database.service
        ;;
    "down")  
        echo "网络接口 $INTERFACE 已关闭"
        # 优雅停止服务
        systemctl stop web-server.service
        ;;
esac
```

---

## 6. 🤝 NetworkManager与systemd协作


### 6.1 两者的区别与选择


**简单对比**：
```
NetworkManager：
• 图形界面友好           • 适合桌面环境
• 自动化程度高           • WiFi管理优秀
• 插件生态丰富           • 移动设备支持好

systemd-networkd：
• 配置文件化管理         • 适合服务器环境  
• 资源占用少             • 启动速度快
• 与systemd深度集成      • 容器友好
```

> 🎯 **选择建议**：
> - **桌面环境**：推荐NetworkManager（用户体验好）
> - **服务器环境**：推荐systemd-networkd（简洁高效）

### 6.2 协作而非冲突的场景


**混合环境管理**：
```bash
# NetworkManager管理WiFi接口
# systemd-networkd管理有线接口

# NetworkManager配置排除有线接口
# /etc/NetworkManager/conf.d/10-ignore-wired.conf
[keyfile]
unmanaged-devices=interface-name:eth*
```

### 6.3 迁移策略


**从NetworkManager迁移到systemd-networkd**：

```bash
# 1. 备份现有配置
sudo cp -r /etc/NetworkManager /etc/NetworkManager.backup

# 2. 导出当前网络配置信息
nmcli connection show > network-backup.txt

# 3. 停用NetworkManager
sudo systemctl stop NetworkManager
sudo systemctl disable NetworkManager

# 4. 转换配置为systemd-networkd格式
# （手动创建对应的.network文件）

# 5. 启用systemd-networkd
sudo systemctl enable systemd-networkd
sudo systemctl start systemd-networkd
```

---

## 7. 🏆 网络服务依赖最佳实践


### 7.1 依赖关系设计原则


**层次化依赖**：
```
应用服务层     ← 业务应用（Web服务、数据库等）
    ↓ After=network-online.target
网络服务层     ← 网络连接就绪
    ↓ After=network.target  
网络配置层     ← 网络接口配置
    ↓ After=systemd-networkd.service
系统基础层     ← 系统基础服务
```

### 7.2 常见服务依赖模式


**Web服务器依赖**：
```ini
[Unit]
Description=Web Server
After=network-online.target
Wants=network-online.target

# 可选：等待特定端口可用
After=mysql.service
Wants=mysql.service

[Service]
ExecStart=/usr/bin/web-server
ExecStartPre=/usr/bin/wait-for-port 3306
Restart=on-failure
```

**数据库服务依赖**：
```ini
[Unit]  
Description=Database Server
After=network.target               # 基础网络即可
Wants=network.target
Before=web-server.service          # 在Web服务前启动

[Service]
ExecStart=/usr/bin/database-server
Type=notify
```

**备份服务依赖**：
```ini
[Unit]
Description=Daily Backup Service
After=network-online.target        # 需要外网连接
Requires=network-online.target     # 强制要求
OnFailure=backup-failed.service    # 失败时通知

[Service]
Type=oneshot
ExecStart=/usr/bin/backup-script
```

### 7.3 健康检查与自动恢复


**网络健康检查服务**：
```ini
# /etc/systemd/system/network-health-check.service
[Unit]
Description=Network Health Check
After=network-online.target

[Service]
Type=simple
ExecStart=/usr/local/bin/network-health-monitor.sh
Restart=always
RestartSec=30

[Install]
WantedBy=multi-user.target
```

**健康检查脚本**：
```bash
#!/bin/bash
# /usr/local/bin/network-health-monitor.sh

while true; do
    if ! ping -c 1 8.8.8.8 > /dev/null 2>&1; then
        echo "网络连接异常，重启网络服务"
        systemctl restart systemd-networkd
        sleep 10
        
        # 重启依赖服务
        systemctl restart web-server.service
    fi
    sleep 60
done
```

### 7.4 服务启动超时处理


**合理设置超时时间**：
```ini
[Unit]
Description=Network Dependent Service
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/usr/bin/my-service
TimeoutStartSec=60                # 启动超时60秒
TimeoutStopSec=30                 # 停止超时30秒
Restart=on-failure
RestartSec=10                     # 重启间隔10秒

[Install]
WantedBy=multi-user.target
```

### 7.5 日志记录与监控


**网络依赖服务日志配置**：
```ini
[Service]
StandardOutput=journal
StandardError=journal
SyslogIdentifier=my-network-service

# 在脚本中记录日志
ExecStartPre=/bin/bash -c 'echo "等待网络就绪..." | systemd-cat -t my-service'
```

**监控命令**：
```bash
# 查看网络相关服务状态
systemctl status systemd-networkd
systemctl status network-online.target

# 查看服务依赖关系
systemctl list-dependencies network-online.target

# 查看启动日志
journalctl -u systemd-networkd -f
journalctl -u my-network-service -f
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 systemd-networkd：systemd的网络管理组件，统一配置格式
🔸 三种文件类型：.network(配置)、.netdev(虚拟设备)、.link(硬件属性)  
🔸 网络目标层级：network.target → network-online.target
🔸 服务依赖关系：After、Wants、Requires的正确使用
🔸 动态响应机制：udev规则和路径监控实现自动化
🔸 最佳实践：分层依赖、健康检查、超时处理
```

### 8.2 关键理解要点


**🔹 网络管理的统一性**
```
systemd-networkd的价值在于：
• 配置统一化：避免不同发行版配置方式不同
• 服务集成化：与systemd服务管理深度融合  
• 自动化程度：减少手工干预，提高可靠性
```

**🔹 依赖关系的重要性**
```
正确的依赖设置可以：
• 避免服务启动失败
• 提高系统可靠性
• 简化故障排查
• 优化启动顺序
```

**🔹 动态响应的意义**
```
网络环境变化时：
• 自动调整服务状态
• 减少人工介入
• 提高服务可用性
• 适应复杂环境
```

### 8.3 实际应用指导


**新手学习路径**：
1. **基础配置**：先学会基本的.network文件编写
2. **服务依赖**：理解After、Wants的区别和用法
3. **状态监控**：熟练使用networkctl和systemctl命令
4. **高级特性**：掌握动态响应和健康检查

**常见应用场景**：
- **Web服务器**：确保网络就绪后启动HTTP服务
- **数据库服务**：网络配置完成后启动数据库
- **容器环境**：动态创建网桥和虚拟网络设备
- **云环境**：适应网络配置变化，自动调整服务

> 💡 **核心记忆**：
> systemd-networkd让网络配置变得**统一、自动、可靠**。
> 正确的服务依赖关系是系统稳定运行的基础。
> 动态响应机制让系统更加智能和自适应。