---
title: 9ã€Socketè¿›ç¨‹é—´é€šä¿¡
---
## ğŸ“š ç›®å½•

1. [Socketè¿›ç¨‹é—´é€šä¿¡æ¦‚è¿°](#1-socketè¿›ç¨‹é—´é€šä¿¡æ¦‚è¿°)
2. [UnixåŸŸå¥—æ¥å­—åŸºç¡€](#2-unixåŸŸå¥—æ¥å­—åŸºç¡€)
3. [æµå¼å¥—æ¥å­—vsæ•°æ®æŠ¥å¥—æ¥å­—](#3-æµå¼å¥—æ¥å­—vsæ•°æ®æŠ¥å¥—æ¥å­—)
4. [å¥—æ¥å­—åˆ›å»ºä¸ç»‘å®š](#4-å¥—æ¥å­—åˆ›å»ºä¸ç»‘å®š)
5. [å¥—æ¥å­—æ–‡ä»¶æƒé™ä¸å®‰å…¨](#5-å¥—æ¥å­—æ–‡ä»¶æƒé™ä¸å®‰å…¨)
6. [æ–‡ä»¶æè¿°ç¬¦ä¼ é€’æœºåˆ¶](#6-æ–‡ä»¶æè¿°ç¬¦ä¼ é€’æœºåˆ¶)
7. [å¥—æ¥å­—ç¼“å†²åŒºä¸æ€§èƒ½ä¼˜åŒ–](#7-å¥—æ¥å­—ç¼“å†²åŒºä¸æ€§èƒ½ä¼˜åŒ–)
8. [éé˜»å¡I/Oä¸å¤šè·¯å¤ç”¨](#8-éé˜»å¡ioä¸å¤šè·¯å¤ç”¨)
9. [å¥—æ¥å­—åœ°å€ç»“æ„è¯¦è§£](#9-å¥—æ¥å­—åœ°å€ç»“æ„è¯¦è§£)
10. [å¥—æ¥å­—é€‰é¡¹é…ç½®](#10-å¥—æ¥å­—é€‰é¡¹é…ç½®)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”— Socketè¿›ç¨‹é—´é€šä¿¡æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Socketè¿›ç¨‹é—´é€šä¿¡


**ğŸ¯ é€šä¿—ç†è§£**ï¼š
Socket IPCå°±åƒæ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸Šä¸ºè¿›ç¨‹ä¹‹é—´å»ºç«‹ä¸€æ¡"ä¸“ç”¨é€šä¿¡ç®¡é“"ã€‚æƒ³è±¡ä¸¤ä¸ªç¨‹åºéœ€è¦äº¤æ¢æ•°æ®ï¼ŒSocketå°±æ˜¯å®ƒä»¬ä¹‹é—´çš„"å¯¹è¯æ¡¥æ¢"ã€‚

```
è¿›ç¨‹A                    è¿›ç¨‹B
  |                        |
  |------ Socketé€šä¿¡ ------|
  |     (æ•°æ®ä¼ è¾“)        |
  
å°±åƒä¸¤äººé€šè¿‡å¯¹è®²æœºé€šè¯ä¸€æ ·
```

**ğŸ’¡ æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- **åŒå‘é€šä¿¡**ï¼šæ•°æ®å¯ä»¥åœ¨ä¸¤ä¸ªæ–¹å‘ä¸ŠæµåŠ¨
- **å¯é ä¼ è¾“**ï¼šæ•°æ®ä¸ä¼šä¸¢å¤±æˆ–æŸå
- **çµæ´»æ€§å¼º**ï¼šæ”¯æŒå¤šç§é€šä¿¡æ¨¡å¼
- **è·¨è¯­è¨€**ï¼šä¸åŒç¼–ç¨‹è¯­è¨€å†™çš„ç¨‹åºéƒ½èƒ½ä½¿ç”¨

### 1.2 Socket IPCçš„ä¼˜åŠ¿


**ğŸ”¸ ç›¸æ¯”å…¶ä»–IPCæ–¹å¼çš„ä¼˜åŠ¿**ï¼š

| é€šä¿¡æ–¹å¼ | **é€Ÿåº¦** | **æ•°æ®é‡** | **ä½¿ç”¨å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|-----------|---------------|------------|
| **ç®¡é“** | `å¿«` | `å°` | `ç®€å•` | `ç®€å•æ•°æ®äº¤æ¢` |
| **å…±äº«å†…å­˜** | `æå¿«` | `å¤§` | `å¤æ‚` | `é«˜æ€§èƒ½è®¡ç®—` |
| **Socket** | `ä¸­ç­‰` | `å¤§` | `ä¸­ç­‰` | `ç½‘ç»œåŒ–åº”ç”¨` |
| **æ¶ˆæ¯é˜Ÿåˆ—** | `ä¸­ç­‰` | `ä¸­` | `ä¸­ç­‰` | `å¼‚æ­¥é€šä¿¡` |

> ğŸ’¡ **Socketçš„ç‹¬ç‰¹ä¼˜åŠ¿**ï¼šæ—¢èƒ½åšæœ¬åœ°é€šä¿¡ï¼Œåˆèƒ½æ‰©å±•åˆ°ç½‘ç»œé€šä¿¡ï¼Œä»£ç åŸºæœ¬ä¸ç”¨æ”¹

---

## 2. ğŸ  UnixåŸŸå¥—æ¥å­—åŸºç¡€


### 2.1 ä»€ä¹ˆæ˜¯UnixåŸŸå¥—æ¥å­—


**ğŸ¯ ç®€å•ç†è§£**ï¼š
UnixåŸŸå¥—æ¥å­—ï¼ˆUnix Domain Socketï¼‰æ˜¯ä¸“é—¨ç”¨äºåŒä¸€å°æœºå™¨ä¸Šè¿›ç¨‹é€šä¿¡çš„ç‰¹æ®Šå¥—æ¥å­—ï¼Œå°±åƒæ˜¯"æœ¬åœ°ä¸“çº¿ç”µè¯"ã€‚

```
ç½‘ç»œå¥—æ¥å­—ï¼š     è¿›ç¨‹A â†â†’ ç½‘ç»œ â†â†’ è¿›ç¨‹B (å¯èƒ½åœ¨ä¸åŒæœºå™¨)
UnixåŸŸå¥—æ¥å­—ï¼š   è¿›ç¨‹A â†â†’ å†…æ ¸ â†â†’ è¿›ç¨‹B (åŒä¸€å°æœºå™¨)
```

**ğŸ”¸ æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **é€Ÿåº¦æ›´å¿«**ï¼šä¸èµ°ç½‘ç»œåè®®æ ˆï¼Œç›´æ¥åœ¨å†…æ ¸ä¸­ä¼ è¾“
- **æ›´å®‰å…¨**ï¼šæ•°æ®ä¸ä¼šç¦»å¼€æœ¬æœºï¼Œæ— ç½‘ç»œæ³„éœ²é£é™©
- **æƒé™æ§åˆ¶**ï¼šå¯ä»¥åˆ©ç”¨æ–‡ä»¶ç³»ç»Ÿæƒé™æ§åˆ¶è®¿é—®

### 2.2 UnixåŸŸå¥—æ¥å­—çš„å·¥ä½œåŸç†


**ğŸ“Š å·¥ä½œæµç¨‹å›¾**ï¼š
```
å®¢æˆ·ç«¯è¿›ç¨‹                     æœåŠ¡ç«¯è¿›ç¨‹
    |                            |
    |--[1]åˆ›å»ºsocket----------->  |
    |                           |--[2]åˆ›å»ºsocket
    |--[3]connect()----------->  |
    |                           |<-[4]bind()+listen()
    |<--[5]accept()-------------|
    |                            |
    |===[6]æ•°æ®ä¼ è¾“é˜¶æ®µ]========|
    |                            |
    |--[7]close()------------->  |
    |                           |--[8]close()
```

**ğŸ’¡ å…³é”®ç†è§£**ï¼š
- æœåŠ¡ç«¯åˆ›å»ºä¸€ä¸ª"ç›‘å¬ç‚¹"ï¼ˆåƒåº—é“ºå¼€é—¨è¥ä¸šï¼‰
- å®¢æˆ·ç«¯ä¸»åŠ¨è¿æ¥è¿™ä¸ª"ç›‘å¬ç‚¹"ï¼ˆåƒé¡¾å®¢è¿›åº—ï¼‰
- è¿æ¥å»ºç«‹åï¼ŒåŒæ–¹å°±å¯ä»¥è‡ªç”±äº¤æ¢æ•°æ®äº†

### 2.3 å¥—æ¥å­—æ–‡ä»¶çš„æœ¬è´¨


**ğŸ”¸ å¥—æ¥å­—æ–‡ä»¶ç‰¹ç‚¹**ï¼š
```bash
# æŸ¥çœ‹å¥—æ¥å­—æ–‡ä»¶
$ ls -la /tmp/mysocket
srwxrwxrwx 1 user group 0 Sep 14 10:30 /tmp/mysocket
# â†‘æ³¨æ„å¼€å¤´çš„'s'ï¼Œè¡¨ç¤ºè¿™æ˜¯socketæ–‡ä»¶
```

> ğŸ“ **é‡è¦æ¦‚å¿µ**ï¼šå¥—æ¥å­—æ–‡ä»¶ä¸å­˜å‚¨æ•°æ®ï¼Œåªæ˜¯ä¸€ä¸ª"é€šä¿¡å…¥å£æ ‡è¯†"ï¼Œå°±åƒé—¨ç‰Œå·ä¸€æ ·

---

## 3. ğŸ”„ æµå¼å¥—æ¥å­—vsæ•°æ®æŠ¥å¥—æ¥å­—


### 3.1 æµå¼å¥—æ¥å­—ï¼ˆSOCK_STREAMï¼‰


**ğŸ¯ é€šä¿—æ¯”å–»**ï¼šå°±åƒæ‰“ç”µè¯ï¼Œå»ºç«‹è¿æ¥åå¯ä»¥æŒç»­å¯¹è¯ã€‚

**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- **é¢å‘è¿æ¥**ï¼šé€šä¿¡å‰å¿…é¡»å»ºç«‹è¿æ¥
- **æ•°æ®å¯é **ï¼šä¿è¯æ•°æ®å®Œæ•´ã€æœ‰åºåˆ°è¾¾
- **åŒå‘é€šä¿¡**ï¼šç±»ä¼¼ç”µè¯ï¼Œä¸¤è¾¹éƒ½èƒ½è¯´è¯
- **æµå¼ä¼ è¾“**ï¼šæ•°æ®åƒæ°´æµä¸€æ ·è¿ç»­ä¼ è¾“

```c
// åˆ›å»ºæµå¼å¥—æ¥å­—ç¤ºä¾‹
int sock = socket(AF_UNIX, SOCK_STREAM, 0);
```

**ğŸ“Š æ•°æ®ä¼ è¾“ç‰¹ç‚¹**ï¼š
```
å‘é€ç«¯ï¼š  [Hello][World][123]
æ¥æ”¶ç«¯ï¼š  HelloWorld123  (æ•°æ®å¯èƒ½åˆå¹¶æ¥æ”¶)

ç‰¹ç‚¹ï¼šæ•°æ®è¾¹ç•Œä¸ä¿ç•™ï¼Œéœ€è¦åº”ç”¨å±‚è‡ªå·±å¤„ç†åˆ†éš”
```

### 3.2 æ•°æ®æŠ¥å¥—æ¥å­—ï¼ˆSOCK_DGRAMï¼‰


**ğŸ¯ é€šä¿—æ¯”å–»**ï¼šå°±åƒå‘çŸ­ä¿¡ï¼Œä¸€æ¡ä¸€æ¡ç‹¬ç«‹å‘é€ã€‚

**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- **æ— è¿æ¥**ï¼šå‘é€å‰ä¸éœ€è¦å»ºç«‹è¿æ¥
- **æ¶ˆæ¯è¾¹ç•Œ**ï¼šæ¯ä¸ªæ¶ˆæ¯éƒ½æ˜¯ç‹¬ç«‹å®Œæ•´çš„
- **ä¸ä¿è¯åˆ°è¾¾**ï¼šæ¶ˆæ¯å¯èƒ½ä¸¢å¤±ï¼ˆåœ¨UnixåŸŸä¸­å¾ˆå°‘å‘ç”Ÿï¼‰
- **ç®€å•å¿«é€Ÿ**ï¼šæ²¡æœ‰è¿æ¥å¼€é”€

```c
// åˆ›å»ºæ•°æ®æŠ¥å¥—æ¥å­—ç¤ºä¾‹
int sock = socket(AF_UNIX, SOCK_DGRAM, 0);
```

**ğŸ“Š æ•°æ®ä¼ è¾“ç‰¹ç‚¹**ï¼š
```
å‘é€ç«¯ï¼š  [Hello] [World] [123]
æ¥æ”¶ç«¯ï¼š  [Hello] [World] [123]  (æ¶ˆæ¯è¾¹ç•Œä¿ç•™)

ç‰¹ç‚¹ï¼šä¸€æ¬¡å‘é€ï¼Œä¸€æ¬¡æ¥æ”¶ï¼Œæ¶ˆæ¯å®Œæ•´æ€§ä¿è¯
```

### 3.3 é€‰æ‹©å“ªç§å¥—æ¥å­—ï¼Ÿ


> ğŸ’¡ **é€‰æ‹©å»ºè®®**ï¼š

**é€‰æ‹©æµå¼å¥—æ¥å­—ï¼ˆSOCK_STREAMï¼‰å½“**ï¼š
- âœ… éœ€è¦å¯é çš„æ•°æ®ä¼ è¾“
- âœ… æ•°æ®é‡è¾ƒå¤§
- âœ… éœ€è¦é•¿æ—¶é—´æŒç»­é€šä¿¡
- âœ… ä¾‹å¦‚ï¼šæ•°æ®åº“è¿æ¥ã€æ–‡ä»¶ä¼ è¾“

**é€‰æ‹©æ•°æ®æŠ¥å¥—æ¥å­—ï¼ˆSOCK_DGRAMï¼‰å½“**ï¼š
- âœ… æ¶ˆæ¯ç‹¬ç«‹ä¸”ç®€çŸ­
- âœ… ä¸éœ€è¦å»ºç«‹è¿æ¥çš„å¼€é”€
- âœ… å‘é€é¢‘ç‡ä¸é«˜
- âœ… ä¾‹å¦‚ï¼šçŠ¶æ€é€šçŸ¥ã€ç®€å•å‘½ä»¤

---

## 4. ğŸ› ï¸ å¥—æ¥å­—åˆ›å»ºä¸ç»‘å®š


### 4.1 å¥—æ¥å­—åˆ›å»ºè¿‡ç¨‹


**ğŸ“‹ åŸºæœ¬åˆ›å»ºæ­¥éª¤**ï¼š

```c
#include <sys/socket.h>
#include <sys/un.h>

// ç¬¬1æ­¥ï¼šåˆ›å»ºå¥—æ¥å­—
int server_sock = socket(AF_UNIX, SOCK_STREAM, 0);
if (server_sock == -1) {
    perror("socketåˆ›å»ºå¤±è´¥");
    exit(1);
}
```

**ğŸ”¸ å‚æ•°è§£é‡Š**ï¼š
- `AF_UNIX`ï¼šè¡¨ç¤ºUnixåŸŸå¥—æ¥å­—ï¼ˆæœ¬åœ°é€šä¿¡ï¼‰
- `SOCK_STREAM`ï¼šæµå¼å¥—æ¥å­—ï¼ˆå¯é è¿æ¥ï¼‰
- `0`ï¼šåè®®å‚æ•°ï¼ˆUnixåŸŸå¥—æ¥å­—é€šå¸¸ä¸º0ï¼‰

### 4.2 åœ°å€ç»“æ„ä¸ç»‘å®š


**ğŸ“Š åœ°å€ç»“æ„è®¾ç½®**ï¼š

```c
struct sockaddr_un server_addr;
memset(&server_addr, 0, sizeof(server_addr));

// è®¾ç½®åœ°å€æ—
server_addr.sun_family = AF_UNIX;

// è®¾ç½®å¥—æ¥å­—æ–‡ä»¶è·¯å¾„
strcpy(server_addr.sun_path, "/tmp/my_socket");
```

**ğŸ”¸ ç»‘å®šæ“ä½œ**ï¼š

```c
// ç¡®ä¿æ—§çš„å¥—æ¥å­—æ–‡ä»¶ä¸å­˜åœ¨
unlink("/tmp/my_socket");

// ç»‘å®šåœ°å€åˆ°å¥—æ¥å­—
if (bind(server_sock, (struct sockaddr*)&server_addr, 
         sizeof(server_addr)) == -1) {
    perror("ç»‘å®šå¤±è´¥");
    close(server_sock);
    exit(1);
}
```

> âš ï¸ **é‡è¦æé†’**ï¼šç»‘å®šå‰è¦å…ˆ`unlink()`åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§å¥—æ¥å­—æ–‡ä»¶

### 4.3 å®Œæ•´çš„æœåŠ¡ç«¯åˆ›å»ºç¤ºä¾‹


```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/socket.h>
#include <sys/un.h>

int create_server_socket(const char* path) {
    int sock;
    struct sockaddr_un addr;
    
    // åˆ›å»ºå¥—æ¥å­—
    sock = socket(AF_UNIX, SOCK_STREAM, 0);
    if (sock == -1) return -1;
    
    // è®¾ç½®åœ°å€
    memset(&addr, 0, sizeof(addr));
    addr.sun_family = AF_UNIX;
    strcpy(addr.sun_path, path);
    
    // åˆ é™¤æ—§æ–‡ä»¶å¹¶ç»‘å®š
    unlink(path);
    if (bind(sock, (struct sockaddr*)&addr, sizeof(addr)) == -1) {
        close(sock);
        return -1;
    }
    
    // å¼€å§‹ç›‘å¬
    if (listen(sock, 5) == -1) {
        close(sock);
        unlink(path);
        return -1;
    }
    
    return sock;
}
```

### 4.4 å®¢æˆ·ç«¯è¿æ¥ç¤ºä¾‹


```c
int connect_to_server(const char* path) {
    int sock;
    struct sockaddr_un addr;
    
    // åˆ›å»ºå¥—æ¥å­—
    sock = socket(AF_UNIX, SOCK_STREAM, 0);
    if (sock == -1) return -1;
    
    // è®¾ç½®æœåŠ¡ç«¯åœ°å€
    memset(&addr, 0, sizeof(addr));
    addr.sun_family = AF_UNIX;
    strcpy(addr.sun_path, path);
    
    // è¿æ¥åˆ°æœåŠ¡ç«¯
    if (connect(sock, (struct sockaddr*)&addr, sizeof(addr)) == -1) {
        close(sock);
        return -1;
    }
    
    return sock;
}
```

---

## 5. ğŸ” å¥—æ¥å­—æ–‡ä»¶æƒé™ä¸å®‰å…¨


### 5.1 å¥—æ¥å­—æ–‡ä»¶æƒé™åŸºç¡€


**ğŸ¯ æ ¸å¿ƒç†è§£**ï¼š
å¥—æ¥å­—æ–‡ä»¶çš„æƒé™å°±åƒæˆ¿å±‹çš„é—¨ç¦ç³»ç»Ÿï¼Œæ§åˆ¶å“ªäº›ç”¨æˆ·å’Œè¿›ç¨‹å¯ä»¥"è¿›å…¥"è¿›è¡Œé€šä¿¡ã€‚

**ğŸ“‹ æƒé™ç±»å‹**ï¼š
```bash
# æŸ¥çœ‹å¥—æ¥å­—æ–‡ä»¶æƒé™
$ ls -la /tmp/mysocket
srwxrwxrwx 1 user group 0 Sep 14 10:30 /tmp/mysocket
# |||||||
# |||||++-- å…¶ä»–ç”¨æˆ·æƒé™ (rwx)
# ||+++---- ç”¨æˆ·ç»„æƒé™ (rwx)  
# |+------- æ–‡ä»¶æ‰€æœ‰è€…æƒé™ (rwx)
# +-------- æ–‡ä»¶ç±»å‹ (s=socket)
```

**ğŸ”¸ æƒé™å«ä¹‰**ï¼š
- **rï¼ˆè¯»ï¼‰**ï¼šå¯ä»¥ä»å¥—æ¥å­—æ¥æ”¶æ•°æ®
- **wï¼ˆå†™ï¼‰**ï¼šå¯ä»¥å‘å¥—æ¥å­—å‘é€æ•°æ®  
- **xï¼ˆæ‰§è¡Œï¼‰**ï¼šå¯ä»¥è¿æ¥åˆ°å¥—æ¥å­—

### 5.2 è®¾ç½®å¥—æ¥å­—æƒé™


**ğŸ“Š æƒé™è®¾ç½®æ–¹æ³•**ï¼š

```c
// æ–¹æ³•1ï¼šåˆ›å»ºåè®¾ç½®æƒé™
int sock = socket(AF_UNIX, SOCK_STREAM, 0);
// ... ç»‘å®šæ“ä½œ ...
chmod("/tmp/mysocket", 0660);  // åªå…è®¸æ‰€æœ‰è€…å’Œç»„è®¿é—®
```

```c
// æ–¹æ³•2ï¼šä½¿ç”¨umaskæ§åˆ¶é»˜è®¤æƒé™
umask(0007);  // ç¦æ­¢å…¶ä»–ç”¨æˆ·è®¿é—®
int sock = socket(AF_UNIX, SOCK_STREAM, 0);
// ... ç»‘å®šæ“ä½œ ...
```

**ğŸ”¸ å¸¸ç”¨æƒé™è®¾ç½®**ï¼š

| æƒé™å€¼ | **å«ä¹‰** | **é€‚ç”¨åœºæ™¯** |
|--------|---------|-------------|
| `0600` | `ä»…æ‰€æœ‰è€…å¯è¯»å†™` | `ç§å¯†é€šä¿¡` |
| `0660` | `æ‰€æœ‰è€…å’Œç»„å¯è¯»å†™` | `å›¢é˜Ÿå†…éƒ¨é€šä¿¡` |
| `0666` | `æ‰€æœ‰ç”¨æˆ·å¯è¯»å†™` | `å…¬å…±æœåŠ¡` |
| `0644` | `æ‰€æœ‰è€…è¯»å†™ï¼Œå…¶ä»–åªè¯»` | `åªè¯»æœåŠ¡` |

### 5.3 å®‰å…¨æ³¨æ„äº‹é¡¹


> âš ï¸ **å®‰å…¨è¦ç‚¹**ï¼š

**ğŸ”¸ æ–‡ä»¶ä½ç½®å®‰å…¨**ï¼š
```c
// âŒ ä¸å®‰å…¨ï¼šæ”¾åœ¨å…¬å…±ç›®å½•
strcpy(addr.sun_path, "/tmp/mysocket");

// âœ… æ›´å®‰å…¨ï¼šæ”¾åœ¨å—ä¿æŠ¤çš„ç›®å½•
strcpy(addr.sun_path, "/var/run/myapp/socket");
mkdir("/var/run/myapp", 0750);  // åˆ›å»ºå—ä¿æŠ¤ç›®å½•
```

**ğŸ”¸ æƒé™æœ€å°åŒ–åŸåˆ™**ï¼š
```c
// åˆ›å»ºåç«‹å³è®¾ç½®ä¸¥æ ¼æƒé™
bind(sock, (struct sockaddr*)&addr, sizeof(addr));
chmod(addr.sun_path, 0600);  // ä»…æ‰€æœ‰è€…è®¿é—®
```

**ğŸ”¸ æ¸…ç†å¥—æ¥å­—æ–‡ä»¶**ï¼š
```c
// ç¨‹åºé€€å‡ºæ—¶æ¸…ç†
void cleanup() {
    unlink("/tmp/mysocket");
}

// æ³¨å†Œæ¸…ç†å‡½æ•°
atexit(cleanup);
```

---

## 6. ğŸ“¤ æ–‡ä»¶æè¿°ç¬¦ä¼ é€’æœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯æ–‡ä»¶æè¿°ç¬¦ä¼ é€’


**ğŸ¯ é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ æœ‰ä¸€æŠŠæˆ¿å±‹é’¥åŒ™ï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰ï¼Œä½ å¯ä»¥é€šè¿‡SocketæŠŠè¿™æŠŠ"é’¥åŒ™"ä¼ é€’ç»™å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œè®©å®ƒä¹Ÿèƒ½æ‰“å¼€åŒä¸€ä¸ª"æˆ¿å­"ï¼ˆæ–‡ä»¶ï¼‰ã€‚

```
è¿›ç¨‹A                    è¿›ç¨‹B
  |                        |
  |--[ä¼ é€’fd=5]----------->|
  |  (æŒ‡å‘æŸä¸ªæ–‡ä»¶)         |--ç°åœ¨è¿›ç¨‹Bä¹Ÿèƒ½
  |                        |  è®¿é—®åŒä¸€ä¸ªæ–‡ä»¶
```

**ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯**ï¼š
- **æƒé™ä»£ç†**ï¼šé«˜æƒé™è¿›ç¨‹æ‰“å¼€æ–‡ä»¶åï¼Œä¼ é€’ç»™ä½æƒé™è¿›ç¨‹ä½¿ç”¨
- **è¿æ¥ä¼ é€’**ï¼šWebæœåŠ¡å™¨æ¥å—è¿æ¥åï¼Œä¼ é€’ç»™å·¥ä½œè¿›ç¨‹å¤„ç†
- **èµ„æºå…±äº«**ï¼šå¤šä¸ªè¿›ç¨‹å…±äº«åŒä¸€ä¸ªæ–‡ä»¶æˆ–è®¾å¤‡

### 6.2 SCM_RIGHTSæœºåˆ¶è¯¦è§£


**ğŸ”¸ æŠ€æœ¯åŸç†**ï¼š
`SCM_RIGHTS`æ˜¯Linuxæä¾›çš„ç‰¹æ®Šæœºåˆ¶ï¼Œå…è®¸é€šè¿‡UnixåŸŸå¥—æ¥å­—ä¼ é€’æ–‡ä»¶æè¿°ç¬¦ã€‚

**ğŸ“Š ä¼ é€’è¿‡ç¨‹å›¾**ï¼š
```
è¿›ç¨‹A                     å†…æ ¸                    è¿›ç¨‹B
  |                        |                        |
  |--[sendmsg+SCM_RIGHTS]->|                        |
  |   fd=5                 |--[å†…æ ¸å¤„ç†]            |
  |                        |--[å¤åˆ¶æ–‡ä»¶è¡¨é¡¹]        |
  |                        |                     <--|--[recvmsg]
  |                        |                        |  å¾—åˆ°æ–°çš„fd=7
  |                        |                        |  (æŒ‡å‘åŒä¸€æ–‡ä»¶)
```

### 6.3 å‘é€æ–‡ä»¶æè¿°ç¬¦ä»£ç ç¤ºä¾‹


```c
#include <sys/socket.h>
#include <sys/un.h>

// å‘é€æ–‡ä»¶æè¿°ç¬¦
int send_fd(int socket_fd, int fd_to_send) {
    struct msghdr msg = {0};
    struct iovec iov[1];
    struct cmsghdr *cmsg;
    char buf[CMSG_SPACE(sizeof(int))];
    char dummy = 'X';  // å¿…é¡»å‘é€ä¸€äº›æ•°æ®
    
    // è®¾ç½®æ™®é€šæ•°æ®
    iov[0].iov_base = &dummy;
    iov[0].iov_len = 1;
    msg.msg_iov = iov;
    msg.msg_iovlen = 1;
    
    // è®¾ç½®æ§åˆ¶æ•°æ®
    msg.msg_control = buf;
    msg.msg_controllen = sizeof(buf);
    
    // è®¾ç½®æ–‡ä»¶æè¿°ç¬¦æ•°æ®
    cmsg = CMSG_FIRSTHDR(&msg);
    cmsg->cmsg_level = SOL_SOCKET;
    cmsg->cmsg_type = SCM_RIGHTS;
    cmsg->cmsg_len = CMSG_LEN(sizeof(int));
    memcpy(CMSG_DATA(cmsg), &fd_to_send, sizeof(int));
    
    // å‘é€
    return sendmsg(socket_fd, &msg, 0);
}
```

### 6.4 æ¥æ”¶æ–‡ä»¶æè¿°ç¬¦ä»£ç ç¤ºä¾‹


```c
// æ¥æ”¶æ–‡ä»¶æè¿°ç¬¦
int receive_fd(int socket_fd) {
    struct msghdr msg = {0};
    struct iovec iov[1];
    struct cmsghdr *cmsg;
    char buf[CMSG_SPACE(sizeof(int))];
    char dummy;
    int received_fd = -1;
    
    // è®¾ç½®æ¥æ”¶ç¼“å†²åŒº
    iov[0].iov_base = &dummy;
    iov[0].iov_len = 1;
    msg.msg_iov = iov;
    msg.msg_iovlen = 1;
    msg.msg_control = buf;
    msg.msg_controllen = sizeof(buf);
    
    // æ¥æ”¶æ¶ˆæ¯
    if (recvmsg(socket_fd, &msg, 0) <= 0) {
        return -1;
    }
    
    // æå–æ–‡ä»¶æè¿°ç¬¦
    cmsg = CMSG_FIRSTHDR(&msg);
    if (cmsg && cmsg->cmsg_type == SCM_RIGHTS) {
        memcpy(&received_fd, CMSG_DATA(cmsg), sizeof(int));
    }
    
    return received_fd;
}
```

### 6.5 å®é™…åº”ç”¨ç¤ºä¾‹


**ğŸ› ï¸ WebæœåŠ¡å™¨è¿æ¥ä¼ é€’**ï¼š

```c
// ä¸»è¿›ç¨‹ï¼šæ¥å—è¿æ¥å¹¶ä¼ é€’ç»™å·¥ä½œè¿›ç¨‹
void master_process() {
    int listen_fd = create_server_socket();
    int worker_sock = connect_to_worker();
    
    while (1) {
        // æ¥å—æ–°è¿æ¥
        int client_fd = accept(listen_fd, NULL, NULL);
        if (client_fd > 0) {
            // ä¼ é€’ç»™å·¥ä½œè¿›ç¨‹å¤„ç†
            send_fd(worker_sock, client_fd);
            close(client_fd);  // ä¸»è¿›ç¨‹å…³é—­ï¼Œä½†å·¥ä½œè¿›ç¨‹ä»å¯ä½¿ç”¨
        }
    }
}

// å·¥ä½œè¿›ç¨‹ï¼šæ¥æ”¶è¿æ¥å¹¶å¤„ç†
void worker_process() {
    int master_sock = connect_to_master();
    
    while (1) {
        // æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥
        int client_fd = receive_fd(master_sock);
        if (client_fd > 0) {
            handle_client(client_fd);  // å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
            close(client_fd);
        }
    }
}
```

---

## 7. ğŸ“Š å¥—æ¥å­—ç¼“å†²åŒºä¸æ€§èƒ½ä¼˜åŒ–


### 7.1 å¥—æ¥å­—ç¼“å†²åŒºåŸç†


**ğŸ¯ é€šä¿—ç†è§£**ï¼š
å¥—æ¥å­—ç¼“å†²åŒºå°±åƒæ˜¯é€šä¿¡ç®¡é“ä¸­çš„"ä¸´æ—¶å­˜å‚¨ä»“åº“"ã€‚å‘é€çš„æ•°æ®å…ˆæ”¾åœ¨å‘é€ç¼“å†²åŒºï¼Œæ¥æ”¶çš„æ•°æ®å…ˆæ”¾åœ¨æ¥æ”¶ç¼“å†²åŒºã€‚

```
è¿›ç¨‹A                     å†…æ ¸                     è¿›ç¨‹B
  |                        |                        |
  |--[å†™æ•°æ®]-->å‘é€ç¼“å†²åŒº->|->æ¥æ”¶ç¼“å†²åŒº--[è¯»æ•°æ®]<--|
  |             â†“          |    â†“                   |
  |           æ»¡äº†åˆ™é˜»å¡    |  æ»¡äº†åˆ™ä¸¢å¼ƒ/é˜»å¡       |
```

**ğŸ”¸ ç¼“å†²åŒºä½œç”¨**ï¼š
- **æé«˜æ•ˆç‡**ï¼šå‡å°‘ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°
- **å¹³æ»‘æ•°æ®æµ**ï¼šå¤„ç†å‘é€å’Œæ¥æ”¶é€Ÿåº¦ä¸åŒ¹é…
- **ä¸´æ—¶å­˜å‚¨**ï¼šç½‘ç»œå»¶è¿Ÿæ—¶ç¼“å­˜æ•°æ®

### 7.2 æŸ¥çœ‹å’Œè®¾ç½®ç¼“å†²åŒºå¤§å°


**ğŸ“Š æŸ¥çœ‹å½“å‰ç¼“å†²åŒºå¤§å°**ï¼š

```c
#include <sys/socket.h>

void check_buffer_size(int sock) {
    int send_buf, recv_buf;
    socklen_t len = sizeof(int);
    
    // è·å–å‘é€ç¼“å†²åŒºå¤§å°
    getsockopt(sock, SOL_SOCKET, SO_SNDBUF, &send_buf, &len);
    printf("å‘é€ç¼“å†²åŒºå¤§å°: %d å­—èŠ‚\n", send_buf);
    
    // è·å–æ¥æ”¶ç¼“å†²åŒºå¤§å°  
    getsockopt(sock, SOL_SOCKET, SO_RCVBUF, &recv_buf, &len);
    printf("æ¥æ”¶ç¼“å†²åŒºå¤§å°: %d å­—èŠ‚\n", recv_buf);
}
```

**ğŸ”§ è®¾ç½®ç¼“å†²åŒºå¤§å°**ï¼š

```c
void optimize_buffer_size(int sock) {
    int new_size = 64 * 1024;  // 64KB
    
    // è®¾ç½®å‘é€ç¼“å†²åŒº
    if (setsockopt(sock, SOL_SOCKET, SO_SNDBUF, 
                   &new_size, sizeof(new_size)) == -1) {
        perror("è®¾ç½®å‘é€ç¼“å†²åŒºå¤±è´¥");
    }
    
    // è®¾ç½®æ¥æ”¶ç¼“å†²åŒº
    if (setsockopt(sock, SOL_SOCKET, SO_RCVBUF,
                   &new_size, sizeof(new_size)) == -1) {
        perror("è®¾ç½®æ¥æ”¶ç¼“å†²åŒºå¤±è´¥");
    }
}
```

### 7.3 ç¼“å†²åŒºå¤§å°é€‰æ‹©ç­–ç•¥


**ğŸ’¡ é€‰æ‹©åŸåˆ™**ï¼š

| åº”ç”¨åœºæ™¯ | **å»ºè®®ç¼“å†²åŒºå¤§å°** | **åŸå› ** |
|---------|------------------|---------|
| **å°æ¶ˆæ¯é¢‘ç¹** | `8KB - 16KB` | `å‡å°‘å†…å­˜å ç”¨` |
| **å¤§æ–‡ä»¶ä¼ è¾“** | `64KB - 128KB` | `æé«˜ä¼ è¾“æ•ˆç‡` |
| **å®æ—¶åº”ç”¨** | `4KB - 8KB` | `é™ä½å»¶è¿Ÿ` |
| **æ‰¹é‡æ•°æ®** | `128KB+` | `æœ€å¤§åŒ–ååé‡` |

**ğŸ”¸ åŠ¨æ€è°ƒä¼˜ç¤ºä¾‹**ï¼š

```c
void auto_tune_buffer(int sock, int data_size) {
    int optimal_size;
    
    if (data_size < 1024) {
        optimal_size = 8 * 1024;      // 8KB for small data
    } else if (data_size < 64 * 1024) {
        optimal_size = 32 * 1024;     // 32KB for medium data  
    } else {
        optimal_size = 128 * 1024;    // 128KB for large data
    }
    
    setsockopt(sock, SOL_SOCKET, SO_SNDBUF, &optimal_size, sizeof(optimal_size));
    setsockopt(sock, SOL_SOCKET, SO_RCVBUF, &optimal_size, sizeof(optimal_size));
}
```

### 7.4 æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜


**ğŸ“Š æ€§èƒ½ç›‘æ§ä»£ç **ï¼š

```c
#include <time.h>

typedef struct {
    size_t bytes_sent;
    size_t bytes_received;
    time_t start_time;
    int send_errors;
    int recv_errors;
} socket_stats_t;

void update_send_stats(socket_stats_t *stats, ssize_t bytes) {
    if (bytes > 0) {
        stats->bytes_sent += bytes;
    } else {
        stats->send_errors++;
    }
}

void print_performance_stats(socket_stats_t *stats) {
    time_t duration = time(NULL) - stats->start_time;
    if (duration > 0) {
        printf("ä¼ è¾“æ€§èƒ½ç»Ÿè®¡:\n");
        printf("  å‘é€: %zu bytes (%.2f KB/s)\n", 
               stats->bytes_sent, 
               (double)stats->bytes_sent / duration / 1024);
        printf("  æ¥æ”¶: %zu bytes (%.2f KB/s)\n",
               stats->bytes_received,
               (double)stats->bytes_received / duration / 1024);
        printf("  é”™è¯¯: å‘é€ %d æ¬¡, æ¥æ”¶ %d æ¬¡\n",
               stats->send_errors, stats->recv_errors);
    }
}
```

---

## 8. ğŸš€ éé˜»å¡I/Oä¸å¤šè·¯å¤ç”¨


### 8.1 é˜»å¡vséé˜»å¡I/O


**ğŸ¯ é€šä¿—æ¯”å–»**ï¼š
- **é˜»å¡I/O**ï¼šå°±åƒåœ¨é“¶è¡Œæ’é˜Ÿï¼Œå¿…é¡»ç­‰å‰é¢çš„äººåŠå®Œæ‰èƒ½è½®åˆ°ä½ 
- **éé˜»å¡I/O**ï¼šå°±åƒç½‘ä¸Šé¢„çº¦ï¼Œä¸ç”¨ç­‰å¾…ï¼Œæœ‰ç»“æœäº†å†é€šçŸ¥ä½ 

**ğŸ“Š å¯¹æ¯”å›¾**ï¼š
```
é˜»å¡I/O:
è¿›ç¨‹è°ƒç”¨read() -> ç­‰å¾…æ•°æ® -> æ•°æ®åˆ°è¾¾ -> è¿”å›æ•°æ®
      |           â†“              â†‘
      +----------(é˜»å¡ç­‰å¾…)--------+

éé˜»å¡I/O:
è¿›ç¨‹è°ƒç”¨read() -> ç«‹å³è¿”å›EAGAIN -> ç»§ç»­å…¶ä»–å·¥ä½œ
      |              â†“
      +------ç¨åå†æ¬¡å°è¯•read()
```

### 8.2 è®¾ç½®éé˜»å¡æ¨¡å¼


**ğŸ”§ è®¾ç½®éé˜»å¡å¥—æ¥å­—**ï¼š

```c
#include <fcntl.h>

// è®¾ç½®å¥—æ¥å­—ä¸ºéé˜»å¡æ¨¡å¼
int set_nonblocking(int sock) {
    int flags = fcntl(sock, F_GETFL, 0);
    if (flags == -1) return -1;
    
    return fcntl(sock, F_SETFL, flags | O_NONBLOCK);
}

// è®¾ç½®å¥—æ¥å­—ä¸ºé˜»å¡æ¨¡å¼
int set_blocking(int sock) {
    int flags = fcntl(sock, F_GETFL, 0);
    if (flags == -1) return -1;
    
    return fcntl(sock, F_SETFL, flags & ~O_NONBLOCK);
}
```

**ğŸ”¸ éé˜»å¡è¯»å†™ç¤ºä¾‹**ï¼š

```c
ssize_t nonblock_read(int sock, void *buf, size_t len) {
    ssize_t result = read(sock, buf, len);
    
    if (result == -1) {
        if (errno == EAGAIN || errno == EWOULDBLOCK) {
            // æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µ
            return 0;
        }
        // çœŸæ­£çš„é”™è¯¯
        return -1;
    }
    
    return result;  // è¿”å›å®é™…è¯»å–çš„å­—èŠ‚æ•°
}
```

### 8.3 ä½¿ç”¨select()å¤šè·¯å¤ç”¨


**ğŸ¯ selectçš„ä½œç”¨**ï¼š
selectå°±åƒæ˜¯ä¸€ä¸ª"é—¨å«"ï¼ŒåŒæ—¶ç›‘è§†å¤šä¸ªå¥—æ¥å­—ï¼Œå“ªä¸ªæœ‰æ•°æ®æ¥äº†å°±é€šçŸ¥ä½ å¤„ç†å“ªä¸ªã€‚

**ğŸ“Š selectå·¥ä½œæµç¨‹**ï¼š
```
   å¥—æ¥å­—1 â†â”
   å¥—æ¥å­—2 â†â”¤ 
   å¥—æ¥å­—3 â†â”¤â†’ select() ç›‘æ§ â†’ æœ‰æ•°æ®çš„å¥—æ¥å­—åˆ—è¡¨
   å¥—æ¥å­—4 â†â”¤
   å¥—æ¥å­—5 â†â”˜
```

**ğŸ”§ selectä½¿ç”¨ç¤ºä¾‹**ï¼š

```c
#include <sys/select.h>

void handle_multiple_sockets(int *socks, int count) {
    fd_set readfds, writefds;
    int max_fd = 0;
    struct timeval timeout;
    
    while (1) {
        // æ¸…ç©ºå¹¶è®¾ç½®æ–‡ä»¶æè¿°ç¬¦é›†
        FD_ZERO(&readfds);
        FD_ZERO(&writefds);
        
        for (int i = 0; i < count; i++) {
            FD_SET(socks[i], &readfds);
            if (socks[i] > max_fd) {
                max_fd = socks[i];
            }
        }
        
        // è®¾ç½®è¶…æ—¶æ—¶é—´
        timeout.tv_sec = 1;
        timeout.tv_usec = 0;
        
        // ç­‰å¾…äº‹ä»¶å‘ç”Ÿ
        int ready = select(max_fd + 1, &readfds, NULL, NULL, &timeout);
        
        if (ready > 0) {
            // æ£€æŸ¥å“ªäº›å¥—æ¥å­—æœ‰æ•°æ®
            for (int i = 0; i < count; i++) {
                if (FD_ISSET(socks[i], &readfds)) {
                    handle_socket_data(socks[i]);
                }
            }
        } else if (ready == 0) {
            printf("è¶…æ—¶ï¼Œæ²¡æœ‰æ•°æ®åˆ°è¾¾\n");
        } else {
            perror("selecté”™è¯¯");
            break;
        }
    }
}
```

### 8.4 ä½¿ç”¨epoll()é«˜æ€§èƒ½å¤šè·¯å¤ç”¨


**ğŸ’¡ epollçš„ä¼˜åŠ¿**ï¼š
- **æ•ˆç‡æ›´é«˜**ï¼šåªè¿”å›æ´»è·ƒçš„æ–‡ä»¶æè¿°ç¬¦
- **æ”¯æŒæ›´å¤šè¿æ¥**ï¼šä¸å—FD_SETSIZEé™åˆ¶
- **è¾¹ç¼˜è§¦å‘**ï¼šæ›´ç²¾ç¡®çš„äº‹ä»¶é€šçŸ¥

```c
#include <sys/epoll.h>

int setup_epoll_server(int listen_sock) {
    int epfd = epoll_create1(0);
    if (epfd == -1) return -1;
    
    // æ·»åŠ ç›‘å¬å¥—æ¥å­—åˆ°epoll
    struct epoll_event ev;
    ev.events = EPOLLIN;  // ç›‘å¬å¯è¯»äº‹ä»¶
    ev.data.fd = listen_sock;
    
    if (epoll_ctl(epfd, EPOLL_CTL_ADD, listen_sock, &ev) == -1) {
        close(epfd);
        return -1;
    }
    
    return epfd;
}

void epoll_event_loop(int epfd, int listen_sock) {
    struct epoll_event events[10];
    
    while (1) {
        int nfds = epoll_wait(epfd, events, 10, -1);  // æ— é™ç­‰å¾…
        
        for (int i = 0; i < nfds; i++) {
            if (events[i].data.fd == listen_sock) {
                // æ–°è¿æ¥åˆ°è¾¾
                handle_new_connection(epfd, listen_sock);
            } else {
                // ç°æœ‰è¿æ¥æœ‰æ•°æ®
                handle_client_data(events[i].data.fd);
            }
        }
    }
}
```

---

## 9. ğŸ“ å¥—æ¥å­—åœ°å€ç»“æ„è¯¦è§£


### 9.1 sockaddr_unç»“æ„è¯¦è§£


**ğŸ“Š ç»“æ„ç»„æˆ**ï¼š

```c
struct sockaddr_un {
    sa_family_t sun_family;   // åœ°å€æ—ï¼Œæ€»æ˜¯AF_UNIX
    char        sun_path[108]; // å¥—æ¥å­—æ–‡ä»¶è·¯å¾„
};
```

**ğŸ”¸ å­—æ®µè¯¦ç»†è¯´æ˜**ï¼š

| å­—æ®µ | **ç±»å‹** | **ä½œç”¨** | **æ³¨æ„äº‹é¡¹** |
|------|---------|---------|-------------|
| `sun_family` | `sa_family_t` | `æ ‡è¯†åœ°å€ç±»å‹` | `æ€»æ˜¯è®¾ä¸ºAF_UNIX` |
| `sun_path` | `char[108]` | `å¥—æ¥å­—æ–‡ä»¶è·¯å¾„` | `å¿…é¡»ä»¥\\0ç»“å°¾` |

### 9.2 æŠ½è±¡å‘½åç©ºé—´


**ğŸ¯ ä»€ä¹ˆæ˜¯æŠ½è±¡å‘½åç©ºé—´**ï¼š
Linuxç‰¹æœ‰çš„åŠŸèƒ½ï¼Œå¥—æ¥å­—åå­—ä¸å¯¹åº”å®é™…æ–‡ä»¶ï¼Œå­˜åœ¨äºå†…æ ¸ä¸­çš„æŠ½è±¡ç©ºé—´é‡Œã€‚

```c
// æ™®é€šå‘½åå¥—æ¥å­—
strcpy(addr.sun_path, "/tmp/mysocket");  // ä¼šåˆ›å»ºæ–‡ä»¶

// æŠ½è±¡å‘½åå¥—æ¥å­—  
addr.sun_path[0] = '\0';  // ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸ºnull
strcpy(&addr.sun_path[1], "mysocket");  // ä¸ä¼šåˆ›å»ºæ–‡ä»¶
```

**ğŸ”¸ æŠ½è±¡å¥—æ¥å­—çš„ä¼˜åŠ¿**ï¼š
- âœ… **è‡ªåŠ¨æ¸…ç†**ï¼šè¿›ç¨‹ç»“æŸè‡ªåŠ¨åˆ é™¤ï¼Œä¸ç•™åƒåœ¾æ–‡ä»¶
- âœ… **æƒé™ç®€å•**ï¼šä¸æ¶‰åŠæ–‡ä»¶ç³»ç»Ÿæƒé™
- âœ… **åå­—å†²çªå°‘**ï¼šç‹¬ç«‹çš„å‘½åç©ºé—´

### 9.3 åœ°å€é•¿åº¦è®¡ç®—


**ğŸ“ è®¡ç®—æ­£ç¡®çš„åœ°å€é•¿åº¦**ï¼š

```c
// è®¡ç®—sockaddr_unçš„å®é™…é•¿åº¦
size_t calc_addr_len(const struct sockaddr_un *addr) {
    if (addr->sun_path[0] == '\0') {
        // æŠ½è±¡å¥—æ¥å­—ï¼šåŸºç¡€é•¿åº¦ + åå­—é•¿åº¦
        return sizeof(addr->sun_family) + strlen(&addr->sun_path[1]) + 1;
    } else {
        // æ™®é€šå¥—æ¥å­—ï¼šåŸºç¡€é•¿åº¦ + è·¯å¾„é•¿åº¦
        return sizeof(addr->sun_family) + strlen(addr->sun_path);
    }
}
```

**ğŸ”§ å®é™…ä½¿ç”¨ç¤ºä¾‹**ï¼š

```c
int bind_unix_socket(int sock, const char *path, int abstract) {
    struct sockaddr_un addr;
    size_t addr_len;
    
    memset(&addr, 0, sizeof(addr));
    addr.sun_family = AF_UNIX;
    
    if (abstract) {
        // æŠ½è±¡å¥—æ¥å­—
        addr.sun_path[0] = '\0';
        strcpy(&addr.sun_path[1], path);
        addr_len = sizeof(addr.sun_family) + 1 + strlen(path);
    } else {
        // æ™®é€šå¥—æ¥å­—
        strcpy(addr.sun_path, path);
        addr_len = sizeof(addr.sun_family) + strlen(path);
        unlink(path);  // åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ–‡ä»¶
    }
    
    return bind(sock, (struct sockaddr*)&addr, addr_len);
}
```

### 9.4 åœ°å€è·å–å‡½æ•°


**ğŸ” è·å–å¥—æ¥å­—åœ°å€ä¿¡æ¯**ï¼š

```c
void print_socket_info(int sock) {
    struct sockaddr_un local_addr, peer_addr;
    socklen_t len;
    
    // è·å–æœ¬åœ°åœ°å€
    len = sizeof(local_addr);
    if (getsockname(sock, (struct sockaddr*)&local_addr, &len) == 0) {
        if (local_addr.sun_path[0] == '\0') {
            printf("æœ¬åœ°åœ°å€: æŠ½è±¡å¥—æ¥å­— @%s\n", &local_addr.sun_path[1]);
        } else {
            printf("æœ¬åœ°åœ°å€: %s\n", local_addr.sun_path);
        }
    }
    
    // è·å–å¯¹ç«¯åœ°å€ï¼ˆå¦‚æœå·²è¿æ¥ï¼‰
    len = sizeof(peer_addr);
    if (getpeername(sock, (struct sockaddr*)&peer_addr, &len) == 0) {
        if (peer_addr.sun_path[0] == '\0') {
            printf("å¯¹ç«¯åœ°å€: æŠ½è±¡å¥—æ¥å­— @%s\n", &peer_addr.sun_path[1]);
        } else {
            printf("å¯¹ç«¯åœ°å€: %s\n", peer_addr.sun_path);
        }
    }
}
```

---

## 10. âš™ï¸ å¥—æ¥å­—é€‰é¡¹é…ç½®


### 10.1 å¥—æ¥å­—é€‰é¡¹æ¦‚è¿°


**ğŸ¯ ä»€ä¹ˆæ˜¯å¥—æ¥å­—é€‰é¡¹**ï¼š
å°±åƒè°ƒèŠ‚æ”¶éŸ³æœºçš„éŸ³é‡ã€é¢‘é“ä¸€æ ·ï¼Œå¥—æ¥å­—é€‰é¡¹ç”¨æ¥è°ƒèŠ‚å¥—æ¥å­—çš„å„ç§å·¥ä½œå‚æ•°å’Œè¡Œä¸ºã€‚

**ğŸ“Š é€‰é¡¹åˆ†ç±»**ï¼š

| é€‰é¡¹çº§åˆ« | **ä½œç”¨èŒƒå›´** | **å¸¸ç”¨é€‰é¡¹** |
|---------|-------------|-------------|
| `SOL_SOCKET` | `æ‰€æœ‰å¥—æ¥å­—é€šç”¨` | `ç¼“å†²åŒºå¤§å°ã€è¶…æ—¶æ—¶é—´` |
| `IPPROTO_TCP` | `TCPå¥—æ¥å­—ä¸“ç”¨` | `æ— å»¶è¿Ÿã€ä¿æ´»` |
| `IPPROTO_UDP` | `UDPå¥—æ¥å­—ä¸“ç”¨` | `å¹¿æ’­æƒé™` |

### 10.2 å¸¸ç”¨å¥—æ¥å­—é€‰é¡¹è¯¦è§£


**ğŸ”§ ç¼“å†²åŒºå¤§å°é€‰é¡¹**ï¼š

```c
// è®¾ç½®å’Œè·å–ç¼“å†²åŒºå¤§å°
void manage_buffer_options(int sock) {
    int send_buf = 64 * 1024;  // 64KB
    int recv_buf = 64 * 1024;  // 64KB
    int current_size;
    socklen_t len = sizeof(int);
    
    // è®¾ç½®å‘é€ç¼“å†²åŒº
    setsockopt(sock, SOL_SOCKET, SO_SNDBUF, &send_buf, sizeof(send_buf));
    
    // è®¾ç½®æ¥æ”¶ç¼“å†²åŒº
    setsockopt(sock, SOL_SOCKET, SO_RCVBUF, &recv_buf, sizeof(recv_buf));
    
    // éªŒè¯è®¾ç½®ç»“æœ
    getsockopt(sock, SOL_SOCKET, SO_SNDBUF, &current_size, &len);
    printf("å®é™…å‘é€ç¼“å†²åŒº: %d bytes\n", current_size);
}
```

**â° è¶…æ—¶é€‰é¡¹**ï¼š

```c
// è®¾ç½®æ¥æ”¶å’Œå‘é€è¶…æ—¶
void set_socket_timeouts(int sock) {
    struct timeval timeout;
    
    // è®¾ç½®æ¥æ”¶è¶…æ—¶ï¼š5ç§’
    timeout.tv_sec = 5;
    timeout.tv_usec = 0;
    setsockopt(sock, SOL_SOCKET, SO_RCVTIMEO, &timeout, sizeof(timeout));
    
    // è®¾ç½®å‘é€è¶…æ—¶ï¼š3ç§’
    timeout.tv_sec = 3;
    timeout.tv_usec = 0;
    setsockopt(sock, SOL_SOCKET, SO_SNDTIMEO, &timeout, sizeof(timeout));
}
```

### 10.3 åœ°å€é‡ç”¨é€‰é¡¹


**ğŸ”„ SO_REUSEADDRè¯¦è§£**ï¼š

```c
// å…è®¸åœ°å€é‡ç”¨ï¼ˆè§£å†³"Address already in use"é”™è¯¯ï¼‰
void enable_address_reuse(int sock) {
    int reuse = 1;
    if (setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, 
                   &reuse, sizeof(reuse)) == -1) {
        perror("è®¾ç½®åœ°å€é‡ç”¨å¤±è´¥");
    }
}

// åˆ›å»ºå¯é‡ç”¨åœ°å€çš„æœåŠ¡å™¨
int create_reusable_server(const char *path) {
    int sock = socket(AF_UNIX, SOCK_STREAM, 0);
    if (sock == -1) return -1;
    
    // å¯ç”¨åœ°å€é‡ç”¨
    enable_address_reuse(sock);
    
    // ç»‘å®šå’Œç›‘å¬
    struct sockaddr_un addr;
    memset(&addr, 0, sizeof(addr));
    addr.sun_family = AF_UNIX;
    strcpy(addr.sun_path, path);
    
    unlink(path);  // åˆ é™¤æ—§æ–‡ä»¶
    bind(sock, (struct sockaddr*)&addr, sizeof(addr));
    listen(sock, 5);
    
    return sock;
}
```

### 10.4 è°ƒè¯•å’Œç›‘æ§é€‰é¡¹


**ğŸ” è°ƒè¯•é€‰é¡¹**ï¼š

```c
// å¯ç”¨å¥—æ¥å­—è°ƒè¯•ä¿¡æ¯
void enable_socket_debug(int sock) {
    int debug = 1;
    setsockopt(sock, SOL_SOCKET, SO_DEBUG, &debug, sizeof(debug));
}

// è·å–å¥—æ¥å­—é”™è¯¯ä¿¡æ¯
int get_socket_error(int sock) {
    int error;
    socklen_t len = sizeof(error);
    
    if (getsockopt(sock, SOL_SOCKET, SO_ERROR, &error, &len) == 0) {
        return error;
    }
    return -1;
}
```

**ğŸ“Š è¿æ¥çŠ¶æ€æ£€æŸ¥**ï¼š

```c
// æ£€æŸ¥å¥—æ¥å­—æ˜¯å¦ä»ç„¶è¿æ¥
int is_socket_connected(int sock) {
    int error = get_socket_error(sock);
    if (error != 0) {
        printf("å¥—æ¥å­—é”™è¯¯: %s\n", strerror(error));
        return 0;
    }
    
    // å°è¯•å‘é€0å­—èŠ‚æ•°æ®æ¥æ£€æŸ¥è¿æ¥
    ssize_t result = send(sock, NULL, 0, MSG_DONTWAIT);
    if (result == 0 || (result == -1 && errno != EAGAIN)) {
        return 1;  // è¿æ¥æ­£å¸¸
    }
    
    return 0;  // è¿æ¥å¯èƒ½æ–­å¼€
}
```

### 10.5 é€‰é¡¹è®¾ç½®æœ€ä½³å®è·µ


**ğŸ’¡ æ¨èçš„é€‰é¡¹é…ç½®æ¨¡æ¿**ï¼š

```c
// ä¸ºé«˜æ€§èƒ½æœåŠ¡å™¨é…ç½®å¥—æ¥å­—é€‰é¡¹
int optimize_server_socket(int sock) {
    int opt = 1;
    struct timeval timeout = {30, 0};  // 30ç§’è¶…æ—¶
    int bufsize = 128 * 1024;  // 128KBç¼“å†²åŒº
    
    // å¯ç”¨åœ°å€é‡ç”¨
    setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt));
    
    // è®¾ç½®è¶…æ—¶
    setsockopt(sock, SOL_SOCKET, SO_RCVTIMEO, &timeout, sizeof(timeout));
    setsockopt(sock, SOL_SOCKET, SO_SNDTIMEO, &timeout, sizeof(timeout));
    
    // ä¼˜åŒ–ç¼“å†²åŒº
    setsockopt(sock, SOL_SOCKET, SO_RCVBUF, &bufsize, sizeof(bufsize));
    setsockopt(sock, SOL_SOCKET, SO_SNDBUF, &bufsize, sizeof(bufsize));
    
    // å¯ç”¨ä¿æ´»æ£€æµ‹ï¼ˆå¦‚æœæ”¯æŒï¼‰
    setsockopt(sock, SOL_SOCKET, SO_KEEPALIVE, &opt, sizeof(opt));
    
    return 0;
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ¯ Socket IPCæ ¸å¿ƒç†è§£**ï¼š
```
ğŸ”¸ Socketæœ¬è´¨ï¼šè¿›ç¨‹é—´çš„"é€šä¿¡ç®¡é“"ï¼Œæ—¢èƒ½æœ¬åœ°é€šä¿¡åˆèƒ½ç½‘ç»œé€šä¿¡
ğŸ”¸ UnixåŸŸå¥—æ¥å­—ï¼šä¸“é—¨ç”¨äºæœ¬æœºé€šä¿¡ï¼Œé€Ÿåº¦å¿«ã€å®‰å…¨æ€§é«˜
ğŸ”¸ ä¸¤ç§ç±»å‹ï¼šæµå¼ï¼ˆTCP-likeï¼‰å¯é è¿æ¥ï¼Œæ•°æ®æŠ¥ï¼ˆUDP-likeï¼‰æ¶ˆæ¯ç‹¬ç«‹
ğŸ”¸ åœ°å€æ–‡ä»¶ï¼šå¥—æ¥å­—åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„"é—¨ç‰Œå·"ï¼Œæ§åˆ¶è®¿é—®æƒé™
ğŸ”¸ æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ï¼šé«˜çº§åŠŸèƒ½ï¼Œå¯ä»¥åœ¨è¿›ç¨‹é—´ä¼ é€’æ–‡ä»¶è®¿é—®æƒé™
```

### 11.2 å…³é”®æ“ä½œæµç¨‹


**ğŸ“Š æœåŠ¡ç«¯æ“ä½œæµç¨‹**ï¼š
```
1. socket()    â†’ åˆ›å»ºå¥—æ¥å­—
2. bind()      â†’ ç»‘å®šåœ°å€æ–‡ä»¶
3. listen()    â†’ å¼€å§‹ç›‘å¬è¿æ¥
4. accept()    â†’ æ¥å—å®¢æˆ·ç«¯è¿æ¥
5. read/write() â†’ æ•°æ®äº¤æ¢
6. close()     â†’ å…³é—­è¿æ¥
7. unlink()    â†’ æ¸…ç†åœ°å€æ–‡ä»¶
```

**ğŸ“Š å®¢æˆ·ç«¯æ“ä½œæµç¨‹**ï¼š
```
1. socket()    â†’ åˆ›å»ºå¥—æ¥å­—
2. connect()   â†’ è¿æ¥åˆ°æœåŠ¡ç«¯
3. read/write() â†’ æ•°æ®äº¤æ¢
4. close()     â†’ å…³é—­è¿æ¥
```

### 11.3 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹


**âš¡ æå‡æ€§èƒ½çš„å…³é”®æªæ–½**ï¼š
- **ç¼“å†²åŒºè°ƒä¼˜**ï¼šæ ¹æ®æ•°æ®é‡è°ƒæ•´å‘é€/æ¥æ”¶ç¼“å†²åŒºå¤§å°
- **éé˜»å¡I/O**ï¼šé¿å…é˜»å¡ç­‰å¾…ï¼Œæé«˜å¹¶å‘å¤„ç†èƒ½åŠ›
- **å¤šè·¯å¤ç”¨**ï¼šä½¿ç”¨select/epollåŒæ—¶å¤„ç†å¤šä¸ªè¿æ¥
- **åˆç†è¶…æ—¶**ï¼šè®¾ç½®é€‚å½“çš„è¯»å†™è¶…æ—¶æ—¶é—´
- **åœ°å€é‡ç”¨**ï¼šé¿å…"Address already in use"é”™è¯¯

### 11.4 å®‰å…¨æ³¨æ„äº‹é¡¹


**ğŸ” å®‰å…¨æœ€ä½³å®è·µ**ï¼š
```
æƒé™æ§åˆ¶ï¼š
â€¢ è®¾ç½®åˆé€‚çš„å¥—æ¥å­—æ–‡ä»¶æƒé™ï¼ˆ0600/0660ï¼‰
â€¢ å°†å¥—æ¥å­—æ–‡ä»¶æ”¾åœ¨å®‰å…¨ç›®å½•ä¸­
â€¢ ç¨‹åºé€€å‡ºæ—¶æ¸…ç†å¥—æ¥å­—æ–‡ä»¶

é”™è¯¯å¤„ç†ï¼š
â€¢ æ£€æŸ¥æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼
â€¢ åˆç†å¤„ç†EAGAINã€EINTRç­‰å¸¸è§é”™è¯¯
â€¢ è®¾ç½®è¶…æ—¶é˜²æ­¢æ— é™ç­‰å¾…

èµ„æºç®¡ç†ï¼š
â€¢ åŠæ—¶å…³é—­ä¸ç”¨çš„æ–‡ä»¶æè¿°ç¬¦
â€¢ é¿å…æ–‡ä»¶æè¿°ç¬¦æ³„éœ²
â€¢ æ­£ç¡®å¤„ç†ä¿¡å·ä¸­æ–­
```

### 11.5 å®é™…åº”ç”¨åœºæ™¯


**ğŸ› ï¸ å¸¸è§åº”ç”¨åœºæ™¯**ï¼š
- **WebæœåŠ¡å™¨**ï¼šä¸»è¿›ç¨‹æ¥å—è¿æ¥ï¼Œå·¥ä½œè¿›ç¨‹å¤„ç†è¯·æ±‚
- **æ•°æ®åº“ä»£ç†**ï¼šå®¢æˆ·ç«¯é€šè¿‡Socketè¿æ¥æ•°æ®åº“ä»£ç†æœåŠ¡
- **è¿›ç¨‹ç›‘æ§**ï¼šç›‘æ§è¿›ç¨‹é€šè¿‡Socketæ”¶é›†å…¶ä»–è¿›ç¨‹çŠ¶æ€
- **é…ç½®æ›´æ–°**ï¼šé…ç½®æœåŠ¡é€šè¿‡Socketé€šçŸ¥å…¶ä»–è¿›ç¨‹é‡æ–°åŠ è½½é…ç½®
- **æ—¥å¿—æ”¶é›†**ï¼šåº”ç”¨ç¨‹åºé€šè¿‡Socketå‘é€æ—¥å¿—åˆ°æ—¥å¿—æœåŠ¡

### 11.6 è°ƒè¯•å’Œæ•…éšœæ’é™¤


**ğŸ” å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ**ï¼š

| é—®é¢˜ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|------|---------|-------------|
| `Address already in use` | `å¥—æ¥å­—æ–‡ä»¶æœªæ¸…ç†` | `unlink()åˆ é™¤æ—§æ–‡ä»¶` |
| `Permission denied` | `æ–‡ä»¶æƒé™ä¸è¶³` | `chmod()è®¾ç½®æ­£ç¡®æƒé™` |
| `Connection refused` | `æœåŠ¡ç«¯æœªå¯åŠ¨` | `ç¡®è®¤æœåŠ¡ç«¯æ­£åœ¨listen()` |
| `Broken pipe` | `å¯¹ç«¯å…³é—­è¿æ¥` | `æ£€æŸ¥SIGPIPEä¿¡å·å¤„ç†` |
| `Resource temporarily unavailable` | `éé˜»å¡I/Oæš‚æ— æ•°æ®` | `ä½¿ç”¨select/epollç­‰å¾…` |

**ğŸ”§ è°ƒè¯•å·¥å…·å’ŒæŠ€å·§**ï¼š
```bash
# æŸ¥çœ‹å¥—æ¥å­—æ–‡ä»¶
ls -la /tmp/your_socket

# æ£€æŸ¥è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦
lsof -p <è¿›ç¨‹ID>

# ä½¿ç”¨straceè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨
strace -e socket,bind,listen,accept,read,write ./your_program

# ä½¿ç”¨netstatæŸ¥çœ‹UnixåŸŸå¥—æ¥å­—
netstat -x
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Socketé€šä¿¡å»ºç®¡é“ï¼Œæœ¬åœ°ç½‘ç»œéƒ½èƒ½è·‘
- åˆ›å»ºç»‘å®šå†ç›‘å¬ï¼Œæ¥å—è¿æ¥å¼€å§‹èŠ  
- æƒé™å®‰å…¨è¦æ³¨æ„ï¼Œç¼“å†²è¶…æ—¶è°ƒæ€§èƒ½
- éé˜»å¡é…å¤šè·¯å¤ç”¨ï¼Œé«˜å¹¶å‘ä¸æ˜¯æ¢¦