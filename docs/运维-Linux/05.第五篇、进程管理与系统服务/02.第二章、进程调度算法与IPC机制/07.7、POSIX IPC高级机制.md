---
title: 7ã€POSIX IPCé«˜çº§æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [POSIX IPCæ¦‚è¿°ä¸System Vå¯¹æ¯”](#1-POSIX-IPCæ¦‚è¿°ä¸System-Vå¯¹æ¯”)
2. [POSIXæ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶](#2-POSIXæ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶)
3. [POSIXä¿¡å·é‡æœºåˆ¶](#3-POSIXä¿¡å·é‡æœºåˆ¶)
4. [POSIXå…±äº«å†…å­˜æœºåˆ¶](#4-POSIXå…±äº«å†…å­˜æœºåˆ¶)
5. [å®æ—¶ä¿¡å·é˜Ÿåˆ—æœºåˆ¶](#5-å®æ—¶ä¿¡å·é˜Ÿåˆ—æœºåˆ¶)
6. [å¼‚æ­¥I/Oä¸ä¿¡å·é©±åŠ¨I/O](#6-å¼‚æ­¥I-Oä¸ä¿¡å·é©±åŠ¨I-O)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” POSIX IPCæ¦‚è¿°ä¸System Vå¯¹æ¯”


### 1.1 ä»€ä¹ˆæ˜¯POSIX IPC


**ç®€å•ç†è§£**ï¼šPOSIX IPCå°±æ˜¯**ç¬¦åˆPOSIXæ ‡å‡†çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼**ï¼Œå®ƒæä¾›äº†ä¸€å¥—æ›´ç°ä»£ã€æ›´æ ‡å‡†åŒ–çš„è¿›ç¨‹é€šä¿¡æ¥å£ã€‚

```
è¿›ç¨‹é€šä¿¡çš„æœ¬è´¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      æ•°æ®ä¼ é€’      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿›ç¨‹ A  â”‚ ----------------> â”‚ è¿›ç¨‹ B  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼šä¸åŒè¿›ç¨‹æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œæ— æ³•ç›´æ¥è®¿é—®
è§£å†³ï¼šé€šè¿‡æ“ä½œç³»ç»Ÿæä¾›çš„IPCæœºåˆ¶è¿›è¡Œé€šä¿¡
```

**POSIX IPCçš„æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **æ ‡å‡†åŒ–**ï¼šéµå¾ªPOSIXæ ‡å‡†ï¼Œè·¨å¹³å°å…¼å®¹æ€§å¥½
- **é¢å‘å¯¹è±¡**ï¼šä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦ï¼Œæ›´æ¥è¿‘Unix"ä¸€åˆ‡çš†æ–‡ä»¶"çš„ç†å¿µ
- **ç°ä»£åŒ–**ï¼šæ”¯æŒå¼‚æ­¥æ“ä½œã€å®æ—¶ç‰¹æ€§

### 1.2 POSIX IPC vs System V IPC è¯¦ç»†å¯¹æ¯”


**è®¾è®¡ç†å¿µå·®å¼‚**ï¼š
```
System V IPCï¼š
- åŸºäºkeyå€¼è®¿é—®ï¼ˆç±»ä¼¼é—¨ç‰Œå·ï¼‰
- å…¨å±€å‘½åç©ºé—´
- éœ€è¦æ‰‹åŠ¨æ¸…ç†èµ„æº

POSIX IPCï¼š  
- åŸºäºåå­—è®¿é—®ï¼ˆç±»ä¼¼æ–‡ä»¶è·¯å¾„ï¼‰
- ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå‘½åç©ºé—´
- æ”¯æŒå¼•ç”¨è®¡æ•°è‡ªåŠ¨æ¸…ç†
```

| **ç‰¹æ€§å¯¹æ¯”** | **System V IPC** | **POSIX IPC** | **é€šä¿—è§£é‡Š** |
|-------------|-------------------|----------------|-------------|
| **è®¿é—®æ–¹å¼** | `key_té”®å€¼` | `å­—ç¬¦ä¸²åå­—` | POSIXåƒæ–‡ä»¶è·¯å¾„ï¼Œæ›´ç›´è§‚ |
| **åˆ›å»ºæ¥å£** | `msgget/semget/shmget` | `mq_open/sem_open/shm_open` | POSIXæ¥å£æ›´ç»Ÿä¸€ |
| **æƒé™æ§åˆ¶** | `å¤æ‚çš„IPCæƒé™` | `æ–‡ä»¶ç³»ç»Ÿæƒé™` | POSIXç›´æ¥ç”¨æ–‡ä»¶æƒé™ï¼Œç®€å• |
| **æŒä¹…æ€§** | `å†…æ ¸æŒä¹…åŒ–` | `æ–‡ä»¶ç³»ç»ŸæŒä¹…åŒ–` | POSIXå¯ä»¥éšæ–‡ä»¶ç³»ç»Ÿå­˜åœ¨ |
| **è·¨å¹³å°** | `ä¸»è¦Linux/Unix` | `POSIXæ ‡å‡†ï¼Œå…¼å®¹æ€§å¥½` | POSIXæ›´æ ‡å‡†åŒ– |
| **æ¸…ç†æ–¹å¼** | `æ‰‹åŠ¨ipcrmæ¸…ç†` | `å¼•ç”¨è®¡æ•°è‡ªåŠ¨æ¸…ç†` | POSIXæ›´æ™ºèƒ½ |

### 1.3 ä¸ºä»€ä¹ˆè¦å­¦POSIX IPC


**å®é™…åº”ç”¨ä»·å€¼**ï¼š
- **ç°ä»£Linuxç³»ç»Ÿ**ï¼šæ–°çš„ç³»ç»ŸæœåŠ¡æ›´å¤šé‡‡ç”¨POSIX IPC
- **è·¨å¹³å°å¼€å‘**ï¼šPOSIXæ ‡å‡†ä¿è¯ä»£ç å¯ç§»æ¤æ€§
- **å®æ—¶ç³»ç»Ÿ**ï¼šæ”¯æŒå®æ—¶ç‰¹æ€§ï¼Œé€‚åˆå¯¹æ—¶é—´æ•æ„Ÿçš„åº”ç”¨
- **å®¹å™¨åŒ–ç¯å¢ƒ**ï¼šåœ¨Dockerç­‰å®¹å™¨ä¸­è¡¨ç°æ›´å¥½

---

## 2. ğŸ“¬ POSIXæ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶


### 2.1 ä»€ä¹ˆæ˜¯POSIXæ¶ˆæ¯é˜Ÿåˆ—


**é€šä¿—ç†è§£**ï¼šå°±åƒ**é‚®å±€çš„ä¿¡ç®±ç³»ç»Ÿ**ï¼Œè¿›ç¨‹å¯ä»¥å¾€é˜Ÿåˆ—é‡ŒæŠ•é€’æ¶ˆæ¯ï¼Œå…¶ä»–è¿›ç¨‹å¯ä»¥ä»é˜Ÿåˆ—é‡Œå–æ¶ˆæ¯ã€‚

```
æ¶ˆæ¯é˜Ÿåˆ—å·¥ä½œåŸç†ï¼š
å‘é€è¿›ç¨‹                 æ¶ˆæ¯é˜Ÿåˆ—                 æ¥æ”¶è¿›ç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿›ç¨‹ A  â”‚ â”€æ¶ˆæ¯1â”€â”€â”€> â”‚ [æ¶ˆæ¯1]     â”‚ â”€æ¶ˆæ¯1â”€â”€â”€> â”‚ è¿›ç¨‹ B  â”‚
â”‚         â”‚ â”€æ¶ˆæ¯2â”€â”€â”€> â”‚ [æ¶ˆæ¯2]     â”‚ â”€æ¶ˆæ¯2â”€â”€â”€> â”‚         â”‚
â”‚         â”‚ â”€æ¶ˆæ¯3â”€â”€â”€> â”‚ [æ¶ˆæ¯3]     â”‚            â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†‘å…ˆè¿›å…ˆå‡ºâ†‘
```

**POSIXæ¶ˆæ¯é˜Ÿåˆ—çš„ç‰¹ç‚¹**ï¼š
- **æœ‰åºæ€§**ï¼šæ¶ˆæ¯æŒ‰å‘é€é¡ºåºæ’é˜Ÿï¼ˆFIFOï¼‰
- **ä¼˜å…ˆçº§**ï¼šæ¯ä¸ªæ¶ˆæ¯å¯ä»¥è®¾ç½®ä¼˜å…ˆçº§
- **å¤§å°é™åˆ¶**ï¼šæ¯ä¸ªæ¶ˆæ¯æœ‰æœ€å¤§é•¿åº¦é™åˆ¶
- **å¼‚æ­¥é€šä¿¡**ï¼šå‘é€æ–¹ä¸éœ€è¦ç­‰å¾…æ¥æ”¶æ–¹

### 2.2 æ ¸å¿ƒæ¥å£è¯¦è§£


#### mq_open - æ‰“å¼€/åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—


```c
#include <mqueue.h>

// æ‰“å¼€å·²å­˜åœ¨çš„é˜Ÿåˆ—
mqd_t mq_open(const char *name, int oflag);

// åˆ›å»ºæ–°é˜Ÿåˆ—
mqd_t mq_open(const char *name, int oflag, mode_t mode, struct mq_attr *attr);
```

**å‚æ•°è¯´æ˜**ï¼š
- **name**ï¼šé˜Ÿåˆ—åå­—ï¼Œå¿…é¡»ä»¥`/`å¼€å¤´ï¼ˆå¦‚ï¼š`/myqueue`ï¼‰
- **oflag**ï¼šæ‰“å¼€æ ‡å¿—
  - `O_RDONLY`ï¼šåªè¯»
  - `O_WRONLY`ï¼šåªå†™  
  - `O_RDWR`ï¼šè¯»å†™
  - `O_CREAT`ï¼šä¸å­˜åœ¨åˆ™åˆ›å»º
  - `O_EXCL`ï¼šä¸O_CREATä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿åˆ›å»ºæ–°é˜Ÿåˆ—

**åˆ›å»ºé˜Ÿåˆ—ç¤ºä¾‹**ï¼š
```c
// é˜Ÿåˆ—å±æ€§è®¾ç½®
struct mq_attr attr;
attr.mq_flags = 0;          // é˜»å¡æ¨¡å¼
attr.mq_maxmsg = 10;        // æœ€å¤š10æ¡æ¶ˆæ¯
attr.mq_msgsize = 256;      // æ¯æ¡æ¶ˆæ¯æœ€å¤§256å­—èŠ‚

// åˆ›å»ºé˜Ÿåˆ—
mqd_t mq = mq_open("/myqueue", 
                   O_CREAT | O_RDWR, 
                   0644,      // æ–‡ä»¶æƒé™ï¼šrw-r--r--
                   &attr);
if (mq == (mqd_t)-1) {
    perror("mq_open failed");
}
```

#### mq_send - å‘é€æ¶ˆæ¯


```c
int mq_send(mqd_t mqdes, const char *msg_ptr, 
            size_t msg_len, unsigned int msg_prio);
```

**é€šä¿—è§£é‡Š**ï¼šå°±åƒå¾€é‚®ç®±é‡ŒæŠ•ä¿¡ï¼Œå¯ä»¥è®¾ç½®ä¿¡ä»¶çš„é‡è¦ç¨‹åº¦ï¼ˆä¼˜å…ˆçº§ï¼‰ã€‚

```c
// å‘é€æ¶ˆæ¯ç¤ºä¾‹
char message[] = "Hello from Process A";
int priority = 5;  // ä¼˜å…ˆçº§0-31ï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜

if (mq_send(mq, message, strlen(message), priority) == -1) {
    perror("mq_send failed");
}
```

#### mq_receive - æ¥æ”¶æ¶ˆæ¯


```c
ssize_t mq_receive(mqd_t mqdes, char *msg_ptr, 
                   size_t msg_len, unsigned int *msg_prio);
```

**å·¥ä½œæ–¹å¼**ï¼šè‡ªåŠ¨è·å–**ä¼˜å…ˆçº§æœ€é«˜**çš„æ¶ˆæ¯ï¼Œç›¸åŒä¼˜å…ˆçº§åˆ™æŒ‰**å…ˆè¿›å…ˆå‡º**é¡ºåºã€‚

```c
// æ¥æ”¶æ¶ˆæ¯ç¤ºä¾‹
char buffer[256];
unsigned int priority;

// æ¥æ”¶æ¶ˆæ¯ï¼ˆä¼šé˜»å¡ç­‰å¾…ï¼‰
ssize_t bytes = mq_receive(mq, buffer, sizeof(buffer), &priority);
if (bytes == -1) {
    perror("mq_receive failed");
} else {
    buffer[bytes] = '\0';  // æ·»åŠ å­—ç¬¦ä¸²ç»“æŸç¬¦
    printf("æ”¶åˆ°æ¶ˆæ¯: %s, ä¼˜å…ˆçº§: %u\n", buffer, priority);
}
```

### 2.3 å®Œæ•´åº”ç”¨ç¤ºä¾‹


**å‘é€è¿›ç¨‹ï¼ˆproducer.cï¼‰**ï¼š
```c
#include <mqueue.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main() {
    mqd_t mq;
    struct mq_attr attr;
    
    // è®¾ç½®é˜Ÿåˆ—å±æ€§
    attr.mq_flags = 0;
    attr.mq_maxmsg = 10;
    attr.mq_msgsize = 256;
    
    // åˆ›å»ºé˜Ÿåˆ—
    mq = mq_open("/testqueue", O_CREAT | O_WRONLY, 0644, &attr);
    if (mq == (mqd_t)-1) {
        perror("ç”Ÿäº§è€…ï¼šæ— æ³•æ‰“å¼€é˜Ÿåˆ—");
        exit(1);
    }
    
    // å‘é€å‡ æ¡æ¶ˆæ¯
    char *messages[] = {"æ¶ˆæ¯1", "é‡è¦æ¶ˆæ¯", "æ™®é€šæ¶ˆæ¯"};
    unsigned int priorities[] = {1, 10, 5};
    
    for (int i = 0; i < 3; i++) {
        if (mq_send(mq, messages[i], strlen(messages[i]), priorities[i]) == -1) {
            perror("å‘é€å¤±è´¥");
        } else {
            printf("å·²å‘é€: %s (ä¼˜å…ˆçº§: %u)\n", messages[i], priorities[i]);
        }
    }
    
    mq_close(mq);
    return 0;
}
```

**æ¥æ”¶è¿›ç¨‹ï¼ˆconsumer.cï¼‰**ï¼š
```c
#include <mqueue.h>
#include <stdio.h>
#include <stdlib.h>

int main() {
    mqd_t mq;
    char buffer[256];
    unsigned int priority;
    ssize_t bytes;
    
    // æ‰“å¼€é˜Ÿåˆ—
    mq = mq_open("/testqueue", O_RDONLY);
    if (mq == (mqd_t)-1) {
        perror("æ¶ˆè´¹è€…ï¼šæ— æ³•æ‰“å¼€é˜Ÿåˆ—");
        exit(1);
    }
    
    // æ¥æ”¶æ‰€æœ‰æ¶ˆæ¯
    printf("å¼€å§‹æ¥æ”¶æ¶ˆæ¯...\n");
    while ((bytes = mq_receive(mq, buffer, sizeof(buffer), &priority)) != -1) {
        buffer[bytes] = '\0';
        printf("æ”¶åˆ°: %s (ä¼˜å…ˆçº§: %u)\n", buffer, priority);
    }
    
    mq_close(mq);
    mq_unlink("/testqueue");  // åˆ é™¤é˜Ÿåˆ—
    return 0;
}
```

---

## 3. ğŸ” POSIXä¿¡å·é‡æœºåˆ¶


### 3.1 ä»€ä¹ˆæ˜¯ä¿¡å·é‡


**ç”Ÿæ´»æ¯”å–»**ï¼šä¿¡å·é‡å°±åƒ**åœè½¦åœºçš„è½¦ä½è®¡æ•°å™¨**ã€‚

```
åœè½¦åœºç±»æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœè½¦åœº (å…±äº«èµ„æº)    â”‚
â”‚ æ€»è½¦ä½: 5ä¸ª         â”‚  â† ä¿¡å·é‡åˆå§‹å€¼
â”‚ å‰©ä½™è½¦ä½: 3ä¸ª       â”‚  â† ä¿¡å·é‡å½“å‰å€¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è½¦è¾†è¿›å…¥ (waitæ“ä½œ)ï¼šå‰©ä½™è½¦ä½ -1
è½¦è¾†ç¦»å¼€ (postæ“ä½œ)ï¼šå‰©ä½™è½¦ä½ +1
è½¦ä½ä¸º0æ—¶ï¼šæ–°è½¦ç­‰å¾…
```

**ä¿¡å·é‡çš„ä½œç”¨**ï¼š
- **èµ„æºè®¡æ•°**ï¼šæ§åˆ¶åŒæ—¶è®¿é—®èµ„æºçš„è¿›ç¨‹æ•°é‡
- **åŒæ­¥æ§åˆ¶**ï¼šåè°ƒå¤šä¸ªè¿›ç¨‹çš„æ‰§è¡Œé¡ºåº
- **äº’æ–¥ä¿æŠ¤**ï¼šä¿æŠ¤ä¸´ç•ŒåŒºï¼ˆå½“ä¿¡å·é‡å€¼ä¸º1æ—¶ï¼‰

### 3.2 å‘½åä¿¡å·é‡ vs åŒ¿åä¿¡å·é‡


| **ç‰¹æ€§** | **å‘½åä¿¡å·é‡** | **åŒ¿åä¿¡å·é‡** | **ä½¿ç”¨åœºæ™¯** |
|---------|---------------|---------------|-------------|
| **æ ‡è¯†æ–¹å¼** | `å­—ç¬¦ä¸²åå­—` | `å†…å­˜åœ°å€` | å‘½åç”¨äºä¸ç›¸å…³è¿›ç¨‹ |
| **ä½œç”¨èŒƒå›´** | `è·¨è¿›ç¨‹` | `è¿›ç¨‹å†…æˆ–çˆ¶å­è¿›ç¨‹` | åŒ¿åç”¨äºç›¸å…³è¿›ç¨‹ |
| **æŒä¹…æ€§** | `å¯æŒä¹…åŒ–` | `è¿›ç¨‹ç»“æŸå³æ¶ˆå¤±` | å‘½åå¯ä»¥ä¿å­˜çŠ¶æ€ |
| **åˆ›å»ºæ–¹å¼** | `sem_open()` | `sem_init()` | æ ¹æ®éœ€æ±‚é€‰æ‹© |

### 3.3 å‘½åä¿¡å·é‡æ¥å£è¯¦è§£


#### sem_open - åˆ›å»º/æ‰“å¼€ä¿¡å·é‡


```c
#include <semaphore.h>

// æ‰“å¼€å·²å­˜åœ¨çš„ä¿¡å·é‡
sem_t *sem_open(const char *name, int oflag);

// åˆ›å»ºæ–°ä¿¡å·é‡
sem_t *sem_open(const char *name, int oflag, mode_t mode, unsigned int value);
```

**åˆ›å»ºç¤ºä¾‹**ï¼š
```c
// åˆ›å»ºä¸€ä¸ªåˆå§‹å€¼ä¸º3çš„ä¿¡å·é‡ï¼ˆæ¨¡æ‹Ÿ3ä¸ªè½¦ä½ï¼‰
sem_t *sem = sem_open("/parking_lots", 
                      O_CREAT | O_EXCL,  // åˆ›å»ºæ–°çš„
                      0644,              // æƒé™
                      3);                // åˆå§‹å€¼3
if (sem == SEM_FAILED) {
    perror("sem_open failed");
}
```

#### sem_wait - è·å–èµ„æºï¼ˆPæ“ä½œï¼‰


```c
int sem_wait(sem_t *sem);      // é˜»å¡ç­‰å¾…
int sem_trywait(sem_t *sem);   // éé˜»å¡å°è¯•
```

**å·¥ä½œåŸç†**ï¼š
```c
// æ¨¡æ‹Ÿè½¦è¾†è¿›å…¥åœè½¦åœº
printf("å°è¯•è¿›å…¥åœè½¦åœº...\n");
if (sem_wait(sem) == 0) {
    printf("æˆåŠŸè·å¾—è½¦ä½ï¼Œå¼€å§‹åœè½¦\n");
    // ä¸´ç•ŒåŒºï¼šä½¿ç”¨èµ„æº
    sleep(2);  // æ¨¡æ‹Ÿåœè½¦æ—¶é—´
} else {
    perror("è·å–è½¦ä½å¤±è´¥");
}
```

#### sem_post - é‡Šæ”¾èµ„æºï¼ˆVæ“ä½œï¼‰


```c
int sem_post(sem_t *sem);
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```c
// æ¨¡æ‹Ÿè½¦è¾†ç¦»å¼€åœè½¦åœº
printf("ç¦»å¼€åœè½¦åœºï¼Œé‡Šæ”¾è½¦ä½\n");
if (sem_post(sem) == -1) {
    perror("é‡Šæ”¾è½¦ä½å¤±è´¥");
}
```

### 3.4 åŒ¿åä¿¡å·é‡æ¥å£


**åˆå§‹åŒ–å’Œé”€æ¯**ï¼š
```c
#include <semaphore.h>

// åˆå§‹åŒ–åŒ¿åä¿¡å·é‡
int sem_init(sem_t *sem, int pshared, unsigned int value);

// é”€æ¯ä¿¡å·é‡
int sem_destroy(sem_t *sem);
```

**å‚æ•°è¯´æ˜**ï¼š
- **pshared = 0**ï¼šä»…åœ¨å½“å‰è¿›ç¨‹çš„çº¿ç¨‹é—´ä½¿ç”¨
- **pshared = 1**ï¼šå¯åœ¨å¤šä¸ªè¿›ç¨‹é—´ä½¿ç”¨ï¼ˆéœ€è¦æ”¾åœ¨å…±äº«å†…å­˜ä¸­ï¼‰

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```c
sem_t mutex;  // äº’æ–¥ä¿¡å·é‡

// åˆå§‹åŒ–ä¸º1ï¼Œå®ç°äº’æ–¥é”åŠŸèƒ½
if (sem_init(&mutex, 1, 1) == -1) {  // pshared=1æ”¯æŒå¤šè¿›ç¨‹
    perror("sem_init failed");
}

// ä½¿ç”¨
sem_wait(&mutex);    // è¿›å…¥ä¸´ç•ŒåŒº
// ä¸´ç•ŒåŒºä»£ç ...
sem_post(&mutex);    // ç¦»å¼€ä¸´ç•ŒåŒº

// é”€æ¯
sem_destroy(&mutex);
```

### 3.5 ç”Ÿäº§è€…-æ¶ˆè´¹è€…å®Œæ•´ç¤ºä¾‹


```c
#include <semaphore.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/wait.h>

#define BUFFER_SIZE 5

int main() {
    // åˆ›å»ºä¿¡å·é‡
    sem_t *empty = sem_open("/empty", O_CREAT, 0644, BUFFER_SIZE);  // ç©ºæ§½ä½
    sem_t *full = sem_open("/full", O_CREAT, 0644, 0);             // æ»¡æ§½ä½
    sem_t *mutex = sem_open("/mutex", O_CREAT, 0644, 1);           // äº’æ–¥é”
    
    pid_t pid = fork();
    
    if (pid == 0) {
        // ç”Ÿäº§è€…è¿›ç¨‹
        for (int i = 0; i < 10; i++) {
            sem_wait(empty);  // ç­‰å¾…ç©ºæ§½ä½
            sem_wait(mutex);  // è·å–äº’æ–¥é”
            
            printf("ç”Ÿäº§è€…ï¼šç”Ÿäº§äº§å“ %d\n", i);
            sleep(1);
            
            sem_post(mutex);  // é‡Šæ”¾äº’æ–¥é”
            sem_post(full);   // å¢åŠ æ»¡æ§½ä½
        }
    } else {
        // æ¶ˆè´¹è€…è¿›ç¨‹
        for (int i = 0; i < 10; i++) {
            sem_wait(full);   // ç­‰å¾…æ»¡æ§½ä½
            sem_wait(mutex);  // è·å–äº’æ–¥é”
            
            printf("æ¶ˆè´¹è€…ï¼šæ¶ˆè´¹äº§å“ %d\n", i);
            sleep(2);
            
            sem_post(mutex);  // é‡Šæ”¾äº’æ–¥é”
            sem_post(empty);  // å¢åŠ ç©ºæ§½ä½
        }
        wait(NULL);  // ç­‰å¾…å­è¿›ç¨‹ç»“æŸ
    }
    
    // æ¸…ç†èµ„æº
    sem_close(empty);
    sem_close(full);
    sem_close(mutex);
    sem_unlink("/empty");
    sem_unlink("/full");
    sem_unlink("/mutex");
    
    return 0;
}
```

---

## 4. ğŸ’¾ POSIXå…±äº«å†…å­˜æœºåˆ¶


### 4.1 ä»€ä¹ˆæ˜¯å…±äº«å†…å­˜


**é€šä¿—ç†è§£**ï¼šå…±äº«å†…å­˜å°±åƒ**å¤šä¸ªäººå…±ç”¨çš„ç™½æ¿**ï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥åœ¨ä¸Šé¢å†™å­—ã€è¯»å­—ã€‚

```
å…±äº«å†…å­˜ç¤ºæ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿›ç¨‹ A  â”‚ -------> â”‚   å…±äº«å†…å­˜åŒºåŸŸ   â”‚ <------- â”‚ è¿›ç¨‹ B  â”‚
â”‚         â”‚   è¯»å†™    â”‚ [æ•°æ®][æ•°æ®]... â”‚   è¯»å†™    â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼š
- å¤šä¸ªè¿›ç¨‹ç›´æ¥è®¿é—®åŒä¸€å—å†…å­˜
- é€Ÿåº¦æœ€å¿«çš„IPCæ–¹å¼
- éœ€è¦åŒæ­¥æœºåˆ¶é˜²æ­¢å†²çª
```

**å…±äº«å†…å­˜çš„ä¼˜åŠ¿**ï¼š
- **é€Ÿåº¦å¿«**ï¼šç›´æ¥å†…å­˜è®¿é—®ï¼Œæ— éœ€å†…æ ¸å¤åˆ¶
- **å®¹é‡å¤§**ï¼šå¯ä»¥åˆ†é…å¤§å—å†…å­˜åŒºåŸŸ
- **çµæ´»æ€§**ï¼šå¯ä»¥å­˜å‚¨å¤æ‚çš„æ•°æ®ç»“æ„

### 4.2 æ ¸å¿ƒæ¥å£è¯¦è§£


#### shm_open - åˆ›å»ºå…±äº«å†…å­˜å¯¹è±¡


```c
#include <sys/mman.h>
#include <sys/stat.h>
#include <fcntl.h>

int shm_open(const char *name, int oflag, mode_t mode);
```

**å·¥ä½œåŸç†**ï¼šåˆ›å»ºä¸€ä¸ª**ç±»ä¼¼æ–‡ä»¶çš„å†…å­˜å¯¹è±¡**ï¼Œè¿”å›æ–‡ä»¶æè¿°ç¬¦ã€‚

```c
// åˆ›å»ºå…±äº«å†…å­˜å¯¹è±¡
int shm_fd = shm_open("/myshm",           // åå­—
                      O_CREAT | O_RDWR,   // åˆ›å»º+è¯»å†™
                      0644);              // æƒé™
if (shm_fd == -1) {
    perror("shm_open failed");
}

// è®¾ç½®å¤§å°ï¼ˆæ–°åˆ›å»ºçš„å…±äº«å†…å­˜å¤§å°ä¸º0ï¼Œéœ€è¦è®¾ç½®ï¼‰
if (ftruncate(shm_fd, 1024) == -1) {  // è®¾ç½®ä¸º1KB
    perror("ftruncate failed");
}
```

#### mmap - æ˜ å°„å…±äº«å†…å­˜åˆ°è¿›ç¨‹åœ°å€ç©ºé—´


```c
#include <sys/mman.h>

void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);
```

**å‚æ•°è¯¦è§£**ï¼š
- **addr**ï¼šæŒ‡å®šæ˜ å°„åœ°å€ï¼Œé€šå¸¸è®¾ä¸ºNULLè®©ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©
- **length**ï¼šæ˜ å°„é•¿åº¦
- **prot**ï¼šå†…å­˜ä¿æŠ¤æ ‡å¿—
  - `PROT_READ`ï¼šå¯è¯»
  - `PROT_WRITE`ï¼šå¯å†™
- **flags**ï¼šæ˜ å°„æ ‡å¿—
  - `MAP_SHARED`ï¼šå¤šè¿›ç¨‹å…±äº«
- **fd**ï¼šæ–‡ä»¶æè¿°ç¬¦ï¼ˆshm_openè¿”å›çš„ï¼‰
- **offset**ï¼šåç§»é‡ï¼Œé€šå¸¸ä¸º0

**æ˜ å°„ç¤ºä¾‹**ï¼š
```c
// å°†å…±äº«å†…å­˜æ˜ å°„åˆ°è¿›ç¨‹ç©ºé—´
void *ptr = mmap(NULL,                    // ç³»ç»Ÿé€‰æ‹©åœ°å€
                 1024,                    // å¤§å°1KB  
                 PROT_READ | PROT_WRITE,  // å¯è¯»å†™
                 MAP_SHARED,              // å…±äº«æ˜ å°„
                 shm_fd,                  // å…±äº«å†…å­˜æè¿°ç¬¦
                 0);                      // åç§»é‡0
if (ptr == MAP_FAILED) {
    perror("mmap failed");
}

// ç°åœ¨å¯ä»¥åƒæ™®é€šæŒ‡é’ˆä¸€æ ·ä½¿ç”¨ptr
strcpy((char*)ptr, "Hello from shared memory!");
```

### 4.3 å®Œæ•´å…±äº«å†…å­˜ç¤ºä¾‹


**å†™è¿›ç¨‹ï¼ˆwriter.cï¼‰**ï¼š
```c
#include <sys/mman.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <string.h>
#include <stdio.h>

#define SHM_NAME "/myshm"
#define SHM_SIZE 1024

int main() {
    int shm_fd;
    void *ptr;
    
    // 1. åˆ›å»ºå…±äº«å†…å­˜å¯¹è±¡
    shm_fd = shm_open(SHM_NAME, O_CREAT | O_RDWR, 0644);
    if (shm_fd == -1) {
        perror("shm_open");
        return 1;
    }
    
    // 2. è®¾ç½®å¤§å°
    if (ftruncate(shm_fd, SHM_SIZE) == -1) {
        perror("ftruncate");
        return 1;
    }
    
    // 3. æ˜ å°„åˆ°å†…å­˜
    ptr = mmap(NULL, SHM_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, shm_fd, 0);
    if (ptr == MAP_FAILED) {
        perror("mmap");
        return 1;
    }
    
    // 4. å†™å…¥æ•°æ®
    sprintf((char*)ptr, "å½“å‰æ—¶é—´: %ld", time(NULL));
    printf("å†™è¿›ç¨‹ï¼šå·²å†™å…¥æ•°æ®åˆ°å…±äº«å†…å­˜\n");
    
    // 5. ç­‰å¾…è¯»è¿›ç¨‹å¤„ç†
    printf("å†™è¿›ç¨‹ï¼šæŒ‰å›è½¦é”®ç»§ç»­...\n");
    getchar();
    
    // 6. æ¸…ç†èµ„æº
    munmap(ptr, SHM_SIZE);
    close(shm_fd);
    shm_unlink(SHM_NAME);  // åˆ é™¤å…±äº«å†…å­˜å¯¹è±¡
    
    return 0;
}
```

**è¯»è¿›ç¨‹ï¼ˆreader.cï¼‰**ï¼š
```c
#include <sys/mman.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdio.h>

#define SHM_NAME "/myshm"
#define SHM_SIZE 1024

int main() {
    int shm_fd;
    void *ptr;
    
    // 1. æ‰“å¼€å…±äº«å†…å­˜å¯¹è±¡
    shm_fd = shm_open(SHM_NAME, O_RDONLY, 0644);
    if (shm_fd == -1) {
        perror("shm_open");
        return 1;
    }
    
    // 2. æ˜ å°„åˆ°å†…å­˜
    ptr = mmap(NULL, SHM_SIZE, PROT_READ, MAP_SHARED, shm_fd, 0);
    if (ptr == MAP_FAILED) {
        perror("mmap");
        return 1;
    }
    
    // 3. è¯»å–æ•°æ®
    printf("è¯»è¿›ç¨‹ï¼šä»å…±äº«å†…å­˜è¯»å–: %s\n", (char*)ptr);
    
    // 4. æ¸…ç†èµ„æº
    munmap(ptr, SHM_SIZE);
    close(shm_fd);
    
    return 0;
}
```

**ç¼–è¯‘è¿è¡Œ**ï¼š
```bash
# ç¼–è¯‘ï¼ˆéœ€è¦é“¾æ¥å®æ—¶åº“ï¼‰
gcc -o writer writer.c -lrt
gcc -o reader reader.c -lrt

# è¿è¡Œ
./writer &    # åå°è¿è¡Œå†™è¿›ç¨‹
./reader      # è¿è¡Œè¯»è¿›ç¨‹
```

### 4.4 å…±äº«å†…å­˜åŒæ­¥é—®é¢˜


**é—®é¢˜**ï¼šå¤šä¸ªè¿›ç¨‹åŒæ—¶è¯»å†™å…±äº«å†…å­˜å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šç»“åˆä¿¡å·é‡å®ç°åŒæ­¥ã€‚

```c
// ç»“åˆä¿¡å·é‡çš„å®‰å…¨å…±äº«å†…å­˜
typedef struct {
    int count;
    char data[1000];
} shared_data_t;

// å†™æ“ä½œ
sem_wait(mutex);           // è·å–äº’æ–¥é”
shared_data_t *data = (shared_data_t*)ptr;
data->count++;
sprintf(data->data, "æ›´æ–°æ¬¡æ•°: %d", data->count);
sem_post(mutex);           // é‡Šæ”¾äº’æ–¥é”
```

---

## 5. âš¡ å®æ—¶ä¿¡å·é˜Ÿåˆ—æœºåˆ¶


### 5.1 ä»€ä¹ˆæ˜¯å®æ—¶ä¿¡å·


**ä¼ ç»Ÿä¿¡å· vs å®æ—¶ä¿¡å·å¯¹æ¯”**ï¼š

```
ä¼ ç»Ÿä¿¡å·é—®é¢˜ï¼š
è¿›ç¨‹A                    è¿›ç¨‹B
  |                       |
  |--SIGUSR1------------>|  â† ç¬¬1ä¸ªä¿¡å·
  |--SIGUSR1------------>|  â† ç¬¬2ä¸ªä¿¡å·ï¼ˆä¸¢å¤±ï¼ï¼‰
  |--SIGUSR1------------>|  â† ç¬¬3ä¸ªä¿¡å·ï¼ˆä¸¢å¤±ï¼ï¼‰
                          |
                          åªæ”¶åˆ°1ä¸ªSIGUSR1

å®æ—¶ä¿¡å·ä¼˜åŠ¿ï¼š
è¿›ç¨‹A                    è¿›ç¨‹B  
  |                       |
  |--SIGRTMIN+0---------->|  â† ä¿¡å·1 + æ•°æ®1
  |--SIGRTMIN+0---------->|  â† ä¿¡å·2 + æ•°æ®2 
  |--SIGRTMIN+0---------->|  â† ä¿¡å·3 + æ•°æ®3
                          |
                          æ”¶åˆ°3ä¸ªä¿¡å·ï¼ŒæŒ‰é¡ºåºå¤„ç†
```

**å®æ—¶ä¿¡å·çš„ç‰¹ç‚¹**ï¼š
- **ä¸ä¼šä¸¢å¤±**ï¼šå¤šä¸ªç›¸åŒå®æ—¶ä¿¡å·ä¼šæ’é˜Ÿ
- **æºå¸¦æ•°æ®**ï¼šå¯ä»¥é™„å¸¦æ•´æ•°æˆ–æŒ‡é’ˆæ•°æ®
- **æœ‰åºä¼ é€’**ï¼šæŒ‰ä¼˜å…ˆçº§å’Œå‘é€é¡ºåºä¼ é€’
- **ç¼–å·èŒƒå›´**ï¼šSIGRTMIN åˆ° SIGRTMAXï¼ˆé€šå¸¸æ˜¯34-64ï¼‰

### 5.2 å®æ—¶ä¿¡å·å‘é€æ¥å£


#### sigqueue - å‘é€å¸¦æ•°æ®çš„å®æ—¶ä¿¡å·


```c
#include <signal.h>

int sigqueue(pid_t pid, int sig, const union sigval value);
```

**sigvalè”åˆä½“**ï¼š
```c
union sigval {
    int   sival_int;    // æ•´æ•°æ•°æ®
    void *sival_ptr;    // æŒ‡é’ˆæ•°æ®
};
```

**å‘é€ç¤ºä¾‹**ï¼š
```c
#include <signal.h>
#include <stdio.h>

int main() {
    pid_t target_pid = 1234;  // ç›®æ ‡è¿›ç¨‹PID
    
    // å‘é€å¸¦æ•´æ•°æ•°æ®çš„å®æ—¶ä¿¡å·
    union sigval data;
    data.sival_int = 42;  // è¦ä¼ é€’çš„æ•´æ•°
    
    if (sigqueue(target_pid, SIGRTMIN+0, data) == -1) {
        perror("sigqueue failed");
    } else {
        printf("å·²å‘é€å®æ—¶ä¿¡å·ï¼Œæºå¸¦æ•°æ®: %d\n", data.sival_int);
    }
    
    return 0;
}
```

### 5.3 å®æ—¶ä¿¡å·æ¥æ”¶å¤„ç†


#### sigaction - å®‰è£…ä¿¡å·å¤„ç†å™¨


```c
#include <signal.h>

int sigaction(int signum, const struct sigaction *act, struct sigaction *oldact);
```

**å¤„ç†å®æ—¶ä¿¡å·çš„å…³é”®**ï¼šä½¿ç”¨`SA_SIGINFO`æ ‡å¿—è·å–é™„åŠ ä¿¡æ¯ã€‚

```c
#include <signal.h>
#include <stdio.h>

// å®æ—¶ä¿¡å·å¤„ç†å‡½æ•°
void rt_signal_handler(int sig, siginfo_t *info, void *context) {
    printf("æ”¶åˆ°å®æ—¶ä¿¡å· %d\n", sig);
    printf("å‘é€è¿›ç¨‹PID: %d\n", info->si_pid);
    printf("æºå¸¦çš„æ•°æ®: %d\n", info->si_value.sival_int);
    printf("ä¿¡å·æ¥æº: %s\n", 
           (info->si_code == SI_QUEUE) ? "sigqueueå‘é€" : "å…¶ä»–æ–¹å¼");
}

int main() {
    struct sigaction sa;
    
    // è®¾ç½®ä¿¡å·å¤„ç†å™¨
    sa.sa_sigaction = rt_signal_handler;  // å¤„ç†å‡½æ•°
    sigemptyset(&sa.sa_mask);
    sa.sa_flags = SA_SIGINFO;             // å¯ç”¨æ‰©å±•ä¿¡æ¯
    
    // æ³¨å†Œå¤„ç†å™¨
    if (sigaction(SIGRTMIN+0, &sa, NULL) == -1) {
        perror("sigaction failed");
        return 1;
    }
    
    printf("ç­‰å¾…å®æ—¶ä¿¡å·... (PID: %d)\n", getpid());
    
    // ç­‰å¾…ä¿¡å·
    while (1) {
        pause();  // æš‚åœç­‰å¾…ä¿¡å·
    }
    
    return 0;
}
```

### 5.4 å®æ—¶ä¿¡å·é˜Ÿåˆ—ç¤ºä¾‹


**å‘é€ç«¯ï¼ˆsender.cï¼‰**ï¼š
```c
#include <signal.h>
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>

int main(int argc, char *argv[]) {
    if (argc != 2) {
        printf("ç”¨æ³•: %s <ç›®æ ‡è¿›ç¨‹PID>\n", argv[0]);
        return 1;
    }
    
    pid_t target_pid = atoi(argv[1]);
    union sigval data;
    
    // å‘é€å¤šä¸ªå®æ—¶ä¿¡å·ï¼Œæ¯ä¸ªæºå¸¦ä¸åŒæ•°æ®
    for (int i = 1; i <= 5; i++) {
        data.sival_int = i * 100;  // æ•°æ®: 100, 200, 300, 400, 500
        
        if (sigqueue(target_pid, SIGRTMIN+0, data) == -1) {
            perror("sigqueue failed");
        } else {
            printf("å‘é€ä¿¡å· %dï¼Œæ•°æ®: %d\n", i, data.sival_int);
        }
        
        usleep(100000);  // ç­‰å¾…0.1ç§’
    }
    
    return 0;
}
```

**æ¥æ”¶ç«¯ï¼ˆreceiver.cï¼‰**ï¼š
```c
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

int signal_count = 0;

void rt_handler(int sig, siginfo_t *info, void *context) {
    signal_count++;
    printf("ç¬¬%dä¸ªä¿¡å·: æ•°æ®=%d, æ¥è‡ªPID=%d\n", 
           signal_count, info->si_value.sival_int, info->si_pid);
}

int main() {
    struct sigaction sa;
    
    sa.sa_sigaction = rt_handler;
    sigemptyset(&sa.sa_mask);
    sa.sa_flags = SA_SIGINFO;
    
    sigaction(SIGRTMIN+0, &sa, NULL);
    
    printf("æ¥æ”¶è¿›ç¨‹å¯åŠ¨ (PID: %d)\n", getpid());
    printf("ç­‰å¾…å®æ—¶ä¿¡å·...\n");
    
    // ç­‰å¾…10ç§’é’Ÿæ¥æ”¶ä¿¡å·
    alarm(10);
    while (signal_count < 5) {
        pause();
    }
    
    printf("æ€»å…±æ¥æ”¶åˆ° %d ä¸ªä¿¡å·\n", signal_count);
    return 0;
}
```

---

## 6. ğŸ“¡ å¼‚æ­¥I/Oä¸ä¿¡å·é©±åŠ¨I/O


### 6.1 ä»€ä¹ˆæ˜¯å¼‚æ­¥I/O


**åŒæ­¥I/O vs å¼‚æ­¥I/O**ï¼š

```
åŒæ­¥I/Oï¼ˆé˜»å¡ï¼‰ï¼š
è¿›ç¨‹                   å†…æ ¸
  |                     |
  |--read()------------>| â† è¿›ç¨‹ç­‰å¾…
  |      ç­‰å¾…ä¸­...       | 
  |<----æ•°æ®è¿”å›---------|
  |                     |
è¿›ç¨‹è¢«é˜»å¡ç›´åˆ°æ•°æ®å‡†å¤‡å¥½

å¼‚æ­¥I/Oï¼ˆéé˜»å¡ï¼‰ï¼š
è¿›ç¨‹                   å†…æ ¸
  |                     |
  |--aio_read()-------->| â† ç«‹å³è¿”å›
  |<----ç«‹å³è¿”å›--------|
  |                     | 
  | ç»§ç»­å…¶ä»–å·¥ä½œ...      | åå°å¤„ç†I/O
  |                     |
  |<----ä¿¡å·é€šçŸ¥--------|  â† I/Oå®Œæˆé€šçŸ¥
```

**å¼‚æ­¥I/Oçš„ä¼˜åŠ¿**ï¼š
- **éé˜»å¡**ï¼šå‘èµ·I/Oæ“ä½œåç«‹å³è¿”å›
- **å¹¶è¡Œå¤„ç†**ï¼šå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªI/Oæ“ä½œ
- **é«˜æ•ˆåˆ©ç”¨**ï¼šCPUä¸ä¼šå› ç­‰å¾…I/Oè€Œç©ºé—²

### 6.2 POSIXå¼‚æ­¥I/Oæ¥å£


#### aio_read - å¼‚æ­¥è¯»æ“ä½œ


```c
#include <aio.h>

int aio_read(struct aiocb *aiocbp);
```

**aiocbæ§åˆ¶å—**ï¼š
```c
struct aiocb {
    int             aio_fildes;     // æ–‡ä»¶æè¿°ç¬¦
    off_t           aio_offset;     // æ–‡ä»¶åç§»é‡
    volatile void  *aio_buf;        // ç¼“å†²åŒºæŒ‡é’ˆ
    size_t          aio_nbytes;     // è¯»å–å­—èŠ‚æ•°
    int             aio_reqprio;    // è¯·æ±‚ä¼˜å…ˆçº§
    struct sigevent aio_sigevent;   // å®Œæˆæ—¶çš„é€šçŸ¥æ–¹å¼
};
```

**å¼‚æ­¥è¯»å–ç¤ºä¾‹**ï¼š
```c
#include <aio.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

char buffer[1024];
struct aiocb cb;

void aio_completion_handler(int sig, siginfo_t *si, void *ucontext) {
    struct aiocb *req = (struct aiocb*)si->si_value.sival_ptr;
    
    if (aio_error(req) == 0) {
        int bytes = aio_return(req);
        printf("å¼‚æ­¥è¯»å–å®Œæˆï¼Œè¯»å–äº† %d å­—èŠ‚\n", bytes);
        buffer[bytes] = '\0';
        printf("å†…å®¹: %s\n", buffer);
    } else {
        printf("å¼‚æ­¥è¯»å–å¤±è´¥\n");
    }
}

int main() {
    int fd;
    struct sigaction sa;
    
    // æ‰“å¼€æ–‡ä»¶
    fd = open("test.txt", O_RDONLY);
    if (fd == -1) {
        perror("open");
        return 1;
    }
    
    // è®¾ç½®ä¿¡å·å¤„ç†å™¨
    sa.sa_sigaction = aio_completion_handler;
    sigemptyset(&sa.sa_mask);
    sa.sa_flags = SA_SIGINFO;
    sigaction(SIGIO, &sa, NULL);
    
    // è®¾ç½®å¼‚æ­¥I/Oæ§åˆ¶å—
    memset(&cb, 0, sizeof(cb));
    cb.aio_fildes = fd;
    cb.aio_offset = 0;
    cb.aio_buf = buffer;
    cb.aio_nbytes = sizeof(buffer) - 1;
    cb.aio_sigevent.sigev_notify = SIGEV_SIGNAL;  // ä¿¡å·é€šçŸ¥
    cb.aio_sigevent.sigev_signo = SIGIO;          // ä½¿ç”¨SIGIOä¿¡å·
    cb.aio_sigevent.sigev_value.sival_ptr = &cb;  // ä¼ é€’æ§åˆ¶å—æŒ‡é’ˆ
    
    // å‘èµ·å¼‚æ­¥è¯»å–
    if (aio_read(&cb) == -1) {
        perror("aio_read");
        return 1;
    }
    
    printf("å¼‚æ­¥è¯»å–å·²å¯åŠ¨ï¼Œç»§ç»­å…¶ä»–å·¥ä½œ...\n");
    
    // æ¨¡æ‹Ÿå…¶ä»–å·¥ä½œ
    for (int i = 0; i < 5; i++) {
        printf("åšå…¶ä»–å·¥ä½œ... %d\n", i);
        sleep(1);
    }
    
    // ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ
    pause();
    
    close(fd);
    return 0;
}
```

### 6.3 ä¿¡å·é©±åŠ¨I/O


**æ¦‚å¿µ**ï¼šå½“æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¿›è¡ŒI/Oæ“ä½œæ—¶ï¼Œå†…æ ¸å‘é€SIGIOä¿¡å·é€šçŸ¥è¿›ç¨‹ã€‚

**è®¾ç½®ä¿¡å·é©±åŠ¨I/O**ï¼š
```c
#include <fcntl.h>
#include <signal.h>

void sigio_handler(int sig) {
    printf("æ”¶åˆ°SIGIOä¿¡å·ï¼Œå¯ä»¥è¿›è¡ŒI/Oæ“ä½œäº†\n");
    // åœ¨è¿™é‡Œè¿›è¡Œå®é™…çš„I/Oæ“ä½œ
}

int main() {
    int fd;
    struct sigaction sa;
    
    // è®¾ç½®SIGIOä¿¡å·å¤„ç†å™¨
    sa.sa_handler = sigio_handler;
    sigemptyset(&sa.sa_mask);
    sa.sa_flags = 0;
    sigaction(SIGIO, &sa, NULL);
    
    // æ‰“å¼€æ–‡ä»¶
    fd = open("test.txt", O_RDONLY);
    
    // è®¾ç½®æ–‡ä»¶æè¿°ç¬¦çš„æ‹¥æœ‰è€…ä¸ºå½“å‰è¿›ç¨‹
    fcntl(fd, F_SETOWN, getpid());
    
    // å¯ç”¨ä¿¡å·é©±åŠ¨I/O
    int flags = fcntl(fd, F_GETFL);
    fcntl(fd, F_SETFL, flags | O_ASYNC);
    
    printf("ä¿¡å·é©±åŠ¨I/Oå·²å¯ç”¨ï¼Œç­‰å¾…ä¿¡å·...\n");
    
    while (1) {
        pause();  // ç­‰å¾…ä¿¡å·
    }
    
    return 0;
}
```

### 6.4 å¼‚æ­¥I/OçŠ¶æ€æ£€æŸ¥


#### aio_error - æ£€æŸ¥æ“ä½œçŠ¶æ€


```c
int aio_error(const struct aiocb *aiocbp);
```

**è¿”å›å€¼**ï¼š
- **0**ï¼šæ“ä½œæˆåŠŸå®Œæˆ
- **EINPROGRESS**ï¼šæ“ä½œä»åœ¨è¿›è¡Œä¸­
- **å…¶ä»–å€¼**ï¼šæ“ä½œå¤±è´¥çš„é”™è¯¯ç 

#### aio_return - è·å–æ“ä½œç»“æœ


```c
ssize_t aio_return(struct aiocb *aiocbp);
```

**å®Œæ•´æ£€æŸ¥ç¤ºä¾‹**ï¼š
```c
// æ£€æŸ¥å¼‚æ­¥æ“ä½œçŠ¶æ€
int check_aio_status(struct aiocb *cb) {
    int error = aio_error(cb);
    
    switch (error) {
        case 0:
            // æ“ä½œå®Œæˆ
            printf("æ“ä½œæˆåŠŸï¼Œè¯»å–äº† %ld å­—èŠ‚\n", aio_return(cb));
            return 1;  // å®Œæˆ
            
        case EINPROGRESS:
            printf("æ“ä½œä»åœ¨è¿›è¡Œä¸­...\n");
            return 0;  // è¿›è¡Œä¸­
            
        default:
            printf("æ“ä½œå¤±è´¥: %s\n", strerror(error));
            return -1; // å¤±è´¥
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ POSIX IPCç‰¹ç‚¹ï¼šæ ‡å‡†åŒ–ã€é¢å‘å¯¹è±¡ã€æ–‡ä»¶æè¿°ç¬¦ã€å¼•ç”¨è®¡æ•°
ğŸ”¸ æ¶ˆæ¯é˜Ÿåˆ—ï¼šæœ‰åºæ’é˜Ÿã€æ”¯æŒä¼˜å…ˆçº§ã€å¼‚æ­¥é€šä¿¡
ğŸ”¸ ä¿¡å·é‡æœºåˆ¶ï¼šèµ„æºè®¡æ•°ã€åŒæ­¥æ§åˆ¶ã€å‘½åvsåŒ¿å
ğŸ”¸ å…±äº«å†…å­˜ï¼šé€Ÿåº¦æœ€å¿«ã€ç›´æ¥è®¿é—®ã€éœ€è¦åŒæ­¥
ğŸ”¸ å®æ—¶ä¿¡å·ï¼šä¸ä¸¢å¤±ã€æºå¸¦æ•°æ®ã€æœ‰åºä¼ é€’
ğŸ”¸ å¼‚æ­¥I/Oï¼šéé˜»å¡ã€å¹¶è¡Œå¤„ç†ã€ä¿¡å·é€šçŸ¥
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ POSIX vs System Vçš„æ ¹æœ¬å·®å¼‚**
```
è®¾è®¡å“²å­¦ï¼š
- System Vï¼šåŸºäºkeyçš„å…¨å±€å‘½å
- POSIXï¼šåŸºäºnameçš„æ–‡ä»¶ç³»ç»Ÿå‘½å

å®é™…å½±å“ï¼š
- POSIXæ›´ç¬¦åˆUnix"ä¸€åˆ‡çš†æ–‡ä»¶"ç†å¿µ
- POSIXæƒé™ç®¡ç†æ›´ç›´è§‚
- POSIXè·¨å¹³å°å…¼å®¹æ€§æ›´å¥½
```

**ğŸ”¹ æ¥å£ä½¿ç”¨çš„ç»Ÿä¸€æ¨¡å¼**
```
POSIX IPCçš„ç»Ÿä¸€æ¨¡å¼ï¼š
1. xxx_open() - åˆ›å»º/æ‰“å¼€IPCå¯¹è±¡
2. å…·ä½“æ“ä½œ - è¯»å†™ã€ç­‰å¾…ã€å‘é€ç­‰
3. xxx_close() - å…³é—­å¯¹è±¡
4. xxx_unlink() - åˆ é™¤å¯¹è±¡

è¿™ç§æ¨¡å¼ç±»ä¼¼æ–‡ä»¶æ“ä½œï¼Œå®¹æ˜“ç†è§£è®°å¿†
```

**ğŸ”¹ åŒæ­¥çš„é‡è¦æ€§**
```
å…±äº«èµ„æºè®¿é—®å¿…é¡»åŒæ­¥ï¼š
- æ¶ˆæ¯é˜Ÿåˆ—ï¼šå†…éƒ¨å·²åŒæ­¥ï¼Œå¯ç›´æ¥ä½¿ç”¨
- ä¿¡å·é‡ï¼šä¸“é—¨ç”¨äºåŒæ­¥æ§åˆ¶
- å…±äº«å†…å­˜ï¼šå¿…é¡»é…åˆä¿¡å·é‡ä½¿ç”¨
- å®æ—¶ä¿¡å·ï¼šæœ‰åºä¼ é€’ï¼Œå¤©ç„¶åŒæ­¥
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**æŠ€æœ¯é€‰æ‹©å»ºè®®**ï¼š
- **æ•°æ®äº¤æ¢é¢‘ç¹**ï¼šé€‰æ‹©å…±äº«å†…å­˜ + ä¿¡å·é‡
- **å¼‚æ­¥é€šä¿¡**ï¼šé€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—
- **èµ„æºæ§åˆ¶**ï¼šé€‰æ‹©ä¿¡å·é‡
- **å®æ—¶é€šä¿¡**ï¼šé€‰æ‹©å®æ—¶ä¿¡å·
- **é«˜æ€§èƒ½I/O**ï¼šé€‰æ‹©å¼‚æ­¥I/O

**ç¼–ç¨‹å®è·µè¦ç‚¹**ï¼š
- æ€»æ˜¯æ£€æŸ¥è¿”å›å€¼å¹¶å¤„ç†é”™è¯¯
- åŠæ—¶æ¸…ç†èµ„æºï¼Œé¿å…ç³»ç»Ÿèµ„æºæ³„æ¼
- åˆç†è®¾ç½®æƒé™ï¼Œç¡®ä¿å®‰å…¨æ€§
- ä½¿ç”¨ä¿¡å·é‡é¿å…ç«æ€æ¡ä»¶

### 7.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**æƒé™é—®é¢˜**ï¼š
```bash
# æŸ¥çœ‹POSIX IPCå¯¹è±¡
ls /dev/shm/      # å…±äº«å†…å­˜å¯¹è±¡
ls /dev/mqueue/   # æ¶ˆæ¯é˜Ÿåˆ—å¯¹è±¡

# æ¸…ç†æ®‹ç•™å¯¹è±¡
sudo rm /dev/shm/myshm
sudo rm /dev/mqueue/myqueue
```

**ç¼–è¯‘é“¾æ¥**ï¼š
```bash
# POSIX IPCéœ€è¦é“¾æ¥å®æ—¶åº“
gcc program.c -lrt -lpthread
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- POSIX IPCç»Ÿä¸€ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå‘½åï¼Œæƒé™ç®¡ç†ç®€å•
- æ¶ˆæ¯é˜Ÿåˆ—æ”¯æŒä¼˜å…ˆçº§ï¼Œä¿¡å·é‡æ§åˆ¶èµ„æºï¼Œå…±äº«å†…å­˜æœ€å¿«é€Ÿ
- å®æ—¶ä¿¡å·ä¸ä¸¢å¤±å¯æºå¸¦æ•°æ®ï¼Œå¼‚æ­¥I/Oæé«˜å¹¶è¡Œæ€§èƒ½
- åŒæ­¥æ˜¯å…³é”®ï¼Œåˆç†é€‰æ‹©IPCæœºåˆ¶äº‹åŠåŠŸå€