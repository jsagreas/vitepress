---
title: 12ã€å¤šçº¿ç¨‹åŒæ­¥ä¸äº’æ–¥
---
## ğŸ“š ç›®å½•

1. [pthreadçº¿ç¨‹åº“åŸºç¡€æ“ä½œ](#1-pthreadçº¿ç¨‹åº“åŸºç¡€æ“ä½œ)
2. [äº’æ–¥é”mutexåˆ›å»ºä¸ä½¿ç”¨](#2-äº’æ–¥é”mutexåˆ›å»ºä¸ä½¿ç”¨)
3. [æ¡ä»¶å˜é‡conditionç­‰å¾…ä¸ä¿¡å·](#3-æ¡ä»¶å˜é‡conditionç­‰å¾…ä¸ä¿¡å·)
4. [è¯»å†™é”rwlockå…±äº«ä¸ç‹¬å ](#4-è¯»å†™é”rwlockå…±äº«ä¸ç‹¬å )
5. [è‡ªæ—‹é”spinlocké«˜æ€§èƒ½åœºæ™¯](#5-è‡ªæ—‹é”spinlocké«˜æ€§èƒ½åœºæ™¯)
6. [çº¿ç¨‹æœ¬åœ°å­˜å‚¨TLSæœºåˆ¶](#6-çº¿ç¨‹æœ¬åœ°å­˜å‚¨tlsæœºåˆ¶)
7. [çº¿ç¨‹å–æ¶ˆä¸æ¸…ç†å¤„ç†](#7-çº¿ç¨‹å–æ¶ˆä¸æ¸…ç†å¤„ç†)
8. [æ­»é”æ£€æµ‹ä¸é¢„é˜²ç­–ç•¥](#8-æ­»é”æ£€æµ‹ä¸é¢„é˜²ç­–ç•¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ§µ pthreadçº¿ç¨‹åº“åŸºç¡€æ“ä½œ


### 1.1 ä»€ä¹ˆæ˜¯pthreadçº¿ç¨‹åº“


**ç®€å•ç†è§£**ï¼špthreadå°±æ˜¯Linuxç³»ç»Ÿä¸­åˆ›å»ºå’Œç®¡ç†å¤šçº¿ç¨‹çš„"å·¥å…·ç®±"

```
ç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼š
å°±åƒä¸€å®¶é¤å…éœ€è¦å¤šä¸ªæœåŠ¡å‘˜åŒæ—¶å·¥ä½œ
- ä¸»å¨ï¼ˆä¸»çº¿ç¨‹ï¼‰è´Ÿè´£æ•´ä½“è°ƒåº¦
- æœåŠ¡å‘˜ä»¬ï¼ˆå­çº¿ç¨‹ï¼‰å„è‡ªå¤„ç†ä¸åŒæ¡Œçš„å®¢äºº
- pthreadå°±æ˜¯ç®¡ç†è¿™äº›æœåŠ¡å‘˜çš„"æ’ç­ç³»ç»Ÿ"
```

**pthreadçš„æ ¸å¿ƒä½œç”¨**ï¼š
- **åˆ›å»ºçº¿ç¨‹**ï¼šè®©ç¨‹åºå¯ä»¥åŒæ—¶åšå¤šä»¶äº‹
- **ç®¡ç†çº¿ç¨‹**ï¼šæ§åˆ¶çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ
- **åŒæ­¥çº¿ç¨‹**ï¼šç¡®ä¿å¤šä¸ªçº¿ç¨‹åè°ƒå·¥ä½œä¸å‡ºä¹±å­

### 1.2 pthreadåŸºæœ¬æ¦‚å¿µ


> ğŸ’¡ **æ ¸å¿ƒæ¦‚å¿µ**  
> **çº¿ç¨‹**ï¼šç¨‹åºå†…éƒ¨çš„"å°ç¨‹åº"ï¼Œå¯ä»¥ç‹¬ç«‹æ‰§è¡Œä»»åŠ¡  
> **å¤šçº¿ç¨‹**ï¼šä¸€ä¸ªç¨‹åºåŒæ—¶è¿è¡Œå¤šä¸ªçº¿ç¨‹ï¼Œæé«˜æ•ˆç‡

**ä¸ºä»€ä¹ˆéœ€è¦å¤šçº¿ç¨‹ï¼Ÿ**
```
å•çº¿ç¨‹å¤„ç†ï¼š
ä»»åŠ¡A â†’ ä»»åŠ¡B â†’ ä»»åŠ¡C  (ä¸²è¡Œï¼Œæ…¢)

å¤šçº¿ç¨‹å¤„ç†ï¼š
ä»»åŠ¡A â†˜
ä»»åŠ¡B â†’ åŒæ—¶æ‰§è¡Œ (å¹¶è¡Œï¼Œå¿«)  
ä»»åŠ¡C â†—
```

### 1.3 pthreadåŸºç¡€æ“ä½œå‡½æ•°


**ğŸ”§ çº¿ç¨‹åˆ›å»ºä¸é”€æ¯**

```c
#include <pthread.h>

// 1. åˆ›å»ºçº¿ç¨‹
int pthread_create(pthread_t *thread,           // çº¿ç¨‹IDå­˜å‚¨ä½ç½®
                  const pthread_attr_t *attr,   // çº¿ç¨‹å±æ€§(é€šå¸¸NULL)
                  void *(*start_routine)(void*), // çº¿ç¨‹è¦æ‰§è¡Œçš„å‡½æ•°
                  void *arg);                   // ä¼ ç»™å‡½æ•°çš„å‚æ•°

// 2. ç­‰å¾…çº¿ç¨‹ç»“æŸ
int pthread_join(pthread_t thread,    // è¦ç­‰å¾…çš„çº¿ç¨‹ID
                void **retval);       // æ¥æ”¶çº¿ç¨‹è¿”å›å€¼

// 3. çº¿ç¨‹é€€å‡º
void pthread_exit(void *retval);      // é€€å‡ºå½“å‰çº¿ç¨‹å¹¶è¿”å›å€¼

// 4. è·å–å½“å‰çº¿ç¨‹ID
pthread_t pthread_self(void);
```

**ğŸ“ æœ€ç®€å•çš„å¤šçº¿ç¨‹ç¤ºä¾‹**

```c
#include <stdio.h>
#include <pthread.h>
#include <unistd.h>

// çº¿ç¨‹è¦æ‰§è¡Œçš„å‡½æ•°
void* worker_thread(void* arg) {
    int thread_num = *(int*)arg;
    
    printf("çº¿ç¨‹%då¼€å§‹å·¥ä½œ...\n", thread_num);
    sleep(2);  // æ¨¡æ‹Ÿå·¥ä½œ2ç§’
    printf("çº¿ç¨‹%då·¥ä½œå®Œæˆ!\n", thread_num);
    
    return NULL;
}

int main() {
    pthread_t threads[3];  // å­˜å‚¨3ä¸ªçº¿ç¨‹ID
    int thread_ids[3] = {1, 2, 3};
    
    // åˆ›å»º3ä¸ªå·¥ä½œçº¿ç¨‹
    for(int i = 0; i < 3; i++) {
        pthread_create(&threads[i], NULL, worker_thread, &thread_ids[i]);
    }
    
    printf("ä¸»çº¿ç¨‹ï¼šæ‰€æœ‰å·¥ä½œçº¿ç¨‹å·²å¯åŠ¨\n");
    
    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    for(int i = 0; i < 3; i++) {
        pthread_join(threads[i], NULL);
    }
    
    printf("ä¸»çº¿ç¨‹ï¼šæ‰€æœ‰å·¥ä½œå®Œæˆï¼\n");
    return 0;
}

// ç¼–è¯‘å‘½ä»¤ï¼šgcc -o demo demo.c -lpthread
```

### 1.4 çº¿ç¨‹å±æ€§è®¾ç½®


**ğŸ¯ å¸¸ç”¨çº¿ç¨‹å±æ€§**

```c
pthread_attr_t attr;

// åˆå§‹åŒ–å±æ€§
pthread_attr_init(&attr);

// è®¾ç½®çº¿ç¨‹åˆ†ç¦»çŠ¶æ€ï¼ˆåˆ›å»ºåè‡ªåŠ¨å›æ”¶èµ„æºï¼‰
pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_DETACHED);

// è®¾ç½®æ ˆå¤§å°
pthread_attr_setstacksize(&attr, 1024 * 1024);  // 1MBæ ˆç©ºé—´

// ä½¿ç”¨å±æ€§åˆ›å»ºçº¿ç¨‹
pthread_create(&thread, &attr, worker_function, NULL);

// æ¸…ç†å±æ€§èµ„æº
pthread_attr_destroy(&attr);
```

> âš ï¸ **é‡è¦æé†’**  
> ç¼–è¯‘pthreadç¨‹åºæ—¶å¿…é¡»é“¾æ¥pthreadåº“ï¼š`gcc -lpthread`

---

## 2. ğŸ”’ äº’æ–¥é”mutexåˆ›å»ºä¸ä½¿ç”¨


### 2.1 ä»€ä¹ˆæ˜¯äº’æ–¥é”


**é€šä¿—è§£é‡Š**ï¼šmutexå°±åƒå•æ‰€é—¨ä¸Šçš„é”

```
ç°å®åœºæ™¯ï¼š
- å•æ‰€åŒæ—¶åªèƒ½ä¸€ä¸ªäººä½¿ç”¨
- è¿›å»çš„äººé”é—¨ï¼ˆåŠ é”ï¼‰
- å¤–é¢çš„äººåªèƒ½ç­‰å¾…
- ç”¨å®Œå¼€é—¨ï¼ˆè§£é”ï¼‰ï¼Œä¸‹ä¸€ä¸ªäººæ‰èƒ½è¿›å…¥

ç¨‹åºåœºæ™¯ï¼š
- å…±äº«èµ„æºåŒæ—¶åªèƒ½ä¸€ä¸ªçº¿ç¨‹è®¿é—®
- çº¿ç¨‹è·å–é”ï¼ˆåŠ é”ï¼‰
- å…¶ä»–çº¿ç¨‹ç­‰å¾…
- æ“ä½œå®Œæˆé‡Šæ”¾é”ï¼ˆè§£é”ï¼‰
```

**ä¸ºä»€ä¹ˆéœ€è¦äº’æ–¥é”ï¼Ÿ**

```c
// é—®é¢˜åœºæ™¯ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹å…¨å±€å˜é‡
int counter = 0;  // å…¨å±€è®¡æ•°å™¨

void* increment(void* arg) {
    for(int i = 0; i < 100000; i++) {
        counter++;  // å±é™©ï¼å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹
    }
    return NULL;
}

// ç»“æœï¼šcounterçš„æœ€ç»ˆå€¼æ˜¯ä¸ç¡®å®šçš„ï¼
// åŸå› ï¼šcounter++ä¸æ˜¯åŸå­æ“ä½œï¼Œä¼šè¢«æ‰“æ–­
```

### 2.2 mutexåŸºæœ¬æ“ä½œ


**ğŸ”§ mutexæ ¸å¿ƒå‡½æ•°**

```c
#include <pthread.h>

pthread_mutex_t mutex;  // å£°æ˜äº’æ–¥é”

// 1. åˆå§‹åŒ–é”
int pthread_mutex_init(pthread_mutex_t *mutex, 
                      const pthread_mutexattr_t *attr);

// 2. åŠ é”ï¼ˆå¦‚æœé”è¢«å ç”¨ä¼šç­‰å¾…ï¼‰
int pthread_mutex_lock(pthread_mutex_t *mutex);

// 3. å°è¯•åŠ é”ï¼ˆä¸ç­‰å¾…ï¼Œç«‹å³è¿”å›ç»“æœï¼‰
int pthread_mutex_trylock(pthread_mutex_t *mutex);

// 4. è§£é”
int pthread_mutex_unlock(pthread_mutex_t *mutex);

// 5. é”€æ¯é”
int pthread_mutex_destroy(pthread_mutex_t *mutex);
```

**ğŸ“ mutexä½¿ç”¨ç¤ºä¾‹**

```c
#include <stdio.h>
#include <pthread.h>

int counter = 0;              // å…±äº«èµ„æº
pthread_mutex_t counter_mutex; // ä¿æŠ¤counterçš„é”

void* safe_increment(void* arg) {
    for(int i = 0; i < 100000; i++) {
        // åŠ é” - ç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½ä¿®æ”¹counter
        pthread_mutex_lock(&counter_mutex);
        
        counter++;  // å®‰å…¨çš„ä¿®æ”¹
        
        // è§£é” - è®©å…¶ä»–çº¿ç¨‹å¯ä»¥è®¿é—®
        pthread_mutex_unlock(&counter_mutex);
    }
    return NULL;
}

int main() {
    pthread_t threads[5];
    
    // åˆå§‹åŒ–äº’æ–¥é”
    pthread_mutex_init(&counter_mutex, NULL);
    
    // åˆ›å»º5ä¸ªçº¿ç¨‹åŒæ—¶å¢åŠ counter
    for(int i = 0; i < 5; i++) {
        pthread_create(&threads[i], NULL, safe_increment, NULL);
    }
    
    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    for(int i = 0; i < 5; i++) {
        pthread_join(threads[i], NULL);
    }
    
    printf("æœ€ç»ˆç»“æœï¼š%d (åº”è¯¥æ˜¯500000)\n", counter);
    
    // é”€æ¯é”
    pthread_mutex_destroy(&counter_mutex);
    return 0;
}
```

### 2.3 mutexä½¿ç”¨æœ€ä½³å®è·µ


> ğŸ’¡ **ä½¿ç”¨åŸåˆ™**  
> 1. **åŠ é”èŒƒå›´æœ€å°åŒ–**ï¼šåªåœ¨å¿…è¦æ—¶åŠ é”  
> 2. **é¿å…é•¿æ—¶é—´æŒé”**ï¼šå¿«è¿›å¿«å‡º  
> 3. **é…å¯¹ä½¿ç”¨**ï¼šæ¯ä¸ªlockå¿…é¡»æœ‰å¯¹åº”çš„unlock

**ğŸ¯ æ­£ç¡®çš„åŠ é”æ¨¡å¼**

```c
// âœ… æ­£ç¡®ï¼šæœ€å°åŒ–åŠ é”èŒƒå›´
pthread_mutex_lock(&mutex);
// åªåœ¨è¿™é‡Œæ“ä½œå…±äº«èµ„æº
shared_data++;
pthread_mutex_unlock(&mutex);

// âŒ é”™è¯¯ï¼šæŒé”æ—¶é—´è¿‡é•¿
pthread_mutex_lock(&mutex);
shared_data++;
sleep(1);          // ä¸è¦åœ¨æŒé”æ—¶åšè€—æ—¶æ“ä½œï¼
other_operation(); // ä¸è¦åœ¨æŒé”æ—¶è°ƒç”¨å…¶ä»–å‡½æ•°ï¼
pthread_mutex_unlock(&mutex);
```

---

## 3. ğŸš¦ æ¡ä»¶å˜é‡conditionç­‰å¾…ä¸ä¿¡å·


### 3.1 ä»€ä¹ˆæ˜¯æ¡ä»¶å˜é‡


**ç”Ÿæ´»ç±»æ¯”**ï¼šæ¡ä»¶å˜é‡å°±åƒ"ç­‰å€™åŒºçš„å‘¼å«ç³»ç»Ÿ"

```
é“¶è¡Œæ’é˜Ÿåœºæ™¯ï¼š
1. é¡¾å®¢è¿›å…¥ç­‰å€™åŒºï¼ˆçº¿ç¨‹ç­‰å¾…æ¡ä»¶ï¼‰
2. å·¥ä½œäººå‘˜å¿™å®Œä¸€ä¸ªå®¢æˆ·åæŒ‰é“ƒï¼ˆå‘é€ä¿¡å·ï¼‰
3. ç­‰å€™åŒºçš„é¡¾å®¢å¬åˆ°é“ƒå£°è¿‡å»åŠä¸šåŠ¡ï¼ˆçº¿ç¨‹è¢«å”¤é†’ï¼‰

ç¨‹åºåœºæ™¯ï¼š
1. çº¿ç¨‹æ£€æŸ¥æ¡ä»¶ï¼Œå‘ç°ä¸æ»¡è¶³å°±ç­‰å¾…
2. å…¶ä»–çº¿ç¨‹æ”¹å˜äº†æ¡ä»¶ï¼Œå‘é€ä¿¡å·
3. ç­‰å¾…çš„çº¿ç¨‹è¢«å”¤é†’ï¼Œé‡æ–°æ£€æŸ¥æ¡ä»¶
```

**æ¡ä»¶å˜é‡è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ**

```
é—®é¢˜ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹
- ç”Ÿäº§è€…ï¼šç”Ÿäº§æ•°æ®æ”¾å…¥ç¼“å†²åŒº
- æ¶ˆè´¹è€…ï¼šä»ç¼“å†²åŒºå–æ•°æ®æ¶ˆè´¹
- ç¼“å†²åŒºæ»¡æ—¶ï¼Œç”Ÿäº§è€…éœ€è¦ç­‰å¾…
- ç¼“å†²åŒºç©ºæ—¶ï¼Œæ¶ˆè´¹è€…éœ€è¦ç­‰å¾…
```

### 3.2 æ¡ä»¶å˜é‡åŸºæœ¬æ“ä½œ


**ğŸ”§ æ¡ä»¶å˜é‡æ ¸å¿ƒå‡½æ•°**

```c
#include <pthread.h>

pthread_cond_t cond;    // æ¡ä»¶å˜é‡
pthread_mutex_t mutex;  // é…å¥—ä½¿ç”¨çš„äº’æ–¥é”

// 1. åˆå§‹åŒ–æ¡ä»¶å˜é‡
int pthread_cond_init(pthread_cond_t *cond, 
                     const pthread_condattr_t *attr);

// 2. ç­‰å¾…æ¡ä»¶æ»¡è¶³ï¼ˆä¼šè‡ªåŠ¨é‡Šæ”¾é”å¹¶ç­‰å¾…ï¼‰
int pthread_cond_wait(pthread_cond_t *cond, 
                     pthread_mutex_t *mutex);

// 3. å¸¦è¶…æ—¶çš„ç­‰å¾…
int pthread_cond_timedwait(pthread_cond_t *cond,
                          pthread_mutex_t *mutex,
                          const struct timespec *abstime);

// 4. å”¤é†’ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹
int pthread_cond_signal(pthread_cond_t *cond);

// 5. å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹
int pthread_cond_broadcast(pthread_cond_t *cond);

// 6. é”€æ¯æ¡ä»¶å˜é‡
int pthread_cond_destroy(pthread_cond_t *cond);
```

### 3.3 ç”Ÿäº§è€…-æ¶ˆè´¹è€…å®Œæ•´ç¤ºä¾‹


```c
#include <stdio.h>
#include <pthread.h>
#include <unistd.h>

#define BUFFER_SIZE 5

// å…±äº«ç¼“å†²åŒº
int buffer[BUFFER_SIZE];
int count = 0;          // å½“å‰ç¼“å†²åŒºä¸­çš„æ•°æ®ä¸ªæ•°
int in = 0, out = 0;    // ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä½ç½®æŒ‡é’ˆ

// åŒæ­¥å·¥å…·
pthread_mutex_t mutex;
pthread_cond_t not_full;   // ç¼“å†²åŒºä¸æ»¡çš„æ¡ä»¶
pthread_cond_t not_empty;  // ç¼“å†²åŒºä¸ç©ºçš„æ¡ä»¶

// ç”Ÿäº§è€…çº¿ç¨‹
void* producer(void* arg) {
    int producer_id = *(int*)arg;
    
    for(int i = 0; i < 10; i++) {
        // ç”Ÿäº§ä¸€ä¸ªæ•°æ®
        int item = producer_id * 100 + i;
        
        pthread_mutex_lock(&mutex);
        
        // å¦‚æœç¼“å†²åŒºæ»¡äº†ï¼Œå°±ç­‰å¾…
        while(count == BUFFER_SIZE) {
            printf("ç”Ÿäº§è€…%d: ç¼“å†²åŒºæ»¡ï¼Œç­‰å¾…...\n", producer_id);
            pthread_cond_wait(&not_full, &mutex);
        }
        
        // æ”¾å…¥ç¼“å†²åŒº
        buffer[in] = item;
        in = (in + 1) % BUFFER_SIZE;
        count++;
        
        printf("ç”Ÿäº§è€…%d: ç”Ÿäº§äº† %d (ç¼“å†²åŒºï¼š%d/%d)\n", 
               producer_id, item, count, BUFFER_SIZE);
        
        // é€šçŸ¥æ¶ˆè´¹è€…ï¼šç¼“å†²åŒºä¸ç©ºäº†
        pthread_cond_signal(&not_empty);
        
        pthread_mutex_unlock(&mutex);
        
        usleep(100000);  // æ¨¡æ‹Ÿç”Ÿäº§æ—¶é—´
    }
    return NULL;
}

// æ¶ˆè´¹è€…çº¿ç¨‹
void* consumer(void* arg) {
    int consumer_id = *(int*)arg;
    
    for(int i = 0; i < 10; i++) {
        pthread_mutex_lock(&mutex);
        
        // å¦‚æœç¼“å†²åŒºç©ºï¼Œå°±ç­‰å¾…
        while(count == 0) {
            printf("æ¶ˆè´¹è€…%d: ç¼“å†²åŒºç©ºï¼Œç­‰å¾…...\n", consumer_id);
            pthread_cond_wait(&not_empty, &mutex);
        }
        
        // ä»ç¼“å†²åŒºå–æ•°æ®
        int item = buffer[out];
        out = (out + 1) % BUFFER_SIZE;
        count--;
        
        printf("æ¶ˆè´¹è€…%d: æ¶ˆè´¹äº† %d (ç¼“å†²åŒºï¼š%d/%d)\n", 
               consumer_id, item, count, BUFFER_SIZE);
        
        // é€šçŸ¥ç”Ÿäº§è€…ï¼šç¼“å†²åŒºä¸æ»¡äº†
        pthread_cond_signal(&not_full);
        
        pthread_mutex_unlock(&mutex);
        
        usleep(150000);  // æ¨¡æ‹Ÿæ¶ˆè´¹æ—¶é—´
    }
    return NULL;
}

int main() {
    pthread_t producers[2], consumers[2];
    int producer_ids[2] = {1, 2};
    int consumer_ids[2] = {1, 2};
    
    // åˆå§‹åŒ–åŒæ­¥å·¥å…·
    pthread_mutex_init(&mutex, NULL);
    pthread_cond_init(&not_full, NULL);
    pthread_cond_init(&not_empty, NULL);
    
    // åˆ›å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹
    for(int i = 0; i < 2; i++) {
        pthread_create(&producers[i], NULL, producer, &producer_ids[i]);
        pthread_create(&consumers[i], NULL, consumer, &consumer_ids[i]);
    }
    
    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    for(int i = 0; i < 2; i++) {
        pthread_join(producers[i], NULL);
        pthread_join(consumers[i], NULL);
    }
    
    // æ¸…ç†èµ„æº
    pthread_mutex_destroy(&mutex);
    pthread_cond_destroy(&not_full);
    pthread_cond_destroy(&not_empty);
    
    return 0;
}
```

> ğŸ’¡ **ä½¿ç”¨è¦ç‚¹**  
> - æ¡ä»¶å˜é‡å¿…é¡»å’Œäº’æ–¥é”é…åˆä½¿ç”¨  
> - ä½¿ç”¨`while`å¾ªç¯è€Œä¸æ˜¯`if`æ£€æŸ¥æ¡ä»¶ï¼ˆé˜²æ­¢è™šå‡å”¤é†’ï¼‰  
> - `pthread_cond_wait`ä¼šè‡ªåŠ¨é‡Šæ”¾é”å¹¶ç­‰å¾…ï¼Œè¢«å”¤é†’æ—¶é‡æ–°è·å–é”

---

## 4. ğŸ“š è¯»å†™é”rwlockå…±äº«ä¸ç‹¬å 


### 4.1 ä»€ä¹ˆæ˜¯è¯»å†™é”


**ç”Ÿæ´»ç±»æ¯”**ï¼šå›¾ä¹¦é¦†çš„é˜…è¯»è§„åˆ™

```
å›¾ä¹¦é¦†åœºæ™¯ï¼š
- å¤šäººå¯ä»¥åŒæ—¶è¯»åŒä¸€æœ¬ä¹¦ï¼ˆå…±äº«è¯»ï¼‰
- åªæœ‰ä¸€ä¸ªäººèƒ½ä¿®æ”¹ä¹¦çš„å†…å®¹ï¼ˆç‹¬å å†™ï¼‰
- æœ‰äººåœ¨å†™æ—¶ï¼Œå…¶ä»–äººéƒ½ä¸èƒ½è¯»æˆ–å†™

ç¨‹åºåœºæ™¯ï¼š
- å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»æ•°æ®ï¼ˆè¯»ä¸å†²çªï¼‰
- åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å†™æ•°æ®ï¼ˆå†™éœ€è¦ç‹¬å ï¼‰
- å†™æ—¶ä¸èƒ½è¯»ï¼Œè¯»æ—¶ä¸èƒ½å†™
```

**è¯»å†™é”çš„ä¼˜åŠ¿**ï¼š

```
æ™®é€šäº’æ–¥é”ï¼š
è¯»æ“ä½œ1 â†’ è¯»æ“ä½œ2 â†’ è¯»æ“ä½œ3  (ä¸²è¡Œï¼Œæ…¢)

è¯»å†™é”ï¼š
è¯»æ“ä½œ1 â†˜
è¯»æ“ä½œ2 â†’ å¹¶è¡Œè¯»å– (å¿«)
è¯»æ“ä½œ3 â†—
```

### 4.2 è¯»å†™é”åŸºæœ¬æ“ä½œ


**ğŸ”§ è¯»å†™é”æ ¸å¿ƒå‡½æ•°**

```c
#include <pthread.h>

pthread_rwlock_t rwlock;  // è¯»å†™é”

// 1. åˆå§‹åŒ–è¯»å†™é”
int pthread_rwlock_init(pthread_rwlock_t *rwlock,
                       const pthread_rwlockattr_t *attr);

// 2. åŠ è¯»é”ï¼ˆå…±äº«é”ï¼‰
int pthread_rwlock_rdlock(pthread_rwlock_t *rwlock);

// 3. å°è¯•åŠ è¯»é”
int pthread_rwlock_tryrdlock(pthread_rwlock_t *rwlock);

// 4. åŠ å†™é”ï¼ˆç‹¬å é”ï¼‰
int pthread_rwlock_wrlock(pthread_rwlock_t *rwlock);

// 5. å°è¯•åŠ å†™é”
int pthread_rwlock_trywrlock(pthread_rwlock_t *rwlock);

// 6. è§£é”ï¼ˆè¯»é”å’Œå†™é”éƒ½ç”¨è¿™ä¸ªï¼‰
int pthread_rwlock_unlock(pthread_rwlock_t *rwlock);

// 7. é”€æ¯è¯»å†™é”
int pthread_rwlock_destroy(pthread_rwlock_t *rwlock);
```

### 4.3 è¯»å†™é”åº”ç”¨ç¤ºä¾‹


```c
#include <stdio.h>
#include <pthread.h>
#include <unistd.h>
#include <string.h>

// å…±äº«æ•°æ®ï¼šç”¨æˆ·ä¿¡æ¯æ•°æ®åº“
typedef struct {
    int id;
    char name[50];
    int age;
} User;

User database[100];
int user_count = 0;
pthread_rwlock_t db_lock;  // ä¿æŠ¤æ•°æ®åº“çš„è¯»å†™é”

// è¯»çº¿ç¨‹ï¼šæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
void* reader_thread(void* arg) {
    int reader_id = *(int*)arg;
    
    for(int i = 0; i < 5; i++) {
        // åŠ è¯»é” - å¤šä¸ªè¯»çº¿ç¨‹å¯ä»¥å¹¶è¡Œ
        pthread_rwlock_rdlock(&db_lock);
        
        printf("è¯»è€…%d: å¼€å§‹æŸ¥è¯¢æ•°æ®åº“ (å½“å‰ç”¨æˆ·æ•°ï¼š%d)\n", 
               reader_id, user_count);
        
        // æ¨¡æ‹ŸæŸ¥è¯¢æ“ä½œ
        for(int j = 0; j < user_count; j++) {
            if(database[j].id > 0) {
                printf("è¯»è€…%d: æ‰¾åˆ°ç”¨æˆ· %s (ID:%d, å¹´é¾„:%d)\n",
                       reader_id, database[j].name, 
                       database[j].id, database[j].age);
                break;  // åªæ˜¾ç¤ºç¬¬ä¸€ä¸ªç”¨æˆ·
            }
        }
        
        sleep(1);  // æ¨¡æ‹Ÿè¯»å–æ—¶é—´
        
        // é‡Šæ”¾è¯»é”
        pthread_rwlock_unlock(&db_lock);
        
        printf("è¯»è€…%d: æŸ¥è¯¢å®Œæˆ\n", reader_id);
        sleep(2);
    }
    return NULL;
}

// å†™çº¿ç¨‹ï¼šæ·»åŠ ç”¨æˆ·ä¿¡æ¯
void* writer_thread(void* arg) {
    int writer_id = *(int*)arg;
    
    for(int i = 0; i < 3; i++) {
        // åŠ å†™é” - ç‹¬å è®¿é—®
        pthread_rwlock_wrlock(&db_lock);
        
        printf("å†™è€…%d: å¼€å§‹æ·»åŠ ç”¨æˆ·æ•°æ®\n", writer_id);
        
        // æ·»åŠ æ–°ç”¨æˆ·
        if(user_count < 100) {
            database[user_count].id = writer_id * 10 + i + 1;
            snprintf(database[user_count].name, 50, "ç”¨æˆ·_%d_%d", writer_id, i);
            database[user_count].age = 20 + i;
            user_count++;
            
            printf("å†™è€…%d: æ·»åŠ äº†ç”¨æˆ· %s (æ€»ç”¨æˆ·æ•°ï¼š%d)\n",
                   writer_id, database[user_count-1].name, user_count);
        }
        
        sleep(2);  // æ¨¡æ‹Ÿå†™å…¥æ—¶é—´
        
        // é‡Šæ”¾å†™é”
        pthread_rwlock_unlock(&db_lock);
        
        printf("å†™è€…%d: å†™å…¥å®Œæˆ\n", writer_id);
        sleep(3);
    }
    return NULL;
}

int main() {
    pthread_t readers[3], writers[2];
    int reader_ids[3] = {1, 2, 3};
    int writer_ids[2] = {1, 2};
    
    // åˆå§‹åŒ–è¯»å†™é”
    pthread_rwlock_init(&db_lock, NULL);
    
    // åˆå§‹åŒ–ä¸€äº›æ•°æ®
    strcpy(database[0].name, "åˆå§‹ç”¨æˆ·");
    database[0].id = 1;
    database[0].age = 25;
    user_count = 1;
    
    // åˆ›å»ºè¯»å†™çº¿ç¨‹
    for(int i = 0; i < 3; i++) {
        pthread_create(&readers[i], NULL, reader_thread, &reader_ids[i]);
    }
    for(int i = 0; i < 2; i++) {
        pthread_create(&writers[i], NULL, writer_thread, &writer_ids[i]);
    }
    
    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    for(int i = 0; i < 3; i++) {
        pthread_join(readers[i], NULL);
    }
    for(int i = 0; i < 2; i++) {
        pthread_join(writers[i], NULL);
    }
    
    // æ¸…ç†èµ„æº
    pthread_rwlock_destroy(&db_lock);
    
    printf("ç¨‹åºç»“æŸï¼Œæœ€ç»ˆç”¨æˆ·æ•°ï¼š%d\n", user_count);
    return 0;
}
```

> ğŸ¯ **è¯»å†™é”é€‚ç”¨åœºæ™¯**  
> - è¯»æ“ä½œé¢‘ç‡è¿œé«˜äºå†™æ“ä½œ  
> - æ•°æ®ç»“æ„è¾ƒå¤§ï¼Œè¯»æ“ä½œè€—æ—¶è¾ƒé•¿  
> - å¤šä¸ªè¯»æ“ä½œä¹‹é—´æ²¡æœ‰å†²çª

---

## 5. âš¡ è‡ªæ—‹é”spinlocké«˜æ€§èƒ½åœºæ™¯


### 5.1 ä»€ä¹ˆæ˜¯è‡ªæ—‹é”


**æ ¸å¿ƒåŒºåˆ«**ï¼šè‡ªæ—‹é”ä¸"ç¡è§‰"ï¼Œè€Œæ˜¯"åŸåœ°æ‰“è½¬ç­‰å¾…"

```
æ™®é€šäº’æ–¥é”ï¼ˆmutexï¼‰ï¼š
çº¿ç¨‹Aè·å–é” â†’ çº¿ç¨‹Bå‘ç°é”è¢«å ç”¨ â†’ çº¿ç¨‹Bè¿›å…¥ç¡çœ çŠ¶æ€ â†’ 
çº¿ç¨‹Aé‡Šæ”¾é” â†’ ç³»ç»Ÿå”¤é†’çº¿ç¨‹B â†’ çº¿ç¨‹Bè·å–é”

è‡ªæ—‹é”ï¼ˆspinlockï¼‰ï¼š
çº¿ç¨‹Aè·å–é” â†’ çº¿ç¨‹Bå‘ç°é”è¢«å ç”¨ â†’ çº¿ç¨‹Bä¸æ–­å°è¯•è·å–é”ï¼ˆ"è‡ªæ—‹"ï¼‰ â†’ 
çº¿ç¨‹Aé‡Šæ”¾é” â†’ çº¿ç¨‹Bç«‹å³è·å–åˆ°é”

ç”Ÿæ´»ç±»æ¯”ï¼š
æ™®é€šé”ï¼šæ’é˜Ÿå–å·ï¼Œåç€ç­‰å«å·
è‡ªæ—‹é”ï¼šç«™åœ¨çª—å£å‰ä¸åœé—®"å¥½äº†å—ï¼Ÿå¥½äº†å—ï¼Ÿ"
```

### 5.2 è‡ªæ—‹é”çš„ä¼˜ç¼ºç‚¹


**âœ… ä¼˜ç‚¹**ï¼š
- **å“åº”å¿«**ï¼šä¸éœ€è¦çº¿ç¨‹åˆ‡æ¢ï¼Œè·å–é”çš„å»¶è¿Ÿå¾ˆå°
- **é«˜æ•ˆ**ï¼šé€‚åˆé”æŒæœ‰æ—¶é—´å¾ˆçŸ­çš„åœºæ™¯
- **ç®€å•**ï¼šå®ç°ç›¸å¯¹ç®€å•

**âŒ ç¼ºç‚¹**ï¼š
- **è€—CPU**ï¼šä¸€ç›´"è‡ªæ—‹"ä¼šæµªè´¹CPUèµ„æº  
- **ä¸å…¬å¹³**ï¼šå¯èƒ½å¯¼è‡´æŸäº›çº¿ç¨‹é•¿æœŸè·å–ä¸åˆ°é”
- **ä¸é€‚åˆé•¿ç­‰å¾…**ï¼šå¦‚æœé”è¢«é•¿æœŸå ç”¨ï¼Œä¼šæµªè´¹å¤§é‡CPU

### 5.3 è‡ªæ—‹é”åŸºæœ¬æ“ä½œ


```c
#include <pthread.h>

pthread_spinlock_t spinlock;  // è‡ªæ—‹é”

// 1. åˆå§‹åŒ–è‡ªæ—‹é”
int pthread_spin_init(pthread_spinlock_t *lock, int pshared);
// pshared: 0è¡¨ç¤ºè¿›ç¨‹å†…ä½¿ç”¨ï¼Œé0è¡¨ç¤ºè¿›ç¨‹é—´ä½¿ç”¨

// 2. åŠ é”ï¼ˆä¼šè‡ªæ—‹ç­‰å¾…ï¼‰
int pthread_spin_lock(pthread_spinlock_t *lock);

// 3. å°è¯•åŠ é”ï¼ˆä¸ç­‰å¾…ï¼‰
int pthread_spin_trylock(pthread_spinlock_t *lock);

// 4. è§£é”
int pthread_spin_unlock(pthread_spinlock_t *lock);

// 5. é”€æ¯è‡ªæ—‹é”
int pthread_spin_destroy(pthread_spinlock_t *lock);
```

### 5.4 è‡ªæ—‹é”æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹


```c
#include <stdio.h>
#include <pthread.h>
#include <time.h>

#define ITERATIONS 1000000

// æµ‹è¯•æ•°æ®
long counter_mutex = 0;
long counter_spin = 0;

// åŒæ­¥å·¥å…·
pthread_mutex_t mutex_lock;
pthread_spinlock_t spin_lock;

// ä½¿ç”¨äº’æ–¥é”çš„æµ‹è¯•å‡½æ•°
void* mutex_test(void* arg) {
    for(int i = 0; i < ITERATIONS; i++) {
        pthread_mutex_lock(&mutex_lock);
        counter_mutex++;  // å¾ˆçŸ­çš„ä¸´ç•ŒåŒº
        pthread_mutex_unlock(&mutex_lock);
    }
    return NULL;
}

// ä½¿ç”¨è‡ªæ—‹é”çš„æµ‹è¯•å‡½æ•°
void* spin_test(void* arg) {
    for(int i = 0; i < ITERATIONS; i++) {
        pthread_spin_lock(&spin_lock);
        counter_spin++;   // å¾ˆçŸ­çš„ä¸´ç•ŒåŒº
        pthread_spin_unlock(&spin_lock);
    }
    return NULL;
}

// æ€§èƒ½æµ‹è¯•å‡½æ•°
double test_performance(void* (*test_func)(void*), const char* lock_type) {
    pthread_t threads[4];
    struct timespec start, end;
    
    // è®°å½•å¼€å§‹æ—¶é—´
    clock_gettime(CLOCK_MONOTONIC, &start);
    
    // åˆ›å»º4ä¸ªçº¿ç¨‹
    for(int i = 0; i < 4; i++) {
        pthread_create(&threads[i], NULL, test_func, NULL);
    }
    
    // ç­‰å¾…çº¿ç¨‹å®Œæˆ
    for(int i = 0; i < 4; i++) {
        pthread_join(threads[i], NULL);
    }
    
    // è®°å½•ç»“æŸæ—¶é—´
    clock_gettime(CLOCK_MONOTONIC, &end);
    
    // è®¡ç®—è€—æ—¶
    double elapsed = (end.tv_sec - start.tv_sec) + 
                    (end.tv_nsec - start.tv_nsec) / 1000000000.0;
    
    printf("%sé”æµ‹è¯•å®Œæˆï¼šè€—æ—¶ %.3f ç§’\n", lock_type, elapsed);
    return elapsed;
}

int main() {
    // åˆå§‹åŒ–é”
    pthread_mutex_init(&mutex_lock, NULL);
    pthread_spin_init(&spin_lock, 0);
    
    printf("å¼€å§‹æ€§èƒ½æµ‹è¯•ï¼ˆæ¯ä¸ªæµ‹è¯•%dæ¬¡æ“ä½œï¼‰...\n", ITERATIONS * 4);
    
    // æµ‹è¯•äº’æ–¥é”æ€§èƒ½
    counter_mutex = 0;
    double mutex_time = test_performance(mutex_test, "äº’æ–¥");
    printf("äº’æ–¥é”ç»“æœï¼šcounter = %ld\n\n", counter_mutex);
    
    // æµ‹è¯•è‡ªæ—‹é”æ€§èƒ½
    counter_spin = 0;
    double spin_time = test_performance(spin_test, "è‡ªæ—‹");
    printf("è‡ªæ—‹é”ç»“æœï¼šcounter = %ld\n\n", counter_spin);
    
    // æ€§èƒ½å¯¹æ¯”
    if(spin_time < mutex_time) {
        printf("è‡ªæ—‹é”æ¯”äº’æ–¥é”å¿« %.1f%%\n", 
               (mutex_time - spin_time) / mutex_time * 100);
    } else {
        printf("äº’æ–¥é”æ¯”è‡ªæ—‹é”å¿« %.1f%%\n", 
               (spin_time - mutex_time) / spin_time * 100);
    }
    
    // æ¸…ç†èµ„æº
    pthread_mutex_destroy(&mutex_lock);
    pthread_spin_destroy(&spin_lock);
    
    return 0;
}
```

> âš ï¸ **ä½¿ç”¨å»ºè®®**  
> **é€‚åˆè‡ªæ—‹é”çš„åœºæ™¯**ï¼šä¸´ç•ŒåŒºå¾ˆå°ï¼Œé”æŒæœ‰æ—¶é—´çŸ­ï¼ˆå¾®ç§’çº§ï¼‰  
> **é€‚åˆäº’æ–¥é”çš„åœºæ™¯**ï¼šä¸´ç•ŒåŒºè¾ƒå¤§ï¼Œé”æŒæœ‰æ—¶é—´é•¿ï¼ˆæ¯«ç§’çº§åŠä»¥ä¸Šï¼‰

---

## 6. ğŸ’¾ çº¿ç¨‹æœ¬åœ°å­˜å‚¨TLSæœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯çº¿ç¨‹æœ¬åœ°å­˜å‚¨


**ç®€å•ç†è§£**ï¼šTLSå°±æ˜¯æ¯ä¸ªçº¿ç¨‹çš„"ç§äººå‚¨ç‰©æŸœ"

```
ç°å®ç±»æ¯”ï¼š
åŠå…¬å®¤çš„å‘˜å·¥å‚¨ç‰©æŸœ
- æ¯ä¸ªå‘˜å·¥éƒ½æœ‰è‡ªå·±çš„å‚¨ç‰©æŸœ
- åªæœ‰è‡ªå·±èƒ½è®¿é—®è‡ªå·±çš„å‚¨ç‰©æŸœ
- ä¸åŒå‘˜å·¥çš„å‚¨ç‰©æŸœå†…å®¹äº’ä¸å½±å“

ç¨‹åºåœºæ™¯ï¼š
- æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„TLSå­˜å‚¨ç©ºé—´
- åŒä¸€ä¸ªTLSå˜é‡åœ¨ä¸åŒçº¿ç¨‹ä¸­æœ‰ä¸åŒçš„å€¼
- å„çº¿ç¨‹çš„TLSæ•°æ®äº’ä¸å¹²æ‰°
```

**ä¸ºä»€ä¹ˆéœ€è¦TLSï¼Ÿ**

```c
// é—®é¢˜ï¼šå…¨å±€å˜é‡è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«
int error_code = 0;  // å…¨å±€é”™è¯¯ç 

void* worker1(void* arg) {
    // çº¿ç¨‹1è®¾ç½®é”™è¯¯ç 
    error_code = 404;
    sleep(1);
    printf("çº¿ç¨‹1çš„é”™è¯¯ç ï¼š%d\n", error_code);  // å¯èƒ½ä¸æ˜¯404ï¼
    return NULL;
}

void* worker2(void* arg) {
    sleep(1);
    // çº¿ç¨‹2ä¹Ÿè®¾ç½®é”™è¯¯ç 
    error_code = 500;  // è¦†ç›–äº†çº¿ç¨‹1çš„è®¾ç½®
    return NULL;
}

// è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨TLSï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹çš„error_code
```

### 6.2 TLSåŸºæœ¬æ“ä½œ


**ğŸ”§ TLSæ ¸å¿ƒå‡½æ•°**

```c
#include <pthread.h>

pthread_key_t key;  // TLSé”®

// 1. åˆ›å»ºTLSé”®
int pthread_key_create(pthread_key_t *key, void (*destructor)(void*));
// destructor: çº¿ç¨‹ç»“æŸæ—¶çš„æ¸…ç†å‡½æ•°

// 2. åˆ é™¤TLSé”®
int pthread_key_delete(pthread_key_t key);

// 3. è®¾ç½®TLSæ•°æ®
int pthread_setspecific(pthread_key_t key, const void *value);

// 4. è·å–TLSæ•°æ®
void* pthread_getspecific(pthread_key_t key);
```

### 6.3 TLSä½¿ç”¨ç¤ºä¾‹


```c
#include <stdio.h>
#include <pthread.h>
#include <stdlib.h>
#include <unistd.h>

// TLSé”®
pthread_key_t error_key;    // é”™è¯¯ç 
pthread_key_t name_key;     // çº¿ç¨‹åç§°

// TLSæ•°æ®æ¸…ç†å‡½æ•°
void cleanup_error(void* data) {
    printf("æ¸…ç†çº¿ç¨‹çš„é”™è¯¯ç æ•°æ®\n");
    free(data);
}

void cleanup_name(void* data) {
    printf("æ¸…ç†çº¿ç¨‹çš„åç§°æ•°æ®ï¼š%s\n", (char*)data);
    free(data);
}

// è®¾ç½®çº¿ç¨‹é”™è¯¯ç 
void set_thread_error(int error) {
    int* error_ptr = malloc(sizeof(int));
    *error_ptr = error;
    pthread_setspecific(error_key, error_ptr);
}

// è·å–çº¿ç¨‹é”™è¯¯ç 
int get_thread_error(void) {
    int* error_ptr = pthread_getspecific(error_key);
    return error_ptr ? *error_ptr : 0;
}

// è®¾ç½®çº¿ç¨‹åç§°
void set_thread_name(const char* name) {
    char* name_copy = malloc(strlen(name) + 1);
    strcpy(name_copy, name);
    pthread_setspecific(name_key, name_copy);
}

// è·å–çº¿ç¨‹åç§°
const char* get_thread_name(void) {
    char* name = pthread_getspecific(name_key);
    return name ? name : "Unknown";
}

// å·¥ä½œçº¿ç¨‹å‡½æ•°
void* worker_thread(void* arg) {
    int thread_id = *(int*)arg;
    
    // è®¾ç½®çº¿ç¨‹åç§°å’Œåˆå§‹é”™è¯¯ç 
    char name[20];
    snprintf(name, 20, "Worker-%d", thread_id);
    set_thread_name(name);
    set_thread_error(0);  // åˆå§‹æ— é”™è¯¯
    
    printf("çº¿ç¨‹ %s å¼€å§‹å·¥ä½œ\n", get_thread_name());
    
    // æ¨¡æ‹Ÿä¸åŒçš„å·¥ä½œå’Œé”™è¯¯æƒ…å†µ
    for(int i = 0; i < 5; i++) {
        sleep(1);
        
        // æ¨¡æ‹Ÿéšæœºé”™è¯¯
        if(i == 2) {
            set_thread_error(thread_id * 100 + i);
            printf("çº¿ç¨‹ %s é‡åˆ°é”™è¯¯ï¼š%d\n", 
                   get_thread_name(), get_thread_error());
        } else {
            printf("çº¿ç¨‹ %s æ­£å¸¸å·¥ä½œä¸­... (é”™è¯¯ç ï¼š%d)\n", 
                   get_thread_name(), get_thread_error());
        }
    }
    
    printf("çº¿ç¨‹ %s å·¥ä½œå®Œæˆï¼Œæœ€ç»ˆé”™è¯¯ç ï¼š%d\n", 
           get_thread_name(), get_thread_error());
    
    return NULL;
}

int main() {
    pthread_t threads[3];
    int thread_ids[3] = {1, 2, 3};
    
    // åˆ›å»ºTLSé”®
    pthread_key_create(&error_key, cleanup_error);
    pthread_key_create(&name_key, cleanup_name);
    
    printf("åˆ›å»º3ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œæ¯ä¸ªéƒ½æœ‰ç‹¬ç«‹çš„TLSæ•°æ®\n\n");
    
    // åˆ›å»ºçº¿ç¨‹
    for(int i = 0; i < 3; i++) {
        pthread_create(&threads[i], NULL, worker_thread, &thread_ids[i]);
    }
    
    // ç­‰å¾…çº¿ç¨‹å®Œæˆ
    for(int i = 0; i < 3; i++) {
        pthread_join(threads[i], NULL);
    }
    
    // æ¸…ç†TLSé”®
    pthread_key_delete(error_key);
    pthread_key_delete(name_key);
    
    printf("\næ‰€æœ‰çº¿ç¨‹å®Œæˆï¼ŒTLSæ•°æ®å·²æ¸…ç†\n");
    return 0;
}
```

### 6.4 TLSçš„ç¼–è¯‘å™¨æ”¯æŒ


**ğŸ¯ ä½¿ç”¨`__thread`å…³é”®å­—ï¼ˆæ›´ç®€å•çš„æ–¹å¼ï¼‰**

```c
#include <stdio.h>
#include <pthread.h>
#include <unistd.h>

// ä½¿ç”¨__threadå…³é”®å­—å£°æ˜çº¿ç¨‹æœ¬åœ°å˜é‡
__thread int thread_id = 0;      // æ¯ä¸ªçº¿ç¨‹ç‹¬æœ‰
__thread char thread_name[50];   // æ¯ä¸ªçº¿ç¨‹ç‹¬æœ‰
__thread int error_count = 0;    // æ¯ä¸ªçº¿ç¨‹ç‹¬æœ‰

void* simple_worker(void* arg) {
    int id = *(int*)arg;
    
    // è®¾ç½®çº¿ç¨‹æœ¬åœ°æ•°æ®
    thread_id = id;
    snprintf(thread_name, 50, "SimpleWorker-%d", id);
    error_count = 0;
    
    printf("çº¿ç¨‹å¯åŠ¨ï¼šID=%d, åç§°=%s\n", thread_id, thread_name);
    
    // æ¨¡æ‹Ÿå·¥ä½œ
    for(int i = 0; i < 3; i++) {
        sleep(1);
        if(i == 1) {
            error_count++;
            printf("%s: å‘ç”Ÿé”™è¯¯ï¼Œé”™è¯¯è®¡æ•°=%d\n", thread_name, error_count);
        } else {
            printf("%s: æ­£å¸¸å·¥ä½œä¸­\n", thread_name);
        }
    }
    
    printf("çº¿ç¨‹%dç»“æŸï¼šæœ€ç»ˆé”™è¯¯è®¡æ•°=%d\n", thread_id, error_count);
    return NULL;
}

int main() {
    pthread_t threads[3];
    int ids[3] = {1, 2, 3};
    
    // åˆ›å»ºçº¿ç¨‹
    for(int i = 0; i < 3; i++) {
        pthread_create(&threads[i], NULL, simple_worker, &ids[i]);
    }
    
    // ç­‰å¾…å®Œæˆ
    for(int i = 0; i < 3; i++) {
        pthread_join(threads[i], NULL);
    }
    
    return 0;
}
```

> ğŸ’¡ **TLSä½¿ç”¨å»ºè®®**  
> - ç®€å•åœºæ™¯ï¼šä½¿ç”¨`__thread`å…³é”®å­—  
> - å¤æ‚åœºæ™¯ï¼šä½¿ç”¨pthread TLS API  
> - æ³¨æ„å†…å­˜ç®¡ç†ï¼šåŠæ—¶é‡Šæ”¾åˆ†é…çš„å†…å­˜

---

## 7. ğŸ›‘ çº¿ç¨‹å–æ¶ˆä¸æ¸…ç†å¤„ç†


### 7.1 ä»€ä¹ˆæ˜¯çº¿ç¨‹å–æ¶ˆ


**é€šä¿—ç†è§£**ï¼šçº¿ç¨‹å–æ¶ˆå°±æ˜¯"ç´§æ€¥å«åœ"ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹

```
ç”Ÿæ´»åœºæ™¯ï¼š
æ¶ˆé˜²æ¼”ä¹ æ—¶ï¼Œå¹¿æ’­é€šçŸ¥ï¼š"è¯·æ‰€æœ‰äººå‘˜ç«‹å³åœæ­¢å·¥ä½œï¼ŒæŒ‰é¢„å®šè·¯çº¿æ’¤ç¦»"
- æœ‰äº›äººå¬åˆ°ç«‹å³åœä¸‹ï¼ˆç«‹å³å–æ¶ˆï¼‰
- æœ‰äº›äººå®Œæˆæ‰‹å¤´å·¥ä½œå†æ’¤ç¦»ï¼ˆå»¶è¿Ÿå–æ¶ˆï¼‰
- æœ‰äº›äººå¿½è§†å¹¿æ’­ç»§ç»­å·¥ä½œï¼ˆç¦ç”¨å–æ¶ˆï¼‰

ç¨‹åºåœºæ™¯ï¼š
ä¸€ä¸ªçº¿ç¨‹å‘å¦ä¸€ä¸ªçº¿ç¨‹å‘é€å–æ¶ˆè¯·æ±‚
- ç›®æ ‡çº¿ç¨‹å¯ä»¥ç«‹å³å“åº”
- ç›®æ ‡çº¿ç¨‹å¯ä»¥æ¨è¿Ÿåˆ°åˆé€‚æ—¶æœºå“åº”
- ç›®æ ‡çº¿ç¨‹å¯ä»¥å¿½ç•¥å–æ¶ˆè¯·æ±‚
```

### 7.2 çº¿ç¨‹å–æ¶ˆçš„ç±»å‹


**ğŸ¯ å–æ¶ˆç±»å‹ï¼ˆCancel Typeï¼‰**

| ç±»å‹ | è¯´æ˜ | å“åº”æ—¶æœº |
|------|------|----------|
| **ç«‹å³å–æ¶ˆ**<br>`PTHREAD_CANCEL_ASYNCHRONOUS` | æ”¶åˆ°å–æ¶ˆè¯·æ±‚ç«‹å³ç»ˆæ­¢ | ä»»ä½•æ—¶åˆ»éƒ½å¯èƒ½è¢«å–æ¶ˆ |
| **å»¶è¿Ÿå–æ¶ˆ**<br>`PTHREAD_CANCEL_DEFERRED` | å»¶è¿Ÿåˆ°å–æ¶ˆç‚¹æ‰å“åº” | åªåœ¨ç‰¹å®šå‡½æ•°è°ƒç”¨æ—¶æ£€æŸ¥ |

**ğŸ¯ å–æ¶ˆçŠ¶æ€ï¼ˆCancel Stateï¼‰**

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| **å¯ç”¨å–æ¶ˆ**<br>`PTHREAD_CANCEL_ENABLE` | å…è®¸å“åº”å–æ¶ˆè¯·æ±‚ï¼ˆé»˜è®¤ï¼‰ |
| **ç¦ç”¨å–æ¶ˆ**<br>`PTHREAD_CANCEL_DISABLE` | å¿½ç•¥å–æ¶ˆè¯·æ±‚ |

### 7.3 çº¿ç¨‹å–æ¶ˆåŸºæœ¬æ“ä½œ


```c
#include <pthread.h>

// 1. å‘é€å–æ¶ˆè¯·æ±‚
int pthread_cancel(pthread_t thread);

// 2. è®¾ç½®å–æ¶ˆçŠ¶æ€ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰
int pthread_setcancelstate(int state, int *oldstate);

// 3. è®¾ç½®å–æ¶ˆç±»å‹ï¼ˆç«‹å³/å»¶è¿Ÿï¼‰
int pthread_setcanceltype(int type, int *oldtype);

// 4. åˆ›å»ºå–æ¶ˆç‚¹ï¼ˆä¸»åŠ¨æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆï¼‰
void pthread_testcancel(void);

// 5. æ³¨å†Œæ¸…ç†å¤„ç†å‡½æ•°
void pthread_cleanup_push(void (*routine)(void*), void *arg);
void pthread_cleanup_pop(int execute);
```

### 7.4 çº¿ç¨‹å–æ¶ˆå®Œæ•´ç¤ºä¾‹


```c
#include <stdio.h>
#include <pthread.h>
#include <unistd.h>
#include <stdlib.h>

// å…±äº«æ•°æ®
int* shared_data = NULL;
FILE* log_file = NULL;

// æ¸…ç†å‡½æ•°1ï¼šé‡Šæ”¾å†…å­˜
void cleanup_memory(void* arg) {
    printf("æ¸…ç†å‡½æ•°ï¼šé‡Šæ”¾å†…å­˜\n");
    if(shared_data) {
        free(shared_data);
        shared_data = NULL;
    }
}

// æ¸…ç†å‡½æ•°2ï¼šå…³é—­æ–‡ä»¶
void cleanup_file(void* arg) {
    printf("æ¸…ç†å‡½æ•°ï¼šå…³é—­æ—¥å¿—æ–‡ä»¶\n");
    if(log_file) {
        fprintf(log_file, "çº¿ç¨‹è¢«å–æ¶ˆï¼Œæ¸…ç†èµ„æº\n");
        fclose(log_file);
        log_file = NULL;
    }
}

// å¯å–æ¶ˆçš„å·¥ä½œçº¿ç¨‹
void* cancelable_worker(void* arg) {
    int worker_id = *(int*)arg;
    
    printf("çº¿ç¨‹%dï¼šå¼€å§‹å·¥ä½œ\n", worker_id);
    
    // åˆ†é…èµ„æº
    shared_data = malloc(1024);
    log_file = fopen("worker.log", "w");
    
    // æ³¨å†Œæ¸…ç†å‡½æ•°ï¼ˆæ³¨æ„ï¼šåæ³¨å†Œçš„å…ˆæ‰§è¡Œï¼‰
    pthread_cleanup_push(cleanup_file, NULL);    // ç¬¬äºŒä¸ªæ‰§è¡Œ
    pthread_cleanup_push(cleanup_memory, NULL);  // ç¬¬ä¸€ä¸ªæ‰§è¡Œ
    
    // è®¾ç½®å–æ¶ˆå±æ€§
    pthread_setcancelstate(PTHREAD_CANCEL_ENABLE, NULL);   // å¯ç”¨å–æ¶ˆ
    pthread_setcanceltype(PTHREAD_CANCEL_DEFERRED, NULL);  // å»¶è¿Ÿå–æ¶ˆ
    
    // æ¨¡æ‹Ÿé•¿æ—¶é—´å·¥ä½œ
    for(int i = 0; i < 10; i++) {
        printf("çº¿ç¨‹%dï¼šå·¥ä½œæ­¥éª¤ %d/10\n", worker_id, i + 1);
        
        if(log_file) {
            fprintf(log_file, "å®Œæˆæ­¥éª¤ %d\n", i + 1);
            fflush(log_file);
        }
        
        // æ¨¡æ‹Ÿå·¥ä½œ
        sleep(2);
        
        // åˆ›å»ºå–æ¶ˆç‚¹ï¼ˆæ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆï¼‰
        pthread_testcancel();
        
        // åœ¨æŸäº›å…³é”®æ“ä½œæ—¶ç¦ç”¨å–æ¶ˆ
        if(i == 7) {
            printf("çº¿ç¨‹%dï¼šè¿›å…¥å…³é”®æ“ä½œï¼Œç¦ç”¨å–æ¶ˆ\n", worker_id);
            pthread_setcancelstate(PTHREAD_CANCEL_DISABLE, NULL);
            sleep(3);  // å…³é”®æ“ä½œ
            printf("çº¿ç¨‹%dï¼šå…³é”®æ“ä½œå®Œæˆï¼Œé‡æ–°å¯ç”¨å–æ¶ˆ\n", worker_id);
            pthread_setcancelstate(PTHREAD_CANCEL_ENABLE, NULL);
        }
    }
    
    printf("çº¿ç¨‹%dï¼šå·¥ä½œå®Œæˆï¼\n", worker_id);
    
    // æ‰‹åŠ¨æ¸…ç†ï¼ˆå¦‚æœæ²¡æœ‰è¢«å–æ¶ˆï¼‰
    pthread_cleanup_pop(1);  // æ‰§è¡Œcleanup_memory
    pthread_cleanup_pop(1);  // æ‰§è¡Œcleanup_file
    
    return NULL;
}

// ä¸å¯å–æ¶ˆçš„å…³é”®çº¿ç¨‹
void* critical_worker(void* arg) {
    int worker_id = *(int*)arg;
    
    printf("å…³é”®çº¿ç¨‹%dï¼šå¼€å§‹å·¥ä½œï¼ˆä¸å¯å–æ¶ˆï¼‰\n", worker_id);
    
    // ç¦ç”¨å–æ¶ˆ
    pthread_setcancelstate(PTHREAD_CANCEL_DISABLE, NULL);
    
    // æ‰§è¡Œå…³é”®ä»»åŠ¡
    for(int i = 0; i < 5; i++) {
        printf("å…³é”®çº¿ç¨‹%dï¼šæ‰§è¡Œå…³é”®ä»»åŠ¡ %d/5\n", worker_id, i + 1);
        sleep(2);
    }
    
    printf("å…³é”®çº¿ç¨‹%dï¼šä»»åŠ¡å®Œæˆ\n", worker_id);
    return NULL;
}

int main() {
    pthread_t worker_thread, critical_thread;
    int worker_id = 1, critical_id = 2;
    
    // åˆ›å»ºå¯å–æ¶ˆçš„å·¥ä½œçº¿ç¨‹
    pthread_create(&worker_thread, NULL, cancelable_worker, &worker_id);
    
    // åˆ›å»ºä¸å¯å–æ¶ˆçš„å…³é”®çº¿ç¨‹
    pthread_create(&critical_thread, NULL, critical_worker, &critical_id);
    
    // è®©çº¿ç¨‹è¿è¡Œä¸€æ®µæ—¶é—´
    sleep(8);
    
    printf("\nä¸»çº¿ç¨‹ï¼šå‘é€å–æ¶ˆè¯·æ±‚ç»™å·¥ä½œçº¿ç¨‹\n");
    pthread_cancel(worker_thread);
    
    printf("ä¸»çº¿ç¨‹ï¼šå°è¯•å–æ¶ˆå…³é”®çº¿ç¨‹ï¼ˆåº”è¯¥æ— æ•ˆï¼‰\n");
    pthread_cancel(critical_thread);
    
    // ç­‰å¾…çº¿ç¨‹ç»“æŸ
    void* worker_result;
    void* critical_result;
    
    int ret1 = pthread_join(worker_thread, &worker_result);
    int ret2 = pthread_join(critical_thread, &critical_result);
    
    // æ£€æŸ¥çº¿ç¨‹ç»“æŸçŠ¶æ€
    if(worker_result == PTHREAD_CANCELED) {
        printf("å·¥ä½œçº¿ç¨‹å·²è¢«å–æ¶ˆ\n");
    } else {
        printf("å·¥ä½œçº¿ç¨‹æ­£å¸¸ç»“æŸ\n");
    }
    
    if(critical_result == PTHREAD_CANCELED) {
        printf("å…³é”®çº¿ç¨‹å·²è¢«å–æ¶ˆ\n");
    } else {
        printf("å…³é”®çº¿ç¨‹æ­£å¸¸ç»“æŸ\n");
    }
    
    return 0;
}
```

> âš ï¸ **é‡è¦æ³¨æ„äº‹é¡¹**  
> 1. **æ¸…ç†å‡½æ•°åŒ¹é…**ï¼šæ¯ä¸ª`pthread_cleanup_push`å¿…é¡»æœ‰å¯¹åº”çš„`pthread_cleanup_pop`  
> 2. **å–æ¶ˆç‚¹**ï¼šåªæœ‰åœ¨å–æ¶ˆç‚¹æ‰ä¼šå“åº”å»¶è¿Ÿå–æ¶ˆè¯·æ±‚  
> 3. **èµ„æºæ¸…ç†**ï¼šè¢«å–æ¶ˆçš„çº¿ç¨‹å¿…é¡»æ­£ç¡®æ¸…ç†èµ„æº

### 7.5 å¸¸è§çš„å–æ¶ˆç‚¹


**ğŸ“‹ ç³»ç»Ÿè°ƒç”¨å–æ¶ˆç‚¹**

```c
// è¿™äº›å‡½æ•°ä¼šæ£€æŸ¥å–æ¶ˆè¯·æ±‚ï¼š
sleep()       // ç¡çœ 
read()        // è¯»æ–‡ä»¶
write()       // å†™æ–‡ä»¶
accept()      // æ¥å—è¿æ¥
select()      // I/Oå¤šè·¯å¤ç”¨
pthread_cond_wait()  // æ¡ä»¶å˜é‡ç­‰å¾…
sem_wait()    // ä¿¡å·é‡ç­‰å¾…

// æ‰‹åŠ¨åˆ›å»ºå–æ¶ˆç‚¹ï¼š
pthread_testcancel();  // ä¸»åŠ¨æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
```

---

## 8. âš ï¸ æ­»é”æ£€æµ‹ä¸é¢„é˜²ç­–ç•¥


### 8.1 ä»€ä¹ˆæ˜¯æ­»é”


**ç”Ÿæ´»ç±»æ¯”**ï¼šä¸¤è¾†è½¦åœ¨çª„è·¯ç›¸é‡çš„åƒµå±€

```
æ­»é”åœºæ™¯ï¼š
Aè½¦éœ€è¦Bè½¦è®©è·¯æ‰èƒ½é€šè¿‡ â†â†’ Bè½¦éœ€è¦Aè½¦è®©è·¯æ‰èƒ½é€šè¿‡
ç»“æœï¼šä¸¤è¾†è½¦éƒ½åŠ¨ä¸äº†ï¼Œæ°¸è¿œåƒµæŒ

ç¨‹åºæ­»é”ï¼š
çº¿ç¨‹1æŒæœ‰é”Aï¼Œç­‰å¾…é”B â†â†’ çº¿ç¨‹2æŒæœ‰é”Bï¼Œç­‰å¾…é”A
ç»“æœï¼šä¸¤ä¸ªçº¿ç¨‹éƒ½é˜»å¡ï¼Œç¨‹åºå¡æ­»
```

### 8.2 æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶


**ğŸ”¸ äº’æ–¥æ¡ä»¶**ï¼šèµ„æºä¸èƒ½è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨
**ğŸ”¸ å æœ‰ç­‰å¾…**ï¼šçº¿ç¨‹æŒæœ‰èµ„æºçš„åŒæ—¶ç­‰å¾…å…¶ä»–èµ„æº  
**ğŸ”¸ ä¸å¯å‰¥å¤º**ï¼šèµ„æºä¸èƒ½è¢«å¼ºåˆ¶ä»çº¿ç¨‹æ‰‹ä¸­å¤ºèµ°
**ğŸ”¸ å¾ªç¯ç­‰å¾…**ï¼šå­˜åœ¨çº¿ç¨‹ç­‰å¾…é“¾å½¢æˆç¯è·¯

> ğŸ’¡ **é¢„é˜²åŸç†**  
> åªè¦ç ´åå››ä¸ªæ¡ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œå°±èƒ½é¢„é˜²æ­»é”

### 8.3 ç»å…¸æ­»é”ç¤ºä¾‹


```c
#include <stdio.h>
#include <pthread.h>
#include <unistd.h>

pthread_mutex_t lock_a, lock_b;

// çº¿ç¨‹1ï¼šå…ˆè·å–Aé”ï¼Œå†è·å–Bé”
void* thread1_func(void* arg) {
    printf("çº¿ç¨‹1ï¼šå°è¯•è·å–é”A\n");
    pthread_mutex_lock(&lock_a);
    printf("çº¿ç¨‹1ï¼šè·å–åˆ°é”A\n");
    
    sleep(1);  // å¢åŠ æ­»é”æ¦‚ç‡
    
    printf("çº¿ç¨‹1ï¼šå°è¯•è·å–é”B\n");
    pthread_mutex_lock(&lock_b);  // å¯èƒ½æ­»é”ï¼
    printf("çº¿ç¨‹1ï¼šè·å–åˆ°é”B\n");
    
    // åšä¸€äº›å·¥ä½œ
    printf("çº¿ç¨‹1ï¼šå®Œæˆå·¥ä½œ\n");
    
    pthread_mutex_unlock(&lock_b);
    pthread_mutex_unlock(&lock_a);
    return NULL;
}

// çº¿ç¨‹2ï¼šå…ˆè·å–Bé”ï¼Œå†è·å–Aé”ï¼ˆé¡ºåºç›¸åï¼ï¼‰
void* thread2_func(void* arg) {
    printf("çº¿ç¨‹2ï¼šå°è¯•è·å–é”B\n");
    pthread_mutex_lock(&lock_b);
    printf("çº¿ç¨‹2ï¼šè·å–åˆ°é”B\n");
    
    sleep(1);  // å¢åŠ æ­»é”æ¦‚ç‡
    
    printf("çº¿ç¨‹2ï¼šå°è¯•è·å–é”A\n");
    pthread_mutex_lock(&lock_a);  // å¯èƒ½æ­»é”ï¼
    printf("çº¿ç¨‹2ï¼šè·å–åˆ°é”A\n");
    
    // åšä¸€äº›å·¥ä½œ
    printf("çº¿ç¨‹2ï¼šå®Œæˆå·¥ä½œ\n");
    
    pthread_mutex_unlock(&lock_a);
    pthread_mutex_unlock(&lock_b);
    return NULL;
}

int main() {
    pthread_t t1, t2;
    
    pthread_mutex_init(&lock_a, NULL);
    pthread_mutex_init(&lock_b, NULL);
    
    printf("åˆ›å»ºä¸¤ä¸ªå¯èƒ½æ­»é”çš„çº¿ç¨‹...\n");
    
    pthread_create(&t1, NULL, thread1_func, NULL);
    pthread_create(&t2, NULL, thread2_func, NULL);
    
    // ç­‰å¾…çº¿ç¨‹ç»“æŸï¼ˆå¦‚æœæ­»é”ï¼Œç¨‹åºä¼šåœ¨è¿™é‡Œå¡ä½ï¼‰
    pthread_join(t1, NULL);
    pthread_join(t2, NULL);
    
    printf("æ‰€æœ‰çº¿ç¨‹å®Œæˆ\n");
    
    pthread_mutex_destroy(&lock_a);
    pthread_mutex_destroy(&lock_b);
    
    return 0;
}
```

### 8.4 æ­»é”é¢„é˜²ç­–ç•¥


**ğŸ¯ ç­–ç•¥1ï¼šé”æ’åºï¼ˆç ´åå¾ªç¯ç­‰å¾…ï¼‰**

```c
// âœ… è§£å†³æ–¹æ¡ˆï¼šæ‰€æœ‰çº¿ç¨‹éƒ½æŒ‰ç›¸åŒé¡ºåºè·å–é”
void* safe_thread1(void* arg) {
    // æ€»æ˜¯å…ˆè·å–lock_aï¼Œå†è·å–lock_b
    pthread_mutex_lock(&lock_a);
    pthread_mutex_lock(&lock_b);
    
    printf("çº¿ç¨‹1ï¼šå®‰å…¨åœ°è·å–äº†ä¸¤ä¸ªé”\n");
    
    pthread_mutex_unlock(&lock_b);
    pthread_mutex_unlock(&lock_a);
    return NULL;
}

void* safe_thread2(void* arg) {
    // ä¹Ÿæ˜¯å…ˆè·å–lock_aï¼Œå†è·å–lock_bï¼ˆç›¸åŒé¡ºåºï¼‰
    pthread_mutex_lock(&lock_a);
    pthread_mutex_lock(&lock_b);
    
    printf("çº¿ç¨‹2ï¼šå®‰å…¨åœ°è·å–äº†ä¸¤ä¸ªé”\n");
    
    pthread_mutex_unlock(&lock_b);
    pthread_mutex_unlock(&lock_a);
    return NULL;
}
```

**ğŸ¯ ç­–ç•¥2ï¼šè¶…æ—¶æœºåˆ¶ï¼ˆç ´åå æœ‰ç­‰å¾…ï¼‰**

```c
#include <errno.h>
#include <time.h>

void* timeout_thread(void* arg) {
    struct timespec timeout;
    
    pthread_mutex_lock(&lock_a);
    printf("çº¿ç¨‹è·å–é”AæˆåŠŸ\n");
    
    // è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆ1ç§’åï¼‰
    clock_gettime(CLOCK_REALTIME, &timeout);
    timeout.tv_sec += 1;
    
    // å°è¯•åœ¨è¶…æ—¶å†…è·å–é”B
    int result = pthread_mutex_timedlock(&lock_b, &timeout);
    
    if(result == 0) {
        printf("çº¿ç¨‹è·å–é”BæˆåŠŸ\n");
        // æ­£å¸¸å·¥ä½œ
        pthread_mutex_unlock(&lock_b);
    } else if(result == ETIMEDOUT) {
        printf("çº¿ç¨‹è·å–é”Bè¶…æ—¶ï¼Œæ”¾å¼ƒæ“ä½œ\n");
        // é¿å…äº†æ­»é”
    } else {
        printf("çº¿ç¨‹è·å–é”Bå¤±è´¥ï¼š%d\n", result);
    }
    
    pthread_mutex_unlock(&lock_a);
    return NULL;
}
```

**ğŸ¯ ç­–ç•¥3ï¼štrylockæœºåˆ¶ï¼ˆç ´åå æœ‰ç­‰å¾…ï¼‰**

```c
void* trylock_thread(void* arg) {
    pthread_mutex_lock(&lock_a);
    printf("çº¿ç¨‹è·å–é”AæˆåŠŸ\n");
    
    // å°è¯•è·å–é”Bï¼Œå¦‚æœå¤±è´¥å°±æ”¾å¼ƒ
    if(pthread_mutex_trylock(&lock_b) == 0) {
        printf("çº¿ç¨‹è·å–é”BæˆåŠŸ\n");
        
        // æ­£å¸¸å·¥ä½œ
        printf("çº¿ç¨‹ï¼šå®Œæˆå·¥ä½œ\n");
        
        pthread_mutex_unlock(&lock_b);
    } else {
        printf("çº¿ç¨‹æ— æ³•è·å–é”Bï¼Œæš‚æ—¶æ”¾å¼ƒ\n");
        
        // é‡Šæ”¾å·²æŒæœ‰çš„é”ï¼Œç¨åé‡è¯•
        pthread_mutex_unlock(&lock_a);
        
        usleep(100000);  // ç­‰å¾…100msåé‡è¯•
        
        // å¯ä»¥åœ¨è¿™é‡Œå®ç°é‡è¯•é€»è¾‘
        printf("çº¿ç¨‹ç¨åé‡è¯•\n");
        return NULL;
    }
    
    pthread_mutex_unlock(&lock_a);
    return NULL;
}
```

### 8.5 æ­»é”æ£€æµ‹å·¥å…·


**ğŸ”§ ä½¿ç”¨helgrindæ£€æµ‹æ­»é”**

```bash
# ç¼–è¯‘ç¨‹åº
gcc -g -o deadlock_test deadlock_test.c -lpthread

# ä½¿ç”¨valgrindçš„helgrindå·¥å…·æ£€æµ‹
valgrind --tool=helgrind --conflict-threshold=1 ./deadlock_test

# è¾“å‡ºç¤ºä¾‹ï¼š
# ==1234== Thread #1: lock order "0x602040 before 0x602080" violated
# ==1234== Thread #2: lock order "0x602080 before 0x602040" violated
# ==1234== Possible data race during read/write
```

**ğŸ“‹ æ­»é”é¢„é˜²æ£€æŸ¥æ¸…å•**

```
âœ… æ£€æŸ¥äº‹é¡¹ï¼š

ğŸ”¸ é”é¡ºåº
  - æ˜¯å¦æ‰€æœ‰çº¿ç¨‹éƒ½æŒ‰ç›¸åŒé¡ºåºè·å–å¤šä¸ªé”ï¼Ÿ
  - æ˜¯å¦å¯ä»¥ç»™é”åˆ†é…å›ºå®šçš„ä¼˜å…ˆçº§ï¼Ÿ

ğŸ”¸ æŒé”æ—¶é—´
  - æ˜¯å¦åœ¨æŒé”æ—¶åšäº†è€—æ—¶æ“ä½œï¼Ÿ
  - æ˜¯å¦å¯ä»¥å‡å°ä¸´ç•ŒåŒºå¤§å°ï¼Ÿ

ğŸ”¸ åµŒå¥—é”
  - æ˜¯å¦å­˜åœ¨ä¸å¿…è¦çš„é”åµŒå¥—ï¼Ÿ
  - æ˜¯å¦å¯ä»¥åˆå¹¶æˆ–æ‹†åˆ†é”ï¼Ÿ

ğŸ”¸ é”™è¯¯å¤„ç†
  - è·å–é”å¤±è´¥æ—¶æ˜¯å¦æ­£ç¡®å¤„ç†ï¼Ÿ
  - æ˜¯å¦ä½¿ç”¨äº†è¶…æ—¶æœºåˆ¶ï¼Ÿ

ğŸ”¸ è®¾è®¡åŸåˆ™
  - æ˜¯å¦éµå¾ª"æœ€å°‘é”åŸåˆ™"ï¼Ÿ
  - æ˜¯å¦è€ƒè™‘ä½¿ç”¨æ— é”æ•°æ®ç»“æ„ï¼Ÿ
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ pthreadåŸºç¡€ï¼šçº¿ç¨‹åˆ›å»ºã€ç­‰å¾…ã€é€€å‡ºçš„åŸºæœ¬æ“ä½œ
ğŸ”¸ äº’æ–¥é”mutexï¼šä¿æŠ¤å…±äº«èµ„æºï¼Œç¡®ä¿äº’æ–¥è®¿é—®
ğŸ”¸ æ¡ä»¶å˜é‡conditionï¼šå®ç°çº¿ç¨‹é—´çš„æ¡ä»¶åŒæ­¥
ğŸ”¸ è¯»å†™é”rwlockï¼šè¯»æ“ä½œå¹¶å‘ï¼Œå†™æ“ä½œç‹¬å 
ğŸ”¸ è‡ªæ—‹é”spinlockï¼šé€‚åˆçŸ­æ—¶é—´é”ç«äº‰çš„é«˜æ€§èƒ½åœºæ™¯
ğŸ”¸ TLSæœºåˆ¶ï¼šæ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰å­˜å‚¨ç©ºé—´
ğŸ”¸ çº¿ç¨‹å–æ¶ˆï¼šå®‰å…¨åœ°ç»ˆæ­¢çº¿ç¨‹å¹¶æ¸…ç†èµ„æº
ğŸ”¸ æ­»é”é¢„é˜²ï¼šé€šè¿‡è®¾è®¡é¿å…çº¿ç¨‹æ­»é”é—®é¢˜
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ åŒæ­¥å·¥å…·çš„é€‰æ‹©åŸåˆ™**
```
äº’æ–¥é”ï¼ˆmutexï¼‰ï¼š
â€¢ é€‚ç”¨ï¼šä¿æŠ¤ä¸´ç•ŒåŒºï¼Œç¡®ä¿äº’æ–¥è®¿é—®
â€¢ ç‰¹ç‚¹ï¼šä¼šé˜»å¡ç­‰å¾…ï¼Œå¼€é”€é€‚ä¸­

æ¡ä»¶å˜é‡ï¼ˆconditionï¼‰ï¼š
â€¢ é€‚ç”¨ï¼šç­‰å¾…æŸä¸ªæ¡ä»¶æˆç«‹
â€¢ ç‰¹ç‚¹ï¼šå¿…é¡»ä¸mutexé…åˆä½¿ç”¨

è¯»å†™é”ï¼ˆrwlockï¼‰ï¼š
â€¢ é€‚ç”¨ï¼šè¯»å¤šå†™å°‘çš„åœºæ™¯
â€¢ ç‰¹ç‚¹ï¼šè¯»æ“ä½œå¯å¹¶å‘ï¼Œå†™æ“ä½œç‹¬å 

è‡ªæ—‹é”ï¼ˆspinlockï¼‰ï¼š
â€¢ é€‚ç”¨ï¼šé”æŒæœ‰æ—¶é—´å¾ˆçŸ­çš„åœºæ™¯
â€¢ ç‰¹ç‚¹ï¼šä¸é˜»å¡ï¼Œæ¶ˆè€—CPUèµ„æº
```

**ğŸ”¹ ç¼–ç¨‹æœ€ä½³å®è·µ**
```
ğŸ¯ é”çš„ä½¿ç”¨åŸåˆ™ï¼š
â€¢ æœ€å°åŒ–ä¸´ç•ŒåŒºï¼šé”çš„èŒƒå›´è¶Šå°è¶Šå¥½
â€¢ é¿å…åµŒå¥—é”ï¼šå‡å°‘æ­»é”é£é™©
â€¢ ç»Ÿä¸€é”é¡ºåºï¼šå¦‚æœå¿…é¡»åµŒå¥—ï¼Œä¿æŒé¡ºåºä¸€è‡´
â€¢ åŠæ—¶é‡Šæ”¾é”ï¼šä¸è¦åœ¨æŒé”æ—¶åšè€—æ—¶æ“ä½œ

ğŸ¯ é”™è¯¯å¤„ç†ï¼š
â€¢ æ£€æŸ¥å‡½æ•°è¿”å›å€¼
â€¢ ä½¿ç”¨è¶…æ—¶æœºåˆ¶é˜²æ­¢æ— é™ç­‰å¾…
â€¢ æ­£ç¡®æ¸…ç†èµ„æº

ğŸ¯ è°ƒè¯•æŠ€å·§ï¼š
â€¢ ä½¿ç”¨è°ƒè¯•å·¥å…·ï¼ˆgdb, valgrindï¼‰
â€¢ æ·»åŠ æ—¥å¿—è®°å½•é”çš„è·å–å’Œé‡Šæ”¾
â€¢ å•å…ƒæµ‹è¯•è¦†ç›–å¹¶å‘åœºæ™¯
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’» å¸¸è§åº”ç”¨åœºæ™¯**

| åœºæ™¯ | æ¨èåŒæ­¥å·¥å…· | è¯´æ˜ |
|------|-------------|------|
| **ç”Ÿäº§è€…-æ¶ˆè´¹è€…** | mutex + condition | ç¼“å†²åŒºç®¡ç†ï¼Œæ¡ä»¶åŒæ­¥ |
| **è¯»å†™æ•°æ®åº“** | rwlock | è¯»æ“ä½œå¤šï¼Œå†™æ“ä½œå°‘ |
| **è®¡æ•°å™¨æ›´æ–°** | mutex æˆ– spinlock | ä¸´ç•ŒåŒºå°ç”¨spinlock |
| **çº¿ç¨‹æ± ä»»åŠ¡** | mutex + condition | ä»»åŠ¡é˜Ÿåˆ—ç®¡ç† |
| **é…ç½®ç®¡ç†** | rwlock | è¯»é…ç½®é¢‘ç¹ï¼Œå†™é…ç½®å°‘ |

**âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```
ğŸ”¸ å‡å°‘é”ç²’åº¦ï¼šä½¿ç”¨å¤šä¸ªç»†ç²’åº¦é”ä»£æ›¿å•ä¸ªç²—ç²’åº¦é”
ğŸ”¸ é¿å…é”ç«äº‰ï¼šè®¾è®¡æ—¶å°½é‡å‡å°‘å¤šçº¿ç¨‹ç«äº‰åŒä¸€èµ„æº
ğŸ”¸ ä½¿ç”¨åŸå­æ“ä½œï¼šç®€å•æ“ä½œå¯è€ƒè™‘åŸå­å˜é‡æ›¿ä»£é”
ğŸ”¸ æ— é”æ•°æ®ç»“æ„ï¼šé«˜æ€§èƒ½åœºæ™¯è€ƒè™‘æ— é”ç®—æ³•
ğŸ”¸ çº¿ç¨‹äº²å’Œæ€§ï¼šç»‘å®šçº¿ç¨‹åˆ°ç‰¹å®šCPUæ ¸å¿ƒ
```

### 9.4 ç¼–ç¨‹å®è·µæŠ€å·§


**ğŸ› ï¸ è°ƒè¯•å¤šçº¿ç¨‹ç¨‹åºçš„æ–¹æ³•**

```bash
# ç¼–è¯‘æ—¶åŠ è°ƒè¯•ä¿¡æ¯
gcc -g -pthread -o program program.c

# ä½¿ç”¨gdbè°ƒè¯•å¤šçº¿ç¨‹
gdb ./program
(gdb) set scheduler-locking on    # é”å®šè°ƒåº¦å™¨
(gdb) info threads                # æŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹
(gdb) thread 2                    # åˆ‡æ¢åˆ°çº¿ç¨‹2
(gdb) bt                          # æŸ¥çœ‹çº¿ç¨‹è°ƒç”¨æ ˆ

# ä½¿ç”¨valgrindæ£€æµ‹ç«æ€æ¡ä»¶
valgrind --tool=helgrind ./program

# ä½¿ç”¨straceè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨
strace -f ./program
```

**ğŸ“ ä»£ç å®¡æŸ¥æ£€æŸ¥ç‚¹**
```
âœ… å¤šçº¿ç¨‹ä»£ç å®¡æŸ¥æ¸…å•ï¼š

ğŸ”¸ èµ„æºç®¡ç†
  â–¡ æ¯ä¸ªpthread_createéƒ½æœ‰å¯¹åº”çš„pthread_joinï¼Ÿ
  â–¡ æ¯ä¸ªmutex_initéƒ½æœ‰å¯¹åº”çš„mutex_destroyï¼Ÿ
  â–¡ æ¯ä¸ªlockéƒ½æœ‰å¯¹åº”çš„unlockï¼Ÿ

ğŸ”¸ é”™è¯¯å¤„ç†  
  â–¡ æ˜¯å¦æ£€æŸ¥äº†æ‰€æœ‰pthreadå‡½æ•°çš„è¿”å›å€¼ï¼Ÿ
  â–¡ å¼‚å¸¸æƒ…å†µä¸‹æ˜¯å¦æ­£ç¡®é‡Šæ”¾äº†èµ„æºï¼Ÿ
  â–¡ æ˜¯å¦å¤„ç†äº†çº¿ç¨‹å–æ¶ˆçš„æƒ…å†µï¼Ÿ

ğŸ”¸ åŒæ­¥é€»è¾‘
  â–¡ æ˜¯å¦æ­£ç¡®ä½¿ç”¨äº†whileå¾ªç¯æ£€æŸ¥æ¡ä»¶å˜é‡ï¼Ÿ
  â–¡ æ˜¯å¦é¿å…äº†æ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼Ÿ
  â–¡ å…±äº«æ•°æ®æ˜¯å¦éƒ½è¢«é€‚å½“çš„é”ä¿æŠ¤ï¼Ÿ

ğŸ”¸ æ€§èƒ½è€ƒè™‘
  â–¡ ä¸´ç•ŒåŒºæ˜¯å¦å°½å¯èƒ½å°ï¼Ÿ
  â–¡ æ˜¯å¦é€‰æ‹©äº†åˆé€‚çš„åŒæ­¥å·¥å…·ï¼Ÿ
  â–¡ æ˜¯å¦é¿å…äº†ä¸å¿…è¦çš„çº¿ç¨‹åˆ›å»ºï¼Ÿ
```

### 9.5 è¿›é˜¶å­¦ä¹ æ–¹å‘


**ğŸš€ æ·±å…¥å­¦ä¹ å»ºè®®**
```
ğŸ”¸ ç³»ç»Ÿå±‚é¢ï¼š
  â€¢ å­¦ä¹ æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹è°ƒåº¦åŸç†
  â€¢ ç†è§£å†…æ ¸çº§çº¿ç¨‹ä¸ç”¨æˆ·çº§çº¿ç¨‹çš„åŒºåˆ«
  â€¢ æŒæ¡Linuxå†…æ ¸çš„åŒæ­¥åŸè¯­

ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼š
  â€¢ å­¦ä¹ æ— é”ç¼–ç¨‹æŠ€æœ¯
  â€¢ æŒæ¡å†…å­˜å±éšœå’ŒCPUç¼“å­˜ä¸€è‡´æ€§
  â€¢ äº†è§£NUMAæ¶æ„å¯¹å¤šçº¿ç¨‹çš„å½±å“

ğŸ”¸ é«˜çº§ä¸»é¢˜ï¼š
  â€¢ å¼‚æ­¥I/Oä¸äº‹ä»¶é©±åŠ¨ç¼–ç¨‹
  â€¢ åç¨‹å’Œè½»é‡çº§çº¿ç¨‹
  â€¢ åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä¸€è‡´æ€§ç®—æ³•

ğŸ”¸ å®è·µé¡¹ç›®ï¼š
  â€¢ å®ç°ä¸€ä¸ªçº¿ç¨‹æ± 
  â€¢ ç¼–å†™ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¡†æ¶
  â€¢ å¼€å‘é«˜æ€§èƒ½æœåŠ¡å™¨ç¨‹åº
```

**ğŸ“š æ¨èå­¦ä¹ èµ„æº**
```
ğŸ“– ç»å…¸ä¹¦ç±ï¼š
  â€¢ ã€ŠUNIXç¯å¢ƒé«˜çº§ç¼–ç¨‹ã€‹- Stevens
  â€¢ ã€ŠLinux/UNIXç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹- Kerrisk  
  â€¢ ã€Šå¤šå¤„ç†å™¨ç¼–ç¨‹çš„è‰ºæœ¯ã€‹- Herlihy

ğŸ”§ å®è·µå·¥å…·ï¼š
  â€¢ gdb: å¤šçº¿ç¨‹è°ƒè¯•
  â€¢ valgrind: å†…å­˜å’Œç«æ€æ£€æµ‹
  â€¢ perf: æ€§èƒ½åˆ†æå·¥å…·
  â€¢ htop: ç³»ç»Ÿç›‘æ§

ğŸ’» åœ¨çº¿èµ„æºï¼š
  â€¢ Linux man pages: æƒå¨æ–‡æ¡£
  â€¢ POSIXæ ‡å‡†æ–‡æ¡£: æ ‡å‡†è§„èŒƒ
  â€¢ GitHubå¼€æºé¡¹ç›®: å­¦ä¹ ä¼˜ç§€ä»£ç 
```

### 9.6 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â“ FAQ troubleshooting**

```
Q: ç¨‹åºè¿è¡Œæ—¶å¶å°”å‡ºç°æ®µé”™è¯¯ï¼Œå•çº¿ç¨‹æ—¶æ­£å¸¸ï¼Ÿ
A: æ£€æŸ¥å…±äº«æ•°æ®è®¿é—®æ˜¯å¦åŠ é”ï¼Œä½¿ç”¨valgrind --tool=helgrindæ£€æµ‹

Q: å¤šçº¿ç¨‹ç¨‹åºæ€§èƒ½ä¸å¦‚é¢„æœŸï¼Œç”šè‡³æ¯”å•çº¿ç¨‹æ…¢ï¼Ÿ
A: æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¿‡åº¦åŠ é”ã€é¢‘ç¹çš„é”ç«äº‰ã€æˆ–false sharing

Q: æ¡ä»¶å˜é‡ç­‰å¾…æ—¶ç¨‹åºå¡æ­»ï¼Ÿ
A: ç¡®è®¤æ˜¯å¦ä½¿ç”¨whileå¾ªç¯æ£€æŸ¥æ¡ä»¶ï¼Œæ˜¯å¦æ­£ç¡®å‘é€ä¿¡å·

Q: çº¿ç¨‹å–æ¶ˆåèµ„æºæ²¡æœ‰é‡Šæ”¾ï¼Ÿ
A: æ£€æŸ¥æ¸…ç†å‡½æ•°æ˜¯å¦æ­£ç¡®æ³¨å†Œï¼Œå–æ¶ˆç‚¹æ˜¯å¦åˆé€‚è®¾ç½®

Q: æ­»é”å¶å°”å‘ç”Ÿï¼Œå¾ˆéš¾é‡ç°ï¼Ÿ
A: ä½¿ç”¨é”æ’åºï¼Œæ·»åŠ è¶…æ—¶æœºåˆ¶ï¼Œç”¨å·¥å…·æ£€æµ‹æ½œåœ¨æ­»é”

Q: ç¼–è¯‘æ—¶æç¤ºundefined reference to pthread_createï¼Ÿ
A: ç¡®ä¿ä½¿ç”¨äº† -lpthread é“¾æ¥é€‰é¡¹
```

**ğŸ¯ æ€§èƒ½è°ƒä¼˜å®ç”¨æŠ€å·§**
```
ğŸ”¸ é”ä¼˜åŒ–ï¼š
  â€¢ å‡å°‘æŒé”æ—¶é—´ï¼šå°†éä¸´ç•Œæ“ä½œç§»å‡ºé”ä¿æŠ¤åŒºåŸŸ
  â€¢ è¯»å†™åˆ†ç¦»ï¼šè¯»å¤šå†™å°‘åœºæ™¯ä½¿ç”¨è¯»å†™é”
  â€¢ é”åˆ†ç¦»ï¼šå°†å¤§é”æ‹†åˆ†ä¸ºå¤šä¸ªå°é”

ğŸ”¸ å†…å­˜ä¼˜åŒ–ï¼š
  â€¢ é¿å…false sharingï¼šç¡®ä¿çº¿ç¨‹è®¿é—®çš„æ•°æ®åœ¨ä¸åŒç¼“å­˜è¡Œ
  â€¢ ä½¿ç”¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼šå‡å°‘å…±äº«æ•°æ®è®¿é—®
  â€¢ å†…å­˜å¯¹é½ï¼šæé«˜ç¼“å­˜æ•ˆç‡

ğŸ”¸ ç®—æ³•ä¼˜åŒ–ï¼š  
  â€¢ ä½¿ç”¨æ— é”æ•°æ®ç»“æ„ï¼šå¦‚æ— é”é˜Ÿåˆ—ã€æ ˆ
  â€¢ æ‰¹é‡å¤„ç†ï¼šå‡å°‘é”è·å–æ¬¡æ•°
  â€¢ å·¥ä½œçªƒå–ï¼šå¹³è¡¡çº¿ç¨‹é—´è´Ÿè½½
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- pthreadç¼–ç¨‹é”ä¸ºå…ˆï¼Œmutexæ¡ä»¶é…åˆä¸¥
- è¯»å†™è‡ªæ—‹å„æœ‰ç”¨ï¼ŒTLSå­˜å‚¨æœ€å®‰å…¨  
- æ­»é”é¢„é˜²é è®¾è®¡ï¼Œé¡ºåºè¶…æ—¶ç ´å¾ªç¯
- è°ƒè¯•å·¥å…·è¦å–„ç”¨ï¼Œæ€§èƒ½ä¼˜åŒ–éœ€å®è·µ

é€šè¿‡æŒæ¡è¿™äº›å¤šçº¿ç¨‹åŒæ­¥ä¸äº’æ–¥æœºåˆ¶ï¼Œä½ å°±èƒ½ç¼–å†™å‡ºå®‰å…¨ã€é«˜æ•ˆçš„å¹¶å‘ç¨‹åºã€‚è®°ä½ï¼šå¤šçº¿ç¨‹ç¼–ç¨‹çš„å…³é”®åœ¨äºæ­£ç¡®çš„åŒæ­¥è®¾è®¡å’Œç»†è‡´çš„èµ„æºç®¡ç†ï¼