---
title: 6ã€ç½‘ç»œèµ„æºæ§åˆ¶ä¸æµé‡æ•´å½¢
---
## ğŸ“š ç›®å½•

1. [ç½‘ç»œèµ„æºæ§åˆ¶åŸºç¡€æ¦‚å¿µ](#1-ç½‘ç»œèµ„æºæ§åˆ¶åŸºç¡€æ¦‚å¿µ)
2. [net_clsç½‘ç»œåˆ†ç±»æ ‡è®°](#2-net_clsç½‘ç»œåˆ†ç±»æ ‡è®°)
3. [TCæµé‡æ§åˆ¶åŸºç¡€](#3-tcæµé‡æ§åˆ¶åŸºç¡€)
4. [ç½‘ç»œå¸¦å®½é™åˆ¶å®ç°](#4-ç½‘ç»œå¸¦å®½é™åˆ¶å®ç°)
5. [ç½‘ç»œQoSé…ç½®è¯¦è§£](#5-ç½‘ç»œqosé…ç½®è¯¦è§£)
6. [ç½‘ç»œä¼˜å…ˆçº§è®¾ç½®](#6-ç½‘ç»œä¼˜å…ˆçº§è®¾ç½®)
7. [ç½‘ç»œä½¿ç”¨ç»Ÿè®¡](#7-ç½‘ç»œä½¿ç”¨ç»Ÿè®¡)
8. [ç½‘ç»œèµ„æºéš”ç¦»](#8-ç½‘ç»œèµ„æºéš”ç¦»)
9. [ç½‘ç»œæ€§èƒ½ç›‘æ§](#9-ç½‘ç»œæ€§èƒ½ç›‘æ§)
10. [å®æˆ˜æ¡ˆä¾‹ä¸æœ€ä½³å®è·µ](#10-å®æˆ˜æ¡ˆä¾‹ä¸æœ€ä½³å®è·µ)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ ç½‘ç»œèµ„æºæ§åˆ¶åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ç½‘ç»œèµ„æºæ§åˆ¶


**é€šä¿—ç†è§£**ï¼šç½‘ç»œèµ„æºæ§åˆ¶å°±åƒç®¡ç†ä¸€ä¸ªå…¬å¸çš„ç½‘ç»œä½¿ç”¨æƒé™ï¼Œç¡®ä¿é‡è¦éƒ¨é—¨æœ‰è¶³å¤Ÿå¸¦å®½ï¼Œé˜²æ­¢æŸä¸ªéƒ¨é—¨å ç”¨å¤ªå¤šç½‘ç»œèµ„æºå½±å“å…¶ä»–éƒ¨é—¨å·¥ä½œã€‚

```
ç°å®åœºæ™¯ç±»æ¯”ï¼š
å…¬å¸ç½‘ç»œ 100M å¸¦å®½
â”œâ”€â”€ ç ”å‘éƒ¨é—¨ï¼šéœ€è¦ 50Mï¼ˆä¼˜å…ˆçº§é«˜ï¼‰
â”œâ”€â”€ å¸‚åœºéƒ¨é—¨ï¼šéœ€è¦ 30Mï¼ˆæ­£å¸¸ä¼˜å…ˆçº§ï¼‰  
â”œâ”€â”€ è¡Œæ”¿éƒ¨é—¨ï¼šéœ€è¦ 20Mï¼ˆä½ä¼˜å…ˆçº§ï¼‰
â””â”€â”€ é¢„ç•™å¸¦å®½ï¼šä¿ç•™ä¸€äº›åº”æ€¥ä½¿ç”¨

ç½‘ç»œæ§åˆ¶ç›®æ ‡ï¼š
âœ… ä¿è¯é‡è¦æœåŠ¡æœ‰è¶³å¤Ÿå¸¦å®½
âœ… é˜²æ­¢æŸä¸ªè¿›ç¨‹ç‹¬å ç½‘ç»œ
âœ… æé«˜ç½‘ç»œä½¿ç”¨æ•ˆç‡
âœ… å®ç°å…¬å¹³çš„å¸¦å®½åˆ†é…
```

### 1.2 æ ¸å¿ƒæ§åˆ¶æœºåˆ¶


**ğŸ”¸ Linuxç½‘ç»œæ§åˆ¶ä½“ç³»**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        åº”ç”¨ç¨‹åº              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Control Groups         â”‚ â† è¿›ç¨‹åˆ†ç»„ç®¡ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Traffic Control (TC)    â”‚ â† æµé‡æ•´å½¢æ ¸å¿ƒ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Network Stack          â”‚ â† å†…æ ¸ç½‘ç»œæ ˆ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Network Interface      â”‚ â† ç½‘ç»œæ¥å£
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç»„ä»¶è¯´æ˜**ï¼š
- **CGroup (net_cls)**ï¼šç»™è¿›ç¨‹è´´"æ ‡ç­¾"ï¼Œæ ‡è®°å®ƒä»¬å±äºå“ªä¸ªç»„
- **TC (Traffic Control)**ï¼šæ ¹æ®æ ‡ç­¾å¯¹ç½‘ç»œæµé‡è¿›è¡Œé™é€Ÿã€ä¼˜å…ˆçº§å¤„ç†
- **QoS (Quality of Service)**ï¼šæœåŠ¡è´¨é‡ä¿è¯æœºåˆ¶
- **Network Namespace**ï¼šç½‘ç»œéš”ç¦»æŠ€æœ¯

### 1.3 åº”ç”¨åœºæ™¯


**å¸¸è§ä½¿ç”¨åœºæ™¯**ï¼š
- **ğŸ¢ ä¼ä¸šç¯å¢ƒ**ï¼šé™åˆ¶ä¸‹è½½è½¯ä»¶å ç”¨å¸¦å®½ï¼Œä¿è¯ä¸šåŠ¡ç³»ç»Ÿæµé‡
- **â˜ï¸ äº‘æœåŠ¡**ï¼šä¸ºä¸åŒç§Ÿæˆ·åˆ†é…ä¸åŒçš„ç½‘ç»œèµ„æºé…é¢
- **ğŸ® æ¸¸æˆæœåŠ¡å™¨**ï¼šä¿è¯æ¸¸æˆæ•°æ®åŒ…ä¼˜å…ˆä¼ è¾“ï¼Œé™ä½å»¶è¿Ÿ
- **ğŸ“º è§†é¢‘ç½‘ç«™**ï¼šæ§åˆ¶ä¸Šä¼ ä¸‹è½½é€Ÿåº¦ï¼Œé¿å…ç½‘ç»œæ‹¥å µ

---

## 2. ğŸ·ï¸ net_clsç½‘ç»œåˆ†ç±»æ ‡è®°


### 2.1 net_clsæ§åˆ¶å™¨æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯net_cls**ï¼šå®ƒæ˜¯cgroupçš„ä¸€ä¸ªå­ç³»ç»Ÿï¼Œä¸“é—¨ç”¨æ¥ç»™è¿›ç¨‹çš„ç½‘ç»œæ•°æ®åŒ…æ‰“"æ ‡ç­¾"ã€‚

```
ç®€å•ç†è§£ï¼š
å°±åƒç»™ä¸åŒéƒ¨é—¨çš„å‘˜å·¥å‘ä¸åŒé¢œè‰²çš„å·¥ç‰Œï¼š
- çº¢è‰²å·¥ç‰Œï¼šç ”å‘éƒ¨ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
- è“è‰²å·¥ç‰Œï¼šå¸‚åœºéƒ¨ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰  
- ç»¿è‰²å·¥ç‰Œï¼šè¡Œæ”¿éƒ¨ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

net_clsåšçš„äº‹æƒ…ï¼š
ç»™æ¯ä¸ªè¿›ç¨‹å‘é€çš„ç½‘ç»œæ•°æ®åŒ…è´´ä¸Š"é¢œè‰²æ ‡ç­¾"
ç„¶åTCæ ¹æ®é¢œè‰²æ ‡ç­¾å†³å®šå¦‚ä½•å¤„ç†è¿™äº›æ•°æ®åŒ…
```

### 2.2 net_clsé…ç½®å®è·µ


**ğŸ”§ åŸºç¡€é…ç½®æ­¥éª¤**

**æ­¥éª¤1ï¼šæ£€æŸ¥ç³»ç»Ÿæ”¯æŒ**
```bash
# æ£€æŸ¥æ˜¯å¦æ”¯æŒnet_cls
ls /sys/fs/cgroup/ | grep net_cls

# å¦‚æœæ²¡æœ‰ï¼Œéœ€è¦æŒ‚è½½
sudo mkdir -p /sys/fs/cgroup/net_cls
sudo mount -t cgroup -o net_cls none /sys/fs/cgroup/net_cls
```

**æ­¥éª¤2ï¼šåˆ›å»ºåˆ†ç±»ç»„**
```bash
# åˆ›å»ºé«˜ä¼˜å…ˆçº§ç»„ï¼ˆç ”å‘éƒ¨é—¨ï¼‰
sudo mkdir /sys/fs/cgroup/net_cls/high_priority

# åˆ›å»ºæ™®é€šä¼˜å…ˆçº§ç»„ï¼ˆå¸‚åœºéƒ¨é—¨ï¼‰
sudo mkdir /sys/fs/cgroup/net_cls/normal_priority

# åˆ›å»ºä½ä¼˜å…ˆçº§ç»„ï¼ˆåå°ä»»åŠ¡ï¼‰
sudo mkdir /sys/fs/cgroup/net_cls/low_priority
```

**æ­¥éª¤3ï¼šè®¾ç½®åˆ†ç±»æ ‡è®°**
```bash
# è®¾ç½®åˆ†ç±»æ ‡è®°ï¼ˆ16è¿›åˆ¶æ ¼å¼ï¼šä¸»ç±»å·:å­ç±»å·ï¼‰
# é«˜ä¼˜å…ˆçº§ç»„æ ‡è®°ä¸º 1:1
echo 0x10001 | sudo tee /sys/fs/cgroup/net_cls/high_priority/net_cls.classid

# æ™®é€šä¼˜å…ˆçº§ç»„æ ‡è®°ä¸º 1:2  
echo 0x10002 | sudo tee /sys/fs/cgroup/net_cls/normal_priority/net_cls.classid

# ä½ä¼˜å…ˆçº§ç»„æ ‡è®°ä¸º 1:3
echo 0x10003 | sudo tee /sys/fs/cgroup/net_cls/low_priority/net_cls.classid
```

### 2.3 è¿›ç¨‹åˆ†ç±»å®è·µ


**ğŸ¯ å°†è¿›ç¨‹åˆ†é…åˆ°ä¸åŒç»„**

```bash
# å‡è®¾æœ‰ä¸€ä¸ªé‡è¦çš„WebæœåŠ¡è¿›ç¨‹PIDä¸º1234
echo 1234 | sudo tee /sys/fs/cgroup/net_cls/high_priority/cgroup.procs

# å°†ä¸‹è½½å·¥å…·è¿›ç¨‹PIDä¸º5678åˆ†é…åˆ°ä½ä¼˜å…ˆçº§ç»„
echo 5678 | sudo tee /sys/fs/cgroup/net_cls/low_priority/cgroup.procs

# éªŒè¯åˆ†ç±»æ˜¯å¦ç”Ÿæ•ˆ
cat /sys/fs/cgroup/net_cls/high_priority/cgroup.procs
```

**è‡ªåŠ¨åŒ–è„šæœ¬ç¤ºä¾‹**ï¼š
```bash
#!/bin/bash
# ç½‘ç»œåˆ†ç±»ç®¡ç†è„šæœ¬

# å‡½æ•°ï¼šå°†è¿›ç¨‹åŠ å…¥é«˜ä¼˜å…ˆçº§ç»„
add_to_high_priority() {
    local pid=$1
    echo $pid | sudo tee /sys/fs/cgroup/net_cls/high_priority/cgroup.procs
    echo "è¿›ç¨‹ $pid å·²åŠ å…¥é«˜ä¼˜å…ˆçº§ç½‘ç»œç»„"
}

# å‡½æ•°ï¼šå°†è¿›ç¨‹åŠ å…¥ä½ä¼˜å…ˆçº§ç»„  
add_to_low_priority() {
    local pid=$1
    echo $pid | sudo tee /sys/fs/cgroup/net_cls/low_priority/cgroup.procs
    echo "è¿›ç¨‹ $pid å·²åŠ å…¥ä½ä¼˜å…ˆçº§ç½‘ç»œç»„"
}

# ä½¿ç”¨ç¤ºä¾‹
# ./network_classify.sh high 1234
# ./network_classify.sh low 5678
```

---

## 3. ğŸš¦ TCæµé‡æ§åˆ¶åŸºç¡€


### 3.1 ä»€ä¹ˆæ˜¯TC (Traffic Control)


**é€šä¿—è§£é‡Š**ï¼šTCå°±åƒäº¤é€šè­¦å¯Ÿï¼Œç®¡ç†ç½‘ç»œæ•°æ®åŒ…çš„"äº¤é€š"ã€‚å®ƒå¯ä»¥ï¼š
- ğŸš¥ **æ§åˆ¶çº¢ç»¿ç¯**ï¼šå†³å®šå“ªäº›æ•°æ®åŒ…å…ˆèµ°ï¼Œå“ªäº›åèµ°
- ğŸ›£ï¸ **è®¾ç½®è½¦é“é™é€Ÿ**ï¼šé™åˆ¶æŸäº›æµé‡çš„æœ€å¤§é€Ÿåº¦
- ğŸš§ **åˆ†é…è½¦é“**ï¼šç»™ä¸åŒç±»å‹çš„æµé‡åˆ†é…ä¸“ç”¨é€šé“

### 3.2 TCæ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ åŸºæœ¬ç»„ä»¶è§£é‡Š**

```
TCæµé‡æ§åˆ¶ä½“ç³»ï¼š

é˜Ÿåˆ—è§„åˆ™ (Qdisc) - æ’é˜Ÿæ–¹å¼
â”œâ”€â”€ æ ¹é˜Ÿåˆ— (Root Qdisc)     â† ç½‘å¡çš„æ€»ç®¡ç†å‘˜
â”œâ”€â”€ åˆ†ç±»é˜Ÿåˆ— (Class)        â† ä¸åŒçš„è½¦é“
â””â”€â”€ è¿‡æ»¤å™¨ (Filter)         â† äº¤é€šæŒ‡ç¤ºç‰Œ

å¸¸ç”¨é˜Ÿåˆ—ç±»å‹ï¼š
â€¢ pfifo_fastï¼šé»˜è®¤é˜Ÿåˆ—ï¼ˆç®€å•å…ˆè¿›å…ˆå‡ºï¼‰
â€¢ htbï¼šå±‚æ¬¡ä»¤ç‰Œæ¡¶ï¼ˆæœ€å¸¸ç”¨çš„é™é€Ÿæ–¹æ³•ï¼‰
â€¢ cbqï¼šåŸºäºç±»çš„é˜Ÿåˆ—
â€¢ sfqï¼šå…¬å¹³é˜Ÿåˆ—
```

### 3.3 HTBé˜Ÿåˆ—è¯¦è§£


**ä»€ä¹ˆæ˜¯HTB (Hierarchical Token Bucket)**ï¼š
HTBå°±åƒé“¶è¡Œçš„ä¿¡è´·ç³»ç»Ÿï¼Œç»™æ¯ä¸ªè´¦æˆ·ï¼ˆè¿›ç¨‹ç»„ï¼‰åˆ†é…ä¸åŒçš„"ä¿¡ç”¨é¢åº¦"ï¼ˆå¸¦å®½é…é¢ï¼‰ã€‚

**ğŸ¦ HTBå·¥ä½œåŸç†ç±»æ¯”**ï¼š
```
é“¶è¡Œä¿¡è´·æ¨¡å‹ï¼š
æ€»é¢åº¦ 100M
â”œâ”€â”€ VIPå®¢æˆ·ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰ï¼šä¿è¯ 50Mï¼Œæœ€é«˜å¯å€Ÿ 80M
â”œâ”€â”€ æ™®é€šå®¢æˆ·ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰ï¼šä¿è¯ 30Mï¼Œæœ€é«˜å¯å€Ÿ 50M  
â””â”€â”€ æ–°å®¢æˆ·ï¼ˆä½ä¼˜å…ˆçº§ï¼‰ï¼šä¿è¯ 20Mï¼Œæœ€é«˜å¯å€Ÿ 30M

HTBç½‘ç»œæ¨¡å‹ï¼š
æ€»å¸¦å®½ 100Mbps
â”œâ”€â”€ é«˜ä¼˜å…ˆçº§ï¼šä¿è¯ 50Mbpsï¼Œå³°å€¼ 80Mbps
â”œâ”€â”€ ä¸­ä¼˜å…ˆçº§ï¼šä¿è¯ 30Mbpsï¼Œå³°å€¼ 50Mbps
â””â”€â”€ ä½ä¼˜å…ˆçº§ï¼šä¿è¯ 20Mbpsï¼Œå³°å€¼ 30Mbps
```

---

## 4. ğŸŒŠ ç½‘ç»œå¸¦å®½é™åˆ¶å®ç°


### 4.1 åŸºç¡€å¸¦å®½é™åˆ¶


**ğŸ”§ å®æˆ˜ï¼šç»™ç‰¹å®šè¿›ç¨‹é™åˆ¶å¸¦å®½**

**æ­¥éª¤1ï¼šé…ç½®æ ¹é˜Ÿåˆ—**
```bash
# åœ¨eth0ç½‘å¡ä¸Šé…ç½®HTBæ ¹é˜Ÿåˆ—
sudo tc qdisc add dev eth0 root handle 1: htb default 3

# è§£é‡Šå„å‚æ•°ï¼š
# dev eth0ï¼šåœ¨eth0ç½‘å¡ä¸Šæ“ä½œ
# rootï¼šæ ¹é˜Ÿåˆ—
# handle 1:ï¼šé˜Ÿåˆ—å¥æŸ„å·ä¸º1
# htbï¼šä½¿ç”¨HTBç®—æ³•
# default 3ï¼šé»˜è®¤æ•°æ®åŒ…èµ°ç±»åˆ«3
```

**æ­¥éª¤2ï¼šåˆ›å»ºå¸¦å®½ç±»åˆ«**
```bash
# åˆ›å»ºæ€»å¸¦å®½é™åˆ¶ï¼ˆå‡è®¾æ€»å…±100Mbpsï¼‰
sudo tc class add dev eth0 parent 1: classid 1:1 htb rate 100mbit

# åˆ›å»ºé«˜ä¼˜å…ˆçº§ç±»åˆ«ï¼ˆä¿è¯50Mï¼Œå³°å€¼80Mï¼‰
sudo tc class add dev eth0 parent 1:1 classid 1:10 htb rate 50mbit ceil 80mbit

# åˆ›å»ºæ™®é€šä¼˜å…ˆçº§ç±»åˆ«ï¼ˆä¿è¯30Mï¼Œå³°å€¼50Mï¼‰
sudo tc class add dev eth0 parent 1:1 classid 1:20 htb rate 30mbit ceil 50mbit

# åˆ›å»ºä½ä¼˜å…ˆçº§ç±»åˆ«ï¼ˆä¿è¯20Mï¼Œå³°å€¼30Mï¼‰
sudo tc class add dev eth0 parent 1:1 classid 1:30 htb rate 20mbit ceil 30mbit
```

**æ­¥éª¤3ï¼šå…³è”net_clsæ ‡è®°**
```bash
# å°†net_clsæ ‡è®°çš„æ•°æ®åŒ…åˆ†é…åˆ°å¯¹åº”ç±»åˆ«
sudo tc filter add dev eth0 parent 1: protocol ip prio 1 handle 1:1 cgroup

# è¿™ä¸ªå‘½ä»¤çš„æ„æ€ï¼š
# æ ¹æ®cgroup net_clsçš„æ ‡è®°ï¼Œè‡ªåŠ¨å°†æ•°æ®åŒ…åˆ†é…åˆ°å¯¹åº”çš„HTBç±»åˆ«
```

### 4.2 å®Œæ•´é…ç½®è„šæœ¬


```bash
#!/bin/bash
# ç½‘ç»œå¸¦å®½é™åˆ¶é…ç½®è„šæœ¬

INTERFACE="eth0"      # ç½‘ç»œæ¥å£
TOTAL_BW="100mbit"    # æ€»å¸¦å®½

echo "é…ç½®ç½‘ç»œå¸¦å®½é™åˆ¶..."

# æ¸…é™¤ç°æœ‰é…ç½®
sudo tc qdisc del dev $INTERFACE root 2>/dev/null

# 1. é…ç½®æ ¹é˜Ÿåˆ—
sudo tc qdisc add dev $INTERFACE root handle 1: htb default 30

# 2. é…ç½®æ€»å¸¦å®½
sudo tc class add dev $INTERFACE parent 1: classid 1:1 htb rate $TOTAL_BW

# 3. é…ç½®å„ä¼˜å…ˆçº§ç±»åˆ«
# é«˜ä¼˜å…ˆçº§ï¼šWebæœåŠ¡å™¨ã€æ•°æ®åº“
sudo tc class add dev $INTERFACE parent 1:1 classid 1:10 htb rate 50mbit ceil 80mbit prio 1

# ä¸­ä¼˜å…ˆçº§ï¼šä¸€èˆ¬åº”ç”¨
sudo tc class add dev $INTERFACE parent 1:1 classid 1:20 htb rate 30mbit ceil 50mbit prio 2

# ä½ä¼˜å…ˆçº§ï¼šä¸‹è½½ã€å¤‡ä»½ç­‰åå°ä»»åŠ¡  
sudo tc class add dev $INTERFACE parent 1:1 classid 1:30 htb rate 20mbit ceil 30mbit prio 3

# 4. é…ç½®è¿‡æ»¤å™¨
sudo tc filter add dev $INTERFACE parent 1: protocol ip prio 1 handle 1:1 cgroup

echo "å¸¦å®½é™åˆ¶é…ç½®å®Œæˆï¼"

# 5. æ˜¾ç¤ºé…ç½®ç»“æœ
echo "å½“å‰é…ç½®ï¼š"
sudo tc qdisc show dev $INTERFACE
sudo tc class show dev $INTERFACE
```

### 4.3 éªŒè¯å¸¦å®½é™åˆ¶æ•ˆæœ


**ğŸ” æµ‹è¯•æ–¹æ³•**

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨iperfæµ‹è¯•
# åœ¨æœåŠ¡å™¨ç«¯
iperf -s

# åœ¨å®¢æˆ·ç«¯æµ‹è¯•é«˜ä¼˜å…ˆçº§è¿›ç¨‹çš„é€Ÿåº¦
# å…ˆå°†iperfå®¢æˆ·ç«¯è¿›ç¨‹åŠ å…¥é«˜ä¼˜å…ˆçº§ç»„
echo $$ | sudo tee /sys/fs/cgroup/net_cls/high_priority/cgroup.procs
iperf -c server_ip -t 10

# æ–¹æ³•2ï¼šä½¿ç”¨wgetæµ‹è¯•ä¸‹è½½é€Ÿåº¦  
wget --limit-rate=0 http://example.com/large_file.zip

# æ–¹æ³•3ï¼šå®æ—¶ç›‘æ§ç½‘ç»œä½¿ç”¨
sudo tc -s class show dev eth0
```

---

## 5. ğŸ¯ ç½‘ç»œQoSé…ç½®è¯¦è§£


### 5.1 ä»€ä¹ˆæ˜¯QoS (Quality of Service)


**ç”Ÿæ´»åŒ–ç†è§£**ï¼šQoSå°±åƒåŒ»é™¢çš„åˆ†è¯Šåˆ¶åº¦
- ğŸš¨ **æ€¥è¯Š**ï¼šå¿ƒè„ç—…ã€å¤–ä¼¤ç­‰ç´§æ€¥æƒ…å†µï¼Œä¼˜å…ˆå¤„ç†
- ğŸ¥ **ä¸“ç§‘**ï¼šé¢„çº¦çš„ä¸“ç§‘é—¨è¯Šï¼ŒæŒ‰æ—¶å¤„ç†
- ğŸ“‹ **æ™®é€šé—¨è¯Š**ï¼šä¸€èˆ¬ç–¾ç—…ï¼Œæ’é˜Ÿç­‰å¾…

**ç½‘ç»œQoSå¯¹åº”**ï¼š
- âš¡ **å®æ—¶æµé‡**ï¼šè¯­éŸ³é€šè¯ã€è§†é¢‘ä¼šè®®ï¼ˆå»¶è¿Ÿæ•æ„Ÿï¼‰
- ğŸ“º **æµåª’ä½“**ï¼šåœ¨çº¿è§†é¢‘ã€ç›´æ’­ï¼ˆéœ€è¦ç¨³å®šå¸¦å®½ï¼‰
- ğŸ“ **æ–‡ä»¶ä¼ è¾“**ï¼šä¸‹è½½ã€åŒæ­¥ï¼ˆå¯¹å»¶è¿Ÿä¸æ•æ„Ÿï¼‰

### 5.2 QoSåˆ†ç±»æ–¹æ³•


**ğŸ”¸ åŸºäºDSCPæ ‡è®°çš„QoS**

```bash
# DSCP (Differentiated Services Code Point) æ ‡è®°ç¤ºä¾‹

# ä¸ºé«˜ä¼˜å…ˆçº§æµé‡è®¾ç½®DSCPæ ‡è®°
sudo tc filter add dev eth0 parent 1: protocol ip prio 1 \
    u32 match ip dscp 0x2e 0xff flowid 1:10

# å¸¸ç”¨DSCPå€¼è¯´æ˜ï¼š
# 0x2e (46): è¯­éŸ³é€šè¯ (Expedited Forwarding)
# 0x22 (34): è§†é¢‘ä¼šè®® (Assured Forwarding)
# 0x1a (26): é‡è¦æ•°æ® (Assured Forwarding)  
# 0x00 (0):  æ™®é€šæµé‡ (Best Effort)
```

**ğŸ”¸ åŸºäºç«¯å£çš„QoSåˆ†ç±»**

```bash
# å°†SSHæµé‡(ç«¯å£22)åˆ†é…åˆ°é«˜ä¼˜å…ˆçº§
sudo tc filter add dev eth0 parent 1: protocol ip prio 1 \
    u32 match ip sport 22 0xffff flowid 1:10

# å°†HTTPæµé‡(ç«¯å£80)åˆ†é…åˆ°ä¸­ä¼˜å…ˆçº§  
sudo tc filter add dev eth0 parent 1: protocol ip prio 2 \
    u32 match ip sport 80 0xffff flowid 1:20

# å°†P2Pæµé‡åˆ†é…åˆ°ä½ä¼˜å…ˆçº§ï¼ˆå¸¸ç”¨ç«¯å£èŒƒå›´ï¼‰
sudo tc filter add dev eth0 parent 1: protocol ip prio 3 \
    u32 match ip sport 6881 0xffff flowid 1:30
```

### 5.3 é«˜çº§QoSé…ç½®


**ğŸš€ å®æˆ˜æ¡ˆä¾‹ï¼šé…ç½®ä¼ä¸šçº§QoS**

```bash
#!/bin/bash
# ä¼ä¸šç½‘ç»œQoSé…ç½®è„šæœ¬

INTERFACE="eth0"
TOTAL_BW="1000mbit"  # åƒå…†ç½‘ç»œ

echo "é…ç½®ä¼ä¸šçº§QoS..."

# æ¸…é™¤ç°æœ‰é…ç½®
sudo tc qdisc del dev $INTERFACE root 2>/dev/null

# æ ¹é˜Ÿåˆ—é…ç½®
sudo tc qdisc add dev $INTERFACE root handle 1: htb default 40

# æ€»å¸¦å®½åˆ†é…
sudo tc class add dev $INTERFACE parent 1: classid 1:1 htb rate $TOTAL_BW

# === ä¸šåŠ¡å…³é”®åº”ç”¨ (40%) ===
sudo tc class add dev $INTERFACE parent 1:1 classid 1:10 \
    htb rate 400mbit ceil 600mbit prio 1

# æ•°æ®åº“æµé‡
sudo tc class add dev $INTERFACE parent 1:10 classid 1:11 \
    htb rate 200mbit ceil 400mbit prio 1

# Webåº”ç”¨æµé‡  
sudo tc class add dev $INTERFACE parent 1:10 classid 1:12 \
    htb rate 200mbit ceil 400mbit prio 1

# === åŠå…¬åº”ç”¨ (35%) ===
sudo tc class add dev $INTERFACE parent 1:1 classid 1:20 \
    htb rate 350mbit ceil 500mbit prio 2

# é‚®ä»¶ç³»ç»Ÿ
sudo tc class add dev $INTERFACE parent 1:20 classid 1:21 \
    htb rate 100mbit ceil 200mbit prio 2

# æ–‡ä»¶å…±äº«
sudo tc class add dev $INTERFACE parent 1:20 classid 1:22 \
    htb rate 250mbit ceil 350mbit prio 2

# === äº’è”ç½‘è®¿é—® (25%) ===
sudo tc class add dev $INTERFACE parent 1:1 classid 1:30 \
    htb rate 250mbit ceil 400mbit prio 3

# ä¸€èˆ¬ä¸Šç½‘
sudo tc class add dev $INTERFACE parent 1:30 classid 1:31 \
    htb rate 150mbit ceil 250mbit prio 3

# ä¸‹è½½/æ›´æ–°ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
sudo tc class add dev $INTERFACE parent 1:30 classid 1:32 \
    htb rate 100mbit ceil 200mbit prio 4

echo "QoSé…ç½®å®Œæˆï¼"
```

---

## 6. ğŸ“Š ç½‘ç»œä¼˜å…ˆçº§è®¾ç½®


### 6.1 ä¼˜å…ˆçº§æœºåˆ¶è¯¦è§£


**ä¼˜å…ˆçº§å·¥ä½œåŸç†**ï¼š
```
é«˜ä¼˜å…ˆçº§æ•°æ®åŒ…å¤„ç†æµç¨‹ï¼š
æ•°æ®åŒ…åˆ°è¾¾ â†’ æ£€æŸ¥ä¼˜å…ˆçº§æ ‡è®° â†’ é«˜ä¼˜å…ˆçº§ï¼Ÿ
    â†“ æ˜¯                     â†“ å¦
  ç«‹å³å¤„ç†              åŠ å…¥æ™®é€šé˜Ÿåˆ—ç­‰å¾…

å®é™…æ•ˆæœï¼š
âš¡ é«˜ä¼˜å…ˆçº§ï¼šå»¶è¿Ÿ < 10ms
ğŸ“Š ä¸­ä¼˜å…ˆçº§ï¼šå»¶è¿Ÿ 10-50ms  
ğŸ“ ä½ä¼˜å…ˆçº§ï¼šå»¶è¿Ÿ > 50ms
```

### 6.2 åŸºäºåº”ç”¨çš„ä¼˜å…ˆçº§è®¾ç½®


**ğŸ® å®æˆ˜ï¼šæ¸¸æˆæœåŠ¡å™¨ä¼˜å…ˆçº§é…ç½®**

```bash
#!/bin/bash
# æ¸¸æˆæœåŠ¡å™¨ç½‘ç»œä¼˜å…ˆçº§é…ç½®

GAME_PORT=7777        # æ¸¸æˆæœåŠ¡ç«¯å£
INTERFACE="eth0"

# é…ç½®æ¸¸æˆæµé‡æœ€é«˜ä¼˜å…ˆçº§
echo "é…ç½®æ¸¸æˆæœåŠ¡å™¨ç½‘ç»œä¼˜å…ˆçº§..."

# 1. åˆ›å»ºä¸“é—¨çš„æ¸¸æˆæµé‡åˆ†ç±»
sudo tc class add dev $INTERFACE parent 1:1 classid 1:5 \
    htb rate 100mbit ceil 200mbit prio 0

# 2. æ¸¸æˆç«¯å£æµé‡è¿‡æ»¤
sudo tc filter add dev $INTERFACE parent 1: protocol ip prio 1 \
    u32 match ip sport $GAME_PORT 0xffff flowid 1:5

sudo tc filter add dev $INTERFACE parent 1: protocol ip prio 1 \
    u32 match ip dport $GAME_PORT 0xffff flowid 1:5

# 3. è®¾ç½®æœ€ä½å»¶è¿Ÿé˜Ÿåˆ—
sudo tc qdisc add dev $INTERFACE parent 1:5 handle 50: pfifo limit 10

echo "æ¸¸æˆæµé‡å·²è®¾ç½®ä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼"
```

### 6.3 åŠ¨æ€ä¼˜å…ˆçº§è°ƒæ•´


**ğŸ“ˆ æ™ºèƒ½ä¼˜å…ˆçº§è„šæœ¬**

```bash
#!/bin/bash
# æ™ºèƒ½ç½‘ç»œä¼˜å…ˆçº§è°ƒæ•´è„šæœ¬

# æ£€æµ‹ç½‘ç»œæ‹¥å µæƒ…å†µ
check_network_congestion() {
    local ping_avg=$(ping -c 5 8.8.8.8 | tail -1 | cut -d'/' -f5)
    local congestion_level
    
    if (( $(echo "$ping_avg > 100" | bc -l) )); then
        congestion_level="high"
    elif (( $(echo "$ping_avg > 50" | bc -l) )); then
        congestion_level="medium"  
    else
        congestion_level="low"
    fi
    
    echo $congestion_level
}

# æ ¹æ®æ‹¥å µæƒ…å†µè°ƒæ•´ä¼˜å…ˆçº§
adjust_priority() {
    local congestion=$(check_network_congestion)
    
    case $congestion in
        "high")
            echo "ç½‘ç»œæ‹¥å µä¸¥é‡ï¼Œæé«˜å…³é”®æœåŠ¡ä¼˜å…ˆçº§"
            # å¢åŠ å…³é”®æœåŠ¡å¸¦å®½ï¼Œå‡å°‘å…¶ä»–æœåŠ¡
            sudo tc class change dev eth0 classid 1:10 htb rate 70mbit ceil 90mbit
            sudo tc class change dev eth0 classid 1:30 htb rate 10mbit ceil 20mbit
            ;;
        "medium")
            echo "ç½‘ç»œæ‹¥å µé€‚ä¸­ï¼Œå¹³è¡¡åˆ†é…å¸¦å®½"
            sudo tc class change dev eth0 classid 1:10 htb rate 50mbit ceil 80mbit
            sudo tc class change dev eth0 classid 1:30 htb rate 20mbit ceil 30mbit
            ;;
        "low")
            echo "ç½‘ç»œçŠ¶å†µè‰¯å¥½ï¼Œæ¢å¤æ­£å¸¸åˆ†é…"
            sudo tc class change dev eth0 classid 1:10 htb rate 40mbit ceil 70mbit
            sudo tc class change dev eth0 classid 1:30 htb rate 30mbit ceil 50mbit
            ;;
    esac
}

# æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
while true; do
    adjust_priority
    sleep 60
done
```

---

## 7. ğŸ“ˆ ç½‘ç»œä½¿ç”¨ç»Ÿè®¡


### 7.1 å®æ—¶æµé‡ç›‘æ§


**ğŸ” æŸ¥çœ‹å½“å‰ç½‘ç»œä½¿ç”¨æƒ…å†µ**

```bash
# æŸ¥çœ‹TCç»Ÿè®¡ä¿¡æ¯
sudo tc -s class show dev eth0

# è¾“å‡ºè§£é‡Šï¼š
# class htb 1:10 parent 1:1 prio 1 rate 50Mbit ceil 80Mbit burst 1600b cburst 1600b
# Sent 1048576 bytes 1024 pkt (dropped 0, overlimits 0 requeues 0)
# rate 25Mbit 3125pps backlog 0b 0p requeues 0
#
# å…³é”®ä¿¡æ¯ï¼š
# Sent: å·²å‘é€çš„å­—èŠ‚æ•°å’Œæ•°æ®åŒ…æ•°
# rate: å½“å‰ä¼ è¾“é€Ÿç‡  
# dropped: ä¸¢å¼ƒçš„åŒ…æ•°é‡
# overlimits: è¶…è¿‡é™åˆ¶çš„æ¬¡æ•°
```

**ğŸ“Š è¯¦ç»†ç»Ÿè®¡è„šæœ¬**

```bash
#!/bin/bash
# ç½‘ç»œä½¿ç”¨ç»Ÿè®¡è„šæœ¬

INTERFACE="eth0"
LOG_FILE="/var/log/network_stats.log"

# è®°å½•ç½‘ç»œç»Ÿè®¡ä¿¡æ¯
log_network_stats() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    echo "=== $timestamp ===" >> $LOG_FILE
    
    # TCç±»åˆ«ç»Ÿè®¡
    sudo tc -s class show dev $INTERFACE | while read line; do
        if [[ $line =~ class.* ]]; then
            echo "$line" >> $LOG_FILE
        elif [[ $line =~ Sent.* ]]; then
            echo "  $line" >> $LOG_FILE
        elif [[ $line =~ rate.* ]]; then
            echo "  $line" >> $LOG_FILE
        fi
    done
    
    echo "" >> $LOG_FILE
}

# ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
generate_report() {
    echo "ç½‘ç»œä½¿ç”¨ç»Ÿè®¡æŠ¥å‘Š"
    echo "=================="
    
    # é«˜ä¼˜å…ˆçº§æµé‡ç»Ÿè®¡
    local high_prio_bytes=$(sudo tc -s class show dev $INTERFACE | \
        grep -A 1 "class htb 1:10" | grep "Sent" | \
        awk '{print $2}')
    
    # è½¬æ¢ä¸ºMB
    local high_prio_mb=$((high_prio_bytes / 1024 / 1024))
    
    echo "é«˜ä¼˜å…ˆçº§æµé‡: ${high_prio_mb} MB"
    
    # ç±»ä¼¼åœ°ç»Ÿè®¡å…¶ä»–ä¼˜å…ˆçº§...
}

# ä¸»å¾ªç¯ï¼šæ¯30ç§’è®°å½•ä¸€æ¬¡
while true; do
    log_network_stats
    sleep 30
done &

# æ¯å°æ—¶ç”Ÿæˆä¸€æ¬¡æŠ¥å‘Š  
while true; do
    generate_report
    sleep 3600
done
```

### 7.2 å¸¦å®½ä½¿ç”¨åˆ†æ


**ğŸ“Š å¯è§†åŒ–å¸¦å®½ä½¿ç”¨**

```bash
#!/bin/bash
# å¸¦å®½ä½¿ç”¨å¯è§†åŒ–è„šæœ¬

# åˆ›å»ºç®€å•çš„æ–‡æœ¬å›¾è¡¨
create_bandwidth_chart() {
    local interface=$1
    
    # è·å–å„ç±»åˆ«çš„å®æ—¶é€Ÿç‡
    local high_rate=$(sudo tc -s class show dev $interface | \
        grep -A 2 "class htb 1:10" | grep "rate" | \
        awk '{print $2}' | sed 's/[^0-9]//g')
        
    local normal_rate=$(sudo tc -s class show dev $interface | \
        grep -A 2 "class htb 1:20" | grep "rate" | \
        awk '{print $2}' | sed 's/[^0-9]//g')
        
    local low_rate=$(sudo tc -s class show dev $interface | \
        grep -A 2 "class htb 1:30" | grep "rate" | \
        awk '{print $2}' | sed 's/[^0-9]//g')
    
    # è®¡ç®—ç™¾åˆ†æ¯”å¹¶ç”Ÿæˆå›¾è¡¨
    local total=$((high_rate + normal_rate + low_rate))
    
    if [ $total -gt 0 ]; then
        local high_percent=$((high_rate * 100 / total))
        local normal_percent=$((normal_rate * 100 / total))
        local low_percent=$((low_rate * 100 / total))
        
        echo "å®æ—¶å¸¦å®½ä½¿ç”¨åˆ†å¸ƒï¼š"
        echo "é«˜ä¼˜å…ˆçº§: $(printf '%*s' $((high_percent/2)) '' | tr ' ' 'â–ˆ') ${high_percent}%"
        echo "æ™®é€šæµé‡: $(printf '%*s' $((normal_percent/2)) '' | tr ' ' 'â–“') ${normal_percent}%"
        echo "ä½ä¼˜å…ˆçº§: $(printf '%*s' $((low_percent/2)) '' | tr ' ' 'â–‘') ${low_percent}%"
    fi
}

# æ¯5ç§’æ›´æ–°ä¸€æ¬¡æ˜¾ç¤º
while true; do
    clear
    echo "ç½‘ç»œå¸¦å®½å®æ—¶ç›‘æ§ - $(date)"
    echo "=================================="
    create_bandwidth_chart eth0
    echo ""
    echo "è¯¦ç»†ç»Ÿè®¡ï¼š"
    sudo tc -s class show dev eth0 | grep -E "(class htb|Sent|rate)" | \
        sed 's/^/  /'
    sleep 5
done
```

---

## 8. ğŸ”’ ç½‘ç»œèµ„æºéš”ç¦»


### 8.1 ç½‘ç»œå‘½åç©ºé—´éš”ç¦»


**ä»€ä¹ˆæ˜¯ç½‘ç»œéš”ç¦»**ï¼šå°±åƒç»™ä¸åŒçš„éƒ¨é—¨åˆ†é…ç‹¬ç«‹çš„ç½‘ç»œç¯å¢ƒï¼Œäº’ç›¸ä¸å¹²æ‰°ã€‚

```
ç½‘ç»œéš”ç¦»ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç‰©ç†ä¸»æœº                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å®¹å™¨A      â”‚    å®¹å™¨B     â”‚    å®¹å™¨C    â”‚
â”‚  10.1.1.2   â”‚   10.1.2.2  â”‚  10.1.3.2   â”‚
â”‚  ç‹¬ç«‹ç½‘ç»œ   â”‚   ç‹¬ç«‹ç½‘ç»œ   â”‚   ç‹¬ç«‹ç½‘ç»œ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 å®ç°ç½‘ç»œéš”ç¦»


**ğŸ› ï¸ åˆ›å»ºéš”ç¦»çš„ç½‘ç»œç¯å¢ƒ**

```bash
#!/bin/bash
# ç½‘ç»œéš”ç¦»é…ç½®è„šæœ¬

# åˆ›å»ºç½‘ç»œå‘½åç©ºé—´
create_isolated_network() {
    local ns_name=$1
    local subnet=$2
    
    echo "åˆ›å»ºéš”ç¦»ç½‘ç»œç¯å¢ƒ: $ns_name"
    
    # 1. åˆ›å»ºç½‘ç»œå‘½åç©ºé—´
    sudo ip netns add $ns_name
    
    # 2. åˆ›å»ºvethè®¾å¤‡å¯¹
    sudo ip link add veth-$ns_name type veth peer name veth-$ns_name-br
    
    # 3. å°†ä¸€ç«¯ç§»åˆ°å‘½åç©ºé—´
    sudo ip link set veth-$ns_name netns $ns_name
    
    # 4. é…ç½®å‘½åç©ºé—´å†…çš„ç½‘ç»œ
    sudo ip netns exec $ns_name ip addr add $subnet dev veth-$ns_name
    sudo ip netns exec $ns_name ip link set veth-$ns_name up
    sudo ip netns exec $ns_name ip link set lo up
    
    # 5. é…ç½®ä¸»æœºç«¯
    sudo ip link set veth-$ns_name-br up
    
    echo "ç½‘ç»œå‘½åç©ºé—´ $ns_name åˆ›å»ºå®Œæˆ"
}

# ä½¿ç”¨ç¤ºä¾‹
create_isolated_network "app1" "192.168.100.10/24"
create_isolated_network "app2" "192.168.100.20/24" 
create_isolated_network "app3" "192.168.100.30/24"

# ä¸ºæ¯ä¸ªéš”ç¦»ç¯å¢ƒé…ç½®ç‹¬ç«‹çš„æµé‡æ§åˆ¶
setup_isolated_tc() {
    local ns_name=$1
    local bandwidth=$2
    
    # åœ¨å‘½åç©ºé—´å†…é…ç½®TC
    sudo ip netns exec $ns_name tc qdisc add dev veth-$ns_name root handle 1: htb
    sudo ip netns exec $ns_name tc class add dev veth-$ns_name parent 1: \
        classid 1:1 htb rate $bandwidth
}

setup_isolated_tc "app1" "100mbit"
setup_isolated_tc "app2" "50mbit"
setup_isolated_tc "app3" "25mbit"
```

### 8.3 å®¹å™¨ç½‘ç»œèµ„æºæ§åˆ¶


**ğŸ³ Dockerå®¹å™¨ç½‘ç»œé™åˆ¶**

```bash
#!/bin/bash
# Dockerå®¹å™¨ç½‘ç»œèµ„æºæ§åˆ¶

# å¯åŠ¨å¸¦ç½‘ç»œé™åˆ¶çš„å®¹å™¨
start_limited_container() {
    local container_name=$1
    local cpu_limit=$2
    local bandwidth_limit=$3
    
    echo "å¯åŠ¨ç½‘ç»œé™åˆ¶å®¹å™¨: $container_name"
    
    # å¯åŠ¨å®¹å™¨
    docker run -d --name $container_name \
        --cpus=$cpu_limit \
        nginx:alpine
    
    # è·å–å®¹å™¨çš„ç½‘ç»œæ¥å£
    local container_pid=$(docker inspect -f '{{.State.Pid}}' $container_name)
    local container_netns="/proc/$container_pid/ns/net"
    
    # è¿›å…¥å®¹å™¨ç½‘ç»œå‘½åç©ºé—´é…ç½®TC
    sudo nsenter -t $container_pid -n tc qdisc add dev eth0 root handle 1: htb
    sudo nsenter -t $container_pid -n tc class add dev eth0 parent 1: \
        classid 1:1 htb rate $bandwidth_limit ceil $bandwidth_limit
    
    echo "å®¹å™¨ $container_name ç½‘ç»œé™åˆ¶å·²é…ç½®: $bandwidth_limit"
}

# ä½¿ç”¨ç¤ºä¾‹
start_limited_container "web-server" "1.0" "100mbit"
start_limited_container "api-server" "0.5" "50mbit"
start_limited_container "background-task" "0.2" "10mbit"
```

---

## 9. ğŸ“Š ç½‘ç»œæ€§èƒ½ç›‘æ§


### 9.1 å®æ—¶æ€§èƒ½ç›‘æ§


**ğŸ” comprehensiveç½‘ç»œç›‘æ§è„šæœ¬**

```bash
#!/bin/bash
# ç»¼åˆç½‘ç»œæ€§èƒ½ç›‘æ§ç³»ç»Ÿ

INTERFACE="eth0"
MONITOR_LOG="/var/log/network_monitor.log"

# ç½‘ç»œæ€§èƒ½æŒ‡æ ‡æ”¶é›†
collect_network_metrics() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # 1. åŸºç¡€ç½‘ç»œç»Ÿè®¡
    local rx_bytes=$(cat /sys/class/net/$INTERFACE/statistics/rx_bytes)
    local tx_bytes=$(cat /sys/class/net/$INTERFACE/statistics/tx_bytes)
    local rx_packets=$(cat /sys/class/net/$INTERFACE/statistics/rx_packets)
    local tx_packets=$(cat /sys/class/net/$INTERFACE/statistics/tx_packets)
    
    # 2. é”™è¯¯ç»Ÿè®¡
    local rx_errors=$(cat /sys/class/net/$INTERFACE/statistics/rx_errors)
    local tx_errors=$(cat /sys/class/net/$INTERFACE/statistics/tx_errors)
    local rx_dropped=$(cat /sys/class/net/$INTERFACE/statistics/rx_dropped)
    local tx_dropped=$(cat /sys/class/net/$INTERFACE/statistics/tx_dropped)
    
    # 3. TCç»Ÿè®¡ä¿¡æ¯
    local tc_stats=$(sudo tc -s class show dev $INTERFACE | grep -E "(class htb|Sent|rate)")
    
    # 4. ç½‘ç»œå»¶è¿Ÿæµ‹è¯•
    local ping_latency=$(ping -c 1 -W 1 8.8.8.8 2>/dev/null | \
        grep 'time=' | cut -d'=' -f4 | cut -d' ' -f1)
    
    # è®°å½•åˆ°æ—¥å¿—
    {
        echo "[$timestamp] Network Metrics:"
        echo "  RX: $rx_bytes bytes, $rx_packets packets"
        echo "  TX: $tx_bytes bytes, $tx_packets packets"  
        echo "  Errors: RX=$rx_errors, TX=$tx_errors"
        echo "  Dropped: RX=$rx_dropped, TX=$tx_dropped"
        echo "  Latency: ${ping_latency:-N/A} ms"
        echo "  TC Stats:"
        echo "$tc_stats" | sed 's/^/    /'
        echo "---"
    } >> $MONITOR_LOG
}

# æ€§èƒ½æŠ¥è­¦æ£€æŸ¥
check_network_alerts() {
    local error_threshold=100
    local latency_threshold=100
    
    local current_errors=$(cat /sys/class/net/$INTERFACE/statistics/rx_errors)
    local current_latency=$(ping -c 1 -W 1 8.8.8.8 2>/dev/null | \
        grep 'time=' | cut -d'=' -f4 | cut -d' ' -f1)
    
    # æ£€æŸ¥é”™è¯¯ç‡
    if [ $current_errors -gt $error_threshold ]; then
        echo "âš ï¸  è­¦å‘Š: ç½‘ç»œé”™è¯¯ç‡è¿‡é«˜ ($current_errors errors)"
        # è¿™é‡Œå¯ä»¥å‘é€é‚®ä»¶æˆ–å…¶ä»–é€šçŸ¥
    fi
    
    # æ£€æŸ¥å»¶è¿Ÿ
    if [ ! -z "$current_latency" ] && \
       (( $(echo "$current_latency > $latency_threshold" | bc -l) )); then
        echo "âš ï¸  è­¦å‘Š: ç½‘ç»œå»¶è¿Ÿè¿‡é«˜ (${current_latency}ms)"
    fi
}

# ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
generate_performance_report() {
    echo "ç½‘ç»œæ€§èƒ½æŠ¥å‘Š - $(date)"
    echo "=========================="
    
    # ç»Ÿè®¡è¿‡å»24å°æ—¶çš„æ•°æ®
    local report_file="/tmp/network_report_$(date +%Y%m%d).txt"
    
    {
        echo "è¿‡å»24å°æ—¶ç½‘ç»œæ€§èƒ½ç»Ÿè®¡:"
        echo ""
        
        # æµé‡ç»Ÿè®¡
        echo "1. æµé‡ä½¿ç”¨æƒ…å†µ:"
        tail -n 2880 $MONITOR_LOG | grep "RX:" | tail -1
        tail -n 2880 $MONITOR_LOG | grep "TX:" | tail -1
        
        # é”™è¯¯ç»Ÿè®¡  
        echo ""
        echo "2. é”™è¯¯ç»Ÿè®¡:"
        tail -n 2880 $MONITOR_LOG | grep "Errors:" | tail -1
        tail -n 2880 $MONITOR_LOG | grep "Dropped:" | tail -1
        
        # å¹³å‡å»¶è¿Ÿ
        echo ""
        echo "3. ç½‘ç»œå»¶è¿Ÿ:"
        local avg_latency=$(tail -n 2880 $MONITOR_LOG | \
            grep "Latency:" | grep -v "N/A" | \
            awk '{print $2}' | awk '{sum+=$1; count++} END {print sum/count}')
        echo "  å¹³å‡å»¶è¿Ÿ: ${avg_latency:-N/A} ms"
        
    } > $report_file
    
    cat $report_file
}

# ä¸»ç›‘æ§å¾ªç¯
main_monitor() {
    echo "å¯åŠ¨ç½‘ç»œæ€§èƒ½ç›‘æ§ç³»ç»Ÿ..."
    
    while true; do
        collect_network_metrics
        check_network_alerts
        sleep 30
    done &
    
    # æ¯å°æ—¶ç”Ÿæˆä¸€æ¬¡æŠ¥å‘Š
    while true; do
        sleep 3600
        generate_performance_report > /tmp/hourly_network_report.txt
    done
}

# å¯åŠ¨ç›‘æ§
main_monitor
```

### 9.2 ç›‘æ§æ•°æ®å¯è§†åŒ–


**ğŸ“Š ç®€å•çš„å®æ—¶ç›‘æ§é¢æ¿**

```bash
#!/bin/bash
# å®æ—¶ç½‘ç»œç›‘æ§é¢æ¿

# æ˜¾ç¤ºå®æ—¶ç½‘ç»œçŠ¶æ€
show_realtime_dashboard() {
    while true; do
        clear
        
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘              ç½‘ç»œèµ„æºå®æ—¶ç›‘æ§é¢æ¿                      â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“Š å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        # ç½‘ç»œæ¥å£çŠ¶æ€
        echo "ğŸŒ ç½‘ç»œæ¥å£çŠ¶æ€:"
        local interface_up=$(ip link show eth0 | grep "state UP" | wc -l)
        if [ $interface_up -eq 1 ]; then
            echo "   eth0: âœ… UP"
        else
            echo "   eth0: âŒ DOWN"
        fi
        echo ""
        
        # TCç±»åˆ«çŠ¶æ€  
        echo "ğŸš¦ æµé‡æ§åˆ¶çŠ¶æ€:"
        sudo tc -s class show dev eth0 2>/dev/null | \
        grep -E "(class htb|rate)" | \
        while read line; do
            if [[ $line =~ class.*htb.*1:10.* ]]; then
                echo -n "   é«˜ä¼˜å…ˆçº§: "
            elif [[ $line =~ class.*htb.*1:20.* ]]; then
                echo -n "   ä¸­ä¼˜å…ˆçº§: "  
            elif [[ $line =~ class.*htb.*1:30.* ]]; then
                echo -n "   ä½ä¼˜å…ˆçº§: "
            elif [[ $line =~ rate.* ]]; then
                local current_rate=$(echo $line | awk '{print $2}')
                echo "å½“å‰é€Ÿç‡ $current_rate"
            fi
        done
        echo ""
        
        # ç½‘ç»œå»¶è¿Ÿ
        echo "âš¡ ç½‘ç»œå»¶è¿Ÿ:"
        local ping_result=$(ping -c 1 -W 2 8.8.8.8 2>/dev/null | grep 'time=')
        if [ ! -z "$ping_result" ]; then
            local latency=$(echo $ping_result | cut -d'=' -f4 | cut -d' ' -f1)
            echo "   åˆ° 8.8.8.8: ${latency} ms"
        else
            echo "   åˆ° 8.8.8.8: âŒ è¶…æ—¶"
        fi
        echo ""
        
        # cgroupè¿›ç¨‹ç»Ÿè®¡
        echo "ğŸ‘¥ åˆ†ç»„è¿›ç¨‹ç»Ÿè®¡:"
        local high_procs=$(cat /sys/fs/cgroup/net_cls/high_priority/cgroup.procs 2>/dev/null | wc -l)
        local normal_procs=$(cat /sys/fs/cgroup/net_cls/normal_priority/cgroup.procs 2>/dev/null | wc -l)
        local low_procs=$(cat /sys/fs/cgroup/net_cls/low_priority/cgroup.procs 2>/dev/null | wc -l)
        
        echo "   é«˜ä¼˜å…ˆçº§ç»„: $high_procs ä¸ªè¿›ç¨‹"
        echo "   æ™®é€šä¼˜å…ˆçº§ç»„: $normal_procs ä¸ªè¿›ç¨‹"  
        echo "   ä½ä¼˜å…ˆçº§ç»„: $low_procs ä¸ªè¿›ç¨‹"
        echo ""
        
        echo "æŒ‰ Ctrl+C é€€å‡ºç›‘æ§"
        sleep 2
    done
}

# å¯åŠ¨å®æ—¶é¢æ¿
show_realtime_dashboard
```

---

## 10. ğŸ¯ å®æˆ˜æ¡ˆä¾‹ä¸æœ€ä½³å®è·µ


### 10.1 WebæœåŠ¡å™¨ç½‘ç»œä¼˜åŒ–


**ğŸŒ å®é™…æ¡ˆä¾‹ï¼šé«˜å¹¶å‘WebæœåŠ¡å™¨**

```bash
#!/bin/bash
# WebæœåŠ¡å™¨ç½‘ç»œä¼˜åŒ–é…ç½®

INTERFACE="eth0" 
WEB_PORT=80
HTTPS_PORT=443

echo "é…ç½®WebæœåŠ¡å™¨ç½‘ç»œä¼˜åŒ–..."

# 1. æ¸…é™¤ç°æœ‰é…ç½®
sudo tc qdisc del dev $INTERFACE root 2>/dev/null

# 2. åŸºç¡€é˜Ÿåˆ—é…ç½®
sudo tc qdisc add dev $INTERFACE root handle 1: htb default 50

# 3. æ€»å¸¦å®½åˆ†é… (å‡è®¾1Gbpsè¿æ¥)
sudo tc class add dev $INTERFACE parent 1: classid 1:1 htb rate 1000mbit

# 4. WebæœåŠ¡å™¨æµé‡ä¼˜åŒ–åˆ†ç±»

# Webå“åº”æµé‡ - æœ€é«˜ä¼˜å…ˆçº§ (40%)
sudo tc class add dev $INTERFACE parent 1:1 classid 1:10 \
    htb rate 400mbit ceil 800mbit prio 1

# APIæ¥å£æµé‡ - é«˜ä¼˜å…ˆçº§ (30%)  
sudo tc class add dev $INTERFACE parent 1:1 classid 1:20 \
    htb rate 300mbit ceil 600mbit prio 2

# é™æ€èµ„æºæµé‡ - ä¸­ä¼˜å…ˆçº§ (20%)
sudo tc class add dev $INTERFACE parent 1:1 classid 1:30 \
    htb rate 200mbit ceil 400mbit prio 3

# ç®¡ç†/ç›‘æ§æµé‡ - ä¿è¯å¸¦å®½ (5%)
sudo tc class add dev $INTERFACE parent 1:1 classid 1:40 \
    htb rate 50mbit ceil 100mbit prio 4

# å…¶ä»–æµé‡ - é»˜è®¤ (5%)
sudo tc class add dev $INTERFACE parent 1:1 classid 1:50 \
    htb rate 50mbit ceil 200mbit prio 5

# 5. é…ç½®è¿‡æ»¤å™¨è§„åˆ™

# HTTP/HTTPSæµé‡åˆ°WebæœåŠ¡ç±»åˆ«
sudo tc filter add dev $INTERFACE parent 1: protocol ip prio 1 \
    u32 match ip sport $WEB_PORT 0xffff flowid 1:10

sudo tc filter add dev $INTERFACE parent 1: protocol ip prio 1 \
    u32 match ip sport $HTTPS_PORT 0xffff flowid 1:10

# APIç«¯å£æµé‡ (å‡è®¾8080)
sudo tc filter add dev $INTERFACE parent 1: protocol ip prio 2 \
    u32 match ip sport 8080 0xffff flowid 1:20

# å›¾ç‰‡/è§†é¢‘ç­‰é™æ€èµ„æº (é€šè¿‡ToSæ ‡è®°)
sudo tc filter add dev $INTERFACE parent 1: protocol ip prio 3 \
    u32 match ip tos 0x10 0xff flowid 1:30

# SSHç®¡ç†æµé‡
sudo tc filter add dev $INTERFACE parent 1: protocol ip prio 4 \
    u32 match ip sport 22 0xffff flowid 1:40

# 6. é…ç½®SFQå…¬å¹³é˜Ÿåˆ—é˜²æ­¢å•ä¸ªè¿æ¥å ç”¨è¿‡å¤šèµ„æº
sudo tc qdisc add dev $INTERFACE parent 1:10 handle 10: sfq perturb 10
sudo tc qdisc add dev $INTERFACE parent 1:20 handle 20: sfq perturb 10
sudo tc qdisc add dev $INTERFACE parent 1:30 handle 30: sfq perturb 10

echo "WebæœåŠ¡å™¨ç½‘ç»œä¼˜åŒ–é…ç½®å®Œæˆï¼"

# 7. éªŒè¯é…ç½®
echo "å½“å‰é…ç½®éªŒè¯ï¼š"
sudo tc qdisc show dev $INTERFACE
sudo tc class show dev $INTERFACE
```

### 10.2 æ•°æ®åº“æœåŠ¡å™¨ç½‘ç»œè°ƒä¼˜


**ğŸ—„ï¸ æ•°æ®åº“ä¸“ç”¨ç½‘ç»œé…ç½®**

```bash
#!/bin/bash
# æ•°æ®åº“æœåŠ¡å™¨ç½‘ç»œè°ƒä¼˜

DB_PORT=3306        # MySQLç«¯å£
REDIS_PORT=6379     # Redisç«¯å£  
INTERFACE="eth0"

echo "é…ç½®æ•°æ®åº“æœåŠ¡å™¨ç½‘ç»œè°ƒä¼˜..."

# æ•°æ®åº“æœåŠ¡å™¨ç‰¹æ®Šéœ€æ±‚ï¼š
# - ä½å»¶è¿Ÿ (æŸ¥è¯¢å“åº”)
# - ç¨³å®šå¸¦å®½ (å¤§æ•°æ®ä¼ è¾“)  
# - ä¼˜å…ˆçº§ä¿è¯ (é‡è¦ä¸šåŠ¡)

# 1. ä½¿ç”¨PRIOé˜Ÿåˆ—å‡å°‘å»¶è¿Ÿ
sudo tc qdisc add dev $INTERFACE root handle 1: prio bands 4 priomap 3 3 3 3 2 1 0 0

# 2. ä¸ºæ¯ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—é…ç½®HTBé™åˆ¶

# æœ€é«˜ä¼˜å…ˆçº§ï¼šæ•°æ®åº“æŸ¥è¯¢å“åº”
sudo tc qdisc add dev $INTERFACE parent 1:1 handle 10: htb default 1
sudo tc class add dev $INTERFACE parent 10: classid 10:1 htb rate 500mbit ceil 800mbit

# é«˜ä¼˜å…ˆçº§ï¼šç¼“å­˜æœåŠ¡
sudo tc qdisc add dev $INTERFACE parent 1:2 handle 20: htb default 1  
sudo tc class add dev $INTERFACE parent 20: classid 20:1 htb rate 300mbit ceil 500mbit

# ä¸­ä¼˜å…ˆçº§ï¼šæ•°æ®åŒæ­¥
sudo tc qdisc add dev $INTERFACE parent 1:3 handle 30: htb default 1
sudo tc class add dev $INTERFACE parent 30: classid 30:1 htb rate 200mbit ceil 400mbit

# ä½ä¼˜å…ˆçº§ï¼šå¤‡ä»½ç­‰åå°ä»»åŠ¡
sudo tc qdisc add dev $INTERFACE parent 1:4 handle 40: htb default 1
sudo tc class add dev $INTERFACE parent 40: classid 40:1 htb rate 100mbit ceil 200mbit

# 3. é…ç½®æ•°æ®åº“ç«¯å£è¿‡æ»¤
sudo tc filter add dev $INTERFACE parent 1: protocol ip prio 1 \
    u32 match ip sport $DB_PORT 0xffff flowid 1:1

sudo tc filter add dev $INTERFACE parent 1: protocol ip prio 1 \
    u32 match ip dport $DB_PORT 0xffff flowid 1:1

# Redisç¼“å­˜æµé‡    
sudo tc filter add dev $INTERFACE parent 1: protocol ip prio 2 \
    u32 match ip sport $REDIS_PORT 0xffff flowid 1:2

# 4. é’ˆå¯¹æ•°æ®åº“çš„ç‰¹æ®Šä¼˜åŒ–
# å‡å°‘TCPç¼“å†²åŒºå»¶è¿Ÿ
echo 'net.core.rmem_default = 262144' >> /etc/sysctl.conf
echo 'net.core.rmem_max = 16777216' >> /etc/sysctl.conf
echo 'net.core.wmem_default = 262144' >> /etc/sysctl.conf  
echo 'net.core.wmem_max = 16777216' >> /etc/sysctl.conf

sysctl -p

echo "æ•°æ®åº“ç½‘ç»œè°ƒä¼˜å®Œæˆï¼"
```

### 10.3 å®¹å™¨åŒ–ç¯å¢ƒç½‘ç»œç®¡ç†


**ğŸ³ Docker Swarmç½‘ç»œèµ„æºç®¡ç†**

```bash
#!/bin/bash
# Docker Swarmç¯å¢ƒç½‘ç»œèµ„æºç®¡ç†

# åˆ›å»ºå…·æœ‰ç½‘ç»œé™åˆ¶çš„DockeræœåŠ¡
create_limited_service() {
    local service_name=$1
    local replicas=$2
    local cpu_limit=$3
    local memory_limit=$4
    local bandwidth_limit=$5
    
    echo "åˆ›å»ºç½‘ç»œé™åˆ¶æœåŠ¡: $service_name"
    
    # åˆ›å»ºæœåŠ¡
    docker service create \
        --name $service_name \
        --replicas $replicas \
        --limit-cpu $cpu_limit \
        --limit-memory $memory_limit \
        --network overlay-net \
        nginx:alpine
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 10
    
    # ä¸ºæ‰€æœ‰å‰¯æœ¬é…ç½®ç½‘ç»œé™åˆ¶
    local containers=$(docker service ps $service_name --format "{{.ID}}")
    
    for container_id in $containers; do
        local task_info=$(docker service ps $service_name --filter "id=$container_id" --format "{{.Node}} {{.Name}}")
        local node_name=$(echo $task_info | awk '{print $1}')
        local task_name=$(echo $task_info | awk '{print $2}')
        
        # åœ¨å¯¹åº”èŠ‚ç‚¹ä¸Šé…ç½®ç½‘ç»œé™åˆ¶
        if [ "$node_name" = "$(hostname)" ]; then
            local container_name=$(docker ps --filter "name=$task_name" --format "{{.Names}}")
            local container_pid=$(docker inspect -f '{{.State.Pid}}' $container_name)
            
            if [ ! -z "$container_pid" ]; then
                # é…ç½®å®¹å™¨ç½‘ç»œé™åˆ¶
                sudo nsenter -t $container_pid -n tc qdisc add dev eth0 root handle 1: htb
                sudo nsenter -t $container_pid -n tc class add dev eth0 parent 1: \
                    classid 1:1 htb rate $bandwidth_limit ceil $bandwidth_limit
                    
                echo "å®¹å™¨ $container_name ç½‘ç»œé™åˆ¶å·²é…ç½®"
            fi
        fi
    done
}

# ä½¿ç”¨ç¤ºä¾‹
create_limited_service "web-frontend" 3 "1.0" "512m" "100mbit"
create_limited_service "api-backend" 2 "2.0" "1g" "200mbit"  
create_limited_service "worker-service" 5 "0.5" "256m" "50mbit"

# åˆ›å»ºç½‘ç»œç›‘æ§æœåŠ¡
create_network_monitor() {
    cat > /tmp/network-monitor.yml << EOF
version: '3.8'
services:
  network-monitor:
    image: prom/node-exporter
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($|/)'
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
EOF

    docker stack deploy -c /tmp/network-monitor.yml monitoring
}

create_network_monitor

echo "å®¹å™¨åŒ–ç½‘ç»œç®¡ç†é…ç½®å®Œæˆï¼"
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ ç½‘ç»œèµ„æºæ§åˆ¶æœ¬è´¨ï¼šç®¡ç†å’Œåˆ†é…ç½‘ç»œå¸¦å®½ï¼Œä¿è¯æœåŠ¡è´¨é‡
ğŸ”¸ net_clsä½œç”¨ï¼šç»™è¿›ç¨‹ç½‘ç»œæµé‡è´´æ ‡ç­¾ï¼Œä¾¿äºåˆ†ç±»ç®¡ç†
ğŸ”¸ TCæ ¸å¿ƒåŠŸèƒ½ï¼šæ ¹æ®æ ‡ç­¾å¯¹æµé‡è¿›è¡Œé™é€Ÿã€ä¼˜å…ˆçº§å¤„ç†
ğŸ”¸ QoSç›®æ ‡ï¼šä¿è¯å…³é”®æœåŠ¡ç½‘ç»œè´¨é‡ï¼Œé˜²æ­¢èµ„æºæŠ¢å 
ğŸ”¸ ç½‘ç»œéš”ç¦»ï¼šé€šè¿‡å‘½åç©ºé—´å®ç°ä¸åŒåº”ç”¨çš„ç½‘ç»œéš”ç¦»
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦ç½‘ç»œèµ„æºæ§åˆ¶**
```
ç°å®é—®é¢˜ï¼š
- ä¸‹è½½è½¯ä»¶å ç”¨å¤§é‡å¸¦å®½å½±å“ä¸šåŠ¡
- æŸä¸ªæœåŠ¡å¼‚å¸¸å¯¼è‡´ç½‘ç»œæ‹¥å µ
- é‡è¦æœåŠ¡å¾—ä¸åˆ°è¶³å¤Ÿç½‘ç»œèµ„æº
- ç”¨æˆ·ä½“éªŒå› ç½‘ç»œé—®é¢˜ä¸‹é™

æ§åˆ¶æ•ˆæœï¼š
- ä¿è¯å…³é”®ä¸šåŠ¡ä¼˜å…ˆä¼ è¾“
- é™åˆ¶åå°ä»»åŠ¡å¸¦å®½ä½¿ç”¨  
- æä¾›å¯é¢„æµ‹çš„ç½‘ç»œæ€§èƒ½
- å®ç°å…¬å¹³çš„èµ„æºåˆ†é…
```

**ğŸ”¹ net_cls + TCçš„åä½œæœºåˆ¶**
```
å·¥ä½œæµç¨‹ï¼š
1. net_clsç»™è¿›ç¨‹æµé‡æ‰“æ ‡ç­¾
2. TCè¯†åˆ«æ ‡ç­¾è¿›è¡Œåˆ†ç±»
3. æ ¹æ®åˆ†ç±»åº”ç”¨ä¸åŒç­–ç•¥
4. å®ç°å·®å¼‚åŒ–ç½‘ç»œæœåŠ¡

å°±åƒå¿«é€’åˆ†æ‹£ï¼š
net_cls = è´´å¿«é€’æ ‡ç­¾
TC = åˆ†æ‹£å‘˜æŒ‰æ ‡ç­¾å¤„ç†
ä¸åŒæ ‡ç­¾ = ä¸åŒè¿è¾“ä¼˜å…ˆçº§
```

**ğŸ”¹ HTBç®—æ³•çš„ä¼˜åŠ¿**
```
é“¶è¡Œä¿¡è´·æ¨¡å‹ï¼š
- ä¿è¯å¸¦å®½ï¼šåŸºç¡€ä¿¡ç”¨é¢åº¦
- å³°å€¼å¸¦å®½ï¼šä¸´æ—¶ä¿¡ç”¨æå‡
- å±‚æ¬¡ç®¡ç†ï¼šæ€»è¡Œ-åˆ†è¡Œ-æ”¯è¡Œ
- èµ„æºå…±äº«ï¼šé—²ç½®é¢åº¦å¯å€Ÿç”¨

ç½‘ç»œåº”ç”¨ï¼š
- ç¨³å®šæ€§ï¼šä¿è¯æœ€ä½å¸¦å®½éœ€æ±‚
- å¼¹æ€§ï¼šç©ºé—²æ—¶å¯è·å¾—æ›´å¤šèµ„æº
- å…¬å¹³æ€§ï¼šé˜²æ­¢æŸä¸ªæœåŠ¡ç‹¬å 
- æ•ˆç‡ï¼šå……åˆ†åˆ©ç”¨ç½‘ç»œèµ„æº
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ åº”ç”¨åœºæ™¯é€‰æ‹©**
```
ä¼ä¸šç½‘ç»œä¼˜åŒ–ï¼š
âœ… ä¿è¯å…³é”®ä¸šåŠ¡ç³»ç»Ÿå¸¦å®½
âœ… é™åˆ¶å¨±ä¹ã€ä¸‹è½½ç±»åº”ç”¨
âœ… ä¸ºè§†é¢‘ä¼šè®®é¢„ç•™ä¸“ç”¨é€šé“

äº‘æœåŠ¡æä¾›å•†ï¼š
âœ… ä¸ºä¸åŒç§Ÿæˆ·åˆ†é…ç½‘ç»œé…é¢
âœ… å®ç°æŒ‰éœ€ä»˜è´¹çš„ç½‘ç»œæœåŠ¡
âœ… é˜²æ­¢å•ä¸ªç”¨æˆ·å½±å“å…¶ä»–ç”¨æˆ·

æ•°æ®ä¸­å¿ƒç®¡ç†ï¼š
âœ… åŒºåˆ†å‰ç«¯ã€åç«¯ã€å­˜å‚¨æµé‡
âœ… ä¸ºæ‰¹å¤„ç†ä»»åŠ¡è®¾ç½®ä½ä¼˜å…ˆçº§
âœ… ä¿è¯å®æ—¶æœåŠ¡å“åº”é€Ÿåº¦
```

**ğŸ”§ é…ç½®æœ€ä½³å®è·µ**
```
è§„åˆ’åŸåˆ™ï¼š
- å…ˆåˆ†æä¸šåŠ¡éœ€æ±‚å’Œæµé‡ç‰¹ç‚¹
- é¢„ç•™20-30%å¸¦å®½ä½œä¸ºç¼“å†²
- è®¾ç½®åˆç†çš„ä¼˜å…ˆçº§å±‚æ¬¡
- å®šæœŸç›‘æ§å’Œè°ƒæ•´é…ç½®

å¸¸è§é…ç½®æ¯”ä¾‹ï¼š
- å…³é”®ä¸šåŠ¡ï¼š40-50%å¸¦å®½ï¼Œæœ€é«˜ä¼˜å…ˆçº§
- ä¸€èˆ¬åº”ç”¨ï¼š30-35%å¸¦å®½ï¼Œä¸­ç­‰ä¼˜å…ˆçº§  
- åå°ä»»åŠ¡ï¼š15-20%å¸¦å®½ï¼Œä½ä¼˜å…ˆçº§
- é¢„ç•™ç¼“å†²ï¼š5-10%å¸¦å®½ï¼Œåº”æ€¥ä½¿ç”¨

ç›‘æ§é‡ç‚¹ï¼š
- å„ç±»åˆ«å®é™…å¸¦å®½ä½¿ç”¨æƒ…å†µ
- ç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…ç‡å˜åŒ–
- ä¸šåŠ¡æœåŠ¡å“åº”æ—¶é—´
- ç”¨æˆ·ä½“éªŒæ»¡æ„åº¦åé¦ˆ
```

### 11.4 æ•…éšœæ’æŸ¥è¦ç‚¹


**ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­**
```
é—®é¢˜1ï¼šé…ç½®ä¸ç”Ÿæ•ˆ
æ£€æŸ¥é¡¹ï¼š
- TCé…ç½®æ˜¯å¦æ­£ç¡®åº”ç”¨
- net_clsæ ‡è®°æ˜¯å¦æ­£ç¡®è®¾ç½®
- è¿›ç¨‹æ˜¯å¦æ­£ç¡®åŠ å…¥cgroup
- è¿‡æ»¤å™¨è§„åˆ™æ˜¯å¦åŒ¹é…æµé‡

é—®é¢˜2ï¼šæ€§èƒ½ä¸ç¬¦åˆé¢„æœŸ  
æ£€æŸ¥é¡¹ï¼š
- å¸¦å®½åˆ†é…æ˜¯å¦åˆç†
- æ˜¯å¦æœ‰ä¼˜å…ˆçº§å†²çª
- ç½‘ç»œç¡¬ä»¶æ˜¯å¦æ»¡è¶³éœ€æ±‚
- ç³»ç»Ÿè´Ÿè½½æ˜¯å¦è¿‡é«˜

é—®é¢˜3ï¼šæŸäº›æµé‡æ— æ³•æ§åˆ¶
æ£€æŸ¥é¡¹ï¼š
- æµé‡æ˜¯å¦èµ°äº†å…¶ä»–ç½‘ç»œæ¥å£
- æ˜¯å¦æœ‰ç»•è¿‡TCçš„è·¯å¾„
- åº”ç”¨æ˜¯å¦ä½¿ç”¨äº†ç‰¹æ®Šåè®®
- é˜²ç«å¢™è§„åˆ™æ˜¯å¦æœ‰å½±å“
```

### 11.5 å‘å±•è¶‹åŠ¿


**ğŸš€ æŠ€æœ¯æ¼”è¿›æ–¹å‘**
```
å®¹å™¨åŒ–ç½‘ç»œï¼š
- Kubernetesç½‘ç»œç­–ç•¥
- Service Meshæµé‡ç®¡ç†
- å®¹å™¨ç½‘ç»œæ€§èƒ½ä¼˜åŒ–
- å¾®æœåŠ¡é—´é€šä¿¡æ§åˆ¶

æ™ºèƒ½åŒ–ç®¡ç†ï¼š
- åŸºäºæœºå™¨å­¦ä¹ çš„æµé‡é¢„æµ‹
- è‡ªåŠ¨è°ƒæ•´ç½‘ç»œç­–ç•¥
- å¼‚å¸¸æµé‡æ™ºèƒ½è¯†åˆ«
- æ€§èƒ½é—®é¢˜è‡ªåŠ¨è¯Šæ–­

äº‘åŸç”Ÿæ”¯æŒï¼š
- äº‘å¹³å°é›†æˆç½‘ç»œQoS
- è½¯ä»¶å®šä¹‰ç½‘ç»œ(SDN)
- ç½‘ç»œåŠŸèƒ½è™šæ‹ŸåŒ–(NFV)
- è¾¹ç¼˜è®¡ç®—ç½‘ç»œä¼˜åŒ–
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- **ç½‘ç»œæ ‡ç­¾åˆ†ç±»ï¼ŒTCæ ¹æ®æ ‡ç­¾é™æµé‡**
- **HTBç®—æ³•ä¿è¯å…¬å¹³ï¼Œå±‚æ¬¡ç®¡ç†æ›´çµæ´»** 
- **å…³é”®ä¸šåŠ¡é«˜ä¼˜å…ˆï¼Œåå°ä»»åŠ¡ä½é…é¢**
- **å®æ—¶ç›‘æ§å¾ˆé‡è¦ï¼ŒåŠæ—¶è°ƒæ•´ä¿æ•ˆæœ**
- **å®¹å™¨ç¯å¢ƒéœ€ç‰¹æ®Šï¼Œå‘½åç©ºé—´æ¥éš”ç¦»**