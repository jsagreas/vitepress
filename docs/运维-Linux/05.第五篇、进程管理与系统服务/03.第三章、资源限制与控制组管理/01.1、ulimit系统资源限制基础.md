---
title: 1ã€ulimitç³»ç»Ÿèµ„æºé™åˆ¶åŸºç¡€
---
## ğŸ“š ç›®å½•

1. [ulimitåŸºæœ¬æ¦‚å¿µ](#1-ulimitåŸºæœ¬æ¦‚å¿µ)
2. [ulimitå‘½ä»¤è¯¦è§£](#2-ulimitå‘½ä»¤è¯¦è§£)
3. [è½¯é™åˆ¶ä¸ç¡¬é™åˆ¶](#3-è½¯é™åˆ¶ä¸ç¡¬é™åˆ¶)
4. [æ°¸ä¹…é…ç½®ç®¡ç†](#4-æ°¸ä¹…é…ç½®ç®¡ç†)
5. [å®é™…åº”ç”¨åœºæ™¯](#5-å®é™…åº”ç”¨åœºæ™¯)
6. [æ•…éšœæ’æŸ¥æŠ€å·§](#6-æ•…éšœæ’æŸ¥æŠ€å·§)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ’¡ ulimitåŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ulimit


ğŸ’­ **æƒ³è±¡ä¸€ä¸‹**ï¼šä½ åœ¨ç®¡ç†ä¸€ä¸ªé¤å…ï¼Œéœ€è¦æ§åˆ¶æ¯æ¡Œå®¢äººèƒ½ç‚¹å¤šå°‘èœã€å ç”¨å¤šé•¿æ—¶é—´ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯é¤å…æ­£å¸¸è¿è¥ï¼Œä¸ä¼šå› ä¸ºæŸæ¡Œå®¢äººè¿‡åº¦æ¶ˆè´¹è€Œå½±å“å…¶ä»–å®¢äººã€‚

**ulimitå°±æ˜¯Linuxç³»ç»Ÿçš„"é¤å…ç®¡ç†å‘˜"**ï¼š
- ğŸ·ï¸ **ulimit** = `user limit`ï¼Œç”¨æˆ·èµ„æºé™åˆ¶
- ğŸ¯ **ä½œç”¨**ï¼šé˜²æ­¢å•ä¸ªç”¨æˆ·æˆ–è¿›ç¨‹æ¶ˆè€—è¿‡å¤šç³»ç»Ÿèµ„æº
- ğŸ›¡ï¸ **ä¿æŠ¤**ï¼šä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§ï¼Œé¿å…èµ„æºè€—å°½

```
ç³»ç»Ÿèµ„æºæ± ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     CPU    å†…å­˜    æ–‡ä»¶  â”‚
â”‚   â”Œâ”€â”€â”€â”  â”Œâ”€â”€â”€â”  â”Œâ”€â”€â”€â”   â”‚
â”‚   â”‚ A â”‚  â”‚ B â”‚  â”‚ C â”‚   â”‚  â† å„ä¸ªç”¨æˆ·è¿›ç¨‹
â”‚   â””â”€â”€â”€â”˜  â””â”€â”€â”€â”˜  â””â”€â”€â”€â”˜   â”‚
â”‚                         â”‚
â”‚   ulimit æ§åˆ¶æ¯ä¸ªç”¨æˆ·    â”‚
â”‚   æœ€å¤šèƒ½ç”¨å¤šå°‘èµ„æº       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ğŸ¤” **ä¸ºä»€ä¹ˆéœ€è¦ulimit**ï¼š
- **é˜²æ­¢ç³»ç»Ÿå´©æºƒ**ï¼šæŸä¸ªç¨‹åºæ— é™åˆ¶æ¶ˆè€—å†…å­˜
- **ä¿è¯å…¬å¹³æ€§**ï¼šå¤šç”¨æˆ·ç¯å¢ƒä¸‹èµ„æºåˆç†åˆ†é…
- **é¿å…æ„å¤–**ï¼šç¨‹åºbugå¯¼è‡´çš„èµ„æºæ³„æ¼
- **æœåŠ¡ç¨³å®š**ï¼šWebæœåŠ¡å™¨ã€æ•°æ®åº“ç­‰å…³é”®æœåŠ¡çš„èµ„æºä¿æŠ¤

### 1.2 ulimitçš„å·¥ä½œåŸç†


ğŸ—ï¸ **èµ„æºé™åˆ¶æ¶æ„**ï¼š
```
ç”¨æˆ·ç™»å½• â†’ Shellå¯åŠ¨ â†’ ç»§æ‰¿çˆ¶è¿›ç¨‹é™åˆ¶ â†’ è®¾ç½®å½“å‰ä¼šè¯é™åˆ¶
    â†“
åˆ›å»ºå­è¿›ç¨‹ â†’ ç»§æ‰¿çˆ¶è¿›ç¨‹é™åˆ¶ â†’ æ— æ³•è¶…è¿‡è®¾å®šå€¼
```

ğŸ“‹ **èµ„æºç»§æ‰¿æœºåˆ¶**ï¼š
- **çˆ¶è¿›ç¨‹é™åˆ¶**ï¼šå­è¿›ç¨‹ä¸èƒ½è¶…è¿‡çˆ¶è¿›ç¨‹çš„é™åˆ¶
- **ä¼šè¯çº§åˆ«**ï¼šåŒä¸€ç™»å½•ä¼šè¯å…±äº«é™åˆ¶è®¾ç½®
- **ç”¨æˆ·çº§åˆ«**ï¼šä¸åŒç”¨æˆ·æœ‰ç‹¬ç«‹çš„èµ„æºé™åˆ¶

---

## 2. ğŸ”§ ulimitå‘½ä»¤è¯¦è§£


### 2.1 å¸¸ç”¨å‚æ•°å…¨è§£æ


ğŸ“Š **æ ¸å¿ƒå‚æ•°å¯¹ç…§è¡¨**ï¼š

| å‚æ•° | **å«ä¹‰** | **è¯´æ˜** | **å•ä½** | **å…¸å‹å€¼** |
|------|---------|---------|---------|-----------|
| `-n` | `æ–‡ä»¶æè¿°ç¬¦æ•°é‡` | `è¿›ç¨‹èƒ½åŒæ—¶æ‰“å¼€çš„æ–‡ä»¶æ•°` | `ä¸ªæ•°` | `1024/65536` |
| `-u` | `ç”¨æˆ·è¿›ç¨‹æ•°` | `ç”¨æˆ·èƒ½åˆ›å»ºçš„æœ€å¤§è¿›ç¨‹æ•°` | `ä¸ªæ•°` | `4096/æ— é™åˆ¶` |
| `-f` | `æ–‡ä»¶å¤§å°` | `Shellèƒ½åˆ›å»ºçš„æœ€å¤§æ–‡ä»¶` | `KB` | `æ— é™åˆ¶` |
| `-s` | `æ ˆå¤§å°` | `è¿›ç¨‹æ ˆçš„æœ€å¤§å¤§å°` | `KB` | `8192` |
| `-c` | `æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶` | `core dumpæ–‡ä»¶æœ€å¤§å¤§å°` | `KB` | `0(ç¦ç”¨)` |
| `-m` | `å†…å­˜å¤§å°` | `è¿›ç¨‹æœ€å¤§å†…å­˜ä½¿ç”¨é‡` | `KB` | `æ— é™åˆ¶` |
| `-t` | `CPUæ—¶é—´` | `è¿›ç¨‹æœ€å¤§CPUä½¿ç”¨æ—¶é—´` | `ç§’` | `æ— é™åˆ¶` |
| `-v` | `è™šæ‹Ÿå†…å­˜` | `è™šæ‹Ÿå†…å­˜æœ€å¤§å¤§å°` | `KB` | `æ— é™åˆ¶` |

### 2.2 åŸºç¡€å‘½ä»¤æ“ä½œ


ğŸ” **æŸ¥çœ‹å½“å‰é™åˆ¶**ï¼š
```bash
# æŸ¥çœ‹æ‰€æœ‰èµ„æºé™åˆ¶
ulimit -a

# æŸ¥çœ‹ç‰¹å®šèµ„æº
ulimit -n    # æ–‡ä»¶æè¿°ç¬¦
ulimit -u    # ç”¨æˆ·è¿›ç¨‹æ•°
ulimit -s    # æ ˆå¤§å°
```

**è¾“å‡ºè§£è¯»**ï¼š
```bash
$ ulimit -a
core file size          (blocks, -c) 0           # æ ¸å¿ƒè½¬å‚¨ç¦ç”¨
data seg size           (kbytes, -d) unlimited   # æ•°æ®æ®µæ— é™åˆ¶
scheduling priority             (-e) 0           # è°ƒåº¦ä¼˜å…ˆçº§
file size               (blocks, -f) unlimited   # æ–‡ä»¶å¤§å°æ— é™åˆ¶
pending signals                 (-i) 15663       # å¾…å¤„ç†ä¿¡å·æ•°é‡
max locked memory       (kbytes, -l) 64          # é”å®šå†…å­˜64KB
max memory size         (kbytes, -m) unlimited   # å†…å­˜ä½¿ç”¨æ— é™åˆ¶
open files                      (-n) 1024        # æ–‡ä»¶æè¿°ç¬¦1024ä¸ª
pipe size            (512 bytes, -p) 8          # ç®¡é“å¤§å°4KB
POSIX message queues     (bytes, -q) 819200     # POSIXæ¶ˆæ¯é˜Ÿåˆ—
real-time priority              (-r) 0           # å®æ—¶ä¼˜å…ˆçº§
stack size              (kbytes, -s) 8192        # æ ˆå¤§å°8MB
cpu time               (seconds, -t) unlimited   # CPUæ—¶é—´æ— é™åˆ¶
max user processes              (-u) 4096        # ç”¨æˆ·è¿›ç¨‹4096ä¸ª
virtual memory          (kbytes, -v) unlimited   # è™šæ‹Ÿå†…å­˜æ— é™åˆ¶
file locks                      (-x) unlimited   # æ–‡ä»¶é”æ— é™åˆ¶
```

âš¡ **è®¾ç½®èµ„æºé™åˆ¶**ï¼š
```bash
# ä¸´æ—¶è®¾ç½®ï¼ˆå½“å‰ä¼šè¯æœ‰æ•ˆï¼‰
ulimit -n 65536          # è®¾ç½®æ–‡ä»¶æè¿°ç¬¦ä¸º65536
ulimit -u 8192           # è®¾ç½®ç”¨æˆ·è¿›ç¨‹æ•°ä¸º8192
ulimit -c unlimited      # å¯ç”¨æ ¸å¿ƒè½¬å‚¨ï¼Œæ— å¤§å°é™åˆ¶
ulimit -s 16384          # è®¾ç½®æ ˆå¤§å°ä¸º16MB
```

---

## 3. âš–ï¸ è½¯é™åˆ¶ä¸ç¡¬é™åˆ¶


### 3.1 æ¦‚å¿µåŒºåˆ«


ğŸ·ï¸ **è½¯é™åˆ¶ï¼ˆSoft Limitï¼‰**ï¼š
- **å®šä¹‰**ï¼šç¨‹åºè¿è¡Œæ—¶çš„å®é™…é™åˆ¶å€¼
- **ç‰¹ç‚¹**ï¼šå¯ä»¥åœ¨ç¡¬é™åˆ¶èŒƒå›´å†…åŠ¨æ€è°ƒæ•´
- **ä½œç”¨**ï¼šæ—¥å¸¸ä½¿ç”¨çš„é™åˆ¶ï¼Œè¶…è¿‡ä¼šæ”¶åˆ°ä¿¡å·

ğŸ·ï¸ **ç¡¬é™åˆ¶ï¼ˆHard Limitï¼‰**ï¼š
- **å®šä¹‰**ï¼šè½¯é™åˆ¶èƒ½è®¾ç½®çš„æœ€å¤§å€¼
- **ç‰¹ç‚¹**ï¼šåªæœ‰rootç”¨æˆ·èƒ½æé«˜ç¡¬é™åˆ¶
- **ä½œç”¨**ï¼šè½¯é™åˆ¶çš„ä¸Šé™ï¼Œç³»ç»Ÿçº§åˆ«çš„æœ€ç»ˆé™åˆ¶

```
ç¡¬é™åˆ¶ä¸è½¯é™åˆ¶å…³ç³»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç¡¬é™åˆ¶: 10000  â”‚  â† æœ€å¤§ä¸Šé™ï¼Œrootè®¾ç½®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   è½¯é™åˆ¶: 1024   â”‚  â† å®é™…ç”Ÿæ•ˆå€¼ï¼Œç”¨æˆ·å¯è°ƒ
â”‚                 â”‚
â”‚   0 â‰¤ è½¯é™åˆ¶ â‰¤ ç¡¬é™åˆ¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æŸ¥çœ‹å’Œè®¾ç½®è½¯ç¡¬é™åˆ¶


ğŸ”§ **æŸ¥çœ‹è½¯ç¡¬é™åˆ¶**ï¼š
```bash
# æŸ¥çœ‹è½¯é™åˆ¶ï¼ˆé»˜è®¤ï¼‰
ulimit -n

# æŸ¥çœ‹ç¡¬é™åˆ¶
ulimit -Hn    # æ–‡ä»¶æè¿°ç¬¦ç¡¬é™åˆ¶
ulimit -Hu    # ç”¨æˆ·è¿›ç¨‹æ•°ç¡¬é™åˆ¶
ulimit -Ha    # æ‰€æœ‰ç¡¬é™åˆ¶
```

ğŸ› ï¸ **è®¾ç½®è½¯ç¡¬é™åˆ¶**ï¼š
```bash
# è®¾ç½®è½¯é™åˆ¶ï¼ˆä¸èƒ½è¶…è¿‡ç¡¬é™åˆ¶ï¼‰
ulimit -Sn 2048

# è®¾ç½®ç¡¬é™åˆ¶ï¼ˆéœ€è¦rootæƒé™ï¼‰
ulimit -Hn 65536

# åŒæ—¶è®¾ç½®è½¯ç¡¬é™åˆ¶
ulimit -n 4096    # è½¯é™åˆ¶å’Œç¡¬é™åˆ¶éƒ½è®¾ä¸º4096
```

ğŸ’¡ **å®é™…ä¾‹å­**ï¼š
```bash
# æŸ¥çœ‹å½“å‰æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
$ ulimit -n
1024

# æŸ¥çœ‹ç¡¬é™åˆ¶
$ ulimit -Hn  
4096

# æé«˜è½¯é™åˆ¶åˆ°ç¡¬é™åˆ¶èŒƒå›´å†…
$ ulimit -n 4096
$ ulimit -n
4096

# å°è¯•è¶…è¿‡ç¡¬é™åˆ¶ï¼ˆæ™®é€šç”¨æˆ·æ— æ³•æˆåŠŸï¼‰
$ ulimit -n 8192
bash: ulimit: open files: cannot modify limit: Operation not permitted
```

### 3.3 é™åˆ¶çš„å®é™…æ•ˆæœ


âš ï¸ **è¶…è¿‡è½¯é™åˆ¶ä¼šå‘ç”Ÿä»€ä¹ˆ**ï¼š
- **æ–‡ä»¶æè¿°ç¬¦**ï¼šæ–°çš„æ–‡ä»¶æ‰“å¼€å¤±è´¥ï¼Œè¿”å›"Too many open files"
- **è¿›ç¨‹æ•°**ï¼šfork()å¤±è´¥ï¼Œæ— æ³•åˆ›å»ºæ–°è¿›ç¨‹
- **å†…å­˜**ï¼šmalloc()å¤±è´¥ï¼Œå†…å­˜åˆ†é…å¤±è´¥
- **CPUæ—¶é—´**ï¼šè¿›ç¨‹æ”¶åˆ°SIGKILLä¿¡å·è¢«ç»ˆæ­¢

ğŸŒ° **å®é™…æµ‹è¯•ä¾‹å­**ï¼š
```bash
# è®¾ç½®å¾ˆå°çš„æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
ulimit -n 10

# è¿è¡Œéœ€è¦æ‰“å¼€å¾ˆå¤šæ–‡ä»¶çš„ç¨‹åº
ls /usr/bin/*
# å¯èƒ½ä¼šçœ‹åˆ°é”™è¯¯ï¼šls: cannot access: Too many open files
```

---

## 4. ğŸ“ æ°¸ä¹…é…ç½®ç®¡ç†


### 4.1 ç³»ç»Ÿçº§é…ç½®æ–‡ä»¶


ğŸ·ï¸ **`/etc/security/limits.conf`** = ä¸»è¦çš„èµ„æºé™åˆ¶é…ç½®æ–‡ä»¶

**æ–‡ä»¶æ ¼å¼**ï¼š
```
<domain>  <type>  <item>  <value>
```

ğŸ“‹ **å‚æ•°è¯¦è§£**ï¼š
- **domain**ï¼šç”¨æˆ·åã€ç»„å(@group)æˆ–é€šé…ç¬¦(*)
- **type**ï¼šsoft(è½¯é™åˆ¶)ã€hard(ç¡¬é™åˆ¶)ã€-(è½¯ç¡¬éƒ½è®¾ç½®)
- **item**ï¼šèµ„æºç±»å‹ï¼ˆnprocã€nofileã€stackç­‰ï¼‰
- **value**ï¼šé™åˆ¶å€¼ï¼ˆæ•°å­—æˆ–unlimitedï¼‰

### 4.2 é…ç½®ç¤ºä¾‹


```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo vim /etc/security/limits.conf
```

**å®ç”¨é…ç½®ç¤ºä¾‹**ï¼š
```bash
# ä¸ºæ‰€æœ‰ç”¨æˆ·è®¾ç½®æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
*               soft    nofile          65536
*               hard    nofile          65536

# ä¸ºç‰¹å®šç”¨æˆ·è®¾ç½®è¿›ç¨‹æ•°é™åˆ¶
nginx           soft    nproc           8192
nginx           hard    nproc           16384

# ä¸ºç”¨æˆ·ç»„è®¾ç½®å†…å­˜é™åˆ¶
@developers     soft    as              2097152    # 2GB
@developers     hard    as              4194304    # 4GB

# è®¾ç½®æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶
*               soft    core            unlimited
*               hard    core            unlimited

# è®¾ç½®æ ˆå¤§å°
*               soft    stack           8192       # 8MB
*               hard    stack           16384      # 16MB
```

ğŸ“ **é…ç½®æ–‡ä»¶æ³¨æ„äº‹é¡¹**ï¼š
- ä¿®æ”¹åéœ€è¦é‡æ–°ç™»å½•æ‰èƒ½ç”Ÿæ•ˆ
- é…ç½®æŒ‰è¡Œè¯»å–ï¼Œåé¢çš„é…ç½®ä¼šè¦†ç›–å‰é¢çš„
- ä½¿ç”¨TABæˆ–å¤šä¸ªç©ºæ ¼åˆ†éš”å­—æ®µ

### 4.3 åˆ†ç¦»å¼é…ç½®ç®¡ç†


ğŸ·ï¸ **`/etc/security/limits.d/`** = æ›´çµæ´»çš„é…ç½®ç›®å½•

**ä¼˜åŠ¿**ï¼š
- æŒ‰åº”ç”¨æˆ–ç”¨æˆ·åˆ†ç±»ç®¡ç†
- é¿å…å¤§æ–‡ä»¶éš¾ä»¥ç»´æŠ¤
- åŒ…ç®¡ç†å™¨å¯ä»¥è‡ªåŠ¨æ·»åŠ é…ç½®

ğŸ”§ **åˆ›å»ºä¸“ç”¨é…ç½®**ï¼š
```bash
# ä¸ºnginxåˆ›å»ºä¸“ç”¨é…ç½®
sudo vim /etc/security/limits.d/nginx.conf
```

```bash
# nginxæœåŠ¡èµ„æºé™åˆ¶
nginx           soft    nofile          32768
nginx           hard    nofile          65536
nginx           soft    nproc           4096
nginx           hard    nproc           8192
```

```bash
# ä¸ºæ•°æ®åº“æœåŠ¡åˆ›å»ºé…ç½®
sudo vim /etc/security/limits.d/mysql.conf
```

```bash
# MySQLèµ„æºé™åˆ¶
mysql           soft    nofile          65536
mysql           hard    nofile          65536
mysql           soft    memlock         unlimited
mysql           hard    memlock         unlimited
```

### 4.4 systemdæœåŠ¡çš„èµ„æºé™åˆ¶


ğŸ”§ **systemdå•å…ƒæ–‡ä»¶é…ç½®**ï¼š
```bash
# ç¼–è¾‘æœåŠ¡é…ç½®
sudo systemctl edit nginx

# åœ¨override.confä¸­æ·»åŠ ï¼š
[Service]
LimitNOFILE=65536
LimitNPROC=8192
LimitMEMLOCK=unlimited
```

**systemdé™åˆ¶å‚æ•°å¯¹ç…§**ï¼š
```
ulimitå‚æ•°    systemdå‚æ•°      è¯´æ˜
-n           LimitNOFILE      æ–‡ä»¶æè¿°ç¬¦
-u           LimitNPROC       è¿›ç¨‹æ•°
-c           LimitCORE        æ ¸å¿ƒè½¬å‚¨
-s           LimitSTACK       æ ˆå¤§å°
-m           LimitRSS         å†…å­˜å¤§å°
```

---

## 5. ğŸ¯ å®é™…åº”ç”¨åœºæ™¯


### 5.1 WebæœåŠ¡å™¨ä¼˜åŒ–


ğŸŒ **Nginxé«˜å¹¶å‘é…ç½®**ï¼š

**é—®é¢˜åœºæ™¯**ï¼šNginxæŠ¥é”™"too many open files"

**è§£å†³æ­¥éª¤**ï¼š
```bash
# 1. æ£€æŸ¥å½“å‰é™åˆ¶
sudo -u nginx ulimit -n
# è¾“å‡ºå¯èƒ½åªæœ‰1024

# 2. åˆ›å»ºnginxä¸“ç”¨é…ç½®
sudo vim /etc/security/limits.d/nginx.conf
```

```bash
# nginxç”¨æˆ·èµ„æºé™åˆ¶
nginx           soft    nofile          65536
nginx           hard    nofile          65536
nginx           soft    nproc           4096
nginx           hard    nproc           4096
```

```bash
# 3. é…ç½®systemdæœåŠ¡
sudo vim /etc/systemd/system/nginx.service.d/limits.conf
```

```ini
[Service]
LimitNOFILE=65536
LimitNPROC=4096
```

```bash
# 4. é‡è½½é…ç½®å¹¶é‡å¯æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl restart nginx

# 5. éªŒè¯é…ç½®
sudo -u nginx bash -c 'ulimit -n'
```

### 5.2 æ•°æ®åº“æœåŠ¡ä¼˜åŒ–


ğŸ—„ï¸ **MySQL/MariaDBé…ç½®**ï¼š

**å…¸å‹é—®é¢˜**ï¼šæ•°æ®åº“è¿æ¥æ•°é™åˆ¶
```bash
# MySQLç”¨æˆ·èµ„æºé…ç½®
sudo vim /etc/security/limits.d/mysql.conf
```

```bash
mysql           soft    nofile          65536
mysql           hard    nofile          65536
mysql           soft    memlock         unlimited
mysql           hard    memlock         unlimited
mysql           soft    nproc           4096
mysql           hard    nproc           8192
```

**systemdæœåŠ¡é…ç½®**ï¼š
```bash
sudo systemctl edit mysql
```

```ini
[Service]
LimitNOFILE=65536
LimitMEMLOCK=infinity
LimitNPROC=8192
```

### 5.3 å¼€å‘ç¯å¢ƒé…ç½®


ğŸ’» **å¼€å‘è€…ç”¨æˆ·é…ç½®**ï¼š
```bash
sudo vim /etc/security/limits.d/developers.conf
```

```bash
# å¼€å‘ç”¨æˆ·ç»„èµ„æºé™åˆ¶
@developers     soft    nofile          32768
@developers     hard    nofile          65536
@developers     soft    nproc           8192
@developers     hard    nproc           16384
@developers     soft    core            unlimited
@developers     hard    core            unlimited
```

ğŸ” **è°ƒè¯•ç¨‹åºéœ€è¦core dump**ï¼š
```bash
# å¯ç”¨æ ¸å¿ƒè½¬å‚¨
ulimit -c unlimited

# è®¾ç½®coreæ–‡ä»¶æ ¼å¼å’Œä½ç½®
echo '/tmp/core.%e.%p' | sudo tee /proc/sys/kernel/core_pattern

# è¿è¡Œå¯èƒ½å´©æºƒçš„ç¨‹åº
./my_program
# å¦‚æœç¨‹åºå´©æºƒï¼Œä¼šåœ¨/tmp/ç”Ÿæˆcoreæ–‡ä»¶
```

---

## 6. ğŸ”§ æ•…éšœæ’æŸ¥æŠ€å·§


### 6.1 å¸¸è§é”™è¯¯è¯Šæ–­


âŒ **"Too many open files"é”™è¯¯**ï¼š

**è¯Šæ–­æ­¥éª¤**ï¼š
```bash
# 1. æ£€æŸ¥å½“å‰è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨æƒ…å†µ
lsof -p <pid> | wc -l

# 2. æ£€æŸ¥ç³»ç»Ÿå…¨å±€æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨
cat /proc/sys/fs/file-nr
# è¾“å‡ºæ ¼å¼ï¼šå·²åˆ†é… å·²ä½¿ç”¨ æœ€å¤§å€¼

# 3. æ£€æŸ¥ç”¨æˆ·é™åˆ¶
ulimit -n

# 4. æŸ¥çœ‹è¿›ç¨‹çš„å®é™…é™åˆ¶
cat /proc/<pid>/limits
```

**è§£å†³æ–¹æ³•**ï¼š
```bash
# ä¸´æ—¶è§£å†³
ulimit -n 65536

# æ°¸ä¹…è§£å†³
echo "* soft nofile 65536" | sudo tee -a /etc/security/limits.conf
echo "* hard nofile 65536" | sudo tee -a /etc/security/limits.conf
```

### 6.2 è¿›ç¨‹èµ„æºç›‘æ§


ğŸ“Š **å®æ—¶ç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# ç›‘æ§æŒ‡å®šè¿›ç¨‹çš„èµ„æºä½¿ç”¨æƒ…å†µ

PID=$1
if [ -z "$PID" ]; then
    echo "Usage: $0 <pid>"
    exit 1
fi

echo "è¿›ç¨‹ $PID çš„èµ„æºä½¿ç”¨æƒ…å†µï¼š"
echo "================================"

# æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨æƒ…å†µ
fd_count=$(lsof -p $PID 2>/dev/null | wc -l)
fd_limit=$(cat /proc/$PID/limits | grep "Max open files" | awk '{print $4}')
echo "æ–‡ä»¶æè¿°ç¬¦: $fd_count / $fd_limit"

# çº¿ç¨‹æ•°ä½¿ç”¨æƒ…å†µ
thread_count=$(cat /proc/$PID/status | grep Threads | awk '{print $2}')
proc_limit=$(cat /proc/$PID/limits | grep "Max processes" | awk '{print $3}')
echo "çº¿ç¨‹/è¿›ç¨‹æ•°: $thread_count / $proc_limit"

# å†…å­˜ä½¿ç”¨æƒ…å†µ
mem_kb=$(cat /proc/$PID/status | grep VmRSS | awk '{print $2}')
echo "å†…å­˜ä½¿ç”¨: ${mem_kb} KB"

# æ ˆå¤§å°é™åˆ¶
stack_limit=$(cat /proc/$PID/limits | grep "Max stack size" | awk '{print $3}')
echo "æ ˆå¤§å°é™åˆ¶: $stack_limit"
```

### 6.3 é…ç½®éªŒè¯


âœ… **éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆ**ï¼š
```bash
# éªŒè¯è„šæœ¬
check_limits() {
    local user=$1
    echo "æ£€æŸ¥ç”¨æˆ· $user çš„èµ„æºé™åˆ¶:"
    
    # åˆ‡æ¢åˆ°ç”¨æˆ·å¹¶æ£€æŸ¥é™åˆ¶
    sudo -u $user bash -c '
        echo "æ–‡ä»¶æè¿°ç¬¦ (è½¯/ç¡¬): $(ulimit -Sn)/$(ulimit -Hn)"
        echo "ç”¨æˆ·è¿›ç¨‹æ•° (è½¯/ç¡¬): $(ulimit -Su)/$(ulimit -Hu)"
        echo "æ ¸å¿ƒè½¬å‚¨ (è½¯/ç¡¬): $(ulimit -Sc)/$(ulimit -Hc)"
        echo "æ ˆå¤§å° (è½¯/ç¡¬): $(ulimit -Ss)/$(ulimit -Hs)"
    '
}

# ä½¿ç”¨æ–¹æ³•
check_limits nginx
check_limits mysql
```

**æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•**ï¼š
```bash
# æ£€æŸ¥limits.confè¯­æ³•
sudo bash -c '
    while read line; do
        # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
        [[ "$line" =~ ^[[:space:]]*# ]] && continue
        [[ -z "${line// }" ]] && continue
        
        # æ£€æŸ¥å­—æ®µæ•°é‡
        fields=($line)
        if [[ ${#fields[@]} -ne 4 ]]; then
            echo "è¯­æ³•é”™è¯¯: $line"
        fi
    done < /etc/security/limits.conf
'
```

### 6.4 æ€§èƒ½å½±å“åˆ†æ


ğŸ“ˆ **èµ„æºé™åˆ¶å¯¹æ€§èƒ½çš„å½±å“**ï¼š

| é™åˆ¶ç±»å‹ | **è¿‡å°çš„å½±å“** | **å»ºè®®å€¼** | **ç›‘æ§æ–¹æ³•** |
|---------|----------------|-----------|-------------|
| `æ–‡ä»¶æè¿°ç¬¦` | `è¿æ¥è¢«æ‹’ç»ï¼ŒæœåŠ¡ä¸å¯ç”¨` | `65536` | `lsofç»Ÿè®¡` |
| `ç”¨æˆ·è¿›ç¨‹æ•°` | `æ— æ³•åˆ›å»ºæ–°è¿›ç¨‹/çº¿ç¨‹` | `8192` | `psç»Ÿè®¡` |
| `å†…å­˜é™åˆ¶` | `ç¨‹åºå´©æºƒï¼ŒOOMé”™è¯¯` | `æ ¹æ®åº”ç”¨éœ€æ±‚` | `/proc/meminfo` |
| `æ ˆå¤§å°` | `é€’å½’å‡½æ•°å´©æºƒ` | `8192KB` | `ç¨‹åºæµ‹è¯•` |

**æ€§èƒ½è°ƒä¼˜å»ºè®®**ï¼š
```bash
# é«˜å¹¶å‘WebæœåŠ¡å™¨
echo "nginx soft nofile 65536" >> /etc/security/limits.d/nginx.conf
echo "nginx hard nofile 65536" >> /etc/security/limits.d/nginx.conf

# æ•°æ®åº“æœåŠ¡å™¨
echo "mysql soft nofile 65536" >> /etc/security/limits.d/mysql.conf  
echo "mysql soft memlock unlimited" >> /etc/security/limits.d/mysql.conf

# å¼€å‘ç¯å¢ƒ
echo "* soft core unlimited" >> /etc/security/limits.d/development.conf
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„åŸºç¡€æ¦‚å¿µ


ğŸ¯ **æ ¸å¿ƒç†è§£**ï¼š
- **ulimitä½œç”¨**ï¼šä¿æŠ¤ç³»ç»Ÿèµ„æºï¼Œé˜²æ­¢å•ä¸ªç”¨æˆ·è¿‡åº¦æ¶ˆè€—
- **è½¯ç¡¬é™åˆ¶**ï¼šè½¯é™åˆ¶æ˜¯å®é™…ç”Ÿæ•ˆå€¼ï¼Œç¡¬é™åˆ¶æ˜¯è½¯é™åˆ¶çš„ä¸Šé™
- **é…ç½®å±‚æ¬¡**ï¼šä¸´æ—¶è®¾ç½® < ç”¨æˆ·é…ç½® < ç³»ç»Ÿé…ç½®
- **ç”Ÿæ•ˆæ—¶æœº**ï¼šé…ç½®ä¿®æ”¹åéœ€è¦é‡æ–°ç™»å½•æˆ–é‡å¯æœåŠ¡

### 7.2 å…³é”®æ“ä½œå‘½ä»¤


```bash
# æŸ¥çœ‹é™åˆ¶
ulimit -a              # æŸ¥çœ‹æ‰€æœ‰é™åˆ¶
ulimit -n              # æŸ¥çœ‹æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
ulimit -Hn             # æŸ¥çœ‹ç¡¬é™åˆ¶

# ä¸´æ—¶è®¾ç½®
ulimit -n 65536        # è®¾ç½®æ–‡ä»¶æè¿°ç¬¦
ulimit -c unlimited    # å¯ç”¨æ ¸å¿ƒè½¬å‚¨

# æ°¸ä¹…é…ç½®
vim /etc/security/limits.conf
vim /etc/security/limits.d/app.conf

# éªŒè¯é…ç½®
sudo -u username bash -c 'ulimit -n'
cat /proc/<pid>/limits
```

### 7.3 å®é™…åº”ç”¨è¦ç‚¹


ğŸ”§ **é…ç½®æœ€ä½³å®è·µ**ï¼š
- **WebæœåŠ¡å™¨**ï¼šnofileè®¾ç½®65536ï¼Œnprocè®¾ç½®4096-8192
- **æ•°æ®åº“**ï¼šnofileè®¾ç½®65536ï¼Œå¯ç”¨memlock unlimited
- **å¼€å‘ç¯å¢ƒ**ï¼šå¯ç”¨core dumpï¼Œé€‚å½“æé«˜å„é¡¹é™åˆ¶
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šæ ¹æ®åº”ç”¨ç‰¹ç‚¹å’Œç¡¬ä»¶èµ„æºåˆç†è®¾ç½®

âš ï¸ **å¸¸è§æ³¨æ„äº‹é¡¹**ï¼š
- ä¿®æ”¹ç³»ç»Ÿé…ç½®éœ€è¦rootæƒé™
- é…ç½®ç”Ÿæ•ˆéœ€è¦é‡æ–°ç™»å½•
- systemdæœåŠ¡éœ€è¦åœ¨serviceæ–‡ä»¶ä¸­å•ç‹¬é…ç½®
- ä¸è¦ç›²ç›®è®¾ç½®unlimitedï¼Œæ ¹æ®å®é™…éœ€æ±‚è®¾ç½®

ğŸš¨ **æ•…éšœæ’æŸ¥é‡ç‚¹**ï¼š
- "Too many open files"æ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
- è¿›ç¨‹åˆ›å»ºå¤±è´¥æ£€æŸ¥nprocé™åˆ¶  
- ç¨‹åºå´©æºƒæ£€æŸ¥core dumpé…ç½®
- å†…å­˜åˆ†é…å¤±è´¥æ£€æŸ¥å†…å­˜é™åˆ¶

**ğŸ”‘ æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ulimitç®¡èµ„æºï¼Œè½¯ç¡¬é™åˆ¶è¦åˆ†æ¸…
- ä¸´æ—¶æ”¹å½“å‰ï¼Œæ°¸ä¹…æ”¹é…ç½®æ–‡ä»¶
- æœåŠ¡è¦é‡å¯ï¼Œç”¨æˆ·è¦é‡ç™»
- ç›‘æ§å¾ˆé‡è¦ï¼Œæ•…éšœå¥½æ’æŸ¥

é€šè¿‡åˆç†é…ç½®ulimitï¼Œå¯ä»¥æœ‰æ•ˆä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§ï¼Œæå‡æœåŠ¡æ€§èƒ½ï¼Œæ˜¯Linuxç³»ç»Ÿç®¡ç†çš„é‡è¦æŠ€èƒ½ï¼