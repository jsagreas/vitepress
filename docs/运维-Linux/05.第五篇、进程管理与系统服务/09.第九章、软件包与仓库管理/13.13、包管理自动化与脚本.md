---
title: 13ã€åŒ…ç®¡ç†è‡ªåŠ¨åŒ–ä¸è„šæœ¬
---
## ğŸ“š ç›®å½•

1. [åŒ…ç®¡ç†è‡ªåŠ¨åŒ–åŸºç¡€æ¦‚å¿µ](#1-åŒ…ç®¡ç†è‡ªåŠ¨åŒ–åŸºç¡€æ¦‚å¿µ)
2. [åŒ…ç®¡ç†è„šæœ¬ç¼–å†™](#2-åŒ…ç®¡ç†è„šæœ¬ç¼–å†™)
3. [æ‰¹é‡è½¯ä»¶éƒ¨ç½²ç­–ç•¥](#3-æ‰¹é‡è½¯ä»¶éƒ¨ç½²ç­–ç•¥)
4. [åŒ…ç®¡ç†APIæ¥å£åº”ç”¨](#4-åŒ…ç®¡ç†APIæ¥å£åº”ç”¨)
5. [è‡ªåŠ¨åŒ–æ›´æ–°ä¸ç›‘æ§](#5-è‡ªåŠ¨åŒ–æ›´æ–°ä¸ç›‘æ§)
6. [è½¯ä»¶æ¸…å•ä¸åˆè§„æ€§ç®¡ç†](#6-è½¯ä»¶æ¸…å•ä¸åˆè§„æ€§ç®¡ç†)
7. [CI/CDé›†æˆå®è·µ](#7-cicdé›†æˆå®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ åŒ…ç®¡ç†è‡ªåŠ¨åŒ–åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åŒ…ç®¡ç†è‡ªåŠ¨åŒ–


**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
åŒ…ç®¡ç†è‡ªåŠ¨åŒ–ï¼šé€šè¿‡è„šæœ¬å’Œå·¥å…·è‡ªåŠ¨å®Œæˆè½¯ä»¶åŒ…çš„å®‰è£…ã€æ›´æ–°ã€å¸è½½ç­‰æ“ä½œ
ç›®æ ‡ï¼šå‡å°‘äººå·¥å¹²é¢„ï¼Œæé«˜æ•ˆç‡ï¼Œä¿è¯ä¸€è‡´æ€§
å®ç°æ–¹å¼ï¼šè„šæœ¬ã€APIã€é…ç½®ç®¡ç†å·¥å…·ã€CI/CDæµæ°´çº¿
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦è‡ªåŠ¨åŒ–**

ç®€å•æ¥è¯´ï¼Œæ‰‹åŠ¨ç®¡ç†è½¯ä»¶åŒ…å°±åƒä¸€ä¸ªäººç®¡ç†100å°æœåŠ¡å™¨ï¼Œç´¯æ­»ä¹Ÿç®¡ä¸è¿‡æ¥ã€‚è‡ªåŠ¨åŒ–å°±æ˜¯è¯·äº†100ä¸ªåŠ©æ‰‹ï¼Œæ¯ä¸ªåŠ©æ‰‹ä¸“é—¨è´Ÿè´£ä¸€å°æœåŠ¡å™¨ã€‚

```
æ‰‹åŠ¨ç®¡ç†çš„é—®é¢˜ï¼š
â€¢ æ—¶é—´æ¶ˆè€—å¤§ï¼šé€å°æœåŠ¡å™¨æ“ä½œ
â€¢ å®¹æ˜“å‡ºé”™ï¼šäººå·¥æ“ä½œéš¾å…ç–å¿½
â€¢ ä¸ä¸€è‡´æ€§ï¼šä¸åŒæœåŠ¡å™¨å¯èƒ½ç‰ˆæœ¬ä¸åŒ
â€¢ éš¾ä»¥è¿½è¸ªï¼šæ— æ³•çŸ¥é“è°æ”¹äº†ä»€ä¹ˆ

è‡ªåŠ¨åŒ–çš„ä¼˜åŠ¿ï¼š
â€¢ æ‰¹é‡æ“ä½œï¼šä¸€æ¬¡è„šæœ¬ï¼Œå¤šå°æ‰§è¡Œ
â€¢ æ ‡å‡†åŒ–ï¼šæ‰€æœ‰æœåŠ¡å™¨æ‰§è¡Œç›¸åŒæ“ä½œ
â€¢ å¯è¿½æº¯ï¼šæ“ä½œæ—¥å¿—å®Œæ•´è®°å½•
â€¢ å¯é‡å¤ï¼šç›¸åŒç¯å¢ƒå¯é‡å¤æ„å»º
```

### 1.2 è‡ªåŠ¨åŒ–çš„æ ¸å¿ƒç»„ä»¶


**ğŸ—ï¸ åŸºç¡€æ¶æ„**
```
é…ç½®ç®¡ç†å±‚
    â†“
è„šæœ¬æ‰§è¡Œå±‚ â† â†’ æ—¥å¿—ç›‘æ§å±‚
    â†“
åŒ…ç®¡ç†å·¥å…·å±‚ (yum/apt/dnf)
    â†“
æ“ä½œç³»ç»Ÿå±‚
```

**ğŸ”§ å…³é”®ç»„ä»¶è§£æ**

- **é…ç½®ç®¡ç†å±‚**ï¼šå®šä¹‰è¦å®‰è£…ä»€ä¹ˆè½¯ä»¶ï¼Œä»€ä¹ˆç‰ˆæœ¬
- **è„šæœ¬æ‰§è¡Œå±‚**ï¼šå…·ä½“æ‰§è¡Œå®‰è£…ã€æ›´æ–°ç­‰æ“ä½œ
- **æ—¥å¿—ç›‘æ§å±‚**ï¼šè®°å½•æ“ä½œè¿‡ç¨‹ï¼Œç›‘æ§æ‰§è¡Œç»“æœ
- **åŒ…ç®¡ç†å·¥å…·å±‚**ï¼šåº•å±‚çš„rpmã€aptã€yumç­‰å·¥å…·

---

## 2. ğŸ“ åŒ…ç®¡ç†è„šæœ¬ç¼–å†™


### 2.1 åŸºç¡€è„šæœ¬ç»“æ„


**ğŸ¯ æ ‡å‡†è„šæœ¬æ¨¡æ¿**
```bash
#!/bin/bash
# è½¯ä»¶åŒ…ç®¡ç†è„šæœ¬æ¨¡æ¿

# åŸºç¡€é…ç½®
SCRIPT_NAME="package_manager"
LOG_FILE="/var/log/${SCRIPT_NAME}.log"
PACKAGE_LIST="packages.txt"

# æ—¥å¿—å‡½æ•°
log_info() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] INFO: $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $1" | tee -a "$LOG_FILE"
}

# æ£€æµ‹ç³»ç»Ÿç±»å‹
detect_os() {
    if command -v yum >/dev/null 2>&1; then
        echo "rhel"
    elif command -v apt >/dev/null 2>&1; then
        echo "debian"
    else
        echo "unknown"
    fi
}

# å®‰è£…è½¯ä»¶åŒ…
install_package() {
    local package=$1
    local os_type=$(detect_os)
    
    case $os_type in
        "rhel")
            yum install -y "$package"
            ;;
        "debian")
            apt-get install -y "$package"
            ;;
        *)
            log_error "ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ"
            return 1
            ;;
    esac
}
```

**ğŸ’¡ è„šæœ¬ç¼–å†™è¦ç‚¹**

è¿™ä¸ªæ¨¡æ¿å°±åƒå»ºæˆ¿å­çš„è“å›¾ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½æœ‰ç‰¹å®šä½œç”¨ï¼š
- **é…ç½®éƒ¨åˆ†**ï¼šå°±åƒæˆ¿å­çš„åœ°åŸºï¼Œå®šä¹‰åŸºæœ¬ä¿¡æ¯
- **æ—¥å¿—å‡½æ•°**ï¼šå°±åƒç›‘æ§æ‘„åƒå¤´ï¼Œè®°å½•å‘ç”Ÿäº†ä»€ä¹ˆ
- **æ£€æµ‹å‡½æ•°**ï¼šå°±åƒè¯†åˆ«ç³»ç»Ÿï¼ŒçŸ¥é“åœ¨ä»€ä¹ˆç¯å¢ƒä¸‹å·¥ä½œ
- **æ“ä½œå‡½æ•°**ï¼šå°±åƒå…·ä½“çš„æ–½å·¥é˜Ÿï¼Œæ‰§è¡Œå®é™…å·¥ä½œ

### 2.2 æ‰¹é‡å®‰è£…è„šæœ¬


**ğŸ”„ æ‰¹é‡å¤„ç†å®ç°**
```bash
# æ‰¹é‡å®‰è£…è„šæœ¬ç¤ºä¾‹
batch_install() {
    local package_file=$1
    
    if [[ ! -f "$package_file" ]]; then
        log_error "è½¯ä»¶åŒ…åˆ—è¡¨æ–‡ä»¶ä¸å­˜åœ¨: $package_file"
        return 1
    fi
    
    # è¯»å–å¹¶å®‰è£…æ¯ä¸ªåŒ…
    while IFS= read -r package; do
        # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
        [[ -z "$package" || "$package" =~ ^# ]] && continue
        
        log_info "å¼€å§‹å®‰è£…: $package"
        if install_package "$package"; then
            log_info "å®‰è£…æˆåŠŸ: $package"
        else
            log_error "å®‰è£…å¤±è´¥: $package"
        fi
    done < "$package_file"
}
```

**ğŸ“‹ è½¯ä»¶åŒ…åˆ—è¡¨æ ¼å¼**
```
# packages.txt æ–‡ä»¶ç¤ºä¾‹
# WebæœåŠ¡ç›¸å…³
nginx
apache2
php

# æ•°æ®åº“ç›¸å…³
mysql-server
postgresql

# å¼€å‘å·¥å…·
git
vim
curl
```

### 2.3 é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶


**âš¡ æ™ºèƒ½é‡è¯•è„šæœ¬**
```bash
# å¸¦é‡è¯•æœºåˆ¶çš„å®‰è£…å‡½æ•°
install_with_retry() {
    local package=$1
    local max_retry=3
    local retry_count=0
    
    while [ $retry_count -lt $max_retry ]; do
        log_info "å°è¯•å®‰è£… $package (ç¬¬ $((retry_count + 1)) æ¬¡)"
        
        if install_package "$package"; then
            log_info "å®‰è£…æˆåŠŸ: $package"
            return 0
        else
            retry_count=$((retry_count + 1))
            if [ $retry_count -lt $max_retry ]; then
                log_info "ç­‰å¾…30ç§’åé‡è¯•..."
                sleep 30
            fi
        fi
    done
    
    log_error "å®‰è£…å¤±è´¥ï¼Œå·²é‡è¯• $max_retry æ¬¡: $package"
    return 1
}
```

---

## 3. ğŸš€ æ‰¹é‡è½¯ä»¶éƒ¨ç½²ç­–ç•¥


### 3.1 éƒ¨ç½²ç­–ç•¥æ¦‚è¿°


**ğŸ¯ éƒ¨ç½²ç­–ç•¥ç±»å‹**

| ç­–ç•¥ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|----------|------------|---------|---------|
| ğŸ”„ **å…¨é‡éƒ¨ç½²** | `æµ‹è¯•ç¯å¢ƒï¼Œå°è§„æ¨¡` | `ç®€å•ç›´æ¥ï¼Œå¿«é€Ÿå®Œæˆ` | `é£é™©å¤§ï¼Œå›æ»šå›°éš¾` |
| ğŸ¯ **åˆ†æ‰¹éƒ¨ç½²** | `ç”Ÿäº§ç¯å¢ƒï¼Œå¤§è§„æ¨¡` | `é£é™©å¯æ§ï¼Œå¯é€æ­¥éªŒè¯` | `è€—æ—¶é•¿ï¼Œç®¡ç†å¤æ‚` |
| ğŸ”€ **è“ç»¿éƒ¨ç½²** | `å…³é”®ä¸šåŠ¡ç³»ç»Ÿ` | `é›¶åœæœºï¼Œå¿«é€Ÿå›æ»š` | `èµ„æºæ¶ˆè€—å¤§` |
| ğŸŒŠ **æ»šåŠ¨éƒ¨ç½²** | `é›†ç¾¤ç¯å¢ƒ` | `å¹³æ»‘å‡çº§ï¼ŒæŒç»­æœåŠ¡` | `éƒ¨ç½²æ—¶é—´é•¿` |

### 3.2 åˆ†æ‰¹éƒ¨ç½²å®ç°


**ğŸ“Š åˆ†æ‰¹éƒ¨ç½²è„šæœ¬**
```bash
# åˆ†æ‰¹éƒ¨ç½²ç®¡ç†è„šæœ¬
rolling_deployment() {
    local server_list=("server1" "server2" "server3" "server4")
    local batch_size=2
    local total_servers=${#server_list[@]}
    
    log_info "å¼€å§‹åˆ†æ‰¹éƒ¨ç½²ï¼Œæ€»æœåŠ¡å™¨æ•°: $total_serversï¼Œæ‰¹æ¬¡å¤§å°: $batch_size"
    
    # åˆ†æ‰¹å¤„ç†
    for ((i=0; i<total_servers; i+=batch_size)); do
        local batch_num=$((i/batch_size + 1))
        log_info "å¼€å§‹ç¬¬ $batch_num æ‰¹éƒ¨ç½²"
        
        # å½“å‰æ‰¹æ¬¡çš„æœåŠ¡å™¨
        for ((j=i; j<i+batch_size && j<total_servers; j++)); do
            local server=${server_list[j]}
            log_info "éƒ¨ç½²åˆ°æœåŠ¡å™¨: $server"
            
            # è¿œç¨‹æ‰§è¡Œéƒ¨ç½²
            ssh "$server" "bash -s" < deploy_script.sh
            
            if [ $? -eq 0 ]; then
                log_info "æœåŠ¡å™¨ $server éƒ¨ç½²æˆåŠŸ"
            else
                log_error "æœåŠ¡å™¨ $server éƒ¨ç½²å¤±è´¥"
                # å¯ä»¥é€‰æ‹©åœæ­¢æˆ–ç»§ç»­
                read -p "æ˜¯å¦ç»§ç»­éƒ¨ç½²ï¼Ÿ(y/n): " continue_deploy
                [[ "$continue_deploy" != "y" ]] && return 1
            fi
        done
        
        # æ‰¹æ¬¡é—´æš‚åœ
        if [ $((i + batch_size)) -lt $total_servers ]; then
            log_info "æ‰¹æ¬¡éƒ¨ç½²å®Œæˆï¼Œç­‰å¾…60ç§’..."
            sleep 60
        fi
    done
}
```

### 3.3 ç¯å¢ƒä¸€è‡´æ€§ä¿è¯


**ğŸ” ç¯å¢ƒæ£€æŸ¥è„šæœ¬**
```bash
# ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥
check_environment() {
    local target_server=$1
    
    log_info "æ£€æŸ¥æœåŠ¡å™¨ç¯å¢ƒ: $target_server"
    
    # æ£€æŸ¥æ“ä½œç³»ç»Ÿç‰ˆæœ¬
    local os_version=$(ssh "$target_server" "cat /etc/os-release | grep VERSION_ID")
    log_info "$target_server OSç‰ˆæœ¬: $os_version"
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    local disk_usage=$(ssh "$target_server" "df -h / | tail -1 | awk '{print \$5}'")
    log_info "$target_server ç£ç›˜ä½¿ç”¨ç‡: $disk_usage"
    
    # æ£€æŸ¥å†…å­˜
    local memory=$(ssh "$target_server" "free -h | grep Mem")
    log_info "$target_server å†…å­˜çŠ¶æ€: $memory"
    
    # æ£€æŸ¥å¿…è¦çš„å‘½ä»¤æ˜¯å¦å­˜åœ¨
    local required_commands=("curl" "wget" "systemctl")
    for cmd in "${required_commands[@]}"; do
        if ! ssh "$target_server" "command -v $cmd >/dev/null 2>&1"; then
            log_error "$target_server ç¼ºå°‘å¿…è¦å‘½ä»¤: $cmd"
            return 1
        fi
    done
    
    log_info "$target_server ç¯å¢ƒæ£€æŸ¥é€šè¿‡"
    return 0
}
```

---

## 4. ğŸ”Œ åŒ…ç®¡ç†APIæ¥å£åº”ç”¨


### 4.1 REST APIåŸºç¡€åº”ç”¨


**ğŸŒ APIæ¥å£æ¦‚å¿µ**

åŒ…ç®¡ç†APIå°±åƒé¤å…çš„ç‚¹é¤ç³»ç»Ÿï¼Œä½ ä¸éœ€è¦å»å¨æˆ¿ï¼Œåªè¦å‘Šè¯‰æœåŠ¡å‘˜ä½ è¦ä»€ä¹ˆï¼Œç³»ç»Ÿå°±ä¼šå¸®ä½ å¤„ç†ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼šç›´æ¥æ“ä½œ â†’ yum install nginx
APIæ–¹å¼ï¼šå‘é€è¯·æ±‚ â†’ POST /api/packages {"name": "nginx", "action": "install"}
```

**ğŸ’» Python APIå®¢æˆ·ç«¯ç¤ºä¾‹**
```python
#!/usr/bin/env python3
import requests
import json

class PackageManager:
    def __init__(self, base_url, token=None):
        self.base_url = base_url
        self.headers = {'Content-Type': 'application/json'}
        if token:
            self.headers['Authorization'] = f'Bearer {token}'
    
    def install_package(self, package_name, version=None):
        """å®‰è£…è½¯ä»¶åŒ…"""
        data = {
            'action': 'install',
            'package': package_name
        }
        if version:
            data['version'] = version
        
        response = requests.post(
            f'{self.base_url}/packages',
            headers=self.headers,
            json=data
        )
        return response.json()
    
    def get_package_status(self, package_name):
        """æŸ¥è¯¢åŒ…çŠ¶æ€"""
        response = requests.get(
            f'{self.base_url}/packages/{package_name}',
            headers=self.headers
        )
        return response.json()

# ä½¿ç”¨ç¤ºä¾‹
pm = PackageManager('http://localhost:8080/api')
result = pm.install_package('nginx')
print(f"å®‰è£…ç»“æœ: {result}")
```

### 4.2 æ‰¹é‡æ“ä½œAPI


**ğŸ”„ æ‰¹é‡å¤„ç†å®ç°**
```python
def batch_install_packages(self, package_list):
    """æ‰¹é‡å®‰è£…è½¯ä»¶åŒ…"""
    results = []
    
    for package_info in package_list:
        if isinstance(package_info, str):
            # ç®€å•åŒ…å
            result = self.install_package(package_info)
        else:
            # åŒ…å«ç‰ˆæœ¬ä¿¡æ¯çš„å­—å…¸
            result = self.install_package(
                package_info['name'], 
                package_info.get('version')
            )
        
        results.append({
            'package': package_info,
            'result': result
        })
        
        # æ·»åŠ å»¶è¿Ÿé¿å…è¿‡è½½
        time.sleep(1)
    
    return results

# ä½¿ç”¨ç¤ºä¾‹
packages = [
    'nginx',
    {'name': 'mysql-server', 'version': '8.0'},
    'git'
]

pm = PackageManager('http://localhost:8080/api')
results = pm.batch_install_packages(packages)
```

---

## 5. âš¡ è‡ªåŠ¨åŒ–æ›´æ–°ä¸ç›‘æ§


### 5.1 è‡ªåŠ¨æ›´æ–°ç­–ç•¥


**ğŸ• å®šæ—¶æ›´æ–°è„šæœ¬**
```bash
#!/bin/bash
# è‡ªåŠ¨æ›´æ–°è„šæœ¬

UPDATE_LOG="/var/log/auto_update.log"
MAINTENANCE_WINDOW_START="02:00"
MAINTENANCE_WINDOW_END="04:00"

# æ£€æŸ¥æ˜¯å¦åœ¨ç»´æŠ¤çª—å£
is_maintenance_window() {
    local current_time=$(date +%H:%M)
    local start_time="$MAINTENANCE_WINDOW_START"
    local end_time="$MAINTENANCE_WINDOW_END"
    
    # ç®€å•æ—¶é—´æ¯”è¾ƒ
    if [[ "$current_time" > "$start_time" && "$current_time" < "$end_time" ]]; then
        return 0
    else
        return 1
    fi
}

# å®‰å…¨æ›´æ–°æ£€æŸ¥
safe_update() {
    log_info "å¼€å§‹å®‰å…¨æ›´æ–°æ£€æŸ¥"
    
    # æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
    local load=$(uptime | awk -F'load average:' '{print $2}' | cut -d',' -f1 | tr -d ' ')
    if (( $(echo "$load > 2.0" | bc -l) )); then
        log_error "ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ ($load)ï¼Œè·³è¿‡æ›´æ–°"
        return 1
    fi
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    local disk_free=$(df / | awk 'NR==2 {print $4}')
    if [ "$disk_free" -lt 1000000 ]; then  # å°äº1GB
        log_error "ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œè·³è¿‡æ›´æ–°"
        return 1
    fi
    
    log_info "ç³»ç»ŸçŠ¶æ€æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥è¿›è¡Œæ›´æ–°"
    return 0
}

# æ‰§è¡Œæ›´æ–°
perform_update() {
    if ! is_maintenance_window; then
        log_info "ä¸åœ¨ç»´æŠ¤çª—å£å†…ï¼Œè·³è¿‡æ›´æ–°"
        return 0
    fi
    
    if ! safe_update; then
        return 1
    fi
    
    log_info "å¼€å§‹ç³»ç»Ÿæ›´æ–°"
    
    # åˆ›å»ºç³»ç»Ÿå¿«ç…§ï¼ˆå¦‚æœæ”¯æŒï¼‰
    if command -v snapper >/dev/null 2>&1; then
        snapper create --description "Before auto update"
    fi
    
    # æ‰§è¡Œæ›´æ–°
    if command -v dnf >/dev/null 2>&1; then
        dnf update -y
    elif command -v yum >/dev/null 2>&1; then
        yum update -y
    elif command -v apt >/dev/null 2>&1; then
        apt update && apt upgrade -y
    fi
    
    local update_result=$?
    
    if [ $update_result -eq 0 ]; then
        log_info "ç³»ç»Ÿæ›´æ–°å®Œæˆ"
        # å‘é€æˆåŠŸé€šçŸ¥
        send_notification "success" "ç³»ç»Ÿæ›´æ–°æˆåŠŸå®Œæˆ"
    else
        log_error "ç³»ç»Ÿæ›´æ–°å¤±è´¥"
        # å‘é€å¤±è´¥é€šçŸ¥
        send_notification "error" "ç³»ç»Ÿæ›´æ–°å¤±è´¥ï¼Œéœ€è¦äººå·¥å¹²é¢„"
    fi
    
    return $update_result
}
```

### 5.2 åŒ…çŠ¶æ€ç›‘æ§


**ğŸ“Š ç›‘æ§è„šæœ¬å®ç°**
```bash
# åŒ…çŠ¶æ€ç›‘æ§è„šæœ¬
monitor_packages() {
    local critical_packages=("nginx" "mysql-server" "sshd")
    local report_file="/tmp/package_status_report.txt"
    
    echo "=== è½¯ä»¶åŒ…çŠ¶æ€æŠ¥å‘Š $(date) ===" > "$report_file"
    
    for package in "${critical_packages[@]}"; do
        echo "æ£€æŸ¥åŒ…: $package" >> "$report_file"
        
        # æ£€æŸ¥åŒ…æ˜¯å¦å®‰è£…
        if rpm -q "$package" >/dev/null 2>&1 || dpkg -l "$package" >/dev/null 2>&1; then
            echo "  çŠ¶æ€: å·²å®‰è£…" >> "$report_file"
            
            # æ£€æŸ¥ç‰ˆæœ¬
            if command -v rpm >/dev/null 2>&1; then
                local version=$(rpm -q "$package")
                echo "  ç‰ˆæœ¬: $version" >> "$report_file"
            fi
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            if systemctl is-active "$package" >/dev/null 2>&1; then
                echo "  æœåŠ¡: è¿è¡Œä¸­" >> "$report_file"
            else
                echo "  æœåŠ¡: æœªè¿è¡Œ" >> "$report_file"
            fi
        else
            echo "  çŠ¶æ€: æœªå®‰è£…" >> "$report_file"
        fi
        echo "" >> "$report_file"
    done
    
    # å‘é€æŠ¥å‘Š
    cat "$report_file"
}
```

---

## 6. ğŸ“‹ è½¯ä»¶æ¸…å•ä¸åˆè§„æ€§ç®¡ç†


### 6.1 è½¯ä»¶æ¸…å•ç”Ÿæˆ


**ğŸ“ æ¸…å•ç®¡ç†è„šæœ¬**
```bash
# ç”Ÿæˆè½¯ä»¶æ¸…å•
generate_inventory() {
    local output_file="/tmp/software_inventory.json"
    local temp_file="/tmp/packages_raw.txt"
    
    log_info "ç”Ÿæˆè½¯ä»¶æ¸…å•"
    
    # è·å–å·²å®‰è£…åŒ…åˆ—è¡¨
    if command -v rpm >/dev/null 2>&1; then
        rpm -qa --queryformat '%{NAME}|%{VERSION}|%{RELEASE}|%{INSTALLTIME:date}\n' > "$temp_file"
    elif command -v dpkg >/dev/null 2>&1; then
        dpkg-query -W -f='${Package}|${Version}|${Status}\n' > "$temp_file"
    fi
    
    # è½¬æ¢ä¸ºJSONæ ¼å¼
    echo "{" > "$output_file"
    echo "  \"hostname\": \"$(hostname)\"," >> "$output_file"
    echo "  \"scan_time\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"," >> "$output_file"
    echo "  \"packages\": [" >> "$output_file"
    
    local first_package=true
    while IFS='|' read -r name version release install_time; do
        if [ "$first_package" = true ]; then
            first_package=false
        else
            echo "," >> "$output_file"
        fi
        
        echo "    {" >> "$output_file"
        echo "      \"name\": \"$name\"," >> "$output_file"
        echo "      \"version\": \"$version\"," >> "$output_file"
        echo "      \"release\": \"$release\"," >> "$output_file"
        echo "      \"install_time\": \"$install_time\"" >> "$output_file"
        echo "    }" >> "$output_file" | tr -d '\n'
    done < "$temp_file"
    
    echo "" >> "$output_file"
    echo "  ]" >> "$output_file"
    echo "}" >> "$output_file"
    
    log_info "è½¯ä»¶æ¸…å•å·²ç”Ÿæˆ: $output_file"
}
```

### 6.2 åˆè§„æ€§æ£€æŸ¥


**ğŸ” åˆè§„æ€§æ£€æŸ¥å®ç°**
```python
#!/usr/bin/env python3
import json
import yaml

class ComplianceChecker:
    def __init__(self, policy_file):
        """åˆå§‹åŒ–åˆè§„æ£€æŸ¥å™¨"""
        with open(policy_file, 'r') as f:
            self.policy = yaml.safe_load(f)
    
    def check_compliance(self, inventory_file):
        """æ£€æŸ¥ç³»ç»Ÿåˆè§„æ€§"""
        with open(inventory_file, 'r') as f:
            inventory = json.load(f)
        
        results = {
            'hostname': inventory['hostname'],
            'check_time': inventory['scan_time'],
            'compliance_status': 'PASS',
            'violations': [],
            'recommendations': []
        }
        
        # æ£€æŸ¥å¿…éœ€çš„è½¯ä»¶åŒ…
        self._check_required_packages(inventory['packages'], results)
        
        # æ£€æŸ¥ç¦æ­¢çš„è½¯ä»¶åŒ…
        self._check_forbidden_packages(inventory['packages'], results)
        
        # æ£€æŸ¥ç‰ˆæœ¬åˆè§„æ€§
        self._check_version_compliance(inventory['packages'], results)
        
        if results['violations']:
            results['compliance_status'] = 'FAIL'
        
        return results
    
    def _check_required_packages(self, packages, results):
        """æ£€æŸ¥å¿…éœ€çš„è½¯ä»¶åŒ…"""
        installed_packages = {pkg['name'] for pkg in packages}
        required_packages = set(self.policy.get('required_packages', []))
        
        missing_packages = required_packages - installed_packages
        for package in missing_packages:
            results['violations'].append({
                'type': 'missing_required_package',
                'package': package,
                'severity': 'HIGH'
            })
    
    def _check_forbidden_packages(self, packages, results):
        """æ£€æŸ¥ç¦æ­¢çš„è½¯ä»¶åŒ…"""
        installed_packages = {pkg['name'] for pkg in packages}
        forbidden_packages = set(self.policy.get('forbidden_packages', []))
        
        found_forbidden = installed_packages & forbidden_packages
        for package in found_forbidden:
            results['violations'].append({
                'type': 'forbidden_package_found',
                'package': package,
                'severity': 'CRITICAL'
            })
```

**ğŸ“„ ç­–ç•¥é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼ˆpolicy.yamlï¼‰**
```yaml
# åˆè§„ç­–ç•¥é…ç½®
required_packages:
  - openssh-server
  - fail2ban
  - rsyslog
  - chrony

forbidden_packages:
  - telnet-server
  - rsh-server
  - ftp

version_requirements:
  openssl:
    min_version: "1.1.1"
  nginx:
    max_version: "1.20.*"
    
security_updates:
  auto_install: true
  reboot_required: false
  maintenance_window: "02:00-04:00"
```

---

## 7. ğŸ”„ CI/CDé›†æˆå®è·µ


### 7.1 GitLab CIé›†æˆ


**âš™ï¸ CI/CDé…ç½®ç¤ºä¾‹**
```yaml
# .gitlab-ci.yml
stages:
  - validate
  - build
  - deploy
  - verify

variables:
  PACKAGE_LIST_FILE: "deployment/packages.txt"
  INVENTORY_DIR: "inventory"

# éªŒè¯åŒ…åˆ—è¡¨æ ¼å¼
validate_packages:
  stage: validate
  script:
    - echo "éªŒè¯è½¯ä»¶åŒ…åˆ—è¡¨æ ¼å¼"
    - python3 scripts/validate_packages.py $PACKAGE_LIST_FILE
  only:
    changes:
      - deployment/packages.txt

# æ„å»ºéƒ¨ç½²åŒ…
build_deployment:
  stage: build
  script:
    - mkdir -p artifacts
    - cp deployment/* artifacts/
    - cp scripts/* artifacts/
    - tar -czf deployment-${CI_COMMIT_SHORT_SHA}.tar.gz artifacts/
  artifacts:
    paths:
      - deployment-${CI_COMMIT_SHORT_SHA}.tar.gz
    expire_in: 1 week

# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
deploy_test:
  stage: deploy
  script:
    - echo "éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ"
    - ansible-playbook -i inventory/test playbooks/deploy-packages.yml
  environment:
    name: test
  only:
    - develop

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
deploy_production:
  stage: deploy
  script:
    - echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
    - ansible-playbook -i inventory/production playbooks/deploy-packages.yml
  environment:
    name: production
  when: manual
  only:
    - main

# éƒ¨ç½²åéªŒè¯
verify_deployment:
  stage: verify
  script:
    - python3 scripts/verify_deployment.py
    - python3 scripts/compliance_check.py
  dependencies:
    - deploy_production
```

### 7.2 Ansibleé›†æˆ


**ğŸ“‹ Ansible Playbookç¤ºä¾‹**
```yaml
# playbooks/deploy-packages.yml
---
- name: è‡ªåŠ¨åŒ–è½¯ä»¶åŒ…éƒ¨ç½²
  hosts: all
  become: yes
  vars:
    package_list_file: "../deployment/packages.txt"
    log_dir: "/var/log/ansible-deployment"
  
  tasks:
    - name: åˆ›å»ºæ—¥å¿—ç›®å½•
      file:
        path: "{{ log_dir }}"
        state: directory
        mode: '0755'
    
    - name: æ›´æ–°åŒ…ç®¡ç†å™¨ç¼“å­˜
      package:
        update_cache: yes
      register: cache_update
    
    - name: è¯»å–è½¯ä»¶åŒ…åˆ—è¡¨
      set_fact:
        packages_to_install: "{{ lookup('file', package_list_file).split('\n') | select('match', '^[^#].*') | list }}"
    
    - name: å®‰è£…è½¯ä»¶åŒ…
      package:
        name: "{{ item }}"
        state: present
      loop: "{{ packages_to_install }}"
      register: package_install_result
      ignore_errors: yes
    
    - name: è®°å½•å®‰è£…ç»“æœ
      lineinfile:
        path: "{{ log_dir }}/package_install.log"
        line: "{{ ansible_date_time.iso8601 }} - {{ item.item }} - {{ 'SUCCESS' if item.changed else 'FAILED' }}"
        create: yes
      loop: "{{ package_install_result.results }}"
    
    - name: ç”Ÿæˆå®‰è£…æŠ¥å‘Š
      template:
        src: install_report.j2
        dest: "{{ log_dir }}/install_report_{{ ansible_date_time.epoch }}.html"
    
    - name: å¯åŠ¨ç›¸å…³æœåŠ¡
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - nginx
        - mysql
      ignore_errors: yes
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ¯ åŒ…ç®¡ç†è‡ªåŠ¨åŒ–ï¼šé€šè¿‡è„šæœ¬å’Œå·¥å…·è‡ªåŠ¨ç®¡ç†è½¯ä»¶åŒ…
ğŸ”§ æ‰¹é‡éƒ¨ç½²ï¼šä¸€æ¬¡æ“ä½œï¼Œå¤šå°æœåŠ¡å™¨åŒæ­¥æ‰§è¡Œ
ğŸ“Š çŠ¶æ€ç›‘æ§ï¼šå®æ—¶è·Ÿè¸ªè½¯ä»¶åŒ…çŠ¶æ€å’Œç³»ç»Ÿå¥åº·
ğŸ” åˆè§„æ£€æŸ¥ï¼šç¡®ä¿ç³»ç»Ÿç¬¦åˆå®‰å…¨å’Œç®¡ç†è¦æ±‚
ğŸ”„ CI/CDé›†æˆï¼šå°†åŒ…ç®¡ç†çº³å…¥æŒç»­é›†æˆæµç¨‹
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è‡ªåŠ¨åŒ–çš„ä»·å€¼ä½“ç°**
```
æ•ˆç‡æå‡ï¼š
â€¢ æ‰‹åŠ¨æ“ä½œ1å°æœåŠ¡å™¨éœ€è¦10åˆ†é’Ÿ
â€¢ è‡ªåŠ¨åŒ–æ“ä½œ100å°æœåŠ¡å™¨åªéœ€è¦15åˆ†é’Ÿ
â€¢ æ—¶é—´æ•ˆç‡æå‡å‡ åå€

ä¸€è‡´æ€§ä¿è¯ï¼š
â€¢ æ‰€æœ‰æœåŠ¡å™¨æ‰§è¡Œç›¸åŒæ“ä½œ
â€¢ é¿å…äººä¸ºå·®å¼‚å’Œé”™è¯¯
â€¢ ç¯å¢ƒæ ‡å‡†åŒ–ç®¡ç†

å¯è¿½æº¯æ€§ï¼š
â€¢ å®Œæ•´çš„æ“ä½œæ—¥å¿—
â€¢ è°åœ¨ä»€ä¹ˆæ—¶å€™åšäº†ä»€ä¹ˆæ“ä½œ
â€¢ é—®é¢˜å›æº¯å’Œè´£ä»»ç•Œå®š
```

**ğŸ”¹ è„šæœ¬ç¼–å†™æœ€ä½³å®è·µ**
```
ç»“æ„åŒ–è®¾è®¡ï¼š
â€¢ æ¨¡å—åŒ–å‡½æ•°è®¾è®¡
â€¢ ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼
â€¢ å®Œå–„çš„é”™è¯¯å¤„ç†

å®‰å…¨æ€§è€ƒè™‘ï¼š
â€¢ æƒé™æ£€æŸ¥
â€¢ è¾“å…¥éªŒè¯
â€¢ æ“ä½œç¡®è®¤æœºåˆ¶

å¯ç»´æŠ¤æ€§ï¼š
â€¢ æ¸…æ™°çš„ä»£ç æ³¨é‡Š
â€¢ é…ç½®ä¸ä»£ç åˆ†ç¦»
â€¢ ç‰ˆæœ¬æ§åˆ¶ç®¡ç†
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **å¤§è§„æ¨¡éƒ¨ç½²**ï¼šæ–°æœåŠ¡å™¨æ‰¹é‡åˆå§‹åŒ–é…ç½®
- **å®‰å…¨æ›´æ–°**ï¼šç´§æ€¥å®‰å…¨è¡¥ä¸å¿«é€Ÿæ¨é€
- **ç¯å¢ƒåŒæ­¥**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒä¸€è‡´æ€§
- **åˆè§„ç®¡ç†**ï¼šä¼ä¸šè½¯ä»¶èµ„äº§ç®¡ç†å’Œå®¡è®¡

**ğŸ”§ è¿ç»´å®è·µ**
- **æ ‡å‡†åŒ–è¿ç»´**ï¼šç»Ÿä¸€çš„æ“ä½œè§„èŒƒå’Œæµç¨‹
- **é£é™©æ§åˆ¶**ï¼šåˆ†æ‰¹éƒ¨ç½²å’Œè‡ªåŠ¨å›æ»šæœºåˆ¶
- **æ•ˆç‡æå‡**ï¼šå‡å°‘é‡å¤æ€§æ‰‹å·¥æ“ä½œ
- **è´¨é‡ä¿è¯**ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•å’ŒéªŒè¯æµç¨‹

### 8.4 å­¦ä¹ è·¯å¾„å»ºè®®


```
ğŸ¯ å­¦ä¹ å±‚æ¬¡ï¼š
Level 1: åŸºç¡€è„šæœ¬ç¼–å†™ï¼Œç®€å•çš„åŒ…å®‰è£…è„šæœ¬
Level 2: æ‰¹é‡æ“ä½œå’Œé”™è¯¯å¤„ç†æœºåˆ¶
Level 3: APIé›†æˆå’Œç›‘æ§å‘Šè­¦
Level 4: CI/CDé›†æˆå’Œä¼ä¸šçº§åº”ç”¨

ğŸ›¤ï¸ å®è·µå»ºè®®ï¼š
1. ä»ç®€å•çš„å•æœºè„šæœ¬å¼€å§‹
2. é€æ­¥æ‰©å±•åˆ°å¤šæœºæ‰¹é‡æ“ä½œ
3. åŠ å…¥ç›‘æ§å’ŒæŠ¥å‘ŠåŠŸèƒ½
4. æœ€åé›†æˆåˆ°CI/CDæµæ°´çº¿
```

**ğŸ”‘ æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- åŒ…ç®¡ç†è‡ªåŠ¨åŒ–æ˜¯è¿ç»´æ•ˆç‡æå‡çš„å…³é”®
- è„šæœ¬ç¼–å†™è¦è€ƒè™‘é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- æ‰¹é‡æ“ä½œéœ€è¦åˆ†æ‰¹æ‰§è¡Œå’Œé£é™©æ§åˆ¶
- APIæ¥å£æä¾›æ›´çµæ´»çš„é›†æˆæ–¹å¼
- ç›‘æ§å’Œåˆè§„æ£€æŸ¥ä¿è¯ç³»ç»Ÿç¨³å®šæ€§
- CI/CDé›†æˆå®ç°ç«¯åˆ°ç«¯è‡ªåŠ¨åŒ–æµç¨‹

**å®ç”¨å£è¯€**ï¼š
- è„šæœ¬å…ˆè¡Œæ—¥å¿—å…¨ï¼Œé”™è¯¯å¤„ç†è¦å®Œå–„
- æ‰¹é‡æ“ä½œåˆ†æ­¥éª¤ï¼Œç›‘æ§å‘Šè­¦ä¸å¯å°‘
- APIé›†æˆæ›´çµæ´»ï¼ŒCI/CDæµç¨‹è¦è§„èŒƒ