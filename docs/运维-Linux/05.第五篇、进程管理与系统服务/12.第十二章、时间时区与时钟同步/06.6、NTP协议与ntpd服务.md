---
title: 6ã€NTPåè®®ä¸ntpdæœåŠ¡
---
## ğŸ“š ç›®å½•

1. [NTPåè®®åŸºç¡€æ¦‚å¿µ](#1-NTPåè®®åŸºç¡€æ¦‚å¿µ)
2. [NTPåè®®ç‰ˆæœ¬ä¸ç‰¹æ€§](#2-NTPåè®®ç‰ˆæœ¬ä¸ç‰¹æ€§)
3. [ntpdæœåŠ¡è¯¦è§£](#3-ntpdæœåŠ¡è¯¦è§£)
4. [é…ç½®æ–‡ä»¶æ ¼å¼è¯¦è§£](#4-é…ç½®æ–‡ä»¶æ ¼å¼è¯¦è§£)
5. [è®¿é—®æ§åˆ¶ä¸å®‰å…¨é…ç½®](#5-è®¿é—®æ§åˆ¶ä¸å®‰å…¨é…ç½®)
6. [NTPçŠ¶æ€ç›‘æ§å·¥å…·](#6-NTPçŠ¶æ€ç›‘æ§å·¥å…·)
7. [å®æˆ˜é…ç½®æ¡ˆä¾‹](#7-å®æˆ˜é…ç½®æ¡ˆä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ•°ï¸ NTPåè®®åŸºç¡€æ¦‚å¿µ


### 1.1 NTPæ˜¯ä»€ä¹ˆ


**ğŸ”¸ NTPï¼ˆNetwork Time Protocolï¼‰** 
- **é€šä¿—è§£é‡Š**: ç½‘ç»œæ—¶é—´åè®®ï¼Œå°±åƒç½‘ç»œä¸­çš„"æ ‡å‡†é’Ÿè¡¨"
- **æ ¸å¿ƒä½œç”¨**: è®©ç½‘ç»œä¸­æ‰€æœ‰è®¡ç®—æœºçš„æ—¶é—´ä¿æŒä¸€è‡´
- **å·¥ä½œåŸç†**: å®¢æˆ·ç«¯å‘æœåŠ¡å™¨è¯¢é—®å‡†ç¡®æ—¶é—´ï¼Œç„¶åè°ƒæ•´è‡ªå·±çš„æ—¶é’Ÿ

> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**  
> å°±åƒä»¥å‰å®¶å®¶æˆ·æˆ·éƒ½è¦å¯¹é’Ÿè¡¨ä¸€æ ·ï¼ŒNTPè®©ç½‘ç»œä¸­çš„æ‰€æœ‰è®¡ç®—æœºéƒ½å¯¹ç€åŒä¸€ä¸ª"æ ‡å‡†æ—¶é—´"

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ—¶é—´åŒæ­¥


**ğŸ¯ å®é™…éœ€æ±‚åœºæ™¯**
```
ğŸ¢ ä¼ä¸šç¯å¢ƒï¼š
- æ—¥å¿—æ–‡ä»¶æ—¶é—´æˆ³ä¸€è‡´
- æ•°æ®åº“äº‹åŠ¡æ—¶é—´å‡†ç¡®
- å®‰å…¨å®¡è®¡æ—¶é—´å¯é 

ğŸŒ åˆ†å¸ƒå¼ç³»ç»Ÿï¼š
- å¤šæœåŠ¡å™¨ååŒå·¥ä½œ
- æ–‡ä»¶åŒæ­¥æ—¶é—´åˆ¤æ–­
- ä»»åŠ¡è°ƒåº¦ç²¾ç¡®æ‰§è¡Œ

ğŸ” å®‰å…¨è®¤è¯ï¼š
- æ•°å­—è¯ä¹¦æœ‰æ•ˆæœŸæ£€æŸ¥
- åŠ å¯†å¯†é’¥æ—¶é—´éªŒè¯
- ç™»å½•ä¼šè¯æ—¶é—´æ§åˆ¶
```

### 1.3 æ—¶é—´åŒæ­¥å±‚æ¬¡ç»“æ„


**ğŸ”¸ æ—¶é—´æœåŠ¡å™¨å±‚çº§ï¼ˆStratumï¼‰**
```
Stratum 0ï¼šåŸå­é’Ÿã€GPSæ—¶é’Ÿç­‰ç‰©ç†æ—¶é—´æº
     â”‚
     â–¼
Stratum 1ï¼šç›´æ¥è¿æ¥åˆ°Stratum 0çš„æœåŠ¡å™¨
     â”‚      ï¼ˆå¦‚ï¼štime.nist.govï¼‰
     â–¼
Stratum 2ï¼šä»Stratum 1åŒæ­¥æ—¶é—´çš„æœåŠ¡å™¨
     â”‚      ï¼ˆå¦‚ï¼šä¼ä¸šå†…éƒ¨ä¸»æ—¶é—´æœåŠ¡å™¨ï¼‰
     â–¼
Stratum 3ï¼šä»Stratum 2åŒæ­¥æ—¶é—´çš„æœåŠ¡å™¨
     â”‚      ï¼ˆå¦‚ï¼šéƒ¨é—¨æœåŠ¡å™¨ï¼‰
     â–¼
... æœ€å¤šåˆ°Stratum 15
```

> âš ï¸ **é‡è¦æé†’**  
> Stratumæ•°å­—è¶Šå°ï¼Œæ—¶é—´ç²¾åº¦è¶Šé«˜ã€‚ä¸€èˆ¬ä¼ä¸šä½¿ç”¨Stratum 2-4çš„æœåŠ¡å™¨å°±è¶³å¤Ÿäº†

---

## 2. ğŸ“‹ NTPåè®®ç‰ˆæœ¬ä¸ç‰¹æ€§


### 2.1 ä¸»è¦ç‰ˆæœ¬å¯¹æ¯”


| ç‰ˆæœ¬ | **å‘å¸ƒæ—¶é—´** | **ä¸»è¦ç‰¹æ€§** | **ä½¿ç”¨å»ºè®®** |
|------|------------|-------------|-------------|
| **NTPv3** | `1992å¹´` | `åŸºç¡€æ—¶é—´åŒæ­¥` | `å·²è¿‡æ—¶ï¼Œä¸æ¨è` |
| **NTPv4** | `2010å¹´` | `IPv6æ”¯æŒã€å®‰å…¨å¢å¼º` | `ğŸ‘ æ¨èä½¿ç”¨` |
| **NTPv5** | `å¼€å‘ä¸­` | `æ›´å¥½å®‰å…¨æ€§ã€ç²¾åº¦` | `æœªæ¥è€ƒè™‘` |

### 2.2 NTPv4æ ¸å¿ƒç‰¹æ€§è¯¦è§£


**ğŸ”¸ ç²¾åº¦æå‡**
```
æ—¶é—´ç²¾åº¦ï¼šçº³ç§’çº§åˆ«ï¼ˆç›¸æ¯”v3çš„å¾®ç§’çº§åˆ«ï¼‰
åŒæ­¥ç²¾åº¦ï¼šå±€åŸŸç½‘å†…å¯è¾¾1æ¯«ç§’ä»¥å†…
ç½‘ç»œé€‚åº”ï¼šè‡ªåŠ¨è°ƒæ•´åŒæ­¥é¢‘ç‡
```

**ğŸ”¸ IPv6æ”¯æŒ**
```bash
# æ”¯æŒIPv4å’ŒIPv6æ··åˆç¯å¢ƒ
server time.example.com iburst    # IPv4
server 2001:db8::1 iburst         # IPv6
```

**ğŸ”¸ å®‰å…¨å¢å¼º**
- **MD5è®¤è¯**: é˜²æ­¢æ—¶é—´æœåŠ¡å™¨ä¼ªé€ 
- **è®¿é—®æ§åˆ¶**: é™åˆ¶å®¢æˆ·ç«¯è®¿é—®èŒƒå›´
- **ç›‘æ§æ—¥å¿—**: è¯¦ç»†è®°å½•åŒæ­¥çŠ¶æ€

### 2.3 NTPå·¥ä½œæ¨¡å¼


**ğŸ”¸ å››ç§åŸºæœ¬å·¥ä½œæ¨¡å¼**

```
1ï¸âƒ£ å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Modeï¼‰
å®¢æˆ·ç«¯ â”€â”€è¯·æ±‚æ—¶é—´â”€â”€â–¶ æœåŠ¡å™¨
       â—€â”€â”€è¿”å›æ—¶é—´â”€â”€

2ï¸âƒ£ æœåŠ¡å™¨æ¨¡å¼ï¼ˆServer Modeï¼‰  
æœåŠ¡å™¨ç­‰å¾…å®¢æˆ·ç«¯è¯·æ±‚ï¼Œæä¾›æ—¶é—´æœåŠ¡

3ï¸âƒ£ å¯¹ç­‰æ¨¡å¼ï¼ˆPeer Modeï¼‰
æœåŠ¡å™¨A â—€â”€â”€æ—¶é—´åŒæ­¥â”€â”€â–¶ æœåŠ¡å™¨B
ä¸¤å°æœåŠ¡å™¨äº’ç›¸åŒæ­¥ï¼Œæé«˜å¯é æ€§

4ï¸âƒ£ å¹¿æ’­æ¨¡å¼ï¼ˆBroadcast Modeï¼‰
æœåŠ¡å™¨ â”€â”€å¹¿æ’­æ—¶é—´â”€â”€â–¶ æ‰€æœ‰å®¢æˆ·ç«¯
é€‚ç”¨äºå±€åŸŸç½‘ç¯å¢ƒ
```

---

## 3. ğŸ”§ ntpdæœåŠ¡è¯¦è§£


### 3.1 ntpdæœåŠ¡åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯ntpd**
- **å…¨ç§°**: Network Time Protocol daemonï¼ˆNTPå®ˆæŠ¤è¿›ç¨‹ï¼‰
- **ä½œç”¨**: Linuxç³»ç»Ÿä¸­å®ç°NTPåè®®çš„æœåŠ¡ç¨‹åº
- **ç‰¹ç‚¹**: æŒç»­è¿è¡Œï¼Œè‡ªåŠ¨ä¿æŒæ—¶é—´åŒæ­¥

> ğŸ’¡ **é€šä¿—ç†è§£**  
> ntpdå°±åƒä¸€ä¸ª"æ—¶é—´ç®¡å®¶"ï¼Œ24å°æ—¶ä¸åœåœ°æ£€æŸ¥å’Œè°ƒæ•´ç³»ç»Ÿæ—¶é—´

### 3.2 ntpdæœåŠ¡ç®¡ç†


**ğŸ”¸ æœåŠ¡åŸºæœ¬æ“ä½œ**
```bash
# ğŸš€ å¯åŠ¨æœåŠ¡
systemctl start ntpd

# â¹ï¸ åœæ­¢æœåŠ¡  
systemctl stop ntpd

# ğŸ”„ é‡å¯æœåŠ¡
systemctl restart ntpd

# ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status ntpd

# âš™ï¸ å¼€æœºè‡ªå¯åŠ¨
systemctl enable ntpd
```

**ğŸ”¸ æœåŠ¡çŠ¶æ€æ£€æŸ¥**
```bash
# æ£€æŸ¥ntpdè¿›ç¨‹æ˜¯å¦è¿è¡Œ
ps aux | grep ntpd

# æ£€æŸ¥ntpdç›‘å¬ç«¯å£ï¼ˆUDP 123ï¼‰
netstat -unlp | grep :123

# æŸ¥çœ‹æœåŠ¡å¯åŠ¨æ—¥å¿—
journalctl -u ntpd -f
```

### 3.3 ntpdä¸å…¶ä»–æ—¶é—´åŒæ­¥å·¥å…·å¯¹æ¯”


| å·¥å…· | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|------|------------|---------|---------|
| **ntpd** | `æœåŠ¡å™¨ç¯å¢ƒ` | `ç²¾åº¦é«˜ã€åŠŸèƒ½å…¨` | `é…ç½®å¤æ‚` |
| **chronyd** | `æ¡Œé¢/ç§»åŠ¨è®¾å¤‡` | `é€‚åº”ç½‘ç»œå˜åŒ–` | `åŠŸèƒ½ç›¸å¯¹ç®€å•` |
| **ntpdate** | `ä¸€æ¬¡æ€§åŒæ­¥` | `ç®€å•å¿«é€Ÿ` | `å·²è¿‡æ—¶ï¼Œä¸æ¨è` |

---

## 4. ğŸ“„ é…ç½®æ–‡ä»¶æ ¼å¼è¯¦è§£


### 4.1 é…ç½®æ–‡ä»¶ä½ç½®ä¸ç»“æ„


**ğŸ”¸ ä¸»é…ç½®æ–‡ä»¶**: `/etc/ntp.conf`

```bash
# æŸ¥çœ‹é»˜è®¤é…ç½®
cat /etc/ntp.conf

# å¤‡ä»½åŸé…ç½®ï¼ˆé‡è¦ä¹ æƒ¯ï¼ï¼‰
cp /etc/ntp.conf /etc/ntp.conf.backup
```

**ğŸ”¸ é…ç½®æ–‡ä»¶åŸºæœ¬ç»“æ„**
```bash
# ===== NTPæœåŠ¡å™¨é…ç½®ç¤ºä¾‹ =====

# ğŸŒ æ—¶é—´æœåŠ¡å™¨é…ç½®
server 0.pool.ntp.org iburst
server 1.pool.ntp.org iburst

# ğŸ” è®¿é—®æ§åˆ¶é…ç½®
restrict default nomodify notrap nopeer noquery
restrict 127.0.0.1

# ğŸ“ å…¶ä»–é…ç½®
driftfile /var/lib/ntp/drift
logfile /var/log/ntp.log
```

### 4.2 serveræŒ‡ä»¤è¯¦è§£


**ğŸ”¸ åŸºæœ¬è¯­æ³•**
```bash
server æœåŠ¡å™¨åœ°å€ [é€‰é¡¹...]
```

**ğŸ”¸ å¸¸ç”¨é€‰é¡¹è¯´æ˜**

| é€‰é¡¹ | **å«ä¹‰** | **ä½¿ç”¨åœºæ™¯** |
|------|---------|-------------|
| `iburst` | `å¿«é€ŸåŒæ­¥` | `ğŸ‘ æ¨èä½¿ç”¨ï¼ŒåŠ å¿«åˆå§‹åŒæ­¥` |
| `burst` | `æ‰¹é‡è¯·æ±‚` | `ç½‘ç»œä¸ç¨³å®šæ—¶ä½¿ç”¨` |
| `prefer` | `ä¼˜å…ˆæœåŠ¡å™¨` | `æŒ‡å®šé¦–é€‰æ—¶é—´æº` |
| `noselect` | `ä¸é€‰æ‹©` | `ä»…ç›‘æ§ï¼Œä¸ç”¨äºæ—¶é—´åŒæ­¥` |

**ğŸ”¸ é…ç½®ç¤ºä¾‹**
```bash
# âœ… æ¨èçš„åŸºç¡€é…ç½®
server ntp1.aliyun.com iburst prefer    # é˜¿é‡Œäº‘NTPï¼ˆé¦–é€‰ï¼‰
server ntp2.aliyun.com iburst           # é˜¿é‡Œäº‘NTPï¼ˆå¤‡ç”¨ï¼‰
server time.pool.ntp.org iburst         # å›½é™…NTPæ± 

# ğŸ¢ ä¼ä¸šå†…éƒ¨æ—¶é—´æœåŠ¡å™¨
server 192.168.1.10 iburst             # å†…ç½‘ä¸»æ—¶é—´æœåŠ¡å™¨
server 192.168.1.11 iburst             # å†…ç½‘å¤‡ç”¨æœåŠ¡å™¨
```

### 4.3 peeræŒ‡ä»¤é…ç½®


**ğŸ”¸ peeræ¨¡å¼åº”ç”¨åœºæ™¯**
```bash
# ğŸ¤ å¯¹ç­‰æ¨¡å¼ï¼šä¸¤å°æœåŠ¡å™¨äº’ç›¸åŒæ­¥
# æœåŠ¡å™¨Açš„é…ç½®ï¼š
server time.example.com iburst    # ä¸Šçº§æ—¶é—´æº
peer 192.168.1.11                # ä¸æœåŠ¡å™¨Bå¯¹ç­‰

# æœåŠ¡å™¨Bçš„é…ç½®ï¼š
server time.example.com iburst    # ä¸Šçº§æ—¶é—´æº  
peer 192.168.1.10                # ä¸æœåŠ¡å™¨Aå¯¹ç­‰
```

> ğŸ’¡ **ä½¿ç”¨å»ºè®®**  
> peeræ¨¡å¼é€‚ç”¨äºé‡è¦çš„æ—¶é—´æœåŠ¡å™¨ï¼Œé€šè¿‡äº’ç›¸åŒæ­¥æé«˜å¯é æ€§

### 4.4 poolæŒ‡ä»¤é…ç½®


**ğŸ”¸ poolæŒ‡ä»¤ä¼˜åŠ¿**
```bash
# ğŸŒ ä½¿ç”¨NTPæ± æœåŠ¡
pool 0.pool.ntp.org iburst
pool 1.pool.ntp.org iburst

# ç­‰æ•ˆäºå¤šä¸ªserveræŒ‡ä»¤ï¼Œä½†æ›´æ™ºèƒ½
# è‡ªåŠ¨é€‰æ‹©æœ€ä½³æœåŠ¡å™¨
```

**ğŸ”¸ å›½å†…æ¨èNTPæ± **
```bash
# ğŸ‡¨ğŸ‡³ ä¸­å›½NTPæ± 
pool cn.pool.ntp.org iburst

# ğŸ¢ å•†ä¸šNTPæœåŠ¡
pool ntp.aliyun.com iburst        # é˜¿é‡Œäº‘
pool time.pool.aliyun.com iburst  # é˜¿é‡Œäº‘æ± 
```

---

## 5. ğŸ” è®¿é—®æ§åˆ¶ä¸å®‰å…¨é…ç½®


### 5.1 restrictè®¿é—®æ§åˆ¶è¯¦è§£


**ğŸ”¸ restrictæŒ‡ä»¤è¯­æ³•**
```bash
restrict åœ°å€/ç½‘ç»œ [é€‰é¡¹...]
```

**ğŸ”¸ è®¿é—®æ§åˆ¶é€‰é¡¹è¯´æ˜**

| é€‰é¡¹ | **ä½œç”¨** | **é€‚ç”¨åœºæ™¯** |
|------|---------|-------------|
| `ignore` | `å®Œå…¨æ‹’ç»` | `å±è”½æ¶æ„å®¢æˆ·ç«¯` |
| `noquery` | `ç¦æ­¢æŸ¥è¯¢` | `ç¦æ­¢ntpqå‘½ä»¤æŸ¥è¯¢` |
| `nomodify` | `ç¦æ­¢ä¿®æ”¹` | `ç¦æ­¢é…ç½®ä¿®æ”¹` |
| `notrap` | `ç¦æ­¢é™·é˜±` | `å®‰å…¨é˜²æŠ¤` |
| `nopeer` | `ç¦æ­¢å¯¹ç­‰` | `ç¦æ­¢peeræ¨¡å¼` |

### 5.2 å…¸å‹å®‰å…¨é…ç½®


**ğŸ”¸ åŸºç¡€å®‰å…¨é…ç½®**
```bash
# ğŸš« é»˜è®¤æ‹’ç»æ‰€æœ‰è®¿é—®
restrict default ignore

# âœ… å…è®¸æœ¬æœºè®¿é—®
restrict 127.0.0.1
restrict ::1

# ğŸ¢ å…è®¸å†…ç½‘å®¢æˆ·ç«¯åŒæ­¥æ—¶é—´ï¼ˆä½†ç¦æ­¢å…¶ä»–æ“ä½œï¼‰
restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap nopeer noquery

# ğŸŒ å…è®¸ç‰¹å®šæœåŠ¡å™¨å®Œå…¨è®¿é—®
restrict ntp1.aliyun.com nomodify notrap nopeer
```

**ğŸ”¸ åˆ†çº§æƒé™é…ç½®**
```bash
# ç®¡ç†å‘˜ç½‘æ®µï¼šå…è®¸æŸ¥è¯¢å’Œç›‘æ§
restrict 192.168.100.0 mask 255.255.255.0 nomodify notrap nopeer

# æ™®é€šç”¨æˆ·ç½‘æ®µï¼šä»…å…è®¸æ—¶é—´åŒæ­¥
restrict 192.168.0.0 mask 255.255.0.0 nomodify notrap nopeer noquery

# DMZåŒºåŸŸï¼šå®Œå…¨ç¦æ­¢è®¿é—®
restrict 172.16.1.0 mask 255.255.255.0 ignore
```

### 5.3 driftæ–‡ä»¶æ—¶é’Ÿæ¼‚ç§»è®°å½•


**ğŸ”¸ driftæ–‡ä»¶ä½œç”¨**
```bash
# ğŸ“ driftæ–‡ä»¶ä½ç½®
driftfile /var/lib/ntp/drift

# ğŸ” æŸ¥çœ‹æ—¶é’Ÿæ¼‚ç§»å€¼
cat /var/lib/ntp/drift
# ç¤ºä¾‹è¾“å‡ºï¼š-23.456 (è¡¨ç¤ºæœ¬åœ°æ—¶é’Ÿæ…¢äº†23.456 PPM)
```

**ğŸ”¸ æ—¶é’Ÿæ¼‚ç§»ç†è§£**
```
PPM (Parts Per Million)ï¼šç™¾ä¸‡åˆ†ä¹‹å‡ çš„è¯¯å·®

ç¤ºä¾‹ç†è§£ï¼š
-23.456 PPM = æœ¬åœ°æ—¶é’Ÿæ¯ç™¾ä¸‡ç§’æ…¢23.456ç§’
æ¢ç®—ï¼šæ¯å¤©å¤§çº¦æ…¢ 2.03 ç§’ (86400 Ã— 23.456 / 1000000)

ğŸ¯ driftæ–‡ä»¶å¥½å¤„ï¼š
- å¯åŠ¨æ—¶å¿«é€Ÿæ ¡å‡†
- æé«˜æ—¶é—´åŒæ­¥ç²¾åº¦  
- å‡å°‘ç½‘ç»œæŸ¥è¯¢é¢‘ç‡
```

### 5.4 NTPå®‰å…¨é…ç½®è¦ç‚¹


**ğŸ”¸ é˜²ç«å¢™é…ç½®**
```bash
# å¼€æ”¾NTPç«¯å£ï¼ˆUDP 123ï¼‰
firewall-cmd --permanent --add-service=ntp
firewall-cmd --reload

# æˆ–è€…æŒ‡å®šç«¯å£
firewall-cmd --permanent --add-port=123/udp
```

**ğŸ”¸ æ—¥å¿—ç›‘æ§é…ç½®**
```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
logfile /var/log/ntp.log

# æ—¥å¿—çº§åˆ«é…ç½®
# åœ¨/etc/ntp.confä¸­æ·»åŠ ï¼š
logconfig +syncevents +peerevents +sysevents +allclock
```

**ğŸ”¸ ç›‘æ§è„šæœ¬ç¤ºä¾‹**
```bash
#!/bin/bash
# NTPçŠ¶æ€ç›‘æ§è„šæœ¬

# æ£€æŸ¥ntpdæœåŠ¡çŠ¶æ€
if ! systemctl is-active --quiet ntpd; then
    echo "âš ï¸  NTPæœåŠ¡æœªè¿è¡Œï¼"
    exit 1
fi

# æ£€æŸ¥æ—¶é—´åŒæ­¥çŠ¶æ€
if ntpstat | grep -q "synchronized"; then
    echo "âœ… æ—¶é—´åŒæ­¥æ­£å¸¸"
else
    echo "âŒ æ—¶é—´åŒæ­¥å¼‚å¸¸"
    ntpq -p
fi
```

---

## 6. ğŸ” NTPçŠ¶æ€ç›‘æ§å·¥å…·


### 6.1 ntpqæŸ¥è¯¢å·¥å…·è¯¦è§£


**ğŸ”¸ ntpqåŸºæœ¬ç”¨æ³•**
```bash
# æŸ¥çœ‹NTPæœåŠ¡å™¨åˆ—è¡¨
ntpq -p

# è¯¦ç»†è¾“å‡ºæ ¼å¼
ntpq -pn    # ä½¿ç”¨IPåœ°å€ä»£æ›¿ä¸»æœºå
```

**ğŸ”¸ ntpqè¾“å‡ºè§£è¯»**
```bash
$ ntpq -p
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
*ntp1.aliyun.com .PTP.           1 u   64   64  377   23.456   -2.123   1.234
+ntp2.aliyun.com .PTP.           1 u   32   64  377   25.789   -1.567   2.345
-time.pool.org   .POOL.          2 u  128   64  177   45.123    5.678   3.456
```

**ğŸ”¸ è¾“å‡ºå­—æ®µå«ä¹‰**

| å­—æ®µ | **å«ä¹‰** | **è¯´æ˜** |
|------|---------|---------|
| `*` | `å½“å‰åŒæ­¥æº` | `æ­£åœ¨ä½¿ç”¨çš„æ—¶é—´æœåŠ¡å™¨` |
| `+` | `å¤‡é€‰åŒæ­¥æº` | `å¯ç”¨çš„å¤‡ç”¨æœåŠ¡å™¨` |
| `-` | `è¢«æ’é™¤æº` | `ä¸å¯ç”¨æˆ–ç²¾åº¦å·®çš„æœåŠ¡å™¨` |
| `remote` | `æœåŠ¡å™¨åœ°å€` | `NTPæœåŠ¡å™¨çš„ä¸»æœºåæˆ–IP` |
| `refid` | `å‚è€ƒæ—¶é’Ÿ` | `æœåŠ¡å™¨çš„ä¸Šçº§æ—¶é—´æº` |
| `st` | `å±‚çº§` | `Stratumå±‚çº§ï¼ˆ1-15ï¼‰` |
| `when` | `ä¸Šæ¬¡æŸ¥è¯¢` | `è·ç¦»ä¸Šæ¬¡æŸ¥è¯¢çš„ç§’æ•°` |
| `poll` | `æŸ¥è¯¢é—´éš”` | `æŸ¥è¯¢é—´éš”ç§’æ•°` |
| `reach` | `å¯è¾¾æ€§` | `8æ¬¡æŸ¥è¯¢çš„æˆåŠŸæƒ…å†µï¼ˆå…«è¿›åˆ¶ï¼‰` |
| `delay` | `ç½‘ç»œå»¶è¿Ÿ` | `å¾€è¿”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰` |
| `offset` | `æ—¶é—´åç§»` | `ä¸æœ¬åœ°æ—¶é’Ÿçš„å·®å€¼ï¼ˆæ¯«ç§’ï¼‰` |
| `jitter` | `æ—¶é—´æŠ–åŠ¨` | `æ—¶é—´å˜åŒ–çš„ç¨³å®šæ€§ï¼ˆæ¯«ç§’ï¼‰` |

### 6.2 ntpqäº¤äº’æ¨¡å¼


**ğŸ”¸ è¿›å…¥äº¤äº’æ¨¡å¼**
```bash
# å¯åŠ¨äº¤äº’å¼æŸ¥è¯¢
ntpq

# åœ¨ntpq>æç¤ºç¬¦ä¸‹ä½¿ç”¨å‘½ä»¤ï¼š
ntpq> peers        # æŸ¥çœ‹å¯¹ç­‰æœåŠ¡å™¨
ntpq> associations # æŸ¥çœ‹å…³è”ä¿¡æ¯
ntpq> rv           # æŸ¥çœ‹ç³»ç»Ÿå˜é‡
ntpq> quit         # é€€å‡º
```

**ğŸ”¸ å¸¸ç”¨äº¤äº’å‘½ä»¤**
```bash
# æŸ¥çœ‹è¯¦ç»†æœåŠ¡å™¨ä¿¡æ¯
ntpq> rv æœåŠ¡å™¨åœ°å€

# æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
ntpq> rv 0

# æŸ¥çœ‹æ‰€æœ‰å…³è”
ntpq> as
```

### 6.3 ntpstatåŒæ­¥çŠ¶æ€æ£€æŸ¥


**ğŸ”¸ ntpstatåŸºæœ¬ç”¨æ³•**
```bash
# æ£€æŸ¥åŒæ­¥çŠ¶æ€
ntpstat

# ç¤ºä¾‹è¾“å‡ºï¼š
synchronised to NTP server (192.168.1.10) at stratum 3
   time correct to within 42 ms
   polling server every 64 s
```

**ğŸ”¸ çŠ¶æ€åˆ¤æ–­æ ‡å‡†**
```bash
âœ… æ­£å¸¸çŠ¶æ€ï¼š
synchronised to NTP server...
æ—¶é—´å·²åŒæ­¥åˆ°NTPæœåŠ¡å™¨

â³ åŒæ­¥ä¸­çŠ¶æ€ï¼š
synchronisation in progress...  
æ­£åœ¨è¿›è¡Œæ—¶é—´åŒæ­¥

âŒ å¼‚å¸¸çŠ¶æ€ï¼š
unsynchronised
æ—¶é—´æœªåŒæ­¥ï¼ˆå¯èƒ½æœåŠ¡å™¨ä¸å¯è¾¾ï¼‰
```

### 6.4 å…¶ä»–æœ‰ç”¨çš„ç›‘æ§å‘½ä»¤


**ğŸ”¸ ç³»ç»Ÿæ—¶é—´ç›¸å…³å‘½ä»¤**
```bash
# æŸ¥çœ‹å½“å‰ç³»ç»Ÿæ—¶é—´
date

# æŸ¥çœ‹ç¡¬ä»¶æ—¶é—´
hwclock

# åŒæ­¥ç³»ç»Ÿæ—¶é—´åˆ°ç¡¬ä»¶æ—¶é’Ÿ
hwclock --systohc

# æŸ¥çœ‹æ—¶åŒºè®¾ç½®
timedatectl status
```

**ğŸ”¸ ç½‘ç»œè¿é€šæ€§æµ‹è¯•**
```bash
# æµ‹è¯•NTPæœåŠ¡å™¨è¿é€šæ€§
ping ntp1.aliyun.com

# æµ‹è¯•NTPç«¯å£è¿é€šæ€§
nc -u ntp1.aliyun.com 123

# ä½¿ç”¨ntpdateæµ‹è¯•ï¼ˆä»…æµ‹è¯•ï¼Œä¸å»ºè®®ç”¨äºç”Ÿäº§ï¼‰
ntpdate -q ntp1.aliyun.com
```

---

## 7. âš™ï¸ å®æˆ˜é…ç½®æ¡ˆä¾‹


### 7.1 ä¼ä¸šå†…ç½‘NTPæœåŠ¡å™¨é…ç½®


**ğŸ”¸ åœºæ™¯æè¿°**: ä¼ä¸šå†…ç½‘æ­å»ºä¸»NTPæœåŠ¡å™¨

```bash
# ===== /etc/ntp.conf é…ç½®ç¤ºä¾‹ =====

# ğŸŒ ä¸Šæ¸¸æ—¶é—´æœåŠ¡å™¨ï¼ˆå…¬ç½‘NTPï¼‰
server ntp1.aliyun.com iburst prefer
server ntp2.aliyun.com iburst
server time.pool.aliyun.com iburst

# ğŸ¢ å†…ç½‘å®¢æˆ·ç«¯è®¿é—®æ§åˆ¶
# å…è®¸å†…ç½‘å®¢æˆ·ç«¯åŒæ­¥æ—¶é—´
restrict 192.168.0.0 mask 255.255.0.0 nomodify notrap nopeer noquery

# ğŸš« é»˜è®¤å®‰å…¨ç­–ç•¥
restrict default ignore
restrict 127.0.0.1
restrict ::1

# ğŸ“ ç³»ç»Ÿé…ç½®
driftfile /var/lib/ntp/drift
logfile /var/log/ntp.log

# ğŸ“Š è¯¦ç»†æ—¥å¿—
logconfig +syncevents +peerevents +sysevents

# ğŸ”§ å…¶ä»–é…ç½®
disable monitor
```

### 7.2 å®¢æˆ·ç«¯é…ç½®ç¤ºä¾‹


**ğŸ”¸ å†…ç½‘å®¢æˆ·ç«¯é…ç½®**
```bash
# ===== å†…ç½‘å®¢æˆ·ç«¯ /etc/ntp.conf =====

# ğŸ¢ æŒ‡å‘å†…ç½‘NTPæœåŠ¡å™¨
server 192.168.1.10 iburst prefer    # ä¸»æœåŠ¡å™¨
server 192.168.1.11 iburst           # å¤‡ç”¨æœåŠ¡å™¨

# ğŸŒ å…¬ç½‘å¤‡ç”¨ï¼ˆé˜²æ­¢å†…ç½‘æœåŠ¡å™¨æ•…éšœï¼‰
server ntp1.aliyun.com iburst

# ğŸ” åŸºæœ¬å®‰å…¨é…ç½®
restrict default ignore
restrict 127.0.0.1
restrict ::1

# ğŸ“ åŸºæœ¬é…ç½®
driftfile /var/lib/ntp/drift
```

### 7.3 é«˜å¯ç”¨NTPæœåŠ¡å™¨é…ç½®


**ğŸ”¸ åœºæ™¯**: ä¸¤å°NTPæœåŠ¡å™¨äº’ä¸ºå¤‡ä»½

**æœåŠ¡å™¨Aé…ç½®**:
```bash
# ===== NTPæœåŠ¡å™¨Aï¼ˆ192.168.1.10ï¼‰=====

# ğŸŒ ä¸Šæ¸¸æ—¶é—´æº
server ntp1.aliyun.com iburst
server ntp2.aliyun.com iburst

# ğŸ¤ å¯¹ç­‰æœåŠ¡å™¨B
peer 192.168.1.11

# ğŸ¢ å®¢æˆ·ç«¯è®¿é—®æ§åˆ¶
restrict 192.168.0.0 mask 255.255.0.0 nomodify notrap nopeer noquery
restrict 192.168.1.11 nomodify notrap  # å…è®¸å¯¹ç­‰è¿æ¥

# ğŸš« é»˜è®¤é™åˆ¶
restrict default ignore
restrict 127.0.0.1

# ğŸ“ é…ç½®æ–‡ä»¶
driftfile /var/lib/ntp/drift
```

**æœåŠ¡å™¨Bé…ç½®**:
```bash
# ===== NTPæœåŠ¡å™¨Bï¼ˆ192.168.1.11ï¼‰=====

# ğŸŒ ä¸Šæ¸¸æ—¶é—´æº
server ntp1.aliyun.com iburst
server ntp2.aliyun.com iburst

# ğŸ¤ å¯¹ç­‰æœåŠ¡å™¨A
peer 192.168.1.10

# ğŸ¢ å®¢æˆ·ç«¯è®¿é—®æ§åˆ¶
restrict 192.168.0.0 mask 255.255.0.0 nomodify notrap nopeer noquery  
restrict 192.168.1.10 nomodify notrap  # å…è®¸å¯¹ç­‰è¿æ¥

# ğŸš« é»˜è®¤é™åˆ¶
restrict default ignore
restrict 127.0.0.1

# ğŸ“ é…ç½®æ–‡ä»¶
driftfile /var/lib/ntp/drift
```

### 7.4 é…ç½®éƒ¨ç½²æ­¥éª¤


**ğŸ”¸ å®Œæ•´éƒ¨ç½²æµç¨‹**

1ï¸âƒ£ **å®‰è£…NTPæœåŠ¡**
```bash
# CentOS/RHEL
yum install ntp -y

# Ubuntu/Debian  
apt-get install ntp -y
```

2ï¸âƒ£ **é…ç½®æ–‡ä»¶ä¿®æ”¹**
```bash
# å¤‡ä»½åŸé…ç½®
cp /etc/ntp.conf /etc/ntp.conf.backup

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim /etc/ntp.conf
# ï¼ˆä½¿ç”¨ä¸Šé¢çš„é…ç½®ç¤ºä¾‹ï¼‰
```

3ï¸âƒ£ **å¯åŠ¨å’Œæµ‹è¯•**
```bash
# å¯åŠ¨æœåŠ¡
systemctl start ntpd
systemctl enable ntpd

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status ntpd

# ç­‰å¾…å‡ åˆ†é’Ÿåæ£€æŸ¥åŒæ­¥çŠ¶æ€
ntpq -p
ntpstat
```

4ï¸âƒ£ **é˜²ç«å¢™é…ç½®**
```bash
# å¼€æ”¾NTPç«¯å£
firewall-cmd --permanent --add-service=ntp
firewall-cmd --reload
```

5ï¸âƒ£ **éªŒè¯é…ç½®**
```bash
# æ£€æŸ¥ç›‘å¬ç«¯å£
netstat -unlp | grep :123

# æµ‹è¯•å®¢æˆ·ç«¯è¿æ¥
# åœ¨å®¢æˆ·ç«¯æ‰§è¡Œï¼š
ntpdate -q æœåŠ¡å™¨IP
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ•°ï¸ NTPåè®®ï¼šç½‘ç»œæ—¶é—´åè®®ï¼Œç”¨äºåŒæ­¥ç½‘ç»œä¸­è®¡ç®—æœºçš„æ—¶é—´
ğŸ”§ ntpdæœåŠ¡ï¼šLinuxä¸­å®ç°NTPåè®®çš„å®ˆæŠ¤è¿›ç¨‹
ğŸ“Š Stratumå±‚çº§ï¼šæ—¶é—´æœåŠ¡å™¨çš„ç²¾åº¦å±‚çº§ï¼Œæ•°å­—è¶Šå°ç²¾åº¦è¶Šé«˜
ğŸ“ driftæ–‡ä»¶ï¼šè®°å½•æœ¬åœ°æ—¶é’Ÿæ¼‚ç§»ï¼Œæé«˜åŒæ­¥ç²¾åº¦
ğŸ” è®¿é—®æ§åˆ¶ï¼šrestrictæŒ‡ä»¤æ§åˆ¶å®¢æˆ·ç«¯è®¿é—®æƒé™
```

### 8.2 å…³é”®é…ç½®ç†è§£è¦ç‚¹


**ğŸ”¹ æœåŠ¡å™¨æŒ‡ä»¤é…ç½®**
```
serverï¼šæŒ‡å®šä¸Šæ¸¸æ—¶é—´æœåŠ¡å™¨
peerï¼šé…ç½®å¯¹ç­‰æ—¶é—´æœåŠ¡å™¨ï¼ˆåŒå‘åŒæ­¥ï¼‰
poolï¼šä½¿ç”¨NTPæœåŠ¡å™¨æ± ï¼ˆè‡ªåŠ¨é€‰æ‹©æœ€ä½³ï¼‰
iburstï¼šå¿«é€Ÿåˆå§‹åŒæ­¥é€‰é¡¹ï¼ˆæ¨èä½¿ç”¨ï¼‰
```

**ğŸ”¹ å®‰å…¨è®¿é—®æ§åˆ¶**
```
restrict default ignoreï¼šé»˜è®¤æ‹’ç»æ‰€æœ‰è®¿é—®
restrict ç½‘æ®µ nomodify notrap nopeer noqueryï¼šå…è®¸æ—¶é—´åŒæ­¥ï¼Œç¦æ­¢å…¶ä»–æ“ä½œ
restrict 127.0.0.1ï¼šå…è®¸æœ¬æœºå®Œå…¨è®¿é—®
```

**ğŸ”¹ çŠ¶æ€ç›‘æ§å‘½ä»¤**
```
ntpq -pï¼šæŸ¥çœ‹NTPæœåŠ¡å™¨çŠ¶æ€å’ŒåŒæ­¥æƒ…å†µ
ntpstatï¼šæ£€æŸ¥æ—¶é—´åŒæ­¥çŠ¶æ€
systemctl status ntpdï¼šæ£€æŸ¥ntpdæœåŠ¡è¿è¡ŒçŠ¶æ€
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ å…¸å‹éƒ¨ç½²æ¶æ„**
```
å…¬ç½‘NTPæœåŠ¡å™¨ â”€â”€â–¶ ä¼ä¸šä¸»NTPæœåŠ¡å™¨ â”€â”€â–¶ å†…ç½‘å®¢æˆ·ç«¯
     â”‚                    â–²
     â””â”€â”€å¤‡ç”¨è¿æ¥â”€â”€â–¶ ä¼ä¸šå¤‡NTPæœåŠ¡å™¨ â”€â”€â”˜
                     ï¼ˆå¯¹ç­‰æ¨¡å¼ï¼‰
```

**ğŸ”§ é…ç½®æœ€ä½³å®è·µ**
- âœ… **å¤šæœåŠ¡å™¨æº**: é…ç½®è‡³å°‘3ä¸ªä¸Šæ¸¸æ—¶é—´æœåŠ¡å™¨
- âœ… **ä½¿ç”¨iburst**: åŠ å¿«åˆå§‹åŒæ­¥é€Ÿåº¦  
- âœ… **å®‰å…¨é™åˆ¶**: ä¸¥æ ¼æ§åˆ¶å®¢æˆ·ç«¯è®¿é—®æƒé™
- âœ… **æ—¥å¿—ç›‘æ§**: å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•
- âœ… **é˜²ç«å¢™è®¾ç½®**: å¼€æ”¾UDP 123ç«¯å£

**âš ï¸ å¸¸è§é—®é¢˜é¿å…**
- é¿å…æ—¶é—´æœåŠ¡å™¨å±‚çº§è¿‡æ·±ï¼ˆè¶…è¿‡5å±‚ï¼‰
- é¿å…å¾ªç¯å¼•ç”¨ï¼ˆAæŒ‡å‘Bï¼ŒBåˆæŒ‡å‘Aä½œä¸ºserverï¼‰
- é¿å…åœ¨è™šæ‹Ÿæœºä¸­ç›´æ¥è°ƒæ•´ç¡¬ä»¶æ—¶é’Ÿ
- é¿å…ntpdateä¸ntpdåŒæ—¶ä½¿ç”¨

**ğŸ” æ•…éšœæ’æŸ¥æ€è·¯**
1. æ£€æŸ¥ntpdæœåŠ¡æ˜¯å¦è¿è¡Œæ­£å¸¸
2. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§å’Œé˜²ç«å¢™è®¾ç½®
3. æŸ¥çœ‹ntpq -pè¾“å‡ºï¼Œç¡®è®¤æœåŠ¡å™¨å¯è¾¾æ€§
4. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•å’Œæƒé™è®¾ç½®
5. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- NTPè®©ç½‘ç»œæ—¶é—´ä¿æŒä¸€è‡´ï¼Œntpdæ˜¯å®ç°å·¥å…·
- serveré…ç½®ä¸Šæ¸¸æœåŠ¡å™¨ï¼Œrestrictæ§åˆ¶è®¿é—®å®‰å…¨
- ntpqæŸ¥çœ‹çŠ¶æ€ï¼Œntpstatæ£€æŸ¥åŒæ­¥æƒ…å†µ
- é…ç½®è¦ç‚¹ï¼šå¤šæºã€å®‰å…¨ã€ç›‘æ§ã€iburståŠ é€Ÿ