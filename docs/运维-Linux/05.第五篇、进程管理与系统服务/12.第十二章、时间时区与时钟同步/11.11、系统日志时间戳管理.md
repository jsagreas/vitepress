---
title: 11ã€ç³»ç»Ÿæ—¥å¿—æ—¶é—´æˆ³ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [ç³»ç»Ÿæ—¥å¿—æ—¶é—´æˆ³æ¦‚è¿°](#1-ç³»ç»Ÿæ—¥å¿—æ—¶é—´æˆ³æ¦‚è¿°)
2. [Syslogæ—¶é—´æˆ³æ ¼å¼æ ‡å‡†](#2-Syslogæ—¶é—´æˆ³æ ¼å¼æ ‡å‡†)
3. [Journaldæ—¶é—´æˆ³ç²¾åº¦é…ç½®](#3-Journaldæ—¶é—´æˆ³ç²¾åº¦é…ç½®)
4. [æ—¥å¿—æ—¶åŒºä¸€è‡´æ€§å¤„ç†](#4-æ—¥å¿—æ—¶åŒºä¸€è‡´æ€§å¤„ç†)
5. [æ—¶é—´æˆ³ç´¢å¼•ä¸æ£€ç´¢](#5-æ—¶é—´æˆ³ç´¢å¼•ä¸æ£€ç´¢)
6. [å¤šæœåŠ¡å™¨æ—¥å¿—æ—¶é—´åŒæ­¥](#6-å¤šæœåŠ¡å™¨æ—¥å¿—æ—¶é—´åŒæ­¥)
7. [æ—¥å¿—è½®è½¬æ—¶é—´ç­–ç•¥](#7-æ—¥å¿—è½®è½¬æ—¶é—´ç­–ç•¥)
8. [å®¡è®¡æ—¥å¿—æ—¶é—´è¦æ±‚](#8-å®¡è®¡æ—¥å¿—æ—¶é—´è¦æ±‚)
9. [æ—¥å¿—æ—¶é—´å¼‚å¸¸æ’æŸ¥](#9-æ—¥å¿—æ—¶é—´å¼‚å¸¸æ’æŸ¥)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“‹ ç³»ç»Ÿæ—¥å¿—æ—¶é—´æˆ³æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ—¥å¿—æ—¶é—´æˆ³


**æ—¶é—´æˆ³çš„æœ¬è´¨**ï¼šè®°å½•æ—¥å¿—äº‹ä»¶å‘ç”Ÿçš„ç²¾ç¡®æ—¶é—´ç‚¹çš„æ ‡è®°

```
ç®€å•ç†è§£ï¼š
å°±åƒæ‹ç…§æ—¶ç›¸æœºè‡ªåŠ¨è®°å½•çš„æ‹æ‘„æ—¶é—´
æ¯æ¡æ—¥å¿—éƒ½æœ‰ä¸€ä¸ª"æ—¶é—´å°ç« "
å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªäº‹ä»¶æ˜¯ä»€ä¹ˆæ—¶å€™å‘ç”Ÿçš„
```

**ä¸ºä»€ä¹ˆæ—¶é—´æˆ³é‡è¦**ï¼š
- ğŸ•’ **äº‹ä»¶æ’åº**ï¼šæŒ‰æ—¶é—´é¡ºåºè¿½è¸ªç³»ç»Ÿå‘ç”Ÿäº†ä»€ä¹ˆ
- ğŸ” **æ•…éšœåˆ†æ**ï¼šå®šä½é—®é¢˜å‘ç”Ÿçš„å…·ä½“æ—¶é—´
- ğŸ“Š **æ€§èƒ½ç›‘æ§**ï¼šåˆ†æç³»ç»Ÿåœ¨ä¸åŒæ—¶é—´æ®µçš„è¡¨ç°
- ğŸ›¡ï¸ **å®‰å…¨å®¡è®¡**ï¼šè¿½è¸ªå®‰å…¨äº‹ä»¶çš„å‘ç”Ÿæ—¶é—´

### 1.2 Linuxç³»ç»Ÿä¸­çš„æ—¥å¿—ç³»ç»Ÿ


**ä¸¤å¤§ä¸»æµæ—¥å¿—ç³»ç»Ÿ**ï¼š

```
ä¼ ç»ŸSyslogï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨ç¨‹åº   â”‚â”€â”€â”€â–¶â”‚   rsyslog   â”‚â”€â”€â”€â–¶â”‚  æ—¥å¿—æ–‡ä»¶   â”‚
â”‚             â”‚    â”‚   daemon    â”‚    â”‚ /var/log/   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç°ä»£Systemdï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨ç¨‹åº   â”‚â”€â”€â”€â–¶â”‚  journald   â”‚â”€â”€â”€â–¶â”‚ journaläºŒè¿›åˆ¶â”‚
â”‚             â”‚    â”‚   daemon    â”‚    â”‚    æ•°æ®åº“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸¤è€…çš„å·®å¼‚**ï¼š

| ç‰¹æ€§ | **Syslog** | **Journald** |
|------|-----------|--------------|
| ğŸ“ **å­˜å‚¨æ ¼å¼** | `æ–‡æœ¬æ–‡ä»¶` | `äºŒè¿›åˆ¶æ•°æ®åº“` |
| â° **æ—¶é—´ç²¾åº¦** | `ç§’çº§` | `å¾®ç§’çº§` |
| ğŸ” **æŸ¥è¯¢æ–¹å¼** | `grep/awkç­‰æ–‡æœ¬å·¥å…·` | `journalctlå‘½ä»¤` |
| ğŸ’¾ **å­˜å‚¨æ•ˆç‡** | `è¾ƒä½` | `è¾ƒé«˜` |
| ğŸ”§ **é…ç½®å¤æ‚åº¦** | `è¾ƒå¤æ‚` | `è¾ƒç®€å•` |

### 1.3 æ—¶é—´æˆ³åœ¨ç³»ç»Ÿè¿ç»´ä¸­çš„ä½œç”¨


**å®é™…åº”ç”¨åœºæ™¯**ï¼š

```
ğŸš¨ æ•…éšœæ’æŸ¥åœºæ™¯ï¼š
14:32:15 - ç”¨æˆ·æŠ¥å‘Šç½‘ç«™æ— æ³•è®¿é—®
14:32:20 - æŸ¥çœ‹nginxæ—¥å¿—å‘ç°å¤§é‡502é”™è¯¯
14:32:25 - æŸ¥çœ‹åç«¯æœåŠ¡æ—¥å¿—å‘ç°æ•°æ®åº“è¿æ¥å¤±è´¥
14:32:30 - æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—å‘ç°ç£ç›˜ç©ºé—´ä¸è¶³
ç»“è®ºï¼šç£ç›˜æ»¡å¯¼è‡´æ•°æ®åº“å¼‚å¸¸ï¼Œè¿›è€Œå¯¼è‡´ç½‘ç«™ä¸å¯ç”¨

ğŸ“Š æ€§èƒ½åˆ†æåœºæ™¯ï¼š
é€šè¿‡æ—¶é—´æˆ³åˆ†æå‘ç°ï¼š
- æ¯å¤©9:00-10:00ç³»ç»Ÿè´Ÿè½½æœ€é«˜
- å‘¨äº”ä¸‹åˆå“åº”æ—¶é—´æ˜æ˜¾å¢åŠ 
- æ•°æ®åº“æŸ¥è¯¢åœ¨ç‰¹å®šæ—¶é—´æ®µå˜æ…¢
```

---

## 2. ğŸ“ Syslogæ—¶é—´æˆ³æ ¼å¼æ ‡å‡†


### 2.1 ä¼ ç»ŸSyslogæ—¶é—´æˆ³æ ¼å¼


**RFC 3164æ ‡å‡†æ ¼å¼**ï¼š
```
æ ¼å¼ï¼šMmm dd hh:mm:ss
ç¤ºä¾‹ï¼šJan 15 14:32:45

å®Œæ•´æ—¥å¿—è¡Œç¤ºä¾‹ï¼š
Jan 15 14:32:45 server01 sshd[1234]: Failed login attempt from 192.168.1.100
```

> ğŸ’¡ **æ ¼å¼è¯´æ˜**ï¼š
> - `Mmm`ï¼šæœˆä»½çš„è‹±æ–‡ç¼©å†™ï¼ˆJan, Feb, Mar...ï¼‰
> - `dd`ï¼šæ—¥æœŸï¼Œå•æ•°å­—å‰è¡¥ç©ºæ ¼ï¼ˆå¦‚ " 5"è¡¨ç¤º5å·ï¼‰
> - `hh:mm:ss`ï¼š24å°æ—¶åˆ¶çš„æ—¶åˆ†ç§’

**ä¼ ç»Ÿæ ¼å¼çš„å±€é™æ€§**ï¼š
- âŒ **æ— å¹´ä»½ä¿¡æ¯**ï¼šè·¨å¹´æ—¥å¿—åˆ†æå›°éš¾
- âŒ **æ— æ—¶åŒºä¿¡æ¯**ï¼šå¤šæ—¶åŒºç¯å¢ƒå®¹æ˜“æ··ä¹±
- âŒ **ç²¾åº¦æœ‰é™**ï¼šåªèƒ½ç²¾ç¡®åˆ°ç§’
- âŒ **æ ¼å¼å›ºå®š**ï¼šä¸å¤Ÿçµæ´»

### 2.2 ç°ä»£Syslogæ—¶é—´æˆ³æ ¼å¼


**RFC 5424æ ‡å‡†æ ¼å¼**ï¼š
```
æ ¼å¼ï¼šYYYY-MM-DDTHH:MM:SS.sssZ
ç¤ºä¾‹ï¼š2025-01-15T14:32:45.123+08:00

å®Œæ•´æ—¥å¿—è¡Œç¤ºä¾‹ï¼š
2025-01-15T14:32:45.123+08:00 server01 sshd 1234 - Failed login attempt
```

> ğŸ”¸ **ç°ä»£æ ¼å¼ä¼˜åŠ¿**ï¼š
> - âœ… **åŒ…å«å¹´ä»½**ï¼šä¾¿äºé•¿æœŸæ—¥å¿—åˆ†æ
> - âœ… **åŒ…å«æ—¶åŒº**ï¼šæ”¯æŒå¤šæ—¶åŒºç¯å¢ƒ
> - âœ… **æ¯«ç§’ç²¾åº¦**ï¼šæ›´ç²¾ç¡®çš„æ—¶é—´è®°å½•
> - âœ… **ISOæ ‡å‡†**ï¼šå›½é™…æ ‡å‡†æ ¼å¼ï¼Œé€šç”¨æ€§å¥½

### 2.3 Rsyslogæ—¶é—´æˆ³é…ç½®


**é…ç½®æ—¶é—´æˆ³æ ¼å¼**ï¼š

```bash
# ç¼–è¾‘rsyslogé…ç½®æ–‡ä»¶
sudo vim /etc/rsyslog.conf

# ä¼ ç»Ÿæ ¼å¼ï¼ˆé»˜è®¤ï¼‰
$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat

# ç°ä»£æ ¼å¼
$ActionFileDefaultTemplate RSYSLOG_FileFormat

# è‡ªå®šä¹‰æ ¼å¼
$template CustomFormat,"%timestamp:::date-rfc3339% %HOSTNAME% %syslogtag%%msg%\n"
$ActionFileDefaultTemplate CustomFormat
```

**å¸¸ç”¨æ—¶é—´æˆ³æ¨¡æ¿**ï¼š

| æ¨¡æ¿åç§° | **æ ¼å¼ç¤ºä¾‹** | **è¯´æ˜** |
|---------|------------|---------|
| `RSYSLOG_TraditionalFileFormat` | `Jan 15 14:32:45` | `ä¼ ç»ŸBSDæ ¼å¼` |
| `RSYSLOG_FileFormat` | `2025-01-15T14:32:45+08:00` | `RFC5424æ ¼å¼` |
| `RSYSLOG_ForwardFormat` | `<priority>timestamp hostname tag msg` | `ç½‘ç»œä¼ è¾“æ ¼å¼` |

**å®é™…é…ç½®ç¤ºä¾‹**ï¼š

```bash
# 1. å¤‡ä»½åŸé…ç½®
sudo cp /etc/rsyslog.conf /etc/rsyslog.conf.bak

# 2. é…ç½®ä½¿ç”¨é«˜ç²¾åº¦æ—¶é—´æˆ³
echo '$ActionFileDefaultTemplate RSYSLOG_FileFormat' | sudo tee -a /etc/rsyslog.conf

# 3. é‡å¯rsyslogæœåŠ¡
sudo systemctl restart rsyslog

# 4. éªŒè¯é…ç½®æ•ˆæœ
logger "æµ‹è¯•é«˜ç²¾åº¦æ—¶é—´æˆ³"
tail -1 /var/log/messages
```

---

## 3. âš™ï¸ Journaldæ—¶é—´æˆ³ç²¾åº¦é…ç½®


### 3.1 Journaldæ—¶é—´æˆ³ç‰¹ç‚¹


**Journaldçš„æ—¶é—´æˆ³ä¼˜åŠ¿**ï¼š

```
ç²¾åº¦å¯¹æ¯”ï¼š
Syslogï¼š    2025-01-15 14:32:45 (ç§’çº§)
Journaldï¼š  2025-01-15 14:32:45.123456 (å¾®ç§’çº§)

å­˜å‚¨æ–¹å¼ï¼š
Syslogï¼š    å­˜å‚¨ä¸ºæ–‡æœ¬å­—ç¬¦ä¸²
Journaldï¼š  å­˜å‚¨ä¸ºæ•°å€¼ï¼ŒæŸ¥è¯¢æ›´é«˜æ•ˆ
```

**å¾®ç§’çº§ç²¾åº¦çš„æ„ä¹‰**ï¼š
- ğŸ¯ **é«˜å¹¶å‘åˆ†æ**ï¼šåŒºåˆ†æ¯«ç§’çº§çš„äº‹ä»¶é¡ºåº
- ğŸ” **æ€§èƒ½è°ƒä¼˜**ï¼šç²¾ç¡®æµ‹é‡æ“ä½œè€—æ—¶
- ğŸ› **è°ƒè¯•æ”¯æŒ**ï¼šæ›´å‡†ç¡®çš„äº‹ä»¶æ—¶åºåˆ†æ

### 3.2 Journaldé…ç½®æ–‡ä»¶


**ä¸»é…ç½®æ–‡ä»¶ä½ç½®**ï¼š`/etc/systemd/journald.conf`

```bash
# æŸ¥çœ‹å½“å‰é…ç½®
sudo cat /etc/systemd/journald.conf

# ä¸»è¦æ—¶é—´ç›¸å…³é…ç½®é¡¹
[Journal]
# å­˜å‚¨ä½ç½®
Storage=persistent
# æœ€å¤§ç£ç›˜ä½¿ç”¨
SystemMaxUse=100M
# å•ä¸ªæ–‡ä»¶å¤§å°
SystemMaxFileSize=10M
# ä¿ç•™æ—¶é—´
MaxRetentionSec=1month
# å‹ç¼©è®¾ç½®
Compress=yes
```

**æ—¶é—´æˆ³ç›¸å…³é…ç½®**ï¼š

```bash
# ç¼–è¾‘journaldé…ç½®
sudo vim /etc/systemd/journald.conf

# å…³é”®é…ç½®é¡¹
[Journal]
# æœ€å¤§ç£ç›˜ä½¿ç”¨ï¼ˆå½±å“æ—¥å¿—ä¿ç•™æ—¶é—´ï¼‰
SystemMaxUse=1G
# æ—¥å¿—ä¿ç•™æ—¶é—´
MaxRetentionSec=6month
# åŒæ­¥åˆ°ç£ç›˜çš„é¢‘ç‡ï¼ˆå½±å“æ—¶é—´æˆ³ç²¾åº¦ï¼‰
SyncIntervalSec=5m
```

### 3.3 Journalctlæ—¶é—´æŸ¥è¯¢


**åŸºæœ¬æ—¶é—´æŸ¥è¯¢è¯­æ³•**ï¼š

```bash
# æŸ¥çœ‹ä»Šå¤©çš„æ—¥å¿—
journalctl --since today

# æŸ¥çœ‹æ˜¨å¤©çš„æ—¥å¿—
journalctl --since yesterday

# æŸ¥çœ‹ç‰¹å®šæ—¶é—´èŒƒå›´
journalctl --since "2025-01-15 14:00:00" --until "2025-01-15 15:00:00"

# æŸ¥çœ‹æœ€è¿‘1å°æ—¶
journalctl --since "1 hour ago"

# æŸ¥çœ‹æœ€è¿‘30åˆ†é’Ÿ
journalctl --since "30 minutes ago"
```

**é«˜ç²¾åº¦æ—¶é—´æŸ¥è¯¢**ï¼š

```bash
# æ˜¾ç¤ºå®Œæ•´æ—¶é—´æˆ³ï¼ˆåŒ…å«å¾®ç§’ï¼‰
journalctl -o verbose

# æ˜¾ç¤ºJSONæ ¼å¼ï¼ˆåŒ…å«æ‰€æœ‰æ—¶é—´ä¿¡æ¯ï¼‰
journalctl -o json-pretty

# æ˜¾ç¤ºç®€æ´æ ¼å¼ä½†åŒ…å«å®Œæ•´æ—¶é—´
journalctl -o short-precise
```

**å®ç”¨æŸ¥è¯¢ç¤ºä¾‹**ï¼š

```bash
# æŸ¥æ‰¾ç³»ç»Ÿå¯åŠ¨ç›¸å…³çš„æ—¥å¿—
journalctl -b --since "10 minutes ago"

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡çš„æ—¶é—´èŒƒå›´æ—¥å¿—
journalctl -u nginx --since "2025-01-15 08:00" --until "2025-01-15 09:00"

# å®æ—¶ç›‘æ§æ–°æ—¥å¿—ï¼ˆç±»ä¼¼tail -fï¼‰
journalctl -f

# æŸ¥çœ‹å†…æ ¸æ—¥å¿—
journalctl -k --since "1 hour ago"
```

---

## 4. ğŸŒ æ—¥å¿—æ—¶åŒºä¸€è‡´æ€§å¤„ç†


### 4.1 æ—¶åŒºé—®é¢˜çš„å½±å“


**å¤šæ—¶åŒºç¯å¢ƒçš„æŒ‘æˆ˜**ï¼š

```
é—®é¢˜åœºæ™¯ï¼š
ğŸ“ åŒ—äº¬æœåŠ¡å™¨ï¼š2025-01-15 14:32:45 CST (+8)
ğŸ“ ä¼¦æ•¦æœåŠ¡å™¨ï¼š2025-01-15 06:32:45 GMT (0)
ğŸ“ çº½çº¦æœåŠ¡å™¨ï¼š2025-01-15 01:32:45 EST (-5)

çœ‹èµ·æ¥æ˜¯ä¸åŒæ—¶é—´ï¼Œå®é™…æ˜¯åŒä¸€æ—¶åˆ»ï¼
```

**æ—¶åŒºä¸ä¸€è‡´å¯¼è‡´çš„é—®é¢˜**ï¼š
- ğŸ” **æ•…éšœæ’æŸ¥å›°éš¾**ï¼šæ— æ³•å‡†ç¡®å…³è”ä¸åŒæœåŠ¡å™¨çš„äº‹ä»¶
- ğŸ“Š **æ•°æ®åˆ†æé”™è¯¯**ï¼šæ—¶é—´ç»Ÿè®¡ç»“æœä¸å‡†ç¡®
- ğŸš¨ **å‘Šè­¦å»¶è¿Ÿ**ï¼šå‘Šè­¦æ—¶é—´è®¡ç®—é”™è¯¯
- ğŸ“‹ **å®¡è®¡åˆè§„é—®é¢˜**ï¼šæ— æ³•æä¾›å‡†ç¡®çš„æ—¶é—´çº¿

### 4.2 ç³»ç»Ÿæ—¶åŒºé…ç½®


**æŸ¥çœ‹å½“å‰æ—¶åŒº**ï¼š

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨timedatectl
timedatectl

# æ–¹æ³•2ï¼šæŸ¥çœ‹æ—¶åŒºæ–‡ä»¶
ls -l /etc/localtime

# æ–¹æ³•3ï¼šæŸ¥çœ‹æ—¶åŒºç¯å¢ƒå˜é‡
echo $TZ

# æ–¹æ³•4ï¼šä½¿ç”¨dateå‘½ä»¤
date
```

**è®¾ç½®ç³»ç»Ÿæ—¶åŒº**ï¼š

```bash
# æŸ¥çœ‹å¯ç”¨æ—¶åŒºåˆ—è¡¨
timedatectl list-timezones

# è®¾ç½®ä¸ºä¸­å›½æ—¶åŒº
sudo timedatectl set-timezone Asia/Shanghai

# è®¾ç½®ä¸ºUTCæ—¶åŒºï¼ˆæ¨èç”¨äºæœåŠ¡å™¨ï¼‰
sudo timedatectl set-timezone UTC

# éªŒè¯è®¾ç½®
timedatectl status
```

> ğŸ’¡ **æœåŠ¡å™¨æ—¶åŒºæœ€ä½³å®è·µ**ï¼š
> å»ºè®®æ‰€æœ‰æœåŠ¡å™¨éƒ½ä½¿ç”¨UTCæ—¶åŒºï¼Œåœ¨åº”ç”¨å±‚è¿›è¡Œæ—¶åŒºè½¬æ¢

### 4.3 æ—¥å¿—æ—¶åŒºæ ‡å‡†åŒ–


**Rsyslogæ—¶åŒºé…ç½®**ï¼š

```bash
# ç¼–è¾‘rsyslogé…ç½®
sudo vim /etc/rsyslog.conf

# å¼ºåˆ¶ä½¿ç”¨UTCæ—¶é—´
$ActionFileDefaultTemplate RSYSLOG_FileFormat
# æˆ–è€…ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿ï¼Œæ˜ç¡®æŒ‡å®šUTC
$template UTCFormat,"%timestamp:::date-utc% %HOSTNAME% %syslogtag%%msg%\n"
$ActionFileDefaultTemplate UTCFormat
```

**Journaldæ—¶åŒºå¤„ç†**ï¼š

```bash
# journaldè‡ªåŠ¨ä½¿ç”¨ç³»ç»Ÿæ—¶åŒºï¼Œä½†å¯ä»¥æ˜¾ç¤ºä¸åŒæ ¼å¼

# æ˜¾ç¤ºUTCæ—¶é—´
journalctl -o short-unix

# æ˜¾ç¤ºæœ¬åœ°æ—¶é—´
journalctl -o short

# æ˜¾ç¤ºå®Œæ•´æ—¶åŒºä¿¡æ¯
journalctl -o verbose | head -20
```

**æ—¶åŒºè½¬æ¢è„šæœ¬ç¤ºä¾‹**ï¼š

```bash
#!/bin/bash
# æ—¥å¿—æ—¶åŒºè½¬æ¢è„šæœ¬

# å°†æœ¬åœ°æ—¶é—´è½¬æ¢ä¸ºUTC
convert_to_utc() {
    local log_file=$1
    local output_file=$2
    
    # ä½¿ç”¨awkè½¬æ¢æ—¶é—´æˆ³
    awk '{
        # å‡è®¾æ—¶é—´æˆ³åœ¨ç¬¬1å’Œç¬¬2å­—æ®µ
        cmd = "date -d \"" $1 " " $2 "\" -u \"+%Y-%m-%dT%H:%M:%SZ\""
        cmd | getline utc_time
        close(cmd)
        
        # æ›¿æ¢åŸæ—¶é—´æˆ³
        $1 = utc_time
        $2 = ""
        print $0
    }' "$log_file" > "$output_file"
}

# ä½¿ç”¨ç¤ºä¾‹
convert_to_utc "/var/log/messages" "/tmp/messages_utc.log"
```

---

## 5. ğŸ” æ—¶é—´æˆ³ç´¢å¼•ä¸æ£€ç´¢


### 5.1 é«˜æ•ˆæ—¶é—´æ£€ç´¢ç­–ç•¥


**æ—¶é—´æˆ³ç´¢å¼•çš„é‡è¦æ€§**ï¼š

```
æ— ç´¢å¼•æ£€ç´¢ï¼š
éœ€è¦é€è¡Œæ‰«ææ•´ä¸ªæ—¥å¿—æ–‡ä»¶
å¤§æ–‡ä»¶æ£€ç´¢é€Ÿåº¦ï¼šGBçº§åˆ«æ–‡ä»¶å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ

æœ‰ç´¢å¼•æ£€ç´¢ï¼š
é€šè¿‡æ—¶é—´æˆ³å¿«é€Ÿå®šä½åˆ°ç›¸å…³åŒºåŸŸ
æ£€ç´¢é€Ÿåº¦ï¼šç§’çº§å®Œæˆ
```

### 5.2 Journaldé«˜æ•ˆæŸ¥è¯¢


**æ—¶é—´èŒƒå›´æŸ¥è¯¢ä¼˜åŒ–**ï¼š

```bash
# ä½¿ç”¨ç»å¯¹æ—¶é—´ï¼ˆæœ€å¿«ï¼‰
journalctl --since "2025-01-15 14:00:00" --until "2025-01-15 15:00:00"

# ä½¿ç”¨ç›¸å¯¹æ—¶é—´
journalctl --since "2 hours ago" --until "1 hour ago"

# ç»„åˆæ¡ä»¶æŸ¥è¯¢ï¼ˆå…ˆæ—¶é—´åå…¶ä»–æ¡ä»¶ï¼‰
journalctl --since today -u nginx -p err

# ä½¿ç”¨æ¸¸æ ‡ï¼ˆcursorï¼‰è¿›è¡Œåˆ†é¡µæŸ¥è¯¢
journalctl --after-cursor="s=8c4e..."
```

**æ€§èƒ½ä¼˜åŒ–æŠ€å·§**ï¼š

```bash
# 1. é™åˆ¶è¾“å‡ºè¡Œæ•°
journalctl -n 100 --since "1 hour ago"

# 2. æŒ‡å®šå…·ä½“æœåŠ¡
journalctl -u sshd --since today

# 3. ä½¿ç”¨ä¼˜å…ˆçº§è¿‡æ»¤
journalctl -p warning --since "2 hours ago"

# 4. è¾“å‡ºåˆ°æ–‡ä»¶è€Œä¸æ˜¯ç»ˆç«¯
journalctl --since today > today.log

# 5. ä½¿ç”¨--no-pageré¿å…åˆ†é¡µ
journalctl --no-pager -n 50
```

### 5.3 æ–‡æœ¬æ—¥å¿—æ£€ç´¢ä¼˜åŒ–


**åˆ›å»ºæ—¶é—´ç´¢å¼•**ï¼š

```bash
#!/bin/bash
# ä¸ºå¤§å‹æ—¥å¿—æ–‡ä»¶åˆ›å»ºæ—¶é—´ç´¢å¼•

create_time_index() {
    local log_file=$1
    local index_file="${log_file}.index"
    
    # æå–æ—¶é—´æˆ³å’Œè¡Œå·
    grep -n "^[A-Z][a-z][a-z] [0-9 ][0-9] [0-9][0-9]:" "$log_file" | \
    awk -F: '{
        # æå–è¡Œå·å’Œæ—¶é—´æˆ³
        line_num = $1
        timestamp = $2 ":" $3 ":" $4
        print timestamp " " line_num
    }' > "$index_file"
    
    echo "ç´¢å¼•å·²åˆ›å»ºï¼š$index_file"
}

# ä½¿ç”¨ç´¢å¼•å¿«é€ŸæŸ¥æ‰¾
search_by_time() {
    local log_file=$1
    local target_time=$2
    local index_file="${log_file}.index"
    
    # åœ¨ç´¢å¼•ä¸­æŸ¥æ‰¾æ¥è¿‘çš„æ—¶é—´
    line_num=$(grep -A1 -B1 "$target_time" "$index_file" | \
               awk '{print $2}' | head -1)
    
    # ä»æ‰¾åˆ°çš„è¡Œå·å¼€å§‹æ˜¾ç¤º
    sed -n "${line_num},+100p" "$log_file"
}
```

**ä½¿ç”¨å·¥å…·åŠ é€Ÿæ£€ç´¢**ï¼š

```bash
# ä½¿ç”¨ripgrepï¼ˆæ¯”grepæ›´å¿«ï¼‰
rg "ERROR" --type log --after-context 5 --before-context 5

# ä½¿ç”¨agï¼ˆé“¶æœç´¢å™¨ï¼‰
ag "Failed login" /var/log/ --time-limit 30

# ä½¿ç”¨zgrepæœç´¢å‹ç¼©æ—¥å¿—
zgrep "2025-01-15 14:" /var/log/messages.*.gz
```

---

## 6. ğŸ”„ å¤šæœåŠ¡å™¨æ—¥å¿—æ—¶é—´åŒæ­¥


### 6.1 æ—¶é—´åŒæ­¥çš„é‡è¦æ€§


**æ—¶é—´ä¸åŒæ­¥çš„åæœ**ï¼š

```
æœåŠ¡å™¨æ—¶é—´å·®å¼‚ç¤ºä¾‹ï¼š
WebæœåŠ¡å™¨ï¼š  14:32:45.123  ç”¨æˆ·è¯·æ±‚
è´Ÿè½½å‡è¡¡å™¨ï¼š14:32:44.890  è½¬å‘è¯·æ±‚ï¼ˆæ…¢233msï¼‰
æ•°æ®åº“ï¼š    14:32:46.001  æŸ¥è¯¢æ‰§è¡Œï¼ˆå¿«1.2sï¼‰

åˆ†æç»“æœï¼šçœ‹èµ·æ¥æ•°æ®åº“æ¯”ç”¨æˆ·è¯·æ±‚è¿˜æ—©ï¼Ÿæ˜æ˜¾ä¸å¯¹ï¼
```

> âš ï¸ **è­¦å‘Š**ï¼šå³ä½¿å‡ æ¯«ç§’çš„æ—¶é—´å·®å¼‚ä¹Ÿä¼šå½±å“æ—¥å¿—åˆ†æçš„å‡†ç¡®æ€§

### 6.2 NTP/Chronyæ—¶é—´åŒæ­¥


**ä½¿ç”¨ChronyåŒæ­¥æ—¶é—´**ï¼š

```bash
# å®‰è£…chrony
sudo apt-get install chrony  # Ubuntu/Debian
sudo yum install chrony      # CentOS/RHEL

# é…ç½®chrony
sudo vim /etc/chrony.conf

# æ·»åŠ æ—¶é—´æœåŠ¡å™¨
pool ntp.aliyun.com iburst
pool time.cloudflare.com iburst
pool pool.ntp.org iburst

# é‡å¯å¹¶å¯ç”¨æœåŠ¡
sudo systemctl restart chronyd
sudo systemctl enable chronyd

# æŸ¥çœ‹åŒæ­¥çŠ¶æ€
chronyc tracking
chronyc sources -v
```

**éªŒè¯æ—¶é—´åŒæ­¥æ•ˆæœ**ï¼š

```bash
# æ£€æŸ¥æ—¶é—´åŒæ­¥çŠ¶æ€
timedatectl status

# æŸ¥çœ‹æ—¶é—´åå·®
chronyc tracking | grep "System time"

# å¼ºåˆ¶ç«‹å³åŒæ­¥
sudo chronyc makestep

# ç›‘æ§æ—¶é—´åå·®
watch -n 1 'chronyc tracking | grep "System time"'
```

### 6.3 é›†ä¸­åŒ–æ—¥å¿—ç®¡ç†


**ELK Stackæ—¶é—´å¤„ç†**ï¼š

```yaml
# Logstashæ—¶é—´æˆ³è§£æé…ç½®
filter {
  date {
    match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
    target => "@timestamp"
    timezone => "UTC"
  }
}
```

**Rsyslogé›†ä¸­æ”¶é›†é…ç½®**ï¼š

```bash
# ä¸­å¤®æ—¥å¿—æœåŠ¡å™¨é…ç½®
sudo vim /etc/rsyslog.conf

# å¯ç”¨ç½‘ç»œæ¥æ”¶
$ModLoad imudp
$UDPServerRun 514
$ModLoad imtcp
$InputTCPServerRun 514

# æŒ‰ä¸»æœºååˆ†ç±»å­˜å‚¨
$template RemoteStore,"/var/log/remote/%HOSTNAME%/%$YEAR%-%$MONTH%-%$DAY%.log"
*.* ?RemoteStore

# å®¢æˆ·ç«¯é…ç½®ï¼ˆå‘é€æ—¥å¿—åˆ°ä¸­å¤®æœåŠ¡å™¨ï¼‰
*.* @192.168.1.100:514  # UDPä¼ è¾“
*.* $$192.168.1.100:514 # TCPä¼ è¾“
```

---

## 7. ğŸ“‚ æ—¥å¿—è½®è½¬æ—¶é—´ç­–ç•¥


### 7.1 ä»€ä¹ˆæ˜¯æ—¥å¿—è½®è½¬


**æ—¥å¿—è½®è½¬çš„ç›®çš„**ï¼š

```
é—®é¢˜ï¼šæ—¥å¿—æ–‡ä»¶ä¼šæ— é™å¢é•¿
/var/log/messages: 1GB -> 2GB -> 5GB -> 10GB...

è§£å†³ï¼šå®šæœŸè½®è½¬æ—¥å¿—æ–‡ä»¶
messages      (å½“å‰æ—¥å¿—)
messages.1    (æ˜¨å¤©çš„æ—¥å¿—)  
messages.2    (å‰å¤©çš„æ—¥å¿—)
messages.3.gz (å‹ç¼©çš„æ—§æ—¥å¿—)
```

**è½®è½¬çš„å¥½å¤„**ï¼š
- ğŸ’¾ **èŠ‚çœç£ç›˜ç©ºé—´**ï¼šåˆ é™¤æˆ–å‹ç¼©æ—§æ—¥å¿—
- âš¡ **æé«˜æ€§èƒ½**ï¼šå‡å°å½“å‰æ—¥å¿—æ–‡ä»¶å¤§å°
- ğŸ” **ä¾¿äºç®¡ç†**ï¼šæŒ‰æ—¶é—´ç»„ç»‡æ—¥å¿—æ–‡ä»¶
- ğŸ“‹ **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³æ—¥å¿—ä¿ç•™æ”¿ç­–

### 7.2 Logrotateé…ç½®


**ä¸»é…ç½®æ–‡ä»¶**ï¼š`/etc/logrotate.conf`

```bash
# æŸ¥çœ‹å½“å‰é…ç½®
cat /etc/logrotate.conf

# å…¨å±€é»˜è®¤é…ç½®
weekly          # æ¯å‘¨è½®è½¬
rotate 4        # ä¿ç•™4ä¸ªæ—§ç‰ˆæœ¬
create          # è½®è½¬ååˆ›å»ºæ–°æ–‡ä»¶
dateext         # ä½¿ç”¨æ—¥æœŸæ‰©å±•å
compress        # å‹ç¼©æ—§æ–‡ä»¶
```

**é’ˆå¯¹ä¸åŒæ—¥å¿—çš„é…ç½®**ï¼š

```bash
# ç¼–è¾‘ç‰¹å®šæœåŠ¡çš„è½®è½¬é…ç½®
sudo vim /etc/logrotate.d/nginx

/var/log/nginx/*.log {
    daily           # æ¯å¤©è½®è½¬
    missingok       # æ–‡ä»¶ä¸å­˜åœ¨ä¸æŠ¥é”™
    rotate 30       # ä¿ç•™30å¤©
    compress        # å‹ç¼©æ—§æ–‡ä»¶
    delaycompress   # å»¶è¿Ÿå‹ç¼©ï¼ˆä¸‹æ¬¡è½®è½¬æ—¶å‹ç¼©ï¼‰
    notifempty      # ç©ºæ–‡ä»¶ä¸è½®è½¬
    create 0644 www-data www-data  # åˆ›å»ºæ–°æ–‡ä»¶çš„æƒé™å’Œæ‰€æœ‰è€…
    postrotate      # è½®è½¬åæ‰§è¡Œçš„å‘½ä»¤
        systemctl reload nginx
    endscript
}
```

**æ—¶é—´ç›¸å…³çš„è½®è½¬ç­–ç•¥**ï¼š

| é…ç½®é¡¹ | **è¯´æ˜** | **ç¤ºä¾‹** |
|--------|---------|---------|
| `daily` | `æ¯å¤©è½®è½¬` | `é€‚åˆé«˜æµé‡ç½‘ç«™` |
| `weekly` | `æ¯å‘¨è½®è½¬` | `é€‚åˆä¸­ç­‰æµé‡åº”ç”¨` |
| `monthly` | `æ¯æœˆè½®è½¬` | `é€‚åˆä½æµé‡ç³»ç»Ÿ` |
| `size 100M` | `æŒ‰å¤§å°è½®è½¬` | `æ–‡ä»¶è¾¾åˆ°100MBæ—¶è½®è½¬` |
| `maxage 30` | `ä¿ç•™å¤©æ•°` | `è¶…è¿‡30å¤©çš„æ–‡ä»¶è¢«åˆ é™¤` |

### 7.3 æ‰‹åŠ¨æµ‹è¯•è½®è½¬


**æµ‹è¯•è½®è½¬é…ç½®**ï¼š

```bash
# æµ‹è¯•ç‰¹å®šé…ç½®æ–‡ä»¶
sudo logrotate -d /etc/logrotate.d/nginx

# å¼ºåˆ¶æ‰§è¡Œè½®è½¬ï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰
sudo logrotate -f /etc/logrotate.d/nginx

# æŸ¥çœ‹è½®è½¬çŠ¶æ€
cat /var/lib/logrotate/status

# æ‰‹åŠ¨æ‰§è¡Œæ‰€æœ‰è½®è½¬
sudo logrotate -f /etc/logrotate.conf
```

**ç›‘æ§è½®è½¬æ•ˆæœ**ï¼š

```bash
# æŸ¥çœ‹è½®è½¬å‰åçš„æ–‡ä»¶
ls -lh /var/log/nginx/

# ç›‘æ§ç£ç›˜ä½¿ç”¨æƒ…å†µ
df -h /var/log

# æ£€æŸ¥è½®è½¬åçš„æ–‡ä»¶å®Œæ•´æ€§
zcat /var/log/nginx/access.log.1.gz | wc -l
```

---

## 8. ğŸ›¡ï¸ å®¡è®¡æ—¥å¿—æ—¶é—´è¦æ±‚


### 8.1 å®¡è®¡æ—¥å¿—çš„ç‰¹æ®Šè¦æ±‚


**æ³•è§„åˆè§„è¦æ±‚**ï¼š

```
é‡‘èè¡Œä¸šï¼šæ—¥å¿—éœ€è¦ä¿ç•™7å¹´ï¼Œæ—¶é—´æˆ³ä¸å¯ç¯¡æ”¹
åŒ»ç–—è¡Œä¸šï¼šæ‚£è€…æ•°æ®è®¿é—®æ—¥å¿—éœ€è¦ç²¾ç¡®åˆ°ç§’
æ”¿åºœéƒ¨é—¨ï¼šå®‰å…¨äº‹ä»¶æ—¥å¿—éœ€è¦æ³•å¾‹çº§åˆ«çš„æ—¶é—´è¯æ˜
```

**å®¡è®¡æ—¥å¿—çš„æ—¶é—´ç‰¹å¾**ï¼š
- ğŸ”’ **ä¸å¯ç¯¡æ”¹**ï¼šæ—¶é—´æˆ³ä¸€æ—¦å†™å…¥ä¸èƒ½ä¿®æ”¹
- â° **é«˜ç²¾åº¦**ï¼šé€šå¸¸éœ€è¦æ¯«ç§’æˆ–å¾®ç§’çº§ç²¾åº¦
- ğŸ”„ **è¿ç»­æ€§**ï¼šä¸èƒ½æœ‰æ—¶é—´é—´éš™
- ğŸ“ **æ—¶åŒºæ˜ç¡®**ï¼šå¿…é¡»æ˜ç¡®æ ‡æ³¨æ—¶åŒºä¿¡æ¯

### 8.2 Auditdå®¡è®¡ç³»ç»Ÿ


**å¯ç”¨ç³»ç»Ÿå®¡è®¡**ï¼š

```bash
# å®‰è£…auditå·¥å…·
sudo apt-get install auditd audispd-plugins

# å¯åŠ¨å®¡è®¡æœåŠ¡
sudo systemctl start auditd
sudo systemctl enable auditd

# æŸ¥çœ‹å®¡è®¡çŠ¶æ€
sudo auditctl -s
```

**é…ç½®å®¡è®¡è§„åˆ™**ï¼š

```bash
# ç¼–è¾‘å®¡è®¡è§„åˆ™
sudo vim /etc/audit/rules.d/audit.rules

# ç›‘æ§é‡è¦æ–‡ä»¶è®¿é—®
-w /etc/passwd -p wa -k passwd_changes
-w /etc/shadow -p wa -k shadow_changes
-w /var/log/ -p wa -k log_access

# ç›‘æ§ç½‘ç»œè¿æ¥
-a always,exit -F arch=b64 -S connect -k network_connect

# ç›‘æ§æ–‡ä»¶åˆ é™¤
-a always,exit -F arch=b64 -S unlink -S rmdir -k file_deletion
```

**å®¡è®¡æ—¥å¿—æ—¶é—´æˆ³åˆ†æ**ï¼š

```bash
# æŸ¥çœ‹å®¡è®¡æ—¥å¿—
sudo ausearch -ts today

# æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢
sudo ausearch -ts 14:00:00 -te 15:00:00

# æŸ¥çœ‹ç‰¹å®šäº‹ä»¶
sudo ausearch -k passwd_changes

# ç”Ÿæˆå®¡è®¡æŠ¥å‘Š
sudo aureport --start today --end now
```

### 8.3 ç¡®ä¿æ—¶é—´æˆ³å®Œæ•´æ€§


**é˜²ç¯¡æ”¹æªæ–½**ï¼š

```bash
# 1. é…ç½®auditæ—¥å¿—ä¸å¯å˜
sudo chattr +a /var/log/audit/audit.log

# 2. ä½¿ç”¨è¿œç¨‹æ—¥å¿—æœåŠ¡å™¨
sudo vim /etc/audisp/plugins.d/syslog.conf
active = yes
direction = out
path = builtin_syslog
type = builtin
args = LOG_LOCAL6
format = string

# 3. é…ç½®æ—¥å¿—ç­¾å
sudo vim /etc/audit/auditd.conf
# å¯ç”¨æ—¥å¿—ç­¾å
log_format = ENRICHED
```

**æ—¶é—´æˆ³éªŒè¯è„šæœ¬**ï¼š

```bash
#!/bin/bash
# éªŒè¯å®¡è®¡æ—¥å¿—æ—¶é—´æˆ³è¿ç»­æ€§

check_audit_continuity() {
    local log_file="/var/log/audit/audit.log"
    local last_timestamp=0
    local line_num=0
    
    while read -r line; do
        line_num=$((line_num + 1))
        
        # æå–æ—¶é—´æˆ³
        timestamp=$(echo "$line" | grep -o 'msg=audit([0-9.]*)')
        if [[ -n "$timestamp" ]]; then
            current_ts=$(echo "$timestamp" | sed 's/msg=audit(\([0-9.]*\).*/\1/')
            
            # æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦é€’å¢
            if (( $(echo "$current_ts < $last_timestamp" | bc -l) )); then
                echo "è­¦å‘Šï¼šç¬¬${line_num}è¡Œæ—¶é—´æˆ³å¼‚å¸¸"
                echo "å½“å‰ï¼š$current_tsï¼Œä¸Šä¸€ä¸ªï¼š$last_timestamp"
            fi
            
            last_timestamp=$current_ts
        fi
    done < "$log_file"
}

check_audit_continuity
```

---

## 9. ğŸ”§ æ—¥å¿—æ—¶é—´å¼‚å¸¸æ’æŸ¥


### 9.1 å¸¸è§æ—¶é—´å¼‚å¸¸é—®é¢˜


**å…¸å‹é—®é¢˜ç±»å‹**ï¼š

```
ğŸ• æ—¶é—´è·³è·ƒï¼š
2025-01-15 14:32:45
2025-01-15 16:45:23  â† çªç„¶è·³è·ƒ2å°æ—¶
2025-01-15 14:35:12  â† åˆå›åˆ°è¿‡å»

ğŸ”„ æ—¶é—´é‡å¤ï¼š
2025-01-15 14:32:45
2025-01-15 14:32:45  â† å®Œå…¨ç›¸åŒçš„æ—¶é—´æˆ³
2025-01-15 14:32:45

â° æ—¶åŒºæ··ä¹±ï¼š
åŒä¸€ä¸ªäº‹ä»¶åœ¨ä¸åŒæ—¥å¿—ä¸­æ˜¾ç¤ºä¸åŒæ—¶é—´
```

### 9.2 è¯Šæ–­å·¥å…·å’Œæ–¹æ³•


**ç³»ç»Ÿæ—¶é—´æ£€æŸ¥**ï¼š

```bash
# æ£€æŸ¥ç³»ç»Ÿæ—¶é—´çŠ¶æ€
timedatectl status

# æ£€æŸ¥ç¡¬ä»¶æ—¶é—´
sudo hwclock --show

# æ¯”è¾ƒç³»ç»Ÿæ—¶é—´å’Œç¡¬ä»¶æ—¶é—´
echo "ç³»ç»Ÿæ—¶é—´ï¼š$(date)"
echo "ç¡¬ä»¶æ—¶é—´ï¼š$(sudo hwclock --show)"

# æ£€æŸ¥æ—¶é—´åŒæ­¥çŠ¶æ€
chronyc tracking
chronyc sources -v
```

**æ—¥å¿—æ—¶é—´åˆ†æè„šæœ¬**ï¼š

```bash
#!/bin/bash
# åˆ†ææ—¥å¿—æ—¶é—´æˆ³å¼‚å¸¸

analyze_log_timestamps() {
    local log_file=$1
    local prev_timestamp=""
    local line_num=0
    
    echo "åˆ†ææ—¥å¿—æ–‡ä»¶ï¼š$log_file"
    echo "================================"
    
    while IFS= read -r line; do
        line_num=$((line_num + 1))
        
        # æå–æ—¶é—´æˆ³ï¼ˆå‡è®¾æ˜¯æ ‡å‡†æ ¼å¼ï¼‰
        timestamp=$(echo "$line" | grep -o '^[A-Z][a-z][a-z] [0-9 ][0-9] [0-9][0-9]:[0-9][0-9]:[0-9][0-9]')
        
        if [[ -n "$timestamp" ]]; then
            # è½¬æ¢ä¸ºç§’æ•°è¿›è¡Œæ¯”è¾ƒ
            current_sec=$(date -d "$timestamp" +%s 2>/dev/null)
            prev_sec=$(date -d "$prev_timestamp" +%s 2>/dev/null)
            
            if [[ -n "$prev_sec" && -n "$current_sec" ]]; then
                diff=$((current_sec - prev_sec))
                
                # æ£€æŸ¥å¼‚å¸¸æƒ…å†µ
                if [[ $diff -lt 0 ]]; then
                    echo "âš ï¸  æ—¶é—´å€’é€€ (è¡Œ$line_num): $timestamp (å€’é€€${diff#-}ç§’)"
                elif [[ $diff -gt 3600 ]]; then
                    echo "âš ï¸  æ—¶é—´è·³è·ƒ (è¡Œ$line_num): $timestamp (è·³è·ƒ$diffç§’)"
                elif [[ $diff -eq 0 ]]; then
                    echo "â„¹ï¸  ç›¸åŒæ—¶é—´ (è¡Œ$line_num): $timestamp"
                fi
            fi
            
            prev_timestamp=$timestamp
        fi
    done < "$log_file"
}

# ä½¿ç”¨ç¤ºä¾‹
analyze_log_timestamps "/var/log/messages"
```

### 9.3 ä¿®å¤æ—¶é—´å¼‚å¸¸


**æ—¶é—´åŒæ­¥ä¿®å¤**ï¼š

```bash
# 1. ç«‹å³åŒæ­¥æ—¶é—´
sudo chronyc makestep

# 2. é‡å¯æ—¶é—´åŒæ­¥æœåŠ¡
sudo systemctl restart chronyd

# 3. ä¿®æ­£ç¡¬ä»¶æ—¶é’Ÿ
sudo hwclock --systohc

# 4. éªŒè¯ä¿®å¤æ•ˆæœ
timedatectl status
```

**æ—¥å¿—æ—¶é—´ä¿®å¤è„šæœ¬**ï¼š

```bash
#!/bin/bash
# ä¿®å¤æ—¥å¿—ä¸­çš„æ—¶é—´æˆ³å¼‚å¸¸

fix_log_timestamps() {
    local log_file=$1
    local fixed_file="${log_file}.fixed"
    local last_valid_time=""
    
    echo "ä¿®å¤æ—¥å¿—æ–‡ä»¶ï¼š$log_file"
    
    while IFS= read -r line; do
        # æå–æ—¶é—´æˆ³
        timestamp=$(echo "$line" | grep -o '^[A-Z][a-z][a-z] [0-9 ][0-9] [0-9][0-9]:[0-9][0-9]:[0-9][0-9]')
        
        if [[ -n "$timestamp" ]]; then
            current_sec=$(date -d "$timestamp" +%s 2>/dev/null)
            last_sec=$(date -d "$last_valid_time" +%s 2>/dev/null)
            
            # å¦‚æœæ—¶é—´æˆ³æœ‰æ•ˆä¸”åˆç†ï¼Œä½¿ç”¨å®ƒ
            if [[ -n "$current_sec" ]] && 
               [[ -z "$last_sec" || $current_sec -ge $last_sec ]]; then
                last_valid_time=$timestamp
                echo "$line" >> "$fixed_file"
            else
                # ä½¿ç”¨ä¸Šä¸€ä¸ªæœ‰æ•ˆæ—¶é—´æˆ³
                if [^ -n "$last_valid_time" ]]; then
                    fixed_line=$(echo "$line" | sed "s/^[A-Z][a-z][a-z] [0-9 ][0-9] [0-9][0-9]:[0-9][0-9]:[0-9][0-9]/$last_valid_time/")
                    echo "$fixed_line" >> "$fixed_file"
                fi
            fi
        else
            echo "$line" >> "$fixed_file"
        fi
    done < "$log_file"
    
    echo "ä¿®å¤å®Œæˆï¼Œç»“æœä¿å­˜åˆ°ï¼š$fixed_file"
}
```

**é¢„é˜²æªæ–½**ï¼š

```bash
# 1. è®¾ç½®å®šæœŸæ—¶é—´åŒæ­¥æ£€æŸ¥
echo "*/5 * * * * chronyc tracking | grep 'System time' | awk '{if($4>0.1) print \"æ—¶é—´åå·®è¿‡å¤§:\", $0}' | logger" | crontab -

# 2. ç›‘æ§æ—¶é—´åŒæ­¥çŠ¶æ€
cat > /usr/local/bin/check_time_sync.sh << 'EOF'
#!/bin/bash
OFFSET=$(chronyc tracking | grep "System time" | awk '{print $4}')
if (( $(echo "$OFFSET > 0.1" | bc -l) )); then
    logger "WARNING: Time offset is $OFFSET seconds"
    # å¯ä»¥åœ¨è¿™é‡Œå‘é€å‘Šè­¦é‚®ä»¶
fi
EOF

chmod +x /usr/local/bin/check_time_sync.sh

# 3. æ·»åŠ åˆ°crontab
echo "*/10 * * * * /usr/local/bin/check_time_sync.sh" | crontab -
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ—¶é—´æˆ³æœ¬è´¨ï¼šè®°å½•äº‹ä»¶å‘ç”Ÿç²¾ç¡®æ—¶é—´çš„æ ‡è®°
ğŸ”¸ ä¸¤å¤§æ—¥å¿—ç³»ç»Ÿï¼šSyslogï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰å’ŒJournaldï¼ˆäºŒè¿›åˆ¶æ ¼å¼ï¼‰
ğŸ”¸ æ—¶é—´ç²¾åº¦å·®å¼‚ï¼šSyslogç§’çº§ vs Journaldå¾®ç§’çº§
ğŸ”¸ æ—¶åŒºä¸€è‡´æ€§ï¼šå¤šæœåŠ¡å™¨ç¯å¢ƒå¿…é¡»ç»Ÿä¸€æ—¶åŒº
ğŸ”¸ æ—¶é—´åŒæ­¥ï¼šä½¿ç”¨NTP/Chronyç¡®ä¿æ—¶é—´å‡†ç¡®
ğŸ”¸ æ—¥å¿—è½®è½¬ï¼šå®šæœŸå½’æ¡£é˜²æ­¢æ—¥å¿—æ–‡ä»¶è¿‡å¤§
ğŸ”¸ å®¡è®¡è¦æ±‚ï¼šåˆè§„åœºæ™¯éœ€è¦ä¸å¯ç¯¡æ”¹çš„æ—¶é—´æˆ³
ğŸ”¸ å¼‚å¸¸æ’æŸ¥ï¼šè¯†åˆ«å’Œä¿®å¤æ—¶é—´æˆ³å¼‚å¸¸é—®é¢˜
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆæ—¶é—´æˆ³å¦‚æ­¤é‡è¦**
```
å®é™…æ„ä¹‰ï¼š
- æ•…éšœæ’æŸ¥ï¼šé€šè¿‡æ—¶é—´çº¿è¿½è¸ªé—®é¢˜æ ¹å› 
- æ€§èƒ½åˆ†æï¼šè¯†åˆ«ç³»ç»Ÿç“¶é¢ˆå’Œå¼‚å¸¸æ¨¡å¼  
- å®‰å…¨å®¡è®¡ï¼šè¿½è¸ªå®‰å…¨äº‹ä»¶çš„å‘ç”Ÿæ—¶é—´
- åˆè§„è¦æ±‚ï¼šæ»¡è¶³æ³•è§„å¯¹æ—¥å¿—ä¿ç•™çš„è¦æ±‚
```

**ğŸ”¹ æ—¶é—´åŒæ­¥çš„å¿…è¦æ€§**
```
å…³é”®ç†è§£ï¼š
- å³ä½¿å‡ æ¯«ç§’çš„æ—¶é—´å·®å¼‚ä¹Ÿä¼šå½±å“æ—¥å¿—åˆ†æ
- åˆ†å¸ƒå¼ç³»ç»Ÿå¿…é¡»æœ‰ç»Ÿä¸€çš„æ—¶é—´å‚è€ƒ
- æ—¶é—´ä¸å‡†ç¡®ä¼šå¯¼è‡´å‘Šè­¦å’Œç›‘æ§å¤±æ•ˆ
- å®¡è®¡æ—¥å¿—éœ€è¦æ³•å¾‹çº§åˆ«çš„æ—¶é—´å‡†ç¡®æ€§
```

**ğŸ”¹ ä¸åŒåœºæ™¯çš„æ—¶é—´ç²¾åº¦éœ€æ±‚**
```
ç²¾åº¦éœ€æ±‚ï¼š
- ä¸€èˆ¬åº”ç”¨ï¼šç§’çº§ç²¾åº¦å¤Ÿç”¨
- é«˜å¹¶å‘ç³»ç»Ÿï¼šéœ€è¦æ¯«ç§’çº§ç²¾åº¦
- é‡‘èäº¤æ˜“ï¼šéœ€è¦å¾®ç§’çº§ç²¾åº¦
- è°ƒè¯•åˆ†æï¼šç²¾åº¦è¶Šé«˜è¶Šå¥½
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æ—¥å¸¸è¿ç»´å»ºè®®**
```
æœ€ä½³å®è·µï¼š
âœ… æ‰€æœ‰æœåŠ¡å™¨ä½¿ç”¨UTCæ—¶åŒº
âœ… é…ç½®è‡ªåŠ¨æ—¶é—´åŒæ­¥ï¼ˆchrony/ntpï¼‰
âœ… å®šæœŸæ£€æŸ¥æ—¶é—´åå·®
âœ… ä½¿ç”¨é«˜ç²¾åº¦æ—¶é—´æˆ³æ ¼å¼
âœ… å»ºç«‹ä¸­å¤®æ—¥å¿—æ”¶é›†ç³»ç»Ÿ
âœ… é…ç½®åˆé€‚çš„æ—¥å¿—è½®è½¬ç­–ç•¥
âœ… ç›‘æ§æ—¥å¿—æ—¶é—´å¼‚å¸¸
```

**ğŸ”§ æ•…éšœæ’æŸ¥æ€è·¯**
```
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥ç³»ç»Ÿæ—¶é—´æ˜¯å¦å‡†ç¡®
2. éªŒè¯æ—¶é—´åŒæ­¥æœåŠ¡çŠ¶æ€
3. å¯¹æ¯”ä¸åŒæœåŠ¡å™¨çš„æ—¶é—´
4. åˆ†ææ—¥å¿—æ—¶é—´æˆ³è¿ç»­æ€§
5. æ£€æŸ¥æ—¶åŒºé…ç½®ä¸€è‡´æ€§
6. ç¡®è®¤æ—¥å¿—æœåŠ¡é…ç½®æ­£ç¡®
```

**âš ï¸ å¸¸è§é™·é˜±é¿å…**
```
éœ€è¦æ³¨æ„ï¼š
âŒ æ··ç”¨ä¸åŒæ—¶åŒºå¯¼è‡´åˆ†æé”™è¯¯
âŒ å¿½ç•¥é—°ç§’å¯¹æ—¶é—´æˆ³çš„å½±å“  
âŒ æ—¥å¿—è½®è½¬æ—¶é—´é…ç½®ä¸å½“
âŒ å®¡è®¡æ—¥å¿—ç¼ºå°‘é˜²ç¯¡æ”¹æªæ–½
âŒ æ—¶é—´åŒæ­¥æœåŠ¡é…ç½®é”™è¯¯
âŒ å¿½ç•¥ç¡¬ä»¶æ—¶é’Ÿçš„æ¼‚ç§»
```

### 10.4 æ‰©å±•å­¦ä¹ æ–¹å‘


```
è¿›é˜¶ä¸»é¢˜ï¼š
ğŸ”¹ åˆ†å¸ƒå¼ç³»ç»Ÿæ—¶é—´ä¸€è‡´æ€§ç®—æ³•
ğŸ”¹ é«˜å¯ç”¨æ—¥å¿—æ”¶é›†æ¶æ„è®¾è®¡
ğŸ”¹ æ—¥å¿—æ•°æ®çš„å®æ—¶æµå¤„ç†
ğŸ”¹ åŸºäºæœºå™¨å­¦ä¹ çš„å¼‚å¸¸æ—¶é—´æˆ³æ£€æµ‹
ğŸ”¹ åŒºå—é“¾æŠ€æœ¯åœ¨æ—¥å¿—é˜²ç¯¡æ”¹ä¸­çš„åº”ç”¨
ğŸ”¹ äº‘åŸç”Ÿç¯å¢ƒä¸‹çš„æ—¥å¿—æ—¶é—´ç®¡ç†
```

> ğŸ’¡ **æ ¸å¿ƒè®°å¿†**ï¼š
> æ—¶é—´æˆ³æ˜¯æ—¥å¿—çš„ç”Ÿå‘½çº¿ï¼Œå‡†ç¡®çš„æ—¶é—´è®°å½•æ˜¯ç³»ç»Ÿè¿ç»´å’Œæ•…éšœæ’æŸ¥çš„åŸºç¡€ã€‚æŒæ¡æ—¶é—´æˆ³ç®¡ç†ä¸ä»…ä»…æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œæ›´æ˜¯ä¿è¯ç³»ç»Ÿå¯è§‚æµ‹æ€§å’Œåˆè§„æ€§çš„å…³é”®èƒ½åŠ›ã€‚