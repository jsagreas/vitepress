---
title: 9ã€æ—¥å¿—å’Œå®¡è®¡å®‰å…¨
---
## ğŸ“š ç›®å½•

1. [æ—¥å¿—å®‰å…¨åŸºç¡€æ¦‚å¿µ](#1-æ—¥å¿—å®‰å…¨åŸºç¡€æ¦‚å¿µ)
2. [systemdæ—¥å¿—é…ç½®å®‰å…¨](#2-systemdæ—¥å¿—é…ç½®å®‰å…¨)
3. [æ•æ„Ÿä¿¡æ¯ä¿æŠ¤ç­–ç•¥](#3-æ•æ„Ÿä¿¡æ¯ä¿æŠ¤ç­–ç•¥)
4. [æ—¥å¿—è½®è½¬ä¸å®Œæ•´æ€§](#4-æ—¥å¿—è½®è½¬ä¸å®Œæ•´æ€§)
5. [å®¡è®¡äº‹ä»¶è®°å½•æœºåˆ¶](#5-å®¡è®¡äº‹ä»¶è®°å½•æœºåˆ¶)
6. [å®‰å…¨ç›‘æ§å‘Šè­¦ä½“ç³»](#6-å®‰å…¨ç›‘æ§å‘Šè­¦ä½“ç³»)
7. [å®æˆ˜é…ç½®æ¡ˆä¾‹](#7-å®æˆ˜é…ç½®æ¡ˆä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ æ—¥å¿—å®‰å…¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ—¥å¿—å®‰å…¨


**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
æ—¥å¿—å®‰å…¨å°±åƒç»™ä½ å®¶å®‰è£…"ç›‘æ§æ‘„åƒå¤´"å’Œ"ä¿é™©ç®±"ï¼š
- **ç›‘æ§åŠŸèƒ½**ï¼šè®°å½•ç³»ç»Ÿå‘ç”Ÿçš„æ‰€æœ‰é‡è¦äº‹ä»¶
- **ä¿æŠ¤åŠŸèƒ½**ï¼šç¡®ä¿æ—¥å¿—ä¸è¢«ç¯¡æ”¹ã€æ³„éœ²æˆ–ä¸¢å¤±
- **åˆ†æåŠŸèƒ½**ï¼šé€šè¿‡æ—¥å¿—å‘ç°å®‰å…¨é—®é¢˜å’Œå¼‚å¸¸è¡Œä¸º

```
æ—¥å¿—å®‰å…¨ä¸‰è¦ç´ ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®Œæ•´æ€§      â”‚    â”‚ ä¿å¯†æ€§      â”‚    â”‚ å¯ç”¨æ€§      â”‚
â”‚ Integrity   â”‚    â”‚ Confidentialâ”‚    â”‚ Available   â”‚
â”‚ ä¸è¢«ç¯¡æ”¹    â”‚    â”‚ ä¸è¢«æ³„éœ²    â”‚    â”‚ éšæ—¶å¯æŸ¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 systemdæ—¥å¿—ç³»ç»Ÿæ¶æ„


**ğŸ—ï¸ systemdæ—¥å¿—æ¶æ„å›¾**ï¼š
```
åº”ç”¨ç¨‹åº/æœåŠ¡           systemdæ—¥å¿—ç³»ç»Ÿ          æ—¥å¿—å­˜å‚¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebæœåŠ¡     â”‚ ---> â”‚ systemd-journald    â”‚   â”‚ /var/log/   â”‚
â”‚ æ•°æ®åº“      â”‚      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ journal/    â”‚
â”‚ è‡ªå®šä¹‰ç¨‹åº  â”‚ ---> â”‚ â”‚ æ—¥å¿—æ”¶é›†        â”‚ â”‚ ->â”‚ *.journal   â”‚
â”‚ ç³»ç»ŸæœåŠ¡    â”‚      â”‚ â”‚ æ ¼å¼æ ‡å‡†åŒ–      â”‚ â”‚   â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚ æƒé™æ§åˆ¶        â”‚ â”‚   â”‚ ä¼ ç»Ÿæ—¥å¿—:   â”‚
                     â”‚ â”‚ å‹ç¼©å­˜å‚¨        â”‚ â”‚   â”‚ /var/log/   â”‚
                     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ syslog      â”‚
                     â”‚ journalctl æŸ¥è¯¢å·¥å…· â”‚   â”‚ auth.log    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 æ—¥å¿—å®‰å…¨å¨èƒåˆ†æ


**ğŸ›¡ï¸ å¸¸è§å¨èƒç±»å‹**ï¼š

| **å¨èƒç±»å‹** | **å…·ä½“è¡¨ç°** | **å±å®³å½±å“** | **é˜²æŠ¤æªæ–½** |
|-------------|-------------|-------------|-------------|
| **æ—¥å¿—ç¯¡æ”¹** | æ”»å‡»è€…ä¿®æ”¹æ—¥å¿—å†…å®¹ | æ©ç›–æ”»å‡»ç—•è¿¹ | å®Œæ•´æ€§æ ¡éªŒ |
| **æ—¥å¿—æ³„éœ²** | æ•æ„Ÿä¿¡æ¯æš´éœ² | éšç§æ³„éœ²ã€å‡­è¯æš´éœ² | è®¿é—®æ§åˆ¶ã€åŠ å¯† |
| **æ—¥å¿—ä¸¢å¤±** | æ¶æ„åˆ é™¤ã€ç¡¬ä»¶æ•…éšœ | å¤±å»å®¡è®¡è¯æ® | å¤‡ä»½ã€å†—ä½™å­˜å‚¨ |
| **æ‹’ç»æœåŠ¡** | å¤§é‡åƒåœ¾æ—¥å¿— | ç£ç›˜ç©ºé—´è€—å°½ | é™æµã€è½®è½¬ |

---

## 2. âš™ï¸ systemdæ—¥å¿—é…ç½®å®‰å…¨


### 2.1 SyslogIdentifieræ—¥å¿—æ ‡è¯†


**ğŸ“š çŸ¥è¯†å¡ç‰‡**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“š é…ç½®é¡¹ï¼šSyslogIdentifier     â”‚
â”‚ ğŸ¯ ä½œç”¨ï¼šè®¾ç½®æœåŠ¡æ—¥å¿—æ ‡è¯†ç¬¦      â”‚
â”‚ ğŸ’» æ ¼å¼ï¼šSyslogIdentifier=åç§°  â”‚
â”‚ ğŸ”§ ç”¨é€”ï¼šæ—¥å¿—åˆ†ç±»ã€è¿‡æ»¤ã€å®¡è®¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
SyslogIdentifierå°±åƒç»™æ¯ä¸ªå¿«é€’åŒ…è£¹è´´ä¸Š"å‘ä»¶äººæ ‡ç­¾"ï¼š
- **ä¾¿äºè¯†åˆ«**ï¼šä¸€çœ¼å°±èƒ½çœ‹å‡ºæ—¥å¿—æ¥è‡ªå“ªä¸ªæœåŠ¡
- **æ–¹ä¾¿è¿‡æ»¤**ï¼šå¯ä»¥å¿«é€Ÿæ‰¾åˆ°ç‰¹å®šæœåŠ¡çš„æ‰€æœ‰æ—¥å¿—
- **å®‰å…¨å®¡è®¡**ï¼šè¿½è¸ªé—®é¢˜æ—¶èƒ½å‡†ç¡®å®šä½åˆ°æºå¤´

**ğŸ”¢ é…ç½®ç¤ºä¾‹**ï¼š

```bash
# /etc/systemd/system/webapp.service
[Unit]
Description=Web Application Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/webapp-server
User=webapp
Group=webapp
# è®¾ç½®æ¸…æ™°çš„æ—¥å¿—æ ‡è¯†
SyslogIdentifier=webapp-prod
# æŒ‡å®šæ—¥å¿—çº§åˆ«
StandardOutput=journal
StandardError=journal
```

**ğŸ” æ—¥å¿—æŸ¥çœ‹æ•ˆæœ**ï¼š
```bash
# æŸ¥çœ‹ç‰¹å®šæ ‡è¯†çš„æ—¥å¿—
journalctl -t webapp-prod

# è¾“å‡ºç¤ºä¾‹
Sep 14 10:30:15 server webapp-prod[1234]: Application started successfully
Sep 14 10:30:16 server webapp-prod[1234]: Database connection established
Sep 14 10:35:22 server webapp-prod[1234]: User login: admin from 192.168.1.100
```

### 2.2 LogsDirectoryæ—¥å¿—ç›®å½•å®‰å…¨


**ğŸ“š çŸ¥è¯†å¡ç‰‡**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“š é…ç½®é¡¹ï¼šLogsDirectory        â”‚
â”‚ ğŸ¯ ä½œç”¨ï¼šè‡ªåŠ¨åˆ›å»ºä¸“ç”¨æ—¥å¿—ç›®å½•    â”‚
â”‚ ğŸ’» è·¯å¾„ï¼š/var/log/ç›®å½•å        â”‚
â”‚ ğŸ”§ ä¼˜åŠ¿ï¼šè‡ªåŠ¨æƒé™ç®¡ç†ã€æ¸…ç†     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
LogsDirectoryåƒç»™æ¯ä¸ªç§Ÿæˆ·åˆ†é…"ä¸“ç”¨å‚¨ç‰©æŸœ"ï¼š
- **ç‹¬ç«‹ç©ºé—´**ï¼šæ¯ä¸ªæœåŠ¡æœ‰è‡ªå·±çš„æ—¥å¿—ç›®å½•
- **è‡ªåŠ¨ç®¡ç†**ï¼šsystemdè‡ªåŠ¨åˆ›å»ºå’Œè®¾ç½®æƒé™
- **å®‰å…¨éš”ç¦»**ï¼šä¸åŒæœåŠ¡çš„æ—¥å¿—ä¸ä¼šæ··åœ¨ä¸€èµ·

**ğŸ”¢ é…ç½®æ–¹æ³•**ï¼š

```bash
# /etc/systemd/system/webapp.service
[Unit]
Description=Web Application Service

[Service]
Type=simple
ExecStart=/usr/bin/webapp-server
User=webapp
Group=webapp

# è‡ªåŠ¨åˆ›å»º /var/log/webapp ç›®å½•
LogsDirectory=webapp
# è®¾ç½®ç›®å½•æƒé™ï¼ˆ8è¿›åˆ¶ï¼‰
LogsDirectoryMode=0750
# ç›®å½•æ‰€æœ‰è€…å’Œç»„ä¼šè‡ªåŠ¨è®¾ä¸º webapp:webapp

# åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥å†™å…¥
Environment=LOG_DIR=/var/log/webapp
```

**ğŸ” å®é™…æ•ˆæœ**ï¼š
```bash
# systemdä¼šè‡ªåŠ¨åˆ›å»ºå¹¶è®¾ç½®æƒé™
ls -ld /var/log/webapp/
drwxr-x---. 2 webapp webapp 4096 Sep 14 10:30 /var/log/webapp/

# æƒé™è§£è¯»ï¼š
# d: ç›®å½•ç±»å‹
# rwx: æ‰€æœ‰è€…(webapp)æœ‰è¯»å†™æ‰§è¡Œæƒé™
# r-x: ç»„(webapp)æœ‰è¯»æ‰§è¡Œæƒé™
# ---: å…¶ä»–ç”¨æˆ·æ— ä»»ä½•æƒé™
```

### 2.3 LogsDirectoryModeæƒé™å®‰å…¨


**ğŸ”’ æƒé™æ¨¡å¼è¯¦è§£**ï¼š

| **æ¨¡å¼** | **æ•°å€¼** | **æƒé™æè¿°** | **å®‰å…¨çº§åˆ«** | **é€‚ç”¨åœºæ™¯** |
|----------|----------|-------------|-------------|-------------|
| **é«˜å®‰å…¨** | `0700` | ä»…æ‰€æœ‰è€…å¯è®¿é—® | æé«˜ ğŸ”’ | é‡‘èã€åŒ»ç–—ç³»ç»Ÿ |
| **æ ‡å‡†å®‰å…¨** | `0750` | æ‰€æœ‰è€…è¯»å†™ï¼Œç»„åªè¯» | é«˜ ğŸ›¡ï¸ | ä¸€èˆ¬ä¸šåŠ¡ç³»ç»Ÿ |
| **å›¢é˜Ÿåä½œ** | `0755` | æ‰€æœ‰è€…è¯»å†™ï¼Œå…¶ä»–åªè¯» | ä¸­ ğŸ“Š | å¼€å‘æµ‹è¯•ç¯å¢ƒ |
| **å¼€æ”¾è®¿é—®** | `0777` | æ‰€æœ‰äººå¯è¯»å†™ | ä½ âš ï¸ | ä¸æ¨èä½¿ç”¨ |

**âš ï¸ é‡è¦æé†’**ï¼š
> **æƒé™è®¾ç½®åŸåˆ™**  
> éµå¾ª"æœ€å°æƒé™åŸåˆ™"ï¼Œåªç»™å¿…éœ€çš„æœ€å°æƒé™

> **å®‰å…¨å»ºè®®**  
> ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨0700æˆ–0750æ¨¡å¼

**ğŸ”¢ æƒé™é…ç½®å®ä¾‹**ï¼š

```bash
# é«˜å®‰å…¨çº§åˆ«é…ç½®
[Service]
User=webapp
Group=webapp
LogsDirectory=webapp
LogsDirectoryMode=0700    # åªæœ‰webappç”¨æˆ·å¯è®¿é—®

# é€‚ä¸­å®‰å…¨çº§åˆ«é…ç½®  
[Service]
User=webapp
Group=webteam
LogsDirectory=webapp
LogsDirectoryMode=0750    # webappç”¨æˆ·è¯»å†™ï¼Œwebteamç»„åªè¯»

# å¤šçº§ç›®å½•é…ç½®
LogsDirectory=webapp webapp/access webapp/error
LogsDirectoryMode=0750    # æ‰€æœ‰å­ç›®å½•ä½¿ç”¨ç›¸åŒæƒé™
```

---

## 3. ğŸ” æ•æ„Ÿä¿¡æ¯ä¿æŠ¤ç­–ç•¥


### 3.1 æ•æ„Ÿä¿¡æ¯è¯†åˆ«


**ğŸ” å¸¸è§æ•æ„Ÿä¿¡æ¯ç±»å‹**ï¼š

```
æ•æ„Ÿä¿¡æ¯åˆ†ç±»å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”‘ è®¤è¯å‡­è¯ç±»                                           â”‚
â”‚ â€¢ å¯†ç ã€APIå¯†é’¥ã€Token                                  â”‚
â”‚ â€¢ æ•°æ®åº“è¿æ¥ä¸²ã€è¯ä¹¦ç§é’¥                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“± ä¸ªäººä¿¡æ¯ç±»                                           â”‚
â”‚ â€¢ èº«ä»½è¯å·ã€æ‰‹æœºå·ã€é‚®ç®±                                â”‚
â”‚ â€¢ ç”¨æˆ·çœŸå®å§“åã€åœ°å€ä¿¡æ¯                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’° ä¸šåŠ¡æ•æ„Ÿç±»                                           â”‚
â”‚ â€¢ äº¤æ˜“é‡‘é¢ã€è´¦æˆ·ä½™é¢                                    â”‚
â”‚ â€¢ å•†ä¸šæœºå¯†ã€ç®—æ³•é€»è¾‘                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŒ ç½‘ç»œå®‰å…¨ç±»                                           â”‚
â”‚ â€¢ å†…ç½‘IPåœ°å€ã€æœåŠ¡å™¨ä¿¡æ¯                                â”‚
â”‚ â€¢ å®‰å…¨ç­–ç•¥ã€æ¼æ´ä¿¡æ¯                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ—¥å¿—è¿‡æ»¤ç­–ç•¥å®ç°


**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
æ—¥å¿—è¿‡æ»¤å°±åƒå®‰è£…"é©¬èµ›å…‹å¤„ç†å™¨"ï¼š
- **è‡ªåŠ¨è¯†åˆ«**ï¼šå‘ç°æ•æ„Ÿä¿¡æ¯
- **æ™ºèƒ½å¤„ç†**ï¼šç”¨æ˜Ÿå·æˆ–å…¶ä»–å­—ç¬¦æ›¿æ¢
- **ä¿ç•™ä»·å€¼**ï¼šä¿æŒæ—¥å¿—çš„è¯Šæ–­ä»·å€¼

**ğŸ”¢ è¿‡æ»¤å®ç°æ–¹æ³•**ï¼š

**æ–¹æ³•1ï¼šåº”ç”¨å±‚è¿‡æ»¤**
```bash
# webappæ—¥å¿—å¤„ç†å‡½æ•°
log_safe() {
    local message="$1"
    # è¿‡æ»¤å¯†ç å­—æ®µ
    message=$(echo "$message" | sed 's/password=[^&]*/password=***/g')
    # è¿‡æ»¤æ‰‹æœºå·
    message=$(echo "$message" | sed 's/phone=1[0-9]\{10\}/phone=1****/g')
    # è¿‡æ»¤é‚®ç®±
    message=$(echo "$message" | sed 's/[a-zA-Z0-9._%+-]\+@[a-zA-Z0-9.-]\+\.[a-zA-Z]\{2,\}/***@***.com/g')
    
    echo "$message" | systemd-cat -t webapp-prod
}

# ä½¿ç”¨ç¤ºä¾‹
log_safe "User login: phone=13812345678, password=mypass123"
# è¾“å‡ºï¼šUser login: phone=1****, password=***
```

**æ–¹æ³•2ï¼šrsyslogè¿‡æ»¤**
```bash
# /etc/rsyslog.d/sensitive-filter.conf
# å®šä¹‰æ•æ„Ÿä¿¡æ¯è¿‡æ»¤è§„åˆ™

# è¿‡æ»¤å¯†ç ç›¸å…³
:msg, contains, "password=" {
    # æ›¿æ¢æ•æ„Ÿå†…å®¹
    set $!message = replace($msg, "password=[^&]*", "password=***");
    # é‡æ–°è®°å½•
    *.* /var/log/webapp/app.log;RSYSLOG_TraditionalFileFormat
    stop
}

# è¿‡æ»¤APIå¯†é’¥
:msg, contains, "api_key=" {
    set $!message = replace($msg, "api_key=[A-Za-z0-9]*", "api_key=***");
    *.* /var/log/webapp/app.log;RSYSLOG_TraditionalFileFormat
    stop
}
```

### 3.3 æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨


**ğŸ”’ åŠ å¯†æ–¹æ¡ˆé€‰æ‹©**ï¼š

| **æ–¹æ¡ˆç±»å‹** | **å®ç°æ–¹å¼** | **å®‰å…¨çº§åˆ«** | **æ€§èƒ½å½±å“** | **é€‚ç”¨åœºæ™¯** |
|-------------|-------------|-------------|-------------|-------------|
| **æ–‡ä»¶ç³»ç»ŸåŠ å¯†** | LUKS/dm-crypt | å¾ˆé«˜ ğŸ›¡ï¸ | ä½ ğŸ“ˆ | æ•´ä¸ªæ—¥å¿—åˆ†åŒº |
| **åº”ç”¨å±‚åŠ å¯†** | AES/GPGåŠ å¯† | é«˜ ğŸ”’ | ä¸­ ğŸ“Š | ç‰¹å®šæ•æ„Ÿæ—¥å¿— |
| **ä¼ è¾“åŠ å¯†** | TLS/HTTPS | ä¸­ ğŸŒ | ä½ ğŸ“‰ | è¿œç¨‹æ—¥å¿—ä¼ è¾“ |

**ğŸ”¢ æ–‡ä»¶ç³»ç»ŸåŠ å¯†å®ç°**ï¼š

```bash
# åˆ›å»ºåŠ å¯†çš„æ—¥å¿—åˆ†åŒº
# 1. åˆ›å»ºLUKSåŠ å¯†å®¹å™¨
cryptsetup luksFormat /dev/sdb1

# 2. æ‰“å¼€åŠ å¯†è®¾å¤‡
cryptsetup open /dev/sdb1 encrypted-logs

# 3. åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ
mkfs.ext4 /dev/mapper/encrypted-logs

# 4. é…ç½®è‡ªåŠ¨æŒ‚è½½
echo "encrypted-logs /var/log/secure ext4 defaults 0 2" >> /etc/fstab
echo "/dev/sdb1 encrypted-logs luks" >> /etc/crypttab

# 5. systemdæœåŠ¡é…ç½®
[Service]
# ç¡®ä¿åŠ å¯†åˆ†åŒºæŒ‚è½½åå†å¯åŠ¨
RequiresMountsFor=/var/log/secure
LogsDirectory=secure/webapp
LogsDirectoryMode=0700
```

---

## 4. ğŸ”„ æ—¥å¿—è½®è½¬ä¸å®Œæ•´æ€§


### 4.1 æ—¥å¿—è½®è½¬å®‰å…¨é…ç½®


**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
æ—¥å¿—è½®è½¬å°±åƒ"å®šæœŸæ•´ç†æ–‡ä»¶æŸœ"ï¼š
- **å®šæœŸæ¸…ç†**ï¼šåˆ é™¤è¿‡æœŸçš„æ—§æ—¥å¿—æ–‡ä»¶
- **å‹ç¼©å­˜æ¡£**ï¼šèŠ‚çœå­˜å‚¨ç©ºé—´
- **ä¿æŒè¿ç»­**ï¼šç¡®ä¿æ—¥å¿—è®°å½•ä¸ä¸­æ–­
- **æƒé™ç»´æŠ¤**ï¼šæ–°å»ºæ—¥å¿—æ–‡ä»¶ä¿æŒæ­£ç¡®æƒé™

**ğŸ“š çŸ¥è¯†å¡ç‰‡**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“š å·¥å…·ï¼šlogrotate              â”‚
â”‚ ğŸ¯ ä½œç”¨ï¼šè‡ªåŠ¨åŒ–æ—¥å¿—æ–‡ä»¶ç®¡ç†      â”‚
â”‚ â° æ—¶æœºï¼šæŒ‰æ—¶é—´æˆ–å¤§å°è§¦å‘        â”‚
â”‚ ğŸ”§ åŠŸèƒ½ï¼šå‹ç¼©ã€åˆ é™¤ã€æƒé™è®¾ç½®    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¢ å®‰å…¨è½®è½¬é…ç½®**ï¼š

```bash
# /etc/logrotate.d/webapp-secure
/var/log/webapp/*.log {
    # è½®è½¬å‘¨æœŸï¼šæ¯å¤©æ£€æŸ¥
    daily
    
    # ä¿ç•™ä»½æ•°ï¼šä¿ç•™30å¤©çš„æ—¥å¿—
    rotate 30
    
    # å¤§å°é™åˆ¶ï¼šå•æ–‡ä»¶è¶…è¿‡100Mæ—¶å¼ºåˆ¶è½®è½¬
    size 100M
    
    # å‹ç¼©è®¾ç½®
    compress              # å‹ç¼©æ—§æ—¥å¿—
    delaycompress        # å»¶è¿Ÿä¸€è½®å†å‹ç¼©ï¼ˆä¾¿äºç¨‹åºç»§ç»­å†™å…¥ï¼‰
    
    # æƒé™å®‰å…¨
    create 0640 webapp webapp    # æ–°æ—¥å¿—æ–‡ä»¶æƒé™å’Œæ‰€æœ‰è€…
    
    # é”™è¯¯å¤„ç†
    missingok            # æ–‡ä»¶ä¸å­˜åœ¨æ—¶ä¸æŠ¥é”™
    notifempty          # ç©ºæ–‡ä»¶ä¸è½®è½¬
    
    # ç¨‹åºé€šçŸ¥
    postrotate
        # é€šçŸ¥ç¨‹åºé‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶
        /bin/kill -HUP $(cat /var/run/webapp.pid) 2>/dev/null || true
    endscript
    
    # å®Œæ•´æ€§ä¿æŠ¤
    postrotate
        # ä¸ºè½®è½¬çš„æ—¥å¿—ç”Ÿæˆæ ¡éªŒå’Œ
        sha256sum /var/log/webapp/*.log.1 > /var/log/webapp/checksums.sha256
        # è®¾ç½®æ ¡éªŒæ–‡ä»¶æƒé™
        chmod 400 /var/log/webapp/checksums.sha256
        chown webapp:webapp /var/log/webapp/checksums.sha256
    endscript
}
```

### 4.2 æ—¥å¿—å®Œæ•´æ€§ä¿æŠ¤


**ğŸ›¡ï¸ å®Œæ•´æ€§æ ¡éªŒæ–¹æ¡ˆ**ï¼š

```
å®Œæ•´æ€§ä¿æŠ¤ä½“ç³»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”Ÿæˆé˜¶æ®µ    â”‚    â”‚ å­˜å‚¨é˜¶æ®µ    â”‚    â”‚ éªŒè¯é˜¶æ®µ    â”‚
â”‚ å“ˆå¸Œè®¡ç®—    â”‚ -> â”‚ ç­¾åä¿å­˜    â”‚ -> â”‚ å®šæœŸæ ¡éªŒ    â”‚
â”‚ æ—¶é—´æˆ³è®°å½•  â”‚    â”‚ åªè¯»ä¿æŠ¤    â”‚    â”‚ å¼‚å¸¸å‘Šè­¦    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¢ å®Œæ•´æ€§å®ç°è„šæœ¬**ï¼š

```bash
#!/bin/bash
# log-integrity-check.sh - æ—¥å¿—å®Œæ•´æ€§æ£€æŸ¥è„šæœ¬

LOG_DIR="/var/log/webapp"
CHECKSUM_FILE="${LOG_DIR}/integrity.sha256"
ALERT_EMAIL="admin@company.com"

# ç”Ÿæˆæ—¥å¿—æ–‡ä»¶æ ¡éªŒå’Œ
generate_checksums() {
    cd "$LOG_DIR"
    # è®¡ç®—æ‰€æœ‰æ—¥å¿—æ–‡ä»¶çš„SHA256å€¼
    find . -name "*.log*" -type f -exec sha256sum {} \; > "${CHECKSUM_FILE}.new"
    
    # æ·»åŠ æ—¶é—´æˆ³
    echo "# Generated at $(date -R)" >> "${CHECKSUM_FILE}.new"
    
    # è®¾ç½®å®‰å…¨æƒé™
    chmod 400 "${CHECKSUM_FILE}.new"
    chown webapp:webapp "${CHECKSUM_FILE}.new"
    
    # åŸå­æ€§æ›¿æ¢
    mv "${CHECKSUM_FILE}.new" "$CHECKSUM_FILE"
}

# éªŒè¯æ—¥å¿—å®Œæ•´æ€§
verify_integrity() {
    if [[ -f "$CHECKSUM_FILE" ]]; then
        cd "$LOG_DIR"
        if ! sha256sum -c "$CHECKSUM_FILE" --quiet; then
            # å‘ç°å®Œæ•´æ€§é—®é¢˜ï¼Œå‘é€å‘Šè­¦
            echo "æ—¥å¿—å®Œæ•´æ€§éªŒè¯å¤±è´¥ï¼" | mail -s "å®‰å…¨å‘Šè­¦ï¼šæ—¥å¿—è¢«ç¯¡æ”¹" "$ALERT_EMAIL"
            logger -t log-integrity "ALERT: Log integrity check failed"
            return 1
        fi
    fi
    return 0
}

# æ ¹æ®å‚æ•°æ‰§è¡Œå¯¹åº”æ“ä½œ
case "$1" in
    generate)
        generate_checksums
        ;;
    verify)
        verify_integrity
        ;;
    *)
        echo "ç”¨æ³•: $0 {generate|verify}"
        exit 1
        ;;
esac
```

**â° å®šæ—¶ä»»åŠ¡é…ç½®**ï¼š

```bash
# /etc/cron.d/log-integrity
# æ¯å°æ—¶éªŒè¯ä¸€æ¬¡å®Œæ•´æ€§
0 * * * * webapp /usr/local/bin/log-integrity-check.sh verify

# æ¯å¤©å‡Œæ™¨ç”Ÿæˆæ–°çš„æ ¡éªŒå’Œ
0 0 * * * webapp /usr/local/bin/log-integrity-check.sh generate

# æ¯æ¬¡æ—¥å¿—è½®è½¬åé‡æ–°ç”Ÿæˆæ ¡éªŒå’Œ
# åœ¨logrotateé…ç½®ä¸­æ·»åŠ ï¼š
# postrotate
#     /usr/local/bin/log-integrity-check.sh generate
# endscript
```

---

## 5. ğŸ“Š å®¡è®¡äº‹ä»¶è®°å½•æœºåˆ¶


### 5.1 å®¡è®¡äº‹ä»¶åˆ†ç±»


**ğŸ” å®¡è®¡äº‹ä»¶ç±»å‹å›¾**ï¼š
```
å®¡è®¡äº‹ä»¶åˆ†ç±»ï¼š
â”œâ”€â”€ ğŸ” å®‰å…¨äº‹ä»¶
â”‚   â”œâ”€â”€ ç™»å½•å¤±è´¥/æˆåŠŸ
â”‚   â”œâ”€â”€ æƒé™å˜æ›´
â”‚   â”œâ”€â”€ å¯†ç ä¿®æ”¹
â”‚   â””â”€â”€ å¼‚å¸¸è®¿é—®
â”œâ”€â”€ ğŸ’¼ ä¸šåŠ¡äº‹ä»¶  
â”‚   â”œâ”€â”€ äº¤æ˜“æ“ä½œ
â”‚   â”œâ”€â”€ æ•°æ®ä¿®æ”¹
â”‚   â”œâ”€â”€ é‡è¦é…ç½®å˜æ›´
â”‚   â””â”€â”€ æ‰¹é‡æ“ä½œ
â”œâ”€â”€ ğŸ”§ ç³»ç»Ÿäº‹ä»¶
â”‚   â”œâ”€â”€ æœåŠ¡å¯åœ
â”‚   â”œâ”€â”€ é…ç½®å˜æ›´
â”‚   â”œâ”€â”€ èµ„æºå‘Šè­¦
â”‚   â””â”€â”€ æ€§èƒ½å¼‚å¸¸
â””â”€â”€ ğŸŒ ç½‘ç»œäº‹ä»¶
    â”œâ”€â”€ è¿æ¥å»ºç«‹/æ–­å¼€
    â”œâ”€â”€ æµé‡å¼‚å¸¸
    â”œâ”€â”€ é˜²ç«å¢™è§„åˆ™è§¦å‘
    â””â”€â”€ DNSæŸ¥è¯¢å¼‚å¸¸
```

### 5.2 ç»“æ„åŒ–å®¡è®¡æ—¥å¿—


**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
ç»“æ„åŒ–æ—¥å¿—å°±åƒå¡«å†™"æ ‡å‡†è¡¨æ ¼"ï¼š
- **æ ¼å¼ç»Ÿä¸€**ï¼šæ‰€æœ‰æ—¥å¿—éƒ½æŒ‰ç›¸åŒæ ¼å¼è®°å½•
- **ä¾¿äºå¤„ç†**ï¼šç¨‹åºå®¹æ˜“è§£æå’Œåˆ†æ
- **ä¿¡æ¯å®Œæ•´**ï¼šåŒ…å«å¿…è¦çš„å®¡è®¡è¦ç´ 

**ğŸ“š çŸ¥è¯†å¡ç‰‡**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“š æ ¼å¼ï¼šJSONç»“æ„åŒ–æ—¥å¿—         â”‚
â”‚ ğŸ¯ ä¼˜åŠ¿ï¼šæœºå™¨å¯è¯»ã€æŸ¥è¯¢æ–¹ä¾¿      â”‚
â”‚ ğŸ’» å·¥å…·ï¼šjqã€ElasticSearch      â”‚
â”‚ ğŸ”§ æ ‡å‡†ï¼šRFC 5424ã€ECSæ ¼å¼      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¢ å®¡è®¡æ—¥å¿—æ ‡å‡†æ ¼å¼**ï¼š

```json
{
  "timestamp": "2024-09-14T10:30:15.123Z",
  "level": "INFO",
  "service": "webapp-prod",
  "event_type": "user_authentication",
  "event_category": "security",
  "severity": "medium",
  "user": {
    "id": "12345",
    "username": "admin",
    "role": "administrator",
    "session_id": "sess_abc123"
  },
  "source": {
    "ip": "192.168.1.100",
    "user_agent": "Mozilla/5.0...",
    "geo_location": "Beijing, China"
  },
  "action": {
    "type": "login",
    "result": "success", 
    "resource": "/admin/dashboard",
    "method": "POST"
  },
  "context": {
    "request_id": "req_xyz789",
    "transaction_id": "tx_456",
    "business_context": "admin_panel_access"
  },
  "security": {
    "risk_score": 3,
    "authentication_method": "password",
    "mfa_used": false,
    "previous_login": "2024-09-14T09:15:30.000Z"
  }
}
```

### 5.3 systemdå®¡è®¡é›†æˆ


**ğŸ”— ä¸Linuxå®¡è®¡å­ç³»ç»Ÿé›†æˆ**ï¼š

```bash
# /etc/systemd/system/webapp.service
[Unit]
Description=Web Application Service
After=network.target auditd.service

[Service]
Type=simple
ExecStart=/usr/bin/webapp-server
User=webapp
Group=webapp

# å®¡è®¡ç›¸å…³é…ç½®
SyslogIdentifier=webapp-prod
StandardOutput=journal
StandardError=journal

# å¯ç”¨å®¡è®¡åŠŸèƒ½
# è®°å½•æ‰€æœ‰æ–‡ä»¶è®¿é—®
AuditWrite=yes
# è®°å½•ç½‘ç»œè¿æ¥
PrivateNetwork=no
# è®°å½•ç³»ç»Ÿè°ƒç”¨
SystemCallLog=yes

# æ•æ„Ÿæ“ä½œå®¡è®¡
ExecStartPre=/bin/sh -c 'echo "Service webapp-prod starting" | /sbin/auditctl -w /var/log/audit/audit.log -p wa'
```

**ğŸ”¢ å®¡è®¡è§„åˆ™é…ç½®**ï¼š

```bash
# /etc/audit/rules.d/webapp-audit.rules
# webappæœåŠ¡ç›¸å…³å®¡è®¡è§„åˆ™

# ç›‘æ§webappé…ç½®æ–‡ä»¶ä¿®æ”¹
-w /etc/webapp/ -p wa -k webapp_config_change

# ç›‘æ§webappæ—¥å¿—ç›®å½•
-w /var/log/webapp/ -p wa -k webapp_log_access

# ç›‘æ§webappæ•°æ®ç›®å½•
-w /var/lib/webapp/ -p wa -k webapp_data_change

# ç›‘æ§webappç”¨æˆ·çš„ç³»ç»Ÿè°ƒç”¨
-a always,exit -F arch=b64 -S execve -F auid>=1000 -F auid!=4294967295 -F uid=webapp -k webapp_execution

# ç›‘æ§ç½‘ç»œè¿æ¥
-a always,exit -F arch=b64 -S socket -F a0=2 -F uid=webapp -k webapp_network

# ç›‘æ§æ–‡ä»¶æƒé™å˜æ›´
-a always,exit -F arch=b64 -S chmod,fchmod,fchmodat -F uid=webapp -k webapp_permission_change
```

---

## 6. ğŸš¨ å®‰å…¨ç›‘æ§å‘Šè­¦ä½“ç³»


### 6.1 å‘Šè­¦è§¦å‘æ¡ä»¶


**âš ï¸ å…³é”®å‘Šè­¦äº‹ä»¶**ï¼š

| **å‘Šè­¦çº§åˆ«** | **è§¦å‘æ¡ä»¶** | **å“åº”æ—¶é—´** | **å¤„ç†æ–¹å¼** |
|-------------|-------------|-------------|-------------|
| **ğŸ”´ ä¸¥é‡** | æ—¥å¿—å®Œæ•´æ€§ç ´åã€å¤§é‡è®¤è¯å¤±è´¥ | ç«‹å³ | è‡ªåŠ¨é˜»æ–­+äººå·¥å¤„ç† |
| **ğŸŸ¡ è­¦å‘Š** | å¼‚å¸¸ç™»å½•ã€æƒé™å˜æ›´ | 5åˆ†é’Ÿå†… | è‡ªåŠ¨è®°å½•+é€šçŸ¥ç®¡ç†å‘˜ |
| **ğŸ”µ ä¿¡æ¯** | æœåŠ¡é‡å¯ã€é…ç½®å˜æ›´ | 30åˆ†é’Ÿå†… | è®°å½•å¤‡æŸ¥ |

### 6.2 å®æ—¶ç›‘æ§å®ç°


**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
å®æ—¶ç›‘æ§å°±åƒå®‰è£…"æ™ºèƒ½çƒŸé›¾æŠ¥è­¦å™¨"ï¼š
- **æŒç»­ç›‘æµ‹**ï¼š24å°æ—¶ä¸é—´æ–­ç›‘æ§æ—¥å¿—
- **æ™ºèƒ½åˆ†æ**ï¼šè¯†åˆ«å¼‚å¸¸æ¨¡å¼å’Œå±é™©ä¿¡å·
- **åŠæ—¶å‘Šè­¦**ï¼šå‘ç°é—®é¢˜ç«‹å³é€šçŸ¥ç›¸å…³äººå‘˜
- **è‡ªåŠ¨å“åº”**ï¼šå…³é”®é—®é¢˜è‡ªåŠ¨æ‰§è¡Œä¿æŠ¤æªæ–½

**ğŸ”¢ ç›‘æ§è„šæœ¬å®ç°**ï¼š

```bash
#!/bin/bash
# realtime-log-monitor.sh - å®æ—¶æ—¥å¿—ç›‘æ§è„šæœ¬

LOG_FILE="/var/log/webapp/app.log"
ALERT_EMAIL="security@company.com"
WEBHOOK_URL="https://alert.company.com/api/webhook"

# å‘Šè­¦é˜ˆå€¼é…ç½®
LOGIN_FAIL_THRESHOLD=5      # 5åˆ†é’Ÿå†…ç™»å½•å¤±è´¥æ¬¡æ•°
UNUSUAL_IP_THRESHOLD=10     # å¼‚å¸¸IPè®¿é—®æ¬¡æ•°
LOG_ERROR_THRESHOLD=20      # é”™è¯¯æ—¥å¿—æ•°é‡

# å‘é€å‘Šè­¦é€šçŸ¥
send_alert() {
    local level="$1"
    local message="$2"
    local timestamp=$(date -R)
    
    # é‚®ä»¶å‘Šè­¦
    echo -e "å‘Šè­¦çº§åˆ«: $level\næ—¶é—´: $timestamp\nè¯¦æƒ…: $message" | \
        mail -s "ã€å®‰å…¨å‘Šè­¦ã€‘webappç³»ç»Ÿå¼‚å¸¸" "$ALERT_EMAIL"
    
    # Webhookå‘Šè­¦ï¼ˆå¦‚Slackã€é’‰é’‰ç­‰ï¼‰
    curl -X POST "$WEBHOOK_URL" \
        -H "Content-Type: application/json" \
        -d "{
            \"level\": \"$level\",
            \"message\": \"$message\",
            \"timestamp\": \"$timestamp\",
            \"service\": \"webapp-prod\"
        }"
    
    # ç³»ç»Ÿæ—¥å¿—è®°å½•
    logger -t security-monitor "ALERT [$level]: $message"
}

# æ£€æŸ¥ç™»å½•å¤±è´¥æ¬¡æ•°
check_login_failures() {
    local count=$(tail -1000 "$LOG_FILE" | \
        grep -c "authentication failed" | \
        awk -v threshold="$LOGIN_FAIL_THRESHOLD" '$1 > threshold')
    
    if [[ $count -gt 0 ]]; then
        send_alert "CRITICAL" "æ£€æµ‹åˆ°å¤§é‡ç™»å½•å¤±è´¥å°è¯•: $count æ¬¡"
    fi
}

# æ£€æŸ¥å¼‚å¸¸IPè®¿é—®
check_unusual_ips() {
    # è·å–æœ€è¿‘çš„IPè®¿é—®ç»Ÿè®¡
    tail -1000 "$LOG_FILE" | \
        grep -E "ip.*[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+" | \
        awk '{print $NF}' | sort | uniq -c | \
        awk -v threshold="$UNUSUAL_IP_THRESHOLD" \
        '$1 > threshold {print "å¼‚å¸¸IPè®¿é—®: " $2 " è®¿é—®æ¬¡æ•°: " $1}' | \
        while read line; do
            send_alert "WARNING" "$line"
        done
}

# å®æ—¶ç›‘æ§ä¸»å¾ªç¯
monitor_loop() {
    # ä½¿ç”¨tail -FæŒç»­ç›‘æ§æ—¥å¿—æ–‡ä»¶
    tail -F "$LOG_FILE" | while read line; do
        # æ£€æŸ¥å…³é”®å®‰å…¨äº‹ä»¶
        if echo "$line" | grep -q "authentication failed"; then
            check_login_failures
        fi
        
        if echo "$line" | grep -q "permission denied"; then
            send_alert "WARNING" "æƒé™æ‹’ç»äº‹ä»¶: $line"
        fi
        
        if echo "$line" | grep -q "CRITICAL\|FATAL"; then
            send_alert "CRITICAL" "ç³»ç»Ÿä¸¥é‡é”™è¯¯: $line"
        fi
        
        # å®šæœŸæ‰§è¡Œå…¶ä»–æ£€æŸ¥ï¼ˆæ¯100è¡Œæ£€æŸ¥ä¸€æ¬¡ï¼‰
        if (( RANDOM % 100 == 0 )); then
            check_unusual_ips
        fi
    done
}

# å¯åŠ¨ç›‘æ§
echo "å¯åŠ¨webappæ—¥å¿—å®æ—¶ç›‘æ§..."
monitor_loop
```

### 6.3 ç›‘æ§æœåŠ¡åŒ–éƒ¨ç½²


**ğŸ”¢ systemdæœåŠ¡é…ç½®**ï¼š

```bash
# /etc/systemd/system/webapp-log-monitor.service
[Unit]
Description=WebApp Log Security Monitor
After=webapp.service
Requires=webapp.service
PartOf=webapp.service

[Service]
Type=simple
ExecStart=/usr/local/bin/realtime-log-monitor.sh
Restart=always
RestartSec=10
User=webapp
Group=webapp

# å®‰å…¨é…ç½®
PrivateTmp=yes
ProtectSystem=strict
ProtectHome=yes
ReadWritePaths=/var/log/webapp

# èµ„æºé™åˆ¶
MemoryLimit=128M
CPUQuota=10%

# æ—¥å¿—é…ç½®
SyslogIdentifier=webapp-monitor
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

---

## 7. ğŸ› ï¸ å®æˆ˜é…ç½®æ¡ˆä¾‹


### 7.1 å®Œæ•´çš„å®‰å…¨æ—¥å¿—é…ç½®


**ğŸ¯ åœºæ™¯**ï¼šç”Ÿäº§ç¯å¢ƒWebåº”ç”¨çš„å®‰å…¨æ—¥å¿—é…ç½®

```bash
# /etc/systemd/system/webapp-prod.service
[Unit]
Description=Production Web Application
Documentation=https://wiki.company.com/webapp
After=network.target postgresql.service redis.service
Wants=postgresql.service redis.service

[Service]
Type=notify
ExecStart=/usr/bin/webapp-server --config=/etc/webapp/prod.conf
ExecReload=/bin/kill -HUP $MAINPID
KillMode=mixed
Restart=on-failure
RestartSec=5
TimeoutStartSec=300
TimeoutStopSec=30

# ç”¨æˆ·å’Œæƒé™
User=webapp
Group=webapp
UMask=0027

# æ—¥å¿—å®‰å…¨é…ç½®
SyslogIdentifier=webapp-prod
LogsDirectory=webapp webapp/access webapp/error webapp/audit
LogsDirectoryMode=0750
StandardOutput=journal
StandardError=journal

# ç³»ç»Ÿå®‰å…¨åŠ å›º
PrivateTmp=yes
PrivateDevices=yes
ProtectSystem=strict
ProtectHome=yes
NoNewPrivileges=yes
ReadWritePaths=/var/log/webapp /var/lib/webapp
ReadOnlyPaths=/etc/webapp

# ç½‘ç»œå®‰å…¨
PrivateNetwork=no
RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX
IPAddressDeny=any
IPAddressAllow=localhost 192.168.0.0/16 10.0.0.0/8

# å®¡è®¡é…ç½®
AuditWrite=yes

# ç¯å¢ƒå˜é‡
Environment=LOG_LEVEL=INFO
Environment=AUDIT_ENABLED=true
Environment=LOG_DIR=/var/log/webapp
EnvironmentFile=-/etc/webapp/environment

[Install]
WantedBy=multi-user.target
```

### 7.2 é…å¥—ç›‘æ§è„šæœ¬


**ğŸ”¢ ç»¼åˆç›‘æ§è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
#!/bin/bash
# webapp-security-monitor.sh - ç»¼åˆå®‰å…¨ç›‘æ§è„šæœ¬

set -euo pipefail

# é…ç½®å‚æ•°
readonly SCRIPT_NAME=$(basename "$0")
readonly LOG_DIR="/var/log/webapp"
readonly CONFIG_FILE="/etc/webapp-monitor/config.conf"
readonly PID_FILE="/var/run/webapp-monitor.pid"

# åŠ è½½é…ç½®æ–‡ä»¶
if [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE"
else
    # é»˜è®¤é…ç½®
    ALERT_EMAIL="admin@company.com"
    LOGIN_FAIL_THRESHOLD=5
    ERROR_RATE_THRESHOLD=10
    DISK_USAGE_THRESHOLD=80
fi

# æ—¥å¿—å‡½æ•°
log_message() {
    local level="$1"
    local message="$2"
    echo "$(date -R) [$level] $message" | \
        systemd-cat -t webapp-monitor -p "$level"
}

# æ£€æŸ¥ç£ç›˜ä½¿ç”¨ç‡
check_disk_usage() {
    local usage=$(df "$LOG_DIR" | awk 'NR==2 {print $5}' | sed 's/%//')
    if [[ $usage -gt $DISK_USAGE_THRESHOLD ]]; then
        log_message "warning" "æ—¥å¿—ç›®å½•ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: ${usage}%"
        return 1
    fi
    return 0
}

# æ£€æŸ¥æ—¥å¿—é”™è¯¯ç‡
check_error_rate() {
    local total_lines=$(wc -l < "$LOG_DIR/app.log")
    local error_lines=$(grep -c "ERROR\|CRITICAL" "$LOG_DIR/app.log" || true)
    
    if [[ $total_lines -gt 0 ]]; then
        local error_rate=$((error_lines * 100 / total_lines))
        if [[ $error_rate -gt $ERROR_RATE_THRESHOLD ]]; then
            log_message "warning" "é”™è¯¯æ—¥å¿—æ¯”ä¾‹è¿‡é«˜: ${error_rate}%"
            return 1
        fi
    fi
    return 0
}

# ä¸»ç›‘æ§å¾ªç¯
main_monitor() {
    log_message "info" "webappå®‰å…¨ç›‘æ§å¯åŠ¨"
    
    while true; do
        check_disk_usage || true
        check_error_rate || true
        
        # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        sleep 300
    done
}

# ä¿¡å·å¤„ç†
cleanup() {
    log_message "info" "webappå®‰å…¨ç›‘æ§åœæ­¢"
    rm -f "$PID_FILE"
    exit 0
}

trap cleanup SIGTERM SIGINT

# é˜²æ­¢é‡å¤è¿è¡Œ
if [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
    echo "ç›‘æ§è„šæœ¬å·²åœ¨è¿è¡Œä¸­"
    exit 1
fi

echo $$ > "$PID_FILE"
main_monitor
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 æ—¥å¿—å®‰å…¨æ ¸å¿ƒåŸåˆ™


**ğŸ”¸ å®Œæ•´æ€§ç¬¬ä¸€**ï¼š
- ä½¿ç”¨æ ¡éªŒå’ŒéªŒè¯æ—¥å¿—æœªè¢«ç¯¡æ”¹
- å®æ–½è®¿é—®æ§åˆ¶é˜²æ­¢æœªæˆæƒä¿®æ”¹
- å»ºç«‹å®Œæ•´çš„å®¡è®¡é“¾è¿½æº¯æ‰€æœ‰å˜æ›´

**ğŸ”¸ ä¿å¯†æ€§ä¿éšœ**ï¼š
- è¿‡æ»¤æ•æ„Ÿä¿¡æ¯é¿å…æ³„éœ²
- ä½¿ç”¨åŠ å¯†ä¿æŠ¤å­˜å‚¨çš„æ—¥å¿—
- ä¸¥æ ¼çš„æƒé™æ§åˆ¶é™åˆ¶è®¿é—®èŒƒå›´

**ğŸ”¸ å¯ç”¨æ€§ç»´æŠ¤**ï¼š
- åˆç†çš„è½®è½¬ç­–ç•¥é˜²æ­¢ç£ç›˜æ»¡
- å†—ä½™å¤‡ä»½ç¡®ä¿æ—¥å¿—ä¸ä¸¢å¤±  
- å®æ—¶ç›‘æ§ä¿è¯æœåŠ¡æ­£å¸¸è¿è¡Œ

### 8.2 systemdæ—¥å¿—å®‰å…¨é…ç½®è¦ç‚¹


**âš¡ å…³é”®é…ç½®é¡¹æ€»ç»“**ï¼š

| **é…ç½®é¡¹** | **å®‰å…¨ä½œç”¨** | **æ¨èå€¼** | **æ³¨æ„äº‹é¡¹** |
|-----------|-------------|-----------|-------------|
| `SyslogIdentifier` | æ—¥å¿—æ ‡è¯†å’Œåˆ†ç±» | æœåŠ¡å-ç¯å¢ƒ | ä¾¿äºå®¡è®¡è¿½è¸ª |
| `LogsDirectory` | è‡ªåŠ¨ç›®å½•ç®¡ç† | æœåŠ¡ä¸“ç”¨ç›®å½• | é¿å…æƒé™æ··ä¹± |
| `LogsDirectoryMode` | ç›®å½•æƒé™æ§åˆ¶ | 0750æˆ–0700 | éµå¾ªæœ€å°æƒé™ |
| `StandardOutput=journal` | ç»“æ„åŒ–æ—¥å¿— | journal | ä¾¿äºæŸ¥è¯¢åˆ†æ |
| `AuditWrite=yes` | å¯ç”¨å®¡è®¡ | yes | å…³é”®æœåŠ¡å¿…é¡» |

### 8.3 ç›‘æ§å‘Šè­¦æœ€ä½³å®è·µ


**ğŸ¯ ç›‘æ§ç­–ç•¥**ï¼š
- **åˆ†å±‚å‘Šè­¦**ï¼šæŒ‰ä¸¥é‡ç¨‹åº¦åˆ†çº§å“åº”
- **æ™ºèƒ½è¿‡æ»¤**ï¼šé¿å…å‘Šè­¦ç–²åŠ³
- **è‡ªåŠ¨å“åº”**ï¼šå…³é”®é—®é¢˜è‡ªåŠ¨å¤„ç†
- **æŒç»­ä¼˜åŒ–**ï¼šæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´é˜ˆå€¼

**âš ï¸ å¸¸è§è¯¯åŒº**ï¼š
```
âŒ è®°å½•æ‰€æœ‰ä¿¡æ¯ â†’ âœ… è®°å½•å…³é”®ä¿¡æ¯
âŒ æ˜æ–‡å­˜å‚¨æ•æ„Ÿæ•°æ® â†’ âœ… è¿‡æ»¤æˆ–åŠ å¯†å¤„ç†
âŒ å¿½ç•¥æ—¥å¿—è½®è½¬ â†’ âœ… åˆç†é…ç½®è½®è½¬ç­–ç•¥
âŒ ç¼ºä¹å®Œæ•´æ€§æ£€æŸ¥ â†’ âœ… å®šæœŸæ ¡éªŒæ—¥å¿—å®Œæ•´æ€§
```

### 8.4 å®é™…éƒ¨ç½²å»ºè®®


**ğŸ”§ éƒ¨ç½²checklist**ï¼š
```
ç¯å¢ƒå‡†å¤‡ï¼š
â–¡ ç¡®è®¤æ—¥å¿—å­˜å‚¨ç©ºé—´å……è¶³
â–¡ è®¾ç½®åˆé€‚çš„æ–‡ä»¶ç³»ç»Ÿæƒé™
â–¡ é…ç½®æ—¥å¿—è½®è½¬ç­–ç•¥
â–¡ éƒ¨ç½²ç›‘æ§å‘Šè­¦ç³»ç»Ÿ

å®‰å…¨é…ç½®ï¼š
â–¡ å¯ç”¨æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
â–¡ é…ç½®è®¿é—®æ§åˆ¶æƒé™
â–¡ å®æ–½æ—¥å¿—å®Œæ•´æ€§æ£€æŸ¥
â–¡ å»ºç«‹å®¡è®¡è§„åˆ™

è¿ç»´ä¿éšœï¼š
â–¡ å®šæœŸå¤‡ä»½é‡è¦æ—¥å¿—
â–¡ ç›‘æ§ç£ç›˜ä½¿ç”¨æƒ…å†µ
â–¡ æµ‹è¯•å‘Šè­¦é€šçŸ¥æœºåˆ¶
â–¡ åˆ¶å®šåº”æ€¥å“åº”æµç¨‹
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- æ—¥å¿—å®‰å…¨ä¸‰è¦ç´ ï¼šå®Œæ•´æ€§ã€ä¿å¯†æ€§ã€å¯ç”¨æ€§
- systemdæä¾›å¼ºå¤§çš„æ—¥å¿—å®‰å…¨é…ç½®èƒ½åŠ›
- æ•æ„Ÿä¿¡æ¯è¿‡æ»¤å’Œæƒé™æ§åˆ¶æ˜¯åŸºç¡€
- å®æ—¶ç›‘æ§å’Œå‘Šè­¦æ˜¯å®‰å…¨é˜²æŠ¤çš„å…³é”®ç¯èŠ‚