---
title: 4ã€ç½‘ç»œè®¿é—®é™åˆ¶é…ç½®
---
## ğŸ“š ç›®å½•

1. [ç½‘ç»œå®‰å…¨åŸºç¡€æ¦‚å¿µ](#1-ç½‘ç»œå®‰å…¨åŸºç¡€æ¦‚å¿µ)
2. [PrivateNetworkç½‘ç»œéš”ç¦»](#2-PrivateNetworkç½‘ç»œéš”ç¦»)
3. [åœ°å€æ—é™åˆ¶é…ç½®](#3-åœ°å€æ—é™åˆ¶é…ç½®)
4. [IPè®¿é—®æ§åˆ¶æœºåˆ¶](#4-IPè®¿é—®æ§åˆ¶æœºåˆ¶)
5. [ç«¯å£ç»‘å®šæ§åˆ¶](#5-ç«¯å£ç»‘å®šæ§åˆ¶)
6. [ç½‘ç»œå‘½åç©ºé—´é…ç½®](#6-ç½‘ç»œå‘½åç©ºé—´é…ç½®)
7. [é˜²ç«å¢™é›†æˆé…ç½®](#7-é˜²ç«å¢™é›†æˆé…ç½®)
8. [æœåŠ¡é—´ç½‘ç»œé€šä¿¡æ§åˆ¶](#8-æœåŠ¡é—´ç½‘ç»œé€šä¿¡æ§åˆ¶)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ ç½‘ç»œå®‰å…¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯systemdç½‘ç»œå®‰å…¨


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
systemdç½‘ç»œå®‰å…¨ï¼šé€šè¿‡é…ç½®é™åˆ¶æœåŠ¡çš„ç½‘ç»œè®¿é—®æƒé™
ç›®æ ‡ï¼šæœ€å°åŒ–ç½‘ç»œæ”»å‡»é¢ï¼Œé˜²æ­¢æœåŠ¡æ»¥ç”¨ç½‘ç»œèµ„æº
åŸç†ï¼šåœ¨systemdå±‚é¢æ§åˆ¶è¿›ç¨‹çš„ç½‘ç»œè¡Œä¸º
```

> **ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**
> å°±åƒç»™æ¯ä¸ªæˆ¿é—´å®‰è£…ä¸åŒçº§åˆ«çš„é—¨é”ï¼Œæœ‰äº›æˆ¿é—´å®Œå…¨éš”ç¦»ï¼Œæœ‰äº›åªèƒ½è®¿é—®ç‰¹å®šåŒºåŸŸï¼Œæœ‰äº›å¯ä»¥è‡ªç”±è¿›å‡ºã€‚systemdç½‘ç»œé™åˆ¶å°±æ˜¯ç»™æœåŠ¡é…ç½®"ç½‘ç»œé—¨ç¦å¡"ã€‚

**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦ç½‘ç»œé™åˆ¶ï¼Ÿ**
```
å®‰å…¨é£é™©ï¼š
â€¢ æœåŠ¡è¢«å…¥ä¾µåå¯èƒ½å‘å¤–å‘é€æ¶æ„æ•°æ®
â€¢ å†…éƒ¨æœåŠ¡å¯èƒ½è¢«æ»¥ç”¨è®¿é—®ä¸è¯¥è®¿é—®çš„èµ„æº
â€¢ å‡å°‘æ¨ªå‘æ”»å‡»çš„å¯èƒ½æ€§

å®é™…åœºæ™¯ï¼š
â€¢ WebæœåŠ¡åªéœ€è¦ç›‘å¬80/443ç«¯å£
â€¢ æ•°æ®åº“æœåŠ¡åªéœ€è¦å†…ç½‘é€šä¿¡
â€¢ è®¡ç®—æœåŠ¡å¯èƒ½å®Œå…¨ä¸éœ€è¦ç½‘ç»œè®¿é—®
```

### 1.2 systemdç½‘ç»œå®‰å…¨æœºåˆ¶æ¦‚è§ˆ


**ğŸ“‹ ä¸»è¦æ§åˆ¶ç»´åº¦**
```
â”Œâ”€ç½‘ç»œéš”ç¦»æ§åˆ¶â”€â”    â”Œâ”€åœ°å€æ—é™åˆ¶â”€â”    â”Œâ”€IPè®¿é—®æ§åˆ¶â”€â”
â”‚PrivateNetwork â”‚    â”‚RestrictAddr â”‚    â”‚IPAddressAllowâ”‚
â”‚å®Œå…¨ç½‘ç»œéš”ç¦»   â”‚    â”‚é™åˆ¶åè®®ç±»å‹ â”‚    â”‚ç™½åå•æœºåˆ¶   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                 â”‚
           â”Œâ”€ç«¯å£ç»‘å®šæ§åˆ¶â”€â”    â”Œâ”€å‘½åç©ºé—´â”€â”
           â”‚SocketBind     â”‚    â”‚Network    â”‚
           â”‚ç«¯å£ç™½åå•     â”‚    â”‚Namespace  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ”’ PrivateNetworkç½‘ç»œéš”ç¦»


### 2.1 å®Œå…¨ç½‘ç»œéš”ç¦»é…ç½®


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
PrivateNetwork=yesï¼šä¸ºæœåŠ¡åˆ›å»ºç‹¬ç«‹çš„ç½‘ç»œå‘½åç©ºé—´
æ•ˆæœï¼šæœåŠ¡åªèƒ½çœ‹åˆ°lo(æœ¬åœ°å›ç¯)æ¥å£ï¼Œæ— æ³•è®¿é—®å¤–ç½‘
é€‚ç”¨ï¼šä¸éœ€è¦ç½‘ç»œé€šä¿¡çš„è®¡ç®—å‹æœåŠ¡
```

**ğŸ”§ é…ç½®ç¤ºä¾‹**

```ini
# /etc/systemd/system/compute-service.service
[Unit]
Description=è®¡ç®—å¯†é›†å‹æœåŠ¡(æ— ç½‘ç»œéœ€æ±‚)
After=network.target

[Service]
Type=simple
User=compute-user
ExecStart=/opt/myapp/compute-worker

# å®Œå…¨éš”ç¦»ç½‘ç»œ
PrivateNetwork=yes

# é…å¥—çš„å…¶ä»–å®‰å…¨æªæ–½
PrivateTmp=yes
NoNewPrivileges=yes
ProtectSystem=strict
ProtectHome=yes

[Install]
WantedBy=multi-user.target
```

**ğŸ“Š éš”ç¦»æ•ˆæœéªŒè¯**
```bash
# å¯åŠ¨æœåŠ¡åï¼Œåœ¨æœåŠ¡å†…éƒ¨æŸ¥çœ‹ç½‘ç»œæ¥å£
systemctl start compute-service

# è¿›å…¥æœåŠ¡çš„å‘½åç©ºé—´æŸ¥çœ‹
systemd-run --uid=compute-user --gid=compute-user \
  --property=PrivateNetwork=yes \
  ip addr show

# è¾“å‡ºç»“æœï¼šåªæ˜¾ç¤ºloæ¥å£
# 1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue
#     inet 127.0.0.1/8 scope host lo
```

### 2.2 é€‚ç”¨åœºæ™¯ä¸æ³¨æ„äº‹é¡¹


**âœ… é€‚ç”¨åœºæ™¯**
- ğŸ¯ **çº¯è®¡ç®—æœåŠ¡**ï¼šå›¾åƒå¤„ç†ã€æ•°æ®åˆ†æã€æ•°å­¦è®¡ç®—
- ğŸ¯ **æœ¬åœ°å¤„ç†æœåŠ¡**ï¼šæ–‡ä»¶æ ¼å¼è½¬æ¢ã€å‹ç¼©è§£å‹
- ğŸ¯ **å®šæ—¶ä»»åŠ¡**ï¼šæ—¥å¿—æ¸…ç†ã€æ•°æ®å¤‡ä»½(æœ¬åœ°)

**âš ï¸ æ³¨æ„äº‹é¡¹**
```
é™åˆ¶å½±å“ï¼š
â€¢ æ— æ³•è¿æ¥æ•°æ®åº“(é™¤éé€šè¿‡Unix Socket)
â€¢ æ— æ³•å‘é€é‚®ä»¶æˆ–HTTPè¯·æ±‚
â€¢ æ— æ³•è¿›è¡ŒDNSè§£æ
â€¢ æ— æ³•è®¿é—®ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ

æ›¿ä»£æ–¹æ¡ˆï¼š
â€¢ ä½¿ç”¨Unix Domain Socketè¿›è¡Œæœ¬åœ°é€šä¿¡
â€¢ é€šè¿‡æ–‡ä»¶ç³»ç»Ÿå…±äº«æ•°æ®
â€¢ ä½¿ç”¨ç®¡é“(pipe)ä¼ é€’ä¿¡æ¯
```

---

## 3. ğŸŒ åœ°å€æ—é™åˆ¶é…ç½®


### 3.1 RestrictAddressFamiliesè¯¦è§£


**ğŸ”¸ åœ°å€æ—æ¦‚å¿µ**
```
åœ°å€æ—(Address Family)ï¼šç½‘ç»œåè®®çš„åˆ†ç±»æ–¹å¼
å¸¸ç”¨åœ°å€æ—ï¼š
â€¢ AF_INETï¼šIPv4ç½‘ç»œåè®®
â€¢ AF_INET6ï¼šIPv6ç½‘ç»œåè®®  
â€¢ AF_UNIXï¼šUnixåŸŸå¥—æ¥å­—
â€¢ AF_NETLINKï¼šå†…æ ¸ä¸ç”¨æˆ·ç©ºé—´é€šä¿¡
```

**ğŸ’¡ é€šä¿—ç†è§£**
> å°±åƒä¸åŒçš„"é€šè¯æ–¹å¼"ï¼šAF_INETæ˜¯"æ‰“ç”µè¯"ï¼ŒAF_UNIXæ˜¯"é¢å¯¹é¢äº¤è°ˆ"ï¼ŒAF_INET6æ˜¯"è§†é¢‘é€šè¯"ã€‚é™åˆ¶åœ°å€æ—å°±æ˜¯é™åˆ¶æœåŠ¡èƒ½ä½¿ç”¨å“ªäº›"é€šè¯æ–¹å¼"ã€‚

### 3.2 å®é™…é…ç½®ç¤ºä¾‹


**ğŸ”§ WebæœåŠ¡é…ç½®**
```ini
# /etc/systemd/system/webapp.service
[Unit]
Description=Webåº”ç”¨æœåŠ¡
After=network.target

[Service]
Type=notify
User=webapp
ExecStart=/opt/webapp/server

# åªå…è®¸IPv4å’ŒUnixå¥—æ¥å­—
RestrictAddressFamilies=AF_INET AF_UNIX

# å…¶ä»–å®‰å…¨é…ç½®
PrivateTmp=yes
ProtectSystem=strict
ReadWritePaths=/var/log/webapp

[Install]
WantedBy=multi-user.target
```

**ğŸ”§ æ•°æ®åº“æœåŠ¡é…ç½®**
```ini
# /etc/systemd/system/database.service
[Unit]
Description=æ•°æ®åº“æœåŠ¡
After=network.target

[Service]
Type=notify
User=postgres
ExecStart=/usr/bin/postgres -D /var/lib/postgresql/data

# æ”¯æŒIPv4ã€IPv6å’ŒUnixå¥—æ¥å­—
RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX

# æ•°æ®åº“ç‰¹å®šé…ç½®
PrivateDevices=yes
ProtectKernelTunables=yes

[Install]
WantedBy=multi-user.target
```

### 3.3 åœ°å€æ—é™åˆ¶å¯¹ç…§è¡¨


| **æœåŠ¡ç±»å‹** | **æ¨èåœ°å€æ—** | **ä½¿ç”¨åœºæ™¯** |
|-------------|---------------|-------------|
| ğŸŒ **WebæœåŠ¡** | `AF_INET AF_UNIX` | HTTP/HTTPSæœåŠ¡ï¼Œæœ¬åœ°ç®¡ç†æ¥å£ |
| ğŸ—„ï¸ **æ•°æ®åº“** | `AF_INET AF_INET6 AF_UNIX` | ç½‘ç»œ+æœ¬åœ°è¿æ¥ |
| ğŸ“§ **é‚®ä»¶æœåŠ¡** | `AF_INET AF_INET6` | SMTP/POP3/IMAP |
| ğŸ”§ **æœ¬åœ°æœåŠ¡** | `AF_UNIX` | ä»…æœ¬åœ°è¿›ç¨‹é—´é€šä¿¡ |
| ğŸ–¥ï¸ **ç³»ç»ŸæœåŠ¡** | `AF_NETLINK AF_UNIX` | ç³»ç»Ÿç®¡ç†æ¥å£ |

---

## 4. ğŸ›¡ï¸ IPè®¿é—®æ§åˆ¶æœºåˆ¶


### 4.1 IPAddressAllowç™½åå•é…ç½®


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
IPAddressAllowï¼šå…è®¸è®¿é—®çš„IPåœ°å€ç™½åå•
IPAddressDenyï¼šç¦æ­¢è®¿é—®çš„IPåœ°å€é»‘åå•
è§„åˆ™ï¼šç™½åå•ä¼˜å…ˆçº§é«˜äºé»‘åå•
```

**ğŸ”§ ä¼ä¸šå†…ç½‘æœåŠ¡é…ç½®**
```ini
# /etc/systemd/system/internal-api.service
[Unit]
Description=å†…éƒ¨APIæœåŠ¡
After=network.target

[Service]
Type=simple
User=api-user
ExecStart=/opt/api/internal-server

# åªå…è®¸å†…ç½‘è®¿é—®
IPAddressAllow=192.168.0.0/16 10.0.0.0/8 127.0.0.1

# æ˜ç¡®ç¦æ­¢å¤–ç½‘è®¿é—®(å¯é€‰ï¼Œç™½åå•å·²ç»é™åˆ¶)
IPAddressDeny=0.0.0.0/0

[Install]
WantedBy=multi-user.target
```

### 4.2 å¤æ‚è®¿é—®æ§åˆ¶åœºæ™¯


**ğŸ”§ å¤šç¯å¢ƒAPIæœåŠ¡**
```ini
# /etc/systemd/system/api-gateway.service
[Unit]
Description=APIç½‘å…³æœåŠ¡
After=network.target

[Service]
Type=notify
User=gateway
ExecStart=/opt/gateway/server

# å…è®¸ç‰¹å®šIPæ®µå’ŒVPNåœ°å€
IPAddressAllow=localhost
IPAddressAllow=192.168.1.0/24    # åŠå…¬ç½‘ç»œ
IPAddressAllow=10.10.0.0/16      # VPNç½‘ç»œ
IPAddressAllow=172.16.100.0/24   # åˆä½œä¼™ä¼´ç½‘ç»œ

# æ—¥å¿—è®°å½•è¢«æ‹’ç»çš„è¿æ¥
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

**ğŸ“ é…ç½®éªŒè¯**
```bash
# æ£€æŸ¥æœåŠ¡çš„ç½‘ç»œé™åˆ¶
systemctl show api-gateway.service -p IPAddressAllow -p IPAddressDeny

# æµ‹è¯•è¿æ¥(ä»ä¸åŒIP)
curl -I http://æœåŠ¡å™¨IP:ç«¯å£/health

# æŸ¥çœ‹systemdæ—¥å¿—ä¸­çš„è®¿é—®æ§åˆ¶ä¿¡æ¯
journalctl -u api-gateway.service -f
```

### 4.3 IPæ§åˆ¶æœ€ä½³å®è·µ


**ğŸ¯ é…ç½®ç­–ç•¥**
```
1. æœ€å°åŒ–åŸåˆ™ï¼š
   â€¢ åªå…è®¸å¿…è¦çš„IPåœ°å€èŒƒå›´
   â€¢ å®šæœŸå®¡æŸ¥å’Œæ›´æ–°IPç™½åå•
   â€¢ è®°å½•è¢«æ‹’ç»çš„è®¿é—®å°è¯•

2. åˆ†å±‚é˜²æŠ¤ï¼š
   â€¢ systemdå±‚IPæ§åˆ¶(ç¬¬ä¸€é“é˜²çº¿)
   â€¢ åº”ç”¨å±‚è®¿é—®æ§åˆ¶(ç¬¬äºŒé“é˜²çº¿)  
   â€¢ é˜²ç«å¢™è§„åˆ™(ç¬¬ä¸‰é“é˜²çº¿)

3. ç›‘æ§å‘Šè­¦ï¼š
   â€¢ ç›‘æ§å¼‚å¸¸IPè®¿é—®å°è¯•
   â€¢ è®¾ç½®è®¿é—®é¢‘ç‡å‘Šè­¦
   â€¢ è®°å½•è®¿é—®æ¨¡å¼å˜åŒ–
```

---

## 5. ğŸ”Œ ç«¯å£ç»‘å®šæ§åˆ¶


### 5.1 SocketBindAllowç«¯å£ç™½åå•


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
SocketBindAllowï¼šæœåŠ¡å¯ä»¥ç»‘å®šçš„ç«¯å£ç™½åå•
SocketBindDenyï¼šæœåŠ¡ç¦æ­¢ç»‘å®šçš„ç«¯å£é»‘åå•
ç›®çš„ï¼šé˜²æ­¢æœåŠ¡ç»‘å®šä¸å½“çš„ç«¯å£ï¼Œå‡å°‘æ”»å‡»é¢
```

**ğŸ’¡ å®é™…æ„ä¹‰**
> å°±åƒç»™æœåŠ¡åˆ†é…"ä¸“ç”¨è½¦ä½"ï¼ŒWebæœåŠ¡åªèƒ½åœåœ¨80/443è½¦ä½ï¼Œæ•°æ®åº“åªèƒ½åœåœ¨3306è½¦ä½ï¼Œé˜²æ­¢æœåŠ¡ä¹±åœä¹±æ”¾å ç”¨å…¶ä»–æœåŠ¡çš„ç«¯å£ã€‚

### 5.2 WebæœåŠ¡ç«¯å£æ§åˆ¶


**ğŸ”§ æ ‡å‡†WebæœåŠ¡é…ç½®**
```ini
# /etc/systemd/system/webserver.service
[Unit]
Description=WebæœåŠ¡å™¨
After=network.target

[Service]
Type=notify
User=www-data
ExecStart=/usr/sbin/nginx -g "daemon off;"

# åªå…è®¸ç»‘å®šWebç›¸å…³ç«¯å£
SocketBindAllow=80 443 8080 8443

# ç¦æ­¢ç»‘å®šç³»ç»Ÿç«¯å£(å¯é€‰)
SocketBindDeny=1-1023
SocketBindDeny=3306    # MySQLç«¯å£
SocketBindDeny=5432    # PostgreSQLç«¯å£

[Install]
WantedBy=multi-user.target
```

**ğŸ”§ æ•°æ®åº“æœåŠ¡ç«¯å£æ§åˆ¶**
```ini
# /etc/systemd/system/mysql.service
[Unit]
Description=MySQLæ•°æ®åº“
After=network.target

[Service]
Type=notify
User=mysql
ExecStart=/usr/sbin/mysqld

# åªå…è®¸ç»‘å®šæ•°æ®åº“ç«¯å£
SocketBindAllow=3306 33060    # MySQLæ ‡å‡†ç«¯å£å’ŒXåè®®ç«¯å£

# ä¸¥æ ¼ç¦æ­¢å…¶ä»–ç«¯å£
SocketBindDeny=1-3305 3307-65535

# é¢å¤–å®‰å…¨é…ç½®
PrivateNetwork=no
IPAddressAllow=127.0.0.1 192.168.0.0/16

[Install]
WantedBy=multi-user.target
```

### 5.3 ç«¯å£æ§åˆ¶ç­–ç•¥è¡¨


| **æœåŠ¡ç±»å‹** | **å…è®¸ç«¯å£** | **ç¦æ­¢ç«¯å£** | **å®‰å…¨è€ƒé‡** |
|-------------|-------------|-------------|-------------|
| ğŸŒ **WebæœåŠ¡** | `80 443 8080 8443` | `22 3306 5432` | é˜²æ­¢ç›‘å¬SSH/DBç«¯å£ |
| ğŸ—„ï¸ **MySQL** | `3306 33060` | `å…¶ä»–æ‰€æœ‰` | ä¸¥æ ¼é™åˆ¶æ•°æ®åº“ç«¯å£ |
| ğŸ˜ **PostgreSQL** | `5432` | `å…¶ä»–æ‰€æœ‰` | å•ä¸€ç«¯å£ç­–ç•¥ |
| ğŸ”§ **å¼€å‘æœåŠ¡** | `3000-3999 8000-8999` | `ç³»ç»Ÿç«¯å£1-1023` | å¼€å‘ç¯å¢ƒçµæ´»æ€§ |
| ğŸ–¥ï¸ **ç³»ç»ŸæœåŠ¡** | `è‡ªå®šä¹‰ç«¯å£` | `çŸ¥åæœåŠ¡ç«¯å£` | é¿å…ç«¯å£å†²çª |

---

## 6. ğŸ  ç½‘ç»œå‘½åç©ºé—´é…ç½®


### 6.1 NetworkNamespacePathè¯¦è§£


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
NetworkNamespacePathï¼šæŒ‡å®šæœåŠ¡ä½¿ç”¨ç‰¹å®šçš„ç½‘ç»œå‘½åç©ºé—´
ä½œç”¨ï¼šè®©å¤šä¸ªæœåŠ¡å…±äº«åŒä¸€ä¸ªç½‘ç»œç¯å¢ƒ
åœºæ™¯ï¼šå®¹å™¨åŒ–éƒ¨ç½²ã€å¾®æœåŠ¡æ¶æ„
```

**ğŸ’¡ é€šä¿—ç†è§£**
> å°±åƒè®©å‡ ä¸ªå®¤å‹å…±äº«åŒä¸€ä¸ª"ç½‘ç»œå¥—é¤"ï¼Œå®ƒä»¬çœ‹åˆ°çš„ç½‘ç»œç¯å¢ƒå®Œå…¨ä¸€è‡´ï¼Œå¯ä»¥äº’ç›¸ç›´æ¥é€šä¿¡ï¼Œä½†ä¸å¤–ç•Œçš„å…¶ä»–"ç”¨æˆ·"éš”ç¦»ã€‚

### 6.2 å…±äº«ç½‘ç»œå‘½åç©ºé—´é…ç½®


**ğŸ”§ ä¸»æœåŠ¡åˆ›å»ºå‘½åç©ºé—´**
```ini
# /etc/systemd/system/app-main.service
[Unit]
Description=ä¸»åº”ç”¨æœåŠ¡
After=network.target

[Service]
Type=simple
User=app-user
ExecStart=/opt/app/main-server

# åˆ›å»ºç§æœ‰ç½‘ç»œç¯å¢ƒ
PrivateNetwork=yes

# è®¾ç½®ç½‘ç»œæ¥å£(éœ€è¦é¢å¤–è„šæœ¬)
ExecStartPre=/opt/app/setup-network.sh

[Install]
WantedBy=multi-user.target
```

**ğŸ”§ ä»æœåŠ¡åŠ å…¥å‘½åç©ºé—´**
```ini
# /etc/systemd/system/app-worker.service
[Unit]
Description=åº”ç”¨å·¥ä½œè¿›ç¨‹
After=app-main.service
Requires=app-main.service

[Service]
Type=simple
User=app-user
ExecStart=/opt/app/worker-process

# åŠ å…¥ä¸»æœåŠ¡çš„ç½‘ç»œå‘½åç©ºé—´
NetworkNamespacePath=/proc/$(systemctl show -p MainPID --value app-main.service)/ns/net

[Install]
WantedBy=multi-user.target
```

### 6.3 ç½‘ç»œå‘½åç©ºé—´å®ç”¨è„šæœ¬


**ğŸ”§ ç½‘ç»œè®¾ç½®è„šæœ¬**
```bash
#!/bin/bash
# /opt/app/setup-network.sh - é…ç½®ç§æœ‰ç½‘ç»œå‘½åç©ºé—´

set -e

# è·å–æœåŠ¡PID
SERVICE_PID=$(systemctl show -p MainPID --value app-main.service)

if [ -n "$SERVICE_PID" ] && [ "$SERVICE_PID" != "0" ]; then
    # è¿›å…¥ç½‘ç»œå‘½åç©ºé—´å¹¶é…ç½®æ¥å£
    nsenter -t $SERVICE_PID -n ip link set lo up
    nsenter -t $SERVICE_PID -n ip addr add 127.0.0.1/8 dev lo
    
    echo "ç½‘ç»œå‘½åç©ºé—´é…ç½®å®Œæˆ: PID $SERVICE_PID"
else
    echo "è­¦å‘Š: æ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„æœåŠ¡è¿›ç¨‹ID"
    exit 1
fi
```

---

## 7. ğŸ”¥ é˜²ç«å¢™é›†æˆé…ç½®


### 7.1 systemdä¸iptablesé›†æˆ


**ğŸ”¸ é›†æˆåŸç†**
```
systemdç½‘ç»œé™åˆ¶ + iptablesè§„åˆ™ = åŒå±‚é˜²æŠ¤
systemdï¼šè¿›ç¨‹çº§åˆ«çš„è®¿é—®æ§åˆ¶
iptablesï¼šç³»ç»Ÿçº§åˆ«çš„ç½‘ç»œè¿‡æ»¤
```

**ğŸ”§ WebæœåŠ¡é˜²ç«å¢™é›†æˆ**
```ini
# /etc/systemd/system/secure-web.service
[Unit]
Description=å®‰å…¨WebæœåŠ¡
After=network.target iptables.service
Requires=iptables.service

[Service]
Type=notify
User=www-secure
ExecStart=/opt/secure-web/server

# systemdå±‚ç½‘ç»œé™åˆ¶
RestrictAddressFamilies=AF_INET AF_UNIX
IPAddressAllow=127.0.0.1 192.168.0.0/16
SocketBindAllow=8443

# å¯åŠ¨å‰é…ç½®é˜²ç«å¢™è§„åˆ™
ExecStartPre=/opt/secure-web/setup-firewall.sh

# åœæ­¢åæ¸…ç†é˜²ç«å¢™è§„åˆ™  
ExecStopPost=/opt/secure-web/cleanup-firewall.sh

[Install]
WantedBy=multi-user.target
```

**ğŸ”§ é˜²ç«å¢™é…ç½®è„šæœ¬**
```bash
#!/bin/bash
# /opt/secure-web/setup-firewall.sh

# ä¸ºsecure-webæœåŠ¡é…ç½®iptablesè§„åˆ™
iptables -N SECURE_WEB_INPUT 2>/dev/null || true
iptables -F SECURE_WEB_INPUT

# å…è®¸å†…ç½‘è®¿é—®8443ç«¯å£
iptables -A SECURE_WEB_INPUT -p tcp --dport 8443 -s 192.168.0.0/16 -j ACCEPT

# å…è®¸æœ¬åœ°è®¿é—®
iptables -A SECURE_WEB_INPUT -p tcp --dport 8443 -s 127.0.0.1 -j ACCEPT

# æ‹’ç»å…¶ä»–è®¿é—®
iptables -A SECURE_WEB_INPUT -p tcp --dport 8443 -j DROP

# æ’å…¥åˆ°INPUTé“¾
iptables -I INPUT -j SECURE_WEB_INPUT

echo "é˜²ç«å¢™è§„åˆ™é…ç½®å®Œæˆ"
```

### 7.2 åŠ¨æ€é˜²ç«å¢™ç®¡ç†


**ğŸ”§ è‡ªé€‚åº”è®¿é—®æ§åˆ¶**
```bash
#!/bin/bash
# /opt/security/adaptive-firewall.sh - åŠ¨æ€è°ƒæ•´é˜²ç«å¢™è§„åˆ™

SERVICE_NAME="secure-api"
LOG_FILE="/var/log/${SERVICE_NAME}-access.log"

# ç›‘æ§è®¿é—®æ—¥å¿—ï¼ŒåŠ¨æ€è°ƒæ•´è§„åˆ™
monitor_access() {
    tail -f $LOG_FILE | while read line; do
        # æ£€æµ‹å¼‚å¸¸è®¿é—®æ¨¡å¼
        if echo "$line" | grep -q "SUSPICIOUS_PATTERN"; then
            SUSPECT_IP=$(echo "$line" | awk '{print $1}')
            
            # ä¸´æ—¶å°ç¦å¯ç–‘IP
            iptables -I INPUT -s $SUSPECT_IP -j DROP
            
            # è®°å½•å°ç¦è¡Œä¸º
            logger "Blocked suspicious IP: $SUSPECT_IP"
            
            # è®¾ç½®5åˆ†é’Ÿåè‡ªåŠ¨è§£å°
            (sleep 300; iptables -D INPUT -s $SUSPECT_IP -j DROP) &
        fi
    done
}

# åå°è¿è¡Œç›‘æ§
monitor_access &
```

---

## 8. ğŸ”— æœåŠ¡é—´ç½‘ç»œé€šä¿¡æ§åˆ¶


### 8.1 å¾®æœåŠ¡é€šä¿¡é™åˆ¶


**ğŸ”¸ åœºæ™¯è¯´æ˜**
```
å¾®æœåŠ¡æ¶æ„ä¸­çš„é€šä¿¡æ§åˆ¶ï¼š
â€¢ API Gateway â†â†’ ä¸šåŠ¡æœåŠ¡
â€¢ ä¸šåŠ¡æœåŠ¡ â†â†’ æ•°æ®åº“
â€¢ ä¸šåŠ¡æœåŠ¡ â†â†’ ç¼“å­˜æœåŠ¡
â€¢ æœåŠ¡ â†â†’ æ¶ˆæ¯é˜Ÿåˆ—
```

**ğŸ”§ API Gatewayé…ç½®**
```ini
# /etc/systemd/system/api-gateway.service
[Unit]
Description=APIç½‘å…³
After=network.target

[Service]
Type=simple
User=gateway
ExecStart=/opt/gateway/server

# ç½‘å…³éœ€è¦è®¿é—®å¤šä¸ªå†…éƒ¨æœåŠ¡
RestrictAddressFamilies=AF_INET AF_UNIX
IPAddressAllow=127.0.0.1 192.168.100.0/24   # å†…éƒ¨æœåŠ¡ç½‘æ®µ

# åªç»‘å®šå¯¹å¤–ç«¯å£
SocketBindAllow=80 443 8080

# é™åˆ¶å‡ºç«™è¿æ¥
Environment=ALLOWED_UPSTREAM=192.168.100.10:3000,192.168.100.11:3001

[Install]
WantedBy=multi-user.target
```

**ğŸ”§ ä¸šåŠ¡æœåŠ¡é…ç½®**
```ini
# /etc/systemd/system/user-service.service
[Unit]
Description=ç”¨æˆ·æœåŠ¡
After=network.target database.service

[Service]
Type=simple  
User=user-svc
ExecStart=/opt/services/user-service

# åªå…è®¸æ¥è‡ªç½‘å…³çš„è¿æ¥
IPAddressAllow=127.0.0.1 192.168.100.1    # ç½‘å…³IP

# åªèƒ½è¿æ¥æ•°æ®åº“
RestrictAddressFamilies=AF_INET AF_UNIX
SocketBindAllow=3000    # æœåŠ¡ç«¯å£

[Install]
WantedBy=multi-user.target
```

### 8.2 æœåŠ¡ä¾èµ–ç½‘ç»œå›¾


**ğŸ“Š ç½‘ç»œæ‹“æ‰‘ç»“æ„**
```
å¤–éƒ¨ç”¨æˆ·
    â†“ (HTTPS:443)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Gateway â”‚ IPAllow: 0.0.0.0/0
â”‚ :80/:443    â”‚ SocketBind: 80,443
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (HTTP:3000-3002)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Serviceâ”‚ â”‚Order Serviceâ”‚ â”‚Product Svc  â”‚
â”‚ :3000       â”‚ â”‚ :3001       â”‚ â”‚ :3002       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“               â†“               â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ (MySQL:3306)
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Database  â”‚ IPAllow: 192.168.100.0/24
            â”‚ :3306       â”‚ SocketBind: 3306
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 é€šä¿¡çŸ©é˜µé…ç½®


**ğŸ“‹ æœåŠ¡é€šä¿¡æƒé™è¡¨**

| **æœåŠ¡** | **å…¥ç«™å…è®¸** | **å‡ºç«™å…è®¸** | **ç«¯å£ç»‘å®š** |
|---------|-------------|-------------|-------------|
| ğŸŒ **Gateway** | `0.0.0.0/0:80,443` | `192.168.100.0/24` | `80,443` |
| ğŸ‘¤ **User-Svc** | `192.168.100.1` | `192.168.100.10:3306` | `3000` |
| ğŸ“¦ **Order-Svc** | `192.168.100.1` | `192.168.100.10:3306` | `3001` |
| ğŸ›ï¸ **Product-Svc** | `192.168.100.1` | `192.168.100.10:3306` | `3002` |
| ğŸ—„ï¸ **Database** | `192.168.100.0/24` | `-` | `3306` |

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç½‘ç»œéš”ç¦»ï¼šPrivateNetworkå®Œå…¨éš”ç¦»ç½‘ç»œè®¿é—®
ğŸ”¸ åœ°å€æ—é™åˆ¶ï¼šRestrictAddressFamiliesæ§åˆ¶ç½‘ç»œåè®®ç±»å‹
ğŸ”¸ IPè®¿é—®æ§åˆ¶ï¼šIPAddressAllow/Denyå®ç°ç™½åå•/é»‘åå•
ğŸ”¸ ç«¯å£ç»‘å®šæ§åˆ¶ï¼šSocketBindé™åˆ¶æœåŠ¡å¯ä½¿ç”¨çš„ç«¯å£
ğŸ”¸ å‘½åç©ºé—´ï¼šNetworkNamespacePathå®ç°ç½‘ç»œç¯å¢ƒå…±äº«
ğŸ”¸ é›†æˆé˜²æŠ¤ï¼šsystemd + iptablesåŒå±‚ç½‘ç»œå®‰å…¨
```

### 9.2 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ é…ç½®é€‰æ‹©ç­–ç•¥**
```
å®Œå…¨éš”ç¦»åœºæ™¯ï¼š
â€¢ è®¡ç®—å¯†é›†å‹æœåŠ¡ â†’ PrivateNetwork=yes
â€¢ æ–‡ä»¶å¤„ç†æœåŠ¡ â†’ PrivateNetwork=yes + æ–‡ä»¶æƒé™æ§åˆ¶

å†…ç½‘æœåŠ¡åœºæ™¯ï¼š
â€¢ æ•°æ®åº“æœåŠ¡ â†’ IPAddressAllow=å†…ç½‘æ®µ + SocketBindAllow=DBç«¯å£
â€¢ å†…éƒ¨API â†’ RestrictAddressFamilies=AF_INET + IPç™½åå•

å¯¹å¤–æœåŠ¡åœºæ™¯ï¼š
â€¢ WebæœåŠ¡ â†’ SocketBindAllow=80,443 + é˜²ç«å¢™é›†æˆ
â€¢ APIç½‘å…³ â†’ æœ€å°åŒ–æƒé™ + åŠ¨æ€è®¿é—®æ§åˆ¶
```

**âš¡ å®‰å…¨é…ç½®æœ€ä½³å®è·µ**
```
1. æœ€å°æƒé™åŸåˆ™ï¼š
   â€¢ åªæˆäºˆæœåŠ¡å¿…éœ€çš„ç½‘ç»œæƒé™
   â€¢ å®šæœŸå®¡æŸ¥å’Œæ”¶ç´§æƒé™èŒƒå›´
   â€¢ è®°å½•æ‰€æœ‰ç½‘ç»œè®¿é—®è¡Œä¸º

2. åˆ†å±‚é˜²æŠ¤ç­–ç•¥ï¼š
   â€¢ systemdç½‘ç»œé™åˆ¶(è¿›ç¨‹çº§)
   â€¢ iptablesè§„åˆ™(ç³»ç»Ÿçº§)
   â€¢ åº”ç”¨å±‚è®¿é—®æ§åˆ¶(ä¸šåŠ¡çº§)

3. ç›‘æ§å‘Šè­¦æœºåˆ¶ï¼š
   â€¢ ç›‘æ§å¼‚å¸¸ç½‘ç»œè®¿é—®å°è¯•
   â€¢ è‡ªåŠ¨åŒ–å¨èƒå“åº”
   â€¢ å®šæœŸå®‰å…¨å®¡è®¡
```

### 9.3 å¸¸è§é—®é¢˜è§£å†³


**â“ æœåŠ¡å¯åŠ¨å¤±è´¥**
```bash
# æ£€æŸ¥ç½‘ç»œæƒé™é…ç½®
systemd-analyze security your-service.service | grep -i network

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
journalctl -u your-service.service -f

# ä¸´æ—¶è°ƒè¯•æ¨¡å¼(æ”¾å®½é™åˆ¶)
systemctl edit your-service.service
# æ·»åŠ ï¼š
[Service]  
IPAddressAllow=
RestrictAddressFamilies=
```

**â“ æ— æ³•è¿æ¥å¤–éƒ¨æœåŠ¡**
```bash
# æ£€æŸ¥å½“å‰ç½‘ç»œé™åˆ¶
systemctl show your-service.service -p IPAddressAllow -p RestrictAddressFamilies

# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
systemd-run --uid=service-user --property=IPAddressAllow=ç›®æ ‡IP curl -I ç›®æ ‡URL
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- systemdç½‘ç»œé™åˆ¶æ˜¯è¿›ç¨‹çº§å®‰å…¨çš„ç¬¬ä¸€é“é˜²çº¿
- ç½‘ç»œéš”ç¦»è¦ä¸ä¸šåŠ¡éœ€æ±‚å¹³è¡¡ï¼Œä¸èƒ½ä¸€åˆ€åˆ‡
- å¤šå±‚é˜²æŠ¤æ¯”å•ä¸€é˜²æŠ¤æ›´å®‰å…¨æœ‰æ•ˆ  
- å®šæœŸå®¡æŸ¥å’Œè°ƒæ•´ç½‘ç»œæƒé™é…ç½®