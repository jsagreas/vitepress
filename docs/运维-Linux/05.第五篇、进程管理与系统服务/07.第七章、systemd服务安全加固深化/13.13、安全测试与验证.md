---
title: 13、安全测试与验证
---
## 📚 目录

1. [systemd-analyze安全分析](#1-systemd-analyze安全分析)
2. [服务安全配置测试](#2-服务安全配置测试)
3. [权限测试验证方法](#3-权限测试验证方法)
4. [安全策略有效性验证](#4-安全策略有效性验证)
5. [漏洞扫描与评估](#5-漏洞扫描与评估)
6. [渗透测试配合配置](#6-渗透测试配合配置)
7. [安全基线检查工具](#7-安全基线检查工具)
8. [持续安全监控部署](#8-持续安全监控部署)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔍 systemd-analyze安全分析


### 1.1 什么是systemd-analyze安全分析


**简单理解**：就像给你的服务做个"安全体检"，看看它的安全配置是否合格。

`systemd-analyze` 是Linux系统自带的一个工具，专门用来分析systemd服务的安全性。它会检查你的服务配置，然后给出一个"安全评分"，告诉你哪些地方做得好，哪些地方还需要加强。

```
简单比喻：
就像汽车年检一样，检查各个安全配置项
✅ 安全带 - 对应服务的权限限制
✅ 刹车系统 - 对应网络访问控制  
✅ 灯光系统 - 对应文件系统保护
最后给出一个综合评分
```

### 1.2 基本使用方法


**🔸 分析单个服务**
```bash
# 分析nginx服务的安全配置
systemd-analyze security nginx

# 分析SSH服务的安全配置  
systemd-analyze security sshd

# 分析Apache服务
systemd-analyze security apache2
```

**💡 输出结果解读**
```
示例输出：
NAME                DESCRIPTION                     EXPOSURE
✗ PrivateNetwork=   Service has access to the host's network  10.0
✗ NoNewPrivileges=  Service processes may acquire new privileges  10.0
✓ ProtectHome=      Service has no access to home directories  0.0
~ DynamicUser=      Service runs under a dynamic user  5.0

Overall exposure level for nginx.service: 9.2 (UNSAFE) 😨
```

**评分说明**：
- `0.0-2.0`：**安全** 🟢 配置很好
- `2.1-5.0`：**中等** 🟡 有改进空间  
- `5.1-7.0`：**有风险** 🟠 需要关注
- `7.1-10.0`：**危险** 🔴 急需修复

### 1.3 详细分析选项


**🔸 查看所有安全检查项**
```bash
# 显示完整的安全分析报告
systemd-analyze security --no-pager nginx

# 只显示有问题的项目
systemd-analyze security --no-pager --threshold=5 nginx

# 以JSON格式输出（方便脚本处理）
systemd-analyze security --format=json nginx
```

### 1.4 核心安全配置项解释


```
🔸 网络安全
PrivateNetwork=     是否隔离网络（建议启用）
IPAddressDeny=      是否限制IP访问
RestrictAddressFamilies=  限制网络协议族

🔸 文件系统安全  
ProtectSystem=      保护系统文件夹
ProtectHome=        保护用户主目录
ReadOnlyPaths=      只读路径设置
PrivateTmp=         使用私有临时目录

🔸 权限安全
NoNewPrivileges=    禁止获取新权限
User=               指定运行用户
DynamicUser=        使用动态用户

🔸 系统调用安全
SystemCallFilter=   系统调用过滤
SystemCallArchitectures=  限制系统架构
```

---

## 2. 🛠️ 服务安全配置测试


### 2.1 什么是服务安全配置测试


**通俗解释**：就是验证你对服务设置的那些安全规则是否真的生效了。

比如你设置了"禁止服务访问网络"，那就要实际测试一下，看看服务是不是真的无法联网。

### 2.2 网络访问测试


**🔸 测试网络隔离**
```bash
# 1. 设置网络隔离的服务配置
cat > /etc/systemd/system/test-service.service << 'EOF'
[Unit]
Description=Test Service with Network Isolation

[Service]
ExecStart=/bin/bash -c 'ping -c 3 8.8.8.8 || echo "网络被隔离了"'
PrivateNetwork=yes
Type=oneshot

[Install]
WantedBy=multi-user.target
EOF

# 2. 重载并测试
systemctl daemon-reload
systemctl start test-service
systemctl status test-service

# 3. 查看日志验证
journalctl -u test-service --no-pager
```

**预期结果**：服务应该无法ping通外网，证明网络隔离生效。

### 2.3 文件系统保护测试


**🔸 测试目录保护**
```bash
# 创建测试服务，尝试写入受保护目录
cat > /etc/systemd/system/fs-test.service << 'EOF'
[Unit]
Description=Filesystem Protection Test

[Service]
ExecStart=/bin/bash -c 'echo "测试" > /home/test.txt 2>&1 || echo "无法写入home目录"'
ProtectHome=yes
Type=oneshot
EOF

# 启动测试
systemctl daemon-reload
systemctl start fs-test
journalctl -u fs-test --no-pager
```

### 2.4 权限降级测试


**🔸 验证用户权限**
```bash
# 检查服务实际运行用户
ps aux | grep your-service

# 测试权限操作
sudo -u service-user whoami
sudo -u service-user ls /root  # 应该被拒绝
```

---

## 3. 🔐 权限测试验证方法


### 3.1 文件权限测试


**核心思路**：验证用户和服务是否只能访问它们应该访问的文件。

**🔸 基本权限检查**
```bash
# 1. 查看关键文件权限
ls -la /etc/passwd
ls -la /etc/shadow  
ls -la /var/log/

# 2. 测试普通用户权限
su - testuser -c "cat /etc/shadow"  # 应该被拒绝
su - testuser -c "ls /var/log/"     # 检查访问权限

# 3. 服务文件权限检查
find /etc/systemd/system/ -type f -perm -o+w  # 查找其他用户可写的服务文件
```

### 3.2 进程权限测试


**🔸 检查进程特权**
```bash
# 查看进程的实际权限
ps axo pid,user,group,comm | grep nginx

# 检查进程的capabilities
grep Cap /proc/$(pgrep nginx | head -1)/status

# 验证进程不能执行特权操作
```

### 3.3 网络权限测试


**🔸 端口访问测试**
```bash
# 1. 检查开放端口
netstat -tlnp | grep :80
ss -tlnp | grep :443

# 2. 测试端口访问
nmap localhost -p 1-1024  # 扫描特权端口

# 3. 验证服务只监听指定接口
netstat -tlnp | grep nginx
```

**测试用例示例**：
```
✅ 正确：nginx只监听80和443端口
✅ 正确：SSH只监听指定IP的22端口  
❌ 错误：服务监听了0.0.0.0:3306（不安全）
```

---

## 4. ✅ 安全策略有效性验证


### 4.1 什么是安全策略有效性验证


**简单说明**：就是检查你制定的那些安全规则是否真的在保护系统，还是只是看起来很安全。

```
举个例子：
你设置了防火墙规则禁止外网访问数据库
但是要实际测试：
1. 从外网真的无法连接数据库吗？
2. 内网可以正常访问吗？
3. 应用程序工作正常吗？
```

### 4.2 防火墙规则验证


**🔸 基本连接测试**
```bash
# 1. 从不同位置测试连接
# 内网测试
telnet 192.168.1.100 3306

# 外网测试（应该失败）
telnet your-server.com 3306

# 2. 使用nmap扫描
nmap -p 1-65535 your-server-ip

# 3. 检查防火墙规则
iptables -L -n
firewall-cmd --list-all
```

### 4.3 访问控制验证


**🔸 用户权限分离测试**
```bash
# 1. 创建测试用户
useradd testuser

# 2. 测试权限边界
su - testuser -c "sudo ls"        # 应该被拒绝
su - testuser -c "cat /etc/shadow"  # 应该被拒绝
su - testuser -c "netstat -tlnp"   # 检查能看到什么

# 3. 测试服务账户
su - nginx -c "bash"  # 应该无法获得shell
```

### 4.4 网络分段验证


**🔸 网络隔离测试**
```bash
# 测试不同网段的连通性
ping 192.168.1.100    # Web服务器
ping 192.168.2.100    # 数据库服务器
ping 192.168.3.100    # 管理网络

# 检查路由规则
ip route show
iptables -L FORWARD
```

---

## 5. 🔍 漏洞扫描与评估


### 5.1 漏洞扫描基础概念


**什么是漏洞扫描**：用自动化工具检查系统中存在的安全漏洞，就像用机器给系统做全面体检。

**常见漏洞类型**：
- **软件版本过旧**：存在已知安全漏洞
- **配置错误**：权限设置不当、服务暴露等
- **弱密码**：容易被破解的密码
- **未打补丁**：系统补丁未及时更新

### 5.2 系统级漏洞扫描


**🔸 使用Lynis进行系统审计**
```bash
# 安装Lynis
curl -L https://downloads.cisofy.com/lynis/lynis-3.0.8.tar.gz | tar xz
cd lynis

# 运行完整系统审计
./lynis audit system

# 查看建议
./lynis show suggestions

# 生成报告
./lynis audit system --report-file /tmp/lynis-report.txt
```

**报告解读**：
```
扫描结果示例：
✅ [KRNL-6000] 内核版本检查                    [正常]
❌ [AUTH-9262] 检查sudoers文件权限             [警告]
⚠️  [SSH-7408] SSH配置检查                    [建议]

总体评分：78/100 (Good)
需要关注：3个警告，5个建议
```

### 5.3 网络服务漏洞扫描


**🔸 使用Nmap进行服务扫描**
```bash
# 基础端口扫描
nmap -sS your-server-ip

# 服务版本检测
nmap -sV your-server-ip

# 漏洞脚本扫描
nmap --script vuln your-server-ip

# 详细扫描报告
nmap -sC -sV -O your-server-ip -oA scan-results
```

### 5.4 Web应用漏洞扫描


**🔸 使用Nikto扫描Web服务**
```bash
# 安装Nikto
apt install nikto

# 扫描Web应用
nikto -h http://your-website.com

# 详细扫描
nikto -h http://your-website.com -C all -Format htm -output nikto-report.html
```

**常见发现的问题**：
```
🔸 常见漏洞发现
- 默认页面未删除
- 敏感文件可访问 (.git, .svn等)
- 弱加密算法
- 缺失安全头部
- SQL注入风险点
```

---

## 6. 🎯 渗透测试配合配置


### 6.1 渗透测试环境准备


**什么是渗透测试配合**：为渗透测试创建安全的测试环境，确保测试不会影响生产系统。

**🔸 隔离测试环境**
```bash
# 1. 创建测试用虚拟机或容器
docker run -d --name pentest-target ubuntu:20.04

# 2. 配置网络隔离
iptables -A INPUT -s test-network -j ACCEPT
iptables -A INPUT -j DROP

# 3. 部署测试版本应用
# （使用与生产环境相同的配置，但数据要脱敏）
```

### 6.2 测试工具配置


**🔸 Metasploit配置**
```bash
# 安装和初始化
apt install metasploit-framework
msfdb init

# 配置目标范围
echo "192.168.100.0/24" > /tmp/target-range.txt

# 运行基础扫描
msfconsole -x "db_nmap -sS 192.168.100.1-50"
```

### 6.3 测试结果配合


**🔸 结果收集和分析**
```bash
# 1. 收集渗透测试日志
mkdir /var/log/pentest
tail -f /var/log/auth.log > /var/log/pentest/auth-during-test.log

# 2. 监控系统状态
while true; do
  echo "$(date): $(w | wc -l) users logged in" >> /var/log/pentest/system-status.log
  sleep 60
done

# 3. 分析攻击路径
grep "Failed password" /var/log/pentest/auth-during-test.log
```

---

## 7. 📊 安全基线检查工具


### 7.1 什么是安全基线


**通俗解释**：安全基线就是一套"安全标准答案"，规定了系统应该如何配置才算安全。

```
比如安全基线会规定：
✅ 密码长度至少8位
✅ SSH禁用root登录  
✅ 防火墙必须启用
✅ 系统日志必须记录
✅ 未使用的服务必须关闭
```

### 7.2 CIS基线检查


**🔸 使用CIS-CAT工具**
```bash
# 下载CIS基线检查工具（需要注册）
# 运行Ubuntu 20.04基线检查
./CIS-CAT.sh -b benchmarks/CIS_Ubuntu_20.04_Benchmark_v1.0.0-xccdf.xml

# 生成HTML报告  
./CIS-CAT.sh -b benchmarks/CIS_Ubuntu_20.04_Benchmark_v1.0.0-xccdf.xml -r /tmp/cis-report
```

### 7.3 自定义基线检查脚本


**🔸 创建检查脚本**
```bash
#!/bin/bash
# 简单的安全基线检查脚本

echo "🔍 开始安全基线检查..."

# 检查1: SSH配置
echo "检查SSH配置..."
if grep -q "PermitRootLogin no" /etc/ssh/sshd_config; then
    echo "✅ SSH禁用root登录 - 通过"
else
    echo "❌ SSH允许root登录 - 失败"
fi

# 检查2: 防火墙状态
echo "检查防火墙状态..."
if systemctl is-active --quiet ufw; then
    echo "✅ 防火墙已启用 - 通过"
else
    echo "❌ 防火墙未启用 - 失败"
fi

# 检查3: 系统更新
echo "检查系统更新..."
updates=$(apt list --upgradable 2>/dev/null | wc -l)
if [ $updates -lt 5 ]; then
    echo "✅ 系统更新较新 ($updates个待更新) - 通过"
else
    echo "⚠️  系统需要更新 ($updates个待更新) - 警告"
fi

echo "🏁 基线检查完成"
```

### 7.4 OpenSCAP工具


**🔸 使用OpenSCAP进行合规检查**
```bash
# 安装OpenSCAP
apt install libopenscap8 scap-security-guide

# 运行Ubuntu基线扫描
oscap xccdf eval --profile xccdf_org.ssgproject.content_profile_standard \
    --results results.xml \
    --report report.html \
    /usr/share/scap-security-guide/ssg-ubuntu2004-ds.xml

# 查看报告
firefox report.html
```

---

## 8. 📈 持续安全监控部署


### 8.1 持续监控的重要性


**为什么需要持续监控**：安全不是一次性的事情，而是需要持续关注的过程。

```
安全威胁在变化：
- 新漏洞不断出现
- 攻击手段在进化  
- 系统配置可能被更改
- 用户行为可能有异常

持续监控就像：
🏥 医院的监护仪 - 实时监测病人状况
🚨 家里的报警器 - 24小时守护安全
📹 监控摄像头 - 记录所有活动
```

### 8.2 日志监控系统


**🔸 配置rsyslog集中日志**
```bash
# 1. 配置日志服务器
echo "*.*  $$log-server:514" >> /etc/rsyslog.conf

# 2. 配置日志轮转
cat > /etc/logrotate.d/security-logs << 'EOF'
/var/log/security/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    create 640 syslog syslog
}
EOF

# 3. 重启服务
systemctl restart rsyslog
```

### 8.3 文件完整性监控


**🔸 使用AIDE监控文件变化**
```bash
# 安装AIDE
apt install aide

# 初始化数据库
aide --init
mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db

# 定期检查文件变化
cat > /etc/cron.daily/aide-check << 'EOF'
#!/bin/bash
aide --check | mail -s "AIDE报告 $(date)" admin@company.com
EOF

chmod +x /etc/cron.daily/aide-check
```

### 8.4 性能和安全指标监控


**🔸 部署监控工具**
```bash
# 1. 安装监控代理
curl -L https://github.com/prometheus/node_exporter/releases/download/v1.0.1/node_exporter-1.0.1.linux-amd64.tar.gz | tar xz
sudo cp node_exporter-*/node_exporter /usr/local/bin/

# 2. 创建systemd服务
cat > /etc/systemd/system/node-exporter.service << 'EOF'
[Unit]
Description=Node Exporter

[Service]
User=node-exporter  
ExecStart=/usr/local/bin/node_exporter
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# 3. 启动监控
systemctl enable --now node-exporter
```

### 8.5 告警系统配置


**🔸 配置告警规则**
```bash
# 创建告警脚本
cat > /usr/local/bin/security-alert.sh << 'EOF'
#!/bin/bash
# 安全告警脚本

# 检查失败登录
failed_logins=$(journalctl --since "1 hour ago" | grep "Failed password" | wc -l)
if [ $failed_logins -gt 10 ]; then
    echo "⚠️ 警告：过去1小时内有 $failed_logins 次失败登录尝试" | \
        mail -s "安全警告" admin@company.com
fi

# 检查磁盘使用率
disk_usage=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $disk_usage -gt 90 ]; then
    echo "⚠️ 警告：根分区磁盘使用率达到 $disk_usage%" | \
        mail -s "磁盘空间警告" admin@company.com
fi

# 检查进程异常
if ! pgrep nginx > /dev/null; then
    echo "❌ 错误：nginx服务未运行" | \
        mail -s "服务异常" admin@company.com
fi
EOF

# 设置定期执行
echo "*/10 * * * * /usr/local/bin/security-alert.sh" | crontab -
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的基本概念


```
🔸 systemd-analyze：系统自带的安全分析工具，给服务打"安全评分"
🔸 安全配置测试：验证设置的安全规则是否真的生效
🔸 权限验证：确保用户和服务只能访问应该访问的资源
🔸 漏洞扫描：自动化工具检查系统安全问题
🔸 安全基线：一套标准的安全配置要求
🔸 持续监控：24小时守护系统安全状态
```

### 9.2 关键理解要点


**🔹 安全测试的层次性**
```
配置层面：检查服务配置是否安全
  ↓
权限层面：验证访问控制是否有效  
  ↓
网络层面：确认网络隔离是否生效
  ↓
应用层面：检查应用程序安全性
  ↓
系统层面：整体安全评估
```

**🔹 测试与生产环境的关系**
```
测试环境：
- 安全、隔离的测试空间
- 可以进行破坏性测试
- 数据脱敏，配置相同

生产环境：
- 只进行非破坏性检查
- 重点关注监控和告警
- 定期进行安全评估
```

**🔹 工具选择原则**
```
简单场景：使用系统自带工具（systemd-analyze, netstat等）
中等需求：开源扫描工具（Lynis, Nmap, Nikto）
复杂环境：专业安全工具（OpenSCAP, CIS-CAT）
企业级：商业安全产品 + 自定义脚本
```

### 9.3 实际应用指导


**🎯 日常安全检查清单**
```
每日检查：
✅ 查看系统登录日志
✅ 检查服务运行状态  
✅ 监控磁盘和内存使用

每周检查：
✅ 运行安全基线检查
✅ 更新系统补丁
✅ 检查防火墙日志

每月检查：
✅ 进行漏洞扫描
✅ 审计用户权限
✅ 更新安全策略
```

**🔧 常用命令速查**
```bash
# 安全分析
systemd-analyze security service-name    # 服务安全评分
lynis audit system                       # 系统安全审计  
nmap -sV target-ip                       # 服务版本扫描

# 权限检查
ls -la /etc/passwd                       # 关键文件权限
ps aux | grep service-name               # 服务运行用户
netstat -tlnp                           # 监听端口检查

# 日志分析
journalctl -u service-name               # 服务日志
grep "Failed password" /var/log/auth.log # 登录失败
tail -f /var/log/syslog                 # 实时系统日志
```

### 9.4 注意事项和最佳实践


**⚠️ 重要提醒**
```
测试安全：
- 在测试环境进行破坏性测试
- 渗透测试要有明确授权
- 备份重要数据再进行测试

工具使用：
- 不要在生产环境运行未知脚本
- 扫描工具可能触发入侵检测系统
- 定期更新工具和规则库

结果解读：
- 警告不等于漏洞，需要分析实际影响
- 结合业务场景判断风险优先级
- 误报和漏报都可能存在
```

**✨ 最佳实践**
- **分层防御**：不依赖单一安全措施
- **定期评估**：安全检查要成为常规工作
- **文档记录**：记录配置变更和测试结果
- **团队协作**：开发、运维、安全团队密切配合
- **持续改进**：根据测试结果优化安全配置

**核心记忆**：
- 安全测试像体检，定期检查保健康
- 工具虽好需会用，结果解读更重要
- 测试生产要分开，安全规则验实效
- 持续监控不能停，早发现早处理