---
title: 5ã€ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤æœºåˆ¶æ¦‚è¿°](#1-ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤æœºåˆ¶æ¦‚è¿°)
2. [SystemCallFilteråŸºç¡€é…ç½®](#2-SystemCallFilteråŸºç¡€é…ç½®)
3. [ç³»ç»Ÿè°ƒç”¨é›†åˆä¸é¢„å®šä¹‰ç­–ç•¥](#3-ç³»ç»Ÿè°ƒç”¨é›†åˆä¸é¢„å®šä¹‰ç­–ç•¥)
4. [é”™è¯¯å¤„ç†ä¸æ¶æ„é™åˆ¶](#4-é”™è¯¯å¤„ç†ä¸æ¶æ„é™åˆ¶)
5. [seccomp-bpfè¿‡æ»¤å™¨åŸç†](#5-seccomp-bpfè¿‡æ»¤å™¨åŸç†)
6. [ç³»ç»Ÿè°ƒç”¨å®¡è®¡ä¸ç›‘æ§](#6-ç³»ç»Ÿè°ƒç”¨å®¡è®¡ä¸ç›‘æ§)
7. [æ€§èƒ½å½±å“ä¸æœ€ä½³å®è·µ](#7-æ€§èƒ½å½±å“ä¸æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤æœºåˆ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤


**é€šä¿—ç†è§£**ï¼šç³»ç»Ÿè°ƒç”¨è¿‡æ»¤å°±åƒç»™ç¨‹åºè£…äº†ä¸€ä¸ª"å®‰å…¨é—¨å«"

```
æ²¡æœ‰è¿‡æ»¤çš„æƒ…å†µï¼š
ç¨‹åº â†’ ç›´æ¥è®¿é—®å†…æ ¸ â†’ æ‰§è¡Œä»»ä½•ç³»ç»Ÿè°ƒç”¨
é£é™©ï¼šæ¶æ„ç¨‹åºå¯ä»¥ä¸ºæ‰€æ¬²ä¸º

æœ‰è¿‡æ»¤çš„æƒ…å†µï¼š
ç¨‹åº â†’ å®‰å…¨é—¨å«æ£€æŸ¥ â†’ å…è®¸çš„è°ƒç”¨æ‰èƒ½é€šè¿‡ â†’ å†…æ ¸
å¥½å¤„ï¼šåªèƒ½åšè¢«å…è®¸çš„æ“ä½œ
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **ç³»ç»Ÿè°ƒç”¨**ï¼šç¨‹åºå‘æ“ä½œç³»ç»Ÿè¯·æ±‚æœåŠ¡çš„æ¥å£ï¼ˆå¦‚è¯»æ–‡ä»¶ã€åˆ›å»ºè¿›ç¨‹ç­‰ï¼‰
- **è¿‡æ»¤æœºåˆ¶**ï¼šé™åˆ¶ç¨‹åºåªèƒ½ä½¿ç”¨ç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨
- **seccomp**ï¼šLinuxå†…æ ¸çš„å®‰å…¨è®¡ç®—æ¨¡å¼ï¼Œç”¨äºé™åˆ¶ç³»ç»Ÿè°ƒç”¨

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤


**å®‰å…¨é˜²æŠ¤éœ€æ±‚**ï¼š
```
WebæœåŠ¡å™¨ç¤ºä¾‹ï¼š
âœ… éœ€è¦çš„ç³»ç»Ÿè°ƒç”¨ï¼š
  - read/write (å¤„ç†ç½‘ç»œæ•°æ®)
  - open/close (è¯»å–é…ç½®æ–‡ä»¶)
  - socketç›¸å…³ (ç½‘ç»œé€šä¿¡)

âŒ ä¸éœ€è¦çš„ç³»ç»Ÿè°ƒç”¨ï¼š
  - mount/umount (æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ)
  - reboot (é‡å¯ç³»ç»Ÿ)
  - ptrace (è°ƒè¯•å…¶ä»–è¿›ç¨‹)
  - module_init (åŠ è½½å†…æ ¸æ¨¡å—)
```

**å®é™…åº”ç”¨ä»·å€¼**ï¼š
- **æœ€å°æƒé™åŸåˆ™**ï¼šåªç»™ç¨‹åºæœ€å¿…è¦çš„æƒé™
- **æ”»å‡»é¢ç¼©å‡**ï¼šå‡å°‘å¯è¢«åˆ©ç”¨çš„ç³»ç»Ÿè°ƒç”¨
- **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³å®‰å…¨æ ‡å‡†å’Œå®¡è®¡è¦æ±‚

### 1.3 systemdä¸­çš„å®ç°æ–¹å¼


**æ¶æ„ç¤ºæ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Application   â”‚ â† ç”¨æˆ·ç¨‹åº
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        |
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   systemd       â”‚ â† æœåŠ¡ç®¡ç†å™¨
â”‚  é…ç½®è¿‡æ»¤è§„åˆ™    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        |
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   seccomp-bpf   â”‚ â† å†…æ ¸è¿‡æ»¤å™¨
â”‚   è¿‡æ»¤å™¨        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        |
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Linux Kernel  â”‚ â† å†…æ ¸ç³»ç»Ÿè°ƒç”¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. âš™ï¸ SystemCallFilteråŸºç¡€é…ç½®


### 2.1 åŸºæœ¬è¯­æ³•æ ¼å¼


**é…ç½®æ–¹å¼**ï¼šåœ¨æœåŠ¡å•å…ƒæ–‡ä»¶çš„`[Service]`æ®µä¸­é…ç½®

```ini
[Service]
# åŸºæœ¬æ ¼å¼ï¼šSystemCallFilter=è°ƒç”¨åˆ—è¡¨
SystemCallFilter=read write open close

# ç™½åå•æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼šåªå…è®¸åˆ—å‡ºçš„ç³»ç»Ÿè°ƒç”¨
SystemCallFilter=@basic-io @file-system @network-io

# é»‘åå•æ¨¡å¼ï¼šç¦æ­¢åˆ—å‡ºçš„ç³»ç»Ÿè°ƒç”¨
SystemCallFilter=~@privileged @raw-io
```

**è¯­æ³•è¯´æ˜**ï¼š
- **ä¸åŠ å‰ç¼€**ï¼šç™½åå•æ¨¡å¼ï¼Œåªå…è®¸æŒ‡å®šçš„è°ƒç”¨
- **`~`å‰ç¼€**ï¼šé»‘åå•æ¨¡å¼ï¼Œç¦æ­¢æŒ‡å®šçš„è°ƒç”¨  
- **`@`å‰ç¼€**ï¼šå¼•ç”¨é¢„å®šä¹‰çš„ç³»ç»Ÿè°ƒç”¨é›†åˆ

### 2.2 ç™½åå•é…ç½®ç¤ºä¾‹


**WebæœåŠ¡å™¨é…ç½®**ï¼š
```ini
[Unit]
Description=Secure Web Server
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/nginx -g "daemon off;"
User=nginx
Group=nginx

# ç³»ç»Ÿè°ƒç”¨ç™½åå•ï¼šåªå…è®¸å¿…éœ€çš„è°ƒç”¨
SystemCallFilter=@basic-io @file-system @network-io @signal @process
SystemCallFilter=mmap munmap mprotect
SystemCallFilter=clock_gettime gettimeofday

# å…¶ä»–å®‰å…¨é…ç½®
NoNewPrivileges=true
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

**é…ç½®è§£é‡Š**ï¼š
- `@basic-io`ï¼šåŸºç¡€è¾“å…¥è¾“å‡ºæ“ä½œ
- `@file-system`ï¼šæ–‡ä»¶ç³»ç»Ÿè®¿é—®
- `@network-io`ï¼šç½‘ç»œé€šä¿¡
- `@signal`ï¼šä¿¡å·å¤„ç†
- `@process`ï¼šè¿›ç¨‹ç®¡ç†

### 2.3 é»‘åå•é…ç½®ç¤ºä¾‹


**åº”ç”¨ç¨‹åºä¿æŠ¤**ï¼š
```ini
[Unit]
Description=Application with System Call Protection

[Service]
Type=simple
ExecStart=/opt/myapp/bin/application
User=appuser

# ç³»ç»Ÿè°ƒç”¨é»‘åå•ï¼šç¦æ­¢å±é™©æ“ä½œ
SystemCallFilter=~@privileged @raw-io @mount @swap @reboot
SystemCallFilter=~ptrace seccomp
SystemCallFilter=~keyctl add_key request_key

# è¯¦ç»†è¯´æ˜ï¼š
# @privileged - ç‰¹æƒæ“ä½œï¼ˆå¦‚chrootã€mountç­‰ï¼‰
# @raw-io - åŸå§‹IOæ“ä½œï¼ˆå¯ç»•è¿‡æƒé™æ£€æŸ¥ï¼‰
# @mount - æ–‡ä»¶ç³»ç»ŸæŒ‚è½½æ“ä½œ
# @swap - äº¤æ¢ç©ºé—´æ“ä½œ
# @reboot - ç³»ç»Ÿé‡å¯æ“ä½œ

[Install]
WantedBy=multi-user.target
```

### 2.4 ç»„åˆé…ç½®ç­–ç•¥


**åˆ†å±‚è¿‡æ»¤é…ç½®**ï¼š
```ini
[Service]
# ç¬¬ä¸€å±‚ï¼šå…è®¸åŸºç¡€æ“ä½œ
SystemCallFilter=@basic-io @file-system @network-io

# ç¬¬äºŒå±‚ï¼šç¦æ­¢ç‰¹å®šå±é™©æ“ä½œ  
SystemCallFilter=~@privileged @debug @mount

# ç¬¬ä¸‰å±‚ï¼šæ˜ç¡®ç¦æ­¢ä¸ªåˆ«è°ƒç”¨
SystemCallFilter=~ptrace personality

# ç­‰ä»·äºå•è¡Œé…ç½®ï¼š
# SystemCallFilter=@basic-io @file-system @network-io ~@privileged ~@debug ~@mount ~ptrace ~personality
```

**å®é™…æ•ˆæœ**ï¼š
- âœ… **å…è®¸**ï¼šæ–‡ä»¶è¯»å†™ã€ç½‘ç»œé€šä¿¡ã€åŸºç¡€IO
- âŒ **ç¦æ­¢**ï¼šç³»ç»Ÿç®¡ç†ã€è¿›ç¨‹è°ƒè¯•ã€æ–‡ä»¶ç³»ç»ŸæŒ‚è½½

---

## 3. ğŸ“‹ ç³»ç»Ÿè°ƒç”¨é›†åˆä¸é¢„å®šä¹‰ç­–ç•¥


### 3.1 å¸¸ç”¨ç³»ç»Ÿè°ƒç”¨é›†åˆ


| é›†åˆåç§° | **åŒ…å«çš„ç³»ç»Ÿè°ƒç”¨** | **ç”¨é€”è¯´æ˜** | **å…¸å‹åœºæ™¯** |
|---------|------------------|-------------|-------------|
| `@basic-io` | `read write lseek close` | åŸºç¡€è¾“å…¥è¾“å‡º | æ‰€æœ‰ç¨‹åºåŸºæœ¬éœ€è¦ |
| `@file-system` | `open openat stat chmod` | æ–‡ä»¶ç³»ç»Ÿæ“ä½œ | éœ€è¦æ–‡ä»¶è®¿é—®çš„ç¨‹åº |
| `@network-io` | `socket bind listen accept` | ç½‘ç»œé€šä¿¡ | WebæœåŠ¡ã€æ•°æ®åº“ç­‰ |
| `@process` | `fork clone execve exit` | è¿›ç¨‹ç®¡ç† | éœ€è¦åˆ›å»ºå­è¿›ç¨‹ |
| `@signal` | `kill sigaction sigprocmask` | ä¿¡å·å¤„ç† | éœ€è¦ä¿¡å·é€šä¿¡ |
| `@privileged` | `mount chroot setuid` | ç‰¹æƒæ“ä½œ | é€šå¸¸åº”è¯¥ç¦æ­¢ |

### 3.2 è¯¦ç»†é›†åˆè¯´æ˜


**@basic-ioé›†åˆè¯¦è§£**ï¼š
```bash
# æŸ¥çœ‹é›†åˆåŒ…å«çš„ç³»ç»Ÿè°ƒç”¨
systemd-analyze syscall-filter @basic-io

# åŒ…å«çš„ä¸»è¦è°ƒç”¨ï¼š
read          # è¯»å–æ•°æ®
write         # å†™å…¥æ•°æ®  
lseek         # æ–‡ä»¶å®šä½
close         # å…³é—­æ–‡ä»¶
dup           # å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦
dup2          # å¤åˆ¶åˆ°æŒ‡å®šæè¿°ç¬¦
pipe          # åˆ›å»ºç®¡é“
```

**@network-ioé›†åˆè¯¦è§£**ï¼š
```bash
# ç½‘ç»œç›¸å…³ç³»ç»Ÿè°ƒç”¨
socket        # åˆ›å»ºå¥—æ¥å­—
bind          # ç»‘å®šåœ°å€
listen        # ç›‘å¬è¿æ¥
accept        # æ¥å—è¿æ¥
connect       # å»ºç«‹è¿æ¥
send/sendto   # å‘é€æ•°æ®
recv/recvfrom # æ¥æ”¶æ•°æ®
```

### 3.3 å±é™©ç³»ç»Ÿè°ƒç”¨é›†åˆ


**@privilegedé›†åˆ**ï¼ˆé€šå¸¸åº”è¯¥ç¦æ­¢ï¼‰ï¼š
```
mount/umount     # æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ
chroot           # æ”¹å˜æ ¹ç›®å½•
setuid/setgid    # æ”¹å˜ç”¨æˆ·ID
ptrace           # è¿›ç¨‹è·Ÿè¸ªè°ƒè¯•
reboot           # ç³»ç»Ÿé‡å¯
kexec_load       # åŠ è½½æ–°å†…æ ¸
```

**@raw-ioé›†åˆ**ï¼ˆåŸå§‹IOæ“ä½œï¼‰ï¼š
```
ioperm          # IOç«¯å£æƒé™
iopl            # IOç‰¹æƒçº§åˆ«  
pciconfig_read  # PCIé…ç½®è¯»å–
/dev/memè®¿é—®    # ç›´æ¥å†…å­˜è®¿é—®
```

### 3.4 å®é™…åº”ç”¨ç¤ºä¾‹


**æ•°æ®åº“æœåŠ¡é…ç½®**ï¼š
```ini
[Service]
# æ•°æ®åº“éœ€è¦çš„æ ¸å¿ƒåŠŸèƒ½
SystemCallFilter=@basic-io        # åŸºç¡€IO
SystemCallFilter=@file-system     # æ–‡ä»¶è®¿é—®ï¼ˆæ•°æ®æ–‡ä»¶ï¼‰
SystemCallFilter=@network-io      # ç½‘ç»œè¿æ¥
SystemCallFilter=@process         # å¯èƒ½éœ€è¦forkè¿›ç¨‹
SystemCallFilter=@signal          # ä¿¡å·å¤„ç†
SystemCallFilter=mmap munmap      # å†…å­˜æ˜ å°„ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
SystemCallFilter=fsync fdatasync  # æ•°æ®åŒæ­¥

# æ˜ç¡®ç¦æ­¢å±é™©æ“ä½œ
SystemCallFilter=~@privileged @debug @mount @reboot
```

**å®¹å™¨åŒ–åº”ç”¨é…ç½®**ï¼š
```ini  
[Service]
# å®¹å™¨å†…åº”ç”¨çš„æœ€å°æƒé™é›†
SystemCallFilter=@basic-io @file-system @network-io
SystemCallFilter=~@privileged ~@raw-io ~@mount ~@swap
SystemCallFilter=~ptrace ~personality ~keyctl
```

---

## 4. ğŸ”§ é”™è¯¯å¤„ç†ä¸æ¶æ„é™åˆ¶


### 4.1 SystemCallErrorNumberé…ç½®


**é”™è¯¯è¿”å›æœºåˆ¶**ï¼šå½“ç¨‹åºå°è¯•æ‰§è¡Œè¢«ç¦æ­¢çš„ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œç³»ç»Ÿå¯ä»¥ï¼š
- **SIGKILLä¿¡å·**ï¼ˆé»˜è®¤ï¼‰ï¼šç›´æ¥ç»ˆæ­¢ç¨‹åº
- **è¿”å›é”™è¯¯ç **ï¼šè®©ç¨‹åºç»§ç»­è¿è¡Œï¼Œä½†è°ƒç”¨å¤±è´¥

```ini
[Service]
# é…ç½®è¢«ç¦æ­¢è°ƒç”¨çš„é”™è¯¯è¿”å›ç 
SystemCallErrorNumber=EPERM
SystemCallFilter=~@privileged @mount

# å¸¸ç”¨é”™è¯¯ç ï¼š
# EPERM   - æ“ä½œä¸è¢«å…è®¸
# EACCES  - æƒé™æ‹’ç»
# ENOSYS  - åŠŸèƒ½æœªå®ç°
# EINVAL  - å‚æ•°æ— æ•ˆ
```

**å®é™…æ•ˆæœå¯¹æ¯”**ï¼š
```
é»˜è®¤è¡Œä¸ºï¼ˆSIGKILLï¼‰ï¼š
ç¨‹åºå°è¯•mount() â†’ è¿›ç¨‹è¢«æ€æ­» â†’ æœåŠ¡å¼‚å¸¸é€€å‡º

é…ç½®ErrorNumberåï¼š
ç¨‹åºå°è¯•mount() â†’ è¿”å›EPERMé”™è¯¯ â†’ ç¨‹åºç»§ç»­è¿è¡Œ
```

### 4.2 æ¶æ„é™åˆ¶é…ç½®


**SystemCallArchitecturesç”¨é€”**ï¼šé™åˆ¶ç¨‹åºåªèƒ½ä½¿ç”¨ç‰¹å®šCPUæ¶æ„çš„ç³»ç»Ÿè°ƒç”¨

```ini
[Service]
# é™åˆ¶åªèƒ½ä½¿ç”¨åŸç”Ÿæ¶æ„çš„ç³»ç»Ÿè°ƒç”¨
SystemCallArchitectures=native

# æˆ–è€…æ˜ç¡®æŒ‡å®šæ¶æ„
SystemCallArchitectures=x86-64

# å¤šæ¶æ„æ”¯æŒ
SystemCallArchitectures=x86-64 x86
```

**å®‰å…¨æ„ä¹‰**ï¼š
```
æ”»å‡»é˜²æŠ¤ç¤ºä¾‹ï¼š
æ¶æ„ä»£ç å¯èƒ½å°è¯•ï¼š
- ä½¿ç”¨32ä½ç³»ç»Ÿè°ƒç”¨ç»•è¿‡64ä½å®‰å…¨æ£€æŸ¥
- åˆ©ç”¨ä¸åŒæ¶æ„çš„è°ƒç”¨å·å·®å¼‚
- é€šè¿‡æ¶æ„åˆ‡æ¢é€ƒé¿è¿‡æ»¤

é™åˆ¶æ¶æ„åï¼š
âœ… åªèƒ½ä½¿ç”¨x86-64åŸç”Ÿè°ƒç”¨
âŒ æ— æ³•ä½¿ç”¨i386å…¼å®¹è°ƒç”¨é€ƒé¿è¿‡æ»¤
```

### 4.3 ç»„åˆé…ç½®ç¤ºä¾‹


**å®Œæ•´çš„å®‰å…¨é…ç½®**ï¼š
```ini
[Unit]
Description=Secure Application Service

[Service]
Type=simple
ExecStart=/opt/app/secure-app
User=appuser
Group=appuser

# ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤é…ç½®
SystemCallFilter=@basic-io @file-system @network-io @signal
SystemCallFilter=~@privileged @debug @raw-io @mount

# é”™è¯¯å¤„ç†é…ç½®
SystemCallErrorNumber=EPERM

# æ¶æ„é™åˆ¶é…ç½®  
SystemCallArchitectures=native

# å…¶ä»–å®‰å…¨é…ç½®
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true

[Install]
WantedBy=multi-user.target
```

**é…ç½®éªŒè¯**ï¼š
```bash
# æ£€æŸ¥æœåŠ¡é…ç½®
systemd-analyze verify secure-app.service

# æŸ¥çœ‹è¿è¡Œæ—¶çš„è¿‡æ»¤å™¨çŠ¶æ€
systemd-cgls
grep -r "SystemCall" /proc/[PID]/status
```

---

## 5. ğŸ”¬ seccomp-bpfè¿‡æ»¤å™¨åŸç†


### 5.1 seccompæœºåˆ¶ä»‹ç»


**ä»€ä¹ˆæ˜¯seccomp**ï¼š
- **å…¨ç§°**ï¼šSecure Computing Modeï¼ˆå®‰å…¨è®¡ç®—æ¨¡å¼ï¼‰
- **ä½œç”¨**ï¼šLinuxå†…æ ¸æä¾›çš„ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤æœºåˆ¶
- **å®ç°**ï¼šåŸºäºBPFï¼ˆBerkeley Packet Filterï¼‰çš„è¿‡æ»¤å™¨

**å·¥ä½œåŸç†å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·ç¨‹åº      â”‚
â”‚  ç³»ç»Ÿè°ƒç”¨è¯·æ±‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        |
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  seccomp-bpf    â”‚ â† å†…æ ¸ä¸­çš„è¿‡æ»¤å™¨
â”‚   è¿‡æ»¤å™¨ç¨‹åº     â”‚   æ£€æŸ¥è°ƒç”¨æ˜¯å¦è¢«å…è®¸
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        |
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”
    â†“       â†“
  å…è®¸      æ‹’ç»
    |       |
    â†“       â†“
 â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
 â”‚æ‰§è¡Œ â”‚ â”‚ç»ˆæ­¢ â”‚
 â”‚è°ƒç”¨ â”‚ â”‚ç¨‹åº â”‚
 â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
```

### 5.2 BPFè¿‡æ»¤å™¨å·¥ä½œæœºåˆ¶


**BPFç¨‹åºç»“æ„**ï¼š
```c
// ç®€åŒ–çš„BPFè¿‡æ»¤å™¨ç¤ºä¾‹
struct sock_filter filter[] = {
    // åŠ è½½ç³»ç»Ÿè°ƒç”¨å·
    BPF_STMT(BPF_LD | BPF_W | BPF_ABS, offsetof(struct seccomp_data, nr)),
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºreadç³»ç»Ÿè°ƒç”¨
    BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, __NR_read, 0, 1),
    BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ALLOW),  // å…è®¸
    
    // å…¶ä»–è°ƒç”¨ä¸€å¾‹æ‹’ç»
    BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_KILL)    // ç»ˆæ­¢è¿›ç¨‹
};
```

**systemdç”Ÿæˆçš„è¿‡æ»¤å™¨**ï¼š
```bash
# æŸ¥çœ‹systemdä¸ºæœåŠ¡ç”Ÿæˆçš„seccompè¿‡æ»¤å™¨
systemd-analyze dump secure-app.service | grep -A 20 "SystemCallFilter"

# è¿‡æ»¤å™¨ç‰¹ç‚¹ï¼š
# 1. é«˜æ•ˆï¼šç›´æ¥åœ¨å†…æ ¸ä¸­æ‰§è¡Œï¼Œæ— ç”¨æˆ·æ€åˆ‡æ¢
# 2. å®‰å…¨ï¼šæ— æ³•è¢«ç”¨æˆ·ç¨‹åºç»•è¿‡æˆ–ä¿®æ”¹
# 3. çµæ´»ï¼šæ”¯æŒå¤æ‚çš„è¿‡æ»¤é€»è¾‘
```

### 5.3 è¿‡æ»¤å™¨æ€§èƒ½ç‰¹ç‚¹


**æ€§èƒ½å½±å“åˆ†æ**ï¼š
```
æ— è¿‡æ»¤å™¨ï¼š
ç¨‹åºè°ƒç”¨ â†’ å†…æ ¸ (1æ­¥)

æœ‰è¿‡æ»¤å™¨ï¼š
ç¨‹åºè°ƒç”¨ â†’ BPFæ£€æŸ¥ â†’ å†…æ ¸ (2æ­¥)

æ€§èƒ½å¼€é”€ï¼š
âœ… BPFæ‰§è¡Œæå¿«ï¼ˆçº³ç§’çº§ï¼‰
âœ… ä¸€æ¬¡è®¾ç½®ï¼Œåç»­æ— å¼€é”€
âš ï¸  å¤æ‚è¿‡æ»¤è§„åˆ™å¯èƒ½å¢åŠ å»¶è¿Ÿ
```

**å®é™…æµ‹è¯•æ•°æ®**ï¼š
```bash
# ç³»ç»Ÿè°ƒç”¨æ€§èƒ½æµ‹è¯•
time strace -c -f systemctl start test-service

# å…¸å‹ç»“æœï¼š
# æ— è¿‡æ»¤å™¨ï¼š10,000æ¬¡è°ƒç”¨/ç§’
# ç®€å•è¿‡æ»¤ï¼š9,800æ¬¡è°ƒç”¨/ç§’ï¼ˆ2%å¼€é”€ï¼‰
# å¤æ‚è¿‡æ»¤ï¼š9,500æ¬¡è°ƒç”¨/ç§’ï¼ˆ5%å¼€é”€ï¼‰
```

---

## 6. ğŸ“Š ç³»ç»Ÿè°ƒç”¨å®¡è®¡ä¸ç›‘æ§


### 6.1 å®¡è®¡æ—¥å¿—é…ç½®


**å¯ç”¨å®¡è®¡åŠŸèƒ½**ï¼š
```ini
[Service]
# å¯ç”¨ç³»ç»Ÿè°ƒç”¨å®¡è®¡
SystemCallFilter=@basic-io @file-system ~@privileged
SystemCallErrorNumber=EPERM

# é…åˆauditå­ç³»ç»Ÿ
# éœ€è¦å®‰è£…auditdæœåŠ¡
```

**auditè§„åˆ™é…ç½®**ï¼š
```bash
# /etc/audit/rules.d/syscall-monitor.rules

# ç›‘æ§è¢«æ‹’ç»çš„ç³»ç»Ÿè°ƒç”¨
-a always,exit -F arch=b64 -S all -F success=0 -F exit=-EPERM

# ç›‘æ§ç‰¹æƒç³»ç»Ÿè°ƒç”¨
-a always,exit -F arch=b64 -S mount -S umount2 -S chroot

# ç›‘æ§è¿›ç¨‹åˆ›å»º
-a always,exit -F arch=b64 -S execve -S fork -S clone
```

### 6.2 æ—¥å¿—åˆ†ææ–¹æ³•


**æŸ¥çœ‹è¢«æ‹’ç»çš„è°ƒç”¨**ï¼š
```bash
# æŸ¥çœ‹auditæ—¥å¿—
ausearch -f /usr/bin/myapp -sv no

# ç¤ºä¾‹è¾“å‡ºï¼š
type=SECCOMP msg=audit(1634567890.123:456): 
    auid=1000 uid=1001 gid=1001 ses=2 
    pid=12345 comm="myapp" 
    exe="/usr/bin/myapp" 
    syscall=2 (open) 
    compat=0 
    ip=0x7f1234567890 
    code=0x80000000
```

**åˆ†æè„šæœ¬ç¤ºä¾‹**ï¼š
```bash
#!/bin/bash
# åˆ†æç³»ç»Ÿè°ƒç”¨è¿è§„æ—¥å¿—

echo "=== ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤è¿è§„ç»Ÿè®¡ ==="
ausearch -m SECCOMP --start today | \
awk '/syscall=/ {
    match($0, /syscall=([0-9]+)/, arr);
    syscalls[arr[1]]++
} 
END {
    for(sc in syscalls) 
        print "ç³»ç»Ÿè°ƒç”¨å·", sc ":", syscalls[sc], "æ¬¡è¿è§„"
}'
```

### 6.3 å®æ—¶ç›‘æ§é…ç½®


**ä½¿ç”¨journaldç›‘æ§**ï¼š
```bash
# å®æ—¶æŸ¥çœ‹æœåŠ¡çš„ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤æ—¥å¿—
journalctl -u myapp.service -f | grep -i seccomp

# å…¸å‹æ—¥å¿—è¾“å‡ºï¼š
Oct 15 10:30:15 server systemd[1]: myapp.service: Forbidden system call 'mount' (264)
Oct 15 10:30:16 server kernel: audit: type=1326 audit(1634567890.123:789): auid=1000 uid=1001 gid=1001 ses=2 pid=12345 comm="myapp" exe="/usr/bin/myapp" sig=31 syscall=165 compat=0 ip=0x7f1234567890 code=0x80000000
```

**ç›‘æ§è„šæœ¬è‡ªåŠ¨åŒ–**ï¼š
```bash
#!/bin/bash
# /opt/scripts/syscall-monitor.sh

THRESHOLD=10  # è¿è§„æ¬¡æ•°é˜ˆå€¼
CHECK_INTERVAL=300  # æ£€æŸ¥é—´éš”(ç§’)

while true; do
    # ç»Ÿè®¡æœ€è¿‘5åˆ†é’Ÿçš„è¿è§„æ¬¡æ•°
    VIOLATIONS=$(ausearch -m SECCOMP --start now-5m | wc -l)
    
    if [ $VIOLATIONS -gt $THRESHOLD ]; then
        echo "è­¦å‘Šï¼šæ£€æµ‹åˆ° $VIOLATIONS æ¬¡ç³»ç»Ÿè°ƒç”¨è¿è§„"
        # å‘é€å‘Šè­¦é‚®ä»¶æˆ–é€šçŸ¥
        mail -s "ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤è¿è§„å‘Šè­¦" admin@company.com < /dev/null
    fi
    
    sleep $CHECK_INTERVAL
done
```

---

## 7. âš¡ æ€§èƒ½å½±å“ä¸æœ€ä½³å®è·µ


### 7.1 æ€§èƒ½å½±å“è¯„ä¼°


**å¼€é”€æ¥æºåˆ†æ**ï¼š
```
1. è¿‡æ»¤å™¨åŠ è½½å¼€é”€ï¼š
   - å‘ç”Ÿæ—¶æœºï¼šæœåŠ¡å¯åŠ¨æ—¶
   - å½±å“ç¨‹åº¦ï¼šä¸€æ¬¡æ€§ï¼Œå¯å¿½ç•¥

2. è¿è¡Œæ—¶æ£€æŸ¥å¼€é”€ï¼š
   - å‘ç”Ÿæ—¶æœºï¼šæ¯æ¬¡ç³»ç»Ÿè°ƒç”¨
   - å½±å“ç¨‹åº¦ï¼šå¾®ç§’çº§ï¼Œé€šå¸¸<1%

3. å¤æ‚è§„åˆ™å¼€é”€ï¼š  
   - é•¿è§„åˆ™åˆ—è¡¨ï¼šçº¿æ€§æŸ¥æ‰¾æ—¶é—´å¢åŠ 
   - å¤šå±‚åµŒå¥—ï¼šBPFç¨‹åºå¤æ‚åº¦ä¸Šå‡
```

**æ€§èƒ½æµ‹è¯•æ–¹æ³•**ï¼š
```bash
# åŸºå‡†æµ‹è¯•è„šæœ¬
#!/bin/bash

echo "=== ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤æ€§èƒ½æµ‹è¯• ==="

# æµ‹è¯•æ— è¿‡æ»¤å™¨æƒ…å†µ
systemctl stop test-app
systemctl edit test-app --drop-in=no-filter << EOF
[Service]
SystemCallFilter=
EOF

systemctl start test-app
echo "æ— è¿‡æ»¤å™¨æµ‹è¯•..."
time benchmark-tool --iterations 10000

# æµ‹è¯•æœ‰è¿‡æ»¤å™¨æƒ…å†µ
systemctl stop test-app  
systemctl edit test-app --drop-in=with-filter << EOF
[Service]
SystemCallFilter=@basic-io @file-system @network-io ~@privileged
EOF

systemctl start test-app
echo "æœ‰è¿‡æ»¤å™¨æµ‹è¯•..."
time benchmark-tool --iterations 10000
```

### 7.2 é…ç½®ä¼˜åŒ–ç­–ç•¥


**è§„åˆ™ä¼˜åŒ–åŸåˆ™**ï¼š
```ini
[Service]
# âŒ ä½æ•ˆçš„é…ç½®æ–¹å¼
SystemCallFilter=read
SystemCallFilter=write  
SystemCallFilter=open
SystemCallFilter=close
# ... 100è¡Œå•ä¸ªè°ƒç”¨

# âœ… é«˜æ•ˆçš„é…ç½®æ–¹å¼
SystemCallFilter=@basic-io @file-system @network-io
SystemCallFilter=~@privileged @debug
```

**åˆ†å±‚è¿‡æ»¤ç­–ç•¥**ï¼š
```ini
# âœ… æ¨èçš„åˆ†å±‚é…ç½®
[Service]
# ç¬¬1å±‚ï¼šåŸºç¡€åŠŸèƒ½é›†åˆ
SystemCallFilter=@basic-io @file-system @network-io @process @signal

# ç¬¬2å±‚ï¼šç¦ç”¨å±é™©ç±»åˆ«
SystemCallFilter=~@privileged @raw-io @mount @debug @reboot

# ç¬¬3å±‚ï¼šç²¾ç¡®æ§åˆ¶ä¸ªåˆ«è°ƒç”¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
# SystemCallFilter=~ptrace personality keyctl
```

### 7.3 æœ€ä½³å®è·µæŒ‡å—


**å¼€å‘é˜¶æ®µæœ€ä½³å®è·µ**ï¼š
```bash
# 1. ä½¿ç”¨å®½æ¾é…ç½®å¼€å§‹
[Service]
SystemCallFilter=~@reboot @mount  # åªç¦ç”¨æœ€å±é™©çš„

# 2. é€æ­¥æ”¶ç´§é…ç½®
[Service]  
SystemCallFilter=@basic-io @file-system @network-io
SystemCallFilter=~@privileged

# 3. ç›‘æ§å’Œè°ƒæ•´
ausearch -m SECCOMP --start today
journalctl -u myapp -f | grep seccomp
```

**ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•**ï¼š
- [ ] **æµ‹è¯•å®Œæ•´æ€§**ï¼šç¡®ä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] **ç›‘æ§å‘Šè­¦**ï¼šé…ç½®è¿è§„è¡Œä¸ºç›‘æ§
- [ ] **æ–‡æ¡£è®°å½•**ï¼šè®°å½•è¿‡æ»¤è§„åˆ™çš„ä¸šåŠ¡ç†ç”±
- [ ] **å®šæœŸå®¡æŸ¥**ï¼šéšåº”ç”¨æ›´æ–°è°ƒæ•´è§„åˆ™
- [ ] **å›æ»šè®¡åˆ’**ï¼šå‡†å¤‡å¿«é€Ÿç¦ç”¨è¿‡æ»¤çš„æ–¹æ¡ˆ

**å¸¸è§é—®é¢˜å¤„ç†**ï¼š
```bash
# é—®é¢˜ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥
# è§£å†³ï¼šä¸´æ—¶ç¦ç”¨è¿‡æ»¤å™¨è°ƒè¯•
systemctl edit myapp << EOF
[Service]
SystemCallFilter=
EOF

# é—®é¢˜ï¼šåŠŸèƒ½å¼‚å¸¸
# è§£å†³ï¼šæŸ¥çœ‹è¢«æ‹’ç»çš„è°ƒç”¨
ausearch -m SECCOMP --start today | grep myapp

# é—®é¢˜ï¼šæ€§èƒ½ä¸‹é™
# è§£å†³ï¼šç®€åŒ–è¿‡æ»¤è§„åˆ™
systemctl edit myapp << EOF
[Service]
SystemCallFilter=@basic-io @file-system @network-io ~@privileged
EOF
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤ï¼šé™åˆ¶ç¨‹åºåªèƒ½ä½¿ç”¨ç‰¹å®šçš„å†…æ ¸æ¥å£
ğŸ”¸ SystemCallFilterï¼šsystemdçš„ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤é…ç½®æŒ‡ä»¤
ğŸ”¸ ç™½åå•vsé»‘åå•ï¼š~å‰ç¼€è¡¨ç¤ºé»‘åå•ï¼Œæ— å‰ç¼€è¡¨ç¤ºç™½åå•
ğŸ”¸ é¢„å®šä¹‰é›†åˆï¼š@basic-ioã€@network-ioç­‰å¸¸ç”¨ç³»ç»Ÿè°ƒç”¨åˆ†ç»„
ğŸ”¸ seccomp-bpfï¼šLinuxå†…æ ¸çº§åˆ«çš„è¿‡æ»¤å®ç°æœºåˆ¶
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è¿‡æ»¤æœºåˆ¶çš„æœ¬è´¨**
```
å®‰å…¨åŸç†ï¼š
- æœ€å°æƒé™åŸåˆ™ï¼šåªç»™å¿…éœ€çš„ç³»ç»Ÿè°ƒç”¨æƒé™
- æ”»å‡»é¢ç¼©å‡ï¼šå‡å°‘å¯è¢«æ¶æ„åˆ©ç”¨çš„æ¥å£
- æ·±åº¦é˜²æŠ¤ï¼šå³ä½¿ç¨‹åºè¢«æ”»ç ´ï¼Œæ”»å‡»è€…èƒ½åŠ›ä¹Ÿå—é™

å®ç°æœºåˆ¶ï¼š
- å†…æ ¸çº§é˜²æŠ¤ï¼šæ— æ³•è¢«ç”¨æˆ·ç¨‹åºç»•è¿‡
- BPFé«˜æ•ˆè¿‡æ»¤ï¼šå¾®ç§’çº§æ£€æŸ¥å¼€é”€
- systemdé›†æˆï¼šé…ç½®ç®€å•ï¼ŒåŠŸèƒ½å¼ºå¤§
```

**ğŸ”¹ é…ç½®ç­–ç•¥çš„é€‰æ‹©**
```
ç™½åå•é€‚ç”¨åœºæ™¯ï¼š
- åŠŸèƒ½æ˜ç¡®çš„æœåŠ¡ï¼ˆå¦‚WebæœåŠ¡å™¨ï¼‰
- å®‰å…¨è¦æ±‚æé«˜çš„ç¯å¢ƒ
- å¯ä»¥æ˜ç¡®åˆ—å‡ºæ‰€éœ€è°ƒç”¨çš„ç¨‹åº

é»‘åå•é€‚ç”¨åœºæ™¯ï¼š
- åŠŸèƒ½å¤æ‚å¤šå˜çš„ç¨‹åº
- åªéœ€è¦ç¦ç”¨æ˜æ˜¾å±é™©çš„æ“ä½œ
- ä¸´æ—¶å¿«é€ŸåŠ å›ºçš„åœºæ™¯
```

**ğŸ”¹ é›†åˆä½¿ç”¨çš„æŠ€å·§**
```
å¸¸ç”¨ç»„åˆï¼š
@basic-io + @file-system + @network-io  # Webåº”ç”¨æ ‡é…
~@privileged ~@debug ~@raw-io          # é€šç”¨ç¦ç”¨ç»„åˆ
@process + @signal                     # éœ€è¦è¿›ç¨‹æ§åˆ¶çš„æœåŠ¡

é¿å…è¿‡åº¦é™åˆ¶ï¼š
- ä¸è¦ä¸€å¼€å§‹å°±ç”¨æœ€ä¸¥æ ¼çš„ç™½åå•
- é€æ­¥æ”¶ç´§é…ç½®ï¼Œè¾¹æµ‹è¯•è¾¹è°ƒæ•´
- ä¿ç•™å¿…è¦çš„è°ƒè¯•å’Œç›‘æ§èƒ½åŠ›
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯**
- **WebæœåŠ¡åŠ å›º**ï¼šnginxã€apacheç­‰WebæœåŠ¡å™¨
- **æ•°æ®åº“å®‰å…¨**ï¼šMySQLã€PostgreSQLç­‰æ•°æ®åº“
- **å®¹å™¨å®‰å…¨**ï¼šå®¹å™¨å†…åº”ç”¨çš„æƒé™é™åˆ¶
- **å¾®æœåŠ¡æ¶æ„**ï¼šæœåŠ¡é—´è°ƒç”¨çš„å®‰å…¨éš”ç¦»

**ğŸ”§ è¿ç»´å®è·µè¦ç‚¹**
- **æ¸è¿›å¼éƒ¨ç½²**ï¼šä»å®½æ¾åˆ°ä¸¥æ ¼é€æ­¥æ”¶ç´§
- **ç›‘æ§å‘Šè­¦**ï¼šåŠæ—¶å‘ç°è¿è§„è¡Œä¸ºå’Œè¯¯é…ç½®
- **æ–‡æ¡£ç®¡ç†**ï¼šè®°å½•æ¯ä¸ªè§„åˆ™çš„ä¸šåŠ¡ç›®çš„
- **åº”æ€¥å¤„ç†**ï¼šå‡†å¤‡å¿«é€Ÿç¦ç”¨è¿‡æ»¤çš„å›æ»šæ–¹æ¡ˆ

**ğŸ’¡ å®‰å…¨æ•ˆæœè¯„ä¼°**
```
é‡åŒ–æŒ‡æ ‡ï¼š
- å¯ç”¨ç³»ç»Ÿè°ƒç”¨æ•°é‡ï¼šä»~300ä¸ªå‡å°‘åˆ°~50ä¸ª
- æ”»å‡»é¢ç¼©å‡ï¼šå‡å°‘80%+çš„æ½œåœ¨åˆ©ç”¨ç‚¹
- åˆè§„è¾¾æˆï¼šæ»¡è¶³CISã€NISTç­‰å®‰å…¨æ ‡å‡†

å®šæ€§æ•ˆæœï¼š
- å³ä½¿ç¨‹åºè¢«æ”»ç ´ï¼Œæ”»å‡»è€…æƒé™å—é™
- é˜²æ­¢æƒé™æå‡å’Œæ¨ªå‘ç§»åŠ¨
- æä¾›è¯¦ç»†çš„å®‰å…¨å®¡è®¡æ—¥å¿—
```

### 8.4 å®ç”¨é…ç½®æ¨¡æ¿


**WebæœåŠ¡å™¨æ¨¡æ¿**ï¼š
```ini
[Service]
SystemCallFilter=@basic-io @file-system @network-io @signal @process
SystemCallFilter=~@privileged @debug @raw-io @mount @swap @reboot
SystemCallErrorNumber=EPERM
SystemCallArchitectures=native
```

**æ•°æ®åº“æœåŠ¡æ¨¡æ¿**ï¼š
```ini
[Service]  
SystemCallFilter=@basic-io @file-system @network-io @signal
SystemCallFilter=mmap munmap mprotect fsync fdatasync
SystemCallFilter=~@privileged @debug @mount @reboot
SystemCallErrorNumber=EPERM
```

**é€šç”¨åº”ç”¨æ¨¡æ¿**ï¼š
```ini
[Service]
SystemCallFilter=@basic-io @file-system @network-io @process @signal  
SystemCallFilter=~@privileged @raw-io @debug @mount @swap @reboot @clock
SystemCallErrorNumber=EPERM
SystemCallArchitectures=native
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ç³»ç»Ÿè°ƒç”¨ä¼¼é—¨å«ï¼Œåªæ”¾è¡Œæ¥è®¿å®¢
- ç™½åå•ä¸¥æ ¼é»‘åå•æ¾ï¼Œé›†åˆç»„åˆå·§é…ç½®  
- seccompå†…æ ¸åšè¿‡æ»¤ï¼ŒBPFç¨‹åºé€Ÿåº¦å¿«
- ç›‘æ§å®¡è®¡ä¸å¯å°‘ï¼Œå®‰å…¨è¿ç»´è¦åšå¥½