---
title: 3、文件系统访问控制
---
## 📚 目录

1. [文件系统访问控制概述](#1-文件系统访问控制概述)
2. [临时目录隔离技术](#2-临时目录隔离技术)
3. [系统目录保护机制](#3-系统目录保护机制)
4. [用户目录访问控制](#4-用户目录访问控制)
5. [路径访问权限设置](#5-路径访问权限设置)
6. [挂载绑定与命名空间](#6-挂载绑定与命名空间)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔐 文件系统访问控制概述


### 1.1 什么是文件系统访问控制


**通俗理解**：就像给房子装防盗门和监控一样，文件系统访问控制是给systemd服务装"安全锁"，决定服务能访问哪些文件和目录。

```
生活类比：
租房子时的规则          →    systemd文件访问控制
• 卧室可以随便用         →    ReadWritePaths（读写权限）
• 厨房只能看不能动       →    ReadOnlyPaths（只读权限）
• 其他房间禁止进入       →    InaccessiblePaths（禁止访问）
• 临时储物间独立使用     →    PrivateTmp（临时目录隔离）
```

**核心作用**：
- **安全防护**：防止服务访问不该访问的敏感文件
- **权限最小化**：只给服务运行必需的文件访问权限
- **隔离保护**：不同服务之间的文件访问互不干扰
- **系统稳定**：防止服务误操作破坏系统文件

### 1.2 为什么需要文件系统访问控制


**传统问题**：
```
没有访问控制的风险：
┌─────────────────┐
│   恶意服务      │ ──┐
├─────────────────┤   │
│   Web服务       │ ──┼──→ 都能访问 → /etc/passwd
├─────────────────┤   │              /etc/shadow  
│   数据库服务    │ ──┘              /root/*
└─────────────────┘                  系统关键文件
```

**控制后的安全**：
```
有访问控制的保护：
┌─────────────────┐    ┌─────────────────┐
│   Web服务       │ ──→│ 只能访问网站目录  │
├─────────────────┤    ├─────────────────┤
│   数据库服务    │ ──→│ 只能访问数据目录  │
├─────────────────┤    ├─────────────────┤
│   备份服务      │ ──→│ 只能读取备份目录  │
└─────────────────┘    └─────────────────┘
```

---

## 2. 🔒 临时目录隔离技术


### 2.1 PrivateTmp临时目录隔离


**简单理解**：`PrivateTmp`就像给每个服务单独分配一个临时文件夹，互相看不到对方的临时文件。

**基本概念**：
```
传统方式（不安全）：
/tmp/ 
├── service-a-temp-file    ← 服务A的临时文件
├── service-b-temp-file    ← 服务B的临时文件  
└── user-temp-file         ← 用户的临时文件
    ↑ 所有服务都能看到所有临时文件！

PrivateTmp=true（安全）：
服务A看到的/tmp/：        服务B看到的/tmp/：
├── service-a-temp-file   ├── service-b-temp-file
└── (看不到其他文件)      └── (看不到其他文件)
```

### 2.2 PrivateTmp配置示例


**配置方法**：
```ini
[Unit]
Description=Web服务示例
After=network.target

[Service]
Type=forking
User=www-data
Group=www-data

# 🔸 启用临时目录隔离
PrivateTmp=true

# 🔸 其他相关配置
ExecStart=/usr/sbin/nginx -g "daemon on;"
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

**实际效果验证**：
```bash
# 查看服务实际使用的临时目录
sudo systemctl status nginx
sudo ls -la /tmp/systemd-private-*-nginx.service-*/
```

### 2.3 PrivateTmp工作原理


**技术原理**：
```
1. 创建独立命名空间
   ┌─────────────────────────────┐
   │ 服务的文件系统命名空间        │
   │ /tmp → /tmp/systemd-private- │
   │        [random]-service-*/   │
   └─────────────────────────────┘

2. 目录映射过程
   原始目录：/tmp/
   隔离后：/tmp/systemd-private-abc123-myservice-def456/tmp/
   
3. 服务看到的路径仍然是 /tmp/，但实际指向隔离目录
```

---

## 3. 🛡️ 系统目录保护机制


### 3.1 ProtectSystem系统目录保护


**通俗理解**：`ProtectSystem`就像给系统重要文件夹加了"只读锁"，服务只能看不能改。

**保护级别**：
| 级别 | **保护范围** | **通俗解释** | **适用场景** |
|------|-------------|-------------|-------------|
| `false` | `无保护` | `完全开放，能改任何系统文件` | `系统管理工具` |
| `true` | `保护/usr /boot` | `保护程序文件和启动文件` | `一般应用服务` |
| `full` | `保护整个根文件系统` | `除了/proc /sys /dev外都只读` | `高安全要求服务` |
| `strict` | `整个文件系统只读` | `最严格保护，连/etc也只读` | `无状态服务` |

### 3.2 ProtectSystem配置示例


```ini
[Unit]
Description=高安全Web服务
After=network.target

[Service]
Type=simple
User=nginx
Group=nginx

# 🔸 系统目录保护（不同级别示例）
# ProtectSystem=false     # 无保护（不推荐）
# ProtectSystem=true      # 保护 /usr 和 /boot
ProtectSystem=full        # 保护整个根文件系统
# ProtectSystem=strict    # 最严格保护

# 🔸 配合其他安全选项
ProtectHome=true
PrivateTmp=true

ExecStart=/usr/sbin/nginx -g "daemon off;"
Restart=always

[Install]
WantedBy=multi-user.target
```

### 3.3 ProtectSystem效果演示


```
ProtectSystem=true 的保护效果：
┌─────────────────────────┐
│ 只读保护的目录：          │
│ /usr/     ← 程序文件     │
│ /boot/    ← 启动文件     │
└─────────────────────────┘
┌─────────────────────────┐
│ 仍可写的目录：            │
│ /var/     ← 数据目录     │
│ /etc/     ← 配置目录     │
│ /opt/     ← 可选软件     │
└─────────────────────────┘

ProtectSystem=full 的保护效果：
┌─────────────────────────┐
│ 只读保护的目录：          │
│ /        ← 整个根目录    │
│ ├── usr/               │
│ ├── etc/               │
│ ├── opt/               │
│ └── boot/              │
└─────────────────────────┘
┌─────────────────────────┐
│ 仍可访问的特殊目录：      │
│ /proc/    ← 进程信息     │
│ /sys/     ← 系统信息     │
│ /dev/     ← 设备文件     │
└─────────────────────────┘
```

---

## 4. 🏠 用户目录访问控制


### 4.1 ProtectHome用户目录保护


**简单理解**：`ProtectHome`就像给用户的私人文件夹加密码锁，服务看不到用户的个人文件。

**保护选项**：
```
ProtectHome=false    # 不保护，能访问所有用户目录
ProtectHome=true     # 保护所有用户目录，完全访问不了
ProtectHome=read-only # 只读访问用户目录
ProtectHome=tmpfs    # 用空的临时目录替代用户目录
```

### 4.2 ProtectHome实际应用


```ini
[Unit]
Description=文件处理服务
After=network.target

[Service]
Type=simple
User=fileservice
Group=fileservice

# 🔸 用户目录保护配置
ProtectHome=true          # 完全保护用户目录

# 🔸 系统目录也一起保护
ProtectSystem=strict

# 🔸 只允许访问工作目录
ReadWritePaths=/var/lib/fileservice
ReadOnlyPaths=/etc/fileservice

ExecStart=/usr/bin/fileprocessor
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

### 4.3 ProtectHome保护效果


**保护前的风险**：
```
服务能看到的用户目录（危险）：
/home/
├── alice/
│   ├── documents/        ← 能看到用户文档
│   ├── .ssh/            ← 能看到SSH密钥  
│   └── .bashrc          ← 能看到配置文件
├── bob/
│   ├── photos/          ← 能看到用户照片
│   └── private/         ← 能看到私人文件
└── ...
```

**保护后的效果**：
```
ProtectHome=true 后：
/home/  ← 目录存在但是空的，看不到任何用户文件
├── (empty)
└── (empty)

ProtectHome=read-only 后：
/home/
├── alice/  ← 能看到但不能修改
├── bob/    ← 能看到但不能修改  
└── ...     ← 所有文件只读
```

---

## 5. 📁 路径访问权限设置


### 5.1 ReadOnlyPaths只读路径设置


**通俗理解**：`ReadOnlyPaths`就像把某些文件夹设为"展示柜"，服务只能看不能碰。

**基本语法**：
```ini
# 单个路径
ReadOnlyPaths=/etc/myapp/

# 多个路径（用空格分隔）
ReadOnlyPaths=/etc/myapp/ /usr/share/myapp/ /var/log/myapp/

# 使用通配符
ReadOnlyPaths=/etc/ssl/certs/
```

### 5.2 InaccessiblePaths不可访问路径


**简单理解**：`InaccessiblePaths`就像把某些文件夹"隐身"了，服务完全看不到这些路径。

```ini
[Unit]
Description=受限应用服务

[Service]
Type=simple
User=appuser
Group=appuser

# 🔸 完全禁止访问的路径
InaccessiblePaths=/home /root /etc/shadow /etc/gshadow

# 🔸 只读访问的路径  
ReadOnlyPaths=/etc/myapp/ /usr/share/myapp/

# 🔸 可读写的路径
ReadWritePaths=/var/lib/myapp/ /var/log/myapp/

ExecStart=/usr/bin/myapp
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

### 5.3 ReadWritePaths读写路径限制


**核心概念**：当使用`ProtectSystem=strict`时，整个文件系统变为只读，`ReadWritePaths`用来指定哪些路径仍然可写。

```ini
[Service]
# 🔸 严格保护模式
ProtectSystem=strict

# 🔸 指定可写路径（白名单）
ReadWritePaths=/var/lib/myservice/    # 数据目录可写
ReadWritePaths=/var/log/myservice/    # 日志目录可写  
ReadWritePaths=/run/myservice/        # 运行时文件可写

# 🔸 指定只读路径
ReadOnlyPaths=/etc/myservice/         # 配置文件只读

# 🔸 指定禁止访问路径
InaccessiblePaths=/home/ /root/       # 完全禁止访问
```

### 5.4 路径权限层次图


```
文件系统访问权限层次：
┌──────────────────────────────────┐
│ InaccessiblePaths（最高优先级）    │  ← 完全看不见
│ • /home/                        │
│ • /root/                        │
└──────────────────────────────────┘
            ↓ 覆盖关系
┌──────────────────────────────────┐
│ ReadWritePaths（中等优先级）       │  ← 可以读写
│ • /var/lib/myservice/           │
│ • /var/log/myservice/           │
└──────────────────────────────────┘
            ↓ 覆盖关系  
┌──────────────────────────────────┐
│ ReadOnlyPaths（低优先级）         │  ← 只能读取
│ • /etc/myservice/               │
│ • /usr/share/myservice/         │
└──────────────────────────────────┘
            ↓ 默认继承
┌──────────────────────────────────┐
│ ProtectSystem影响的其他路径       │  ← 根据设置决定
└──────────────────────────────────┘
```

---

## 6. 🔗 挂载绑定与命名空间


### 6.1 BindPaths挂载绑定


**通俗理解**：`BindPaths`就像给文件夹做"镜像"，在服务的视角里创建一个指向真实位置的"快捷方式"。

**基本概念**：
```
现实类比：
真实的文件在 /real/data/files/          （真实位置）
通过BindPaths，服务看到的是 /app/data/    （虚拟位置）
                    ↓
            实际指向同一个地方
```

### 6.2 BindPaths配置示例


```ini
[Unit]
Description=需要特殊路径映射的服务

[Service]
Type=simple
User=myservice
Group=myservice

# 🔸 可读写的路径绑定
BindPaths=/real/storage/data:/app/data
BindPaths=/var/lib/shared:/app/shared

# 🔸 只读的路径绑定  
BindReadOnlyPaths=/etc/ssl/certs:/app/certs
BindReadOnlyPaths=/usr/share/timezone:/app/timezone

# 🔸 严格保护模式
ProtectSystem=strict
ProtectHome=true

ExecStart=/usr/bin/myservice --config=/app/config
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

### 6.3 BindPaths工作原理


**绑定过程示意**：
```
服务启动前的文件系统：
/
├── real/
│   └── storage/
│       └── data/           ← 真实数据位置
│           ├── file1.txt
│           └── file2.txt
└── app/
    └── data/               ← 空目录

BindPaths=/real/storage/data:/app/data 执行后：
/
├── real/
│   └── storage/
│       └── data/           ← 真实位置
│           ├── file1.txt
│           └── file2.txt  
└── app/
    └── data/               ← 绑定后指向真实位置
        ├── file1.txt       ← 同一个文件
        └── file2.txt       ← 同一个文件

服务在/app/data/中的操作 = 在/real/storage/data/中的操作
```

### 6.4 文件系统命名空间隔离


**核心概念**：命名空间隔离让每个服务看到不同的文件系统"视图"。

```
全局文件系统视图：                服务A的命名空间视图：
/                                /
├── etc/                        ├── etc/          ← 只读
├── var/                        ├── var/          ← 部分可写
├── home/ ← 所有用户目录          ├── (hidden)      ← 看不到home
├── root/ ← 管理员目录            ├── (hidden)      ← 看不到root
├── tmp/  ← 共享临时目录          └── tmp/          ← 独立临时目录
└── ...                              ↑
                                服务看到的是隔离后的视图
```

**实际应用场景**：
```ini
# 🎯 Web服务的完整安全配置
[Unit]
Description=高安全Web应用
After=network.target

[Service]
Type=notify
User=webapp
Group=webapp

# 🔸 基础隔离
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true

# 🔸 路径权限设置
ReadWritePaths=/var/lib/webapp/
ReadWritePaths=/var/log/webapp/
ReadOnlyPaths=/etc/webapp/

# 🔸 路径绑定
BindReadOnlyPaths=/etc/ssl/certs:/app/ssl
BindPaths=/var/lib/webapp/uploads:/app/uploads

# 🔸 禁止访问敏感路径
InaccessiblePaths=/etc/shadow /etc/gshadow /root

ExecStart=/usr/bin/webapp --config=/etc/webapp/app.conf
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的基本概念


```
🔸 文件系统访问控制：给服务设置文件访问边界的安全机制
🔸 PrivateTmp：给每个服务独立的临时目录，互不干扰
🔸 ProtectSystem：保护系统重要目录不被服务破坏
🔸 ProtectHome：保护用户私人文件不被服务窥探
🔸 路径权限：细粒度控制服务能访问哪些文件夹
🔸 挂载绑定：创建文件路径的"快捷方式"映射
🔸 命名空间隔离：让服务看到独立的文件系统视图
```

### 7.2 关键理解要点


**🔹 安全分层原则**
```
从宽松到严格的保护层次：
无保护 → 基础保护 → 严格保护 → 完全隔离
   ↑         ↑         ↑         ↑
 默认状态   生产建议   高安全   容器化
```

**🔹 权限覆盖关系**
```
优先级：InaccessiblePaths > ReadWritePaths > ReadOnlyPaths > 默认权限
理解：高优先级的设置会覆盖低优先级的设置
```

**🔹 隔离与绑定的区别**
```
隔离（Protect*）：限制访问，提高安全性
绑定（Bind*）：重新映射，提高灵活性
两者结合使用效果最佳
```

### 7.3 实际应用指导


**✅ 推荐的安全配置套餐**

```ini
# 🏆 高安全性服务配置模板
[Service]
# 基础隔离三件套
PrivateTmp=true
ProtectSystem=strict  
ProtectHome=true

# 精确权限控制
ReadWritePaths=/var/lib/myservice/
ReadOnlyPaths=/etc/myservice/
InaccessiblePaths=/home/ /root/ /etc/shadow

# 路径映射优化
BindReadOnlyPaths=/etc/ssl/certs:/app/ssl
```

**🎯 不同场景的配置建议**

| **服务类型** | **ProtectSystem** | **ProtectHome** | **其他重点配置** |
|-------------|------------------|----------------|-----------------|
| **Web服务** | `strict` | `true` | `BindReadOnlyPaths SSL证书` |
| **数据库** | `full` | `true` | `ReadWritePaths数据目录` |
| **系统工具** | `false` | `false` | `根据具体需求细化` |
| **容器服务** | `strict` | `true` | `大量InaccessiblePaths` |

### 7.4 故障排查要点


**🔍 常见问题诊断**
```bash
# 查看服务的实际命名空间
sudo systemctl status myservice
sudo ls -la /proc/$(pidof myservice)/root/

# 检查路径权限设置
systemctl show myservice | grep -E "(Protect|ReadOnly|Bind|Inaccessible)"

# 测试服务文件访问
sudo -u myservice ls -la /some/path/
```

**⚠️ 配置注意事项**
```
1. 配置前先备份原始service文件
2. 逐步增加限制，不要一次配置过严
3. 测试服务功能是否正常
4. 查看日志确认没有权限错误
5. 生产环境应用前在测试环境验证
```

**核心记忆口诀**：
```
Private隔离各自用，Protect保护系统稳
ReadOnly只读ReadWrite写，Inaccessible看不见  
BindPaths映射更灵活，命名空间筑围墙
安全配置分层做，权限最小化原则
```