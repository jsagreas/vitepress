---
title: 8ã€å†…å­˜ä¿æŠ¤æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [å†…å­˜ä¿æŠ¤æœºåˆ¶æ¦‚è¿°](#1-å†…å­˜ä¿æŠ¤æœºåˆ¶æ¦‚è¿°)
2. [å†…å­˜æ‰§è¡Œä¿æŠ¤](#2-å†…å­˜æ‰§è¡Œä¿æŠ¤)
3. [å‘½åç©ºé—´é™åˆ¶](#3-å‘½åç©ºé—´é™åˆ¶)
4. [ä¸»æœºåä¸è®¾å¤‡ä¿æŠ¤](#4-ä¸»æœºåä¸è®¾å¤‡ä¿æŠ¤)
5. [è®¾å¤‡è®¿é—®ç­–ç•¥](#5-è®¾å¤‡è®¿é—®ç­–ç•¥)
6. [é«˜çº§å†…å­˜å®‰å…¨æœºåˆ¶](#6-é«˜çº§å†…å­˜å®‰å…¨æœºåˆ¶)
7. [ç»¼åˆé…ç½®å®è·µ](#7-ç»¼åˆé…ç½®å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ å†…å­˜ä¿æŠ¤æœºåˆ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å†…å­˜ä¿æŠ¤æœºåˆ¶


**é€šä¿—ç†è§£**ï¼š
å†…å­˜ä¿æŠ¤æœºåˆ¶å°±åƒç»™ç¨‹åºæˆ´ä¸Š"å®‰å…¨æ‰‹å¥—"ï¼Œé˜²æ­¢ç¨‹åºåšä¸€äº›å±é™©çš„å†…å­˜æ“ä½œã€‚å°±åƒæˆ‘ä»¬ä¸è®©å°å­©ç©åˆ€å…·ä¸€æ ·ï¼Œä¸è®©ç¨‹åºéšæ„ä¿®æ”¹å†…å­˜ä¸­çš„å¯æ‰§è¡Œä»£ç ã€‚

**æ ¸å¿ƒä½œç”¨**ï¼š
```
å†…å­˜ä¿æŠ¤çš„æœ¬è´¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    åº”ç”¨ç¨‹åºè¿›ç¨‹      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å†…å­˜ä¿æŠ¤å±éšœ       â”‚ â† é˜²æ­¢æ¶æ„æ“ä½œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ç³»ç»Ÿå†…å­˜ç©ºé—´      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¿æŠ¤ç›®æ ‡ï¼š
â€¢ é˜²æ­¢ä»£ç æ³¨å…¥æ”»å‡»
â€¢ é˜»æ­¢å†…å­˜ç¯¡æ”¹
â€¢ é™åˆ¶å±é™©ç³»ç»Ÿè°ƒç”¨
â€¢ éš”ç¦»è¿›ç¨‹èµ„æºè®¿é—®
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜ä¿æŠ¤


**ç°å®é—®é¢˜**ï¼š
- **ç¼“å†²åŒºæº¢å‡ºæ”»å‡»**ï¼šæ¶æ„ç¨‹åºå‘å†…å­˜å†™å…¥è¶…é•¿æ•°æ®ï¼Œè¦†ç›–å…¶ä»–å†…å­˜åŒºåŸŸ
- **ä»£ç æ³¨å…¥**ï¼šæ”»å‡»è€…å°†æ¶æ„ä»£ç æ³¨å…¥åˆ°ç¨‹åºçš„å†…å­˜ç©ºé—´ä¸­æ‰§è¡Œ
- **æƒé™æå‡**ï¼šæ™®é€šç¨‹åºè¯•å›¾è®¿é—®ç³»ç»Ÿçº§åˆ«çš„å†…å­˜èµ„æº

**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
æ²¡æœ‰ä¿æŠ¤çš„ç¨‹åº = æ²¡æœ‰å›´å¢™çš„æˆ¿å­
æœ‰å†…å­˜ä¿æŠ¤çš„ç¨‹åº = æœ‰å›´å¢™ã€é—¨ç¦ã€ç›‘æ§çš„æˆ¿å­

å›´å¢™ = å†…å­˜è¾¹ç•Œä¿æŠ¤
é—¨ç¦ = è®¿é—®æƒé™æ§åˆ¶  
ç›‘æ§ = è¡Œä¸ºç›‘æ§æœºåˆ¶
```

### 1.3 systemdå†…å­˜ä¿æŠ¤åˆ†ç±»


**ğŸ”¸ æ‰§è¡Œä¿æŠ¤**ï¼šé˜²æ­¢æ•°æ®åŒºåŸŸè¢«å½“ä½œä»£ç æ‰§è¡Œ
**ğŸ”¸ è®¿é—®éš”ç¦»**ï¼šé™åˆ¶è¿›ç¨‹è®¿é—®ç³»ç»Ÿèµ„æº
**ğŸ”¸ å‘½åç©ºé—´é™åˆ¶**ï¼šéš”ç¦»è¿›ç¨‹çš„ç³»ç»Ÿè§†å›¾
**ğŸ”¸ è®¾å¤‡æ§åˆ¶**ï¼šé™åˆ¶ç¡¬ä»¶è®¾å¤‡è®¿é—®æƒé™

---

## 2. âš¡ å†…å­˜æ‰§è¡Œä¿æŠ¤


### 2.1 MemoryDenyWriteExecuteè¯¦è§£


**åŸºæœ¬æ¦‚å¿µ**ï¼š
`MemoryDenyWriteExecute` æ˜¯ä¸€ä¸ªå¼€å…³ï¼Œå†³å®šè¿›ç¨‹èƒ½å¦åŒæ—¶å¯¹å†…å­˜åŒºåŸŸè¿›è¡Œ**å†™å…¥**å’Œ**æ‰§è¡Œ**æ“ä½œã€‚

**é€šä¿—è§£é‡Š**ï¼š
```
æ­£å¸¸æƒ…å†µï¼šå†…å­˜åˆ†ä¸ºä¸åŒåŒºåŸŸ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä»£ç åŒº     â”‚ â† åªèƒ½è¯»å–å’Œæ‰§è¡Œï¼Œä¸èƒ½å†™å…¥
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®åŒº     â”‚ â† åªèƒ½è¯»å–å’Œå†™å…¥ï¼Œä¸èƒ½æ‰§è¡Œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚   å †æ ˆåŒº     â”‚ â† åªèƒ½è¯»å–å’Œå†™å…¥ï¼Œä¸èƒ½æ‰§è¡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ”»å‡»æ‰‹æ®µï¼šå‘æ•°æ®åŒºå†™å…¥æ¶æ„ä»£ç ï¼Œç„¶åæ‰§è¡Œ
é˜²æŠ¤æœºåˆ¶ï¼šç¦æ­¢ä»»ä½•å†…å­˜åŒºåŸŸåŒæ—¶å…·æœ‰"å†™å…¥+æ‰§è¡Œ"æƒé™
```

### 2.2 é…ç½®æ–¹æ³•


**åŸºç¡€é…ç½®**ï¼š
```ini
[Service]
# å¯ç”¨å†…å­˜æ‰§è¡Œä¿æŠ¤
MemoryDenyWriteExecute=yes

# ç¤ºä¾‹æœåŠ¡é…ç½®
[Unit]
Description=Web Server with Memory Protection
After=network.target

[Service]
Type=simple
User=www-data
ExecStart=/usr/bin/nginx -g "daemon off;"
MemoryDenyWriteExecute=yes
Restart=always

[Install]
WantedBy=multi-user.target
```

### 2.3 å·¥ä½œåŸç†


**æŠ€æœ¯å®ç°**ï¼š
```
ç³»ç»Ÿè°ƒç”¨å±‚é¢çš„ä¿æŠ¤ï¼š
ç¨‹åºè¯·æ±‚å†…å­˜ â†’ å†…æ ¸æ£€æŸ¥æƒé™ â†’ å†³å®šæ˜¯å¦å…è®¸

mmap()ç³»ç»Ÿè°ƒç”¨çš„é™åˆ¶ï¼š
â€¢ PROT_WRITE | PROT_EXEC ç»„åˆè¢«ç¦æ­¢
â€¢ åªå…è®¸ PROT_READ | PROT_WRITE æˆ– PROT_READ | PROT_EXEC
â€¢ JITç¼–è¯‘å™¨ä¼šå—åˆ°å½±å“
```

**å®é™…æ•ˆæœéªŒè¯**ï¼š
```bash
# åˆ›å»ºæµ‹è¯•æœåŠ¡
sudo tee /etc/systemd/system/memory-test.service > /dev/null << 'EOF'
[Unit]
Description=Memory Protection Test

[Service]
Type=oneshot
ExecStart=/bin/bash -c 'echo "Testing memory protection"'
MemoryDenyWriteExecute=yes
EOF

# é‡è½½å¹¶è¿è¡Œ
sudo systemctl daemon-reload
sudo systemctl start memory-test.service
sudo systemctl status memory-test.service
```

### 2.4 å…¼å®¹æ€§æ³¨æ„äº‹é¡¹


**âš ï¸ å¯èƒ½å½±å“çš„ç¨‹åº**ï¼š
- **JITç¼–è¯‘å™¨**ï¼šå¦‚Javaè™šæ‹Ÿæœºã€JavaScriptå¼•æ“
- **åŠ¨æ€ä»£ç ç”Ÿæˆ**ï¼šæŸäº›æ•°æ®åº“ã€è§£é‡Šå™¨
- **è‡ªä¿®æ”¹ä»£ç **ï¼šä¸€äº›ä¼˜åŒ–ç¼–è¯‘å™¨äº§ç”Ÿçš„ä»£ç 

**è§£å†³æ–¹æ¡ˆ**ï¼š
```ini
# å¯¹äºéœ€è¦JITçš„æœåŠ¡ï¼Œå¯ä»¥å…³é—­æ­¤ä¿æŠ¤
[Service]
MemoryDenyWriteExecute=no

# æˆ–è€…ä½¿ç”¨æ›´ç²¾ç»†çš„æ§åˆ¶ï¼ˆè¾ƒæ–°ç‰ˆæœ¬systemdï¼‰
SystemCallFilter=@system-service
SystemCallFilter=~@privileged @resources
```

---

## 3. ğŸ”’ å‘½åç©ºé—´é™åˆ¶


### 3.1 RestrictNamespacesæ¦‚å¿µ


**ä»€ä¹ˆæ˜¯å‘½åç©ºé—´**ï¼š
å‘½åç©ºé—´å°±åƒç»™æ¯ä¸ªè¿›ç¨‹åˆ›å»ºä¸€ä¸ª"è™šæ‹Ÿä¸–ç•Œ"ï¼Œè®©å®ƒä»¥ä¸ºè‡ªå·±çœ‹åˆ°çš„å°±æ˜¯æ•´ä¸ªç³»ç»Ÿï¼Œå®é™…ä¸Šåªæ˜¯ç³»ç»Ÿçš„ä¸€ä¸ªéš”ç¦»è§†å›¾ã€‚

**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
ç‰©ç†ä¸–ç•Œ vs è™šæ‹Ÿä¸–ç•Œï¼š
çœŸå®ä¸–ç•Œï¼šæ‰€æœ‰äººçœ‹åˆ°ç›¸åŒçš„è¡—é“ã€å•†åº—
è™šæ‹Ÿä¸–ç•Œï¼šæ¯ä¸ªäººæœ‰è‡ªå·±çš„"å¹³è¡Œç©ºé—´"

ç³»ç»Ÿå‘½åç©ºé—´ï¼š
çœŸå®ç³»ç»Ÿï¼šæ‰€æœ‰è¿›ç¨‹å…±äº«ç›¸åŒçš„PIDã€ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿ
éš”ç¦»å‘½åç©ºé—´ï¼šæ¯ä¸ªè¿›ç¨‹ç»„æœ‰ç‹¬ç«‹çš„PIDç©ºé—´ã€ç½‘ç»œè§†å›¾
```

### 3.2 å‘½åç©ºé—´ç±»å‹


**Linuxæ”¯æŒçš„å‘½åç©ºé—´**ï¼š
```
ç½‘ç»œå‘½åç©ºé—´ (net)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿›ç¨‹Aç½‘ç»œè§†å›¾â”‚  â”‚ è¿›ç¨‹Bç½‘ç»œè§†å›¾â”‚
â”‚ eth0: 1.1.1.1â”‚  â”‚ eth0: 2.2.2.2â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PIDå‘½åç©ºé—´ (pid)ï¼š
è¿›ç¨‹Açœ‹åˆ°çš„PID: 1, 2, 3, 4...
è¿›ç¨‹Bçœ‹åˆ°çš„PID: 1, 2, 3, 4...  (å®é™…ä¸åŒ)

æ–‡ä»¶ç³»ç»Ÿå‘½åç©ºé—´ (mnt)ï¼š
è¿›ç¨‹Açœ‹åˆ°: /usr, /var, /tmp
è¿›ç¨‹Bçœ‹åˆ°: /app, /data     (å—é™è§†å›¾)
```

### 3.3 RestrictNamespacesé…ç½®


**åŸºç¡€é…ç½®è¯­æ³•**ï¼š
```ini
[Service]
# å®Œå…¨ç¦ç”¨æ‰€æœ‰å‘½åç©ºé—´
RestrictNamespaces=yes

# åªå…è®¸ç‰¹å®šå‘½åç©ºé—´
RestrictNamespaces=~net pid

# ç¦ç”¨ç‰¹å®šå‘½åç©ºé—´
RestrictNamespaces=~user mnt
```

**è¯¦ç»†é…ç½®ç¤ºä¾‹**ï¼š
```ini
[Unit]
Description=Secure Web Service
After=network.target

[Service]
Type=simple
User=webapp
Group=webapp
ExecStart=/usr/bin/webapp-server

# å®‰å…¨é…ç½®
RestrictNamespaces=yes          # ç¦ç”¨æ‰€æœ‰å‘½åç©ºé—´åˆ›å»º
MemoryDenyWriteExecute=yes      # å†…å­˜æ‰§è¡Œä¿æŠ¤
PrivateDevices=yes              # ç§æœ‰è®¾å¤‡ç©ºé—´
ProtectHome=yes                 # ä¿æŠ¤å®¶ç›®å½•

[Install]
WantedBy=multi-user.target
```

### 3.4 å®‰å…¨å½±å“åˆ†æ


**æ”»å‡»é˜²æŠ¤**ï¼š
```
å®¹å™¨é€ƒé€¸æ”»å‡»é˜²æŠ¤ï¼š
æ”»å‡»è€…è¯•å›¾ï¼šåˆ›å»ºæ–°çš„æŒ‚è½½å‘½åç©ºé—´ â†’ è®¿é—®å®¿ä¸»æ–‡ä»¶ç³»ç»Ÿ
RestrictNamespacesé˜»æ­¢ï¼šç¦æ­¢åˆ›å»ºæ–°å‘½åç©ºé—´ â†’ æ”»å‡»å¤±è´¥

æƒé™æå‡é˜²æŠ¤ï¼š
æ”»å‡»è€…è¯•å›¾ï¼šåˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ â†’ è·å¾—rootæƒé™æ˜ å°„
RestrictNamespacesé˜»æ­¢ï¼šç¦æ­¢ç”¨æˆ·å‘½åç©ºé—´ â†’ æƒé™å—é™
```

---

## 4. ğŸ  ä¸»æœºåä¸è®¾å¤‡ä¿æŠ¤


### 4.1 ProtectHostnameä¸»æœºåä¿æŠ¤


**åŸºæœ¬æ¦‚å¿µ**ï¼š
`ProtectHostname=yes` é˜»æ­¢è¿›ç¨‹ä¿®æ”¹ç³»ç»Ÿä¸»æœºåï¼Œç»´æŠ¤ç³»ç»Ÿèº«ä»½çš„ç¨³å®šæ€§ã€‚

**ä¸ºä»€ä¹ˆé‡è¦**ï¼š
```
ä¸»æœºåçš„ä½œç”¨ï¼š
â€¢ ç½‘ç»œèº«ä»½è¯†åˆ«
â€¢ æ—¥å¿—è®°å½•æ ‡è¯†  
â€¢ é›†ç¾¤èŠ‚ç‚¹è¯†åˆ«
â€¢ è®¸å¯è¯ç»‘å®š

æ¶æ„ä¿®æ”¹åæœï¼š
â€¢ ç½‘ç»œæœåŠ¡è¯†åˆ«æ··ä¹±
â€¢ æ—¥å¿—è¿½è¸ªå›°éš¾
â€¢ é›†ç¾¤ç®¡ç†é—®é¢˜
â€¢ å®‰å…¨å®¡è®¡å¤±æ•ˆ
```

**é…ç½®ç¤ºä¾‹**ï¼š
```ini
[Service]
# ä¿æŠ¤ä¸»æœºåä¸è¢«ä¿®æ”¹
ProtectHostname=yes

# å®Œæ•´çš„WebæœåŠ¡ä¿æŠ¤é…ç½®
[Unit]
Description=Protected Web Server
After=network.target

[Service]
Type=simple
User=www-data
ExecStart=/usr/sbin/apache2 -DFOREGROUND
ProtectHostname=yes
PrivateDevices=yes
ProtectHome=yes
Restart=always

[Install]
WantedBy=multi-user.target
```

### 4.2 PrivateDevicesè®¾å¤‡éš”ç¦»


**è®¾å¤‡éš”ç¦»åŸç†**ï¼š
```
æ­£å¸¸æƒ…å†µï¼šæ‰€æœ‰è¿›ç¨‹å¯è®¿é—® /dev ä¸‹æ‰€æœ‰è®¾å¤‡
éš”ç¦»æƒ…å†µï¼šè¿›ç¨‹åªèƒ½çœ‹åˆ°ç²¾ç®€çš„è®¾å¤‡åˆ—è¡¨

æ ‡å‡†/devç›®å½•ï¼š          éš”ç¦»åçš„/devï¼š
/dev/sda1 (ç¡¬ç›˜)       /dev/null
/dev/random           /dev/zero  
/dev/tty*             /dev/random
/dev/audio            /dev/urandom
/dev/video*           /dev/tty
... (æ•°ç™¾ä¸ªè®¾å¤‡)       ... (åªæœ‰åŸºæœ¬è®¾å¤‡)
```

**å®‰å…¨ä»·å€¼**ï¼š
- **é˜²æ­¢æ•°æ®ç›—å–**ï¼šæ— æ³•ç›´æ¥è¯»å–ç¡¬ç›˜è®¾å¤‡
- **é˜²æ­¢ç¡¬ä»¶æ”»å‡»**ï¼šæ— æ³•è®¿é—®æ‘„åƒå¤´ã€éº¦å…‹é£ç­‰
- **å‡å°‘æ”»å‡»é¢**ï¼šå¤§å¹…å‡å°‘å¯åˆ©ç”¨çš„è®¾å¤‡èŠ‚ç‚¹

**é…ç½®å’ŒéªŒè¯**ï¼š
```ini
[Service]
PrivateDevices=yes

# éªŒè¯è®¾å¤‡éš”ç¦»æ•ˆæœ
ExecStart=/bin/bash -c 'ls -la /dev/ | wc -l'
```

```bash
# æµ‹è¯•è®¾å¤‡éš”ç¦»
sudo systemctl cat your-service.service
sudo systemctl start your-service.service

# åœ¨éš”ç¦»çš„æœåŠ¡ä¸­ï¼Œ/devç›®å½•åªæœ‰å°‘æ•°å‡ ä¸ªè®¾å¤‡
# æ­£å¸¸ç³»ç»Ÿ: ls /dev | wc -l  # å¯èƒ½æ˜¾ç¤º200+
# éš”ç¦»ç¯å¢ƒ: ls /dev | wc -l  # å¯èƒ½åªæ˜¾ç¤º10-20ä¸ª
```

---

## 5. ğŸ›ï¸ è®¾å¤‡è®¿é—®ç­–ç•¥


### 5.1 DevicePolicyè®¾å¤‡ç­–ç•¥åŸºç¡€


**è®¾å¤‡ç­–ç•¥ç±»å‹**ï¼š
```
strict (ä¸¥æ ¼æ¨¡å¼)ï¼š
â€¢ é»˜è®¤æ‹’ç»æ‰€æœ‰è®¾å¤‡è®¿é—®
â€¢ åªå…è®¸æ˜ç¡®æˆæƒçš„è®¾å¤‡
â€¢ é€‚ç”¨äºé«˜å®‰å…¨è¦æ±‚çš„æœåŠ¡

closed (å°é—­æ¨¡å¼)ï¼š  
â€¢ æ‹’ç»æ‰€æœ‰è®¾å¤‡è®¿é—®
â€¢ ä¸å…è®¸ä»»ä½•DeviceAllowä¾‹å¤–
â€¢ é€‚ç”¨äºå®Œå…¨ä¸éœ€è¦è®¾å¤‡è®¿é—®çš„æœåŠ¡

auto (è‡ªåŠ¨æ¨¡å¼)ï¼š
â€¢ æ ¹æ®å…¶ä»–é…ç½®è‡ªåŠ¨å†³å®š
â€¢ å¦‚æœæœ‰DeviceAllowåˆ™ä¸ºstrict
â€¢ å¦‚æœæ²¡æœ‰åˆ™ä¸ºé»˜è®¤è¡Œä¸º
```

### 5.2 DeviceAllowç²¾ç¡®æ§åˆ¶


**è¯­æ³•æ ¼å¼**ï¼š
```ini
DeviceAllow=è®¾å¤‡è·¯å¾„ æƒé™

æƒé™ç±»å‹ï¼š
r = è¯»å– (read)
w = å†™å…¥ (write)  
m = åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ (mknod)
```

**å®ç”¨é…ç½®ç¤ºä¾‹**ï¼š
```ini
[Unit]
Description=Log Processing Service
After=network.target

[Service]
Type=simple
User=logger
ExecStart=/usr/bin/log-processor

# ä¸¥æ ¼çš„è®¾å¤‡è®¿é—®æ§åˆ¶
DevicePolicy=strict

# åªå…è®¸è®¿é—®å¿…éœ€çš„è®¾å¤‡
DeviceAllow=/dev/null rw          # å…è®¸è¯»å†™nullè®¾å¤‡
DeviceAllow=/dev/zero r           # å…è®¸è¯»å–zeroè®¾å¤‡
DeviceAllow=/dev/urandom r        # å…è®¸è¯»å–éšæœºæ•°è®¾å¤‡
DeviceAllow=/dev/log w            # å…è®¸å†™å…¥ç³»ç»Ÿæ—¥å¿—socket

# å¦‚æœéœ€è¦è®¿é—®ç‰¹å®šç£ç›˜ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
# DeviceAllow=/dev/sdb1 r         # åªè¯»è®¿é—®ç‰¹å®šåˆ†åŒº

[Install]
WantedBy=multi-user.target
```

### 5.3 å¸¸è§è®¾å¤‡è®¿é—®æ¨¡å¼


**WebæœåŠ¡å™¨è®¾å¤‡é…ç½®**ï¼š
```ini
[Service]
# WebæœåŠ¡å™¨é€šå¸¸åªéœ€è¦åŸºæœ¬è®¾å¤‡
DevicePolicy=strict
DeviceAllow=/dev/null rw
DeviceAllow=/dev/zero r
DeviceAllow=/dev/urandom r
```

**æ•°æ®åº“æœåŠ¡è®¾å¤‡é…ç½®**ï¼š
```ini
[Service]
# æ•°æ®åº“å¯èƒ½éœ€è¦è®¿é—®ç‰¹å®šå­˜å‚¨è®¾å¤‡
DevicePolicy=strict
DeviceAllow=/dev/null rw
DeviceAllow=/dev/zero r  
DeviceAllow=/dev/urandom r
# å¦‚æœæ•°æ®åº“ç›´æ¥ç®¡ç†è£¸è®¾å¤‡
DeviceAllow=/dev/database-lv rw   # LVMé€»è¾‘å·
```

**å®¹å™¨è¿è¡Œæ—¶è®¾å¤‡é…ç½®**ï¼š
```ini
[Service]
# å®¹å™¨è¿è¡Œæ—¶éœ€è¦æ›´å¤šè®¾å¤‡è®¿é—®æƒé™
DevicePolicy=strict
DeviceAllow=/dev/null rw
DeviceAllow=/dev/zero rw
DeviceAllow=/dev/random r
DeviceAllow=/dev/urandom r
DeviceAllow=/dev/tty rw
DeviceAllow=/dev/pts/* rw         # ä¼ªç»ˆç«¯è®¾å¤‡
DeviceAllow=char-* m              # å…è®¸åˆ›å»ºå­—ç¬¦è®¾å¤‡
```

---

## 6. ğŸ§  é«˜çº§å†…å­˜å®‰å…¨æœºåˆ¶


### 6.1 å†…å­˜å¸ƒå±€éšæœºåŒ–æ”¯æŒ


**ASLRåœ°å€ç©ºé—´éšæœºåŒ–**ï¼š
```
ä¼ ç»Ÿå†…å­˜å¸ƒå±€ (å›ºå®šåœ°å€)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ ˆåŒº: 0xBFFFFFFF â”‚ â† æ”»å‡»è€…å¯é¢„æµ‹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å †åŒº: 0x08048000 â”‚ â† åœ°å€å›ºå®š
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»£ç : 0x40000000 â”‚ â† å®¹æ˜“åˆ©ç”¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ASLRéšæœºåŒ–å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ ˆåŒº: 0x???????? â”‚ â† éšæœºåœ°å€
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ å †åŒº: 0x???????? â”‚ â† æ— æ³•é¢„æµ‹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»£ç : 0x???????? â”‚ â† æ”»å‡»å›°éš¾
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**systemdä¸­çš„ASLRé…ç½®**ï¼š
```ini
[Service]
# æ”¯æŒå†…å­˜å¸ƒå±€éšæœºåŒ–ï¼ˆé€šå¸¸é»˜è®¤å¯ç”¨ï¼‰
# systemdä¼šä¿æŒç³»ç»ŸASLRè®¾ç½®

# æ£€æŸ¥ç³»ç»ŸASLRçŠ¶æ€
# cat /proc/sys/kernel/randomize_va_space
# 0 = ç¦ç”¨, 1 = éƒ¨åˆ†éšæœºåŒ–, 2 = å®Œå…¨éšæœºåŒ–

# ç¡®ä¿ä¸ç¦ç”¨ASLR
Environment="ADDR_NO_RANDOMIZE=0"
```

### 6.2 æ ˆä¿æŠ¤æœºåˆ¶é…ç½®


**æ ˆä¿æŠ¤åŸç†**ï¼š
```
æ ˆæº¢å‡ºæ”»å‡»è¿‡ç¨‹ï¼š
æ­£å¸¸å‡½æ•°è°ƒç”¨æ ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å±€éƒ¨å˜é‡    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä¿å­˜çš„å¯„å­˜å™¨ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   è¿”å›åœ°å€    â”‚ â† æ”»å‡»ç›®æ ‡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ï¼š
é•¿æ•°æ®è¦†ç›–æ ˆ â†’ ä¿®æ”¹è¿”å›åœ°å€ â†’ è·³è½¬åˆ°æ¶æ„ä»£ç 

æ ˆä¿æŠ¤æœºåˆ¶ï¼š
åœ¨è¿”å›åœ°å€å‰æ’å…¥"å“¨å…µå€¼" â†’ å‡½æ•°è¿”å›å‰æ£€æŸ¥ â†’ å‘ç°ç¯¡æ”¹ç«‹å³ç»ˆæ­¢
```

**ç¼–è¯‘å™¨æ ˆä¿æŠ¤é€‰é¡¹**ï¼š
```bash
# ç¼–è¯‘æ—¶å¯ç”¨æ ˆä¿æŠ¤
gcc -fstack-protector-strong program.c

# åœ¨systemdæœåŠ¡ä¸­ç¡®ä¿ä½¿ç”¨ä¿æŠ¤ç‰ˆæœ¬
[Service]
# ä½¿ç”¨å¸¦æ ˆä¿æŠ¤çš„äºŒè¿›åˆ¶æ–‡ä»¶
ExecStart=/usr/bin/protected-program

# ç¯å¢ƒå˜é‡ç¡®ä¿æ ˆä¿æŠ¤å¯ç”¨
Environment="FORTIFY_SOURCE=2"
```

### 6.3 å†…å­˜æ³„æ¼é˜²æŠ¤ç­–ç•¥


**å†…å­˜é™åˆ¶é…ç½®**ï¼š
```ini
[Service]
# é™åˆ¶å†…å­˜ä½¿ç”¨é‡ï¼Œé˜²æ­¢å†…å­˜è€—å°½æ”»å‡»
MemoryMax=512M                    # æœ€å¤§å†…å­˜é™åˆ¶
MemoryHigh=400M                   # é«˜æ°´ä½è­¦å‘Š  
MemorySwapMax=0                   # ç¦ç”¨swapé˜²æ­¢æ³„å¯†

# ç»“åˆå…¶ä»–ä¿æŠ¤æœºåˆ¶
MemoryDenyWriteExecute=yes        # é˜²ä»£ç æ³¨å…¥
PrivateDevices=yes                # è®¾å¤‡éš”ç¦»
```

**å†…å­˜ç›‘æ§å’Œå‘Šè­¦**ï¼š
```bash
# ç›‘æ§æœåŠ¡å†…å­˜ä½¿ç”¨
systemctl show your-service.service -p MemoryCurrent
systemctl show your-service.service -p MemoryPeak

# è®¾ç½®å†…å­˜ç›‘æ§è„šæœ¬
tee /usr/local/bin/memory-monitor.sh > /dev/null << 'EOF'
#!/bin/bash
SERVICE=$1
THRESHOLD_MB=400

CURRENT=$(systemctl show $SERVICE -p MemoryCurrent --value)
CURRENT_MB=$((CURRENT / 1024 / 1024))

if [ $CURRENT_MB -gt $THRESHOLD_MB ]; then
    logger "WARNING: $SERVICE using ${CURRENT_MB}MB memory (threshold: ${THRESHOLD_MB}MB)"
fi
EOF

chmod +x /usr/local/bin/memory-monitor.sh
```

---

## 7. ğŸ› ï¸ ç»¼åˆé…ç½®å®è·µ


### 7.1 é«˜å®‰å…¨WebæœåŠ¡é…ç½®


```ini
# /etc/systemd/system/secure-webapp.service
[Unit]
Description=Secure Web Application
Documentation=https://example.com/docs
After=network.target
Wants=network.target

[Service]
Type=simple
User=webapp
Group=webapp
WorkingDirectory=/opt/webapp

# åŸºæœ¬æ‰§è¡Œé…ç½®
ExecStart=/opt/webapp/bin/server
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=10

# === å†…å­˜ä¿æŠ¤æœºåˆ¶ ===
MemoryDenyWriteExecute=yes        # ç¦æ­¢å†™å…¥+æ‰§è¡Œå†…å­˜
MemoryMax=1G                      # å†…å­˜ä½¿ç”¨ä¸Šé™
MemoryHigh=800M                   # é«˜æ°´ä½å‘Šè­¦

# === å‘½åç©ºé—´é™åˆ¶ ===  
RestrictNamespaces=yes            # ç¦ç”¨æ‰€æœ‰å‘½åç©ºé—´
ProtectHostname=yes               # ä¿æŠ¤ä¸»æœºå

# === è®¾å¤‡è®¿é—®æ§åˆ¶ ===
PrivateDevices=yes                # ç§æœ‰è®¾å¤‡ç©ºé—´
DevicePolicy=strict               # ä¸¥æ ¼è®¾å¤‡ç­–ç•¥
DeviceAllow=/dev/null rw          # å…è®¸åŸºæœ¬è®¾å¤‡
DeviceAllow=/dev/zero r
DeviceAllow=/dev/urandom r

# === æ–‡ä»¶ç³»ç»Ÿä¿æŠ¤ ===
ProtectSystem=strict              # åªè¯»ç³»ç»Ÿç›®å½•
ProtectHome=yes                   # éš”ç¦»å®¶ç›®å½•
PrivateTmp=yes                    # ç§æœ‰ä¸´æ—¶ç›®å½•

# === ç½‘ç»œå®‰å…¨ ===
PrivateNetwork=no                 # WebæœåŠ¡éœ€è¦ç½‘ç»œ
RestrictAddressFamilies=AF_INET AF_INET6

# === ç³»ç»Ÿè°ƒç”¨é™åˆ¶ ===
SystemCallFilter=@system-service  # å…è®¸ç³»ç»ŸæœåŠ¡è°ƒç”¨
SystemCallFilter=~@privileged @resources @mount

[Install]
WantedBy=multi-user.target
```

### 7.2 æ•°æ®åº“æœåŠ¡å®‰å…¨é…ç½®


```ini
# /etc/systemd/system/secure-database.service  
[Unit]
Description=Secure Database Service
After=network.target
Requires=network.target

[Service]
Type=notify
User=dbuser
Group=dbgroup
WorkingDirectory=/var/lib/database

ExecStart=/usr/bin/database-server --config=/etc/db/config.conf
ExecReload=/bin/kill -HUP $MAINPID

# === å†…å­˜ä¿æŠ¤ ===
MemoryDenyWriteExecute=yes        # æ•°æ®åº“é€šå¸¸ä¸éœ€è¦JIT
MemoryMax=4G                      # æ•°æ®åº“éœ€è¦æ›´å¤šå†…å­˜
MemoryHigh=3G

# === ç³»ç»Ÿéš”ç¦» ===
RestrictNamespaces=yes
ProtectHostname=yes
PrivateDevices=yes

# === è®¾å¤‡è®¿é—®ï¼ˆæ•°æ®åº“ç‰¹æ®Šéœ€æ±‚ï¼‰===
DevicePolicy=strict
DeviceAllow=/dev/null rw
DeviceAllow=/dev/zero r
DeviceAllow=/dev/urandom r
# å¦‚æœæ•°æ®åº“ä½¿ç”¨è£¸è®¾å¤‡æˆ–ç‰¹å®šå­˜å‚¨
DeviceAllow=/dev/mapper/db-data rw

# === æ–‡ä»¶ç³»ç»Ÿæƒé™ ===
ProtectSystem=strict
ReadWritePaths=/var/lib/database  # æ•°æ®åº“æ•°æ®ç›®å½•
ReadWritePaths=/var/log/database  # æ—¥å¿—ç›®å½•
ProtectHome=yes

# === ç½‘ç»œé™åˆ¶ ===  
RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX

[Install]
WantedBy=multi-user.target
```

### 7.3 é…ç½®éªŒè¯å’Œæµ‹è¯•


**éªŒè¯å†…å­˜ä¿æŠ¤**ï¼š
```bash
# æ£€æŸ¥æœåŠ¡é…ç½®
sudo systemctl show secure-webapp.service -p MemoryDenyWriteExecute
sudo systemctl show secure-webapp.service -p MemoryCurrent

# æµ‹è¯•å†…å­˜é™åˆ¶
sudo systemctl start secure-webapp.service
sudo systemctl status secure-webapp.service

# ç›‘æ§å†…å­˜ä½¿ç”¨
watch -n 1 'systemctl show secure-webapp.service -p MemoryCurrent --value'
```

**éªŒè¯è®¾å¤‡éš”ç¦»**ï¼š
```bash
# è¿›å…¥æœåŠ¡çš„å‘½åç©ºé—´æŸ¥çœ‹è®¾å¤‡
sudo systemd-run --property="PrivateDevices=yes" --shell
ls -la /dev/  # åº”è¯¥åªçœ‹åˆ°å°‘æ•°è®¾å¤‡

# å¯¹æ¯”æ­£å¸¸ç¯å¢ƒ
ls -la /dev/ | wc -l  # æ­£å¸¸ç¯å¢ƒè®¾å¤‡æ•°é‡
```

**éªŒè¯ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤**ï¼š
```bash
# æŸ¥çœ‹æœåŠ¡å…è®¸çš„ç³»ç»Ÿè°ƒç”¨
sudo systemctl show secure-webapp.service -p SystemCallFilter

# æµ‹è¯•è¢«ç¦æ­¢çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
sudo systemd-run --property="SystemCallFilter=~@mount" \
  --shell -c 'mount -t tmpfs tmpfs /tmp/test'
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ MemoryDenyWriteExecuteï¼šé˜²æ­¢ä»£ç æ³¨å…¥çš„æ ¸å¿ƒæœºåˆ¶
ğŸ”¸ RestrictNamespacesï¼šé™åˆ¶è¿›ç¨‹åˆ›å»ºéš”ç¦»ç¯å¢ƒ  
ğŸ”¸ ProtectHostnameï¼šç»´æŠ¤ç³»ç»Ÿèº«ä»½ç¨³å®šæ€§
ğŸ”¸ PrivateDevicesï¼šè®¾å¤‡è®¿é—®éš”ç¦»ä¿æŠ¤
ğŸ”¸ DevicePolicy/DeviceAllowï¼šç²¾ç¡®çš„è®¾å¤‡è®¿é—®æ§åˆ¶
ğŸ”¸ å†…å­˜é™åˆ¶ï¼šé˜²æ­¢èµ„æºè€—å°½æ”»å‡»
ğŸ”¸ ASLRæ”¯æŒï¼šå†…å­˜å¸ƒå±€éšæœºåŒ–å¢å¼ºå®‰å…¨æ€§
```

### 8.2 å…³é”®é…ç½®åŸåˆ™


**ğŸ”¹ å®‰å…¨ä¼˜å…ˆé…ç½®æ€è·¯**ï¼š
```
1. æœ€å°æƒé™åŸåˆ™ï¼šåªç»™æœåŠ¡æœ€å¿…è¦çš„æƒé™
2. æ·±åº¦é˜²å¾¡ï¼šå¤šå±‚å®‰å…¨æœºåˆ¶ç»„åˆä½¿ç”¨  
3. é»˜è®¤æ‹’ç»ï¼šé™¤éæ˜ç¡®å…è®¸ï¼Œå¦åˆ™æ‹’ç»è®¿é—®
4. æŒç»­ç›‘æ§ï¼šé…ç½®ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
```

**ğŸ”¹ å…¼å®¹æ€§è€ƒè™‘**ï¼š
```
JITåº”ç”¨ï¼šJavaã€Node.jsç­‰éœ€è¦å…³é—­MemoryDenyWriteExecute
å®¹å™¨åº”ç”¨ï¼šéœ€è¦æ›´å®½æ¾çš„è®¾å¤‡å’Œå‘½åç©ºé—´ç­–ç•¥
æ•°æ®åº“ï¼šå¯èƒ½éœ€è¦è®¿é—®ç‰¹å®šå­˜å‚¨è®¾å¤‡
WebæœåŠ¡å™¨ï¼šé€šå¸¸å¯ä»¥ä½¿ç”¨æœ€ä¸¥æ ¼çš„å®‰å…¨é…ç½®
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ é…ç½®æ£€æŸ¥æ¸…å•**ï¼š
- [ ] ç¡®è®¤æœåŠ¡æ˜¯å¦éœ€è¦JITåŠŸèƒ½
- [ ] è¯†åˆ«æœåŠ¡å¿…éœ€çš„è®¾å¤‡è®¿é—®
- [ ] æµ‹è¯•å†…å­˜é™åˆ¶æ˜¯å¦åˆç†
- [ ] éªŒè¯å‘½åç©ºé—´é™åˆ¶å…¼å®¹æ€§
- [ ] é…ç½®ç›‘æ§å’Œå‘Šè­¦é˜ˆå€¼

**âš ï¸ å¸¸è§é—®é¢˜å¤„ç†**ï¼š
- **æœåŠ¡å¯åŠ¨å¤±è´¥**ï¼šæ£€æŸ¥è®¾å¤‡è®¿é—®æƒé™å’Œå†…å­˜é™åˆ¶
- **åŠŸèƒ½å¼‚å¸¸**ï¼šç¡®è®¤æ˜¯å¦è¯¯ç¦äº†å¿…è¦çš„ç³»ç»Ÿè°ƒç”¨
- **æ€§èƒ½ä¸‹é™**ï¼šè°ƒæ•´å†…å­˜é™åˆ¶å’Œä¿æŠ¤æœºåˆ¶å¼ºåº¦
- **å…¼å®¹æ€§é—®é¢˜**ï¼šé’ˆå¯¹ç‰¹å®šåº”ç”¨è°ƒæ•´é…ç½®

**ğŸ¯ æœ€ä½³å®è·µè¦ç‚¹**ï¼š
```
1. ä»å®½æ¾é…ç½®å¼€å§‹ï¼Œé€æ­¥æ”¶ç´§å®‰å…¨ç­–ç•¥
2. å……åˆ†æµ‹è¯•æ‰€æœ‰åŠŸèƒ½åœºæ™¯
3. å»ºç«‹é…ç½®å˜æ›´çš„å›æ»šæœºåˆ¶  
4. å®šæœŸå®¡æ ¸å’Œæ›´æ–°å®‰å…¨é…ç½®
5. ç›‘æ§å®‰å…¨äº‹ä»¶å’Œå¼‚å¸¸è¡Œä¸º
```

### 8.4 è®°å¿†è¦ç‚¹


> ğŸ’¡ **æ ¸å¿ƒè®°å¿†å£è¯€**  
> "å†…å­˜æ‰§è¡Œè¦åˆ†ç¦»ï¼Œå‘½åç©ºé—´éœ€é™åˆ¶"  
> "è®¾å¤‡è®¿é—®ä¸¥æ§åˆ¶ï¼Œä¸»æœºèº«ä»½è¦ä¿æŠ¤"  
> "æœ€å°æƒé™æ·±é˜²å¾¡ï¼ŒæŒç»­ç›‘æ§ä¿å®‰å…¨"

**ğŸ”‘ å…³é”®é…ç½®å‚æ•°é€Ÿè®°**ï¼š
- `MemoryDenyWriteExecute=yes` â†’ é˜²ä»£ç æ³¨å…¥
- `RestrictNamespaces=yes` â†’ é™åˆ¶ç³»ç»Ÿéš”ç¦»
- `PrivateDevices=yes` â†’ è®¾å¤‡è®¿é—®éš”ç¦»
- `DevicePolicy=strict` â†’ ä¸¥æ ¼è®¾å¤‡ç­–ç•¥
- `ProtectHostname=yes` â†’ ä¿æŠ¤ç³»ç»Ÿèº«ä»½