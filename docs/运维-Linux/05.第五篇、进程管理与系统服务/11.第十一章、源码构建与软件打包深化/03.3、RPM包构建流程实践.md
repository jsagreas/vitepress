---
title: 3ã€RPMåŒ…æ„å»ºæµç¨‹å®è·µ
---
## ğŸ“š ç›®å½•

1. [RPMåŒ…æ„å»ºåŸºç¡€æ¦‚å¿µ](#1-RPMåŒ…æ„å»ºåŸºç¡€æ¦‚å¿µ)
2. [rpmbuildå‘½ä»¤è¯¦è§£](#2-rpmbuildå‘½ä»¤è¯¦è§£)
3. [å®Œæ•´æ„å»ºæµç¨‹å®æˆ˜](#3-å®Œæ•´æ„å»ºæµç¨‹å®æˆ˜)
4. [æ„å»ºè¿‡ç¨‹è°ƒè¯•ä¸æ’é”™](#4-æ„å»ºè¿‡ç¨‹è°ƒè¯•ä¸æ’é”™)
5. [å¤šåŒ…æ„å»ºä¸å­åŒ…ç®¡ç†](#5-å¤šåŒ…æ„å»ºä¸å­åŒ…ç®¡ç†)
6. [æ¡ä»¶æ„å»ºä¸å¹³å°é€‚é…](#6-æ¡ä»¶æ„å»ºä¸å¹³å°é€‚é…)
7. [æ„å»ºæ€§èƒ½ä¼˜åŒ–](#7-æ„å»ºæ€§èƒ½ä¼˜åŒ–)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ RPMåŒ…æ„å»ºåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯RPMåŒ…æ„å»º


**é€šä¿—ç†è§£**ï¼šå°±åƒç›–æˆ¿å­ä¸€æ ·ï¼ŒRPMåŒ…æ„å»ºå°±æ˜¯æŠŠæ•£è½çš„å»ºç­‘ææ–™ï¼ˆæºç ã€é…ç½®æ–‡ä»¶ï¼‰æŒ‰ç…§è®¾è®¡å›¾çº¸ï¼ˆspecæ–‡ä»¶ï¼‰ï¼Œç»„è£…æˆå¯ä»¥ç›´æ¥ä½¿ç”¨çš„æˆ¿å­ï¼ˆrpmåŒ…ï¼‰ã€‚

```
ç”Ÿæ´»æ¯”å–»ï¼š
åšé¥­è¿‡ç¨‹ â†’ RPMæ„å»ºè¿‡ç¨‹
é£Ÿæå‡†å¤‡ â†’ æºç å‡†å¤‡  
èœè°±è¯´æ˜ â†’ SPECæ–‡ä»¶
çƒ¹é¥ªè¿‡ç¨‹ â†’ æ„å»ºè¿‡ç¨‹
æˆå“èœè‚´ â†’ RPMåŒ…
```

**ğŸ”¸ RPMæ„å»ºçš„æœ¬è´¨ä½œç”¨**
- **æ ‡å‡†åŒ–æ‰“åŒ…**ï¼šæŠŠè½¯ä»¶æŒ‰ç»Ÿä¸€æ ¼å¼æ‰“åŒ…ï¼Œæ–¹ä¾¿å®‰è£…ç®¡ç†
- **ä¾èµ–å…³ç³»å¤„ç†**ï¼šè‡ªåŠ¨å¤„ç†è½¯ä»¶é—´çš„ä¾èµ–å…³ç³»
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ¸…æ¥šè®°å½•è½¯ä»¶ç‰ˆæœ¬å’Œæ›´æ–°ä¿¡æ¯
- **ç³»ç»Ÿé›†æˆ**ï¼šç¡®ä¿è½¯ä»¶èƒ½æ­£ç¡®é›†æˆåˆ°Linuxç³»ç»Ÿä¸­

### 1.2 æ„å»ºç¯å¢ƒç»“æ„


**ğŸ“ æ ‡å‡†æ„å»ºç›®å½•æ ‘**
```
~/rpmbuild/                    â† æ„å»ºå·¥ä½œç›®å½•
â”œâ”€â”€ BUILD/                     â† ç¼–è¯‘è¿‡ç¨‹çš„ä¸´æ—¶ç›®å½•
â”œâ”€â”€ BUILDROOT/                 â† å®‰è£…æ–‡ä»¶çš„ä¸´æ—¶ç›®å½•  
â”œâ”€â”€ RPMS/                      â† ç”Ÿæˆçš„äºŒè¿›åˆ¶RPMåŒ…
â”‚   â”œâ”€â”€ x86_64/               â† 64ä½æ¶æ„åŒ…
â”‚   â”œâ”€â”€ i386/                 â† 32ä½æ¶æ„åŒ…
â”‚   â””â”€â”€ noarch/               â† æ¶æ„æ— å…³åŒ…
â”œâ”€â”€ SOURCES/                   â† æºç å’Œè¡¥ä¸æ–‡ä»¶
â”œâ”€â”€ SPECS/                     â† SPECè§„æ ¼æ–‡ä»¶
â””â”€â”€ SRPMS/                     â† ç”Ÿæˆçš„æºç RPMåŒ…
```

**ğŸ’¡ ç›®å½•åŠŸèƒ½è¯´æ˜**
- `SOURCES`ï¼šå­˜æ”¾åŸå§‹æºç åŒ…ã€é…ç½®æ–‡ä»¶ã€è¡¥ä¸æ–‡ä»¶
- `SPECS`ï¼šå­˜æ”¾æ„å»ºè§„èŒƒæ–‡ä»¶ï¼Œå‘Šè¯‰ç³»ç»Ÿå¦‚ä½•æ„å»º
- `BUILD`ï¼šç¼–è¯‘æ—¶çš„å·¥ä½œç›®å½•ï¼Œç±»ä¼¼å»ºç­‘å·¥åœ°
- `BUILDROOT`ï¼šå®‰è£…æ¼”ç»ƒç›®å½•ï¼Œæ¨¡æ‹ŸçœŸå®å®‰è£…ç¯å¢ƒ
- `RPMS`ï¼šæœ€ç»ˆçš„æˆå“åŒ…ï¼Œå¯ä»¥ç›´æ¥å®‰è£…ä½¿ç”¨
- `SRPMS`ï¼šæºç åŒ…ï¼ŒåŒ…å«æ‰€æœ‰æ„å»ºä¿¡æ¯

### 1.3 æ„å»ºæµç¨‹æ¦‚è§ˆ


**ğŸ”„ å®Œæ•´æ„å»ºè¿‡ç¨‹**
```
æºç å‡†å¤‡ â†’ ç¯å¢ƒæ£€æŸ¥ â†’ ç¼–è¯‘æ„å»º â†’ å®‰è£…æµ‹è¯• â†’ æ‰“åŒ…è¾“å‡º

è¯¦ç»†æ­¥éª¤ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1.å‡†å¤‡é˜¶æ®µ  â”‚ â†’ â”‚  2.æ„å»ºé˜¶æ®µ  â”‚ â†’ â”‚  3.æ‰“åŒ…é˜¶æ®µ  â”‚
â”‚ æ£€æŸ¥ä¾èµ–    â”‚    â”‚ ç¼–è¯‘æºç     â”‚    â”‚ ç”ŸæˆRPMåŒ…   â”‚
â”‚ è§£å‹æºç     â”‚    â”‚ è¿è¡Œæµ‹è¯•    â”‚    â”‚ éªŒè¯åŒ…å®Œæ•´æ€§ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ›  rpmbuildå‘½ä»¤è¯¦è§£


### 2.1 ä¸»è¦æ„å»ºå‘½ä»¤


**ğŸ”¸ rpmbuild -ba**ï¼ˆå®Œæ•´æ„å»ºï¼‰
```bash
# åŒæ—¶ç”Ÿæˆæºç åŒ…å’ŒäºŒè¿›åˆ¶åŒ…
rpmbuild -ba myapp.spec

# ç­‰ä»·äºæ‰§è¡Œï¼š
# rpmbuild -bs myapp.spec  (æ„å»ºæºç åŒ…)
# rpmbuild -bb myapp.spec  (æ„å»ºäºŒè¿›åˆ¶åŒ…)
```

**å«ä¹‰è§£é‡Š**ï¼š
- `-ba` = `-bs` + `-bb`ï¼Œè¡¨ç¤º"both all"
- è¿™æ˜¯æœ€å¸¸ç”¨çš„æ„å»ºæ–¹å¼ï¼Œä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰æ„å»ºä»»åŠ¡
- é€‚åˆæ­£å¼å‘å¸ƒæ—¶ä½¿ç”¨

**ğŸ”¸ rpmbuild -bs**ï¼ˆä»…æ„å»ºæºç åŒ…ï¼‰
```bash
# åªç”ŸæˆSRPMæºç åŒ…ï¼Œä¸ç¼–è¯‘äºŒè¿›åˆ¶
rpmbuild -bs myapp.spec

# ç”Ÿæˆçš„æ–‡ä»¶ä½ç½®
ls ~/rpmbuild/SRPMS/myapp-1.0-1.src.rpm
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- å¿«é€Ÿæ£€æŸ¥SPECæ–‡ä»¶è¯­æ³•
- å‡†å¤‡æºç åŒ…ç”¨äºå…¶ä»–ç¯å¢ƒæ„å»º
- èŠ‚çœæ—¶é—´ï¼Œä¸è¿›è¡Œå®é™…ç¼–è¯‘

**ğŸ”¸ rpmbuild -bb**ï¼ˆä»…æ„å»ºäºŒè¿›åˆ¶åŒ…ï¼‰
```bash
# åªç”ŸæˆäºŒè¿›åˆ¶RPMåŒ…
rpmbuild -bb myapp.spec

# ç”Ÿæˆçš„æ–‡ä»¶ä½ç½®
ls ~/rpmbuild/RPMS/x86_64/myapp-1.0-1.x86_64.rpm
```

**é€‚ç”¨æƒ…å†µ**ï¼š
- å·²æœ‰æºç åŒ…ï¼Œåªéœ€ç”Ÿæˆå®‰è£…åŒ…
- è°ƒè¯•æ„å»ºè¿‡ç¨‹ï¼Œä¸“æ³¨äºç¼–è¯‘é—®é¢˜

### 2.2 æ„å»ºé€‰é¡¹è¯¦è§£


| é€‰é¡¹ | **ä½œç”¨è¯´æ˜** | **å®é™…ç”¨é€”** |
|------|-------------|-------------|
| `--target` | `æŒ‡å®šç›®æ ‡æ¶æ„` | `rpmbuild --target=i686 -ba app.spec` |
| `--define` | `å®šä¹‰å®å˜é‡` | `rpmbuild --define "debug 1" -ba app.spec` |
| `--with/--without` | `æ¡ä»¶æ„å»ºæ§åˆ¶` | `rpmbuild --with mysql -ba app.spec` |
| `--clean` | `æ„å»ºåæ¸…ç†` | `è‡ªåŠ¨æ¸…ç†BUILDç›®å½•` |
| `-v` | `è¯¦ç»†è¾“å‡º` | `æ˜¾ç¤ºè¯¦ç»†æ„å»ºä¿¡æ¯` |

**ğŸ¯ å®é™…åº”ç”¨ç¤ºä¾‹**
```bash
# ä¸º32ä½æ¶æ„æ„å»º
rpmbuild --target=i386 -ba myapp.spec

# å¼€å¯è°ƒè¯•æ¨¡å¼æ„å»º
rpmbuild --define "debug_package 1" -ba myapp.spec

# æ¡ä»¶æ„å»ºï¼ˆå¯ç”¨MySQLæ”¯æŒï¼‰
rpmbuild --with mysql --without sqlite -ba myapp.spec
```

### 2.3 æ„å»ºé˜¶æ®µæ§åˆ¶


**ğŸ“‹ æ„å»ºé˜¶æ®µè¯´æ˜**
```
%prep    â†’ å‡†å¤‡æºç ï¼ˆè§£å‹ã€æ‰“è¡¥ä¸ï¼‰
%build   â†’ ç¼–è¯‘æ„å»º
%install â†’ å®‰è£…åˆ°BUILDROOT
%check   â†’ è¿è¡Œæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
%clean   â†’ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
```

**ğŸ”§ å•ç‹¬æ‰§è¡ŒæŸä¸ªé˜¶æ®µ**
```bash
# åªæ‰§è¡Œå‡†å¤‡é˜¶æ®µ
rpmbuild -bp myapp.spec

# åªæ‰§è¡Œåˆ°ç¼–è¯‘é˜¶æ®µ
rpmbuild -bc myapp.spec

# åªæ‰§è¡Œåˆ°å®‰è£…é˜¶æ®µ  
rpmbuild -bi myapp.spec
```

---

## 3. ğŸš€ å®Œæ•´æ„å»ºæµç¨‹å®æˆ˜


### 3.1 ç¯å¢ƒå‡†å¤‡


**ğŸ“¦ å®‰è£…æ„å»ºå·¥å…·**
```bash
# CentOS/RHELç³»ç»Ÿ
sudo yum install rpm-build rpm-devel rpmdevtools

# Ubuntu/Debianç³»ç»Ÿï¼ˆä½¿ç”¨alienè½¬æ¢ï¼‰
sudo apt-get install rpm alien

# åˆ›å»ºæ„å»ºç¯å¢ƒ
rpmdev-setuptree
```

**ğŸ— æ„å»ºç›®å½•åˆå§‹åŒ–**
```bash
# æ£€æŸ¥ç›®å½•ç»“æ„
tree ~/rpmbuild
# åº”è¯¥çœ‹åˆ°æ ‡å‡†çš„6ä¸ªç›®å½•

# å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨åˆ›å»º
mkdir -p ~/rpmbuild/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
```

### 3.2 å‡†å¤‡æ„å»ºææ–™


**ğŸ“¥ æºç åŒ…å‡†å¤‡**
```bash
# ä¸‹è½½æºç åŒ…åˆ°SOURCESç›®å½•
cd ~/rpmbuild/SOURCES
wget https://example.com/myapp-1.0.tar.gz

# å‡†å¤‡é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
cp myapp.conf ~/rpmbuild/SOURCES/

# å‡†å¤‡è¡¥ä¸æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
cp myapp-fix.patch ~/rpmbuild/SOURCES/
```

**ğŸ“ ç¼–å†™SPECæ–‡ä»¶**
```bash
# åœ¨SPECSç›®å½•åˆ›å»ºè§„æ ¼æ–‡ä»¶
cd ~/rpmbuild/SPECS
cat > myapp.spec << 'EOF'
Name:           myapp
Version:        1.0
Release:        1%{?dist}
Summary:        ç¤ºä¾‹åº”ç”¨ç¨‹åº

License:        GPL
URL:            http://example.com
Source0:        myapp-%{version}.tar.gz

BuildRequires:  gcc, make
Requires:       glibc

%description
è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹åº”ç”¨ç¨‹åºï¼Œç”¨äºæ¼”ç¤ºRPMæ„å»ºè¿‡ç¨‹ã€‚

%prep
%setup -q

%build
make %{?_smp_mflags}

%install
make install DESTDIR=%{buildroot}

%files
%{_bindir}/myapp
%{_mandir}/man1/myapp.1*

%changelog
* Sat Sep 14 2024 ç”¨æˆ·å <email@example.com> - 1.0-1
- åˆå§‹ç‰ˆæœ¬
EOF
```

### 3.3 æ‰§è¡Œæ„å»ºè¿‡ç¨‹


**ğŸ”¥ å®Œæ•´æ„å»ºæµç¨‹**
```bash
# è¿›å…¥SPECSç›®å½•
cd ~/rpmbuild/SPECS

# æ£€æŸ¥SPECæ–‡ä»¶è¯­æ³•
rpmlint myapp.spec

# å¼€å§‹å®Œæ•´æ„å»º
rpmbuild -ba myapp.spec

# æ„å»ºè¿‡ç¨‹è¾“å‡ºç¤ºä¾‹ï¼š
# Executing(%prep): /bin/sh -e /tmp/rpm-tmp.abc123
# + cd /home/user/rpmbuild/BUILD
# + cd myapp-1.0
# + exit 0
# Executing(%build): /bin/sh -e /tmp/rpm-tmp.def456
# + cd /home/user/rpmbuild/BUILD/myapp-1.0
# + make -j2
# + exit 0
# ...æ„å»ºå®Œæˆ
```

**ğŸ“Š æ„å»ºè¿›åº¦è·Ÿè¸ª**
```
æ„å»ºé˜¶æ®µè¿›åº¦ï¼š
[å‡†å¤‡] â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%  è§£å‹æºç å®Œæˆ
[æ„å»º] â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%  ç¼–è¯‘å®Œæˆ
[å®‰è£…] â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%  å®‰è£…æ–‡ä»¶å®Œæˆ
[æ‰“åŒ…] â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%  ç”ŸæˆRPMåŒ…å®Œæˆ

è¾“å‡ºæ–‡ä»¶ï¼š
~/rpmbuild/SRPMS/myapp-1.0-1.src.rpm      â† æºç åŒ…
~/rpmbuild/RPMS/x86_64/myapp-1.0-1.x86_64.rpm â† äºŒè¿›åˆ¶åŒ…
```

### 3.4 éªŒè¯æ„å»ºç»“æœ


**ğŸ” æ£€æŸ¥ç”Ÿæˆçš„åŒ…**
```bash
# æŸ¥çœ‹äºŒè¿›åˆ¶åŒ…ä¿¡æ¯
rpm -qpi ~/rpmbuild/RPMS/x86_64/myapp-1.0-1.x86_64.rpm

# æŸ¥çœ‹åŒ…å«çš„æ–‡ä»¶
rpm -qpl ~/rpmbuild/RPMS/x86_64/myapp-1.0-1.x86_64.rpm

# æµ‹è¯•å®‰è£…ï¼ˆä¸å®é™…å®‰è£…ï¼‰
rpm -qp --scripts ~/rpmbuild/RPMS/x86_64/myapp-1.0-1.x86_64.rpm
```

**âœ… å®Œæ•´æ€§éªŒè¯**
```bash
# éªŒè¯åŒ…å®Œæ•´æ€§
rpm -K ~/rpmbuild/RPMS/x86_64/myapp-1.0-1.x86_64.rpm

# è¾“å‡ºç¤ºä¾‹ï¼š
# myapp-1.0-1.x86_64.rpm: sha1 md5 OK
```

---

## 4. ğŸ”§ æ„å»ºè¿‡ç¨‹è°ƒè¯•ä¸æ’é”™


### 4.1 å¸¸è§æ„å»ºé”™è¯¯


**âŒ ä¾èµ–ç¼ºå¤±é”™è¯¯**
```
é”™è¯¯ä¿¡æ¯ï¼š
error: Failed build dependencies:
    gcc is needed by myapp-1.0-1.x86_64
    make is needed by myapp-1.0-1.x86_64

è§£å†³æ–¹æ³•ï¼š
sudo yum install gcc make
# æˆ–è€…åœ¨SPECæ–‡ä»¶ä¸­æ­£ç¡®å£°æ˜BuildRequires
```

**âŒ æ–‡ä»¶è·¯å¾„é”™è¯¯**
```
é”™è¯¯ä¿¡æ¯ï¼š
error: File not found: /home/user/rpmbuild/BUILDROOT/myapp-1.0-1.x86_64/usr/bin/myapp

åŸå› åˆ†æï¼š
å®‰è£…è·¯å¾„ä¸%fileså£°æ˜ä¸åŒ¹é…

è§£å†³æ–¹æ³•ï¼š
1. æ£€æŸ¥Makefileçš„å®‰è£…è·¯å¾„
2. ä¿®æ­£%filesä¸­çš„è·¯å¾„å£°æ˜
3. æˆ–è€…åœ¨%installé˜¶æ®µæ‰‹åŠ¨è°ƒæ•´è·¯å¾„
```

**âŒ æƒé™é—®é¢˜**
```
é”™è¯¯ä¿¡æ¯ï¼š
error: Bad file permissions: 0755 -> 0644

è§£å†³æ–¹æ³•ï¼š
# åœ¨%installé˜¶æ®µè®¾ç½®æ­£ç¡®æƒé™
chmod 755 %{buildroot}%{_bindir}/myapp
```

### 4.2 è°ƒè¯•æŠ€å·§ä¸æ–¹æ³•


**ğŸ” è¯¦ç»†è¾“å‡ºè°ƒè¯•**
```bash
# å¯ç”¨è¯¦ç»†è¾“å‡º
rpmbuild -ba -v myapp.spec

# æŸ¥çœ‹æ„å»ºæ—¥å¿—
rpmbuild -ba myapp.spec 2>&1 | tee build.log

# åˆ†ææ—¥å¿—å…³é”®ä¿¡æ¯
grep -i error build.log
grep -i "file not found" build.log
```

**ğŸ›  åˆ†é˜¶æ®µè°ƒè¯•**
```bash
# åªæ‰§è¡Œå‡†å¤‡é˜¶æ®µï¼Œæ£€æŸ¥æºç è§£å‹
rpmbuild -bp myapp.spec

# æ‰§è¡Œåˆ°æ„å»ºé˜¶æ®µï¼Œæ£€æŸ¥ç¼–è¯‘è¿‡ç¨‹
rpmbuild -bc myapp.spec

# æ‰§è¡Œåˆ°å®‰è£…é˜¶æ®µï¼Œæ£€æŸ¥æ–‡ä»¶å®‰è£…
rpmbuild -bi myapp.spec

# æ£€æŸ¥BUILDROOTç›®å½•å†…å®¹
find ~/rpmbuild/BUILDROOT -type f
```

**ğŸ“‹ æ„å»ºç¯å¢ƒæ£€æŸ¥**
```bash
# æ£€æŸ¥æ„å»ºä¾èµ–
rpm -q gcc make
# æˆ–è€…
yum list installed | grep -E "(gcc|make)"

# æ£€æŸ¥ç³»ç»Ÿæ¶æ„
uname -m
arch

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h ~/rpmbuild
```

### 4.3 è°ƒè¯•æœ€ä½³å®è·µ


**ğŸ¯ é€æ­¥è°ƒè¯•ç­–ç•¥**
```
æ­¥éª¤1ï¼šè¯­æ³•æ£€æŸ¥
rpmlint myapp.spec

æ­¥éª¤2ï¼šä¾èµ–æ£€æŸ¥  
yum-builddep myapp.spec

æ­¥éª¤3ï¼šåˆ†é˜¶æ®µæ„å»º
rpmbuild -bp â†’ -bc â†’ -bi â†’ -ba

æ­¥éª¤4ï¼šè¯¦ç»†æ—¥å¿—åˆ†æ
åˆ†æé”™è¯¯ä¿¡æ¯ï¼Œå®šä½é—®é¢˜æ ¹æº
```

**ğŸ’¡ è°ƒè¯•å°æŠ€å·§**
- ä¿æŒBUILDç›®å½•å†…å®¹ï¼Œä¾¿äºæ£€æŸ¥ä¸­é—´æ–‡ä»¶
- ä½¿ç”¨`--define "debug 1"`å¯ç”¨è°ƒè¯•æ¨¡å¼
- åœ¨SPECæ–‡ä»¶ä¸­æ·»åŠ `echo`è¯­å¥è¾“å‡ºè°ƒè¯•ä¿¡æ¯
- åˆ©ç”¨`%{_builddir}`å’Œ`%{buildroot}`ç¯å¢ƒå˜é‡

---

## 5. ğŸ“¦ å¤šåŒ…æ„å»ºä¸å­åŒ…ç®¡ç†


### 5.1 å­åŒ…æ¦‚å¿µç†è§£


**é€šä¿—è§£é‡Š**ï¼šå°±åƒä¸€ä¸ªè½¯ä»¶å¥—è£…ï¼Œå¯ä»¥åˆ†æˆå¤šä¸ªå°åŒ…ã€‚æ¯”å¦‚MySQLè½¯ä»¶ï¼Œå¯ä»¥åˆ†æˆï¼š
- `mysql-server`ï¼šæœåŠ¡å™¨ç¨‹åºåŒ…
- `mysql-client`ï¼šå®¢æˆ·ç«¯å·¥å…·åŒ…  
- `mysql-devel`ï¼šå¼€å‘åº“åŒ…
- `mysql-doc`ï¼šæ–‡æ¡£åŒ…

**ğŸ”¸ ä¸ºä»€ä¹ˆè¦ç”¨å­åŒ…**
- **çµæ´»å®‰è£…**ï¼šç”¨æˆ·åªå®‰è£…éœ€è¦çš„éƒ¨åˆ†
- **å‡å°‘ç©ºé—´**ï¼šé¿å…å®‰è£…ä¸éœ€è¦çš„æ–‡ä»¶
- **ä¾èµ–ç®¡ç†**ï¼šä¸åŒåŒ…æœ‰ä¸åŒçš„ä¾èµ–å…³ç³»
- **æƒé™åˆ†ç¦»**ï¼šæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å¯èƒ½æœ‰ä¸åŒæƒé™éœ€æ±‚

### 5.2 å­åŒ…SPECæ–‡ä»¶ç»“æ„


**ğŸ“ å¤šåŒ…SPECæ–‡ä»¶ç¤ºä¾‹**
```spec
Name:           myapp
Version:        1.0
Release:        1%{?dist}
Summary:        ç¤ºä¾‹åº”ç”¨ç¨‹åºå¥—ä»¶

# ä¸»åŒ…ä¿¡æ¯
%description
è¿™æ˜¯ç¤ºä¾‹åº”ç”¨ç¨‹åºçš„ä¸»åŒ…ï¼ŒåŒ…å«åŸºç¡€è¿è¡Œåº“ã€‚

# å­åŒ…1ï¼šæœåŠ¡å™¨åŒ…
%package server
Summary:        ç¤ºä¾‹åº”ç”¨çš„æœåŠ¡å™¨ç»„ä»¶
Requires:       %{name} = %{version}-%{release}

%description server
åŒ…å«ç¤ºä¾‹åº”ç”¨çš„æœåŠ¡å™¨ç«¯ç¨‹åºå’Œé…ç½®æ–‡ä»¶ã€‚

# å­åŒ…2ï¼šå¼€å‘åŒ…
%package devel
Summary:        ç¤ºä¾‹åº”ç”¨çš„å¼€å‘æ–‡ä»¶
Requires:       %{name} = %{version}-%{release}

%description devel
åŒ…å«å¼€å‘ç¤ºä¾‹åº”ç”¨æ‰€éœ€çš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶ã€‚

# å®‰è£…æ–‡ä»¶åˆ†é…
%files
%{_libdir}/libmyapp.so.*

%files server
%{_bindir}/myapp-server
%{_sysconfdir}/myapp/server.conf

%files devel
%{_includedir}/myapp/
%{_libdir}/libmyapp.so
```

### 5.3 å­åŒ…æ„å»ºå®è·µ


**ğŸš€ æ„å»ºæ‰€æœ‰å­åŒ…**
```bash
# æ„å»ºä¼šç”Ÿæˆå¤šä¸ªRPMåŒ…
rpmbuild -ba myapp.spec

# æŸ¥çœ‹ç”Ÿæˆçš„åŒ…
ls ~/rpmbuild/RPMS/x86_64/
# myapp-1.0-1.x86_64.rpm        â† ä¸»åŒ…
# myapp-server-1.0-1.x86_64.rpm â† æœåŠ¡å™¨åŒ…  
# myapp-devel-1.0-1.x86_64.rpm  â† å¼€å‘åŒ…
```

**ğŸ“¦ åŒ…ä¹‹é—´çš„å…³ç³»å›¾**
```
myapp (ä¸»åŒ…)
â”œâ”€â”€ åŸºç¡€åº“æ–‡ä»¶
â””â”€â”€ è¿è¡Œæ—¶ä¾èµ–

myapp-server (å­åŒ…)
â”œâ”€â”€ ä¾èµ–ä¸»åŒ…
â”œâ”€â”€ æœåŠ¡å™¨ç¨‹åº
â””â”€â”€ é…ç½®æ–‡ä»¶

myapp-devel (å­åŒ…)  
â”œâ”€â”€ ä¾èµ–ä¸»åŒ…
â”œâ”€â”€ å¤´æ–‡ä»¶
â””â”€â”€ å¼€å‘åº“
```

### 5.4 æ¡ä»¶å­åŒ…æ„å»º


**ğŸ› æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦æ„å»ºæŸä¸ªå­åŒ…**
```spec
# å®šä¹‰æ„å»ºå¼€å…³
%bcond_without mysql_support
%bcond_without postgresql_support

# æ¡ä»¶å­åŒ…
%if %{with mysql_support}
%package mysql
Summary: MySQLæ•°æ®åº“æ”¯æŒ
%description mysql
ä¸ºåº”ç”¨ç¨‹åºæä¾›MySQLæ•°æ®åº“æ”¯æŒã€‚
%endif

%if %{with postgresql_support}  
%package postgresql
Summary: PostgreSQLæ•°æ®åº“æ”¯æŒ
%description postgresql
ä¸ºåº”ç”¨ç¨‹åºæä¾›PostgreSQLæ•°æ®åº“æ”¯æŒã€‚
%endif
```

**ğŸ”§ æ„å»ºæ—¶æ§åˆ¶å­åŒ…**
```bash
# æ„å»ºæ—¶ç¦ç”¨MySQLæ”¯æŒ
rpmbuild --without mysql_support -ba myapp.spec

# æ„å»ºæ—¶å¯ç”¨æ‰€æœ‰æ”¯æŒ
rpmbuild --with mysql_support --with postgresql_support -ba myapp.spec
```

---

## 6. âš™ï¸ æ¡ä»¶æ„å»ºä¸å¹³å°é€‚é…


### 6.1 æ¡ä»¶æ„å»ºåŸºç¡€


**ğŸ’¡ ä»€ä¹ˆæ˜¯æ¡ä»¶æ„å»º**
ç®€å•è¯´å°±æ˜¯"çœ‹æƒ…å†µå†³å®šæ€ä¹ˆæ„å»º"ï¼Œæ¯”å¦‚ï¼š
- ä¸åŒæ“ä½œç³»ç»Ÿç‰ˆæœ¬ç”¨ä¸åŒçš„ç¼–è¯‘å‚æ•°
- æ ¹æ®ç”¨æˆ·éœ€æ±‚å†³å®šå¯ç”¨å“ªäº›åŠŸèƒ½
- é’ˆå¯¹ä¸åŒç¡¬ä»¶æ¶æ„ä¼˜åŒ–ç¼–è¯‘

**ğŸ¯ å¸¸ç”¨æ¡ä»¶æ„å»ºå®**
```spec
# ç³»ç»Ÿç‰ˆæœ¬åˆ¤æ–­
%if 0%{?rhel} >= 7
    # RHEL 7åŠä»¥ä¸Šç‰ˆæœ¬çš„ä»£ç 
%endif

# æ¶æ„åˆ¤æ–­
%ifarch x86_64
    # 64ä½ç³»ç»Ÿç‰¹æœ‰ä»£ç 
%endif

# å‘è¡Œç‰ˆåˆ¤æ–­
%if 0%{?fedora}
    # Fedoraç‰¹æœ‰ä»£ç 
%endif
```

### 6.2 å¹³å°é€‚é…å®ä¾‹


**ğŸ¢ ä¸åŒå‘è¡Œç‰ˆé€‚é…**
```spec
Name: myapp
Version: 1.0

# æ ¹æ®å‘è¡Œç‰ˆè®¾ç½®ä¸åŒçš„ä¾èµ–
%if 0%{?rhel}
BuildRequires: mysql-devel
%endif

%if 0%{?fedora}  
BuildRequires: community-mysql-devel
%endif

%if 0%{?suse_version}
BuildRequires: libmysqlclient-devel
%endif

# æ ¹æ®ç³»ç»Ÿç‰ˆæœ¬é€‰æ‹©ç¼–è¯‘å™¨
%if 0%{?rhel} <= 6
    # è€ç‰ˆæœ¬ç³»ç»Ÿä½¿ç”¨æ—§ç¼–è¯‘å™¨
    %define _cc gcc44
%else
    # æ–°ç‰ˆæœ¬ç³»ç»Ÿä½¿ç”¨æ–°ç¼–è¯‘å™¨
    %define _cc gcc
%endif
```

**ğŸ”§ æ¶æ„ç›¸å…³é€‚é…**
```spec
# é’ˆå¯¹ä¸åŒæ¶æ„çš„ä¼˜åŒ–
%build
%ifarch x86_64
    # 64ä½ä¼˜åŒ–ç¼–è¯‘
    ./configure --enable-64bit-optimizations
%endif

%ifarch %{ix86}
    # 32ä½å…¼å®¹ç¼–è¯‘
    ./configure --enable-32bit-compatibility  
%endif

%ifarch aarch64
    # ARM64æ¶æ„ç¼–è¯‘
    ./configure --enable-arm64-optimizations
%endif

make %{?_smp_mflags}
```

### 6.3 åŠŸèƒ½å¼€å…³æ§åˆ¶


**ğŸ› ç”¨æˆ·å¯æ§çš„åŠŸèƒ½å¼€å…³**
```spec
# å®šä¹‰åŠŸèƒ½å¼€å…³ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
%bcond_without gui_support
%bcond_without database_support  
%bcond_with debug_mode

%build
./configure \
%if %{with gui_support}
    --enable-gui \
%else
    --disable-gui \
%endif
%if %{with database_support}
    --with-mysql \
%endif  
%if %{with debug_mode}
    --enable-debug \
%endif

make %{?_smp_mflags}
```

**ğŸš€ æ„å»ºæ—¶æ§åˆ¶åŠŸèƒ½**
```bash
# æ„å»ºæ—¶ç¦ç”¨GUIæ”¯æŒ
rpmbuild --without gui_support -ba myapp.spec

# æ„å»ºè°ƒè¯•ç‰ˆæœ¬
rpmbuild --with debug_mode -ba myapp.spec

# æ„å»ºæœ€å°åŠŸèƒ½ç‰ˆæœ¬
rpmbuild --without gui_support --without database_support -ba myapp.spec
```

---

## 7. ğŸš€ æ„å»ºæ€§èƒ½ä¼˜åŒ–


### 7.1 ç¼–è¯‘æ€§èƒ½ä¼˜åŒ–


**âš¡ å¹¶è¡Œç¼–è¯‘ä¼˜åŒ–**
```spec
%build
# ä½¿ç”¨æ‰€æœ‰å¯ç”¨CPUæ ¸å¿ƒ
make %{?_smp_mflags}

# æ‰‹åŠ¨æŒ‡å®šå¹¶è¡Œåº¦
make -j$(nproc)

# é™åˆ¶å¹¶è¡Œåº¦ï¼ˆé¿å…å†…å­˜ä¸è¶³ï¼‰
make -j2
```

**ğŸ’¾ å†…å­˜ä½¿ç”¨ä¼˜åŒ–**
```spec
%build
# å¯¹äºå¤§å‹é¡¹ç›®ï¼Œé™åˆ¶å¹¶è¡Œç¼–è¯‘é¿å…å†…å­˜è€—å°½
%if 0%{?_memory_constrained}
    make -j1
%else
    make %{?_smp_mflags}
%endif
```

**ğŸ¯ ç¼–è¯‘å™¨ä¼˜åŒ–é€‰é¡¹**
```spec
# æ€§èƒ½ä¼˜åŒ–ç¼–è¯‘
%build
export CFLAGS="%{optflags} -O3 -march=native"
export CXXFLAGS="%{optflags} -O3 -march=native"

# è°ƒè¯•ç‰ˆæœ¬ç¼–è¯‘
%if %{with debug}
    export CFLAGS="%{optflags} -g -O0"
    export CXXFLAGS="%{optflags} -g -O0"
%endif

./configure
make %{?_smp_mflags}
```

### 7.2 æ„å»ºæ—¶é—´ä¼˜åŒ–


**ğŸ“¦ ç¼“å­˜ç­–ç•¥**
```spec
%prep
%setup -q

# ä½¿ç”¨ccacheåŠ é€Ÿé‡å¤ç¼–è¯‘
%build
export CC="ccache gcc"
export CXX="ccache g++"
make %{?_smp_mflags}
```

**ğŸ”§ è·³è¿‡å¯é€‰æ­¥éª¤**
```spec
# å¼€å‘æ„å»ºæ—¶è·³è¿‡æ–‡æ¡£ç”Ÿæˆ
%if 0%{?quick_build}
    %define _without_docs 1
%endif

%build
make %{?_smp_mflags}

%if !0%{?_without_docs}
    # åªåœ¨å®Œæ•´æ„å»ºæ—¶ç”Ÿæˆæ–‡æ¡£
    make docs
%endif
```

### 7.3 ç£ç›˜IOä¼˜åŒ–


**ğŸ’½ ä¸´æ—¶æ–‡ä»¶ç®¡ç†**
```spec
%prep
# ä½¿ç”¨å†…å­˜æ–‡ä»¶ç³»ç»ŸåŠ é€Ÿæ„å»ºï¼ˆå¦‚æœå†…å­˜å……è¶³ï¼‰
%if 0%{?use_tmpfs}
    mkdir -p /tmp/rpmbuild-$$
    mount -t tmpfs tmpfs /tmp/rpmbuild-$$
    export TMPDIR=/tmp/rpmbuild-$$
%endif

%setup -q
```

**ğŸ—‚ æ¸…ç†ä¼˜åŒ–**
```spec
%install
make install DESTDIR=%{buildroot}

# æ„å»ºè¿‡ç¨‹ä¸­åŠæ—¶æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
find %{buildroot} -name "*.la" -delete
find %{buildroot} -name "__pycache__" -exec rm -rf {} +

%clean
# æ„å»ºå®Œæˆåè‡ªåŠ¨æ¸…ç†
rm -rf %{buildroot}
%if 0%{?use_tmpfs}
    umount /tmp/rpmbuild-$$ 2>/dev/null || true
    rm -rf /tmp/rpmbuild-$$
%endif
```

### 7.4 æ„å»ºç¯å¢ƒä¼˜åŒ–


**ğŸ— æ„å»ºç¯å¢ƒé…ç½®**
```bash
# ~/.rpmmacros æ–‡ä»¶é…ç½®
cat > ~/.rpmmacros << 'EOF'
# ä¼˜åŒ–æ„å»ºå‚æ•°
%_smp_mflags -j$(nproc)

# ä½¿ç”¨æ›´å¿«çš„å‹ç¼©ç®—æ³•
%_source_payload w1.gzdio
%_binary_payload w1.gzdio

# è·³è¿‡è°ƒè¯•ä¿¡æ¯ï¼ˆå¦‚æœä¸éœ€è¦ï¼‰
%debug_package %{nil}
EOF
```

**â± æ€§èƒ½ç›‘æ§**
```bash
# ç›‘æ§æ„å»ºè¿‡ç¨‹èµ„æºä½¿ç”¨
time rpmbuild -ba myapp.spec

# è¯¦ç»†æ€§èƒ½åˆ†æ
/usr/bin/time -v rpmbuild -ba myapp.spec

# ç›‘æ§ç£ç›˜IO
iotop -a &
rpmbuild -ba myapp.spec
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ RPMæ„å»ºæœ¬è´¨ï¼šæŠŠæºç æŒ‰è§„èŒƒæ‰“åŒ…æˆå¯å®‰è£…çš„RPMåŒ…
ğŸ”¸ æ„å»ºç¯å¢ƒï¼š6ä¸ªæ ‡å‡†ç›®å½•å„æœ‰ä¸“é—¨ç”¨é€”
ğŸ”¸ rpmbuildå‘½ä»¤ï¼š-ba(å®Œæ•´)ã€-bs(æºç )ã€-bb(äºŒè¿›åˆ¶)
ğŸ”¸ æ„å»ºæµç¨‹ï¼šå‡†å¤‡â†’ç¼–è¯‘â†’å®‰è£…â†’æ‰“åŒ…çš„æ ‡å‡†åŒ–è¿‡ç¨‹
ğŸ”¸ SPECæ–‡ä»¶ï¼šæ„å»ºçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼Œå®šä¹‰æ•´ä¸ªæ„å»ºè¿‡ç¨‹
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ„å»ºè¿‡ç¨‹çš„æœ¬è´¨**
```
ç†è§£æ ¸å¿ƒï¼š
RPMæ„å»º = è‡ªåŠ¨åŒ–çš„è½¯ä»¶ç¼–è¯‘å®‰è£…è¿‡ç¨‹
SPECæ–‡ä»¶ = è¯¦ç»†çš„æ„å»ºæŒ‡ä»¤ä¹¦
æ„å»ºç¯å¢ƒ = éš”ç¦»çš„æ²™ç®±ç¯å¢ƒï¼Œä¿è¯æ„å»ºå®‰å…¨

å®é™…æ„ä¹‰ï¼š
- ç¡®ä¿è½¯ä»¶åœ¨ä¸åŒç¯å¢ƒä¸‹çš„ä¸€è‡´æ€§
- ç®€åŒ–è½¯ä»¶çš„å®‰è£…å’Œå¸è½½è¿‡ç¨‹
- æä¾›ä¾èµ–å…³ç³»ç®¡ç†å’Œç‰ˆæœ¬æ§åˆ¶
```

**ğŸ”¹ å¸¸è§é—®é¢˜çš„è§£å†³æ€è·¯**
```
æ„å»ºå¤±è´¥æ—¶çš„æ’æŸ¥é¡ºåºï¼š
1. æ£€æŸ¥SPECæ–‡ä»¶è¯­æ³•
2. éªŒè¯æ„å»ºä¾èµ–æ˜¯å¦æ»¡è¶³
3. æ£€æŸ¥æºç åŒ…æ˜¯å¦å®Œæ•´
4. åˆ†é˜¶æ®µè°ƒè¯•å®šä½é—®é¢˜
5. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—åˆ†æé”™è¯¯
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„è¦ç‚¹**
```
ä¼˜åŒ–ç­–ç•¥ï¼š
- åˆç†ä½¿ç”¨å¹¶è¡Œç¼–è¯‘
- é’ˆå¯¹ç›®æ ‡å¹³å°ä¼˜åŒ–
- ä½¿ç”¨ç¼“å­˜åŠ é€Ÿé‡å¤æ„å»º
- åŠæ—¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


- **è½¯ä»¶åˆ†å‘**ï¼šåˆ¶ä½œæ ‡å‡†åŒ–çš„è½¯ä»¶å®‰è£…åŒ…
- **ç¯å¢ƒç®¡ç†**ï¼šç¡®ä¿ä¸åŒç¯å¢ƒä¸‹è½¯ä»¶çš„ä¸€è‡´æ€§
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ¸…æ™°çš„ç‰ˆæœ¬ç®¡ç†å’Œå‡çº§è·¯å¾„
- **ä¾èµ–å¤„ç†**ï¼šè‡ªåŠ¨åŒ–çš„ä¾èµ–å…³ç³»ç®¡ç†
- **ç³»ç»Ÿé›†æˆ**ï¼šä¸LinuxåŒ…ç®¡ç†ç³»ç»Ÿæ— ç¼é›†æˆ

### 8.4 å­¦ä¹ è¿›é˜¶è·¯å¾„


```
ğŸ¯ æŒæ¡å±‚æ¬¡ï¼š
åˆçº§ï¼šèƒ½ç‹¬ç«‹æ„å»ºç®€å•çš„RPMåŒ…
ä¸­çº§ï¼šæŒæ¡å¤šåŒ…æ„å»ºå’Œæ¡ä»¶æ„å»º
é«˜çº§ï¼šèƒ½ä¼˜åŒ–æ„å»ºæ€§èƒ½ï¼Œå¤„ç†å¤æ‚ä¾èµ–
ä¸“å®¶ï¼šèƒ½è®¾è®¡æ„å»ºç³»ç»Ÿï¼Œè‡ªåŠ¨åŒ–CI/CD

ğŸ“š æ‰©å±•å­¦ä¹ ï¼š
- å­¦ä¹ æ›´é«˜çº§çš„SPECæ–‡ä»¶ç¼–å†™æŠ€å·§
- äº†è§£RPMåŒ…ç­¾åå’ŒéªŒè¯æœºåˆ¶
- æŒæ¡æ„å»ºè‡ªåŠ¨åŒ–å’ŒæŒç»­é›†æˆ
- ç ”ç©¶ä¸åŒå‘è¡Œç‰ˆçš„åŒ…ç®¡ç†å·®å¼‚
```

**ğŸ’¡ å®è·µå»ºè®®**
- ä»ç®€å•çš„Hello Worldç¨‹åºå¼€å§‹ç»ƒä¹ 
- å¤šé˜…è¯»ç°æœ‰è½¯ä»¶åŒ…çš„SPECæ–‡ä»¶
- åœ¨è™šæ‹Ÿç¯å¢ƒä¸­è¿›è¡Œæ„å»ºå®éªŒ
- å»ºç«‹è‡ªå·±çš„æ„å»ºè„šæœ¬å’Œæ¨¡æ¿åº“

**æ ¸å¿ƒè®°å¿†**ï¼š
- RPMæ„å»ºå°±æ˜¯æ ‡å‡†åŒ–çš„è½¯ä»¶æ‰“åŒ…è¿‡ç¨‹
- SPECæ–‡ä»¶æ˜¯æ„å»ºçš„æ ¸å¿ƒï¼Œå®šä¹‰äº†ä¸€åˆ‡
- åˆ†é˜¶æ®µè°ƒè¯•æ˜¯è§£å†³æ„å»ºé—®é¢˜çš„æœ‰æ•ˆæ–¹æ³•
- æ€§èƒ½ä¼˜åŒ–é‡ç‚¹åœ¨å¹¶è¡Œç¼–è¯‘å’Œç¯å¢ƒé…ç½®