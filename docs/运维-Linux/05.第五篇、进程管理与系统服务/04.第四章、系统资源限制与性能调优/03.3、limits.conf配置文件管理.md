---
title: 3ã€limits.confé…ç½®æ–‡ä»¶ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [limits.confé…ç½®æ–‡ä»¶æ¦‚è¿°](#1-limitsconfé…ç½®æ–‡ä»¶æ¦‚è¿°)
2. [é…ç½®æ–‡ä»¶è¯­æ³•ä¸ç»“æ„](#2-é…ç½®æ–‡ä»¶è¯­æ³•ä¸ç»“æ„)
3. [ç”¨æˆ·ä¸ç»„é™åˆ¶é…ç½®](#3-ç”¨æˆ·ä¸ç»„é™åˆ¶é…ç½®)
4. [softä¸hardé™åˆ¶è¯¦è§£](#4-softä¸hardé™åˆ¶è¯¦è§£)
5. [limits.dç›®å½•åˆ†ç‰‡ç®¡ç†](#5-limitsdç›®å½•åˆ†ç‰‡ç®¡ç†)
6. [PAMæ¨¡å—é›†æˆé…ç½®](#6-pamæ¨¡å—é›†æˆé…ç½®)
7. [é…ç½®ç”Ÿæ•ˆæœºåˆ¶ä¸éªŒè¯](#7-é…ç½®ç”Ÿæ•ˆæœºåˆ¶ä¸éªŒè¯)
8. [é€šé…ç¬¦ä¸ç‰¹æ®Šé…ç½®](#8-é€šé…ç¬¦ä¸ç‰¹æ®Šé…ç½®)
9. [é…ç½®ä¼˜å…ˆçº§ä¸ç»§æ‰¿](#9-é…ç½®ä¼˜å…ˆçº§ä¸ç»§æ‰¿)
10. [å®è·µæ¡ˆä¾‹ä¸æ•…éšœæ’æŸ¥](#10-å®è·µæ¡ˆä¾‹ä¸æ•…éšœæ’æŸ¥)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ limits.confé…ç½®æ–‡ä»¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯limits.conf


**æ ¸å¿ƒå®šä¹‰**ï¼š
`limits.conf`æ˜¯Linuxç³»ç»Ÿä¸­ç”¨æ¥**é™åˆ¶ç”¨æˆ·ä½¿ç”¨ç³»ç»Ÿèµ„æº**çš„é…ç½®æ–‡ä»¶ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒå°±åƒæ˜¯ç»™æ¯ä¸ªç”¨æˆ·è®¾ç½®"ä½¿ç”¨è§„åˆ™"çš„æ–‡ä»¶ã€‚

**é€šä¿—ç†è§£**ï¼š
```
æƒ³è±¡ä¸€ä¸ªå›¾ä¹¦é¦†çš„å€Ÿé˜…è§„åˆ™ï¼š
- æ™®é€šè¯»è€…ï¼šæœ€å¤šå€Ÿ5æœ¬ä¹¦ï¼Œå€ŸæœŸ1ä¸ªæœˆ
- VIPè¯»è€…ï¼šæœ€å¤šå€Ÿ20æœ¬ä¹¦ï¼Œå€ŸæœŸ3ä¸ªæœˆ
- å­¦ç”Ÿï¼šæœ€å¤šå€Ÿ10æœ¬ä¹¦ï¼Œå€ŸæœŸ2ä¸ªæœˆ

limits.confå°±æ˜¯ç»™ç³»ç»Ÿç”¨æˆ·åˆ¶å®šè¿™æ ·çš„"èµ„æºä½¿ç”¨è§„åˆ™"
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦limits.conf


**è§£å†³çš„æ ¸å¿ƒé—®é¢˜**ï¼š
- ğŸš« **é˜²æ­¢èµ„æºæ»¥ç”¨** - é¿å…æŸä¸ªç”¨æˆ·å ç”¨è¿‡å¤šèµ„æºå½±å“ç³»ç»Ÿ
- âš–ï¸ **èµ„æºå…¬å¹³åˆ†é…** - ç¡®ä¿æ¯ä¸ªç”¨æˆ·éƒ½èƒ½åˆç†ä½¿ç”¨ç³»ç»Ÿèµ„æº
- ğŸ›¡ï¸ **ç³»ç»Ÿç¨³å®šæ€§** - é˜²æ­¢ç³»ç»Ÿå› èµ„æºè€—å°½è€Œå´©æºƒ
- ğŸ‘¥ **å¤šç”¨æˆ·ç®¡ç†** - åœ¨å¤šç”¨æˆ·ç¯å¢ƒä¸‹ç»´æŠ¤ç³»ç»Ÿå¹³è¡¡

**å®é™…åº”ç”¨åœºæ™¯**ï¼š
```
WebæœåŠ¡å™¨ç¯å¢ƒï¼š
â”œâ”€ é™åˆ¶æ¯ä¸ªç”¨æˆ·æœ€å¤§è¿›ç¨‹æ•° â†’ é˜²æ­¢forkç‚¸å¼¹
â”œâ”€ é™åˆ¶æ–‡ä»¶æ‰“å¼€æ•°é‡ â†’ é¿å…æ–‡ä»¶å¥æŸ„è€—å°½  
â”œâ”€ é™åˆ¶å†…å­˜ä½¿ç”¨é‡ â†’ é˜²æ­¢å†…å­˜è¢«æŸä¸ªç”¨æˆ·ç‹¬å 
â””â”€ é™åˆ¶CPUæ—¶é—´ â†’ ç¡®ä¿å¤šç”¨æˆ·å…¬å¹³ä½¿ç”¨CPU
```

### 1.3 é…ç½®æ–‡ä»¶ä½ç½®ä¸ä½œç”¨


**ä¸»é…ç½®æ–‡ä»¶**ï¼š
```bash
/etc/security/limits.conf
```

**é…ç½®ç›®å½•**ï¼š
```bash
/etc/security/limits.d/
```

**ä½œç”¨èŒƒå›´**ï¼š
- é€šè¿‡PAMæ¨¡å—ç”Ÿæ•ˆ
- å½±å“ç”¨æˆ·ç™»å½•åçš„èµ„æºé™åˆ¶
- å¯¹ç³»ç»ŸæœåŠ¡å’Œç”¨æˆ·ä¼šè¯éƒ½æœ‰æ•ˆ

---

## 2. ğŸ“ é…ç½®æ–‡ä»¶è¯­æ³•ä¸ç»“æ„


### 2.1 åŸºæœ¬è¯­æ³•æ ¼å¼


**æ ‡å‡†é…ç½®è¡Œæ ¼å¼**ï¼š
```
<domain> <type> <item> <value>
```

**è¯­æ³•è¯´æ˜**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ domain  â”‚   type   â”‚    item     â”‚  value   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·/ç»„  â”‚ é™åˆ¶ç±»å‹  â”‚ èµ„æºé¡¹ç›®     â”‚ é™åˆ¶å€¼    â”‚
â”‚         â”‚          â”‚             â”‚          â”‚
â”‚ user1   â”‚  hard    â”‚   nofile    â”‚  65536   â”‚
â”‚ @group1 â”‚  soft    â”‚   nproc     â”‚  1024    â”‚
â”‚ *       â”‚  -       â”‚   memlock   â”‚  unlimitedâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 é…ç½®å­—æ®µè¯¦è§£


#### ğŸ¯ Domainå­—æ®µï¼ˆç”¨æˆ·/ç»„æ ‡è¯†ï¼‰


**è¯­æ³•è§„åˆ™**ï¼š
```
ç”¨æˆ·å        username     â†’ æŒ‡å®šå…·ä½“ç”¨æˆ·
ç»„å          @groupname   â†’ æŒ‡å®šç”¨æˆ·ç»„ï¼ˆå‰é¢åŠ @ç¬¦å·ï¼‰
é€šé…ç¬¦        *           â†’ åŒ¹é…æ‰€æœ‰ç”¨æˆ·
é€šé…ç¬¦        %           â†’ åŒ¹é…æ‰€æœ‰ç”¨æˆ·ç»„
```

**å®é™…ç¤ºä¾‹**ï¼š
```bash
# å…·ä½“ç”¨æˆ·
tom     hard    nofile    8192
jerry   soft    nproc     512

# ç”¨æˆ·ç»„ï¼ˆæ³¨æ„@ç¬¦å·ï¼‰
@wheel  hard    memlock   unlimited
@users  soft    core      0

# é€šé…ç¬¦
*       soft    nofile    1024
%       hard    nproc     2048
```

#### ğŸ”§ Typeå­—æ®µï¼ˆé™åˆ¶ç±»å‹ï¼‰


**é™åˆ¶ç±»å‹è¯´æ˜**ï¼š
| ç±»å‹ | **å«ä¹‰** | **è¯´æ˜** |
|------|----------|----------|
| `soft` | **è½¯é™åˆ¶** | ç”¨æˆ·å¯ä»¥è¶…è¿‡ï¼Œä½†ä¼šæ”¶åˆ°è­¦å‘Š |
| `hard` | **ç¡¬é™åˆ¶** | ç»å¯¹ä¸èƒ½è¶…è¿‡çš„ä¸Šé™ |
| `-` | **åŒæ—¶è®¾ç½®** | åŒæ—¶è®¾ç½®softå’Œhardä¸ºç›¸åŒå€¼ |

**é€šä¿—ç†è§£**ï¼š
```
ç±»æ¯”æ±½è½¦é™é€Ÿï¼š
ğŸŸ¡ softé™åˆ¶ = å»ºè®®æ—¶é€Ÿ80km/hï¼ˆè¶…è¿‡ä¼šæœ‰è­¦å‘Šï¼Œä½†ä¸ä¼šå¼ºåˆ¶åœè½¦ï¼‰
ğŸ”´ hardé™åˆ¶ = æœ€é«˜æ—¶é€Ÿ120km/hï¼ˆè¶…è¿‡ç«‹å³å¼ºåˆ¶é™åˆ¶ï¼‰
ğŸ”µ -é™åˆ¶   = ç»Ÿä¸€è®¾å®šä¸º100km/hï¼ˆè½¯ç¡¬é™åˆ¶ç›¸åŒï¼‰
```

#### ğŸ“Š Itemå­—æ®µï¼ˆèµ„æºé¡¹ç›®ï¼‰


**å¸¸ç”¨èµ„æºé¡¹ç›®**ï¼š
```bash
# æ–‡ä»¶ç›¸å…³
nofile          # æœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°
fsize           # æœ€å¤§æ–‡ä»¶å¤§å°(KB)

# è¿›ç¨‹ç›¸å…³  
nproc           # æœ€å¤§è¿›ç¨‹æ•°
cpu             # CPUæ—¶é—´(åˆ†é’Ÿ)

# å†…å­˜ç›¸å…³
memlock         # æœ€å¤§é”å®šå†…å­˜(KB)  
rss             # æœ€å¤§ç‰©ç†å†…å­˜(KB)
as              # æœ€å¤§è™šæ‹Ÿå†…å­˜(KB)

# å…¶ä»–èµ„æº
core            # coreæ–‡ä»¶å¤§å°(KB)
priority        # è¿›ç¨‹ä¼˜å…ˆçº§
locks           # æœ€å¤§æ–‡ä»¶é”æ•°é‡
```

#### ğŸ”¢ Valueå­—æ®µï¼ˆé™åˆ¶å€¼ï¼‰


**æ•°å€¼è®¾ç½®**ï¼š
```bash
unlimited       # æ— é™åˆ¶
0              # ç¦ç”¨è¯¥èµ„æº
å…·ä½“æ•°å€¼        # å¦‚ï¼š1024ã€65536ç­‰
```

### 2.3 å®Œæ•´é…ç½®ç¤ºä¾‹


```bash
# /etc/security/limits.confç¤ºä¾‹

# ç³»ç»Ÿç®¡ç†å‘˜æ— é™åˆ¶
root            -       nofile          unlimited
root            -       nproc           unlimited

# æ™®é€šç”¨æˆ·åŸºç¡€é™åˆ¶
*               soft    nofile          1024
*               hard    nofile          65536
*               soft    nproc           1024  
*               hard    nproc           4096

# WebæœåŠ¡ç”¨æˆ·ç‰¹æ®Šé…ç½®
www             -       nofile          65536
www             -       nproc           2048
www             hard    memlock         unlimited

# å¼€å‘è€…ç»„é…ç½®
@developers     soft    nofile          8192
@developers     hard    nofile          16384
@developers     soft    core            unlimited

# ç¦ç”¨core dump
@users          hard    core            0
```

---

## 3. ğŸ‘¥ ç”¨æˆ·ä¸ç»„é™åˆ¶é…ç½®


### 3.1 ç”¨æˆ·ç‰¹å®šé…ç½®


**ä¸ªäººç”¨æˆ·é…ç½®**ï¼š
```bash
# ä¸ºç‰¹å®šç”¨æˆ·è®¾ç½®é™åˆ¶
alice           soft    nofile          2048    # Aliceè½¯é™åˆ¶2048ä¸ªæ–‡ä»¶
alice           hard    nofile          4096    # Aliceç¡¬é™åˆ¶4096ä¸ªæ–‡ä»¶
bob             -       nproc           512     # Bobè¿›ç¨‹æ•°ç»Ÿä¸€é™åˆ¶512

# Webåº”ç”¨ç”¨æˆ·
www-data        soft    nofile          8192
www-data        hard    nofile          16384
www-data        soft    memlock         64
```

**é…ç½®è¯´æ˜**ï¼š
```
å®é™…åº”ç”¨åœºæ™¯ï¼š

ğŸ“Š æ•°æ®åº“ç®¡ç†å‘˜ï¼š
mysql          -       nofile          65536   # éœ€è¦å¤§é‡æ–‡ä»¶å¥æŸ„
mysql          soft    memlock         unlimited # å…è®¸é”å®šæ›´å¤šå†…å­˜

ğŸŒ WebæœåŠ¡å™¨ï¼š  
nginx          -       nofile          32768   # é«˜å¹¶å‘éœ€è¦æ›´å¤šæ–‡ä»¶æè¿°ç¬¦
apache         soft    nproc           1024    # æ§åˆ¶è¿›ç¨‹æ•°é‡

ğŸ’» å¼€å‘äººå‘˜ï¼š
developer      soft    core            unlimited # å…è®¸ç”Ÿæˆè°ƒè¯•æ–‡ä»¶
developer      hard    fsize           unlimited # å…è®¸åˆ›å»ºå¤§æ–‡ä»¶
```

### 3.2 ç”¨æˆ·ç»„é…ç½®


**ç»„é…ç½®è¯­æ³•**ï¼š
```bash
# ç”¨æˆ·ç»„é…ç½®ï¼ˆå‰ç¼€@ç¬¦å·ï¼‰
@admin          -       nofile          unlimited
@wheel          hard    nproc           unlimited  
@users          soft    nofile          1024
@guest          hard    nproc           128
```

**ç»„é…ç½®ä¼˜åŠ¿**ï¼š
- ğŸ“‹ **æ‰¹é‡ç®¡ç†** - ä¸€æ¬¡é…ç½®å½±å“æ•´ä¸ªç»„
- ğŸ”„ **åŠ¨æ€ç”Ÿæ•ˆ** - ç”¨æˆ·åŠ å…¥ç»„åè‡ªåŠ¨è·å¾—é™åˆ¶
- ğŸ¯ **è§’è‰²åŒ–ç®¡ç†** - æŒ‰èŒèƒ½è®¾ç½®ä¸åŒé™åˆ¶

**å®é™…ç»„é…ç½®ç¤ºä¾‹**ï¼š
```bash
# ç³»ç»Ÿç®¡ç†ç»„
@wheel          -       nofile          unlimited
@wheel          -       nproc           unlimited
@wheel          -       memlock         unlimited

# æ™®é€šç”¨æˆ·ç»„  
@users          soft    nofile          1024
@users          hard    nofile          4096
@users          soft    nproc           512
@users          hard    nproc           1024

# å—é™ç”¨æˆ·ç»„
@restricted     hard    nofile          256
@restricted     hard    nproc           32
@restricted     hard    fsize           10240    # 10MBæ–‡ä»¶å¤§å°é™åˆ¶
@restricted     hard    cpu             30       # 30åˆ†é’ŸCPUæ—¶é—´

# æœåŠ¡å™¨ç»„
@servers        -       nofile          65536
@servers        soft    memlock         256000
@servers        hard    memlock         unlimited
```

### 3.3 ç”¨æˆ·ä¸ç»„çš„ä¼˜å…ˆçº§å…³ç³»


**ä¼˜å…ˆçº§è§„åˆ™**ï¼š
```
ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š
1ï¸âƒ£ å…·ä½“ç”¨æˆ·é…ç½®
2ï¸âƒ£ ç”¨æˆ·æ‰€å±ç»„é…ç½®  
3ï¸âƒ£ é€šé…ç¬¦é…ç½®(*)
```

**ä¼˜å…ˆçº§ç¤ºä¾‹**ï¼š
```bash
# é…ç½®æ–‡ä»¶å†…å®¹
*               soft    nofile          1024    # é€šé…ç¬¦ï¼šæ‰€æœ‰ç”¨æˆ·1024
@developers     soft    nofile          2048    # å¼€å‘ç»„ï¼š2048  
alice           soft    nofile          4096    # Aliceç”¨æˆ·ï¼š4096

# Aliceæ˜¯developersç»„æˆå‘˜ï¼Œæœ€ç»ˆé™åˆ¶ï¼š
# Aliceå®é™…ç”Ÿæ•ˆï¼š4096ï¼ˆç”¨æˆ·é…ç½®ä¼˜å…ˆçº§æœ€é«˜ï¼‰
# å…¶ä»–developersç»„æˆå‘˜ï¼š2048ï¼ˆç»„é…ç½®ï¼‰
# æ™®é€šç”¨æˆ·ï¼š1024ï¼ˆé€šé…ç¬¦é…ç½®ï¼‰
```

---

## 4. ğŸ›ï¸ softä¸hardé™åˆ¶è¯¦è§£


### 4.1 softé™åˆ¶ï¼ˆè½¯é™åˆ¶ï¼‰


**åŸºæœ¬æ¦‚å¿µ**ï¼š
è½¯é™åˆ¶æ˜¯**å»ºè®®æ€§é™åˆ¶**ï¼Œç”¨æˆ·å¯ä»¥ä¸´æ—¶è¶…è¿‡è¿™ä¸ªé™åˆ¶ï¼Œä½†ç³»ç»Ÿä¼šç»™å‡ºè­¦å‘Šã€‚

**ç‰¹ç‚¹**ï¼š
- âš ï¸ **å¯ä»¥è¶…è¿‡** - ä¸æ˜¯å¼ºåˆ¶æ€§é™åˆ¶
- ğŸ“¢ **ä¼šæœ‰è­¦å‘Š** - è¶…è¿‡æ—¶ç³»ç»Ÿæç¤º
- ğŸ”§ **ç”¨æˆ·å¯è°ƒæ•´** - æ™®é€šç”¨æˆ·å¯ä»¥åœ¨ç¡¬é™åˆ¶èŒƒå›´å†…è°ƒæ•´è½¯é™åˆ¶

**å®é™…è¡Œä¸º**ï¼š
```bash
# è®¾ç½®è½¯é™åˆ¶
alice    soft    nofile    1024

# Aliceå¯ä»¥è¿™æ ·æ“ä½œï¼š
$ ulimit -n 2048    # âœ… å¯ä»¥ä¸´æ—¶æé«˜åˆ°2048ï¼ˆå¦‚æœç¡¬é™åˆ¶å…è®¸ï¼‰
$ ulimit -n 512     # âœ… å¯ä»¥é™ä½åˆ°512
```

### 4.2 hardé™åˆ¶ï¼ˆç¡¬é™åˆ¶ï¼‰


**åŸºæœ¬æ¦‚å¿µ**ï¼š
ç¡¬é™åˆ¶æ˜¯**å¼ºåˆ¶æ€§é™åˆ¶**ï¼Œç»å¯¹ä¸èƒ½è¶…è¿‡çš„ä¸Šé™ã€‚

**ç‰¹ç‚¹**ï¼š
- ğŸš« **ç»ä¸èƒ½è¶…è¿‡** - å¼ºåˆ¶æ€§é™åˆ¶
- ğŸ”’ **éœ€è¦rootæƒé™** - åªæœ‰rootæ‰èƒ½ä¿®æ”¹ç¡¬é™åˆ¶
- ğŸ“Š **è½¯é™åˆ¶ä¸Šé™** - è½¯é™åˆ¶ä¸èƒ½è¶…è¿‡ç¡¬é™åˆ¶

**å®é™…è¡Œä¸º**ï¼š
```bash
# è®¾ç½®ç¡¬é™åˆ¶
alice    hard    nofile    4096

# Aliceçš„æ“ä½œé™åˆ¶ï¼š
$ ulimit -n 5000    # âŒ å¤±è´¥ï¼è¶…è¿‡ç¡¬é™åˆ¶
$ ulimit -n 4000    # âœ… æˆåŠŸï¼åœ¨ç¡¬é™åˆ¶èŒƒå›´å†…
```

### 4.3 softä¸hardçš„å…³ç³»


**åŸºæœ¬å…³ç³»**ï¼š
```
è½¯é™åˆ¶ â‰¤ ç¡¬é™åˆ¶

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é™åˆ¶ç±»å‹   â”‚      æƒé™       â”‚     å¯è¶…è¿‡å—      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ softè½¯é™åˆ¶  â”‚ ç”¨æˆ·å¯è‡ªè¡Œè°ƒæ•´   â”‚ âœ… å¯ä»¥ä¸´æ—¶è¶…è¿‡    â”‚
â”‚ hardç¡¬é™åˆ¶  â”‚ éœ€è¦rootæƒé™    â”‚ âŒ ç»å¯¹ä¸èƒ½è¶…è¿‡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®å…³ç³»å›¾**ï¼š
```
Hard Limit (4096) â†â”€â”€â”€ ç»å¯¹ä¸Šé™ï¼Œä¸å¯è¶…è¿‡
    â†‘
    â”‚ è½¯é™åˆ¶å¯åœ¨æ­¤èŒƒå›´å†…è°ƒæ•´
    â”‚
Soft Limit (1024) â†â”€â”€â”€ å»ºè®®å€¼ï¼Œå¯ä¸´æ—¶è¶…è¿‡
    â†“
å®é™…ä½¿ç”¨ (800)    â†â”€â”€â”€ å½“å‰å®é™…ä½¿ç”¨é‡
```

### 4.4 ç»Ÿä¸€è®¾ç½®ï¼ˆ-æ ‡è¯†ç¬¦ï¼‰


**è¯­æ³•**ï¼š
```bash
# ä½¿ç”¨"-"åŒæ—¶è®¾ç½®softå’Œhardä¸ºç›¸åŒå€¼
alice    -    nofile    2048

# ç­‰ä»·äºï¼š
alice    soft    nofile    2048
alice    hard    nofile    2048
```

**ä½¿ç”¨åœºæ™¯**ï¼š
```bash
# æœåŠ¡å™¨ç”¨æˆ·ç»Ÿä¸€é™åˆ¶
nginx    -    nofile     16384   # nginxè½¯ç¡¬é™åˆ¶éƒ½æ˜¯16384
mysql    -    memlock    64000   # mysqlå†…å­˜é”å®šç»Ÿä¸€é™åˆ¶

# å—é™ç”¨æˆ·ä¸¥æ ¼æ§åˆ¶
guest    -    nproc      64      # guestç”¨æˆ·è¿›ç¨‹æ•°ä¸¥æ ¼é™åˆ¶64
temp     -    fsize      1024    # ä¸´æ—¶ç”¨æˆ·æ–‡ä»¶å¤§å°ä¸¥æ ¼é™åˆ¶1MB
```

### 4.5 å®é™…åº”ç”¨å¯¹æ¯”


**åœºæ™¯ä¸€ï¼šå¼€å‘ç¯å¢ƒ**
```bash
# å¼€å‘äººå‘˜éœ€è¦çµæ´»æ€§
developer    soft    nofile    2048     # å¹³æ—¶å¤Ÿç”¨
developer    hard    nofile    8192     # ç¼–è¯‘å¤§é¡¹ç›®æ—¶å¯ä¸´æ—¶è°ƒé«˜

# å¼€å‘è€…å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ï¼š
$ ulimit -n 4096    # ç¼–è¯‘å¤§é¡¹ç›®æ—¶ä¸´æ—¶æé«˜
```

**åœºæ™¯äºŒï¼šç”Ÿäº§ç¯å¢ƒ**
```bash
# ç”Ÿäº§æœåŠ¡å™¨éœ€è¦ç¨³å®š
webserver    -    nofile    4096        # ç»Ÿä¸€é™åˆ¶ï¼Œä¸å…è®¸éšæ„è°ƒæ•´

# ç³»ç»Ÿç®¡ç†å‘˜é¢„è®¾å›ºå®šå€¼ï¼ŒæœåŠ¡ç¨³å®šè¿è¡Œ
```

**åœºæ™¯ä¸‰ï¼šå—é™ç¯å¢ƒ**
```bash
# å…±äº«ä¸»æœºä¸¥æ ¼æ§åˆ¶
@shared      hard    nproc     128      # ç¡¬é™åˆ¶ï¼Œç»ä¸èƒ½è¶…è¿‡
@shared      soft    nproc     64       # è½¯é™åˆ¶ï¼Œå»ºè®®å€¼

# ç”¨æˆ·åªèƒ½åœ¨64-128ä¹‹é—´è°ƒæ•´
```

---

## 5. ğŸ“ limits.dç›®å½•åˆ†ç‰‡ç®¡ç†


### 5.1 limits.dç›®å½•ä»‹ç»


**ç›®å½•ä½ç½®**ï¼š
```bash
/etc/security/limits.d/
```

**è®¾è®¡ç†å¿µ**ï¼š
- ğŸ§© **åˆ†ç‰‡ç®¡ç†** - æŒ‰åº”ç”¨æˆ–æœåŠ¡åˆ†åˆ«é…ç½®
- ğŸ”„ **ä¾¿äºç»´æŠ¤** - é¿å…å•æ–‡ä»¶è¿‡å¤§éš¾ä»¥ç®¡ç†  
- ğŸ“¦ **è½¯ä»¶åŒ…ç®¡ç†** - å„è½¯ä»¶å¯ä»¥ç‹¬ç«‹å®‰è£…è‡ªå·±çš„é™åˆ¶é…ç½®

**ç›®å½•ç»“æ„ç¤ºä¾‹**ï¼š
```
/etc/security/limits.d/
â”œâ”€â”€ 90-nproc.conf           # ç³»ç»Ÿé»˜è®¤è¿›ç¨‹æ•°é™åˆ¶
â”œâ”€â”€ mysql.conf              # MySQLæ•°æ®åº“é™åˆ¶
â”œâ”€â”€ nginx.conf              # Nginx WebæœåŠ¡å™¨é™åˆ¶
â”œâ”€â”€ 99-custom.conf          # è‡ªå®šä¹‰é…ç½®
â””â”€â”€ docker.conf             # Dockerå®¹å™¨é™åˆ¶
```

### 5.2 é…ç½®æ–‡ä»¶å‘½åè§„åˆ™


**å‘½åçº¦å®š**ï¼š
```bash
# æ•°å­—å‰ç¼€æ§åˆ¶åŠ è½½é¡ºåº
10-system.conf              # ç³»ç»ŸåŸºç¡€é…ç½®ï¼ˆæœ€å…ˆåŠ è½½ï¼‰
50-applications.conf        # åº”ç”¨ç¨‹åºé…ç½®
90-nproc.conf              # ç³»ç»Ÿé»˜è®¤é…ç½®
99-custom.conf             # ç”¨æˆ·è‡ªå®šä¹‰é…ç½®ï¼ˆæœ€ååŠ è½½ï¼‰

# æŒ‰æœåŠ¡å‘½å
mysql.conf                 # MySQLä¸“ç”¨é…ç½®
apache.conf                # Apacheä¸“ç”¨é…ç½®
nginx.conf                 # Nginxä¸“ç”¨é…ç½®
```

**æ–‡ä»¶æ‰©å±•å**ï¼š
```bash
# åªæœ‰.confåç¼€çš„æ–‡ä»¶ä¼šè¢«è¯»å–
valid.conf          âœ… ä¼šè¢«è¯»å–
invalid.txt         âŒ ä¸ä¼šè¢«è¯»å–  
backup.conf.bak     âŒ ä¸ä¼šè¢«è¯»å–
```

### 5.3 åˆ†ç‰‡é…ç½®ç¤ºä¾‹


**MySQLé…ç½®æ–‡ä»¶** (`/etc/security/limits.d/mysql.conf`)ï¼š
```bash
# MySQLæ•°æ®åº“æœåŠ¡é™åˆ¶é…ç½®
mysql           soft    nofile          8192
mysql           hard    nofile          16384
mysql           soft    memlock         unlimited
mysql           hard    memlock         unlimited
mysql           soft    nproc           2048
mysql           hard    nproc           4096
```

**Nginxé…ç½®æ–‡ä»¶** (`/etc/security/limits.d/nginx.conf`)ï¼š
```bash
# Nginx WebæœåŠ¡å™¨é™åˆ¶é…ç½®  
nginx           soft    nofile          32768
nginx           hard    nofile          65536
nginx           soft    nproc           1024
nginx           hard    nproc           2048
```

**å¼€å‘è€…é…ç½®æ–‡ä»¶** (`/etc/security/limits.d/developers.conf`)ï¼š
```bash
# å¼€å‘äººå‘˜ä¸“ç”¨é…ç½®
@developers     soft    nofile          4096
@developers     hard    nofile          16384
@developers     soft    core            unlimited
@developers     hard    fsize           unlimited
```

### 5.4 é…ç½®ä¼˜å…ˆçº§ä¸åˆå¹¶è§„åˆ™


**åŠ è½½é¡ºåº**ï¼š
```
åŠ è½½é¡ºåºï¼ˆæŒ‰æ–‡ä»¶åæ’åºï¼‰ï¼š
1ï¸âƒ£ /etc/security/limits.conf         # ä¸»é…ç½®æ–‡ä»¶
2ï¸âƒ£ /etc/security/limits.d/*.conf     # æŒ‰æ–‡ä»¶åå­—æ¯é¡ºåºåŠ è½½
```

**åˆå¹¶è§„åˆ™**ï¼š
```bash
# ç¤ºä¾‹ï¼šåŒä¸€ç”¨æˆ·åœ¨ä¸åŒæ–‡ä»¶ä¸­çš„é…ç½®

# /etc/security/limits.conf
alice    soft    nofile    1024

# /etc/security/limits.d/50-users.conf  
alice    hard    nofile    4096

# /etc/security/limits.d/99-custom.conf
alice    soft    nproc     512

# æœ€ç»ˆç”Ÿæ•ˆé…ç½®ï¼š
alice    soft    nofile    1024    # æ¥è‡ªä¸»é…ç½®æ–‡ä»¶
alice    hard    nofile    4096    # æ¥è‡ª50-users.conf
alice    soft    nproc     512     # æ¥è‡ª99-custom.conf
```

### 5.5 åˆ†ç‰‡ç®¡ç†æœ€ä½³å®è·µ


**æ¨èç›®å½•ç»“æ„**ï¼š
```bash
/etc/security/limits.d/
â”œâ”€â”€ 10-system-default.conf     # ç³»ç»Ÿé»˜è®¤é…ç½®
â”œâ”€â”€ 20-system-users.conf       # ç³»ç»Ÿç”¨æˆ·é…ç½®
â”œâ”€â”€ 50-application-mysql.conf  # MySQLåº”ç”¨é…ç½®
â”œâ”€â”€ 50-application-nginx.conf  # Nginxåº”ç”¨é…ç½®
â”œâ”€â”€ 80-user-groups.conf        # ç”¨æˆ·ç»„é…ç½®
â”œâ”€â”€ 90-nproc.conf              # ä¿æŒç³»ç»Ÿé»˜è®¤
â””â”€â”€ 99-local-custom.conf       # æœ¬åœ°è‡ªå®šä¹‰é…ç½®
```

**é…ç½®æ–‡ä»¶æ¨¡æ¿**ï¼š
```bash
# æ¨¡æ¿ï¼šåº”ç”¨ä¸“ç”¨é…ç½®æ–‡ä»¶å¤´éƒ¨
# ================================================================
# Application: MySQL Database Server
# Purpose: Resource limits for MySQL service
# Maintained by: Database Team
# Last updated: 2024-09-14
# ================================================================

mysql           soft    nofile          8192
mysql           hard    nofile          16384
# ... å…¶ä»–é…ç½®
```

---

## 6. ğŸ”Œ PAMæ¨¡å—é›†æˆé…ç½®


### 6.1 PAMæ¨¡å—æ¦‚è¿°


**ä»€ä¹ˆæ˜¯PAM**ï¼š
PAMï¼ˆPluggable Authentication Modulesï¼‰æ˜¯Linuxç³»ç»Ÿçš„**è®¤è¯æ¨¡å—ç³»ç»Ÿ**ã€‚ç®€å•ç†è§£ï¼ŒPAMå°±åƒä¸€ä¸ª"é—¨å«ç³»ç»Ÿ"ï¼Œç®¡ç†ç”¨æˆ·ç™»å½•å’Œä½¿ç”¨ç³»ç»Ÿèµ„æºçš„æƒé™ã€‚

**PAMä¸limitsçš„å…³ç³»**ï¼š
```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·ç™»å½•   â”‚â”€â”€â”€â†’â”‚  PAMè®¤è¯    â”‚â”€â”€â”€â†’â”‚ åŠ è½½limits  â”‚
â”‚  ssh/login  â”‚    â”‚   æ£€æŸ¥      â”‚    â”‚   é…ç½®     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                  pam_limits.soæ¨¡å—
                  è¯»å–limits.confé…ç½®
```

### 6.2 pam_limits.soæ¨¡å—


**æ¨¡å—ä½œç”¨**ï¼š
`pam_limits.so`æ˜¯PAMä¸­è´Ÿè´£**è¯»å–å’Œåº”ç”¨limits.confé…ç½®**çš„æ¨¡å—ã€‚

**æ¨¡å—ä½ç½®**ï¼š
```bash
/lib64/security/pam_limits.so
# æˆ–è€…
/lib/security/pam_limits.so
```

**å·¥ä½œæœºåˆ¶**ï¼š
1. ç”¨æˆ·ç™»å½•æ—¶ï¼ŒPAMè°ƒç”¨pam_limits.so
2. pam_limits.soè¯»å–limits.confé…ç½®
3. æ ¹æ®ç”¨æˆ·èº«ä»½åº”ç”¨ç›¸åº”çš„èµ„æºé™åˆ¶
4. è®¾ç½®ç”¨æˆ·ä¼šè¯çš„èµ„æºé™åˆ¶

### 6.3 PAMé…ç½®æ–‡ä»¶è®¾ç½®


**å¸¸è§PAMé…ç½®æ–‡ä»¶**ï¼š
```bash
/etc/pam.d/login        # æ§åˆ¶å°ç™»å½•
/etc/pam.d/sshd         # SSHç™»å½•  
/etc/pam.d/su           # suå‘½ä»¤
/etc/pam.d/sudo         # sudoå‘½ä»¤
/etc/pam.d/system-auth  # ç³»ç»Ÿè®¤è¯
```

**pam_limitsé…ç½®è¯­æ³•**ï¼š
```bash
# åŸºæœ¬æ ¼å¼
session required pam_limits.so

# å¸¦å‚æ•°æ ¼å¼  
session required pam_limits.so conf=/etc/security/limits.conf
session required pam_limits.so debug
```

### 6.4 å®é™…PAMé…ç½®ç¤ºä¾‹


**SSHç™»å½•é…ç½®** (`/etc/pam.d/sshd`)ï¼š
```bash
#%PAM-1.0
auth       required     pam_sepermit.so
auth       substack     password-auth
auth       include      postlogin
account    required     pam_nologin.so
account    include      password-auth
password   include      password-auth
# pam_selinux.so close should be the first session rule
session    required     pam_selinux.so close
session    required     pam_loginuid.so
# pam_selinux.so open should only be followed by sessions to be executed in the user context
session    required     pam_selinux.so open env_params
session    required     pam_limits.so                    # â†â”€â”€ è¿™é‡ŒåŠ è½½limitsé…ç½®
session    optional     pam_keyinit.so force revoke
session    include      password-auth
session    include      postlogin
```

**ç³»ç»Ÿè®¤è¯é…ç½®** (`/etc/pam.d/system-auth`)ï¼š
```bash
#%PAM-1.0
# è®¤è¯é˜¶æ®µ
auth        required      pam_env.so
auth        required      pam_faildelay.so delay=2000000
auth        sufficient    pam_unix.so nullok try_first_pass
auth        requisite     pam_succeed_if.so uid >= 1000 quiet_success
auth        required      pam_deny.so

# è´¦æˆ·éªŒè¯é˜¶æ®µ
account     required      pam_unix.so
account     sufficient    pam_localuser.so
account     sufficient    pam_succeed_if.so uid < 1000 quiet
account     required      pam_permit.so

# å¯†ç ç®¡ç†é˜¶æ®µ
password    requisite     pam_pwquality.so try_first_pass local_users_only
password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass
password    required      pam_deny.so

# ä¼šè¯ç®¡ç†é˜¶æ®µ
session     optional      pam_keyinit.so revoke
session     required      pam_limits.so                  # â†â”€â”€ åŠ è½½èµ„æºé™åˆ¶
session     optional      pam_systemd.so
session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
session     required      pam_unix.so
```

### 6.5 PAMæ¨¡å—å‚æ•°é…ç½®


**å¸¸ç”¨å‚æ•°**ï¼š
```bash
# åŸºæœ¬é…ç½®ï¼ˆæ¨èï¼‰
session required pam_limits.so

# æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„
session required pam_limits.so conf=/etc/security/limits.conf

# å¼€å¯è°ƒè¯•æ¨¡å¼
session required pam_limits.so debug

# ä¿®æ”¹utmpè®°å½•
session required pam_limits.so change_uid

# ç»„åˆå‚æ•°ä½¿ç”¨
session required pam_limits.so conf=/etc/security/limits.conf debug
```

**å‚æ•°è¯´æ˜**ï¼š
| å‚æ•° | **ä½œç”¨** | **ä½¿ç”¨åœºæ™¯** |
|------|----------|-------------|
| `conf=file` | æŒ‡å®šé…ç½®æ–‡ä»¶ | ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶æ—¶ |
| `debug` | å¼€å¯è°ƒè¯•æ—¥å¿— | æ’æŸ¥é…ç½®é—®é¢˜æ—¶ |
| `change_uid` | ä¿®æ”¹utmpè®°å½• | ç‰¹æ®Šè®¤è¯éœ€æ±‚ |
| `utmp_early` | æå‰å¤„ç†utmp | å¤æ‚ç™»å½•æµç¨‹ |

### 6.6 PAMé…ç½®éªŒè¯


**æ£€æŸ¥PAMé…ç½®**ï¼š
```bash
# æŸ¥çœ‹SSHçš„PAMé…ç½®
$ cat /etc/pam.d/sshd | grep limits
session    required     pam_limits.so

# æ£€æŸ¥pam_limits.soæ¨¡å—æ˜¯å¦å­˜åœ¨
$ find /lib* -name "pam_limits.so" 2>/dev/null
/lib64/security/pam_limits.so

# æŸ¥çœ‹æ¨¡å—ä¿¡æ¯
$ ldd /lib64/security/pam_limits.so
```

**è°ƒè¯•PAMé…ç½®**ï¼š
```bash
# ä¸´æ—¶å¼€å¯è°ƒè¯•æ¨¡å¼
session required pam_limits.so debug

# æŸ¥çœ‹è°ƒè¯•æ—¥å¿—
$ tail -f /var/log/secure | grep limits
Sep 14 10:30:15 server pam_limits[1234]: reading settings from '/etc/security/limits.conf'
Sep 14 10:30:15 server pam_limits[1234]: user 'alice' matched rule '*'
```

---

## 7. âœ… é…ç½®ç”Ÿæ•ˆæœºåˆ¶ä¸éªŒè¯


### 7.1 é…ç½®ç”Ÿæ•ˆæœºåˆ¶


**ç”Ÿæ•ˆæ—¶æœº**ï¼š
limits.confçš„é…ç½®**ä¸æ˜¯ç«‹å³ç”Ÿæ•ˆ**çš„ï¼Œéœ€è¦ç”¨æˆ·é‡æ–°ç™»å½•ã€‚

**ç”Ÿæ•ˆæµç¨‹**ï¼š
```
é…ç½®ç”Ÿæ•ˆæµç¨‹ï¼š
1ï¸âƒ£ ä¿®æ”¹limits.confé…ç½®æ–‡ä»¶
2ï¸âƒ£ ç”¨æˆ·é‡æ–°ç™»å½•ï¼ˆæ–°å»ºä¼šè¯ï¼‰
3ï¸âƒ£ PAMè°ƒç”¨pam_limits.soæ¨¡å—
4ï¸âƒ£ è¯»å–é…ç½®æ–‡ä»¶å¹¶åº”ç”¨é™åˆ¶
5ï¸âƒ£ è®¾ç½®å½“å‰ä¼šè¯çš„èµ„æºé™åˆ¶
```

**é‡è¦æ¦‚å¿µ**ï¼š
- ğŸ”„ **ä¼šè¯çº§ç”Ÿæ•ˆ** - åªå¯¹æ–°ç™»å½•ä¼šè¯ç”Ÿæ•ˆ
- â° **ä¸å½±å“å·²æœ‰ä¼šè¯** - å·²ç»ç™»å½•çš„ç”¨æˆ·ä¸å—å½±å“
- ğŸ¯ **ç»§æ‰¿æœºåˆ¶** - æ–°å¯åŠ¨çš„è¿›ç¨‹ç»§æ‰¿ä¼šè¯é™åˆ¶

### 7.2 éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆ


**ä½¿ç”¨ulimitå‘½ä»¤éªŒè¯**ï¼š
```bash
# æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„æ‰€æœ‰é™åˆ¶
$ ulimit -a
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 15663
max locked memory       (kbytes, -l) 64
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1024      # â†â”€â”€ æ–‡ä»¶æ‰“å¼€æ•°é™åˆ¶
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 4096      # â†â”€â”€ è¿›ç¨‹æ•°é™åˆ¶
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
```

**é’ˆå¯¹æ€§æŸ¥çœ‹ç‰¹å®šé™åˆ¶**ï¼š
```bash
# æŸ¥çœ‹æ–‡ä»¶æ‰“å¼€æ•°é™åˆ¶
$ ulimit -n
1024

# æŸ¥çœ‹è¿›ç¨‹æ•°é™åˆ¶  
$ ulimit -u
4096

# æŸ¥çœ‹coreæ–‡ä»¶å¤§å°é™åˆ¶
$ ulimit -c
0

# æŸ¥çœ‹å†…å­˜é”å®šé™åˆ¶
$ ulimit -l
64
```

### 7.3 æµ‹è¯•å…·ä½“ç”¨æˆ·é™åˆ¶


**åˆ‡æ¢ç”¨æˆ·æµ‹è¯•**ï¼š
```bash
# åˆ‡æ¢åˆ°æŒ‡å®šç”¨æˆ·æŸ¥çœ‹é™åˆ¶
$ su - alice
$ ulimit -a

# æˆ–è€…ç›´æ¥ä»¥æŒ‡å®šç”¨æˆ·èº«ä»½æ‰§è¡Œå‘½ä»¤
$ su - alice -c "ulimit -n"
2048
```

**SSHç™»å½•æµ‹è¯•**ï¼š
```bash
# SSHç™»å½•æµ‹è¯•ï¼ˆæ›´æ¥è¿‘çœŸå®åœºæ™¯ï¼‰
$ ssh alice@localhost
alice@server:~$ ulimit -n
2048

alice@server:~$ ulimit -u  
1024
```

### 7.4 éªŒè¯é…ç½®è¯»å–è¿‡ç¨‹


**æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•**ï¼š
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯
$ sudo /sbin/pam_limits_check

# æˆ–è€…æ‰‹åŠ¨æ£€æŸ¥
$ awk '/^[^#]/ {print NR": "$0}' /etc/security/limits.conf
```

**æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—**ï¼š
```bash
# æŸ¥çœ‹PAMç›¸å…³æ—¥å¿—
$ sudo tail -f /var/log/secure | grep pam_limits

# æˆ–è€…æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
$ sudo journalctl -u systemd-logind | grep limits
```

### 7.5 å¼ºåˆ¶é…ç½®ç«‹å³ç”Ÿæ•ˆ


**æ–¹æ³•ä¸€ï¼šé‡æ–°ç™»å½•**ï¼ˆæ¨èï¼‰
```bash
# é€€å‡ºå½“å‰ä¼šè¯
$ exit

# é‡æ–°ç™»å½•
$ ssh user@hostname
```

**æ–¹æ³•äºŒï¼šä½¿ç”¨execå‘½ä»¤**
```bash
# åœ¨å½“å‰shellä¸­æ‰§è¡Œæ–°çš„bash
$ exec bash -l

# éªŒè¯é…ç½®
$ ulimit -n
```

**æ–¹æ³•ä¸‰ï¼šsystemdç”¨æˆ·ä¼šè¯é‡è½½**ï¼ˆä»…é™systemdç³»ç»Ÿï¼‰
```bash
# é‡è½½ç”¨æˆ·ä¼šè¯ç®¡ç†å™¨
$ sudo systemctl reload systemd-logind

# é‡æ–°ç™»å½•ç”Ÿæ•ˆ
```

### 7.6 éªŒè¯é…ç½®çš„å®Œæ•´æµç¨‹


**å®Œæ•´éªŒè¯æ­¥éª¤**ï¼š
```bash
# æ­¥éª¤1ï¼šä¿®æ”¹é…ç½®
$ sudo vim /etc/security/limits.conf
alice    soft    nofile    2048
alice    hard    nofile    4096

# æ­¥éª¤2ï¼šæ£€æŸ¥è¯­æ³•
$ sudo awk '/alice/ {print}' /etc/security/limits.conf
alice    soft    nofile    2048
alice    hard    nofile    4096

# æ­¥éª¤3ï¼šç”¨æˆ·é‡æ–°ç™»å½•
$ ssh alice@localhost

# æ­¥éª¤4ï¼šéªŒè¯ç”Ÿæ•ˆ
alice@server:~$ ulimit -n
2048

alice@server:~$ ulimit -Hn  # æŸ¥çœ‹ç¡¬é™åˆ¶
4096

# æ­¥éª¤5ï¼šæµ‹è¯•è°ƒæ•´é™åˆ¶
alice@server:~$ ulimit -n 3000
alice@server:~$ ulimit -n
3000

alice@server:~$ ulimit -n 5000  # è¶…è¿‡ç¡¬é™åˆ¶
bash: ulimit: open files: cannot modify limit: Operation not permitted
```

---

## 8. ğŸ¯ é€šé…ç¬¦ä¸ç‰¹æ®Šé…ç½®


### 8.1 é€šé…ç¬¦ä½¿ç”¨è¯¦è§£


**åŸºæœ¬é€šé…ç¬¦**ï¼š
```bash
*           # åŒ¹é…æ‰€æœ‰ç”¨æˆ·
%           # åŒ¹é…æ‰€æœ‰ç”¨æˆ·ç»„ï¼ˆè¾ƒå°‘ä½¿ç”¨ï¼‰
```

**é€šé…ç¬¦åº”ç”¨ç¤ºä¾‹**ï¼š
```bash
# ä¸ºæ‰€æœ‰ç”¨æˆ·è®¾ç½®åŸºç¡€é™åˆ¶
*               soft    nofile          1024
*               hard    nofile          65536
*               soft    nproc           1024
*               hard    nproc           4096

# ä¸ºæ‰€æœ‰ç”¨æˆ·ç¦ç”¨core dump
*               hard    core            0
```

### 8.2 ç‰¹æ®Šç”¨æˆ·é…ç½®


**ç³»ç»Ÿç”¨æˆ·é…ç½®**ï¼š
```bash
# rootç”¨æˆ·æ— é™åˆ¶ï¼ˆæ¨èé…ç½®ï¼‰
root            -       nofile          unlimited
root            -       nproc           unlimited  
root            -       memlock         unlimited

# ç³»ç»ŸæœåŠ¡ç”¨æˆ·
daemon          -       nofile          8192
bin             -       nproc           64
nobody          -       nofile          1024
```

**æœåŠ¡ä¸“ç”¨ç”¨æˆ·**ï¼š
```bash
# WebæœåŠ¡ç”¨æˆ·
www-data        soft    nofile          16384
www-data        hard    nofile          32768
nginx           -       nofile          65536

# æ•°æ®åº“ç”¨æˆ·  
mysql           soft    nofile          8192
mysql           hard    nofile          16384
mysql           soft    memlock         unlimited

# ç¼“å­˜æœåŠ¡ç”¨æˆ·
redis           -       nofile          10240
memcached       -       memlock         64000
```

### 8.3 ç‰¹æ®Šå€¼é…ç½®


**unlimitedå€¼**ï¼š
```bash
# è®¾ç½®ä¸ºæ— é™åˆ¶
root            -       nofile          unlimited
mysql           soft    memlock         unlimited

# æ³¨æ„ï¼šunlimitedè¦è°¨æ…ä½¿ç”¨ï¼Œå¯èƒ½å½±å“ç³»ç»Ÿç¨³å®šæ€§
```

**é›¶å€¼é…ç½®**ï¼š
```bash
# ç¦ç”¨æŸé¡¹èµ„æº
*               hard    core            0          # ç¦ç”¨core dump
guest           hard    fsize           0          # ç¦ç”¨æ–‡ä»¶åˆ›å»º
temp            hard    cpu             0          # ç¦ç”¨CPUæ—¶é—´ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
```

**æ•°å€¼å•ä½**ï¼š
```bash
# ä¸åŒèµ„æºé¡¹çš„å•ä½
nofile          # ä¸ªæ•°ï¼ˆæ–‡ä»¶æè¿°ç¬¦æ•°é‡ï¼‰
fsize           # KBï¼ˆæ–‡ä»¶å¤§å°ï¼Œå•ä½åƒå­—èŠ‚ï¼‰
memlock         # KBï¼ˆå†…å­˜å¤§å°ï¼Œå•ä½åƒå­—èŠ‚ï¼‰  
nproc           # ä¸ªæ•°ï¼ˆè¿›ç¨‹æ•°é‡ï¼‰
cpu             # åˆ†é’Ÿï¼ˆCPUæ—¶é—´ï¼‰
rss             # KBï¼ˆç‰©ç†å†…å­˜å¤§å°ï¼‰
```

### 8.4 å¤æ‚é…ç½®ç¤ºä¾‹


**åˆ†å±‚é…ç½®ç¤ºä¾‹**ï¼š
```bash
# ç¬¬ä¸€å±‚ï¼šå…¨å±€é»˜è®¤é…ç½®
*               soft    nofile          1024
*               hard    nofile          4096  
*               soft    nproc           512
*               hard    nproc           2048

# ç¬¬äºŒå±‚ï¼šç®¡ç†ç»„é…ç½®
@wheel          -       nofile          unlimited
@wheel          -       nproc           unlimited

# ç¬¬ä¸‰å±‚ï¼šæœåŠ¡ç»„é…ç½®  
@webservers     soft    nofile          8192
@webservers     hard    nofile          16384
@databases      soft    nofile          4096
@databases      hard    memlock         unlimited

# ç¬¬å››å±‚ï¼šç‰¹å®šç”¨æˆ·é…ç½®
nginx           -       nofile          32768
mysql           soft    memlock         256000
redis           -       nofile          10240

# ç¬¬äº”å±‚ï¼šå—é™ç”¨æˆ·é…ç½®
guest           hard    nofile          256
guest           hard    nproc           32
guest           hard    fsize           10240      # 10MB
```

### 8.5 é…ç½®å†²çªå¤„ç†


**ä¼˜å…ˆçº§è§„åˆ™**ï¼š
```
é…ç½®ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
1ï¸âƒ£ å…·ä½“ç”¨æˆ·åé…ç½®
2ï¸âƒ£ ç”¨æˆ·ç»„é…ç½®ï¼ˆ@groupï¼‰
3ï¸âƒ£ é€šé…ç¬¦é…ç½®ï¼ˆ*ï¼‰
```

**å†²çªè§£å†³ç¤ºä¾‹**ï¼š
```bash
# é…ç½®æ–‡ä»¶å†…å®¹
*               soft    nofile          1024    # å…¨å±€é…ç½®
@developers     soft    nofile          2048    # ç»„é…ç½®  
alice           soft    nofile          4096    # ç”¨æˆ·é…ç½®

# aliceæ˜¯developersç»„æˆå‘˜ï¼Œæœ€ç»ˆç”Ÿæ•ˆï¼š
# aliceçš„nofileè½¯é™åˆ¶ = 4096ï¼ˆç”¨æˆ·é…ç½®ä¼˜å…ˆï¼‰

# å…¶ä»–developersç»„æˆå‘˜ï¼š
# å…¶ä»–æˆå‘˜çš„nofileè½¯é™åˆ¶ = 2048ï¼ˆç»„é…ç½®ï¼‰

# æ™®é€šç”¨æˆ·ï¼š
# æ™®é€šç”¨æˆ·nofileè½¯é™åˆ¶ = 1024ï¼ˆé€šé…ç¬¦é…ç½®ï¼‰
```

### 8.6 ç‰¹æ®Šåœºæ™¯é…ç½®


**ä¸´æ—¶ç”¨æˆ·é…ç½®**ï¼š
```bash
# ä¸´æ—¶è®¿å®¢è´¦æˆ·ä¸¥æ ¼é™åˆ¶
temp*           hard    nofile          128     # ä¸´æ—¶ç”¨æˆ·å¼€å¤´
guest*          hard    nproc           16      
visitor*        hard    fsize           1024    # 1MBæ–‡ä»¶é™åˆ¶
```

**æœåŠ¡å™¨è§’è‰²é…ç½®**ï¼š
```bash
# WebæœåŠ¡å™¨è§’è‰²
web*            -       nofile          16384
app*            soft    memlock         128000

# æ•°æ®åº“æœåŠ¡å™¨è§’è‰²  
db*             -       nofile          8192
db*             soft    memlock         unlimited

# ç¼“å­˜æœåŠ¡å™¨è§’è‰²
cache*          -       nofile          10240
cache*          -       memlock         256000
```

---

## 9. ğŸ“Š é…ç½®ä¼˜å…ˆçº§ä¸ç»§æ‰¿


### 9.1 é…ç½®ä¼˜å…ˆçº§è¯¦è§£


**åŸºæœ¬ä¼˜å…ˆçº§è§„åˆ™**ï¼š
```
é…ç½®åŒ¹é…ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
1ï¸âƒ£ ç²¾ç¡®ç”¨æˆ·ååŒ¹é…    alice
2ï¸âƒ£ ç”¨æˆ·ç»„åŒ¹é…        @developers  
3ï¸âƒ£ é€šé…ç¬¦åŒ¹é…        *
```

**ä¼˜å…ˆçº§å®é™…åº”ç”¨**ï¼š
```bash
# é…ç½®ç¤ºä¾‹
*               soft    nofile          1024    # ä¼˜å…ˆçº§ï¼šä½
@developers     soft    nofile          2048    # ä¼˜å…ˆçº§ï¼šä¸­
alice           soft    nofile          4096    # ä¼˜å…ˆçº§ï¼šé«˜

# ç»“æœåˆ†æï¼š
# aliceï¼ˆdevelopersç»„æˆå‘˜ï¼‰â†’ 4096ï¼ˆç”¨æˆ·é…ç½®ç”Ÿæ•ˆï¼‰
# bobï¼ˆdevelopersç»„æˆå‘˜ï¼‰  â†’ 2048ï¼ˆç»„é…ç½®ç”Ÿæ•ˆï¼‰  
# charlieï¼ˆæ™®é€šç”¨æˆ·ï¼‰      â†’ 1024ï¼ˆé€šé…ç¬¦ç”Ÿæ•ˆï¼‰
```

### 9.2 åŒä¸€ç”¨æˆ·å¤šé¡¹é…ç½®


**é…ç½®åˆå¹¶è§„åˆ™**ï¼š
åŒä¸€ç”¨æˆ·å¯ä»¥æœ‰å¤šè¡Œé…ç½®ï¼Œæ¯è¡Œé…ç½®ä¸åŒçš„èµ„æºé¡¹ç›®ï¼Œ**å…¨éƒ¨éƒ½ä¼šç”Ÿæ•ˆ**ã€‚

**é…ç½®ç¤ºä¾‹**ï¼š
```bash
# aliceç”¨æˆ·çš„å¤šé¡¹é…ç½®
alice           soft    nofile          2048    # æ–‡ä»¶æ‰“å¼€æ•°
alice           hard    nofile          4096    
alice           soft    nproc           1024    # è¿›ç¨‹æ•°
alice           hard    memlock         64000   # å†…å­˜é”å®š

# æœ€ç»ˆaliceçš„ç”Ÿæ•ˆé…ç½®ï¼š
# nofile: soft=2048, hard=4096
# nproc:  soft=1024, hard=unlimitedï¼ˆç»§æ‰¿é»˜è®¤å€¼ï¼‰
# memlock: soft=unlimitedï¼ˆç»§æ‰¿é»˜è®¤å€¼ï¼‰, hard=64000
```

### 9.3 é…ç½®ç»§æ‰¿æœºåˆ¶


**ç»§æ‰¿æ¥æº**ï¼š
```
ç”¨æˆ·æœ€ç»ˆé…ç½® = ç”¨æˆ·ä¸“æœ‰é…ç½® + ç»„é…ç½® + é€šé…ç¬¦é…ç½®

ç»§æ‰¿è§„åˆ™ï¼š
- æœ‰æ˜ç¡®é…ç½®ï¼šä½¿ç”¨æ˜ç¡®é…ç½®å€¼
- æ— æ˜ç¡®é…ç½®ï¼šç»§æ‰¿æ›´ä½ä¼˜å…ˆçº§çš„é…ç½®  
- éƒ½æ— é…ç½®ï¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤å€¼
```

**ç»§æ‰¿ç¤ºä¾‹**ï¼š
```bash
# é…ç½®æ–‡ä»¶å†…å®¹
*               soft    nofile          1024    # å…¨å±€é»˜è®¤
*               hard    nofile          4096
*               soft    nproc           512
*               hard    nproc           2048

@developers     soft    nofile          2048    # å¼€å‘ç»„é…ç½®
@developers     hard    memlock         64000   # å¼€å‘ç»„ç‹¬æœ‰

alice           hard    nofile          8192    # Aliceä¸“æœ‰é…ç½®

# Aliceï¼ˆdevelopersç»„æˆå‘˜ï¼‰çš„æœ€ç»ˆé…ç½®ï¼š
# nofile:  soft=2048ï¼ˆç»§æ‰¿ç»„é…ç½®ï¼‰, hard=8192ï¼ˆç”¨æˆ·ä¸“æœ‰ï¼‰
# nproc:   soft=512ï¼ˆç»§æ‰¿é€šé…ç¬¦ï¼‰, hard=2048ï¼ˆç»§æ‰¿é€šé…ç¬¦ï¼‰  
# memlock: soft=unlimitedï¼ˆç³»ç»Ÿé»˜è®¤ï¼‰, hard=64000ï¼ˆç»§æ‰¿ç»„é…ç½®ï¼‰
```

### 9.4 é…ç½®æ–‡ä»¶è¯»å–é¡ºåº


**æ–‡ä»¶è¯»å–é¡ºåº**ï¼š
```
è¯»å–é¡ºåºï¼š
1ï¸âƒ£ /etc/security/limits.conf           # ä¸»é…ç½®æ–‡ä»¶
2ï¸âƒ£ /etc/security/limits.d/*.conf       # æŒ‰å­—æ¯é¡ºåºè¯»å–

æ–‡ä»¶å†…å®¹åˆå¹¶è§„åˆ™ï¼š
- åè¯»å–çš„æ–‡ä»¶å¯ä»¥è¦†ç›–å‰é¢çš„é…ç½®
- ç›¸åŒç”¨æˆ·ç›¸åŒèµ„æºé¡¹ï¼šåé¢çš„è¦†ç›–å‰é¢çš„
- ä¸åŒèµ„æºé¡¹ï¼šç´¯ç§¯ç”Ÿæ•ˆ
```

**è¦†ç›–ç¤ºä¾‹**ï¼š
```bash
# /etc/security/limits.conf
alice           soft    nofile          1024

# /etc/security/limits.d/50-custom.conf
alice           soft    nofile          2048    # è¦†ç›–ä¸»é…ç½®æ–‡ä»¶
alice           hard    nproc           1024    # æ–°å¢é…ç½®

# /etc/security/limits.d/99-final.conf  
alice           soft    nofile          4096    # å†æ¬¡è¦†ç›–

# Aliceæœ€ç»ˆé…ç½®ï¼š
# nofile: soft=4096ï¼ˆè¢«99-final.confè¦†ç›–ï¼‰
# nproc:  hard=1024ï¼ˆæ¥è‡ª50-custom.confï¼‰
```

### 9.5 è¿›ç¨‹ç»§æ‰¿æœºåˆ¶


**è¿›ç¨‹èµ„æºé™åˆ¶ç»§æ‰¿**ï¼š
```
ç»§æ‰¿å±‚æ¬¡ï¼š
ç™»å½•Shell â†’ å­è¿›ç¨‹ â†’ å­™å­è¿›ç¨‹
    â†“         â†“         â†“
 limits    ç»§æ‰¿çˆ¶è¿›ç¨‹  ç»§æ‰¿çˆ¶è¿›ç¨‹
 é…ç½®      èµ„æºé™åˆ¶    èµ„æºé™åˆ¶
```

**ç»§æ‰¿ç¤ºä¾‹**ï¼š
```bash
# ç”¨æˆ·ç™»å½•æ—¶è·å¾—limitsé…ç½®
$ ssh alice@server
alice@server:~$ ulimit -n
2048

# å¯åŠ¨bashå­è¿›ç¨‹ï¼Œç»§æ‰¿é™åˆ¶
alice@server:~$ bash
alice@server:~$ ulimit -n  
2048

# å­è¿›ç¨‹å¯ä»¥è°ƒæ•´é™åˆ¶ï¼ˆåœ¨å…è®¸èŒƒå›´å†…ï¼‰
alice@server:~$ ulimit -n 1500
alice@server:~$ ulimit -n
1500

# å¯åŠ¨æ–°çš„å­è¿›ç¨‹
alice@server:~$ bash
alice@server:~$ ulimit -n
1500                    # ç»§æ‰¿è°ƒæ•´åçš„å€¼

# é€€å‡ºåˆ°çˆ¶è¿›ç¨‹
alice@server:~$ exit
alice@server:~$ ulimit -n
2048                    # çˆ¶è¿›ç¨‹çš„å€¼æœªæ”¹å˜
```

### 9.6 ä¼˜å…ˆçº§è°ƒè¯•æŠ€å·§


**æŸ¥çœ‹é…ç½®åº”ç”¨è¿‡ç¨‹**ï¼š
```bash
# æ–¹æ³•1ï¼šä½¿ç”¨debugæ¨¡å¼
# åœ¨/etc/pam.d/sshdä¸­ä¸´æ—¶æ·»åŠ 
session required pam_limits.so debug

# æŸ¥çœ‹æ—¥å¿—
$ sudo tail -f /var/log/secure | grep pam_limits
```

**æ‰‹åŠ¨æµ‹è¯•ä¼˜å…ˆçº§**ï¼š
```bash
# åˆ›å»ºæµ‹è¯•é…ç½®
$ sudo tee /etc/security/limits.d/99-test.conf << EOF
*          soft  nofile  1000
@testgroup soft  nofile  2000  
testuser   soft  nofile  3000
EOF

# åˆ›å»ºæµ‹è¯•ç”¨æˆ·å’Œç»„
$ sudo groupadd testgroup
$ sudo useradd -g testgroup testuser

# æµ‹è¯•ç»§æ‰¿ç»“æœ
$ sudo su - testuser -c "ulimit -n"
3000                    # ç”¨æˆ·é…ç½®ä¼˜å…ˆçº§æœ€é«˜
```

---

## 10. ğŸ› ï¸ å®è·µæ¡ˆä¾‹ä¸æ•…éšœæ’æŸ¥


### 10.1 WebæœåŠ¡å™¨é…ç½®æ¡ˆä¾‹


**åœºæ™¯æè¿°**ï¼š
é…ç½®ä¸€å°é«˜å¹¶å‘WebæœåŠ¡å™¨ï¼Œéœ€è¦æ”¯æŒå¤§é‡å¹¶å‘è¿æ¥ã€‚

**éœ€æ±‚åˆ†æ**ï¼š
- ğŸŒ **Nginxç”¨æˆ·** - éœ€è¦å¤§é‡æ–‡ä»¶æè¿°ç¬¦å¤„ç†è¿æ¥
- ğŸ“Š **åº”ç”¨ç”¨æˆ·** - éœ€è¦é€‚ä¸­çš„è¿›ç¨‹æ•°å’Œæ–‡ä»¶æ‰“å¼€æ•°
- ğŸ‘¥ **æ™®é€šç”¨æˆ·** - åŸºç¡€é™åˆ¶å³å¯

**é…ç½®å®ç°**ï¼š
```bash
# /etc/security/limits.d/webserver.conf
# ========================================
# WebæœåŠ¡å™¨èµ„æºé™åˆ¶é…ç½®
# ========================================

# Nginx WebæœåŠ¡å™¨é…ç½®
nginx           soft    nofile          32768
nginx           hard    nofile          65536
nginx           soft    nproc           2048
nginx           hard    nproc           4096

# PHP-FPMè¿›ç¨‹ç”¨æˆ·
www-data        soft    nofile          8192
www-data        hard    nofile          16384
www-data        soft    nproc           1024
www-data        hard    nproc           2048

# Webç®¡ç†å‘˜ç»„
@webadmins      soft    nofile          4096
@webadmins      hard    nofile          8192
@webadmins      soft    core            unlimited

# æ™®é€šç³»ç»Ÿç”¨æˆ·åŸºç¡€é™åˆ¶
*               soft    nofile          1024
*               hard    nofile          4096
*               soft    nproc           1024
*               hard    nproc           2048
*               hard    core            0
```

**éªŒè¯è¿‡ç¨‹**ï¼š
```bash
# éªŒè¯nginxç”¨æˆ·é™åˆ¶
$ sudo su - nginx -c "ulimit -n"
32768

# éªŒè¯www-dataç”¨æˆ·é™åˆ¶
$ sudo su - www-data -c "ulimit -a | grep 'open files'"
open files                      (-n) 8192

# éªŒè¯æ™®é€šç”¨æˆ·é™åˆ¶
$ ulimit -n
1024
```

### 10.2 æ•°æ®åº“æœåŠ¡å™¨é…ç½®æ¡ˆä¾‹


**åœºæ™¯æè¿°**ï¼š
é…ç½®MySQLæ•°æ®åº“æœåŠ¡å™¨ï¼Œéœ€è¦å¤§é‡å†…å­˜é”å®šå’Œæ–‡ä»¶æ“ä½œã€‚

**é…ç½®å®ç°**ï¼š
```bash
# /etc/security/limits.d/database.conf
# ====================================
# æ•°æ®åº“æœåŠ¡å™¨èµ„æºé™åˆ¶é…ç½®
# ====================================

# MySQLæ•°æ®åº“ç”¨æˆ·
mysql           soft    nofile          8192
mysql           hard    nofile          65536
mysql           soft    memlock         unlimited
mysql           hard    memlock         unlimited
mysql           soft    nproc           4096
mysql           hard    nproc           8192

# æ•°æ®åº“ç®¡ç†å‘˜ç»„
@dba            soft    nofile          16384
@dba            hard    nofile          32768
@dba            soft    memlock         1048576    # 1GB
@dba            hard    memlock         unlimited
@dba            soft    core            unlimited

# ç¦æ­¢æ™®é€šç”¨æˆ·å¤§é‡å†…å­˜é”å®š
*               hard    memlock         65536      # 64MB
```

**MySQLæœåŠ¡é…ç½®éªŒè¯**ï¼š
```bash
# æ£€æŸ¥MySQLç”¨æˆ·é™åˆ¶
$ sudo su - mysql -c "ulimit -l"
unlimited

# æ£€æŸ¥MySQLè¿›ç¨‹å®é™…é™åˆ¶
$ cat /proc/$(pgrep mysqld)/limits | grep "Max locked memory"
Max locked memory    unlimited            unlimited            bytes
```

### 10.3 å…±äº«ä¸»æœºé…ç½®æ¡ˆä¾‹


**åœºæ™¯æè¿°**ï¼š
é…ç½®å…±äº«ä¸»æœºç¯å¢ƒï¼Œéœ€è¦ä¸¥æ ¼æ§åˆ¶ç”¨æˆ·èµ„æºä½¿ç”¨ã€‚

**é…ç½®å®ç°**ï¼š
```bash
# /etc/security/limits.d/shared-hosting.conf
# ==========================================
# å…±äº«ä¸»æœºèµ„æºé™åˆ¶é…ç½®
# ==========================================

# å…±äº«ç”¨æˆ·ä¸¥æ ¼é™åˆ¶
@shared         hard    nofile          512
@shared         hard    nproc           32
@shared         hard    fsize           102400     # 100MB
@shared         hard    cpu             30         # 30åˆ†é’Ÿ
@shared         hard    rss             524288     # 512MB
@shared         hard    core            0

# VIPç”¨æˆ·é€‚åº¦æ”¾å®½
@vip            hard    nofile          2048  
@vip            hard    nproc           128
@vip            hard    fsize           1048576    # 1GB
@vip            hard    rss             2097152    # 2GB

# ç³»ç»Ÿç®¡ç†å‘˜ä¸å—é™
@wheel          -       nofile          unlimited
@wheel          -       nproc           unlimited
@wheel          -       memlock         unlimited

# é»˜è®¤ä¸¥æ ¼é™åˆ¶
*               hard    nofile          256
*               hard    nproc           16  
*               hard    fsize           51200      # 50MB
```

### 10.4 å¸¸è§æ•…éšœæ’æŸ¥


#### ğŸš« é—®é¢˜1ï¼šé…ç½®ä¸ç”Ÿæ•ˆ


**æ•…éšœç°è±¡**ï¼š
```bash
# ä¿®æ”¹äº†limits.confä½†é™åˆ¶æ²¡æœ‰ç”Ÿæ•ˆ
$ ulimit -n
1024                    # ä¾ç„¶æ˜¯æ—§å€¼
```

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# 1. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
$ sudo awk '/^[^#]/ {if(NF!=4) print "Line "NR": " $0}' /etc/security/limits.conf

# 2. æ£€æŸ¥PAMé…ç½®
$ grep -r pam_limits /etc/pam.d/
/etc/pam.d/sshd:session    required     pam_limits.so

# 3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦é‡æ–°ç™»å½•
$ who
alice    pts/0        2024-09-14 10:30

# 4. å¼ºåˆ¶é‡æ–°ç™»å½•æµ‹è¯•
$ ssh alice@localhost
alice@server:~$ ulimit -n
2048                    # æ–°å€¼ç”Ÿæ•ˆ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ç¡®ä¿PAMé…ç½®æ­£ç¡®
$ sudo grep "session.*pam_limits" /etc/pam.d/sshd
session    required     pam_limits.so

# å¦‚æœæ²¡æœ‰ï¼Œæ·»åŠ é…ç½®
$ sudo sed -i '/session.*pam_selinux.*open/a session    required     pam_limits.so' /etc/pam.d/sshd
```

#### ğŸ“ é—®é¢˜2ï¼šæ–‡ä»¶å¥æŸ„ä¸è¶³


**æ•…éšœç°è±¡**ï¼š
```bash
# åº”ç”¨ç¨‹åºæŠ¥é”™
-bash: cannot create temp file for here-document: Too many open files
```

**æ•…éšœåˆ†æ**ï¼š
```bash
# æ£€æŸ¥å½“å‰è¿›ç¨‹æ–‡ä»¶æ‰“å¼€æƒ…å†µ
$ lsof -p $$ | wc -l
1020

# æ£€æŸ¥å½“å‰é™åˆ¶
$ ulimit -n
1024

# æ£€æŸ¥ç³»ç»Ÿçº§é™åˆ¶
$ cat /proc/sys/fs/file-max
3263256
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å¢åŠ ç”¨æˆ·æ–‡ä»¶æ‰“å¼€æ•°é™åˆ¶
$ sudo vim /etc/security/limits.conf
alice    soft    nofile    8192
alice    hard    nofile    16384

# é‡æ–°ç™»å½•ç”Ÿæ•ˆ
$ exit
$ ssh alice@server
$ ulimit -n
8192
```

#### ğŸ”„ é—®é¢˜3ï¼šè¿›ç¨‹æ•°é™åˆ¶è¿‡ä½


**æ•…éšœç°è±¡**ï¼š
```bash
# ç¼–è¯‘å¤§å‹é¡¹ç›®æ—¶æŠ¥é”™
make: fork: Resource temporarily unavailable
```

**æ•…éšœæ’æŸ¥**ï¼š
```bash
# æ£€æŸ¥å½“å‰è¿›ç¨‹æ•°
$ ps -u alice | wc -l
512

# æ£€æŸ¥è¿›ç¨‹æ•°é™åˆ¶
$ ulimit -u  
512

# æ£€æŸ¥ç³»ç»Ÿæœ€å¤§è¿›ç¨‹æ•°
$ cat /proc/sys/kernel/pid_max
32768
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å¢åŠ ç”¨æˆ·è¿›ç¨‹æ•°é™åˆ¶
$ sudo vim /etc/security/limits.conf
alice    soft    nproc     2048
alice    hard    nproc     4096

# åŒæ—¶æ£€æŸ¥/etc/security/limits.d/90-nproc.conf
$ sudo vim /etc/security/limits.d/90-nproc.conf
# ç¡®ä¿ä¸ä¸ä¸»é…ç½®å†²çª
```

### 10.5 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ


**WebæœåŠ¡å™¨ä¼˜åŒ–**ï¼š
```bash
# é«˜æ€§èƒ½WebæœåŠ¡å™¨é…ç½®æ¨¡æ¿
nginx           soft    nofile          65536
nginx           hard    nofile          100000
nginx           soft    nproc           8192
nginx           hard    nproc           16384

# é…åˆå†…æ ¸å‚æ•°è°ƒæ•´
$ sudo sysctl -w fs.file-max=1000000
$ sudo sysctl -w net.core.somaxconn=65535
```

**æ•°æ®åº“ä¼˜åŒ–**ï¼š
```bash
# æ•°æ®åº“æœåŠ¡å™¨ä¼˜åŒ–é…ç½®
mysql           soft    nofile          65536
mysql           hard    nofile          100000
mysql           soft    memlock         unlimited
mysql           hard    memlock         unlimited
mysql           soft    nproc           32768
mysql           hard    nproc           65536
```

**ç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# limitsç›‘æ§è„šæœ¬

echo "=== ç”¨æˆ·èµ„æºé™åˆ¶ä½¿ç”¨æƒ…å†µ ==="
for user in $(ps -eo user --no-headers | sort -u); do
    if id "$user" &>/dev/null; then
        echo "ç”¨æˆ·: $user"
        sudo su - "$user" -c "ulimit -n" 2>/dev/null | sed 's/^/  æ–‡ä»¶æ•°: /'
        sudo su - "$user" -c "ulimit -u" 2>/dev/null | sed 's/^/  è¿›ç¨‹æ•°: /'
        echo
    fi
done
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ limits.confä½œç”¨ï¼šæ§åˆ¶ç”¨æˆ·ç³»ç»Ÿèµ„æºä½¿ç”¨é™åˆ¶çš„é…ç½®æ–‡ä»¶
ğŸ”¸ é…ç½®è¯­æ³•ï¼š<domain> <type> <item> <value> å››ä¸ªå­—æ®µ
ğŸ”¸ é™åˆ¶ç±»å‹ï¼šsoftè½¯é™åˆ¶ï¼ˆå¯è°ƒæ•´ï¼‰ã€hardç¡¬é™åˆ¶ï¼ˆç»å¯¹ä¸Šé™ï¼‰
ğŸ”¸ ç”Ÿæ•ˆæœºåˆ¶ï¼šé€šè¿‡PAMæ¨¡å—è¯»å–é…ç½®ï¼Œç”¨æˆ·é‡æ–°ç™»å½•åç”Ÿæ•ˆ
ğŸ”¸ ä¼˜å…ˆçº§è§„åˆ™ï¼šç”¨æˆ·é…ç½® > ç»„é…ç½® > é€šé…ç¬¦é…ç½®
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é…ç½®æ–‡ä»¶ç»“æ„ç†è§£**
```
é…ç½®ä½ç½®ï¼š
ä¸»é…ç½®æ–‡ä»¶ï¼š/etc/security/limits.conf
åˆ†ç‰‡é…ç½®ï¼š/etc/security/limits.d/*.conf

è¯­æ³•æ ¼å¼ï¼š
domain(ç”¨æˆ·)  type(ç±»å‹)  item(èµ„æº)  value(æ•°å€¼)
alice        soft       nofile      2048
```

**ğŸ”¹ è½¯ç¡¬é™åˆ¶çš„å…³ç³»**
```
å…³ç³»çº¦æŸï¼šè½¯é™åˆ¶ â‰¤ ç¡¬é™åˆ¶

æ“ä½œæƒé™ï¼š
- æ™®é€šç”¨æˆ·ï¼šå¯è°ƒæ•´è½¯é™åˆ¶ï¼ˆåœ¨ç¡¬é™åˆ¶èŒƒå›´å†…ï¼‰
- rootç”¨æˆ·ï¼šå¯ä¿®æ”¹è½¯ç¡¬é™åˆ¶

å®é™…æ•ˆæœï¼š
- è½¯é™åˆ¶ï¼šå»ºè®®å€¼ï¼Œå¯ä¸´æ—¶è¶…è¿‡
- ç¡¬é™åˆ¶ï¼šç»å¯¹ä¸Šé™ï¼Œä¸èƒ½è¶…è¿‡
```

**ğŸ”¹ PAMé›†æˆæœºåˆ¶**
```
å·¥ä½œæµç¨‹ï¼š
ç”¨æˆ·ç™»å½• â†’ PAMè®¤è¯ â†’ pam_limits.so â†’ è¯»å–limits.conf â†’ åº”ç”¨é™åˆ¶

å…³é”®æ–‡ä»¶ï¼š
/etc/pam.d/sshd        # SSHç™»å½•
/etc/pam.d/login       # æ§åˆ¶å°ç™»å½•
/etc/pam.d/system-auth # ç³»ç»Ÿè®¤è¯
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**é…ç½®ç­–ç•¥**ï¼š
```bash
# åˆ†å±‚é…ç½®åŸåˆ™
1ï¸âƒ£ å…¨å±€é»˜è®¤ï¼šä¿å®ˆçš„åŸºç¡€é™åˆ¶
*          soft    nofile    1024

2ï¸âƒ£ ç»„çº§é…ç½®ï¼šæŒ‰è§’è‰²è®¾ç½®
@webusers  soft    nofile    8192

3ï¸âƒ£ ç”¨æˆ·ç‰¹å®šï¼šé’ˆå¯¹æ€§ä¼˜åŒ–
nginx      -       nofile    32768
```

**æ•…éšœæ’æŸ¥æ­¥éª¤**ï¼š
```bash
# æ ‡å‡†æ’æŸ¥æµç¨‹
1. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³• â†’ awkæ£€æŸ¥
2. éªŒè¯PAMé…ç½®     â†’ grep pam_limits
3. ç¡®è®¤ç”¨æˆ·é‡ç™»å½•  â†’ æ–°å»ºä¼šè¯æµ‹è¯•
4. æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—    â†’ /var/log/secure
5. æµ‹è¯•é™åˆ¶ç”Ÿæ•ˆ    â†’ ulimitéªŒè¯
```

### 11.4 é…ç½®æ³¨æ„äº‹é¡¹


**å®‰å…¨è€ƒè™‘**ï¼š
- âš ï¸ **é¿å…unlimitedæ»¥ç”¨** - å¯èƒ½å½±å“ç³»ç»Ÿç¨³å®šæ€§
- ğŸ”’ **åˆ†å±‚æƒé™ç®¡ç†** - ä¸åŒç”¨æˆ·ä¸åŒé™åˆ¶ç­–ç•¥
- ğŸ“Š **ç›‘æ§èµ„æºä½¿ç”¨** - å®šæœŸæ£€æŸ¥é™åˆ¶åˆç†æ€§

**æ€§èƒ½è€ƒè™‘**ï¼š
- ğŸš€ **æ ¹æ®åº”ç”¨éœ€æ±‚è°ƒæ•´** - WebæœåŠ¡å™¨éœ€è¦æ›´å¤šæ–‡ä»¶å¥æŸ„
- ğŸ’¾ **è€ƒè™‘ç³»ç»Ÿèµ„æºæ€»é‡** - ä¸è¦è¶…è¿‡ç³»ç»Ÿç‰©ç†é™åˆ¶
- âš–ï¸ **å¹³è¡¡ç”¨æˆ·éœ€æ±‚** - é¿å…æŸä¸ªç”¨æˆ·å ç”¨è¿‡å¤šèµ„æº

**ç»´æŠ¤è€ƒè™‘**ï¼š
- ğŸ“ **ä½¿ç”¨åˆ†ç‰‡é…ç½®** - limits.dç›®å½•ä¾¿äºç®¡ç†
- ğŸ“ **æ·»åŠ é…ç½®æ³¨é‡Š** - è¯´æ˜é…ç½®ç›®çš„å’Œæ—¶é—´
- ğŸ” **å®šæœŸå®¡æŸ¥é…ç½®** - æ¸…ç†ä¸å†éœ€è¦çš„é…ç½®

### 11.5 å¿«é€Ÿå‚è€ƒ


**å¸¸ç”¨èµ„æºé¡¹ç›®**ï¼š
```bash
nofile     # æ–‡ä»¶æ‰“å¼€æ•°        ulimit -n
nproc      # è¿›ç¨‹æ•°           ulimit -u  
memlock    # å†…å­˜é”å®š(KB)     ulimit -l
fsize      # æ–‡ä»¶å¤§å°(KB)     ulimit -f
core       # coreæ–‡ä»¶å¤§å°     ulimit -c
cpu        # CPUæ—¶é—´(åˆ†é’Ÿ)    ulimit -t
```

**éªŒè¯å‘½ä»¤**ï¼š
```bash
ulimit -a              # æŸ¥çœ‹æ‰€æœ‰é™åˆ¶
ulimit -n              # æŸ¥çœ‹æ–‡ä»¶æ‰“å¼€æ•°é™åˆ¶
ulimit -Sn             # æŸ¥çœ‹è½¯é™åˆ¶
ulimit -Hn             # æŸ¥çœ‹ç¡¬é™åˆ¶
cat /proc/PID/limits   # æŸ¥çœ‹è¿›ç¨‹é™åˆ¶
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
limitsé…ç½®å››å­—æ®µï¼Œç”¨æˆ·ç±»å‹é¡¹ç›®å€¼
è½¯ç¡¬é™åˆ¶è¦åˆ†æ¸…ï¼ŒPAMæ¨¡å—æ¥è¯»å–
é‡æ–°ç™»å½•æ‰ç”Ÿæ•ˆï¼Œä¼˜å…ˆçº§åˆ«æœ‰è§„å¾‹
ç”¨æˆ·é…ç½®æƒæœ€é«˜ï¼Œç»„é…é€šé…ä¾æ¬¡ä½
```