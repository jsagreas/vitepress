---
title: 2ã€æ–‡ä»¶ä¸‹è½½å®ç°æ–¹å¼
---
## ğŸ“š ç›®å½•

1. [æ–‡ä»¶ä¸‹è½½åŸºç¡€æ¦‚å¿µ](#1-æ–‡ä»¶ä¸‹è½½åŸºç¡€æ¦‚å¿µ)
2. [ResponseEntityä¸‹è½½æ–¹å¼](#2-ResponseEntityä¸‹è½½æ–¹å¼)
3. [æµå¼ä¸‹è½½å®ç°](#3-æµå¼ä¸‹è½½å®ç°)
4. [HTTPå“åº”å¤´é…ç½®](#4-HTTPå“åº”å¤´é…ç½®)
5. [æ–‡ä»¶åç¼–ç å¤„ç†](#5-æ–‡ä»¶åç¼–ç å¤„ç†)
6. [æ–­ç‚¹ç»­ä¼ æœºåˆ¶](#6-æ–­ç‚¹ç»­ä¼ æœºåˆ¶)
7. [ä¸‹è½½æƒé™æ§åˆ¶](#7-ä¸‹è½½æƒé™æ§åˆ¶)
8. [å¤§æ–‡ä»¶ä¸‹è½½ä¼˜åŒ–](#8-å¤§æ–‡ä»¶ä¸‹è½½ä¼˜åŒ–)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“¥ æ–‡ä»¶ä¸‹è½½åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ–‡ä»¶ä¸‹è½½


ğŸ”¸ **é€šä¿—ç†è§£**
```
å°±åƒä½ åœ¨ç½‘ä¸Šä¸‹è½½è½¯ä»¶ã€æ–‡æ¡£ã€å›¾ç‰‡ä¸€æ ·ï¼š
- ç”¨æˆ·ç‚¹å‡»ä¸‹è½½æŒ‰é’®
- æµè§ˆå™¨å¼¹å‡ºä¿å­˜å¯¹è¯æ¡†
- æ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°ç”µè„‘

åœ¨Spring MVCä¸­ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯ï¼š
æŠŠæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ï¼Œé€šè¿‡HTTPåè®®å‘é€ç»™æµè§ˆå™¨
```

ğŸ”¸ **æ ¸å¿ƒåŸç†**
- **æœ¬è´¨**ï¼šæœåŠ¡å™¨æŠŠæ–‡ä»¶å†…å®¹ä½œä¸ºHTTPå“åº”ä½“å‘é€
- **å…³é”®**ï¼šè®¾ç½®æ­£ç¡®çš„å“åº”å¤´ï¼Œå‘Šè¯‰æµè§ˆå™¨è¿™æ˜¯ä¸ªä¸‹è½½æ–‡ä»¶
- **æµç¨‹**ï¼šè¯»å–æ–‡ä»¶ â†’ è®¾ç½®å“åº”å¤´ â†’ å†™å…¥å“åº”æµ

### 1.2 ä¸‹è½½æµç¨‹ç¤ºæ„


```
å®¢æˆ·ç«¯(æµè§ˆå™¨)              Spring MVC              æ–‡ä»¶ç³»ç»Ÿ
     |                          |                        |
     |--[1]è¯·æ±‚ä¸‹è½½æ–‡ä»¶--------->|                        |
     |   /download?file=xx.pdf  |                        |
     |                          |--[2]è¯»å–æ–‡ä»¶---------->|
     |                          |<-[3]è¿”å›æ–‡ä»¶æ•°æ®-------|
     |                          |                        |
     |<-[4]å‘é€æ–‡ä»¶+å“åº”å¤´-------|                        |
     |   Content-Disposition    |                        |
     |   attachment;filename=   |                        |
     |                          |                        |
     |--[5]æµè§ˆå™¨å¼¹å‡ºä¿å­˜æ¡†----->|                        |
```

### 1.3 æ–‡ä»¶ä¸‹è½½çš„ä¸¤ç§æ¨¡å¼


| æ¨¡å¼ç±»å‹ | **å·¥ä½œæ–¹å¼** | **ç”¨æˆ·ä½“éªŒ** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|------------|-------------|
| ğŸ”½ **é™„ä»¶ä¸‹è½½** | `å¼¹å‡ºä¿å­˜å¯¹è¯æ¡†` | `ç”¨æˆ·é€‰æ‹©ä¿å­˜ä½ç½®` | `æ–‡æ¡£ã€å‹ç¼©åŒ…ã€å¯æ‰§è¡Œæ–‡ä»¶` |
| ğŸ‘ï¸ **åœ¨çº¿é¢„è§ˆ** | `æµè§ˆå™¨ç›´æ¥æ‰“å¼€` | `æ— éœ€ä¸‹è½½ç›´æ¥æŸ¥çœ‹` | `å›¾ç‰‡ã€PDFã€è§†é¢‘` |

ğŸ”¸ **åŒºåˆ«çš„å…³é”®**ï¼šå°±æ˜¯HTTPå“åº”å¤´ä¸­çš„ `Content-Disposition` è®¾ç½®
- **é™„ä»¶ä¸‹è½½**ï¼š`attachment; filename="æ–‡ä»¶å"`
- **åœ¨çº¿é¢„è§ˆ**ï¼š`inline; filename="æ–‡ä»¶å"` æˆ–ä¸è®¾ç½®

---

## 2. ğŸ¯ ResponseEntityä¸‹è½½æ–¹å¼


### 2.1 ResponseEntityæ˜¯ä»€ä¹ˆ


ğŸ”¸ **é€šä¿—è§£é‡Š**
```
ResponseEntity å°±åƒä¸€ä¸ªå¿«é€’åŒ…è£¹ï¼š
- åŒ…è£¹å†…å®¹ï¼šæ–‡ä»¶çš„å­—èŠ‚æ•°æ®
- åŒ…è£¹æ ‡ç­¾ï¼šHTTPå“åº”å¤´ï¼ˆæ–‡ä»¶åã€ç±»å‹ç­‰ï¼‰
- åŒ…è£¹çŠ¶æ€ï¼šHTTPçŠ¶æ€ç ï¼ˆ200æˆåŠŸã€404æœªæ‰¾åˆ°ï¼‰

Spring MVCå¸®æˆ‘ä»¬æŠŠè¿™ä¸‰æ ·ä¸œè¥¿æ‰“åŒ…å¥½ï¼Œå‘é€ç»™æµè§ˆå™¨
```

ğŸ”¸ **ä¸ºä»€ä¹ˆç”¨ResponseEntity**
- âœ… **ç®€å•ç›´è§‚**ï¼šä¸€ä¸ªå¯¹è±¡æå®šå“åº”çš„æ‰€æœ‰å†…å®¹
- âœ… **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æœŸå°±èƒ½å‘ç°é”™è¯¯
- âœ… **çµæ´»æ§åˆ¶**ï¼šå¯ä»¥ç²¾ç¡®æ§åˆ¶å“åº”å¤´å’ŒçŠ¶æ€ç 

### 2.2 åŸºç¡€ä¸‹è½½å®ç°


ğŸŸ¢ **å…¥é—¨çº§ç¤ºä¾‹**

```java
@RestController
@RequestMapping("/file")
public class FileDownloadController {
    
    /**
     * æœ€ç®€å•çš„æ–‡ä»¶ä¸‹è½½
     * è®¿é—®ï¼šhttp://localhost:8080/file/download?filename=test.txt
     */
    @GetMapping("/download")
    public ResponseEntity<byte[]> downloadFile(String filename) {
        // 1. è¯»å–æ–‡ä»¶å†…å®¹
        File file = new File("D:/files/" + filename);
        byte[] fileContent = Files.readAllBytes(file.toPath());
        
        // 2. è®¾ç½®å“åº”å¤´
        HttpHeaders headers = new HttpHeaders();
        headers.add("Content-Disposition", "attachment; filename=" + filename);
        
        // 3. è¿”å›ResponseEntity
        return ResponseEntity.ok()
                .headers(headers)
                .body(fileContent);
    }
}
```

ğŸ”¸ **ä»£ç è§£æ**
- `byte[] fileContent`ï¼šæ–‡ä»¶å†…å®¹è½¬æˆå­—èŠ‚æ•°ç»„
- `HttpHeaders`ï¼šè®¾ç½®å“åº”å¤´ä¿¡æ¯
- `Content-Disposition: attachment`ï¼šå‘Šè¯‰æµè§ˆå™¨å¼¹å‡ºä¸‹è½½æ¡†
- `ResponseEntity.ok()`ï¼šè¿”å›200çŠ¶æ€ç 

### 2.3 å®Œæ•´ä¸‹è½½å®ç°


ğŸŸ¡ **è¿›é˜¶çº§ç¤ºä¾‹**ï¼ˆåŒ…å«å¼‚å¸¸å¤„ç†ï¼‰

```java
@GetMapping("/download-safe")
public ResponseEntity<Resource> downloadFileSafe(@RequestParam String filename) {
    try {
        // 1. å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢è·¯å¾„ç©¿è¶Šæ”»å‡»
        Path filePath = Paths.get("D:/files").resolve(filename).normalize();
        if (!filePath.startsWith("D:/files")) {
            return ResponseEntity.badRequest().build();
        }
        
        // 2. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        File file = filePath.toFile();
        if (!file.exists()) {
            return ResponseEntity.notFound().build();
        }
        
        // 3. ä½¿ç”¨ResourceåŒ…è£…æ–‡ä»¶
        Resource resource = new FileSystemResource(file);
        
        // 4. è®¾ç½®å“åº”å¤´
        HttpHeaders headers = new HttpHeaders();
        headers.add(HttpHeaders.CONTENT_DISPOSITION, 
                    "attachment; filename=" + filename);
        headers.add(HttpHeaders.CONTENT_TYPE, 
                    MediaType.APPLICATION_OCTET_STREAM_VALUE);
        
        return ResponseEntity.ok()
                .headers(headers)
                .contentLength(file.length())
                .body(resource);
                
    } catch (Exception e) {
        return ResponseEntity.internalServerError().build();
    }
}
```

ğŸ”¸ **å®‰å…¨è¦ç‚¹**
- **è·¯å¾„æ£€æŸ¥**ï¼šé˜²æ­¢ `../../` è¿™ç§è·¯å¾„ç©¿è¶Š
- **æ–‡ä»¶å­˜åœ¨æ€§**ï¼šé¿å…æ–‡ä»¶ä¸å­˜åœ¨å¯¼è‡´é”™è¯¯
- **å¼‚å¸¸å¤„ç†**ï¼šæ•è·æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸

---

## 3. ğŸŒŠ æµå¼ä¸‹è½½å®ç°


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦æµå¼ä¸‹è½½


ğŸ”¸ **é—®é¢˜åœºæ™¯**
```
âŒ ä¸€æ¬¡æ€§è¯»å–å¤§æ–‡ä»¶çš„é—®é¢˜ï¼š
æ–‡ä»¶å¤§å°ï¼š2GB
å†…å­˜å ç”¨ï¼š2GBï¼ˆè¯»å–åˆ°byte[]æ•°ç»„ï¼‰
ç»“æœï¼šå†…å­˜æº¢å‡ºï¼

âœ… æµå¼ä¸‹è½½çš„ä¼˜åŠ¿ï¼š
æ–‡ä»¶å¤§å°ï¼š2GB
å†…å­˜å ç”¨ï¼š8KBï¼ˆç¼“å†²åŒºå¤§å°ï¼‰
ç»“æœï¼šç¨³å®šä¸‹è½½ï¼
```

ğŸ”¸ **æ ¸å¿ƒæ€æƒ³**
- ä¸æ˜¯ä¸€æ¬¡æ€§è¯»å–æ•´ä¸ªæ–‡ä»¶
- è€Œæ˜¯åˆ†å—è¯»å–ï¼Œè¾¹è¯»è¾¹å†™
- å°±åƒç”¨æ°´æ¡¶æ¥æ°´ï¼Œä¸€æ¡¶ä¸€æ¡¶åœ°ä¼ é€’

### 3.2 ä½¿ç”¨OutputStreamæµå¼ä¸‹è½½


```java
@GetMapping("/download-stream")
public void downloadByStream(@RequestParam String filename, 
                             HttpServletResponse response) {
    try {
        // 1. è·å–æ–‡ä»¶
        File file = new File("D:/files/" + filename);
        
        // 2. è®¾ç½®å“åº”å¤´
        response.setContentType("application/octet-stream");
        response.setHeader("Content-Disposition", 
                          "attachment; filename=" + filename);
        response.setContentLengthLong(file.length());
        
        // 3. æµå¼ä¼ è¾“
        try (FileInputStream fis = new FileInputStream(file);
             OutputStream os = response.getOutputStream()) {
            
            byte[] buffer = new byte[8192]; // 8KBç¼“å†²åŒº
            int bytesRead;
            
            // å¾ªç¯è¯»å–å¹¶å†™å…¥
            while ((bytesRead = fis.read(buffer)) != -1) {
                os.write(buffer, 0, bytesRead);
            }
            
            os.flush();
        }
        
    } catch (IOException e) {
        throw new RuntimeException("æ–‡ä»¶ä¸‹è½½å¤±è´¥", e);
    }
}
```

ğŸ”¸ **æµç¨‹è¯´æ˜**
```
æ–‡ä»¶(2GB) â†’ è¯»å–8KB â†’ å†™å…¥å“åº” â†’ è¯»å–8KB â†’ å†™å…¥å“åº” â†’ ...
             â†‘                        â†‘
          bufferæ•°ç»„                bufferæ•°ç»„
          (å†…å­˜8KB)                (å†…å­˜8KB)
```

### 3.3 ä½¿ç”¨StreamingResponseBody


ğŸŸ¡ **Springæä¾›çš„æ›´ä¼˜é›…æ–¹å¼**

```java
@GetMapping("/download-streaming")
public ResponseEntity<StreamingResponseBody> downloadStreaming(
        @RequestParam String filename) {
    
    File file = new File("D:/files/" + filename);
    
    // 1. åˆ›å»ºStreamingResponseBody
    StreamingResponseBody stream = outputStream -> {
        try (FileInputStream fis = new FileInputStream(file)) {
            byte[] buffer = new byte[8192];
            int bytesRead;
            while ((bytesRead = fis.read(buffer)) != -1) {
                outputStream.write(buffer, 0, bytesRead);
            }
        }
    };
    
    // 2. è®¾ç½®å“åº”å¤´
    HttpHeaders headers = new HttpHeaders();
    headers.add(HttpHeaders.CONTENT_DISPOSITION, 
                "attachment; filename=" + filename);
    
    return ResponseEntity.ok()
            .headers(headers)
            .contentLength(file.length())
            .body(stream);
}
```

ğŸ”¸ **ä¼˜åŠ¿å¯¹æ¯”**

| æ–¹å¼ | **ä»£ç å¤æ‚åº¦** | **å¼‚å¸¸å¤„ç†** | **å†…å­˜å ç”¨** |
|------|--------------|------------|------------|
| `byte[]æ•°ç»„` | â­ ç®€å• | âš¡ å®¹æ˜“ | ğŸ”´ é«˜(æ–‡ä»¶å¤§å°) |
| `OutputStream` | â­â­ ä¸­ç­‰ | âš¡âš¡ ä¸­ç­‰ | ğŸŸ¢ ä½(ç¼“å†²åŒºå¤§å°) |
| `StreamingResponseBody` | â­â­â­ ç¨å¤æ‚ | âš¡âš¡âš¡ å®Œå–„ | ğŸŸ¢ ä½(ç¼“å†²åŒºå¤§å°) |

---

## 4. ğŸ“‹ HTTPå“åº”å¤´é…ç½®


### 4.1 æ ¸å¿ƒå“åº”å¤´è¯¦è§£


ğŸ”¸ **Content-Dispositionï¼ˆå†…å®¹å¤„ç†æ–¹å¼ï¼‰**
```
ä½œç”¨ï¼šå‘Šè¯‰æµè§ˆå™¨å¦‚ä½•å¤„ç†è¿™ä¸ªæ–‡ä»¶

ä¸¤ç§æ¨¡å¼ï¼š
1. attachment: é™„ä»¶æ¨¡å¼ï¼Œå¼¹å‡ºä¸‹è½½æ¡†
   Content-Disposition: attachment; filename="report.pdf"

2. inline: å†…è”æ¨¡å¼ï¼Œæµè§ˆå™¨å°è¯•ç›´æ¥æ‰“å¼€
   Content-Disposition: inline; filename="image.jpg"
```

ğŸ”¸ **Content-Typeï¼ˆå†…å®¹ç±»å‹ï¼‰**
```
ä½œç”¨ï¼šå‘Šè¯‰æµè§ˆå™¨æ–‡ä»¶çš„MIMEç±»å‹

å¸¸è§ç±»å‹ï¼š
â€¢ application/octet-stream  : é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶
â€¢ application/pdf           : PDFæ–‡ä»¶
â€¢ image/jpeg                : JPEGå›¾ç‰‡
â€¢ text/plain                : æ–‡æœ¬æ–‡ä»¶
â€¢ application/zip           : ZIPå‹ç¼©åŒ…
```

ğŸ”¸ **Content-Lengthï¼ˆå†…å®¹é•¿åº¦ï¼‰**
```
ä½œç”¨ï¼šå‘Šè¯‰æµè§ˆå™¨æ–‡ä»¶çš„æ€»å¤§å°ï¼ˆå­—èŠ‚ï¼‰

å¥½å¤„ï¼š
âœ… æµè§ˆå™¨èƒ½æ˜¾ç¤ºä¸‹è½½è¿›åº¦
âœ… å¯ä»¥é¢„ä¼°ä¸‹è½½æ—¶é—´
âœ… æ”¯æŒæ–­ç‚¹ç»­ä¼ 
```

### 4.2 å“åº”å¤´é…ç½®å®æˆ˜


```java
@GetMapping("/download-complete")
public ResponseEntity<Resource> downloadWithHeaders(
        @RequestParam String filename) {
    
    File file = new File("D:/files/" + filename);
    Resource resource = new FileSystemResource(file);
    
    // æ ¹æ®æ–‡ä»¶ç±»å‹è®¾ç½®Content-Type
    String contentType = determineContentType(filename);
    
    HttpHeaders headers = new HttpHeaders();
    
    // æ ¸å¿ƒå“åº”å¤´
    headers.add(HttpHeaders.CONTENT_DISPOSITION, 
                "attachment; filename=\"" + filename + "\"");
    headers.add(HttpHeaders.CONTENT_TYPE, contentType);
    headers.add(HttpHeaders.CONTENT_LENGTH, 
                String.valueOf(file.length()));
    
    // é™„åŠ å“åº”å¤´
    headers.add(HttpHeaders.CACHE_CONTROL, "no-cache");
    headers.add("X-Download-Options", "noopen");
    
    return ResponseEntity.ok()
            .headers(headers)
            .body(resource);
}

// æ ¹æ®æ–‡ä»¶æ‰©å±•åç¡®å®šContent-Type
private String determineContentType(String filename) {
    String extension = filename.substring(filename.lastIndexOf(".") + 1);
    
    switch (extension.toLowerCase()) {
        case "pdf": return "application/pdf";
        case "jpg":
        case "jpeg": return "image/jpeg";
        case "png": return "image/png";
        case "txt": return "text/plain";
        case "zip": return "application/zip";
        default: return "application/octet-stream";
    }
}
```

---

## 5. ğŸ”¤ æ–‡ä»¶åç¼–ç å¤„ç†


### 5.1 ä¸­æ–‡æ–‡ä»¶åçš„é—®é¢˜


ğŸ”¸ **é—®é¢˜ç°è±¡**
```
åŸæ–‡ä»¶åï¼šç”¨æˆ·æŠ¥å‘Š.pdf
ä¸‹è½½åå˜æˆï¼šÃ“ÃƒÂ»Â§Â±Â¨Â¸Ã¦.pdf  (ä¹±ç ï¼)

åŸå› ï¼šHTTPå“åº”å¤´åªæ”¯æŒASCIIå­—ç¬¦
      ä¸­æ–‡å±äºUnicodeå­—ç¬¦ï¼Œéœ€è¦ç¼–ç 
```

### 5.2 æ–‡ä»¶åç¼–ç æ–¹æ¡ˆ


ğŸŸ¢ **æ–¹æ¡ˆä¸€ï¼šURLç¼–ç ï¼ˆæ¨èï¼‰**

```java
@GetMapping("/download-encode")
public ResponseEntity<Resource> downloadWithEncodedName(
        @RequestParam String filename) throws UnsupportedEncodingException {
    
    File file = new File("D:/files/" + filename);
    Resource resource = new FileSystemResource(file);
    
    // URLç¼–ç æ–‡ä»¶å
    String encodedFilename = URLEncoder.encode(filename, "UTF-8")
                                      .replaceAll("\\+", "%20");
    
    HttpHeaders headers = new HttpHeaders();
    headers.add(HttpHeaders.CONTENT_DISPOSITION, 
                "attachment; filename*=UTF-8''" + encodedFilename);
    
    return ResponseEntity.ok()
            .headers(headers)
            .body(resource);
}
```

ğŸ”¸ **ç¼–ç è¯´æ˜**
- `URLEncoder.encode()`ï¼šURLç¼–ç 
- `.replaceAll("\\+", "%20")`ï¼šç©ºæ ¼ç”¨%20ä»£æ›¿
- `filename*=UTF-8''`ï¼šRFC 5987æ ‡å‡†æ ¼å¼

ğŸŸ¡ **æ–¹æ¡ˆäºŒï¼šå…¼å®¹æ€§ç¼–ç **

```java
private String encodeFilename(String filename, 
                              HttpServletRequest request) 
        throws UnsupportedEncodingException {
    
    // è·å–æµè§ˆå™¨ç±»å‹
    String userAgent = request.getHeader("User-Agent");
    
    if (userAgent.contains("MSIE") || userAgent.contains("Trident")) {
        // IEæµè§ˆå™¨ï¼šä½¿ç”¨URLEncoder
        return URLEncoder.encode(filename, "UTF-8")
                        .replaceAll("\\+", "%20");
    } else if (userAgent.contains("Firefox")) {
        // Firefoxï¼šä½¿ç”¨Base64ç¼–ç 
        return "=?UTF-8?B?" + 
               Base64.getEncoder().encodeToString(filename.getBytes("UTF-8")) + 
               "?=";
    } else {
        // Chromeã€Safariç­‰ï¼šä½¿ç”¨æ ‡å‡†ç¼–ç 
        return new String(filename.getBytes("UTF-8"), "ISO-8859-1");
    }
}
```

### 5.3 æœ€ä½³å®è·µæ–¹æ¡ˆ


```java
@GetMapping("/download-best")
public ResponseEntity<Resource> downloadBest(
        @RequestParam String filename,
        HttpServletRequest request) {
    
    File file = new File("D:/files/" + filename);
    Resource resource = new FileSystemResource(file);
    
    // åŒæ—¶æä¾›ä¸¤ç§ç¼–ç æ–¹å¼
    String encodedFilename = encodeForAllBrowsers(filename, request);
    
    HttpHeaders headers = new HttpHeaders();
    headers.add(HttpHeaders.CONTENT_DISPOSITION, 
                "attachment; " +
                "filename=\"" + encodedFilename + "\"; " +
                "filename*=UTF-8''" + 
                URLEncoder.encode(filename, StandardCharsets.UTF_8)
                         .replaceAll("\\+", "%20"));
    
    return ResponseEntity.ok()
            .headers(headers)
            .body(resource);
}
```

---

## 6. â¯ï¸ æ–­ç‚¹ç»­ä¼ æœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯æ–­ç‚¹ç»­ä¼ 


ğŸ”¸ **ç”Ÿæ´»åœºæ™¯**
```
åœºæ™¯ï¼šä¸‹è½½ä¸€ä¸ª2GBçš„ç”µå½±
é—®é¢˜ï¼šä¸‹è½½åˆ°1.5GBæ—¶ï¼Œç½‘ç»œæ–­äº†

âŒ æ²¡æœ‰æ–­ç‚¹ç»­ä¼ ï¼š
   é‡æ–°å¼€å§‹ï¼Œä»0GBä¸‹è½½

âœ… æœ‰æ–­ç‚¹ç»­ä¼ ï¼š
   ç»§ç»­ä¸‹è½½ï¼Œä»1.5GBå¼€å§‹
```

ğŸ”¸ **æ ¸å¿ƒåŸç†**
- æµè§ˆå™¨å‘Šè¯‰æœåŠ¡å™¨ï¼šæˆ‘å·²ç»æœ‰äº†å¤šå°‘æ•°æ®
- æœåŠ¡å™¨ä»æŒ‡å®šä½ç½®å¼€å§‹å‘é€å‰©ä½™æ•°æ®
- å…³é”®HTTPå¤´ï¼š`Range` å’Œ `Content-Range`

### 6.2 Rangeè¯·æ±‚å¤´æ ¼å¼


```
å®¢æˆ·ç«¯è¯·æ±‚ç¤ºä¾‹ï¼š
Range: bytes=0-499        â†’ è¯·æ±‚å‰500å­—èŠ‚
Range: bytes=500-999      â†’ è¯·æ±‚ç¬¬500-999å­—èŠ‚
Range: bytes=500-         â†’ è¯·æ±‚ä»500å­—èŠ‚åˆ°ç»“å°¾
Range: bytes=-500         â†’ è¯·æ±‚æœ€å500å­—èŠ‚

æœåŠ¡å™¨å“åº”ç¤ºä¾‹ï¼š
Content-Range: bytes 500-999/2000  â†’ è¿”å›500-999ï¼Œæ€»å…±2000å­—èŠ‚
```

### 6.3 æ–­ç‚¹ç»­ä¼ å®ç°


```java
@GetMapping("/download-range")
public ResponseEntity<Resource> downloadWithRange(
        @RequestParam String filename,
        @RequestHeader(value = "Range", required = false) String range) {
    
    try {
        File file = new File("D:/files/" + filename);
        long fileLength = file.length();
        
        // è§£æRangeè¯·æ±‚å¤´
        long start = 0;
        long end = fileLength - 1;
        
        if (range != null && range.startsWith("bytes=")) {
            String[] ranges = range.substring(6).split("-");
            start = Long.parseLong(ranges[0]);
            if (ranges.length > 1 && !ranges[1].isEmpty()) {
                end = Long.parseLong(ranges[1]);
            }
        }
        
        // è¯»å–æŒ‡å®šèŒƒå›´çš„æ•°æ®
        long contentLength = end - start + 1;
        byte[] data = new byte[(int) contentLength];
        
        try (RandomAccessFile raf = new RandomAccessFile(file, "r")) {
            raf.seek(start); // å®šä½åˆ°èµ·å§‹ä½ç½®
            raf.readFully(data);
        }
        
        // è®¾ç½®å“åº”å¤´
        HttpHeaders headers = new HttpHeaders();
        headers.add(HttpHeaders.CONTENT_DISPOSITION, 
                    "attachment; filename=" + filename);
        headers.add(HttpHeaders.CONTENT_RANGE, 
                    "bytes " + start + "-" + end + "/" + fileLength);
        headers.add(HttpHeaders.ACCEPT_RANGES, "bytes");
        
        // 206 Partial Content è¡¨ç¤ºéƒ¨åˆ†å†…å®¹
        return ResponseEntity.status(HttpStatus.PARTIAL_CONTENT)
                .headers(headers)
                .contentLength(contentLength)
                .body(new ByteArrayResource(data));
                
    } catch (IOException e) {
        return ResponseEntity.internalServerError().build();
    }
}
```

ğŸ”¸ **å…³é”®ç‚¹è¯´æ˜**
- `RandomAccessFile`ï¼šå¯ä»¥å®šä½åˆ°æ–‡ä»¶ä»»æ„ä½ç½®
- `HTTP 206`ï¼šè¡¨ç¤ºéƒ¨åˆ†å†…å®¹å“åº”
- `Content-Range`ï¼šå‘Šè¯‰å®¢æˆ·ç«¯è¿”å›çš„èŒƒå›´

### 6.4 æ–­ç‚¹ç»­ä¼ æµç¨‹å›¾


```
å®¢æˆ·ç«¯                                    æœåŠ¡å™¨
  |                                        |
  |--[1]è¯·æ±‚æ–‡ä»¶(æ— Range)------------------>|
  |                                        |
  |<-[2]è¿”å›206 + Accept-Ranges: bytes----|
  |   å‰1MBæ•°æ®                            |
  |                                        |
  |--[ç½‘ç»œä¸­æ–­]--                          |
  |                                        |
  |--[3]ç»­ä¼ è¯·æ±‚(Range: bytes=1048576-)---->|
  |   ä»1MBå¼€å§‹                            |
  |                                        |
  |<-[4]è¿”å›206 + Content-Range-----------|
  |   å‰©ä½™æ•°æ®                             |
  |                                        |
  |--[5]ä¸‹è½½å®Œæˆ]--                        |
```

---

## 7. ğŸ” ä¸‹è½½æƒé™æ§åˆ¶


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦æƒé™æ§åˆ¶


ğŸ”¸ **å®‰å…¨åœºæ™¯**
```
âŒ æ²¡æœ‰æƒé™æ§åˆ¶çš„é—®é¢˜ï¼š
â€¢ ä»»ä½•äººéƒ½èƒ½ä¸‹è½½æ•æ„Ÿæ–‡ä»¶
â€¢ ä»˜è´¹èµ„æºè¢«å…è´¹ä¸‹è½½
â€¢ é‡è¦æ–‡æ¡£è¢«éæ³•è·å–

âœ… æƒé™æ§åˆ¶çš„ä½œç”¨ï¼š
â€¢ éªŒè¯ç”¨æˆ·èº«ä»½
â€¢ æ£€æŸ¥ä¸‹è½½æƒé™
â€¢ è®°å½•ä¸‹è½½æ—¥å¿—
â€¢ é˜²æ­¢ç›—é“¾
```

### 7.2 åŸºäºTokençš„æƒé™æ§åˆ¶


```java
@GetMapping("/download-secure")
public ResponseEntity<Resource> downloadSecure(
        @RequestParam String filename,
        @RequestParam String token,
        HttpServletRequest request) {
    
    // 1. éªŒè¯Token
    if (!validateToken(token, filename)) {
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                .body(null);
    }
    
    // 2. éªŒè¯ä¸‹è½½æƒé™
    String userId = getUserIdFromToken(token);
    if (!hasDownloadPermission(userId, filename)) {
        return ResponseEntity.status(HttpStatus.FORBIDDEN)
                .body(null);
    }
    
    // 3. è®°å½•ä¸‹è½½æ—¥å¿—
    logDownload(userId, filename, request.getRemoteAddr());
    
    // 4. æ‰§è¡Œä¸‹è½½
    File file = new File("D:/files/" + filename);
    Resource resource = new FileSystemResource(file);
    
    HttpHeaders headers = new HttpHeaders();
    headers.add(HttpHeaders.CONTENT_DISPOSITION, 
                "attachment; filename=" + filename);
    
    return ResponseEntity.ok()
            .headers(headers)
            .body(resource);
}

// TokenéªŒè¯
private boolean validateToken(String token, String filename) {
    // éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆä¸”æœªè¿‡æœŸ
    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ç”¨JWTæˆ–Redis
    return tokenService.validate(token, filename);
}

// æƒé™æ£€æŸ¥
private boolean hasDownloadPermission(String userId, String filename) {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ä¸‹è½½è¯¥æ–‡ä»¶çš„æƒé™
    return permissionService.checkDownload(userId, filename);
}
```

### 7.3 é˜²ç›—é“¾å®ç°


```java
@GetMapping("/download-referer")
public ResponseEntity<Resource> downloadWithReferer(
        @RequestParam String filename,
        @RequestHeader(value = "Referer", required = false) String referer) {
    
    // æ£€æŸ¥Refereræ¥æº
    if (referer == null || !referer.startsWith("https://yoursite.com")) {
        return ResponseEntity.status(HttpStatus.FORBIDDEN)
                .body(null);
    }
    
    // æ‰§è¡Œä¸‹è½½...
    File file = new File("D:/files/" + filename);
    return ResponseEntity.ok()
            .header(HttpHeaders.CONTENT_DISPOSITION, 
                   "attachment; filename=" + filename)
            .body(new FileSystemResource(file));
}
```

### 7.4 ä¸´æ—¶ä¸‹è½½é“¾æ¥


```java
@Service
public class DownloadTokenService {
    
    private final Map<String, DownloadToken> tokenStore = new ConcurrentHashMap<>();
    
    /**
     * ç”Ÿæˆä¸´æ—¶ä¸‹è½½Tokenï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼‰
     */
    public String generateToken(String userId, String filename) {
        String token = UUID.randomUUID().toString();
        DownloadToken downloadToken = new DownloadToken(
            userId, 
            filename, 
            System.currentTimeMillis() + 5 * 60 * 1000 // 5åˆ†é’Ÿåè¿‡æœŸ
        );
        tokenStore.put(token, downloadToken);
        return token;
    }
    
    /**
     * éªŒè¯å¹¶æ¶ˆè´¹Tokenï¼ˆä¸€æ¬¡æ€§ï¼‰
     */
    public boolean validateAndConsume(String token, String filename) {
        DownloadToken downloadToken = tokenStore.remove(token);
        
        if (downloadToken == null) {
            return false; // Tokenä¸å­˜åœ¨
        }
        
        if (System.currentTimeMillis() > downloadToken.getExpireTime()) {
            return false; // Tokenå·²è¿‡æœŸ
        }
        
        return downloadToken.getFilename().equals(filename);
    }
}
```

---

## 8. ğŸ“¦ å¤§æ–‡ä»¶ä¸‹è½½ä¼˜åŒ–


### 8.1 å¤§æ–‡ä»¶ä¸‹è½½çš„æŒ‘æˆ˜


ğŸ”¸ **æ€§èƒ½é—®é¢˜**
```
æ–‡ä»¶å¤§å°ï¼š5GB
ä¼ ç»Ÿæ–¹å¼é—®é¢˜ï¼š
âŒ å†…å­˜å ç”¨ï¼š5GBï¼ˆä¸€æ¬¡æ€§åŠ è½½ï¼‰
âŒ å“åº”æ—¶é—´ï¼šé•¿æ—¶é—´ç­‰å¾…
âŒ å¹¶å‘é™åˆ¶ï¼š10ä¸ªå¹¶å‘=50GBå†…å­˜
âŒ ç½‘ç»œä¸­æ–­ï¼šä»å¤´å¼€å§‹
```

ğŸ”¸ **è§£å†³æ–¹æ¡ˆå¯¹æ¯”**

| æ–¹æ¡ˆ | **å†…å­˜å ç”¨** | **å“åº”é€Ÿåº¦** | **ç¨³å®šæ€§** | **éš¾åº¦** |
|------|------------|------------|-----------|---------|
| ğŸ”´ **ä¸€æ¬¡æ€§åŠ è½½** | `æ–‡ä»¶å¤§å°` | `æ…¢` | `å·®` | â­ ç®€å• |
| ğŸŸ¡ **åˆ†å—ä¼ è¾“** | `ç¼“å†²åŒºå¤§å°` | `ä¸­` | `ä¸­` | â­â­ ä¸­ç­‰ |
| ğŸŸ¢ **æµå¼+Range** | `ç¼“å†²åŒºå¤§å°` | `å¿«` | `ä¼˜` | â­â­â­ å¤æ‚ |
| ğŸ”µ **CDNåŠ é€Ÿ** | `æ— å½±å“` | `æå¿«` | `ä¼˜` | â­â­â­â­ é…ç½® |

### 8.2 åˆ†å—æµå¼ä¼ è¾“


```java
@GetMapping("/download-chunked")
public void downloadChunked(@RequestParam String filename,
                            HttpServletResponse response) {
    
    File file = new File("D:/files/" + filename);
    
    // è®¾ç½®å“åº”å¤´
    response.setContentType("application/octet-stream");
    response.setHeader("Content-Disposition", 
                      "attachment; filename=" + filename);
    response.setHeader("Transfer-Encoding", "chunked"); // åˆ†å—ä¼ è¾“
    
    try (FileInputStream fis = new FileInputStream(file);
         BufferedOutputStream bos = new BufferedOutputStream(
                 response.getOutputStream())) {
        
        byte[] buffer = new byte[1024 * 1024]; // 1MBç¼“å†²åŒº
        int bytesRead;
        
        while ((bytesRead = fis.read(buffer)) != -1) {
            bos.write(buffer, 0, bytesRead);
            bos.flush(); // ç«‹å³å‘é€ç»™å®¢æˆ·ç«¯
            
            // å¯é€‰ï¼šæ·»åŠ ä¸‹è½½é€Ÿåº¦é™åˆ¶
            Thread.sleep(10); // é™é€Ÿï¼š100KB/så·¦å³
        }
        
    } catch (Exception e) {
        throw new RuntimeException("ä¸‹è½½å¤±è´¥", e);
    }
}
```

### 8.3 å¼‚æ­¥ä¸‹è½½å¤„ç†


```java
@RestController
@RequestMapping("/async")
public class AsyncDownloadController {
    
    @Autowired
    private TaskExecutor taskExecutor;
    
    /**
     * å¼‚æ­¥å‡†å¤‡å¤§æ–‡ä»¶ä¸‹è½½
     */
    @PostMapping("/prepare")
    public ResponseEntity<String> prepareDownload(
            @RequestParam String filename) {
        
        String taskId = UUID.randomUUID().toString();
        
        // å¼‚æ­¥å¤„ç†æ–‡ä»¶å‡†å¤‡
        taskExecutor.execute(() -> {
            try {
                // å‹ç¼©æˆ–å¤„ç†å¤§æ–‡ä»¶
                prepareFileForDownload(filename, taskId);
                // æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼šå‡†å¤‡å®Œæˆ
                updateTaskStatus(taskId, "READY");
            } catch (Exception e) {
                updateTaskStatus(taskId, "FAILED");
            }
        });
        
        return ResponseEntity.ok(taskId);
    }
    
    /**
     * æŸ¥è¯¢å‡†å¤‡çŠ¶æ€
     */
    @GetMapping("/status/{taskId}")
    public ResponseEntity<String> getStatus(@PathVariable String taskId) {
        String status = getTaskStatus(taskId);
        return ResponseEntity.ok(status);
    }
    
    /**
     * ä¸‹è½½å‡†å¤‡å¥½çš„æ–‡ä»¶
     */
    @GetMapping("/download/{taskId}")
    public ResponseEntity<Resource> download(@PathVariable String taskId) {
        // ä¸‹è½½é€»è¾‘...
        return ResponseEntity.ok().build();
    }
}
```

ğŸ”¸ **å¼‚æ­¥ä¸‹è½½æµç¨‹**
```
å®¢æˆ·ç«¯è¯·æ±‚                     æœåŠ¡å™¨å¤„ç†
    |                             |
    |--[1]POST /prepare---------->|
    |   è¯·æ±‚å‡†å¤‡ä¸‹è½½              |----[å¼€å§‹å¼‚æ­¥ä»»åŠ¡]
    |                             |    å‹ç¼©/å¤„ç†æ–‡ä»¶
    |<-[2]è¿”å›taskId--------------|
    |   (ç«‹å³è¿”å›)                |
    |                             |
    |--[3]GET /status/{id}------->|
    |   è½®è¯¢çŠ¶æ€                  |<---[ä»»åŠ¡å®Œæˆ]
    |<-[4]è¿”å›READY---------------|
    |                             |
    |--[5]GET /download/{id}----->|
    |   ä¸‹è½½æ–‡ä»¶                  |
    |<-[6]è¿”å›æ–‡ä»¶æµ--------------|
```

### 8.4 å¤šçº¿ç¨‹åˆ†ç‰‡ä¸‹è½½


```java
@GetMapping("/download-multipart")
public ResponseEntity<Resource> downloadMultipart(
        @RequestParam String filename,
        @RequestParam(defaultValue = "0") int part,
        @RequestParam(defaultValue = "4") int totalParts) {
    
    File file = new File("D:/files/" + filename);
    long fileSize = file.length();
    long partSize = fileSize / totalParts;
    
    // è®¡ç®—å½“å‰åˆ†ç‰‡çš„èŒƒå›´
    long start = part * partSize;
    long end = (part == totalParts - 1) ? fileSize - 1 : start + partSize - 1;
    
    try (RandomAccessFile raf = new RandomAccessFile(file, "r")) {
        // å®šä½åˆ°åˆ†ç‰‡èµ·å§‹ä½ç½®
        raf.seek(start);
        
        // è¯»å–åˆ†ç‰‡æ•°æ®
        byte[] data = new byte[(int)(end - start + 1)];
        raf.readFully(data);
        
        HttpHeaders headers = new HttpHeaders();
        headers.add("Content-Disposition", 
                   "attachment; filename=" + filename + ".part" + part);
        headers.add("X-Part-Number", String.valueOf(part));
        headers.add("X-Total-Parts", String.valueOf(totalParts));
        
        return ResponseEntity.ok()
                .headers(headers)
                .body(new ByteArrayResource(data));
                
    } catch (IOException e) {
        return ResponseEntity.internalServerError().build();
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


ğŸ”¸ **æ–‡ä»¶ä¸‹è½½æœ¬è´¨**
```
æ ¸å¿ƒï¼šHTTPå“åº” = å“åº”å¤´ + æ–‡ä»¶å†…å®¹
å…³é”®ï¼šContent-Disposition å†³å®šä¸‹è½½æ–¹å¼
æµç¨‹ï¼šè¯»å–æ–‡ä»¶ â†’ è®¾ç½®å“åº”å¤´ â†’ å‘é€æ•°æ®
```

ğŸ”¸ **ä¸‰ç§å®ç°æ–¹å¼**

| æ–¹å¼ | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|------|------------|---------|---------|
| `ResponseEntity<byte[]>` | `å°æ–‡ä»¶(< 10MB)` | `ç®€å•ç›´è§‚` | `å†…å­˜å ç”¨é«˜` |
| `OutputStreamæµå¼` | `ä¸­å¤§æ–‡ä»¶` | `å†…å­˜å ç”¨ä½` | `ä»£ç ç¨å¤æ‚` |
| `StreamingResponseBody` | `å¤§æ–‡ä»¶ã€è§†é¢‘æµ` | `æ€§èƒ½æœ€ä¼˜` | `éœ€è¦Springæ”¯æŒ` |

### 9.2 å…³é”®æŠ€æœ¯ç‚¹


ğŸŸ¢ **åŸºç¡€å¿…ä¼š**
- âœ… ResponseEntityçš„ä½¿ç”¨
- âœ… HTTPå“åº”å¤´é…ç½®
- âœ… æ–‡ä»¶åç¼–ç å¤„ç†
- âœ… å¼‚å¸¸å¤„ç†ä¸å®‰å…¨æ£€æŸ¥

ğŸŸ¡ **è¿›é˜¶æŒæ¡**
- âš¡ æµå¼ä¸‹è½½å®ç°
- âš¡ æ–­ç‚¹ç»­ä¼ æœºåˆ¶
- âš¡ ä¸‹è½½æƒé™æ§åˆ¶
- âš¡ ä¸´æ—¶é“¾æ¥ç”Ÿæˆ

ğŸ”´ **é«˜çº§ä¼˜åŒ–**
- ğŸ”¥ å¤§æ–‡ä»¶åˆ†ç‰‡ä¸‹è½½
- ğŸ”¥ å¼‚æ­¥ä¸‹è½½å¤„ç†
- ğŸ”¥ ä¸‹è½½é™é€Ÿæ§åˆ¶
- ğŸ”¥ CDNåŠ é€Ÿé›†æˆ

### 9.3 å®é™…åº”ç”¨å»ºè®®


**åœºæ™¯é€‰æ‹©ï¼š**
```
ğŸ“„ æ–‡æ¡£ä¸‹è½½ï¼ˆPDFã€Wordï¼‰ï¼š
   â†’ ResponseEntity<Resource>
   â†’ æ·»åŠ æ–‡ä»¶åç¼–ç 
   â†’ æƒé™éªŒè¯

ğŸ“¹ è§†é¢‘ä¸‹è½½ï¼š
   â†’ StreamingResponseBody
   â†’ æ”¯æŒæ–­ç‚¹ç»­ä¼ 
   â†’ Rangeè¯·æ±‚

ğŸ“¦ å¤§æ–‡ä»¶ä¸‹è½½ï¼ˆ> 100MBï¼‰ï¼š
   â†’ æµå¼ä¼ è¾“
   â†’ åˆ†ç‰‡ä¸‹è½½
   â†’ å¼‚æ­¥å‡†å¤‡
```

**å®‰å…¨è¦ç‚¹ï¼š**
```
âš ï¸ è·¯å¾„å®‰å…¨ï¼šé˜²æ­¢ ../ è·¯å¾„ç©¿è¶Š
âš ï¸ æƒé™éªŒè¯ï¼šTokenæˆ–SessionéªŒè¯
âš ï¸ é˜²ç›—é“¾ï¼šæ£€æŸ¥Refereræ¥æº
âš ï¸ ä¸‹è½½é™åˆ¶ï¼šé¢‘ç‡é™åˆ¶ã€æµé‡æ§åˆ¶
```

### 9.4 å¸¸è§é—®é¢˜ä¸è§£å†³


ğŸ”¸ **ä¸­æ–‡æ–‡ä»¶åä¹±ç **
```
è§£å†³ï¼šä½¿ç”¨ filename*=UTF-8'' + URLEncoderç¼–ç 
å…¼å®¹ï¼šåŒæ—¶æä¾› filename å’Œ filename* ä¸¤ç§æ ¼å¼
```

ğŸ”¸ **å¤§æ–‡ä»¶ä¸‹è½½è¶…æ—¶**
```
è§£å†³ï¼šä½¿ç”¨æµå¼ä¼ è¾“ï¼Œä¸è¦ä¸€æ¬¡æ€§åŠ è½½
é…ç½®ï¼šå¢åŠ  spring.mvc.async.request-timeout
```

ğŸ”¸ **ä¸‹è½½è¿›åº¦ä¸æ˜¾ç¤º**
```
è§£å†³ï¼šè®¾ç½® Content-Length å“åº”å¤´
ä¼˜åŒ–ï¼šæ”¯æŒ Range è¯·æ±‚ï¼Œå®ç°æ–­ç‚¹ç»­ä¼ 
```

**æ ¸å¿ƒè®°å¿†å£è¯€ï¼š**
```
ğŸ“¥ æ–‡ä»¶ä¸‹è½½çœ‹åœºæ™¯ï¼Œå°æ–‡ä»¶æ•°ç»„å¤§æ–‡ä»¶æµ
ğŸ”¤ ä¸­æ–‡æ–‡ä»¶è¦ç¼–ç ï¼ŒUTF-8æ ‡å‡†æœ€ç¨³å¦¥
â¯ï¸ æ–­ç‚¹ç»­ä¼ ç”¨Rangeï¼Œ206çŠ¶æ€ä¸èƒ½å°‘
ğŸ” æƒé™æ§åˆ¶è¦åšå¥½ï¼ŒTokenéªŒè¯é˜²ç›—é“¾
ğŸ“¦ å¤§æ–‡ä»¶è¦ä¼˜åŒ–ï¼Œåˆ†ç‰‡å¼‚æ­¥æ€§èƒ½é«˜
```