---
title: 3ã€è¯·æ±‚æ‰§è¡Œé“¾ä¸è¿”å›æµç¨‹
---
## ğŸ“š ç›®å½•

1. [è¯·æ±‚æ‰§è¡Œé“¾æ¦‚è¿°](#1-è¯·æ±‚æ‰§è¡Œé“¾æ¦‚è¿°)
2. [è¯·æ±‚æµè½¬å®Œæ•´è¿‡ç¨‹](#2-è¯·æ±‚æµè½¬å®Œæ•´è¿‡ç¨‹)
3. [HandlerExecutionChainæ‰§è¡Œé“¾](#3-HandlerExecutionChainæ‰§è¡Œé“¾)
4. [æ‹¦æˆªå™¨è°ƒç”¨é“¾æœºåˆ¶](#4-æ‹¦æˆªå™¨è°ƒç”¨é“¾æœºåˆ¶)
5. [å¤„ç†å™¨æ‰§è¡Œè¿‡ç¨‹](#5-å¤„ç†å™¨æ‰§è¡Œè¿‡ç¨‹)
6. [å¼‚å¸¸å¤„ç†é“¾](#6-å¼‚å¸¸å¤„ç†é“¾)
7. [è§†å›¾æ¸²æŸ“è¿‡ç¨‹](#7-è§†å›¾æ¸²æŸ“è¿‡ç¨‹)
8. [èµ„æºæ¸…ç†ä¸æ€§èƒ½ç›‘æ§](#8-èµ„æºæ¸…ç†ä¸æ€§èƒ½ç›‘æ§)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŠ è¯·æ±‚æ‰§è¡Œé“¾æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯è¯·æ±‚æ‰§è¡Œé“¾


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ å»é¤å…åƒé¥­çš„æµç¨‹

```
ä½ è¿›é—¨ â†’ æœåŠ¡å‘˜æ¥å¾… â†’ ç‚¹èœ â†’ å¨å¸ˆåšèœ â†’ ä¸Šèœ â†’ ç”¨é¤ â†’ ç»“è´¦ç¦»å¼€

Spring MVCå¤„ç†è¯·æ±‚ä¹Ÿæ˜¯ç±»ä¼¼çš„"æµæ°´çº¿"è¿‡ç¨‹
æ¯ä¸ªç¯èŠ‚éƒ½æœ‰ç‰¹å®šçš„å·¥ä½œè¦åšï¼Œç¯ç¯ç›¸æ‰£
```

**ä¸“ä¸šå®šä¹‰**ï¼š
- **æ‰§è¡Œé“¾**ï¼šè¯·æ±‚ä»è¿›å…¥åˆ°å“åº”è¿”å›ï¼Œç»è¿‡çš„ä¸€ç³»åˆ—å¤„ç†æ­¥éª¤
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šä¸€ä¸ªHTTPè¯·æ±‚åœ¨Spring MVCä¸­çš„å®Œæ•´å¤„ç†å†ç¨‹
- **æ ¸å¿ƒç›®çš„**ï¼šæœ‰åºã€å¯æ§åœ°å®Œæˆè¯·æ±‚å¤„ç†ï¼Œä¿è¯æ¯ä¸ªç¯èŠ‚éƒ½èƒ½æ­£ç¡®æ‰§è¡Œ

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ‰§è¡Œé“¾


**è§£å†³çš„é—®é¢˜**ï¼š
```
âŒ æ²¡æœ‰æ‰§è¡Œé“¾çš„æ··ä¹±åœºæ™¯ï¼š
- ä¸çŸ¥é“è¯·æ±‚åº”è¯¥å…ˆåšä»€ä¹ˆååšä»€ä¹ˆ
- æƒé™æ£€æŸ¥ã€æ—¥å¿—è®°å½•æ²¡æœ‰ç»Ÿä¸€ç®¡ç†
- å‡ºé”™äº†ä¸çŸ¥é“åœ¨å“ªä¸ªç¯èŠ‚å¤„ç†
- å¤šä¸ªåŠŸèƒ½äº’ç›¸å¹²æ‰°

âœ… æœ‰äº†æ‰§è¡Œé“¾çš„å¥½å¤„ï¼š
- æµç¨‹æ¸…æ™°ï¼šæ¯æ­¥åšä»€ä¹ˆä¸€ç›®äº†ç„¶
- èŒè´£åˆ†ç¦»ï¼šå„å¸å…¶èŒï¼Œäº’ä¸å¹²æ‰°
- æ˜“äºæ‰©å±•ï¼šæƒ³åŠ æ–°åŠŸèƒ½æ’å…¥å¯¹åº”ä½ç½®å³å¯
- ç»Ÿä¸€ç®¡ç†ï¼šå¼‚å¸¸ã€æ—¥å¿—ç­‰é›†ä¸­å¤„ç†
```

### 1.3 æ‰§è¡Œé“¾çš„æ•´ä½“æµç¨‹å›¾


```
ç”¨æˆ·æµè§ˆå™¨                    Spring MVCå®¹å™¨
    |                              |
    |--[1] HTTPè¯·æ±‚--------------->|
    |                              |
    |                         DispatcherServlet
    |                              |
    |                         [2] æŸ¥æ‰¾Handler
    |                              |
    |                         HandlerMapping
    |                              |
    |                         [3] è¿”å›æ‰§è¡Œé“¾
    |                              |
    |                         HandlerExecutionChain
    |                         (Handler + æ‹¦æˆªå™¨)
    |                              |
    |                         [4] å‰ç½®æ‹¦æˆªå™¨
    |                              |
    |                         [5] æ‰§è¡ŒHandler
    |                              |
    |                         [6] åç½®æ‹¦æˆªå™¨
    |                              |
    |                         [7] è§†å›¾æ¸²æŸ“
    |                              |
    |<--[8] HTTPå“åº”---------------|
    |                              |
```

---

## 2. ğŸ”„ è¯·æ±‚æµè½¬å®Œæ•´è¿‡ç¨‹


### 2.1 å…«æ­¥å®Œæ•´æµç¨‹


**ç¬¬ä¸€æ­¥ï¼šç”¨æˆ·å‘èµ·è¯·æ±‚**
```
æµè§ˆå™¨ â†’ http://localhost:8080/user/list

è¿™å°±åƒä½ åˆ°é¤å…é—¨å£ï¼ŒæœåŠ¡å‘˜è¿˜æ²¡æ¥å¾…ä½ 
è¯·æ±‚åˆšåˆ°è¾¾æœåŠ¡å™¨ï¼Œç­‰å¾…å¤„ç†
```

**ç¬¬äºŒæ­¥ï¼šDispatcherServletæ¥æ”¶è¯·æ±‚**
```java
// DispatcherServlet æ˜¯ Spring MVC çš„"å‰å°æ€»è°ƒåº¦"
// æ‰€æœ‰è¯·æ±‚éƒ½å…ˆåˆ°å®ƒè¿™é‡Œ
public class DispatcherServlet {
    // æ¥æ”¶è¯·æ±‚çš„å…¥å£æ–¹æ³•
    protected void doService(HttpServletRequest request, 
                            HttpServletResponse response) {
        // å¼€å§‹å¤„ç†è¯·æ±‚
    }
}
```

> ğŸ’¡ **ç†è§£è¦ç‚¹**ï¼šDispatcherServletå°±åƒé¤å…çš„å‰å°ç»ç†ï¼Œæ‰€æœ‰å®¢äººï¼ˆè¯·æ±‚ï¼‰éƒ½å…ˆæ‰¾ä»–ï¼Œä»–æ¥åˆ†é…åç»­å·¥ä½œ

**ç¬¬ä¸‰æ­¥ï¼šæŸ¥æ‰¾å¤„ç†å™¨æ˜ å°„å™¨**
```
DispatcherServleté—®ï¼šè¿™ä¸ªè¯·æ±‚è°æ¥å¤„ç†ï¼Ÿ

HandlerMappingå›ç­”ï¼š
"/user/list" â†’ UserController.list()æ–¹æ³•
å°±åƒå‰å°æŸ¥çœ‹é¢„è®¢æœ¬ï¼Œæ‰¾åˆ°å¯¹åº”çš„æœåŠ¡å‘˜
```

**ç¬¬å››æ­¥ï¼šè·å–å¤„ç†å™¨æ‰§è¡Œé“¾**
```
ä¸åªæ˜¯æ‰¾åˆ°Handlerï¼ˆå¤„ç†å™¨ï¼‰ï¼Œè¿˜è¦æ‰¾åˆ°ï¼š
- æ‰€æœ‰ç›¸å…³çš„æ‹¦æˆªå™¨
- å®ƒä»¬çš„æ‰§è¡Œé¡ºåº

è¿”å›ä¸€ä¸ª"æ‰§è¡Œé“¾"å¯¹è±¡ï¼šHandlerExecutionChain
```

**ç¬¬äº”æ­¥ï¼šæ‰§è¡Œæ‹¦æˆªå™¨å‰ç½®æ–¹æ³•**
```
æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰æ‹¦æˆªå™¨çš„ preHandle()
- ç™»å½•æ£€æŸ¥
- æƒé™éªŒè¯  
- æ—¥å¿—è®°å½•
- è¯·æ±‚å‚æ•°é¢„å¤„ç†

ä»»ä½•ä¸€ä¸ªæ‹¦æˆªå™¨è¿”å›falseï¼Œæµç¨‹ä¸­æ–­ï¼
```

**ç¬¬å…­æ­¥ï¼šæ‰§è¡ŒHandlerå¤„ç†å™¨**
```java
// è¿™æ‰æ˜¯çœŸæ­£æ‰§è¡Œä½ å†™çš„Controlleræ–¹æ³•
@GetMapping("/user/list")
public String list() {
    // ä½ çš„ä¸šåŠ¡é€»è¾‘
    return "userList";
}
```

**ç¬¬ä¸ƒæ­¥ï¼šæ‰§è¡Œæ‹¦æˆªå™¨åç½®æ–¹æ³•**
```
å€’åºæ‰§è¡Œæ‰€æœ‰æ‹¦æˆªå™¨çš„ postHandle()
- ç»Ÿä¸€æ·»åŠ å“åº”å¤´
- ä¿®æ”¹è¿”å›æ•°æ®
- è®°å½•æ‰§è¡Œæ—¶é—´
```

**ç¬¬å…«æ­¥ï¼šæ¸²æŸ“è§†å›¾å¹¶è¿”å›**
```
æ ¹æ®è¿”å›å€¼å†³å®šå¦‚ä½•å“åº”ï¼š
- è¿”å›è§†å›¾å â†’ æ¸²æŸ“é¡µé¢
- è¿”å› @ResponseBody â†’ ç›´æ¥è¿”å›JSON
- é‡å®šå‘/è½¬å‘ â†’ è·³è½¬å…¶ä»–åœ°å€
```

### 2.2 æµç¨‹æ—¶åºå›¾


```
å®¢æˆ·ç«¯          DispatcherServlet    HandlerMapping    æ‹¦æˆªå™¨é“¾    Handler    ViewResolver
  |                    |                   |             |          |             |
  |--è¯·æ±‚------------->|                   |             |          |             |
  |                    |                   |             |          |             |
  |                    |--æŸ¥æ‰¾Handler----->|             |          |             |
  |                    |<--è¿”å›æ‰§è¡Œé“¾------|             |          |             |
  |                    |                   |             |          |             |
  |                    |--preHandle------->|             |          |             |
  |                    |<--è¿”å›true--------|             |          |             |
  |                    |                   |             |          |             |
  |                    |--æ‰§è¡Œå¤„ç†å™¨------------------->|          |             |
  |                    |<--è¿”å›ModelAndView-------------|          |             |
  |                    |                   |             |          |             |
  |                    |--postHandle------>|             |          |             |
  |                    |<--å¤„ç†å®Œæˆ--------|             |          |             |
  |                    |                   |             |          |             |
  |                    |--è§£æè§†å›¾å----------------------------------->|         |
  |                    |<--è¿”å›Viewå¯¹è±¡----------------------------------|         |
  |                    |                   |             |          |             |
  |                    |--æ¸²æŸ“è§†å›¾-------->|             |          |             |
  |<--å“åº”-------------|                   |             |          |             |
```

---

## 3. â›“ï¸ HandlerExecutionChainæ‰§è¡Œé“¾


### 3.1 æ‰§è¡Œé“¾æ˜¯ä»€ä¹ˆ


**é€šä¿—æ¯”å–»**ï¼š
```
æ‰§è¡Œé“¾ = ä¸€ä¸²ç³–è‘«èŠ¦

ğŸ¡ æ‹¦æˆªå™¨1
ğŸ¡ æ‹¦æˆªå™¨2  
ğŸ¡ æ‹¦æˆªå™¨3
ğŸ¡ Handlerå¤„ç†å™¨ï¼ˆæ ¸å¿ƒï¼‰

è¯·æ±‚åƒç«¹ç­¾ä¸€æ ·ç©¿è¿‡è¿™äº›"å±±æ¥‚"
æ¯ä¸ªéƒ½è¦ç»è¿‡ï¼ŒæŒ‰é¡ºåºå¤„ç†
```

**æ ¸å¿ƒç»„æˆ**ï¼š
- **Handler**ï¼šçœŸæ­£å¤„ç†è¯·æ±‚çš„æ–¹æ³•ï¼ˆControlleræ–¹æ³•ï¼‰
- **Interceptor[]**ï¼šæ‹¦æˆªå™¨æ•°ç»„ï¼ŒæŒ‰é¡ºåºæ’åˆ—
- **æ‰§è¡Œé¡ºåº**ï¼šå›ºå®šçš„è°ƒç”¨è§„åˆ™

### 3.2 æ‰§è¡Œé“¾çš„ç»“æ„


```java
public class HandlerExecutionChain {
    
    // æ ¸å¿ƒå¤„ç†å™¨ï¼ˆä½ çš„Controlleræ–¹æ³•ï¼‰
    private final Object handler;
    
    // æ‹¦æˆªå™¨æ•°ç»„ï¼ˆå¯ä»¥æœ‰å¤šä¸ªï¼‰
    private HandlerInterceptor[] interceptors;
    
    // è®°å½•æ‰§è¡Œåˆ°å“ªä¸ªæ‹¦æˆªå™¨äº†
    private int interceptorIndex = -1;
}
```

> ğŸ“ **ç†è§£è¦ç‚¹**ï¼š
> - `handler` æ˜¯æœ€ç»ˆè¦æ‰§è¡Œçš„ç›®æ ‡ï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼‰
> - `interceptors` æ˜¯"ä¿é•–"ï¼Œåœ¨æ ¸å¿ƒä¸šåŠ¡å‰ååšæ£€æŸ¥
> - `interceptorIndex` è®°å½•æ‰§è¡Œè¿›åº¦ï¼Œç”¨äºå¼‚å¸¸æ—¶çš„å›æ»š

### 3.3 æ‰§è¡Œé“¾çš„å·¥ä½œæ–¹å¼


**å‰è¿›æ‰§è¡Œæµç¨‹**ï¼š
```
è¯·æ±‚æ¥äº† â†’ æ‰§è¡Œé“¾å¼€å§‹å·¥ä½œ

1. æ‹¦æˆªå™¨A.preHandle()  â†’ è¿”å›trueï¼Œç»§ç»­
2. æ‹¦æˆªå™¨B.preHandle()  â†’ è¿”å›trueï¼Œç»§ç»­  
3. æ‹¦æˆªå™¨C.preHandle()  â†’ è¿”å›trueï¼Œç»§ç»­
4. Handler.method()     â†’ æ‰§è¡Œä¸šåŠ¡é€»è¾‘
5. æ‹¦æˆªå™¨C.postHandle() â†’ å€’åºæ‰§è¡Œ
6. æ‹¦æˆªå™¨B.postHandle()
7. æ‹¦æˆªå™¨A.postHandle()
8. è§†å›¾æ¸²æŸ“
9. æ‹¦æˆªå™¨C.afterCompletion()
10. æ‹¦æˆªå™¨B.afterCompletion()
11. æ‹¦æˆªå™¨A.afterCompletion()
```

**ä¸­æ–­æ‰§è¡Œæµç¨‹**ï¼š
```
å¦‚æœæ‹¦æˆªå™¨Bçš„preHandle()è¿”å›falseï¼š

1. æ‹¦æˆªå™¨A.preHandle()  â†’ è¿”å›trueï¼Œç»§ç»­
2. æ‹¦æˆªå™¨B.preHandle()  â†’ è¿”å›falseï¼Œä¸­æ–­ï¼
   
æ­¤æ—¶ï¼š
- ä¸å†ç»§ç»­å¾€ä¸‹æ‰§è¡Œ
- åªå›è°ƒå·²æ‰§è¡Œçš„æ‹¦æˆªå™¨çš„afterCompletion()
- æ‹¦æˆªå™¨A.afterCompletion() â†’ æ¸…ç†èµ„æº
```

### 3.4 æ‰§è¡Œé“¾ç¤ºä¾‹ä»£ç 


```java
// åˆ›å»ºæ‰§è¡Œé“¾
HandlerExecutionChain chain = new HandlerExecutionChain(handler);

// æ·»åŠ æ‹¦æˆªå™¨
chain.addInterceptor(new LoginInterceptor());
chain.addInterceptor(new PermissionInterceptor());
chain.addInterceptor(new LogInterceptor());

// è¿™å°±æ„æˆäº†å®Œæ•´çš„æ‰§è¡Œé“¾
```

| ç»„æˆéƒ¨åˆ† | **ä½œç”¨** | **æ‰§è¡Œæ—¶æœº** | **æ˜¯å¦å¿…éœ€** |
|---------|---------|-------------|-------------|
| Handler | å¤„ç†ä¸šåŠ¡é€»è¾‘ | æ‹¦æˆªå™¨preHandleä¹‹å | âœ… å¿…éœ€ |
| preHandle | å‰ç½®æ£€æŸ¥ | Handleræ‰§è¡Œå‰ | âŒ å¯é€‰ |
| postHandle | åç½®å¤„ç† | Handleræ‰§è¡Œå | âŒ å¯é€‰ |
| afterCompletion | æœ€ç»ˆæ¸…ç† | è§†å›¾æ¸²æŸ“å | âŒ å¯é€‰ |

---

## 4. ğŸ”— æ‹¦æˆªå™¨è°ƒç”¨é“¾æœºåˆ¶


### 4.1 æ‹¦æˆªå™¨æ˜¯ä»€ä¹ˆ


**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
æ‹¦æˆªå™¨ = å®‰æ£€é—¨

ä½ å»åé£æœºï¼š
1. å®‰æ£€å£æ£€æŸ¥èº«ä»½è¯ï¼ˆç™»å½•æ£€æŸ¥ï¼‰
2. å®‰æ£€æœºæ£€æŸ¥è¡Œæï¼ˆæƒé™éªŒè¯ï¼‰
3. æµ·å…³æ£€æŸ¥ç­¾è¯ï¼ˆä¸šåŠ¡è§„åˆ™ï¼‰

æ¯é“"é—¨"éƒ½è¦è¿‡ï¼Œä¸€ä¸ªä¸é€šè¿‡å°±è¿›ä¸å»
```

**ä¸“ä¸šå®šä¹‰**ï¼š
- **æ‹¦æˆªå™¨**ï¼šåœ¨è¯·æ±‚å¤„ç†å‰åæ‰§è¡Œçš„é€šç”¨é€»è¾‘
- **è°ƒç”¨é“¾**ï¼šå¤šä¸ªæ‹¦æˆªå™¨æŒ‰é¡ºåºæ‰§è¡Œå½¢æˆçš„é“¾æ¡
- **æ ¸å¿ƒæ¥å£**ï¼š`HandlerInterceptor`

### 4.2 æ‹¦æˆªå™¨çš„ä¸‰ä¸ªæ–¹æ³•


```java
public interface HandlerInterceptor {
    
    // 1. å‰ç½®æ–¹æ³•ï¼šHandleræ‰§è¡Œå‰è°ƒç”¨
    default boolean preHandle(HttpServletRequest request, 
                             HttpServletResponse response, 
                             Object handler) throws Exception {
        return true; // true=ç»§ç»­æ‰§è¡Œï¼Œfalse=ä¸­æ–­
    }
    
    // 2. åç½®æ–¹æ³•ï¼šHandleræ‰§è¡Œåï¼Œè§†å›¾æ¸²æŸ“å‰è°ƒç”¨
    default void postHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler, 
                           ModelAndView modelAndView) throws Exception {
    }
    
    // 3. å®Œæˆæ–¹æ³•ï¼šæ•´ä¸ªè¯·æ±‚å¤„ç†å®Œæˆåè°ƒç”¨ï¼ˆä¸€å®šä¼šæ‰§è¡Œï¼‰
    default void afterCompletion(HttpServletRequest request, 
                                HttpServletResponse response, 
                                Object handler, 
                                Exception ex) throws Exception {
    }
}
```

> ğŸ’¡ **é‡ç‚¹ç†è§£**ï¼š
> - `preHandle`ï¼šå¯ä»¥é˜»æ­¢è¯·æ±‚ç»§ç»­ï¼ˆè¿”å›falseï¼‰
> - `postHandle`ï¼šå¯ä»¥ä¿®æ”¹è¿”å›çš„æ•°æ®
> - `afterCompletion`ï¼šä¸€å®šä¼šæ‰§è¡Œï¼Œç”¨äºæ¸…ç†èµ„æº

### 4.3 æ‹¦æˆªå™¨çš„æ‰§è¡Œé¡ºåº


**æ­£å¸¸æµç¨‹é¡ºåº**ï¼š
```
é…ç½®é¡ºåºï¼šæ‹¦æˆªå™¨A â†’ æ‹¦æˆªå™¨B â†’ æ‹¦æˆªå™¨C

æ‰§è¡Œé¡ºåºï¼š
A.preHandle()    â†“ æ­£åºæ‰§è¡Œ
B.preHandle()    â†“
C.preHandle()    â†“
     â†“
Handler.method() â† æ ¸å¿ƒä¸šåŠ¡
     â†“
C.postHandle()   â†‘ å€’åºæ‰§è¡Œ
B.postHandle()   â†‘
A.postHandle()   â†‘
     â†“
  è§†å›¾æ¸²æŸ“
     â†“
C.afterCompletion() â†‘ å€’åºæ‰§è¡Œ
B.afterCompletion() â†‘
A.afterCompletion() â†‘
```

**ä¸­æ–­æµç¨‹é¡ºåº**ï¼š
```
å‡è®¾B.preHandle()è¿”å›falseï¼š

æ‰§è¡Œé¡ºåºï¼š
A.preHandle() â†’ trueï¼Œç»§ç»­
B.preHandle() â†’ falseï¼Œä¸­æ–­ï¼

åªæ‰§è¡Œï¼š
A.afterCompletion() â† æ¸…ç†å·²æ‰§è¡Œçš„

ä¸æ‰§è¡Œï¼š
- Cçš„ä»»ä½•æ–¹æ³•
- Bçš„postHandleå’ŒafterCompletion
- Handler
```

### 4.4 å®æˆ˜æ‹¦æˆªå™¨ç¤ºä¾‹


**ç™»å½•æ£€æŸ¥æ‹¦æˆªå™¨**ï¼š
```java
public class LoginInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) {
        
        // æ£€æŸ¥sessionä¸­æ˜¯å¦æœ‰ç”¨æˆ·ä¿¡æ¯
        Object user = request.getSession().getAttribute("user");
        
        if (user == null) {
            // æœªç™»å½•ï¼Œè·³è½¬ç™»å½•é¡µ
            response.sendRedirect("/login");
            return false; // ä¸­æ–­è¯·æ±‚
        }
        
        return true; // å·²ç™»å½•ï¼Œç»§ç»­æ‰§è¡Œ
    }
}
```

**æ—¥å¿—è®°å½•æ‹¦æˆªå™¨**ï¼š
```java
public class LogInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) {
        // è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
        long startTime = System.currentTimeMillis();
        request.setAttribute("startTime", startTime);
        
        System.out.println("è¯·æ±‚å¼€å§‹ï¼š" + request.getRequestURI());
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                               HttpServletResponse response, 
                               Object handler, 
                               Exception ex) {
        // è®¡ç®—è¯·æ±‚è€—æ—¶
        long startTime = (Long) request.getAttribute("startTime");
        long endTime = System.currentTimeMillis();
        
        System.out.println("è¯·æ±‚ç»“æŸï¼Œè€—æ—¶ï¼š" + (endTime - startTime) + "ms");
    }
}
```

### 4.5 æ‹¦æˆªå™¨é…ç½®


```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        
        // ç™»å½•æ‹¦æˆªå™¨ï¼ˆç¬¬ä¸€ä¸ªæ‰§è¡Œï¼‰
        registry.addInterceptor(new LoginInterceptor())
                .addPathPatterns("/**")           // æ‹¦æˆªæ‰€æœ‰
                .excludePathPatterns("/login");   // æ’é™¤ç™»å½•é¡µ
        
        // æƒé™æ‹¦æˆªå™¨ï¼ˆç¬¬äºŒä¸ªæ‰§è¡Œï¼‰
        registry.addInterceptor(new PermissionInterceptor())
                .addPathPatterns("/admin/**");    // åªæ‹¦æˆªç®¡ç†å‘˜è·¯å¾„
        
        // æ—¥å¿—æ‹¦æˆªå™¨ï¼ˆæœ€åæ‰§è¡Œï¼‰
        registry.addInterceptor(new LogInterceptor())
                .addPathPatterns("/**");
    }
}
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼š
> - é…ç½®é¡ºåº = æ‰§è¡Œé¡ºåº
> - è¦æ³¨æ„è·¯å¾„åŒ¹é…è§„åˆ™
> - æ’é™¤è·¯å¾„è¦æ˜ç¡®ï¼Œé¿å…æ­»å¾ªç¯

---

## 5. âš™ï¸ å¤„ç†å™¨æ‰§è¡Œè¿‡ç¨‹


### 5.1 å¤„ç†å™¨æ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼š
```
å¤„ç†å™¨(Handler) = é¤å…çš„å¨å¸ˆ

ä½ ç‚¹äº†ä¸€é“èœ(è¯·æ±‚) â†’ å¨å¸ˆ(Handler)åšèœ(å¤„ç†ä¸šåŠ¡)

å¤„ç†å™¨å°±æ˜¯çœŸæ­£å¹²æ´»çš„Controlleræ–¹æ³•
å‰é¢çš„æ‹¦æˆªå™¨éƒ½æ˜¯"å‡†å¤‡å·¥ä½œ"
è¿™é‡Œæ‰æ˜¯"æ ¸å¿ƒä¸šåŠ¡"
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **Handler**ï¼šå¤„ç†è¯·æ±‚çš„å…·ä½“æ–¹æ³•ï¼ˆé€šå¸¸æ˜¯Controllerä¸­çš„æ–¹æ³•ï¼‰
- **HandlerAdapter**ï¼šé€‚é…å™¨ï¼Œè´Ÿè´£è°ƒç”¨Handler
- **è¿”å›å€¼**ï¼šå¤„ç†ç»“æœï¼Œå¯ä»¥æ˜¯è§†å›¾åã€æ•°æ®å¯¹è±¡ç­‰

### 5.2 å¤„ç†å™¨çš„æ‰§è¡Œæµç¨‹


```
1. HandlerAdapteræ£€æŸ¥Handlerç±»å‹
   â†“
2. å‡†å¤‡æ–¹æ³•å‚æ•°ï¼ˆä»è¯·æ±‚ä¸­æå–ï¼‰
   â†“
3. è°ƒç”¨Handleræ–¹æ³•
   â†“
4. å¤„ç†è¿”å›å€¼
   â†“
5. å°è£…æˆModelAndView
```

**è¯¦ç»†æ­¥éª¤è¯´æ˜**ï¼š

**æ­¥éª¤1ï¼šé€‰æ‹©åˆé€‚çš„é€‚é…å™¨**
```java
// Spring MVCæœ‰å¤šä¸ªé€‚é…å™¨å¤„ç†ä¸åŒç±»å‹çš„Handler
- RequestMappingHandlerAdapter  â†’ å¤„ç†@RequestMapping
- SimpleControllerHandlerAdapter â†’ å¤„ç†Controlleræ¥å£
- HttpRequestHandlerAdapter     â†’ å¤„ç†HttpRequestHandler

DispatcherServletä¼šè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„
```

**æ­¥éª¤2ï¼šå‚æ•°è§£æ**
```java
@GetMapping("/user/{id}")
public User getUser(@PathVariable Long id, 
                   @RequestParam String name) {
    // Springè‡ªåŠ¨ä»è¯·æ±‚ä¸­æå–å‚æ•°
    // idä»è·¯å¾„ä¸­è·å–
    // nameä»æŸ¥è¯¢å‚æ•°ä¸­è·å–
}
```

> ğŸ’¡ **ç†è§£è¦ç‚¹**ï¼šä½ ä¸éœ€è¦æ‰‹åŠ¨ä»requestä¸­å–å‚æ•°ï¼ŒSpringä¼šè‡ªåŠ¨è§£æå¹¶æ³¨å…¥

**æ­¥éª¤3ï¼šæ‰§è¡Œä¸šåŠ¡é€»è¾‘**
```java
@Service
public class UserService {
    public User getUser(Long id) {
        // è¿™é‡Œæ˜¯çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘
        // æŸ¥è¯¢æ•°æ®åº“
        // å¤„ç†æ•°æ®
        return user;
    }
}
```

**æ­¥éª¤4ï¼šå¤„ç†è¿”å›å€¼**
```java
// ä¸åŒè¿”å›å€¼ï¼Œä¸åŒå¤„ç†æ–¹å¼

// 1. è¿”å›è§†å›¾å
@GetMapping("/user/list")
public String list(Model model) {
    model.addAttribute("users", userList);
    return "userList";  // â†’ è§†å›¾åï¼Œä¼šå»æ‰¾userList.jsp
}

// 2. è¿”å›JSONæ•°æ®
@GetMapping("/api/user")
@ResponseBody
public User getUser() {
    return user;  // â†’ è‡ªåŠ¨è½¬æˆJSONè¿”å›
}

// 3. è¿”å›ModelAndView
@GetMapping("/user/detail")
public ModelAndView detail() {
    ModelAndView mv = new ModelAndView("userDetail");
    mv.addObject("user", user);
    return mv;
}
```

### 5.3 å¤„ç†å™¨æ–¹æ³•å‚æ•°


**å¸¸ç”¨å‚æ•°ç±»å‹**ï¼š

| å‚æ•°ç±»å‹ | **è¯´æ˜** | **ç¤ºä¾‹** |
|---------|---------|---------|
| `@PathVariable` | è·¯å¾„å‚æ•° | `/user/{id}` |
| `@RequestParam` | æŸ¥è¯¢å‚æ•° | `?name=å¼ ä¸‰` |
| `@RequestBody` | è¯·æ±‚ä½“ï¼ˆJSONï¼‰ | POSTçš„JSONæ•°æ® |
| `HttpServletRequest` | åŸå§‹è¯·æ±‚å¯¹è±¡ | éœ€è¦æ‰‹åŠ¨æ“ä½œæ—¶ |
| `Model` | æ•°æ®æ¨¡å‹ | ä¼ æ•°æ®ç»™è§†å›¾ |
| `@ModelAttribute` | è¡¨å•å¯¹è±¡ | è¡¨å•æäº¤ |

**å‚æ•°ç»‘å®šç¤ºä¾‹**ï¼š
```java
// è·¯å¾„å‚æ•°
@GetMapping("/user/{id}")
public String detail(@PathVariable Long id) {
    // idè‡ªåŠ¨ä»è·¯å¾„æå–
}

// æŸ¥è¯¢å‚æ•°
@GetMapping("/user/search")
public String search(@RequestParam String keyword) {
    // keywordä»?keyword=xxxæå–
}

// è¯·æ±‚ä½“JSON
@PostMapping("/user/save")
public String save(@RequestBody User user) {
    // userä»è¯·æ±‚ä½“JSONè‡ªåŠ¨è½¬æ¢
}
```

### 5.4 å¤„ç†å™¨è¿”å›å€¼å¤„ç†


**è¿”å›å€¼ç±»å‹åŠå¤„ç†**ï¼š

```
è¿”å›Stringï¼š
"userList" â†’ è§£ææˆè§†å›¾å â†’ æŸ¥æ‰¾userList.jsp
"redirect:/user/list" â†’ é‡å®šå‘
"forward:/user/detail" â†’ è½¬å‘

è¿”å›voidï¼š
è‡ªå·±å¤„ç†responseï¼Œæ‰‹åŠ¨å†™å…¥å“åº”

è¿”å›å¯¹è±¡+@ResponseBodyï¼š
è‡ªåŠ¨è½¬JSON â†’ ç›´æ¥å†™å…¥å“åº”ä½“

è¿”å›ModelAndViewï¼š
åŒ…å«è§†å›¾åå’Œæ•°æ® â†’ æ¸²æŸ“è§†å›¾
```

---

## 6. âš ï¸ å¼‚å¸¸å¤„ç†é“¾


### 6.1 å¼‚å¸¸å¤„ç†æœºåˆ¶


**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
å¼‚å¸¸å¤„ç† = åŒ»é™¢çš„åˆ†è¯Šå°

ä½ ç”Ÿç—…äº†ï¼ˆç¨‹åºå‡ºé”™ï¼‰ï¼š
1. å…ˆçœ‹æ˜¯ä»€ä¹ˆç—…ï¼ˆå¼‚å¸¸ç±»å‹ï¼‰
2. åˆ†é…åˆ°å¯¹åº”ç§‘å®¤ï¼ˆå¼‚å¸¸å¤„ç†å™¨ï¼‰
3. åŒ»ç”Ÿå¼€è¯ï¼ˆè¿”å›é”™è¯¯é¡µé¢/ä¿¡æ¯ï¼‰

ä¸åŒçš„ç—…çœ‹ä¸åŒçš„ç§‘ï¼Œä¸åŒçš„å¼‚å¸¸ä¸åŒå¤„ç†
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **å¼‚å¸¸å¤„ç†é“¾**ï¼šå¤šä¸ªå¼‚å¸¸å¤„ç†å™¨æŒ‰é¡ºåºå°è¯•å¤„ç†å¼‚å¸¸
- **HandlerExceptionResolver**ï¼šå¼‚å¸¸è§£æå™¨æ¥å£
- **@ExceptionHandler**ï¼šæ–¹æ³•çº§å¼‚å¸¸å¤„ç†æ³¨è§£

### 6.2 å¼‚å¸¸å¤„ç†æµç¨‹


```
Handleræ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸
        â†“
DispatcherServletæ•è·å¼‚å¸¸
        â†“
éå†å¼‚å¸¸å¤„ç†å™¨é“¾
        â†“
æ‰¾åˆ°èƒ½å¤„ç†çš„å¼‚å¸¸å¤„ç†å™¨
        â†“
è¿”å›é”™è¯¯è§†å›¾æˆ–é”™è¯¯ä¿¡æ¯
        â†“
å“åº”ç»™å®¢æˆ·ç«¯
```

### 6.3 ä¸‰çº§å¼‚å¸¸å¤„ç†


**ç¬¬ä¸€çº§ï¼šæ–¹æ³•çº§å¤„ç†ï¼ˆ@ExceptionHandlerï¼‰**
```java
@Controller
public class UserController {
    
    @GetMapping("/user/{id}")
    public String getUser(@PathVariable Long id) {
        if (id < 0) {
            throw new IllegalArgumentException("IDä¸èƒ½ä¸ºè´Ÿæ•°");
        }
        return "userDetail";
    }
    
    // åªå¤„ç†å½“å‰Controllerçš„å¼‚å¸¸
    @ExceptionHandler(IllegalArgumentException.class)
    public String handleError(Exception e, Model model) {
        model.addAttribute("error", e.getMessage());
        return "error";  // è·³è½¬é”™è¯¯é¡µé¢
    }
}
```

**ç¬¬äºŒçº§ï¼šå…¨å±€å¤„ç†ï¼ˆ@ControllerAdviceï¼‰**
```java
@ControllerAdvice
public class GlobalExceptionHandler {
    
    // å¤„ç†æ‰€æœ‰Controllerçš„å‚æ•°å¼‚å¸¸
    @ExceptionHandler(IllegalArgumentException.class)
    public ModelAndView handleParamError(Exception e) {
        ModelAndView mv = new ModelAndView("error");
        mv.addObject("message", "å‚æ•°é”™è¯¯ï¼š" + e.getMessage());
        return mv;
    }
    
    // å¤„ç†æ‰€æœ‰æœªçŸ¥å¼‚å¸¸
    @ExceptionHandler(Exception.class)
    @ResponseBody
    public Map<String, Object> handleUnknownError(Exception e) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 500);
        result.put("message", "ç³»ç»Ÿé”™è¯¯");
        return result;
    }
}
```

**ç¬¬ä¸‰çº§ï¼šé…ç½®çº§å¤„ç†**
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void configureHandlerExceptionResolvers(
            List<HandlerExceptionResolver> resolvers) {
        
        // æ·»åŠ è‡ªå®šä¹‰å¼‚å¸¸è§£æå™¨
        resolvers.add(new CustomExceptionResolver());
    }
}
```

### 6.4 å¼‚å¸¸å¤„ç†ä¼˜å…ˆçº§


```
ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š

1. @ExceptionHandler (æ–¹æ³•çº§)
   â†“ å½“å‰Controllerå†…éƒ¨çš„å¼‚å¸¸å¤„ç†
   
2. @ControllerAdvice (å…¨å±€çº§)
   â†“ å…¨å±€å¼‚å¸¸å¤„ç†
   
3. HandlerExceptionResolver (é…ç½®çº§)
   â†“ è‡ªå®šä¹‰å¼‚å¸¸è§£æå™¨
   
4. é»˜è®¤å¼‚å¸¸é¡µé¢
   â†“ Spring MVCé»˜è®¤çš„é”™è¯¯å¤„ç†
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼š
> - ä¼˜å…ˆçº§é«˜çš„å…ˆå¤„ç†
> - æ–¹æ³•çº§åªå¤„ç†å½“å‰Controller
> - å…¨å±€å¤„ç†å¯¹æ‰€æœ‰Controllerç”Ÿæ•ˆ
> - ä¸€ä¸ªå¼‚å¸¸åªä¼šè¢«å¤„ç†ä¸€æ¬¡

### 6.5 å®ç”¨å¼‚å¸¸å¤„ç†ç¤ºä¾‹


```java
@ControllerAdvice
public class ApiExceptionHandler {
    
    // å¤„ç†404
    @ExceptionHandler(NoHandlerFoundException.class)
    @ResponseBody
    public Result handle404() {
        return Result.error(404, "æ¥å£ä¸å­˜åœ¨");
    }
    
    // å¤„ç†ä¸šåŠ¡å¼‚å¸¸
    @ExceptionHandler(BusinessException.class)
    @ResponseBody
    public Result handleBusiness(BusinessException e) {
        return Result.error(e.getCode(), e.getMessage());
    }
    
    // å¤„ç†å‚æ•°æ ¡éªŒå¼‚å¸¸
    @ExceptionHandler(MethodArgumentNotValidException.class)
    @ResponseBody
    public Result handleValidation(MethodArgumentNotValidException e) {
        String msg = e.getBindingResult().getFieldError().getDefaultMessage();
        return Result.error(400, msg);
    }
}
```

---

## 7. ğŸ¨ è§†å›¾æ¸²æŸ“è¿‡ç¨‹


### 7.1 è§†å›¾æ¸²æŸ“æ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼š
```
è§†å›¾æ¸²æŸ“ = è£…ç›˜ä¸Šèœ

å¨å¸ˆåšå¥½èœï¼ˆHandlerå¤„ç†å®Œæ•°æ®ï¼‰
éœ€è¦è£…ç›˜ï¼ˆæ¸²æŸ“ï¼‰åä¸Šæ¡Œï¼ˆè¿”å›æµè§ˆå™¨ï¼‰

æ¸²æŸ“å°±æ˜¯æŠŠæ•°æ®"æ‰“æ‰®"æˆç”¨æˆ·èƒ½çœ‹çš„æ ·å­
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **è§†å›¾(View)**ï¼šæœ€ç»ˆå±•ç¤ºç»™ç”¨æˆ·çš„é¡µé¢
- **ViewResolver**ï¼šè§†å›¾è§£æå™¨ï¼Œæ‰¾åˆ°å¯¹åº”çš„è§†å›¾
- **æ¸²æŸ“**ï¼šæŠŠæ•°æ®å¡«å……åˆ°è§†å›¾æ¨¡æ¿ä¸­

### 7.2 è§†å›¾æ¸²æŸ“æµç¨‹


```
Handlerè¿”å›è§†å›¾å
        â†“
ViewResolverè§£æè§†å›¾å
        â†“
æ‰¾åˆ°å¯¹åº”çš„Viewå¯¹è±¡
        â†“
View.render()æ¸²æŸ“
        â†“
å¡«å……æ•°æ®åˆ°æ¨¡æ¿
        â†“
ç”Ÿæˆæœ€ç»ˆHTML
        â†“
å†™å…¥å“åº”æµ
```

**è¯¦ç»†æ­¥éª¤è¯´æ˜**ï¼š

**æ­¥éª¤1ï¼šè¿”å›è§†å›¾å**
```java
@GetMapping("/user/list")
public String list(Model model) {
    model.addAttribute("users", userService.findAll());
    return "user/list";  // è§†å›¾å
}
```

**æ­¥éª¤2ï¼šè§†å›¾è§£æå™¨å·¥ä½œ**
```java
// é…ç½®è§†å›¾è§£æå™¨
@Configuration
public class WebConfig {
    
    @Bean
    public InternalResourceViewResolver viewResolver() {
        InternalResourceViewResolver resolver = new InternalResourceViewResolver();
        resolver.setPrefix("/WEB-INF/views/");  // å‰ç¼€
        resolver.setSuffix(".jsp");              // åç¼€
        return resolver;
    }
}

// "user/list" â†’ "/WEB-INF/views/user/list.jsp"
```

**æ­¥éª¤3ï¼šæ¸²æŸ“è§†å›¾**
```jsp
<!-- user/list.jsp -->
<table>
    <c:forEach items="${users}" var="user">
        <tr>
            <td>${user.id}</td>
            <td>${user.name}</td>
        </tr>
    </c:forEach>
</table>
```

### 7.3 å¸¸è§è§†å›¾ç±»å‹


| è§†å›¾ç±»å‹ | **è¯´æ˜** | **ä½¿ç”¨åœºæ™¯** | **è¿”å›ç¤ºä¾‹** |
|---------|---------|-------------|-------------|
| **JSPè§†å›¾** | JSPé¡µé¢ | ä¼ ç»ŸWebåº”ç”¨ | `return "userList";` |
| **JSONè§†å›¾** | JSONæ•°æ® | APIæ¥å£ | `@ResponseBody` |
| **é‡å®šå‘è§†å›¾** | è·³è½¬å…¶ä»–URL | è¡¨å•æäº¤å | `return "redirect:/user/list";` |
| **è½¬å‘è§†å›¾** | è½¬å‘å…¶ä»–Controller | å†…éƒ¨è·³è½¬ | `return "forward:/user/detail";` |

**ä¸åŒè§†å›¾ç¤ºä¾‹**ï¼š

```java
// 1. è¿”å›JSPé¡µé¢
@GetMapping("/user/list")
public String list() {
    return "userList";  // â†’ userList.jsp
}

// 2. è¿”å›JSON
@GetMapping("/api/user")
@ResponseBody
public List<User> apiList() {
    return userService.findAll();  // â†’ è‡ªåŠ¨è½¬JSON
}

// 3. é‡å®šå‘
@PostMapping("/user/save")
public String save(User user) {
    userService.save(user);
    return "redirect:/user/list";  // â†’ é‡å®šå‘åˆ°åˆ—è¡¨é¡µ
}

// 4. è½¬å‘
@GetMapping("/user/detail")
public String detail() {
    return "forward:/user/info";  // â†’ è½¬å‘åˆ°infoæ–¹æ³•
}
```

### 7.4 è§†å›¾è§£æå™¨é…ç½®


**JSPè§†å›¾è§£æå™¨**ï¼š
```java
@Bean
public InternalResourceViewResolver jspResolver() {
    InternalResourceViewResolver resolver = new InternalResourceViewResolver();
    resolver.setPrefix("/WEB-INF/views/");
    resolver.setSuffix(".jsp");
    resolver.setOrder(1);  // ä¼˜å…ˆçº§
    return resolver;
}
```

**Thymeleafè§†å›¾è§£æå™¨**ï¼š
```java
@Bean
public ThymeleafViewResolver thymeleafResolver() {
    ThymeleafViewResolver resolver = new ThymeleafViewResolver();
    resolver.setTemplateEngine(templateEngine());
    resolver.setOrder(2);
    return resolver;
}
```

> ğŸ’¡ **ç†è§£è¦ç‚¹**ï¼š
> - å¯ä»¥é…ç½®å¤šä¸ªè§†å›¾è§£æå™¨
> - Orderå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
> - ç¬¬ä¸€ä¸ªèƒ½è§£æçš„è§£æå™¨ä¼šè¢«ä½¿ç”¨

### 7.5 æ•°æ®ä¼ é€’æ–¹å¼


**ä¼ é€’æ•°æ®åˆ°è§†å›¾çš„æ–¹æ³•**ï¼š

```java
// æ–¹å¼1ï¼šä½¿ç”¨Model
@GetMapping("/user/list")
public String list(Model model) {
    model.addAttribute("users", userList);
    model.addAttribute("total", 100);
    return "userList";
}

// æ–¹å¼2ï¼šä½¿ç”¨ModelAndView
@GetMapping("/user/list")
public ModelAndView list() {
    ModelAndView mv = new ModelAndView("userList");
    mv.addObject("users", userList);
    mv.addObject("total", 100);
    return mv;
}

// æ–¹å¼3ï¼šä½¿ç”¨Map
@GetMapping("/user/list")
public String list(Map<String, Object> map) {
    map.put("users", userList);
    map.put("total", 100);
    return "userList";
}
```

---

## 8. ğŸ§¹ èµ„æºæ¸…ç†ä¸æ€§èƒ½ç›‘æ§


### 8.1 èµ„æºæ¸…ç†æœºåˆ¶


**ä¸ºä»€ä¹ˆéœ€è¦æ¸…ç†èµ„æº**ï¼š
```
å°±åƒåƒå®Œé¥­è¦æ”¶æ‹¾æ¡Œå­

è¯·æ±‚å¤„ç†å®Œåå¯èƒ½æœ‰ï¼š
- æ‰“å¼€çš„æ•°æ®åº“è¿æ¥
- å ç”¨çš„å†…å­˜å¯¹è±¡
- ä¸´æ—¶æ–‡ä»¶
- çº¿ç¨‹èµ„æº

ä¸æ¸…ç†ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€èµ„æºè€—å°½
```

**æ¸…ç†æ—¶æœº**ï¼š
```
afterCompletion()æ–¹æ³•ï¼š
- æ— è®ºè¯·æ±‚æˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½ä¼šæ‰§è¡Œ
- åœ¨è§†å›¾æ¸²æŸ“å®Œæˆåè°ƒç”¨
- æ˜¯æœ€åçš„æ¸…ç†æœºä¼š
```

### 8.2 èµ„æºæ¸…ç†å®ç°


```java
public class ResourceInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) {
        // è¯·æ±‚å¼€å§‹ï¼Œåˆå§‹åŒ–èµ„æº
        DataSourceContext.setDataSource("master");
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                               HttpServletResponse response, 
                               Object handler, 
                               Exception ex) {
        // è¯·æ±‚ç»“æŸï¼Œæ¸…ç†èµ„æº
        DataSourceContext.clear();  // æ¸…é™¤çº¿ç¨‹å˜é‡
        
        // è®°å½•æ—¥å¿—
        if (ex != null) {
            log.error("è¯·æ±‚å¼‚å¸¸ï¼š", ex);
        }
    }
}
```

### 8.3 æ€§èƒ½ç›‘æ§ç‚¹


**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

| ç›‘æ§ç‚¹ | **å«ä¹‰** | **ä½œç”¨** | **æ­£å¸¸èŒƒå›´** |
|-------|---------|---------|-------------|
| **è¯·æ±‚æ€»è€—æ—¶** | ä»æ¥æ”¶åˆ°è¿”å› | å‘ç°æ…¢è¯·æ±‚ | < 1ç§’ |
| **Handleræ‰§è¡Œæ—¶é—´** | ä¸šåŠ¡é€»è¾‘è€—æ—¶ | ä¼˜åŒ–ä¸šåŠ¡ä»£ç  | < 500ms |
| **è§†å›¾æ¸²æŸ“æ—¶é—´** | é¡µé¢ç”Ÿæˆè€—æ—¶ | ä¼˜åŒ–æ¨¡æ¿ | < 200ms |
| **æ‹¦æˆªå™¨è€—æ—¶** | æ‰€æœ‰æ‹¦æˆªå™¨æ€»æ—¶é—´ | å‡å°‘æ‹¦æˆªå™¨é€»è¾‘ | < 50ms |

**æ€§èƒ½ç›‘æ§å®ç°**ï¼š
```java
public class PerformanceInterceptor implements HandlerInterceptor {
    
    private static final String START_TIME = "startTime";
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) {
        // è®°å½•å¼€å§‹æ—¶é—´
        long startTime = System.currentTimeMillis();
        request.setAttribute(START_TIME, startTime);
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                               HttpServletResponse response, 
                               Object handler, 
                               Exception ex) {
        // è®¡ç®—æ€»è€—æ—¶
        long startTime = (Long) request.getAttribute(START_TIME);
        long endTime = System.currentTimeMillis();
        long executeTime = endTime - startTime;
        
        // æ…¢è¯·æ±‚è­¦å‘Š
        if (executeTime > 1000) {
            log.warn("æ…¢è¯·æ±‚ï¼š{}, è€—æ—¶ï¼š{}ms", 
                    request.getRequestURI(), executeTime);
        }
        
        // è®°å½•æ€§èƒ½æŒ‡æ ‡
        log.info("URI: {}, è€—æ—¶: {}ms", 
                request.getRequestURI(), executeTime);
    }
}
```

### 8.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**å¸¸è§æ€§èƒ½é—®é¢˜åŠä¼˜åŒ–**ï¼š

```
ğŸ”¥ é—®é¢˜1ï¼šæ‹¦æˆªå™¨å¤ªå¤šï¼Œæ¯ä¸ªéƒ½æ‰§è¡Œ
ä¼˜åŒ–ï¼šåˆå¹¶æ‹¦æˆªå™¨é€»è¾‘ï¼Œå‡å°‘æ‹¦æˆªå™¨æ•°é‡

ğŸ”¥ é—®é¢˜2ï¼šè§†å›¾æ¸²æŸ“æ…¢
ä¼˜åŒ–ï¼šä½¿ç”¨ç¼“å­˜ã€å‡å°‘æ•°æ®åº“æŸ¥è¯¢ã€ä¼˜åŒ–æ¨¡æ¿

ğŸ”¥ é—®é¢˜3ï¼šè¯·æ±‚å‚æ•°è¿‡å¤§
ä¼˜åŒ–ï¼šä½¿ç”¨åˆ†é¡µã€å‹ç¼©æ•°æ®ã€å¼‚æ­¥å¤„ç†

ğŸ”¥ é—®é¢˜4ï¼šé¢‘ç¹åˆ›å»ºå¯¹è±¡
ä¼˜åŒ–ï¼šä½¿ç”¨å¯¹è±¡æ± ã€å•ä¾‹æ¨¡å¼
```

**ç›‘æ§æ•°æ®ä½¿ç”¨**ï¼š
```java
// å°†æ€§èƒ½æ•°æ®å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
public class MonitorInterceptor implements HandlerInterceptor {
    
    @Autowired
    private MetricService metricService;
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                               HttpServletResponse response, 
                               Object handler, 
                               Exception ex) {
        
        long executeTime = calculateTime(request);
        
        // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
        metricService.record(
            "request.time",           // æŒ‡æ ‡å
            executeTime,              // æŒ‡æ ‡å€¼
            request.getRequestURI()   // æ ‡ç­¾
        );
        
        // è§¦å‘å‘Šè­¦
        if (executeTime > 3000) {
            alertService.sendAlert("è¶…æ—¶è¯·æ±‚ï¼š" + request.getRequestURI());
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 è¯·æ±‚æ‰§è¡Œé“¾å…¨æ™¯å›¾


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¯·æ±‚æ‰§è¡Œé“¾                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  1. ç”¨æˆ·è¯·æ±‚ â†’ DispatcherServlet                             â”‚
â”‚         â†“                                                     â”‚
â”‚  2. æŸ¥æ‰¾Handler â†’ HandlerMapping                             â”‚
â”‚         â†“                                                     â”‚
â”‚  3. è·å–æ‰§è¡Œé“¾ â†’ HandlerExecutionChain                        â”‚
â”‚         â†“                                                     â”‚
â”‚  4. å‰ç½®æ‹¦æˆª â†’ preHandle() (å¯ä¸­æ–­)                          â”‚
â”‚         â†“                                                     â”‚
â”‚  5. æ‰§è¡ŒHandler â†’ Controlleræ–¹æ³•                              â”‚
â”‚         â†“                                                     â”‚
â”‚  6. åç½®æ‹¦æˆª â†’ postHandle()                                   â”‚
â”‚         â†“                                                     â”‚
â”‚  7. å¼‚å¸¸å¤„ç† â†’ ExceptionHandler (å¦‚æœ‰å¼‚å¸¸)                    â”‚
â”‚         â†“                                                     â”‚
â”‚  8. è§†å›¾æ¸²æŸ“ â†’ ViewResolver + View                            â”‚
â”‚         â†“                                                     â”‚
â”‚  9. æœ€ç»ˆæ¸…ç† â†’ afterCompletion()                              â”‚
â”‚         â†“                                                     â”‚
â”‚  10. å“åº”è¿”å› â†’ æµè§ˆå™¨                                        â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ¯ æ‰§è¡Œé“¾ç»„æˆ**ï¼š
- `HandlerExecutionChain` = Handler + Interceptor[]
- Handlerï¼šæ ¸å¿ƒä¸šåŠ¡å¤„ç†æ–¹æ³•
- Interceptorï¼šå‰åé€šç”¨å¤„ç†é€»è¾‘

**ğŸ¯ æ‹¦æˆªå™¨ä¸‰æ–¹æ³•**ï¼š
- `preHandle`ï¼šå‰ç½®æ£€æŸ¥ï¼Œå¯ä¸­æ–­ï¼ˆè¿”å›falseï¼‰
- `postHandle`ï¼šåç½®å¤„ç†ï¼Œä¿®æ”¹è¿”å›å€¼
- `afterCompletion`ï¼šæœ€ç»ˆæ¸…ç†ï¼Œä¸€å®šæ‰§è¡Œ

**ğŸ¯ æ‰§è¡Œé¡ºåºè§„åˆ™**ï¼š
- preHandleï¼šæ­£åºæ‰§è¡Œï¼ˆAâ†’Bâ†’Cï¼‰
- postHandleï¼šå€’åºæ‰§è¡Œï¼ˆCâ†’Bâ†’Aï¼‰
- afterCompletionï¼šå€’åºæ‰§è¡Œï¼ˆCâ†’Bâ†’Aï¼‰

**ğŸ¯ å¼‚å¸¸å¤„ç†ä¼˜å…ˆçº§**ï¼š
1. @ExceptionHandlerï¼ˆæ–¹æ³•çº§ï¼Œæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. @ControllerAdviceï¼ˆå…¨å±€çº§ï¼‰
3. HandlerExceptionResolverï¼ˆé…ç½®çº§ï¼‰

**ğŸ¯ è§†å›¾æ¸²æŸ“è¿‡ç¨‹**ï¼š
- è¿”å›è§†å›¾å â†’ ViewResolverè§£æ â†’ Viewæ¸²æŸ“ â†’ è¾“å‡ºHTML

### 9.3 å®æˆ˜å…³é”®ç‚¹


> âœ… **æ‹¦æˆªå™¨ä½¿ç”¨è¦ç‚¹**ï¼š
> - ç™»å½•æ£€æŸ¥æ”¾æœ€å‰é¢
> - æ—¥å¿—è®°å½•æ”¾æœ€åé¢
> - æ³¨æ„è·¯å¾„åŒ¹é…è§„åˆ™
> - preHandleè¿”å›falseä¼šä¸­æ–­æµç¨‹

> âš ï¸ **å¼‚å¸¸å¤„ç†è¦ç‚¹**ï¼š
> - å…¨å±€å¼‚å¸¸å¤„ç†ç”¨@ControllerAdvice
> - ä¸šåŠ¡å¼‚å¸¸è¦è‡ªå®šä¹‰
> - ç»Ÿä¸€è¿”å›æ ¼å¼ï¼ˆcodeã€messageã€dataï¼‰
> - è®°å½•å¼‚å¸¸æ—¥å¿—

> ğŸ’¡ **æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**ï¼š
> - ç›‘æ§æ…¢è¯·æ±‚ï¼ˆ> 1ç§’ï¼‰
> - å‡å°‘æ‹¦æˆªå™¨æ•°é‡
> - ä¼˜åŒ–è§†å›¾æ¸²æŸ“
> - åŠæ—¶æ¸…ç†èµ„æº

> ğŸ”§ **è°ƒè¯•æŠ€å·§**ï¼š
> - åœ¨æ‹¦æˆªå™¨æ‰“æ—¥å¿—çœ‹æ‰§è¡Œé¡ºåº
> - æ£€æŸ¥preHandleè¿”å›å€¼
> - çœ‹afterCompletionçš„å¼‚å¸¸å‚æ•°
> - ç›‘æ§æ€§èƒ½æ•°æ®

### 9.4 å¸¸è§é—®é¢˜è§£ç­”


**Q1ï¼šä¸ºä»€ä¹ˆæ‹¦æˆªå™¨æ²¡æ‰§è¡Œï¼Ÿ**
```
æ£€æŸ¥ç‚¹ï¼š
1. æ˜¯å¦æ­£ç¡®é…ç½®ï¼Ÿ(addInterceptors)
2. è·¯å¾„åŒ¹é…æ˜¯å¦æ­£ç¡®ï¼Ÿ(addPathPatterns)
3. æ˜¯å¦è¢«æ’é™¤äº†ï¼Ÿ(excludePathPatterns)
4. å‰ä¸€ä¸ªæ‹¦æˆªå™¨æ˜¯å¦è¿”å›falseï¼Ÿ
```

**Q2ï¼šå¼‚å¸¸å¤„ç†ä¸ç”Ÿæ•ˆï¼Ÿ**
```
æ£€æŸ¥ç‚¹ï¼š
1. å¼‚å¸¸ç±»å‹æ˜¯å¦åŒ¹é…ï¼Ÿ
2. @ControllerAdviceæ˜¯å¦è¢«æ‰«æï¼Ÿ
3. æœ‰æ²¡æœ‰è¢«å…¶ä»–å¼‚å¸¸å¤„ç†å™¨æ‹¦æˆªï¼Ÿ
4. è¿”å›å€¼ç±»å‹æ˜¯å¦æ­£ç¡®ï¼Ÿ
```

**Q3ï¼šè§†å›¾æ‰¾ä¸åˆ°ï¼Ÿ**
```
æ£€æŸ¥ç‚¹ï¼š
1. è§†å›¾åæ˜¯å¦æ­£ç¡®ï¼Ÿ
2. ViewResolveré…ç½®å¯¹ä¸å¯¹ï¼Ÿ
3. å‰ç¼€åç¼€æ‹¼æ¥å¯¹ä¸å¯¹ï¼Ÿ
4. æ–‡ä»¶æ˜¯å¦çœŸçš„å­˜åœ¨ï¼Ÿ
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
è¯·æ±‚æ¥äº†å…ˆæ‹¦æˆªï¼Œæ­£åºæ£€æŸ¥èƒ½é€šè¿‡
Handleræ‰§è¡Œå¹²æ­£äº‹ï¼Œå€’åºæ‹¦æˆªå†å¤„ç†
å¼‚å¸¸å‘ç”Ÿæœ‰ä¸“äººï¼Œä¸‰çº§å¤„ç†ä¿å®‰å…¨
è§†å›¾æ¸²æŸ“æœ€åæ­¥ï¼Œæ•°æ®å¡«å……å˜é¡µé¢
èµ„æºæ¸…ç†è¦è®°å¾—ï¼Œæ€§èƒ½ç›‘æ§ä¿è´¨é‡
```