---
title: 4ã€è¿”å›å€¼å¤„ç†å™¨æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [è¿”å›å€¼å¤„ç†å™¨åŸºç¡€æ¦‚å¿µ](#1-è¿”å›å€¼å¤„ç†å™¨åŸºç¡€æ¦‚å¿µ)
2. [HandlerMethodReturnValueHandlerè¯¦è§£](#2-HandlerMethodReturnValueHandlerè¯¦è§£)
3. [å¸¸è§è¿”å›å€¼ç±»å‹è§£æ](#3-å¸¸è§è¿”å›å€¼ç±»å‹è§£æ)
4. [è§†å›¾åç§°è§£ææœºåˆ¶](#4-è§†å›¾åç§°è§£ææœºåˆ¶)
5. [ModelAndViewå¤„ç†æµç¨‹](#5-ModelAndViewå¤„ç†æµç¨‹)
6. [ResponseBodyå¤„ç†åŸç†](#6-ResponseBodyå¤„ç†åŸç†)
7. [å¼‚æ­¥ç»“æœå¤„ç†](#7-å¼‚æ­¥ç»“æœå¤„ç†)
8. [è‡ªå®šä¹‰è¿”å›å€¼å¤„ç†å™¨](#8-è‡ªå®šä¹‰è¿”å›å€¼å¤„ç†å™¨)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è¿”å›å€¼å¤„ç†å™¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è¿”å›å€¼å¤„ç†å™¨


**é€šä¿—ç†è§£**ï¼šControlleræ–¹æ³•æ‰§è¡Œå®Œåä¼šè¿”å›å„ç§ç±»å‹çš„ç»“æœï¼Œè¿”å›å€¼å¤„ç†å™¨å°±æ˜¯ä¸“é—¨è´Ÿè´£æŠŠè¿™äº›ä¸åŒç±»å‹çš„è¿”å›å€¼"ç¿»è¯‘"æˆæµè§ˆå™¨èƒ½ç†è§£çš„å“åº”ã€‚

```
ç±»æ¯”ç”Ÿæ´»åœºæ™¯ï¼š
ä½ å»é¤å…ç‚¹é¤ï¼Œå¨å¸ˆåšå¥½èœåï¼š
- æœ‰çš„èœç›´æ¥ç«¯ä¸Šæ¡Œ â†’ ç±»ä¼¼ç›´æ¥è¿”å›è§†å›¾é¡µé¢
- æœ‰çš„èœéœ€è¦æ‰“åŒ… â†’ ç±»ä¼¼è¿”å›JSONæ•°æ®
- æœ‰çš„èœéœ€è¦æ‘†ç›˜è£…é¥° â†’ ç±»ä¼¼ModelAndViewåŒ…è£…

è¿”å›å€¼å¤„ç†å™¨å°±æ˜¯é‚£ä¸ª"ä¼ èœå‘˜"ï¼Œæ ¹æ®ä¸åŒæƒ…å†µå†³å®šæ€ä¹ˆæŠŠèœé€åˆ°ä½ é¢å‰
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è¿”å›å€¼å¤„ç†å™¨


**æ ¸å¿ƒä½œç”¨**ï¼š
- âœ… **ç»Ÿä¸€å¤„ç†**ï¼šä¸åŒè¿”å›ç±»å‹ç”¨ç»Ÿä¸€çš„æ–¹å¼å¤„ç†
- âœ… **çµæ´»æ‰©å±•**ï¼šå¯ä»¥æ”¯æŒè‡ªå®šä¹‰è¿”å›ç±»å‹
- âœ… **èŒè´£åˆ†ç¦»**ï¼šè®©Controllerä¸“æ³¨ä¸šåŠ¡ï¼Œå¤„ç†å™¨è´Ÿè´£å“åº”è½¬æ¢

```
Controllerè¿”å›å€¼çš„å¤šæ ·æ€§ï¼š
@GetMapping("/user")
public String getUser()              â†’ è¿”å›è§†å›¾åç§°
public ModelAndView getUserView()    â†’ è¿”å›è§†å›¾å’Œæ•°æ®
public @ResponseBody User getJson()  â†’ è¿”å›JSONæ•°æ®
public void writeResponse()          â†’ ç›´æ¥å†™å“åº”æµ
public DeferredResult async()        â†’ å¼‚æ­¥è¿”å›ç»“æœ

æ¯ç§è¿”å›æ–¹å¼çš„å¤„ç†é€»è¾‘éƒ½ä¸åŒï¼Œéœ€è¦ä¸“é—¨çš„å¤„ç†å™¨ï¼
```

### 1.3 è¿”å›å€¼å¤„ç†æµç¨‹æ¦‚è§ˆ


```
è¯·æ±‚å¤„ç†æµç¨‹ï¼š
æµè§ˆå™¨è¯·æ±‚ 
    â†“
DispatcherServletæ¥æ”¶
    â†“
HandlerAdapterè°ƒç”¨Controlleræ–¹æ³•
    â†“
Controlleræ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›ç»“æœ
    â†“
[è¿”å›å€¼å¤„ç†å™¨ç™»åœº] â† æˆ‘ä»¬ç°åœ¨å­¦ä¹ çš„éƒ¨åˆ†
    â†“
â‘  åˆ¤æ–­èƒ½å¦å¤„ç†è¿™ä¸ªè¿”å›å€¼ç±»å‹
â‘¡ è§£æè¿”å›å€¼
â‘¢ å°†ç»“æœå†™å…¥å“åº”æˆ–æ¸²æŸ“è§†å›¾
    â†“
å“åº”è¿”å›ç»™æµè§ˆå™¨
```

---

## 2. ğŸ”§ HandlerMethodReturnValueHandlerè¯¦è§£


### 2.1 æ ¸å¿ƒæ¥å£å®šä¹‰


**æ¥å£ä½œç”¨**ï¼šå®šä¹‰äº†è¿”å›å€¼å¤„ç†å™¨çš„æ ‡å‡†è§„èŒƒ

```java
public interface HandlerMethodReturnValueHandler {
    
    // åˆ¤æ–­æ˜¯å¦æ”¯æŒå¤„ç†è¿™ä¸ªè¿”å›å€¼ç±»å‹
    boolean supportsReturnType(MethodParameter returnType);
    
    // çœŸæ­£å¤„ç†è¿”å›å€¼çš„æ–¹æ³•
    void handleReturnValue(
        Object returnValue,              // è¿”å›å€¼å¯¹è±¡
        MethodParameter returnType,      // è¿”å›å€¼ç±»å‹ä¿¡æ¯
        ModelAndViewContainer mavContainer, // æ¨¡å‹è§†å›¾å®¹å™¨
        NativeWebRequest webRequest      // Webè¯·æ±‚å¯¹è±¡
    ) throws Exception;
}
```

**é€šä¿—è§£é‡Š**ï¼š
- `supportsReturnType`ï¼šé—®"è¿™ä¸ªæ´»ä½ èƒ½å¹²å—ï¼Ÿ"
- `handleReturnValue`ï¼šå›ç­”"èƒ½å¹²"åï¼Œå°±å¼€å§‹å¹²æ´»

### 2.2 å·¥ä½œæœºåˆ¶


```
å¤„ç†å™¨é€‰æ‹©æµç¨‹ï¼š

Controllerè¿”å›äº†ä¸€ä¸ªStringç±»å‹ "hello"
    â†“
Springéå†æ‰€æœ‰è¿”å›å€¼å¤„ç†å™¨ï¼š
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ViewNameMethodReturnValueHandler    â”‚
â”‚ supportsReturnType? â†’ YES! æˆ‘èƒ½å¤„ç† â”‚ â† é€‰ä¸­è¿™ä¸ª
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RequestResponseBodyMethodProcessor  â”‚
â”‚ supportsReturnType? â†’ NO,æœ‰@ResponseBodyæ‰è¡Œâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰¾åˆ°åˆé€‚çš„å¤„ç†å™¨åï¼Œè°ƒç”¨handleReturnValueè¿›è¡Œå¤„ç†
```

### 2.3 å†…ç½®å¤„ç†å™¨å®¶æ—


Spring MVCå†…ç½®äº†å¤šä¸ªè¿”å›å€¼å¤„ç†å™¨ï¼Œå„å¸å…¶èŒï¼š

| å¤„ç†å™¨åç§° | è´Ÿè´£å¤„ç†çš„è¿”å›å€¼ | åº”ç”¨åœºæ™¯ |
|----------|----------------|---------|
| **ViewNameMethodReturnValueHandler** | `String`ç±»å‹è§†å›¾å | è¿”å›JSP/Thymeleafé¡µé¢å |
| **ModelAndViewMethodReturnValueHandler** | `ModelAndView`å¯¹è±¡ | åŒæ—¶è¿”å›è§†å›¾å’Œæ•°æ® |
| **RequestResponseBodyMethodProcessor** | `@ResponseBody`æ ‡æ³¨çš„æ–¹æ³• | è¿”å›JSON/XMLæ•°æ® |
| **HttpEntityMethodProcessor** | `HttpEntity/ResponseEntity` | ç²¾ç»†æ§åˆ¶HTTPå“åº” |
| **ModelMethodProcessor** | `Model`å¯¹è±¡ | åªè¿”å›æ•°æ®æ¨¡å‹ |
| **ViewMethodReturnValueHandler** | `View`å¯¹è±¡ | è¿”å›è§†å›¾å¯¹è±¡ |

---

## 3. ğŸ“‹ å¸¸è§è¿”å›å€¼ç±»å‹è§£æ


### 3.1 è¿”å›Stringç±»å‹


**åœºæ™¯è¯´æ˜**ï¼šæœ€å¸¸è§çš„è¿”å›è§†å›¾åç§°æ–¹å¼

```java
@Controller
public class UserController {
    
    @GetMapping("/user/list")
    public String listUsers(Model model) {
        model.addAttribute("users", userService.findAll());
        return "user/list";  // è¿”å›è§†å›¾åç§°
    }
}
```

**å¤„ç†è¿‡ç¨‹**ï¼š
```
è¿”å› "user/list"
    â†“
ViewNameMethodReturnValueHandlerå¤„ç†
    â†“
åˆ¤æ–­ï¼šè¿™æ˜¯ä¸ªè§†å›¾åç§°
    â†“
è®¾ç½®åˆ°ModelAndViewContainerä¸­
    â†“
åç»­ç”±ViewResolverè§£ææˆçœŸå®è§†å›¾è·¯å¾„
    â†“
/WEB-INF/views/user/list.jsp
```

### 3.2 è¿”å›voidç±»å‹


**åœºæ™¯è¯´æ˜**ï¼šç›´æ¥æ“ä½œå“åº”æµï¼Œä¸éœ€è¦è§†å›¾

```java
@GetMapping("/download")
public void downloadFile(HttpServletResponse response) {
    response.setContentType("application/pdf");
    // ç›´æ¥å†™å…¥å“åº”æµ
    OutputStream out = response.getOutputStream();
    // å†™å…¥æ–‡ä»¶å†…å®¹...
}
```

**å¤„ç†ç‰¹ç‚¹**ï¼š
- â­ æ–¹æ³•è‡ªå·±å¤„ç†äº†å“åº”ï¼Œä¸éœ€è¦é¢å¤–å¤„ç†
- â­ é€‚åˆä¸‹è½½æ–‡ä»¶ã€å¯¼å‡ºæ•°æ®ç­‰åœºæ™¯

### 3.3 è¿”å›å¯¹è±¡ç±»å‹


**åœºæ™¯è¯´æ˜**ï¼šè¿”å›æ™®é€šå¯¹è±¡ï¼Œé…åˆ`@ResponseBody`è½¬JSON

```java
@RestController  // ç­‰åŒäº @Controller + @ResponseBody
public class ApiController {
    
    @GetMapping("/api/user/{id}")
    public User getUser(@PathVariable Long id) {
        return userService.findById(id);  // è¿”å›Userå¯¹è±¡
    }
}
```

**å¤„ç†è¿‡ç¨‹**ï¼š
```
è¿”å›Userå¯¹è±¡
    â†“
RequestResponseBodyMethodProcessorå¤„ç†
    â†“
ä½¿ç”¨HttpMessageConverterè½¬æ¢
    â†“
MappingJackson2HttpMessageConverter
    â†“
å°†Userå¯¹è±¡è½¬æˆJSONå­—ç¬¦ä¸²
    â†“
{"id":1,"name":"å¼ ä¸‰","age":25}
    â†“
å†™å…¥HTTPå“åº”ä½“
```

---

## 4. ğŸ” è§†å›¾åç§°è§£ææœºåˆ¶


### 4.1 è§†å›¾åç§°å¤„ç†æµç¨‹


```
Controllerè¿”å› "user/detail"
    â†“
ViewNameMethodReturnValueHandlerå¤„ç†
    â†“
å­˜å…¥ModelAndViewContainer
    â†“
DispatcherServletå–å‡ºè§†å›¾å
    â†“
ViewResolverè§£æè§†å›¾åç§°
    â†“
æœ€ç»ˆè·¯å¾„ï¼š/WEB-INF/views/user/detail.jsp
```

### 4.2 è§†å›¾åç§°è§„åˆ™


**ç›´æ¥è§†å›¾å**ï¼š
```java
return "user/list";  
// â†’ æ¸²æŸ“ user/list.jsp é¡µé¢
```

**é‡å®šå‘**ï¼š
```java
return "redirect:/user/list";  
// â†’ æµè§ˆå™¨é‡å®šå‘åˆ° /user/list
```

**è½¬å‘**ï¼š
```java
return "forward:/user/detail";  
// â†’ æœåŠ¡å™¨å†…éƒ¨è½¬å‘åˆ° /user/detail
```

**è§†å›¾åç§°è§£æå¯¹ç…§è¡¨**ï¼š

| è¿”å›å€¼ | è§£æç»“æœ | è¯´æ˜ |
|-------|---------|------|
| `"home"` | `/WEB-INF/views/home.jsp` | æ™®é€šè§†å›¾ |
| `"redirect:/login"` | é‡å®šå‘åˆ°`/login` | æµè§ˆå™¨åœ°å€æ æ”¹å˜ |
| `"forward:/process"` | è½¬å‘åˆ°`/process` | åœ°å€æ ä¸å˜ |
| `"user/detail"` | `/WEB-INF/views/user/detail.jsp` | å¸¦è·¯å¾„çš„è§†å›¾ |

### 4.3 è§†å›¾è§£æå™¨é…ç½®


```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    
    @Bean
    public InternalResourceViewResolver viewResolver() {
        InternalResourceViewResolver resolver = new InternalResourceViewResolver();
        resolver.setPrefix("/WEB-INF/views/");  // å‰ç¼€
        resolver.setSuffix(".jsp");              // åç¼€
        return resolver;
    }
}
```

**é…ç½®è¯´æ˜**ï¼š
- **å‰ç¼€ï¼ˆPrefixï¼‰**ï¼šè§†å›¾æ–‡ä»¶å­˜æ”¾çš„ç›®å½•
- **åç¼€ï¼ˆSuffixï¼‰**ï¼šè§†å›¾æ–‡ä»¶çš„æ‰©å±•å
- **ç»„åˆè§„åˆ™**ï¼šå‰ç¼€ + è§†å›¾å + åç¼€ = å®Œæ•´è·¯å¾„

---

## 5. ğŸ¨ ModelAndViewå¤„ç†æµç¨‹


### 5.1 ä»€ä¹ˆæ˜¯ModelAndView


**é€šä¿—ç†è§£**ï¼šæŠŠæ•°æ®ï¼ˆModelï¼‰å’Œé¡µé¢ï¼ˆViewï¼‰æ‰“åŒ…åœ¨ä¸€èµ·çš„å®¹å™¨

```
ç”Ÿæ´»ç±»æ¯”ï¼š
ä½ å»é¤å…åƒé¥­ï¼š
- Modelï¼ˆæ•°æ®ï¼‰= èœå“
- Viewï¼ˆè§†å›¾ï¼‰= é¤ç›˜
- ModelAndView = è£…å¥½èœçš„é¤ç›˜

ä¸€èµ·ç«¯ç»™ä½ ï¼Œæ—¢æœ‰èœåˆæœ‰ç›˜ï¼
```

### 5.2 ä½¿ç”¨æ–¹å¼


```java
@Controller
public class UserController {
    
    @GetMapping("/user/{id}")
    public ModelAndView getUserDetail(@PathVariable Long id) {
        ModelAndView mav = new ModelAndView();
        
        // è®¾ç½®æ•°æ®
        User user = userService.findById(id);
        mav.addObject("user", user);
        mav.addObject("title", "ç”¨æˆ·è¯¦æƒ…");
        
        // è®¾ç½®è§†å›¾
        mav.setViewName("user/detail");
        
        return mav;
    }
}
```

### 5.3 å¤„ç†æµç¨‹è¯¦è§£


```
Controllerè¿”å›ModelAndView
    â†“
ModelAndViewMethodReturnValueHandlerå¤„ç†
    â†“
æå–è§†å›¾åç§° â†’ "user/detail"
    â†“
æå–Modelæ•°æ® â†’ {user=Userå¯¹è±¡, title="ç”¨æˆ·è¯¦æƒ…"}
    â†“
å­˜å…¥ModelAndViewContainer
    â†“
DispatcherServletç»§ç»­å¤„ç†ï¼š
  â‘  ViewResolverè§£æè§†å›¾
  â‘¡ å°†Modelæ•°æ®æš´éœ²ç»™è§†å›¾
  â‘¢ æ¸²æŸ“é¡µé¢
```

### 5.4 ModelAndViewçš„ä¼˜åŠ¿


> ğŸ’¡ **é€‚ç”¨åœºæ™¯**ï¼š
> - âœ… éœ€è¦åŒæ—¶è¿”å›å¤šä¸ªæ•°æ®å’Œè§†å›¾æ—¶
> - âœ… éœ€è¦åœ¨ä¸€ä¸ªæ–¹æ³•ä¸­å¤„ç†å¤æ‚ä¸šåŠ¡é€»è¾‘
> - âœ… å¸Œæœ›ä»£ç ç»“æ„æ›´æ¸…æ™°çš„åœºæ™¯

**å¯¹æ¯”å…¶ä»–æ–¹å¼**ï¼š

```java
// æ–¹å¼1ï¼šModelAndViewï¼ˆæ¨èç”¨äºå¤æ‚åœºæ™¯ï¼‰
public ModelAndView method1() {
    ModelAndView mav = new ModelAndView("view");
    mav.addObject("key1", value1);
    mav.addObject("key2", value2);
    return mav;
}

// æ–¹å¼2ï¼šString + Modelï¼ˆæ¨èç”¨äºç®€å•åœºæ™¯ï¼‰
public String method2(Model model) {
    model.addAttribute("key1", value1);
    model.addAttribute("key2", value2);
    return "view";
}
```

---

## 6. ğŸ“¡ ResponseBodyå¤„ç†åŸç†


### 6.1 @ResponseBodyä½œç”¨


**æ ¸å¿ƒä½œç”¨**ï¼šå‘Šè¯‰Springä¸è¦æ¸²æŸ“è§†å›¾ï¼Œè€Œæ˜¯æŠŠè¿”å›å€¼ç›´æ¥å†™å…¥HTTPå“åº”ä½“

```java
@Controller
public class ApiController {
    
    // ä¸åŠ @ResponseBody â†’ è¿”å›è§†å›¾åç§°
    @GetMapping("/view")
    public String returnView() {
        return "hello";  // å¯»æ‰¾hello.jspé¡µé¢
    }
    
    // åŠ äº†@ResponseBody â†’ è¿”å›å­—ç¬¦ä¸²å†…å®¹
    @GetMapping("/text")
    @ResponseBody
    public String returnText() {
        return "hello";  // ç›´æ¥è¿”å›å­—ç¬¦ä¸²"hello"
    }
    
    // åŠ äº†@ResponseBody â†’ è¿”å›JSON
    @GetMapping("/json")
    @ResponseBody
    public User returnJson() {
        return new User(1L, "å¼ ä¸‰");  // è¿”å›JSONï¼š{"id":1,"name":"å¼ ä¸‰"}
    }
}
```

### 6.2 @RestControllerç®€åŒ–ç”¨æ³•


```java
// @RestController = @Controller + @ResponseBody
@RestController  // ç±»ä¸Šçš„@ResponseBodyå¯¹æ‰€æœ‰æ–¹æ³•ç”Ÿæ•ˆ
public class UserApiController {
    
    @GetMapping("/api/users")
    public List<User> getAllUsers() {
        return userService.findAll();  // è‡ªåŠ¨è½¬JSON
    }
}
```

### 6.3 å¤„ç†æµç¨‹æ·±åº¦è§£æ


```
å¸¦@ResponseBodyçš„æ–¹æ³•è¿”å›Userå¯¹è±¡
    â†“
RequestResponseBodyMethodProcessorå¤„ç†å™¨è¯†åˆ«
    â†“
æ£€æŸ¥æ˜¯å¦æœ‰@ResponseBodyæ³¨è§£ â†’ æœ‰ï¼
    â†“
è°ƒç”¨HttpMessageConverterè½¬æ¢å™¨
    â†“
é€‰æ‹©åˆé€‚çš„è½¬æ¢å™¨ï¼š
  - è¿”å›å¯¹è±¡ â†’ MappingJackson2HttpMessageConverter
  - è¿”å›String â†’ StringHttpMessageConverter
  - è¿”å›byte[] â†’ ByteArrayHttpMessageConverter
    â†“
å°†å¯¹è±¡è½¬æ¢æˆæŒ‡å®šæ ¼å¼ï¼ˆJSON/XML/æ–‡æœ¬ï¼‰
    â†“
è®¾ç½®å“åº”å¤´ï¼šContent-Type: application/json
    â†“
å†™å…¥HTTPå“åº”ä½“
    â†“
æµè§ˆå™¨æ”¶åˆ°JSONæ•°æ®
```

### 6.4 å†…å®¹åå•†æœºåˆ¶


**ä»€ä¹ˆæ˜¯å†…å®¹åå•†**ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å•†é‡ç”¨ä»€ä¹ˆæ ¼å¼ä¼ è¾“æ•°æ®

```
å®¢æˆ·ç«¯è¯·æ±‚æ—¶å¸¦ä¸ŠAcceptå¤´ï¼š
GET /api/user/1
Accept: application/json  â† æˆ‘æƒ³è¦JSONæ ¼å¼

æœåŠ¡å™¨å¤„ç†ï¼š
    â†“
æ£€æŸ¥Acceptå¤´ â†’ application/json
    â†“
é€‰æ‹©Jacksonè½¬æ¢å™¨
    â†“
è¿”å›JSONï¼š{"id":1,"name":"å¼ ä¸‰"}
    â†“
è®¾ç½®å“åº”å¤´ï¼šContent-Type: application/json
```

**æ”¯æŒçš„æ ¼å¼ç±»å‹**ï¼š
- `application/json` â†’ JSONæ ¼å¼
- `application/xml` â†’ XMLæ ¼å¼
- `text/html` â†’ HTMLæ ¼å¼
- `text/plain` â†’ çº¯æ–‡æœ¬æ ¼å¼

---

## 7. â° å¼‚æ­¥ç»“æœå¤„ç†


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥å¤„ç†


**åŒæ­¥å¤„ç†çš„é—®é¢˜**ï¼š
```
ä¼ ç»ŸåŒæ­¥æ–¹å¼ï¼š
å®¢æˆ·ç«¯è¯·æ±‚ â†’ Tomcatçº¿ç¨‹å¤„ç† â†’ ç­‰å¾…ä¸šåŠ¡æ‰§è¡Œï¼ˆå¯èƒ½å¾ˆæ…¢ï¼‰â†’ è¿”å›ç»“æœ
                    â†‘
                çº¿ç¨‹ä¸€ç›´è¢«å ç”¨ï¼
                
å‡è®¾ï¼š
- Tomcatæœ€å¤§çº¿ç¨‹æ•°ï¼š200
- æŸä¸ªè¯·æ±‚éœ€è¦5ç§’å¤„ç†
- åŒæ—¶æ¥äº†200ä¸ªè¯·æ±‚
â†’ æ‰€æœ‰çº¿ç¨‹éƒ½åœ¨ç­‰å¾…ï¼Œæ–°è¯·æ±‚æ— æ³•å¤„ç†ï¼
```

**å¼‚æ­¥å¤„ç†çš„ä¼˜åŠ¿**ï¼š
```
å¼‚æ­¥æ–¹å¼ï¼š
å®¢æˆ·ç«¯è¯·æ±‚ â†’ Tomcatçº¿ç¨‹æ¥æ”¶ â†’ æäº¤ä»»åŠ¡ç»™çº¿ç¨‹æ±  â†’ ç«‹å³é‡Šæ”¾çº¿ç¨‹
                                        â†“
                            åå°æ…¢æ…¢æ‰§è¡Œï¼Œæ‰§è¡Œå®Œé€šçŸ¥è¿”å›
                                        â†“
                            Tomcatçº¿ç¨‹é‡æ–°å¤„ç†ç»“æœ
```

### 7.2 DeferredResultå¼‚æ­¥æ–¹å¼


**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
@RestController
public class AsyncController {
    
    @GetMapping("/async/order")
    public DeferredResult<String> createOrder() {
        // åˆ›å»ºDeferredResultï¼Œè¶…æ—¶æ—¶é—´5ç§’
        DeferredResult<String> result = new DeferredResult<>(5000L);
        
        // å¼‚æ­¥å¤„ç†ä¸šåŠ¡
        CompletableFuture.runAsync(() -> {
            try {
                // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œï¼ˆè°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£ç­‰ï¼‰
                Thread.sleep(3000);
                // è®¾ç½®ç»“æœ
                result.setResult("è®¢å•åˆ›å»ºæˆåŠŸ");
            } catch (Exception e) {
                result.setErrorResult("è®¢å•åˆ›å»ºå¤±è´¥");
            }
        });
        
        // ç«‹å³è¿”å›ï¼Œä¸é˜»å¡çº¿ç¨‹
        return result;
    }
}
```

**å¤„ç†æµç¨‹**ï¼š
```
â‘  è¯·æ±‚åˆ°è¾¾ï¼Œåˆ›å»ºDeferredResult
    â†“
â‘¡ Controlleræ–¹æ³•ç«‹å³è¿”å›DeferredResult
    â†“
â‘¢ Tomcatçº¿ç¨‹é‡Šæ”¾ï¼Œå¯ä»¥å¤„ç†å…¶ä»–è¯·æ±‚
    â†“
â‘£ åå°çº¿ç¨‹æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    â†“
â‘¤ ä¸šåŠ¡å®Œæˆï¼Œè°ƒç”¨setResultè®¾ç½®ç»“æœ
    â†“
â‘¥ Spring MVCæ£€æµ‹åˆ°ç»“æœå·²è®¾ç½®
    â†“
â‘¦ ä½¿ç”¨Tomcatçº¿ç¨‹å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯
```

### 7.3 Callableå¼‚æ­¥æ–¹å¼


```java
@GetMapping("/async/query")
public Callable<List<User>> queryUsers() {
    return () -> {
        // è¿™æ®µä»£ç åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­æ‰§è¡Œ
        Thread.sleep(2000);  // æ¨¡æ‹Ÿè€—æ—¶æŸ¥è¯¢
        return userService.findAll();
    };
}
```

**Callable vs DeferredResult**ï¼š

| ç‰¹æ€§ | Callable | DeferredResult |
|-----|----------|----------------|
| **é€‚ç”¨åœºæ™¯** | Springå†…éƒ¨æ§åˆ¶çš„å¼‚æ­¥ä»»åŠ¡ | éœ€è¦åœ¨å¤–éƒ¨çº¿ç¨‹è®¾ç½®ç»“æœ |
| **çº¿ç¨‹ç®¡ç†** | Springè‡ªåŠ¨ç®¡ç† | è‡ªå·±ç®¡ç†çº¿ç¨‹ |
| **çµæ´»æ€§** | è¾ƒä½ | è¾ƒé«˜ |
| **å…¸å‹ç”¨é€”** | æ•°æ®åº“æŸ¥è¯¢ã€æ–‡ä»¶å¤„ç† | MQæ¶ˆæ¯ã€ç¬¬ä¸‰æ–¹å›è°ƒ |

---

## 8. ğŸ› ï¸ è‡ªå®šä¹‰è¿”å›å€¼å¤„ç†å™¨


### 8.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰


**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… ç»Ÿä¸€å°è£…APIå“åº”æ ¼å¼
- âœ… å¤„ç†ç‰¹æ®Šçš„ä¸šåŠ¡å¯¹è±¡
- âœ… å®ç°è‡ªå®šä¹‰çš„æ•°æ®è½¬æ¢é€»è¾‘

### 8.2 ç»Ÿä¸€å“åº”æ ¼å¼ç¤ºä¾‹


**å®šä¹‰å“åº”å¯¹è±¡**ï¼š
```java
// ç»Ÿä¸€å“åº”æ ¼å¼
public class ApiResponse<T> {
    private Integer code;    // çŠ¶æ€ç 
    private String message;  // æ¶ˆæ¯
    private T data;         // æ•°æ®
    
    public static <T> ApiResponse<T> success(T data) {
        return new ApiResponse<>(200, "æˆåŠŸ", data);
    }
    
    public static <T> ApiResponse<T> error(String message) {
        return new ApiResponse<>(500, message, null);
    }
}

// è‡ªå®šä¹‰æ³¨è§£ï¼Œæ ‡è®°éœ€è¦ç»Ÿä¸€å°è£…çš„æ–¹æ³•
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface ApiResult {
}
```

### 8.3 å®ç°è‡ªå®šä¹‰å¤„ç†å™¨


```java
public class ApiResponseReturnValueHandler implements HandlerMethodReturnValueHandler {
    
    private final HandlerMethodReturnValueHandler delegate;
    
    @Override
    public boolean supportsReturnType(MethodParameter returnType) {
        // åˆ¤æ–­æ–¹æ³•æ˜¯å¦æœ‰@ApiResultæ³¨è§£
        return returnType.hasMethodAnnotation(ApiResult.class);
    }
    
    @Override
    public void handleReturnValue(Object returnValue, 
                                   MethodParameter returnType,
                                   ModelAndViewContainer mavContainer, 
                                   NativeWebRequest webRequest) throws Exception {
        
        // å°†è¿”å›å€¼åŒ…è£…æˆApiResponse
        ApiResponse<?> response = ApiResponse.success(returnValue);
        
        // å§”æ‰˜ç»™RequestResponseBodyMethodProcessorå¤„ç†
        delegate.handleReturnValue(response, returnType, mavContainer, webRequest);
    }
}
```

### 8.4 æ³¨å†Œè‡ªå®šä¹‰å¤„ç†å™¨


```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    
    @Override
    public void addReturnValueHandlers(List<HandlerMethodReturnValueHandler> handlers) {
        // æ·»åŠ è‡ªå®šä¹‰è¿”å›å€¼å¤„ç†å™¨
        handlers.add(new ApiResponseReturnValueHandler(
            // ä¼ å…¥é»˜è®¤çš„JSONå¤„ç†å™¨
            new RequestResponseBodyMethodProcessor(...)
        ));
    }
}
```

### 8.5 ä½¿ç”¨æ•ˆæœ


```java
@RestController
public class UserController {
    
    @ApiResult  // ä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£
    @GetMapping("/api/user/{id}")
    public User getUser(@PathVariable Long id) {
        return userService.findById(id);
    }
}

// å®é™…è¿”å›ç»™å‰ç«¯çš„JSONï¼š
{
    "code": 200,
    "message": "æˆåŠŸ",
    "data": {
        "id": 1,
        "name": "å¼ ä¸‰",
        "age": 25
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


> ğŸ¯ **è¿”å›å€¼å¤„ç†å™¨ä¸‰è¦ç´ **ï¼š
> 1. **è¯†åˆ«èƒ½åŠ›**ï¼šé€šè¿‡`supportsReturnType`åˆ¤æ–­èƒ½å¦å¤„ç†
> 2. **å¤„ç†èƒ½åŠ›**ï¼šé€šè¿‡`handleReturnValue`çœŸæ­£å¤„ç†è¿”å›å€¼
> 3. **åä½œèƒ½åŠ›**ï¼šä¸HttpMessageConverterã€ViewResolverç­‰ç»„ä»¶é…åˆ

### 9.2 å¸¸è§è¿”å›å€¼ç±»å‹æ€»ç»“


| è¿”å›ç±»å‹ | å¤„ç†å™¨ | ç”¨é€” | ç¤ºä¾‹ |
|---------|-------|------|------|
| **String** | ViewNameMethodReturnValueHandler | è¿”å›è§†å›¾å | `return "user/list";` |
| **ModelAndView** | ModelAndViewMethodReturnValueHandler | è§†å›¾+æ•°æ® | `return new ModelAndView("view");` |
| **@ResponseBodyå¯¹è±¡** | RequestResponseBodyMethodProcessor | è¿”å›JSON | `return user;` |
| **void** | è‡ªå·±å¤„ç†å“åº” | æ–‡ä»¶ä¸‹è½½ | `response.getOutputStream()` |
| **DeferredResult** | DeferredResultMethodReturnValueHandler | å¼‚æ­¥å¤„ç† | `return new DeferredResult<>()` |

### 9.3 å…³é”®ç†è§£è¦ç‚¹


**è¿”å›å€¼å¤„ç†çš„æœ¬è´¨**ï¼š
```
ä¸åŒçš„è¿”å›ç±»å‹ â†’ ä¸åŒçš„å¤„ç†æ–¹å¼ â†’ ç»Ÿä¸€çš„HTTPå“åº”

å°±åƒå¤–å–æ‰“åŒ…ï¼š
- çƒ­èœ â†’ ä¿æ¸©è¢‹
- å†·é¥® â†’ å†°è¢‹
- æ±¤å“ â†’ å¯†å°ç›’
ç›®çš„éƒ½æ˜¯ï¼šå®‰å…¨é€åˆ°å®¢æˆ·æ‰‹ä¸­ï¼ˆè¿”å›ç»™æµè§ˆå™¨ï¼‰
```

**@ResponseBodyçš„æ ¸å¿ƒä½œç”¨**ï¼š
- âŒ ä¸åŠ ï¼šè¿”å›å€¼è¢«å½“ä½œè§†å›¾åå¤„ç† â†’ æ¸²æŸ“é¡µé¢
- âœ… åŠ äº†ï¼šè¿”å›å€¼ç›´æ¥å†™å…¥å“åº”ä½“ â†’ è¿”å›æ•°æ®ï¼ˆJSON/XMLç­‰ï¼‰

**å¼‚æ­¥å¤„ç†çš„ä»·å€¼**ï¼š
- â­ é‡Šæ”¾çº¿ç¨‹èµ„æºï¼Œæé«˜å¹¶å‘èƒ½åŠ›
- â­ é€‚åˆè€—æ—¶æ“ä½œï¼šè°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£ã€å¤æ‚è®¡ç®—ç­‰
- â­ æå‡ç³»ç»Ÿæ•´ä½“ååé‡

### 9.4 å®é™…åº”ç”¨å»ºè®®


**é€‰æ‹©è¿”å›å€¼ç±»å‹çš„åŸåˆ™**ï¼š
- ğŸ“„ **è¿”å›é¡µé¢**ï¼šç”¨`String`æˆ–`ModelAndView`
- ğŸ“¡ **è¿”å›æ•°æ®**ï¼šç”¨`@ResponseBody` + å¯¹è±¡
- â° **å¼‚æ­¥å¤„ç†**ï¼šç”¨`DeferredResult`æˆ–`Callable`
- ğŸ“¥ **æ–‡ä»¶ä¸‹è½½**ï¼šç”¨`void`ç›´æ¥æ“ä½œå“åº”æµ

**æœ€ä½³å®è·µ**ï¼š
```java
// âœ… æ¨èï¼šå‰åç«¯åˆ†ç¦»é¡¹ç›®ç»Ÿä¸€è¿”å›JSON
@RestController
public class ApiController {
    @GetMapping("/api/users")
    public ApiResponse<List<User>> getUsers() {
        return ApiResponse.success(userService.findAll());
    }
}

// âœ… æ¨èï¼šä¼ ç»Ÿé¡¹ç›®è¿”å›è§†å›¾
@Controller
public class PageController {
    @GetMapping("/user/list")
    public String listPage(Model model) {
        model.addAttribute("users", userService.findAll());
        return "user/list";
    }
}
```

### 9.5 å­¦ä¹ è¦ç‚¹è®°å¿†


**æ ¸å¿ƒæµç¨‹è®°å¿†**ï¼š
```
è¯·æ±‚ â†’ Controlleræ‰§è¡Œ â†’ è¿”å›ç»“æœ
         â†“
    è¿”å›å€¼å¤„ç†å™¨ç™»åœº
         â†“
â‘  åˆ¤æ–­ç±»å‹ï¼ˆsupportsï¼‰
â‘¡ å¤„ç†è½¬æ¢ï¼ˆhandleï¼‰  
â‘¢ å†™å…¥å“åº”ï¼ˆresponseï¼‰
```

**å…³é”®ç»„ä»¶å…³ç³»**ï¼š
- **è¿”å›å€¼å¤„ç†å™¨**ï¼šå†³å®šæ€ä¹ˆå¤„ç†è¿”å›å€¼
- **HttpMessageConverter**ï¼šè´Ÿè´£å¯¹è±¡å’ŒJSON/XMLè½¬æ¢
- **ViewResolver**ï¼šè´Ÿè´£è§†å›¾åç§°è§£æ
- **ä¸‰è€…é…åˆ**ï¼šå®Œæˆä»è¿”å›å€¼åˆ°HTTPå“åº”çš„è½¬æ¢