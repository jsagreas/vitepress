---
title: 6ã€HttpMessageConverteræ·±åº¦å®šåˆ¶
---
## ğŸ“š ç›®å½•

1. [æ¶ˆæ¯è½¬æ¢å™¨åŸºç¡€æ¦‚å¿µ](#1-æ¶ˆæ¯è½¬æ¢å™¨åŸºç¡€æ¦‚å¿µ)
2. [HttpMessageConverteræ¥å£è¯¦è§£](#2-HttpMessageConverteræ¥å£è¯¦è§£)
3. [è‡ªå®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨å®æˆ˜](#3-è‡ªå®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨å®æˆ˜)
4. [è½¬æ¢å™¨æ³¨å†Œä¸é…ç½®](#4-è½¬æ¢å™¨æ³¨å†Œä¸é…ç½®)
5. [åª’ä½“ç±»å‹åŒ¹é…æœºåˆ¶](#5-åª’ä½“ç±»å‹åŒ¹é…æœºåˆ¶)
6. [ç¼–ç å¤„ç†ä¸å­—ç¬¦é›†](#6-ç¼–ç å¤„ç†ä¸å­—ç¬¦é›†)
7. [è½¬æ¢å™¨ä¼˜å…ˆçº§æ§åˆ¶](#7-è½¬æ¢å™¨ä¼˜å…ˆçº§æ§åˆ¶)
8. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#8-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
9. [é”™è¯¯å¤„ç†æœºåˆ¶](#9-é”™è¯¯å¤„ç†æœºåˆ¶)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ¶ˆæ¯è½¬æ¢å™¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ¶ˆæ¯è½¬æ¢å™¨


**é€šä¿—ç†è§£**ï¼šæ¶ˆæ¯è½¬æ¢å™¨å°±åƒæ˜¯ä¸€ä¸ª"ç¿»è¯‘å®˜"ï¼Œè´Ÿè´£æŠŠJavaå¯¹è±¡å’ŒHTTPè¯·æ±‚/å“åº”ä¹‹é—´äº’ç›¸è½¬æ¢ã€‚

```
å‰ç«¯å‘é€JSON â†’ æ¶ˆæ¯è½¬æ¢å™¨ â†’ Javaå¯¹è±¡ï¼ˆControlleræ¥æ”¶ï¼‰
Javaå¯¹è±¡ â†’ æ¶ˆæ¯è½¬æ¢å™¨ â†’ JSONè¿”å›ç»™å‰ç«¯
```

**ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯è½¬æ¢å™¨ï¼Ÿ**
- å‰ç«¯å‘é€çš„æ˜¯æ–‡æœ¬æ ¼å¼ï¼ˆJSONã€XMLç­‰ï¼‰ï¼Œåç«¯éœ€è¦Javaå¯¹è±¡
- åç«¯è¿”å›çš„æ˜¯Javaå¯¹è±¡ï¼Œå‰ç«¯éœ€è¦æ–‡æœ¬æ ¼å¼
- ä¸åŒçš„æ•°æ®æ ¼å¼éœ€è¦ä¸åŒçš„è½¬æ¢æ–¹å¼

### 1.2 æ¶ˆæ¯è½¬æ¢å™¨çš„å·¥ä½œåœºæ™¯


```
åœºæ™¯ç¤ºæ„å›¾ï¼š

å®¢æˆ·ç«¯                        Spring MVC                      æœåŠ¡ç«¯
  |                              |                              |
  |--[1] POST JSONæ•°æ®---------->|                              |
  |   {"name":"å¼ ä¸‰"}            |                              |
  |                              |--[2] æ¶ˆæ¯è½¬æ¢å™¨----------->|
  |                              |    JSON â†’ Userå¯¹è±¡          |
  |                              |                              |
  |                              |<--[3] ä¸šåŠ¡å¤„ç†è¿”å›å¯¹è±¡------|
  |                              |    Userå¯¹è±¡                 |
  |                              |--[4] æ¶ˆæ¯è½¬æ¢å™¨----------->|
  |                              |    Userå¯¹è±¡ â†’ JSON          |
  |<--[5] è¿”å›JSONæ•°æ®-----------|                              |
  |   {"id":1,"name":"å¼ ä¸‰"}     |                              |
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- **è¯·æ±‚è½¬æ¢**ï¼šHTTPè¯·æ±‚ä½“ â†’ Javaå¯¹è±¡ï¼ˆååºåˆ—åŒ–ï¼‰
- **å“åº”è½¬æ¢**ï¼šJavaå¯¹è±¡ â†’ HTTPå“åº”ä½“ï¼ˆåºåˆ—åŒ–ï¼‰
- **æ ¼å¼é€‚é…**ï¼šæ”¯æŒJSONã€XMLã€è¡¨å•ç­‰å¤šç§æ ¼å¼

### 1.3 Spring MVCå†…ç½®çš„è½¬æ¢å™¨


| è½¬æ¢å™¨ç±»å‹ | **æ”¯æŒçš„æ ¼å¼** | **é€‚ç”¨åœºæ™¯** |
|-----------|--------------|-------------|
| `MappingJackson2HttpMessageConverter` | `JSONæ ¼å¼` | `å¤„ç†JSONæ•°æ®ï¼Œæœ€å¸¸ç”¨` |
| `StringHttpMessageConverter` | `çº¯æ–‡æœ¬` | `å¤„ç†å­—ç¬¦ä¸²æ•°æ®` |
| `FormHttpMessageConverter` | `è¡¨å•æ•°æ®` | `å¤„ç†è¡¨å•æäº¤` |
| `MappingJackson2XmlHttpMessageConverter` | `XMLæ ¼å¼` | `å¤„ç†XMLæ•°æ®` |
| `ByteArrayHttpMessageConverter` | `å­—èŠ‚æ•°ç»„` | `å¤„ç†æ–‡ä»¶ä¸Šä¼ ä¸‹è½½` |

---

## 2. ğŸ”§ HttpMessageConverteræ¥å£è¯¦è§£


### 2.1 æ ¸å¿ƒæ¥å£æ–¹æ³•


**HttpMessageConverteræ¥å£å®šä¹‰**ï¼š

```java
public interface HttpMessageConverter<T> {
    
    // 1ï¸âƒ£ åˆ¤æ–­æ˜¯å¦èƒ½è¯»å–ï¼ˆè¯·æ±‚è½¬å¯¹è±¡ï¼‰
    boolean canRead(Class<?> clazz, MediaType mediaType);
    
    // 2ï¸âƒ£ åˆ¤æ–­æ˜¯å¦èƒ½å†™å…¥ï¼ˆå¯¹è±¡è½¬å“åº”ï¼‰
    boolean canWrite(Class<?> clazz, MediaType mediaType);
    
    // 3ï¸âƒ£ æ”¯æŒçš„åª’ä½“ç±»å‹åˆ—è¡¨
    List<MediaType> getSupportedMediaTypes();
    
    // 4ï¸âƒ£ è¯»å–è¯·æ±‚æ•°æ®ï¼ˆååºåˆ—åŒ–ï¼‰
    T read(Class<? extends T> clazz, HttpInputMessage inputMessage);
    
    // 5ï¸âƒ£ å†™å…¥å“åº”æ•°æ®ï¼ˆåºåˆ—åŒ–ï¼‰
    void write(T t, MediaType contentType, HttpOutputMessage outputMessage);
}
```

### 2.2 æ–¹æ³•è¯¦ç»†è¯´æ˜


**canReadæ–¹æ³• - åˆ¤æ–­èƒ½å¦è¯»å–**

```java
// å‚æ•°è¯´æ˜ï¼š
// clazz - ç›®æ ‡Javaç±»å‹ï¼Œå¦‚ User.class
// mediaType - è¯·æ±‚çš„Content-Typeï¼Œå¦‚ application/json

boolean canRead(Class<?> clazz, MediaType mediaType);

// å®é™…åˆ¤æ–­é€»è¾‘ç¤ºä¾‹ï¼š
if (mediaType.includes(MediaType.APPLICATION_JSON) && 
    supportedClass.isAssignableFrom(clazz)) {
    return true;  // å¯ä»¥å¤„ç†
}
```

> ğŸ’¡ **ç†è§£è¦ç‚¹**ï¼šè¿™ä¸ªæ–¹æ³•å†³å®šäº†"è¿™ä¸ªè½¬æ¢å™¨èƒ½ä¸èƒ½å¤„ç†è¿™ä¸ªè¯·æ±‚"

**readæ–¹æ³• - è¯»å–å¹¶è½¬æ¢æ•°æ®**

```java
// å°†HTTPè¯·æ±‚ä½“è½¬æ¢ä¸ºJavaå¯¹è±¡
T read(Class<? extends T> clazz, HttpInputMessage inputMessage);

// å†…éƒ¨å·¥ä½œæµç¨‹ï¼š
// 1. ä»inputMessageè·å–è¯·æ±‚ä½“çš„è¾“å…¥æµ
// 2. è¯»å–å­—èŠ‚æ•°æ®
// 3. æ ¹æ®æ ¼å¼ï¼ˆJSON/XMLç­‰ï¼‰è§£æ
// 4. åˆ›å»ºå¹¶å¡«å……Javaå¯¹è±¡
// 5. è¿”å›è½¬æ¢åçš„å¯¹è±¡
```

**writeæ–¹æ³• - å†™å…¥å“åº”æ•°æ®**

```java
// å°†Javaå¯¹è±¡è½¬æ¢ä¸ºHTTPå“åº”ä½“
void write(T t, MediaType contentType, HttpOutputMessage outputMessage);

// å†…éƒ¨å·¥ä½œæµç¨‹ï¼š
// 1. å°†Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°æ®
// 2. è®¾ç½®Content-Typeå“åº”å¤´
// 3. å†™å…¥åˆ°outputMessageçš„è¾“å‡ºæµ
// 4. å‘é€ç»™å®¢æˆ·ç«¯
```

### 2.3 è½¬æ¢å™¨å·¥ä½œæµç¨‹å›¾


```
è¯·æ±‚å¤„ç†æµç¨‹ï¼ˆcanRead + readï¼‰ï¼š

HTTPè¯·æ±‚
   â†“
[Content-Type: application/json]
   â†“
éå†æ‰€æœ‰è½¬æ¢å™¨
   â†“
è°ƒç”¨ canRead(User.class, application/json)
   â†“
æ‰¾åˆ°åŒ¹é…çš„è½¬æ¢å™¨ï¼ˆå¦‚Jacksonè½¬æ¢å™¨ï¼‰
   â†“
è°ƒç”¨ read() æ–¹æ³•
   â†“
{"name":"å¼ ä¸‰"} â†’ Userå¯¹è±¡
   â†“
ä¼ é€’ç»™Controlleræ–¹æ³•

---

å“åº”å¤„ç†æµç¨‹ï¼ˆcanWrite + writeï¼‰ï¼š

Controllerè¿”å›å¯¹è±¡
   â†“
Userå¯¹è±¡
   â†“
éå†æ‰€æœ‰è½¬æ¢å™¨
   â†“
è°ƒç”¨ canWrite(User.class, application/json)
   â†“
æ‰¾åˆ°åŒ¹é…çš„è½¬æ¢å™¨
   â†“
è°ƒç”¨ write() æ–¹æ³•
   â†“
Userå¯¹è±¡ â†’ {"id":1,"name":"å¼ ä¸‰"}
   â†“
è®¾ç½®å“åº”å¤´å¹¶è¿”å›
```

---

## 3. ğŸ› ï¸ è‡ªå®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨å®æˆ˜


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰è½¬æ¢å™¨


**å¸¸è§åœºæ™¯**ï¼š
- **ç‰¹æ®Šæ ¼å¼å¤„ç†**ï¼šå…¬å¸å†…éƒ¨è‡ªå®šä¹‰çš„æ•°æ®æ ¼å¼
- **åŠ å¯†è§£å¯†**ï¼šæ•æ„Ÿæ•°æ®éœ€è¦åŠ å¯†ä¼ è¾“
- **æ•°æ®è„±æ•**ï¼šè¿”å›æ•°æ®æ—¶éšè—æ•æ„Ÿä¿¡æ¯
- **æ ¼å¼å…¼å®¹**ï¼šå¤„ç†è€ç³»ç»Ÿçš„ç‰¹æ®Šæ ¼å¼

### 3.2 å®æˆ˜æ¡ˆä¾‹ï¼šè‡ªå®šä¹‰CSVè½¬æ¢å™¨


> ğŸ“Œ **åœºæ™¯**ï¼šéœ€è¦æ”¯æŒCSVæ ¼å¼çš„æ•°æ®å¯¼å…¥å¯¼å‡º

**æ­¥éª¤1ï¸âƒ£ï¼šå®šä¹‰æ•°æ®æ¨¡å‹**

```java
public class User {
    private Long id;
    private String name;
    private String email;
    
    // getter/setterçœç•¥
}
```

**æ­¥éª¤2ï¸âƒ£ï¼šå®ç°è‡ªå®šä¹‰è½¬æ¢å™¨**

```java
public class CsvHttpMessageConverter implements HttpMessageConverter<List<User>> {
    
    // æ”¯æŒçš„åª’ä½“ç±»å‹
    private static final MediaType CSV_MEDIA_TYPE = 
        MediaType.parseMediaType("text/csv");
    
    @Override
    public boolean canRead(Class<?> clazz, MediaType mediaType) {
        // åˆ¤æ–­æ˜¯å¦æ˜¯List<User>ä¸”Content-Typeæ˜¯text/csv
        return List.class.isAssignableFrom(clazz) && 
               mediaType != null && 
               mediaType.includes(CSV_MEDIA_TYPE);
    }
    
    @Override
    public boolean canWrite(Class<?> clazz, MediaType mediaType) {
        return List.class.isAssignableFrom(clazz) && 
               (mediaType == null || mediaType.includes(CSV_MEDIA_TYPE));
    }
    
    @Override
    public List<MediaType> getSupportedMediaTypes() {
        return Collections.singletonList(CSV_MEDIA_TYPE);
    }
    
    @Override
    public List<User> read(Class<? extends List<User>> clazz, 
                           HttpInputMessage inputMessage) throws IOException {
        // è¯»å–CSVæ•°æ®å¹¶è½¬æ¢ä¸ºList<User>
        List<User> users = new ArrayList<>();
        BufferedReader reader = new BufferedReader(
            new InputStreamReader(inputMessage.getBody(), StandardCharsets.UTF_8));
        
        String line;
        reader.readLine(); // è·³è¿‡è¡¨å¤´
        while ((line = reader.readLine()) != null) {
            String[] parts = line.split(",");
            User user = new User();
            user.setId(Long.parseLong(parts[0]));
            user.setName(parts[1]);
            user.setEmail(parts[2]);
            users.add(user);
        }
        return users;
    }
    
    @Override
    public void write(List<User> users, MediaType contentType, 
                      HttpOutputMessage outputMessage) throws IOException {
        // å°†List<User>è½¬æ¢ä¸ºCSVæ ¼å¼
        outputMessage.getHeaders().setContentType(CSV_MEDIA_TYPE);
        
        PrintWriter writer = new PrintWriter(
            new OutputStreamWriter(outputMessage.getBody(), StandardCharsets.UTF_8));
        
        // å†™å…¥è¡¨å¤´
        writer.println("id,name,email");
        
        // å†™å…¥æ•°æ®
        for (User user : users) {
            writer.printf("%d,%s,%s%n", 
                user.getId(), user.getName(), user.getEmail());
        }
        writer.flush();
    }
}
```

> ğŸ’¡ **æ ¸å¿ƒæ€è·¯**ï¼š
> - `canRead/canWrite`ï¼šåˆ¤æ–­èƒ½å¦å¤„ç†
> - `read`ï¼šè§£æè¾“å…¥æµ â†’ Javaå¯¹è±¡
> - `write`ï¼šJavaå¯¹è±¡ â†’ è¾“å‡ºæµ

### 3.3 å®æˆ˜æ¡ˆä¾‹ï¼šåŠ å¯†è½¬æ¢å™¨


> ğŸ“Œ **åœºæ™¯**ï¼šæ•æ„Ÿæ•°æ®åŠ å¯†ä¼ è¾“

```java
public class EncryptedMessageConverter 
    extends MappingJackson2HttpMessageConverter {
    
    private final AESEncryptor encryptor = new AESEncryptor();
    
    @Override
    protected void writeInternal(Object object, HttpOutputMessage outputMessage) 
        throws IOException {
        // 1. å…ˆåºåˆ—åŒ–ä¸ºJSON
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        super.writeInternal(object, new HttpOutputMessageWrapper(outputMessage, baos));
        
        // 2. åŠ å¯†JSONæ•°æ®
        byte[] jsonBytes = baos.toByteArray();
        byte[] encryptedBytes = encryptor.encrypt(jsonBytes);
        
        // 3. å†™å…¥åŠ å¯†åçš„æ•°æ®
        outputMessage.getBody().write(encryptedBytes);
    }
    
    @Override
    public Object read(Type type, Class<?> contextClass, HttpInputMessage inputMessage) 
        throws IOException {
        // 1. è¯»å–åŠ å¯†æ•°æ®
        byte[] encryptedBytes = StreamUtils.copyToByteArray(inputMessage.getBody());
        
        // 2. è§£å¯†
        byte[] decryptedBytes = encryptor.decrypt(encryptedBytes);
        
        // 3. ååºåˆ—åŒ–ä¸ºå¯¹è±¡
        return super.read(type, contextClass, 
            new HttpInputMessageWrapper(inputMessage, decryptedBytes));
    }
}
```

---

## 4. âš™ï¸ è½¬æ¢å™¨æ³¨å†Œä¸é…ç½®


### 4.1 é…ç½®æ–¹å¼å¯¹æ¯”


| é…ç½®æ–¹å¼ | **ä½¿ç”¨åœºæ™¯** | **ä¼˜å…ˆçº§** |
|---------|------------|-----------|
| `extendMessageConverters` | `è°ƒæ•´ç°æœ‰è½¬æ¢å™¨é¡ºåº` | `ä¿ç•™é»˜è®¤+è‡ªå®šä¹‰` |
| `configureMessageConverters` | `å®Œå…¨è‡ªå®šä¹‰è½¬æ¢å™¨åˆ—è¡¨` | `è¦†ç›–é»˜è®¤é…ç½®` |
| `@Beanæ³¨å†Œ` | `ç®€å•åœºæ™¯å•ä¸ªè½¬æ¢å™¨` | `è¿½åŠ åˆ°é»˜è®¤åˆ—è¡¨` |

### 4.2 æ–¹æ³•1ï¼šextendMessageConvertersï¼ˆæ¨èï¼‰


```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void extendMessageConverters(List<HttpMessageConverter<?>> converters) {
        // æ·»åŠ è‡ªå®šä¹‰CSVè½¬æ¢å™¨åˆ°åˆ—è¡¨å¼€å¤´ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
        converters.add(0, new CsvHttpMessageConverter());
        
        // æˆ–æ·»åŠ åˆ°æœ«å°¾ï¼ˆä¼˜å…ˆçº§æœ€ä½ï¼‰
        converters.add(new CustomMessageConverter());
    }
}
```

> ğŸ’¡ **ç‰¹ç‚¹**ï¼šä¿ç•™Springé»˜è®¤çš„è½¬æ¢å™¨ï¼Œåªæ˜¯æ·»åŠ æˆ–è°ƒæ•´é¡ºåº

### 4.3 æ–¹æ³•2ï¼šconfigureMessageConverters


```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void configureMessageConverters(List<HttpMessageConverter<?>> converters) {
        // âš ï¸ è¿™é‡Œä¼šè¦†ç›–é»˜è®¤é…ç½®ï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ æ‰€æœ‰éœ€è¦çš„è½¬æ¢å™¨
        
        // æ·»åŠ JSONè½¬æ¢å™¨
        converters.add(new MappingJackson2HttpMessageConverter());
        
        // æ·»åŠ è‡ªå®šä¹‰è½¬æ¢å™¨
        converters.add(new CsvHttpMessageConverter());
        
        // æ·»åŠ å­—ç¬¦ä¸²è½¬æ¢å™¨
        StringHttpMessageConverter stringConverter = 
            new StringHttpMessageConverter(StandardCharsets.UTF_8);
        converters.add(stringConverter);
    }
}
```

> âš ï¸ **æ³¨æ„**ï¼šæ­¤æ–¹æ³•ä¼šæ¸…ç©ºé»˜è®¤è½¬æ¢å™¨ï¼Œéœ€è¦è‡ªå·±æ·»åŠ æ‰€æœ‰éœ€è¦çš„è½¬æ¢å™¨

### 4.4 æ–¹æ³•3ï¼š@Beanæ³¨å†Œï¼ˆç®€å•åœºæ™¯ï¼‰


```java
@Configuration
public class WebConfig {
    
    @Bean
    public HttpMessageConverter<List<User>> csvConverter() {
        return new CsvHttpMessageConverter();
    }
}
```

### 4.5 é…ç½®é€‰æ‹©å»ºè®®


```
é€‰æ‹©æ ‡å‡†ï¼š

âœ… å¤§å¤šæ•°æƒ…å†µ â†’ extendMessageConverters
   ä¿ç•™é»˜è®¤åŠŸèƒ½ï¼Œåªæ·»åŠ è‡ªå®šä¹‰è½¬æ¢å™¨

âš ï¸ ç‰¹æ®Šéœ€æ±‚ â†’ configureMessageConverters  
   å®Œå…¨æ§åˆ¶è½¬æ¢å™¨åˆ—è¡¨ï¼Œä½†è¦è´Ÿè´£æ·»åŠ æ‰€æœ‰è½¬æ¢å™¨

ğŸ”¹ ç®€å•åœºæ™¯ â†’ @Beanæ³¨å†Œ
   åªéœ€æ·»åŠ ä¸€ä¸ªè½¬æ¢å™¨ä¸”ä¸å…³å¿ƒé¡ºåº
```

---

## 5. ğŸ¯ åª’ä½“ç±»å‹åŒ¹é…æœºåˆ¶


### 5.1 ä»€ä¹ˆæ˜¯åª’ä½“ç±»å‹ï¼ˆMedia Typeï¼‰


**é€šä¿—ç†è§£**ï¼šåª’ä½“ç±»å‹å°±æ˜¯å‘Šè¯‰æœåŠ¡å™¨"æˆ‘å‘é€/éœ€è¦ä»€ä¹ˆæ ¼å¼çš„æ•°æ®"

```
å¸¸è§åª’ä½“ç±»å‹ï¼š
application/json       â†’ JSONæ ¼å¼
application/xml        â†’ XMLæ ¼å¼
text/html              â†’ HTMLé¡µé¢
text/csv               â†’ CSVæ ¼å¼
multipart/form-data    â†’ æ–‡ä»¶ä¸Šä¼ 
application/x-www-form-urlencoded â†’ è¡¨å•æäº¤
```

### 5.2 åª’ä½“ç±»å‹åŒ¹é…æµç¨‹


```
è¯·æ±‚åŒ¹é…æµç¨‹ï¼š

HTTPè¯·æ±‚
  â†“
[Content-Type: application/json]
  â†“
éå†è½¬æ¢å™¨åˆ—è¡¨
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è½¬æ¢å™¨1: canRead(User.class,   â”‚
â”‚          application/json)      â”‚
â”‚ ç»“æœ: falseï¼ˆä¸æ”¯æŒï¼‰            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è½¬æ¢å™¨2: canRead(User.class,   â”‚
â”‚          application/json)      â”‚
â”‚ ç»“æœ: trueï¼ˆæ”¯æŒï¼‰âœ“              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
ä½¿ç”¨è½¬æ¢å™¨2å¤„ç†è¯·æ±‚
```

### 5.3 åª’ä½“ç±»å‹åŒ¹é…è§„åˆ™


**ç²¾ç¡®åŒ¹é…**ï¼š

```java
// è¯·æ±‚çš„Content-Typeå¿…é¡»å®Œå…¨åŒ¹é…
MediaType requestType = MediaType.parseMediaType("application/json");
MediaType supportedType = MediaType.APPLICATION_JSON;

if (requestType.equals(supportedType)) {
    // å®Œå…¨åŒ¹é…
}
```

**åŒ…å«åŒ¹é…**ï¼š

```java
// æ”¯æŒé€šé…ç¬¦åŒ¹é…
MediaType requestType = MediaType.parseMediaType("application/json;charset=UTF-8");
MediaType supportedType = MediaType.APPLICATION_JSON; // application/json

if (supportedType.includes(requestType)) {
    // åŒ…å«åŒ¹é…ï¼ˆå¿½ç•¥charsetå‚æ•°ï¼‰
}
```

**é€šé…ç¬¦åŒ¹é…**ï¼š

```java
// ä½¿ç”¨ */* æˆ– text/* ç­‰é€šé…ç¬¦
MediaType allTypes = MediaType.ALL; // */*
MediaType textTypes = MediaType.parseMediaType("text/*");

// application/json åŒ¹é… */*
// text/html åŒ¹é… text/*
```

### 5.4 å†…å®¹åå•†ï¼ˆContent Negotiationï¼‰


**ä»€ä¹ˆæ˜¯å†…å®¹åå•†**ï¼šå®¢æˆ·ç«¯å‘Šè¯‰æœåŠ¡å™¨"æˆ‘å¸Œæœ›æ¥æ”¶ä»€ä¹ˆæ ¼å¼çš„æ•°æ®"

```
è¯·æ±‚ç¤ºä¾‹ï¼š

GET /api/users/1
Accept: application/json        â† å®¢æˆ·ç«¯æœŸæœ›JSONæ ¼å¼
Accept: application/xml         â† æˆ–XMLæ ¼å¼
Accept: */*                     â† æˆ–ä»»æ„æ ¼å¼
```

**å†…å®¹åå•†æµç¨‹**ï¼š

```
å®¢æˆ·ç«¯è¯·æ±‚
  â†“
[Accept: application/json, application/xml]
  â†“
Controllerè¿”å›Userå¯¹è±¡
  â†“
éå†è½¬æ¢å™¨
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Jacksonè½¬æ¢å™¨:                  â”‚
â”‚ canWrite(User.class, JSON) â†’ âœ“ â”‚
â”‚ ä¼˜å…ˆçº§: é«˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
ä½¿ç”¨JSONæ ¼å¼è¿”å›

---

å¦‚æœAcceptåªæœ‰ application/xmlï¼š
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ XMLè½¬æ¢å™¨:                      â”‚
â”‚ canWrite(User.class, XML) â†’ âœ“  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
ä½¿ç”¨XMLæ ¼å¼è¿”å›
```

### 5.5 è‡ªå®šä¹‰åª’ä½“ç±»å‹ç¤ºä¾‹


```java
public class CustomProtocolConverter 
    extends AbstractHttpMessageConverter<CustomData> {
    
    // å®šä¹‰è‡ªå®šä¹‰åª’ä½“ç±»å‹
    private static final MediaType CUSTOM_PROTOCOL = 
        MediaType.parseMediaType("application/x-custom-protocol");
    
    public CustomProtocolConverter() {
        // å£°æ˜æ”¯æŒçš„åª’ä½“ç±»å‹
        super(CUSTOM_PROTOCOL);
    }
    
    @Override
    protected boolean supports(Class<?> clazz) {
        return CustomData.class.isAssignableFrom(clazz);
    }
    
    @Override
    protected CustomData readInternal(Class<? extends CustomData> clazz, 
                                      HttpInputMessage inputMessage) {
        // æŒ‰è‡ªå®šä¹‰åè®®è§£æ
        // ...
    }
    
    @Override
    protected void writeInternal(CustomData data, 
                                 HttpOutputMessage outputMessage) {
        // æŒ‰è‡ªå®šä¹‰åè®®è¾“å‡º
        outputMessage.getHeaders().setContentType(CUSTOM_PROTOCOL);
        // ...
    }
}
```

---

## 6. ğŸ“ ç¼–ç å¤„ç†ä¸å­—ç¬¦é›†


### 6.1 ä¸ºä»€ä¹ˆè¦å…³æ³¨ç¼–ç 


**å¸¸è§é—®é¢˜**ï¼š
- ä¸­æ–‡ä¹±ç ï¼š`å¼ ä¸‰` å˜æˆ `Ã¥Â¼ Ã¤Â¸â€°`
- å“åº”å¤´é”™è¯¯ï¼š`Content-Type`ç¼ºå°‘`charset`å‚æ•°
- æ•°æ®æˆªæ–­ï¼šç‰¹æ®Šå­—ç¬¦å¯¼è‡´æ•°æ®ä¸¢å¤±

### 6.2 å­—ç¬¦ç¼–ç åŸºç¡€


```
ç¼–ç è½¬æ¢ç¤ºæ„ï¼š

Javaå­—ç¬¦ä¸²ï¼ˆUnicodeï¼‰
    â†“ [ç¼–ç ]
å­—èŠ‚æ•°ç»„ï¼ˆUTF-8/GBKç­‰ï¼‰
    â†“ [ç½‘ç»œä¼ è¾“]
å­—èŠ‚æ•°ç»„
    â†“ [è§£ç ]
Javaå­—ç¬¦ä¸²
```

**å¸¸è§ç¼–ç æ ¼å¼**ï¼š
- **UTF-8**ï¼šä¸‡å›½ç ï¼Œæ”¯æŒæ‰€æœ‰è¯­è¨€ï¼Œæ¨èä½¿ç”¨
- **GBK**ï¼šä¸­æ–‡ç¼–ç ï¼Œä»…æ”¯æŒä¸­æ–‡
- **ISO-8859-1**ï¼šè¥¿æ–‡ç¼–ç ï¼Œä¸æ”¯æŒä¸­æ–‡

### 6.3 è®¾ç½®é»˜è®¤å­—ç¬¦ç¼–ç 


**æ–¹æ³•1ï¼šé…ç½®StringHttpMessageConverter**

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void extendMessageConverters(List<HttpMessageConverter<?>> converters) {
        // ç§»é™¤é»˜è®¤çš„Stringè½¬æ¢å™¨
        converters.removeIf(converter -> 
            converter instanceof StringHttpMessageConverter);
        
        // æ·»åŠ UTF-8çš„Stringè½¬æ¢å™¨
        StringHttpMessageConverter stringConverter = 
            new StringHttpMessageConverter(StandardCharsets.UTF_8);
        converters.add(0, stringConverter);
    }
}
```

**æ–¹æ³•2ï¼šapplication.propertiesé…ç½®**

```properties
# Spring Booté…ç½®
spring.http.encoding.charset=UTF-8
spring.http.encoding.enabled=true
spring.http.encoding.force=true
```

### 6.4 å¤„ç†JSONç¼–ç é—®é¢˜


```java
@Configuration
public class WebConfig {
    
    @Bean
    public MappingJackson2HttpMessageConverter jsonConverter() {
        MappingJackson2HttpMessageConverter converter = 
            new MappingJackson2HttpMessageConverter();
        
        ObjectMapper mapper = new ObjectMapper();
        
        // è®¾ç½®æ—¥æœŸæ ¼å¼
        mapper.setDateFormat(new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"));
        
        // è®¾ç½®æ—¶åŒº
        mapper.setTimeZone(TimeZone.getTimeZone("GMT+8"));
        
        // å¿½ç•¥æœªçŸ¥å±æ€§
        mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        
        converter.setObjectMapper(mapper);
        
        // è®¾ç½®æ”¯æŒçš„åª’ä½“ç±»å‹å’Œå­—ç¬¦é›†
        List<MediaType> mediaTypes = Arrays.asList(
            new MediaType("application", "json", StandardCharsets.UTF_8),
            new MediaType("text", "json", StandardCharsets.UTF_8)
        );
        converter.setSupportedMediaTypes(mediaTypes);
        
        return converter;
    }
}
```

### 6.5 è‡ªå®šä¹‰è½¬æ¢å™¨ä¸­çš„ç¼–ç å¤„ç†


```java
public class CustomConverter implements HttpMessageConverter<MyData> {
    
    private Charset charset = StandardCharsets.UTF_8;
    
    @Override
    public void write(MyData data, MediaType contentType, 
                      HttpOutputMessage outputMessage) throws IOException {
        
        // è®¾ç½®å“åº”å¤´å­—ç¬¦é›†
        MediaType mediaType = new MediaType(
            contentType.getType(), 
            contentType.getSubtype(), 
            charset
        );
        outputMessage.getHeaders().setContentType(mediaType);
        
        // ä½¿ç”¨æŒ‡å®šå­—ç¬¦é›†å†™å…¥æ•°æ®
        String jsonStr = toJson(data);
        byte[] bytes = jsonStr.getBytes(charset);
        outputMessage.getBody().write(bytes);
    }
    
    @Override
    public MyData read(Class<? extends MyData> clazz, 
                       HttpInputMessage inputMessage) throws IOException {
        
        // ä»è¯·æ±‚å¤´è·å–å­—ç¬¦é›†ï¼Œé»˜è®¤UTF-8
        Charset requestCharset = Optional.ofNullable(
            inputMessage.getHeaders().getContentType())
            .map(MediaType::getCharset)
            .orElse(StandardCharsets.UTF_8);
        
        // ä½¿ç”¨å¯¹åº”å­—ç¬¦é›†è¯»å–æ•°æ®
        String body = StreamUtils.copyToString(
            inputMessage.getBody(), requestCharset);
        
        return fromJson(body, clazz);
    }
}
```

---

## 7. ğŸšï¸ è½¬æ¢å™¨ä¼˜å…ˆçº§æ§åˆ¶


### 7.1 ä¼˜å…ˆçº§è§„åˆ™


**è½¬æ¢å™¨åŒ¹é…é¡ºåº**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æŒ‰åˆ—è¡¨é¡ºåºä¾æ¬¡åŒ¹é…         â”‚
â”‚ 2. ç¬¬ä¸€ä¸ªcanRead/canWrite     â”‚
â”‚    è¿”å›trueçš„è½¬æ¢å™¨è¢«é€‰ä¸­      â”‚
â”‚ 3. åé¢çš„è½¬æ¢å™¨è¢«å¿½ç•¥         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜å…ˆçº§ç¤ºæ„**ï¼š

```
è½¬æ¢å™¨åˆ—è¡¨ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š

ä½ç½®0: [è‡ªå®šä¹‰CSVè½¬æ¢å™¨]       â† æœ€ä¼˜å…ˆ
  â†“
ä½ç½®1: [Jackson JSONè½¬æ¢å™¨]
  â†“
ä½ç½®2: [XMLè½¬æ¢å™¨]
  â†“
ä½ç½®3: [Stringè½¬æ¢å™¨]           â† æœ€å
```

### 7.2 æ§åˆ¶ä¼˜å…ˆçº§çš„æ–¹æ³•


**æ–¹æ³•1ï¼šæ’å…¥åˆ°åˆ—è¡¨å¼€å¤´**

```java
@Override
public void extendMessageConverters(List<HttpMessageConverter<?>> converters) {
    // æ·»åŠ åˆ°å¼€å¤´ï¼Œä¼˜å…ˆçº§æœ€é«˜
    converters.add(0, new HighPriorityConverter());
}
```

**æ–¹æ³•2ï¼šæŸ¥æ‰¾å¹¶æ›¿æ¢**

```java
@Override
public void extendMessageConverters(List<HttpMessageConverter<?>> converters) {
    // æ‰¾åˆ°Jacksonè½¬æ¢å™¨çš„ä½ç½®
    int jacksonIndex = -1;
    for (int i = 0; i < converters.size(); i++) {
        if (converters.get(i) instanceof MappingJackson2HttpMessageConverter) {
            jacksonIndex = i;
            break;
        }
    }
    
    // åœ¨Jacksonè½¬æ¢å™¨ä¹‹å‰æ’å…¥è‡ªå®šä¹‰è½¬æ¢å™¨
    if (jacksonIndex >= 0) {
        converters.add(jacksonIndex, new CustomConverter());
    }
}
```

**æ–¹æ³•3ï¼šå®Œå…¨æ§åˆ¶é¡ºåº**

```java
@Override
public void configureMessageConverters(List<HttpMessageConverter<?>> converters) {
    // æŒ‰ä¼˜å…ˆçº§é¡ºåºæ·»åŠ 
    converters.add(new CustomConverter1());      // ç¬¬1ä¼˜å…ˆçº§
    converters.add(new CustomConverter2());      // ç¬¬2ä¼˜å…ˆçº§
    converters.add(new MappingJackson2HttpMessageConverter()); // ç¬¬3ä¼˜å…ˆçº§
    converters.add(new StringHttpMessageConverter());          // ç¬¬4ä¼˜å…ˆçº§
}
```

### 7.3 ä¼˜å…ˆçº§å†²çªè§£å†³


**åœºæ™¯**ï¼šå¤šä¸ªè½¬æ¢å™¨éƒ½æ”¯æŒåŒä¸€ç§ç±»å‹

```java
// è½¬æ¢å™¨Aï¼šæ”¯æŒæ‰€æœ‰Object
class GenericConverter implements HttpMessageConverter<Object> {
    @Override
    public boolean canWrite(Class<?> clazz, MediaType mediaType) {
        return true; // æ¥å—æ‰€æœ‰ç±»å‹
    }
}

// è½¬æ¢å™¨Bï¼šä¸“é—¨å¤„ç†User
class UserConverter implements HttpMessageConverter<User> {
    @Override
    public boolean canWrite(Class<?> clazz, MediaType mediaType) {
        return User.class.isAssignableFrom(clazz);
    }
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼šä¸“ç”¨è½¬æ¢å™¨æ”¾å‰é¢

```java
@Override
public void extendMessageConverters(List<HttpMessageConverter<?>> converters) {
    // ä¸“ç”¨çš„UserConverteræ”¾åœ¨å‰é¢
    converters.add(0, new UserConverter());
    
    // é€šç”¨çš„GenericConverteræ”¾åœ¨åé¢
    converters.add(new GenericConverter());
}
```

---

## 8. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 8.1 æ€§èƒ½ç“¶é¢ˆåˆ†æ


```
æ€§èƒ½çƒ­ç‚¹ï¼š

åºåˆ—åŒ–/ååºåˆ—åŒ– â”€â”€â”€â”
                  â”œâ”€â†’ CPUå¯†é›†å‹æ“ä½œ
å¯¹è±¡åˆ›å»ºä¸é”€æ¯ â”€â”€â”€â”€â”˜

IOæ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ IOå¯†é›†å‹æ“ä½œ

å†…å­˜åˆ†é… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å†…å­˜å‹åŠ›
```

### 8.2 ä¼˜åŒ–ç­–ç•¥1ï¼šå¯¹è±¡é‡ç”¨


**é—®é¢˜**ï¼šé¢‘ç¹åˆ›å»ºObjectMapperæ¶ˆè€—èµ„æº

```java
// âŒ ä¸å¥½çš„åšæ³•ï¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°å¯¹è±¡
@Override
public void write(User user, MediaType contentType, 
                  HttpOutputMessage outputMessage) throws IOException {
    ObjectMapper mapper = new ObjectMapper(); // æ¯æ¬¡åˆ›å»º
    mapper.writeValue(outputMessage.getBody(), user);
}

// âœ… å¥½çš„åšæ³•ï¼šé‡ç”¨å¯¹è±¡
public class OptimizedConverter extends MappingJackson2HttpMessageConverter {
    
    private static final ObjectMapper SHARED_MAPPER = new ObjectMapper();
    
    static {
        // ä¸€æ¬¡æ€§é…ç½®
        SHARED_MAPPER.setDateFormat(new SimpleDateFormat("yyyy-MM-dd"));
    }
    
    @Override
    protected void writeInternal(Object object, HttpOutputMessage outputMessage) 
        throws IOException {
        SHARED_MAPPER.writeValue(outputMessage.getBody(), object);
    }
}
```

### 8.3 ä¼˜åŒ–ç­–ç•¥2ï¼šç¼“å­˜åºåˆ—åŒ–ç»“æœ


```java
public class CachedConverter implements HttpMessageConverter<CachedData> {
    
    private final Map<Object, byte[]> cache = new ConcurrentHashMap<>();
    
    @Override
    public void write(CachedData data, MediaType contentType, 
                      HttpOutputMessage outputMessage) throws IOException {
        
        // æ£€æŸ¥ç¼“å­˜
        byte[] cached = cache.get(data.getCacheKey());
        
        if (cached == null) {
            // åºåˆ—åŒ–å¹¶ç¼“å­˜
            cached = serialize(data);
            cache.put(data.getCacheKey(), cached);
        }
        
        // ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ç»“æœ
        outputMessage.getBody().write(cached);
    }
}
```

> âš ï¸ **æ³¨æ„**ï¼šåªé€‚ç”¨äºä¸å¸¸å˜åŒ–çš„æ•°æ®

### 8.4 ä¼˜åŒ–ç­–ç•¥3ï¼šæµå¼å¤„ç†å¤§æ•°æ®


```java
public class StreamingConverter implements HttpMessageConverter<LargeDataList> {
    
    @Override
    public void write(LargeDataList dataList, MediaType contentType, 
                      HttpOutputMessage outputMessage) throws IOException {
        
        // ä½¿ç”¨æµå¼å†™å…¥ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜
        try (JsonGenerator generator = new JsonFactory()
            .createGenerator(outputMessage.getBody())) {
            
            generator.writeStartArray();
            
            // é€æ¡å¤„ç†æ•°æ®
            dataList.stream().forEach(item -> {
                try {
                    generator.writeObject(item);
                } catch (IOException e) {
                    throw new UncheckedIOException(e);
                }
            });
            
            generator.writeEndArray();
        }
    }
}
```

### 8.5 ä¼˜åŒ–ç­–ç•¥4ï¼šå‹ç¼©å“åº”


```java
public class CompressedConverter extends MappingJackson2HttpMessageConverter {
    
    @Override
    protected void writeInternal(Object object, HttpOutputMessage outputMessage) 
        throws IOException {
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦å‹ç¼©ï¼ˆå“åº”å¤§äº1KBæ—¶å‹ç¼©ï¼‰
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        super.writeInternal(object, new HttpOutputMessageWrapper(outputMessage, baos));
        
        byte[] originalBytes = baos.toByteArray();
        
        if (originalBytes.length > 1024) {
            // ä½¿ç”¨Gzipå‹ç¼©
            ByteArrayOutputStream gzipOut = new ByteArrayOutputStream();
            try (GZIPOutputStream gzip = new GZIPOutputStream(gzipOut)) {
                gzip.write(originalBytes);
            }
            
            byte[] compressedBytes = gzipOut.toByteArray();
            outputMessage.getHeaders().set("Content-Encoding", "gzip");
            outputMessage.getBody().write(compressedBytes);
        } else {
            outputMessage.getBody().write(originalBytes);
        }
    }
}
```

### 8.6 æ€§èƒ½ç›‘æ§


```java
public class MonitoredConverter extends MappingJackson2HttpMessageConverter {
    
    @Override
    protected void writeInternal(Object object, HttpOutputMessage outputMessage) 
        throws IOException {
        
        long startTime = System.currentTimeMillis();
        
        try {
            super.writeInternal(object, outputMessage);
        } finally {
            long duration = System.currentTimeMillis() - startTime;
            
            // è®°å½•æ€§èƒ½æ•°æ®
            if (duration > 100) { // è¶…è¿‡100msè®°å½•
                log.warn("åºåˆ—åŒ–è€—æ—¶: {}ms, ç±»å‹: {}", 
                    duration, object.getClass().getName());
            }
        }
    }
}
```

---

## 9. ğŸ›¡ï¸ é”™è¯¯å¤„ç†æœºåˆ¶


### 9.1 å¸¸è§é”™è¯¯ç±»å‹


| é”™è¯¯ç±»å‹ | **åŸå› ** | **å½±å“** |
|---------|---------|---------|
| `HttpMessageNotReadableException` | `è¯·æ±‚ä½“æ ¼å¼é”™è¯¯` | `400 Bad Request` |
| `HttpMessageNotWritableException` | `åºåˆ—åŒ–å¤±è´¥` | `500 Server Error` |
| `UnsupportedMediaTypeException` | `ä¸æ”¯æŒçš„Content-Type` | `415 Unsupported Media Type` |
| `HttpMediaTypeNotAcceptableException` | `æ— æ³•ç”Ÿæˆå®¢æˆ·ç«¯è¦æ±‚çš„æ ¼å¼` | `406 Not Acceptable` |

### 9.2 è¯»å–å¼‚å¸¸å¤„ç†


```java
public class SafeConverter implements HttpMessageConverter<User> {
    
    @Override
    public User read(Class<? extends User> clazz, HttpInputMessage inputMessage) 
        throws IOException, HttpMessageNotReadableException {
        
        try {
            String body = StreamUtils.copyToString(
                inputMessage.getBody(), StandardCharsets.UTF_8);
            
            // éªŒè¯JSONæ ¼å¼
            if (body == null || body.trim().isEmpty()) {
                throw new HttpMessageNotReadableException(
                    "è¯·æ±‚ä½“ä¸èƒ½ä¸ºç©º", inputMessage);
            }
            
            // è§£æJSON
            return parseJson(body, clazz);
            
        } catch (JsonProcessingException e) {
            throw new HttpMessageNotReadableException(
                "JSONæ ¼å¼é”™è¯¯: " + e.getMessage(), e, inputMessage);
        }
    }
    
    private User parseJson(String json, Class<? extends User> clazz) 
        throws JsonProcessingException {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(json, clazz);
    }
}
```

### 9.3 å†™å…¥å¼‚å¸¸å¤„ç†


```java
public class RobustConverter extends AbstractHttpMessageConverter<Object> {
    
    @Override
    protected void writeInternal(Object object, HttpOutputMessage outputMessage) 
        throws IOException, HttpMessageNotWritableException {
        
        try {
            // éªŒè¯å¯¹è±¡
            if (object == null) {
                throw new HttpMessageNotWritableException("è¿”å›å¯¹è±¡ä¸èƒ½ä¸ºnull");
            }
            
            // åºåˆ—åŒ–
            byte[] bytes = serialize(object);
            
            // è®¾ç½®å“åº”å¤´
            outputMessage.getHeaders().setContentType(MediaType.APPLICATION_JSON);
            outputMessage.getHeaders().setContentLength(bytes.length);
            
            // å†™å…¥å“åº”
            outputMessage.getBody().write(bytes);
            
        } catch (Exception e) {
            throw new HttpMessageNotWritableException(
                "åºåˆ—åŒ–å¤±è´¥: " + e.getMessage(), e);
        }
    }
}
```

### 9.4 å…¨å±€å¼‚å¸¸å¤„ç†


```java
@RestControllerAdvice
public class MessageConverterExceptionHandler {
    
    // å¤„ç†è¯·æ±‚ä½“è§£æé”™è¯¯
    @ExceptionHandler(HttpMessageNotReadableException.class)
    public ResponseEntity<ErrorResponse> handleNotReadable(
        HttpMessageNotReadableException ex) {
        
        ErrorResponse error = new ErrorResponse();
        error.setCode(400);
        error.setMessage("è¯·æ±‚æ•°æ®æ ¼å¼é”™è¯¯");
        error.setDetail(ex.getMessage());
        
        return ResponseEntity.badRequest().body(error);
    }
    
    // å¤„ç†ä¸æ”¯æŒçš„åª’ä½“ç±»å‹
    @ExceptionHandler(HttpMediaTypeNotSupportedException.class)
    public ResponseEntity<ErrorResponse> handleUnsupportedMediaType(
        HttpMediaTypeNotSupportedException ex) {
        
        ErrorResponse error = new ErrorResponse();
        error.setCode(415);
        error.setMessage("ä¸æ”¯æŒçš„Content-Type");
        error.setSupportedTypes(ex.getSupportedMediaTypes()
            .stream()
            .map(MediaType::toString)
            .collect(Collectors.toList()));
        
        return ResponseEntity.status(415).body(error);
    }
    
    // å¤„ç†åºåˆ—åŒ–é”™è¯¯
    @ExceptionHandler(HttpMessageNotWritableException.class)
    public ResponseEntity<ErrorResponse> handleNotWritable(
        HttpMessageNotWritableException ex) {
        
        ErrorResponse error = new ErrorResponse();
        error.setCode(500);
        error.setMessage("å“åº”æ•°æ®åºåˆ—åŒ–å¤±è´¥");
        
        return ResponseEntity.status(500).body(error);
    }
}
```

### 9.5 ä¼˜é›…é™çº§ç­–ç•¥


```java
public class FallbackConverter implements HttpMessageConverter<Object> {
    
    private final List<HttpMessageConverter<?>> delegates;
    
    @Override
    public void write(Object object, MediaType contentType, 
                      HttpOutputMessage outputMessage) throws IOException {
        
        // å°è¯•ä½¿ç”¨å„ä¸ªè½¬æ¢å™¨
        for (HttpMessageConverter delegate : delegates) {
            if (delegate.canWrite(object.getClass(), contentType)) {
                try {
                    delegate.write(object, contentType, outputMessage);
                    return; // æˆåŠŸåˆ™è¿”å›
                } catch (Exception e) {
                    log.warn("è½¬æ¢å™¨{}å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª", 
                        delegate.getClass().getSimpleName());
                }
            }
        }
        
        // æ‰€æœ‰è½¬æ¢å™¨éƒ½å¤±è´¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ
        fallbackWrite(object, outputMessage);
    }
    
    private void fallbackWrite(Object object, HttpOutputMessage outputMessage) 
        throws IOException {
        // é™çº§ä¸ºç®€å•çš„toStringè¾“å‡º
        String fallback = "{\"error\":\"åºåˆ—åŒ–å¤±è´¥\",\"data\":\"" + 
                         object.toString() + "\"}";
        outputMessage.getBody().write(fallback.getBytes(StandardCharsets.UTF_8));
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ¶ˆæ¯è½¬æ¢å™¨æœ¬è´¨ï¼šJavaå¯¹è±¡ä¸HTTPæ¶ˆæ¯ä½“ä¹‹é—´çš„è½¬æ¢å™¨
ğŸ”¸ æ ¸å¿ƒæ¥å£ï¼šHttpMessageConverter<T>ï¼ŒåŒ…å«canReadã€readã€canWriteã€writeæ–¹æ³•
ğŸ”¸ å·¥ä½œæµç¨‹ï¼šè¯·æ±‚â†’è½¬æ¢å™¨â†’å¯¹è±¡ï¼Œå¯¹è±¡â†’è½¬æ¢å™¨â†’å“åº”
ğŸ”¸ åª’ä½“ç±»å‹ï¼šé€šè¿‡Content-Typeå’ŒAcceptåå•†æ•°æ®æ ¼å¼
ğŸ”¸ ä¼˜å…ˆçº§æœºåˆ¶ï¼šè½¬æ¢å™¨æŒ‰åˆ—è¡¨é¡ºåºåŒ¹é…ï¼Œå…ˆåŒ¹é…å…ˆä½¿ç”¨
```

### 10.2 å®æˆ˜å…³é”®ç‚¹


> ğŸ’¡ **è‡ªå®šä¹‰è½¬æ¢å™¨è¦ç‚¹**ï¼š
> - ç»§æ‰¿`AbstractHttpMessageConverter`ç®€åŒ–å¼€å‘
> - æ˜ç¡®`canRead/canWrite`çš„åˆ¤æ–­é€»è¾‘
> - æ­£ç¡®å¤„ç†å­—ç¬¦ç¼–ç ï¼ˆæ¨èUTF-8ï¼‰
> - åšå¥½å¼‚å¸¸å¤„ç†å’Œé™çº§æ–¹æ¡ˆ

> âš ï¸ **é…ç½®æ³¨æ„äº‹é¡¹**ï¼š
> - ä¼˜å…ˆä½¿ç”¨`extendMessageConverters`ä¿ç•™é»˜è®¤é…ç½®
> - ä½¿ç”¨`configureMessageConverters`éœ€æ‰‹åŠ¨æ·»åŠ æ‰€æœ‰è½¬æ¢å™¨
> - è‡ªå®šä¹‰è½¬æ¢å™¨æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´æé«˜ä¼˜å…ˆçº§

> ğŸš€ **æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
> - é‡ç”¨ObjectMapperç­‰å¯¹è±¡ï¼Œé¿å…é¢‘ç¹åˆ›å»º
> - å¤§æ•°æ®ä½¿ç”¨æµå¼å¤„ç†ï¼Œé¿å…å†…å­˜æº¢å‡º
> - è€ƒè™‘å“åº”å‹ç¼©å‡å°‘ç½‘ç»œä¼ è¾“
> - æ·»åŠ æ€§èƒ½ç›‘æ§åŠæ—¶å‘ç°é—®é¢˜

### 10.3 å­¦ä¹ è·¯å¾„å»ºè®®


```
å­¦ä¹ è¿›é˜¶è·¯çº¿ï¼š

å…¥é—¨é˜¶æ®µ â”€â”€â”€â”€â†’ ç†è§£æ¶ˆæ¯è½¬æ¢å™¨çš„ä½œç”¨å’Œå·¥ä½œåŸç†
              ç†Ÿæ‚‰Spring MVCå†…ç½®çš„è½¬æ¢å™¨

è¿›é˜¶é˜¶æ®µ â”€â”€â”€â”€â†’ ç¼–å†™ç®€å•çš„è‡ªå®šä¹‰è½¬æ¢å™¨
              æŒæ¡è½¬æ¢å™¨é…ç½®å’Œä¼˜å…ˆçº§æ§åˆ¶
              
é«˜çº§é˜¶æ®µ â”€â”€â”€â”€â†’ å¤„ç†å¤æ‚æ ¼å¼å’ŒåŠ å¯†åœºæ™¯
              æ€§èƒ½ä¼˜åŒ–å’Œå¼‚å¸¸å¤„ç†
              å¤šè½¬æ¢å™¨ç»„åˆä½¿ç”¨
```

### 10.4 å¸¸è§é—®é¢˜é€ŸæŸ¥


| é—®é¢˜ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|-----|---------|------------|
| `ä¸­æ–‡ä¹±ç ` | `å­—ç¬¦ç¼–ç ä¸ä¸€è‡´` | `ç»Ÿä¸€ä½¿ç”¨UTF-8ç¼–ç ` |
| `è½¬æ¢å™¨ä¸ç”Ÿæ•ˆ` | `ä¼˜å…ˆçº§å¤ªä½` | `æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´` |
| `JSONè§£æå¤±è´¥` | `æ ¼å¼é”™è¯¯æˆ–ç±»å‹ä¸åŒ¹é…` | `æ£€æŸ¥å­—æ®µç±»å‹å’ŒJSONæ ¼å¼` |
| `æ€§èƒ½æ…¢` | `é¢‘ç¹åˆ›å»ºå¯¹è±¡` | `ä½¿ç”¨å¯¹è±¡æ± æˆ–å•ä¾‹æ¨¡å¼` |

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
è½¬æ¢å™¨æœ¬è´¨æ˜¯ç¿»è¯‘å®˜ï¼ŒJavaå¯¹è±¡å’ŒHTTPäº’ç›¸è½¬
canReadåˆ¤æ–­èƒ½å¦è¯»ï¼Œreadæ–¹æ³•è´Ÿè´£è§£æè½¬æ¢
canWriteåˆ¤æ–­èƒ½å¦å†™ï¼Œwriteæ–¹æ³•åºåˆ—åŒ–è¾“å‡º
ä¼˜å…ˆçº§é¡ºåºå¾ˆé‡è¦ï¼Œä¸“ç”¨è½¬æ¢æ”¾æœ€å‰
å­—ç¬¦ç¼–ç è¦ç»Ÿä¸€ï¼ŒUTF-8æ˜¯é¦–é€‰æ–¹æ¡ˆ
æ€§èƒ½ä¼˜åŒ–é‡å¯¹è±¡ï¼Œå¼‚å¸¸å¤„ç†è¦å¥å…¨
```