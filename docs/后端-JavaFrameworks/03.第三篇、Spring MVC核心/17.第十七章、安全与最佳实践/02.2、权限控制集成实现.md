---
title: 2ã€æƒé™æ§åˆ¶é›†æˆå®ç°
---
## ğŸ“š ç›®å½•

1. [æƒé™æ§åˆ¶æ˜¯ä»€ä¹ˆ](#1-æƒé™æ§åˆ¶æ˜¯ä»€ä¹ˆ)
2. [Spring Securityé›†æˆ](#2-Spring-Securityé›†æˆ)
3. [è®¤è¯æœºåˆ¶è¯¦è§£](#3-è®¤è¯æœºåˆ¶è¯¦è§£)
4. [æˆæƒæ§åˆ¶å®ç°](#4-æˆæƒæ§åˆ¶å®ç°)
5. [è§’è‰²ä¸æƒé™ç®¡ç†](#5-è§’è‰²ä¸æƒé™ç®¡ç†)
6. [æƒé™æ³¨è§£ä½¿ç”¨](#6-æƒé™æ³¨è§£ä½¿ç”¨)
7. [URLæƒé™æ§åˆ¶](#7-URLæƒé™æ§åˆ¶)
8. [æ–¹æ³•çº§æƒé™æ§åˆ¶](#8-æ–¹æ³•çº§æƒé™æ§åˆ¶)
9. [è‡ªå®šä¹‰è®¤è¯æ–¹æ¡ˆ](#9-è‡ªå®šä¹‰è®¤è¯æ–¹æ¡ˆ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” æƒé™æ§åˆ¶æ˜¯ä»€ä¹ˆ


### 1.1 ç°å®ç”Ÿæ´»ä¸­çš„æƒé™


**ç†è§£æƒé™æ§åˆ¶**ï¼šå°±åƒå…¬å¸çš„é—¨ç¦ç³»ç»Ÿ

```
å…¬å¸å¤§æ¥¼çš„æƒé™æ§åˆ¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ™®é€šå‘˜å·¥ï¼šåªèƒ½è¿›1æ¥¼åŠå…¬åŒº  â”‚
â”‚  éƒ¨é—¨ç»ç†ï¼šèƒ½è¿›1-3æ¥¼        â”‚
â”‚  æ€»ç»ç†ï¼š  æ‰€æœ‰æ¥¼å±‚éƒ½èƒ½è¿›    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç½‘ç«™ç³»ç»Ÿçš„æƒé™æ§åˆ¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¸¸å®¢ï¼š    åªèƒ½æµè§ˆæ–‡ç«       â”‚
â”‚  æ™®é€šç”¨æˆ·ï¼šèƒ½å‘è¡¨è¯„è®º        â”‚
â”‚  ç®¡ç†å‘˜ï¼š  èƒ½åˆ é™¤ä»»ä½•å†…å®¹    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æƒé™æ§åˆ¶çš„æœ¬è´¨**ï¼š
- **è®¤è¯ï¼ˆAuthenticationï¼‰**ï¼šç¡®è®¤"ä½ æ˜¯è°" â†’ å°±åƒé—¨ç¦å¡éªŒè¯èº«ä»½
- **æˆæƒï¼ˆAuthorizationï¼‰**ï¼šç¡®è®¤"ä½ èƒ½å¹²ä»€ä¹ˆ" â†’ å°±åƒä¸åŒå·¥ç‰Œæœ‰ä¸åŒæƒé™

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æƒé™æ§åˆ¶


**ğŸ¯ æ ¸å¿ƒä½œç”¨**ï¼š

| å®‰å…¨éœ€æ±‚ | **å®é™…åœºæ™¯** | **æ²¡æœ‰æƒé™æ§åˆ¶çš„åæœ** |
|---------|------------|---------------------|
| **æ•°æ®å®‰å…¨** | `ç”¨æˆ·ä¸ªäººä¿¡æ¯` | ä»»ä½•äººéƒ½èƒ½çœ‹åˆ°åˆ«äººçš„éšç§ |
| **åŠŸèƒ½ä¿æŠ¤** | `åˆ é™¤æ–‡ç« åŠŸèƒ½` | æ™®é€šç”¨æˆ·å¯ä»¥åˆ é™¤ä»»ä½•å†…å®¹ |
| **ç³»ç»Ÿç¨³å®š** | `ç³»ç»Ÿé…ç½®ä¿®æ”¹` | è¯¯æ“ä½œå¯¼è‡´ç³»ç»Ÿå´©æºƒ |
| **åˆè§„è¦æ±‚** | `è´¢åŠ¡æ•°æ®è®¿é—®` | è¿åæ³•å¾‹æ³•è§„è¦æ±‚ |

> ğŸ’¡ **ç®€å•ç†è§£**  
> æƒé™æ§åˆ¶å°±æ˜¯ç»™ç³»ç»Ÿè£…ä¸Š"é—¨é”"ï¼Œç¡®ä¿åªæœ‰æœ‰é’¥åŒ™çš„äººæ‰èƒ½è¿›å…¥ç‰¹å®šæˆ¿é—´ï¼Œå¹¶ä¸”åªèƒ½åšè¢«å…è®¸çš„äº‹æƒ…ã€‚

---

## 2. ğŸ›¡ï¸ Spring Securityé›†æˆ


### 2.1 ä»€ä¹ˆæ˜¯Spring Security


**Spring Security**ï¼šSpringå®¶æ—çš„ä¸“ä¸šä¿å®‰

```
æ²¡æœ‰Spring Securityçš„ç³»ç»Ÿï¼š
ç”¨æˆ· â†’ ç›´æ¥è®¿é—® â†’ ä»»ä½•åŠŸèƒ½ï¼ˆå±é™©ï¼ï¼‰

æœ‰Spring Securityçš„ç³»ç»Ÿï¼š
ç”¨æˆ· â†’ ç™»å½•éªŒè¯ â†’ æƒé™æ£€æŸ¥ â†’ å…è®¸çš„åŠŸèƒ½ï¼ˆå®‰å…¨ï¼ï¼‰
```

**ğŸ”¸ æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ… **ç™»å½•è®¤è¯**ï¼šéªŒè¯ç”¨æˆ·èº«ä»½
- âœ… **æƒé™æ£€æŸ¥**ï¼šåˆ¤æ–­èƒ½å¦è®¿é—®
- âœ… **åŠ å¯†ä¿æŠ¤**ï¼šå¯†ç å®‰å…¨å­˜å‚¨
- âœ… **ä¼šè¯ç®¡ç†**ï¼šè®°ä½ç™»å½•çŠ¶æ€

### 2.2 å¿«é€Ÿé›†æˆæ­¥éª¤


**æ­¥éª¤1ï¼šæ·»åŠ ä¾èµ–** ğŸ“¦

```xml
<!-- pom.xml ä¸­æ·»åŠ  Spring Security -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

> ğŸ’¡ **æç¤º**ï¼šä½¿ç”¨ Spring Boot æ—¶ï¼ŒåŠ ä¸Šè¿™ä¸ªä¾èµ–åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¯ç”¨å®‰å…¨ä¿æŠ¤

**æ­¥éª¤2ï¼šåŸºç¡€é…ç½®** âš™ï¸

```java
@Configuration
@EnableWebSecurity  // å¼€å¯Webå®‰å…¨åŠŸèƒ½
public class SecurityConfig {
    
    // é…ç½®å“ªäº›è·¯å¾„éœ€è¦ä¿æŠ¤
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**").permitAll()  // å…¬å¼€è·¯å¾„
                .anyRequest().authenticated()                // å…¶ä»–éƒ½éœ€è¦ç™»å½•
            )
            .formLogin(form -> form
                .loginPage("/login")      // è‡ªå®šä¹‰ç™»å½•é¡µ
                .permitAll()
            );
        return http.build();
    }
}
```

**å…³é”®æ¦‚å¿µè§£é‡Š**ï¼š

- `@EnableWebSecurity`ï¼šå‘Šè¯‰Spring "æˆ‘è¦å¯ç”¨å®‰å…¨åŠŸèƒ½"
- `permitAll()`ï¼šä¸éœ€è¦ç™»å½•å°±èƒ½è®¿é—®ï¼ˆæ¯”å¦‚é¦–é¡µï¼‰
- `authenticated()`ï¼šå¿…é¡»ç™»å½•æ‰èƒ½è®¿é—®

### 2.3 é›†æˆåçš„æ•ˆæœ


**è®¿é—®æµç¨‹å˜åŒ–**ï¼š

```
é›†æˆå‰ï¼š
æµè§ˆå™¨ â†’ è¾“å…¥ç½‘å€ â†’ ç›´æ¥æ˜¾ç¤ºé¡µé¢

é›†æˆåï¼š
æµè§ˆå™¨ â†’ è¾“å…¥ç½‘å€ â†’ Securityæ‹¦æˆª â†’ è·³è½¬ç™»å½•é¡µ â†’ éªŒè¯æˆåŠŸ â†’ æ˜¾ç¤ºé¡µé¢
         â†“                        â†“
    æœªç™»å½•è·¯å¾„              éœ€è¦ä¿æŠ¤çš„è·¯å¾„
```

> âš ï¸ **æ–°æ‰‹æ³¨æ„**  
> åŠ å…¥ Spring Security åï¼Œé»˜è®¤æ‰€æœ‰è·¯å¾„éƒ½éœ€è¦ç™»å½•ï¼è¦è®°å¾—é…ç½®å…¬å¼€è·¯å¾„ã€‚

---

## 3. ğŸ”‘ è®¤è¯æœºåˆ¶è¯¦è§£


### 3.1 è®¤è¯æ˜¯ä»€ä¹ˆ


**è®¤è¯ï¼ˆAuthenticationï¼‰**ï¼šè¯æ˜"æˆ‘æ˜¯æˆ‘"

```
ç°å®ç”Ÿæ´»çš„è®¤è¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é“¶è¡Œå–é’±         â”‚
â”‚ â†“               â”‚
â”‚ å‡ºç¤ºèº«ä»½è¯       â”‚ â† è®¤è¯å‡­è¯
â”‚ â†“               â”‚
â”‚ æ ¸å¯¹ç…§ç‰‡å’Œä¿¡æ¯   â”‚ â† éªŒè¯è¿‡ç¨‹
â”‚ â†“               â”‚
â”‚ ç¡®è®¤æ˜¯æœ¬äºº       â”‚ â† è®¤è¯æˆåŠŸ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç³»ç»Ÿçš„è®¤è¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¿é—®ç³»ç»Ÿ         â”‚
â”‚ â†“               â”‚
â”‚ è¾“å…¥ç”¨æˆ·åå¯†ç    â”‚ â† è®¤è¯å‡­è¯
â”‚ â†“               â”‚
â”‚ ç³»ç»ŸéªŒè¯        â”‚ â† éªŒè¯è¿‡ç¨‹
â”‚ â†“               â”‚
â”‚ ç™»å½•æˆåŠŸ        â”‚ â† è®¤è¯æˆåŠŸ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å¸¸è§è®¤è¯æ–¹å¼


**ğŸ”¸ ç”¨æˆ·åå¯†ç è®¤è¯**ï¼ˆæœ€å¸¸ç”¨ï¼‰

```java
@Service
public class UserDetailsServiceImpl implements UserDetailsService {
    
    @Autowired
    private UserMapper userMapper;
    
    // æ ¹æ®ç”¨æˆ·ååŠ è½½ç”¨æˆ·ä¿¡æ¯
    @Override
    public UserDetails loadUserByUsername(String username) {
        // ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
        User user = userMapper.findByUsername(username);
        
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // è¿”å›ç”¨æˆ·è¯¦æƒ…ï¼ˆåŒ…å«å¯†ç å’Œæƒé™ï¼‰
        return org.springframework.security.core.userdetails.User
                .withUsername(user.getUsername())
                .password(user.getPassword())  // åŠ å¯†åçš„å¯†ç 
                .authorities(user.getRoles())  // ç”¨æˆ·è§’è‰²
                .build();
    }
}
```

**æµç¨‹è¯´æ˜**ï¼š

```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š
1. ç”¨æˆ·è¾“å…¥ï¼šusername = "zhangsan", password = "123456"
2. Spring Security è°ƒç”¨ loadUserByUsername("zhangsan")
3. ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
4. å¯¹æ¯”å¯†ç æ˜¯å¦åŒ¹é…
5. åŒ¹é…æˆåŠŸ â†’ ç™»å½•æˆåŠŸï¼Œç”Ÿæˆä¼šè¯
6. åŒ¹é…å¤±è´¥ â†’ ç™»å½•å¤±è´¥ï¼Œè¿”å›é”™è¯¯
```

**ğŸ”¸ Tokenè®¤è¯**ï¼ˆé€‚åˆå‰åç«¯åˆ†ç¦»ï¼‰

```java
@Component
public class JwtTokenProvider {
    
    private String secretKey = "mySecretKey";
    
    // ç”ŸæˆToken
    public String createToken(String username) {
        Date now = new Date();
        Date validity = new Date(now.getTime() + 3600000); // 1å°æ—¶æœ‰æ•ˆ
        
        return Jwts.builder()
                .setSubject(username)           // ç”¨æˆ·å
                .setIssuedAt(now)               // ç­¾å‘æ—¶é—´
                .setExpiration(validity)        // è¿‡æœŸæ—¶é—´
                .signWith(SignatureAlgorithm.HS256, secretKey)
                .compact();
    }
    
    // éªŒè¯Token
    public boolean validateToken(String token) {
        try {
            Jwts.parser().setSigningKey(secretKey).parseClaimsJws(token);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
}
```

**Tokenè®¤è¯æµç¨‹**ï¼š

```
1. ç”¨æˆ·ç™»å½•æˆåŠŸ â†’ æœåŠ¡å™¨ç”ŸæˆToken â†’ è¿”å›ç»™å‰ç«¯
2. å‰ç«¯ä¿å­˜Tokenï¼ˆé€šå¸¸å­˜åœ¨localStorageï¼‰
3. åç»­è¯·æ±‚éƒ½å¸¦ä¸ŠTokenï¼š
   
   è¯·æ±‚å¤´ï¼šAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   
4. æœåŠ¡å™¨éªŒè¯Token â†’ ç¡®è®¤ç”¨æˆ·èº«ä»½ â†’ å…è®¸è®¿é—®
```

> ğŸ’¡ **é€‰æ‹©å»ºè®®**  
> - ä¼ ç»ŸWebé¡¹ç›®ï¼šç”¨æˆ·åå¯†ç  + Session  
> - å‰åç«¯åˆ†ç¦»ï¼šTokenè®¤è¯ï¼ˆJWTï¼‰  
> - ç§»åŠ¨Appï¼šTokenè®¤è¯

### 3.3 å¯†ç åŠ å¯†


**ä¸ºä»€ä¹ˆè¦åŠ å¯†**ï¼š

```
ä¸åŠ å¯†çš„å±é™©ï¼š
æ•°æ®åº“å­˜å‚¨ï¼šusername="admin", password="123456"
â†“
æ•°æ®åº“æ³„éœ² â†’ é»‘å®¢ç›´æ¥çœ‹åˆ°å¯†ç  â†’ ç”¨ç›¸åŒå¯†ç ç™»å½•å…¶ä»–ç½‘ç«™

åŠ å¯†åçš„å®‰å…¨ï¼š
æ•°æ®åº“å­˜å‚¨ï¼šusername="admin", password="$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi"
â†“
æ•°æ®åº“æ³„éœ² â†’ é»‘å®¢çœ‹åˆ°åŠ å¯†ä¸² â†’ æ— æ³•æ¨ç®—å‡ºåŸå§‹å¯†ç 
```

**ä½¿ç”¨BCryptåŠ å¯†**ï¼š

```java
@Configuration
public class SecurityConfig {
    
    // é…ç½®å¯†ç åŠ å¯†å™¨
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();  // ä½¿ç”¨BCryptç®—æ³•
    }
}

// æ³¨å†Œæ—¶åŠ å¯†å¯†ç 
@Service
public class UserService {
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    public void register(String username, String password) {
        // åŠ å¯†å¯†ç 
        String encryptedPassword = passwordEncoder.encode(password);
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        userMapper.save(username, encryptedPassword);
    }
}
```

**BCryptç‰¹ç‚¹**ï¼š
- âœ… **ä¸å¯é€†**ï¼šåŠ å¯†åæ— æ³•è§£å¯†å›åŸæ–‡
- âœ… **åŠ ç›**ï¼šç›¸åŒå¯†ç æ¯æ¬¡åŠ å¯†ç»“æœéƒ½ä¸åŒ
- âœ… **æ…¢é€Ÿ**ï¼šæ•…æ„è®¾è®¡å¾—æ…¢ï¼Œé˜²æ­¢æš´åŠ›ç ´è§£

---

## 4. âœ… æˆæƒæ§åˆ¶å®ç°


### 4.1 æˆæƒæ˜¯ä»€ä¹ˆ


**æˆæƒï¼ˆAuthorizationï¼‰**ï¼šç¡®å®š"ä½ èƒ½åšä»€ä¹ˆ"

```
è®¤è¯ vs æˆæƒçš„åŒºåˆ«ï¼š

è®¤è¯ï¼ˆAuthenticationï¼‰ï¼š
é—®ï¼šä½ æ˜¯è°ï¼Ÿ
ç­”ï¼šæˆ‘æ˜¯å¼ ä¸‰ï¼ˆæä¾›å·¥ç‰Œè¯æ˜èº«ä»½ï¼‰

æˆæƒï¼ˆAuthorizationï¼‰ï¼š  
é—®ï¼šä½ èƒ½è¿›å“ªäº›æˆ¿é—´ï¼Ÿ
ç­”ï¼šæˆ‘èƒ½è¿›åŠå…¬åŒºï¼Œä½†ä¸èƒ½è¿›è´¢åŠ¡å®¤ï¼ˆæ ¹æ®å·¥ç‰Œæƒé™å†³å®šï¼‰
```

### 4.2 åŸºäºè§’è‰²çš„æˆæƒ


**è§’è‰²ï¼ˆRoleï¼‰**ï¼šä¸€ç»„æƒé™çš„é›†åˆ

```
è§’è‰²è®¾è®¡ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§’è‰²ï¼šADMINï¼ˆç®¡ç†å‘˜ï¼‰     â”‚
â”‚ æƒé™ï¼š                   â”‚
â”‚  - æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·           â”‚
â”‚  - åˆ é™¤ç”¨æˆ·              â”‚
â”‚  - ä¿®æ”¹ç³»ç»Ÿé…ç½®           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§’è‰²ï¼šUSERï¼ˆæ™®é€šç”¨æˆ·ï¼‰    â”‚
â”‚ æƒé™ï¼š                   â”‚
â”‚  - æŸ¥çœ‹ä¸ªäººä¿¡æ¯           â”‚
â”‚  - ä¿®æ”¹ä¸ªäººä¿¡æ¯           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®è§’è‰²æˆæƒ**ï¼š

```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) {
        http.authorizeHttpRequests(auth -> auth
            // é¦–é¡µæ‰€æœ‰äººéƒ½èƒ½è®¿é—®
            .requestMatchers("/").permitAll()
            
            // /admin/** è·¯å¾„éœ€è¦ADMINè§’è‰²
            .requestMatchers("/admin/**").hasRole("ADMIN")
            
            // /user/** è·¯å¾„éœ€è¦USERæˆ–ADMINè§’è‰²
            .requestMatchers("/user/**").hasAnyRole("USER", "ADMIN")
            
            // å…¶ä»–è·¯å¾„éœ€è¦ç™»å½•
            .anyRequest().authenticated()
        );
        return http.build();
    }
}
```

**è®¿é—®åˆ¤æ–­é€»è¾‘**ï¼š

```
ç”¨æˆ·è®¿é—® /admin/usersï¼š
1. Spring Securityæ£€æŸ¥ï¼šæ­¤è·¯å¾„éœ€è¦ADMINè§’è‰²
2. è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„è§’è‰²
3. åˆ¤æ–­ï¼š
   - æœ‰ADMINè§’è‰² â†’ å…è®¸è®¿é—®
   - æ²¡æœ‰ADMINè§’è‰² â†’ æ‹’ç»è®¿é—®ï¼ˆ403é”™è¯¯ï¼‰
```

### 4.3 åŸºäºæƒé™çš„æˆæƒ


**ç»†ç²’åº¦æƒé™æ§åˆ¶**ï¼š

```java
// é…ç½®å…·ä½“æƒé™
http.authorizeHttpRequests(auth -> auth
    // éœ€è¦ "user:read" æƒé™æ‰èƒ½è®¿é—®
    .requestMatchers("/user/list").hasAuthority("user:read")
    
    // éœ€è¦ "user:delete" æƒé™æ‰èƒ½è®¿é—®
    .requestMatchers("/user/delete").hasAuthority("user:delete")
);
```

**æƒé™å‘½åè§„èŒƒ**ï¼š

```
å¸¸è§æƒé™å‘½åï¼š
èµ„æº:æ“ä½œ

ç¤ºä¾‹ï¼š
user:read    â†’ è¯»å–ç”¨æˆ·ä¿¡æ¯
user:create  â†’ åˆ›å»ºç”¨æˆ·
user:update  â†’ æ›´æ–°ç”¨æˆ·
user:delete  â†’ åˆ é™¤ç”¨æˆ·

article:publish â†’ å‘å¸ƒæ–‡ç« 
article:edit    â†’ ç¼–è¾‘æ–‡ç« 
```

> ğŸ“ **è§’è‰² vs æƒé™**  
> - **è§’è‰²**ï¼šç²—ç²’åº¦ï¼Œä¸€ä¸ªäººçš„èº«ä»½ï¼ˆå¦‚ï¼šç®¡ç†å‘˜ã€ç¼–è¾‘ï¼‰  
> - **æƒé™**ï¼šç»†ç²’åº¦ï¼Œå…·ä½“èƒ½åšä»€ä¹ˆï¼ˆå¦‚ï¼šåˆ é™¤æ–‡ç« ã€æŸ¥çœ‹æŠ¥è¡¨ï¼‰  
> - **å…³ç³»**ï¼šä¸€ä¸ªè§’è‰²åŒ…å«å¤šä¸ªæƒé™

---

## 5. ğŸ‘¥ è§’è‰²ä¸æƒé™ç®¡ç†


### 5.1 è§’è‰²æƒé™è®¾è®¡


**æ•°æ®åº“è®¾è®¡**ï¼š

```
ç”¨æˆ·è¡¨ï¼ˆuserï¼‰           è§’è‰²è¡¨ï¼ˆroleï¼‰         æƒé™è¡¨ï¼ˆpermissionï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id       â”‚            â”‚ id       â”‚          â”‚ id           â”‚
â”‚ username â”‚            â”‚ name     â”‚          â”‚ name         â”‚
â”‚ password â”‚            â”‚ desc     â”‚          â”‚ code         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“                       â†“                      â†“
   ç”¨æˆ·è§’è‰²å…³è”è¡¨          è§’è‰²æƒé™å…³è”è¡¨
   (user_role)           (role_permission)
```

**å®ä½“ç±»è®¾è®¡**ï¼š

```java
// ç”¨æˆ·å®ä½“
@Entity
public class User {
    @Id
    private Long id;
    private String username;
    private String password;
    
    // ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²
    @ManyToMany
    private Set<Role> roles;
}

// è§’è‰²å®ä½“
@Entity
public class Role {
    @Id
    private Long id;
    private String name;  // å¦‚ï¼šADMIN, USER
    
    // è§’è‰²æ‹¥æœ‰çš„æƒé™
    @ManyToMany
    private Set<Permission> permissions;
}

// æƒé™å®ä½“
@Entity
public class Permission {
    @Id
    private Long id;
    private String name;  // å¦‚ï¼šç”¨æˆ·ç®¡ç†
    private String code;  // å¦‚ï¼šuser:delete
}
```

### 5.2 åŠ¨æ€åŠ è½½æƒé™


**ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·æƒé™**ï¼š

```java
@Service
public class UserDetailsServiceImpl implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) {
        // 1. æŸ¥è¯¢ç”¨æˆ·
        User user = userRepository.findByUsername(username);
        
        // 2. æ”¶é›†ç”¨æˆ·çš„æ‰€æœ‰æƒé™
        Set<GrantedAuthority> authorities = new HashSet<>();
        
        // æ·»åŠ è§’è‰²ï¼ˆæ³¨æ„ï¼šSpring Securityçš„è§’è‰²éœ€è¦ROLE_å‰ç¼€ï¼‰
        for (Role role : user.getRoles()) {
            authorities.add(new SimpleGrantedAuthority("ROLE_" + role.getName()));
            
            // æ·»åŠ è¯¥è§’è‰²çš„æ‰€æœ‰æƒé™
            for (Permission permission : role.getPermissions()) {
                authorities.add(new SimpleGrantedAuthority(permission.getCode()));
            }
        }
        
        // 3. æ„å»ºUserDetailså¯¹è±¡
        return new org.springframework.security.core.userdetails.User(
            user.getUsername(),
            user.getPassword(),
            authorities  // åŒ…å«è§’è‰²å’Œæƒé™
        );
    }
}
```

**æƒé™æ”¶é›†è¿‡ç¨‹**ï¼š

```
ç”¨æˆ·ï¼šzhangsan
è§’è‰²ï¼šADMIN
æƒé™ï¼šuser:read, user:delete, user:update

æ”¶é›†ç»“æœï¼š
authorities = [
    "ROLE_ADMIN",      // è§’è‰²ï¼ˆåŠ äº†ROLE_å‰ç¼€ï¼‰
    "user:read",       // æƒé™1
    "user:delete",     // æƒé™2  
    "user:update"      // æƒé™3
]
```

---

## 6. ğŸ·ï¸ æƒé™æ³¨è§£ä½¿ç”¨


### 6.1 ä¸ºä»€ä¹ˆç”¨æ³¨è§£


**æ³¨è§£çš„ä¼˜åŠ¿**ï¼š

```
é…ç½®æ–¹å¼ vs æ³¨è§£æ–¹å¼ï¼š

é…ç½®æ–¹å¼ï¼ˆSecurityConfigä¸­é…ç½®ï¼‰ï¼š
âœ… é›†ä¸­ç®¡ç†
âŒ ä¿®æ”¹éœ€è¦æ”¹é…ç½®ç±»
âŒ ä¸å¤Ÿçµæ´»

æ³¨è§£æ–¹å¼ï¼ˆæ–¹æ³•ä¸ŠåŠ æ³¨è§£ï¼‰ï¼š
âœ… ä»£ç å³æ–‡æ¡£ï¼Œä¸€ç›®äº†ç„¶
âœ… çµæ´»æ–¹ä¾¿
âœ… æ”¯æŒå¤æ‚çš„æƒé™è¡¨è¾¾å¼
```

### 6.2 å¸¸ç”¨æƒé™æ³¨è§£


**å¼€å¯æ–¹æ³•çº§å®‰å…¨**ï¼š

```java
@Configuration
@EnableMethodSecurity  // å¼€å¯æ–¹æ³•çº§æƒé™æ§åˆ¶
public class SecurityConfig {
    // ...é…ç½®
}
```

**ğŸ”¸ @PreAuthorize**ï¼ˆæœ€å¸¸ç”¨ï¼‰

```java
@RestController
@RequestMapping("/user")
public class UserController {
    
    // éœ€è¦ADMINè§’è‰²æ‰èƒ½è®¿é—®
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/list")
    public List<User> listUsers() {
        return userService.findAll();
    }
    
    // éœ€è¦user:deleteæƒé™
    @PreAuthorize("hasAuthority('user:delete')")
    @DeleteMapping("/{id}")
    public void deleteUser(@PathVariable Long id) {
        userService.delete(id);
    }
    
    // éœ€è¦ADMINæˆ–MANAGERè§’è‰²
    @PreAuthorize("hasAnyRole('ADMIN', 'MANAGER')")
    @PostMapping("/approve")
    public void approveUser(@RequestBody User user) {
        userService.approve(user);
    }
}
```

**ğŸ”¸ @PostAuthorize**ï¼ˆæ–¹æ³•æ‰§è¡Œåæ£€æŸ¥ï¼‰

```java
@Service
public class ArticleService {
    
    // æŸ¥è¯¢åæ£€æŸ¥ï¼šåªèƒ½çœ‹åˆ°è‡ªå·±çš„æ–‡ç« 
    @PostAuthorize("returnObject.author == authentication.name")
    public Article getArticle(Long id) {
        return articleRepository.findById(id);
    }
}
```

**æµç¨‹è¯´æ˜**ï¼š

```
@PostAuthorizeçš„æ‰§è¡Œæµç¨‹ï¼š
1. æ‰§è¡Œæ–¹æ³•ï¼šgetArticle(1)
2. å¾—åˆ°è¿”å›å€¼ï¼šArticle{id=1, author="zhangsan", ...}
3. æ£€æŸ¥è¡¨è¾¾å¼ï¼šreturnObject.author == authentication.name
   - returnObject.author = "zhangsan"
   - authentication.name = "lisi"ï¼ˆå½“å‰ç™»å½•ç”¨æˆ·ï¼‰
4. ä¸ç›¸ç­‰ â†’ æŠ›å‡ºè®¿é—®æ‹’ç»å¼‚å¸¸
```

**ğŸ”¸ @Secured**ï¼ˆç®€å•çš„è§’è‰²æ£€æŸ¥ï¼‰

```java
@Secured("ROLE_ADMIN")  // æ³¨æ„ï¼šå¿…é¡»æœ‰ROLE_å‰ç¼€
@GetMapping("/admin/dashboard")
public String adminDashboard() {
    return "admin-dashboard";
}
```

### 6.3 SpELè¡¨è¾¾å¼


**Spring Securityæ”¯æŒçš„è¡¨è¾¾å¼**ï¼š

| è¡¨è¾¾å¼ | **å«ä¹‰** | **ç¤ºä¾‹** |
|--------|---------|---------|
| `hasRole('ADMIN')` | æœ‰æŒ‡å®šè§’è‰² | `@PreAuthorize("hasRole('ADMIN')")` |
| `hasAnyRole('ADMIN','USER')` | æœ‰ä»»ä¸€è§’è‰² | `@PreAuthorize("hasAnyRole('ADMIN','USER')")` |
| `hasAuthority('user:read')` | æœ‰æŒ‡å®šæƒé™ | `@PreAuthorize("hasAuthority('user:read')")` |
| `principal.username` | è·å–ç”¨æˆ·å | `@PreAuthorize("principal.username == 'admin')")` |
| `authentication.name` | è·å–ç”¨æˆ·åï¼ˆå¦ä¸€ç§å†™æ³•ï¼‰ | `@PreAuthorize("#username == authentication.name")` |

**å¤æ‚è¡¨è¾¾å¼ç¤ºä¾‹**ï¼š

```java
// ç»„åˆæ¡ä»¶ï¼šæœ‰ADMINè§’è‰² æˆ– æ˜¯èµ„æºæ‹¥æœ‰è€…
@PreAuthorize("hasRole('ADMIN') or #userId == principal.id")
@PutMapping("/user/{userId}")
public void updateUser(@PathVariable Long userId, @RequestBody User user) {
    userService.update(userId, user);
}

// æ–¹æ³•å‚æ•°æ£€æŸ¥
@PreAutorize("#article.author == authentication.name")
@PostMapping("/article/publish")
public void publishArticle(@RequestBody Article article) {
    articleService.publish(article);
}
```

---

## 7. ğŸ”’ URLæƒé™æ§åˆ¶


### 7.1 URLåŒ¹é…è§„åˆ™


**è·¯å¾„æ¨¡å¼åŒ¹é…**ï¼š

```java
http.authorizeHttpRequests(auth -> auth
    // ç²¾ç¡®åŒ¹é…
    .requestMatchers("/admin").hasRole("ADMIN")
    
    // è·¯å¾„åŒ¹é…ï¼š/admin/åçš„æ‰€æœ‰è·¯å¾„
    .requestMatchers("/admin/**").hasRole("ADMIN")
    
    // æ‰©å±•ååŒ¹é…
    .requestMatchers("/**/*.css", "/**/*.js").permitAll()
    
    // æ­£åˆ™åŒ¹é…
    .requestMatchers(RegexRequestMatcher.regexMatcher("/api/v[0-9]+/.*"))
        .hasRole("API_USER")
);
```

**åŒ¹é…ä¼˜å…ˆçº§**ï¼š

```
é…ç½®é¡ºåºå¾ˆé‡è¦ï¼ä»ä¸Šåˆ°ä¸‹åŒ¹é…ï¼Œå…ˆåŒ¹é…å…ˆç”Ÿæ•ˆ

ç¤ºä¾‹ï¼š
.requestMatchers("/admin/**").permitAll()      // é…ç½®1
.requestMatchers("/admin/delete").hasRole("ADMIN")  // é…ç½®2

è®¿é—® /admin/deleteï¼š
â†’ åŒ¹é…åˆ°é…ç½®1 â†’ å…è®¸æ‰€æœ‰äººè®¿é—®ï¼ˆé…ç½®2æ— æ•ˆï¼‰

æ­£ç¡®é¡ºåºï¼š
.requestMatchers("/admin/delete").hasRole("ADMIN")  // å…ˆé…ç½®å…·ä½“çš„
.requestMatchers("/admin/**").permitAll()           // å†é…ç½®é€šç”¨çš„
```

### 7.2 HTTPæ–¹æ³•é™åˆ¶


**æ ¹æ®è¯·æ±‚æ–¹æ³•æ§åˆ¶**ï¼š

```java
http.authorizeHttpRequests(auth -> auth
    // åªå¯¹POSTè¯·æ±‚é™åˆ¶
    .requestMatchers(HttpMethod.POST, "/article").hasRole("EDITOR")
    
    // GETè¯·æ±‚å…è®¸æ‰€æœ‰äºº
    .requestMatchers(HttpMethod.GET, "/article").permitAll()
    
    // DELETEè¯·æ±‚éœ€è¦ADMIN
    .requestMatchers(HttpMethod.DELETE, "/article/**").hasRole("ADMIN")
);
```

### 7.3 è‡ªå®šä¹‰è®¿é—®å†³ç­–


**å®ç°è‡ªå®šä¹‰é€»è¾‘**ï¼š

```java
@Component
public class CustomAccessDecisionManager {
    
    // è‡ªå®šä¹‰è®¿é—®åˆ¤æ–­é€»è¾‘
    public boolean check(Authentication authentication, String resource) {
        // è·å–ç”¨æˆ·æƒé™
        Collection<? extends GrantedAuthority> authorities = 
            authentication.getAuthorities();
        
        // è‡ªå®šä¹‰åˆ¤æ–­é€»è¾‘ï¼ˆå¦‚ï¼šæŸ¥æ•°æ®åº“ã€è°ƒç”¨å…¶ä»–æœåŠ¡ï¼‰
        if (resource.startsWith("/vip/")) {
            // VIPèµ„æºéœ€è¦ä¼šå‘˜æƒé™
            return authorities.stream()
                .anyMatch(auth -> auth.getAuthority().equals("VIP_MEMBER"));
        }
        
        return true;
    }
}

// åœ¨é…ç½®ä¸­ä½¿ç”¨
http.authorizeHttpRequests(auth -> auth
    .requestMatchers("/vip/**").access(
        (authentication, request) -> 
            customAccessDecisionManager.check(authentication, request.getRequestURI())
    )
);
```

---

## 8. ğŸ¯ æ–¹æ³•çº§æƒé™æ§åˆ¶


### 8.1 æ–¹æ³•çº§ vs URLçº§


**ä¸¤ç§æ–¹å¼çš„åŒºåˆ«**ï¼š

```
URLçº§æƒé™æ§åˆ¶ï¼š
âœ… æ§åˆ¶æ•´ä¸ªè¯·æ±‚è·¯å¾„
âœ… é…ç½®é›†ä¸­
âŒ ç²’åº¦ç²—

æ–¹æ³•çº§æƒé™æ§åˆ¶ï¼š
âœ… æ§åˆ¶å…·ä½“æ–¹æ³•
âœ… ç²’åº¦ç»†
âœ… æ›´çµæ´»
âŒ éœ€è¦åœ¨æ¯ä¸ªæ–¹æ³•ä¸Šé…ç½®
```

**ç»„åˆä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
// URLçº§ï¼šæ§åˆ¶è·¯å¾„è®¿é—®
http.authorizeHttpRequests(auth -> auth
    .requestMatchers("/admin/**").hasRole("ADMIN")
    .anyRequest().authenticated()
);

// æ–¹æ³•çº§ï¼šæ§åˆ¶å…·ä½“æ“ä½œ
@RestController
@RequestMapping("/admin")
public class AdminController {
    
    // è¿›ä¸€æ­¥ç»†åˆ†ï¼šåˆ é™¤ç”¨æˆ·éœ€è¦ç‰¹æ®Šæƒé™
    @PreAuthorize("hasAuthority('user:delete')")
    @DeleteMapping("/user/{id}")
    public void deleteUser(@PathVariable Long id) {
        userService.delete(id);
    }
}
```

### 8.2 Serviceå±‚æƒé™æ§åˆ¶


**ä¸ºä»€ä¹ˆåœ¨Serviceå±‚æ§åˆ¶**ï¼š

```
Controllerå±‚ vs Serviceå±‚ï¼š

Controllerå±‚æ§åˆ¶ï¼š
- ä¿æŠ¤HTTPæ¥å£
- é˜²æ­¢æœªæˆæƒè®¿é—®

Serviceå±‚æ§åˆ¶ï¼š
- ä¿æŠ¤ä¸šåŠ¡é€»è¾‘
- é˜²æ­¢å†…éƒ¨è°ƒç”¨ç»•è¿‡æƒé™
```

**Serviceå±‚åŠ æƒé™**ï¼š

```java
@Service
public class UserService {
    
    // åˆ é™¤ç”¨æˆ·ï¼šéœ€è¦æƒé™
    @PreAuthorize("hasAuthority('user:delete')")
    public void deleteUser(Long id) {
        userRepository.deleteById(id);
    }
    
    // æ‰¹é‡åˆ é™¤ï¼šéœ€è¦ADMINè§’è‰²
    @PreAuthorize("hasRole('ADMIN')")
    public void batchDelete(List<Long> ids) {
        userRepository.deleteAllById(ids);
    }
    
    // æŸ¥è¯¢ç”¨æˆ·ï¼šåªèƒ½æŸ¥è‡ªå·±æˆ–æœ‰æŸ¥è¯¢æƒé™
    @PostAuthorize("returnObject.username == authentication.name or hasAuthority('user:query:all')")
    public User getUser(Long id) {
        return userRepository.findById(id).orElse(null);
    }
}
```

### 8.3 æƒé™æ ¡éªŒå®è·µ


**å®é™…å¼€å‘å»ºè®®**ï¼š

> âœ… **æ¨èåšæ³•**

```java
// 1. Controlleråšç²—ç²’åº¦æ§åˆ¶
@PreAuthorize("hasAnyRole('ADMIN', 'MANAGER')")
@RequestMapping("/user")
public class UserController { ... }

// 2. Serviceåšç»†ç²’åº¦æ§åˆ¶  
@PreAuthorize("hasAuthority('user:delete')")
public void deleteUser(Long id) { ... }

// 3. æ•°æ®çº§æƒé™åœ¨æ–¹æ³•å†…åˆ¤æ–­
public List<Order> getOrders() {
    if (hasRole("ADMIN")) {
        return orderRepository.findAll();  // ç®¡ç†å‘˜çœ‹æ‰€æœ‰
    } else {
        return orderRepository.findByUserId(getCurrentUserId());  // æ™®é€šç”¨æˆ·çœ‹è‡ªå·±çš„
    }
}
```

---

## 9. ğŸ”§ è‡ªå®šä¹‰è®¤è¯æ–¹æ¡ˆ


### 9.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰


**é»˜è®¤æ–¹æ¡ˆçš„å±€é™**ï¼š

```
Spring Securityé»˜è®¤ï¼š
- ç”¨æˆ·åå¯†ç ç™»å½•
- Sessionä¼šè¯ç®¡ç†
- å†…å­˜æˆ–æ•°æ®åº“å­˜å‚¨

å®é™…éœ€æ±‚å¯èƒ½æ˜¯ï¼š
- æ‰‹æœºå· + éªŒè¯ç ç™»å½•
- ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆå¾®ä¿¡ã€QQï¼‰
- åŒå› ç´ è®¤è¯ï¼ˆå¯†ç +çŸ­ä¿¡ï¼‰
- å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰
```

### 9.2 æ‰‹æœºéªŒè¯ç ç™»å½•


**å®ç°æµç¨‹**ï¼š

```
æ‰‹æœºéªŒè¯ç ç™»å½•æµç¨‹ï¼š
1. ç”¨æˆ·è¾“å…¥æ‰‹æœºå· â†’ ç‚¹å‡»è·å–éªŒè¯ç 
2. åç«¯ç”ŸæˆéªŒè¯ç  â†’ å‘é€çŸ­ä¿¡ â†’ ä¿å­˜åˆ°Redisï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼‰
3. ç”¨æˆ·è¾“å…¥éªŒè¯ç  â†’ æäº¤ç™»å½•
4. åç«¯éªŒè¯ï¼š
   - æ£€æŸ¥Redisä¸­çš„éªŒè¯ç æ˜¯å¦åŒ¹é…
   - åŒ¹é…æˆåŠŸ â†’ åˆ›å»ºç”¨æˆ·ä¿¡æ¯ â†’ ç™»å½•æˆåŠŸ
   - åŒ¹é…å¤±è´¥ â†’ è¿”å›é”™è¯¯
```

**ä»£ç å®ç°**ï¼š

```java
// 1. è‡ªå®šä¹‰è®¤è¯Token
public class PhoneAuthenticationToken extends AbstractAuthenticationToken {
    
    private final String phone;
    private String code;
    
    // æœªè®¤è¯çš„Token
    public PhoneAuthenticationToken(String phone, String code) {
        super(null);
        this.phone = phone;
        this.code = code;
        setAuthenticated(false);
    }
    
    // å·²è®¤è¯çš„Token
    public PhoneAuthenticationToken(String phone, Collection<? extends GrantedAuthority> authorities) {
        super(authorities);
        this.phone = phone;
        setAuthenticated(true);
    }
    
    @Override
    public Object getCredentials() {
        return code;
    }
    
    @Override
    public Object getPrincipal() {
        return phone;
    }
}

// 2. è‡ªå®šä¹‰è®¤è¯æä¾›è€…
@Component
public class PhoneAuthenticationProvider implements AuthenticationProvider {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    @Override
    public Authentication authenticate(Authentication authentication) {
        PhoneAuthenticationToken token = (PhoneAuthenticationToken) authentication;
        
        String phone = token.getPrincipal().toString();
        String code = token.getCredentials().toString();
        
        // ä»Redisè·å–éªŒè¯ç 
        String savedCode = redisTemplate.opsForValue().get("sms:code:" + phone);
        
        if (savedCode == null || !savedCode.equals(code)) {
            throw new BadCredentialsException("éªŒè¯ç é”™è¯¯");
        }
        
        // éªŒè¯ç æ­£ç¡®ï¼ŒåŠ è½½ç”¨æˆ·ä¿¡æ¯
        UserDetails user = userDetailsService.loadUserByUsername(phone);
        
        // è¿”å›å·²è®¤è¯çš„Token
        return new PhoneAuthenticationToken(phone, user.getAuthorities());
    }
    
    @Override
    public boolean supports(Class<?> authentication) {
        return PhoneAuthenticationToken.class.isAssignableFrom(authentication);
    }
}

// 3. Controllerå¤„ç†ç™»å½•è¯·æ±‚
@RestController
public class AuthController {
    
    @Autowired
    private AuthenticationManager authenticationManager;
    
    // å‘é€éªŒè¯ç 
    @PostMapping("/sendCode")
    public void sendCode(@RequestParam String phone) {
        String code = generateCode();  // ç”Ÿæˆ6ä½éªŒè¯ç 
        
        // å‘é€çŸ­ä¿¡ï¼ˆçœç•¥ï¼‰
        smsService.send(phone, code);
        
        // ä¿å­˜åˆ°Redisï¼Œ5åˆ†é’Ÿæœ‰æ•ˆ
        redisTemplate.opsForValue().set("sms:code:" + phone, code, 5, TimeUnit.MINUTES);
    }
    
    // éªŒè¯ç ç™»å½•
    @PostMapping("/login/phone")
    public String loginByPhone(@RequestParam String phone, @RequestParam String code) {
        // åˆ›å»ºæœªè®¤è¯çš„Token
        PhoneAuthenticationToken token = new PhoneAuthenticationToken(phone, code);
        
        // è®¤è¯
        Authentication authentication = authenticationManager.authenticate(token);
        
        // è®¤è¯æˆåŠŸï¼Œè®¾ç½®åˆ°ä¸Šä¸‹æ–‡
        SecurityContextHolder.getContext().setAuthentication(authentication);
        
        return "ç™»å½•æˆåŠŸ";
    }
}
```

### 9.3 ç¬¬ä¸‰æ–¹ç™»å½•é›†æˆ


**OAuth2ç™»å½•æµç¨‹**ï¼š

```
ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆä»¥å¾®ä¿¡ä¸ºä¾‹ï¼‰ï¼š

1. ç”¨æˆ·ç‚¹å‡»"å¾®ä¿¡ç™»å½•" 
   â†“
2. è·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢
   â†“
3. ç”¨æˆ·åŒæ„æˆæƒ
   â†“
4. å¾®ä¿¡å›è°ƒæˆ‘ä»¬çš„ç³»ç»Ÿï¼Œæºå¸¦æˆæƒç ï¼ˆcodeï¼‰
   â†“
5. æˆ‘ä»¬ç”¨codeæ¢å–access_token
   â†“
6. ç”¨access_tokenè·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆopenidã€æ˜µç§°ã€å¤´åƒï¼‰
   â†“
7. æ ¹æ®openidæŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
   â†“
8. ç™»å½•æˆåŠŸ
```

**Spring Security OAuth2é…ç½®**ï¼š

```yaml
# application.yml
spring:
  security:
    oauth2:
      client:
        registration:
          wechat:
            client-id: ä½ çš„AppID
            client-secret: ä½ çš„AppSecret
            authorization-grant-type: authorization_code
            redirect-uri: http://localhost:8080/login/oauth2/code/wechat
        provider:
          wechat:
            authorization-uri: https://open.weixin.qq.com/connect/oauth2/authorize
            token-uri: https://api.weixin.qq.com/sns/oauth2/access_token
            user-info-uri: https://api.weixin.qq.com/sns/userinfo
```

```java
@Configuration
public class OAuth2LoginConfig {
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) {
        http
            .oauth2Login(oauth2 -> oauth2
                .loginPage("/login")
                .successHandler(oAuth2LoginSuccessHandler())
            );
        return http.build();
    }
    
    // ç™»å½•æˆåŠŸå¤„ç†
    @Bean
    public AuthenticationSuccessHandler oAuth2LoginSuccessHandler() {
        return (request, response, authentication) -> {
            OAuth2User oAuth2User = (OAuth2User) authentication.getPrincipal();
            
            // è·å–å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯
            String openid = oAuth2User.getAttribute("openid");
            String nickname = oAuth2User.getAttribute("nickname");
            
            // æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
            User user = userService.findOrCreateByOpenid(openid, nickname);
            
            // è·³è½¬åˆ°é¦–é¡µ
            response.sendRedirect("/");
        };
    }
}
```

> ğŸ’¡ **æç¤º**  
> Spring Bootçš„OAuth2æ”¯æŒå·²ç»å¸®æˆ‘ä»¬å¤„ç†äº†å¤§éƒ¨åˆ†å¤æ‚é€»è¾‘ï¼Œåªéœ€é…ç½®å¥½å‚æ•°å³å¯

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å…³é”®æ¦‚å¿µå›é¡¾


**ğŸ”¸ è®¤è¯ä¸æˆæƒ**
```
è®¤è¯ï¼ˆAuthenticationï¼‰= è¯æ˜ä½ æ˜¯è°
- ç”¨æˆ·åå¯†ç ç™»å½•
- æ‰‹æœºéªŒè¯ç ç™»å½•  
- ç¬¬ä¸‰æ–¹ç™»å½•
- TokenéªŒè¯

æˆæƒï¼ˆAuthorizationï¼‰= ç¡®å®šä½ èƒ½åšä»€ä¹ˆ
- åŸºäºè§’è‰²ï¼ˆROLE_ADMINï¼‰
- åŸºäºæƒé™ï¼ˆuser:deleteï¼‰
- åŸºäºURLï¼ˆ/admin/**ï¼‰
- åŸºäºæ–¹æ³•ï¼ˆ@PreAuthorizeï¼‰
```

**ğŸ”¸ æ ¸å¿ƒç»„ä»¶**

| ç»„ä»¶ | **ä½œç”¨** | **è®°å¿†è¦ç‚¹** |
|------|---------|------------|
| `SecurityFilterChain` | é…ç½®å®‰å…¨è§„åˆ™ | é…ç½®"å“ªäº›è·¯å¾„éœ€è¦ä»€ä¹ˆæƒé™" |
| `UserDetailsService` | åŠ è½½ç”¨æˆ·ä¿¡æ¯ | ä»æ•°æ®åº“æŸ¥ç”¨æˆ·å’Œæƒé™ |
| `PasswordEncoder` | å¯†ç åŠ å¯† | ç”¨BCryptï¼Œå®‰å…¨å­˜å‚¨å¯†ç  |
| `AuthenticationManager` | è®¤è¯ç®¡ç†å™¨ | è´Ÿè´£éªŒè¯ç”¨æˆ·èº«ä»½ |

### 10.2 é…ç½®æ–¹å¼å¯¹æ¯”


**URLçº§ vs æ–¹æ³•çº§**ï¼š

```
URLçº§é…ç½®ï¼ˆSecurityConfigï¼‰ï¼š
âœ… é€‚åˆï¼šæ•´ä½“è·¯å¾„ä¿æŠ¤
âœ… ç¤ºä¾‹ï¼š.requestMatchers("/admin/**").hasRole("ADMIN")
âœ… ä¼˜ç‚¹ï¼šé›†ä¸­ç®¡ç†
âŒ ç¼ºç‚¹ï¼šç²’åº¦ç²—

æ–¹æ³•çº§æ³¨è§£ï¼š
âœ… é€‚åˆï¼šç»†ç²’åº¦æ§åˆ¶
âœ… ç¤ºä¾‹ï¼š@PreAuthorize("hasAuthority('user:delete')")
âœ… ä¼˜ç‚¹ï¼šçµæ´»ç²¾ç¡®
âŒ ç¼ºç‚¹ï¼šåˆ†æ•£åœ¨å„å¤„

ğŸ’¡ æœ€ä½³å®è·µï¼šä¸¤è€…ç»“åˆä½¿ç”¨
- URLçº§åšç¬¬ä¸€é“é˜²çº¿
- æ–¹æ³•çº§åšç²¾ç»†æ§åˆ¶
```

### 10.3 å¸¸è§é—®é¢˜è§£å†³


**â“ é—®é¢˜1ï¼šé…ç½®äº†æƒé™ä½†ä¸ç”Ÿæ•ˆ**

```java
// åŸå› ï¼šå¿˜è®°å¼€å¯æ–¹æ³•çº§å®‰å…¨
@Configuration
@EnableMethodSecurity  // â† ä¸€å®šè¦åŠ è¿™ä¸ªï¼
public class SecurityConfig { ... }
```

**â“ é—®é¢˜2ï¼šè§’è‰²åç§°ä¸åŒ¹é…**

```java
// é”™è¯¯å†™æ³•
.hasRole("ROLE_ADMIN")  // âŒ ä¸è¦åŠ ROLE_å‰ç¼€

// æ­£ç¡®å†™æ³•
.hasRole("ADMIN")       // âœ… Spring Securityè‡ªåŠ¨åŠ å‰ç¼€
```

**â“ é—®é¢˜3ï¼šå¯†ç è®¤è¯å¤±è´¥**

```java
// æ³¨å†Œæ—¶è¦åŠ å¯†
String encrypted = passwordEncoder.encode(password);

// æ•°æ®åº“å­˜çš„æ˜¯åŠ å¯†åçš„å¯†ç 
user.setPassword(encrypted);

// ç™»å½•æ—¶Spring Securityè‡ªåŠ¨è§£å¯†æ¯”å¯¹ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
```

### 10.4 å­¦ä¹ è·¯çº¿å»ºè®®


**ğŸ“ˆ è¿›é˜¶å­¦ä¹ è·¯å¾„**ï¼š

1ï¸âƒ£ **åŸºç¡€é˜¶æ®µ**ï¼ˆå·²æŒæ¡ï¼‰
- [x] ç†è§£è®¤è¯ä¸æˆæƒæ¦‚å¿µ
- [x] é…ç½®åŸºæœ¬çš„ç”¨æˆ·åå¯†ç ç™»å½•
- [x] ä½¿ç”¨è§’è‰²æ§åˆ¶è®¿é—®

2ï¸âƒ£ **è¿›é˜¶é˜¶æ®µ**ï¼ˆæ·±å…¥å­¦ä¹ ï¼‰
- [ ] è‡ªå®šä¹‰è®¤è¯é€»è¾‘ï¼ˆæ‰‹æœºéªŒè¯ç ï¼‰
- [ ] é›†æˆç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆOAuth2ï¼‰
- [ ] å®ç°JWT Tokenè®¤è¯

3ï¸âƒ£ **é«˜çº§é˜¶æ®µ**ï¼ˆé¡¹ç›®å®æˆ˜ï¼‰
- [ ] åŠ¨æ€æƒé™ç®¡ç†ï¼ˆæ•°æ®åº“é…ç½®æƒé™ï¼‰
- [ ] å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰
- [ ] åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†ï¼ˆRedisï¼‰

> ğŸ’¡ **å­¦ä¹ å»ºè®®**  
> - å…ˆæŒæ¡åŸºç¡€çš„ç”¨æˆ·åå¯†ç è®¤è¯  
> - ç†è§£è§’è‰²å’Œæƒé™çš„åŒºåˆ«  
> - å¤šå†™ä»£ç å¤šå®è·µï¼Œæƒé™æ§åˆ¶è¦åœ¨é¡¹ç›®ä¸­æ‰èƒ½æ·±åˆ»ç†è§£

### 10.5 å®æˆ˜æ£€æŸ¥æ¸…å•


**âœ… é¡¹ç›®ä¸­çš„æƒé™æ§åˆ¶æ£€æŸ¥**

- [ ] æ‰€æœ‰æ•æ„Ÿæ¥å£éƒ½åŠ äº†æƒé™æ§åˆ¶
- [ ] å¯†ç ä½¿ç”¨BCryptç­‰å®‰å…¨ç®—æ³•åŠ å¯†
- [ ] ä¸åœ¨å‰ç«¯åšæƒé™åˆ¤æ–­ï¼ˆå‰ç«¯åªæ˜¯è¾…åŠ©å±•ç¤ºï¼‰
- [ ] é‡è¦æ“ä½œä½¿ç”¨æ–¹æ³•çº§æƒé™åŒé‡ä¿æŠ¤
- [ ] é…ç½®äº†åˆç†çš„ä¼šè¯è¶…æ—¶æ—¶é—´
- [ ] å¤„ç†äº†æƒé™ä¸è¶³çš„å‹å¥½æç¤º

**è®°å¿†å£è¯€**ï¼š
```
è®¤è¯æˆæƒè¦åˆ†æ¸…ï¼Œä¸€ä¸ªèº«ä»½ä¸€ä¸ªè¡Œ
è§’è‰²æƒé™ä¸¤æŠŠåˆ€ï¼Œç²—ç»†ç»“åˆç”¨å¾—å¦™
URLæ–¹æ³•åŒä¿é™©ï¼Œå‰ç«¯å±•ç¤ºåç«¯ç®¡
å¯†ç åŠ å¯†è¦è®°ç‰¢ï¼Œå®‰å…¨ç¬¬ä¸€ä¸èƒ½å°‘
```