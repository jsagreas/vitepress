---
title: 2ã€Spring MVCé›†æˆæµ‹è¯•
---
## ğŸ“š ç›®å½•

1. [é›†æˆæµ‹è¯•åŸºç¡€æ¦‚å¿µ](#1-é›†æˆæµ‹è¯•åŸºç¡€æ¦‚å¿µ)
2. [@SpringBootTestæ³¨è§£è¯¦è§£](#2-springboottestæ³¨è§£è¯¦è§£)
3. [TestRestTemplateä½¿ç”¨æŒ‡å—](#3-testresttemplateä½¿ç”¨æŒ‡å—)
4. [å®Œæ•´åº”ç”¨æµ‹è¯•å®æˆ˜](#4-å®Œæ•´åº”ç”¨æµ‹è¯•å®æˆ˜)
5. [æ•°æ®åº“æµ‹è¯•ç­–ç•¥](#5-æ•°æ®åº“æµ‹è¯•ç­–ç•¥)
6. [äº‹åŠ¡æµ‹è¯•å¤„ç†](#6-äº‹åŠ¡æµ‹è¯•å¤„ç†)
7. [é…ç½®æµ‹è¯•æ–¹æ¡ˆ](#7-é…ç½®æµ‹è¯•æ–¹æ¡ˆ)
8. [ç¯å¢ƒéš”ç¦»ä¸æµ‹è¯•æ•°æ®å‡†å¤‡](#8-ç¯å¢ƒéš”ç¦»ä¸æµ‹è¯•æ•°æ®å‡†å¤‡)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ é›†æˆæµ‹è¯•åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯é›†æˆæµ‹è¯•


**é€šä¿—ç†è§£**ï¼šé›†æˆæµ‹è¯•å°±åƒæ˜¯ç»™ä½ çš„æ•´ä¸ªåº”ç”¨ç¨‹åºåšä¸€æ¬¡"å…¨é¢ä½“æ£€"ã€‚

```
å•å…ƒæµ‹è¯•ï¼šåªæµ‹ä¸€ä¸ªç±»æˆ–æ–¹æ³•ï¼ˆåƒæ£€æŸ¥ä¸€ä¸ªé›¶ä»¶ï¼‰
é›†æˆæµ‹è¯•ï¼šæµ‹è¯•å¤šä¸ªç»„ä»¶ååŒå·¥ä½œï¼ˆåƒæµ‹è¯•æ•´å°æœºå™¨è¿è½¬ï¼‰
```

**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
é›†æˆæµ‹è¯•ï¼ˆIntegration Testingï¼‰ï¼š
æµ‹è¯•å¤šä¸ªç»„ä»¶ã€æ¨¡å—ååŒå·¥ä½œçš„æƒ…å†µ
ç›®çš„ï¼šéªŒè¯ä¸åŒéƒ¨åˆ†ç»„åˆåèƒ½å¦æ­£å¸¸è¿è¡Œ
ç‰¹ç‚¹ï¼šæ¶‰åŠæ•°æ®åº“ã€ç½‘ç»œã€å¤–éƒ¨æœåŠ¡ç­‰çœŸå®ç¯å¢ƒ
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦é›†æˆæµ‹è¯•


**å®é™…åœºæ™¯å¯¹æ¯”**ï¼š

| æµ‹è¯•ç±»å‹ | **æµ‹è¯•èŒƒå›´** | **å‘ç°é—®é¢˜** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|------------|------------|
| ğŸ”¸ **å•å…ƒæµ‹è¯•** | `å•ä¸ªç±»/æ–¹æ³•` | `é€»è¾‘é”™è¯¯` | `éªŒè¯ä»£ç é€»è¾‘` |
| ğŸ”¸ **é›†æˆæµ‹è¯•** | `å¤šä¸ªç»„ä»¶åä½œ` | `æ¥å£å¯¹æ¥é—®é¢˜` | `éªŒè¯åŠŸèƒ½æµç¨‹` |
| ğŸ”¸ **ç«¯åˆ°ç«¯æµ‹è¯•** | `æ•´ä¸ªç³»ç»Ÿ` | `ç”¨æˆ·ä½“éªŒé—®é¢˜` | `æ¨¡æ‹ŸçœŸå®æ“ä½œ` |

**ğŸ’¡ é€šä¿—ä¸¾ä¾‹**
```
åšèœçš„è¿‡ç¨‹ï¼š
å•å…ƒæµ‹è¯• = æ£€æŸ¥æ¯ä¸ªé£Ÿææ˜¯å¦æ–°é²œ
é›†æˆæµ‹è¯• = æ£€æŸ¥é£Ÿææ­é…åå‘³é“å¦‚ä½•
ç«¯åˆ°ç«¯æµ‹è¯• = æ£€æŸ¥æ•´é“èœä¸Šæ¡Œåå®¢äººæ˜¯å¦æ»¡æ„
```

### 1.3 é›†æˆæµ‹è¯•çš„æµ‹è¯•å±‚æ¬¡


**ğŸ—ï¸ æµ‹è¯•é‡‘å­—å¡”**
```
           /\
          /  \  ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆå°‘é‡ï¼‰
         /â”€â”€â”€â”€\
        /      \  é›†æˆæµ‹è¯•ï¼ˆé€‚é‡ï¼‰
       /â”€â”€â”€â”€â”€â”€â”€â”€\
      /          \  å•å…ƒæµ‹è¯•ï¼ˆå¤§é‡ï¼‰
     /____________\

åŸåˆ™ï¼šåº•å±‚æµ‹è¯•å¤šï¼Œä¸Šå±‚æµ‹è¯•å°‘
åŸå› ï¼šå•å…ƒæµ‹è¯•å¿«é€Ÿã€ä¾¿å®œï¼Œé›†æˆæµ‹è¯•è¾ƒæ…¢ã€æˆæœ¬é«˜
```

---

## 2. ğŸ“‹ @SpringBootTestæ³¨è§£è¯¦è§£


### 2.1 @SpringBootTestçš„ä½œç”¨


**ğŸ”¸ æ ¸å¿ƒåŠŸèƒ½**
```
@SpringBootTestçš„ä½œç”¨ï¼š
1. å¯åŠ¨å®Œæ•´çš„Springåº”ç”¨ä¸Šä¸‹æ–‡
2. åŠ è½½æ‰€æœ‰é…ç½®å’ŒBean
3. æ¨¡æ‹ŸçœŸå®è¿è¡Œç¯å¢ƒ
4. æ”¯æŒä¾èµ–æ³¨å…¥

ç®€å•è¯´ï¼šè®©æµ‹è¯•ç¯å¢ƒå’ŒçœŸå®ç¯å¢ƒä¸€æ¨¡ä¸€æ ·
```

**ğŸ’¡ ä¸æ™®é€šæµ‹è¯•çš„åŒºåˆ«**
```java
// æ™®é€šå•å…ƒæµ‹è¯•ï¼ˆä¸å¯åŠ¨Springå®¹å™¨ï¼‰
public class UserServiceTest {
    private UserService userService = new UserService();
}

// é›†æˆæµ‹è¯•ï¼ˆå¯åŠ¨å®Œæ•´Springå®¹å™¨ï¼‰
@SpringBootTest
public class UserServiceIntegrationTest {
    @Autowired  // å¯ä»¥æ³¨å…¥çœŸå®çš„Bean
    private UserService userService;
}
```

### 2.2 @SpringBootTestçš„å¸¸ç”¨å±æ€§


**ğŸ”§ æ ¸å¿ƒé…ç½®å±æ€§**

| å±æ€§ | **å«ä¹‰** | **ç¤ºä¾‹** | **ä½¿ç”¨åœºæ™¯** |
|------|---------|---------|-------------|
| `webEnvironment` | `Webç¯å¢ƒæ¨¡å¼` | `RANDOM_PORT` | `æµ‹è¯•HTTPæ¥å£` |
| `classes` | `æŒ‡å®šé…ç½®ç±»` | `{AppConfig.class}` | `è‡ªå®šä¹‰é…ç½®` |
| `properties` | `ä¸´æ—¶é…ç½®` | `"app.name=test"` | `è¦†ç›–é…ç½®å€¼` |

**ğŸŸ¢ åŸºç¡€ç”¨æ³•ç¤ºä¾‹**
```java
// æœ€ç®€å•çš„ç”¨æ³•
@SpringBootTest
class SimpleTest {
    @Autowired
    private UserService userService;
}
```

### 2.3 webEnvironmentè¯¦è§£


**ğŸŒ Webç¯å¢ƒé…ç½®é€‰é¡¹**

```java
// 1. MOCKï¼ˆé»˜è®¤ï¼‰- æ¨¡æ‹ŸWebç¯å¢ƒï¼Œä¸å¯åŠ¨çœŸå®æœåŠ¡å™¨
@SpringBootTest(webEnvironment = WebEnvironment.MOCK)

// 2. RANDOM_PORT - å¯åŠ¨çœŸå®æœåŠ¡å™¨ï¼Œéšæœºç«¯å£
@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)

// 3. DEFINED_PORT - å¯åŠ¨çœŸå®æœåŠ¡å™¨ï¼Œä½¿ç”¨é…ç½®çš„ç«¯å£
@SpringBootTest(webEnvironment = WebEnvironment.DEFINED_PORT)

// 4. NONE - ä¸å¯åŠ¨Webç¯å¢ƒ
@SpringBootTest(webEnvironment = WebEnvironment.NONE)
```

**ğŸ”¸ å¦‚ä½•é€‰æ‹©Webç¯å¢ƒ**
```
MOCKï¼šæµ‹è¯•Controlleré€»è¾‘ï¼Œä¸éœ€è¦çœŸå®HTTPè¯·æ±‚
RANDOM_PORTï¼šæµ‹è¯•å®Œæ•´HTTPæµç¨‹ï¼Œé¿å…ç«¯å£å†²çª â­æ¨è
DEFINED_PORTï¼šéœ€è¦å›ºå®šç«¯å£ï¼ˆå¦‚å¯¹æ¥ç¬¬ä¸‰æ–¹ï¼‰
NONEï¼šçº¯ä¸šåŠ¡é€»è¾‘æµ‹è¯•ï¼Œæ— WebåŠŸèƒ½
```

---

## 3. ğŸš€ TestRestTemplateä½¿ç”¨æŒ‡å—


### 3.1 TestRestTemplateæ˜¯ä»€ä¹ˆ


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
TestRestTemplateï¼šSpringæä¾›çš„HTTPå®¢æˆ·ç«¯å·¥å…·
ä½œç”¨ï¼šåœ¨æµ‹è¯•ä¸­å‘é€HTTPè¯·æ±‚ï¼Œè·å–å“åº”
ç‰¹ç‚¹ï¼šä¸“ä¸ºæµ‹è¯•è®¾è®¡ï¼Œä½¿ç”¨ç®€å•

ç±»æ¯”ç†è§£ï¼š
RestTemplate = ç”Ÿäº§ç¯å¢ƒçš„HTTPå·¥å…·
TestRestTemplate = æµ‹è¯•ç¯å¢ƒçš„HTTPå·¥å…·ï¼ˆæ›´å¥½ç”¨ï¼‰
```

**ğŸ’¡ ä¸RestTemplateçš„åŒºåˆ«**

| ç‰¹æ€§ | **RestTemplate** | **TestRestTemplate** |
|------|-----------------|---------------------|
| ğŸ”¸ **ä½¿ç”¨ç¯å¢ƒ** | `ç”Ÿäº§ä»£ç ` | `æµ‹è¯•ä»£ç ` |
| ğŸ”¸ **å¼‚å¸¸å¤„ç†** | `æŠ›å‡ºå¼‚å¸¸` | `è¿”å›é”™è¯¯ä¹Ÿå½“æ­£å¸¸` |
| ğŸ”¸ **é…ç½®éš¾åº¦** | `éœ€è¦æ‰‹åŠ¨é…ç½®` | `è‡ªåŠ¨é…ç½®` |

### 3.2 TestRestTemplateåŸºæœ¬ä½¿ç”¨


**ğŸ”§ æ³¨å…¥å’Œé…ç½®**
```java
@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)
class UserControllerTest {
    
    @Autowired
    private TestRestTemplate restTemplate; // è‡ªåŠ¨æ³¨å…¥
    
    @LocalServerPort  // è·å–éšæœºç«¯å£å·
    private int port;
}
```

**ğŸŸ¡ å¸¸ç”¨HTTPæ–¹æ³•**
```java
// GETè¯·æ±‚
String url = "http://localhost:" + port + "/api/users/1";
User user = restTemplate.getForObject(url, User.class);

// POSTè¯·æ±‚
User newUser = new User("å¼ ä¸‰", 25);
User created = restTemplate.postForObject(url, newUser, User.class);

// PUTè¯·æ±‚
restTemplate.put(url + "/1", updatedUser);

// DELETEè¯·æ±‚
restTemplate.delete(url + "/1");
```

### 3.3 è·å–å“åº”è¯¦ç»†ä¿¡æ¯


**ğŸ”¸ ä½¿ç”¨ResponseEntityè·å–å®Œæ•´å“åº”**
```java
// è·å–å“åº”çŠ¶æ€ç ã€å¤´ä¿¡æ¯ã€å“åº”ä½“
ResponseEntity<User> response = 
    restTemplate.getForEntity("/api/users/1", User.class);

// æ£€æŸ¥çŠ¶æ€ç 
assertEquals(200, response.getStatusCodeValue());

// è·å–å“åº”ä½“
User user = response.getBody();

// è·å–å“åº”å¤´
String contentType = response.getHeaders()
    .getContentType().toString();
```

**âš¡ å®ç”¨æŠ€å·§**
```java
// å¸¦æŸ¥è¯¢å‚æ•°çš„GETè¯·æ±‚
String url = "/api/users?name={name}&age={age}";
User[] users = restTemplate.getForObject(url, User[].class, 
    "å¼ ä¸‰", 25);

// å¸¦è¯·æ±‚å¤´çš„POSTè¯·æ±‚
HttpHeaders headers = new HttpHeaders();
headers.set("Authorization", "Bearer token123");
HttpEntity<User> request = new HttpEntity<>(newUser, headers);

ResponseEntity<User> response = 
    restTemplate.postForEntity(url, request, User.class);
```

---

## 4. ğŸ§ª å®Œæ•´åº”ç”¨æµ‹è¯•å®æˆ˜


### 4.1 Controllerå±‚å®Œæ•´æµ‹è¯•


**ğŸ¯ æµ‹è¯•ç›®æ ‡ï¼šéªŒè¯HTTPæ¥å£åŠŸèƒ½**

```java
@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)
class UserControllerIntegrationTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Test
    void æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯() {
        // å‘é€è¯·æ±‚
        ResponseEntity<User> response = 
            restTemplate.getForEntity("/api/users/1", User.class);
        
        // éªŒè¯çŠ¶æ€ç 
        assertEquals(HttpStatus.OK, response.getStatusCode());
        
        // éªŒè¯å“åº”æ•°æ®
        User user = response.getBody();
        assertNotNull(user);
        assertEquals("å¼ ä¸‰", user.getName());
    }
    
    @Test
    void æµ‹è¯•åˆ›å»ºç”¨æˆ·() {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        User newUser = new User();
        newUser.setName("æå››");
        newUser.setAge(30);
        
        // å‘é€POSTè¯·æ±‚
        ResponseEntity<User> response = 
            restTemplate.postForEntity("/api/users", newUser, User.class);
        
        // éªŒè¯åˆ›å»ºæˆåŠŸ
        assertEquals(HttpStatus.CREATED, response.getStatusCode());
        assertNotNull(response.getBody().getId());
    }
}
```

### 4.2 Serviceå±‚é›†æˆæµ‹è¯•


**ğŸ”¸ æµ‹è¯•Serviceä¸æ•°æ®åº“äº¤äº’**
```java
@SpringBootTest
@Transactional  // è‡ªåŠ¨å›æ»šï¼Œä¸æ±¡æŸ“æ•°æ®åº“
class UserServiceIntegrationTest {
    
    @Autowired
    private UserService userService;
    
    @Test
    void æµ‹è¯•ä¿å­˜ç”¨æˆ·() {
        // åˆ›å»ºç”¨æˆ·
        User user = new User("ç‹äº”", 28);
        User saved = userService.save(user);
        
        // éªŒè¯ä¿å­˜æˆåŠŸ
        assertNotNull(saved.getId());
        
        // éªŒè¯å¯ä»¥æŸ¥è¯¢åˆ°
        User found = userService.findById(saved.getId());
        assertEquals("ç‹äº”", found.getName());
    }
}
```

### 4.3 å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•


**ğŸ”„ ç«¯åˆ°ç«¯ä¸šåŠ¡æµç¨‹ç¤ºä¾‹**
```java
@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)
class OrderProcessTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Test
    void æµ‹è¯•å®Œæ•´ä¸‹å•æµç¨‹() {
        // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
        Order order = new Order();
        order.setProductId(100L);
        order.setQuantity(2);
        
        ResponseEntity<Order> createResponse = 
            restTemplate.postForEntity("/api/orders", order, Order.class);
        assertEquals(HttpStatus.CREATED, createResponse.getStatusCode());
        
        // æ­¥éª¤2ï¼šæ”¯ä»˜è®¢å•
        Long orderId = createResponse.getBody().getId();
        ResponseEntity<String> payResponse = 
            restTemplate.postForEntity(
                "/api/orders/" + orderId + "/pay", 
                null, 
                String.class
            );
        assertEquals(HttpStatus.OK, payResponse.getStatusCode());
        
        // æ­¥éª¤3ï¼šæŸ¥è¯¢è®¢å•çŠ¶æ€
        ResponseEntity<Order> queryResponse = 
            restTemplate.getForEntity(
                "/api/orders/" + orderId, 
                Order.class
            );
        assertEquals("PAID", queryResponse.getBody().getStatus());
    }
}
```

---

## 5. ğŸ’¾ æ•°æ®åº“æµ‹è¯•ç­–ç•¥


### 5.1 æ•°æ®åº“æµ‹è¯•çš„æŒ‘æˆ˜


**ğŸ”¸ å¸¸è§é—®é¢˜**
```
é—®é¢˜1ï¼šæµ‹è¯•æ•°æ®æ±¡æŸ“æ•°æ®åº“
é—®é¢˜2ï¼šæµ‹è¯•ä¹‹é—´äº’ç›¸å½±å“
é—®é¢˜3ï¼šæ•°æ®åº“çŠ¶æ€ä¸ç¡®å®š
é—®é¢˜4ï¼šæµ‹è¯•é€Ÿåº¦æ…¢

è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨æµ‹è¯•ä¸“ç”¨ç­–ç•¥
```

### 5.2 ä½¿ç”¨æµ‹è¯•æ•°æ®åº“


**ğŸŸ¢ é…ç½®æµ‹è¯•ä¸“ç”¨æ•°æ®åº“**
```properties
# src/test/resources/application.properties
# ä½¿ç”¨H2å†…å­˜æ•°æ®åº“ï¼ˆå¿«é€Ÿã€éš”ç¦»ï¼‰
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driver-class-name=org.h2.Driver
spring.jpa.database-platform=org.hibernate.dialect.H2Dialect

# æ¯æ¬¡å¯åŠ¨åˆ›å»ºè¡¨ç»“æ„
spring.jpa.hibernate.ddl-auto=create-drop
```

**ğŸ’¡ ä¸ºä»€ä¹ˆç”¨H2æ•°æ®åº“**
```
H2æ•°æ®åº“ä¼˜åŠ¿ï¼š
âœ… å†…å­˜æ•°æ®åº“ï¼Œé€Ÿåº¦æå¿«
âœ… æµ‹è¯•ç»“æŸè‡ªåŠ¨æ¸…ç©º
âœ… ä¸å½±å“å¼€å‘/ç”Ÿäº§æ•°æ®åº“
âœ… æ— éœ€å®‰è£…ï¼Œå¼€ç®±å³ç”¨

é€‚ç”¨åœºæ™¯ï¼šå¤§éƒ¨åˆ†é›†æˆæµ‹è¯•
ä¸é€‚ç”¨ï¼šæµ‹è¯•ç‰¹å®šæ•°æ®åº“ç‰¹æ€§ï¼ˆå¦‚MySQLçš„JSONå­—æ®µï¼‰
```

### 5.3 ä½¿ç”¨@Sqlæ³¨è§£å‡†å¤‡æ•°æ®


**ğŸ”§ è‡ªåŠ¨æ‰§è¡ŒSQLè„šæœ¬**
```java
@SpringBootTest
@Sql("/test-data.sql")  // æµ‹è¯•å‰æ‰§è¡ŒSQLè„šæœ¬
class ProductRepositoryTest {
    
    @Autowired
    private ProductRepository productRepository;
    
    @Test
    void æµ‹è¯•æŸ¥è¯¢äº§å“() {
        // test-data.sqlå·²ç»æ’å…¥äº†æµ‹è¯•æ•°æ®
        List<Product> products = productRepository.findAll();
        assertEquals(5, products.size());
    }
}
```

**ğŸ“„ SQLè„šæœ¬ç¤ºä¾‹ï¼ˆtest-data.sqlï¼‰**
```sql
-- æ¸…ç©ºè¡¨
DELETE FROM products;

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO products (id, name, price) VALUES (1, 'å•†å“A', 99.9);
INSERT INTO products (id, name, price) VALUES (2, 'å•†å“B', 199.9);
```

---

## 6. ğŸ”„ äº‹åŠ¡æµ‹è¯•å¤„ç†


### 6.1 @Transactionalçš„ä½œç”¨


**ğŸ”¸ è‡ªåŠ¨å›æ»šæœºåˆ¶**
```
@Transactionalåœ¨æµ‹è¯•ç±»ä¸Šçš„ä½œç”¨ï¼š
1. æ¯ä¸ªæµ‹è¯•æ–¹æ³•è‡ªåŠ¨å¼€å¯äº‹åŠ¡
2. æµ‹è¯•ç»“æŸè‡ªåŠ¨å›æ»šäº‹åŠ¡
3. æ•°æ®åº“æ¢å¤åˆ°æµ‹è¯•å‰çš„çŠ¶æ€

å¥½å¤„ï¼šæµ‹è¯•ä¹‹é—´ä¸ä¼šäº’ç›¸å½±å“
```

**ğŸŸ¡ ä½¿ç”¨ç¤ºä¾‹**
```java
@SpringBootTest
@Transactional  // å…³é”®æ³¨è§£
class UserRepositoryTest {
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    void æµ‹è¯•ä¿å­˜ç”¨æˆ·() {
        User user = new User("æµ‹è¯•ç”¨æˆ·", 20);
        userRepository.save(user);
        
        // æµ‹è¯•ç»“æŸåï¼Œè¿™æ¡æ•°æ®ä¼šè‡ªåŠ¨åˆ é™¤ï¼ˆå›æ»šï¼‰
        assertEquals(1, userRepository.count());
    }
    
    @Test
    void å¦ä¸€ä¸ªæµ‹è¯•() {
        // ä¸ä¼šçœ‹åˆ°ä¸Šä¸ªæµ‹è¯•çš„æ•°æ®ï¼Œå› ä¸ºå·²ç»å›æ»š
        assertEquals(0, userRepository.count());
    }
}
```

### 6.2 æµ‹è¯•äº‹åŠ¡ä¼ æ’­è¡Œä¸º


**ğŸ”¸ æµ‹è¯•Serviceçš„äº‹åŠ¡é…ç½®**
```java
@SpringBootTest
class TransactionTest {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    @Transactional
    void æµ‹è¯•äº‹åŠ¡å›æ»š() {
        try {
            // è¿™ä¸ªæ–¹æ³•å†…éƒ¨ä¼šæŠ›å¼‚å¸¸
            userService.saveUserWithError();
        } catch (Exception e) {
            // å¼‚å¸¸è¢«æ•è·
        }
        
        // éªŒè¯äº‹åŠ¡å·²å›æ»šï¼Œæ•°æ®æœªä¿å­˜
        assertEquals(0, userRepository.count());
    }
}
```

### 6.3 ä¸å›æ»šçš„æµ‹è¯•åœºæ™¯


**âš ï¸ æŸäº›æƒ…å†µéœ€è¦ä¿ç•™æ•°æ®**
```java
@SpringBootTest
class NoRollbackTest {
    
    @Test
    @Transactional
    @Rollback(false)  // ä¸å›æ»š
    void æµ‹è¯•å¹¶ä¿ç•™æ•°æ®() {
        // è¿™ä¸ªæµ‹è¯•çš„æ•°æ®ä¼šçœŸå®ä¿å­˜
        // é€‚ç”¨äºï¼šå‡†å¤‡æ¼”ç¤ºæ•°æ®ã€æµ‹è¯•æ•°æ®è¿ç§»ç­‰
    }
}
```

---

## 7. âš™ï¸ é…ç½®æµ‹è¯•æ–¹æ¡ˆ


### 7.1 ä½¿ç”¨@TestPropertySource


**ğŸ”¸ ä¸´æ—¶è¦†ç›–é…ç½®**
```java
@SpringBootTest
@TestPropertySource(properties = {
    "app.name=æµ‹è¯•åº”ç”¨",
    "app.version=1.0-test",
    "logging.level.root=DEBUG"
})
class ConfigTest {
    
    @Value("${app.name}")
    private String appName;
    
    @Test
    void æµ‹è¯•é…ç½®è¦†ç›–() {
        assertEquals("æµ‹è¯•åº”ç”¨", appName);
    }
}
```

**ğŸ’¡ ä½¿ç”¨åœºæ™¯**
```
é€‚åˆï¼šä¸´æ—¶ä¿®æ”¹å°‘é‡é…ç½®
ä¸é€‚åˆï¼šå¤§é‡é…ç½®ä¿®æ”¹ï¼ˆç”¨ä¸“é—¨çš„é…ç½®æ–‡ä»¶ï¼‰
```

### 7.2 ä½¿ç”¨æµ‹è¯•ä¸“ç”¨é…ç½®æ–‡ä»¶


**ğŸ“ åˆ›å»ºæµ‹è¯•é…ç½®**
```
src/test/resources/application-test.properties
```

```properties
# æµ‹è¯•ä¸“ç”¨é…ç½®
spring.datasource.url=jdbc:h2:mem:testdb
spring.jpa.show-sql=true
logging.level.root=INFO
```

**ğŸ”§ æ¿€æ´»æµ‹è¯•é…ç½®**
```java
@SpringBootTest
@ActiveProfiles("test")  // æ¿€æ´»testé…ç½®
class ConfigFileTest {
    // è‡ªåŠ¨ä½¿ç”¨application-test.properties
}
```

### 7.3 @TestConfigurationè‡ªå®šä¹‰é…ç½®


**ğŸ”¸ åˆ›å»ºæµ‹è¯•ä¸“ç”¨Bean**
```java
@TestConfiguration
class TestConfig {
    
    @Bean
    @Primary  // ä¼˜å…ˆä½¿ç”¨æµ‹è¯•Bean
    public EmailService emailService() {
        return new FakeEmailService(); // å‡çš„é‚®ä»¶æœåŠ¡
    }
}

@SpringBootTest
@Import(TestConfig.class)  // å¯¼å…¥æµ‹è¯•é…ç½®
class EmailTest {
    
    @Autowired
    private EmailService emailService;
    
    @Test
    void æµ‹è¯•å‘é€é‚®ä»¶() {
        // ä½¿ç”¨å‡çš„é‚®ä»¶æœåŠ¡ï¼Œä¸ä¼šçœŸçš„å‘é‚®ä»¶
        emailService.send("test@example.com", "æµ‹è¯•");
    }
}
```

---

## 8. ğŸ”’ ç¯å¢ƒéš”ç¦»ä¸æµ‹è¯•æ•°æ®å‡†å¤‡


### 8.1 ç¯å¢ƒéš”ç¦»ç­–ç•¥


**ğŸ—ï¸ æµ‹è¯•ç¯å¢ƒæ¶æ„**
```
å¼€å‘ç¯å¢ƒ â”€â”€â†’ å¼€å‘æ•°æ®åº“ï¼ˆçœŸå®æ•°æ®ï¼‰
    â†“
æµ‹è¯•ç¯å¢ƒ â”€â”€â†’ æµ‹è¯•æ•°æ®åº“ï¼ˆéš”ç¦»æ•°æ®ï¼‰
    â†“
ç”Ÿäº§ç¯å¢ƒ â”€â”€â†’ ç”Ÿäº§æ•°æ®åº“ï¼ˆç”¨æˆ·æ•°æ®ï¼‰

éš”ç¦»åŸåˆ™ï¼š
âœ… æµ‹è¯•ç”¨H2å†…å­˜æ•°æ®åº“
âœ… æµ‹è¯•é…ç½®ä¸ç”Ÿäº§åˆ†ç¦»
âœ… æµ‹è¯•æ•°æ®è‡ªåŠ¨æ¸…ç†
```

**ğŸ”¸ é…ç½®æ–‡ä»¶éš”ç¦»**
```
src/main/resources/
  â”œâ”€â”€ application.properties          # é»˜è®¤é…ç½®
  â””â”€â”€ application-prod.properties     # ç”Ÿäº§é…ç½®

src/test/resources/
  â””â”€â”€ application.properties          # æµ‹è¯•é…ç½®ï¼ˆä¼˜å…ˆçº§é«˜ï¼‰
```

### 8.2 æµ‹è¯•æ•°æ®å‡†å¤‡ç­–ç•¥


**ğŸŸ¢ æ–¹æ¡ˆ1ï¼šSQLè„šæœ¬å‡†å¤‡æ•°æ®**
```java
@Sql(scripts = {
    "/schema.sql",      // å»ºè¡¨
    "/test-data.sql"    // æ’å…¥æ•°æ®
})
class DataPrepareTest {
    // æµ‹è¯•å‰è‡ªåŠ¨æ‰§è¡ŒSQL
}
```

**ğŸŸ¡ æ–¹æ¡ˆ2ï¼šä»£ç å‡†å¤‡æ•°æ®**
```java
@SpringBootTest
class DataPrepareTest {
    
    @Autowired
    private UserRepository userRepository;
    
    @BeforeEach
    void å‡†å¤‡æµ‹è¯•æ•°æ®() {
        // æ¯ä¸ªæµ‹è¯•å‰æ‰§è¡Œ
        userRepository.deleteAll();
        userRepository.save(new User("æµ‹è¯•ç”¨æˆ·1", 20));
        userRepository.save(new User("æµ‹è¯•ç”¨æˆ·2", 25));
    }
    
    @Test
    void æµ‹è¯•æŸ¥è¯¢() {
        assertEquals(2, userRepository.count());
    }
}
```

**ğŸ”´ æ–¹æ¡ˆ3ï¼šä½¿ç”¨æµ‹è¯•æ•°æ®å·¥å‚**
```java
// åˆ›å»ºæµ‹è¯•æ•°æ®å·¥å‚ç±»
class TestDataFactory {
    
    public static User createUser(String name, int age) {
        User user = new User();
        user.setName(name);
        user.setAge(age);
        user.setEmail(name + "@test.com");
        return user;
    }
    
    public static List<User> createUsers(int count) {
        List<User> users = new ArrayList<>();
        for (int i = 1; i <= count; i++) {
            users.add(createUser("ç”¨æˆ·" + i, 20 + i));
        }
        return users;
    }
}

// åœ¨æµ‹è¯•ä¸­ä½¿ç”¨
@Test
void æµ‹è¯•æ‰¹é‡åˆ›å»º() {
    List<User> users = TestDataFactory.createUsers(10);
    userRepository.saveAll(users);
    assertEquals(10, userRepository.count());
}
```

### 8.3 Mockå¤–éƒ¨ä¾èµ–


**ğŸ”¸ ä½¿ç”¨@MockBeanæ¨¡æ‹Ÿå¤–éƒ¨æœåŠ¡**
```java
@SpringBootTest
class PaymentServiceTest {
    
    @Autowired
    private OrderService orderService;
    
    @MockBean  // æ¨¡æ‹ŸBeanï¼Œæ›¿æ¢çœŸå®çš„Bean
    private PaymentClient paymentClient;
    
    @Test
    void æµ‹è¯•è®¢å•æ”¯ä»˜() {
        // æ¨¡æ‹Ÿæ”¯ä»˜æ¥å£è¿”å›æˆåŠŸ
        when(paymentClient.pay(anyLong(), any()))
            .thenReturn(new PaymentResult(true, "æ”¯ä»˜æˆåŠŸ"));
        
        // æµ‹è¯•è®¢å•æœåŠ¡
        boolean result = orderService.payOrder(1L);
        assertTrue(result);
        
        // éªŒè¯æ”¯ä»˜æ¥å£è¢«è°ƒç”¨
        verify(paymentClient).pay(eq(1L), any());
    }
}
```

**ğŸ’¡ ä¸ºä»€ä¹ˆè¦Mock**
```
åŸå› ï¼š
âŒ å¤–éƒ¨æœåŠ¡ä¸ç¨³å®šï¼ˆç½‘ç»œé—®é¢˜ï¼‰
âŒ å¤–éƒ¨æœåŠ¡è¦æ”¶è´¹ï¼ˆæµ‹è¯•æˆæœ¬é«˜ï¼‰
âŒ å¤–éƒ¨æœåŠ¡æœ‰å‰¯ä½œç”¨ï¼ˆçœŸçš„å‘çŸ­ä¿¡ï¼‰

æ–¹æ¡ˆï¼š
âœ… Mockå¤–éƒ¨æœåŠ¡ï¼Œæ§åˆ¶è¿”å›ç»“æœ
âœ… æµ‹è¯•åªå…³æ³¨è‡ªå·±çš„é€»è¾‘
âœ… å¿«é€Ÿã€ç¨³å®šã€æ— å‰¯ä½œç”¨
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é›†æˆæµ‹è¯•æœ¬è´¨ï¼šæµ‹è¯•å¤šä¸ªç»„ä»¶ååŒå·¥ä½œ
ğŸ”¸ @SpringBootTestï¼šå¯åŠ¨å®Œæ•´Springå®¹å™¨
ğŸ”¸ TestRestTemplateï¼šå‘é€HTTPè¯·æ±‚çš„æµ‹è¯•å·¥å…·
ğŸ”¸ @Transactionalï¼šè‡ªåŠ¨å›æ»šï¼Œä¿æŒæ•°æ®åº“å¹²å‡€
ğŸ”¸ ç¯å¢ƒéš”ç¦»ï¼šæµ‹è¯•ç”¨ç‹¬ç«‹çš„æ•°æ®åº“å’Œé…ç½®
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é›†æˆæµ‹è¯•çš„æ ¸å¿ƒä»·å€¼**
```
å•å…ƒæµ‹è¯•ï¼šéªŒè¯å•ä¸ªé›¶ä»¶ï¼ˆå¿«ï¼Œä½†ä¸å…¨é¢ï¼‰
é›†æˆæµ‹è¯•ï¼šéªŒè¯é›¶ä»¶ç»„è£…ï¼ˆæ…¢ï¼Œä½†æ›´çœŸå®ï¼‰

åŸåˆ™ï¼š
âœ… å•å…ƒæµ‹è¯•ä¸ºä¸»ï¼ˆ70%ï¼‰
âœ… é›†æˆæµ‹è¯•ä¸ºè¾…ï¼ˆ20%ï¼‰
âœ… ç«¯åˆ°ç«¯æµ‹è¯•æœ€å°‘ï¼ˆ10%ï¼‰
```

**ğŸ”¹ @SpringBootTestçš„webEnvironmenté€‰æ‹©**
```
MOCKï¼ˆé»˜è®¤ï¼‰ï¼š
- ä¸å¯åŠ¨çœŸå®æœåŠ¡å™¨
- é€‚åˆï¼šæµ‹è¯•Controlleré€»è¾‘

RANDOM_PORTï¼ˆæ¨èï¼‰ï¼š
- å¯åŠ¨çœŸå®æœåŠ¡å™¨
- éšæœºç«¯å£ï¼Œé¿å…å†²çª
- é€‚åˆï¼šæµ‹è¯•HTTPæ¥å£

é€‰æ‹©å»ºè®®ï¼š
æµ‹è¯•æ¥å£ â†’ RANDOM_PORT
æµ‹è¯•é€»è¾‘ â†’ MOCK
```

**ğŸ”¹ æ•°æ®åº“æµ‹è¯•æœ€ä½³å®è·µ**
```
ç­–ç•¥1ï¼šä½¿ç”¨H2å†…å­˜æ•°æ®åº“
- ä¼˜ç‚¹ï¼šå¿«é€Ÿã€è‡ªåŠ¨æ¸…ç†
- é€‚ç”¨ï¼š90%çš„æµ‹è¯•åœºæ™¯

ç­–ç•¥2ï¼šä½¿ç”¨@Transactional
- ä¼˜ç‚¹ï¼šè‡ªåŠ¨å›æ»š
- ç¡®ä¿æµ‹è¯•éš”ç¦»

ç­–ç•¥3ï¼š@Sqlè„šæœ¬å‡†å¤‡æ•°æ®
- ä¼˜ç‚¹ï¼šå¯é‡å¤ã€å¯ç»´æŠ¤
- é€‚åˆï¼šå¤æ‚æ•°æ®å‡†å¤‡
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æµ‹è¯•ç¼–å†™æ­¥éª¤**
```
æ­¥éª¤ 1ï¸âƒ£ ç¡®å®šæµ‹è¯•ç›®æ ‡
     â†“
æ­¥éª¤ 2ï¸âƒ£ é€‰æ‹©åˆé€‚çš„æµ‹è¯•ç­–ç•¥
     â†“
æ­¥éª¤ 3ï¸âƒ£ å‡†å¤‡æµ‹è¯•æ•°æ®
     â†“
æ­¥éª¤ 4ï¸âƒ£ æ‰§è¡Œæµ‹è¯•å¹¶éªŒè¯
     â†“
æ­¥éª¤ 5ï¸âƒ£ æ¸…ç†æµ‹è¯•ç¯å¢ƒ
```

**ğŸ”§ å¸¸è§é—®é¢˜ä¸è§£å†³**

| é—®é¢˜ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|------|---------|-------------|
| ğŸ”¸ **æµ‹è¯•å¾ˆæ…¢** | `å¯åŠ¨å®Œæ•´å®¹å™¨` | `ä½¿ç”¨@WebMvcTestç­‰åˆ‡ç‰‡æµ‹è¯•` |
| ğŸ”¸ **æ•°æ®æ±¡æŸ“** | `æ²¡æœ‰å›æ»š` | `æ·»åŠ @Transactional` |
| ğŸ”¸ **ç«¯å£å†²çª** | `å›ºå®šç«¯å£` | `ä½¿ç”¨RANDOM_PORT` |
| ğŸ”¸ **å¤–éƒ¨ä¾èµ–å¤±è´¥** | `çœŸå®è°ƒç”¨` | `ä½¿ç”¨@MockBeanæ¨¡æ‹Ÿ` |

**ğŸ’¯ æœ€ä½³å®è·µæ¸…å•**
```
âœ… ä½¿ç”¨H2å†…å­˜æ•°æ®åº“ï¼ˆå¿«é€Ÿéš”ç¦»ï¼‰
âœ… æ·»åŠ @Transactionalï¼ˆè‡ªåŠ¨å›æ»šï¼‰
âœ… Mockå¤–éƒ¨ä¾èµ–ï¼ˆé¿å…å‰¯ä½œç”¨ï¼‰
âœ… ä½¿ç”¨TestRestTemplateï¼ˆæ–¹ä¾¿æµ‹è¯•HTTPï¼‰
âœ… å‡†å¤‡å¯é‡å¤çš„æµ‹è¯•æ•°æ®
âœ… éªŒè¯å…³é”®ä¸šåŠ¡é€»è¾‘
âœ… ä¿æŒæµ‹è¯•ç‹¬ç«‹æ€§ï¼ˆäº’ä¸å½±å“ï¼‰
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
é›†æˆæµ‹è¯•éªŒå…¨å±€ï¼Œå¤šä¸ªç»„ä»¶é½åä½œ
SpringBootTestå¯å®¹å™¨ï¼ŒTestRestTemplateå‘è¯·æ±‚
æ•°æ®åº“ç”¨H2å¿«ï¼Œäº‹åŠ¡å›æ»šä¿å¹²å‡€
é…ç½®éš”ç¦»åˆ†ç¯å¢ƒï¼ŒMockä¾èµ–æ§ç»“æœ
æµ‹è¯•ç‹¬ç«‹å¯é‡å¤ï¼Œå¿«é€Ÿåé¦ˆä¿è´¨é‡
```