---
title: 1ã€Spring MVCå•å…ƒæµ‹è¯•
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•](#1-ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•)
2. [MockMvcæµ‹è¯•æ¡†æ¶](#2-MockMvcæµ‹è¯•æ¡†æ¶)
3. [æµ‹è¯•æ³¨è§£è¯¦è§£](#3-æµ‹è¯•æ³¨è§£è¯¦è§£)
4. [æ§åˆ¶å™¨æµ‹è¯•å®æˆ˜](#4-æ§åˆ¶å™¨æµ‹è¯•å®æˆ˜)
5. [Mockå¯¹è±¡ä½¿ç”¨](#5-Mockå¯¹è±¡ä½¿ç”¨)
6. [æµ‹è¯•é…ç½®æŠ€å·§](#6-æµ‹è¯•é…ç½®æŠ€å·§)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•


### 1.1 å•å…ƒæµ‹è¯•çš„æœ¬è´¨


**é€šä¿—ç†è§£**ï¼šå°±åƒä½ åšå®Œä½œä¸šè¦æ£€æŸ¥ä¸€æ ·ï¼Œå†™å®Œä»£ç ä¹Ÿéœ€è¦éªŒè¯æ˜¯å¦æ­£ç¡®ã€‚

```
ç°å®ç±»æ¯”ï¼š
åšèœ â†’ å°ä¸€å°å‘³é“
å†™ä½œä¸š â†’ æ£€æŸ¥ç­”æ¡ˆ
å†™ä»£ç  â†’ å•å…ƒæµ‹è¯•

ç›®çš„ï¼šç¡®ä¿æ¯ä¸ªéƒ¨åˆ†éƒ½èƒ½æ­£å¸¸å·¥ä½œ
```

**ä¸ºä»€ä¹ˆéœ€è¦æµ‹è¯•**ï¼š
- âœ… **åŠæ—©å‘ç°é—®é¢˜**ï¼šå†™å®Œä»£ç ç«‹åˆ»çŸ¥é“æœ‰æ²¡æœ‰bug
- âœ… **ä¿è¯è´¨é‡**ï¼šç¡®ä¿åŠŸèƒ½æŒ‰é¢„æœŸå·¥ä½œ
- âœ… **æ–¹ä¾¿ä¿®æ”¹**ï¼šæ”¹ä»£ç åèƒ½å¿«é€ŸéªŒè¯æ²¡ç ´ååŸæœ‰åŠŸèƒ½
- âœ… **æ–‡æ¡£ä½œç”¨**ï¼šæµ‹è¯•ä»£ç æœ¬èº«å°±è¯´æ˜äº†åŠŸèƒ½å¦‚ä½•ä½¿ç”¨

### 1.2 Spring MVCæµ‹è¯•çš„ç‰¹ç‚¹


**ä¼ ç»Ÿæµ‹è¯•çš„å›°å¢ƒ**ï¼š
```
é—®é¢˜åœºæ™¯ï¼š
Controlleréœ€è¦ï¼š
â†’ TomcatæœåŠ¡å™¨è¿è¡Œ
â†’ æ•°æ®åº“è¿æ¥
â†’ å„ç§Beanæ³¨å…¥
â†’ HTTPè¯·æ±‚å‘é€

è¿™æ ·æµ‹è¯•å¾ˆæ…¢ï¼Œå¾ˆéº»çƒ¦ï¼
```

**Spring MVCæµ‹è¯•çš„ä¼˜åŠ¿**ï¼š
- ğŸš€ **ä¸éœ€è¦å¯åŠ¨æœåŠ¡å™¨**ï¼šæ¨¡æ‹ŸHTTPç¯å¢ƒ
- âš¡ **è¿è¡Œé€Ÿåº¦å¿«**ï¼šåªåŠ è½½éœ€è¦çš„ç»„ä»¶
- ğŸ¯ **éš”ç¦»æµ‹è¯•**ï¼šä¸“æ³¨æµ‹è¯•Controlleré€»è¾‘
- ğŸ”§ **çµæ´»é…ç½®**ï¼šå¯ä»¥Mockä»»ä½•ä¾èµ–

---

## 2. ğŸ› ï¸ MockMvcæµ‹è¯•æ¡†æ¶


### 2.1 MockMvcæ˜¯ä»€ä¹ˆ


**ç®€å•ç†è§£**ï¼šMockMvcå°±æ˜¯ä¸€ä¸ª"å‡çš„"Webç¯å¢ƒï¼Œè®©ä½ å¯ä»¥åœ¨ä¸å¯åŠ¨æœåŠ¡å™¨çš„æƒ…å†µä¸‹æµ‹è¯•Controllerã€‚

```
å·¥ä½œåŸç†å›¾ç¤ºï¼š

çœŸå®ç¯å¢ƒï¼š
æµè§ˆå™¨ â†’ HTTPè¯·æ±‚ â†’ Tomcat â†’ Controller â†’ è¿”å›å“åº”

MockMvcç¯å¢ƒï¼š
æµ‹è¯•ä»£ç  â†’ æ¨¡æ‹ŸHTTP â†’ MockMvc â†’ Controller â†’ éªŒè¯ç»“æœ
         â†‘
      ä¸éœ€è¦çœŸå®æœåŠ¡å™¨ï¼
```

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ğŸ“¤ **æ¨¡æ‹ŸHTTPè¯·æ±‚**ï¼šGETã€POSTã€PUTã€DELETEç­‰
- ğŸ“¥ **éªŒè¯å“åº”ç»“æœ**ï¼šçŠ¶æ€ç ã€å“åº”å†…å®¹ã€Headerç­‰
- ğŸ­ **æ¨¡æ‹Ÿå„ç§åœºæ™¯**ï¼šæ­£å¸¸è¯·æ±‚ã€å¼‚å¸¸æƒ…å†µã€è¾¹ç•Œæ¡ä»¶

### 2.2 MockMvcçš„åŸºæœ¬ä½¿ç”¨


**ç¬¬ä¸€æ­¥ï¼šå¼•å…¥ä¾èµ–**

| ä¾èµ–é¡¹ | ä½œç”¨ | è¯´æ˜ |
|--------|------|------|
| `spring-boot-starter-test` | æµ‹è¯•åŸºç¡€åŒ… | åŒ…å«JUnitã€Mockitoç­‰ |
| `spring-test` | Springæµ‹è¯•æ”¯æŒ | æä¾›MockMvcç­‰å·¥å…· |

**ç¬¬äºŒæ­¥ï¼šåˆ›å»ºMockMvcå¯¹è±¡**

```java
@WebMvcTest(UserController.class)  // åªæµ‹è¯•è¿™ä¸ªController
public class UserControllerTest {
    
    @Autowired
    private MockMvc mockMvc;  // Springè‡ªåŠ¨åˆ›å»ºå¥½çš„MockMvc
    
    // æ¥ä¸‹æ¥å°±å¯ä»¥ç”¨mockMvcå‘é€æµ‹è¯•è¯·æ±‚äº†
}
```

**ç¬¬ä¸‰æ­¥ï¼šå‘é€æµ‹è¯•è¯·æ±‚**

```java
@Test
public void testGetUser() throws Exception {
    // å‘é€GETè¯·æ±‚
    mockMvc.perform(get("/user/1"))
           .andExpect(status().isOk())           // æœŸæœ›è¿”å›200
           .andExpect(jsonPath("$.name").value("å¼ ä¸‰"));  // æœŸæœ›nameæ˜¯å¼ ä¸‰
}
```

### 2.3 è¯·æ±‚æ¨¡æ‹Ÿè¯¦è§£


**å‘é€ä¸åŒç±»å‹çš„è¯·æ±‚**ï¼š

```java
// GETè¯·æ±‚
mockMvc.perform(get("/users"))

// POSTè¯·æ±‚ï¼ˆå‘é€JSONï¼‰
mockMvc.perform(post("/user")
       .contentType(MediaType.APPLICATION_JSON)
       .content("{\"name\":\"æå››\",\"age\":25}"))

// PUTè¯·æ±‚ï¼ˆæ›´æ–°æ•°æ®ï¼‰
mockMvc.perform(put("/user/1")
       .param("name", "ç‹äº”"))

// DELETEè¯·æ±‚
mockMvc.perform(delete("/user/1"))
```

**è¯·æ±‚æ„é€ æŠ€å·§**ï¼š

```
è¯·æ±‚ç»„æˆéƒ¨åˆ†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTPæ–¹æ³•    â”‚ â†’ getã€postã€putã€delete
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¯·æ±‚è·¯å¾„    â”‚ â†’ /user/1
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¯·æ±‚å‚æ•°    â”‚ â†’ param()æ·»åŠ 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¯·æ±‚å¤´      â”‚ â†’ header()æ·»åŠ 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¯·æ±‚ä½“      â”‚ â†’ content()æ·»åŠ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 å“åº”éªŒè¯è¯¦è§£


**çŠ¶æ€ç éªŒè¯**ï¼š
```java
.andExpect(status().isOk())           // 200
.andExpect(status().isCreated())      // 201
.andExpect(status().isBadRequest())   // 400
.andExpect(status().isNotFound())     // 404
```

**å“åº”å†…å®¹éªŒè¯**ï¼š
```java
// éªŒè¯JSONå†…å®¹
.andExpect(jsonPath("$.id").value(1))
.andExpect(jsonPath("$.name").value("å¼ ä¸‰"))
.andExpect(jsonPath("$.age").value(20))

// éªŒè¯JSONæ•°ç»„
.andExpect(jsonPath("$[0].name").value("ç”¨æˆ·1"))
.andExpect(jsonPath("$.length()").value(3))  // æ•°ç»„é•¿åº¦

// éªŒè¯å“åº”å¤´
.andExpect(header().string("Content-Type", "application/json"))
```

---

## 3. ğŸ“ æµ‹è¯•æ³¨è§£è¯¦è§£


### 3.1 @WebMvcTestæ³¨è§£


**æ ¸å¿ƒä½œç”¨**ï¼šåªåŠ è½½Webå±‚ç›¸å…³çš„ç»„ä»¶ï¼Œä¸åŠ è½½æ•´ä¸ªSpringå®¹å™¨ã€‚

**ä¸ºä»€ä¹ˆç”¨å®ƒ**ï¼š
```
å¯¹æ¯”è¯´æ˜ï¼š

@SpringBootTestï¼š
â†’ åŠ è½½æ‰€æœ‰Beanï¼ˆServiceã€Mapperã€Config...ï¼‰
â†’ å¯åŠ¨å®Œæ•´Springå®¹å™¨
â†’ é€Ÿåº¦æ…¢ï¼Œä½†ç¯å¢ƒå®Œæ•´

@WebMvcTestï¼š
â†’ åªåŠ è½½Controllerå’ŒWebç›¸å…³ç»„ä»¶
â†’ å…¶ä»–Beanéœ€è¦Mock
â†’ é€Ÿåº¦å¿«ï¼Œä¸“æ³¨æµ‹è¯•Controller
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```java
// æ–¹å¼1ï¼šæµ‹è¯•å•ä¸ªController
@WebMvcTest(UserController.class)

// æ–¹å¼2ï¼šæµ‹è¯•å¤šä¸ªController
@WebMvcTest({UserController.class, OrderController.class})

// æ–¹å¼3ï¼šæµ‹è¯•æ‰€æœ‰Controllerï¼ˆä¸æ¨èï¼‰
@WebMvcTest
```

**ä¼šè‡ªåŠ¨é…ç½®çš„å†…å®¹**ï¼š
- âœ… MockMvcå¯¹è±¡
- âœ… Controllerå±‚
- âœ… @ControllerAdviceï¼ˆå…¨å±€å¼‚å¸¸å¤„ç†ï¼‰
- âœ… Filterè¿‡æ»¤å™¨
- âœ… æ•°æ®éªŒè¯å™¨

**ä¸ä¼šåŠ è½½çš„å†…å®¹**ï¼ˆéœ€è¦Mockï¼‰ï¼š
- âŒ ServiceæœåŠ¡å±‚
- âŒ Repositoryæ•°æ®å±‚
- âŒ å…¶ä»–ä¸šåŠ¡Bean

### 3.2 æµ‹è¯•åˆ‡ç‰‡æ³¨è§£


**ä»€ä¹ˆæ˜¯æµ‹è¯•åˆ‡ç‰‡**ï¼šåªåŠ è½½ç‰¹å®šå±‚çš„ç»„ä»¶ï¼Œä¸æ˜¯æ•´ä¸ªåº”ç”¨ã€‚

| æ³¨è§£ | ä½œç”¨ | åŠ è½½å†…å®¹ |
|------|------|----------|
| `@WebMvcTest` | Webå±‚æµ‹è¯• | Controllerã€Filterã€Converter |
| `@DataJpaTest` | JPAæµ‹è¯• | Repositoryã€Entityã€JPAé…ç½® |
| `@JsonTest` | JSONæµ‹è¯• | JSONåºåˆ—åŒ–ç»„ä»¶ |
| `@RestClientTest` | RESTå®¢æˆ·ç«¯æµ‹è¯• | RestTemplateç›¸å…³ |

### 3.3 å¸¸ç”¨æµ‹è¯•æ³¨è§£ç»„åˆ


```java
@WebMvcTest(UserController.class)  // æŒ‡å®šè¦æµ‹è¯•çš„Controller
@AutoConfigureMockMvc               // è‡ªåŠ¨é…ç½®MockMvcï¼ˆé€šå¸¸ä¸éœ€è¦ï¼‰
public class UserControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean  // åˆ›å»ºMockå¯¹è±¡å¹¶æ³¨å…¥Springå®¹å™¨
    private UserService userService;
    
    @Test
    public void testGetUser() {
        // æµ‹è¯•ä»£ç 
    }
}
```

---

## 4. ğŸ® æ§åˆ¶å™¨æµ‹è¯•å®æˆ˜


### 4.1 æµ‹è¯•GETè¯·æ±‚


**åœºæ™¯ï¼šæ ¹æ®IDæŸ¥è¯¢ç”¨æˆ·**

```java
// Controllerä»£ç 
@GetMapping("/user/{id}")
public User getUser(@PathVariable Long id) {
    return userService.findById(id);
}

// æµ‹è¯•ä»£ç 
@Test
public void æµ‹è¯•æŸ¥è¯¢ç”¨æˆ·æˆåŠŸ() throws Exception {
    // 1. å‡†å¤‡Mockæ•°æ®
    User mockUser = new User(1L, "å¼ ä¸‰", 25);
    when(userService.findById(1L)).thenReturn(mockUser);
    
    // 2. å‘é€è¯·æ±‚å¹¶éªŒè¯
    mockMvc.perform(get("/user/1"))
           .andExpect(status().isOk())
           .andExpect(jsonPath("$.id").value(1))
           .andExpect(jsonPath("$.name").value("å¼ ä¸‰"))
           .andExpect(jsonPath("$.age").value(25));
}
```

**éªŒè¯æ€è·¯**ï¼š
```
æµ‹è¯•æ­¥éª¤ï¼š
1ï¸âƒ£ Mock Serviceå±‚çš„è¿”å›å€¼
2ï¸âƒ£ ç”¨MockMvcå‘é€HTTPè¯·æ±‚
3ï¸âƒ£ éªŒè¯HTTPå“åº”ï¼ˆçŠ¶æ€ç ã€å†…å®¹ï¼‰
```

### 4.2 æµ‹è¯•POSTè¯·æ±‚


**åœºæ™¯ï¼šåˆ›å»ºæ–°ç”¨æˆ·**

```java
// Controllerä»£ç 
@PostMapping("/user")
public User createUser(@RequestBody User user) {
    return userService.save(user);
}

// æµ‹è¯•ä»£ç 
@Test
public void æµ‹è¯•åˆ›å»ºç”¨æˆ·æˆåŠŸ() throws Exception {
    // 1. å‡†å¤‡è¯·æ±‚æ•°æ®
    User newUser = new User(null, "æå››", 30);
    User savedUser = new User(1L, "æå››", 30);
    
    when(userService.save(any(User.class))).thenReturn(savedUser);
    
    // 2. å‘é€POSTè¯·æ±‚
    mockMvc.perform(post("/user")
           .contentType(MediaType.APPLICATION_JSON)
           .content("{\"name\":\"æå››\",\"age\":30}"))
           .andExpect(status().isOk())
           .andExpect(jsonPath("$.id").value(1))
           .andExpect(jsonPath("$.name").value("æå››"));
}
```

### 4.3 æµ‹è¯•è¯·æ±‚å‚æ•°éªŒè¯


**åœºæ™¯ï¼šéªŒè¯å‚æ•°æ ¡éªŒæ˜¯å¦ç”Ÿæ•ˆ**

```java
// Controllerä»£ç 
@PostMapping("/user")
public User createUser(@Valid @RequestBody User user) {
    return userService.save(user);
}

// æµ‹è¯•ä»£ç 
@Test
public void æµ‹è¯•å‚æ•°éªŒè¯å¤±è´¥() throws Exception {
    // å‘é€ç©ºnameçš„è¯·æ±‚ï¼ŒæœŸæœ›è¿”å›400
    mockMvc.perform(post("/user")
           .contentType(MediaType.APPLICATION_JSON)
           .content("{\"name\":\"\",\"age\":30}"))
           .andExpect(status().isBadRequest());  // å‚æ•°æ ¡éªŒå¤±è´¥è¿”å›400
}
```

### 4.4 æµ‹è¯•å¼‚å¸¸å¤„ç†


**åœºæ™¯ï¼šæµ‹è¯•å…¨å±€å¼‚å¸¸å¤„ç†**

```java
@Test
public void æµ‹è¯•ç”¨æˆ·ä¸å­˜åœ¨å¼‚å¸¸() throws Exception {
    // Mock ServiceæŠ›å‡ºå¼‚å¸¸
    when(userService.findById(999L))
        .thenThrow(new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
    
    // éªŒè¯è¿”å›404
    mockMvc.perform(get("/user/999"))
           .andExpect(status().isNotFound())
           .andExpect(jsonPath("$.message").value("ç”¨æˆ·ä¸å­˜åœ¨"));
}
```

---

## 5. ğŸ­ Mockå¯¹è±¡ä½¿ç”¨


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦Mock


**é—®é¢˜åœºæ™¯**ï¼š
```
Controlleræµ‹è¯•å›°å¢ƒï¼š
UserController ä¾èµ– â†’ UserService
UserService ä¾èµ– â†’ UserMapper
UserMapper ä¾èµ– â†’ æ•°æ®åº“

å¦‚æœæµ‹è¯•Controllerè¦å¯åŠ¨æ•°æ®åº“ï¼Œå¤ªéº»çƒ¦äº†ï¼
```

**Mockè§£å†³æ–¹æ¡ˆ**ï¼š
```
ä½¿ç”¨Mockå¯¹è±¡ï¼š
UserController â†’ Mockçš„UserServiceï¼ˆå‡çš„ï¼‰
                 â†“
            è¿”å›é¢„è®¾å¥½çš„æ•°æ®
            ä¸ä¾èµ–çœŸå®æ•°æ®åº“
```

### 5.2 @MockBeanæ³¨è§£


**ä½œç”¨**ï¼šåˆ›å»ºMockå¯¹è±¡å¹¶è‡ªåŠ¨æ³¨å…¥åˆ°Springå®¹å™¨ä¸­ã€‚

```java
@WebMvcTest(UserController.class)
public class UserControllerTest {
    
    @MockBean  // å…³é”®ï¼šåˆ›å»ºMockçš„UserService
    private UserService userService;
    
    @Test
    public void test() {
        // è®¾ç½®Mockè¡Œä¸ºï¼šå½“è°ƒç”¨findById(1L)æ—¶è¿”å›æŒ‡å®šå¯¹è±¡
        when(userService.findById(1L))
            .thenReturn(new User(1L, "å¼ ä¸‰", 25));
        
        // Controllerä¼šè‡ªåŠ¨ä½¿ç”¨è¿™ä¸ªMockå¯¹è±¡
    }
}
```

**Mockå¯¹è±¡çš„ç‰¹ç‚¹**ï¼š
- ğŸ­ **å‡çš„å¯¹è±¡**ï¼šä¸æ˜¯çœŸå®çš„Serviceå®ä¾‹
- ğŸ¯ **è¡Œä¸ºå¯æ§**ï¼šä½ è¯´å®ƒè¿”å›ä»€ä¹ˆå°±è¿”å›ä»€ä¹ˆ
- âš¡ **ä¸æ‰§è¡ŒçœŸå®é€»è¾‘**ï¼šä¸ä¼šè®¿é—®æ•°æ®åº“ã€ä¸ä¼šè°ƒç”¨API

### 5.3 Mockè¡Œä¸ºè®¾ç½®


**åŸºæœ¬è¯­æ³•**ï¼š`when(...).thenReturn(...)`

```java
// å›ºå®šè¿”å›å€¼
when(userService.findById(1L)).thenReturn(user1);

// æ ¹æ®ä¸åŒå‚æ•°è¿”å›ä¸åŒå€¼
when(userService.findById(1L)).thenReturn(user1);
when(userService.findById(2L)).thenReturn(user2);

// ä»»æ„å‚æ•°éƒ½è¿”å›ç›¸åŒå€¼
when(userService.findById(anyLong())).thenReturn(user);

// æŠ›å‡ºå¼‚å¸¸
when(userService.findById(999L))
    .thenThrow(new UserNotFoundException());

// å¤šæ¬¡è°ƒç”¨è¿”å›ä¸åŒå€¼
when(userService.findAll())
    .thenReturn(list1)    // ç¬¬1æ¬¡è°ƒç”¨è¿”å›list1
    .thenReturn(list2);   // ç¬¬2æ¬¡è°ƒç”¨è¿”å›list2
```

### 5.4 å‚æ•°åŒ¹é…å™¨


**å¸¸ç”¨åŒ¹é…å™¨**ï¼š

| åŒ¹é…å™¨ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `any()` | ä»»æ„å¯¹è±¡ | `any(User.class)` |
| `anyString()` | ä»»æ„å­—ç¬¦ä¸² | `anyString()` |
| `anyLong()` | ä»»æ„Long | `anyLong()` |
| `eq()` | ç­‰äºæŸå€¼ | `eq(1L)` |
| `isNull()` | å‚æ•°ä¸ºnull | `isNull()` |

```java
// ç¤ºä¾‹ï¼šä¿å­˜ä»»æ„Useréƒ½è¿”å›æˆåŠŸ
when(userService.save(any(User.class)))
    .thenReturn(new User(1L, "saved", 0));
```

### 5.5 éªŒè¯Mockè°ƒç”¨


**éªŒè¯æ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨**ï¼š

```java
@Test
public void æµ‹è¯•åˆ é™¤ç”¨æˆ·() throws Exception {
    mockMvc.perform(delete("/user/1"))
           .andExpect(status().isOk());
    
    // éªŒè¯deleteByIdæ–¹æ³•è¢«è°ƒç”¨äº†1æ¬¡
    verify(userService, times(1)).deleteById(1L);
    
    // éªŒè¯ä»æœªè°ƒç”¨saveæ–¹æ³•
    verify(userService, never()).save(any());
}
```

---

## 6. âš™ï¸ æµ‹è¯•é…ç½®æŠ€å·§


### 6.1 é€šç”¨æµ‹è¯•é…ç½®


**åˆ›å»ºåŸºç¡€æµ‹è¯•ç±»**ï¼š

```java
@WebMvcTest
public abstract class BaseControllerTest {
    
    @Autowired
    protected MockMvc mockMvc;
    
    @Autowired
    protected ObjectMapper objectMapper;  // JSONè½¬æ¢å·¥å…·
    
    // é€šç”¨å·¥å…·æ–¹æ³•
    protected String toJson(Object obj) throws Exception {
        return objectMapper.writeValueAsString(obj);
    }
}
```

**å…¶ä»–æµ‹è¯•ç±»ç»§æ‰¿å®ƒ**ï¼š

```java
public class UserControllerTest extends BaseControllerTest {
    
    @MockBean
    private UserService userService;
    
    @Test
    public void test() throws Exception {
        String json = toJson(new User());  // ä½¿ç”¨çˆ¶ç±»çš„å·¥å…·æ–¹æ³•
        mockMvc.perform(post("/user").content(json))...
    }
}
```

### 6.2 æµ‹è¯•æ•°æ®å‡†å¤‡


**ä½¿ç”¨@BeforeEachå‡†å¤‡æ•°æ®**ï¼š

```java
@WebMvcTest(UserController.class)
public class UserControllerTest {
    
    @MockBean
    private UserService userService;
    
    private User testUser;  // æµ‹è¯•æ•°æ®
    
    @BeforeEach  // æ¯ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œå‰éƒ½ä¼šæ‰§è¡Œ
    public void setUp() {
        testUser = new User(1L, "æµ‹è¯•ç”¨æˆ·", 20);
    }
    
    @Test
    public void test1() {
        // å¯ä»¥ç›´æ¥ä½¿ç”¨testUser
    }
}
```

### 6.3 é…ç½®æ–‡ä»¶ç®¡ç†


**ä½¿ç”¨æµ‹è¯•ä¸“ç”¨é…ç½®**ï¼š

```yaml
# src/test/resources/application-test.yml
spring:
  datasource:
    url: jdbc:h2:mem:testdb  # ä½¿ç”¨å†…å­˜æ•°æ®åº“
  jpa:
    show-sql: true           # æ˜¾ç¤ºSQLä¾¿äºè°ƒè¯•
```

**åœ¨æµ‹è¯•ç±»ä¸­æ¿€æ´»**ï¼š

```java
@WebMvcTest
@ActiveProfiles("test")  // ä½¿ç”¨testé…ç½®
public class UserControllerTest {
    // ...
}
```

### 6.4 å®Œæ•´æµ‹è¯•ç¤ºä¾‹


```java
@WebMvcTest(UserController.class)
public class UserControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private UserService userService;
    
    @Test
    public void å®Œæ•´çš„ç”¨æˆ·CRUDæµ‹è¯•() throws Exception {
        // 1. æµ‹è¯•æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
        List<User> users = Arrays.asList(
            new User(1L, "å¼ ä¸‰", 25),
            new User(2L, "æå››", 30)
        );
        when(userService.findAll()).thenReturn(users);
        
        mockMvc.perform(get("/users"))
               .andExpect(status().isOk())
               .andExpect(jsonPath("$.length()").value(2))
               .andExpect(jsonPath("$[0].name").value("å¼ ä¸‰"));
        
        // 2. æµ‹è¯•åˆ›å»ºç”¨æˆ·
        User newUser = new User(null, "ç‹äº”", 28);
        User savedUser = new User(3L, "ç‹äº”", 28);
        when(userService.save(any(User.class))).thenReturn(savedUser);
        
        mockMvc.perform(post("/user")
               .contentType(MediaType.APPLICATION_JSON)
               .content("{\"name\":\"ç‹äº”\",\"age\":28}"))
               .andExpect(status().isOk())
               .andExpect(jsonPath("$.id").value(3));
        
        // 3. æµ‹è¯•æ›´æ–°ç”¨æˆ·
        when(userService.update(eq(1L), any(User.class)))
            .thenReturn(new User(1L, "å¼ ä¸‰æ”¹å", 26));
        
        mockMvc.perform(put("/user/1")
               .contentType(MediaType.APPLICATION_JSON)
               .content("{\"name\":\"å¼ ä¸‰æ”¹å\",\"age\":26}"))
               .andExpect(status().isOk())
               .andExpect(jsonPath("$.name").value("å¼ ä¸‰æ”¹å"));
        
        // 4. æµ‹è¯•åˆ é™¤ç”¨æˆ·
        mockMvc.perform(delete("/user/1"))
               .andExpect(status().isOk());
        
        verify(userService).deleteById(1L);
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ¦‚å¿µ


```
ğŸ¯ å•å…ƒæµ‹è¯•æœ¬è´¨ï¼š
â†’ è‡ªåŠ¨åŒ–éªŒè¯ä»£ç åŠŸèƒ½
â†’ ä¸ä¾èµ–å¤–éƒ¨ç¯å¢ƒï¼ˆæ•°æ®åº“ã€æœåŠ¡å™¨ï¼‰
â†’ å¿«é€Ÿåé¦ˆä»£ç é—®é¢˜

ğŸ› ï¸ MockMvcæ¡†æ¶ï¼š
â†’ æ¨¡æ‹ŸHTTPè¯·æ±‚å’Œå“åº”
â†’ ä¸éœ€è¦å¯åŠ¨çœŸå®æœåŠ¡å™¨
â†’ ä¸“æ³¨æµ‹è¯•Controllerå±‚é€»è¾‘

ğŸ­ Mockå¯¹è±¡ï¼š
â†’ åˆ›å»ºå‡çš„ä¾èµ–å¯¹è±¡
â†’ æ§åˆ¶æ–¹æ³•è¿”å›å€¼
â†’ éš”ç¦»æµ‹è¯•ç¯å¢ƒ
```

### 7.2 å…³é”®æ³¨è§£å¯¹æ¯”


| æ³¨è§£ | ä½œç”¨ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `@WebMvcTest` | åªåŠ è½½Webå±‚ | æµ‹è¯•Controller |
| `@SpringBootTest` | åŠ è½½å®Œæ•´å®¹å™¨ | é›†æˆæµ‹è¯• |
| `@MockBean` | åˆ›å»ºMockå¯¹è±¡ | æ¨¡æ‹Ÿä¾èµ– |
| `@Autowired` | æ³¨å…¥çœŸå®Bean | ä½¿ç”¨MockMvc |

### 7.3 æµ‹è¯•ç¼–å†™æµç¨‹


```
æ ‡å‡†æµ‹è¯•æ­¥éª¤ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å‡†å¤‡æµ‹è¯•æ•°æ®  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. Mockä¾èµ–è¡Œä¸º  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. å‘é€HTTPè¯·æ±‚  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. éªŒè¯å“åº”ç»“æœ  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. éªŒè¯æ–¹æ³•è°ƒç”¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.4 å¸¸è§é—®é¢˜è§£å†³


**Qï¼šæµ‹è¯•æ—¶Serviceæ˜¯nullæ€ä¹ˆåŠï¼Ÿ**
```
Aï¼šä½¿ç”¨@MockBeanåˆ›å»ºMockå¯¹è±¡
   @MockBean
   private UserService userService;
```

**Qï¼šå¦‚ä½•æµ‹è¯•å¼‚å¸¸æƒ…å†µï¼Ÿ**
```
Aï¼šMockæ–¹æ³•æŠ›å‡ºå¼‚å¸¸
   when(service.method()).thenThrow(new Exception());
```

**Qï¼šæµ‹è¯•å¾ˆæ…¢æ€ä¹ˆä¼˜åŒ–ï¼Ÿ**
```
Aï¼š
1. ä½¿ç”¨@WebMvcTestä»£æ›¿@SpringBootTest
2. åªMockå¿…è¦çš„Bean
3. åˆç†ä½¿ç”¨@BeforeEachå‡†å¤‡æ•°æ®
```

### 7.5 æœ€ä½³å®è·µå»ºè®®


âœ… **æ¨èåšæ³•**ï¼š
- æ¯ä¸ªControlleræ–¹æ³•éƒ½å†™æµ‹è¯•
- æµ‹è¯•æ­£å¸¸åœºæ™¯å’Œå¼‚å¸¸åœºæ™¯
- ä½¿ç”¨æœ‰æ„ä¹‰çš„æµ‹è¯•æ–¹æ³•åï¼ˆä¸­æ–‡ä¹Ÿå¯ä»¥ï¼‰
- ä¸€ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªåŠŸèƒ½ç‚¹

âŒ **é¿å…åšæ³•**ï¼š
- ä¸è¦åœ¨æµ‹è¯•ä¸­è®¿é—®çœŸå®æ•°æ®åº“
- ä¸è¦æµ‹è¯•å¤ªå¤šé€»è¾‘åœ¨ä¸€ä¸ªæ–¹æ³•é‡Œ
- ä¸è¦å¿½ç•¥è¾¹ç•Œæ¡ä»¶æµ‹è¯•
- ä¸è¦å¤åˆ¶ç²˜è´´æµ‹è¯•ä»£ç 

**æ ¸å¿ƒè®°å¿†**ï¼š
- MockMvcæ¨¡æ‹Ÿè¯·æ±‚ï¼Œ@WebMvcTeståŠ è½½Controller
- @MockBeanåˆ›å»ºå‡ä¾èµ–ï¼Œwhenè®¾ç½®è¿”å›å€¼
- performå‘è¯·æ±‚ï¼ŒandExpectéªŒè¯å“åº”
- æµ‹è¯•è¦å¿«ã€è¦éš”ç¦»ã€è¦è‡ªåŠ¨åŒ–