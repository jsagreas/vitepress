---
title: 1ã€å¼‚æ­¥è¯·æ±‚å¤„ç†æœºåˆ¶
---
## ğŸ“š ç›®å½•


1. [ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥å¤„ç†](#1-ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥å¤„ç†)
2. [DeferredResultè¯¦è§£](#2-DeferredResultè¯¦è§£)
3. [Callableè¿”å›å€¼å¤„ç†](#3-Callableè¿”å›å€¼å¤„ç†)
4. [å¼‚æ­¥ServletåŸç†](#4-å¼‚æ­¥ServletåŸç†)
5. [é•¿è¿æ¥å¤„ç†æŠ€æœ¯](#5-é•¿è¿æ¥å¤„ç†æŠ€æœ¯)
6. [è¶…æ—¶é…ç½®ä¸ç®¡ç†](#6-è¶…æ—¶é…ç½®ä¸ç®¡ç†)
7. [å¼‚æ­¥æ‹¦æˆªå™¨æœºåˆ¶](#7-å¼‚æ­¥æ‹¦æˆªå™¨æœºåˆ¶)
8. [çº¿ç¨‹æ± é…ç½®ä¼˜åŒ–](#8-çº¿ç¨‹æ± é…ç½®ä¼˜åŒ–)
9. [å¼‚æ­¥å¼‚å¸¸å¤„ç†](#9-å¼‚æ­¥å¼‚å¸¸å¤„ç†)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥å¤„ç†



### 1.1 ä¼ ç»ŸåŒæ­¥è¯·æ±‚çš„é—®é¢˜



**ä¼ ç»Ÿæ–¹å¼çš„å›°å¢ƒ**ï¼šæƒ³è±¡ä¸€ä¸‹ä½ å»é¤å…ç‚¹é¤

```
åŒæ­¥æ–¹å¼ï¼ˆä¼ ç»Ÿï¼‰ï¼š
é¡¾å®¢ â†’ æœåŠ¡å‘˜ â†’ ç­‰å¾…å¨æˆ¿åšèœ â†’ æœåŠ¡å‘˜ä¸€ç›´ç«™åœ¨å¨æˆ¿é—¨å£ â†’ èœå¥½äº† â†’ ç«¯ç»™é¡¾å®¢
        â†‘_____________ç­‰å¾…æœŸé—´å•¥ä¹Ÿä¸å¹²_____________â†‘

é—®é¢˜ï¼šæœåŠ¡å‘˜ï¼ˆçº¿ç¨‹ï¼‰åœ¨ç­‰å¾…æœŸé—´è¢«å ç”¨ï¼Œä¸èƒ½æœåŠ¡å…¶ä»–é¡¾å®¢ï¼
```

**ç°å®åœºæ™¯ä¸¾ä¾‹**ï¼š
- ğŸ“§ **å‘é€é‚®ä»¶**ï¼šè°ƒç”¨é‚®ä»¶æœåŠ¡å¯èƒ½éœ€è¦3-5ç§’
- ğŸ—„ï¸ **æŸ¥è¯¢æ•°æ®åº“**ï¼šå¤æ‚ç»Ÿè®¡æŸ¥è¯¢å¯èƒ½è¦10ç§’
- ğŸŒ **è°ƒç”¨ç¬¬ä¸‰æ–¹API**ï¼šç½‘ç»œå»¶è¿Ÿä¸å¯æ§
- ğŸ“Š **ç”ŸæˆæŠ¥è¡¨**ï¼šå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ

### 1.2 å¼‚æ­¥å¤„ç†çš„ä¼˜åŠ¿



```
å¼‚æ­¥æ–¹å¼ï¼š
é¡¾å®¢ â†’ æœåŠ¡å‘˜ â†’ ç»™å¨æˆ¿ä¸‹å• â†’ æœåŠ¡å‘˜å»æœåŠ¡å…¶ä»–é¡¾å®¢ â†’ èœå¥½äº†é€šçŸ¥ â†’ ç«¯ç»™é¡¾å®¢
        â†‘_____é‡Šæ”¾å‡ºæ¥å¹²åˆ«çš„æ´»_____â†‘

ä¼˜åŠ¿ï¼šæœåŠ¡å‘˜ï¼ˆçº¿ç¨‹ï¼‰å¯ä»¥åŒæ—¶å¤„ç†æ›´å¤šé¡¾å®¢çš„éœ€æ±‚ï¼
```

**æ ¸å¿ƒä»·å€¼å¯¹æ¯”è¡¨**ï¼š

| å¯¹æ¯”ç»´åº¦ | **åŒæ­¥å¤„ç†** | **å¼‚æ­¥å¤„ç†** |
|---------|-------------|-------------|
| ğŸ“Š **å¹¶å‘èƒ½åŠ›** | `å—é™äºçº¿ç¨‹æ± å¤§å°` | `çªç ´çº¿ç¨‹æ•°é™åˆ¶` |
| âš¡ **å“åº”é€Ÿåº¦** | `æ…¢ä»»åŠ¡é˜»å¡å…¶ä»–è¯·æ±‚` | `å¿«é€Ÿé‡Šæ”¾çº¿ç¨‹` |
| ğŸ’° **èµ„æºåˆ©ç”¨** | `çº¿ç¨‹ç­‰å¾…æ—¶æµªè´¹èµ„æº` | `çº¿ç¨‹é«˜æ•ˆå¤ç”¨` |
| ğŸ¯ **é€‚ç”¨åœºæ™¯** | `å¿«é€Ÿå¤„ç†çš„è¯·æ±‚` | `è€—æ—¶æ“ä½œã€é•¿è¿æ¥` |

### 1.3 ä½•æ—¶ä½¿ç”¨å¼‚æ­¥å¤„ç†



**âœ… é€‚åˆä½¿ç”¨çš„åœºæ™¯**ï¼š
```
ğŸ”¸ è€—æ—¶æ“ä½œï¼šæ•°æ®åº“æŸ¥è¯¢ã€æ–‡ä»¶å¤„ç†ã€å¤æ‚è®¡ç®—
ğŸ”¸ å¤–éƒ¨è°ƒç”¨ï¼šç¬¬ä¸‰æ–¹APIã€å¾®æœåŠ¡è°ƒç”¨ã€æ¶ˆæ¯é˜Ÿåˆ—
ğŸ”¸ é•¿è¿æ¥ï¼šSSEæ¨é€ã€é•¿è½®è¯¢ã€å®æ—¶é€šçŸ¥
ğŸ”¸ é«˜å¹¶å‘ï¼šç§’æ€ã€æŠ¢è´­ç­‰æµé‡çªå¢åœºæ™¯
```

**âŒ ä¸é€‚åˆçš„åœºæ™¯**ï¼š
```
ğŸ”¸ ç®€å•æŸ¥è¯¢ï¼šæ¯«ç§’çº§å“åº”çš„æ•°æ®åº“æ“ä½œ
ğŸ”¸ çº¯å†…å­˜æ“ä½œï¼šç¼“å­˜è¯»å–ã€ç®€å•è®¡ç®—
ğŸ”¸ äº‹åŠ¡è¦æ±‚é«˜ï¼šéœ€è¦å¼ºä¸€è‡´æ€§çš„æ“ä½œ
```

---

## 2. ğŸ¯ DeferredResultè¯¦è§£



### 2.1 ä»€ä¹ˆæ˜¯DeferredResult



**é€šä¿—ç†è§£**ï¼šDeferredResultå°±åƒä¸€ä¸ª"å–é¤ç‰Œ"

```
ä¼ ç»Ÿæ–¹å¼ï¼š
ä½  â†’ ç‚¹é¤ â†’ ç«™åœ¨æŸœå°ç­‰ â†’ æ‹¿åˆ°é¤ â†’ ç¦»å¼€
     â†‘________ä¸€ç›´å ç”¨æŸœå°________â†‘

DeferredResultæ–¹å¼ï¼š
ä½  â†’ ç‚¹é¤ â†’ æ‹¿åˆ°å–é¤ç‰Œ(DeferredResult) â†’ å»æ‰¾åº§ä½
              â†“
         å¨æˆ¿åšå¥½äº† â†’ å«å· â†’ ä½ æ¥å–é¤
```

**ä¸“ä¸šå®šä¹‰**ï¼šDeferredResultæ˜¯Spring MVCæä¾›çš„å¼‚æ­¥å¤„ç†å®¹å™¨ï¼Œå…è®¸åœ¨å…¶ä»–çº¿ç¨‹ä¸­è®¾ç½®è¿”å›ç»“æœã€‚

### 2.2 DeferredResultåŸºæœ¬ç”¨æ³•



**æœ€ç®€å•çš„ä¾‹å­**ï¼š
```java
@RestController
public class AsyncController {
    
    // æ¨¡æ‹Ÿè®¢å•å¤„ç†
    @GetMapping("/order/{id}")
    public DeferredResult<String> getOrder(@PathVariable Long id) {
        // åˆ›å»ºä¸€ä¸ª"å–é¤ç‰Œ"ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´5ç§’
        DeferredResult<String> result = new DeferredResult<>(5000L);
        
        // å¼‚æ­¥å¤„ç†è®¢å•ï¼ˆäº¤ç»™å…¶ä»–çº¿ç¨‹ï¼‰
        orderService.processOrder(id, orderResult -> {
            // è®¢å•å¤„ç†å®Œæˆåï¼Œé€šçŸ¥ç”¨æˆ·ï¼ˆè®¾ç½®ç»“æœï¼‰
            result.setResult("è®¢å•å¤„ç†å®Œæˆï¼š" + orderResult);
        });
        
        // ç«‹å³è¿”å›"å–é¤ç‰Œ"ï¼Œä¸é˜»å¡å½“å‰çº¿ç¨‹
        return result;
    }
}
```

**æ‰§è¡Œæµç¨‹å›¾**ï¼š
```
æµè§ˆå™¨è¯·æ±‚ â†’ Spring MVC Controller â†’ è¿”å›DeferredResult
    â†“                                      â†“
ç­‰å¾…å“åº”                              é‡Šæ”¾Servletçº¿ç¨‹
    â†“                                      â†“
    â†“                          ä¸šåŠ¡çº¿ç¨‹å¤„ç†è®¢å•ï¼ˆè€—æ—¶æ“ä½œï¼‰
    â†“                                      â†“
    â†“                            è°ƒç”¨ setResult() è®¾ç½®ç»“æœ
    â†“                                      â†“
æ”¶åˆ°å“åº” â† Spring MVC å®Œæˆå“åº” â† å®¹å™¨è·å–ç»“æœ
```

### 2.3 DeferredResultæ ¸å¿ƒAPI



**å¸¸ç”¨æ–¹æ³•è¯´æ˜**ï¼š

| æ–¹æ³• | **ä½œç”¨** | **ä½¿ç”¨åœºæ™¯** |
|-----|---------|-------------|
| `setResult(T result)` | `è®¾ç½®æˆåŠŸç»“æœ` | `ä¸šåŠ¡å¤„ç†å®Œæˆ` |
| `setErrorResult(Object result)` | `è®¾ç½®é”™è¯¯ç»“æœ` | `ä¸šåŠ¡å¤„ç†å¤±è´¥` |
| `onTimeout(Runnable callback)` | `è¶…æ—¶å›è°ƒ` | `å¤„ç†è¶…æ—¶æƒ…å†µ` |
| `onCompletion(Runnable callback)` | `å®Œæˆå›è°ƒ` | `æ¸…ç†èµ„æº` |
| `onError(Consumer<Throwable>)` | `å¼‚å¸¸å›è°ƒ` | `å¼‚å¸¸å¤„ç†` |

**å®æˆ˜ç¤ºä¾‹**ï¼š
```java
@GetMapping("/email/send")
public DeferredResult<String> sendEmail(@RequestParam String to) {
    DeferredResult<String> result = new DeferredResult<>(10000L);
    
    // è¶…æ—¶å¤„ç†
    result.onTimeout(() -> {
        result.setErrorResult("é‚®ä»¶å‘é€è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");
    });
    
    // å®Œæˆåæ¸…ç†èµ„æº
    result.onCompletion(() -> {
        log.info("é‚®ä»¶å‘é€è¯·æ±‚å¤„ç†å®Œæˆ");
    });
    
    // å¼‚å¸¸å¤„ç†
    result.onError(throwable -> {
        log.error("é‚®ä»¶å‘é€å¼‚å¸¸", throwable);
    });
    
    // å¼‚æ­¥å‘é€é‚®ä»¶
    emailService.sendAsync(to, result);
    
    return result;
}
```

### 2.4 DeferredResult vs ä¼ ç»Ÿæ–¹å¼å¯¹æ¯”



**æ€§èƒ½å¯¹æ¯”æ•°æ®**ï¼š
```
åœºæ™¯ï¼š1000ä¸ªå¹¶å‘è¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚è€—æ—¶2ç§’

ä¼ ç»ŸåŒæ­¥æ–¹å¼ï¼š
çº¿ç¨‹æ± ï¼š200ä¸ªçº¿ç¨‹
ååé‡ï¼š100è¯·æ±‚/ç§’
æ€»è€—æ—¶ï¼š10ç§’
çº¿ç¨‹åˆ©ç”¨ç‡ï¼š50%ï¼ˆç­‰å¾…æ—¶é—´å¤šï¼‰

DeferredResultå¼‚æ­¥æ–¹å¼ï¼š
çº¿ç¨‹æ± ï¼š200ä¸ªçº¿ç¨‹
ååé‡ï¼š500è¯·æ±‚/ç§’
æ€»è€—æ—¶ï¼š2ç§’
çº¿ç¨‹åˆ©ç”¨ç‡ï¼š90%ï¼ˆé«˜æ•ˆå¤ç”¨ï¼‰
```

---

## 3. ğŸ”„ Callableè¿”å›å€¼å¤„ç†



### 3.1 Callableæ˜¯ä»€ä¹ˆ



**ç”Ÿæ´»ç±»æ¯”**ï¼šCallableå°±åƒ"å¤–å–é…é€"

```
ä½ ä¸‹å• â†’ å•†å®¶æ¥å• â†’ éª‘æ‰‹é…é€ï¼ˆCallableä»»åŠ¡ï¼‰ â†’ é€åˆ°ä½ æ‰‹ä¸Š
        â†‘_____ä½ ä¸ç”¨ç®¡é…é€è¿‡ç¨‹_____â†‘

ä»£ç é‡Œï¼š
Controllerè¿”å›Callable â†’ Springæ¥ç®¡ â†’ çº¿ç¨‹æ± æ‰§è¡Œ â†’ è‡ªåŠ¨è¿”å›ç»“æœ
```

**ä¸DeferredResultçš„åŒºåˆ«**ï¼š

```
DeferredResultï¼ˆè‡ªå·±æ§åˆ¶ï¼‰ï¼š
ä½ è‡ªå·±å†³å®šä»€ä¹ˆæ—¶å€™è°ƒç”¨ setResult()ï¼Œåƒé¥æ§å™¨

Callableï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰ï¼š
Springè‡ªåŠ¨åœ¨çº¿ç¨‹æ± æ‰§è¡Œä½ çš„ä»£ç ï¼Œç„¶åè¿”å›ç»“æœ
```

### 3.2 CallableåŸºæœ¬ä½¿ç”¨



**ç®€å•ç¤ºä¾‹**ï¼š
```java
@RestController
public class CallableController {
    
    @GetMapping("/report")
    public Callable<String> generateReport() {
        return () -> {
            // è¿™æ®µä»£ç ä¼šåœ¨Springçš„çº¿ç¨‹æ± ä¸­æ‰§è¡Œ
            Thread.sleep(3000); // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
            return "æŠ¥è¡¨ç”Ÿæˆå®Œæˆï¼š" + new Date();
        };
    }
}
```

**æ‰§è¡Œè¿‡ç¨‹æ‹†è§£**ï¼š
```
æ­¥éª¤1ï¼šControlleræ–¹æ³•è¿”å›Callableå¯¹è±¡
       â†“
æ­¥éª¤2ï¼šSpringé‡Šæ”¾Servletå®¹å™¨çº¿ç¨‹
       â†“
æ­¥éª¤3ï¼šSpringä»çº¿ç¨‹æ± å–ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒCallable.call()
       â†“
æ­¥éª¤4ï¼šæ‰§è¡Œå®Œæˆåï¼ŒSpringè‡ªåŠ¨å°†ç»“æœå†™å…¥å“åº”
       â†“
æ­¥éª¤5ï¼šæµè§ˆå™¨æ”¶åˆ°å“åº”
```

### 3.3 Callableé«˜çº§ç”¨æ³•



**å¸¦å¼‚å¸¸å¤„ç†çš„å®Œæ•´ç¤ºä¾‹**ï¼š
```java
@GetMapping("/data/export")
public Callable<ResponseEntity<String>> exportData(@RequestParam String type) {
    return () -> {
        try {
            // è€—æ—¶çš„æ•°æ®å¯¼å‡ºæ“ä½œ
            String data = dataService.export(type);
            
            return ResponseEntity.ok()
                    .header("Content-Type", "text/csv")
                    .body(data);
                    
        } catch (Exception e) {
            log.error("æ•°æ®å¯¼å‡ºå¤±è´¥", e);
            return ResponseEntity.status(500)
                    .body("å¯¼å‡ºå¤±è´¥ï¼š" + e.getMessage());
        }
    };
}
```

### 3.4 DeferredResult vs Callable é€‰æ‹©æŒ‡å—



| ç»´åº¦ | **DeferredResult** | **Callable** |
|-----|-------------------|-------------|
| ğŸ¯ **æ§åˆ¶æ–¹å¼** | `æ‰‹åŠ¨æ§åˆ¶ç»“æœè®¾ç½®` | `è‡ªåŠ¨æ‰§è¡Œè¿”å›` |
| ğŸ§µ **çº¿ç¨‹ç®¡ç†** | `è‡ªå·±ç®¡ç†å¼‚æ­¥çº¿ç¨‹` | `Springçº¿ç¨‹æ± æ‰˜ç®¡` |
| â±ï¸ **å“åº”æ—¶æœº** | `ä»»æ„æ—¶åˆ»è°ƒç”¨setResult` | `call()æ–¹æ³•æ‰§è¡Œå®Œ` |
| ğŸ”§ **çµæ´»æ€§** | `é«˜ï¼ˆå®Œå…¨æ§åˆ¶ï¼‰` | `ä½ï¼ˆæ¡†æ¶æ‰˜ç®¡ï¼‰` |
| ğŸ’¡ **é€‚ç”¨åœºæ™¯** | `æ¶ˆæ¯é˜Ÿåˆ—ã€äº‹ä»¶é©±åŠ¨` | `ç‹¬ç«‹è€—æ—¶ä»»åŠ¡` |

**å¿«é€Ÿé€‰æ‹©å†³ç­–**ï¼š
```
ä½¿ç”¨ Callable å¦‚æœï¼š
âœ… ä»»åŠ¡å¯ä»¥åœ¨ä¸€ä¸ªæ–¹æ³•é‡Œå®Œæˆ
âœ… ä¸éœ€è¦å¤–éƒ¨äº‹ä»¶è§¦å‘
âœ… ç®€å•çš„å¼‚æ­¥æ‰§è¡Œå°±å¤Ÿäº†

ä½¿ç”¨ DeferredResult å¦‚æœï¼š
âœ… éœ€è¦ç­‰å¾…å¤–éƒ¨äº‹ä»¶ï¼ˆæ¶ˆæ¯ã€å›è°ƒï¼‰
âœ… ç»“æœç”±å…¶ä»–ç»„ä»¶äº§ç”Ÿ
âœ… éœ€è¦ç²¾ç¡®æ§åˆ¶ä½•æ—¶è¿”å›
```

---

## 4. âš™ï¸ å¼‚æ­¥ServletåŸç†



### 4.1 Servlet 3.0å¼‚æ­¥æ”¯æŒ



**å†å²èƒŒæ™¯**ï¼š
```
Servlet 2.x æ—¶ä»£ï¼š
è¯·æ±‚ â†’ Servletçº¿ç¨‹ â†’ å¤„ç†å®Œæ‰é‡Šæ”¾ â†’ å“åº”
        â†‘________çº¿ç¨‹ä¸€ç›´å ç”¨________â†‘

Servlet 3.0 å¼€å§‹ï¼š
è¯·æ±‚ â†’ å¯åŠ¨å¼‚æ­¥ â†’ é‡Šæ”¾çº¿ç¨‹ â†’ å…¶ä»–çº¿ç¨‹å¤„ç† â†’ å“åº”
        â†‘____ç«‹å³é‡Šæ”¾____â†‘    â†‘____æ–°çº¿ç¨‹å·¥ä½œ____â†‘
```

**å…³é”®APIä»‹ç»**ï¼š
- `@WebServlet(asyncSupported = true)` - å¯ç”¨å¼‚æ­¥æ”¯æŒ
- `request.startAsync()` - å¼€å¯å¼‚æ­¥å¤„ç†
- `AsyncContext` - å¼‚æ­¥ä¸Šä¸‹æ–‡å¯¹è±¡

### 4.2 Spring MVCçš„å¼‚æ­¥å®ç°



**Springå¯¹Servletå¼‚æ­¥çš„å°è£…**ï¼š
```
åº•å±‚æœºåˆ¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Spring MVC DispatcherServlet       â”‚
â”‚  â†“                                  â”‚
â”‚  æ£€æµ‹åˆ° DeferredResult/Callable     â”‚
â”‚  â†“                                  â”‚
â”‚  è°ƒç”¨ request.startAsync()          â”‚
â”‚  â†“                                  â”‚
â”‚  é‡Šæ”¾ Servlet å®¹å™¨çº¿ç¨‹              â”‚
â”‚  â†“                                  â”‚
â”‚  ç­‰å¾…ç»“æœè®¾ç½®                        â”‚
â”‚  â†“                                  â”‚
â”‚  asyncContext.complete() å®Œæˆå“åº”   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®è¦æ±‚**ï¼š
```java
// Spring Boot è‡ªåŠ¨é…ç½®å¼‚æ­¥æ”¯æŒ
// ä¼ ç»ŸSpring MVCéœ€è¦é…ç½®ï¼š

@Configuration
@EnableWebMvc
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void configureAsyncSupport(AsyncSupportConfigurer configurer) {
        // è®¾ç½®é»˜è®¤è¶…æ—¶æ—¶é—´
        configurer.setDefaultTimeout(30000);
        
        // è®¾ç½®å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå™¨
        configurer.setTaskExecutor(taskExecutor());
    }
    
    @Bean
    public ThreadPoolTaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(50);
        executor.setQueueCapacity(200);
        executor.setThreadNamePrefix("async-");
        return executor;
    }
}
```

---

## 5. ğŸ”— é•¿è¿æ¥å¤„ç†æŠ€æœ¯



### 5.1 ä»€ä¹ˆæ˜¯é•¿è¿æ¥



**ä¼ ç»ŸçŸ­è¿æ¥ vs é•¿è¿æ¥**ï¼š
```
çŸ­è¿æ¥ï¼ˆä¼ ç»ŸHTTPï¼‰ï¼š
å®¢æˆ·ç«¯ â†’ è¯·æ±‚ â†’ æœåŠ¡å™¨ â†’ å“åº” â†’ æ–­å¼€
        â†‘_______ä¸€é—®ä¸€ç­”_______â†‘

é•¿è¿æ¥ï¼ˆLong Polling/SSEï¼‰ï¼š
å®¢æˆ·ç«¯ â†’ è¯·æ±‚ â†’ æœåŠ¡å™¨ä¿æŒè¿æ¥ â†’ æœ‰æ•°æ®å°±æ¨é€
        â†‘_________è¿æ¥ä¿æŒæ‰“å¼€_________â†‘
```

### 5.2 é•¿è½®è¯¢ï¼ˆLong Pollingï¼‰å®ç°



**åŸç†è¯´æ˜**ï¼šå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¸ç«‹å³å“åº”ï¼Œç­‰åˆ°æœ‰æ–°æ•°æ®æ‰è¿”å›

```java
@RestController
public class LongPollingController {
    
    // å­˜å‚¨å¾…å¤„ç†çš„è¯·æ±‚
    private final Map<String, DeferredResult<String>> pollingRequests = 
        new ConcurrentHashMap<>();
    
    // å®¢æˆ·ç«¯é•¿è½®è¯¢è¯·æ±‚
    @GetMapping("/polling/message")
    public DeferredResult<String> longPolling(@RequestParam String userId) {
        DeferredResult<String> result = new DeferredResult<>(30000L);
        
        // è¶…æ—¶è¿”å›ç©ºæ¶ˆæ¯
        result.onTimeout(() -> {
            pollingRequests.remove(userId);
            result.setResult("æ— æ–°æ¶ˆæ¯");
        });
        
        // ä¿å­˜è¯·æ±‚ï¼Œç­‰å¾…æ¨é€
        pollingRequests.put(userId, result);
        
        return result;
    }
    
    // æ¨é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·
    @PostMapping("/push/message")
    public String pushMessage(@RequestParam String userId, 
                             @RequestParam String message) {
        DeferredResult<String> result = pollingRequests.remove(userId);
        if (result != null) {
            result.setResult(message);
            return "æ¨é€æˆåŠŸ";
        }
        return "ç”¨æˆ·ä¸åœ¨çº¿";
    }
}
```

**åº”ç”¨åœºæ™¯**ï¼š
```
ğŸ’¬ å³æ—¶èŠå¤©ï¼šç­‰å¾…å¯¹æ–¹å›å¤æ¶ˆæ¯
ğŸ“¢ é€šçŸ¥ç³»ç»Ÿï¼šç­‰å¾…ç³»ç»Ÿé€šçŸ¥
ğŸ“Š æ•°æ®ç›‘æ§ï¼šç­‰å¾…æ•°æ®æ›´æ–°
ğŸ« è®¢å•çŠ¶æ€ï¼šç­‰å¾…è®¢å•å˜åŒ–
```

### 5.3 SSEï¼ˆServer-Sent Eventsï¼‰å®ç°



**SSEæ˜¯ä»€ä¹ˆ**ï¼šæœåŠ¡å™¨ä¸»åŠ¨å‘æµè§ˆå™¨æ¨é€æ•°æ®çš„æŠ€æœ¯

```java
@GetMapping(value = "/sse/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public SseEmitter streamEvents() {
    SseEmitter emitter = new SseEmitter(0L); // 0è¡¨ç¤ºæ°¸ä¸è¶…æ—¶
    
    // å¼‚æ­¥å‘é€äº‹ä»¶
    executorService.execute(() -> {
        try {
            for (int i = 0; i < 10; i++) {
                // å‘é€æ•°æ®åˆ°å®¢æˆ·ç«¯
                emitter.send("æ•°æ®æ¨é€ï¼š" + i);
                Thread.sleep(1000);
            }
            emitter.complete(); // å®Œæˆæ¨é€
        } catch (Exception e) {
            emitter.completeWithError(e);
        }
    });
    
    return emitter;
}
```

**å‰ç«¯æ¥æ”¶ä»£ç **ï¼š
```javascript
// æµè§ˆå™¨ç«¯ç›‘å¬SSE
const eventSource = new EventSource('/sse/stream');

eventSource.onmessage = function(event) {
    console.log('æ”¶åˆ°æ¨é€ï¼š', event.data);
};

eventSource.onerror = function(error) {
    console.error('è¿æ¥é”™è¯¯', error);
    eventSource.close();
};
```

---

## 6. â±ï¸ è¶…æ—¶é…ç½®ä¸ç®¡ç†



### 6.1 ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶æ§åˆ¶



**ä¸è®¾ç½®è¶…æ—¶çš„é£é™©**ï¼š
```
âŒ èµ„æºè€—å°½ï¼šå¤§é‡è¯·æ±‚æŒ‚èµ·ï¼Œå ç”¨è¿æ¥
âŒ å†…å­˜æ³„æ¼ï¼šDeferredResultå¯¹è±¡æ— æ³•é‡Šæ”¾
âŒ ç”¨æˆ·ä½“éªŒå·®ï¼šæµè§ˆå™¨æ— é™ç­‰å¾…
```

### 6.2 è¶…æ—¶é…ç½®æ–¹å¼



**æ–¹å¼ä¸€ï¼šDeferredResultæ„é€ å™¨**
```java
// è®¾ç½®5ç§’è¶…æ—¶
DeferredResult<String> result = new DeferredResult<>(5000L);
```

**æ–¹å¼äºŒï¼šå…¨å±€é…ç½®**
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Override
    public void configureAsyncSupport(AsyncSupportConfigurer configurer) {
        configurer.setDefaultTimeout(30000L); // 30ç§’
    }
}
```

**æ–¹å¼ä¸‰ï¼šapplication.ymlé…ç½®**
```yaml
spring:
  mvc:
    async:
      request-timeout: 30000 # 30ç§’
```

### 6.3 è¶…æ—¶å¤„ç†ç­–ç•¥



**å®Œæ•´çš„è¶…æ—¶å¤„ç†ç¤ºä¾‹**ï¼š
```java
@GetMapping("/timeout/demo")
public DeferredResult<String> timeoutDemo() {
    DeferredResult<String> result = new DeferredResult<>(3000L);
    
    // è¶…æ—¶å›è°ƒ
    result.onTimeout(() -> {
        log.warn("è¯·æ±‚è¶…æ—¶");
        result.setErrorResult(
            ResponseEntity.status(HttpStatus.REQUEST_TIMEOUT)
                .body("å¤„ç†è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•")
        );
    });
    
    // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    taskExecutor.execute(() -> {
        try {
            Thread.sleep(5000); // æ•…æ„è¶…è¿‡è¶…æ—¶æ—¶é—´
            result.setResult("å¤„ç†å®Œæˆ");
        } catch (Exception e) {
            if (!result.isSetOrExpired()) {
                result.setErrorResult("å¤„ç†å¼‚å¸¸");
            }
        }
    });
    
    return result;
}
```

**è¶…æ—¶æ—¶é—´è®¾ç½®å»ºè®®**ï¼š

| åœºæ™¯ç±»å‹ | **æ¨èè¶…æ—¶** | **è¯´æ˜** |
|---------|-------------|---------|
| ğŸš€ **å¿«é€ŸæŸ¥è¯¢** | `3-5ç§’` | `æ•°æ®åº“æŸ¥è¯¢ã€ç¼“å­˜è¯»å–` |
| ğŸ“Š **æŠ¥è¡¨ç”Ÿæˆ** | `30-60ç§’` | `å¤æ‚è®¡ç®—ã€æ•°æ®å¯¼å‡º` |
| ğŸ“¨ **æ¶ˆæ¯æ¨é€** | `2-5åˆ†é’Ÿ` | `é•¿è½®è¯¢ã€å®æ—¶é€šçŸ¥` |
| ğŸ“¡ **SSEæµ** | `æ— é™åˆ¶æˆ–å¾ˆé•¿` | `å®æ—¶æ•°æ®æµ` |

---

## 7. ğŸ›¡ï¸ å¼‚æ­¥æ‹¦æˆªå™¨æœºåˆ¶



### 7.1 ä»€ä¹ˆæ˜¯å¼‚æ­¥æ‹¦æˆªå™¨



**æ™®é€šæ‹¦æˆªå™¨çš„å±€é™**ï¼š
```
æ™®é€šæ‹¦æˆªå™¨ï¼š
è¯·æ±‚è¿›å…¥ â†’ preHandle â†’ Controller â†’ postHandle â†’ å“åº”
           â†‘_______________åªèƒ½æ‹¦æˆªåŒæ­¥æµç¨‹_______________â†‘

å¼‚æ­¥æ‹¦æˆªå™¨ï¼š
è¯·æ±‚è¿›å…¥ â†’ preHandle â†’ è¿”å›DeferredResult â†’ å¼‚æ­¥å¤„ç† â†’ å“åº”
           â†‘________å¯ä»¥ç›‘å¬æ•´ä¸ªå¼‚æ­¥ç”Ÿå‘½å‘¨æœŸ________â†‘
```

### 7.2 AsyncHandlerInterceptoræ¥å£



**æ ¸å¿ƒæ–¹æ³•è¯´æ˜**ï¼š
```java
public interface AsyncHandlerInterceptor extends HandlerInterceptor {
    
    // å¼‚æ­¥å¤„ç†å¼€å§‹åè°ƒç”¨
    void afterConcurrentHandlingStarted(
        HttpServletRequest request,
        HttpServletResponse response,
        Object handler
    );
}
```

**å®ç°ç¤ºä¾‹**ï¼š
```java
@Component
public class AsyncLoggingInterceptor implements AsyncHandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) {
        log.info("è¯·æ±‚å¼€å§‹ï¼š{}", request.getRequestURI());
        request.setAttribute("startTime", System.currentTimeMillis());
        return true;
    }
    
    @Override
    public void afterConcurrentHandlingStarted(HttpServletRequest request,
                                               HttpServletResponse response,
                                               Object handler) {
        long startTime = (long) request.getAttribute("startTime");
        log.info("å¼‚æ­¥å¤„ç†å¼€å§‹ï¼Œå·²è€—æ—¶ï¼š{}ms", 
            System.currentTimeMillis() - startTime);
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request,
                               HttpServletResponse response,
                               Object handler,
                               Exception ex) {
        long startTime = (long) request.getAttribute("startTime");
        log.info("è¯·æ±‚å®Œæˆï¼Œæ€»è€—æ—¶ï¼š{}ms", 
            System.currentTimeMillis() - startTime);
    }
}
```

**æ³¨å†Œæ‹¦æˆªå™¨**ï¼š
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Autowired
    private AsyncLoggingInterceptor asyncLoggingInterceptor;
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(asyncLoggingInterceptor)
                .addPathPatterns("/api/**");
    }
}
```

### 7.3 CallableProcessingInterceptor



**ä¸“é—¨å¤„ç†Callableçš„æ‹¦æˆªå™¨**ï¼š
```java
@Component
public class CallableInterceptor implements CallableProcessingInterceptor {
    
    @Override
    public <T> void beforeConcurrentHandling(NativeWebRequest request,
                                             Callable<T> task) {
        log.info("Callableä»»åŠ¡å³å°†æ‰§è¡Œ");
    }
    
    @Override
    public <T> void afterCompletion(NativeWebRequest request,
                                    Callable<T> task) {
        log.info("Callableä»»åŠ¡æ‰§è¡Œå®Œæˆ");
    }
    
    @Override
    public <T> Object handleTimeout(NativeWebRequest request,
                                    Callable<T> task) {
        log.error("Callableä»»åŠ¡è¶…æ—¶");
        return "ä»»åŠ¡æ‰§è¡Œè¶…æ—¶";
    }
}
```

---

## 8. ğŸŠ çº¿ç¨‹æ± é…ç½®ä¼˜åŒ–



### 8.1 ä¸ºä»€ä¹ˆéœ€è¦é…ç½®çº¿ç¨‹æ± 



**é»˜è®¤é…ç½®çš„é—®é¢˜**ï¼š
```
Springé»˜è®¤ä½¿ç”¨SimpleAsyncTaskExecutorï¼š
âŒ æ¯ä¸ªä»»åŠ¡åˆ›å»ºæ–°çº¿ç¨‹ï¼ˆæ— å¤ç”¨ï¼‰
âŒ æ²¡æœ‰çº¿ç¨‹æ•°é™åˆ¶ï¼ˆå¯èƒ½è€—å°½èµ„æºï¼‰
âŒ æ²¡æœ‰é˜Ÿåˆ—æœºåˆ¶ï¼ˆæ‹’ç»ç­–ç•¥ä¸å‹å¥½ï¼‰
```

### 8.2 è‡ªå®šä¹‰çº¿ç¨‹æ± é…ç½®



**å®Œæ•´é…ç½®ç¤ºä¾‹**ï¼š
```java
@Configuration
public class AsyncConfig {
    
    @Bean(name = "asyncExecutor")
    public ThreadPoolTaskExecutor asyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        
        // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šå§‹ç»ˆä¿æŒçš„çº¿ç¨‹æ•°é‡
        executor.setCorePoolSize(10);
        
        // æœ€å¤§çº¿ç¨‹æ•°ï¼šçº¿ç¨‹æ± èƒ½åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°
        executor.setMaxPoolSize(50);
        
        // é˜Ÿåˆ—å®¹é‡ï¼šå½“æ ¸å¿ƒçº¿ç¨‹éƒ½åœ¨å¿™ï¼Œæ–°ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—
        executor.setQueueCapacity(200);
        
        // çº¿ç¨‹åç§°å‰ç¼€ï¼šä¾¿äºæ’æŸ¥é—®é¢˜
        executor.setThreadNamePrefix("async-task-");
        
        // æ‹’ç»ç­–ç•¥ï¼šé˜Ÿåˆ—æ»¡äº†æ€ä¹ˆåŠ
        executor.setRejectedExecutionHandler(
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
        
        // çº¿ç¨‹ç©ºé—²æ—¶é—´ï¼šè¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ï¼Œç©ºé—²å¤šä¹…åå›æ”¶
        executor.setKeepAliveSeconds(60);
        
        // ç­‰å¾…ä»»åŠ¡å®Œæˆåå…³é—­çº¿ç¨‹æ± 
        executor.setWaitForTasksToCompleteOnShutdown(true);
        
        // ç­‰å¾…æ—¶é—´
        executor.setAwaitTerminationSeconds(60);
        
        executor.initialize();
        return executor;
    }
}
```

### 8.3 çº¿ç¨‹æ± å‚æ•°è°ƒä¼˜æŒ‡å—



**å‚æ•°è®¾ç½®åŸåˆ™**ï¼š

```
æ ¸å¿ƒçº¿ç¨‹æ•°è®¡ç®—å…¬å¼ï¼š
â€¢ CPUå¯†é›†å‹ï¼šæ ¸å¿ƒæ•° + 1
â€¢ IOå¯†é›†å‹ï¼šæ ¸å¿ƒæ•° Ã— 2
â€¢ æ··åˆå‹ï¼šæ ¹æ®å®é™…æµ‹è¯•è°ƒæ•´

æœ€å¤§çº¿ç¨‹æ•°è®¾ç½®ï¼š
â€¢ ä¸€èˆ¬æ˜¯æ ¸å¿ƒçº¿ç¨‹æ•°çš„ 2-4 å€
â€¢ é¿å…è®¾ç½®è¿‡å¤§å¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€

é˜Ÿåˆ—å®¹é‡é€‰æ‹©ï¼š
â€¢ æœ‰ç•Œé˜Ÿåˆ—ï¼šé˜²æ­¢å†…å­˜æº¢å‡ºï¼ˆæ¨èï¼‰
â€¢ æ— ç•Œé˜Ÿåˆ—ï¼šå¯èƒ½å¯¼è‡´OOM
â€¢ å»ºè®®ï¼š100-500ä¹‹é—´
```

**å®æˆ˜è°ƒä¼˜ç¤ºä¾‹**ï¼š
```java
// åœºæ™¯ï¼šç”µå•†è®¢å•å¤„ç†ç³»ç»Ÿ
@Bean(name = "orderExecutor")
public ThreadPoolTaskExecutor orderExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    
    // æœåŠ¡å™¨8æ ¸CPUï¼ŒIOå¯†é›†å‹ä»»åŠ¡
    executor.setCorePoolSize(16);      // 8 Ã— 2
    executor.setMaxPoolSize(64);       // 16 Ã— 4
    executor.setQueueCapacity(300);    // æ ¹æ®ä¸šåŠ¡é‡
    executor.setThreadNamePrefix("order-");
    
    // æ‹’ç»ç­–ç•¥ï¼šè®°å½•æ—¥å¿—å¹¶æŠ›å‡ºå¼‚å¸¸
    executor.setRejectedExecutionHandler((r, e) -> {
        log.error("è®¢å•å¤„ç†çº¿ç¨‹æ± å·²æ»¡ï¼Œæ‹’ç»ä»»åŠ¡");
        throw new RejectedExecutionException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    });
    
    executor.initialize();
    return executor;
}
```

### 8.4 ç›‘æ§çº¿ç¨‹æ± çŠ¶æ€



**çº¿ç¨‹æ± ç›‘æ§å·¥å…·ç±»**ï¼š
```java
@Component
public class ThreadPoolMonitor {
    
    @Autowired
    @Qualifier("asyncExecutor")
    private ThreadPoolTaskExecutor executor;
    
    // å®šæ—¶ç›‘æ§çº¿ç¨‹æ± çŠ¶æ€
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œ
    public void monitor() {
        ThreadPoolExecutor pool = executor.getThreadPoolExecutor();
        
        log.info("==== çº¿ç¨‹æ± ç›‘æ§ ====");
        log.info("æ ¸å¿ƒçº¿ç¨‹æ•°ï¼š{}", pool.getCorePoolSize());
        log.info("å½“å‰çº¿ç¨‹æ•°ï¼š{}", pool.getPoolSize());
        log.info("æ´»è·ƒçº¿ç¨‹æ•°ï¼š{}", pool.getActiveCount());
        log.info("é˜Ÿåˆ—å¤§å°ï¼š{}", pool.getQueue().size());
        log.info("å·²å®Œæˆä»»åŠ¡ï¼š{}", pool.getCompletedTaskCount());
        log.info("æ€»ä»»åŠ¡æ•°ï¼š{}", pool.getTaskCount());
    }
}
```

---

## 9. âš ï¸ å¼‚æ­¥å¼‚å¸¸å¤„ç†



### 9.1 å¼‚æ­¥å¼‚å¸¸çš„ç‰¹æ®Šæ€§



**åŒæ­¥å¼‚å¸¸ vs å¼‚æ­¥å¼‚å¸¸**ï¼š
```
åŒæ­¥å¼‚å¸¸ï¼š
ControlleræŠ›å¼‚å¸¸ â†’ @ExceptionHandleræ•è· â†’ è¿”å›é”™è¯¯å“åº”
           â†‘___________å¼‚å¸¸åœ¨å½“å‰çº¿ç¨‹_________â†‘

å¼‚æ­¥å¼‚å¸¸ï¼š
Controllerè¿”å›DeferredResult â†’ é‡Šæ”¾çº¿ç¨‹ â†’ å¼‚æ­¥çº¿ç¨‹æŠ›å¼‚å¸¸ï¼Ÿ
                               â†‘_______å¼‚å¸¸åœ¨å…¶ä»–çº¿ç¨‹_______â†‘
é—®é¢˜ï¼š@ExceptionHandleræ•è·ä¸åˆ°ï¼
```

### 9.2 DeferredResultå¼‚å¸¸å¤„ç†



**æ–¹å¼ä¸€ï¼šsetErrorResult()**
```java
@GetMapping("/order/create")
public DeferredResult<String> createOrder(@RequestParam Long productId) {
    DeferredResult<String> result = new DeferredResult<>(5000L);
    
    orderService.createAsync(productId, new OrderCallback() {
        @Override
        public void onSuccess(String orderId) {
            result.setResult("è®¢å•åˆ›å»ºæˆåŠŸï¼š" + orderId);
        }
        
        @Override
        public void onError(Exception e) {
            // è®¾ç½®é”™è¯¯ç»“æœ
            result.setErrorResult(
                ResponseEntity.status(500)
                    .body("è®¢å•åˆ›å»ºå¤±è´¥ï¼š" + e.getMessage())
            );
        }
    });
    
    return result;
}
```

**æ–¹å¼äºŒï¼šonErrorå›è°ƒ**
```java
@GetMapping("/payment/process")
public DeferredResult<String> processPayment(@RequestParam String orderId) {
    DeferredResult<String> result = new DeferredResult<>(10000L);
    
    // æ³¨å†Œå¼‚å¸¸å›è°ƒ
    result.onError(throwable -> {
        log.error("æ”¯ä»˜å¤„ç†å¼‚å¸¸", throwable);
        if (throwable instanceof TimeoutException) {
            result.setResult("æ”¯ä»˜è¶…æ—¶");
        } else {
            result.setResult("æ”¯ä»˜å¤±è´¥ï¼š" + throwable.getMessage());
        }
    });
    
    // å¼‚æ­¥å¤„ç†æ”¯ä»˜
    paymentService.processAsync(orderId, result);
    
    return result;
}
```

### 9.3 Callableå¼‚å¸¸å¤„ç†



**Callableçš„å¼‚å¸¸ä¼šè‡ªåŠ¨ä¼ æ’­**ï¼š
```java
@RestController
@ControllerAdvice
public class AsyncExceptionHandler {
    
    // è¿™ä¸ªå¯ä»¥æ•è·CallableæŠ›å‡ºçš„å¼‚å¸¸
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<String> handleBusinessException(BusinessException e) {
        log.error("ä¸šåŠ¡å¼‚å¸¸", e);
        return ResponseEntity.status(400).body(e.getMessage());
    }
    
    // Callableç¤ºä¾‹
    @GetMapping("/data/process")
    public Callable<String> processData() {
        return () -> {
            // è¿™é‡Œçš„å¼‚å¸¸ä¼šè¢«ä¸Šé¢çš„@ExceptionHandleræ•è·
            if (someCondition) {
                throw new BusinessException("æ•°æ®å¤„ç†å¤±è´¥");
            }
            return "å¤„ç†æˆåŠŸ";
        };
    }
}
```

### 9.4 ç»Ÿä¸€å¼‚æ­¥å¼‚å¸¸å¤„ç†



**å°è£…å¼‚æ­¥å¤„ç†å·¥å…·ç±»**ï¼š
```java
@Component
public class AsyncResultBuilder {
    
    public <T> DeferredResult<ResponseEntity<T>> build(
            long timeout,
            AsyncTask<T> task) {
        
        DeferredResult<ResponseEntity<T>> result = 
            new DeferredResult<>(timeout);
        
        // è¶…æ—¶å¤„ç†
        result.onTimeout(() -> {
            result.setResult(
                ResponseEntity.status(HttpStatus.REQUEST_TIMEOUT)
                    .body(null)
            );
        });
        
        // å¼‚å¸¸å¤„ç†
        result.onError(throwable -> {
            log.error("å¼‚æ­¥ä»»åŠ¡å¼‚å¸¸", throwable);
            result.setResult(
                ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(null)
            );
        });
        
        // æ‰§è¡Œä»»åŠ¡
        taskExecutor.execute(() -> {
            try {
                T data = task.execute();
                result.setResult(ResponseEntity.ok(data));
            } catch (Exception e) {
                result.setErrorResult(e);
            }
        });
        
        return result;
    }
    
    @FunctionalInterface
    public interface AsyncTask<T> {
        T execute() throws Exception;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@RestController
public class UserController {
    
    @Autowired
    private AsyncResultBuilder asyncBuilder;
    
    @GetMapping("/user/{id}")
    public DeferredResult<ResponseEntity<User>> getUser(@PathVariable Long id) {
        return asyncBuilder.build(5000L, () -> userService.findById(id));
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ å¼‚æ­¥å¤„ç†æœ¬è´¨ï¼šé‡Šæ”¾Servletçº¿ç¨‹ï¼Œæé«˜å¹¶å‘èƒ½åŠ›
ğŸ”¸ DeferredResultï¼šæ‰‹åŠ¨æ§åˆ¶ç»“æœè®¾ç½®ï¼Œé€‚åˆäº‹ä»¶é©±åŠ¨
ğŸ”¸ Callableï¼šè‡ªåŠ¨æ‰§è¡Œå¹¶è¿”å›ï¼Œé€‚åˆç‹¬ç«‹ä»»åŠ¡
ğŸ”¸ çº¿ç¨‹æ± é…ç½®ï¼šåˆç†é…ç½®å‚æ•°ï¼Œé¿å…èµ„æºè€—å°½
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šå¼‚æ­¥å¼‚å¸¸éœ€è¦ç‰¹æ®Šå¤„ç†æœºåˆ¶
```

### 10.2 æŠ€æœ¯é€‰å‹å†³ç­–æ ‘



```
éœ€è¦å¼‚æ­¥å¤„ç†ï¼Ÿ
   â”‚
   â”œâ”€ å¦ â†’ ä½¿ç”¨ä¼ ç»ŸåŒæ­¥Controller
   â”‚
   â””â”€ æ˜¯ â†’ åˆ¤æ–­åœºæ™¯
           â”‚
           â”œâ”€ ç‹¬ç«‹ä»»åŠ¡ï¼Œå¯åœ¨ä¸€ä¸ªæ–¹æ³•å®Œæˆ
           â”‚  â†’ ä½¿ç”¨ Callable
           â”‚
           â”œâ”€ éœ€è¦ç­‰å¾…å¤–éƒ¨äº‹ä»¶ï¼ˆæ¶ˆæ¯ã€å›è°ƒï¼‰
           â”‚  â†’ ä½¿ç”¨ DeferredResult
           â”‚
           â”œâ”€ éœ€è¦æŒç»­æ¨é€æ•°æ®
           â”‚  â†’ ä½¿ç”¨ SseEmitter
           â”‚
           â””â”€ éœ€è¦åŒå‘é€šä¿¡
              â†’ è€ƒè™‘ WebSocketï¼ˆè¶…å‡ºæœ¬ç« èŒƒå›´ï¼‰
```

### 10.3 æ€§èƒ½ä¼˜åŒ–æ¸…å•



**âœ… å¿…åšä¼˜åŒ–**ï¼š
```
ğŸ”¸ é…ç½®åˆé€‚çš„çº¿ç¨‹æ± ï¼ˆé¿å…ä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
ğŸ”¸ è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼ˆé˜²æ­¢èµ„æºæ³„æ¼ï¼‰
ğŸ”¸ å®ç°å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼ˆä¿è¯ç³»ç»Ÿç¨³å®šï¼‰
ğŸ”¸ æ·»åŠ ç›‘æ§å’Œæ—¥å¿—ï¼ˆä¾¿äºé—®é¢˜æ’æŸ¥ï¼‰
```

**âš ï¸ å¸¸è§é™·é˜±**ï¼š
```
âŒ å¿˜è®°è®¾ç½®è¶…æ—¶æ—¶é—´
âŒ å¼‚æ­¥ä»»åŠ¡ä¸­è®¿é—®request/sessionï¼ˆå¯èƒ½å·²å¤±æ•ˆï¼‰
âŒ çº¿ç¨‹æ± å‚æ•°é…ç½®ä¸å½“
âŒ æ²¡æœ‰å¤„ç†å¼‚æ­¥å¼‚å¸¸
âŒ è¿‡åº¦ä½¿ç”¨å¼‚æ­¥ï¼ˆç®€å•ä»»åŠ¡åè€Œé™ä½æ€§èƒ½ï¼‰
```

### 10.4 å®æˆ˜åº”ç”¨å»ºè®®



**é€‚åˆå¼‚æ­¥å¤„ç†çš„åœºæ™¯**ï¼š
```
âœ… è°ƒç”¨ç¬¬ä¸‰æ–¹APIï¼šæ”¯ä»˜ã€çŸ­ä¿¡ã€é‚®ä»¶
âœ… å¤§æ•°æ®é‡æ“ä½œï¼šæŠ¥è¡¨ç”Ÿæˆã€æ•°æ®å¯¼å‡º
âœ… é•¿æ—¶é—´è®¡ç®—ï¼šå¤æ‚ç®—æ³•ã€å›¾åƒå¤„ç†
âœ… å®æ—¶æ¨é€ï¼šé€šçŸ¥ã€æ¶ˆæ¯ã€ç›‘æ§æ•°æ®
```

**ä»£ç ç¤ºä¾‹å¯¹æ¯”**ï¼š
```java
// âŒ ä¸å¥½çš„åšæ³•ï¼šç®€å•æŸ¥è¯¢ä¹Ÿç”¨å¼‚æ­¥
@GetMapping("/user/{id}")
public Callable<User> getUser(@PathVariable Long id) {
    return () -> userService.findById(id); // æ¯«ç§’çº§æ“ä½œï¼Œæ²¡å¿…è¦å¼‚æ­¥
}

// âœ… å¥½çš„åšæ³•ï¼šè€—æ—¶æ“ä½œæ‰ç”¨å¼‚æ­¥
@GetMapping("/report/monthly")
public DeferredResult<Report> generateReport() {
    DeferredResult<Report> result = new DeferredResult<>(60000L);
    // æŠ¥è¡¨ç”Ÿæˆå¯èƒ½éœ€è¦å‡ åç§’ï¼Œé€‚åˆå¼‚æ­¥
    reportService.generateAsync(result);
    return result;
}
```

### 10.5 å¿«é€Ÿè®°å¿†å£è¯€



```
å¼‚æ­¥å¤„ç†è§£æ”¾çº¿ç¨‹ï¼ŒDeferredResultæ‰‹åŠ¨æ§
Callableè‡ªåŠ¨æ‰§è¡Œå®Œï¼Œçº¿ç¨‹æ± é…ç½®è¦è®°ç‰¢
è¶…æ—¶è®¾ç½®é˜²æ³„æ¼ï¼Œå¼‚å¸¸å¤„ç†ä¿ç¨³å®š
é•¿è¿æ¥æ¨é€ç”¨SSEï¼Œç›‘æ§æ—¥å¿—ä¸èƒ½å°‘
```

---

# ğŸ“ å­¦ä¹ å»ºè®®



**å¾ªåºæ¸è¿›çš„å­¦ä¹ è·¯å¾„**ï¼š
1. å…ˆç†è§£åŒæ­¥vså¼‚æ­¥çš„åŒºåˆ«ï¼ˆæ¦‚å¿µï¼‰
2. æŒæ¡DeferredResultåŸºæœ¬ç”¨æ³•ï¼ˆå®è·µï¼‰
3. å­¦ä¹ Callableçš„ä½¿ç”¨åœºæ™¯ï¼ˆå¯¹æ¯”ï¼‰
4. æ·±å…¥çº¿ç¨‹æ± é…ç½®ä¼˜åŒ–ï¼ˆè¿›é˜¶ï¼‰
5. å®Œå–„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼ˆå®Œå–„ï¼‰

**å®æˆ˜ç»ƒä¹ å»ºè®®**ï¼š
```
ğŸ”¸ å®ç°ä¸€ä¸ªé‚®ä»¶å‘é€æ¥å£ï¼ˆDeferredResultï¼‰
ğŸ”¸ å¼€å‘ä¸€ä¸ªæŠ¥è¡¨ç”ŸæˆåŠŸèƒ½ï¼ˆCallableï¼‰
ğŸ”¸ æ­å»ºä¸€ä¸ªæ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼ˆSSEï¼‰
ğŸ”¸ é…ç½®å’Œç›‘æ§çº¿ç¨‹æ± ï¼ˆè¿ç»´ï¼‰
```

**å‚è€ƒèµ„æº**ï¼š
- Springå®˜æ–¹æ–‡æ¡£ï¼šSpring MVC Async Support
- Servlet 3.0è§„èŒƒï¼šå¼‚æ­¥å¤„ç†ç« èŠ‚
- Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜ï¼šçº¿ç¨‹æ± ç« èŠ‚