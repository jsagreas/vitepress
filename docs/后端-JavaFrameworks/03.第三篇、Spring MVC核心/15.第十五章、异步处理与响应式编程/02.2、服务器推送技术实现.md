---
title: 2ã€æœåŠ¡å™¨æ¨é€æŠ€æœ¯å®ç°
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯æœåŠ¡å™¨æ¨é€æŠ€æœ¯](#1-ä»€ä¹ˆæ˜¯æœåŠ¡å™¨æ¨é€æŠ€æœ¯)
2. [Server-Sent Eventsæ ¸å¿ƒæ¦‚å¿µ](#2-server-sent-eventsæ ¸å¿ƒæ¦‚å¿µ)
3. [SseEmitterè¯¦è§£](#3-sseemitterè¯¦è§£)
4. [å®æ—¶æ•°æ®æ¨é€å®ç°](#4-å®æ—¶æ•°æ®æ¨é€å®ç°)
5. [äº‹ä»¶æµå¤„ç†æœºåˆ¶](#5-äº‹ä»¶æµå¤„ç†æœºåˆ¶)
6. [è¿æ¥ç®¡ç†ä¸é‡è¿æœºåˆ¶](#6-è¿æ¥ç®¡ç†ä¸é‡è¿æœºåˆ¶)
7. [æµè§ˆå™¨å…¼å®¹æ€§å¤„ç†](#7-æµè§ˆå™¨å…¼å®¹æ€§å¤„ç†)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ ä»€ä¹ˆæ˜¯æœåŠ¡å™¨æ¨é€æŠ€æœ¯


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡å™¨æ¨é€


**ä¼ ç»Ÿè¯·æ±‚æ–¹å¼çš„å±€é™**ï¼š
```
ä¼ ç»ŸHTTPè¯·æ±‚æµç¨‹ï¼š
å®¢æˆ·ç«¯ â”€â”€å‘é€è¯·æ±‚â”€â”€> æœåŠ¡å™¨
å®¢æˆ·ç«¯ <â”€â”€è¿”å›å“åº”â”€â”€ æœåŠ¡å™¨
        (è¿æ¥å…³é—­)

é—®é¢˜ï¼š
â€¢ æœåŠ¡å™¨æ— æ³•ä¸»åŠ¨å‘é€æ¶ˆæ¯
â€¢ éœ€è¦å®æ—¶æ•°æ®æ—¶ï¼Œå®¢æˆ·ç«¯åªèƒ½ä¸æ–­è½®è¯¢
â€¢ æµªè´¹èµ„æºï¼Œå¢åŠ æœåŠ¡å™¨å‹åŠ›
```

**æœåŠ¡å™¨æ¨é€çš„ä¼˜åŠ¿**ï¼š
```
æœåŠ¡å™¨æ¨é€æµç¨‹ï¼š
å®¢æˆ·ç«¯ â”€â”€å»ºç«‹è¿æ¥â”€â”€> æœåŠ¡å™¨
å®¢æˆ·ç«¯ <â”€â”€æŒç»­æ¨é€â”€â”€ æœåŠ¡å™¨
        (è¿æ¥ä¿æŒ)

ä¼˜åŠ¿ï¼š
â€¢ æœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨æ¨é€æ•°æ®
â€¢ å®æ—¶æ€§å¼ºï¼Œæ— éœ€è½®è¯¢
â€¢ èŠ‚çœèµ„æºï¼Œå‡å°‘è¯·æ±‚æ¬¡æ•°
```

### 1.2 å¸¸è§çš„æœåŠ¡å™¨æ¨é€æ–¹æ¡ˆå¯¹æ¯”


| æŠ€æœ¯æ–¹æ¡ˆ | **åŸç†** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|---------|------------|
| **è½®è¯¢** | `å®šæ—¶å‘é€è¯·æ±‚` | `å®ç°ç®€å•` | `å»¶è¿Ÿé«˜ã€æµªè´¹èµ„æº` | `å®æ—¶æ€§è¦æ±‚ä¸é«˜` |
| **é•¿è½®è¯¢** | `è¯·æ±‚ç­‰å¾…æ•°æ®åè¿”å›` | `å‡å°‘è¯·æ±‚æ¬¡æ•°` | `æœåŠ¡å™¨å ç”¨é«˜` | `ä¸­ç­‰å®æ—¶æ€§` |
| **WebSocket** | `åŒå‘é€šä¿¡åè®®` | `å…¨åŒå·¥ã€ä½å»¶è¿Ÿ` | `å®ç°å¤æ‚` | `èŠå¤©ã€æ¸¸æˆ` |
| **SSE** | `å•å‘äº‹ä»¶æµ` | `ç®€å•ã€è‡ªåŠ¨é‡è¿` | `åªèƒ½æœåŠ¡å™¨æ¨é€` | `æ¶ˆæ¯æ¨é€ã€é€šçŸ¥` |

### 1.3 æœåŠ¡å™¨æ¨é€çš„æœ¬è´¨ç†è§£


> ğŸ’¡ **é€šä¿—ç†è§£**ï¼š
> 
> ä¼ ç»Ÿè¯·æ±‚å°±åƒ**æ‰“ç”µè¯**ï¼šä½ æ‰“è¿‡å»é—®ä¸€å¥ï¼Œå¯¹æ–¹ç­”ä¸€å¥ï¼Œç„¶åæŒ‚æ–­
> 
> æœåŠ¡å™¨æ¨é€å°±åƒ**è®¢é˜…æŠ¥çº¸**ï¼šä½ è®¢é˜…åï¼ŒæŠ¥ç¤¾æ¯å¤©ä¸»åŠ¨é€æŠ¥çº¸ä¸Šé—¨ï¼Œä¸éœ€è¦ä½ æ¯å¤©å»ä¹°

---

## 2. ğŸ“¡ Server-Sent Eventsæ ¸å¿ƒæ¦‚å¿µ


### 2.1 SSEæ˜¯ä»€ä¹ˆ


**SSEï¼ˆServer-Sent Eventsï¼‰å®šä¹‰**ï¼š
```
SSE = æœåŠ¡å™¨å‘é€äº‹ä»¶
æ˜¯HTML5æä¾›çš„ä¸€ç§æœåŠ¡å™¨å‘æµè§ˆå™¨æ¨é€ä¿¡æ¯çš„æŠ€æœ¯
åŸºäºHTTPåè®®ï¼Œä½¿ç”¨æ–‡æœ¬æ ¼å¼ä¼ è¾“æ•°æ®
```

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- âœ… **å•å‘é€šä¿¡**ï¼šåªèƒ½æœåŠ¡å™¨æ¨é€åˆ°å®¢æˆ·ç«¯
- âœ… **è‡ªåŠ¨é‡è¿**ï¼šè¿æ¥æ–­å¼€åè‡ªåŠ¨é‡æ–°è¿æ¥
- âœ… **äº‹ä»¶ID**ï¼šæ”¯æŒæ–­ç‚¹ç»­ä¼ 
- âœ… **è½»é‡ç®€å•**ï¼šæ¯”WebSocketç®€å•å¾ˆå¤š

### 2.2 SSEçš„å·¥ä½œåŸç†


**é€šä¿¡æµç¨‹å›¾**ï¼š
```
æµè§ˆå™¨ç«¯                           æœåŠ¡å™¨ç«¯
   |                                  |
   |---[1]å‘èµ·HTTPè¯·æ±‚---------------->|
   |   GET /events                    |
   |   Accept: text/event-stream      |
   |                                  |
   |<--[2]è¿”å›äº‹ä»¶æµ-------------------|
   |   Content-Type: text/event-stream|
   |   (è¿æ¥ä¿æŒæ‰“å¼€)                  |
   |                                  |
   |<--[3]æŒç»­æ¨é€äº‹ä»¶-----------------|
   |   data: æ¶ˆæ¯1                    |
   |   data: æ¶ˆæ¯2                    |
   |   data: æ¶ˆæ¯3                    |
   |   ...                            |
```

**æ¶ˆæ¯æ ¼å¼è§„èŒƒ**ï¼š
```
åŸºæœ¬æ ¼å¼ï¼š
data: è¿™æ˜¯ä¸€æ¡æ¶ˆæ¯

å¸¦IDçš„æ¶ˆæ¯ï¼š
id: 123
data: è¿™æ˜¯ä¸€æ¡å¸¦IDçš„æ¶ˆæ¯

è‡ªå®šä¹‰äº‹ä»¶ï¼š
event: userLogin
data: {"userId": 1001}

é‡è¿æ—¶é—´è®¾ç½®ï¼š
retry: 3000
data: 3ç§’åé‡è¿
```

### 2.3 SSE vs WebSocket å¯¹æ¯”


**æŠ€æœ¯é€‰å‹æŒ‡å—**ï¼š

```
é€‰æ‹©SSEçš„åœºæ™¯ï¼š
âœ… åªéœ€è¦æœåŠ¡å™¨æ¨é€ï¼ˆè‚¡ç¥¨è¡Œæƒ…ã€æ–°é—»æ¨é€ï¼‰
âœ… ç®€å•æ˜“ç”¨ï¼Œå¿«é€Ÿå®ç°
âœ… éœ€è¦è‡ªåŠ¨é‡è¿åŠŸèƒ½
âœ… åŸºäºHTTPï¼Œç©¿é€é˜²ç«å¢™

é€‰æ‹©WebSocketçš„åœºæ™¯ï¼š
âœ… éœ€è¦åŒå‘å®æ—¶é€šä¿¡ï¼ˆèŠå¤©ã€åä½œç¼–è¾‘ï¼‰
âœ… ä¼ è¾“äºŒè¿›åˆ¶æ•°æ®
âœ… ä½å»¶è¿Ÿè¦æ±‚é«˜
âœ… éœ€è¦ä¿æŒå¤§é‡å¹¶å‘è¿æ¥
```

**å®ç°å¤æ‚åº¦å¯¹æ¯”**ï¼š
```
SSEå®ç°ï¼š
å®¢æˆ·ç«¯ï¼š3è¡Œä»£ç 
æœåŠ¡ç«¯ï¼š10è¡Œä»£ç 

WebSocketå®ç°ï¼š
å®¢æˆ·ç«¯ï¼šéœ€è¦å¤„ç†å„ç§äº‹ä»¶
æœåŠ¡ç«¯ï¼šéœ€è¦åè®®å‡çº§ã€æ¡æ‰‹ç­‰
```

---

## 3. ğŸ”§ SseEmitterè¯¦è§£


### 3.1 SseEmitteræ˜¯ä»€ä¹ˆ


**SseEmitterå®šä¹‰**ï¼š
```
SseEmitter = SSEå‘å°„å™¨
æ˜¯Springæä¾›çš„ç”¨äºå‘é€æœåŠ¡å™¨æ¨é€äº‹ä»¶çš„å·¥å…·ç±»
åŸºäºServlet 3.0çš„å¼‚æ­¥å¤„ç†æœºåˆ¶
```

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼š
> 
> SseEmitterå°±åƒä¸€ä¸ª**å¹¿æ’­ç”µå°**ï¼š
> - å®¢æˆ·ç«¯è¿æ¥å°±æ˜¯**è°ƒé¢‘æ”¶å¬**
> - send()æ–¹æ³•å°±æ˜¯**æ’­æŠ¥æ¶ˆæ¯**
> - complete()å°±æ˜¯**åœæ­¢æ’­æŠ¥**

### 3.2 SseEmitterçš„ç”Ÿå‘½å‘¨æœŸ


**ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ**ï¼š
```
1ï¸âƒ£ åˆ›å»ºé˜¶æ®µ
   new SseEmitter(timeout)
   â†“
2ï¸âƒ£ è¿æ¥é˜¶æ®µ  
   å®¢æˆ·ç«¯è¿æ¥ï¼Œè¿”å›SseEmitter
   â†“
3ï¸âƒ£ é€šä¿¡é˜¶æ®µ
   emitter.send(data) - å‘é€æ•°æ®
   â†“
4ï¸âƒ£ ç»“æŸé˜¶æ®µ
   emitter.complete() - æ­£å¸¸ç»“æŸ
   æˆ– emitter.completeWithError() - å¼‚å¸¸ç»“æŸ
```

**çŠ¶æ€ç®¡ç†å›¾ç¤º**ï¼š
```
åˆ›å»º â”€â”€> æ´»è·ƒ â”€â”€> å®Œæˆ
 |        |        |
 |        |        â””â”€> è¿æ¥å…³é—­
 |        |
 |        â””â”€è¶…æ—¶â”€â”€> è‡ªåŠ¨å®Œæˆ
 |
 â””â”€å¼‚å¸¸â”€â”€> é”™è¯¯å®Œæˆ
```

### 3.3 SseEmitteræ ¸å¿ƒAPI


**å¸¸ç”¨æ–¹æ³•è¯´æ˜**ï¼š

| æ–¹æ³• | **ä½œç”¨** | **ä½¿ç”¨åœºæ™¯** |
|-----|---------|------------|
| `send(Object)` | `å‘é€æ•°æ®` | `æ¨é€æ¶ˆæ¯å†…å®¹` |
| `send(SseEventBuilder)` | `å‘é€å¸¦é…ç½®çš„äº‹ä»¶` | `è‡ªå®šä¹‰äº‹ä»¶ç±»å‹å’ŒID` |
| `complete()` | `æ­£å¸¸ç»“æŸ` | `æ•°æ®å‘é€å®Œæ¯•` |
| `completeWithError(Throwable)` | `å¼‚å¸¸ç»“æŸ` | `å‘ç”Ÿé”™è¯¯æ—¶` |
| `onTimeout(Runnable)` | `è¶…æ—¶å›è°ƒ` | `è¿æ¥è¶…æ—¶å¤„ç†` |
| `onCompletion(Runnable)` | `å®Œæˆå›è°ƒ` | `æ¸…ç†èµ„æº` |
| `onError(Consumer)` | `é”™è¯¯å›è°ƒ` | `å¼‚å¸¸å¤„ç†` |

**è¶…æ—¶æ—¶é—´è®¾ç½®**ï¼š
```java
// ä¸è®¾ç½®è¶…æ—¶ï¼ˆæ°¸ä¸è¶…æ—¶ï¼‰
SseEmitter emitter = new SseEmitter();

// è®¾ç½®30ç§’è¶…æ—¶
SseEmitter emitter = new SseEmitter(30000L);

// è¶…æ—¶åçš„å¤„ç†
emitter.onTimeout(() -> {
    // è¶…æ—¶é€»è¾‘
    emitter.complete();
});
```

---

## 4. ğŸš€ å®æ—¶æ•°æ®æ¨é€å®ç°


### 4.1 åŸºç¡€æ¨é€ç¤ºä¾‹


**ç®€å•çš„æ¶ˆæ¯æ¨é€**ï¼š
```java
@RestController
@RequestMapping("/sse")
public class SseController {
    
    // åŸºç¡€æ¨é€ç¤ºä¾‹
    @GetMapping("/message")
    public SseEmitter sendMessage() {
        SseEmitter emitter = new SseEmitter();
        
        // å¼‚æ­¥å‘é€æ¶ˆæ¯
        new Thread(() -> {
            try {
                for (int i = 1; i <= 5; i++) {
                    emitter.send("æ¶ˆæ¯ " + i);
                    Thread.sleep(1000); // æ¯ç§’å‘é€ä¸€æ¬¡
                }
                emitter.complete(); // å‘é€å®Œæ¯•
            } catch (Exception e) {
                emitter.completeWithError(e);
            }
        }).start();
        
        return emitter;
    }
}
```

**å‰ç«¯æ¥æ”¶ä»£ç **ï¼š
```javascript
// åˆ›å»ºEventSourceè¿æ¥
const eventSource = new EventSource('/sse/message');

// ç›‘å¬æ¶ˆæ¯
eventSource.onmessage = (event) => {
    console.log('æ”¶åˆ°æ¶ˆæ¯:', event.data);
};

// ç›‘å¬é”™è¯¯
eventSource.onerror = (error) => {
    console.error('è¿æ¥é”™è¯¯:', error);
    eventSource.close();
};
```

### 4.2 å®æ—¶æ•°æ®æ¨é€åœºæ™¯


**è‚¡ç¥¨è¡Œæƒ…æ¨é€ç¤ºä¾‹**ï¼š
```java
@RestController
@RequestMapping("/sse")
public class StockPriceController {
    
    @GetMapping("/stock/{symbol}")
    public SseEmitter streamStockPrice(@PathVariable String symbol) {
        SseEmitter emitter = new SseEmitter(0L); // ä¸è¶…æ—¶
        
        // æ¨¡æ‹Ÿå®æ—¶è¡Œæƒ…æ¨é€
        ScheduledExecutorService executor = Executors.newSingleThreadScheduledExecutor();
        
        executor.scheduleAtFixedRate(() -> {
            try {
                // ç”Ÿæˆéšæœºä»·æ ¼
                double price = 100 + Math.random() * 10;
                
                // æ„å»ºæ•°æ®
                Map<String, Object> data = Map.of(
                    "symbol", symbol,
                    "price", price,
                    "time", System.currentTimeMillis()
                );
                
                emitter.send(data);
            } catch (IOException e) {
                emitter.completeWithError(e);
                executor.shutdown();
            }
        }, 0, 1, TimeUnit.SECONDS);
        
        // æ¸…ç†èµ„æº
        emitter.onCompletion(executor::shutdown);
        emitter.onTimeout(executor::shutdown);
        
        return emitter;
    }
}
```

### 4.3 è‡ªå®šä¹‰äº‹ä»¶ç±»å‹


**å¸¦äº‹ä»¶ç±»å‹çš„æ¨é€**ï¼š
```java
@GetMapping("/events")
public SseEmitter sendCustomEvents() {
    SseEmitter emitter = new SseEmitter();
    
    new Thread(() -> {
        try {
            // å‘é€ä¸åŒç±»å‹çš„äº‹ä»¶
            emitter.send(SseEmitter.event()
                .name("userLogin")  // äº‹ä»¶åç§°
                .id("1001")         // äº‹ä»¶ID
                .data("ç”¨æˆ·å¼ ä¸‰ç™»å½•äº†"));
            
            Thread.sleep(1000);
            
            emitter.send(SseEmitter.event()
                .name("orderCreate")
                .id("1002")
                .data(Map.of("orderId", "20250120001")));
            
            emitter.complete();
        } catch (Exception e) {
            emitter.completeWithError(e);
        }
    }).start();
    
    return emitter;
}
```

**å‰ç«¯ç›‘å¬ç‰¹å®šäº‹ä»¶**ï¼š
```javascript
const eventSource = new EventSource('/sse/events');

// ç›‘å¬userLoginäº‹ä»¶
eventSource.addEventListener('userLogin', (event) => {
    console.log('ç”¨æˆ·ç™»å½•:', event.data);
});

// ç›‘å¬orderCreateäº‹ä»¶
eventSource.addEventListener('orderCreate', (event) => {
    const order = JSON.parse(event.data);
    console.log('è®¢å•åˆ›å»º:', order);
});
```

---

## 5. âš™ï¸ äº‹ä»¶æµå¤„ç†æœºåˆ¶


### 5.1 äº‹ä»¶æµçš„æœ¬è´¨


**äº‹ä»¶æµæ¦‚å¿µ**ï¼š
```
äº‹ä»¶æµ = æŒç»­ä¸æ–­çš„æ•°æ®æµ
ç±»ä¼¼äºæ²³æµï¼Œæ•°æ®åƒæ°´ä¸€æ ·æºæºä¸æ–­æµå‘å®¢æˆ·ç«¯

ç‰¹ç‚¹ï¼š
â€¢ å•å‘æµåŠ¨ï¼šæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯
â€¢ æŒç»­æ€§ï¼šè¿æ¥ä¿æŒæ‰“å¼€
â€¢ å®æ—¶æ€§ï¼šæ•°æ®äº§ç”Ÿå³æ¨é€
```

**æ•°æ®æµåŠ¨ç¤ºæ„**ï¼š
```
æœåŠ¡å™¨ç«¯                            å®¢æˆ·ç«¯
  [æ•°æ®æº]
     â†“
  [äº‹ä»¶é˜Ÿåˆ—]
     â†“
  [SseEmitter] â”€â”€äº‹ä»¶æµâ”€â”€> [EventSource]
     â†“                         â†“
  [å‘é€ç¼“å†²]                [æ¥æ”¶ç¼“å†²]
                              â†“
                          [åº”ç”¨å¤„ç†]
```

### 5.2 èƒŒå‹å¤„ç†


> âš ï¸ **èƒŒå‹é—®é¢˜**ï¼š
> å½“ç”Ÿäº§é€Ÿåº¦ > æ¶ˆè´¹é€Ÿåº¦æ—¶ï¼Œä¼šå¯¼è‡´æ•°æ®ç§¯å‹

**èƒŒå‹å¤„ç†ç­–ç•¥**ï¼š
```java
@Service
public class SseService {
    
    // ä½¿ç”¨é˜»å¡é˜Ÿåˆ—æ§åˆ¶æµé€Ÿ
    public SseEmitter createEmitterWithBackpressure() {
        SseEmitter emitter = new SseEmitter();
        BlockingQueue<String> queue = new LinkedBlockingQueue<>(100); // é™åˆ¶é˜Ÿåˆ—å¤§å°
        
        // ç”Ÿäº§è€…çº¿ç¨‹
        new Thread(() -> {
            try {
                while (true) {
                    String data = produceData();
                    queue.put(data); // é˜Ÿåˆ—æ»¡æ—¶é˜»å¡
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }).start();
        
        // æ¶ˆè´¹è€…çº¿ç¨‹
        new Thread(() -> {
            try {
                while (true) {
                    String data = queue.take();
                    emitter.send(data);
                }
            } catch (Exception e) {
                emitter.completeWithError(e);
            }
        }).start();
        
        return emitter;
    }
}
```

### 5.3 æ‰¹é‡å‘é€ä¼˜åŒ–


**æ‰¹é‡æ¨é€æé«˜æ•ˆç‡**ï¼š
```java
@GetMapping("/batch")
public SseEmitter batchSend() {
    SseEmitter emitter = new SseEmitter();
    
    new Thread(() -> {
        try {
            List<String> batch = new ArrayList<>();
            
            for (int i = 1; i <= 100; i++) {
                batch.add("æ•°æ® " + i);
                
                // æ¯10æ¡æ‰¹é‡å‘é€
                if (batch.size() >= 10) {
                    emitter.send(batch);
                    batch.clear();
                    Thread.sleep(500);
                }
            }
            
            // å‘é€å‰©ä½™æ•°æ®
            if (!batch.isEmpty()) {
                emitter.send(batch);
            }
            
            emitter.complete();
        } catch (Exception e) {
            emitter.completeWithError(e);
        }
    }).start();
    
    return emitter;
}
```

---

## 6. ğŸ”— è¿æ¥ç®¡ç†ä¸é‡è¿æœºåˆ¶


### 6.1 è¿æ¥æ± ç®¡ç†


**ç®¡ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥**ï¼š
```java
@Service
public class SseConnectionManager {
    
    // å­˜å‚¨æ‰€æœ‰æ´»è·ƒè¿æ¥
    private final Map<String, SseEmitter> connections = new ConcurrentHashMap<>();
    
    // åˆ›å»ºè¿æ¥
    public SseEmitter createConnection(String userId) {
        SseEmitter emitter = new SseEmitter(0L);
        
        // è¿æ¥å®Œæˆæ—¶ç§»é™¤
        emitter.onCompletion(() -> removeConnection(userId));
        emitter.onTimeout(() -> removeConnection(userId));
        emitter.onError((ex) -> removeConnection(userId));
        
        connections.put(userId, emitter);
        return emitter;
    }
    
    // ç§»é™¤è¿æ¥
    private void removeConnection(String userId) {
        connections.remove(userId);
    }
    
    // å‘æ‰€æœ‰è¿æ¥å¹¿æ’­æ¶ˆæ¯
    public void broadcast(String message) {
        connections.values().forEach(emitter -> {
            try {
                emitter.send(message);
            } catch (IOException e) {
                emitter.completeWithError(e);
            }
        });
    }
    
    // å‘ç‰¹å®šç”¨æˆ·å‘é€
    public void sendToUser(String userId, String message) {
        SseEmitter emitter = connections.get(userId);
        if (emitter != null) {
            try {
                emitter.send(message);
            } catch (IOException e) {
                emitter.completeWithError(e);
            }
        }
    }
}
```

**ä½¿ç”¨è¿æ¥ç®¡ç†å™¨**ï¼š
```java
@RestController
@RequestMapping("/sse")
public class NotificationController {
    
    @Autowired
    private SseConnectionManager connectionManager;
    
    // å»ºç«‹è¿æ¥
    @GetMapping("/connect/{userId}")
    public SseEmitter connect(@PathVariable String userId) {
        return connectionManager.createConnection(userId);
    }
    
    // å‘é€é€šçŸ¥
    @PostMapping("/notify/{userId}")
    public void notifyUser(@PathVariable String userId, @RequestBody String message) {
        connectionManager.sendToUser(userId, message);
    }
    
    // å¹¿æ’­æ¶ˆæ¯
    @PostMapping("/broadcast")
    public void broadcast(@RequestBody String message) {
        connectionManager.broadcast(message);
    }
}
```

### 6.2 è‡ªåŠ¨é‡è¿æœºåˆ¶


**æœåŠ¡å™¨ç«¯è®¾ç½®é‡è¿æ—¶é—´**ï¼š
```java
@GetMapping("/auto-reconnect")
public SseEmitter autoReconnect() {
    SseEmitter emitter = new SseEmitter();
    
    new Thread(() -> {
        try {
            // å‘é€é‡è¿æ—¶é—´è®¾ç½®ï¼ˆæ¯«ç§’ï¼‰
            emitter.send(SseEmitter.event()
                .reconnectTime(3000L)  // 3ç§’åé‡è¿
                .data("è¿æ¥å»ºç«‹"));
            
            // æ¨¡æ‹Ÿæ•°æ®æ¨é€
            for (int i = 1; i <= 5; i++) {
                emitter.send("æ•°æ® " + i);
                Thread.sleep(1000);
            }
            
            emitter.complete();
        } catch (Exception e) {
            emitter.completeWithError(e);
        }
    }).start();
    
    return emitter;
}
```

**å®¢æˆ·ç«¯é‡è¿é€»è¾‘**ï¼š
```javascript
let eventSource;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;

function connect() {
    eventSource = new EventSource('/sse/auto-reconnect');
    
    eventSource.onopen = () => {
        console.log('è¿æ¥æˆåŠŸ');
        reconnectAttempts = 0; // é‡ç½®é‡è¿æ¬¡æ•°
    };
    
    eventSource.onerror = (error) => {
        console.error('è¿æ¥é”™è¯¯:', error);
        eventSource.close();
        
        // å°è¯•é‡è¿
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`${reconnectAttempts}æ¬¡é‡è¿...`);
            setTimeout(connect, 3000);
        } else {
            console.log('è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿');
        }
    };
}

connect();
```

### 6.3 æ–­ç‚¹ç»­ä¼ æœºåˆ¶


**åŸºäºLast-Event-IDçš„ç»­ä¼ **ï¼š
```java
@GetMapping("/resume")
public SseEmitter resumableStream(@RequestHeader(value = "Last-Event-ID", required = false) String lastEventId) {
    SseEmitter emitter = new SseEmitter();
    
    new Thread(() -> {
        try {
            // ä»ä¸Šæ¬¡æ–­å¼€çš„ä½ç½®ç»§ç»­
            int startId = lastEventId != null ? Integer.parseInt(lastEventId) : 0;
            
            for (int i = startId + 1; i <= 100; i++) {
                emitter.send(SseEmitter.event()
                    .id(String.valueOf(i))  // è®¾ç½®äº‹ä»¶ID
                    .data("æ•°æ® " + i));
                Thread.sleep(100);
            }
            
            emitter.complete();
        } catch (Exception e) {
            emitter.completeWithError(e);
        }
    }).start();
    
    return emitter;
}
```

> ğŸ’¡ **å·¥ä½œåŸç†**ï¼š
> 1. æœåŠ¡å™¨å‘é€æ¶ˆæ¯æ—¶å¸¦ä¸ŠID
> 2. è¿æ¥æ–­å¼€åï¼Œæµè§ˆå™¨è‡ªåŠ¨åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦Last-Event-ID
> 3. æœåŠ¡å™¨æ ¹æ®IDåˆ¤æ–­ä»å“ªé‡Œç»§ç»­å‘é€

---

## 7. ğŸŒ æµè§ˆå™¨å…¼å®¹æ€§å¤„ç†


### 7.1 æµè§ˆå™¨æ”¯æŒæƒ…å†µ


**å…¼å®¹æ€§ä¸€è§ˆ**ï¼š

| æµè§ˆå™¨ | **æ”¯æŒç‰ˆæœ¬** | **å…¼å®¹æ€§** |
|--------|------------|----------|
| Chrome | `6+` | âœ… å®Œå…¨æ”¯æŒ |
| Firefox | `6+` | âœ… å®Œå…¨æ”¯æŒ |
| Safari | `5+` | âœ… å®Œå…¨æ”¯æŒ |
| Edge | `79+` | âœ… å®Œå…¨æ”¯æŒ |
| IE | `æ‰€æœ‰ç‰ˆæœ¬` | âŒ ä¸æ”¯æŒ |
| Opera | `11+` | âœ… å®Œå…¨æ”¯æŒ |

> âš ï¸ **æ³¨æ„**ï¼šIEæµè§ˆå™¨å®Œå…¨ä¸æ”¯æŒSSEï¼Œéœ€è¦ä½¿ç”¨polyfillæˆ–é™çº§æ–¹æ¡ˆ

### 7.2 Polyfillæ–¹æ¡ˆ


**ä½¿ç”¨polyfillå…¼å®¹IE**ï¼š
```html
<!-- å¼•å…¥polyfillåº“ -->
<script src="https://cdn.jsdelivr.net/npm/event-source-polyfill@1.0.25/src/eventsource.min.js"></script>

<script>
// ä½¿ç”¨polyfillçš„EventSource
const EventSourcePolyfill = window.EventSourcePolyfill || window.EventSource;

const eventSource = new EventSourcePolyfill('/sse/events', {
    headers: {
        'Authorization': 'Bearer token'  // æ”¯æŒè‡ªå®šä¹‰è¯·æ±‚å¤´
    }
});
</script>
```

### 7.3 é™çº§æ–¹æ¡ˆ


**æ£€æµ‹å¹¶é™çº§åˆ°è½®è¯¢**ï¼š
```javascript
function createConnection(url) {
    // æ£€æµ‹æ˜¯å¦æ”¯æŒSSE
    if (typeof EventSource !== 'undefined') {
        // ä½¿ç”¨SSE
        const eventSource = new EventSource(url);
        
        eventSource.onmessage = (event) => {
            handleMessage(event.data);
        };
        
        return {
            close: () => eventSource.close()
        };
    } else {
        // é™çº§åˆ°è½®è¯¢
        console.warn('æµè§ˆå™¨ä¸æ”¯æŒSSEï¼Œä½¿ç”¨è½®è¯¢æ–¹å¼');
        
        const intervalId = setInterval(() => {
            fetch(url + '/poll')
                .then(res => res.json())
                .then(data => handleMessage(data));
        }, 2000);
        
        return {
            close: () => clearInterval(intervalId)
        };
    }
}

function handleMessage(data) {
    console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
}
```

**æœåŠ¡å™¨ç«¯æä¾›è½®è¯¢æ¥å£**ï¼š
```java
@RestController
@RequestMapping("/sse")
public class FallbackController {
    
    private final Queue<String> messageQueue = new ConcurrentLinkedQueue<>();
    
    // SSEæ¥å£
    @GetMapping("/events")
    public SseEmitter sseEvents() {
        // SSEå®ç°
    }
    
    // è½®è¯¢é™çº§æ¥å£
    @GetMapping("/poll")
    public ResponseEntity<List<String>> pollMessages() {
        List<String> messages = new ArrayList<>();
        
        // è·å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯
        String message;
        while ((message = messageQueue.poll()) != null) {
            messages.add(message);
        }
        
        return ResponseEntity.ok(messages);
    }
}
```

### 7.4 åŠŸèƒ½æ£€æµ‹æœ€ä½³å®è·µ


**å®Œæ•´çš„å…¼å®¹æ€§å¤„ç†**ï¼š
```javascript
class RealtimeClient {
    constructor(url) {
        this.url = url;
        this.connection = null;
        this.init();
    }
    
    init() {
        // åŠŸèƒ½æ£€æµ‹
        if (this.supportSSE()) {
            this.useSSE();
        } else if (this.supportWebSocket()) {
            this.useWebSocket();
        } else {
            this.usePolling();
        }
    }
    
    supportSSE() {
        return typeof EventSource !== 'undefined';
    }
    
    supportWebSocket() {
        return typeof WebSocket !== 'undefined';
    }
    
    useSSE() {
        console.log('ä½¿ç”¨SSEæ–¹å¼');
        this.connection = new EventSource(this.url + '/sse');
        this.connection.onmessage = (e) => this.onMessage(e.data);
    }
    
    useWebSocket() {
        console.log('ä½¿ç”¨WebSocketæ–¹å¼');
        this.connection = new WebSocket(this.url.replace('http', 'ws'));
        this.connection.onmessage = (e) => this.onMessage(e.data);
    }
    
    usePolling() {
        console.log('ä½¿ç”¨è½®è¯¢æ–¹å¼');
        setInterval(() => {
            fetch(this.url + '/poll')
                .then(res => res.json())
                .then(data => this.onMessage(data));
        }, 3000);
    }
    
    onMessage(data) {
        console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æœåŠ¡å™¨æ¨é€ï¼šæœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ®çš„æŠ€æœ¯
ğŸ”¸ SSEï¼šåŸºäºHTTPçš„å•å‘äº‹ä»¶æµï¼Œç®€å•æ˜“ç”¨
ğŸ”¸ SseEmitterï¼šSpringæä¾›çš„SSEå·¥å…·ç±»
ğŸ”¸ äº‹ä»¶æµï¼šæŒç»­ä¸æ–­çš„æ•°æ®æµä¼ è¾“
ğŸ”¸ è‡ªåŠ¨é‡è¿ï¼šè¿æ¥æ–­å¼€åè‡ªåŠ¨é‡æ–°å»ºç«‹
ğŸ”¸ è¿æ¥ç®¡ç†ï¼šç»´æŠ¤å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥
ğŸ”¸ å…¼å®¹æ€§å¤„ç†ï¼špolyfillæˆ–é™çº§æ–¹æ¡ˆ
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä»€ä¹ˆæ—¶å€™ç”¨SSE**ï¼š
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… å®æ—¶é€šçŸ¥æ¨é€ï¼ˆæ¶ˆæ¯ã€è®¢å•çŠ¶æ€ï¼‰
âœ… æ•°æ®ç›‘æ§ï¼ˆè‚¡ç¥¨ã€æœåŠ¡å™¨çŠ¶æ€ï¼‰
âœ… è¿›åº¦æ˜¾ç¤ºï¼ˆæ–‡ä»¶ä¸Šä¼ ã€ä»»åŠ¡è¿›åº¦ï¼‰
âœ… æ—¥å¿—æµï¼ˆå®æ—¶æ—¥å¿—æŸ¥çœ‹ï¼‰

ä¸é€‚ç”¨åœºæ™¯ï¼š
âŒ éœ€è¦å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼ˆç”¨WebSocketï¼‰
âŒ ä¼ è¾“äºŒè¿›åˆ¶æ•°æ®ï¼ˆç”¨WebSocketï¼‰
âŒ IEæµè§ˆå™¨å¿…é¡»æ”¯æŒï¼ˆéœ€è¦polyfillï¼‰
```

**ğŸ”¹ SseEmitterä½¿ç”¨è¦ç‚¹**ï¼š
```
å…³é”®æ­¥éª¤ï¼š
1. åˆ›å»ºSseEmitterå¯¹è±¡
2. å¼‚æ­¥çº¿ç¨‹å‘é€æ•°æ®
3. è®¾ç½®è¶…æ—¶å’Œå›è°ƒ
4. å®Œæˆæ—¶è°ƒç”¨complete()
5. å¼‚å¸¸æ—¶è°ƒç”¨completeWithError()
```

**ğŸ”¹ è¿æ¥ç®¡ç†æ ¸å¿ƒ**ï¼š
```
ç®¡ç†ç­–ç•¥ï¼š
â€¢ ä½¿ç”¨Mapå­˜å‚¨è¿æ¥ï¼ˆç”¨æˆ·ID â†’ SseEmitterï¼‰
â€¢ è®¾ç½®å®Œæˆ/è¶…æ—¶/é”™è¯¯å›è°ƒæ¸…ç†èµ„æº
â€¢ æä¾›å¹¿æ’­å’Œå•æ’­æ–¹æ³•
â€¢ å®šæœŸæ¸…ç†æ— æ•ˆè¿æ¥
```

### 8.3 å®é™…åº”ç”¨å»ºè®®


**æœ€ä½³å®è·µ**ï¼š

1ï¸âƒ£ **è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´**
```java
// æ ¹æ®ä¸šåŠ¡è®¾ç½®è¶…æ—¶
SseEmitter emitter = new SseEmitter(30000L);  // 30ç§’
```

2ï¸âƒ£ **åšå¥½å¼‚å¸¸å¤„ç†**
```java
emitter.onError(ex -> {
    log.error("SSEé”™è¯¯", ex);
    emitter.completeWithError(ex);
});
```

3ï¸âƒ£ **ä½¿ç”¨çº¿ç¨‹æ± ç®¡ç†å¼‚æ­¥ä»»åŠ¡**
```java
@Autowired
private ThreadPoolTaskExecutor executor;

executor.execute(() -> {
    // å‘é€æ•°æ®
});
```

4ï¸âƒ£ **å‰ç«¯é‡è¿é™åˆ¶**
```javascript
// é™åˆ¶é‡è¿æ¬¡æ•°ï¼Œé¿å…æ— é™é‡è¿
if (reconnectAttempts < 5) {
    setTimeout(connect, 3000);
}
```

5ï¸âƒ£ **è·¨åŸŸå¤„ç†**
```java
@CrossOrigin(origins = "*")
@GetMapping("/events")
public SseEmitter events() {
    // ...
}
```

### 8.4 å¸¸è§é—®é¢˜è§£å†³


**â“ è¿æ¥æ€»æ˜¯æ–­å¼€**ï¼š
- æ£€æŸ¥è¶…æ—¶è®¾ç½®æ˜¯å¦åˆç†
- ç¡®è®¤æ˜¯å¦æœ‰åå‘ä»£ç†ç¼“å­˜é—®é¢˜
- å¢åŠ å¿ƒè·³ä¿æ´»æœºåˆ¶

**â“ æ•°æ®æ¨é€å»¶è¿Ÿ**ï¼š
- æ£€æŸ¥æ˜¯å¦æœ‰èƒŒå‹é—®é¢˜
- ä¼˜åŒ–æ•°æ®å‘é€é¢‘ç‡
- ä½¿ç”¨æ‰¹é‡å‘é€

**â“ å†…å­˜æ³„æ¼**ï¼š
- ç¡®ä¿è¿æ¥ç»“æŸæ—¶æ¸…ç†èµ„æº
- ä½¿ç”¨å¼±å¼•ç”¨å­˜å‚¨è¿æ¥
- å®šæœŸæ¸…ç†è¿‡æœŸè¿æ¥

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æœåŠ¡å™¨æ¨é€SSEå¼ºï¼Œ
å•å‘é€šä¿¡è‡ªé‡è¿ï¼Œ
SseEmitterç®¡ç†è¿æ¥ï¼Œ
äº‹ä»¶æµå¼å®æ—¶ä¼ ï¼Œ
å…¼å®¹å¤„ç†è¦è€ƒè™‘ï¼Œ
è¿æ¥ç®¡ç†æ˜¯å…³é”®ï¼
```