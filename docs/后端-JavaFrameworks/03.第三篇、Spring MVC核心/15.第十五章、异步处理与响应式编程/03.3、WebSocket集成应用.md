---
title: 3ã€WebSocketé›†æˆåº”ç”¨
---
## ğŸ“š ç›®å½•

1. [WebSocketåŸºç¡€æ¦‚å¿µ](#1-websocketåŸºç¡€æ¦‚å¿µ)
2. [WebSocketé…ç½®ä¸å¯ç”¨](#2-websocketé…ç½®ä¸å¯ç”¨)
3. [æ¶ˆæ¯å¤„ç†å™¨å¼€å‘](#3-æ¶ˆæ¯å¤„ç†å™¨å¼€å‘)
4. [ä¼šè¯ç®¡ç†æœºåˆ¶](#4-ä¼šè¯ç®¡ç†æœºåˆ¶)
5. [å¹¿æ’­ä¸ç‚¹å¯¹ç‚¹é€šä¿¡](#5-å¹¿æ’­ä¸ç‚¹å¯¹ç‚¹é€šä¿¡)
6. [å¿ƒè·³æ£€æµ‹ä¸æ–­çº¿é‡è¿](#6-å¿ƒè·³æ£€æµ‹ä¸æ–­çº¿é‡è¿)
7. [å®‰å…¨è®¤è¯ä¸æˆæƒ](#7-å®‰å…¨è®¤è¯ä¸æˆæƒ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ WebSocketåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯WebSocket


**ğŸ”¸ é€šä¿—ç†è§£**
æƒ³è±¡ä½ åœ¨å’Œæœ‹å‹èŠå¾®ä¿¡ï¼Œä¼ ç»Ÿçš„HTTPå°±åƒ"å†™ä¿¡"ï¼š
- ä½ é—®ä¸€å¥ï¼Œç­‰å›å¤
- æ¯æ¬¡éƒ½è¦é‡æ–°å»ºç«‹è”ç³»
- å•å‘æ²Ÿé€šï¼Œä¸€æ¥ä¸€å›

è€ŒWebSocketå°±åƒ"æ‰“ç”µè¯"ï¼š
- è¿æ¥ä¸€æ¬¡ï¼Œéšæ—¶èŠå¤©
- åŒæ–¹éƒ½èƒ½ä¸»åŠ¨è¯´è¯
- å®æ—¶é€šä¿¡ï¼Œä¸ç”¨ç­‰å¾…

```
ä¼ ç»ŸHTTPé€šä¿¡ï¼š
å®¢æˆ·ç«¯ --è¯·æ±‚--> æœåŠ¡å™¨
å®¢æˆ·ç«¯ <--å“åº”-- æœåŠ¡å™¨
ï¼ˆæ¯æ¬¡éƒ½è¦é‡æ–°è¿æ¥ï¼‰

WebSocketé€šä¿¡ï¼š
å®¢æˆ·ç«¯ <=======åŒå‘é€šé“=======> æœåŠ¡å™¨
ï¼ˆä¸€æ¬¡è¿æ¥ï¼ŒæŒç»­é€šä¿¡ï¼‰
```

**ğŸ”¸ æŠ€æœ¯å®šä¹‰**
WebSocketæ˜¯ä¸€ç§ç½‘ç»œé€šä¿¡åè®®ï¼Œæä¾›äº†**å…¨åŒå·¥**ï¼ˆåŒå‘ï¼‰çš„é€šä¿¡é€šé“ã€‚å®ƒè§£å†³äº†HTTPåè®®æ— æ³•å®æ—¶æ¨é€æ•°æ®çš„é—®é¢˜ã€‚

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦WebSocket


**ğŸ’¡ å®é™…åœºæ™¯å¯¹æ¯”**

| åœºæ™¯ | HTTPè½®è¯¢æ–¹å¼ | WebSocketæ–¹å¼ |
|------|-------------|--------------|
| **åœ¨çº¿èŠå¤©** | æ¯ç§’å‘è¯·æ±‚é—®"æœ‰æ–°æ¶ˆæ¯å—ï¼Ÿ" | æœ‰æ¶ˆæ¯ç›´æ¥æ¨é€ |
| **è‚¡ç¥¨è¡Œæƒ…** | ä¸æ–­åˆ·æ–°é¡µé¢è·å–æœ€æ–°ä»·æ ¼ | ä»·æ ¼å˜åŠ¨å®æ—¶æ¨é€ |
| **æ¸¸æˆå¯¹æˆ˜** | é¢‘ç¹è¯·æ±‚è·å–å¯¹æ‰‹åŠ¨ä½œ | åŠ¨ä½œå‘ç”Ÿç«‹å³é€šçŸ¥ |
| **ååŒç¼–è¾‘** | å®šæ—¶æ‹‰å–å…¶ä»–äººçš„ä¿®æ”¹ | ä¿®æ”¹å®æ—¶åŒæ­¥ |

**âš¡ æ ¸å¿ƒä¼˜åŠ¿**
```
âœ… å®æ—¶æ€§ï¼šæ¶ˆæ¯å³æ—¶é€è¾¾ï¼Œå»¶è¿Ÿæä½
âœ… é«˜æ•ˆæ€§ï¼šä¸€æ¬¡è¿æ¥ï¼ŒæŒç»­ä½¿ç”¨ï¼Œå‡å°‘å¼€é”€
âœ… åŒå‘æ€§ï¼šæœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨æ¨é€æ•°æ®
âœ… èŠ‚çœèµ„æºï¼šé¿å…é¢‘ç¹çš„HTTPè¯·æ±‚
```

### 1.3 WebSocketå·¥ä½œåŸç†


**ğŸ”¸ è¿æ¥å»ºç«‹è¿‡ç¨‹**
```
æ­¥éª¤1ï¼šå®¢æˆ·ç«¯å‘èµ·æ¡æ‰‹è¯·æ±‚
HTTP GET /chat HTTP/1.1
Upgrade: websocket           â† å‘Šè¯‰æœåŠ¡å™¨è¦å‡çº§åè®®
Connection: Upgrade
Sec-WebSocket-Key: xxx       â† å®‰å…¨å¯†é’¥

æ­¥éª¤2ï¼šæœåŠ¡å™¨åŒæ„å‡çº§
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: yyy    â† ç¡®è®¤å¯†é’¥

æ­¥éª¤3ï¼šåè®®å‡çº§æˆåŠŸ
ä»HTTPåˆ‡æ¢åˆ°WebSocketåè®®
å»ºç«‹æŒä¹…åŒ–çš„åŒå‘é€šé“

æ­¥éª¤4ï¼šå¼€å§‹æ•°æ®é€šä¿¡
å®¢æˆ·ç«¯ <----æ¶ˆæ¯----> æœåŠ¡å™¨
```

---

## 2. âš™ï¸ WebSocketé…ç½®ä¸å¯ç”¨


### 2.1 æ·»åŠ ä¾èµ–é…ç½®


**ğŸ”¸ Mavenä¾èµ–**
```xml
<!-- Spring WebSocketæ ¸å¿ƒä¾èµ– -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-websocket</artifactId>
</dependency>

<!-- æ¶ˆæ¯è½¬æ¢æ”¯æŒï¼ˆJSONæ ¼å¼ï¼‰ -->
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
</dependency>
```

> ğŸ’¡ **ä¾èµ–è¯´æ˜**ï¼š`spring-boot-starter-websocket` å·²ç»åŒ…å«äº†æ‰€æœ‰å¿…è¦çš„WebSocketç»„ä»¶ï¼Œå¼€ç®±å³ç”¨ã€‚

### 2.2 å¯ç”¨WebSocketæ”¯æŒ


**ğŸ”¸ é…ç½®ç±»å®ç°**

```java
@Configuration
@EnableWebSocketMessageBroker  // å¯ç”¨WebSocketæ¶ˆæ¯ä»£ç†
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {
    
    // æ³¨å†ŒWebSocketç«¯ç‚¹
    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws")          // WebSocketè¿æ¥åœ°å€
                .setAllowedOrigins("*")      // å…è®¸è·¨åŸŸ
                .withSockJS();               // æ”¯æŒSockJSé™çº§æ–¹æ¡ˆ
    }
    
    // é…ç½®æ¶ˆæ¯ä»£ç†
    @Override
    public void configureMessageBroker(MessageBrokerRegistry registry) {
        registry.enableSimpleBroker("/topic", "/queue");  // æ¶ˆæ¯è®¢é˜…å‰ç¼€
        registry.setApplicationDestinationPrefixes("/app"); // æ¶ˆæ¯å‘é€å‰ç¼€
    }
}
```

**ğŸ“‹ é…ç½®è§£é‡Š**

| é…ç½®é¡¹ | å«ä¹‰ | ç¤ºä¾‹ |
|--------|------|------|
| `addEndpoint("/ws")` | WebSocketè¿æ¥åœ°å€ | `ws://localhost:8080/ws` |
| `setAllowedOrigins("*")` | å…è®¸çš„è·¨åŸŸæ¥æº | å…è®¸æ‰€æœ‰åŸŸåè®¿é—® |
| `withSockJS()` | å¯ç”¨é™çº§æ–¹æ¡ˆ | æµè§ˆå™¨ä¸æ”¯æŒæ—¶ç”¨è½®è¯¢ |
| `enableSimpleBroker` | å¯ç”¨å†…å­˜æ¶ˆæ¯ä»£ç† | ç®¡ç†æ¶ˆæ¯è®¢é˜…å’Œåˆ†å‘ |
| `setApplicationDestinationPrefixes` | åº”ç”¨æ¶ˆæ¯å‰ç¼€ | å®¢æˆ·ç«¯å‘é€åˆ° `/app/xxx` |

**ğŸ”¸ æ¶ˆæ¯è·¯å¾„è§„åˆ™**
```
å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼š/app/chat/send
                â†“
            Controllerå¤„ç†
                â†“
æœåŠ¡å™¨æ¨é€æ¶ˆæ¯ï¼š/topic/chat/messages
                â†“
            è®¢é˜…çš„å®¢æˆ·ç«¯æ¥æ”¶
```

---

## 3. ğŸ“¨ æ¶ˆæ¯å¤„ç†å™¨å¼€å‘


### 3.1 åŸºç¡€æ¶ˆæ¯å¤„ç†


**ğŸ”¸ åˆ›å»ºæ§åˆ¶å™¨**

```java
@Controller
public class ChatController {
    
    // å¤„ç†å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯
    @MessageMapping("/chat/send")           // ç›‘å¬ /app/chat/send
    @SendTo("/topic/chat/messages")         // å¹¿æ’­åˆ° /topic/chat/messages
    public ChatMessage sendMessage(ChatMessage message) {
        message.setTime(LocalDateTime.now());
        return message;  // è¿”å›çš„æ¶ˆæ¯ä¼šè‡ªåŠ¨å¹¿æ’­
    }
}
```

**ğŸ”¸ æ¶ˆæ¯å®ä½“ç±»**

```java
public class ChatMessage {
    private String sender;      // å‘é€è€…
    private String content;     // æ¶ˆæ¯å†…å®¹
    private LocalDateTime time; // å‘é€æ—¶é—´
    
    // getter/setterçœç•¥
}
```

**ğŸ’¡ å·¥ä½œæµç¨‹**
```
1. å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯åˆ° /app/chat/send
   â†“
2. @MessageMapping æ–¹æ³•æ¥æ”¶æ¶ˆæ¯
   â†“
3. æ–¹æ³•å¤„ç†æ¶ˆæ¯ï¼ˆæ·»åŠ æ—¶é—´æˆ³ç­‰ï¼‰
   â†“
4. @SendTo å°†æ¶ˆæ¯å¹¿æ’­åˆ° /topic/chat/messages
   â†“
5. æ‰€æœ‰è®¢é˜…è¯¥ä¸»é¢˜çš„å®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯
```

### 3.2 é«˜çº§æ¶ˆæ¯å¤„ç†


**ğŸ”¸ ä½¿ç”¨SimpMessagingTemplate**

```java
@Service
public class MessageService {
    
    @Autowired
    private SimpMessagingTemplate messagingTemplate;
    
    // å‘é€ç»™æ‰€æœ‰äººï¼ˆå¹¿æ’­ï¼‰
    public void broadcastMessage(String message) {
        messagingTemplate.convertAndSend("/topic/public", message);
    }
    
    // å‘é€ç»™ç‰¹å®šç”¨æˆ·ï¼ˆç‚¹å¯¹ç‚¹ï¼‰
    public void sendToUser(String username, String message) {
        messagingTemplate.convertAndSendToUser(
            username,           // ç”¨æˆ·å
            "/queue/private",   // ç§æœ‰é˜Ÿåˆ—
            message             // æ¶ˆæ¯å†…å®¹
        );
    }
    
    // å®šæ—¶æ¨é€æ¶ˆæ¯
    @Scheduled(fixedRate = 5000)
    public void pushUpdate() {
        messagingTemplate.convertAndSend("/topic/updates", 
            "æœ€æ–°é€šçŸ¥ï¼š" + LocalDateTime.now());
    }
}
```

**ğŸ“‹ æ–¹æ³•å¯¹æ¯”**

| æ–¹æ³• | é€‚ç”¨åœºæ™¯ | æ¥æ”¶è€… |
|------|---------|--------|
| `convertAndSend("/topic/xxx")` | å¹¿æ’­æ¶ˆæ¯ | æ‰€æœ‰è®¢é˜…è¯¥ä¸»é¢˜çš„ç”¨æˆ· |
| `convertAndSendToUser(user, "/queue/xxx")` | ç§èŠæ¶ˆæ¯ | æŒ‡å®šç”¨æˆ· |

---

## 4. ğŸ‘¥ ä¼šè¯ç®¡ç†æœºåˆ¶


### 4.1 ç›‘å¬è¿æ¥äº‹ä»¶


**ğŸ”¸ äº‹ä»¶ç›‘å¬å™¨**

```java
@Component
public class WebSocketEventListener {
    
    private static final Logger log = LoggerFactory.getLogger(WebSocketEventListener.class);
    
    // ç”¨æˆ·è¿æ¥æ—¶è§¦å‘
    @EventListener
    public void handleWebSocketConnectListener(SessionConnectedEvent event) {
        StompHeaderAccessor headerAccessor = StompHeaderAccessor.wrap(event.getMessage());
        String sessionId = headerAccessor.getSessionId();
        log.info("æ–°ç”¨æˆ·è¿æ¥ï¼šsessionId = {}", sessionId);
    }
    
    // ç”¨æˆ·æ–­å¼€æ—¶è§¦å‘
    @EventListener
    public void handleWebSocketDisconnectListener(SessionDisconnectEvent event) {
        StompHeaderAccessor headerAccessor = StompHeaderAccessor.wrap(event.getMessage());
        String username = (String) headerAccessor.getSessionAttributes().get("username");
        if(username != null) {
            log.info("ç”¨æˆ·ç¦»çº¿ï¼š{}", username);
            // å¹¿æ’­ç”¨æˆ·ç¦»çº¿æ¶ˆæ¯
        }
    }
}
```

**âš¡ äº‹ä»¶ç±»å‹è¯´æ˜**

| äº‹ä»¶ | è§¦å‘æ—¶æœº | ç”¨é€” |
|------|---------|------|
| `SessionConnectedEvent` | WebSocketè¿æ¥æˆåŠŸ | è®°å½•åœ¨çº¿ç”¨æˆ·ã€å‘é€æ¬¢è¿æ¶ˆæ¯ |
| `SessionDisconnectEvent` | WebSocketè¿æ¥æ–­å¼€ | æ¸…ç†èµ„æºã€é€šçŸ¥å…¶ä»–ç”¨æˆ· |
| `SessionSubscribeEvent` | ç”¨æˆ·è®¢é˜…ä¸»é¢˜ | æƒé™æ£€æŸ¥ã€è®°å½•è®¢é˜… |

### 4.2 ä¼šè¯å­˜å‚¨ç®¡ç†


**ğŸ”¸ åœ¨çº¿ç”¨æˆ·ç®¡ç†**

```java
@Component
public class SessionManager {
    
    // å­˜å‚¨åœ¨çº¿ç”¨æˆ·ï¼šsessionId -> ç”¨æˆ·ä¿¡æ¯
    private final Map<String, UserSession> activeSessions = new ConcurrentHashMap<>();
    
    // æ·»åŠ ä¼šè¯
    public void addSession(String sessionId, String username) {
        UserSession session = new UserSession(username, LocalDateTime.now());
        activeSessions.put(sessionId, session);
    }
    
    // ç§»é™¤ä¼šè¯
    public void removeSession(String sessionId) {
        activeSessions.remove(sessionId);
    }
    
    // è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
    public List<String> getOnlineUsers() {
        return activeSessions.values().stream()
                .map(UserSession::getUsername)
                .collect(Collectors.toList());
    }
    
    // è·å–åœ¨çº¿äººæ•°
    public int getOnlineCount() {
        return activeSessions.size();
    }
}
```

**ğŸ”¸ ä¼šè¯ä¿¡æ¯å®ä½“**

```java
public class UserSession {
    private String username;        // ç”¨æˆ·å
    private LocalDateTime connectTime; // è¿æ¥æ—¶é—´
    private String ipAddress;       // IPåœ°å€
    
    // æ„é€ æ–¹æ³•ã€getter/setterçœç•¥
}
```

---

## 5. ğŸ“¢ å¹¿æ’­ä¸ç‚¹å¯¹ç‚¹é€šä¿¡


### 5.1 å¹¿æ’­æ¶ˆæ¯ï¼ˆä¸€å¯¹å¤šï¼‰


**ğŸ”¸ å®ç°æ–¹å¼**

```java
@Controller
public class BroadcastController {
    
    @Autowired
    private SimpMessagingTemplate template;
    
    // æ–¹å¼1ï¼šä½¿ç”¨@SendToæ³¨è§£
    @MessageMapping("/broadcast")
    @SendTo("/topic/public")
    public String broadcast(String message) {
        return "å¹¿æ’­æ¶ˆæ¯ï¼š" + message;
    }
    
    // æ–¹å¼2ï¼šä½¿ç”¨SimpMessagingTemplate
    public void sendBroadcast(String message) {
        template.convertAndSend("/topic/public", message);
    }
}
```

**ğŸ“Š å¹¿æ’­æµç¨‹å›¾**
```
å‘é€è€…
  â†“ å‘é€æ¶ˆæ¯åˆ° /app/broadcast
Controllerå¤„ç†
  â†“ è½¬å‘åˆ° /topic/public
æ¶ˆæ¯ä»£ç†
  â†“ åˆ†å‘ç»™æ‰€æœ‰è®¢é˜…è€…
è®¢é˜…è€…A   è®¢é˜…è€…B   è®¢é˜…è€…C
  â†“         â†“         â†“
æ”¶åˆ°æ¶ˆæ¯  æ”¶åˆ°æ¶ˆæ¯  æ”¶åˆ°æ¶ˆæ¯
```

### 5.2 ç‚¹å¯¹ç‚¹é€šä¿¡ï¼ˆä¸€å¯¹ä¸€ï¼‰


**ğŸ”¸ å®ç°ç§èŠåŠŸèƒ½**

```java
@Controller
public class PrivateMessageController {
    
    @Autowired
    private SimpMessagingTemplate template;
    
    // å‘é€ç§èŠæ¶ˆæ¯
    @MessageMapping("/private")
    public void sendPrivate(PrivateMessage message) {
        template.convertAndSendToUser(
            message.getReceiver(),      // æ¥æ”¶è€…ç”¨æˆ·å
            "/queue/private",           // ç§æœ‰é˜Ÿåˆ—
            message                     // æ¶ˆæ¯å†…å®¹
        );
    }
}
```

**ğŸ”¸ ç§èŠæ¶ˆæ¯å®ä½“**

```java
public class PrivateMessage {
    private String sender;      // å‘é€è€…
    private String receiver;    // æ¥æ”¶è€…
    private String content;     // æ¶ˆæ¯å†…å®¹
    
    // getter/setterçœç•¥
}
```

**ğŸ“‹ é€šä¿¡æ–¹å¼å¯¹æ¯”**

| ç±»å‹ | ç›®æ ‡åœ°å€ | æ¥æ”¶è€… | ä½¿ç”¨åœºæ™¯ |
|------|---------|--------|---------|
| **å¹¿æ’­** | `/topic/xxx` | æ‰€æœ‰è®¢é˜…è€… | å…¬å‘Šã€ç³»ç»Ÿé€šçŸ¥ |
| **ç‚¹å¯¹ç‚¹** | `/user/{username}/queue/xxx` | æŒ‡å®šç”¨æˆ· | ç§èŠã€ä¸ªäººæé†’ |

---

## 6. ğŸ’“ å¿ƒè·³æ£€æµ‹ä¸æ–­çº¿é‡è¿


### 6.1 å¿ƒè·³æ£€æµ‹æœºåˆ¶


**ğŸ”¸ æœåŠ¡ç«¯å¿ƒè·³é…ç½®**

```java
@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {
    
    @Override
    public void configureMessageBroker(MessageBrokerRegistry registry) {
        registry.enableSimpleBroker("/topic", "/queue")
                .setHeartbeatValue(new long[] {10000, 10000}); // å¿ƒè·³é—´éš”10ç§’
    }
}
```

**ğŸ”¸ å®¢æˆ·ç«¯å¿ƒè·³å®ç°ï¼ˆJavaScriptï¼‰**

```javascript
let stompClient = null;
let heartbeatInterval = null;

// è¿æ¥WebSocket
function connect() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    
    stompClient.connect({}, function(frame) {
        console.log('è¿æ¥æˆåŠŸ');
        
        // å¯åŠ¨å¿ƒè·³æ£€æµ‹
        startHeartbeat();
        
        // è®¢é˜…æ¶ˆæ¯
        stompClient.subscribe('/topic/public', function(message) {
            console.log('æ”¶åˆ°æ¶ˆæ¯ï¼š', message.body);
        });
    });
}

// å¿ƒè·³æ£€æµ‹
function startHeartbeat() {
    heartbeatInterval = setInterval(() => {
        if(stompClient && stompClient.connected) {
            stompClient.send("/app/heartbeat", {}, "ping");
        }
    }, 30000); // æ¯30ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
}
```

**ğŸ’¡ å¿ƒè·³ä½œç”¨**
```
âœ… æ£€æµ‹è¿æ¥çŠ¶æ€ï¼šåˆ¤æ–­è¿æ¥æ˜¯å¦å­˜æ´»
âœ… ä¿æŒè¿æ¥ï¼šé˜²æ­¢ä»£ç†æœåŠ¡å™¨æ–­å¼€ç©ºé—²è¿æ¥
âœ… åŠæ—¶å‘ç°æ–­çº¿ï¼šå¿«é€Ÿè§¦å‘é‡è¿æœºåˆ¶
```

### 6.2 æ–­çº¿é‡è¿ç­–ç•¥


**ğŸ”¸ æŒ‡æ•°é€€é¿é‡è¿**

```javascript
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;

function connect() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    
    stompClient.connect({}, 
        function onConnect() {
            console.log('è¿æ¥æˆåŠŸ');
            reconnectAttempts = 0; // é‡ç½®é‡è¿æ¬¡æ•°
            startHeartbeat();
        },
        function onError(error) {
            console.error('è¿æ¥å¤±è´¥', error);
            attemptReconnect();
        }
    );
}

// é‡è¿é€»è¾‘
function attemptReconnect() {
    if(reconnectAttempts < maxReconnectAttempts) {
        reconnectAttempts++;
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
        
        console.log(`${delay/1000}ç§’åè¿›è¡Œç¬¬${reconnectAttempts}æ¬¡é‡è¿...`);
        
        setTimeout(() => {
            connect();
        }, delay);
    } else {
        console.error('é‡è¿å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
        alert('è¿æ¥å·²æ–­å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢');
    }
}
```

**ğŸ“Š é‡è¿æ—¶é—´ç­–ç•¥**
```
ç¬¬1æ¬¡é‡è¿ï¼šç­‰å¾… 2ç§’  (2^1 Ã— 1000ms)
ç¬¬2æ¬¡é‡è¿ï¼šç­‰å¾… 4ç§’  (2^2 Ã— 1000ms)
ç¬¬3æ¬¡é‡è¿ï¼šç­‰å¾… 8ç§’  (2^3 Ã— 1000ms)
ç¬¬4æ¬¡é‡è¿ï¼šç­‰å¾… 16ç§’ (2^4 Ã— 1000ms)
ç¬¬5æ¬¡é‡è¿ï¼šç­‰å¾… 30ç§’ (ä¸Šé™)
```

---

## 7. ğŸ”’ å®‰å…¨è®¤è¯ä¸æˆæƒ


### 7.1 è¿æ¥è®¤è¯


**ğŸ”¸ åŸºäºTokençš„è®¤è¯**

```java
@Configuration
@EnableWebSocketMessageBroker
public class WebSocketSecurityConfig implements WebSocketMessageBrokerConfigurer {
    
    @Override
    public void configureClientInboundChannel(ChannelRegistration registration) {
        registration.interceptors(new ChannelInterceptor() {
            @Override
            public Message<?> preSend(Message<?> message, MessageChannel channel) {
                StompHeaderAccessor accessor = 
                    MessageHeaderAccessor.getAccessor(message, StompHeaderAccessor.class);
                
                if (StompCommand.CONNECT.equals(accessor.getCommand())) {
                    // è·å–Token
                    String token = accessor.getFirstNativeHeader("Authorization");
                    
                    if(token == null || !validateToken(token)) {
                        throw new IllegalArgumentException("æ— æ•ˆçš„è®¤è¯Token");
                    }
                    
                    // éªŒè¯é€šè¿‡ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯
                    String username = getUsernameFromToken(token);
                    accessor.setUser(new SimplePrincipal(username));
                }
                
                return message;
            }
        });
    }
    
    private boolean validateToken(String token) {
        // TokenéªŒè¯é€»è¾‘
        return true;
    }
    
    private String getUsernameFromToken(String token) {
        // ä»Tokenè§£æç”¨æˆ·å
        return "user";
    }
}
```

**ğŸ”¸ å®¢æˆ·ç«¯ä¼ é€’Token**

```javascript
function connect() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    
    const headers = {
        'Authorization': 'Bearer ' + localStorage.getItem('token')
    };
    
    stompClient.connect(headers, function(frame) {
        console.log('è®¤è¯æˆåŠŸ');
    });
}
```

### 7.2 æ¶ˆæ¯æˆæƒ


**ğŸ”¸ æƒé™æ‹¦æˆªå™¨**

```java
@Component
public class MessageAuthorizationInterceptor implements ChannelInterceptor {
    
    @Override
    public Message<?> preSend(Message<?> message, MessageChannel channel) {
        StompHeaderAccessor accessor = 
            MessageHeaderAccessor.getAccessor(message, StompHeaderAccessor.class);
        
        if (StompCommand.SUBSCRIBE.equals(accessor.getCommand())) {
            String destination = accessor.getDestination();
            Principal user = accessor.getUser();
            
            // æ£€æŸ¥è®¢é˜…æƒé™
            if(!hasPermission(user, destination)) {
                throw new AccessDeniedException("æ— æƒé™è®¢é˜…è¯¥ä¸»é¢˜");
            }
        }
        
        return message;
    }
    
    private boolean hasPermission(Principal user, String destination) {
        // æƒé™æ£€æŸ¥é€»è¾‘
        if(destination.startsWith("/topic/admin")) {
            return isAdmin(user);
        }
        return true;
    }
}
```

**âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹**

> **ğŸ” å¿…é¡»åšçš„å®‰å…¨æªæ–½**ï¼š
> - âœ… ä½¿ç”¨HTTPS/WSSåŠ å¯†ä¼ è¾“
> - âœ… éªŒè¯æ‰€æœ‰å…¥ç«™æ¶ˆæ¯çš„æ¥æº
> - âœ… é™åˆ¶æ¶ˆæ¯å¤§å°å’Œé¢‘ç‡
> - âœ… å®šæœŸæ¸…ç†è¿‡æœŸè¿æ¥
> - âœ… è®°å½•å®‰å…¨æ—¥å¿—ä¾¿äºå®¡è®¡

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ¯ WebSocketæ ¸å¿ƒç‰¹æ€§**
```
âœ… å…¨åŒå·¥é€šä¿¡ï¼šæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½èƒ½ä¸»åŠ¨å‘é€æ¶ˆæ¯
âœ… æŒä¹…è¿æ¥ï¼šä¸€æ¬¡æ¡æ‰‹ï¼Œé•¿æœŸä¿æŒè¿æ¥çŠ¶æ€
âœ… ä½å»¶è¿Ÿï¼šæ¶ˆæ¯å®æ—¶æ¨é€ï¼Œæ— éœ€è½®è¯¢
âœ… åŒå‘æ€§ï¼šæ‰“ç ´HTTPå•å‘è¯·æ±‚-å“åº”æ¨¡å¼
```

**ğŸ¯ å…³é”®é…ç½®è¦ç´ **
```
ğŸ”¸ @EnableWebSocketMessageBrokerï¼šå¯ç”¨WebSocketæ”¯æŒ
ğŸ”¸ registerStompEndpointsï¼šæ³¨å†ŒWebSocketç«¯ç‚¹
ğŸ”¸ configureMessageBrokerï¼šé…ç½®æ¶ˆæ¯ä»£ç†
ğŸ”¸ enableSimpleBrokerï¼šå¯ç”¨å†…å­˜æ¶ˆæ¯ä»£ç†
```

**ğŸ¯ æ¶ˆæ¯å¤„ç†æ ¸å¿ƒ**
```
ğŸ”¸ @MessageMappingï¼šå¤„ç†å®¢æˆ·ç«¯æ¶ˆæ¯
ğŸ”¸ @SendToï¼šå¹¿æ’­æ¶ˆæ¯ç»™è®¢é˜…è€…
ğŸ”¸ SimpMessagingTemplateï¼šçµæ´»å‘é€æ¶ˆæ¯
ğŸ”¸ convertAndSendToUserï¼šç‚¹å¯¹ç‚¹ç§èŠ
```

### 8.2 å®é™…åº”ç”¨åœºæ™¯


| åœºæ™¯ | æŠ€æœ¯é€‰å‹ | æ ¸å¿ƒåŠŸèƒ½ |
|------|---------|---------|
| **åœ¨çº¿èŠå¤©å®¤** | å¹¿æ’­æ¶ˆæ¯ | ç¾¤èŠã€ç³»ç»Ÿé€šçŸ¥ |
| **ç§èŠåŠŸèƒ½** | ç‚¹å¯¹ç‚¹é€šä¿¡ | ç”¨æˆ·é—´ä¸€å¯¹ä¸€æ¶ˆæ¯ |
| **å®æ—¶åä½œ** | ä¼šè¯ç®¡ç† + å¹¿æ’­ | å¤šäººç¼–è¾‘ã€ç™½æ¿ |
| **æ¶ˆæ¯æ¨é€** | å¿ƒè·³æ£€æµ‹ + é‡è¿ | é€šçŸ¥ã€æé†’ |
| **åœ¨çº¿å®¢æœ** | è®¤è¯ + ç§èŠ | å®¢æœå¯¹è¯ç³»ç»Ÿ |

### 8.3 å¼€å‘æœ€ä½³å®è·µ


**âœ… è¿æ¥ç®¡ç†**
- å®ç°å¿ƒè·³æ£€æµ‹ï¼ŒåŠæ—¶å‘ç°æ–­çº¿
- æŒ‡æ•°é€€é¿ç­–ç•¥è¿›è¡Œé‡è¿
- é™åˆ¶æœ€å¤§é‡è¿æ¬¡æ•°é¿å…æ— é™å¾ªç¯

**âœ… æ¶ˆæ¯å¤„ç†**
- ä½¿ç”¨`@MessageMapping`å¤„ç†ä¸šåŠ¡é€»è¾‘
- åˆç†é€‰æ‹©å¹¿æ’­æˆ–ç‚¹å¯¹ç‚¹æ–¹å¼
- å¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œï¼Œé¿å…é˜»å¡

**âœ… å®‰å…¨é˜²æŠ¤**
- è¿æ¥æ—¶è¿›è¡ŒTokenè®¤è¯
- è®¢é˜…æ—¶æ£€æŸ¥æƒé™
- é™åˆ¶æ¶ˆæ¯å¤§å°å’Œå‘é€é¢‘ç‡
- ä½¿ç”¨WSSåŠ å¯†ä¼ è¾“

**âœ… æ€§èƒ½ä¼˜åŒ–**
- åˆç†è®¾ç½®å¿ƒè·³é—´éš”
- åŠæ—¶æ¸…ç†æ— æ•ˆè¿æ¥
- ä½¿ç”¨Redisç­‰å¤–éƒ¨æ¶ˆæ¯ä»£ç†æ”¯æŒé›†ç¾¤

### 8.4 å¸¸è§é—®é¢˜è§£å†³


**â“ è¿æ¥é¢‘ç¹æ–­å¼€**
```
åŸå› ï¼šç½‘ç»œä¸ç¨³å®šã€ä»£ç†è¶…æ—¶
è§£å†³ï¼š
1. å¢åŠ å¿ƒè·³é¢‘ç‡ä¿æŒè¿æ¥
2. ç¼©çŸ­å¿ƒè·³é—´éš”æ—¶é—´
3. å®ç°è‡ªåŠ¨é‡è¿æœºåˆ¶
```

**â“ æ¶ˆæ¯ä¸¢å¤±**
```
åŸå› ï¼šè¿æ¥æ–­å¼€æ—¶å‘é€æ¶ˆæ¯
è§£å†³ï¼š
1. æ£€æŸ¥è¿æ¥çŠ¶æ€å†å‘é€
2. å®ç°æ¶ˆæ¯é˜Ÿåˆ—ç¼“å­˜
3. æ¶ˆæ¯ç¡®è®¤æœºåˆ¶
```

**â“ è·¨åŸŸé—®é¢˜**
```
è§£å†³ï¼šsetAllowedOrigins("*") 
ç”Ÿäº§ç¯å¢ƒï¼šæŒ‡å®šå…·ä½“åŸŸå
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- WebSocketæ˜¯å…¨åŒå·¥å®æ—¶é€šä¿¡åè®®
- é€šè¿‡@EnableWebSocketMessageBrokerå¯ç”¨
- å¹¿æ’­ç”¨/topicï¼Œç§èŠç”¨/queue
- å¿ƒè·³æ£€æµ‹ä¿æ´»ï¼Œæ–­çº¿è‡ªåŠ¨é‡è¿
- è¿æ¥è®¤è¯å’Œæ¶ˆæ¯æˆæƒä¿å®‰å…¨