---
title: 6ã€è·¨åŸŸå¤„ç†CORSé…ç½®
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯è·¨åŸŸé—®é¢˜](#1-ä»€ä¹ˆæ˜¯è·¨åŸŸé—®é¢˜)
2. [åŒæºç­–ç•¥è¯¦è§£](#2-åŒæºç­–ç•¥è¯¦è§£)
3. [CORSè·¨åŸŸè§£å†³æ–¹æ¡ˆ](#3-CORSè·¨åŸŸè§£å†³æ–¹æ¡ˆ)
4. [@CrossOriginæ³¨è§£ä½¿ç”¨](#4-CrossOriginæ³¨è§£ä½¿ç”¨)
5. [å…¨å±€CORSé…ç½®](#5-å…¨å±€CORSé…ç½®)
6. [é¢„æ£€è¯·æ±‚æœºåˆ¶](#6-é¢„æ£€è¯·æ±‚æœºåˆ¶)
7. [Filterå®ç°CORS](#7-Filterå®ç°CORS)
8. [å®‰å…¨æ€§è€ƒè™‘](#8-å®‰å…¨æ€§è€ƒè™‘)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ ä»€ä¹ˆæ˜¯è·¨åŸŸé—®é¢˜


### 1.1 è·¨åŸŸé—®é¢˜çš„æœ¬è´¨


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ åœ¨Aå•†åœºä¹°ä¸œè¥¿ï¼Œå´æƒ³ç”¨Bå•†åœºçš„ä¼šå‘˜å¡ï¼Œå•†åœºè¯´"ä¸è¡Œï¼Œè¿™æ˜¯æˆ‘ä»¬çš„è§„å®š"ã€‚æµè§ˆå™¨ä¹Ÿæœ‰ç±»ä¼¼è§„å®šâ€”â€”ä¸å…è®¸ç½‘é¡µéšæ„è®¿é—®å…¶ä»–ç½‘ç«™çš„èµ„æºã€‚

```
å®é™…åœºæ™¯ä¸¾ä¾‹ï¼š

å‰ç«¯é¡µé¢ï¼šhttp://www.myapp.com
å°è¯•è®¿é—®ï¼šhttp://api.server.com/data

æµè§ˆå™¨æ£€æŸ¥ï¼š
âŒ åŸŸåä¸åŒ(myapp.com â‰  api.server.com)
âŒ æ‹¦æˆªè¯·æ±‚ï¼æç¤ºè·¨åŸŸé”™è¯¯

é”™è¯¯ä¿¡æ¯ï¼š
"Access to XMLHttpRequest at 'http://api.server.com/data' 
from origin 'http://www.myapp.com' has been blocked by CORS policy"
```

**ä¸ºä»€ä¹ˆä¼šæœ‰è·¨åŸŸé™åˆ¶ï¼Ÿ**
- ğŸ›¡ï¸ **å®‰å…¨ä¿æŠ¤**ï¼šé˜²æ­¢æ¶æ„ç½‘ç«™çªƒå–ä½ çš„æ•°æ®
- ğŸ”’ **éšç§ä¿æŠ¤**ï¼šé˜²æ­¢CSRFæ”»å‡»ï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰
- ğŸš« **é˜²æ­¢æ»¥ç”¨**ï¼šé™åˆ¶ç½‘é¡µçš„è®¿é—®æƒé™

### 1.2 ä»€ä¹ˆæƒ…å†µç®—è·¨åŸŸ


```
è·¨åŸŸåˆ¤æ–­æ ‡å‡†ï¼ˆä¸‰è¦ç´ å¿…é¡»å®Œå…¨ç›¸åŒï¼‰ï¼š

âœ… åè®®ç›¸åŒï¼šhttp vs https
âœ… åŸŸåç›¸åŒï¼šwww.a.com vs www.b.com  
âœ… ç«¯å£ç›¸åŒï¼š8080 vs 3000

åˆ¤æ–­ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å½“å‰é¡µé¢              è®¿é—®åœ°å€           æ˜¯å¦è·¨åŸŸ  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ http://a.com       â†’ http://a.com      âœ… åŒæº  â”‚
â”‚ http://a.com       â†’ https://a.com     âŒ è·¨åŸŸ  â”‚
â”‚ http://a.com       â†’ http://b.com      âŒ è·¨åŸŸ  â”‚
â”‚ http://a.com:8080  â†’ http://a.com:3000 âŒ è·¨åŸŸ  â”‚
â”‚ http://a.com/page1 â†’ http://a.com/page2 âœ… åŒæº  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ” åŒæºç­–ç•¥è¯¦è§£


### 2.1 åŒæºç­–ç•¥æ˜¯ä»€ä¹ˆ


**åŒæºç­–ç•¥ï¼ˆSame-Origin Policyï¼‰** - æµè§ˆå™¨çš„æ ¸å¿ƒå®‰å…¨æœºåˆ¶

> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šåŒæºç­–ç•¥å°±åƒå°åŒºé—¨ç¦ï¼Œåªæœ‰åŒä¸€ä¸ªå°åŒºçš„ä½æˆ·æ‰èƒ½äº’ç›¸ä¸²é—¨ï¼Œå¤–æ¥è®¿å®¢éœ€è¦ç»è¿‡ç™»è®°è®¸å¯æ‰èƒ½è¿›å…¥ã€‚

**åŒæºç­–ç•¥çš„ä½œç”¨**ï¼š
```
é™åˆ¶å†…å®¹ï¼š

âŒ ä¸èƒ½è¯»å–Cookieã€LocalStorageã€IndexDB
âŒ ä¸èƒ½æ“ä½œDOMå…ƒç´ 
âŒ ä¸èƒ½å‘é€Ajaxè¯·æ±‚è·å–æ•°æ®

ä¿æŠ¤å¯¹è±¡ï¼š
ğŸ”’ ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯
ğŸ”’ ç½‘ç«™çš„æ•°æ®å®‰å…¨
ğŸ”’ é˜²æ­¢XSSã€CSRFç­‰æ”»å‡»
```

### 2.2 åŒæºç­–ç•¥çš„é™åˆ¶èŒƒå›´


**ä¸‰ä¸ªæ ¸å¿ƒé™åˆ¶**ï¼š

**ğŸ”¸ å­˜å‚¨é™åˆ¶**
```
åœºæ™¯ï¼šAç½‘ç«™æƒ³è¯»å–Bç½‘ç«™çš„Cookie

ç½‘ç«™A(http://a.com)ï¼š
document.cookie  // åªèƒ½è®¿é—®a.comçš„cookie

å°è¯•è®¿é—®Bç½‘ç«™cookieï¼š
// æ— æ³•è®¿é—®b.comçš„cookieï¼Œæµè§ˆå™¨ç›´æ¥æ‹¦æˆª
```

**ğŸ”¸ DOMé™åˆ¶**
```
åœºæ™¯ï¼šé¡µé¢Aæƒ³æ“ä½œiframeä¸­é¡µé¢Bçš„DOM

<iframe src="http://b.com"></iframe>

é¡µé¢Açš„è„šæœ¬ï¼š
const iframe = document.querySelector('iframe');
const bDocument = iframe.contentDocument; // âŒ è·¨åŸŸè®¿é—®è¢«æ‹¦æˆª
```

**ğŸ”¸ ç½‘ç»œè¯·æ±‚é™åˆ¶**
```
åœºæ™¯ï¼šå‰ç«¯è°ƒç”¨åç«¯API

å‰ç«¯(http://localhost:3000)ï¼š
fetch('http://localhost:8080/api/user')
  .then(res => res.json())
  .catch(err => {
    // âŒ CORSé”™è¯¯ï¼šè·¨åŸŸè¯·æ±‚è¢«æ‹¦æˆª
  })
```

---

## 3. ğŸŒ‰ CORSè·¨åŸŸè§£å†³æ–¹æ¡ˆ


### 3.1 CORSæ˜¯ä»€ä¹ˆ


**CORSï¼ˆCross-Origin Resource Sharingï¼‰** = è·¨åŸŸèµ„æºå…±äº«

> ğŸ’¡ **é€šä¿—æ¯”å–»**ï¼šCORSå°±åƒç»™å¤–æ¥è®¿å®¢åŠç†äº†"è®¿é—®è®¸å¯è¯"ï¼ŒæœåŠ¡å™¨è¯´"æˆ‘å…è®¸è¿™ä¸ªåŸŸåçš„ç½‘é¡µè®¿é—®æˆ‘"ï¼Œæµè§ˆå™¨çœ‹åˆ°è®¸å¯è¯å°±æ”¾è¡Œäº†ã€‚

**CORSå·¥ä½œæµç¨‹**ï¼š
```
æµè§ˆå™¨ â†’ æœåŠ¡å™¨ â†’ æµè§ˆå™¨

æ­¥éª¤1ï¼šæµè§ˆå™¨å‘é€è¯·æ±‚
   â†“
   è¯·æ±‚å¤´å¸¦ä¸Šï¼šOrigin: http://localhost:3000

æ­¥éª¤2ï¼šæœåŠ¡å™¨æ£€æŸ¥Origin
   â†“
   è®¾ç½®å“åº”å¤´ï¼šAccess-Control-Allow-Origin: http://localhost:3000

æ­¥éª¤3ï¼šæµè§ˆå™¨æ£€æŸ¥å“åº”å¤´
   â†“
   âœ… OriginåŒ¹é…ï¼Œå…è®¸è®¿é—®
   âŒ Originä¸åŒ¹é…ï¼Œæ‹¦æˆªå“åº”
```

### 3.2 CORSçš„æ ¸å¿ƒå“åº”å¤´


| å“åº”å¤´åç§° | **ä½œç”¨è¯´æ˜** | **ç¤ºä¾‹å€¼** |
|-----------|------------|-----------|
| `Access-Control-Allow-Origin` | **å…è®¸å“ªäº›åŸŸåè®¿é—®**<br/>æœ€é‡è¦çš„å¤´ | `http://localhost:3000`<br/>`*`ï¼ˆæ‰€æœ‰åŸŸåï¼‰ |
| `Access-Control-Allow-Methods` | **å…è®¸çš„HTTPæ–¹æ³•** | `GET, POST, PUT, DELETE` |
| `Access-Control-Allow-Headers` | **å…è®¸çš„è¯·æ±‚å¤´** | `Content-Type, Authorization` |
| `Access-Control-Allow-Credentials` | **æ˜¯å¦å…è®¸å‘é€Cookie** | `true` æˆ– `false` |
| `Access-Control-Max-Age` | **é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰** | `3600`ï¼ˆ1å°æ—¶ï¼‰ |

**å®Œæ•´çš„CORSå“åº”ç¤ºä¾‹**ï¼š
```
HTTPå“åº”å¤´ï¼š

Access-Control-Allow-Origin: http://localhost:3000
Access-Control-Allow-Methods: GET, POST, PUT, DELETE
Access-Control-Allow-Headers: Content-Type, Authorization
Access-Control-Allow-Credentials: true
Access-Control-Max-Age: 3600
```

---

## 4. ğŸ¯ @CrossOriginæ³¨è§£ä½¿ç”¨


### 4.1 @CrossOriginåŸºç¡€ç”¨æ³•


**æœ€ç®€å•çš„ç”¨æ³•**ï¼š
```java
@RestController
@RequestMapping("/api")
public class UserController {
    
    // âœ… å…è®¸æ‰€æœ‰åŸŸåè®¿é—®è¿™ä¸ªæ¥å£
    @CrossOrigin
    @GetMapping("/users")
    public List<User> getUsers() {
        return userService.findAll();
    }
}
```

> ğŸ’¡ **è¯´æ˜**ï¼š`@CrossOrigin` é»˜è®¤å…è®¸æ‰€æœ‰åŸŸåï¼ˆ`*`ï¼‰è®¿é—®ï¼Œé€‚åˆå¼€å‘æµ‹è¯•ï¼Œç”Ÿäº§ç¯å¢ƒè¦æŒ‡å®šå…·ä½“åŸŸåã€‚

### 4.2 æŒ‡å®šå…è®¸çš„åŸŸå


**æŒ‡å®šå•ä¸ªåŸŸå**ï¼š
```java
@RestController
public class ProductController {
    
    // âœ… åªå…è®¸å‰ç«¯é¡¹ç›®è®¿é—®
    @CrossOrigin(origins = "http://localhost:3000")
    @GetMapping("/products")
    public List<Product> getProducts() {
        return productService.findAll();
    }
}
```

**æŒ‡å®šå¤šä¸ªåŸŸå**ï¼š
```java
@CrossOrigin(origins = {
    "http://localhost:3000",      // å¼€å‘ç¯å¢ƒ
    "https://www.myapp.com",      // ç”Ÿäº§ç¯å¢ƒ
    "https://admin.myapp.com"     // ç®¡ç†åå°
})
@GetMapping("/data")
public ResponseEntity<Data> getData() {
    return ResponseEntity.ok(data);
}
```

### 4.3 å®Œæ•´é…ç½®ç¤ºä¾‹


**é…ç½®æ‰€æœ‰å‚æ•°**ï¼š
```java
@CrossOrigin(
    origins = "http://localhost:3000",           // å…è®¸çš„åŸŸå
    methods = {RequestMethod.GET, RequestMethod.POST},  // å…è®¸çš„æ–¹æ³•
    allowedHeaders = {"Content-Type", "Authorization"}, // å…è®¸çš„è¯·æ±‚å¤´
    exposedHeaders = {"X-Custom-Header"},        // æš´éœ²çš„å“åº”å¤´
    allowCredentials = "true",                   // å…è®¸æºå¸¦Cookie
    maxAge = 3600                                // é¢„æ£€è¯·æ±‚ç¼“å­˜1å°æ—¶
)
@PostMapping("/orders")
public Order createOrder(@RequestBody OrderDTO orderDTO) {
    return orderService.create(orderDTO);
}
```

**å‚æ•°è¯¦è§£**ï¼š
- **`origins`**ï¼šå“ªäº›ç½‘ç«™å¯ä»¥è®¿é—®
- **`methods`**ï¼šå…è®¸çš„è¯·æ±‚æ–¹æ³•ï¼ˆGETã€POSTç­‰ï¼‰
- **`allowedHeaders`**ï¼šå…è®¸æºå¸¦çš„è¯·æ±‚å¤´
- **`exposedHeaders`**ï¼šå‰ç«¯JSå¯ä»¥è¯»å–çš„å“åº”å¤´
- **`allowCredentials`**ï¼šæ˜¯å¦å…è®¸å‘é€Cookieï¼ˆéœ€è¦å‰ç«¯ä¹Ÿé…ç½®ï¼‰
- **`maxAge`**ï¼šé¢„æ£€è¯·æ±‚çš„ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰

### 4.4 Controllerç±»çº§åˆ«é…ç½®


**æ•´ä¸ªControllerç»Ÿä¸€é…ç½®**ï¼š
```java
// âœ… ç±»ä¸Šçš„@CrossOriginå¯¹æ‰€æœ‰æ–¹æ³•ç”Ÿæ•ˆ
@CrossOrigin(origins = "http://localhost:3000")
@RestController
@RequestMapping("/api/books")
public class BookController {
    
    @GetMapping
    public List<Book> list() {
        return bookService.findAll();
    }
    
    @PostMapping
    public Book create(@RequestBody Book book) {
        return bookService.save(book);
    }
    
    // âš ï¸ æ–¹æ³•çº§åˆ«çš„é…ç½®ä¼šè¦†ç›–ç±»çº§åˆ«é…ç½®
    @CrossOrigin(origins = "http://admin.myapp.com")
    @DeleteMapping("/{id}")
    public void delete(@PathVariable Long id) {
        bookService.delete(id);
    }
}
```

---

## 5. ğŸŒ å…¨å±€CORSé…ç½®


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦å…¨å±€é…ç½®


**é—®é¢˜åœºæ™¯**ï¼š
```
âŒ æ¯ä¸ªControlleréƒ½å†™@CrossOriginï¼š
   - ä»£ç é‡å¤
   - ç»´æŠ¤å›°éš¾
   - å®¹æ˜“é—æ¼

âœ… å…¨å±€é…ç½®ä¸€æ¬¡ï¼Œå…¨éƒ¨æ¥å£ç”Ÿæ•ˆï¼š
   - ç»Ÿä¸€ç®¡ç†
   - æ˜“äºç»´æŠ¤
   - ä¸ä¼šé—æ¼
```

### 5.2 WebMvcConfigureré…ç½®æ–¹å¼


**æ¨èæ–¹å¼**ï¼šé€šè¿‡é…ç½®ç±»å®ç°

```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")  // å¯¹æ‰€æœ‰æ¥å£ç”Ÿæ•ˆ
                .allowedOrigins("http://localhost:3000")  // å…è®¸çš„åŸŸå
                .allowedMethods("GET", "POST", "PUT", "DELETE")  // å…è®¸çš„æ–¹æ³•
                .allowedHeaders("*")  // å…è®¸æ‰€æœ‰è¯·æ±‚å¤´
                .allowCredentials(true)  // å…è®¸Cookie
                .maxAge(3600);  // é¢„æ£€è¯·æ±‚ç¼“å­˜1å°æ—¶
    }
}
```

**é…ç½®è¯´æ˜**ï¼š
```
æ ¸å¿ƒæ–¹æ³•è§£æï¼š

addMapping("/**")
â†’ é…ç½®å“ªäº›è·¯å¾„éœ€è¦CORS
â†’ /** è¡¨ç¤ºæ‰€æœ‰è·¯å¾„
â†’ /api/** è¡¨ç¤ºåªå¯¹/apiå¼€å¤´çš„è·¯å¾„ç”Ÿæ•ˆ

allowedOrigins("...")  
â†’ å…è®¸å“ªäº›åŸŸåè®¿é—®
â†’ å¯ä»¥é…ç½®å¤šä¸ªï¼šallowedOrigins("http://a.com", "http://b.com")

allowedMethods("...")
â†’ å…è®¸çš„HTTPæ–¹æ³•
â†’ å¸¸ç”¨ï¼šGET, POST, PUT, DELETE, OPTIONS

allowCredentials(true)
â†’ æ˜¯å¦å…è®¸å‘é€Cookie
â†’ è®¾ç½®ä¸ºtrueæ—¶ï¼ŒallowedOriginsä¸èƒ½ç”¨*
```

### 5.3 å¤šåŸŸåé…ç½®


**ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹**ï¼š
```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        
        // é…ç½®1ï¼šå¯¹APIæ¥å£çš„è·¨åŸŸé…ç½®
        registry.addMapping("/api/**")
                .allowedOrigins(
                    "http://localhost:3000",       // æœ¬åœ°å¼€å‘
                    "https://www.myapp.com",       // æ­£å¼ç½‘ç«™
                    "https://m.myapp.com"          // ç§»åŠ¨ç«¯H5
                )
                .allowedMethods("GET", "POST", "PUT", "DELETE")
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);
        
        // é…ç½®2ï¼šå¯¹ç®¡ç†åå°æ¥å£çš„è·¨åŸŸé…ç½®
        registry.addMapping("/admin/**")
                .allowedOrigins("https://admin.myapp.com")  // åªå…è®¸ç®¡ç†åå°
                .allowedMethods("*")
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(7200);
    }
}
```

### 5.4 ä½¿ç”¨é…ç½®æ–‡ä»¶ç®¡ç†


**application.ymlé…ç½®**ï¼š
```yaml
# è‡ªå®šä¹‰CORSé…ç½®
cors:
  allowed-origins: 
    - http://localhost:3000
    - https://www.myapp.com
  allowed-methods: 
    - GET
    - POST
    - PUT
    - DELETE
  allowed-headers: '*'
  allow-credentials: true
  max-age: 3600
```

**è¯»å–é…ç½®çš„Javaç±»**ï¼š
```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    
    @Value("${cors.allowed-origins}")
    private List<String> allowedOrigins;
    
    @Value("${cors.allowed-methods}")
    private List<String> allowedMethods;
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOrigins(allowedOrigins.toArray(new String[0]))
                .allowedMethods(allowedMethods.toArray(new String[0]))
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);
    }
}
```

---

## 6. ğŸ” é¢„æ£€è¯·æ±‚æœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯é¢„æ£€è¯·æ±‚


**é¢„æ£€è¯·æ±‚ï¼ˆPreflight Requestï¼‰** = æµè§ˆå™¨çš„"å®‰å…¨ä¾¦å¯Ÿå…µ"

> ğŸ’¡ **é€šä¿—æ¯”å–»**ï¼šå°±åƒä½ å»é“¶è¡ŒåŠå¤§é¢ä¸šåŠ¡ï¼Œå·¥ä½œäººå‘˜å…ˆé—®"ä½ è¦åŠä»€ä¹ˆä¸šåŠ¡ï¼Ÿå¸¦è¯ä»¶äº†å—ï¼Ÿ"ç¡®è®¤æ²¡é—®é¢˜åæ‰ç»™ä½ åŠç†ã€‚

**è§¦å‘é¢„æ£€è¯·æ±‚çš„æ¡ä»¶**ï¼š
```
æ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶å°±ä¼šå‘é€é¢„æ£€è¯·æ±‚ï¼š

âœ… ä½¿ç”¨äº†éç®€å•æ–¹æ³•
   â†’ PUT, DELETE, PATCHç­‰

âœ… ä½¿ç”¨äº†è‡ªå®šä¹‰è¯·æ±‚å¤´
   â†’ Authorization, X-Custom-Headerç­‰

âœ… Content-Typeä¸æ˜¯ç®€å•ç±»å‹
   â†’ application/json (ä¼šè§¦å‘)
   â†’ application/x-www-form-urlencoded (ä¸ä¼šè§¦å‘)
   â†’ multipart/form-data (ä¸ä¼šè§¦å‘)
```

### 6.2 é¢„æ£€è¯·æ±‚çš„å®Œæ•´æµç¨‹


```
è¯·æ±‚æµç¨‹ç¤ºæ„ï¼š

å‰ç«¯                æµè§ˆå™¨                æœåŠ¡å™¨
 |                   |                    |
 | [1]å‘èµ·è¯·æ±‚        |                    |
 |------------------>|                    |
 |                   | [2]OPTIONSé¢„æ£€     |
 |                   |------------------->|
 |                   |                    | [3]æ£€æŸ¥æ˜¯å¦å…è®¸
 |                   | [4]è¿”å›CORSå¤´       |
 |                   |<-------------------|
 |                   | [5]æ£€æŸ¥å“åº”å¤´       |
 |                   |                    |
 | [6]é¢„æ£€é€šè¿‡        |                    |
 |<------------------|                    |
 |                   | [7]å‘é€çœŸå®è¯·æ±‚     |
 |                   |------------------->|
 |                   | [8]è¿”å›æ•°æ®         |
 | [9]è·å¾—å“åº”        |<-------------------|
 |<------------------|                    |
```

### 6.3 é¢„æ£€è¯·æ±‚ç¤ºä¾‹


**å‰ç«¯å‘èµ·è¯·æ±‚**ï¼š
```javascript
// è¿™ä¸ªè¯·æ±‚ä¼šè§¦å‘é¢„æ£€
fetch('http://localhost:8080/api/data', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer token123'
  },
  body: JSON.stringify({ name: 'test' })
})
```

**æ­¥éª¤1ï¼šæµè§ˆå™¨å…ˆå‘é€OPTIONSé¢„æ£€è¯·æ±‚**ï¼š
```
OPTIONS /api/data HTTP/1.1
Host: localhost:8080
Origin: http://localhost:3000
Access-Control-Request-Method: POST
Access-Control-Request-Headers: content-type,authorization
```

**æ­¥éª¤2ï¼šæœåŠ¡å™¨è¿”å›é¢„æ£€å“åº”**ï¼š
```
HTTP/1.1 200 OK
Access-Control-Allow-Origin: http://localhost:3000
Access-Control-Allow-Methods: GET, POST, PUT, DELETE
Access-Control-Allow-Headers: content-type, authorization
Access-Control-Max-Age: 3600
```

**æ­¥éª¤3ï¼šé¢„æ£€é€šè¿‡ï¼Œå‘é€çœŸå®è¯·æ±‚**ï¼š
```
POST /api/data HTTP/1.1
Host: localhost:8080
Origin: http://localhost:3000
Content-Type: application/json
Authorization: Bearer token123

{"name":"test"}
```

### 6.4 ä¼˜åŒ–é¢„æ£€è¯·æ±‚æ€§èƒ½


**é—®é¢˜**ï¼šæ¯æ¬¡è¯·æ±‚éƒ½é¢„æ£€ä¼šå½±å“æ€§èƒ½

**è§£å†³æ–¹æ¡ˆ1ï¼šè®¾ç½®ç¼“å­˜æ—¶é—´**
```java
@CrossOrigin(maxAge = 3600)  // é¢„æ£€ç»“æœç¼“å­˜1å°æ—¶
```

**è§£å†³æ–¹æ¡ˆ2ï¼šé¿å…è§¦å‘é¢„æ£€**
```javascript
// âŒ ä¼šè§¦å‘é¢„æ£€ï¼ˆapplication/jsonï¼‰
fetch('/api/data', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(data)
})

// âœ… ä¸ä¼šè§¦å‘é¢„æ£€ï¼ˆç®€å•è¯·æ±‚ï¼‰
fetch('/api/data', {
  method: 'POST',
  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
  body: new URLSearchParams(data)
})
```

---

## 7. ğŸ”§ Filterå®ç°CORS


### 7.1 ä¸ºä»€ä¹ˆç”¨Filterå®ç°


**Filteræ–¹å¼çš„ä¼˜åŠ¿**ï¼š
```
âœ… ä¼˜ç‚¹ï¼š
   - æ›´åº•å±‚ï¼Œä¼˜å…ˆçº§é«˜
   - å¯ä»¥ç²¾ç»†æ§åˆ¶
   - å¤„ç†éSpringç®¡ç†çš„èµ„æº
   - çµæ´»åº¦æœ€é«˜

âš ï¸ ç¼ºç‚¹ï¼š
   - ä»£ç ç›¸å¯¹å¤æ‚
   - éœ€è¦æ‰‹åŠ¨å¤„ç†å“åº”å¤´
```

### 7.2 è‡ªå®šä¹‰CORS Filter


**å®Œæ•´çš„Filterå®ç°**ï¼š
```java
@Component
@Order(Ordered.HIGHEST_PRECEDENCE)  // æœ€é«˜ä¼˜å…ˆçº§
public class CorsFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest req, ServletResponse res, 
                         FilterChain chain) throws IOException, ServletException {
        
        HttpServletResponse response = (HttpServletResponse) res;
        HttpServletRequest request = (HttpServletRequest) req;
        
        // è·å–è¯·æ±‚æ¥æº
        String origin = request.getHeader("Origin");
        
        // è®¾ç½®å…è®¸çš„åŸŸåï¼ˆå¯ä»¥æ ¹æ®originåŠ¨æ€åˆ¤æ–­ï¼‰
        if (isAllowedOrigin(origin)) {
            response.setHeader("Access-Control-Allow-Origin", origin);
        }
        
        // è®¾ç½®å…è®¸çš„æ–¹æ³•
        response.setHeader("Access-Control-Allow-Methods", 
            "GET, POST, PUT, DELETE, OPTIONS");
        
        // è®¾ç½®å…è®¸çš„è¯·æ±‚å¤´
        response.setHeader("Access-Control-Allow-Headers", 
            "Origin, Content-Type, Accept, Authorization");
        
        // å…è®¸æºå¸¦Cookie
        response.setHeader("Access-Control-Allow-Credentials", "true");
        
        // é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´
        response.setHeader("Access-Control-Max-Age", "3600");
        
        // OPTIONSè¯·æ±‚ç›´æ¥è¿”å›
        if ("OPTIONS".equalsIgnoreCase(request.getMethod())) {
            response.setStatus(HttpServletResponse.SC_OK);
            return;
        }
        
        // ç»§ç»­æ‰§è¡Œåç»­è¿‡æ»¤å™¨
        chain.doFilter(req, res);
    }
    
    // åˆ¤æ–­æ˜¯å¦å…è®¸è¯¥åŸŸå
    private boolean isAllowedOrigin(String origin) {
        List<String> allowedOrigins = Arrays.asList(
            "http://localhost:3000",
            "https://www.myapp.com"
        );
        return allowedOrigins.contains(origin);
    }
}
```

### 7.3 åŠ¨æ€é…ç½®Filter


**è¯»å–é…ç½®æ–‡ä»¶**ï¼š
```java
@Component
public class CorsFilter implements Filter {
    
    @Value("${cors.allowed-origins}")
    private List<String> allowedOrigins;
    
    @Value("${cors.allowed-methods}")
    private String allowedMethods;
    
    @Override
    public void doFilter(ServletRequest req, ServletResponse res, 
                         FilterChain chain) throws IOException, ServletException {
        
        HttpServletResponse response = (HttpServletResponse) res;
        HttpServletRequest request = (HttpServletRequest) req;
        
        String origin = request.getHeader("Origin");
        
        // åŠ¨æ€æ£€æŸ¥æ˜¯å¦å…è®¸
        if (allowedOrigins.contains(origin)) {
            response.setHeader("Access-Control-Allow-Origin", origin);
            response.setHeader("Access-Control-Allow-Methods", allowedMethods);
            response.setHeader("Access-Control-Allow-Headers", "*");
            response.setHeader("Access-Control-Allow-Credentials", "true");
            response.setHeader("Access-Control-Max-Age", "3600");
        }
        
        if ("OPTIONS".equalsIgnoreCase(request.getMethod())) {
            response.setStatus(HttpServletResponse.SC_OK);
            return;
        }
        
        chain.doFilter(req, res);
    }
}
```

### 7.4 Filter vs é…ç½®ç±» vs æ³¨è§£


| æ–¹å¼ | **ä¼˜å…ˆçº§** | **ä½¿ç”¨åœºæ™¯** | **çµæ´»æ€§** | **æ¨èåº¦** |
|-----|----------|------------|----------|----------|
| **Filter** | â­â­â­ æœ€é«˜ | éœ€è¦ç²¾ç»†æ§åˆ¶<br/>å¤„ç†é™æ€èµ„æº | â­â­â­ | â­â­ |
| **WebMvcConfigurer** | â­â­ ä¸­ç­‰ | å…¨å±€ç»Ÿä¸€é…ç½®<br/>ç”Ÿäº§ç¯å¢ƒæ¨è | â­â­ | â­â­â­ |
| **@CrossOrigin** | â­ æœ€ä½ | ç‰¹å®šæ¥å£é…ç½®<br/>å¿«é€Ÿå¼€å‘æµ‹è¯• | â­ | â­â­ |

**é€‰æ‹©å»ºè®®**ï¼š
```
ğŸ¯ å¼€å‘æµ‹è¯•é˜¶æ®µï¼š
   â†’ ä½¿ç”¨@CrossOriginæ³¨è§£ï¼Œå¿«é€Ÿæ–¹ä¾¿

ğŸ¯ ç”Ÿäº§ç¯å¢ƒï¼š
   â†’ ä½¿ç”¨WebMvcConfigurerå…¨å±€é…ç½®ï¼Œç»Ÿä¸€ç®¡ç†

ğŸ¯ ç‰¹æ®Šéœ€æ±‚ï¼š
   â†’ ä½¿ç”¨Filterï¼Œå®Œå…¨è‡ªå®šä¹‰æ§åˆ¶
```

---

## 8. ğŸ›¡ï¸ å®‰å…¨æ€§è€ƒè™‘


### 8.1 å¸¸è§çš„å®‰å…¨éšæ‚£


**éšæ‚£1ï¼šå…è®¸æ‰€æœ‰åŸŸå**
```java
// âŒ å±é™©ï¼ä»»ä½•ç½‘ç«™éƒ½èƒ½è®¿é—®ä½ çš„æ¥å£
@CrossOrigin(origins = "*")
@GetMapping("/sensitive-data")
public SensitiveData getData() {
    return sensitiveData;
}

// âœ… å®‰å…¨ï¼šæ˜ç¡®æŒ‡å®šå…è®¸çš„åŸŸå
@CrossOrigin(origins = "https://www.myapp.com")
@GetMapping("/sensitive-data")
public SensitiveData getData() {
    return sensitiveData;
}
```

**éšæ‚£2ï¼šå…è®¸å‡­è¯å´ç”¨é€šé…ç¬¦**
```java
// âŒ é”™è¯¯é…ç½®ï¼æµè§ˆå™¨ä¼šæ‹’ç»è¿™ç§é…ç½®
registry.addMapping("/**")
        .allowedOrigins("*")           // âŒ é€šé…ç¬¦
        .allowCredentials(true);        // âŒ å…è®¸å‡­è¯

// âœ… æ­£ç¡®é…ç½®
registry.addMapping("/**")
        .allowedOrigins("https://www.myapp.com")  // âœ… æ˜ç¡®åŸŸå
        .allowCredentials(true);                   // âœ… å…è®¸å‡­è¯
```

### 8.2 ç”Ÿäº§ç¯å¢ƒé…ç½®å»ºè®®


**å®‰å…¨é…ç½®æ¸…å•**ï¼š
```
âœ… å¿…åšé¡¹ï¼š

1. æ˜ç¡®æŒ‡å®šå…è®¸çš„åŸŸåï¼ˆä¸ç”¨*ï¼‰
2. åªå¼€æ”¾å¿…è¦çš„HTTPæ–¹æ³•
3. é™åˆ¶å…è®¸çš„è¯·æ±‚å¤´
4. æ•æ„Ÿæ¥å£é¢å¤–æ ¡éªŒ
5. å®šæœŸå®¡æŸ¥CORSé…ç½®
```

**ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®**ï¼š
```java
@Configuration
public class SecureCorsConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        
        // æ™®é€šAPIæ¥å£
        registry.addMapping("/api/**")
                .allowedOrigins(
                    "https://www.myapp.com",
                    "https://m.myapp.com"
                )
                .allowedMethods("GET", "POST")  // åªå…è®¸è¯»å†™
                .allowedHeaders("Content-Type", "Authorization")
                .allowCredentials(true)
                .maxAge(3600);
        
        // ç®¡ç†åå°æ¥å£ - æ›´ä¸¥æ ¼
        registry.addMapping("/admin/**")
                .allowedOrigins("https://admin.myapp.com")  // å•ä¸€æ¥æº
                .allowedMethods("GET", "POST", "PUT", "DELETE")
                .allowedHeaders("Content-Type", "Authorization", "X-Admin-Token")
                .allowCredentials(true)
                .maxAge(1800);  // 30åˆ†é’Ÿç¼“å­˜
    }
}
```

### 8.3 ç»“åˆæƒé™æ§åˆ¶


**æ¥å£çº§åˆ«çš„å®‰å…¨**ï¼š
```java
@RestController
@RequestMapping("/api")
public class SecureController {
    
    // CORSé…ç½® + æƒé™éªŒè¯
    @CrossOrigin(origins = "https://www.myapp.com")
    @PreAuthorize("hasRole('USER')")  // Spring Securityæƒé™
    @GetMapping("/user-info")
    public UserInfo getUserInfo() {
        return userService.getCurrentUserInfo();
    }
    
    // æ•æ„Ÿæ“ä½œéœ€è¦æ›´é«˜æƒé™
    @CrossOrigin(origins = "https://admin.myapp.com")
    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/users/{id}")
    public void deleteUser(@PathVariable Long id) {
        userService.delete(id);
    }
}
```

### 8.4 CSRFé˜²æŠ¤


**CORSä¸CSRFçš„å…³ç³»**ï¼š
```
CORSï¼šæ§åˆ¶å“ªäº›åŸŸåå¯ä»¥è®¿é—®
CSRFï¼šé˜²æ­¢æ¶æ„ç½‘ç«™å†’å……ç”¨æˆ·æ“ä½œ

âš ï¸ æ³¨æ„ï¼šCORSä¸èƒ½å®Œå…¨é˜²æ­¢CSRFæ”»å‡»ï¼
```

**ç»“åˆCSRF Token**ï¼š
```java
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .cors()  // å¯ç”¨CORS
            .and()
            .csrf()  // å¯ç”¨CSRFé˜²æŠ¤
                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
            .and()
            .authorizeRequests()
                .anyRequest().authenticated();
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è·¨åŸŸæœ¬è´¨ï¼šæµè§ˆå™¨çš„åŒæºç­–ç•¥å®‰å…¨é™åˆ¶
ğŸ”¸ åŒæºæ ‡å‡†ï¼šåè®®ã€åŸŸåã€ç«¯å£ä¸‰è¦ç´ å¿…é¡»å®Œå…¨ç›¸åŒ
ğŸ”¸ CORSåŸç†ï¼šæœåŠ¡å™¨é€šè¿‡å“åº”å¤´å‘Šè¯‰æµè§ˆå™¨"æˆ‘å…è®¸ä½ è®¿é—®"
ğŸ”¸ é¢„æ£€è¯·æ±‚ï¼šå¤æ‚è¯·æ±‚å‰çš„OPTIONSä¾¦å¯Ÿè¯·æ±‚
ğŸ”¸ ä¸‰ç§é…ç½®ï¼š@CrossOriginæ³¨è§£ã€å…¨å±€é…ç½®ã€Filterå®ç°
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ CORSé…ç½®ä¼˜å…ˆçº§**
```
Filter > å…¨å±€é…ç½® > @CrossOriginæ³¨è§£

å®é™…å·¥ä½œä¸­ï¼š
â†’ ä¼˜å…ˆç”¨å…¨å±€é…ç½®ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
â†’ ç‰¹æ®Šæ¥å£ç”¨@CrossOriginï¼ˆä¸ªæ€§åŒ–ï¼‰
â†’ å¤æ‚éœ€æ±‚ç”¨Filterï¼ˆå®Œå…¨æ§åˆ¶ï¼‰
```

**ğŸ”¹ é¢„æ£€è¯·æ±‚çš„è§¦å‘æ¡ä»¶**
```
ç®€å•è¯·æ±‚ï¼ˆä¸è§¦å‘é¢„æ£€ï¼‰ï¼š
âœ… GETã€HEADã€POSTæ–¹æ³•
âœ… ç®€å•Content-Typeï¼ˆform-urlencodedç­‰ï¼‰
âœ… åªç”¨ç®€å•è¯·æ±‚å¤´

å¤æ‚è¯·æ±‚ï¼ˆè§¦å‘é¢„æ£€ï¼‰ï¼š
âŒ PUTã€DELETEç­‰æ–¹æ³•
âŒ application/json
âŒ è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼ˆAuthorizationç­‰ï¼‰
```

**ğŸ”¹ å®‰å…¨é…ç½®åŸåˆ™**
```
ç”Ÿäº§ç¯å¢ƒï¼š
âŒ ä¸ç”¨ origins = "*"
âŒ allowCredentialsè¦é…åˆæ˜ç¡®åŸŸå
âœ… åªå¼€æ”¾å¿…è¦çš„æ–¹æ³•å’Œå¤´
âœ… å®šæœŸå®¡æŸ¥é…ç½®
```

### 9.3 å®é™…åº”ç”¨å»ºè®®


**å¼€å‘é˜¶æ®µé…ç½®**ï¼š
```java
// å¿«é€Ÿå¼€å‘ - å…è®¸æ‰€æœ‰
@CrossOrigin
@RestController
public class DevController {
    // å¼€å‘æ—¶å¿«é€Ÿæµ‹è¯•
}
```

**ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š
```java
// ä¸¥æ ¼å®‰å…¨ - æ˜ç¡®æŒ‡å®š
@Configuration
public class ProdCorsConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOrigins(
                    "https://www.myapp.com",
                    "https://m.myapp.com"
                )
                .allowedMethods("GET", "POST", "PUT", "DELETE")
                .allowedHeaders("Content-Type", "Authorization")
                .allowCredentials(true)
                .maxAge(3600);
    }
}
```

### 9.4 å¸¸è§é—®é¢˜è§£å†³


**é—®é¢˜1ï¼šé…ç½®äº†CORSè¿˜æ˜¯æŠ¥é”™**
```
æ£€æŸ¥æ¸…å•ï¼š
â–¡ Originæ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­
â–¡ æ–¹æ³•æ˜¯å¦å…è®¸ï¼ˆGETã€POSTç­‰ï¼‰
â–¡ è¯·æ±‚å¤´æ˜¯å¦å…è®¸
â–¡ allowCredentialsä¸originsé…ç½®æ˜¯å¦å†²çª
â–¡ è¿‡æ»¤å™¨é¡ºåºæ˜¯å¦æ­£ç¡®
```

**é—®é¢˜2ï¼šé¢„æ£€è¯·æ±‚è¿”å›403**
```
åŸå› ï¼šOPTIONSè¯·æ±‚è¢«æ‹¦æˆªäº†

è§£å†³ï¼š
â†’ æ”¾è¡ŒOPTIONSè¯·æ±‚
â†’ æˆ–åœ¨Filterä¸­å•ç‹¬å¤„ç†OPTIONS
```

**é—®é¢˜3ï¼šå¸¦Cookieçš„è·¨åŸŸè¯·æ±‚å¤±è´¥**
```
å‰ç«¯é…ç½®ï¼š
fetch(url, {
  credentials: 'include'  // âœ… å¿…é¡»è®¾ç½®
})

åç«¯é…ç½®ï¼š
.allowedOrigins("https://www.myapp.com")  // âœ… æ˜ç¡®åŸŸå
.allowCredentials(true)  // âœ… å…è®¸å‡­è¯
```

### 9.5 å¿«é€Ÿå‚è€ƒè¡¨


| é…ç½®æ–¹å¼ | **ä»£ç ä½ç½®** | **é€‚ç”¨åœºæ™¯** | **ç¤ºä¾‹** |
|---------|------------|------------|---------|
| **æ³¨è§£** | Controlleræ–¹æ³•/ç±»ä¸Š | ç‰¹å®šæ¥å£å¿«é€Ÿé…ç½® | `@CrossOrigin(origins="...")` |
| **å…¨å±€é…ç½®** | WebMvcConfigurerå®ç°ç±» | ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ¥å£ | `addCorsMappings(registry)` |
| **Filter** | Filterå®ç°ç±» | åº•å±‚æ§åˆ¶/é™æ€èµ„æº | `implements Filter` |

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- è·¨åŸŸæºäºåŒæºç­–ç•¥ï¼Œå®‰å…¨ç¬¬ä¸€è¦è®°ç‰¢
- CORSå“åº”å¤´æ¥æ”¾è¡Œï¼Œé¢„æ£€OPTIONSå…ˆä¾¦æŸ¥  
- æ³¨è§£å¿«æ·å…¨å±€ç»Ÿä¸€ï¼ŒFilteråº•å±‚æ§åˆ¶å¼º
- ç”Ÿäº§æ˜ç¡®åŸŸååˆ—è¡¨ï¼Œå‡­è¯é€šé…ä¸å¯ç”¨