---
title: 1ã€æ‹¦æˆªå™¨æ¦‚å¿µä¸é…ç½®
---
## ğŸ“š ç›®å½•

1. [æ‹¦æˆªå™¨æ˜¯ä»€ä¹ˆ](#1-æ‹¦æˆªå™¨æ˜¯ä»€ä¹ˆ)
2. [HandlerInterceptoræ¥å£è¯¦è§£](#2-HandlerInterceptoræ¥å£è¯¦è§£)
3. [æ‹¦æˆªå™¨ç”Ÿå‘½å‘¨æœŸ](#3-æ‹¦æˆªå™¨ç”Ÿå‘½å‘¨æœŸ)
4. [æ‹¦æˆªå™¨é…ç½®ä¸æ³¨å†Œ](#4-æ‹¦æˆªå™¨é…ç½®ä¸æ³¨å†Œ)
5. [æ‹¦æˆªèŒƒå›´æ§åˆ¶](#5-æ‹¦æˆªèŒƒå›´æ§åˆ¶)
6. [æ‹¦æˆªå™¨é“¾ç®¡ç†](#6-æ‹¦æˆªå™¨é“¾ç®¡ç†)
7. [å®æˆ˜åº”ç”¨åœºæ™¯](#7-å®æˆ˜åº”ç”¨åœºæ™¯)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ‹¦æˆªå™¨æ˜¯ä»€ä¹ˆ


### 1.1 ç”Ÿæ´»ä¸­çš„æ‹¦æˆªå™¨


> ğŸ’¡ **ç±»æ¯”ç†è§£**ï¼šæ‹¦æˆªå™¨å°±åƒæœºåœºå®‰æ£€ã€å°åŒºé—¨å«ï¼Œåœ¨ä½ è¿›å…¥ç›®æ ‡åœ°ç‚¹ä¹‹å‰å…ˆæ£€æŸ¥ä¸€é

```
æ™®é€šæµç¨‹ï¼š
ç”¨æˆ·è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€> Controllerå¤„ç† â”€â”€â”€â”€â”€â”€â”€â”€> è¿”å›ç»“æœ

åŠ å…¥æ‹¦æˆªå™¨ï¼š
ç”¨æˆ·è¯·æ±‚ â”€â”€> [æ‹¦æˆªå™¨æ£€æŸ¥] â”€â”€> Controllerå¤„ç† â”€â”€> [æ‹¦æˆªå™¨å¤„ç†] â”€â”€> è¿”å›ç»“æœ
              â†“                                    â†“
           å¯ä»¥æ‹¦æˆª                              å¯ä»¥ä¿®æ”¹å“åº”
```

### 1.2 æ‹¦æˆªå™¨çš„æœ¬è´¨


**æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰** æ˜¯Spring MVCæä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥åœ¨è¯·æ±‚å¤„ç†çš„**å‰ã€ä¸­ã€å**ä¸‰ä¸ªæ—¶æœºæ’å…¥è‡ªå®šä¹‰é€»è¾‘ã€‚

**æ ¸å¿ƒä½œç”¨**ï¼š
- âœ… **è¯·æ±‚é¢„å¤„ç†**ï¼šåœ¨Controlleræ‰§è¡Œå‰åšç»Ÿä¸€å¤„ç†ï¼ˆæƒé™éªŒè¯ã€æ—¥å¿—è®°å½•ç­‰ï¼‰
- âœ… **å“åº”åå¤„ç†**ï¼šåœ¨è¿”å›ç»“æœå‰åšç»Ÿä¸€å¤„ç†ï¼ˆæ•°æ®åŠ å·¥ã€å“åº”ä¿®æ”¹ç­‰ï¼‰
- âœ… **èµ„æºæ¸…ç†**ï¼šè¯·æ±‚å®Œæˆååšæ¸…ç†å·¥ä½œï¼ˆå…³é—­è¿æ¥ã€è®°å½•è€—æ—¶ç­‰ï¼‰

**æ‹¦æˆªå™¨ vs è¿‡æ»¤å™¨å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | **æ‹¦æˆªå™¨ Interceptor** | **è¿‡æ»¤å™¨ Filter** |
|------|----------------------|------------------|
| **ä½œç”¨å±‚æ¬¡** | Spring MVCå±‚ï¼Œåªæ‹¦æˆªController | Servletå®¹å™¨å±‚ï¼Œæ‹¦æˆªæ‰€æœ‰è¯·æ±‚ |
| **æ‰§è¡Œæ—¶æœº** | DispatcherServletä¹‹å | DispatcherServletä¹‹å‰ |
| **èƒ½è®¿é—®çš„å¯¹è±¡** | âœ… Springå®¹å™¨å¯¹è±¡ã€Handlerä¿¡æ¯ | âŒ åªèƒ½è®¿é—®Request/Response |
| **é…ç½®æ–¹å¼** | Springé…ç½®ç±» | web.xmlæˆ–@WebFilter |
| **é€‚ç”¨åœºæ™¯** | ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„æ‹¦æˆª | ç¼–ç ã€è·¨åŸŸç­‰åº•å±‚æ‹¦æˆª |

---

## 2. ğŸ”§ HandlerInterceptoræ¥å£è¯¦è§£


### 2.1 æ¥å£å®šä¹‰


**HandlerInterceptor** æ˜¯Spring MVCæä¾›çš„æ ¸å¿ƒæ‹¦æˆªå™¨æ¥å£ï¼ŒåŒ…å«ä¸‰ä¸ªå…³é”®æ–¹æ³•ï¼š

```java
public interface HandlerInterceptor {
    
    // â‘  é¢„å¤„ç†ï¼šControlleræ‰§è¡Œå‰è°ƒç”¨
    boolean preHandle(HttpServletRequest request, 
                     HttpServletResponse response, 
                     Object handler) throws Exception;
    
    // â‘¡ åå¤„ç†ï¼šControlleræ‰§è¡Œåã€è§†å›¾æ¸²æŸ“å‰è°ƒç”¨
    void postHandle(HttpServletRequest request, 
                   HttpServletResponse response, 
                   Object handler, 
                   ModelAndView modelAndView) throws Exception;
    
    // â‘¢ å®Œæˆå¤„ç†ï¼šè§†å›¾æ¸²æŸ“åè°ƒç”¨
    void afterCompletion(HttpServletRequest request, 
                        HttpServletResponse response, 
                        Object handler, 
                        Exception ex) throws Exception;
}
```

### 2.2 ä¸‰å¤§æ–¹æ³•è¯¦è§£


**â‘  preHandle - é¢„å¤„ç†æ–¹æ³•**

**ä½œç”¨æ—¶æœº**ï¼šåœ¨Controlleræ–¹æ³•æ‰§è¡Œ**ä¹‹å‰**è°ƒç”¨

**å‚æ•°è¯´æ˜**ï¼š
- `request`ï¼šå½“å‰HTTPè¯·æ±‚å¯¹è±¡
- `response`ï¼šå½“å‰HTTPå“åº”å¯¹è±¡  
- `handler`ï¼šå°†è¦æ‰§è¡Œçš„Controlleræ–¹æ³•å¯¹è±¡ï¼ˆå¯ä»¥è·å–æ–¹æ³•ä¿¡æ¯ï¼‰

**è¿”å›å€¼**ï¼š
- `true`ï¼šæ”¾è¡Œï¼Œç»§ç»­æ‰§è¡Œåç»­æ‹¦æˆªå™¨å’ŒController
- `false`ï¼šæ‹¦æˆªï¼Œä¸å†æ‰§è¡Œåç»­æµç¨‹

**å…¸å‹åº”ç”¨**ï¼š
```java
@Override
public boolean preHandle(HttpServletRequest request, 
                        HttpServletResponse response, 
                        Object handler) {
    // åœºæ™¯1ï¼šæƒé™éªŒè¯
    String token = request.getHeader("Authorization");
    if (token == null) {
        response.setStatus(401);
        return false; // æ‹¦æˆªè¯·æ±‚
    }
    
    // åœºæ™¯2ï¼šè®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
    request.setAttribute("startTime", System.currentTimeMillis());
    
    return true; // æ”¾è¡Œ
}
```

---

**â‘¡ postHandle - åå¤„ç†æ–¹æ³•**

**ä½œç”¨æ—¶æœº**ï¼šControlleræ–¹æ³•æ‰§è¡Œ**ä¹‹å**ã€è§†å›¾æ¸²æŸ“**ä¹‹å‰**è°ƒç”¨

**å‚æ•°è¯´æ˜**ï¼š
- `modelAndView`ï¼šControllerè¿”å›çš„æ¨¡å‹å’Œè§†å›¾å¯¹è±¡ï¼ˆå¯ä»¥ä¿®æ”¹ï¼‰

**ç‰¹ç‚¹**ï¼š
- âš ï¸ å¦‚æœControlleræŠ›å¼‚å¸¸ï¼Œæ­¤æ–¹æ³•**ä¸ä¼šæ‰§è¡Œ**
- âœ… å¯ä»¥ä¿®æ”¹ModelAndViewï¼Œå½±å“æœ€ç»ˆæ¸²æŸ“ç»“æœ

**å…¸å‹åº”ç”¨**ï¼š
```java
@Override
public void postHandle(HttpServletRequest request, 
                      HttpServletResponse response, 
                      Object handler, 
                      ModelAndView modelAndView) {
    // åœºæ™¯ï¼šç»Ÿä¸€æ·»åŠ å…¬å…±æ•°æ®
    if (modelAndView != null) {
        modelAndView.addObject("currentTime", new Date());
        modelAndView.addObject("serverName", "MyApp");
    }
}
```

---

**â‘¢ afterCompletion - å®Œæˆå¤„ç†æ–¹æ³•**

**ä½œç”¨æ—¶æœº**ï¼šè§†å›¾æ¸²æŸ“**å®Œæˆå**è°ƒç”¨ï¼ˆæ•´ä¸ªè¯·æ±‚ç»“æŸï¼‰

**å‚æ•°è¯´æ˜**ï¼š
- `ex`ï¼šå¦‚æœæœ‰å¼‚å¸¸ï¼Œä¼ å…¥å¼‚å¸¸å¯¹è±¡ï¼›å¦åˆ™ä¸ºnull

**ç‰¹ç‚¹**ï¼š
- âœ… **æ€»æ˜¯ä¼šæ‰§è¡Œ**ï¼Œå³ä½¿Controlleræˆ–postHandleæŠ›å¼‚å¸¸
- âœ… é€‚åˆåšèµ„æºæ¸…ç†ã€æ—¥å¿—è®°å½•ç­‰æ”¶å°¾å·¥ä½œ

**å…¸å‹åº”ç”¨**ï¼š
```java
@Override
public void afterCompletion(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler, 
                           Exception ex) {
    // åœºæ™¯ï¼šè®¡ç®—è¯·æ±‚è€—æ—¶
    Long startTime = (Long) request.getAttribute("startTime");
    long duration = System.currentTimeMillis() - startTime;
    System.out.println("è¯·æ±‚è€—æ—¶ï¼š" + duration + "ms");
    
    // è®°å½•å¼‚å¸¸ä¿¡æ¯
    if (ex != null) {
        System.err.println("è¯·æ±‚å¼‚å¸¸ï¼š" + ex.getMessage());
    }
}
```

---

## 3. â±ï¸ æ‹¦æˆªå™¨ç”Ÿå‘½å‘¨æœŸ


### 3.1 å®Œæ•´æ‰§è¡Œæµç¨‹


```
è¯·æ±‚åˆ°è¾¾
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘  preHandle(æ‹¦æˆªå™¨1) â†’ è¿”å›true?    â”‚
â”‚     â†“ true                           â”‚
â”‚  â‘¡ preHandle(æ‹¦æˆªå™¨2) â†’ è¿”å›true?    â”‚
â”‚     â†“ true                           â”‚
â”‚  â‘¢ æ‰§è¡ŒControlleræ–¹æ³•                â”‚
â”‚     â†“                                â”‚
â”‚  â‘£ postHandle(æ‹¦æˆªå™¨2) â† é€†åºæ‰§è¡Œ    â”‚
â”‚     â†“                                â”‚
â”‚  â‘¤ postHandle(æ‹¦æˆªå™¨1)               â”‚
â”‚     â†“                                â”‚
â”‚  â‘¥ æ¸²æŸ“è§†å›¾                          â”‚
â”‚     â†“                                â”‚
â”‚  â‘¦ afterCompletion(æ‹¦æˆªå™¨2) â† é€†åº   â”‚
â”‚     â†“                                â”‚
â”‚  â‘§ afterCompletion(æ‹¦æˆªå™¨1)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
å“åº”è¿”å›
```

### 3.2 å…³é”®ç‰¹æ€§è¯´æ˜


**æ‰§è¡Œé¡ºåºç‰¹ç‚¹**ï¼š
- `preHandle`ï¼š**æ­£åº**æ‰§è¡Œï¼ˆæ‹¦æˆªå™¨1 â†’ æ‹¦æˆªå™¨2ï¼‰
- `postHandle`ï¼š**é€†åº**æ‰§è¡Œï¼ˆæ‹¦æˆªå™¨2 â†’ æ‹¦æˆªå™¨1ï¼‰
- `afterCompletion`ï¼š**é€†åº**æ‰§è¡Œï¼ˆæ‹¦æˆªå™¨2 â†’ æ‹¦æˆªå™¨1ï¼‰

**ä¸­æ–­æƒ…å†µ**ï¼š
```
æƒ…å†µ1ï¼špreHandleè¿”å›false
æ‹¦æˆªå™¨1.preHandle() â†’ true
æ‹¦æˆªå™¨2.preHandle() â†’ false âœ— ä¸­æ–­
â†“
åªæ‰§è¡Œ æ‹¦æˆªå™¨1.afterCompletion()

æƒ…å†µ2ï¼šControlleræŠ›å¼‚å¸¸
æ‹¦æˆªå™¨1.preHandle() â†’ true
æ‹¦æˆªå™¨2.preHandle() â†’ true
Controlleræ‰§è¡Œ â†’ æŠ›å¼‚å¸¸ âœ—
â†“
è·³è¿‡ postHandleï¼Œç›´æ¥æ‰§è¡Œ afterCompletion
```

### 3.3 å®é™…æ‰§è¡Œç¤ºä¾‹


å‡è®¾æœ‰ä¸¤ä¸ªæ‹¦æˆªå™¨ï¼šç™»å½•æ‹¦æˆªå™¨ã€æ—¥å¿—æ‹¦æˆªå™¨

```java
// å®Œæ•´æ‰§è¡Œæ—¥å¿—ï¼š
[ç™»å½•æ‹¦æˆªå™¨] preHandle - æ£€æŸ¥ç™»å½•çŠ¶æ€
[æ—¥å¿—æ‹¦æˆªå™¨] preHandle - è®°å½•è¯·æ±‚å¼€å§‹
[Controller] æ‰§è¡Œä¸šåŠ¡é€»è¾‘
[æ—¥å¿—æ‹¦æˆªå™¨] postHandle - æ·»åŠ å“åº”å¤´
[ç™»å½•æ‹¦æˆªå™¨] postHandle - æ›´æ–°ä¼šè¯æ—¶é—´
[è§†å›¾æ¸²æŸ“] ç”ŸæˆHTML
[æ—¥å¿—æ‹¦æˆªå™¨] afterCompletion - è®°å½•è¯·æ±‚ç»“æŸ
[ç™»å½•æ‹¦æˆªå™¨] afterCompletion - æ¸…ç†ThreadLocal
```

---

## 4. ğŸ“ æ‹¦æˆªå™¨é…ç½®ä¸æ³¨å†Œ


### 4.1 åˆ›å»ºæ‹¦æˆªå™¨


**æ–¹å¼1ï¼šå®ç°HandlerInterceptoræ¥å£**

```java
@Component
public class LoginInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) {
        // æ£€æŸ¥sessionä¸­æ˜¯å¦æœ‰ç”¨æˆ·ä¿¡æ¯
        HttpSession session = request.getSession();
        if (session.getAttribute("user") != null) {
            return true; // å·²ç™»å½•ï¼Œæ”¾è¡Œ
        }
        
        // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
        response.sendRedirect("/login");
        return false;
    }
}
```

**æ–¹å¼2ï¼šç»§æ‰¿HandlerInterceptorAdapterï¼ˆå·²è¿‡æ—¶ï¼‰**

```java
// Spring 5.3åæ¨èç›´æ¥å®ç°æ¥å£
public class MyInterceptor extends HandlerInterceptorAdapter {
    // åªéœ€è¦é‡å†™éœ€è¦çš„æ–¹æ³•
}
```

### 4.2 æ³¨å†Œæ‹¦æˆªå™¨


**æ ¸å¿ƒé…ç½®ç±»**ï¼šå®ç° `WebMvcConfigurer` æ¥å£

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Autowired
    private LoginInterceptor loginInterceptor;
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // æ³¨å†Œæ‹¦æˆªå™¨
        registry.addInterceptor(loginInterceptor)
                .addPathPatterns("/**")           // æ‹¦æˆªæ‰€æœ‰è·¯å¾„
                .excludePathPatterns("/login",    // æ’é™¤ç™»å½•é¡µ
                                    "/register",  // æ’é™¤æ³¨å†Œé¡µ
                                    "/static/**"); // æ’é™¤é™æ€èµ„æº
    }
}
```

### 4.3 æ³¨å†Œé¡ºåº


**é¡ºåºæ§åˆ¶**ï¼šä½¿ç”¨ `.order()` æ–¹æ³•

```java
@Override
public void addInterceptors(InterceptorRegistry registry) {
    // é¡ºåº1ï¼šæ—¥å¿—æ‹¦æˆªå™¨ï¼ˆæœ€å…ˆæ‰§è¡Œï¼‰
    registry.addInterceptor(new LogInterceptor())
            .addPathPatterns("/**")
            .order(1);
    
    // é¡ºåº2ï¼šç™»å½•æ‹¦æˆªå™¨
    registry.addInterceptor(loginInterceptor)
            .addPathPatterns("/**")
            .order(2);
    
    // é¡ºåº3ï¼šæƒé™æ‹¦æˆªå™¨ï¼ˆæœ€åæ‰§è¡Œï¼‰
    registry.addInterceptor(new AuthInterceptor())
            .addPathPatterns("/admin/**")
            .order(3);
}
```

**æ‰§è¡Œé¡ºåº**ï¼šæ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œï¼ˆé»˜è®¤ä¸º0ï¼‰

---

## 5. ğŸ¯ æ‹¦æˆªèŒƒå›´æ§åˆ¶


### 5.1 è·¯å¾„åŒ¹é…è§„åˆ™


**é€šé…ç¬¦è¯´æ˜**ï¼š

| é€šé…ç¬¦ | **å«ä¹‰** | **ç¤ºä¾‹** | **åŒ¹é…è·¯å¾„** |
|--------|---------|---------|-------------|
| `?` | åŒ¹é…å•ä¸ªå­—ç¬¦ | `/user/?` | `/user/1`ã€`/user/a` |
| `*` | åŒ¹é…ä»»æ„å­—ç¬¦ï¼ˆä¸å«`/`ï¼‰ | `/user/*` | `/user/list`ã€`/user/add` |
| `**` | åŒ¹é…ä»»æ„è·¯å¾„ | `/user/**` | `/user/1/info`ã€`/user/a/b/c` |

**å…¸å‹é…ç½®**ï¼š

```java
registry.addInterceptor(interceptor)
    // æ‹¦æˆªæ¨¡å¼
    .addPathPatterns(
        "/api/**",          // æ‹¦æˆªæ‰€æœ‰API
        "/admin/**",        // æ‹¦æˆªç®¡ç†åå°
        "/user/*/orders"    // æ‹¦æˆªç”¨æˆ·è®¢å•
    )
    // æ’é™¤æ¨¡å¼
    .excludePathPatterns(
        "/api/public/**",   // æ’é™¤å…¬å¼€API
        "/admin/login",     // æ’é™¤ç™»å½•é¡µ
        "/**/*.html",       // æ’é™¤æ‰€æœ‰HTML
        "/static/**"        // æ’é™¤é™æ€èµ„æº
    );
```

### 5.2 ç²¾ç¡®æ§åˆ¶æŠ€å·§


**â‘  æŒ‰è¯·æ±‚æ–¹æ³•æ‹¦æˆª**

```java
@Override
public boolean preHandle(HttpServletRequest request, 
                        HttpServletResponse response, 
                        Object handler) {
    String method = request.getMethod();
    
    // åªæ‹¦æˆªPOSTè¯·æ±‚
    if ("POST".equals(method)) {
        // æ£€æŸ¥CSRF Token
    }
    
    return true;
}
```

**â‘¡ æŒ‰æ³¨è§£æ‹¦æˆª**

```java
@Override
public boolean preHandle(HttpServletRequest request, 
                        HttpServletResponse response, 
                        Object handler) {
    if (handler instanceof HandlerMethod) {
        HandlerMethod method = (HandlerMethod) handler;
        
        // æ£€æŸ¥æ–¹æ³•ä¸Šæ˜¯å¦æœ‰@RequireLoginæ³¨è§£
        RequireLogin annotation = method.getMethodAnnotation(RequireLogin.class);
        if (annotation != null) {
            // æ‰§è¡Œç™»å½•æ£€æŸ¥
        }
    }
    return true;
}
```

**â‘¢ æŒ‰IPæ‹¦æˆª**

```java
@Override
public boolean preHandle(HttpServletRequest request, 
                        HttpServletResponse response, 
                        Object handler) {
    String ip = request.getRemoteAddr();
    
    // IPé»‘åå•æ£€æŸ¥
    if (blackList.contains(ip)) {
        response.setStatus(403);
        return false;
    }
    
    return true;
}
```

---

## 6. ğŸ”— æ‹¦æˆªå™¨é“¾ç®¡ç†


### 6.1 æ‹¦æˆªå™¨é“¾çš„æ¦‚å¿µ


**æ‹¦æˆªå™¨é“¾ï¼ˆInterceptor Chainï¼‰**ï¼šå¤šä¸ªæ‹¦æˆªå™¨æŒ‰ç…§æ³¨å†Œé¡ºåºç»„æˆçš„æ‰§è¡Œé“¾

```
è¯·æ±‚ â†’ [æ‹¦æˆªå™¨A] â†’ [æ‹¦æˆªå™¨B] â†’ [æ‹¦æˆªå™¨C] â†’ Controller
       â†“           â†“           â†“
     preHandle   preHandle   preHandle
       â†“           â†“           â†“
     postHandle  postHandle  postHandle (é€†åº)
       â†“           â†“           â†“
  afterCompletion afterCompletion afterCompletion (é€†åº)
```

### 6.2 é“¾å¼æ‰§è¡ŒåŸç†


**æ‰§è¡Œé€»è¾‘**ï¼š

```java
// Springå†…éƒ¨ä¼ªä»£ç 
boolean applyPreHandle(request, response, chain) {
    for (int i = 0; i < interceptors.length; i++) {
        if (!interceptors[i].preHandle(request, response, handler)) {
            // æŸä¸ªæ‹¦æˆªå™¨è¿”å›falseï¼Œè§¦å‘å·²æ‰§è¡Œæ‹¦æˆªå™¨çš„afterCompletion
            triggerAfterCompletion(i - 1);
            return false;
        }
    }
    return true;
}
```

### 6.3 é“¾ç®¡ç†æœ€ä½³å®è·µ


**â‘  åˆç†åˆ†å±‚**

```
å±‚çº§1ï¼šåŸºç¡€æ‹¦æˆªå™¨ï¼ˆæ—¥å¿—ã€è·¨åŸŸã€ç¼–ç ï¼‰
    â†“
å±‚çº§2ï¼šå®‰å…¨æ‹¦æˆªå™¨ï¼ˆç™»å½•ã€æƒé™ã€é˜²é‡æ”¾ï¼‰
    â†“
å±‚çº§3ï¼šä¸šåŠ¡æ‹¦æˆªå™¨ï¼ˆæ•°æ®æ ¡éªŒã€ä¸šåŠ¡è§„åˆ™ï¼‰
    â†“
Controller
```

**â‘¡ é¿å…å¾ªç¯ä¾èµ–**

```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šæ‹¦æˆªå™¨Aä¾èµ–æ‹¦æˆªå™¨Bçš„å¤„ç†ç»“æœ
public class InterceptorA implements HandlerInterceptor {
    @Autowired
    private InterceptorB interceptorB; // ä¸æ¨è
}

// âœ… æ­£ç¡®åšæ³•ï¼šé€šè¿‡RequeståŸŸä¼ é€’æ•°æ®
public class InterceptorA implements HandlerInterceptor {
    public boolean preHandle(...) {
        request.setAttribute("dataFromA", "value");
        return true;
    }
}

public class InterceptorB implements HandlerInterceptor {
    public boolean preHandle(...) {
        String data = (String) request.getAttribute("dataFromA");
        // ä½¿ç”¨æ•°æ®
        return true;
    }
}
```

**â‘¢ ç»Ÿä¸€å¼‚å¸¸å¤„ç†**

```java
@Override
public void afterCompletion(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler, 
                           Exception ex) {
    if (ex != null) {
        // è®°å½•å¼‚å¸¸æ—¥å¿—
        logger.error("è¯·æ±‚å¼‚å¸¸", ex);
        
        // å¯ä»¥åœ¨è¿™é‡Œç»Ÿä¸€å¤„ç†å¼‚å¸¸å“åº”
        if (!response.isCommitted()) {
            response.setStatus(500);
            response.getWriter().write("{\"error\":\"ç³»ç»Ÿå¼‚å¸¸\"}");
        }
    }
}
```

---

## 7. ğŸš€ å®æˆ˜åº”ç”¨åœºæ™¯


### 7.1 åœºæ™¯1ï¼šç™»å½•çŠ¶æ€æ£€æŸ¥


```java
@Component
public class LoginCheckInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) throws Exception {
        // ä»sessionè·å–ç”¨æˆ·ä¿¡æ¯
        HttpSession session = request.getSession();
        Object user = session.getAttribute("currentUser");
        
        if (user == null) {
            // æœªç™»å½•ï¼Œè¿”å›401
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            response.setContentType("application/json;charset=UTF-8");
            response.getWriter().write("{\"code\":401,\"msg\":\"è¯·å…ˆç™»å½•\"}");
            return false;
        }
        
        return true;
    }
}
```

### 7.2 åœºæ™¯2ï¼šæ¥å£é˜²é‡æ”¾æ”»å‡»


```java
@Component
public class AntiReplayInterceptor implements HandlerInterceptor {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) {
        // è·å–è¯·æ±‚å”¯ä¸€æ ‡è¯†ï¼ˆæ—¶é—´æˆ³+éšæœºæ•°ï¼‰
        String nonce = request.getHeader("X-Nonce");
        String timestamp = request.getHeader("X-Timestamp");
        
        if (nonce == null || timestamp == null) {
            response.setStatus(400);
            return false;
        }
        
        // æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦è¿‡æœŸï¼ˆ5åˆ†é’Ÿå†…æœ‰æ•ˆï¼‰
        long currentTime = System.currentTimeMillis();
        long requestTime = Long.parseLong(timestamp);
        if (currentTime - requestTime > 5 * 60 * 1000) {
            return false; // è¯·æ±‚è¿‡æœŸ
        }
        
        // æ£€æŸ¥nonceæ˜¯å¦å·²ä½¿ç”¨
        String key = "nonce:" + nonce;
        if (redisTemplate.hasKey(key)) {
            return false; // é‡æ”¾æ”»å‡»
        }
        
        // è®°å½•nonceï¼Œ5åˆ†é’Ÿè¿‡æœŸ
        redisTemplate.opsForValue().set(key, "1", 5, TimeUnit.MINUTES);
        
        return true;
    }
}
```

### 7.3 åœºæ™¯3ï¼šæ¥å£è€—æ—¶ç›‘æ§


```java
@Component
public class PerformanceInterceptor implements HandlerInterceptor {
    
    private static final String START_TIME = "requestStartTime";
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) {
        request.setAttribute(START_TIME, System.currentTimeMillis());
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                               HttpServletResponse response, 
                               Object handler, 
                               Exception ex) {
        Long startTime = (Long) request.getAttribute(START_TIME);
        long duration = System.currentTimeMillis() - startTime;
        
        // è·å–è¯·æ±‚ä¿¡æ¯
        String uri = request.getRequestURI();
        String method = request.getMethod();
        
        // è®°å½•æ…¢æ¥å£ï¼ˆè¶…è¿‡1ç§’ï¼‰
        if (duration > 1000) {
            System.err.println(String.format(
                "âš ï¸ æ…¢æ¥å£è­¦å‘Š: %s %s è€—æ—¶ %dms", 
                method, uri, duration
            ));
        } else {
            System.out.println(String.format(
                "âœ… %s %s è€—æ—¶ %dms", 
                method, uri, duration
            ));
        }
    }
}
```

### 7.4 åœºæ™¯4ï¼šAPIç‰ˆæœ¬æ§åˆ¶


```java
@Component
public class ApiVersionInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) throws Exception {
        // ä»è¯·æ±‚å¤´è·å–APIç‰ˆæœ¬
        String version = request.getHeader("API-Version");
        
        if (handler instanceof HandlerMethod) {
            HandlerMethod method = (HandlerMethod) handler;
            
            // æ£€æŸ¥æ–¹æ³•ä¸Šçš„@ApiVersionæ³¨è§£
            ApiVersion apiVersion = method.getMethodAnnotation(ApiVersion.class);
            if (apiVersion != null) {
                String requiredVersion = apiVersion.value();
                
                // ç‰ˆæœ¬ä¸åŒ¹é…
                if (!requiredVersion.equals(version)) {
                    response.setStatus(400);
                    response.getWriter().write(
                        "{\"error\":\"APIç‰ˆæœ¬ä¸åŒ¹é…ï¼Œéœ€è¦: " + requiredVersion + "\"}"
                    );
                    return false;
                }
            }
        }
        
        return true;
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ‹¦æˆªå™¨æœ¬è´¨ï¼šåœ¨è¯·æ±‚å¤„ç†å‰ã€ä¸­ã€åæ’å…¥è‡ªå®šä¹‰é€»è¾‘çš„æœºåˆ¶
ğŸ”¸ ä¸‰å¤§æ–¹æ³•ï¼špreHandle(å‰)ã€postHandle(ä¸­)ã€afterCompletion(å)
ğŸ”¸ æ‰§è¡Œé¡ºåºï¼špreHandleæ­£åºã€postHandleé€†åºã€afterCompletioné€†åº
ğŸ”¸ é…ç½®æ–¹å¼ï¼šå®ç°WebMvcConfigureræ¥å£ï¼Œé‡å†™addInterceptorsæ–¹æ³•
ğŸ”¸ è·¯å¾„åŒ¹é…ï¼šæ”¯æŒ?ã€*ã€**é€šé…ç¬¦ï¼Œå¯ç²¾ç¡®æ§åˆ¶æ‹¦æˆªèŒƒå›´
ğŸ”¸ æ‹¦æˆªå™¨é“¾ï¼šå¤šä¸ªæ‹¦æˆªå™¨æŒ‰æ³¨å†Œé¡ºåºå½¢æˆæ‰§è¡Œé“¾
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ‹¦æˆªå™¨ vs è¿‡æ»¤å™¨**
```
æ‹¦æˆªå™¨ï¼šSpring MVCå±‚ï¼Œèƒ½è®¿é—®Springå®¹å™¨ï¼Œé€‚åˆä¸šåŠ¡æ‹¦æˆª
è¿‡æ»¤å™¨ï¼šServletå®¹å™¨å±‚ï¼Œæ›´åº•å±‚ï¼Œé€‚åˆç¼–ç ã€è·¨åŸŸç­‰é€šç”¨å¤„ç†

é€‰æ‹©åŸåˆ™ï¼š
- éœ€è¦è®¿é—®Spring Bean â†’ ç”¨æ‹¦æˆªå™¨
- éœ€è¦æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼ˆå«é™æ€èµ„æºï¼‰â†’ ç”¨è¿‡æ»¤å™¨
- ä¸šåŠ¡ç›¸å…³é€»è¾‘ â†’ ç”¨æ‹¦æˆªå™¨
```

**ğŸ”¹ preHandleçš„è¿”å›å€¼**
```
è¿”å›trueï¼šæ”¾è¡Œï¼Œç»§ç»­æ‰§è¡Œåç»­æ‹¦æˆªå™¨å’ŒController
è¿”å›falseï¼šæ‹¦æˆªï¼Œä¸å†æ‰§è¡Œåç»­æµç¨‹
           ä½†ä¼šè§¦å‘å·²æ‰§è¡Œæ‹¦æˆªå™¨çš„afterCompletion

å®é™…åº”ç”¨ï¼š
- æƒé™éªŒè¯ä¸é€šè¿‡ â†’ è¿”å›false
- ç™»å½•çŠ¶æ€æ£€æŸ¥å¤±è´¥ â†’ è¿”å›false
- æ­£å¸¸æƒ…å†µ â†’ è¿”å›true
```

**ğŸ”¹ ç”Ÿå‘½å‘¨æœŸä¸­æ–­æƒ…å†µ**
```
æƒ…å†µ1ï¼šæŸä¸ªpreHandleè¿”å›false
â†’ åœæ­¢æ‰§è¡Œåç»­æ‹¦æˆªå™¨å’ŒController
â†’ åªæ‰§è¡Œå·²é€šè¿‡æ‹¦æˆªå™¨çš„afterCompletion

æƒ…å†µ2ï¼šControlleræŠ›å¼‚å¸¸
â†’ è·³è¿‡æ‰€æœ‰postHandle
â†’ ä»ç„¶æ‰§è¡Œæ‰€æœ‰afterCompletionï¼ˆä¼ å…¥å¼‚å¸¸å¯¹è±¡ï¼‰

æƒ…å†µ3ï¼špostHandleæŠ›å¼‚å¸¸
â†’ ä¸å½±å“afterCompletionæ‰§è¡Œ
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š
- âœ… **æƒé™æ§åˆ¶**ï¼šç™»å½•æ£€æŸ¥ã€è§’è‰²éªŒè¯ã€APIæƒé™
- âœ… **æ—¥å¿—è®°å½•**ï¼šè¯·æ±‚æ—¥å¿—ã€è€—æ—¶ç›‘æ§ã€å¼‚å¸¸è®°å½•
- âœ… **å®‰å…¨é˜²æŠ¤**ï¼šé˜²é‡æ”¾ã€é˜²åˆ·ã€IPé»‘åå•
- âœ… **æ•°æ®å¤„ç†**ï¼šç»Ÿä¸€å‚æ•°æ ¡éªŒã€å“åº”åŠ å·¥
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜æ§åˆ¶ã€å‹ç¼©å¤„ç†

**æœ€ä½³å®è·µå»ºè®®**ï¼š
```
â‘  æ‹¦æˆªå™¨èŒè´£å•ä¸€ï¼Œä¸€ä¸ªæ‹¦æˆªå™¨åªåšä¸€ä»¶äº‹
â‘¡ åˆç†è®¾ç½®æ‰§è¡Œé¡ºåºï¼ŒåŸºç¡€æ‹¦æˆªå™¨ä¼˜å…ˆæ‰§è¡Œ
â‘¢ preHandleä¸­é¿å…è€—æ—¶æ“ä½œï¼Œå½±å“æ€§èƒ½
â‘£ afterCompletionæ€»æ˜¯ä¼šæ‰§è¡Œï¼Œé€‚åˆåšèµ„æºæ¸…ç†
â‘¤ é€šè¿‡RequeståŸŸåœ¨æ‹¦æˆªå™¨é—´ä¼ é€’æ•°æ®
â‘¥ æ‹¦æˆªå™¨å¼‚å¸¸è¦å¦¥å–„å¤„ç†ï¼Œé¿å…å½±å“ä¸»æµç¨‹
```

### 8.4 å¸¸è§é—®é¢˜ä¸è§£å†³


**â“ æ‹¦æˆªå™¨ä¸ç”Ÿæ•ˆï¼Ÿ**
```
æ£€æŸ¥æ¸…å•ï¼š
âœ“ æ‹¦æˆªå™¨æ˜¯å¦è¢«Springå®¹å™¨ç®¡ç†ï¼ˆ@Componentï¼‰
âœ“ WebMvcConfigureré…ç½®ç±»æ˜¯å¦æ·»åŠ @Configuration
âœ“ addPathPatternsè·¯å¾„æ˜¯å¦æ­£ç¡®
âœ“ æ˜¯å¦è¢«excludePathPatternsæ’é™¤
âœ“ orderé¡ºåºæ˜¯å¦åˆç†
```

**â“ å¦‚ä½•åœ¨æ‹¦æˆªå™¨ä¸­ä½¿ç”¨Serviceï¼Ÿ**
```java
@Component
public class MyInterceptor implements HandlerInterceptor {
    
    @Autowired  // âœ… å¯ä»¥æ³¨å…¥Spring Bean
    private UserService userService;
    
    @Override
    public boolean preHandle(...) {
        User user = userService.getCurrentUser();
        // ä½¿ç”¨Service
        return true;
    }
}
```

**â“ é™æ€èµ„æºè¢«æ‹¦æˆªäº†æ€ä¹ˆåŠï¼Ÿ**
```java
@Override
public void addInterceptors(InterceptorRegistry registry) {
    registry.addInterceptor(myInterceptor)
            .addPathPatterns("/**")
            .excludePathPatterns(
                "/static/**",      // æ’é™¤é™æ€èµ„æº
                "/**.html",        // æ’é™¤HTML
                "/**.css",         // æ’é™¤CSS
                "/**.js",          // æ’é™¤JS
                "/favicon.ico"     // æ’é™¤å›¾æ ‡
            );
}
```

---

**æ ¸å¿ƒè®°å¿†**ï¼š
- æ‹¦æˆªå™¨åƒé—¨å«ï¼Œè¯·æ±‚å¿…é¡»å…ˆè¿‡å…³
- ä¸‰ä¸ªæ–¹æ³•ä¸‰ä¸ªæ—¶æœºï¼Œå‰ä¸­åå…¨è¦†ç›–
- preHandleè¿”å›falseç›´æ¥æ‹¦ï¼ŒafterCompletionæ€»æ‰§è¡Œ
- é…ç½®ç®€å•åŠŸèƒ½å¼ºï¼ŒSpring MVCå¿…å¤‡æŠ€èƒ½