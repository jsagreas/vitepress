---
title: 3ã€æ‹¦æˆªå™¨åº”ç”¨åœºæ™¯å®è·µ
---
## ğŸ“š ç›®å½•

1. [æ‹¦æˆªå™¨åº”ç”¨åœºæ™¯æ¦‚è¿°](#1-æ‹¦æˆªå™¨åº”ç”¨åœºæ™¯æ¦‚è¿°)
2. [ç™»å½•è®¤è¯æ‹¦æˆª](#2-ç™»å½•è®¤è¯æ‹¦æˆª)
3. [æƒé™æ§åˆ¶æ‹¦æˆª](#3-æƒé™æ§åˆ¶æ‹¦æˆª)
4. [æ—¥å¿—è®°å½•æ‹¦æˆª](#4-æ—¥å¿—è®°å½•æ‹¦æˆª)
5. [æ€§èƒ½ç›‘æ§æ‹¦æˆª](#5-æ€§èƒ½ç›‘æ§æ‹¦æˆª)
6. [ç¼–ç å¤„ç†æ‹¦æˆª](#6-ç¼–ç å¤„ç†æ‹¦æˆª)
7. [è·¨åŸŸå¤„ç†æ‹¦æˆª](#7-è·¨åŸŸå¤„ç†æ‹¦æˆª)
8. [ç¼“å­˜æ§åˆ¶æ‹¦æˆª](#8-ç¼“å­˜æ§åˆ¶æ‹¦æˆª)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ‹¦æˆªå™¨åº”ç”¨åœºæ™¯æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨åº”ç”¨åœºæ™¯


**é€šä¿—ç†è§£**ï¼šæ‹¦æˆªå™¨å°±åƒå•†åœºçš„å®‰æ£€é—¨ï¼Œåœ¨ä½ è¿›å…¥å•†åœºå‰æ£€æŸ¥ä½ çš„åŒ…è£¹ï¼Œåœ¨ä½ ç¦»å¼€æ—¶ç»™ä½ ç›–ç« ç¡®è®¤ã€‚

```
ç”¨æˆ·è¯·æ±‚æµç¨‹ï¼š
æµè§ˆå™¨ â†’ [æ‹¦æˆªå™¨æ£€æŸ¥] â†’ Controllerå¤„ç† â†’ [æ‹¦æˆªå™¨æ”¶å°¾] â†’ è¿”å›å“åº”

å°±åƒï¼š
ä½  â†’ [ä¿å®‰æ£€æŸ¥] â†’ è¿›å…¥å•†åœºè´­ç‰© â†’ [æ”¶é“¶å‘˜ç»“è´¦] â†’ ç¦»å¼€å•†åœº
```

### 1.2 æ‹¦æˆªå™¨çš„ä¸‰ä¸ªå…³é”®æ—¶æœº


**æ‹¦æˆªå™¨çš„å·¥ä½œæ—¶é—´ç‚¹**ï¼š

| æ—¶æœº | æ–¹æ³•å | **åšä»€ä¹ˆ** | **ç”Ÿæ´»ç±»æ¯”** |
|------|--------|-----------|-------------|
| ğŸšª **è¯·æ±‚å‰** | `preHandle()` | è¯·æ±‚åˆ°è¾¾Controllerä¹‹å‰æ‰§è¡Œ | è¿›é—¨å‰çš„å®‰æ£€ |
| ğŸ¬ **è¯·æ±‚å** | `postHandle()` | Controlleræ‰§è¡Œå®Œï¼Œè§†å›¾æ¸²æŸ“å‰ | ä»˜æ¬¾åæ‰“åŒ…å•†å“ |
| ğŸ **å®Œæˆå** | `afterCompletion()` | æ•´ä¸ªè¯·æ±‚ç»“æŸåæ‰§è¡Œ | ç¦»å¼€å•†åœºå‰çš„æ»¡æ„åº¦è°ƒæŸ¥ |

### 1.3 å¸¸è§åº”ç”¨åœºæ™¯æ€»è§ˆ


```
ğŸ” ç™»å½•è®¤è¯æ‹¦æˆª â†’ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
ğŸ›¡ï¸ æƒé™æ§åˆ¶æ‹¦æˆª â†’ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ“ä½œæƒé™
ğŸ“ æ—¥å¿—è®°å½•æ‹¦æˆª â†’ è®°å½•è¯·æ±‚è®¿é—®æ—¥å¿—
â±ï¸ æ€§èƒ½ç›‘æ§æ‹¦æˆª â†’ ç›‘æ§æ¥å£å“åº”æ—¶é—´
ğŸ”¤ ç¼–ç å¤„ç†æ‹¦æˆª â†’ ç»Ÿä¸€å¤„ç†å­—ç¬¦ç¼–ç 
ğŸŒ è·¨åŸŸå¤„ç†æ‹¦æˆª â†’ å¤„ç†è·¨åŸŸè®¿é—®è¯·æ±‚
ğŸ’¾ ç¼“å­˜æ§åˆ¶æ‹¦æˆª â†’ è®¾ç½®é¡µé¢ç¼“å­˜ç­–ç•¥
```

---

## 2. ğŸ” ç™»å½•è®¤è¯æ‹¦æˆª


### 2.1 ç™»å½•è®¤è¯æ‹¦æˆªçš„ä½œç”¨


**æ ¸å¿ƒç›®æ ‡**ï¼šç¡®ä¿åªæœ‰ç™»å½•ç”¨æˆ·æ‰èƒ½è®¿é—®å—ä¿æŠ¤çš„é¡µé¢

**ç”Ÿæ´»åœºæ™¯ç±»æ¯”**ï¼š
```
å°±åƒå°åŒºé—¨ç¦ï¼š
æ²¡æœ‰é—¨ç¦å¡ â†’ ä¸èƒ½è¿›å…¥å°åŒºï¼ˆè·³è½¬ç™»å½•é¡µï¼‰
æœ‰é—¨ç¦å¡ â†’ æ­£å¸¸è¿›å…¥ï¼ˆç»§ç»­è®¿é—®ï¼‰
```

### 2.2 ç™»å½•è®¤è¯æ‹¦æˆªå™¨å®ç°


```java
public class LoginInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // 1. ä»Sessionä¸­è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯
        HttpSession session = request.getSession();
        Object user = session.getAttribute("loginUser");
        
        // 2. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        if (user == null) {
            // æœªç™»å½•ï¼šè·³è½¬åˆ°ç™»å½•é¡µ
            response.sendRedirect("/login");
            return false;  // æ‹¦æˆªè¯·æ±‚ï¼Œä¸ç»§ç»­æ‰§è¡Œ
        }
        
        // å·²ç™»å½•ï¼šæ”¾è¡Œè¯·æ±‚
        return true;
    }
}
```

**ä»£ç è§£è¯»**ï¼š
- `session.getAttribute("loginUser")`ï¼šä»Sessionå–ç™»å½•ä¿¡æ¯
- `return false`ï¼šæ‹¦æˆªè¯·æ±‚ï¼Œä¸è®©ç»§ç»­æ‰§è¡Œ
- `return true`ï¼šæ”¾è¡Œè¯·æ±‚ï¼Œç»§ç»­è®¿é—®Controller

### 2.3 é…ç½®ç™»å½•æ‹¦æˆªå™¨


```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new LoginInterceptor())
                .addPathPatterns("/**")              // æ‹¦æˆªæ‰€æœ‰è¯·æ±‚
                .excludePathPatterns(
                    "/login",      // ç™»å½•é¡µé¢ä¸æ‹¦æˆª
                    "/register",   // æ³¨å†Œé¡µé¢ä¸æ‹¦æˆª
                    "/css/**",     // é™æ€èµ„æºä¸æ‹¦æˆª
                    "/js/**",
                    "/images/**"
                );
    }
}
```

**é…ç½®è¯´æ˜**ï¼š
- `addPathPatterns("/**")`ï¼šæ‹¦æˆªæ‰€æœ‰è·¯å¾„
- `excludePathPatterns()`ï¼šæ’é™¤ä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„

### 2.4 ç™»å½•è®¤è¯æµç¨‹å›¾


```
ç”¨æˆ·è®¿é—® /user/profile
         â†“
   [ç™»å½•æ‹¦æˆªå™¨æ£€æŸ¥]
         â†“
  æ£€æŸ¥Sessionä¸­æ˜¯å¦æœ‰loginUser
    â†™           â†˜
 æ²¡æœ‰           æœ‰
  â†“             â†“
è·³è½¬ç™»å½•é¡µ    æ”¾è¡Œç»§ç»­è®¿é—®
/login       /user/profile
```

> ğŸ’¡ **å®ç”¨æŠ€å·§**  
> å¯ä»¥åœ¨æ‹¦æˆªå™¨ä¸­è®°å½•è¢«æ‹¦æˆªçš„åŸå§‹è¯·æ±‚URLï¼Œç™»å½•æˆåŠŸåè‡ªåŠ¨è·³è½¬å›å»ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

---

## 3. ğŸ›¡ï¸ æƒé™æ§åˆ¶æ‹¦æˆª


### 3.1 æƒé™æ§åˆ¶æ‹¦æˆªçš„ä½œç”¨


**æ ¸å¿ƒç›®æ ‡**ï¼šä¸åŒè§’è‰²çš„ç”¨æˆ·åªèƒ½è®¿é—®å¯¹åº”æƒé™çš„åŠŸèƒ½

**ç”Ÿæ´»åœºæ™¯ç±»æ¯”**ï¼š
```
å…¬å¸æƒé™ç®¡ç†ï¼š
æ™®é€šå‘˜å·¥ â†’ åªèƒ½è®¿é—®è‡ªå·±çš„å·¥ä½ï¼ˆæŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯ï¼‰
éƒ¨é—¨ç»ç† â†’ å¯ä»¥è®¿é—®éƒ¨é—¨åŠå…¬å®¤ï¼ˆç®¡ç†éƒ¨é—¨å‘˜å·¥ï¼‰
æ€»ç»ç†   â†’ å¯ä»¥è®¿é—®æ‰€æœ‰åŒºåŸŸï¼ˆç®¡ç†å…¨éƒ¨åŠŸèƒ½ï¼‰
```

### 3.2 æƒé™æ§åˆ¶æ‹¦æˆªå™¨å®ç°


**å®ç°æ€è·¯**ï¼šé€šè¿‡æ³¨è§£æ ‡è®°éœ€è¦çš„æƒé™ï¼Œæ‹¦æˆªå™¨æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¯¥æƒé™

```java
// 1. å®šä¹‰æƒé™æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RequirePermission {
    String value();  // éœ€è¦çš„æƒé™åç§°
}

// 2. åœ¨Controlleræ–¹æ³•ä¸Šä½¿ç”¨æ³¨è§£
@Controller
public class UserController {
    
    @RequirePermission("user:delete")  // éœ€è¦åˆ é™¤ç”¨æˆ·æƒé™
    @PostMapping("/user/delete")
    public String deleteUser(Long id) {
        // åˆ é™¤ç”¨æˆ·é€»è¾‘
        return "success";
    }
}
```

```java
// 3. æƒé™æ‹¦æˆªå™¨å®ç°
public class PermissionInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // åªå¤„ç†æ–¹æ³•çº§åˆ«çš„æ‹¦æˆª
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }
        
        HandlerMethod method = (HandlerMethod) handler;
        
        // è·å–æ–¹æ³•ä¸Šçš„æƒé™æ³¨è§£
        RequirePermission annotation = 
            method.getMethodAnnotation(RequirePermission.class);
        
        // æ²¡æœ‰æ³¨è§£ï¼Œä¸éœ€è¦æƒé™æ£€æŸ¥
        if (annotation == null) {
            return true;
        }
        
        // è·å–éœ€è¦çš„æƒé™
        String requiredPermission = annotation.value();
        
        // è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„æƒé™åˆ—è¡¨
        HttpSession session = request.getSession();
        User loginUser = (User) session.getAttribute("loginUser");
        List<String> userPermissions = loginUser.getPermissions();
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¯¥æƒé™
        if (!userPermissions.contains(requiredPermission)) {
            // æ²¡æœ‰æƒé™ï¼šè·³è½¬åˆ°æ— æƒé™æç¤ºé¡µ
            response.sendRedirect("/error/403");
            return false;
        }
        
        return true;
    }
}
```

### 3.3 æƒé™æ£€æŸ¥æµç¨‹å›¾


```
ç”¨æˆ·è®¿é—® /user/delete
         â†“
   [æƒé™æ‹¦æˆªå™¨]
         â†“
 æ£€æŸ¥æ–¹æ³•æ˜¯å¦æœ‰@RequirePermissionæ³¨è§£
    â†™           â†˜
  æ²¡æœ‰           æœ‰
   â†“             â†“
  æ”¾è¡Œ      è·å–éœ€è¦çš„æƒé™å€¼
            (user:delete)
                â†“
         æ£€æŸ¥ç”¨æˆ·æƒé™åˆ—è¡¨
            â†™       â†˜
        æ²¡æœ‰è¯¥æƒé™   æœ‰è¯¥æƒé™
           â†“          â†“
       è·³è½¬403é¡µé¢   ç»§ç»­æ‰§è¡Œ
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**  
> æƒé™æ‹¦æˆªå™¨è¦åœ¨ç™»å½•æ‹¦æˆªå™¨ä¹‹åæ‰§è¡Œï¼Œå› ä¸ºéœ€è¦å…ˆç¡®ä¿ç”¨æˆ·å·²ç™»å½•æ‰èƒ½æ£€æŸ¥æƒé™

---

## 4. ğŸ“ æ—¥å¿—è®°å½•æ‹¦æˆª


### 4.1 æ—¥å¿—è®°å½•æ‹¦æˆªçš„ä½œç”¨


**æ ¸å¿ƒç›®æ ‡**ï¼šè®°å½•ç³»ç»Ÿè®¿é—®æ—¥å¿—ï¼Œæ–¹ä¾¿é—®é¢˜æ’æŸ¥å’Œæ•°æ®åˆ†æ

**è®°å½•å†…å®¹**ï¼š
- è°è®¿é—®äº†ç³»ç»Ÿï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰
- è®¿é—®äº†ä»€ä¹ˆï¼ˆè¯·æ±‚URLï¼‰
- ä»€ä¹ˆæ—¶å€™è®¿é—®ï¼ˆè®¿é—®æ—¶é—´ï¼‰
- è®¿é—®ç»“æœå¦‚ä½•ï¼ˆå“åº”çŠ¶æ€ï¼‰

### 4.2 æ—¥å¿—è®°å½•æ‹¦æˆªå™¨å®ç°


```java
@Slf4j  // ä½¿ç”¨Lombokçš„æ—¥å¿—æ³¨è§£
public class LogInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        
        // è®°å½•è¯·æ±‚ä¿¡æ¯
        String method = request.getMethod();           // GET/POSTç­‰
        String uri = request.getRequestURI();          // è¯·æ±‚è·¯å¾„
        String ip = request.getRemoteAddr();           // å®¢æˆ·ç«¯IP
        
        // è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯
        HttpSession session = request.getSession();
        User user = (User) session.getAttribute("loginUser");
        String username = user != null ? user.getName() : "æœªç™»å½•";
        
        // æ‰“å°è®¿é—®æ—¥å¿—
        log.info("ç”¨æˆ·[{}] IP[{}] è®¿é—® {} {}", 
                 username, ip, method, uri);
        
        // å°†è¯·æ±‚å¼€å§‹æ—¶é—´å­˜å…¥requestï¼Œç”¨äºè®¡ç®—è€—æ—¶
        request.setAttribute("startTime", System.currentTimeMillis());
        
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                               HttpServletResponse response, 
                               Object handler, 
                               Exception ex) {
        
        // è®¡ç®—è¯·æ±‚è€—æ—¶
        Long startTime = (Long) request.getAttribute("startTime");
        long duration = System.currentTimeMillis() - startTime;
        
        // è®°å½•å“åº”ä¿¡æ¯
        int status = response.getStatus();  // å“åº”çŠ¶æ€ç 
        
        log.info("è¯·æ±‚å®Œæˆ çŠ¶æ€ç [{}] è€—æ—¶[{}ms]", status, duration);
        
        // å¦‚æœæœ‰å¼‚å¸¸ï¼Œè®°å½•å¼‚å¸¸ä¿¡æ¯
        if (ex != null) {
            log.error("è¯·æ±‚å¼‚å¸¸: ", ex);
        }
    }
}
```

### 4.3 æ—¥å¿—è®°å½•ç¤ºä¾‹


**è®¿é—®æ—¥å¿—è¾“å‡ºç¤ºä¾‹**ï¼š
```
2024-09-24 14:30:15 [INFO] ç”¨æˆ·[å¼ ä¸‰] IP[192.168.1.100] è®¿é—® GET /user/list
2024-09-24 14:30:16 [INFO] è¯·æ±‚å®Œæˆ çŠ¶æ€ç [200] è€—æ—¶[523ms]

2024-09-24 14:32:08 [INFO] ç”¨æˆ·[æå››] IP[192.168.1.101] è®¿é—® POST /user/save
2024-09-24 14:32:09 [ERROR] è¯·æ±‚å¼‚å¸¸: java.lang.NullPointerException...
```

> ğŸ’¡ **å®ç”¨å»ºè®®**  
> å¯ä»¥å°†æ—¥å¿—ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ï¼Œæ–¹ä¾¿åç»­çš„æ•°æ®ç»Ÿè®¡å’Œåˆ†æï¼Œæ¯”å¦‚ç»Ÿè®¡æ¥å£è®¿é—®é‡ã€ç”¨æˆ·æ´»è·ƒåº¦ç­‰

---

## 5. â±ï¸ æ€§èƒ½ç›‘æ§æ‹¦æˆª


### 5.1 æ€§èƒ½ç›‘æ§æ‹¦æˆªçš„ä½œç”¨


**æ ¸å¿ƒç›®æ ‡**ï¼šç›‘æ§ç³»ç»Ÿæ¥å£çš„æ€§èƒ½ï¼ŒåŠæ—¶å‘ç°æ…¢æ¥å£

**ç›‘æ§æŒ‡æ ‡**ï¼š
- æ¥å£å“åº”æ—¶é—´
- æ¥å£è°ƒç”¨æ¬¡æ•°
- æ…¢æ¥å£é¢„è­¦ï¼ˆè¶…è¿‡é˜ˆå€¼ï¼‰

### 5.2 æ€§èƒ½ç›‘æ§æ‹¦æˆªå™¨å®ç°


```java
@Slf4j
public class PerformanceInterceptor implements HandlerInterceptor {
    
    // æ…¢æ¥å£é˜ˆå€¼ï¼š2ç§’
    private static final long SLOW_REQUEST_THRESHOLD = 2000;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        
        // è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
        long startTime = System.currentTimeMillis();
        request.setAttribute("startTime", startTime);
        
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                               HttpServletResponse response, 
                               Object handler, 
                               Exception ex) {
        
        // è®¡ç®—æ¥å£è€—æ—¶
        Long startTime = (Long) request.getAttribute("startTime");
        long duration = System.currentTimeMillis() - startTime;
        
        String uri = request.getRequestURI();
        
        // å¦‚æœè¶…è¿‡é˜ˆå€¼ï¼Œè®°å½•è­¦å‘Šæ—¥å¿—
        if (duration > SLOW_REQUEST_THRESHOLD) {
            log.warn("âš ï¸ æ…¢æ¥å£è­¦å‘Š: {} è€—æ—¶ {}ms", uri, duration);
            
            // å¯ä»¥å‘é€å‘Šè­¦é€šçŸ¥ï¼ˆé‚®ä»¶ã€çŸ­ä¿¡ã€é’‰é’‰ç­‰ï¼‰
            sendAlert(uri, duration);
        } else {
            log.info("æ¥å£æ€§èƒ½: {} è€—æ—¶ {}ms", uri, duration);
        }
        
        // å°†æ€§èƒ½æ•°æ®ä¿å­˜åˆ°ç›‘æ§ç³»ç»Ÿ
        savePerformanceData(uri, duration);
    }
    
    private void sendAlert(String uri, long duration) {
        // å‘é€å‘Šè­¦é€šçŸ¥çš„é€»è¾‘
        // ä¾‹å¦‚ï¼šå‘é€é’‰é’‰æ¶ˆæ¯ã€é‚®ä»¶ç­‰
    }
    
    private void savePerformanceData(String uri, long duration) {
        // ä¿å­˜æ€§èƒ½æ•°æ®åˆ°æ•°æ®åº“æˆ–ç›‘æ§ç³»ç»Ÿ
        // ç”¨äºåç»­çš„æ€§èƒ½åˆ†æå’ŒæŠ¥è¡¨ç”Ÿæˆ
    }
}
```

### 5.3 æ€§èƒ½ç›‘æ§æ•°æ®åº”ç”¨


**æ…¢æ¥å£ç»Ÿè®¡è¡¨**ï¼š

| æ¥å£è·¯å¾„ | **å¹³å‡è€—æ—¶** | **æœ€å¤§è€—æ—¶** | **è°ƒç”¨æ¬¡æ•°** | **æ…¢è¯·æ±‚å æ¯”** |
|---------|------------|------------|------------|--------------|
| `/user/list` | 1.2s | 3.5s | 1000 | 15% |
| `/order/export` | 2.8s | 5.2s | 500 | 45% |
| `/report/generate` | 4.1s | 8.7s | 200 | 78% |

**æ€§èƒ½ä¼˜åŒ–æ–¹å‘**ï¼š
```
å‘ç°æ…¢æ¥å£ â†’ åˆ†æåŸå› ï¼ˆæ•°æ®åº“æŸ¥è¯¢ï¼Ÿå¤–éƒ¨è°ƒç”¨ï¼Ÿï¼‰
          â†’ é’ˆå¯¹æ€§ä¼˜åŒ–ï¼ˆåŠ ç´¢å¼•ï¼ŸåŠ ç¼“å­˜ï¼Ÿå¼‚æ­¥å¤„ç†ï¼Ÿï¼‰
          â†’ æŒç»­ç›‘æ§æ•ˆæœ
```

---

## 6. ğŸ”¤ ç¼–ç å¤„ç†æ‹¦æˆª


### 6.1 ç¼–ç å¤„ç†æ‹¦æˆªçš„ä½œç”¨


**æ ¸å¿ƒç›®æ ‡**ï¼šç»Ÿä¸€å¤„ç†è¯·æ±‚å’Œå“åº”çš„å­—ç¬¦ç¼–ç ï¼Œé¿å…ä¹±ç é—®é¢˜

**å¸¸è§ä¹±ç åœºæ™¯**ï¼š
```
åœºæ™¯1ï¼šè¡¨å•æäº¤ä¸­æ–‡å‚æ•°
æµè§ˆå™¨ â†’ [ISO-8859-1ç¼–ç ] â†’ æœåŠ¡å™¨
ç»“æœï¼šä¸­æ–‡æ˜¾ç¤ºä¸ºä¹±ç  "Ã¥Â¼ Ã¤Â¸â€°"

åœºæ™¯2ï¼šå“åº”ä¸­æ–‡å†…å®¹
æœåŠ¡å™¨ â†’ [æœªæŒ‡å®šç¼–ç ] â†’ æµè§ˆå™¨
ç»“æœï¼šé¡µé¢æ˜¾ç¤ºä¹±ç 
```

### 6.2 ç¼–ç å¤„ç†æ‹¦æˆªå™¨å®ç°


```java
public class EncodingInterceptor implements HandlerInterceptor {
    
    private static final String DEFAULT_ENCODING = "UTF-8";
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // è®¾ç½®è¯·æ±‚ç¼–ç ï¼ˆå¤„ç†POSTè¡¨å•æäº¤çš„ä¸­æ–‡å‚æ•°ï¼‰
        request.setCharacterEncoding(DEFAULT_ENCODING);
        
        // è®¾ç½®å“åº”ç¼–ç ï¼ˆå“åº”ä¸­æ–‡å†…å®¹ä¸ä¹±ç ï¼‰
        response.setCharacterEncoding(DEFAULT_ENCODING);
        response.setContentType("text/html;charset=" + DEFAULT_ENCODING);
        
        return true;
    }
}
```

**æ›´ç®€å•çš„æ–¹å¼**ï¼šSpringæä¾›çš„ç¼–ç è¿‡æ»¤å™¨
```java
@Configuration
public class WebConfig {
    
    @Bean
    public FilterRegistrationBean<CharacterEncodingFilter> encodingFilter() {
        CharacterEncodingFilter filter = new CharacterEncodingFilter();
        filter.setEncoding("UTF-8");
        filter.setForceEncoding(true);  // å¼ºåˆ¶ä½¿ç”¨UTF-8
        
        FilterRegistrationBean<CharacterEncodingFilter> bean = 
            new FilterRegistrationBean<>(filter);
        bean.addUrlPatterns("/*");  // æ‹¦æˆªæ‰€æœ‰è¯·æ±‚
        
        return bean;
    }
}
```

> ğŸ’¡ **æœ€ä½³å®è·µ**  
> ä¼˜å…ˆä½¿ç”¨Springæä¾›çš„`CharacterEncodingFilter`ï¼Œå®ƒæ˜¯ä¸“é—¨ç”¨äºå¤„ç†ç¼–ç é—®é¢˜çš„ï¼ŒåŠŸèƒ½æ›´å®Œå–„

---

## 7. ğŸŒ è·¨åŸŸå¤„ç†æ‹¦æˆª


### 7.1 ä»€ä¹ˆæ˜¯è·¨åŸŸé—®é¢˜


**è·¨åŸŸ**ï¼šæµè§ˆå™¨çš„å®‰å…¨ç­–ç•¥ï¼Œé™åˆ¶ä¸åŒåŸŸåä¹‹é—´çš„è¯·æ±‚

**ç”Ÿæ´»åœºæ™¯ç±»æ¯”**ï¼š
```
å°±åƒä¸åŒå›½å®¶ä¹‹é—´çš„é€šè¡Œï¼š
ä¸­å›½å…¬æ°‘ â†’ è®¿é—®ç¾å›½ç½‘ç«™ï¼ˆä¸åŒåŸŸï¼‰â†’ éœ€è¦ç­¾è¯ï¼ˆè·¨åŸŸè®¸å¯ï¼‰
æ²¡æœ‰ç­¾è¯ â†’ è¢«æ‹¦æˆªï¼ˆè·¨åŸŸå¤±è´¥ï¼‰
æœ‰ç­¾è¯ â†’ æ­£å¸¸è®¿é—®ï¼ˆè·¨åŸŸæˆåŠŸï¼‰
```

### 7.2 è·¨åŸŸåœºæ™¯ç¤ºä¾‹


```
å‰ç«¯é¡µé¢ï¼šhttp://localhost:8080
åç«¯æ¥å£ï¼šhttp://localhost:9090/api/user

å‰ç«¯å‘èµ·è¯·æ±‚ï¼š
fetch('http://localhost:9090/api/user')

æµè§ˆå™¨æ£€æŸ¥ï¼š
å‰ç«¯ç«¯å£8080 â‰  åç«¯ç«¯å£9090
åˆ¤å®šä¸ºè·¨åŸŸ â†’ æ‹¦æˆªè¯·æ±‚ â†’ æ§åˆ¶å°æŠ¥é”™
```

**æµè§ˆå™¨æŠ¥é”™ä¿¡æ¯**ï¼š
```
Access to fetch at 'http://localhost:9090/api/user' from origin 
'http://localhost:8080' has been blocked by CORS policy
```

### 7.3 è·¨åŸŸå¤„ç†æ‹¦æˆªå™¨å®ç°


```java
public class CorsInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        
        // å…è®¸å“ªäº›åŸŸåè®¿é—®ï¼ˆ* è¡¨ç¤ºå…è®¸æ‰€æœ‰åŸŸåï¼‰
        response.setHeader("Access-Control-Allow-Origin", "*");
        
        // å…è®¸å“ªäº›è¯·æ±‚æ–¹æ³•
        response.setHeader("Access-Control-Allow-Methods", 
                          "GET, POST, PUT, DELETE, OPTIONS");
        
        // å…è®¸å“ªäº›è¯·æ±‚å¤´
        response.setHeader("Access-Control-Allow-Headers", 
                          "Content-Type, Authorization");
        
        // é¢„æ£€è¯·æ±‚çš„ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰
        response.setHeader("Access-Control-Max-Age", "3600");
        
        // å…è®¸æºå¸¦Cookie
        response.setHeader("Access-Control-Allow-Credentials", "true");
        
        // OPTIONSé¢„æ£€è¯·æ±‚ç›´æ¥è¿”å›
        if ("OPTIONS".equals(request.getMethod())) {
            response.setStatus(200);
            return false;  // ä¸å†ç»§ç»­æ‰§è¡Œ
        }
        
        return true;
    }
}
```

### 7.4 è·¨åŸŸè¯·æ±‚æµç¨‹å›¾


```
æµè§ˆå™¨å‘èµ·è·¨åŸŸè¯·æ±‚
         â†“
   [æµè§ˆå™¨è‡ªåŠ¨å‘é€OPTIONSé¢„æ£€è¯·æ±‚]
         â†“
   æœåŠ¡å™¨è¿”å›CORSå“åº”å¤´
   (Access-Control-Allow-*)
         â†“
    æµè§ˆå™¨æ£€æŸ¥å“åº”å¤´
      â†™         â†˜
   é€šè¿‡         ä¸é€šè¿‡
     â†“           â†“
 å‘é€çœŸå®è¯·æ±‚   æ‹¦æˆªè¯·æ±‚
     â†“         (æ˜¾ç¤ºé”™è¯¯)
 æ­£å¸¸è·å–å“åº”
```

**æ›´æ¨èçš„æ–¹å¼**ï¼šä½¿ç”¨Springçš„`@CrossOrigin`æ³¨è§£
```java
@RestController
@CrossOrigin(origins = "http://localhost:8080")  // å…è®¸8080ç«¯å£è®¿é—®
public class UserController {
    
    @GetMapping("/user")
    public List<User> getUsers() {
        // ...
    }
}
```

---

## 8. ğŸ’¾ ç¼“å­˜æ§åˆ¶æ‹¦æˆª


### 8.1 ç¼“å­˜æ§åˆ¶æ‹¦æˆªçš„ä½œç”¨


**æ ¸å¿ƒç›®æ ‡**ï¼šæ§åˆ¶æµè§ˆå™¨å’Œä»£ç†æœåŠ¡å™¨çš„ç¼“å­˜è¡Œä¸º

**ç¼“å­˜ç­–ç•¥ç±»å‹**ï¼š

| ç­–ç•¥ | **é€‚ç”¨åœºæ™¯** | **æ•ˆæœ** |
|------|------------|---------|
| ğŸ“„ **å¼ºåˆ¶ç¼“å­˜** | é™æ€èµ„æºï¼ˆå›¾ç‰‡ã€CSSã€JSï¼‰ | ç›´æ¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œä¸å‘è¯·æ±‚ |
| ğŸ”„ **åå•†ç¼“å­˜** | å˜åŒ–ä¸é¢‘ç¹çš„æ•°æ® | å‘è¯·æ±‚éªŒè¯ï¼Œæœªä¿®æ”¹è¿”å›304 |
| ğŸš« **ç¦ç”¨ç¼“å­˜** | å®æ—¶æ€§è¦æ±‚é«˜çš„æ•°æ® | æ¯æ¬¡éƒ½ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ® |

### 8.2 ç¼“å­˜æ§åˆ¶æ‹¦æˆªå™¨å®ç°


```java
public class CacheControlInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        
        String uri = request.getRequestURI();
        
        // 1. é™æ€èµ„æºï¼šå¼ºåˆ¶ç¼“å­˜1å¤©
        if (uri.endsWith(".css") || uri.endsWith(".js") || 
            uri.endsWith(".jpg") || uri.endsWith(".png")) {
            
            // max-age=86400 è¡¨ç¤ºç¼“å­˜1å¤©ï¼ˆ86400ç§’ï¼‰
            response.setHeader("Cache-Control", "max-age=86400");
            response.setDateHeader("Expires", 
                System.currentTimeMillis() + 86400000);
        }
        
        // 2. APIæ¥å£ï¼šç¦ç”¨ç¼“å­˜
        else if (uri.startsWith("/api/")) {
            response.setHeader("Cache-Control", 
                "no-cache, no-store, must-revalidate");
            response.setHeader("Pragma", "no-cache");  // HTTP 1.0å…¼å®¹
            response.setDateHeader("Expires", 0);
        }
        
        // 3. æ™®é€šé¡µé¢ï¼šåå•†ç¼“å­˜
        else {
            response.setHeader("Cache-Control", "no-cache");
            // è®¾ç½®Last-Modifiedæ—¶é—´ï¼Œç”¨äºåå•†ç¼“å­˜
            response.setDateHeader("Last-Modified", 
                System.currentTimeMillis());
        }
        
        return true;
    }
}
```

### 8.3 ç¼“å­˜æ§åˆ¶å¤´è¯¦è§£


**Cache-Controlå¸¸ç”¨æŒ‡ä»¤**ï¼š

```
no-cacheï¼š
å«ä¹‰ï¼šå¯ä»¥ç¼“å­˜ï¼Œä½†æ¯æ¬¡ä½¿ç”¨å‰å¿…é¡»å‘æœåŠ¡å™¨éªŒè¯
åœºæ™¯ï¼šå†…å®¹å¯èƒ½æ›´æ–°çš„é¡µé¢

no-storeï¼š
å«ä¹‰ï¼šå®Œå…¨ä¸ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½é‡æ–°è·å–
åœºæ™¯ï¼šæ•æ„Ÿä¿¡æ¯ï¼ˆé“¶è¡Œè´¦æˆ·ã€è®¢å•è¯¦æƒ…ï¼‰

max-age=3600ï¼š
å«ä¹‰ï¼šç¼“å­˜3600ç§’ï¼ˆ1å°æ—¶ï¼‰ï¼ŒæœŸé—´ç›´æ¥ä½¿ç”¨
åœºæ™¯ï¼šå˜åŒ–ä¸é¢‘ç¹çš„èµ„æº

publicï¼š
å«ä¹‰ï¼šå¯ä»¥è¢«ä»»ä½•ç¼“å­˜ï¼ˆæµè§ˆå™¨ã€CDNï¼‰ä¿å­˜
åœºæ™¯ï¼šå…¬å…±èµ„æº

privateï¼š
å«ä¹‰ï¼šåªèƒ½è¢«æµè§ˆå™¨ç¼“å­˜ï¼Œä¸èƒ½è¢«CDNç­‰ç¼“å­˜
åœºæ™¯ï¼šç”¨æˆ·ç§æœ‰æ•°æ®
```

### 8.4 ç¼“å­˜ç­–ç•¥é€‰æ‹©


```
èµ„æºç±»å‹å†³ç­–æ ‘ï¼š
             èµ„æºç±»å‹
          â†™         â†˜
      é™æ€èµ„æº      åŠ¨æ€å†…å®¹
         â†“             â†“
    å¼ºåˆ¶ç¼“å­˜        æ˜¯å¦å®æ—¶ï¼Ÿ
    (max-age)      â†™      â†˜
                 æ˜¯         å¦
                 â†“          â†“
            ç¦ç”¨ç¼“å­˜    åå•†ç¼“å­˜
           (no-store)  (no-cache)
```

**å®é™…åº”ç”¨å»ºè®®**ï¼š

| èµ„æºç±»å‹ | **ç¼“å­˜ç­–ç•¥** | **Cache-Controlè®¾ç½®** |
|---------|------------|---------------------|
| ğŸ–¼ï¸ å›¾ç‰‡/å­—ä½“ | å¼ºåˆ¶ç¼“å­˜1å¹´ | `max-age=31536000, public` |
| ğŸ“„ CSS/JS | å¼ºåˆ¶ç¼“å­˜1å¤© | `max-age=86400, public` |
| ğŸ“Š æ•°æ®åˆ—è¡¨ | åå•†ç¼“å­˜ | `no-cache, must-revalidate` |
| ğŸ’° è®¢å•è¯¦æƒ… | ç¦ç”¨ç¼“å­˜ | `no-store, no-cache, private` |

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 ä¸ƒå¤§åº”ç”¨åœºæ™¯é€Ÿè®°


```
ğŸ” ç™»å½•è®¤è¯ â†’ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œæœªç™»å½•è·³è½¬ç™»å½•é¡µ
ğŸ›¡ï¸ æƒé™æ§åˆ¶ â†’ æ£€æŸ¥ç”¨æˆ·æƒé™ï¼Œæ— æƒé™è¿”å›403é”™è¯¯
ğŸ“ æ—¥å¿—è®°å½• â†’ è®°å½•è®¿é—®æ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥å’Œåˆ†æ
â±ï¸ æ€§èƒ½ç›‘æ§ â†’ ç›‘æ§æ¥å£è€—æ—¶ï¼Œå‘ç°æ€§èƒ½ç“¶é¢ˆ
ğŸ”¤ ç¼–ç å¤„ç† â†’ ç»Ÿä¸€å­—ç¬¦ç¼–ç ï¼Œé¿å…ä¹±ç é—®é¢˜
ğŸŒ è·¨åŸŸå¤„ç† â†’ è®¾ç½®CORSå“åº”å¤´ï¼Œè§£å†³è·¨åŸŸé—®é¢˜
ğŸ’¾ ç¼“å­˜æ§åˆ¶ â†’ æ§åˆ¶ç¼“å­˜ç­–ç•¥ï¼Œä¼˜åŒ–åŠ è½½é€Ÿåº¦
```

### 9.2 æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº


**å¤šä¸ªæ‹¦æˆªå™¨çš„æ‰§è¡Œæµç¨‹**ï¼š

```
è¯·æ±‚è¿›å…¥
   â†“
æ‹¦æˆªå™¨1.preHandle()
   â†“
æ‹¦æˆªå™¨2.preHandle()
   â†“
æ‹¦æˆªå™¨3.preHandle()
   â†“
Controlleræ‰§è¡Œ
   â†“
æ‹¦æˆªå™¨3.postHandle()
   â†“
æ‹¦æˆªå™¨2.postHandle()
   â†“
æ‹¦æˆªå™¨1.postHandle()
   â†“
è§†å›¾æ¸²æŸ“
   â†“
æ‹¦æˆªå™¨3.afterCompletion()
   â†“
æ‹¦æˆªå™¨2.afterCompletion()
   â†“
æ‹¦æˆªå™¨1.afterCompletion()
   â†“
å“åº”è¿”å›
```

> ğŸ“Œ **æ‰§è¡Œé¡ºåºè§„å¾‹**  
> - **preHandle**ï¼šæŒ‰é…ç½®é¡ºåºæ‰§è¡Œï¼ˆ1â†’2â†’3ï¼‰
> - **postHandle**ï¼šæŒ‰é…ç½®é€†åºæ‰§è¡Œï¼ˆ3â†’2â†’1ï¼‰
> - **afterCompletion**ï¼šæŒ‰é…ç½®é€†åºæ‰§è¡Œï¼ˆ3â†’2â†’1ï¼‰

### 9.3 æ‹¦æˆªå™¨é…ç½®æœ€ä½³å®è·µ


**æ¨èé…ç½®é¡ºåº**ï¼š
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        
        // 1. ç¼–ç å¤„ç†ï¼ˆæœ€å…ˆæ‰§è¡Œï¼‰
        registry.addInterceptor(new EncodingInterceptor())
                .addPathPatterns("/**")
                .order(1);
        
        // 2. æ—¥å¿—è®°å½•ï¼ˆè®°å½•æ‰€æœ‰è¯·æ±‚ï¼‰
        registry.addInterceptor(new LogInterceptor())
                .addPathPatterns("/**")
                .order(2);
        
        // 3. ç™»å½•è®¤è¯ï¼ˆæ’é™¤é™æ€èµ„æºï¼‰
        registry.addInterceptor(new LoginInterceptor())
                .addPathPatterns("/**")
                .excludePathPatterns("/login", "/css/**", "/js/**")
                .order(3);
        
        // 4. æƒé™æ§åˆ¶ï¼ˆåœ¨ç™»å½•ä¹‹åï¼‰
        registry.addInterceptor(new PermissionInterceptor())
                .addPathPatterns("/**")
                .excludePathPatterns("/login", "/css/**", "/js/**")
                .order(4);
        
        // 5. æ€§èƒ½ç›‘æ§ï¼ˆæœ€åæ‰§è¡Œï¼‰
        registry.addInterceptor(new PerformanceInterceptor())
                .addPathPatterns("/**")
                .order(5);
    }
}
```

### 9.4 å®é™…åº”ç”¨æ³¨æ„äº‹é¡¹


> âš ï¸ **ç™»å½•è®¤è¯æ‹¦æˆªå™¨**
> - å¿…é¡»æ’é™¤ç™»å½•é¡µã€æ³¨å†Œé¡µã€é™æ€èµ„æº
> - å¯ä»¥è®°å½•è¢«æ‹¦æˆªçš„åŸå§‹URLï¼Œç™»å½•åè‡ªåŠ¨è·³è½¬

> ğŸ›¡ï¸ **æƒé™æ§åˆ¶æ‹¦æˆªå™¨**  
> - å¿…é¡»åœ¨ç™»å½•æ‹¦æˆªå™¨ä¹‹åæ‰§è¡Œ
> - å¯ä»¥ä½¿ç”¨æ³¨è§£æ–¹å¼ï¼Œæ›´çµæ´»æ–¹ä¾¿

> ğŸ“ **æ—¥å¿—è®°å½•æ‹¦æˆªå™¨**
> - å»ºè®®è®°å½•åˆ°æ•°æ®åº“ï¼Œæ–¹ä¾¿æŸ¥è¯¢ç»Ÿè®¡
> - å¯ä»¥å¼‚æ­¥è®°å½•ï¼Œé¿å…å½±å“æ€§èƒ½

> â±ï¸ **æ€§èƒ½ç›‘æ§æ‹¦æˆªå™¨**
> - è®¾ç½®åˆç†çš„æ…¢æ¥å£é˜ˆå€¼ï¼ˆå¦‚2ç§’ï¼‰
> - æ…¢æ¥å£è¦åŠæ—¶å‘Šè­¦å’Œä¼˜åŒ–

> ğŸ”¤ **ç¼–ç å¤„ç†æ‹¦æˆªå™¨**
> - ä¼˜å…ˆä½¿ç”¨Springæä¾›çš„CharacterEncodingFilter
> - è®¾ç½®forceEncoding=trueå¼ºåˆ¶ä½¿ç”¨UTF-8

> ğŸŒ **è·¨åŸŸå¤„ç†æ‹¦æˆªå™¨**
> - ç”Ÿäº§ç¯å¢ƒä¸è¦è®¾ç½®ä¸ºå…è®¸æ‰€æœ‰åŸŸåï¼ˆ*ï¼‰
> - ä¼˜å…ˆä½¿ç”¨@CrossOriginæ³¨è§£ï¼Œæ›´çµæ´»

> ğŸ’¾ **ç¼“å­˜æ§åˆ¶æ‹¦æˆªå™¨**
> - é™æ€èµ„æºè®¾ç½®é•¿æ—¶é—´ç¼“å­˜ï¼ˆ1å¹´ï¼‰
> - æ•æ„Ÿæ•°æ®ç¦ç”¨ç¼“å­˜ï¼ˆno-storeï¼‰

### 9.5 å­¦ä¹ æ£€éªŒæ¸…å•


âœ… **è‡ªæ£€æ¸…å•**ï¼š
- [ ] èƒ½è¯´å‡ºæ‹¦æˆªå™¨çš„ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•åŠå…¶ä½œç”¨
- [ ] èƒ½ç‹¬ç«‹å®ç°ç™»å½•è®¤è¯æ‹¦æˆªå™¨
- [ ] ç†è§£æƒé™æ§åˆ¶æ‹¦æˆªå™¨çš„æ³¨è§£ä½¿ç”¨æ–¹å¼
- [ ] çŸ¥é“å¦‚ä½•è®°å½•è®¿é—®æ—¥å¿—å’Œæ€§èƒ½ç›‘æ§
- [ ] äº†è§£è·¨åŸŸé—®é¢˜çš„åŸå› å’Œè§£å†³æ–¹æ¡ˆ
- [ ] æŒæ¡ä¸åŒèµ„æºçš„ç¼“å­˜ç­–ç•¥é€‰æ‹©
- [ ] èƒ½æ­£ç¡®é…ç½®å¤šä¸ªæ‹¦æˆªå™¨çš„æ‰§è¡Œé¡ºåº

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æ‹¦æˆªå™¨åœºæ™¯ä¸ƒå¤§ç±»ï¼Œç™»å½•æƒé™æ—¥å¿—æ’
æ€§èƒ½ç¼–ç è·¨åŸŸç¼“å­˜ï¼Œé…ç½®é¡ºåºè¦è®°ç‰¢
preHandleè¯·æ±‚å‰ï¼ŒpostHandleè§†å›¾å‰
afterCompletionæœ€åï¼Œä¸‰ä¸ªæ—¶æœºè¦åˆ†æ¸…
```