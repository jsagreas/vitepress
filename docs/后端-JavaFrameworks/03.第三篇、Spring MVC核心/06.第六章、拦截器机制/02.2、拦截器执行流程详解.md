---
title: 2ã€æ‹¦æˆªå™¨æ‰§è¡Œæµç¨‹è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [æ‹¦æˆªå™¨æ˜¯ä»€ä¹ˆ](#1-æ‹¦æˆªå™¨æ˜¯ä»€ä¹ˆ)
2. [ä¸‰å¤§æ ¸å¿ƒæ–¹æ³•è¯¦è§£](#2-ä¸‰å¤§æ ¸å¿ƒæ–¹æ³•è¯¦è§£)
3. [æ‰§è¡Œæµç¨‹ä¸é¡ºåº](#3-æ‰§è¡Œæµç¨‹ä¸é¡ºåº)
4. [è°ƒç”¨é“¾æœºåˆ¶](#4-è°ƒç”¨é“¾æœºåˆ¶)
5. [å¼‚å¸¸å¤„ç†æœºåˆ¶](#5-å¼‚å¸¸å¤„ç†æœºåˆ¶)
6. [è¿”å›å€¼æ§åˆ¶è¯¦è§£](#6-è¿”å›å€¼æ§åˆ¶è¯¦è§£)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ‹¦æˆªå™¨æ˜¯ä»€ä¹ˆ


### 1.1 ç”Ÿæ´»åŒ–ç†è§£


**æ‹¦æˆªå™¨å°±åƒæœºåœºå®‰æ£€ç«™**

```
æ—…å®¢ç™»æœºæµç¨‹ï¼š
ä¹°ç¥¨ â†’ å®‰æ£€å…¥å£ â†’ é€šè¿‡æ£€æŸ¥ â†’ ç™»æœº â†’ åˆ°è¾¾ç›®çš„åœ° â†’ å®‰æ£€å‡ºå£

Spring MVCæµç¨‹ï¼š
è¯·æ±‚å‘èµ· â†’ preHandle â†’ é€šè¿‡éªŒè¯ â†’ æ‰§è¡ŒController â†’ è¿”å›ç»“æœ â†’ postHandle â†’ afterCompletion
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- **è¿›é—¨æ£€æŸ¥**ï¼špreHandle - æ£€æŸ¥æ˜¯å¦å…è®¸é€šè¡Œ
- **ä¸­é€”è®°å½•**ï¼špostHandle - è®°å½•å¤„ç†ç»“æœ
- **ç¦»å¼€æ¸…ç†**ï¼šafterCompletion - æ”¶å°¾å·¥ä½œ

### 1.2 æŠ€æœ¯å®šä¹‰


> **æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰** æ˜¯Spring MVCæä¾›çš„ä¸€ç§åœ¨è¯·æ±‚å¤„ç†å‰åè¿›è¡Œæ‹¦æˆªå¤„ç†çš„æœºåˆ¶ï¼Œå¯ä»¥åœ¨Controlleræ‰§è¡Œå‰åæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ã€‚

**æ ¸å¿ƒæ¥å£**ï¼š`HandlerInterceptor`

```java
public interface HandlerInterceptor {
    // é¢„å¤„ç†ï¼šControlleræ‰§è¡Œå‰è°ƒç”¨
    boolean preHandle(HttpServletRequest request, 
                      HttpServletResponse response, 
                      Object handler);
    
    // åå¤„ç†ï¼šControlleræ‰§è¡Œåè°ƒç”¨
    void postHandle(HttpServletRequest request, 
                    HttpServletResponse response, 
                    Object handler, 
                    ModelAndView modelAndView);
    
    // å®Œæˆå¤„ç†ï¼šè§†å›¾æ¸²æŸ“åè°ƒç”¨
    void afterCompletion(HttpServletRequest request, 
                         HttpServletResponse response, 
                         Object handler, 
                         Exception ex);
}
```

---

## 2. ğŸ”§ ä¸‰å¤§æ ¸å¿ƒæ–¹æ³•è¯¦è§£


### 2.1 preHandle - é¢„å¤„ç†æ–¹æ³•


**ğŸ”¸ æ–¹æ³•è¯´æ˜**

```
è°ƒç”¨æ—¶æœºï¼šControlleræ–¹æ³•æ‰§è¡Œä¹‹å‰
è¿”å›ç±»å‹ï¼šboolean
ä½œç”¨ï¼šå†³å®šè¯·æ±‚æ˜¯å¦ç»§ç»­æ‰§è¡Œ
```

**æ–¹æ³•ç­¾å**ï¼š
```java
boolean preHandle(HttpServletRequest request, 
                  HttpServletResponse response, 
                  Object handler) throws Exception
```

**å‚æ•°å«ä¹‰**ï¼š
- `request` - å½“å‰HTTPè¯·æ±‚å¯¹è±¡
- `response` - å½“å‰HTTPå“åº”å¯¹è±¡  
- `handler` - å³å°†æ‰§è¡Œçš„å¤„ç†å™¨ï¼ˆé€šå¸¸æ˜¯Controlleræ–¹æ³•ï¼‰

**è¿”å›å€¼æ§åˆ¶**ï¼š
```
true  â†’ ç»§ç»­æ‰§è¡Œï¼Œæ”¾è¡Œåˆ°ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨æˆ–Controller
false â†’ ä¸­æ–­æ‰§è¡Œï¼Œè¯·æ±‚åˆ°æ­¤ä¸ºæ­¢
```

**ğŸ’¡ å…¸å‹åº”ç”¨åœºæ™¯**ï¼š

| åœºæ™¯ | è¯´æ˜ | è¿”å›å€¼ |
|------|------|--------|
| **ç™»å½•éªŒè¯** | æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½• | æœªç™»å½•è¿”å›false |
| **æƒé™æ£€æŸ¥** | éªŒè¯ç”¨æˆ·æƒé™ | æ— æƒé™è¿”å›false |
| **è¯·æ±‚æ—¥å¿—** | è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´ | è¿”å›true |
| **å‚æ•°æ ¡éªŒ** | éªŒè¯å¿…è¦å‚æ•° | å‚æ•°é”™è¯¯è¿”å›false |

**ç¤ºä¾‹ä»£ç **ï¼š
```java
@Override
public boolean preHandle(HttpServletRequest request, 
                         HttpServletResponse response, 
                         Object handler) {
    // 1. è·å–sessionä¸­çš„ç”¨æˆ·ä¿¡æ¯
    HttpSession session = request.getSession();
    Object user = session.getAttribute("user");
    
    // 2. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•
    if (user == null) {
        // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
        response.sendRedirect("/login");
        return false;  // â† ä¸­æ–­è¯·æ±‚
    }
    
    // 3. å·²ç™»å½•ï¼Œæ”¾è¡Œ
    return true;  // â† ç»§ç»­æ‰§è¡Œ
}
```

### 2.2 postHandle - åå¤„ç†æ–¹æ³•


**ğŸ”¸ æ–¹æ³•è¯´æ˜**

```
è°ƒç”¨æ—¶æœºï¼šControlleræ–¹æ³•æ‰§è¡Œä¹‹åï¼Œè§†å›¾æ¸²æŸ“ä¹‹å‰
è¿”å›ç±»å‹ï¼švoidï¼ˆæ— è¿”å›å€¼ï¼‰
ä½œç”¨ï¼šå¯ä»¥ä¿®æ”¹ModelAndViewï¼Œå½±å“æœ€ç»ˆé¡µé¢å±•ç¤º
```

**æ–¹æ³•ç­¾å**ï¼š
```java
void postHandle(HttpServletRequest request, 
                HttpServletResponse response, 
                Object handler, 
                ModelAndView modelAndView) throws Exception
```

**æ–°å¢å‚æ•°**ï¼š
- `modelAndView` - Controllerè¿”å›çš„æ¨¡å‹å’Œè§†å›¾å¯¹è±¡ï¼Œå¯ä»¥ä¿®æ”¹

**âš ï¸ é‡è¦ç‰¹æ€§**ï¼š
- åªæœ‰preHandleè¿”å›trueæ—¶æ‰ä¼šæ‰§è¡Œ
- ControlleræŠ›å‡ºå¼‚å¸¸æ—¶ä¸ä¼šæ‰§è¡Œ
- å¯ä»¥ä¿®æ”¹è¿”å›ç»™é¡µé¢çš„æ•°æ®

**ğŸ’¡ å…¸å‹åº”ç”¨åœºæ™¯**ï¼š

```
ç»Ÿä¸€æ•°æ®å¤„ç†ï¼š
â€¢ ç»™æ‰€æœ‰é¡µé¢æ·»åŠ å…¬å…±ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·åã€æ—¶é—´æˆ³ï¼‰
â€¢ ç»Ÿä¸€ä¿®æ”¹è¿”å›æ•°æ®æ ¼å¼
â€¢ æ·»åŠ å…¨å±€çš„Modelå±æ€§

æ—¥å¿—è®°å½•ï¼š
â€¢ è®°å½•Controlleræ‰§è¡Œè€—æ—¶
â€¢ è®°å½•è¿”å›çš„è§†å›¾åç§°
```

**ç¤ºä¾‹ä»£ç **ï¼š
```java
@Override
public void postHandle(HttpServletRequest request, 
                       HttpServletResponse response, 
                       Object handler, 
                       ModelAndView modelAndView) {
    // 1. æ£€æŸ¥æ˜¯å¦æœ‰ModelAndViewï¼ˆå¯èƒ½è¿”å›JSONï¼‰
    if (modelAndView != null) {
        // 2. ç»™æ‰€æœ‰é¡µé¢æ·»åŠ å½“å‰æ—¶é—´
        modelAndView.addObject("currentTime", new Date());
        
        // 3. æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°é¡µé¢
        HttpSession session = request.getSession();
        Object user = session.getAttribute("user");
        modelAndView.addObject("loginUser", user);
    }
    
    // 4. è®°å½•æ—¥å¿—
    System.out.println("Controlleræ‰§è¡Œå®Œæˆï¼Œè§†å›¾å: " + 
                       modelAndView.getViewName());
}
```

### 2.3 afterCompletion - å®Œæˆæ–¹æ³•


**ğŸ”¸ æ–¹æ³•è¯´æ˜**

```
è°ƒç”¨æ—¶æœºï¼šæ•´ä¸ªè¯·æ±‚å®Œæˆä¹‹åï¼ˆè§†å›¾æ¸²æŸ“å®Œæˆï¼‰
è¿”å›ç±»å‹ï¼švoid
ä½œç”¨ï¼šæ¸…ç†èµ„æºï¼Œè®°å½•æœ€ç»ˆæ—¥å¿—
```

**æ–¹æ³•ç­¾å**ï¼š
```java
void afterCompletion(HttpServletRequest request, 
                     HttpServletResponse response, 
                     Object handler, 
                     Exception ex) throws Exception
```

**æ–°å¢å‚æ•°**ï¼š
- `ex` - å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œè¿™é‡Œä¼šæœ‰å¼‚å¸¸å¯¹è±¡ï¼›å¦åˆ™ä¸ºnull

**âš ï¸ é‡è¦ç‰¹æ€§**ï¼š
- **ä¸€å®šä¼šæ‰§è¡Œ**ï¼ˆåªè¦preHandleè¿”å›äº†trueï¼‰
- **å³ä½¿å‡ºç°å¼‚å¸¸ä¹Ÿä¼šæ‰§è¡Œ**ï¼ˆç”¨äºèµ„æºé‡Šæ”¾ï¼‰
- **ç±»ä¼¼äºfinallyå—çš„ä½œç”¨**

**ğŸ’¡ å…¸å‹åº”ç”¨åœºæ™¯**ï¼š

```
èµ„æºæ¸…ç†ï¼š
â€¢ å…³é—­æ•°æ®åº“è¿æ¥
â€¢ é‡Šæ”¾æ–‡ä»¶å¥æŸ„
â€¢ æ¸…ç†çº¿ç¨‹å±€éƒ¨å˜é‡

æ—¥å¿—è®°å½•ï¼š
â€¢ è®°å½•è¯·æ±‚æ€»è€—æ—¶
â€¢ è®°å½•æ˜¯å¦å‘ç”Ÿå¼‚å¸¸
â€¢ è®°å½•æœ€ç»ˆæ‰§è¡ŒçŠ¶æ€
```

**ç¤ºä¾‹ä»£ç **ï¼š
```java
@Override
public void afterCompletion(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler, 
                            Exception ex) {
    // 1. è®¡ç®—æ€»è€—æ—¶
    Long startTime = (Long) request.getAttribute("startTime");
    long endTime = System.currentTimeMillis();
    long duration = endTime - startTime;
    
    // 2. è®°å½•æ—¥å¿—
    System.out.println("è¯·æ±‚å¤„ç†å®Œæˆï¼Œæ€»è€—æ—¶: " + duration + "ms");
    
    // 3. æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸
    if (ex != null) {
        System.err.println("è¯·æ±‚å¼‚å¸¸: " + ex.getMessage());
    }
    
    // 4. æ¸…ç†èµ„æº
    request.removeAttribute("startTime");
}
```

---

## 3. ğŸ“Š æ‰§è¡Œæµç¨‹ä¸é¡ºåº


### 3.1 å®Œæ•´æ‰§è¡Œæµç¨‹å›¾


```
HTTPè¯·æ±‚
   â”‚
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DispatcherServletï¼ˆå‰ç«¯æ§åˆ¶å™¨ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â†“
ã€æ‹¦æˆªå™¨1 - preHandleã€‘ â”€â”€â”€â”€â†’ false? â”€â”€â†’ ç»“æŸ
   â”‚                         (ä¸å¾€ä¸‹æ‰§è¡Œ)
   â†“ true
ã€æ‹¦æˆªå™¨2 - preHandleã€‘ â”€â”€â”€â”€â†’ false? â”€â”€â†’ æ‰§è¡ŒafterCompletion
   â”‚                         (é€†åº)
   â†“ true
ã€æ‹¦æˆªå™¨3 - preHandleã€‘ â”€â”€â”€â”€â†’ false? â”€â”€â†’ æ‰§è¡ŒafterCompletion
   â”‚                         (é€†åº)
   â†“ true
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Controlleræ–¹æ³•æ‰§è¡Œ                      â”‚
â”‚  (å¤„ç†ä¸šåŠ¡é€»è¾‘)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â†“
ã€æ‹¦æˆªå™¨3 - postHandleã€‘
   â”‚
   â†“
ã€æ‹¦æˆªå™¨2 - postHandleã€‘
   â”‚
   â†“
ã€æ‹¦æˆªå™¨1 - postHandleã€‘
   â”‚
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§†å›¾æ¸²æŸ“ï¼ˆç”ŸæˆHTMLï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â†“
ã€æ‹¦æˆªå™¨3 - afterCompletionã€‘
   â”‚
   â†“
ã€æ‹¦æˆªå™¨2 - afterCompletionã€‘
   â”‚
   â†“
ã€æ‹¦æˆªå™¨1 - afterCompletionã€‘
   â”‚
   â†“
è¿”å›å“åº”ç»™å®¢æˆ·ç«¯
```

### 3.2 æ‰§è¡Œé¡ºåºè§„å¾‹


**ğŸ”¸ æ ¸å¿ƒè§„å¾‹**

| æ–¹æ³• | æ‰§è¡Œé¡ºåº | è®°å¿†æŠ€å·§ |
|------|----------|----------|
| **preHandle** | æ­£åºæ‰§è¡Œ | åƒè¿‡å®‰æ£€ï¼ŒæŒ‰é¡ºåºä¸€ä¸ªä¸ªæ£€æŸ¥ |
| **postHandle** | é€†åºæ‰§è¡Œ | åƒç©¿è¡£æœï¼Œå…ˆç©¿çš„åè„± |
| **afterCompletion** | é€†åºæ‰§è¡Œ | åƒç©¿è¡£æœï¼Œå…ˆç©¿çš„åè„± |

**æ—¶é—´è½´ç¤ºä¾‹**ï¼š
```
å‡è®¾æœ‰3ä¸ªæ‹¦æˆªå™¨ï¼šAã€Bã€C

æ—¶é—´é¡ºåºæ‰§è¡Œï¼š
1. A.preHandle()      â† æ­£åº
2. B.preHandle()      â† æ­£åº
3. C.preHandle()      â† æ­£åº
4. Controlleræ‰§è¡Œ
5. C.postHandle()     â† é€†åº
6. B.postHandle()     â† é€†åº
7. A.postHandle()     â† é€†åº
8. è§†å›¾æ¸²æŸ“
9. C.afterCompletion() â† é€†åº
10. B.afterCompletion() â† é€†åº
11. A.afterCompletion() â† é€†åº
```

### 3.3 ç‰¹æ®Šæƒ…å†µä¸‹çš„æ‰§è¡Œ


**æƒ…å†µ1ï¼šç¬¬2ä¸ªæ‹¦æˆªå™¨preHandleè¿”å›false**

```
æ‰§è¡Œè¿‡ç¨‹ï¼š
1. A.preHandle() â†’ true  âœ…
2. B.preHandle() â†’ false âŒ (ä¸­æ–­)
3. A.afterCompletion()   âœ… (åªæ‰§è¡Œå·²æ”¾è¡Œçš„)

ç»“æœï¼š
â€¢ C.preHandleä¸æ‰§è¡Œ
â€¢ Controllerä¸æ‰§è¡Œ
â€¢ æ‰€æœ‰postHandleä¸æ‰§è¡Œ
â€¢ åªæ‰§è¡ŒAçš„afterCompletion
```

**æƒ…å†µ2ï¼šControlleræŠ›å‡ºå¼‚å¸¸**

```
æ‰§è¡Œè¿‡ç¨‹ï¼š
1. A.preHandle() â†’ true
2. B.preHandle() â†’ true
3. C.preHandle() â†’ true
4. Controlleræ‰§è¡Œ â†’ æŠ›å¼‚å¸¸ï¼ğŸ’¥
5. postHandleå…¨éƒ¨è·³è¿‡ âŒ
6. C.afterCompletion(exä¸ä¸ºnull)
7. B.afterCompletion(exä¸ä¸ºnull)
8. A.afterCompletion(exä¸ä¸ºnull)

ç»“æœï¼š
â€¢ æ‰€æœ‰postHandleä¸æ‰§è¡Œ
â€¢ afterCompletionä»ç„¶æ‰§è¡Œï¼ˆæ¥æ”¶å¼‚å¸¸å¯¹è±¡ï¼‰
```

---

## 4. ğŸ”— è°ƒç”¨é“¾æœºåˆ¶


### 4.1 ä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨é“¾


**é€šä¿—ç†è§£**ï¼š
> æ‹¦æˆªå™¨é“¾å°±åƒä¸€æ¡æµæ°´çº¿ï¼Œè¯·æ±‚åƒäº§å“ä¸€æ ·ç»è¿‡å¤šé“å·¥åºï¼Œæ¯é“å·¥åºéƒ½å¯ä»¥æ£€æŸ¥ã€åŠ å·¥ã€ç”šè‡³æ‹’ç»è¿™ä¸ªäº§å“ã€‚

**æŠ€æœ¯å®šä¹‰**ï¼š
```
æ‹¦æˆªå™¨é“¾ = å¤šä¸ªæ‹¦æˆªå™¨æŒ‰é…ç½®é¡ºåºç»„æˆçš„æ‰§è¡Œé“¾æ¡
æ¯ä¸ªæ‹¦æˆªå™¨éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚æˆ–ä¸­æ–­è¯·æ±‚
```

### 4.2 é…ç½®æ‹¦æˆªå™¨é“¾


**é…ç½®æ–¹å¼ï¼ˆJava Configï¼‰**ï¼š

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // æ‹¦æˆªå™¨1ï¼šç™»å½•æ£€æŸ¥
        registry.addInterceptor(new LoginInterceptor())
                .addPathPatterns("/user/**")      // æ‹¦æˆªè·¯å¾„
                .excludePathPatterns("/user/login"); // æ’é™¤è·¯å¾„
        
        // æ‹¦æˆªå™¨2ï¼šæƒé™æ£€æŸ¥
        registry.addInterceptor(new AuthInterceptor())
                .addPathPatterns("/admin/**");
        
        // æ‹¦æˆªå™¨3ï¼šæ—¥å¿—è®°å½•
        registry.addInterceptor(new LogInterceptor())
                .addPathPatterns("/**");
    }
}
```

**æ‰§è¡Œé¡ºåº**ï¼š
```
é…ç½®é¡ºåº = æ‰§è¡Œé¡ºåº
ç¬¬1ä¸ªé…ç½® â†’ ç¬¬1ä¸ªæ‰§è¡ŒpreHandle
ç¬¬2ä¸ªé…ç½® â†’ ç¬¬2ä¸ªæ‰§è¡ŒpreHandle
ç¬¬3ä¸ªé…ç½® â†’ ç¬¬3ä¸ªæ‰§è¡ŒpreHandle
```

### 4.3 è°ƒç”¨é“¾æ‰§è¡Œæœºåˆ¶


**æ­£å‘ä¼ æ’­ï¼ˆpreHandleï¼‰**ï¼š

```
è¯·æ±‚è¿›å…¥
  â†“
æ‹¦æˆªå™¨1.preHandle() â†’ true
  â†“
æ‹¦æˆªå™¨2.preHandle() â†’ true  
  â†“
æ‹¦æˆªå™¨3.preHandle() â†’ true
  â†“
Controlleræ‰§è¡Œ
```

**é€†å‘ä¼ æ’­ï¼ˆpostHandle & afterCompletionï¼‰**ï¼š

```
Controlleræ‰§è¡Œå®Œæˆ
  â†“
æ‹¦æˆªå™¨3.postHandle()
  â†“
æ‹¦æˆªå™¨2.postHandle()
  â†“
æ‹¦æˆªå™¨1.postHandle()
  â†“
è§†å›¾æ¸²æŸ“
  â†“
æ‹¦æˆªå™¨3.afterCompletion()
  â†“
æ‹¦æˆªå™¨2.afterCompletion()
  â†“
æ‹¦æˆªå™¨1.afterCompletion()
```

**ğŸ”‘ å…³é”®æœºåˆ¶**ï¼š
- **çŸ­è·¯æœºåˆ¶**ï¼šä»»ä¸€preHandleè¿”å›falseï¼Œç«‹å³ä¸­æ–­
- **è¡¥å¿æœºåˆ¶**ï¼šå³ä½¿ä¸­æ–­ï¼Œå·²æ‰§è¡Œçš„æ‹¦æˆªå™¨ä»ä¼šæ‰§è¡ŒafterCompletion
- **å¼‚å¸¸éš”ç¦»**ï¼šæŸä¸ªæ‹¦æˆªå™¨å¼‚å¸¸ä¸å½±å“å…¶ä»–æ‹¦æˆªå™¨çš„afterCompletionæ‰§è¡Œ

---

## 5. âš ï¸ å¼‚å¸¸å¤„ç†æœºåˆ¶


### 5.1 å¼‚å¸¸å‘ç”Ÿçš„ä¸‰ä¸ªé˜¶æ®µ


**é˜¶æ®µ1ï¼špreHandleä¸­çš„å¼‚å¸¸**

```java
// æ‹¦æˆªå™¨A
public boolean preHandle(...) {
    throw new RuntimeException("Aå¼‚å¸¸");  // ğŸ’¥ æŠ›å‡ºå¼‚å¸¸
}

æ‰§è¡Œç»“æœï¼š
â€¢ åç»­æ‹¦æˆªå™¨çš„preHandleä¸æ‰§è¡Œ
â€¢ Controllerä¸æ‰§è¡Œ
â€¢ æ‰€æœ‰postHandleä¸æ‰§è¡Œ
â€¢ å·²æ‰§è¡Œçš„æ‹¦æˆªå™¨ä¼šæ‰§è¡ŒafterCompletionï¼ˆexå‚æ•°æœ‰å€¼ï¼‰
```

**é˜¶æ®µ2ï¼šControllerä¸­çš„å¼‚å¸¸**

```java
@GetMapping("/test")
public String test() {
    throw new RuntimeException("ä¸šåŠ¡å¼‚å¸¸");  // ğŸ’¥ æŠ›å‡ºå¼‚å¸¸
}

æ‰§è¡Œç»“æœï¼š
â€¢ æ‰€æœ‰æ‹¦æˆªå™¨çš„preHandleå·²æ‰§è¡Œ
â€¢ æ‰€æœ‰postHandleä¸æ‰§è¡Œ âŒ
â€¢ æ‰€æœ‰afterCompletionæ‰§è¡Œ âœ…ï¼ˆexå‚æ•°æœ‰å€¼ï¼‰
```

**é˜¶æ®µ3ï¼špostHandleä¸­çš„å¼‚å¸¸**

```java
// æ‹¦æˆªå™¨B
public void postHandle(...) {
    throw new RuntimeException("Bå¼‚å¸¸");  // ğŸ’¥ æŠ›å‡ºå¼‚å¸¸
}

æ‰§è¡Œç»“æœï¼š
â€¢ å½“å‰åŠåç»­æ‹¦æˆªå™¨çš„postHandleä¸æ‰§è¡Œ
â€¢ æ‰€æœ‰afterCompletionä»ç„¶æ‰§è¡Œï¼ˆexå‚æ•°æœ‰å€¼ï¼‰
```

### 5.2 å¼‚å¸¸å¤„ç†æµç¨‹å›¾


```
è¯·æ±‚å¼€å§‹
   â”‚
   â†“
æ‹¦æˆªå™¨A.preHandle()  â”€â”€å¼‚å¸¸â†’  A.afterCompletion(ex) â†’ ç»“æŸ
   â”‚ âœ“
   â†“
æ‹¦æˆªå™¨B.preHandle()  â”€â”€å¼‚å¸¸â†’  B.afterCompletion(ex)
   â”‚ âœ“                       A.afterCompletion(ex) â†’ ç»“æŸ
   â†“
Controlleræ‰§è¡Œ       â”€â”€å¼‚å¸¸â†’  è·³è¿‡æ‰€æœ‰postHandle
   â”‚ âœ“                       B.afterCompletion(ex)
   â†“                         A.afterCompletion(ex) â†’ ç»“æŸ
æ‹¦æˆªå™¨B.postHandle() â”€â”€å¼‚å¸¸â†’  è·³è¿‡A.postHandle
   â”‚ âœ“                       B.afterCompletion(ex)
   â†“                         A.afterCompletion(ex) â†’ ç»“æŸ
æ‹¦æˆªå™¨A.postHandle()
   â”‚ âœ“
   â†“
è§†å›¾æ¸²æŸ“
   â”‚
   â†“
æ‹¦æˆªå™¨B.afterCompletion(null)
   â”‚
   â†“
æ‹¦æˆªå™¨A.afterCompletion(null)
   â”‚
   â†“
æ­£å¸¸ç»“æŸ
```

### 5.3 å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**ï¼š

```java
@Override
public boolean preHandle(...) {
    try {
        // ä¸šåŠ¡é€»è¾‘
        checkLogin();
        return true;
    } catch (Exception e) {
        // è®°å½•æ—¥å¿—
        logger.error("ç™»å½•æ£€æŸ¥å¤±è´¥", e);
        // è®¾ç½®é”™è¯¯ä¿¡æ¯
        response.sendError(HttpServletResponse.SC_UNAUTHORIZED, 
                          "è¯·å…ˆç™»å½•");
        return false;  // ä¸­æ–­è¯·æ±‚
    }
}

@Override
public void afterCompletion(..., Exception ex) {
    // ç»Ÿä¸€å¼‚å¸¸æ—¥å¿—è®°å½•
    if (ex != null) {
        logger.error("è¯·æ±‚å¤„ç†å¼‚å¸¸: " + request.getRequestURI(), ex);
    }
    
    // æ¸…ç†èµ„æºï¼ˆå³ä½¿å¼‚å¸¸ä¹Ÿè¦æ¸…ç†ï¼‰
    cleanupResources();
}
```

---

## 6. ğŸ›ï¸ è¿”å›å€¼æ§åˆ¶è¯¦è§£


### 6.1 preHandleè¿”å›å€¼çš„å½±å“


**è¿”å›trueçš„æ•ˆæœ**ï¼š

```
âœ… å…è®¸æ‰§è¡Œï¼š
â€¢ ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨çš„preHandle
â€¢ å¦‚æœæ˜¯æœ€åä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæ‰§è¡ŒController
â€¢ åç»­ä¼šæ‰§è¡ŒpostHandleå’ŒafterCompletion

ä½¿ç”¨åœºæ™¯ï¼š
â€¢ ç™»å½•æ£€æŸ¥é€šè¿‡
â€¢ æƒé™éªŒè¯æˆåŠŸ
â€¢ å‚æ•°æ ¡éªŒæ­£ç¡®
```

**è¿”å›falseçš„æ•ˆæœ**ï¼š

```
âŒ ä¸­æ–­æ‰§è¡Œï¼š
â€¢ ä¸æ‰§è¡Œåç»­æ‹¦æˆªå™¨çš„preHandle
â€¢ ä¸æ‰§è¡ŒController
â€¢ ä¸æ‰§è¡Œä»»ä½•postHandle
â€¢ ä»…æ‰§è¡Œå·²æ”¾è¡Œæ‹¦æˆªå™¨çš„afterCompletionï¼ˆé€†åºï¼‰

ä½¿ç”¨åœºæ™¯ï¼š
â€¢ ç”¨æˆ·æœªç™»å½•
â€¢ æƒé™ä¸è¶³
â€¢ è¯·æ±‚å‚æ•°éæ³•
â€¢ è®¿é—®é¢‘ç‡è¶…é™
```

### 6.2 è¿”å›å€¼æ§åˆ¶ç¤ºä¾‹


**æ¡ˆä¾‹1ï¼šç™»å½•æ‹¦æˆªå™¨**

```java
public class LoginInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                             HttpServletResponse response, 
                             Object handler) throws Exception {
        // 1. æ£€æŸ¥session
        HttpSession session = request.getSession();
        Object user = session.getAttribute("user");
        
        // 2. æ ¹æ®ç™»å½•çŠ¶æ€è¿”å›ä¸åŒå€¼
        if (user == null) {
            // æœªç™»å½•ï¼šé‡å®šå‘åˆ°ç™»å½•é¡µ
            response.sendRedirect("/login");
            return false;  // â† ä¸­æ–­è¯·æ±‚
        }
        
        // å·²ç™»å½•ï¼šç»§ç»­æ‰§è¡Œ
        return true;  // â† æ”¾è¡Œ
    }
}
```

**æ¡ˆä¾‹2ï¼šæƒé™æ‹¦æˆªå™¨**

```java
public class AuthInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                             HttpServletResponse response, 
                             Object handler) throws Exception {
        // 1. è·å–ç”¨æˆ·è§’è‰²
        User user = (User) request.getSession().getAttribute("user");
        String role = user.getRole();
        
        // 2. è·å–è¯·æ±‚è·¯å¾„
        String uri = request.getRequestURI();
        
        // 3. æƒé™æ£€æŸ¥
        if (uri.startsWith("/admin") && !"ADMIN".equals(role)) {
            // æ— æƒé™ï¼šè¿”å›403é”™è¯¯
            response.sendError(HttpServletResponse.SC_FORBIDDEN, 
                              "æƒé™ä¸è¶³");
            return false;  // â† ä¸­æ–­è¯·æ±‚
        }
        
        // æœ‰æƒé™ï¼šæ”¾è¡Œ
        return true;
```

### 6.3 è¿”å›å€¼ä¸æ‰§è¡Œé“¾çš„å…³ç³»


**é…ç½®ç¤ºä¾‹**ï¼š
```java
// 3ä¸ªæ‹¦æˆªå™¨ï¼šç™»å½• â†’ æƒé™ â†’ æ—¥å¿—
registry.addInterceptor(new LoginInterceptor());   // A
registry.addInterceptor(new AuthInterceptor());    // B
registry.addInterceptor(new LogInterceptor());     // C
```

**åœºæ™¯1ï¼šå…¨éƒ¨è¿”å›true**
```
A.preHandle() â†’ true
B.preHandle() â†’ true
C.preHandle() â†’ true
Controlleræ‰§è¡Œ
C.postHandle()
B.postHandle()
A.postHandle()
C.afterCompletion()
B.afterCompletion()
A.afterCompletion()
```

**åœºæ™¯2ï¼šBè¿”å›false**
```
A.preHandle() â†’ true
B.preHandle() â†’ false  â† ä¸­æ–­ç‚¹
Cä¸æ‰§è¡Œ
Controllerä¸æ‰§è¡Œ
postHandleå…¨ä¸æ‰§è¡Œ
B.afterCompletion()    â† ä»è¿™é‡Œå¼€å§‹é€†åº
A.afterCompletion()
```

**åœºæ™¯3ï¼šAè¿”å›false**
```
A.preHandle() â†’ false  â† ç«‹å³ä¸­æ–­
åç»­å…¨ä¸æ‰§è¡Œ
A.afterCompletion()    â† åªæ‰§è¡ŒAçš„æ¸…ç†
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 ä¸‰å¤§æ–¹æ³•å¯¹æ¯”


| æ–¹æ³• | è°ƒç”¨æ—¶æœº | è¿”å›å€¼ | èƒ½å¦ä¸­æ–­ | å…¸å‹ç”¨é€” |
|------|----------|--------|----------|----------|
| **preHandle** | Controlleræ‰§è¡Œå‰ | boolean | âœ… èƒ½ | ç™»å½•éªŒè¯ã€æƒé™æ£€æŸ¥ |
| **postHandle** | Controlleræ‰§è¡Œå | void | âŒ ä¸èƒ½ | æ•°æ®åŠ å·¥ã€æ—¥å¿—è®°å½• |
| **afterCompletion** | è§†å›¾æ¸²æŸ“å | void | âŒ ä¸èƒ½ | èµ„æºæ¸…ç†ã€å¼‚å¸¸å¤„ç† |

### 7.2 æ‰§è¡Œæµç¨‹å…³é”®ç‚¹


**ğŸ”¸ æ‰§è¡Œé¡ºåºå£è¯€**
```
preHandleæ­£ç€æ¥ï¼ˆé¡ºåºæ‰§è¡Œï¼‰
postHandleåç€èµ°ï¼ˆé€†åºæ‰§è¡Œï¼‰
afterCompletionå€’ç€æ¸…ï¼ˆé€†åºæ‰§è¡Œï¼‰
```

**ğŸ”¸ å¼‚å¸¸å¤„ç†è§„åˆ™**
```
â€¢ preHandleå¼‚å¸¸ â†’ åç»­å…¨ä¸æ‰§è¡Œï¼Œæ‰§è¡Œå·²æ”¾è¡Œçš„afterCompletion
â€¢ Controllerå¼‚å¸¸ â†’ è·³è¿‡postHandleï¼Œæ‰§è¡Œå…¨éƒ¨afterCompletion
â€¢ postHandleå¼‚å¸¸ â†’ è·³è¿‡åç»­postHandleï¼Œæ‰§è¡Œå…¨éƒ¨afterCompletion
â€¢ afterCompletionä¸€å®šæ‰§è¡Œï¼ˆåªè¦preHandleè¿”å›äº†trueï¼‰
```

**ğŸ”¸ è¿”å›å€¼æ§åˆ¶è§„åˆ™**
```
true  â†’ ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨æˆ–Controller
false â†’ ç«‹å³ä¸­æ–­ï¼Œä¸æ‰§è¡Œåç»­æµç¨‹
      â†’ ä½†ä¼šæ‰§è¡Œå·²æ”¾è¡Œæ‹¦æˆªå™¨çš„afterCompletion
```

### 7.3 å®é™…åº”ç”¨åœºæ™¯


**ç™»å½•éªŒè¯æµç¨‹**ï¼š
```
1. LoginInterceptor.preHandle()
   â†’ æ£€æŸ¥sessionä¸­æ˜¯å¦æœ‰ç”¨æˆ·
   â†’ æœ‰ç”¨æˆ·ï¼šreturn trueï¼ˆæ”¾è¡Œï¼‰
   â†’ æ— ç”¨æˆ·ï¼šé‡å®šå‘åˆ°ç™»å½•é¡µï¼Œreturn falseï¼ˆä¸­æ–­ï¼‰

2. å¦‚æœæ”¾è¡Œï¼Œç»§ç»­æ‰§è¡ŒController
3. afterCompletionä¸­è®°å½•è®¿é—®æ—¥å¿—
```

**æƒé™æ§åˆ¶æµç¨‹**ï¼š
```
1. LoginInterceptor.preHandle()
   â†’ éªŒè¯ç™»å½•çŠ¶æ€

2. AuthInterceptor.preHandle()
   â†’ æ£€æŸ¥ç”¨æˆ·è§’è‰²æƒé™
   â†’ æœ‰æƒé™ï¼šreturn true
   â†’ æ— æƒé™ï¼šè¿”å›403é”™è¯¯ï¼Œreturn false

3. afterCompletionä¸­æ¸…ç†æƒé™ä¸Šä¸‹æ–‡
```

**æ—¥å¿—è®°å½•æµç¨‹**ï¼š
```
1. LogInterceptor.preHandle()
   â†’ è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
   â†’ return true

2. LogInterceptor.postHandle()
   â†’ è®°å½•Controllerè¿”å›ç»“æœ

3. LogInterceptor.afterCompletion()
   â†’ è®¡ç®—æ€»è€—æ—¶
   â†’ è®°å½•å®Œæ•´æ—¥å¿—
   â†’ æ¸…ç†ä¸´æ—¶æ•°æ®
```

### 7.4 æ–°æ‰‹æ˜“é”™ç‚¹


**âŒ é”™è¯¯1ï¼šå¿˜è®°è¿”å›å€¼**
```java
// é”™è¯¯ï¼šæ²¡æœ‰è¿”å›å€¼
public boolean preHandle(...) {
    checkLogin();
    // å¿˜è®°returnï¼Œç¼–è¯‘æŠ¥é”™
}

// æ­£ç¡®ï¼šå¿…é¡»è¿”å›boolean
public boolean preHandle(...) {
    checkLogin();
    return true;  // â† å¿…é¡»è¿”å›
}
```

**âŒ é”™è¯¯2ï¼šåœ¨postHandleä¸­åšèµ„æºæ¸…ç†**
```java
// é”™è¯¯ï¼šå¼‚å¸¸æ—¶ä¸æ‰§è¡Œ
public void postHandle(...) {
    closeConnection();  // Controllerå¼‚å¸¸æ—¶ä¸ä¼šæ‰§è¡Œ
}

// æ­£ç¡®ï¼šåœ¨afterCompletionä¸­æ¸…ç†
public void afterCompletion(...) {
    closeConnection();  // ä¸€å®šä¼šæ‰§è¡Œ
}
```

**âŒ é”™è¯¯3ï¼šæ··æ·†æ‰§è¡Œé¡ºåº**
```java
// é”™è¯¯ç†è§£ï¼šä»¥ä¸ºpostHandleæ˜¯æ­£åº
æ‹¦æˆªå™¨A.postHandle()  // å®é™…æ˜¯é€†åºï¼
æ‹¦æˆªå™¨B.postHandle()  // å®é™…æ˜¯é€†åºï¼

// æ­£ç¡®ç†è§£ï¼š
æ‹¦æˆªå™¨B.postHandle()  // å…ˆæ‰§è¡ŒB
æ‹¦æˆªå™¨A.postHandle()  // åæ‰§è¡ŒA
```

### 7.5 è®°å¿†æŠ€å·§


**ğŸ¯ æ ¸å¿ƒè®°å¿†**
```
æ‹¦æˆªå™¨åƒå®‰æ£€ç«™ï¼š
â€¢ preHandleæ˜¯è¿›é—¨æ£€æŸ¥ï¼ˆèƒ½æ‹¦æˆªï¼‰
â€¢ postHandleæ˜¯ä¸­é€”åŠ å·¥ï¼ˆä¸èƒ½æ‹¦æˆªï¼‰
â€¢ afterCompletionæ˜¯ç¦»å¼€æ¸…ç†ï¼ˆä¸€å®šæ‰§è¡Œï¼‰

æ‰§è¡Œé¡ºåºåƒç©¿è¡£æœï¼š
â€¢ preHandleæ­£ç€ç©¿ï¼ˆAâ†’Bâ†’Cï¼‰
â€¢ postHandleå€’ç€è„±ï¼ˆCâ†’Bâ†’Aï¼‰
â€¢ afterCompletionå€’ç€æ¸…ï¼ˆCâ†’Bâ†’Aï¼‰
```

**ğŸ”‘ å…³é”®è¯æ€»ç»“**
- **preHandle** = éªŒè¯ + æ”¾è¡Œ/ä¸­æ–­
- **postHandle** = åŠ å·¥ + è®°å½•
- **afterCompletion** = æ¸…ç† + å…œåº•
- **è¿”å›true** = ç»§ç»­èµ°
- **è¿”å›false** = åœä¸‹æ¥
- **å¼‚å¸¸å‘ç”Ÿ** = è·³è¿‡postHandleï¼Œæ‰§è¡ŒafterCompletion

---

**ğŸ’¡ å­¦ä¹ å»ºè®®**

æ–°æ‰‹å­¦ä¹ æ‹¦æˆªå™¨æ—¶ï¼š
1. å…ˆç†è§£ä¸‰ä¸ªæ–¹æ³•çš„**è°ƒç”¨æ—¶æœº**
2. è®°ä½**æ‰§è¡Œé¡ºåºè§„å¾‹**ï¼ˆæ­£åºã€é€†åºï¼‰
3. æŒæ¡**è¿”å›å€¼æ§åˆ¶**æœºåˆ¶ï¼ˆtrue/falseçš„å½±å“ï¼‰
4. ç†è§£**å¼‚å¸¸å¤„ç†**æµç¨‹ï¼ˆafterCompletionä¸€å®šæ‰§è¡Œï¼‰
5. é€šè¿‡**å®é™…æ¡ˆä¾‹**åŠ æ·±ç†è§£ï¼ˆç™»å½•ã€æƒé™ã€æ—¥å¿—ï¼‰

è®°ä½ï¼šæ‹¦æˆªå™¨å°±æ˜¯ç»™è¯·æ±‚åŠ ä¸Šå¤šé“æ£€æŸ¥å…³å¡ï¼Œæ¯é“å…³å¡éƒ½èƒ½å†³å®šæ˜¯å¦æ”¾è¡Œï¼