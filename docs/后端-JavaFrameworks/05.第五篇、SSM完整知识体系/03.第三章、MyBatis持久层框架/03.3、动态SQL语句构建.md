---
title: 3ã€åŠ¨æ€SQLè¯­å¥æ„å»º
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯åŠ¨æ€SQL](#1-ä»€ä¹ˆæ˜¯åŠ¨æ€sql)
2. [ifæ¡ä»¶åˆ¤æ–­](#2-ifæ¡ä»¶åˆ¤æ–­)
3. [chooseå¤šåˆ†æ”¯é€‰æ‹©](#3-chooseå¤šåˆ†æ”¯é€‰æ‹©)
4. [whereæ¡ä»¶æ„å»º](#4-whereæ¡ä»¶æ„å»º)
5. [setæ›´æ–°æ„å»º](#5-setæ›´æ–°æ„å»º)
6. [trimå­—ç¬¦ä¸²ä¿®å‰ª](#6-trimå­—ç¬¦ä¸²ä¿®å‰ª)
7. [foreachå¾ªç¯éå†](#7-foreachå¾ªç¯éå†)
8. [SQLç‰‡æ®µå¤ç”¨](#8-sqlç‰‡æ®µå¤ç”¨)
9. [é«˜çº§åŠ¨æ€SQLæŠ€å·§](#9-é«˜çº§åŠ¨æ€sqlæŠ€å·§)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯åŠ¨æ€SQL


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€SQL


**ç°å®åœºæ™¯ç†è§£**ï¼š
```
æƒ³è±¡ä½ åœ¨å¼€å‘ä¸€ä¸ªæœç´¢åŠŸèƒ½ï¼š
- ç”¨æˆ·å¯èƒ½åªè¾“å…¥å•†å“åç§°
- ç”¨æˆ·å¯èƒ½åªé€‰æ‹©ä»·æ ¼èŒƒå›´
- ç”¨æˆ·å¯èƒ½åŒæ—¶è®¾ç½®åç§°ã€ä»·æ ¼ã€åˆ†ç±»
- ç”šè‡³ç”¨æˆ·ä»€ä¹ˆéƒ½ä¸å¡«

è¿™æ—¶å€™SQLè¯­å¥æ€ä¹ˆå†™ï¼Ÿ
```

**ä¼ ç»Ÿåšæ³•çš„é—®é¢˜**ï¼š
```
âŒ æ–¹æ¡ˆ1ï¼šå†™æ­»æ‰€æœ‰æ¡ä»¶
SELECT * FROM product 
WHERE name = ? AND price BETWEEN ? AND ? AND category = ?
é—®é¢˜ï¼šç”¨æˆ·ä¸å¡«æŸä¸ªæ¡ä»¶å°±æŠ¥é”™

âŒ æ–¹æ¡ˆ2ï¼šJavaä»£ç æ‹¼æ¥SQL
String sql = "SELECT * FROM product WHERE 1=1";
if(name != null) sql += " AND name = '" + name + "'";
é—®é¢˜ï¼šå®¹æ˜“SQLæ³¨å…¥ã€ä»£ç æ··ä¹±
```

**åŠ¨æ€SQLçš„è§£å†³æ–¹æ¡ˆ**ï¼š
```
âœ… MyBatisåŠ¨æ€SQLï¼šæ ¹æ®æ¡ä»¶è‡ªåŠ¨æ‹¼æ¥
<select id="searchProduct" resultType="Product">
  SELECT * FROM product
  <where>
    <if test="name != null">
      AND name LIKE #{name}
    </if>
    <if test="minPrice != null">
      AND price >= #{minPrice}
    </if>
    <if test="category != null">
      AND category = #{category}
    </if>
  </where>
</select>

ä¼˜åŠ¿ï¼šå®‰å…¨ã€çµæ´»ã€ä»£ç æ¸…æ™°
```

### 1.2 åŠ¨æ€SQLçš„æœ¬è´¨


**æ ¸å¿ƒç†è§£**ï¼š
```
åŠ¨æ€SQL = XMLæ ‡ç­¾æ§åˆ¶ + SQLç‰‡æ®µç»„åˆ

å°±åƒæ­ç§¯æœ¨ï¼š
- XMLæ ‡ç­¾æ˜¯è§„åˆ™ï¼ˆä»€ä¹ˆæƒ…å†µä¸‹ç”¨å“ªå—ç§¯æœ¨ï¼‰
- SQLç‰‡æ®µæ˜¯ç§¯æœ¨å—ï¼ˆå„ç§SQLæ¡ä»¶ï¼‰
- MyBatisæ˜¯ç»„è£…å·¥ï¼ˆæŒ‰è§„åˆ™æŠŠç§¯æœ¨æ‹¼å¥½ï¼‰

æœ€ç»ˆç”Ÿæˆå®Œæ•´çš„SQLè¯­å¥
```

**å·¥ä½œæµç¨‹**ï¼š
```
ç”¨æˆ·è¯·æ±‚
    â†“
Javaä»£ç ä¼ å‚æ•°
    â†“
MyBatisè§£æXMLæ ‡ç­¾
    â†“
æ ¹æ®å‚æ•°åˆ¤æ–­æ¡ä»¶
    â†“
åŠ¨æ€æ‹¼æ¥SQLç‰‡æ®µ
    â†“
ç”Ÿæˆæœ€ç»ˆSQLè¯­å¥
    â†“
æ‰§è¡ŒæŸ¥è¯¢
```

---

## 2. ğŸ” ifæ¡ä»¶åˆ¤æ–­


### 2.1 åŸºæœ¬ç”¨æ³•


**ifæ ‡ç­¾çš„ä½œç”¨**ï¼š
> ğŸ’¡ **ç®€å•ç†è§£**ï¼š`<if>`å°±åƒJavaä¸­çš„`ifè¯­å¥`ï¼Œæ¡ä»¶æˆç«‹å°±æ‰§è¡Œé‡Œé¢çš„SQLç‰‡æ®µ

**åŸºç¡€è¯­æ³•**ï¼š
```xml
<if test="æ¡ä»¶è¡¨è¾¾å¼">
  SQLç‰‡æ®µ
</if>
```

**å®é™…æ¡ˆä¾‹**ï¼š
```xml
<!-- ç”¨æˆ·æœç´¢å•†å“ -->
<select id="searchProduct" resultType="Product">
  SELECT * FROM product
  WHERE 1=1
  <if test="name != null and name != ''">
    AND name LIKE CONCAT('%', #{name}, '%')
  </if>
  <if test="minPrice != null">
    AND price >= #{minPrice}
  </if>
  <if test="maxPrice != null">
    AND price <= #{maxPrice}
  </if>
</select>
```

### 2.2 testæ¡ä»¶è¡¨è¾¾å¼è¯¦è§£


**å¸¸ç”¨åˆ¤æ–­æ¡ä»¶**ï¼š

| åˆ¤æ–­ç±»å‹ | è¡¨è¾¾å¼å†™æ³• | è¯´æ˜ |
|---------|-----------|------|
| **éç©ºåˆ¤æ–­** | `test="name != null"` | åˆ¤æ–­å‚æ•°ä¸ä¸ºnull |
| **éç©ºå­—ç¬¦ä¸²** | `test="name != null and name != ''"` | æ—¢ä¸ä¸ºnullä¹Ÿä¸æ˜¯ç©ºä¸² |
| **æ•°å­—åˆ¤æ–­** | `test="age > 18"` | æ•°å€¼æ¯”è¾ƒ |
| **å¸ƒå°”åˆ¤æ–­** | `test="isVip == true"` | å¸ƒå°”å€¼åˆ¤æ–­ |
| **å¤šæ¡ä»¶** | `test="name != null and price > 0"` | å¤šä¸ªæ¡ä»¶ç»„åˆ |

**å¸¸è§å‘ç‚¹**ï¼š
```xml
<!-- âŒ é”™è¯¯ï¼šç›´æ¥åˆ¤æ–­ç©ºå­—ç¬¦ä¸² -->
<if test="name != ''">  
  <!-- nameä¸ºnullæ—¶ä¼šæŠ¥é”™ -->
</if>

<!-- âœ… æ­£ç¡®ï¼šå…ˆåˆ¤æ–­nullå†åˆ¤æ–­ç©ºä¸² -->
<if test="name != null and name != ''">
  <!-- å®‰å…¨çš„å†™æ³• -->
</if>
```

### 2.3 å®æˆ˜ç¤ºä¾‹


**åœºæ™¯ï¼šç”¨æˆ·æ³¨å†Œä¿¡æ¯æ›´æ–°**
```xml
<update id="updateUser" parameterType="User">
  UPDATE user
  <set>
    <!-- åªæ›´æ–°ä¼ å…¥çš„å­—æ®µ -->
    <if test="nickname != null">
      nickname = #{nickname},
    </if>
    <if test="email != null">
      email = #{email},
    </if>
    <if test="phone != null">
      phone = #{phone},
    </if>
    <!-- æ›´æ–°æ—¶é—´æ€»æ˜¯æ›´æ–° -->
    update_time = NOW()
  </set>
  WHERE id = #{id}
</update>
```

**æ•ˆæœæ¼”ç¤º**ï¼š
```
ä¼ å…¥å‚æ•°ï¼š{id: 1, nickname: "å°æ˜", email: null, phone: null}

ç”ŸæˆSQLï¼š
UPDATE user
SET nickname = ?, update_time = NOW()
WHERE id = ?

åªæ›´æ–°äº†nicknameï¼Œemailå’Œphoneå› ä¸ºä¸ºnullæ‰€ä»¥è¢«å¿½ç•¥
```

---

## 3. ğŸ”€ chooseå¤šåˆ†æ”¯é€‰æ‹©


### 3.1 chooseçš„ä½œç”¨


**å¯¹æ¯”ç†è§£**ï¼š
```
ifæ ‡ç­¾      = Javaçš„ifè¯­å¥ï¼ˆå¯ä»¥åŒæ—¶æ»¡è¶³å¤šä¸ªï¼‰
chooseæ ‡ç­¾  = Javaçš„if-else if-elseï¼ˆåªä¼šæ‰§è¡Œä¸€ä¸ªåˆ†æ”¯ï¼‰
```

**è¯­æ³•ç»“æ„**ï¼š
```xml
<choose>
  <when test="æ¡ä»¶1">SQLç‰‡æ®µ1</when>
  <when test="æ¡ä»¶2">SQLç‰‡æ®µ2</when>
  <when test="æ¡ä»¶3">SQLç‰‡æ®µ3</when>
  <otherwise>é»˜è®¤SQLç‰‡æ®µ</otherwise>
</choose>
```

### 3.2 å®æˆ˜åœºæ™¯ï¼šæ’åºè§„åˆ™


**éœ€æ±‚**ï¼šæ ¹æ®ç”¨æˆ·é€‰æ‹©çš„æ’åºæ–¹å¼æŸ¥è¯¢å•†å“
```xml
<select id="getProductList" resultType="Product">
  SELECT * FROM product
  WHERE status = 1
  <choose>
    <when test="sortType == 'price_asc'">
      ORDER BY price ASC
    </when>
    <when test="sortType == 'price_desc'">
      ORDER BY price DESC
    </when>
    <when test="sortType == 'sales'">
      ORDER BY sales DESC
    </when>
    <otherwise>
      ORDER BY create_time DESC
    </otherwise>
  </choose>
</select>
```

**æ‰§è¡Œé€»è¾‘**ï¼š
```
sortType = "price_asc"  â†’ æŒ‰ä»·æ ¼å‡åº
sortType = "price_desc" â†’ æŒ‰ä»·æ ¼é™åº
sortType = "sales"      â†’ æŒ‰é”€é‡æ’åº
sortType = null         â†’ é»˜è®¤æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼ˆotherwiseï¼‰
```

### 3.3 whenä¸otherwiseçš„åŒºåˆ«


**å…³é”®ç†è§£**ï¼š
```
when     = æ¡ä»¶åˆ†æ”¯ï¼Œå¯ä»¥æœ‰å¤šä¸ªï¼Œä»ä¸Šå¾€ä¸‹åŒ¹é…
otherwise = é»˜è®¤åˆ†æ”¯ï¼Œåªèƒ½æœ‰ä¸€ä¸ªï¼Œéƒ½ä¸æ»¡è¶³æ—¶æ‰§è¡Œ
```

**å®Œæ•´ç¤ºä¾‹**ï¼š
```xml
<!-- ä¼šå‘˜ç­‰çº§æŸ¥è¯¢æŠ˜æ‰£ -->
<select id="getDiscount" resultType="double">
  SELECT 
  <choose>
    <when test="vipLevel == 3">
      0.7 as discount  <!-- VIP3äº«å—7æŠ˜ -->
    </when>
    <when test="vipLevel == 2">
      0.8 as discount  <!-- VIP2äº«å—8æŠ˜ -->
    </when>
    <when test="vipLevel == 1">
      0.9 as discount  <!-- VIP1äº«å—9æŠ˜ -->
    </when>
    <otherwise>
      1.0 as discount  <!-- æ™®é€šç”¨æˆ·æ— æŠ˜æ‰£ -->
    </otherwise>
  </choose>
  FROM dual
</select>
```

---

## 4. ğŸ“ whereæ¡ä»¶æ„å»º


### 4.1 whereæ ‡ç­¾è§£å†³çš„é—®é¢˜


**ç—›ç‚¹åœºæ™¯**ï¼š
```xml
<!-- âŒ é—®é¢˜ä»£ç  -->
<select id="searchUser" resultType="User">
  SELECT * FROM user
  WHERE
  <if test="name != null">
    name = #{name}
  </if>
  <if test="age != null">
    AND age = #{age}
  </if>
</select>

é—®é¢˜1ï¼šå¦‚æœnameä¸ºnullï¼ŒSQLå˜æˆ "WHERE AND age = ?"ï¼ˆè¯­æ³•é”™è¯¯ï¼‰
é—®é¢˜2ï¼šå¦‚æœéƒ½ä¸ºnullï¼ŒSQLå˜æˆ "WHERE"ï¼ˆè¯­æ³•é”™è¯¯ï¼‰
```

**whereæ ‡ç­¾çš„ä½œç”¨**ï¼š
> ğŸ’¡ **æ™ºèƒ½å¤„ç†**ï¼š
> 1. è‡ªåŠ¨æ·»åŠ WHEREå…³é”®å­—ï¼ˆæœ‰æ¡ä»¶æ—¶ï¼‰
> 2. è‡ªåŠ¨å»é™¤å¤šä½™çš„AND/ORï¼ˆåœ¨å¼€å¤´æ—¶ï¼‰
> 3. æ²¡æœ‰æ¡ä»¶æ—¶ä¸æ·»åŠ WHERE

### 4.2 whereæ ‡ç­¾ä½¿ç”¨


**æ ‡å‡†å†™æ³•**ï¼š
```xml
<select id="searchUser" resultType="User">
  SELECT * FROM user
  <where>
    <if test="name != null">
      AND name = #{name}
    </if>
    <if test="age != null">
      AND age = #{age}
    </if>
    <if test="city != null">
      AND city = #{city}
    </if>
  </where>
</select>
```

**ç”ŸæˆSQLå¯¹æ¯”**ï¼š
```
å‚æ•°ï¼š{name: "å¼ ä¸‰", age: 25, city: null}
ç”Ÿæˆï¼šSELECT * FROM user WHERE name = ? AND age = ?
      âœ… è‡ªåŠ¨å»æ‰äº†ç¬¬ä¸€ä¸ªANDï¼Œcityæ¡ä»¶è¢«å¿½ç•¥

å‚æ•°ï¼š{name: null, age: null, city: null}  
ç”Ÿæˆï¼šSELECT * FROM user
      âœ… æ²¡æœ‰WHEREï¼Œé¿å…è¯­æ³•é”™è¯¯
```

### 4.3 å®æˆ˜æŠ€å·§


**æŠ€å·§1ï¼šç»Ÿä¸€ä½¿ç”¨ANDå¼€å¤´**
```xml
<where>
  <!-- ç»Ÿä¸€ç”¨ANDå¼€å¤´ï¼Œwhereæ ‡ç­¾ä¼šè‡ªåŠ¨å¤„ç† -->
  <if test="keyword != null">
    AND (name LIKE #{keyword} OR description LIKE #{keyword})
  </if>
  <if test="status != null">
    AND status = #{status}
  </if>
</where>
```

**æŠ€å·§2ï¼šå¤æ‚æ¡ä»¶åˆ†ç»„**
```xml
<where>
  <!-- å¿…é€‰æ¡ä»¶ -->
  AND deleted = 0
  
  <!-- å¯é€‰æ¡ä»¶ -->
  <if test="categoryId != null">
    AND category_id = #{categoryId}
  </if>
  
  <!-- æ—¥æœŸèŒƒå›´ -->
  <if test="startDate != null">
    AND create_time >= #{startDate}
  </if>
  <if test="endDate != null">
    AND create_time &lt;= #{endDate}
  </if>
</where>
```

---

## 5. âœï¸ setæ›´æ–°æ„å»º


### 5.1 setæ ‡ç­¾çš„ä½œç”¨


**æ›´æ–°åœºæ™¯çš„é—®é¢˜**ï¼š
```xml
<!-- âŒ é—®é¢˜ä»£ç  -->
<update id="updateUser">
  UPDATE user
  SET
  <if test="name != null">
    name = #{name},
  </if>
  <if test="age != null">
    age = #{age},
  </if>
  WHERE id = #{id}
</update>

é—®é¢˜ï¼šæœ€åä¸€ä¸ªé€—å·å¤šä½™ï¼Œå¯¼è‡´SQLé”™è¯¯
```

**setæ ‡ç­¾çš„æ™ºèƒ½å¤„ç†**ï¼š
> ğŸ’¡ **è‡ªåŠ¨ä¼˜åŒ–**ï¼š
> 1. è‡ªåŠ¨æ·»åŠ SETå…³é”®å­—
> 2. è‡ªåŠ¨å»é™¤å¤šä½™çš„é€—å·ï¼ˆåœ¨æœ«å°¾æ—¶ï¼‰
> 3. ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªå­—æ®µè¢«æ›´æ–°

### 5.2 æ ‡å‡†ç”¨æ³•


**åŸºç¡€ç¤ºä¾‹**ï¼š
```xml
<update id="updateUser" parameterType="User">
  UPDATE user
  <set>
    <if test="nickname != null">
      nickname = #{nickname},
    </if>
    <if test="email != null">
      email = #{email},
    </if>
    <if test="avatar != null">
      avatar = #{avatar},
    </if>
    <!-- æ›´æ–°æ—¶é—´æ€»æ˜¯æ›´æ–° -->
    update_time = NOW()
  </set>
  WHERE id = #{id}
</update>
```

**æ‰§è¡Œæ•ˆæœ**ï¼š
```
å‚æ•°ï¼š{id: 1, nickname: "æ–°æ˜µç§°", email: null, avatar: null}

ç”ŸæˆSQLï¼š
UPDATE user
SET nickname = ?, update_time = NOW()
WHERE id = ?

âœ… åªæ›´æ–°äº†ä¼ å…¥çš„å­—æ®µï¼Œè‡ªåŠ¨å»é™¤äº†å¤šä½™é€—å·
```

### 5.3 å®æˆ˜åœºæ™¯


**åœºæ™¯1ï¼šå•†å“ä¿¡æ¯æ›´æ–°**
```xml
<update id="updateProduct">
  UPDATE product
  <set>
    <if test="productName != null">
      product_name = #{productName},
    </if>
    <if test="price != null">
      price = #{price},
    </if>
    <if test="stock != null">
      stock = #{stock},
    </if>
    <if test="description != null">
      description = #{description},
    </if>
    update_time = NOW()
  </set>
  WHERE id = #{id}
</update>
```

**åœºæ™¯2ï¼šæ‰¹é‡å­—æ®µæ›´æ–°**
```xml
<update id="updateOrderStatus">
  UPDATE orders
  <set>
    status = #{newStatus},
    <if test="remark != null">
      remark = #{remark},
    </if>
    <if test="completeTime != null">
      complete_time = #{completeTime},
    </if>
    update_time = NOW()
  </set>
  WHERE id IN
  <foreach collection="orderIds" item="id" open="(" close=")" separator=",">
    #{id}
  </foreach>
</update>
```

---

## 6. âœ‚ï¸ trimå­—ç¬¦ä¸²ä¿®å‰ª


### 6.1 trimæ ‡ç­¾çš„å¨åŠ›


**trimæ˜¯ä»€ä¹ˆ**ï¼š
> ğŸ’¡ **ä¸‡èƒ½å·¥å…·**ï¼štrimæ˜¯whereå’Œsetçš„åº•å±‚å®ç°ï¼Œå¯ä»¥è‡ªå®šä¹‰å‰ç¼€ã€åç¼€çš„æ·»åŠ å’Œåˆ é™¤

**è¯­æ³•æ ¼å¼**ï¼š
```xml
<trim 
  prefix="å‰ç¼€"           <!-- æ·»åŠ çš„å‰ç¼€ -->
  suffix="åç¼€"           <!-- æ·»åŠ çš„åç¼€ -->
  prefixOverrides="å»é™¤çš„å‰ç¼€"  <!-- è¦åˆ é™¤çš„å‰ç¼€ -->
  suffixOverrides="å»é™¤çš„åç¼€"> <!-- è¦åˆ é™¤çš„åç¼€ -->
  SQLç‰‡æ®µ
</trim>
```

### 6.2 ç”¨trimå®ç°whereåŠŸèƒ½


**å¯¹æ¯”ç†è§£**ï¼š
```xml
<!-- ä½¿ç”¨whereæ ‡ç­¾ -->
<where>
  <if test="name != null">AND name = #{name}</if>
</where>

<!-- ç­‰ä»·çš„trimå†™æ³• -->
<trim prefix="WHERE" prefixOverrides="AND |OR ">
  <if test="name != null">AND name = #{name}</if>
</trim>

è¯´æ˜ï¼š
- prefix="WHERE"     â†’ æ·»åŠ WHEREå‰ç¼€
- prefixOverrides    â†’ å»æ‰å¼€å¤´çš„ANDæˆ–OR
```

### 6.3 ç”¨trimå®ç°setåŠŸèƒ½


**å¯¹æ¯”ç†è§£**ï¼š
```xml
<!-- ä½¿ç”¨setæ ‡ç­¾ -->
<set>
  <if test="name != null">name = #{name},</if>
</set>

<!-- ç­‰ä»·çš„trimå†™æ³• -->
<trim prefix="SET" suffixOverrides=",">
  <if test="name != null">name = #{name},</if>
</trim>

è¯´æ˜ï¼š
- prefix="SET"      â†’ æ·»åŠ SETå‰ç¼€
- suffixOverrides   â†’ å»æ‰ç»“å°¾çš„é€—å·
```

### 6.4 trimçš„é«˜çº§ç”¨æ³•


**åœºæ™¯ï¼šè‡ªå®šä¹‰INSERT**
```xml
<insert id="insertUser">
  INSERT INTO user
  <trim prefix="(" suffix=")" suffixOverrides=",">
    id,
    <if test="name != null">name,</if>
    <if test="age != null">age,</if>
    create_time,
  </trim>
  <trim prefix="VALUES(" suffix=")" suffixOverrides=",">
    #{id},
    <if test="name != null">#{name},</if>
    <if test="age != null">#{age},</if>
    NOW(),
  </trim>
</insert>
```

**æ•ˆæœ**ï¼š
```
å‚æ•°ï¼š{id: 1, name: "å¼ ä¸‰", age: null}

ç”ŸæˆSQLï¼š
INSERT INTO user (id, name, create_time) 
VALUES (?, ?, NOW())

âœ… è‡ªåŠ¨å»é™¤äº†å¤šä½™é€—å·ï¼Œçµæ´»æ’å…¥å­—æ®µ
```

---

## 7. ğŸ”„ foreachå¾ªç¯éå†


### 7.1 foreachè§£å†³çš„é—®é¢˜


**åœºæ™¯ç†è§£**ï¼š
```
éœ€æ±‚ï¼šæŸ¥è¯¢IDä¸º1ã€2ã€3ã€5ã€8çš„ç”¨æˆ·
ä¼ ç»Ÿå†™æ³•ï¼šWHERE id IN (1,2,3,5,8)

é—®é¢˜ï¼šIDæ•°é‡ä¸å›ºå®šæ€ä¹ˆåŠï¼Ÿ
```

**foreachçš„ä½œç”¨**ï¼š
> ğŸ’¡ **å¾ªç¯ç”ŸæˆSQL**ï¼šéå†é›†åˆ/æ•°ç»„ï¼Œè‡ªåŠ¨ç”ŸæˆSQLç‰‡æ®µ

**åŸºæœ¬è¯­æ³•**ï¼š
```xml
<foreach 
  collection="é›†åˆå‚æ•°å"    <!-- è¦éå†çš„é›†åˆ -->
  item="å…ƒç´ å˜é‡å"         <!-- å½“å‰å…ƒç´ çš„å˜é‡å -->
  open="å¼€å§‹ç¬¦å·"          <!-- å¼€å§‹ç¬¦å· -->
  close="ç»“æŸç¬¦å·"         <!-- ç»“æŸç¬¦å· -->
  separator="åˆ†éš”ç¬¦">      <!-- å…ƒç´ é—´åˆ†éš”ç¬¦ -->
  #{å…ƒç´ å˜é‡å}
</foreach>
```

### 7.2 INæŸ¥è¯¢ä½¿ç”¨


**åŸºç¡€ç¤ºä¾‹**ï¼š
```xml
<!-- æ‰¹é‡æŸ¥è¯¢ç”¨æˆ· -->
<select id="getUsersByIds" resultType="User">
  SELECT * FROM user
  WHERE id IN
  <foreach collection="ids" item="id" open="(" close=")" separator=",">
    #{id}
  </foreach>
</select>
```

**æ‰§è¡Œæ•ˆæœ**ï¼š
```
å‚æ•°ï¼šids = [1, 3, 5, 7]

ç”ŸæˆSQLï¼š
SELECT * FROM user
WHERE id IN (?, ?, ?, ?)

å®é™…å€¼ï¼š(1, 3, 5, 7)
```

### 7.3 æ‰¹é‡æ’å…¥


**é«˜æ•ˆæ‰¹é‡æ’å…¥**ï¼š
```xml
<insert id="batchInsert" parameterType="list">
  INSERT INTO user (name, age, email)
  VALUES
  <foreach collection="list" item="user" separator=",">
    (#{user.name}, #{user.age}, #{user.email})
  </foreach>
</insert>
```

**æ•ˆæœå¯¹æ¯”**ï¼š
```
ä¼ ç»Ÿæ–¹å¼ï¼šæ‰§è¡ŒNæ¬¡INSERT
INSERT INTO user VALUES (...)
INSERT INTO user VALUES (...)
INSERT INTO user VALUES (...)

foreachæ–¹å¼ï¼šä¸€æ¬¡æ€§æ’å…¥
INSERT INTO user VALUES 
  ('å¼ ä¸‰', 20, 'a@qq.com'),
  ('æå››', 22, 'b@qq.com'),
  ('ç‹äº”', 25, 'c@qq.com')

âœ… æ€§èƒ½æå‡10å€ä»¥ä¸Š
```

### 7.4 æ‰¹é‡æ›´æ–°


**åœºæ™¯ï¼šæ‰¹é‡ä¿®æ”¹çŠ¶æ€**
```xml
<update id="batchUpdateStatus">
  <foreach collection="list" item="item" separator=";">
    UPDATE user
    SET status = #{item.status}
    WHERE id = #{item.id}
  </foreach>
</update>
```

### 7.5 collectionå‚æ•°è¯´æ˜


**å‚æ•°ç±»å‹ä¸åç§°å¯¹åº”**ï¼š

| å‚æ•°ç±»å‹ | collectionå€¼ | è¯´æ˜ |
|---------|-------------|------|
| **List** | `list` æˆ– å‚æ•°å | åˆ—è¡¨é›†åˆ |
| **Array** | `array` æˆ– å‚æ•°å | æ•°ç»„ |
| **Map** | `mapçš„key` | Mapä¸­çš„æŸä¸ªå€¼ |
| **@Param** | `æ³¨è§£æŒ‡å®šçš„åç§°` | ä½¿ç”¨@Paramæ³¨è§£ |

**ç¤ºä¾‹**ï¼š
```java
// æ–¹å¼1ï¼šç›´æ¥ä¼ List
List<Integer> getUsersByIds(List<Integer> ids);
// XML: collection="list"

// æ–¹å¼2ï¼šä½¿ç”¨@Paramæ³¨è§£
List<User> getUsersByIds(@Param("userIds") List<Integer> ids);
// XML: collection="userIds"

// æ–¹å¼3ï¼šä¼ æ•°ç»„
List<User> getUsersByIds(Integer[] ids);
// XML: collection="array"
```

---

## 8. ğŸ§© SQLç‰‡æ®µå¤ç”¨


### 8.1 ä¸ºä»€ä¹ˆéœ€è¦SQLç‰‡æ®µ


**é‡å¤ä»£ç çš„ç—›ç‚¹**ï¼š
```xml
<!-- æŸ¥è¯¢1 -->
<select id="getUserList">
  SELECT id, username, nickname, email, phone, status 
  FROM user WHERE ...
</select>

<!-- æŸ¥è¯¢2 -->
<select id="getUserById">
  SELECT id, username, nickname, email, phone, status 
  FROM user WHERE id = #{id}
</select>

<!-- æŸ¥è¯¢3 -->  
<select id="searchUser">
  SELECT id, username, nickname, email, phone, status 
  FROM user WHERE ...
</select>

âŒ å­—æ®µåˆ—è¡¨é‡å¤äº†3æ¬¡ï¼Œç»´æŠ¤å›°éš¾
```

### 8.2 sqlæ ‡ç­¾å®šä¹‰ç‰‡æ®µ


**å®šä¹‰å¯å¤ç”¨ç‰‡æ®µ**ï¼š
```xml
<!-- å®šä¹‰SQLç‰‡æ®µ -->
<sql id="userColumns">
  id, username, nickname, email, phone, status, create_time
</sql>

<sql id="userTable">
  user
</sql>

<sql id="baseCondition">
  <where>
    <if test="status != null">
      AND status = #{status}
    </if>
    <if test="keyword != null">
      AND (username LIKE #{keyword} OR nickname LIKE #{keyword})
    </if>
  </where>
</sql>
```

### 8.3 includeå¼•ç”¨ç‰‡æ®µ


**ä½¿ç”¨SQLç‰‡æ®µ**ï¼š
```xml
<!-- æŸ¥è¯¢1ï¼šä½¿ç”¨ç‰‡æ®µ -->
<select id="getUserList" resultType="User">
  SELECT <include refid="userColumns"/>
  FROM <include refid="userTable"/>
  <include refid="baseCondition"/>
  ORDER BY create_time DESC
</select>

<!-- æŸ¥è¯¢2ï¼šä½¿ç”¨ç‰‡æ®µ -->
<select id="getUserById" resultType="User">
  SELECT <include refid="userColumns"/>
  FROM <include refid="userTable"/>
  WHERE id = #{id}
</select>

<!-- æŸ¥è¯¢3ï¼šä½¿ç”¨ç‰‡æ®µ -->
<select id="searchUser" resultType="User">
  SELECT <include refid="userColumns"/>
  FROM <include refid="userTable"/>
  <include refid="baseCondition"/>
  LIMIT #{offset}, #{limit}
</select>
```

**ä¼˜åŠ¿æ€»ç»“**ï¼š
```
âœ… å‡å°‘é‡å¤ä»£ç 
âœ… ç»Ÿä¸€ç»´æŠ¤ï¼Œä¿®æ”¹ä¸€å¤„å…¨éƒ¨ç”Ÿæ•ˆ
âœ… ä»£ç æ›´æ¸…æ™°ï¼Œå¯è¯»æ€§æ›´å¥½
âœ… é™ä½å‡ºé”™æ¦‚ç‡
```

### 8.4 ç‰‡æ®µä¼ å‚æŠ€å·§


**åŠ¨æ€SQLç‰‡æ®µ**ï¼š
```xml
<!-- å®šä¹‰å¸¦å‚æ•°çš„ç‰‡æ®µ -->
<sql id="orderBy">
  ORDER BY ${orderColumn} ${orderType}
</sql>

<!-- ä½¿ç”¨æ—¶ä¼ å‚ -->
<select id="getUserList" resultType="User">
  SELECT * FROM user
  <include refid="orderBy">
    <property name="orderColumn" value="create_time"/>
    <property name="orderType" value="DESC"/>
  </include>
</select>
```

---

## 9. ğŸš€ é«˜çº§åŠ¨æ€SQLæŠ€å·§


### 9.1 bindå˜é‡ç»‘å®š


**bindçš„ä½œç”¨**ï¼š
> ğŸ’¡ **åˆ›å»ºä¸´æ—¶å˜é‡**ï¼šåœ¨SQLä¸­å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œç”¨äºå¤æ‚è¡¨è¾¾å¼æˆ–æ¨¡ç³ŠæŸ¥è¯¢

**æ¨¡ç³ŠæŸ¥è¯¢ä¼˜åŒ–**ï¼š
```xml
<!-- ä¼ ç»Ÿå†™æ³•ï¼šåœ¨Javaä¸­æ‹¼æ¥ -->
<select id="searchUser" resultType="User">
  SELECT * FROM user
  WHERE name LIKE #{namePattern}  
  <!-- Javaä¼ å‚ï¼šnamePattern = "%" + name + "%" -->
</select>

<!-- bindä¼˜åŒ–å†™æ³•ï¼šåœ¨SQLä¸­æ‹¼æ¥ -->
<select id="searchUser" resultType="User">
  <bind name="namePattern" value="'%' + name + '%'"/>
  SELECT * FROM user
  WHERE name LIKE #{namePattern}
  <!-- Javaä¼ å‚ï¼šname = "å¼ ä¸‰" -->
</select>
```

**å¤æ‚è¡¨è¾¾å¼**ï¼š
```xml
<select id="getUserScore" resultType="User">
  <bind name="passScore" value="60"/>
  <bind name="excellentScore" value="90"/>
  
  SELECT *,
  <choose>
    <when test="score >= excellentScore">
      'ä¼˜ç§€' as level
    </when>
    <when test="score >= passScore">
      'åŠæ ¼' as level
    </when>
    <otherwise>
      'ä¸åŠæ ¼' as level
    </otherwise>
  </choose>
  FROM student
  WHERE id = #{id}
</select>
```

### 9.2 åŠ¨æ€è¡¨åå¤„ç†


**åœºæ™¯ï¼šåˆ†è¡¨æŸ¥è¯¢**
```xml
<!-- æŒ‰æœˆä»½æŸ¥è¯¢è®¢å• -->
<select id="getOrdersByMonth" resultType="Order">
  SELECT * FROM order_${month}
  WHERE user_id = #{userId}
</select>

<!-- Javaè°ƒç”¨ -->
// month = "202309"
// ç”ŸæˆSQLï¼šSELECT * FROM order_202309 WHERE user_id = ?
```

> âš ï¸ **æ³¨æ„**ï¼š
> - ä½¿ç”¨`${}`ä¸æ˜¯`#{}`
> - `${}`æ˜¯å­—ç¬¦ä¸²æ›¿æ¢ï¼Œæœ‰SQLæ³¨å…¥é£é™©
> - åªèƒ½ç”¨äºè¡¨åã€åˆ—åç­‰æ— æ³•ç”¨`#{}`çš„åœ°æ–¹
> - å¿…é¡»ä¸¥æ ¼æ ¡éªŒå‚æ•°å€¼

**å®‰å…¨åšæ³•**ï¼š
```java
// Javaä»£ç ä¸­æ ¡éªŒ
public List<Order> getOrdersByMonth(String month) {
    // ä¸¥æ ¼æ ¡éªŒæ ¼å¼
    if (!month.matches("^\\d{6}$")) {
        throw new IllegalArgumentException("æœˆä»½æ ¼å¼é”™è¯¯");
    }
    return orderMapper.getOrdersByMonth(month);
}
```

### 9.3 åŠ¨æ€æ’åºå¤„ç†


**å¤šå­—æ®µåŠ¨æ€æ’åº**ï¼š
```xml
<select id="getUserList" resultType="User">
  SELECT * FROM user
  <where>
    <if test="status != null">
      AND status = #{status}
    </if>
  </where>
  <if test="sortFields != null and sortFields.size() > 0">
    ORDER BY
    <foreach collection="sortFields" item="field" separator=",">
      ${field.column} ${field.direction}
    </foreach>
  </if>
</select>
```

**Javaè°ƒç”¨ç¤ºä¾‹**ï¼š
```java
// å®šä¹‰æ’åºå­—æ®µ
List<SortField> sortFields = Arrays.asList(
    new SortField("age", "DESC"),
    new SortField("create_time", "ASC")
);

// ç”ŸæˆSQL
SELECT * FROM user
ORDER BY age DESC, create_time ASC
```

### 9.4 å¤æ‚æ¡ä»¶ç»„åˆ


**ORæ¡ä»¶ç»„åˆ**ï¼š
```xml
<select id="complexSearch" resultType="Product">
  SELECT * FROM product
  <where>
    <!-- å¿…é¡»æ»¡è¶³çš„æ¡ä»¶ -->
    AND status = 1
    
    <!-- å¤æ‚ORæ¡ä»¶ -->
    <if test="keyword != null">
      AND (
        name LIKE CONCAT('%', #{keyword}, '%')
        OR description LIKE CONCAT('%', #{keyword}, '%')
        OR brand LIKE CONCAT('%', #{keyword}, '%')
      )
    </if>
    
    <!-- ä»·æ ¼æˆ–æŠ˜æ‰£æ¡ä»¶ï¼ˆæ»¡è¶³ä¸€ä¸ªå³å¯ï¼‰ -->
    <if test="filterType != null">
      AND (
        <choose>
          <when test="filterType == 'lowPrice'">
            price &lt; 100
          </when>
          <when test="filterType == 'onSale'">
            discount > 0
          </when>
          <when test="filterType == 'new'">
            DATEDIFF(NOW(), create_time) &lt;= 7
          </when>
        </choose>
      )
    </if>
  </where>
  ORDER BY sales DESC
</select>
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 åŠ¨æ€SQLæ ‡ç­¾é€ŸæŸ¥


| æ ‡ç­¾ | ä½œç”¨ | ä½¿ç”¨åœºæ™¯ | æ ¸å¿ƒè¦ç‚¹ |
|------|------|---------|---------|
| **if** | æ¡ä»¶åˆ¤æ–­ | å•ä¸ªæ¡ä»¶æ‹¼æ¥ | `test`è¡¨è¾¾å¼ï¼Œæ³¨æ„nullåˆ¤æ–­ |
| **choose** | å¤šåˆ†æ”¯é€‰æ‹© | ç±»ä¼¼switch | åªæ‰§è¡Œä¸€ä¸ªåˆ†æ”¯ |
| **where** | æ™ºèƒ½WHERE | åŠ¨æ€æ¡ä»¶æŸ¥è¯¢ | è‡ªåŠ¨å»AND/OR |
| **set** | æ™ºèƒ½SET | åŠ¨æ€å­—æ®µæ›´æ–° | è‡ªåŠ¨å»é€—å· |
| **trim** | å­—ç¬¦ä¸²å¤„ç† | è‡ªå®šä¹‰æ‹¼æ¥ | çµæ´»ä½†å¤æ‚ |
| **foreach** | å¾ªç¯éå† | æ‰¹é‡æ“ä½œ | INæŸ¥è¯¢ã€æ‰¹é‡æ’å…¥ |
| **sql** | ç‰‡æ®µå®šä¹‰ | ä»£ç å¤ç”¨ | å‡å°‘é‡å¤ |
| **include** | ç‰‡æ®µå¼•ç”¨ | å¼•ç”¨sqlç‰‡æ®µ | refidæŒ‡å®šç‰‡æ®µ |
| **bind** | å˜é‡ç»‘å®š | åˆ›å»ºä¸´æ—¶å˜é‡ | æ¨¡ç³ŠæŸ¥è¯¢ä¼˜åŒ– |

### 10.2 æœ€ä½³å®è·µå»ºè®®


**å®è·µ1ï¼šå‚æ•°æ ¡éªŒ**
```
âœ… å…ˆåˆ¤æ–­nullå†åˆ¤æ–­ç©ºä¸²
âœ… æ•°å­—ç±»å‹åˆ¤æ–­å¤§å°å…³ç³»
âœ… é›†åˆåˆ¤æ–­size > 0
âŒ ä¸è¦ç›´æ¥åˆ¤æ–­ç©ºä¸²
```

**å®è·µ2ï¼šå®‰å…¨ä½¿ç”¨**
```
âœ… ä¼˜å…ˆä½¿ç”¨#{} (é¢„ç¼–è¯‘ï¼Œé˜²SQLæ³¨å…¥)
âŒ è°¨æ…ä½¿ç”¨${} (å­—ç¬¦ä¸²æ›¿æ¢ï¼Œæœ‰æ³¨å…¥é£é™©)
âœ… ${}åªç”¨äºè¡¨åã€åˆ—åã€ORDER BY
âœ… ä½¿ç”¨${}æ—¶å¿…é¡»æ ¡éªŒå‚æ•°
```

**å®è·µ3ï¼šä»£ç ä¼˜åŒ–**
```
âœ… æå–å…¬å…±SQLç‰‡æ®µ
âœ… å¤æ‚æ¡ä»¶åˆ†ç»„ç¼–å†™
âœ… åˆç†ä½¿ç”¨chooseæ›¿ä»£å¤šä¸ªif
âœ… foreachæ‰¹é‡æ“ä½œæå‡æ€§èƒ½
```

### 10.3 å¸¸è§é—®é¢˜è§£å†³


**é—®é¢˜1ï¼šWHEREåé¢å¤šäº†AND**
```xml
<!-- âŒ é”™è¯¯å†™æ³• -->
WHERE
<if test="name != null">name = #{name}</if>

<!-- âœ… æ­£ç¡®å†™æ³• -->
<where>
  <if test="name != null">AND name = #{name}</if>
</where>
```

**é—®é¢˜2ï¼šSETæœ€åå¤šäº†é€—å·**
```xml
<!-- âŒ é”™è¯¯å†™æ³• -->
SET
<if test="name != null">name = #{name},</if>

<!-- âœ… æ­£ç¡®å†™æ³• -->
<set>
  <if test="name != null">name = #{name},</if>
</set>
```

**é—®é¢˜3ï¼šforeaché›†åˆä¸ºç©º**
```xml
<!-- âœ… åŠ åˆ¤æ–­ -->
<if test="ids != null and ids.size() > 0">
  WHERE id IN
  <foreach collection="ids" item="id" open="(" close=")" separator=",">
    #{id}
  </foreach>
</if>
```

### 10.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ¯ æ–°æ‰‹å…¥é—¨é¡ºåº**ï¼š
```
1ï¸âƒ£ æŒæ¡ifåŸºæœ¬ç”¨æ³•
2ï¸âƒ£ å­¦ä¹ whereå’Œsetæ ‡ç­¾
3ï¸âƒ£ ç†è§£foreachå¾ªç¯
4ï¸âƒ£ ä½¿ç”¨sqlç‰‡æ®µå¤ç”¨
5ï¸âƒ£ è¿›é˜¶chooseå’Œtrim
6ï¸âƒ£ å®æˆ˜åŠ¨æ€è¡¨åå’Œæ’åº
```

**ğŸ’¡ è®°å¿†å£è¯€**ï¼š
```
ifåˆ¤æ–­æ¡ä»¶è¦å†™test
whereå’Œsetæ™ºèƒ½å»é¦–å°¾
chooseåˆ†æ”¯åªé€‰ä¸€ä¸ªèµ°
foreachå¾ªç¯æ‰¹é‡æ“ä½œç‰›
sqlç‰‡æ®µincludeæ¥å¤ç”¨
trimçµæ´»ä½†è¦æƒ³æ¸…æ¥š
```

**ğŸ”¥ å®æˆ˜å»ºè®®**ï¼š
- ä»ç®€å•çš„æŸ¥è¯¢æ¡ä»¶å¼€å§‹ç»ƒä¹ 
- é€æ­¥å¢åŠ æ¡ä»¶å¤æ‚åº¦
- å¤šå†™æ‰¹é‡æ“ä½œæå‡æ€§èƒ½
- é‡è§†ä»£ç å¤ç”¨å’Œç»´æŠ¤æ€§
- æ³¨æ„SQLå®‰å…¨å’Œå‚æ•°æ ¡éªŒ

---

> ğŸ“Œ **æ ¸å¿ƒç†å¿µ**ï¼šåŠ¨æ€SQLæ˜¯MyBatisçš„ç²¾é«“ï¼ŒæŒæ¡å®ƒå°±æŒæ¡äº†çµæ´»æ„å»ºSQLçš„èƒ½åŠ›ã€‚ä»ç®€å•çš„ifå¼€å§‹ï¼Œé€æ­¥è¿‡æ¸¡åˆ°å¤æ‚çš„ç»„åˆä½¿ç”¨ï¼Œå¤šå†™å¤šç»ƒæ‰èƒ½ç†Ÿèƒ½ç”Ÿå·§ï¼