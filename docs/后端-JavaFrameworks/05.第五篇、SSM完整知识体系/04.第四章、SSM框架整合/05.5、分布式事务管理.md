---
title: 5ã€åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [äº‹åŠ¡ç®¡ç†åŸºç¡€æ¦‚å¿µ](#1-äº‹åŠ¡ç®¡ç†åŸºç¡€æ¦‚å¿µ)
2. [å£°æ˜å¼äº‹åŠ¡é…ç½®](#2-å£°æ˜å¼äº‹åŠ¡é…ç½®)
3. [äº‹åŠ¡ç®¡ç†å™¨é…ç½®è¯¦è§£](#3-äº‹åŠ¡ç®¡ç†å™¨é…ç½®è¯¦è§£)
4. [äº‹åŠ¡ä¼ æ’­è¡Œä¸ºåº”ç”¨](#4-äº‹åŠ¡ä¼ æ’­è¡Œä¸ºåº”ç”¨)
5. [äº‹åŠ¡éš”ç¦»çº§åˆ«è®¾ç½®](#5-äº‹åŠ¡éš”ç¦»çº§åˆ«è®¾ç½®)
6. [äº‹åŠ¡å›æ»šç­–ç•¥](#6-äº‹åŠ¡å›æ»šç­–ç•¥)
7. [åªè¯»äº‹åŠ¡ä¼˜åŒ–](#7-åªè¯»äº‹åŠ¡ä¼˜åŒ–)
8. [äº‹åŠ¡è¶…æ—¶è®¾ç½®](#8-äº‹åŠ¡è¶…æ—¶è®¾ç½®)
9. [äº‹åŠ¡å¤±æ•ˆåœºæ™¯åˆ†æ](#9-äº‹åŠ¡å¤±æ•ˆåœºæ™¯åˆ†æ)
10. [äº‹åŠ¡åµŒå¥—å¤„ç†](#10-äº‹åŠ¡åµŒå¥—å¤„ç†)
11. [åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†](#11-åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ’¡ äº‹åŠ¡ç®¡ç†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Ÿ


**ğŸ  ç”Ÿæ´»ä¸­çš„ä¾‹å­**
> æƒ³è±¡ä½ åœ¨é“¶è¡Œè½¬è´¦ï¼šä»ä½ çš„è´¦æˆ·æ‰£500å…ƒï¼Œç»™æœ‹å‹è´¦æˆ·åŠ 500å…ƒã€‚è¿™ä¸¤ä¸ªæ“ä½œå¿…é¡»è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½ä¸åšï¼Œä¸èƒ½åªæ‰£äº†é’±ä½†æ²¡ç»™æœ‹å‹åŠ ä¸Šï¼Œè¿™å°±æ˜¯äº‹åŠ¡çš„æ¦‚å¿µã€‚

**ğŸ“– äº‹åŠ¡çš„æ­£å¼å®šä¹‰**
```
äº‹åŠ¡ï¼ˆTransactionï¼‰ï¼šä¸€ç»„è¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œçš„æ•°æ®åº“æ“ä½œ
å°±åƒä¸€ä¸ª"åŒ…è£¹"ï¼Œé‡Œé¢çš„æ“ä½œæ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œä¸èƒ½æ‹†å¼€
```

**ğŸ¯ äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼ˆACIDï¼‰**

| ç‰¹æ€§ | è‹±æ–‡ | é€šä¿—è§£é‡Š | ç”Ÿæ´»ä¾‹å­ |
|------|------|----------|----------|
| **åŸå­æ€§** | Atomicity | å…¨åšæˆ–å…¨ä¸åšï¼Œä¸èƒ½åšä¸€åŠ | è½¬è´¦ï¼šæ‰£é’±å’ŒåŠ é’±å¿…é¡»åŒæ—¶æˆåŠŸ |
| **ä¸€è‡´æ€§** | Consistency | æ•°æ®ä»ä¸€ä¸ªæ­£ç¡®çŠ¶æ€åˆ°å¦ä¸€ä¸ªæ­£ç¡®çŠ¶æ€ | è½¬è´¦å‰åæ€»é‡‘é¢ä¸å˜ |
| **éš”ç¦»æ€§** | Isolation | å¤šä¸ªäº‹åŠ¡äº’ä¸å¹²æ‰° | ä½ è½¬è´¦æ—¶åˆ«äººçœ‹ä¸åˆ°ä¸­é—´çŠ¶æ€ |
| **æŒä¹…æ€§** | Durability | ä¸€æ—¦æˆåŠŸå°±æ°¸ä¹…ä¿å­˜ | è½¬è´¦æˆåŠŸåæ–­ç”µä¹Ÿä¸ä¼šä¸¢å¤± |

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡ç®¡ç†ï¼Ÿ


**âŒ æ²¡æœ‰äº‹åŠ¡ç®¡ç†çš„é—®é¢˜**
```
åœºæ™¯ï¼šç”¨æˆ·ä¸‹å•ä¹°å•†å“
æ­¥éª¤1ï¼šæ‰£å‡åº“å­˜ âœ“
æ­¥éª¤2ï¼šåˆ›å»ºè®¢å• âœ— (æ•°æ®åº“çªç„¶æ–­å¼€)
æ­¥éª¤3ï¼šæ‰£å‡ç”¨æˆ·ä½™é¢ (è¿˜æ²¡æ‰§è¡Œ)

ç»“æœï¼šåº“å­˜å‡å°‘äº†ï¼Œä½†è®¢å•æ²¡åˆ›å»ºï¼Œç”¨æˆ·é’±ä¹Ÿæ²¡æ‰£
è¿™å°±ä¹±å¥—äº†ï¼
```

**âœ… æœ‰äº‹åŠ¡ç®¡ç†çš„æ•ˆæœ**
```
åœºæ™¯ï¼šç”¨æˆ·ä¸‹å•ä¹°å•†å“ï¼ˆåŠ ä¸Šäº‹åŠ¡ï¼‰
æ­¥éª¤1ï¼šå¼€å§‹äº‹åŠ¡
æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜
æ­¥éª¤3ï¼šåˆ›å»ºè®¢å• (å¤±è´¥äº†)
æ­¥éª¤4ï¼šäº‹åŠ¡å›æ»šï¼Œåº“å­˜æ¢å¤åŸçŠ¶

ç»“æœï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿ
æ•°æ®æ°¸è¿œæ˜¯æ­£ç¡®çš„ï¼
```

### 1.3 Springä¸­çš„äº‹åŠ¡ç®¡ç†æ–¹å¼


**ä¸¤ç§ç®¡ç†æ–¹å¼å¯¹æ¯”**

```
ç¼–ç¨‹å¼äº‹åŠ¡ï¼ˆæ‰‹åŠ¨ç®¡ç†ï¼‰              å£°æ˜å¼äº‹åŠ¡ï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰
     â†“                                    â†“
æ‰‹åŠ¨å¼€å¯äº‹åŠ¡                        åŠ ä¸ª@Transactionalæ³¨è§£
try {                              @Transactional
  æ‰§è¡Œä¸šåŠ¡é€»è¾‘                       public void transfer() {
  æ‰‹åŠ¨æäº¤                             æ‰£é’±();
} catch {                              åŠ é’±();
  æ‰‹åŠ¨å›æ»š                           }
}                                  Springè‡ªåŠ¨ç®¡ç†äº‹åŠ¡
     â†“                                    â†“
  éº»çƒ¦ä½†çµæ´»                          ç®€å•ä½†å¤Ÿç”¨
```

**ğŸ¯ æ¨èæ–¹æ¡ˆ**
- **99%çš„åœºæ™¯**ï¼šç”¨å£°æ˜å¼äº‹åŠ¡ï¼ˆ@Transactionalæ³¨è§£ï¼‰
- **ç‰¹æ®Šåœºæ™¯**ï¼šéœ€è¦ç²¾ç»†æ§åˆ¶æ—¶æ‰ç”¨ç¼–ç¨‹å¼

---

## 2. âš™ï¸ å£°æ˜å¼äº‹åŠ¡é…ç½®


### 2.1 å£°æ˜å¼äº‹åŠ¡çš„æ ¸å¿ƒåŸç†


**ğŸ” å®ƒæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ**
```
æ²¡æœ‰äº‹åŠ¡æ—¶çš„è°ƒç”¨ï¼š
Controller â†’ Service.transfer()

æœ‰@Transactionalåï¼š
Controller â†’ äº‹åŠ¡ä»£ç† â†’ Service.transfer()
                â†“
         å¼€å¯äº‹åŠ¡ â†’ æ‰§è¡Œæ–¹æ³• â†’ æäº¤/å›æ»š
```

> ğŸ’¡ **å…³é”®ç†è§£**ï¼šSpringä¼šä¸ºä½ çš„Serviceç±»åˆ›å»ºä¸€ä¸ª"ä»£ç†å¯¹è±¡"ï¼Œè¿™ä¸ªä»£ç†å¯¹è±¡åœ¨è°ƒç”¨ä½ çš„æ–¹æ³•å‰åè‡ªåŠ¨ç®¡ç†äº‹åŠ¡

### 2.2 åŸºäºæ³¨è§£çš„é…ç½®ï¼ˆæœ€å¸¸ç”¨ï¼‰


**ğŸ“ ç¬¬ä¸€æ­¥ï¼šå¼€å¯äº‹åŠ¡ç®¡ç†**

```java
// Springé…ç½®ç±»
@Configuration
@EnableTransactionManagement  // å°±è¿™ä¸€ä¸ªæ³¨è§£ï¼Œå¼€å¯äº‹åŠ¡åŠŸèƒ½
public class TransactionConfig {
    
    // é…ç½®äº‹åŠ¡ç®¡ç†å™¨ï¼ˆåé¢è¯¦ç»†è®²ï¼‰
    @Bean
    public PlatformTransactionManager transactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

**ğŸ“ ç¬¬äºŒæ­¥ï¼šåœ¨Serviceæ–¹æ³•ä¸ŠåŠ æ³¨è§£**

```java
@Service
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private StockMapper stockMapper;
    
    // å°±è¿™ä¸€ä¸ªæ³¨è§£ï¼Œè¿™ä¸ªæ–¹æ³•å°±æœ‰äº‹åŠ¡äº†ï¼
    @Transactional
    public void createOrder(Order order) {
        // 1. æ‰£å‡åº“å­˜
        stockMapper.reduceStock(order.getProductId(), order.getQuantity());
        
        // 2. åˆ›å»ºè®¢å•
        orderMapper.insert(order);
        
        // å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œéƒ½ä¼šè‡ªåŠ¨å›æ»š
    }
}
```

### 2.3 åŸºäºXMLçš„é…ç½®ï¼ˆäº†è§£å³å¯ï¼‰


**ğŸ“‹ é€‚ç”¨åœºæ™¯**ï¼šè€é¡¹ç›®æˆ–éœ€è¦ç»Ÿä¸€é…ç½®æ—¶

```xml
<!-- Springé…ç½®æ–‡ä»¶ -->
<beans>
    <!-- é…ç½®äº‹åŠ¡ç®¡ç†å™¨ -->
    <bean id="transactionManager" 
          class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    
    <!-- å¼€å¯æ³¨è§£äº‹åŠ¡ -->
    <tx:annotation-driven transaction-manager="transactionManager"/>
    
    <!-- æˆ–è€…é…ç½®AOPåˆ‡é¢ï¼ˆæ›´çµæ´»ï¼‰ -->
    <tx:advice id="txAdvice" transaction-manager="transactionManager">
        <tx:attributes>
            <tx:method name="create*" propagation="REQUIRED"/>
            <tx:method name="update*" propagation="REQUIRED"/>
            <tx:method name="delete*" propagation="REQUIRED"/>
            <tx:method name="get*" propagation="SUPPORTS" read-only="true"/>
        </tx:attributes>
    </tx:advice>
</beans>
```

### 2.4 æ³¨è§£ä½ç½®çš„é€‰æ‹©


**ğŸ¯ @Transactionalå¯ä»¥æ”¾åœ¨å“ªé‡Œï¼Ÿ**

| ä½ç½® | æ•ˆæœ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **ç±»ä¸Š** | ç±»ä¸­æ‰€æœ‰publicæ–¹æ³•éƒ½æœ‰äº‹åŠ¡ | æ•´ä¸ªServiceéƒ½éœ€è¦äº‹åŠ¡ |
| **æ–¹æ³•ä¸Š** | åªæœ‰è¿™ä¸ªæ–¹æ³•æœ‰äº‹åŠ¡ | ä¸ªåˆ«æ–¹æ³•éœ€è¦ç‰¹æ®Šé…ç½® |
| **æ¥å£ä¸Š** | ä¸æ¨èï¼Œå¯èƒ½å¤±æ•ˆ | å°½é‡é¿å… |

```java
// æ¨èåšæ³•ï¼šç±»ä¸ŠåŠ é»˜è®¤é…ç½®ï¼Œç‰¹æ®Šæ–¹æ³•å•ç‹¬é…ç½®
@Service
@Transactional(readOnly = true)  // é»˜è®¤åªè¯»äº‹åŠ¡
public class UserService {
    
    // æŸ¥è¯¢æ–¹æ³•ï¼Œç”¨ç±»ä¸Šçš„åªè¯»äº‹åŠ¡
    public User getById(Long id) {
        return userMapper.selectById(id);
    }
    
    // ä¿®æ”¹æ–¹æ³•ï¼Œè¦†ç›–ç±»ä¸Šçš„é…ç½®
    @Transactional(readOnly = false)
    public void updateUser(User user) {
        userMapper.updateById(user);
    }
}
```

---

## 3. ğŸ”§ äº‹åŠ¡ç®¡ç†å™¨é…ç½®è¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ç®¡ç†å™¨ï¼Ÿ


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> äº‹åŠ¡ç®¡ç†å™¨å°±åƒä¸€ä¸ª"äº¤é€šè­¦å¯Ÿ"ï¼Œè´Ÿè´£æŒ‡æŒ¥æ•°æ®åº“æ“ä½œä»€ä¹ˆæ—¶å€™å¼€å§‹ã€ä»€ä¹ˆæ—¶å€™æäº¤ã€ä»€ä¹ˆæ—¶å€™å›æ»š

**ğŸ“– æ­£å¼å®šä¹‰**
```
äº‹åŠ¡ç®¡ç†å™¨ï¼ˆTransaction Managerï¼‰ï¼š
Springç”¨æ¥ç®¡ç†äº‹åŠ¡çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ï¼š
- å¼€å¯äº‹åŠ¡
- æäº¤äº‹åŠ¡
- å›æ»šäº‹åŠ¡
- é‡Šæ”¾èµ„æº
```

### 3.2 å¸¸ç”¨äº‹åŠ¡ç®¡ç†å™¨ç±»å‹


**ğŸ“Š ä¸åŒåœºæ™¯é€‰æ‹©ä¸åŒç®¡ç†å™¨**

```
å•æ•°æ®æºåº”ç”¨
    â†“
DataSourceTransactionManager
ï¼ˆæœ€å¸¸ç”¨ï¼Œé€‚åˆMyBatis/JDBCï¼‰

JPAåº”ç”¨
    â†“
JpaTransactionManager
ï¼ˆé€‚åˆHibernate/JPAï¼‰

åˆ†å¸ƒå¼äº‹åŠ¡
    â†“
JtaTransactionManager
ï¼ˆè·¨å¤šä¸ªæ•°æ®åº“ï¼‰
```

### 3.3 DataSourceTransactionManageré…ç½®


**ğŸ’» Javaé…ç½®æ–¹å¼ï¼ˆæ¨èï¼‰**

```java
@Configuration
public class TransactionConfig {
    
    /**
     * é…ç½®äº‹åŠ¡ç®¡ç†å™¨
     * å°±åƒç»™Springé…ä¸ª"äº¤é€šè­¦å¯Ÿ"
     */
    @Bean
    public PlatformTransactionManager transactionManager(DataSource dataSource) {
        DataSourceTransactionManager manager = new DataSourceTransactionManager();
        manager.setDataSource(dataSource);  // å‘Šè¯‰å®ƒç®¡ç†å“ªä¸ªæ•°æ®åº“
        return manager;
    }
}
```

**ğŸ”§ å¸¦è¯¦ç»†é…ç½®çš„ç‰ˆæœ¬**

```java
@Bean
public PlatformTransactionManager transactionManager(DataSource dataSource) {
    DataSourceTransactionManager manager = new DataSourceTransactionManager();
    manager.setDataSource(dataSource);
    
    // å¯é€‰é…ç½®
    manager.setDefaultTimeout(30);  // é»˜è®¤è¶…æ—¶30ç§’
    manager.setValidateExistingTransaction(true);  // éªŒè¯å·²å­˜åœ¨çš„äº‹åŠ¡
    
    return manager;
}
```

### 3.4 æ•´åˆMyBatisçš„å®Œæ•´é…ç½®


**ğŸ“‹ å®Œæ•´çš„SSMäº‹åŠ¡é…ç½®**

```java
@Configuration
@MapperScan("com.example.mapper")
public class MyBatisConfig {
    
    // 1. é…ç½®æ•°æ®æº
    @Bean
    public DataSource dataSource() {
        DruidDataSource dataSource = new DruidDataSource();
        dataSource.setUrl("jdbc:mysql://localhost:3306/test");
        dataSource.setUsername("root");
        dataSource.setPassword("123456");
        return dataSource;
    }
    
    // 2. é…ç½®SqlSessionFactory
    @Bean
    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {
        SqlSessionFactoryBean factory = new SqlSessionFactoryBean();
        factory.setDataSource(dataSource);
        return factory.getObject();
    }
    
    // 3. é…ç½®äº‹åŠ¡ç®¡ç†å™¨ï¼ˆé‡ç‚¹ï¼ï¼‰
    @Bean
    public PlatformTransactionManager transactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

---

## 4. ğŸ”„ äº‹åŠ¡ä¼ æ’­è¡Œä¸ºåº”ç”¨


### 4.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼Ÿ


**ğŸ  ç”Ÿæ´»åœºæ™¯ç†è§£**
> ä½ åœ¨åšä¸€ä»¶äº‹ï¼ˆæœ‰äº‹åŠ¡ï¼‰ï¼Œçªç„¶éœ€è¦åšå¦ä¸€ä»¶äº‹ï¼Œè¿™å¦ä¸€ä»¶äº‹æ˜¯ï¼š
> - åŠ å…¥ä½ æ­£åœ¨åšçš„äº‹ï¼Ÿï¼ˆä¸€èµ·å®Œæˆï¼‰
> - å•ç‹¬åšä¸€ä»¶æ–°äº‹ï¼Ÿï¼ˆå„åšå„çš„ï¼‰
> - æš‚åœä½ çš„äº‹ï¼Œåšå®Œæ–°äº‹å†ç»§ç»­ï¼Ÿï¼ˆåˆ†å¼€å¤„ç†ï¼‰
> è¿™å°±æ˜¯"ä¼ æ’­è¡Œä¸º"è¦è§£å†³çš„é—®é¢˜

**ğŸ“– æ­£å¼å®šä¹‰**
```
äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼ˆPropagationï¼‰ï¼š
å½“ä¸€ä¸ªæœ‰äº‹åŠ¡çš„æ–¹æ³•è°ƒç”¨å¦ä¸€ä¸ªæœ‰äº‹åŠ¡çš„æ–¹æ³•æ—¶ï¼Œ
äº‹åŠ¡è¯¥å¦‚ä½•ä¼ æ’­ï¼ˆå…±ç”¨è¿˜æ˜¯æ–°å»ºï¼‰
```

### 4.2 ä¸ƒç§ä¼ æ’­è¡Œä¸ºè¯¦è§£


**ğŸ“Š ä¼ æ’­è¡Œä¸ºå¯¹ç…§è¡¨**

| ä¼ æ’­è¡Œä¸º | è¯´æ˜ | é€šä¿—ç†è§£ | ä½¿ç”¨åœºæ™¯ |
|---------|------|----------|----------|
| **REQUIRED** â­ | å¦‚æœæœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±æ–°å»º | "æ­é¡ºé£è½¦"ï¼Œæœ‰è½¦å°±ä¸Šï¼Œæ²¡è½¦è‡ªå·±å¼€ | æœ€å¸¸ç”¨ï¼Œ99%åœºæ™¯ |
| **REQUIRES_NEW** | æ€»æ˜¯æ–°å»ºäº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ | "æ‰“çš„"ï¼Œè‡ªå·±å•ç‹¬å¼€ä¸€è¾† | æ—¥å¿—è®°å½•ã€å®¡è®¡ |
| **SUPPORTS** | æœ‰äº‹åŠ¡å°±ç”¨ï¼Œæ²¡æœ‰å°±ä¸ç”¨ | "éšä¾¿"ï¼Œæœ‰è½¦åè½¦ï¼Œæ²¡è½¦èµ°è·¯ | æŸ¥è¯¢æ“ä½œ |
| **NOT_SUPPORTED** | ä¸ç”¨äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ | "èµ°è·¯"ï¼Œæœ‰è½¦ä¹Ÿä¸å | è€—æ—¶æ“ä½œ |
| **MANDATORY** | å¿…é¡»æœ‰äº‹åŠ¡ï¼Œå¦åˆ™æŠ›å¼‚å¸¸ | "å¿…é¡»æ­è½¦"ï¼Œæ²¡è½¦å°±æŠ¥é”™ | ä¸¥æ ¼è¦æ±‚ |
| **NEVER** | ä¸èƒ½æœ‰äº‹åŠ¡ï¼Œæœ‰å°±æŠ›å¼‚å¸¸ | "æ‹’ç»æ­è½¦"ï¼Œæœ‰è½¦å°±æŠ¥é”™ | ç‰¹æ®Šåœºæ™¯ |
| **NESTED** | åµŒå¥—äº‹åŠ¡ï¼Œå¯ä»¥ç‹¬ç«‹å›æ»š | "å­ä»»åŠ¡"ï¼Œå¤±è´¥ä¸å½±å“çˆ¶ä»»åŠ¡ | éƒ¨åˆ†å¤±è´¥å¯æ¥å— |

### 4.3 REQUIREDï¼ˆæœ€å¸¸ç”¨ï¼‰


**ğŸ¯ åº”ç”¨åœºæ™¯ï¼šæ ‡å‡†ä¸šåŠ¡æ“ä½œ**

```java
@Service
public class OrderService {
    
    @Autowired
    private PaymentService paymentService;
    
    /**
     * åˆ›å»ºè®¢å•ï¼ˆæœ‰äº‹åŠ¡ï¼‰
     */
    @Transactional(propagation = Propagation.REQUIRED)  // å¯çœç•¥ï¼Œè¿™æ˜¯é»˜è®¤å€¼
    public void createOrder(Order order) {
        // 1. ä¿å­˜è®¢å•
        orderMapper.insert(order);
        
        // 2. è°ƒç”¨æ”¯ä»˜æœåŠ¡ï¼ˆä¹Ÿæœ‰äº‹åŠ¡ï¼‰
        paymentService.pay(order.getId(), order.getAmount());
        
        // payæ–¹æ³•ä¼šåŠ å…¥å½“å‰äº‹åŠ¡ï¼Œä¸€èµ·æäº¤æˆ–å›æ»š
    }
}

@Service
public class PaymentService {
    
    @Transactional(propagation = Propagation.REQUIRED)
    public void pay(Long orderId, BigDecimal amount) {
        // è¿™ä¸ªæ–¹æ³•åŠ å…¥createOrderçš„äº‹åŠ¡
        // å¦‚æœè¿™é‡Œå‡ºé”™ï¼Œæ•´ä¸ªcreateOrderä¹Ÿä¼šå›æ»š
        paymentMapper.insert(...);
    }
}
```

**æ‰§è¡Œæµç¨‹å›¾ç¤º**
```
createOrderå¼€å¯äº‹åŠ¡A
    â†“
orderMapper.insert() (åœ¨äº‹åŠ¡Aä¸­)
    â†“
è°ƒç”¨pay() 
    â†“
pay()å‘ç°å·²æœ‰äº‹åŠ¡Aï¼Œç›´æ¥åŠ å…¥
    â†“
paymentMapper.insert() (ä¹Ÿåœ¨äº‹åŠ¡Aä¸­)
    â†“
éƒ½æˆåŠŸ â†’ ä¸€èµ·æäº¤
ä»»ä½•å¤±è´¥ â†’ ä¸€èµ·å›æ»š
```

### 4.4 REQUIRES_NEWï¼ˆæ–°å»ºäº‹åŠ¡ï¼‰


**ğŸ¯ åº”ç”¨åœºæ™¯ï¼šæ—¥å¿—è®°å½•ã€å®¡è®¡è·Ÿè¸ª**

```java
@Service
public class OrderService {
    
    @Autowired
    private LogService logService;
    
    @Transactional
    public void createOrder(Order order) {
        try {
            // 1. åˆ›å»ºè®¢å•
            orderMapper.insert(order);
            
            // 2. è®°å½•æ—¥å¿—ï¼ˆæ–°äº‹åŠ¡ï¼Œç‹¬ç«‹æäº¤ï¼‰
            logService.saveLog("åˆ›å»ºè®¢å•", order.getId());
            
            // 3. æ¨¡æ‹Ÿå¼‚å¸¸
            int i = 1 / 0;
            
        } catch (Exception e) {
            // è®¢å•ä¼šå›æ»šï¼Œä½†æ—¥å¿—å·²ç»ä¿å­˜æˆåŠŸï¼
        }
    }
}

@Service
public class LogService {
    
    /**
     * REQUIRES_NEWï¼šæ€»æ˜¯æ–°å»ºäº‹åŠ¡
     * å³ä½¿å¤–éƒ¨äº‹åŠ¡å›æ»šï¼Œæ—¥å¿—ä¹Ÿä¼šä¿å­˜
     */
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void saveLog(String action, Long orderId) {
        logMapper.insert(new Log(action, orderId));
        // è¿™é‡Œç«‹å³æäº¤ï¼Œä¸å—å¤–éƒ¨äº‹åŠ¡å½±å“
    }
}
```

**æ‰§è¡Œæµç¨‹å›¾ç¤º**
```
createOrderå¼€å¯äº‹åŠ¡A
    â†“
orderMapper.insert() (åœ¨äº‹åŠ¡Aä¸­)
    â†“
è°ƒç”¨saveLog()
    â†“
saveLog()æŒ‚èµ·äº‹åŠ¡Aï¼Œæ–°å»ºäº‹åŠ¡B
    â†“
logMapper.insert() (åœ¨æ–°äº‹åŠ¡Bä¸­)
    â†“
äº‹åŠ¡Bæäº¤ (æ—¥å¿—ä¿å­˜æˆåŠŸ)
    â†“
ç»§ç»­äº‹åŠ¡A
    â†“
å‘ç”Ÿå¼‚å¸¸ï¼Œäº‹åŠ¡Aå›æ»š (è®¢å•æ²¡ä¿å­˜)
    â†“
ç»“æœï¼šè®¢å•å¤±è´¥ï¼Œä½†æ—¥å¿—è®°å½•æˆåŠŸ
```

### 4.5 NESTEDï¼ˆåµŒå¥—äº‹åŠ¡ï¼‰


**ğŸ¯ åº”ç”¨åœºæ™¯ï¼šéƒ¨åˆ†å¤±è´¥å¯ä»¥æ¥å—çš„åœºæ™¯**

```java
@Service
public class BatchService {
    
    @Autowired
    private UserService userService;
    
    /**
     * æ‰¹é‡å¯¼å…¥ç”¨æˆ·
     */
    @Transactional
    public void importUsers(List<User> users) {
        int success = 0;
        for (User user : users) {
            try {
                // å°è¯•ä¿å­˜ç”¨æˆ·ï¼ˆåµŒå¥—äº‹åŠ¡ï¼‰
                userService.saveUser(user);
                success++;
            } catch (Exception e) {
                // æŸä¸ªç”¨æˆ·ä¿å­˜å¤±è´¥ï¼Œä¸å½±å“å…¶ä»–ç”¨æˆ·
                log.error("ç”¨æˆ·{}ä¿å­˜å¤±è´¥", user.getName());
            }
        }
        log.info("æˆåŠŸå¯¼å…¥{}ä¸ªç”¨æˆ·", success);
    }
}

@Service
public class UserService {
    
    /**
     * NESTEDï¼šåµŒå¥—äº‹åŠ¡
     * å¯ä»¥ç‹¬ç«‹å›æ»šï¼Œä¸å½±å“å¤–éƒ¨äº‹åŠ¡
     */
    @Transactional(propagation = Propagation.NESTED)
    public void saveUser(User user) {
        userMapper.insert(user);
        
        // å¦‚æœè¿™é‡Œå‡ºé”™ï¼Œåªå›æ»šå½“å‰ç”¨æˆ·
        // ä¸å½±å“å…¶ä»–ç”¨æˆ·çš„ä¿å­˜
    }
}
```

---

## 5. ğŸ”’ äº‹åŠ¡éš”ç¦»çº§åˆ«è®¾ç½®


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦éš”ç¦»çº§åˆ«ï¼Ÿ


**ğŸ  ç”Ÿæ´»åœºæ™¯**
> ä½ åœ¨ATMå–é’±ï¼ŒåŒæ—¶ä½ è€å©†ä¹Ÿåœ¨å¦ä¸€ä¸ªATMå–é’±
> å¦‚æœä¸åšéš”ç¦»ï¼Œå¯èƒ½ä½ ä¿©éƒ½çœ‹åˆ°ä½™é¢1000å…ƒï¼Œéƒ½å–å‡º1000å…ƒ
> ç»“æœè´¦æˆ·é€æ”¯äº†ï¼è¿™å°±æ˜¯"å¹¶å‘é—®é¢˜"

**ğŸ“– æ•°æ®åº“å¹¶å‘é—®é¢˜**

| é—®é¢˜ | è¯´æ˜ | ç”Ÿæ´»ä¾‹å­ |
|------|------|----------|
| **è„è¯»** | è¯»åˆ°åˆ«äººæœªæäº¤çš„æ•°æ® | çœ‹åˆ°åˆ«äººæ­£åœ¨å†™çš„è‰ç¨¿ |
| **ä¸å¯é‡å¤è¯»** | åŒä¸€äº‹åŠ¡å†…ï¼Œä¸¤æ¬¡è¯»å–æ•°æ®ä¸ä¸€è‡´ | ä½ çœ‹ä¸¤æ¬¡ï¼Œåˆ«äººæ”¹äº†ä¸€æ¬¡ |
| **å¹»è¯»** | åŒä¸€äº‹åŠ¡å†…ï¼Œä¸¤æ¬¡æŸ¥è¯¢è®°å½•æ•°ä¸ä¸€è‡´ | ä½ æŸ¥ä¸¤æ¬¡ï¼Œåˆ«äººæ–°å¢äº†æ•°æ® |

### 5.2 å››ç§éš”ç¦»çº§åˆ«


**ğŸ“Š éš”ç¦»çº§åˆ«å¯¹æ¯”è¡¨**

| éš”ç¦»çº§åˆ« | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» | æ€§èƒ½ | è¯´æ˜ |
|---------|------|-----------|------|------|------|
| **READ_UNCOMMITTED** | âœ— | âœ— | âœ— | â­â­â­â­ | è¯»æœªæäº¤ï¼Œå•¥éƒ½ä¸éš”ç¦» |
| **READ_COMMITTED** | âœ“ | âœ— | âœ— | â­â­â­ | è¯»å·²æäº¤ï¼ŒOracleé»˜è®¤ |
| **REPEATABLE_READ** â­ | âœ“ | âœ“ | âœ— | â­â­ | å¯é‡å¤è¯»ï¼ŒMySQLé»˜è®¤ |
| **SERIALIZABLE** | âœ“ | âœ“ | âœ“ | â­ | ä¸²è¡ŒåŒ–ï¼Œå®Œå…¨éš”ç¦» |

> âœ“ è¡¨ç¤ºå¯ä»¥é˜²æ­¢ï¼Œâœ— è¡¨ç¤ºæ— æ³•é˜²æ­¢

### 5.3 éš”ç¦»çº§åˆ«çš„å®é™…åº”ç”¨


**ğŸ¯ READ_COMMITTEDï¼ˆè¯»å·²æäº¤ï¼‰**

```java
/**
 * åœºæ™¯ï¼šé“¶è¡Œè½¬è´¦
 * è¦æ±‚ï¼šä¸èƒ½è¯»åˆ°åˆ«äººæœªæäº¤çš„æ•°æ®
 */
@Service
public class AccountService {
    
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public void transfer(Long fromId, Long toId, BigDecimal amount) {
        // 1. è¯»å–è´¦æˆ·ä½™é¢ï¼ˆåªè¯»å·²æäº¤çš„ï¼‰
        Account from = accountMapper.selectById(fromId);
        
        // 2. æ‰£æ¬¾
        from.setBalance(from.getBalance().subtract(amount));
        accountMapper.updateById(from);
        
        // 3. åŠ æ¬¾
        Account to = accountMapper.selectById(toId);
        to.setBalance(to.getBalance().add(amount));
        accountMapper.updateById(to);
    }
}
```

**ğŸ¯ REPEATABLE_READï¼ˆå¯é‡å¤è¯»ï¼‰**

```java
/**
 * åœºæ™¯ï¼šç»Ÿè®¡æŠ¥è¡¨
 * è¦æ±‚ï¼šç»Ÿè®¡è¿‡ç¨‹ä¸­æ•°æ®ä¸èƒ½å˜åŒ–
 */
@Service
public class ReportService {
    
    @Transactional(isolation = Isolation.REPEATABLE_READ)
    public OrderReport generateReport(LocalDate date) {
        // ç¬¬ä¸€æ¬¡æŸ¥è¯¢è®¢å•æ€»æ•°
        int totalCount = orderMapper.countByDate(date);
        
        // ... ä¸­é—´è¿›è¡Œå…¶ä»–è®¡ç®— ...
        
        // ç¬¬äºŒæ¬¡æŸ¥è¯¢è®¢å•æ€»æ•°ï¼ˆç»“æœä¸ç¬¬ä¸€æ¬¡ç›¸åŒï¼‰
        int checkCount = orderMapper.countByDate(date);
        
        // ä¿è¯ä¸¤æ¬¡æŸ¥è¯¢ç»“æœä¸€è‡´
        assert totalCount == checkCount;
        
        return report;
    }
}
```

### 5.4 éš”ç¦»çº§åˆ«é€‰æ‹©æŒ‡å—


**ğŸ¯ å®é™…å¼€å‘å»ºè®®**

```
ä¸€èˆ¬ä¸šåŠ¡æ“ä½œï¼š
- ä½¿ç”¨é»˜è®¤éš”ç¦»çº§åˆ«ï¼ˆMySQLçš„REPEATABLE_READï¼‰
- ä¸ç”¨ç‰¹æ„è®¾ç½®

é‡‘èç±»ä¸šåŠ¡ï¼š
- ä½¿ç”¨READ_COMMITTEDæˆ–æ›´é«˜çº§åˆ«
- é˜²æ­¢è„è¯»

æŠ¥è¡¨ç»Ÿè®¡ï¼š
- ä½¿ç”¨REPEATABLE_READ
- ä¿è¯æ•°æ®ä¸€è‡´æ€§

é«˜å¹¶å‘åœºæ™¯ï¼š
- ä½¿ç”¨READ_COMMITTED
- å¹³è¡¡æ€§èƒ½å’Œå®‰å…¨
```

---

## 6. ğŸ”™ äº‹åŠ¡å›æ»šç­–ç•¥


### 6.1 é»˜è®¤å›æ»šè§„åˆ™


**ğŸ“– Springçš„é»˜è®¤è¡Œä¸º**
```
é»˜è®¤æƒ…å†µä¸‹ï¼š
- RuntimeExceptionåŠå…¶å­ç±» â†’ è‡ªåŠ¨å›æ»š
- ErroråŠå…¶å­ç±» â†’ è‡ªåŠ¨å›æ»š
- æ£€æŸ¥å‹å¼‚å¸¸ï¼ˆChecked Exceptionï¼‰ â†’ ä¸å›æ»š
```

**ğŸ¤” ä¸ºä»€ä¹ˆæ£€æŸ¥å‹å¼‚å¸¸ä¸å›æ»šï¼Ÿ**
> æ£€æŸ¥å‹å¼‚å¸¸é€šå¸¸æ˜¯å¯é¢„æœŸçš„ä¸šåŠ¡å¼‚å¸¸ï¼ˆå¦‚æ–‡ä»¶ä¸å­˜åœ¨ï¼‰ï¼Œä¸ä¸€å®šä»£è¡¨æ•°æ®é”™è¯¯ï¼Œæ‰€ä»¥Springè®¤ä¸ºä½ ä¼šè‡ªå·±å¤„ç†ï¼Œä¸ä¼šè‡ªåŠ¨å›æ»š

### 6.2 è‡ªå®šä¹‰å›æ»šè§„åˆ™


**ğŸ¯ æŒ‡å®šå“ªäº›å¼‚å¸¸å›æ»š**

```java
@Service
public class OrderService {
    
    /**
     * æ–¹å¼1ï¼šæŒ‡å®šå›æ»šçš„å¼‚å¸¸ç±»å‹
     */
    @Transactional(
        rollbackFor = {Exception.class},  // æ‰€æœ‰å¼‚å¸¸éƒ½å›æ»š
        noRollbackFor = {BusinessException.class}  // ä¸šåŠ¡å¼‚å¸¸ä¸å›æ»š
    )
    public void createOrder(Order order) throws Exception {
        orderMapper.insert(order);
        
        // å³ä½¿æ˜¯æ£€æŸ¥å‹å¼‚å¸¸ï¼Œä¹Ÿä¼šå›æ»š
        if (order.getAmount().compareTo(BigDecimal.ZERO) <= 0) {
            throw new Exception("è®¢å•é‡‘é¢å¿…é¡»å¤§äº0");
        }
    }
    
    /**
     * æ–¹å¼2ï¼šæŒ‡å®šå›æ»šçš„å¼‚å¸¸ç±»å
     */
    @Transactional(
        rollbackForClassName = {"java.lang.Exception"},
        noRollbackForClassName = {"com.example.exception.BusinessException"}
    )
    public void updateOrder(Order order) {
        // ...
    }
}
```

### 6.3 ç¼–ç¨‹å¼å›æ»š


**ğŸ”§ æ‰‹åŠ¨æ§åˆ¶å›æ»š**

```java
@Service
public class OrderService {
    
    @Transactional
    public void processOrder(Order order) {
        try {
            // 1. ä¿å­˜è®¢å•
            orderMapper.insert(order);
            
            // 2. è°ƒç”¨å¤–éƒ¨æ¥å£
            boolean success = externalService.notify(order);
            
            // 3. æ ¹æ®ä¸šåŠ¡é€»è¾‘å†³å®šæ˜¯å¦å›æ»š
            if (!success) {
                // æ‰‹åŠ¨æ ‡è®°å›æ»š
                TransactionAspectSupport.currentTransactionStatus()
                    .setRollbackOnly();
                return;
            }
            
            // 4. æ›´æ–°è®¢å•çŠ¶æ€
            order.setStatus("SUCCESS");
            orderMapper.updateById(order);
            
        } catch (Exception e) {
            // å¼‚å¸¸ä¼šè‡ªåŠ¨å›æ»š
            throw e;
        }
    }
}
```

### 6.4 å›æ»šç­–ç•¥æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**

```java
// 1. å¯¹å…³é”®æ“ä½œï¼Œæ˜ç¡®æŒ‡å®šå›æ»šå¼‚å¸¸
@Transactional(rollbackFor = Exception.class)
public void importantOperation() {
    // ...
}

// 2. ä¸šåŠ¡å¼‚å¸¸ä¸å›æ»šï¼Œç”¨äºæµç¨‹æ§åˆ¶
@Transactional(noRollbackFor = BusinessException.class)
public void businessOperation() throws BusinessException {
    if (somethingWrong) {
        throw new BusinessException("ä¸šåŠ¡æ ¡éªŒå¤±è´¥");
    }
}

// 3. è®°å½•æ—¥å¿—åé‡æ–°æŠ›å‡ºå¼‚å¸¸
@Transactional(rollbackFor = Exception.class)
public void operationWithLog() {
    try {
        // ä¸šåŠ¡é€»è¾‘
    } catch (Exception e) {
        log.error("æ“ä½œå¤±è´¥", e);
        throw e;  // å¿…é¡»é‡æ–°æŠ›å‡ºï¼Œå¦åˆ™ä¸ä¼šå›æ»š
    }
}
```

---

## 7. ğŸ“– åªè¯»äº‹åŠ¡ä¼˜åŒ–


### 7.1 ä»€ä¹ˆæ˜¯åªè¯»äº‹åŠ¡ï¼Ÿ


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> å»å›¾ä¹¦é¦†å€Ÿä¹¦å’Œçœ‹ä¹¦æ˜¯ä¸åŒçš„
> - å€Ÿä¹¦ï¼šéœ€è¦ç™»è®°ã€ä¿®æ”¹åº“å­˜ï¼ˆå†™æ“ä½œï¼‰
> - çœ‹ä¹¦ï¼šåªæ˜¯é˜…è¯»ï¼Œä¸æ”¹å˜ä»»ä½•ä¸œè¥¿ï¼ˆè¯»æ“ä½œï¼‰
> åªè¯»äº‹åŠ¡å°±åƒ"çœ‹ä¹¦"ï¼Œå‘Šè¯‰æ•°æ®åº“"æˆ‘åªçœ‹ä¸æ”¹"

**ğŸ“– åªè¯»äº‹åŠ¡çš„å¥½å¤„**

| ä¼˜åŠ¿ | è¯´æ˜ | æ•ˆæœ |
|------|------|------|
| **æ€§èƒ½æå‡** | æ•°æ®åº“å¯ä»¥ä¼˜åŒ–æŸ¥è¯¢ | é€Ÿåº¦æ›´å¿« |
| **èµ„æºèŠ‚çœ** | ä¸éœ€è¦åŠ å†™é” | å¹¶å‘æ€§æ›´å¥½ |
| **é˜²æ­¢è¯¯æ“ä½œ** | ç¦æ­¢ä¿®æ”¹æ“ä½œ | æ›´å®‰å…¨ |

### 7.2 åªè¯»äº‹åŠ¡çš„ä½¿ç”¨


**ğŸ¯ åŸºæœ¬ç”¨æ³•**

```java
@Service
public class UserService {
    
    /**
     * æŸ¥è¯¢æ“ä½œï¼šä½¿ç”¨åªè¯»äº‹åŠ¡
     */
    @Transactional(readOnly = true)
    public User getUserById(Long id) {
        return userMapper.selectById(id);
    }
    
    /**
     * ä¿®æ”¹æ“ä½œï¼šä¸èƒ½ç”¨åªè¯»äº‹åŠ¡
     */
    @Transactional(readOnly = false)  // æˆ–è€…çœç•¥ï¼Œé»˜è®¤å°±æ˜¯false
    public void updateUser(User user) {
        userMapper.updateById(user);
    }
}
```

**ğŸ”§ ç±»çº§åˆ«é…ç½®**

```java
@Service
@Transactional(readOnly = true)  // é»˜è®¤éƒ½æ˜¯åªè¯»
public class QueryService {
    
    // è¿™ä¸ªæ–¹æ³•ç»§æ‰¿ç±»ä¸Šçš„åªè¯»é…ç½®
    public List<Order> getOrders() {
        return orderMapper.selectList(null);
    }
    
    // è¿™ä¸ªæ–¹æ³•è¦†ç›–ç±»ä¸Šçš„é…ç½®
    @Transactional(readOnly = false)
    public void updateOrderStatus(Long id, String status) {
        orderMapper.updateStatus(id, status);
    }
}
```

### 7.3 åªè¯»äº‹åŠ¡çš„æ³¨æ„äº‹é¡¹


**âš ï¸ å¸¸è§è¯¯åŒº**

```java
// âŒ é”™è¯¯ï¼šåœ¨åªè¯»äº‹åŠ¡ä¸­è¿›è¡Œä¿®æ”¹æ“ä½œ
@Transactional(readOnly = true)
public void wrongMethod() {
    User user = userMapper.selectById(1L);
    user.setName("æ–°åå­—");
    userMapper.updateById(user);  // è¿™é‡Œä¼šæŠ¥é”™æˆ–ä¸ç”Ÿæ•ˆ
}

// âœ… æ­£ç¡®ï¼šè¯»å†™åˆ†ç¦»
@Transactional(readOnly = true)
public User queryUser(Long id) {
    return userMapper.selectById(id);  // åªæŸ¥è¯¢
}

@Transactional
public void modifyUser(User user) {
    userMapper.updateById(user);  // åªä¿®æ”¹
}
```

**ğŸ¯ æœ€ä½³å®è·µ**

```java
@Service
public class UserService {
    
    // æ–¹å¼1ï¼šServiceå±‚é¢åˆ†ç¦»è¯»å†™
    @Transactional(readOnly = true)
    public User getUser(Long id) {
        return userMapper.selectById(id);
    }
    
    @Transactional
    public void saveUser(User user) {
        userMapper.insert(user);
    }
    
    // æ–¹å¼2ï¼šå¤æ‚æŸ¥è¯¢ä¹Ÿç”¨åªè¯»äº‹åŠ¡
    @Transactional(readOnly = true)
    public PageResult<User> searchUsers(UserQuery query) {
        // å¤æ‚çš„å¤šè¡¨æŸ¥è¯¢
        List<User> users = userMapper.selectByCondition(query);
        int total = userMapper.countByCondition(query);
        return new PageResult<>(users, total);
    }
}
```

---

## 8. â±ï¸ äº‹åŠ¡è¶…æ—¶è®¾ç½®


### 8.1 ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶è®¾ç½®ï¼Ÿ


**ğŸ  ç”Ÿæ´»åœºæ™¯**
> ä½ åœ¨é¤å…ç‚¹èœï¼Œå¦‚æœå¨å¸ˆ30åˆ†é’Ÿè¿˜æ²¡åšå¥½ï¼Œä½ å¯ä»¥é€‰æ‹©é€€å•
> äº‹åŠ¡è¶…æ—¶å°±æ˜¯è¿™ä¸ªé“ç†ï¼šå¦‚æœæ“ä½œå¤ªä¹…ï¼Œå°±è‡ªåŠ¨å–æ¶ˆ

**âŒ æ²¡æœ‰è¶…æ—¶è®¾ç½®çš„é—®é¢˜**
```
åœºæ™¯ï¼šæ‰¹é‡å¯¼å…¥10ä¸‡æ¡æ•°æ®
é—®é¢˜ï¼š
1. æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå ç”¨æ•°æ®åº“è¿æ¥
2. å¯èƒ½é™·å…¥æ­»é”ï¼Œä¸€ç›´ç­‰å¾…
3. å½±å“å…¶ä»–ç”¨æˆ·çš„æ“ä½œ

ç»“æœï¼šç³»ç»Ÿå‡æ­»ï¼Œç”¨æˆ·ä½“éªŒæå·®
```

### 8.2 è¶…æ—¶æ—¶é—´é…ç½®


**ğŸ¯ åŸºæœ¬é…ç½®**

```java
@Service
public class BatchService {
    
    /**
     * è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º30ç§’
     * è¶…è¿‡30ç§’è‡ªåŠ¨å›æ»š
     */
    @Transactional(timeout = 30)
    public void importData(List<Data> dataList) {
        for (Data data : dataList) {
            dataMapper.insert(data);
        }
        // å¦‚æœè¿™ä¸ªå¾ªç¯è¶…è¿‡30ç§’ï¼Œäº‹åŠ¡è‡ªåŠ¨å›æ»š
    }
}
```

**ğŸ”§ ä¸åŒåœºæ™¯çš„è¶…æ—¶è®¾ç½®**

```java
@Service
public class OrderService {
    
    // 1. å¿«é€Ÿæ“ä½œï¼šè¶…æ—¶æ—¶é—´çŸ­
    @Transactional(timeout = 5)  // 5ç§’
    public void createOrder(Order order) {
        orderMapper.insert(order);
    }
    
    // 2. æ‰¹é‡æ“ä½œï¼šè¶…æ—¶æ—¶é—´é•¿
    @Transactional(timeout = 300)  // 5åˆ†é’Ÿ
    public void batchImport(List<Order> orders) {
        orders.forEach(orderMapper::insert);
    }
    
    // 3. å¤æ‚ç»Ÿè®¡ï¼šè¶…æ—¶æ—¶é—´æ›´é•¿
    @Transactional(timeout = 600, readOnly = true)  // 10åˆ†é’Ÿ
    public Report generateAnnualReport() {
        // å¤æ‚çš„ç»Ÿè®¡è®¡ç®—
        return reportService.calculate();
    }
}
```

### 8.3 è¶…æ—¶æœºåˆ¶åŸç†


**æ‰§è¡Œæµç¨‹**
```
å¼€å§‹äº‹åŠ¡ï¼ˆè®°å½•å¼€å§‹æ—¶é—´ï¼‰
    â†“
æ‰§è¡Œç¬¬1ä¸ªSQLï¼ˆæ£€æŸ¥æ˜¯å¦è¶…æ—¶ï¼‰
    â†“
æ‰§è¡Œç¬¬2ä¸ªSQLï¼ˆæ£€æŸ¥æ˜¯å¦è¶…æ—¶ï¼‰
    â†“
...
    â†“
æ‰§è¡Œç¬¬Nä¸ªSQLï¼ˆæ£€æŸ¥æ˜¯å¦è¶…æ—¶ï¼‰
    â†“
å¦‚æœè¶…æ—¶ â†’ æŠ›å‡ºå¼‚å¸¸ â†’ è‡ªåŠ¨å›æ»š
å¦‚æœæœªè¶…æ—¶ â†’ æäº¤äº‹åŠ¡
```

**âš ï¸ æ³¨æ„äº‹é¡¹**

```java
// è¶…æ—¶æ£€æŸ¥æ˜¯åœ¨SQLæ‰§è¡Œæ—¶è¿›è¡Œçš„
@Transactional(timeout = 5)
public void processData() {
    // è¿™æ®µJavaä»£ç æ‰§è¡Œ10ç§’ï¼Œä¸ä¼šè¶…æ—¶
    for (int i = 0; i < 10000000; i++) {
        // çº¯è®¡ç®—ï¼Œä¸æ¶‰åŠæ•°æ®åº“
    }
    
    // è¿™é‡Œæ‰§è¡ŒSQLæ—¶æ‰ä¼šæ£€æŸ¥è¶…æ—¶
    dataMapper.insert(data);  // å¦‚æœæ€»æ—¶é—´è¶…è¿‡5ç§’ï¼Œè¿™é‡Œä¼šè¶…æ—¶
}
```

### 8.4 è¶…æ—¶è®¾ç½®æœ€ä½³å®è·µ


**ğŸ¯ æ¨èé…ç½®**

| æ“ä½œç±»å‹ | è¶…æ—¶æ—¶é—´ | è¯´æ˜ |
|---------|---------|------|
| **å•æ¡å¢åˆ æ”¹** | 5-10ç§’ | å¿«é€Ÿæ“ä½œ |
| **æ‰¹é‡æ“ä½œ** | 60-300ç§’ | æ ¹æ®æ•°æ®é‡è°ƒæ•´ |
| **å¤æ‚æŸ¥è¯¢** | 30-60ç§’ | ç»Ÿè®¡æŠ¥è¡¨ç­‰ |
| **æ•°æ®å¯¼å…¥** | 300-600ç§’ | å¤§æ‰¹é‡æ•°æ® |

```java
// æ¨èï¼šåœ¨é…ç½®ç±»ä¸­è®¾ç½®é»˜è®¤è¶…æ—¶
@Configuration
@EnableTransactionManagement
public class TransactionConfig {
    
    @Bean
    public PlatformTransactionManager transactionManager(DataSource dataSource) {
        DataSourceTransactionManager manager = new DataSourceTransactionManager();
        manager.setDataSource(dataSource);
        manager.setDefaultTimeout(30);  // é»˜è®¤30ç§’
        return manager;
    }
}
```

---

## 9. âš ï¸ äº‹åŠ¡å¤±æ•ˆåœºæ™¯åˆ†æ


### 9.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡å¤±æ•ˆï¼Ÿ


**ğŸ¤” äº‹åŠ¡å¤±æ•ˆçš„è¡¨ç°**
> æ˜æ˜åŠ äº†@Transactionalæ³¨è§£ï¼Œä½†æ˜¯å‡ºé”™æ—¶æ•°æ®æ²¡æœ‰å›æ»šï¼Œè¿™å°±æ˜¯"äº‹åŠ¡å¤±æ•ˆ"

**ğŸ“– å¸¸è§åŸå› æ€»ç»“**
```
8å¤§å¤±æ•ˆåœºæ™¯ï¼š
1. æ•°æ®åº“å¼•æ“ä¸æ”¯æŒäº‹åŠ¡
2. ç±»æ²¡æœ‰è¢«Springç®¡ç†
3. æ–¹æ³•ä¸æ˜¯public
4. è‡ªèº«è°ƒç”¨é—®é¢˜
5. å¼‚å¸¸è¢«æ•è·
6. å¼‚å¸¸ç±»å‹ä¸å¯¹
7. å¤šçº¿ç¨‹è°ƒç”¨
8. ä¼ æ’­è¡Œä¸ºè®¾ç½®é”™è¯¯
```

### 9.2 åœºæ™¯1ï¼šæ•°æ®åº“å¼•æ“ä¸æ”¯æŒ


**âŒ MyISAMå¼•æ“ä¸æ”¯æŒäº‹åŠ¡**

```sql
-- æŸ¥çœ‹è¡¨çš„å¼•æ“
SHOW CREATE TABLE user;

-- å¦‚æœæ˜¯MyISAMï¼Œéœ€è¦æ”¹æˆInnoDB
ALTER TABLE user ENGINE = InnoDB;
```

> ğŸ’¡ **è®°ä½**ï¼šMySQLä¸­åªæœ‰InnoDBå¼•æ“æ”¯æŒäº‹åŠ¡ï¼ŒMyISAMä¸æ”¯æŒ

### 9.3 åœºæ™¯2ï¼šç±»æ²¡æœ‰è¢«Springç®¡ç†


**âŒ é”™è¯¯ç¤ºä¾‹**

```java
// æ²¡æœ‰åŠ @Serviceæ³¨è§£ï¼ŒSpringä¸ä¼šç®¡ç†è¿™ä¸ªç±»
public class UserService {
    
    @Transactional  // è¿™ä¸ªæ³¨è§£ä¸ä¼šç”Ÿæ•ˆ
    public void saveUser(User user) {
        userMapper.insert(user);
    }
}
```

**âœ… æ­£ç¡®ç¤ºä¾‹**

```java
@Service  // å¿…é¡»åŠ è¿™ä¸ªæ³¨è§£
public class UserService {
    
    @Transactional  // ç°åœ¨å¯ä»¥ç”Ÿæ•ˆäº†
    public void saveUser(User user) {
        userMapper.insert(user);
    }
}
```

### 9.4 åœºæ™¯3ï¼šæ–¹æ³•ä¸æ˜¯public


**âŒ é”™è¯¯ç¤ºä¾‹**

```java
@Service
public class UserService {
    
    @Transactional
    private void saveUser(User user) {  // privateæ–¹æ³•
        userMapper.insert(user);
    }
}
```

**âœ… æ­£ç¡®ç¤ºä¾‹**

```java
@Service
public class UserService {
    
    @Transactional
    public void saveUser(User user) {  // publicæ–¹æ³•
        userMapper.insert(user);
    }
}
```

> ğŸ” **åŸå› **ï¼šSpringä½¿ç”¨AOPä»£ç†å®ç°äº‹åŠ¡ï¼Œåªèƒ½ä»£ç†publicæ–¹æ³•

### 9.5 åœºæ™¯4ï¼šè‡ªèº«è°ƒç”¨ï¼ˆæœ€å®¹æ˜“çŠ¯çš„é”™è¯¯ï¼‰


**âŒ é”™è¯¯ç¤ºä¾‹**

```java
@Service
public class UserService {
    
    public void register(User user) {
        // æ–¹æ³•1ï¼šæ²¡æœ‰äº‹åŠ¡
        
        // ç›´æ¥è°ƒç”¨æ–¹æ³•2ï¼ˆè‡ªèº«è°ƒç”¨ï¼‰
        this.saveUser(user);  // äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆï¼
    }
    
    @Transactional
    public void saveUser(User user) {
        // æ–¹æ³•2ï¼šæœ‰äº‹åŠ¡ï¼Œä½†ä¸ä¼šç”Ÿæ•ˆ
        userMapper.insert(user);
    }
}
```

**ğŸ” ä¸ºä»€ä¹ˆå¤±æ•ˆï¼Ÿ**
```
æ­£å¸¸è°ƒç”¨é“¾ï¼š
Controller â†’ ä»£ç†å¯¹è±¡ â†’ çœŸå®å¯¹è±¡.saveUser()
         (å¼€å¯äº‹åŠ¡)

è‡ªèº«è°ƒç”¨é“¾ï¼š
register() â†’ this.saveUser()
       (ç›´æ¥è°ƒç”¨ï¼Œè·³è¿‡äº†ä»£ç†)
```

**âœ… è§£å†³æ–¹æ¡ˆ1ï¼šæ³¨å…¥è‡ªå·±**

```java
@Service
public class UserService {
    
    @Autowired
    private UserService userService;  // æ³¨å…¥è‡ªå·±
    
    public void register(User user) {
        // é€šè¿‡Springæ³¨å…¥çš„å¯¹è±¡è°ƒç”¨
        userService.saveUser(user);  // äº‹åŠ¡ç”Ÿæ•ˆ
    }
    
    @Transactional
    public void saveUser(User user) {
        userMapper.insert(user);
    }
}
```

**âœ… è§£å†³æ–¹æ¡ˆ2ï¼šæ‹†åˆ†åˆ°ä¸åŒç±»**

```java
@Service
public class UserRegisterService {
    
    @Autowired
    private UserService userService;
    
    public void register(User user) {
        // è°ƒç”¨å¦ä¸€ä¸ªService
        userService.saveUser(user);  // äº‹åŠ¡ç”Ÿæ•ˆ
    }
}

@Service
public class UserService {
    
    @Transactional
    public void saveUser(User user) {
        userMapper.insert(user);
    }
}
```

### 9.6 åœºæ™¯5ï¼šå¼‚å¸¸è¢«æ•è·


**âŒ é”™è¯¯ç¤ºä¾‹**

```java
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(Order order) {
        try {
            orderMapper.insert(order);
            
            // æ¨¡æ‹Ÿå¼‚å¸¸
            int i = 1 / 0;
            
        } catch (Exception e) {
            // å¼‚å¸¸è¢«æ•è·ï¼Œäº‹åŠ¡ä¸ä¼šå›æ»š
            log.error("åˆ›å»ºè®¢å•å¤±è´¥", e);
        }
    }
}
```

**âœ… æ­£ç¡®ç¤ºä¾‹**

```java
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(Order order) {
        try {
            orderMapper.insert(order);
            int i = 1 / 0;
        } catch (Exception e) {
            log.error("åˆ›å»ºè®¢å•å¤±è´¥", e);
            throw e;  // å¿…é¡»é‡æ–°æŠ›å‡ºå¼‚å¸¸
        }
    }
}
```

### 9.7 åœºæ™¯6ï¼šå¼‚å¸¸ç±»å‹ä¸å¯¹


**âŒ é”™è¯¯ç¤ºä¾‹**

```java
@Service
public class OrderService {
    
    @Transactional  // é»˜è®¤åªå›æ»šRuntimeException
    public void createOrder(Order order) throws Exception {
        orderMapper.insert(order);
        
        // æŠ›å‡ºæ£€æŸ¥å‹å¼‚å¸¸ï¼Œä¸ä¼šå›æ»š
        throw new Exception("ä¸šåŠ¡å¼‚å¸¸");
    }
}
```

**âœ… æ­£ç¡®ç¤ºä¾‹**

```java
@Service
public class OrderService {
    
    @Transactional(rollbackFor = Exception.class)  // æ˜ç¡®æŒ‡å®šå›æ»šå¼‚å¸¸
    public void createOrder(Order order) throws Exception {
        orderMapper.insert(order);
        throw new Exception("ä¸šåŠ¡å¼‚å¸¸");  // ç°åœ¨ä¼šå›æ»š
    }
}
```

### 9.8 äº‹åŠ¡å¤±æ•ˆæ’æŸ¥æ¸…å•


**ğŸ” å‡ºç°äº‹åŠ¡ä¸ç”Ÿæ•ˆæ—¶ï¼ŒæŒ‰é¡ºåºæ£€æŸ¥**

```
- [ ] 1. æ•°æ®åº“å¼•æ“æ˜¯InnoDBå—ï¼Ÿ
- [ ] 2. ç±»ä¸Šæœ‰@Serviceç­‰æ³¨è§£å—ï¼Ÿ
- [ ] 3. æ–¹æ³•æ˜¯publicçš„å—ï¼Ÿ
- [ ] 4. æ˜¯ä¸æ˜¯è‡ªèº«è°ƒç”¨ï¼Ÿ
- [ ] 5. å¼‚å¸¸æœ‰é‡æ–°æŠ›å‡ºå—ï¼Ÿ
- [ ] 6. å¼‚å¸¸ç±»å‹åœ¨rollbackForä¸­å—ï¼Ÿ
- [ ] 7. æ˜¯å•çº¿ç¨‹è°ƒç”¨å—ï¼Ÿ
- [ ] 8. ä¼ æ’­è¡Œä¸ºè®¾ç½®å¯¹äº†å—ï¼Ÿ
```

---

## 10. ğŸ”— äº‹åŠ¡åµŒå¥—å¤„ç†


### 10.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡åµŒå¥—ï¼Ÿ


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> ä½ åœ¨åšå¤§æ‰«é™¤ï¼ˆå¤–å±‚äº‹åŠ¡ï¼‰ï¼š
> - æ‰“æ‰«å®¢å…
> - æ‰“æ‰«å§å®¤ï¼ˆåµŒå¥—äº‹åŠ¡ï¼‰
> - æ‰“æ‰«å¨æˆ¿
> 
> å¦‚æœå§å®¤æ‰“æ‰«å¤±è´¥ï¼Œæ˜¯åªé‡æ–°æ‰“æ‰«å§å®¤ï¼Œè¿˜æ˜¯æ•´ä¸ªå¤§æ‰«é™¤é‡æ¥ï¼Ÿè¿™å°±æ˜¯äº‹åŠ¡åµŒå¥—è¦è§£å†³çš„é—®é¢˜

**ğŸ“– åµŒå¥—äº‹åŠ¡çš„åœºæ™¯**
```
æ–¹æ³•Aï¼ˆæœ‰äº‹åŠ¡ï¼‰è°ƒç”¨æ–¹æ³•Bï¼ˆæœ‰äº‹åŠ¡ï¼‰
    â†“
å¦‚ä½•å¤„ç†ä¸¤ä¸ªäº‹åŠ¡çš„å…³ç³»ï¼Ÿ
    â†“
1. BåŠ å…¥Açš„äº‹åŠ¡ï¼ˆREQUIREDï¼‰
2. Bæ–°å»ºç‹¬ç«‹äº‹åŠ¡ï¼ˆREQUIRES_NEWï¼‰  
3. Båˆ›å»ºåµŒå¥—äº‹åŠ¡ï¼ˆNESTEDï¼‰
```

### 10.2 NESTEDåµŒå¥—äº‹åŠ¡è¯¦è§£


**ğŸ¯ NESTEDçš„ç‰¹ç‚¹**

```
ç‰¹ç‚¹ï¼š
- å¤–éƒ¨äº‹åŠ¡å›æ»š â†’ åµŒå¥—äº‹åŠ¡ä¹Ÿå›æ»š
- åµŒå¥—äº‹åŠ¡å›æ»š â†’ å¤–éƒ¨äº‹åŠ¡å¯ä»¥é€‰æ‹©æ˜¯å¦å›æ»š
- ä½¿ç”¨JDBCçš„savepointå®ç°
```

**ğŸ’» å®æˆ˜ç¤ºä¾‹**

```java
@Service
public class OrderService {
    
    @Autowired
    private StockService stockService;
    
    @Autowired
    private CouponService couponService;
    
    /**
     * åˆ›å»ºè®¢å•ï¼ˆå¤–å±‚äº‹åŠ¡ï¼‰
     */
    @Transactional
    public void createOrder(Order order) {
        // 1. ä¿å­˜è®¢å•
        orderMapper.insert(order);
        
        // 2. æ‰£å‡åº“å­˜ï¼ˆå¿…é¡»æˆåŠŸï¼‰
        stockService.reduceStock(order.getProductId(), order.getQuantity());
        
        // 3. ä½¿ç”¨ä¼˜æƒ åˆ¸ï¼ˆå¯ä»¥å¤±è´¥ï¼‰
        try {
            couponService.useCoupon(order.getUserId(), order.getCouponId());
        } catch (Exception e) {
            // ä¼˜æƒ åˆ¸ä½¿ç”¨å¤±è´¥ï¼Œä¸å½±å“è®¢å•åˆ›å»º
            log.warn("ä¼˜æƒ åˆ¸ä½¿ç”¨å¤±è´¥", e);
        }
        
        // 4. æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus("SUCCESS");
        orderMapper.updateById(order);
    }
}

@Service
public class StockService {
    
    /**
     * REQUIREDï¼šåŠ å…¥å¤–å±‚äº‹åŠ¡
     * å¤±è´¥ä¼šå¯¼è‡´æ•´ä¸ªè®¢å•å›æ»š
     */
    @Transactional(propagation = Propagation.REQUIRED)
    public void reduceStock(Long productId, Integer quantity) {
        Stock stock = stockMapper.selectById(productId);
        if (stock.getQuantity() < quantity) {
            throw new RuntimeException("åº“å­˜ä¸è¶³");
        }
        stock.setQuantity(stock.getQuantity() - quantity);
        stockMapper.updateById(stock);
    }
}

@Service
public class CouponService {
    
    /**
     * NESTEDï¼šåµŒå¥—äº‹åŠ¡
     * å¤±è´¥åªå›æ»šè‡ªå·±ï¼Œä¸å½±å“å¤–å±‚äº‹åŠ¡
     */
    @Transactional(propagation = Propagation.NESTED)
    public void useCoupon(Long userId, Long couponId) {
        Coupon coupon = couponMapper.selectById(couponId);
        if (coupon.isExpired()) {
            throw new RuntimeException("ä¼˜æƒ åˆ¸å·²è¿‡æœŸ");
        }
        coupon.setUsed(true);
        couponMapper.updateById(coupon);
    }
}
```

**æ‰§è¡Œæµç¨‹å›¾ç¤º**
```
createOrderå¼€å¯äº‹åŠ¡A
    â†“
orderMapper.insert() âœ“
    â†“
reduceStock() (åŠ å…¥äº‹åŠ¡A)
    â†“
stockMapper.update() âœ“
    â†“
useCoupon() (åˆ›å»ºåµŒå¥—äº‹åŠ¡B)
    â†“
ä¼˜æƒ åˆ¸è¿‡æœŸï¼ŒæŠ›å‡ºå¼‚å¸¸
    â†“
äº‹åŠ¡Bå›æ»šï¼ˆä¼˜æƒ åˆ¸æ“ä½œå›æ»šï¼‰
    â†“
å¤–å±‚æ•è·å¼‚å¸¸ï¼Œç»§ç»­æ‰§è¡Œ
    â†“
orderMapper.updateById() âœ“
    â†“
äº‹åŠ¡Aæäº¤æˆåŠŸ
    â†“
ç»“æœï¼šè®¢å•åˆ›å»ºæˆåŠŸï¼Œåº“å­˜æ‰£å‡æˆåŠŸï¼Œä¼˜æƒ åˆ¸æœªä½¿ç”¨
```

### 10.3 NESTED vs REQUIRES_NEW


**ğŸ“Š ä¸¤ç§åµŒå¥—æ–¹å¼å¯¹æ¯”**

| ç‰¹æ€§ | NESTED | REQUIRES_NEW |
|------|--------|--------------|
| **äº‹åŠ¡å…³ç³»** | çˆ¶å­å…³ç³» | ç‹¬ç«‹å…³ç³» |
| **çˆ¶äº‹åŠ¡å›æ»š** | å­äº‹åŠ¡ä¹Ÿå›æ»š | å­äº‹åŠ¡ä¸å—å½±å“ |
| **å­äº‹åŠ¡å›æ»š** | çˆ¶äº‹åŠ¡å¯ä»¥ç»§ç»­ | çˆ¶äº‹åŠ¡ä¸å—å½±å“ |
| **æäº¤æ—¶æœº** | çˆ¶äº‹åŠ¡æäº¤æ—¶ä¸€èµ·æäº¤ | å­äº‹åŠ¡ç«‹å³æäº¤ |
| **å®ç°æ–¹å¼** | JDBC savepoint | æ–°å»ºäº‹åŠ¡ |

**ä½¿ç”¨åœºæ™¯å¯¹æ¯”**

```java
// NESTEDï¼šéƒ¨åˆ†å¤±è´¥å¯æ¥å—
@Transactional(propagation = Propagation.NESTED)
public void sendNotification(Long orderId) {
    // å‘é€é€šçŸ¥å¤±è´¥ä¸å½±å“è®¢å•
    notificationService.send(orderId);
}

// REQUIRES_NEWï¼šå¿…é¡»ç‹¬ç«‹ä¿å­˜
@Transactional(propagation = Propagation.REQUIRES_NEW)
public void saveLog(String action) {
    // æ—¥å¿—å¿…é¡»ä¿å­˜ï¼Œå³ä½¿å¤–éƒ¨äº‹åŠ¡å›æ»š
    logMapper.insert(new Log(action));
}
```

---

## 11. ğŸŒ åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†


### 11.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ


**ğŸ  ç”Ÿæ´»åœºæ™¯**
> ä½ åœ¨ç½‘ä¸Šè´­ç‰©ï¼š
> - è®¢å•ç³»ç»Ÿï¼šåˆ›å»ºè®¢å•
> - åº“å­˜ç³»ç»Ÿï¼šæ‰£å‡åº“å­˜  
> - æ”¯ä»˜ç³»ç»Ÿï¼šæ‰£æ¬¾
> 
> è¿™ä¸‰ä¸ªç³»ç»Ÿå¯èƒ½åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œå¦‚ä½•ä¿è¯è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ï¼Ÿè¿™å°±æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡

**ğŸ“– å•ä½“vsåˆ†å¸ƒå¼**

```
å•ä½“åº”ç”¨ï¼ˆä¸€ä¸ªæ•°æ®åº“ï¼‰:
OrderService â†’ åŒä¸€ä¸ªæ•°æ®åº“ â†’ æœ¬åœ°äº‹åŠ¡æå®š
    â†“
ç®€å•ï¼Œç”¨@Transactionalå°±è¡Œ

åˆ†å¸ƒå¼åº”ç”¨ï¼ˆå¤šä¸ªæ•°æ®åº“ï¼‰:
OrderService â†’ è®¢å•æ•°æ®åº“
    â†“
StockService â†’ åº“å­˜æ•°æ®åº“
    â†“
PayService â†’ æ”¯ä»˜æ•°æ®åº“
    â†“
å¤æ‚ï¼Œéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ
```

### 11.2 åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ


**ğŸ“Š å¸¸è§æ–¹æ¡ˆå¯¹æ¯”**

| æ–¹æ¡ˆ | åŸç† | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|----------|
| **2PCä¸¤é˜¶æ®µæäº¤** | åè°ƒè€…ç»Ÿä¸€æäº¤ | å¼ºä¸€è‡´æ€§ | æ€§èƒ½å·®ï¼Œå•ç‚¹æ•…éšœ | é‡‘èç³»ç»Ÿ |
| **TCC** | Try-Confirm-Cancel | æ€§èƒ½å¥½ | å®ç°å¤æ‚ | è®¢å•ç³»ç»Ÿ |
| **æœ¬åœ°æ¶ˆæ¯è¡¨** | æ¶ˆæ¯+å®šæ—¶ä»»åŠ¡ | ç®€å•å¯é  | æœ€ç»ˆä¸€è‡´æ€§ | ç”µå•†ç³»ç»Ÿ |
| **MQäº‹åŠ¡æ¶ˆæ¯** | æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯ | è§£è€¦æ€§å¥½ | ä¾èµ–MQ | é€šç”¨åœºæ™¯ |
| **Sagaæ¨¡å¼** | è¡¥å¿æœºåˆ¶ | é•¿äº‹åŠ¡å‹å¥½ | éœ€è¦è¡¥å¿é€»è¾‘ | å¤æ‚æµç¨‹ |

### 11.3 æ–¹æ¡ˆ1ï¼šæœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆæœ€å®ç”¨ï¼‰


**ğŸ’¡ åŸç†è¯´æ˜**
> åœ¨è®¢å•æ•°æ®åº“ä¸­å»ºä¸€ä¸ªæ¶ˆæ¯è¡¨ï¼Œå‘é€æ¶ˆæ¯å‰å…ˆæŠŠæ¶ˆæ¯å­˜åˆ°è¿™ä¸ªè¡¨é‡Œï¼Œç„¶åå®šæ—¶ä»»åŠ¡å»å‘é€ï¼Œå‘é€æˆåŠŸååˆ é™¤æ¶ˆæ¯

**ğŸ’» å®ç°ç¤ºä¾‹**

```java
/**
 * è®¢å•æœåŠ¡
 */
@Service
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private MessageMapper messageMapper;
    
    /**
     * åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
     */
    @Transactional
    public void createOrder(Order order) {
        // 1. ä¿å­˜è®¢å•
        orderMapper.insert(order);
        
        // 2. ä¿å­˜å¾…å‘é€çš„æ¶ˆæ¯
        Message message = new Message();
        message.setContent(JSON.toJSONString(order));
        message.setTopic("order.created");
        message.setStatus("PENDING");
        messageMapper.insert(message);
        
        // è¿™ä¸¤æ­¥åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥
    }
}

/**
 * å®šæ—¶ä»»åŠ¡ï¼šå‘é€æ¶ˆæ¯
 */
@Component
public class MessageSender {
    
    @Autowired
    private MessageMapper messageMapper;
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    /**
     * æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
     */
    @Scheduled(fixedDelay = 5000)
    public void sendPendingMessages() {
        // 1. æŸ¥è¯¢å¾…å‘é€çš„æ¶ˆæ¯
        List<Message> messages = messageMapper.selectPending();
        
        for (Message msg : messages) {
            try {
                // 2. å‘é€åˆ°MQ
                rabbitTemplate.convertAndSend(msg.getTopic(), msg.getContent());
                
                // 3. æ ‡è®°ä¸ºå·²å‘é€
                msg.setStatus("SENT");
                messageMapper.updateById(msg);
                
            } catch (Exception e) {
                // å‘é€å¤±è´¥ï¼Œä¸‹æ¬¡ç»§ç»­å°è¯•
                log.error("æ¶ˆæ¯å‘é€å¤±è´¥", e);
            }
        }
    }
}

/**
 * åº“å­˜æœåŠ¡ï¼šæ¶ˆè´¹æ¶ˆæ¯
 */
@Component
public class StockListener {
    
    @RabbitListener(queues = "order.created")
    public void handleOrderCreated(String orderJson) {
        Order order = JSON.parseObject(orderJson, Order.class);
        
        // æ‰£å‡åº“å­˜
        stockService.reduceStock(order.getProductId(), order.getQuantity());
    }
}
```

**æµç¨‹å›¾ç¤º**
```
è®¢å•æœåŠ¡                    æ¶ˆæ¯è¡¨                    MQ                    åº“å­˜æœåŠ¡
   |                         |                        |                        |
   |--åˆ›å»ºè®¢å•--------------->|                        |                        |
   |                         |                        |                        |
   |--ä¿å­˜æ¶ˆæ¯--------------->|                        |                        |
   |                         |                        |                        |
   |<--æäº¤æˆåŠŸ---------------|                        |                        |
   |                         |                        |                        |
å®šæ—¶ä»»åŠ¡                      |                        |                        |
   |--æŸ¥è¯¢å¾…å‘é€------------->|                        |                        |
   |                         |                        |                        |
   |--å‘é€æ¶ˆæ¯---------------------------------->|                        |
   |                         |                        |                        |
   |--æ›´æ–°çŠ¶æ€--------------->|                        |                        |
   |                         |                        |--æ¶ˆè´¹æ¶ˆæ¯------------->|
   |                         |                        |                        |
   |                         |                        |<--æ‰£å‡åº“å­˜-------------|
```

### 11.4 æ–¹æ¡ˆ2ï¼šSeataåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶


**ğŸ”§ Seataç®€ä»‹**
> Seataæ˜¯é˜¿é‡Œå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒå¤šç§æ¨¡å¼

**å¿«é€Ÿé›†æˆæ­¥éª¤**

```java
// 1. å¼•å…¥ä¾èµ–
<dependency>
    <groupId>io.seata</groupId>
    <artifactId>seata-spring-boot-starter</artifactId>
    <version>1.5.2</version>
</dependency>

// 2. é…ç½®Seata
@Configuration
public class SeataConfig {
    
    @Bean
    public GlobalTransactionScanner globalTransactionScanner() {
        return new GlobalTransactionScanner("my-service", "my-group");
    }
}

// 3. ä½¿ç”¨@GlobalTransactionalæ³¨è§£
@Service
public class OrderService {
    
    @Autowired
    private StockServiceClient stockServiceClient;  // Feignå®¢æˆ·ç«¯
    
    /**
     * å¼€å¯å…¨å±€äº‹åŠ¡
     */
    @GlobalTransactional
    public void createOrder(Order order) {
        // 1. æœ¬åœ°æ“ä½œï¼šä¿å­˜è®¢å•
        orderMapper.insert(order);
        
        // 2. è¿œç¨‹è°ƒç”¨ï¼šæ‰£å‡åº“å­˜
        stockServiceClient.reduceStock(order.getProductId(), order.getQuantity());
        
        // å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼ŒSeataä¼šåè°ƒæ‰€æœ‰æœåŠ¡å›æ»š
    }
}
```

**Seataå·¥ä½œæµç¨‹**
```
TCï¼ˆäº‹åŠ¡åè°ƒè€…ï¼‰
   â†“
TMï¼ˆäº‹åŠ¡ç®¡ç†è€…ï¼‰å¼€å¯å…¨å±€äº‹åŠ¡
   â†“
RM1ï¼ˆè®¢å•æœåŠ¡ï¼‰æ³¨å†Œåˆ†æ”¯äº‹åŠ¡ â†’ æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
   â†“
RM2ï¼ˆåº“å­˜æœåŠ¡ï¼‰æ³¨å†Œåˆ†æ”¯äº‹åŠ¡ â†’ æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
   â†“
æ‰€æœ‰åˆ†æ”¯æˆåŠŸ â†’ TMè¯·æ±‚TCæäº¤ â†’ TCé€šçŸ¥æ‰€æœ‰RMæäº¤
ä»»ä½•åˆ†æ”¯å¤±è´¥ â†’ TMè¯·æ±‚TCå›æ»š â†’ TCé€šçŸ¥æ‰€æœ‰RMå›æ»š
```

### 11.5 åˆ†å¸ƒå¼äº‹åŠ¡é€‰æ‹©å»ºè®®


**ğŸ¯ æ ¹æ®åœºæ™¯é€‰æ‹©**

```
é‡‘èç³»ç»Ÿï¼ˆå¼ºä¸€è‡´æ€§ï¼‰:
- ä½¿ç”¨Seataçš„ATæ¨¡å¼
- æˆ–è€…ä½¿ç”¨2PC

ç”µå•†ç³»ç»Ÿï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰:
- ä½¿ç”¨æœ¬åœ°æ¶ˆæ¯è¡¨
- æˆ–è€…ä½¿ç”¨å¯é æ¶ˆæ¯ï¼ˆRocketMQäº‹åŠ¡æ¶ˆæ¯ï¼‰

å¤æ‚ä¸šåŠ¡æµç¨‹:
- ä½¿ç”¨Sagaæ¨¡å¼
- æ¯ä¸ªæ­¥éª¤å®šä¹‰è¡¥å¿æ“ä½œ

é«˜æ€§èƒ½è¦æ±‚:
- ä½¿ç”¨TCCæ¨¡å¼
- è‡ªå·±å®ç°Try-Confirm-Cancel
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„åŸºç¡€æ¦‚å¿µ


**ğŸ”¸ äº‹åŠ¡å››å¤§ç‰¹æ€§ï¼ˆACIDï¼‰**
```
åŸå­æ€§ï¼šè¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆä¸åš
ä¸€è‡´æ€§ï¼šæ•°æ®ä»æ­£ç¡®åˆ°æ­£ç¡®
éš”ç¦»æ€§ï¼šäº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰°
æŒä¹…æ€§ï¼šæˆåŠŸåæ°¸ä¹…ä¿å­˜
```

**ğŸ”¸ ä¸¤ç§äº‹åŠ¡ç®¡ç†æ–¹å¼**
```
ç¼–ç¨‹å¼äº‹åŠ¡ï¼šæ‰‹åŠ¨æ§åˆ¶ï¼Œçµæ´»ä½†éº»çƒ¦
å£°æ˜å¼äº‹åŠ¡ï¼šæ³¨è§£æ§åˆ¶ï¼Œç®€å•å¤Ÿç”¨ï¼ˆæ¨èï¼‰
```

### 12.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ¯ äº‹åŠ¡ç®¡ç†å™¨é…ç½®**
```java
@Bean
public PlatformTransactionManager transactionManager(DataSource dataSource) {
    return new DataSourceTransactionManager(dataSource);
}
```

**ğŸ¯ å¼€å¯äº‹åŠ¡ç®¡ç†**
```java
@EnableTransactionManagement  // é…ç½®ç±»ä¸ŠåŠ è¿™ä¸ª
```

**ğŸ¯ æ–¹æ³•ä¸ŠåŠ æ³¨è§£**
```java
@Transactional  // æœ€ç®€å•çš„ç”¨æ³•
@Transactional(
    propagation = Propagation.REQUIRED,  // ä¼ æ’­è¡Œä¸º
    isolation = Isolation.DEFAULT,        // éš”ç¦»çº§åˆ«
    timeout = 30,                         // è¶…æ—¶æ—¶é—´
    readOnly = false,                     // æ˜¯å¦åªè¯»
    rollbackFor = Exception.class         // å›æ»šå¼‚å¸¸
)
```

### 12.3 ä¸ƒç§ä¼ æ’­è¡Œä¸ºé€Ÿè®°


| ä¼ æ’­è¡Œä¸º | è®°å¿†å£è¯€ | ä½¿ç”¨é¢‘ç‡ |
|---------|---------|---------|
| **REQUIRED** | æœ‰äº‹åŠ¡å°±ç”¨ï¼Œæ²¡æœ‰å°±å»º | â­â­â­â­â­ |
| **REQUIRES_NEW** | æ€»æ˜¯æ–°å»ºäº‹åŠ¡ | â­â­â­ |
| **SUPPORTS** | æœ‰å°±ç”¨ï¼Œæ²¡æœ‰æ‹‰å€’ | â­â­ |
| **NOT_SUPPORTED** | ä¸è¦äº‹åŠ¡ | â­ |
| **MANDATORY** | å¿…é¡»æœ‰äº‹åŠ¡ | â­ |
| **NEVER** | ä¸èƒ½æœ‰äº‹åŠ¡ | â­ |
| **NESTED** | åµŒå¥—äº‹åŠ¡ | â­â­ |

### 12.4 äº‹åŠ¡å¤±æ•ˆå…«å¤§åœºæ™¯


**ğŸ” å¿«é€Ÿæ’æŸ¥æ¸…å•**

```
1. âŒ æ•°æ®åº“å¼•æ“ä¸æ˜¯InnoDB
   âœ… ä½¿ç”¨InnoDBå¼•æ“

2. âŒ ç±»æ²¡æœ‰è¢«Springç®¡ç†  
   âœ… åŠ ä¸Š@Service/@Component

3. âŒ æ–¹æ³•ä¸æ˜¯public
   âœ… æ”¹æˆpublicæ–¹æ³•

4. âŒ è‡ªèº«è°ƒç”¨
   âœ… æ³¨å…¥è‡ªå·±æˆ–æ‹†åˆ†åˆ°ä¸åŒç±»

5. âŒ å¼‚å¸¸è¢«æ•è·æ²¡é‡æ–°æŠ›å‡º
   âœ… catchåé‡æ–°throwå¼‚å¸¸

6. âŒ æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹ä¸å¯¹
   âœ… æŒ‡å®šrollbackFor = Exception.class

7. âŒ å¤šçº¿ç¨‹è°ƒç”¨
   âœ… åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­

8. âŒ ä¼ æ’­è¡Œä¸ºè®¾ç½®é”™è¯¯
   âœ… æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„ä¼ æ’­è¡Œä¸º
```

### 12.5 åªè¯»äº‹åŠ¡ä¼˜åŒ–ç­–ç•¥


**ğŸ¯ ä½¿ç”¨åŸåˆ™**

```java
// æ‰€æœ‰æŸ¥è¯¢æ“ä½œéƒ½åŠ åªè¯»äº‹åŠ¡
@Transactional(readOnly = true)
public User getUser(Long id) {
    return userMapper.selectById(id);
}

// ç±»çº§åˆ«è®¾ç½®ï¼Œä¸ªåˆ«æ–¹æ³•è¦†ç›–
@Service
@Transactional(readOnly = true)
public class UserService {
    
    public User getById(Long id) {
        return userMapper.selectById(id);
    }
    
    @Transactional(readOnly = false)
    public void save(User user) {
        userMapper.insert(user);
    }
}
```

### 12.6 è¶…æ—¶æ—¶é—´è®¾ç½®å‚è€ƒ


**ğŸ“Š æ¨èé…ç½®è¡¨**

| æ“ä½œç±»å‹ | è¶…æ—¶æ—¶é—´ | å…¸å‹åœºæ™¯ |
|---------|---------|---------|
| ç®€å•CRUD | 5-10ç§’ | å•è¡¨æ“ä½œ |
| å¤æ‚æŸ¥è¯¢ | 30-60ç§’ | å¤šè¡¨å…³è”ã€ç»Ÿè®¡ |
| æ‰¹é‡æ“ä½œ | 60-300ç§’ | æ‰¹é‡å¯¼å…¥/æ›´æ–° |
| æŠ¥è¡¨ç”Ÿæˆ | 300-600ç§’ | å¤æ‚è®¡ç®— |

### 12.7 åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆé€‰æ‹©


**ğŸ¯ å†³ç­–æ ‘**

```
éœ€è¦å¼ºä¸€è‡´æ€§ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ Seata ATæ¨¡å¼ / 2PC
   â””â”€ å¦ â†’ æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ
            â”œâ”€ ç®€å•åœºæ™¯ â†’ æœ¬åœ°æ¶ˆæ¯è¡¨
            â”œâ”€ éœ€è¦è§£è€¦ â†’ MQäº‹åŠ¡æ¶ˆæ¯
            â””â”€ å¤æ‚æµç¨‹ â†’ Sagaæ¨¡å¼
```

### 12.8 å®æˆ˜æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**

```java
// 1. Serviceå±‚ç»Ÿä¸€åŠ äº‹åŠ¡
@Service
@Transactional(readOnly = true)  // é»˜è®¤åªè¯»
public class UserService {
    
    // æŸ¥è¯¢ç»§æ‰¿ç±»é…ç½®
    public User getById(Long id) {
        return userMapper.selectById(id);
    }
    
    // ä¿®æ”¹æ“ä½œè¦†ç›–é…ç½®
    @Transactional(
        readOnly = false,
        rollbackFor = Exception.class,
        timeout = 30
    )
    public void save(User user) {
        userMapper.insert(user);
    }
}

// 2. é¿å…å¤§äº‹åŠ¡
@Transactional
public void processOrders(List<Order> orders) {
    // âŒ ä¸å¥½ï¼šä¸€ä¸ªå¤§äº‹åŠ¡å¤„ç†æ‰€æœ‰è®¢å•
    for (Order order : orders) {
        processOrder(order);  // æ¯ä¸ªè®¢å•å¤„ç†å¯èƒ½å¾ˆæ…¢
    }
}

// âœ… æ”¹è¿›ï¼šæ¯ä¸ªè®¢å•ä¸€ä¸ªäº‹åŠ¡
public void processOrders(List<Order> orders) {
    for (Order order : orders) {
        processSingleOrder(order);  // å°äº‹åŠ¡
    }
}

@Transactional
public void processSingleOrder(Order order) {
    // å¤„ç†å•ä¸ªè®¢å•
}

// 3. å¼‚æ­¥æ“ä½œç§»å‡ºäº‹åŠ¡
@Transactional
public void createOrder(Order order) {
    // 1. æ•°æ®åº“æ“ä½œï¼ˆåœ¨äº‹åŠ¡ä¸­ï¼‰
    orderMapper.insert(order);
    
    // 2. æäº¤äº‹åŠ¡
    // ...
}

// å‘é€é‚®ä»¶ç§»åˆ°äº‹åŠ¡å¤–
@Async
public void sendEmailAsync(Long orderId) {
    // å¼‚æ­¥å‘é€ï¼Œä¸å½±å“äº‹åŠ¡
    emailService.sendOrderConfirmation(orderId);
}
```

**âŒ é¿å…çš„åšæ³•**

```java
// 1. é¿å…åœ¨äº‹åŠ¡ä¸­è°ƒç”¨è¿œç¨‹æœåŠ¡
@Transactional
public void badMethod() {
    orderMapper.insert(order);
    
    // âŒ ä¸å¥½ï¼šè¿œç¨‹è°ƒç”¨å¯èƒ½å¾ˆæ…¢ï¼Œå ç”¨äº‹åŠ¡æ—¶é—´
    restTemplate.postForObject(url, data, String.class);
}

// 2. é¿å…åœ¨äº‹åŠ¡ä¸­è¿›è¡Œæ–‡ä»¶æ“ä½œ
@Transactional
public void badFileOperation() {
    userMapper.insert(user);
    
    // âŒ ä¸å¥½ï¼šæ–‡ä»¶æ“ä½œæ…¢ä¸”ä¸å—äº‹åŠ¡æ§åˆ¶
    FileUtils.write(new File("user.txt"), user.toString());
}

// 3. é¿å…åœ¨å¾ªç¯ä¸­å¼€å¯äº‹åŠ¡
public void badLoop() {
    for (User user : users) {
        // âŒ ä¸å¥½ï¼šé¢‘ç¹å¼€å¯å…³é—­äº‹åŠ¡
        saveUserWithTransaction(user);
    }
}
```

### 12.9 æ ¸å¿ƒè®°å¿†å£è¯€


**ğŸ“ äº‹åŠ¡ç®¡ç†è®°å¿†è¦ç‚¹**

```
ğŸ”¸ äº‹åŠ¡ç‰¹æ€§ACIDè¦ç‰¢è®°
   åŸå­ä¸€è‡´éš”ç¦»ä¹…

ğŸ”¸ å£°æ˜å¼äº‹åŠ¡æœ€å¸¸ç”¨
   æ³¨è§£ä¸€åŠ äº‹åŠ¡æœ‰

ğŸ”¸ ä¼ æ’­è¡Œä¸ºä¸ƒç§ç±»
   REQUIREDæœ€å¸¸è§

ğŸ”¸ éš”ç¦»çº§åˆ«å››ä¸ªæ¡£
   é»˜è®¤å¤Ÿç”¨ä¸ç”¨æ”¹

ğŸ”¸ å¤±æ•ˆåœºæ™¯è¦é¿å…
   å…«ä¸ªå‘ç‚¹è¦è®°ç‰¢

ğŸ”¸ åªè¯»äº‹åŠ¡æ€§èƒ½å¥½
   æŸ¥è¯¢æ“ä½œè¦è®¾ç½®

ğŸ”¸ è¶…æ—¶æ—¶é—´è¦åˆç†
   æ ¹æ®åœºæ™¯æ¥è°ƒæ•´

ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡å¤æ‚ç‚¹
   é€‰å¯¹æ–¹æ¡ˆæœ€é‡è¦
```

### 12.10 å­¦ä¹ æ£€æŸ¥æ¸…å•


**ğŸ“‹ è‡ªæˆ‘æ£€æµ‹**

- [ ] èƒ½è§£é‡Šäº‹åŠ¡ACIDå››å¤§ç‰¹æ€§
- [ ] ä¼šé…ç½®å£°æ˜å¼äº‹åŠ¡
- [ ] ç†è§£ä¸ƒç§ä¼ æ’­è¡Œä¸ºçš„åŒºåˆ«
- [ ] çŸ¥é“å››ç§éš”ç¦»çº§åˆ«çš„åº”ç”¨åœºæ™¯
- [ ] èƒ½è¯†åˆ«äº‹åŠ¡å¤±æ•ˆçš„å¸¸è§åŸå› 
- [ ] ä¼šä½¿ç”¨åªè¯»äº‹åŠ¡ä¼˜åŒ–æŸ¥è¯¢
- [ ] èƒ½è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- [ ] ç†è§£äº‹åŠ¡åµŒå¥—çš„å¤„ç†æ–¹å¼
- [ ] äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆ
- [ ] èƒ½å†™å‡ºè§„èŒƒçš„äº‹åŠ¡ä»£ç 

### 12.11 è¿›é˜¶å­¦ä¹ è·¯å¾„


**ğŸš€ ä¸‹ä¸€æ­¥å­¦ä¹ æ–¹å‘**

```
åˆçº§é˜¶æ®µï¼ˆå½“å‰ï¼‰
    â†“
æŒæ¡åŸºç¡€äº‹åŠ¡é…ç½®
ç†è§£ä¼ æ’­è¡Œä¸ºå’Œéš”ç¦»çº§åˆ«
é¿å…å¸¸è§å¤±æ•ˆåœºæ™¯
    â†“
ä¸­çº§é˜¶æ®µ
    â†“
æ·±å…¥ç†è§£AOPå’Œä»£ç†æœºåˆ¶
å­¦ä¹ äº‹åŠ¡æºç å®ç°åŸç†
æŒæ¡æ€§èƒ½è°ƒä¼˜æŠ€å·§
    â†“
é«˜çº§é˜¶æ®µ
    â†“
åˆ†å¸ƒå¼äº‹åŠ¡æ·±å…¥ç ”ç©¶
è‡ªå®šä¹‰äº‹åŠ¡ç®¡ç†å™¨
å¤§è§„æ¨¡ç³»ç»Ÿäº‹åŠ¡è®¾è®¡
```

### 12.12 å¸¸è§é¢è¯•é—®é¢˜


**ğŸ¯ é«˜é¢‘é¢è¯•é¢˜**

**Q1ï¼šSpringäº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯æœ‰å“ªäº›ï¼Ÿ**
```
å›ç­”è¦ç‚¹ï¼š
1. æ•°æ®åº“å¼•æ“ä¸æ”¯æŒäº‹åŠ¡ï¼ˆMyISAMï¼‰
2. ç±»æ²¡æœ‰è¢«Springç®¡ç†ï¼ˆç¼ºå°‘@Serviceï¼‰
3. æ–¹æ³•ä¸æ˜¯public
4. è‡ªèº«è°ƒç”¨é—®é¢˜ï¼ˆthisè°ƒç”¨ï¼‰
5. å¼‚å¸¸è¢«æ•è·æ²¡é‡æ–°æŠ›å‡º
6. å¼‚å¸¸ç±»å‹ä¸åœ¨rollbackForä¸­
7. å¤šçº¿ç¨‹è°ƒç”¨
8. ä¼ æ’­è¡Œä¸ºè®¾ç½®é”™è¯¯
```

**Q2ï¼šREQUIREDå’ŒREQUIRES_NEWçš„åŒºåˆ«ï¼Ÿ**
```
REQUIREDï¼ˆé»˜è®¤ï¼‰ï¼š
- æœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±æ–°å»º
- å…±ç”¨ä¸€ä¸ªäº‹åŠ¡ï¼Œä¸€èµ·æäº¤å›æ»š
- é€‚åˆ99%çš„åœºæ™¯

REQUIRES_NEWï¼š
- æ€»æ˜¯æ–°å»ºç‹¬ç«‹äº‹åŠ¡
- æŒ‚èµ·å½“å‰äº‹åŠ¡ï¼Œç‹¬ç«‹æäº¤
- é€‚åˆæ—¥å¿—è®°å½•ã€å®¡è®¡ç­‰
```

**Q3ï¼šå¦‚ä½•ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§ï¼Ÿ**
```
æ–¹æ¡ˆé€‰æ‹©ï¼š
1. å¼ºä¸€è‡´æ€§ï¼šSeataã€2PC
2. æœ€ç»ˆä¸€è‡´æ€§ï¼šæœ¬åœ°æ¶ˆæ¯è¡¨ã€MQäº‹åŠ¡æ¶ˆæ¯
3. è¡¥å¿æœºåˆ¶ï¼šSagaã€TCC

æ¨èï¼šå¤§éƒ¨åˆ†åœºæ™¯ç”¨æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ
```

### 12.13 å®æˆ˜é¡¹ç›®ç»éªŒ


**ğŸ’¼ çœŸå®æ¡ˆä¾‹åˆ†äº«**

**æ¡ˆä¾‹1ï¼šè®¢å•ç³»ç»Ÿäº‹åŠ¡ä¼˜åŒ–**
```
é—®é¢˜ï¼šä¸‹å•æ¥å£å“åº”æ…¢
åŸå› ï¼šäº‹åŠ¡ä¸­åŒ…å«äº†çŸ­ä¿¡å‘é€
è§£å†³ï¼š
1. çŸ­ä¿¡å‘é€æ”¹ä¸ºå¼‚æ­¥
2. äº‹åŠ¡åªåŒ…å«æ ¸å¿ƒæ•°æ®åº“æ“ä½œ
3. å“åº”æ—¶é—´ä»3ç§’é™åˆ°500ms
```

**æ¡ˆä¾‹2ï¼šæ‰¹é‡å¯¼å…¥äº‹åŠ¡å¤„ç†**
```
é—®é¢˜ï¼š10ä¸‡æ¡æ•°æ®å¯¼å…¥å¤±è´¥å…¨éƒ¨å›æ»š
åŸå› ï¼šå•ä¸ªå¤§äº‹åŠ¡ï¼Œéƒ¨åˆ†å¤±è´¥å½±å“å…¨éƒ¨
è§£å†³ï¼š
1. ä½¿ç”¨NESTEDåµŒå¥—äº‹åŠ¡
2. æ¯æ¡æ•°æ®ç‹¬ç«‹äº‹åŠ¡
3. å¤±è´¥è®°å½•æ—¥å¿—ï¼Œç»§ç»­å¤„ç†
4. æˆåŠŸç‡ä»0%æå‡åˆ°99%
```

**æ¡ˆä¾‹3ï¼šåˆ†å¸ƒå¼äº‹åŠ¡æ”¹é€ **
```
é—®é¢˜ï¼šè®¢å•å’Œåº“å­˜åœ¨ä¸åŒæ•°æ®åº“ï¼Œæ•°æ®ä¸ä¸€è‡´
åŸå› ï¼šæ²¡æœ‰åˆ†å¸ƒå¼äº‹åŠ¡æ§åˆ¶
è§£å†³ï¼š
1. å¼•å…¥æœ¬åœ°æ¶ˆæ¯è¡¨
2. å®šæ—¶ä»»åŠ¡ä¿è¯æ¶ˆæ¯æŠ•é€’
3. æ¶ˆè´¹ç«¯å¹‚ç­‰å¤„ç†
4. å®ç°æœ€ç»ˆä¸€è‡´æ€§
```

---

## ğŸ“ æ€»ç»“


é€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œä½ åº”è¯¥æŒæ¡äº†ï¼š

**âœ… åŸºç¡€èƒ½åŠ›**
- èƒ½å¤Ÿé…ç½®å’Œä½¿ç”¨Springå£°æ˜å¼äº‹åŠ¡
- ç†è§£äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼ˆACIDï¼‰
- æŒæ¡ä¸ƒç§ä¼ æ’­è¡Œä¸ºçš„åº”ç”¨åœºæ™¯
- äº†è§£å››ç§éš”ç¦»çº§åˆ«çš„åŒºåˆ«

**âœ… è¿›é˜¶èƒ½åŠ›**
- èƒ½å¤Ÿè¯†åˆ«å’Œè§£å†³äº‹åŠ¡å¤±æ•ˆé—®é¢˜
- ä¼šä½¿ç”¨åªè¯»äº‹åŠ¡ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- èƒ½å¤Ÿå¤„ç†äº‹åŠ¡åµŒå¥—çš„å¤æ‚åœºæ™¯
- äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆ

**âœ… å®æˆ˜èƒ½åŠ›**
- èƒ½å†™å‡ºè§„èŒƒçš„äº‹åŠ¡ç®¡ç†ä»£ç 
- ä¼šæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„ä¼ æ’­è¡Œä¸º
- èƒ½å¤Ÿä¼˜åŒ–äº‹åŠ¡æ€§èƒ½
- æŒæ¡äº‹åŠ¡æ•…éšœæ’æŸ¥æ–¹æ³•

**ğŸ¯ å…³é”®è¦ç‚¹**
1. **å£°æ˜å¼äº‹åŠ¡**æ˜¯é¦–é€‰ï¼Œç®€å•å¤Ÿç”¨
2. **REQUIREDä¼ æ’­è¡Œä¸º**é€‚åˆ99%åœºæ™¯
3. **äº‹åŠ¡å¤±æ•ˆ**è¦ç‰¹åˆ«æ³¨æ„è‡ªèº«è°ƒç”¨é—®é¢˜
4. **åªè¯»äº‹åŠ¡**èƒ½æ˜¾è‘—æå‡æŸ¥è¯¢æ€§èƒ½
5. **åˆ†å¸ƒå¼äº‹åŠ¡**æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©æ–¹æ¡ˆ

**ğŸ’¡ ä¸€å¥è¯æ€»ç»“**
> äº‹åŠ¡ç®¡ç†çš„æœ¬è´¨æ˜¯ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼ŒSpringé€šè¿‡AOPä»£ç†å®ç°å£°æ˜å¼äº‹åŠ¡ï¼ŒæŒæ¡ä¼ æ’­è¡Œä¸ºå’Œå¤±æ•ˆåœºæ™¯æ˜¯æ ¸å¿ƒï¼Œåˆ†å¸ƒå¼åœºæ™¯éœ€è¦é€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§æ–¹æ¡ˆã€‚

---

## ğŸ“š æ‰©å±•é˜…è¯»


**æ¨èèµ„æº**
- ğŸ“– ã€ŠSpringå®æˆ˜ã€‹äº‹åŠ¡ç®¡ç†ç« èŠ‚
- ğŸ“– ã€Šæ·±å…¥ç†è§£Springäº‹åŠ¡åŸç†ã€‹
- ğŸ¥ Bç«™ï¼šSpringäº‹åŠ¡æºç è§£æ
- ğŸ“ å®˜æ–¹æ–‡æ¡£ï¼šSpring Transaction Management

**ç›¸å…³ä¸»é¢˜**
- [Spring AOPåŸç†](#)
- [MyBatisäºŒçº§ç¼“å­˜](#)
- [åˆ†å¸ƒå¼é”å®ç°](#)
- [æ•°æ®åº“äº‹åŠ¡éš”ç¦»çº§åˆ«](#)