---
title: 8ã€å¸¸è§é—®é¢˜æ’æŸ¥è§£å†³
---
## ğŸ“š ç›®å½•

1. [å¾ªç¯ä¾èµ–é—®é¢˜](#1-å¾ªç¯ä¾èµ–é—®é¢˜)
2. [æ‡’åŠ è½½å¼‚å¸¸å¤„ç†](#2-æ‡’åŠ è½½å¼‚å¸¸å¤„ç†)
3. [äº‹åŠ¡å¤±æ•ˆåœºæ™¯](#3-äº‹åŠ¡å¤±æ•ˆåœºæ™¯)
4. [N+1æŸ¥è¯¢ä¼˜åŒ–](#4-n1æŸ¥è¯¢ä¼˜åŒ–)
5. [å†…å­˜æ³„æ¼æ’æŸ¥](#5-å†…å­˜æ³„æ¼æ’æŸ¥)
6. [æ­»é”é—®é¢˜å¤„ç†](#6-æ­»é”é—®é¢˜å¤„ç†)
7. [æ€§èƒ½é—®é¢˜è¯Šæ–­](#7-æ€§èƒ½é—®é¢˜è¯Šæ–­)
8. [æ•°æ®ä¸€è‡´æ€§é—®é¢˜](#8-æ•°æ®ä¸€è‡´æ€§é—®é¢˜)
9. [å¹¶å‘å®‰å…¨é—®é¢˜](#9-å¹¶å‘å®‰å…¨é—®é¢˜)
10. [é›†æˆæµ‹è¯•é—®é¢˜](#10-é›†æˆæµ‹è¯•é—®é¢˜)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ å¾ªç¯ä¾èµ–é—®é¢˜


### 1.1 ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–ï¼Ÿ


**é€šä¿—æ¯”å–»**ï¼šå°±åƒ"é¸¡ç”Ÿè›‹ï¼Œè›‹ç”Ÿé¸¡"çš„é—®é¢˜

```
Aç±»éœ€è¦Bç±»ï¼š
public class A {
    @Autowired
    private B b;  // Aä¾èµ–B
}

Bç±»éœ€è¦Aç±»ï¼š
public class B {
    @Autowired
    private A a;  // Bä¾èµ–A
}

Springå®¹å™¨æ‡µäº†ï¼š
æƒ³åˆ›å»ºA â†’ éœ€è¦å…ˆæœ‰B
æƒ³åˆ›å»ºB â†’ éœ€è¦å…ˆæœ‰A
è°ä¹Ÿåˆ›å»ºä¸äº†ï¼
```

**å¾ªç¯ä¾èµ–çš„ä¸‰ç§æƒ…å†µ**ï¼š

```
æƒ…å†µä¸€ï¼šæ„é€ å™¨æ³¨å…¥ï¼ˆæ— æ³•è§£å†³ï¼‰
A(B b) â†â†’ B(A a)
Springå¯åŠ¨ç›´æ¥æŠ¥é”™ âŒ

æƒ…å†µäºŒï¼šå±æ€§æ³¨å…¥ï¼ˆå¯ä»¥è§£å†³ï¼‰
@Autowired B b â†â†’ @Autowired A a
Springé€šè¿‡ä¸‰çº§ç¼“å­˜è§£å†³ âœ…

æƒ…å†µä¸‰ï¼šå¤šä¾‹Beanï¼ˆæ— æ³•è§£å†³ï¼‰
@Scope("prototype") â†â†’ @Scope("prototype")
æ¯æ¬¡éƒ½åˆ›å»ºæ–°å¯¹è±¡ï¼Œæ— æ³•ç¼“å­˜ âŒ
```

### 1.2 å¾ªç¯ä¾èµ–çš„è¯†åˆ«


**é”™è¯¯ä¿¡æ¯ç¤ºä¾‹**ï¼š
```
Error creating bean with name 'serviceA': 
Requested bean is currently in creation: 
Is there an unresolvable circular reference?

ç¿»è¯‘ï¼š
åˆ›å»ºserviceAæ—¶å‡ºé”™
è¿™ä¸ªBeanæ­£åœ¨åˆ›å»ºä¸­ï¼ˆè¯´æ˜å¾ªç¯äº†ï¼‰
æ˜¯ä¸æ˜¯æœ‰æ— æ³•è§£å†³çš„å¾ªç¯å¼•ç”¨ï¼Ÿ
```

**å¿«é€Ÿå®šä½æ–¹æ³•**ï¼š
```
æ­¥éª¤ä¸€ï¼šçœ‹é”™è¯¯æ—¥å¿—
â”œâ”€â”€ æ‰¾åˆ°"circular reference"å…³é”®å­—
â””â”€â”€ æŸ¥çœ‹æ¶‰åŠçš„Beanåç§°

æ­¥éª¤äºŒï¼šæ£€æŸ¥ä¾èµ–å…³ç³»
ServiceA â†’ ServiceB â†’ ServiceC â†’ ServiceA
         â†‘_______________________|
         å‘ç°å¾ªç¯ï¼

æ­¥éª¤ä¸‰ï¼šç”»ä¾èµ–å›¾
ç”¨ç¬”åœ¨çº¸ä¸Šç”»ç®­å¤´ï¼Œå¾ˆå®¹æ˜“å‘ç°ç¯
```

### 1.3 è§£å†³æ–¹æ¡ˆ


**æ–¹æ¡ˆä¸€ï¼šæ”¹ç”¨Setteræ³¨å…¥ï¼ˆæ¨èï¼‰**

```java
// âŒ æ„é€ å™¨æ³¨å…¥ï¼ˆä¼šæŠ¥é”™ï¼‰
@Service
public class ServiceA {
    private ServiceB serviceB;
    
    public ServiceA(ServiceB serviceB) {
        this.serviceB = serviceB;
    }
}

// âœ… Setteræ³¨å…¥ï¼ˆå¯ä»¥è§£å†³ï¼‰
@Service
public class ServiceA {
    private ServiceB serviceB;
    
    @Autowired
    public void setServiceB(ServiceB serviceB) {
        this.serviceB = serviceB;
    }
}
```

**æ–¹æ¡ˆäºŒï¼šä½¿ç”¨@Lazyå»¶è¿ŸåŠ è½½**

```java
@Service
public class ServiceA {
    private ServiceB serviceB;
    
    // å»¶è¿ŸåŠ è½½ï¼šç”¨åˆ°æ—¶å†æ³¨å…¥
    public ServiceA(@Lazy ServiceB serviceB) {
        this.serviceB = serviceB;
    }
}
```

**æ–¹æ¡ˆä¸‰ï¼šé‡æ„ä»£ç ç»“æ„ï¼ˆæœ€ä½³ï¼‰**

```
é—®é¢˜æ ¹æºï¼šè®¾è®¡ä¸åˆç†
Aä¾èµ–Bï¼ŒBä¾èµ–A â†’ è¯´æ˜èŒè´£åˆ’åˆ†æœ‰é—®é¢˜

é‡æ„æ€è·¯ï¼š
1. æå–å…¬å…±é€»è¾‘åˆ°æ–°ç±»C
   A â†’ C â† B ï¼ˆè§£é™¤å¾ªç¯ï¼‰

2. ä½¿ç”¨äº‹ä»¶æœºåˆ¶è§£è€¦
   Aå‘å¸ƒäº‹ä»¶ â†’ Bç›‘å¬äº‹ä»¶

3. å¼•å…¥æ¥å£éš”ç¦»
   A â†’ IBæ¥å£ â† Bå®ç°
```

### 1.4 é¢„é˜²å¾ªç¯ä¾èµ–


**è®¾è®¡åŸåˆ™**ï¼š
```
âœ… å•ä¸€èŒè´£åŸåˆ™
æ¯ä¸ªç±»åªåšä¸€ä»¶äº‹ï¼Œå‡å°‘ä¾èµ–

âœ… ä¾èµ–å€’ç½®åŸåˆ™
é«˜å±‚ä¸ä¾èµ–ä½å±‚ï¼Œéƒ½ä¾èµ–æŠ½è±¡

âœ… æœ€å°çŸ¥é“åŸåˆ™
Aä¸éœ€è¦çŸ¥é“Bçš„å†…éƒ¨å®ç°

å®é™…åº”ç”¨ï¼š
Controller â†’ Service â†’ Dao
       â†“         â†“       â†“
   å•å‘ä¾èµ–ï¼Œä¸ä¼šå¾ªç¯
```

---

## 2. ğŸ¦¥ æ‡’åŠ è½½å¼‚å¸¸å¤„ç†


### 2.1 ä»€ä¹ˆæ˜¯æ‡’åŠ è½½å¼‚å¸¸ï¼Ÿ


**åœºæ™¯é‡ç°**ï¼š
```
æƒ…å†µï¼šæŸ¥è¯¢è®¢å•ï¼ŒåŒæ—¶è¦æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯

Orderå®ä½“ï¼š
@Entity
public class Order {
    private Long id;
    
    @ManyToOne(fetch = FetchType.LAZY)  // æ‡’åŠ è½½
    private User user;  // å…³è”çš„ç”¨æˆ·
}

Controllerä¸­ï¼š
Order order = orderService.getById(1);
return order.getUser().getName();  // ğŸ’¥ æŠ›å¼‚å¸¸ï¼

é”™è¯¯ï¼šLazyInitializationException
åŸå› ï¼šSessionå·²å…³é—­ï¼Œæ— æ³•åŠ è½½Useræ•°æ®
```

**ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ**
```
æ‰§è¡Œæµç¨‹ï¼š
1. ServiceæŸ¥è¯¢Order â†’ æ‰“å¼€æ•°æ®åº“è¿æ¥
2. è¿”å›Orderå¯¹è±¡    â†’ å…³é—­æ•°æ®åº“è¿æ¥
3. Controllerè·å–User â†’ éœ€è¦æŸ¥æ•°æ®åº“
4. ä½†è¿æ¥å·²å…³é—­ï¼   â†’ æŠ¥é”™

æ‡’åŠ è½½çš„ç‰¹ç‚¹ï¼š
ç”¨åˆ°æ—¶æ‰æŸ¥è¯¢ï¼Œä½†æ­¤æ—¶Sessionå¯èƒ½å·²å…³é—­
```

### 2.2 è§£å†³æ–¹æ¡ˆå¯¹æ¯”


| æ–¹æ¡ˆ | å®ç°æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|------|---------|
| **ç«‹å³åŠ è½½** | `FetchType.EAGER` | ç®€å•ç›´æ¥ | å¯èƒ½æŸ¥è¯¢æ— ç”¨æ•°æ® | å…³è”æ•°æ®å¿…å®šä½¿ç”¨ |
| **JOIN FETCH** | JPQLæ‰‹åŠ¨å…³è” | ä¸€æ¬¡æŸ¥è¯¢å®Œæˆ | SQLå¤æ‚åº¦å¢åŠ  | éœ€è¦å®Œæ•´æ•°æ® |
| **Open Session in View** | æ‰©å±•Sessionå‘¨æœŸ | æ— éœ€æ”¹ä»£ç  | å¯èƒ½æ€§èƒ½é—®é¢˜ | å¿«é€Ÿè§£å†³ |
| **DTOè½¬æ¢** | æå‰åŠ è½½æ‰€éœ€æ•°æ® | æ€§èƒ½æœ€ä¼˜ | ä»£ç é‡å¢åŠ  | ç”Ÿäº§ç¯å¢ƒæ¨è |

**æ–¹æ¡ˆä¸€ï¼šæ”¹ä¸ºç«‹å³åŠ è½½**
```java
@Entity
public class Order {
    @ManyToOne(fetch = FetchType.EAGER)  // ç«‹å³åŠ è½½
    private User user;
}

// æŸ¥Orderæ—¶è‡ªåŠ¨å…³è”æŸ¥User
// é€‚åˆï¼šUseræ•°æ®æ€»æ˜¯éœ€è¦çš„æƒ…å†µ
```

**æ–¹æ¡ˆäºŒï¼šä½¿ç”¨JOIN FETCH**
```java
@Repository
public interface OrderRepository extends JpaRepository<Order, Long> {
    @Query("SELECT o FROM Order o JOIN FETCH o.user WHERE o.id = :id")
    Order findByIdWithUser(@Param("id") Long id);
}

// ä¸€æ¡SQLæŸ¥è¯¢å®Œæˆï¼Œé¿å…æ‡’åŠ è½½
```

**æ–¹æ¡ˆä¸‰ï¼šDTOæ¨¡å¼ï¼ˆæ¨èï¼‰**
```java
// DTOï¼šæ•°æ®ä¼ è¾“å¯¹è±¡
public class OrderDTO {
    private Long orderId;
    private String orderNo;
    private String userName;  // ç”¨æˆ·å
    private String userPhone; // ç”¨æˆ·æ‰‹æœº
    
    // åœ¨Serviceå±‚ç»„è£…æ•°æ®
}

@Service
public class OrderService {
    public OrderDTO getOrderDetail(Long id) {
        Order order = orderRepository.findById(id).get();
        User user = order.getUser();  // åœ¨Serviceå†…è®¿é—®ï¼ŒSessionæœªå…³é—­
        
        // è½¬æ¢ä¸ºDTOè¿”å›
        return new OrderDTO(order, user);
    }
}
```

### 2.3 é…ç½®Open Session in View


**å¼€å¯æ–¹å¼**ï¼š
```yaml
# application.yml
spring:
  jpa:
    open-in-view: true  # é»˜è®¤å¼€å¯

# æ•ˆæœï¼š
# Sessionä¿æŒæ‰“å¼€ï¼Œç›´åˆ°è¯·æ±‚ç»“æŸ
# åœ¨Controller/Viewä¸­ä¹Ÿèƒ½æ‡’åŠ è½½
```

**æ³¨æ„äº‹é¡¹**ï¼š
```
âš ï¸ æ½œåœ¨é—®é¢˜ï¼š
1. æ•°æ®åº“è¿æ¥å ç”¨æ—¶é—´é•¿
2. å¯èƒ½å¯¼è‡´N+1æŸ¥è¯¢é—®é¢˜
3. ä¸é€‚åˆé«˜å¹¶å‘åœºæ™¯

ğŸ’¡ å»ºè®®ï¼š
å¼€å‘ç¯å¢ƒï¼šå¯ä»¥å¼€å¯ï¼Œæ–¹ä¾¿è°ƒè¯•
ç”Ÿäº§ç¯å¢ƒï¼šå»ºè®®å…³é—­ï¼Œä½¿ç”¨DTOæ¨¡å¼
```

---

## 3. ğŸ’¸ äº‹åŠ¡å¤±æ•ˆåœºæ™¯


### 3.1 äº‹åŠ¡ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ


**äº‹åŠ¡çš„ä½œç”¨**ï¼šä¿è¯æ“ä½œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥

```
è½¬è´¦åœºæ™¯ï¼š
public void transfer(Long from, Long to, int money) {
    accountDao.minus(from, money);  // Aæ‰£é’±
    accountDao.add(to, money);      // BåŠ é’±
}

æ²¡æœ‰äº‹åŠ¡ï¼š
Aæ‰£é’±æˆåŠŸ â†’ ç¨‹åºå´©æºƒ â†’ Bæ²¡åŠ é’±
é’±å‡­ç©ºæ¶ˆå¤±äº†ï¼

æœ‰äº‹åŠ¡ï¼š
Aæ‰£é’± â†’ å‡ºé”™ â†’ è‡ªåŠ¨å›æ»š â†’ Açš„é’±ä¹Ÿæ²¡æ‰£
ä¿è¯æ•°æ®ä¸€è‡´æ€§ âœ…
```

### 3.2 å¸¸è§å¤±æ•ˆåœºæ™¯


**åœºæ™¯ä¸€ï¼šæ–¹æ³•ä¸æ˜¯public**
```java
// âŒ äº‹åŠ¡å¤±æ•ˆ
@Service
public class UserService {
    @Transactional
    private void updateUser() {  // privateæ–¹æ³•
        // äº‹åŠ¡ä¸ç”Ÿæ•ˆï¼
    }
}

// âœ… æ­£ç¡®å†™æ³•
@Transactional
public void updateUser() {  // å¿…é¡»æ˜¯public
    // äº‹åŠ¡æ­£å¸¸å·¥ä½œ
}

åŸå› ï¼š
Springç”¨ä»£ç†å®ç°äº‹åŠ¡ï¼Œåªèƒ½ä»£ç†publicæ–¹æ³•
```

**åœºæ™¯äºŒï¼šè‡ªè°ƒç”¨é—®é¢˜**
```java
@Service
public class OrderService {
    // æ–¹æ³•Aè°ƒç”¨æ–¹æ³•B
    public void createOrder() {
        // ... ä¸€äº›é€»è¾‘
        this.updateStock();  // âŒ äº‹åŠ¡å¤±æ•ˆï¼
    }
    
    @Transactional
    public void updateStock() {
        // äº‹åŠ¡ä¸ç”Ÿæ•ˆ
    }
}

é—®é¢˜åˆ†æï¼š
createOrder()           updateStock()
   â†“                       â†“
æ™®é€šå¯¹è±¡è°ƒç”¨  â†’  ä¸èµ°ä»£ç†  â†’  äº‹åŠ¡å¤±æ•ˆ

æ­£ç¡®åšæ³•ï¼š
@Autowired
private OrderService self;  // æ³¨å…¥è‡ªå·±

public void createOrder() {
    self.updateStock();  // âœ… é€šè¿‡ä»£ç†è°ƒç”¨
}
```

**åœºæ™¯ä¸‰ï¼šå¼‚å¸¸è¢«æ•è·**
```java
// âŒ äº‹åŠ¡ä¸ä¼šå›æ»š
@Transactional
public void saveData() {
    try {
        // ä¿å­˜æ•°æ®
        userDao.save(user);
        // å‘ç”Ÿå¼‚å¸¸
        int i = 1 / 0;
    } catch (Exception e) {
        // å¼‚å¸¸è¢«åƒæ‰äº†
        log.error("å‡ºé”™äº†", e);
    }
    // äº‹åŠ¡ä¸ä¼šå›æ»šï¼
}

// âœ… æ­£ç¡®å¤„ç†
@Transactional
public void saveData() {
    try {
        userDao.save(user);
        int i = 1 / 0;
    } catch (Exception e) {
        log.error("å‡ºé”™äº†", e);
        throw e;  // é‡æ–°æŠ›å‡ºå¼‚å¸¸
    }
}
```

**åœºæ™¯å››ï¼šå¼‚å¸¸ç±»å‹ä¸åŒ¹é…**
```java
// âŒ äº‹åŠ¡ä¸å›æ»š
@Transactional  // é»˜è®¤åªå›æ»šRuntimeException
public void updateData() throws Exception {
    userDao.update(user);
    throw new Exception("æ£€æŸ¥å¼‚å¸¸");  // ä¸ä¼šå›æ»š
}

// âœ… æŒ‡å®šå¼‚å¸¸ç±»å‹
@Transactional(rollbackFor = Exception.class)
public void updateData() throws Exception {
    userDao.update(user);
    throw new Exception("æ£€æŸ¥å¼‚å¸¸");  // ä¼šå›æ»š
}
```

### 3.3 äº‹åŠ¡ä¼ æ’­è¡Œä¸ºé—®é¢˜


**ä¼ æ’­è¡Œä¸ºå¯¹æ¯”**ï¼š
```
åœºæ™¯ï¼šæ–¹æ³•Aè°ƒç”¨æ–¹æ³•B

REQUIREDï¼ˆé»˜è®¤ï¼‰ï¼š
Aæœ‰äº‹åŠ¡ â†’ BåŠ å…¥Açš„äº‹åŠ¡ â†’ åŒä¸€ä¸ªäº‹åŠ¡
Aæ— äº‹åŠ¡ â†’ Bæ–°å»ºäº‹åŠ¡

REQUIRES_NEWï¼š
Bæ€»æ˜¯æ–°å»ºäº‹åŠ¡ â†’ ä¸¤ä¸ªç‹¬ç«‹äº‹åŠ¡
Aå›æ»šä¸å½±å“Bï¼ŒBå›æ»šä¸å½±å“A

NESTEDï¼š
Bä½¿ç”¨åµŒå¥—äº‹åŠ¡ â†’ æœ‰ä¿å­˜ç‚¹
Bå›æ»šåˆ°ä¿å­˜ç‚¹ï¼ŒAå¯ä»¥ç»§ç»­
Aå›æ»šï¼ŒBä¹Ÿå›æ»š
```

**å®é™…åº”ç”¨**ï¼š
```java
@Service
public class OrderService {
    @Autowired
    private LogService logService;
    
    @Transactional
    public void createOrder() {
        // ä¿å­˜è®¢å•
        orderDao.save(order);
        
        // è®°å½•æ—¥å¿—ï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼‰
        logService.saveLog(log);
        
        // å³ä½¿è®¢å•ä¿å­˜å¤±è´¥ï¼Œæ—¥å¿—ä¹Ÿè¦è®°å½•æˆåŠŸ
    }
}

@Service
public class LogService {
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void saveLog(Log log) {
        logDao.save(log);  // ç‹¬ç«‹äº‹åŠ¡
    }
}
```

---

## 4. ğŸ” N+1æŸ¥è¯¢ä¼˜åŒ–


### 4.1 ä»€ä¹ˆæ˜¯N+1æŸ¥è¯¢é—®é¢˜ï¼Ÿ


**é—®é¢˜æ¼”ç¤º**ï¼š
```
éœ€æ±‚ï¼šæŸ¥è¯¢10ä¸ªè®¢å•ï¼Œæ˜¾ç¤ºè®¢å•å’Œç”¨æˆ·ä¿¡æ¯

æ‰§è¡Œçš„SQLï¼š
1. SELECT * FROM order LIMIT 10          -- æŸ¥è¯¢10ä¸ªè®¢å•ï¼ˆ1æ¬¡ï¼‰
2. SELECT * FROM user WHERE id = 1       -- æŸ¥è¯¢ç¬¬1ä¸ªè®¢å•çš„ç”¨æˆ·
3. SELECT * FROM user WHERE id = 2       -- æŸ¥è¯¢ç¬¬2ä¸ªè®¢å•çš„ç”¨æˆ·
4. SELECT * FROM user WHERE id = 3       -- ...
   ...
11. SELECT * FROM user WHERE id = 10     -- æŸ¥è¯¢ç¬¬10ä¸ªè®¢å•çš„ç”¨æˆ·

æ€»å…±ï¼š1 + 10 = 11æ¬¡æŸ¥è¯¢
è¿™å°±æ˜¯N+1é—®é¢˜ï¼ˆ1æ¬¡è®¢å•æŸ¥è¯¢ + Næ¬¡ç”¨æˆ·æŸ¥è¯¢ï¼‰
```

**ä¸ºä»€ä¹ˆè¿™æ ·æ…¢ï¼Ÿ**
```
é—®é¢˜åˆ†æï¼š
æ¯æ¬¡æŸ¥è¯¢éƒ½è¦ï¼š
â”œâ”€â”€ å»ºç«‹æ•°æ®åº“è¿æ¥
â”œâ”€â”€ è§£æSQL
â”œâ”€â”€ æ‰§è¡ŒæŸ¥è¯¢
â””â”€â”€ è¿”å›ç»“æœ

10æ¬¡æŸ¥è¯¢ = 10å€å¼€é”€
å¦‚æœæœ‰100ä¸ªè®¢å• = 101æ¬¡æŸ¥è¯¢ï¼
```

### 4.2 è§£å†³æ–¹æ¡ˆ


**æ–¹æ¡ˆä¸€ï¼šJOINæŸ¥è¯¢ï¼ˆä¸€æ¬¡æå®šï¼‰**
```java
// MyBatisæ–¹å¼
@Select("""
    SELECT o.*, u.name, u.phone 
    FROM t_order o 
    LEFT JOIN t_user u ON o.user_id = u.id
    WHERE o.id IN (...)
""")
List<OrderVO> findOrdersWithUser(List<Long> ids);

// 1æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰æ•°æ®
```

**æ–¹æ¡ˆäºŒï¼šåˆ†æ­¥æŸ¥è¯¢ + æ‰¹é‡åŠ è½½**
```java
// ç¬¬ä¸€æ­¥ï¼šæŸ¥è¯¢è®¢å•
List<Order> orders = orderDao.findAll();

// ç¬¬äºŒæ­¥ï¼šæ”¶é›†ç”¨æˆ·ID
Set<Long> userIds = orders.stream()
    .map(Order::getUserId)
    .collect(Collectors.toSet());

// ç¬¬ä¸‰æ­¥ï¼šæ‰¹é‡æŸ¥è¯¢ç”¨æˆ·
List<User> users = userDao.findByIds(userIds);

// ç¬¬å››æ­¥ï¼šå†…å­˜ç»„è£…
Map<Long, User> userMap = users.stream()
    .collect(Collectors.toMap(User::getId, u -> u));

orders.forEach(order -> {
    order.setUser(userMap.get(order.getUserId()));
});

// æ€»å…±2æ¬¡æŸ¥è¯¢ï¼Œè€Œä¸æ˜¯N+1æ¬¡
```

**æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨MyBatisçš„æ‡’åŠ è½½**
```xml
<!-- mapper.xml -->
<resultMap id="OrderMap" type="Order">
    <id column="id" property="id"/>
    <result column="order_no" property="orderNo"/>
    
    <!-- å…³è”æŸ¥è¯¢ï¼Œé…ç½®æ‡’åŠ è½½ -->
    <association property="user" 
                 column="user_id"
                 select="findUserById"
                 fetchType="lazy"/>
</resultMap>

<!-- é…ç½®å…¨å±€æ‡’åŠ è½½ -->
<settings>
    <setting name="lazyLoadingEnabled" value="true"/>
    <setting name="aggressiveLazyLoading" value="false"/>
</settings>
```

### 4.3 æ€§èƒ½å¯¹æ¯”


**å®æµ‹æ•°æ®**ï¼š
```
æµ‹è¯•ç¯å¢ƒï¼š100ä¸ªè®¢å•ï¼Œæ¯ä¸ªå…³è”ç”¨æˆ·

N+1æŸ¥è¯¢ï¼š
â””â”€â”€ æ‰§è¡Œ101æ¬¡SQL
â””â”€â”€ æ€»è€—æ—¶ï¼š1500ms
â””â”€â”€ æ•°æ®åº“å‹åŠ›å¤§

JOINä¼˜åŒ–ï¼š
â””â”€â”€ æ‰§è¡Œ1æ¬¡SQL
â””â”€â”€ æ€»è€—æ—¶ï¼š80ms
â””â”€â”€ æ€§èƒ½æå‡ï¼š18å€

åˆ†æ­¥æ‰¹é‡ï¼š
â””â”€â”€ æ‰§è¡Œ2æ¬¡SQL
â””â”€â”€ æ€»è€—æ—¶ï¼š120ms
â””â”€â”€ æ€§èƒ½æå‡ï¼š12å€
```

---

## 5. ğŸ’¾ å†…å­˜æ³„æ¼æ’æŸ¥


### 5.1 å†…å­˜æ³„æ¼çš„è¡¨ç°


**å…¸å‹ç—‡çŠ¶**ï¼š
```
åˆšå¯åŠ¨ï¼šå†…å­˜300MBï¼Œè¿è¡Œæ­£å¸¸
è¿è¡Œ1å¤©ï¼šå†…å­˜500MBï¼Œå¶å°”å˜æ…¢
è¿è¡Œ3å¤©ï¼šå†…å­˜800MBï¼Œé¢‘ç¹å¡é¡¿
è¿è¡Œ5å¤©ï¼šå†…å­˜1.5GBï¼ŒæœåŠ¡å´©æºƒ
         â†“
    å†…å­˜æ³„æ¼äº†ï¼
```

**ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿ**
```
æ­£å¸¸æƒ…å†µï¼š
åˆ›å»ºå¯¹è±¡ â†’ ä½¿ç”¨ â†’ ä¸ç”¨äº† â†’ GCå›æ”¶ â†’ å†…å­˜é‡Šæ”¾

å†…å­˜æ³„æ¼ï¼š
åˆ›å»ºå¯¹è±¡ â†’ ä½¿ç”¨ â†’ ä¸ç”¨äº† â†’ ä»è¢«å¼•ç”¨ â†’ GCæ— æ³•å›æ”¶
               â†“
          å¯¹è±¡è¶Šç§¯è¶Šå¤šï¼Œå†…å­˜è€—å°½
```

### 5.2 å¸¸è§æ³„æ¼åœºæ™¯


**åœºæ™¯ä¸€ï¼šé™æ€é›†åˆæœªæ¸…ç†**
```java
// âŒ å†…å­˜æ³„æ¼
public class CacheUtil {
    private static Map<String, Object> cache = new HashMap<>();
    
    public static void put(String key, Object value) {
        cache.put(key, value);  // ä¸€ç›´å¾€é‡Œæ”¾
        // ä»ä¸åˆ é™¤ï¼Œå†…å­˜æŒç»­å¢é•¿ï¼
    }
}

// âœ… ä½¿ç”¨æœ‰é™å®¹é‡çš„ç¼“å­˜
public class CacheUtil {
    private static Map<String, Object> cache = 
        new LinkedHashMap<>(1000, 0.75f, true) {
            @Override
            protected boolean removeEldestEntry(Map.Entry eldest) {
                return size() > 1000;  // è¶…è¿‡1000æ¡è‡ªåŠ¨åˆ é™¤æœ€è€çš„
            }
        };
}
```

**åœºæ™¯äºŒï¼šæ•°æ®åº“è¿æ¥æœªå…³é—­**
```java
// âŒ è¿æ¥æ³„æ¼
public List<User> getUsers() {
    Connection conn = dataSource.getConnection();
    Statement stmt = conn.createStatement();
    ResultSet rs = stmt.executeQuery("SELECT * FROM user");
    
    // å¤„ç†ç»“æœ...
    
    // å¿˜è®°å…³é—­ï¼è¿æ¥æ³„æ¼
    return users;
}

// âœ… ä½¿ç”¨try-with-resources
public List<User> getUsers() {
    try (Connection conn = dataSource.getConnection();
         Statement stmt = conn.createStatement();
         ResultSet rs = stmt.executeQuery("SELECT * FROM user")) {
        
        // å¤„ç†ç»“æœ...
        return users;
    }  // è‡ªåŠ¨å…³é—­èµ„æº
}
```

**åœºæ™¯ä¸‰ï¼šThreadLocalæœªæ¸…ç†**
```java
// âŒ ThreadLocalæ³„æ¼
public class UserContext {
    private static ThreadLocal<User> userHolder = new ThreadLocal<>();
    
    public static void setUser(User user) {
        userHolder.set(user);
        // ä½¿ç”¨å®Œä¸æ¸…ç†ï¼Œåœ¨çº¿ç¨‹æ± ä¸­ä¼šæ³„æ¼
    }
}

// âœ… åŠæ—¶æ¸…ç†
public static void setUser(User user) {
    try {
        userHolder.set(user);
        // ä¸šåŠ¡é€»è¾‘...
    } finally {
        userHolder.remove();  // å¿…é¡»æ¸…ç†
    }
}
```

### 5.3 æ’æŸ¥å·¥å…·ä½¿ç”¨


**ä½¿ç”¨JVMå‚æ•°å¯¼å‡ºå †å¿«ç…§**ï¼š
```bash
# å¯åŠ¨æ—¶æ·»åŠ å‚æ•°
java -jar app.jar \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/logs/heapdump.hprof

# OOMæ—¶è‡ªåŠ¨å¯¼å‡ºå †å¿«ç…§
```

**ä½¿ç”¨MATåˆ†æå†…å­˜**ï¼š
```
æ­¥éª¤ä¸€ï¼šæ‰“å¼€heapdumpæ–‡ä»¶
MATå·¥å…· â†’ File â†’ Open Heap Dump

æ­¥éª¤äºŒï¼šæŸ¥çœ‹å†…å­˜å ç”¨
Histogram â†’ æŒ‰å¤§å°æ’åº
æ‰¾åˆ°å ç”¨å†…å­˜æœ€å¤šçš„å¯¹è±¡

æ­¥éª¤ä¸‰ï¼šåˆ†æå¼•ç”¨é“¾
å³é”®å¯¹è±¡ â†’ Path to GC Roots
æŸ¥çœ‹ä¸ºä»€ä¹ˆæ— æ³•è¢«å›æ”¶

æ­¥éª¤å››ï¼šå®šä½ä»£ç 
æ‰¾åˆ°å¼•ç”¨çš„ä»£ç ä½ç½® â†’ ä¿®å¤é—®é¢˜
```

**å®ç”¨å‘½ä»¤**ï¼š
```bash
# æŸ¥çœ‹å †å†…å­˜ä½¿ç”¨
jmap -heap <pid>

# æŸ¥çœ‹å¯¹è±¡ç»Ÿè®¡
jmap -histo <pid> | head -20

# æ‰‹åŠ¨è§¦å‘GC
jmap -dump:live,format=b,file=heap.bin <pid>
```

---

## 6. ğŸ”’ æ­»é”é—®é¢˜å¤„ç†


### 6.1 ä»€ä¹ˆæ˜¯æ•°æ®åº“æ­»é”ï¼Ÿ


**ç”Ÿæ´»åŒ–æ¯”å–»**ï¼š
```
åœºæ™¯ï¼šAå’ŒBè¦æ¢åº§ä½

æ­£å¸¸æµç¨‹ï¼š
Aèµ·èº« â†’ Bèµ·èº« â†’ Aååˆ°Bçš„ä½ç½® â†’ Bååˆ°Açš„ä½ç½® âœ…

æ­»é”æƒ…å†µï¼š
Aå ç€åº§ä½ï¼Œç­‰Bèµ·æ¥
Bå ç€åº§ä½ï¼Œç­‰Aèµ·æ¥
ä¸¤äººéƒ½åœ¨ç­‰å¯¹æ–¹ï¼Œè°ä¹ŸåŠ¨ä¸äº† ğŸ’€
```

**æ•°æ®åº“æ­»é”**ï¼š
```
äº‹åŠ¡1ï¼š
UPDATE user SET name='A' WHERE id=1;  -- é”ä½id=1
UPDATE user SET name='A' WHERE id=2;  -- ç­‰å¾…id=2ï¼ˆè¢«äº‹åŠ¡2é”ä½ï¼‰

äº‹åŠ¡2ï¼š
UPDATE user SET name='B' WHERE id=2;  -- é”ä½id=2
UPDATE user SET name='B' WHERE id=1;  -- ç­‰å¾…id=1ï¼ˆè¢«äº‹åŠ¡1é”ä½ï¼‰

ç»“æœï¼šäº’ç›¸ç­‰å¾…ï¼Œå½¢æˆæ­»é”
```

### 6.2 æ­»é”çš„è¯†åˆ«


**é”™è¯¯ä¿¡æ¯**ï¼š
```
Deadlock found when trying to get lock; 
try restarting transaction

ç¿»è¯‘ï¼š
å‘ç°æ­»é”äº†ï¼Œå°è¯•é‡å¯äº‹åŠ¡å§
```

**æŸ¥çœ‹æ­»é”æ—¥å¿—**ï¼š
```sql
-- MySQLæŸ¥çœ‹æ­»é”ä¿¡æ¯
SHOW ENGINE INNODB STATUS;

-- è¾“å‡ºä¸­æ‰¾åˆ°LATEST DETECTED DEADLOCKéƒ¨åˆ†
-- ä¼šæ˜¾ç¤ºï¼š
-- å“ªäº›äº‹åŠ¡å‘ç”Ÿæ­»é”
-- æŒæœ‰å“ªäº›é”
-- ç­‰å¾…å“ªäº›é”
```

### 6.3 è§£å†³æ–¹æ¡ˆ


**æ–¹æ¡ˆä¸€ï¼šç»Ÿä¸€åŠ é”é¡ºåº**
```java
// âŒ å¯èƒ½æ­»é”
public void transfer(Long from, Long to, int money) {
    accountDao.lock(from);  // å…ˆé”from
    accountDao.lock(to);    // å†é”to
    // è½¬è´¦é€»è¾‘...
}

// è°ƒç”¨ï¼š
transfer(1, 2, 100);  // é”é¡ºåºï¼š1 â†’ 2
transfer(2, 1, 100);  // é”é¡ºåºï¼š2 â†’ 1  æ­»é”ï¼

// âœ… ç»Ÿä¸€é¡ºåº
public void transfer(Long from, Long to, int money) {
    Long first = Math.min(from, to);   // æ€»æ˜¯å…ˆé”IDå°çš„
    Long second = Math.max(from, to);
    
    accountDao.lock(first);
    accountDao.lock(second);
    // è½¬è´¦é€»è¾‘...
}
```

**æ–¹æ¡ˆäºŒï¼šç¼©å°é”èŒƒå›´**
```java
// âŒ é”èŒƒå›´å¤ªå¤§
@Transactional
public void processOrder(Long orderId) {
    // å¼€å¯äº‹åŠ¡ï¼ŒæŒæœ‰é”
    Order order = orderDao.selectForUpdate(orderId);
    
    // å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼ˆè€—æ—¶é•¿ï¼‰
    calculatePrice(order);
    checkInventory(order);
    callThirdParty(order);  // è°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£
    
    // æ›´æ–°è®¢å•
    orderDao.update(order);
}  // é‡Šæ”¾é”

// âœ… åªåœ¨å¿…è¦æ—¶åŠ é”
public void processOrder(Long orderId) {
    Order order = orderDao.selectById(orderId);
    
    // ä¸šåŠ¡é€»è¾‘ï¼ˆä¸åŠ é”ï¼‰
    calculatePrice(order);
    checkInventory(order);
    callThirdParty(order);
    
    // åªåœ¨æ›´æ–°æ—¶åŠ é”
    synchronized(this) {
        orderDao.update(order);
    }
}
```

**æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨ä¹è§‚é”**
```java
@Entity
public class Product {
    @Id
    private Long id;
    private Integer stock;
    
    @Version  // ç‰ˆæœ¬å·
    private Integer version;
}

// æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·
@Transactional
public boolean reduceStock(Long productId, int count) {
    Product product = productDao.findById(productId);
    product.setStock(product.getStock() - count);
    
    int rows = productDao.update(product);
    return rows > 0;  // versionä¸åŒ¹é…åˆ™æ›´æ–°å¤±è´¥
}
```

---

## 7. ğŸ“Š æ€§èƒ½é—®é¢˜è¯Šæ–­


### 7.1 æ€§èƒ½é—®é¢˜çš„è¡¨ç°


**ç”¨æˆ·æ„ŸçŸ¥**ï¼š
```
æ…¢æŸ¥è¯¢ï¼š
ç‚¹å‡»æŒ‰é’® â†’ è½¬åœˆ5ç§’ â†’ æ‰å‡ºç»“æœ
ç”¨æˆ·ï¼šè¿™ç³»ç»Ÿå¤ªå¡äº†ï¼

å†…å­˜é—®é¢˜ï¼š
ä½¿ç”¨ä¸€ä¼šå„¿ â†’ ç³»ç»Ÿå˜æ…¢ â†’ æœ€åå¡æ­»
ç”¨æˆ·ï¼šåƒåœ¾ç³»ç»Ÿï¼

CPUé£™é«˜ï¼š
æŸä¸ªåŠŸèƒ½ä¸€ç”¨ â†’ æœåŠ¡å™¨CPU 100%
ç”¨æˆ·ï¼šå…¶ä»–åŠŸèƒ½éƒ½æ…¢äº†ï¼
```

### 7.2 æ€§èƒ½è¯Šæ–­æ­¥éª¤


**ç¬¬ä¸€æ­¥ï¼šå®šä½æ…¢åœ¨å“ªé‡Œ**

```
åˆ†å±‚æ’æŸ¥ï¼š
æµè§ˆå™¨ â†’ ç½‘ç»œ â†’ åç«¯ â†’ æ•°æ®åº“

å·¥å…·ï¼š
â”œâ”€â”€ æµè§ˆå™¨F12 â†’ çœ‹ç½‘ç»œè¯·æ±‚è€—æ—¶
â”œâ”€â”€ Nginxæ—¥å¿— â†’ çœ‹åç«¯å“åº”æ—¶é—´
â”œâ”€â”€ åº”ç”¨æ—¥å¿— â†’ çœ‹ä¸šåŠ¡å¤„ç†æ—¶é—´
â””â”€â”€ æ•°æ®åº“æ…¢æŸ¥è¯¢æ—¥å¿— â†’ çœ‹SQLæ‰§è¡Œæ—¶é—´

ç¤ºä¾‹åˆ†æï¼š
æ€»è€—æ—¶ï¼š3000ms
â”œâ”€â”€ ç½‘ç»œä¼ è¾“ï¼š50ms   ï¼ˆæ­£å¸¸ï¼‰
â”œâ”€â”€ åç«¯å¤„ç†ï¼š2900ms ï¼ˆæœ‰é—®é¢˜ï¼ï¼‰
â”‚   â”œâ”€â”€ ä¸šåŠ¡é€»è¾‘ï¼š100ms
â”‚   â””â”€â”€ æ•°æ®åº“æŸ¥è¯¢ï¼š2800ms ï¼ˆæ ¹æºåœ¨è¿™é‡Œï¼ï¼‰
â””â”€â”€ å“åº”è¿”å›ï¼š50ms
```

**ç¬¬äºŒæ­¥ï¼šåˆ†æå…·ä½“åŸå› **

```
æ•°æ®åº“æ…¢ï¼š
â–¡ SQLæ²¡æœ‰ç´¢å¼• â†’ å…¨è¡¨æ‰«æ
â–¡ æ•°æ®é‡å¤ªå¤§ â†’ éœ€è¦åˆ†é¡µ
â–¡ é”ç­‰å¾…     â†’ äº‹åŠ¡å†²çª

ä»£ç æ…¢ï¼š
â–¡ å¾ªç¯è°ƒç”¨æ•°æ®åº“ â†’ N+1é—®é¢˜
â–¡ å¤§é‡å¯¹è±¡åˆ›å»º   â†’ GCé¢‘ç¹
â–¡ åŒæ­¥é˜»å¡       â†’ ä¸²è¡Œæ‰§è¡Œ

ç½‘ç»œæ…¢ï¼š
â–¡ æ¥å£è°ƒç”¨è¶…æ—¶
â–¡ å¤§æ–‡ä»¶ä¼ è¾“
```

### 7.3 ä¼˜åŒ–æŠ€å·§


**æ•°æ®åº“ä¼˜åŒ–**ï¼š
```sql
-- âŒ æ…¢æŸ¥è¯¢
SELECT * FROM user WHERE name LIKE '%å¼ %';
-- å…¨è¡¨æ‰«æï¼Œ100ä¸‡æ•°æ®éœ€è¦3ç§’

-- âœ… æ·»åŠ ç´¢å¼•
CREATE INDEX idx_name ON user(name);
-- ä½¿ç”¨ç´¢å¼•ï¼ŒæŸ¥è¯¢æ—¶é—´é™åˆ°100ms

-- âŒ è¿”å›æ— ç”¨å­—æ®µ
SELECT * FROM user WHERE id = 1;

-- âœ… åªæŸ¥éœ€è¦çš„å­—æ®µ
SELECT id, name, phone FROM user WHERE id = 1;
-- å‡å°‘æ•°æ®ä¼ è¾“é‡
```

**ä»£ç ä¼˜åŒ–**ï¼š
```java
// âŒ æ•ˆç‡ä½
for (Long userId : userIds) {
    User user = userService.getById(userId);  // æ¯æ¬¡æŸ¥è¯¢ä¸€æ¬¡
    users.add(user);
}

// âœ… æ‰¹é‡æŸ¥è¯¢
List<User> users = userService.getByIds(userIds);

// âŒ é¢‘ç¹åˆ›å»ºå¯¹è±¡
for (int i = 0; i < 10000; i++) {
    String str = new String("hello");  // åˆ›å»º10000ä¸ªå¯¹è±¡
}

// âœ… å¤ç”¨å¯¹è±¡
String str = "hello";  // å­—ç¬¦ä¸²å¸¸é‡æ± å¤ç”¨
```

**å¼‚æ­¥ä¼˜åŒ–**ï¼š
```java
// âŒ åŒæ­¥æ‰§è¡Œï¼ˆæ…¢ï¼‰
public void processOrder(Order order) {
    saveOrder(order);           // 100ms
    sendSMS(order.getPhone());  // 2000msï¼ˆè°ƒç”¨çŸ­ä¿¡æ¥å£ï¼‰
    sendEmail(order.getEmail()); // 1000msï¼ˆå‘é€é‚®ä»¶ï¼‰
    // æ€»è€—æ—¶ï¼š3100ms
}

// âœ… å¼‚æ­¥æ‰§è¡Œï¼ˆå¿«ï¼‰
@Async
public void sendSMS(String phone) {
    // å¼‚æ­¥å‘é€çŸ­ä¿¡
}

@Async  
public void sendEmail(String email) {
    // å¼‚æ­¥å‘é€é‚®ä»¶
}

public void processOrder(Order order) {
    saveOrder(order);      // 100ms
    sendSMS(order.getPhone());   // ä¸ç­‰å¾…
    sendEmail(order.getEmail()); // ä¸ç­‰å¾…
    // æ€»è€—æ—¶ï¼š100ms
}
```

---

## 8. ğŸ”„ æ•°æ®ä¸€è‡´æ€§é—®é¢˜


### 8.1 åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜


**åœºæ™¯è¯´æ˜**ï¼š
```
ç”µå•†ä¸‹å•æµç¨‹ï¼š
1. è®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å•
2. åº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜
3. ç§¯åˆ†æœåŠ¡ï¼šå¢åŠ ç§¯åˆ†

é—®é¢˜ï¼š
è®¢å•åˆ›å»ºæˆåŠŸ â†’ åº“å­˜æ‰£å‡å¤±è´¥
ç»“æœï¼šè®¢å•æœ‰äº†ï¼Œä½†åº“å­˜æ²¡æ‰£
æ•°æ®ä¸ä¸€è‡´ï¼
```

**æœ¬åœ°äº‹åŠ¡çš„å±€é™**ï¼š
```
@Transactionalåªèƒ½ç®¡ç†æœ¬åœ°æ•°æ®åº“
æ— æ³•ç®¡ç†ï¼š
â”œâ”€â”€ ä¸åŒæ•°æ®åº“
â”œâ”€â”€ ä¸åŒæœåŠ¡
â””â”€â”€ æ¶ˆæ¯é˜Ÿåˆ—
```

### 8.2 è§£å†³æ–¹æ¡ˆ


**æ–¹æ¡ˆä¸€ï¼šTCCæ¨¡å¼**
```
TCC = Try-Confirm-Cancel

Tryé˜¶æ®µï¼ˆå°è¯•ï¼‰ï¼š
è®¢å•æœåŠ¡ï¼šé¢„åˆ›å»ºè®¢å•ï¼ˆçŠ¶æ€=å¾…ç¡®è®¤ï¼‰
åº“å­˜æœåŠ¡ï¼šé¢„æ‰£åº“å­˜ï¼ˆå†»ç»“ï¼‰
ç§¯åˆ†æœåŠ¡ï¼šé¢„æ‰£ç§¯åˆ†ï¼ˆå†»ç»“ï¼‰

Confirmé˜¶æ®µï¼ˆç¡®è®¤ï¼‰ï¼š
å…¨éƒ¨æˆåŠŸ â†’ æŠŠ"é¢„"æ”¹æˆ"çœŸ"
è®¢å•ç¡®è®¤ã€åº“å­˜ç¡®è®¤æ‰£å‡ã€ç§¯åˆ†ç¡®è®¤æ‰£å‡

Cancelé˜¶æ®µï¼ˆå–æ¶ˆï¼‰ï¼š
ä»»ä½•å¤±è´¥ â†’ å…¨éƒ¨å›æ»š
è®¢å•åˆ é™¤ã€åº“å­˜é‡Šæ”¾ã€ç§¯åˆ†é‡Šæ”¾
```

**æ–¹æ¡ˆäºŒï¼šæœ¬åœ°æ¶ˆæ¯è¡¨**
```java
// è®¢å•æœåŠ¡
@Transactional
public void createOrder(Order order) {
    // 1. ä¿å­˜è®¢å•
    orderDao.save(order);
    
    // 2. ä¿å­˜æ¶ˆæ¯è®°å½•ï¼ˆåŒä¸€ä¸ªäº‹åŠ¡ï¼‰
    Message msg = new Message();
    msg.setTopic("order-created");
    msg.setContent(order.toJson());
    msgDao.save(msg);
    
    // æäº¤äº‹åŠ¡ï¼Œç¡®ä¿è®¢å•å’Œæ¶ˆæ¯ä¸€èµ·ä¿å­˜
}

// å®šæ—¶ä»»åŠ¡å‘é€æ¶ˆæ¯
@Scheduled(fixedDelay = 1000)
public void sendMessage() {
    List<Message> messages = msgDao.findUnsent();
    for (Message msg : messages) {
        // å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
        mqSender.send(msg);
        // æ ‡è®°å·²å‘é€
        msg.setStatus("SENT");
        msgDao.update(msg);
    }
}
```

**æ–¹æ¡ˆä¸‰ï¼šæœ€ç»ˆä¸€è‡´æ€§**
```
æ ¸å¿ƒæ€æƒ³ï¼šä¸è¦æ±‚ç«‹å³ä¸€è‡´ï¼Œå…è®¸çŸ­æš‚å»¶è¿Ÿ

ç¤ºä¾‹ï¼šä¸‹å•å‡åº“å­˜
1. è®¢å•åˆ›å»ºæˆåŠŸ â†’ å‘é€MQæ¶ˆæ¯
2. åº“å­˜æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯ â†’ æ‰£å‡åº“å­˜
3. å¦‚æœå¤±è´¥ â†’ é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
4. è¿˜å¤±è´¥ â†’ äººå·¥ä»‹å…¥

ç”¨æˆ·è§†è§’ï¼š
ä¸‹å•æˆåŠŸ â†’ 1-2ç§’ååº“å­˜æ‰£å‡
å¯ä»¥æ¥å—çš„å»¶è¿Ÿ
```

### 8.3 ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜


**Cache Asideæ¨¡å¼**ï¼š
```java
// è¯»æ•°æ®
public User getUser(Long id) {
    // 1. å…ˆæŸ¥ç¼“å­˜
    User user = redis.get("user:" + id);
    if (user != null) {
        return user;
    }
    
    // 2. ç¼“å­˜æ²¡æœ‰ï¼ŒæŸ¥æ•°æ®åº“
    user = userDao.findById(id);
    
    // 3. å†™å…¥ç¼“å­˜
    redis.set("user:" + id, user);
    
    return user;
}

// æ›´æ–°æ•°æ®
public void updateUser(User user) {
    // 1. å…ˆæ›´æ–°æ•°æ®åº“
    userDao.update(user);
    
    // 2. å†åˆ é™¤ç¼“å­˜
    redis.delete("user:" + user.getId());
    
    // ä¸‹æ¬¡æŸ¥è¯¢æ—¶ä¼šé‡æ–°åŠ è½½æœ€æ–°æ•°æ®
}
```

**ä¸ºä»€ä¹ˆæ˜¯åˆ é™¤è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ**
```
æ›´æ–°ç¼“å­˜çš„é—®é¢˜ï¼š
çº¿ç¨‹Aï¼šæ›´æ–°æ•°æ®åº“ â†’ æ›´æ–°ç¼“å­˜
çº¿ç¨‹Bï¼šæ›´æ–°æ•°æ®åº“ â†’ æ›´æ–°ç¼“å­˜
å¦‚æœBçš„æ•°æ®åº“æ“ä½œæ™šï¼Œä½†ç¼“å­˜æ›´æ–°æ—©
ç»“æœï¼šæ•°æ®åº“æ˜¯Bçš„å€¼ï¼Œç¼“å­˜æ˜¯Açš„å€¼
ä¸ä¸€è‡´ï¼

åˆ é™¤ç¼“å­˜ï¼š
çº¿ç¨‹Aï¼šæ›´æ–°æ•°æ®åº“ â†’ åˆ é™¤ç¼“å­˜
çº¿ç¨‹Bï¼šæ›´æ–°æ•°æ®åº“ â†’ åˆ é™¤ç¼“å­˜
ä¸‹æ¬¡æŸ¥è¯¢æ—¶ä»æ•°æ®åº“åŠ è½½æœ€æ–°å€¼
ä¿è¯ä¸€è‡´æ€§ âœ…
```

---

## 9. ğŸ” å¹¶å‘å®‰å…¨é—®é¢˜


### 9.1 è¶…å–é—®é¢˜


**å…¸å‹åœºæ™¯**ï¼š
```
å•†å“åº“å­˜ï¼š10ä»¶

åŒæ—¶æœ‰100ä¸ªç”¨æˆ·ä¸‹å•ï¼š
ç”¨æˆ·Aï¼šæŸ¥è¯¢åº“å­˜10ä»¶ â†’ è´­ä¹°æˆåŠŸ
ç”¨æˆ·Bï¼šæŸ¥è¯¢åº“å­˜10ä»¶ â†’ è´­ä¹°æˆåŠŸ
ç”¨æˆ·Cï¼šæŸ¥è¯¢åº“å­˜10ä»¶ â†’ è´­ä¹°æˆåŠŸ
...

ç»“æœï¼šå–å‡ºäº†100ä»¶ï¼Œä½†å®é™…åªæœ‰10ä»¶
è¶…å–äº†ï¼
```

**é—®é¢˜æ ¹æº**ï¼š
```
å¹¶å‘æ‰§è¡Œæµç¨‹ï¼š
çº¿ç¨‹Aï¼šSELECT stock FROM product WHERE id=1  ï¼ˆæŸ¥åˆ°10ï¼‰
çº¿ç¨‹Bï¼šSELECT stock FROM product WHERE id=1  ï¼ˆæŸ¥åˆ°10ï¼‰
çº¿ç¨‹Aï¼šUPDATE product SET stock=9 WHERE id=1
çº¿ç¨‹Bï¼šUPDATE product SET stock=9 WHERE id=1
                â†“
           ä¸¤ä¸ªäººéƒ½æ‰£äº†ï¼Œå®é™…åº”è¯¥æ˜¯8
```

### 9.2 è§£å†³æ–¹æ¡ˆ


**æ–¹æ¡ˆä¸€ï¼šæ‚²è§‚é”ï¼ˆSELECT FOR UPDATEï¼‰**
```java
@Transactional
public boolean buyProduct(Long productId, int count) {
    // é”å®šè¿™ä¸€è¡Œï¼Œå…¶ä»–äº‹åŠ¡å¿…é¡»ç­‰å¾…
    Product product = productDao.selectForUpdate(productId);
    
    if (product.getStock() >= count) {
        product.setStock(product.getStock() - count);
        productDao.update(product);
        return true;
    }
    return false;
}

// SQLæ‰§è¡Œï¼š
// SELECT * FROM product WHERE id=1 FOR UPDATE
// å…¶ä»–äº‹åŠ¡æ‰§è¡Œåˆ°è¿™é‡Œä¼šé˜»å¡ï¼Œç›´åˆ°å½“å‰äº‹åŠ¡æäº¤
```

**æ–¹æ¡ˆäºŒï¼šä¹è§‚é”ï¼ˆç‰ˆæœ¬å·ï¼‰**
```java
@Entity
public class Product {
    private Long id;
    private Integer stock;
    
    @Version  // ç‰ˆæœ¬å·å­—æ®µ
    private Integer version;
}

public boolean buyProduct(Long productId, int count) {
    Product product = productDao.findById(productId);
    product.setStock(product.getStock() - count);
    
    // æ›´æ–°SQLï¼š
    // UPDATE product 
    // SET stock = stock - ?, version = version + 1
    // WHERE id = ? AND version = ?
    
    int rows = productDao.update(product);
    if (rows == 0) {
        // æ›´æ–°å¤±è´¥ï¼Œè¯´æ˜versionå·²å˜åŒ–ï¼ˆæœ‰äººå…ˆæ›´æ–°äº†ï¼‰
        return false;  // å¯ä»¥é‡è¯•
    }
    return true;
}
```

**æ–¹æ¡ˆä¸‰ï¼šRedisåˆ†å¸ƒå¼é”**
```java
public boolean buyProduct(Long productId, int count) {
    String lockKey = "lock:product:" + productId;
    
    // å°è¯•è·å–é”ï¼ˆ10ç§’è¿‡æœŸï¼‰
    boolean locked = redisTemplate.opsForValue()
        .setIfAbsent(lockKey, "1", 10, TimeUnit.SECONDS);
    
    if (!locked) {
        return false;  // è·å–é”å¤±è´¥
    }
    
    try {
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        Product product = productDao.findById(productId);
        if (product.getStock() >= count) {
            product.setStock(product.getStock() - count);
            productDao.update(product);
            return true;
        }
        return false;
    } finally {
        // é‡Šæ”¾é”
        redisTemplate.delete(lockKey);
    }
}
```

### 9.3 æ–¹æ¡ˆå¯¹æ¯”


| æ–¹æ¡ˆ | æ€§èƒ½ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|------|--------|---------|
| **æ‚²è§‚é”** | ä½ï¼ˆé”ç­‰å¾…ï¼‰ | ç®€å• | å†²çªé¢‘ç¹ |
| **ä¹è§‚é”** | é«˜ï¼ˆæ— é”ç­‰å¾…ï¼‰ | ä¸­ç­‰ | å†²çªè¾ƒå°‘ |
| **åˆ†å¸ƒå¼é”** | ä¸­ç­‰ | å¤æ‚ | åˆ†å¸ƒå¼ç³»ç»Ÿ |

---

## 10. ğŸ§ª é›†æˆæµ‹è¯•é—®é¢˜


### 10.1 æµ‹è¯•ç¯å¢ƒæ­å»º


**å†…å­˜æ•°æ®åº“æ–¹æ¡ˆ**ï¼š
```java
// æµ‹è¯•é…ç½®
@TestConfiguration
public class TestConfig {
    @Bean
    public DataSource dataSource() {
        return new EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.H2)  // ä½¿ç”¨H2å†…å­˜æ•°æ®åº“
            .addScript("schema.sql")   // å»ºè¡¨è„šæœ¬
            .addScript("data.sql")     // æµ‹è¯•æ•°æ®
            .build();
    }
}

// ä¼˜ç‚¹ï¼š
// - å¯åŠ¨å¿«ï¼Œæ— éœ€çœŸå®æ•°æ®åº“
// - æ•°æ®éš”ç¦»ï¼Œæµ‹è¯•äº’ä¸å½±å“
// - æ¯æ¬¡æµ‹è¯•åè‡ªåŠ¨æ¸…ç©º
```

**æµ‹è¯•æ•°æ®å‡†å¤‡**ï¼š
```java
@SpringBootTest
@Transactional  // æµ‹è¯•å®Œè‡ªåŠ¨å›æ»š
public class UserServiceTest {
    @Autowired
    private UserService userService;
    
    @BeforeEach
    void setUp() {
        // æ¯ä¸ªæµ‹è¯•å‰å‡†å¤‡æ•°æ®
        User user = new User();
        user.setName("æµ‹è¯•ç”¨æˆ·");
        userService.save(user);
    }
    
    @Test
    void testFindUser() {
        User user = userService.findByName("æµ‹è¯•ç”¨æˆ·");
        assertNotNull(user);
    }
    
    // æµ‹è¯•ç»“æŸè‡ªåŠ¨å›æ»šï¼Œä¸å½±å“å…¶ä»–æµ‹è¯•
}
```

### 10.2 Mockä½¿ç”¨


**Mockå¤–éƒ¨ä¾èµ–**ï¼š
```java
@SpringBootTest
public class OrderServiceTest {
    @Autowired
    private OrderService orderService;
    
    @MockBean  // Mockçš„Bean
    private PaymentService paymentService;
    
    @Test
    void testCreateOrder() {
        // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
        when(paymentService.pay(anyLong(), anyInt()))
            .thenReturn(true);
        
        // æµ‹è¯•ä¸‹å•
        Order order = orderService.createOrder(1L, 100);
        
        assertNotNull(order);
        assertEquals("SUCCESS", order.getStatus());
    }
}
```

**ä¸ºä»€ä¹ˆè¦Mockï¼Ÿ**
```
ä¸Mockçš„é—®é¢˜ï¼š
æµ‹è¯•è®¢å•æœåŠ¡ â†’ çœŸçš„è°ƒç”¨æ”¯ä»˜æ¥å£
                â†“
           éœ€è¦çœŸå®çš„æ”¯ä»˜è´¦å·
           å¯èƒ½äº§ç”ŸçœŸå®æ‰£æ¬¾
           å¤–éƒ¨æ¥å£å¯èƒ½æŒ‚äº†

ä½¿ç”¨Mockï¼š
æµ‹è¯•è®¢å•æœåŠ¡ â†’ Mockæ”¯ä»˜æ¥å£
                â†“
           æ¨¡æ‹Ÿè¿”å›æˆåŠŸ/å¤±è´¥
           ä¸ä¾èµ–å¤–éƒ¨ç³»ç»Ÿ
           æµ‹è¯•æ›´ç¨³å®š
```

### 10.3 å¸¸è§æµ‹è¯•é—®é¢˜


**é—®é¢˜ä¸€ï¼šæµ‹è¯•ç›¸äº’å½±å“**
```java
// âŒ é—®é¢˜ä»£ç 
@SpringBootTest
public class BadTest {
    @Test
    void test1() {
        User user = new User();
        user.setId(1L);
        userService.save(user);
    }
    
    @Test
    void test2() {
        // ä¾èµ–test1çš„æ•°æ®
        User user = userService.findById(1L);
        // å¦‚æœtest1æ²¡æ‰§è¡Œï¼Œè¿™é‡Œå°±ä¼šå¤±è´¥
    }
}

// âœ… æ­£ç¡®åšæ³•
@SpringBootTest
@Transactional  // æ¯ä¸ªæµ‹è¯•åå›æ»š
public class GoodTest {
    @BeforeEach
    void setUp() {
        // æ¯ä¸ªæµ‹è¯•éƒ½ç‹¬ç«‹å‡†å¤‡æ•°æ®
    }
}
```

**é—®é¢˜äºŒï¼šæµ‹è¯•è¦†ç›–ä¸å…¨**
```
è¦†ç›–çš„åœºæ™¯ï¼š
âœ… æ­£å¸¸æµç¨‹
âœ… å¼‚å¸¸æƒ…å†µï¼ˆå‚æ•°ä¸ºnullï¼‰
âœ… è¾¹ç•Œæ¡ä»¶ï¼ˆåº“å­˜ä¸º0ï¼‰
âœ… å¹¶å‘åœºæ™¯ï¼ˆæ¨¡æ‹Ÿå¤šçº¿ç¨‹ï¼‰

ç¤ºä¾‹ï¼š
@Test
void testBuyProduct_Success() { ... }      // æ­£å¸¸è´­ä¹°

@Test
void testBuyProduct_NoStock() { ... }      // åº“å­˜ä¸è¶³

@Test
void testBuyProduct_NullParam() { ... }    // å‚æ•°ä¸ºç©º

@Test
void testBuyProduct_Concurrent() { ... }   // å¹¶å‘è´­ä¹°
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 é—®é¢˜å¿«é€Ÿå®šä½


**é—®é¢˜åˆ†ç±»è¡¨**ï¼š
| é—®é¢˜ç±»å‹ | å…¸å‹é”™è¯¯ | å¿«é€Ÿåˆ¤æ–­æ–¹æ³• |
|---------|---------|------------|
| **å¾ªç¯ä¾èµ–** | circular reference | çœ‹Beanåˆ›å»ºå¤±è´¥ä¿¡æ¯ |
| **æ‡’åŠ è½½** | LazyInitializationException | Sessionå…³é—­å¼‚å¸¸ |
| **äº‹åŠ¡å¤±æ•ˆ** | æ•°æ®æ²¡å›æ»š | æ£€æŸ¥æ–¹æ³•ä¿®é¥°ç¬¦ |
| **N+1æŸ¥è¯¢** | æ€§èƒ½æ…¢ | æŸ¥çœ‹SQLæ‰§è¡Œæ¬¡æ•° |
| **å†…å­˜æ³„æ¼** | å†…å­˜æŒç»­å¢é•¿ | çœ‹å †å†…å­˜å ç”¨ |
| **æ­»é”** | Deadlock detected | æŸ¥çœ‹é”ç­‰å¾…æ—¥å¿— |
| **è¶…å–** | åº“å­˜ä¸ºè´Ÿ | æ£€æŸ¥å¹¶å‘æ§åˆ¶ |

### 11.2 è§£å†³æ€è·¯æ€»ç»“


**é€šç”¨æ’æŸ¥æ­¥éª¤**ï¼š
```
ç¬¬ä¸€æ­¥ï¼šå¤ç°é—®é¢˜
â”œâ”€â”€ æ”¶é›†é”™è¯¯æ—¥å¿—
â”œâ”€â”€ è®°å½•æ“ä½œæ­¥éª¤
â””â”€â”€ ç¡®å®šç¯å¢ƒæ¡ä»¶

ç¬¬äºŒæ­¥ï¼šåˆ†æåŸå› 
â”œâ”€â”€ çœ‹é”™è¯¯å †æ ˆ
â”œâ”€â”€ æŸ¥ç›¸å…³æ—¥å¿—
â””â”€â”€ åˆ†æä¸šåŠ¡é€»è¾‘

ç¬¬ä¸‰æ­¥ï¼šéªŒè¯ä¿®å¤
â”œâ”€â”€ æœ¬åœ°å¤ç°å¹¶ä¿®å¤
â”œâ”€â”€ ç¼–å†™æµ‹è¯•ç”¨ä¾‹
â””â”€â”€ ä¸Šçº¿éªŒè¯æ•ˆæœ
```

**æ ¸å¿ƒåŸåˆ™**ï¼š
```
ğŸ”¸ é¢„é˜²å¤§äºæ²»ç–—
- ä»£ç è§„èŒƒ
- å•å…ƒæµ‹è¯•
- Code Review

ğŸ”¸ é—®é¢˜è¦å½»åº•è§£å†³
- æ‰¾åˆ°æ ¹æœ¬åŸå› 
- ä¸åªæ˜¯ä¸´æ—¶ä¿®å¤
- æ€»ç»“é¿å…å†çŠ¯

ğŸ”¸ å»ºç«‹ç›‘æ§å‘Šè­¦
- å…³é”®æŒ‡æ ‡ç›‘æ§
- å¼‚å¸¸åŠæ—¶å‘Šè­¦
- å®šæœŸå·¡æ£€
```

### 11.3 æœ€ä½³å®è·µæ¸…å•


**å¼€å‘é˜¶æ®µ**ï¼š
```
â–¡ Beanæ³¨å…¥ä¼˜å…ˆç”¨æ„é€ å™¨
â–¡ æ•°æ®åº“æ“ä½œç”¨try-with-resources
â–¡ ThreadLocalä½¿ç”¨åå¿…é¡»æ¸…ç†
â–¡ äº‹åŠ¡æ–¹æ³•å¿…é¡»æ˜¯public
â–¡ ç»Ÿä¸€å¼‚å¸¸å¤„ç†æœºåˆ¶
â–¡ æ‰¹é‡æ“ä½œä»£æ›¿å¾ªç¯
â–¡ åŠ é”è¦ç»Ÿä¸€é¡ºåº
â–¡ æ•æ„Ÿæ“ä½œåŠ æ—¥å¿—
```

**æµ‹è¯•é˜¶æ®µ**ï¼š
```
â–¡ å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒé€»è¾‘
â–¡ é›†æˆæµ‹è¯•éªŒè¯å®Œæ•´æµç¨‹
â–¡ å‹åŠ›æµ‹è¯•æ¨¡æ‹Ÿé«˜å¹¶å‘
â–¡ è¾¹ç•Œæ¡ä»¶éƒ½è¦æµ‹è¯•
â–¡ Mockå¤–éƒ¨ä¾èµ–
```

**ä¸Šçº¿é˜¶æ®µ**ï¼š
```
â–¡ ç°åº¦å‘å¸ƒé™ä½é£é™©
â–¡ ç›‘æ§å…³é”®æŒ‡æ ‡
â–¡ å‡†å¤‡å›æ»šæ–¹æ¡ˆ
â–¡ å€¼ç­å“åº”æœºåˆ¶
```

**è®°å¿†å£è¯€**ï¼š
```
å¾ªç¯ä¾èµ–æŸ¥æ³¨å…¥ï¼Œæ‡’åŠ è½½è®°å¾—å…³è”æŸ¥
äº‹åŠ¡å¤±æ•ˆçœ‹ä¿®é¥°ï¼ŒN+1ä¼˜åŒ–è¦æ‰¹é‡
å†…å­˜æ³„æ¼æ‰¾å¼•ç”¨,æ­»é”ç»Ÿä¸€åŠ é”åº
æ€§èƒ½é—®é¢˜å±‚å±‚æŸ¥ï¼Œä¸€è‡´æ€§è¦çœ‹åœºæ™¯
å¹¶å‘å®‰å…¨åŠ ç‰ˆæœ¬ï¼Œæµ‹è¯•è¦†ç›–è¦å…¨é¢
```