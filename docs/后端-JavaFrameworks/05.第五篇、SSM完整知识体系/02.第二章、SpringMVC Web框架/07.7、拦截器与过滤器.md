---
title: 7ã€æ‹¦æˆªå™¨ä¸è¿‡æ»¤å™¨
---
## ğŸ“š ç›®å½•

1. [æ‹¦æˆªå™¨æ˜¯ä»€ä¹ˆ](#1-æ‹¦æˆªå™¨æ˜¯ä»€ä¹ˆ)
2. [æ‹¦æˆªå™¨çš„å·¥ä½œåŸç†](#2-æ‹¦æˆªå™¨çš„å·¥ä½œåŸç†)
3. [HandlerInterceptoræ¥å£è¯¦è§£](#3-HandlerInterceptoræ¥å£è¯¦è§£)
4. [æ‹¦æˆªå™¨çš„é…ç½®ä¸æ³¨å†Œ](#4-æ‹¦æˆªå™¨çš„é…ç½®ä¸æ³¨å†Œ)
5. [æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåºä¸æ‹¦æˆªå™¨é“¾](#5-æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåºä¸æ‹¦æˆªå™¨é“¾)
6. [æ‹¦æˆªå™¨å®æˆ˜åº”ç”¨](#6-æ‹¦æˆªå™¨å®æˆ˜åº”ç”¨)
7. [æ‹¦æˆªå™¨vsè¿‡æ»¤å™¨](#7-æ‹¦æˆªå™¨vsè¿‡æ»¤å™¨)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ‹¦æˆªå™¨æ˜¯ä»€ä¹ˆ


### 1.1 ç”Ÿæ´»ä¸­çš„æ‹¦æˆªå™¨


**ç†è§£æ‹¦æˆªå™¨ï¼Œå…ˆæƒ³è±¡ä¸€ä¸ªåœºæ™¯**ï¼š

ä½ å»ååœ°é“ï¼Œå¿…é¡»ç»è¿‡å®‰æ£€é—¨ã€‚å®‰æ£€é—¨ä¼šåšä¸‰ä»¶äº‹ï¼š
- **è¿›é—¨å‰æ£€æŸ¥**ï¼šæ£€æŸ¥ä½ æœ‰æ²¡æœ‰å¸¦å±é™©å“ï¼ˆä¸åˆæ ¼å°±æ‹¦ä½ï¼‰
- **é€šè¿‡æ—¶è®°å½•**ï¼šè®°å½•ä½ çš„è¿›ç«™æ—¶é—´
- **å‡ºé—¨åç»Ÿè®¡**ï¼šç»Ÿè®¡ä»Šå¤©é€šè¿‡äº†å¤šå°‘äºº

```
ä¹˜å®¢æµç¨‹ï¼š
å…¥å£ â†’ [å®‰æ£€é—¨æ‹¦æˆªæ£€æŸ¥] â†’ åœ°é“ç«™å†… â†’ [å®‰æ£€é—¨è®°å½•] â†’ å‡ºå£

SpringMVCæ‹¦æˆªå™¨å°±åƒè¿™ä¸ªå®‰æ£€é—¨ï¼
```

### 1.2 SpringMVCæ‹¦æˆªå™¨çš„æœ¬è´¨


**æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰** æ˜¯Spring MVCæä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨æ¥åœ¨**è¯·æ±‚å¤„ç†å‰å**æ’å…¥è‡ªå®šä¹‰é€»è¾‘ã€‚

**ğŸ”¸ æ ¸å¿ƒç†è§£**ï¼š
```
æ™®é€šè¯·æ±‚æµç¨‹ï¼š
æµè§ˆå™¨ â†’ Controller â†’ è¿”å›ç»“æœ

åŠ äº†æ‹¦æˆªå™¨åï¼š
æµè§ˆå™¨ â†’ [æ‹¦æˆªå™¨å‰ç½®å¤„ç†] â†’ Controller â†’ [æ‹¦æˆªå™¨åç½®å¤„ç†] â†’ è¿”å›ç»“æœ
```

**ğŸ”¹ æ‹¦æˆªå™¨èƒ½å¹²ä»€ä¹ˆ**ï¼ˆæœ€å¸¸ç”¨çš„4ä¸ªåœºæ™¯ï¼‰ï¼š
- âœ… **ç™»å½•é‰´æƒ**ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œæ²¡ç™»å½•å°±æ‹¦æˆª
- âœ… **æƒé™æ§åˆ¶**ï¼šæ£€æŸ¥ç”¨æˆ·æœ‰æ²¡æœ‰æƒé™è®¿é—®æŸä¸ªåŠŸèƒ½
- âœ… **æ—¥å¿—è®°å½•**ï¼šè®°å½•è°åœ¨ä»€ä¹ˆæ—¶å€™è®¿é—®äº†ä»€ä¹ˆæ¥å£
- âœ… **æ€§èƒ½ç›‘æ§**ï¼šç»Ÿè®¡æ¥å£æ‰§è¡Œæ—¶é—´

### 1.3 æ‹¦æˆªå™¨çš„ç‰¹ç‚¹


| ç‰¹ç‚¹ | è¯´æ˜ | å®é™…ä½œç”¨ |
|------|------|----------|
| ğŸ¯ **AOPæ€æƒ³** | åœ¨ä¸æ”¹åŠ¨Controllerä»£ç çš„æƒ…å†µä¸‹å¢åŠ åŠŸèƒ½ | ä»£ç æ›´å¹²å‡€ï¼ŒåŠŸèƒ½è§£è€¦ |
| ğŸ”„ **å¯é…ç½®** | å¯ä»¥æŒ‡å®šæ‹¦æˆªå“ªäº›è·¯å¾„ | çµæ´»æ§åˆ¶æ‹¦æˆªèŒƒå›´ |
| ğŸ“Š **æœ‰é¡ºåº** | å¤šä¸ªæ‹¦æˆªå™¨æŒ‰é…ç½®é¡ºåºæ‰§è¡Œ | å¯ä»¥ç»„åˆä½¿ç”¨ |
| âš¡ **SpringMVCå±‚é¢** | åªèƒ½æ‹¦æˆªåˆ°è¾¾Controllerçš„è¯·æ±‚ | ä¸èƒ½æ‹¦æˆªé™æ€èµ„æº |

---

## 2. âš™ï¸ æ‹¦æˆªå™¨çš„å·¥ä½œåŸç†


### 2.1 è¯·æ±‚å®Œæ•´æ‰§è¡Œæµç¨‹


**æ²¡æœ‰æ‹¦æˆªå™¨æ—¶**ï¼š
```
1. ç”¨æˆ·å‘è¯·æ±‚ â†’ 2. DispatcherServletæ¥æ”¶ â†’ 3. Controllerå¤„ç† â†’ 4. è¿”å›ç»“æœ
```

**æœ‰æ‹¦æˆªå™¨æ—¶**ï¼ˆå®Œæ•´æµç¨‹ï¼‰ï¼š
```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
DispatcherServletï¼ˆå‰ç«¯æ§åˆ¶å™¨ï¼‰
    â†“
æ‹¦æˆªå™¨1 - preHandle()     â† å‰ç½®å¤„ç†ï¼šæ£€æŸ¥æ˜¯å¦å…è®¸è®¿é—®
    â†“
æ‹¦æˆªå™¨2 - preHandle()
    â†“
Controllerå¤„ç†ä¸šåŠ¡é€»è¾‘     â† çœŸæ­£çš„ä¸šåŠ¡ä»£ç 
    â†“
æ‹¦æˆªå™¨2 - postHandle()    â† åç½®å¤„ç†ï¼šå¯ä»¥ä¿®æ”¹è¿”å›æ•°æ®
    â†“
æ‹¦æˆªå™¨1 - postHandle()
    â†“
æ¸²æŸ“è§†å›¾/è¿”å›JSON
    â†“
æ‹¦æˆªå™¨2 - afterCompletion() â† æœ€ç»ˆå¤„ç†ï¼šè®°å½•æ—¥å¿—ã€é‡Šæ”¾èµ„æº
    â†“
æ‹¦æˆªå™¨1 - afterCompletion()
    â†“
å“åº”è¿”å›ç»™å®¢æˆ·ç«¯
```

**ğŸ”¸ å…³é”®ç†è§£**ï¼š
- preHandleæ˜¯**æ­£åº**æ‰§è¡Œï¼ˆ1â†’2â†’3ï¼‰
- postHandleå’ŒafterCompletionæ˜¯**å€’åº**æ‰§è¡Œï¼ˆ3â†’2â†’1ï¼‰
- å°±åƒç©¿è¡£æœå’Œè„±è¡£æœï¼šç©¿çš„æ—¶å€™å…ˆç©¿å†…è¡£å†ç©¿å¤–å¥—ï¼Œè„±çš„æ—¶å€™å…ˆè„±å¤–å¥—å†è„±å†…è¡£

### 2.2 æ‹¦æˆªæ—¶æœºå›¾è§£


```
æ—¶é—´çº¿ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        â†“              â†“                â†“
    preHandle      Controller      postHandle      afterCompletion
    ã€æ£€æŸ¥ã€‘         ã€å¤„ç†ã€‘         ã€ä¿®æ”¹ã€‘          ã€æ¸…ç†ã€‘
    
    è¿”å›false      ä¸šåŠ¡é€»è¾‘          å¯é€‰æ–¹æ³•          å¿…æ‰§è¡Œ
    å°±æ‹¦æˆªäº†                        ä¿®æ”¹æ•°æ®          è®°å½•æ—¥å¿—
```

---

## 3. ğŸ”§ HandlerInterceptoræ¥å£è¯¦è§£


### 3.1 æ¥å£å®šä¹‰


**HandlerInterceptor** æ˜¯æ‹¦æˆªå™¨å¿…é¡»å®ç°çš„æ¥å£ï¼Œå®ƒå®šä¹‰äº†3ä¸ªæ–¹æ³•ï¼š

```java
public interface HandlerInterceptor {
    // 1. å‰ç½®å¤„ç†ï¼ˆæœ€é‡è¦ï¼‰
    boolean preHandle(HttpServletRequest request, 
                     HttpServletResponse response, 
                     Object handler);
    
    // 2. åç½®å¤„ç†ï¼ˆå¯é€‰ï¼‰
    void postHandle(HttpServletRequest request, 
                   HttpServletResponse response, 
                   Object handler, 
                   ModelAndView modelAndView);
    
    // 3. å®Œæˆå¤„ç†ï¼ˆå¯é€‰ï¼‰
    void afterCompletion(HttpServletRequest request, 
                        HttpServletResponse response, 
                        Object handler, 
                        Exception ex);
}
```

### 3.2 ä¸‰ä¸ªæ–¹æ³•è¯¦è§£


#### ğŸ”¸ preHandle - å‰ç½®å¤„ç†


**ä½œç”¨**ï¼šåœ¨Controlleræ–¹æ³•æ‰§è¡Œ**ä¹‹å‰**è°ƒç”¨

**è¿”å›å€¼**ï¼š
- `true`ï¼šæ”¾è¡Œï¼Œç»§ç»­æ‰§è¡Œåç»­æµç¨‹
- `false`ï¼šæ‹¦æˆªï¼Œä¸å†æ‰§è¡ŒController

**å…¸å‹ç”¨é€”**ï¼š
```
âœ… ç™»å½•æ£€æŸ¥ï¼šæ²¡ç™»å½•å°±return false
âœ… æƒé™éªŒè¯ï¼šæ²¡æƒé™å°±return false  
âœ… å‚æ•°æ ¡éªŒï¼šå‚æ•°ä¸åˆæ³•å°±return false
```

**ç¤ºä¾‹ä»£ç **ï¼š
```java
@Override
public boolean preHandle(HttpServletRequest request, 
                        HttpServletResponse response, 
                        Object handler) {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
    HttpSession session = request.getSession();
    Object user = session.getAttribute("user");
    
    if (user == null) {
        // æ²¡ç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
        response.sendRedirect("/login");
        return false; // æ‹¦æˆªè¯·æ±‚
    }
    
    return true; // å·²ç™»å½•ï¼Œæ”¾è¡Œ
}
```

#### ğŸ”¸ postHandle - åç½®å¤„ç†


**ä½œç”¨**ï¼šåœ¨Controlleræ–¹æ³•æ‰§è¡Œ**ä¹‹å**ï¼Œè§†å›¾æ¸²æŸ“**ä¹‹å‰**è°ƒç”¨

**ä»€ä¹ˆæ—¶å€™ç”¨**ï¼šéœ€è¦ä¿®æ”¹Controllerè¿”å›çš„æ•°æ®æ—¶

**å…¸å‹ç”¨é€”**ï¼š
```
âœ… ç»Ÿä¸€æ·»åŠ è¿”å›æ•°æ®ï¼ˆå¦‚ç”¨æˆ·ä¿¡æ¯ï¼‰
âœ… ä¿®æ”¹ModelAndView
âœ… è®°å½•Controlleræ‰§è¡Œæ—¶é—´
```

**ç¤ºä¾‹ä»£ç **ï¼š
```java
@Override
public void postHandle(HttpServletRequest request, 
                      HttpServletResponse response, 
                      Object handler, 
                      ModelAndView modelAndView) {
    // ç»™æ‰€æœ‰é¡µé¢ç»Ÿä¸€æ·»åŠ ç”¨æˆ·ä¿¡æ¯
    if (modelAndView != null) {
        HttpSession session = request.getSession();
        Object user = session.getAttribute("user");
        modelAndView.addObject("currentUser", user);
    }
}
```

**âš ï¸ æ³¨æ„**ï¼šå¦‚æœpreHandleè¿”å›falseï¼ŒpostHandleä¸ä¼šæ‰§è¡Œï¼

#### ğŸ”¸ afterCompletion - å®Œæˆå¤„ç†


**ä½œç”¨**ï¼šæ•´ä¸ªè¯·æ±‚å®Œæˆ**ä¹‹å**è°ƒç”¨ï¼ˆè§†å›¾å·²ç»æ¸²æŸ“å®Œï¼‰

**ç‰¹ç‚¹**ï¼šæ— è®ºå‰é¢æ˜¯å¦å‡ºé”™ï¼Œè¿™ä¸ªæ–¹æ³•**ä¸€å®šä¼šæ‰§è¡Œ**ï¼ˆç±»ä¼¼finallyï¼‰

**å…¸å‹ç”¨é€”**ï¼š
```
âœ… è®°å½•æ—¥å¿—
âœ… é‡Šæ”¾èµ„æºï¼ˆå…³é—­è¿æ¥ï¼‰
âœ… æ€§èƒ½ç›‘æ§ï¼ˆè®°å½•æ€»è€—æ—¶ï¼‰
```

**ç¤ºä¾‹ä»£ç **ï¼š
```java
@Override
public void afterCompletion(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler, 
                           Exception ex) {
    // è®°å½•è¯·æ±‚å¤„ç†å®Œæˆ
    String url = request.getRequestURI();
    long endTime = System.currentTimeMillis();
    
    // å‡è®¾åœ¨preHandleä¸­è®°å½•äº†å¼€å§‹æ—¶é—´
    Long startTime = (Long) request.getAttribute("startTime");
    long duration = endTime - startTime;
    
    System.out.println("è¯·æ±‚" + url + "å¤„ç†å®Œæˆï¼Œè€—æ—¶ï¼š" + duration + "ms");
    
    // å¦‚æœæœ‰å¼‚å¸¸ï¼Œè®°å½•å¼‚å¸¸ä¿¡æ¯
    if (ex != null) {
        System.err.println("è¯·æ±‚å‡ºé”™ï¼š" + ex.getMessage());
    }
}
```

### 3.3 ä¸‰ä¸ªæ–¹æ³•å¯¹æ¯”è¡¨


| æ–¹æ³• | æ‰§è¡Œæ—¶æœº | è¿”å›å€¼ | ä¸»è¦ç”¨é€” | æ˜¯å¦å¿…é¡»å®ç° |
|------|----------|--------|----------|--------------|
| **preHandle** | Controlleræ‰§è¡Œå‰ | boolean | ç™»å½•æ£€æŸ¥ã€æƒé™éªŒè¯ | âŒï¼ˆä½†æœ€å¸¸ç”¨ï¼‰ |
| **postHandle** | Controlleræ‰§è¡Œå | void | ä¿®æ”¹è¿”å›æ•°æ® | âŒ |
| **afterCompletion** | è¯·æ±‚å®Œæˆå | void | è®°å½•æ—¥å¿—ã€æ¸…ç†èµ„æº | âŒ |

**ğŸ”¹ å®ç°æŠ€å·§**ï¼š
- å¦‚æœåªéœ€è¦ç™»å½•æ£€æŸ¥ï¼Œåªå®ç°`preHandle`å³å¯
- ä¸‰ä¸ªæ–¹æ³•éƒ½æ˜¯å¯é€‰çš„ï¼ŒæŒ‰éœ€å®ç°
- å»ºè®®ä½¿ç”¨`HandlerInterceptorAdapter`é€‚é…å™¨ç±»ï¼Œåªé‡å†™éœ€è¦çš„æ–¹æ³•

---

## 4. ğŸ”¨ æ‹¦æˆªå™¨çš„é…ç½®ä¸æ³¨å†Œ


### 4.1 åˆ›å»ºæ‹¦æˆªå™¨ç±»


**æ­¥éª¤1**ï¼šåˆ›å»ºæ‹¦æˆªå™¨ç±»ï¼Œå®ç°HandlerInterceptoræ¥å£

```java
// ç™»å½•æ£€æŸ¥æ‹¦æˆªå™¨
public class LoginInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) throws Exception {
        // æ£€æŸ¥sessionä¸­æ˜¯å¦æœ‰ç”¨æˆ·ä¿¡æ¯
        HttpSession session = request.getSession();
        Object user = session.getAttribute("user");
        
        if (user == null) {
            // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
            response.sendRedirect("/login");
            return false;
        }
        
        return true; // å·²ç™»å½•ï¼Œæ”¾è¡Œ
    }
}
```

### 4.2 æ³¨å†Œæ‹¦æˆªå™¨ï¼ˆä¸¤ç§æ–¹å¼ï¼‰


#### ğŸ”¸ æ–¹å¼1ï¼šXMLé…ç½®ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰


```xml
<!-- spring-mvc.xml -->
<mvc:interceptors>
    <!-- é…ç½®æ‹¦æˆªå™¨ -->
    <mvc:interceptor>
        <!-- æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ -->
        <mvc:mapping path="/**"/>
        <!-- æ’é™¤ç™»å½•ç›¸å…³è¯·æ±‚ -->
        <mvc:exclude-mapping path="/login"/>
        <mvc:exclude-mapping path="/register"/>
        <!-- æŒ‡å®šæ‹¦æˆªå™¨ç±» -->
        <bean class="com.example.interceptor.LoginInterceptor"/>
    </mvc:interceptor>
</mvc:interceptors>
```

#### ğŸ”¸ æ–¹å¼2ï¼šJavaé…ç½®ï¼ˆæ¨èï¼ŒSpringBootå¸¸ç”¨ï¼‰


```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // æ³¨å†Œç™»å½•æ‹¦æˆªå™¨
        registry.addInterceptor(new LoginInterceptor())
                .addPathPatterns("/**")        // æ‹¦æˆªæ‰€æœ‰è¯·æ±‚
                .excludePathPatterns(          // æ’é™¤è¿™äº›è·¯å¾„
                    "/login",
                    "/register", 
                    "/static/**"               // é™æ€èµ„æº
                );
    }
}
```

### 4.3 è·¯å¾„åŒ¹é…è§„åˆ™


| é€šé…ç¬¦ | å«ä¹‰ | ç¤ºä¾‹ | åŒ¹é…è¯´æ˜ |
|--------|------|------|----------|
| `?` | åŒ¹é…1ä¸ªå­—ç¬¦ | `/user/?` | åŒ¹é… /user/1ï¼Œä¸åŒ¹é… /user/12 |
| `*` | åŒ¹é…0æˆ–å¤šä¸ªå­—ç¬¦ | `/user/*` | åŒ¹é… /user/listï¼Œä¸åŒ¹é… /user/a/b |
| `**` | åŒ¹é…0æˆ–å¤šå±‚è·¯å¾„ | `/user/**` | åŒ¹é… /user/a/b/c æ‰€æœ‰å­è·¯å¾„ |

**å®ç”¨é…ç½®ç¤ºä¾‹**ï¼š
```java
registry.addInterceptor(new LoginInterceptor())
    .addPathPatterns("/admin/**")      // åªæ‹¦æˆªç®¡ç†å‘˜é¡µé¢
    .addPathPatterns("/user/**")       // å’Œç”¨æˆ·ç›¸å…³é¡µé¢
    .excludePathPatterns(              // ä½†ä¸æ‹¦æˆªè¿™äº›
        "/user/login",
        "/user/register",
        "/**/*.html",                  // æ‰€æœ‰htmlé™æ€é¡µ
        "/**/*.js",                    // jsæ–‡ä»¶
        "/**/*.css"                    // cssæ–‡ä»¶
    );
```

---

## 5. ğŸ”„ æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåºä¸æ‹¦æˆªå™¨é“¾


### 5.1 ä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨é“¾


**æ‹¦æˆªå™¨é“¾**ï¼šå¤šä¸ªæ‹¦æˆªå™¨æŒ‰ç…§æ³¨å†Œé¡ºåºï¼Œåƒé“¾æ¡ä¸€æ ·ä¾æ¬¡æ‰§è¡Œã€‚

**ç†è§£æ‹¦æˆªå™¨é“¾**ï¼š
```
æƒ³è±¡ä½ å»åŠäº‹ï¼Œè¦ç»è¿‡3ä¸ªçª—å£ï¼š

çª—å£Aï¼ˆèº«ä»½éªŒè¯ï¼‰â†’ çª—å£Bï¼ˆèµ„æ–™å®¡æ ¸ï¼‰â†’ çª—å£Cï¼ˆç›–ç« ï¼‰

åŠäº‹æµç¨‹ï¼š
è¿›é—¨ â†’ Aæ£€æŸ¥ â†’ Bæ£€æŸ¥ â†’ Cæ£€æŸ¥ â†’ åŠç†ä¸šåŠ¡ â†’ Cè®°å½• â†’ Bè®°å½• â†’ Aè®°å½• â†’ å‡ºé—¨

è¿™å°±æ˜¯æ‹¦æˆªå™¨é“¾ï¼
```

### 5.2 æ‰§è¡Œé¡ºåºè§„åˆ™


**é…ç½®é¡ºåºå†³å®šæ‰§è¡Œé¡ºåº**ï¼š

```java
@Override
public void addInterceptors(InterceptorRegistry registry) {
    // ç¬¬1ä¸ªæ³¨å†Œ
    registry.addInterceptor(new LoginInterceptor());
    
    // ç¬¬2ä¸ªæ³¨å†Œ  
    registry.addInterceptor(new PermissionInterceptor());
    
    // ç¬¬3ä¸ªæ³¨å†Œ
    registry.addInterceptor(new LogInterceptor());
}
```

**æ‰§è¡Œæµç¨‹å›¾**ï¼š
```
è¯·æ±‚åˆ°è¾¾
    â†“
ã€æ‹¦æˆªå™¨1ã€‘preHandle() - ç™»å½•æ£€æŸ¥
    â†“ (è¿”å›true)
ã€æ‹¦æˆªå™¨2ã€‘preHandle() - æƒé™æ£€æŸ¥
    â†“ (è¿”å›true)
ã€æ‹¦æˆªå™¨3ã€‘preHandle() - è®°å½•å¼€å§‹æ—¶é—´
    â†“
Controllerå¤„ç†ä¸šåŠ¡
    â†“
ã€æ‹¦æˆªå™¨3ã€‘postHandle() - æ·»åŠ å“åº”ä¿¡æ¯
    â†“
ã€æ‹¦æˆªå™¨2ã€‘postHandle() - ä¿®æ”¹æ•°æ®
    â†“
ã€æ‹¦æˆªå™¨1ã€‘postHandle() - ç»Ÿä¸€å¤„ç†
    â†“
æ¸²æŸ“è§†å›¾
    â†“
ã€æ‹¦æˆªå™¨3ã€‘afterCompletion() - è®°å½•ç»“æŸæ—¶é—´
    â†“
ã€æ‹¦æˆªå™¨2ã€‘afterCompletion() - æ¸…ç†æƒé™ç¼“å­˜
    â†“
ã€æ‹¦æˆªå™¨1ã€‘afterCompletion() - è®°å½•æ—¥å¿—
    â†“
è¿”å›å“åº”
```

**ğŸ”¸ è®°ä½å£è¯€**ï¼š
```
preHandleï¼šæ­£ç€èµ°ï¼ˆ1â†’2â†’3ï¼‰
postHandleï¼šå€’ç€èµ°ï¼ˆ3â†’2â†’1ï¼‰
afterCompletionï¼šå€’ç€èµ°ï¼ˆ3â†’2â†’1ï¼‰
```

### 5.3 æ‹¦æˆªå™¨é“¾çš„çŸ­è·¯æœºåˆ¶


**å¦‚æœæŸä¸ªæ‹¦æˆªå™¨çš„preHandleè¿”å›falseï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ**

```
å‡è®¾æ‹¦æˆªå™¨2çš„preHandleè¿”å›falseï¼š

ã€æ‹¦æˆªå™¨1ã€‘preHandle() âœ… è¿”å›true
    â†“
ã€æ‹¦æˆªå™¨2ã€‘preHandle() âŒ è¿”å›falseï¼ˆåœ¨è¿™é‡Œè¢«æ‹¦æˆªï¼ï¼‰
    â†“
è¯·æ±‚è¢«æ‹¦æˆªï¼Œåç»­æ‹¦æˆªå™¨å’ŒControlleréƒ½ä¸æ‰§è¡Œ
    â†“
ã€æ‹¦æˆªå™¨1ã€‘afterCompletion() âœ… ä»ç„¶æ‰§è¡Œï¼ˆæ¸…ç†èµ„æºï¼‰
    â†“
è¿”å›å“åº”ï¼ˆå¯èƒ½æ˜¯é‡å®šå‘åˆ°ç™»å½•é¡µï¼‰
```

**é‡è¦è§„åˆ™**ï¼š
- âœ… **å·²æ‰§è¡Œçš„æ‹¦æˆªå™¨çš„afterCompletionä¼šè¢«è°ƒç”¨**ï¼ˆç”¨äºæ¸…ç†ï¼‰
- âŒ **åç»­æ‹¦æˆªå™¨çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¸ä¼šæ‰§è¡Œ**
- âŒ **Controllerä¸ä¼šæ‰§è¡Œ**
- âŒ **postHandleä¸ä¼šæ‰§è¡Œ**

### 5.4 å®é™…æ‰§è¡Œåœºæ™¯æ¼”ç¤º


**åœºæ™¯**ï¼šç™»å½•æ£€æŸ¥ + æƒé™éªŒè¯ + æ—¥å¿—è®°å½•

```java
// æ‹¦æˆªå™¨1ï¼šç™»å½•æ£€æŸ¥
public class LoginInterceptor implements HandlerInterceptor {
    public boolean preHandle(...) {
        System.out.println("1. æ£€æŸ¥ç™»å½•çŠ¶æ€");
        return session.getAttribute("user") != null;
    }
    
    public void afterCompletion(...) {
        System.out.println("6. ç™»å½•æ‹¦æˆªå™¨å®Œæˆ");
    }
}

// æ‹¦æˆªå™¨2ï¼šæƒé™æ£€æŸ¥
public class PermissionInterceptor implements HandlerInterceptor {
    public boolean preHandle(...) {
        System.out.println("2. æ£€æŸ¥ç”¨æˆ·æƒé™");
        return checkPermission();
    }
    
    public void afterCompletion(...) {
        System.out.println("5. æƒé™æ‹¦æˆªå™¨å®Œæˆ");
    }
}

// æ‹¦æˆªå™¨3ï¼šæ—¥å¿—è®°å½•
public class LogInterceptor implements HandlerInterceptor {
    public boolean preHandle(...) {
        System.out.println("3. è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´");
        return true;
    }
    
    public void afterCompletion(...) {
        System.out.println("4. è®°å½•è¯·æ±‚ç»“æŸï¼Œç»Ÿè®¡è€—æ—¶");
    }
}
```

**æ§åˆ¶å°è¾“å‡º**ï¼š
```
1. æ£€æŸ¥ç™»å½•çŠ¶æ€
2. æ£€æŸ¥ç”¨æˆ·æƒé™
3. è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
[Controlleræ‰§è¡Œä¸šåŠ¡é€»è¾‘]
4. è®°å½•è¯·æ±‚ç»“æŸï¼Œç»Ÿè®¡è€—æ—¶
5. æƒé™æ‹¦æˆªå™¨å®Œæˆ
6. ç™»å½•æ‹¦æˆªå™¨å®Œæˆ
```

---

## 6. ğŸš€ æ‹¦æˆªå™¨å®æˆ˜åº”ç”¨


### 6.1 ç™»å½•é‰´æƒæ‹¦æˆªå™¨


**éœ€æ±‚**ï¼šç”¨æˆ·å¿…é¡»ç™»å½•æ‰èƒ½è®¿é—®ï¼Œæœªç™»å½•è·³è½¬åˆ°ç™»å½•é¡µ

```java
@Component
public class LoginCheckInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) throws Exception {
        
        // 1. è·å–è¯·æ±‚è·¯å¾„
        String uri = request.getRequestURI();
        
        // 2. åˆ¤æ–­æ˜¯å¦æ˜¯ç™»å½•è¯·æ±‚ï¼ˆç™»å½•è¯·æ±‚ç›´æ¥æ”¾è¡Œï¼‰
        if (uri.contains("/login")) {
            return true;
        }
        
        // 3. æ£€æŸ¥sessionä¸­æ˜¯å¦æœ‰ç”¨æˆ·ä¿¡æ¯
        HttpSession session = request.getSession();
        Object user = session.getAttribute("loginUser");
        
        // 4. å·²ç™»å½•ï¼Œæ”¾è¡Œ
        if (user != null) {
            return true;
        }
        
        // 5. æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
        response.sendRedirect("/login?redirect=" + uri);
        return false;
    }
}
```

**é…ç½®æ‹¦æˆªå™¨**ï¼š
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Autowired
    private LoginCheckInterceptor loginCheckInterceptor;
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(loginCheckInterceptor)
                .addPathPatterns("/**")
                .excludePathPatterns(
                    "/login",           // ç™»å½•é¡µé¢
                    "/doLogin",         // ç™»å½•è¯·æ±‚
                    "/register",        // æ³¨å†Œé¡µé¢
                    "/static/**"        // é™æ€èµ„æº
                );
    }
}
```

### 6.2 æƒé™æ§åˆ¶æ‹¦æˆªå™¨


**éœ€æ±‚**ï¼šä¸åŒç”¨æˆ·æœ‰ä¸åŒæƒé™ï¼Œè®¿é—®éœ€è¦æƒé™çš„èµ„æºæ—¶æ£€æŸ¥

```java
@Component
public class PermissionInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) throws Exception {
        
        // 1. è·å–ç”¨æˆ·è§’è‰²
        HttpSession session = request.getSession();
        User user = (User) session.getAttribute("loginUser");
        
        // 2. è·å–è¯·æ±‚è·¯å¾„
        String uri = request.getRequestURI();
        
        // 3. åˆ¤æ–­æ˜¯å¦æ˜¯ç®¡ç†å‘˜é¡µé¢
        if (uri.startsWith("/admin")) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜
            if (!"admin".equals(user.getRole())) {
                // ä¸æ˜¯ç®¡ç†å‘˜ï¼Œè¿”å›403
                response.setStatus(HttpServletResponse.SC_FORBIDDEN);
                response.getWriter().write("æ— æƒé™è®¿é—®");
                return false;
            }
        }
        
        return true;
    }
}
```

### 6.3 æ—¥å¿—è®°å½•æ‹¦æˆªå™¨


**éœ€æ±‚**ï¼šè®°å½•æ¯ä¸ªè¯·æ±‚çš„è®¿é—®æ—¥å¿—ï¼ŒåŒ…æ‹¬IPã€URLã€è€—æ—¶

```java
@Component
public class LogInterceptor implements HandlerInterceptor {
    
    private static final Logger log = LoggerFactory.getLogger(LogInterceptor.class);
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) throws Exception {
        
        // è®°å½•å¼€å§‹æ—¶é—´
        long startTime = System.currentTimeMillis();
        request.setAttribute("startTime", startTime);
        
        // è®°å½•è¯·æ±‚ä¿¡æ¯
        String ip = request.getRemoteAddr();
        String url = request.getRequestURI();
        String method = request.getMethod();
        
        log.info("è¯·æ±‚å¼€å§‹ - IP:{}, URL:{}, Method:{}", ip, url, method);
        
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                               HttpServletResponse response, 
                               Object handler, 
                               Exception ex) throws Exception {
        
        // è®¡ç®—è€—æ—¶
        long startTime = (Long) request.getAttribute("startTime");
        long endTime = System.currentTimeMillis();
        long duration = endTime - startTime;
        
        // è®°å½•å®Œæˆä¿¡æ¯
        String url = request.getRequestURI();
        log.info("è¯·æ±‚å®Œæˆ - URL:{}, è€—æ—¶:{}ms", url, duration);
        
        // å¦‚æœæœ‰å¼‚å¸¸ï¼Œè®°å½•å¼‚å¸¸
        if (ex != null) {
            log.error("è¯·æ±‚å¼‚å¸¸ - URL:{}, å¼‚å¸¸:{}", url, ex.getMessage());
        }
    }
}
```

### 6.4 æ€§èƒ½ç›‘æ§æ‹¦æˆªå™¨


**éœ€æ±‚**ï¼šç›‘æ§æ¥å£æ€§èƒ½ï¼Œå¦‚æœå“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼å°±å‘Šè­¦

```java
@Component
public class PerformanceInterceptor implements HandlerInterceptor {
    
    private static final long SLOW_REQUEST_THRESHOLD = 1000; // 1ç§’
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) throws Exception {
        
        request.setAttribute("startTime", System.currentTimeMillis());
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                               HttpServletResponse response, 
                               Object handler, 
                               Exception ex) throws Exception {
        
        long startTime = (Long) request.getAttribute("startTime");
        long duration = System.currentTimeMillis() - startTime;
        
        // å¦‚æœå“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼
        if (duration > SLOW_REQUEST_THRESHOLD) {
            String url = request.getRequestURI();
            String method = request.getMethod();
            
            // è®°å½•æ…¢è¯·æ±‚
            System.err.println("âš ï¸ æ…¢è¯·æ±‚å‘Šè­¦ï¼");
            System.err.println("URL: " + url);
            System.err.println("Method: " + method);
            System.err.println("è€—æ—¶: " + duration + "ms");
            
            // è¿™é‡Œå¯ä»¥å‘é€å‘Šè­¦é€šçŸ¥
            // sendAlert(url, duration);
        }
    }
}
```

---

## 7. ğŸ”€ æ‹¦æˆªå™¨vsè¿‡æ»¤å™¨


### 7.1 ä¸¤è€…çš„åŒºåˆ«


å¾ˆå¤šåŒå­¦å®¹æ˜“æ··æ·†æ‹¦æˆªå™¨å’Œè¿‡æ»¤å™¨ï¼Œæˆ‘ä»¬è¯¦ç»†å¯¹æ¯”ä¸€ä¸‹ï¼š

| å¯¹æ¯”é¡¹ | æ‹¦æˆªå™¨ Interceptor | è¿‡æ»¤å™¨ Filter |
|--------|-------------------|---------------|
| **æ‰€å±** | SpringMVCæ¡†æ¶ | Servletè§„èŒƒ |
| **æ‹¦æˆªèŒƒå›´** | åªæ‹¦æˆªControllerè¯·æ±‚ | æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼ˆåŒ…æ‹¬é™æ€èµ„æºï¼‰ |
| **æ‰§è¡Œæ—¶æœº** | DispatcherServletä¹‹å | DispatcherServletä¹‹å‰ |
| **é…ç½®æ–¹å¼** | SpringMVCé…ç½® | web.xmlæˆ–@WebFilter |
| **ä¾èµ–æ³¨å…¥** | âœ… å¯ä»¥æ³¨å…¥Spring Bean | âŒ ä¸èƒ½æ³¨å…¥ï¼ˆé™¤éç‰¹æ®Šé…ç½®ï¼‰ |
| **æ‰§è¡Œæ¬¡æ•°** | 3ä¸ªæ–¹æ³•ï¼ˆpre/post/afterï¼‰ | 2ä¸ªæ–¹æ³•ï¼ˆbefore/afterï¼‰ |
| **åŠŸèƒ½ä¾§é‡** | ä¸šåŠ¡ç›¸å…³ï¼ˆç™»å½•ã€æƒé™ï¼‰ | æŠ€æœ¯ç›¸å…³ï¼ˆç¼–ç ã€è·¨åŸŸï¼‰ |

### 7.2 æ‰§è¡Œé¡ºåºå¯¹æ¯”


```
å®Œæ•´è¯·æ±‚æµç¨‹ï¼š

æµè§ˆå™¨å‘èµ·è¯·æ±‚
    â†“
ã€Filterè¿‡æ»¤å™¨ã€‘doFilter() - å¼€å§‹
    â†“
DispatcherServletï¼ˆå‰ç«¯æ§åˆ¶å™¨ï¼‰
    â†“
ã€Interceptoræ‹¦æˆªå™¨ã€‘preHandle()
    â†“
Controllerå¤„ç†ä¸šåŠ¡
    â†“
ã€Interceptoræ‹¦æˆªå™¨ã€‘postHandle()
    â†“
ã€Interceptoræ‹¦æˆªå™¨ã€‘afterCompletion()
    â†“
ã€Filterè¿‡æ»¤å™¨ã€‘doFilter() - ç»“æŸ
    â†“
è¿”å›å“åº”ç»™æµè§ˆå™¨
```

**å½¢è±¡ç†è§£**ï¼š
```
è¿‡æ»¤å™¨åƒå°åŒºå¤§é—¨çš„ä¿å®‰ï¼ˆç®¡æ‰€æœ‰äººï¼‰
æ‹¦æˆªå™¨åƒå…¬å¸å‰å°ï¼ˆåªç®¡æ¥åŠå…¬çš„äººï¼‰

æµç¨‹ï¼š
1. è¿›å°åŒºé—¨ - è¿‡æ»¤å™¨æ£€æŸ¥
2. è¿›å…¬å¸æ¥¼ - DispatcherServlet
3. åˆ°å‰å°ç™»è®° - æ‹¦æˆªå™¨æ£€æŸ¥
4. è¿›åŠå…¬å®¤ - Controller
5. å‰å°è®°å½• - æ‹¦æˆªå™¨è®°å½•
6. å‡ºå°åŒºé—¨ - è¿‡æ»¤å™¨è®°å½•
```

### 7.3 ä½¿ç”¨åœºæ™¯é€‰æ‹©


**ä»€ä¹ˆæ—¶å€™ç”¨è¿‡æ»¤å™¨ï¼Ÿ**
```
âœ… ç¼–ç è®¾ç½®ï¼ˆCharacterEncodingFilterï¼‰
âœ… è·¨åŸŸå¤„ç†ï¼ˆCorsFilterï¼‰
âœ… æ•æ„Ÿè¯è¿‡æ»¤
âœ… è¯·æ±‚æ—¥å¿—ï¼ˆè®°å½•æ‰€æœ‰è¯·æ±‚ï¼‰
âœ… é™æ€èµ„æºå¤„ç†
```

**ä»€ä¹ˆæ—¶å€™ç”¨æ‹¦æˆªå™¨ï¼Ÿ**
```
âœ… ç™»å½•é‰´æƒï¼ˆéœ€è¦è®¿é—®Sessionï¼‰
âœ… æƒé™æ§åˆ¶ï¼ˆéœ€è¦è®¿é—®Springå®¹å™¨ï¼‰
âœ… ä¸šåŠ¡æ—¥å¿—ï¼ˆåªè®°å½•Controllerè¯·æ±‚ï¼‰
âœ… æ€§èƒ½ç›‘æ§ï¼ˆç»Ÿè®¡Controllerè€—æ—¶ï¼‰
```

### 7.4 è¿‡æ»¤å™¨ç¤ºä¾‹ï¼ˆå¯¹æ¯”å‚è€ƒï¼‰


```java
// ç¼–ç è¿‡æ»¤å™¨ç¤ºä¾‹
@WebFilter("/*")
public class EncodingFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, 
                        ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        // å‰ç½®å¤„ç†
        request.setCharacterEncoding("UTF-8");
        response.setCharacterEncoding("UTF-8");
        
        // æ”¾è¡Œ
        chain.doFilter(request, response);
        
        // åç½®å¤„ç†
        // ...
    }
}
```

**å¯¹æ¯”æ‹¦æˆªå™¨**ï¼š
```java
// æ‹¦æˆªå™¨å¯ä»¥è®¿é—®Spring Bean
@Component
public class LoginInterceptor implements HandlerInterceptor {
    
    @Autowired
    private UserService userService; // å¯ä»¥æ³¨å…¥Service
    
    @Override
    public boolean preHandle(...) {
        // å¯ä»¥è°ƒç”¨Serviceå±‚æ–¹æ³•
        User user = userService.getCurrentUser();
        return user != null;
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ æ‹¦æˆªå™¨çš„æœ¬è´¨**
```
æ‹¦æˆªå™¨ = åœ¨Controllerå‰åæ’å…¥è‡ªå®šä¹‰é€»è¾‘çš„æœºåˆ¶
ç›®çš„ï¼šä¸æ”¹Controllerä»£ç ï¼Œå®ç°é€šç”¨åŠŸèƒ½ï¼ˆç™»å½•æ£€æŸ¥ã€æƒé™æ§åˆ¶ç­‰ï¼‰
```

**ğŸ”¸ HandlerInterceptorä¸‰ä¸ªæ–¹æ³•**
```
preHandleï¼šControlleræ‰§è¡Œå‰ï¼Œè¿”å›falseå¯æ‹¦æˆª
postHandleï¼šControlleræ‰§è¡Œåï¼Œå¯ä¿®æ”¹è¿”å›æ•°æ®
afterCompletionï¼šè¯·æ±‚å®Œæˆåï¼Œå¿…å®šæ‰§è¡Œï¼Œç”¨äºæ¸…ç†
```

**ğŸ”¸ æ‹¦æˆªå™¨é…ç½®è¦ç‚¹**
```
1. å®ç°HandlerInterceptoræ¥å£
2. åœ¨é…ç½®ç±»ä¸­æ³¨å†Œæ‹¦æˆªå™¨
3. é…ç½®æ‹¦æˆªè·¯å¾„å’Œæ’é™¤è·¯å¾„
4. å¤šä¸ªæ‹¦æˆªå™¨æŒ‰æ³¨å†Œé¡ºåºæ‰§è¡Œ
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ‰§è¡Œé¡ºåºè®°å¿†**
```
å£è¯€ï¼šè¿›é—¨æ­£ç€èµ°ï¼Œå‡ºé—¨å€’ç€èµ°

preHandleï¼š1â†’2â†’3ï¼ˆæ­£åºï¼‰
postHandleï¼š3â†’2â†’1ï¼ˆå€’åºï¼‰
afterCompletionï¼š3â†’2â†’1ï¼ˆå€’åºï¼‰
```

**ğŸ”¹ æ‹¦æˆªå™¨é“¾çŸ­è·¯è§„åˆ™**
```
æŸä¸ªæ‹¦æˆªå™¨preHandleè¿”å›falseï¼š
âœ… å·²æ‰§è¡Œçš„æ‹¦æˆªå™¨çš„afterCompletionä»ä¼šæ‰§è¡Œ
âŒ åç»­æ‰€æœ‰æ‹¦æˆªå™¨éƒ½ä¸æ‰§è¡Œ
âŒ Controllerä¸æ‰§è¡Œ
âŒ postHandleä¸æ‰§è¡Œ
```

**ğŸ”¹ æ‹¦æˆªå™¨vsè¿‡æ»¤å™¨å¿«é€ŸåŒºåˆ†**
```
è¿‡æ»¤å™¨ï¼šServletçº§åˆ«ï¼Œæ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼ŒæŠ€æœ¯å¤„ç†
æ‹¦æˆªå™¨ï¼šSpringMVCçº§åˆ«ï¼Œåªæ‹¦æˆªControllerï¼Œä¸šåŠ¡å¤„ç†
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**å…¸å‹åº”ç”¨åœºæ™¯**
- âœ… **ç™»å½•æ‹¦æˆª**ï¼šæ£€æŸ¥sessionï¼Œæœªç™»å½•è·³è½¬ç™»å½•é¡µ
- âœ… **æƒé™æ§åˆ¶**ï¼šæ£€æŸ¥ç”¨æˆ·è§’è‰²ï¼Œæ— æƒé™è¿”å›403
- âœ… **æ—¥å¿—è®°å½•**ï¼šè®°å½•è¯·æ±‚ä¿¡æ¯ã€å“åº”æ—¶é—´
- âœ… **æ€§èƒ½ç›‘æ§**ï¼šç»Ÿè®¡æ¥å£è€—æ—¶ï¼Œæ…¢è¯·æ±‚å‘Šè­¦

**æœ€ä½³å®è·µå»ºè®®**
1. ç™»å½•æ£€æŸ¥ç”¨æ‹¦æˆªå™¨ï¼Œç¼–ç è®¾ç½®ç”¨è¿‡æ»¤å™¨
2. æ‹¦æˆªå™¨åªå®ç°éœ€è¦çš„æ–¹æ³•ï¼Œä¸è¦å…¨éƒ¨å®ç°
3. åˆç†é…ç½®æ‹¦æˆªè·¯å¾„ï¼Œé¿å…æ‹¦æˆªé™æ€èµ„æº
4. å¤šä¸ªæ‹¦æˆªå™¨æŒ‰åŠŸèƒ½åˆ†ç¦»ï¼Œä¾¿äºç»´æŠ¤
5. afterCompletionä¸­åšèµ„æºæ¸…ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼

**æ ¸å¿ƒè®°å¿†**
```
æ‹¦æˆªå™¨åƒå®‰æ£€é—¨ï¼Œè¯·æ±‚å¿…é¡»ç»è¿‡æ£€æŸ¥
ä¸‰ä¸ªæ–¹æ³•æœ‰å…ˆåï¼ŒpreHandleæœ€å…³é”®
æ‰§è¡Œé¡ºåºæœ‰è§„å¾‹ï¼Œè¿›å‡ºæ–¹å‘è¦è®°ç‰¢
ç™»å½•æƒé™æ—¥å¿—ç›‘æ§ï¼Œæ‹¦æˆªå™¨æ¥å¸®å¤§å¿™
```