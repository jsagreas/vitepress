---
title: 7ã€åˆ†å¸ƒå¼è¿½è¸ªå®è·µ
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼è¿½è¸ªåŸºç¡€æ¦‚å¿µ](#1-åˆ†å¸ƒå¼è¿½è¸ªåŸºç¡€æ¦‚å¿µ)
2. [Micrometer Tracingé›†æˆ](#2-micrometer-tracingé›†æˆ)
3. [OpenTelemetryæ ‡å‡†å®è·µ](#3-opentelemetryæ ‡å‡†å®è·µ)
4. [TraceIdä¸SpanIdä¼ æ’­æœºåˆ¶](#4-traceidä¸spanidä¼ æ’­æœºåˆ¶)
5. [HTTPè¯·æ±‚é“¾è·¯è¿½è¸ª](#5-httpè¯·æ±‚é“¾è·¯è¿½è¸ª)
6. [æ—¥å¿—å…³è”TraceIdå®ç°](#6-æ—¥å¿—å…³è”traceidå®ç°)
7. [é“¾è·¯æ•°æ®é‡‡æ ·ç­–ç•¥](#7-é“¾è·¯æ•°æ®é‡‡æ ·ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” åˆ†å¸ƒå¼è¿½è¸ªåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼è¿½è¸ª


**ç®€å•ç†è§£**ï¼šæƒ³è±¡ä½ åœ¨ç½‘ä¸Šä¹°ä¸œè¥¿ï¼Œä»ä¸‹å•åˆ°æ”¶è´§è¦ç»è¿‡å¾ˆå¤šç¯èŠ‚

```
ä¼ ç»Ÿå•ä½“åº”ç”¨ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ åº”ç”¨å¤„ç† â†’ æ•°æ®åº“ â†’ è¿”å›ç»“æœ
(å°±åƒåœ¨å°å•†åº—ä¹°ä¸œè¥¿ï¼Œè€æ¿ä¸€ä¸ªäººæå®š)

å¾®æœåŠ¡åº”ç”¨ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡ â†’ ç‰©æµæœåŠ¡ â†’ è¿”å›ç»“æœ
(å°±åƒå¤§å•†åœºï¼Œæ¯ä¸ªéƒ¨é—¨è´Ÿè´£ä¸åŒç¯èŠ‚)
```

**åˆ†å¸ƒå¼è¿½è¸ªçš„ä½œç”¨**ï¼š
- ğŸ” **å…¨é“¾è·¯ç›‘æ§**ï¼šçœ‹æ¸…æ¥šè¯·æ±‚åœ¨å„ä¸ªæœåŠ¡é—´çš„å®Œæ•´è·¯å¾„
- â±ï¸ **æ€§èƒ½åˆ†æ**ï¼šçŸ¥é“æ¯ä¸ªç¯èŠ‚èŠ±äº†å¤šé•¿æ—¶é—´
- ğŸ› **é—®é¢˜å®šä½**ï¼šå¿«é€Ÿæ‰¾å‡ºå“ªä¸ªæœåŠ¡å‡ºäº†é—®é¢˜
- ğŸ“Š **ä¾èµ–å…³ç³»**ï¼šç†è§£æœåŠ¡ä¹‹é—´çš„è°ƒç”¨å…³ç³»

### 1.2 æ ¸å¿ƒæ¦‚å¿µè§£é‡Š


**Traceï¼ˆè¿½è¸ªï¼‰**ï¼š
- **å«ä¹‰**ï¼šä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚é“¾è·¯ï¼Œå°±åƒå¿«é€’çš„å®Œæ•´é…é€è·¯å¾„
- **ç»„æˆ**ï¼šåŒ…å«å¤šä¸ªSpanï¼Œä»£è¡¨æ•´ä¸ªä¸šåŠ¡æµç¨‹

**Spanï¼ˆè·¨åº¦ï¼‰**ï¼š
- **å«ä¹‰**ï¼šé“¾è·¯ä¸­çš„ä¸€ä¸ªæ“ä½œå•å…ƒï¼Œå°±åƒå¿«é€’åœ¨æŸä¸ªç«™ç‚¹çš„å¤„ç†è¿‡ç¨‹
- **ç‰¹ç‚¹**ï¼šæœ‰å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€æ“ä½œåç§°

**TraceIdï¼ˆè¿½è¸ªIDï¼‰**ï¼š
- **å«ä¹‰**ï¼šæ•´ä¸ªé“¾è·¯çš„å”¯ä¸€æ ‡è¯†ï¼Œå°±åƒå¿«é€’å•å·
- **ä½œç”¨**ï¼šæŠŠåˆ†æ•£åœ¨å„ä¸ªæœåŠ¡çš„æ“ä½œä¸²è”èµ·æ¥

**SpanIdï¼ˆè·¨åº¦IDï¼‰**ï¼š
- **å«ä¹‰**ï¼šå•ä¸ªæ“ä½œçš„å”¯ä¸€æ ‡è¯†ï¼Œå°±åƒæ¯ä¸ªå¤„ç†ç¯èŠ‚çš„ç¼–å·
- **å…³ç³»**ï¼šå¤šä¸ªSpanIdç»„æˆä¸€ä¸ªTraceId

### 1.3 åˆ†å¸ƒå¼è¿½è¸ªæ¶æ„


```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å¾®æœåŠ¡é›†ç¾¤                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ ç”¨æˆ·æœåŠ¡ â”‚â†’   â”‚ è®¢å•æœåŠ¡ â”‚â†’   â”‚ æ”¯ä»˜æœåŠ¡ â”‚         â”‚
â”‚  â”‚TraceId:Aâ”‚    â”‚TraceId:Aâ”‚    â”‚TraceId:Aâ”‚         â”‚
â”‚  â”‚SpanId:1 â”‚    â”‚SpanId:2 â”‚    â”‚SpanId:3 â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ï¼ˆè¿½è¸ªæ•°æ®ä¸ŠæŠ¥ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è¿½è¸ªç³»ç»Ÿï¼ˆå¦‚Zipkinã€Jaegerï¼‰           â”‚
â”‚  å­˜å‚¨ã€åˆ†æã€å±•ç¤ºæ‰€æœ‰è¿½è¸ªæ•°æ®                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. âš™ï¸ Micrometer Tracingé›†æˆ


### 2.1 Micrometer Tracingç®€ä»‹


**ä»€ä¹ˆæ˜¯Micrometer Tracing**ï¼š
- **å®˜æ–¹å®šä¹‰**ï¼šSpring Bootå®˜æ–¹æ¨èçš„è¿½è¸ªå·¥å…·
- **é€šä¿—ç†è§£**ï¼šå°±åƒåº”ç”¨çš„"è¡Œè½¦è®°å½•ä»ª"ï¼Œè®°å½•è¯·æ±‚çš„å®Œæ•´è·¯å¾„
- **æ ¸å¿ƒä»·å€¼**ï¼šç»Ÿä¸€çš„APIï¼Œæ”¯æŒå¤šç§è¿½è¸ªç³»ç»Ÿ

**ä¸ºä»€ä¹ˆé€‰æ‹©Micrometer Tracing**ï¼š
- âœ… **Springå®˜æ–¹æ”¯æŒ**ï¼šä¸Spring Bootæ·±åº¦é›†æˆ
- âœ… **æ ‡å‡†åŒ–API**ï¼šåˆ‡æ¢è¿½è¸ªç³»ç»Ÿä¸éœ€è¦æ”¹ä»£ç 
- âœ… **è‡ªåŠ¨é…ç½®**ï¼šå‡ ä¹é›¶é…ç½®å³å¯ä½¿ç”¨
- âœ… **æ€§èƒ½ä¼˜ç§€**ï¼šå¯¹åº”ç”¨æ€§èƒ½å½±å“å¾ˆå°

### 2.2 å¿«é€Ÿé›†æˆæ­¥éª¤


**ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ–**

```xml
<dependencies>
    <!-- Spring Boot Actuator -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    
    <!-- Micrometer Tracing -->
    <dependency>
        <groupId>io.micrometer</groupId>
        <artifactId>micrometer-tracing-bridge-brave</artifactId>
    </dependency>
    
    <!-- ZipkinæŠ¥å‘Šå™¨ï¼ˆå¯é€‰ï¼‰ -->
    <dependency>
        <groupId>io.zipkin.reporter2</groupId>
        <artifactId>zipkin-reporter-brave</artifactId>
    </dependency>
</dependencies>
```

**ç¬¬äºŒæ­¥ï¼šåŸºç¡€é…ç½®**

```yaml
# application.yml
management:
  tracing:
    sampling:
      probability: 1.0  # é‡‡æ ·ç‡100%ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
  zipkin:
    tracing:
      endpoint: http://localhost:9411/api/v2/spans

spring:
  application:
    name: user-service  # æœåŠ¡åç§°ï¼Œå¾ˆé‡è¦ï¼

logging:
  pattern:
    level: '%5p [${spring.application.name:},%X{traceId:-},%X{spanId:-}]'
```

> ğŸ’¡ **é…ç½®è§£é‡Š**ï¼š
> - `probability: 1.0`ï¼šå¼€å‘ç¯å¢ƒé‡‡æ ·100%ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®0.1ï¼ˆ10%ï¼‰
> - `endpoint`ï¼šZipkinæœåŠ¡åœ°å€ï¼Œç”¨äºæ”¶é›†è¿½è¸ªæ•°æ®
> - `traceId`ã€`spanId`ï¼šè‡ªåŠ¨æ·»åŠ åˆ°æ—¥å¿—ä¸­ï¼Œæ–¹ä¾¿é—®é¢˜å®šä½

### 2.3 éªŒè¯é›†æˆæ•ˆæœ


**åˆ›å»ºæµ‹è¯•æ§åˆ¶å™¨**ï¼š

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @GetMapping("/{id}")
    public ResponseEntity<User> getUser(@PathVariable Long id) {
        // è‡ªåŠ¨ç”ŸæˆSpanï¼Œè®°å½•HTTPè¯·æ±‚
        User user = userService.findById(id);
        return ResponseEntity.ok(user);
    }
}

@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    // è‡ªåŠ¨åˆ›å»ºæ–°çš„Span
    public User findById(Long id) {
        // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
        return userRepository.findById(id).orElse(null);
    }
}
```

**æŸ¥çœ‹æ•ˆæœ**ï¼š
1. å¯åŠ¨åº”ç”¨ï¼Œè®¿é—®æ¥å£ï¼š`GET /api/users/1`
2. æŸ¥çœ‹æ—¥å¿—ï¼Œä¼šçœ‹åˆ°TraceIdå’ŒSpanId
3. è®¿é—®Zipkin UIï¼š`http://localhost:9411`

---

## 3. ğŸŒ OpenTelemetryæ ‡å‡†å®è·µ


### 3.1 OpenTelemetryæ ‡å‡†ä»‹ç»


**ä»€ä¹ˆæ˜¯OpenTelemetry**ï¼š
- **å®˜æ–¹å®šä¹‰**ï¼šè§‚æµ‹æ€§æ•°æ®çš„ç»Ÿä¸€æ ‡å‡†
- **é€šä¿—ç†è§£**ï¼šå°±åƒUSBæ¥å£æ ‡å‡†ï¼Œè®©ä¸åŒå‚å•†çš„è®¾å¤‡èƒ½äº’ç›¸å…¼å®¹
- **æ ¸å¿ƒä»·å€¼**ï¼šç»Ÿä¸€çš„æ•°æ®æ ¼å¼ï¼Œé¿å…å‚å•†é”å®š

**OpenTelemetryåŒ…å«ä»€ä¹ˆ**ï¼š
- ğŸ“Š **Tracingï¼ˆè¿½è¸ªï¼‰**ï¼šè¯·æ±‚é“¾è·¯è¿½è¸ª
- ğŸ“ˆ **Metricsï¼ˆæŒ‡æ ‡ï¼‰**ï¼šæ€§èƒ½æŒ‡æ ‡ç›‘æ§  
- ğŸ“ **Loggingï¼ˆæ—¥å¿—ï¼‰**ï¼šç»“æ„åŒ–æ—¥å¿—è®°å½•

### 3.2 åˆ‡æ¢åˆ°OpenTelemetry


**ä¾èµ–é…ç½®**ï¼š

```xml
<dependencies>
    <!-- ç§»é™¤Braveï¼Œä½¿ç”¨OpenTelemetry -->
    <dependency>
        <groupId>io.micrometer</groupId>
        <artifactId>micrometer-tracing-bridge-otel</artifactId>
    </dependency>
    
    <!-- OpenTelemetryå¯¼å‡ºå™¨ -->
    <dependency>
        <groupId>io.opentelemetry</groupId>
        <artifactId>opentelemetry-exporter-zipkin</artifactId>
    </dependency>
</dependencies>
```

**é…ç½®è°ƒæ•´**ï¼š

```yaml
management:
  tracing:
    sampling:
      probability: 0.1  # ç”Ÿäº§ç¯å¢ƒå»ºè®®å€¼
  otlp:
    tracing:
      endpoint: http://localhost:4318/v1/traces  # OTLP endpoint
      
# æˆ–è€…ç»§ç»­ä½¿ç”¨Zipkin
management:
  zipkin:
    tracing:
      endpoint: http://localhost:9411/api/v2/spans
```

### 3.3 è‡ªå®šä¹‰Spanåˆ›å»º


```java
@Service
public class OrderService {
    
    private final Tracer tracer;
    
    public OrderService(Tracer tracer) {
        this.tracer = tracer;
    }
    
    public Order createOrder(OrderRequest request) {
        // åˆ›å»ºè‡ªå®šä¹‰Span
        Span span = tracer.nextSpan()
            .name("order-creation")  // Spanåç§°
            .tag("order.type", request.getType())  // æ·»åŠ æ ‡ç­¾
            .tag("user.id", request.getUserId().toString())
            .start();
        
        try (Tracer.SpanInScope ws = tracer.withSpanInScope(span)) {
            // ä¸šåŠ¡é€»è¾‘å¤„ç†
            Order order = processOrder(request);
            
            // æ·»åŠ ç»“æœä¿¡æ¯
            span.tag("order.id", order.getId().toString());
            span.tag("order.status", "created");
            
            return order;
        } catch (Exception e) {
            // è®°å½•å¼‚å¸¸
            span.tag("error", true);
            span.tag("error.message", e.getMessage());
            throw e;
        } finally {
            span.end();  // ç»“æŸSpan
        }
    }
}
```

---

## 4. ğŸ”— TraceIdä¸SpanIdä¼ æ’­æœºåˆ¶


### 4.1 ä¼ æ’­æœºåˆ¶åŸç†


**ä»€ä¹ˆæ˜¯ä¼ æ’­**ï¼š
- **ç®€å•ç†è§£**ï¼šå°±åƒæ¥åŠ›æ£’ä¼ é€’ï¼Œæ¯ä¸ªæœåŠ¡éƒ½è¦æŠŠTraceIdä¼ ç»™ä¸‹ä¸€ä¸ªæœåŠ¡
- **æŠ€æœ¯å®ç°**ï¼šé€šè¿‡HTTPå¤´éƒ¨ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰æ–¹å¼ä¼ é€’

**ä¼ æ’­è¿‡ç¨‹ç¤ºæ„**ï¼š

```
è¯·æ±‚æµç¨‹ï¼š
å®¢æˆ·ç«¯ â†’ ç½‘å…³ â†’ ç”¨æˆ·æœåŠ¡ â†’ è®¢å•æœåŠ¡ â†’ æ•°æ®åº“

TraceIdä¼ æ’­ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   TraceId:abc123   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   TraceId:abc123   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç½‘å…³   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ç”¨æˆ·æœåŠ¡ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚è®¢å•æœåŠ¡ â”‚
â”‚SpanId:1 â”‚                    â”‚SpanId:2 â”‚                    â”‚SpanId:3 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 HTTPè¯·æ±‚ä¼ æ’­


**è‡ªåŠ¨ä¼ æ’­**ï¼š
- Spring Bootä¼šè‡ªåŠ¨åœ¨HTTPè¯·æ±‚å¤´ä¸­æ·»åŠ è¿½è¸ªä¿¡æ¯
- å¸¸ç”¨çš„HTTPå¤´ï¼š`X-Trace-Id`ã€`X-Span-Id`ã€`traceparent`

**æ‰‹åŠ¨ä¼ æ’­ç¤ºä¾‹**ï¼š

```java
@Service
public class UserService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    public UserProfile getUserProfile(Long userId) {
        // Spring Bootè‡ªåŠ¨ä¼ æ’­TraceId
        // æ— éœ€æ‰‹åŠ¨è®¾ç½®HTTPå¤´
        String url = "http://profile-service/api/profiles/" + userId;
        return restTemplate.getForObject(url, UserProfile.class);
    }
}

// å¦‚æœéœ€è¦æ‰‹åŠ¨ä¼ æ’­
@Service  
public class ManualTracingService {
    
    public void callExternalService() {
        TraceContext context = Tracing.current().currentTraceContext().get();
        
        HttpHeaders headers = new HttpHeaders();
        headers.set("X-Trace-Id", context.traceId());
        headers.set("X-Span-Id", context.spanId());
        
        HttpEntity<String> entity = new HttpEntity<>(headers);
        restTemplate.exchange(url, HttpMethod.GET, entity, String.class);
    }
}
```

### 4.3 å¼‚æ­¥å¤„ç†ä¸­çš„ä¼ æ’­


```java
@Service
public class AsyncOrderService {
    
    private final Tracer tracer;
    
    @Async
    public CompletableFuture<String> processOrderAsync(Long orderId) {
        // å¼‚æ­¥æ–¹æ³•ä¸­éœ€è¦ç‰¹æ®Šå¤„ç†
        Span currentSpan = tracer.nextSpan().name("async-order-processing");
        
        try (Tracer.SpanInScope ws = tracer.withSpanInScope(currentSpan.start())) {
            // å¼‚æ­¥ä¸šåŠ¡é€»è¾‘
            Thread.sleep(1000); // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
            return CompletableFuture.completedFuture("å¤„ç†å®Œæˆ");
        } finally {
            currentSpan.end();
        }
    }
}
```

---

## 5. ğŸŒ HTTPè¯·æ±‚é“¾è·¯è¿½è¸ª


### 5.1 HTTPå®¢æˆ·ç«¯é…ç½®


**RestTemplateé…ç½®**ï¼š

```java
@Configuration
public class TracingConfig {
    
    // è‡ªåŠ¨é…ç½®çš„RestTemplateä¼šåŒ…å«è¿½è¸ªåŠŸèƒ½
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
    
    // å¦‚æœéœ€è¦è‡ªå®šä¹‰é…ç½®
    @Bean
    public RestTemplate customRestTemplate(RestTemplateBuilder builder) {
        return builder
            .setConnectTimeout(Duration.ofSeconds(5))
            .setReadTimeout(Duration.ofSeconds(10))
            .build();
    }
}
```

**WebClienté…ç½®**ï¼š

```java
@Configuration
public class WebClientConfig {
    
    @Bean
    public WebClient webClient() {
        return WebClient.builder()
            .baseUrl("http://order-service")
            .build();
    }
}

@Service
public class OrderClientService {
    
    @Autowired
    private WebClient webClient;
    
    public Mono<Order> getOrder(Long orderId) {
        return webClient.get()
            .uri("/api/orders/{id}", orderId)
            .retrieve()
            .bodyToMono(Order.class);
        // WebClientä¼šè‡ªåŠ¨ä¼ æ’­TraceId
    }
}
```

### 5.2 æœåŠ¡é—´è°ƒç”¨è¿½è¸ª


**åœºæ™¯ç¤ºä¾‹**ï¼šç”¨æˆ·ä¸‹å•æµç¨‹

```java
// ç”¨æˆ·æœåŠ¡
@RestController
public class UserOrderController {
    
    @Autowired
    private OrderServiceClient orderServiceClient;
    
    @PostMapping("/orders")
    public ResponseEntity<OrderResponse> createOrder(@RequestBody OrderRequest request) {
        // Span 1: HTTPè¯·æ±‚å¤„ç†
        
        // è°ƒç”¨è®¢å•æœåŠ¡ï¼ˆè‡ªåŠ¨åˆ›å»ºæ–°çš„Spanï¼‰
        OrderResponse response = orderServiceClient.createOrder(request);
        
        return ResponseEntity.ok(response);
    }
}

// è®¢å•æœåŠ¡å®¢æˆ·ç«¯
@Component
public class OrderServiceClient {
    
    @Autowired
    private RestTemplate restTemplate;
    
    public OrderResponse createOrder(OrderRequest request) {
        // Span 2: HTTPå®¢æˆ·ç«¯è°ƒç”¨
        String url = "http://order-service/api/orders";
        return restTemplate.postForObject(url, request, OrderResponse.class);
    }
}

// è®¢å•æœåŠ¡
@RestController
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    @PostMapping("/api/orders")
    public OrderResponse createOrder(@RequestBody OrderRequest request) {
        // Span 3: è®¢å•æœåŠ¡å¤„ç†
        return orderService.processOrder(request);
    }
}
```

**è¿½è¸ªæ•ˆæœå±•ç¤º**ï¼š

| Spanåç§° | æœåŠ¡åç§° | è€—æ—¶ | æ“ä½œ |
|---------|---------|------|------|
| `POST /orders` | user-service | 150ms | ç”¨æˆ·åˆ›å»ºè®¢å•è¯·æ±‚ |
| `POST /api/orders` | order-service | 120ms | è®¢å•æœåŠ¡å¤„ç† |
| `order-validation` | order-service | 50ms | è®¢å•éªŒè¯ |
| `inventory-check` | inventory-service | 80ms | åº“å­˜æ£€æŸ¥ |

---

## 6. ğŸ“ æ—¥å¿—å…³è”TraceIdå®ç°


### 6.1 Logbacké…ç½®


**é…ç½®æ—¥å¿—æ ¼å¼**ï¼š

```xml
<!-- logback-spring.xml -->
<configuration>
    <springProfile name="!prod">
        <!-- å¼€å‘ç¯å¢ƒï¼šåŒ…å«å®Œæ•´è¿½è¸ªä¿¡æ¯ -->
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
                <pattern>
                    %d{HH:mm:ss.SSS} %highlight(%-5level) [%blue(%thread)] [%yellow(%X{traceId:-})] [%yellow(%X{spanId:-})] %cyan(%logger{36}) - %msg%n
                </pattern>
            </encoder>
        </appender>
    </springProfile>
    
    <springProfile name="prod">
        <!-- ç”Ÿäº§ç¯å¢ƒï¼šJSONæ ¼å¼ä¾¿äºåˆ†æ -->
        <appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp/>
                    <version/>
                    <logLevel/>
                    <message/>
                    <mdc/>
                    <arguments/>
                    <stackTrace/>
                </providers>
            </encoder>
        </appender>
    </springProfile>
    
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
    </root>
</configuration>
```

### 6.2 åº”ç”¨ä¸­ä½¿ç”¨è¿½è¸ªæ—¥å¿—


```java
@Service
public class OrderProcessService {
    
    private static final Logger log = LoggerFactory.getLogger(OrderProcessService.class);
    
    public Order processOrder(OrderRequest request) {
        // æ—¥å¿—è‡ªåŠ¨åŒ…å«TraceIdå’ŒSpanId
        log.info("å¼€å§‹å¤„ç†è®¢å•ï¼Œç”¨æˆ·ID: {}", request.getUserId());
        
        try {
            // ä¸šåŠ¡å¤„ç†
            Order order = createOrder(request);
            
            // æˆåŠŸæ—¥å¿—
            log.info("è®¢å•åˆ›å»ºæˆåŠŸï¼Œè®¢å•ID: {}, é‡‘é¢: {}", 
                    order.getId(), order.getAmount());
            
            return order;
        } catch (Exception e) {
            // é”™è¯¯æ—¥å¿—ï¼ŒåŒæ ·åŒ…å«è¿½è¸ªä¿¡æ¯
            log.error("è®¢å•å¤„ç†å¤±è´¥ï¼Œç”¨æˆ·ID: {}, é”™è¯¯: {}", 
                     request.getUserId(), e.getMessage(), e);
            throw e;
        }
    }
}
```

**æ—¥å¿—è¾“å‡ºæ•ˆæœ**ï¼š

```
14:30:15.123 INFO  [http-nio-8080-exec-1] [abc123def456] [span789] c.e.service.OrderProcessService - å¼€å§‹å¤„ç†è®¢å•ï¼Œç”¨æˆ·ID: 12345
14:30:15.234 INFO  [http-nio-8080-exec-1] [abc123def456] [span790] c.e.service.InventoryService - æ£€æŸ¥å•†å“åº“å­˜ï¼Œå•†å“ID: 67890
14:30:15.456 INFO  [http-nio-8080-exec-1] [abc123def456] [span789] c.e.service.OrderProcessService - è®¢å•åˆ›å»ºæˆåŠŸï¼Œè®¢å•ID: 98765, é‡‘é¢: 299.00
```

### 6.3 è‡ªå®šä¹‰MDCä¿¡æ¯


```java
@Component
public class TracingEnhancer {
    
    public void addCustomTraceInfo(String userId, String businessType) {
        // æ·»åŠ è‡ªå®šä¹‰è¿½è¸ªä¿¡æ¯åˆ°MDC
        MDC.put("userId", userId);
        MDC.put("businessType", businessType);
        MDC.put("requestId", UUID.randomUUID().toString());
    }
    
    public void clearCustomTraceInfo() {
        // æ¸…ç†MDCï¼Œé¿å…å†…å­˜æ³„æ¼
        MDC.remove("userId");
        MDC.remove("businessType");
        MDC.remove("requestId");
    }
}

@RestController
public class EnhancedController {
    
    @Autowired
    private TracingEnhancer tracingEnhancer;
    
    @PostMapping("/enhanced-order")
    public ResponseEntity<String> createOrderWithTracing(@RequestBody OrderRequest request) {
        try {
            // æ·»åŠ è‡ªå®šä¹‰è¿½è¸ªä¿¡æ¯
            tracingEnhancer.addCustomTraceInfo(
                request.getUserId().toString(), 
                "ORDER_CREATION"
            );
            
            // ä¸šåŠ¡å¤„ç†...
            return ResponseEntity.ok("è®¢å•åˆ›å»ºæˆåŠŸ");
            
        } finally {
            // æ¸…ç†è¿½è¸ªä¿¡æ¯
            tracingEnhancer.clearCustomTraceInfo();
        }
    }
}
```

---

## 7. ğŸ“Š é“¾è·¯æ•°æ®é‡‡æ ·ç­–ç•¥


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦é‡‡æ ·


**é‡‡æ ·çš„å¿…è¦æ€§**ï¼š
- ğŸš€ **æ€§èƒ½è€ƒè™‘**ï¼š100%è¿½è¸ªä¼šæ˜¾è‘—å½±å“æ€§èƒ½
- ğŸ’° **æˆæœ¬æ§åˆ¶**ï¼šå‡å°‘å­˜å‚¨å’Œä¼ è¾“æˆæœ¬  
- ğŸ“ˆ **æ•°æ®ç®¡ç†**ï¼šé¿å…è¿½è¸ªæ•°æ®è¿‡å¤šéš¾ä»¥åˆ†æ

**é‡‡æ ·ç­–ç•¥å¯¹æ¯”**ï¼š

| é‡‡æ ·ç‡ | é€‚ç”¨åœºæ™¯ | æ€§èƒ½å½±å“ | æ•°æ®å®Œæ•´æ€§ |
|-------|---------|---------|-----------|
| **100%** | å¼€å‘/æµ‹è¯•ç¯å¢ƒ | è¾ƒé«˜ | å®Œæ•´ |
| **10%** | ç”Ÿäº§ç¯å¢ƒï¼ˆä¸€èˆ¬ï¼‰ | è¾ƒä½ | åŸºæœ¬å¤Ÿç”¨ |  
| **1%** | é«˜å¹¶å‘ç”Ÿäº§ç¯å¢ƒ | å¾ˆä½ | ç»Ÿè®¡åˆ†æå¤Ÿç”¨ |
| **0.1%** | è¶…å¤§è§„æ¨¡ç³»ç»Ÿ | æä½ | ä»…è¶‹åŠ¿åˆ†æ |

### 7.2 é…ç½®é‡‡æ ·ç­–ç•¥


**åŸºç¡€é‡‡æ ·é…ç½®**ï¼š

```yaml
management:
  tracing:
    sampling:
      probability: 0.1  # 10%é‡‡æ ·ç‡
      
# æ ¹æ®ç¯å¢ƒåŠ¨æ€é…ç½®
---
spring:
  profiles: dev
management:
  tracing:
    sampling:
      probability: 1.0  # å¼€å‘ç¯å¢ƒ100%

---  
spring:
  profiles: prod
management:
  tracing:
    sampling:
      probability: 0.01  # ç”Ÿäº§ç¯å¢ƒ1%
```

**è‡ªå®šä¹‰é‡‡æ ·å™¨**ï¼š

```java
@Configuration
public class CustomSamplingConfig {
    
    @Bean
    public ProbabilityBasedSampler customSampler() {
        // å¯ä»¥åŸºäºæ¡ä»¶åŠ¨æ€è°ƒæ•´é‡‡æ ·ç‡
        return ProbabilityBasedSampler.create(0.1f);
    }
    
    // æ›´å¤æ‚çš„é‡‡æ ·é€»è¾‘
    @Bean
    public Sampler conditionalSampler() {
        return new Sampler() {
            @Override
            public Decision sample(Context parentContext, TraceIdLong traceId, 
                                   String name, SpanKind spanKind, 
                                   AttributesBuilder attributes, 
                                   List<Link> parentLinks) {
                
                // é‡è¦æ¥å£100%é‡‡æ ·
                if (name.contains("payment") || name.contains("order")) {
                    return Decision.RECORD_AND_SAMPLE;
                }
                
                // å…¶ä»–æ¥å£10%é‡‡æ ·
                return traceId.getTraceRandomLong() % 10 == 0 ? 
                    Decision.RECORD_AND_SAMPLE : Decision.NOT_RECORD;
            }
        };
    }
}
```

### 7.3 åŠ¨æ€é‡‡æ ·è°ƒæ•´


```java
@RestController
@RequestMapping("/admin/tracing")
public class TracingAdminController {
    
    @Autowired
    private MeterRegistry meterRegistry;
    
    // åŠ¨æ€è°ƒæ•´é‡‡æ ·ç‡
    @PostMapping("/sampling-rate")
    public ResponseEntity<String> adjustSamplingRate(@RequestParam double rate) {
        if (rate < 0 || rate > 1) {
            return ResponseEntity.badRequest().body("é‡‡æ ·ç‡å¿…é¡»åœ¨0-1ä¹‹é—´");
        }
        
        // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…ä½¿ç”¨çš„è¿½è¸ªåº“æ¥å®ç°
        // ç¤ºä¾‹ï¼šæ›´æ–°é…ç½®æˆ–é‡æ–°åˆ›å»ºé‡‡æ ·å™¨
        updateSamplingRate(rate);
        
        return ResponseEntity.ok("é‡‡æ ·ç‡å·²è°ƒæ•´ä¸º: " + (rate * 100) + "%");
    }
    
    // è·å–å½“å‰è¿½è¸ªç»Ÿè®¡
    @GetMapping("/stats")
    public Map<String, Object> getTracingStats() {
        Map<String, Object> stats = new HashMap<>();
        
        // è·å–è¿½è¸ªç›¸å…³æŒ‡æ ‡
        Timer.Sample sample = Timer.start(meterRegistry);
        stats.put("total_spans", meterRegistry.counter("tracing.spans.total").count());
        stats.put("sampled_spans", meterRegistry.counter("tracing.spans.sampled").count());
        
        return stats;
    }
    
    private void updateSamplingRate(double rate) {
        // å®é™…å®ç°ä¾èµ–äºå…·ä½“çš„è¿½è¸ªé…ç½®
        System.setProperty("management.tracing.sampling.probability", String.valueOf(rate));
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†å¸ƒå¼è¿½è¸ªï¼šå¾®æœåŠ¡æ¶æ„ä¸‹çš„å…¨é“¾è·¯ç›‘æ§è§£å†³æ–¹æ¡ˆ
ğŸ”¸ Traceä¸Spanï¼šå®Œæ•´è¯·æ±‚é“¾è·¯å’Œå•ä¸ªæ“ä½œå•å…ƒçš„å…³ç³»  
ğŸ”¸ TraceIdä¼ æ’­ï¼šä¿è¯åˆ†æ•£æ“ä½œèƒ½å¤Ÿå…³è”æˆå®Œæ•´é“¾è·¯
ğŸ”¸ OpenTelemetryï¼šä¸šç•Œæ ‡å‡†çš„è§‚æµ‹æ€§æ•°æ®è§„èŒƒ
ğŸ”¸ é‡‡æ ·ç­–ç•¥ï¼šå¹³è¡¡æ€§èƒ½ä¸ç›‘æ§å®Œæ•´æ€§çš„é‡è¦æ‰‹æ®µ
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ åˆ†å¸ƒå¼è¿½è¸ªçš„ä»·å€¼**ï¼š
```
ä¼ ç»Ÿç›‘æ§ç—›ç‚¹ï¼š
- å¾®æœåŠ¡è°ƒç”¨é“¾è·¯å¤æ‚ï¼Œé—®é¢˜éš¾ä»¥å®šä½
- æ€§èƒ½ç“¶é¢ˆä¸æ¸…æ¥šåœ¨å“ªä¸ªç¯èŠ‚
- æœåŠ¡ä¾èµ–å…³ç³»ä¸æ˜ç¡®

åˆ†å¸ƒå¼è¿½è¸ªè§£å†³ï¼š
- å®Œæ•´é“¾è·¯å¯è§†åŒ–ï¼Œä¸€ç›®äº†ç„¶
- ç²¾ç¡®çš„æ€§èƒ½åˆ†æï¼Œå®šä½ç“¶é¢ˆ
- æ¸…æ™°çš„æœåŠ¡ä¾èµ–å›¾
```

**ğŸ”¹ æŠ€æœ¯é€‰æ‹©å»ºè®®**ï¼š
```
Micrometer Tracingï¼š
âœ… Spring Bootå®˜æ–¹æ¨èï¼Œé›†æˆç®€å•
âœ… ç»Ÿä¸€APIï¼Œä¾¿äºåˆ‡æ¢åº•å±‚å®ç°
âœ… è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜ï¼Œå¼€ç®±å³ç”¨

OpenTelemetryï¼š
âœ… è¡Œä¸šæ ‡å‡†ï¼Œå‚å•†ä¸­ç«‹
âœ… åŠŸèƒ½å…¨é¢ï¼Œç”Ÿæ€ä¸°å¯Œ  
âœ… æœªæ¥è¶‹åŠ¿ï¼Œå€¼å¾—æŠ•èµ„
```

**ğŸ”¹ ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹**ï¼š
```
æ€§èƒ½å½±å“ï¼š
- åˆç†è®¾ç½®é‡‡æ ·ç‡ï¼ˆå»ºè®®1%-10%ï¼‰
- é¿å…åœ¨çƒ­ç‚¹è·¯å¾„åˆ›å»ºè¿‡å¤šè‡ªå®šä¹‰Span
- å®šæœŸç›‘æ§è¿½è¸ªç³»ç»Ÿæœ¬èº«çš„æ€§èƒ½

æ•°æ®ç®¡ç†ï¼š
- è®¾ç½®åˆç†çš„æ•°æ®ä¿ç•™æœŸé™
- å»ºç«‹æ•°æ®æ¸…ç†æœºåˆ¶
- ç›‘æ§å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ å¼€å‘é˜¶æ®µ**ï¼š
- é‡‡æ ·ç‡è®¾ä¸º100%ï¼Œä¾¿äºè°ƒè¯•
- é›†æˆåˆ°æœ¬åœ°å¼€å‘ç¯å¢ƒçš„è¿½è¸ªç³»ç»Ÿ
- ä¸ºå…³é”®ä¸šåŠ¡é€»è¾‘æ·»åŠ è‡ªå®šä¹‰Span

**ğŸš€ æµ‹è¯•é˜¶æ®µ**ï¼š
- æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒçš„é‡‡æ ·ç‡
- éªŒè¯è¿½è¸ªæ•°æ®çš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§
- æµ‹è¯•å¼‚å¸¸æƒ…å†µä¸‹çš„è¿½è¸ªè¡¨ç°

**ğŸ“ˆ ç”Ÿäº§ç¯å¢ƒ**ï¼š
- é‡‡æ ·ç‡1%-10%ï¼ˆæ ¹æ®ç³»ç»Ÿè§„æ¨¡è°ƒæ•´ï¼‰
- å»ºç«‹è¿½è¸ªæ•°æ®çš„ç›‘æ§å’Œå‘Šè­¦
- å®šæœŸåˆ†æè¿½è¸ªæ•°æ®ï¼Œä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½

**ğŸ”§ è¿ç»´å»ºè®®**ï¼š
- å»ºç«‹è¿½è¸ªæ•°æ®çš„å¤‡ä»½ç­–ç•¥
- ç›‘æ§è¿½è¸ªç³»ç»Ÿçš„å¥åº·çŠ¶å†µ
- ä¸ºå›¢é˜Ÿæä¾›è¿½è¸ªæ•°æ®åˆ†æåŸ¹è®­

**æ ¸å¿ƒè®°å¿†**ï¼š
- åˆ†å¸ƒå¼è¿½è¸ªæ˜¯å¾®æœåŠ¡ç›‘æ§çš„çœ¼ç›
- TraceIdä¸²è”åˆ†æ•£æ“ä½œï¼ŒSpanIdæ ‡è¯†å•ä¸ªæ­¥éª¤  
- åˆç†é‡‡æ ·å¹³è¡¡æ€§èƒ½ä¸ç›‘æ§æ•ˆæœ
- æ—¥å¿—å…³è”TraceIdæ˜¯é—®é¢˜å®šä½çš„åˆ©å™¨