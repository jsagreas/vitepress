---
title: 6ã€æ—¥å¿—åˆ†ç¯å¢ƒä¸JSONæ ¼å¼
---
## ğŸ“š ç›®å½•

1. [æ—¥å¿—åˆ†ç¯å¢ƒé…ç½®æ¦‚è¿°](#1-æ—¥å¿—åˆ†ç¯å¢ƒé…ç½®æ¦‚è¿°)
2. [logback-spring.xmlæ ¸å¿ƒé…ç½®](#2-logback-spring-xmlæ ¸å¿ƒé…ç½®)
3. [åŠ¨æ€æ—¥å¿—çº§åˆ«ç®¡ç†](#3-åŠ¨æ€æ—¥å¿—çº§åˆ«ç®¡ç†)
4. [å¼‚æ­¥æ—¥å¿—é…ç½®ä¼˜åŒ–](#4-å¼‚æ­¥æ—¥å¿—é…ç½®ä¼˜åŒ–)
5. [JSONæ ¼å¼æ—¥å¿—å®æˆ˜](#5-jsonæ ¼å¼æ—¥å¿—å®æˆ˜)
6. [TraceIdé“¾è·¯è¿½è¸ªå®ç°](#6-traceidé“¾è·¯è¿½è¸ªå®ç°)
7. [ç”Ÿäº§ç¯å¢ƒæ—¥å¿—é™å™ª](#7-ç”Ÿäº§ç¯å¢ƒæ—¥å¿—é™å™ª)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“‹ æ—¥å¿—åˆ†ç¯å¢ƒé…ç½®æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ—¥å¿—åˆ†ç¯å¢ƒé…ç½®


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
æ—¥å¿—åˆ†ç¯å¢ƒé…ç½®ï¼šæ ¹æ®ä¸åŒçš„è¿è¡Œç¯å¢ƒï¼Œè®¾ç½®ä¸åŒçš„æ—¥å¿—è¾“å‡ºç­–ç•¥
```

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šå°±åƒç©¿è¡£æœä¸€æ ·ï¼Œå¤å¤©ç©¿çŸ­è¢–ï¼Œå†¬å¤©ç©¿æ£‰è¡£ã€‚ä¸åŒç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸åŒçš„æ—¥å¿—ç­–ç•¥ã€‚

**ç¯å¢ƒåˆ†ç±»ä¸ç‰¹ç‚¹**ï¼š
```
å¼€å‘ç¯å¢ƒï¼ˆdevï¼‰ï¼š        æµ‹è¯•ç¯å¢ƒï¼ˆtestï¼‰ï¼š       ç”Ÿäº§ç¯å¢ƒï¼ˆprodï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ è¯¦ç»†è°ƒè¯•ä¿¡æ¯   â”‚     â”‚ ğŸ§ª ä¸šåŠ¡åŠŸèƒ½éªŒè¯   â”‚     â”‚ âš¡ æ€§èƒ½ä¼˜å…ˆ      â”‚
â”‚ ğŸ“± æ§åˆ¶å°è¾“å‡º     â”‚     â”‚ ğŸ“ æ–‡ä»¶è®°å½•      â”‚     â”‚ ğŸ”‡ å…³é”®ä¿¡æ¯only  â”‚
â”‚ ğŸ¯ DEBUGçº§åˆ«     â”‚     â”‚ âš ï¸ INFOçº§åˆ«      â”‚     â”‚ â— WARN+ERROR   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç¯å¢ƒæ—¥å¿—


**ğŸ¯ å®é™…é—®é¢˜åœºæ™¯**
```
é—®é¢˜1ï¼šå¼€å‘æ—¶éœ€è¦çœ‹è¯¦ç»†æ—¥å¿—ï¼Œç”Ÿäº§ç¯å¢ƒä¼šå½±å“æ€§èƒ½
é—®é¢˜2ï¼šæµ‹è¯•ç¯å¢ƒéœ€è¦è®°å½•æ–‡ä»¶ï¼Œå¼€å‘ç¯å¢ƒåªè¦æ§åˆ¶å°
é—®é¢˜3ï¼šç”Ÿäº§ç¯å¢ƒæ—¥å¿—å¤ªå¤šï¼Œæ‰¾å…³é”®ä¿¡æ¯åƒå¤§æµ·æé’ˆ
```

**âœ… åˆ†ç¯å¢ƒé…ç½®çš„å¥½å¤„**
- **å¼€å‘æ•ˆç‡æå‡**ï¼šå¼€å‘æ—¶å¿«é€Ÿå®šä½é—®é¢˜
- **æµ‹è¯•è´¨é‡ä¿éšœ**ï¼šæµ‹è¯•æ—¶å®Œæ•´è®°å½•æ“ä½œ
- **ç”Ÿäº§æ€§èƒ½ä¼˜åŒ–**ï¼šç”Ÿäº§ç¯å¢ƒå‡å°‘ä¸å¿…è¦çš„æ—¥å¿—è¾“å‡º
- **è¿ç»´ç®€åŒ–**ï¼šä¸åŒç¯å¢ƒé‡‡ç”¨æœ€åˆé€‚çš„æ—¥å¿—ç­–ç•¥

---

## 2. ğŸ› ï¸ logback-spring.xmlæ ¸å¿ƒé…ç½®


### 2.1 Spring Bootæ—¥å¿—é…ç½®æ–‡ä»¶


**ğŸ“ é…ç½®æ–‡ä»¶å‘½åè§„åˆ™**
```
logback.xml          â† æ™®é€šlogbacké…ç½®
logback-spring.xml   â† Spring Bootä¸“ç”¨é…ç½®ï¼ˆæ¨èâœ…ï¼‰
```

> ğŸ’¡ **ä¸ºä»€ä¹ˆç”¨logback-spring.xmlï¼Ÿ**  
> å› ä¸ºå®ƒæ”¯æŒSpring Bootçš„`<springProfile>`æ ‡ç­¾ï¼Œå¯ä»¥æ ¹æ®ä¸åŒç¯å¢ƒåŠ è½½ä¸åŒé…ç½®ï¼

### 2.2 åŸºç¡€é…ç½®ç»“æ„


**ğŸ—ï¸ å®Œæ•´é…ç½®æ¡†æ¶**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- 1ï¸âƒ£ å¼•å…¥Spring Booté»˜è®¤é…ç½® -->
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    
    <!-- 2ï¸âƒ£ å®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼ -->
    <property name="CONSOLE_LOG_PATTERN" value="${CONSOLE_LOG_PATTERN:-%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr(${LOG_LEVEL_PATTERN:-%5p}) %clr(${PID:- }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}}"/>
    
    <!-- 3ï¸âƒ£ å¼€å‘ç¯å¢ƒé…ç½® -->
    <springProfile name="dev">
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>${CONSOLE_LOG_PATTERN}</pattern>
                <charset>UTF-8</charset>
            </encoder>
        </appender>
        <root level="DEBUG">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>
    
    <!-- 4ï¸âƒ£ ç”Ÿäº§ç¯å¢ƒé…ç½® -->
    <springProfile name="prod">
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>logs/app.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                <fileNamePattern>logs/app-%d{yyyy-MM-dd}-%i.log.gz</fileNamePattern>
                <maxFileSize>100MB</maxFileSize>
                <maxHistory>30</maxHistory>
            </rollingPolicy>
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp/>
                    <logLevel/>
                    <loggerName/>
                    <message/>
                    <mdc/>
                </providers>
            </encoder>
        </appender>
        <root level="INFO">
            <appender-ref ref="FILE"/>
        </root>
    </springProfile>
</configuration>
```

### 2.3 é…ç½®è¯¦è§£è¯´æ˜


**ğŸ” å…³é”®é…ç½®è§£é‡Š**

| é…ç½®é¡¹ | **ä½œç”¨è¯´æ˜** | **é€šä¿—ç†è§£** |
|--------|-------------|-------------|
| `<springProfile name="dev">` | æŒ‡å®šç¯å¢ƒ | ç±»ä¼¼ifæ¡ä»¶ï¼šå¦‚æœæ˜¯å¼€å‘ç¯å¢ƒå°±ç”¨è¿™ä¸ªé…ç½® |
| `ConsoleAppender` | æ§åˆ¶å°è¾“å‡º | åœ¨IDEAæˆ–å‘½ä»¤è¡Œçœ‹åˆ°çš„æ—¥å¿— |
| `RollingFileAppender` | æ»šåŠ¨æ–‡ä»¶è¾“å‡º | å†™åˆ°æ–‡ä»¶é‡Œï¼Œæ–‡ä»¶å¤ªå¤§è‡ªåŠ¨åˆ‡åˆ† |
| `<pattern>` | æ—¥å¿—æ ¼å¼ | å†³å®šæ—¥å¿—é•¿ä»€ä¹ˆæ ·å­ |
| `<maxFileSize>` | å•ä¸ªæ–‡ä»¶å¤§å°é™åˆ¶ | é˜²æ­¢æ—¥å¿—æ–‡ä»¶è¿‡å¤§ |

---

## 3. âš™ï¸ åŠ¨æ€æ—¥å¿—çº§åˆ«ç®¡ç†


### 3.1 æ—¥å¿—çº§åˆ«åŸºç¡€çŸ¥è¯†


**ğŸ“Š æ—¥å¿—çº§åˆ«å±‚æ¬¡**
```
TRACE â†’ DEBUG â†’ INFO â†’ WARN â†’ ERROR â†’ OFF
  â†‘        â†‘       â†‘      â†‘       â†‘      â†‘
æœ€è¯¦ç»†    è°ƒè¯•    å¸¸è§„   è­¦å‘Š    é”™è¯¯   å…³é—­

çº§åˆ«è§„åˆ™ï¼šè®¾ç½®INFOçº§åˆ«ï¼Œå°±åªä¼šè¾“å‡ºINFOã€WARNã€ERROR
```

> ğŸ’¡ **ç”Ÿæ´»åŒ–ç†è§£**ï¼šå°±åƒå£°éŸ³å¤§å°ï¼Œè®¾ç½®ä¸­ç­‰éŸ³é‡ï¼Œå°±å¬ä¸åˆ°å°å£°è¯´è¯ï¼Œä½†èƒ½å¬åˆ°å¤§å£°å–Šå«ã€‚

### 3.2 application.ymlä¸­çš„çº§åˆ«é…ç½®


**ğŸ“ åŸºç¡€é…ç½®æ–¹å¼**
```yaml
# å…¨å±€æ—¥å¿—çº§åˆ«
logging:
  level:
    root: INFO                    # æ‰€æœ‰åŒ…çš„é»˜è®¤çº§åˆ«
    com.mycompany: DEBUG          # è‡ªå·±å…¬å¸çš„åŒ…ç”¨DEBUGçº§åˆ«
    org.springframework: WARN    # Springæ¡†æ¶åªæ˜¾ç¤ºè­¦å‘Š
    com.baomidou.mybatisplus: DEBUG # MyBatis-Plusçš„SQLæ—¥å¿—
```

**ğŸ¯ ç¯å¢ƒåŒºåˆ†é…ç½®**
```yaml
# å¼€å‘ç¯å¢ƒé…ç½®
spring:
  profiles: dev
logging:
  level:
    root: DEBUG
    com.mycompany.service: TRACE  # æœåŠ¡å±‚çœ‹æœ€è¯¦ç»†çš„æ—¥å¿—

---
# ç”Ÿäº§ç¯å¢ƒé…ç½®  
spring:
  profiles: prod
logging:
  level:
    root: WARN                    # ç”Ÿäº§ç¯å¢ƒåªçœ‹è­¦å‘Šå’Œé”™è¯¯
    com.mycompany.controller: INFO # æ§åˆ¶å±‚ä¿ç•™INFO
```

### 3.3 åŠ¨æ€è°ƒæ•´æ—¥å¿—çº§åˆ«


**ğŸ”§ è¿è¡Œæ—¶ä¿®æ”¹çº§åˆ«**

Spring Boot Actuatoræä¾›äº†åŠ¨æ€ä¿®æ”¹åŠŸèƒ½ï¼š

```yaml
# å¯ç”¨actuatorç«¯ç‚¹
management:
  endpoints:
    web:
      exposure:
        include: loggers
  endpoint:
    loggers:
      enabled: true
```

**ğŸ“¡ HTTPæ¥å£è°ƒç”¨ç¤ºä¾‹**
```bash
# æŸ¥çœ‹å½“å‰æ—¥å¿—çº§åˆ«
GET /actuator/loggers/com.mycompany.service.UserService

# åŠ¨æ€ä¿®æ”¹æ—¥å¿—çº§åˆ«
POST /actuator/loggers/com.mycompany.service.UserService
Content-Type: application/json
{"configuredLevel": "DEBUG"}
```

> âš ï¸ **ç”Ÿäº§ç¯å¢ƒæ³¨æ„**ï¼šåŠ¨æ€ä¿®æ”¹åŠŸèƒ½å¾ˆæ–¹ä¾¿ï¼Œä½†è¦æ³¨æ„å®‰å…¨æ€§ï¼Œå»ºè®®åŠ ä¸Šè®¿é—®æ§åˆ¶ï¼

---

## 4. âš¡ å¼‚æ­¥æ—¥å¿—é…ç½®ä¼˜åŒ–


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥æ—¥å¿—


**ğŸŒ åŒæ­¥æ—¥å¿—çš„é—®é¢˜**
```
ç”¨æˆ·è¯·æ±‚ â†’ ä¸šåŠ¡é€»è¾‘ â†’ å†™æ—¥å¿—ï¼ˆç­‰å¾…ç£ç›˜IOï¼‰ â†’ è¿”å›å“åº”
                          â†‘
                      è¿™é‡Œä¼šå¡ä½ï¼
```

**ğŸš€ å¼‚æ­¥æ—¥å¿—çš„ä¼˜åŠ¿**
```
ç”¨æˆ·è¯·æ±‚ â†’ ä¸šåŠ¡é€»è¾‘ â†’ æ—¥å¿—æ”¾å…¥ç¼“å†²åŒº â†’ ç«‹å³è¿”å›å“åº”
                          â†“
                    åå°çº¿ç¨‹æ…¢æ…¢å†™ç£ç›˜
```

> ğŸ’¡ **ç”Ÿæ´»åŒ–æ¯”å–»**ï¼šåŒæ­¥æ—¥å¿—åƒç°åœºåšèœï¼Œå¼‚æ­¥æ—¥å¿—åƒæå‰å¤‡èœï¼Œç”¨çš„æ—¶å€™ç›´æ¥æ‹¿ï¼

### 4.2 AsyncAppenderé…ç½®


**âš™ï¸ å¼‚æ­¥é…ç½®ç¤ºä¾‹**
```xml
<configuration>
    <!-- åŸå§‹æ–‡ä»¶Appender -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/app.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/app-%d{yyyy-MM-dd}.log</fileNamePattern>
        </rollingPolicy>
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- å¼‚æ­¥åŒ…è£…å™¨ -->
    <appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <!-- é˜Ÿåˆ—å¤§å°ï¼šç¼“å†²åŒºèƒ½å­˜å¤šå°‘æ¡æ—¥å¿— -->
        <queueSize>1024</queueSize>
        
        <!-- é˜Ÿåˆ—æ»¡æ—¶ä¸¢å¼ƒç­–ç•¥ï¼šä¸¢å¼ƒTRACEå’ŒDEBUGçº§åˆ« -->
        <discardingThreshold>20</discardingThreshold>
        
        <!-- æ˜¯å¦é˜»å¡ï¼šfalse=ä¸é˜»å¡ï¼ˆä¸¢å¼ƒï¼‰ï¼Œtrue=é˜»å¡ç­‰å¾… -->
        <neverBlock>false</neverBlock>
        
        <!-- å¼•ç”¨åŸå§‹appender -->
        <appender-ref ref="FILE"/>
    </appender>
    
    <root level="INFO">
        <appender-ref ref="ASYNC_FILE"/>
    </root>
</configuration>
```

### 4.3 å¼‚æ­¥é…ç½®å‚æ•°è¯¦è§£


| å‚æ•° | **é»˜è®¤å€¼** | **ä½œç”¨** | **å»ºè®®è®¾ç½®** |
|------|-----------|----------|-------------|
| `queueSize` | 256 | ç¼“å†²é˜Ÿåˆ—å¤§å° | 1024-2048ï¼ˆæ ¹æ®å†…å­˜è°ƒæ•´ï¼‰ |
| `discardingThreshold` | queueSize/5 | é˜Ÿåˆ—å‰©ä½™20%æ—¶å¼€å§‹ä¸¢å¼ƒä½çº§åˆ«æ—¥å¿— | 10-20 |
| `neverBlock` | false | é˜Ÿåˆ—æ»¡æ—¶æ˜¯å¦é˜»å¡ | falseï¼ˆé«˜å¹¶å‘ï¼‰trueï¼ˆé‡è¦æ—¥å¿—ï¼‰ |

---

## 5. ğŸ“„ JSONæ ¼å¼æ—¥å¿—å®æˆ˜


### 5.1 ä¸ºä»€ä¹ˆä½¿ç”¨JSONæ ¼å¼


**ğŸ“‹ ä¼ ç»Ÿæ–‡æœ¬æ—¥å¿—çš„å±€é™**
```
2023-09-22 14:30:15.123 INFO [http-nio-8080-exec-1] c.m.controller.UserController - User login success, userId=12345, ip=192.168.1.100
```

**ğŸ” JSONæ ¼å¼çš„ä¼˜åŠ¿**
```json
{
  "timestamp": "2023-09-22T14:30:15.123+08:00",
  "level": "INFO",
  "thread": "http-nio-8080-exec-1",
  "logger": "com.mycompany.controller.UserController",
  "message": "User login success",
  "userId": "12345",
  "ip": "192.168.1.100",
  "traceId": "abc123def456"
}
```

> ğŸ’¡ **ä¸ºä»€ä¹ˆJSONæ›´å¥½ï¼Ÿ**  
> 1. **ç»“æ„åŒ–**ï¼šå­—æ®µæ¸…æ™°ï¼Œæ˜“äºè§£æ  
> 2. **å¯æœç´¢**ï¼šELKç­‰å·¥å…·å¯ä»¥æŒ‰å­—æ®µæœç´¢  
> 3. **å¯åˆ†æ**ï¼šä¾¿äºåšæ•°æ®åˆ†æå’Œç›‘æ§  

### 5.2 JSONæ—¥å¿—é…ç½®å®ç°


**ğŸ“¦ æ·»åŠ ä¾èµ–**
```xml
<dependency>
    <groupId>net.logstash.logback</groupId>
    <artifactId>logstash-logback-encoder</artifactId>
    <version>7.4</version>
</dependency>
```

**âš™ï¸ logbacké…ç½®**
```xml
<appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>logs/app.json</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
        <fileNamePattern>logs/app-%d{yyyy-MM-dd}-%i.json.gz</fileNamePattern>
        <maxFileSize>100MB</maxFileSize>
        <maxHistory>30</maxHistory>
    </rollingPolicy>
    
    <!-- JSONç¼–ç å™¨ -->
    <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
        <providers>
            <!-- æ—¶é—´æˆ³ -->
            <timestamp>
                <pattern>yyyy-MM-dd HH:mm:ss.SSS</pattern>
            </timestamp>
            
            <!-- æ—¥å¿—çº§åˆ« -->
            <logLevel/>
            
            <!-- çº¿ç¨‹å -->
            <loggerName/>
            
            <!-- æ—¥å¿—æ¶ˆæ¯ -->
            <message/>
            
            <!-- MDCä¸Šä¸‹æ–‡ -->
            <mdc/>
            
            <!-- è‡ªå®šä¹‰å­—æ®µ -->
            <pattern>
                <pattern>
                {
                  "service": "user-service",
                  "version": "1.0.0"
                }
                </pattern>
            </pattern>
        </providers>
    </encoder>
</appender>
```

### 5.3 ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨


**ğŸ”§ åœ¨Controllerä¸­è®°å½•JSONæ—¥å¿—**
```java
@RestController
public class UserController {
    private static final Logger logger = LoggerFactory.getLogger(UserController.class);
    
    @PostMapping("/login")
    public Result login(@RequestBody LoginRequest request) {
        // ä½¿ç”¨MDCæ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯
        MDC.put("userId", request.getUserId());
        MDC.put("ip", getClientIP());
        MDC.put("action", "login");
        
        try {
            // ä¸šåŠ¡é€»è¾‘
            User user = userService.login(request);
            
            // è®°å½•æˆåŠŸæ—¥å¿—
            logger.info("User login success");
            
            return Result.success(user);
        } catch (Exception e) {
            logger.error("User login failed", e);
            return Result.error("Login failed");
        } finally {
            // æ¸…ç†MDCï¼Œé¿å…å†…å­˜æ³„æ¼
            MDC.clear();
        }
    }
}
```

---

## 6. ğŸ”— TraceIdé“¾è·¯è¿½è¸ªå®ç°


### 6.1 ä»€ä¹ˆæ˜¯TraceIdé“¾è·¯è¿½è¸ª


**ğŸ¯ é“¾è·¯è¿½è¸ªè§£å†³çš„é—®é¢˜**
```
å¾®æœåŠ¡A â†’ å¾®æœåŠ¡B â†’ å¾®æœåŠ¡C â†’ æ•°æ®åº“
   â†“         â†“         â†“        â†“
 æ—¥å¿—1     æ—¥å¿—2     æ—¥å¿—3    æ—¥å¿—4

é—®é¢˜ï¼šè¿™äº›æ—¥å¿—å±äºåŒä¸€ä¸ªç”¨æˆ·è¯·æ±‚å—ï¼Ÿæ€ä¹ˆå…³è”èµ·æ¥ï¼Ÿ
```

**âœ¨ TraceIdçš„ä½œç”¨**
```
ç”¨æˆ·è¯·æ±‚ â†’ [TraceId: abc123] è´¯ç©¿æ•´ä¸ªè°ƒç”¨é“¾

å¾®æœåŠ¡A: [TraceId: abc123] æ¥æ”¶ç”¨æˆ·è¯·æ±‚
å¾®æœåŠ¡B: [TraceId: abc123] å¤„ç†è®¢å•é€»è¾‘  
å¾®æœåŠ¡C: [TraceId: abc123] æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
æ•°æ®åº“:  [TraceId: abc123] æ‰§è¡ŒSQLæŸ¥è¯¢
```

> ğŸ’¡ **ç”Ÿæ´»åŒ–ç†è§£**ï¼šå°±åƒå¿«é€’åŒ…è£¹çš„è¿å•å·ï¼Œä»å‘è´§åˆ°æ”¶è´§ï¼Œæ¯ä¸ªç¯èŠ‚éƒ½èƒ½é€šè¿‡è¿å•å·è¿½è¸ªï¼

### 6.2 TraceIdç”Ÿæˆä¸ä¼ é€’


**ğŸ”§ è‡ªå®šä¹‰TraceIdè¿‡æ»¤å™¨**
```java
@Component
public class TraceIdFilter implements Filter {
    private static final String TRACE_ID = "traceId";
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        try {
            // 1. ç”Ÿæˆæˆ–è·å–TraceId
            String traceId = generateTraceId();
            
            // 2. æ”¾å…¥MDC
            MDC.put(TRACE_ID, traceId);
            
            // 3. æ”¾å…¥HTTPå“åº”å¤´
            if (response instanceof HttpServletResponse) {
                ((HttpServletResponse) response).setHeader(TRACE_ID, traceId);
            }
            
            // 4. ç»§ç»­å¤„ç†è¯·æ±‚
            chain.doFilter(request, response);
            
        } finally {
            // 5. æ¸…ç†MDC
            MDC.remove(TRACE_ID);
        }
    }
    
    private String generateTraceId() {
        return UUID.randomUUID().toString().replace("-", "");
    }
}
```

### 6.3 å¾®æœåŠ¡é—´TraceIdä¼ é€’


**ğŸ“¡ Feignå®¢æˆ·ç«¯æ‹¦æˆªå™¨**
```java
@Component
public class TraceIdFeignInterceptor implements RequestInterceptor {
    @Override
    public void apply(RequestTemplate template) {
        // ä»å½“å‰çº¿ç¨‹MDCè·å–TraceId
        String traceId = MDC.get("traceId");
        if (StringUtils.hasText(traceId)) {
            // æ·»åŠ åˆ°HTTPè¯·æ±‚å¤´
            template.header("traceId", traceId);
        }
    }
}

@Component  
public class TraceIdWebInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, Object handler) {
        // ä»è¯·æ±‚å¤´è·å–TraceId
        String traceId = request.getHeader("traceId");
        if (StringUtils.hasText(traceId)) {
            MDC.put("traceId", traceId);
        }
        return true;
    }
}
```

### 6.4 æ—¥å¿—ä¸­æ˜¾ç¤ºTraceId


**âš™ï¸ logbacké…ç½®ä¸­æ·»åŠ TraceId**
```xml
<!-- æ§åˆ¶å°æ ¼å¼ -->
<property name="CONSOLE_PATTERN" 
          value="%d{HH:mm:ss.SSS} [%thread] [%X{traceId:-NO_TRACE}] %-5level %logger{36} - %msg%n"/>

<!-- JSONæ ¼å¼ -->
<encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
    <providers>
        <timestamp/>
        <logLevel/>
        <loggerName/>
        <message/>
        <mdc>
            <includeMdcKeyName>traceId</includeMdcKeyName>
        </mdc>
    </providers>
</encoder>
```

**ğŸ“‹ æœ€ç»ˆæ—¥å¿—æ•ˆæœ**
```
14:30:15.123 [http-nio-8080-exec-1] [abc123def456] INFO  c.m.controller.UserController - User login start
14:30:15.156 [http-nio-8080-exec-1] [abc123def456] DEBUG c.m.service.UserService - Query user from database  
14:30:15.189 [http-nio-8080-exec-1] [abc123def456] INFO  c.m.controller.UserController - User login success
```

---

## 7. ğŸ”‡ ç”Ÿäº§ç¯å¢ƒæ—¥å¿—é™å™ª


### 7.1 ä»€ä¹ˆæ˜¯æ—¥å¿—é™å™ª


**ğŸ“¢ æ—¥å¿—å™ªéŸ³çš„å…¸å‹é—®é¢˜**
```
âŒ é—®é¢˜æ—¥å¿—ï¼š
DEBUG com.alibaba.nacos - Nacos heartbeat check...  (æ¯5ç§’ä¸€æ¬¡)
DEBUG org.springframework - Bean initialization...   (å¯åŠ¨æ—¶å¤§é‡)
INFO  com.zaxxer.hikari - HikariPool connection...  (è¿æ¥æ± æ—¥å¿—)
```

**ğŸ¯ é™å™ªåçš„æ•ˆæœ**
```
âœ… æ¸…æ´æ—¥å¿—ï¼š
INFO  com.mycompany.service - User login success, userId=12345
WARN  com.mycompany.payment - Payment timeout, retry attempt 1
ERROR com.mycompany.order - Order processing failed, orderId=67890
```

> ğŸ’¡ **é™å™ªçš„ç›®æ ‡**ï¼šä¿ç•™æœ‰ä»·å€¼çš„ä¸šåŠ¡æ—¥å¿—ï¼Œè¿‡æ»¤æ‰æ¡†æ¶å’Œä¸­é—´ä»¶çš„å™ªéŸ³ï¼

### 7.2 æ¡†æ¶æ—¥å¿—è¿‡æ»¤é…ç½®


**ğŸ”§ å¸¸è§æ¡†æ¶é™å™ªé…ç½®**
```yaml
# application-prod.yml
logging:
  level:
    # Springæ¡†æ¶é™å™ª
    org.springframework: WARN
    org.springframework.web: WARN  
    org.springframework.security: WARN
    
    # æ•°æ®åº“ç›¸å…³é™å™ª
    com.zaxxer.hikari: WARN           # è¿æ¥æ± 
    org.mybatis: WARN                 # MyBatis
    com.baomidou.mybatisplus: WARN    # MyBatis-Plus
    
    # æ³¨å†Œä¸­å¿ƒé™å™ª  
    com.alibaba.nacos: WARN
    com.netflix.eureka: WARN
    
    # HTTPå®¢æˆ·ç«¯é™å™ª
    org.apache.http: WARN
    feign: WARN
    
    # ä¿ç•™ä¸šåŠ¡æ—¥å¿—è¯¦ç»†çº§åˆ«
    com.mycompany: INFO               # è‡ªå·±çš„ä¸šåŠ¡ä»£ç 
```

### 7.3 åŸºäºFilterçš„æ™ºèƒ½è¿‡æ»¤


**ğŸ¯ è‡ªå®šä¹‰æ—¥å¿—è¿‡æ»¤å™¨**
```xml
<configuration>
    <!-- å®šä¹‰è¿‡æ»¤å™¨ -->
    <filter class="ch.qos.logback.core.filter.EvaluatorFilter">
        <evaluator class="ch.qos.logback.classic.boolex.GEventEvaluator">
            <expression>
                <!-- è¿‡æ»¤æ‰å¿ƒè·³æ£€æŸ¥æ—¥å¿— -->
                return message.contains("heartbeat") ||
                       message.contains("health check") ||
                       /* è¿‡æ»¤è¿æ¥æ± ä¿¡æ¯ */
                       (logger.contains("hikari") &amp;&amp; level.toInt() &lt; WARN.toInt()) ||
                       /* è¿‡æ»¤Nacosæ³¨å†Œä¿¡æ¯ */  
                       (logger.contains("nacos") &amp;&amp; message.contains("register"))
            </expression>
        </evaluator>
        <OnMismatch>ACCEPT</OnMismatch>
        <OnMatch>DENY</OnMatch>
    </filter>
    
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <!-- åº”ç”¨è¿‡æ»¤å™¨ -->
        <filter-ref ref="NOISE_FILTER"/>
        <!-- ... å…¶ä»–é…ç½® ... -->
    </appender>
</configuration>
```

### 7.4 ä¸šåŠ¡æ—¥å¿—åˆ†çº§ç­–ç•¥


**ğŸ“Š æ—¥å¿—åˆ†çº§å»ºè®®**

| çº§åˆ« | **ä½¿ç”¨åœºæ™¯** | **ç¤ºä¾‹** | **ç”Ÿäº§ç¯å¢ƒå»ºè®®** |
|------|-------------|----------|------------------|
| **ERROR** | ç³»ç»Ÿé”™è¯¯ã€ä¸šåŠ¡å¼‚å¸¸ | æ”¯ä»˜å¤±è´¥ã€è®¢å•å¼‚å¸¸ | âœ… å¿…é¡»è®°å½• |
| **WARN** | è­¦å‘Šä¿¡æ¯ã€é™çº§å¤„ç† | ç¼“å­˜å¤±æ•ˆã€ç†”æ–­è§¦å‘ | âœ… å¿…é¡»è®°å½• |
| **INFO** | å…³é”®ä¸šåŠ¡èŠ‚ç‚¹ | ç”¨æˆ·ç™»å½•ã€è®¢å•åˆ›å»º | âœ… é€‰æ‹©æ€§è®°å½• |
| **DEBUG** | è¯¦ç»†è°ƒè¯•ä¿¡æ¯ | SQLå‚æ•°ã€æ–¹æ³•è°ƒç”¨ | âŒ ç”Ÿäº§ç¯å¢ƒå…³é—­ |

**ğŸ’¼ ä¸šåŠ¡ä»£ç ç¤ºä¾‹**
```java
@Service
public class OrderService {
    private static final Logger logger = LoggerFactory.getLogger(OrderService.class);
    
    public Order createOrder(CreateOrderRequest request) {
        // INFO: è®°å½•å…³é”®ä¸šåŠ¡æ“ä½œ
        logger.info("Creating order for user: {}, amount: {}", 
                   request.getUserId(), request.getAmount());
        
        try {
            // ä¸šåŠ¡é€»è¾‘
            Order order = doCreateOrder(request);
            
            // INFO: è®°å½•æˆåŠŸç»“æœ  
            logger.info("Order created successfully, orderId: {}", order.getId());
            return order;
            
        } catch (InsufficientBalanceException e) {
            // WARN: ä¸šåŠ¡å¼‚å¸¸ä½†ç³»ç»Ÿæ­£å¸¸
            logger.warn("Insufficient balance for user: {}, required: {}, available: {}", 
                       request.getUserId(), request.getAmount(), e.getAvailableBalance());
            throw e;
            
        } catch (Exception e) {
            // ERROR: ç³»ç»Ÿå¼‚å¸¸  
            logger.error("Failed to create order for user: " + request.getUserId(), e);
            throw e;
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ—¥å¿—åˆ†ç¯å¢ƒï¼šä¸åŒç¯å¢ƒç”¨ä¸åŒçš„æ—¥å¿—ç­–ç•¥ï¼Œå¼€å‘è¯¦ç»†ã€ç”Ÿäº§ç²¾ç®€
ğŸ”¸ logback-spring.xmlï¼šSpring Bootä¸“ç”¨é…ç½®ï¼Œæ”¯æŒç¯å¢ƒåŒºåˆ†
ğŸ”¸ åŠ¨æ€æ—¥å¿—çº§åˆ«ï¼šè¿è¡Œæ—¶å¯è°ƒæ•´ï¼Œä¾¿äºçº¿ä¸Šé—®é¢˜æ’æŸ¥  
ğŸ”¸ å¼‚æ­¥æ—¥å¿—ï¼šæé«˜æ€§èƒ½ï¼Œé¿å…æ—¥å¿—IOé˜»å¡ä¸šåŠ¡
ğŸ”¸ JSONæ ¼å¼ï¼šç»“æ„åŒ–æ—¥å¿—ï¼Œä¾¿äºåˆ†æå’Œæœç´¢
ğŸ”¸ TraceIdé“¾è·¯è¿½è¸ªï¼šä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªIDï¼Œè´¯ç©¿æ•´ä¸ªè°ƒç”¨é“¾
ğŸ”¸ æ—¥å¿—é™å™ªï¼šè¿‡æ»¤æ¡†æ¶å™ªéŸ³ï¼Œçªå‡ºä¸šåŠ¡é‡ç‚¹
```

### 8.2 å…³é”®é…ç½®è®°å¿†è¦ç‚¹


**ğŸ”¹ ç¯å¢ƒé…ç½®æ¨¡æ¿**
```xml
<!-- å¼€å‘ç¯å¢ƒï¼šè¯¦ç»†+æ§åˆ¶å° -->
<springProfile name="dev">
    <root level="DEBUG">
        <appender-ref ref="CONSOLE"/>
    </root>  
</springProfile>

<!-- ç”Ÿäº§ç¯å¢ƒï¼šç²¾ç®€+æ–‡ä»¶+JSON -->
<springProfile name="prod">
    <root level="WARN">
        <appender-ref ref="ASYNC_JSON_FILE"/>
    </root>
</springProfile>
```

**ğŸ”¹ TraceIdä¸‰æ­¥èµ°**
```java
// 1. è¿‡æ»¤å™¨ç”ŸæˆTraceId
MDC.put("traceId", generateTraceId());

// 2. å¾®æœåŠ¡ä¼ é€’TraceId  
template.header("traceId", MDC.get("traceId"));

// 3. æ—¥å¿—æ˜¾ç¤ºTraceId
[%X{traceId:-NO_TRACE}]
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


- **ğŸš€ æå‡å¼€å‘æ•ˆç‡**ï¼šå¼€å‘æ—¶å¿«é€Ÿå®šä½é—®é¢˜
- **ğŸ“Š æ”¹å–„è¿ç»´ä½“éªŒ**ï¼šç”Ÿäº§ç¯å¢ƒæ—¥å¿—æ¸…æ™°æœ‰åº
- **ğŸ” å¢å¼ºé—®é¢˜æ’æŸ¥**ï¼šTraceIdè®©åˆ†å¸ƒå¼è°ƒç”¨é“¾æ¸…æ™°å¯è§
- **âš¡ ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½**ï¼šå¼‚æ­¥æ—¥å¿—å‡å°‘IOé˜»å¡
- **ğŸ“ˆ æ”¯æŒæ•°æ®åˆ†æ**ï¼šJSONæ ¼å¼ä¾¿äºæ—¥å¿—åˆ†æç³»ç»Ÿæ¥å…¥

### 8.4 æœ€ä½³å®è·µå»ºè®®


> ğŸ’¡ **å¼€å‘é˜¶æ®µ**ï¼šDEBUGçº§åˆ« + æ§åˆ¶å°è¾“å‡º + è¯¦ç»†ä¿¡æ¯
> 
> ğŸ§ª **æµ‹è¯•é˜¶æ®µ**ï¼šINFOçº§åˆ« + æ–‡ä»¶è¾“å‡º + ä¸šåŠ¡éªŒè¯  
>
> âš¡ **ç”Ÿäº§é˜¶æ®µ**ï¼šWARNçº§åˆ« + å¼‚æ­¥æ–‡ä»¶ + JSONæ ¼å¼ + é™å™ªå¤„ç†

**ğŸ”‘ æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- åˆ†ç¯å¢ƒé…ç½®å„ä¸åŒï¼Œå¼€å‘è¯¦ç»†ç”Ÿäº§ç²¾
- å¼‚æ­¥æ—¥å¿—ææ€§èƒ½ï¼ŒJSONç»“æ„ä¾¿åˆ†æ  
- TraceIdè¿½è¸ªè°ƒç”¨é“¾ï¼Œé™å™ªå¤„ç†çªé‡ç‚¹
- ä¸šåŠ¡æ—¥å¿—è¦æ¸…æ™°ï¼Œæ¡†æ¶å™ªéŸ³éœ€è¿‡æ»¤