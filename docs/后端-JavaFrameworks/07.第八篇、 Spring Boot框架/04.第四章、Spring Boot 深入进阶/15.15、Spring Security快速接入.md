---
title: 15ã€Spring Securityå¿«é€Ÿæ¥å…¥
---
## ğŸ“š ç›®å½•

1. [Spring Securityæ¦‚è¿°](#1-Spring-Securityæ¦‚è¿°)
2. [å¿«é€Ÿå¼€å§‹é…ç½®](#2-å¿«é€Ÿå¼€å§‹é…ç½®)
3. [å®‰å…¨è¿‡æ»¤å™¨é“¾é…ç½®](#3-å®‰å…¨è¿‡æ»¤å™¨é“¾é…ç½®)
4. [è®¤è¯ä¸æˆæƒæœºåˆ¶](#4-è®¤è¯ä¸æˆæƒæœºåˆ¶)
5. [å¸¸è§è·¯å¾„æ”¾è¡Œç­–ç•¥](#5-å¸¸è§è·¯å¾„æ”¾è¡Œç­–ç•¥)
6. [å¯†ç ç¼–ç å™¨é…ç½®](#6-å¯†ç ç¼–ç å™¨é…ç½®)
7. [JWTä»¤ç‰Œé›†æˆ](#7-JWTä»¤ç‰Œé›†æˆ)
8. [CSRFé˜²æŠ¤é…ç½®](#8-CSRFé˜²æŠ¤é…ç½®)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ Spring Securityæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Spring Security


**ç®€å•ç†è§£**ï¼šSpring Securityå°±åƒæ˜¯ç»™ä½ çš„æˆ¿å­å®‰è£…äº†ä¸€å¥—æ™ºèƒ½å®‰é˜²ç³»ç»Ÿ

```
ç°å®ç”Ÿæ´»ä¸­çš„å®‰é˜²ç³»ç»Ÿï¼š           Spring Securityï¼š
é—¨ç¦å¡ â†’ éªŒè¯èº«ä»½               â†’ è®¤è¯(Authentication)
æˆ¿é—´æƒé™ â†’ æ§åˆ¶è®¿é—®             â†’ æˆæƒ(Authorization)  
å®‰å…¨æ‘„åƒå¤´ â†’ ç›‘æ§è¡Œä¸º           â†’ å®‰å…¨å®¡è®¡
é˜²ç›—æŠ¥è­¦ â†’ å¼‚å¸¸å¤„ç†             â†’ å®‰å…¨å¼‚å¸¸å¤„ç†
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ” **èº«ä»½è®¤è¯**ï¼šç¡®è®¤"ä½ æ˜¯è°"ï¼ˆç™»å½•éªŒè¯ï¼‰
- ğŸ¯ **æƒé™æ§åˆ¶**ï¼šå†³å®š"ä½ èƒ½åšä»€ä¹ˆ"ï¼ˆè®¿é—®æ§åˆ¶ï¼‰
- ğŸ›¡ï¸ **å®‰å…¨é˜²æŠ¤**ï¼šé˜²æ­¢å„ç§ç½‘ç»œæ”»å‡»
- ğŸ“Š **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•å®‰å…¨ç›¸å…³æ“ä½œ

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Spring Security


> ğŸ’¡ **æ–°æ‰‹ç†è§£**
> 
> æƒ³è±¡ä½ å¼€äº†ä¸€å®¶å’–å•¡åº—ï¼Œæ²¡æœ‰å®‰ä¿æªæ–½ä¼šæ€æ ·ï¼Ÿ
> - ä»»ä½•äººéƒ½èƒ½è¿›å…¥æ“ä½œåŒº
> - æ”¶é“¶å°æ²¡äººçœ‹ç®¡
> - é¡¾å®¢ä¿¡æ¯éšæ„æŸ¥çœ‹
> - è¿™æ ·çš„åº—é“ºèƒ½æ­£å¸¸ç»è¥å—ï¼Ÿ

**Webåº”ç”¨çš„å®‰å…¨å¨èƒ**ï¼š

| å¨èƒç±»å‹ | å…·ä½“è¡¨ç° | Spring Securityå¦‚ä½•é˜²æŠ¤ |
|---------|----------|------------------------|
| ğŸš« **æœªæˆæƒè®¿é—®** | ç›´æ¥è®¿é—®ç®¡ç†é¡µé¢ | ç™»å½•è®¤è¯ + æƒé™æ§åˆ¶ |
| ğŸ”“ **å¯†ç æ³„éœ²** | æ˜æ–‡å­˜å‚¨å¯†ç  | å¯†ç åŠ å¯†å­˜å‚¨ |
| ğŸ•·ï¸ **CSRFæ”»å‡»** | ä¼ªé€ ç”¨æˆ·è¯·æ±‚ | CSRF TokenéªŒè¯ |
| ğŸ’‰ **SQLæ³¨å…¥** | æ¶æ„SQLä»£ç  | å‚æ•°åŒ–æŸ¥è¯¢ä¿æŠ¤ |
| ğŸ”’ **ä¼šè¯åŠ«æŒ** | ç›—ç”¨ç”¨æˆ·ä¼šè¯ | å®‰å…¨ä¼šè¯ç®¡ç† |

### 1.3 Spring Securityæ ¸å¿ƒæ¦‚å¿µ


**ğŸ”‘ è®¤è¯(Authentication)**
```
è®¤è¯è¿‡ç¨‹å°±åƒéªŒè¯èº«ä»½è¯ï¼š
ç”¨æˆ·æäº¤ï¼šç”¨æˆ·å + å¯†ç 
ç³»ç»ŸéªŒè¯ï¼šæ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ­£ç¡®
ç»“æœè¾“å‡ºï¼šè®¤è¯æˆåŠŸ æˆ– è®¤è¯å¤±è´¥

å®é™…åº”ç”¨ï¼š
ç™»å½•è¡¨å• â†’ ç”¨æˆ·è¾“å…¥è´¦å¯† â†’ ç³»ç»ŸéªŒè¯ â†’ ç”Ÿæˆè®¤è¯ä»¤ç‰Œ
```

**ğŸ¯ æˆæƒ(Authorization)**
```
æˆæƒè¿‡ç¨‹å°±åƒæ£€æŸ¥é—¨ç¦å¡æƒé™ï¼š
ç”¨æˆ·è¯·æ±‚ï¼šè®¿é—®æŸä¸ªèµ„æº
ç³»ç»Ÿæ£€æŸ¥ï¼šè¯¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™
ç»“æœè¾“å‡ºï¼šå…è®¸è®¿é—® æˆ– æ‹’ç»è®¿é—®

å®é™…åº”ç”¨ï¼š
è®¿é—®ç®¡ç†é¡µé¢ â†’ æ£€æŸ¥ç”¨æˆ·è§’è‰² â†’ ç®¡ç†å‘˜å¯è®¿é—®ï¼Œæ™®é€šç”¨æˆ·è¢«æ‹’ç»
```

---

## 2. ğŸš€ å¿«é€Ÿå¼€å§‹é…ç½®


### 2.1 æ·»åŠ Spring Securityä¾èµ–


**ç¬¬ä¸€æ­¥ï¼šåœ¨pom.xmlä¸­æ·»åŠ ä¾èµ–**

```xml
<dependencies>
    <!-- Spring Boot Starter Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- Spring Securityæ ¸å¿ƒä¾èµ– -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
    
    <!-- å¦‚æœéœ€è¦JWTæ”¯æŒ -->
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt</artifactId>
        <version>0.9.1</version>
    </dependency>
</dependencies>
```

> âš ï¸ **æ–°æ‰‹æ³¨æ„**
> 
> åªè¦æ·»åŠ äº†`spring-boot-starter-security`ä¾èµ–ï¼ŒSpring Securityå°±ä¼š**è‡ªåŠ¨å¯ç”¨**ï¼
> è¿™æ„å‘³ç€ä½ çš„æ‰€æœ‰æ¥å£éƒ½éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®äº†ã€‚

### 2.2 é»˜è®¤è¡Œä¸ºä½“éªŒ


æ·»åŠ ä¾èµ–åå¯åŠ¨é¡¹ç›®ï¼Œä½ ä¼šå‘ç°ï¼š

**ğŸ” è‡ªåŠ¨ç”Ÿæˆçš„å®‰å…¨é…ç½®**ï¼š
- é»˜è®¤ç”¨æˆ·åï¼š`user`
- é»˜è®¤å¯†ç ï¼šå¯åŠ¨æ—¶æ§åˆ¶å°ä¼šæ˜¾ç¤ºï¼ˆç±»ä¼¼ï¼š`Using generated security password: a1b2c3d4-e5f6-7890-...`ï¼‰
- æ‰€æœ‰æ¥å£éƒ½éœ€è¦ç™»å½•
- è‡ªåŠ¨ç”Ÿæˆç™»å½•é¡µé¢ï¼š`/login`

**ğŸ“‹ ä½“éªŒæ­¥éª¤**ï¼š
1. **å¯åŠ¨é¡¹ç›®**ï¼š`mvn spring-boot:run`
2. **æŸ¥çœ‹æ§åˆ¶å°**ï¼šæ‰¾åˆ°è‡ªåŠ¨ç”Ÿæˆçš„å¯†ç 
3. **è®¿é—®æ¥å£**ï¼šæµè§ˆå™¨æ‰“å¼€ `http://localhost:8080/hello`
4. **è‡ªåŠ¨è·³è½¬**ï¼šè·³è½¬åˆ°ç™»å½•é¡µé¢ `/login`
5. **ç™»å½•éªŒè¯**ï¼šç”¨æˆ·å`user`ï¼Œå¯†ç ä½¿ç”¨æ§åˆ¶å°æ˜¾ç¤ºçš„

```
å¯åŠ¨æ—¥å¿—ç¤ºä¾‹ï¼š
2025-09-22 16:30:15.123  INFO 12345 --- [main] o.s.s.core.userdetails.User     : 
Using generated security password: f8e7d6c5-b4a3-9281-a0b1-234567890abc
```

### 2.3 ç¬¬ä¸€ä¸ªå®‰å…¨æ§åˆ¶å™¨


```java
@RestController
public class HelloController {
    
    // è¿™ä¸ªæ¥å£ç°åœ¨éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®
    @GetMapping("/hello")
    public String hello() {
        return "Hello, Spring Security!";
    }
    
    // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
    @GetMapping("/user")
    public String currentUser(Authentication authentication) {
        return "å½“å‰ç”¨æˆ·ï¼š" + authentication.getName();
    }
}
```

---

## 3. âš™ï¸ å®‰å…¨è¿‡æ»¤å™¨é“¾é…ç½®


### 3.1 è¿‡æ»¤å™¨é“¾å·¥ä½œåŸç†


**ğŸ”„ è¯·æ±‚å¤„ç†æµç¨‹**ï¼š

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
SecurityFilterChain (å®‰å…¨è¿‡æ»¤å™¨é“¾)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. SecurityContextFilter        â”‚ â† å»ºç«‹å®‰å…¨ä¸Šä¸‹æ–‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. LogoutFilter                 â”‚ â† å¤„ç†ç™»å‡ºè¯·æ±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ 3. UsernamePasswordAuthFilter   â”‚ â† å¤„ç†è¡¨å•ç™»å½•
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. BasicAuthenticationFilter    â”‚ â† å¤„ç†Basicè®¤è¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. AuthorizationFilter          â”‚ â† æƒé™æ£€æŸ¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç›®æ ‡æ§åˆ¶å™¨æ–¹æ³•
```

> ğŸ’¡ **å½¢è±¡ç†è§£**
> 
> è¿‡æ»¤å™¨é“¾å°±åƒæœºåœºå®‰æ£€æµç¨‹ï¼š
> - **ç¬¬1å…³**ï¼šæ£€æŸ¥èº«ä»½è¯ï¼ˆèº«ä»½è®¤è¯ï¼‰
> - **ç¬¬2å…³**ï¼šå®‰æ£€ä»ªå™¨ï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰
> - **ç¬¬3å…³**ï¼šç™»æœºç‰ŒéªŒè¯ï¼ˆæƒé™ç¡®è®¤ï¼‰
> - **é€šè¿‡æ‰€æœ‰å…³å¡**ï¼šæ‰èƒ½ç™»æœºï¼ˆè®¿é—®èµ„æºï¼‰

### 3.2 è‡ªå®šä¹‰å®‰å…¨é…ç½®


**åˆ›å»ºå®‰å…¨é…ç½®ç±»**ï¼š

```java
@Configuration
@EnableWebSecurity  // å¯ç”¨Webå®‰å…¨é…ç½®
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // é…ç½®è¯·æ±‚æˆæƒ
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**").permitAll()        // å…¬å¼€è·¯å¾„
                .requestMatchers("/admin/**").hasRole("ADMIN")     // ç®¡ç†å‘˜è·¯å¾„
                .anyRequest().authenticated()                      // å…¶ä»–éœ€è¦è®¤è¯
            )
            // é…ç½®è¡¨å•ç™»å½•
            .formLogin(form -> form
                .loginPage("/login")                    // è‡ªå®šä¹‰ç™»å½•é¡µ
                .defaultSuccessUrl("/dashboard")        // ç™»å½•æˆåŠŸè·³è½¬
                .permitAll()                           // ç™»å½•é¡µå…è®¸æ‰€æœ‰äººè®¿é—®
            )
            // é…ç½®ç™»å‡º
            .logout(logout -> logout
                .logoutUrl("/logout")                  // ç™»å‡ºURL
                .logoutSuccessUrl("/login?logout")     // ç™»å‡ºåè·³è½¬
                .permitAll()
            );
            
        return http.build();
    }
}
```

**âš™ï¸ é…ç½®é€‰é¡¹è¯¦è§£**ï¼š

| é…ç½®æ–¹æ³• | ä½œç”¨è¯´æ˜ | æ–°æ‰‹ç†è§£ |
|---------|----------|----------|
| `permitAll()` | å…è®¸æ‰€æœ‰äººè®¿é—® | ğŸŸ¢ ç»¿è‰²é€šé“ï¼Œæ— éœ€éªŒè¯ |
| `authenticated()` | éœ€è¦ç™»å½•è®¤è¯ | ğŸ” éœ€è¦å‡ºç¤º"é—¨ç¥¨" |
| `hasRole("ADMIN")` | éœ€è¦ç‰¹å®šè§’è‰² | ğŸ‘‘ éœ€è¦"VIPä¼šå‘˜å¡" |
| `hasAuthority("READ")` | éœ€è¦ç‰¹å®šæƒé™ | ğŸ« éœ€è¦ç‰¹å®š"é€šè¡Œè¯" |

### 3.3 è·¯å¾„åŒ¹é…è§„åˆ™


**ğŸ¯ è·¯å¾„åŒ¹é…æ¨¡å¼**ï¼š

```java
// ç²¾ç¡®åŒ¹é…
.requestMatchers("/admin/users").hasRole("ADMIN")

// é€šé…ç¬¦åŒ¹é…  
.requestMatchers("/public/**").permitAll()     // åŒ¹é… /public/ä¸‹æ‰€æœ‰è·¯å¾„
.requestMatchers("/api/*/info").permitAll()    // åŒ¹é… /api/ä»»æ„/info

// å¤šè·¯å¾„åŒ¹é…
.requestMatchers("/login", "/register", "/forgot").permitAll()

// HTTPæ–¹æ³•é™åˆ¶
.requestMatchers(HttpMethod.GET, "/api/users").hasAuthority("READ")
.requestMatchers(HttpMethod.POST, "/api/users").hasAuthority("WRITE")
```

**ğŸ“ åŒ¹é…ä¼˜å…ˆçº§**ï¼š
```
ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
1. ç²¾ç¡®è·¯å¾„åŒ¹é…     /admin/users
2. è·¯å¾„æ¨¡å¼åŒ¹é…     /admin/**  
3. é€šç”¨åŒ¹é…        /**
```

---

## 4. ğŸ” è®¤è¯ä¸æˆæƒæœºåˆ¶


### 4.1 è®¤è¯æœºåˆ¶è¯¦è§£


**ğŸ” ä»€ä¹ˆæ˜¯è®¤è¯**ï¼š
è®¤è¯å°±æ˜¯éªŒè¯"ä½ æ˜¯è°"çš„è¿‡ç¨‹ï¼Œç±»ä¼¼äºï¼š
- é“¶è¡ŒATMï¼šæ’å¡ + è¾“å…¥å¯†ç 
- æ‰‹æœºè§£é”ï¼šæŒ‡çº¹ + é¢éƒ¨è¯†åˆ«
- ç½‘ç«™ç™»å½•ï¼šç”¨æˆ·å + å¯†ç 

**ğŸ”„ è®¤è¯æµç¨‹**ï¼š

```
ç”¨æˆ·ç™»å½•è¯·æ±‚
    â†“
AuthenticationManager (è®¤è¯ç®¡ç†å™¨)
    â†“
AuthenticationProvider (è®¤è¯æä¾›è€…)
    â†“
UserDetailsService (ç”¨æˆ·è¯¦æƒ…æœåŠ¡)
    â†“
æ•°æ®åº“/å†…å­˜ (ç”¨æˆ·å­˜å‚¨)
    â†“
è¿”å›UserDetails (ç”¨æˆ·è¯¦æƒ…)
    â†“
ç”ŸæˆAuthentication (è®¤è¯ç»“æœ)
    â†“
å­˜å…¥SecurityContext (å®‰å…¨ä¸Šä¸‹æ–‡)
```

**å®ç°è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯**ï¼š

```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        // 1. ä»æ•°æ®åº“æŸ¥æ‰¾ç”¨æˆ·
        User user = userRepository.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + username);
        }
        
        // 2. æ„å»ºSpring Securityçš„UserDetailså¯¹è±¡
        return org.springframework.security.core.userdetails.User.builder()
                .username(user.getUsername())                    // ç”¨æˆ·å
                .password(user.getPassword())                    // å¯†ç (å·²åŠ å¯†)
                .authorities(getAuthorities(user.getRoles()))    // æƒé™åˆ—è¡¨
                .accountNonExpired(true)                         // è´¦æˆ·æœªè¿‡æœŸ
                .accountNonLocked(true)                          // è´¦æˆ·æœªé”å®š  
                .credentialsNonExpired(true)                     // å¯†ç æœªè¿‡æœŸ
                .enabled(user.isEnabled())                       // è´¦æˆ·å¯ç”¨çŠ¶æ€
                .build();
    }
    
    // è½¬æ¢è§’è‰²ä¸ºæƒé™
    private Collection<? extends GrantedAuthority> getAuthorities(Set<Role> roles) {
        return roles.stream()
                .map(role -> new SimpleGrantedAuthority("ROLE_" + role.getName()))
                .collect(Collectors.toList());
    }
}
```

### 4.2 æˆæƒæœºåˆ¶è¯¦è§£


**ğŸ¯ ä»€ä¹ˆæ˜¯æˆæƒ**ï¼š
æˆæƒå°±æ˜¯å†³å®š"ä½ èƒ½åšä»€ä¹ˆ"çš„è¿‡ç¨‹ï¼Œç±»ä¼¼äºï¼š
- é“¶è¡Œå¡ï¼šæ™®é€šå¡åªèƒ½å–æ¬¾ï¼ŒVIPå¡å¯ä»¥äº«å—è´µå®¾æœåŠ¡
- å‘˜å·¥å¡ï¼šå‰å°å‘˜å·¥è¿›ä¸äº†æœºæˆ¿ï¼ŒæŠ€æœ¯å‘˜å·¥å¯ä»¥
- ä¼šå‘˜å¡ï¼šé’é“œä¼šå‘˜å’Œé’»çŸ³ä¼šå‘˜äº«å—ä¸åŒæœåŠ¡

**ğŸ“Š æƒé™ç±»å‹å¯¹æ¯”**ï¼š

| æƒé™ç±»å‹ | ç‰¹ç‚¹ | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|---------|------|----------|------|
| **åŸºäºè§’è‰² (RBAC)** | ç²—ç²’åº¦ï¼Œæ˜“ç®¡ç† | ç®€å•æƒé™æ§åˆ¶ | `ADMIN`, `USER`, `GUEST` |
| **åŸºäºæƒé™** | ç»†ç²’åº¦ï¼Œçµæ´» | å¤æ‚ä¸šåŠ¡åœºæ™¯ | `READ_USER`, `WRITE_ORDER` |
| **åŸºäºè¡¨è¾¾å¼** | åŠ¨æ€åˆ¤æ–­ï¼Œå¼ºå¤§ | å¤æ‚ä¸šåŠ¡è§„åˆ™ | `@PreAuthorize("hasRole('ADMIN') and #id == authentication.name")` |

**ğŸ› ï¸ æ–¹æ³•çº§åˆ«æˆæƒ**ï¼š

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    // éœ€è¦ADMINè§’è‰²
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/all")
    public List<User> getAllUsers() {
        return userService.findAll();
    }
    
    // éœ€è¦READ_USERæƒé™
    @PreAuthorize("hasAuthority('READ:user')")
    @GetMapping("/{id}")
    public User getUser(@PathVariable Long id) {
        return userService.findById(id);
    }
    
    // ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„ä¿¡æ¯
    @PreAuthorize("#id == authentication.name or hasRole('ADMIN')")
    @GetMapping("/{id}/profile")
    public UserProfile getProfile(@PathVariable String id) {
        return userService.getProfile(id);
    }
    
    // å¤šæ¡ä»¶ç»„åˆ
    @PreAuthorize("hasRole('USER') and #request.userId == authentication.name")
    @PostMapping("/update")
    public String updateUser(@RequestBody UpdateUserRequest request) {
        return userService.update(request);
    }
}
```

**ğŸª æƒé™è¡¨è¾¾å¼è¯­æ³•**ï¼š

```java
// åŸºæœ¬æƒé™æ£€æŸ¥
hasRole('ADMIN')                    // æ£€æŸ¥æ˜¯å¦æœ‰ADMINè§’è‰²
hasAuthority('read:user')           // æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹å®šæƒé™
hasAnyRole('ADMIN', 'MANAGER')      // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä¸€è§’è‰²
hasAnyAuthority('read', 'write')    // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä¸€æƒé™

// ç»„åˆè¡¨è¾¾å¼
hasRole('ADMIN') and hasAuthority('write')     // ANDå…³ç³»
hasRole('ADMIN') or hasRole('MANAGER')         // ORå…³ç³»
!hasRole('GUEST')                              // NOTå…³ç³»

// åŠ¨æ€å‚æ•°
#id == authentication.name          // å‚æ•°ç­‰äºå½“å‰ç”¨æˆ·
#user.owner == authentication.name  // å¯¹è±¡å±æ€§ç­‰äºå½“å‰ç”¨æˆ·

// æ–¹æ³•è°ƒç”¨
@customSecurityService.canAccess(authentication, #resource)  // è°ƒç”¨è‡ªå®šä¹‰æœåŠ¡
```

---

## 5. ğŸ›£ï¸ å¸¸è§è·¯å¾„æ”¾è¡Œç­–ç•¥


### 5.1 é™æ€èµ„æºæ”¾è¡Œ


**â“ ä¸ºä»€ä¹ˆè¦æ”¾è¡Œé™æ€èµ„æº**ï¼š
æƒ³è±¡ä¸€ä¸ªè´­ç‰©ç½‘ç«™ï¼Œå¦‚æœè¿å•†å“å›¾ç‰‡ã€CSSæ ·å¼éƒ½éœ€è¦ç™»å½•æ‰èƒ½çœ‹åˆ°ï¼Œç”¨æˆ·è¿˜æ²¡ç™»å½•å°±çœ‹åˆ°ä¸€ä¸ª"ä¸‘é™‹"çš„é¡µé¢ï¼Œè¿™æ ·åˆç†å—ï¼Ÿ

**ğŸ“ å¸¸è§é™æ€èµ„æºè·¯å¾„**ï¼š

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.authorizeHttpRequests(auth -> auth
                // é™æ€èµ„æºæ”¾è¡Œ - æ— éœ€ç™»å½•å³å¯è®¿é—®
                .requestMatchers("/css/**", "/js/**", "/images/**").permitAll()
                .requestMatchers("/webjars/**").permitAll()              // WebJarsèµ„æº
                .requestMatchers("/favicon.ico").permitAll()             // ç½‘ç«™å›¾æ ‡
                .requestMatchers("/error").permitAll()                   // é”™è¯¯é¡µé¢
                
                // Spring Boot Actuatorç›‘æ§ç«¯ç‚¹
                .requestMatchers("/actuator/health").permitAll()         // å¥åº·æ£€æŸ¥
                .requestMatchers("/actuator/**").hasRole("ADMIN")        // å…¶ä»–ç›‘æ§ä¿¡æ¯
                
                // APIæ–‡æ¡£ç›¸å…³ (å¼€å‘ç¯å¢ƒ)
                .requestMatchers("/swagger-ui/**").permitAll()           // Swagger UI
                .requestMatchers("/v3/api-docs/**").permitAll()          // APIæ–‡æ¡£
                
                // å…¶ä»–è¯·æ±‚éœ€è¦è®¤è¯
                .anyRequest().authenticated()
        );
        
        return http.build();
    }
}
```

### 5.2 å…¬å¼€APIæ”¾è¡Œ


**ğŸŒ å…¬å¼€APIè®¾è®¡åŸåˆ™**ï¼š

```java
// ç”¨æˆ·æ³¨å†Œå’Œç™»å½• - å¿…é¡»å…¬å¼€
.requestMatchers("/api/auth/**").permitAll()

// å…¬å¼€ä¿¡æ¯æŸ¥è¯¢ - æ— æ•æ„Ÿæ•°æ®
.requestMatchers("/api/public/**").permitAll()  

// æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½ - æ ¹æ®ä¸šåŠ¡å†³å®š
.requestMatchers(HttpMethod.GET, "/api/files/download/**").permitAll()

// ç¬¬ä¸‰æ–¹å›è°ƒ - webhookç­‰
.requestMatchers("/api/webhook/**").permitAll()

// å¥åº·æ£€æŸ¥ - ç›‘æ§ç³»ç»Ÿéœ€è¦
.requestMatchers("/api/health").permitAll()
```

### 5.3 åŸºäºç¯å¢ƒçš„æ”¾è¡Œç­–ç•¥


**ğŸ”§ å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ**ï¼š

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Value("${spring.profiles.active:prod}")
    private String activeProfile;
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        
        http.authorizeHttpRequests(auth -> {
            // åŸºç¡€å…¬å¼€è·¯å¾„
            auth.requestMatchers("/public/**", "/auth/**").permitAll();
            
            // å¼€å‘ç¯å¢ƒé¢å¤–æ”¾è¡Œ
            if ("dev".equals(activeProfile) || "test".equals(activeProfile)) {
                auth.requestMatchers("/h2-console/**").permitAll()      // H2æ•°æ®åº“æ§åˆ¶å°
                    .requestMatchers("/swagger-ui/**").permitAll()      // APIæ–‡æ¡£
                    .requestMatchers("/actuator/**").permitAll();       // ç›‘æ§ç«¯ç‚¹
            }
            
            // å…¶ä»–è¯·æ±‚éœ€è¦è®¤è¯
            auth.anyRequest().authenticated();
        });
        
        // å¼€å‘ç¯å¢ƒç¦ç”¨æŸäº›å®‰å…¨ç‰¹æ€§
        if ("dev".equals(activeProfile)) {
            http.csrf(csrf -> csrf.disable())                          // ç¦ç”¨CSRF
                .headers(headers -> headers.frameOptions().disable());  // å…è®¸iframe
        }
        
        return http.build();
    }
}
```

### 5.4 æ™ºèƒ½è·¯å¾„åŒ¹é…


**ğŸ¯ è·¯å¾„åŒ¹é…æŠ€å·§**ï¼š

```java
// ç‰ˆæœ¬åŒ–APIå¤„ç†
.requestMatchers("/api/v*/public/**").permitAll()        // åŒ¹é…æ‰€æœ‰ç‰ˆæœ¬çš„å…¬å¼€API

// RESTfulé£æ ¼å¤„ç†  
.requestMatchers(HttpMethod.GET, "/api/products/**").permitAll()    // å•†å“æµè§ˆæ— éœ€ç™»å½•
.requestMatchers(HttpMethod.POST, "/api/products/**").hasRole("ADMIN") // å•†å“åˆ›å»ºéœ€è¦ç®¡ç†å‘˜

// æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
.requestMatchers(PathRequest.toStaticResources().atCommonLocations()).permitAll() // æ ‡å‡†é™æ€èµ„æºä½ç½®

// åŸºäºè¯·æ±‚å¤´çš„åŒ¹é…
.requestMatchers(request -> 
    "application/json".equals(request.getHeader("Content-Type")) &&
    request.getRequestURI().startsWith("/api/public")
).permitAll()
```

**ğŸ“ è·¯å¾„é…ç½®æœ€ä½³å®è·µ**ï¼š

| åœºæ™¯ | é…ç½®å»ºè®® | ç†ç”± |
|------|----------|------|
| **é™æ€èµ„æº** | å…¨éƒ¨æ”¾è¡Œ | æå‡ç”¨æˆ·ä½“éªŒ |
| **APIæ–‡æ¡£** | å¼€å‘ç¯å¢ƒæ”¾è¡Œ | æ–¹ä¾¿å¼€å‘è°ƒè¯• |  
| **å¥åº·æ£€æŸ¥** | æ”¾è¡ŒåŸºç¡€æ£€æŸ¥ | ç›‘æ§ç³»ç»Ÿéœ€è¦ |
| **ç”¨æˆ·æ³¨å†Œ** | å¿…é¡»æ”¾è¡Œ | ä¸šåŠ¡åŠŸèƒ½éœ€è¦ |
| **æ•æ„Ÿæ“ä½œ** | ä¸¥æ ¼æ§åˆ¶æƒé™ | ä¿è¯æ•°æ®å®‰å…¨ |

---

## 6. ğŸ”’ å¯†ç ç¼–ç å™¨é…ç½®


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦å¯†ç åŠ å¯†


**ğŸš¨ æ˜æ–‡å¯†ç çš„å±é™©**ï¼š

```
æƒ³è±¡ä½ çš„å¯†ç æ˜¯ä¸€å¼ æ˜ä¿¡ç‰‡ï¼š
âŒ é‚®é€’å‘˜èƒ½çœ‹åˆ°å†…å®¹      â†’ ç³»ç»Ÿç®¡ç†å‘˜èƒ½çœ‹åˆ°å¯†ç 
âŒ ä¸­é€”è¢«äººå·çœ‹         â†’ æ•°æ®åº“è¢«æ³„éœ²æ—¶å¯†ç æš´éœ²  
âŒ å¤åˆ¶å¾ˆå®¹æ˜“           â†’ å¯†ç è¢«è½»æ˜“å¤åˆ¶ç›—ç”¨
âŒ æ²¡æœ‰éšç§ä¿æŠ¤         â†’ ç”¨æˆ·éšç§å®Œå…¨æš´éœ²
```

**âœ… å¯†ç åŠ å¯†çš„å¥½å¤„**ï¼š
- **ä¸å¯é€†æ€§**ï¼šåŠ å¯†åæ— æ³•ç›´æ¥çœ‹åˆ°åŸå¯†ç 
- **å”¯ä¸€æ€§**ï¼šç›¸åŒå¯†ç åŠ å¯†ç»“æœä¸åŒï¼ˆåŠ ç›ï¼‰
- **å®‰å…¨æ€§**ï¼šå³ä½¿æ•°æ®åº“æ³„éœ²ï¼Œå¯†ç ä»ç„¶å®‰å…¨
- **åˆè§„æ€§**ï¼šæ»¡è¶³æ•°æ®ä¿æŠ¤æ³•è§„è¦æ±‚

### 6.2 Spring Securityå¯†ç ç¼–ç å™¨


**ğŸ”§ é…ç½®å¯†ç ç¼–ç å™¨**ï¼š

```java
@Configuration
public class SecurityConfig {
    
    // BCryptå¯†ç ç¼–ç å™¨ (æ¨è)
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    // å¦‚æœéœ€è¦è‡ªå®šä¹‰å¼ºåº¦
    @Bean 
    public PasswordEncoder customBCryptEncoder() {
        return new BCryptPasswordEncoder(12); // å¼ºåº¦12ï¼Œé»˜è®¤10
    }
    
    // å…¼å®¹å¤šç§ç¼–ç å™¨ (ç³»ç»Ÿå‡çº§æ—¶æœ‰ç”¨)
    @Bean
    public PasswordEncoder delegatingPasswordEncoder() {
        String encodingId = "bcrypt";
        Map<String, PasswordEncoder> encoders = new HashMap<>();
        encoders.put(encodingId, new BCryptPasswordEncoder());
        encoders.put("pbkdf2", Pbkdf2PasswordEncoder.defaultsForSpringSecurity_v5_8());
        encoders.put("scrypt", SCryptPasswordEncoder.defaultsForSpringSecurity_v5_8());
        
        DelegatingPasswordEncoder passwordEncoder = new DelegatingPasswordEncoder(encodingId, encoders);
        passwordEncoder.setDefaultPasswordEncoderForMatches(new BCryptPasswordEncoder());
        
        return passwordEncoder;
    }
}
```

### 6.3 å¯†ç ç¼–ç å™¨å¯¹æ¯”


| ç¼–ç å™¨ç±»å‹ | å®‰å…¨å¼ºåº¦ | æ€§èƒ½ | æ¨èä½¿ç”¨ | ç‰¹ç‚¹è¯´æ˜ |
|-----------|---------|------|----------|----------|
| **BCryptPasswordEncoder** | â­â­â­â­â­ | â­â­â­ | ğŸŸ¢ å¼ºçƒˆæ¨è | è‡ªåŠ¨åŠ ç›ï¼Œå¯è°ƒå¼ºåº¦ |
| **Pbkdf2PasswordEncoder** | â­â­â­â­ | â­â­â­â­ | ğŸŸ¡ å¯é€‰ | FIPSè®¤è¯ï¼Œæ€§èƒ½è¾ƒå¥½ |  
| **SCryptPasswordEncoder** | â­â­â­â­â­ | â­â­ | ğŸŸ¡ é«˜å®‰å…¨è¦æ±‚ | å†…å­˜æ¶ˆè€—å¤§ï¼Œè¶…é«˜å®‰å…¨ |
| **NoOpPasswordEncoder** | â­ | â­â­â­â­â­ | ğŸ”´ ä»…æµ‹è¯•ç”¨ | æ˜æ–‡å­˜å‚¨ï¼Œç”Ÿäº§ç¯å¢ƒç¦ç”¨ |

### 6.4 å¯†ç åŠ å¯†å®æˆ˜


**ğŸ‘¤ ç”¨æˆ·æ³¨å†Œæ—¶åŠ å¯†å¯†ç **ï¼š

```java
@Service
public class UserService {
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Autowired
    private UserRepository userRepository;
    
    public User registerUser(RegisterRequest request) {
        // 1. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        if (userRepository.existsByUsername(request.getUsername())) {
            throw new UserAlreadyExistsException("ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        // 2. å¯†ç å¼ºåº¦éªŒè¯ (å¯é€‰)
        validatePasswordStrength(request.getPassword());
        
        // 3. åˆ›å»ºç”¨æˆ·å¯¹è±¡
        User user = new User();
        user.setUsername(request.getUsername());
        user.setEmail(request.getEmail());
        
        // 4. â­ å…³é”®ï¼šåŠ å¯†å¯†ç 
        String encodedPassword = passwordEncoder.encode(request.getPassword());
        user.setPassword(encodedPassword);
        
        // 5. è®¾ç½®é»˜è®¤è§’è‰²
        user.setRoles(Set.of(Role.USER));
        user.setEnabled(true);
        
        // 6. ä¿å­˜åˆ°æ•°æ®åº“
        return userRepository.save(user);
    }
    
    // å¯†ç å¼ºåº¦éªŒè¯
    private void validatePasswordStrength(String password) {
        if (password.length() < 8) {
            throw new WeakPasswordException("å¯†ç é•¿åº¦è‡³å°‘8ä½");
        }
        
        // å¯ä»¥æ·»åŠ æ›´å¤šè§„åˆ™ï¼šå¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ç­‰
        String pattern = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]{8,}$";
        if (!password.matches(pattern)) {
            throw new WeakPasswordException("å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦");
        }
    }
}
```

**ğŸ”„ å¯†ç ä¿®æ”¹åŠŸèƒ½**ï¼š

```java
@RestController
@RequestMapping("/api/user")
public class UserController {
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @PostMapping("/change-password")
    @PreAuthorize("isAuthenticated()")
    public ResponseEntity<String> changePassword(
            @RequestBody ChangePasswordRequest request,
            Authentication authentication) {
        
        User currentUser = userService.findByUsername(authentication.getName());
        
        // 1. éªŒè¯å½“å‰å¯†ç 
        if (!passwordEncoder.matches(request.getCurrentPassword(), currentUser.getPassword())) {
            return ResponseEntity.badRequest().body("å½“å‰å¯†ç é”™è¯¯");
        }
        
        // 2. éªŒè¯æ–°å¯†ç å¼ºåº¦
        try {
            validatePasswordStrength(request.getNewPassword());
        } catch (WeakPasswordException e) {
            return ResponseEntity.badRequest().body(e.getMessage());
        }
        
        // 3. åŠ å¯†æ–°å¯†ç å¹¶ä¿å­˜
        String encodedNewPassword = passwordEncoder.encode(request.getNewPassword());
        currentUser.setPassword(encodedNewPassword);
        userService.save(currentUser);
        
        return ResponseEntity.ok("å¯†ç ä¿®æ”¹æˆåŠŸ");
    }
}
```

### 6.5 å¯†ç åŠ å¯†åŸç†æ¼”ç¤º


**ğŸ”¬ BCryptåŠ å¯†è¿‡ç¨‹**ï¼š

```java
@Component
public class PasswordDemo {
    
    private final BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
    
    public void demonstratePasswordEncoding() {
        String rawPassword = "mySecretPassword123";
        
        // æ¯æ¬¡åŠ å¯†ç»“æœéƒ½ä¸åŒ (å› ä¸ºæœ‰éšæœºç›)
        String encoded1 = encoder.encode(rawPassword);
        String encoded2 = encoder.encode(rawPassword);
        String encoded3 = encoder.encode(rawPassword);
        
        System.out.println("åŸå§‹å¯†ç : " + rawPassword);
        System.out.println("åŠ å¯†ç»“æœ1: " + encoded1);
        System.out.println("åŠ å¯†ç»“æœ2: " + encoded2);
        System.out.println("åŠ å¯†ç»“æœ3: " + encoded3);
        
        // éªŒè¯å¯†ç  - éƒ½ä¼šè¿”å›true
        System.out.println("éªŒè¯1: " + encoder.matches(rawPassword, encoded1)); // true
        System.out.println("éªŒè¯2: " + encoder.matches(rawPassword, encoded2)); // true  
        System.out.println("éªŒè¯3: " + encoder.matches(rawPassword, encoded3)); // true
        
        // é”™è¯¯å¯†ç éªŒè¯
        System.out.println("é”™è¯¯å¯†ç : " + encoder.matches("wrongPassword", encoded1)); // false
    }
}

/* è¾“å‡ºç¤ºä¾‹ï¼š
åŸå§‹å¯†ç : mySecretPassword123
åŠ å¯†ç»“æœ1: $2a$10$N.zmdr9k7uOCQb0bta/OOuED5vvPGvBqo5F3gE7wNgGl4JzrEhjey
åŠ å¯†ç»“æœ2: $2a$10$Jw8I2zOV7wkI5oq9NRFQT.GWuiTVIWp6HPWgA4WNZ4.Qj3mGWg1LG
åŠ å¯†ç»“æœ3: $2a$10$xJ2kNm1qF4YoP6cQ3wS9d.vF8nHqGcBQUoUo8YhNxC5yJ9zM7qLOu
*/
```

**ğŸ” å¯†ç å­—ç¬¦ä¸²ç»“æ„è§£æ**ï¼š
```
$2a$10$N.zmdr9k7uOCQb0bta/OOuED5vvPGvBqo5F3gE7wNgGl4JzrEhjey
â”‚ â”‚  â”‚  â”‚                    â”‚                           
â”‚ â”‚  â”‚  â””â”€â”€â”€ ç›å€¼ (22å­—ç¬¦)     â””â”€â”€â”€ å“ˆå¸Œå€¼ (31å­—ç¬¦)
â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€ å¼ºåº¦å› å­ (10)       
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç‰ˆæœ¬å· (2a)         
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ ‡è¯†ç¬¦ ($)          
```

---

## 7. ğŸ« JWTä»¤ç‰Œé›†æˆ


### 7.1 ä»€ä¹ˆæ˜¯JWT


**ğŸ« JWTå°±åƒç”µå½±ç¥¨**ï¼š

```
ä¼ ç»ŸSessionå°±åƒï¼š                    JWTå°±åƒï¼š
ç”µå½±é™¢å‘ç»™ä½ ä¸€ä¸ªå·ç‰Œ (Session ID)     ç”µå½±é™¢ç»™ä½ ä¸€å¼ å®Œæ•´çš„ç”µå½±ç¥¨ (JWT)
â”‚                                   â”‚
â”œâ”€ å·ç‰Œåªæ˜¯æ ‡è¯†                      â”œâ”€ ç¥¨é¢åŒ…å«æ‰€æœ‰ä¿¡æ¯
â”œâ”€ éœ€è¦å›ç”µå½±é™¢æŸ¥åº§ä½ä¿¡æ¯              â”œâ”€ ç¥¨é¢ç›´æ¥æ˜¾ç¤ºåº§ä½ã€æ—¶é—´ã€åœºæ¬¡
â”œâ”€ å·ç‰Œä¸¢å¤±æ— æ³•å…¥åœº                  â”œâ”€ ç¥¨æœ‰ç­¾åé˜²ä¼ªé€ 
â””â”€ ä¾èµ–ç”µå½±é™¢ç³»ç»Ÿ                    â””â”€ è‡ªåŒ…å«ï¼Œä»»ä½•åœ°æ–¹éƒ½å¯éªŒè¯
```

**JWTç»“æ„ç»„æˆ**ï¼š
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
â”‚                                    â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€ Header (ç®—æ³•å’Œç±»å‹)          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Payload (ç”¨æˆ·ä¿¡æ¯å’Œå£°æ˜)                                               â””â”€ Signature (ç­¾å)
```

### 7.2 JWTé…ç½®å®ç°


**ğŸ“¦ æ·»åŠ JWTä¾èµ–**ï¼š

```xml
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>0.11.5</version>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-impl</artifactId>
    <version>0.11.5</version>
    <scope>runtime</scope>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-jackson</artifactId>
    <version>0.11.5</version>
    <scope>runtime</scope>
</dependency>
```

**ğŸ”§ JWTå·¥å…·ç±»**ï¼š

```java
@Component
public class JwtUtil {
    
    // JWTç­¾åå¯†é’¥ (ç”Ÿäº§ç¯å¢ƒåº”è¯¥ä»é…ç½®æ–‡ä»¶è¯»å–)
    private String jwtSecret = "mySecretKey12345678901234567890123456789012345678901234567890";
    
    // Tokenè¿‡æœŸæ—¶é—´ (24å°æ—¶)
    private int jwtExpirationMs = 86400000;
    
    // ç”ŸæˆJWT Token
    public String generateJwtToken(Authentication authentication) {
        UserPrincipal userPrincipal = (UserPrincipal) authentication.getPrincipal();
        
        return Jwts.builder()
                .setSubject(userPrincipal.getUsername())                    // ç”¨æˆ·å
                .claim("userId", userPrincipal.getId())                     // è‡ªå®šä¹‰å£°æ˜ï¼šç”¨æˆ·ID
                .claim("authorities", getAuthorities(authentication))       // è‡ªå®šä¹‰å£°æ˜ï¼šæƒé™åˆ—è¡¨
                .setIssuedAt(new Date())                                   // ç­¾å‘æ—¶é—´
                .setExpiration(new Date(System.currentTimeMillis() + jwtExpirationMs)) // è¿‡æœŸæ—¶é—´
                .signWith(SignatureAlgorithm.HS512, jwtSecret)             // ç­¾åç®—æ³•å’Œå¯†é’¥
                .compact();
    }
    
    // ä»JWTä¸­è·å–ç”¨æˆ·å
    public String getUsernameFromJwtToken(String token) {
        Claims claims = Jwts.parser()
                .setSigningKey(jwtSecret)
                .parseClaimsJws(token)
                .getBody();
        
        return claims.getSubject();
    }
    
    // éªŒè¯JWT Token
    public boolean validateJwtToken(String authToken) {
        try {
            Jwts.parser().setSigningKey(jwtSecret).parseClaimsJws(authToken);
            return true;
        } catch (SignatureException e) {
            logger.error("JWTç­¾åæ— æ•ˆ: {}", e.getMessage());
        } catch (MalformedJwtException e) {
            logger.error("JWTæ ¼å¼é”™è¯¯: {}", e.getMessage());
        } catch (ExpiredJwtException e) {
            logger.error("JWTå·²è¿‡æœŸ: {}", e.getMessage());
        } catch (UnsupportedJwtException e) {
            logger.error("JWTä¸æ”¯æŒ: {}", e.getMessage());
        } catch (IllegalArgumentException e) {
            logger.error("JWTå£°æ˜ä¸ºç©º: {}", e.getMessage());
        }
        return false;
    }
    
    // è·å–æƒé™åˆ—è¡¨
    private List<String> getAuthorities(Authentication authentication) {
        return authentication.getAuthorities().stream()
                .map(GrantedAuthority::getAuthority)
                .collect(Collectors.toList());
    }
}
```

### 7.3 JWTè¿‡æ»¤å™¨é…ç½®


**ğŸ›¡ï¸ JWTè®¤è¯è¿‡æ»¤å™¨**ï¼š

```java
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                  HttpServletResponse response, 
                                  FilterChain filterChain) throws ServletException, IOException {
        
        try {
            // 1. ä»è¯·æ±‚å¤´è·å–JWT Token
            String jwt = parseJwt(request);
            
            // 2. éªŒè¯Tokenå¹¶è®¾ç½®è®¤è¯ä¿¡æ¯
            if (jwt != null && jwtUtil.validateJwtToken(jwt)) {
                String username = jwtUtil.getUsernameFromJwtToken(jwt);
                
                // 3. åŠ è½½ç”¨æˆ·è¯¦æƒ…
                UserDetails userDetails = userDetailsService.loadUserByUsername(username);
                
                // 4. åˆ›å»ºè®¤è¯å¯¹è±¡
                UsernamePasswordAuthenticationToken authentication = 
                    new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
                authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                
                // 5. è®¾ç½®åˆ°å®‰å…¨ä¸Šä¸‹æ–‡
                SecurityContextHolder.getContext().setAuthentication(authentication);
            }
        } catch (Exception e) {
            logger.error("æ— æ³•è®¾ç½®ç”¨æˆ·è®¤è¯: {}", e);
        }
        
        // 6. ç»§ç»­è¿‡æ»¤å™¨é“¾
        filterChain.doFilter(request, response);
    }
    
    // ä»è¯·æ±‚å¤´è§£æJWT Token
    private String parseJwt(HttpServletRequest request) {
        String headerAuth = request.getHeader("Authorization");
        
        if (StringUtils.hasText(headerAuth) && headerAuth.startsWith("Bearer ")) {
            return headerAuth.substring(7); // å»æ‰ "Bearer " å‰ç¼€
        }
        
        return null;
    }
}
```

### 7.4 ç™»å½•æ¥å£å®ç°


**ğŸšª JWTç™»å½•æ§åˆ¶å™¨**ï¼š

```java
@RestController
@RequestMapping("/api/auth")
public class AuthController {
    
    @Autowired
    private AuthenticationManager authenticationManager;
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Autowired
    private UserService userService;
    
    // JWTç™»å½•æ¥å£
    @PostMapping("/login")
    public ResponseEntity<?> authenticateUser(@RequestBody LoginRequest loginRequest) {
        try {
            // 1. æ‰§è¡Œè®¤è¯
            Authentication authentication = authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(
                    loginRequest.getUsername(),
                    loginRequest.getPassword()
                )
            );
            
            // 2. è®¤è¯æˆåŠŸï¼Œç”ŸæˆJWT Token
            String jwt = jwtUtil.generateJwtToken(authentication);
            UserPrincipal userPrincipal = (UserPrincipal) authentication.getPrincipal();
            
            // 3. è¿”å›Tokenå’Œç”¨æˆ·ä¿¡æ¯
            return ResponseEntity.ok(new JwtResponse(
                jwt,
                userPrincipal.getId(),
                userPrincipal.getUsername(),
                userPrincipal.getEmail(),
                userPrincipal.getAuthorities().stream()
                    .map(item -> item.getAuthority())
                    .collect(Collectors.toList())
            ));
            
        } catch (BadCredentialsException e) {
            return ResponseEntity.badRequest()
                .body(new MessageResponse("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼"));
        }
    }
    
    // æ³¨å†Œæ¥å£
    @PostMapping("/register")
    public ResponseEntity<?> registerUser(@RequestBody SignupRequest signUpRequest) {
        if (userService.existsByUsername(signUpRequest.getUsername())) {
            return ResponseEntity.badRequest()
                .body(new MessageResponse("ç”¨æˆ·åå·²è¢«ä½¿ç”¨ï¼"));
        }
        
        if (userService.existsByEmail(signUpRequest.getEmail())) {
            return ResponseEntity.badRequest()
                .body(new MessageResponse("é‚®ç®±å·²è¢«ä½¿ç”¨ï¼"));
        }
        
        // åˆ›å»ºæ–°ç”¨æˆ·
        User user = userService.createUser(signUpRequest);
        
        return ResponseEntity.ok(new MessageResponse("ç”¨æˆ·æ³¨å†ŒæˆåŠŸï¼"));
    }
    
    // åˆ·æ–°Tokenæ¥å£
    @PostMapping("/refresh")
    @PreAuthorize("isAuthenticated()")
    public ResponseEntity<?> refreshToken(HttpServletRequest request) {
        String jwt = parseJwt(request);
        
        if (jwt != null && jwtUtil.validateJwtToken(jwt)) {
            String username = jwtUtil.getUsernameFromJwtToken(jwt);
            UserDetails userDetails = userDetailsService.loadUserByUsername(username);
            
            // ç”Ÿæˆæ–°Token
            Authentication authentication = new UsernamePasswordAuthenticationToken(
                userDetails, null, userDetails.getAuthorities());
            String newJwt = jwtUtil.generateJwtToken(authentication);
            
            return ResponseEntity.ok(new JwtResponse(newJwt));
        }
        
        return ResponseEntity.badRequest().body(new MessageResponse("æ— æ•ˆçš„Token"));
    }
}
```

### 7.5 å‰ç«¯JWTä½¿ç”¨


**ğŸŒ å‰ç«¯Tokenä½¿ç”¨ç¤ºä¾‹**ï¼š

```javascript
// ç™»å½•è¯·æ±‚
async function login(username, password) {
    const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username, password })
    });
    
    if (response.ok) {
        const data = await response.json();
        // å­˜å‚¨Tokenåˆ°localStorage
        localStorage.setItem('jwt_token', data.token);
        return data;
    } else {
        throw new Error('ç™»å½•å¤±è´¥');
    }
}

// å‘é€è®¤è¯è¯·æ±‚
async function fetchUserData() {
    const token = localStorage.getItem('jwt_token');
    
    const response = await fetch('/api/user/profile', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,  // é‡è¦ï¼šBearerå‰ç¼€
            'Content-Type': 'application/json'
        }
    });
    
    if (response.status === 401) {
        // Tokenè¿‡æœŸï¼Œé‡æ–°ç™»å½•
        localStorage.removeItem('jwt_token');
        window.location.href = '/login';
        return;
    }
    
    return await response.json();
}

// è‡ªåŠ¨æ·»åŠ Tokençš„axiosé…ç½®
axios.interceptors.request.use(
    config => {
        const token = localStorage.getItem('jwt_token');
        if (token) {
            config.headers['Authorization'] = `Bearer ${token}`;
        }
        return config;
    },
    error => Promise.reject(error)
);

// Tokenè¿‡æœŸè‡ªåŠ¨å¤„ç†
axios.interceptors.response.use(
    response => response,
    error => {
        if (error.response?.status === 401) {
            localStorage.removeItem('jwt_token');
            window.location.href = '/login';
        }
        return Promise.reject(error);
    }
);
```

---

## 8. ğŸ›¡ï¸ CSRFé˜²æŠ¤é…ç½®


### 8.1 ä»€ä¹ˆæ˜¯CSRFæ”»å‡»


**ğŸ­ CSRFæ”»å‡»åœºæ™¯æ¨¡æ‹Ÿ**ï¼š

```
1. å°æ˜ç™»å½•äº†é“¶è¡Œç½‘ç«™ (bank.com)
2. é“¶è¡Œè®¾ç½®äº†ç™»å½•Cookieï¼Œå°æ˜ä¿æŒç™»å½•çŠ¶æ€
3. å°æ˜åœ¨å¦ä¸€ä¸ªæ ‡ç­¾é¡µè®¿é—®äº†æ¶æ„ç½‘ç«™ (evil.com)
4. æ¶æ„ç½‘ç«™åŒ…å«éšè—è¡¨å•ï¼š

<form action="https://bank.com/transfer" method="POST">
    <input type="hidden" name="to" value="é»‘å®¢è´¦æˆ·">
    <input type="hidden" name="amount" value="10000">
</form>
<script>document.forms[0].submit();</script>

5. è¡¨å•è‡ªåŠ¨æäº¤ï¼Œåˆ©ç”¨å°æ˜çš„ç™»å½•çŠ¶æ€è½¬è´¦ç»™é»‘å®¢
6. é“¶è¡Œç³»ç»Ÿè®¤ä¸ºè¿™æ˜¯å°æ˜çš„æ­£å¸¸æ“ä½œï¼Œå› ä¸ºCookieéªŒè¯é€šè¿‡
```

**ğŸ” CSRFæ”»å‡»çš„ç‰¹ç‚¹**ï¼š
- **åˆ©ç”¨ä¿¡ä»»**ï¼šåˆ©ç”¨ç½‘ç«™å¯¹ç”¨æˆ·æµè§ˆå™¨çš„ä¿¡ä»»
- **è·¨ç«™æ‰§è¡Œ**ï¼šåœ¨ç¬¬ä¸‰æ–¹ç½‘ç«™æ‰§è¡Œç›®æ ‡ç½‘ç«™çš„æ“ä½œ
- **æ— æ„ŸçŸ¥**ï¼šç”¨æˆ·æ¯«ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æ‰§è¡Œæ“ä½œ
- **è‡ªåŠ¨åŒ–**ï¼šé€šè¿‡è„šæœ¬è‡ªåŠ¨å®Œæˆæ”»å‡»è¿‡ç¨‹

### 8.2 Spring Security CSRFé˜²æŠ¤


**ğŸ›¡ï¸ CSRFé˜²æŠ¤åŸç†**ï¼š

```
æ­£å¸¸è¯·æ±‚æµç¨‹ï¼ˆæœ‰CSRFé˜²æŠ¤ï¼‰ï¼š
1. ç”¨æˆ·è®¿é—®é¡µé¢ â†’ æœåŠ¡å™¨ç”ŸæˆCSRF Token
2. é¡µé¢è¡¨å•åŒ…å«Token â†’ <input name="_csrf" value="abc123">
3. ç”¨æˆ·æäº¤è¡¨å• â†’ Tokenä¸€èµ·æäº¤
4. æœåŠ¡å™¨éªŒè¯Token â†’ åŒ¹é…æˆåŠŸï¼Œå…è®¸æ“ä½œ

æ¶æ„è¯·æ±‚æµç¨‹ï¼š
1. æ¶æ„ç½‘ç«™ä¼ªé€ è¯·æ±‚ â†’ æ²¡æœ‰æœ‰æ•ˆçš„CSRF Token  
2. æœåŠ¡å™¨éªŒè¯Token â†’ Tokenç¼ºå¤±æˆ–æ— æ•ˆ
3. æ‹’ç»è¯·æ±‚ â†’ æ”»å‡»å¤±è´¥
```

**âš™ï¸ CSRFé…ç½®é€‰é¡¹**ï¼š

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // å¯ç”¨CSRFé˜²æŠ¤ (é»˜è®¤å¯ç”¨)
            .csrf(csrf -> csrf
                // æŒ‡å®šéœ€è¦CSRFä¿æŠ¤çš„è¯·æ±‚åŒ¹é…å™¨
                .requireCsrfProtectionMatcher(new AndRequestMatcher(
                    CsrfFilter.DEFAULT_CSRF_MATCHER,
                    new NegatedRequestMatcher(new OrRequestMatcher(
                        new AntPathRequestMatcher("/api/**", HttpMethod.GET.name()),
                        new AntPathRequestMatcher("/api/public/**")
                    ))
                ))
                
                // æ’é™¤ç‰¹å®šè·¯å¾„ (ä¸éœ€è¦CSRFä¿æŠ¤)
                .ignoringRequestMatchers(
                    "/api/webhook/**",      // Webhookå›è°ƒ
                    "/api/auth/login",      // ç™»å½•æ¥å£  
                    "/api/auth/register"    // æ³¨å†Œæ¥å£
                )
                
                // è‡ªå®šä¹‰CSRF Tokenå­˜å‚¨
                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
            );
            
        return http.build();
    }
}
```

### 8.3 ä¸åŒåœºæ™¯çš„CSRFé…ç½®


**ğŸŒ ä¼ ç»ŸWebåº”ç”¨é…ç½®**ï¼š

```java
// é€‚ç”¨äºï¼šJSPã€Thymeleafç­‰æœåŠ¡ç«¯æ¸²æŸ“é¡µé¢
@Configuration
public class WebAppSecurityConfig {
    
    @Bean
    public SecurityFilterChain webAppFilterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf
                // ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œæ‰€æœ‰çŠ¶æ€å˜æ›´æ“ä½œéƒ½éœ€è¦CSRF Token
                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
                
                // è‡ªå®šä¹‰å¤±è´¥å¤„ç†
                .failureHandler((request, response, exception) -> {
                    response.setStatus(HttpStatus.FORBIDDEN.value());
                    response.getWriter().write("{\"error\":\"CSRF TokenéªŒè¯å¤±è´¥\"}");
                })
            )
            
            // è¡¨å•ç™»å½•é…ç½®
            .formLogin(form -> form
                .loginPage("/login")
                .defaultSuccessUrl("/dashboard")
                .permitAll()
            );
            
        return http.build();
    }
}
```

**ğŸ“± APIåº”ç”¨é…ç½®**ï¼š

```java
// é€‚ç”¨äºï¼šå‰åç«¯åˆ†ç¦»ã€ç§»åŠ¨APPç­‰åœºæ™¯
@Configuration
public class ApiSecurityConfig {
    
    @Bean
    public SecurityFilterChain apiFilterChain(HttpSecurity http) throws Exception {
        http
            .securityMatcher("/api/**")  // åªé€‚ç”¨äºAPIè·¯å¾„
            
            // ç¦ç”¨CSRF (APIé€šå¸¸ä½¿ç”¨JWTï¼Œæ— çŠ¶æ€)
            .csrf(csrf -> csrf.disable())
            
            // ç¦ç”¨Session (APIä½¿ç”¨Tokenè®¤è¯)
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                
            // æ·»åŠ JWTè¿‡æ»¤å™¨
            .addFilterBefore(jwtAuthenticationFilter(), 
                           UsernamePasswordAuthenticationFilter.class);
            
        return http.build();
    }
}
```

**ğŸ”€ æ··åˆåº”ç”¨é…ç½®**ï¼š

```java
// é€‚ç”¨äºï¼šåŒæ—¶æä¾›Webé¡µé¢å’ŒAPIçš„åº”ç”¨
@Configuration  
public class HybridSecurityConfig {
    
    @Bean
    @Order(1)  // ä¼˜å…ˆçº§é«˜
    public SecurityFilterChain apiFilterChain(HttpSecurity http) throws Exception {
        http
            .securityMatcher("/api/**")
            .csrf(csrf -> csrf.disable())  // APIç¦ç”¨CSRF
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS));
            
        return http.build();
    }
    
    @Bean
    @Order(2)  // ä¼˜å…ˆçº§ä½
    public SecurityFilterChain webFilterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf
                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
            )  // Webé¡µé¢å¯ç”¨CSRF
            .formLogin(Customizer.withDefaults());
            
        return http.build();
    }
}
```

### 8.4 å‰ç«¯CSRF Tokenå¤„ç†


**ğŸŒ ä¼ ç»Ÿè¡¨å•å¤„ç†**ï¼š

```html
<!-- Thymeleafæ¨¡æ¿ -->
<form th:action="@{/api/users}" method="post">
    <!-- CSRF Tokenè‡ªåŠ¨æ·»åŠ  -->
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    
    <input type="text" name="username" placeholder="ç”¨æˆ·å">
    <input type="email" name="email" placeholder="é‚®ç®±">
    <button type="submit">æäº¤</button>
</form>

<!-- æˆ–è€…ä½¿ç”¨metaæ ‡ç­¾ -->
<html>
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
</html>
```

**âš¡ JavaScript Ajaxå¤„ç†**ï¼š

```javascript
// è·å–CSRF Token
function getCsrfToken() {
    // æ–¹æ³•1ï¼šä»Cookieè·å–
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'XSRF-TOKEN') {
            return decodeURIComponent(value);
        }
    }
    
    // æ–¹æ³•2ï¼šä»metaæ ‡ç­¾è·å–
    const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    return token;
}

// å‘é€å¸¦CSRF Tokençš„è¯·æ±‚
async function submitForm(formData) {
    const csrfToken = getCsrfToken();
    
    const response = await fetch('/api/users', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': csrfToken,  // åœ¨è¯·æ±‚å¤´ä¸­å‘é€Token
            // æˆ–è€… 'X-XSRF-TOKEN': csrfToken
        },
        body: JSON.stringify(formData)
    });
    
    if (response.status === 403) {
        console.error('CSRF TokenéªŒè¯å¤±è´¥');
        return;
    }
    
    return await response.json();
}

// axioså…¨å±€é…ç½®
axios.defaults.xsrfCookieName = 'XSRF-TOKEN';
axios.defaults.xsrfHeaderName = 'X-XSRF-TOKEN';

// æˆ–è€…æ‰‹åŠ¨é…ç½®æ‹¦æˆªå™¨
axios.interceptors.request.use(config => {
    const token = getCsrfToken();
    if (token) {
        config.headers['X-CSRF-TOKEN'] = token;
    }
    return config;
});
```

### 8.5 CSRFé˜²æŠ¤æœ€ä½³å®è·µ


**âœ… é…ç½®å»ºè®®**ï¼š

| åº”ç”¨ç±»å‹ | CSRFé…ç½® | ç†ç”± | ç¤ºä¾‹åœºæ™¯ |
|---------|----------|------|----------|
| **ä¼ ç»ŸWebåº”ç”¨** | å¯ç”¨CSRF | åŸºäºCookieè®¤è¯ï¼Œéœ€è¦é˜²æŠ¤ | JSPã€Thymeleafé¡µé¢ |
| **çº¯APIæœåŠ¡** | ç¦ç”¨CSRF | æ— çŠ¶æ€Tokenè®¤è¯ï¼Œä¸éœ€è¦ | RESTful APIã€å¾®æœåŠ¡ |
| **æ··åˆåº”ç”¨** | åˆ†è·¯å¾„é…ç½® | ä¸åŒè·¯å¾„ä¸åŒéœ€æ±‚ | åŒæ—¶æä¾›é¡µé¢å’ŒAPI |
| **ç§»åŠ¨åº”ç”¨åç«¯** | ç¦ç”¨CSRF | Tokenè®¤è¯ï¼Œæ— è·¨ç«™é£é™© | ç§»åŠ¨APPåç«¯API |

**âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹**ï¼š

```java
// âŒ é”™è¯¯åšæ³•ï¼šå…¨å±€ç¦ç”¨CSRF
.csrf(csrf -> csrf.disable())  // å¦‚æœæœ‰ä¼ ç»Ÿè¡¨å•ï¼Œè¿™æ ·ä¸å®‰å…¨

// âœ… æ­£ç¡®åšæ³•ï¼šé’ˆå¯¹æ€§é…ç½®
.csrf(csrf -> csrf
    .ignoringRequestMatchers("/api/public/**")  // åªå¯¹ç‰¹å®šè·¯å¾„ç¦ç”¨
    .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
)

// âš ï¸ æ³¨æ„ï¼šHttpOnlyè®¾ç½®
// withHttpOnlyFalse() - JavaScriptå¯ä»¥è®¿é—®ï¼Œé€‚åˆSPA
// withHttpOnlyTrue() - JavaScriptæ— æ³•è®¿é—®ï¼Œæ›´å®‰å…¨ä½†ä¸é€‚åˆSPA
```

**ğŸ”§ è°ƒè¯•CSRFé—®é¢˜**ï¼š

```java
// å¯ç”¨CSRFè°ƒè¯•æ—¥å¿—
logging.level.org.springframework.security.web.csrf=DEBUG

// è‡ªå®šä¹‰CSRFå¤±è´¥å¤„ç†å™¨  
@Component
public class CsrfTokenLogger implements AccessDeniedHandler {
    
    @Override
    public void handle(HttpServletRequest request, 
                      HttpServletResponse response,
                      AccessDeniedException accessDeniedException) throws IOException {
        
        if (accessDeniedException instanceof CsrfException) {
            logger.warn("CSRF TokenéªŒè¯å¤±è´¥: URI={}, Method={}, RemoteAddr={}", 
                       request.getRequestURI(), 
                       request.getMethod(),
                       request.getRemoteAddr());
        }
        
        response.setStatus(HttpServletResponse.SC_FORBIDDEN);
        response.getWriter().write("{\"error\":\"CSRFéªŒè¯å¤±è´¥\",\"message\":\"è¯·åˆ·æ–°é¡µé¢é‡è¯•\"}");
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ Spring Securityæœ¬è´¨ï¼šä¸ºSpringåº”ç”¨æä¾›å£°æ˜å¼å®‰å…¨æœåŠ¡çš„æ¡†æ¶
ğŸ”¸ è®¤è¯vsæˆæƒï¼šè®¤è¯è§£å†³"ä½ æ˜¯è°"ï¼Œæˆæƒè§£å†³"ä½ èƒ½åšä»€ä¹ˆ"  
ğŸ”¸ è¿‡æ»¤å™¨é“¾ï¼šè¯·æ±‚é€šè¿‡ä¸€ç³»åˆ—å®‰å…¨è¿‡æ»¤å™¨è¿›è¡Œå¤„ç†
ğŸ”¸ å¯†ç åŠ å¯†ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨BCryptç­‰å¼ºåŠ å¯†ç®—æ³•
ğŸ”¸ JWTä»¤ç‰Œï¼šæ— çŠ¶æ€è®¤è¯æ–¹æ¡ˆï¼Œé€‚åˆAPIå’Œå¾®æœåŠ¡
ğŸ”¸ CSRFé˜²æŠ¤ï¼šé˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»çš„é‡è¦æœºåˆ¶
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Spring Securityä¸æ˜¯é»‘é­”æ³•**
```
æ–°æ‰‹å¸¸è§è¯¯åŒºï¼š
âŒ "Spring Securityå¤ªå¤æ‚ï¼Œçœ‹ä¸æ‡‚"
âŒ "é…ç½®ä¸€åŠ å°±å…¨éƒ¨éœ€è¦ç™»å½•äº†"  
âŒ "ä¸ºä»€ä¹ˆæˆ‘çš„APIæ€»æ˜¯403é”™è¯¯"

æ­£ç¡®ç†è§£ï¼š
âœ… Spring Securityæ˜¯ä¸€å¥—å¯é…ç½®çš„å®‰å…¨æ¡†æ¶
âœ… é»˜è®¤é…ç½®å¾ˆä¸¥æ ¼ï¼Œéœ€è¦æ ¹æ®éœ€æ±‚è°ƒæ•´
âœ… ç†è§£è¿‡æ»¤å™¨é“¾å°±èƒ½ç†è§£å·¥ä½œåŸç†
âœ… è®¤è¯å’Œæˆæƒæ˜¯ä¸¤ä¸ªç‹¬ç«‹ä½†ç›¸å…³çš„æ¦‚å¿µ
```

**ğŸ”¹ ä¸åŒåœºæ™¯é€‰æ‹©ä¸åŒç­–ç•¥**
```
ä¼ ç»ŸWebåº”ç”¨ï¼š
- Session + Cookieè®¤è¯
- å¯ç”¨CSRFé˜²æŠ¤  
- è¡¨å•ç™»å½•é¡µé¢

å‰åç«¯åˆ†ç¦»åº”ç”¨ï¼š
- JWT Tokenè®¤è¯
- ç¦ç”¨CSRFé˜²æŠ¤
- RESTful APIæ¥å£

å¾®æœåŠ¡æ¶æ„ï¼š
- JWTæˆ–OAuth2è®¤è¯
- æ— çŠ¶æ€è®¾è®¡
- æœåŠ¡é—´è®¤è¯
```

**ğŸ”¹ å®‰å…¨é…ç½®çš„æ¼”è¿›è¿‡ç¨‹**
```
å­¦ä¹ è·¯å¾„ï¼š
ç¬¬1é˜¶æ®µï¼šä½¿ç”¨é»˜è®¤é…ç½®ï¼Œç†è§£åŸºæœ¬æ¦‚å¿µ
ç¬¬2é˜¶æ®µï¼šè‡ªå®šä¹‰ç”¨æˆ·å’Œå¯†ç ï¼Œé…ç½®ç®€å•æƒé™
ç¬¬3é˜¶æ®µï¼šé›†æˆæ•°æ®åº“ï¼Œå®ç°åŠ¨æ€ç”¨æˆ·ç®¡ç†
ç¬¬4é˜¶æ®µï¼šæ·»åŠ JWTæ”¯æŒï¼Œå®ç°æ— çŠ¶æ€è®¤è¯
ç¬¬5é˜¶æ®µï¼šç»†ç²’åº¦æƒé™æ§åˆ¶ï¼Œæ–¹æ³•çº§åˆ«æˆæƒ
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¼ä¸šå¼€å‘å¿…å¤‡æŠ€èƒ½**ï¼š
- ğŸ¢ **ä¼ä¸šé¡¹ç›®**ï¼šå‡ ä¹æ‰€æœ‰ä¼ä¸šåº”ç”¨éƒ½éœ€è¦å®‰å…¨è®¤è¯
- ğŸ”’ **åˆè§„è¦æ±‚**ï¼šæ•°æ®ä¿æŠ¤æ³•è§„è¦æ±‚åº”ç”¨å…·å¤‡å®‰å…¨é˜²æŠ¤
- ğŸš€ **å¾®æœåŠ¡æ¶æ„**ï¼šç°ä»£æ¶æ„å¿…å¤‡çš„å®‰å…¨ç»„ä»¶
- ğŸ“± **ç§»åŠ¨äº’è”ç½‘**ï¼šAPIå®‰å…¨æ˜¯ç§»åŠ¨åº”ç”¨çš„åŸºç¡€

**ğŸ› ï¸ è§£å†³å®é™…é—®é¢˜**ï¼š
- **ç”¨æˆ·ç®¡ç†**ï¼šæ³¨å†Œã€ç™»å½•ã€æƒé™åˆ†é…
- **æ•°æ®ä¿æŠ¤**ï¼šé˜²æ­¢æœªæˆæƒè®¿é—®æ•æ„Ÿæ•°æ®
- **APIå®‰å…¨**ï¼šä¿æŠ¤RESTful APIä¸è¢«æ¶æ„è°ƒç”¨
- **æ”»å‡»é˜²æŠ¤**ï¼šCSRFã€SessionåŠ«æŒç­‰æ”»å‡»é˜²æŠ¤

### 9.4 å­¦ä¹ å»ºè®®


**ğŸ“š å¾ªåºæ¸è¿›çš„å­¦ä¹ è·¯å¾„**ï¼š

```
ğŸ¯ ç¬¬1å‘¨ï¼šåŸºç¡€æ¦‚å¿µç†è§£
- è®¤è¯ä¸æˆæƒçš„åŒºåˆ«
- è¿‡æ»¤å™¨é“¾å·¥ä½œåŸç†
- åŸºæœ¬é…ç½®å’Œæµ‹è¯•

ğŸ¯ ç¬¬2å‘¨ï¼šç”¨æˆ·è®¤è¯å®ç°  
- è‡ªå®šä¹‰ç”¨æˆ·æœåŠ¡
- å¯†ç ç¼–ç å™¨ä½¿ç”¨
- æ•°æ®åº“é›†æˆ

ğŸ¯ ç¬¬3å‘¨ï¼šæƒé™æ§åˆ¶æ·±å…¥
- è§’è‰²å’Œæƒé™è®¾è®¡
- URLçº§åˆ«æˆæƒ
- æ–¹æ³•çº§åˆ«æˆæƒ

ğŸ¯ ç¬¬4å‘¨ï¼šé«˜çº§ç‰¹æ€§åº”ç”¨
- JWTä»¤ç‰Œé›†æˆ
- CSRFé˜²æŠ¤é…ç½®
- å®‰å…¨äº‹ä»¶å¤„ç†
```

**ğŸ”§ å®è·µé¡¹ç›®å»ºè®®**ï¼š
1. **ä¸ªäººåšå®¢ç³»ç»Ÿ**ï¼šç”¨æˆ·æ³¨å†Œç™»å½•ï¼Œæ–‡ç« æƒé™ç®¡ç†
2. **åœ¨çº¿å•†åŸåå°**ï¼šå•†å“ç®¡ç†æƒé™ï¼Œè®¢å•æ“ä½œæƒé™  
3. **ä¼ä¸šOAç³»ç»Ÿ**ï¼šéƒ¨é—¨è§’è‰²æƒé™ï¼Œå®¡æ‰¹æµç¨‹æƒé™
4. **APIæœåŠ¡å¹³å°**ï¼šJWTè®¤è¯ï¼ŒAPIè°ƒç”¨æƒé™æ§åˆ¶

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ğŸ§  Spring Securityè®°å¿†æ³•ï¼š
è®¤è¯å…ˆè¡Œæƒé™è·Ÿï¼Œè¿‡æ»¤å™¨é“¾ä¸€ç¯æ‰£ä¸€ç¯
å¯†ç åŠ å¯†ä¸èƒ½å°‘ï¼ŒCSRFé˜²æŠ¤å¾ˆé‡è¦
JWTæ— çŠ¶æ€APIå¥½ï¼Œä¼ ç»ŸWebç”¨Sessionä¿
é…ç½®åˆ†åœºæ™¯æ¥å®šåˆ¶ï¼Œå®‰å…¨ç¬¬ä¸€ä¸èƒ½å°‘
```

### 9.5 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â“ æ–°æ‰‹å¸¸è§é—®é¢˜**ï¼š

| é—®é¢˜ | åŸå› åˆ†æ | è§£å†³æ–¹æ¡ˆ |
|------|----------|----------|
| **æ‰€æœ‰æ¥å£éƒ½éœ€è¦ç™»å½•** | æ·»åŠ Securityä¾èµ–åé»˜è®¤ä¿æŠ¤æ‰€æœ‰ç«¯ç‚¹ | é…ç½®`permitAll()`æ”¾è¡Œå…¬å¼€æ¥å£ |
| **ç™»å½•åä»ç„¶403** | ç”¨æˆ·è®¤è¯æˆåŠŸä½†æ²¡æœ‰ç›¸åº”æƒé™ | æ£€æŸ¥è§’è‰²æƒé™é…ç½®ï¼Œç¡®ä¿è§’è‰²åå‰ç¼€æ­£ç¡® |
| **CSRF Tokené”™è¯¯** | å‰åç«¯åˆ†ç¦»é¡¹ç›®å¯ç”¨äº†CSRF | APIé¡¹ç›®ç¦ç”¨CSRFæˆ–æ­£ç¡®ä¼ é€’Token |
| **JWT Tokenæ— æ•ˆ** | Tokenè¿‡æœŸã€æ ¼å¼é”™è¯¯æˆ–å¯†é’¥ä¸åŒ¹é… | æ£€æŸ¥Tokenç”Ÿæˆå’Œè§£æé€»è¾‘ï¼ŒéªŒè¯å¯†é’¥ä¸€è‡´æ€§ |
| **å¯†ç éªŒè¯å¤±è´¥** | å¯†ç ç¼–ç å™¨ä¸ä¸€è‡´æˆ–æœªæ­£ç¡®åŠ å¯† | ç¡®ä¿æ³¨å†Œå’Œç™»å½•ä½¿ç”¨ç›¸åŒç¼–ç å™¨ |

**ğŸ”§ è°ƒè¯•æŠ€å·§**ï¼š

```java
// å¯ç”¨Securityè°ƒè¯•æ—¥å¿—
@EnableWebSecurity(debug = true)
public class SecurityConfig {
    // é…ç½®å†…å®¹...
}

// æˆ–åœ¨application.ymlä¸­é…ç½®
logging:
  level:
    org.springframework.security: DEBUG
    org.springframework.security.web.FilterChainProxy: DEBUG
```

**ğŸš¨ ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹**ï¼š

> âš ï¸ **ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ£€æŸ¥æ¸…å•**
> 
> - [ ] ä½¿ç”¨å¼ºå¯†ç ç¼–ç å™¨ (BCryptã€Pbkdf2ç­‰)
> - [ ] JWTå¯†é’¥è¶³å¤Ÿå¤æ‚ä¸”å®šæœŸè½®æ¢
> - [ ] æ•æ„Ÿé…ç½®ä¿¡æ¯ä¸è¦ç¡¬ç¼–ç 
> - [ ] å¯ç”¨HTTPSï¼Œç¦æ­¢HTTPä¼ è¾“
> - [ ] è®¾ç½®åˆç†çš„Sessionè¶…æ—¶æ—¶é—´
> - [ ] é…ç½®å®‰å…¨å“åº”å¤´ (HSTSã€X-Frame-Optionsç­‰)
> - [ ] å®šæœŸæ›´æ–°ä¾èµ–ç‰ˆæœ¬ï¼Œä¿®å¤å®‰å…¨æ¼æ´
> - [ ] å¯ç”¨å®‰å…¨å®¡è®¡æ—¥å¿—

**ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š

```java
// ç¼“å­˜ç”¨æˆ·è¯¦æƒ…ï¼Œé¿å…é‡å¤æ•°æ®åº“æŸ¥è¯¢
@Cacheable("users")
public UserDetails loadUserByUsername(String username) {
    // ç”¨æˆ·æŸ¥è¯¢é€»è¾‘
}

// å¼‚æ­¥å¤„ç†å®‰å…¨äº‹ä»¶
@Async
@EventListener
public void handleAuthenticationSuccess(AuthenticationSuccessEvent event) {
    // è®°å½•ç™»å½•æ—¥å¿—
}

// ä½¿ç”¨Rediså­˜å‚¨Session (åˆ†å¸ƒå¼ç¯å¢ƒ)
@Bean
public RedisIndexedSessionRepository sessionRepository() {
    return new RedisIndexedSessionRepository(redisTemplate);
}
```

### 9.6 æ‰©å±•å­¦ä¹ æ–¹å‘


**ğŸš€ è¿›é˜¶ä¸»é¢˜**ï¼š

1. **OAuth2é›†æˆ**ï¼š
   - ç¬¬ä¸‰æ–¹ç™»å½• (å¾®ä¿¡ã€QQã€GitHub)
   - æˆæƒæœåŠ¡å™¨æ­å»º
   - èµ„æºæœåŠ¡å™¨ä¿æŠ¤

2. **å¾®æœåŠ¡å®‰å…¨**ï¼š
   - Gatewayç½‘å…³è®¤è¯
   - æœåŠ¡é—´è®¤è¯æˆæƒ
   - åˆ†å¸ƒå¼Sessionç®¡ç†

3. **é«˜çº§å®‰å…¨ç‰¹æ€§**ï¼š
   - è®°ä½æˆ‘åŠŸèƒ½
   - å¹¶å‘Sessionæ§åˆ¶
   - å®‰å…¨äº‹ä»¶ç›‘å¬

4. **å®‰å…¨æµ‹è¯•**ï¼š
   - å•å…ƒæµ‹è¯•ç¼–å†™
   - å®‰å…¨æ¸—é€æµ‹è¯•
   - è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æ

**ğŸ“š æ¨èå­¦ä¹ èµ„æº**ï¼š

- **å®˜æ–¹æ–‡æ¡£**ï¼š[Spring Security Reference](https://docs.spring.io/spring-security/reference/)
- **å®æˆ˜æ•™ç¨‹**ï¼šSpring Securityå®æˆ˜é¡¹ç›®
- **å®‰å…¨ç¤¾åŒº**ï¼šOWASPå®‰å…¨æŒ‡å—
- **æœ€ä½³å®è·µ**ï¼šä¼ä¸šçº§å®‰å…¨æ¶æ„æ¡ˆä¾‹

**ğŸ¯ å­¦ä¹ æˆæœæ£€éªŒ**ï¼š

å®Œæˆä»¥ä¸‹é¡¹ç›®æ¥æ£€éªŒå­¦ä¹ æ•ˆæœï¼š
1. æ„å»ºå®Œæ•´çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
2. å®ç°åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶
3. é›†æˆJWTå®ç°APIè®¤è¯
4. é…ç½®CSRFé˜²æŠ¤å’Œå®‰å…¨å“åº”å¤´
5. ç¼–å†™å®‰å…¨ç›¸å…³çš„å•å…ƒæµ‹è¯•

é€šè¿‡è¿™ä»½ç¬”è®°çš„å­¦ä¹ ï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- ç†è§£Spring Securityçš„æ ¸å¿ƒæ¦‚å¿µå’Œå·¥ä½œåŸç†
- åœ¨å®é™…é¡¹ç›®ä¸­æ­£ç¡®é…ç½®å®‰å…¨è®¤è¯å’Œæˆæƒ
- å¤„ç†å¸¸è§çš„å®‰å…¨é—®é¢˜å’Œæ”»å‡»é˜²æŠ¤
- æ ¹æ®ä¸åŒåœºæ™¯é€‰æ‹©åˆé€‚çš„å®‰å…¨ç­–ç•¥
- ä¸ºä¼ä¸šçº§åº”ç”¨è®¾è®¡å®Œæ•´çš„å®‰å…¨è§£å†³æ–¹æ¡ˆ