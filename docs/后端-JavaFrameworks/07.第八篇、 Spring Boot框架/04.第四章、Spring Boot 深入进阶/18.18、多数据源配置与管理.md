---
title: 18ã€å¤šæ•°æ®æºé…ç½®ä¸ç®¡ç†
---
## ğŸ“š ç›®å½•


1. [å¤šæ•°æ®æºæ¦‚å¿µç†è§£](#1-å¤šæ•°æ®æºæ¦‚å¿µç†è§£)
2. [åŸºç¡€é…ç½®å®ç°](#2-åŸºç¡€é…ç½®å®ç°)
3. [ä¸»æ•°æ®æºæ ‡è¯†](#3-ä¸»æ•°æ®æºæ ‡è¯†)
4. [æ•°æ®æºè·¯ç”±ç­–ç•¥](#4-æ•°æ®æºè·¯ç”±ç­–ç•¥)
5. [äº‹åŠ¡ç®¡ç†å™¨é…ç½®](#5-äº‹åŠ¡ç®¡ç†å™¨é…ç½®)
6. [è¯»å†™åˆ†ç¦»å®ç°](#6-è¯»å†™åˆ†ç¦»å®ç°)
7. [åˆ†åº“åˆ†è¡¨æ”¯æŒ](#7-åˆ†åº“åˆ†è¡¨æ”¯æŒ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

# 1. ğŸŒ å¤šæ•°æ®æºæ¦‚å¿µç†è§£



## 1.1 ä»€ä¹ˆæ˜¯å¤šæ•°æ®æº



**ğŸ”¸ ç”Ÿæ´»ä¸­çš„ç±»æ¯”**

æƒ³è±¡ä½ æ˜¯ä¸€ä¸ªå›¾ä¹¦ç®¡ç†å‘˜ï¼Œä½ éœ€è¦ç®¡ç†ä¸åŒçš„ä¹¦åº“ï¼š
- **ä¸»ä¹¦åº“**ï¼šå­˜æ”¾æ—¥å¸¸å›¾ä¹¦ï¼Œä½¿ç”¨é¢‘ç‡æœ€é«˜
- **å¤ç±åº“**ï¼šå­˜æ”¾çè´µå¤ç±ï¼Œè®¿é—®è¾ƒå°‘ä½†å¾ˆé‡è¦
- **æœŸåˆŠåº“**ï¼šå­˜æ”¾æ‚å¿—æœŸåˆŠï¼Œæ›´æ–°é¢‘ç¹

åœ¨Spring Bootä¸­ï¼Œå¤šæ•°æ®æºå°±åƒç®¡ç†è¿™äº›ä¸åŒçš„ä¹¦åº“ä¸€æ ·ï¼š

```
ä¼ ç»Ÿå•æ•°æ®æºï¼šåªæœ‰ä¸€ä¸ªæ•°æ®åº“è¿æ¥
      åº”ç”¨ç¨‹åº â”€â”€â”€â”€â–º æ•°æ®åº“

å¤šæ•°æ®æºé…ç½®ï¼šè¿æ¥å¤šä¸ªæ•°æ®åº“
      åº”ç”¨ç¨‹åº â”€â”€â”€â”€â–º ä¸»æ•°æ®åº“(ç”¨æˆ·æ•°æ®)
             â”œâ”€â”€â–º ä»æ•°æ®åº“(æ—¥å¿—æ•°æ®) 
             â””â”€â”€â–º ç¼“å­˜æ•°æ®åº“(ä¸´æ—¶æ•°æ®)
```

## 1.2 ä¸ºä»€ä¹ˆéœ€è¦å¤šæ•°æ®æº



**ğŸ”¸ å®é™…ä¸šåŠ¡éœ€æ±‚**

| ä½¿ç”¨åœºæ™¯ | **å…·ä½“è¯´æ˜** | **ä¸¾ä¾‹è¯´æ˜** |
|---------|------------|-------------|
| ğŸ”¸ **ä¸šåŠ¡åˆ†ç¦»** | `ä¸åŒä¸šåŠ¡ä½¿ç”¨ä¸åŒæ•°æ®åº“` | `ç”¨æˆ·æ•°æ®åº“ + å•†å“æ•°æ®åº“` |
| ğŸ”¸ **è¯»å†™åˆ†ç¦»** | `å†™æ“ä½œå’Œè¯»æ“ä½œåˆ†å¼€` | `ä¸»åº“å†™å…¥ï¼Œä»åº“æŸ¥è¯¢` |
| ğŸ”¸ **æ€§èƒ½ä¼˜åŒ–** | `åˆ†æ•£æ•°æ®åº“å‹åŠ›` | `çƒ­æ•°æ®å¿«åº“ï¼Œå†·æ•°æ®æ…¢åº“` |
| ğŸ”¸ **å†å²å…¼å®¹** | `æ–°æ—§ç³»ç»Ÿæ•°æ®åº“å…±å­˜` | `æ–°ä¸šåŠ¡MySQL + è€ä¸šåŠ¡Oracle` |

**ğŸ”¸ æ ¸å¿ƒä¼˜åŠ¿**

- **æ€§èƒ½æå‡**ï¼šåˆ†æ•£æ•°æ®åº“è´Ÿè½½ï¼Œæé«˜å“åº”é€Ÿåº¦
- **ä¸šåŠ¡éš”ç¦»**ï¼šä¸åŒæ¨¡å—ä½¿ç”¨ç‹¬ç«‹æ•°æ®æºï¼Œé™ä½è€¦åˆ
- **çµæ´»æ‰©å±•**ï¼šå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ–°çš„æ•°æ®æº
- **é£é™©åˆ†æ•£**ï¼šå•ä¸ªæ•°æ®åº“æ•…éšœä¸å½±å“å…¨éƒ¨ä¸šåŠ¡

---

# 2. âš™ï¸ åŸºç¡€é…ç½®å®ç°



## 2.1 é…ç½®æ–‡ä»¶å‡†å¤‡



**ğŸ”¸ application.yml å¤šæ•°æ®æºé…ç½®**

```yaml
spring:
  datasource:
#    # ä¸»æ•°æ®æº - ç”¨æˆ·ä¸šåŠ¡
    primary:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/user_db?useSSL=false
      username: root
      password: 123456
      
#    # ä»æ•°æ®æº - è®¢å•ä¸šåŠ¡  
    secondary:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/order_db?useSSL=false
      username: root
      password: 123456
```

> ğŸ’¡ **é…ç½®è¯´æ˜**  
> è¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªæ•°æ®æºï¼šprimary(ä¸»è¦çš„)ç”¨äºç”¨æˆ·æ•°æ®ï¼Œsecondary(æ¬¡è¦çš„)ç”¨äºè®¢å•æ•°æ®ã€‚å°±åƒæŠŠç”¨æˆ·ä¿¡æ¯å’Œè®¢å•ä¿¡æ¯åˆ†åˆ«å­˜åœ¨ä¸åŒçš„æ–‡ä»¶æŸœé‡Œã€‚

## 2.2 æ•°æ®æºBeané…ç½®ç±»



**ğŸ”¸ æ ¸å¿ƒé…ç½®ç±»ç¼–å†™**

```java
@Configuration
public class DataSourceConfig {
    
    // åˆ›å»ºä¸»æ•°æ®æº
    @Bean(name = "primaryDataSource")
    @ConfigurationProperties(prefix = "spring.datasource.primary")
    public DataSource primaryDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    // åˆ›å»ºä»æ•°æ®æº
    @Bean(name = "secondaryDataSource") 
    @ConfigurationProperties(prefix = "spring.datasource.secondary")
    public DataSource secondaryDataSource() {
        return DataSourceBuilder.create().build();
    }
}
```

**ğŸ”¸ é…ç½®è§£é‡Š**

- `@ConfigurationProperties`ï¼šå‘Šè¯‰Springä»é…ç½®æ–‡ä»¶çš„æŒ‡å®šä½ç½®è¯»å–æ•°æ®æºä¿¡æ¯
- `DataSourceBuilder.create().build()`ï¼šSpringæä¾›çš„æ•°æ®æºæ„å»ºå™¨ï¼Œè‡ªåŠ¨åˆ›å»ºæ•°æ®æºå¯¹è±¡
- `@Bean(name = "xxx")`ï¼šä¸ºæ¯ä¸ªæ•°æ®æºèµ·ä¸ªåå­—ï¼Œæ–¹ä¾¿åé¢å¼•ç”¨

## 2.3 MyBatisé…ç½®æ•´åˆ



**ğŸ”¸ ä¸»æ•°æ®æºMyBatisé…ç½®**

```java
@Configuration
@MapperScan(basePackages = "com.example.mapper.user", 
           sqlSessionFactoryRef = "primarySqlSessionFactory")
public class PrimaryDataSourceConfig {
    
    @Bean(name = "primarySqlSessionFactory")
    public SqlSessionFactory primarySqlSessionFactory(
            @Qualifier("primaryDataSource") DataSource dataSource) throws Exception {
        
        SqlSessionFactoryBean bean = new SqlSessionFactoryBean();
        bean.setDataSource(dataSource);
        // æŒ‡å®šmapper xmlæ–‡ä»¶ä½ç½®
        bean.setMapperLocations(
            new PathMatchingResourcePatternResolver()
                .getResources("classpath:mapper/user/*.xml"));
        return bean.getObject();
    }
}
```

> ğŸ¤” **æ–°æ‰‹ç–‘é—®**  
> **é—®**ï¼šä¸ºä»€ä¹ˆè¦åˆ†åˆ«é…ç½®SqlSessionFactoryï¼Ÿ  
> **ç­”**ï¼šå°±åƒæ¯ä¸ªå›¾ä¹¦é¦†éƒ½éœ€è¦è‡ªå·±çš„ç®¡ç†å‘˜ä¸€æ ·ï¼Œæ¯ä¸ªæ•°æ®æºéƒ½éœ€è¦è‡ªå·±çš„"ç®¡ç†å‘˜"(SqlSessionFactory)æ¥å¤„ç†æ•°æ®åº“æ“ä½œã€‚

---

# 3. ğŸ¯ ä¸»æ•°æ®æºæ ‡è¯†



## 3.1 @Primaryæ³¨è§£çš„ä½œç”¨



**ğŸ”¸ ä»€ä¹ˆæ˜¯@Primary**

```java
@Bean(name = "primaryDataSource")
@Primary  // è¿™ä¸ªæ³¨è§£å¾ˆé‡è¦ï¼
@ConfigurationProperties(prefix = "spring.datasource.primary")
public DataSource primaryDataSource() {
    return DataSourceBuilder.create().build();
}
```

**ğŸ”¸ é€šä¿—ç†è§£@Primary**

æƒ³è±¡ä½ å®¶é‡Œæœ‰å¤šä¸ªé¥æ§å™¨ï¼š
- ç”µè§†é¥æ§å™¨ (ä¸»è¦çš„ï¼Œç”¨å¾—æœ€å¤š)
- ç©ºè°ƒé¥æ§å™¨
- éŸ³å“é¥æ§å™¨

å½“ä½ è¯´"æ‹¿é¥æ§å™¨æ¥"ï¼Œå®¶äººä¼šé»˜è®¤ç»™ä½ ç”µè§†é¥æ§å™¨ï¼Œå› ä¸ºå®ƒæ˜¯"ä¸»è¦çš„"ã€‚

`@Primary`å°±æ˜¯å‘Šè¯‰Springï¼š"å½“ä¸ç¡®å®šç”¨å“ªä¸ªæ•°æ®æºæ—¶ï¼Œé»˜è®¤ç”¨è¿™ä¸ªï¼"

## 3.2 ä¸»æ•°æ®æºçš„ä½¿ç”¨åœºæ™¯



**ğŸ”¸ è‡ªåŠ¨é€‰æ‹©ç¤ºä¾‹**

```java
@Service
public class UserService {
    
    @Autowired
    private DataSource dataSource;  // è‡ªåŠ¨æ³¨å…¥ä¸»æ•°æ®æº
    
    // Springä¼šè‡ªåŠ¨é€‰æ‹©å¸¦@Primaryçš„æ•°æ®æº
    public void saveUser(User user) {
        // è¿™é‡Œä¼šä½¿ç”¨ä¸»æ•°æ®æº
    }
}
```

**ğŸ”¸ æ˜ç¡®æŒ‡å®šæ•°æ®æº**

```java
@Service  
public class OrderService {
    
    @Autowired
    @Qualifier("secondaryDataSource")  // æ˜ç¡®æŒ‡å®šä½¿ç”¨ä»æ•°æ®æº
    private DataSource orderDataSource;
    
    public void saveOrder(Order order) {
        // è¿™é‡Œä¼šä½¿ç”¨ä»æ•°æ®æº
    }
}
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**  
> åœ¨å¤šæ•°æ®æºç¯å¢ƒä¸­ï¼Œå»ºè®®æ€»æ˜¯æ˜ç¡®æŒ‡å®šè¦ä½¿ç”¨çš„æ•°æ®æºï¼Œé¿å…æ··ä¹±ã€‚å°±åƒåœ¨å¤šä¸ªæ–‡ä»¶æŸœå‰ï¼Œæœ€å¥½æ˜ç¡®è¯´å‡ºè¦æ‰“å¼€å“ªä¸ªæŸœå­ã€‚

---

# 4. ğŸ”„ æ•°æ®æºè·¯ç”±ç­–ç•¥



## 4.1 åŠ¨æ€æ•°æ®æºè·¯ç”±åŸç†



**ğŸ”¸ è·¯ç”±æ¦‚å¿µç†è§£**

è·¯ç”±å°±åƒæ™ºèƒ½å¯¼èˆªç³»ç»Ÿï¼š
- æ ¹æ®ç›®çš„åœ°(ä¸šåŠ¡ç±»å‹)é€‰æ‹©æœ€ä½³è·¯çº¿(æ•°æ®æº)
- è‡ªåŠ¨åˆ‡æ¢ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥

```
è¯·æ±‚è¿›æ¥ â†’ åˆ¤æ–­ä¸šåŠ¡ç±»å‹ â†’ é€‰æ‹©å¯¹åº”æ•°æ®æº â†’ æ‰§è¡Œæ“ä½œ

ç”¨æˆ·æŸ¥è¯¢ â”€â”€â”€â”€â–º è·¯ç”±åˆ¤æ–­ â”€â”€â”€â”€â–º é€‰æ‹©ç”¨æˆ·æ•°æ®åº“
è®¢å•æŸ¥è¯¢ â”€â”€â”€â”€â–º è·¯ç”±åˆ¤æ–­ â”€â”€â”€â”€â–º é€‰æ‹©è®¢å•æ•°æ®åº“
```

## 4.2 åŠ¨æ€æ•°æ®æºå®ç°



**ğŸ”¸ è‡ªå®šä¹‰è·¯ç”±æ•°æ®æº**

```java
public class DynamicDataSource extends AbstractRoutingDataSource {
    
    @Override
    protected Object determineCurrentLookupKey() {
        // è¿”å›å½“å‰çº¿ç¨‹åº”è¯¥ä½¿ç”¨çš„æ•°æ®æºæ ‡è¯†
        return DataSourceContextHolder.getDataSourceKey();
    }
}
```

**ğŸ”¸ æ•°æ®æºä¸Šä¸‹æ–‡ç®¡ç†**

```java
public class DataSourceContextHolder {
    
    private static final ThreadLocal<String> CONTEXT_HOLDER = 
            new ThreadLocal<>();
    
    // è®¾ç½®å½“å‰çº¿ç¨‹ä½¿ç”¨çš„æ•°æ®æº
    public static void setDataSourceKey(String key) {
        CONTEXT_HOLDER.set(key);
    }
    
    // è·å–å½“å‰çº¿ç¨‹çš„æ•°æ®æºæ ‡è¯†
    public static String getDataSourceKey() {
        return CONTEXT_HOLDER.get();
    }
    
    // æ¸…é™¤æ•°æ®æºè®¾ç½®
    public static void clearDataSourceKey() {
        CONTEXT_HOLDER.remove();
    }
}
```

## 4.3 æ³¨è§£å¼æ•°æ®æºåˆ‡æ¢



**ğŸ”¸ è‡ªå®šä¹‰æ•°æ®æºåˆ‡æ¢æ³¨è§£**

```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface DataSource {
    String value() default "primary";  // é»˜è®¤ä½¿ç”¨ä¸»æ•°æ®æº
}
```

**ğŸ”¸ AOPåˆ‡é¢å®ç°è‡ªåŠ¨åˆ‡æ¢**

```java
@Aspect
@Component
public class DataSourceAspect {
    
    @Around("@annotation(dataSource)")
    public Object switchDataSource(ProceedingJoinPoint point, 
                                  DataSource dataSource) throws Throwable {
        try {
            // åˆ‡æ¢åˆ°æŒ‡å®šæ•°æ®æº
            DataSourceContextHolder.setDataSourceKey(dataSource.value());
            
            // æ‰§è¡Œç›®æ ‡æ–¹æ³•
            return point.proceed();
            
        } finally {
            // æ¸…ç†æ•°æ®æºè®¾ç½®
            DataSourceContextHolder.clearDataSourceKey();
        }
    }
}
```

**ğŸ”¸ ä½¿ç”¨ç¤ºä¾‹**

```java
@Service
public class BusinessService {
    
    @DataSource("primary")
    public void saveUser(User user) {
        // è‡ªåŠ¨ä½¿ç”¨ä¸»æ•°æ®æº
    }
    
    @DataSource("secondary") 
    public void saveOrder(Order order) {
        // è‡ªåŠ¨ä½¿ç”¨ä»æ•°æ®æº
    }
}
```

---

# 5. ğŸ“Š äº‹åŠ¡ç®¡ç†å™¨é…ç½®



## 5.1 ä¸ºä»€ä¹ˆéœ€è¦å¤šä¸ªäº‹åŠ¡ç®¡ç†å™¨



**ğŸ”¸ äº‹åŠ¡ç®¡ç†å™¨çš„ä½œç”¨**

äº‹åŠ¡ç®¡ç†å™¨å°±åƒé“¶è¡Œçš„è½¬è´¦ç³»ç»Ÿï¼š
- **ä¿è¯æ“ä½œçš„å®Œæ•´æ€§**ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- **ç®¡ç†ä¸åŒè´¦æˆ·**ï¼šä¸åŒæ•°æ®æºéœ€è¦ä¸åŒçš„"è´¦æˆ·ç®¡ç†å‘˜"

```
å•æ•°æ®æºäº‹åŠ¡ï¼š
å¼€å§‹äº‹åŠ¡ â†’ æ“ä½œæ•°æ®åº“ â†’ æäº¤/å›æ»š

å¤šæ•°æ®æºäº‹åŠ¡ï¼š
å¼€å§‹äº‹åŠ¡A â†’ æ“ä½œæ•°æ®åº“A â†’ æäº¤A
å¼€å§‹äº‹åŠ¡B â†’ æ“ä½œæ•°æ®åº“B â†’ æäº¤B
```

## 5.2 äº‹åŠ¡ç®¡ç†å™¨é…ç½®



**ğŸ”¸ ä¸ºæ¯ä¸ªæ•°æ®æºé…ç½®äº‹åŠ¡ç®¡ç†å™¨**

```java
@Configuration
public class TransactionConfig {
    
    // ä¸»æ•°æ®æºäº‹åŠ¡ç®¡ç†å™¨
    @Bean(name = "primaryTransactionManager")
    @Primary
    public PlatformTransactionManager primaryTransactionManager(
            @Qualifier("primaryDataSource") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
    
    // ä»æ•°æ®æºäº‹åŠ¡ç®¡ç†å™¨
    @Bean(name = "secondaryTransactionManager")
    public PlatformTransactionManager secondaryTransactionManager(
            @Qualifier("secondaryDataSource") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

## 5.3 äº‹åŠ¡ç®¡ç†å™¨ä½¿ç”¨



**ğŸ”¸ æŒ‡å®šä½¿ç”¨ç‰¹å®šäº‹åŠ¡ç®¡ç†å™¨**

```java
@Service
public class UserService {
    
    @Transactional(transactionManager = "primaryTransactionManager")
    public void saveUserWithTransaction(User user) {
        // ä½¿ç”¨ä¸»æ•°æ®æºçš„äº‹åŠ¡ç®¡ç†å™¨
        userMapper.insert(user);
        
        // å¦‚æœè¿™é‡Œå‡ºé”™ï¼Œä¼šè‡ªåŠ¨å›æ»š
        if (user.getAge() < 0) {
            throw new RuntimeException("å¹´é¾„ä¸èƒ½ä¸ºè´Ÿæ•°");
        }
    }
}
```

**ğŸ”¸ è·¨æ•°æ®æºäº‹åŠ¡é—®é¢˜**

> âš ï¸ **é‡è¦æé†’**  
> é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸åŒæ•°æ®æºçš„äº‹åŠ¡æ˜¯ç‹¬ç«‹çš„ï¼Œæ— æ³•ä¿è¯è·¨æ•°æ®æºæ“ä½œçš„ä¸€è‡´æ€§ã€‚å¦‚æœéœ€è¦è·¨æ•°æ®æºäº‹åŠ¡ï¼Œéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚

---

# 6. ğŸ”€ è¯»å†™åˆ†ç¦»å®ç°



## 6.1 è¯»å†™åˆ†ç¦»åŸºæœ¬åŸç†



**ğŸ”¸ è¯»å†™åˆ†ç¦»æ¦‚å¿µ**

è¯»å†™åˆ†ç¦»å°±åƒå¤§å‹å›¾ä¹¦é¦†çš„ç®¡ç†æ–¹å¼ï¼š
- **å†™æ“ä½œ(å€Ÿä¹¦ã€è¿˜ä¹¦)**ï¼šåœ¨æ€»å°åŠç†ï¼Œæ•°æ®å‡†ç¡®åŠæ—¶
- **è¯»æ“ä½œ(æŸ¥é˜…èµ„æ–™)**ï¼šåœ¨å„ä¸ªé˜…è§ˆå®¤è¿›è¡Œï¼Œåˆ†æ•£å‹åŠ›

```
æ•°æ®åº“è¯»å†™åˆ†ç¦»æ¶æ„ï¼š
              åº”ç”¨ç¨‹åº
               /    \
         å†™æ“ä½œ/      \è¯»æ“ä½œ  
            /        \
       ä¸»æ•°æ®åº“      ä»æ•°æ®åº“
    (Master)      (Slave)
         |           â†‘
         â””â”€ æ•°æ®åŒæ­¥ â”€â”€â”˜
```

## 6.2 è¯»å†™åˆ†ç¦»é…ç½®å®ç°



**ğŸ”¸ æ•°æ®æºé…ç½®**

```yaml
spring:
  datasource:
#    # å†™åº“é…ç½®
    master:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://192.168.1.100:3306/app_db
      username: root
      password: 123456
      
#    # è¯»åº“é…ç½®
    slave:
      driver-class-name: com.mysql.cj.jdbc.Driver  
      url: jdbc:mysql://192.168.1.101:3306/app_db
      username: readonly_user
      password: 123456
```

**ğŸ”¸ è¯»å†™åˆ†ç¦»è·¯ç”±å®ç°**

```java
public class ReadWriteSplitDataSource extends AbstractRoutingDataSource {
    
    @Override
    protected Object determineCurrentLookupKey() {
        // æ ¹æ®å½“å‰æ“ä½œç±»å‹é€‰æ‹©æ•°æ®æº
        return DataSourceContextHolder.isReadOperation() ? "slave" : "master";
    }
}
```

**ğŸ”¸ è‡ªåŠ¨è¯†åˆ«è¯»å†™æ“ä½œ**

```java
@Aspect
@Component
public class ReadWriteSplitAspect {
    
    // åŒ¹é…æ‰€æœ‰æŸ¥è¯¢æ–¹æ³•
    @Before("execution(* com.example.service.*.find*(..)) || " +
            "execution(* com.example.service.*.get*(..)) || " +
            "execution(* com.example.service.*.query*(..))")
    public void setReadDataSource() {
        DataSourceContextHolder.setReadOperation(true);
    }
    
    // åŒ¹é…æ‰€æœ‰å†™æ“ä½œæ–¹æ³•
    @Before("execution(* com.example.service.*.save*(..)) || " +
            "execution(* com.example.service.*.update*(..)) || " +
            "execution(* com.example.service.*.delete*(..))")
    public void setWriteDataSource() {
        DataSourceContextHolder.setReadOperation(false);
    }
}
```

## 6.3 è¯»å†™åˆ†ç¦»æ³¨æ„äº‹é¡¹



**ğŸ”¸ æ•°æ®åŒæ­¥å»¶è¿Ÿ**

```java
@Service
public class UserService {
    
    public void updateUserAndQuery(Long userId, String newName) {
        // 1. å†™æ“ä½œï¼šæ›´æ–°ç”¨æˆ·å
        userMapper.updateUserName(userId, newName);
        
        // 2. ç«‹å³æŸ¥è¯¢å¯èƒ½è¯»ä¸åˆ°æœ€æ–°æ•°æ®(ä¸»ä»åŒæ­¥å»¶è¿Ÿ)
        User user = userMapper.findById(userId);  // å¯èƒ½è¿˜æ˜¯æ—§æ•°æ®
        
        // è§£å†³æ–¹æ¡ˆï¼šå¼ºåˆ¶ä½¿ç”¨ä¸»åº“æŸ¥è¯¢
        DataSourceContextHolder.setReadOperation(false);
        User latestUser = userMapper.findById(userId);  // è¯»å–æœ€æ–°æ•°æ®
    }
}
```

> ğŸ’¡ **å®ç”¨æŠ€å·§**  
> å¯¹äºå†™æ“ä½œåç«‹å³éœ€è¦è¯»å–çš„åœºæ™¯ï¼Œå¯ä»¥çŸ­æ—¶é—´å†…å¼ºåˆ¶ä½¿ç”¨ä¸»åº“ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚

---

# 7. ğŸ“ åˆ†åº“åˆ†è¡¨æ”¯æŒ



## 7.1 åˆ†åº“åˆ†è¡¨æ¦‚å¿µç†è§£



**ğŸ”¸ ä»€ä¹ˆæ˜¯åˆ†åº“åˆ†è¡¨**

æƒ³è±¡ä¸€ä¸ªå·¨å¤§çš„å›¾ä¹¦é¦†ï¼š
- **åˆ†åº“**ï¼šæŠŠå›¾ä¹¦åˆ†æ•£åˆ°ä¸åŒçš„å›¾ä¹¦é¦†å»ºç­‘
- **åˆ†è¡¨**ï¼šæŠŠæ¯ä¸ªå»ºç­‘å†…çš„å›¾ä¹¦æŒ‰ç±»åˆ«åˆ†åˆ°ä¸åŒæ¥¼å±‚

```
ä¼ ç»Ÿå•åº“å•è¡¨ï¼š
æ‰€æœ‰æ•°æ® â†’ ä¸€ä¸ªæ•°æ®åº“ â†’ ä¸€ä¸ªè¡¨

åˆ†åº“åˆ†è¡¨åï¼š
ç”¨æˆ·æ•°æ® â†’ ç”¨æˆ·åº“1 â†’ user_table_1, user_table_2
       â†’ ç”¨æˆ·åº“2 â†’ user_table_3, user_table_4
è®¢å•æ•°æ® â†’ è®¢å•åº“1 â†’ order_table_1, order_table_2  
       â†’ è®¢å•åº“2 â†’ order_table_3, order_table_4
```

## 7.2 åˆ†åº“åˆ†è¡¨è§„åˆ™é…ç½®



**ğŸ”¸ åŸºäºç”¨æˆ·IDçš„åˆ†åº“åˆ†è¡¨ç­–ç•¥**

```java
@Component
public class ShardingStrategy {
    
    // åˆ†åº“è§„åˆ™ï¼šæ ¹æ®ç”¨æˆ·IDåˆ†åˆ°ä¸åŒæ•°æ®åº“
    public String determineDatabase(Long userId) {
        // ç”¨æˆ·IDå¯¹2å–æ¨¡ï¼Œåˆ†åˆ°2ä¸ªåº“
        int dbIndex = (int)(userId % 2);
        return "datasource_" + dbIndex;
    }
    
    // åˆ†è¡¨è§„åˆ™ï¼šæ ¹æ®ç”¨æˆ·IDåˆ†åˆ°ä¸åŒè¡¨
    public String determineTable(Long userId) {
        // ç”¨æˆ·IDå¯¹4å–æ¨¡ï¼Œæ¯ä¸ªåº“åˆ†4å¼ è¡¨
        int tableIndex = (int)(userId % 4);
        return "user_" + tableIndex;
    }
}
```

## 7.3 ShardingSphereé›†æˆ



**ğŸ”¸ ShardingSphereé…ç½®**

```yaml
spring:
  shardingsphere:
    datasource:
      names: ds0,ds1
      ds0:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        jdbc-url: jdbc:mysql://localhost:3306/demo_ds_0
      ds1:
        type: com.zaxxer.hikari.HikariDataSource  
        driver-class-name: com.mysql.cj.jdbc.Driver
        jdbc-url: jdbc:mysql://localhost:3306/demo_ds_1
        
    sharding:
      tables:
        t_user:
          actual-data-nodes: ds$->{0..1}.t_user_$->{0..1}
          database-strategy:
            inline:
              sharding-column: user_id
              algorithm-expression: ds$->{user_id % 2}
          table-strategy:
            inline:
              sharding-column: user_id
              algorithm-expression: t_user_$->{user_id % 2}
```

**ğŸ”¸ ä¸šåŠ¡ä»£ç ä½¿ç”¨**

```java
@Service
public class UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    // ä¸šåŠ¡ä»£ç ä¸éœ€è¦å…³å¿ƒåˆ†åº“åˆ†è¡¨é€»è¾‘
    public void saveUser(User user) {
        // ShardingSphereè‡ªåŠ¨æ ¹æ®user_idè·¯ç”±åˆ°å¯¹åº”åº“è¡¨
        userMapper.insert(user);
    }
    
    public User findUser(Long userId) {
        // è‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”åº“è¡¨æŸ¥è¯¢
        return userMapper.selectById(userId);
    }
}
```

> ğŸš€ **æ¡†æ¶ä¼˜åŠ¿**  
> ä½¿ç”¨ShardingSphereç­‰åˆ†åº“åˆ†è¡¨æ¡†æ¶ï¼Œä¸šåŠ¡ä»£ç å‡ ä¹ä¸éœ€è¦ä¿®æ”¹ï¼Œæ¡†æ¶è‡ªåŠ¨å¤„ç†è·¯ç”±é€»è¾‘ï¼Œå¤§å¤§é™ä½äº†å¼€å‘å¤æ‚åº¦ã€‚

---

# 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



## 8.1 å¤šæ•°æ®æºé…ç½®æ ¸å¿ƒçŸ¥è¯†



**ğŸ”¸ å¿…é¡»æŒæ¡çš„æ¦‚å¿µ**
```
ğŸ¯ å¤šæ•°æ®æºï¼šä¸€ä¸ªåº”ç”¨è¿æ¥å¤šä¸ªæ•°æ®åº“
ğŸ¯ @Primaryï¼šæ ‡è¯†ä¸»æ•°æ®æºï¼ŒSpringé»˜è®¤é€‰æ‹©
ğŸ¯ æ•°æ®æºè·¯ç”±ï¼šæ ¹æ®ä¸šåŠ¡é€»è¾‘åŠ¨æ€é€‰æ‹©æ•°æ®æº  
ğŸ¯ äº‹åŠ¡ç®¡ç†ï¼šæ¯ä¸ªæ•°æ®æºéœ€è¦ç‹¬ç«‹çš„äº‹åŠ¡ç®¡ç†å™¨
ğŸ¯ è¯»å†™åˆ†ç¦»ï¼šå†™ä¸»åº“ï¼Œè¯»ä»åº“ï¼Œæé«˜æ€§èƒ½
ğŸ¯ åˆ†åº“åˆ†è¡¨ï¼šæ•°æ®æ°´å¹³æ‹†åˆ†ï¼Œè§£å†³å•è¡¨ç“¶é¢ˆ
```

## 8.2 å®é™…åº”ç”¨åœºæ™¯



| åº”ç”¨åœºæ™¯ | **æŠ€æœ¯é€‰æ‹©** | **æ ¸å¿ƒè¦ç‚¹** | **æ³¨æ„äº‹é¡¹** |
|---------|------------|-------------|-------------|
| ğŸ”¸ **ä¸šåŠ¡æ•°æ®åˆ†ç¦»** | `å¤šæ•°æ®æºBeané…ç½®` | `ä¸åŒä¸šåŠ¡ç”¨ä¸åŒåº“` | `äº‹åŠ¡è¾¹ç•Œæ¸…æ™°` |
| ğŸ”¸ **è¯»å†™åˆ†ç¦»** | `åŠ¨æ€æ•°æ®æºè·¯ç”±` | `è¯»å†™æ“ä½œè‡ªåŠ¨è¯†åˆ«` | `ä¸»ä»åŒæ­¥å»¶è¿Ÿ` |
| ğŸ”¸ **å¤§æ•°æ®é‡å¤„ç†** | `åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶` | `æ°´å¹³æ‹†åˆ†ç­–ç•¥` | `è·¨åº“æŸ¥è¯¢å¤æ‚` |
| ğŸ”¸ **å¾®æœåŠ¡æ¶æ„** | `ç‹¬ç«‹æ•°æ®æºé…ç½®` | `æœåŠ¡é—´æ•°æ®éš”ç¦»` | `åˆ†å¸ƒå¼äº‹åŠ¡` |

## 8.3 æœ€ä½³å®è·µå»ºè®®



**ğŸ”¸ é…ç½®ç®¡ç†**
- ç»Ÿä¸€é…ç½®æ–‡ä»¶ç®¡ç†ï¼Œä¾¿äºç¯å¢ƒåˆ‡æ¢
- æ•°æ®æºè¿æ¥æ± å‚æ•°åˆç†è®¾ç½®
- æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨

**ğŸ”¸ æ€§èƒ½ä¼˜åŒ–**
- åˆç†è®¾ç½®è¿æ¥æ± å¤§å°
- è¯»å†™åˆ†ç¦»é™ä½ä¸»åº“å‹åŠ›
- ç¼“å­˜çƒ­ç‚¹æ•°æ®å‡å°‘æ•°æ®åº“è®¿é—®

**ğŸ”¸ ç›‘æ§è¿ç»´**
- ç›‘æ§å„æ•°æ®æºè¿æ¥çŠ¶æ€
- å®šæœŸæ£€æŸ¥æ•°æ®åŒæ­¥çŠ¶æ€
- å»ºç«‹æ•°æ®æºæ•…éšœåˆ‡æ¢æœºåˆ¶

## 8.4 å­¦ä¹ è¿›é˜¶è·¯çº¿



```
åŸºç¡€é…ç½® â”€â”€â–¶ åŠ¨æ€è·¯ç”± â”€â”€â–¶ äº‹åŠ¡ç®¡ç† â”€â”€â–¶ è¯»å†™åˆ†ç¦» â”€â”€â–¶ åˆ†åº“åˆ†è¡¨
    â”‚           â”‚          â”‚          â”‚          â”‚
    â–¼           â–¼          â–¼          â–¼          â–¼
 å…¥é—¨é˜¶æ®µ    è¿›é˜¶é˜¶æ®µ    æå‡é˜¶æ®µ    ä¼˜åŒ–é˜¶æ®µ    é«˜çº§é˜¶æ®µ
```

**ğŸ”¹ å­¦ä¹ å»ºè®®**
1. **å…ˆç†è§£æ¦‚å¿µ**ï¼šæ˜ç™½ä¸ºä»€ä¹ˆéœ€è¦å¤šæ•°æ®æº
2. **åŠ¨æ‰‹å®è·µ**ï¼šä»ç®€å•çš„åŒæ•°æ®æºé…ç½®å¼€å§‹
3. **é€æ­¥æ·±å…¥**ï¼šæŒæ¡åŠ¨æ€è·¯ç”±å’Œäº‹åŠ¡ç®¡ç†
4. **ç»“åˆå®é™…**ï¼šåœ¨çœŸå®é¡¹ç›®ä¸­åº”ç”¨è¯»å†™åˆ†ç¦»
5. **æŒç»­ä¼˜åŒ–**ï¼šå­¦ä¹ åˆ†åº“åˆ†è¡¨ç­‰é«˜çº§ç‰¹æ€§

> ğŸ¯ **æ ¸å¿ƒè®°å¿†**  
> å¤šæ•°æ®æºå°±åƒç®¡ç†å¤šä¸ªä»“åº“ï¼Œæ¯ä¸ªä»“åº“æœ‰è‡ªå·±çš„ç®¡ç†å‘˜(äº‹åŠ¡ç®¡ç†å™¨)ï¼Œæ ¹æ®ä¸åŒéœ€æ±‚(è·¯ç”±ç­–ç•¥)é€‰æ‹©åˆé€‚çš„ä»“åº“ï¼Œæœ€ç»ˆç›®çš„æ˜¯æé«˜ç³»ç»Ÿæ€§èƒ½å’Œæ‰©å±•æ€§ã€‚

**ğŸ§  è®°å¿†å£è¯€**: 
```
å¤šæºé…ç½®æœ‰ç­–ç•¥ï¼Œä¸»ä»æ ‡è¯†è¦æ¸…æ™°
è·¯ç”±åˆ‡æ¢è¦çµæ´»ï¼Œäº‹åŠ¡ç®¡ç†å„è‡ªç«‹  
è¯»å†™åˆ†ç¦»ææ€§èƒ½ï¼Œåˆ†åº“åˆ†è¡¨è§£å‹åŠ›
```