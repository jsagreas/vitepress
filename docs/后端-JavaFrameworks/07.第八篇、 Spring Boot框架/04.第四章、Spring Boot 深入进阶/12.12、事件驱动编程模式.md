---
title: 12ã€äº‹ä»¶é©±åŠ¨ç¼–ç¨‹æ¨¡å¼
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯äº‹ä»¶é©±åŠ¨ç¼–ç¨‹](#1-ä»€ä¹ˆæ˜¯äº‹ä»¶é©±åŠ¨ç¼–ç¨‹)
2. [Spring Bootäº‹ä»¶æœºåˆ¶åŸºç¡€](#2-Spring-Bootäº‹ä»¶æœºåˆ¶åŸºç¡€)
3. [è‡ªå®šä¹‰ApplicationEvent](#3-è‡ªå®šä¹‰ApplicationEvent)
4. [@EventListenerç›‘å¬å™¨è¯¦è§£](#4-EventListenerç›‘å¬å™¨è¯¦è§£)
5. [@TransactionalEventListeneräº‹åŠ¡äº‹ä»¶](#5-TransactionalEventListeneräº‹åŠ¡äº‹ä»¶)
6. [å¼‚æ­¥äº‹ä»¶å¤„ç†æœºåˆ¶](#6-å¼‚æ­¥äº‹ä»¶å¤„ç†æœºåˆ¶)
7. [äº‹ä»¶å‘å¸ƒé¡ºåºæ§åˆ¶](#7-äº‹ä»¶å‘å¸ƒé¡ºåºæ§åˆ¶)
8. [äº‹ä»¶å¼‚å¸¸å¤„ç†ç­–ç•¥](#8-äº‹ä»¶å¼‚å¸¸å¤„ç†ç­–ç•¥)
9. [å®æˆ˜åº”ç”¨åœºæ™¯](#9-å®æˆ˜åº”ç”¨åœºæ™¯)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯äº‹ä»¶é©±åŠ¨ç¼–ç¨‹


### 1.1 äº‹ä»¶é©±åŠ¨çš„ç”Ÿæ´»ç±»æ¯”


æƒ³è±¡ä¸€ä¸‹æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­çš„åœºæ™¯ï¼š

```
ç”Ÿæ´»ä¸­çš„äº‹ä»¶é©±åŠ¨ï¼š
å½“é—¨é“ƒå“äº†ï¼ˆäº‹ä»¶å‘ç”Ÿï¼‰
â†“
å¦ˆå¦ˆå»å¼€é—¨ï¼ˆç›‘å¬å™¨1å“åº”ï¼‰
çˆ¸çˆ¸æš‚åœçœ‹ç”µè§†ï¼ˆç›‘å¬å™¨2å“åº”ï¼‰  
å°ç‹—å¼€å§‹å«ï¼ˆç›‘å¬å™¨3å“åº”ï¼‰

ç‰¹ç‚¹ï¼š
âœ“ ä¸€ä¸ªäº‹ä»¶ï¼Œå¤šä¸ªå“åº”è€…
âœ“ å“åº”è€…ä¹‹é—´äº’ä¸å½±å“
âœ“ äº‹ä»¶å‘å¸ƒè€…ä¸å…³å¿ƒè°åœ¨ç›‘å¬
```

### 1.2 ä¼ ç»Ÿç¼–ç¨‹vsäº‹ä»¶é©±åŠ¨


**ä¼ ç»Ÿè°ƒç”¨æ–¹å¼ï¼ˆç´§è€¦åˆï¼‰**ï¼š
```
ç”¨æˆ·æ³¨å†Œæµç¨‹ï¼š
æ³¨å†ŒæœåŠ¡.register() {
  1. ä¿å­˜ç”¨æˆ·ä¿¡æ¯
  2. å‘é€é‚®ä»¶        â† ç›´æ¥è°ƒç”¨é‚®ä»¶æœåŠ¡
  3. å‘é€çŸ­ä¿¡        â† ç›´æ¥è°ƒç”¨çŸ­ä¿¡æœåŠ¡  
  4. è®°å½•æ—¥å¿—        â† ç›´æ¥è°ƒç”¨æ—¥å¿—æœåŠ¡
  5. ç»Ÿè®¡åˆ†æ        â† ç›´æ¥è°ƒç”¨åˆ†ææœåŠ¡
}

é—®é¢˜ï¼šæ³¨å†ŒæœåŠ¡éœ€è¦çŸ¥é“æ‰€æœ‰åç»­æ“ä½œ
```

**äº‹ä»¶é©±åŠ¨æ–¹å¼ï¼ˆæ¾è€¦åˆï¼‰**ï¼š
```
ç”¨æˆ·æ³¨å†Œæµç¨‹ï¼š
æ³¨å†ŒæœåŠ¡.register() {
  1. ä¿å­˜ç”¨æˆ·ä¿¡æ¯
  2. å‘å¸ƒ"ç”¨æˆ·æ³¨å†Œ"äº‹ä»¶  â† åªç®¡å‘å¸ƒäº‹ä»¶
}

ç›‘å¬å™¨ä»¬è‡ªåŠ¨å“åº”ï¼š
é‚®ä»¶ç›‘å¬å™¨ â†’ å‘é€é‚®ä»¶
çŸ­ä¿¡ç›‘å¬å™¨ â†’ å‘é€çŸ­ä¿¡
æ—¥å¿—ç›‘å¬å™¨ â†’ è®°å½•æ—¥å¿—  
åˆ†æç›‘å¬å™¨ â†’ ç»Ÿè®¡åˆ†æ

ä¼˜åŠ¿ï¼šæ³¨å†ŒæœåŠ¡åªå…³å¿ƒæ ¸å¿ƒä¸šåŠ¡
```

### 1.3 äº‹ä»¶é©±åŠ¨çš„æ ¸å¿ƒä»·å€¼


ğŸ”¸ **è§£è€¦åˆ**ï¼šå‘å¸ƒè€…å’Œç›‘å¬è€…äº’ä¸ä¾èµ–
ğŸ”¸ **æ‰©å±•æ€§**ï¼šæ·»åŠ æ–°åŠŸèƒ½åªéœ€æ–°å¢ç›‘å¬å™¨
ğŸ”¸ **å¼‚æ­¥å¤„ç†**ï¼šæå‡ç³»ç»Ÿå“åº”é€Ÿåº¦
ğŸ”¸ **äº‹åŠ¡å®‰å…¨**ï¼šå¯æ§åˆ¶äº‹ä»¶åœ¨äº‹åŠ¡å†…å¤–æ‰§è¡Œ

---

## 2. ğŸ—ï¸ Spring Bootäº‹ä»¶æœºåˆ¶åŸºç¡€


### 2.1 Springäº‹ä»¶ä½“ç³»ç»“æ„


```
Springäº‹ä»¶ä½“ç³»æ¶æ„ï¼š

ApplicationEventPublisher    ApplicationEvent
        â†“                         â†‘
   [äº‹ä»¶å‘å¸ƒè€…]              [äº‹ä»¶å¯¹è±¡]
        â†“                         â†‘
ApplicationEventMulticaster â† ApplicationListener
   [äº‹ä»¶åˆ†å‘å™¨]               [äº‹ä»¶ç›‘å¬å™¨]
```

### 2.2 æ ¸å¿ƒç»„ä»¶è¯´æ˜


**ApplicationEventï¼ˆäº‹ä»¶ï¼‰**ï¼š
- å°±åƒç°å®ä¸­å‘ç”Ÿçš„"äº‹æƒ…"
- æ‰¿è½½äº‹ä»¶ç›¸å…³çš„æ•°æ®ä¿¡æ¯
- æ‰€æœ‰è‡ªå®šä¹‰äº‹ä»¶éƒ½è¦ç»§æ‰¿å®ƒ

**ApplicationListenerï¼ˆç›‘å¬å™¨ï¼‰**ï¼š
- å°±åƒ"äº‹æƒ…çš„å…³æ³¨è€…"
- å½“ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶è‡ªåŠ¨æ‰§è¡Œ
- å¯ä»¥æœ‰å¤šä¸ªç›‘å¬å™¨ç›‘å¬åŒä¸€äº‹ä»¶

**ApplicationEventPublisherï¼ˆå‘å¸ƒè€…ï¼‰**ï¼š
- å°±åƒ"æ¶ˆæ¯å¹¿æ’­å‘˜"
- è´Ÿè´£æŠŠäº‹ä»¶å‘Šè¯‰æ‰€æœ‰å…³å¿ƒçš„ç›‘å¬å™¨
- Springå®¹å™¨è‡ªåŠ¨æä¾›

### 2.3 Spring Bootå†…ç½®äº‹ä»¶


Spring Bootåœ¨åº”ç”¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨å‘å¸ƒå¤šä¸ªäº‹ä»¶ï¼š

```
åº”ç”¨å¯åŠ¨äº‹ä»¶æ—¶åºï¼š
ApplicationStartingEvent     â† åº”ç”¨å¼€å§‹å¯åŠ¨
     â†“
ApplicationEnvironmentPreparedEvent  â† ç¯å¢ƒå‡†å¤‡å®Œæˆ
     â†“  
ApplicationPreparedEvent     â† åº”ç”¨å‡†å¤‡å®Œæˆ
     â†“
ApplicationStartedEvent      â† åº”ç”¨å¯åŠ¨å®Œæˆ
     â†“
ApplicationReadyEvent        â† åº”ç”¨å°±ç»ªå¯ç”¨
```

---

## 3. ğŸ“ è‡ªå®šä¹‰ApplicationEvent


### 3.1 åˆ›å»ºè‡ªå®šä¹‰äº‹ä»¶


è‡ªå®šä¹‰äº‹ä»¶å°±åƒå®šä¹‰ä¸€å¼ "é€šçŸ¥å•"ï¼Œé‡Œé¢åŒ…å«è¦ä¼ é€’çš„ä¿¡æ¯ï¼š

```java
// ç”¨æˆ·æ³¨å†Œäº‹ä»¶ - é€šçŸ¥å•çš„å†…å®¹
public class UserRegisterEvent extends ApplicationEvent {
    
    private String username;    // ç”¨æˆ·å
    private String email;       // é‚®ç®±
    private Date registerTime;  // æ³¨å†Œæ—¶é—´
    
    // æ„é€ æ–¹æ³• - åˆ›å»ºé€šçŸ¥å•
    public UserRegisterEvent(Object source, String username, String email) {
        super(source);  // sourceæ˜¯äº‹ä»¶å‘å¸ƒè€…
        this.username = username;
        this.email = email;
        this.registerTime = new Date();
    }
    
    // getteræ–¹æ³•è®©ç›‘å¬å™¨è·å–ä¿¡æ¯
    public String getUsername() { return username; }
    public String getEmail() { return email; }
    public Date getRegisterTime() { return registerTime; }
}
```

### 3.2 äº‹ä»¶è®¾è®¡åŸåˆ™


**æ•°æ®å®Œæ•´æ€§**ï¼š
```java
// âœ… å¥½çš„è®¾è®¡ - åŒ…å«å¿…è¦ä¿¡æ¯
public class OrderCreatedEvent extends ApplicationEvent {
    private Long orderId;
    private Long customerId;  
    private BigDecimal amount;
    private String status;
    // åŒ…å«å¤„ç†è¯¥äº‹ä»¶éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯
}

// âŒ ä¸å¥½çš„è®¾è®¡ - ä¿¡æ¯ä¸è¶³
public class OrderCreatedEvent extends ApplicationEvent {
    private Long orderId;  // ç›‘å¬å™¨è¿˜éœ€è¦æŸ¥æ•°æ®åº“è·å–å…¶ä»–ä¿¡æ¯
}
```

**äº‹ä»¶å‘½åè§„èŒƒ**ï¼š
```java
// æ¨èçš„å‘½åæ–¹å¼ï¼š
UserRegisterEvent      // ç”¨æˆ·æ³¨å†Œäº‹ä»¶
OrderCreatedEvent      // è®¢å•åˆ›å»ºäº‹ä»¶  
PaymentCompletedEvent  // æ”¯ä»˜å®Œæˆäº‹ä»¶
EmailSentEvent         // é‚®ä»¶å‘é€äº‹ä»¶

// ä½“ç°ï¼šä¸»ä½“ + åŠ¨ä½œ + Eventåç¼€
```

### 3.3 å¤æ‚äº‹ä»¶ç¤ºä¾‹


```java
// è®¢å•çŠ¶æ€å˜æ›´äº‹ä»¶ - åŒ…å«æ›´å¤šä¸šåŠ¡ä¿¡æ¯
public class OrderStatusChangeEvent extends ApplicationEvent {
    
    private Long orderId;
    private String oldStatus;    // åŸçŠ¶æ€
    private String newStatus;    // æ–°çŠ¶æ€
    private String changeReason; // å˜æ›´åŸå› 
    private Long operatorId;     // æ“ä½œäºº
    
    public OrderStatusChangeEvent(Object source, Long orderId, 
                                 String oldStatus, String newStatus, 
                                 String changeReason, Long operatorId) {
        super(source);
        this.orderId = orderId;
        this.oldStatus = oldStatus;
        this.newStatus = newStatus;
        this.changeReason = changeReason;
        this.operatorId = operatorId;
    }
    
    // ä¸šåŠ¡åˆ¤æ–­æ–¹æ³•
    public boolean isOrderCompleted() {
        return "COMPLETED".equals(newStatus);
    }
    
    public boolean isOrderCancelled() {
        return "CANCELLED".equals(newStatus);
    }
    
    // getteræ–¹æ³•...
}
```

---

## 4. ğŸ‘‚ @EventListenerç›‘å¬å™¨è¯¦è§£


### 4.1 åŸºç¡€ç›‘å¬å™¨ä½¿ç”¨


`@EventListener`å°±åƒç»™æ–¹æ³•è´´ä¸ª"æ ‡ç­¾"ï¼Œå‘Šè¯‰Springï¼šå½“æŸä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè¯·è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚

```java
@Component
public class UserEventListener {
    
    private static final Logger log = LoggerFactory.getLogger(UserEventListener.class);
    
    // ç›‘å¬ç”¨æˆ·æ³¨å†Œäº‹ä»¶
    @EventListener
    public void handleUserRegister(UserRegisterEvent event) {
        // è¿™ä¸ªæ–¹æ³•ä¼šåœ¨ç”¨æˆ·æ³¨å†Œäº‹ä»¶å‘ç”Ÿæ—¶è‡ªåŠ¨æ‰§è¡Œ
        log.info("ç”¨æˆ· {} åœ¨ {} æ³¨å†Œäº†è´¦å·", 
                event.getUsername(), 
                event.getRegisterTime());
                
        // å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œä»»ä½•åç»­æ“ä½œ
        // æ¯”å¦‚å‘é€æ¬¢è¿é‚®ä»¶ã€åˆå§‹åŒ–ç”¨æˆ·é…ç½®ç­‰
    }
}
```

### 4.2 å¤šä¸ªç›‘å¬å™¨ç›‘å¬åŒä¸€äº‹ä»¶


```java
// é‚®ä»¶æœåŠ¡ç›‘å¬å™¨
@Component
public class EmailServiceListener {
    
    @EventListener
    public void sendWelcomeEmail(UserRegisterEvent event) {
        // å‘é€æ¬¢è¿é‚®ä»¶
        System.out.println("å‘é€æ¬¢è¿é‚®ä»¶ç»™: " + event.getEmail());
    }
}

// ç»Ÿè®¡æœåŠ¡ç›‘å¬å™¨  
@Component
public class StatisticsListener {
    
    @EventListener
    public void updateUserStats(UserRegisterEvent event) {
        // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
        System.out.println("æ›´æ–°ç”¨æˆ·æ³¨å†Œç»Ÿè®¡");
    }
}

// ä¼šå‘˜æœåŠ¡ç›‘å¬å™¨
@Component  
public class MembershipListener {
    
    @EventListener
    public void initMembershipLevel(UserRegisterEvent event) {
        // åˆå§‹åŒ–ä¼šå‘˜ç­‰çº§
        System.out.println("ä¸ºç”¨æˆ· " + event.getUsername() + " åˆå§‹åŒ–ä¼šå‘˜ç­‰çº§");
    }
}
```

### 4.3 æ¡ä»¶ç›‘å¬å™¨


æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›ç›‘å¬å™¨åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹æ‰æ‰§è¡Œï¼š

```java
@Component
public class ConditionalListener {
    
    // åªå¤„ç†VIPç”¨æˆ·çš„æ³¨å†Œ
    @EventListener(condition = "#event.username.startsWith('VIP_')")
    public void handleVipUserRegister(UserRegisterEvent event) {
        System.out.println("VIPç”¨æˆ·æ³¨å†Œï¼Œæä¾›ä¸“å±æœåŠ¡");
    }
    
    // åªå¤„ç†å·¥ä½œæ—¶é—´çš„è®¢å•
    @EventListener(condition = "T(java.time.LocalTime).now().getHour() >= 9 && T(java.time.LocalTime).now().getHour() <= 17")
    public void handleWorkHoursOrder(OrderCreatedEvent event) {
        System.out.println("å·¥ä½œæ—¶é—´è®¢å•ï¼Œç«‹å³å¤„ç†");
    }
    
    // åªå¤„ç†å¤§é¢è®¢å•
    @EventListener(condition = "#event.amount.compareTo(T(java.math.BigDecimal).valueOf(1000)) > 0")
    public void handleLargeOrder(OrderCreatedEvent event) {
        System.out.println("å¤§é¢è®¢å•ï¼Œéœ€è¦å®¡æ ¸");
    }
}
```

### 4.4 ç›‘å¬å™¨çš„è¿”å›å€¼


ç›‘å¬å™¨æ–¹æ³•å¯ä»¥è¿”å›æ–°çš„äº‹ä»¶ï¼Œå½¢æˆäº‹ä»¶é“¾ï¼š

```java
@Component
public class EventChainListener {
    
    // å¤„ç†ç”¨æˆ·æ³¨å†Œï¼Œè¿”å›æ–°äº‹ä»¶
    @EventListener
    public UserActivationEvent handleUserRegister(UserRegisterEvent event) {
        // å¤„ç†æ³¨å†Œé€»è¾‘
        System.out.println("å¤„ç†ç”¨æˆ·æ³¨å†Œ: " + event.getUsername());
        
        // è¿”å›æ–°äº‹ä»¶ï¼Œä¼šè‡ªåŠ¨å‘å¸ƒ
        return new UserActivationEvent(this, event.getUsername(), event.getEmail());
    }
    
    // ç›‘å¬ä¸Šä¸€ä¸ªäº‹ä»¶äº§ç”Ÿçš„æ¿€æ´»äº‹ä»¶
    @EventListener  
    public void handleUserActivation(UserActivationEvent event) {
        System.out.println("å¤„ç†ç”¨æˆ·æ¿€æ´»: " + event.getUsername());
    }
}
```

---

## 5. ğŸ”„ @TransactionalEventListeneräº‹åŠ¡äº‹ä»¶


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡äº‹ä»¶


æ™®é€šäº‹ä»¶ç›‘å¬å™¨çš„é—®é¢˜ï¼š

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired  
    private ApplicationEventPublisher publisher;
    
    @Transactional
    public void registerUser(String username, String email) {
        // 1. ä¿å­˜ç”¨æˆ·ï¼ˆåœ¨äº‹åŠ¡ä¸­ï¼‰
        User user = new User(username, email);
        userRepository.save(user);
        
        // 2. å‘å¸ƒäº‹ä»¶ï¼ˆç«‹å³æ‰§è¡Œç›‘å¬å™¨ï¼‰
        publisher.publishEvent(new UserRegisterEvent(this, username, email));
        
        // 3. å¦‚æœè¿™é‡ŒæŠ›å¼‚å¸¸ï¼Œç”¨æˆ·æ•°æ®ä¼šå›æ»š
        // ä½†ç›‘å¬å™¨å·²ç»æ‰§è¡Œäº†ï¼ˆæ¯”å¦‚é‚®ä»¶å·²å‘é€ï¼‰
        if (someCondition) {
            throw new RuntimeException("æ³¨å†Œå¤±è´¥");
        }
    }
}

// é—®é¢˜ï¼šç”¨æˆ·æ³¨å†Œå¤±è´¥äº†ï¼Œä½†æ¬¢è¿é‚®ä»¶å·²ç»å‘é€äº†ï¼
@Component
public class EmailListener {
    
    @EventListener
    public void sendWelcomeEmail(UserRegisterEvent event) {
        // è¿™ä¸ªæ–¹æ³•åœ¨äº‹åŠ¡æäº¤å‰å°±æ‰§è¡Œäº†
        emailService.sendWelcome(event.getEmail());
    }
}
```

### 5.2 @TransactionalEventListenerè§£å†³æ–¹æ¡ˆ


```java
@Component
public class TransactionalEmailListener {
    
    // ç­‰äº‹åŠ¡æäº¤æˆåŠŸåå†æ‰§è¡Œ
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void sendWelcomeEmailAfterCommit(UserRegisterEvent event) {
        // åªæœ‰å½“ç”¨æˆ·çœŸæ­£ä¿å­˜æˆåŠŸåï¼Œæ‰å‘é€é‚®ä»¶
        emailService.sendWelcome(event.getEmail());
        System.out.println("äº‹åŠ¡æäº¤æˆåŠŸï¼Œå‘é€æ¬¢è¿é‚®ä»¶");
    }
    
    // äº‹åŠ¡å›æ»šæ—¶æ‰§è¡Œ
    @TransactionalEventListener(phase = TransactionPhase.AFTER_ROLLBACK)
    public void handleRegistrationFailure(UserRegisterEvent event) {
        // è®°å½•æ³¨å†Œå¤±è´¥çš„æƒ…å†µ
        System.out.println("ç”¨æˆ·æ³¨å†Œå¤±è´¥ï¼Œè®°å½•é”™è¯¯æ—¥å¿—");
    }
    
    // æ— è®ºäº‹åŠ¡æˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½æ‰§è¡Œ
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMPLETION)
    public void cleanupResources(UserRegisterEvent event) {
        // æ¸…ç†ä¸´æ—¶èµ„æº
        System.out.println("æ¸…ç†æ³¨å†Œè¿‡ç¨‹ä¸­çš„ä¸´æ—¶èµ„æº");
    }
}
```

### 5.3 äº‹åŠ¡é˜¶æ®µè¯¦è§£


```
äº‹åŠ¡æ‰§è¡Œæ—¶åºå›¾ï¼š
                    
å¼€å§‹äº‹åŠ¡ â”€â”€â”
         â”‚
ä¸šåŠ¡é€»è¾‘   â”‚ â† BEFORE_COMMITé˜¶æ®µï¼ˆäº‹åŠ¡æäº¤å‰ï¼‰
         â”‚
æäº¤/å›æ»š â”˜ â† AFTER_COMMITé˜¶æ®µï¼ˆæäº¤æˆåŠŸåï¼‰
         â”‚  â† AFTER_ROLLBACKé˜¶æ®µï¼ˆå›æ»šåï¼‰  
         â””â”€ â† AFTER_COMPLETIONé˜¶æ®µï¼ˆå®Œæˆåï¼‰
```

**å„é˜¶æ®µè¯´æ˜**ï¼š

| é˜¶æ®µ | æ‰§è¡Œæ—¶æœº | é€‚ç”¨åœºæ™¯ | æ³¨æ„äº‹é¡¹ |
|-----|---------|---------|---------|
| `BEFORE_COMMIT` | äº‹åŠ¡æäº¤å‰ | æœ€åçš„æ•°æ®æ ¡éªŒ | å¯èƒ½å½±å“äº‹åŠ¡æäº¤ |
| `AFTER_COMMIT` | äº‹åŠ¡æäº¤å | å‘é€é€šçŸ¥ã€æ¸…ç†ç¼“å­˜ | **æœ€å¸¸ç”¨** |
| `AFTER_ROLLBACK` | äº‹åŠ¡å›æ»šå | è®°å½•é”™è¯¯ã€è¡¥å¿æ“ä½œ | å¤„ç†å¼‚å¸¸æƒ…å†µ |
| `AFTER_COMPLETION` | äº‹åŠ¡å®Œæˆå | èµ„æºæ¸…ç†ã€ç»Ÿè®¡ | æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ |

### 5.4 å®é™…åº”ç”¨ç¤ºä¾‹


```java
@Component
public class OrderTransactionalListener {
    
    @Autowired
    private EmailService emailService;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private NotificationService notificationService;
    
    // è®¢å•åˆ›å»ºæˆåŠŸåçš„åç»­å¤„ç†
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void handleOrderCreated(OrderCreatedEvent event) {
        // å‘é€è®¢å•ç¡®è®¤é‚®ä»¶
        emailService.sendOrderConfirmation(event.getCustomerId(), event.getOrderId());
        
        // æ›´æ–°åº“å­˜
        inventoryService.updateStock(event.getOrderId());
        
        // å‘é€æ‰‹æœºé€šçŸ¥
        notificationService.sendOrderNotification(event.getCustomerId());
    }
    
    // è®¢å•åˆ›å»ºå¤±è´¥çš„å¤„ç†
    @TransactionalEventListener(phase = TransactionPhase.AFTER_ROLLBACK)  
    public void handleOrderCreationFailure(OrderCreatedEvent event) {
        // è®°å½•å¤±è´¥åŸå› 
        System.out.println("è®¢å•åˆ›å»ºå¤±è´¥ï¼Œè®¢å•ID: " + event.getOrderId());
        
        // å¯ä»¥å‘é€å¤±è´¥é€šçŸ¥ç»™å®¢æœ
        notificationService.notifyCustomerService("è®¢å•åˆ›å»ºå¤±è´¥", event);
    }
}
```

---

## 6. âš¡ å¼‚æ­¥äº‹ä»¶å¤„ç†æœºåˆ¶


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥å¤„ç†


åŒæ­¥å¤„ç†çš„é—®é¢˜ï¼š

```
ç”¨æˆ·æ³¨å†Œæµç¨‹ï¼ˆåŒæ­¥ï¼‰ï¼š
ç”¨æˆ·æäº¤æ³¨å†Œ â†’ ä¿å­˜ç”¨æˆ·ä¿¡æ¯(100ms) â†’ å‘é€é‚®ä»¶(2000ms) â†’ å‘é€çŸ­ä¿¡(1500ms) â†’ è®°å½•æ—¥å¿—(50ms) â†’ è¿”å›ç»“æœ
æ€»è€—æ—¶ï¼š3650msï¼Œç”¨æˆ·éœ€è¦ç­‰å¾…3.6ç§’ï¼
```

å¼‚æ­¥å¤„ç†çš„ä¼˜åŠ¿ï¼š

```
ç”¨æˆ·æ³¨å†Œæµç¨‹ï¼ˆå¼‚æ­¥ï¼‰ï¼š
ç”¨æˆ·æäº¤æ³¨å†Œ â†’ ä¿å­˜ç”¨æˆ·ä¿¡æ¯(100ms) â†’ å‘å¸ƒäº‹ä»¶ â†’ ç«‹å³è¿”å›ç»“æœ
                                    â†“
                              åå°å¼‚æ­¥å¤„ç†ï¼š
                              - å‘é€é‚®ä»¶(2000ms)
                              - å‘é€çŸ­ä¿¡(1500ms)  
                              - è®°å½•æ—¥å¿—(50ms)
ç”¨æˆ·å“åº”æ—¶é—´ï¼šçº¦100msï¼Œä½“éªŒå¤§å¹…æå‡ï¼
```

### 6.2 å¯ç”¨å¼‚æ­¥äº‹ä»¶å¤„ç†


**ç¬¬ä¸€æ­¥**ï¼šåœ¨é…ç½®ç±»ä¸Šå¯ç”¨å¼‚æ­¥æ”¯æŒ

```java
@Configuration
@EnableAsync  // å¯ç”¨å¼‚æ­¥å¤„ç†
public class AsyncConfig {
    
    // è‡ªå®šä¹‰å¼‚æ­¥æ‰§è¡Œå™¨
    @Bean
    public Executor asyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);        // æ ¸å¿ƒçº¿ç¨‹æ•°
        executor.setMaxPoolSize(10);        // æœ€å¤§çº¿ç¨‹æ•°
        executor.setQueueCapacity(100);     // é˜Ÿåˆ—å¤§å°
        executor.setThreadNamePrefix("Event-Async-"); // çº¿ç¨‹åå‰ç¼€
        executor.initialize();
        return executor;
    }
}
```

**ç¬¬äºŒæ­¥**ï¼šåœ¨ç›‘å¬å™¨æ–¹æ³•ä¸Šæ·»åŠ `@Async`æ³¨è§£

```java
@Component
public class AsyncEventListener {
    
    private static final Logger log = LoggerFactory.getLogger(AsyncEventListener.class);
    
    // å¼‚æ­¥å¤„ç†é‚®ä»¶å‘é€
    @EventListener
    @Async("asyncExecutor")  // æŒ‡å®šä½¿ç”¨çš„å¼‚æ­¥æ‰§è¡Œå™¨
    public void sendEmailAsync(UserRegisterEvent event) {
        // æ¨¡æ‹Ÿè€—æ—¶çš„é‚®ä»¶å‘é€
        try {
            Thread.sleep(2000); // æ¨¡æ‹Ÿ2ç§’çš„é‚®ä»¶å‘é€æ—¶é—´
            log.info("å¼‚æ­¥å‘é€é‚®ä»¶ç»™ {}", event.getEmail());
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    // å¼‚æ­¥å¤„ç†çŸ­ä¿¡å‘é€  
    @EventListener
    @Async("asyncExecutor")
    public void sendSmsAsync(UserRegisterEvent event) {
        try {
            Thread.sleep(1500); // æ¨¡æ‹Ÿ1.5ç§’çš„çŸ­ä¿¡å‘é€æ—¶é—´
            log.info("å¼‚æ­¥å‘é€çŸ­ä¿¡ç»™ {}", event.getUsername());
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    // åŒæ­¥å¤„ç†é‡è¦é€»è¾‘
    @EventListener
    public void updateUserStats(UserRegisterEvent event) {
        // é‡è¦çš„ç»Ÿè®¡æ•°æ®åŒæ­¥å¤„ç†
        log.info("åŒæ­¥æ›´æ–°ç”¨æˆ·ç»Ÿè®¡");
    }
}
```

### 6.3 å¼‚æ­¥å¤„ç†çš„æ³¨æ„äº‹é¡¹


**å¼‚æ­¥ç›‘å¬å™¨ç‰¹ç‚¹**ï¼š
```
âœ… ä¼˜åŠ¿ï¼š
â€¢ æé«˜å“åº”é€Ÿåº¦
â€¢ ä¸é˜»å¡ä¸»æµç¨‹
â€¢ æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

âš ï¸  æ³¨æ„äº‹é¡¹ï¼š
â€¢ å¼‚æ­¥æ–¹æ³•ä¸èƒ½æœ‰è¿”å›å€¼ï¼ˆvoidï¼‰
â€¢ å¼‚å¸¸ä¸ä¼šä¼ æ’­åˆ°è°ƒç”¨æ–¹
â€¢ éœ€è¦åˆç†é…ç½®çº¿ç¨‹æ± 
â€¢ è¦åšå¥½å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
```

**å¼‚å¸¸å¤„ç†ç¤ºä¾‹**ï¼š

```java
@Component
public class SafeAsyncListener {
    
    @EventListener
    @Async
    public void processEventSafely(UserRegisterEvent event) {
        try {
            // å¯èƒ½å‡ºç°å¼‚å¸¸çš„å¤„ç†é€»è¾‘
            riskyOperation(event);
        } catch (Exception e) {
            // å¼‚æ­¥æ–¹æ³•ä¸­çš„å¼‚å¸¸å¿…é¡»è‡ªå·±å¤„ç†
            log.error("å¤„ç†ç”¨æˆ·æ³¨å†Œäº‹ä»¶å¼‚å¸¸", e);
            
            // å¯ä»¥å‘å¸ƒä¸€ä¸ªé”™è¯¯äº‹ä»¶
            publisher.publishEvent(new EventProcessingErrorEvent(this, event, e));
        }
    }
}
```

---

## 7. ğŸ“‹ äº‹ä»¶å‘å¸ƒé¡ºåºæ§åˆ¶


### 7.1 é»˜è®¤æ‰§è¡Œé¡ºåº


é»˜è®¤æƒ…å†µä¸‹ï¼Œç›‘å¬å™¨çš„æ‰§è¡Œé¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼š

```java
@Component
public class UnorderedListeners {
    
    @EventListener
    public void listener1(UserRegisterEvent event) {
        System.out.println("ç›‘å¬å™¨1æ‰§è¡Œ");
    }
    
    @EventListener  
    public void listener2(UserRegisterEvent event) {
        System.out.println("ç›‘å¬å™¨2æ‰§è¡Œ");
    }
    
    @EventListener
    public void listener3(UserRegisterEvent event) {
        System.out.println("ç›‘å¬å™¨3æ‰§è¡Œ");
    }
}

// è¾“å‡ºå¯èƒ½æ˜¯ï¼šç›‘å¬å™¨2 â†’ ç›‘å¬å™¨1 â†’ ç›‘å¬å™¨3ï¼ˆé¡ºåºä¸ç¡®å®šï¼‰
```

### 7.2 ä½¿ç”¨@Orderæ§åˆ¶é¡ºåº


```java
@Component
public class OrderedListeners {
    
    @EventListener
    @Order(1)  // æ•°å­—è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜
    public void firstListener(UserRegisterEvent event) {
        System.out.println("ç¬¬ä¸€ä¸ªæ‰§è¡Œï¼šéªŒè¯ç”¨æˆ·ä¿¡æ¯");
    }
    
    @EventListener
    @Order(2)
    public void secondListener(UserRegisterEvent event) {
        System.out.println("ç¬¬äºŒä¸ªæ‰§è¡Œï¼šåˆå§‹åŒ–ç”¨æˆ·é…ç½®");
    }
    
    @EventListener
    @Order(3)  
    public void thirdListener(UserRegisterEvent event) {
        System.out.println("ç¬¬ä¸‰ä¸ªæ‰§è¡Œï¼šå‘é€é€šçŸ¥é‚®ä»¶");
    }
    
    @EventListener
    @Order(Integer.MAX_VALUE)  // æœ€åæ‰§è¡Œ
    public void lastListener(UserRegisterEvent event) {
        System.out.println("æœ€åæ‰§è¡Œï¼šæ¸…ç†ä¸´æ—¶æ•°æ®");
    }
}
```

### 7.3 å®é™…ä¸šåŠ¡ä¸­çš„é¡ºåºæ§åˆ¶


```java
@Component
public class UserRegistrationProcessors {
    
    // ç¬¬1æ­¥ï¼šæ•°æ®éªŒè¯ï¼ˆå¿…é¡»æœ€å…ˆæ‰§è¡Œï¼‰
    @EventListener
    @Order(1)
    public void validateUserData(UserRegisterEvent event) {
        System.out.println("1. éªŒè¯ç”¨æˆ·æ•°æ®å®Œæ•´æ€§");
        // å¦‚æœéªŒè¯å¤±è´¥ï¼Œå¯ä»¥æŠ›å¼‚å¸¸é˜»æ­¢åç»­å¤„ç†
    }
    
    // ç¬¬2æ­¥ï¼šåˆå§‹åŒ–ç”¨æˆ·é…ç½®
    @EventListener
    @Order(2)
    public void initializeUserSettings(UserRegisterEvent event) {
        System.out.println("2. åˆå§‹åŒ–ç”¨æˆ·é»˜è®¤è®¾ç½®");
    }
    
    // ç¬¬3æ­¥ï¼šåˆ†é…ç”¨æˆ·æƒé™
    @EventListener
    @Order(3)
    public void assignUserRoles(UserRegisterEvent event) {
        System.out.println("3. åˆ†é…ç”¨æˆ·è§’è‰²å’Œæƒé™");
    }
    
    // ç¬¬4æ­¥ï¼šå‘é€é€šçŸ¥ï¼ˆå¯ä»¥å¼‚æ­¥ï¼‰
    @EventListener
    @Order(4)
    @Async
    public void sendNotifications(UserRegisterEvent event) {
        System.out.println("4. å‘é€æ¬¢è¿é‚®ä»¶å’ŒçŸ­ä¿¡");
    }
    
    // ç¬¬5æ­¥ï¼šç»Ÿè®¡å’Œæ—¥å¿—ï¼ˆæœ€åæ‰§è¡Œï¼‰
    @EventListener
    @Order(5)
    public void recordStatistics(UserRegisterEvent event) {
        System.out.println("5. æ›´æ–°æ³¨å†Œç»Ÿè®¡å’Œè®°å½•æ—¥å¿—");
    }
}
```

### 7.4 æ··åˆåŒæ­¥å¼‚æ­¥çš„é¡ºåº


```java
@Component  
public class MixedOrderProcessors {
    
    // åŒæ­¥å¤„ç†ï¼Œé¡ºåºæ‰§è¡Œ
    @EventListener
    @Order(1)
    public void syncProcess1(UserRegisterEvent event) {
        System.out.println("åŒæ­¥å¤„ç†1 - çº¿ç¨‹ï¼š" + Thread.currentThread().getName());
    }
    
    @EventListener
    @Order(2) 
    public void syncProcess2(UserRegisterEvent event) {
        System.out.println("åŒæ­¥å¤„ç†2 - çº¿ç¨‹ï¼š" + Thread.currentThread().getName());
    }
    
    // å¼‚æ­¥å¤„ç†ï¼ŒOrderå¯¹å¼‚æ­¥æ–¹æ³•æ— æ•ˆ
    @EventListener
    @Order(3)
    @Async
    public void asyncProcess1(UserRegisterEvent event) {
        System.out.println("å¼‚æ­¥å¤„ç†1 - çº¿ç¨‹ï¼š" + Thread.currentThread().getName());
    }
    
    @EventListener  
    @Order(4)
    @Async
    public void asyncProcess2(UserRegisterEvent event) {
        System.out.println("å¼‚æ­¥å¤„ç†2 - çº¿ç¨‹ï¼š" + Thread.currentThread().getName());
    }
}

/*
æ‰§è¡Œç»“æœï¼š
åŒæ­¥å¤„ç†1 - çº¿ç¨‹ï¼šmain
åŒæ­¥å¤„ç†2 - çº¿ç¨‹ï¼šmain  
å¼‚æ­¥å¤„ç†1 - çº¿ç¨‹ï¼šEvent-Async-1 ï¼ˆå¼‚æ­¥ï¼Œé¡ºåºä¸ä¿è¯ï¼‰
å¼‚æ­¥å¤„ç†2 - çº¿ç¨‹ï¼šEvent-Async-2 ï¼ˆå¼‚æ­¥ï¼Œé¡ºåºä¸ä¿è¯ï¼‰
*/
```

---

## 8. ğŸ›¡ï¸ äº‹ä»¶å¼‚å¸¸å¤„ç†ç­–ç•¥


### 8.1 åŒæ­¥äº‹ä»¶çš„å¼‚å¸¸ä¼ æ’­


```java
@Service
public class UserService {
    
    @Autowired
    private ApplicationEventPublisher publisher;
    
    public void registerUser(String username, String email) {
        try {
            // å‘å¸ƒäº‹ä»¶
            publisher.publishEvent(new UserRegisterEvent(this, username, email));
            System.out.println("ç”¨æˆ·æ³¨å†Œå®Œæˆ");
        } catch (Exception e) {
            // å¦‚æœä»»ä½•ç›‘å¬å™¨æŠ›å¼‚å¸¸ï¼Œè¿™é‡Œä¼šæ•è·åˆ°
            System.out.println("æ³¨å†Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: " + e.getMessage());
            throw e; // å¯ä»¥é€‰æ‹©é‡æ–°æŠ›å‡ºæˆ–å¤„ç†
        }
    }
}

@Component
public class ProblematicListener {
    
    @EventListener
    @Order(1)
    public void goodListener(UserRegisterEvent event) {
        System.out.println("æ­£å¸¸ç›‘å¬å™¨æ‰§è¡Œ");
    }
    
    @EventListener
    @Order(2) 
    public void badListener(UserRegisterEvent event) {
        // è¿™ä¸ªç›‘å¬å™¨ä¼šæŠ›å¼‚å¸¸
        throw new RuntimeException("ç›‘å¬å™¨æ‰§è¡Œå‡ºé”™ï¼");
    }
    
    @EventListener
    @Order(3)
    public void neverExecutedListener(UserRegisterEvent event) {
        // ç”±äºå‰é¢çš„ç›‘å¬å™¨æŠ›å¼‚å¸¸ï¼Œè¿™ä¸ªæ°¸è¿œä¸ä¼šæ‰§è¡Œ
        System.out.println("è¿™å¥è¯ä¸ä¼šæ‰“å°");
    }
}
```

### 8.2 è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨


```java
@Component
public class EventExceptionHandler implements ApplicationListener<ApplicationEvent> {
    
    private static final Logger log = LoggerFactory.getLogger(EventExceptionHandler.class);
    
    @Override
    public void onApplicationEvent(ApplicationEvent event) {
        // è¿™ä¸ªæ–¹æ³•å¯ä»¥ä½œä¸º"å…œåº•"å¤„ç†å™¨
        if (event instanceof UserRegisterEvent) {
            handleUserRegisterEventSafely((UserRegisterEvent) event);
        }
    }
    
    private void handleUserRegisterEventSafely(UserRegisterEvent event) {
        try {
            // æ‰§è¡Œå¯èƒ½å‡ºé”™çš„é€»è¾‘
            riskyBusinessLogic(event);
        } catch (Exception e) {
            // è®°å½•é”™è¯¯ä½†ä¸æŠ›å‡ºï¼Œé¿å…å½±å“å…¶ä»–ç›‘å¬å™¨
            log.error("å¤„ç†ç”¨æˆ·æ³¨å†Œäº‹ä»¶å¤±è´¥ï¼Œç”¨æˆ·ï¼š{}", event.getUsername(), e);
            
            // å¯ä»¥å‘é€å‘Šè­¦æˆ–è®°å½•åˆ°é”™è¯¯é˜Ÿåˆ—
            sendAlertToAdmin(event, e);
        }
    }
    
    private void sendAlertToAdmin(UserRegisterEvent event, Exception e) {
        // å‘é€å‘Šè­¦ç»™ç®¡ç†å‘˜
        System.out.println("å‘é€é”™è¯¯å‘Šè­¦ï¼šç”¨æˆ·æ³¨å†Œå¤„ç†å¼‚å¸¸");
    }
}
```

### 8.3 å®¹é”™çš„ç›‘å¬å™¨è®¾è®¡


```java
@Component
public class FaultTolerantListeners {
    
    private static final Logger log = LoggerFactory.getLogger(FaultTolerantListeners.class);
    
    // å®‰å…¨çš„é‚®ä»¶å‘é€ç›‘å¬å™¨
    @EventListener
    public void sendEmailSafely(UserRegisterEvent event) {
        try {
            emailService.sendWelcomeEmail(event.getEmail());
            log.info("æ¬¢è¿é‚®ä»¶å‘é€æˆåŠŸï¼š{}", event.getEmail());
        } catch (Exception e) {
            // é‚®ä»¶å‘é€å¤±è´¥ä¸åº”è¯¥å½±å“ç”¨æˆ·æ³¨å†Œ
            log.error("æ¬¢è¿é‚®ä»¶å‘é€å¤±è´¥ï¼Œä½†ä¸å½±å“æ³¨å†Œæµç¨‹", e);
            
            // å¯ä»¥å°†å¤±è´¥çš„é‚®ä»¶æ”¾å…¥é‡è¯•é˜Ÿåˆ—
            retryQueue.addFailedEmail(event.getEmail());
        }
    }
    
    // å®‰å…¨çš„çŸ­ä¿¡å‘é€ç›‘å¬å™¨
    @EventListener
    public void sendSmsSafely(UserRegisterEvent event) {
        try {
            smsService.sendWelcomeSms(event.getUsername());
            log.info("æ¬¢è¿çŸ­ä¿¡å‘é€æˆåŠŸï¼š{}", event.getUsername());
        } catch (Exception e) {
            log.error("æ¬¢è¿çŸ­ä¿¡å‘é€å¤±è´¥", e);
            // çŸ­ä¿¡å¤±è´¥ä¹Ÿä¸å½±å“ä¸»æµç¨‹
        }
    }
    
    // å…³é”®ä¸šåŠ¡ç›‘å¬å™¨ï¼ˆå¤±è´¥æ—¶éœ€è¦é˜»æ­¢æµç¨‹ï¼‰
    @EventListener
    @Order(1) // ä¼˜å…ˆæ‰§è¡Œ
    public void validateCriticalBusiness(UserRegisterEvent event) {
        try {
            // å…³é”®ä¸šåŠ¡éªŒè¯
            criticalValidationService.validate(event);
        } catch (Exception e) {
            log.error("å…³é”®ä¸šåŠ¡éªŒè¯å¤±è´¥ï¼Œé˜»æ­¢æ³¨å†Œæµç¨‹", e);
            // å…³é”®ä¸šåŠ¡å¤±è´¥æ—¶é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œé˜»æ­¢åç»­å¤„ç†
            throw new UserRegistrationException("ç”¨æˆ·æ³¨å†ŒéªŒè¯å¤±è´¥", e);
        }
    }
}
```

### 8.4 å¼‚æ­¥äº‹ä»¶çš„å¼‚å¸¸å¤„ç†


```java
@Component
public class AsyncExceptionHandler {
    
    private static final Logger log = LoggerFactory.getLogger(AsyncExceptionHandler.class);
    
    @EventListener
    @Async
    public void asyncProcessWithExceptionHandling(UserRegisterEvent event) {
        try {
            // å¼‚æ­¥å¤„ç†é€»è¾‘
            performAsyncOperation(event);
        } catch (Exception e) {
            // å¼‚æ­¥æ–¹æ³•çš„å¼‚å¸¸ä¸ä¼šä¼ æ’­ï¼Œå¿…é¡»è‡ªå·±å¤„ç†
            handleAsyncException(event, e);
        }
    }
    
    private void handleAsyncException(UserRegisterEvent event, Exception e) {
        log.error("å¼‚æ­¥å¤„ç†ç”¨æˆ·æ³¨å†Œäº‹ä»¶å¤±è´¥ï¼š{}", event.getUsername(), e);
        
        // å¼‚æ­¥å¼‚å¸¸çš„å¤„ç†ç­–ç•¥ï¼š
        // 1. è®°å½•è¯¦ç»†æ—¥å¿—
        // 2. å‘é€å‘Šè­¦é€šçŸ¥
        // 3. å°è¯•è¡¥å¿æ“ä½œ
        // 4. æ›´æ–°äº‹ä»¶çŠ¶æ€ä¸ºå¤±è´¥
        
        try {
            // å°è¯•è¡¥å¿æ“ä½œ
            compensationService.compensate(event);
        } catch (Exception compensationError) {
            log.error("è¡¥å¿æ“ä½œä¹Ÿå¤±è´¥äº†", compensationError);
            // å‘é€ç´§æ€¥å‘Šè­¦
            alertService.sendUrgentAlert("ç”¨æˆ·æ³¨å†Œå¼‚æ­¥å¤„ç†å¤±è´¥ä¸”è¡¥å¿å¤±è´¥");
        }
    }
}
```

---

## 9. ğŸš€ å®æˆ˜åº”ç”¨åœºæ™¯


### 9.1 ç”µå•†è®¢å•å¤„ç†ç³»ç»Ÿ


```java
// è®¢å•äº‹ä»¶
public class OrderCreatedEvent extends ApplicationEvent {
    private Long orderId;
    private Long customerId;
    private BigDecimal amount;
    private List<OrderItem> items;
    
    // æ„é€ æ–¹æ³•å’Œgetter...
}

// è®¢å•æœåŠ¡
@Service
public class OrderService {
    
    @Transactional
    public Order createOrder(CreateOrderRequest request) {
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order(request);
        orderRepository.save(order);
        
        // 2. å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
        publisher.publishEvent(new OrderCreatedEvent(this, 
            order.getId(), 
            order.getCustomerId(), 
            order.getAmount(), 
            order.getItems()));
            
        return order;
    }
}

// å„ç§ä¸šåŠ¡ç›‘å¬å™¨
@Component
public class OrderBusinessListeners {
    
    // åº“å­˜æ‰£å‡ï¼ˆåŒæ­¥ï¼Œå¿…é¡»æˆåŠŸï¼‰
    @TransactionalEventListener(phase = TransactionPhase.BEFORE_COMMIT)
    @Order(1)
    public void reduceInventory(OrderCreatedEvent event) {
        for (OrderItem item : event.getItems()) {
            inventoryService.reduceStock(item.getProductId(), item.getQuantity());
        }
    }
    
    // å‘é€è®¢å•ç¡®è®¤é‚®ä»¶ï¼ˆå¼‚æ­¥ï¼‰
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    @Async
    public void sendOrderConfirmation(OrderCreatedEvent event) {
        emailService.sendOrderConfirmation(event.getCustomerId(), event.getOrderId());
    }
    
    // æ›´æ–°ç”¨æˆ·ç§¯åˆ†ï¼ˆå¼‚æ­¥ï¼‰
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    @Async
    public void updateUserPoints(OrderCreatedEvent event) {
        pointsService.addPoints(event.getCustomerId(), event.getAmount());
    }
    
    // æ¨é€æ¶ˆæ¯ç»™ä»“åº“ï¼ˆå¼‚æ­¥ï¼‰
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)  
    @Async
    public void notifyWarehouse(OrderCreatedEvent event) {
        warehouseService.notifyPickup(event.getOrderId());
    }
}
```

### 9.2 ç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿ


```java
// ç”¨æˆ·è¡Œä¸ºäº‹ä»¶
public class UserBehaviorEvent extends ApplicationEvent {
    private Long userId;
    private String action;      // è¡Œä¸ºç±»å‹ï¼šlogin, view, purchaseç­‰
    private String resourceId;  // èµ„æºIDï¼šå•†å“IDã€é¡µé¢IDç­‰
    private Map<String, Object> properties; // é¢å¤–å±æ€§
    
    // æ„é€ æ–¹æ³•å’Œgetter...
}

// è¡Œä¸ºæ”¶é›†æœåŠ¡
@Service
public class BehaviorTrackingService {
    
    public void trackUserBehavior(Long userId, String action, String resourceId, Map<String, Object> properties) {
        // å‘å¸ƒè¡Œä¸ºäº‹ä»¶
        UserBehaviorEvent event = new UserBehaviorEvent(this, userId, action, resourceId, properties);
        publisher.publishEvent(event);
    }
}

// å„ç§åˆ†æç›‘å¬å™¨
@Component
public class BehaviorAnalysisListeners {
    
    // å®æ—¶æ•°æ®ç»Ÿè®¡
    @EventListener
    @Async
    public void updateRealtimeStats(UserBehaviorEvent event) {
        statisticsService.updateRealtimeData(event.getAction(), event.getResourceId());
    }
    
    // ç”¨æˆ·ç”»åƒæ›´æ–°
    @EventListener
    @Async
    public void updateUserProfile(UserBehaviorEvent event) {
        userProfileService.updateBehaviorProfile(event.getUserId(), event);
    }
    
    // æ¨èç®—æ³•æ•°æ®æ”¶é›†
    @EventListener
    @Async
    public void collectRecommendationData(UserBehaviorEvent event) {
        recommendationService.addBehaviorData(event);
    }
    
    // å¼‚å¸¸è¡Œä¸ºæ£€æµ‹
    @EventListener
    public void detectAnomalBehavior(UserBehaviorEvent event) {
        if (anomalDetectionService.isAnomal(event)) {
            // å‘å¸ƒå¼‚å¸¸è¡Œä¸ºäº‹ä»¶
            publisher.publishEvent(new AnomalBehaviorEvent(this, event));
        }
    }
}
```

### 9.3 ç³»ç»Ÿç›‘æ§å‘Šè­¦


```java
// ç³»ç»ŸæŒ‡æ ‡äº‹ä»¶
public class SystemMetricEvent extends ApplicationEvent {
    private String metricName;
    private Double value;
    private String instanceId;
    private Date timestamp;
    
    // æ„é€ æ–¹æ³•å’Œgetter...
}

// ç›‘æ§æ•°æ®æ”¶é›†
@Component
public class SystemMonitoringListeners {
    
    // CPUä½¿ç”¨ç‡ç›‘æ§
    @EventListener(condition = "#event.metricName == 'cpu.usage' && #event.value > 80")
    public void handleHighCpuUsage(SystemMetricEvent event) {
        alertService.sendAlert("CPUä½¿ç”¨ç‡è¿‡é«˜", event.getInstanceId(), event.getValue());
    }
    
    // å†…å­˜ä½¿ç”¨ç›‘æ§  
    @EventListener(condition = "#event.metricName == 'memory.usage' && #event.value > 85")
    public void handleHighMemoryUsage(SystemMetricEvent event) {
        alertService.sendAlert("å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜", event.getInstanceId(), event.getValue());
    }
    
    // ç£ç›˜ç©ºé—´ç›‘æ§
    @EventListener(condition = "#event.metricName == 'disk.usage' && #event.value > 90")
    public void handleLowDiskSpace(SystemMetricEvent event) {
        alertService.sendUrgentAlert("ç£ç›˜ç©ºé—´ä¸è¶³", event.getInstanceId(), event.getValue());
    }
    
    // æ•°æ®æŒä¹…åŒ–
    @EventListener
    @Async
    public void persistMetricData(SystemMetricEvent event) {
        metricRepository.save(new MetricData(event));
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ äº‹ä»¶é©±åŠ¨æœ¬è´¨ï¼šå‘å¸ƒè€…ä¸ç›‘å¬è€…è§£è€¦ï¼Œä¸€äº‹å¤šåº”
ğŸ”¸ Springäº‹ä»¶ä½“ç³»ï¼šApplicationEvent + ApplicationListener + ApplicationEventPublisher
ğŸ”¸ è‡ªå®šä¹‰äº‹ä»¶ï¼šç»§æ‰¿ApplicationEventï¼Œæ‰¿è½½ä¸šåŠ¡æ•°æ®
ğŸ”¸ @EventListenerï¼šç®€åŒ–ç›‘å¬å™¨å¼€å‘ï¼Œæ”¯æŒæ¡ä»¶è¿‡æ»¤
ğŸ”¸ @TransactionalEventListenerï¼šäº‹åŠ¡å®‰å…¨çš„äº‹ä»¶å¤„ç†
ğŸ”¸ å¼‚æ­¥å¤„ç†ï¼š@Asyncæå‡æ€§èƒ½ï¼Œä½†éœ€æ³¨æ„å¼‚å¸¸å¤„ç†
ğŸ”¸ é¡ºåºæ§åˆ¶ï¼š@Orderæ§åˆ¶æ‰§è¡Œé¡ºåºï¼Œå¼‚æ­¥æ— æ•ˆ
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šåŒæ­¥å¼‚å¸¸ä¼šä¼ æ’­ï¼Œå¼‚æ­¥å¼‚å¸¸éœ€è‡ªè¡Œå¤„ç†
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ äº‹ä»¶é©±åŠ¨çš„ä»·å€¼**
```
è§£è€¦åˆï¼š
â€¢ æ³¨å†ŒæœåŠ¡ä¸éœ€è¦çŸ¥é“è¦å‘é‚®ä»¶ã€å‘çŸ­ä¿¡
â€¢ æ·»åŠ æ–°åŠŸèƒ½åªéœ€æ–°å¢ç›‘å¬å™¨
â€¢ æ¨¡å—é—´ä¾èµ–å…³ç³»å¤§å¤§é™ä½

æ‰©å±•æ€§ï¼š
â€¢ éœ€æ±‚å˜æ›´æ—¶å½±å“é¢å°
â€¢ æ–°åŠŸèƒ½å¼€å‘ç‹¬ç«‹è¿›è¡Œ
â€¢ ç³»ç»Ÿæ¶æ„æ›´åŠ çµæ´»

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ å¼‚æ­¥å¤„ç†æå‡å“åº”é€Ÿåº¦
â€¢ äº‹åŠ¡äº‹ä»¶ä¿è¯æ•°æ®ä¸€è‡´æ€§
â€¢ åˆç†çš„çº¿ç¨‹æ± é…ç½®é¿å…èµ„æºæµªè´¹
```

**ğŸ”¹ äº‹åŠ¡äº‹ä»¶çš„é‡è¦æ€§**
```
æ•°æ®ä¸€è‡´æ€§ï¼š
â€¢ é¿å…"æ•°æ®æœªä¿å­˜ï¼Œé€šçŸ¥å·²å‘é€"çš„é—®é¢˜
â€¢ ç¡®ä¿ä¸šåŠ¡é€»è¾‘çš„åŸå­æ€§
â€¢ æä¾›å¤šç§äº‹åŠ¡é˜¶æ®µçš„å¤„ç†æ—¶æœº

ä¸šåŠ¡å®Œæ•´æ€§ï¼š
â€¢ AFTER_COMMITï¼šç¡®ä¿æ•°æ®å·²ä¿å­˜å†æ‰§è¡Œåç»­æ“ä½œ
â€¢ AFTER_ROLLBACKï¼šå¤„ç†å¤±è´¥æƒ…å†µï¼Œæ‰§è¡Œè¡¥å¿é€»è¾‘
â€¢ BEFORE_COMMITï¼šæœ€åçš„æ•°æ®éªŒè¯æœºä¼š
```

**ğŸ”¹ å¼‚æ­¥å¤„ç†çš„å¹³è¡¡**
```
æ€§èƒ½vså¯é æ€§ï¼š
â€¢ å¼‚æ­¥æå‡æ€§èƒ½ä½†å¢åŠ å¤æ‚æ€§
â€¢ éœ€è¦å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
â€¢ ç›‘æ§å’Œæ—¥å¿—å˜å¾—æ›´åŠ é‡è¦

åŒæ­¥vså¼‚æ­¥çš„é€‰æ‹©ï¼š
â€¢ å…³é”®ä¸šåŠ¡é€»è¾‘ï¼šåŒæ­¥å¤„ç†
â€¢ é€šçŸ¥å‘é€ç±»ï¼šå¼‚æ­¥å¤„ç†
â€¢ æ•°æ®ç»Ÿè®¡ç±»ï¼šå¼‚æ­¥å¤„ç†
â€¢ å¤–éƒ¨ç³»ç»Ÿè°ƒç”¨ï¼šæ ¹æ®é‡è¦æ€§å†³å®š
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… é€‚ç”¨åœºæ™¯**ï¼š
- ä¸šåŠ¡æµç¨‹ä¸­çš„åç»­å¤„ç†ï¼ˆæ³¨å†Œåå‘é‚®ä»¶ï¼‰
- ç³»ç»Ÿè§£è€¦å’Œæ¨¡å—åŒ–è®¾è®¡
- å¼‚æ­¥ä»»åŠ¡å’Œæ€§èƒ½ä¼˜åŒ–  
- æ•°æ®åŒæ­¥å’ŒçŠ¶æ€é€šçŸ¥
- ç›‘æ§å‘Šè­¦å’Œæ—¥å¿—è®°å½•

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
- ä¸è¦è¿‡åº¦ä½¿ç”¨ï¼Œç®€å•åœºæ™¯ç›´æ¥è°ƒç”¨å³å¯
- å¼‚æ­¥äº‹ä»¶è¦åšå¥½å¼‚å¸¸å¤„ç†å’Œç›‘æ§
- äº‹ä»¶æ•°æ®è¦åŒ…å«è¶³å¤Ÿçš„ä¸šåŠ¡ä¿¡æ¯
- è€ƒè™‘äº‹ä»¶çš„é¡ºåºä¾èµ–å…³ç³»
- åˆç†é…ç½®çº¿ç¨‹æ± é¿å…èµ„æºè€—å°½

**ğŸ› ï¸ å¼€å‘å»ºè®®**ï¼š
```java
// å¥½çš„å®è·µç¤ºä¾‹
@Component
public class BestPracticeListener {
    
    private static final Logger log = LoggerFactory.getLogger(BestPracticeListener.class);
    
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    @Async
    @Order(1)
    public void handleEventWithBestPractice(BusinessEvent event) {
        try {
            // 1. è®°å½•å¼€å§‹å¤„ç†
            log.info("å¼€å§‹å¤„ç†ä¸šåŠ¡äº‹ä»¶ï¼š{}", event.getEventId());
            
            // 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            businessService.processEvent(event);
            
            // 3. è®°å½•å¤„ç†æˆåŠŸ
            log.info("ä¸šåŠ¡äº‹ä»¶å¤„ç†å®Œæˆï¼š{}", event.getEventId());
            
        } catch (Exception e) {
            // 4. å¼‚å¸¸å¤„ç†
            log.error("ä¸šåŠ¡äº‹ä»¶å¤„ç†å¤±è´¥ï¼š{}", event.getEventId(), e);
            
            // 5. å‘å¸ƒé”™è¯¯äº‹ä»¶æˆ–å‘Šè­¦
            publisher.publishEvent(new EventProcessingErrorEvent(this, event, e));
        }
    }
}
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- äº‹ä»¶é©±åŠ¨è§£è€¦åˆï¼Œä¸€å‘å¤šå¬å¥½æ‰©å±•
- åŒæ­¥å¼‚æ­¥éœ€åˆ†æ¸…ï¼Œäº‹åŠ¡å®‰å…¨è¦ä¿è¯
- é¡ºåºå¼‚å¸¸è¦å¤„ç†ï¼Œç›‘æ§æ—¥å¿—ä¸å¯å°‘
- é€‚åº¦ä½¿ç”¨æ˜¯å…³é”®ï¼Œè¿‡çŠ¹ä¸åŠè¦é¿å…