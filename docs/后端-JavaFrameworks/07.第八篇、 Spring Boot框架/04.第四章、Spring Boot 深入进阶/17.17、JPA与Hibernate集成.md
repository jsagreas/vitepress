---
title: 17ã€JPAä¸Hibernateé›†æˆ
---
## ğŸ“š ç›®å½•

1. [JPAä¸HibernateåŸºç¡€æ¦‚å¿µ](#1-JPAä¸HibernateåŸºç¡€æ¦‚å¿µ)
2. [Spring Boot JPAå¿«é€Ÿé›†æˆ](#2-Spring-Boot-JPAå¿«é€Ÿé›†æˆ)
3. [JPAå®ä½“æ˜ å°„é…ç½®è¯¦è§£](#3-JPAå®ä½“æ˜ å°„é…ç½®è¯¦è§£)
4. [Repositoryæ¥å£æ‰©å±•ä¸è‡ªå®šä¹‰](#4-Repositoryæ¥å£æ‰©å±•ä¸è‡ªå®šä¹‰)
5. [è‡ªå®šä¹‰æŸ¥è¯¢æ–¹æ³•å®æˆ˜](#5-è‡ªå®šä¹‰æŸ¥è¯¢æ–¹æ³•å®æˆ˜)
6. [åˆ†é¡µä¸æ’åºå¤„ç†æŠ€å·§](#6-åˆ†é¡µä¸æ’åºå¤„ç†æŠ€å·§)
7. [æ‡’åŠ è½½ä¸N+1é—®é¢˜è§£å†³](#7-æ‡’åŠ è½½ä¸N+1é—®é¢˜è§£å†³)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ JPAä¸HibernateåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯JPAï¼Ÿ


**ğŸ”¸ é€šä¿—ç†è§£**
JPAå°±åƒæ˜¯ä¸€ä¸ª"æ•°æ®åº“æ“ä½œçš„ç»Ÿä¸€æ ‡å‡†"ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆï¼š
- ä½ è¦å»ä¸åŒçš„é“¶è¡ŒåŠä¸šåŠ¡ï¼Œæ¯ä¸ªé“¶è¡Œçš„æµç¨‹éƒ½ä¸ä¸€æ ·
- JPAå°±æ˜¯åˆ¶å®šäº†ä¸€å¥—ç»Ÿä¸€çš„åŠäº‹æµç¨‹
- ä¸ç®¡å»å“ªä¸ªé“¶è¡Œï¼Œéƒ½ç”¨è¿™å¥—æ ‡å‡†æµç¨‹

**ğŸ“‹ ä¸“ä¸šå®šä¹‰**
```
JPAï¼ˆJava Persistence APIï¼‰ï¼šJavaæŒä¹…åŒ–API
ä½œç”¨ï¼šå®šä¹‰äº†Javaå¯¹è±¡ä¸å…³ç³»æ•°æ®åº“ä¹‹é—´çš„æ˜ å°„æ ‡å‡†
æœ¬è´¨ï¼šåªæ˜¯è§„èŒƒæ¥å£ï¼Œä¸æ˜¯å…·ä½“å®ç°
```

### 1.2 ä»€ä¹ˆæ˜¯Hibernateï¼Ÿ


**ğŸ”¸ é€šä¿—ç†è§£**
Hibernateæ˜¯JPAæ ‡å‡†çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œå°±åƒï¼š
- JPAæ˜¯"åšèœçš„èœè°±"ï¼ˆæ ‡å‡†ï¼‰
- Hibernateæ˜¯"çœŸæ­£çš„å¨å¸ˆ"ï¼ˆå®ç°è€…ï¼‰
- å¨å¸ˆæŒ‰ç…§èœè°±åšå‡ºçœŸæ­£çš„èœ

**ğŸ“‹ ä¸“ä¸šå®šä¹‰**
```
Hibernateï¼šJPAè§„èŒƒçš„å…·ä½“å®ç°æ¡†æ¶
åŠŸèƒ½ï¼šå°†Javaå¯¹è±¡è‡ªåŠ¨è½¬æ¢ä¸ºSQLè¯­å¥æ“ä½œæ•°æ®åº“
ä¼˜åŠ¿ï¼šæˆç†Ÿç¨³å®šï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œç”Ÿæ€ä¸°å¯Œ
```

### 1.3 å®ƒä»¬ä¹‹é—´çš„å…³ç³»å›¾


```
åº”ç”¨ç¨‹åº
    â†“
JPAæ¥å£ï¼ˆæ ‡å‡†è§„èŒƒï¼‰
    â†“
Hibernateå®ç°ï¼ˆå…·ä½“å¹²æ´»çš„ï¼‰
    â†“
JDBCé©±åŠ¨
    â†“
æ•°æ®åº“ï¼ˆMySQLã€PostgreSQLç­‰ï¼‰
```

**ğŸ’¡ å…³ç³»è§£æ**
- **åº”ç”¨å±‚**ï¼šä½ å†™çš„ä¸šåŠ¡ä»£ç 
- **JPAå±‚**ï¼šç»Ÿä¸€çš„æ“ä½œæ¥å£
- **Hibernateå±‚**ï¼šçœŸæ­£æ‰§è¡Œæ•°æ®åº“æ“ä½œ
- **æ•°æ®åº“å±‚**ï¼šå­˜å‚¨æ•°æ®çš„åœ°æ–¹

---

## 2. ğŸš€ Spring Boot JPAå¿«é€Ÿé›†æˆ


### 2.1 æ·»åŠ ä¾èµ–é…ç½®


**ğŸ“¦ Mavenä¾èµ–**
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
</dependency>
```

**ğŸ” ä¾èµ–è¯´æ˜**
- `spring-boot-starter-data-jpa`ï¼šåŒ…å«äº†JPAã€Hibernateã€Spring Data JPAçš„å®Œæ•´å¥—ä»¶
- `mysql-connector-java`ï¼šMySQLæ•°æ®åº“é©±åŠ¨ï¼Œè¿æ¥æ•°æ®åº“å¿…éœ€

### 2.2 æ•°æ®åº“è¿æ¥é…ç½®


**âš™ï¸ application.ymlé…ç½®**
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/demo_db?useUnicode=true&characterEncoding=utf8
    username: root
    password: 123456
    driver-class-name: com.mysql.cj.jdbc.Driver
  
  jpa:
    hibernate:
      ddl-auto: update        # è‡ªåŠ¨å»ºè¡¨æ¨¡å¼
    show-sql: true           # æ˜¾ç¤ºSQLè¯­å¥
    properties:
      hibernate:
        format_sql: true     # æ ¼å¼åŒ–SQLè¯­å¥
```

**ğŸ”§ é…ç½®è¯¦è§£**

| é…ç½®é¡¹ | å«ä¹‰ | å¸¸ç”¨å€¼ |
|--------|------|--------|
| `ddl-auto` | è¡¨ç»“æ„ç®¡ç†ç­–ç•¥ | `create` `update` `none` |
| `show-sql` | æ˜¯å¦æ‰“å°SQL | `true` `false` |
| `format_sql` | æ˜¯å¦æ ¼å¼åŒ–SQL | `true` `false` |

**âš ï¸ é‡è¦æé†’**
- **å¼€å‘ç¯å¢ƒ**ï¼šå¯ä»¥ç”¨ `update`ï¼Œä¼šè‡ªåŠ¨æ›´æ–°è¡¨ç»“æ„
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šå»ºè®®ç”¨ `none`ï¼Œé¿å…æ„å¤–ä¿®æ”¹è¡¨ç»“æ„

### 2.3 å¿«é€ŸéªŒè¯é…ç½®


**ğŸ”¬ åˆ›å»ºæµ‹è¯•å®ä½“**
```java
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    private String email;
    
    // æ„é€ å‡½æ•°ã€getterã€setterçœç•¥...
}
```

å¯åŠ¨é¡¹ç›®åï¼Œå¦‚æœæ²¡æœ‰æŠ¥é”™ä¸”æ•°æ®åº“ä¸­è‡ªåŠ¨åˆ›å»ºäº† `users` è¡¨ï¼Œè¯´æ˜é…ç½®æˆåŠŸï¼

---

## 3. ğŸ“‹ JPAå®ä½“æ˜ å°„é…ç½®è¯¦è§£


### 3.1 åŸºç¡€æ³¨è§£è¯¦è§£


**ğŸ·ï¸ æ ¸å¿ƒæ³¨è§£è¯´æ˜**

```java
@Entity                    // æ ‡è®°è¿™æ˜¯ä¸€ä¸ªæ•°æ®åº“å®ä½“ç±»
@Table(name = "t_user")   // æŒ‡å®šæ•°æ®åº“è¡¨åï¼Œä¸å†™é»˜è®¤ç”¨ç±»å
public class User {
    
    @Id                           // ä¸»é”®æ ‡è®°
    @GeneratedValue(strategy = GenerationType.IDENTITY)  // ä¸»é”®ç”Ÿæˆç­–ç•¥
    private Long id;
    
    @Column(name = "user_name", length = 50, nullable = false)  // åˆ—æ˜ å°„
    private String name;
    
    @Column(unique = true)        // å”¯ä¸€çº¦æŸ
    private String email;
    
    @Temporal(TemporalType.TIMESTAMP)  // æ—¥æœŸæ—¶é—´ç±»å‹
    private Date createTime;
}
```

**ğŸ“Š æ³¨è§£å¯¹æ¯”è¡¨**

| æ³¨è§£ | ä½œç”¨ | ğŸŒŸ é‡è¦ç¨‹åº¦ | ç¤ºä¾‹ |
|------|------|-----------|------|
| `@Entity` | æ ‡è®°å®ä½“ç±» | â­â­â­ | å¿…é¡»è¦æœ‰ |
| `@Table` | æŒ‡å®šè¡¨å | â­â­ | `@Table(name="t_user")` |
| `@Id` | æ ‡è®°ä¸»é”® | â­â­â­ | æ¯ä¸ªå®ä½“å¿…é¡»æœ‰ |
| `@Column` | åˆ—å±æ€§é…ç½® | â­â­ | `@Column(length=50)` |

### 3.2 ä¸»é”®ç”Ÿæˆç­–ç•¥


**ğŸ”‘ å››ç§ç”Ÿæˆç­–ç•¥å¯¹æ¯”**

```java
// 1. è‡ªå¢ä¸»é”®ï¼ˆæœ€å¸¸ç”¨ï¼‰
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;

// 2. åºåˆ—ç”Ÿæˆï¼ˆOracleå¸¸ç”¨ï¼‰
@GeneratedValue(strategy = GenerationType.SEQUENCE)
private Long id;

// 3. è¡¨ç”Ÿæˆå™¨ï¼ˆé€šç”¨ä½†æ€§èƒ½å·®ï¼‰
@GeneratedValue(strategy = GenerationType.TABLE)
private Long id;

// 4. è‡ªåŠ¨é€‰æ‹©ï¼ˆè®©JPAè‡ªå·±å†³å®šï¼‰
@GeneratedValue(strategy = GenerationType.AUTO)
private Long id;
```

**ğŸ’¡ é€‰æ‹©å»ºè®®**
- **MySQLæ•°æ®åº“**ï¼šç”¨ `IDENTITY`ï¼ˆè‡ªå¢ä¸»é”®ï¼‰
- **Oracleæ•°æ®åº“**ï¼šç”¨ `SEQUENCE`ï¼ˆåºåˆ—ï¼‰
- **ä¸ç¡®å®šæ•°æ®åº“**ï¼šç”¨ `AUTO`ï¼ˆè‡ªåŠ¨é€‰æ‹©ï¼‰

### 3.3 å®ä½“å…³ç³»æ˜ å°„


**ğŸ‘¥ ä¸€å¯¹ä¸€å…³ç³»**
```java
@Entity
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @OneToOne(cascade = CascadeType.ALL)
    @JoinColumn(name = "profile_id")    // å¤–é”®å­—æ®µ
    private UserProfile profile;
}

@Entity  
public class UserProfile {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String avatar;
    private String bio;
}
```

**ğŸ‘¥ ä¸€å¯¹å¤šå…³ç³»**
```java
@Entity
public class Department {
    @Id
    private Long id;
    
    @OneToMany(mappedBy = "department", cascade = CascadeType.ALL)
    private List<Employee> employees;
}

@Entity
public class Employee {
    @Id  
    private Long id;
    
    @ManyToOne
    @JoinColumn(name = "dept_id")
    private Department department;
}
```

---

## 4. ğŸ› ï¸ Repositoryæ¥å£æ‰©å±•ä¸è‡ªå®šä¹‰


### 4.1 Repositoryç»§æ‰¿ä½“ç³»


**ğŸ—ï¸ Repositoryå®¶æ—ç»“æ„å›¾**
```
Repository<T, ID>
    â†“
CrudRepository<T, ID>         â† åŸºç¡€CRUDæ“ä½œ
    â†“  
PagingAndSortingRepository<T, ID>  â† åˆ†é¡µæ’åºæ”¯æŒ  
    â†“
JpaRepository<T, ID>          â† å®Œæ•´åŠŸèƒ½ï¼ˆæ¨èä½¿ç”¨ï¼‰
```

**ğŸ“‹ æ¥å£åŠŸèƒ½å¯¹æ¯”**

| æ¥å£ | ğŸ”¸ ä¸»è¦åŠŸèƒ½ | ğŸ¯ é€‚ç”¨åœºæ™¯ | â­ æ¨èåº¦ |
|------|------------|-----------|---------|
| `Repository` | æ ‡è®°æ¥å£ï¼Œæ— æ–¹æ³• | å®Œå…¨è‡ªå®šä¹‰ | â­ |
| `CrudRepository` | åŸºç¡€å¢åˆ æ”¹æŸ¥ | ç®€å•æ“ä½œ | â­â­ |
| `PagingAndSortingRepository` | å¢åŠ åˆ†é¡µæ’åº | éœ€è¦åˆ†é¡µ | â­â­â­ |
| `JpaRepository` | åŠŸèƒ½æœ€å…¨ | ä¸€èˆ¬æ¨è | â­â­â­ |

### 4.2 åˆ›å»ºRepositoryæ¥å£


**ğŸ’» æ ‡å‡†Repositoryå†™æ³•**
```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    // ç»§æ‰¿JpaRepositoryåï¼Œè‡ªåŠ¨è·å¾—ä»¥ä¸‹æ–¹æ³•ï¼š
    // save()ã€findById()ã€findAll()ã€deleteById()ç­‰
}
```

**ğŸ¯ ä¸ºä»€ä¹ˆæ¨èJpaRepositoryï¼Ÿ**
- âœ… **åŠŸèƒ½æœ€å…¨**ï¼šåŒ…å«æ‰€æœ‰åŸºç¡€æ“ä½œ
- âœ… **æ”¯æŒæ‰¹é‡**ï¼šbatchæ“ä½œæ•ˆç‡é«˜
- âœ… **è‡ªåŠ¨flush**ï¼šç«‹å³åŒæ­¥åˆ°æ•°æ®åº“

### 4.3 Repositoryæ–¹æ³•ä¸€è§ˆ


**ğŸ“Š JpaRepositoryæä¾›çš„æ–¹æ³•**
```java
// ä¿å­˜æ“ä½œ
User save(User user);                    // ä¿å­˜æˆ–æ›´æ–°
List<User> saveAll(Iterable<User> users); // æ‰¹é‡ä¿å­˜

// æŸ¥è¯¢æ“ä½œ  
Optional<User> findById(Long id);        // æ ¹æ®IDæŸ¥è¯¢
List<User> findAll();                    // æŸ¥è¯¢æ‰€æœ‰
Page<User> findAll(Pageable pageable);   // åˆ†é¡µæŸ¥è¯¢

// åˆ é™¤æ“ä½œ
void deleteById(Long id);                // æ ¹æ®IDåˆ é™¤  
void delete(User user);                  // åˆ é™¤å®ä½“
void deleteAll();                        // åˆ é™¤æ‰€æœ‰

// åˆ¤æ–­æ“ä½œ
boolean existsById(Long id);             // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
long count();                            // ç»Ÿè®¡æ•°é‡
```

---

## 5. ğŸ” è‡ªå®šä¹‰æŸ¥è¯¢æ–¹æ³•å®æˆ˜


### 5.1 æ–¹æ³•åæŸ¥è¯¢ï¼ˆæœ€ç®€å•ï¼‰


**ğŸ¯ å‘½åè§„åˆ™**
Spring Data JPAä¼šæ ¹æ®æ–¹æ³•åè‡ªåŠ¨ç”ŸæˆSQLè¯­å¥ï¼Œå°±åƒ"ç¿»è¯‘å®˜"ä¸€æ ·ï¼š

```java
public interface UserRepository extends JpaRepository<User, Long> {
    
    // findBy + å­—æ®µå = æŸ¥è¯¢æ¡ä»¶
    List<User> findByName(String name);
    // ç¿»è¯‘ï¼šSELECT * FROM user WHERE name = ?
    
    // Andè¿æ¥å¤šä¸ªæ¡ä»¶  
    List<User> findByNameAndEmail(String name, String email);
    // ç¿»è¯‘ï¼šSELECT * FROM user WHERE name = ? AND email = ?
    
    // Orè¿æ¥æ¡ä»¶
    List<User> findByNameOrEmail(String name, String email);  
    // ç¿»è¯‘ï¼šSELECT * FROM user WHERE name = ? OR email = ?
    
    // Likeæ¨¡ç³ŠæŸ¥è¯¢
    List<User> findByNameContaining(String keyword);
    // ç¿»è¯‘ï¼šSELECT * FROM user WHERE name LIKE '%keyword%'
    
    // æ’åº
    List<User> findByNameOrderByCreateTimeDesc(String name);
    // ç¿»è¯‘ï¼šSELECT * FROM user WHERE name = ? ORDER BY create_time DESC
}
```

**ğŸ“‹ å¸¸ç”¨å…³é”®å­—å¯¹ç…§è¡¨**

| å…³é”®å­— | ç¤ºä¾‹ | ç”ŸæˆSQL | ğŸ”¸ ç”¨é€” |
|--------|------|---------|--------|
| `findBy` | `findByName` | `WHERE name = ?` | ç­‰å€¼æŸ¥è¯¢ |
| `And` | `findByNameAndAge` | `WHERE name = ? AND age = ?` | ä¸”æ¡ä»¶ |
| `Or` | `findByNameOrEmail` | `WHERE name = ? OR email = ?` | æˆ–æ¡ä»¶ |
| `Between` | `findByAgeBetween` | `WHERE age BETWEEN ? AND ?` | èŒƒå›´æŸ¥è¯¢ |
| `LessThan` | `findByAgeLessThan` | `WHERE age < ?` | å°äº |
| `GreaterThan` | `findByAgeGreaterThan` | `WHERE age > ?` | å¤§äº |
| `Like` | `findByNameLike` | `WHERE name LIKE ?` | æ¨¡ç³ŠæŸ¥è¯¢ |
| `Containing` | `findByNameContaining` | `WHERE name LIKE '%?%'` | åŒ…å« |
| `StartingWith` | `findByNameStartingWith` | `WHERE name LIKE '?%'` | å¼€å¤´åŒ¹é… |
| `EndingWith` | `findByNameEndingWith` | `WHERE name LIKE '%?'` | ç»“å°¾åŒ¹é… |
| `OrderBy` | `findByNameOrderByAgeDesc` | `ORDER BY age DESC` | æ’åº |

### 5.2 @Queryæ³¨è§£æŸ¥è¯¢ï¼ˆæ›´çµæ´»ï¼‰


**âœï¸ JPQLæŸ¥è¯¢ï¼ˆæ¨èï¼‰**
```java
public interface UserRepository extends JpaRepository<User, Long> {
    
    // JPQLæŸ¥è¯¢ï¼ˆé¢å‘å¯¹è±¡çš„SQLï¼‰
    @Query("SELECT u FROM User u WHERE u.name = ?1")
    List<User> findByNameJPQL(String name);
    
    // å‘½åå‚æ•°ï¼ˆæ›´æ¸…æ™°ï¼‰
    @Query("SELECT u FROM User u WHERE u.name = :name AND u.age > :age")
    List<User> findByNameAndAgeGreaterThan(@Param("name") String name, 
                                          @Param("age") Integer age);
    
    // æ›´æ–°æ“ä½œ
    @Modifying
    @Query("UPDATE User u SET u.name = :name WHERE u.id = :id")
    int updateNameById(@Param("id") Long id, @Param("name") String name);
}
```

**ğŸ—ƒï¸ åŸç”ŸSQLæŸ¥è¯¢ï¼ˆç‰¹æ®Šæƒ…å†µç”¨ï¼‰**
```java
@Query(value = "SELECT * FROM users WHERE name = ?1", nativeQuery = true)
List<User> findByNameNative(String name);

// å¤æ‚ç»Ÿè®¡æŸ¥è¯¢
@Query(value = "SELECT COUNT(*) FROM users WHERE create_time > ?1", nativeQuery = true)
Long countUsersCreatedAfter(Date date);
```

**ğŸ’¡ JPQL vs åŸç”ŸSQLé€‰æ‹©**
- **JPQLä¼˜ç‚¹**ï¼šæ•°æ®åº“æ— å…³ï¼Œé¢å‘å¯¹è±¡ï¼Œç±»å‹å®‰å…¨
- **åŸç”ŸSQLä¼˜ç‚¹**ï¼šåŠŸèƒ½å¼ºå¤§ï¼Œå¤æ‚æŸ¥è¯¢ï¼Œæ•°æ®åº“ç‰¹æ€§
- **å»ºè®®**ï¼šä¼˜å…ˆJPQLï¼Œå¤æ‚åœºæ™¯ç”¨åŸç”ŸSQL

### 5.3 åŠ¨æ€æŸ¥è¯¢ï¼ˆé«˜çº§ç”¨æ³•ï¼‰


**ğŸ”§ SpecificationåŠ¨æ€æŸ¥è¯¢**
```java
public interface UserRepository extends JpaRepository<User, Long>, JpaSpecificationExecutor<User> {
    // ç»§æ‰¿JpaSpecificationExecutorè·å¾—åŠ¨æ€æŸ¥è¯¢èƒ½åŠ›
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class UserService {
    
    public List<User> findUsersWithConditions(String name, Integer minAge, String email) {
        return userRepository.findAll((root, query, cb) -> {
            List<Predicate> predicates = new ArrayList<>();
            
            // åŠ¨æ€æ·»åŠ æŸ¥è¯¢æ¡ä»¶
            if (name != null) {
                predicates.add(cb.like(root.get("name"), "%" + name + "%"));
            }
            if (minAge != null) {
                predicates.add(cb.greaterThan(root.get("age"), minAge));
            }  
            if (email != null) {
                predicates.add(cb.equal(root.get("email"), email));
            }
            
            return cb.and(predicates.toArray(new Predicate[0]));
        });
    }
}
```

---

## 6. ğŸ“– åˆ†é¡µä¸æ’åºå¤„ç†æŠ€å·§


### 6.1 åŸºç¡€åˆ†é¡µæŸ¥è¯¢


**ğŸ“„ åˆ†é¡µåŸç†å›¾**
```
æ•°æ®åº“ä¸­æœ‰100æ¡è®°å½•ï¼š
[1][2][3]...[98][99][100]

åˆ†é¡µå‚æ•°ï¼špage=1, size=10
æŸ¥è¯¢ç»“æœï¼š[11][12][13]...[20]  ï¼ˆç¬¬2é¡µï¼Œæ¯é¡µ10æ¡ï¼‰

SQLç¿»è¯‘ï¼šSELECT * FROM user LIMIT 10 OFFSET 10
```

**ğŸ’» åˆ†é¡µæŸ¥è¯¢å®ç°**
```java
@RestController
public class UserController {
    
    @Autowired
    private UserRepository userRepository;
    
    @GetMapping("/users")
    public Page<User> getUsers(
        @RequestParam(defaultValue = "0") int page,      // é¡µç ï¼Œä»0å¼€å§‹
        @RequestParam(defaultValue = "10") int size,     // æ¯é¡µå¤§å°  
        @RequestParam(defaultValue = "id") String sort,  // æ’åºå­—æ®µ
        @RequestParam(defaultValue = "asc") String direction // æ’åºæ–¹å‘
    ) {
        // åˆ›å»ºåˆ†é¡µå‚æ•°
        Sort sortObj = Sort.by(Sort.Direction.fromString(direction), sort);
        Pageable pageable = PageRequest.of(page, size, sortObj);
        
        // æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢
        return userRepository.findAll(pageable);
    }
}
```

### 6.2 åˆ†é¡µç»“æœè¯¦è§£


**ğŸ“Š Pageå¯¹è±¡åŒ…å«çš„ä¿¡æ¯**
```java
Page<User> userPage = userRepository.findAll(pageable);

// è·å–åˆ†é¡µä¿¡æ¯
int currentPage = userPage.getNumber();        // å½“å‰é¡µç 
int totalPages = userPage.getTotalPages();     // æ€»é¡µæ•°  
long totalElements = userPage.getTotalElements(); // æ€»è®°å½•æ•°
int pageSize = userPage.getSize();             // æ¯é¡µå¤§å°
boolean hasNext = userPage.hasNext();          // æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
boolean hasPrevious = userPage.hasPrevious();  // æ˜¯å¦æœ‰ä¸Šä¸€é¡µ

// è·å–æ•°æ®
List<User> users = userPage.getContent();      // å½“å‰é¡µæ•°æ®
```

**ğŸ¯ åˆ†é¡µä¿¡æ¯JSONç¤ºä¾‹**
```json
{
  "content": [
    {"id": 1, "name": "å¼ ä¸‰", "email": "zhang@example.com"},
    {"id": 2, "name": "æå››", "email": "li@example.com"}
  ],
  "pageable": {
    "pageNumber": 0,
    "pageSize": 10
  },
  "totalElements": 25,
  "totalPages": 3,
  "last": false,
  "first": true,
  "numberOfElements": 10
}
```

### 6.3 æ’åºé«˜çº§ç”¨æ³•


**ğŸ”€ å¤šå­—æ®µæ’åº**
```java
// å¤åˆæ’åºï¼šå…ˆæŒ‰å¹´é¾„é™åºï¼Œå†æŒ‰å§“åå‡åº
Sort sort = Sort.by(
    Sort.Order.desc("age"),
    Sort.Order.asc("name")
);
Pageable pageable = PageRequest.of(0, 10, sort);
```

**ğŸ”§ è‡ªå®šä¹‰æ’åºé€»è¾‘**
```java
public interface UserRepository extends JpaRepository<User, Long> {
    
    // è‡ªå®šä¹‰æ’åºæŸ¥è¯¢
    @Query("SELECT u FROM User u WHERE u.status = :status ORDER BY u.createTime DESC, u.name ASC")
    Page<User> findByStatusWithCustomSort(@Param("status") String status, Pageable pageable);
}
```

---

## 7. âš¡ æ‡’åŠ è½½ä¸N+1é—®é¢˜è§£å†³


### 7.1 ä»€ä¹ˆæ˜¯æ‡’åŠ è½½ï¼Ÿ


**ğŸ”¸ é€šä¿—ç†è§£**
æ‡’åŠ è½½å°±åƒ"æŒ‰éœ€å–è´§"ï¼š
- ä½ å»è¶…å¸‚è´­ç‰©ï¼Œä¸æ˜¯ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰å•†å“éƒ½æ‹¿èµ°
- è€Œæ˜¯éœ€è¦ä»€ä¹ˆæ‰å»æ‹¿ä»€ä¹ˆ
- è¿™æ ·å¯ä»¥èŠ‚çœ"è´­ç‰©è½¦ç©ºé—´"ï¼ˆå†…å­˜ï¼‰

**ğŸ“‹ æŠ€æœ¯è§£é‡Š**
```java
@Entity
public class User {
    @Id
    private Long id;
    private String name;
    
    // æ‡’åŠ è½½ï¼šåªæœ‰è®¿é—®ordersæ—¶æ‰å»æ•°æ®åº“æŸ¥è¯¢
    @OneToMany(fetch = FetchType.LAZY, mappedBy = "user")
    private List<Order> orders;
}
```

**âš–ï¸ æ‡’åŠ è½½ vs ç«‹å³åŠ è½½**

| åŠ è½½æ–¹å¼ | ç‰¹ç‚¹ | ä¼˜ç‚¹ | ç¼ºç‚¹ | ä½¿ç”¨åœºæ™¯ |
|----------|------|------|------|----------|
| **æ‡’åŠ è½½** `LAZY` | éœ€è¦æ—¶æ‰æŸ¥è¯¢ | èŠ‚çœå†…å­˜ï¼Œæé«˜æ€§èƒ½ | å¯èƒ½äº§ç”ŸN+1é—®é¢˜ | å¤§å¤šæ•°æƒ…å†µ |
| **ç«‹å³åŠ è½½** `EAGER` | ç«‹å³æŸ¥è¯¢æ‰€æœ‰æ•°æ® | ä¸€æ¬¡æ€§è·å–å®Œæ•´æ•°æ® | æ¶ˆè€—å†…å­˜ï¼Œå¯èƒ½å¾ˆæ…¢ | å°æ•°æ®é‡ï¼Œå¿…éœ€æ•°æ® |

### 7.2 N+1é—®é¢˜è¯¦è§£


**â“ ä»€ä¹ˆæ˜¯N+1é—®é¢˜ï¼Ÿ**

æƒ³è±¡ä½ è¦æŸ¥è¯¢10ä¸ªç”¨æˆ·åŠå…¶è®¢å•ä¿¡æ¯ï¼š
```
ç¬¬1æ¬¡æŸ¥è¯¢ï¼šSELECT * FROM user LIMIT 10           // æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
ç¬¬2æ¬¡æŸ¥è¯¢ï¼šSELECT * FROM order WHERE user_id = 1  // æŸ¥è¯¢ç”¨æˆ·1çš„è®¢å•  
ç¬¬3æ¬¡æŸ¥è¯¢ï¼šSELECT * FROM order WHERE user_id = 2  // æŸ¥è¯¢ç”¨æˆ·2çš„è®¢å•
...
ç¬¬11æ¬¡æŸ¥è¯¢ï¼šSELECT * FROM order WHERE user_id = 10 // æŸ¥è¯¢ç”¨æˆ·10çš„è®¢å•

æ€»å…±æ‰§è¡Œï¼š1 + 10 = 11æ¬¡æŸ¥è¯¢ï¼ˆ1æ¬¡æŸ¥ç”¨æˆ· + Næ¬¡æŸ¥è®¢å•ï¼‰
```

**ğŸš¨ é—®é¢˜ä¸¥é‡æ€§**
- 10ä¸ªç”¨æˆ· â†’ 11æ¬¡æ•°æ®åº“æŸ¥è¯¢
- 1000ä¸ªç”¨æˆ· â†’ 1001æ¬¡æ•°æ®åº“æŸ¥è¯¢
- æ•°æ®åº“å‹åŠ›å·¨å¤§ï¼Œæ€§èƒ½æ€¥å‰§ä¸‹é™ï¼

### 7.3 N+1é—®é¢˜è§£å†³æ–¹æ¡ˆ


**âœ… æ–¹æ¡ˆä¸€ï¼š@EntityGraphï¼ˆæ¨èï¼‰**
```java
public interface UserRepository extends JpaRepository<User, Long> {
    
    // ä½¿ç”¨EntityGraphä¸€æ¬¡æ€§åŠ è½½å…³è”æ•°æ®
    @EntityGraph(attributePaths = {"orders"})  
    List<User> findAll();
    
    // ä¹Ÿå¯ä»¥æŒ‡å®šå¤šä¸ªå…³è”
    @EntityGraph(attributePaths = {"orders", "profile"})
    Optional<User> findById(Long id);
}
```

**âœ… æ–¹æ¡ˆäºŒï¼šJOIN FETCHæŸ¥è¯¢**
```java
@Query("SELECT u FROM User u LEFT JOIN FETCH u.orders WHERE u.id = :id")
Optional<User> findByIdWithOrders(@Param("id") Long id);

// æŸ¥è¯¢å¤šä¸ªç”¨æˆ·åŠå…¶è®¢å•
@Query("SELECT DISTINCT u FROM User u LEFT JOIN FETCH u.orders")  
List<User> findAllWithOrders();
```

**âœ… æ–¹æ¡ˆä¸‰ï¼šåˆ†æ‰¹åŠ è½½**  
```java
// å…ˆæŸ¥è¯¢ç”¨æˆ·
List<User> users = userRepository.findAll();

// æå–æ‰€æœ‰ç”¨æˆ·ID
List<Long> userIds = users.stream()
    .map(User::getId)
    .collect(Collectors.toList());

// ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰ç›¸å…³è®¢å•
List<Order> orders = orderRepository.findByUserIdIn(userIds);

// åœ¨å†…å­˜ä¸­ç»„è£…æ•°æ®ï¼ˆéœ€è¦è‡ªå·±å†™é€»è¾‘ï¼‰
```

### 7.4 æ‡’åŠ è½½æœ€ä½³å®è·µ


**ğŸ¯ é…ç½®å»ºè®®**
```yaml
spring:
  jpa:
    properties:
      hibernate:
        enable_lazy_load_no_trans: false  # å…³é—­äº‹åŠ¡å¤–æ‡’åŠ è½½
        jdbc:
          batch_size: 20                  # æ‰¹é‡å¤„ç†å¤§å°
```

**ğŸ’¡ ä½¿ç”¨æŠ€å·§**
```java
@Service
@Transactional  // ç¡®ä¿åœ¨äº‹åŠ¡å†…è®¿é—®æ‡’åŠ è½½å±æ€§
public class UserService {
    
    public UserDTO getUserWithOrders(Long userId) {
        User user = userRepository.findById(userId).orElse(null);
        
        // åœ¨äº‹åŠ¡å†…è®¿é—®æ‡’åŠ è½½å±æ€§ï¼Œè§¦å‘æŸ¥è¯¢
        List<Order> orders = user.getOrders();  
        
        return convertToDTO(user, orders);
    }
}
```

**âš ï¸ å¸¸è§é™·é˜±**
```java
// âŒ é”™è¯¯ï¼šåœ¨Controllerä¸­è®¿é—®æ‡’åŠ è½½å±æ€§
@RestController  
public class UserController {
    
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        User user = userService.findById(id);
        // è¿™é‡Œè®¿é—®ordersä¼šæŠ¥é”™ï¼šLazyInitializationException
        user.getOrders().size();  // ğŸ’¥ äº‹åŠ¡å·²ç»ç»“æŸï¼
        return user;
    }
}

// âœ… æ­£ç¡®ï¼šåœ¨Serviceå±‚å¤„ç†
@Service
@Transactional
public class UserService {
    
    public UserDTO getUserWithOrders(Long id) {
        User user = userRepository.findById(id).orElse(null);
        // åœ¨äº‹åŠ¡å†…å®‰å…¨è®¿é—®
        List<OrderDTO> orders = user.getOrders().stream()
            .map(this::convertToDTO)
            .collect(Collectors.toList());
            
        return new UserDTO(user.getName(), orders);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ JPAä¸Hibernateå…³ç³»ï¼šJPAæ˜¯æ ‡å‡†ï¼ŒHibernateæ˜¯å®ç°
ğŸ”¸ å®ä½“æ˜ å°„ï¼š@Entityã€@Tableã€@Idç­‰æ³¨è§£çš„æ­£ç¡®ä½¿ç”¨  
ğŸ”¸ Repositoryç»§æ‰¿ï¼šä¼˜å…ˆé€‰æ‹©JpaRepositoryè·å¾—å®Œæ•´åŠŸèƒ½
ğŸ”¸ æŸ¥è¯¢æ–¹æ³•ï¼šæ–¹æ³•å‘½åæŸ¥è¯¢ â†’ @Query â†’ SpecificationåŠ¨æ€æŸ¥è¯¢
ğŸ”¸ åˆ†é¡µæ’åºï¼šPageableå‚æ•°ï¼ŒPageç»“æœå¯¹è±¡çš„ä½¿ç”¨
ğŸ”¸ æ‡’åŠ è½½é—®é¢˜ï¼šç†è§£N+1é—®é¢˜ï¼ŒæŒæ¡è§£å†³æ–¹æ¡ˆ
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆè¦ç”¨JPAï¼Ÿ**
```
ä¼ ç»ŸJDBCçš„é—®é¢˜ï¼š
- å¤§é‡é‡å¤çš„SQLç¼–å†™
- æ‰‹åŠ¨å¤„ç†ç»“æœé›†æ˜ å°„  
- äº‹åŠ¡ç®¡ç†å¤æ‚
- æ•°æ®åº“åˆ‡æ¢å›°éš¾

JPAçš„ä¼˜åŠ¿ï¼š
- é¢å‘å¯¹è±¡æ“ä½œæ•°æ®åº“
- è‡ªåŠ¨SQLç”Ÿæˆå’Œä¼˜åŒ–
- æ ‡å‡†åŒ–ï¼Œå¯ç§»æ¤æ€§å¥½
- ä¸°å¯Œçš„æŸ¥è¯¢æ–¹å¼
```

**ğŸ”¹ ä»€ä¹ˆæ—¶å€™ç”¨å“ªç§æŸ¥è¯¢æ–¹å¼ï¼Ÿ**
```
ç®€å•æŸ¥è¯¢ â†’ æ–¹æ³•å‘½åæŸ¥è¯¢
- findByNameã€findByAgeGreaterThan

å¤æ‚æŸ¥è¯¢ â†’ @Query JPQL
- å¤šè¡¨å…³è”ã€å¤æ‚æ¡ä»¶ã€èšåˆæŸ¥è¯¢

åŠ¨æ€æŸ¥è¯¢ â†’ Specification  
- æœç´¢åŠŸèƒ½ã€æ¡ä»¶ä¸å›ºå®š

ç‰¹æ®Šéœ€æ±‚ â†’ åŸç”ŸSQL
- æ•°æ®åº“ç‰¹æœ‰åŠŸèƒ½ã€å¤æ‚åˆ†ææŸ¥è¯¢
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
é¿å…N+1é—®é¢˜ï¼š
- ä½¿ç”¨@EntityGraphæˆ–JOIN FETCH
- åˆç†è®¾è®¡æ‡’åŠ è½½ç­–ç•¥

æ‰¹é‡æ“ä½œï¼š  
- saveAll()è€Œä¸æ˜¯å¤šæ¬¡save()
- é…ç½®batch_sizeæé«˜æ‰¹é‡æ€§èƒ½

æŸ¥è¯¢ä¼˜åŒ–ï¼š
- åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼ˆDTOæŠ•å½±ï¼‰
- åˆç†ä½¿ç”¨åˆ†é¡µé¿å…å¤§ç»“æœé›†
- å»ºç«‹åˆé€‚çš„æ•°æ®åº“ç´¢å¼•
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æ–°æ‰‹å­¦ä¹ è·¯å¾„**
```
ç¬¬ä¸€æ­¥ï¼šæŒæ¡åŸºç¡€é…ç½®å’Œç®€å•CRUD
ç¬¬äºŒæ­¥ï¼šå­¦ä¼šå®ä½“æ˜ å°„å’Œå…³è”å…³ç³»
ç¬¬ä¸‰æ­¥ï¼šç†Ÿç»ƒä½¿ç”¨å„ç§æŸ¥è¯¢æ–¹å¼
ç¬¬å››æ­¥ï¼šç†è§£åˆ†é¡µæ’åºæœºåˆ¶  
ç¬¬äº”æ­¥ï¼šè§£å†³æ‡’åŠ è½½å’Œæ€§èƒ½é—®é¢˜
```

**ğŸš¨ å¸¸è§é”™è¯¯æé†’**
- âŒ **å¿˜è®°@Transactional**ï¼šå¯¼è‡´æ‡’åŠ è½½å¼‚å¸¸
- âŒ **æ»¥ç”¨EAGERåŠ è½½**ï¼šå¯¼è‡´æ€§èƒ½é—®é¢˜
- âŒ **ä¸å¤„ç†N+1é—®é¢˜**ï¼šæ•°æ®åº“å‹åŠ›è¿‡å¤§  
- âŒ **é”™è¯¯çš„ä¸»é”®ç­–ç•¥**ï¼šåœ¨ä¸åŒæ•°æ®åº“é—´ä¸é€šç”¨
- âŒ **ç¼ºå°‘å¼‚å¸¸å¤„ç†**ï¼šæ•°æ®åº“æ“ä½œæ²¡æœ‰å®¹é”™æœºåˆ¶

**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**
```
é…ç½®æ–¹é¢ï¼š
âœ… å¼€å‘ç¯å¢ƒshow-sql=trueï¼Œç”Ÿäº§ç¯å¢ƒfalse
âœ… åˆç†è®¾ç½®è¿æ¥æ± å‚æ•°
âœ… é…ç½®åˆé€‚çš„ddl-autoç­–ç•¥

ç¼–ç æ–¹é¢ï¼š  
âœ… å®ä½“ç±»éµå¾ªJavaBeanè§„èŒƒ
âœ… åˆç†ä½¿ç”¨@Transactionalæ³¨è§£
âœ… ä¼˜å…ˆä½¿ç”¨æ–¹æ³•å‘½åæŸ¥è¯¢
âœ… å¤æ‚æŸ¥è¯¢è€ƒè™‘ç¼“å­˜ç­–ç•¥

æ€§èƒ½æ–¹é¢ï¼š
âœ… é¿å…åœ¨å¾ªç¯ä¸­æ‰§è¡Œæ•°æ®åº“æ“ä½œ  
âœ… ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢å¤„ç†å¤§æ•°æ®é‡
âœ… ç›‘æ§æ…¢æŸ¥è¯¢å¹¶è¿›è¡Œä¼˜åŒ–
âœ… åˆç†è®¾è®¡æ•°æ®åº“ç´¢å¼•
```

### 8.4 è®°å¿†è¦ç‚¹


**ğŸ§  æ ¸å¿ƒè®°å¿†**
- **JPAæ˜¯æ ‡å‡†ï¼ŒHibernateæ˜¯å®ç°**ï¼ŒSpring Bootå¸®æˆ‘ä»¬æ•´åˆå¥½äº†
- **Repositoryé€‰JpaRepository**ï¼ŒåŠŸèƒ½æœ€å…¨é¢
- **æŸ¥è¯¢ä¼˜å…ˆçº§**ï¼šæ–¹æ³•å‘½å â†’ @Query â†’ Specification  
- **åˆ†é¡µå¿…é¡»ç”¨Pageable**ï¼Œç»“æœç”¨Pageæ¥æ”¶
- **æ‡’åŠ è½½è¦åœ¨äº‹åŠ¡å†…è®¿é—®**ï¼Œå°å¿ƒN+1é—®é¢˜
- **æ€§èƒ½ä¼˜åŒ–ä»é¿å…N+1å¼€å§‹**ï¼Œæ‰¹é‡æ“ä½œæ˜¯å…³é”®

**ğŸ“ å¿«é€Ÿæ£€æŸ¥æ¸…å•**
- â˜ ä¾èµ–å’Œé…ç½®æ˜¯å¦æ­£ç¡®ï¼Ÿ
- â˜ å®ä½“æ˜ å°„æ³¨è§£æ˜¯å¦å®Œæ•´ï¼Ÿ  
- â˜ Repositoryæ¥å£æ˜¯å¦ç»§æ‰¿æ­£ç¡®ï¼Ÿ
- â˜ æŸ¥è¯¢æ–¹æ³•æ˜¯å¦é€‰æ‹©åˆé€‚ï¼Ÿ
- â˜ åˆ†é¡µæ’åºæ˜¯å¦æ­£ç¡®å®ç°ï¼Ÿ
- â˜ æ‡’åŠ è½½é—®é¢˜æ˜¯å¦è€ƒè™‘ï¼Ÿ
- â˜ äº‹åŠ¡ç®¡ç†æ˜¯å¦åˆ°ä½ï¼Ÿ