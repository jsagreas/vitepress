---
title: 1ã€å“åº”å¼ç¼–ç¨‹æ¡†æ¶
---
## ğŸ“š ç›®å½•

1. [å“åº”å¼ç¼–ç¨‹æ˜¯ä»€ä¹ˆ](#1-å“åº”å¼ç¼–ç¨‹æ˜¯ä»€ä¹ˆ)
2. [Spring WebFluxæ¡†æ¶è¯¦è§£](#2-Spring-WebFluxæ¡†æ¶è¯¦è§£)
3. [Reactorå“åº”å¼åº“æ ¸å¿ƒ](#3-Reactorå“åº”å¼åº“æ ¸å¿ƒ)
4. [Monoå’ŒFluxè¯¦ç»†è®²è§£](#4-Monoå’ŒFluxè¯¦ç»†è®²è§£)
5. [éé˜»å¡IOåŸç†ä¸åº”ç”¨](#5-éé˜»å¡IOåŸç†ä¸åº”ç”¨)
6. [èƒŒå‹å¤„ç†æœºåˆ¶](#6-èƒŒå‹å¤„ç†æœºåˆ¶)
7. [å‡½æ•°å¼ç¼–ç¨‹åœ¨å“åº”å¼ä¸­çš„åº”ç”¨](#7-å‡½æ•°å¼ç¼–ç¨‹åœ¨å“åº”å¼ä¸­çš„åº”ç”¨)
8. [å¼‚æ­¥å¤„ç†æœ€ä½³å®è·µ](#8-å¼‚æ­¥å¤„ç†æœ€ä½³å®è·µ)
9. [äº‹ä»¶é©±åŠ¨æ¶æ„è®¾è®¡](#9-äº‹ä»¶é©±åŠ¨æ¶æ„è®¾è®¡)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ’¡ å“åº”å¼ç¼–ç¨‹æ˜¯ä»€ä¹ˆ


### 1.1 ç”¨ç”Ÿæ´»ä¾‹å­ç†è§£å“åº”å¼ç¼–ç¨‹

ğŸ¯ **æœ€ç®€å•çš„ç†è§£æ–¹å¼**ï¼šå“åº”å¼ç¼–ç¨‹å°±åƒ"è®¢é˜…å¾®ä¿¡æœ‹å‹åœˆ"

```
ä¼ ç»Ÿç¼–ç¨‹ï¼ˆé˜»å¡å¼ï¼‰ï¼š
ä½ æ‰“ç”µè¯é—®æœ‹å‹ï¼š"ä½ å‘æœ‹å‹åœˆäº†å—ï¼Ÿ"
æœ‹å‹è¯´ï¼š"ç­‰ç­‰ï¼Œæˆ‘æŸ¥æŸ¥..." ï¼ˆä½ ä¸€ç›´ç­‰å¾…ï¼Œä»€ä¹ˆéƒ½ä¸èƒ½åšï¼‰
è¿‡äº†5åˆ†é’Ÿï¼Œæœ‹å‹è¯´ï¼š"å‘äº†ï¼Œå†…å®¹æ˜¯xxx"

å“åº”å¼ç¼–ç¨‹ï¼ˆéé˜»å¡å¼ï¼‰ï¼š
ä½ è®¢é˜…äº†æœ‹å‹çš„æœ‹å‹åœˆé€šçŸ¥
æœ‹å‹ä¸€å‘æœ‹å‹åœˆï¼Œä½ ç«‹å³æ”¶åˆ°æ¨é€é€šçŸ¥
æœŸé—´ä½ å¯ä»¥åšå…¶ä»–äº‹æƒ…ï¼Œä¸ç”¨å¹²ç­‰
```

**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹è§£æ**
```
å“åº”æ€§ï¼ˆResponsiveï¼‰ï¼š
åƒå¤–å–APPä¸€æ ·ï¼Œä¸‹å•åç«‹å³ç»™ä½ åé¦ˆï¼Œä¸è®©ä½ å¹²ç­‰

å¼¹æ€§ï¼ˆResilientï¼‰ï¼š
åƒé“¶è¡Œç³»ç»Ÿä¸€æ ·ï¼ŒæŸä¸ªæœåŠ¡æŒ‚äº†ï¼Œå…¶ä»–åŠŸèƒ½ç…§å¸¸è¿è¡Œ

ä¼¸ç¼©æ€§ï¼ˆElasticï¼‰ï¼š
åƒç›´æ’­å¹³å°ä¸€æ ·ï¼Œè§‚ä¼—å¤šäº†è‡ªåŠ¨å¢åŠ æœåŠ¡å™¨ï¼Œè§‚ä¼—å°‘äº†è‡ªåŠ¨å‡å°‘

æ¶ˆæ¯é©±åŠ¨ï¼ˆMessage Drivenï¼‰ï¼š
åƒå¾®ä¿¡ç¾¤èŠä¸€æ ·ï¼Œé€šè¿‡æ¶ˆæ¯ä¼ é€’æ¥åè°ƒå·¥ä½œ
```

### 1.2 å“åº”å¼ç¼–ç¨‹è§£å†³äº†ä»€ä¹ˆé—®é¢˜

**ğŸš¨ ä¼ ç»Ÿç¼–ç¨‹çš„ç—›ç‚¹**

```
ç—›ç‚¹1ï¼šèµ„æºæµªè´¹
ä¼ ç»Ÿæ–¹å¼ï¼šæ¯ä¸ªç”¨æˆ·è¯·æ±‚éƒ½è¦å ç”¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…
ç»“æœï¼š1000ä¸ªç”¨æˆ· = 1000ä¸ªçº¿ç¨‹ = å†…å­˜çˆ†ç‚¸

ç—›ç‚¹2ï¼šæ€§èƒ½ç“¶é¢ˆ
ä¼ ç»Ÿæ–¹å¼ï¼šæŸ¥è¯¢æ•°æ®åº“æ—¶ï¼Œç¨‹åºå‚»ç­‰ç»“æœå›æ¥
ç»“æœï¼šCPUé—²ç€æ²¡äº‹å¹²ï¼Œç”¨æˆ·ä½“éªŒå·®

ç—›ç‚¹3ï¼šæ‰©å±•å›°éš¾
ä¼ ç»Ÿæ–¹å¼ï¼šç”¨æˆ·å¤šäº†å°±åŠ æœºå™¨ï¼Œç”¨æˆ·å°‘äº†æœºå™¨é—²ç½®
ç»“æœï¼šæˆæœ¬é«˜ï¼Œèµ„æºåˆ©ç”¨ç‡ä½
```

**âœ… å“åº”å¼ç¼–ç¨‹çš„è§£å†³æ–¹æ¡ˆ**
```
è§£å†³æ–¹æ¡ˆ1ï¼šå°‘é‡çº¿ç¨‹å¤„ç†å¤§é‡è¯·æ±‚
å“åº”å¼ï¼šç”¨å¾ˆå°‘çš„çº¿ç¨‹å¤„ç†å¾ˆå¤šè¯·æ±‚
ç±»æ¯”ï¼šä¸€ä¸ªæœåŠ¡å‘˜å¯ä»¥åŒæ—¶æœåŠ¡å¤šæ¡Œå®¢äººï¼ˆç‚¹èœåå»å¨æˆ¿ï¼Œä¸ç”¨å¹²ç­‰ï¼‰

è§£å†³æ–¹æ¡ˆ2ï¼šå¼‚æ­¥éé˜»å¡å¤„ç†
å“åº”å¼ï¼šå‘å‡ºè¯·æ±‚åç«‹å³å»åšå…¶ä»–äº‹ï¼Œæœ‰ç»“æœäº†å†å¤„ç†
ç±»æ¯”ï¼šä½ ç‚¹å¤–å–åå¯ä»¥åšå…¶ä»–äº‹ï¼Œå¤–å–åˆ°äº†å†å»æ‹¿

è§£å†³æ–¹æ¡ˆ3ï¼šæµå¼æ•°æ®å¤„ç†
å“åº”å¼ï¼šæ•°æ®åƒæ°´æµä¸€æ ·æŒç»­æµåŠ¨å’Œå¤„ç†
ç±»æ¯”ï¼šå·¥å‚æµæ°´çº¿ï¼Œæ¯ä¸ªç¯èŠ‚æŒç»­å¤„ç†ï¼Œä¸ç”¨ç­‰å…¨éƒ¨å®Œæˆ
```

### 1.3 ä»€ä¹ˆæ—¶å€™åº”è¯¥ç”¨å“åº”å¼ç¼–ç¨‹

**ğŸ¯ é€‚åˆçš„åœºæ™¯**

```
é«˜å¹¶å‘åœºæ™¯ï¼š
- åœ¨çº¿ç›´æ’­ï¼šåŒæ—¶å‡ ä¸‡äººè§‚çœ‹
- åœ¨çº¿æ¸¸æˆï¼šå®æ—¶äº’åŠ¨ï¼Œå»¶è¿Ÿè¦æ±‚ä½
- é‡‘èäº¤æ˜“ï¼šå¤§é‡å¹¶å‘äº¤æ˜“è¯·æ±‚

IOå¯†é›†åœºæ™¯ï¼š
- æ•°æ®èšåˆï¼šéœ€è¦è°ƒç”¨å¤šä¸ªå¤–éƒ¨æœåŠ¡
- æ–‡ä»¶å¤„ç†ï¼šå¤§æ–‡ä»¶ä¸Šä¼ ä¸‹è½½
- æ•°æ®åº“æ“ä½œï¼šå¤æ‚æŸ¥è¯¢æ“ä½œ

å®æ—¶å“åº”åœºæ™¯ï¼š
- èŠå¤©åº”ç”¨ï¼šæ¶ˆæ¯å®æ—¶æ¨é€
- è‚¡ç¥¨ç³»ç»Ÿï¼šä»·æ ¼å®æ—¶æ›´æ–°
- ç›‘æ§ç³»ç»Ÿï¼šçŠ¶æ€å®æ—¶åé¦ˆ
```

**âš ï¸ ä¸é€‚åˆçš„åœºæ™¯**
```
ä¸å»ºè®®ä½¿ç”¨çš„æƒ…å†µï¼š
- ç®€å•çš„CRUDæ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
- å›¢é˜Ÿå¯¹å“åº”å¼ç¼–ç¨‹ä¸ç†Ÿæ‚‰
- ä¸šåŠ¡é€»è¾‘ç®€å•ï¼Œå¹¶å‘å‹åŠ›ä¸å¤§
- è°ƒè¯•å’Œæ’é”™è¦æ±‚ç®€å•æ˜ç¡®
```

---

## 2. ğŸŒŠ Spring WebFluxæ¡†æ¶è¯¦è§£


### 2.1 WebFluxæ˜¯ä»€ä¹ˆ

**ğŸ’¡ ç®€å•ç†è§£**ï¼šWebFluxæ˜¯Springå®¶æ—çš„"å¼‚æ­¥ç‰ˆæœ¬"

```
å¯¹æ¯”ç†è§£ï¼š
Spring MVC = ä¼ ç»Ÿé¤å…
- ä¸€ä¸ªæœåŠ¡å‘˜æœåŠ¡ä¸€æ¡Œå®¢äºº
- ç‚¹èœåæœåŠ¡å‘˜ç­‰ç€èœåšå¥½æ‰èƒ½æœåŠ¡ä¸‹ä¸€æ¡Œ
- å®¢äººå¤šäº†å°±é›‡æ›´å¤šæœåŠ¡å‘˜

Spring WebFlux = ç°ä»£å¿«é¤åº—  
- ä¸€ä¸ªæœåŠ¡å‘˜å¯ä»¥æœåŠ¡å¤šæ¡Œå®¢äºº
- ç‚¹èœåç«‹å³æœåŠ¡ä¸‹ä¸€æ¡Œï¼Œèœå¥½äº†å†é€è¿‡å»
- åŒæ ·çš„æœåŠ¡å‘˜å¯ä»¥æœåŠ¡æ›´å¤šå®¢äºº
```

**ğŸ”¸ æ ¸å¿ƒæ¶æ„å¯¹æ¯”**

| ç‰¹æ€§ | **Spring MVC** | **Spring WebFlux** |
|------|-----------------|-------------------|
| ğŸ”¸ **ç¼–ç¨‹æ¨¡å‹** | `åŒæ­¥é˜»å¡` | `å¼‚æ­¥éé˜»å¡` |
| ğŸ”¸ **çº¿ç¨‹æ¨¡å‹** | `ä¸€è¯·æ±‚ä¸€çº¿ç¨‹` | `å°‘é‡çº¿ç¨‹å¤„ç†å¤šè¯·æ±‚` |
| ğŸ”¸ **é€‚ç”¨åœºæ™¯** | `ä¼ ç»ŸWebåº”ç”¨` | `é«˜å¹¶å‘ã€å®æ—¶åº”ç”¨` |
| ğŸ”¸ **å­¦ä¹ éš¾åº¦** | `ç›¸å¯¹ç®€å•` | `éœ€è¦è½¬æ¢æ€ç»´` |
| ğŸ”¸ **è°ƒè¯•éš¾åº¦** | `å®¹æ˜“` | `ç›¸å¯¹å¤æ‚` |

### 2.2 WebFluxçš„ä¸¤ç§ç¼–ç¨‹æ¨¡å¼

**ğŸ”§ æ³¨è§£æ¨¡å¼ï¼ˆAnnotation-basedï¼‰**

```java
// ä¼ ç»Ÿçš„Controllerå†™æ³•ï¼Œä½†è¿”å›Mono/Flux
@RestController
public class UserController {
    
    @GetMapping("/user/{id}")
    public Mono<User> getUser(@PathVariable String id) {
        // è¿”å›Monoè¡¨ç¤º"å°†æ¥ä¼šæœ‰ä¸€ä¸ªUserå¯¹è±¡"
        return userService.findById(id);
    }
    
    @GetMapping("/users")
    public Flux<User> getAllUsers() {
        // è¿”å›Fluxè¡¨ç¤º"å°†æ¥ä¼šæœ‰ä¸€ä¸²Userå¯¹è±¡"
        return userService.findAll();
    }
}
```

**âš¡ å‡½æ•°å¼æ¨¡å¼ï¼ˆFunctionalï¼‰**
```java
// å‡½æ•°å¼è·¯ç”±é…ç½®
@Configuration
public class RouterConfig {
    
    @Bean
    public RouterFunction<ServerResponse> routes(UserHandler handler) {
        return RouterFunctions.route()
            .GET("/user/{id}", handler::getUser)
            .GET("/users", handler::getAllUsers)
            .POST("/user", handler::createUser)
            .build();
    }
}

// å¤„ç†å™¨ç±»
@Component
public class UserHandler {
    
    public Mono<ServerResponse> getUser(ServerRequest request) {
        String id = request.pathVariable("id");
        return userService.findById(id)
            .flatMap(user -> ServerResponse.ok().bodyValue(user))
            .switchIfEmpty(ServerResponse.notFound().build());
    }
}
```

### 2.3 WebFluxçš„æ ¸å¿ƒç»„ä»¶

**ğŸ—ï¸ ä¸»è¦ç»„ä»¶æ¶æ„**

```
WebFluxæ¶æ„å›¾ï¼š
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
WebFilterï¼ˆè¿‡æ»¤å™¨ï¼‰
    â†“  
RouterFunctionï¼ˆè·¯ç”±å‡½æ•°ï¼‰
    â†“
HandlerFunctionï¼ˆå¤„ç†å‡½æ•°ï¼‰
    â†“
Service Layerï¼ˆä¸šåŠ¡å±‚ï¼‰
    â†“
Reactive Repositoryï¼ˆå“åº”å¼ä»“åº“ï¼‰
    â†“
æ•°æ®åº“/å¤–éƒ¨æœåŠ¡
```

**ğŸ’¡ ç»„ä»¶èŒè´£è¯´æ˜**
```
WebFilterï¼š
ä½œç”¨ï¼šç±»ä¼¼ä¼ ç»Ÿçš„Filterï¼Œä½†æ”¯æŒå¼‚æ­¥
ç”¨é€”ï¼šèº«ä»½éªŒè¯ã€æ—¥å¿—è®°å½•ã€è·¨åŸŸå¤„ç†

RouterFunctionï¼š  
ä½œç”¨ï¼šå®šä¹‰URLè·¯ç”±è§„åˆ™
ç”¨é€”ï¼šå°†è¯·æ±‚è·¯ç”±åˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°

HandlerFunctionï¼š
ä½œç”¨ï¼šå…·ä½“çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
ç”¨é€”ï¼šå¤„ç†è¯·æ±‚ï¼Œè¿”å›å“åº”

ServerRequest/ServerResponseï¼š
ä½œç”¨ï¼šè¯·æ±‚å’Œå“åº”çš„å°è£…
ç”¨é€”ï¼šè·å–è¯·æ±‚å‚æ•°ï¼Œæ„å»ºå“åº”ç»“æœ
```

---

## 3. âš›ï¸ Reactorå“åº”å¼åº“æ ¸å¿ƒ


### 3.1 Reactoræ˜¯ä»€ä¹ˆ

**ğŸ”§ æ ¸å¿ƒå®šä½**ï¼šReactoræ˜¯Spring WebFluxçš„"å‘åŠ¨æœº"

```
ç±»æ¯”ç†è§£ï¼š
å¦‚æœWebFluxæ˜¯ä¸€è¾†æ±½è½¦
é‚£ä¹ˆReactorå°±æ˜¯æ±½è½¦çš„å‘åŠ¨æœº

WebFluxè´Ÿè´£ï¼šç”¨æˆ·ç•Œé¢ã€æ–¹å‘ç›˜ã€æ¡£ä½ï¼ˆAPIè®¾è®¡ï¼‰
Reactorè´Ÿè´£ï¼šåŠ¨åŠ›è¾“å‡ºã€ç‡ƒæ²¹æ•ˆç‡ã€æ’æ”¾æ§åˆ¶ï¼ˆåº•å±‚å¼‚æ­¥å¤„ç†ï¼‰
```

**ğŸ”¸ Reactorçš„æ ¸å¿ƒä»·å€¼**
```
ç»Ÿä¸€æŠ½è±¡ï¼š
- æä¾›ç»Ÿä¸€çš„å¼‚æ­¥æ•°æ®æµå¤„ç†æ–¹å¼
- ä¸ç®¡æ˜¯æ•°æ®åº“æŸ¥è¯¢è¿˜æ˜¯HTTPè°ƒç”¨ï¼Œéƒ½ç”¨ç›¸åŒæ–¹å¼å¤„ç†

æ“ä½œä¸°å¯Œï¼š
- æä¾›ä¸°å¯Œçš„æ•°æ®æµæ“ä½œç¬¦ï¼ˆmapã€filterã€mergeç­‰ï¼‰
- åƒæ“ä½œé›†åˆä¸€æ ·æ“ä½œå¼‚æ­¥æ•°æ®æµ

æ€§èƒ½ä¼˜åŒ–ï¼š
- ä¼˜åŒ–çš„è°ƒåº¦å™¨å’Œçº¿ç¨‹æ¨¡å‹
- è‡ªåŠ¨çš„èƒŒå‹å¤„ç†å’Œå†…å­˜ç®¡ç†
```

### 3.2 Reactorçš„è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰

**âš¡ çº¿ç¨‹è°ƒåº¦ç­–ç•¥**

```java
// ä¸åŒç±»å‹çš„è°ƒåº¦å™¨
public class SchedulerExample {
    
    public void demonstrateSchedulers() {
        // 1. ç«‹å³è°ƒåº¦å™¨ - åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œ
        Scheduler immediate = Schedulers.immediate();
        
        // 2. å•çº¿ç¨‹è°ƒåº¦å™¨ - ä¸²è¡Œæ‰§è¡Œä»»åŠ¡
        Scheduler single = Schedulers.single();
        
        // 3. å¼¹æ€§è°ƒåº¦å™¨ - é€‚åˆIOå¯†é›†ä»»åŠ¡
        Scheduler elastic = Schedulers.elastic();
        
        // 4. å¹¶è¡Œè°ƒåº¦å™¨ - é€‚åˆCPUå¯†é›†ä»»åŠ¡
        Scheduler parallel = Schedulers.parallel();
        
        // 5. è‡ªå®šä¹‰çº¿ç¨‹æ± è°ƒåº¦å™¨
        Scheduler custom = Schedulers.fromExecutor(
            Executors.newFixedThreadPool(10)
        );
    }
}
```

**ğŸ“Š è°ƒåº¦å™¨é€‰æ‹©ç­–ç•¥**

| è°ƒåº¦å™¨ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **ç‰¹ç‚¹** | **ç¤ºä¾‹ç”¨é€”** |
|-----------|-------------|---------|-------------|
| ğŸ”¸ **immediate** | `åŒæ­¥æ“ä½œ` | `å½“å‰çº¿ç¨‹æ‰§è¡Œ` | `ç®€å•è®¡ç®—` |
| ğŸ”¸ **single** | `é¡ºåºæ‰§è¡Œ` | `å•çº¿ç¨‹ä¸²è¡Œ` | `æ–‡ä»¶å†™å…¥` |
| ğŸ”¸ **elastic** | `IOæ“ä½œ` | `çº¿ç¨‹æ± å¯æ‰©å±•` | `HTTPè°ƒç”¨` |
| ğŸ”¸ **parallel** | `CPUå¯†é›†` | `å›ºå®šçº¿ç¨‹æ± ` | `æ•°æ®è®¡ç®—` |

### 3.3 Reactoræ“ä½œç¬¦è¯¦è§£

**ğŸ”„ å¸¸ç”¨æ“ä½œç¬¦åˆ†ç±»**

```
è½¬æ¢æ“ä½œç¬¦ï¼ˆTransformï¼‰ï¼š
mapï¼šä¸€å¯¹ä¸€è½¬æ¢ï¼Œåƒå·¥å‚åŠ å·¥äº§å“
flatMapï¼šä¸€å¯¹å¤šè½¬æ¢ï¼Œåƒè®¢å•æ‹†åˆ†æˆå•†å“
filterï¼šç­›é€‰è¿‡æ»¤ï¼Œåƒç­›æ²™å­ç•™ä¸‹é‡‘å­

ç»„åˆæ“ä½œç¬¦ï¼ˆCombineï¼‰ï¼š
mergeï¼šå¤šä¸ªæµåˆå¹¶ï¼Œåƒå¤šæ¡æ²³æµæ±‡èš
zipï¼šé…å¯¹ç»„åˆï¼Œåƒå·¦å³æ‰‹é…å¯¹æˆ´æ‰‹å¥—
concatï¼šé¡ºåºè¿æ¥ï¼Œåƒç«è½¦è½¦å¢è¿æ¥

é”™è¯¯å¤„ç†æ“ä½œç¬¦ï¼ˆErrorï¼‰ï¼š
onErrorReturnï¼šå‡ºé”™æ—¶è¿”å›é»˜è®¤å€¼
onErrorResumeï¼šå‡ºé”™æ—¶åˆ‡æ¢åˆ°å¤‡ç”¨æµ
retryï¼šå‡ºé”™æ—¶é‡è¯•ï¼ŒåƒæŠ•ç¯®ä¸ä¸­å†æŠ•
```

**ğŸ’¡ æ“ä½œç¬¦é“¾å¼è°ƒç”¨ç¤ºä¾‹**
```java
// æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®å¤„ç†æµæ°´çº¿
public Flux<UserDTO> processUsers() {
    return userRepository.findAll()           // è·å–æ‰€æœ‰ç”¨æˆ·
        .filter(user -> user.isActive())      // ç­›é€‰æ´»è·ƒç”¨æˆ·
        .map(this::enrichUserInfo)            // è¡¥å……ç”¨æˆ·ä¿¡æ¯
        .flatMap(this::validateUser)          // éªŒè¯ç”¨æˆ·æ•°æ®
        .onErrorContinue(this::handleError)   // å¤„ç†ä¸ªåˆ«ç”¨æˆ·çš„é”™è¯¯
        .take(100);                           // åªå–å‰100ä¸ª
}
```

---

## 4. ğŸŒŠ Monoå’ŒFluxè¯¦ç»†è®²è§£


### 4.1 Monoå’ŒFluxçš„ç›´è§‚ç†è§£

**ğŸ’¡ ç”Ÿæ´»åŒ–ç±»æ¯”**

```
Mono = å¿«é€’åŒ…è£¹
ç‰¹ç‚¹ï¼šä¸€ä¸ªåŒ…è£¹é‡Œåªæœ‰ä¸€ä»¶å•†å“ï¼ˆ0ä¸ªæˆ–1ä¸ªï¼‰
ç”¨é€”ï¼šè·å–å•ä¸ªç”¨æˆ·ä¿¡æ¯ã€ä¿å­˜ä¸€æ¡è®°å½•ã€åˆ é™¤æ“ä½œçš„ç»“æœ

Flux = æµæ°´çº¿å•†å“
ç‰¹ç‚¹ï¼šæŒç»­ä¸æ–­çš„å•†å“æµï¼ˆ0ä¸ªåˆ°æ— é™ä¸ªï¼‰  
ç”¨é€”ï¼šè·å–ç”¨æˆ·åˆ—è¡¨ã€å®æ—¶æ•°æ®æµã€æ–‡ä»¶è¯»å–æµ
```

**ğŸ”¸ ä½¿ç”¨åœºæ™¯å¯¹æ¯”**
```
ä»€ä¹ˆæ—¶å€™ç”¨Monoï¼š
- æ ¹æ®IDæŸ¥è¯¢ä¸€ä¸ªç”¨æˆ·ï¼šMono<User>
- ä¿å­˜æ•°æ®çš„ç»“æœï¼šMono<Boolean>  
- åˆ é™¤æ“ä½œçš„å½±å“è¡Œæ•°ï¼šMono<Integer>
- HTTPå“åº”çŠ¶æ€ï¼šMono<ResponseEntity>

ä»€ä¹ˆæ—¶å€™ç”¨Fluxï¼š
- æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ï¼šFlux<User>
- è¯»å–æ–‡ä»¶å†…å®¹ï¼šFlux<String>
- å®æ—¶è‚¡ä»·æ•°æ®ï¼šFlux<StockPrice>
- èŠå¤©æ¶ˆæ¯æµï¼šFlux<Message>
```

### 4.2 åˆ›å»ºMonoå’ŒFluxçš„å¸¸ç”¨æ–¹æ³•

**ğŸ”§ Monoåˆ›å»ºæ–¹å¼**

```java
public class MonoCreationExamples {
    
    public void demonstrateMonoCreation() {
        // 1. åˆ›å»ºåŒ…å«å€¼çš„Mono
        Mono<String> justMono = Mono.just("Hello World");
        
        // 2. åˆ›å»ºç©ºçš„Mono  
        Mono<String> emptyMono = Mono.empty();
        
        // 3. åˆ›å»ºé”™è¯¯çš„Mono
        Mono<String> errorMono = Mono.error(new RuntimeException("å‡ºé”™äº†"));
        
        // 4. ä»Supplieråˆ›å»ºï¼ˆå»¶è¿Ÿè®¡ç®—ï¼‰
        Mono<String> fromSupplier = Mono.fromSupplier(() -> {
            // è¿™é‡Œçš„ä»£ç åœ¨è®¢é˜…æ—¶æ‰æ‰§è¡Œ
            return "å»¶è¿Ÿè®¡ç®—çš„ç»“æœ";
        });
        
        // 5. ä»Callableåˆ›å»ºï¼ˆæ”¯æŒå¼‚å¸¸ï¼‰
        Mono<String> fromCallable = Mono.fromCallable(() -> {
            // å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„æ“ä½œ
            return someExpensiveOperation();
        });
    }
    
    private String someExpensiveOperation() {
        // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
        return "æ“ä½œç»“æœ";
    }
}
```

**âš¡ Fluxåˆ›å»ºæ–¹å¼**
```java
public class FluxCreationExamples {
    
    public void demonstrateFluxCreation() {
        // 1. ä»å¤šä¸ªå€¼åˆ›å»º
        Flux<String> justFlux = Flux.just("A", "B", "C");
        
        // 2. ä»é›†åˆåˆ›å»º
        List<String> list = Arrays.asList("1", "2", "3");
        Flux<String> fromIterable = Flux.fromIterable(list);
        
        // 3. åˆ›å»ºæ•°å­—åºåˆ—
        Flux<Integer> range = Flux.range(1, 10); // 1åˆ°10
        
        // 4. åˆ›å»ºé—´éš”å‘å°„çš„Flux
        Flux<Long> interval = Flux.interval(Duration.ofSeconds(1)); // æ¯ç§’å‘å°„ä¸€ä¸ªé€’å¢æ•°å­—
        
        // 5. ä»æ–‡ä»¶åˆ›å»º
        Flux<String> fromFile = Flux.using(
            () -> Files.lines(Paths.get("data.txt")), // èµ„æºè·å–
            Flux::fromStream,                         // è½¬æ¢ä¸ºFlux
            BaseStream::close                         // èµ„æºæ¸…ç†
        );
        
        // 6. åˆ›å»ºæ— é™æµ
        Flux<String> generate = Flux.generate(
            () -> 0,                    // åˆå§‹çŠ¶æ€
            (state, sink) -> {          // ç”Ÿæˆé€»è¾‘
                sink.next("Item " + state);
                if (state == 10) {
                    sink.complete();     // å®Œæˆä¿¡å·
                }
                return state + 1;       // æ–°çŠ¶æ€
            }
        );
    }
}
```

### 4.3 Monoå’ŒFluxçš„å¸¸ç”¨æ“ä½œ

**ğŸ”„ è½¬æ¢å’Œè¿‡æ»¤æ“ä½œ**

```java
public class MonoFluxOperations {
    
    // Monoè½¬æ¢ç¤ºä¾‹
    public void monoTransformations() {
        Mono<String> userInput = Mono.just("hello world");
        
        Mono<String> result = userInput
            .map(String::toUpperCase)           // è½¬å¤§å†™
            .filter(s -> s.contains("HELLO"))   // è¿‡æ»¤åŒ…å«HELLOçš„
            .defaultIfEmpty("é»˜è®¤å€¼")            // å¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼
            .onErrorReturn("å‘ç”Ÿé”™è¯¯æ—¶çš„é»˜è®¤å€¼"); // é”™è¯¯æ—¶çš„é»˜è®¤å€¼
    }
    
    // Fluxè½¬æ¢ç¤ºä¾‹  
    public void fluxTransformations() {
        Flux<Integer> numbers = Flux.range(1, 10);
        
        Flux<String> result = numbers
            .filter(n -> n % 2 == 0)           // åªè¦å¶æ•°
            .map(n -> "æ•°å­—: " + n)             // è½¬æ¢ä¸ºå­—ç¬¦ä¸²
            .take(3)                           // åªå–å‰3ä¸ª
            .distinctUntilChanged();           // å»é‡ï¼ˆç›¸é‚»é‡å¤ï¼‰
    }
    
    // ç»„åˆæ“ä½œç¤ºä¾‹
    public void combineOperations() {
        Mono<String> mono1 = Mono.just("Hello");
        Mono<String> mono2 = Mono.just("World");
        
        // ç»„åˆä¸¤ä¸ªMono
        Mono<String> combined = mono1
            .zipWith(mono2, (a, b) -> a + " " + b);
            
        Flux<String> flux1 = Flux.just("A", "B");
        Flux<String> flux2 = Flux.just("1", "2");
        
        // åˆå¹¶ä¸¤ä¸ªFlux
        Flux<String> merged = Flux.merge(flux1, flux2);
    }
}
```

---

## 5. ğŸš€ éé˜»å¡IOåŸç†ä¸åº”ç”¨


### 5.1 é˜»å¡IO vs éé˜»å¡IO

**ğŸ“ ç”µè¯å®¢æœçš„ç±»æ¯”**

```
é˜»å¡IOï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰ï¼š
å®¢æœï¼šæ‚¨å¥½ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ
å®¢æˆ·ï¼šæˆ‘è¦æŸ¥è¯¢è®¢å•çŠ¶æ€
å®¢æœï¼šè¯·ç¨ç­‰ï¼Œæˆ‘å¸®æ‚¨æŸ¥è¯¢...ï¼ˆä»€ä¹ˆéƒ½ä¸åšï¼Œå‚»ç­‰5åˆ†é’Ÿï¼‰
å®¢æœï¼šæŸ¥åˆ°äº†ï¼Œæ‚¨çš„è®¢å•åœ¨é…é€ä¸­
æœŸé—´ï¼šå…¶ä»–å®¢æˆ·æ’é˜Ÿç­‰å¾…ï¼Œå®¢æœèµ„æºè¢«å ç”¨

éé˜»å¡IOï¼ˆå“åº”å¼æ–¹å¼ï¼‰ï¼š
å®¢æœï¼šæ‚¨å¥½ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ  
å®¢æˆ·ï¼šæˆ‘è¦æŸ¥è¯¢è®¢å•çŠ¶æ€
å®¢æœï¼šå¥½çš„ï¼Œæˆ‘æäº¤æŸ¥è¯¢è¯·æ±‚ï¼Œç¨åå›å¤æ‚¨ï¼ˆç«‹å³å»æœåŠ¡å…¶ä»–å®¢æˆ·ï¼‰
ç³»ç»Ÿï¼šæŸ¥è¯¢å®Œæˆï¼Œé€šçŸ¥å®¢æœ
å®¢æœï¼šï¼ˆå›åˆ°ç¬¬ä¸€ä¸ªå®¢æˆ·ï¼‰æ‚¨çš„è®¢å•åœ¨é…é€ä¸­
æœŸé—´ï¼šå¯ä»¥åŒæ—¶æœåŠ¡å¤šä¸ªå®¢æˆ·ï¼Œèµ„æºåˆ©ç”¨ç‡é«˜
```

### 5.2 éé˜»å¡IOçš„æŠ€æœ¯å®ç°

**âš¡ åº•å±‚æŠ€æœ¯åŸç†**

```
ä¼ ç»ŸBIOï¼ˆBlocking IOï¼‰æ¨¡å‹ï¼š
çº¿ç¨‹1 â†’ è¯·æ±‚1 â†’ ç­‰å¾…IO â†’ è¿”å›ç»“æœ
çº¿ç¨‹2 â†’ è¯·æ±‚2 â†’ ç­‰å¾…IO â†’ è¿”å›ç»“æœ  
çº¿ç¨‹3 â†’ è¯·æ±‚3 â†’ ç­‰å¾…IO â†’ è¿”å›ç»“æœ

é—®é¢˜ï¼šæ¯ä¸ªè¯·æ±‚å ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹å¤šäº†ç³»ç»Ÿå‹åŠ›å¤§

NIOï¼ˆNon-blocking IOï¼‰æ¨¡å‹ï¼š
å°‘é‡çº¿ç¨‹ â†’ ç®¡ç†å¤šä¸ªè¿æ¥
IOå¤šè·¯å¤ç”¨ â†’ ä¸€ä¸ªçº¿ç¨‹ç›‘å¬å¤šä¸ªIOäº‹ä»¶
äº‹ä»¶å¾ªç¯ â†’ æœ‰æ•°æ®å‡†å¤‡å¥½å°±å¤„ç†ï¼Œæ²¡æœ‰å°±å¤„ç†å…¶ä»–

ä¼˜åŠ¿ï¼šç”¨å°‘é‡çº¿ç¨‹å¤„ç†å¤§é‡è¿æ¥
```

**ğŸ”§ åœ¨Javaä¸­çš„ä½“ç°**
```java
// ä¼ ç»Ÿé˜»å¡æ–¹å¼ï¼ˆä¼ªä»£ç ï¼‰
public String traditionalGetData() {
    // çº¿ç¨‹ä¼šåœ¨è¿™é‡Œç­‰å¾…ï¼Œä»€ä¹ˆéƒ½ä¸èƒ½åš
    String result = httpClient.get("http://api.example.com/data");
    return result;
}

// éé˜»å¡å“åº”å¼æ–¹å¼
public Mono<String> reactiveGetData() {
    // ç«‹å³è¿”å›Monoï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹
    return WebClient.create()
        .get()
        .uri("http://api.example.com/data")
        .retrieve()
        .bodyToMono(String.class);
}
```

### 5.3 éé˜»å¡IOçš„å®é™…åº”ç”¨

**ğŸŒ Webåº”ç”¨ä¸­çš„åº”ç”¨**

```java
@RestController
public class ProductController {
    
    // ä¼ ç»Ÿé˜»å¡æ–¹å¼
    @GetMapping("/product/{id}/details")
    public ProductDetails getProductDetails(@PathVariable String id) {
        // ä»¥ä¸‹æ“ä½œéƒ½æ˜¯é˜»å¡çš„ï¼Œçº¿ç¨‹ä¼šç­‰å¾…
        Product product = productService.findById(id);        // æŸ¥æ•°æ®åº“
        List<Review> reviews = reviewService.findByProductId(id); // æŸ¥è¯„è®º
        Price price = priceService.getCurrentPrice(id);           // æŸ¥ä»·æ ¼
        
        return new ProductDetails(product, reviews, price);
        // æ€»è€—æ—¶ = æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ + è¯„è®ºæŸ¥è¯¢æ—¶é—´ + ä»·æ ¼æŸ¥è¯¢æ—¶é—´
    }
    
    // å“åº”å¼éé˜»å¡æ–¹å¼
    @GetMapping("/reactive/product/{id}/details")
    public Mono<ProductDetails> getProductDetailsReactive(@PathVariable String id) {
        // å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæŸ¥è¯¢ï¼Œä¸é˜»å¡çº¿ç¨‹
        Mono<Product> productMono = productService.findByIdReactive(id);
        Mono<List<Review>> reviewsMono = reviewService.findByProductIdReactive(id);  
        Mono<Price> priceMono = priceService.getCurrentPriceReactive(id);
        
        // ç­‰æ‰€æœ‰æ•°æ®éƒ½å‡†å¤‡å¥½åç»„åˆç»“æœ
        return Mono.zip(productMono, reviewsMono, priceMono)
            .map(tuple -> new ProductDetails(
                tuple.getT1(), // product
                tuple.getT2(), // reviews  
                tuple.getT3()  // price
            ));
        // æ€»è€—æ—¶ â‰ˆ max(æ•°æ®åº“æ—¶é—´, è¯„è®ºæ—¶é—´, ä»·æ ¼æ—¶é—´) - å¹¶è¡Œæ‰§è¡Œ
    }
}
```

**ğŸ“Š æ€§èƒ½å¯¹æ¯”æ•ˆæœ**
```
å‡è®¾åœºæ™¯ï¼š1000ä¸ªå¹¶å‘ç”¨æˆ·æŸ¥è¯¢å•†å“è¯¦æƒ…

ä¼ ç»Ÿé˜»å¡æ–¹å¼ï¼š
- éœ€è¦1000ä¸ªçº¿ç¨‹
- æ¯ä¸ªçº¿ç¨‹å ç”¨1-2MBå†…å­˜
- æ€»å†…å­˜éœ€æ±‚ï¼š1-2GB
- å“åº”æ—¶é—´ï¼šå„æŸ¥è¯¢æ—¶é—´ç´¯åŠ 

å“åº”å¼éé˜»å¡ï¼š
- éœ€è¦å°‘é‡çº¿ç¨‹ï¼ˆé€šå¸¸å‡ ä¸ªåˆ°å‡ åä¸ªï¼‰
- æ€»å†…å­˜éœ€æ±‚ï¼šå‡ åMBåˆ°å‡ ç™¾MB
- å“åº”æ—¶é—´ï¼šå¹¶è¡Œæ‰§è¡Œï¼Œæ—¶é—´å¤§å¹…å‡å°‘
- ç³»ç»Ÿååé‡ï¼šæå‡5-10å€
```

---

## 6. ğŸŒŠ èƒŒå‹å¤„ç†æœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯èƒŒå‹ï¼ˆBackpressureï¼‰

**ğŸš° æ°´ç®¡çš„ç±»æ¯”**

```
æƒ³è±¡ä¸€ä¸ªè‡ªæ¥æ°´ç³»ç»Ÿï¼š
æ°´æºï¼ˆæ•°æ®æºï¼‰â†’ æ°´ç®¡ï¼ˆä¼ è¾“é€šé“ï¼‰â†’ æ°´é¾™å¤´ï¼ˆæ¶ˆè´¹è€…ï¼‰

æ­£å¸¸æƒ…å†µï¼š
æ°´æºå‡ºæ°´ = æ°´é¾™å¤´ç”¨æ°´ï¼Œç³»ç»Ÿå¹³è¡¡

èƒŒå‹æƒ…å†µï¼š
æ°´æºå‡ºæ°´ > æ°´é¾™å¤´ç”¨æ°´
ç»“æœï¼šæ°´ç®¡å‹åŠ›å¢å¤§ï¼Œå¯èƒ½çˆ†ç®¡ï¼ˆç³»ç»Ÿå´©æºƒï¼‰

è§£å†³æ–¹æ¡ˆï¼š
1. è°ƒèŠ‚æ°´æºå‡ºæ°´é‡ï¼ˆé™åˆ¶ç”Ÿäº§é€Ÿåº¦ï¼‰
2. æ‰©å¤§æ°´ç®¡ï¼ˆå¢åŠ ç¼“å†²åŒºï¼‰
3. å¢åŠ æ°´é¾™å¤´ï¼ˆå¢åŠ æ¶ˆè´¹èƒ½åŠ›ï¼‰
```

**ğŸ”¸ ç¼–ç¨‹ä¸­çš„èƒŒå‹åœºæ™¯**
```
å…¸å‹åœºæ™¯ï¼š
æ•°æ®ç”Ÿäº§è€…ï¼šæ¯ç§’äº§ç”Ÿ1000æ¡æ¶ˆæ¯
æ•°æ®æ¶ˆè´¹è€…ï¼šæ¯ç§’åªèƒ½å¤„ç†100æ¡æ¶ˆæ¯
ç»“æœï¼šå†…å­˜ä¸­ç§¯å‹è¶Šæ¥è¶Šå¤šæ•°æ®ï¼Œæœ€ç»ˆå†…å­˜æº¢å‡º

å®é™…ä¾‹å­ï¼š
- æ—¥å¿—ç³»ç»Ÿï¼šæ—¥å¿—äº§ç”Ÿé€Ÿåº¦ > å†™å…¥ç£ç›˜é€Ÿåº¦
- æ¶ˆæ¯é˜Ÿåˆ—ï¼šæ¶ˆæ¯ç”Ÿäº§é€Ÿåº¦ > æ¶ˆæ¯æ¶ˆè´¹é€Ÿåº¦  
- æ–‡ä»¶å¤„ç†ï¼šæ–‡ä»¶è¯»å–é€Ÿåº¦ > æ•°æ®å¤„ç†é€Ÿåº¦
```

### 6.2 Reactorçš„èƒŒå‹ç­–ç•¥

**âš¡ å†…ç½®èƒŒå‹å¤„ç†ç­–ç•¥**

```java
public class BackpressureStrategies {
    
    public void demonstrateStrategies() {
        // 1. ç¼“å†²ç­–ç•¥ - ç¼“å­˜æ•°æ®ç›´åˆ°æ¶ˆè´¹è€…å‡†å¤‡å¥½
        Flux<Integer> buffered = Flux.range(1, 1000)
            .onBackpressureBuffer(100); // æœ€å¤šç¼“å†²100ä¸ªå…ƒç´ 
            
        // 2. ä¸¢å¼ƒç­–ç•¥ - ä¸¢å¼ƒæœ€æ–°çš„æ•°æ®
        Flux<Integer> dropLatest = Flux.range(1, 1000)
            .onBackpressureDrop(item -> {
                System.out.println("ä¸¢å¼ƒäº†æ•°æ®ï¼š" + item);
            });
            
        // 3. ä¿ç•™æœ€æ–°ç­–ç•¥ - åªä¿ç•™æœ€æ–°çš„æ•°æ®
        Flux<Integer> keepLatest = Flux.range(1, 1000)
            .onBackpressureLatest();
            
        // 4. é”™è¯¯ç­–ç•¥ - èƒŒå‹æ—¶æŠ›å‡ºå¼‚å¸¸
        Flux<Integer> error = Flux.range(1, 1000)
            .onBackpressureError();
    }
    
    // å®é™…åº”ç”¨ç¤ºä¾‹ï¼šæ—¥å¿—å¤„ç†ç³»ç»Ÿ
    public Flux<LogEntry> processLogs() {
        return logSource.getLogStream()
            .onBackpressureBuffer(
                1000,                                    // ç¼“å†²åŒºå¤§å°
                dropped -> logger.warn("æ—¥å¿—ä¸¢å¤±: {}", dropped), // æº¢å‡ºæ—¶çš„å›è°ƒ
                BufferOverflowStrategy.DROP_OLDEST       // æº¢å‡ºç­–ç•¥ï¼šä¸¢å¼ƒæœ€æ—§çš„
            )
            .publishOn(Schedulers.elastic())             // åˆ‡æ¢åˆ°IOçº¿ç¨‹
            .flatMap(this::processLogEntry, 10);         // é™åˆ¶å¹¶å‘æ•°ä¸º10
    }
}
```

### 6.3 èƒŒå‹çš„æœ€ä½³å®è·µ

**ğŸ›¡ï¸ å®é™…é¡¹ç›®ä¸­çš„èƒŒå‹å¤„ç†**

```java
@Service  
public class DataProcessingService {
    
    // å¤§æ–‡ä»¶å¤„ç†çš„èƒŒå‹æ§åˆ¶
    public Flux<ProcessResult> processBigFile(String filePath) {
        return Flux.using(
            () -> Files.lines(Paths.get(filePath)),      // èµ„æºè·å–
            Flux::fromStream,                            // è½¬æ¢ä¸ºFlux
            BaseStream::close                            // èµ„æºæ¸…ç†
        )
        .subscribeOn(Schedulers.boundedElastic())        // ä½¿ç”¨æœ‰ç•Œå¼¹æ€§è°ƒåº¦å™¨
        .onBackpressureBuffer(                           // èƒŒå‹ç¼“å†²é…ç½®
            1000,                                        // ç¼“å†²åŒºå¤§å°
            line -> logger.warn("å¤„ç†ç¼“æ…¢ï¼Œè·³è¿‡è¡Œ: {}", line),
            BufferOverflowStrategy.DROP_LATEST
        )
        .window(100)                                     // åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹100è¡Œ
        .flatMap(batch -> batch.collectList()           // æ”¶é›†æ‰¹æ¬¡
            .flatMapMany(this::processBatch)             // å¤„ç†ä¸€æ‰¹æ•°æ®
            .onErrorContinue((error, item) ->            // é”™è¯¯å¤„ç†
                logger.error("å¤„ç†å¤±è´¥: {}", item, error)
            )
        );
    }
    
    // å®æ—¶æ•°æ®æµçš„èƒŒå‹å¤„ç†
    public Flux<AlertEvent> monitorSystem() {
        return systemMetrics.getMetricStream()
            .sample(Duration.ofSeconds(1))               // é‡‡æ ·ï¼šæ¯ç§’å–ä¸€ä¸ªæ ·æœ¬
            .onBackpressureLatest()                      // èƒŒå‹ï¼šåªä¿ç•™æœ€æ–°æ•°æ®
            .filter(this::isAbnormal)                    // è¿‡æ»¤å¼‚å¸¸æŒ‡æ ‡
            .map(this::createAlert)                      // åˆ›å»ºå‘Šè­¦äº‹ä»¶
            .distinctUntilChanged()                      // å»é™¤é‡å¤å‘Šè­¦
            .doOnNext(alert ->                           // è®°å½•å‘Šè­¦
                logger.info("ç³»ç»Ÿå‘Šè­¦: {}", alert)
            );
    }
}
```

---

## 7. ğŸ”§ å‡½æ•°å¼ç¼–ç¨‹åœ¨å“åº”å¼ä¸­çš„åº”ç”¨


### 7.1 å‡½æ•°å¼ç¼–ç¨‹åŸºæœ¬æ¦‚å¿µ

**ğŸ’¡ å‡½æ•°å¼ç¼–ç¨‹å°±åƒ"æ­ç§¯æœ¨"**

```
ä¼ ç»Ÿç¼–ç¨‹æ€ç»´ï¼ˆå‘½ä»¤å¼ï¼‰ï¼š
å‘Šè¯‰è®¡ç®—æœº"æ€ä¹ˆåš"
1. åˆ›å»ºä¸€ä¸ªåˆ—è¡¨
2. éå†åˆ—è¡¨
3. å¯¹æ¯ä¸ªå…ƒç´ åšå¤„ç†
4. æŠŠç»“æœå­˜åˆ°æ–°åˆ—è¡¨

å‡½æ•°å¼ç¼–ç¨‹æ€ç»´ï¼ˆå£°æ˜å¼ï¼‰ï¼š
å‘Šè¯‰è®¡ç®—æœº"è¦ä»€ä¹ˆ"
è¾“å…¥æ•°æ® â†’ åº”ç”¨å‡½æ•°1 â†’ åº”ç”¨å‡½æ•°2 â†’ å¾—åˆ°ç»“æœ

å°±åƒæ­ç§¯æœ¨ï¼š
æ¯ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªç§¯æœ¨å—
æŠŠç§¯æœ¨å—ç»„åˆèµ·æ¥æ„å»ºå¤æ‚åŠŸèƒ½
```

### 7.2 å“åº”å¼ç¼–ç¨‹ä¸­çš„å‡½æ•°å¼æ“ä½œ

**âš¡ å¸¸ç”¨å‡½æ•°å¼æ“ä½œç¬¦**

```java
public class FunctionalReactiveExamples {
    
    // æ•°æ®å¤„ç†æµæ°´çº¿ç¤ºä¾‹
    public Flux<OrderSummary> processOrders() {
        return orderRepository.findAll()                    // è·å–æ‰€æœ‰è®¢å•
            // mapï¼šä¸€å¯¹ä¸€è½¬æ¢
            .map(order -> {
                order.calculateTotal();                     // è®¡ç®—æ€»ä»·
                return order;
            })
            // filterï¼šç­›é€‰è¿‡æ»¤
            .filter(order -> order.getTotal() > 100)       // åªè¦é‡‘é¢å¤§äº100çš„
            // flatMapï¼šä¸€å¯¹å¤šè½¬æ¢
            .flatMap(order -> 
                orderItemService.findByOrderId(order.getId()) // è·å–è®¢å•é¡¹
                    .collectList()                          // æ”¶é›†ä¸ºåˆ—è¡¨
                    .map(items -> new OrderSummary(order, items))
            )
            // groupByï¼šåˆ†ç»„æ“ä½œ
            .groupBy(OrderSummary::getCustomerType)         // æŒ‰å®¢æˆ·ç±»å‹åˆ†ç»„
            .flatMap(group -> 
                group.collectList()                         // æ”¶é›†æ¯ç»„çš„è®¢å•
                    .map(orders -> summarizeByGroup(group.key(), orders))
            )
            // reduceï¼šèšåˆæ“ä½œ
            .reduce(OrderSummary::merge)                    // åˆå¹¶æ‰€æœ‰æ‘˜è¦
            .flux();                                        // è½¬æ¢ä¸ºFlux
    }
    
    // å‡½æ•°ç»„åˆç¤ºä¾‹
    public Mono<UserProfile> buildUserProfile(String userId) {
        // å®šä¹‰å¤„ç†å‡½æ•°
        Function<String, Mono<User>> getUser = 
            id -> userService.findById(id);
            
        Function<User, Mono<List<Order>>> getOrders = 
            user -> orderService.findByUserId(user.getId()).collectList();
            
        Function<User, Mono<UserStats>> getStats = 
            user -> statsService.calculateStats(user.getId());
            
        // ç»„åˆå‡½æ•°æ„å»ºå®Œæ•´çš„ç”¨æˆ·ç”»åƒ
        return getUser.apply(userId)
            .flatMap(user -> 
                Mono.zip(
                    Mono.just(user),        // ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
                    getOrders.apply(user),  // ç”¨æˆ·è®¢å•
                    getStats.apply(user)    // ç”¨æˆ·ç»Ÿè®¡
                )
                .map(tuple -> new UserProfile(
                    tuple.getT1(),  // user
                    tuple.getT2(),  // orders
                    tuple.getT3()   // stats
                ))
            );
    }
}
```

### 7.3 é«˜é˜¶å‡½æ•°çš„åº”ç”¨

**ğŸ”§ å¤ç”¨å’Œç»„åˆçš„è‰ºæœ¯**

```java
public class HighOrderFunctionExamples {
    
    // é«˜é˜¶å‡½æ•°ï¼šæ¥å—å‡½æ•°ä½œä¸ºå‚æ•°
    public <T, R> Flux<R> processWithRetry(
            Flux<T> source,                              // æ•°æ®æº
            Function<T, Mono<R>> processor,              // å¤„ç†å‡½æ•°
            int maxRetries                               // æœ€å¤§é‡è¯•æ¬¡æ•°
    ) {
        return source.flatMap(item -> 
            processor.apply(item)                        // åº”ç”¨å¤„ç†å‡½æ•°
                .retryWhen(Retry.fixedDelay(maxRetries, Duration.ofSeconds(1)))
                .onErrorResume(error -> {
                    logger.error("å¤„ç†å¤±è´¥: {}", item, error);
                    return Mono.empty();                 // å¤±è´¥æ—¶è¿”å›ç©º
                })
        );
    }
    
    // å‡½æ•°æŸ¯é‡ŒåŒ–ï¼šå°†å¤šå‚æ•°å‡½æ•°è½¬ä¸ºå•å‚æ•°å‡½æ•°é“¾
    public Function<String, Function<Integer, Mono<ValidationResult>>> 
    createValidator() {
        return fieldName -> maxLength -> value -> {
            if (value != null && value.length() <= maxLength) {
                return Mono.just(ValidationResult.valid(fieldName));
            } else {
                return Mono.just(ValidationResult.invalid(
                    fieldName, "é•¿åº¦è¶…è¿‡ " + maxLength + " å­—ç¬¦"
                ));
            }
        };
    }
    
    // ä½¿ç”¨æŸ¯é‡ŒåŒ–å‡½æ•°
    public void useValidator() {
        Function<String, Function<Integer, Mono<ValidationResult>>> validator = 
            createValidator();
            
        // åˆ›å»ºå…·ä½“çš„éªŒè¯å™¨
        Function<String, Mono<ValidationResult>> nameValidator = 
            validator.apply("å§“å").apply(50);
        Function<String, Mono<ValidationResult>> emailValidator = 
            validator.apply("é‚®ç®±").apply(100);
            
        // ä½¿ç”¨éªŒè¯å™¨
        Mono<List<ValidationResult>> validationResults = Flux.just(
                nameValidator.apply("å¼ ä¸‰"),
                emailValidator.apply("zhang.san@example.com")
            )
            .flatMap(mono -> mono)                       // æ‰§è¡ŒéªŒè¯
            .collectList();                              // æ”¶é›†ç»“æœ
    }
}
```

---

## 8. âš¡ å¼‚æ­¥å¤„ç†æœ€ä½³å®è·µ


### 8.1 å¼‚æ­¥ç¼–ç¨‹çš„å¸¸è§é™·é˜±

**ğŸš¨ æ–°æ‰‹å®¹æ˜“çŠ¯çš„é”™è¯¯**

```java
public class CommonAsyncMistakes {
    
    // âŒ é”™è¯¯1ï¼šåœ¨å“åº”å¼é“¾ä¸­ä½¿ç”¨é˜»å¡æ“ä½œ
    public Mono<User> badExample1(String userId) {
        return userRepository.findById(userId)
            .map(user -> {
                // é”™è¯¯ï¼šåœ¨å“åº”å¼é“¾ä¸­è°ƒç”¨é˜»å¡æ–¹æ³•
                String email = legacyEmailService.getEmail(user.getId()); // é˜»å¡è°ƒç”¨
                user.setEmail(email);
                return user;
            });
    }
    
    // âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨flatMapå¤„ç†å¼‚æ­¥æ“ä½œ
    public Mono<User> goodExample1(String userId) {
        return userRepository.findById(userId)
            .flatMap(user -> 
                emailService.getEmailAsync(user.getId())    // å¼‚æ­¥è°ƒç”¨
                    .map(email -> {
                        user.setEmail(email);
                        return user;
                    })
            );
    }
    
    // âŒ é”™è¯¯2ï¼šè¿‡åº¦åµŒå¥—çš„flatMap
    public Mono<OrderResult> badExample2(String orderId) {
        return orderRepository.findById(orderId)
            .flatMap(order ->
                customerService.findById(order.getCustomerId())
                    .flatMap(customer ->
                        paymentService.processPayment(order.getAmount())
                            .flatMap(payment ->
                                inventoryService.updateStock(order.getItems())
                                    .map(inventory -> 
                                        new OrderResult(order, customer, payment, inventory)
                                    )
                            )
                    )
            );
    }
    
    // âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨zipç»„åˆå¹¶è¡Œæ“ä½œ
    public Mono<OrderResult> goodExample2(String orderId) {
        return orderRepository.findById(orderId)
            .flatMap(order -> {
                Mono<Customer> customerMono = customerService.findById(order.getCustomerId());
                Mono<Payment> paymentMono = paymentService.processPayment(order.getAmount());
                Mono<Inventory> inventoryMono = inventoryService.updateStock(order.getItems());
                
                return Mono.zip(customerMono, paymentMono, inventoryMono)
                    .map(tuple -> new OrderResult(
                        order, 
                        tuple.getT1(), // customer
                        tuple.getT2(), // payment  
                        tuple.getT3()  // inventory
                    ));
            });
    }
}
```

### 8.2 å¼‚æ­¥å¼‚å¸¸å¤„ç†ç­–ç•¥

**ğŸ›¡ï¸ ä¼˜é›…çš„é”™è¯¯å¤„ç†**

```java
@Service
public class AsyncErrorHandlingService {
    
    // åˆ†å±‚é”™è¯¯å¤„ç†ç­–ç•¥
    public Mono<ApiResponse<User>> getUserWithErrorHandling(String userId) {
        return userService.findById(userId)
            // 1. ä¸šåŠ¡å±‚é”™è¯¯å¤„ç†
            .onErrorMap(DatabaseException.class, ex -> 
                new ServiceException("ç”¨æˆ·æ•°æ®è®¿é—®å¤±è´¥", ex)
            )
            // 2. é‡è¯•æœºåˆ¶
            .retryWhen(Retry.backoff(3, Duration.ofSeconds(1))
                .filter(throwable -> throwable instanceof TransientException)
                .onRetryExhaustedThrow((retryBackoffSpec, retrySignal) -> 
                    new ServiceException("é‡è¯•æ¬¡æ•°ç”¨å°½ï¼ŒæœåŠ¡æš‚æ—¶ä¸å¯ç”¨")
                )
            )
            // 3. é™çº§å¤„ç†
            .onErrorResume(ServiceException.class, ex -> {
                logger.error("è·å–ç”¨æˆ·å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç”¨æˆ·", ex);
                return Mono.just(createDefaultUser(userId));
            })
            // 4. æœ€ç»ˆåŒ…è£…ä¸ºAPIå“åº”
            .map(user -> ApiResponse.success(user))
            .onErrorReturn(ApiResponse.error("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"));
    }
    
    // å¹¶è¡Œå¤„ç†çš„é”™è¯¯éš”ç¦»
    public Mono<DashboardData> getDashboardData(String userId) {
        // å„ä¸ªæ•°æ®è·å–éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸€ä¸ªå¤±è´¥ä¸å½±å“å…¶ä»–
        Mono<UserProfile> profileMono = getUserProfile(userId)
            .onErrorResume(ex -> {
                logger.warn("è·å–ç”¨æˆ·ç”»åƒå¤±è´¥", ex);
                return Mono.just(UserProfile.empty());
            });
            
        Mono<List<Order>> ordersMono = getRecentOrders(userId)
            .onErrorResume(ex -> {
                logger.warn("è·å–è®¢å•å†å²å¤±è´¥", ex);  
                return Mono.just(Collections.emptyList());
            });
            
        Mono<Notification> notificationMono = getNotifications(userId)
            .onErrorResume(ex -> {
                logger.warn("è·å–é€šçŸ¥å¤±è´¥", ex);
                return Mono.just(Notification.empty());
            });
            
        // ç»„åˆæ‰€æœ‰æ•°æ®ï¼Œå³ä½¿éƒ¨åˆ†å¤±è´¥ä¹Ÿèƒ½è¿”å›å¯ç”¨æ•°æ®
        return Mono.zip(profileMono, ordersMono, notificationMono)
            .map(tuple -> new DashboardData(
                tuple.getT1(), // profile
                tuple.getT2(), // orders
                tuple.getT3()  // notifications
            ));
    }
}
```

### 8.3 æ€§èƒ½ä¼˜åŒ–æŠ€å·§

**âš¡ å“åº”å¼æ€§èƒ½è°ƒä¼˜**

```java
@Configuration
public class ReactivePerformanceConfig {
    
    // 1. åˆç†é…ç½®çº¿ç¨‹æ± 
    @Bean
    public Scheduler ioScheduler() {
        return Schedulers.fromExecutor(
            Executors.newFixedThreadPool(
                50,  // IOå¯†é›†ä»»åŠ¡çš„çº¿ç¨‹æ•°
                new ThreadFactoryBuilder()
                    .setNameFormat("io-thread-%d")
                    .setDaemon(true)
                    .build()
            )
        );
    }
    
    // 2. é…ç½®ç¼“å­˜ç­–ç•¥
    @Bean
    public CacheManager reactiveCacheManager() {
        return CacheManager.builder()
            .withCacheExpiry(Duration.ofMinutes(5))    // 5åˆ†é’Ÿè¿‡æœŸ
            .withMaxSize(1000)                         // æœ€å¤§ç¼“å­˜æ•°é‡
            .build();
    }
}

@Service
public class OptimizedDataService {
    
    // æ‰¹é‡å¤„ç†ä¼˜åŒ–
    public Flux<ProcessResult> processBatchOptimized(Flux<DataItem> items) {
        return items
            .buffer(100)                               // åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹100ä¸ª
            .flatMap(batch -> 
                processItemsBatch(batch)               // æ‰¹é‡å¤„ç†
                    .subscribeOn(ioScheduler)          // åœ¨IOçº¿ç¨‹æ± æ‰§è¡Œ
                    .publishOn(Schedulers.parallel())  // åˆ‡æ¢åˆ°CPUçº¿ç¨‹æ± 
            , 4)                                       // é™åˆ¶å¹¶å‘æ‰¹æ¬¡æ•°
            .flatMapIterable(Function.identity());     // å±•å¼€ç»“æœ
    }
    
    // ç¼“å­˜ä¼˜åŒ–
    public Mono<ExpensiveResult> getExpensiveData(String key) {
        return Mono.fromCallable(() -> cacheManager.get(key))
            .cast(ExpensiveResult.class)
            .switchIfEmpty(
                // ç¼“å­˜æœªå‘½ä¸­æ—¶è®¡ç®—
                computeExpensiveResult(key)
                    .doOnNext(result -> 
                        cacheManager.put(key, result)  // ç¼“å­˜ç»“æœ
                    )
            )
            .subscribeOn(Schedulers.boundedElastic());
    }
    
    // é¢„çƒ­å’Œé¢„å–ä¼˜åŒ–
    @PostConstruct
    public void preloadData() {
        // ç³»ç»Ÿå¯åŠ¨æ—¶é¢„åŠ è½½å¸¸ç”¨æ•°æ®
        commonDataKeys.forEach(key -> 
            getExpensiveData(key)
                .subscribe(result -> 
                    logger.info("é¢„åŠ è½½æ•°æ®å®Œæˆ: {}", key)
                )
        );
    }
}
```

---

## 9. ğŸŒ äº‹ä»¶é©±åŠ¨æ¶æ„è®¾è®¡


### 9.1 äº‹ä»¶é©±åŠ¨æ¶æ„åŸºæœ¬æ¦‚å¿µ

**ğŸ“¡ äº‹ä»¶é©±åŠ¨å°±åƒ"å¾®ä¿¡ç¾¤èŠ"**

```
ä¼ ç»Ÿæ¶æ„ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ï¼š
è®¢å•æœåŠ¡ï¼šæˆ‘åˆ›å»ºäº†ä¸€ä¸ªè®¢å•
åº“å­˜æœåŠ¡ï¼šå¥½çš„ï¼Œæˆ‘æ¥å‡åº“å­˜
æ”¯ä»˜æœåŠ¡ï¼šå¥½çš„ï¼Œæˆ‘æ¥æ‰£æ¬¾  
é€šçŸ¥æœåŠ¡ï¼šå¥½çš„ï¼Œæˆ‘æ¥å‘é€šçŸ¥
ç»“æœï¼šæ‰€æœ‰æœåŠ¡å¿…é¡»éƒ½åœ¨çº¿ï¼Œä¸€ä¸ªæœåŠ¡æŒ‚äº†æ•´ä¸ªæµç¨‹ä¸­æ–­

äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆå¼‚æ­¥è§£è€¦ï¼‰ï¼š
è®¢å•æœåŠ¡ï¼šå‘å¸ƒ"è®¢å•åˆ›å»º"äº‹ä»¶åˆ°ç¾¤é‡Œï¼Œç„¶åå»åšå…¶ä»–äº‹
åº“å­˜æœåŠ¡ï¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œå¤„ç†å‡åº“å­˜ï¼Œå®Œæˆåå‘å¸ƒ"åº“å­˜æ›´æ–°"äº‹ä»¶
æ”¯ä»˜æœåŠ¡ï¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œå¤„ç†æ‰£æ¬¾ï¼Œå®Œæˆåå‘å¸ƒ"æ”¯ä»˜å®Œæˆ"äº‹ä»¶
é€šçŸ¥æœåŠ¡ï¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œå‘é€é€šçŸ¥ç»™ç”¨æˆ·
ç»“æœï¼šå„æœåŠ¡ç‹¬ç«‹å·¥ä½œï¼Œä¸€ä¸ªæœåŠ¡ä¸´æ—¶æŒ‚äº†ä¸å½±å“å…¶ä»–æœåŠ¡
```

### 9.2 å“åº”å¼äº‹ä»¶å¤„ç†

**âš¡ Spring WebFluxä¸­çš„äº‹ä»¶å¤„ç†**

```java
// äº‹ä»¶å®šä¹‰
public abstract class DomainEvent {
    private final String eventId;
    private final Instant timestamp;
    private final String eventType;
    
    protected DomainEvent(String eventType) {
        this.eventId = UUID.randomUUID().toString();
        this.timestamp = Instant.now();
        this.eventType = eventType;
    }
}

public class OrderCreatedEvent extends DomainEvent {
    private final String orderId;
    private final String customerId;
    private final BigDecimal amount;
    
    public OrderCreatedEvent(String orderId, String customerId, BigDecimal amount) {
        super("ORDER_CREATED");
        this.orderId = orderId;
        this.customerId = customerId;
        this.amount = amount;
    }
}

// äº‹ä»¶å‘å¸ƒå™¨
@Component
public class ReactiveEventPublisher {
    
    private final Sinks.Many<DomainEvent> eventSink = 
        Sinks.many().multicast().onBackpressureBuffer();
    
    public void publishEvent(DomainEvent event) {
        eventSink.tryEmitNext(event);
        logger.info("å‘å¸ƒäº‹ä»¶: {}", event);
    }
    
    public Flux<DomainEvent> getEventStream() {
        return eventSink.asFlux()
            .share(); // å¤šä¸ªè®¢é˜…è€…å¯ä»¥å…±äº«äº‹ä»¶æµ
    }
    
    // æŒ‰äº‹ä»¶ç±»å‹è¿‡æ»¤
    public <T extends DomainEvent> Flux<T> getEventStream(Class<T> eventType) {
        return getEventStream()
            .filter(event -> eventType.isInstance(event))
            .cast(eventType);
    }
}
```

### 9.3 äº‹ä»¶å¤„ç†å™¨æ¨¡å¼

**ğŸ”§ ä¸åŒç±»å‹çš„äº‹ä»¶å¤„ç†ç­–ç•¥**

```java
// äº‹ä»¶å¤„ç†å™¨æ¥å£
public interface EventHandler<T extends DomainEvent> {
    Mono<Void> handle(T event);
}

// è®¢å•åˆ›å»ºäº‹ä»¶å¤„ç†å™¨
@Component
public class OrderCreatedEventHandler implements EventHandler<OrderCreatedEvent> {
    
    private final InventoryService inventoryService;
    private final PaymentService paymentService;
    private final NotificationService notificationService;
    
    @Override
    public Mono<Void> handle(OrderCreatedEvent event) {
        logger.info("å¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶: {}", event.getOrderId());
        
        return Mono.just(event)
            .flatMap(this::validateOrder)        // è®¢å•éªŒè¯
            .flatMap(this::reserveInventory)     // åº“å­˜é¢„ç•™
            .flatMap(this::processPayment)       // æ”¯ä»˜å¤„ç†
            .flatMap(this::sendConfirmation)     // å‘é€ç¡®è®¤
            .onErrorResume(this::handleError)    // é”™è¯¯å¤„ç†
            .then();                             // è½¬æ¢ä¸ºMono<Void>
    }
    
    private Mono<OrderCreatedEvent> validateOrder(OrderCreatedEvent event) {
        // è®¢å•éªŒè¯é€»è¾‘
        return orderValidator.validate(event)
            .then(Mono.just(event));
    }
    
    private Mono<OrderCreatedEvent> reserveInventory(OrderCreatedEvent event) {
        return inventoryService.reserve(event.getOrderId(), event.getItems())
            .then(Mono.just(event))
            .onErrorMap(ex -> new InventoryException("åº“å­˜é¢„ç•™å¤±è´¥", ex));
    }
    
    private Mono<OrderCreatedEvent> processPayment(OrderCreatedEvent event) {
        return paymentService.charge(event.getCustomerId(), event.getAmount())
            .then(Mono.just(event))
            .onErrorMap(ex -> new PaymentException("æ”¯ä»˜å¤„ç†å¤±è´¥", ex));
    }
    
    private Mono<OrderCreatedEvent> sendConfirmation(OrderCreatedEvent event) {
        return notificationService.sendOrderConfirmation(event)
            .then(Mono.just(event));
    }
    
    private Mono<OrderCreatedEvent> handleError(Throwable error) {
        logger.error("è®¢å•å¤„ç†å¤±è´¥", error);
        // å‘å¸ƒè®¢å•å¤±è´¥äº‹ä»¶ï¼Œè§¦å‘è¡¥å¿æ“ä½œ
        return Mono.error(new OrderProcessingException("è®¢å•å¤„ç†å¤±è´¥", error));
    }
}

// äº‹ä»¶å¤„ç†å™¨æ³¨å†Œå’Œåˆ†å‘
@Component
public class EventProcessor {
    
    private final Map<Class<? extends DomainEvent>, List<EventHandler<?>>> handlers = new HashMap<>();
    private final ReactiveEventPublisher eventPublisher;
    
    @PostConstruct
    public void initialize() {
        // å¯åŠ¨äº‹ä»¶å¤„ç†æµ
        eventPublisher.getEventStream()
            .flatMap(this::processEvent)
            .onErrorContinue((error, event) -> 
                logger.error("å¤„ç†äº‹ä»¶å¤±è´¥: {}", event, error)
            )
            .subscribe();
    }
    
    @SuppressWarnings("unchecked")
    private Mono<Void> processEvent(DomainEvent event) {
        List<EventHandler<?>> eventHandlers = handlers.get(event.getClass());
        
        if (eventHandlers == null || eventHandlers.isEmpty()) {
            logger.warn("æ²¡æœ‰æ‰¾åˆ°äº‹ä»¶å¤„ç†å™¨: {}", event.getClass());
            return Mono.empty();
        }
        
        // å¹¶è¡Œå¤„ç†æ‰€æœ‰å¤„ç†å™¨
        return Flux.fromIterable(eventHandlers)
            .flatMap(handler -> {
                EventHandler<DomainEvent> typedHandler = (EventHandler<DomainEvent>) handler;
                return typedHandler.handle(event)
                    .onErrorResume(error -> {
                        logger.error("äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œå¤±è´¥: {}", handler.getClass(), error);
                        return Mono.empty(); // ä¸€ä¸ªå¤„ç†å™¨å¤±è´¥ä¸å½±å“å…¶ä»–å¤„ç†å™¨
                    });
            })
            .then();
    }
    
    // æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
    public <T extends DomainEvent> void registerHandler(
            Class<T> eventType, 
            EventHandler<T> handler) {
        handlers.computeIfAbsent(eventType, k -> new ArrayList<>()).add(handler);
    }
}
```

### 9.4 äº‹ä»¶å­˜å‚¨å’Œå›æ”¾

**ğŸ’¾ äº‹ä»¶æº¯æºæ¨¡å¼**

```java
// äº‹ä»¶å­˜å‚¨æ¥å£
public interface EventStore {
    Mono<Void> save(DomainEvent event);
    Flux<DomainEvent> getEventsAfter(String aggregateId, Instant timestamp);
    Flux<DomainEvent> getAllEvents(String aggregateId);
}

// äº‹ä»¶å­˜å‚¨å®ç°
@Repository
public class ReactiveEventStore implements EventStore {
    
    private final ReactiveMongoTemplate mongoTemplate;
    
    @Override
    public Mono<Void> save(DomainEvent event) {
        EventDocument document = new EventDocument(event);
        return mongoTemplate.save(document)
            .doOnSuccess(saved -> 
                logger.debug("äº‹ä»¶å·²ä¿å­˜: {}", saved.getEventId())
            )
            .then();
    }
    
    @Override
    public Flux<DomainEvent> getEventsAfter(String aggregateId, Instant timestamp) {
        Query query = Query.query(
            Criteria.where("aggregateId").is(aggregateId)
                .and("timestamp").gt(timestamp)
        ).with(Sort.by("timestamp").ascending());
        
        return mongoTemplate.find(query, EventDocument.class)
            .map(EventDocument::toDomainEvent);
    }
    
    @Override
    public Flux<DomainEvent> getAllEvents(String aggregateId) {
        Query query = Query.query(
            Criteria.where("aggregateId").is(aggregateId)
        ).with(Sort.by("timestamp").ascending());
        
        return mongoTemplate.find(query, EventDocument.class)
            .map(EventDocument::toDomainEvent);
    }
}

// äº‹ä»¶å›æ”¾æœåŠ¡
@Service
public class EventReplayService {
    
    private final EventStore eventStore;
    private final EventProcessor eventProcessor;
    
    // é‡æ”¾ç‰¹å®šèšåˆçš„æ‰€æœ‰äº‹ä»¶
    public Mono<Void> replayEvents(String aggregateId) {
        return eventStore.getAllEvents(aggregateId)
            .doOnNext(event -> 
                logger.info("é‡æ”¾äº‹ä»¶: {}", event)
            )
            .flatMap(eventProcessor::processEvent)
            .then();
    }
    
    // é‡æ”¾æŒ‡å®šæ—¶é—´ç‚¹ä¹‹åçš„äº‹ä»¶
    public Mono<Void> replayEventsAfter(String aggregateId, Instant timestamp) {
        return eventStore.getEventsAfter(aggregateId, timestamp)
            .flatMap(eventProcessor::processEvent)
            .then();
    }
    
    // ç³»ç»Ÿæ¢å¤ï¼šé‡æ”¾æ‰€æœ‰æœªå¤„ç†çš„äº‹ä»¶
    public Mono<Void> recoverSystem() {
        Instant lastProcessedTime = getLastProcessedTime();
        
        return eventStore.getEventsAfter(null, lastProcessedTime)
            .flatMap(eventProcessor::processEvent)
            .doOnComplete(() -> 
                updateLastProcessedTime(Instant.now())
            )
            .then();
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å“åº”å¼ç¼–ç¨‹ï¼šå¼‚æ­¥éé˜»å¡çš„ç¼–ç¨‹èŒƒå¼ï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡
ğŸ”¸ Spring WebFluxï¼šSpringçš„å“åº”å¼Webæ¡†æ¶ï¼Œæ”¯æŒé«˜å¹¶å‘
ğŸ”¸ Reactoråº“ï¼šæä¾›Monoå’ŒFluxä¸¤ç§å“åº”å¼æ•°æ®ç±»å‹
ğŸ”¸ Mono vs Fluxï¼šå•ä¸ªå€¼vså¤šä¸ªå€¼çš„å¼‚æ­¥æ•°æ®æµ
ğŸ”¸ éé˜»å¡IOï¼šä¸ç­‰å¾…IOæ“ä½œå®Œæˆï¼Œæé«˜ç³»ç»Ÿååé‡
ğŸ”¸ èƒŒå‹å¤„ç†ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é€Ÿåº¦ä¸åŒ¹é…æ—¶çš„ç¼“å†²ç­–ç•¥
ğŸ”¸ å‡½æ•°å¼ç¼–ç¨‹ï¼šä½¿ç”¨å‡½æ•°ç»„åˆçš„æ–¹å¼å¤„ç†æ•°æ®æµ
ğŸ”¸ å¼‚æ­¥å¤„ç†ï¼šé¿å…é˜»å¡æ“ä½œï¼Œåˆç†å¤„ç†å¼‚å¸¸å’Œé”™è¯¯
ğŸ”¸ äº‹ä»¶é©±åŠ¨ï¼šé€šè¿‡äº‹ä»¶è§£è€¦æœåŠ¡ï¼Œæé«˜ç³»ç»Ÿå¼¹æ€§
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å“åº”å¼ç¼–ç¨‹çš„æ ¸å¿ƒä»·å€¼**
```
èµ„æºæ•ˆç‡ï¼š
- å°‘é‡çº¿ç¨‹å¤„ç†å¤§é‡è¯·æ±‚
- é™ä½å†…å­˜å ç”¨å’Œä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬
- æé«˜CPUå’ŒIOèµ„æºåˆ©ç”¨ç‡

ç³»ç»Ÿæ€§èƒ½ï¼š
- æ”¯æŒæ›´é«˜çš„å¹¶å‘æ•°
- æ›´å¿«çš„å“åº”æ—¶é—´
- æ›´å¥½çš„å¯æ‰©å±•æ€§

å¼€å‘ä½“éªŒï¼š
- å£°æ˜å¼ç¼–ç¨‹æ¨¡å¼
- ä¸°å¯Œçš„æ“ä½œç¬¦æ”¯æŒ
- å‡½æ•°ç»„åˆçš„çµæ´»æ€§
```

**ğŸ”¹ ä½•æ—¶ä½¿ç”¨å“åº”å¼ç¼–ç¨‹**
```
é€‚åˆåœºæ™¯ï¼š
- é«˜å¹¶å‘Webåº”ç”¨
- å®æ—¶æ•°æ®å¤„ç†
- å¾®æœåŠ¡æ¶æ„
- IOå¯†é›†å‹åº”ç”¨

ä¸é€‚åˆåœºæ™¯ï¼š
- ç®€å•çš„CRUDåº”ç”¨
- å›¢é˜Ÿç¼ºä¹ç›¸å…³ç»éªŒ
- è°ƒè¯•å’Œæ’é”™è¦æ±‚é«˜
- ä¸šåŠ¡é€»è¾‘å¤æ‚åº¦ä½
```

**ğŸ”¹ å­¦ä¹ å’Œå®è·µå»ºè®®**
```
å­¦ä¹ è·¯å¾„ï¼š
1. ç†è§£å“åº”å¼ç¼–ç¨‹åŸºæœ¬æ¦‚å¿µ
2. æŒæ¡Monoå’ŒFluxçš„åŸºæœ¬æ“ä½œ
3. å­¦ä¹ å¸¸ç”¨æ“ä½œç¬¦çš„ä½¿ç”¨
4. å®è·µé”™è¯¯å¤„ç†å’ŒèƒŒå‹æ§åˆ¶
5. åº”ç”¨åˆ°å®é™…é¡¹ç›®ä¸­

æ³¨æ„äº‹é¡¹ï¼š
- é¿å…åœ¨å“åº”å¼é“¾ä¸­ä½¿ç”¨é˜»å¡æ“ä½œ
- åˆç†å¤„ç†å¼‚å¸¸å’Œé”™è¯¯æƒ…å†µ
- æ³¨æ„èƒŒå‹å¤„ç†é¿å…å†…å­˜æº¢å‡º
- é€‰æ‹©åˆé€‚çš„è°ƒåº¦å™¨æ‰§è¡Œä»»åŠ¡
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒåº”ç”¨åœºæ™¯**
- **åœ¨çº¿ç›´æ’­å¹³å°**ï¼šå®æ—¶å¼¹å¹•ã€è§‚ä¼—äº’åŠ¨ã€æµåª’ä½“æ¨é€
- **é‡‘èäº¤æ˜“ç³»ç»Ÿ**ï¼šå®æ—¶è¡Œæƒ…æ¨é€ã€é«˜é¢‘äº¤æ˜“å¤„ç†
- **ç‰©è”ç½‘å¹³å°**ï¼šè®¾å¤‡çŠ¶æ€ç›‘æ§ã€æ•°æ®å®æ—¶é‡‡é›†
- **ç”µå•†å¹³å°**ï¼šç§’æ€æ´»åŠ¨ã€åº“å­˜å®æ—¶æ›´æ–°ã€è®¢å•çŠ¶æ€æ¨é€

**ğŸ”§ é¡¹ç›®å®è·µå»ºè®®**
- **æ¸è¿›å¼é‡‡ç”¨**ï¼šä»æ–°æ¨¡å—å¼€å§‹ä½¿ç”¨ï¼Œé€æ­¥æ‰©å±•åˆ°æ•´ä¸ªç³»ç»Ÿ
- **å›¢é˜ŸåŸ¹è®­**ï¼šç¡®ä¿å›¢é˜Ÿæˆå‘˜ç†è§£å“åº”å¼ç¼–ç¨‹æ¦‚å¿µ
- **ç›‘æ§å®Œå–„**ï¼šå»ºç«‹é’ˆå¯¹å“åº”å¼åº”ç”¨çš„ç›‘æ§ä½“ç³»
- **æµ‹è¯•ç­–ç•¥**ï¼šåˆ¶å®šå“åº”å¼ä»£ç çš„æµ‹è¯•æ–¹æ³•å’Œç­–ç•¥

**ğŸ“ˆ æŠ€æœ¯å‘å±•è¶‹åŠ¿**
- **äº‘åŸç”Ÿæ”¯æŒ**ï¼šä¸Kubernetesã€Spring Cloudé›†æˆ
- **å·¥å…·ç”Ÿæ€å®Œå–„**ï¼šè°ƒè¯•å·¥å…·ã€ç›‘æ§å·¥å…·ä¸æ–­æ”¹è¿›
- **æ€§èƒ½æŒç»­ä¼˜åŒ–**ï¼šJVMå’Œæ¡†æ¶å±‚é¢çš„æ€§èƒ½æå‡
- **æ ‡å‡†åŒ–è¿›ç¨‹**ï¼šReactive Streamsè§„èŒƒçš„æ¨å¹¿åº”ç”¨

**å­¦ä¹ è®°å¿†å£è¯€**ï¼š
- å“åº”å¼ç¼–ç¨‹å¼‚æ­¥å¥½ï¼Œå°‘é‡çº¿ç¨‹æ•ˆç‡é«˜
- Monoå•å€¼Fluxå¤šå€¼ï¼Œæ“ä½œç¬¦ç»„åˆå·§å¦™
- èƒŒå‹å¤„ç†é˜²æº¢å‡ºï¼Œå‡½æ•°ç»„åˆä»£ç æ¸…
- äº‹ä»¶é©±åŠ¨ç³»ç»Ÿæ¾ï¼Œéé˜»å¡IOæ€§èƒ½ä¼˜