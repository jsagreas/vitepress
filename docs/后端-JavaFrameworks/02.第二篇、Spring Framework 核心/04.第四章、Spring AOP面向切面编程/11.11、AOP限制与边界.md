---
title: 11ã€AOPé™åˆ¶ä¸è¾¹ç•Œ
---
## ğŸ“š ç›®å½•

1. [AOPçš„é™åˆ¶æ¦‚è¿°](#1-AOPçš„é™åˆ¶æ¦‚è¿°)
2. [è‡ªè°ƒç”¨å¤±æ•ˆé—®é¢˜](#2-è‡ªè°ƒç”¨å¤±æ•ˆé—®é¢˜)
3. [finalæ–¹æ³•çš„é™åˆ¶](#3-finalæ–¹æ³•çš„é™åˆ¶)
4. [ä»£ç†æœºåˆ¶çš„è¾¹ç•Œ](#4-ä»£ç†æœºåˆ¶çš„è¾¹ç•Œ)
5. [äº‹åŠ¡å¤±æ•ˆçš„å¸¸è§åœºæ™¯](#5-äº‹åŠ¡å¤±æ•ˆçš„å¸¸è§åœºæ™¯)
6. [æ€§èƒ½å½±å“åˆ†æ](#6-æ€§èƒ½å½±å“åˆ†æ)
7. [è°ƒè¯•å›°éš¾ä¸è§£å†³æ–¹æ¡ˆ](#7-è°ƒè¯•å›°éš¾ä¸è§£å†³æ–¹æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš« AOPçš„é™åˆ¶æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆAOPä¼šæœ‰é™åˆ¶


**ç†è§£AOPçš„æœ¬è´¨**ï¼š

AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æœ¬è´¨ä¸Šæ˜¯é€šè¿‡**ä»£ç†æ¨¡å¼**æ¥å·¥ä½œçš„ã€‚å°±åƒä½ æ‰¾äº†ä¸ªåŠ©æ‰‹å¸®ä½ å¤„ç†äº‹åŠ¡ï¼Œä½†è¿™ä¸ªåŠ©æ‰‹ä¸æ˜¯ä½ æœ¬äººï¼Œæ‰€ä»¥æœ‰äº›äº‹æƒ…ä»–åšä¸åˆ°ã€‚

```
çœŸå®å¯¹è±¡ï¼ˆä½ æœ¬äººï¼‰         ä»£ç†å¯¹è±¡ï¼ˆåŠ©æ‰‹ï¼‰
    â†“                        â†“
 å¯ä»¥è‡ªå·±è°ƒç”¨è‡ªå·±      â†’   æ— æ³•è§¦å‘å†…éƒ¨è°ƒç”¨çš„å¢å¼º
 å¯ä»¥æ˜¯finalæ–¹æ³•      â†’   æ— æ³•ä»£ç†finalæ–¹æ³•
 æ€§èƒ½å¼€é”€å°           â†’   å¤šäº†ä¸€å±‚ä»£ç†å¼€é”€
```

**æ ¸å¿ƒé™åˆ¶ç±»å‹**ï¼š

| é™åˆ¶ç±»å‹ | **äº§ç”ŸåŸå› ** | **å½±å“èŒƒå›´** | **ä¸¥é‡ç¨‹åº¦** |
|---------|------------|------------|------------|
| ğŸ”´ **è‡ªè°ƒç”¨å¤±æ•ˆ** | `ä»£ç†å¯¹è±¡æ— æ³•æ‹¦æˆªå†…éƒ¨è°ƒç”¨` | `@Transactional`ã€åˆ‡é¢æ–¹æ³• | `é«˜ - å®¹æ˜“å‡ºbug` |
| ğŸŸ¡ **finalé™åˆ¶** | `ä»£ç†éœ€è¦ç»§æ‰¿æˆ–å®ç°æ¥å£` | `finalç±»/æ–¹æ³•` | `ä¸­ - è®¾è®¡é—®é¢˜` |
| ğŸŸ¡ **æ€§èƒ½å¼€é”€** | `ä»£ç†å±‚å¢åŠ è°ƒç”¨é“¾è·¯` | `é«˜é¢‘è°ƒç”¨åœºæ™¯` | `ä¸­ - å¯ä¼˜åŒ–` |
| ğŸŸ¢ **è°ƒè¯•å›°éš¾** | `ä»£ç†å¯¹è±¡é®è”½çœŸå®å¯¹è±¡` | `å¼€å‘è°ƒè¯•é˜¶æ®µ` | `ä½ - å·¥å…·å¯è§£å†³` |

### 1.2 é™åˆ¶äº§ç”Ÿçš„æ ¹æœ¬åŸå› 


**ä»£ç†æœºåˆ¶çš„å·¥ä½œåŸç†**ï¼š

```
å®¢æˆ·ç«¯è°ƒç”¨æµç¨‹ï¼š

ä¼ ç»Ÿè°ƒç”¨ï¼š
å®¢æˆ·ç«¯ â†’ ç›®æ ‡å¯¹è±¡.æ–¹æ³•()
        â†“
       ç›´æ¥æ‰§è¡Œ

AOPä»£ç†è°ƒç”¨ï¼š
å®¢æˆ·ç«¯ â†’ ä»£ç†å¯¹è±¡.æ–¹æ³•()
        â†“
       å‰ç½®å¢å¼º
        â†“
       ç›®æ ‡å¯¹è±¡.æ–¹æ³•()
        â†“
       åç½®å¢å¼º
```

**å…³é”®ç†è§£**ï¼š
- å¢å¼ºé€»è¾‘åœ¨**ä»£ç†å¯¹è±¡**ä¸Šï¼Œä¸åœ¨**çœŸå®å¯¹è±¡**ä¸Š
- åªæœ‰é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ï¼Œå¢å¼ºæ‰ä¼šç”Ÿæ•ˆ
- å†…éƒ¨è°ƒç”¨ç”¨çš„æ˜¯`this`ï¼ŒæŒ‡å‘çœŸå®å¯¹è±¡è€Œéä»£ç†

---

## 2. ğŸ”„ è‡ªè°ƒç”¨å¤±æ•ˆé—®é¢˜


### 2.1 ä»€ä¹ˆæ˜¯è‡ªè°ƒç”¨å¤±æ•ˆ


**é€šä¿—è§£é‡Š**ï¼š

æƒ³è±¡ä½ æ˜¯ä¸ªæœ‰åŠ©æ‰‹çš„è€æ¿ï¼š
- å®¢æˆ·æ‰¾åŠ©æ‰‹åŠäº‹ â†’ åŠ©æ‰‹ä¼šè®°å½•ã€æ”¶è´¹ã€å¤„ç†ï¼ˆå¢å¼ºç”Ÿæ•ˆâœ…ï¼‰
- ä½ è‡ªå·±åŠè‡ªå·±çš„äº‹ â†’ ä¸ç»è¿‡åŠ©æ‰‹ï¼Œæ²¡æœ‰è®°å½•å’Œæ”¶è´¹ï¼ˆå¢å¼ºå¤±æ•ˆâŒï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š

```java
@Service
public class OrderService {
    
    // æ–¹æ³•Aï¼šæœ‰äº‹åŠ¡æ³¨è§£
    @Transactional
    public void createOrder(Order order) {
        // ä¿å­˜è®¢å•
        orderRepository.save(order);
        
        // è‡ªå·±è°ƒç”¨è‡ªå·±çš„æ–¹æ³•B
        this.updateInventory(order);  // âŒ è¿™é‡Œçš„äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆï¼
    }
    
    // æ–¹æ³•Bï¼šä¹Ÿæœ‰äº‹åŠ¡æ³¨è§£
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void updateInventory(Order order) {
        // æ›´æ–°åº“å­˜
        inventoryRepository.update(order);
    }
}
```

### 2.2 ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆ


**å¤±æ•ˆåŸç†å›¾è§£**ï¼š

```
å¤–éƒ¨è°ƒç”¨ï¼ˆâœ… å¢å¼ºç”Ÿæ•ˆï¼‰ï¼š
Controller â†’ ä»£ç†å¯¹è±¡.createOrder()
              â†“
            å¼€å¯äº‹åŠ¡
              â†“
            çœŸå®å¯¹è±¡.createOrder()

å†…éƒ¨è°ƒç”¨ï¼ˆâŒ å¢å¼ºå¤±æ•ˆï¼‰ï¼š
çœŸå®å¯¹è±¡.createOrder()
   â†“
  this.updateInventory()  â† è¿™é‡Œçš„thisæ˜¯çœŸå®å¯¹è±¡ï¼Œä¸æ˜¯ä»£ç†ï¼
   â†“
çœŸå®å¯¹è±¡.updateInventory() â† ç›´æ¥è°ƒç”¨ï¼Œä¸èµ°ä»£ç†ï¼Œæ²¡æœ‰äº‹åŠ¡ï¼
```

**å…³é”®ç‚¹**ï¼š
- `this`å…³é”®å­—æ°¸è¿œæŒ‡å‘**å½“å‰çœŸå®å¯¹è±¡**
- çœŸå®å¯¹è±¡å†…éƒ¨çš„æ–¹æ³•è°ƒç”¨**ä¸ç»è¿‡ä»£ç†å±‚**
- ä»£ç†å±‚çš„å¢å¼ºé€»è¾‘ï¼ˆå¦‚äº‹åŠ¡ç®¡ç†ï¼‰è¢«**å®Œå…¨è·³è¿‡**

### 2.3 è‡ªè°ƒç”¨å¤±æ•ˆçš„å…¸å‹åœºæ™¯


**åœºæ™¯1ï¼šäº‹åŠ¡ä¼ æ’­å¤±æ•ˆ**

```java
@Service
public class AccountService {
    
    @Transactional
    public void transfer(String from, String to, int amount) {
        // æ‰£æ¬¾
        deduct(from, amount);
        
        // åŠ æ¬¾ - æœŸæœ›ç‹¬ç«‹äº‹åŠ¡ï¼Œä½†å®é™…å¤±æ•ˆï¼
        this.deposit(to, amount);  // âŒ REQUIRES_NEWä¸ä¼šç”Ÿæ•ˆ
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void deposit(String account, int amount) {
        accountRepository.updateBalance(account, amount);
    }
}
```

**é—®é¢˜åˆ†æ**ï¼š
- æœŸæœ›ï¼š`deposit`æ–¹æ³•ç”¨ç‹¬ç«‹äº‹åŠ¡ï¼Œå¤±è´¥ä¸å½±å“`deduct`
- å®é™…ï¼š`deposit`åŠ å…¥äº†`transfer`çš„äº‹åŠ¡ï¼Œä¸€èµ·å›æ»š
- åŸå› ï¼šå†…éƒ¨è°ƒç”¨ä¸èµ°ä»£ç†ï¼Œ`REQUIRES_NEW`å¤±æ•ˆ

**åœºæ™¯2ï¼šç¼“å­˜æ³¨è§£å¤±æ•ˆ**

```java
@Service
public class ProductService {
    
    public List<Product> getProducts(String category) {
        // ä¸šåŠ¡é€»è¾‘...
        
        // è°ƒç”¨ç¼“å­˜æ–¹æ³•
        return this.getCachedProducts(category);  // âŒ ç¼“å­˜ä¸ç”Ÿæ•ˆ
    }
    
    @Cacheable("products")
    public List<Product> getCachedProducts(String category) {
        return productRepository.findByCategory(category);
    }
}
```

**åœºæ™¯3ï¼šå¼‚æ­¥è°ƒç”¨å¤±æ•ˆ**

```java
@Service
public class NotificationService {
    
    public void sendNotifications(List<User> users) {
        for (User user : users) {
            // æœŸæœ›å¼‚æ­¥æ‰§è¡Œï¼Œå®é™…åŒæ­¥æ‰§è¡Œ
            this.sendEmail(user);  // âŒ @Asyncå¤±æ•ˆ
        }
    }
    
    @Async
    public void sendEmail(User user) {
        emailService.send(user.getEmail(), "é€šçŸ¥å†…å®¹");
    }
}
```

### 2.4 è§£å†³è‡ªè°ƒç”¨å¤±æ•ˆçš„æ–¹æ³•


**æ–¹æ¡ˆ1ï¼šæ³¨å…¥è‡ªå·±ï¼ˆæ¨èâœ…ï¼‰**

```java
@Service
public class OrderService {
    
    @Autowired
    private OrderService self;  // æ³¨å…¥çš„æ˜¯ä»£ç†å¯¹è±¡
    
    @Transactional
    public void createOrder(Order order) {
        orderRepository.save(order);
        
        // é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨
        self.updateInventory(order);  // âœ… äº‹åŠ¡ç”Ÿæ•ˆï¼
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void updateInventory(Order order) {
        inventoryRepository.update(order);
    }
}
```

**æ–¹æ¡ˆ2ï¼šé€šè¿‡ApplicationContextè·å–ä»£ç†**

```java
@Service
public class OrderService implements ApplicationContextAware {
    
    private ApplicationContext context;
    
    @Override
    public void setApplicationContext(ApplicationContext ctx) {
        this.context = ctx;
    }
    
    @Transactional
    public void createOrder(Order order) {
        orderRepository.save(order);
        
        // ä»å®¹å™¨è·å–ä»£ç†å¯¹è±¡
        OrderService proxy = context.getBean(OrderService.class);
        proxy.updateInventory(order);  // âœ… èµ°ä»£ç†
    }
}
```

**æ–¹æ¡ˆ3ï¼šä½¿ç”¨AopContextï¼ˆéœ€å¼€å¯expose-proxyï¼‰**

```java
// é…ç½®ç±»å¼€å¯
@EnableAspectJAutoProxy(exposeProxy = true)

@Service
public class OrderService {
    
    @Transactional
    public void createOrder(Order order) {
        orderRepository.save(order);
        
        // è·å–å½“å‰ä»£ç†å¯¹è±¡
        OrderService proxy = (OrderService) AopContext.currentProxy();
        proxy.updateInventory(order);  // âœ… èµ°ä»£ç†
    }
}
```

**æ–¹æ¡ˆ4ï¼šæ‹†åˆ†æˆä¸åŒçš„ç±»ï¼ˆæœ€ä½³å®è·µâœ…ï¼‰**

```java
@Service
public class OrderService {
    
    @Autowired
    private InventoryService inventoryService;  // ç‹¬ç«‹çš„Service
    
    @Transactional
    public void createOrder(Order order) {
        orderRepository.save(order);
        
        // è°ƒç”¨å…¶ä»–Serviceï¼Œè‡ªç„¶èµ°ä»£ç†
        inventoryService.updateInventory(order);  // âœ… æ¨èæ–¹å¼
    }
}

@Service
public class InventoryService {
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void updateInventory(Order order) {
        inventoryRepository.update(order);
    }
}
```

**æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **æ¨èåº¦** |
|------|---------|---------|-----------|
| æ³¨å…¥è‡ªå·± | `ç®€å•ç›´æ¥` | `å¾ªç¯ä¾èµ–é£é™©` | â­â­â­ |
| ApplicationContext | `çµæ´»` | `ä»£ç å†—ä½™` | â­â­ |
| AopContext | `æ ‡å‡†æ–¹å¼` | `éœ€è¦é…ç½®ï¼Œä¾µå…¥æ€§å¼º` | â­â­ |
| æ‹†åˆ†ç±» | `ç¬¦åˆå•ä¸€èŒè´£ï¼Œæ— è€¦åˆ` | `ç±»å˜å¤š` | â­â­â­â­â­ |

---

## 3. ğŸ”’ finalæ–¹æ³•çš„é™åˆ¶


### 3.1 ä¸ºä»€ä¹ˆfinalæ–¹æ³•æ— æ³•è¢«ä»£ç†


**ä»£ç†æœºåˆ¶å›é¡¾**ï¼š

Spring AOPä½¿ç”¨ä¸¤ç§ä»£ç†æ–¹å¼ï¼š
1. **JDKåŠ¨æ€ä»£ç†**ï¼šåŸºäºæ¥å£ï¼Œåˆ›å»ºæ¥å£å®ç°ç±»
2. **CGLIBä»£ç†**ï¼šåŸºäºç»§æ‰¿ï¼Œåˆ›å»ºç›®æ ‡ç±»çš„å­ç±»

```
JDKåŠ¨æ€ä»£ç†ï¼š
    æ¥å£
     â†‘
  å®ç°å…³ç³»
     â†‘
  ä»£ç†ç±»ï¼ˆå®ç°åŒä¸€æ¥å£ï¼‰

CGLIBä»£ç†ï¼š
   ç›®æ ‡ç±»
     â†‘
  ç»§æ‰¿å…³ç³»
     â†‘
  ä»£ç†ç±»ï¼ˆå­ç±»ï¼‰
```

**finalçš„é™åˆ¶åŸç†**ï¼š

```java
// åŸå§‹ç±»
public class UserService {
    
    // finalæ–¹æ³•æ— æ³•è¢«å­ç±»é‡å†™
    public final void deleteUser(Long id) {
        userRepository.delete(id);
    }
}

// CGLIBä»£ç†ç±»ï¼ˆä¼ªä»£ç ï¼‰
public class UserService$$EnhancerByCGLIB extends UserService {
    
    // âŒ ç¼–è¯‘é”™è¯¯ï¼šCannot override the final method from UserService
    @Override
    public final void deleteUser(Long id) {
        // å¢å¼ºé€»è¾‘...
        super.deleteUser(id);
    }
}
```

### 3.2 finalé™åˆ¶çš„å…·ä½“æƒ…å†µ


**æƒ…å†µ1ï¼šfinalç±»æ— æ³•è¢«ä»£ç†**

```java
// âŒ è¿™ä¸ªç±»æ— æ³•è¢«CGLIBä»£ç†
public final class PaymentService {
    
    @Transactional
    public void pay(Order order) {
        // äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆï¼ˆå¦‚æœç”¨CGLIBä»£ç†ï¼‰
    }
}
```

**æƒ…å†µ2ï¼šfinalæ–¹æ³•æ— æ³•è¢«å¢å¼º**

```java
@Service
public class OrderService {
    
    // âœ… æ™®é€šæ–¹æ³•å¯ä»¥è¢«å¢å¼º
    @Transactional
    public void createOrder(Order order) {
        // äº‹åŠ¡ç”Ÿæ•ˆ
    }
    
    // âŒ finalæ–¹æ³•æ— æ³•è¢«å¢å¼º
    @Transactional
    public final void updateOrder(Order order) {
        // äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆï¼
    }
}
```

**æƒ…å†µ3ï¼šprivateæ–¹æ³•å¤©ç„¶æ— æ³•ä»£ç†**

```java
@Service
public class UserService {
    
    // âŒ privateæ–¹æ³•å¤–éƒ¨æ— æ³•è°ƒç”¨ï¼Œä»£ç†æ— æ„ä¹‰
    @Transactional
    private void internalMethod() {
        // æ°¸è¿œä¸ä¼šæœ‰äº‹åŠ¡
    }
    
    public void publicMethod() {
        // å³ä½¿è¿™æ ·è°ƒç”¨ï¼ŒinternalMethodä¹Ÿæ²¡æœ‰äº‹åŠ¡
        this.internalMethod();
    }
}
```

### 3.3 è§£å†³finalé™åˆ¶çš„æ–¹æ³•


**æ–¹æ¡ˆ1ï¼šç§»é™¤finalå…³é”®å­—ï¼ˆæœ€ç®€å•âœ…ï¼‰**

```java
// ä¿®æ”¹å‰
public final class PaymentService {
    public final void pay(Order order) { }
}

// ä¿®æ”¹å
public class PaymentService {  // âœ… ç§»é™¤final
    public void pay(Order order) { }  // âœ… ç§»é™¤final
}
```

**æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ¥å£ï¼ˆæ¨èâœ…ï¼‰**

```java
// å®šä¹‰æ¥å£
public interface PaymentService {
    void pay(Order order);
}

// å®ç°ç±»å¯ä»¥æ˜¯final
@Service
public final class PaymentServiceImpl implements PaymentService {
    
    @Override
    @Transactional
    public void pay(Order order) {
        // ä½¿ç”¨JDKåŠ¨æ€ä»£ç†ï¼Œä¸å—finalå½±å“
    }
}
```

**åŸç†è¯´æ˜**ï¼š
- JDKåŠ¨æ€ä»£ç†åŸºäº**æ¥å£**ï¼Œä¸æ˜¯ç»§æ‰¿
- ä»£ç†ç±»å’Œç›®æ ‡ç±»éƒ½å®ç°**åŒä¸€æ¥å£**
- `final`åªé™åˆ¶ç»§æ‰¿ï¼Œä¸é™åˆ¶æ¥å£å®ç°

**æ–¹æ¡ˆ3ï¼šAspectJç¼–è¯‘æ—¶ç»‡å…¥ï¼ˆé«˜çº§ï¼‰**

```xml
<!-- ä½¿ç”¨AspectJï¼Œä¸ä¾èµ–ä»£ç† -->
<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-aspects</artifactId>
</dependency>
```

```java
// é…ç½®ä½¿ç”¨AspectJæ¨¡å¼
@EnableTransactionManagement(mode = AdviceMode.ASPECTJ)
```

**AspectJä¼˜åŠ¿**ï¼š
- âœ… ç›´æ¥ä¿®æ”¹å­—èŠ‚ç ï¼Œä¸ä¾èµ–ä»£ç†
- âœ… å¯ä»¥å¢å¼º`final`æ–¹æ³•ã€`private`æ–¹æ³•
- âœ… æ²¡æœ‰è‡ªè°ƒç”¨å¤±æ•ˆé—®é¢˜
- âŒ éœ€è¦ç‰¹æ®Šçš„ç¼–è¯‘å™¨é…ç½®ï¼Œå¤æ‚åº¦é«˜

---

## 4. ğŸ­ ä»£ç†æœºåˆ¶çš„è¾¹ç•Œ


### 4.1 JDKåŠ¨æ€ä»£ç†çš„é™åˆ¶


**å¿…é¡»åŸºäºæ¥å£**ï¼š

```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰æ¥å£
@Service
public class UserService {
    
    @Transactional
    public void saveUser(User user) {
        // å¦‚æœå¼ºåˆ¶ä½¿ç”¨JDKä»£ç†ï¼Œä¼šæŠ¥é”™
    }
}

// âœ… æ­£ç¡®ç¤ºä¾‹ï¼šæœ‰æ¥å£
public interface UserService {
    void saveUser(User user);
}

@Service
public class UserServiceImpl implements UserService {
    
    @Override
    @Transactional
    public void saveUser(User user) {
        // JDKä»£ç†æ­£å¸¸å·¥ä½œ
    }
}
```

**åªèƒ½ä»£ç†æ¥å£æ–¹æ³•**ï¼š

```java
public interface UserService {
    void saveUser(User user);
}

@Service
public class UserServiceImpl implements UserService {
    
    @Override
    @Transactional
    public void saveUser(User user) {
        // âœ… å¯ä»¥è¢«ä»£ç†
    }
    
    @Transactional
    public void deleteUser(Long id) {
        // âŒ ä¸åœ¨æ¥å£ä¸­ï¼ŒJDKä»£ç†æ— æ³•å¢å¼º
    }
}
```

### 4.2 CGLIBä»£ç†çš„é™åˆ¶


**ç»§æ‰¿é™åˆ¶æ±‡æ€»**ï¼š

| é™åˆ¶ç±»å‹ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|---------|---------|------------|
| `finalç±»` | `æ— æ³•ç»§æ‰¿` | `ç§»é™¤finalæˆ–ç”¨æ¥å£` |
| `finalæ–¹æ³•` | `æ— æ³•é‡å†™` | `ç§»é™¤final` |
| `privateæ–¹æ³•` | `ä¸å¯è§` | `æ”¹ä¸ºprotectedæˆ–public` |
| `staticæ–¹æ³•` | `å±äºç±»ä¸å±äºå¯¹è±¡` | `æ— æ³•ä»£ç†ï¼Œé‡æ–°è®¾è®¡` |

**æ„é€ å‡½æ•°è°ƒç”¨ä¸¤æ¬¡**ï¼š

```java
@Service
public class UserService {
    
    public UserService() {
        System.out.println("æ„é€ å‡½æ•°æ‰§è¡Œ");
    }
    
    @Transactional
    public void saveUser(User user) {
        userRepository.save(user);
    }
}

// å®é™…è¿è¡Œè¾“å‡ºï¼š
// æ„é€ å‡½æ•°æ‰§è¡Œ  â† åˆ›å»ºç›®æ ‡å¯¹è±¡
// æ„é€ å‡½æ•°æ‰§è¡Œ  â† åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆCGLIBé€šè¿‡ç»§æ‰¿ï¼‰
```

### 4.3 ä»£ç†å¯¹è±¡çš„ç±»å‹é—®é¢˜


**ç±»å‹è½¬æ¢é™·é˜±**ï¼š

```java
// æ¥å£å’Œå®ç°
public interface UserService {
    void saveUser(User user);
}

@Service
public class UserServiceImpl implements UserService {
    
    @Override
    public void saveUser(User user) { }
    
    public void deleteUser(Long id) { }
}

// ä½¿ç”¨ä»£ç 
@Autowired
private UserService userService;  // âœ… æ¥å£ç±»å‹

public void test() {
    // âŒ å¦‚æœæ˜¯JDKä»£ç†ï¼Œè¿™ä¸ªè½¬æ¢ä¼šå¤±è´¥
    UserServiceImpl impl = (UserServiceImpl) userService;
    impl.deleteUser(1L);  // ClassCastException!
}
```

**å®‰å…¨çš„åšæ³•**ï¼š

```java
// å§‹ç»ˆç”¨æ¥å£ç±»å‹
@Autowired
private UserService userService;  // âœ…

// æˆ–æ˜ç¡®ä½¿ç”¨å®ç°ç±»ï¼ˆå¼ºåˆ¶CGLIBä»£ç†ï¼‰
@Autowired
private UserServiceImpl userService;  // âœ… ä½†ä¸æ¨è
```

---

## 5. ğŸ’³ äº‹åŠ¡å¤±æ•ˆçš„å¸¸è§åœºæ™¯


### 5.1 åœºæ™¯1ï¼šépublicæ–¹æ³•


```java
@Service
public class OrderService {
    
    // âŒ protected/private/defaultæ–¹æ³•ï¼Œäº‹åŠ¡ä¸ç”Ÿæ•ˆ
    @Transactional
    protected void createOrder(Order order) {
        orderRepository.save(order);
    }
}
```

**åŸå› **ï¼š
- Springäº‹åŠ¡é»˜è®¤åªå¢å¼º`public`æ–¹æ³•
- ä»£ç†åªèƒ½è°ƒç”¨`public`æ–¹æ³•çš„å¢å¼ºé€»è¾‘

### 5.2 åœºæ™¯2ï¼šå¼‚å¸¸è¢«æ•è·


```java
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(Order order) {
        try {
            orderRepository.save(order);
            // å¯èƒ½æŠ›å‡ºå¼‚å¸¸
            inventoryService.deduct(order);
        } catch (Exception e) {
            // âŒ å¼‚å¸¸è¢«åæ‰ï¼Œäº‹åŠ¡ä¸ä¼šå›æ»š
            log.error("åˆ›å»ºè®¢å•å¤±è´¥", e);
        }
    }
}
```

**æ­£ç¡®åšæ³•**ï¼š

```java
@Transactional
public void createOrder(Order order) {
    try {
        orderRepository.save(order);
        inventoryService.deduct(order);
    } catch (Exception e) {
        log.error("åˆ›å»ºè®¢å•å¤±è´¥", e);
        throw e;  // âœ… é‡æ–°æŠ›å‡ºï¼Œè®©äº‹åŠ¡å›æ»š
    }
}
```

### 5.3 åœºæ™¯3ï¼šé”™è¯¯çš„å¼‚å¸¸ç±»å‹


```java
@Service
public class OrderService {
    
    // âŒ é»˜è®¤åªå›æ»šRuntimeExceptionå’ŒError
    @Transactional
    public void createOrder(Order order) throws Exception {
        orderRepository.save(order);
        
        if (order.getAmount() > 10000) {
            // æ£€æŸ¥å‹å¼‚å¸¸ï¼Œä¸ä¼šå›æ»š
            throw new Exception("é‡‘é¢è¿‡å¤§");
        }
    }
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// æ–¹æ¡ˆ1ï¼šæŒ‡å®šå›æ»šçš„å¼‚å¸¸ç±»å‹
@Transactional(rollbackFor = Exception.class)
public void createOrder(Order order) throws Exception {
    // âœ… æ‰€æœ‰Exceptionéƒ½ä¼šå›æ»š
}

// æ–¹æ¡ˆ2ï¼šæ”¹ç”¨è¿è¡Œæ—¶å¼‚å¸¸
@Transactional
public void createOrder(Order order) {
    if (order.getAmount() > 10000) {
        throw new BusinessException("é‡‘é¢è¿‡å¤§");  // âœ… è¿è¡Œæ—¶å¼‚å¸¸
    }
}
```

### 5.4 åœºæ™¯4ï¼šå¤šçº¿ç¨‹è°ƒç”¨


```java
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(Order order) {
        orderRepository.save(order);
        
        // âŒ æ–°çº¿ç¨‹æ²¡æœ‰äº‹åŠ¡ä¸Šä¸‹æ–‡
        new Thread(() -> {
            // è¿™é‡Œçš„æ•°æ®åº“æ“ä½œæ²¡æœ‰äº‹åŠ¡
            logService.saveLog(order);
        }).start();
    }
}
```

**åŸç†**ï¼š
- Springäº‹åŠ¡åŸºäº`ThreadLocal`
- äº‹åŠ¡ä¿¡æ¯ç»‘å®šåœ¨**å½“å‰çº¿ç¨‹**
- æ–°çº¿ç¨‹æ— æ³•è·å–çˆ¶çº¿ç¨‹çš„äº‹åŠ¡

### 5.5 äº‹åŠ¡å¤±æ•ˆæ£€æŸ¥æ¸…å•


**å¿«é€Ÿæ£€æŸ¥è¡¨**ï¼š

- [ ] æ˜¯å¦æ˜¯`public`æ–¹æ³•ï¼Ÿ
- [ ] æ˜¯å¦é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ï¼Ÿï¼ˆä¸æ˜¯è‡ªè°ƒç”¨ï¼‰
- [ ] å¼‚å¸¸æ˜¯å¦è¢«æ­£ç¡®æŠ›å‡ºï¼Ÿ
- [ ] å¼‚å¸¸ç±»å‹æ˜¯å¦åœ¨å›æ»šèŒƒå›´å†…ï¼Ÿ
- [ ] æ˜¯å¦åœ¨åŒä¸€çº¿ç¨‹ä¸­ï¼Ÿ
- [ ] æ•°æ®åº“å¼•æ“æ˜¯å¦æ”¯æŒäº‹åŠ¡ï¼Ÿï¼ˆå¦‚MyISAMä¸æ”¯æŒï¼‰
- [ ] æ˜¯å¦æ­£ç¡®é…ç½®äº†äº‹åŠ¡ç®¡ç†å™¨ï¼Ÿ

---

## 6. âš¡ æ€§èƒ½å½±å“åˆ†æ


### 6.1 ä»£ç†å¸¦æ¥çš„æ€§èƒ½å¼€é”€


**è°ƒç”¨é“¾è·¯å¯¹æ¯”**ï¼š

```
æ™®é€šè°ƒç”¨ï¼š
å®¢æˆ·ç«¯ â†’ ç›®æ ‡å¯¹è±¡.æ–¹æ³•() â†’ è¿”å›ç»“æœ
[1æ¬¡æ–¹æ³•è°ƒç”¨]

ä»£ç†è°ƒç”¨ï¼š
å®¢æˆ·ç«¯ â†’ ä»£ç†å¯¹è±¡.æ–¹æ³•() â†’ å‰ç½®å¢å¼º â†’ ç›®æ ‡å¯¹è±¡.æ–¹æ³•() â†’ åç½®å¢å¼º â†’ è¿”å›ç»“æœ
[3-5æ¬¡æ–¹æ³•è°ƒç”¨ + åå°„ + åŠ¨æ€åˆ¤æ–­]
```

**æ€§èƒ½æŸè€—æ¥æº**ï¼š

| å¼€é”€æ¥æº | **å½±å“ç¨‹åº¦** | **è¯´æ˜** |
|---------|------------|---------|
| **æ–¹æ³•è°ƒç”¨** | `ä½` | `å¢åŠ 1-2å±‚æ–¹æ³•è°ƒç”¨` |
| **åå°„æ“ä½œ** | `ä¸­` | `JDKä»£ç†ç”¨åå°„è°ƒç”¨` |
| **å¯¹è±¡åˆ›å»º** | `ä½` | `ä»£ç†å¯¹è±¡åˆ›å»ºå¼€é”€` |
| **æ¡ä»¶åˆ¤æ–­** | `ä½` | `åˆ‡ç‚¹åŒ¹é…ã€å¢å¼ºåˆ¤æ–­` |
| **çº¿ç¨‹ä¸Šä¸‹æ–‡** | `ä¸­` | `äº‹åŠ¡ã€å®‰å…¨ä¸Šä¸‹æ–‡ç®¡ç†` |

### 6.2 æ€§èƒ½æµ‹è¯•æ•°æ®


**ç®€å•æ–¹æ³•è°ƒç”¨æ€§èƒ½å¯¹æ¯”**ï¼š

```java
// æµ‹è¯•ä»£ç 
public interface Calculator {
    int add(int a, int b);
}

// æ— ä»£ç†
public class SimpleCalculator implements Calculator {
    public int add(int a, int b) {
        return a + b;
    }
}

// æœ‰ä»£ç†ï¼ˆå¸¦æ—¥å¿—åˆ‡é¢ï¼‰
@Service
public class ProxyCalculator implements Calculator {
    
    @LogExecutionTime
    public int add(int a, int b) {
        return a + b;
    }
}
```

**æ€§èƒ½æ•°æ®**ï¼ˆ100ä¸‡æ¬¡è°ƒç”¨ï¼‰ï¼š

- æ— ä»£ç†ï¼š~10ms
- JDKä»£ç†ï¼š~180msï¼ˆ**18å€å¼€é”€**ï¼‰
- CGLIBä»£ç†ï¼š~150msï¼ˆ**15å€å¼€é”€**ï¼‰

**ç»“è®º**ï¼š
- ç®€å•æ–¹æ³•ä»£ç†å¼€é”€**æ˜¾è‘—**
- ä½†å¦‚æœæ–¹æ³•æœ¬èº«å¤æ‚ï¼ˆæ•°æ®åº“æ“ä½œç­‰ï¼‰ï¼Œä»£ç†å¼€é”€**å¯å¿½ç•¥**

### 6.3 ä½•æ—¶éœ€è¦å…³æ³¨æ€§èƒ½


**é«˜é¢‘è°ƒç”¨åœºæ™¯**ï¼š

```java
@Service
public class DataProcessor {
    
    // âŒ ä¸å»ºè®®ï¼šç®€å•è®¡ç®—æ–¹æ³•åŠ ä»£ç†
    @LogExecutionTime
    public int calculate(int x) {
        return x * 2;  // å¤ªç®€å•ï¼Œä»£ç†å¼€é”€æ¯”ä¾‹å¤§
    }
    
    // âœ… åˆç†ï¼šå¤æ‚ä¸šåŠ¡é€»è¾‘åŠ ä»£ç†
    @Transactional
    public void processBatch(List<Data> dataList) {
        // æ•°æ®åº“æ“ä½œã€ä¸šåŠ¡é€»è¾‘...
        // æ–¹æ³•æœ¬èº«è€—æ—¶ï¼Œä»£ç†å¼€é”€å¯å¿½ç•¥
    }
}
```

**ä¼˜åŒ–å»ºè®®**ï¼š

ğŸ”¸ **é¿å…è¿‡åº¦ä½¿ç”¨AOP**
```java
// âŒ ä¸å¥½çš„åšæ³•
@LogExecutionTime  // æ‰€æœ‰æ–¹æ³•éƒ½åŠ æ—¥å¿—
@Transactional     // æ‰€æœ‰æ–¹æ³•éƒ½åŠ äº‹åŠ¡
@Cacheable         // æ‰€æœ‰æ–¹æ³•éƒ½åŠ ç¼“å­˜
public class UserService {
    // æ¯ä¸ªæ–¹æ³•éƒ½æœ‰å¤šå±‚ä»£ç†
}

// âœ… å¥½çš„åšæ³•
public class UserService {
    
    @Transactional  // åªåœ¨éœ€è¦äº‹åŠ¡çš„æ–¹æ³•ä¸Š
    public void updateUser(User user) { }
    
    public User getUser(Long id) {  // ç®€å•æŸ¥è¯¢ä¸åŠ ä»£ç†
        return userRepository.findById(id);
    }
}
```

ğŸ”¸ **é€‰æ‹©åˆé€‚çš„ä»£ç†æ–¹å¼**
- ç®€å•åœºæ™¯ï¼šä¼˜å…ˆJDKä»£ç†ï¼ˆåŸºäºæ¥å£ï¼‰
- å¤æ‚åœºæ™¯ï¼šCGLIBä»£ç†ä¹Ÿå¯æ¥å—
- æè‡´æ€§èƒ½ï¼šè€ƒè™‘AspectJç¼–è¯‘æ—¶ç»‡å…¥

ğŸ”¸ **åˆç†é…ç½®åˆ‡ç‚¹**
```java
// âŒ è¿‡äºå®½æ³›çš„åˆ‡ç‚¹
@Around("execution(* com.example..*.*(..))")  // æ‰€æœ‰åŒ…æ‰€æœ‰æ–¹æ³•
public Object logAround(ProceedingJoinPoint pjp) { }

// âœ… ç²¾ç¡®çš„åˆ‡ç‚¹
@Around("@annotation(LogExecutionTime)")  // åªå¢å¼ºå¸¦æ³¨è§£çš„æ–¹æ³•
public Object logAround(ProceedingJoinPoint pjp) { }
```

---

## 7. ğŸ› è°ƒè¯•å›°éš¾ä¸è§£å†³æ–¹æ¡ˆ


### 7.1 è°ƒè¯•éš¾ç‚¹åˆ†æ


**é—®é¢˜1ï¼šæ–­ç‚¹è¿›å…¥ä»£ç†ç±»**

```
è°ƒè¯•æ—¶çš„è°ƒç”¨æ ˆï¼š
UserService$$EnhancerByCGLIB$$abc123.saveUser()  â† ä»£ç†ç±»
  â†’ TransactionInterceptor.invoke()
    â†’ UserServiceImpl.saveUser()  â† çœŸå®ç±»

é—®é¢˜ï¼š
- çœ‹ä¸åˆ°çœŸå®çš„ä¸šåŠ¡ä»£ç 
- è°ƒç”¨æ ˆå¤æ‚ï¼Œéš¾ä»¥ç†è§£
- å˜é‡å€¼å¯èƒ½è¢«ä»£ç†åŒ…è£…
```

**é—®é¢˜2ï¼šthisæŒ‡å‘æ··ä¹±**

```java
@Service
public class UserService {
    
    public void method1() {
        System.out.println(this.getClass());
        // è¾“å‡ºï¼šclass UserService$$EnhancerByCGLIB$$abc123
        
        method2();  // thisè°ƒç”¨
    }
    
    @Transactional
    public void method2() {
        // æ–­ç‚¹åˆ°è¿™é‡Œï¼Œthisæ˜¯ä»£ç†è¿˜æ˜¯çœŸå®å¯¹è±¡ï¼Ÿ
    }
}
```

**é—®é¢˜3ï¼šå¼‚å¸¸å †æ ˆå†—é•¿**

```
java.lang.RuntimeException: ä¸šåŠ¡å¼‚å¸¸
    at UserServiceImpl.saveUser(UserServiceImpl.java:25)
    at UserServiceImpl$$FastClassByCGLIB$$abc.invoke(<generated>)
    at net.sf.cglib.proxy.MethodProxy.invoke(MethodProxy.java:204)
    at o.s.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(...)
    at o.s.aop.framework.ReflectiveMethodInvocation.proceed(...)
    at o.s.transaction.interceptor.TransactionInterceptor.invoke(...)
    ... 30 more

çœŸæ­£çš„é”™è¯¯åœ¨ç¬¬1è¡Œï¼Œä½†è¢«å¤§é‡ä»£ç†ç›¸å…³å †æ ˆæ·¹æ²¡
```

### 7.2 è°ƒè¯•æŠ€å·§ä¸å·¥å…·


**æŠ€å·§1ï¼šä½¿ç”¨æ¡ä»¶æ–­ç‚¹**

```java
// åœ¨IDEä¸­è®¾ç½®æ¡ä»¶æ–­ç‚¹
@Transactional
public void saveUser(User user) {
    // æ–­ç‚¹æ¡ä»¶ï¼šuser.getId() == 123
    // åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹æš‚åœ
    userRepository.save(user);
}
```

**æŠ€å·§2ï¼šæ—¥å¿—å®šä½**

```java
@Service
@Slf4j
public class UserService {
    
    @Transactional
    public void saveUser(User user) {
        log.debug("è¿›å…¥saveUserï¼Œå½“å‰å¯¹è±¡ï¼š{}", this.getClass().getSimpleName());
        log.debug("æ˜¯å¦ä»£ç†å¯¹è±¡ï¼š{}", AopUtils.isAopProxy(this));
        
        userRepository.save(user);
    }
}
```

**æŠ€å·§3ï¼šä½¿ç”¨Spring AOPå·¥å…·ç±»**

```java
import org.springframework.aop.framework.AopContext;
import org.springframework.aop.support.AopUtils;

public void debugMethod() {
    // æ£€æŸ¥æ˜¯å¦æ˜¯ä»£ç†å¯¹è±¡
    boolean isProxy = AopUtils.isAopProxy(this);
    
    // æ£€æŸ¥ä»£ç†ç±»å‹
    boolean isJdkProxy = AopUtils.isJdkDynamicProxy(this);
    boolean isCglibProxy = AopUtils.isCglibProxy(this);
    
    // è·å–ç›®æ ‡å¯¹è±¡
    Object target = AopUtils.getTargetClass(this);
    
    log.info("ä»£ç†ä¿¡æ¯ - isProxy:{}, JDK:{}, CGLIB:{}, target:{}", 
             isProxy, isJdkProxy, isCglibProxy, target);
}
```

**æŠ€å·§4ï¼šIDEæ’ä»¶è¾…åŠ©**

å¸¸ç”¨æ’ä»¶ï¼š
- **Spring Tools** (Eclipse/STS)
- **Spring Boot Helper** (IntelliJ IDEA)
- **JRebel** (çƒ­éƒ¨ç½²ï¼Œé¿å…é‡å¯)

**æŠ€å·§5ï¼šç¦ç”¨ä»£ç†è°ƒè¯•**

```java
// å¼€å‘ç¯å¢ƒä¸´æ—¶ç¦ç”¨AOP
@Profile("dev")
@Configuration
public class DebugConfig {
    
    @Bean
    public static BeanFactoryPostProcessor disableAop() {
        return beanFactory -> {
            // è·å–æ‰€æœ‰åˆ‡é¢
            String[] aspects = beanFactory.getBeanNamesForType(Aspect.class);
            // ä¸´æ—¶ç¦ç”¨
            for (String aspect : aspects) {
                ((DefaultListableBeanFactory) beanFactory).removeBeanDefinition(aspect);
            }
        };
    }
}
```

### 7.3 å¸¸è§è°ƒè¯•åœºæ™¯è§£å†³æ–¹æ¡ˆ


**åœºæ™¯1ï¼šäº‹åŠ¡æœªç”Ÿæ•ˆæ’æŸ¥**

```java
@Service
@Slf4j
public class OrderService {
    
    @Transactional
    public void createOrder(Order order) {
        // 1. æ£€æŸ¥æ˜¯å¦èµ°äº†ä»£ç†
        log.info("å½“å‰ç±»ï¼š{}", this.getClass().getName());
        // è¾“å‡ºåŒ…å«$$EnhancerByCGLIBåˆ™è¯´æ˜æ˜¯ä»£ç†
        
        // 2. æ£€æŸ¥äº‹åŠ¡æ˜¯å¦å¼€å¯
        boolean isActive = TransactionSynchronizationManager.isActualTransactionActive();
        log.info("äº‹åŠ¡æ˜¯å¦æ¿€æ´»ï¼š{}", isActive);
        
        // 3. ä¸šåŠ¡é€»è¾‘
        orderRepository.save(order);
    }
}
```

**åœºæ™¯2ï¼šåˆ‡é¢æœªæ‰§è¡Œæ’æŸ¥**

```java
@Aspect
@Component
@Slf4j
public class LogAspect {
    
    @Before("@annotation(logExecutionTime)")
    public void logBefore(JoinPoint joinPoint, LogExecutionTime logExecutionTime) {
        // 1. ç¡®è®¤åˆ‡é¢è¢«åŠ è½½
        log.info("åˆ‡é¢æ‰§è¡Œ - æ–¹æ³•ï¼š{}", joinPoint.getSignature());
        
        // 2. æ‰“å°ç›®æ ‡å¯¹è±¡ä¿¡æ¯
        Object target = joinPoint.getTarget();
        log.info("ç›®æ ‡å¯¹è±¡ï¼š{}", target.getClass().getName());
    }
}
```

**åœºæ™¯3ï¼šæ€§èƒ½é—®é¢˜å®šä½**

```java
@Aspect
@Component
public class PerformanceAspect {
    
    @Around("execution(* com.example.service.*.*(..))")
    public Object measureTime(ProceedingJoinPoint pjp) throws Throwable {
        long start = System.currentTimeMillis();
        
        try {
            return pjp.proceed();
        } finally {
            long cost = System.currentTimeMillis() - start;
            // å®šä½æ…¢æ–¹æ³•
            if (cost > 1000) {
                log.warn("æ…¢æ–¹æ³•è­¦å‘Š - {}è€—æ—¶{}ms", 
                        pjp.getSignature(), cost);
            }
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒçŸ¥è¯†


```
ğŸ”¸ è‡ªè°ƒç”¨å¤±æ•ˆï¼šå†…éƒ¨è°ƒç”¨ä¸èµ°ä»£ç†ï¼Œå¢å¼ºå¤±æ•ˆ
ğŸ”¸ finalé™åˆ¶ï¼šfinalç±»/æ–¹æ³•æ— æ³•è¢«CGLIBä»£ç†
ğŸ”¸ ä»£ç†è¾¹ç•Œï¼šJDKåŸºäºæ¥å£ï¼ŒCGLIBåŸºäºç»§æ‰¿
ğŸ”¸ äº‹åŠ¡å¤±æ•ˆï¼šépublicã€å¼‚å¸¸è¢«æ•è·ã€é”™è¯¯å¼‚å¸¸ç±»å‹ã€å¤šçº¿ç¨‹
ğŸ”¸ æ€§èƒ½å¼€é”€ï¼šç®€å•æ–¹æ³•ä»£ç†å¼€é”€å¤§ï¼Œå¤æ‚æ–¹æ³•å¯å¿½ç•¥
ğŸ”¸ è°ƒè¯•æŠ€å·§ï¼šä½¿ç”¨æ—¥å¿—ã€å·¥å…·ç±»ã€IDEæ’ä»¶è¾…åŠ©
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä»£ç†çš„æœ¬è´¨**
- ä»£ç†å¯¹è±¡ â‰  ç›®æ ‡å¯¹è±¡
- `this`æ°¸è¿œæŒ‡å‘çœŸå®å¯¹è±¡
- å¢å¼ºé€»è¾‘åœ¨ä»£ç†å¯¹è±¡ä¸Šï¼Œä¸åœ¨çœŸå®å¯¹è±¡ä¸Š

**ğŸ”¹ é™åˆ¶äº§ç”Ÿçš„åŸå› **
```
ä»£ç†æœºåˆ¶é™åˆ¶ï¼š
- JDKä»£ç† â†’ å¿…é¡»æœ‰æ¥å£
- CGLIBä»£ç† â†’ ä¸èƒ½æ˜¯final

è°ƒç”¨æ–¹å¼é™åˆ¶ï¼š
- å¤–éƒ¨è°ƒç”¨ â†’ èµ°ä»£ç† âœ…
- å†…éƒ¨è°ƒç”¨ â†’ ä¸èµ°ä»£ç† âŒ
```

**ğŸ”¹ è§£å†³é—®é¢˜çš„æ€è·¯**
1. **è‡ªè°ƒç”¨**ï¼šæ³¨å…¥è‡ªå·± æˆ– æ‹†åˆ†æˆä¸åŒç±»
2. **final**ï¼šç§»é™¤final æˆ– ä½¿ç”¨æ¥å£
3. **äº‹åŠ¡**ï¼šæ£€æŸ¥æ–¹æ³•å¯è§æ€§ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹ä¸Šä¸‹æ–‡
4. **æ€§èƒ½**ï¼šé¿å…è¿‡åº¦ä½¿ç”¨ï¼Œç²¾ç¡®åˆ‡ç‚¹
5. **è°ƒè¯•**ï¼šä½¿ç”¨å·¥å…·ç±»ã€æ—¥å¿—ã€æ¡ä»¶æ–­ç‚¹

### 8.3 æœ€ä½³å®è·µå»ºè®®


**âœ… è®¾è®¡å»ºè®®**
```java
// 1. ä½¿ç”¨æ¥å£ç¼–ç¨‹
public interface UserService { }  // âœ… å®šä¹‰æ¥å£
public class UserServiceImpl implements UserService { }  // âœ… å®ç°ç±»

// 2. é¿å…final
public class OrderService { }  // âœ… ä¸ç”¨final
public void createOrder() { }  // âœ… ä¸ç”¨final

// 3. æ–¹æ³•public
@Transactional
public void businessMethod() { }  // âœ… publicæ–¹æ³•

// 4. æ‹†åˆ†èŒè´£
@Service
public class OrderService {
    @Autowired
    private InventoryService inventoryService;  // âœ… ä¾èµ–å…¶ä»–Service
}
```

**âœ… ç¼–ç å»ºè®®**
```java
// 1. æ­£ç¡®å¤„ç†å¼‚å¸¸
@Transactional(rollbackFor = Exception.class)  // âœ… æŒ‡å®šå›æ»šå¼‚å¸¸
public void businessMethod() throws Exception {
    try {
        // ä¸šåŠ¡é€»è¾‘
    } catch (Exception e) {
        log.error("é”™è¯¯", e);
        throw e;  // âœ… é‡æ–°æŠ›å‡º
    }
}

// 2. åˆç†ä½¿ç”¨ä»£ç†
@Transactional  // âœ… åªåœ¨éœ€è¦çš„æ–¹æ³•ä¸Š
public void saveUser(User user) { }

public User getUser(Long id) {  // âœ… ç®€å•æŸ¥è¯¢ä¸åŠ ä»£ç†
    return userRepository.findById(id);
}

// 3. é¿å…å¾ªç¯ä¾èµ–
@Service
public class ServiceA {
    @Lazy  // âœ… å»¶è¿Ÿæ³¨å…¥é¿å…å¾ªç¯ä¾èµ–
    @Autowired
    private ServiceA self;
}
```

**âœ… è°ƒè¯•å»ºè®®**
```java
// 1. æ·»åŠ è°ƒè¯•æ—¥å¿—
@Slf4j
@Service
public class UserService {
    
    @Transactional
    public void saveUser(User user) {
        log.debug("ä»£ç†ä¿¡æ¯ï¼š{}", this.getClass().getName());
        log.debug("äº‹åŠ¡çŠ¶æ€ï¼š{}", 
            TransactionSynchronizationManager.isActualTransactionActive());
    }
}

// 2. ä½¿ç”¨å·¥å…·ç±»
boolean isProxy = AopUtils.isAopProxy(this);
Object proxy = AopContext.currentProxy();
```

### 8.4 å¿«é€Ÿæ£€æŸ¥æ¸…å•


**è‡ªè°ƒç”¨é—®é¢˜æ£€æŸ¥**ï¼š
- [ ] æ˜¯å¦é€šè¿‡`this`è°ƒç”¨å…¶ä»–æ–¹æ³•ï¼Ÿ
- [ ] è¢«è°ƒç”¨çš„æ–¹æ³•æ˜¯å¦æœ‰AOPå¢å¼ºï¼Ÿ
- [ ] æ˜¯å¦å¯ä»¥æ‹†åˆ†æˆç‹¬ç«‹çš„Serviceï¼Ÿ

**äº‹åŠ¡å¤±æ•ˆæ£€æŸ¥**ï¼š
- [ ] æ–¹æ³•æ˜¯å¦æ˜¯`public`ï¼Ÿ
- [ ] å¼‚å¸¸æ˜¯å¦è¢«æ­£ç¡®æŠ›å‡ºï¼Ÿ
- [ ] æ˜¯å¦æ˜¯`RuntimeException`æˆ–å·²é…ç½®`rollbackFor`ï¼Ÿ
- [ ] æ˜¯å¦åœ¨åŒä¸€çº¿ç¨‹ä¸­æ‰§è¡Œï¼Ÿ

**æ€§èƒ½é—®é¢˜æ£€æŸ¥**ï¼š
- [ ] æ˜¯å¦å¯¹ç®€å•æ–¹æ³•è¿‡åº¦ä½¿ç”¨AOPï¼Ÿ
- [ ] åˆ‡ç‚¹æ˜¯å¦è¿‡äºå®½æ³›ï¼Ÿ
- [ ] æ˜¯å¦å¯ä»¥ç”¨æ›´é«˜æ•ˆçš„å®ç°æ–¹å¼ï¼Ÿ

**æ ¸å¿ƒè®°å¿†**ï¼š
```
ä»£ç†å¯¹è±¡éæœ¬ä½“ï¼Œå†…éƒ¨è°ƒç”¨éœ€æ³¨æ„
finalç»§æ‰¿å—é™åˆ¶ï¼Œæ¥å£è®¾è®¡æ›´çµæ´»
äº‹åŠ¡publicæ‰ç”Ÿæ•ˆï¼Œå¼‚å¸¸æŠ›å‡ºè¦æ­£ç¡®
æ€§èƒ½å¼€é”€éœ€æƒè¡¡ï¼Œç®€å•æ–¹æ³•å°‘ç”¨AOP
è°ƒè¯•å·¥å…·æ¥å¸®å¿™ï¼Œæ—¥å¿—æ£€æŸ¥æœ€ç›´è§‚
```