---
title: 6ã€äº‹ä»¶å‘å¸ƒæœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [äº‹ä»¶å‘å¸ƒçš„æ ¸å¿ƒæ¦‚å¿µ](#1-äº‹ä»¶å‘å¸ƒçš„æ ¸å¿ƒæ¦‚å¿µ)
2. [ApplicationEventPublisherè¯¦è§£](#2-ApplicationEventPublisherè¯¦è§£)
3. [publishEventæ–¹æ³•æ·±åº¦è§£æ](#3-publishEventæ–¹æ³•æ·±åº¦è§£æ)
4. [äº‹ä»¶ä¼ æ’­æœºåˆ¶](#4-äº‹ä»¶ä¼ æ’­æœºåˆ¶)
5. [å‘å¸ƒæ—¶æœºä¸æœ€ä½³å®è·µ](#5-å‘å¸ƒæ—¶æœºä¸æœ€ä½³å®è·µ)
6. [å¼‚å¸¸å¤„ç†ç­–ç•¥](#6-å¼‚å¸¸å¤„ç†ç­–ç•¥)
7. [äº‹åŠ¡è¾¹ç•Œä¸äº‹ä»¶å‘å¸ƒ](#7-äº‹åŠ¡è¾¹ç•Œä¸äº‹ä»¶å‘å¸ƒ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ äº‹ä»¶å‘å¸ƒçš„æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯äº‹ä»¶å‘å¸ƒ


**é€šä¿—ç†è§£**ï¼š
> æƒ³è±¡ä½ åœ¨å…¬å¸é‡Œå‘é€šçŸ¥ï¼šä½ ï¼ˆå‘å¸ƒè€…ï¼‰åœ¨ç¾¤é‡Œå‘æ¶ˆæ¯"ä»Šå¤©ä¸‹åˆå¼€ä¼š"ï¼Œæ‰€æœ‰è®¢é˜…äº†è¿™ä¸ªç¾¤çš„åŒäº‹ï¼ˆç›‘å¬è€…ï¼‰éƒ½èƒ½æ”¶åˆ°é€šçŸ¥å¹¶åšå‡ºå“åº”ã€‚Springçš„äº‹ä»¶å‘å¸ƒå°±æ˜¯è¿™ä¸ªé“ç†ã€‚

**ä¸“ä¸šå®šä¹‰**ï¼š
```
äº‹ä»¶å‘å¸ƒ(Event Publishing)ï¼š
Springä¸­çš„å‘å¸ƒ-è®¢é˜…æ¨¡å¼å®ç°ï¼Œå…è®¸Beanä¹‹é—´é€šè¿‡äº‹ä»¶è¿›è¡Œæ¾è€¦åˆé€šä¿¡
å‘å¸ƒè€…æ— éœ€çŸ¥é“è°åœ¨ç›‘å¬ï¼Œç›‘å¬è€…æ— éœ€çŸ¥é“è°åœ¨å‘å¸ƒ
```

### 1.2 äº‹ä»¶å‘å¸ƒçš„ä¸‰è¦ç´ 


```
å‘å¸ƒè€…(Publisher)          äº‹ä»¶(Event)          ç›‘å¬è€…(Listener)
       |                      |                      |
   å‘é€æ¶ˆæ¯  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  äº‹ä»¶å¯¹è±¡  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  å¤„ç†æ¶ˆæ¯
       |                      |                      |
   ä¸šåŠ¡Bean              æºå¸¦æ•°æ®ä¿¡æ¯            å“åº”Bean
```

**ğŸ”¸ æ ¸å¿ƒè¦ç´ è¯´æ˜**ï¼š

| è¦ç´  | ä½œç”¨ | ä¸¾ä¾‹ |
|------|------|------|
| **å‘å¸ƒè€…** | è§¦å‘äº‹ä»¶ï¼Œå‘é€é€šçŸ¥ | è®¢å•æœåŠ¡å‘å¸ƒ"è®¢å•å®Œæˆ"äº‹ä»¶ |
| **äº‹ä»¶å¯¹è±¡** | æºå¸¦æ•°æ®ï¼Œä¼ é€’ä¿¡æ¯ | åŒ…å«è®¢å•å·ã€é‡‘é¢ç­‰ä¿¡æ¯ |
| **ç›‘å¬è€…** | æ¥æ”¶äº‹ä»¶ï¼Œæ‰§è¡Œé€»è¾‘ | åº“å­˜æœåŠ¡å‡åº“å­˜ã€ç§¯åˆ†æœåŠ¡åŠ ç§¯åˆ† |

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶å‘å¸ƒ


**ğŸ”¸ ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**ï¼š

```java
// âŒ ä¼ ç»Ÿçš„ç¡¬ç¼–ç è°ƒç”¨æ–¹å¼
public class OrderService {
    @Autowired
    private InventoryService inventoryService;
    @Autowired
    private PointsService pointsService;
    @Autowired
    private NotificationService notificationService;
    
    public void completeOrder(Order order) {
        // è®¢å•å®Œæˆåï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨æ¯ä¸ªæœåŠ¡
        inventoryService.reduceStock(order);      // å‡åº“å­˜
        pointsService.addPoints(order);           // åŠ ç§¯åˆ†
        notificationService.sendEmail(order);     // å‘é‚®ä»¶
        // æ¯å¢åŠ ä¸€ä¸ªåŠŸèƒ½ï¼Œéƒ½è¦æ”¹è¿™é‡Œçš„ä»£ç 
    }
}
```

**é—®é¢˜åˆ†æ**ï¼š
- âŒ **å¼ºè€¦åˆ**ï¼šOrderServiceå¿…é¡»çŸ¥é“æ‰€æœ‰ç›¸å…³æœåŠ¡
- âŒ **éš¾ç»´æŠ¤**ï¼šæ–°å¢åŠŸèƒ½è¦ä¿®æ”¹OrderServiceä»£ç 
- âŒ **éš¾æµ‹è¯•**ï¼šä¾èµ–å¤ªå¤šï¼Œå•å…ƒæµ‹è¯•å›°éš¾

**âœ… äº‹ä»¶å‘å¸ƒçš„ä¼˜åŠ¿**ï¼š

```java
// âœ… ä½¿ç”¨äº‹ä»¶å‘å¸ƒçš„æ–¹å¼
public class OrderService {
    @Autowired
    private ApplicationEventPublisher publisher;
    
    public void completeOrder(Order order) {
        // åªéœ€å‘å¸ƒäº‹ä»¶ï¼Œè°ç›‘å¬è°å¤„ç†
        publisher.publishEvent(new OrderCompletedEvent(order));
        // æ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ ç›‘å¬å™¨ï¼Œæ— éœ€æ”¹åŠ¨è¿™é‡Œ
    }
}
```

**ä¼˜åŠ¿æ€»ç»“**ï¼š
- âœ… **æ¾è€¦åˆ**ï¼šå‘å¸ƒè€…ä¸çŸ¥é“ç›‘å¬è€…æ˜¯è°
- âœ… **æ˜“æ‰©å±•**ï¼šæ–°å¢ç›‘å¬å™¨å³å¯ï¼Œæ— éœ€æ”¹åŸä»£ç 
- âœ… **æ˜“æµ‹è¯•**ï¼šå‘å¸ƒè€…å’Œç›‘å¬è€…å¯ç‹¬ç«‹æµ‹è¯•

---

## 2. ğŸ“¡ ApplicationEventPublisherè¯¦è§£


### 2.1 æ ¸å¿ƒæ¥å£è®¤è¯†


**ApplicationEventPublisher**æ˜¯Springæä¾›çš„äº‹ä»¶å‘å¸ƒå™¨æ¥å£ï¼Œå¯ä»¥ç†è§£ä¸º**æ¶ˆæ¯å¹¿æ’­ç«™**ã€‚

```java
public interface ApplicationEventPublisher {
    // å‘å¸ƒäº‹ä»¶çš„å”¯ä¸€æ–¹æ³•
    void publishEvent(Object event);
}
```

**ğŸ”¸ æ¥å£ç‰¹ç‚¹**ï¼š
- æ–¹æ³•ç®€å•ï¼šåªæœ‰ä¸€ä¸ªå‘å¸ƒæ–¹æ³•
- å‚æ•°çµæ´»ï¼šå¯ä»¥æ˜¯ä»»ä½•å¯¹è±¡
- è‡ªåŠ¨ç®¡ç†ï¼šSpringè‡ªåŠ¨æ³¨å…¥ï¼Œå¼€ç®±å³ç”¨

### 2.2 è·å–å‘å¸ƒå™¨çš„ä¸‰ç§æ–¹å¼


**æ–¹å¼1ï¼šç›´æ¥æ³¨å…¥ï¼ˆæ¨èï¼‰** â­â­â­â­â­
```java
@Service
public class UserService {
    
    @Autowired  // ç›´æ¥æ³¨å…¥ï¼Œæœ€ç®€å•
    private ApplicationEventPublisher publisher;
    
    public void registerUser(User user) {
        // ... æ³¨å†Œé€»è¾‘
        publisher.publishEvent(new UserRegisteredEvent(user));
    }
}
```

**æ–¹å¼2ï¼šå®ç°æ¥å£** â­â­â­
```java
@Service
public class UserService implements ApplicationEventPublisherAware {
    
    private ApplicationEventPublisher publisher;
    
    @Override
    public void setApplicationEventPublisher(ApplicationEventPublisher publisher) {
        this.publisher = publisher;
    }
    
    public void registerUser(User user) {
        publisher.publishEvent(new UserRegisteredEvent(user));
    }
}
```

**æ–¹å¼3ï¼šæ³¨å…¥ApplicationContext** â­â­
```java
@Service
public class UserService {
    
    @Autowired
    private ApplicationContext context;  // Contextä¹Ÿæ˜¯å‘å¸ƒå™¨
    
    public void registerUser(User user) {
        context.publishEvent(new UserRegisteredEvent(user));
    }
}
```

**ğŸ“Š ä¸‰ç§æ–¹å¼å¯¹æ¯”**ï¼š

| æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **ç›´æ¥æ³¨å…¥** | ç®€å•ç›´è§‚ï¼Œä»£ç å°‘ | æ—  | **æ—¥å¸¸å¼€å‘é¦–é€‰** |
| **å®ç°æ¥å£** | ç¬¦åˆSpringè§„èŒƒ | ä»£ç ç¨å¤š | éœ€è¦æ„ŸçŸ¥Springç¯å¢ƒæ—¶ |
| **æ³¨å…¥Context** | åŠŸèƒ½æ›´å…¨é¢ | è¿‡åº¦ä¾èµ–å®¹å™¨ | éœ€è¦å®¹å™¨å…¶ä»–åŠŸèƒ½æ—¶ |

### 2.3 å‘å¸ƒå™¨çš„å·¥ä½œåŸç†


```
å‘å¸ƒæµç¨‹ï¼š
         
å‘å¸ƒè€…è°ƒç”¨                Springå®¹å™¨                 ç›‘å¬å™¨æ³¨å†Œè¡¨
publishEvent()     â†’    æŸ¥æ‰¾æ‰€æœ‰ç›‘å¬å™¨    â†’      åŒ¹é…äº‹ä»¶ç±»å‹
                              â†“
                        ä¾æ¬¡è°ƒç”¨ç›‘å¬å™¨
                              â†“
                        å¤„ç†äº‹ä»¶é€»è¾‘
```

**ğŸ”¸ æ ¸å¿ƒç†è§£**ï¼š
- ApplicationEventPublisheråªæ˜¯ä¸ª**å…¥å£**
- çœŸæ­£å¹²æ´»çš„æ˜¯Springå®¹å™¨çš„**äº‹ä»¶å¤šæ’­å™¨**ï¼ˆMulticasterï¼‰
- å®¹å™¨è‡ªåŠ¨æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„ç›‘å¬å™¨å¹¶è°ƒç”¨

---

## 3. ğŸš€ publishEventæ–¹æ³•æ·±åº¦è§£æ


### 3.1 æ–¹æ³•ç­¾åè§£è¯»


```java
void publishEvent(Object event);
```

**å‚æ•°åˆ†æ**ï¼š
- `Object event`ï¼šäº‹ä»¶å¯¹è±¡ï¼Œå¯ä»¥æ˜¯**ä»»ä½•ç±»å‹**
- è¿”å›å€¼ï¼š`void`ï¼Œå‘å¸ƒå³å¿˜ï¼Œä¸å…³å¿ƒå¤„ç†ç»“æœ

**ğŸ”¸ çµæ´»æ€§ä½“ç°**ï¼š

```java
// å¯ä»¥å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶å¯¹è±¡
publisher.publishEvent(new OrderEvent(order));

// ä¹Ÿå¯ä»¥ç›´æ¥å‘å¸ƒæ™®é€šå¯¹è±¡
publisher.publishEvent("è®¢å•å·²å®Œæˆ");

// ç”šè‡³å¯ä»¥å‘å¸ƒåŸºæœ¬ç±»å‹åŒ…è£…
publisher.publishEvent(12345);
```

### 3.2 å‘å¸ƒçš„ä¸¤ç§äº‹ä»¶ç±»å‹


**ç±»å‹1ï¼šApplicationEventäº‹ä»¶ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰**

```java
// ç»§æ‰¿ApplicationEventçš„äº‹ä»¶ç±»
public class OrderEvent extends ApplicationEvent {
    private Order order;
    
    public OrderEvent(Object source, Order order) {
        super(source);  // sourceæ˜¯äº‹ä»¶æºï¼Œé€šå¸¸ä¼ this
        this.order = order;
    }
    
    public Order getOrder() {
        return order;
    }
}

// å‘å¸ƒ
publisher.publishEvent(new OrderEvent(this, order));
```

**ç±»å‹2ï¼šPOJOäº‹ä»¶ï¼ˆç°ä»£æ–¹å¼ï¼‰** ğŸ”¥

```java
// æ™®é€šJavaå¯¹è±¡ï¼Œæ— éœ€ç»§æ‰¿
public class OrderEvent {
    private Order order;
    private String eventType;
    
    // æ™®é€šçš„getter/setterå³å¯
}

// å‘å¸ƒ
publisher.publishEvent(new OrderEvent(order, "COMPLETED"));
```

**ğŸ“Š ä¸¤ç§æ–¹å¼å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | ApplicationEvent | POJOäº‹ä»¶ |
|------|-----------------|----------|
| **ç»§æ‰¿è¦æ±‚** | å¿…é¡»ç»§æ‰¿ | æ— éœ€ç»§æ‰¿ |
| **äº‹ä»¶æº** | è‡ªåŠ¨æºå¸¦source | å¯è‡ªå®šä¹‰ |
| **çµæ´»æ€§** | è¾ƒå›ºå®š | éå¸¸çµæ´» |
| **æ¨èåº¦** | â­â­â­ | â­â­â­â­â­ |

> ğŸ’¡ **å»ºè®®**ï¼šä¼˜å…ˆä½¿ç”¨POJOäº‹ä»¶ï¼Œä»£ç æ›´ç®€æ´ï¼Œæ— Springä¾µå…¥

### 3.3 å‘å¸ƒæ—¶çš„å†…éƒ¨æµç¨‹


```
è°ƒç”¨é“¾è·¯ï¼š

1. publisher.publishEvent(event)
         â†“
2. åŒ…è£…æˆApplicationEventï¼ˆå¦‚æœä¸æ˜¯çš„è¯ï¼‰
         â†“
3. è·å–äº‹ä»¶å¤šæ’­å™¨(Multicaster)
         â†“
4. å¤šæ’­å™¨æŸ¥æ‰¾åŒ¹é…çš„ç›‘å¬å™¨
         â†“
5. åŒæ­¥/å¼‚æ­¥è°ƒç”¨ç›‘å¬å™¨
         â†“
6. ç›‘å¬å™¨å¤„ç†äº‹ä»¶
```

**ğŸ”¸ å…³é”®æ­¥éª¤è¯´æ˜**ï¼š

**æ­¥éª¤2ï¼šè‡ªåŠ¨åŒ…è£…**
```java
// å¦‚æœä½ å‘å¸ƒçš„æ˜¯æ™®é€šå¯¹è±¡
publisher.publishEvent("Hello");

// Springä¼šè‡ªåŠ¨åŒ…è£…æˆPayloadApplicationEvent
PayloadApplicationEvent<String> wrapped = 
    new PayloadApplicationEvent<>(source, "Hello");
```

**æ­¥éª¤4ï¼šç›‘å¬å™¨åŒ¹é…**
```
åŒ¹é…è§„åˆ™ï¼š
- æ³›å‹åŒ¹é…ï¼šç›‘å¬å™¨æ³›å‹ç±»å‹è¦åŒ¹é…äº‹ä»¶ç±»å‹
- æ¡ä»¶åŒ¹é…ï¼š@EventListenerçš„conditionè¦æ»¡è¶³
- é¡ºåºåŒ¹é…ï¼šæŒ‰@Orderæ’åº
```

### 3.4 å®é™…åº”ç”¨ç¤ºä¾‹


**åœºæ™¯ï¼šç”¨æˆ·æ³¨å†Œå®Œæˆåçš„å¤šä¸ªåç»­æ“ä½œ**

```java
// 1. å®šä¹‰äº‹ä»¶ï¼ˆPOJOæ–¹å¼ï¼‰
public class UserRegisteredEvent {
    private final User user;
    private final LocalDateTime registeredAt;
    
    public UserRegisteredEvent(User user) {
        this.user = user;
        this.registeredAt = LocalDateTime.now();
    }
    // getter...
}

// 2. å‘å¸ƒäº‹ä»¶
@Service
public class UserService {
    @Autowired
    private ApplicationEventPublisher publisher;
    
    public void register(User user) {
        // ä¿å­˜ç”¨æˆ·
        userRepository.save(user);
        
        // å‘å¸ƒæ³¨å†Œäº‹ä»¶
        publisher.publishEvent(new UserRegisteredEvent(user));
    }
}

// 3. å¤šä¸ªç›‘å¬å™¨å¤„ç†
@Component
public class UserEventListeners {
    
    // å‘é€æ¬¢è¿é‚®ä»¶
    @EventListener
    @Order(1)
    public void sendWelcomeEmail(UserRegisteredEvent event) {
        emailService.sendWelcome(event.getUser());
    }
    
    // èµ é€æ–°äººç§¯åˆ†
    @EventListener
    @Order(2)
    public void grantNewbiePoints(UserRegisteredEvent event) {
        pointsService.grant(event.getUser(), 100);
    }
    
    // è®°å½•æ³¨å†Œæ—¥å¿—
    @EventListener
    @Order(3)
    public void logRegistration(UserRegisteredEvent event) {
        log.info("ç”¨æˆ·æ³¨å†Œï¼š{}", event.getUser().getUsername());
    }
}
```

**ğŸ¯ è¿™ä¸ªä¾‹å­å±•ç¤ºäº†**ï¼š
- ä¸€æ¬¡å‘å¸ƒï¼Œå¤šä¸ªç›‘å¬å™¨å“åº”
- æ¯ä¸ªç›‘å¬å™¨ç‹¬ç«‹å·¥ä½œï¼Œäº’ä¸å½±å“
- æ–°å¢åŠŸèƒ½åªéœ€åŠ ç›‘å¬å™¨ï¼Œä¸æ”¹å‘å¸ƒä»£ç 

---

## 4. ğŸŒŠ äº‹ä»¶ä¼ æ’­æœºåˆ¶


### 4.1 ä¼ æ’­çš„å«ä¹‰


**é€šä¿—ç†è§£**ï¼š
> å°±åƒåœ¨å¾®ä¿¡ç¾¤é‡Œå‘æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¼šä¼ æ’­ç»™æ‰€æœ‰ç¾¤æˆå‘˜ã€‚ä½†æ¯ä¸ªæˆå‘˜æ”¶åˆ°æ¶ˆæ¯çš„æ—¶é—´ã€å¤„ç†æ–¹å¼å¯èƒ½ä¸åŒã€‚

**ä¸“ä¸šå®šä¹‰**ï¼š
```
äº‹ä»¶ä¼ æ’­ï¼šäº‹ä»¶ä»å‘å¸ƒç‚¹å¼€å§‹ï¼Œä¾æ¬¡æˆ–å¹¶å‘åœ°ä¼ é€’ç»™æ‰€æœ‰åŒ¹é…çš„ç›‘å¬å™¨çš„è¿‡ç¨‹
```

### 4.2 ä¼ æ’­çš„ä¸¤ç§æ¨¡å¼


**æ¨¡å¼1ï¼šåŒæ­¥ä¼ æ’­ï¼ˆé»˜è®¤ï¼‰**

```
å‘å¸ƒè€…çº¿ç¨‹ï¼š
    |
    â”œâ”€ å‘å¸ƒäº‹ä»¶
    â”œâ”€ è°ƒç”¨ç›‘å¬å™¨1  â† é˜»å¡ç­‰å¾…
    â”œâ”€ è°ƒç”¨ç›‘å¬å™¨2  â† é˜»å¡ç­‰å¾…
    â”œâ”€ è°ƒç”¨ç›‘å¬å™¨3  â† é˜»å¡ç­‰å¾…
    â””â”€ ç»§ç»­æ‰§è¡Œ
    
ç‰¹ç‚¹ï¼šæŒ‰é¡ºåºæ‰§è¡Œï¼Œä¸€ä¸ªæ¥ä¸€ä¸ª
```

```java
@EventListener
public void handleEvent(OrderEvent event) {
    // è¿™ä¸ªæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œå‘å¸ƒè€…çº¿ç¨‹ä¼šç­‰å¾…
    System.out.println("ç›‘å¬å™¨å¤„ç†ä¸­...");
}
```

**æ¨¡å¼2ï¼šå¼‚æ­¥ä¼ æ’­** ğŸ”¥

```
å‘å¸ƒè€…çº¿ç¨‹ï¼š
    |
    â”œâ”€ å‘å¸ƒäº‹ä»¶
    â”œâ”€ ç«‹å³è¿”å›ç»§ç»­æ‰§è¡Œ
    
ç›‘å¬å™¨çº¿ç¨‹æ± ï¼š
    â”œâ”€ ç›‘å¬å™¨1ï¼ˆç‹¬ç«‹çº¿ç¨‹ï¼‰
    â”œâ”€ ç›‘å¬å™¨2ï¼ˆç‹¬ç«‹çº¿ç¨‹ï¼‰
    â””â”€ ç›‘å¬å™¨3ï¼ˆç‹¬ç«‹çº¿ç¨‹ï¼‰
    
ç‰¹ç‚¹ï¼šå¹¶å‘æ‰§è¡Œï¼Œäº’ä¸é˜»å¡
```

```java
@EventListener
@Async  // æ ‡è®°ä¸ºå¼‚æ­¥
public void handleEvent(OrderEvent event) {
    // åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¸é˜»å¡å‘å¸ƒè€…
    System.out.println("å¼‚æ­¥ç›‘å¬å™¨å¤„ç†ä¸­...");
}
```

**ğŸ“Š ä¸¤ç§æ¨¡å¼å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | åŒæ­¥ä¼ æ’­ | å¼‚æ­¥ä¼ æ’­ |
|------|---------|---------|
| **æ‰§è¡Œçº¿ç¨‹** | å‘å¸ƒè€…çº¿ç¨‹ | ç‹¬ç«‹çº¿ç¨‹æ±  |
| **æ€§èƒ½å½±å“** | é˜»å¡å‘å¸ƒè€… | ä¸é˜»å¡ |
| **äº‹åŠ¡ä¼ é€’** | å¯ä¼ é€’ | ä¸ä¼ é€’ |
| **å¼‚å¸¸å¤„ç†** | å¯æ•è· | éœ€ç‰¹æ®Šå¤„ç† |
| **é€‚ç”¨åœºæ™¯** | éœ€è¦äº‹åŠ¡ã€é¡ºåºæ€§ | è€—æ—¶æ“ä½œã€å¹¶å‘å¤„ç† |

### 4.3 ä¼ æ’­é¡ºåºæ§åˆ¶


**ä½¿ç”¨@Orderæ§åˆ¶é¡ºåº**ï¼š

```java
@Component
public class OrderEventHandlers {
    
    @EventListener
    @Order(1)  // æœ€å…ˆæ‰§è¡Œ
    public void step1(OrderEvent event) {
        System.out.println("æ­¥éª¤1ï¼šéªŒè¯è®¢å•");
    }
    
    @EventListener
    @Order(2)  // ç¬¬äºŒæ‰§è¡Œ
    public void step2(OrderEvent event) {
        System.out.println("æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜");
    }
    
    @EventListener
    @Order(3)  // æœ€åæ‰§è¡Œ
    public void step3(OrderEvent event) {
        System.out.println("æ­¥éª¤3ï¼šå‘é€é€šçŸ¥");
    }
}
```

**ğŸ”¸ é¡ºåºè§„åˆ™**ï¼š
- æ•°å­—è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜
- é»˜è®¤å€¼ï¼š`Ordered.LOWEST_PRECEDENCE`ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰
- åŒä¼˜å…ˆçº§ï¼šæ‰§è¡Œé¡ºåºä¸ä¿è¯

### 4.4 ä¼ æ’­èŒƒå›´æ§åˆ¶


**æ¡ä»¶å‘å¸ƒï¼šåªä¼ æ’­ç»™ç‰¹å®šç›‘å¬å™¨**

```java
@EventListener(condition = "#event.amount > 1000")
public void handleBigOrder(OrderEvent event) {
    // åªå¤„ç†é‡‘é¢å¤§äº1000çš„è®¢å•
}

@EventListener(condition = "#event.userId == 'VIP'")
public void handleVipOrder(OrderEvent event) {
    // åªå¤„ç†VIPç”¨æˆ·çš„è®¢å•
}
```

**æ³›å‹åŒ¹é…ï¼šç²¾ç¡®ä¼ æ’­**

```java
@EventListener
public void handleOrderEvent(OrderCompletedEvent event) {
    // åªæ¥æ”¶OrderCompletedEventç±»å‹
}

@EventListener
public void handlePayEvent(PaymentSuccessEvent event) {
    // åªæ¥æ”¶PaymentSuccessEventç±»å‹
}
```

---

## 5. â° å‘å¸ƒæ—¶æœºä¸æœ€ä½³å®è·µ


### 5.1 å¸¸è§çš„å‘å¸ƒæ—¶æœº


**æ—¶æœº1ï¼šä¸šåŠ¡æ“ä½œå®Œæˆå** â­â­â­â­â­

```java
@Service
public class OrderService {
    
    public void createOrder(Order order) {
        // 1. å…ˆå®Œæˆæ ¸å¿ƒä¸šåŠ¡
        orderRepository.save(order);
        
        // 2. ä¸šåŠ¡æˆåŠŸåå‘å¸ƒäº‹ä»¶
        publisher.publishEvent(new OrderCreatedEvent(order));
    }
}
```

**æ—¶æœº2ï¼šçŠ¶æ€å˜æ›´æ—¶** â­â­â­â­

```java
@Service
public class OrderService {
    
    public void updateStatus(Long orderId, OrderStatus newStatus) {
        Order order = orderRepository.findById(orderId);
        OrderStatus oldStatus = order.getStatus();
        
        // æ›´æ–°çŠ¶æ€
        order.setStatus(newStatus);
        orderRepository.save(order);
        
        // çŠ¶æ€å˜æ›´æ—¶å‘å¸ƒ
        publisher.publishEvent(
            new OrderStatusChangedEvent(order, oldStatus, newStatus)
        );
    }
}
```

**æ—¶æœº3ï¼šç‰¹å®šæ¡ä»¶æ»¡è¶³æ—¶** â­â­â­

```java
@Service
public class OrderService {
    
    public void checkOrder(Order order) {
        // æ£€æŸ¥è®¢å•é‡‘é¢
        if (order.getAmount() > 10000) {
            // å¤§é¢è®¢å•å‘å¸ƒç‰¹æ®Šäº‹ä»¶
            publisher.publishEvent(new BigOrderEvent(order));
        }
    }
}
```

### 5.2 å‘å¸ƒæ—¶æœºçš„æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**ï¼š

```java
// âœ… åœ¨äº‹åŠ¡æäº¤åå‘å¸ƒï¼ˆé¿å…äº‹åŠ¡æœªæäº¤å°±é€šçŸ¥ï¼‰
@Transactional
public void createOrder(Order order) {
    orderRepository.save(order);
    // äº‹åŠ¡ç»“æŸåæ‰å‘å¸ƒ
}

@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
public void afterOrderCreated(OrderCreatedEvent event) {
    // ç¡®ä¿äº‹åŠ¡å·²æäº¤
}
```

**âŒ é¿å…çš„åšæ³•**ï¼š

```java
// âŒ åœ¨äº‹åŠ¡ä¹‹å‰å‘å¸ƒï¼ˆå¯èƒ½äº‹åŠ¡å¤±è´¥ï¼Œä½†å·²é€šçŸ¥ï¼‰
public void createOrder(Order order) {
    publisher.publishEvent(new OrderCreatedEvent(order));
    orderRepository.save(order);  // å¦‚æœè¿™é‡Œå¤±è´¥ï¼Œäº‹ä»¶å·²å‘å‡º
}

// âŒ åœ¨å¾ªç¯ä¸­é¢‘ç¹å‘å¸ƒ
for (Order order : orders) {
    publisher.publishEvent(new OrderEvent(order));  // æ€§èƒ½é—®é¢˜
}
```

### 5.3 å®è·µå»ºè®®


**åœºæ™¯1ï¼šè®¢å•æµç¨‹ä¸­çš„äº‹ä»¶å‘å¸ƒ**

```java
@Service
public class OrderService {
    
    @Transactional
    public void completeOrder(Long orderId) {
        Order order = orderRepository.findById(orderId);
        
        // 1. æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus(OrderStatus.COMPLETED);
        orderRepository.save(order);
        
        // 2. å‘å¸ƒå®Œæˆäº‹ä»¶ï¼ˆäº‹åŠ¡å†…å‘å¸ƒï¼‰
        publisher.publishEvent(new OrderCompletedEvent(order));
    }
}

// ç›‘å¬å™¨ï¼šåœ¨äº‹åŠ¡æäº¤åå¤„ç†
@Component
public class OrderEventListener {
    
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void onOrderCompleted(OrderCompletedEvent event) {
        // è®¢å•å·²ç¡®è®¤æäº¤ï¼Œå¯ä»¥å®‰å…¨å¤„ç†
        sendNotification(event.getOrder());
    }
}
```

**åœºæ™¯2ï¼šæ‰¹é‡æ“ä½œçš„äº‹ä»¶å‘å¸ƒ**

```java
@Service
public class OrderService {
    
    public void batchComplete(List<Long> orderIds) {
        // âœ… å…ˆæ‰¹é‡å¤„ç†ï¼Œå†ç»Ÿä¸€å‘å¸ƒ
        List<Order> completedOrders = new ArrayList<>();
        
        for (Long id : orderIds) {
            Order order = completeOrder(id);
            completedOrders.add(order);
        }
        
        // æ‰¹é‡å‘å¸ƒï¼Œå‡å°‘äº‹ä»¶æ•°é‡
        publisher.publishEvent(new BatchOrderCompletedEvent(completedOrders));
    }
}
```

---

## 6. ğŸš¨ å¼‚å¸¸å¤„ç†ç­–ç•¥


### 6.1 ç›‘å¬å™¨å¼‚å¸¸çš„å½±å“


**åŒæ­¥ç›‘å¬å™¨å¼‚å¸¸** âš ï¸

```
å‘å¸ƒè€…è°ƒç”¨é“¾ï¼š
    |
    â”œâ”€ å‘å¸ƒäº‹ä»¶
    â”œâ”€ ç›‘å¬å™¨1æ‰§è¡Œ âœ…
    â”œâ”€ ç›‘å¬å™¨2æŠ›å¼‚å¸¸ âŒ  â† å¼‚å¸¸ä¼ æ’­ç»™å‘å¸ƒè€…
    â””â”€ ç›‘å¬å™¨3æœªæ‰§è¡Œ â­ï¸   â† åç»­ç›‘å¬å™¨è¢«è·³è¿‡
```

```java
// ç›‘å¬å™¨2æŠ›å¼‚å¸¸
@EventListener
public void listener2(OrderEvent event) {
    throw new RuntimeException("å¤„ç†å¤±è´¥");
}

// å‘å¸ƒè€…ä¼šæ•è·åˆ°å¼‚å¸¸
public void createOrder() {
    try {
        publisher.publishEvent(event);
    } catch (Exception e) {
        // æ•è·åˆ°ç›‘å¬å™¨çš„å¼‚å¸¸
        System.out.println("äº‹ä»¶å¤„ç†å¤±è´¥ï¼š" + e.getMessage());
    }
}
```

**å¼‚æ­¥ç›‘å¬å™¨å¼‚å¸¸** âš ï¸

```
å‘å¸ƒè€…çº¿ç¨‹ï¼š
    |
    â””â”€ å‘å¸ƒäº‹ä»¶ï¼Œç«‹å³è¿”å› âœ…ï¼ˆæ„ŸçŸ¥ä¸åˆ°å¼‚å¸¸ï¼‰
    
ç›‘å¬å™¨çº¿ç¨‹ï¼š
    |
    â””â”€ æŠ›å¼‚å¸¸ âŒï¼ˆå¼‚å¸¸è¢«çº¿ç¨‹æ± åæ‰ï¼‰
```

```java
@EventListener
@Async
public void asyncListener(OrderEvent event) {
    throw new RuntimeException("å¼‚æ­¥å¤„ç†å¤±è´¥");
    // å‘å¸ƒè€…æ„ŸçŸ¥ä¸åˆ°è¿™ä¸ªå¼‚å¸¸
}
```

### 6.2 å¼‚å¸¸å¤„ç†çš„å››ç§ç­–ç•¥


**ç­–ç•¥1ï¼šç›‘å¬å™¨å†…éƒ¨æ•è·ï¼ˆæ¨èï¼‰** â­â­â­â­â­

```java
@EventListener
public void handleOrder(OrderEvent event) {
    try {
        // ä¸šåŠ¡é€»è¾‘
        processOrder(event.getOrder());
    } catch (Exception e) {
        // è‡ªå·±å¤„ç†å¼‚å¸¸ï¼Œä¸å½±å“å…¶ä»–ç›‘å¬å™¨
        log.error("è®¢å•å¤„ç†å¤±è´¥", e);
        // å¯ä»¥å‘å¸ƒå¤±è´¥äº‹ä»¶
        publisher.publishEvent(new OrderProcessFailedEvent(event, e));
    }
}
```

**ç­–ç•¥2ï¼šå…¨å±€å¼‚å¸¸å¤„ç†å™¨**

```java
@Component
public class EventExceptionHandler implements ApplicationListener<ApplicationEvent> {
    
    @Override
    public void onApplicationEvent(ApplicationEvent event) {
        // è¿™ä¸ªä¸æ¨èï¼Œåªæ˜¯å±•ç¤ºå¯èƒ½æ€§
    }
}

// æ›´å¥½çš„æ–¹å¼ï¼šä½¿ç”¨ErrorHandler
@Configuration
public class EventConfig {
    
    @Bean
    public SimpleApplicationEventMulticaster applicationEventMulticaster() {
        SimpleApplicationEventMulticaster multicaster = 
            new SimpleApplicationEventMulticaster();
        
        // è®¾ç½®é”™è¯¯å¤„ç†å™¨
        multicaster.setErrorHandler(t -> {
            log.error("äº‹ä»¶å¤„ç†å¼‚å¸¸", t);
        });
        
        return multicaster;
    }
}
```

**ç­–ç•¥3ï¼šæ¡ä»¶é‡è¯•æœºåˆ¶**

```java
@EventListener
@Retryable(
    value = {Exception.class},
    maxAttempts = 3,
    backoff = @Backoff(delay = 1000)
)
public void handleWithRetry(OrderEvent event) {
    // å¤±è´¥ä¼šè‡ªåŠ¨é‡è¯•3æ¬¡
    riskyOperation(event);
}
```

**ç­–ç•¥4ï¼šå¼‚æ­¥ç›‘å¬å™¨çš„å¼‚å¸¸å¤„ç†**

```java
@Configuration
@EnableAsync
public class AsyncConfig implements AsyncConfigurer {
    
    @Override
    public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() {
        return (ex, method, params) -> {
            log.error("å¼‚æ­¥äº‹ä»¶å¤„ç†å¼‚å¸¸: method={}, params={}", 
                method.getName(), Arrays.toString(params), ex);
        };
    }
}
```

### 6.3 å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ


**å®æˆ˜ç¤ºä¾‹ï¼šè®¢å•å¤„ç†çš„å®Œæ•´å¼‚å¸¸å¤„ç†**

```java
@Component
public class OrderEventHandler {
    
    @EventListener
    @Order(1)
    public void validateOrder(OrderEvent event) {
        try {
            // éªŒè¯è®¢å•
            if (!isValid(event.getOrder())) {
                throw new OrderValidationException("è®¢å•æ— æ•ˆ");
            }
        } catch (OrderValidationException e) {
            // éªŒè¯å¤±è´¥ï¼Œå‘å¸ƒå¤±è´¥äº‹ä»¶
            publisher.publishEvent(new OrderValidationFailedEvent(event, e));
            throw e;  // ç»§ç»­æŠ›å‡ºï¼Œé˜»æ­¢åç»­å¤„ç†
        }
    }
    
    @EventListener
    @Order(2)
    public void processOrder(OrderEvent event) {
        try {
            // å¤„ç†è®¢å•
            orderProcessor.process(event.getOrder());
        } catch (Exception e) {
            // å¤„ç†å¤±è´¥ï¼Œè®°å½•æ—¥å¿—ä½†ä¸å½±å“å…¶ä»–ç›‘å¬å™¨
            log.error("è®¢å•å¤„ç†å¤±è´¥", e);
            // å‘å¸ƒå¤±è´¥äº‹ä»¶ç”¨äºè¡¥å¿
            publisher.publishEvent(new OrderProcessFailedEvent(event, e));
        }
    }
    
    @EventListener
    @Async
    public void sendNotification(OrderEvent event) {
        try {
            // å‘é€é€šçŸ¥
            notificationService.send(event.getOrder());
        } catch (Exception e) {
            // å¼‚æ­¥å¤„ç†å¤±è´¥ï¼Œè®°å½•åˆ°å¤±è´¥é˜Ÿåˆ—
            failureQueue.add(new FailedNotification(event, e));
        }
    }
}
```

---

## 7. ğŸ’¾ äº‹åŠ¡è¾¹ç•Œä¸äº‹ä»¶å‘å¸ƒ


### 7.1 äº‹åŠ¡ä¸äº‹ä»¶çš„å…³ç³»


**æ ¸å¿ƒé—®é¢˜**ï¼šäº‹ä»¶å‘å¸ƒåœ¨äº‹åŠ¡çš„å“ªä¸ªé˜¶æ®µï¼Ÿ

```
äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸï¼š

å¼€å§‹äº‹åŠ¡
    â†“
æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    â†“
å‘å¸ƒäº‹ä»¶ï¼ˆåœ¨è¿™é‡Œï¼Ÿï¼‰
    â†“
æäº¤äº‹åŠ¡
    â†“
äº‹ä»¶å¤„ç†ï¼ˆè¿˜æ˜¯åœ¨è¿™é‡Œï¼Ÿï¼‰
```

**é»˜è®¤è¡Œä¸º**ï¼šäº‹ä»¶åœ¨äº‹åŠ¡**å†…éƒ¨**å‘å¸ƒï¼Œç›‘å¬å™¨**ç«‹å³**æ‰§è¡Œ

```java
@Transactional
public void createOrder(Order order) {
    orderRepository.save(order);           // 1. ä¿å­˜è®¢å•
    publisher.publishEvent(new OrderEvent(order));  // 2. å‘å¸ƒäº‹ä»¶
    // 3. ç›‘å¬å™¨ç«‹å³æ‰§è¡Œï¼ˆäº‹åŠ¡æœªæäº¤ï¼‰
}  // 4. äº‹åŠ¡æäº¤
```

**âš ï¸ æ½œåœ¨é—®é¢˜**ï¼š

```java
@EventListener
public void onOrderCreated(OrderEvent event) {
    // æ­¤æ—¶è®¢å•è¿˜åœ¨äº‹åŠ¡ä¸­ï¼Œæœªæäº¤
    Order order = orderRepository.findById(event.getOrderId());
    // å¯èƒ½æŸ¥è¯¢ä¸åˆ°ï¼Œæˆ–æŸ¥åˆ°çš„æ˜¯æ—§æ•°æ®
}
```

### 7.2 @TransactionalEventListenerè¯¦è§£


**æ ¸å¿ƒä½œç”¨**ï¼šæ§åˆ¶ç›‘å¬å™¨åœ¨äº‹åŠ¡çš„å“ªä¸ªé˜¶æ®µæ‰§è¡Œ

```java
@TransactionalEventListener(
    phase = TransactionPhase.AFTER_COMMIT  // äº‹åŠ¡é˜¶æ®µ
)
public void onOrderCreated(OrderEvent event) {
    // åœ¨äº‹åŠ¡æäº¤åæ‰§è¡Œ
}
```

**å››ä¸ªäº‹åŠ¡é˜¶æ®µ**ï¼š

| é˜¶æ®µ | æšä¸¾å€¼ | æ‰§è¡Œæ—¶æœº | é€‚ç”¨åœºæ™¯ |
|------|--------|---------|---------|
| **æäº¤å** | `AFTER_COMMIT` | äº‹åŠ¡æˆåŠŸæäº¤å | **æœ€å¸¸ç”¨**ï¼Œç¡®ä¿æ•°æ®å·²æŒä¹…åŒ– |
| **å›æ»šå** | `AFTER_ROLLBACK` | äº‹åŠ¡å›æ»šå | å›æ»šè¡¥å¿æ“ä½œ |
| **å®Œæˆå** | `AFTER_COMPLETION` | æ— è®ºæˆåŠŸæˆ–å¤±è´¥ | æ¸…ç†èµ„æº |
| **æäº¤å‰** | `BEFORE_COMMIT` | æäº¤ä¹‹å‰ | æœ€åçš„éªŒè¯ |

### 7.3 äº‹åŠ¡é˜¶æ®µçš„å®æˆ˜åº”ç”¨


**åœºæ™¯1ï¼šè®¢å•åˆ›å»ºæµç¨‹**

```java
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(Order order) {
        // 1. ä¿å­˜è®¢å•
        orderRepository.save(order);
        
        // 2. å‘å¸ƒäº‹ä»¶
        publisher.publishEvent(new OrderCreatedEvent(order));
        
        // 3. äº‹åŠ¡æäº¤
    }
}

// ç›‘å¬å™¨1ï¼šäº‹åŠ¡æäº¤åå‘é€é€šçŸ¥
@Component
public class OrderNotificationListener {
    
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void sendNotification(OrderCreatedEvent event) {
        // ç¡®ä¿è®¢å•å·²ä¿å­˜ï¼Œå¯ä»¥å®‰å…¨å‘é€é€šçŸ¥
        emailService.sendOrderConfirmation(event.getOrder());
    }
}

// ç›‘å¬å™¨2ï¼šäº‹åŠ¡å›æ»šåçš„è¡¥å¿
@Component
public class OrderCompensationListener {
    
    @TransactionalEventListener(phase = TransactionPhase.AFTER_ROLLBACK)
    public void onRollback(OrderCreatedEvent event) {
        // äº‹åŠ¡å¤±è´¥ï¼Œæ‰§è¡Œè¡¥å¿é€»è¾‘
        log.error("è®¢å•åˆ›å»ºå¤±è´¥ï¼Œè®¢å•å·ï¼š{}", event.getOrder().getId());
        // é€šçŸ¥ç”¨æˆ·è®¢å•åˆ›å»ºå¤±è´¥
        notifyUserFailure(event.getOrder());
    }
}
```

**åœºæ™¯2ï¼šåº“å­˜æ‰£å‡ä¸è®¢å•åˆ›å»º**

```java
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(Order order) {
        // 1. æ‰£å‡åº“å­˜
        inventoryService.reduce(order.getProductId(), order.getQuantity());
        
        // 2. åˆ›å»ºè®¢å•
        orderRepository.save(order);
        
        // 3. å‘å¸ƒäº‹ä»¶
        publisher.publishEvent(new OrderCreatedEvent(order));
    }
}

// åº“å­˜æœåŠ¡
@Service
public class InventoryService {
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void reduce(Long productId, int quantity) {
        // ç‹¬ç«‹äº‹åŠ¡ï¼Œå…ˆæäº¤
        Inventory inventory = inventoryRepository.findById(productId);
        inventory.reduce(quantity);
        inventoryRepository.save(inventory);
    }
}

// ç›‘å¬å™¨ï¼šæäº¤åå¤„ç†
@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
public void afterOrderCreated(OrderCreatedEvent event) {
    // è®¢å•å·²ç¡®è®¤ï¼Œåº“å­˜å·²æ‰£å‡ï¼Œå¯ä»¥è¿›è¡Œåç»­æ“ä½œ
    generateInvoice(event.getOrder());
}
```

### 7.4 äº‹åŠ¡ä¼ æ’­çš„æ³¨æ„äº‹é¡¹


**é—®é¢˜1ï¼šç›‘å¬å™¨ä¸­å¼€å¯æ–°äº‹åŠ¡**

```java
@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
@Transactional(propagation = Propagation.REQUIRES_NEW)
public void processOrder(OrderEvent event) {
    // å¼€å¯æ–°äº‹åŠ¡å¤„ç†
    // å³ä½¿è¿™é‡Œå¤±è´¥ï¼ŒåŸäº‹åŠ¡å·²æäº¤ï¼Œä¸ä¼šå›æ»š
}
```

**é—®é¢˜2ï¼šç›‘å¬å™¨å¼‚å¸¸ä¸å½±å“åŸäº‹åŠ¡**

```java
@Transactional
public void createOrder(Order order) {
    orderRepository.save(order);
    publisher.publishEvent(new OrderEvent(order));
}  // äº‹åŠ¡æäº¤

@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
public void afterCommit(OrderEvent event) {
    throw new RuntimeException("å¤„ç†å¤±è´¥");
    // åŸäº‹åŠ¡å·²æäº¤ï¼Œä¸ä¼šå›æ»š
    // éœ€è¦æ‰‹åŠ¨è¡¥å¿
}
```

**æœ€ä½³å®è·µæ€»ç»“**ï¼š

```java
// âœ… æ¨èï¼šåˆ†ç¦»æ ¸å¿ƒäº‹åŠ¡ä¸åç»­å¤„ç†
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(Order order) {
        // æ ¸å¿ƒä¸šåŠ¡ï¼Œç¡®ä¿äº‹åŠ¡å®Œæ•´æ€§
        orderRepository.save(order);
        publisher.publishEvent(new OrderCreatedEvent(order));
    }
}

@Component
public class OrderFollowUpHandler {
    
    // æäº¤åå¤„ç†ï¼Œå¤±è´¥ä¸å½±å“æ ¸å¿ƒä¸šåŠ¡
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void followUp(OrderCreatedEvent event) {
        try {
            sendEmail(event.getOrder());
            updateStatistics(event.getOrder());
        } catch (Exception e) {
            // å¤±è´¥é‡è¯•æˆ–è®°å½•ï¼Œä¸å½±å“è®¢å•åˆ›å»º
            retryQueue.add(event);
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ äº‹ä»¶å‘å¸ƒä¸‰è¦ç´ **ï¼š
```
å‘å¸ƒè€… + äº‹ä»¶å¯¹è±¡ + ç›‘å¬è€… = å®Œæ•´çš„äº‹ä»¶æœºåˆ¶
```

**ğŸ”¸ ApplicationEventPublisher**ï¼š
- Springæä¾›çš„äº‹ä»¶å‘å¸ƒå™¨æ¥å£
- é€šè¿‡`@Autowired`ç›´æ¥æ³¨å…¥ä½¿ç”¨
- åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š`publishEvent(Object event)`

**ğŸ”¸ äº‹ä»¶ä¼ æ’­æ–¹å¼**ï¼š
```
åŒæ­¥ä¼ æ’­ï¼šæŒ‰é¡ºåºæ‰§è¡Œï¼Œä¼šé˜»å¡å‘å¸ƒè€…
å¼‚æ­¥ä¼ æ’­ï¼šå¹¶å‘æ‰§è¡Œï¼Œä¸é˜»å¡å‘å¸ƒè€…ï¼ˆéœ€@Asyncï¼‰
```

**ğŸ”¸ äº‹åŠ¡ä¸äº‹ä»¶**ï¼š
```
@EventListener         â†’ äº‹åŠ¡å†…ç«‹å³æ‰§è¡Œ
@TransactionalEventListener â†’ å¯æ§åˆ¶äº‹åŠ¡é˜¶æ®µ
    AFTER_COMMIT      â†’ äº‹åŠ¡æäº¤åï¼ˆæœ€å¸¸ç”¨ï¼‰
    AFTER_ROLLBACK    â†’ äº‹åŠ¡å›æ»šå
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ’¡ äº‹ä»¶å‘å¸ƒçš„æœ¬è´¨**ï¼š
- è§£è€¦ä¸šåŠ¡é€»è¾‘ï¼Œè®©ä»£ç æ›´çµæ´»
- å‘å¸ƒè€…åªç®¡å‘ï¼Œä¸ç®¡è°åœ¨å¬
- ç›‘å¬è€…åªç®¡å¬ï¼Œä¸ç®¡è°åœ¨å‘

**ğŸ’¡ ä½•æ—¶ä½¿ç”¨äº‹ä»¶å‘å¸ƒ**ï¼š
```
âœ… é€‚åˆï¼š
- ä¸€ä¸ªæ“ä½œè§¦å‘å¤šä¸ªåç»­åŠ¨ä½œ
- ä¸šåŠ¡æ¨¡å—éœ€è¦è§£è€¦
- éœ€è¦æ‰©å±•ç‚¹çš„åœºæ™¯

âŒ ä¸é€‚åˆï¼š
- å¼ºä¾èµ–å…³ç³»çš„ä¸šåŠ¡
- éœ€è¦è¿”å›å€¼çš„è°ƒç”¨
- å¤æ‚çš„ä¸šåŠ¡æµç¨‹ç¼–æ’
```

**ğŸ’¡ å¼‚å¸¸å¤„ç†ç­–ç•¥**ï¼š
```
åŒæ­¥ç›‘å¬å™¨ï¼š
- å¼‚å¸¸ä¼šä¼ æ’­ç»™å‘å¸ƒè€…
- åç»­ç›‘å¬å™¨å¯èƒ½è¢«è·³è¿‡
- éœ€è¦try-catchä¿æŠ¤

å¼‚æ­¥ç›‘å¬å™¨ï¼š
- å¼‚å¸¸ä¸ä¼šä¼ æ’­
- éœ€è¦é…ç½®å¼‚å¸¸å¤„ç†å™¨
- è€ƒè™‘é‡è¯•æœºåˆ¶
```

### 8.3 å®æˆ˜åº”ç”¨å»ºè®®


**ğŸ“Š å…¸å‹åº”ç”¨åœºæ™¯**ï¼š

| åœºæ™¯ | äº‹ä»¶ç±»å‹ | ç›‘å¬å™¨åŠ¨ä½œ |
|------|---------|-----------|
| **ç”¨æˆ·æ³¨å†Œ** | `UserRegisteredEvent` | å‘é‚®ä»¶ã€é€ç§¯åˆ†ã€è®°æ—¥å¿— |
| **è®¢å•å®Œæˆ** | `OrderCompletedEvent` | å‡åº“å­˜ã€å‘ç¥¨ã€é€šçŸ¥ |
| **æ”¯ä»˜æˆåŠŸ** | `PaymentSuccessEvent` | æ›´æ–°è®¢å•ã€å‘è´§ã€ç§¯åˆ† |
| **æ•°æ®å˜æ›´** | `EntityChangedEvent` | ç¼“å­˜å¤±æ•ˆã€é€šçŸ¥ç›¸å…³æ–¹ |

**ğŸ¯ è®¾è®¡åŸåˆ™**ï¼š
1. **å•ä¸€èŒè´£**ï¼šä¸€ä¸ªäº‹ä»¶åªè¡¨è¾¾ä¸€ä¸ªä¸šåŠ¡å«ä¹‰
2. **æ•°æ®å……åˆ†**ï¼šäº‹ä»¶æºå¸¦è¶³å¤Ÿçš„å¤„ç†ä¿¡æ¯
3. **å¹‚ç­‰è®¾è®¡**ï¼šç›‘å¬å™¨å¯èƒ½è¢«é‡å¤è°ƒç”¨
4. **å¤±è´¥è¡¥å¿**ï¼šè€ƒè™‘å¼‚å¸¸åœºæ™¯çš„å¤„ç†æ–¹æ¡ˆ

**ğŸ”§ æ€§èƒ½ä¼˜åŒ–**ï¼š
```java
// 1. æ‰¹é‡å‘å¸ƒå‡å°‘äº‹ä»¶æ•°é‡
publisher.publishEvent(new BatchEvent(list));

// 2. å¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œ
@Async
@EventListener
public void slowOperation(Event event) { }

// 3. æ¡ä»¶ç›‘å¬å‡å°‘æ— æ•ˆæ‰§è¡Œ
@EventListener(condition = "#event.amount > 1000")
public void handleBigOrder(OrderEvent event) { }
```

### 8.4 è®°å¿†è¦è¯€


**ğŸ§  å¿«é€Ÿè®°å¿†å£è¯€**ï¼š

```
å‘å¸ƒäº‹ä»¶ç”¨Publisherï¼Œæ³¨å…¥å³ç”¨å¾ˆç®€å•
åŒæ­¥ä¼ æ’­ä¼šé˜»å¡ï¼Œå¼‚æ­¥éœ€è¦åŠ @Async

äº‹åŠ¡æäº¤ç”¨AFTER_COMMITï¼Œç¡®ä¿æ•°æ®å·²è½åœ°
å¼‚å¸¸å¤„ç†è¦è°¨æ…ï¼ŒåŒæ­¥å¼‚æ­¥åŒºåˆ†æ¸…

ç›‘å¬å™¨å†…æ•å¼‚å¸¸ï¼Œä¸å½±å“å…¶ä»–æ‰§è¡Œ
æ¡ä»¶ç›‘å¬åŠ @Orderï¼Œç²¾ç¡®æ§åˆ¶æ›´çµæ´»
```

**ğŸ“Œ å…³é”®APIé€ŸæŸ¥**ï¼š
```java
// å‘å¸ƒäº‹ä»¶
@Autowired
ApplicationEventPublisher publisher;
publisher.publishEvent(event);

// ç›‘å¬äº‹ä»¶
@EventListener
void handle(Event event) { }

// å¼‚æ­¥ç›‘å¬
@Async
@EventListener
void asyncHandle(Event event) { }

// äº‹åŠ¡ç›‘å¬
@TransactionalEventListener(phase = AFTER_COMMIT)
void afterCommit(Event event) { }

// æ¡ä»¶ç›‘å¬
@EventListener(condition = "#event.type == 'VIP'")
void handleVip(Event event) { }

// é¡ºåºæ§åˆ¶
@Order(1)
@EventListener
void first(Event event) { }
```

---

**ğŸ“ å­¦ä¹ å»ºè®®**ï¼š
1. å…ˆç†è§£å‘å¸ƒ-è®¢é˜…æ¨¡å¼çš„æ€æƒ³
2. æŒæ¡åŸºæœ¬çš„äº‹ä»¶å‘å¸ƒå’Œç›‘å¬
3. æ·±å…¥ç†è§£äº‹åŠ¡ä¸äº‹ä»¶çš„å…³ç³»
4. å®è·µä¸­æ€»ç»“å¼‚å¸¸å¤„ç†ç»éªŒ
5. æ ¹æ®ä¸šåŠ¡åœºæ™¯çµæ´»åº”ç”¨

**æ ¸å¿ƒè®°å¿†**ï¼šäº‹ä»¶æœºåˆ¶æ˜¯Springè§£è€¦çš„åˆ©å™¨ï¼Œå‘å¸ƒè€…å’Œç›‘å¬è€…å„å¸å…¶èŒï¼Œé€šè¿‡äº‹ä»¶å¯¹è±¡ä¼ é€’ä¿¡æ¯ï¼Œçµæ´»è¿ç”¨åŒæ­¥å¼‚æ­¥ã€äº‹åŠ¡é˜¶æ®µã€å¼‚å¸¸å¤„ç†ï¼Œå°±èƒ½æ„å»ºå‡ºæ¾è€¦åˆã€æ˜“æ‰©å±•çš„åº”ç”¨æ¶æ„ï¼