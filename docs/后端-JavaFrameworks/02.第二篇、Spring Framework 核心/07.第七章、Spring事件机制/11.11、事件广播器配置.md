---
title: 11ã€äº‹ä»¶å¹¿æ’­å™¨é…ç½®
---
## ğŸ“š ç›®å½•

1. [äº‹ä»¶å¹¿æ’­å™¨åŸºç¡€æ¦‚å¿µ](#1-äº‹ä»¶å¹¿æ’­å™¨åŸºç¡€æ¦‚å¿µ)
2. [ApplicationEventMulticasteræ ¸å¿ƒæœºåˆ¶](#2-ApplicationEventMulticasteræ ¸å¿ƒæœºåˆ¶)
3. [è‡ªå®šä¹‰å¹¿æ’­å™¨é…ç½®](#3-è‡ªå®šä¹‰å¹¿æ’­å™¨é…ç½®)
4. [æ‰§è¡Œå™¨é…ç½®ä¸çº¿ç¨‹ç®¡ç†](#4-æ‰§è¡Œå™¨é…ç½®ä¸çº¿ç¨‹ç®¡ç†)
5. [å¼‚å¸¸å¤„ç†ç­–ç•¥](#5-å¼‚å¸¸å¤„ç†ç­–ç•¥)
6. [æ€§èƒ½ä¼˜åŒ–å®è·µ](#6-æ€§èƒ½ä¼˜åŒ–å®è·µ)
7. [ç›‘æ§æŒ‡æ ‡ä¸æœ€ä½³å®è·µ](#7-ç›‘æ§æŒ‡æ ‡ä¸æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ äº‹ä»¶å¹¿æ’­å™¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯äº‹ä»¶å¹¿æ’­å™¨


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> æƒ³è±¡ä¸€ä¸‹å­¦æ ¡çš„å¹¿æ’­ç³»ç»Ÿï¼šå½“æœ‰é‡è¦é€šçŸ¥æ—¶ï¼Œå¹¿æ’­å‘˜ï¼ˆäº‹ä»¶å‘å¸ƒè€…ï¼‰é€šè¿‡å¹¿æ’­å®¤çš„è®¾å¤‡ï¼ˆå¹¿æ’­å™¨ï¼‰æŠŠæ¶ˆæ¯ä¼ è¾¾ç»™æ‰€æœ‰æ•™å®¤çš„å–‡å­ï¼ˆç›‘å¬å™¨ï¼‰ã€‚Springçš„äº‹ä»¶å¹¿æ’­å™¨å°±æ˜¯è¿™æ ·ä¸€ä¸ª"æ¶ˆæ¯ä¸­è½¬ç«™"ã€‚

**ğŸ“ æ ¸å¿ƒå®šä¹‰**
```
äº‹ä»¶å¹¿æ’­å™¨ï¼ˆApplicationEventMulticasterï¼‰ï¼š
â€¢ ä½œç”¨ï¼šè´Ÿè´£å°†äº‹ä»¶åˆ†å‘ç»™æ‰€æœ‰æ„Ÿå…´è¶£çš„ç›‘å¬å™¨
â€¢ å®šä½ï¼šSpringäº‹ä»¶æœºåˆ¶çš„æ ¸å¿ƒç»„ä»¶
â€¢ èŒè´£ï¼šç®¡ç†ç›‘å¬å™¨æ³¨å†Œã€äº‹ä»¶åˆ†å‘ã€å¼‚å¸¸å¤„ç†
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦å¹¿æ’­å™¨**

Springäº‹ä»¶æœºåˆ¶çš„å·¥ä½œæµç¨‹ï¼š
```
å‘å¸ƒè€…å‘å¸ƒäº‹ä»¶ â†’ å¹¿æ’­å™¨æ¥æ”¶äº‹ä»¶ â†’ å¹¿æ’­å™¨é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨
    â†“                  â†“                    â†“
ApplicationContext  Multicaster        Listeners
```

å¦‚æœæ²¡æœ‰å¹¿æ’­å™¨ï¼Œå‘å¸ƒè€…éœ€è¦ï¼š
- âŒ è‡ªå·±ç»´æŠ¤æ‰€æœ‰ç›‘å¬å™¨åˆ—è¡¨
- âŒ æ‰‹åŠ¨è°ƒç”¨æ¯ä¸ªç›‘å¬å™¨
- âŒ å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
- âŒ è€ƒè™‘åŒæ­¥/å¼‚æ­¥æ‰§è¡Œ

æœ‰äº†å¹¿æ’­å™¨ä¹‹åï¼š
- âœ… **ç»Ÿä¸€ç®¡ç†**ï¼šæ‰€æœ‰ç›‘å¬å™¨é›†ä¸­æ³¨å†Œ
- âœ… **è‡ªåŠ¨åˆ†å‘**ï¼šäº‹ä»¶è‡ªåŠ¨æ¨é€ç»™ç›¸å…³ç›‘å¬å™¨
- âœ… **çµæ´»é…ç½®**ï¼šæ”¯æŒåŒæ­¥/å¼‚æ­¥ã€å¼‚å¸¸å¤„ç†ç­‰
- âœ… **è§£è€¦è®¾è®¡**ï¼šå‘å¸ƒè€…å’Œç›‘å¬å™¨å®Œå…¨åˆ†ç¦»

### 1.2 å¹¿æ’­å™¨åœ¨Springä¸­çš„ä½ç½®


**ğŸ” æ¶æ„å…³ç³»å›¾**
```
                  Springå®¹å™¨å¯åŠ¨
                        â†“
            åˆ›å»ºApplicationEventMulticaster
                        â†“
              æ³¨å†Œæ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                              â†“
   äº‹ä»¶å‘å¸ƒæ—¶                    å¹¿æ’­å™¨åˆ†å‘äº‹ä»¶
        â†“                              â†“
publishEvent()  â†’  multicastEvent()  â†’ æ‰€æœ‰ç›‘å¬å™¨
```

**ğŸ”— çŸ¥è¯†å…³è”**
- **å‰ç½®çŸ¥è¯†**ï¼š[Springäº‹ä»¶åŸºç¡€]ã€[ApplicationContextå®¹å™¨]
- **ç›¸å…³æ¦‚å¿µ**ï¼š[äº‹ä»¶ç›‘å¬å™¨]ã€[ApplicationEvent]
- **åç»­å­¦ä¹ **ï¼š[äº‹ä»¶å¼‚æ­¥å¤„ç†]ã€[äº‹ä»¶äº‹åŠ¡ç®¡ç†]

### 1.3 é»˜è®¤å¹¿æ’­å™¨ vs è‡ªå®šä¹‰å¹¿æ’­å™¨


| å¯¹æ¯”ç»´åº¦ | **é»˜è®¤SimpleApplicationEventMulticaster** | **è‡ªå®šä¹‰å¹¿æ’­å™¨** |
|---------|------------------------------------------|-----------------|
| **åˆ›å»ºæ–¹å¼** | Springè‡ªåŠ¨åˆ›å»º | æ‰‹åŠ¨é…ç½®Bean |
| **æ‰§è¡Œæ–¹å¼** | åŒæ­¥æ‰§è¡Œ | å¯é…ç½®å¼‚æ­¥ |
| **å¼‚å¸¸å¤„ç†** | æŠ›å‡ºå¼‚å¸¸ä¸­æ–­ | å¯è‡ªå®šä¹‰ç­–ç•¥ |
| **æ€§èƒ½ç›‘æ§** | æ—  | å¯æ·»åŠ ç›‘æ§ |
| **é€‚ç”¨åœºæ™¯** | ç®€å•åº”ç”¨ | å¤æ‚ä¸šåŠ¡åœºæ™¯ |

---

## 2. âš™ï¸ ApplicationEventMulticasteræ ¸å¿ƒæœºåˆ¶


### 2.1 æ¥å£å®šä¹‰ä¸æ ¸å¿ƒæ–¹æ³•


**ğŸ“‹ æ ¸å¿ƒæ¥å£**
```java
public interface ApplicationEventMulticaster {
    
    // æ·»åŠ ç›‘å¬å™¨
    void addApplicationListener(ApplicationListener<?> listener);
    
    // ç§»é™¤ç›‘å¬å™¨
    void removeApplicationListener(ApplicationListener<?> listener);
    
    // å¹¿æ’­äº‹ä»¶ï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼‰
    void multicastEvent(ApplicationEvent event);
    
    // æ”¯æŒäº‹ä»¶ç±»å‹çš„å¹¿æ’­
    void multicastEvent(ApplicationEvent event, 
                       @Nullable ResolvableType eventType);
}
```

ğŸ¯ **ä¸€åˆ†é’ŸæŒæ¡**
æœ€æ ¸å¿ƒçš„3ä¸ªè¦ç‚¹ï¼š
1. **æ³¨å†Œç›‘å¬å™¨**ï¼šå‘Šè¯‰å¹¿æ’­å™¨è°è¦å¬æ¶ˆæ¯
2. **å¹¿æ’­äº‹ä»¶**ï¼šæŠŠæ¶ˆæ¯å‘ç»™æ‰€æœ‰æ„Ÿå…´è¶£çš„äºº
3. **ç±»å‹åŒ¹é…**ï¼šåªé€šçŸ¥å…³å¿ƒè¿™ç±»æ¶ˆæ¯çš„ç›‘å¬å™¨

### 2.2 é»˜è®¤å®ç°ç±»å·¥ä½œåŸç†


**ğŸ”§ SimpleApplicationEventMulticasteræºç è§£æ**

```java
public class SimpleApplicationEventMulticaster 
    extends AbstractApplicationEventMulticaster {
    
    @Nullable
    private Executor taskExecutor; // å¼‚æ­¥æ‰§è¡Œå™¨
    
    @Nullable
    private ErrorHandler errorHandler; // é”™è¯¯å¤„ç†å™¨
    
    @Override
    public void multicastEvent(ApplicationEvent event, 
                              @Nullable ResolvableType eventType) {
        ResolvableType type = (eventType != null ? 
                               eventType : resolveDefaultEventType(event));
        
        // è·å–æ‰€æœ‰åŒ¹é…çš„ç›‘å¬å™¨
        for (ApplicationListener<?> listener : getApplicationListeners(event, type)) {
            
            Executor executor = getTaskExecutor();
            
            // å¦‚æœé…ç½®äº†å¼‚æ­¥æ‰§è¡Œå™¨ï¼Œå¼‚æ­¥è°ƒç”¨
            if (executor != null) {
                executor.execute(() -> invokeListener(listener, event));
            } 
            // å¦åˆ™åŒæ­¥è°ƒç”¨
            else {
                invokeListener(listener, event);
            }
        }
    }
    
    // å®é™…è°ƒç”¨ç›‘å¬å™¨
    protected void invokeListener(ApplicationListener<?> listener, 
                                 ApplicationEvent event) {
        ErrorHandler errorHandler = getErrorHandler();
        if (errorHandler != null) {
            try {
                doInvokeListener(listener, event);
            } catch (Throwable err) {
                errorHandler.handleError(err); // å¼‚å¸¸å¤„ç†
            }
        } else {
            doInvokeListener(listener, event);
        }
    }
}
```

**ğŸ’­ å·¥ä½œæµç¨‹ç†è§£**

åŒæ­¥æ‰§è¡Œæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼š
```
äº‹ä»¶å‘å¸ƒ â†’ å¹¿æ’­å™¨ â†’ é€ä¸ªè°ƒç”¨ç›‘å¬å™¨ â†’ å…¨éƒ¨å®Œæˆè¿”å›
   |          |            |              |
ä¸»çº¿ç¨‹    ä¸»çº¿ç¨‹        ä¸»çº¿ç¨‹          ä¸»çº¿ç¨‹
```

å¼‚æ­¥æ‰§è¡Œæ¨¡å¼ï¼ˆé…ç½®Executorï¼‰ï¼š
```
äº‹ä»¶å‘å¸ƒ â†’ å¹¿æ’­å™¨ â†’ æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ±  â†’ ç«‹å³è¿”å›
   |          |            |              |
ä¸»çº¿ç¨‹    ä¸»çº¿ç¨‹      å·¥ä½œçº¿ç¨‹          ä¸»çº¿ç¨‹
                         â†“
                  ç›‘å¬å™¨å¼‚æ­¥æ‰§è¡Œ
```

### 2.3 ç›‘å¬å™¨åŒ¹é…æœºåˆ¶


**ğŸ” å¦‚ä½•æ‰¾åˆ°åˆé€‚çš„ç›‘å¬å™¨**

```java
// å†…éƒ¨ç»´æŠ¤ç›‘å¬å™¨é›†åˆ
private final ListenerRetriever defaultRetriever = new ListenerRetriever();

// ç›‘å¬å™¨æ£€ç´¢
protected Collection<ApplicationListener<?>> getApplicationListeners(
    ApplicationEvent event, ResolvableType eventType) {
    
    // ä»ç¼“å­˜ä¸­è·å–åŒ¹é…çš„ç›‘å¬å™¨
    ListenerCacher cacher = this.retrieverCache.get(cacheKey);
    
    // ç­›é€‰æ”¯æŒè¯¥äº‹ä»¶ç±»å‹çš„ç›‘å¬å™¨
    for (ApplicationListener<?> listener : allListeners) {
        if (supportsEvent(listener, eventType, sourceType)) {
            filteredListeners.add(listener);
        }
    }
    
    return filteredListeners;
}
```

**ğŸ“Š åŒ¹é…è§„åˆ™**

ç›‘å¬å™¨ç±»å‹ | åŒ¹é…æ–¹å¼ | ç¤ºä¾‹
-----------|---------|-----
æ³›å‹ç›‘å¬å™¨ | æ ¹æ®æ³›å‹å‚æ•° | `ApplicationListener<UserCreatedEvent>`
SmartApplicationListener | è°ƒç”¨supportsEventType() | è‡ªå®šä¹‰å¤æ‚åŒ¹é…é€»è¾‘
@EventListeneræ³¨è§£ | æ ¹æ®å‚æ•°ç±»å‹ | `@EventListener void handle(OrderEvent e)`

---

## 3. ğŸ› ï¸ è‡ªå®šä¹‰å¹¿æ’­å™¨é…ç½®


### 3.1 ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰å¹¿æ’­å™¨


**âš ï¸ é»˜è®¤å¹¿æ’­å™¨çš„å±€é™æ€§**

é»˜è®¤SimpleApplicationEventMulticasterçš„é—®é¢˜ï¼š
- âŒ **åŒæ­¥é˜»å¡**ï¼šæ‰€æœ‰ç›‘å¬å™¨é¡ºåºæ‰§è¡Œï¼Œè€—æ—¶é•¿
- âŒ **å¼‚å¸¸ä¸­æ–­**ï¼šä¸€ä¸ªç›‘å¬å™¨å¼‚å¸¸ä¼šå½±å“åç»­ç›‘å¬å™¨
- âŒ **æ— æ³•ç›‘æ§**ï¼šçœ‹ä¸åˆ°äº‹ä»¶å¤„ç†æ€§èƒ½
- âŒ **æ— æ³•é™çº§**ï¼šå‡ºé—®é¢˜åªèƒ½æŠ›å¼‚å¸¸

**âœ… è‡ªå®šä¹‰å¹¿æ’­å™¨çš„ä¼˜åŠ¿**

```
æ€§èƒ½ä¼˜åŒ– â†’ å¼‚æ­¥æ‰§è¡Œã€çº¿ç¨‹æ± ç®¡ç†
ç¨³å®šæ€§ â†’ å¼‚å¸¸éš”ç¦»ã€é™çº§ç­–ç•¥
å¯è§‚æµ‹æ€§ â†’ æ€§èƒ½ç›‘æ§ã€é“¾è·¯è¿½è¸ª
çµæ´»æ€§ â†’ è‡ªå®šä¹‰åˆ†å‘é€»è¾‘
```

### 3.2 åŸºç¡€è‡ªå®šä¹‰é…ç½®


**ğŸš€ å¿«é€Ÿä¸Šæ‰‹ï¼šé…ç½®å¼‚æ­¥å¹¿æ’­å™¨**

```java
@Configuration
public class EventConfig {
    
    /**
     * è‡ªå®šä¹‰äº‹ä»¶å¹¿æ’­å™¨ï¼ˆBeanåç§°å¿…é¡»æ˜¯applicationEventMulticasterï¼‰
     */
    @Bean(name = "applicationEventMulticaster")
    public ApplicationEventMulticaster simpleApplicationEventMulticaster() {
        
        SimpleApplicationEventMulticaster multicaster = 
            new SimpleApplicationEventMulticaster();
        
        // é…ç½®å¼‚æ­¥æ‰§è¡Œå™¨
        multicaster.setTaskExecutor(asyncEventExecutor());
        
        // é…ç½®é”™è¯¯å¤„ç†å™¨
        multicaster.setErrorHandler(t -> {
            log.error("äº‹ä»¶å¤„ç†å¼‚å¸¸", t);
        });
        
        return multicaster;
    }
    
    /**
     * äº‹ä»¶ä¸“ç”¨çº¿ç¨‹æ± 
     */
    @Bean
    public Executor asyncEventExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        
        executor.setCorePoolSize(5);          // æ ¸å¿ƒçº¿ç¨‹æ•°
        executor.setMaxPoolSize(10);          // æœ€å¤§çº¿ç¨‹æ•°
        executor.setQueueCapacity(100);       // é˜Ÿåˆ—å®¹é‡
        executor.setThreadNamePrefix("event-"); // çº¿ç¨‹åå‰ç¼€
        
        // æ‹’ç»ç­–ç•¥ï¼šè°ƒç”¨è€…æ‰§è¡Œ
        executor.setRejectedExecutionHandler(
            new ThreadPoolExecutor.CallerRunsPolicy());
        
        executor.initialize();
        return executor;
    }
}
```

**ğŸ”‘ é…ç½®å…³é”®ç‚¹**

```
Beanåç§°è¦æ±‚ï¼š
âœ“ å¿…é¡»æ˜¯ "applicationEventMulticaster"
âœ“ Springå®¹å™¨å¯åŠ¨æ—¶ä¼šæŸ¥æ‰¾è¿™ä¸ªåç§°çš„Bean
âœ“ æ‰¾åˆ°åæ›¿æ¢é»˜è®¤å®ç°

æ‰§è¡Œå™¨é€‰æ‹©ï¼š
â€¢ SimpleAsyncTaskExecutorï¼šæ¯æ¬¡åˆ›å»ºæ–°çº¿ç¨‹ï¼ˆä¸æ¨èï¼‰
â€¢ ThreadPoolTaskExecutorï¼šçº¿ç¨‹æ± å¤ç”¨ï¼ˆæ¨èï¼‰
â€¢ è‡ªå®šä¹‰Executorï¼šå®Œå…¨æ§åˆ¶çº¿ç¨‹ç®¡ç†
```

### 3.3 è¿›é˜¶é…ç½®ï¼šæ¡ä»¶åŒ–å¹¿æ’­


**ğŸ’¡ æ ¹æ®äº‹ä»¶ç±»å‹é€‰æ‹©ä¸åŒç­–ç•¥**

```java
@Bean(name = "applicationEventMulticaster")
public ApplicationEventMulticaster customMulticaster() {
    
    return new SimpleApplicationEventMulticaster() {
        
        @Override
        public void multicastEvent(ApplicationEvent event, 
                                  ResolvableType eventType) {
            
            // é‡è¦äº‹ä»¶ï¼šåŒæ­¥æ‰§è¡Œä¿è¯å¯é æ€§
            if (event instanceof CriticalEvent) {
                this.setTaskExecutor(null); // è®¾ç½®ä¸ºnullè¡¨ç¤ºåŒæ­¥
                super.multicastEvent(event, eventType);
                return;
            }
            
            // æ™®é€šäº‹ä»¶ï¼šå¼‚æ­¥æ‰§è¡Œæå‡æ€§èƒ½
            if (event instanceof NormalEvent) {
                this.setTaskExecutor(asyncExecutor);
                super.multicastEvent(event, eventType);
                return;
            }
            
            // é»˜è®¤ç­–ç•¥
            super.multicastEvent(event, eventType);
        }
    };
}
```

**ğŸ“ˆ ç­–ç•¥é€‰æ‹©æŒ‡å—**

| äº‹ä»¶ç±»å‹ | æ‰§è¡Œæ–¹å¼ | åŸå›  | ç¤ºä¾‹ |
|---------|---------|------|------|
| ğŸ”¥ **å…³é”®ä¸šåŠ¡** | åŒæ­¥æ‰§è¡Œ | ä¿è¯å¯é æ€§ | è®¢å•æ”¯ä»˜æˆåŠŸ |
| ğŸ“Š **æ•°æ®ç»Ÿè®¡** | å¼‚æ­¥æ‰§è¡Œ | ä¸å½±å“ä¸»æµç¨‹ | ç”¨æˆ·è¡Œä¸ºåŸ‹ç‚¹ |
| ğŸ“§ **æ¶ˆæ¯é€šçŸ¥** | å¼‚æ­¥æ‰§è¡Œ | å…è®¸å»¶è¿Ÿ | å‘é€é‚®ä»¶/çŸ­ä¿¡ |
| ğŸ”„ **çŠ¶æ€åŒæ­¥** | åŒæ­¥æ‰§è¡Œ | ä¿è¯ä¸€è‡´æ€§ | ç¼“å­˜æ›´æ–° |

---

## 4. ğŸ§µ æ‰§è¡Œå™¨é…ç½®ä¸çº¿ç¨‹ç®¡ç†


### 4.1 çº¿ç¨‹æ± å‚æ•°è¯¦è§£


**ğŸ”§ ThreadPoolTaskExecutoræ ¸å¿ƒå‚æ•°**

```java
@Bean
public Executor eventExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    
    // ========== æ ¸å¿ƒå‚æ•° ==========
    
    // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šå§‹ç»ˆä¿æŒçš„çº¿ç¨‹æ•°é‡
    executor.setCorePoolSize(8);
    
    // æœ€å¤§çº¿ç¨‹æ•°ï¼šçº¿ç¨‹æ± å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°
    executor.setMaxPoolSize(16);
    
    // é˜Ÿåˆ—å®¹é‡ï¼šç­‰å¾…é˜Ÿåˆ—çš„å¤§å°
    executor.setQueueCapacity(200);
    
    // çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼šéæ ¸å¿ƒçº¿ç¨‹ç©ºé—²å¤šä¹…åå›æ”¶
    executor.setKeepAliveSeconds(60);
    
    // ========== è¾…åŠ©å‚æ•° ==========
    
    // çº¿ç¨‹åç§°å‰ç¼€ï¼šä¾¿äºé—®é¢˜æ’æŸ¥
    executor.setThreadNamePrefix("spring-event-");
    
    // ç­‰å¾…ä»»åŠ¡å®Œæˆï¼šå…³é—­æ—¶ç­‰å¾…é˜Ÿåˆ—ä»»åŠ¡æ‰§è¡Œå®Œ
    executor.setWaitForTasksToCompleteOnShutdown(true);
    
    // ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼šæœ€å¤šç­‰å¾…30ç§’
    executor.setAwaitTerminationSeconds(30);
    
    // æ‹’ç»ç­–ç•¥ï¼šé˜Ÿåˆ—æ»¡æ—¶çš„å¤„ç†æ–¹å¼
    executor.setRejectedExecutionHandler(
        new ThreadPoolExecutor.CallerRunsPolicy()
    );
    
    executor.initialize();
    return executor;
}
```

**ğŸ“Š å‚æ•°è®¡ç®—å…¬å¼**

```
æ ¸å¿ƒçº¿ç¨‹æ•°è®¡ç®—ï¼š
â€¢ CPUå¯†é›†å‹ï¼šæ ¸å¿ƒæ•° + 1
â€¢ IOå¯†é›†å‹ï¼šæ ¸å¿ƒæ•° Ã— 2
â€¢ æ··åˆå‹ï¼šæ ¹æ®å®é™…å‹æµ‹è°ƒæ•´

é˜Ÿåˆ—å®¹é‡é€‰æ‹©ï¼š
â€¢ å†…å­˜å……è¶³ï¼šå¯è®¾ç½®è¾ƒå¤§ï¼ˆ500-1000ï¼‰
â€¢ å†…å­˜å—é™ï¼šè®¾ç½®è¾ƒå°ï¼ˆ100-200ï¼‰
â€¢ åŸåˆ™ï¼šé˜²æ­¢OOMï¼Œåˆç†æ’é˜Ÿ

æœ€å¤§çº¿ç¨‹æ•°ï¼š
â€¢ ä¸€èˆ¬è®¾ç½®ä¸ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„ 2 å€
â€¢ ç”¨äºåº”å¯¹çªå‘æµé‡
â€¢ ä¸å®œè¿‡å¤§ï¼Œé¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€
```

### 4.2 æ‹’ç»ç­–ç•¥å¯¹æ¯”


**ğŸš¨ å››ç§å†…ç½®æ‹’ç»ç­–ç•¥**

ç­–ç•¥ç±»å‹ | è¡Œä¸º | é€‚ç”¨åœºæ™¯ | ä¼˜ç¼ºç‚¹
--------|------|---------|-------
**AbortPolicy** (é»˜è®¤) | æŠ›å‡ºå¼‚å¸¸ | å¿…é¡»å¤„ç†çš„ä»»åŠ¡ | âœ… èƒ½æ„ŸçŸ¥æ‹’ç»<br>âŒ éœ€è¦æ•è·å¼‚å¸¸
**CallerRunsPolicy** | è°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œ | é‡è¦ä»»åŠ¡ä¸èƒ½ä¸¢ | âœ… ä¸ä¸¢å¤±ä»»åŠ¡<br>âŒ é™ä½æäº¤é€Ÿåº¦
**DiscardPolicy** | é™é»˜ä¸¢å¼ƒ | å…è®¸ä¸¢å¤±çš„ä»»åŠ¡ | âœ… ä¸æŠ›å¼‚å¸¸<br>âŒ ä»»åŠ¡ä¸¢å¤±æ— æ„ŸçŸ¥
**DiscardOldestPolicy** | ä¸¢å¼ƒæœ€è€ä»»åŠ¡ | ä¼˜å…ˆå¤„ç†æ–°ä»»åŠ¡ | âœ… ä¿è¯æ–°ä»»åŠ¡<br>âŒ è€ä»»åŠ¡ä¸¢å¤±

**ğŸ’¡ å®é™…é€‰æ‹©å»ºè®®**

```java
// æ¨èï¼šè°ƒç”¨è€…æ‰§è¡Œç­–ç•¥ï¼ˆäº‹ä»¶åœºæ™¯å¸¸ç”¨ï¼‰
new ThreadPoolExecutor.CallerRunsPolicy()
// ä¼˜ç‚¹ï¼š
// 1. ä¸ä¸¢å¤±äº‹ä»¶ï¼Œä¿è¯å¯é æ€§
// 2. åå‘å‹åŠ›ï¼Œè‡ªåŠ¨é™æµ
// 3. çº¿ç¨‹æ± æ»¡æ—¶ç”¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œé™ä½é€Ÿåº¦

// åœºæ™¯ç¤ºä¾‹ï¼š
å‘å¸ƒäº‹ä»¶ â†’ çº¿ç¨‹æ± æ»¡ â†’ ä¸»çº¿ç¨‹æ‰§è¡Œç›‘å¬å™¨ â†’ è‡ªåŠ¨é™é€Ÿ
```

### 4.3 çº¿ç¨‹æ± ç›‘æ§é…ç½®


**ğŸ“ˆ æ·»åŠ ç›‘æ§æŒ‡æ ‡**

```java
@Bean
public Executor monitoredEventExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    
    // åŸºç¡€é…ç½®
    executor.setCorePoolSize(8);
    executor.setMaxPoolSize(16);
    executor.setQueueCapacity(200);
    executor.setThreadNamePrefix("event-pool-");
    
    // è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚ï¼ˆæ·»åŠ ç›‘æ§ï¼‰
    executor.setThreadFactory(new ThreadFactory() {
        private final AtomicInteger threadNumber = new AtomicInteger(1);
        
        @Override
        public Thread newThread(Runnable r) {
            Thread thread = new Thread(r, 
                "event-" + threadNumber.getAndIncrement());
            
            // è®¾ç½®æœªæ•è·å¼‚å¸¸å¤„ç†å™¨
            thread.setUncaughtExceptionHandler((t, e) -> {
                log.error("çº¿ç¨‹ {} å‘ç”Ÿæœªæ•è·å¼‚å¸¸", t.getName(), e);
                // å¯ä»¥å‘é€å‘Šè­¦
            });
            
            return thread;
        }
    });
    
    // æ·»åŠ ä»»åŠ¡è£…é¥°å™¨ï¼ˆç»Ÿè®¡æ‰§è¡Œæ—¶é—´ï¼‰
    executor.setTaskDecorator(runnable -> {
        return () -> {
            long start = System.currentTimeMillis();
            try {
                runnable.run();
            } finally {
                long cost = System.currentTimeMillis() - start;
                if (cost > 1000) { // è¶…è¿‡1ç§’è®°å½•
                    log.warn("äº‹ä»¶å¤„ç†è€—æ—¶: {}ms", cost);
                }
            }
        };
    });
    
    executor.initialize();
    return executor;
}
```

**ğŸ” ç›‘æ§æŒ‡æ ‡æ”¶é›†**

```java
@Component
public class ThreadPoolMonitor {
    
    @Autowired
    @Qualifier("eventExecutor")
    private ThreadPoolTaskExecutor executor;
    
    /**
     * å®šæ—¶æ”¶é›†çº¿ç¨‹æ± æŒ‡æ ‡
     */
    @Scheduled(fixedRate = 10000) // æ¯10ç§’
    public void collectMetrics() {
        ThreadPoolExecutor pool = executor.getThreadPoolExecutor();
        
        int activeCount = pool.getActiveCount();        // æ´»è·ƒçº¿ç¨‹æ•°
        int poolSize = pool.getPoolSize();              // å½“å‰çº¿ç¨‹æ•°
        long completedTasks = pool.getCompletedTaskCount(); // å®Œæˆä»»åŠ¡æ•°
        int queueSize = pool.getQueue().size();         // é˜Ÿåˆ—å¤§å°
        
        log.info("çº¿ç¨‹æ± çŠ¶æ€ - æ´»è·ƒ:{}/{}, é˜Ÿåˆ—:{}, å·²å®Œæˆ:{}", 
                 activeCount, poolSize, queueSize, completedTasks);
        
        // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆå¦‚Prometheusï¼‰
        // metricsRegistry.gauge("event.pool.active", activeCount);
    }
}
```

---

## 5. ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†ç­–ç•¥


### 5.1 é»˜è®¤å¼‚å¸¸è¡Œä¸ºçš„é—®é¢˜


**âš ï¸ é»˜è®¤æƒ…å†µä¸‹çš„é£é™©**

```java
// é»˜è®¤è¡Œä¸ºï¼šä¸€ä¸ªç›‘å¬å™¨å¼‚å¸¸ä¼šä¸­æ–­æ•´ä¸ªäº‹ä»¶ä¼ æ’­
@EventListener
public void listener1(UserEvent event) {
    // æ­£å¸¸æ‰§è¡Œ
    log.info("ç›‘å¬å™¨1æ‰§è¡Œ");
}

@EventListener
public void listener2(UserEvent event) {
    // æŠ›å‡ºå¼‚å¸¸
    throw new RuntimeException("ç›‘å¬å™¨2å¼‚å¸¸");
    // âŒ åç»­ç›‘å¬å™¨3ä¸ä¼šè¢«è°ƒç”¨ï¼
}

@EventListener
public void listener3(UserEvent event) {
    // æ°¸è¿œä¸ä¼šæ‰§è¡Œ
    log.info("ç›‘å¬å™¨3æ‰§è¡Œ");
}
```

å¼‚å¸¸ä¼ æ’­é“¾ï¼š
```
å‘å¸ƒäº‹ä»¶ â†’ ç›‘å¬å™¨1(æˆåŠŸ) â†’ ç›‘å¬å™¨2(å¼‚å¸¸) âš ï¸ â†’ ç›‘å¬å™¨3(æœªæ‰§è¡Œ)
                                  â†“
                            å¼‚å¸¸æŠ›å›è°ƒç”¨è€…
```

### 5.2 é…ç½®å…¨å±€å¼‚å¸¸å¤„ç†å™¨


**ğŸ”§ æ–¹å¼1ï¼šErrorHandleré…ç½®**

```java
@Bean(name = "applicationEventMulticaster")
public ApplicationEventMulticaster multicaster() {
    SimpleApplicationEventMulticaster multicaster = 
        new SimpleApplicationEventMulticaster();
    
    // é…ç½®å…¨å±€é”™è¯¯å¤„ç†å™¨
    multicaster.setErrorHandler(new ErrorHandler() {
        @Override
        public void handleError(Throwable t) {
            // è®°å½•å¼‚å¸¸æ—¥å¿—
            log.error("äº‹ä»¶ç›‘å¬å™¨æ‰§è¡Œå¼‚å¸¸", t);
            
            // å¼‚å¸¸åˆ†ç±»å¤„ç†
            if (t instanceof BusinessException) {
                // ä¸šåŠ¡å¼‚å¸¸ï¼šè®°å½•å¹¶å‘Šè­¦
                alertService.sendAlert("ä¸šåŠ¡å¼‚å¸¸", t.getMessage());
            } else if (t instanceof TimeoutException) {
                // è¶…æ—¶å¼‚å¸¸ï¼šè®°å½•æ€§èƒ½é—®é¢˜
                metricsService.recordTimeout();
            } else {
                // å…¶ä»–å¼‚å¸¸ï¼šé€šç”¨å¤„ç†
                log.error("æœªçŸ¥å¼‚å¸¸ç±»å‹", t);
            }
            
            // âœ… ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œä¿è¯åç»­ç›‘å¬å™¨ç»§ç»­æ‰§è¡Œ
        }
    });
    
    return multicaster;
}
```

**ğŸ’¡ ErrorHandlerçš„ä½œç”¨**

é…ç½®å‰ vs é…ç½®åï¼š
```
ã€é…ç½®å‰ã€‘
ç›‘å¬å™¨å¼‚å¸¸ â†’ ä¸­æ–­ä¼ æ’­ â†’ åç»­ç›‘å¬å™¨ä¸æ‰§è¡Œ â†’ è°ƒç”¨è€…æ”¶åˆ°å¼‚å¸¸

ã€é…ç½®åã€‘
ç›‘å¬å™¨å¼‚å¸¸ â†’ æ•è·å¤„ç† â†’ åç»­ç›‘å¬å™¨ç»§ç»­ â†’ è°ƒç”¨è€…æ­£å¸¸è¿”å›
              â†“
        ErrorHandlerå¤„ç†
```

### 5.3 é«˜çº§å¼‚å¸¸å¤„ç†ç­–ç•¥


**ğŸ¯ åˆ†çº§å¼‚å¸¸å¤„ç†**

```java
@Component
public class SmartErrorHandler implements ErrorHandler {
    
    @Override
    public void handleError(Throwable t) {
        
        // è·å–å¼‚å¸¸ä¸Šä¸‹æ–‡
        String listenerName = getListenerName(t);
        String eventType = getEventType(t);
        
        // åˆ†çº§å¤„ç†
        if (isCriticalError(t)) {
            handleCriticalError(listenerName, eventType, t);
        } else if (isRetryableError(t)) {
            handleRetryableError(listenerName, eventType, t);
        } else {
            handleNormalError(listenerName, eventType, t);
        }
    }
    
    /**
     * ä¸¥é‡é”™è¯¯ï¼šç«‹å³å‘Šè­¦ + é™çº§
     */
    private void handleCriticalError(String listener, 
                                     String event, Throwable t) {
        log.error("ä¸¥é‡é”™è¯¯ - ç›‘å¬å™¨:{}, äº‹ä»¶:{}", listener, event, t);
        
        // å‘é€å‘Šè­¦
        alertService.sendUrgentAlert(
            String.format("ç›‘å¬å™¨%så¤„ç†äº‹ä»¶%så¤±è´¥", listener, event),
            t.getMessage()
        );
        
        // æ ‡è®°é™çº§
        circuitBreaker.open(listener);
    }
    
    /**
     * å¯é‡è¯•é”™è¯¯ï¼šå¼‚æ­¥é‡è¯•
     */
    private void handleRetryableError(String listener, 
                                      String event, Throwable t) {
        log.warn("å¯é‡è¯•é”™è¯¯ - ç›‘å¬å™¨:{}, äº‹ä»¶:{}", listener, event, t);
        
        // åŠ å…¥é‡è¯•é˜Ÿåˆ—
        retryQueue.offer(new RetryTask(listener, event, t));
    }
    
    /**
     * æ™®é€šé”™è¯¯ï¼šè®°å½•æ—¥å¿—
     */
    private void handleNormalError(String listener, 
                                   String event, Throwable t) {
        log.error("ç›‘å¬å™¨æ‰§è¡Œå¤±è´¥ - ç›‘å¬å™¨:{}, äº‹ä»¶:{}", 
                  listener, event, t);
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸¥é‡é”™è¯¯
    private boolean isCriticalError(Throwable t) {
        return t instanceof OutOfMemoryError 
            || t instanceof StackOverflowError
            || t.getMessage().contains("æ•°æ®åº“è¿æ¥å¤±è´¥");
    }
    
    // åˆ¤æ–­æ˜¯å¦å¯é‡è¯•
    private boolean isRetryableError(Throwable t) {
        return t instanceof TimeoutException
            || t instanceof TemporaryFailureException;
    }
}
```

### 5.4 ç›‘å¬å™¨çº§åˆ«çš„å¼‚å¸¸å¤„ç†


**ğŸ”’ å•ä¸ªç›‘å¬å™¨çš„å¼‚å¸¸éš”ç¦»**

```java
@Component
public class SafeEventListener {
    
    @EventListener
    public void handleEvent(OrderEvent event) {
        try {
            // ä¸šåŠ¡é€»è¾‘
            processOrder(event.getOrderId());
            
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼šè®°å½•åç»§ç»­
            log.warn("è®¢å•å¤„ç†å¤±è´¥: {}", e.getMessage());
            
        } catch (Exception e) {
            // ç³»ç»Ÿå¼‚å¸¸ï¼šè®°å½•å¹¶å‘Šè­¦
            log.error("è®¢å•å¤„ç†å¼‚å¸¸", e);
            alertService.sendAlert("è®¢å•ç›‘å¬å™¨å¼‚å¸¸", e.getMessage());
            
        } finally {
            // æ¸…ç†èµ„æº
            cleanup();
        }
    }
    
    /**
     * å¸¦é‡è¯•çš„ç›‘å¬å™¨
     */
    @EventListener
    @Retryable(
        value = {TimeoutException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000)
    )
    public void handleWithRetry(PaymentEvent event) {
        // å¯èƒ½è¶…æ—¶çš„æ“ä½œ
        callThirdPartyService(event);
    }
}
```

---

## 6. âš¡ æ€§èƒ½ä¼˜åŒ–å®è·µ


### 6.1 å¼‚æ­¥æ‰§è¡Œä¼˜åŒ–


**ğŸš€ å¼‚æ­¥åŒ–æ”¹é€ å‰åå¯¹æ¯”**

åŒæ­¥æ‰§è¡Œï¼ˆé»˜è®¤ï¼‰ï¼š
```java
// æ€§èƒ½é—®é¢˜ç¤ºä¾‹
@EventListener
public void syncListener1(UserEvent event) {
    Thread.sleep(100); // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
}

@EventListener
public void syncListener2(UserEvent event) {
    Thread.sleep(100);
}

@EventListener
public void syncListener3(UserEvent event) {
    Thread.sleep(100);
}

// å‘å¸ƒäº‹ä»¶æ€»è€—æ—¶ï¼š100 + 100 + 100 = 300ms âŒ
```

å¼‚æ­¥æ‰§è¡Œï¼ˆä¼˜åŒ–åï¼‰ï¼š
```java
@Configuration
public class AsyncEventConfig {
    
    @Bean(name = "applicationEventMulticaster")
    public ApplicationEventMulticaster asyncMulticaster() {
        SimpleApplicationEventMulticaster multicaster = 
            new SimpleApplicationEventMulticaster();
        
        // é…ç½®å¼‚æ­¥æ‰§è¡Œå™¨
        multicaster.setTaskExecutor(eventExecutor());
        
        return multicaster;
    }
    
    @Bean
    public Executor eventExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(500);
        executor.initialize();
        return executor;
    }
}

// å‘å¸ƒäº‹ä»¶æ€»è€—æ—¶ï¼š~10msï¼ˆæäº¤åˆ°çº¿ç¨‹æ± å³è¿”å›ï¼‰âœ…
```

**ğŸ“Š æ€§èƒ½æå‡å¯¹æ¯”**

| æŒ‡æ ‡ | åŒæ­¥æ‰§è¡Œ | å¼‚æ­¥æ‰§è¡Œ | æå‡ |
|------|---------|---------|------|
| äº‹ä»¶å‘å¸ƒè€—æ—¶ | 300ms | 10ms | **30å€** |
| ç³»ç»Ÿååé‡ | 3 äº‹ä»¶/ç§’ | 100 äº‹ä»¶/ç§’ | **33å€** |
| ç”¨æˆ·ä½“éªŒ | æ˜æ˜¾å¡é¡¿ | æ— æ„ŸçŸ¥ | **æå¤§æ”¹å–„** |

### 6.2 ç›‘å¬å™¨è¿‡æ»¤ä¼˜åŒ–


**ğŸ” é¿å…æ— æ•ˆè°ƒç”¨**

```java
/**
 * æ™ºèƒ½ç›‘å¬å™¨ï¼šåªå¤„ç†æ„Ÿå…´è¶£çš„äº‹ä»¶
 */
@Component
public class SmartListener implements SmartApplicationListener {
    
    @Override
    public boolean supportsEventType(Class<? extends ApplicationEvent> eventType) {
        // åªå¤„ç†OrderEventåŠå…¶å­ç±»
        return OrderEvent.class.isAssignableFrom(eventType);
    }
    
    @Override
    public boolean supportsSourceType(@Nullable Class<?> sourceType) {
        // åªå¤„ç†æ¥è‡ªOrderServiceçš„äº‹ä»¶
        return OrderService.class.isAssignableFrom(sourceType);
    }
    
    @Override
    public void onApplicationEvent(ApplicationEvent event) {
        OrderEvent orderEvent = (OrderEvent) event;
        // å¤„ç†é€»è¾‘
        processOrder(orderEvent);
    }
    
    @Override
    public int getOrder() {
        return HIGHEST_PRECEDENCE; // ä¼˜å…ˆçº§
    }
}
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
```
æ™®é€šç›‘å¬å™¨ï¼š
äº‹ä»¶å‘å¸ƒ â†’ è°ƒç”¨æ‰€æœ‰ç›‘å¬å™¨ â†’ å†…éƒ¨åˆ¤æ–­æ˜¯å¦å¤„ç†
          ï¼ˆæµªè´¹è°ƒç”¨å¼€é”€ï¼‰

æ™ºèƒ½ç›‘å¬å™¨ï¼š
äº‹ä»¶å‘å¸ƒ â†’ æå‰è¿‡æ»¤ â†’ åªè°ƒç”¨åŒ¹é…çš„ç›‘å¬å™¨
          ï¼ˆå‡å°‘æ— æ•ˆè°ƒç”¨ï¼‰
```

### 6.3 æ‰¹é‡äº‹ä»¶ä¼˜åŒ–


**ğŸ“¦ äº‹ä»¶æ‰¹å¤„ç†ç­–ç•¥**

```java
@Component
public class BatchEventPublisher {
    
    private final ApplicationEventPublisher publisher;
    private final BlockingQueue<OrderEvent> eventQueue = 
        new LinkedBlockingQueue<>(1000);
    
    /**
     * æ”¶é›†äº‹ä»¶ï¼ˆä¸ç«‹å³å‘å¸ƒï¼‰
     */
    public void collectEvent(OrderEvent event) {
        eventQueue.offer(event);
    }
    
    /**
     * å®šæ—¶æ‰¹é‡å‘å¸ƒ
     */
    @Scheduled(fixedRate = 1000) // æ¯ç§’ä¸€æ¬¡
    public void publishBatch() {
        List<OrderEvent> events = new ArrayList<>();
        eventQueue.drainTo(events, 100); // ä¸€æ¬¡æœ€å¤š100ä¸ª
        
        if (!events.isEmpty()) {
            // å‘å¸ƒæ‰¹é‡äº‹ä»¶
            publisher.publishEvent(new BatchOrderEvent(this, events));
            
            log.info("æ‰¹é‡å‘å¸ƒ {} ä¸ªäº‹ä»¶", events.size());
        }
    }
}

/**
 * æ‰¹é‡äº‹ä»¶
 */
public class BatchOrderEvent extends ApplicationEvent {
    private final List<OrderEvent> events;
    
    public BatchOrderEvent(Object source, List<OrderEvent> events) {
        super(source);
        this.events = events;
    }
}

/**
 * æ‰¹é‡ç›‘å¬å™¨
 */
@EventListener
public void handleBatch(BatchOrderEvent batchEvent) {
    List<OrderEvent> events = batchEvent.getEvents();
    
    // æ‰¹é‡å¤„ç†ï¼ˆå¦‚æ‰¹é‡å…¥åº“ï¼‰
    batchInsert(events);
}
```

**ğŸ’° æ‰¹å¤„ç†æ”¶ç›Š**

```
å•ä¸ªå‘å¸ƒæ¨¡å¼ï¼š
å‘å¸ƒ1000ä¸ªäº‹ä»¶ = 1000æ¬¡æ–¹æ³•è°ƒç”¨ + 1000æ¬¡ç›‘å¬å™¨è°ƒç”¨

æ‰¹é‡å‘å¸ƒæ¨¡å¼ï¼š
æ”¶é›†1000ä¸ªäº‹ä»¶ = 10æ¬¡æ‰¹é‡å‘å¸ƒ + 10æ¬¡ç›‘å¬å™¨è°ƒç”¨
æ€§èƒ½æå‡ï¼š~100å€
```

### 6.4 ç¼“å­˜ä¼˜åŒ–


**ğŸ—„ï¸ ç›‘å¬å™¨ç¼“å­˜æœºåˆ¶**

```java
@Configuration
public class CachedMulticasterConfig {
    
    @Bean(name = "applicationEventMulticaster")
    public ApplicationEventMulticaster cachedMulticaster() {
        
        return new SimpleApplicationEventMulticaster() {
            
            // ç›‘å¬å™¨ç¼“å­˜
            private final Map<Class<?>, List<ApplicationListener<?>>> 
                listenerCache = new ConcurrentHashMap<>();
            
            @Override
            protected Collection<ApplicationListener<?>> getApplicationListeners(
                ApplicationEvent event, ResolvableType eventType) {
                
                Class<?> eventClass = event.getClass();
                
                // ä»ç¼“å­˜è·å–
                return listenerCache.computeIfAbsent(eventClass, key -> {
                    // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢å¹¶ç¼“å­˜
                    Collection<ApplicationListener<?>> listeners = 
                        super.getApplicationListeners(event, eventType);
                    return new ArrayList<>(listeners);
                });
            }
        };
    }
}
```

**æ€§èƒ½æå‡**ï¼š
```
æ— ç¼“å­˜ï¼š
æ¯æ¬¡äº‹ä»¶ â†’ éå†æ‰€æœ‰ç›‘å¬å™¨ â†’ ç±»å‹åŒ¹é… â†’ è¿”å›ç»“æœ
         ï¼ˆé‡å¤è®¡ç®—ï¼‰

æœ‰ç¼“å­˜ï¼š
é¦–æ¬¡äº‹ä»¶ â†’ è®¡ç®—å¹¶ç¼“å­˜ â†’ è¿”å›ç»“æœ
åç»­äº‹ä»¶ â†’ ç›´æ¥ä»ç¼“å­˜è·å– â†’ è¿”å›ç»“æœ
         ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
```

---

## 7. ğŸ“Š ç›‘æ§æŒ‡æ ‡ä¸æœ€ä½³å®è·µ


### 7.1 å…³é”®æ€§èƒ½æŒ‡æ ‡


**ğŸ“ˆ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**

| æŒ‡æ ‡ç±»å‹ | æŒ‡æ ‡åç§° | è¯´æ˜ | å‘Šè­¦é˜ˆå€¼ |
|---------|---------|------|---------|
| **ååé‡** | events_per_second | æ¯ç§’å¤„ç†äº‹ä»¶æ•° | < 10 å‘Šè­¦ |
| **å»¶è¿Ÿ** | event_processing_latency | äº‹ä»¶å¤„ç†è€—æ—¶ | > 1s å‘Šè­¦ |
| **é˜Ÿåˆ—** | event_queue_size | å¾…å¤„ç†äº‹ä»¶æ•° | > 500 å‘Šè­¦ |
| **çº¿ç¨‹æ± ** | thread_pool_active | æ´»è·ƒçº¿ç¨‹æ•° | = maxPoolSize å‘Šè­¦ |
| **å¼‚å¸¸ç‡** | error_rate | å¼‚å¸¸æ¯”ä¾‹ | > 5% å‘Šè­¦ |

**ğŸ”§ æŒ‡æ ‡é‡‡é›†å®ç°**

```java
@Component
public class EventMetricsCollector {
    
    private final MeterRegistry meterRegistry;
    
    // è®¡æ•°å™¨ï¼šäº‹ä»¶æ€»æ•°
    private final Counter eventCounter;
    
    // è®¡æ—¶å™¨ï¼šäº‹ä»¶å¤„ç†æ—¶é•¿
    private final Timer eventTimer;
    
    // ä»ªè¡¨ç›˜ï¼šé˜Ÿåˆ—å¤§å°
    private final Gauge queueGauge;
    
    public EventMetricsCollector(MeterRegistry meterRegistry,
                                ThreadPoolTaskExecutor executor) {
        this.meterRegistry = meterRegistry;
        
        // åˆå§‹åŒ–æŒ‡æ ‡
        this.eventCounter = Counter.builder("spring.events.published")
            .description("å‘å¸ƒçš„äº‹ä»¶æ€»æ•°")
            .register(meterRegistry);
        
        this.eventTimer = Timer.builder("spring.events.processing.time")
            .description("äº‹ä»¶å¤„ç†æ—¶é•¿")
            .register(meterRegistry);
        
        this.queueGauge = Gauge.builder("spring.events.queue.size", 
            executor.getThreadPoolExecutor().getQueue(), 
            Queue::size)
            .description("äº‹ä»¶é˜Ÿåˆ—å¤§å°")
            .register(meterRegistry);
    }
    
    /**
     * è®°å½•äº‹ä»¶å‘å¸ƒ
     */
    public void recordEventPublished(ApplicationEvent event) {
        eventCounter.increment();
        
        // æŒ‰äº‹ä»¶ç±»å‹åˆ†ç±»ç»Ÿè®¡
        meterRegistry.counter("spring.events.published", 
            "type", event.getClass().getSimpleName())
            .increment();
    }
    
    /**
     * è®°å½•äº‹ä»¶å¤„ç†æ—¶é•¿
     */
    public void recordProcessingTime(ApplicationEvent event, long millis) {
        eventTimer.record(millis, TimeUnit.MILLISECONDS);
        
        // è®°å½•æ…¢äº‹ä»¶
        if (millis > 1000) {
            log.warn("æ…¢äº‹ä»¶: {} è€—æ—¶ {}ms", 
                     event.getClass().getSimpleName(), millis);
        }
    }
}
```

### 7.2 ç›‘æ§é›†æˆç¤ºä¾‹


**ğŸ”Œ Prometheus + Grafanaé›†æˆ**

```java
@Configuration
public class MonitoringConfig {
    
    /**
     * é…ç½®å¸¦ç›‘æ§çš„å¹¿æ’­å™¨
     */
    @Bean(name = "applicationEventMulticaster")
    public ApplicationEventMulticaster monitoredMulticaster(
        EventMetricsCollector metricsCollector) {
        
        return new SimpleApplicationEventMulticaster() {
            
            @Override
            public void multicastEvent(ApplicationEvent event, 
                                      ResolvableType eventType) {
                
                // è®°å½•äº‹ä»¶å‘å¸ƒ
                metricsCollector.recordEventPublished(event);
                
                long startTime = System.currentTimeMillis();
                
                try {
                    // æ‰§è¡Œäº‹ä»¶åˆ†å‘
                    super.multicastEvent(event, eventType);
                    
                } finally {
                    // è®°å½•å¤„ç†æ—¶é•¿
                    long cost = System.currentTimeMillis() - startTime;
                    metricsCollector.recordProcessingTime(event, cost);
                }
            }
        };
    }
}
```

**Grafanaä»ªè¡¨ç›˜é…ç½®**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Spring Events ç›‘æ§é¢æ¿         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Š æ¯ç§’äº‹ä»¶æ•°                        â”‚
â”‚ â–†â–†â–ˆâ–†â–…â–„â–ƒâ–‚â–                   [23/s] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â±ï¸ å¹³å‡å¤„ç†æ—¶é•¿                     â”‚
â”‚ â–‚â–ƒâ–„â–…â–†â–ˆâ–†â–…â–„â–ƒâ–‚               [125ms] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ§µ çº¿ç¨‹æ± çŠ¶æ€                       â”‚
â”‚ æ´»è·ƒ: 8/16   é˜Ÿåˆ—: 45/500          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸ å¼‚å¸¸ç‡                          â”‚
â”‚ â–â–â–‚â–â–â–â–â–â–â–                 [0.5%] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 æœ€ä½³å®è·µæ€»ç»“


**âœ… DO - æ¨èåšæ³•**

```
1ï¸âƒ£ é…ç½®ä¸“ç”¨çº¿ç¨‹æ± 
â€¢ ä¸è¦ä½¿ç”¨å…¬å…±çº¿ç¨‹æ± 
â€¢ æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è°ƒæ•´å‚æ•°
â€¢ è®¾ç½®æœ‰æ„ä¹‰çš„çº¿ç¨‹åç§°

2ï¸âƒ£ å®ç°å…¨å±€å¼‚å¸¸å¤„ç†
â€¢ é…ç½®ErrorHandler
â€¢ è®°å½•è¯¦ç»†å¼‚å¸¸ä¿¡æ¯
â€¢ ä¸è¦è®©å¼‚å¸¸ä¸­æ–­äº‹ä»¶ä¼ æ’­

3ï¸âƒ£ åˆç†é€‰æ‹©æ‰§è¡Œæ¨¡å¼
â€¢ å…³é”®ä¸šåŠ¡ï¼šåŒæ­¥æ‰§è¡Œ
â€¢ è¾…åŠ©åŠŸèƒ½ï¼šå¼‚æ­¥æ‰§è¡Œ
â€¢ æ ¹æ®åœºæ™¯çµæ´»é…ç½®

4ï¸âƒ£ æ·»åŠ ç›‘æ§å‘Šè­¦
â€¢ ç›‘æ§å…³é”®æŒ‡æ ‡
â€¢ è®¾ç½®åˆç†é˜ˆå€¼
â€¢ åŠæ—¶å“åº”å‘Šè­¦

5ï¸âƒ£ ä¼˜åŒ–ç›‘å¬å™¨æ€§èƒ½
â€¢ ä½¿ç”¨SmartApplicationListener
â€¢ é¿å…é‡å¤è®¡ç®—
â€¢ å®ç°ç¼“å­˜æœºåˆ¶
```

**âŒ DON'T - é¿å…åšæ³•**

```
1ï¸âƒ£ ä¸è¦åœ¨ç›‘å¬å™¨ä¸­æ‰§è¡Œé•¿è€—æ—¶æ“ä½œ
â€¢ ä¼šé˜»å¡å…¶ä»–ç›‘å¬å™¨
â€¢ å½±å“ç³»ç»Ÿæ€§èƒ½
â€¢ åº”è¯¥å¼‚æ­¥å¤„ç†æˆ–æ‹†åˆ†

2ï¸âƒ£ ä¸è¦å¿½ç•¥å¼‚å¸¸å¤„ç†
â€¢ ä¼šå¯¼è‡´äº‹ä»¶ä¼ æ’­ä¸­æ–­
â€¢ å½±å“å…¶ä»–ç›‘å¬å™¨æ‰§è¡Œ
â€¢ å¿…é¡»é…ç½®ErrorHandler

3ï¸âƒ£ ä¸è¦æ— é™åˆ¶åˆ›å»ºçº¿ç¨‹
â€¢ ä½¿ç”¨çº¿ç¨‹æ± ç®¡ç†
â€¢ è®¾ç½®åˆç†çš„é˜Ÿåˆ—å¤§å°
â€¢ é…ç½®æ‹’ç»ç­–ç•¥

4ï¸âƒ£ ä¸è¦åœ¨ç›‘å¬å™¨ä¸­å‘å¸ƒç›¸åŒç±»å‹äº‹ä»¶
â€¢ å¯èƒ½å¯¼è‡´æ— é™é€’å½’
â€¢ é€ æˆæ ˆæº¢å‡º
â€¢ éœ€è¦æ·»åŠ é€’å½’æ£€æµ‹

5ï¸âƒ£ ä¸è¦å¿½ç•¥ç›‘æ§
â€¢ æ— æ³•å‘ç°æ€§èƒ½é—®é¢˜
â€¢ æ— æ³•å®šä½æ•…éšœåŸå› 
â€¢ å¿…é¡»å»ºç«‹ç›‘æ§ä½“ç³»
```

### 7.4 ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•


**ğŸ” ä¸Šçº¿å‰æ£€æŸ¥**

- [ ] **é…ç½®æ£€æŸ¥**
  - [ ] å·²é…ç½®è‡ªå®šä¹‰å¹¿æ’­å™¨
  - [ ] çº¿ç¨‹æ± å‚æ•°ç»è¿‡å‹æµ‹éªŒè¯
  - [ ] æ‹’ç»ç­–ç•¥ç¬¦åˆä¸šåŠ¡éœ€æ±‚
  
- [ ] **å¼‚å¸¸å¤„ç†**
  - [ ] å·²é…ç½®å…¨å±€ErrorHandler
  - [ ] å…³é”®ç›‘å¬å™¨æœ‰try-catch
  - [ ] å¼‚å¸¸å‘Šè­¦å·²é…ç½®
  
- [ ] **æ€§èƒ½ä¼˜åŒ–**
  - [ ] è€—æ—¶æ“ä½œå·²å¼‚æ­¥åŒ–
  - [ ] æ‰¹å¤„ç†ç­–ç•¥å·²å®æ–½
  - [ ] ç¼“å­˜æœºåˆ¶å·²å¯ç”¨
  
- [ ] **ç›‘æ§å‘Šè­¦**
  - [ ] å…³é”®æŒ‡æ ‡å·²æ¥å…¥ç›‘æ§
  - [ ] å‘Šè­¦é˜ˆå€¼å·²è®¾ç½®
  - [ ] å‘Šè­¦é€šé“å·²æµ‹è¯•
  
- [ ] **æ–‡æ¡£è®°å½•**
  - [ ] é…ç½®è¯´æ˜æ–‡æ¡£
  - [ ] ç›‘å¬å™¨æ¸…å•
  - [ ] æ•…éšœå¤„ç†æ‰‹å†Œ

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


ğŸ¯ **äº”ä¸ªå…³é”®ç†è§£**

1. **å¹¿æ’­å™¨æ˜¯ä»€ä¹ˆ**
   - Springäº‹ä»¶æœºåˆ¶çš„æ¶ˆæ¯ä¸­è½¬ç«™
   - è´Ÿè´£ç®¡ç†ç›‘å¬å™¨å’Œåˆ†å‘äº‹ä»¶
   - å¯ä»¥è‡ªå®šä¹‰é…ç½®åŒæ­¥/å¼‚æ­¥æ‰§è¡Œ

2. **ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰å¹¿æ’­å™¨**
   - é»˜è®¤åŒæ­¥æ‰§è¡Œæ€§èƒ½å·®
   - å¼‚å¸¸å¤„ç†ä¸å¤Ÿçµæ´»
   - éœ€è¦ç›‘æ§å’Œæ€§èƒ½ä¼˜åŒ–

3. **å¦‚ä½•é…ç½®å¹¿æ’­å™¨**
   - Beanåç§°å¿…é¡»æ˜¯`applicationEventMulticaster`
   - é…ç½®TaskExecutorå®ç°å¼‚æ­¥
   - é…ç½®ErrorHandlerå¤„ç†å¼‚å¸¸

4. **çº¿ç¨‹æ± æ€ä¹ˆé…ç½®**
   - æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šCPUå¯†é›†å‹=æ ¸å¿ƒæ•°+1ï¼ŒIOå¯†é›†å‹=æ ¸å¿ƒæ•°Ã—2
   - é˜Ÿåˆ—å®¹é‡ï¼š100-500é€‚ä¸­
   - æ‹’ç»ç­–ç•¥ï¼šæ¨èCallerRunsPolicy

5. **ç›‘æ§æŒ‡æ ‡æœ‰å“ªäº›**
   - ååé‡ã€å»¶è¿Ÿã€é˜Ÿåˆ—å¤§å°
   - çº¿ç¨‹æ± çŠ¶æ€ã€å¼‚å¸¸ç‡
   - éœ€è¦æ¥å…¥Prometheus/Grafana

### 8.2 å¿«é€Ÿé…ç½®æ¨¡æ¿


**ğŸš€ å¼€ç®±å³ç”¨é…ç½®**

```java
@Configuration
public class EventBroadcasterConfig {
    
    /**
     * ç”Ÿäº§çº§å¹¿æ’­å™¨é…ç½®
     */
    @Bean(name = "applicationEventMulticaster")
    public ApplicationEventMulticaster eventMulticaster() {
        SimpleApplicationEventMulticaster multicaster = 
            new SimpleApplicationEventMulticaster();
        
        // å¼‚æ­¥æ‰§è¡Œå™¨
        multicaster.setTaskExecutor(eventExecutor());
        
        // å¼‚å¸¸å¤„ç†å™¨
        multicaster.setErrorHandler(t -> 
            log.error("äº‹ä»¶å¤„ç†å¼‚å¸¸", t));
        
        return multicaster;
    }
    
    /**
     * äº‹ä»¶çº¿ç¨‹æ± 
     */
    @Bean
    public Executor eventExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(8);
        executor.setMaxPoolSize(16);
        executor.setQueueCapacity(200);
        executor.setThreadNamePrefix("event-");
        executor.setRejectedExecutionHandler(
            new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}
```

### 8.3 å®æˆ˜ç»éªŒæ€»ç»“


**ğŸ’¡ å…³é”®ç»éªŒ**

```
ç»éªŒ1ï¼šå¼‚æ­¥ä¸æ˜¯ä¸‡èƒ½çš„
âœ“ å…³é”®ä¸šåŠ¡ä¿æŒåŒæ­¥ä¿è¯å¯é æ€§
âœ“ è¾…åŠ©åŠŸèƒ½å¼‚æ­¥æå‡æ€§èƒ½
âœ“ æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹çµæ´»é€‰æ‹©

ç»éªŒ2ï¼šå¼‚å¸¸å¤„ç†æ˜¯æ ¸å¿ƒ
âœ“ å¿…é¡»é…ç½®ErrorHandler
âœ“ ä¸è¦è®©å¼‚å¸¸ä¸­æ–­äº‹ä»¶ä¼ æ’­
âœ“ è®°å½•è¯¦ç»†æ—¥å¿—ä¾¿äºæ’æŸ¥

ç»éªŒ3ï¼šç›‘æ§æ˜¯è¿ç»´åŸºç¡€
âœ“ å…³é”®æŒ‡æ ‡å¿…é¡»ç›‘æ§
âœ“ è®¾ç½®åˆç†å‘Šè­¦é˜ˆå€¼
âœ“ å®šæœŸreviewç›‘æ§æ•°æ®

ç»éªŒ4ï¼šæ€§èƒ½ä¼˜åŒ–è¦é€‚åº¦
âœ“ å…ˆæ»¡è¶³åŠŸèƒ½å†ä¼˜åŒ–æ€§èƒ½
âœ“ åŸºäºç›‘æ§æ•°æ®åšä¼˜åŒ–å†³ç­–
âœ“ é¿å…è¿‡åº¦ä¼˜åŒ–
```

### 8.4 å­¦ä¹ è·¯çº¿å›¾


**ğŸ“š è¿›é˜¶å­¦ä¹ è·¯å¾„**

```
å½“å‰æŒæ¡ï¼šäº‹ä»¶å¹¿æ’­å™¨é…ç½®
         â†“
ä¸‹ä¸€æ­¥å­¦ä¹ ï¼š
â”œâ”€â”€ ğŸ”„ äº‹ä»¶äº‹åŠ¡ç®¡ç†
â”‚   â””â”€â”€ @TransactionalEventListener
â”œâ”€â”€ ğŸŒ åˆ†å¸ƒå¼äº‹ä»¶æ€»çº¿
â”‚   â””â”€â”€ Spring Cloud Bus
â”œâ”€â”€ ğŸ”Œ æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ
â”‚   â””â”€â”€ RabbitMQ/Kafkaäº‹ä»¶
â””â”€â”€ ğŸ¯ é¢†åŸŸäº‹ä»¶é©±åŠ¨
    â””â”€â”€ DDDä¸­çš„äº‹ä»¶åº”ç”¨
```

**ğŸ¯ ä¸€å¥è¯æ€»ç»“**

> Springäº‹ä»¶å¹¿æ’­å™¨æ˜¯äº‹ä»¶æœºåˆ¶çš„å¿ƒè„ï¼Œé€šè¿‡åˆç†é…ç½®çº¿ç¨‹æ± ã€å¼‚å¸¸å¤„ç†å’Œç›‘æ§ï¼Œå¯ä»¥æ„å»ºé«˜æ€§èƒ½ã€é«˜å¯é çš„äº‹ä»¶é©±åŠ¨ç³»ç»Ÿã€‚

---

**ğŸ”— ç›¸å…³æ–‡æ¡£**
- å‰ç½®å­¦ä¹ ï¼š[Springäº‹ä»¶åŸºç¡€]ã€[ApplicationContextå®¹å™¨]
- é…å¥—å­¦ä¹ ï¼š[äº‹ä»¶ç›‘å¬å™¨è¯¦è§£]ã€[äº‹ä»¶å‘å¸ƒæœºåˆ¶]
- è¿›é˜¶å­¦ä¹ ï¼š[äº‹åŠ¡äº‹ä»¶å¤„ç†]ã€[åˆ†å¸ƒå¼äº‹ä»¶]

**ğŸ“ å®è·µå»ºè®®**
1. å…ˆç”¨é»˜è®¤é…ç½®ç†è§£æœºåˆ¶
2. æ ¹æ®ä¸šåŠ¡éœ€æ±‚è‡ªå®šä¹‰é…ç½®
3. æ·»åŠ ç›‘æ§è§‚å¯Ÿè¿è¡ŒçŠ¶æ€
4. åŸºäºæ•°æ®æŒç»­ä¼˜åŒ–è°ƒæ•´