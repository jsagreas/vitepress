---
title: 6ã€SpELå®‰å…¨ä¸æ€§èƒ½
---
## ğŸ“š ç›®å½•

1. [SpELå®‰å…¨åŸºç¡€](#1-spelå®‰å…¨åŸºç¡€)
2. [ç©ºå®‰å…¨æ“ä½œç¬¦?.](#2-ç©ºå®‰å…¨æ“ä½œç¬¦)
3. [ç¦ç”¨å±é™©æ“ä½œ](#3-ç¦ç”¨å±é™©æ“ä½œ)
4. [è¡¨è¾¾å¼è¾¹ç•Œæ§åˆ¶](#4-è¡¨è¾¾å¼è¾¹ç•Œæ§åˆ¶)
5. [æœ€å°æƒé™åŸåˆ™](#5-æœ€å°æƒé™åŸåˆ™)
6. [ç¼“å­˜è§£æå™¨ä¼˜åŒ–](#6-ç¼“å­˜è§£æå™¨ä¼˜åŒ–)
7. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#7-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ SpELå®‰å…¨åŸºç¡€


### 1.1 ä¸ºä»€ä¹ˆè¦å…³æ³¨SpELå®‰å…¨


**SpELæ˜¯ä»€ä¹ˆ**ï¼šSpring Expression Languageï¼ˆSpringè¡¨è¾¾å¼è¯­è¨€ï¼‰ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€è®¡ç®—å€¼ã€è°ƒç”¨æ–¹æ³•ã€‚

**å®‰å…¨é£é™©æ¥æº**ï¼š
```
ç”¨æˆ·è¾“å…¥ â†’ SpELè¡¨è¾¾å¼ â†’ æ‰§è¡Œä»£ç 
         â†“
    å¦‚æœä¸åŠ æ§åˆ¶ï¼Œå¯èƒ½å¯¼è‡´ï¼š
    â€¢ æ‰§è¡Œæ¶æ„ä»£ç 
    â€¢ è®¿é—®æ•æ„Ÿæ•°æ®
    â€¢ ç³»ç»Ÿèµ„æºè¢«æ»¥ç”¨
```

**çœŸå®åœºæ™¯ä¸¾ä¾‹**ï¼š
```java
// âŒ å±é™©ï¼ç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥
String userInput = request.getParameter("expression"); 
Object result = parser.parseExpression(userInput).getValue();
// ç”¨æˆ·è¾“å…¥: T(java.lang.Runtime).getRuntime().exec("rm -rf /")
// åæœï¼šç³»ç»Ÿæ–‡ä»¶è¢«åˆ é™¤ï¼
```

### 1.2 SpELå®‰å…¨çš„æ ¸å¿ƒæ€è·¯


**ä¸‰å±‚é˜²æŠ¤ä½“ç³»**ï¼š
```
ç¬¬ä¸€å±‚ï¼šè¾“å…¥éªŒè¯ â†’ é™åˆ¶ç”¨æˆ·èƒ½è¾“å…¥ä»€ä¹ˆ
   â†“
ç¬¬äºŒå±‚ï¼šåŠŸèƒ½é™åˆ¶ â†’ é™åˆ¶SpELèƒ½åšä»€ä¹ˆ  
   â†“
ç¬¬ä¸‰å±‚ï¼šæƒé™æ§åˆ¶ â†’ é™åˆ¶SpELèƒ½è®¿é—®ä»€ä¹ˆ
```

**å®‰å…¨åŸåˆ™**ï¼š
- âœ… **æ°¸è¿œä¸è¦ä¿¡ä»»ç”¨æˆ·è¾“å…¥**
- âœ… **æœ€å°æƒé™**ï¼šåªå¼€æ”¾å¿…éœ€çš„åŠŸèƒ½
- âœ… **ç™½åå•ä¼˜äºé»‘åå•**
- âœ… **é»˜è®¤æ‹’ç»**ï¼šä¸ç¡®å®šçš„å°±ç¦æ­¢

---

## 2. âš¡ ç©ºå®‰å…¨æ“ä½œç¬¦?.


### 2.1 ä»€ä¹ˆæ˜¯ç©ºå®‰å…¨æ“ä½œç¬¦


**ç©ºå®‰å…¨æ“ä½œç¬¦`?.`**ï¼šä¹Ÿå«å®‰å…¨å¯¼èˆªæ“ä½œç¬¦ï¼Œç”¨äºé¿å…ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚

**å·¥ä½œåŸç†**ï¼š
```
å¯¹è±¡?.å±æ€§
   â†“
å¦‚æœå¯¹è±¡æ˜¯null â†’ ç›´æ¥è¿”å›null
å¦‚æœå¯¹è±¡ä¸æ˜¯null â†’ æ­£å¸¸è®¿é—®å±æ€§
```

### 2.2 ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜


**æ²¡æœ‰ç©ºå®‰å…¨æ—¶çš„éº»çƒ¦**ï¼š
```java
// ä¼ ç»ŸJavaä»£ç ï¼ˆç¹çï¼‰
User user = getUser();
String city = null;

if (user != null) {
    Address address = user.getAddress();
    if (address != null) {
        city = address.getCity();
    }
}

// éœ€è¦å¤šå±‚ifåˆ¤æ–­ï¼Œä»£ç å†—é•¿
```

**SpELä¼ ç»Ÿå†™æ³•çš„é—®é¢˜**ï¼š
```java
// âŒ å®¹æ˜“æŠ¥é”™
String expr = "#user.address.city";
// å¦‚æœuserä¸ºnull â†’ NullPointerException
// å¦‚æœaddressä¸ºnull â†’ NullPointerException
```

### 2.3 ç©ºå®‰å…¨æ“ä½œç¬¦çš„ä½¿ç”¨


**åŸºç¡€ç”¨æ³•**ï¼š
```java
// âœ… ä½¿ç”¨ç©ºå®‰å…¨æ“ä½œç¬¦
String expr = "#user?.address?.city";

// æ‰§è¡Œè¿‡ç¨‹ï¼š
// 1. useræ˜¯null â†’ ç›´æ¥è¿”å›nullï¼Œä¸å†å¾€ä¸‹æ‰§è¡Œ
// 2. userä¸æ˜¯null â†’ ç»§ç»­æ£€æŸ¥address
// 3. addressæ˜¯null â†’ è¿”å›null
// 4. addressä¸æ˜¯null â†’ è¿”å›city
```

**å®é™…åº”ç”¨åœºæ™¯**ï¼š

```java
// åœºæ™¯1ï¼šè·å–ç”¨æˆ·ä¿¡æ¯
@Value("#{@userService.getCurrentUser()?.name ?: 'æ¸¸å®¢'}")
private String userName;  // å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤º"æ¸¸å®¢"

// åœºæ™¯2ï¼šå¤„ç†é…ç½®é¡¹
@Value("#{@config?.database?.host ?: 'localhost'}")
private String dbHost;  // é…ç½®ç¼ºå¤±æ—¶ä½¿ç”¨é»˜è®¤å€¼

// åœºæ™¯3ï¼šé›†åˆå…ƒç´ è®¿é—®
@Value("#{@orderList?.get(0)?.totalAmount ?: 0}")
private BigDecimal amount;  // è®¢å•åˆ—è¡¨ä¸ºç©ºæ—¶è¿”å›0
```

### 2.4 ç©ºå®‰å…¨æ“ä½œç¬¦çš„ä¼˜åŠ¿


| ç‰¹æ€§ | ä¼ ç»Ÿæ–¹å¼ | ç©ºå®‰å…¨æ“ä½œç¬¦ |
|------|---------|------------|
| **ä»£ç é‡** | `éœ€è¦å¤šå±‚ifåˆ¤æ–­` | `ä¸€è¡Œè§£å†³` |
| **å¯è¯»æ€§** | `åµŒå¥—æ·±ï¼Œéš¾ç†è§£` | `æ¸…æ™°ç›´è§‚` |
| **å®‰å…¨æ€§** | `å®¹æ˜“é—æ¼æ£€æŸ¥` | `è‡ªåŠ¨å¤„ç†null` |
| **ç»´æŠ¤æ€§** | `ä¿®æ”¹éº»çƒ¦` | `æ˜“äºç»´æŠ¤` |

**è®°å¿†æŠ€å·§**ï¼š
```
?.  â†’  é—®å·è¡¨ç¤º"å¯èƒ½ä¸ºnull"
       ç‚¹è¡¨ç¤º"ç»§ç»­è®¿é—®"
       åˆèµ·æ¥å°±æ˜¯"å¦‚æœä¸æ˜¯nullå°±ç»§ç»­è®¿é—®"
```

---

## 3. ğŸš« ç¦ç”¨å±é™©æ“ä½œ


### 3.1 ä»€ä¹ˆæ˜¯å±é™©æ“ä½œ


**SpELä¸­çš„å±é™©æ“ä½œ**ï¼šå¯èƒ½è¢«æ¶æ„åˆ©ç”¨çš„åŠŸèƒ½ã€‚

**å¸¸è§å±é™©æ“ä½œç±»å‹**ï¼š
```
ç±»å‹                    é£é™©è¯´æ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T()ç±»å‹å¼•ç”¨           â†’ å¯ä»¥è°ƒç”¨ä»»æ„Javaç±»
#thisè®¿é—®            â†’ å¯ä»¥è®¿é—®å½“å‰å¯¹è±¡
constructorè°ƒç”¨      â†’ å¯ä»¥åˆ›å»ºä»»æ„å¯¹è±¡
åå°„æ“ä½œ             â†’ å¯ä»¥ç»•è¿‡è®¿é—®æ§åˆ¶
æ–‡ä»¶/ç½‘ç»œæ“ä½œ        â†’ å¯ä»¥è¯»å†™æ–‡ä»¶ã€å‘é€è¯·æ±‚
```

### 3.2 å±é™©æ“ä½œçš„å®é™…æ¡ˆä¾‹


**æ¡ˆä¾‹1ï¼šä»»æ„ä»£ç æ‰§è¡Œ**
```java
// âŒ æåº¦å±é™©çš„è¡¨è¾¾å¼
String malicious = "T(java.lang.Runtime).getRuntime().exec('calc')";
// æ‰§è¡Œç»“æœï¼šæ‰“å¼€è®¡ç®—å™¨ç¨‹åº
// åœ¨æœåŠ¡å™¨ä¸Šå¯èƒ½æ‰§è¡Œæ›´å±é™©çš„å‘½ä»¤ï¼
```

**æ¡ˆä¾‹2ï¼šæ•æ„Ÿä¿¡æ¯æ³„éœ²**
```java
// âŒ è·å–ç³»ç»Ÿæ•æ„Ÿä¿¡æ¯
String expr = "T(System).getenv()";  // è·å–æ‰€æœ‰ç¯å¢ƒå˜é‡
// å¯èƒ½åŒ…å«æ•°æ®åº“å¯†ç ã€APIå¯†é’¥ç­‰
```

**æ¡ˆä¾‹3ï¼šèµ„æºè€—å°½æ”»å‡»**
```java
// âŒ æ­»å¾ªç¯æ”»å‡»
String expr = "T(java.lang.Thread).sleep(9999999)";
// é˜»å¡çº¿ç¨‹ï¼Œæ¶ˆè€—ç³»ç»Ÿèµ„æº
```

### 3.3 å¦‚ä½•ç¦ç”¨å±é™©æ“ä½œ


**æ–¹æ³•1ï¼šä½¿ç”¨SimpleEvaluationContextï¼ˆæ¨èï¼‰**

```java
// âœ… åˆ›å»ºå—é™çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ
SimpleEvaluationContext context = SimpleEvaluationContext
    .forReadOnlyDataBinding()  // åªè¯»æ•°æ®ç»‘å®š
    .build();

// è¿™ä¸ªç¯å¢ƒä¸‹ï¼š
// âŒ ä¸èƒ½ä½¿ç”¨ T() å¼•ç”¨ç±»
// âŒ ä¸èƒ½è°ƒç”¨æ„é€ å™¨
// âŒ ä¸èƒ½ä½¿ç”¨åå°„
// âœ… åªèƒ½è®¿é—®å±æ€§å’Œè°ƒç”¨ç®€å•æ–¹æ³•
```

**æ–¹æ³•2ï¼šé…ç½®ç™½åå•**

```java
// âœ… åªå…è®¸ç‰¹å®šçš„ç±»å’Œæ–¹æ³•
SimpleEvaluationContext context = SimpleEvaluationContext
    .forPropertyAccessors(new DataBindingPropertyAccessor())
    .withMethodResolvers(
        // åªå…è®¸è°ƒç”¨è¿™äº›æ–¹æ³•
        new MethodResolver() {
            @Override
            public MethodExecutor resolve(
                EvaluationContext context,
                Object target,
                String name,
                List<TypeDescriptor> args) {
                
                // ç™½åå•æ£€æŸ¥
                if ("substring".equals(name) || 
                    "length".equals(name) ||
                    "toLowerCase".equals(name)) {
                    return new ReflectiveMethodExecutor(...);
                }
                return null;  // å…¶ä»–æ–¹æ³•ä¸€å¾‹æ‹’ç»
            }
        }
    )
    .build();
```

**æ–¹æ³•3ï¼šç¦ç”¨ç±»å‹å¼•ç”¨**

```java
// âœ… å®Œå…¨ç¦æ­¢T()æ“ä½œ
StandardEvaluationContext context = new StandardEvaluationContext();
context.setTypeLocator(new TypeLocator() {
    @Override
    public Class<?> findType(String typeName) {
        throw new SpelEvaluationException(
            "ç±»å‹å¼•ç”¨å·²è¢«ç¦ç”¨"
        );
    }
});
```

### 3.4 å®‰å…¨é…ç½®å®æˆ˜


**å®é™…é¡¹ç›®ä¸­çš„å®‰å…¨é…ç½®**ï¼š

```java
@Configuration
public class SpELSecurityConfig {
    
    /**
     * åˆ›å»ºå®‰å…¨çš„SpELè§£æå™¨
     */
    @Bean
    public ExpressionParser secureParser() {
        return new SpelExpressionParser();
    }
    
    /**
     * åˆ›å»ºå—é™çš„æ±‚å€¼ç¯å¢ƒ
     */
    @Bean
    public EvaluationContext secureContext() {
        return SimpleEvaluationContext
            .forReadOnlyDataBinding()
            .withRootObject(createSafeRoot())
            .build();
    }
    
    /**
     * åˆ›å»ºå®‰å…¨çš„æ ¹å¯¹è±¡ï¼ˆåªæš´éœ²å®‰å…¨çš„æ–¹æ³•ï¼‰
     */
    private Object createSafeRoot() {
        return new Object() {
            // åªæä¾›å®‰å…¨çš„å·¥å…·æ–¹æ³•
            public String format(String text) {
                return text != null ? text.trim() : "";
            }
            
            public boolean isEmpty(String text) {
                return text == null || text.isEmpty();
            }
        };
    }
}
```

**å®‰å…¨æ£€æŸ¥æµç¨‹å›¾**ï¼š
```
ç”¨æˆ·è¾“å…¥è¡¨è¾¾å¼
    â†“
è¯­æ³•æ£€æŸ¥ï¼ˆæ˜¯å¦åŒ…å«å±é™©å­—ç¬¦ï¼Ÿï¼‰
    â†“ [é€šè¿‡]
åŠŸèƒ½æ£€æŸ¥ï¼ˆæ˜¯å¦ä½¿ç”¨ç¦ç”¨åŠŸèƒ½ï¼Ÿï¼‰
    â†“ [é€šè¿‡]
æƒé™æ£€æŸ¥ï¼ˆæ˜¯å¦æœ‰æ‰§è¡Œæƒé™ï¼Ÿï¼‰
    â†“ [é€šè¿‡]
åœ¨å—é™ç¯å¢ƒä¸­æ‰§è¡Œ
    â†“
è¿”å›ç»“æœ
```

---

## 4. ğŸ“Š è¡¨è¾¾å¼è¾¹ç•Œæ§åˆ¶


### 4.1 ä»€ä¹ˆæ˜¯è¡¨è¾¾å¼è¾¹ç•Œ


**è¡¨è¾¾å¼è¾¹ç•Œ**ï¼šé™åˆ¶SpELè¡¨è¾¾å¼èƒ½åšä»€ä¹ˆã€è®¿é—®ä»€ä¹ˆçš„"å›´æ "ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦è¾¹ç•Œæ§åˆ¶**ï¼š
```
æ²¡æœ‰è¾¹ç•Œçš„SpELï¼š
ç”¨æˆ· â†’ è¾“å…¥ä»»æ„è¡¨è¾¾å¼ â†’ è®¿é—®æ‰€æœ‰æ•°æ®å’Œæ–¹æ³•
   â†“
   é£é™©ï¼šæ•°æ®æ³„éœ²ã€ç³»ç»Ÿç ´å

æœ‰è¾¹ç•Œçš„SpELï¼š
ç”¨æˆ· â†’ è¾“å…¥è¡¨è¾¾å¼ â†’ è¾¹ç•Œæ£€æŸ¥ â†’ åªè®¿é—®å…è®¸çš„å†…å®¹
   â†“
   å®‰å…¨ï¼šå¯æ§èŒƒå›´å†…ä½¿ç”¨
```

### 4.2 è¾¹ç•Œæ§åˆ¶çš„ä¸‰ä¸ªç»´åº¦


**ç»´åº¦1ï¼šè¯­æ³•è¾¹ç•Œ**
```
é™åˆ¶èƒ½å†™ä»€ä¹ˆæ ·çš„è¡¨è¾¾å¼

å…è®¸çš„ï¼š
âœ… #user.name              // ç®€å•å±æ€§è®¿é—®
âœ… #price * 0.9            // åŸºæœ¬è¿ç®—
âœ… #list.size()            // å®‰å…¨æ–¹æ³•è°ƒç”¨

ç¦æ­¢çš„ï¼š
âŒ T(Runtime)...           // ç±»å‹å¼•ç”¨
âŒ new java.io.File()      // å¯¹è±¡åˆ›å»º  
âŒ #root.getClass()        // åå°„æ“ä½œ
```

**ç»´åº¦2ï¼šæ•°æ®è¾¹ç•Œ**
```
é™åˆ¶èƒ½è®¿é—®å“ªäº›æ•°æ®

å¯è®¿é—®èŒƒå›´ç¤ºæ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨æ•°æ®              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç”¨æˆ·å¯è§æ•°æ®    â”‚   â”‚  â† SpELåªèƒ½è®¿é—®è¿™é‡Œ
â”‚  â”‚  (name, age)    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  æ•æ„Ÿæ•°æ®(password)     â”‚  â† ä¸èƒ½è®¿é—®
â”‚  ç³»ç»Ÿæ•°æ®(config)       â”‚  â† ä¸èƒ½è®¿é—®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç»´åº¦3ï¼šæ‰§è¡Œè¾¹ç•Œ**
```
é™åˆ¶è¡¨è¾¾å¼çš„æ‰§è¡Œæ—¶é—´å’Œèµ„æº

æ—¶é—´é™åˆ¶ï¼šæœ€å¤šæ‰§è¡Œ100ms
å†…å­˜é™åˆ¶ï¼šæœ€å¤šä½¿ç”¨10MB
æ·±åº¦é™åˆ¶ï¼šæœ€å¤šåµŒå¥—5å±‚
```

### 4.3 å®ç°è¾¹ç•Œæ§åˆ¶


**æ–¹æ³•1ï¼šè‡ªå®šä¹‰è¡¨è¾¾å¼éªŒè¯å™¨**

```java
public class ExpressionValidator {
    
    // é»‘åå•ï¼šç¦æ­¢çš„å…³é”®å­—
    private static final List<String> FORBIDDEN_KEYWORDS = Arrays.asList(
        "T(", "new ", "class", "getClass", 
        "Runtime", "exec", "ProcessBuilder"
    );
    
    /**
     * éªŒè¯è¡¨è¾¾å¼æ˜¯å¦å®‰å…¨
     */
    public static void validate(String expression) {
        if (expression == null) {
            throw new IllegalArgumentException("è¡¨è¾¾å¼ä¸èƒ½ä¸ºç©º");
        }
        
        // é•¿åº¦é™åˆ¶
        if (expression.length() > 200) {
            throw new IllegalArgumentException("è¡¨è¾¾å¼é•¿åº¦è¶…é™");
        }
        
        // å…³é”®å­—æ£€æŸ¥
        for (String keyword : FORBIDDEN_KEYWORDS) {
            if (expression.contains(keyword)) {
                throw new SecurityException(
                    "è¡¨è¾¾å¼åŒ…å«ç¦ç”¨å…³é”®å­—: " + keyword
                );
            }
        }
        
        // åµŒå¥—æ·±åº¦æ£€æŸ¥
        int depth = countNestingDepth(expression);
        if (depth > 5) {
            throw new IllegalArgumentException("è¡¨è¾¾å¼åµŒå¥—è¿‡æ·±");
        }
    }
    
    // è®¡ç®—åµŒå¥—æ·±åº¦
    private static int countNestingDepth(String expr) {
        int maxDepth = 0;
        int currentDepth = 0;
        
        for (char c : expr.toCharArray()) {
            if (c == '(' || c == '[' || c == '{') {
                currentDepth++;
                maxDepth = Math.max(maxDepth, currentDepth);
            } else if (c == ')' || c == ']' || c == '}') {
                currentDepth--;
            }
        }
        
        return maxDepth;
    }
}
```

**æ–¹æ³•2ï¼šé™åˆ¶è®¿é—®èŒƒå›´**

```java
public class BoundedEvaluationContext extends StandardEvaluationContext {
    
    // å®šä¹‰å¯è®¿é—®çš„å¯¹è±¡è¾¹ç•Œ
    private final Set<String> allowedBeans;
    
    public BoundedEvaluationContext(Set<String> allowedBeans) {
        this.allowedBeans = allowedBeans;
    }
    
    @Override
    public Object lookupVariable(String name) {
        // åªå…è®¸è®¿é—®ç™½åå•ä¸­çš„å˜é‡
        if (!allowedBeans.contains(name)) {
            throw new SecurityException(
                "ä¸å…è®¸è®¿é—®å˜é‡: " + name
            );
        }
        return super.lookupVariable(name);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
Set<String> allowed = Set.of("user", "order", "product");
EvaluationContext context = new BoundedEvaluationContext(allowed);

// âœ… å¯ä»¥è®¿é—®
context.setVariable("user", currentUser);
String expr1 = "#user.name";  // OK

// âŒ ä¸èƒ½è®¿é—®
String expr2 = "#systemConfig.password";  // æŠ›å‡ºSecurityException
```

**æ–¹æ³•3ï¼šæ‰§è¡Œæ—¶é—´é™åˆ¶**

```java
public class TimeLimitedEvaluator {
    
    /**
     * å¸¦è¶…æ—¶æ§åˆ¶çš„è¡¨è¾¾å¼æ±‚å€¼
     */
    public static Object evaluateWithTimeout(
            Expression expression,
            EvaluationContext context,
            long timeoutMs) {
        
        ExecutorService executor = Executors.newSingleThreadExecutor();
        
        try {
            Future<Object> future = executor.submit(() -> 
                expression.getValue(context)
            );
            
            // ç­‰å¾…ç»“æœï¼Œæœ€å¤šç­‰å¾…æŒ‡å®šæ—¶é—´
            return future.get(timeoutMs, TimeUnit.MILLISECONDS);
            
        } catch (TimeoutException e) {
            throw new SpelEvaluationException(
                "è¡¨è¾¾å¼æ‰§è¡Œè¶…æ—¶ï¼ˆé™åˆ¶" + timeoutMs + "msï¼‰"
            );
        } finally {
            executor.shutdownNow();
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
Expression expr = parser.parseExpression("#user.orders.size()");
Object result = TimeLimitedEvaluator.evaluateWithTimeout(
    expr, context, 100  // æœ€å¤šæ‰§è¡Œ100ms
);
```

### 4.4 è¾¹ç•Œæ§åˆ¶æœ€ä½³å®è·µ


**å®æˆ˜é…ç½®æ¸…å•**ï¼š

| è¾¹ç•Œç±»å‹ | æ¨èé…ç½® | è¯´æ˜ |
|---------|---------|------|
| **è¯­æ³•è¾¹ç•Œ** | `SimpleEvaluationContext` | `ç¦ç”¨å±é™©è¯­æ³•` |
| **é•¿åº¦é™åˆ¶** | `â‰¤ 200å­—ç¬¦` | `é˜²æ­¢å¤æ‚æ”»å‡»` |
| **åµŒå¥—æ·±åº¦** | `â‰¤ 5å±‚` | `é˜²æ­¢æ ˆæº¢å‡º` |
| **æ‰§è¡Œæ—¶é—´** | `â‰¤ 100ms` | `é˜²æ­¢èµ„æºè€—å°½` |
| **å˜é‡è®¿é—®** | `ç™½åå•æœºåˆ¶` | `åªè®¿é—®æ˜ç¡®å…è®¸çš„` |

---

## 5. ğŸ›¡ï¸ æœ€å°æƒé™åŸåˆ™


### 5.1 ä»€ä¹ˆæ˜¯æœ€å°æƒé™åŸåˆ™


**æœ€å°æƒé™åŸåˆ™ï¼ˆPrinciple of Least Privilegeï¼‰**ï¼šåªç»™äºˆå®Œæˆä»»åŠ¡æ‰€å¿…éœ€çš„æœ€å°æƒé™ï¼Œä¸å¤šç»™ä¸€ç‚¹ã€‚

**é€šä¿—ç†è§£**ï¼š
```
å°±åƒå¼€è½¦ï¼š
âŒ ç»™ä½ æ•´ä¸ªè½¦é’¥åŒ™åº— â†’ æƒé™å¤ªå¤§ï¼Œå¯ä»¥æ‹¿èµ°æ‰€æœ‰è½¦
âœ… åªç»™ä½ è‡ªå·±è½¦çš„é’¥åŒ™ â†’ åˆšåˆšå¥½ï¼Œåªèƒ½å¼€è‡ªå·±çš„è½¦

SpELä¸­ï¼š
âŒ èƒ½è®¿é—®æ‰€æœ‰Beanå’Œæ–¹æ³• â†’ æƒé™å¤ªå¤§ï¼Œå±é™©
âœ… åªèƒ½è®¿é—®å½“å‰åŠŸèƒ½éœ€è¦çš„æ•°æ® â†’ å®‰å…¨å¯æ§
```

### 5.2 ä¸ºä»€ä¹ˆéœ€è¦æœ€å°æƒé™


**å®‰å…¨é£é™©ç¤ºæ„**ï¼š
```
æƒé™è¿‡å¤§çš„åæœï¼š

å…¨éƒ¨æƒé™
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… éœ€è¦çš„åŠŸèƒ½        â”‚
â”‚ âŒ ä¸éœ€è¦ä½†èƒ½è®¿é—®çš„   â”‚ â† è¿™äº›éƒ½æ˜¯å®‰å…¨éšæ‚£
â”‚ âŒ æ•æ„Ÿæ•°æ®          â”‚
â”‚ âŒ ç³»ç»Ÿé…ç½®          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®é™…æ¡ˆä¾‹**ï¼š
```java
// âŒ æƒé™è¿‡å¤§ï¼ˆå±é™©ï¼‰
@Value("#{@applicationContext}")  
private ApplicationContext ctx;
// èƒ½è®¿é—®æ•´ä¸ªSpringå®¹å™¨ï¼Œå¯ä»¥è·å–ä»»ä½•Beanï¼ŒåŒ…æ‹¬æ•æ„Ÿé…ç½®

// âœ… æœ€å°æƒé™ï¼ˆå®‰å…¨ï¼‰
@Value("#{@userService.getCurrentUsername()}")
private String username;
// åªèƒ½è·å–å½“å‰ç”¨æˆ·åï¼Œæ— æ³•è®¿é—®å…¶ä»–æ•°æ®
```

### 5.3 å®ç°æœ€å°æƒé™çš„æ–¹æ³•


**æ–¹æ³•1ï¼šä¸“ç”¨ä¸Šä¸‹æ–‡å¯¹è±¡**

```java
/**
 * ä¸ºç‰¹å®šåŠŸèƒ½åˆ›å»ºä¸“ç”¨ä¸Šä¸‹æ–‡
 */
public class OrderExpressionContext {
    
    private final Order currentOrder;
    
    // åªæš´éœ²è®¢å•ç›¸å…³çš„å®‰å…¨æ–¹æ³•
    public BigDecimal getTotalAmount() {
        return currentOrder.getTotalAmount();
    }
    
    public String getOrderStatus() {
        return currentOrder.getStatus();
    }
    
    public int getItemCount() {
        return currentOrder.getItems().size();
    }
    
    // ä¸æš´éœ²æ•æ„Ÿä¿¡æ¯
    // âŒ æ²¡æœ‰ getUserPassword()
    // âŒ æ²¡æœ‰ getPaymentDetails()
}

// ä½¿ç”¨æ—¶åªèƒ½è®¿é—®æš´éœ²çš„æ–¹æ³•
StandardEvaluationContext context = new StandardEvaluationContext();
context.setRootObject(new OrderExpressionContext(order));

String expr = "totalAmount * 0.9";  // âœ… å¯ä»¥è®¿é—®
String bad = "userPassword";         // âŒ æ— æ³•è®¿é—®
```

**æ–¹æ³•2ï¼šæƒé™åˆ†çº§è®¾è®¡**

```java
/**
 * æ ¹æ®ç”¨æˆ·è§’è‰²æä¾›ä¸åŒæƒé™
 */
public class RoleBasedEvaluationContext {
    
    public static EvaluationContext createContext(User user) {
        SimpleEvaluationContext.Builder builder = 
            SimpleEvaluationContext.forReadOnlyDataBinding();
        
        // æ‰€æœ‰ç”¨æˆ·çš„åŸºç¡€æƒé™
        builder.withRootObject(createBasicRoot());
        
        // æ ¹æ®è§’è‰²æ·»åŠ é¢å¤–æƒé™
        if (user.hasRole("ADMIN")) {
            builder.withInstanceMethods();  // ç®¡ç†å‘˜å¯ä»¥è°ƒç”¨æ–¹æ³•
        }
        
        if (user.hasRole("ANALYST")) {
            // åˆ†æå¸ˆå¯ä»¥è®¿é—®ç»Ÿè®¡åŠŸèƒ½
            builder.withMethodResolvers(new StatisticsMethodResolver());
        }
        
        return builder.build();
    }
}

// æ™®é€šç”¨æˆ·åªèƒ½è¯»æ•°æ®
EvaluationContext userCtx = RoleBasedEvaluationContext
    .createContext(normalUser);

// ç®¡ç†å‘˜æœ‰æ›´å¤šæƒé™
EvaluationContext adminCtx = RoleBasedEvaluationContext
    .createContext(adminUser);
```

**æ–¹æ³•3ï¼šåŠŸèƒ½éš”ç¦»**

```java
/**
 * ä¸åŒåŠŸèƒ½æ¨¡å—ä½¿ç”¨ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡
 */
public class ModuleIsolatedContext {
    
    // ç”¨æˆ·æ¨¡å—ï¼šåªèƒ½è®¿é—®ç”¨æˆ·ä¿¡æ¯
    public static EvaluationContext forUserModule(User user) {
        Map<String, Object> variables = new HashMap<>();
        variables.put("user", new UserDTO(user));  // åªæš´éœ²DTO
        // ä¸æš´éœ²å®Œæ•´çš„Userå®ä½“
        
        StandardEvaluationContext context = new StandardEvaluationContext();
        context.setVariables(variables);
        return context;
    }
    
    // è®¢å•æ¨¡å—ï¼šåªèƒ½è®¿é—®è®¢å•ä¿¡æ¯
    public static EvaluationContext forOrderModule(Order order) {
        Map<String, Object> variables = new HashMap<>();
        variables.put("order", new OrderDTO(order));
        
        StandardEvaluationContext context = new StandardEvaluationContext();
        context.setVariables(variables);
        return context;
    }
}
```

### 5.4 æœ€å°æƒé™å®æˆ˜æ£€æŸ¥æ¸…å•


**æƒé™å®¡æŸ¥æ­¥éª¤**ï¼š
```
æ­¥éª¤1ï¼šæ˜ç¡®éœ€æ±‚
      â†“
   è¿™ä¸ªåŠŸèƒ½åˆ°åº•éœ€è¦è®¿é—®ä»€ä¹ˆï¼Ÿ
      â†“
æ­¥éª¤2ï¼šè®¾è®¡æƒé™
      â†“
   åªæš´éœ²å¿…éœ€çš„æ–¹æ³•å’Œå±æ€§
      â†“
æ­¥éª¤3ï¼šéš”ç¦»æ•æ„Ÿä¿¡æ¯
      â†“
   ç¡®ä¿æ•æ„Ÿæ•°æ®ä¸å¯è®¿é—®
      â†“
æ­¥éª¤4ï¼šæµ‹è¯•éªŒè¯
      â†“
   å°è¯•è®¿é—®ä¸è¯¥è®¿é—®çš„æ•°æ®
```

**æƒé™è®¾è®¡å¯¹æ¯”è¡¨**ï¼š

| åœºæ™¯ | âŒ è¿‡åº¦æƒé™ | âœ… æœ€å°æƒé™ |
|------|-----------|-----------|
| **æ˜¾ç¤ºç”¨æˆ·å** | `æš´éœ²æ•´ä¸ªUserå¯¹è±¡` | `åªè¿”å›nameå­—ç¬¦ä¸²` |
| **è®¡ç®—æŠ˜æ‰£** | `èƒ½è®¿é—®æ‰€æœ‰å•†å“æ•°æ®` | `åªèƒ½è®¿é—®ä»·æ ¼å’ŒæŠ˜æ‰£ç‡` |
| **è®¢å•æŸ¥è¯¢** | `èƒ½ä¿®æ”¹è®¢å•çŠ¶æ€` | `åªè¯»è®¿é—®è®¢å•ä¿¡æ¯` |
| **æŠ¥è¡¨ç”Ÿæˆ** | `èƒ½æ‰§è¡Œä»»æ„SQL` | `åªèƒ½è°ƒç”¨é¢„å®šä¹‰æŸ¥è¯¢` |

---

## 6. ğŸš€ ç¼“å­˜è§£æå™¨ä¼˜åŒ–


### 6.1 ä»€ä¹ˆæ˜¯SpELç¼“å­˜è§£æå™¨


**SpELè¡¨è¾¾å¼çš„æ‰§è¡Œè¿‡ç¨‹**ï¼š
```
æ–‡æœ¬è¡¨è¾¾å¼ â†’ è§£æ â†’ ASTè¯­æ³•æ ‘ â†’ ç¼–è¯‘ â†’ æ‰§è¡Œ â†’ ç»“æœ
            â†‘
         è€—æ—¶çš„æ­¥éª¤ï¼
```

**ç¼“å­˜è§£æå™¨çš„ä½œç”¨**ï¼šæŠŠè§£æå¥½çš„ç»“æœå­˜èµ·æ¥ï¼Œä¸‹æ¬¡ç›´æ¥ç”¨ã€‚

**é€šä¿—ç±»æ¯”**ï¼š
```
æ²¡æœ‰ç¼“å­˜ï¼š
æ¯æ¬¡éƒ½è¦é‡æ–°è§£æ = æ¯æ¬¡åƒé¥­éƒ½è¦é‡æ–°åšèœ
   â†“
è´¹æ—¶è´¹åŠ›

æœ‰ç¼“å­˜ï¼š
è§£æä¸€æ¬¡ï¼Œé‡å¤ä½¿ç”¨ = åšä¸€æ¬¡èœï¼Œåˆ†å¤šæ¬¡åƒï¼ˆå‰©èœï¼‰
   â†“
å¿«é€Ÿé«˜æ•ˆ
```

### 6.2 ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜


**æ€§èƒ½å¯¹æ¯”**ï¼š
```
ä¸ä½¿ç”¨ç¼“å­˜ï¼š
è¯·æ±‚1ï¼šè§£æè¡¨è¾¾å¼(10ms) + æ‰§è¡Œ(1ms) = 11ms
è¯·æ±‚2ï¼šè§£æè¡¨è¾¾å¼(10ms) + æ‰§è¡Œ(1ms) = 11ms
è¯·æ±‚3ï¼šè§£æè¡¨è¾¾å¼(10ms) + æ‰§è¡Œ(1ms) = 11ms
æ€»è€—æ—¶ï¼š33ms

ä½¿ç”¨ç¼“å­˜ï¼š
è¯·æ±‚1ï¼šè§£æè¡¨è¾¾å¼(10ms) + æ‰§è¡Œ(1ms) = 11ms  â† ç¬¬ä¸€æ¬¡è§£æå¹¶ç¼“å­˜
è¯·æ±‚2ï¼šä»ç¼“å­˜è·å– + æ‰§è¡Œ(1ms) = 1ms       â† ç›´æ¥ç”¨ç¼“å­˜
è¯·æ±‚3ï¼šä»ç¼“å­˜è·å– + æ‰§è¡Œ(1ms) = 1ms       â† ç›´æ¥ç”¨ç¼“å­˜
æ€»è€—æ—¶ï¼š13msï¼ˆæå‡60%ï¼ï¼‰
```

### 6.3 å®ç°SpELç¼“å­˜


**æ–¹æ³•1ï¼šSpringå†…ç½®ç¼“å­˜**

```java
@Configuration
public class SpELCacheConfig {
    
    /**
     * é…ç½®å¸¦ç¼“å­˜çš„SpELè§£æå™¨
     */
    @Bean
    public ExpressionParser cachedParser() {
        // SpelExpressionParserå†…éƒ¨é»˜è®¤å°±æœ‰ç¼“å­˜
        SpelExpressionParser parser = new SpelExpressionParser();
        
        // é…ç½®è§£æå™¨ç¼“å­˜å¤§å°
        SpelParserConfiguration config = new SpelParserConfiguration(
            true,    // è‡ªåŠ¨åˆ›å»ºnullå¼•ç”¨çš„å¯¹è±¡
            true,    // è‡ªåŠ¨å¢é•¿é›†åˆ
            256      // ç¼“å­˜å®¹é‡ï¼šæœ€å¤šç¼“å­˜256ä¸ªè¡¨è¾¾å¼
        );
        
        return new SpelExpressionParser(config);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@Autowired
private ExpressionParser parser;

public void processOrders(List<Order> orders) {
    // è¿™ä¸ªè¡¨è¾¾å¼ä¼šè¢«ç¼“å­˜
    Expression expr = parser.parseExpression("totalAmount * 0.9");
    
    for (Order order : orders) {
        // ç¬¬ä¸€æ¬¡ï¼šè§£æ + æ‰§è¡Œ
        // åç»­ï¼šç›´æ¥ä»ç¼“å­˜è·å–å¹¶æ‰§è¡Œ
        BigDecimal discounted = expr.getValue(order, BigDecimal.class);
    }
}
```

**æ–¹æ³•2ï¼šæ‰‹åŠ¨ç®¡ç†ç¼“å­˜**

```java
public class ExpressionCacheManager {
    
    // ä½¿ç”¨Caffeineä½œä¸ºç¼“å­˜
    private final LoadingCache<String, Expression> cache;
    private final ExpressionParser parser;
    
    public ExpressionCacheManager(ExpressionParser parser) {
        this.parser = parser;
        this.cache = Caffeine.newBuilder()
            .maximumSize(500)              // æœ€å¤šç¼“å­˜500ä¸ª
            .expireAfterAccess(1, TimeUnit.HOURS)  // 1å°æ—¶æœªä½¿ç”¨åˆ™è¿‡æœŸ
            .recordStats()                 // è®°å½•ç»Ÿè®¡ä¿¡æ¯
            .build(key -> parser.parseExpression(key));
    }
    
    /**
     * è·å–è¡¨è¾¾å¼ï¼ˆå¸¦ç¼“å­˜ï¼‰
     */
    public Expression getExpression(String expressionString) {
        return cache.get(expressionString);
    }
    
    /**
     * è·å–ç¼“å­˜ç»Ÿè®¡
     */
    public CacheStats getStats() {
        return cache.stats();
    }
    
    /**
     * æ¸…ç©ºç¼“å­˜
     */
    public void clearCache() {
        cache.invalidateAll();
    }
}

// ä½¿ç”¨ç¤ºä¾‹
ExpressionCacheManager cacheManager = new ExpressionCacheManager(parser);

// ç¬¬ä¸€æ¬¡è®¿é—®ï¼šè§£æå¹¶ç¼“å­˜
Expression expr1 = cacheManager.getExpression("#user.name");

// ç¬¬äºŒæ¬¡è®¿é—®ï¼šç›´æ¥ä»ç¼“å­˜è·å–
Expression expr2 = cacheManager.getExpression("#user.name");

// æŸ¥çœ‹ç¼“å­˜æ•ˆæœ
CacheStats stats = cacheManager.getStats();
System.out.println("å‘½ä¸­ç‡: " + stats.hitRate());
```

**æ–¹æ³•3ï¼šé¢„ç¼–è¯‘å¸¸ç”¨è¡¨è¾¾å¼**

```java
@Component
public class PrecompiledExpressions {
    
    private final ExpressionParser parser = new SpelExpressionParser();
    
    // åœ¨åº”ç”¨å¯åŠ¨æ—¶é¢„ç¼–è¯‘å¸¸ç”¨è¡¨è¾¾å¼
    public final Expression DISCOUNT_EXPR = 
        parser.parseExpression("price * (1 - discountRate)");
    
    public final Expression FULL_NAME_EXPR = 
        parser.parseExpression("firstName + ' ' + lastName");
    
    public final Expression ORDER_TOTAL_EXPR = 
        parser.parseExpression("items.![price * quantity].sum()");
    
    /**
     * ä½¿ç”¨é¢„ç¼–è¯‘çš„è¡¨è¾¾å¼
     */
    public BigDecimal calculateDiscount(Product product) {
        return DISCOUNT_EXPR.getValue(product, BigDecimal.class);
    }
}

// ä¼˜åŠ¿ï¼š
// âœ… å¯åŠ¨æ—¶ç¼–è¯‘ä¸€æ¬¡ï¼Œè¿è¡Œæ—¶ç›´æ¥ç”¨
// âœ… ç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æœŸå°±èƒ½å‘ç°é”™è¯¯
// âœ… æ€§èƒ½æœ€ä½³ï¼Œé›¶è§£æå¼€é”€
```

### 6.4 ç¼“å­˜ç­–ç•¥é€‰æ‹©


**ä¸åŒåœºæ™¯çš„ç¼“å­˜ç­–ç•¥**ï¼š

| åœºæ™¯ | æ¨èç­–ç•¥ | åŸå›  |
|------|---------|------|
| **å›ºå®šè¡¨è¾¾å¼** | `é¢„ç¼–è¯‘` | `è¡¨è¾¾å¼ä¸å˜ï¼Œé¢„ç¼–è¯‘æœ€å¿«` |
| **æœ‰é™å˜åŒ–** | `æ‰‹åŠ¨ç¼“å­˜` | `å¯æ§çš„è¡¨è¾¾å¼é›†åˆ` |
| **åŠ¨æ€è¡¨è¾¾å¼** | `å†…ç½®ç¼“å­˜` | `è¡¨è¾¾å¼ä¸å¯é¢„æµ‹` |
| **ä¸€æ¬¡æ€§ä½¿ç”¨** | `ä¸ç¼“å­˜` | `ç¼“å­˜åè€Œæµªè´¹å†…å­˜` |

**ç¼“å­˜ç›‘æ§**ï¼š
```java
@Component
public class CacheMonitor {
    
    @Scheduled(fixedRate = 60000)  // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void monitorCache() {
        CacheStats stats = expressionCache.getStats();
        
        double hitRate = stats.hitRate();
        long hitCount = stats.hitCount();
        long missCount = stats.missCount();
        
        // å‘½ä¸­ç‡å¤ªä½ï¼Œè¯´æ˜ç¼“å­˜æ•ˆæœä¸å¥½
        if (hitRate < 0.5) {
            log.warn("SpELç¼“å­˜å‘½ä¸­ç‡è¿‡ä½: {}%", hitRate * 100);
        }
        
        log.info("SpELç¼“å­˜ç»Ÿè®¡ - å‘½ä¸­:{} æœªå‘½ä¸­:{} å‘½ä¸­ç‡:{}", 
            hitCount, missCount, hitRate);
    }
}
```

---

## 7. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 7.1 SpELæ€§èƒ½ä¼˜åŒ–å…¨æ™¯å›¾


**æ€§èƒ½ä¼˜åŒ–çš„å››ä¸ªå±‚æ¬¡**ï¼š
```
Layer 4: æ¶æ„å±‚ä¼˜åŒ– â†’ å‡å°‘SpELä½¿ç”¨åœºæ™¯
   â†“
Layer 3: ç¼“å­˜å±‚ä¼˜åŒ– â†’ ç¼“å­˜è§£æç»“æœ
   â†“
Layer 2: ç¼–è¯‘å±‚ä¼˜åŒ– â†’ ä½¿ç”¨ç¼–è¯‘æ¨¡å¼
   â†“
Layer 1: è¡¨è¾¾å¼å±‚ä¼˜åŒ– â†’ ç®€åŒ–è¡¨è¾¾å¼é€»è¾‘
```

### 7.2 è¡¨è¾¾å¼å±‚ä¼˜åŒ–


**æŠ€å·§1ï¼šç®€åŒ–è¡¨è¾¾å¼é€»è¾‘**

```java
// âŒ å¤æ‚è¡¨è¾¾å¼ï¼ˆæ…¢ï¼‰
String complex = "#orders.?[status == 'PAID'].![items].flatten()
                  .?[price > 100].![price * quantity].sum()";
// å¤šæ¬¡è¿‡æ»¤ã€å¤šæ¬¡è½¬æ¢ï¼Œæ€§èƒ½å·®

// âœ… ç®€åŒ–é€»è¾‘ï¼ˆå¿«ï¼‰
// æ–¹æ¡ˆ1ï¼šæ‹†åˆ†æˆå¤šæ­¥
List<Order> paidOrders = orders.stream()
    .filter(o -> "PAID".equals(o.getStatus()))
    .collect(Collectors.toList());

String simple = "#paidOrders.![totalAmount].sum()";

// æ–¹æ¡ˆ2ï¼šåœ¨Javaä»£ç ä¸­å¤„ç†
BigDecimal total = orders.stream()
    .filter(o -> "PAID".equals(o.getStatus()))
    .flatMap(o -> o.getItems().stream())
    .filter(i -> i.getPrice().compareTo(new BigDecimal(100)) > 0)
    .map(i -> i.getPrice().multiply(i.getQuantity()))
    .reduce(BigDecimal.ZERO, BigDecimal::add);
```

**æŠ€å·§2ï¼šé¿å…é‡å¤è®¡ç®—**

```java
// âŒ é‡å¤è®¡ç®—ï¼ˆä½æ•ˆï¼‰
@Value("#{#order.items.size() > 0 ? #order.items.size() : 0}")
private int itemCount;
// items.size()è¢«è°ƒç”¨äº†ä¸¤æ¬¡

// âœ… æå‰è®¡ç®—ï¼ˆé«˜æ•ˆï¼‰
@Value("#{#order.itemCount}")
private int itemCount;

// åœ¨Orderç±»ä¸­æ·»åŠ ç¼“å­˜å­—æ®µ
public class Order {
    private List<Item> items;
    private Integer itemCount;  // ç¼“å­˜è®¡ç®—ç»“æœ
    
    public Integer getItemCount() {
        if (itemCount == null) {
            itemCount = items != null ? items.size() : 0;
        }
        return itemCount;
    }
}
```

**æŠ€å·§3ï¼šä½¿ç”¨é«˜æ•ˆçš„æ“ä½œç¬¦**

```java
// âŒ ä½æ•ˆçš„é›†åˆæ“ä½œ
String inefficient = "#list.?[price > 100].size() > 0";
// éœ€è¦éå†æ•´ä¸ªé›†åˆ

// âœ… é«˜æ•ˆçš„çŸ­è·¯æ“ä½œ
String efficient = "#list.^[price > 100] != null";
// ^ è¡¨ç¤ºæ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…å°±è¿”å›ï¼Œä¸ç»§ç»­éå†

// æ“ä½œç¬¦æ€§èƒ½å¯¹æ¯”ï¼š
// .?[condition]  â†’ è¿‡æ»¤æ‰€æœ‰å…ƒç´ ï¼ˆæ…¢ï¼‰
// .^[condition]  â†’ æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…ï¼ˆå¿«ï¼‰
// .$[condition]  â†’ æ‰¾åˆ°æœ€åä¸€ä¸ªåŒ¹é…ï¼ˆæ…¢ï¼‰
```

### 7.3 ç¼–è¯‘å±‚ä¼˜åŒ–


**ç¼–è¯‘æ¨¡å¼çš„å¨åŠ›**ï¼š

```java
@Configuration
public class CompiledSpELConfig {
    
    /**
     * é…ç½®ç¼–è¯‘æ¨¡å¼çš„SpELè§£æå™¨
     */
    @Bean
    public SpelCompiler spelCompiler() {
        return SpelCompilerMode.IMMEDIATE;
    }
    
    @Bean
    public ExpressionParser compiledParser() {
        SpelParserConfiguration config = new SpelParserConfiguration(
            SpelCompilerMode.IMMEDIATE,  // ç«‹å³ç¼–è¯‘æ¨¡å¼
            null  // ä½¿ç”¨é»˜è®¤ç±»åŠ è½½å™¨
        );
        
        return new SpelExpressionParser(config);
    }
}

// ç¼–è¯‘æ¨¡å¼è¯´æ˜ï¼š
// OFF: ä¸ç¼–è¯‘ï¼ˆé»˜è®¤ï¼‰
// IMMEDIATE: ç«‹å³ç¼–è¯‘
// MIXED: æ··åˆæ¨¡å¼ï¼ˆè¡¨è¾¾å¼è¢«ä½¿ç”¨å¤šæ¬¡åæ‰ç¼–è¯‘ï¼‰
```

**æ€§èƒ½æå‡å¯¹æ¯”**ï¼š
```
åœºæ™¯ï¼šè®¡ç®—1000ä¸ªè®¢å•çš„æŠ˜æ‰£ä»·

è§£é‡Šæ‰§è¡Œæ¨¡å¼ï¼š
- æ¯æ¬¡éƒ½è§£é‡Šæ‰§è¡Œè¡¨è¾¾å¼
- è€—æ—¶ï¼š~500ms

ç¼–è¯‘æ‰§è¡Œæ¨¡å¼ï¼š
- ç¬¬ä¸€æ¬¡ç¼–è¯‘æˆå­—èŠ‚ç 
- åç»­ç›´æ¥æ‰§è¡Œå­—èŠ‚ç 
- è€—æ—¶ï¼š~50msï¼ˆæå‡10å€ï¼ï¼‰
```

### 7.4 ç¼“å­˜å±‚ä¼˜åŒ–


**å¤šçº§ç¼“å­˜ç­–ç•¥**ï¼š

```java
public class MultiLevelExpressionCache {
    
    // L1ç¼“å­˜ï¼šæœ¬åœ°å†…å­˜ï¼ˆæœ€å¿«ï¼‰
    private final Map<String, Expression> l1Cache = 
        new ConcurrentHashMap<>(256);
    
    // L2ç¼“å­˜ï¼šè¿›ç¨‹å†…ç¼“å­˜ï¼ˆå¿«ï¼‰
    private final LoadingCache<String, Expression> l2Cache;
    
    // L3ç¼“å­˜ï¼šåˆ†å¸ƒå¼ç¼“å­˜ï¼ˆæ…¢ï¼Œä½†å…±äº«ï¼‰
    @Autowired
    private RedisTemplate<String, Expression> redisCache;
    
    private final ExpressionParser parser;
    
    public MultiLevelExpressionCache(ExpressionParser parser) {
        this.parser = parser;
        this.l2Cache = Caffeine.newBuilder()
            .maximumSize(1000)
            .build(key -> parseExpression(key));
    }
    
    /**
     * å¤šçº§ç¼“å­˜æŸ¥æ‰¾
     */
    public Expression getExpression(String exprString) {
        // L1ç¼“å­˜æŸ¥æ‰¾
        Expression expr = l1Cache.get(exprString);
        if (expr != null) {
            return expr;
        }
        
        // L2ç¼“å­˜æŸ¥æ‰¾
        expr = l2Cache.get(exprString);
        if (expr != null) {
            l1Cache.put(exprString, expr);  // æ”¾å…¥L1
            return expr;
        }
        
        // L3ç¼“å­˜æŸ¥æ‰¾
        expr = redisCache.opsForValue().get("spel:" + exprString);
        if (expr != null) {
            l1Cache.put(exprString, expr);  // æ”¾å…¥L1
            l2Cache.put(exprString, expr);  // æ”¾å…¥L2
            return expr;
        }
        
        // æ‰€æœ‰ç¼“å­˜æœªå‘½ä¸­ï¼Œè§£æå¹¶å­˜å…¥æ‰€æœ‰å±‚çº§
        expr = parser.parseExpression(exprString);
        l1Cache.put(exprString, expr);
        l2Cache.put(exprString, expr);
        redisCache.opsForValue().set("spel:" + exprString, expr);
        
        return expr;
    }
}
```

### 7.5 æ¶æ„å±‚ä¼˜åŒ–


**å‡å°‘SpELä½¿ç”¨åœºæ™¯**ï¼š

```java
// âŒ è¿‡åº¦ä½¿ç”¨SpELï¼ˆæ€§èƒ½å·®ï¼‰
public class BadExample {
    
    @Value("#{#order.totalAmount * (1 - #order.discountRate)}")
    private BigDecimal finalPrice;
    
    @Value("#{#order.items.size()}")
    private int itemCount;
    
    @Value("#{#order.status == 'PAID' ? 'å·²æ”¯ä»˜' : 'æœªæ”¯ä»˜'}")
    private String statusText;
}

// âœ… åˆç†ä½¿ç”¨ï¼ˆæ€§èƒ½å¥½ï¼‰
public class GoodExample {
    
    // ç®€å•å€¼æ³¨å…¥ä¸éœ€è¦SpEL
    @Value("${app.default.discount:0.1}")
    private BigDecimal defaultDiscount;
    
    // å¤æ‚è®¡ç®—åœ¨Javaä»£ç ä¸­å®Œæˆ
    public BigDecimal getFinalPrice(Order order) {
        return order.getTotalAmount()
            .multiply(BigDecimal.ONE.subtract(order.getDiscountRate()));
    }
    
    // çŠ¶æ€æ˜ å°„ç”¨æšä¸¾
    public String getStatusText(Order order) {
        return OrderStatus.valueOf(order.getStatus()).getDisplayName();
    }
}
```

**æ€§èƒ½ä¼˜åŒ–å†³ç­–æ ‘**ï¼š
```
éœ€è¦åŠ¨æ€è¡¨è¾¾å¼ï¼Ÿ
   â†“ [å¦]
ç›´æ¥ç”¨Javaä»£ç 
   â†“ [æ˜¯]
è¡¨è¾¾å¼æ˜¯å¦å›ºå®šï¼Ÿ
   â†“ [æ˜¯]
ä½¿ç”¨é¢„ç¼–è¯‘
   â†“ [å¦]
è¡¨è¾¾å¼æ˜¯å¦é‡å¤ï¼Ÿ
   â†“ [æ˜¯]
ä½¿ç”¨ç¼“å­˜
   â†“ [å¦]
ä½¿ç”¨ä¸€æ¬¡æ€§è§£æ
```

### 7.6 æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜


**æ€§èƒ½ç›‘æ§æŒ‡æ ‡**ï¼š

```java
@Aspect
@Component
public class SpELPerformanceMonitor {
    
    @Around("@annotation(UseSpEL)")
    public Object monitor(ProceedingJoinPoint pjp) throws Throwable {
        long start = System.nanoTime();
        
        try {
            return pjp.proceed();
        } finally {
            long duration = System.nanoTime() - start;
            
            // è®°å½•æ€§èƒ½æŒ‡æ ‡
            if (duration > 10_000_000) {  // è¶…è¿‡10ms
                log.warn("SpELæ‰§è¡Œç¼“æ…¢: {}ms, æ–¹æ³•: {}", 
                    duration / 1_000_000, pjp.getSignature());
            }
            
            // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
            metricsService.record("spel.execution.time", duration);
        }
    }
}
```

**æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•**ï¼š

| ä¼˜åŒ–é¡¹ | æ£€æŸ¥ç‚¹ | ä¼˜åŒ–æ•ˆæœ |
|--------|--------|---------|
| **è¡¨è¾¾å¼ç®€åŒ–** | `æ˜¯å¦å¯ä»¥æ‹†åˆ†å¤æ‚è¡¨è¾¾å¼ï¼Ÿ` | `æå‡20-50%` |
| **ç¼“å­˜å¯ç”¨** | `é‡å¤è¡¨è¾¾å¼æ˜¯å¦å·²ç¼“å­˜ï¼Ÿ` | `æå‡60-80%` |
| **ç¼–è¯‘æ¨¡å¼** | `æ˜¯å¦å¯ç”¨ç¼–è¯‘æ¨¡å¼ï¼Ÿ` | `æå‡5-10å€` |
| **å‡å°‘ä½¿ç”¨** | `æ˜¯å¦å¯ä»¥ç”¨Javaä»£æ›¿ï¼Ÿ` | `æå‡10å€ä»¥ä¸Š` |

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å®‰å…¨é˜²æŠ¤è¦ç‚¹


**ğŸ”’ å®‰å…¨ä¸‰åŸåˆ™**ï¼š
```
1. æ°¸ä¸ä¿¡ä»»ç”¨æˆ·è¾“å…¥
   â†’ æ‰€æœ‰å¤–éƒ¨è¾“å…¥éƒ½è¦éªŒè¯

2. æœ€å°æƒé™
   â†’ åªç»™å¿…éœ€çš„è®¿é—®æƒé™

3. é»˜è®¤æ‹’ç»
   â†’ ä¸ç¡®å®šçš„å°±ç¦æ­¢
```

**ğŸ›¡ï¸ å®‰å…¨å®æ–½æ¸…å•**ï¼š
- âœ… ä½¿ç”¨`SimpleEvaluationContext`æ›¿ä»£`StandardEvaluationContext`
- âœ… ç¦ç”¨`T()`ç±»å‹å¼•ç”¨
- âœ… ä½¿ç”¨`?.`ç©ºå®‰å…¨æ“ä½œç¬¦é¿å…NPE
- âœ… è®¾ç½®è¡¨è¾¾å¼é•¿åº¦å’ŒåµŒå¥—æ·±åº¦é™åˆ¶
- âœ… å®æ–½ç™½åå•è®¿é—®æ§åˆ¶
- âœ… æ·»åŠ æ‰§è¡Œæ—¶é—´é™åˆ¶

### 8.2 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹


**âš¡ æ€§èƒ½ä¼˜åŒ–å››æ­¥èµ°**ï¼š
```
ç¬¬1æ­¥ï¼šç®€åŒ–è¡¨è¾¾å¼
      â†’ å‡å°‘å¤æ‚è¿ç®—

ç¬¬2æ­¥ï¼šå¯ç”¨ç¼“å­˜
      â†’ é¿å…é‡å¤è§£æ

ç¬¬3æ­¥ï¼šä½¿ç”¨ç¼–è¯‘æ¨¡å¼
      â†’ æå‡æ‰§è¡Œé€Ÿåº¦

ç¬¬4æ­¥ï¼šå‡å°‘SpELä½¿ç”¨
      â†’ èƒ½ç”¨Javaå°±ä¸ç”¨SpEL
```

**ğŸ“Š æ€§èƒ½æå‡å¯¹æ¯”**ï¼š

| ä¼˜åŒ–æ‰‹æ®µ | æå‡å¹…åº¦ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|
| **è¡¨è¾¾å¼ç®€åŒ–** | `20-50%` | `æ‰€æœ‰åœºæ™¯` |
| **ç¼“å­˜æœºåˆ¶** | `60-80%` | `é‡å¤è¡¨è¾¾å¼` |
| **ç¼–è¯‘æ¨¡å¼** | `5-10å€` | `å›ºå®šè¡¨è¾¾å¼` |
| **é¿å…ä½¿ç”¨** | `10å€ä»¥ä¸Š` | `ç®€å•é€»è¾‘` |

### 8.3 å®æˆ˜è®°å¿†å£è¯€


**å®‰å…¨å£è¯€**ï¼š
```
ç©ºå®‰å…¨ç”¨é—®å·ï¼Œå±é™©æ“ä½œè¦ç¦æ‰
è¡¨è¾¾å¼æœ‰è¾¹ç•Œï¼Œæƒé™ç»™åˆ°æœ€å°å¥½
```

**æ€§èƒ½å£è¯€**ï¼š
```
ç®€åŒ–é€»è¾‘ç¬¬ä¸€æ­¥ï¼Œç¼“å­˜è§£æä¸é‡å¤
ç¼–è¯‘æ¨¡å¼é€Ÿåº¦å¿«ï¼Œèƒ½ä¸ç”¨å°±ä¸ç”¨ç€
```

### 8.4 å¿«é€Ÿå†³ç­–æŒ‡å—


**ä½•æ—¶ä½¿ç”¨SpELï¼Ÿ**
```
âœ… é€‚åˆä½¿ç”¨ï¼š
   - é…ç½®æ–‡ä»¶ä¸­çš„åŠ¨æ€å€¼
   - è§„åˆ™å¼•æ“è¡¨è¾¾å¼
   - æ¨¡æ¿å˜é‡æ›¿æ¢
   - ç®€å•çš„æ¡ä»¶åˆ¤æ–­

âŒ ä¸é€‚åˆä½¿ç”¨ï¼š
   - å¤æ‚ä¸šåŠ¡é€»è¾‘
   - å¤§é‡æ•°æ®å¤„ç†
   - æ€§èƒ½æ•æ„Ÿåœºæ™¯
   - å®‰å…¨è¦æ±‚æé«˜çš„åœºæ™¯
```

**å®‰å…¨é…ç½®æ¨¡æ¿**ï¼š
```java
// ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
SimpleEvaluationContext context = SimpleEvaluationContext
    .forReadOnlyDataBinding()           // åªè¯»
    .withRootObject(createSafeRoot())   // å®‰å…¨çš„æ ¹å¯¹è±¡
    .build();

ExpressionParser parser = new SpelExpressionParser(
    new SpelParserConfiguration(
        SpelCompilerMode.IMMEDIATE,     // ç«‹å³ç¼–è¯‘
        null,
        true,                           // è‡ªåŠ¨åˆ›å»ºnullå¯¹è±¡
        true,                           // è‡ªåŠ¨å¢é•¿é›†åˆ
        256                             // ç¼“å­˜å¤§å°
    )
);
```

**æ ¸å¿ƒç†è§£**ï¼š
- SpELå¾ˆå¼ºå¤§ï¼Œä½†ä¸èƒ½æ»¥ç”¨
- å®‰å…¨æ°¸è¿œæ˜¯ç¬¬ä¸€ä½çš„
- æ€§èƒ½ä¼˜åŒ–è¦æœ‰çš„æ”¾çŸ¢
- ç®€å•åœºæ™¯ç”¨Javaä»£æ›¿æ›´å¥½