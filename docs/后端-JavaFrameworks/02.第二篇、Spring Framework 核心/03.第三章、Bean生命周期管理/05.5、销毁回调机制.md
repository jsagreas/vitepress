---
title: 5ã€é”€æ¯å›è°ƒæœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯Beané”€æ¯å›è°ƒæœºåˆ¶](#1-ä»€ä¹ˆæ˜¯beané”€æ¯å›è°ƒæœºåˆ¶)
2. [ä¸ºä»€ä¹ˆéœ€è¦é”€æ¯å›è°ƒ](#2-ä¸ºä»€ä¹ˆéœ€è¦é”€æ¯å›è°ƒ)
3. [ä¸‰ç§é”€æ¯å›è°ƒæ–¹å¼è¯¦è§£](#3-ä¸‰ç§é”€æ¯å›è°ƒæ–¹å¼è¯¦è§£)
4. [é”€æ¯æ—¶æœºä¸å®¹å™¨å…³é—­](#4-é”€æ¯æ—¶æœºä¸å®¹å™¨å…³é—­)
5. [èµ„æºæ¸…ç†æœ€ä½³å®è·µ](#5-èµ„æºæ¸…ç†æœ€ä½³å®è·µ)
6. [å¼‚å¸¸å¤„ç†ç­–ç•¥](#6-å¼‚å¸¸å¤„ç†ç­–ç•¥)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ ä»€ä¹ˆæ˜¯Beané”€æ¯å›è°ƒæœºåˆ¶


### 1.1 é”€æ¯å›è°ƒçš„æœ¬è´¨


**é€šä¿—ç†è§£**ï¼šå°±åƒä½ ç¦»å¼€æˆ¿é—´å‰è¦å…³ç¯ã€å…³é—¨ä¸€æ ·ï¼ŒBeanåœ¨è¢«é”€æ¯å‰ä¹Ÿéœ€è¦åšä¸€äº›"æ”¶å°¾å·¥ä½œ"

```
ç”Ÿæ´»ç±»æ¯”ï¼š
ç¦»å¼€åŠå…¬å®¤ â†’ å…³ç”µè„‘ã€å…³ç¯ã€é”é—¨
Beané”€æ¯    â†’ å…³é—­è¿æ¥ã€é‡Šæ”¾èµ„æºã€ä¿å­˜æ•°æ®

æ ¸å¿ƒæ¦‚å¿µï¼š
é”€æ¯å›è°ƒ = Springå®¹å™¨åœ¨é”€æ¯Beanä¹‹å‰ï¼Œç»™Beanä¸€ä¸ª"è¯´å†è§"çš„æœºä¼š
ç›®çš„ï¼šè®©Beanèƒ½å¤Ÿä¼˜é›…åœ°é‡Šæ”¾èµ„æºï¼Œé¿å…å†…å­˜æ³„æ¼å’Œèµ„æºæµªè´¹
```

### 1.2 é”€æ¯å›è°ƒçš„å·¥ä½œæµç¨‹


```
Beanç”Ÿå‘½å‘¨æœŸå®Œæ•´æµç¨‹ï¼š

åˆ›å»ºé˜¶æ®µ                ä½¿ç”¨é˜¶æ®µ              é”€æ¯é˜¶æ®µ
   â†“                      â†“                    â†“
å®ä¾‹åŒ– â†’ ä¾èµ–æ³¨å…¥ â†’ åˆå§‹åŒ– â†’ ä¸šåŠ¡ä½¿ç”¨ â†’ é”€æ¯å‰å›è°ƒ â†’ çœŸæ­£é”€æ¯
         â†‘                              â†‘
    @Autowired                    @PreDestroy
    æ„é€ å™¨æ³¨å…¥                    DisposableBean
                                  destroy-method

å…³é”®ç†è§£ï¼š
â€¢ é”€æ¯å›è°ƒå‘ç”Ÿåœ¨BeançœŸæ­£é”€æ¯ä¹‹å‰
â€¢ è¿™æ˜¯Bean"æœ€åçš„æœºä¼š"æ¸…ç†èµ„æº
â€¢ å¦‚æœä¸æ¸…ç†ï¼Œå¯èƒ½å¯¼è‡´èµ„æºæ³„æ¼
```

---

## 2. ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦é”€æ¯å›è°ƒ


### 2.1 èµ„æºæ³„æ¼çš„éšæ‚£


**å®é™…é—®é¢˜åœºæ™¯**ï¼š

```
åœºæ™¯1ï¼šæ•°æ®åº“è¿æ¥æœªå…³é—­
ç”¨æˆ·æœåŠ¡å¯åŠ¨ â†’ åˆ›å»º100ä¸ªæ•°æ®åº“è¿æ¥
åº”ç”¨å…³é—­   â†’ è¿æ¥æ²¡å…³é—­ï¼Œä¸€ç›´å ç”¨æ•°æ®åº“èµ„æº
ç»“æœï¼šæ•°æ®åº“è¿æ¥æ± è¢«è€—å°½ï¼Œå…¶ä»–åº”ç”¨æ— æ³•è¿æ¥

åœºæ™¯2ï¼šæ–‡ä»¶å¥æŸ„æœªé‡Šæ”¾  
æ—¥å¿—æœåŠ¡   â†’ æ‰“å¼€æ–‡ä»¶å†™æ—¥å¿—
åº”ç”¨å…³é—­   â†’ æ–‡ä»¶æ²¡å…³é—­
ç»“æœï¼šæ–‡ä»¶è¢«é”å®šï¼Œæ— æ³•åˆ é™¤æˆ–ä¿®æ”¹

åœºæ™¯3ï¼šçº¿ç¨‹æ± æœªå…³é—­
ä»»åŠ¡è°ƒåº¦å™¨ â†’ åˆ›å»ºçº¿ç¨‹æ± æ‰§è¡Œå®šæ—¶ä»»åŠ¡
åº”ç”¨å…³é—­   â†’ çº¿ç¨‹è¿˜åœ¨è¿è¡Œ
ç»“æœï¼šåº”ç”¨æ— æ³•æ­£å¸¸é€€å‡ºï¼Œéœ€è¦å¼ºåˆ¶kill
```

### 2.2 éœ€è¦æ¸…ç†çš„å¸¸è§èµ„æº


| èµ„æºç±»å‹ | **å…·ä½“ä¾‹å­** | **ä¸æ¸…ç†çš„åæœ** |
|---------|------------|---------------|
| ğŸ—„ï¸ **æ•°æ®åº“è¿æ¥** | `DataSourceã€Connection` | è¿æ¥æ± è€—å°½ï¼Œæ•°æ®åº“å‹åŠ›å¤§ |
| ğŸ“ **æ–‡ä»¶èµ„æº** | `FileInputStreamã€Writer` | æ–‡ä»¶é”å®šï¼Œæ— æ³•æ“ä½œ |
| ğŸŒ **ç½‘ç»œè¿æ¥** | `Socketã€HttpClient` | ç«¯å£å ç”¨ï¼Œèµ„æºæµªè´¹ |
| ğŸ”„ **çº¿ç¨‹æ± ** | `ExecutorServiceã€ThreadPool` | çº¿ç¨‹æ— æ³•åœæ­¢ï¼Œå†…å­˜æ³„æ¼ |
| ğŸ“¡ **æ¶ˆæ¯ç›‘å¬å™¨** | `MessageListenerã€Consumer` | ç»§ç»­æ¶ˆè´¹æ¶ˆæ¯ï¼Œé€»è¾‘é”™è¯¯ |
| â° **å®šæ—¶ä»»åŠ¡** | `ScheduledTaskã€Timer` | ä»»åŠ¡ç»§ç»­æ‰§è¡Œï¼Œäº§ç”Ÿè„æ•°æ® |

> ğŸ’¡ **å…³é”®ç†è§£**ï¼šJavaçš„åƒåœ¾å›æ”¶å™¨ï¼ˆGCï¼‰åªèƒ½å›æ”¶å†…å­˜ï¼Œä½†æ— æ³•è‡ªåŠ¨å…³é—­å¤–éƒ¨èµ„æºï¼ˆå¦‚æ•°æ®åº“è¿æ¥ã€æ–‡ä»¶å¥æŸ„ï¼‰ã€‚è¿™äº›å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾ï¼

---

## 3. ğŸ› ï¸ ä¸‰ç§é”€æ¯å›è°ƒæ–¹å¼è¯¦è§£


### 3.1 æ–¹å¼ä¸€ï¼šDisposableBeanæ¥å£


**å®ç°åŸç†**ï¼šè®©Beanå®ç°Springæä¾›çš„`DisposableBean`æ¥å£

```java
// â‘  åŸºç¡€ç”¨æ³•ç¤ºä¾‹
public class DatabaseService implements DisposableBean {
    
    private DataSource dataSource;
    
    @Override
    public void destroy() throws Exception {
        // åœ¨è¿™é‡Œå†™æ¸…ç†é€»è¾‘
        System.out.println("æ­£åœ¨å…³é—­æ•°æ®åº“è¿æ¥...");
        if (dataSource != null) {
            dataSource.close();
        }
    }
}
```

**æ‰§è¡Œæ—¶æœº**ï¼š
```
å®¹å™¨å…³é—­æµç¨‹ï¼š
1. åº”ç”¨è°ƒç”¨ context.close()
2. Springæ£€æµ‹åˆ°Beanå®ç°äº†DisposableBean
3. è‡ªåŠ¨è°ƒç”¨ destroy() æ–¹æ³•
4. æ‰§è¡Œå®Œæ¸…ç†åï¼ŒBeanè¢«é”€æ¯
```

**ä¼˜ç¼ºç‚¹å¯¹æ¯”**ï¼š
- âœ… **ä¼˜ç‚¹**ï¼šç®€å•ç›´æ¥ï¼ŒSpringä¿è¯ä¸€å®šä¼šè°ƒç”¨
- âŒ **ç¼ºç‚¹**ï¼šä»£ç ä¸Springæ¡†æ¶è€¦åˆï¼ˆå®ç°äº†Springæ¥å£ï¼‰

---

### 3.2 æ–¹å¼äºŒï¼šdestroy-methodé…ç½®


**å®ç°åŸç†**ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šé”€æ¯æ–¹æ³•ï¼ŒBeanæ— éœ€å®ç°ä»»ä½•æ¥å£

**ğŸ“‹ XMLé…ç½®æ–¹å¼**ï¼š
```xml
<!-- beané…ç½®ä¸­æŒ‡å®šdestroy-method -->
<bean id="fileService" class="com.example.FileService" 
      destroy-method="cleanup">
</bean>
```

**å¯¹åº”çš„Javaç±»**ï¼š
```java
public class FileService {
    
    private FileWriter writer;
    
    // æ–¹æ³•åå¿…é¡»ä¸é…ç½®çš„destroy-methodä¸€è‡´
    public void cleanup() {
        System.out.println("æ­£åœ¨å…³é—­æ–‡ä»¶...");
        if (writer != null) {
            try {
                writer.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
}
```

**ğŸ”§ Javaé…ç½®æ–¹å¼ï¼ˆæ¨èï¼‰**ï¼š
```java
@Configuration
public class AppConfig {
    
    @Bean(destroyMethod = "cleanup")
    public FileService fileService() {
        return new FileService();
    }
}
```

**ç‰¹æ®Šç”¨æ³•ï¼šè‡ªåŠ¨æ¨æ–­å…³é—­æ–¹æ³•**
```java
@Bean(destroyMethod = "(inferred)")  // è‡ªåŠ¨æ¨æ–­
public DataSource dataSource() {
    return new HikariDataSource();
}

// Springä¼šè‡ªåŠ¨æŸ¥æ‰¾ä»¥ä¸‹æ–¹æ³•åï¼š
// close() æˆ– shutdown()
// å¦‚æœæ‰¾åˆ°ï¼Œè‡ªåŠ¨è°ƒç”¨
```

**ä¼˜ç¼ºç‚¹å¯¹æ¯”**ï¼š
- âœ… **ä¼˜ç‚¹**ï¼šä»£ç ä¸Springè§£è€¦ï¼ŒBeanæ˜¯çº¯POJO
- âœ… **ä¼˜ç‚¹**ï¼šçµæ´»ï¼Œå¯ä»¥æŒ‡å®šä»»æ„æ–¹æ³•å
- âŒ **ç¼ºç‚¹**ï¼šéœ€è¦é¢å¤–é…ç½®

---

### 3.3 æ–¹å¼ä¸‰ï¼š@PreDestroyæ³¨è§£ï¼ˆâ­ æ¨èï¼‰


**å®ç°åŸç†**ï¼šä½¿ç”¨JSR-250æ ‡å‡†æ³¨è§£ï¼Œæ ‡è®°é”€æ¯æ–¹æ³•

```java
import javax.annotation.PreDestroy;

public class CacheService {
    
    private Cache localCache;
    
    @PreDestroy  // æ ‡è®°ä¸ºé”€æ¯æ–¹æ³•
    public void clearCache() {
        System.out.println("æ­£åœ¨æ¸…ç†ç¼“å­˜...");
        if (localCache != null) {
            localCache.clear();
        }
    }
}
```

**æ‰§è¡Œæµç¨‹**ï¼š
```
å®¹å™¨å…³é—­æ—¶ï¼š
1. Springæ‰«æBeançš„æ‰€æœ‰æ–¹æ³•
2. æ‰¾åˆ°æ ‡æ³¨äº†@PreDestroyçš„æ–¹æ³•
3. åœ¨é”€æ¯å‰è‡ªåŠ¨è°ƒç”¨è¯¥æ–¹æ³•
4. å®Œæˆåé”€æ¯Bean
```

**â­ ä¸ºä»€ä¹ˆæ¨èä½¿ç”¨ï¼Ÿ**
```
â‘  ä»£ç ç®€æ´ï¼šåªéœ€ä¸€ä¸ªæ³¨è§£
â‘¡ æ ‡å‡†åŒ–ï¼šJSR-250æ ‡å‡†ï¼Œä¸ä¾èµ–Spring
â‘¢ æ˜“ç»´æŠ¤ï¼šæ–¹æ³•åä»»æ„ï¼Œä¸€ç›®äº†ç„¶
â‘£ å¤šæ–¹æ³•ï¼šå¯ä»¥æœ‰å¤šä¸ª@PreDestroyæ–¹æ³•ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰
```

---

### 3.4 ä¸‰ç§æ–¹å¼å¯¹æ¯”æ€»ç»“


| å¯¹æ¯”ç»´åº¦ | **DisposableBean** | **destroy-method** | **@PreDestroy** |
|---------|-------------------|-------------------|-----------------|
| ğŸ”— **è€¦åˆåº¦** | é«˜ï¼ˆä¾èµ–Springï¼‰ | ä½ï¼ˆçº¯POJOï¼‰ | ä½ï¼ˆæ ‡å‡†æ³¨è§£ï¼‰ |
| ğŸ“ **é…ç½®å¤æ‚åº¦** | æ— éœ€é…ç½® | éœ€è¦XML/Javaé…ç½® | æ— éœ€é…ç½® |
| ğŸ¯ **çµæ´»æ€§** | å›ºå®šæ–¹æ³•ådestroy | è‡ªå®šä¹‰æ–¹æ³•å | è‡ªå®šä¹‰æ–¹æ³•å |
| â­ **æ¨èæŒ‡æ•°** | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜… |

**ğŸ“Œ é€‰æ‹©å»ºè®®**ï¼š
- æ–°é¡¹ç›®é¦–é€‰ï¼š`@PreDestroy`
- å·²æœ‰Springé¡¹ç›®ï¼š`DisposableBean`
- è€é¡¹ç›®è¿ç§»ï¼š`destroy-method`

---

## 4. â° é”€æ¯æ—¶æœºä¸å®¹å™¨å…³é—­


### 4.1 å®¹å™¨å…³é—­çš„è§¦å‘æ–¹å¼


**æ–¹å¼â‘ ï¼šæ‰‹åŠ¨å…³é—­ï¼ˆå¼€å‘æµ‹è¯•å¸¸ç”¨ï¼‰**
```java
// åˆ›å»ºå®¹å™¨
ConfigurableApplicationContext context = 
    new AnnotationConfigApplicationContext(AppConfig.class);

// ä½¿ç”¨Bean...

// æ‰‹åŠ¨å…³é—­å®¹å™¨
context.close();  // è¿™ä¼šè§¦å‘æ‰€æœ‰Beançš„é”€æ¯å›è°ƒ
```

**æ–¹å¼â‘¡ï¼šæ³¨å†Œå…³é—­é’©å­ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰**
```java
public static void main(String[] args) {
    ConfigurableApplicationContext context = 
        new AnnotationConfigApplicationContext(AppConfig.class);
    
    // æ³¨å†ŒJVMå…³é—­é’©å­
    context.registerShutdownHook();
    
    // åº”ç”¨è¿è¡Œ...
    // å½“JVMå…³é—­æ—¶ï¼ˆæ­£å¸¸é€€å‡ºæˆ–Ctrl+Cï¼‰ï¼Œè‡ªåŠ¨è§¦å‘å®¹å™¨å…³é—­
}
```

**å…³é—­é’©å­çš„å·¥ä½œåŸç†**ï¼š
```
åº”ç”¨åœºæ™¯å¯¹æ¯”ï¼š

åœºæ™¯1ï¼šå¼€å‘ç¯å¢ƒæ‰‹åŠ¨å…³é—­
å¼€å‘è€… â†’ ç‚¹å‡»åœæ­¢æŒ‰é’® â†’ è°ƒç”¨context.close() â†’ Beané”€æ¯

åœºæ™¯2ï¼šç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨å…³é—­  
Linux â†’ kill -15 è¿›ç¨‹ â†’ JVMæ•è·ä¿¡å· â†’ æ‰§è¡ŒShutdownHook 
     â†’ è‡ªåŠ¨è°ƒç”¨context.close() â†’ Beané”€æ¯

å…³é”®åŒºåˆ«ï¼š
â€¢ æ‰‹åŠ¨å…³é—­ï¼šéœ€è¦æ˜¾å¼è°ƒç”¨ï¼Œé€‚åˆå¯æ§ç¯å¢ƒ
â€¢ å…³é—­é’©å­ï¼šè‡ªåŠ¨è§¦å‘ï¼Œé€‚åˆæœåŠ¡å™¨éƒ¨ç½²
```

### 4.2 Spring Bootä¸­çš„è‡ªåŠ¨åŒ–å¤„ç†


**Spring Bootçš„è´´å¿ƒè®¾è®¡**ï¼š

> ğŸ’¡ **å¥½æ¶ˆæ¯**ï¼šåœ¨Spring Bootåº”ç”¨ä¸­ï¼Œä½ é€šå¸¸ä¸éœ€è¦æ‰‹åŠ¨å¤„ç†å®¹å™¨å…³é—­ï¼

```java
@SpringBootApplication
public class MyApplication {
    public static void main(String[] args) {
        SpringApplication.run(MyApplication.class, args);
        // Spring Bootå·²ç»è‡ªåŠ¨æ³¨å†Œäº†å…³é—­é’©å­
        // æ— éœ€æ‰‹åŠ¨è°ƒç”¨registerShutdownHook()
    }
}
```

**Spring Bootè‡ªåŠ¨åšçš„äº‹**ï¼š
```
å¯åŠ¨æ—¶ï¼š
â‘  åˆ›å»ºApplicationContext
â‘¡ è‡ªåŠ¨æ³¨å†ŒJVMå…³é—­é’©å­
â‘¢ é…ç½®ä¼˜é›…å…³é—­æœºåˆ¶

å…³é—­æ—¶ï¼š
â‘  æ¥æ”¶å…³é—­ä¿¡å·ï¼ˆkillæˆ–Ctrl+Cï¼‰
â‘¡ åœæ­¢æ¥æ”¶æ–°è¯·æ±‚
â‘¢ ç­‰å¾…ç°æœ‰è¯·æ±‚å¤„ç†å®Œï¼ˆå¯é…ç½®è¶…æ—¶æ—¶é—´ï¼‰
â‘£ è§¦å‘æ‰€æœ‰Beançš„é”€æ¯å›è°ƒ
â‘¤ å…³é—­å®¹å™¨
```

**é…ç½®ä¼˜é›…å…³é—­ï¼ˆSpring Boot 2.3+ï¼‰**ï¼š
```yaml
# application.yml
server:
  shutdown: graceful  # å¼€å¯ä¼˜é›…å…³é—­
spring:
  lifecycle:
    timeout-per-shutdown-phase: 30s  # ç­‰å¾…30ç§’
```

---

## 5. ğŸ§¹ èµ„æºæ¸…ç†æœ€ä½³å®è·µ


### 5.1 æ•°æ®åº“è¿æ¥æ¸…ç†ç¤ºä¾‹


```java
@Component
public class UserRepository {
    
    private DataSource dataSource;
    private Connection connection;
    
    @Autowired
    public UserRepository(DataSource dataSource) {
        this.dataSource = dataSource;
    }
    
    @PreDestroy
    public void cleanup() {
        System.out.println("å¼€å§‹æ¸…ç†æ•°æ®åº“èµ„æº...");
        
        // å…³é—­è¿æ¥
        if (connection != null && !connection.isClosed()) {
            connection.close();
            System.out.println("âœ… æ•°æ®åº“è¿æ¥å·²å…³é—­");
        }
        
        // å¦‚æœDataSourceæ˜¯è‡ªå·±åˆ›å»ºçš„ï¼Œä¹Ÿéœ€è¦å…³é—­
        if (dataSource instanceof AutoCloseable) {
            ((AutoCloseable) dataSource).close();
            System.out.println("âœ… æ•°æ®æºå·²å…³é—­");
        }
    }
}
```

### 5.2 çº¿ç¨‹æ± æ¸…ç†ç¤ºä¾‹


```java
@Service
public class AsyncTaskService {
    
    private ExecutorService executor = 
        Executors.newFixedThreadPool(10);
    
    public void executeTask(Runnable task) {
        executor.submit(task);
    }
    
    @PreDestroy
    public void shutdown() {
        System.out.println("å¼€å§‹å…³é—­çº¿ç¨‹æ± ...");
        
        // â‘  åœæ­¢æ¥æ”¶æ–°ä»»åŠ¡
        executor.shutdown();
        
        try {
            // â‘¡ ç­‰å¾…å·²æœ‰ä»»åŠ¡å®Œæˆï¼ˆæœ€å¤šç­‰10ç§’ï¼‰
            if (!executor.awaitTermination(10, TimeUnit.SECONDS)) {
                System.out.println("âš ï¸ ä»»åŠ¡æœªåœ¨10ç§’å†…å®Œæˆï¼Œå¼ºåˆ¶å…³é—­");
                
                // â‘¢ å¼ºåˆ¶å…³é—­ï¼Œè¿”å›æœªæ‰§è¡Œçš„ä»»åŠ¡
                List<Runnable> unfinished = executor.shutdownNow();
                System.out.println("âŒ æœªå®Œæˆä»»åŠ¡æ•°ï¼š" + unfinished.size());
            } else {
                System.out.println("âœ… çº¿ç¨‹æ± å·²ä¼˜é›…å…³é—­");
            }
        } catch (InterruptedException e) {
            executor.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
}
```

**å…³é”®æ­¥éª¤è¯´æ˜**ï¼š
```
çº¿ç¨‹æ± å…³é—­ä¸‰æ­¥æ›²ï¼š
â‘  shutdown()      â†’ æ‹’ç»æ–°ä»»åŠ¡ï¼Œç­‰å¾…å·²æœ‰ä»»åŠ¡
â‘¡ awaitTermination â†’ ç­‰å¾…æŒ‡å®šæ—¶é—´
â‘¢ shutdownNow()   â†’ è¶…æ—¶å¼ºåˆ¶å…³é—­

ç±»æ¯”ç†è§£ï¼š
â‘  å…³é—¨ä¸è®©æ–°å®¢äººè¿›
â‘¡ ç­‰ç°æœ‰å®¢äººåƒå®Œï¼ˆ10åˆ†é’Ÿï¼‰
â‘¢ æ—¶é—´åˆ°äº†ç›´æ¥æ¸…åœº
```

### 5.3 æ–‡ä»¶èµ„æºæ¸…ç†ç¤ºä¾‹


```java
@Component
public class LogWriter {
    
    private BufferedWriter writer;
    
    @PostConstruct
    public void init() throws IOException {
        writer = new BufferedWriter(
            new FileWriter("app.log", true)
        );
    }
    
    public void writeLog(String message) throws IOException {
        writer.write(message);
        writer.newLine();
    }
    
    @PreDestroy
    public void closeFile() {
        System.out.println("å¼€å§‹å…³é—­æ—¥å¿—æ–‡ä»¶...");
        
        if (writer != null) {
            try {
                writer.flush();  // â‘  å…ˆåˆ·æ–°ç¼“å†²åŒº
                writer.close();  // â‘¡ å†å…³é—­æ–‡ä»¶
                System.out.println("âœ… æ—¥å¿—æ–‡ä»¶å·²å…³é—­");
            } catch (IOException e) {
                System.err.println("âŒ å…³é—­æ–‡ä»¶å¤±è´¥ï¼š" + e.getMessage());
            }
        }
    }
}
```

### 5.4 æ¸…ç†é¡ºåºçš„é‡è¦æ€§


**åœºæ™¯ï¼šä¾èµ–å…³ç³»çš„Beanæ¸…ç†**

```java
// é”™è¯¯ç¤ºä¾‹ï¼šå¯èƒ½äº§ç”Ÿç©ºæŒ‡é’ˆ
@Component
public class ServiceA {
    @Autowired
    private ServiceB serviceB;
    
    @PreDestroy
    public void cleanup() {
        serviceB.doSomething();  // âŒ serviceBå¯èƒ½å·²ç»è¢«é”€æ¯äº†ï¼
    }
}
```

**Springçš„é”€æ¯é¡ºåºè§„åˆ™**ï¼š
```
é”€æ¯é¡ºåºï¼ˆä¸åˆ›å»ºé¡ºåºç›¸åï¼‰ï¼š

åˆ›å»ºé¡ºåºï¼šA â†’ B â†’ C
é”€æ¯é¡ºåºï¼šC â†’ B â†’ A

åŸåˆ™ï¼šååˆ›å»ºçš„å…ˆé”€æ¯

å®é™…åœºæ™¯ï¼š
æ•°æ®æº(A) â†’ ä»“åº“(B) â†’ æœåŠ¡(C)
é”€æ¯æ—¶ï¼šæœåŠ¡(C)å…ˆé”€æ¯ â†’ ä»“åº“(B) â†’ æ•°æ®æº(A)

âš ï¸ æ³¨æ„ï¼šé”€æ¯æ–¹æ³•ä¸­å°½é‡ä¸è¦ä¾èµ–å…¶ä»–Beanï¼
```

**å®‰å…¨çš„æ¸…ç†æ¨¡å¼**ï¼š
```java
@Component
public class SafeService {
    
    @Autowired
    private DataSource dataSource;
    
    @PreDestroy
    public void cleanup() {
        // âœ… åªæ¸…ç†è‡ªå·±æŒæœ‰çš„èµ„æº
        // âœ… ä¸ä¾èµ–å…¶ä»–Bean
        
        if (dataSource != null) {
            // ç›´æ¥å…³é—­ï¼Œä¸è°ƒç”¨å…¶ä»–Beançš„æ–¹æ³•
            dataSource.close();
        }
    }
}
```

---

## 6. âš ï¸ å¼‚å¸¸å¤„ç†ç­–ç•¥


### 6.1 é”€æ¯æ–¹æ³•ä¸­çš„å¼‚å¸¸å½±å“


**å…³é”®é—®é¢˜**ï¼šé”€æ¯æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ä¼šæ€æ ·ï¼Ÿ

```java
@Component
public class ProblematicService {
    
    @PreDestroy
    public void cleanup() throws Exception {
        // å‡è®¾è¿™é‡ŒæŠ›å‡ºå¼‚å¸¸
        throw new RuntimeException("æ¸…ç†å¤±è´¥ï¼");
    }
}
```

**å¼‚å¸¸å½±å“åˆ†æ**ï¼š
```
å•ä¸ªBeanæŠ›å¼‚å¸¸ï¼š
é”€æ¯Bean1 â†’ æˆåŠŸ âœ…
é”€æ¯Bean2 â†’ æŠ›å¼‚å¸¸ âŒ
é”€æ¯Bean3 â†’ ç»§ç»­æ‰§è¡Œ âœ…  ï¼ˆSpringä¼šç»§ç»­é”€æ¯å…¶ä»–Beanï¼‰

å…³é”®ç†è§£ï¼š
â€¢ å•ä¸ªBeançš„å¼‚å¸¸ä¸ä¼šä¸­æ–­æ•´ä¸ªé”€æ¯æµç¨‹
â€¢ ä½†è¯¥Beanå¯èƒ½èµ„æºæ²¡æ¸…ç†å¹²å‡€
â€¢ å¼‚å¸¸ä¼šè¢«Springè®°å½•ï¼Œä½†ä¸ä¼šå‘ä¸ŠæŠ›å‡º
```

### 6.2 æ­£ç¡®çš„å¼‚å¸¸å¤„ç†æ¨¡å¼


**æ¨¡å¼â‘ ï¼šå…¨éƒ¨æ•è·ï¼Œè®°å½•æ—¥å¿—**
```java
@Component
public class RobustService {
    
    private Connection conn;
    private FileWriter writer;
    
    @PreDestroy
    public void cleanup() {
        // å…³é—­æ•°æ®åº“è¿æ¥
        try {
            if (conn != null) {
                conn.close();
                System.out.println("âœ… æ•°æ®åº“è¿æ¥å·²å…³é—­");
            }
        } catch (Exception e) {
            System.err.println("âŒ å…³é—­è¿æ¥å¤±è´¥ï¼š" + e.getMessage());
            // ç»§ç»­æ‰§è¡Œï¼Œä¸å½±å“å…¶ä»–èµ„æºæ¸…ç†
        }
        
        // å…³é—­æ–‡ä»¶
        try {
            if (writer != null) {
                writer.close();
                System.out.println("âœ… æ–‡ä»¶å·²å…³é—­");
            }
        } catch (Exception e) {
            System.err.println("âŒ å…³é—­æ–‡ä»¶å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

**æ¨¡å¼â‘¡ï¼štry-with-resourcesè‡ªåŠ¨æ¸…ç†**
```java
@Component  
public class ModernService {
    
    @PreDestroy
    public void cleanup() {
        // ä½¿ç”¨try-with-resourcesï¼Œè‡ªåŠ¨å…³é—­
        try (
            Connection conn = getConnection();
            FileWriter writer = getWriter()
        ) {
            // èµ„æºä¼šè‡ªåŠ¨å…³é—­ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨close()
            System.out.println("èµ„æºä½¿ç”¨å®Œæ¯•");
        } catch (Exception e) {
            System.err.println("æ¸…ç†å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

### 6.3 èµ„æºæ¸…ç†çš„ä¼˜å…ˆçº§ç­–ç•¥


**ç­–ç•¥ï¼šé‡è¦èµ„æºä¼˜å…ˆæ¸…ç†**

```java
@Component
public class PriorityCleanupService {
    
    private DataSource dataSource;      // é«˜ä¼˜å…ˆçº§
    private FileWriter logWriter;       // ä¸­ä¼˜å…ˆçº§  
    private Cache localCache;           // ä½ä¼˜å…ˆçº§
    
    @PreDestroy
    public void cleanup() {
        // â‘  å…ˆæ¸…ç†æœ€é‡è¦çš„èµ„æºï¼ˆæ•°æ®åº“ï¼‰
        cleanupDatabase();
        
        // â‘¡ å†æ¸…ç†æ¬¡è¦èµ„æºï¼ˆæ–‡ä»¶ï¼‰
        cleanupFiles();
        
        // â‘¢ æœ€åæ¸…ç†å¯é€‰èµ„æºï¼ˆç¼“å­˜ï¼‰
        cleanupCache();
    }
    
    private void cleanupDatabase() {
        try {
            if (dataSource != null) {
                dataSource.close();
                System.out.println("ğŸ”´ æ ¸å¿ƒèµ„æºï¼šæ•°æ®åº“å·²å…³é—­");
            }
        } catch (Exception e) {
            System.err.println("ğŸ’¥ ä¸¥é‡ï¼šæ•°æ®åº“å…³é—­å¤±è´¥ - " + e.getMessage());
        }
    }
    
    private void cleanupFiles() {
        try {
            if (logWriter != null) {
                logWriter.close();
                System.out.println("ğŸŸ¡ æ¬¡è¦èµ„æºï¼šæ–‡ä»¶å·²å…³é—­");
            }
        } catch (Exception e) {
            System.err.println("âš ï¸ è­¦å‘Šï¼šæ–‡ä»¶å…³é—­å¤±è´¥ - " + e.getMessage());
        }
    }
    
    private void cleanupCache() {
        try {
            if (localCache != null) {
                localCache.clear();
                System.out.println("ğŸŸ¢ å¯é€‰èµ„æºï¼šç¼“å­˜å·²æ¸…ç†");
            }
        } catch (Exception e) {
            System.err.println("â„¹ï¸ æç¤ºï¼šç¼“å­˜æ¸…ç†å¤±è´¥ - " + e.getMessage());
        }
    }
}
```

**ä¼˜å…ˆçº§åˆ’åˆ†åŸåˆ™**ï¼š
```
ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»æˆåŠŸï¼‰ï¼š
â€¢ æ•°æ®åº“è¿æ¥
â€¢ æ¶ˆæ¯é˜Ÿåˆ—è¿æ¥
â€¢ åˆ†å¸ƒå¼é”é‡Šæ”¾

ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå°½é‡æˆåŠŸï¼‰ï¼š
â€¢ æ–‡ä»¶å¥æŸ„
â€¢ ç½‘ç»œè¿æ¥
â€¢ ä¸´æ—¶èµ„æº

ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯ä»¥å¤±è´¥ï¼‰ï¼š
â€¢ æœ¬åœ°ç¼“å­˜
â€¢ æ—¥å¿—è¾“å‡º
â€¢ ç›‘æ§ä¸ŠæŠ¥
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é”€æ¯å›è°ƒæœ¬è´¨ï¼šBeanè¢«é”€æ¯å‰çš„"æœ€åæœºä¼š"ï¼Œç”¨äºé‡Šæ”¾èµ„æº
ğŸ”¸ ä¸‰ç§å®ç°æ–¹å¼ï¼šDisposableBeanã€destroy-methodã€@PreDestroy
ğŸ”¸ è§¦å‘æ—¶æœºï¼šå®¹å™¨å…³é—­æ—¶ï¼ˆæ‰‹åŠ¨closeæˆ–JVMå…³é—­é’©å­ï¼‰
ğŸ”¸ æ¸…ç†å¯¹è±¡ï¼šæ•°æ®åº“è¿æ¥ã€æ–‡ä»¶ã€çº¿ç¨‹æ± ã€ç½‘ç»œè¿æ¥ç­‰å¤–éƒ¨èµ„æº
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šå¿…é¡»æ•è·å¼‚å¸¸ï¼Œä¸èƒ½å½±å“å…¶ä»–Beané”€æ¯
```

### 7.2 å…³é”®å¯¹æ¯”ç†è§£


**ğŸ”¹ ä¸‰ç§æ–¹å¼çš„é€‰æ‹©**
```
åœºæ™¯1ï¼šæ–°é¡¹ç›®/Spring Boot
âœ… é¦–é€‰ @PreDestroy
â€¢ ä»£ç ç®€æ´
â€¢ æ ‡å‡†åŒ–
â€¢ æ˜“ç»´æŠ¤

åœºæ™¯2ï¼šéœ€è¦æ¡†æ¶æ— å…³æ€§  
âœ… é€‰æ‹© destroy-method
â€¢ çº¯POJO
â€¢ ä¸ä¾èµ–Spring
â€¢ å¯ç§»æ¤æ€§å¥½

åœºæ™¯3ï¼šå·²æœ‰Springé¡¹ç›®
âœ… ä½¿ç”¨ DisposableBean
â€¢ ä¸ç°æœ‰ä»£ç é£æ ¼ä¸€è‡´
â€¢ æ— éœ€ä¿®æ”¹é…ç½®
```

**ğŸ”¹ æ‰‹åŠ¨å…³é—­ vs è‡ªåŠ¨å…³é—­**
```
å¼€å‘/æµ‹è¯•ç¯å¢ƒï¼š
â€¢ æ‰‹åŠ¨è°ƒç”¨ context.close()
â€¢ å¯æ§æ€§å¼ºï¼Œä¾¿äºè°ƒè¯•

ç”Ÿäº§ç¯å¢ƒï¼š
â€¢ æ³¨å†Œ ShutdownHook
â€¢ è‡ªåŠ¨è§¦å‘ï¼Œæ›´å¯é 

Spring Bootåº”ç”¨ï¼š
â€¢ æ— éœ€æ‰‹åŠ¨å¤„ç†
â€¢ è‡ªåŠ¨æ³¨å†Œé’©å­
â€¢ æ”¯æŒä¼˜é›…å…³é—­
```

### 7.3 å®æˆ˜æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**
```
â‘  ä½¿ç”¨@PreDestroyæ³¨è§£ï¼ˆä»£ç ç®€æ´ï¼‰
â‘¡ æ¸…ç†æ–¹æ³•ä¸­æ•è·æ‰€æœ‰å¼‚å¸¸
â‘¢ æŒ‰ä¼˜å…ˆçº§æ¸…ç†èµ„æº
â‘£ ä¸åœ¨é”€æ¯æ–¹æ³•ä¸­ä¾èµ–å…¶ä»–Bean
â‘¤ ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å…³é—­é’©å­
â‘¥ çº¿ç¨‹æ± ä¼˜é›…å…³é—­ï¼ˆshutdown + awaitTerminationï¼‰
```

**âŒ é¿å…åšæ³•**
```
â‘  é”€æ¯æ–¹æ³•æŠ›å‡ºæœªæ•è·å¼‚å¸¸
â‘¡ åœ¨é”€æ¯æ–¹æ³•ä¸­è°ƒç”¨å…¶ä»–Bean
â‘¢ å¿˜è®°æ¸…ç†å¤–éƒ¨èµ„æº
â‘£ ç”Ÿäº§ç¯å¢ƒä¸æ³¨å†Œå…³é—­é’©å­
â‘¤ çº¿ç¨‹æ± ç›´æ¥shutdownNow()å¼ºåˆ¶å…³é—­
```

### 7.4 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **å¾®æœåŠ¡åº”ç”¨**ï¼šä¼˜é›…åœæœºï¼Œé¿å…è¯·æ±‚ä¸¢å¤±
- **æ‰¹å¤„ç†ä»»åŠ¡**ï¼šä¿å­˜ä¸­é—´çŠ¶æ€ï¼Œä¸‹æ¬¡ç»§ç»­
- **æ•°æ®åŒæ­¥æœåŠ¡**ï¼šå…³é—­è¿æ¥ï¼Œé‡Šæ”¾é”
- **å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ**ï¼šåœæ­¢è°ƒåº¦ï¼Œå®Œæˆå½“å‰ä»»åŠ¡

**ğŸ”§ å¸¸è§é—®é¢˜è§£å†³**
- **æ•°æ®åº“è¿æ¥æ³„æ¼** â†’ æ·»åŠ @PreDestroyå…³é—­è¿æ¥
- **çº¿ç¨‹æ— æ³•åœæ­¢** â†’ shutdown + awaitTerminationç»„åˆ
- **æ–‡ä»¶æ— æ³•åˆ é™¤** â†’ é”€æ¯å‰flushå’Œclose
- **åº”ç”¨æ— æ³•é€€å‡º** â†’ æ³¨å†ŒShutdownHook

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
é”€æ¯å›è°ƒä¸‰æ–¹å¼ï¼ŒPreDestroyæœ€æ¨è
èµ„æºæ¸…ç†è¦å½»åº•ï¼Œå¼‚å¸¸æ•è·ä¸èƒ½å°‘
ä¼˜å…ˆçº§åˆ«åˆ†ä¸‰æ¡£ï¼Œé‡è¦èµ„æºå…ˆå¤„ç†
å®¹å™¨å…³é—­è‡ªåŠ¨è§¦å‘ï¼Œé’©å­æ³¨å†Œæ›´å¯é 
```