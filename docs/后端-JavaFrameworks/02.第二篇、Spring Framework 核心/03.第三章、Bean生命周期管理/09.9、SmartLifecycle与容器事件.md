---
title: 9ã€SmartLifecycleä¸å®¹å™¨äº‹ä»¶
---
## ğŸ“š ç›®å½•

1. [SmartLifecycleæ¥å£æ¦‚è¿°](#1-SmartLifecycleæ¥å£æ¦‚è¿°)
2. [è‡ªåŠ¨å¯åŠ¨ä¸åœæ­¢æœºåˆ¶](#2-è‡ªåŠ¨å¯åŠ¨ä¸åœæ­¢æœºåˆ¶)
3. [é˜¶æ®µPhaseä¸é¡ºåºæ§åˆ¶](#3-é˜¶æ®µPhaseä¸é¡ºåºæ§åˆ¶)
4. [å®¹å™¨å¯åŠ¨äº‹ä»¶](#4-å®¹å™¨å¯åŠ¨äº‹ä»¶)
5. [å®¹å™¨å…³é—­äº‹ä»¶](#5-å®¹å™¨å…³é—­äº‹ä»¶)
6. [å®æˆ˜åº”ç”¨åœºæ™¯](#6-å®æˆ˜åº”ç”¨åœºæ™¯)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ SmartLifecycleæ¥å£æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯SmartLifecycle


> ğŸ’¡ **é€šä¿—ç†è§£**  
> æƒ³è±¡ä½ çš„åº”ç”¨æ˜¯ä¸€è¾†æ±½è½¦ï¼ŒSmartLifecycleå°±åƒæ˜¯"æ™ºèƒ½å¯åŠ¨ç³»ç»Ÿ"ã€‚æ™®é€šçš„Lifecycleåªèƒ½æ‰‹åŠ¨æ‰“ç«ï¼Œè€ŒSmartLifecycleå¯ä»¥è‡ªåŠ¨å¯åŠ¨å¼•æ“ï¼Œè¿˜èƒ½æ§åˆ¶å¯åŠ¨é¡ºåºï¼Œæ¯”å¦‚å…ˆå¯åŠ¨æ²¹æ³µï¼Œå†å¯åŠ¨å‘åŠ¨æœºã€‚

**SmartLifecycleæ¥å£**æ˜¯Springæä¾›çš„é«˜çº§ç”Ÿå‘½å‘¨æœŸç®¡ç†æ¥å£ï¼Œå®ƒæ‰©å±•äº†`Lifecycle`æ¥å£ï¼Œå¢åŠ äº†è‡ªåŠ¨å¯åŠ¨å’Œé¡ºåºæ§åˆ¶çš„èƒ½åŠ›ã€‚

```java
public interface SmartLifecycle extends Lifecycle, Phased {
    // æ˜¯å¦è‡ªåŠ¨å¯åŠ¨ï¼ˆé‡è¦ï¼ï¼‰
    default boolean isAutoStartup() {
        return true;
    }
    
    // åœæ­¢æ—¶çš„å›è°ƒï¼ˆå¯ä»¥åšæ¸…ç†å·¥ä½œï¼‰
    default void stop(Runnable callback) {
        stop();
        callback.run();
    }
    
    // å¯åŠ¨é˜¶æ®µï¼ˆæ§åˆ¶é¡ºåºï¼‰
    default int getPhase() {
        return DEFAULT_PHASE;
    }
}
```

### 1.2 SmartLifecycle vs æ™®é€šLifecycle


**å¯¹æ¯”ç†è§£**ï¼š

| ç‰¹æ€§ | **Lifecycle** | **SmartLifecycle** |
|------|--------------|-------------------|
| ğŸ“ **å¯åŠ¨æ–¹å¼** | `æ‰‹åŠ¨è°ƒç”¨start()` | `å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨` |
| ğŸ”„ **åœæ­¢æ–¹å¼** | `æ‰‹åŠ¨è°ƒç”¨stop()` | `å®¹å™¨å…³é—­æ—¶è‡ªåŠ¨åœæ­¢` |
| ğŸ“Š **é¡ºåºæ§åˆ¶** | `æ— æ³•æ§åˆ¶` | `é€šè¿‡phaseå€¼æ§åˆ¶é¡ºåº` |
| ğŸ¯ **å…¸å‹åœºæ™¯** | `éœ€è¦æ‰‹åŠ¨ç®¡ç†çš„ç»„ä»¶` | `éœ€è¦è‡ªåŠ¨ç®¡ç†çš„æœåŠ¡` |

**æ ¸å¿ƒåŒºåˆ«**ï¼š
- **æ™®é€šLifecycle**ï¼šåƒæ‰‹åŠ¨æŒ¡æ±½è½¦ï¼Œéœ€è¦ä½ è‡ªå·±æ“ä½œ
- **SmartLifecycle**ï¼šåƒè‡ªåŠ¨æŒ¡æ±½è½¦ï¼Œç³»ç»Ÿå¸®ä½ ç®¡ç†

---

## 2. âš¡ è‡ªåŠ¨å¯åŠ¨ä¸åœæ­¢æœºåˆ¶


### 2.1 è‡ªåŠ¨å¯åŠ¨åŸç†


**å·¥ä½œæµç¨‹**ï¼š

```
Springå®¹å™¨å¯åŠ¨
    â†“
æ£€æŸ¥æ‰€æœ‰Bean
    â†“
æ‰¾åˆ°SmartLifecycleç±»å‹çš„Bean
    â†“
åˆ¤æ–­isAutoStartup()æ˜¯å¦ä¸ºtrue
    â†“
æŒ‰phaseå€¼ä»å°åˆ°å¤§ä¾æ¬¡è°ƒç”¨start()
```

**å®ç°ç¤ºä¾‹**ï¼š

```java
@Component
public class DataSourceLifecycle implements SmartLifecycle {
    
    private boolean running = false;
    
    // âœ… å¯åŠ¨æ•°æ®åº“è¿æ¥æ± 
    @Override
    public void start() {
        System.out.println("ğŸ”Œ å¯åŠ¨æ•°æ®åº“è¿æ¥æ± ...");
        // åˆå§‹åŒ–è¿æ¥æ± 
        running = true;
        System.out.println("âœ… æ•°æ®åº“è¿æ¥æ± å¯åŠ¨å®Œæˆ");
    }
    
    // âœ… å…³é—­æ•°æ®åº“è¿æ¥æ± 
    @Override
    public void stop() {
        System.out.println("ğŸ”Œ å…³é—­æ•°æ®åº“è¿æ¥æ± ...");
        // é‡Šæ”¾è¿æ¥èµ„æº
        running = false;
        System.out.println("âœ… æ•°æ®åº“è¿æ¥æ± å·²å…³é—­");
    }
    
    @Override
    public boolean isRunning() {
        return running;
    }
    
    // ğŸ¯ å…³é”®ï¼šå¯ç”¨è‡ªåŠ¨å¯åŠ¨
    @Override
    public boolean isAutoStartup() {
        return true;  // å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨è°ƒç”¨start()
    }
}
```

### 2.2 ä¼˜é›…åœæ­¢æœºåˆ¶


**stop(Runnable callback)çš„ä½œç”¨**ï¼š

> ğŸ” **ä¸ºä»€ä¹ˆéœ€è¦å›è°ƒï¼Ÿ**  
> æœ‰äº›ç»„ä»¶åœæ­¢éœ€è¦æ—¶é—´ï¼ˆæ¯”å¦‚ä¿å­˜æ•°æ®ã€é‡Šæ”¾è¿æ¥ï¼‰ï¼Œç”¨å›è°ƒå¯ä»¥ç¡®ä¿åœæ­¢å®Œæˆåå†è¿›è¡Œä¸‹ä¸€æ­¥ã€‚

```java
@Component
public class CacheManager implements SmartLifecycle {
    
    @Override
    public void stop(Runnable callback) {
        System.out.println("ğŸ’¾ å¼€å§‹ä¿å­˜ç¼“å­˜æ•°æ®...");
        
        // å¼‚æ­¥ä¿å­˜ç¼“å­˜
        new Thread(() -> {
            try {
                // æ¨¡æ‹Ÿä¿å­˜ç¼“å­˜æ•°æ®ï¼ˆè€—æ—¶æ“ä½œï¼‰
                Thread.sleep(2000);
                System.out.println("âœ… ç¼“å­˜æ•°æ®ä¿å­˜å®Œæˆ");
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                // ğŸ¯ å…³é”®ï¼šåœæ­¢å®Œæˆåé€šçŸ¥å®¹å™¨
                callback.run();
            }
        }).start();
    }
    
    // ... å…¶ä»–æ–¹æ³•
}
```

**æ‰§è¡Œæ•ˆæœ**ï¼š

```
å®¹å™¨å…³é—­ä¸­...
ğŸ’¾ å¼€å§‹ä¿å­˜ç¼“å­˜æ•°æ®...
ï¼ˆç­‰å¾…2ç§’ï¼‰
âœ… ç¼“å­˜æ•°æ®ä¿å­˜å®Œæˆ
å®¹å™¨å…³é—­å®Œæˆ
```

---

## 3. ğŸ“Š é˜¶æ®µPhaseä¸é¡ºåºæ§åˆ¶


### 3.1 Phaseå€¼çš„å«ä¹‰


> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**  
> ç›–æˆ¿å­è¦å…ˆæ‰“åœ°åŸºï¼Œå†å»ºå¢™ï¼Œæœ€åè£…ä¿®ã€‚Phaseå€¼å°±åƒæ–½å·¥é¡ºåºç¼–å·ï¼š  
> - `phase = 1`ï¼šæ‰“åœ°åŸºï¼ˆæœ€å…ˆå¯åŠ¨ï¼‰  
> - `phase = 100`ï¼šå»ºå¢™ï¼ˆä¸­é—´å¯åŠ¨ï¼‰  
> - `phase = 1000`ï¼šè£…ä¿®ï¼ˆæœ€åå¯åŠ¨ï¼‰

**Phaseè§„åˆ™**ï¼š

```
å¯åŠ¨é¡ºåºï¼šphaseå€¼ä»å°åˆ°å¤§
    â†“
phase = -100 â†’ æœ€æ—©å¯åŠ¨
phase = 0    â†’ é»˜è®¤å¯åŠ¨
phase = 100  â†’ è¾ƒæ™šå¯åŠ¨
    â†“
åœæ­¢é¡ºåºï¼šphaseå€¼ä»å¤§åˆ°å°ï¼ˆåå‘ï¼‰
```

### 3.2 å¯åŠ¨é¡ºåºç¤ºä¾‹


**åœºæ™¯**ï¼šå…ˆå¯åŠ¨æ•°æ®åº“ï¼Œå†å¯åŠ¨ç¼“å­˜ï¼Œæœ€åå¯åŠ¨WebæœåŠ¡

```java
// 1ï¸âƒ£ æ•°æ®åº“è¿æ¥æ± ï¼ˆæœ€å…ˆå¯åŠ¨ï¼‰
@Component
public class DatabaseLifecycle implements SmartLifecycle {
    
    @Override
    public int getPhase() {
        return 100;  // æ•°å€¼å°ï¼Œä¼˜å…ˆå¯åŠ¨
    }
    
    @Override
    public void start() {
        System.out.println("1ï¸âƒ£ å¯åŠ¨æ•°æ®åº“è¿æ¥æ± ");
    }
    
    // ... å…¶ä»–æ–¹æ³•
}

// 2ï¸âƒ£ ç¼“å­˜æœåŠ¡ï¼ˆä¸­é—´å¯åŠ¨ï¼‰
@Component
public class CacheLifecycle implements SmartLifecycle {
    
    @Override
    public int getPhase() {
        return 200;  // åœ¨æ•°æ®åº“ä¹‹åå¯åŠ¨
    }
    
    @Override
    public void start() {
        System.out.println("2ï¸âƒ£ å¯åŠ¨ç¼“å­˜æœåŠ¡");
    }
    
    // ... å…¶ä»–æ–¹æ³•
}

// 3ï¸âƒ£ WebæœåŠ¡ï¼ˆæœ€åå¯åŠ¨ï¼‰
@Component
public class WebServerLifecycle implements SmartLifecycle {
    
    @Override
    public int getPhase() {
        return 300;  // æœ€åå¯åŠ¨
    }
    
    @Override
    public void start() {
        System.out.println("3ï¸âƒ£ å¯åŠ¨WebæœåŠ¡");
    }
    
    // ... å…¶ä»–æ–¹æ³•
}
```

**å¯åŠ¨è¾“å‡º**ï¼š

```
ğŸš€ å®¹å™¨å¯åŠ¨ä¸­...
1ï¸âƒ£ å¯åŠ¨æ•°æ®åº“è¿æ¥æ± 
2ï¸âƒ£ å¯åŠ¨ç¼“å­˜æœåŠ¡
3ï¸âƒ£ å¯åŠ¨WebæœåŠ¡
âœ… å®¹å™¨å¯åŠ¨å®Œæˆ
```

**å…³é—­è¾“å‡º**ï¼ˆé¡ºåºç›¸åï¼‰ï¼š

```
ğŸ›‘ å®¹å™¨å…³é—­ä¸­...
3ï¸âƒ£ å…³é—­WebæœåŠ¡
2ï¸âƒ£ å…³é—­ç¼“å­˜æœåŠ¡
1ï¸âƒ£ å…³é—­æ•°æ®åº“è¿æ¥æ± 
âœ… å®¹å™¨å…³é—­å®Œæˆ
```

### 3.3 Phaseå€¼æœ€ä½³å®è·µ


**æ¨èå€¼èŒƒå›´**ï¼š

```
ğŸ“‹ åŸºç¡€è®¾æ–½å±‚
- é…ç½®ä¸­å¿ƒï¼šphase = -1000
- æ•°æ®åº“è¿æ¥ï¼šphase = -500
- æ¶ˆæ¯é˜Ÿåˆ—ï¼šphase = -200

ğŸ“‹ æœåŠ¡å±‚
- ç¼“å­˜æœåŠ¡ï¼šphase = 0ï¼ˆé»˜è®¤ï¼‰
- ä¸šåŠ¡æœåŠ¡ï¼šphase = 100

ğŸ“‹ åº”ç”¨å±‚
- WebæœåŠ¡å™¨ï¼šphase = 500
- å®šæ—¶ä»»åŠ¡ï¼šphase = 1000
```

---

## 4. ğŸ“¢ å®¹å™¨å¯åŠ¨äº‹ä»¶


### 4.1 ContextRefreshedEvent


> ğŸ’¡ **é€šä¿—ç†è§£**  
> è¿™ä¸ªäº‹ä»¶å°±åƒ"å¼€ä¸šå…¸ç¤¼"é€šçŸ¥ï¼Œå½“Springå®¹å™¨å®Œå…¨å‡†å¤‡å¥½ï¼ˆæ‰€æœ‰Beanåˆå§‹åŒ–å®Œæˆï¼‰åï¼Œä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶å‘Šè¯‰å¤§å®¶"å¯ä»¥è¥ä¸šäº†"ã€‚

**äº‹ä»¶è§¦å‘æ—¶æœº**ï¼š

```
Springå®¹å™¨å¯åŠ¨æµç¨‹
    â†“
åˆ›å»ºæ‰€æœ‰Bean
    â†“
åˆå§‹åŒ–Beanï¼ˆ@PostConstructï¼‰
    â†“
æ‰§è¡ŒSmartLifecycle.start()
    â†“
ğŸ”” å‘å¸ƒContextRefreshedEvent
    â†“
åº”ç”¨å¯ä»¥æ­£å¸¸ä½¿ç”¨
```

**ç›‘å¬ç¤ºä¾‹**ï¼š

```java
@Component
public class StartupListener {
    
    // æ–¹å¼1ï¼šä½¿ç”¨@EventListeneræ³¨è§£ï¼ˆæ¨èï¼‰
    @EventListener
    public void onContextRefreshed(ContextRefreshedEvent event) {
        System.out.println("ğŸ‰ å®¹å™¨å¯åŠ¨å®Œæˆï¼å¼€å§‹æ‰§è¡Œå¯åŠ¨åä»»åŠ¡");
        
        // æ‰§è¡Œä¸€äº›å¯åŠ¨åçš„åˆå§‹åŒ–å·¥ä½œ
        loadInitialData();
        sendStartupNotification();
    }
    
    private void loadInitialData() {
        System.out.println("ğŸ“Š åŠ è½½åˆå§‹æ•°æ®...");
    }
    
    private void sendStartupNotification() {
        System.out.println("ğŸ“§ å‘é€å¯åŠ¨é€šçŸ¥...");
    }
}
```

**æ–¹å¼2ï¼šå®ç°ApplicationListeneræ¥å£**ï¼š

```java
@Component
public class StartupEventListener 
    implements ApplicationListener<ContextRefreshedEvent> {
    
    @Override
    public void onApplicationEvent(ContextRefreshedEvent event) {
        System.out.println("âœ… å®¹å™¨å¯åŠ¨äº‹ä»¶ç›‘å¬å™¨è§¦å‘");
        
        // è·å–å®¹å™¨ä¿¡æ¯
        ApplicationContext context = event.getApplicationContext();
        System.out.println("å®¹å™¨ID: " + context.getId());
        System.out.println("å¯åŠ¨æ—¶é—´: " + new Date(context.getStartupDate()));
    }
}
```

### 4.2 ContextStartedEvent


**ä¸ContextRefreshedEventçš„åŒºåˆ«**ï¼š

```
ContextRefreshedEventï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰
- å®¹å™¨å¯åŠ¨æˆ–åˆ·æ–°æ—¶è‡ªåŠ¨å‘å¸ƒ
- æœ€å¸¸ç”¨çš„å¯åŠ¨äº‹ä»¶
    â†“

ContextStartedEventï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
- éœ€è¦æ˜¾å¼è°ƒç”¨context.start()
- è¾ƒå°‘ä½¿ç”¨
```

**ä½¿ç”¨åœºæ™¯**ï¼š

```java
@Component
public class ManualStartListener {
    
    @EventListener
    public void onContextStarted(ContextStartedEvent event) {
        System.out.println("âš¡ æ‰‹åŠ¨å¯åŠ¨äº‹ä»¶è§¦å‘");
        // ä»…åœ¨æ‰‹åŠ¨è°ƒç”¨start()æ—¶æ‰§è¡Œçš„é€»è¾‘
    }
}

// æ‰‹åŠ¨è§¦å‘æ–¹å¼
public static void main(String[] args) {
    ConfigurableApplicationContext context = 
        SpringApplication.run(Application.class, args);
    
    // æ˜¾å¼è°ƒç”¨start()æ‰ä¼šè§¦å‘ContextStartedEvent
    context.start();
}
```

---

## 5. ğŸ›‘ å®¹å™¨å…³é—­äº‹ä»¶


### 5.1 ContextClosedEvent


> ğŸ’¡ **é€šä¿—ç†è§£**  
> è¿™ä¸ªäº‹ä»¶å°±åƒ"é—­åº—é€šçŸ¥"ï¼Œå½“Springå®¹å™¨å‡†å¤‡å…³é—­æ—¶ï¼Œä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶è®©å„ä¸ªç»„ä»¶åšå¥½æ”¶å°¾å·¥ä½œï¼ˆä¿å­˜æ•°æ®ã€é‡Šæ”¾èµ„æºç­‰ï¼‰ã€‚

**äº‹ä»¶è§¦å‘æ—¶æœº**ï¼š

```
åº”ç”¨å…³é—­ä¿¡å·ï¼ˆCtrl+Cæˆ–context.close()ï¼‰
    â†“
ğŸ”” å‘å¸ƒContextClosedEvent
    â†“
æ‰§è¡Œ@PreDestroyæ–¹æ³•
    â†“
æ‰§è¡ŒSmartLifecycle.stop()ï¼ˆphaseä»å¤§åˆ°å°ï¼‰
    â†“
é”€æ¯æ‰€æœ‰Bean
    â†“
å®¹å™¨å…³é—­å®Œæˆ
```

**ç›‘å¬ç¤ºä¾‹**ï¼š

```java
@Component
public class ShutdownListener {
    
    @EventListener
    public void onContextClosed(ContextClosedEvent event) {
        System.out.println("ğŸ›‘ å®¹å™¨å³å°†å…³é—­ï¼Œæ‰§è¡Œæ¸…ç†å·¥ä½œ");
        
        // ä¿å­˜æœªæŒä¹…åŒ–çš„æ•°æ®
        saveUnsavedData();
        
        // å…³é—­å¤–éƒ¨è¿æ¥
        closeExternalConnections();
        
        // å‘é€å…³é—­é€šçŸ¥
        sendShutdownNotification();
    }
    
    private void saveUnsavedData() {
        System.out.println("ğŸ’¾ ä¿å­˜æœªæŒä¹…åŒ–æ•°æ®");
    }
    
    private void closeExternalConnections() {
        System.out.println("ğŸ”Œ å…³é—­å¤–éƒ¨è¿æ¥");
    }
    
    private void sendShutdownNotification() {
        System.out.println("ğŸ“§ å‘é€å…³é—­é€šçŸ¥");
    }
}
```

### 5.2 ContextStoppedEvent


**ä½¿ç”¨åœºæ™¯**ï¼š

```java
@Component
public class StopListener {
    
    @EventListener
    public void onContextStopped(ContextStoppedEvent event) {
        System.out.println("â¸ï¸ å®¹å™¨å·²åœæ­¢ï¼ˆä½†æœªé”€æ¯ï¼‰");
        // æš‚åœç›¸å…³çš„æ¸…ç†å·¥ä½œ
    }
}

// è§¦å‘æ–¹å¼
context.stop();  // æš‚åœå®¹å™¨ï¼Œå¯ä»¥å†æ¬¡start()
context.close(); // å½»åº•å…³é—­ï¼Œä¸å¯æ¢å¤
```

### 5.3 ä¼˜é›…å…³é—­é…ç½®


**æ·»åŠ Shutdown Hook**ï¼š

```java
@SpringBootApplication
public class Application {
    
    public static void main(String[] args) {
        ConfigurableApplicationContext context = 
            SpringApplication.run(Application.class, args);
        
        // æ³¨å†Œå…³é—­é’©å­ï¼Œç¡®ä¿ä¼˜é›…å…³é—­
        context.registerShutdownHook();
    }
}
```

> âš ï¸ **é‡è¦æç¤º**  
> Spring Booté»˜è®¤å·²æ³¨å†ŒShutdown Hookï¼Œæ— éœ€æ‰‹åŠ¨æ·»åŠ ã€‚ä½†åœ¨éSpring Bootç¯å¢ƒä¸‹éœ€è¦æ‰‹åŠ¨æ³¨å†Œã€‚

---

## 6. ğŸ’¼ å®æˆ˜åº”ç”¨åœºæ™¯


### 6.1 åœºæ™¯1ï¼šå®šæ—¶ä»»åŠ¡ç®¡ç†


**éœ€æ±‚**ï¼šå®¹å™¨å¯åŠ¨åè‡ªåŠ¨å¼€å¯å®šæ—¶ä»»åŠ¡ï¼Œå…³é—­å‰åœæ­¢ä»»åŠ¡

```java
@Component
public class ScheduledTaskLifecycle implements SmartLifecycle {
    
    private ScheduledExecutorService scheduler;
    private boolean running = false;
    
    @Override
    public void start() {
        System.out.println("â° å¯åŠ¨å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨");
        
        scheduler = Executors.newScheduledThreadPool(5);
        
        // æ¯10ç§’æ‰§è¡Œä¸€æ¬¡
        scheduler.scheduleAtFixedRate(() -> {
            System.out.println("ğŸ”„ æ‰§è¡Œå®šæ—¶ä»»åŠ¡");
        }, 0, 10, TimeUnit.SECONDS);
        
        running = true;
    }
    
    @Override
    public void stop() {
        System.out.println("â° åœæ­¢å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨");
        
        scheduler.shutdown();
        try {
            if (!scheduler.awaitTermination(30, TimeUnit.SECONDS)) {
                scheduler.shutdownNow();
            }
        } catch (InterruptedException e) {
            scheduler.shutdownNow();
        }
        
        running = false;
    }
    
    @Override
    public boolean isRunning() {
        return running;
    }
    
    @Override
    public int getPhase() {
        return 1000; // è¾ƒæ™šå¯åŠ¨ï¼Œè¾ƒæ—©åœæ­¢
    }
}
```

### 6.2 åœºæ™¯2ï¼šæ¶ˆæ¯é˜Ÿåˆ—ç›‘å¬å™¨


**éœ€æ±‚**ï¼šç¡®ä¿æ¶ˆæ¯ç›‘å¬å™¨åœ¨æ•°æ®åº“ä¹‹åå¯åŠ¨

```java
@Component
public class MessageListenerLifecycle implements SmartLifecycle {
    
    @Autowired
    private MessageConsumer consumer;
    
    private boolean running = false;
    
    @Override
    public void start() {
        System.out.println("ğŸ“¨ å¯åŠ¨æ¶ˆæ¯ç›‘å¬å™¨");
        consumer.startListening();
        running = true;
    }
    
    @Override
    public void stop(Runnable callback) {
        System.out.println("ğŸ“¨ åœæ­¢æ¶ˆæ¯ç›‘å¬å™¨");
        
        // å¼‚æ­¥åœæ­¢ç›‘å¬å™¨
        consumer.stopListening(() -> {
            running = false;
            callback.run();
        });
    }
    
    @Override
    public boolean isRunning() {
        return running;
    }
    
    @Override
    public int getPhase() {
        return 200; // åœ¨æ•°æ®åº“(100)ä¹‹åå¯åŠ¨
    }
}
```

### 6.3 åœºæ™¯3ï¼šå¥åº·æ£€æŸ¥æœåŠ¡


**éœ€æ±‚**ï¼šå®¹å™¨å¯åŠ¨å®Œæˆåå¼€å§‹å¥åº·æ£€æŸ¥

```java
@Component
public class HealthCheckService {
    
    @EventListener
    public void onApplicationReady(ContextRefreshedEvent event) {
        System.out.println("ğŸ¥ å¼€å§‹å¥åº·æ£€æŸ¥");
        
        checkDatabaseConnection();
        checkCacheConnection();
        checkExternalServices();
        
        System.out.println("âœ… å¥åº·æ£€æŸ¥å®Œæˆ");
    }
    
    private void checkDatabaseConnection() {
        System.out.println("  ğŸ” æ£€æŸ¥æ•°æ®åº“è¿æ¥...");
        // æ•°æ®åº“è¿æ¥æ£€æŸ¥é€»è¾‘
    }
    
    private void checkCacheConnection() {
        System.out.println("  ğŸ” æ£€æŸ¥ç¼“å­˜è¿æ¥...");
        // ç¼“å­˜è¿æ¥æ£€æŸ¥é€»è¾‘
    }
    
    private void checkExternalServices() {
        System.out.println("  ğŸ” æ£€æŸ¥å¤–éƒ¨æœåŠ¡...");
        // å¤–éƒ¨æœåŠ¡æ£€æŸ¥é€»è¾‘
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ SmartLifecycleï¼šè‡ªåŠ¨ç®¡ç†Beançš„å¯åŠ¨å’Œåœæ­¢
ğŸ”¸ isAutoStartup()ï¼šæ§åˆ¶æ˜¯å¦è‡ªåŠ¨å¯åŠ¨
ğŸ”¸ getPhase()ï¼šæ§åˆ¶å¯åŠ¨å’Œåœæ­¢çš„é¡ºåº
ğŸ”¸ stop(Runnable)ï¼šæ”¯æŒå¼‚æ­¥ä¼˜é›…åœæ­¢
ğŸ”¸ ContextRefreshedEventï¼šå®¹å™¨å¯åŠ¨å®Œæˆäº‹ä»¶
ğŸ”¸ ContextClosedEventï¼šå®¹å™¨å…³é—­äº‹ä»¶
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¯åŠ¨é¡ºåºè§„åˆ™**

```
å¯åŠ¨ï¼šphaseå€¼å° â†’ å¤§
   â†“
100 â†’ 200 â†’ 300

åœæ­¢ï¼šphaseå€¼å¤§ â†’ å°ï¼ˆåå‘ï¼‰
   â†“
300 â†’ 200 â†’ 100
```

**ğŸ”¹ äº‹ä»¶è§¦å‘æ—¶æœº**

```
å®¹å™¨å¯åŠ¨æµç¨‹ï¼š
åˆ›å»ºBean â†’ åˆå§‹åŒ– â†’ start() â†’ ContextRefreshedEvent

å®¹å™¨å…³é—­æµç¨‹ï¼š
ContextClosedEvent â†’ @PreDestroy â†’ stop() â†’ é”€æ¯Bean
```

**ğŸ”¹ é€‰æ‹©åˆé€‚çš„æ–¹å¼**

| éœ€æ±‚ | **æ¨èæ–¹å¼** | **åŸå› ** |
|-----|------------|---------|
| ğŸ¯ è‡ªåŠ¨å¯åŠ¨åœæ­¢ | `SmartLifecycle` | `å®¹å™¨è‡ªåŠ¨ç®¡ç†` |
| ğŸ¯ æ§åˆ¶å¯åŠ¨é¡ºåº | `è®¾ç½®phaseå€¼` | `ä¾èµ–å…³ç³»æ˜ç¡®` |
| ğŸ¯ å¯åŠ¨åæ‰§è¡Œä»»åŠ¡ | `@EventListener` | `ç®€å•ç›´æ¥` |
| ğŸ¯ ä¼˜é›…å…³é—­ | `stop(Runnable)` | `æ”¯æŒå¼‚æ­¥æ¸…ç†` |

### 7.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ“Œ Phaseå€¼è§„åˆ’**

```
âœ… åŸºç¡€è®¾æ–½ï¼šè´Ÿæ•°phaseï¼ˆ-1000 ~ -1ï¼‰
âœ… ä¸šåŠ¡æœåŠ¡ï¼š0 ~ 500
âœ… åº”ç”¨å±‚ï¼š500 ~ 1000
âœ… é¢„ç•™æ‰©å±•ï¼šä½¿ç”¨100çš„å€æ•°ï¼Œæ–¹ä¾¿æ’å…¥
```

**ğŸ“Œ å¼‚æ­¥åœæ­¢æ¨¡æ¿**

```java
@Override
public void stop(Runnable callback) {
    CompletableFuture.runAsync(() -> {
        try {
            // æ¸…ç†èµ„æº
        } finally {
            callback.run(); // ç¡®ä¿å›è°ƒæ‰§è¡Œ
        }
    });
}
```

**ğŸ“Œ äº‹ä»¶ç›‘å¬å™¨ä¼˜åŒ–**

```java
// âœ… æ¨èï¼šä½¿ç”¨@EventListener
@EventListener
public void onStartup(ContextRefreshedEvent event) {
    // å¤„ç†é€»è¾‘
}

// âŒ é¿å…ï¼šè¿‡äºå¤æ‚çš„ç›‘å¬é€»è¾‘
@EventListener
public void onStartup(ContextRefreshedEvent event) {
    // å¤æ‚é€»è¾‘åº”è¯¥å¼‚æ­¥æ‰§è¡Œ
    CompletableFuture.runAsync(() -> {
        // è€—æ—¶æ“ä½œ
    });
}
```

### 7.4 å¸¸è§é—®é¢˜ä¸è§£å†³


**â“ ä¸ºä»€ä¹ˆæˆ‘çš„SmartLifecycleæ²¡æœ‰è‡ªåŠ¨å¯åŠ¨ï¼Ÿ**

```
æ£€æŸ¥æ¸…å•ï¼š
âœ… isAutoStartup()è¿”å›true
âœ… Beanå·²æ³¨å†Œåˆ°å®¹å™¨ï¼ˆæœ‰@Componentç­‰æ³¨è§£ï¼‰
âœ… å®¹å™¨å·²å®Œå…¨å¯åŠ¨
```

**â“ å¯åŠ¨é¡ºåºæ··ä¹±æ€ä¹ˆåŠï¼Ÿ**

```
è§£å†³æ–¹æ¡ˆï¼š
âœ… æ£€æŸ¥phaseå€¼è®¾ç½®
âœ… ç¡®ä¿ä¾èµ–çš„Beanæœ‰æ›´å°çš„phaseå€¼
âœ… ä½¿ç”¨@DependsOnæ³¨è§£è¾…åŠ©
```

**â“ å…³é—­æ—¶å‡ºç°å¼‚å¸¸æ€ä¹ˆåŠï¼Ÿ**

```
æœ€ä½³å®è·µï¼š
âœ… åœ¨stop()ä¸­æ·»åŠ å¼‚å¸¸æ•è·
âœ… ä½¿ç”¨try-finallyç¡®ä¿èµ„æºé‡Šæ”¾
âœ… è®°å½•å…³é—­è¿‡ç¨‹æ—¥å¿—
```

**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Smartæ¥å£çœŸæ™ºèƒ½ï¼Œè‡ªåŠ¨å¯åœä¸ç”¨ç®¡
- Phaseæ•°å€¼å®šé¡ºåºï¼Œå°å…ˆå¤§åè¦è®°ç‰¢
- äº‹ä»¶ç›‘å¬å¾ˆæ–¹ä¾¿ï¼Œå¯åŠ¨å…³é—­éƒ½èƒ½æ„ŸçŸ¥
- ä¼˜é›…åœæ­¢ç”¨å›è°ƒï¼Œå¼‚æ­¥æ¸…ç†æ›´å¯é 