---
title: 20ã€PlatformTransactionManagerç¼–ç¨‹
---
## ğŸ“š ç›®å½•

1. [PlatformTransactionManageræ˜¯ä»€ä¹ˆ](#1-platformtransactionmanageræ˜¯ä»€ä¹ˆ)
2. [ä¸‰å¤§æ ¸å¿ƒæ–¹æ³•è¯¦è§£](#2-ä¸‰å¤§æ ¸å¿ƒæ–¹æ³•è¯¦è§£)
3. [TransactionDefinitionäº‹åŠ¡å®šä¹‰](#3-transactiondefinitionäº‹åŠ¡å®šä¹‰)
4. [TransactionStatusäº‹åŠ¡çŠ¶æ€](#4-transactionstatusäº‹åŠ¡çŠ¶æ€)
5. [æ‰‹åŠ¨äº‹åŠ¡æ§åˆ¶å®æˆ˜](#5-æ‰‹åŠ¨äº‹åŠ¡æ§åˆ¶å®æˆ˜)
6. [èµ„æºç®¡ç†ä¸æœ€ä½³å®è·µ](#6-èµ„æºç®¡ç†ä¸æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ PlatformTransactionManageræ˜¯ä»€ä¹ˆ


### 1.1 é€šä¿—ç†è§£äº‹åŠ¡ç®¡ç†å™¨


**ğŸ¤” ä»€ä¹ˆæ˜¯PlatformTransactionManagerï¼Ÿ**

ç®€å•æ¥è¯´ï¼Œå®ƒå°±æ˜¯Springæ¡†æ¶ä¸­**æ‰‹åŠ¨æ§åˆ¶äº‹åŠ¡çš„å·¥å…·**ï¼Œå°±åƒä½ å¼€è½¦æ—¶çš„æ–¹å‘ç›˜å’Œåˆ¹è½¦ï¼š

```
æ—¥å¸¸ç”Ÿæ´»ç±»æ¯”ï¼š
é“¶è¡Œè½¬è´¦æ“ä½œ â†’ ä½ äº²è‡ªå»é“¶è¡ŒæŸœå°åŠç†
- å‘Šè¯‰æŸœå‘˜ï¼šæˆ‘è¦è½¬è´¦ï¼ˆå¼€å¯äº‹åŠ¡ï¼‰
- æŸœå‘˜æ“ä½œï¼šæ‰£æ¬¾ã€è½¬è´¦ï¼ˆæ‰§è¡Œæ“ä½œï¼‰
- ä½ ç¡®è®¤ï¼šæ²¡é—®é¢˜ï¼Œå®Œæˆï¼ï¼ˆæäº¤äº‹åŠ¡ï¼‰
- æˆ–è€…è¯´ï¼šç­‰ç­‰ï¼Œæˆ‘ä¸è½¬äº†ï¼ï¼ˆå›æ»šäº‹åŠ¡ï¼‰

PlatformTransactionManagerå°±æ˜¯è¿™ä¸ª"æŸœå‘˜"ï¼
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç¼–ç¨‹å¼äº‹åŠ¡


**ğŸ’¡ å£°æ˜å¼ vs ç¼–ç¨‹å¼å¯¹æ¯”**

| å¯¹æ¯”ç»´åº¦ | **å£°æ˜å¼äº‹åŠ¡(@Transactional)** | **ç¼–ç¨‹å¼äº‹åŠ¡(æ‰‹åŠ¨æ§åˆ¶)** |
|---------|-------------------------------|------------------------|
| ğŸ“ ä½¿ç”¨æ–¹å¼ | `ä¸€ä¸ªæ³¨è§£æå®šï¼Œç®€å•æ–¹ä¾¿` | `æ‰‹åŠ¨å†™ä»£ç æ§åˆ¶ï¼Œçµæ´»ç²¾å‡†` |
| ğŸ¯ æ§åˆ¶ç²’åº¦ | `æ•´ä¸ªæ–¹æ³•çº§åˆ«æ§åˆ¶` | `å¯ä»¥ç²¾ç¡®åˆ°ä»£ç å—çº§åˆ«` |
| ğŸ”§ çµæ´»æ€§ | `é…ç½®å›ºå®šï¼Œä¸å¤Ÿçµæ´»` | `æƒ³æ€ä¹ˆæ§åˆ¶å°±æ€ä¹ˆæ§åˆ¶` |
| ğŸ“Š é€‚ç”¨åœºæ™¯ | `90%çš„å¸¸è§„ä¸šåŠ¡` | `å¤æ‚ä¸šåŠ¡é€»è¾‘ã€éœ€è¦ç²¾ç»†æ§åˆ¶` |

**ä»€ä¹ˆæ—¶å€™ç”¨ç¼–ç¨‹å¼äº‹åŠ¡ï¼Ÿ**
- âœ… éœ€è¦åœ¨**æ–¹æ³•ä¸­é—´æŸä¸ªä½ç½®**å¼€å¯äº‹åŠ¡
- âœ… éœ€è¦**å¤šä¸ªç‹¬ç«‹çš„äº‹åŠ¡**åœ¨ä¸€ä¸ªæ–¹æ³•é‡Œ
- âœ… éœ€è¦**åŠ¨æ€å†³å®š**æ˜¯å¦å¼€å¯äº‹åŠ¡
- âœ… éœ€è¦**æ›´ç²¾ç»†çš„å¼‚å¸¸å¤„ç†**æ§åˆ¶

### 1.3 æ ¸å¿ƒæ¥å£ç»“æ„å›¾


```
PlatformTransactionManagerï¼ˆäº‹åŠ¡ç®¡ç†å™¨æ ¸å¿ƒæ¥å£ï¼‰
            |
            |-- å®šä¹‰ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•
            |
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    |                |              |
getTransaction()  commit()      rollback()
 å¼€å¯äº‹åŠ¡          æäº¤äº‹åŠ¡        å›æ»šäº‹åŠ¡
    |                |              |
    â†“                â†“              â†“
è¿”å›TransactionStatuså¯¹è±¡
ï¼ˆè®°å½•äº‹åŠ¡çŠ¶æ€ä¿¡æ¯ï¼‰
```

**ğŸ”¸ å¸¸è§å®ç°ç±»ï¼š**
- `DataSourceTransactionManager` â†’ JDBC/MyBatisç”¨è¿™ä¸ª
- `HibernateTransactionManager` â†’ Hibernateç”¨è¿™ä¸ª  
- `JpaTransactionManager` â†’ JPAç”¨è¿™ä¸ª
- `JtaTransactionManager` â†’ åˆ†å¸ƒå¼äº‹åŠ¡ç”¨è¿™ä¸ª

---

## 2. ğŸ”§ ä¸‰å¤§æ ¸å¿ƒæ–¹æ³•è¯¦è§£


### 2.1 getTransaction - å¼€å¯äº‹åŠ¡


**ğŸ“Œ æ–¹æ³•ç­¾å**
```java
TransactionStatus getTransaction(TransactionDefinition definition)
```

**ğŸ¤” è¿™ä¸ªæ–¹æ³•åœ¨å¹²ä»€ä¹ˆï¼Ÿ**

æƒ³è±¡ä½ å»é“¶è¡ŒåŠä¸šåŠ¡ï¼š
1. **å‘Šè¯‰æŸœå‘˜ä½ çš„éœ€æ±‚**ï¼ˆä¼ å…¥TransactionDefinitionå®šä¹‰ï¼‰
   - æˆ‘è¦ä»€ä¹ˆéš”ç¦»çº§åˆ«ï¼Ÿ
   - æˆ‘è¦ä»€ä¹ˆä¼ æ’­è¡Œä¸ºï¼Ÿ
   - è¶…æ—¶æ—¶é—´æ˜¯å¤šå°‘ï¼Ÿ

2. **æŸœå‘˜ç»™ä½ ä¸€ä¸ªå·ç ç‰Œ**ï¼ˆè¿”å›TransactionStatusï¼‰
   - è¿™ä¸ªå·ç ç‰Œè®°å½•äº†ä½ è¿™æ¬¡ä¸šåŠ¡çš„æ‰€æœ‰ä¿¡æ¯
   - åç»­æäº¤æˆ–å–æ¶ˆéƒ½è¦ç”¨è¿™ä¸ªå·ç ç‰Œ

**ğŸ’» åŸºç¡€ä½¿ç”¨ç¤ºä¾‹**

```java
// 1. åˆ›å»ºäº‹åŠ¡å®šä¹‰
DefaultTransactionDefinition def = new DefaultTransactionDefinition();
def.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED);

// 2. å¼€å¯äº‹åŠ¡ï¼Œæ‹¿åˆ°"å·ç ç‰Œ"
TransactionStatus status = transactionManager.getTransaction(def);
```

**âš¡ é‡è¦ç‰¹æ€§è¯´æ˜**

> **ğŸ”¸ ä¸æ˜¯æ¯æ¬¡éƒ½åˆ›å»ºæ–°äº‹åŠ¡ï¼**
> 
> è¿™ä¸ªæ–¹æ³•å¾ˆèªæ˜ï¼Œä¼šæ ¹æ®å½“å‰æƒ…å†µå†³å®šï¼š
> - å¦‚æœå½“å‰**æ²¡æœ‰äº‹åŠ¡** â†’ åˆ›å»ºæ–°äº‹åŠ¡
> - å¦‚æœå½“å‰**å·²æœ‰äº‹åŠ¡** â†’ æ ¹æ®ä¼ æ’­è¡Œä¸ºå†³å®šï¼ˆåŠ å…¥ã€æŒ‚èµ·ã€æŠ›å¼‚å¸¸ç­‰ï¼‰

### 2.2 commit - æäº¤äº‹åŠ¡


**ğŸ“Œ æ–¹æ³•ç­¾å**
```java
void commit(TransactionStatus status)
```

**ğŸ¤” æäº¤äº‹åŠ¡åšäº†ä»€ä¹ˆï¼Ÿ**

```
æ‰§è¡Œæµç¨‹ï¼š
ç”¨æˆ·ä»£ç æ‰§è¡Œå®Œæ¯•
    â†“
è°ƒç”¨commit(status)
    â†“
æ£€æŸ¥äº‹åŠ¡çŠ¶æ€
    â†“
â”Œâ”€ æœ‰å¼‚å¸¸æ ‡è®°ï¼Ÿ â”€â”€â”€â”€â”€â†’ æ‰§è¡Œrollback
â”‚                      
â””â”€ æ²¡æœ‰é—®é¢˜ï¼Ÿ â”€â”€â”€â”€â”€â”€â”€â”€â†’ æäº¤åˆ°æ•°æ®åº“
                       â†“
                   é‡Šæ”¾èµ„æºè¿æ¥
```

**ğŸ’» åŸºæœ¬ç”¨æ³•**

```java
try {
    // å¼€å¯äº‹åŠ¡
    TransactionStatus status = transactionManager.getTransaction(def);
    
    // æ‰§è¡Œä¸šåŠ¡ä»£ç 
    userDao.save(user);
    orderDao.save(order);
    
    // âœ… ä¸€åˆ‡æ­£å¸¸ï¼Œæäº¤äº‹åŠ¡
    transactionManager.commit(status);
    
} catch (Exception e) {
    // å¤„ç†å¼‚å¸¸...
}
```

**ğŸš¨ å…³é”®æ³¨æ„ç‚¹**

> **âš ï¸ commitä¸æ˜¯100%æäº¤æˆåŠŸçš„ï¼**
> 
> - å¦‚æœäº‹åŠ¡è¢«æ ‡è®°ä¸º`rollback-only` â†’ commitæ—¶ä¹Ÿä¼šå›æ»š
> - å¦‚æœæ•°æ®åº“è¿æ¥å¼‚å¸¸ â†’ commitä¼šå¤±è´¥
> - å¦‚æœæœ‰åµŒå¥—äº‹åŠ¡é—®é¢˜ â†’ å¯èƒ½åªæ˜¯æ ‡è®°ï¼Œä¸æ˜¯çœŸæ­£æäº¤

### 2.3 rollback - å›æ»šäº‹åŠ¡


**ğŸ“Œ æ–¹æ³•ç­¾å**
```java
void rollback(TransactionStatus status)
```

**ğŸ¤” å›æ»šæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ**

å°±åƒ"æ’¤é”€"æŒ‰é’®ï¼š

```
ä¸šåŠ¡æ‰§è¡Œä¸­...
    â†“
å‘ç°é—®é¢˜ï¼ï¼ˆå¼‚å¸¸ã€æ ¡éªŒå¤±è´¥ç­‰ï¼‰
    â†“
è°ƒç”¨rollback(status)
    â†“
â”Œâ”€ ç‰©ç†å›æ»šï¼šæ’¤é”€æ‰€æœ‰æ•°æ®åº“æ“ä½œ
â”‚   - DELETEå·²INSERTçš„æ•°æ®
â”‚   - æ¢å¤å·²UPDATEçš„æ•°æ®
â”‚   - é‡Šæ”¾å·²LOCKçš„èµ„æº
â”‚
â””â”€ é€»è¾‘å›æ»šï¼šæ ‡è®°äº‹åŠ¡çŠ¶æ€
    - è®¾ç½®rollback-onlyæ ‡è®°
    - å¤–å±‚äº‹åŠ¡çœ‹åˆ°æ ‡è®°åä¹Ÿå›æ»š
```

**ğŸ’» å®Œæ•´ä½¿ç”¨æ¨¡æ¿**

```java
TransactionStatus status = null;
try {
    // 1. å¼€å¯äº‹åŠ¡
    status = transactionManager.getTransaction(def);
    
    // 2. æ‰§è¡Œä¸šåŠ¡
    accountDao.deduct(fromId, amount);  // æ‰£æ¬¾
    accountDao.add(toId, amount);       // åŠ æ¬¾
    
    // 3. æäº¤äº‹åŠ¡
    transactionManager.commit(status);
    
} catch (Exception e) {
    // 4. å‡ºé”™å°±å›æ»š
    if (status != null) {
        transactionManager.rollback(status);
    }
    throw e;  // ç»§ç»­æŠ›å‡ºå¼‚å¸¸
}
```

---

## 3. ğŸ“‹ TransactionDefinitionäº‹åŠ¡å®šä¹‰


### 3.1 ä»€ä¹ˆæ˜¯TransactionDefinition


**ğŸ¯ é€šä¿—ç†è§£**

å®ƒå°±æ˜¯"**äº‹åŠ¡é…ç½®å•**"ï¼Œç”¨æ¥å‘Šè¯‰äº‹åŠ¡ç®¡ç†å™¨ï¼š
- ğŸ”¸ æˆ‘è¦ä»€ä¹ˆæ ·çš„éš”ç¦»çº§åˆ«ï¼Ÿï¼ˆé˜²æ­¢è„è¯»ã€å¹»è¯»ï¼‰
- ğŸ”¸ æˆ‘è¦ä»€ä¹ˆä¼ æ’­è¡Œä¸ºï¼Ÿï¼ˆé‡åˆ°å·²æœ‰äº‹åŠ¡æ€ä¹ˆåŠï¼‰
- ğŸ”¸ æˆ‘è¦è®¾ç½®è¶…æ—¶æ—¶é—´å—ï¼Ÿï¼ˆé˜²æ­¢é•¿æ—¶é—´é”å®šï¼‰
- ğŸ”¸ è¿™ä¸ªäº‹åŠ¡æ˜¯åªè¯»çš„å—ï¼Ÿï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰

### 3.2 äº”å¤§æ ¸å¿ƒå±æ€§è¯¦è§£


#### ğŸ”¹ éš”ç¦»çº§åˆ« (Isolation Level)


**ä½œç”¨ï¼šæ§åˆ¶äº‹åŠ¡ä¹‹é—´çš„æ•°æ®å¯è§æ€§**

| éš”ç¦»çº§åˆ« | **è¯´æ˜** | **èƒ½é˜²æ­¢çš„é—®é¢˜** | **æ€§èƒ½** |
|---------|---------|----------------|---------|
| `DEFAULT` | `ä½¿ç”¨æ•°æ®åº“é»˜è®¤éš”ç¦»çº§åˆ«` | `è·Ÿéšæ•°æ®åº“è®¾ç½®` | `â€”` |
| `READ_UNCOMMITTED` | `å¯ä»¥è¯»åˆ°æœªæäº¤çš„æ•°æ®` | `âŒ ä»€ä¹ˆéƒ½é˜²ä¸äº†` | `ğŸš€ æœ€å¿«` |
| `READ_COMMITTED` | `åªèƒ½è¯»å·²æäº¤çš„æ•°æ®` | `âœ… è„è¯»` | `âš¡ è¾ƒå¿«` |
| `REPEATABLE_READ` | `é‡å¤è¯»å–ç»“æœä¸€è‡´` | `âœ… è„è¯»ã€ä¸å¯é‡å¤è¯»` | `ğŸ“Š ä¸€èˆ¬` |
| `SERIALIZABLE` | `ä¸²è¡Œæ‰§è¡Œï¼Œæœ€ä¸¥æ ¼` | `âœ… è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»` | `ğŸŒ æœ€æ…¢` |

**ğŸ’» ä»£ç è®¾ç½®**

```java
DefaultTransactionDefinition def = new DefaultTransactionDefinition();

// è®¾ç½®è¯»å·²æäº¤ï¼ˆæœ€å¸¸ç”¨ï¼‰
def.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED);

// MySQLé»˜è®¤æ˜¯REPEATABLE_READï¼ŒOracleé»˜è®¤æ˜¯READ_COMMITTED
```

#### ğŸ”¹ ä¼ æ’­è¡Œä¸º (Propagation Behavior)


**ä½œç”¨ï¼šå½“å‰äº‹åŠ¡é‡åˆ°å·²æœ‰äº‹åŠ¡æ—¶æ€ä¹ˆåŠ**

**å¸¸ç”¨çš„ä¸‰ç§ï¼š**

**â‘  REQUIREDï¼ˆæœ€å¸¸ç”¨ï¼Œé»˜è®¤ï¼‰**
```
åœºæ™¯ï¼šæ–¹æ³•Aè°ƒç”¨æ–¹æ³•B
    
æ–¹æ³•Aæœ‰äº‹åŠ¡          æ–¹æ³•Aæ— äº‹åŠ¡
    â†“                  â†“
æ–¹æ³•BåŠ å…¥Açš„äº‹åŠ¡    æ–¹æ³•Bæ–°å»ºäº‹åŠ¡
    â†“                  â†“
å…±ç”¨ä¸€ä¸ªäº‹åŠ¡        Bç‹¬ç«‹äº‹åŠ¡
```

**â‘¡ REQUIRES_NEWï¼ˆç‹¬ç«‹æ–°äº‹åŠ¡ï¼‰**
```
åœºæ™¯ï¼šè®°å½•æ—¥å¿—ï¼Œæ— è®ºä¸»ä¸šåŠ¡æˆåŠŸå¤±è´¥éƒ½è¦ä¿å­˜
    
æ–¹æ³•Aæœ‰äº‹åŠ¡
    â†“
æ–¹æ³•BæŒ‚èµ·Açš„äº‹åŠ¡ï¼Œè‡ªå·±æ–°å»º
    â†“
Bæäº¤/å›æ»šä¸å½±å“A
Aæäº¤/å›æ»šä¸å½±å“B
```

**â‘¢ SUPPORTSï¼ˆå¯æœ‰å¯æ— ï¼‰**
```
åœºæ™¯ï¼šæŸ¥è¯¢æ“ä½œï¼Œæœ‰äº‹åŠ¡å°±ç”¨ï¼Œæ²¡æœ‰ä¹Ÿè¡Œ
    
æ–¹æ³•Aæœ‰äº‹åŠ¡          æ–¹æ³•Aæ— äº‹åŠ¡
    â†“                  â†“
æ–¹æ³•BåŠ å…¥Açš„äº‹åŠ¡    æ–¹æ³•Bä¸ç”¨äº‹åŠ¡
```

**ğŸ’» ä»£ç ç¤ºä¾‹**

```java
// 1. å¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼ˆé»˜è®¤ï¼‰
def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);

// 2. æ€»æ˜¯æ–°å»ºç‹¬ç«‹äº‹åŠ¡
def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRES_NEW);

// 3. æ”¯æŒäº‹åŠ¡ï¼Œä½†ä¸æ˜¯å¿…é¡»çš„
def.setPropagationBehavior(TransactionDefinition.PROPAGATION_SUPPORTS);
```

#### ğŸ”¹ è¶…æ—¶æ—¶é—´ (Timeout)


**ä½œç”¨ï¼šé˜²æ­¢äº‹åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿**

```java
// è®¾ç½®30ç§’è¶…æ—¶
def.setTimeout(30);

// å®é™…æ•ˆæœï¼š
æ‰§è¡Œä¸šåŠ¡ä»£ç ...
    â†“
å¦‚æœ30ç§’è¿˜æ²¡å®Œæˆ
    â†“
è‡ªåŠ¨å›æ»šäº‹åŠ¡ + æŠ›å‡ºå¼‚å¸¸
```

#### ğŸ”¹ åªè¯»æ ‡è®° (Read-only)


**ä½œç”¨ï¼šå‘Šè¯‰æ•°æ®åº“è¿™æ˜¯æŸ¥è¯¢æ“ä½œï¼Œå¯ä»¥ä¼˜åŒ–**

```java
// æ ‡è®°ä¸ºåªè¯»äº‹åŠ¡
def.setReadOnly(true);

// æ•°æ®åº“ä¼šåšä»€ä¹ˆä¼˜åŒ–ï¼Ÿ
// - ä¸åŠ å†™é”
// - ä¸è®°å½•å®Œæ•´çš„äº‹åŠ¡æ—¥å¿—
// - å¯èƒ½ä½¿ç”¨å¿«ç…§è¯»
```

**ğŸš¨ æ³¨æ„ï¼šåªè¯»äº‹åŠ¡é‡Œä¸èƒ½æœ‰å¢åˆ æ”¹æ“ä½œï¼**

### 3.3 å¿«é€Ÿåˆ›å»ºTransactionDefinition


```java
// æ–¹å¼1ï¼šä½¿ç”¨é»˜è®¤é…ç½®
TransactionDefinition def = new DefaultTransactionDefinition();

// æ–¹å¼2ï¼šæ„é€ æ—¶æŒ‡å®šä¼ æ’­è¡Œä¸º
TransactionDefinition def = new DefaultTransactionDefinition(
    TransactionDefinition.PROPAGATION_REQUIRES_NEW
);

// æ–¹å¼3ï¼šé“¾å¼è®¾ç½®å¤šä¸ªå±æ€§
DefaultTransactionDefinition def = new DefaultTransactionDefinition();
def.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED);
def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);
def.setTimeout(30);
def.setReadOnly(false);
```

---

## 4. ğŸ“Š TransactionStatusäº‹åŠ¡çŠ¶æ€


### 4.1 TransactionStatusæ˜¯ä»€ä¹ˆ


**ğŸ¯ æ ¸å¿ƒä½œç”¨**

å°±åƒ**ä¸šåŠ¡åŠç†çš„å›æ‰§å•**ï¼Œè®°å½•äº†å½“å‰äº‹åŠ¡çš„æ‰€æœ‰çŠ¶æ€ä¿¡æ¯ï¼š

```
TransactionStatusï¼ˆäº‹åŠ¡çŠ¶æ€å¯¹è±¡ï¼‰
    |
    |-- è¿™æ˜¯æ–°äº‹åŠ¡å—ï¼Ÿ
    |-- æœ‰ä¿å­˜ç‚¹å—ï¼Ÿ
    |-- å·²ç»å®Œæˆäº†å—ï¼Ÿ
    |-- è¢«æ ‡è®°å›æ»šäº†å—ï¼Ÿ
    |
    â””â”€â”€ è¿™äº›ä¿¡æ¯ç”¨äºcommit/rollbackå†³ç­–
```

### 4.2 æ ¸å¿ƒæ–¹æ³•è¯¦è§£


#### ğŸ”¹ isNewTransaction() - æ˜¯å¦æ–°äº‹åŠ¡


**ä½œç”¨ï¼šåˆ¤æ–­å½“å‰äº‹åŠ¡æ˜¯ä¸æ˜¯æ–°åˆ›å»ºçš„**

```java
TransactionStatus status = transactionManager.getTransaction(def);

if (status.isNewTransaction()) {
    System.out.println("æˆ‘æ˜¯æ–°åˆ›å»ºçš„äº‹åŠ¡");
} else {
    System.out.println("æˆ‘åŠ å…¥äº†å·²æœ‰çš„äº‹åŠ¡");
}
```

**ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯**

```
åœºæ™¯ï¼šåµŒå¥—äº‹åŠ¡ä¸­çš„æäº¤æ§åˆ¶

å¤–å±‚æ–¹æ³•Aï¼ˆæœ‰äº‹åŠ¡ï¼‰
    â†“
è°ƒç”¨å†…å±‚æ–¹æ³•B
    â†“
Bæ£€æŸ¥ï¼šstatus.isNewTransaction()
    â†“
æ˜¯æ–°äº‹åŠ¡ â†’ Bå¯ä»¥è‡ªå·±commit/rollback
ä¸æ˜¯æ–°äº‹åŠ¡ â†’ Bä¸åº”è¯¥commitï¼Œäº¤ç»™å¤–å±‚å¤„ç†
```

#### ğŸ”¹ hasSavepoint() - æ˜¯å¦æœ‰ä¿å­˜ç‚¹


**ä½œç”¨ï¼šæ£€æŸ¥äº‹åŠ¡æ˜¯å¦è®¾ç½®äº†ä¿å­˜ç‚¹**

> **ğŸ¤” ä»€ä¹ˆæ˜¯ä¿å­˜ç‚¹ï¼Ÿ**
> 
> å°±åƒæ¸¸æˆé‡Œçš„"å­˜æ¡£ç‚¹"ï¼š
> - äº‹åŠ¡æ‰§è¡Œåˆ°æŸä¸ªä½ç½®ï¼Œè®¾ç½®ä¸€ä¸ªä¿å­˜ç‚¹
> - åé¢å‡ºé”™äº†ï¼Œå¯ä»¥å›æ»šåˆ°è¿™ä¸ªä¿å­˜ç‚¹
> - è€Œä¸æ˜¯å›æ»šæ•´ä¸ªäº‹åŠ¡

```java
// ä½¿ç”¨ä¿å­˜ç‚¹çš„ç¤ºä¾‹
Object savepoint = status.createSavepoint();

try {
    // æ‰§è¡Œä¸€äº›æ“ä½œ
    riskyOperation();
} catch (Exception e) {
    // åªå›æ»šåˆ°ä¿å­˜ç‚¹
    status.rollbackToSavepoint(savepoint);
}
```

#### ğŸ”¹ isCompleted() - äº‹åŠ¡æ˜¯å¦å®Œæˆ


**ä½œç”¨ï¼šæ£€æŸ¥äº‹åŠ¡æ˜¯å¦å·²ç»æäº¤æˆ–å›æ»š**

```java
TransactionStatus status = transactionManager.getTransaction(def);

// æ‰§è¡Œä¸šåŠ¡...

if (!status.isCompleted()) {
    // è¿˜æ²¡å®Œæˆï¼Œå¯ä»¥commitæˆ–rollback
    transactionManager.commit(status);
}

if (status.isCompleted()) {
    // å·²ç»å®Œæˆäº†ï¼Œä¸èƒ½å†æ“ä½œ
    System.out.println("äº‹åŠ¡å·²ç»ç»“æŸ");
}
```

#### ğŸ”¹ isRollbackOnly() - æ˜¯å¦åªèƒ½å›æ»š


**ä½œç”¨ï¼šæ£€æŸ¥äº‹åŠ¡æ˜¯å¦è¢«æ ‡è®°ä¸ºåªèƒ½å›æ»š**

```java
TransactionStatus status = transactionManager.getTransaction(def);

try {
    // æ‰§è¡Œä¸šåŠ¡
    someOperation();
} catch (Exception e) {
    // æ ‡è®°ä¸ºåªèƒ½å›æ»š
    status.setRollbackOnly();
}

// æäº¤æ—¶æ£€æŸ¥
if (status.isRollbackOnly()) {
    transactionManager.rollback(status);
} else {
    transactionManager.commit(status);
}
```

**ğŸ’¡ å…¸å‹ä½¿ç”¨åœºæ™¯**

```
åœºæ™¯ï¼šåµŒå¥—äº‹åŠ¡ä¸­çš„å¼‚å¸¸ä¼ é€’

å¤–å±‚äº‹åŠ¡A
    â†“
è°ƒç”¨å†…å±‚äº‹åŠ¡B
    â†“
Bå‘ç”Ÿå¼‚å¸¸ï¼Œè°ƒç”¨ï¼šstatus.setRollbackOnly()
    â†“
Bè¿”å›åˆ°A
    â†“
Aæ£€æŸ¥ï¼šstatus.isRollbackOnly() == true
    â†“
Aä¹Ÿå¿…é¡»å›æ»šï¼ˆå³ä½¿Açš„ä»£ç æ²¡é—®é¢˜ï¼‰
```

### 4.3 çŠ¶æ€æµè½¬å›¾ç¤º


```
TransactionStatus ç”Ÿå‘½å‘¨æœŸï¼š

åˆ›å»ºï¼ˆNEWï¼‰
    â†“
getTransaction() 
    â†“
â”Œâ”€ æ´»è·ƒä¸­ï¼ˆACTIVEï¼‰
â”‚       â†“
â”‚   æ‰§è¡Œä¸šåŠ¡ä»£ç ...
â”‚       â†“
â”‚   â”Œâ”€ å‡ºé”™ï¼Ÿ â”€â†’ setRollbackOnly()
â”‚   â”‚                    â†“
â”‚   â”‚              æ ‡è®°å›æ»šï¼ˆROLLBACK_ONLYï¼‰
â”‚   â”‚                    â†“
â”‚   â””â”€ æ­£å¸¸ï¼Ÿ â”€â†’ å‡†å¤‡æäº¤
â”‚                        â†“
â”œâ”€ commit() â”€â†’ å·²æäº¤ï¼ˆCOMMITTEDï¼‰
â”‚
â”œâ”€ rollback() â”€â†’ å·²å›æ»šï¼ˆROLLED_BACKï¼‰
â”‚
â””â”€ å®Œæˆï¼ˆCOMPLETEDï¼‰
```

---

## 5. ğŸš€ æ‰‹åŠ¨äº‹åŠ¡æ§åˆ¶å®æˆ˜


### 5.1 åŸºç¡€æ¨¡æ¿ - æ ‡å‡†å†™æ³•


**ğŸ“Œ æœ€ä½³å®è·µæ¨¡æ¿**

```java
@Service
public class TransferService {
    
    @Autowired
    private PlatformTransactionManager transactionManager;
    
    @Autowired
    private AccountDao accountDao;
    
    public void transfer(Long fromId, Long toId, BigDecimal amount) {
        // 1. åˆ›å»ºäº‹åŠ¡å®šä¹‰
        DefaultTransactionDefinition def = new DefaultTransactionDefinition();
        def.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED);
        def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);
        
        // 2. å¼€å¯äº‹åŠ¡
        TransactionStatus status = transactionManager.getTransaction(def);
        
        try {
            // 3. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            accountDao.deduct(fromId, amount);  // æ‰£æ¬¾
            accountDao.add(toId, amount);       // åŠ æ¬¾
            
            // 4. æäº¤äº‹åŠ¡
            transactionManager.commit(status);
            
        } catch (Exception e) {
            // 5. å¼‚å¸¸å›æ»š
            transactionManager.rollback(status);
            throw new RuntimeException("è½¬è´¦å¤±è´¥", e);
        }
    }
}
```

### 5.2 å®æˆ˜æ¡ˆä¾‹ - éƒ¨åˆ†å›æ»š


**åœºæ™¯ï¼šæ‰¹é‡å¯¼å…¥æ•°æ®ï¼Œå¤±è´¥çš„è·³è¿‡ï¼ŒæˆåŠŸçš„ä¿å­˜**

```java
public class BatchImportService {
    
    @Autowired
    private PlatformTransactionManager transactionManager;
    
    public ImportResult batchImport(List<User> users) {
        int successCount = 0;
        int failCount = 0;
        
        for (User user : users) {
            // æ¯æ¡è®°å½•ä½¿ç”¨ç‹¬ç«‹äº‹åŠ¡
            DefaultTransactionDefinition def = new DefaultTransactionDefinition();
            def.setPropagationBehavior(
                TransactionDefinition.PROPAGATION_REQUIRES_NEW  // ç‹¬ç«‹äº‹åŠ¡
            );
            
            TransactionStatus status = transactionManager.getTransaction(def);
            
            try {
                userDao.save(user);
                transactionManager.commit(status);
                successCount++;
                
            } catch (Exception e) {
                transactionManager.rollback(status);
                failCount++;
                log.error("ç”¨æˆ·{}å¯¼å…¥å¤±è´¥: {}", user.getName(), e.getMessage());
            }
        }
        
        return new ImportResult(successCount, failCount);
    }
}
```

**ğŸ¯ æ ¸å¿ƒè¦ç‚¹ï¼š**
- ä½¿ç”¨`REQUIRES_NEW`ä¼ æ’­è¡Œä¸º
- æ¯æ¡è®°å½•ç‹¬ç«‹äº‹åŠ¡ï¼Œäº’ä¸å½±å“
- å¤±è´¥çš„å›æ»šï¼ŒæˆåŠŸçš„æäº¤

### 5.3 å®æˆ˜æ¡ˆä¾‹ - ä¿å­˜ç‚¹ä½¿ç”¨


**åœºæ™¯ï¼šå¤æ‚æµç¨‹ï¼Œä¸­é—´æ­¥éª¤å¯ä»¥å›æ»šåˆ°ä¿å­˜ç‚¹**

```java
public void complexBusinessFlow() {
    DefaultTransactionDefinition def = new DefaultTransactionDefinition();
    TransactionStatus status = transactionManager.getTransaction(def);
    
    try {
        // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•ï¼ˆé‡è¦ï¼Œä¸èƒ½å›æ»šï¼‰
        Order order = orderDao.create(orderInfo);
        
        // è®¾ç½®ä¿å­˜ç‚¹
        Object savepoint = status.createSavepoint();
        
        try {
            // æ­¥éª¤2ï¼šå°è¯•æ‰£å‡åº“å­˜ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
            stockDao.deduct(order.getProductId(), order.getQuantity());
            
            // æ­¥éª¤3ï¼šå°è¯•æ‰£å‡ç§¯åˆ†ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
            pointDao.deduct(order.getUserId(), order.getPoints());
            
        } catch (StockException | PointException e) {
            // æ­¥éª¤2/3å¤±è´¥ï¼Œå›æ»šåˆ°ä¿å­˜ç‚¹
            status.rollbackToSavepoint(savepoint);
            
            // ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼ˆæ¯”å¦‚ï¼šè®°å½•å¤±è´¥åŸå› ï¼Œæ”¹ç”¨å…¶ä»–æ”¯ä»˜æ–¹å¼ï¼‰
            order.setStatus("PENDING");
            orderDao.update(order);
        }
        
        // æäº¤æ•´ä¸ªäº‹åŠ¡
        transactionManager.commit(status);
        
    } catch (Exception e) {
        // å…¨éƒ¨å›æ»š
        transactionManager.rollback(status);
        throw e;
    }
}
```

### 5.4 å®æˆ˜æ¡ˆä¾‹ - ç²¾ç¡®æ§åˆ¶äº‹åŠ¡èŒƒå›´


**åœºæ™¯ï¼šåªå¯¹å…³é”®æ“ä½œåŠ äº‹åŠ¡ï¼ŒæŸ¥è¯¢æ“ä½œä¸éœ€è¦**

```java
public void placeOrder(OrderRequest request) {
    
    // 1. æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼ˆä¸éœ€è¦äº‹åŠ¡ï¼‰
    Product product = productDao.findById(request.getProductId());
    
    // 2. æ ¡éªŒåº“å­˜ï¼ˆä¸éœ€è¦äº‹åŠ¡ï¼‰
    if (product.getStock() < request.getQuantity()) {
        throw new BusinessException("åº“å­˜ä¸è¶³");
    }
    
    // 3. è®¡ç®—ä»·æ ¼ï¼ˆä¸éœ€è¦äº‹åŠ¡ï¼‰
    BigDecimal totalPrice = calculatePrice(product, request);
    
    // âš¡ 4. åªå¯¹å†™æ“ä½œå¼€å¯äº‹åŠ¡
    DefaultTransactionDefinition def = new DefaultTransactionDefinition();
    TransactionStatus status = transactionManager.getTransaction(def);
    
    try {
        // æ‰£å‡åº“å­˜
        stockDao.deduct(request.getProductId(), request.getQuantity());
        
        // åˆ›å»ºè®¢å•
        orderDao.create(new Order(request, totalPrice));
        
        // æ‰£å‡ä½™é¢
        accountDao.deduct(request.getUserId(), totalPrice);
        
        transactionManager.commit(status);
        
    } catch (Exception e) {
        transactionManager.rollback(status);
        throw e;
    }
    
    // 5. å‘é€é€šçŸ¥ï¼ˆä¸éœ€è¦äº‹åŠ¡ï¼‰
    notificationService.sendOrderNotification(request.getUserId());
}
```

**ğŸ’¡ è®¾è®¡æ€è·¯ï¼š**
- æŸ¥è¯¢ã€æ ¡éªŒã€è®¡ç®— â†’ ä¸å¼€äº‹åŠ¡
- å†™æ“ä½œï¼ˆæ‰£åº“å­˜ã€åˆ›å»ºè®¢å•ã€æ‰£ä½™é¢ï¼‰â†’ ç²¾ç¡®å¼€å¯äº‹åŠ¡
- é€šçŸ¥å‘é€ â†’ äº‹åŠ¡å¤–æ‰§è¡Œ

---

## 6. ğŸ›¡ï¸ èµ„æºç®¡ç†ä¸æœ€ä½³å®è·µ


### 6.1 èµ„æºç®¡ç†æ ¸å¿ƒåŸåˆ™


**ğŸ”¸ åŸåˆ™1ï¼šè°å¼€å¯è°å…³é—­**

```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šå¼€å¯äº†äº‹åŠ¡ä½†å¿˜è®°å…³é—­
public void badExample() {
    TransactionStatus status = transactionManager.getTransaction(def);
    userDao.save(user);
    // å¿˜è®°commitæˆ–rollbackï¼Œèµ„æºæ³„æ¼ï¼
}

// âœ… æ­£ç¡®ç¤ºä¾‹ï¼šå¿…é¡»åœ¨finallyä¸­å…³é—­
public void goodExample() {
    TransactionStatus status = null;
    try {
        status = transactionManager.getTransaction(def);
        userDao.save(user);
        transactionManager.commit(status);
    } catch (Exception e) {
        if (status != null) {
            transactionManager.rollback(status);
        }
    }
}
```

**ğŸ”¸ åŸåˆ™2ï¼šé¿å…é•¿äº‹åŠ¡**

```
âŒ ä¸å¥½çš„åšæ³•ï¼š
å¼€å¯äº‹åŠ¡
    â†“
æŸ¥è¯¢æ•°æ®åº“ï¼ˆ100msï¼‰
    â†“
è°ƒç”¨å¤–éƒ¨APIï¼ˆ5ç§’ï¼‰â† é•¿æ—¶é—´ç½‘ç»œIO
    â†“
å¤æ‚è®¡ç®—ï¼ˆ3ç§’ï¼‰â† å ç”¨CPU
    â†“
æäº¤äº‹åŠ¡

âœ… å¥½çš„åšæ³•ï¼š
æŸ¥è¯¢æ•°æ®åº“ï¼ˆä¸åœ¨äº‹åŠ¡ä¸­ï¼‰
    â†“
è°ƒç”¨å¤–éƒ¨APIï¼ˆä¸åœ¨äº‹åŠ¡ä¸­ï¼‰
    â†“
å¤æ‚è®¡ç®—ï¼ˆä¸åœ¨äº‹åŠ¡ä¸­ï¼‰
    â†“
å¼€å¯äº‹åŠ¡
    â†“
æ›´æ–°æ•°æ®åº“ï¼ˆ50msï¼‰
    â†“
æäº¤äº‹åŠ¡
```

**ğŸ”¸ åŸåˆ™3ï¼šåˆç†è®¾ç½®è¶…æ—¶æ—¶é—´**

```java
// æ ¹æ®ä¸šåŠ¡åœºæ™¯è®¾ç½®åˆç†è¶…æ—¶
DefaultTransactionDefinition def = new DefaultTransactionDefinition();

// ç®€å•ä¸šåŠ¡ï¼š5ç§’è¶³å¤Ÿ
def.setTimeout(5);

// æ‰¹é‡å¤„ç†ï¼šå¯ä»¥è®¾ç½®é•¿ä¸€ç‚¹
def.setTimeout(60);

// å®æ—¶äº¤æ˜“ï¼šå¿…é¡»å¿«é€Ÿå“åº”
def.setTimeout(3);
```

### 6.2 å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ


**ğŸ“Œ æ ‡å‡†å¼‚å¸¸å¤„ç†æ¨¡æ¿**

```java
public void standardPattern() {
    TransactionStatus status = null;
    
    try {
        // 1. å¼€å¯äº‹åŠ¡
        status = transactionManager.getTransaction(
            new DefaultTransactionDefinition()
        );
        
        // 2. æ‰§è¡Œä¸šåŠ¡
        doBusinessLogic();
        
        // 3. æ£€æŸ¥çŠ¶æ€å†³å®šæäº¤æˆ–å›æ»š
        if (status.isRollbackOnly()) {
            transactionManager.rollback(status);
        } else {
            transactionManager.commit(status);
        }
        
    } catch (Exception e) {
        // 4. å¼‚å¸¸å›æ»š
        if (status != null && !status.isCompleted()) {
            transactionManager.rollback(status);
        }
        
        // 5. è®°å½•æ—¥å¿—
        log.error("äº‹åŠ¡æ‰§è¡Œå¤±è´¥", e);
        
        // 6. è½¬æ¢ä¸ºä¸šåŠ¡å¼‚å¸¸æŠ›å‡º
        throw new BusinessException("æ“ä½œå¤±è´¥", e);
        
    } finally {
        // 7. æ¸…ç†èµ„æºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        cleanupResources();
    }
}
```

**âš ï¸ å¸¸è§é”™è¯¯**

```java
// âŒ é”™è¯¯1ï¼šåæ‰å¼‚å¸¸
try {
    transactionManager.commit(status);
} catch (Exception e) {
    // ä»€ä¹ˆéƒ½ä¸åšï¼Œé”™è¯¯ï¼
}

// âŒ é”™è¯¯2ï¼šé‡å¤å›æ»š
transactionManager.rollback(status);
transactionManager.rollback(status);  // æŠ¥é”™ï¼

// âŒ é”™è¯¯3ï¼šåœ¨finallyä¸­commit
finally {
    transactionManager.commit(status);  // å¯èƒ½å·²ç»å›æ»šäº†
}
```

### 6.3 å¹¶å‘ä¸é”èµ„æºç®¡ç†


**ğŸ”’ æ‚²è§‚é”ç¤ºä¾‹**

```java
public void pessimisticLockExample(Long accountId) {
    DefaultTransactionDefinition def = new DefaultTransactionDefinition();
    // è®¾ç½®è¾ƒé«˜éš”ç¦»çº§åˆ«
    def.setIsolationLevel(TransactionDefinition.ISOLATION_SERIALIZABLE);
    
    TransactionStatus status = transactionManager.getTransaction(def);
    
    try {
        // æŸ¥è¯¢æ—¶åŠ é”ï¼šSELECT ... FOR UPDATE
        Account account = accountDao.findByIdForUpdate(accountId);
        
        // ä¿®æ”¹ä½™é¢
        account.setBalance(account.getBalance().subtract(amount));
        accountDao.update(account);
        
        transactionManager.commit(status);
        
    } catch (Exception e) {
        transactionManager.rollback(status);
        throw e;
    }
}
```

**âš¡ ä¹è§‚é”ç¤ºä¾‹**

```java
public void optimisticLockExample(Long accountId) {
    DefaultTransactionDefinition def = new DefaultTransactionDefinition();
    TransactionStatus status = transactionManager.getTransaction(def);
    
    try {
        // æŸ¥è¯¢å¸¦ç‰ˆæœ¬å·
        Account account = accountDao.findById(accountId);
        int oldVersion = account.getVersion();
        
        // ä¿®æ”¹æ•°æ®
        account.setBalance(account.getBalance().subtract(amount));
        account.setVersion(oldVersion + 1);
        
        // æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·
        int rows = accountDao.updateWithVersion(account, oldVersion);
        
        if (rows == 0) {
            throw new OptimisticLockException("æ•°æ®å·²è¢«ä¿®æ”¹");
        }
        
        transactionManager.commit(status);
        
    } catch (Exception e) {
        transactionManager.rollback(status);
        throw e;
    }
}
```

### 6.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®


| ä¼˜åŒ–ç‚¹ | **è¯´æ˜** | **å®æ–½æ–¹æ¡ˆ** |
|-------|---------|------------|
| ğŸš€ **ç¼©çŸ­äº‹åŠ¡æ—¶é—´** | `å‡å°‘é”æŒæœ‰æ—¶é—´` | `äº‹åŠ¡å¤–å®ŒæˆæŸ¥è¯¢å’Œè®¡ç®—ï¼Œåªåœ¨æ›´æ–°æ—¶å¼€äº‹åŠ¡` |
| ğŸ“Š **æ‰¹é‡æ“ä½œ** | `å‡å°‘äº‹åŠ¡å¼€å¯æ¬¡æ•°` | `å¤šæ¡è®°å½•åˆå¹¶ä¸ºä¸€ä¸ªäº‹åŠ¡å¤„ç†` |
| ğŸ”„ **åªè¯»æ ‡è®°** | `ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½` | `æŸ¥è¯¢äº‹åŠ¡è®¾ç½®readOnly=true` |
| âš™ï¸ **åˆç†éš”ç¦»çº§åˆ«** | `å¹³è¡¡ä¸€è‡´æ€§å’Œæ€§èƒ½` | `READ_COMMITTEDé€‚ç”¨å¤§å¤šæ•°åœºæ™¯` |
| ğŸ’¾ **è¿æ¥æ± é…ç½®** | `é¿å…è¿æ¥è€—å°½` | `è®¾ç½®åˆç†çš„æœ€å¤§è¿æ¥æ•°å’Œè¶…æ—¶æ—¶é—´` |

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ PlatformTransactionManagerï¼šSpringçš„æ‰‹åŠ¨äº‹åŠ¡æ§åˆ¶å·¥å…·
ğŸ”¸ ä¸‰å¤§æ ¸å¿ƒæ–¹æ³•ï¼šgetTransactionå¼€å¯ã€commitæäº¤ã€rollbackå›æ»š
ğŸ”¸ TransactionDefinitionï¼šäº‹åŠ¡é…ç½®å•ï¼Œå®šä¹‰éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºç­‰
ğŸ”¸ TransactionStatusï¼šäº‹åŠ¡çŠ¶æ€å›æ‰§ï¼Œè®°å½•äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ä¿¡æ¯
ğŸ”¸ èµ„æºç®¡ç†ï¼šè°å¼€å¯è°å…³é—­ï¼Œé¿å…èµ„æºæ³„æ¼
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç¼–ç¨‹å¼ vs å£°æ˜å¼é€‰æ‹©**
```
ç¼–ç¨‹å¼äº‹åŠ¡é€‚ç”¨åœºæ™¯ï¼š
âœ… éœ€è¦åœ¨æ–¹æ³•å†…éƒ¨ç²¾ç¡®æ§åˆ¶äº‹åŠ¡èŒƒå›´
âœ… éœ€è¦åŠ¨æ€å†³å®šæ˜¯å¦å¼€å¯äº‹åŠ¡
âœ… å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œéœ€è¦éƒ¨åˆ†å›æ»š
âœ… éœ€è¦ä½¿ç”¨ä¿å­˜ç‚¹

å£°æ˜å¼äº‹åŠ¡é€‚ç”¨åœºæ™¯ï¼š
âœ… å¸¸è§„CRUDæ“ä½œ
âœ… æ•´ä¸ªæ–¹æ³•éƒ½éœ€è¦äº‹åŠ¡
âœ… ä¸éœ€è¦ç²¾ç»†æ§åˆ¶
âœ… è¿½æ±‚ä»£ç ç®€æ´
```

**ğŸ”¹ ä¼ æ’­è¡Œä¸ºæ ¸å¿ƒè®°å¿†**
```
REQUIREDï¼ˆé»˜è®¤ï¼‰ï¼šæœ‰å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±æ–°å»º
REQUIRES_NEWï¼šæ€»æ˜¯æ–°å»ºç‹¬ç«‹äº‹åŠ¡
SUPPORTSï¼šæœ‰å°±ç”¨ï¼Œæ²¡æœ‰ä¹Ÿè¡Œ
MANDATORYï¼šå¿…é¡»æœ‰ï¼Œæ²¡æœ‰æŠ¥é”™
NEVERï¼šå¿…é¡»æ²¡æœ‰ï¼Œæœ‰å°±æŠ¥é”™
```

**ğŸ”¹ èµ„æºç®¡ç†é‡‘ç§‘ç‰å¾‹**
```
1. å¼€å¯äº‹åŠ¡åï¼Œå¿…é¡»commitæˆ–rollback
2. ä½¿ç”¨try-catch-finallyç¡®ä¿èµ„æºé‡Šæ”¾
3. é¿å…é•¿äº‹åŠ¡ï¼Œç¼©çŸ­é”æŒæœ‰æ—¶é—´
4. åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´é˜²æ­¢æ­»é”
5. å¼‚å¸¸è¦æ­£ç¡®å¤„ç†å’Œä¼ æ’­
```

### 7.3 å®æˆ˜åº”ç”¨ä»·å€¼


**ğŸ’¼ å…¸å‹ä¸šåŠ¡åœºæ™¯**

| åœºæ™¯ | **è§£å†³æ–¹æ¡ˆ** | **å…³é”®é…ç½®** |
|-----|------------|------------|
| ğŸ’° **è½¬è´¦ä¸šåŠ¡** | `ä½¿ç”¨REQUIREDä¼ æ’­ï¼Œç¡®ä¿åŸå­æ€§` | `READ_COMMITTEDéš”ç¦»çº§åˆ«` |
| ğŸ“ **æ—¥å¿—è®°å½•** | `ä½¿ç”¨REQUIRES_NEWç‹¬ç«‹äº‹åŠ¡` | `æ— è®ºä¸»ä¸šåŠ¡æˆè´¥éƒ½è¦ä¿å­˜æ—¥å¿—` |
| ğŸ“Š **æ‰¹é‡å¯¼å…¥** | `æ¯æ¡è®°å½•ç‹¬ç«‹äº‹åŠ¡ï¼Œå¤±è´¥è·³è¿‡` | `REQUIRES_NEW + å¼‚å¸¸æ•è·` |
| ğŸ”„ **å¤æ‚æµç¨‹** | `ä½¿ç”¨ä¿å­˜ç‚¹ï¼Œæ”¯æŒéƒ¨åˆ†å›æ»š` | `savepointæœºåˆ¶` |

**ğŸ¯ æ ¸å¿ƒè®°å¿†å£è¯€**
```
ç¼–ç¨‹äº‹åŠ¡ä¸‰æ­¥èµ°ï¼š
å¼€å¯getTransactionï¼Œè®°å¾—æ‹¿çŠ¶æ€
ä¸šåŠ¡æ‰§è¡Œè¦è°¨æ…ï¼Œå¼‚å¸¸æ•è·ä¸èƒ½å¿˜
æˆåŠŸcommitæäº¤ï¼Œå¤±è´¥rollbackå›æ»š
èµ„æºç®¡ç†è¦ä¸¥æ ¼ï¼Œè°å¼€è°å…³æ˜¯é“å¾‹
```

**âš¡ è¿›é˜¶å­¦ä¹ å»ºè®®**
- æ·±å…¥ç†è§£Springäº‹åŠ¡ä¼ æ’­æœºåˆ¶æºç 
- å­¦ä¹ åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼ˆSeataã€XAï¼‰
- æŒæ¡äº‹åŠ¡å¤±æ•ˆçš„7ç§åœºæ™¯
- ç ”ç©¶ä¸åŒæ•°æ®åº“çš„éš”ç¦»çº§åˆ«å®ç°å·®å¼‚