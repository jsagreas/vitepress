---
title: 34ã€äº‹åŠ¡ç›‘æ§ä¸æ•…éšœæ’æŸ¥
---
## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡ç›‘æ§](#1-ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡ç›‘æ§)
2. [Spring Boot Actuatorç›‘æ§](#2-spring-boot-actuatorç›‘æ§)
3. [æ—¥å¿—ç›‘æ§å®è·µ](#3-æ—¥å¿—ç›‘æ§å®è·µ)
4. [SQLæ—¥å¿—åˆ†æ](#4-sqlæ—¥å¿—åˆ†æ)
5. [è°ƒè¯•æŠ€å·§ä¸å·¥å…·](#5-è°ƒè¯•æŠ€å·§ä¸å·¥å…·)
6. [æ•…éšœæ’æŸ¥æ–¹æ³•è®º](#6-æ•…éšœæ’æŸ¥æ–¹æ³•è®º)
7. [ç›‘æ§æŒ‡æ ‡è¯¦è§£](#7-ç›‘æ§æŒ‡æ ‡è¯¦è§£)
8. [æ…¢æŸ¥è¯¢å®šä½ä¸ä¼˜åŒ–](#8-æ…¢æŸ¥è¯¢å®šä½ä¸ä¼˜åŒ–)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡ç›‘æ§


### 1.1 äº‹åŠ¡ç›‘æ§çš„æœ¬è´¨


**é€šä¿—ç†è§£ï¼š**
```
äº‹åŠ¡ç›‘æ§å°±åƒç»™ä½ çš„ä»£ç è£…ä¸€ä¸ª"å¥åº·ä½“æ£€ä»ª"

æƒ³è±¡ä¸€ä¸‹ï¼š
- ä½ å¼€äº†ä¸€å®¶é¤å…ï¼ˆåº”ç”¨ç³»ç»Ÿï¼‰
- è®¢å•å¤„ç†å°±æ˜¯äº‹åŠ¡ï¼ˆç‚¹èœâ†’åšèœâ†’ä¸Šèœâ†’ç»“è´¦ï¼‰
- å¦‚æœæ²¡æœ‰ç›‘æ§ï¼š
  âœ— ä¸çŸ¥é“å“ªä¸ªç¯èŠ‚æ…¢
  âœ— ä¸çŸ¥é“æ˜¯å¦æœ‰è®¢å•ä¸¢å¤±
  âœ— å‡ºé—®é¢˜åæ— ä»æŸ¥èµ·

- æœ‰äº†ç›‘æ§ï¼š
  âœ“ å®æ—¶çŸ¥é“è®¢å•å¤„ç†é€Ÿåº¦
  âœ“ å‘ç°å“ªä¸ªç¯èŠ‚å‡ºé”™
  âœ“ è®°å½•å®Œæ•´æ“ä½œè½¨è¿¹
```

### 1.2 äº‹åŠ¡å¸¸è§é—®é¢˜


**å®é™…å¼€å‘ä¸­çš„ç—›ç‚¹ï¼š**

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | ç›‘æ§ä½œç”¨ |
|---------|---------|---------|
| **å“åº”å˜æ…¢** | äº‹åŠ¡æ—¶é—´è¿‡é•¿ | å‘ç°æ€§èƒ½ç“¶é¢ˆ |
| **æ•°æ®ä¸ä¸€è‡´** | äº‹åŠ¡å›æ»šå¤±è´¥ | è¿½è¸ªäº‹åŠ¡çŠ¶æ€ |
| **æ­»é”é¢‘å‘** | é”ç«äº‰æ¿€çƒˆ | åˆ†æé”ç­‰å¾… |
| **å†…å­˜æº¢å‡º** | äº‹åŠ¡æœªå…³é—­ | ç›‘æ§è¿æ¥æ•° |

**ğŸ’¡ æ ¸å¿ƒç†è§£ï¼š**
> ç›‘æ§ä¸æ˜¯ä¸ºäº†æ‰¾èŒ¬ï¼Œè€Œæ˜¯ä¸ºäº†**æå‰å‘ç°é—®é¢˜ã€å¿«é€Ÿå®šä½æ•…éšœã€æŒç»­ä¼˜åŒ–æ€§èƒ½**

---

## 2. ğŸ“Š Spring Boot Actuatorç›‘æ§


### 2.1 Actuatoræ˜¯ä»€ä¹ˆ


**ç®€å•ç†è§£ï¼š**
```
Spring Boot Actuator = åº”ç”¨çš„"ä½“æ£€ä¸­å¿ƒ"

å®ƒæä¾›ï¼š
ğŸ“Œ å¥åº·æ£€æŸ¥ï¼ˆåº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œï¼‰
ğŸ“Œ æ€§èƒ½æŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ã€çº¿ç¨‹ä½¿ç”¨æƒ…å†µï¼‰
ğŸ“Œ ç¯å¢ƒä¿¡æ¯ï¼ˆé…ç½®ã€Beanä¿¡æ¯ç­‰ï¼‰
ğŸ“Œ è‡ªå®šä¹‰ç›‘æ§ï¼ˆäº‹åŠ¡ã€æ•°æ®åº“ç­‰ï¼‰
```

### 2.2 å¿«é€Ÿé›†æˆActuator


**ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ–**
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

**ç¬¬äºŒæ­¥ï¼šé…ç½®ç›‘æ§ç«¯ç‚¹**
```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,info  # å¼€æ”¾çš„ç›‘æ§ç«¯ç‚¹
  endpoint:
    health:
      show-details: always  # æ˜¾ç¤ºè¯¦ç»†å¥åº·ä¿¡æ¯
```

**ç¬¬ä¸‰æ­¥ï¼šè®¿é—®ç›‘æ§ä¿¡æ¯**
```bash
# å¥åº·æ£€æŸ¥
http://localhost:8080/actuator/health

# æ€§èƒ½æŒ‡æ ‡
http://localhost:8080/actuator/metrics

# æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
http://localhost:8080/actuator/metrics/hikaricp.connections
```

### 2.3 å…³é”®ç›‘æ§æŒ‡æ ‡


**æ•°æ®åº“è¿æ¥æ± ç›‘æ§ï¼š**
```
æŒ‡æ ‡åç§°ï¼šhikaricp.connections.active
å«ä¹‰ï¼šå½“å‰æ´»è·ƒçš„æ•°æ®åº“è¿æ¥æ•°

å¼‚å¸¸åˆ¤æ–­ï¼š
âœ“ æ­£å¸¸ï¼šactive < æ€»è¿æ¥æ•°çš„70%
âš ï¸ è­¦å‘Šï¼šactive > æ€»è¿æ¥æ•°çš„80%
âœ— å±é™©ï¼šactive = æ€»è¿æ¥æ•°ï¼ˆè¿æ¥æ± è€—å°½ï¼‰
```

**äº‹åŠ¡æ‰§è¡Œç›‘æ§ï¼š**
```
æŒ‡æ ‡åç§°ï¼šspring.transaction.commits / spring.transaction.rollbacks
å«ä¹‰ï¼šäº‹åŠ¡æäº¤æ¬¡æ•° / å›æ»šæ¬¡æ•°

å¼‚å¸¸åˆ¤æ–­ï¼š
âœ“ æ­£å¸¸ï¼šrollbacks < commitsçš„5%
âš ï¸ è­¦å‘Šï¼šrollbacks > commitsçš„10%
âœ— å±é™©ï¼šrollbacksæŒç»­å¢é•¿
```

---

## 3. ğŸ“ æ—¥å¿—ç›‘æ§å®è·µ


### 3.1 äº‹åŠ¡æ—¥å¿—é…ç½®


**å¼€å¯äº‹åŠ¡æ—¥å¿—ï¼š**
```yaml
# application.yml
logging:
  level:
    org.springframework.transaction: DEBUG  # äº‹åŠ¡æ¡†æ¶æ—¥å¿—
    org.springframework.jdbc: DEBUG         # JDBCæ“ä½œæ—¥å¿—
```

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹ï¼š**
```
å…¸å‹çš„äº‹åŠ¡æ—¥å¿—æµç¨‹ï¼š

[äº‹åŠ¡å¼€å§‹]
DEBUG o.s.transaction - Creating new transaction: PROPAGATION_REQUIRED
â†“
[æ‰§è¡ŒSQL]
DEBUG o.s.jdbc - Executing SQL statement: INSERT INTO orders...
â†“
[äº‹åŠ¡æäº¤]
DEBUG o.s.transaction - Committing JDBC transaction
â†“
[äº‹åŠ¡ç»“æŸ]
DEBUG o.s.transaction - Releasing JDBC connection
```

### 3.2 è‡ªå®šä¹‰äº‹åŠ¡æ—¥å¿—


**å®ç”¨çš„æ—¥å¿—åˆ‡é¢ï¼š**
```java
@Aspect
@Component
public class TransactionLogAspect {
    
    private static final Logger log = LoggerFactory.getLogger(TransactionLogAspect.class);
    
    // ç¯ç»•æ‰€æœ‰@Transactionalæ–¹æ³•
    @Around("@annotation(transactional)")
    public Object logTransaction(ProceedingJoinPoint pjp, Transactional transactional) throws Throwable {
        
        String methodName = pjp.getSignature().getName();
        long startTime = System.currentTimeMillis();
        
        log.info("ğŸ”„ äº‹åŠ¡å¼€å§‹: {}", methodName);
        
        try {
            Object result = pjp.proceed();
            long duration = System.currentTimeMillis() - startTime;
            
            log.info("âœ… äº‹åŠ¡æˆåŠŸ: {} (è€—æ—¶: {}ms)", methodName, duration);
            return result;
            
        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            log.error("âŒ äº‹åŠ¡å¤±è´¥: {} (è€—æ—¶: {}ms), åŸå› : {}", 
                     methodName, duration, e.getMessage());
            throw e;
        }
    }
}
```

**æ—¥å¿—è¾“å‡ºæ•ˆæœï¼š**
```
ğŸ”„ äº‹åŠ¡å¼€å§‹: createOrder
âœ… äº‹åŠ¡æˆåŠŸ: createOrder (è€—æ—¶: 45ms)

ğŸ”„ äº‹åŠ¡å¼€å§‹: transferMoney  
âŒ äº‹åŠ¡å¤±è´¥: transferMoney (è€—æ—¶: 120ms), åŸå› : ä½™é¢ä¸è¶³
```

---

## 4. ğŸ” SQLæ—¥å¿—åˆ†æ


### 4.1 å¼€å¯SQLæ—¥å¿—


**æ–¹å¼ä¸€ï¼šé…ç½®æ–‡ä»¶å¼€å¯**
```yaml
# application.yml
spring:
  jpa:
    show-sql: true              # æ˜¾ç¤ºSQLè¯­å¥
    properties:
      hibernate:
        format_sql: true        # æ ¼å¼åŒ–SQL
        use_sql_comments: true  # æ˜¾ç¤ºSQLæ³¨é‡Š
```

**æ–¹å¼äºŒï¼šä½¿ç”¨p6spyæ’ä»¶**
```xml
<!-- æ›´å¼ºå¤§çš„SQLæ—¥å¿—å·¥å…· -->
<dependency>
    <groupId>p6spy</groupId>
    <artifactId>p6spy</artifactId>
    <version>3.9.1</version>
</dependency>
```

**p6spyé…ç½®ï¼š**
```properties
# spy.properties
appender=com.p6spy.engine.spy.appender.Slf4JLogger
logMessageFormat=com.p6spy.engine.spy.appender.CustomLineFormat
customLogMessageFormat=æ‰§è¡Œæ—¶é—´: %(executionTime)ms | SQL: %(sql)
```

### 4.2 SQLæ—¥å¿—åˆ†ææŠ€å·§


**è¯†åˆ«æ…¢SQLï¼š**
```
å…¸å‹çš„æ…¢SQLæ—¥å¿—ï¼š

æ‰§è¡Œæ—¶é—´: 1250ms | SQL: SELECT * FROM orders WHERE status = 'PENDING'
                        â†‘
                   è¶…è¿‡1ç§’ï¼Œéœ€è¦ä¼˜åŒ–ï¼

ä¼˜åŒ–æ–¹å‘ï¼š
1. æ£€æŸ¥æ˜¯å¦ç¼ºå°‘ç´¢å¼•ï¼ˆstatuså­—æ®µï¼‰
2. æ˜¯å¦éœ€è¦åˆ†é¡µæŸ¥è¯¢
3. æ˜¯å¦å¯ä»¥ç¼“å­˜ç»“æœ
```

**å‘ç°N+1é—®é¢˜ï¼š**
```
N+1é—®é¢˜çš„æ—¥å¿—ç‰¹å¾ï¼š

æ‰§è¡Œæ—¶é—´: 5ms | SQL: SELECT * FROM orders LIMIT 10        â† ä¸»æŸ¥è¯¢
æ‰§è¡Œæ—¶é—´: 3ms | SQL: SELECT * FROM order_items WHERE order_id = 1
æ‰§è¡Œæ—¶é—´: 3ms | SQL: SELECT * FROM order_items WHERE order_id = 2
æ‰§è¡Œæ—¶é—´: 3ms | SQL: SELECT * FROM order_items WHERE order_id = 3
... (é‡å¤10æ¬¡)                                            â† Næ¬¡å­æŸ¥è¯¢

é—®é¢˜ï¼šæŸ¥è¯¢10ä¸ªè®¢å•ï¼Œå´æ‰§è¡Œäº†11æ¬¡SQLï¼
è§£å†³ï¼šä½¿ç”¨JOINæˆ–fetch joinä¸€æ¬¡æŸ¥è¯¢æ‰€æœ‰æ•°æ®
```

---

## 5. ğŸ› ï¸ è°ƒè¯•æŠ€å·§ä¸å·¥å…·


### 5.1 IDEAè°ƒè¯•äº‹åŠ¡


**æ–­ç‚¹è°ƒè¯•æ­¥éª¤ï¼š**
```
æ­¥éª¤1ï¼šåœ¨@Transactionalæ–¹æ³•ä¸Šæ‰“æ–­ç‚¹
       â†“
æ­¥éª¤2ï¼šä»¥Debugæ¨¡å¼å¯åŠ¨
       â†“
æ­¥éª¤3ï¼šè§‚å¯ŸVariablesçª—å£çš„TransactionInfoå¯¹è±¡
       â†“
æ­¥éª¤4ï¼šæŸ¥çœ‹äº‹åŠ¡çŠ¶æ€ã€ä¼ æ’­è¡Œä¸ºã€éš”ç¦»çº§åˆ«
```

**å…³é”®è°ƒè¯•ä¿¡æ¯ï¼š**
```java
// åœ¨è°ƒè¯•å™¨ä¸­æŸ¥çœ‹è¿™äº›å˜é‡
TransactionInfo info = ...
- info.getTransactionStatus()      // äº‹åŠ¡çŠ¶æ€
- info.getTransactionAttribute()   // äº‹åŠ¡é…ç½®
- info.hasTransaction()            // æ˜¯å¦åœ¨äº‹åŠ¡ä¸­
```

### 5.2 ä½¿ç”¨TransactionSynchronizationManager


**å®æ—¶æŸ¥è¯¢äº‹åŠ¡çŠ¶æ€ï¼š**
```java
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(Order order) {
        
        // æ£€æŸ¥æ˜¯å¦åœ¨äº‹åŠ¡ä¸­
        boolean inTx = TransactionSynchronizationManager.isActualTransactionActive();
        System.out.println("æ˜¯å¦åœ¨äº‹åŠ¡ä¸­: " + inTx);
        
        // è·å–å½“å‰äº‹åŠ¡åç§°
        String txName = TransactionSynchronizationManager.getCurrentTransactionName();
        System.out.println("äº‹åŠ¡åç§°: " + txName);
        
        // äº‹åŠ¡æ˜¯å¦åªè¯»
        boolean readOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();
        System.out.println("æ˜¯å¦åªè¯»: " + readOnly);
        
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘...
    }
}
```

---

## 6. ğŸ”§ æ•…éšœæ’æŸ¥æ–¹æ³•è®º


### 6.1 äº‹åŠ¡é—®é¢˜æ’æŸ¥æµç¨‹


**æ ‡å‡†æ’æŸ¥æ­¥éª¤ï¼š**
```
é—®é¢˜å‡ºç°
   â†“
1ï¸âƒ£ æŸ¥çœ‹æ—¥å¿—ï¼ˆæ˜¯å¦æœ‰å¼‚å¸¸ï¼Ÿäº‹åŠ¡æ˜¯å¦å›æ»šï¼Ÿï¼‰
   â†“
2ï¸âƒ£ æ£€æŸ¥é…ç½®ï¼ˆ@Transactionalé…ç½®æ˜¯å¦æ­£ç¡®ï¼Ÿï¼‰
   â†“
3ï¸âƒ£ åˆ†æSQLï¼ˆSQLæ˜¯å¦æ‰§è¡Œï¼Ÿæ˜¯å¦æœ‰é”ç­‰å¾…ï¼Ÿï¼‰
   â†“
4ï¸âƒ£ ç›‘æ§æŒ‡æ ‡ï¼ˆè¿æ¥æ± æ˜¯å¦è€—å°½ï¼Ÿçº¿ç¨‹æ˜¯å¦é˜»å¡ï¼Ÿï¼‰
   â†“
5ï¸âƒ£ ä»£ç å®¡æŸ¥ï¼ˆäº‹åŠ¡æ–¹æ³•æ˜¯å¦è¢«ä»£ç†ï¼Ÿå¼‚å¸¸æ˜¯å¦è¢«æ•è·ï¼Ÿï¼‰
```

### 6.2 å¸¸è§æ•…éšœæ¡ˆä¾‹


**æ¡ˆä¾‹1ï¼šäº‹åŠ¡ä¸ç”Ÿæ•ˆ**
```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šè‡ªè°ƒç”¨å¯¼è‡´äº‹åŠ¡å¤±æ•ˆ
@Service
public class UserService {
    
    public void registerUser(User user) {
        // è¿™é‡Œè°ƒç”¨çš„æ˜¯this.saveUser()ï¼Œä¸ä¼šè§¦å‘ä»£ç†
        this.saveUser(user);  // â† äº‹åŠ¡ä¸ç”Ÿæ•ˆï¼
    }
    
    @Transactional
    public void saveUser(User user) {
        userRepository.save(user);
    }
}

// âœ… æ­£ç¡®åšæ³•ï¼šæ³¨å…¥è‡ªå·±æˆ–ä½¿ç”¨AopContext
@Service
public class UserService {
    
    @Autowired
    private UserService self;  // æ³¨å…¥è‡ªå·±
    
    public void registerUser(User user) {
        self.saveUser(user);  // é€šè¿‡ä»£ç†è°ƒç”¨
    }
    
    @Transactional
    public void saveUser(User user) {
        userRepository.save(user);
    }
}
```

**æ¡ˆä¾‹2ï¼šäº‹åŠ¡å›æ»šå¤±è´¥**
```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šå¼‚å¸¸è¢«æ•è·ï¼Œäº‹åŠ¡ä¸ä¼šå›æ»š
@Transactional
public void transferMoney(Long fromId, Long toId, BigDecimal amount) {
    try {
        accountRepository.deduct(fromId, amount);
        accountRepository.add(toId, amount);
    } catch (Exception e) {
        // å¼‚å¸¸è¢«åæ‰ï¼Œäº‹åŠ¡æ­£å¸¸æäº¤ï¼
        log.error("è½¬è´¦å¤±è´¥", e);
    }
}

// âœ… æ­£ç¡®åšæ³•ï¼šæŠ›å‡ºå¼‚å¸¸æˆ–æ‰‹åŠ¨å›æ»š
@Transactional
public void transferMoney(Long fromId, Long toId, BigDecimal amount) {
    try {
        accountRepository.deduct(fromId, amount);
        accountRepository.add(toId, amount);
    } catch (Exception e) {
        log.error("è½¬è´¦å¤±è´¥", e);
        throw e;  // é‡æ–°æŠ›å‡ºï¼Œè§¦å‘å›æ»š
    }
}
```

**æ¡ˆä¾‹3ï¼šæ­»é”é—®é¢˜**
```
æ­»é”æ—¥å¿—ç¤ºä¾‹ï¼š

ERROR: Deadlock found when trying to get lock; try restarting transaction

åŸå› åˆ†æï¼š
äº‹åŠ¡Aï¼šé”å®šè®¢å•1 â†’ ç­‰å¾…é”å®šè®¢å•2
äº‹åŠ¡Bï¼šé”å®šè®¢å•2 â†’ ç­‰å¾…é”å®šè®¢å•1
ç»“æœï¼šäº’ç›¸ç­‰å¾…ï¼Œå½¢æˆæ­»é”

è§£å†³æ–¹æ¡ˆï¼š
1. ç»Ÿä¸€åŠ é”é¡ºåºï¼ˆæ€»æ˜¯å…ˆé”IDå°çš„è®°å½•ï¼‰
2. å‡å°‘äº‹åŠ¡æŒæœ‰é”çš„æ—¶é—´
3. ä½¿ç”¨ä¹è§‚é”æ›¿ä»£æ‚²è§‚é”
```

---

## 7. ğŸ“ˆ ç›‘æ§æŒ‡æ ‡è¯¦è§£


### 7.1 æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡


**äº‹åŠ¡å“åº”æ—¶é—´ï¼ˆTransaction Response Timeï¼‰ï¼š**
```
å«ä¹‰ï¼šä»äº‹åŠ¡å¼€å§‹åˆ°ç»“æŸçš„æ€»è€—æ—¶

è¯„åˆ¤æ ‡å‡†ï¼š
ğŸŸ¢ ä¼˜ç§€ï¼š< 100ms
ğŸŸ¡ ä¸€èˆ¬ï¼š100-500ms
ğŸ”´ è¾ƒå·®ï¼š> 500ms

ä¼˜åŒ–æ–¹å‘ï¼š
- å‡å°‘SQLæŸ¥è¯¢æ¬¡æ•°
- ä¼˜åŒ–SQLæ‰§è¡Œé€Ÿåº¦
- ç¼©å°äº‹åŠ¡èŒƒå›´
```

**äº‹åŠ¡ååé‡ï¼ˆTransaction Throughputï¼‰ï¼š**
```
å«ä¹‰ï¼šæ¯ç§’å¤„ç†çš„äº‹åŠ¡æ•°é‡ï¼ˆTPSï¼‰

è¯„åˆ¤æ ‡å‡†ï¼š
ğŸŸ¢ ä¼˜ç§€ï¼š> 1000 TPS
ğŸŸ¡ ä¸€èˆ¬ï¼š100-1000 TPS
ğŸ”´ è¾ƒå·®ï¼š< 100 TPS

å½±å“å› ç´ ï¼š
- æ•°æ®åº“æ€§èƒ½
- ä¸šåŠ¡é€»è¾‘å¤æ‚åº¦
- é”ç«äº‰ç¨‹åº¦
```

### 7.2 æ•°æ®åº“æŒ‡æ ‡


**è¿æ¥æ± ä½¿ç”¨ç‡ï¼š**
```
å…¬å¼ï¼šä½¿ç”¨ç‡ = æ´»è·ƒè¿æ¥æ•° / æ€»è¿æ¥æ•°

ç¤ºä¾‹ç›‘æ§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿æ¥æ± çŠ¶æ€ï¼šHikariCP     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è¿æ¥æ•°ï¼š20             â”‚
â”‚ æ´»è·ƒè¿æ¥ï¼š12             â”‚
â”‚ ç©ºé—²è¿æ¥ï¼š8              â”‚
â”‚ ä½¿ç”¨ç‡ï¼š60% âœ“            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‘Šè­¦è§„åˆ™ï¼š
- ä½¿ç”¨ç‡ > 80%ï¼šè­¦å‘Š
- ä½¿ç”¨ç‡ > 90%ï¼šä¸¥é‡
```

**é”ç­‰å¾…æ—¶é—´ï¼š**
```
æŒ‡æ ‡ï¼šinnodb_row_lock_time_avg
å«ä¹‰ï¼šå¹³å‡è¡Œé”ç­‰å¾…æ—¶é—´

ç›‘æ§SQLï¼š
SHOW STATUS LIKE 'innodb_row_lock%';

ç»“æœåˆ†æï¼š
Innodb_row_lock_time_avg: 150  â† å¹³å‡ç­‰å¾…150ms
Innodb_row_lock_waits: 50      â† å…±å‘ç”Ÿ50æ¬¡é”ç­‰å¾…

ä¼˜åŒ–å»ºè®®ï¼š
- å‡å°‘äº‹åŠ¡æŒæœ‰é”çš„æ—¶é—´
- é¿å…é•¿äº‹åŠ¡
- è€ƒè™‘åˆ†åº“åˆ†è¡¨
```

---

## 8. ğŸŒ æ…¢æŸ¥è¯¢å®šä½ä¸ä¼˜åŒ–


### 8.1 å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—


**MySQLé…ç½®ï¼š**
```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢é…ç½®
SHOW VARIABLES LIKE 'slow_query%';

-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';

-- è®¾ç½®æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆç§’ï¼‰
SET GLOBAL long_query_time = 1;

-- è®°å½•æœªä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢
SET GLOBAL log_queries_not_using_indexes = 'ON';
```

**æ…¢æŸ¥è¯¢æ—¥å¿—ä½ç½®ï¼š**
```bash
# æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶è·¯å¾„
mysql> SHOW VARIABLES LIKE 'slow_query_log_file';
+---------------------+---------------------------+
| Variable_name       | Value                     |
+---------------------+---------------------------+
| slow_query_log_file | /var/log/mysql/slow.log   |
+---------------------+---------------------------+
```

### 8.2 æ…¢æŸ¥è¯¢åˆ†æ


**æ…¢æŸ¥è¯¢æ—¥å¿—ç¤ºä¾‹ï¼š**
```sql
# Time: 2025-01-10T10:30:15.123456Z
# User@Host: app_user[app_user] @ localhost []
# Query_time: 2.350124  Lock_time: 0.000032  Rows_sent: 1  Rows_examined: 100000
SELECT * FROM orders WHERE create_time > '2024-01-01';
```

**æ—¥å¿—è§£è¯»ï¼š**
```
Query_time: 2.35ç§’    â† æ€»æ‰§è¡Œæ—¶é—´ï¼ˆè¶…è¿‡1ç§’é˜ˆå€¼ï¼‰
Lock_time: 0.00003ç§’  â† è·å–é”çš„æ—¶é—´
Rows_sent: 1          â† è¿”å›1è¡Œæ•°æ®
Rows_examined: 100000 â† æ‰«æäº†10ä¸‡è¡Œï¼

é—®é¢˜ï¼šæ‰«æ10ä¸‡è¡Œåªè¿”å›1è¡Œï¼Œæ•ˆç‡æä½ï¼
åŸå› ï¼šcreate_timeå­—æ®µæ²¡æœ‰ç´¢å¼•
è§£å†³ï¼šCREATE INDEX idx_create_time ON orders(create_time);
```

### 8.3 æ…¢æŸ¥è¯¢ä¼˜åŒ–æµç¨‹


**ä¼˜åŒ–æ­¥éª¤ï¼š**
```
1ï¸âƒ£ åˆ†ææ‰§è¡Œè®¡åˆ’
   â†“
   EXPLAIN SELECT * FROM orders WHERE create_time > '2024-01-01';
   
   å…³æ³¨ç‚¹ï¼š
   - type: ALLï¼ˆå…¨è¡¨æ‰«æï¼‰â†’ éœ€è¦åŠ ç´¢å¼•
   - rows: 100000ï¼ˆæ‰«æè¡Œæ•°ï¼‰â†’ å¤ªå¤š
   - Extra: Using filesortï¼ˆæ–‡ä»¶æ’åºï¼‰â†’ æ…¢

2ï¸âƒ£ æ·»åŠ ç´¢å¼•
   â†“
   CREATE INDEX idx_create_time ON orders(create_time);

3ï¸âƒ£ éªŒè¯ä¼˜åŒ–æ•ˆæœ
   â†“
   å†æ¬¡EXPLAINï¼Œæ£€æŸ¥typeæ˜¯å¦å˜ä¸ºrangeæˆ–ref

4ï¸âƒ£ æµ‹è¯•æ€§èƒ½æå‡
   â†“
   å¯¹æ¯”ä¼˜åŒ–å‰åçš„Query_time
```

**ä¼˜åŒ–å‰åå¯¹æ¯”ï¼š**
```
ä¼˜åŒ–å‰ï¼š
Query_time: 2.35ç§’
Rows_examined: 100000
type: ALL

ä¼˜åŒ–åï¼š
Query_time: 0.05ç§’  â† æå‡47å€ï¼
Rows_examined: 1000  â† åªæ‰«æ1000è¡Œ
type: range         â† ä½¿ç”¨äº†ç´¢å¼•
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 ç›‘æ§ä½“ç³»æ¡†æ¶


**ä¸‰å±‚ç›‘æ§æ¨¡å‹ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨å±‚ç›‘æ§ï¼ˆActuatorï¼‰          â”‚
â”‚  - äº‹åŠ¡æäº¤/å›æ»šæ•°               â”‚
â”‚  - å“åº”æ—¶é—´ã€ååé‡              â”‚
â”‚  - JVMå†…å­˜ã€çº¿ç¨‹çŠ¶æ€             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ—¥å¿—å±‚ç›‘æ§ï¼ˆLoggingï¼‰           â”‚
â”‚  - äº‹åŠ¡æ‰§è¡Œè½¨è¿¹                  â”‚
â”‚  - SQLæ‰§è¡Œæ—¥å¿—                   â”‚
â”‚  - å¼‚å¸¸å †æ ˆä¿¡æ¯                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®åº“å±‚ç›‘æ§ï¼ˆDB Metricsï¼‰      â”‚
â”‚  - è¿æ¥æ± ä½¿ç”¨ç‡                  â”‚
â”‚  - æ…¢æŸ¥è¯¢æ—¥å¿—                    â”‚
â”‚  - é”ç­‰å¾…æ—¶é—´                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 æ•…éšœæ’æŸ¥æ£€æŸ¥æ¸…å•


**å¿«é€Ÿè‡ªæŸ¥è¡¨ï¼š**
- [ ] **æ—¥å¿—æ£€æŸ¥**ï¼šæ˜¯å¦æœ‰å¼‚å¸¸ï¼Ÿäº‹åŠ¡æ˜¯å¦å›æ»šï¼Ÿ
- [ ] **é…ç½®æ£€æŸ¥**ï¼š@Transactionalé…ç½®æ˜¯å¦æ­£ç¡®ï¼Ÿ
- [ ] **ä»£ç†æ£€æŸ¥**ï¼šæ˜¯å¦è‡ªè°ƒç”¨å¯¼è‡´ä»£ç†å¤±æ•ˆï¼Ÿ
- [ ] **å¼‚å¸¸æ£€æŸ¥**ï¼šå¼‚å¸¸æ˜¯å¦è¢«æ•è·æœªæŠ›å‡ºï¼Ÿ
- [ ] **SQLæ£€æŸ¥**ï¼šæ˜¯å¦æœ‰æ…¢æŸ¥è¯¢ï¼Ÿæ˜¯å¦ç¼ºç´¢å¼•ï¼Ÿ
- [ ] **è¿æ¥æ£€æŸ¥**ï¼šè¿æ¥æ± æ˜¯å¦è€—å°½ï¼Ÿ
- [ ] **é”æ£€æŸ¥**ï¼šæ˜¯å¦æœ‰æ­»é”ï¼Ÿé”ç­‰å¾…æ—¶é—´å¤šé•¿ï¼Ÿ

### 9.3 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹


**æ ¸å¿ƒä¼˜åŒ–åŸåˆ™ï¼š**

| ä¼˜åŒ–ç»´åº¦ | å…·ä½“æªæ–½ | æ•ˆæœ |
|---------|---------|------|
| **å‡å°‘äº‹åŠ¡èŒƒå›´** | åªåœ¨å¿…è¦æ“ä½œä¸ŠåŠ @Transactional | é™ä½é”æŒæœ‰æ—¶é—´ |
| **ä¼˜åŒ–SQL** | æ·»åŠ ç´¢å¼•ã€é¿å…N+1 | æå‡æŸ¥è¯¢é€Ÿåº¦ |
| **åˆç†é…ç½®** | è°ƒæ•´éš”ç¦»çº§åˆ«ã€è¶…æ—¶æ—¶é—´ | å¹³è¡¡æ€§èƒ½ä¸ä¸€è‡´æ€§ |
| **ç›‘æ§å‘Šè­¦** | è®¾ç½®é˜ˆå€¼ã€åŠæ—¶å‘ç°é—®é¢˜ | å¿«é€Ÿå“åº”æ•…éšœ |

### 9.4 æœ€ä½³å®è·µå»ºè®®


**å¼€å‘é˜¶æ®µï¼š**
```
âœ… å¯ç”¨SQLæ—¥å¿—ï¼ŒåŠæ—©å‘ç°æ…¢æŸ¥è¯¢
âœ… ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œè¦†ç›–äº‹åŠ¡åœºæ™¯
âœ… ä½¿ç”¨äº‹åŠ¡æ¨¡æ¿ï¼Œå‡å°‘ç¡¬ç¼–ç 
```

**æµ‹è¯•é˜¶æ®µï¼š**
```
âœ… å‹åŠ›æµ‹è¯•ï¼ŒéªŒè¯äº‹åŠ¡ååé‡
âœ… å¹¶å‘æµ‹è¯•ï¼Œæ£€æŸ¥æ­»é”é£é™©
âœ… å¼‚å¸¸æµ‹è¯•ï¼Œç¡®ä¿å›æ»šæ­£ç¡®
```

**ç”Ÿäº§é˜¶æ®µï¼š**
```
âœ… é…ç½®ç›‘æ§å‘Šè­¦ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
âœ… å®šæœŸåˆ†ææ…¢æŸ¥è¯¢ï¼ŒæŒç»­ä¼˜åŒ–
âœ… ä¿ç•™è¯¦ç»†æ—¥å¿—ï¼Œæ–¹ä¾¿æ•…éšœæ’æŸ¥
```

---

**ğŸ¯ æ ¸å¿ƒè®°å¿†å£è¯€ï¼š**
```
ç›‘æ§ä¸‰å±‚è¦è®°ç‰¢ï¼Œåº”ç”¨æ—¥å¿—åŠ æ•°æ®åº“
æ…¢æŸ¥è¯¢æ¥çœ‹æ—¥å¿—ï¼Œæ‰§è¡Œè®¡åˆ’å¸®ä½ æ‰¾
äº‹åŠ¡å¤±æ•ˆæŸ¥ä»£ç†ï¼Œå¼‚å¸¸æ•è·è¦é‡æŠ›
æ€§èƒ½ä¼˜åŒ–çœ‹æŒ‡æ ‡ï¼Œç´¢å¼•è¿æ¥ä¸èƒ½å°‘
```

**ğŸ’¡ å­¦ä¹ å»ºè®®ï¼š**
1. å…ˆåœ¨å¼€å‘ç¯å¢ƒå¼€å¯æ‰€æœ‰æ—¥å¿—ï¼Œç†Ÿæ‚‰äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹
2. ä½¿ç”¨Actuatorç›‘æ§å·¥å…·ï¼Œå®æ—¶æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡
3. é‡åˆ°é—®é¢˜å…ˆçœ‹æ—¥å¿—ï¼Œå†ç”¨EXPLAINåˆ†æSQL
4. å»ºç«‹è‡ªå·±çš„æ•…éšœæ’æŸ¥æ£€æŸ¥æ¸…å•ï¼Œé€é¡¹æ’é™¤
5. å®šæœŸåˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼ŒæŒç»­ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½