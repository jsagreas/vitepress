---
title: 12ã€äº‹åŠ¡åŒæ­¥ä¸èµ„æºç®¡ç†
---
## ğŸ“š ç›®å½•

1. [äº‹åŠ¡åŒæ­¥æœºåˆ¶æ¦‚è¿°](#1-äº‹åŠ¡åŒæ­¥æœºåˆ¶æ¦‚è¿°)
2. [TransactionSynchronizationè¯¦è§£](#2-TransactionSynchronizationè¯¦è§£)
3. [TransactionSynchronizationManageræ ¸å¿ƒä½œç”¨](#3-TransactionSynchronizationManageræ ¸å¿ƒä½œç”¨)
4. [èµ„æºç»‘å®šä¸è¿æ¥å¤ç”¨](#4-èµ„æºç»‘å®šä¸è¿æ¥å¤ç”¨)
5. [äº‹åŠ¡å›è°ƒæœºåˆ¶](#5-äº‹åŠ¡å›è°ƒæœºåˆ¶)
6. [åŒæ­¥ç”Ÿå‘½å‘¨æœŸç®¡ç†](#6-åŒæ­¥ç”Ÿå‘½å‘¨æœŸç®¡ç†)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ äº‹åŠ¡åŒæ­¥æœºåˆ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡åŒæ­¥


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ åœ¨åšä¸€ä»¶å¤æ‚çš„äº‹æƒ…ï¼Œæ¯”å¦‚ç»„ç»‡ä¸€åœºæ´»åŠ¨ï¼Œä½ éœ€è¦åœ¨ä¸åŒé˜¶æ®µé€šçŸ¥ä¸åŒçš„äººåšä¸åŒçš„äº‹æƒ…ï¼š
- æ´»åŠ¨å¼€å§‹å‰ï¼šé€šçŸ¥åœºåœ°æ–¹å‡†å¤‡åœºåœ°
- æ´»åŠ¨è¿›è¡Œä¸­ï¼šåè°ƒå„ä¸ªç¯èŠ‚
- æ´»åŠ¨æˆåŠŸç»“æŸï¼šé€šçŸ¥å¤§å®¶æ”¶æ‹¾æ•´ç†
- æ´»åŠ¨å–æ¶ˆäº†ï¼šé€šçŸ¥å¤§å®¶æ’¤åœº

äº‹åŠ¡åŒæ­¥å°±æ˜¯ç±»ä¼¼çš„æœºåˆ¶ï¼Œå®ƒè®©ä½ å¯ä»¥åœ¨äº‹åŠ¡çš„ä¸åŒé˜¶æ®µï¼ˆå¼€å§‹ã€æäº¤ã€å›æ»šï¼‰æ’å…¥è‡ªå·±çš„é€»è¾‘ã€‚

**æ ¸å¿ƒå®šä¹‰**ï¼š
```
äº‹åŠ¡åŒæ­¥ï¼ˆTransaction Synchronizationï¼‰ï¼š
ä¸€ç§å›è°ƒæœºåˆ¶ï¼Œå…è®¸æˆ‘ä»¬åœ¨äº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸä¸­
æ³¨å†Œè‡ªå®šä¹‰çš„å›è°ƒå‡½æ•°ï¼Œåœ¨ç‰¹å®šæ—¶åˆ»æ‰§è¡Œé¢å¤–çš„æ“ä½œ

ä½œç”¨ï¼š
ğŸ”¸ äº‹åŠ¡æäº¤å‰åæ‰§è¡Œæ¸…ç†å·¥ä½œ
ğŸ”¸ äº‹åŠ¡å®Œæˆåå‘é€æ¶ˆæ¯é€šçŸ¥
ğŸ”¸ åè°ƒå¤šä¸ªèµ„æºçš„åŒæ­¥æ“ä½œ
ğŸ”¸ å®ç°è·¨äº‹åŠ¡çš„èµ„æºå…±äº«
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡åŒæ­¥


**å®é™…åœºæ™¯ç¤ºä¾‹**ï¼š

```
åœºæ™¯1ï¼šè®¢å•ç³»ç»Ÿ
ç”¨æˆ·ä¸‹å• â†’ æ‰£å‡åº“å­˜ â†’ ç”Ÿæˆè®¢å• â†’ å‘é€é€šçŸ¥çŸ­ä¿¡
é—®é¢˜ï¼šçŸ­ä¿¡å‘é€ä¸åº”è¯¥å½±å“è®¢å•äº‹åŠ¡ï¼Œä½†è¦ç¡®ä¿è®¢å•æˆåŠŸåæ‰å‘é€

åœºæ™¯2ï¼šç¼“å­˜æ›´æ–°
æ›´æ–°æ•°æ®åº“ â†’ æ›´æ–°ç¼“å­˜
é—®é¢˜ï¼šåªæœ‰æ•°æ®åº“æäº¤æˆåŠŸï¼Œæ‰èƒ½æ›´æ–°ç¼“å­˜ï¼Œå¦åˆ™ç¼“å­˜å’Œæ•°æ®åº“ä¸ä¸€è‡´

åœºæ™¯3ï¼šæ–‡ä»¶ä¸Šä¼ 
ä¿å­˜æ–‡ä»¶è®°å½•åˆ°æ•°æ®åº“ â†’ ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
é—®é¢˜ï¼šå¦‚æœæ•°æ®åº“å›æ»šï¼Œæ–‡ä»¶ä¹Ÿè¦åˆ é™¤ï¼Œé¿å…åƒåœ¾æ–‡ä»¶
```

**è§£å†³æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|------|---------|---------|-------------|
| âŒ **ç›´æ¥è°ƒç”¨** | `ç®€å•ç›´æ¥` | `äº‹åŠ¡å›æ»šæ—¶æ— æ³•æ’¤é”€` | `ä¸é€‚åˆ` |
| âŒ **å¼‚æ­¥æ¶ˆæ¯** | `è§£è€¦åˆ` | `æ— æ³•æ„ŸçŸ¥äº‹åŠ¡çŠ¶æ€` | `ç®€å•é€šçŸ¥` |
| âœ… **äº‹åŠ¡åŒæ­¥** | `æ„ŸçŸ¥äº‹åŠ¡çŠ¶æ€ï¼Œå¯ç²¾ç¡®æ§åˆ¶æ—¶æœº` | `ç¨å¾®å¤æ‚` | `éœ€è¦äº‹åŠ¡åè°ƒçš„åœºæ™¯` |

### 1.3 äº‹åŠ¡åŒæ­¥çš„å·¥ä½œæµç¨‹


**å®Œæ•´æµç¨‹å›¾ç¤º**ï¼š

```
äº‹åŠ¡å¼€å§‹
   â”‚
   â”œâ”€â†’ [1] æ³¨å†ŒåŒæ­¥å™¨
   â”‚     (TransactionSynchronizationManager.registerSynchronization)
   â”‚
   â”œâ”€â†’ [2] æ‰§è¡Œä¸šåŠ¡é€»è¾‘
   â”‚     (Serviceå±‚æ–¹æ³•)
   â”‚
   â”œâ”€â†’ [3] å‡†å¤‡æäº¤
   â”‚     â””â”€â†’ beforeCommit()      // æäº¤å‰å›è°ƒ
   â”‚     â””â”€â†’ beforeCompletion()   // å®Œæˆå‰å›è°ƒ
   â”‚
   â”œâ”€â†’ [4] æäº¤æˆ–å›æ»š
   â”‚     â”œâ”€â†’ æˆåŠŸ â†’ afterCommit()      // æäº¤åå›è°ƒ
   â”‚     â””â”€â†’ å¤±è´¥ â†’ afterCompletion(ROLLBACK) // å›æ»šåå›è°ƒ
   â”‚
   â””â”€â†’ [5] æ¸…ç†èµ„æº
         â””â”€â†’ afterCompletion()    // æœ€ç»ˆå›è°ƒ
```

---

## 2. ğŸ”§ TransactionSynchronizationè¯¦è§£


### 2.1 æ ¸å¿ƒæ¥å£å®šä¹‰


**æ¥å£è¯´æ˜**ï¼š

```java
public interface TransactionSynchronization {
    
    /** 1. æŒ‚èµ·æ—¶è°ƒç”¨ - äº‹åŠ¡è¢«æš‚åœæ—¶è§¦å‘ */
    default void suspend() {}
    
    /** 2. æ¢å¤æ—¶è°ƒç”¨ - äº‹åŠ¡æ¢å¤æ‰§è¡Œæ—¶è§¦å‘ */
    default void resume() {}
    
    /** 3. åˆ·æ–°å‰è°ƒç”¨ - æ•°æ®å³å°†å†™å…¥æ•°æ®åº“å‰ */
    default void flush() {}
    
    /** 4. æäº¤å‰è°ƒç”¨ - äº‹åŠ¡å³å°†æäº¤ï¼Œä½†è¿˜æœªæäº¤ */
    default void beforeCommit(boolean readOnly) {}
    
    /** 5. å®Œæˆå‰è°ƒç”¨ - ä¸ç®¡æˆåŠŸå¤±è´¥éƒ½ä¼šè°ƒç”¨ */
    default void beforeCompletion() {}
    
    /** 6. æäº¤åè°ƒç”¨ - äº‹åŠ¡æˆåŠŸæäº¤å */
    default void afterCommit() {}
    
    /** 7. å®Œæˆåè°ƒç”¨ - æœ€ç»ˆä¸€å®šä¼šè°ƒç”¨ï¼Œå¸¦çŠ¶æ€å‚æ•° */
    default void afterCompletion(int status) {}
}
```

**å„æ–¹æ³•è§¦å‘æ—¶æœº**ï¼š

```
æ­£å¸¸æµç¨‹ï¼š
beforeCommit â†’ beforeCompletion â†’ æäº¤æˆåŠŸ â†’ afterCommit â†’ afterCompletion(COMMITTED)

å¼‚å¸¸æµç¨‹ï¼š
beforeCompletion â†’ å›æ»š â†’ afterCompletion(ROLLED_BACK)

åµŒå¥—äº‹åŠ¡ï¼š
å¤–å±‚äº‹åŠ¡æŒ‚èµ· â†’ suspend()
å†…å±‚äº‹åŠ¡æ‰§è¡Œ
å†…å±‚äº‹åŠ¡å®Œæˆ
å¤–å±‚äº‹åŠ¡æ¢å¤ â†’ resume()
```

### 2.2 å®é™…åº”ç”¨æ¡ˆä¾‹


**æ¡ˆä¾‹1ï¼šäº‹åŠ¡æˆåŠŸåå‘é€æ¶ˆæ¯**

```java
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Transactional
    public void createOrder(Order order) {
        // 1. ä¿å­˜è®¢å•
        orderRepository.save(order);
        
        // 2. æ³¨å†Œäº‹åŠ¡åŒæ­¥å™¨
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronization() {
                @Override
                public void afterCommit() {
                    // åªæœ‰äº‹åŠ¡æäº¤æˆåŠŸæ‰å‘é€çŸ­ä¿¡
                    smsService.sendOrderNotification(order);
                }
            }
        );
        
        // å¦‚æœåç»­ä»£ç æŠ›å¼‚å¸¸å›æ»šï¼ŒçŸ­ä¿¡ä¸ä¼šå‘é€
    }
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·åš**ï¼š
- ğŸ“Œ ç¡®ä¿æ¶ˆæ¯åªåœ¨äº‹åŠ¡æˆåŠŸæ—¶å‘é€
- ğŸ“Œ é¿å…äº‹åŠ¡å›æ»šåå‘é€æ— æ•ˆé€šçŸ¥
- ğŸ“Œ ä¿è¯æ•°æ®ä¸€è‡´æ€§

**æ¡ˆä¾‹2ï¼šäº‹åŠ¡å®Œæˆåæ›´æ–°ç¼“å­˜**

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    @Transactional
    public void updateUser(User user) {
        // 1. æ›´æ–°æ•°æ®åº“
        userRepository.save(user);
        
        // 2. æ³¨å†Œç¼“å­˜æ›´æ–°çš„åŒæ­¥å™¨
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronization() {
                @Override
                public void afterCommit() {
                    // æäº¤æˆåŠŸåæ›´æ–°ç¼“å­˜
                    redisTemplate.opsForValue().set(
                        "user:" + user.getId(), 
                        user
                    );
                }
                
                @Override
                public void afterCompletion(int status) {
                    // ä¸ç®¡æˆåŠŸå¤±è´¥ï¼Œéƒ½åˆ é™¤æ—§ç¼“å­˜
                    if (status == STATUS_ROLLED_BACK) {
                        // å›æ»šäº†ï¼Œåˆ é™¤å¯èƒ½çš„è„ç¼“å­˜
                        redisTemplate.delete("user:" + user.getId());
                    }
                }
            }
        );
    }
}
```

**æ¡ˆä¾‹3ï¼šæ–‡ä»¶ä¸Šä¼ çš„äº‹åŠ¡åè°ƒ**

```java
@Service
public class AttachmentService {
    
    @Transactional
    public void uploadFile(MultipartFile file) {
        // 1. ä¿å­˜æ–‡ä»¶è®°å½•åˆ°æ•°æ®åº“
        Attachment attachment = new Attachment();
        attachment.setFileName(file.getOriginalFilename());
        attachmentRepository.save(attachment);
        
        // 2. ä¸´æ—¶ä¿å­˜æ–‡ä»¶
        String tempPath = saveTempFile(file);
        
        // 3. æ³¨å†ŒåŒæ­¥å™¨
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronization() {
                @Override
                public void afterCommit() {
                    // æäº¤æˆåŠŸï¼Œç§»åŠ¨åˆ°æ­£å¼ç›®å½•
                    moveToFinalLocation(tempPath, attachment.getId());
                }
                
                @Override
                public void afterCompletion(int status) {
                    if (status == STATUS_ROLLED_BACK) {
                        // å›æ»šäº†ï¼Œåˆ é™¤ä¸´æ—¶æ–‡ä»¶
                        deleteTempFile(tempPath);
                    }
                }
            }
        );
    }
}
```

### 2.3 å›è°ƒæ–¹æ³•ä½¿ç”¨æŒ‡å—


**å„æ–¹æ³•çš„å…¸å‹ç”¨é€”**ï¼š

| å›è°ƒæ–¹æ³• | **ä½¿ç”¨åœºæ™¯** | **ç¤ºä¾‹æ“ä½œ** |
|---------|------------|-------------|
| `suspend()` | `äº‹åŠ¡åµŒå¥—æ—¶æš‚åœ` | `ä¿å­˜å½“å‰çŠ¶æ€` |
| `resume()` | `äº‹åŠ¡æ¢å¤æ‰§è¡Œ` | `æ¢å¤ä¹‹å‰çŠ¶æ€` |
| `flush()` | `å¼ºåˆ¶åˆ·æ–°æ•°æ®` | `ç¡®ä¿æ•°æ®å†™å…¥` |
| `beforeCommit()` | `æäº¤å‰éªŒè¯` | `æœ€åçš„æ•°æ®æ£€æŸ¥` |
| `beforeCompletion()` | `é€šç”¨æ¸…ç†` | `å…³é—­èµ„æºè¿æ¥` |
| `afterCommit()` | `æˆåŠŸåæ“ä½œ` | `å‘é€æ¶ˆæ¯ã€æ›´æ–°ç¼“å­˜` |
| `afterCompletion()` | `æœ€ç»ˆæ¸…ç†` | `åˆ é™¤ä¸´æ—¶æ•°æ®` |

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š

```
1. beforeCommit() vs afterCommit()
   beforeCommit: æäº¤å‰ï¼Œè¿˜åœ¨äº‹åŠ¡å†…ï¼Œå¯ä»¥æŠ›å¼‚å¸¸å›æ»š
   afterCommit:  æäº¤åï¼Œå·²å‡ºäº‹åŠ¡ï¼ŒæŠ›å¼‚å¸¸ä¹Ÿä¸ä¼šå›æ»š

2. beforeCompletion() vs afterCompletion()
   beforeCompletion: æˆåŠŸå’Œå¤±è´¥éƒ½è°ƒç”¨ï¼Œä½†æ—©äºæœ€ç»ˆæäº¤
   afterCompletion:  æœ€åä¸€å®šè°ƒç”¨ï¼Œå¯ä»¥é€šè¿‡statusåˆ¤æ–­ç»“æœ

3. å¼‚å¸¸å¤„ç†
   - afterCommit()ä¸­çš„å¼‚å¸¸ä¸ä¼šå½±å“äº‹åŠ¡
   - beforeCommit()ä¸­çš„å¼‚å¸¸ä¼šå¯¼è‡´å›æ»š
```

---

## 3. ğŸ›ï¸ TransactionSynchronizationManageræ ¸å¿ƒä½œç”¨


### 3.1 ä»€ä¹ˆæ˜¯TransactionSynchronizationManager


**é€šä¿—ç†è§£**ï¼šå°±åƒä¸€ä¸ªäº‹åŠ¡çš„"æ§åˆ¶ä¸­å¿ƒ"ï¼Œè´Ÿè´£ç®¡ç†äº‹åŠ¡ç›¸å…³çš„æ‰€æœ‰èµ„æºå’ŒåŒæ­¥å™¨ã€‚

**æ ¸å¿ƒèŒè´£**ï¼š

```
TransactionSynchronizationManager æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œæä¾›ï¼š

ğŸ”¸ èµ„æºç®¡ç†ï¼šç»‘å®šå’Œè·å–äº‹åŠ¡èµ„æºï¼ˆæ•°æ®åº“è¿æ¥ç­‰ï¼‰
ğŸ”¸ åŒæ­¥å™¨ç®¡ç†ï¼šæ³¨å†Œå’Œè§¦å‘äº‹åŠ¡åŒæ­¥å›è°ƒ
ğŸ”¸ çŠ¶æ€ç®¡ç†ï¼šç»´æŠ¤äº‹åŠ¡çš„å„ç§çŠ¶æ€ä¿¡æ¯
ğŸ”¸ çº¿ç¨‹ç»‘å®šï¼šæ‰€æœ‰ä¿¡æ¯éƒ½ç»‘å®šåˆ°å½“å‰çº¿ç¨‹ï¼ˆThreadLocalï¼‰
```

### 3.2 æ ¸å¿ƒAPIè¯¦è§£


**å¸¸ç”¨æ–¹æ³•è¯´æ˜**ï¼š

```java
// ========== 1. åŒæ­¥å™¨ç®¡ç† ==========
// æ³¨å†ŒåŒæ­¥å™¨
TransactionSynchronizationManager.registerSynchronization(
    TransactionSynchronization synchronization
);

// è·å–æ‰€æœ‰åŒæ­¥å™¨
List<TransactionSynchronization> synchronizations = 
    TransactionSynchronizationManager.getSynchronizations();

// æ£€æŸ¥æ˜¯å¦æ¿€æ´»åŒæ­¥
boolean isActive = 
    TransactionSynchronizationManager.isSynchronizationActive();

// ========== 2. èµ„æºç®¡ç† ==========
// ç»‘å®šèµ„æºåˆ°å½“å‰äº‹åŠ¡
TransactionSynchronizationManager.bindResource(
    Object key,        // é€šå¸¸æ˜¯DataSource
    Object value       // é€šå¸¸æ˜¯Connection
);

// è·å–ç»‘å®šçš„èµ„æº
Object resource = 
    TransactionSynchronizationManager.getResource(key);

// è§£ç»‘èµ„æº
TransactionSynchronizationManager.unbindResource(key);

// ========== 3. äº‹åŠ¡å±æ€§ç®¡ç† ==========
// è®¾ç½®å½“å‰äº‹åŠ¡åªè¯»
TransactionSynchronizationManager.setCurrentTransactionReadOnly(true);

// è·å–å½“å‰äº‹åŠ¡åç§°
String txName = 
    TransactionSynchronizationManager.getCurrentTransactionName();

// æ£€æŸ¥äº‹åŠ¡æ˜¯å¦åªè¯»
boolean readOnly = 
    TransactionSynchronizationManager.isCurrentTransactionReadOnly();
```

**å®é™…ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
@Component
public class TransactionHelper {
    
    // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨äº‹åŠ¡ä¸­
    public static boolean isInTransaction() {
        return TransactionSynchronizationManager
            .isSynchronizationActive();
    }
    
    // è·å–å½“å‰äº‹åŠ¡åç§°
    public static String getCurrentTransactionName() {
        return TransactionSynchronizationManager
            .getCurrentTransactionName();
    }
    
    // åœ¨äº‹åŠ¡æˆåŠŸåæ‰§è¡Œæ“ä½œ
    public static void doAfterCommit(Runnable action) {
        if (isInTransaction()) {
            TransactionSynchronizationManager.registerSynchronization(
                new TransactionSynchronization() {
                    @Override
                    public void afterCommit() {
                        action.run();
                    }
                }
            );
        } else {
            // æ²¡æœ‰äº‹åŠ¡ï¼Œç›´æ¥æ‰§è¡Œ
            action.run();
        }
    }
    
    // åœ¨äº‹åŠ¡å®Œæˆåæ‰§è¡Œæ“ä½œï¼ˆä¸ç®¡æˆåŠŸå¤±è´¥ï¼‰
    public static void doAfterCompletion(Runnable action) {
        if (isInTransaction()) {
            TransactionSynchronizationManager.registerSynchronization(
                new TransactionSynchronization() {
                    @Override
                    public void afterCompletion(int status) {
                        action.run();
                    }
                }
            );
        } else {
            action.run();
        }
    }
}
```

**ä½¿ç”¨å·¥å…·ç±»ç®€åŒ–ä»£ç **ï¼š

```java
@Service
public class ProductService {
    
    @Transactional
    public void updateProduct(Product product) {
        productRepository.save(product);
        
        // ç®€åŒ–çš„äº‹åŠ¡åæ“ä½œ
        TransactionHelper.doAfterCommit(() -> {
            // æ›´æ–°æœç´¢å¼•æ“ç´¢å¼•
            searchService.updateIndex(product);
        });
        
        TransactionHelper.doAfterCompletion(() -> {
            // è®°å½•æ“ä½œæ—¥å¿—
            logger.info("äº§å“æ›´æ–°å®Œæˆ: {}", product.getId());
        });
    }
}
```

### 3.3 å†…éƒ¨å·¥ä½œæœºåˆ¶


**ThreadLocalå­˜å‚¨ç»“æ„**ï¼š

```
æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªThreadLocalå˜é‡ï¼Œå­˜å‚¨ï¼š

Thread-1:
  â””â”€ TransactionSynchronizationManager
       â”œâ”€ resources: Map<DataSource, Connection>
       â”œâ”€ synchronizations: List<TransactionSynchronization>
       â”œâ”€ currentTransactionName: "orderTransaction"
       â”œâ”€ currentTransactionReadOnly: false
       â””â”€ currentTransactionIsolationLevel: REPEATABLE_READ

Thread-2:
  â””â”€ TransactionSynchronizationManager
       â”œâ”€ resources: Map<...>
       â””â”€ ...

ç»“è®ºï¼šä¸åŒçº¿ç¨‹çš„äº‹åŠ¡èµ„æºå®Œå…¨éš”ç¦»ï¼Œäº’ä¸å½±å“
```

**èµ„æºç»‘å®šæµç¨‹å›¾**ï¼š

```
å¼€å¯äº‹åŠ¡
   â”‚
   â”œâ”€â†’ [1] è·å–æ•°æ®åº“è¿æ¥
   â”‚      Connection conn = dataSource.getConnection()
   â”‚
   â”œâ”€â†’ [2] ç»‘å®šåˆ°å½“å‰çº¿ç¨‹
   â”‚      TransactionSynchronizationManager.bindResource(
   â”‚          dataSource,    // key
   â”‚          conn           // value
   â”‚      )
   â”‚
   â”œâ”€â†’ [3] åç»­æ“ä½œä½¿ç”¨åŒä¸€è¿æ¥
   â”‚      conn = TransactionSynchronizationManager.getResource(dataSource)
   â”‚
   â””â”€â†’ [4] äº‹åŠ¡ç»“æŸï¼Œè§£ç»‘èµ„æº
          TransactionSynchronizationManager.unbindResource(dataSource)
          conn.close()
```

---

## 4. ğŸ”— èµ„æºç»‘å®šä¸è¿æ¥å¤ç”¨


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦èµ„æºç»‘å®š


**é—®é¢˜åœºæ™¯**ï¼š

```java
@Transactional
public void transferMoney(Long fromId, Long toId, BigDecimal amount) {
    // ç¬¬1æ¬¡æ•°æ®åº“æ“ä½œ
    accountRepository.deduct(fromId, amount);  // ä½¿ç”¨è¿æ¥Aï¼Ÿ
    
    // ç¬¬2æ¬¡æ•°æ®åº“æ“ä½œ
    accountRepository.add(toId, amount);       // ä½¿ç”¨è¿æ¥Bï¼Ÿ
    
    // å¦‚æœä½¿ç”¨ä¸åŒè¿æ¥ï¼Œä¸¤ä¸ªæ“ä½œä¸åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼šèµ„æºç»‘å®šç¡®ä¿åŒä¸€äº‹åŠ¡ä½¿ç”¨åŒä¸€è¿æ¥

```
äº‹åŠ¡å¼€å§‹
   â”‚
   â”œâ”€â†’ åˆ›å»ºè¿æ¥ Connection-001
   â”‚
   â”œâ”€â†’ ç»‘å®šåˆ°å½“å‰çº¿ç¨‹
   â”‚      key: dataSource
   â”‚      value: Connection-001
   â”‚
   â”œâ”€â†’ æ‰€æœ‰DAOæ“ä½œ
   â”‚   â”œâ”€â†’ accountRepository.deduct() â†’ ä½¿ç”¨ Connection-001
   â”‚   â””â”€â†’ accountRepository.add()    â†’ ä½¿ç”¨ Connection-001
   â”‚
   â””â”€â†’ äº‹åŠ¡ç»“æŸï¼Œå…³é—­ Connection-001
```

### 4.2 èµ„æºç»‘å®šçš„å®ç°åŸç†


**åº•å±‚å®ç°æœºåˆ¶**ï¼š

```java
// Springå†…éƒ¨çš„èµ„æºç»‘å®šé€»è¾‘
public class DataSourceUtils {
    
    public static Connection getConnection(DataSource dataSource) {
        // 1. å…ˆä»çº¿ç¨‹æœ¬åœ°å­˜å‚¨è·å–
        Connection conn = (Connection) 
            TransactionSynchronizationManager.getResource(dataSource);
        
        if (conn != null) {
            // æ‰¾åˆ°äº†ï¼Œå¤ç”¨è¿™ä¸ªè¿æ¥
            return conn;
        }
        
        // 2. æ²¡æ‰¾åˆ°ï¼Œåˆ›å»ºæ–°è¿æ¥
        conn = dataSource.getConnection();
        
        // 3. å¦‚æœå½“å‰åœ¨äº‹åŠ¡ä¸­ï¼Œç»‘å®šè¿™ä¸ªè¿æ¥
        if (TransactionSynchronizationManager.isSynchronizationActive()) {
            TransactionSynchronizationManager.bindResource(
                dataSource, 
                conn
            );
        }
        
        return conn;
    }
}
```

**å…³é”®ç‚¹è¯´æ˜**ï¼š

```
ğŸ”¸ ç¬¬ä¸€æ¬¡è·å–è¿æ¥ï¼šåˆ›å»ºæ–°è¿æ¥å¹¶ç»‘å®š
ğŸ”¸ åç»­è·å–è¿æ¥ï¼šç›´æ¥è¿”å›å·²ç»‘å®šçš„è¿æ¥
ğŸ”¸ äº‹åŠ¡ç»“æŸï¼šè§£ç»‘å¹¶å…³é—­è¿æ¥
ğŸ”¸ çº¿ç¨‹éš”ç¦»ï¼šæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ç»‘å®šèµ„æº
```

### 4.3 è¿æ¥å¤ç”¨çš„å®Œæ•´æµç¨‹


**è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹**ï¼š

```
ç”¨æˆ·è¯·æ±‚ â†’ Controller â†’ Serviceæ–¹æ³•(@Transactional)
                              â”‚
                              â”œâ”€â†’ [1] AOPæ‹¦æˆªï¼Œå¼€å¯äº‹åŠ¡
                              â”‚      - åˆ›å»ºConnection
                              â”‚      - è®¾ç½®autoCommit=false
                              â”‚      - ç»‘å®šåˆ°ThreadLocal
                              â”‚
                              â”œâ”€â†’ [2] æ‰§è¡Œä¸šåŠ¡ä»£ç 
                              â”‚      
                              â”‚      accountRepository.deduct()
                              â”‚         â””â”€â†’ è·å–è¿æ¥
                              â”‚             â””â”€â†’ ä»ThreadLocalå–å‡º
                              â”‚             â””â”€â†’ æ‰§è¡ŒSQL
                              â”‚      
                              â”‚      accountRepository.add()
                              â”‚         â””â”€â†’ è·å–è¿æ¥
                              â”‚             â””â”€â†’ ä»ThreadLocalå–å‡ºï¼ˆåŒä¸€ä¸ªï¼ï¼‰
                              â”‚             â””â”€â†’ æ‰§è¡ŒSQL
                              â”‚
                              â””â”€â†’ [3] æäº¤äº‹åŠ¡
                                     - conn.commit()
                                     - è§£ç»‘èµ„æº
                                     - conn.close()
```

**éªŒè¯è¿æ¥å¤ç”¨çš„ä»£ç **ï¼š

```java
@Service
public class DebugService {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    @Transactional
    public void testConnectionReuse() {
        // è·å–ç¬¬ä¸€æ¬¡è¿æ¥çš„hashCode
        Integer hash1 = jdbcTemplate.execute((Connection conn) -> {
            System.out.println("ç¬¬1æ¬¡æ“ä½œ: " + conn.hashCode());
            return conn.hashCode();
        });
        
        // è·å–ç¬¬äºŒæ¬¡è¿æ¥çš„hashCode
        Integer hash2 = jdbcTemplate.execute((Connection conn) -> {
            System.out.println("ç¬¬2æ¬¡æ“ä½œ: " + conn.hashCode());
            return conn.hashCode();
        });
        
        // è¾“å‡ºï¼šä¸¤æ¬¡hashCodeç›¸åŒï¼Œè¯æ˜æ˜¯åŒä¸€ä¸ªè¿æ¥
        System.out.println("è¿æ¥å¤ç”¨: " + hash1.equals(hash2));
    }
}
```

### 4.4 å¤šæ•°æ®æºåœºæ™¯çš„èµ„æºç»‘å®š


**å¤šæ•°æ®æºé…ç½®**ï¼š

```java
@Configuration
public class MultiDataSourceConfig {
    
    @Bean
    @Primary
    public DataSource primaryDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    public DataSource secondaryDataSource() {
        return DataSourceBuilder.create().build();
    }
}
```

**èµ„æºç»‘å®šç­–ç•¥**ï¼š

```
Thread-1 æ‰§è¡Œäº‹åŠ¡ï¼š
  TransactionSynchronizationManager:
    resources: 
      primaryDataSource   â†’ Connection-A
      secondaryDataSource â†’ Connection-B
    
æ¯ä¸ªæ•°æ®æºç»‘å®šå„è‡ªçš„è¿æ¥ï¼Œäº’ä¸å½±å“
åŒä¸€æ•°æ®æºåœ¨åŒä¸€äº‹åŠ¡ä¸­å¤ç”¨åŒä¸€è¿æ¥
```

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š

```java
@Service
public class MultiDataSourceService {
    
    @Autowired
    @Qualifier("primaryDataSource")
    private DataSource primaryDS;
    
    @Autowired
    @Qualifier("secondaryDataSource")
    private DataSource secondaryDS;
    
    @Transactional
    public void crossDataSourceOperation() {
        // æ“ä½œä¸»æ•°æ®åº“
        Connection conn1 = DataSourceUtils.getConnection(primaryDS);
        // ... æ‰§è¡ŒSQL
        
        // æ“ä½œä»æ•°æ®åº“
        Connection conn2 = DataSourceUtils.getConnection(secondaryDS);
        // ... æ‰§è¡ŒSQL
        
        // conn1å’Œconn2æ˜¯ä¸åŒçš„è¿æ¥
        // ä½†å„è‡ªåœ¨è‡ªå·±çš„æ•°æ®æºèŒƒå›´å†…ä¼šè¢«å¤ç”¨
    }
}
```

---

## 5. ğŸ“ äº‹åŠ¡å›è°ƒæœºåˆ¶


### 5.1 å›è°ƒæœºåˆ¶çš„åº”ç”¨åœºæ™¯


**å…¸å‹åœºæ™¯æ±‡æ€»**ï¼š

| åœºæ™¯ | **å›è°ƒæ—¶æœº** | **ç¤ºä¾‹ä»£ç ** |
|------|------------|-------------|
| **æ¶ˆæ¯å‘é€** | `afterCommit` | `å‘é€è®¢å•é€šçŸ¥çŸ­ä¿¡` |
| **ç¼“å­˜æ›´æ–°** | `afterCommit` | `åˆ·æ–°Redisç¼“å­˜` |
| **æ—¥å¿—è®°å½•** | `afterCompletion` | `è®°å½•æ“ä½œå®¡è®¡æ—¥å¿—` |
| **æ–‡ä»¶æ¸…ç†** | `afterCompletion` | `åˆ é™¤ä¸´æ—¶æ–‡ä»¶` |
| **ç»Ÿè®¡æ›´æ–°** | `afterCommit` | `æ›´æ–°ç»Ÿè®¡æ•°æ®` |
| **æœç´¢ç´¢å¼•** | `afterCommit` | `æ›´æ–°ESç´¢å¼•` |

### 5.2 è‡ªå®šä¹‰åŒæ­¥å™¨çš„æœ€ä½³å®è·µ


**å°è£…é€šç”¨åŒæ­¥å™¨**ï¼š

```java
// ç®€å•çš„æäº¤åå›è°ƒ
public class AfterCommitSynchronization 
    implements TransactionSynchronization {
    
    private final Runnable callback;
    
    public AfterCommitSynchronization(Runnable callback) {
        this.callback = callback;
    }
    
    @Override
    public void afterCommit() {
        callback.run();
    }
    
    // é™æ€å·¥å‚æ–¹æ³•
    public static void execute(Runnable callback) {
        if (TransactionSynchronizationManager.isSynchronizationActive()) {
            TransactionSynchronizationManager.registerSynchronization(
                new AfterCommitSynchronization(callback)
            );
        } else {
            callback.run();
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(Order order) {
        orderRepository.save(order);
        
        // ç®€åŒ–çš„å›è°ƒæ³¨å†Œ
        AfterCommitSynchronization.execute(() -> {
            smsService.send(order.getPhone(), "è®¢å•åˆ›å»ºæˆåŠŸ");
        });
    }
}
```

**å¸¦çŠ¶æ€åˆ¤æ–­çš„åŒæ­¥å™¨**ï¼š

```java
public class SmartSynchronization implements TransactionSynchronization {
    
    private final Runnable onSuccess;
    private final Runnable onRollback;
    private final Runnable always;
    
    @Override
    public void afterCommit() {
        if (onSuccess != null) {
            onSuccess.run();
        }
    }
    
    @Override
    public void afterCompletion(int status) {
        if (status == STATUS_ROLLED_BACK && onRollback != null) {
            onRollback.run();
        }
        if (always != null) {
            always.run();
        }
    }
    
    // æ„é€ å™¨å’ŒBuilderçœç•¥...
}

// ä½¿ç”¨
SmartSynchronization.builder()
    .onSuccess(() -> cache.update())
    .onRollback(() -> cache.clear())
    .always(() -> log.info("completed"))
    .register();
```

### 5.3 Springæä¾›çš„ä¾¿æ·å·¥å…·


**TransactionSynchronizationAdapter**ï¼š

```java
// Springæä¾›çš„é€‚é…å™¨ç±»ï¼Œç®€åŒ–å¼€å‘
public abstract class TransactionSynchronizationAdapter 
    implements TransactionSynchronization {
    
    // æ‰€æœ‰æ–¹æ³•éƒ½æœ‰é»˜è®¤å®ç°ï¼Œåªéœ€é‡å†™éœ€è¦çš„æ–¹æ³•
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class NotificationService {
    
    @Transactional
    public void processOrder(Order order) {
        orderRepository.save(order);
        
        // åªéœ€é‡å†™afterCommitæ–¹æ³•
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronizationAdapter() {
                @Override
                public void afterCommit() {
                    emailService.sendConfirmation(order);
                }
            }
        );
    }
}
```

**@TransactionalEventListeneræ³¨è§£**ï¼š

```java
// Spring 4.2+ æä¾›çš„æ›´ç®€å•æ–¹å¼
@Component
public class OrderEventListener {
    
    // äº‹åŠ¡æäº¤åè‡ªåŠ¨è§¦å‘
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void handleOrderCreated(OrderCreatedEvent event) {
        smsService.send(event.getOrder());
    }
    
    // äº‹åŠ¡å›æ»šåè§¦å‘
    @TransactionalEventListener(phase = TransactionPhase.AFTER_ROLLBACK)
    public void handleOrderFailed(OrderCreatedEvent event) {
        logService.recordFailure(event.getOrder());
    }
}

// åœ¨Serviceä¸­å‘é€äº‹ä»¶
@Service
public class OrderService {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    @Transactional
    public void createOrder(Order order) {
        orderRepository.save(order);
        
        // å‘é€äº‹ä»¶ï¼Œç›‘å¬å™¨ä¼šåœ¨äº‹åŠ¡æäº¤åæ‰§è¡Œ
        eventPublisher.publishEvent(new OrderCreatedEvent(order));
    }
}
```

---

## 6. â³ åŒæ­¥ç”Ÿå‘½å‘¨æœŸç®¡ç†


### 6.1 å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ


**é˜¶æ®µè¯¦è§£**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         äº‹åŠ¡åŒæ­¥ç”Ÿå‘½å‘¨æœŸ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é˜¶æ®µ1: åˆå§‹åŒ–
  â””â”€â†’ TransactionSynchronizationManager.initSynchronization()
      - åˆ›å»ºåŒæ­¥å™¨åˆ—è¡¨
      - æ¿€æ´»åŒæ­¥æœºåˆ¶

é˜¶æ®µ2: æ³¨å†ŒåŒæ­¥å™¨
  â””â”€â†’ registerSynchronization(sync)
      - æ·»åŠ åˆ°åŒæ­¥å™¨åˆ—è¡¨
      - ç­‰å¾…åç»­å›è°ƒ

é˜¶æ®µ3: äº‹åŠ¡æ‰§è¡Œ
  â””â”€â†’ ä¸šåŠ¡ä»£ç æ‰§è¡Œ
      - å¯èƒ½è§¦å‘ suspend/resumeï¼ˆåµŒå¥—äº‹åŠ¡ï¼‰
      - å¯èƒ½è§¦å‘ flushï¼ˆå¼ºåˆ¶åˆ·æ–°ï¼‰

é˜¶æ®µ4: æäº¤å‡†å¤‡
  â””â”€â†’ beforeCommit(readOnly)
      â””â”€â†’ beforeCompletion()
      - æœ€åçš„éªŒè¯å’Œå‡†å¤‡

é˜¶æ®µ5: æäº¤/å›æ»š
  â”œâ”€â†’ æˆåŠŸ: afterCommit()
  â””â”€â†’ å¤±è´¥: (ä¸è°ƒç”¨afterCommit)

é˜¶æ®µ6: æ¸…ç†
  â””â”€â†’ afterCompletion(status)
      â””â”€â†’ TransactionSynchronizationManager.clearSynchronization()
          - æ¸…ç©ºåŒæ­¥å™¨åˆ—è¡¨
          - é‡Šæ”¾æ‰€æœ‰èµ„æº
```

### 6.2 åµŒå¥—äº‹åŠ¡ä¸­çš„ç”Ÿå‘½å‘¨æœŸ


**åµŒå¥—åœºæ™¯ç¤ºä¾‹**ï¼š

```java
@Service
public class OuterService {
    
    @Autowired
    private InnerService innerService;
    
    @Transactional
    public void outerMethod() {
        System.out.println("å¤–å±‚äº‹åŠ¡å¼€å§‹");
        
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronization() {
                @Override
                public void suspend() {
                    System.out.println("å¤–å±‚äº‹åŠ¡æŒ‚èµ·");
                }
                
                @Override
                public void resume() {
                    System.out.println("å¤–å±‚äº‹åŠ¡æ¢å¤");
                }
                
                @Override
                public void afterCommit() {
                    System.out.println("å¤–å±‚äº‹åŠ¡æäº¤");
                }
            }
        );
        
        // è°ƒç”¨å†…å±‚äº‹åŠ¡
        innerService.innerMethod();
        
        System.out.println("å¤–å±‚äº‹åŠ¡ç»“æŸ");
    }
}

@Service
public class InnerService {
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void innerMethod() {
        System.out.println("å†…å±‚äº‹åŠ¡æ‰§è¡Œ");
        
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronization() {
                @Override
                public void afterCommit() {
                    System.out.println("å†…å±‚äº‹åŠ¡æäº¤");
                }
            }
        );
    }
}
```

**æ‰§è¡Œè¾“å‡º**ï¼š

```
å¤–å±‚äº‹åŠ¡å¼€å§‹
å¤–å±‚äº‹åŠ¡æŒ‚èµ·              â† suspend()
å†…å±‚äº‹åŠ¡æ‰§è¡Œ
å†…å±‚äº‹åŠ¡æäº¤              â† å†…å±‚afterCommit()
å¤–å±‚äº‹åŠ¡æ¢å¤              â† resume()
å¤–å±‚äº‹åŠ¡ç»“æŸ
å¤–å±‚äº‹åŠ¡æäº¤              â† å¤–å±‚afterCommit()
```

### 6.3 å¼‚å¸¸åœºæ™¯ä¸‹çš„ç”Ÿå‘½å‘¨æœŸ


**å¼‚å¸¸å¤„ç†æµç¨‹**ï¼š

```java
@Transactional
public void methodWithException() {
    
    // æ³¨å†ŒåŒæ­¥å™¨
    TransactionSynchronizationManager.registerSynchronization(
        new TransactionSynchronization() {
            @Override
            public void beforeCommit(boolean readOnly) {
                System.out.println("å‡†å¤‡æäº¤");
                // è¿™é‡ŒæŠ›å¼‚å¸¸ä¼šå¯¼è‡´å›æ»š
            }
            
            @Override
            public void beforeCompletion() {
                System.out.println("å³å°†å®Œæˆ");
                // æˆåŠŸå’Œå¤±è´¥éƒ½ä¼šè°ƒç”¨
            }
            
            @Override
            public void afterCommit() {
                System.out.println("æäº¤æˆåŠŸ");
                // åªæœ‰æˆåŠŸæ‰è°ƒç”¨
            }
            
            @Override
            public void afterCompletion(int status) {
                if (status == STATUS_ROLLED_BACK) {
                    System.out.println("å·²å›æ»š");
                } else {
                    System.out.println("å·²æäº¤");
                }
            }
        }
    );
    
    // æ¨¡æ‹Ÿå¼‚å¸¸
    throw new RuntimeException("ä¸šåŠ¡å¼‚å¸¸");
}
```

**è¾“å‡ºç»“æœ**ï¼š

```
å³å°†å®Œæˆ                  â† beforeCompletion()
å·²å›æ»š                    â† afterCompletion(STATUS_ROLLED_BACK)

æ³¨æ„ï¼š
- beforeCommit() ä¸ä¼šè°ƒç”¨ï¼ˆå› ä¸ºæ²¡æœ‰æäº¤ï¼‰
- afterCommit() ä¸ä¼šè°ƒç”¨ï¼ˆå› ä¸ºå›æ»šäº†ï¼‰
- afterCompletion() ä¸€å®šä¼šè°ƒç”¨
```

### 6.4 èµ„æºæ¸…ç†çš„æœ€ä½³å®è·µ


**æ­£ç¡®çš„æ¸…ç†æ–¹å¼**ï¼š

```java
@Service
public class FileService {
    
    @Transactional
    public void uploadWithTransaction(MultipartFile file) {
        // ä¸´æ—¶æ–‡ä»¶è·¯å¾„
        final String tempPath = saveTempFile(file);
        
        // æ•°æ®åº“è®°å½•
        FileRecord record = new FileRecord();
        record.setFileName(file.getOriginalFilename());
        fileRepository.save(record);
        
        // æ³¨å†Œæ¸…ç†åŒæ­¥å™¨
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronization() {
                
                private String finalPath;
                
                @Override
                public void beforeCommit(boolean readOnly) {
                    // æäº¤å‰å‡†å¤‡æœ€ç»ˆè·¯å¾„
                    finalPath = "/files/" + record.getId();
                }
                
                @Override
                public void afterCommit() {
                    try {
                        // æäº¤æˆåŠŸï¼Œç§»åŠ¨æ–‡ä»¶
                        Files.move(
                            Paths.get(tempPath), 
                            Paths.get(finalPath)
                        );
                    } catch (IOException e) {
                        log.error("æ–‡ä»¶ç§»åŠ¨å¤±è´¥", e);
                    }
                }
                
                @Override
                public void afterCompletion(int status) {
                    // ä¸ç®¡æˆåŠŸå¤±è´¥ï¼Œæ¸…ç†ä¸´æ—¶æ–‡ä»¶
                    try {
                        if (status == STATUS_ROLLED_BACK) {
                            // å›æ»šäº†ï¼Œåˆ é™¤ä¸´æ—¶æ–‡ä»¶
                            Files.deleteIfExists(Paths.get(tempPath));
                        }
                    } catch (IOException e) {
                        log.error("æ¸…ç†å¤±è´¥", e);
                    }
                }
            }
        );
    }
}
```

**å…³é”®ç‚¹æ€»ç»“**ï¼š

```
âœ… èµ„æºæ¸…ç†è¦ç‚¹ï¼š

1. beforeCompletion()ï¼š
   - é€‚åˆåšæœ€åçš„å‡†å¤‡å·¥ä½œ
   - æˆåŠŸå’Œå¤±è´¥éƒ½ä¼šæ‰§è¡Œ
   - å¯ä»¥è®¿é—®äº‹åŠ¡èµ„æº

2. afterCompletion()ï¼š
   - æœ€ç»ˆä¸€å®šä¼šæ‰§è¡Œ
   - æ ¹æ®statusåˆ¤æ–­æ˜¯å¦æˆåŠŸ
   - é€‚åˆåšæ¸…ç†å·¥ä½œ

3. å¼‚å¸¸å¤„ç†ï¼š
   - å›è°ƒæ–¹æ³•ä¸­çš„å¼‚å¸¸ä¸å½±å“äº‹åŠ¡
   - ä½†è¦è®°å½•æ—¥å¿—ï¼Œé¿å…é—®é¢˜è¢«éšè—

4. èµ„æºé‡Šæ”¾ï¼š
   - ä¸´æ—¶èµ„æºåœ¨afterCompletionä¸­é‡Šæ”¾
   - æ°¸ä¹…èµ„æºåœ¨afterCommitä¸­ç¡®è®¤
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ äº‹åŠ¡åŒæ­¥ï¼šåœ¨äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸçš„ç‰¹å®šæ—¶åˆ»æ‰§è¡Œå›è°ƒçš„æœºåˆ¶
ğŸ”¸ åŒæ­¥å™¨æ¥å£ï¼šTransactionSynchronizationæä¾›å¤šä¸ªå›è°ƒæ–¹æ³•
ğŸ”¸ ç®¡ç†å™¨ï¼šTransactionSynchronizationManagerç®¡ç†èµ„æºå’ŒåŒæ­¥å™¨
ğŸ”¸ èµ„æºç»‘å®šï¼šç¡®ä¿åŒä¸€äº‹åŠ¡ä½¿ç”¨åŒä¸€æ•°æ®åº“è¿æ¥
ğŸ”¸ è¿æ¥å¤ç”¨ï¼šé€šè¿‡ThreadLocalå®ç°çº¿ç¨‹å†…è¿æ¥å¤ç”¨
ğŸ”¸ å›è°ƒæ—¶æœºï¼šbeforeCommitã€afterCommitã€afterCompletionç­‰
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**æ ¸å¿ƒæœºåˆ¶ç†è§£**ï¼š

| æ¦‚å¿µ | **æ ¸å¿ƒç†è§£** |
|------|-------------|
| **åŒæ­¥å™¨** | `äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸçš„é’©å­å‡½æ•°ï¼Œå¯ä»¥åœ¨ç‰¹å®šæ—¶åˆ»æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘` |
| **èµ„æºç»‘å®š** | `å°†æ•°æ®åº“è¿æ¥ç»‘å®šåˆ°çº¿ç¨‹ï¼Œç¡®ä¿äº‹åŠ¡å†…ä½¿ç”¨åŒä¸€è¿æ¥` |
| **ThreadLocal** | `æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹å­˜å‚¨ï¼Œäº’ä¸å¹²æ‰°ï¼Œå®ç°çº¿ç¨‹éš”ç¦»` |
| **å›è°ƒé¡ºåº** | `beforeCommit â†’ afterCommit â†’ afterCompletion` |
| **å¼‚å¸¸å¤„ç†** | `å›è°ƒæ–¹æ³•ä¸­çš„å¼‚å¸¸ä¸ä¼šå½±å“äº‹åŠ¡æœ¬èº«` |

### 7.3 å®é™…åº”ç”¨å»ºè®®


**åº”ç”¨åœºæ™¯é€‰æ‹©**ï¼š

```
âœ… é€‚åˆä½¿ç”¨äº‹åŠ¡åŒæ­¥çš„åœºæ™¯ï¼š
- äº‹åŠ¡æˆåŠŸåå‘é€é€šçŸ¥ï¼ˆçŸ­ä¿¡ã€é‚®ä»¶ï¼‰
- äº‹åŠ¡æäº¤åæ›´æ–°ç¼“å­˜
- äº‹åŠ¡å®Œæˆåæ›´æ–°æœç´¢ç´¢å¼•
- äº‹åŠ¡å›æ»šåæ¸…ç†ä¸´æ—¶èµ„æº
- äº‹åŠ¡ç»“æŸåè®°å½•å®¡è®¡æ—¥å¿—

âŒ ä¸é€‚åˆçš„åœºæ™¯ï¼š
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆåº”è¯¥åœ¨äº‹åŠ¡å†…æ‰§è¡Œï¼‰
- éœ€è¦å‚ä¸äº‹åŠ¡å›æ»šçš„æ“ä½œ
- è€—æ—¶çš„åŒæ­¥æ“ä½œï¼ˆå¯èƒ½é˜»å¡äº‹åŠ¡æäº¤ï¼‰
```

**æœ€ä½³å®è·µå»ºè®®**ï¼š

```
1. ä¼˜å…ˆä½¿ç”¨Springæä¾›çš„å·¥å…·ï¼š
   âœ… @TransactionalEventListenerï¼ˆæœ€ç®€å•ï¼‰
   âœ… TransactionSynchronizationAdapterï¼ˆéœ€è¦ç»†ç²’åº¦æ§åˆ¶ï¼‰
   âœ… è‡ªå®šä¹‰å·¥å…·ç±»å°è£…ï¼ˆé¡¹ç›®ç»Ÿä¸€è§„èŒƒï¼‰

2. å›è°ƒæ–¹æ³•çš„ä½¿ç”¨åŸåˆ™ï¼š
   - afterCommitï¼šå‘é€é€šçŸ¥ã€æ›´æ–°ç¼“å­˜
   - afterCompletionï¼šæ¸…ç†èµ„æºã€è®°å½•æ—¥å¿—
   - beforeCommitï¼šæœ€åçš„æ•°æ®éªŒè¯

3. å¼‚å¸¸å¤„ç†ï¼š
   - å›è°ƒä¸­çš„å¼‚å¸¸è¦æ•è·å¹¶è®°å½•
   - ä¸è¦è®©å›è°ƒå¼‚å¸¸å½±å“ä¸»æµç¨‹
   - è€ƒè™‘é‡è¯•æœºåˆ¶ï¼ˆæ¶ˆæ¯å‘é€å¤±è´¥ç­‰ï¼‰

4. æ€§èƒ½è€ƒè™‘ï¼š
   - å›è°ƒé€»è¾‘è¦å¿«é€Ÿæ‰§è¡Œ
   - è€—æ—¶æ“ä½œè€ƒè™‘å¼‚æ­¥å¤„ç†
   - é¿å…åœ¨å›è°ƒä¸­æ‰§è¡Œå¤æ‚æŸ¥è¯¢
```

**å¸¸è§é—®é¢˜è§£ç­”**ï¼š

```
Q1: ä¸ºä»€ä¹ˆä¸åœ¨ä¸šåŠ¡æ–¹æ³•æœ€åç›´æ¥å‘é€æ¶ˆæ¯ï¼Ÿ
A:  å› ä¸ºåç»­ä»£ç å¯èƒ½æŠ›å¼‚å¸¸å›æ»šï¼Œæ¶ˆæ¯å°±ç™½å‘äº†

Q2: afterCommitä¸­çš„å¼‚å¸¸ä¼šå¯¼è‡´äº‹åŠ¡å›æ»šå—ï¼Ÿ
A:  ä¸ä¼šï¼Œäº‹åŠ¡å·²ç»æäº¤äº†ï¼Œå¼‚å¸¸åªä¼šè¢«è®°å½•

Q3: å¦‚ä½•ç¡®ä¿æ¶ˆæ¯ä¸€å®šå‘é€æˆåŠŸï¼Ÿ
A:  å¯ä»¥ç»“åˆæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ–è€…è®°å½•å‘é€å¤±è´¥çš„æ¶ˆæ¯ï¼Œå®šæ—¶é‡è¯•

Q4: å¤šä¸ªåŒæ­¥å™¨çš„æ‰§è¡Œé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ
A:  æŒ‰æ³¨å†Œé¡ºåºæ‰§è¡Œï¼Œå…ˆæ³¨å†Œå…ˆæ‰§è¡Œ

Q5: åµŒå¥—äº‹åŠ¡ä¸­çš„åŒæ­¥å™¨å¦‚ä½•å·¥ä½œï¼Ÿ
A:  å¤–å±‚äº‹åŠ¡æŒ‚èµ·æ—¶è°ƒç”¨suspendï¼Œå†…å±‚äº‹åŠ¡å®Œæˆåå¤–å±‚resume
```

**è®°å¿†å£è¯€**ï¼š

```
äº‹åŠ¡åŒæ­¥å¾ˆé‡è¦ï¼Œå›è°ƒæ—¶æœºè¦è®°ç‰¢
beforeCommitæäº¤å‰ï¼ŒafterCommitäº‹æˆäº†
afterCompletionæœ€ç»ˆè°ƒï¼Œèµ„æºæ¸…ç†å°‘ä¸äº†
èµ„æºç»‘å®šç”¨ThreadLocalï¼ŒåŒä¸€äº‹åŠ¡åŒè¿æ¥
å‘é€æ¶ˆæ¯æ›´æ–°ç¼“å­˜ï¼Œéƒ½åœ¨afterCommitæå®š
```