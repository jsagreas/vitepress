---
title: 19ã€TransactionTemplateæ¨¡æ¿
---
## ğŸ“š ç›®å½•

1. [TransactionTemplateæ ¸å¿ƒæ¦‚å¿µ](#1-TransactionTemplateæ ¸å¿ƒæ¦‚å¿µ)
2. [åŸºæœ¬ä½¿ç”¨æ–¹å¼](#2-åŸºæœ¬ä½¿ç”¨æ–¹å¼)
3. [å›è°ƒæ¥å£è¯¦è§£](#3-å›è°ƒæ¥å£è¯¦è§£)
4. [é…ç½®ä¸å®šåˆ¶åŒ–](#4-é…ç½®ä¸å®šåˆ¶åŒ–)
5. [å¼‚å¸¸å¤„ç†æœºåˆ¶](#5-å¼‚å¸¸å¤„ç†æœºåˆ¶)
6. [è¿”å›å€¼å¤„ç†ç­–ç•¥](#6-è¿”å›å€¼å¤„ç†ç­–ç•¥)
7. [å®æˆ˜åº”ç”¨åœºæ™¯](#7-å®æˆ˜åº”ç”¨åœºæ™¯)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ TransactionTemplateæ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯TransactionTemplate


**ç›´è§‚ç†è§£**ï¼šTransactionTemplateå°±åƒæ˜¯Springä¸ºæˆ‘ä»¬å‡†å¤‡å¥½çš„"äº‹åŠ¡å¤„ç†æ¨¡æ¿"ï¼Œå¸®æˆ‘ä»¬è‡ªåŠ¨å®Œæˆäº‹åŠ¡çš„å¼€å¯ã€æäº¤å’Œå›æ»šï¼Œæˆ‘ä»¬åªéœ€è¦ä¸“æ³¨äºç¼–å†™ä¸šåŠ¡é€»è¾‘ã€‚

```
ä¼ ç»Ÿç¼–ç¨‹å¼äº‹åŠ¡å†™æ³•ï¼š
å¼€å¯äº‹åŠ¡ â†’ æ‰§è¡Œä¸šåŠ¡ â†’ æäº¤äº‹åŠ¡ â†’ (å‡ºé”™å°±å›æ»š)
æ¯æ¬¡éƒ½è¦æ‰‹åŠ¨å†™è¿™äº›æ­¥éª¤ï¼Œå¾ˆç¹çï¼

ä½¿ç”¨TransactionTemplateï¼š
åªå†™ä¸šåŠ¡é€»è¾‘ï¼Œäº‹åŠ¡ç®¡ç†è‡ªåŠ¨æå®šï¼
```

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- ğŸ”¸ **æ¨¡æ¿æ¨¡å¼åº”ç”¨**ï¼šå°è£…äº†äº‹åŠ¡çš„é€šç”¨å¤„ç†æµç¨‹
- ğŸ”¸ **ç¼–ç¨‹å¼æ§åˆ¶**ï¼šä»£ç ä¸­ç›´æ¥æ§åˆ¶äº‹åŠ¡è¾¹ç•Œ
- ğŸ”¸ **çµæ´»æ€§é«˜**ï¼šå¯ä»¥åœ¨æ–¹æ³•å†…éƒ¨ä»»æ„ä½ç½®ä½¿ç”¨
- ğŸ”¸ **Springé›†æˆ**ï¼šæ— ç¼é›†æˆåˆ°Springå®¹å™¨ä¸­

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦TransactionTemplate


**è§£å†³çš„é—®é¢˜**ï¼š

```
é—®é¢˜åœºæ™¯1ï¼šå¤æ‚çš„äº‹åŠ¡é€»è¾‘
æŸäº›ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œäº‹åŠ¡éœ€è¦æ ¹æ®æ¡ä»¶åŠ¨æ€æ§åˆ¶
å£°æ˜å¼äº‹åŠ¡(@Transactional)åšä¸åˆ°è¿™ä¹ˆçµæ´»

é—®é¢˜åœºæ™¯2ï¼šç»†ç²’åº¦æ§åˆ¶
ä¸€ä¸ªæ–¹æ³•ä¸­åªæœ‰éƒ¨åˆ†ä»£ç éœ€è¦äº‹åŠ¡
ä¸æƒ³æ•´ä¸ªæ–¹æ³•éƒ½åŠ äº‹åŠ¡

é—®é¢˜åœºæ™¯3ï¼šç¼–ç¨‹çµæ´»æ€§
éœ€è¦åœ¨è¿è¡Œæ—¶åŠ¨æ€å†³å®šæ˜¯å¦å¼€å¯äº‹åŠ¡
æˆ–è€…éœ€è¦å¤„ç†å¤šä¸ªä¸åŒçš„äº‹åŠ¡
```

**TransactionTemplateçš„ä¼˜åŠ¿**ï¼š
- âœ… æ¯”ç›´æ¥ä½¿ç”¨PlatformTransactionManageræ›´ç®€å•
- âœ… æ¯”å£°æ˜å¼äº‹åŠ¡@Transactionalæ›´çµæ´»
- âœ… è‡ªåŠ¨å¤„ç†äº‹åŠ¡çš„æäº¤å’Œå›æ»š
- âœ… ä»£ç æ›´æ¸…æ™°ï¼Œæ˜“äºç†è§£

### 1.3 å·¥ä½œåŸç†ç®€è¿°


```
ç”¨æˆ·ä»£ç è°ƒç”¨ transactionTemplate.execute()
         â†“
   TransactionTemplateå†…éƒ¨å¤„ç†
         â†“
    å¼€å¯äº‹åŠ¡(begin)
         â†“
 æ‰§è¡Œä½ çš„ä¸šåŠ¡ä»£ç (callback)
         â†“
   â”Œâ”€â”€â”€ æˆåŠŸæ‰§è¡Œå®Œæ¯• â”€â”€â”€â”
   â†“                    â†“
æäº¤äº‹åŠ¡(commit)    æŠ›å‡ºå¼‚å¸¸
                        â†“
                  å›æ»šäº‹åŠ¡(rollback)
```

---

## 2. ğŸ’» åŸºæœ¬ä½¿ç”¨æ–¹å¼


### 2.1 é…ç½®TransactionTemplate


**ç¬¬ä¸€æ­¥ï¼šæ³¨å…¥äº‹åŠ¡ç®¡ç†å™¨**

```java
@Configuration
public class TransactionConfig {
    
    // é…ç½®äº‹åŠ¡ç®¡ç†å™¨
    @Bean
    public PlatformTransactionManager transactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
    
    // é…ç½®TransactionTemplate
    @Bean
    public TransactionTemplate transactionTemplate(
            PlatformTransactionManager transactionManager) {
        return new TransactionTemplate(transactionManager);
    }
}
```

**ç¬¬äºŒæ­¥ï¼šæ³¨å…¥åˆ°ä¸šåŠ¡ç±»ä¸­ä½¿ç”¨**

```java
@Service
public class UserService {
    
    @Autowired
    private TransactionTemplate transactionTemplate;
    
    @Autowired
    private UserMapper userMapper;
    
    // ä½¿ç”¨TransactionTemplateæ‰§è¡Œäº‹åŠ¡
    public void transferMoney(Long fromId, Long toId, BigDecimal amount) {
        transactionTemplate.execute(status -> {
            // è¿™é‡Œçš„ä»£ç ä¼šåœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
            userMapper.deductBalance(fromId, amount);
            userMapper.addBalance(toId, amount);
            return null;
        });
    }
}
```

### 2.2 æœ€ç®€ä½¿ç”¨ç¤ºä¾‹


**æ— è¿”å›å€¼çš„äº‹åŠ¡æ“ä½œ**ï¼š

```java
public void saveUser(User user) {
    transactionTemplate.execute(status -> {
        userMapper.insert(user);
        // æ‰§è¡Œå…¶ä»–æ•°æ®åº“æ“ä½œ...
        return null;  // æ— è¿”å›å€¼æ—¶è¿”å›null
    });
}
```

**æœ‰è¿”å›å€¼çš„äº‹åŠ¡æ“ä½œ**ï¼š

```java
public User getUserById(Long id) {
    return transactionTemplate.execute(status -> {
        User user = userMapper.selectById(id);
        // å¯ä»¥åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œå¤šä¸ªæ“ä½œ
        return user;  // è¿”å›æŸ¥è¯¢ç»“æœ
    });
}
```

### 2.3 æ ¸å¿ƒæ–¹æ³•execute()


**æ–¹æ³•ç­¾å**ï¼š
```java
public <T> T execute(TransactionCallback<T> action)
```

**å«ä¹‰è§£è¯»**ï¼š
- `<T>`ï¼šæ³›å‹ï¼Œè¡¨ç¤ºè¿”å›å€¼ç±»å‹
- `TransactionCallback<T>`ï¼šå›è°ƒæ¥å£ï¼Œå®šä¹‰äº‹åŠ¡ä¸­è¦æ‰§è¡Œçš„é€»è¾‘
- è¿”å›å€¼ï¼šå°±æ˜¯ä½ åœ¨å›è°ƒä¸­è¿”å›çš„å†…å®¹

**æ‰§è¡Œæµç¨‹**ï¼š

```
è°ƒç”¨ execute(callback)
    â†“
TransactionTemplate å¼€å¯äº‹åŠ¡
    â†“
æ‰§è¡Œ callback ä¸­çš„ä¸šåŠ¡ä»£ç 
    â†“
å¦‚æœæ­£å¸¸æ‰§è¡Œå®Œæˆ
    â†“
è‡ªåŠ¨æäº¤äº‹åŠ¡å¹¶è¿”å›ç»“æœ
    â†“
å¦‚æœæŠ›å‡ºå¼‚å¸¸
    â†“
è‡ªåŠ¨å›æ»šäº‹åŠ¡å¹¶æŠ›å‡ºå¼‚å¸¸
```

---

## 3. ğŸ”§ å›è°ƒæ¥å£è¯¦è§£


### 3.1 TransactionCallbackæ¥å£


**æ¥å£å®šä¹‰**ï¼š

```java
@FunctionalInterface
public interface TransactionCallback<T> {
    T doInTransaction(TransactionStatus status);
}
```

**æ ¸å¿ƒè¯´æ˜**ï¼š
- è¿™æ˜¯ä¸€ä¸ª**å‡½æ•°å¼æ¥å£**ï¼Œå¯ä»¥ç”¨Lambdaè¡¨è¾¾å¼
- `doInTransaction`æ–¹æ³•ï¼šå®šä¹‰äº‹åŠ¡ä¸­è¦æ‰§è¡Œçš„é€»è¾‘
- `TransactionStatus`å‚æ•°ï¼šä»£è¡¨å½“å‰äº‹åŠ¡çš„çŠ¶æ€
- `<T>`æ³›å‹ï¼šæŒ‡å®šè¿”å›å€¼ç±»å‹

**ä½¿ç”¨æ–¹å¼å¯¹æ¯”**ï¼š

```java
// æ–¹å¼1ï¼šLambdaè¡¨è¾¾å¼ï¼ˆæ¨èï¼Œç®€æ´ï¼‰
User user = transactionTemplate.execute(status -> {
    return userMapper.selectById(1L);
});

// æ–¹å¼2ï¼šåŒ¿åå†…éƒ¨ç±»ï¼ˆä¼ ç»Ÿå†™æ³•ï¼‰
User user = transactionTemplate.execute(new TransactionCallback<User>() {
    @Override
    public User doInTransaction(TransactionStatus status) {
        return userMapper.selectById(1L);
    }
});
```

### 3.2 TransactionCallbackWithoutResultæ¥å£


**æ¥å£å®šä¹‰**ï¼š

```java
public abstract class TransactionCallbackWithoutResult 
        implements TransactionCallback<Object> {
    
    @Override
    public final Object doInTransaction(TransactionStatus status) {
        doInTransactionWithoutResult(status);
        return null;
    }
    
    protected abstract void doInTransactionWithoutResult(TransactionStatus status);
}
```

**æ ¸å¿ƒè¯´æ˜**ï¼š
- ä¸“é—¨ç”¨äº**æ²¡æœ‰è¿”å›å€¼**çš„äº‹åŠ¡æ“ä½œ
- ä¸éœ€è¦å†™`return null`ï¼Œä»£ç æ›´ç®€æ´
- æœ¬è´¨ä¸Šæ˜¯å¯¹TransactionCallbackçš„å°è£…

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
// æ²¡æœ‰è¿”å›å€¼çš„æ“ä½œ
transactionTemplate.execute(new TransactionCallbackWithoutResult() {
    @Override
    protected void doInTransactionWithoutResult(TransactionStatus status) {
        userMapper.updateUser(user);
        orderMapper.updateOrder(order);
        // ä¸éœ€è¦è¿”å›å€¼
    }
});
```

### 3.3 TransactionStatuså‚æ•°è¯¦è§£


**TransactionStatusçš„ä½œç”¨**ï¼š

```java
public interface TransactionStatus {
    boolean isNewTransaction();        // æ˜¯å¦æ˜¯æ–°äº‹åŠ¡
    boolean hasSavepoint();           // æ˜¯å¦æœ‰ä¿å­˜ç‚¹
    void setRollbackOnly();           // æ ‡è®°ä¸ºåªå›æ»š
    boolean isRollbackOnly();         // æ˜¯å¦å·²æ ‡è®°ä¸ºåªå›æ»š
    boolean isCompleted();            // äº‹åŠ¡æ˜¯å¦å·²å®Œæˆ
}
```

**å®é™…åº”ç”¨åœºæ™¯**ï¼š

```java
transactionTemplate.execute(status -> {
    try {
        userMapper.insert(user);
        orderMapper.insert(order);
    } catch (Exception e) {
        // æ‰‹åŠ¨æ ‡è®°äº‹åŠ¡éœ€è¦å›æ»š
        status.setRollbackOnly();
        log.error("ä¸šåŠ¡æ‰§è¡Œå¤±è´¥", e);
        return null;
    }
    return "success";
});
```

**å…³é”®æ–¹æ³•è¯´æ˜**ï¼š

| æ–¹æ³• | **ä½œç”¨** | **ä½¿ç”¨åœºæ™¯** |
|------|---------|-------------|
| `setRollbackOnly()` | æ ‡è®°äº‹åŠ¡å¿…é¡»å›æ»š | æ•è·å¼‚å¸¸åæƒ³å›æ»šä½†ä¸æŠ›å‡ºå¼‚å¸¸ |
| `isRollbackOnly()` | æ£€æŸ¥æ˜¯å¦å·²æ ‡è®°å›æ»š | åˆ¤æ–­äº‹åŠ¡çŠ¶æ€ï¼Œå†³å®šåç»­é€»è¾‘ |
| `isNewTransaction()` | åˆ¤æ–­æ˜¯å¦æ–°äº‹åŠ¡ | åœ¨äº‹åŠ¡ä¼ æ’­ä¸­åˆ¤æ–­äº‹åŠ¡ç±»å‹ |

---

## 4. âš™ï¸ é…ç½®ä¸å®šåˆ¶åŒ–


### 4.1 äº‹åŠ¡å±æ€§é…ç½®


**åŸºæœ¬é…ç½®é¡¹**ï¼š

```java
@Bean
public TransactionTemplate transactionTemplate(
        PlatformTransactionManager transactionManager) {
    
    TransactionTemplate template = new TransactionTemplate(transactionManager);
    
    // è®¾ç½®äº‹åŠ¡ä¼ æ’­è¡Œä¸º
    template.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);
    
    // è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«
    template.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED);
    
    // è®¾ç½®äº‹åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    template.setTimeout(30);
    
    // è®¾ç½®æ˜¯å¦åªè¯»äº‹åŠ¡
    template.setReadOnly(false);
    
    return template;
}
```

**é…ç½®é¡¹è¯¦è§£**ï¼š

ğŸ”¸ **ä¼ æ’­è¡Œä¸ºï¼ˆPropagationï¼‰**
```
REQUIREDï¼ˆé»˜è®¤ï¼‰ï¼šå¦‚æœæœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±æ–°å»º
REQUIRES_NEWï¼šæ€»æ˜¯æ–°å»ºäº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡
NESTEDï¼šåµŒå¥—äº‹åŠ¡ï¼Œä½¿ç”¨ä¿å­˜ç‚¹
SUPPORTSï¼šæœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±éäº‹åŠ¡æ‰§è¡Œ
```

ğŸ”¸ **éš”ç¦»çº§åˆ«ï¼ˆIsolationï¼‰**
```
READ_COMMITTEDï¼ˆæ¨èï¼‰ï¼šè¯»å·²æäº¤ï¼Œé¿å…è„è¯»
REPEATABLE_READï¼šå¯é‡å¤è¯»ï¼Œé¿å…ä¸å¯é‡å¤è¯»
SERIALIZABLEï¼šä¸²è¡ŒåŒ–ï¼Œæœ€é«˜çº§åˆ«ï¼Œæ€§èƒ½æœ€ä½
```

ğŸ”¸ **è¶…æ—¶æ—¶é—´ï¼ˆTimeoutï¼‰**
```java
// è®¾ç½®30ç§’è¶…æ—¶
template.setTimeout(30);

// é»˜è®¤ä½¿ç”¨æ•°æ®åº“çš„è¶…æ—¶è®¾ç½®
template.setTimeout(TransactionDefinition.TIMEOUT_DEFAULT);
```

ğŸ”¸ **åªè¯»æ ‡è¯†ï¼ˆReadOnlyï¼‰**
```java
// åªè¯»äº‹åŠ¡ï¼Œå¯ä»¥ä¼˜åŒ–æ€§èƒ½
template.setReadOnly(true);

// è¯»å†™äº‹åŠ¡ï¼ˆé»˜è®¤ï¼‰
template.setReadOnly(false);
```

### 4.2 åˆ›å»ºå¤šä¸ªTransactionTemplate


**åœºæ™¯éœ€æ±‚**ï¼šä¸åŒä¸šåŠ¡éœ€è¦ä¸åŒçš„äº‹åŠ¡é…ç½®

```java
@Configuration
public class MultiTransactionConfig {
    
    // é»˜è®¤äº‹åŠ¡æ¨¡æ¿
    @Bean
    public TransactionTemplate defaultTransactionTemplate(
            PlatformTransactionManager transactionManager) {
        return new TransactionTemplate(transactionManager);
    }
    
    // åªè¯»äº‹åŠ¡æ¨¡æ¿ï¼ˆç”¨äºæŸ¥è¯¢ï¼‰
    @Bean
    public TransactionTemplate readOnlyTransactionTemplate(
            PlatformTransactionManager transactionManager) {
        TransactionTemplate template = new TransactionTemplate(transactionManager);
        template.setReadOnly(true);
        template.setTimeout(10);
        return template;
    }
    
    // æ–°äº‹åŠ¡æ¨¡æ¿ï¼ˆç”¨äºç‹¬ç«‹äº‹åŠ¡ï¼‰
    @Bean
    public TransactionTemplate newTransactionTemplate(
            PlatformTransactionManager transactionManager) {
        TransactionTemplate template = new TransactionTemplate(transactionManager);
        template.setPropagationBehavior(
            TransactionDefinition.PROPAGATION_REQUIRES_NEW);
        return template;
    }
}
```

**ä½¿ç”¨ä¸åŒæ¨¡æ¿**ï¼š

```java
@Service
public class UserService {
    
    @Autowired
    @Qualifier("defaultTransactionTemplate")
    private TransactionTemplate defaultTemplate;
    
    @Autowired
    @Qualifier("readOnlyTransactionTemplate")
    private TransactionTemplate readOnlyTemplate;
    
    // ä½¿ç”¨é»˜è®¤äº‹åŠ¡
    public void saveUser(User user) {
        defaultTemplate.execute(status -> {
            userMapper.insert(user);
            return null;
        });
    }
    
    // ä½¿ç”¨åªè¯»äº‹åŠ¡
    public List<User> queryUsers() {
        return readOnlyTemplate.execute(status -> {
            return userMapper.selectAll();
        });
    }
}
```

---

## 5. âš ï¸ å¼‚å¸¸å¤„ç†æœºåˆ¶


### 5.1 å¼‚å¸¸å›æ»šè§„åˆ™


**é»˜è®¤å›æ»šè§„åˆ™**ï¼š

```
RuntimeException åŠå…¶å­ç±»       â†’ è‡ªåŠ¨å›æ»š
Error åŠå…¶å­ç±»                 â†’ è‡ªåŠ¨å›æ»š
å—æ£€å¼‚å¸¸(Checked Exception)    â†’ ä¸å›æ»šï¼Œæ­£å¸¸æäº¤
```

**ç¤ºä¾‹è¯´æ˜**ï¼š

```java
// åœºæ™¯1ï¼šè¿è¡Œæ—¶å¼‚å¸¸ï¼Œè‡ªåŠ¨å›æ»š
transactionTemplate.execute(status -> {
    userMapper.insert(user);
    if (user.getAge() < 0) {
        throw new RuntimeException("å¹´é¾„ä¸èƒ½ä¸ºè´Ÿæ•°");  // è§¦å‘å›æ»š
    }
    return null;
});

// åœºæ™¯2ï¼šå—æ£€å¼‚å¸¸ï¼Œä¸ä¼šå›æ»š
transactionTemplate.execute(status -> {
    try {
        userMapper.insert(user);
        // è¿™ä¸ªå¼‚å¸¸ä¸ä¼šè§¦å‘å›æ»šï¼
        throw new Exception("ä¸šåŠ¡å¼‚å¸¸");
    } catch (Exception e) {
        // éœ€è¦æ‰‹åŠ¨å›æ»š
        status.setRollbackOnly();
        throw new RuntimeException(e);  // è½¬æ¢ä¸ºè¿è¡Œæ—¶å¼‚å¸¸
    }
    return null;
});
```

### 5.2 æ‰‹åŠ¨æ§åˆ¶å›æ»š


**ä½¿ç”¨setRollbackOnly()**ï¼š

```java
transactionTemplate.execute(status -> {
    try {
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        userMapper.insert(user);
        orderMapper.insert(order);
        
    } catch (Exception e) {
        // æ‰‹åŠ¨æ ‡è®°å›æ»šï¼Œä½†ä¸æŠ›å‡ºå¼‚å¸¸
        status.setRollbackOnly();
        log.error("æ“ä½œå¤±è´¥ï¼Œäº‹åŠ¡å·²å›æ»š", e);
        return "failed";  // è¿”å›å¤±è´¥æ ‡è¯†
    }
    return "success";
});
```

**ä¸ºä»€ä¹ˆè¦æ‰‹åŠ¨å›æ»šï¼Ÿ**

```
åœºæ™¯1ï¼šæ•è·å¼‚å¸¸åæƒ³å›æ»šï¼Œä½†ä¸æƒ³å‘ä¸ŠæŠ›å¼‚å¸¸
åœºæ™¯2ï¼šæ ¹æ®ä¸šåŠ¡ç»“æœå†³å®šæ˜¯å¦å›æ»š
åœºæ™¯3ï¼šè®°å½•æ—¥å¿—æˆ–è¿”å›å‹å¥½æç¤ºï¼ŒåŒæ—¶å›æ»šäº‹åŠ¡
```

### 5.3 å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ


**æ¨èæ–¹å¼**ï¼š

```java
public String processOrder(Order order) {
    return transactionTemplate.execute(status -> {
        try {
            // 1. æ‰£å‡åº“å­˜
            inventoryMapper.deduct(order.getProductId(), order.getQuantity());
            
            // 2. åˆ›å»ºè®¢å•
            orderMapper.insert(order);
            
            // 3. æ‰£å‡ä½™é¢
            userMapper.deductBalance(order.getUserId(), order.getAmount());
            
            return "è®¢å•åˆ›å»ºæˆåŠŸ";
            
        } catch (InsufficientInventoryException e) {
            // åº“å­˜ä¸è¶³ï¼Œå›æ»šäº‹åŠ¡
            status.setRollbackOnly();
            log.warn("åº“å­˜ä¸è¶³: {}", e.getMessage());
            return "åº“å­˜ä¸è¶³ï¼Œè¯·ç¨åå†è¯•";
            
        } catch (InsufficientBalanceException e) {
            // ä½™é¢ä¸è¶³ï¼Œå›æ»šäº‹åŠ¡
            status.setRollbackOnly();
            log.warn("ä½™é¢ä¸è¶³: {}", e.getMessage());
            return "ä½™é¢ä¸è¶³ï¼Œè¯·å……å€¼åå†è¯•";
            
        } catch (Exception e) {
            // å…¶ä»–å¼‚å¸¸ï¼Œå›æ»šå¹¶æŠ›å‡º
            status.setRollbackOnly();
            log.error("è®¢å•å¤„ç†å¤±è´¥", e);
            throw new RuntimeException("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•", e);
        }
    });
}
```

---

## 6. ğŸ è¿”å›å€¼å¤„ç†ç­–ç•¥


### 6.1 æ— è¿”å›å€¼åœºæ™¯


**æ–¹å¼1ï¼šè¿”å›null**

```java
public void deleteUser(Long userId) {
    transactionTemplate.execute(status -> {
        userMapper.deleteById(userId);
        userRoleMapper.deleteByUserId(userId);
        return null;  // æ˜ç¡®è¿”å›null
    });
}
```

**æ–¹å¼2ï¼šä½¿ç”¨TransactionCallbackWithoutResult**

```java
public void deleteUser(Long userId) {
    transactionTemplate.execute(new TransactionCallbackWithoutResult() {
        @Override
        protected void doInTransactionWithoutResult(TransactionStatus status) {
            userMapper.deleteById(userId);
            userRoleMapper.deleteByUserId(userId);
        }
    });
}
```

### 6.2 è¿”å›åŸºæœ¬ç±»å‹


**è¿”å›booleanè¡¨ç¤ºæˆåŠŸå¤±è´¥**ï¼š

```java
public boolean saveUser(User user) {
    return transactionTemplate.execute(status -> {
        try {
            userMapper.insert(user);
            return true;
        } catch (Exception e) {
            status.setRollbackOnly();
            return false;
        }
    });
}
```

**è¿”å›intè¡¨ç¤ºå½±å“è¡Œæ•°**ï¼š

```java
public int batchUpdate(List<User> users) {
    return transactionTemplate.execute(status -> {
        int count = 0;
        for (User user : users) {
            count += userMapper.update(user);
        }
        return count;
    });
}
```

### 6.3 è¿”å›å¯¹è±¡ç±»å‹


**è¿”å›å•ä¸ªå¯¹è±¡**ï¼š

```java
public User createUser(User user) {
    return transactionTemplate.execute(status -> {
        userMapper.insert(user);  // æ’å…¥åIDä¼šå›å¡«
        // æŸ¥è¯¢å®Œæ•´ç”¨æˆ·ä¿¡æ¯
        return userMapper.selectById(user.getId());
    });
}
```

**è¿”å›é›†åˆå¯¹è±¡**ï¼š

```java
public List<Order> getUserOrders(Long userId) {
    return transactionTemplate.execute(status -> {
        // äº‹åŠ¡ä¸­æŸ¥è¯¢è®¢å•åˆ—è¡¨
        List<Order> orders = orderMapper.selectByUserId(userId);
        
        // å¡«å……è®¢å•è¯¦æƒ…
        for (Order order : orders) {
            List<OrderItem> items = orderItemMapper.selectByOrderId(order.getId());
            order.setItems(items);
        }
        
        return orders;
    });
}
```

### 6.4 è¿”å›è‡ªå®šä¹‰ç»“æœç±»


**å®šä¹‰ç»“æœç±»**ï¼š

```java
public class TransactionResult<T> {
    private boolean success;
    private String message;
    private T data;
    
    public static <T> TransactionResult<T> success(T data) {
        TransactionResult<T> result = new TransactionResult<>();
        result.success = true;
        result.data = data;
        return result;
    }
    
    public static <T> TransactionResult<T> fail(String message) {
        TransactionResult<T> result = new TransactionResult<>();
        result.success = false;
        result.message = message;
        return result;
    }
}
```

**ä½¿ç”¨ç»“æœç±»**ï¼š

```java
public TransactionResult<Order> createOrder(Order order) {
    return transactionTemplate.execute(status -> {
        try {
            // éªŒè¯åº“å­˜
            if (!checkInventory(order)) {
                status.setRollbackOnly();
                return TransactionResult.fail("åº“å­˜ä¸è¶³");
            }
            
            // åˆ›å»ºè®¢å•
            orderMapper.insert(order);
            
            // æ‰£å‡åº“å­˜
            inventoryMapper.deduct(order.getProductId(), order.getQuantity());
            
            return TransactionResult.success(order);
            
        } catch (Exception e) {
            status.setRollbackOnly();
            return TransactionResult.fail("è®¢å•åˆ›å»ºå¤±è´¥: " + e.getMessage());
        }
    });
}
```

---

## 7. ğŸš€ å®æˆ˜åº”ç”¨åœºæ™¯


### 7.1 åœºæ™¯1ï¼šéƒ¨åˆ†ä»£ç éœ€è¦äº‹åŠ¡


**éœ€æ±‚**ï¼šæ–¹æ³•ä¸­åªæœ‰éƒ¨åˆ†ä»£ç éœ€è¦äº‹åŠ¡æ§åˆ¶

```java
@Service
public class ReportService {
    
    @Autowired
    private TransactionTemplate transactionTemplate;
    
    public void generateReport(Long userId) {
        // 1. æŸ¥è¯¢æ•°æ®ï¼ˆä¸éœ€è¦äº‹åŠ¡ï¼‰
        User user = userMapper.selectById(userId);
        List<Order> orders = orderMapper.selectByUserId(userId);
        
        // 2. ç”ŸæˆæŠ¥è¡¨ï¼ˆä¸éœ€è¦äº‹åŠ¡ï¼‰
        Report report = buildReport(user, orders);
        
        // 3. ä¿å­˜æŠ¥è¡¨ï¼ˆéœ€è¦äº‹åŠ¡ï¼‰
        transactionTemplate.execute(status -> {
            reportMapper.insert(report);
            reportItemMapper.batchInsert(report.getItems());
            return null;
        });
        
        // 4. å‘é€é€šçŸ¥ï¼ˆä¸éœ€è¦äº‹åŠ¡ï¼‰
        sendNotification(user, report);
    }
}
```

### 7.2 åœºæ™¯2ï¼šåŠ¨æ€æ§åˆ¶äº‹åŠ¡


**éœ€æ±‚**ï¼šæ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦ä½¿ç”¨äº‹åŠ¡

```java
public void processData(List<Data> dataList, boolean useTransaction) {
    if (useTransaction) {
        // ä½¿ç”¨äº‹åŠ¡å¤„ç†
        transactionTemplate.execute(status -> {
            dataList.forEach(data -> dataMapper.insert(data));
            return null;
        });
    } else {
        // ä¸ä½¿ç”¨äº‹åŠ¡ï¼Œç›´æ¥å¤„ç†
        dataList.forEach(data -> dataMapper.insert(data));
    }
}
```

### 7.3 åœºæ™¯3ï¼šåµŒå¥—äº‹åŠ¡å¤„ç†


**éœ€æ±‚**ï¼šåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­è°ƒç”¨å¦ä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡

```java
@Service
public class OrderService {
    
    @Autowired
    private TransactionTemplate defaultTemplate;
    
    @Autowired
    @Qualifier("newTransactionTemplate")
    private TransactionTemplate newTransactionTemplate;
    
    public void createOrderWithLog(Order order) {
        defaultTemplate.execute(status -> {
            try {
                // ä¸»ä¸šåŠ¡ï¼šåˆ›å»ºè®¢å•
                orderMapper.insert(order);
                
                // ç‹¬ç«‹äº‹åŠ¡ï¼šè®°å½•æ—¥å¿—ï¼ˆå³ä½¿è®¢å•å¤±è´¥ä¹Ÿè¦è®°å½•ï¼‰
                newTransactionTemplate.execute(logStatus -> {
                    operationLogMapper.insert(
                        new OperationLog("åˆ›å»ºè®¢å•", order.getId())
                    );
                    return null;
                });
                
            } catch (Exception e) {
                status.setRollbackOnly();
                throw e;
            }
            return null;
        });
    }
}
```

### 7.4 åœºæ™¯4ï¼šæ‰¹é‡å¤„ç†ä¼˜åŒ–


**éœ€æ±‚**ï¼šå¤§æ‰¹é‡æ•°æ®åˆ†æ‰¹æ¬¡äº‹åŠ¡å¤„ç†

```java
public int batchImportUsers(List<User> users) {
    int batchSize = 1000;  // æ¯æ‰¹1000æ¡
    int successCount = 0;
    
    // åˆ†æ‰¹å¤„ç†
    for (int i = 0; i < users.size(); i += batchSize) {
        int end = Math.min(i + batchSize, users.size());
        List<User> batch = users.subList(i, end);
        
        // æ¯æ‰¹ä½¿ç”¨ç‹¬ç«‹äº‹åŠ¡
        Boolean success = transactionTemplate.execute(status -> {
            try {
                batch.forEach(user -> userMapper.insert(user));
                return true;
            } catch (Exception e) {
                status.setRollbackOnly();
                log.error("æ‰¹æ¬¡å¯¼å…¥å¤±è´¥: {}-{}", i, end, e);
                return false;
            }
        });
        
        if (Boolean.TRUE.equals(success)) {
            successCount += batch.size();
        }
    }
    
    return successCount;
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å…³é”®æ¦‚å¿µå›é¡¾


```
ğŸ”¸ TransactionTemplateï¼š
   Springæä¾›çš„äº‹åŠ¡æ¨¡æ¿ç±»ï¼Œç®€åŒ–ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†
   
ğŸ”¸ executeæ–¹æ³•ï¼š
   æ ¸å¿ƒæ–¹æ³•ï¼Œæ¥æ”¶TransactionCallbackå›è°ƒï¼Œæ‰§è¡Œäº‹åŠ¡é€»è¾‘
   
ğŸ”¸ TransactionCallbackï¼š
   æœ‰è¿”å›å€¼çš„äº‹åŠ¡å›è°ƒæ¥å£ï¼Œä½¿ç”¨Lambdaè¡¨è¾¾å¼ç®€åŒ–
   
ğŸ”¸ TransactionCallbackWithoutResultï¼š
   æ— è¿”å›å€¼çš„äº‹åŠ¡å›è°ƒæŠ½è±¡ç±»ï¼Œä¸éœ€è¦è¿”å›null
   
ğŸ”¸ TransactionStatusï¼š
   äº‹åŠ¡çŠ¶æ€å¯¹è±¡ï¼Œå¯æ‰‹åŠ¨æ§åˆ¶å›æ»š(setRollbackOnly)
```

### 8.2 ä½¿ç”¨è¦ç‚¹æ€»ç»“


**âœ… é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦åœ¨ä»£ç ä¸­çµæ´»æ§åˆ¶äº‹åŠ¡è¾¹ç•Œ
- åªæœ‰éƒ¨åˆ†ä»£ç éœ€è¦äº‹åŠ¡
- éœ€è¦æ ¹æ®æ¡ä»¶åŠ¨æ€å†³å®šæ˜¯å¦ä½¿ç”¨äº‹åŠ¡
- éœ€è¦å¤„ç†äº‹åŠ¡çš„è¿”å›å€¼

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
- è¿è¡Œæ—¶å¼‚å¸¸è‡ªåŠ¨å›æ»šï¼Œå—æ£€å¼‚å¸¸éœ€æ‰‹åŠ¨å¤„ç†
- ä½¿ç”¨`status.setRollbackOnly()`æ‰‹åŠ¨æ ‡è®°å›æ»š
- åˆç†é…ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´å ç”¨è¿æ¥
- åªè¯»äº‹åŠ¡è®¾ç½®`readOnly=true`ä¼˜åŒ–æ€§èƒ½

**ğŸ”§ é…ç½®æŠ€å·§**ï¼š
- æ ¹æ®ä¸šåŠ¡éœ€è¦åˆ›å»ºå¤šä¸ªTransactionTemplate
- ä½¿ç”¨@Qualifieræ³¨å…¥æŒ‡å®šçš„æ¨¡æ¿
- åˆç†è®¾ç½®ä¼ æ’­è¡Œä¸ºå’Œéš”ç¦»çº§åˆ«
- æ‰¹é‡æ“ä½œæ—¶åˆ†æ‰¹ä½¿ç”¨ç‹¬ç«‹äº‹åŠ¡

**ğŸ“ æœ€ä½³å®è·µ**ï¼š
```java
// 1. ä½¿ç”¨Lambdaè¡¨è¾¾å¼ç®€åŒ–ä»£ç 
transactionTemplate.execute(status -> {
    // ä¸šåŠ¡é€»è¾‘
    return result;
});

// 2. åˆç†å¤„ç†å¼‚å¸¸
try {
    // ä¸šåŠ¡ä»£ç 
} catch (Exception e) {
    status.setRollbackOnly();
    // è®°å½•æ—¥å¿—
    return failResult;
}

// 3. æ˜ç¡®è¿”å›å€¼ç±»å‹
return transactionTemplate.execute(status -> {
    return userMapper.selectById(id);  // æ¸…æ™°çš„è¿”å›å€¼
});
```

### 8.3 ä¸å£°æ˜å¼äº‹åŠ¡å¯¹æ¯”


| ç‰¹æ€§ | **TransactionTemplate** | **@Transactional** |
|------|------------------------|-------------------|
| **æ§åˆ¶æ–¹å¼** | ç¼–ç¨‹å¼ï¼Œä»£ç ä¸­æ˜¾å¼æ§åˆ¶ | å£°æ˜å¼ï¼Œæ³¨è§£é…ç½® |
| **çµæ´»æ€§** | é«˜ï¼Œå¯ç²¾ç¡®æ§åˆ¶äº‹åŠ¡è¾¹ç•Œ | ä½ï¼Œæ•´ä¸ªæ–¹æ³•éƒ½åœ¨äº‹åŠ¡ä¸­ |
| **ä»£ç ä¾µå…¥** | æœ‰ä¾µå…¥ï¼Œä¾èµ–Springç»„ä»¶ | æ— ä¾µå…¥ï¼Œçº¯ä¸šåŠ¡ä»£ç  |
| **é€‚ç”¨åœºæ™¯** | å¤æ‚äº‹åŠ¡é€»è¾‘ï¼Œç»†ç²’åº¦æ§åˆ¶ | ç®€å•äº‹åŠ¡ï¼Œæ ‡å‡†CRUD |
| **å­¦ä¹ æˆæœ¬** | éœ€è¦ç†è§£äº‹åŠ¡API | ç®€å•ï¼Œæ³¨è§£å³å¯ |

**é€‰æ‹©å»ºè®®**ï¼š
- â­ ç®€å•ä¸šåŠ¡é¦–é€‰ `@Transactional`
- â­â­ å¤æ‚é€»è¾‘ä½¿ç”¨ `TransactionTemplate`
- â­â­â­ ä¸¤è€…ç»“åˆï¼Œçµæ´»è¿ç”¨

**è®°å¿†å£è¯€**ï¼š
```
TransactionTemplateç¼–ç¨‹å¼äº‹åŠ¡ï¼Œ
executeæ–¹æ³•å›è°ƒæ¥æ‰§è¡Œï¼Œ
Lambdaè¡¨è¾¾å¼å†™ä¸šåŠ¡é€»è¾‘ï¼Œ
å¼‚å¸¸è‡ªåŠ¨å›æ»šå¾ˆè½»æ¾ã€‚

æœ‰è¿”å›å€¼ç”¨Callbackï¼Œ
æ— è¿”å›å€¼WithoutResultï¼Œ
TransactionStatusæ§åˆ¶çŠ¶æ€ï¼Œ
setRollbackOnlyæ‰‹åŠ¨å›æ»šã€‚
```