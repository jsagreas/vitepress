---
title: 9ã€å¸¸è§äº‹åŠ¡ç®¡ç†å™¨å®ç°
---
## ğŸ“š ç›®å½•

1. [äº‹åŠ¡ç®¡ç†å™¨æ˜¯ä»€ä¹ˆ](#1-äº‹åŠ¡ç®¡ç†å™¨æ˜¯ä»€ä¹ˆ)
2. [DataSourceTransactionManagerè¯¦è§£](#2-DataSourceTransactionManagerè¯¦è§£)
3. [JpaTransactionManagerè¯¦è§£](#3-JpaTransactionManagerè¯¦è§£)
4. [HibernateTransactionManagerè¯¦è§£](#4-HibernateTransactionManagerè¯¦è§£)
5. [JtaTransactionManagerè¯¦è§£](#5-JtaTransactionManagerè¯¦è§£)
6. [äº‹åŠ¡ç®¡ç†å™¨é€‚é…æœºåˆ¶](#6-äº‹åŠ¡ç®¡ç†å™¨é€‚é…æœºåˆ¶)
7. [å¦‚ä½•é€‰æ‹©åˆé€‚çš„äº‹åŠ¡ç®¡ç†å™¨](#7-å¦‚ä½•é€‰æ‹©åˆé€‚çš„äº‹åŠ¡ç®¡ç†å™¨)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ äº‹åŠ¡ç®¡ç†å™¨æ˜¯ä»€ä¹ˆ


### 1.1 é€šä¿—ç†è§£


> ğŸ’¡ **æ‰“ä¸ªæ¯”æ–¹**ï¼šäº‹åŠ¡ç®¡ç†å™¨å°±åƒæ˜¯é“¶è¡Œçš„å‡ºçº³å‘˜ï¼Œè´Ÿè´£å¤„ç†ä½ çš„è½¬è´¦ä¸šåŠ¡ã€‚ä¸åŒçš„é“¶è¡ŒæŸœå°ï¼ˆæ•°æ®åº“æŠ€æœ¯ï¼‰éœ€è¦ä¸åŒç±»å‹çš„å‡ºçº³å‘˜æ¥æ“ä½œã€‚

**æ ¸å¿ƒç†è§£**ï¼š
- **äº‹åŠ¡ç®¡ç†å™¨** = æ§åˆ¶æ•°æ®åº“äº‹åŠ¡çš„"æ€»æŒ‡æŒ¥"
- **ä½œç”¨**ï¼šå¼€å¯äº‹åŠ¡ã€æäº¤äº‹åŠ¡ã€å›æ»šäº‹åŠ¡
- **æœ¬è´¨**ï¼šæŠŠSpringçš„äº‹åŠ¡æŒ‡ä»¤"ç¿»è¯‘"æˆå…·ä½“æ•°æ®åº“èƒ½ç†è§£çš„æ“ä½œ

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ä¸åŒçš„äº‹åŠ¡ç®¡ç†å™¨


```
é—®é¢˜åœºæ™¯ï¼š
ä½¿ç”¨JDBCè®¿é—®æ•°æ®åº“  â†’  éœ€è¦ DataSourceTransactionManager
ä½¿ç”¨JPAè®¿é—®æ•°æ®åº“   â†’  éœ€è¦ JpaTransactionManager
ä½¿ç”¨Hibernateè®¿é—®   â†’  éœ€è¦ HibernateTransactionManager

åŸå› ï¼šä¸åŒçš„æŒä¹…åŒ–æŠ€æœ¯ï¼Œæ“ä½œæ•°æ®åº“çš„æ–¹å¼ä¸ä¸€æ ·
å°±åƒï¼šä¸åŒå“ç‰Œçš„é¥æ§å™¨ï¼Œæ§åˆ¶æ–¹å¼ä¸åŒ
```

### 1.3 äº‹åŠ¡ç®¡ç†å™¨çš„æ ¸å¿ƒèŒè´£


**ä¸»è¦å·¥ä½œå†…å®¹**ï¼š

ğŸ”¸ **å¼€å¯äº‹åŠ¡**
- å‘Šè¯‰æ•°æ®åº“ï¼š"å‡†å¤‡å¼€å§‹ä¸€ä¸ªäº‹åŠ¡"
- è·å–æ•°æ®åº“è¿æ¥
- è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«

ğŸ”¸ **æäº¤äº‹åŠ¡**
- æ‰€æœ‰æ“ä½œæˆåŠŸåï¼Œå‘Šè¯‰æ•°æ®åº“ï¼š"ç¡®è®¤ä¿å­˜"
- é‡Šæ”¾æ•°æ®åº“è¿æ¥

ğŸ”¸ **å›æ»šäº‹åŠ¡**
- å‡ºç°å¼‚å¸¸æ—¶ï¼Œå‘Šè¯‰æ•°æ®åº“ï¼š"æ’¤é”€æ‰€æœ‰æ“ä½œ"
- æ¢å¤åˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€

---

## 2. ğŸ“¦ DataSourceTransactionManagerè¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯DataSourceTransactionManager


> ğŸ“– **å®šä¹‰**ï¼šä¸“é—¨ç”¨äºç®¡ç†JDBCå’ŒMyBatisäº‹åŠ¡çš„ç®¡ç†å™¨ï¼Œæ˜¯æœ€å¸¸ç”¨çš„äº‹åŠ¡ç®¡ç†å™¨ã€‚

**é€šä¿—è§£é‡Š**ï¼š
- ç›´æ¥æ“ä½œ`DataSource`ï¼ˆæ•°æ®æºï¼‰æ¥ç®¡ç†äº‹åŠ¡
- é€‚åˆä½¿ç”¨**åŸç”ŸJDBC**æˆ–**MyBatis**çš„é¡¹ç›®
- è½»é‡çº§ï¼Œæ€§èƒ½å¥½

### 2.2 é€‚ç”¨åœºæ™¯


**âœ… ä½¿ç”¨åœºæ™¯**ï¼š
- é¡¹ç›®ä½¿ç”¨**MyBatis**ä½œä¸ºæŒä¹…åŒ–æ¡†æ¶
- é¡¹ç›®ä½¿ç”¨**JdbcTemplate**æ“ä½œæ•°æ®åº“
- ä¸æ¶‰åŠJPAã€Hibernateç­‰ORMæ¡†æ¶
- å•æ•°æ®æºçš„ç®€å•åº”ç”¨

**ç¤ºä¾‹é…ç½®**ï¼š
```java
@Configuration
public class TransactionConfig {
    
    @Bean
    public DataSourceTransactionManager transactionManager(DataSource dataSource) {
        // åˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨ï¼Œä¼ å…¥æ•°æ®æº
        return new DataSourceTransactionManager(dataSource);
    }
}
```

### 2.3 å·¥ä½œåŸç†å›¾è§£


```
å¼€å¯äº‹åŠ¡æµç¨‹ï¼š
@Transactionalæ–¹æ³•è¢«è°ƒç”¨
         â†“
DataSourceTransactionManageræ¥æ”¶é€šçŸ¥
         â†“
ä»DataSourceè·å–æ•°æ®åº“è¿æ¥
         â†“
æ‰§è¡Œ connection.setAutoCommit(false)  â† å…³é—­è‡ªåŠ¨æäº¤
         â†“
æŠŠè¿æ¥ç»‘å®šåˆ°å½“å‰çº¿ç¨‹
         â†“
æ‰§è¡Œä¸šåŠ¡æ–¹æ³•
         â†“
æˆåŠŸï¼šconnection.commit()     å¤±è´¥ï¼šconnection.rollback()
         â†“
é‡Šæ”¾è¿æ¥ï¼Œè§£é™¤çº¿ç¨‹ç»‘å®š
```

### 2.4 MyBatisé›†æˆå®è·µ


**é…ç½®æ­¥éª¤**ï¼š

1ï¸âƒ£ **æ·»åŠ ä¾èµ–**ï¼ˆMavenï¼‰ï¼š
```xml
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
</dependency>
```

2ï¸âƒ£ **é…ç½®äº‹åŠ¡ç®¡ç†å™¨**ï¼š
```java
@Configuration
@MapperScan("com.example.mapper")
public class MyBatisConfig {
    
    @Bean
    public DataSourceTransactionManager txManager(DataSource dataSource) {
        DataSourceTransactionManager manager = new DataSourceTransactionManager();
        manager.setDataSource(dataSource);
        return manager;
    }
}
```

3ï¸âƒ£ **ä½¿ç”¨äº‹åŠ¡**ï¼š
```java
@Service
public class UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    @Transactional  // è‡ªåŠ¨ä½¿ç”¨DataSourceTransactionManager
    public void transferMoney(Long fromId, Long toId, int amount) {
        userMapper.decreaseBalance(fromId, amount);  // æ‰£æ¬¾
        userMapper.increaseBalance(toId, amount);    // åŠ æ¬¾
        // ä»»ä½•ä¸€æ­¥å¤±è´¥éƒ½ä¼šè‡ªåŠ¨å›æ»š
    }
}
```

### 2.5 æ ¸å¿ƒç‰¹ç‚¹æ€»ç»“


| ç‰¹ç‚¹ | è¯´æ˜ |
|------|------|
| **æŠ€æœ¯æ”¯æŒ** | `JDBCã€MyBatis` |
| **å¤æ‚åº¦** | `â­â˜†â˜†â˜†â˜† ç®€å•` |
| **æ€§èƒ½** | `â­â­â­â­â­ ä¼˜ç§€` |
| **ä½¿ç”¨åœºæ™¯** | `å•æ•°æ®æºåº”ç”¨` |
| **æ¨èæŒ‡æ•°** | `ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥` |

---

## 3. ğŸ¨ JpaTransactionManagerè¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯JpaTransactionManager


> ğŸ“– **å®šä¹‰**ï¼šä¸“é—¨ä¸ºSpring Data JPAè®¾è®¡çš„äº‹åŠ¡ç®¡ç†å™¨ï¼Œæ”¯æŒJPAè§„èŒƒçš„æ‰€æœ‰ç‰¹æ€§ã€‚

**é€šä¿—è§£é‡Š**ï¼š
- ç®¡ç†`EntityManager`ï¼ˆJPAçš„æ ¸å¿ƒå¯¹è±¡ï¼‰
- æ”¯æŒJPAçš„**ä¸€çº§ç¼“å­˜**å’Œ**å»¶è¿ŸåŠ è½½**
- é€‚åˆä½¿ç”¨**Spring Data JPA**çš„é¡¹ç›®

### 3.2 é€‚ç”¨åœºæ™¯


**âœ… ä½¿ç”¨åœºæ™¯**ï¼š
- é¡¹ç›®ä½¿ç”¨**Spring Data JPA**
- éœ€è¦åˆ©ç”¨JPAçš„**å¯¹è±¡å…³ç³»æ˜ å°„**ç‰¹æ€§
- éœ€è¦**å®ä½“ç¼“å­˜**å’Œ**æ‡’åŠ è½½**åŠŸèƒ½
- é¢å‘å¯¹è±¡çš„æ•°æ®åº“æ“ä½œ

**ç¤ºä¾‹é…ç½®**ï¼š
```java
@Configuration
@EnableJpaRepositories(basePackages = "com.example.repository")
public class JpaConfig {
    
    @Bean
    public JpaTransactionManager transactionManager(EntityManagerFactory factory) {
        // åˆ›å»ºJPAäº‹åŠ¡ç®¡ç†å™¨ï¼Œä¼ å…¥EntityManagerFactory
        return new JpaTransactionManager(factory);
    }
}
```

### 3.3 ä¸DataSourceTransactionManagerçš„åŒºåˆ«


â”Œâ”€ DataSourceTransactionManager â”€â”€â”€â”€â”  â”Œâ”€ JpaTransactionManager â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç®¡ç†å¯¹è±¡: Connection              â”‚  â”‚ ç®¡ç†å¯¹è±¡: EntityManager        â”‚
â”‚ æŠ€æœ¯æ”¯æŒ: JDBC/MyBatis            â”‚  â”‚ æŠ€æœ¯æ”¯æŒ: JPA/Hibernate        â”‚
â”‚ ç¼“å­˜æ”¯æŒ: âŒ æ—                    â”‚  â”‚ ç¼“å­˜æ”¯æŒ: âœ… ä¸€çº§ç¼“å­˜          â”‚
â”‚ å»¶è¿ŸåŠ è½½: âŒ ä¸æ”¯æŒ               â”‚  â”‚ å»¶è¿ŸåŠ è½½: âœ… æ”¯æŒ              â”‚
â”‚ å¤æ‚åº¦:   â­ ç®€å•                 â”‚  â”‚ å¤æ‚åº¦:   â­â­â­ ä¸­ç­‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

### 3.4 JPAé›†æˆå®è·µ


**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    private Integer balance;
    // getter/setter...
}

@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Transactional  // ä½¿ç”¨JpaTransactionManager
    public void transferMoney(Long fromId, Long toId, int amount) {
        User fromUser = userRepository.findById(fromId).orElseThrow();
        User toUser = userRepository.findById(toId).orElseThrow();
        
        fromUser.setBalance(fromUser.getBalance() - amount);
        toUser.setBalance(toUser.getBalance() + amount);
        
        // JPAè‡ªåŠ¨æ£€æµ‹å®ä½“å˜åŒ–å¹¶æ›´æ–°æ•°æ®åº“
    }
}
```

### 3.5 æ ¸å¿ƒä¼˜åŠ¿


**ğŸš€ ä¸»è¦ä¼˜ç‚¹**ï¼š
- **è‡ªåŠ¨è„æ£€æŸ¥**ï¼šä¿®æ”¹å®ä½“åè‡ªåŠ¨æ›´æ–°æ•°æ®åº“
- **ä¸€çº§ç¼“å­˜**ï¼šåŒä¸€äº‹åŠ¡å†…é‡å¤æŸ¥è¯¢ä½¿ç”¨ç¼“å­˜
- **æ‡’åŠ è½½**ï¼šå…³è”å¯¹è±¡æŒ‰éœ€åŠ è½½
- **å¯¹è±¡åŒ–æ“ä½œ**ï¼šé¢å‘å¯¹è±¡è€ŒéSQL

> âš ï¸ **æ³¨æ„**ï¼šJpaTransactionManageræ¯”DataSourceTransactionManagerç¨é‡ï¼Œä½†åŠŸèƒ½æ›´å¼ºå¤§

---

## 4. ğŸ”§ HibernateTransactionManagerè¯¦è§£


### 4.1 ä»€ä¹ˆæ˜¯HibernateTransactionManager


> ğŸ“– **å®šä¹‰**ï¼šä¸“é—¨ä¸ºåŸç”ŸHibernateæ¡†æ¶è®¾è®¡çš„äº‹åŠ¡ç®¡ç†å™¨ï¼ˆä¸æ˜¯é€šè¿‡JPAæ¥å£ï¼‰ã€‚

**é€šä¿—è§£é‡Š**ï¼š
- ç›´æ¥ç®¡ç†Hibernateçš„`SessionFactory`
- ä½¿ç”¨HibernateåŸç”ŸAPIè€ŒéJPAæ ‡å‡†
- é€‚åˆè€é¡¹ç›®æˆ–éœ€è¦Hibernateç‰¹æœ‰åŠŸèƒ½çš„åœºæ™¯

### 4.2 é€‚ç”¨åœºæ™¯


**âœ… ä½¿ç”¨åœºæ™¯**ï¼š
- è€é¡¹ç›®ç›´æ¥ä½¿ç”¨**åŸç”ŸHibernate**
- éœ€è¦Hibernateçš„**ç‰¹æœ‰åŠŸèƒ½**ï¼ˆå¦‚äºŒçº§ç¼“å­˜ç»†ç²’åº¦æ§åˆ¶ï¼‰
- ä¸æƒ³è¿ç§»åˆ°JPAæ ‡å‡†

**âš ï¸ ç°çŠ¶è¯´æ˜**ï¼š
- Spring Booté»˜è®¤æ¨èä½¿ç”¨**JpaTransactionManager**
- HibernateTransactionManagerä¸»è¦ç”¨äº**è€é¡¹ç›®ç»´æŠ¤**
- æ–°é¡¹ç›®å»ºè®®ä½¿ç”¨JPAæ ‡å‡†

### 4.3 é…ç½®ç¤ºä¾‹


```java
@Configuration
public class HibernateConfig {
    
    @Bean
    public HibernateTransactionManager transactionManager(SessionFactory sessionFactory) {
        // åˆ›å»ºHibernateäº‹åŠ¡ç®¡ç†å™¨
        return new HibernateTransactionManager(sessionFactory);
    }
}
```

### 4.4 ä¸JpaTransactionManagerå¯¹æ¯”


```
ç›¸åŒç‚¹ï¼š
âœ… éƒ½æ”¯æŒHibernateåº•å±‚å®ç°
âœ… éƒ½æ”¯æŒä¸€çº§ç¼“å­˜ã€æ‡’åŠ è½½
âœ… éƒ½æ˜¯ORMæ¡†æ¶çš„äº‹åŠ¡ç®¡ç†å™¨

ä¸åŒç‚¹ï¼š
JpaTransactionManager          HibernateTransactionManager
â”œâ”€ ä½¿ç”¨JPAæ ‡å‡†æ¥å£            â”œâ”€ ä½¿ç”¨HibernateåŸç”ŸAPI
â”œâ”€ EntityManager              â”œâ”€ Session
â”œâ”€ æ›´ç°ä»£ã€æ›´é€šç”¨              â”œâ”€ Hibernateç‰¹æœ‰åŠŸèƒ½
â””â”€ Springæ¨è âœ…               â””â”€ è€é¡¹ç›®ä½¿ç”¨
```

---

## 5. ğŸŒ JtaTransactionManagerè¯¦è§£


### 5.1 ä»€ä¹ˆæ˜¯JtaTransactionManager


> ğŸ“– **å®šä¹‰**ï¼šæ”¯æŒ**åˆ†å¸ƒå¼äº‹åŠ¡**çš„äº‹åŠ¡ç®¡ç†å™¨ï¼Œå¯ä»¥è·¨å¤šä¸ªæ•°æ®åº“æˆ–æ¶ˆæ¯é˜Ÿåˆ—ã€‚

**é€šä¿—ç†è§£**ï¼š
- **æ™®é€šäº‹åŠ¡**ï¼šä¸€ä¸ªæ•°æ®åº“å†…çš„äº‹åŠ¡ï¼ˆè½¬è´¦åªæ¶‰åŠä¸€ä¸ªé“¶è¡Œï¼‰
- **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šå¤šä¸ªæ•°æ®åº“çš„äº‹åŠ¡ï¼ˆè½¬è´¦æ¶‰åŠä¸¤ä¸ªä¸åŒé“¶è¡Œï¼‰

**ä¸¾ä¾‹è¯´æ˜**ï¼š
```
åœºæ™¯ï¼šç”µå•†ä¸‹å•
â”œâ”€ è®¢å•æ•°æ®åº“ï¼šåˆ›å»ºè®¢å•è®°å½•
â”œâ”€ åº“å­˜æ•°æ®åº“ï¼šæ‰£å‡å•†å“åº“å­˜
â””â”€ ç§¯åˆ†æ•°æ®åº“ï¼šå¢åŠ ç”¨æˆ·ç§¯åˆ†

è¦æ±‚ï¼šä¸‰ä¸ªæ“ä½œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨JTAåˆ†å¸ƒå¼äº‹åŠ¡
```

### 5.2 é€‚ç”¨åœºæ™¯


**âœ… ä½¿ç”¨åœºæ™¯**ï¼š
- **å¤šæ•°æ®æº**äº‹åŠ¡ï¼ˆè®¢å•åº“+åº“å­˜åº“ï¼‰
- **æ•°æ®åº“+æ¶ˆæ¯é˜Ÿåˆ—**æ··åˆäº‹åŠ¡
- **å¾®æœåŠ¡**é—´çš„åˆ†å¸ƒå¼äº‹åŠ¡
- é“¶è¡Œã€é‡‘èç­‰**å¼ºä¸€è‡´æ€§è¦æ±‚**åœºæ™¯

**âŒ ä¸é€‚ç”¨åœºæ™¯**ï¼š
- å•æ•°æ®æºåº”ç”¨ï¼ˆç”¨DataSourceTransactionManagerå³å¯ï¼‰
- æ€§èƒ½è¦æ±‚æé«˜çš„åœºæ™¯ï¼ˆJTAæœ‰æ€§èƒ½å¼€é”€ï¼‰
- æœ€ç»ˆä¸€è‡´æ€§å¯æ¥å—çš„åœºæ™¯

### 5.3 å·¥ä½œåŸç†å›¾è§£


```
åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œæµç¨‹ï¼š
         å®¢æˆ·ç«¯è°ƒç”¨
            â†“
    JtaTransactionManager
            â†“
      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
      â†“         â†“
   æ•°æ®åº“A    æ•°æ®åº“B
      â†“         â†“
  æ“ä½œæˆåŠŸ?  æ“ä½œæˆåŠŸ?
      â†“         â†“
    ã€ä¸¤é˜¶æ®µæäº¤åè®®ã€‘
      â†“
  é˜¶æ®µ1ï¼šå‡†å¤‡æäº¤
  â”œâ”€ æ•°æ®åº“Aï¼šå‡†å¤‡å®Œæˆ âœ…
  â””â”€ æ•°æ®åº“Bï¼šå‡†å¤‡å®Œæˆ âœ…
      â†“
  é˜¶æ®µ2ï¼šæ­£å¼æäº¤
  â”œâ”€ æ•°æ®åº“Aï¼šæäº¤ âœ…
  â””â”€ æ•°æ®åº“Bï¼šæäº¤ âœ…
      â†“
    äº‹åŠ¡å®Œæˆ
```

### 5.4 é…ç½®ç¤ºä¾‹


```java
@Configuration
public class JtaConfig {
    
    @Bean
    public JtaTransactionManager transactionManager(UserTransaction userTransaction) {
        JtaTransactionManager manager = new JtaTransactionManager();
        manager.setUserTransaction(userTransaction);
        return manager;
    }
    
    @Transactional  // è‡ªåŠ¨ä½¿ç”¨JTAåˆ†å¸ƒå¼äº‹åŠ¡
    public void createOrder(Order order) {
        // æ“ä½œè®¢å•æ•°æ®åº“
        orderRepository.save(order);
        
        // æ“ä½œåº“å­˜æ•°æ®åº“
        inventoryRepository.decrease(order.getProductId(), order.getQuantity());
        
        // ä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œä¸¤ä¸ªæ•°æ®åº“éƒ½å›æ»š
    }
}
```

### 5.5 æ ¸å¿ƒç‰¹ç‚¹


| ç‰¹ç‚¹ | è¯´æ˜ |
|------|------|
| **äº‹åŠ¡èŒƒå›´** | `è·¨å¤šä¸ªæ•°æ®æº` |
| **åè®®** | `XAä¸¤é˜¶æ®µæäº¤` |
| **æ€§èƒ½** | `â­â­â˜†â˜†â˜†ï¼ˆæœ‰å¼€é”€ï¼‰` |
| **å¤æ‚åº¦** | `â­â­â­â­â­ å¤æ‚` |
| **ä½¿ç”¨åœºæ™¯** | `åˆ†å¸ƒå¼ç³»ç»Ÿ` |

> âš ï¸ **é‡è¦æç¤º**ï¼šåˆ†å¸ƒå¼äº‹åŠ¡å¾ˆå¤æ‚ï¼Œæ–°æ‰‹å»ºè®®å…ˆæŒæ¡å•æ•°æ®æºäº‹åŠ¡ï¼Œæœ‰éœ€æ±‚æ—¶å†å­¦ä¹ JTAã€‚

---

## 6. ğŸ”„ äº‹åŠ¡ç®¡ç†å™¨é€‚é…æœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ç®¡ç†å™¨é€‚é…


> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šå°±åƒä¸‡èƒ½å……ç”µå™¨ï¼Œèƒ½å¤Ÿé€‚é…ä¸åŒçš„å……ç”µæ¥å£ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- Springå®šä¹‰ç»Ÿä¸€çš„äº‹åŠ¡æ¥å£ï¼š`PlatformTransactionManager`
- ä¸åŒçš„å®ç°ç±»"ç¿»è¯‘"æˆå…·ä½“æŠ€æœ¯çš„æ“ä½œ
- ä¸šåŠ¡ä»£ç ä¸å…³å¿ƒåº•å±‚ç”¨çš„æ˜¯JDBCè¿˜æ˜¯JPA

### 6.2 é€‚é…å±‚æ¬¡ç»“æ„


```
         åº”ç”¨å±‚
    @Transactionalæ³¨è§£
            â†“
      SpringæŠ½è±¡å±‚
 PlatformTransactionManager
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â†“               â†“
æ•°æ®åº“é€‚é…å±‚      æ¶ˆæ¯é˜Ÿåˆ—é€‚é…
    â†“               â†“
â”Œâ”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”
â†“       â†“       â†“       â†“
JDBC   JPA   Hibernate JTA
é€‚é…   é€‚é…   é€‚é…     é€‚é…
```

### 6.3 JDBCé€‚é…åŸç†


**DataSourceTransactionManagerå¦‚ä½•é€‚é…JDBC**ï¼š

```java
// Springçš„ç»Ÿä¸€æ¥å£å®šä¹‰
public interface PlatformTransactionManager {
    TransactionStatus getTransaction(TransactionDefinition definition);
    void commit(TransactionStatus status);
    void rollback(TransactionStatus status);
}

// JDBCé€‚é…å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
public class DataSourceTransactionManager implements PlatformTransactionManager {
    
    private DataSource dataSource;
    
    @Override
    public TransactionStatus getTransaction(TransactionDefinition definition) {
        // 1. ä»æ•°æ®æºè·å–è¿æ¥
        Connection conn = dataSource.getConnection();
        
        // 2. å…³é—­è‡ªåŠ¨æäº¤ï¼ˆå¼€å¯äº‹åŠ¡ï¼‰
        conn.setAutoCommit(false);
        
        // 3. è®¾ç½®éš”ç¦»çº§åˆ«
        conn.setTransactionIsolation(definition.getIsolationLevel());
        
        // 4. ç»‘å®šåˆ°å½“å‰çº¿ç¨‹
        TransactionSynchronizationManager.bindResource(dataSource, conn);
        
        return new DefaultTransactionStatus(conn, true);
    }
    
    @Override
    public void commit(TransactionStatus status) {
        Connection conn = status.getConnection();
        conn.commit();  // JDBCæäº¤
    }
    
    @Override
    public void rollback(TransactionStatus status) {
        Connection conn = status.getConnection();
        conn.rollback();  // JDBCå›æ»š
    }
}
```

**é€‚é…è¦ç‚¹**ï¼š
- âœ… **è·å–è¿æ¥**ï¼šä»DataSourceè·å–
- âœ… **å¼€å¯äº‹åŠ¡**ï¼š`setAutoCommit(false)`
- âœ… **æäº¤äº‹åŠ¡**ï¼š`connection.commit()`
- âœ… **å›æ»šäº‹åŠ¡**ï¼š`connection.rollback()`

### 6.4 MyBatisé€‚é…åŸç†


**ä¸ºä»€ä¹ˆMyBatiså¯ä»¥ç”¨DataSourceTransactionManagerï¼Ÿ**

```
MyBatisçš„è®¾è®¡ï¼š
1. MyBatisåº•å±‚ä½¿ç”¨JDBC
2. ä»Springå®¹å™¨è·å–DataSource
3. éµå¾ªJDBCçš„äº‹åŠ¡è§„èŒƒ

é€‚é…æµç¨‹ï¼š
@Transactional
    â†“
DataSourceTransactionManager
    â†“
è·å–Connectionå¹¶å…³é—­è‡ªåŠ¨æäº¤
    â†“
æŠŠConnectionå­˜åˆ°ThreadLocal
    â†“
MyBatisæ‰§è¡ŒSQLæ—¶ä»ThreadLocalè·å–åŒä¸€ä¸ªConnection
    â†“
ä¿è¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­
```

**é›†æˆé…ç½®**ï¼š
```java
@Configuration
@MapperScan("com.example.mapper")
public class MyBatisConfig {
    
    @Bean
    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) {
        SqlSessionFactoryBean factory = new SqlSessionFactoryBean();
        factory.setDataSource(dataSource);  // ä½¿ç”¨Springçš„æ•°æ®æº
        return factory.getObject();
    }
    
    @Bean
    public DataSourceTransactionManager transactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

**å…³é”®ç‚¹**ï¼š
- MyBatiså’Œäº‹åŠ¡ç®¡ç†å™¨**å…±äº«åŒä¸€ä¸ªDataSource**
- äº‹åŠ¡ç®¡ç†å™¨æ§åˆ¶Connectionçš„æäº¤/å›æ»š
- MyBatisä½¿ç”¨è¿™ä¸ªConnectionæ‰§è¡ŒSQL

### 6.5 é€‚é…å™¨æ¨¡å¼åº”ç”¨


> ğŸ“– **è®¾è®¡æ¨¡å¼**ï¼šSpringçš„äº‹åŠ¡ç®¡ç†å™¨ä½¿ç”¨äº†**é€‚é…å™¨æ¨¡å¼**ã€‚

**æ¨¡å¼ç»“æ„**ï¼š
```
ç›®æ ‡æ¥å£ï¼šPlatformTransactionManager
    â†“
é€‚é…å™¨ï¼šDataSourceTransactionManager
    â†“
è¢«é€‚é…è€…ï¼šJDBC Connection

å¥½å¤„ï¼š
âœ… ä¸šåŠ¡ä»£ç åªä¾èµ–Springæ¥å£
âœ… åˆ‡æ¢æ•°æ®åº“æŠ€æœ¯ä¸å½±å“ä¸šåŠ¡ä»£ç 
âœ… ç»Ÿä¸€çš„äº‹åŠ¡ç®¡ç†æ–¹å¼
```

---

## 7. ğŸ¯ å¦‚ä½•é€‰æ‹©åˆé€‚çš„äº‹åŠ¡ç®¡ç†å™¨


### 7.1 é€‰æ‹©æµç¨‹å›¾


```
å¼€å§‹é€‰æ‹©äº‹åŠ¡ç®¡ç†å™¨
        â†“
   éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡?
   â”œâ”€ æ˜¯ â†’ JtaTransactionManager
   â””â”€ å¦ â†“
        â†“
   ä½¿ç”¨ä»€ä¹ˆæŒä¹…åŒ–æŠ€æœ¯?
   â”œâ”€ JDBC/MyBatis â†’ DataSourceTransactionManager
   â”œâ”€ Spring Data JPA â†’ JpaTransactionManager
   â””â”€ åŸç”ŸHibernate â†’ HibernateTransactionManager
```

### 7.2 æŠ€æœ¯æ ˆå¯¹ç…§è¡¨


| ä½ çš„æŠ€æœ¯æ ˆ | æ¨èäº‹åŠ¡ç®¡ç†å™¨ | æ¨èæŒ‡æ•° |
|-----------|---------------|---------|
| `MyBatis` | `DataSourceTransactionManager` | `ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥` |
| `JdbcTemplate` | `DataSourceTransactionManager` | `ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥` |
| `Spring Data JPA` | `JpaTransactionManager` | `ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥` |
| `åŸç”ŸHibernate` | `HibernateTransactionManager` | `ğŸ”¥ğŸ”¥ğŸ”¥â˜†â˜†` |
| `å¤šæ•°æ®æº` | `JtaTransactionManager` | `ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥â˜†` |

### 7.3 å®é™…é¡¹ç›®å»ºè®®


**ğŸ¯ æ–°é¡¹ç›®æ¨è**ï¼š
```
å•ä½“åº”ç”¨ï¼š
â”œâ”€ ç®€å•CRUD â†’ MyBatis + DataSourceTransactionManager
â”œâ”€ å¤æ‚å¯¹è±¡æ˜ å°„ â†’ JPA + JpaTransactionManager
â””â”€ æ€§èƒ½è¦æ±‚é«˜ â†’ MyBatis + DataSourceTransactionManager

åˆ†å¸ƒå¼åº”ç”¨ï¼š
â”œâ”€ å¼ºä¸€è‡´æ€§ â†’ JtaTransactionManager
â”œâ”€ æœ€ç»ˆä¸€è‡´æ€§ â†’ æ¶ˆæ¯é˜Ÿåˆ— + æœ¬åœ°äº‹åŠ¡
â””â”€ å¾®æœåŠ¡ â†’ Seataç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶
```

**ğŸ’¡ é€‰æ‹©å»ºè®®**ï¼š
- **æ–°æ‰‹å…¥é—¨**ï¼šä»DataSourceTransactionManagerå¼€å§‹
- **ä¼ä¸šçº§åº”ç”¨**ï¼šJpaTransactionManageråŠŸèƒ½å¼ºå¤§
- **é«˜æ€§èƒ½åœºæ™¯**ï¼šDataSourceTransactionManageræ›´è½»é‡
- **åˆ†å¸ƒå¼ç³»ç»Ÿ**ï¼šæ ¹æ®ä¸€è‡´æ€§è¦æ±‚é€‰æ‹©æ–¹æ¡ˆ

### 7.4 å¸¸è§æ­é…ç»„åˆ


**âœ… æœ€ä½³å®è·µç»„åˆ**ï¼š

```
ç»„åˆ1ï¼šSpring Boot + MyBatisï¼ˆæœ€å¸¸ç”¨ï¼‰
@Configuration
public class Config {
    @Bean
    public DataSourceTransactionManager txManager(DataSource ds) {
        return new DataSourceTransactionManager(ds);
    }
}

ç»„åˆ2ï¼šSpring Boot + JPAï¼ˆæ¨èï¼‰
@Configuration
public class Config {
    @Bean
    public JpaTransactionManager txManager(EntityManagerFactory emf) {
        return new JpaTransactionManager(emf);
    }
}

ç»„åˆ3ï¼šå¤šæ•°æ®æºï¼ˆè¿›é˜¶ï¼‰
@Configuration
public class Config {
    @Bean
    public JtaTransactionManager txManager() {
        return new JtaTransactionManager();
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ äº‹åŠ¡ç®¡ç†å™¨ï¼šæ§åˆ¶æ•°æ®åº“äº‹åŠ¡çš„æ€»æŒ‡æŒ¥
ğŸ”¸ DataSourceç®¡ç†å™¨ï¼šæœ€å¸¸ç”¨ï¼Œæ”¯æŒJDBC/MyBatis
ğŸ”¸ JPAç®¡ç†å™¨ï¼šé¢å‘å¯¹è±¡ï¼Œæ”¯æŒç¼“å­˜å’Œæ‡’åŠ è½½
ğŸ”¸ Hibernateç®¡ç†å™¨ï¼šè€é¡¹ç›®ä½¿ç”¨ï¼ŒåŠŸèƒ½ç±»ä¼¼JPA
ğŸ”¸ JTAç®¡ç†å™¨ï¼šåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œè·¨å¤šä¸ªæ•°æ®æº
ğŸ”¸ é€‚é…æœºåˆ¶ï¼šç»Ÿä¸€æ¥å£ï¼Œåº•å±‚é€‚é…ä¸åŒæŠ€æœ¯
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦ä¸åŒçš„äº‹åŠ¡ç®¡ç†å™¨**ï¼š
- ä¸åŒçš„æŒä¹…åŒ–æŠ€æœ¯ï¼Œåº•å±‚æ“ä½œæ–¹å¼ä¸åŒ
- JDBCç›´æ¥æ“ä½œConnection
- JPAæ“ä½œEntityManager
- éœ€è¦å¯¹åº”çš„ç®¡ç†å™¨æ¥"ç¿»è¯‘"

**ğŸ”¹ å¦‚ä½•é€‰æ‹©äº‹åŠ¡ç®¡ç†å™¨**ï¼š
- çœ‹ä½ ç”¨ä»€ä¹ˆæŒä¹…åŒ–æŠ€æœ¯
- MyBatis â†’ DataSourceTransactionManager
- JPA â†’ JpaTransactionManager
- å¤šæ•°æ®æº â†’ JtaTransactionManager

**ğŸ”¹ é€‚é…å™¨æ¨¡å¼çš„åº”ç”¨**ï¼š
- Springå®šä¹‰ç»Ÿä¸€æ¥å£
- å„ä¸ªç®¡ç†å™¨å®ç°æ¥å£
- ä¸šåŠ¡ä»£ç ä¸å…³å¿ƒåº•å±‚å®ç°

### 8.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ“Œ æ–°æ‰‹å­¦ä¹ è·¯å¾„**ï¼š
1. **å…¥é—¨**ï¼šå…ˆå­¦DataSourceTransactionManagerï¼ˆæœ€ç®€å•ï¼‰
2. **è¿›é˜¶**ï¼šæŒæ¡JpaTransactionManagerï¼ˆæ›´å¼ºå¤§ï¼‰
3. **é«˜çº§**ï¼šäº†è§£JtaTransactionManagerï¼ˆåˆ†å¸ƒå¼ï¼‰

**ğŸ“Œ é¡¹ç›®å®è·µå»ºè®®**ï¼š
- âœ… **80%çš„é¡¹ç›®**ï¼šDataSourceTransactionManagerå¤Ÿç”¨
- âœ… **éœ€è¦ORMç‰¹æ€§**ï¼šé€‰æ‹©JpaTransactionManager
- âœ… **åˆ†å¸ƒå¼ç³»ç»Ÿ**ï¼šè¯„ä¼°æ˜¯å¦çœŸçš„éœ€è¦JTA

**ğŸ“Œ å¸¸è§è¯¯åŒº**ï¼š
- âŒ è¯¯åŒº1ï¼šæ‰€æœ‰é¡¹ç›®éƒ½ç”¨JPAï¼ˆæ€§èƒ½å¯èƒ½ä¸å¦‚MyBatisï¼‰
- âŒ è¯¯åŒº2ï¼šç›²ç›®ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆå¤æ‚åº¦é«˜ã€æ€§èƒ½å·®ï¼‰
- âœ… æ­£ç¡®ï¼šæ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©æœ€åˆé€‚çš„

### 8.4 æ ¸å¿ƒè®°å¿†å£è¯€


```
äº‹åŠ¡ç®¡ç†å™¨å››å…„å¼Ÿï¼Œå„æœ‰ä¸“é•¿è¦è®°ç‰¢ï¼š
DataSourceæœ€å¸¸ç”¨ï¼ŒJDBCå’ŒMyBatiså…¨é å®ƒ
JPAç®¡ç†å™¨åŠŸèƒ½å¼ºï¼Œå¯¹è±¡æ˜ å°„ç¼“å­˜å¥½
Hibernateè€å¤§å“¥ï¼Œè€é¡¹ç›®é‡Œè¿˜åœ¨ç”¨
JTAåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¤šåº“æ“ä½œå®ƒæœ€è¡Œ

é€‰æ‹©è¦çœ‹æŠ€æœ¯æ ˆï¼Œåˆ«ç›²ç›®è·Ÿé£ä¹±ç”¨
æ–°æ‰‹å…¥é—¨DataSourceï¼Œç¨³æ‰ç¨³æ‰“å­¦å¾—å¥½
```