---
title: 33ã€äº‹åŠ¡æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [äº‹åŠ¡æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°](#1-äº‹åŠ¡æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°)
2. [äº‹åŠ¡èŒƒå›´æ§åˆ¶](#2-äº‹åŠ¡èŒƒå›´æ§åˆ¶)
3. [æ‰¹å¤„ç†äº‹åŠ¡ä¼˜åŒ–](#3-æ‰¹å¤„ç†äº‹åŠ¡ä¼˜åŒ–)
4. [åªè¯»äº‹åŠ¡ä¼˜åŒ–](#4-åªè¯»äº‹åŠ¡ä¼˜åŒ–)
5. [è¿æ¥æ± é…ç½®ä¼˜åŒ–](#5-è¿æ¥æ± é…ç½®ä¼˜åŒ–)
6. [é•¿äº‹åŠ¡ä¼˜åŒ–ç­–ç•¥](#6-é•¿äº‹åŠ¡ä¼˜åŒ–ç­–ç•¥)
7. [æ­»é”é—®é¢˜å¤„ç†](#7-æ­»é”é—®é¢˜å¤„ç†)
8. [SQLä¸ç´¢å¼•ä¼˜åŒ–](#8-SQLä¸ç´¢å¼•ä¼˜åŒ–)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ äº‹åŠ¡æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆè¦ä¼˜åŒ–äº‹åŠ¡æ€§èƒ½


**ç†è§£äº‹åŠ¡çš„æ€§èƒ½å½±å“**

æƒ³è±¡ä¸€ä¸‹ï¼Œäº‹åŠ¡å°±åƒé“¶è¡ŒæŸœå°åŠç†ä¸šåŠ¡ï¼š
- å¦‚æœä¸€ä¸ªäººåŠä¸šåŠ¡æ—¶é—´è¿‡é•¿ï¼Œåé¢æ’é˜Ÿçš„äººå°±è¦ç­‰å¾ˆä¹…
- å¦‚æœåŠç†æµç¨‹å¤æ‚ï¼Œä¼šå ç”¨æ›´å¤šæŸœå°èµ„æº
- å¦‚æœä¸¤ä¸ªäººåŒæ—¶è¦å¤„ç†åŒä¸€ä¸ªè´¦æˆ·ï¼Œå°±å¯èƒ½å‘ç”Ÿå†²çª

```
äº‹åŠ¡æ€§èƒ½é—®é¢˜çš„å¸¸è§è¡¨ç°ï¼š

âŒ ç³»ç»Ÿå“åº”æ…¢ï¼šç”¨æˆ·æ“ä½œåŠå¤©æ²¡ååº”
âŒ æ•°æ®åº“å‹åŠ›å¤§ï¼šCPUã€å†…å­˜å ç”¨é«˜
âŒ å¹¶å‘èƒ½åŠ›å·®ï¼šç”¨æˆ·å¤šäº†å°±å¡é¡¿
âŒ æ­»é”é¢‘ç¹ï¼šæ“ä½œå¤±è´¥éœ€è¦é‡è¯•
```

### 1.2 äº‹åŠ¡æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ€è·¯


**ğŸ”¸ ä¸‰å¤§ä¼˜åŒ–åŸåˆ™**

```
1ï¸âƒ£ ç¼©çŸ­äº‹åŠ¡æ—¶é—´ â†’ å‡å°‘é”å®šèµ„æºçš„æ—¶é•¿
2ï¸âƒ£ å‡å°‘äº‹åŠ¡èŒƒå›´ â†’ åªåœ¨å¿…è¦æ—¶ä½¿ç”¨äº‹åŠ¡
3ï¸âƒ£ é™ä½äº‹åŠ¡å†²çª â†’ åˆç†è®¾è®¡è®¿é—®é¡ºåº
```

**ä¼˜åŒ–æ•ˆæœå¯¹æ¯”**

| ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡æ•ˆæœ |
|--------|--------|----------|
| ä¸€æ¬¡æ“ä½œ3ç§’ | ä¸€æ¬¡æ“ä½œ0.3ç§’ | **æ€§èƒ½æå‡10å€** |
| æ”¯æŒ100å¹¶å‘ | æ”¯æŒ1000å¹¶å‘ | **å¹¶å‘èƒ½åŠ›æå‡10å€** |
| æ¯å¤©æ­»é”100æ¬¡ | æ¯å¤©æ­»é”5æ¬¡ | **ç¨³å®šæ€§å¤§å¹…æå‡** |

---

## 2. âš¡ äº‹åŠ¡èŒƒå›´æ§åˆ¶


### 2.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡èŒƒå›´


**é€šä¿—ç†è§£**ï¼šäº‹åŠ¡èŒƒå›´å°±æ˜¯äº‹åŠ¡"ç®¡è¾–"çš„ä»£ç åŒºåŸŸï¼Œå°±åƒä¸€ä¸ªä¿æŠ¤ç½©è¦†ç›–çš„èŒƒå›´ã€‚

```
äº‹åŠ¡èŒƒå›´ç¤ºæ„å›¾ï¼š

å°èŒƒå›´äº‹åŠ¡ï¼ˆæ¨èï¼‰:
å¼€å¯äº‹åŠ¡ â”
  æŸ¥è¯¢æ•°æ®åº“ â† æ•°æ®åº“æ“ä½œ
  ä¿®æ”¹æ•°æ®   â† æ•°æ®åº“æ“ä½œ
  ä¿å­˜æ•°æ®   â† æ•°æ®åº“æ“ä½œ
æäº¤äº‹åŠ¡ â”˜
ï¼ˆåªä¿æŠ¤å¿…è¦æ“ä½œï¼ŒèŒƒå›´å°ï¼‰

å¤§èŒƒå›´äº‹åŠ¡ï¼ˆä¸æ¨èï¼‰:
å¼€å¯äº‹åŠ¡ â”
  å‘é€é‚®ä»¶     â† å¤–éƒ¨è°ƒç”¨ï¼ˆæ…¢ï¼‰
  è°ƒç”¨ç¬¬ä¸‰æ–¹API â† å¤–éƒ¨è°ƒç”¨ï¼ˆæ…¢ï¼‰
  æŸ¥è¯¢æ•°æ®åº“   â† æ•°æ®åº“æ“ä½œ
  ä¼‘çœ ç­‰å¾…     â† æ— æ„ä¹‰æ“ä½œ
  ä¿å­˜æ•°æ®     â† æ•°æ®åº“æ“ä½œ
æäº¤äº‹åŠ¡ â”˜
ï¼ˆä¿æŠ¤äº†å¾ˆå¤šä¸éœ€è¦çš„æ“ä½œï¼ŒèŒƒå›´å¤§ï¼‰
```

### 2.2 äº‹åŠ¡èŒƒå›´ä¼˜åŒ–å®æˆ˜


**âŒ é”™è¯¯ç¤ºä¾‹ï¼šäº‹åŠ¡èŒƒå›´è¿‡å¤§**

```java
@Transactional
public void processOrder(Order order) {
    // âŒ å‘é€é‚®ä»¶åœ¨äº‹åŠ¡å†…ï¼ˆå¤–éƒ¨è°ƒç”¨æ…¢ï¼Œå ç”¨äº‹åŠ¡æ—¶é—´ï¼‰
    emailService.sendNotification(order);
    
    // âŒ è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜ï¼ˆç½‘ç»œè°ƒç”¨æ…¢ï¼Œå¯èƒ½è¶…æ—¶ï¼‰
    paymentService.charge(order);
    
    // âŒ ç”ŸæˆPDFæŠ¥è¡¨ï¼ˆè€—æ—¶æ“ä½œï¼Œå ç”¨æ•°æ®åº“è¿æ¥ï¼‰
    reportService.generatePDF(order);
    
    // çœŸæ­£éœ€è¦äº‹åŠ¡ä¿æŠ¤çš„æ•°æ®åº“æ“ä½œ
    orderRepository.save(order);
    inventoryRepository.updateStock(order);
}
```

**é—®é¢˜åˆ†æ**ï¼š
- é‚®ä»¶å‘é€å¯èƒ½éœ€è¦2-3ç§’ï¼Œäº‹åŠ¡ä¸€ç›´åœ¨ç­‰å¾…
- ç¬¬ä¸‰æ–¹æ”¯ä»˜å¯èƒ½æ›´æ…¢ï¼Œç½‘ç»œé—®é¢˜ä¼šå¯¼è‡´äº‹åŠ¡è¶…æ—¶
- PDFç”Ÿæˆå ç”¨å†…å­˜å’ŒCPUï¼Œå½±å“æ•°æ®åº“æ€§èƒ½
- æ•´ä¸ªè¿‡ç¨‹æ•°æ®åº“è¿æ¥è¢«å ç”¨ï¼Œå…¶ä»–è¯·æ±‚æ— æ³•ä½¿ç”¨

**âœ… æ­£ç¡®ç¤ºä¾‹ï¼šç¼©å°äº‹åŠ¡èŒƒå›´**

```java
public void processOrder(Order order) {
    // 1. å…ˆåšå¤–éƒ¨è°ƒç”¨ï¼ˆä¸åœ¨äº‹åŠ¡å†…ï¼‰
    emailService.sendNotification(order);
    paymentService.charge(order);
    reportService.generatePDF(order);
    
    // 2. åªåœ¨æ•°æ®åº“æ“ä½œæ—¶å¼€å¯äº‹åŠ¡
    saveOrderInTransaction(order);
}

@Transactional
private void saveOrderInTransaction(Order order) {
    // âœ… äº‹åŠ¡åªä¿æŠ¤æ•°æ®åº“æ“ä½œ
    orderRepository.save(order);
    inventoryRepository.updateStock(order);
    // äº‹åŠ¡å¾ˆå¿«å°±ç»“æŸäº†
}
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- äº‹åŠ¡æ—¶é—´ä»5ç§’é™ä½åˆ°0.1ç§’
- æ•°æ®åº“è¿æ¥å¿«é€Ÿé‡Šæ”¾ï¼Œæé«˜å¹¶å‘èƒ½åŠ›
- å¤–éƒ¨è°ƒç”¨å¤±è´¥ä¸å½±å“äº‹åŠ¡

### 2.3 ç¼–ç¨‹å¼äº‹åŠ¡ç²¾ç¡®æ§åˆ¶


æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æ›´ç²¾ç¡®çš„æ§åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ç¼–ç¨‹å¼äº‹åŠ¡ï¼š

```java
@Autowired
private TransactionTemplate transactionTemplate;

public void processOrder(Order order) {
    // éäº‹åŠ¡æ“ä½œ
    String emailResult = emailService.send(order);
    
    // åªåœ¨éœ€è¦æ—¶å¼€å¯äº‹åŠ¡
    transactionTemplate.execute(status -> {
        try {
            orderRepository.save(order);
            inventoryRepository.updateStock(order);
            return true;
        } catch (Exception e) {
            status.setRollbackOnly();
            throw e;
        }
    });
    
    // äº‹åŠ¡å·²ç»“æŸï¼Œç»§ç»­å…¶ä»–æ“ä½œ
    logService.recordSuccess(order);
}
```

**æ ¸å¿ƒè¦ç‚¹**ï¼š
> ğŸ¯ **åŸåˆ™**ï¼šäº‹åŠ¡èŒƒå›´è¶Šå°è¶Šå¥½ï¼Œåªä¿æŠ¤å¿…é¡»ä¿è¯ä¸€è‡´æ€§çš„æ•°æ®åº“æ“ä½œ
> 
> âš ï¸ **é¿å…**ï¼šå¤–éƒ¨è°ƒç”¨ã€æ–‡ä»¶IOã€å¤æ‚è®¡ç®—æ”¾åœ¨äº‹åŠ¡å†…

---

## 3. ğŸš€ æ‰¹å¤„ç†äº‹åŠ¡ä¼˜åŒ–


### 3.1 ä»€ä¹ˆæ˜¯æ‰¹å¤„ç†äº‹åŠ¡


**ç”Ÿæ´»ç±»æ¯”**ï¼š
- ä¸ç”¨æ‰¹å¤„ç†ï¼šå»è¶…å¸‚ä¹°ä¸œè¥¿ï¼Œä¹°ä¸€ä»¶ç»“è´¦ä¸€æ¬¡ï¼Œæ¥å›è·‘10æ¬¡
- ä½¿ç”¨æ‰¹å¤„ç†ï¼šä¹°å®Œæ‰€æœ‰ä¸œè¥¿ï¼Œä¸€æ¬¡æ€§ç»“è´¦ï¼Œåªè·‘1æ¬¡

**æŠ€æœ¯ç†è§£**ï¼šæŠŠå¤šä¸ªæ•°æ®åº“æ“ä½œåˆå¹¶åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå‡å°‘äº‹åŠ¡å¼€å¯/æäº¤çš„æ¬¡æ•°ã€‚

### 3.2 æ‰¹å¤„ç†ä¼˜åŒ–å®æˆ˜


**âŒ ä½æ•ˆæ–¹å¼ï¼šé€æ¡å¤„ç†**

```java
// å¤„ç†1000æ¡è®¢å•ï¼Œå¼€å¯1000æ¬¡äº‹åŠ¡
public void processOrders(List<Order> orders) {
    for (Order order : orders) {
        processOneOrder(order); // æ¯æ¬¡éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡
    }
}

@Transactional
public void processOneOrder(Order order) {
    orderRepository.save(order);
}
```

**æ€§èƒ½é—®é¢˜**ï¼š
- æ¯æ¬¡`save()`éƒ½è¦ï¼šå¼€å¯è¿æ¥ â†’ æ‰§è¡ŒSQL â†’ æäº¤äº‹åŠ¡ â†’ å…³é—­è¿æ¥
- 1000æ¡æ•°æ® = 1000æ¬¡ç½‘ç»œå¾€è¿” = å¾ˆæ…¢ï¼

**âœ… é«˜æ•ˆæ–¹å¼ï¼šæ‰¹é‡å¤„ç†**

```java
@Transactional
public void batchProcessOrders(List<Order> orders) {
    int batchSize = 100; // æ¯æ‰¹å¤„ç†100æ¡
    
    for (int i = 0; i < orders.size(); i++) {
        orderRepository.save(orders.get(i));
        
        // æ¯100æ¡åˆ·æ–°ä¸€æ¬¡ï¼Œé‡Šæ”¾å†…å­˜
        if (i % batchSize == 0) {
            entityManager.flush();
            entityManager.clear();
        }
    }
}
```

**ä¼˜åŒ–æ•ˆæœå¯¹æ¯”**ï¼š

| æ–¹å¼ | å¤„ç†1000æ¡è€—æ—¶ | è¯´æ˜ |
|------|---------------|------|
| é€æ¡äº‹åŠ¡ | **10ç§’** | æ¯æ¡éƒ½è¦å¼€å¯/æäº¤äº‹åŠ¡ |
| æ‰¹é‡äº‹åŠ¡ | **1ç§’** | ä¸€æ¬¡äº‹åŠ¡å¤„ç†æ‰€æœ‰æ•°æ® |
| æ€§èƒ½æå‡ | **10å€** | å‡å°‘äº†999æ¬¡äº‹åŠ¡å¼€é”€ |

### 3.3 JDBCæ‰¹å¤„ç†é…ç½®


**Springé…ç½®å¼€å¯æ‰¹å¤„ç†**

```yaml
spring:
  jpa:
    properties:
      hibernate:
        jdbc:
          batch_size: 50          # æ‰¹å¤„ç†å¤§å°
        order_inserts: true       # å¯¹INSERTæ’åº
        order_updates: true       # å¯¹UPDATEæ’åº
        batch_versioned_data: true # æ”¯æŒç‰ˆæœ¬æ§åˆ¶çš„æ‰¹å¤„ç†
```

**æ‰¹å¤„ç†ä½¿ç”¨ç¤ºä¾‹**

```java
@Transactional
public void batchInsert(List<User> users) {
    for (int i = 0; i < users.size(); i++) {
        entityManager.persist(users.get(i));
        
        // è¾¾åˆ°æ‰¹å¤„ç†å¤§å°æ—¶ï¼Œæ‰§è¡Œæ‰¹é‡SQL
        if (i % 50 == 0 && i > 0) {
            entityManager.flush();  // æ‰§è¡Œæ‰¹é‡SQL
            entityManager.clear();  // æ¸…ç©ºç¼“å­˜é‡Šæ”¾å†…å­˜
        }
    }
}
```

**åŸç†è§£é‡Š**ï¼š
```
ä¸ç”¨æ‰¹å¤„ç†ï¼š
INSERT INTO user VALUES (1, 'A');  â† æ‰§è¡Œ1æ¬¡
INSERT INTO user VALUES (2, 'B');  â† æ‰§è¡Œ1æ¬¡
INSERT INTO user VALUES (3, 'C');  â† æ‰§è¡Œ1æ¬¡
ï¼ˆå‘é€3æ¬¡ç½‘ç»œè¯·æ±‚ï¼‰

ä½¿ç”¨æ‰¹å¤„ç†ï¼š
INSERT INTO user VALUES 
  (1, 'A'),
  (2, 'B'),
  (3, 'C');  â† åªæ‰§è¡Œ1æ¬¡
ï¼ˆåªå‘é€1æ¬¡ç½‘ç»œè¯·æ±‚ï¼‰
```

---

## 4. ğŸ“– åªè¯»äº‹åŠ¡ä¼˜åŒ–


### 4.1 ä»€ä¹ˆæ˜¯åªè¯»äº‹åŠ¡


**é€šä¿—ç†è§£**ï¼šå‘Šè¯‰æ•°æ®åº“"æˆ‘åªæ˜¯çœ‹çœ‹ï¼Œä¸ä¼šä¿®æ”¹æ•°æ®"ï¼Œæ•°æ®åº“å°±å¯ä»¥åšä¸€äº›ä¼˜åŒ–ã€‚

```
æ™®é€šäº‹åŠ¡ vs åªè¯»äº‹åŠ¡ï¼š

æ™®é€šäº‹åŠ¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‡†å¤‡å†™é”æœºåˆ¶     â”‚ â† ä¸ºå¯èƒ½çš„ä¿®æ”¹åšå‡†å¤‡
â”‚ è®°å½•å›æ»šä¿¡æ¯     â”‚ â† å ç”¨æ›´å¤šèµ„æº
â”‚ æŸ¥è¯¢æ•°æ®         â”‚
â”‚ å¯èƒ½ä¿®æ”¹æ•°æ®     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åªè¯»äº‹åŠ¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åªè¯»ä¼˜åŒ–æ¨¡å¼     â”‚ â† ä¸å‡†å¤‡å†™é”
â”‚ ä¸è®°å½•å›æ»šä¿¡æ¯   â”‚ â† èŠ‚çœèµ„æº
â”‚ æŸ¥è¯¢æ•°æ®         â”‚
â”‚ ä¸èƒ½ä¿®æ”¹æ•°æ®     â”‚ â† æé«˜å®‰å…¨æ€§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 åªè¯»äº‹åŠ¡çš„ä¼˜åŠ¿


**ğŸ”¸ æ€§èƒ½ä¼˜åŠ¿**

```
1. å‡å°‘é”å¼€é”€ï¼šä¸éœ€è¦åŠ æ’ä»–é”
2. å‡å°‘æ—¥å¿—ï¼šä¸è®°å½•Undoæ—¥å¿—
3. æé«˜å¹¶å‘ï¼šå…è®¸æ›´å¤šè¯»æ“ä½œåŒæ—¶è¿›è¡Œ
4. ä¼˜åŒ–æŸ¥è¯¢ï¼šæ•°æ®åº“å¯ä»¥é€‰æ‹©æ›´ä¼˜çš„æŸ¥è¯¢è®¡åˆ’
```

**ğŸ”¸ ä½¿ç”¨åœºæ™¯**

| åœºæ™¯ | æ˜¯å¦ä½¿ç”¨åªè¯»äº‹åŠ¡ | åŸå›  |
|------|----------------|------|
| æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ | âœ… ä½¿ç”¨ | çº¯æŸ¥è¯¢æ“ä½œ |
| ç”ŸæˆæŠ¥è¡¨ | âœ… ä½¿ç”¨ | åªè¯»å–æ•°æ® |
| æ•°æ®å¯¼å‡º | âœ… ä½¿ç”¨ | ä¸ä¿®æ”¹æ•°æ® |
| åˆ›å»ºè®¢å• | âŒ ä¸ä½¿ç”¨ | éœ€è¦å†™å…¥æ•°æ® |
| æ›´æ–°åº“å­˜ | âŒ ä¸ä½¿ç”¨ | éœ€è¦ä¿®æ”¹æ•°æ® |

### 4.3 åªè¯»äº‹åŠ¡å®æˆ˜


**åŸºç¡€ç”¨æ³•**

```java
// æ–¹å¼1: æ³¨è§£å£°æ˜
@Transactional(readOnly = true)
public List<User> getAllUsers() {
    return userRepository.findAll();
}

// æ–¹å¼2: ç¼–ç¨‹å¼å£°æ˜
public List<Order> getOrders() {
    TransactionDefinition def = new DefaultTransactionDefinition();
    ((DefaultTransactionDefinition) def).setReadOnly(true);
    
    TransactionStatus status = txManager.getTransaction(def);
    List<Order> orders = orderRepository.findAll();
    txManager.commit(status);
    return orders;
}
```

**å¤æ‚æŸ¥è¯¢ä¼˜åŒ–**

```java
@Transactional(readOnly = true)
public OrderReport generateReport(Date startDate, Date endDate) {
    // âœ… å¤šä¸ªæŸ¥è¯¢åœ¨ä¸€ä¸ªåªè¯»äº‹åŠ¡ä¸­
    List<Order> orders = orderRepository.findByDateRange(startDate, endDate);
    BigDecimal totalAmount = orderRepository.sumAmount(startDate, endDate);
    Long orderCount = orderRepository.countByDateRange(startDate, endDate);
    
    return new OrderReport(orders, totalAmount, orderCount);
}
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

```
åªè¯»äº‹åŠ¡æ€§èƒ½æå‡ï¼š

æ™®é€šäº‹åŠ¡æŸ¥è¯¢1000æ¬¡ï¼š
- è€—æ—¶: 5000ms
- é”ç­‰å¾…: 1000ms
- æ—¥å¿—å†™å…¥: 500ms

åªè¯»äº‹åŠ¡æŸ¥è¯¢1000æ¬¡ï¼š
- è€—æ—¶: 3000ms  â† å¿«40%
- é”ç­‰å¾…: 0ms    â† æ— é”ç­‰å¾…
- æ—¥å¿—å†™å…¥: 0ms  â† æ— æ—¥å¿—å¼€é”€
```

**æ³¨æ„äº‹é¡¹**ï¼š
> âš ï¸ **é‡è¦**ï¼šåªè¯»äº‹åŠ¡ä¸­å¦‚æœæ‰§è¡Œäº†ä¿®æ”¹æ“ä½œï¼Œä¸åŒæ•°æ®åº“è¡¨ç°ä¸åŒï¼š
> - MySQLï¼šå¯èƒ½æ‰§è¡ŒæˆåŠŸï¼ˆå–å†³äºé…ç½®ï¼‰
> - PostgreSQLï¼šä¼šæŠ›å‡ºå¼‚å¸¸
> - Oracleï¼šä¼šæŠ›å‡ºå¼‚å¸¸
> 
> ğŸ’¡ **å»ºè®®**ï¼šä¸¥æ ¼éµå®ˆåªè¯»çº¦å®šï¼Œä¸åœ¨åªè¯»äº‹åŠ¡ä¸­æ‰§è¡Œå†™æ“ä½œ

---

## 5. ğŸ”Œ è¿æ¥æ± é…ç½®ä¼˜åŒ–


### 5.1 ä»€ä¹ˆæ˜¯æ•°æ®åº“è¿æ¥æ± 


**ç”Ÿæ´»ç±»æ¯”**ï¼š
- æ²¡æœ‰è¿æ¥æ± ï¼šæ¯æ¬¡æ‰“ç”µè¯éƒ½è¦é‡æ–°æ‹‰ä¸€æ ¹ç”µè¯çº¿ï¼Œç”¨å®Œæ‹†æ‰
- æœ‰è¿æ¥æ± ï¼šæå‰æ‹‰å¥½10æ ¹ç”µè¯çº¿ï¼Œéœ€è¦æ—¶æ‹¿ä¸€æ ¹ï¼Œç”¨å®Œæ”¾å›å»

```
è¿æ¥æ± å·¥ä½œåŸç†ï¼š

åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºè¿æ¥æ± ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿æ¥æ±  (æœ€å¤š10ä¸ª)   â”‚
â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”  â”‚
â”‚  â”‚ 1 â”‚ â”‚ 2 â”‚ â”‚ 3 â”‚  â”‚ â† é¢„åˆ›å»ºçš„è¿æ¥
â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”        â”‚
â”‚  â”‚ 4 â”‚ â”‚ 5 â”‚  ...   â”‚
â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½¿ç”¨æµç¨‹ï¼š
1. åº”ç”¨éœ€è¦è¿æ¥ â†’ ä»æ± ä¸­å€Ÿä¸€ä¸ª
2. æ‰§è¡Œæ•°æ®åº“æ“ä½œ â†’ ä½¿ç”¨è¿æ¥
3. æ“ä½œå®Œæˆ â†’ å½’è¿˜ç»™æ± ï¼ˆä¸å…³é—­ï¼‰
4. è¿æ¥å¯ä»¥å¤ç”¨ â†’ ä¸‹æ¬¡ç»§ç»­ç”¨
```

### 5.2 HikariCPè¿æ¥æ± é…ç½®


**HikariCPæ˜¯ç›®å‰æœ€å¿«çš„è¿æ¥æ± **ï¼ŒSpring Booté»˜è®¤ä½¿ç”¨ã€‚

**æ ¸å¿ƒé…ç½®è¯´æ˜**

```yaml
spring:
  datasource:
    hikari:
      # è¿æ¥æ± å¤§å°é…ç½®
      minimum-idle: 10              # æœ€å°ç©ºé—²è¿æ¥æ•°
      maximum-pool-size: 20         # æœ€å¤§è¿æ¥æ•°
      
      # è¿æ¥è¶…æ—¶é…ç½®
      connection-timeout: 30000     # è·å–è¿æ¥è¶…æ—¶æ—¶é—´(æ¯«ç§’)
      idle-timeout: 600000          # ç©ºé—²è¿æ¥è¶…æ—¶æ—¶é—´(10åˆ†é’Ÿ)
      max-lifetime: 1800000         # è¿æ¥æœ€å¤§å­˜æ´»æ—¶é—´(30åˆ†é’Ÿ)
      
      # æ€§èƒ½ä¼˜åŒ–é…ç½®
      auto-commit: false            # å…³é—­è‡ªåŠ¨æäº¤
      connection-test-query: SELECT 1  # è¿æ¥æµ‹è¯•SQL
      validation-timeout: 5000      # è¿æ¥éªŒè¯è¶…æ—¶(5ç§’)
```

**å‚æ•°è¯¦è§£**ï¼š

| å‚æ•° | å«ä¹‰ | æ¨èå€¼ | è¯´æ˜ |
|------|------|--------|------|
| `minimum-idle` | æœ€å°ç©ºé—²è¿æ¥ | **10** | ä¿è¯è‡³å°‘æœ‰10ä¸ªè¿æ¥å¾…å‘½ |
| `maximum-pool-size` | æœ€å¤§è¿æ¥æ•° | **20-50** | æ ¹æ®å¹¶å‘é‡è°ƒæ•´ |
| `connection-timeout` | è·å–è¿æ¥è¶…æ—¶ | **30ç§’** | è¶…è¿‡30ç§’è¿˜æ²¡æ‹¿åˆ°è¿æ¥å°±æŠ¥é”™ |
| `idle-timeout` | ç©ºé—²è¶…æ—¶ | **10åˆ†é’Ÿ** | 10åˆ†é’Ÿä¸ç”¨çš„è¿æ¥ä¼šè¢«å›æ”¶ |
| `max-lifetime` | è¿æ¥æœ€å¤§å¯¿å‘½ | **30åˆ†é’Ÿ** | 30åˆ†é’Ÿåå¼ºåˆ¶é‡å»ºè¿æ¥ |

### 5.3 è¿æ¥æ± å¤§å°è®¡ç®—


**å¦‚ä½•ç¡®å®šè¿æ¥æ± å¤§å°ï¼Ÿ**

```
è®¡ç®—å…¬å¼ï¼š
è¿æ¥æ± å¤§å° = (æ ¸å¿ƒçº¿ç¨‹æ•° Ã— 2) + ç£ç›˜æ•°é‡

ä¾‹å¦‚ï¼š
- æœåŠ¡å™¨ï¼š4æ ¸CPU
- ç£ç›˜ï¼š1ä¸ªSSD
- è®¡ç®—ï¼š(4 Ã— 2) + 1 = 9ä¸ªè¿æ¥

å®é™…å»ºè®®ï¼š
- å°å‹åº”ç”¨ï¼š10-20ä¸ªè¿æ¥
- ä¸­å‹åº”ç”¨ï¼š20-50ä¸ªè¿æ¥  
- å¤§å‹åº”ç”¨ï¼š50-100ä¸ªè¿æ¥
```

**æµ‹è¯•è°ƒä¼˜æ­¥éª¤**ï¼š

```
ç¬¬1æ­¥ï¼šè®¾ç½®åˆå§‹å€¼
maximum-pool-size: 20

ç¬¬2æ­¥ï¼šå‹åŠ›æµ‹è¯•
- æ¨¡æ‹ŸçœŸå®å¹¶å‘é‡
- è§‚å¯Ÿè¿æ¥ä½¿ç”¨æƒ…å†µ
- è®°å½•å“åº”æ—¶é—´

ç¬¬3æ­¥ï¼šè°ƒæ•´å‚æ•°
è¿æ¥ä¸å¤Ÿç”¨ï¼Ÿ    â†’ å¢åŠ æ± å¤§å°
æœ‰å¾ˆå¤šç©ºé—²è¿æ¥ï¼Ÿ â†’ å‡å°‘æ± å¤§å°
å“åº”æ…¢ï¼Ÿ        â†’ æ£€æŸ¥SQLæ€§èƒ½

ç¬¬4æ­¥ï¼šé‡å¤æµ‹è¯•ç›´åˆ°æœ€ä¼˜
```

**é…ç½®ç¤ºä¾‹ï¼ˆä¸åŒåœºæ™¯ï¼‰**

```yaml
# åœºæ™¯1: å°å‹ç³»ç»Ÿ (100å¹¶å‘ä»¥å†…)
spring:
  datasource:
    hikari:
      minimum-idle: 5
      maximum-pool-size: 10

# åœºæ™¯2: ä¸­å‹ç³»ç»Ÿ (100-500å¹¶å‘)
spring:
  datasource:
    hikari:
      minimum-idle: 10
      maximum-pool-size: 30

# åœºæ™¯3: å¤§å‹ç³»ç»Ÿ (500+å¹¶å‘)
spring:
  datasource:
    hikari:
      minimum-idle: 20
      maximum-pool-size: 50
```

### 5.4 è¿æ¥æ± ç›‘æ§


**ç›‘æ§å…³é”®æŒ‡æ ‡**

```java
@Component
public class DataSourceMonitor {
    
    @Autowired
    private HikariDataSource dataSource;
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥
    public void monitorConnectionPool() {
        HikariPoolMXBean pool = dataSource.getHikariPoolMXBean();
        
        System.out.println("æ´»è·ƒè¿æ¥: " + pool.getActiveConnections());
        System.out.println("ç©ºé—²è¿æ¥: " + pool.getIdleConnections());
        System.out.println("æ€»è¿æ¥æ•°: " + pool.getTotalConnections());
        System.out.println("ç­‰å¾…çº¿ç¨‹: " + pool.getThreadsAwaitingConnection());
        
        // å‘Šè­¦åˆ¤æ–­
        if (pool.getActiveConnections() > 15) {
            System.out.println("âš ï¸ è­¦å‘Š: è¿æ¥ä½¿ç”¨ç‡è¿‡é«˜!");
        }
    }
}
```

**æ€§èƒ½è°ƒä¼˜å»ºè®®**ï¼š

> ğŸ“Š **ç›‘æ§æŒ‡æ ‡**ï¼š
> - æ´»è·ƒè¿æ¥æ•°æŒç»­æ¥è¿‘æœ€å¤§å€¼ â†’ éœ€è¦å¢åŠ è¿æ¥æ•°
> - ç©ºé—²è¿æ¥æ•°é•¿æœŸå¾ˆå¤š â†’ å¯ä»¥å‡å°‘è¿æ¥æ•°
> - ç­‰å¾…çº¿ç¨‹æ•° > 0 â†’ è¿æ¥ä¸å¤Ÿï¼Œéœ€è¦æ‰©å®¹
>
> ğŸ¯ **ä¼˜åŒ–ç›®æ ‡**ï¼š
> - ä¿æŒ60-80%çš„è¿æ¥åˆ©ç”¨ç‡
> - å°½é‡é¿å…å‡ºç°ç­‰å¾…çº¿ç¨‹
> - å®šæœŸå›æ”¶ç©ºé—²è¿æ¥

---

## 6. â±ï¸ é•¿äº‹åŠ¡ä¼˜åŒ–ç­–ç•¥


### 6.1 ä»€ä¹ˆæ˜¯é•¿äº‹åŠ¡


**é€šä¿—ç†è§£**ï¼šé•¿äº‹åŠ¡å°±æ˜¯æ‰§è¡Œæ—¶é—´å¾ˆé•¿çš„äº‹åŠ¡ï¼Œå°±åƒåœ¨é“¶è¡ŒæŸœå°åŠä¸šåŠ¡åŠäº†1ä¸ªå°æ—¶ï¼Œåé¢çš„äººéƒ½åœ¨ç­‰ã€‚

```
äº‹åŠ¡æ—¶é•¿åˆ†ç±»ï¼š

âœ… çŸ­äº‹åŠ¡ (æ¨è)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0.1ç§’å†… â”‚ â† å¿«é€Ÿå®Œæˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸ ä¸­ç­‰äº‹åŠ¡ (éœ€ä¼˜åŒ–)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0.1ç§’ - 1ç§’     â”‚ â† å¯ä»¥æ¥å—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âŒ é•¿äº‹åŠ¡ (ä¸¥é‡é—®é¢˜)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¶…è¿‡1ç§’ç”šè‡³å‡ åˆ†é’Ÿ              â”‚ â† å¿…é¡»ä¼˜åŒ–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 é•¿äº‹åŠ¡çš„å±å®³


**å±å®³æ¸…å•**ï¼š

```
1ï¸âƒ£ é”èµ„æºé•¿æ—¶é—´è¢«å ç”¨
   â†’ å…¶ä»–äº‹åŠ¡ç­‰å¾… â†’ ç³»ç»Ÿå¡é¡¿

2ï¸âƒ£ è¿æ¥æ± è¢«å æ»¡
   â†’ æ–°è¯·æ±‚æ‹¿ä¸åˆ°è¿æ¥ â†’ æŠ¥é”™

3ï¸âƒ£ å›æ»šæ—¥å¿—è†¨èƒ€
   â†’ å ç”¨å¤§é‡ç£ç›˜ç©ºé—´ â†’ æ€§èƒ½ä¸‹é™

4ï¸âƒ£ å®¹æ˜“å‘ç”Ÿæ­»é”
   â†’ äº‹åŠ¡æ—¶é—´è¶Šé•¿ï¼Œæ­»é”æ¦‚ç‡è¶Šå¤§

5ï¸âƒ£ ä¸»ä»å»¶è¿Ÿ
   â†’ ä¸»åº“äº‹åŠ¡æœªæäº¤ï¼Œä»åº“æ•°æ®ä¸ä¸€è‡´
```

**å®é™…æ¡ˆä¾‹**ï¼š

```
åä¾‹ï¼šä¸€ä¸ªé•¿äº‹åŠ¡å¯¼è‡´ç³»ç»Ÿå´©æºƒ

@Transactional
public void processMonthlyReport() {
    // âŒ åœ¨äº‹åŠ¡å†…æ‰§è¡Œäº†å¤§é‡æ“ä½œ
    
    // 1. æŸ¥è¯¢100ä¸‡æ¡è®¢å• (è€—æ—¶10ç§’)
    List<Order> orders = orderRepository.findAll();
    
    // 2. é€æ¡è®¡ç®—å¤„ç† (è€—æ—¶5åˆ†é’Ÿ)
    for (Order order : orders) {
        calculateDiscount(order);
        generateInvoice(order);
    }
    
    // 3. ç”ŸæˆExcelæŠ¥è¡¨ (è€—æ—¶2åˆ†é’Ÿ)
    ExcelReport report = generateExcel(orders);
    
    // 4. ä¿å­˜ç»“æœ (è€—æ—¶1ç§’)
    reportRepository.save(report);
    
    // æ€»è€—æ—¶: 7åˆ†å¤šé’Ÿï¼
    // åæœ: æ•°æ®åº“è¿æ¥è¢«å ç”¨7åˆ†é’Ÿï¼Œå…¶ä»–è¯·æ±‚å…¨éƒ¨è¶…æ—¶ï¼
}
```

### 6.3 é•¿äº‹åŠ¡ä¼˜åŒ–æ–¹æ¡ˆ


**âœ… æ–¹æ¡ˆ1ï¼šæ‹†åˆ†äº‹åŠ¡**

```java
public void processMonthlyReport() {
    // ç¬¬1æ­¥ï¼šæŸ¥è¯¢æ•°æ®ï¼ˆä¸åœ¨äº‹åŠ¡ä¸­ï¼‰
    List<Order> orders = orderRepository.findAll();
    
    // ç¬¬2æ­¥ï¼šè®¡ç®—å¤„ç†ï¼ˆä¸åœ¨äº‹åŠ¡ä¸­ï¼‰
    for (Order order : orders) {
        calculateDiscount(order);
        generateInvoice(order);
    }
    
    // ç¬¬3æ­¥ï¼šç”ŸæˆæŠ¥è¡¨ï¼ˆä¸åœ¨äº‹åŠ¡ä¸­ï¼‰
    ExcelReport report = generateExcel(orders);
    
    // ç¬¬4æ­¥ï¼šåªåœ¨ä¿å­˜æ—¶å¼€å¯äº‹åŠ¡
    saveReportInTransaction(report);
}

@Transactional
public void saveReportInTransaction(ExcelReport report) {
    reportRepository.save(report); // åªæœ‰è¿™é‡Œåœ¨äº‹åŠ¡ä¸­
}
```

**âœ… æ–¹æ¡ˆ2ï¼šåˆ†æ‰¹å¤„ç†**

```java
public void processLargeData(List<Data> dataList) {
    int batchSize = 1000;
    int total = dataList.size();
    
    // åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹ä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡
    for (int i = 0; i < total; i += batchSize) {
        int end = Math.min(i + batchSize, total);
        List<Data> batch = dataList.subList(i, end);
        
        // æ¯æ‰¹æ•°æ®ç”¨ä¸€ä¸ªå°äº‹åŠ¡
        processBatchInTransaction(batch);
    }
}

@Transactional
public void processBatchInTransaction(List<Data> batch) {
    batch.forEach(data -> {
        dataRepository.save(data);
    });
    // æ¯ä¸ªäº‹åŠ¡å¾ˆå¿«å°±å®Œæˆ
}
```

**âœ… æ–¹æ¡ˆ3ï¼šå¼‚æ­¥å¤„ç†**

```java
@Service
public class OrderService {
    
    @Autowired
    private AsyncService asyncService;
    
    // ä¸»äº‹åŠ¡åªåšæ ¸å¿ƒæ“ä½œ
    @Transactional
    public void createOrder(Order order) {
        orderRepository.save(order);
        
        // å¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œï¼ˆä¸åœ¨å½“å‰äº‹åŠ¡ä¸­ï¼‰
        asyncService.processOrderAsync(order.getId());
    }
}

@Service
public class AsyncService {
    
    @Async
    @Transactional
    public void processOrderAsync(Long orderId) {
        // åœ¨å¦ä¸€ä¸ªçº¿ç¨‹å’Œäº‹åŠ¡ä¸­å¤„ç†
        Order order = orderRepository.findById(orderId).get();
        sendEmail(order);
        generateInvoice(order);
    }
}
```

**ä¼˜åŒ–æ•ˆæœå¯¹æ¯”**ï¼š

| ä¼˜åŒ–æ–¹å¼ | äº‹åŠ¡æ—¶é•¿ | é”å ç”¨æ—¶é—´ | å¹¶å‘èƒ½åŠ› |
|---------|---------|-----------|---------|
| ä¼˜åŒ–å‰ï¼ˆé•¿äº‹åŠ¡ï¼‰ | **7åˆ†é’Ÿ** | 7åˆ†é’Ÿ | å¾ˆå·® |
| æ‹†åˆ†äº‹åŠ¡ | **0.1ç§’** | 0.1ç§’ | å¤§å¹…æå‡ |
| åˆ†æ‰¹å¤„ç† | **æ¯æ‰¹0.1ç§’** | æ¯æ‰¹0.1ç§’ | æå‡æ˜æ˜¾ |
| å¼‚æ­¥å¤„ç† | **0.1ç§’** | 0.1ç§’ | æœ€å¥½ |

---

## 7. ğŸ”’ æ­»é”é—®é¢˜å¤„ç†


### 7.1 ä»€ä¹ˆæ˜¯æ­»é”


**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
ä¸¤ä¸ªäººæŠ¢ç­·å­åƒé¥­ï¼š

å°æ˜æ‹¿äº†å·¦è¾¹çš„ç­·å­ï¼Œç­‰å³è¾¹çš„ç­·å­
å°çº¢æ‹¿äº†å³è¾¹çš„ç­·å­ï¼Œç­‰å·¦è¾¹çš„ç­·å­

ç»“æœï¼šä¸¤ä¸ªäººéƒ½åœ¨ç­‰å¯¹æ–¹æ‰‹é‡Œçš„ç­·å­ï¼Œè°éƒ½åƒä¸äº†é¥­ â†’ æ­»é”
```

**æŠ€æœ¯ç†è§£**ï¼šä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œå¯¼è‡´éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œã€‚

```
æ­»é”åœºæ™¯ç¤ºæ„å›¾ï¼š

æ—¶é—´çº¿ â†’ 

äº‹åŠ¡A: [è·å–é”1] â”€â”€â”€â”€â†’ ç­‰å¾…é”2 â”€â”€â”€â”€â†’ âŒ æ­»é”
                      â†‘
                      â”‚
äº‹åŠ¡B: [è·å–é”2] â”€â”€â”€â”€â†’ ç­‰å¾…é”1 â”€â”€â”€â”€â†’ âŒ æ­»é”

ç»“æœï¼šä¸¤ä¸ªäº‹åŠ¡éƒ½åœ¨ç­‰ï¼Œéƒ½æ‰§è¡Œä¸ä¸‹å»
```

### 7.2 æ­»é”äº§ç”Ÿçš„åŸå› 


**å¸¸è§æ­»é”åœºæ™¯**

**åœºæ™¯1ï¼šåŠ é”é¡ºåºä¸ä¸€è‡´**

```java
// äº‹åŠ¡A
@Transactional
public void transferA() {
    accountRepository.lockAccount(1); // å…ˆé”è´¦æˆ·1
    accountRepository.lockAccount(2); // å†é”è´¦æˆ·2
    // è½¬è´¦æ“ä½œ
}

// äº‹åŠ¡B  
@Transactional
public void transferB() {
    accountRepository.lockAccount(2); // å…ˆé”è´¦æˆ·2
    accountRepository.lockAccount(1); // å†é”è´¦æˆ·1
    // è½¬è´¦æ“ä½œ
}

// å¦‚æœAå’ŒBåŒæ—¶æ‰§è¡Œï¼š
// Aæ‹¿åˆ°é”1ï¼Œç­‰é”2
// Bæ‹¿åˆ°é”2ï¼Œç­‰é”1
// â†’ æ­»é”ï¼
```

**åœºæ™¯2ï¼šé•¿äº‹åŠ¡+é«˜å¹¶å‘**

```java
@Transactional
public void updateInventory(Long productId, int quantity) {
    // 1. é”å®šå•†å“è®°å½•ï¼ˆè€—æ—¶ï¼‰
    Product product = productRepository.findByIdForUpdate(productId);
    
    // 2. å¤æ‚è®¡ç®—ï¼ˆè€—æ—¶ï¼‰
    Thread.sleep(5000); // æ¨¡æ‹Ÿå¤æ‚ä¸šåŠ¡
    
    // 3. æ›´æ–°åº“å­˜
    product.setStock(product.getStock() - quantity);
    productRepository.save(product);
    
    // äº‹åŠ¡æ—¶é—´å¤ªé•¿ï¼Œé”å®šæ—¶é—´é•¿ï¼Œå®¹æ˜“æ­»é”
}
```

### 7.3 æ­»é”é¿å…ç­–ç•¥


**âœ… ç­–ç•¥1ï¼šç»Ÿä¸€åŠ é”é¡ºåº**

```java
// å®šä¹‰ç»Ÿä¸€çš„åŠ é”é¡ºåºè§„åˆ™
public class LockOrderUtil {
    public static List<Long> sortAccountIds(Long id1, Long id2) {
        // æŒ‰IDå¤§å°æ’åºï¼Œä¿è¯åŠ é”é¡ºåºä¸€è‡´
        return Arrays.asList(id1, id2).stream()
                .sorted()
                .collect(Collectors.toList());
    }
}

// äº‹åŠ¡Aå’Œäº‹åŠ¡Béƒ½æŒ‰ç»Ÿä¸€é¡ºåºåŠ é”
@Transactional
public void transfer(Long fromId, Long toId, BigDecimal amount) {
    List<Long> orderedIds = LockOrderUtil.sortAccountIds(fromId, toId);
    
    // âœ… æŒ‰é¡ºåºåŠ é”
    Account account1 = accountRepository.lockById(orderedIds.get(0));
    Account account2 = accountRepository.lockById(orderedIds.get(1));
    
    // æ‰§è¡Œè½¬è´¦
    if (account1.getId().equals(fromId)) {
        account1.setBalance(account1.getBalance().subtract(amount));
        account2.setBalance(account2.getBalance().add(amount));
    } else {
        account2.setBalance(account2.getBalance().subtract(amount));
        account1.setBalance(account1.getBalance().add(amount));
    }
}
```

**âœ… ç­–ç•¥2ï¼šä½¿ç”¨ä¹è§‚é”æ›¿ä»£æ‚²è§‚é”**

```java
@Entity
public class Product {
    @Id
    private Long id;
    
    private Integer stock;
    
    @Version  // ä¹è§‚é”ç‰ˆæœ¬å·
    private Integer version;
}

@Transactional
public void updateStock(Long productId, int quantity) {
    // ä¸åŠ é”æŸ¥è¯¢
    Product product = productRepository.findById(productId).get();
    
    // ä¿®æ”¹æ•°æ®
    product.setStock(product.setStock() - quantity);
    
    try {
        // æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·
        productRepository.save(product);
    } catch (OptimisticLockException e) {
        // ç‰ˆæœ¬å·ä¸ä¸€è‡´ï¼Œè¯´æ˜è¢«åˆ«äººæ”¹äº†ï¼Œé‡è¯•
        updateStock(productId, quantity);
    }
}
```

**âœ… ç­–ç•¥3ï¼šå‡å°é”ç²’åº¦**

```java
// âŒ é”™è¯¯ï¼šé”æ•´å¼ è¡¨
@Transactional
public void processOrder(Order order) {
    // SELECT * FROM product FOR UPDATE; -- é”æ‰€æœ‰å•†å“
    List<Product> products = productRepository.findAllForUpdate();
    // å¤„ç†è®¢å•...
}

// âœ… æ­£ç¡®ï¼šåªé”éœ€è¦çš„è®°å½•
@Transactional
public void processOrder(Order order) {
    // åªé”è®¢å•ä¸­çš„å•†å“
    for (OrderItem item : order.getItems()) {
        Product product = productRepository
            .findByIdForUpdate(item.getProductId());
        // å¤„ç†å•ä¸ªå•†å“
    }
}
```

### 7.4 æ­»é”æ£€æµ‹ä¸å¤„ç†


**MySQLæ­»é”æ£€æµ‹é…ç½®**

```sql
-- æŸ¥çœ‹æ­»é”ä¿¡æ¯
SHOW ENGINE INNODB STATUS;

-- è®¾ç½®æ­»é”è¶…æ—¶æ—¶é—´
SET innodb_lock_wait_timeout = 50; -- 50ç§’è¶…æ—¶

-- å¼€å¯æ­»é”æ£€æµ‹
SET innodb_deadlock_detect = ON;
```

**åº”ç”¨å±‚æ­»é”å¤„ç†**

```java
@Service
public class OrderService {
    
    private static final int MAX_RETRY = 3; // æœ€å¤šé‡è¯•3æ¬¡
    
    public void createOrder(Order order) {
        int retryCount = 0;
        
        while (retryCount < MAX_RETRY) {
            try {
                createOrderInTransaction(order);
                return; // æˆåŠŸåˆ™é€€å‡º
                
            } catch (DeadlockException e) {
                retryCount++;
                
                if (retryCount >= MAX_RETRY) {
                    throw new BusinessException("åˆ›å»ºè®¢å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
                }
                
                // ç­‰å¾…éšæœºæ—¶é—´åé‡è¯•ï¼Œé¿å…å†æ¬¡æ­»é”
                Thread.sleep((long) (Math.random() * 1000));
            }
        }
    }
    
    @Transactional
    public void createOrderInTransaction(Order order) {
        orderRepository.save(order);
        // æ›´æ–°åº“å­˜ç­‰æ“ä½œ
    }
}
```

**æ­»é”é¢„é˜²checklist**ï¼š

> âœ… **åŠ é”é¡ºåº**ï¼šæ‰€æœ‰äº‹åŠ¡æŒ‰ç»Ÿä¸€é¡ºåºåŠ é”  
> âœ… **é”ç²’åº¦**ï¼šå°½é‡åªé”å¿…è¦çš„è®°å½•  
> âœ… **äº‹åŠ¡æ—¶é•¿**ï¼šç¼©çŸ­äº‹åŠ¡æ‰§è¡Œæ—¶é—´  
> âœ… **é”ç±»å‹**ï¼šä¼˜å…ˆä½¿ç”¨ä¹è§‚é”  
> âœ… **ç´¢å¼•ä¼˜åŒ–**ï¼šé¿å…é”è¡¨ï¼Œä½¿ç”¨è¡Œé”  
> âœ… **è¶…æ—¶è®¾ç½®**ï¼šé…ç½®åˆç†çš„é”è¶…æ—¶æ—¶é—´  
> âœ… **é‡è¯•æœºåˆ¶**ï¼šæ­»é”æ—¶è‡ªåŠ¨é‡è¯•

---

## 8. ğŸ¯ SQLä¸ç´¢å¼•ä¼˜åŒ–


### 8.1 SQLä¼˜åŒ–åŸºç¡€


**SQLæ€§èƒ½é—®é¢˜å®šä½**

```java
// å¼€å¯SQLæ—¥å¿—ï¼ŒæŸ¥çœ‹æ‰§è¡Œçš„SQL
spring:
  jpa:
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        use_sql_comments: true
```

**å¸¸è§æ…¢SQLé—®é¢˜**

```java
// âŒ é—®é¢˜1ï¼šæŸ¥è¯¢äº†ä¸éœ€è¦çš„å­—æ®µ
@Query("SELECT u FROM User u WHERE u.age > :age")
List<User> findByAge(int age); // æŸ¥è¯¢äº†æ‰€æœ‰å­—æ®µ

// âœ… ä¼˜åŒ–ï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
@Query("SELECT new com.example.dto.UserDTO(u.id, u.name) " +
       "FROM User u WHERE u.age > :age")
List<UserDTO> findByAgeDTO(int age);

// âŒ é—®é¢˜2ï¼šN+1æŸ¥è¯¢é—®é¢˜
@OneToMany
private List<Order> orders; // å»¶è¿ŸåŠ è½½

public void printUserOrders() {
    List<User> users = userRepository.findAll(); // 1æ¬¡æŸ¥è¯¢
    for (User user : users) {
        System.out.println(user.getOrders()); // Næ¬¡æŸ¥è¯¢
    }
    // æ€»å…±ï¼š1 + N æ¬¡æŸ¥è¯¢
}

// âœ… ä¼˜åŒ–ï¼šä½¿ç”¨JOIN FETCHä¸€æ¬¡æŸ¥è¯¢
@Query("SELECT u FROM User u LEFT JOIN FETCH u.orders")
List<User> findAllWithOrders();
```

### 8.2 ç´¢å¼•ä¼˜åŒ–


**ç´¢å¼•çš„ä½œç”¨ï¼ˆç±»æ¯”ï¼‰**

```
æ²¡æœ‰ç´¢å¼• = å›¾ä¹¦é¦†æ²¡æœ‰ç›®å½•
è¦æ‰¾"Javaç¼–ç¨‹"è¿™æœ¬ä¹¦ï¼š
1. ä»ç¬¬ä¸€æ’ç¬¬ä¸€æœ¬å¼€å§‹æ‰¾
2. é€æœ¬æ£€æŸ¥ä¹¦å
3. å¯èƒ½è¦æ‰¾å‡ ä¸ªå°æ—¶

æœ‰ç´¢å¼• = å›¾ä¹¦é¦†æœ‰åˆ†ç±»ç›®å½•
è¦æ‰¾"Javaç¼–ç¨‹"è¿™æœ¬ä¹¦ï¼š
1. æŸ¥ç›®å½•ï¼šè®¡ç®—æœºç±» â†’ Javaç±» â†’ ç¬¬3æ’ç¬¬5æœ¬
2. ç›´æ¥å»æ‹¿ä¹¦
3. åªéœ€è¦å‡ åˆ†é’Ÿ
```

**ç´¢å¼•ä½¿ç”¨è§„åˆ™**

```java
@Entity
@Table(name = "orders",
       indexes = {
           @Index(name = "idx_user_id", columnList = "user_id"),
           @Index(name = "idx_status", columnList = "status"),
           @Index(name = "idx_user_status", columnList = "user_id, status")
       })
public class Order {
    @Id
    private Long id;
    
    @Column(name = "user_id")
    private Long userId;
    
    private String status;
    
    private Date createTime;
}
```

**ç´¢å¼•ä½¿ç”¨ä¸å¤±æ•ˆåœºæ™¯**

```java
// âœ… ä¼šä½¿ç”¨ç´¢å¼•
orderRepository.findByUserId(123L); 
// SQL: WHERE user_id = 123
// ä½¿ç”¨äº†idx_user_idç´¢å¼•

// âœ… ä¼šä½¿ç”¨ç´¢å¼•
orderRepository.findByUserIdAndStatus(123L, "PAID");
// SQL: WHERE user_id = 123 AND status = 'PAID'
// ä½¿ç”¨äº†idx_user_statuså¤åˆç´¢å¼•

// âŒ ä¸ä¼šä½¿ç”¨ç´¢å¼•ï¼ˆå‡½æ•°æ“ä½œï¼‰
@Query("SELECT o FROM Order o WHERE YEAR(o.createTime) = :year")
List<Order> findByYear(int year);
// å¯¹create_timeä½¿ç”¨äº†YEARå‡½æ•°ï¼Œç´¢å¼•å¤±æ•ˆ

// âœ… ä¼˜åŒ–åä½¿ç”¨ç´¢å¼•
@Query("SELECT o FROM Order o WHERE o.createTime >= :startDate " +
       "AND o.createTime < :endDate")
List<Order> findByDateRange(Date startDate, Date endDate);

// âŒ ä¸ä¼šä½¿ç”¨ç´¢å¼•ï¼ˆæ¨¡ç³ŠåŒ¹é…å¼€å¤´ï¼‰
orderRepository.findByStatusStartingWith("P");
// SQL: WHERE status LIKE 'P%'  -- å¯ä»¥ç”¨ç´¢å¼•

orderRepository.findByStatusContaining("AI");
// SQL: WHERE status LIKE '%AI%'  -- ä¸èƒ½ç”¨ç´¢å¼•
```

**ç´¢å¼•è®¾è®¡åŸåˆ™**

| åœºæ™¯ | æ˜¯å¦å»ºç´¢å¼• | åŸå›  |
|------|-----------|------|
| WHEREæ¡ä»¶å¸¸ç”¨å­—æ®µ | âœ… å»ºè®® | åŠ é€ŸæŸ¥è¯¢ |
| JOINè¿æ¥å­—æ®µ | âœ… å»ºè®® | åŠ é€Ÿå…³è” |
| ORDER BYå­—æ®µ | âœ… å»ºè®® | é¿å…æ’åº |
| é¢‘ç¹æ›´æ–°çš„å­—æ®µ | âŒ ä¸å»ºè®® | å½±å“å†™å…¥æ€§èƒ½ |
| åŒºåˆ†åº¦å¾ˆä½çš„å­—æ®µ | âŒ ä¸å»ºè®® | ç´¢å¼•æ•ˆæœå·®ï¼ˆå¦‚æ€§åˆ«ï¼‰ |
| TEXT/BLOBå­—æ®µ | âŒ ä¸å»ºè®® | ç´¢å¼•å¤ªå¤§ |

### 8.3 äº‹åŠ¡ä¸­çš„SQLä¼˜åŒ–


**æ‰¹é‡æ“ä½œä¼˜åŒ–**

```java
// âŒ æ…¢ï¼šé€æ¡åˆ é™¤
@Transactional
public void deleteUsers(List<Long> userIds) {
    for (Long id : userIds) {
        userRepository.deleteById(id); // æ¯æ¬¡ä¸€æ¡DELETE
    }
}

// âœ… å¿«ï¼šæ‰¹é‡åˆ é™¤
@Transactional
public void deleteUsersBatch(List<Long> userIds) {
    userRepository.deleteAllByIdInBatch(userIds); 
    // ä¸€æ¡SQL: DELETE FROM user WHERE id IN (1,2,3,...)
}
```

**ä½¿ç”¨EXISTSæ›¿ä»£IN**

```java
// âŒ æ…¢ï¼šINå­æŸ¥è¯¢
@Query("SELECT o FROM Order o WHERE o.userId IN " +
       "(SELECT u.id FROM User u WHERE u.level = 'VIP')")
List<Order> findVipOrders();

// âœ… å¿«ï¼šEXISTSå­æŸ¥è¯¢
@Query("SELECT o FROM Order o WHERE EXISTS " +
       "(SELECT 1 FROM User u WHERE u.id = o.userId AND u.level = 'VIP')")
List<Order> findVipOrdersFast();
```

**æŸ¥è¯¢ç»“æœç¼“å­˜**

```java
@Entity
@Cacheable // å¼€å¯äºŒçº§ç¼“å­˜
@org.hibernate.annotations.Cache(
    usage = CacheConcurrencyStrategy.READ_WRITE
)
public class Product {
    @Id
    private Long id;
    private String name;
    private BigDecimal price;
}

// æŸ¥è¯¢æ—¶è‡ªåŠ¨ä½¿ç”¨ç¼“å­˜
Product p1 = productRepository.findById(1L).get(); // æŸ¥æ•°æ®åº“
Product p2 = productRepository.findById(1L).get(); // ä»ç¼“å­˜è¯»å–
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 äº‹åŠ¡ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™


```
ğŸ¯ ä¸‰å¤§æ ¸å¿ƒåŸåˆ™ï¼š

1ï¸âƒ£ äº‹åŠ¡è¦å°è¦å¿«
   âœ… èŒƒå›´å°½é‡å°ï¼Œåªä¿æŠ¤å¿…è¦æ“ä½œ
   âœ… æ‰§è¡Œæ—¶é—´å°½é‡çŸ­ï¼Œé¿å…é•¿äº‹åŠ¡
   âœ… æ‰¹é‡æ“ä½œåˆå¹¶äº‹åŠ¡

2ï¸âƒ£ å‡å°‘é”å†²çª
   âœ… ç»Ÿä¸€åŠ é”é¡ºåº
   âœ… ä¼˜å…ˆä½¿ç”¨ä¹è§‚é”
   âœ… å‡å°é”ç²’åº¦

3ï¸âƒ£ æé«˜å¹¶å‘èƒ½åŠ›
   âœ… åªè¯»äº‹åŠ¡å£°æ˜readOnly
   âœ… åˆç†é…ç½®è¿æ¥æ± 
   âœ… å¼‚æ­¥å¤„ç†éæ ¸å¿ƒä»»åŠ¡
```

### 9.2 ä¼˜åŒ–æ•ˆæœå¯¹æ¯”


| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡æ•ˆæœ |
|--------|--------|--------|----------|
| **äº‹åŠ¡èŒƒå›´** | åŒ…å«å¤–éƒ¨è°ƒç”¨5ç§’ | ä»…æ•°æ®åº“æ“ä½œ0.1ç§’ | **50å€** |
| **æ‰¹å¤„ç†** | é€æ¡å¤„ç†10ç§’ | æ‰¹é‡å¤„ç†1ç§’ | **10å€** |
| **åªè¯»äº‹åŠ¡** | æ™®é€šäº‹åŠ¡5ç§’ | åªè¯»äº‹åŠ¡3ç§’ | **40%** |
| **é•¿äº‹åŠ¡æ‹†åˆ†** | 7åˆ†é’Ÿé•¿äº‹åŠ¡ | 0.1ç§’çŸ­äº‹åŠ¡ | **4200å€** |
| **æ­»é”ä¼˜åŒ–** | æ¯å¤©100æ¬¡æ­»é” | æ¯å¤©5æ¬¡æ­»é” | **95%å‡å°‘** |
| **SQLä¼˜åŒ–** | N+1æŸ¥è¯¢100æ¬¡ | JOIN 1æ¬¡ | **100å€** |

### 9.3 ä¼˜åŒ–checklist


**å¼€å‘é˜¶æ®µ**
- [ ] äº‹åŠ¡èŒƒå›´æ˜¯å¦æœ€å°ï¼ˆä¸åŒ…å«å¤–éƒ¨è°ƒç”¨ï¼‰
- [ ] æ˜¯å¦ä½¿ç”¨äº†æ‰¹å¤„ç†
- [ ] æŸ¥è¯¢æ“ä½œæ˜¯å¦æ ‡è®°readOnly
- [ ] æ˜¯å¦é¿å…äº†é•¿äº‹åŠ¡
- [ ] åŠ é”é¡ºåºæ˜¯å¦ç»Ÿä¸€

**æµ‹è¯•é˜¶æ®µ**
- [ ] å‹åŠ›æµ‹è¯•æ˜¯å¦é€šè¿‡
- [ ] æ˜¯å¦å­˜åœ¨æ…¢SQL
- [ ] è¿æ¥æ± é…ç½®æ˜¯å¦åˆç†
- [ ] æ˜¯å¦å‡ºç°æ­»é”

**ä¸Šçº¿å‰**
- [ ] ç›‘æ§æŒ‡æ ‡æ˜¯å¦å®Œå–„
- [ ] é‡è¯•æœºåˆ¶æ˜¯å¦å®Œå–„
- [ ] æ˜¯å¦æœ‰é™çº§æ–¹æ¡ˆ

### 9.4 æœ€ä½³å®è·µæ€»ç»“


```
ğŸ’¡ è®°ä½è¿™äº›è¦ç‚¹ï¼š

1. äº‹åŠ¡èŒƒå›´
   "äº‹åŠ¡èŒƒå›´è¶Šå°è¶Šå¥½ï¼Œåªä¿æŠ¤æ•°æ®åº“æ“ä½œ"
   
2. æ‰¹é‡å¤„ç†
   "èƒ½æ‰¹é‡å°±ä¸å•æ¡ï¼Œå‡å°‘äº‹åŠ¡å¼€é”€"
   
3. åªè¯»ä¼˜åŒ–  
   "æŸ¥è¯¢å°±ç”¨readOnlyï¼Œæ€§èƒ½æå‡æ˜æ˜¾"
   
4. è¿æ¥æ± 
   "æ ¹æ®å¹¶å‘é‡è°ƒæ•´ï¼Œç›‘æ§å¾ˆé‡è¦"
   
5. é•¿äº‹åŠ¡
   "é•¿äº‹åŠ¡å¿…é¡»æ‹†ï¼Œå¼‚æ­¥æ˜¯ä¸ªå¥½åŠæ³•"
   
6. æ­»é”
   "åŠ é”è¦æœ‰åºï¼Œä¹è§‚é”ä¼˜å…ˆ"
   
7. SQLä¼˜åŒ–
   "ç´¢å¼•è¦å»ºå¥½ï¼Œæ…¢SQLè¦æ‰¾åˆ°"
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
äº‹åŠ¡è¦å°ä¸è¦å¤§ï¼ŒèŒƒå›´æ§åˆ¶æ˜¯å…³é”®
æ‰¹é‡å¤„ç†ææ•ˆç‡ï¼Œåªè¯»ä¼˜åŒ–åˆ«å¿˜è®°  
è¿æ¥æ± è¦é…å¥½ï¼Œé•¿äº‹åŠ¡è¦æ‹†åˆ†
æ­»é”é¡ºåºè¦ç»Ÿä¸€ï¼ŒSQLç´¢å¼•ä¼˜åŒ–å¥½
ç›‘æ§å‘Šè­¦ä¸èƒ½å°‘ï¼Œæ€§èƒ½ä¼˜åŒ–å¾ˆé‡è¦
```