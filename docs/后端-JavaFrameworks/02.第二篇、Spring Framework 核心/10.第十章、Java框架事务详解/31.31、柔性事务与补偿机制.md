---
title: 31ã€æŸ”æ€§äº‹åŠ¡ä¸è¡¥å¿æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [æŸ”æ€§äº‹åŠ¡åŸºç¡€æ¦‚å¿µ](#1-æŸ”æ€§äº‹åŠ¡åŸºç¡€æ¦‚å¿µ)
2. [è¡¥å¿äº‹åŠ¡è¯¦è§£](#2-è¡¥å¿äº‹åŠ¡è¯¦è§£)
3. [æ¶ˆæ¯äº‹åŠ¡æœºåˆ¶](#3-æ¶ˆæ¯äº‹åŠ¡æœºåˆ¶)
4. [äº‹åŠ¡æ¶ˆæ¯å®ç°](#4-äº‹åŠ¡æ¶ˆæ¯å®ç°)
5. [è¡¥å¿æœºåˆ¶è®¾è®¡](#5-è¡¥å¿æœºåˆ¶è®¾è®¡)
6. [ä¸šåŠ¡è¡¥å¿å®è·µ](#6-ä¸šåŠ¡è¡¥å¿å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŸ æŸ”æ€§äº‹åŠ¡åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æŸ”æ€§äº‹åŠ¡


> ğŸ“– **æ ¸å¿ƒæ¦‚å¿µ**  
> æŸ”æ€§äº‹åŠ¡æ˜¯æŒ‡åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œ**ä¸ä¸¥æ ¼è¦æ±‚å®æ—¶ä¸€è‡´æ€§**ï¼Œè€Œæ˜¯**å…è®¸æ•°æ®åœ¨ä¸€æ®µæ—¶é—´åè¾¾åˆ°æœ€ç»ˆä¸€è‡´**çš„äº‹åŠ¡å¤„ç†æ–¹å¼

**ğŸ” ç”Ÿæ´»ç±»æ¯”**
```
åˆšæ€§äº‹åŠ¡ = ç°åœºè½¬è´¦
ä½ åœ¨æŸœå°è½¬è´¦ï¼Œé’±å¿…é¡»ç«‹å³ä»Aè´¦æˆ·è½¬åˆ°Bè´¦æˆ·ï¼Œä¸­é—´ä¸èƒ½å‡ºå·®é”™

æŸ”æ€§äº‹åŠ¡ = è·¨è¡Œè½¬è´¦  
ä½ é€šè¿‡ç½‘é“¶è½¬è´¦ï¼Œå¯èƒ½å‡ åˆ†é’Ÿæˆ–å‡ å°æ—¶ååˆ°è´¦
è¿™æœŸé—´æ•°æ®ä¸ä¸€è‡´ï¼Œä½†æœ€ç»ˆä¼šä¸€è‡´
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æŸ”æ€§äº‹åŠ¡


**ä¼ ç»Ÿåˆšæ€§äº‹åŠ¡çš„å›°å¢ƒ**
```
ç”µå•†ä¸‹å•åœºæ™¯ï¼š
è®¢å•æœåŠ¡ â”€â”€é”å®šåº“å­˜â”€â”€> åº“å­˜æœåŠ¡
    |                      |
    â””â”€â”€æ‰£å‡ç§¯åˆ†â”€â”€> ç§¯åˆ†æœåŠ¡
    
åˆšæ€§äº‹åŠ¡é—®é¢˜ï¼š
âŒ ä¸‰ä¸ªæœåŠ¡å¿…é¡»åŒæ—¶æˆåŠŸæˆ–å¤±è´¥
âŒ é•¿æ—¶é—´é”å®šèµ„æºï¼Œå½±å“æ€§èƒ½
âŒ ä¸€ä¸ªæœåŠ¡æ•…éšœï¼Œå…¨éƒ¨å›æ»š
âŒ åˆ†å¸ƒå¼ç¯å¢ƒä¸‹éš¾ä»¥å®ç°
```

**æŸ”æ€§äº‹åŠ¡çš„ä¼˜åŠ¿**
```
âœ… é«˜å¯ç”¨æ€§ï¼šå•ä¸ªæœåŠ¡æ•…éšœä¸å½±å“æ•´ä½“
âœ… é«˜æ€§èƒ½ï¼šä¸éœ€è¦é•¿æ—¶é—´é”å®šèµ„æº
âœ… å¯æ‰©å±•ï¼šé€‚åˆå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿ
âœ… æœ€ç»ˆä¸€è‡´ï¼šä¿è¯æ•°æ®æœ€ç»ˆæ­£ç¡®å³å¯
```

### 1.3 æŸ”æ€§äº‹åŠ¡çš„æ ¸å¿ƒæ€æƒ³


**ğŸ¯ BASEç†è®º**
```
ä¼ ç»ŸACIDï¼ˆåˆšæ€§äº‹åŠ¡ï¼‰          BASEï¼ˆæŸ”æ€§äº‹åŠ¡ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Aï¼šåŸå­æ€§    â”‚              â”‚ BAï¼šåŸºæœ¬å¯ç”¨     â”‚
â”‚ Cï¼šä¸€è‡´æ€§    â”‚    VS        â”‚ Sï¼šè½¯çŠ¶æ€       â”‚
â”‚ Iï¼šéš”ç¦»æ€§    â”‚              â”‚ Eï¼šæœ€ç»ˆä¸€è‡´æ€§    â”‚
â”‚ Dï¼šæŒä¹…æ€§    â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸‰å¤§æ ¸å¿ƒç‰¹æ€§è¯¦è§£**

1ï¸âƒ£ **åŸºæœ¬å¯ç”¨ï¼ˆBasically Availableï¼‰**
```
ğŸ’¡ **å«ä¹‰**ï¼šç³»ç»Ÿä¿è¯æ ¸å¿ƒåŠŸèƒ½å¯ç”¨ï¼Œå…è®¸éƒ¨åˆ†åŠŸèƒ½é™çº§

å®ä¾‹ï¼šç”µå•†ç§’æ€
- æ ¸å¿ƒï¼šä¸‹å•åŠŸèƒ½å¿…é¡»å¯ç”¨ âœ…
- é™çº§ï¼šæ¨èåŠŸèƒ½å¯ä»¥æš‚åœ â¸ï¸
- é™çº§ï¼šè¯„è®ºåŠŸèƒ½å¯ä»¥å»¶è¿Ÿ â°
```

2ï¸âƒ£ **è½¯çŠ¶æ€ï¼ˆSoft Stateï¼‰**
```
ğŸ’¡ **å«ä¹‰**ï¼šå…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œä¸”ä¸å½±å“ç³»ç»Ÿå¯ç”¨æ€§

è®¢å•çŠ¶æ€æµè½¬ï¼š
åˆ›å»ºè®¢å• â†’ [å¤„ç†ä¸­] â†’ æ”¯ä»˜å®Œæˆ â†’ [é…è´§ä¸­] â†’ å‘è´§
          â†‘è½¯çŠ¶æ€â†‘              â†‘è½¯çŠ¶æ€â†‘

ç‰¹ç‚¹ï¼š
- æ•°æ®åœ¨ä¸åŒæœåŠ¡é—´å¯èƒ½ä¸ä¸€è‡´
- è¿™ç§ä¸ä¸€è‡´æ˜¯ä¸´æ—¶çš„ã€å¯æ¥å—çš„
```

3ï¸âƒ£ **æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventually Consistentï¼‰**
```
ğŸ’¡ **å«ä¹‰**ï¼šç³»ç»Ÿä¸­çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´åæœ€ç»ˆèƒ½è¾¾åˆ°ä¸€è‡´çŠ¶æ€

æ—¶é—´çº¿å±•ç¤ºï¼š
T1: è®¢å•åˆ›å»º â†’ åº“å­˜æœªæ‰£å‡ âŒ ä¸ä¸€è‡´
T2: æ¶ˆæ¯å‘é€ â†’ åº“å­˜å¤„ç†ä¸­ â³ ä¸ä¸€è‡´  
T3: åº“å­˜æ‰£å‡ â†’ æ•°æ®ä¸€è‡´äº† âœ… æœ€ç»ˆä¸€è‡´

å…³é”®ç‚¹ï¼šå¼ºè°ƒ"æœ€ç»ˆ"è€Œé"å®æ—¶"
```

---

## 2. ğŸ”„ è¡¥å¿äº‹åŠ¡è¯¦è§£


### 2.1 è¡¥å¿äº‹åŠ¡çš„æœ¬è´¨


> ğŸ“– **æ ¸å¿ƒå®šä¹‰**  
> è¡¥å¿äº‹åŠ¡æ˜¯æŒ‡å½“åˆ†å¸ƒå¼äº‹åŠ¡å¤±è´¥æ—¶ï¼Œé€šè¿‡**æ‰§è¡Œä¸€ç³»åˆ—åå‘æ“ä½œ**æ¥æ’¤é”€å·²å®Œæˆçš„éƒ¨åˆ†æ“ä½œï¼Œä»è€Œä¿è¯æ•°æ®ä¸€è‡´æ€§

**ğŸ” ç”Ÿæ´»ç±»æ¯”**
```
å°±åƒç½‘è´­é€€è´§æµç¨‹ï¼š
1. ä¸‹å•ä»˜æ¬¾ âœ…         â†’ æ­£å‘æ“ä½œ
2. æ”¶åˆ°å•†å“å‘ç°é—®é¢˜    
3. ç”³è¯·é€€è´§ âœ…         â†’ è¡¥å¿æ“ä½œ
4. å•†å®¶é€€æ¬¾ âœ…         â†’ è¡¥å¿å®Œæˆ
5. æœ€ç»ˆçŠ¶æ€ï¼šé’±å›æ¥äº†ï¼Œå•†å“é€€äº†ï¼Œæ¢å¤åŸçŠ¶
```

### 2.2 è¡¥å¿äº‹åŠ¡çš„å·¥ä½œæµç¨‹


**ğŸ“Š æ ‡å‡†è¡¥å¿æµç¨‹**
```
æ­£å¸¸æµç¨‹ï¼š
æ­¥éª¤1 â”€â”€æˆåŠŸâ”€â”€> æ­¥éª¤2 â”€â”€æˆåŠŸâ”€â”€> æ­¥éª¤3 â”€â”€æˆåŠŸâ”€â”€> å®Œæˆ âœ…

å¼‚å¸¸æµç¨‹ï¼ˆæ­¥éª¤3å¤±è´¥ï¼‰ï¼š
æ­¥éª¤1 â”€â”€æˆåŠŸâ”€â”€> æ­¥éª¤2 â”€â”€æˆåŠŸâ”€â”€> æ­¥éª¤3 â”€â”€å¤±è´¥âŒ
  â†“                â†“                â†“
è¡¥å¿1 <â”€â”€è§¦å‘â”€â”€ è¡¥å¿2 <â”€â”€è§¦å‘â”€â”€ æ£€æµ‹å¤±è´¥
```

**ğŸ’¼ ç”µå•†ä¸‹å•å®Œæ•´ç¤ºä¾‹**
```
åœºæ™¯ï¼šç”¨æˆ·ä¸‹å•è´­ä¹°å•†å“

æ­£å‘æ“ä½œæµç¨‹ï¼š
â‘  åˆ›å»ºè®¢å•      â†’ è®¢å•æœåŠ¡
â‘¡ æ‰£å‡åº“å­˜      â†’ åº“å­˜æœåŠ¡  
â‘¢ æ‰£å‡ç§¯åˆ†      â†’ ç§¯åˆ†æœåŠ¡
â‘£ å‘é€é€šçŸ¥      â†’ é€šçŸ¥æœåŠ¡

å‡è®¾æ­¥éª¤â‘¢å¤±è´¥ï¼Œéœ€è¦è¡¥å¿ï¼š

è¡¥å¿æ“ä½œæµç¨‹ï¼š
â‘¢ ç§¯åˆ†æ‰£å‡å¤±è´¥ âŒ
   â†“
â‘¡ æ¢å¤åº“å­˜ âœ…   â†’ è°ƒç”¨åº“å­˜æœåŠ¡è¡¥å¿æ¥å£
   â†“
â‘  å–æ¶ˆè®¢å• âœ…   â†’ è°ƒç”¨è®¢å•æœåŠ¡è¡¥å¿æ¥å£
   â†“
æœ€ç»ˆï¼šæ‰€æœ‰æ“ä½œéƒ½å›æ»šï¼Œæ•°æ®æ¢å¤ä¸€è‡´
```

### 2.3 è¡¥å¿äº‹åŠ¡çš„è®¾è®¡è¦ç‚¹


**ğŸ¯ è®¾è®¡åŸåˆ™**

**åŸåˆ™1ï¼šæ¯ä¸ªæ“ä½œéƒ½è¦æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œ**
```
æ­£å‘æ“ä½œ              è¡¥å¿æ“ä½œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ‰£å‡åº“å­˜    <â”€â”€>      æ¢å¤åº“å­˜
æ‰£å‡ä½™é¢    <â”€â”€>      é€€è¿˜ä½™é¢
å‘é€ä¼˜æƒ åˆ¸  <â”€â”€>      æ’¤é”€ä¼˜æƒ åˆ¸
åˆ›å»ºè®¢å•    <â”€â”€>      å–æ¶ˆè®¢å•
```

**åŸåˆ™2ï¼šè¡¥å¿æ“ä½œå¿…é¡»æ˜¯å¹‚ç­‰çš„**
```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šéå¹‚ç­‰è¡¥å¿
public void compensateStock(String productId, int quantity) {
    // æ¯æ¬¡è°ƒç”¨éƒ½åŠ åº“å­˜ï¼Œé‡å¤è°ƒç”¨ä¼šå‡ºé”™
    stock += quantity;
}

// âœ… æ­£ç¡®ç¤ºä¾‹ï¼šå¹‚ç­‰è¡¥å¿
public void compensateStock(String orderId, String productId, int quantity) {
    // æ£€æŸ¥è¯¥è®¢å•æ˜¯å¦å·²ç»è¡¥å¿è¿‡
    if (!isCompensated(orderId)) {
        stock += quantity;
        markCompensated(orderId);  // è®°å½•å·²è¡¥å¿
    }
}
```

**åŸåˆ™3ï¼šè®°å½•å®Œæ•´çš„è¡¥å¿æ—¥å¿—**
```
è¡¥å¿æ—¥å¿—è¡¨ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•ID   â”‚ è¡¥å¿æ­¥éª¤    â”‚ è¡¥å¿æ—¶é—´  â”‚ è¡¥å¿çŠ¶æ€   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ O001     â”‚ æ¢å¤åº“å­˜    â”‚ 10:05:30 â”‚ æˆåŠŸ âœ…    â”‚
â”‚ O001     â”‚ å–æ¶ˆè®¢å•    â”‚ 10:05:31 â”‚ æˆåŠŸ âœ…    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½œç”¨ï¼š
ğŸ” è¿½è¸ªè¡¥å¿è¿›åº¦
ğŸ” é¿å…é‡å¤è¡¥å¿
ğŸ” é—®é¢˜æ’æŸ¥ä¾æ®
```

---

## 3. ğŸ“¨ æ¶ˆæ¯äº‹åŠ¡æœºåˆ¶


### 3.1 æ¶ˆæ¯äº‹åŠ¡æ˜¯ä»€ä¹ˆ


> ğŸ“– **æ ¸å¿ƒæ¦‚å¿µ**  
> æ¶ˆæ¯äº‹åŠ¡æ˜¯åˆ©ç”¨**æ¶ˆæ¯é˜Ÿåˆ—çš„ç‰¹æ€§**æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œé€šè¿‡**å¼‚æ­¥æ¶ˆæ¯**ä¿è¯å„ä¸ªæœåŠ¡æœ€ç»ˆå®Œæˆå„è‡ªçš„äº‹åŠ¡æ“ä½œ

**ğŸ” ç”Ÿæ´»ç±»æ¯”**
```
å°±åƒå¿«é€’é…é€ï¼š
ä½ ä¸‹å•åï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰â†’ ç³»ç»Ÿç”Ÿæˆå¿«é€’å•ï¼ˆæ¶ˆæ¯ï¼‰â†’ å¿«é€’å‘˜é…é€ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰

ç‰¹ç‚¹ï¼š
âœ… ä¸‹å•æˆåŠŸåï¼Œä½ ä¸ç”¨ç­‰å¿«é€’é€è¾¾
âœ… å¿«é€’å•ä¿è¯æœ€ç»ˆä¼šé€è¾¾
âœ… å³ä½¿é…é€å¤±è´¥ï¼Œä¼šé‡è¯•ç›´åˆ°æˆåŠŸ
```

### 3.2 æ¶ˆæ¯äº‹åŠ¡çš„å·¥ä½œåŸç†


**ğŸ“Š åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„äº‹åŠ¡æµç¨‹**
```
è®¢å•æœåŠ¡                æ¶ˆæ¯é˜Ÿåˆ—                åº“å­˜æœåŠ¡
   |                      |                      |
   |â”€â”€â‘ åˆ›å»ºè®¢å•(æœ¬åœ°äº‹åŠ¡)â”€>|                      |
   |                      |                      |
   |<â”€â‘¡å‘é€æ¶ˆæ¯(æˆåŠŸ)â”€â”€â”€â”€â”€â”€|                      |
   |                      |                      |
   |                      |â”€â”€â‘¢æ¨é€æ¶ˆæ¯(å¼‚æ­¥)â”€â”€â”€â”€>|
   |                      |                      |
   |                      |                      |â”€â”€â‘£æ‰£å‡åº“å­˜
   |                      |<â”€â‘¤ç¡®è®¤æ¶ˆè´¹â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€|
   |                      |                      |
```

**ğŸ’¡ å…³é”®è®¾è®¡ç‚¹**

**è®¾è®¡1ï¼šæœ¬åœ°äº‹åŠ¡ä¸æ¶ˆæ¯å‘é€ç»‘å®š**
```java
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(Order order) {
        // â‘  æœ¬åœ°æ•°æ®åº“æ“ä½œ
        orderDao.insert(order);
        
        // â‘¡ å‘é€æ¶ˆæ¯ï¼ˆåœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼‰
        // å¦‚æœæ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè®¢å•åˆ›å»ºä¹Ÿä¼šå›æ»š
        messageService.sendMessage("order-created", order);
        
        // è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥
    }
}
```

**è®¾è®¡2ï¼šæ¶ˆè´¹è€…å¹‚ç­‰å¤„ç†**
```java
@Service
public class StockService {
    
    // å¤„ç†è®¢å•åˆ›å»ºæ¶ˆæ¯
    public void handleOrderCreated(Order order) {
        // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡ï¼ˆé˜²æ­¢é‡å¤æ¶ˆè´¹ï¼‰
        if (isProcessed(order.getId())) {
            return;  // å·²å¤„ç†ï¼Œç›´æ¥è¿”å›
        }
        
        // æ‰£å‡åº“å­˜
        stockDao.decreaseStock(order.getProductId(), order.getQuantity());
        
        // è®°å½•å·²å¤„ç†
        markProcessed(order.getId());
    }
}
```

### 3.3 æ¶ˆæ¯äº‹åŠ¡çš„ä¼˜ç¼ºç‚¹


**âœ… ä¼˜åŠ¿åˆ†æ**
```
1ï¸âƒ£ é«˜æ€§èƒ½
è®¢å•æœåŠ¡å‘å®Œæ¶ˆæ¯å°±è¿”å›ï¼Œä¸ç­‰åº“å­˜å¤„ç†
ç”¨æˆ·ä½“éªŒå¥½ï¼Œå“åº”å¿«

2ï¸âƒ£ é«˜å¯ç”¨
åº“å­˜æœåŠ¡æš‚æ—¶å®•æœºï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¼šä¿ç•™æ¶ˆæ¯
æ¢å¤åç»§ç»­å¤„ç†ï¼Œä¸ä¸¢å¤±æ•°æ®

3ï¸âƒ£ è§£è€¦æ€§å¥½  
è®¢å•æœåŠ¡ä¸ç›´æ¥è°ƒç”¨åº“å­˜æœåŠ¡
é€šè¿‡æ¶ˆæ¯é€šä¿¡ï¼Œé™ä½æœåŠ¡é—´ä¾èµ–
```

**âŒ éœ€è¦æ³¨æ„çš„é—®é¢˜**
```
âš ï¸ æ¶ˆæ¯ä¸¢å¤±é£é™©
è§£å†³ï¼šä½¿ç”¨å¯é æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚RocketMQäº‹åŠ¡æ¶ˆæ¯ï¼‰

âš ï¸ æ¶ˆæ¯é‡å¤æ¶ˆè´¹
è§£å†³ï¼šæ¶ˆè´¹è€…å®ç°å¹‚ç­‰æ€§å¤„ç†

âš ï¸ æ¶ˆæ¯é¡ºåºé—®é¢˜
è§£å†³ï¼šä½¿ç”¨é¡ºåºæ¶ˆæ¯æˆ–ä¸šåŠ¡ä¸Šå®¹å¿ä¹±åº
```

---

## 4. ğŸ¯ äº‹åŠ¡æ¶ˆæ¯å®ç°


### 4.1 RocketMQäº‹åŠ¡æ¶ˆæ¯åŸç†


> ğŸ“– **æ ¸å¿ƒæ¦‚å¿µ**  
> RocketMQäº‹åŠ¡æ¶ˆæ¯æ˜¯ä¸€ç§**ä¿è¯æœ¬åœ°äº‹åŠ¡ä¸æ¶ˆæ¯å‘é€ä¸€è‡´æ€§**çš„æœºåˆ¶ï¼Œç¡®ä¿æ¶ˆæ¯è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½ä¸å‘é€

**ğŸ”„ äº‹åŠ¡æ¶ˆæ¯å®Œæ•´æµç¨‹**
```
ç”Ÿäº§è€…                    RocketMQ                æ¶ˆè´¹è€…
  |                         |                      |
  |â”€â”€â‘ å‘é€Halfæ¶ˆæ¯â”€â”€â”€â”€â”€â”€â”€â”€>|                      |
  |  (åŠæ¶ˆæ¯ï¼Œå¯¹æ¶ˆè´¹è€…ä¸å¯è§)|                      |
  |                         |                      |
  |â”€â”€â‘¡æ‰§è¡Œæœ¬åœ°äº‹åŠ¡â”€â”€â”€â”€â”€â”€â”€â”€â”€>|                      |
  |  (å¦‚ï¼šåˆ›å»ºè®¢å•)          |                      |
  |                         |                      |
  |<â”€â‘¢è¿”å›äº‹åŠ¡çŠ¶æ€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€|                      |
  |  (COMMIT/ROLLBACK)      |                      |
  |                         |                      |
  |                         |â”€â”€â‘£æäº¤/åˆ é™¤æ¶ˆæ¯â”€â”€â”€â”€>|
  |                         |  (æ ¹æ®äº‹åŠ¡çŠ¶æ€)      |
  |                         |                      |
  |                         |                      |â”€â”€â‘¤æ¶ˆè´¹æ¶ˆæ¯
```

**ğŸ’¡ ä¸‰ä¸ªå…³é”®æ­¥éª¤è¯¦è§£**

**æ­¥éª¤1ï¼šHalfæ¶ˆæ¯ï¼ˆå‡†å¤‡æ¶ˆæ¯ï¼‰**
```
ä½œç”¨ï¼šå…ˆå‘é€ä¸€ä¸ª"å‡†å¤‡"æ¶ˆæ¯åˆ°MQ
çŠ¶æ€ï¼šæ¶ˆè´¹è€…çœ‹ä¸åˆ°è¿™ä¸ªæ¶ˆæ¯
ç›®çš„ï¼šå ä½ï¼Œç­‰å¾…æœ¬åœ°äº‹åŠ¡ç»“æœ
```

**æ­¥éª¤2ï¼šæ‰§è¡Œæœ¬åœ°äº‹åŠ¡**
```
æœ¬åœ°äº‹åŠ¡æˆåŠŸ â†’ è¿”å›COMMIT   â†’ MQå°†æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…
æœ¬åœ°äº‹åŠ¡å¤±è´¥ â†’ è¿”å›ROLLBACK â†’ MQåˆ é™¤Halfæ¶ˆæ¯
```

**æ­¥éª¤3ï¼šäº‹åŠ¡å›æŸ¥ï¼ˆä¿åº•æœºåˆ¶ï¼‰**
```
å¦‚æœMQé•¿æ—¶é—´æœªæ”¶åˆ°äº‹åŠ¡çŠ¶æ€ï¼š
MQä¼šä¸»åŠ¨å›è°ƒç”Ÿäº§è€…ï¼Œè¯¢é—®äº‹åŠ¡çŠ¶æ€

ç”Ÿäº§è€…æŸ¥è¯¢æ•°æ®åº“ï¼š
- è®¢å•å­˜åœ¨ â†’ è¿”å›COMMIT
- è®¢å•ä¸å­˜åœ¨ â†’ è¿”å›ROLLBACK
```

### 4.2 ä»£ç å®ç°ç¤ºä¾‹


**ğŸ”§ RocketMQäº‹åŠ¡æ¶ˆæ¯å®Œæ•´å®ç°**

```java
@Service
public class OrderTransactionService {
    
    @Resource
    private TransactionMQProducer producer;
    
    @Resource
    private OrderDao orderDao;
    
    /**
     * å‘é€äº‹åŠ¡æ¶ˆæ¯åˆ›å»ºè®¢å•
     */
    public void createOrderWithTransaction(Order order) {
        // æ„å»ºæ¶ˆæ¯
        Message msg = new Message(
            "order-topic",           // ä¸»é¢˜
            "order-create",          // æ ‡ç­¾
            order.getId(),           // æ¶ˆæ¯key
            JSON.toJSONString(order).getBytes()  // æ¶ˆæ¯ä½“
        );
        
        // å‘é€äº‹åŠ¡æ¶ˆæ¯
        producer.sendMessageInTransaction(msg, order);
    }
    
    /**
     * æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå™¨
     */
    @Component
    class OrderTransactionListener implements TransactionListener {
        
        // æ­¥éª¤2ï¼šæ‰§è¡Œæœ¬åœ°äº‹åŠ¡
        @Override
        public LocalTransactionState executeLocalTransaction(Message msg, Object arg) {
            Order order = (Order) arg;
            try {
                // æ‰§è¡Œæœ¬åœ°æ•°æ®åº“æ“ä½œ
                orderDao.insert(order);
                
                // æœ¬åœ°äº‹åŠ¡æˆåŠŸï¼Œæäº¤æ¶ˆæ¯
                return LocalTransactionState.COMMIT_MESSAGE;
                
            } catch (Exception e) {
                // æœ¬åœ°äº‹åŠ¡å¤±è´¥ï¼Œå›æ»šæ¶ˆæ¯
                return LocalTransactionState.ROLLBACK_MESSAGE;
            }
        }
        
        // æ­¥éª¤3ï¼šäº‹åŠ¡å›æŸ¥ï¼ˆMQä¸»åŠ¨è¯¢é—®ï¼‰
        @Override
        public LocalTransactionState checkLocalTransaction(MessageExt msg) {
            String orderId = msg.getKeys();
            
            // æŸ¥è¯¢æ•°æ®åº“ï¼Œæ£€æŸ¥è®¢å•æ˜¯å¦å­˜åœ¨
            Order order = orderDao.findById(orderId);
            
            if (order != null) {
                return LocalTransactionState.COMMIT_MESSAGE;  // è®¢å•å­˜åœ¨ï¼Œæäº¤
            } else {
                return LocalTransactionState.ROLLBACK_MESSAGE; // è®¢å•ä¸å­˜åœ¨ï¼Œå›æ»š
            }
        }
    }
}
```

**ğŸ“ æ¶ˆè´¹è€…ç«¯å®ç°**

```java
@Service
public class StockConsumer {
    
    @Resource
    private StockDao stockDao;
    
    @Resource
    private ProcessRecordDao recordDao;
    
    /**
     * ç›‘å¬è®¢å•åˆ›å»ºæ¶ˆæ¯
     */
    @RocketMQMessageListener(
        topic = "order-topic",
        consumerGroup = "stock-consumer-group"
    )
    public class OrderMessageListener implements RocketMQListener<String> {
        
        @Override
        public void onMessage(String message) {
            Order order = JSON.parseObject(message, Order.class);
            
            // å¹‚ç­‰æ€§æ£€æŸ¥ï¼šé¿å…é‡å¤æ¶ˆè´¹
            if (recordDao.exists(order.getId())) {
                return;  // å·²å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
            }
            
            try {
                // æ‰£å‡åº“å­˜
                stockDao.decreaseStock(
                    order.getProductId(), 
                    order.getQuantity()
                );
                
                // è®°å½•å¤„ç†çŠ¶æ€
                recordDao.save(order.getId(), "SUCCESS");
                
            } catch (Exception e) {
                // å¤„ç†å¤±è´¥ï¼Œæ¶ˆæ¯ä¼šé‡æ–°æŠ•é€’
                throw new RuntimeException("åº“å­˜æ‰£å‡å¤±è´¥", e);
            }
        }
    }
}
```

### 4.3 äº‹åŠ¡æ¶ˆæ¯çš„åº”ç”¨åœºæ™¯


**ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯**

**åœºæ™¯1ï¼šè®¢å•ç³»ç»Ÿ**
```
ç”¨æˆ·ä¸‹å•æµç¨‹ï¼š
â‘  è®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
â‘¡ å‘é€æ¶ˆæ¯ï¼šé€šçŸ¥å…¶ä»–ç³»ç»Ÿ
â‘¢ åº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜ï¼ˆå¼‚æ­¥ï¼‰
â‘£ ç§¯åˆ†æœåŠ¡ï¼šæ‰£å‡ç§¯åˆ†ï¼ˆå¼‚æ­¥ï¼‰
â‘¤ é€šçŸ¥æœåŠ¡ï¼šå‘é€çŸ­ä¿¡ï¼ˆå¼‚æ­¥ï¼‰

ä¼˜åŠ¿ï¼š
âœ… è®¢å•åˆ›å»ºå¿«é€Ÿè¿”å›
âœ… åç»­æ“ä½œå¼‚æ­¥å¤„ç†
âœ… ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
```

**åœºæ™¯2ï¼šæ”¯ä»˜å›è°ƒ**
```
æ”¯ä»˜æˆåŠŸæµç¨‹ï¼š
â‘  æ”¯ä»˜æœåŠ¡ï¼šæ›´æ–°æ”¯ä»˜çŠ¶æ€ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
â‘¡ å‘é€æ¶ˆæ¯ï¼šæ”¯ä»˜æˆåŠŸé€šçŸ¥
â‘¢ è®¢å•æœåŠ¡ï¼šæ›´æ–°è®¢å•çŠ¶æ€ï¼ˆå¼‚æ­¥ï¼‰
â‘£ ä¼šå‘˜æœåŠ¡ï¼šå¢åŠ ç§¯åˆ†ï¼ˆå¼‚æ­¥ï¼‰
â‘¤ è¥é”€æœåŠ¡ï¼šå‘æ”¾ä¼˜æƒ åˆ¸ï¼ˆå¼‚æ­¥ï¼‰
```

---

## 5. ğŸ› ï¸ è¡¥å¿æœºåˆ¶è®¾è®¡


### 5.1 è¡¥å¿æœºåˆ¶çš„è®¾è®¡åŸåˆ™


**ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™**

**åŸåˆ™1ï¼šå¯è¡¥å¿æ€§è®¾è®¡**
```
æ¯ä¸ªä¸šåŠ¡æ“ä½œéƒ½è¦è€ƒè™‘ï¼š
â“ å¦‚æœå¤±è´¥äº†ï¼Œæ€ä¹ˆæ’¤é”€ï¼Ÿ
â“ è¡¥å¿æ“ä½œæ˜¯å¦ä¼šå½±å“å…¶ä»–æ•°æ®ï¼Ÿ
â“ è¡¥å¿æ˜¯å¦æœ‰å‰¯ä½œç”¨ï¼Ÿ

ç¤ºä¾‹ï¼šæ‰£å‡åº“å­˜
æ­£å‘ï¼šstock = stock - quantity
è¡¥å¿ï¼šstock = stock + quantity
è€ƒè™‘ï¼šæ˜¯å¦ä¼šè¶…è¿‡æœ€å¤§åº“å­˜é™åˆ¶ï¼Ÿ
```

**åŸåˆ™2ï¼šè¡¥å¿çš„å¹‚ç­‰æ€§**
```
ğŸ’¡ **å¹‚ç­‰æ€§å«ä¹‰**ï¼šåŒä¸€ä¸ªè¡¥å¿æ“ä½œæ‰§è¡Œå¤šæ¬¡ï¼Œç»“æœä¸æ‰§è¡Œä¸€æ¬¡ç›¸åŒ

å®ç°æ–¹å¼ï¼š
æ–¹å¼1ï¼šè®°å½•è¡¥å¿çŠ¶æ€
- è¡¥å¿å‰æ£€æŸ¥æ˜¯å¦å·²è¡¥å¿
- è¡¥å¿åè®°å½•è¡¥å¿æ ‡è®°

æ–¹å¼2ï¼šä½¿ç”¨å”¯ä¸€é”®
- åŸºäºä¸šåŠ¡IDå»é‡
- æ•°æ®åº“å”¯ä¸€ç´¢å¼•çº¦æŸ
```

**åŸåˆ™3ï¼šè¡¥å¿çš„å¯é æ€§**
```
ä¿éšœæªæ–½ï¼š
âœ… è¡¥å¿å¤±è´¥è¦é‡è¯•
âœ… é‡è¯•æ¬¡æ•°æœ‰ä¸Šé™
âœ… è¶…è¿‡æ¬¡æ•°äººå·¥ä»‹å…¥
âœ… å®Œæ•´çš„æ—¥å¿—è®°å½•
```

### 5.2 è¡¥å¿æœºåˆ¶çš„å®ç°æ–¹æ¡ˆ


**ğŸ“‹ æ–¹æ¡ˆ1ï¼šåŸºäºçŠ¶æ€æœºçš„è¡¥å¿**

```java
/**
 * è®¢å•çŠ¶æ€æœºè¡¥å¿å®ç°
 */
@Service
public class OrderCompensationService {
    
    @Resource
    private OrderDao orderDao;
    
    /**
     * è¡¥å¿è®¢å•
     */
    @Transactional
    public void compensateOrder(String orderId) {
        Order order = orderDao.findById(orderId);
        
        // æ ¹æ®å½“å‰çŠ¶æ€å†³å®šè¡¥å¿åŠ¨ä½œ
        switch (order.getStatus()) {
            case "CREATED":
                // è®¢å•åˆšåˆ›å»ºï¼Œç›´æ¥å–æ¶ˆ
                cancelOrder(orderId);
                break;
                
            case "PAID":
                // å·²æ”¯ä»˜ï¼Œéœ€è¦é€€æ¬¾
                refundOrder(orderId);
                break;
                
            case "SHIPPED":
                // å·²å‘è´§ï¼Œéœ€è¦é€€è´§æµç¨‹
                returnOrder(orderId);
                break;
                
            default:
                throw new IllegalStateException("æ— æ³•è¡¥å¿çŠ¶æ€: " + order.getStatus());
        }
    }
    
    // çŠ¶æ€æµè½¬è®°å½•
    private void recordStateChange(String orderId, String fromState, String toState) {
        // è®°å½•çŠ¶æ€å˜æ›´å†å²ï¼Œä¾¿äºè¿½è¸ª
    }
}
```

**ğŸ“‹ æ–¹æ¡ˆ2ï¼šSagaè¡¥å¿æ¨¡å¼**

```
Sagaæ¨¡å¼æµç¨‹å›¾ï¼š
                æ­£å‘æ‰§è¡Œ
æœåŠ¡A â”€â”€æˆåŠŸâ”€â”€> æœåŠ¡B â”€â”€æˆåŠŸâ”€â”€> æœåŠ¡C â”€â”€æˆåŠŸâ”€â”€> å®Œæˆâœ…
  |              |              |
  â†“å¤±è´¥          â†“å¤±è´¥          â†“å¤±è´¥
è¡¥å¿A <â”€â”€è§¦å‘â”€â”€ è¡¥å¿B <â”€â”€è§¦å‘â”€â”€ è¡¥å¿C
  |              |              |
  â†“              â†“              â†“
å›æ»šå®Œæˆâœ…      å›æ»šå®Œæˆâœ…      å›æ»šå®Œæˆâœ…
```

```java
/**
 * Sagaåè°ƒå™¨å®ç°
 */
@Service
public class SagaCoordinator {
    
    private List<SagaStep> steps = new ArrayList<>();
    
    /**
     * æ·»åŠ Sagaæ­¥éª¤
     */
    public void addStep(SagaStep step) {
        steps.add(step);
    }
    
    /**
     * æ‰§è¡ŒSagaäº‹åŠ¡
     */
    public void execute() {
        List<SagaStep> completedSteps = new ArrayList<>();
        
        try {
            // ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªæ­¥éª¤
            for (SagaStep step : steps) {
                step.execute();
                completedSteps.add(step);
            }
            
        } catch (Exception e) {
            // å‘ç”Ÿå¼‚å¸¸ï¼Œåå‘è¡¥å¿
            Collections.reverse(completedSteps);
            
            for (SagaStep step : completedSteps) {
                try {
                    step.compensate();  // æ‰§è¡Œè¡¥å¿
                } catch (Exception ce) {
                    // è¡¥å¿å¤±è´¥ï¼Œè®°å½•æ—¥å¿—ï¼Œäººå·¥å¤„ç†
                    logCompensationFailure(step, ce);
                }
            }
        }
    }
}

/**
 * Sagaæ­¥éª¤æ¥å£
 */
interface SagaStep {
    void execute() throws Exception;      // æ­£å‘æ“ä½œ
    void compensate() throws Exception;   // è¡¥å¿æ“ä½œ
}
```

### 5.3 è¡¥å¿ä»»åŠ¡çš„è°ƒåº¦


**â° å®šæ—¶è¡¥å¿ä»»åŠ¡**

```java
/**
 * è¡¥å¿ä»»åŠ¡è°ƒåº¦å™¨
 */
@Component
public class CompensationScheduler {
    
    @Resource
    private CompensationRecordDao recordDao;
    
    /**
     * æ¯5åˆ†é’Ÿæ‰«æä¸€æ¬¡éœ€è¦è¡¥å¿çš„è®°å½•
     */
    @Scheduled(fixedRate = 300000)
    public void scanAndCompensate() {
        // æŸ¥è¯¢éœ€è¦è¡¥å¿çš„è®°å½•
        List<CompensationRecord> records = recordDao.findPendingRecords();
        
        for (CompensationRecord record : records) {
            // æ£€æŸ¥é‡è¯•æ¬¡æ•°
            if (record.getRetryCount() >= 3) {
                // è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œæ ‡è®°ä¸ºäººå·¥å¤„ç†
                record.setStatus("MANUAL");
                recordDao.update(record);
                continue;
            }
            
            try {
                // æ‰§è¡Œè¡¥å¿
                executeCompensation(record);
                
                // è¡¥å¿æˆåŠŸ
                record.setStatus("SUCCESS");
                recordDao.update(record);
                
            } catch (Exception e) {
                // è¡¥å¿å¤±è´¥ï¼Œå¢åŠ é‡è¯•æ¬¡æ•°
                record.setRetryCount(record.getRetryCount() + 1);
                recordDao.update(record);
            }
        }
    }
}
```

---

## 6. ğŸ’¼ ä¸šåŠ¡è¡¥å¿å®è·µ


### 6.1 ç”µå•†è®¢å•è¡¥å¿å®æˆ˜


**ğŸ“¦ å®Œæ•´çš„è®¢å•è¡¥å¿æµç¨‹**

```
è®¢å•åˆ›å»ºæµç¨‹ï¼š
ç”¨æˆ·ä¸‹å• â†’ åˆ›å»ºè®¢å• â†’ æ‰£åº“å­˜ â†’ æ‰£ç§¯åˆ† â†’ å‘é€šçŸ¥
   â†“         âœ…         âœ…        âŒ       â¸ï¸
 æ”¯ä»˜     è®¢å•å·²åˆ›å»º   åº“å­˜å·²æ‰£   å¤±è´¥    æœªæ‰§è¡Œ

è¡¥å¿æµç¨‹ï¼ˆç§¯åˆ†æ‰£å‡å¤±è´¥ï¼‰ï¼š
æ£€æµ‹å¤±è´¥ â†’ æ¢å¤åº“å­˜ â†’ å–æ¶ˆè®¢å• â†’ é€šçŸ¥ç”¨æˆ·
           âœ…         âœ…         âœ…
```

**ğŸ”§ è®¢å•è¡¥å¿å®Œæ•´ä»£ç **

```java
@Service
public class OrderCompensationHandler {
    
    @Resource
    private OrderService orderService;
    
    @Resource
    private StockService stockService;
    
    @Resource
    private PointService pointService;
    
    /**
     * å¤„ç†è®¢å•è¡¥å¿
     */
    public void handleOrderCompensation(String orderId) {
        Order order = orderService.getOrder(orderId);
        
        // è¡¥å¿è®°å½•ï¼ˆç”¨äºå¹‚ç­‰æ€§ï¼‰
        CompensationRecord record = new CompensationRecord();
        record.setOrderId(orderId);
        record.setStartTime(new Date());
        
        try {
            // æ­¥éª¤1ï¼šæ¢å¤åº“å­˜
            if (order.isStockDeducted()) {
                stockService.restoreStock(
                    orderId,  // å¹‚ç­‰é”®
                    order.getProductId(),
                    order.getQuantity()
                );
                record.addStep("æ¢å¤åº“å­˜æˆåŠŸ");
            }
            
            // æ­¥éª¤2ï¼šæ¢å¤ç§¯åˆ†ï¼ˆå¦‚æœå·²æ‰£ï¼‰
            if (order.isPointDeducted()) {
                pointService.restorePoint(
                    orderId,  // å¹‚ç­‰é”®
                    order.getUserId(),
                    order.getPointUsed()
                );
                record.addStep("æ¢å¤ç§¯åˆ†æˆåŠŸ");
            }
            
            // æ­¥éª¤3ï¼šå–æ¶ˆè®¢å•
            orderService.cancelOrder(orderId);
            record.addStep("å–æ¶ˆè®¢å•æˆåŠŸ");
            
            // æ­¥éª¤4ï¼šé€šçŸ¥ç”¨æˆ·
            notifyUser(order.getUserId(), "è®¢å•å·²å–æ¶ˆï¼Œåº“å­˜å’Œç§¯åˆ†å·²é€€è¿˜");
            record.addStep("ç”¨æˆ·é€šçŸ¥æˆåŠŸ");
            
            record.setStatus("SUCCESS");
            
        } catch (Exception e) {
            record.setStatus("FAILED");
            record.setErrorMsg(e.getMessage());
            
            // è®°å½•å¤±è´¥ï¼Œç­‰å¾…é‡è¯•
            throw new CompensationException("è¡¥å¿å¤±è´¥", e);
            
        } finally {
            record.setEndTime(new Date());
            saveCompensationRecord(record);
        }
    }
}
```

### 6.2 æ”¯ä»˜è¡¥å¿å®æˆ˜


**ğŸ’° æ”¯ä»˜å¼‚å¸¸è¡¥å¿åœºæ™¯**

```
åœºæ™¯ï¼šç”¨æˆ·æ”¯ä»˜æˆåŠŸï¼Œä½†ä¸šåŠ¡å¤„ç†å¤±è´¥

æ­£å¸¸æµç¨‹ï¼š
æ”¯ä»˜æˆåŠŸ â†’ æ›´æ–°è®¢å• â†’ å‘è´§ â†’ å®Œæˆ
   âœ…        âŒ       â¸ï¸    â¸ï¸

è¡¥å¿æµç¨‹ï¼š
æ£€æµ‹å¤±è´¥ â†’ åŸè·¯é€€æ¬¾ â†’ å–æ¶ˆè®¢å• â†’ é€šçŸ¥ç”¨æˆ·
```

**ğŸ”§ æ”¯ä»˜è¡¥å¿å®ç°**

```java
@Service
public class PaymentCompensationService {
    
    /**
     * æ”¯ä»˜è¡¥å¿ï¼šé€€æ¬¾
     */
    @Transactional
    public void refundPayment(String orderId) {
        Order order = orderDao.findById(orderId);
        Payment payment = paymentDao.findByOrderId(orderId);
        
        // é˜²é‡å¤é€€æ¬¾æ£€æŸ¥
        if (payment.getStatus().equals("REFUNDED")) {
            return;  // å·²é€€æ¬¾ï¼Œç›´æ¥è¿”å›
        }
        
        try {
            // è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜é€€æ¬¾æ¥å£
            RefundResult result = paymentGateway.refund(
                payment.getPaymentId(),
                payment.getAmount()
            );
            
            if (result.isSuccess()) {
                // æ›´æ–°é€€æ¬¾çŠ¶æ€
                payment.setStatus("REFUNDED");
                payment.setRefundTime(new Date());
                paymentDao.update(payment);
                
                // æ›´æ–°è®¢å•çŠ¶æ€
                order.setStatus("REFUNDED");
                orderDao.update(order);
                
                // å‘é€é€€æ¬¾é€šçŸ¥
                sendRefundNotification(order.getUserId(), payment.getAmount());
            }
            
        } catch (Exception e) {
            // é€€æ¬¾å¤±è´¥ï¼Œè®°å½•æ—¥å¿—
            logRefundFailure(orderId, e);
            
            // åŠ å…¥è¡¥å¿é˜Ÿåˆ—ï¼Œç­‰å¾…é‡è¯•
            addToCompensationQueue(orderId);
        }
    }
}
```

### 6.3 è¡¥å¿ç›‘æ§ä¸å‘Šè­¦


**ğŸ“Š è¡¥å¿çŠ¶æ€ç›‘æ§**

```java
/**
 * è¡¥å¿ç›‘æ§æœåŠ¡
 */
@Service
public class CompensationMonitor {
    
    /**
     * ç»Ÿè®¡è¡¥å¿æ•°æ®
     */
    public CompensationMetrics getMetrics(Date startDate, Date endDate) {
        CompensationMetrics metrics = new CompensationMetrics();
        
        // æ€»è¡¥å¿æ¬¡æ•°
        int total = recordDao.countByDateRange(startDate, endDate);
        
        // æˆåŠŸæ¬¡æ•°
        int success = recordDao.countByStatus("SUCCESS", startDate, endDate);
        
        // å¤±è´¥æ¬¡æ•°
        int failed = recordDao.countByStatus("FAILED", startDate, endDate);
        
        // äººå·¥å¤„ç†æ¬¡æ•°
        int manual = recordDao.countByStatus("MANUAL", startDate, endDate);
        
        metrics.setTotal(total);
        metrics.setSuccess(success);
        metrics.setFailed(failed);
        metrics.setManual(manual);
        metrics.setSuccessRate((double) success / total * 100);
        
        return metrics;
    }
    
    /**
     * æ£€æŸ¥å¼‚å¸¸å¹¶å‘Šè­¦
     */
    @Scheduled(fixedRate = 60000)  // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkAndAlert() {
        // æŸ¥è¯¢æœ€è¿‘1å°æ—¶çš„è¡¥å¿å¤±è´¥ç‡
        CompensationMetrics metrics = getMetrics(
            DateUtils.addHours(new Date(), -1),
            new Date()
        );
        
        // å¤±è´¥ç‡è¶…è¿‡10%ï¼Œå‘é€å‘Šè­¦
        if (metrics.getSuccessRate() < 90) {
            sendAlert("è¡¥å¿å¤±è´¥ç‡è¿‡é«˜: " + (100 - metrics.getSuccessRate()) + "%");
        }
        
        // äººå·¥å¤„ç†æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼Œå‘é€å‘Šè­¦
        if (metrics.getManual() > 10) {
            sendAlert("å¾…äººå·¥å¤„ç†çš„è¡¥å¿ä»»åŠ¡è¿‡å¤š: " + metrics.getManual() + "ä¸ª");
        }
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 æŸ”æ€§äº‹åŠ¡æ ¸å¿ƒç†å¿µ


```
ğŸ¯ **è®°å¿†è¦ç‚¹**

æŸ”æ€§äº‹åŠ¡ = æœ€ç»ˆä¸€è‡´æ€§
- ä¸è¿½æ±‚å®æ—¶ä¸€è‡´ï¼Œå…è®¸çŸ­æš‚ä¸ä¸€è‡´
- é€šè¿‡è¡¥å¿æœºåˆ¶ä¿è¯æœ€ç»ˆæ­£ç¡®
- é€‚åˆåˆ†å¸ƒå¼ã€é«˜å¹¶å‘åœºæ™¯

BASEç†è®ºï¼š
â”œâ”€ BAï¼ˆåŸºæœ¬å¯ç”¨ï¼‰ï¼šæ ¸å¿ƒåŠŸèƒ½å¯ç”¨ï¼Œå…è®¸é™çº§
â”œâ”€ Sï¼ˆè½¯çŠ¶æ€ï¼‰ï¼šå…è®¸ä¸­é—´æ€ï¼Œæ•°æ®å¯æš‚æ—¶ä¸ä¸€è‡´  
â””â”€ Eï¼ˆæœ€ç»ˆä¸€è‡´ï¼‰ï¼šç»è¿‡ä¸€æ®µæ—¶é—´åè¾¾åˆ°ä¸€è‡´
```

### 7.2 è¡¥å¿äº‹åŠ¡è®¾è®¡ç²¾è¦


```
ğŸ”§ **è®¾è®¡ä¸‰åŸåˆ™**

1ï¸âƒ£ å¯è¡¥å¿æ€§
æ¯ä¸ªæ“ä½œå¿…é¡»æœ‰å¯¹åº”çš„é€†æ“ä½œ
æ‰£å‡ â†â†’ æ¢å¤
åˆ›å»º â†â†’ åˆ é™¤

2ï¸âƒ£ å¹‚ç­‰æ€§  
è¡¥å¿æ“ä½œé‡å¤æ‰§è¡Œç»“æœç›¸åŒ
é€šè¿‡å”¯ä¸€é”®æˆ–çŠ¶æ€æ ‡è®°å®ç°

3ï¸âƒ£ å¯é æ€§
è¡¥å¿å¤±è´¥è¦é‡è¯•
è¶…è¿‡æ¬¡æ•°äººå·¥ä»‹å…¥
å®Œæ•´æ—¥å¿—è®°å½•
```

### 7.3 æ¶ˆæ¯äº‹åŠ¡å…³é”®ç‚¹


```
ğŸ“¨ **RocketMQäº‹åŠ¡æ¶ˆæ¯æµç¨‹**

å‘é€Halfæ¶ˆæ¯ â†’ æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ â†’ æäº¤/å›æ»šæ¶ˆæ¯
                    â†“
                æˆåŠŸ/å¤±è´¥
                    â†“
            COMMIT/ROLLBACK
                    â†“
            æ¶ˆè´¹è€…æ”¶åˆ°/æ¶ˆæ¯åˆ é™¤

å…³é”®æœºåˆ¶ï¼š
âœ… äº‹åŠ¡å›æŸ¥ï¼šMQä¸»åŠ¨è¯¢é—®äº‹åŠ¡çŠ¶æ€
âœ… å¹‚ç­‰æ¶ˆè´¹ï¼šæ¶ˆè´¹è€…é˜²æ­¢é‡å¤å¤„ç†
âœ… å¼‚æ­¥è§£è€¦ï¼šæé«˜ç³»ç»Ÿæ€§èƒ½å’Œå¯ç”¨æ€§
```

### 7.4 å®è·µåº”ç”¨è¦ç‚¹


```
ğŸ’¼ **ä¸šåŠ¡è¡¥å¿å®æˆ˜å»ºè®®**

è®¢å•åœºæ™¯ï¼š
æ­¥éª¤1ï¼šæ¢å¤åº“å­˜ï¼ˆæ£€æŸ¥æ˜¯å¦å·²æ‰£å‡ï¼‰
æ­¥éª¤2ï¼šæ¢å¤ç§¯åˆ†ï¼ˆæ£€æŸ¥æ˜¯å¦å·²æ‰£å‡ï¼‰
æ­¥éª¤3ï¼šå–æ¶ˆè®¢å•ï¼ˆæ›´æ–°çŠ¶æ€ï¼‰
æ­¥éª¤4ï¼šé€šçŸ¥ç”¨æˆ·ï¼ˆå‘é€æ¶ˆæ¯ï¼‰

æ”¯ä»˜åœºæ™¯ï¼š
æ­¥éª¤1ï¼šè°ƒç”¨é€€æ¬¾æ¥å£ï¼ˆé˜²é‡å¤é€€æ¬¾ï¼‰
æ­¥éª¤2ï¼šæ›´æ–°æ”¯ä»˜çŠ¶æ€ï¼ˆè®°å½•é€€æ¬¾ï¼‰
æ­¥éª¤3ï¼šæ›´æ–°è®¢å•çŠ¶æ€ï¼ˆè®¢å•å·²é€€æ¬¾ï¼‰
æ­¥éª¤4ï¼šé€šçŸ¥ç”¨æˆ·ï¼ˆé€€æ¬¾æˆåŠŸï¼‰

ç›‘æ§å‘Šè­¦ï¼š
ğŸ” è¡¥å¿æˆåŠŸç‡ < 90% â†’ å‘Šè­¦
ğŸ” äººå·¥å¤„ç†æ•°é‡ > 10 â†’ å‘Šè­¦
ğŸ” è¡¥å¿è€—æ—¶ > 5åˆ†é’Ÿ â†’ å‘Šè­¦
```

### 7.5 æŠ€æœ¯é€‰å‹å»ºè®®


```
ğŸ“Š **æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©**

â”‚ åœºæ™¯ç‰¹ç‚¹           â”‚ æ¨èæ–¹æ¡ˆ        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¼ºä¸€è‡´æ€§è¦æ±‚é«˜      â”‚ 2PC/3PC        â”‚
â”‚ æ€§èƒ½è¦æ±‚é«˜          â”‚ æ¶ˆæ¯äº‹åŠ¡       â”‚
â”‚ ä¸šåŠ¡å¤æ‚åº¦é«˜        â”‚ Sagaè¡¥å¿       â”‚
â”‚ æœåŠ¡è°ƒç”¨é“¾é•¿        â”‚ TCCäº‹åŠ¡        â”‚
â”‚ æœ€ç»ˆä¸€è‡´æ€§å¯æ¥å—    â”‚ æŸ”æ€§äº‹åŠ¡       â”‚

é€‰æ‹©åŸåˆ™ï¼š
âœ… ä¼˜å…ˆè€ƒè™‘ä¸šåŠ¡ç‰¹æ€§
âœ… å¹³è¡¡æ€§èƒ½ä¸ä¸€è‡´æ€§
âœ… è€ƒè™‘å›¢é˜ŸæŠ€æœ¯æ ˆ
âœ… è¯„ä¼°ç»´æŠ¤æˆæœ¬
```

**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**
```
æŸ”æ€§äº‹åŠ¡ä¸‰è¦ç´ ï¼ŒBASEç†è®ºæ˜¯åŸºç¡€
è¡¥å¿æ“ä½œè¦å¹‚ç­‰ï¼ŒçŠ¶æ€è®°å½•ä¸èƒ½å°‘
æ¶ˆæ¯äº‹åŠ¡ä¿æœ€ç»ˆï¼Œå¼‚æ­¥å¤„ç†æ€§èƒ½é«˜
ç›‘æ§å‘Šè­¦è¦å®Œå–„ï¼Œäººå·¥ä»‹å…¥æ˜¯ä¿éšœ
```