---
title: 30ã€åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼äº‹åŠ¡åŸºç¡€æ¦‚å¿µ](#1-åˆ†å¸ƒå¼äº‹åŠ¡åŸºç¡€æ¦‚å¿µ)
2. [Seataåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶](#2-Seataåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶)
3. [TCCè¡¥å¿æ¨¡å¼](#3-TCCè¡¥å¿æ¨¡å¼)
4. [Sagaäº‹åŠ¡æ¨¡å¼](#4-Sagaäº‹åŠ¡æ¨¡å¼)
5. [æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆ](#5-æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆ)
6. [æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡](#6-æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡)
7. [æœ€å¤§åŠªåŠ›é€šçŸ¥](#7-æœ€å¤§åŠªåŠ›é€šçŸ¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ åˆ†å¸ƒå¼äº‹åŠ¡åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> æƒ³è±¡ä½ åœ¨ç½‘ä¸Šä¹°ä¸œè¥¿ï¼šä½ çš„è´¦æˆ·æ‰£é’±ï¼ˆé“¶è¡Œç³»ç»Ÿï¼‰ã€å•†å®¶æ”¶é’±ï¼ˆæ”¯ä»˜ç³»ç»Ÿï¼‰ã€åº“å­˜å‡å°‘ï¼ˆä»“å‚¨ç³»ç»Ÿï¼‰ã€‚è¿™ä¸‰ä¸ªæ“ä½œå¿…é¡»åŒæ—¶æˆåŠŸæˆ–åŒæ—¶å¤±è´¥ï¼Œä½†å®ƒä»¬è¿è¡Œåœ¨ä¸åŒçš„ç³»ç»Ÿä¸Šâ€”â€”è¿™å°±æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
```
åˆ†å¸ƒå¼äº‹åŠ¡ï¼šæ¶‰åŠå¤šä¸ªç‹¬ç«‹æ•°æ®åº“æˆ–æœåŠ¡çš„äº‹åŠ¡æ“ä½œ
æœ¬è´¨ï¼šç¡®ä¿è·¨å¤šä¸ªç³»ç»Ÿçš„æ•°æ®ä¸€è‡´æ€§
æŒ‘æˆ˜ï¼šä¸åŒç³»ç»Ÿä¹‹é—´å¦‚ä½•åè°ƒï¼Œä¿è¯è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡


**ä¸šåŠ¡åœºæ™¯ç¤ºä¾‹**

```
ç”µå•†ä¸‹å•æµç¨‹ï¼š
ç”¨æˆ·æœåŠ¡(MySQL)  â†’  æ‰£å‡è´¦æˆ·ä½™é¢
è®¢å•æœåŠ¡(MySQL)  â†’  åˆ›å»ºè®¢å•è®°å½•  
åº“å­˜æœåŠ¡(MySQL)  â†’  å‡å°‘å•†å“åº“å­˜
ç§¯åˆ†æœåŠ¡(Redis)  â†’  å¢åŠ ç”¨æˆ·ç§¯åˆ†

é—®é¢˜ï¼šå¦‚æœåº“å­˜æ‰£å‡å¤±è´¥ï¼Œå‰é¢çš„æ‰£æ¬¾å’Œè®¢å•æ€ä¹ˆåŠï¼Ÿ
```

**ä¼ ç»Ÿå•ä½“åº”ç”¨ vs åˆ†å¸ƒå¼ç³»ç»Ÿ**

```
å•ä½“åº”ç”¨ï¼š                    åˆ†å¸ƒå¼ç³»ç»Ÿï¼š
    æ•°æ®åº“                    æ•°æ®åº“A   æ•°æ®åº“B   æ•°æ®åº“C
      |                         |         |         |
   æœ¬åœ°äº‹åŠ¡                   æœåŠ¡A     æœåŠ¡B     æœåŠ¡C
  (ACIDä¿è¯)                (å¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼Ÿ)
```

### 1.3 åˆ†å¸ƒå¼äº‹åŠ¡çš„éš¾ç‚¹


**ğŸš¨ æ ¸å¿ƒæŒ‘æˆ˜**

| æŒ‘æˆ˜ | è¯´æ˜ | å½±å“ |
|------|------|------|
| **ç½‘ç»œä¸å¯é ** | æœåŠ¡é—´é€šä¿¡å¯èƒ½å¤±è´¥ã€è¶…æ—¶ | æ— æ³•ç¡®å®šæ“ä½œæ˜¯å¦æ‰§è¡Œ |
| **éƒ¨åˆ†å¤±è´¥** | æŸäº›æœåŠ¡æˆåŠŸï¼ŒæŸäº›å¤±è´¥ | æ•°æ®ä¸ä¸€è‡´ |
| **æ€§èƒ½å¼€é”€** | åè°ƒæœºåˆ¶å¢åŠ å“åº”æ—¶é—´ | ç”¨æˆ·ä½“éªŒä¸‹é™ |
| **å¤æ‚æ€§é«˜** | éœ€è¦è€ƒè™‘å„ç§å¼‚å¸¸æƒ…å†µ | å¼€å‘ç»´æŠ¤å›°éš¾ |

**ğŸ’¡ CAPç†è®º**
```
åˆ†å¸ƒå¼ç³»ç»Ÿåªèƒ½åŒæ—¶æ»¡è¶³ä¸¤ä¸ªç‰¹æ€§ï¼š
C (Consistency)    - ä¸€è‡´æ€§ï¼šæ‰€æœ‰èŠ‚ç‚¹æ•°æ®ä¸€è‡´
A (Availability)   - å¯ç”¨æ€§ï¼šç³»ç»ŸæŒç»­æä¾›æœåŠ¡  
P (Partition tolerance) - åˆ†åŒºå®¹é”™ï¼šç½‘ç»œæ•…éšœæ—¶ä»èƒ½å·¥ä½œ

å®é™…é€‰æ‹©ï¼š
â€¢ é‡‘èç³»ç»Ÿï¼šé€‰æ‹©CPï¼ˆä¸€è‡´æ€§+åˆ†åŒºå®¹é”™ï¼‰
â€¢ ç¤¾äº¤åº”ç”¨ï¼šé€‰æ‹©APï¼ˆå¯ç”¨æ€§+åˆ†åŒºå®¹é”™ï¼‰
```

### 1.4 å¸¸è§è§£å†³æ–¹æ¡ˆå¯¹æ¯”


| æ–¹æ¡ˆ | ä¸€è‡´æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|--------|------|--------|----------|
| **Seata ATæ¨¡å¼** | å¼ºä¸€è‡´ | ä¸­ç­‰ | â­â­ | é€šç”¨ä¸šåŠ¡åœºæ™¯ |
| **TCCæ¨¡å¼** | æœ€ç»ˆä¸€è‡´ | é«˜ | â­â­â­â­ | å¯¹æ€§èƒ½è¦æ±‚é«˜ |
| **Sagaæ¨¡å¼** | æœ€ç»ˆä¸€è‡´ | é«˜ | â­â­â­ | é•¿æµç¨‹ä¸šåŠ¡ |
| **æœ¬åœ°æ¶ˆæ¯è¡¨** | æœ€ç»ˆä¸€è‡´ | ä¸­ç­‰ | â­â­ | å¼‚æ­¥åœºæ™¯ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | æœ€ç»ˆä¸€è‡´ | é«˜ | â­â­â­ | è§£è€¦åœºæ™¯ |
| **æœ€å¤§åŠªåŠ›é€šçŸ¥** | å¼±ä¸€è‡´ | æœ€é«˜ | â­ | å¯¹ä¸€è‡´æ€§è¦æ±‚ä¸ä¸¥æ ¼ |

---

## 2. ğŸ”§ Seataåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶


### 2.1 Seataæ˜¯ä»€ä¹ˆ


**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
```
Seata (Simple Extensible Autonomous Transaction Architecture)
ä¸­æ–‡ï¼šç®€å•å¯æ‰©å±•è‡ªæ²»äº‹åŠ¡æ¶æ„
ä½œç”¨ï¼šé˜¿é‡Œå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ
ç›®æ ‡ï¼šè®©åˆ†å¸ƒå¼äº‹åŠ¡åƒæœ¬åœ°äº‹åŠ¡ä¸€æ ·ç®€å•
```

**ğŸ¯ Seataè§£å†³ä»€ä¹ˆé—®é¢˜**
> å°±åƒä¸€ä¸ª"äº‹åŠ¡åè°ƒå‘˜"ï¼Œè´Ÿè´£æŒ‡æŒ¥å¤šä¸ªæœåŠ¡çš„æ“ä½œï¼Œç¡®ä¿å®ƒä»¬è¦ä¹ˆå…¨éƒ¨æˆåŠŸæäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šã€‚

### 2.2 Seataæ ¸å¿ƒè§’è‰²


**æ¶æ„å›¾ç¤º**
```
                    TC (äº‹åŠ¡åè°ƒè€…)
                  Transaction Coordinator
                         |
        +----------------+----------------+
        |                                 |
    TM (äº‹åŠ¡ç®¡ç†å™¨)                    RM (èµ„æºç®¡ç†å™¨)
Transaction Manager              Resource Manager
    è®¢å•æœåŠ¡                         è®¢å•æ•°æ®åº“
        |                                 |
        |                             åº“å­˜æ•°æ®åº“
        |                                 |
    åº“å­˜æœåŠ¡                         è´¦æˆ·æ•°æ®åº“
```

**ğŸ”¹ ä¸‰å¤§è§’è‰²è¯¦è§£**

**TC (Transaction Coordinator) - äº‹åŠ¡åè°ƒè€…**
```
èŒè´£ï¼šç»´æŠ¤å…¨å±€äº‹åŠ¡å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œé©±åŠ¨å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»š
ç±»æ¯”ï¼šå°±åƒå·¥åœ°çš„æ€»æŒ‡æŒ¥ï¼Œç»Ÿä¸€åè°ƒæ‰€æœ‰å·¥äºº
éƒ¨ç½²ï¼šç‹¬ç«‹éƒ¨ç½²çš„SeataæœåŠ¡å™¨
```

**TM (Transaction Manager) - äº‹åŠ¡ç®¡ç†å™¨**
```
èŒè´£ï¼šå®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ï¼Œå¼€å§‹ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡
ç±»æ¯”ï¼šå°±åƒé¡¹ç›®ç»ç†ï¼Œå†³å®šæ•´ä¸ªé¡¹ç›®çš„å¼€å§‹å’Œç»“æŸ
å®ç°ï¼šåœ¨å‘èµ·åˆ†å¸ƒå¼äº‹åŠ¡çš„æœåŠ¡ä¸­
```

**RM (Resource Manager) - èµ„æºç®¡ç†å™¨**
```
èŒè´£ï¼šç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œå‘TCæ³¨å†Œåˆ†æ”¯äº‹åŠ¡å¹¶æ±‡æŠ¥çŠ¶æ€
ç±»æ¯”ï¼šå°±åƒå„ä¸ªæ–½å·¥é˜Ÿï¼Œå‘æ€»æŒ‡æŒ¥æ±‡æŠ¥è¿›åº¦
å®ç°ï¼šåœ¨æ¯ä¸ªå‚ä¸äº‹åŠ¡çš„æœåŠ¡ä¸­
```

### 2.3 Seataå·¥ä½œæµç¨‹


**ğŸ”„ æ‰§è¡Œæµç¨‹å›¾**
```
å®¢æˆ·ç«¯              TM(è®¢å•æœåŠ¡)         TC(Seata)        RM(åº“å­˜æœåŠ¡)
  |                      |                  |                  |
  |---[1]ä¸‹å•è¯·æ±‚------->|                  |                  |
  |                      |                  |                  |
  |              [2]å¼€å¯å…¨å±€äº‹åŠ¡             |                  |
  |                      |----------------->|                  |
  |                      |<---è¿”å›å…¨å±€äº‹åŠ¡ID-|                  |
  |                      |                  |                  |
  |              [3]æ‰§è¡Œæœ¬åœ°äº‹åŠ¡             |                  |
  |                      |(åˆ›å»ºè®¢å•)        |                  |
  |                      |                  |                  |
  |              [4]è°ƒç”¨åº“å­˜æœåŠ¡             |                  |
  |                      |---------------------------------->|
  |                      |                  |                  |
  |                      |          [5]æ³¨å†Œåˆ†æ”¯äº‹åŠ¡            |
  |                      |                  |<-----------------|
  |                      |                  |                  |
  |                      |          [6]æ‰§è¡Œåº“å­˜æ‰£å‡            |
  |                      |<----------------------------------|
  |                      |                  |                  |
  |              [7]æäº¤å…¨å±€äº‹åŠ¡             |                  |
  |                      |----------------->|                  |
  |                      |                  |                  |
  |                      |          [8]é€šçŸ¥æäº¤                |
  |                      |                  |----------------->|
  |                      |                  |<------å®Œæˆ-------|
  |                      |                  |                  |
  |<--[9]è¿”å›æˆåŠŸ---------|                  |                  |
```

**ğŸ” è¯¦ç»†æ­¥éª¤è¯´æ˜**

1ï¸âƒ£ **å¼€å¯å…¨å±€äº‹åŠ¡**
```java
@GlobalTransactional  // Seataæ³¨è§£ï¼Œæ ‡è®°å…¨å±€äº‹åŠ¡
public void createOrder(Order order) {
    // TMå‘TCæ³¨å†Œå…¨å±€äº‹åŠ¡ï¼Œè·å–å…¨å±€äº‹åŠ¡ID(XID)
}
```

2ï¸âƒ£ **æ‰§è¡Œå„ä¸ªåˆ†æ”¯äº‹åŠ¡**
```java
// è®¢å•æœåŠ¡
orderMapper.insert(order);  // RM1ï¼šåˆ›å»ºè®¢å•

// è°ƒç”¨åº“å­˜æœåŠ¡
stockService.deduct(productId, count);  // RM2ï¼šæ‰£å‡åº“å­˜

// è°ƒç”¨è´¦æˆ·æœåŠ¡  
accountService.deduct(userId, amount);  // RM3ï¼šæ‰£å‡ä½™é¢
```

3ï¸âƒ£ **æäº¤æˆ–å›æ»š**
```
å…¨éƒ¨æˆåŠŸï¼šTMé€šçŸ¥TCæäº¤ â†’ TCé€šçŸ¥å„RMæäº¤
ä»»ä¸€å¤±è´¥ï¼šTMé€šçŸ¥TCå›æ»š â†’ TCé€šçŸ¥å„RMå›æ»š
```

### 2.4 Seata ATæ¨¡å¼å®æˆ˜


**ğŸš€ å¿«é€Ÿé›†æˆæ­¥éª¤**

**æ­¥éª¤1ï¼šå¼•å…¥ä¾èµ–**
```xml
<!-- Seataä¾èµ– -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
</dependency>
```

**æ­¥éª¤2ï¼šé…ç½®Seata**
```yaml
seata:
  enabled: true
  application-id: order-service
  tx-service-group: my_test_tx_group  # äº‹åŠ¡åˆ†ç»„
  service:
    vgroup-mapping:
      my_test_tx_group: default  # æ˜ å°„åˆ°TCé›†ç¾¤
    default:
      grouplist: 127.0.0.1:8091  # TCæœåŠ¡åœ°å€
```

**æ­¥éª¤3ï¼šæ·»åŠ å…¨å±€äº‹åŠ¡æ³¨è§£**
```java
@Service
public class OrderServiceImpl implements OrderService {
    
    @Autowired
    private StockService stockService;
    
    @Autowired
    private AccountService accountService;
    
    // åªéœ€è¦ä¸€ä¸ªæ³¨è§£ï¼
    @GlobalTransactional(name = "create-order", rollbackFor = Exception.class)
    public void createOrder(Order order) {
        // 1. åˆ›å»ºè®¢å•
        orderMapper.insert(order);
        
        // 2. æ‰£å‡åº“å­˜ï¼ˆè°ƒç”¨å…¶ä»–æœåŠ¡ï¼‰
        stockService.deduct(order.getProductId(), order.getCount());
        
        // 3. æ‰£å‡è´¦æˆ·ä½™é¢ï¼ˆè°ƒç”¨å…¶ä»–æœåŠ¡ï¼‰
        accountService.deduct(order.getUserId(), order.getMoney());
        
        // ä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œå…¨éƒ¨å›æ»šï¼
    }
}
```

**ğŸ“Š ATæ¨¡å¼çš„ä¼˜ç¼ºç‚¹**

âœ… **ä¼˜ç‚¹**
- **é›¶ä¾µå…¥**ï¼šä¸šåŠ¡ä»£ç å‡ ä¹ä¸ç”¨æ”¹
- **è‡ªåŠ¨å›æ»š**ï¼šæ¡†æ¶è‡ªåŠ¨ç”Ÿæˆåå‘SQL
- **é«˜æ€§èƒ½**ï¼šåŸºäºæœ¬åœ°äº‹åŠ¡

âŒ **ç¼ºç‚¹**
- **åªæ”¯æŒå…³ç³»å‹æ•°æ®åº“**ï¼šMySQLã€Oracleç­‰
- **éš”ç¦»æ€§é—®é¢˜**ï¼šé»˜è®¤è¯»æœªæäº¤

---

## 3. ğŸ’° TCCè¡¥å¿æ¨¡å¼


### 3.1 TCCæ˜¯ä»€ä¹ˆ


**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
```
TCCï¼šTry-Confirm-Cancel
Tryï¼šå°è¯•æ‰§è¡Œï¼Œé¢„ç•™èµ„æº
Confirmï¼šç¡®è®¤æ‰§è¡Œï¼ŒçœŸæ­£æäº¤
Cancelï¼šå–æ¶ˆæ‰§è¡Œï¼Œé‡Šæ”¾èµ„æº
```

**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> å°±åƒç½‘è´­ï¼š
> - **Tryé˜¶æ®µ**ï¼šä¸‹å•æ—¶å†»ç»“åº“å­˜å’Œä½™é¢ï¼ˆé¢„ç•™èµ„æºï¼‰
> - **Confirmé˜¶æ®µ**ï¼šæ”¯ä»˜æˆåŠŸåçœŸæ­£æ‰£å‡ï¼ˆç¡®è®¤æ“ä½œï¼‰
> - **Cancelé˜¶æ®µ**ï¼šæ”¯ä»˜å¤±è´¥æ—¶è§£å†»åº“å­˜å’Œä½™é¢ï¼ˆè¡¥å¿æ“ä½œï¼‰

### 3.2 TCCä¸‰ä¸ªé˜¶æ®µè¯¦è§£


**é˜¶æ®µæµç¨‹å›¾**
```
Tryé˜¶æ®µï¼šé¢„ç•™èµ„æº
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è´¦æˆ·-100 â”‚    â”‚åº“å­˜-1   â”‚    â”‚è®¢å•+1   â”‚
â”‚å†»ç»“+100 â”‚    â”‚å†»ç»“+1   â”‚    â”‚å¾…ç¡®è®¤   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“              â†“              â†“
å…¨éƒ¨æˆåŠŸ â†’ Confirmé˜¶æ®µ    ä»»ä¸€å¤±è´¥ â†’ Cancelé˜¶æ®µ
      â†“                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å†»ç»“-100 â”‚    â”‚å†»ç»“-1   â”‚    â”‚è´¦æˆ·+100 â”‚
â”‚å·²æ”¯ä»˜   â”‚    â”‚å·²å‡ºåº“   â”‚    â”‚åº“å­˜+1   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¹ Tryé˜¶æ®µ - èµ„æºé¢„ç•™**
```java
/**
 * Tryï¼šæ£€æŸ¥å¹¶é¢„ç•™èµ„æº
 * è¦æ±‚ï¼š
 * 1. å¯é‡å¤æ‰§è¡Œï¼ˆå¹‚ç­‰æ€§ï¼‰
 * 2. é¢„ç•™èµ„æºä½†ä¸çœŸæ­£æ‰£å‡
 */
@Transactional
public boolean tryDeduct(String userId, Long amount) {
    // 1. æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³
    Account account = accountMapper.selectById(userId);
    if (account.getBalance() < amount) {
        return false;  // ä½™é¢ä¸è¶³
    }
    
    // 2. å†»ç»“é‡‘é¢ï¼ˆé¢„ç•™èµ„æºï¼‰
    account.setFrozen(account.getFrozen() + amount);
    accountMapper.updateById(account);
    
    return true;
}
```

**ğŸ”¹ Confirmé˜¶æ®µ - ç¡®è®¤æäº¤**
```java
/**
 * Confirmï¼šçœŸæ­£æ‰£å‡èµ„æº
 * è¦æ±‚ï¼šå¿…é¡»æˆåŠŸï¼ˆå¯èƒ½éœ€è¦é‡è¯•ï¼‰
 */
@Transactional
public void confirmDeduct(String userId, Long amount) {
    // 1. æ‰£å‡å†»ç»“é‡‘é¢
    Account account = accountMapper.selectById(userId);
    account.setFrozen(account.getFrozen() - amount);
    account.setBalance(account.getBalance() - amount);
    accountMapper.updateById(account);
}
```

**ğŸ”¹ Cancelé˜¶æ®µ - è¡¥å¿å›æ»š**
```java
/**
 * Cancelï¼šé‡Šæ”¾é¢„ç•™èµ„æº
 * è¦æ±‚ï¼šå¿…é¡»æˆåŠŸï¼ˆå¯èƒ½éœ€è¦é‡è¯•ï¼‰
 */
@Transactional
public void cancelDeduct(String userId, Long amount) {
    // 1. è§£å†»é‡‘é¢
    Account account = accountMapper.selectById(userId);
    account.setFrozen(account.getFrozen() - amount);
    accountMapper.updateById(account);
}
```

### 3.3 TCCå®æˆ˜ç¤ºä¾‹


**å®Œæ•´çš„è®¢å•æœåŠ¡å®ç°**

```java
@Service
public class OrderTccService {
    
    @Autowired
    private AccountTccService accountTccService;
    
    @Autowired
    private StockTccService stockTccService;
    
    /**
     * ä¸»ä¸šåŠ¡æ–¹æ³•
     */
    @TccTransaction
    public void createOrder(Order order) {
        // 1. Tryé˜¶æ®µï¼šé¢„ç•™æ‰€æœ‰èµ„æº
        boolean accountOk = accountTccService.tryDeduct(
            order.getUserId(), order.getAmount());
        boolean stockOk = stockTccService.tryDeduct(
            order.getProductId(), order.getCount());
            
        if (!accountOk || !stockOk) {
            throw new RuntimeException("èµ„æºé¢„ç•™å¤±è´¥");
        }
        
        // 2. åˆ›å»ºè®¢å•è®°å½•
        orderMapper.insert(order);
        
        // TCCæ¡†æ¶ä¼šè‡ªåŠ¨è°ƒç”¨Confirmæˆ–Cancel
    }
    
    /**
     * Confirmï¼šæ‰€æœ‰TryæˆåŠŸåè°ƒç”¨
     */
    public void confirmCreateOrder(Order order) {
        accountTccService.confirmDeduct(order.getUserId(), order.getAmount());
        stockTccService.confirmDeduct(order.getProductId(), order.getCount());
    }
    
    /**
     * Cancelï¼šä»»ä½•Tryå¤±è´¥æ—¶è°ƒç”¨
     */
    public void cancelCreateOrder(Order order) {
        accountTccService.cancelDeduct(order.getUserId(), order.getAmount());
        stockTccService.cancelDeduct(order.getProductId(), order.getCount());
    }
}
```

### 3.4 TCCçš„å…³é”®ç‚¹


**ğŸ”‘ å¿…é¡»ä¿è¯çš„ç‰¹æ€§**

| ç‰¹æ€§ | è¯´æ˜ | å®ç°æ–¹å¼ |
|------|------|----------|
| **å¹‚ç­‰æ€§** | åŒä¸€è¯·æ±‚å¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´ | ç”¨ä¸šåŠ¡IDå»é‡ |
| **å¯æŸ¥è¯¢** | èƒ½æŸ¥è¯¢æ“ä½œæ‰§è¡ŒçŠ¶æ€ | è®°å½•æ“ä½œæ—¥å¿— |
| **è¡¥å¿æ€§** | Cancelèƒ½æ­£ç¡®æ’¤é”€Try | åå‘æ“ä½œè®¾è®¡ |

**âš ï¸ å¸¸è§é—®é¢˜**

**ç©ºå›æ»šé—®é¢˜**
```
é—®é¢˜ï¼šTryé˜¶æ®µå› ç½‘ç»œè¶…æ—¶æ²¡æ‰§è¡Œï¼Œä½†Cancelå´æ‰§è¡Œäº†
è§£å†³ï¼šCancelå‰å…ˆæ£€æŸ¥Tryæ˜¯å¦æ‰§è¡Œè¿‡
```

**æ‚¬æŒ‚é—®é¢˜**
```
é—®é¢˜ï¼šCancelå…ˆæ‰§è¡Œï¼ŒTryååˆ°è¾¾
è§£å†³ï¼šTryå‰æ£€æŸ¥Cancelæ˜¯å¦å·²æ‰§è¡Œ
```

**ğŸ“Š TCCä¼˜ç¼ºç‚¹**

âœ… **ä¼˜ç‚¹**
- **æ€§èƒ½é«˜**ï¼šæ— é•¿äº‹åŠ¡é”å®š
- **çµæ´»æ€§å¼º**ï¼šé€‚é…å„ç§æ•°æ®æº
- **ä¸€è‡´æ€§å¥½**ï¼šæœ€ç»ˆä¸€è‡´æ€§ä¿è¯

âŒ **ç¼ºç‚¹**
- **ä»£ç ä¾µå…¥å¤§**ï¼šéœ€è¦ç¼–å†™ä¸‰ä¸ªæ–¹æ³•
- **å¼€å‘å¤æ‚**ï¼šè¦è€ƒè™‘å„ç§å¼‚å¸¸æƒ…å†µ

---

## 4. ğŸ“– Sagaäº‹åŠ¡æ¨¡å¼


### 4.1 Sagaæ˜¯ä»€ä¹ˆ


**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
```
Sagaï¼šé•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªæœ¬åœ°çŸ­äº‹åŠ¡
ç‰¹ç‚¹ï¼šæ¯ä¸ªçŸ­äº‹åŠ¡æäº¤åï¼Œå¦‚æœå¤±è´¥åˆ™é€šè¿‡è¡¥å¿äº‹åŠ¡å›æ»š
èµ·æºï¼š1987å¹´ç”±æ™®æ—æ–¯é¡¿å¤§å­¦æå‡º
```

**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> å°±åƒæ—…è¡Œè®¡åˆ’ï¼š
> 1. è®¢æœºç¥¨ï¼ˆæˆåŠŸï¼‰
> 2. è®¢é…’åº—ï¼ˆæˆåŠŸï¼‰
> 3. è®¢é—¨ç¥¨ï¼ˆå¤±è´¥ï¼‰
> 
> å¤±è´¥åéœ€è¦ï¼šå–æ¶ˆé…’åº—é¢„è®¢ â†’ é€€æœºç¥¨

### 4.2 Sagaçš„ä¸¤ç§å®ç°æ–¹å¼


**ğŸ”¹ ååŒå¼Sagaï¼ˆChoreographyï¼‰**
```
å„æœåŠ¡è‡ªå·±å†³å®šä¸‹ä¸€æ­¥åšä»€ä¹ˆï¼Œé€šè¿‡äº‹ä»¶é©±åŠ¨

è®¢å•æœåŠ¡ --åˆ›å»ºè®¢å•--> æ¶ˆæ¯é˜Ÿåˆ—
   â†“                        â†“
æ¶ˆæ¯é˜Ÿåˆ— <--è®¢å•å·²åˆ›å»º--  åº“å­˜æœåŠ¡
   â†“                        â†“
æ”¯ä»˜æœåŠ¡ <--åº“å­˜å·²æ‰£å‡--  æ¶ˆæ¯é˜Ÿåˆ—

ç‰¹ç‚¹ï¼šå»ä¸­å¿ƒåŒ–ï¼ŒæœåŠ¡é—´è§£è€¦
ç¼ºç‚¹ï¼šéš¾ä»¥è¿½è¸ªå…¨å±€çŠ¶æ€
```

**ğŸ”¹ ç¼–æ’å¼Sagaï¼ˆOrchestrationï¼‰**
```
ç”±ä¸­å¤®åè°ƒå™¨ç»Ÿä¸€ç¼–æ’å„ä¸ªæœåŠ¡

        Sagaåè°ƒå™¨
           |
    +------+------+------+
    |      |      |      |
  è®¢å•   åº“å­˜   æ”¯ä»˜   ç§¯åˆ†
  æœåŠ¡   æœåŠ¡   æœåŠ¡   æœåŠ¡

ç‰¹ç‚¹ï¼šé›†ä¸­ç®¡ç†ï¼Œæµç¨‹æ¸…æ™°
ç¼ºç‚¹ï¼šåè°ƒå™¨æˆä¸ºå•ç‚¹
```

### 4.3 SagaçŠ¶æ€æœºæ¨¡å¼


**çŠ¶æ€è½¬æ¢å›¾**
```
[å¼€å§‹] 
  â†“
[åˆ›å»ºè®¢å•] â†â”€â”€å¤±è´¥â”€â”€â†’ [ç»“æŸ]
  â†“æˆåŠŸ
[æ‰£å‡åº“å­˜] â†â”€â”€å¤±è´¥â”€â”€â†’ [å–æ¶ˆè®¢å•] â†’ [ç»“æŸ]
  â†“æˆåŠŸ
[æ‰£å‡ä½™é¢] â†â”€â”€å¤±è´¥â”€â”€â†’ [æ¢å¤åº“å­˜] â†’ [å–æ¶ˆè®¢å•] â†’ [ç»“æŸ]
  â†“æˆåŠŸ
[å¢åŠ ç§¯åˆ†] â†â”€â”€å¤±è´¥â”€â”€â†’ [æ¢å¤ä½™é¢] â†’ [æ¢å¤åº“å­˜] â†’ [å–æ¶ˆè®¢å•] â†’ [ç»“æŸ]
  â†“æˆåŠŸ
[ç»“æŸ]
```

**ä»£ç å®ç°ç¤ºä¾‹**

```java
@Service
public class OrderSagaService {
    
    @Autowired
    private StateMachineEngine stateMachineEngine;
    
    /**
     * å®šä¹‰SagaçŠ¶æ€æœº
     */
    public void createOrder(Order order) {
        // 1. å®šä¹‰æ­£å‘æµç¨‹
        StateMachineBuilder builder = StateMachineBuilderFactory.create();
        
        builder.externalTransition()
            .from("Start")
            .to("CreateOrder")
            .on("ORDER_CREATE")
            .when(checkCondition())
            .perform(createOrderAction());
            
        builder.externalTransition()
            .from("CreateOrder")
            .to("DeductStock")
            .on("STOCK_DEDUCT")
            .perform(deductStockAction())
            // å®šä¹‰è¡¥å¿æ“ä½œ
            .errorAction(cancelOrderAction());
            
        builder.externalTransition()
            .from("DeductStock")
            .to("DeductAccount")
            .on("ACCOUNT_DEDUCT")
            .perform(deductAccountAction())
            // å®šä¹‰è¡¥å¿æ“ä½œ
            .errorAction(restoreStockAction(), cancelOrderAction());
            
        // 2. æ‰§è¡ŒçŠ¶æ€æœº
        StateMachine stateMachine = builder.build();
        stateMachine.fireEvent("ORDER_CREATE", order);
    }
}
```

### 4.4 Sagaå®æˆ˜ï¼šSeata-Saga


**ğŸš€ ä½¿ç”¨Seataçš„Sagaæ¨¡å¼**

**æ­¥éª¤1ï¼šå®šä¹‰JSONçŠ¶æ€å›¾**
```json
{
  "Name": "OrderSaga",
  "Comment": "è®¢å•Sagaæµç¨‹",
  "StartState": "CreateOrder",
  "States": {
    "CreateOrder": {
      "Type": "ServiceTask",
      "ServiceName": "orderService",
      "ServiceMethod": "create",
      "CompensateState": "CancelOrder",
      "Next": "DeductStock"
    },
    "DeductStock": {
      "Type": "ServiceTask", 
      "ServiceName": "stockService",
      "ServiceMethod": "deduct",
      "CompensateState": "RestoreStock",
      "Next": "DeductAccount"
    },
    "DeductAccount": {
      "Type": "ServiceTask",
      "ServiceName": "accountService", 
      "ServiceMethod": "deduct",
      "CompensateState": "RestoreAccount",
      "Next": "Succeed"
    }
  }
}
```

**æ­¥éª¤2ï¼šå®ç°è¡¥å¿æ–¹æ³•**
```java
@Service
public class StockService {
    
    // æ­£å‘æ“ä½œï¼šæ‰£å‡åº“å­˜
    public boolean deduct(String productId, int count) {
        Stock stock = stockMapper.selectById(productId);
        stock.setCount(stock.getCount() - count);
        stockMapper.updateById(stock);
        return true;
    }
    
    // è¡¥å¿æ“ä½œï¼šæ¢å¤åº“å­˜
    public boolean restore(String productId, int count) {
        Stock stock = stockMapper.selectById(productId);
        stock.setCount(stock.getCount() + count);
        stockMapper.updateById(stock);
        return true;
    }
}
```

### 4.5 Sagaä¼˜ç¼ºç‚¹


**ğŸ“Š å¯¹æ¯”åˆ†æ**

âœ… **ä¼˜ç‚¹**
- **é•¿æµç¨‹å‹å¥½**ï¼šé€‚åˆæµç¨‹å¤æ‚çš„ä¸šåŠ¡
- **æ— é”è®¾è®¡**ï¼šæ€§èƒ½å¥½ï¼Œä¸é˜»å¡
- **çµæ´»æ€§é«˜**ï¼šæ”¯æŒå¼‚æ­¥è°ƒç”¨

âŒ **ç¼ºç‚¹**  
- **ä¸ä¿è¯éš”ç¦»æ€§**ï¼šä¸­é—´çŠ¶æ€å¯è§
- **è¡¥å¿å¤æ‚**ï¼šéœ€è¦è€ƒè™‘å„ç§è¡¥å¿åœºæ™¯
- **è®¾è®¡éš¾åº¦å¤§**ï¼šçŠ¶æ€æœºè®¾è®¡éœ€è¦ç»éªŒ

---

## 5. ğŸ“ æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆ


### 5.1 æœ¬åœ°æ¶ˆæ¯è¡¨æ˜¯ä»€ä¹ˆ


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> å°±åƒå¯„åŒ…è£¹ï¼š
> 1. å…ˆåœ¨æœ¬åœ°è®°å½•"è¦å¯„ä»€ä¹ˆ"ï¼ˆå†™æ¶ˆæ¯è¡¨ï¼‰
> 2. å’Œå¿«é€’ä¸€èµ·äº¤ç»™ç‰©æµï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
> 3. å®šæ—¶æ£€æŸ¥åŒ…è£¹æ˜¯å¦é€è¾¾ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
> 4. å¦‚æœæ²¡é€è¾¾ï¼Œç»§ç»­å¯„ï¼ˆé‡è¯•ï¼‰

**ğŸ“‹ æ ¸å¿ƒåŸç†**
```
æ ¸å¿ƒæ€æƒ³ï¼šå°†åˆ†å¸ƒå¼äº‹åŠ¡æ‹†åˆ†ä¸ºæœ¬åœ°äº‹åŠ¡ + å¯é æ¶ˆæ¯
å®ç°æ–¹å¼ï¼š
1. åœ¨æœ¬åœ°æ•°æ®åº“åˆ›å»ºæ¶ˆæ¯è¡¨
2. ä¸šåŠ¡æ“ä½œå’Œå†™æ¶ˆæ¯è¡¨åœ¨åŒä¸€äº‹åŠ¡
3. å®šæ—¶ä»»åŠ¡æ‰«ææ¶ˆæ¯è¡¨ï¼Œå‘é€æ¶ˆæ¯
4. æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯ï¼Œæ›´æ–°æ¶ˆæ¯çŠ¶æ€
```

### 5.2 æœ¬åœ°æ¶ˆæ¯è¡¨ç»“æ„è®¾è®¡


**æ¶ˆæ¯è¡¨è®¾è®¡**
```sql
CREATE TABLE local_message (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    business_id VARCHAR(64) NOT NULL COMMENT 'ä¸šåŠ¡ID',
    message_type VARCHAR(32) NOT NULL COMMENT 'æ¶ˆæ¯ç±»å‹',
    content TEXT COMMENT 'æ¶ˆæ¯å†…å®¹(JSON)',
    status TINYINT DEFAULT 0 COMMENT 'çŠ¶æ€: 0-å¾…å‘é€ 1-å·²å‘é€ 2-å·²æ¶ˆè´¹',
    retry_count INT DEFAULT 0 COMMENT 'é‡è¯•æ¬¡æ•°',
    next_retry_time DATETIME COMMENT 'ä¸‹æ¬¡é‡è¯•æ—¶é—´',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_status_retry (status, next_retry_time)
) COMMENT 'æœ¬åœ°æ¶ˆæ¯è¡¨';
```

### 5.3 å®ç°æµç¨‹


**ğŸ”„ å®Œæ•´æµç¨‹å›¾**
```
è®¢å•æœåŠ¡                         åº“å­˜æœåŠ¡
   |                                |
[1]å¼€å¯æœ¬åœ°äº‹åŠ¡                     |
   |                                |
[2]åˆ›å»ºè®¢å•                         |
   |                                |
[3]å†™å…¥æ¶ˆæ¯è¡¨                       |
   |                                |
[4]æäº¤äº‹åŠ¡                         |
   |                                |
[5]å®šæ—¶ä»»åŠ¡æ‰«ææ¶ˆæ¯                 |
   |                                |
[6]å‘é€MQæ¶ˆæ¯ -----------------> [7]æ¥æ”¶æ¶ˆæ¯
   |                                |
[8]æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸ºå·²å‘é€             [9]æ‰£å‡åº“å­˜
   |                                |
   |                            [10]å‘é€ç¡®è®¤æ¶ˆæ¯
   |                                |
[11]æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸ºå·²æ¶ˆè´¹  <--------- |
```

**ä»£ç å®ç°**

**æ­¥éª¤1ï¼šå‘èµ·æ–¹å®ç°**
```java
@Service
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private LocalMessageMapper messageMapper;
    
    /**
     * åˆ›å»ºè®¢å•ï¼šä¸šåŠ¡æ“ä½œ + å†™æ¶ˆæ¯è¡¨åœ¨åŒä¸€äº‹åŠ¡
     */
    @Transactional
    public void createOrder(Order order) {
        // 1. æ‰§è¡Œæœ¬åœ°ä¸šåŠ¡æ“ä½œ
        orderMapper.insert(order);
        
        // 2. å†™å…¥æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆå…³é”®ï¼šåœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼‰
        LocalMessage message = new LocalMessage();
        message.setBusinessId(order.getId());
        message.setMessageType("ORDER_CREATED");
        message.setContent(JSON.toJSONString(order));
        message.setStatus(0);  // å¾…å‘é€
        message.setNextRetryTime(new Date());
        messageMapper.insert(message);
        
        // 3. äº‹åŠ¡æäº¤åï¼Œæ¶ˆæ¯ä¸€å®šå·²ä¿å­˜
    }
}
```

**æ­¥éª¤2ï¼šå®šæ—¶å‘é€æ¶ˆæ¯**
```java
@Component
public class MessageSendJob {
    
    @Autowired
    private LocalMessageMapper messageMapper;
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    /**
     * å®šæ—¶æ‰«æå¾…å‘é€æ¶ˆæ¯ï¼ˆæ¯5ç§’æ‰§è¡Œä¸€æ¬¡ï¼‰
     */
    @Scheduled(fixedRate = 5000)
    public void sendMessage() {
        // 1. æŸ¥è¯¢å¾…å‘é€çš„æ¶ˆæ¯
        List<LocalMessage> messages = messageMapper.selectList(
            new LambdaQueryWrapper<LocalMessage>()
                .eq(LocalMessage::getStatus, 0)  // å¾…å‘é€
                .lt(LocalMessage::getNextRetryTime, new Date())
                .last("LIMIT 100")  // æ¯æ¬¡æœ€å¤š100æ¡
        );
        
        // 2. å‘é€æ¶ˆæ¯
        for (LocalMessage message : messages) {
            try {
                // å‘é€åˆ°MQ
                rocketMQTemplate.convertAndSend(
                    message.getMessageType(), 
                    message.getContent()
                );
                
                // 3. æ›´æ–°æ¶ˆæ¯çŠ¶æ€
                message.setStatus(1);  // å·²å‘é€
                messageMapper.updateById(message);
                
            } catch (Exception e) {
                // 4. å‘é€å¤±è´¥ï¼Œæ›´æ–°é‡è¯•ä¿¡æ¯
                message.setRetryCount(message.getRetryCount() + 1);
                message.setNextRetryTime(
                    DateUtil.addMinutes(new Date(), 
                    message.getRetryCount() * 2)  // æŒ‡æ•°é€€é¿
                );
                messageMapper.updateById(message);
            }
        }
    }
}
```

**æ­¥éª¤3ï¼šæ¶ˆè´¹æ–¹å®ç°**
```java
@Service
@RocketMQMessageListener(
    topic = "ORDER_CREATED",
    consumerGroup = "stock-consumer-group"
)
public class OrderMessageListener implements RocketMQListener<String> {
    
    @Autowired
    private StockService stockService;
    
    /**
     * æ¶ˆè´¹æ¶ˆæ¯ï¼šæ‰£å‡åº“å­˜
     */
    @Override
    public void onMessage(String message) {
        Order order = JSON.parseObject(message, Order.class);
        
        try {
            // 1. æ‰§è¡Œä¸šåŠ¡æ“ä½œï¼ˆä¿è¯å¹‚ç­‰æ€§ï¼‰
            stockService.deduct(order.getProductId(), order.getCount());
            
            // 2. å‘é€ç¡®è®¤æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰
            // é€šçŸ¥è®¢å•æœåŠ¡æ¶ˆæ¯å·²å¤„ç†
            
        } catch (Exception e) {
            // 3. å¤„ç†å¤±è´¥ï¼ŒæŠ›å¼‚å¸¸è®©MQé‡è¯•
            throw new RuntimeException("åº“å­˜æ‰£å‡å¤±è´¥", e);
        }
    }
}
```

### 5.4 æœ¬åœ°æ¶ˆæ¯è¡¨çš„ä¼˜åŒ–


**ğŸ”§ æ€§èƒ½ä¼˜åŒ–**

**æ‰¹é‡å‘é€**
```java
// ä¼˜åŒ–å‰ï¼šé€æ¡å‘é€
for (LocalMessage msg : messages) {
    sendMessage(msg);
}

// ä¼˜åŒ–åï¼šæ‰¹é‡å‘é€
List<String> contents = messages.stream()
    .map(LocalMessage::getContent)
    .collect(Collectors.toList());
rocketMQTemplate.syncSend("BATCH_TOPIC", contents);
```

**æ¶ˆæ¯å½’æ¡£**
```java
// å®šæ—¶å½’æ¡£å·²æ¶ˆè´¹çš„æ¶ˆæ¯
@Scheduled(cron = "0 0 2 * * ?")  // æ¯å¤©å‡Œæ™¨2ç‚¹
public void archiveMessages() {
    // 1. å°†30å¤©å‰å·²æ¶ˆè´¹çš„æ¶ˆæ¯ç§»åˆ°å†å²è¡¨
    LocalDateTime archiveTime = LocalDateTime.now().minusDays(30);
    
    // 2. æ’å…¥å†å²è¡¨
    messageMapper.archiveOldMessages(archiveTime);
    
    // 3. åˆ é™¤åŸè¡¨æ•°æ®
    messageMapper.deleteOldMessages(archiveTime);
}
```

**ğŸ“Š ä¼˜ç¼ºç‚¹åˆ†æ**

âœ… **ä¼˜ç‚¹**
- **å®ç°ç®€å•**ï¼šåŸºäºæ•°æ®åº“ï¼Œå®¹æ˜“ç†è§£
- **å¯é æ€§é«˜**ï¼šæ¶ˆæ¯ä¸ä¼šä¸¢å¤±
- **æ˜“äºç›‘æ§**ï¼šå¯ç›´æ¥æŸ¥è¯¢æ¶ˆæ¯è¡¨

âŒ **ç¼ºç‚¹**
- **æ€§èƒ½ä¸€èˆ¬**ï¼šä¾èµ–æ•°æ®åº“æ‰«æ
- **å»¶è¿Ÿè¾ƒé«˜**ï¼šå®šæ—¶ä»»åŠ¡æœ‰å»¶è¿Ÿ
- **æ•°æ®è†¨èƒ€**ï¼šæ¶ˆæ¯è¡¨æ•°æ®å¢é•¿å¿«

---

## 6. ğŸ“¨ æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡


### 6.1 RocketMQäº‹åŠ¡æ¶ˆæ¯


**ğŸ“‹ æ ¸å¿ƒåŸç†**
```
RocketMQäº‹åŠ¡æ¶ˆæ¯ï¼šé€šè¿‡åŠæ¶ˆæ¯æœºåˆ¶ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
ç‰¹ç‚¹ï¼š
1. å…ˆå‘é€åŠæ¶ˆæ¯ï¼ˆå¯¹æ¶ˆè´¹è€…ä¸å¯è§ï¼‰
2. æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
3. æäº¤æˆ–å›æ»šåŠæ¶ˆæ¯
4. å¦‚æœå¼‚å¸¸ï¼ŒMQä¼šå›æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€
```

**ğŸ”„ æ‰§è¡Œæµç¨‹**
```
è®¢å•æœåŠ¡              RocketMQ Broker           åº“å­˜æœåŠ¡
   |                        |                      |
[1]å‘é€åŠæ¶ˆæ¯ ------------->|                      |
   |                        |                      |
   |<-----è¿”å›æˆåŠŸ-----------|                      |
   |                        |                      |
[2]æ‰§è¡Œæœ¬åœ°äº‹åŠ¡             |                      |
   (åˆ›å»ºè®¢å•)               |                      |
   |                        |                      |
[3]æäº¤/å›æ»šæ¶ˆæ¯ ---------->|                      |
   |                        |                      |
   |                  [4]è½¬ä¸ºå¯æ¶ˆè´¹æ¶ˆæ¯             |
   |                        |                      |
   |                        |---[5]æ¨é€æ¶ˆæ¯------->|
   |                        |                      |
   |                        |              [6]æ‰£å‡åº“å­˜
   |                        |                      |
   |                        |<---[7]ç¡®è®¤æ¶ˆè´¹-------|
```

**å¦‚æœæäº¤æ¶ˆæ¯è¶…æ—¶ï¼Ÿ**
```
è®¢å•æœåŠ¡              RocketMQ Broker
   |                        |
[1]å‘é€åŠæ¶ˆæ¯ ------------->|
   |<-----è¿”å›æˆåŠŸ-----------|
[2]æ‰§è¡Œæœ¬åœ°äº‹åŠ¡             |
   |                        |
[3]æäº¤æ¶ˆæ¯(ç½‘ç»œæ•…éšœ)  X    |
   |                        |
   |                   [4]å®šæ—¶å›æŸ¥
   |                        |
   |<----å›æŸ¥äº‹åŠ¡çŠ¶æ€--------|
   |                        |
[5]æ ¹æ®æ•°æ®åº“æŸ¥è¯¢è®¢å•çŠ¶æ€   |
   |                        |
   |----è¿”å›æäº¤/å›æ»š------->|
```

### 6.2 RocketMQäº‹åŠ¡æ¶ˆæ¯å®æˆ˜


**æ­¥éª¤1ï¼šå®ç°äº‹åŠ¡ç›‘å¬å™¨**
```java
@Component
@RocketMQTransactionListener
public class OrderTransactionListener implements RocketMQLocalTransactionListener {
    
    @Autowired
    private OrderService orderService;
    
    /**
     * æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
     */
    @Override
    public RocketMQLocalTransactionState executeLocalTransaction(
            Message msg, Object arg) {
        try {
            // 1. è§£ææ¶ˆæ¯
            Order order = JSON.parseObject(
                new String(msg.getBody()), Order.class);
            
            // 2. æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼ˆåˆ›å»ºè®¢å•ï¼‰
            orderService.createOrder(order);
            
            // 3. è¿”å›æäº¤çŠ¶æ€
            return RocketMQLocalTransactionState.COMMIT;
            
        } catch (Exception e) {
            // 4. å¤±è´¥è¿”å›å›æ»š
            return RocketMQLocalTransactionState.ROLLBACK;
        }
    }
    
    /**
     * å›æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€
     */
    @Override
    public RocketMQLocalTransactionState checkLocalTransaction(Message msg) {
        // 1. è§£ææ¶ˆæ¯è·å–è®¢å•ID
        String orderId = msg.getKeys();
        
        // 2. æŸ¥è¯¢æ•°æ®åº“ï¼Œæ£€æŸ¥è®¢å•æ˜¯å¦åˆ›å»ºæˆåŠŸ
        Order order = orderService.getById(orderId);
        
        if (order != null) {
            // è®¢å•å­˜åœ¨ï¼Œæäº¤æ¶ˆæ¯
            return RocketMQLocalTransactionState.COMMIT;
        } else {
            // è®¢å•ä¸å­˜åœ¨ï¼Œå›æ»šæ¶ˆæ¯
            return RocketMQLocalTransactionState.ROLLBACK;
        }
    }
}
```

**æ­¥éª¤2ï¼šå‘é€äº‹åŠ¡æ¶ˆæ¯**
```java
@Service
public class OrderService {
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    /**
     * åˆ›å»ºè®¢å•å¹¶å‘é€äº‹åŠ¡æ¶ˆæ¯
     */
    public void createOrderWithMessage(Order order) {
        // 1. å‘é€äº‹åŠ¡æ¶ˆæ¯ï¼ˆåŠæ¶ˆæ¯ï¼‰
        Message<String> message = MessageBuilder
            .withPayload(JSON.toJSONString(order))
            .setHeader("orderId", order.getId())
            .build();
            
        // 2. å‘é€äº‹åŠ¡æ¶ˆæ¯ï¼Œä¼šè§¦å‘executeLocalTransaction
        TransactionSendResult result = rocketMQTemplate.sendMessageInTransaction(
            "order-topic",  // ä¸»é¢˜
            message,        // æ¶ˆæ¯
            order           // é€ä¼ ç»™executeLocalTransactionçš„å‚æ•°
        );
        
        // 3. æ£€æŸ¥å‘é€ç»“æœ
        if (result.getLocalTransactionState() == 
            LocalTransactionState.ROLLBACK_MESSAGE) {
            throw new RuntimeException("è®¢å•åˆ›å»ºå¤±è´¥");
        }
    }
}
```

**æ­¥éª¤3ï¼šæ¶ˆè´¹æ¶ˆæ¯**
```java
@Service
@RocketMQMessageListener(
    topic = "order-topic",
    consumerGroup = "stock-consumer"
)
public class StockConsumer implements RocketMQListener<String> {
    
    @Autowired
    private StockService stockService;
    
    @Override
    public void onMessage(String message) {
        Order order = JSON.parseObject(message, Order.class);
        
        // æ‰£å‡åº“å­˜ï¼ˆä¿è¯å¹‚ç­‰æ€§ï¼‰
        stockService.deduct(order.getProductId(), order.getCount());
    }
}
```

### 6.3 å…¶ä»–MQçš„äº‹åŠ¡æ–¹æ¡ˆ


**Kafkaäº‹åŠ¡æ¶ˆæ¯**
```java
@Service
public class KafkaTransactionService {
    
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;
    
    /**
     * Kafkaäº‹åŠ¡æ¶ˆæ¯
     */
    public void sendInTransaction(Order order) {
        // å¼€å¯äº‹åŠ¡
        kafkaTemplate.executeInTransaction(operations -> {
            // 1. å‘é€æ¶ˆæ¯
            operations.send("order-topic", JSON.toJSONString(order));
            
            // 2. æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
            createOrder(order);
            
            // å¦‚æœæŠ›å¼‚å¸¸ï¼Œæ¶ˆæ¯å’Œæœ¬åœ°äº‹åŠ¡éƒ½å›æ»š
            return true;
        });
    }
}
```

**ğŸ“Š å¯¹æ¯”åˆ†æ**

| MQç±»å‹ | äº‹åŠ¡æ”¯æŒ | å›æŸ¥æœºåˆ¶ | æ€§èƒ½ | æ¨èåœºæ™¯ |
|--------|---------|---------|------|----------|
| **RocketMQ** | âœ… åŸç”Ÿæ”¯æŒ | âœ… è‡ªåŠ¨å›æŸ¥ | â­â­â­â­ | åˆ†å¸ƒå¼äº‹åŠ¡ |
| **Kafka** | âœ… æ”¯æŒ | âŒ æ— å›æŸ¥ | â­â­â­â­â­ | é«˜åååœºæ™¯ |
| **RabbitMQ** | âš ï¸ éœ€è¦è‡ªå·±å®ç° | âŒ æ— å›æŸ¥ | â­â­â­ | ä¸­å°å‹åº”ç”¨ |

---

## 7. ğŸ”” æœ€å¤§åŠªåŠ›é€šçŸ¥


### 7.1 ä»€ä¹ˆæ˜¯æœ€å¤§åŠªåŠ›é€šçŸ¥


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> å°±åƒå¿«é€’å‘˜é€å¿«é€’ï¼š
> - ç¬¬ä¸€æ¬¡é€ï¼šå®¶é‡Œæ²¡äºº
> - ç¬¬äºŒæ¬¡é€ï¼šè¿˜æ˜¯æ²¡äºº
> - ç¬¬ä¸‰æ¬¡é€ï¼šä»ç„¶æ²¡äºº
> - æœ€åï¼šæ”¾åœ¨é—¨å£ï¼Œå‘çŸ­ä¿¡é€šçŸ¥ï¼ˆå°½åŠ›è€Œä¸ºï¼‰

**ğŸ“‹ æ ¸å¿ƒç‰¹ç‚¹**
```
å®šä¹‰ï¼šå°½æœ€å¤§åŠªåŠ›å°†æ¶ˆæ¯é€šçŸ¥åˆ°ç›®æ ‡ç³»ç»Ÿ
ç‰¹ç‚¹ï¼š
1. å…è®¸æ¶ˆæ¯ä¸¢å¤±ï¼ˆä¸šåŠ¡å¯å®¹å¿ï¼‰
2. æœ‰é™æ¬¡æ•°é‡è¯•
3. ä¸»åŠ¨æŸ¥è¯¢è¡¥å¿æœºåˆ¶
```

### 7.2 å®ç°æœºåˆ¶


**ğŸ”„ é€šçŸ¥æµç¨‹**
```
ä¸šåŠ¡ç³»ç»ŸA              ä¸šåŠ¡ç³»ç»ŸB            å¯¹è´¦ç³»ç»Ÿ
    |                      |                    |
[1]æ‰§è¡Œä¸šåŠ¡               |                    |
    |                      |                    |
[2]å‘é€é€šçŸ¥ ------------->|                    |
    |                      |                    |
    |                  [3]å¤„ç†å¤±è´¥              |
    |                      |                    |
[4]è®°å½•å¤±è´¥ï¼Œå®šæ—¶é‡è¯•     |                    |
    |                      |                    |
[5]é‡è¯•3æ¬¡ -------------->|                    |
    |                      |                    |
    |                  [6]ä»ç„¶å¤±è´¥              |
    |                      |                    |
    |              [7]ä¸»åŠ¨æŸ¥è¯¢è¡¥å¿ ------------>|
    |                      |                    |
    |                      |            [8]è¿”å›æ•°æ®
    |                      |<-------------------|
```

**é‡è¯•ç­–ç•¥**
```
é‡è¯•æ¬¡æ•°ï¼šé€šå¸¸3-5æ¬¡
é‡è¯•é—´éš”ï¼š
â€¢ ç¬¬1æ¬¡ï¼šç«‹å³é‡è¯•
â€¢ ç¬¬2æ¬¡ï¼š1åˆ†é’Ÿå
â€¢ ç¬¬3æ¬¡ï¼š5åˆ†é’Ÿå  
â€¢ ç¬¬4æ¬¡ï¼š30åˆ†é’Ÿå
â€¢ ç¬¬5æ¬¡ï¼š1å°æ—¶å

è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼šäººå·¥ä»‹å…¥æˆ–å¯¹è´¦è¡¥å¿
```

### 7.3 ä»£ç å®ç°


**æ­¥éª¤1ï¼šé€šçŸ¥è¡¨è®¾è®¡**
```sql
CREATE TABLE notification_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    business_id VARCHAR(64) NOT NULL COMMENT 'ä¸šåŠ¡ID',
    notify_url VARCHAR(256) NOT NULL COMMENT 'é€šçŸ¥åœ°å€',
    notify_data TEXT COMMENT 'é€šçŸ¥æ•°æ®',
    max_retry INT DEFAULT 5 COMMENT 'æœ€å¤§é‡è¯•æ¬¡æ•°',
    retry_count INT DEFAULT 0 COMMENT 'å·²é‡è¯•æ¬¡æ•°',
    status TINYINT DEFAULT 0 COMMENT '0-å¾…é€šçŸ¥ 1-æˆåŠŸ 2-å¤±è´¥',
    next_notify_time DATETIME COMMENT 'ä¸‹æ¬¡é€šçŸ¥æ—¶é—´',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_status_time (status, next_notify_time)
);
```

**æ­¥éª¤2ï¼šå‘é€é€šçŸ¥**
```java
@Service
public class NotificationService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @Autowired
    private NotificationLogMapper logMapper;
    
    /**
     * å‘é€é€šçŸ¥
     */
    public void sendNotification(String businessId, String url, Object data) {
        // 1. è®°å½•é€šçŸ¥æ—¥å¿—
        NotificationLog log = new NotificationLog();
        log.setBusinessId(businessId);
        log.setNotifyUrl(url);
        log.setNotifyData(JSON.toJSONString(data));
        log.setNextNotifyTime(new Date());
        logMapper.insert(log);
        
        // 2. ç«‹å³å‘é€ç¬¬ä¸€æ¬¡
        doNotify(log);
    }
    
    /**
     * æ‰§è¡Œé€šçŸ¥
     */
    private void doNotify(NotificationLog log) {
        try {
            // å‘é€HTTPè¯·æ±‚
            ResponseEntity<String> response = restTemplate.postForEntity(
                log.getNotifyUrl(),
                log.getNotifyData(),
                String.class
            );
            
            // åˆ¤æ–­æ˜¯å¦æˆåŠŸ
            if (response.getStatusCode().is2xxSuccessful()) {
                // é€šçŸ¥æˆåŠŸ
                log.setStatus(1);
                logMapper.updateById(log);
            } else {
                // é€šçŸ¥å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•
                handleNotifyFail(log);
            }
            
        } catch (Exception e) {
            // å¼‚å¸¸ï¼Œå‡†å¤‡é‡è¯•
            handleNotifyFail(log);
        }
    }
    
    /**
     * å¤„ç†é€šçŸ¥å¤±è´¥
     */
    private void handleNotifyFail(NotificationLog log) {
        log.setRetryCount(log.getRetryCount() + 1);
        
        if (log.getRetryCount() >= log.getMaxRetry()) {
            // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ ‡è®°ä¸ºå¤±è´¥
            log.setStatus(2);
        } else {
            // è®¡ç®—ä¸‹æ¬¡é‡è¯•æ—¶é—´ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
            int delayMinutes = (int) Math.pow(2, log.getRetryCount());
            log.setNextNotifyTime(
                DateUtil.addMinutes(new Date(), delayMinutes)
            );
        }
        
        logMapper.updateById(log);
    }
}
```

**æ­¥éª¤3ï¼šå®šæ—¶é‡è¯•**
```java
@Component
public class NotificationRetryJob {
    
    @Autowired
    private NotificationService notificationService;
    
    /**
     * å®šæ—¶æ‰«æå¾…é‡è¯•çš„é€šçŸ¥
     */
    @Scheduled(fixedRate = 10000)  // æ¯10ç§’æ‰§è¡Œ
    public void retryNotification() {
        // æŸ¥è¯¢å¾…é‡è¯•çš„é€šçŸ¥
        List<NotificationLog> logs = logMapper.selectList(
            new LambdaQueryWrapper<NotificationLog>()
                .eq(NotificationLog::getStatus, 0)  // å¾…é€šçŸ¥
                .lt(NotificationLog::getNextNotifyTime, new Date())
                .last("LIMIT 50")
        );
        
        // æ‰¹é‡é‡è¯•
        logs.forEach(log -> {
            notificationService.doNotify(log);
        });
    }
}
```

**æ­¥éª¤4ï¼šä¸»åŠ¨æŸ¥è¯¢è¡¥å¿**
```java
@Service
public class ReconciliationService {
    
    @Autowired
    private NotificationLogMapper logMapper;
    
    @Autowired
    private RestTemplate restTemplate;
    
    /**
     * å¯¹è´¦ï¼šä¸»åŠ¨æŸ¥è¯¢æœªæˆåŠŸçš„é€šçŸ¥
     */
    @Scheduled(cron = "0 0 1 * * ?")  // æ¯å¤©å‡Œæ™¨1ç‚¹
    public void reconcile() {
        // 1. æŸ¥è¯¢è¶…è¿‡24å°æ—¶ä»æœªæˆåŠŸçš„é€šçŸ¥
        LocalDateTime yesterday = LocalDateTime.now().minusDays(1);
        List<NotificationLog> failedLogs = logMapper.selectList(
            new LambdaQueryWrapper<NotificationLog>()
                .eq(NotificationLog::getStatus, 0)
                .lt(NotificationLog::getCreateTime, yesterday)
        );
        
        // 2. ä¸»åŠ¨æŸ¥è¯¢ä¸šåŠ¡ç³»ç»ŸBçš„æ•°æ®
        for (NotificationLog log : failedLogs) {
            try {
                // è°ƒç”¨ä¸šåŠ¡ç³»ç»ŸBçš„æŸ¥è¯¢æ¥å£
                String queryUrl = log.getNotifyUrl() + "/query/" 
                    + log.getBusinessId();
                ResponseEntity<String> response = restTemplate.getForEntity(
                    queryUrl, String.class
                );
                
                // å¦‚æœæ•°æ®å·²å­˜åœ¨ï¼Œæ ‡è®°ä¸ºæˆåŠŸ
                if (response.getStatusCode().is2xxSuccessful()) {
                    log.setStatus(1);
                    logMapper.updateById(log);
                }
            } catch (Exception e) {
                // è®°å½•å¼‚å¸¸ï¼Œäººå·¥ä»‹å…¥
                log.setStatus(2);
                logMapper.updateById(log);
            }
        }
    }
}
```

### 7.4 å…¸å‹åº”ç”¨åœºæ™¯


**ğŸ¯ é€‚ç”¨åœºæ™¯**

**æ”¯ä»˜ç»“æœé€šçŸ¥**
```
ç¬¬ä¸‰æ–¹æ”¯ä»˜å›è°ƒå•†æˆ·ç³»ç»Ÿï¼š
1. æ”¯ä»˜æˆåŠŸåï¼Œæ”¯ä»˜å®å›è°ƒå•†æˆ·
2. å¦‚æœå•†æˆ·æœåŠ¡å™¨ç¹å¿™ï¼Œå›è°ƒå¤±è´¥
3. æ”¯ä»˜å®ä¼šé‡è¯•å¤šæ¬¡ï¼ˆ1minã€5minã€1hour...ï¼‰
4. å•†æˆ·ä¹Ÿå¯ä»¥ä¸»åŠ¨æŸ¥è¯¢æ”¯ä»˜ç»“æœ
```

**ç‰©æµçŠ¶æ€é€šçŸ¥**
```
ç‰©æµå…¬å¸é€šçŸ¥ç”µå•†å¹³å°ï¼š
1. åŒ…è£¹æ¯ä¸ªèŠ‚ç‚¹éƒ½é€šçŸ¥ç”µå•†
2. å°½åŠ›è€Œä¸ºï¼Œå…è®¸éƒ¨åˆ†é€šçŸ¥ä¸¢å¤±
3. ç”µå•†å¯ä»¥ä¸»åŠ¨æŸ¥è¯¢ç‰©æµè½¨è¿¹
```

**ğŸ“Š ä¼˜ç¼ºç‚¹åˆ†æ**

âœ… **ä¼˜ç‚¹**
- **å®ç°ç®€å•**ï¼šä¸éœ€è¦å¤æ‚çš„äº‹åŠ¡åè°ƒ
- **æ€§èƒ½å¥½**ï¼šå¼‚æ­¥é€šçŸ¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹
- **å®¹é”™æ€§å¼º**ï¼šé€šè¿‡é‡è¯•å’Œè¡¥å¿ä¿è¯æœ€ç»ˆä¸€è‡´

âŒ **ç¼ºç‚¹**
- **ä¸€è‡´æ€§å¼±**ï¼šå¯èƒ½å‡ºç°çŸ­æš‚ä¸ä¸€è‡´
- **éœ€è¦å¯¹è´¦**ï¼šè¦æœ‰è¡¥å¿æŸ¥è¯¢æœºåˆ¶
- **ä¸é€‚åˆå¼ºä¸€è‡´åœºæ™¯**ï¼šé‡‘èæ ¸å¿ƒä¸šåŠ¡ä¸é€‚ç”¨

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆé€‰å‹


**ğŸ¯ é€‰æ‹©å†³ç­–æ ‘**
```
æ˜¯å¦éœ€è¦å¼ºä¸€è‡´æ€§ï¼Ÿ
    |
    |--æ˜¯--> è·¨æ•°æ®åº“ï¼Ÿ
    |         |
    |         |--æ˜¯--> Seata ATæ¨¡å¼
    |         |
    |         |--å¦--> æœ¬åœ°äº‹åŠ¡
    |
    |--å¦--> å¯¹æ€§èƒ½è¦æ±‚é«˜ï¼Ÿ
              |
              |--æ˜¯--> æµç¨‹å¤æ‚ï¼Ÿ
              |         |
              |         |--æ˜¯--> Sagaæ¨¡å¼
              |         |
              |         |--å¦--> TCCæ¨¡å¼
              |
              |--å¦--> å…è®¸å»¶è¿Ÿï¼Ÿ
                        |
                        |--æ˜¯--> æ¶ˆæ¯é˜Ÿåˆ—
                        |
                        |--å¦--> æœ€å¤§åŠªåŠ›é€šçŸ¥
```

**ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“**

| æ–¹æ¡ˆ | ä¸€è‡´æ€§ | æ€§èƒ½ | å®ç°éš¾åº¦ | é€‚ç”¨åœºæ™¯ | æ ¸å¿ƒæ€æƒ³ |
|------|--------|------|----------|----------|----------|
| **Seata AT** | å¼ºä¸€è‡´ | â­â­â­ | â­â­ | è·¨åº“äº‹åŠ¡ | è‡ªåŠ¨è¡¥å¿ |
| **TCC** | æœ€ç»ˆä¸€è‡´ | â­â­â­â­ | â­â­â­â­ | é«˜æ€§èƒ½åœºæ™¯ | æ‰‹åŠ¨è¡¥å¿ |
| **Saga** | æœ€ç»ˆä¸€è‡´ | â­â­â­â­ | â­â­â­ | é•¿æµç¨‹ | çŠ¶æ€æœº |
| **æœ¬åœ°æ¶ˆæ¯è¡¨** | æœ€ç»ˆä¸€è‡´ | â­â­â­ | â­â­ | å¯é é€šçŸ¥ | å®šæ—¶ä»»åŠ¡ |
| **MQäº‹åŠ¡** | æœ€ç»ˆä¸€è‡´ | â­â­â­â­ | â­â­ | å¼‚æ­¥è§£è€¦ | åŠæ¶ˆæ¯ |
| **æœ€å¤§åŠªåŠ›é€šçŸ¥** | å¼±ä¸€è‡´ | â­â­â­â­â­ | â­ | å®¹å¿ä¸¢å¤± | é‡è¯•+å¯¹è´¦ |

### 8.2 å®æˆ˜å»ºè®®


**ğŸ”‘ å…³é”®è¦ç‚¹**

**1. å¹‚ç­‰æ€§è®¾è®¡**
```java
// æ‰€æœ‰åˆ†å¸ƒå¼äº‹åŠ¡æ“ä½œéƒ½è¦ä¿è¯å¹‚ç­‰
@Transactional
public void deductStock(String orderId, Long productId, Integer count) {
    // 1. æ£€æŸ¥æ˜¯å¦å·²ç»æ‰§è¡Œè¿‡
    if (isExecuted(orderId)) {
        return;  // å·²æ‰§è¡Œï¼Œç›´æ¥è¿”å›
    }
    
    // 2. æ‰§è¡Œä¸šåŠ¡æ“ä½œ
    stockMapper.deduct(productId, count);
    
    // 3. è®°å½•æ‰§è¡ŒçŠ¶æ€
    markExecuted(orderId);
}
```

**2. å¼‚å¸¸å¤„ç†**
```java
// è¦åŒºåˆ†ä¸šåŠ¡å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸
try {
    executeTransaction();
} catch (BusinessException e) {
    // ä¸šåŠ¡å¼‚å¸¸ï¼šå›æ»šäº‹åŠ¡
    throw e;
} catch (Exception e) {
    // ç³»ç»Ÿå¼‚å¸¸ï¼šè®°å½•æ—¥å¿—ï¼Œç¨åé‡è¯•
    log.error("ç³»ç»Ÿå¼‚å¸¸", e);
    scheduleRetry();
}
```

**3. ç›‘æ§å‘Šè­¦**
```
å¿…é¡»ç›‘æ§çš„æŒ‡æ ‡ï¼š
â€¢ äº‹åŠ¡æˆåŠŸç‡
â€¢ äº‹åŠ¡è€—æ—¶
â€¢ è¡¥å¿æ‰§è¡Œæ¬¡æ•°
â€¢ æ¶ˆæ¯ç§¯å‹æ•°é‡

å‘Šè­¦è§„åˆ™ï¼š
â€¢ æˆåŠŸç‡ < 95% â†’ å‘Šè­¦
â€¢ è€—æ—¶ > 3s â†’ å‘Šè­¦  
â€¢ è¡¥å¿æ¬¡æ•° > é˜ˆå€¼ â†’ å‘Šè­¦
```

### 8.3 é¿å‘æŒ‡å—


**âš ï¸ å¸¸è§é—®é¢˜**

**é—®é¢˜1ï¼šç©ºå›æ»š**
```
é—®é¢˜ï¼šTryæ²¡æ‰§è¡Œï¼ŒCancelå´æ‰§è¡Œäº†
åŸå› ï¼šç½‘ç»œè¶…æ—¶ï¼ŒTryè¯·æ±‚ä¸¢å¤±
è§£å†³ï¼šCancelå‰æ£€æŸ¥Tryæ˜¯å¦æ‰§è¡Œ
```

**é—®é¢˜2ï¼šæ‚¬æŒ‚**
```
é—®é¢˜ï¼šCancelå…ˆåˆ°ï¼ŒTryååˆ°
åŸå› ï¼šç½‘ç»œå»¶è¿Ÿå¯¼è‡´é¡ºåºé¢ å€’
è§£å†³ï¼šTryå‰æ£€æŸ¥Cancelæ˜¯å¦å·²æ‰§è¡Œ
```

**é—®é¢˜3ï¼šæ¶ˆæ¯é‡å¤æ¶ˆè´¹**
```
é—®é¢˜ï¼šåŒä¸€æ¶ˆæ¯è¢«å¤„ç†å¤šæ¬¡
åŸå› ï¼šæ¶ˆè´¹è€…æ•…éšœé‡å¯ï¼Œæ¶ˆæ¯é‡æ–°æŠ•é€’
è§£å†³ï¼šæ¶ˆè´¹ç«¯åšå¹‚ç­‰æ€§å¤„ç†
```

**é—®é¢˜4ï¼šæ¶ˆæ¯ä¸¢å¤±**
```
é—®é¢˜ï¼šæ¶ˆæ¯å‘é€å¤±è´¥
åŸå› ï¼šMQæ•…éšœã€ç½‘ç»œé—®é¢˜
è§£å†³ï¼šæœ¬åœ°æ¶ˆæ¯è¡¨ + å®šæ—¶è¡¥å¿
```

### 8.4 å­¦ä¹ è·¯å¾„


**ğŸ“š è¿›é˜¶å»ºè®®**

```
åˆçº§é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰ï¼š
âœ“ ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚å¿µ
âœ“ æŒæ¡CAPç†è®º
âœ“ å­¦ä¹ Seata ATæ¨¡å¼
âœ“ å®ç°ç®€å•çš„è®¢å•åœºæ™¯

ä¸­çº§é˜¶æ®µï¼ˆ1-2æœˆï¼‰ï¼š
âœ“ æ·±å…¥ç†è§£TCCæ¨¡å¼
âœ“ æŒæ¡SagaçŠ¶æ€æœº
âœ“ å­¦ä¹ æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡
âœ“ å®è·µç”µå•†å¤æ‚åœºæ™¯

é«˜çº§é˜¶æ®µï¼ˆ3-6æœˆï¼‰ï¼š
âœ“ åˆ†æå„æ–¹æ¡ˆæ€§èƒ½
âœ“ è®¾è®¡é«˜å¯ç”¨æ¶æ„
âœ“ ä¼˜åŒ–äº‹åŠ¡æ€§èƒ½
âœ“ å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
```

**ğŸ¯ ä¸€åˆ†é’ŸæŒæ¡**

**æ ¸å¿ƒè¦è®°ä½çš„3ç‚¹ï¼š**
1. **åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ¬è´¨**ï¼šç”¨è¡¥å¿æœºåˆ¶ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
2. **æ²¡æœ‰é“¶å¼¹**ï¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆ
3. **å…³é”®åœ¨äºå®¹é”™**ï¼šåšå¥½å¹‚ç­‰ã€é‡è¯•ã€ç›‘æ§ã€è¡¥å¿

**ğŸ’¡ è®°å¿†å£è¯€**
```
å¼ºä¸€è‡´ç”¨Seataï¼Œæ€§èƒ½é«˜ç”¨TCC
é•¿æµç¨‹ç”¨Sagaï¼Œå¼‚æ­¥ç”¨MQ
å¯é æ€§æœ¬åœ°è¡¨ï¼Œå®¹é”™ç”¨é€šçŸ¥
å¹‚ç­‰æ˜¯å…³é”®ï¼Œç›‘æ§ä¸èƒ½å°‘
```

**ğŸš€ å®è·µå»ºè®®**
- å…ˆä»ç®€å•åœºæ™¯å…¥æ‰‹ï¼ˆSeata ATæ¨¡å¼ï¼‰
- é€æ­¥ç†è§£å„ç§è¡¥å¿æœºåˆ¶
- é‡ç‚¹å…³æ³¨å¼‚å¸¸å¤„ç†å’Œå¹‚ç­‰æ€§
- åœ¨å®é™…é¡¹ç›®ä¸­å¤šå®è·µã€å¤šæ€»ç»“