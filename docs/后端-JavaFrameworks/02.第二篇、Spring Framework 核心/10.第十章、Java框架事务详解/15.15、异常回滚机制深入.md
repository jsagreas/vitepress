---
title: 15ã€å¼‚å¸¸å›æ»šæœºåˆ¶æ·±å…¥
---
## ğŸ“š ç›®å½•

1. [å¼‚å¸¸å›æ»šæœºåˆ¶æ¦‚è¿°](#1-å¼‚å¸¸å›æ»šæœºåˆ¶æ¦‚è¿°)
2. [Javaå¼‚å¸¸ä½“ç³»åŸºç¡€](#2-Javaå¼‚å¸¸ä½“ç³»åŸºç¡€)
3. [Springäº‹åŠ¡é»˜è®¤å›æ»šè§„åˆ™](#3-Springäº‹åŠ¡é»˜è®¤å›æ»šè§„åˆ™)
4. [rollbackForè‡ªå®šä¹‰å›æ»š](#4-rollbackForè‡ªå®šä¹‰å›æ»š)
5. [noRollbackForæ’é™¤å›æ»š](#5-noRollbackForæ’é™¤å›æ»š)
6. [å¼‚å¸¸ä¼ æ’­æœºåˆ¶](#6-å¼‚å¸¸ä¼ æ’­æœºåˆ¶)
7. [å¼‚å¸¸ç±»å‹åŒ¹é…è§„åˆ™](#7-å¼‚å¸¸ç±»å‹åŒ¹é…è§„åˆ™)
8. [å®æˆ˜æœ€ä½³å®è·µ](#8-å®æˆ˜æœ€ä½³å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å¼‚å¸¸å›æ»šæœºåˆ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å¼‚å¸¸å›æ»š


**é€šä¿—ç†è§£**ï¼šå°±åƒä½ åœ¨é“¶è¡Œè½¬è´¦ï¼Œè½¬åˆ°ä¸€åŠå‘ç°å‡ºé”™äº†ï¼Œé“¶è¡Œä¼šæŠŠè¿™ç¬”äº¤æ˜“å…¨éƒ¨å–æ¶ˆï¼Œè®©è´¦æˆ·å›åˆ°è½¬è´¦å‰çš„çŠ¶æ€ã€‚

```
æ­£å¸¸æµç¨‹ï¼š
å¼€å§‹äº‹åŠ¡ â†’ æ‰£æ¬¾ â†’ åŠ æ¬¾ â†’ æäº¤äº‹åŠ¡ âœ“

å‡ºç°å¼‚å¸¸ï¼š
å¼€å§‹äº‹åŠ¡ â†’ æ‰£æ¬¾ â†’ åŠ æ¬¾å¤±è´¥âŒ â†’ å›æ»šäº‹åŠ¡ï¼ˆæ‰£æ¬¾ä¹Ÿå–æ¶ˆï¼‰
```

**ä¸“ä¸šå®šä¹‰**ï¼š
- äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶ï¼ŒSpringä¼šæ ¹æ®**å¼‚å¸¸ç±»å‹**å†³å®šæ˜¯å¦å›æ»šäº‹åŠ¡
- å›æ»šæ“ä½œä¼šæ’¤é”€äº‹åŠ¡ä¸­æ‰€æœ‰å·²æ‰§è¡Œçš„æ•°æ®åº“æ“ä½œ
- ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å¼‚å¸¸å›æ»š


**å®é™…åœºæ™¯ä¸¾ä¾‹**ï¼š

```
è®¢å•æ”¯ä»˜åœºæ™¯ï¼š
æ­¥éª¤1ï¼šæ‰£å‡åº“å­˜ âœ“
æ­¥éª¤2ï¼šåˆ›å»ºè®¢å• âœ“
æ­¥éª¤3ï¼šæ‰£å‡ä½™é¢ âŒ å¤±è´¥äº†ï¼

å¦‚æœæ²¡æœ‰å›æ»šï¼š
- åº“å­˜è¢«æ‰£äº†
- è®¢å•åˆ›å»ºäº†
- ä½†é’±æ²¡æ‰£æˆåŠŸ
â†’ æ•°æ®ä¸ä¸€è‡´ï¼Œå•†å®¶äºäº†

æœ‰å¼‚å¸¸å›æ»šï¼š
- æ£€æµ‹åˆ°æ­¥éª¤3å¤±è´¥
- è‡ªåŠ¨æ’¤é”€æ­¥éª¤1å’Œæ­¥éª¤2
- ä¸€åˆ‡å›åˆ°åŸç‚¹
â†’ ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§
```

### 1.3 å›æ»šæœºåˆ¶çš„æ ¸å¿ƒä»·å€¼


| ä»·å€¼ç‚¹ | è¯´æ˜ | å®é™…æ„ä¹‰ |
|--------|------|----------|
| **æ•°æ®ä¸€è‡´æ€§** | è¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥ | é¿å…æ•°æ®å¤„äºä¸­é—´çŠ¶æ€ |
| **ä¸šåŠ¡å®Œæ•´æ€§** | ä¿è¯ä¸šåŠ¡é€»è¾‘çš„åŸå­æ€§ | ä¸€ä¸ªä¸šåŠ¡æ“ä½œä¸å¯åˆ†å‰² |
| **å¼‚å¸¸å®‰å…¨** | å¼‚å¸¸å‘ç”Ÿæ—¶è‡ªåŠ¨æ¸…ç† | ä¸éœ€è¦æ‰‹åŠ¨å†™å›æ»šä»£ç  |
| **ç®€åŒ–å¼€å‘** | æ¡†æ¶è‡ªåŠ¨å¤„ç†å›æ»šé€»è¾‘ | å¼€å‘è€…ä¸“æ³¨ä¸šåŠ¡ä»£ç  |

---

## 2. ğŸ“– Javaå¼‚å¸¸ä½“ç³»åŸºç¡€


### 2.1 Javaå¼‚å¸¸åˆ†ç±»


**å¼‚å¸¸å®¶æ—æ ‘**ï¼š

```
                    Throwableï¼ˆæ‰€æœ‰å¼‚å¸¸çš„ç¥–å…ˆï¼‰
                    /              \
                   /                \
              Error                Exceptionï¼ˆå¼‚å¸¸ï¼‰
           ï¼ˆç³»ç»Ÿé”™è¯¯ï¼‰              /          \
                                  /            \
                        RuntimeException    å…¶ä»–Exception
                        ï¼ˆè¿è¡Œæ—¶å¼‚å¸¸ï¼‰      ï¼ˆå—æ£€å¼‚å¸¸ï¼‰
                             |                  |
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                    |                 |   |           |
            NullPointerException  ArithmeticException  IOException  SQLException
            ï¼ˆç©ºæŒ‡é’ˆï¼‰            ï¼ˆç®—æœ¯å¼‚å¸¸ï¼‰        ï¼ˆIOå¼‚å¸¸ï¼‰  ï¼ˆSQLå¼‚å¸¸ï¼‰
```

### 2.2 å—æ£€å¼‚å¸¸ï¼ˆChecked Exceptionï¼‰


**ä»€ä¹ˆæ˜¯å—æ£€å¼‚å¸¸**ï¼š
- **é€šä¿—ç†è§£**ï¼šç¼–è¯‘å™¨ä¼š"æ£€æŸ¥"ä½ æœ‰æ²¡æœ‰å¤„ç†è¿™ä¸ªå¼‚å¸¸
- **å¿…é¡»å¤„ç†**ï¼šè¦ä¹ˆç”¨`try-catch`æ•è·ï¼Œè¦ä¹ˆç”¨`throws`å£°æ˜æŠ›å‡º
- **å…¸å‹ä»£è¡¨**ï¼š`IOException`ã€`SQLException`ã€`ClassNotFoundException`

**ä¸ºä»€ä¹ˆå«"å—æ£€"**ï¼š
```java
// ç¼–è¯‘å™¨ä¼šå¼ºåˆ¶ä½ å¤„ç†
public void readFile() {
    // âŒ ç¼–è¯‘é”™è¯¯ï¼å¿…é¡»å¤„ç†IOException
    FileReader reader = new FileReader("data.txt");
    
    // âœ… æ–¹å¼1ï¼šæ•è·å¤„ç†
    try {
        FileReader reader = new FileReader("data.txt");
    } catch (IOException e) {
        // å¤„ç†å¼‚å¸¸
    }
    
    // âœ… æ–¹å¼2ï¼šå£°æ˜æŠ›å‡º
    public void readFile() throws IOException {
        FileReader reader = new FileReader("data.txt");
    }
}
```

**å—æ£€å¼‚å¸¸ç‰¹ç‚¹**ï¼š

| ç‰¹ç‚¹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **å¯é¢„è§æ€§** | é€šå¸¸æ˜¯å¤–éƒ¨å› ç´ å¼•èµ·çš„ | æ–‡ä»¶ä¸å­˜åœ¨ã€ç½‘ç»œæ–­å¼€ |
| **å¯æ¢å¤æ€§** | ç¨‹åºå¯ä»¥é‡‡å–è¡¥æ•‘æªæ–½ | é‡è¯•ã€ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ |
| **å¼ºåˆ¶å¤„ç†** | ç¼–è¯‘æœŸå¿…é¡»æ˜¾å¼å¤„ç† | ä¸å¤„ç†æ— æ³•ç¼–è¯‘é€šè¿‡ |

### 2.3 éå—æ£€å¼‚å¸¸ï¼ˆUnchecked Exceptionï¼‰


**ä»€ä¹ˆæ˜¯éå—æ£€å¼‚å¸¸**ï¼š
- **é€šä¿—ç†è§£**ï¼šç¼–è¯‘å™¨ä¸å¼ºåˆ¶æ£€æŸ¥ï¼Œä½†è¿è¡Œæ—¶å¯èƒ½æŠ›å‡º
- **åŒ…æ‹¬ä¸¤ç±»**ï¼š`RuntimeException`åŠå…¶å­ç±»ã€`Error`
- **ä¸å¼ºåˆ¶å¤„ç†**ï¼šå¯ä»¥ä¸æ•è·ï¼Œä¸å£°æ˜

**è¿è¡Œæ—¶å¼‚å¸¸ï¼ˆRuntimeExceptionï¼‰**ï¼š

```java
// è¿™äº›ä»£ç ç¼–è¯‘é€šè¿‡ï¼Œä½†è¿è¡Œæ—¶ä¼šå‡ºé”™
public void demo() {
    // ç©ºæŒ‡é’ˆå¼‚å¸¸
    String str = null;
    str.length();  // NullPointerException
    
    // æ•°ç»„è¶Šç•Œ
    int[] arr = new int[5];
    arr[10] = 1;  // ArrayIndexOutOfBoundsException
    
    // ç®—æœ¯å¼‚å¸¸
    int result = 10 / 0;  // ArithmeticException
}
```

**éå—æ£€å¼‚å¸¸ç‰¹ç‚¹**ï¼š

| ç‰¹ç‚¹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **ç¼–ç¨‹é”™è¯¯** | é€šå¸¸æ˜¯ä»£ç bugå¯¼è‡´ | ç©ºæŒ‡é’ˆã€æ•°ç»„è¶Šç•Œ |
| **ä¸å¯é¢„è§** | ç¼–è¯‘æœŸæ— æ³•æ£€æµ‹ | è¿è¡Œæ—¶æ‰æš´éœ² |
| **åº”è¯¥ä¿®å¤** | åº”è¯¥ä¿®æ”¹ä»£ç é¿å… | è€Œä¸æ˜¯æ•è·å¤„ç† |

### 2.4 ä¸¤ç§å¼‚å¸¸çš„åŒºåˆ«


**è®°å¿†å£è¯€**ï¼š
```
å—æ£€å¼‚å¸¸ï¼šå¤–éƒ¨å› ç´ ï¼Œç¼–è¯‘æ£€æŸ¥ï¼Œå¿…é¡»å¤„ç†
è¿è¡Œæ—¶å¼‚å¸¸ï¼šä»£ç bugï¼Œè¿è¡Œæ‰çŸ¥ï¼Œåº”è¯¥ä¿®å¤
```

**å¯¹æ¯”æ€»ç»“**ï¼š

```
æ–‡ä»¶è¯»å–å¤±è´¥ï¼ˆå—æ£€å¼‚å¸¸ï¼‰ï¼š
åŸå› ï¼šæ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨ï¼ˆå¤–éƒ¨å› ç´ ï¼‰
å¤„ç†ï¼šæä¾›é»˜è®¤æ–‡ä»¶æˆ–æç¤ºç”¨æˆ·
â†’ è¿™æ˜¯å¯ä»¥é¢„è§å’Œå¤„ç†çš„

ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼ˆè¿è¡Œæ—¶å¼‚å¸¸ï¼‰ï¼š
åŸå› ï¼šä»£ç å†™é”™äº†ï¼Œæ²¡åˆ¤ç©ºï¼ˆç¼–ç¨‹é”™è¯¯ï¼‰
å¤„ç†ï¼šä¿®æ”¹ä»£ç ï¼ŒåŠ ä¸Šç©ºå€¼åˆ¤æ–­
â†’ è¿™åº”è¯¥åœ¨ä»£ç å±‚é¢é¿å…
```

---

## 3. ğŸ”§ Springäº‹åŠ¡é»˜è®¤å›æ»šè§„åˆ™


### 3.1 é»˜è®¤å›æ»šè§„åˆ™


**æ ¸å¿ƒè§„åˆ™**ï¼š
```
Springäº‹åŠ¡é»˜è®¤åªå¯¹ã€è¿è¡Œæ—¶å¼‚å¸¸ã€‘å’Œã€Errorã€‘è¿›è¡Œå›æ»š
å¯¹ã€å—æ£€å¼‚å¸¸ã€‘ä¸å›æ»š
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡**ï¼Ÿ

```
è®¾è®¡ç†å¿µï¼š
è¿è¡Œæ—¶å¼‚å¸¸ = ç¨‹åºbug = ä¸åº”è¯¥å‘ç”Ÿ = æ•°æ®å¯èƒ½ä¸ä¸€è‡´ 
â†’ å¿…é¡»å›æ»šä¿æŠ¤æ•°æ®

å—æ£€å¼‚å¸¸ = ä¸šåŠ¡å¼‚å¸¸ = å¯é¢„è§çš„æƒ…å†µ = å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†
â†’ äº¤ç»™å¼€å‘è€…å†³å®šè¦ä¸è¦å›æ»š
```

### 3.2 é»˜è®¤å›æ»šçš„å¼‚å¸¸ç±»å‹


**ä¼šè‡ªåŠ¨å›æ»š**ï¼š

| å¼‚å¸¸ç±»å‹ | è¯´æ˜ | å…¸å‹ç¤ºä¾‹ |
|---------|------|----------|
| `RuntimeException` | è¿è¡Œæ—¶å¼‚å¸¸ | `NullPointerException`ã€`ClassCastException` |
| `Error` | ç³»ç»Ÿé”™è¯¯ | `OutOfMemoryError`ã€`StackOverflowError` |
| ä»¥ä¸Šä¸¤è€…çš„å­ç±» | ç»§æ‰¿å…³ç³» | æ‰€æœ‰è‡ªå®šä¹‰è¿è¡Œæ—¶å¼‚å¸¸ |

**ä¸ä¼šè‡ªåŠ¨å›æ»š**ï¼š

| å¼‚å¸¸ç±»å‹ | è¯´æ˜ | å…¸å‹ç¤ºä¾‹ |
|---------|------|----------|
| `Exception`ï¼ˆé™¤Runtimeå¤–ï¼‰ | å—æ£€å¼‚å¸¸ | `IOException`ã€`SQLException` |
| è‡ªå®šä¹‰å—æ£€å¼‚å¸¸ | ç»§æ‰¿Exception | `BusinessException extends Exception` |

### 3.3 é»˜è®¤è§„åˆ™æ¼”ç¤º


```java
@Service
public class OrderService {
    
    @Transactional
    public void createOrder1() {
        // æ’å…¥è®¢å•æ•°æ®
        orderMapper.insert(order);
        
        // æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸
        throw new RuntimeException("å‡ºé”™äº†");
        // âœ… ä¼šå›æ»šï¼šè®¢å•æ•°æ®ä¼šè¢«æ’¤é”€
    }
    
    @Transactional
    public void createOrder2() throws IOException {
        // æ’å…¥è®¢å•æ•°æ®
        orderMapper.insert(order);
        
        // æŠ›å‡ºå—æ£€å¼‚å¸¸
        throw new IOException("æ–‡ä»¶è¯»å–å¤±è´¥");
        // âŒ ä¸ä¼šå›æ»šï¼šè®¢å•æ•°æ®å·²ä¿å­˜
    }
}
```

**å®é™…æ‰§è¡Œæ•ˆæœ**ï¼š

```
createOrder1æ‰§è¡Œï¼š
1. å¼€å§‹äº‹åŠ¡
2. æ’å…¥è®¢å•ï¼ˆSQLå·²æ‰§è¡Œï¼‰
3. æŠ›å‡ºRuntimeException
4. Springæ£€æµ‹åˆ°è¿è¡Œæ—¶å¼‚å¸¸ â†’ å›æ»š
5. è®¢å•æ•°æ®è¢«æ’¤é”€ âœ“

createOrder2æ‰§è¡Œï¼š
1. å¼€å§‹äº‹åŠ¡
2. æ’å…¥è®¢å•ï¼ˆSQLå·²æ‰§è¡Œï¼‰
3. æŠ›å‡ºIOException
4. Springæ£€æµ‹åˆ°å—æ£€å¼‚å¸¸ â†’ ä¸å›æ»š
5. äº‹åŠ¡æäº¤ï¼Œè®¢å•æ•°æ®ä¿å­˜ âœ“
```

### 3.4 ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§é»˜è®¤è§„åˆ™


**è®¾è®¡è€ƒè™‘**ï¼š

```
åœºæ™¯1ï¼šé‡åˆ°ç©ºæŒ‡é’ˆå¼‚å¸¸
â†’ è¿™æ˜¯ä»£ç bugï¼Œæ•°æ®æ“ä½œå¯èƒ½ä¸å®Œæ•´
â†’ åº”è¯¥å›æ»šï¼Œä¿æŠ¤æ•°æ®

åœºæ™¯2ï¼šè¯»å–é…ç½®æ–‡ä»¶å¤±è´¥ï¼ˆIOExceptionï¼‰
â†’ è¿™æ˜¯å¯é¢„è§çš„ä¸šåŠ¡æƒ…å†µ
â†’ å¯èƒ½éœ€è¦ç”¨é»˜è®¤é…ç½®ç»§ç»­
â†’ ä¸ä¸€å®šè¦å›æ»š

åœºæ™¯3ï¼šç”¨æˆ·ä½™é¢ä¸è¶³ï¼ˆè‡ªå®šä¹‰å—æ£€å¼‚å¸¸ï¼‰
â†’ è¿™æ˜¯æ­£å¸¸ä¸šåŠ¡é€»è¾‘
â†’ åº”è¯¥æç¤ºç”¨æˆ·ï¼Œè€Œä¸æ˜¯å›æ»š
â†’ è®©ä¸šåŠ¡ä»£ç è‡ªå·±å†³å®š
```

---

## 4. âš™ï¸ rollbackForè‡ªå®šä¹‰å›æ»š


### 4.1 ä»€ä¹ˆæ˜¯rollbackFor


**é€šä¿—è§£é‡Š**ï¼š
- **rollbackFor** = "é‡åˆ°è¿™äº›å¼‚å¸¸å°±å›æ»š"
- ç”¨æ¥**æ‰©å¤§**å›æ»šèŒƒå›´ï¼Œè®©å—æ£€å¼‚å¸¸ä¹Ÿèƒ½è§¦å‘å›æ»š

**ä¸ºä»€ä¹ˆéœ€è¦å®ƒ**ï¼Ÿ

```
é»˜è®¤è§„åˆ™çš„å±€é™ï¼š
åœºæ™¯ï¼šæ•°æ®åº“æ“ä½œå¤±è´¥æŠ›å‡ºSQLExceptionï¼ˆå—æ£€å¼‚å¸¸ï¼‰
é»˜è®¤ï¼šä¸å›æ»šï¼Œæ•°æ®å¯èƒ½ä¸ä¸€è‡´
éœ€æ±‚ï¼šå¸Œæœ›æ•°æ®åº“å¼‚å¸¸ä¹Ÿå›æ»š

è§£å†³ï¼šç”¨rollbackForæŒ‡å®šSQLExceptionä¹Ÿå›æ»š
```

### 4.2 ä½¿ç”¨æ–¹å¼


**åŸºæœ¬è¯­æ³•**ï¼š

```java
@Transactional(rollbackFor = å¼‚å¸¸ç±».class)
```

**å•ä¸ªå¼‚å¸¸æŒ‡å®š**ï¼š

```java
@Service
public class PaymentService {
    
    // æŒ‡å®šIOExceptionä¹Ÿè¦å›æ»š
    @Transactional(rollbackFor = IOException.class)
    public void processPayment() throws IOException {
        // æ‰£å‡ä½™é¢
        accountMapper.deduct(amount);
        
        // å†™å…¥æ”¯ä»˜æ—¥å¿—æ–‡ä»¶
        writePaymentLog();  // å¯èƒ½æŠ›å‡ºIOException
        
        // å¦‚æœIOExceptionå‘ç”Ÿï¼Œä½™é¢æ‰£å‡ä¼šè¢«å›æ»š
    }
}
```

**å¤šä¸ªå¼‚å¸¸æŒ‡å®š**ï¼š

```java
// æ–¹å¼1ï¼šæ•°ç»„å½¢å¼
@Transactional(rollbackFor = {
    IOException.class, 
    SQLException.class,
    CustomException.class
})
public void complexOperation() {
    // è¿™ä¸‰ç§å¼‚å¸¸éƒ½ä¼šè§¦å‘å›æ»š
}

// æ–¹å¼2ï¼šæŒ‡å®šçˆ¶ç±»ï¼ˆæ¨èï¼‰
@Transactional(rollbackFor = Exception.class)
public void safeOperation() {
    // æ‰€æœ‰ExceptionåŠå…¶å­ç±»éƒ½å›æ»š
}
```

### 4.3 rollbackForçš„å·¥ä½œåŸç†


**å¼‚å¸¸åŒ¹é…è¿‡ç¨‹**ï¼š

```
æ‰§è¡Œæµç¨‹ï¼š
1. æ–¹æ³•æŠ›å‡ºå¼‚å¸¸
2. Springæ£€æŸ¥å¼‚å¸¸ç±»å‹
3. åˆ¤æ–­æ˜¯å¦åŒ¹é…rollbackForæŒ‡å®šçš„ç±»å‹
4. åŒ¹é…æˆåŠŸ â†’ å›æ»š
   åŒ¹é…å¤±è´¥ â†’ æ£€æŸ¥é»˜è®¤è§„åˆ™
```

**ç±»å‹åŒ¹é…è§„åˆ™**ï¼š

```java
@Transactional(rollbackFor = IOException.class)
public void demo() {
    
    // âœ… æŠ›å‡ºIOException â†’ åŒ¹é…æˆåŠŸ â†’ å›æ»š
    throw new IOException();
    
    // âœ… æŠ›å‡ºIOExceptionçš„å­ç±» â†’ ä¹ŸåŒ¹é… â†’ å›æ»š
    throw new FileNotFoundException(); // ç»§æ‰¿IOException
    
    // âŒ æŠ›å‡ºå…¶ä»–å—æ£€å¼‚å¸¸ â†’ ä¸åŒ¹é… â†’ ä¸å›æ»š
    throw new SQLException();
}
```

### 4.4 å¸¸ç”¨é…ç½®åœºæ™¯


**åœºæ™¯1ï¼šæ‰€æœ‰å¼‚å¸¸éƒ½å›æ»š**

```java
@Transactional(rollbackFor = Exception.class)
public void criticalOperation() {
    // æ— è®ºä»€ä¹ˆå¼‚å¸¸éƒ½å›æ»šï¼Œæœ€å®‰å…¨
}
```

**åœºæ™¯2ï¼šæ•°æ®åº“æ“ä½œå›æ»š**

```java
@Transactional(rollbackFor = SQLException.class)
public void databaseOperation() {
    // SQLå¼‚å¸¸å¿…é¡»å›æ»š
}
```

**åœºæ™¯3ï¼šä¸šåŠ¡å¼‚å¸¸å›æ»š**

```java
@Transactional(rollbackFor = BusinessException.class)
public void businessLogic() {
    // è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸ä¹Ÿå›æ»š
}
```

### 4.5 å®æˆ˜æ¡ˆä¾‹


**è®¢å•åˆ›å»ºåœºæ™¯**ï¼š

```java
@Service
public class OrderService {
    
    @Transactional(rollbackFor = Exception.class)
    public void createOrder(Order order) throws Exception {
        
        // æ­¥éª¤1ï¼šæ‰£å‡åº“å­˜
        stockMapper.reduce(order.getProductId(), order.getQuantity());
        
        // æ­¥éª¤2ï¼šåˆ›å»ºè®¢å•
        orderMapper.insert(order);
        
        // æ­¥éª¤3ï¼šå‘é€é€šçŸ¥ï¼ˆå¯èƒ½IOExceptionï¼‰
        notifyUser(order);  // å¦‚æœå¤±è´¥ï¼Œå‰é¢æ“ä½œéƒ½å›æ»š
    }
}
```

**ä¸ºä»€ä¹ˆè¦åŠ rollbackFor**ï¼š
```
å¦‚æœä¸åŠ rollbackFor = Exception.classï¼š
â†’ notifyUseræŠ›å‡ºIOExceptionï¼ˆå—æ£€å¼‚å¸¸ï¼‰
â†’ é»˜è®¤ä¸å›æ»š
â†’ åº“å­˜å·²æ‰£ï¼Œè®¢å•å·²åˆ›å»ºï¼Œä½†é€šçŸ¥å¤±è´¥
â†’ ç”¨æˆ·æ²¡æ”¶åˆ°é€šçŸ¥ï¼Œè®¢å•å´ç”Ÿæˆäº†

åŠ ä¸ŠrollbackFor = Exception.classï¼š
â†’ ä»»ä½•å¼‚å¸¸éƒ½å›æ»š
â†’ ä¿è¯è¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
â†’ æ•°æ®ä¸€è‡´æ€§å¾—åˆ°ä¿éšœ
```

---

## 5. ğŸš« noRollbackForæ’é™¤å›æ»š


### 5.1 ä»€ä¹ˆæ˜¯noRollbackFor


**é€šä¿—è§£é‡Š**ï¼š
- **noRollbackFor** = "é‡åˆ°è¿™äº›å¼‚å¸¸ä¸è¦å›æ»š"
- ç”¨æ¥**ç¼©å°**å›æ»šèŒƒå›´ï¼Œè®©æŸäº›å¼‚å¸¸ä¸è§¦å‘å›æ»š

**ä¸ºä»€ä¹ˆéœ€è¦å®ƒ**ï¼Ÿ

```
åœºæ™¯ï¼šè®°å½•ç”¨æˆ·è¡Œä¸ºæ—¥å¿—
éœ€æ±‚ï¼šå³ä½¿æ—¥å¿—è®°å½•å¤±è´¥ï¼Œä¸»ä¸šåŠ¡ä¹Ÿè¦æˆåŠŸ

é—®é¢˜ï¼šå¦‚æœæ—¥å¿—å¤±è´¥æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸
é»˜è®¤ï¼šä¼šå›æ»šæ•´ä¸ªäº‹åŠ¡ï¼Œä¸»ä¸šåŠ¡ä¹Ÿå¤±è´¥äº†

è§£å†³ï¼šç”¨noRollbackForæ’é™¤æ—¥å¿—å¼‚å¸¸
```

### 5.2 ä½¿ç”¨æ–¹å¼


**åŸºæœ¬è¯­æ³•**ï¼š

```java
@Transactional(noRollbackFor = å¼‚å¸¸ç±».class)
```

**å•ä¸ªå¼‚å¸¸æ’é™¤**ï¼š

```java
@Service
public class UserService {
    
    // æ—¥å¿—å¼‚å¸¸ä¸å›æ»š
    @Transactional(noRollbackFor = LogException.class)
    public void registerUser(User user) {
        
        // æ ¸å¿ƒä¸šåŠ¡ï¼šä¿å­˜ç”¨æˆ·
        userMapper.insert(user);
        
        // è¾…åŠ©åŠŸèƒ½ï¼šè®°å½•æ—¥å¿—
        try {
            logService.recordAction("æ³¨å†Œ", user.getId());
        } catch (LogException e) {
            // æ—¥å¿—å¤±è´¥ä¸å½±å“æ³¨å†Œ
            // äº‹åŠ¡ä¸ä¼šå›æ»šï¼Œç”¨æˆ·ä¿å­˜æˆåŠŸ
        }
    }
}
```

**å¤šä¸ªå¼‚å¸¸æ’é™¤**ï¼š

```java
@Transactional(noRollbackFor = {
    LogException.class,
    NotificationException.class,
    CacheException.class
})
public void businessOperation() {
    // è¿™ä¸‰ç§å¼‚å¸¸éƒ½ä¸ä¼šè§¦å‘å›æ»š
}
```

### 5.3 noRollbackForçš„åº”ç”¨åœºæ™¯


**åœºæ™¯1ï¼šè¾…åŠ©åŠŸèƒ½å¤±è´¥ä¸å½±å“ä¸»ä¸šåŠ¡**

```java
@Transactional(noRollbackFor = NotificationException.class)
public void placeOrder(Order order) {
    
    // ä¸»ä¸šåŠ¡ï¼šåˆ›å»ºè®¢å•ï¼ˆå¿…é¡»æˆåŠŸï¼‰
    orderMapper.insert(order);
    
    // è¾…åŠ©åŠŸèƒ½ï¼šå‘é€é€šçŸ¥ï¼ˆå¤±è´¥æ— æ‰€è°“ï¼‰
    try {
        smsService.sendOrderNotification(order);
    } catch (NotificationException e) {
        log.error("é€šçŸ¥å‘é€å¤±è´¥", e);
        // ä¸å›æ»šï¼Œè®¢å•ä¾ç„¶åˆ›å»ºæˆåŠŸ
    }
}
```

**åœºæ™¯2ï¼šç¼“å­˜æ›´æ–°å¤±è´¥**

```java
@Transactional(noRollbackFor = CacheException.class)
public void updateUserInfo(User user) {
    
    // ä¸»ä¸šåŠ¡ï¼šæ›´æ–°æ•°æ®åº“
    userMapper.update(user);
    
    // è¾…åŠ©åŠŸèƒ½ï¼šæ›´æ–°ç¼“å­˜
    try {
        cacheService.updateUser(user);
    } catch (CacheException e) {
        // ç¼“å­˜å¤±è´¥ä¸å›æ»šï¼Œä¸‹æ¬¡æŸ¥è¯¢ä¼šé‡æ–°åŠ è½½
    }
}
```

### 5.4 rollbackForå’ŒnoRollbackForç»„åˆä½¿ç”¨


**åŒæ—¶é…ç½®çš„å¤„ç†è§„åˆ™**ï¼š

```
ä¼˜å…ˆçº§ï¼šnoRollbackFor > rollbackFor

è§„åˆ™ï¼š
1. å…ˆæ£€æŸ¥æ˜¯å¦åœ¨noRollbackForä¸­ â†’ æ˜¯åˆ™ä¸å›æ»š
2. å†æ£€æŸ¥æ˜¯å¦åœ¨rollbackForä¸­ â†’ æ˜¯åˆ™å›æ»š
3. æœ€åä½¿ç”¨é»˜è®¤è§„åˆ™
```

**ç»„åˆæ¡ˆä¾‹**ï¼š

```java
@Transactional(
    rollbackFor = Exception.class,          // æ‰€æœ‰å¼‚å¸¸éƒ½å›æ»š
    noRollbackFor = NotificationException.class  // é™¤äº†é€šçŸ¥å¼‚å¸¸
)
public void processOrder(Order order) {
    
    // ä»»ä½•å¼‚å¸¸éƒ½å›æ»š
    orderMapper.insert(order);
    paymentService.deduct(order.getAmount());
    
    // é€šçŸ¥å¼‚å¸¸ä¸å›æ»š
    notificationService.send(order);
}
```

**æ‰§è¡Œæ•ˆæœ**ï¼š

```
åœºæ™¯1ï¼špaymentServiceæŠ›å‡ºRuntimeException
â†’ æ£€æŸ¥noRollbackForï¼šä¸åŒ¹é…
â†’ æ£€æŸ¥rollbackForï¼šåŒ¹é…Exception
â†’ å›æ»š âœ“

åœºæ™¯2ï¼šnotificationServiceæŠ›å‡ºNotificationException
â†’ æ£€æŸ¥noRollbackForï¼šåŒ¹é…
â†’ ä¸å›æ»š âœ“
â†’ è®¢å•å’Œæ”¯ä»˜éƒ½ä¿å­˜æˆåŠŸ

åœºæ™¯3ï¼šnotificationServiceæŠ›å‡ºå…¶ä»–Exception
â†’ æ£€æŸ¥noRollbackForï¼šä¸åŒ¹é…
â†’ æ£€æŸ¥rollbackForï¼šåŒ¹é…Exception
â†’ å›æ»š âœ“
```

### 5.5 ä½¿ç”¨æ³¨æ„äº‹é¡¹


**âš ï¸ å¸¸è§è¯¯åŒº**ï¼š

```java
// âŒ é”™è¯¯ç”¨æ³•ï¼šå¼‚å¸¸è¢«åæ‰äº†
@Transactional(noRollbackFor = LogException.class)
public void wrongUsage() {
    userMapper.insert(user);
    
    // é—®é¢˜ï¼šå¼‚å¸¸è¢«catchäº†ï¼ŒSpringæ ¹æœ¬æ£€æµ‹ä¸åˆ°
    try {
        logService.record();
    } catch (LogException e) {
        // å·²è¢«æ•è·ï¼ŒnoRollbackForä¸èµ·ä½œç”¨
    }
}

// âœ… æ­£ç¡®ç”¨æ³•ï¼šè®©å¼‚å¸¸æŠ›å‡º
@Transactional(noRollbackFor = LogException.class)
public void correctUsage() {
    userMapper.insert(user);
    
    logService.record();  // è®©å¼‚å¸¸è‡ªç„¶æŠ›å‡º
    // Springèƒ½æ£€æµ‹åˆ°å¼‚å¸¸ï¼ŒnoRollbackForæ‰ç”Ÿæ•ˆ
}
```

---

## 6. ğŸ”„ å¼‚å¸¸ä¼ æ’­æœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯å¼‚å¸¸ä¼ æ’­


**é€šä¿—ç†è§£**ï¼š
- å¼‚å¸¸å°±åƒ"æ¥åŠ›æ£’"ï¼Œä»ä¸€ä¸ªæ–¹æ³•ä¼ é€’åˆ°å¦ä¸€ä¸ªæ–¹æ³•
- å¦‚æœæ–¹æ³•ä¸å¤„ç†å¼‚å¸¸ï¼Œå°±ä¼šå‘ä¸Šä¼ é€’ç»™è°ƒç”¨è€…

**ä¼ æ’­è·¯å¾„ç¤ºæ„**ï¼š

```
æ–¹æ³•è°ƒç”¨é“¾ï¼š
A() â†’ B() â†’ C() â†’ D()

å¼‚å¸¸ä¼ æ’­ï¼š
D()æŠ›å‡ºå¼‚å¸¸ â†’ C()æ²¡å¤„ç†ï¼Œå‘ä¸ŠæŠ› â†’ B()æ²¡å¤„ç†ï¼Œå‘ä¸ŠæŠ› â†’ A()å¤„ç†
```

### 6.2 äº‹åŠ¡æ–¹æ³•çš„å¼‚å¸¸ä¼ æ’­


**å…³é”®è§„åˆ™**ï¼š
```
äº‹åŠ¡æ–¹æ³•å¿…é¡»è®©å¼‚å¸¸"ä¼ æ’­å‡ºå»"ï¼ŒSpringæ‰èƒ½æ£€æµ‹åˆ°å¹¶å›æ»š
å¦‚æœå¼‚å¸¸è¢«æ•è·ï¼ŒSpringçœ‹ä¸åˆ°ï¼Œå°±ä¸ä¼šå›æ»š
```

**åœºæ™¯æ¼”ç¤º**ï¼š

```java
@Service
public class OrderService {
    
    // åœºæ™¯1ï¼šå¼‚å¸¸è¢«æ•è· - ä¸ä¼šå›æ»š
    @Transactional
    public void createOrder1() {
        orderMapper.insert(order);
        
        try {
            // åº“å­˜ä¸è¶³ï¼ŒæŠ›å‡ºå¼‚å¸¸
            stockService.reduce(productId, quantity);
        } catch (Exception e) {
            log.error("æ‰£åº“å­˜å¤±è´¥", e);
            // âŒ å¼‚å¸¸è¢«åƒæ‰äº†ï¼ŒSpringæ£€æµ‹ä¸åˆ°
        }
        // ç»“æœï¼šè®¢å•åˆ›å»ºäº†ï¼Œä½†åº“å­˜æ²¡æ‰£ â†’ æ•°æ®ä¸ä¸€è‡´
    }
    
    // åœºæ™¯2ï¼šå¼‚å¸¸å‘ä¸ŠæŠ› - ä¼šå›æ»š
    @Transactional
    public void createOrder2() throws Exception {
        orderMapper.insert(order);
        
        // åº“å­˜ä¸è¶³ï¼ŒæŠ›å‡ºå¼‚å¸¸
        stockService.reduce(productId, quantity);
        // âœ… å¼‚å¸¸å‘ä¸Šä¼ æ’­ï¼ŒSpringæ£€æµ‹åˆ°
        // ç»“æœï¼šæ•´ä¸ªäº‹åŠ¡å›æ»šï¼Œè®¢å•å’Œåº“å­˜éƒ½æ’¤é”€
    }
}
```

### 6.3 åµŒå¥—è°ƒç”¨çš„å¼‚å¸¸ä¼ æ’­


**å¤šå±‚è°ƒç”¨åœºæ™¯**ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private PaymentService paymentService;
    
    @Transactional(rollbackFor = Exception.class)
    public void placeOrder(Order order) throws Exception {
        // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
        orderMapper.insert(order);
        
        // æ­¥éª¤2ï¼šè°ƒç”¨æ”¯ä»˜æœåŠ¡
        paymentService.pay(order.getAmount());
        // å¦‚æœæ”¯ä»˜å¤±è´¥ï¼Œå¼‚å¸¸ä¼šä¼ æ’­åˆ°è¿™é‡Œ
    }
}

@Service  
public class PaymentService {
    
    public void pay(BigDecimal amount) throws PaymentException {
        if (balance < amount) {
            // ä½™é¢ä¸è¶³ï¼ŒæŠ›å‡ºå¼‚å¸¸
            throw new PaymentException("ä½™é¢ä¸è¶³");
        }
        accountMapper.deduct(amount);
    }
}
```

**ä¼ æ’­æµç¨‹**ï¼š

```
æ‰§è¡Œé¡ºåºï¼š
1. placeOrderå¼€å§‹ â†’ å¼€å¯äº‹åŠ¡
2. æ’å…¥è®¢å•æˆåŠŸ
3. è°ƒç”¨payæ–¹æ³•
4. payæ£€æŸ¥ä½™é¢ä¸è¶³
5. payæŠ›å‡ºPaymentException
6. å¼‚å¸¸ä¼ æ’­åˆ°placeOrder
7. placeOrderçš„@Transactionalæ£€æµ‹åˆ°å¼‚å¸¸
8. è§¦å‘äº‹åŠ¡å›æ»š
9. è®¢å•æ’å…¥è¢«æ’¤é”€
```

### 6.4 å¼‚å¸¸æ•è·çš„æ­£ç¡®å§¿åŠ¿


**âŒ é”™è¯¯åšæ³•ï¼šåæ‰å¼‚å¸¸**

```java
@Transactional
public void badPractice() {
    try {
        orderMapper.insert(order);
        stockMapper.reduce(productId, quantity);
    } catch (Exception e) {
        log.error("æ“ä½œå¤±è´¥", e);
        // å¼‚å¸¸è¢«åæ‰ï¼Œäº‹åŠ¡ä¸ä¼šå›æ»š
    }
}
```

**âœ… æ­£ç¡®åšæ³•1ï¼šé‡æ–°æŠ›å‡º**

```java
@Transactional
public void goodPractice1() throws Exception {
    try {
        orderMapper.insert(order);
        stockMapper.reduce(productId, quantity);
    } catch (Exception e) {
        log.error("æ“ä½œå¤±è´¥", e);
        throw e;  // é‡æ–°æŠ›å‡ºï¼Œè®©äº‹åŠ¡å›æ»š
    }
}
```

**âœ… æ­£ç¡®åšæ³•2ï¼šæ‰‹åŠ¨å›æ»š**

```java
@Transactional
public void goodPractice2() {
    try {
        orderMapper.insert(order);
        stockMapper.reduce(productId, quantity);
    } catch (Exception e) {
        log.error("æ“ä½œå¤±è´¥", e);
        // æ‰‹åŠ¨æ ‡è®°å›æ»š
        TransactionAspectSupport.currentTransactionStatus()
            .setRollbackOnly();
    }
}
```

**âœ… æ­£ç¡®åšæ³•3ï¼šåŒ…è£…åæŠ›å‡º**

```java
@Transactional
public void goodPractice3() {
    try {
        orderMapper.insert(order);
        stockMapper.reduce(productId, quantity);
    } catch (Exception e) {
        log.error("æ“ä½œå¤±è´¥", e);
        // åŒ…è£…æˆè¿è¡Œæ—¶å¼‚å¸¸æŠ›å‡º
        throw new BusinessException("è®¢å•åˆ›å»ºå¤±è´¥", e);
    }
}
```

### 6.5 å¼‚å¸¸ä¼ æ’­é“¾è·¯è¿½è¸ª


**å®é™…æ¡ˆä¾‹**ï¼š

```java
// Controllerå±‚
@RestController
public class OrderController {
    
    public Result createOrder(OrderDTO dto) {
        try {
            orderService.create(dto);  // â‘¢ å¼‚å¸¸ä¼ åˆ°è¿™é‡Œ
            return Result.success();
        } catch (Exception e) {
            return Result.error(e.getMessage());
        }
    }
}

// Serviceå±‚
@Service
public class OrderService {
    
    @Transactional(rollbackFor = Exception.class)
    public void create(OrderDTO dto) throws Exception {
        orderMapper.insert(order);
        paymentService.deduct(dto.getAmount());  // â‘¡ å¼‚å¸¸ç»§ç»­ä¸ŠæŠ›
    }
}

// åº•å±‚Service
@Service
public class PaymentService {
    
    public void deduct(BigDecimal amount) throws PaymentException {
        if (balance < amount) {
            throw new PaymentException("ä½™é¢ä¸è¶³");  // â‘  å¼‚å¸¸èµ·ç‚¹
        }
    }
}
```

**å¼‚å¸¸ä¼ æ’­é“¾**ï¼š

```
PaymentService.deduct()
    â†“ æŠ›å‡º PaymentException
OrderService.create()
    â†“ æ£€æµ‹åˆ°å¼‚å¸¸ â†’ è§¦å‘äº‹åŠ¡å›æ»š â†’ ç»§ç»­ä¸ŠæŠ›
OrderController.createOrder()
    â†“ æ•è·å¼‚å¸¸ â†’ è¿”å›é”™è¯¯ä¿¡æ¯
```

---

## 7. ğŸ¯ å¼‚å¸¸ç±»å‹åŒ¹é…è§„åˆ™


### 7.1 ç²¾ç¡®åŒ¹é…


**è§„åˆ™**ï¼šæŠ›å‡ºçš„å¼‚å¸¸ç±»å‹**å®Œå…¨ç›¸åŒ**

```java
@Transactional(rollbackFor = IOException.class)
public void demo() {
    
    // âœ… ç²¾ç¡®åŒ¹é…ï¼šæŠ›å‡ºIOException
    throw new IOException();  // å›æ»š
    
    // âŒ ä¸åŒ¹é…ï¼šæŠ›å‡ºå…¶ä»–å¼‚å¸¸
    throw new SQLException();  // ä¸å›æ»š
}
```

### 7.2 ç»§æ‰¿åŒ¹é…ï¼ˆå‘ä¸‹åŒ¹é…ï¼‰


**è§„åˆ™**ï¼šæŠ›å‡ºçš„æ˜¯æŒ‡å®šå¼‚å¸¸çš„**å­ç±»**ä¹ŸåŒ¹é…

```java
@Transactional(rollbackFor = IOException.class)
public void demo() {
    
    // âœ… IOExceptionçš„å­ç±»ä¹ŸåŒ¹é…
    throw new FileNotFoundException();  // å›æ»š
    throw new EOFException();           // å›æ»š
    throw new SocketException();        // å›æ»š
}
```

**ç»§æ‰¿å…³ç³»å›¾**ï¼š

```
                IOException
                    |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |           |           |
  FileNotFoundException  EOFException  SocketException
  
é…ç½®rollbackFor = IOException.class
â†’ ä»¥ä¸Š4ç§å¼‚å¸¸éƒ½ä¼šè§¦å‘å›æ»š
```

### 7.3 ä¸æ”¯æŒå‘ä¸ŠåŒ¹é…


**è§„åˆ™**ï¼šæŠ›å‡ºçš„æ˜¯æŒ‡å®šå¼‚å¸¸çš„**çˆ¶ç±»**ä¸åŒ¹é…

```java
@Transactional(rollbackFor = FileNotFoundException.class)
public void demo() {
    
    // âœ… æŠ›å‡ºFileNotFoundException â†’ åŒ¹é…
    throw new FileNotFoundException();  // å›æ»š
    
    // âŒ æŠ›å‡ºçˆ¶ç±»IOException â†’ ä¸åŒ¹é…
    throw new IOException();  // ä¸å›æ»šï¼ˆæŒ‰é»˜è®¤è§„åˆ™ï¼‰
}
```

### 7.4 å¤šå¼‚å¸¸åŒ¹é…è§„åˆ™


**è§„åˆ™**ï¼šåªè¦åŒ¹é…**ä»»æ„ä¸€ä¸ª**å°±è§¦å‘

```java
@Transactional(rollbackFor = {
    IOException.class,
    SQLException.class,
    CustomException.class
})
public void demo() {
    
    // ä¸‰é€‰ä¸€åŒ¹é…å³å¯
    throw new IOException();      // âœ… å›æ»š
    throw new SQLException();     // âœ… å›æ»š  
    throw new CustomException();  // âœ… å›æ»š
    throw new RuntimeException(); // âœ… å›æ»šï¼ˆé»˜è®¤è§„åˆ™ï¼‰
}
```

### 7.5 rollbackForå’ŒnoRollbackForåŒæ—¶åŒ¹é…


**è§„åˆ™**ï¼š`noRollbackFor`ä¼˜å…ˆçº§æ›´é«˜

```java
@Transactional(
    rollbackFor = Exception.class,
    noRollbackFor = BusinessException.class
)
public void demo() {
    
    // BusinessExceptionï¼šåŒæ—¶åŒ¹é…ä¸¤ä¸ªé…ç½®
    throw new BusinessException();
    // ç»“æœï¼šnoRollbackForä¼˜å…ˆ â†’ ä¸å›æ»š
}
```

**å†³ç­–æ ‘**ï¼š

```
æŠ›å‡ºå¼‚å¸¸
    â†“
æ£€æŸ¥æ˜¯å¦åŒ¹é…noRollbackForï¼Ÿ
    â”œâ”€ æ˜¯ â†’ ä¸å›æ»š âœ“
    â””â”€ å¦ â†’ ç»§ç»­
              â†“
        æ£€æŸ¥æ˜¯å¦åŒ¹é…rollbackForï¼Ÿ
            â”œâ”€ æ˜¯ â†’ å›æ»š âœ“
            â””â”€ å¦ â†’ ä½¿ç”¨é»˜è®¤è§„åˆ™
                      â†“
                æ˜¯RuntimeExceptionæˆ–Errorï¼Ÿ
                    â”œâ”€ æ˜¯ â†’ å›æ»š âœ“
                    â””â”€ å¦ â†’ ä¸å›æ»š âœ“
```

### 7.6 å®æˆ˜åŒ¹é…æ¡ˆä¾‹


**æ¡ˆä¾‹1ï¼šä¸šåŠ¡å¼‚å¸¸ä½“ç³»**

```java
// å¼‚å¸¸ç»§æ‰¿ä½“ç³»
class BusinessException extends RuntimeException { }
class OrderException extends BusinessException { }
class PaymentException extends BusinessException { }

// äº‹åŠ¡é…ç½®
@Transactional(noRollbackFor = BusinessException.class)
public void processOrder() {
    
    // OrderExceptionæ˜¯BusinessExceptionçš„å­ç±»
    throw new OrderException();
    // ç»“æœï¼šåŒ¹é…noRollbackFor â†’ ä¸å›æ»š
    
    // PaymentExceptionæ˜¯BusinessExceptionçš„å­ç±»
    throw new PaymentException();
    // ç»“æœï¼šåŒ¹é…noRollbackFor â†’ ä¸å›æ»š
}
```

**æ¡ˆä¾‹2ï¼šå¼‚å¸¸å±‚æ¬¡åŒ¹é…**

```java
@Transactional(
    rollbackFor = Exception.class,
    noRollbackFor = {LogException.class, NotificationException.class}
)
public void complexOperation() {
    
    // SQLExceptionæ˜¯Exceptionçš„å­ç±»
    throw new SQLException();
    // åŒ¹é…rollbackFor â†’ å›æ»š âœ“
    
    // LogExceptionåœ¨noRollbackForä¸­
    throw new LogException();
    // åŒ¹é…noRollbackFor â†’ ä¸å›æ»š âœ“
    
    // IOExceptionæ˜¯Exceptionçš„å­ç±»ï¼Œä¸åœ¨noRollbackForä¸­
    throw new IOException();
    // åŒ¹é…rollbackFor â†’ å›æ»š âœ“
}
```

---

## 8. ğŸ’¼ å®æˆ˜æœ€ä½³å®è·µ


### 8.1 æ¨èé…ç½®æ¨¡å¼


**æ¨¡å¼1ï¼šæœ€å®‰å…¨æ¨¡å¼**

```java
// æ‰€æœ‰å¼‚å¸¸éƒ½å›æ»šï¼Œæœ€ä¿é™©
@Transactional(rollbackFor = Exception.class)
public void criticalOperation() {
    // é€‚ç”¨åœºæ™¯ï¼šæ ¸å¿ƒä¸šåŠ¡ï¼Œä¸å®¹æœ‰å¤±
}
```

**æ¨¡å¼2ï¼šä¸»è¾…åˆ†ç¦»æ¨¡å¼**

```java
// ä¸»ä¸šåŠ¡å¼‚å¸¸å›æ»šï¼Œè¾…åŠ©åŠŸèƒ½å¼‚å¸¸ä¸å›æ»š
@Transactional(
    rollbackFor = Exception.class,
    noRollbackFor = {LogException.class, NotificationException.class}
)
public void businessWithAuxiliary() {
    // ä¸»ä¸šåŠ¡ï¼šè®¢å•ã€æ”¯ä»˜ç­‰
    // è¾…åŠ©åŠŸèƒ½ï¼šæ—¥å¿—ã€é€šçŸ¥ç­‰
}
```

**æ¨¡å¼3ï¼šè‡ªå®šä¹‰å¼‚å¸¸æ¨¡å¼**

```java
// åªå¤„ç†ä¸šåŠ¡å¼‚å¸¸
@Transactional(rollbackFor = BusinessException.class)
public void businessLogic() {
    // é€‚ç”¨åœºæ™¯ï¼šæ˜ç¡®çš„ä¸šåŠ¡å¼‚å¸¸ä½“ç³»
}
```

### 8.2 å¼‚å¸¸è®¾è®¡å»ºè®®


**å»ºè®®1ï¼šå»ºç«‹å¼‚å¸¸å±‚æ¬¡**

```java
// é¡¶å±‚ä¸šåŠ¡å¼‚å¸¸
public class BusinessException extends RuntimeException {
    private String errorCode;
    
    public BusinessException(String message) {
        super(message);
    }
}

// å…·ä½“ä¸šåŠ¡å¼‚å¸¸
public class OrderException extends BusinessException {
    public OrderException(String message) {
        super(message);
    }
}

public class PaymentException extends BusinessException {
    public PaymentException(String message) {
        super(message);
    }
}
```

**å»ºè®®2ï¼šå—æ£€è½¬éå—æ£€**

```java
// âŒ ä¸æ¨èï¼šä½¿ç”¨å—æ£€å¼‚å¸¸
public class BadException extends Exception { }

// âœ… æ¨èï¼šä½¿ç”¨éå—æ£€å¼‚å¸¸
public class GoodException extends RuntimeException { }
```

**åŸå› **ï¼š
```
å—æ£€å¼‚å¸¸çš„é—®é¢˜ï¼š
- æ–¹æ³•ç­¾åå¿…é¡»å£°æ˜throws
- è°ƒç”¨é“¾ä¸Šæ‰€æœ‰æ–¹æ³•éƒ½è¦å¤„ç†
- ä»£ç å†—ä½™ï¼Œå¯è¯»æ€§å·®

éå—æ£€å¼‚å¸¸çš„ä¼˜åŠ¿ï¼š
- ä¸éœ€è¦æ˜¾å¼å£°æ˜
- Springé»˜è®¤å›æ»š
- ä»£ç ç®€æ´æ¸…æ™°
```

### 8.3 å¸¸è§åœºæ™¯æ–¹æ¡ˆ


**åœºæ™¯1ï¼šè®¢å•æ”¯ä»˜**

```java
@Transactional(rollbackFor = Exception.class)
public void payOrder(Long orderId, BigDecimal amount) throws Exception {
    
    // 1. æŸ¥è¯¢è®¢å•
    Order order = orderMapper.selectById(orderId);
    if (order == null) {
        throw new OrderException("è®¢å•ä¸å­˜åœ¨");
    }
    
    // 2. æ‰£å‡ä½™é¢
    accountService.deduct(order.getUserId(), amount);
    
    // 3. æ›´æ–°è®¢å•çŠ¶æ€
    order.setStatus("PAID");
    orderMapper.update(order);
    
    // 4. å‘é€é€šçŸ¥ï¼ˆå¤±è´¥ä¸å½±å“ï¼‰
    try {
        notificationService.sendPaymentSuccess(order);
    } catch (Exception e) {
        log.error("é€šçŸ¥å‘é€å¤±è´¥", e);
        // ä¸å½±å“ä¸»æµç¨‹
    }
}
```

**åœºæ™¯2ï¼šæ‰¹é‡æ“ä½œ**

```java
@Transactional(rollbackFor = Exception.class)
public void batchImport(List<User> users) {
    
    for (User user : users) {
        try {
            // æ ¡éªŒæ•°æ®
            validateUser(user);
            
            // ä¿å­˜ç”¨æˆ·
            userMapper.insert(user);
            
        } catch (ValidationException e) {
            // å•æ¡æ•°æ®é—®é¢˜ï¼Œè®°å½•æ—¥å¿—ç»§ç»­
            log.warn("ç”¨æˆ·æ•°æ®æ— æ•ˆ: {}", user.getId(), e);
            continue;
        }
    }
    
    // å¦‚æœæœ‰ä¸¥é‡é”™è¯¯ï¼ŒæŠ›å‡ºå¼‚å¸¸å›æ»š
    if (hasError) {
        throw new BusinessException("æ‰¹é‡å¯¼å…¥å¤±è´¥");
    }
}
```

### 8.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ä¼˜åŒ–1ï¼šå‡å°‘äº‹åŠ¡èŒƒå›´**

```java
// âŒ ä¸å¥½ï¼šäº‹åŠ¡èŒƒå›´å¤ªå¤§
@Transactional
public void processOrder(Order order) {
    // éæ•°æ®åº“æ“ä½œï¼Œä¸éœ€è¦äº‹åŠ¡
    validateOrder(order);
    calculatePrice(order);
    
    // æ•°æ®åº“æ“ä½œ
    orderMapper.insert(order);
}

// âœ… æ›´å¥½ï¼šåªåœ¨éœ€è¦çš„åœ°æ–¹å¼€å¯äº‹åŠ¡
public void processOrder(Order order) {
    // éäº‹åŠ¡æ“ä½œ
    validateOrder(order);
    calculatePrice(order);
    
    // åªåœ¨è¿™é‡Œéœ€è¦äº‹åŠ¡
    saveOrder(order);
}

@Transactional
private void saveOrder(Order order) {
    orderMapper.insert(order);
}
```

**ä¼˜åŒ–2ï¼šé¿å…é•¿äº‹åŠ¡**

```java
// âŒ ä¸å¥½ï¼šäº‹åŠ¡ä¸­åŒ…å«è€—æ—¶æ“ä½œ
@Transactional
public void badPractice(Order order) {
    orderMapper.insert(order);
    
    // è°ƒç”¨å¤–éƒ¨æ¥å£ï¼ˆå¯èƒ½å¾ˆæ…¢ï¼‰
    paymentGateway.pay(order);  // äº‹åŠ¡ç­‰å¾…ä¸­...
    
    orderMapper.updateStatus(order);
}

// âœ… æ›´å¥½ï¼šæ‹†åˆ†äº‹åŠ¡
public void goodPractice(Order order) {
    // äº‹åŠ¡1ï¼šåˆ›å»ºè®¢å•
    Long orderId = createOrder(order);
    
    // éäº‹åŠ¡ï¼šè°ƒç”¨æ”¯ä»˜
    boolean paySuccess = paymentGateway.pay(order);
    
    // äº‹åŠ¡2ï¼šæ›´æ–°çŠ¶æ€
    if (paySuccess) {
        updateOrderStatus(orderId, "PAID");
    }
}
```

### 8.5 è°ƒè¯•æŠ€å·§


**æŠ€å·§1ï¼šå¼€å¯äº‹åŠ¡æ—¥å¿—**

```properties
# application.properties
logging.level.org.springframework.jdbc.datasource.DataSourceTransactionManager=DEBUG
logging.level.org.springframework.transaction.interceptor=TRACE
```

**æŠ€å·§2ï¼šæ·»åŠ æ—¥å¿—è¾“å‡º**

```java
@Transactional(rollbackFor = Exception.class)
public void debugOperation() {
    log.info("äº‹åŠ¡å¼€å§‹");
    
    try {
        orderMapper.insert(order);
        log.info("è®¢å•æ’å…¥æˆåŠŸ");
        
        stockMapper.reduce(productId, quantity);
        log.info("åº“å­˜æ‰£å‡æˆåŠŸ");
        
    } catch (Exception e) {
        log.error("æ“ä½œå¤±è´¥ï¼Œäº‹åŠ¡å°†å›æ»š", e);
        throw e;
    }
    
    log.info("äº‹åŠ¡æäº¤");
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…çŸ¥å¿…ä¼š


**ğŸ”¸ å¼‚å¸¸åˆ†ç±»**
```
å—æ£€å¼‚å¸¸ï¼šç¼–è¯‘æœŸæ£€æŸ¥ï¼Œå¿…é¡»å¤„ç†ï¼Œé»˜è®¤ä¸å›æ»š
è¿è¡Œæ—¶å¼‚å¸¸ï¼šè¿è¡ŒæœŸæ£€æŸ¥ï¼Œå¯ä¸å¤„ç†ï¼Œé»˜è®¤å›æ»š
```

**ğŸ”¸ é»˜è®¤å›æ»šè§„åˆ™**
```
RuntimeExceptionåŠå…¶å­ç±» â†’ å›æ»š âœ“
ErroråŠå…¶å­ç±» â†’ å›æ»š âœ“
å—æ£€å¼‚å¸¸ â†’ ä¸å›æ»š âœ—
```

**ğŸ”¸ è‡ªå®šä¹‰é…ç½®**
```
rollbackForï¼šæ‰©å¤§å›æ»šèŒƒå›´
noRollbackForï¼šç¼©å°å›æ»šèŒƒå›´
noRollbackForä¼˜å…ˆçº§æ›´é«˜
```

**ğŸ”¸ å¼‚å¸¸ä¼ æ’­**
```
å¼‚å¸¸å¿…é¡»å‘ä¸Šä¼ æ’­ï¼ŒSpringæ‰èƒ½æ£€æµ‹
æ•è·åè¦é‡æ–°æŠ›å‡ºæˆ–æ‰‹åŠ¨å›æ»š
```

### 9.2 æœ€ä½³å®è·µæ¸…å•


**âœ… æ¨èåšæ³•**
- ä½¿ç”¨`@Transactional(rollbackFor = Exception.class)`æœ€å®‰å…¨
- ä¸šåŠ¡å¼‚å¸¸ç»§æ‰¿`RuntimeException`
- å¼‚å¸¸è¦æœ‰æ˜ç¡®çš„é”™è¯¯ç å’Œä¿¡æ¯
- æ—¥å¿—è®°å½•è¯¦ç»†çš„å¼‚å¸¸ä¸Šä¸‹æ–‡
- ä¸»è¾…ä¸šåŠ¡åˆ†ç¦»å¤„ç†

**âŒ é¿å…åšæ³•**
- ä¸è¦åæ‰å¼‚å¸¸ä¸å¤„ç†
- ä¸è¦åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
- ä¸è¦è¿‡åº¦ä½¿ç”¨å—æ£€å¼‚å¸¸
- ä¸è¦è®©äº‹åŠ¡èŒƒå›´è¿‡å¤§
- ä¸è¦å¿½ç•¥å¼‚å¸¸æ—¥å¿—

### 9.3 å¿«é€Ÿè®°å¿†


**è®°å¿†å£è¯€**ï¼š
```
è¿è¡Œæ—¶å¼‚å¸¸é»˜è®¤å›ï¼Œå—æ£€å¼‚å¸¸ä¸å›æ»š
rollbackForæ¥æ‰©å¤§ï¼ŒnoRollbackForç¼©èŒƒå›´
å¼‚å¸¸ä¼ æ’­è¦å‘ä¸Šï¼Œæ•è·å¤„ç†éœ€é‡æŠ›
ä¸»è¾…åˆ†ç¦»ä¿ä¸€è‡´ï¼Œå®‰å…¨ç¬¬ä¸€æœ€é‡è¦
```

**å†³ç­–æ ‘**ï¼š
```
é€‰æ‹©å›æ»šç­–ç•¥
    â†“
æ ¸å¿ƒä¸šåŠ¡ï¼Ÿ
â”œâ”€ æ˜¯ â†’ rollbackFor = Exception.classï¼ˆæœ€å®‰å…¨ï¼‰
â””â”€ å¦ â†’ æœ‰è¾…åŠ©åŠŸèƒ½ï¼Ÿ
          â”œâ”€ æ˜¯ â†’ rollbackFor + noRollbackForï¼ˆä¸»è¾…åˆ†ç¦»ï¼‰
          â””â”€ å¦ â†’ ä½¿ç”¨é»˜è®¤è§„åˆ™ï¼ˆç®€å•åœºæ™¯ï¼‰
```

### 9.4 å®æˆ˜æ£€æŸ¥æ¸…å•


**å¼€å‘é˜¶æ®µ**ï¼š
- [ ] æ˜ç¡®å“ªäº›æ˜¯æ ¸å¿ƒä¸šåŠ¡ï¼Œå“ªäº›æ˜¯è¾…åŠ©åŠŸèƒ½
- [ ] è®¾è®¡åˆç†çš„å¼‚å¸¸å±‚æ¬¡ç»“æ„
- [ ] é…ç½®æ­£ç¡®çš„rollbackFor/noRollbackFor
- [ ] ç¡®ä¿å¼‚å¸¸èƒ½æ­£ç¡®ä¼ æ’­
- [ ] æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•

**æµ‹è¯•é˜¶æ®µ**ï¼š
- [ ] æµ‹è¯•å„ç§å¼‚å¸¸åœºæ™¯
- [ ] éªŒè¯å›æ»šæ˜¯å¦ç¬¦åˆé¢„æœŸ
- [ ] æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
- [ ] æŸ¥çœ‹äº‹åŠ¡æ—¥å¿—è¾“å‡º
- [ ] æ¨¡æ‹Ÿæç«¯æƒ…å†µ

**ä¸Šçº¿å‰**ï¼š
- [ ] Code Reviewäº‹åŠ¡é…ç½®
- [ ] ç¡®è®¤å¼‚å¸¸å¤„ç†é€»è¾‘
- [ ] æ£€æŸ¥äº‹åŠ¡èŒƒå›´æ˜¯å¦åˆç†
- [ ] å‡†å¤‡å¼‚å¸¸ç›‘æ§å’Œå‘Šè­¦
- [ ] åˆ¶å®šå›æ»šåº”æ€¥é¢„æ¡ˆ