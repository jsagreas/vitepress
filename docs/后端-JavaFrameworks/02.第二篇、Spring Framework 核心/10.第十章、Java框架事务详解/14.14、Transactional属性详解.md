---
title: 14ã€Transactionalå±æ€§è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [@Transactionalæ³¨è§£æ¦‚è¿°](#1-transactionalæ³¨è§£æ¦‚è¿°)
2. [transactionManager - äº‹åŠ¡ç®¡ç†å™¨æŒ‡å®š](#2-transactionmanager-äº‹åŠ¡ç®¡ç†å™¨æŒ‡å®š)
3. [propagation - äº‹åŠ¡ä¼ æ’­è¡Œä¸º](#3-propagation-äº‹åŠ¡ä¼ æ’­è¡Œä¸º)
4. [isolation - äº‹åŠ¡éš”ç¦»çº§åˆ«](#4-isolation-äº‹åŠ¡éš”ç¦»çº§åˆ«)
5. [timeout - è¶…æ—¶æ—¶é—´è®¾ç½®](#5-timeout-è¶…æ—¶æ—¶é—´è®¾ç½®)
6. [readOnly - åªè¯»äº‹åŠ¡ä¼˜åŒ–](#6-readonly-åªè¯»äº‹åŠ¡ä¼˜åŒ–)
7. [rollbackFor - å›æ»šå¼‚å¸¸æŒ‡å®š](#7-rollbackfor-å›æ»šå¼‚å¸¸æŒ‡å®š)
8. [noRollbackFor - ä¸å›æ»šå¼‚å¸¸æŒ‡å®š](#8-norollbackfor-ä¸å›æ»šå¼‚å¸¸æŒ‡å®š)
9. [å±æ€§ç»„åˆä½¿ç”¨æœ€ä½³å®è·µ](#9-å±æ€§ç»„åˆä½¿ç”¨æœ€ä½³å®è·µ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ @Transactionalæ³¨è§£æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯@Transactionalæ³¨è§£


**é€šä¿—ç†è§£**ï¼š`@Transactional`å°±åƒæ˜¯ç»™ä½ çš„æ–¹æ³•åŠ äº†ä¸€ä¸ª"ä¿æŠ¤ç½©"ï¼Œç¡®ä¿æ–¹æ³•é‡Œçš„æ•°æ®åº“æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»šï¼Œä¸ä¼šå‡ºç°"åšäº†ä¸€åŠ"çš„æƒ…å†µã€‚

> ğŸ’¡ **æ ¸å¿ƒæ¦‚å¿µ**
> 
> `@Transactional`æ˜¯Springæ¡†æ¶æä¾›çš„å£°æ˜å¼äº‹åŠ¡ç®¡ç†æ³¨è§£ï¼Œé€šè¿‡åœ¨æ–¹æ³•æˆ–ç±»ä¸Šæ·»åŠ è¿™ä¸ªæ³¨è§£ï¼ŒSpringä¼šè‡ªåŠ¨ä¸ºä½ ç®¡ç†äº‹åŠ¡çš„å¼€å¯ã€æäº¤ã€å›æ»šç­‰æ“ä½œã€‚

**åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
@Service
public class UserService {
    
    @Transactional  // å°±è¿™ä¹ˆç®€å•ï¼
    public void transferMoney(Long fromId, Long toId, BigDecimal amount) {
        // æ‰£æ¬¾
        accountDao.deduct(fromId, amount);
        // åŠ æ¬¾
        accountDao.add(toId, amount);
        // å¦‚æœä¸­é—´å‡ºé”™ï¼Œä¸¤ä¸ªæ“ä½œéƒ½ä¼šå›æ»š
    }
}
```

### 1.2 æ³¨è§£çš„7å¤§æ ¸å¿ƒå±æ€§


| å±æ€§ | ä½œç”¨ | ä½¿ç”¨é¢‘ç‡ |
|------|------|---------|
| `transactionManager` | æŒ‡å®šä½¿ç”¨å“ªä¸ªäº‹åŠ¡ç®¡ç†å™¨ | â­â­ å¤šæ•°æ®æºå¿…ç”¨ |
| `propagation` | æ§åˆ¶äº‹åŠ¡ä¼ æ’­è¡Œä¸º | â­â­â­ å¸¸ç”¨ |
| `isolation` | è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ« | â­â­ æŒ‰éœ€ä½¿ç”¨ |
| `timeout` | è®¾ç½®è¶…æ—¶æ—¶é—´ | â­â­ é˜²æ­¢é•¿äº‹åŠ¡ |
| `readOnly` | æ ‡è®°åªè¯»äº‹åŠ¡ | â­â­â­ æŸ¥è¯¢ä¼˜åŒ–å¿…ç”¨ |
| `rollbackFor` | æŒ‡å®šå›æ»šå¼‚å¸¸ | â­â­â­ éå¸¸é‡è¦ |
| `noRollbackFor` | æŒ‡å®šä¸å›æ»šå¼‚å¸¸ | â­ ç‰¹æ®Šåœºæ™¯ |

---

## 2. ğŸ”§ transactionManager - äº‹åŠ¡ç®¡ç†å™¨æŒ‡å®š


### 2.1 å±æ€§è¯´æ˜


**é€šä¿—è§£é‡Š**ï¼šå½“ä½ çš„ç³»ç»Ÿè¿æ¥äº†å¤šä¸ªæ•°æ®åº“ï¼ˆæ¯”å¦‚ä¸€ä¸ªMySQLã€ä¸€ä¸ªOracleï¼‰ï¼Œä½ éœ€è¦å‘Šè¯‰Spring"è¿™ä¸ªæ–¹æ³•çš„äº‹åŠ¡ç”¨å“ªä¸ªæ•°æ®åº“çš„äº‹åŠ¡ç®¡ç†å™¨"ã€‚

> ğŸ“Œ **ä»€ä¹ˆæ—¶å€™éœ€è¦æŒ‡å®šï¼Ÿ**
> 
> â‘  å•æ•°æ®æºï¼šä¸éœ€è¦æŒ‡å®šï¼ŒSpringè‡ªåŠ¨æ‰¾åˆ°å”¯ä¸€çš„äº‹åŠ¡ç®¡ç†å™¨
> â‘¡ å¤šæ•°æ®æºï¼šå¿…é¡»æ˜ç¡®æŒ‡å®šï¼Œå¦åˆ™Springä¸çŸ¥é“ç”¨å“ªä¸ª

### 2.2 å•æ•°æ®æºåœºæ™¯ï¼ˆé»˜è®¤ï¼‰


```java
// ä¸éœ€è¦æŒ‡å®šï¼ŒSpringä¼šè‡ªåŠ¨æ‰¾åˆ°äº‹åŠ¡ç®¡ç†å™¨
@Transactional
public void saveUser(User user) {
    userDao.insert(user);
}
```

### 2.3 å¤šæ•°æ®æºåœºæ™¯ï¼ˆå¿…é¡»æŒ‡å®šï¼‰


**é…ç½®å¤šä¸ªäº‹åŠ¡ç®¡ç†å™¨**ï¼š
```java
@Configuration
public class DataSourceConfig {
    
    // ä¸»æ•°æ®åº“çš„äº‹åŠ¡ç®¡ç†å™¨
    @Bean("primaryTxManager")
    public PlatformTransactionManager primaryTxManager() {
        return new DataSourceTransactionManager(primaryDataSource());
    }
    
    // è®¢å•æ•°æ®åº“çš„äº‹åŠ¡ç®¡ç†å™¨
    @Bean("orderTxManager")
    public PlatformTransactionManager orderTxManager() {
        return new DataSourceTransactionManager(orderDataSource());
    }
}
```

**ä½¿ç”¨æ—¶æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨**ï¼š
```java
@Service
public class OrderService {
    
    // ä½¿ç”¨è®¢å•åº“çš„äº‹åŠ¡ç®¡ç†å™¨
    @Transactional(transactionManager = "orderTxManager")
    public void createOrder(Order order) {
        orderDao.insert(order);
    }
    
    // ä½¿ç”¨ä¸»åº“çš„äº‹åŠ¡ç®¡ç†å™¨
    @Transactional(transactionManager = "primaryTxManager")
    public void saveUser(User user) {
        userDao.insert(user);
    }
}
```

> âš ï¸ **å¸¸è§é”™è¯¯**
> 
> å¤šæ•°æ®æºç¯å¢ƒä¸‹ä¸æŒ‡å®š`transactionManager`ï¼Œä¼šå¯¼è‡´ï¼š
> - æ‰¾ä¸åˆ°åˆé€‚çš„äº‹åŠ¡ç®¡ç†å™¨æŠ¥é”™
> - æˆ–è€…ç”¨é”™äº†äº‹åŠ¡ç®¡ç†å™¨å¯¼è‡´äº‹åŠ¡ä¸ç”Ÿæ•ˆ

---

## 3. ğŸ”„ propagation - äº‹åŠ¡ä¼ æ’­è¡Œä¸º


### 3.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ä¼ æ’­è¡Œä¸º


**é€šä¿—ç†è§£**ï¼šå½“ä¸€ä¸ªå¸¦äº‹åŠ¡çš„æ–¹æ³•Aè°ƒç”¨å¦ä¸€ä¸ªå¸¦äº‹åŠ¡çš„æ–¹æ³•Bæ—¶ï¼ŒBçš„äº‹åŠ¡è¯¥æ€ä¹ˆåŠï¼Ÿæ˜¯åŠ å…¥Açš„äº‹åŠ¡ï¼Ÿè¿˜æ˜¯è‡ªå·±å¼€ä¸ªæ–°äº‹åŠ¡ï¼Ÿè¿™å°±æ˜¯ä¼ æ’­è¡Œä¸ºè¦è§£å†³çš„é—®é¢˜ã€‚

```
æ–¹æ³•Aï¼ˆæœ‰äº‹åŠ¡ï¼‰
   |
   +--> è°ƒç”¨æ–¹æ³•Bï¼ˆä¹Ÿæœ‰äº‹åŠ¡ï¼‰
        
        é—®é¢˜ï¼šBè¯¥æ€ä¹ˆåŠï¼Ÿ
        â‘  åŠ å…¥Açš„äº‹åŠ¡ï¼Ÿï¼ˆä¸€è£ä¿±è£ï¼Œä¸€æŸä¿±æŸï¼‰
        â‘¡ å¼€å¯è‡ªå·±çš„æ–°äº‹åŠ¡ï¼Ÿï¼ˆå„ç®¡å„çš„ï¼‰
        â‘¢ ä¸ç”¨äº‹åŠ¡ï¼Ÿï¼ˆè£¸å¥”ï¼‰
```

### 3.2 ä¸ƒç§ä¼ æ’­è¡Œä¸ºè¯¦è§£


| ä¼ æ’­è¡Œä¸º | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ | é‡è¦ç¨‹åº¦ |
|---------|------|---------|---------|
| `REQUIRED` | æœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±æ–°å»º | **é»˜è®¤å€¼ï¼Œ99%åœºæ™¯** | â­â­â­â­â­ |
| `REQUIRES_NEW` | æ€»æ˜¯å¼€æ–°äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ | ç‹¬ç«‹äº‹åŠ¡éœ€æ±‚ | â­â­â­ |
| `SUPPORTS` | æœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±ä¸ç”¨ | æŸ¥è¯¢æ–¹æ³• | â­â­ |
| `NOT_SUPPORTED` | ä¸ç”¨äº‹åŠ¡ï¼Œæœ‰äº‹åŠ¡å°±æŒ‚èµ· | éäº‹åŠ¡æ“ä½œ | â­ |
| `MANDATORY` | å¿…é¡»åœ¨äº‹åŠ¡ä¸­ï¼Œå¦åˆ™æŠ¥é”™ | å¼ºåˆ¶äº‹åŠ¡ç¯å¢ƒ | â­ |
| `NEVER` | ä¸èƒ½åœ¨äº‹åŠ¡ä¸­ï¼Œå¦åˆ™æŠ¥é”™ | ç¦æ­¢äº‹åŠ¡ç¯å¢ƒ | â­ |
| `NESTED` | åµŒå¥—äº‹åŠ¡ï¼Œå¯ç‹¬ç«‹å›æ»š | éƒ¨åˆ†å›æ»šéœ€æ±‚ | â­â­ |

### 3.3 REQUIRED - æœ€å¸¸ç”¨çš„é»˜è®¤è¡Œä¸º


> ğŸ’¡ **æ ¸å¿ƒé€»è¾‘**ï¼šæœ‰äº‹åŠ¡æˆ‘å°±åŠ å…¥ï¼Œæ²¡äº‹åŠ¡æˆ‘å°±æ–°å»º

**åœºæ™¯æ¼”ç¤º**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired
    private ProductService productService;
    
    // æ–¹æ³•Aï¼šæœ‰äº‹åŠ¡
    @Transactional(propagation = Propagation.REQUIRED)
    public void createOrder(Order order) {
        orderDao.insert(order);  // æ“ä½œ1
        
        // è°ƒç”¨æ–¹æ³•Bï¼ŒBä¹Ÿæ˜¯REQUIRED
        productService.updateStock(order.getProductId());  // æ“ä½œ2
        
        // æ“ä½œ1å’Œæ“ä½œ2åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­
        // ä»»ä½•ä¸€ä¸ªå‡ºé”™ï¼Œéƒ½ä¼šä¸€èµ·å›æ»š
    }
}

@Service
public class ProductService {
    
    // æ–¹æ³•Bï¼šREQUIREDï¼ˆé»˜è®¤ï¼‰
    @Transactional
    public void updateStock(Long productId) {
        productDao.reduceStock(productId);
        // åŠ å…¥äº†æ–¹æ³•Açš„äº‹åŠ¡ï¼Œä¸ä¼šå¼€æ–°äº‹åŠ¡
    }
}
```

**æ‰§è¡Œæµç¨‹å›¾**ï¼š
```
createOrderæ–¹æ³•å¼€å§‹
    |
    +-- [å¼€å¯äº‹åŠ¡T1]
    |
    +-- orderDao.insert() âœ“ (åœ¨T1ä¸­)
    |
    +-- è°ƒç”¨updateStock()
    |       |
    |       +-- æ£€æµ‹åˆ°å·²æœ‰äº‹åŠ¡T1
    |       +-- åŠ å…¥T1ï¼ˆä¸å¼€æ–°äº‹åŠ¡ï¼‰
    |       +-- productDao.reduceStock() âœ“ (åœ¨T1ä¸­)
    |
    +-- [æäº¤äº‹åŠ¡T1] âœ“
    
ç»“æœï¼šä¸¤ä¸ªæ“ä½œåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œä¸€èµ·æˆåŠŸæˆ–ä¸€èµ·å¤±è´¥
```

### 3.4 REQUIRES_NEW - ç‹¬ç«‹å¼€æ–°äº‹åŠ¡


> ğŸ’¡ **æ ¸å¿ƒé€»è¾‘**ï¼šä¸ç®¡å¤–é¢æœ‰æ²¡æœ‰äº‹åŠ¡ï¼Œæˆ‘éƒ½è¦å¼€è‡ªå·±çš„æ–°äº‹åŠ¡

**ä½¿ç”¨åœºæ™¯**ï¼šè®°å½•æ“ä½œæ—¥å¿—ï¼Œæ— è®ºä¸šåŠ¡æˆåŠŸå¤±è´¥éƒ½è¦ä¿å­˜

```java
@Service
public class OrderService {
    
    @Autowired
    private LogService logService;
    
    @Transactional
    public void createOrder(Order order) {
        orderDao.insert(order);  // ä¸šåŠ¡æ“ä½œ
        
        // è®°å½•æ—¥å¿—ï¼Œæ— è®ºä¸šåŠ¡æˆåŠŸå¤±è´¥éƒ½è¦ä¿å­˜
        logService.saveLog("åˆ›å»ºè®¢å•", order.getId());
        
        // å¦‚æœè¿™é‡ŒæŠ›å¼‚å¸¸ï¼Œè®¢å•å›æ»šï¼Œä½†æ—¥å¿—å·²ä¿å­˜
        if (order.getAmount().compareTo(BigDecimal.ZERO) <= 0) {
            throw new RuntimeException("é‡‘é¢å¿…é¡»å¤§äº0");
        }
    }
}

@Service
public class LogService {
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void saveLog(String action, Long orderId) {
        logDao.insert(new Log(action, orderId));
        // åœ¨è‡ªå·±çš„äº‹åŠ¡ä¸­ï¼Œç«‹å³æäº¤
        // ä¸å—å¤–éƒ¨äº‹åŠ¡å½±å“
    }
}
```

**æ‰§è¡Œæµç¨‹å¯¹æ¯”**ï¼š
```
æƒ…å†µ1ï¼šæ—¥å¿—æ–¹æ³•ç”¨REQUIREDï¼ˆé”™è¯¯åšæ³•ï¼‰
createOrderäº‹åŠ¡
    |-- insertè®¢å• âœ“
    |-- saveLog(åŠ å…¥åŒä¸€äº‹åŠ¡) âœ“
    |-- æŠ›å¼‚å¸¸ âœ—
    |-- æ•´ä½“å›æ»šï¼ˆè®¢å•å’Œæ—¥å¿—éƒ½æ²¡äº†ï¼‰âŒ

æƒ…å†µ2ï¼šæ—¥å¿—æ–¹æ³•ç”¨REQUIRES_NEWï¼ˆæ­£ç¡®åšæ³•ï¼‰
createOrderäº‹åŠ¡
    |-- insertè®¢å• âœ“
    |-- saveLog(æ–°äº‹åŠ¡ï¼Œç«‹å³æäº¤) âœ“
    |-- æŠ›å¼‚å¸¸ âœ—
    |-- åªå›æ»šè®¢å•ï¼ˆæ—¥å¿—å·²ä¿å­˜ï¼‰âœ“
```

### 3.5 SUPPORTS - æœ‰äº‹åŠ¡å°±ç”¨ï¼Œæ²¡äº‹åŠ¡æ‹‰å€’


**ä½¿ç”¨åœºæ™¯**ï¼šæŸ¥è¯¢æ–¹æ³•ï¼Œäº‹åŠ¡å¯æœ‰å¯æ— 

```java
@Service
public class UserService {
    
    // æŸ¥è¯¢æ–¹æ³•ï¼Œäº‹åŠ¡ä¸æ˜¯å¿…é¡»çš„
    @Transactional(propagation = Propagation.SUPPORTS, readOnly = true)
    public User getUserById(Long id) {
        return userDao.selectById(id);
    }
}
```

### 3.6 NESTED - åµŒå¥—äº‹åŠ¡ï¼ˆäº†è§£å³å¯ï¼‰


**æ ¸å¿ƒç‰¹ç‚¹**ï¼šå­äº‹åŠ¡å¯ä»¥ç‹¬ç«‹å›æ»šï¼Œä¸å½±å“çˆ¶äº‹åŠ¡

```java
@Transactional
public void batchProcess(List<Order> orders) {
    for (Order order : orders) {
        try {
            processOrder(order);  // NESTEDä¼ æ’­
        } catch (Exception e) {
            // å•ä¸ªè®¢å•å¤±è´¥ä¸å½±å“å…¶ä»–è®¢å•
            log.error("è®¢å•å¤„ç†å¤±è´¥", e);
        }
    }
    // çˆ¶äº‹åŠ¡ç»§ç»­
}

@Transactional(propagation = Propagation.NESTED)
public void processOrder(Order order) {
    // å¤„ç†å•ä¸ªè®¢å•
    // å¤±è´¥åªå›æ»šè‡ªå·±
}
```

---

## 4. ğŸ”’ isolation - äº‹åŠ¡éš”ç¦»çº§åˆ«


### 4.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡éš”ç¦»çº§åˆ«


**é€šä¿—ç†è§£**ï¼šå½“å¤šä¸ªäº‹åŠ¡åŒæ—¶æ“ä½œæ•°æ®åº“æ—¶ï¼Œå®ƒä»¬ä¹‹é—´äº’ç›¸å½±å“çš„ç¨‹åº¦ã€‚å°±åƒå¤šä¸ªäººåŒæ—¶ç¼–è¾‘ä¸€ä»½æ–‡æ¡£ï¼Œä½ æ˜¯èƒ½çœ‹åˆ°åˆ«äººçš„ä¿®æ”¹ï¼Ÿè¿˜æ˜¯å„æ”¹å„çš„ï¼Ÿ

> ğŸ“Œ **æ•°æ®åº“å¹¶å‘é—®é¢˜**
> 
> - **è„è¯»**ï¼šè¯»åˆ°äº†åˆ«äººè¿˜æ²¡æäº¤çš„æ•°æ®ï¼ˆå¯èƒ½ä¼šå›æ»šï¼‰
> - **ä¸å¯é‡å¤è¯»**ï¼šåŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œä¸¤æ¬¡è¯»å–ç»“æœä¸ä¸€æ ·ï¼ˆè¢«åˆ«äººæ”¹äº†ï¼‰
> - **å¹»è¯»**ï¼šåŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œä¸¤æ¬¡æŸ¥è¯¢è®°å½•æ•°ä¸ä¸€æ ·ï¼ˆè¢«åˆ«äººæ’å…¥/åˆ é™¤äº†ï¼‰

### 4.2 å››ç§éš”ç¦»çº§åˆ«


| éš”ç¦»çº§åˆ« | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» | æ€§èƒ½ | ä½¿ç”¨å»ºè®® |
|---------|------|-----------|------|------|---------|
| `READ_UNCOMMITTED` | âœ— ä¼šå‡ºç° | âœ— ä¼šå‡ºç° | âœ— ä¼šå‡ºç° | æœ€é«˜ | âŒ ä¸æ¨è |
| `READ_COMMITTED` | âœ“ è§£å†³ | âœ— ä¼šå‡ºç° | âœ— ä¼šå‡ºç° | è¾ƒé«˜ | â­â­ Oracleé»˜è®¤ |
| `REPEATABLE_READ` | âœ“ è§£å†³ | âœ“ è§£å†³ | âœ— ä¼šå‡ºç° | è¾ƒä½ | â­â­â­ MySQLé»˜è®¤ |
| `SERIALIZABLE` | âœ“ è§£å†³ | âœ“ è§£å†³ | âœ“ è§£å†³ | æœ€ä½ | â­ ç‰¹æ®Šåœºæ™¯ |

### 4.3 DEFAULT - ä½¿ç”¨æ•°æ®åº“é»˜è®¤çº§åˆ«ï¼ˆæ¨èï¼‰


```java
// ä¸æŒ‡å®šï¼Œä½¿ç”¨æ•°æ®åº“é»˜è®¤ï¼ˆMySQLæ˜¯REPEATABLE_READï¼‰
@Transactional(isolation = Isolation.DEFAULT)
public void normalOperation() {
    // å¤§éƒ¨åˆ†æƒ…å†µç”¨é»˜è®¤å°±å¤Ÿäº†
}
```

### 4.4 READ_COMMITTED - è¯»å·²æäº¤ï¼ˆOracleé»˜è®¤ï¼‰


**ç‰¹ç‚¹**ï¼šåªèƒ½è¯»åˆ°å·²æäº¤çš„æ•°æ®ï¼Œè§£å†³è„è¯»

```java
@Transactional(isolation = Isolation.READ_COMMITTED)
public void queryData() {
    // ä¸ä¼šè¯»åˆ°åˆ«äººæœªæäº¤çš„æ•°æ®
    // ä½†å¯èƒ½ä¸¤æ¬¡è¯»å–ç»“æœä¸åŒï¼ˆä¸å¯é‡å¤è¯»ï¼‰
}
```

**åœºæ™¯æ¼”ç¤º**ï¼š
```
æ—¶é—´çº¿ï¼š
T1: å¼€å§‹äº‹åŠ¡
T1: SELECT balance FROM account WHERE id=1  --> 100å…ƒ
T2: å¼€å§‹äº‹åŠ¡
T2: UPDATE account SET balance=200 WHERE id=1
T2: æäº¤äº‹åŠ¡
T1: SELECT balance FROM account WHERE id=1  --> 200å…ƒï¼ˆä¸ä¸€æ ·äº†ï¼ï¼‰
T1: æäº¤äº‹åŠ¡

ç°è±¡ï¼šä¸å¯é‡å¤è¯»ï¼ˆä¸¤æ¬¡è¯»å–ç»“æœä¸åŒï¼‰
```

### 4.5 REPEATABLE_READ - å¯é‡å¤è¯»ï¼ˆMySQLé»˜è®¤ï¼‰


**ç‰¹ç‚¹**ï¼šåŒä¸€äº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–ç»“æœä¸€è‡´

```java
@Transactional(isolation = Isolation.REPEATABLE_READ)
public void repeatableQuery() {
    // ç¬¬ä¸€æ¬¡æŸ¥è¯¢
    User user = userDao.getById(1L);  // name="å¼ ä¸‰"
    
    // ä¸­é—´åˆ«äººä¿®æ”¹äº†æ•°æ®å¹¶æäº¤
    
    // ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼Œç»“æœä»ç„¶ä¸€æ ·
    user = userDao.getById(1L);  // nameä»æ˜¯"å¼ ä¸‰"
}
```

### 4.6 å®é™…ä½¿ç”¨å»ºè®®


> ğŸ’¡ **æœ€ä½³å®è·µ**
> 
> â‘  **é»˜è®¤æƒ…å†µ**ï¼šä¸æŒ‡å®šï¼Œç”¨æ•°æ®åº“é»˜è®¤çº§åˆ«
> â‘¡ **é‡‘èä¸šåŠ¡**ï¼šç”¨`REPEATABLE_READ`æˆ–æ›´é«˜çº§åˆ«
> â‘¢**é«˜å¹¶å‘æŸ¥è¯¢**ï¼šå¯ä»¥ç”¨`READ_COMMITTED`æé«˜æ€§èƒ½
> â‘£ **é¿å…ä½¿ç”¨**ï¼š`READ_UNCOMMITTED`å’Œ`SERIALIZABLE`

```java
// æ¨èï¼šä¸æŒ‡å®šï¼Œç”¨é»˜è®¤
@Transactional
public void normalMethod() { }

// ç‰¹æ®Šåœºæ™¯ï¼šé‡‘èè½¬è´¦
@Transactional(isolation = Isolation.SERIALIZABLE)
public void transferMoney() {
    // æœ€ä¸¥æ ¼çš„éš”ç¦»ï¼Œé˜²æ­¢ä»»ä½•å¹¶å‘é—®é¢˜
}
```

---

## 5. â±ï¸ timeout - è¶…æ—¶æ—¶é—´è®¾ç½®


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶æ—¶é—´


**é€šä¿—ç†è§£**ï¼šé˜²æ­¢ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå¤ªä¹…ï¼Œå ç”¨æ•°æ®åº“è¿æ¥ä¸é‡Šæ”¾ï¼Œå¯¼è‡´å…¶ä»–è¯·æ±‚éƒ½åœ¨ç­‰å¾…ã€‚å°±åƒé¤å…ç”¨é¤é™æ—¶ï¼Œä¸èƒ½ä¸€ä¸ªäººå ç€ä½ç½®ä¸èµ°ã€‚

> âš ï¸ **é•¿äº‹åŠ¡çš„å±å®³**
> 
> - å ç”¨æ•°æ®åº“è¿æ¥æ± ï¼Œå¯¼è‡´å…¶ä»–è¯·æ±‚æ— æ³•è·å–è¿æ¥
> - æŒæœ‰é”å¤ªä¹…ï¼Œé˜»å¡å…¶ä»–äº‹åŠ¡
> - å¯èƒ½å¯¼è‡´ç³»ç»Ÿé›ªå´©

### 5.2 åŸºæœ¬ä½¿ç”¨


```java
// è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º5ç§’
@Transactional(timeout = 5)
public void processOrder(Order order) {
    // å¦‚æœ5ç§’å†…æ²¡æ‰§è¡Œå®Œï¼Œè‡ªåŠ¨å›æ»š
    orderDao.insert(order);
    
    // å¤æ‚ä¸šåŠ¡é€»è¾‘...
    // è¶…è¿‡5ç§’ä¼šæŠ›TransactionTimedOutException
}
```

### 5.3 è¶…æ—¶æ—¶é—´çš„å•ä½å’Œé»˜è®¤å€¼


> ğŸ“Œ **é‡è¦è¯´æ˜**
> 
> - **å•ä½**ï¼šç§’ï¼ˆä¸æ˜¯æ¯«ç§’ï¼‰
> - **é»˜è®¤å€¼**ï¼š-1ï¼ˆæ°¸ä¸è¶…æ—¶ï¼‰
> - **ç”Ÿæ•ˆèŒƒå›´**ï¼šåªå¯¹æ–°å¼€å¯çš„äº‹åŠ¡æœ‰æ•ˆ

### 5.4 ä½¿ç”¨åœºæ™¯å’Œå»ºè®®


**åœºæ™¯1ï¼šæ‰¹é‡å¤„ç†ï¼ˆå¿…é¡»è®¾ç½®ï¼‰**
```java
// æ‰¹é‡å¯¼å…¥ï¼Œè®¾ç½®è¶…æ—¶é¿å…é•¿æ—¶é—´å ç”¨
@Transactional(timeout = 30)
public void batchImport(List<User> users) {
    for (User user : users) {
        userDao.insert(user);
    }
}
```

**åœºæ™¯2ï¼šå¤æ‚ä¸šåŠ¡ï¼ˆæŒ‰éœ€è®¾ç½®ï¼‰**
```java
// å¤æ‚æŠ¥è¡¨ç”Ÿæˆï¼Œè®¾ç½®åˆç†è¶…æ—¶
@Transactional(timeout = 10, readOnly = true)
public Report generateReport(ReportParam param) {
    // å¤æ‚æŸ¥è¯¢å’Œè®¡ç®—
    return buildReport(data);
}
```

**åœºæ™¯3ï¼šç®€å•æ“ä½œï¼ˆä¸éœ€è¦è®¾ç½®ï¼‰**
```java
// ç®€å•å¢åˆ æ”¹æŸ¥ï¼Œé»˜è®¤å³å¯
@Transactional
public void saveUser(User user) {
    userDao.insert(user);
}
```

> ğŸ’¡ **è®¾ç½®å»ºè®®**
> 
> - ç®€å•æ“ä½œï¼šä¸è®¾ç½®ï¼ˆç”¨é»˜è®¤ï¼‰
> - æ‰¹é‡æ“ä½œï¼šè®¾ç½®30-60ç§’
> - å¤æ‚æŸ¥è¯¢ï¼šè®¾ç½®10-30ç§’
> - å®šæ—¶ä»»åŠ¡ï¼šæŒ‰å®é™…æƒ…å†µè®¾ç½®

---

## 6. ğŸ“– readOnly - åªè¯»äº‹åŠ¡ä¼˜åŒ–


### 6.1 ä»€ä¹ˆæ˜¯åªè¯»äº‹åŠ¡


**é€šä¿—ç†è§£**ï¼šå‘Šè¯‰æ•°æ®åº“"æˆ‘åªæ˜¯æŸ¥è¯¢ï¼Œä¸ä¼šä¿®æ”¹æ•°æ®"ï¼Œæ•°æ®åº“å¯ä»¥åšä¸€äº›ä¼˜åŒ–ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ã€‚

> ğŸ’¡ **åªè¯»äº‹åŠ¡çš„å¥½å¤„**
> 
> - æ•°æ®åº“ä¸éœ€è¦ç»´æŠ¤å›æ»šæ—¥å¿—
> - å¯ä»¥é¿å…åŠ ä¸å¿…è¦çš„é”
> - æŸäº›æ•°æ®åº“ä¼šè·¯ç”±åˆ°ä»åº“æŸ¥è¯¢
> - æç¤ºJPA/Hibernateä¸éœ€è¦åšè„æ£€æŸ¥

### 6.2 åŸºæœ¬ä½¿ç”¨


```java
@Service
public class UserQueryService {
    
    // æŸ¥è¯¢æ–¹æ³•ï¼Œæ ‡è®°ä¸ºåªè¯»
    @Transactional(readOnly = true)
    public User getUserById(Long id) {
        return userDao.selectById(id);
    }
    
    // åˆ—è¡¨æŸ¥è¯¢ï¼Œæ ‡è®°ä¸ºåªè¯»
    @Transactional(readOnly = true)
    public List<User> listUsers(QueryParam param) {
        return userDao.selectList(param);
    }
}
```

### 6.3 ä¸»ä»åˆ†ç¦»åœºæ™¯çš„å¦™ç”¨


**é…ç½®è¯»å†™åˆ†ç¦»**ï¼š
```java
@Configuration
public class DataSourceConfig {
    
    // é…ç½®è¯»å†™åˆ†ç¦»æ‹¦æˆªå™¨
    @Bean
    public DynamicDataSourceInterceptor dataSourceInterceptor() {
        return new DynamicDataSourceInterceptor() {
            @Override
            public void before(Invocation invocation) {
                // å¦‚æœæ˜¯åªè¯»äº‹åŠ¡ï¼Œè·¯ç”±åˆ°ä»åº“
                if (isReadOnly()) {
                    DataSourceContextHolder.useSlave();
                } else {
                    DataSourceContextHolder.useMaster();
                }
            }
        };
    }
}
```

**ä¸šåŠ¡ä»£ç **ï¼š
```java
// è‡ªåŠ¨è·¯ç”±åˆ°ä»åº“
@Transactional(readOnly = true)
public List<Order> queryOrders() {
    return orderDao.selectAll();  // ä»slaveåº“è¯»å–
}

// è‡ªåŠ¨è·¯ç”±åˆ°ä¸»åº“
@Transactional
public void createOrder(Order order) {
    orderDao.insert(order);  // å¾€masteråº“å†™å…¥
}
```

### 6.4 å¸¸è§è¯¯åŒº


> âš ï¸ **é”™è¯¯ç¤ºä¾‹1ï¼šåªè¯»äº‹åŠ¡ä¸­æ‰§è¡Œæ›´æ–°**
> 
> ```java
> // é”™è¯¯ï¼šæ ‡è®°ä¸ºåªè¯»ï¼Œå´æ‰§è¡Œæ›´æ–°æ“ä½œ
> @Transactional(readOnly = true)
> public void updateUser(User user) {
>     userDao.update(user);  // ä¼šæŠ¥é”™æˆ–ä¸ç”Ÿæ•ˆ
> }
> ```

> âš ï¸ **é”™è¯¯ç¤ºä¾‹2ï¼šå¿˜è®°è®¾ç½®åªè¯»**
> 
> ```java
> // æµªè´¹æ€§èƒ½ï¼šçº¯æŸ¥è¯¢å´æ²¡æ ‡è®°åªè¯»
> @Transactional  // åº”è¯¥åŠ readOnly=true
> public List<User> queryUsers() {
>     return userDao.selectAll();
> }
> ```

### 6.5 ä½¿ç”¨è§„èŒƒ


**âœ… æ­£ç¡®åšæ³•**ï¼š
```java
// æ‰€æœ‰æŸ¥è¯¢æ–¹æ³•éƒ½åŠ readOnly
@Transactional(readOnly = true)
public User getUser(Long id) { }

@Transactional(readOnly = true)
public List<Order> listOrders() { }

@Transactional(readOnly = true)
public PageInfo<Product> pageProducts() { }

// å¢åˆ æ”¹ä¸åŠ readOnly
@Transactional
public void saveUser(User user) { }

@Transactional
public void deleteUser(Long id) { }
```

---

## 7. ğŸ”™ rollbackFor - å›æ»šå¼‚å¸¸æŒ‡å®š


### 7.1 Springé»˜è®¤å›æ»šè§„åˆ™


**æ ¸å¿ƒåŸåˆ™**ï¼š
- **RuntimeException**ï¼ˆè¿è¡Œæ—¶å¼‚å¸¸ï¼‰ï¼šè‡ªåŠ¨å›æ»š âœ“
- **Error**ï¼šè‡ªåŠ¨å›æ»š âœ“
- **Checked Exception**ï¼ˆæ£€æŸ¥å¼‚å¸¸ï¼‰ï¼šä¸å›æ»š âœ—

> âš ï¸ **æœ€å®¹æ˜“è¸©çš„å‘**
> 
> ```java
> @Transactional
> public void saveUser(User user) throws Exception {
>     userDao.insert(user);
>     throw new Exception("å‡ºé”™äº†");  // æ£€æŸ¥å¼‚å¸¸ï¼Œä¸ä¼šå›æ»šï¼
> }
> ```

### 7.2 ä¸ºä»€ä¹ˆéœ€è¦rollbackFor


**é—®é¢˜åœºæ™¯**ï¼š
```java
@Transactional
public void transferMoney(Long fromId, Long toId, BigDecimal amount) 
    throws BusinessException {  // è¿™æ˜¯æ£€æŸ¥å¼‚å¸¸
    
    accountDao.deduct(fromId, amount);  // æ‰£æ¬¾æˆåŠŸ
    
    if (amount.compareTo(new BigDecimal("10000")) > 0) {
        // æŠ›å‡ºæ£€æŸ¥å¼‚å¸¸
        throw new BusinessException("è½¬è´¦é‡‘é¢è¶…é™");
    }
    
    accountDao.add(toId, amount);
}
// ç»“æœï¼šæŠ›äº†å¼‚å¸¸ï¼Œä½†æ‰£æ¬¾ä¸ä¼šå›æ»šï¼æ•°æ®ä¸ä¸€è‡´äº†ï¼
```

**æ­£ç¡®åšæ³•**ï¼šæŒ‡å®šå›æ»šå¼‚å¸¸
```java
// æŒ‡å®šBusinessExceptionä¹Ÿè¦å›æ»š
@Transactional(rollbackFor = BusinessException.class)
public void transferMoney(Long fromId, Long toId, BigDecimal amount) 
    throws BusinessException {
    
    accountDao.deduct(fromId, amount);
    
    if (amount.compareTo(new BigDecimal("10000")) > 0) {
        throw new BusinessException("è½¬è´¦é‡‘é¢è¶…é™");  // ç°åœ¨ä¼šå›æ»šäº†
    }
    
    accountDao.add(toId, amount);
}
```

### 7.3 å¸¸è§ç”¨æ³•


**æ–¹å¼1ï¼šæŒ‡å®šå•ä¸ªå¼‚å¸¸**
```java
@Transactional(rollbackFor = BusinessException.class)
public void method1() { }
```

**æ–¹å¼2ï¼šæŒ‡å®šå¤šä¸ªå¼‚å¸¸**
```java
@Transactional(rollbackFor = {
    BusinessException.class, 
    SQLException.class,
    IOException.class
})
public void method2() { }
```

**æ–¹å¼3ï¼šæŒ‡å®šæ‰€æœ‰å¼‚å¸¸ï¼ˆæœ€ä¿é™©ï¼‰**
```java
// æ¨èï¼šæ‰€æœ‰å¼‚å¸¸éƒ½å›æ»š
@Transactional(rollbackFor = Exception.class)
public void method3() { }
```

### 7.4 æœ€ä½³å®è·µ


> ğŸ’¡ **å›¢é˜Ÿè§„èŒƒå»ºè®®**
> 
> **ç»Ÿä¸€è§„åˆ™**ï¼šæ‰€æœ‰`@Transactional`éƒ½åŠ ä¸Š`rollbackFor = Exception.class`
> 
> ```java
> // ç»Ÿä¸€é…ç½®åŸºç±»
> @Transactional(rollbackFor = Exception.class)
> public abstract class BaseService {
>     // å­ç±»ç»§æ‰¿è¿™ä¸ªé…ç½®
> }
> 
> // æˆ–è€…ç”¨AOPç»Ÿä¸€é…ç½®
> @Aspect
> @Component
> public class TransactionConfig {
>     @Around("@annotation(transactional)")
>     public Object around(ProceedingJoinPoint pjp, Transactional transactional) {
>         // å¼ºåˆ¶æ‰€æœ‰äº‹åŠ¡éƒ½å›æ»šæ‰€æœ‰å¼‚å¸¸
>     }
> }
> ```

### 7.5 å¼‚å¸¸ç±»å‹å¯¹ç…§è¡¨


| å¼‚å¸¸ç±»å‹ | æ˜¯å¦å›æ»š | ç¤ºä¾‹ |
|---------|---------|------|
| `RuntimeException` | âœ… è‡ªåŠ¨å›æ»š | `NullPointerException` |
| `Error` | âœ… è‡ªåŠ¨å›æ»š | `OutOfMemoryError` |
| `Exception`ï¼ˆæ£€æŸ¥å¼‚å¸¸ï¼‰ | âŒ é»˜è®¤ä¸å›æ»š | `IOException`, `SQLException` |
| è‡ªå®šä¹‰æ£€æŸ¥å¼‚å¸¸ | âŒ é»˜è®¤ä¸å›æ»š | `BusinessException extends Exception` |

**è®°å¿†æŠ€å·§**ï¼šåªæœ‰`RuntimeException`å’Œ`Error`é»˜è®¤å›æ»šï¼Œå…¶ä»–éƒ½è¦æ‰‹åŠ¨æŒ‡å®šï¼

---

## 8. â­ï¸ noRollbackFor - ä¸å›æ»šå¼‚å¸¸æŒ‡å®š


### 8.1 ä½¿ç”¨åœºæ™¯


**é€šä¿—ç†è§£**ï¼šæŸäº›å¼‚å¸¸ä¸åº”è¯¥å¯¼è‡´å›æ»šï¼Œæ¯”å¦‚è®°å½•æ—¥å¿—å¤±è´¥ã€å‘é€é€šçŸ¥å¤±è´¥ç­‰ï¼Œä¸å½±å“ä¸»ä¸šåŠ¡ã€‚

> ğŸ“Œ **å…¸å‹åœºæ™¯**
> 
> - å®¡è®¡æ—¥å¿—è®°å½•å¤±è´¥
> - æ¶ˆæ¯é€šçŸ¥å‘é€å¤±è´¥
> - ç¼“å­˜æ“ä½œå¤±è´¥
> - éå…³é”®æ•°æ®ä¿å­˜å¤±è´¥

### 8.2 åŸºæœ¬ä½¿ç”¨


```java
@Transactional(
    rollbackFor = Exception.class,  // æ‰€æœ‰å¼‚å¸¸å›æ»š
    noRollbackFor = LogException.class  // é™¤äº†æ—¥å¿—å¼‚å¸¸
)
public void createOrder(Order order) {
    // ä¿å­˜è®¢å•ï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼‰
    orderDao.insert(order);
    
    try {
        // è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆéæ ¸å¿ƒï¼‰
        auditLogService.save(order);
    } catch (LogException e) {
        // æ—¥å¿—å¤±è´¥ä¸å½±å“è®¢å•åˆ›å»º
        log.error("å®¡è®¡æ—¥å¿—è®°å½•å¤±è´¥", e);
    }
    
    // è®¢å•åˆ›å»ºæˆåŠŸï¼Œå³ä½¿æ—¥å¿—å¤±è´¥ä¹Ÿæäº¤
}
```

### 8.3 å®é™…æ¡ˆä¾‹


**åœºæ™¯ï¼šè®¢å•åˆ›å»º + å‘é€é€šçŸ¥**
```java
@Service
public class OrderService {
    
    @Autowired
    private NotificationService notificationService;
    
    @Transactional(
        rollbackFor = Exception.class,
        noRollbackFor = NotificationException.class
    )
    public void createOrderWithNotify(Order order) {
        // 1. ä¿å­˜è®¢å•ï¼ˆå¿…é¡»æˆåŠŸï¼‰
        orderDao.insert(order);
        
        // 2. æ‰£å‡åº“å­˜ï¼ˆå¿…é¡»æˆåŠŸï¼‰
        productDao.reduceStock(order.getProductId(), order.getQuantity());
        
        // 3. å‘é€é€šçŸ¥ï¼ˆå¤±è´¥ä¸å½±å“è®¢å•ï¼‰
        try {
            notificationService.sendSMS(order.getUserPhone(), "è®¢å•åˆ›å»ºæˆåŠŸ");
        } catch (NotificationException e) {
            // é€šçŸ¥å¤±è´¥ï¼Œä½†è®¢å•å·²åˆ›å»ºæˆåŠŸ
            log.warn("çŸ­ä¿¡å‘é€å¤±è´¥ï¼Œè®¢å•å·ï¼š{}", order.getId());
        }
    }
}
```

### 8.4 ä¸rollbackForç»„åˆä½¿ç”¨


```java
// å®Œæ•´é…ç½®ç¤ºä¾‹
@Transactional(
    rollbackFor = Exception.class,           // é»˜è®¤æ‰€æœ‰å¼‚å¸¸å›æ»š
    noRollbackFor = {                        // ä½†è¿™äº›å¼‚å¸¸ä¸å›æ»š
        NotificationException.class,
        CacheException.class,
        LogException.class
    }
)
public void complexOperation() {
    // æ ¸å¿ƒä¸šåŠ¡
    coreBusinessLogic();
    
    // éæ ¸å¿ƒæ“ä½œï¼ˆå¤±è´¥ä¸å½±å“äº‹åŠ¡ï¼‰
    sendNotification();
    updateCache();
    writeLog();
}
```

### 8.5 æ³¨æ„äº‹é¡¹


> âš ï¸ **ä½¿ç”¨è­¦å‘Š**
> 
> - è°¨æ…ä½¿ç”¨ï¼Œç¡®ä¿ä¸å›æ»šçš„å¼‚å¸¸çœŸçš„ä¸å½±å“æ•°æ®ä¸€è‡´æ€§
> - éæ ¸å¿ƒä¸šåŠ¡å¤±è´¥è¦è®°å½•æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥
> - å»ºè®®ç”¨try-catchæ˜ç¡®æ•è·ï¼Œè€Œä¸æ˜¯åªé `noRollbackFor`

---

## 9. ğŸ¯ å±æ€§ç»„åˆä½¿ç”¨æœ€ä½³å®è·µ


### 9.1 å¸¸ç”¨ç»„åˆæ¨¡æ¿


**æ¨¡æ¿1ï¼šæ™®é€šå¢åˆ æ”¹æ“ä½œ**
```java
@Transactional(rollbackFor = Exception.class)
public void normalUpdate() {
    // æœ€ç®€å•çš„é…ç½®ï¼Œé€‚åˆ90%çš„åœºæ™¯
}
```

**æ¨¡æ¿2ï¼šæŸ¥è¯¢æ“ä½œ**
```java
@Transactional(
    propagation = Propagation.SUPPORTS,
    readOnly = true
)
public List<User> queryUsers() {
    // æŸ¥è¯¢ä¼˜åŒ–é…ç½®
}
```

**æ¨¡æ¿3ï¼šæ‰¹é‡å¤„ç†**
```java
@Transactional(
    propagation = Propagation.REQUIRED,
    rollbackFor = Exception.class,
    timeout = 30
)
public void batchProcess(List<Order> orders) {
    // æ‰¹é‡æ“ä½œï¼Œè®¾ç½®è¶…æ—¶
}
```

**æ¨¡æ¿4ï¼šå¤šæ•°æ®æºæ“ä½œ**
```java
@Transactional(
    transactionManager = "orderTxManager",
    propagation = Propagation.REQUIRED,
    rollbackFor = Exception.class
)
public void saveOrder(Order order) {
    // æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨
}
```

**æ¨¡æ¿5ï¼šç‹¬ç«‹äº‹åŠ¡ï¼ˆæ—¥å¿—ã€é€šçŸ¥ï¼‰**
```java
@Transactional(
    propagation = Propagation.REQUIRES_NEW,
    rollbackFor = Exception.class
)
public void saveLog(String message) {
    // ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸å—å¤–éƒ¨å½±å“
}
```

### 9.2 ä¸åŒåœºæ™¯çš„é…ç½®å¯¹ç…§


| åœºæ™¯ | propagation | isolation | timeout | readOnly | rollbackFor |
|------|------------|-----------|---------|----------|------------|
| æ™®é€šå¢åˆ æ”¹ | REQUIRED | DEFAULT | ä¸è®¾ç½® | false | Exception.class |
| æŸ¥è¯¢æ“ä½œ | SUPPORTS | DEFAULT | ä¸è®¾ç½® | **true** | - |
| æ‰¹é‡å¯¼å…¥ | REQUIRED | DEFAULT | **30-60** | false | Exception.class |
| ç‹¬ç«‹æ—¥å¿— | **REQUIRES_NEW** | DEFAULT | ä¸è®¾ç½® | false | Exception.class |
| é‡‘èè½¬è´¦ | REQUIRED | **SERIALIZABLE** | **10** | false | Exception.class |
| æŠ¥è¡¨ç”Ÿæˆ | SUPPORTS | READ_COMMITTED | **30** | **true** | - |

### 9.3 å®é™…é¡¹ç›®é…ç½®ç¤ºä¾‹


```java
@Service
public class OrderServiceImpl implements OrderService {
    
    // åˆ›å»ºè®¢å•ï¼šæ ‡å‡†é…ç½®
    @Transactional(rollbackFor = Exception.class)
    @Override
    public void createOrder(Order order) {
        orderDao.insert(order);
        productDao.reduceStock(order.getProductId());
    }
    
    // è®¢å•æŸ¥è¯¢ï¼šåªè¯»ä¼˜åŒ–
    @Transactional(
        propagation = Propagation.SUPPORTS,
        readOnly = true
    )
    @Override
    public Order getOrderById(Long id) {
        return orderDao.selectById(id);
    }
    
    // æ‰¹é‡å¯¼å…¥ï¼šè®¾ç½®è¶…æ—¶
    @Transactional(
        rollbackFor = Exception.class,
        timeout = 60
    )
    @Override
    public void batchImport(List<Order> orders) {
        orders.forEach(orderDao::insert);
    }
    
    // è®¢å•å–æ¶ˆï¼šå¤šæ•°æ®æº
    @Transactional(
        transactionManager = "orderTxManager",
        rollbackFor = Exception.class
    )
    @Override
    public void cancelOrder(Long orderId) {
        orderDao.updateStatus(orderId, "CANCELLED");
        refundDao.createRefund(orderId);
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…çŸ¥å¿…ä¼šçš„æ ¸å¿ƒå±æ€§


```
ğŸ”¸ transactionManagerï¼šå¤šæ•°æ®æºå¿…é¡»æŒ‡å®š
ğŸ”¸ propagationï¼šæ§åˆ¶äº‹åŠ¡ä¼ æ’­ï¼Œé»˜è®¤REQUIREDå³å¯
ğŸ”¸ isolationï¼šç”¨æ•°æ®åº“é»˜è®¤ï¼Œç‰¹æ®Šåœºæ™¯æ‰æ”¹
ğŸ”¸ timeoutï¼šæ‰¹é‡æ“ä½œå¿…é¡»è®¾ç½®
ğŸ”¸ readOnlyï¼šæ‰€æœ‰æŸ¥è¯¢éƒ½è¦åŠ 
ğŸ”¸ rollbackForï¼šåŠ¡å¿…åŠ ä¸ŠException.class
ğŸ”¸ noRollbackForï¼šè°¨æ…ä½¿ç”¨ï¼Œéæ ¸å¿ƒæ“ä½œå¤±è´¥æ—¶
```

### 10.2 æœ€ä½³å®è·µé€ŸæŸ¥è¡¨


| å®è·µ | è¯´æ˜ |
|------|------|
| âœ… **æŸ¥è¯¢åŠ readOnly** | `@Transactional(readOnly = true)` |
| âœ… **å¢åˆ æ”¹åŠ rollbackFor** | `@Transactional(rollbackFor = Exception.class)` |
| âœ… **æ‰¹é‡æ“ä½œåŠ timeout** | `@Transactional(timeout = 30)` |
| âœ… **å¤šæ•°æ®æºæŒ‡å®šmanager** | `@Transactional(transactionManager = "xxx")` |
| âœ… **ç‹¬ç«‹äº‹åŠ¡ç”¨REQUIRES_NEW** | æ—¥å¿—ã€é€šçŸ¥ç­‰ç‹¬ç«‹æ“ä½œ |
| âŒ **é¿å…è¿‡åº¦é…ç½®** | ä¸éœ€è¦çš„å±æ€§ä¸è¦è®¾ç½® |
| âŒ **é¿å…äº‹åŠ¡åµŒå¥—è¿‡æ·±** | æ§åˆ¶åœ¨3å±‚ä»¥å†… |

### 10.3 å¸¸è§é”™è¯¯æ€»ç»“


> âš ï¸ **é”™è¯¯1ï¼šæ£€æŸ¥å¼‚å¸¸ä¸å›æ»š**
> 
> ```java
> // é”™è¯¯
> @Transactional
> public void method() throws Exception { }
> 
> // æ­£ç¡®
> @Transactional(rollbackFor = Exception.class)
> public void method() throws Exception { }
> ```

> âš ï¸ **é”™è¯¯2ï¼šæŸ¥è¯¢æ–¹æ³•ä¸åŠ readOnly**
> 
> ```java
> // é”™è¯¯
> @Transactional
> public List<User> query() { }
> 
> // æ­£ç¡®  
> @Transactional(readOnly = true)
> public List<User> query() { }
> ```

> âš ï¸ **é”™è¯¯3ï¼šæ‰¹é‡æ“ä½œä¸è®¾è¶…æ—¶**
> 
> ```java
> // é”™è¯¯
> @Transactional
> public void batchImport(List<Data> list) { }
> 
> // æ­£ç¡®
> @Transactional(timeout = 60)
> public void batchImport(List<Data> list) { }
> ```

### 10.4 è®°å¿†å£è¯€


```
äº‹åŠ¡å±æ€§è®°å¿ƒé—´ï¼Œä¸ƒå¤§é…ç½®è¦ç†Ÿç»ƒ
æŸ¥è¯¢æ–¹æ³•åŠ åªè¯»ï¼Œå¢åˆ æ”¹è¦é˜²å¼‚å¸¸
æ‰¹é‡æ“ä½œè®¾è¶…æ—¶ï¼Œå¤šåº“æŒ‡å®šç®¡ç†å™¨
ä¼ æ’­è¡Œä¸ºé€‰åˆé€‚ï¼Œéš”ç¦»çº§åˆ«ç”¨é»˜è®¤
å›æ»šå¼‚å¸¸å…¨è¦†ç›–ï¼Œä¸å›æ»šçš„è¦è°¨æ…
```

### 10.5 è¿›é˜¶å­¦ä¹ å»ºè®®


- ğŸ“š **æ·±å…¥ç†è§£äº‹åŠ¡ä¼ æ’­**ï¼šç”»å›¾ç†è§£åµŒå¥—è°ƒç”¨çš„äº‹åŠ¡è¡Œä¸º
- ğŸ” **ç ”ç©¶æºç å®ç°**ï¼šçœ‹Spring AOPå¦‚ä½•æ‹¦æˆªäº‹åŠ¡æ–¹æ³•
- ğŸ’ª **å¤šåšå®éªŒ**ï¼šä¸åŒé…ç½®ç»„åˆçš„å®é™…æ•ˆæœ
- âš¡ **æ€§èƒ½æµ‹è¯•**ï¼šå¯¹æ¯”ä¸åŒéš”ç¦»çº§åˆ«çš„æ€§èƒ½å·®å¼‚
- ğŸ› **é—®é¢˜æ’æŸ¥**ï¼šå­¦ä¼šé€šè¿‡æ—¥å¿—åˆ†æäº‹åŠ¡é—®é¢˜

---

**æ ¸å¿ƒè®°å¿†**ï¼š
- `@Transactional`å°±æ˜¯ç»™æ–¹æ³•åŠ "äº‹åŠ¡ä¿æŠ¤ç½©"
- 7ä¸ªå±æ€§å„å¸å…¶èŒï¼Œæœ€å¸¸ç”¨çš„æ˜¯`rollbackFor`å’Œ`readOnly`
- æŸ¥è¯¢åŠ `readOnly`ï¼Œå¢åˆ æ”¹åŠ `rollbackFor = Exception.class`
- æ‰¹é‡æ“ä½œè®°å¾—è®¾`timeout`ï¼Œå¤šæ•°æ®æºæŒ‡å®š`transactionManager`
- é»˜è®¤é…ç½®å¤Ÿç”¨90%çš„åœºæ™¯ï¼Œç‰¹æ®Šéœ€æ±‚å†è°ƒæ•´