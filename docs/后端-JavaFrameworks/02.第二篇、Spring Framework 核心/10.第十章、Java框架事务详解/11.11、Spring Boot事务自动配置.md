---
title: 11ã€Spring Bootäº‹åŠ¡è‡ªåŠ¨é…ç½®
---
## ğŸ“š ç›®å½•

1. [Spring Bootè‡ªåŠ¨é…ç½®æ¦‚è¿°](#1-Spring-Bootè‡ªåŠ¨é…ç½®æ¦‚è¿°)
2. [äº‹åŠ¡è‡ªåŠ¨é…ç½®æ ¸å¿ƒåŸç†](#2-äº‹åŠ¡è‡ªåŠ¨é…ç½®æ ¸å¿ƒåŸç†)
3. [é»˜è®¤äº‹åŠ¡ç®¡ç†å™¨æœºåˆ¶](#3-é»˜è®¤äº‹åŠ¡ç®¡ç†å™¨æœºåˆ¶)
4. [è‡ªåŠ¨é…ç½®æ¡ä»¶è¯¦è§£](#4-è‡ªåŠ¨é…ç½®æ¡ä»¶è¯¦è§£)
5. [é…ç½®ä¼˜å…ˆçº§ä¸è¦†ç›–](#5-é…ç½®ä¼˜å…ˆçº§ä¸è¦†ç›–)
6. [application.propertiesäº‹åŠ¡é…ç½®](#6-application-propertiesäº‹åŠ¡é…ç½®)
7. [starterä¾èµ–ä¸è‡ªåŠ¨è£…é…](#7-starterä¾èµ–ä¸è‡ªåŠ¨è£…é…)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ Spring Bootè‡ªåŠ¨é…ç½®æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯è‡ªåŠ¨é…ç½®


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ å»é…’åº—ä½å®¿ï¼Œä¸éœ€è¦è‡ªå·±å‡†å¤‡åºŠå•ã€æ¯›å·¾ã€çƒ­æ°´å™¨ï¼Œé…’åº—éƒ½å·²ç»ç»™ä½ é…å¥½äº†ã€‚Spring Bootçš„è‡ªåŠ¨é…ç½®å°±æ˜¯è¿™ä¸ªé“ç†â€”â€”ä½ åªéœ€è¦å¼•å…¥ä¾èµ–ï¼Œæ¡†æ¶è‡ªåŠ¨å¸®ä½ æŠŠéœ€è¦çš„ç»„ä»¶éƒ½é…ç½®å¥½ã€‚

```
ä¼ ç»ŸSpringé…ç½®ï¼ˆæ‰‹åŠ¨é…ç½®ï¼‰ï¼š
ä½ éœ€è¦ï¼š
1. é…ç½®æ•°æ®æº
2. é…ç½®äº‹åŠ¡ç®¡ç†å™¨
3. é…ç½®äº‹åŠ¡å¢å¼ºå™¨
4. å¼€å¯äº‹åŠ¡æ³¨è§£
...ä¸€å¤§å †XMLæˆ–Javaé…ç½®

Spring Bootè‡ªåŠ¨é…ç½®ï¼ˆå¼€ç®±å³ç”¨ï¼‰ï¼š
ä½ åªéœ€è¦ï¼š
1. æ·»åŠ spring-boot-starter-jdbcä¾èµ–
2. é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯
â†’ å…¶ä»–å…¨éƒ¨è‡ªåŠ¨å®Œæˆï¼
```

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ¯ **é›¶é…ç½®å¯åŠ¨**ï¼šå¼•å…¥ä¾èµ–å°±èƒ½ç”¨
- ğŸ”§ **æ™ºèƒ½é»˜è®¤å€¼**ï¼šæä¾›åˆç†çš„é»˜è®¤é…ç½®
- ğŸ¨ **æŒ‰éœ€å®šåˆ¶**ï¼šéœ€è¦æ—¶å¯ä»¥è¦†ç›–é»˜è®¤é…ç½®
- âš¡ **å¿«é€Ÿå¼€å‘**ï¼šå¤§å¹…å‡å°‘é…ç½®ä»£ç 

### 1.2 è‡ªåŠ¨é…ç½®çš„å·¥ä½œåŸç†


**å·¥ä½œæµç¨‹å›¾**ï¼š
```
åº”ç”¨å¯åŠ¨
   â†“
æ‰«æclasspathä¸­çš„jaråŒ…
   â†“
è¯»å–spring.factoriesæ–‡ä»¶
   â†“
åŠ è½½è‡ªåŠ¨é…ç½®ç±»
   â†“
æ ¹æ®æ¡ä»¶åˆ¤æ–­æ˜¯å¦ç”Ÿæ•ˆ
   â†“
åˆ›å»ºå¹¶æ³¨å†Œç›¸åº”çš„Bean
   â†“
åº”ç”¨å¯ä»¥ç›´æ¥ä½¿ç”¨
```

**å…³é”®æœºåˆ¶**ï¼š
- ğŸ“¦ **@EnableAutoConfiguration**ï¼šå¼€å¯è‡ªåŠ¨é…ç½®æ€»å¼€å…³
- ğŸ” **spring.factories**ï¼šè‡ªåŠ¨é…ç½®ç±»çš„æ¸…å•
- ğŸ¯ **@Conditional**ï¼šæ¡ä»¶åŒ–è£…é…ï¼ŒæŒ‰éœ€ç”Ÿæ•ˆ
- ğŸ”„ **@ConfigurationProperties**ï¼šç»‘å®šé…ç½®æ–‡ä»¶å±æ€§

---

## 2. âš™ï¸ äº‹åŠ¡è‡ªåŠ¨é…ç½®æ ¸å¿ƒåŸç†


### 2.1 TransactionAutoConfigurationç±»è¯¦è§£


**æ ¸å¿ƒé…ç½®ç±»**ï¼šè¿™æ˜¯Spring Bootäº‹åŠ¡è‡ªåŠ¨é…ç½®çš„"å¤§è„‘"

```java
// ç®€åŒ–ç‰ˆæ ¸å¿ƒä»£ç ç†è§£
@Configuration  // æ ‡è®°ä¸ºé…ç½®ç±»
@ConditionalOnClass(PlatformTransactionManager.class)  // æ¡ä»¶ï¼šç±»è·¯å¾„ä¸‹æœ‰äº‹åŠ¡ç®¡ç†å™¨æ¥å£
@EnableConfigurationProperties(TransactionProperties.class)  // ç»‘å®šé…ç½®å±æ€§
public class TransactionAutoConfiguration {
    
    // åˆ›å»ºäº‹åŠ¡æ¨¡æ¿ï¼ˆç”¨äºç¼–ç¨‹å¼äº‹åŠ¡ï¼‰
    @Bean
    @ConditionalOnMissingBean
    public TransactionTemplate transactionTemplate(
            PlatformTransactionManager transactionManager) {
        return new TransactionTemplate(transactionManager);
    }
    
    // å†…éƒ¨é…ç½®ï¼šå¯ç”¨äº‹åŠ¡æ³¨è§£æ”¯æŒ
    @Configuration
    @ConditionalOnBean(TransactionManager.class)
    @EnableTransactionManagement  // å¼€å¯@Transactionalæ³¨è§£æ”¯æŒ
    protected static class EnableTransactionManagementConfiguration {
        // ...
    }
}
```

**å…³é”®è¦ç‚¹ç†è§£**ï¼š

ğŸ”¹ **@ConditionalOnClass**ï¼šå½“ä½ çš„é¡¹ç›®é‡Œæœ‰`PlatformTransactionManager`è¿™ä¸ªç±»æ—¶æ‰ç”Ÿæ•ˆ
- é€šä¿—è¯´ï¼šåªæœ‰å¼•å…¥äº†äº‹åŠ¡ç›¸å…³çš„jaråŒ…ï¼Œè¿™ä¸ªé…ç½®æ‰ä¼šå¯åŠ¨
- é¿å…æ— ç”¨é…ç½®ï¼šå¦‚æœé¡¹ç›®æ ¹æœ¬ä¸éœ€è¦äº‹åŠ¡ï¼Œè¿™ä¸ªé…ç½®å°±ä¸ä¼šåŠ è½½

ğŸ”¹ **@EnableConfigurationProperties**ï¼šæŠŠé…ç½®æ–‡ä»¶çš„å€¼ç»‘å®šåˆ°`TransactionProperties`å¯¹è±¡
- é€šä¿—è¯´ï¼šæŠŠä½ åœ¨`application.properties`é‡Œå†™çš„`spring.transaction.*`é…ç½®è¯»è¿›æ¥
- ä½œç”¨ï¼šè®©ä½ å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶äº‹åŠ¡è¡Œä¸º

ğŸ”¹ **@ConditionalOnMissingBean**ï¼šå¦‚æœä½ æ²¡æœ‰è‡ªå·±é…ç½®ï¼Œæˆ‘æ‰ç”¨é»˜è®¤çš„
- é€šä¿—è¯´ï¼šä½ è‡ªå·±é…äº†å°±ç”¨ä½ çš„ï¼Œæ²¡é…æˆ‘å°±ç»™ä½ ä¸ªé»˜è®¤çš„
- è®¾è®¡åŸåˆ™ï¼šç”¨æˆ·é…ç½®ä¼˜å…ˆ

### 2.2 è‡ªåŠ¨é…ç½®çš„è§¦å‘æ—¶æœº


**ä»€ä¹ˆæ—¶å€™ä¼šè‡ªåŠ¨é…ç½®äº‹åŠ¡ï¼Ÿ**

```
è§¦å‘æ¡ä»¶æ£€æŸ¥æµç¨‹ï¼š

1. ç±»è·¯å¾„æ£€æŸ¥
   âœ… å­˜åœ¨PlatformTransactionManageræ¥å£ï¼Ÿ
   â†’ YESï¼šç»§ç»­æ£€æŸ¥
   â†’ NOï¼šè·³è¿‡äº‹åŠ¡è‡ªåŠ¨é…ç½®

2. Beanå­˜åœ¨æ€§æ£€æŸ¥
   âœ… å®¹å™¨ä¸­å·²æœ‰TransactionManagerï¼Ÿ
   â†’ YESï¼šå¯ç”¨@Transactionalæ”¯æŒ
   â†’ NOï¼šå°è¯•åˆ›å»ºé»˜è®¤çš„

3. æ•°æ®æºæ£€æŸ¥
   âœ… å­˜åœ¨DataSourceç±»ï¼Ÿ
   â†’ YESï¼šåˆ›å»ºDataSourceTransactionManager
   â†’ NOï¼šæ£€æŸ¥å…¶ä»–äº‹åŠ¡ç®¡ç†å™¨

4. ç”¨æˆ·é…ç½®æ£€æŸ¥
   âœ… ç”¨æˆ·è‡ªå®šä¹‰äº†TransactionManagerï¼Ÿ
   â†’ YESï¼šä½¿ç”¨ç”¨æˆ·çš„é…ç½®
   â†’ NOï¼šä½¿ç”¨è‡ªåŠ¨é…ç½®çš„é»˜è®¤å€¼
```

**å®é™…åœºæ™¯ä¸¾ä¾‹**ï¼š

åœºæ™¯1ï¼šçº¯JPAé¡¹ç›®
```
ä¾èµ–ï¼šspring-boot-starter-data-jpa
â†“
è‡ªåŠ¨æ£€æµ‹åˆ°JpaTransactionManager
â†“
è‡ªåŠ¨é…ç½®JPAäº‹åŠ¡ç®¡ç†å™¨
â†“
@Transactionalæ³¨è§£å¯ç”¨
```

åœºæ™¯2ï¼šçº¯JDBCé¡¹ç›®
```
ä¾èµ–ï¼šspring-boot-starter-jdbc
â†“
è‡ªåŠ¨æ£€æµ‹åˆ°DataSource
â†“
è‡ªåŠ¨é…ç½®DataSourceTransactionManager
â†“
@Transactionalæ³¨è§£å¯ç”¨
```

åœºæ™¯3ï¼šåŒæ—¶ä½¿ç”¨JPAå’ŒJDBC
```
ä¾èµ–ï¼šåŒæ—¶åŒ…å«JPAå’ŒJDBC
â†“
ä¼˜å…ˆä½¿ç”¨JpaTransactionManagerï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰
â†“
å¯ä»¥é€šè¿‡é…ç½®æŒ‡å®šä½¿ç”¨å“ªä¸ª
```

---

## 3. ğŸ”§ é»˜è®¤äº‹åŠ¡ç®¡ç†å™¨æœºåˆ¶


### 3.1 äº‹åŠ¡ç®¡ç†å™¨çš„é€‰æ‹©è§„åˆ™


**Spring Bootå¦‚ä½•å†³å®šç”¨å“ªä¸ªäº‹åŠ¡ç®¡ç†å™¨ï¼Ÿ**

| ä¼˜å…ˆçº§ | æ¡ä»¶ | åˆ›å»ºçš„äº‹åŠ¡ç®¡ç†å™¨ | ä½¿ç”¨åœºæ™¯ |
|-------|------|----------------|---------|
| **æœ€é«˜** | `å­˜åœ¨EntityManagerFactory` | `JpaTransactionManager` | `JPA/Hibernateé¡¹ç›®` |
| **æ¬¡é«˜** | `å­˜åœ¨DataSource` | `DataSourceTransactionManager` | `çº¯JDBC/MyBatisé¡¹ç›®` |
| **å…œåº•** | `ç”¨æˆ·è‡ªå®šä¹‰` | `è‡ªå®šä¹‰TransactionManager` | `ç‰¹æ®Šéœ€æ±‚åœºæ™¯` |

**é€šä¿—ç†è§£**ï¼š
- JPAé¡¹ç›®ï¼šSpring Bootè¯´"çœ‹ä½ ç”¨JPAï¼Œç»™ä½ JPAä¸“ç”¨çš„äº‹åŠ¡ç®¡ç†å™¨"
- JDBCé¡¹ç›®ï¼šSpring Bootè¯´"çœ‹ä½ ç”¨JDBCï¼Œç»™ä½ JDBCä¸“ç”¨çš„äº‹åŠ¡ç®¡ç†å™¨"
- è‡ªå®šä¹‰ï¼šä½ è¯´"æˆ‘è‡ªå·±é…ï¼Œåˆ«ç®¡æˆ‘"

### 3.2 é»˜è®¤äº‹åŠ¡ç®¡ç†å™¨é…ç½®æºç 


```java
// DataSourceäº‹åŠ¡ç®¡ç†å™¨è‡ªåŠ¨é…ç½®
@Configuration
@ConditionalOnClass({ JdbcTemplate.class, TransactionManager.class })
@ConditionalOnSingleCandidate(DataSource.class)
public class DataSourceTransactionManagerAutoConfiguration {
    
    @Bean
    @ConditionalOnMissingBean(TransactionManager.class)
    public DataSourceTransactionManager transactionManager(
            DataSource dataSource) {
        // åˆ›å»ºæ•°æ®æºäº‹åŠ¡ç®¡ç†å™¨
        return new DataSourceTransactionManager(dataSource);
    }
}
```

**å…³é”®æ¡ä»¶è§£è¯»**ï¼š

ğŸ”¹ **@ConditionalOnClass**
- æ£€æŸ¥æ¡ä»¶ï¼šç±»è·¯å¾„æœ‰`JdbcTemplate`å’Œ`TransactionManager`
- å®é™…å«ä¹‰ï¼šé¡¹ç›®å¼•å…¥äº†JDBCç›¸å…³ä¾èµ–
- é€šä¿—è¯´æ³•ï¼š"çœ‹ä½ æœ‰JDBCå·¥å…·ï¼Œæˆ‘ç»™ä½ é…JDBCäº‹åŠ¡"

ğŸ”¹ **@ConditionalOnSingleCandidate(DataSource.class)**
- æ£€æŸ¥æ¡ä»¶ï¼šå®¹å™¨ä¸­æœ‰ä¸”åªæœ‰ä¸€ä¸ªä¸»æ•°æ®æº
- å®é™…å«ä¹‰ï¼šç¡®ä¿ä¸ä¼šåˆ›å»ºå¤šä¸ªäº‹åŠ¡ç®¡ç†å™¨å†²çª
- é€šä¿—è¯´æ³•ï¼š"ç¡®è®¤åªæœ‰ä¸€ä¸ªæ•°æ®æºï¼Œé¿å…æ··ä¹±"

ğŸ”¹ **@ConditionalOnMissingBean(TransactionManager.class)**
- æ£€æŸ¥æ¡ä»¶ï¼šå®¹å™¨ä¸­è¿˜æ²¡æœ‰äº‹åŠ¡ç®¡ç†å™¨
- å®é™…å«ä¹‰ï¼šç”¨æˆ·æ²¡æœ‰è‡ªå®šä¹‰ï¼Œæ‰åˆ›å»ºé»˜è®¤çš„
- é€šä¿—è¯´æ³•ï¼š"ä½ æ²¡é…ï¼Œæˆ‘å°±ç»™ä½ é…ä¸ªé»˜è®¤çš„"

### 3.3 å¤šæ•°æ®æºåœºæ™¯çš„å¤„ç†


**é—®é¢˜**ï¼šå¦‚æœé¡¹ç›®æœ‰å¤šä¸ªæ•°æ®æºæ€ä¹ˆåŠï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š

æ–¹å¼1ï¼šæŒ‡å®šä¸»æ•°æ®æº
```java
@Configuration
public class DataSourceConfig {
    
    @Primary  // æ ‡è®°ä¸ºä¸»æ•°æ®æº
    @Bean
    public DataSource primaryDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    public DataSource secondaryDataSource() {
        return DataSourceBuilder.create().build();
    }
}
```

æ–¹å¼2ï¼šæ‰‹åŠ¨é…ç½®äº‹åŠ¡ç®¡ç†å™¨
```java
@Configuration
public class TransactionConfig {
    
    @Primary
    @Bean
    public PlatformTransactionManager primaryTxManager(
            @Qualifier("primaryDataSource") DataSource ds) {
        return new DataSourceTransactionManager(ds);
    }
    
    @Bean
    public PlatformTransactionManager secondaryTxManager(
            @Qualifier("secondaryDataSource") DataSource ds) {
        return new DataSourceTransactionManager(ds);
    }
}
```

**ä½¿ç”¨æ—¶æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨**ï¼š
```java
@Service
public class UserService {
    
    // ä½¿ç”¨ä¸»æ•°æ®æºäº‹åŠ¡
    @Transactional(transactionManager = "primaryTxManager")
    public void saveUser(User user) {
        // ...
    }
    
    // ä½¿ç”¨ä»æ•°æ®æºäº‹åŠ¡
    @Transactional(transactionManager = "secondaryTxManager")
    public void saveLog(Log log) {
        // ...
    }
}
```

---

## 4. ğŸ¯ è‡ªåŠ¨é…ç½®æ¡ä»¶è¯¦è§£


### 4.1 å¸¸ç”¨æ¡ä»¶æ³¨è§£è¯´æ˜


**@Conditionalç³»åˆ—æ³¨è§£**ï¼šå†³å®šé…ç½®æ˜¯å¦ç”Ÿæ•ˆçš„"å¼€å…³"

| æ³¨è§£ | ç”Ÿæ•ˆæ¡ä»¶ | å®é™…ç”¨é€” | ç¤ºä¾‹åœºæ™¯ |
|-----|---------|---------|---------|
| `@ConditionalOnClass` | `æŒ‡å®šç±»å­˜åœ¨äºclasspath` | `æ£€æµ‹ä¾èµ–æ˜¯å¦å¼•å…¥` | `æœ‰Jdbcç±»æ‰é…ç½®JDBCäº‹åŠ¡` |
| `@ConditionalOnMissingClass` | `æŒ‡å®šç±»ä¸å­˜åœ¨` | `é¿å…å†²çªé…ç½®` | `æ²¡æœ‰JPAæ—¶ç”¨JDBCäº‹åŠ¡` |
| `@ConditionalOnBean` | `æŒ‡å®šBeanå·²å­˜åœ¨` | `åŸºäºå·²æœ‰Beané…ç½®` | `æœ‰DataSourceæ‰é…äº‹åŠ¡` |
| `@ConditionalOnMissingBean` | `æŒ‡å®šBeanä¸å­˜åœ¨` | `æä¾›é»˜è®¤é…ç½®` | `ç”¨æˆ·æ²¡é…æ‰ç”¨é»˜è®¤çš„` |
| `@ConditionalOnProperty` | `é…ç½®å±æ€§æ»¡è¶³æ¡ä»¶` | `æ ¹æ®é…ç½®å¼€å…³åŠŸèƒ½` | `spring.jpa.enabled=true` |

### 4.2 æ¡ä»¶åˆ¤æ–­å®æˆ˜æ¡ˆä¾‹


**æ¡ˆä¾‹1ï¼šæ ¹æ®ç±»å­˜åœ¨æ€§å†³å®šé…ç½®**

```java
// JPAäº‹åŠ¡ç®¡ç†å™¨é…ç½®
@Configuration
@ConditionalOnClass(EntityManagerFactory.class)  // æœ‰JPAç›¸å…³ç±»
@ConditionalOnBean(EntityManagerFactory.class)   // ä¸”å·²åˆ›å»ºå®ä½“ç®¡ç†å™¨å·¥å‚
public class JpaTransactionManagerConfig {
    
    @Bean
    @ConditionalOnMissingBean(TransactionManager.class)
    public JpaTransactionManager transactionManager(
            EntityManagerFactory emf) {
        return new JpaTransactionManager(emf);
    }
}
```

**è§£è¯»**ï¼š
- ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥æœ‰æ²¡æœ‰`EntityManagerFactory`è¿™ä¸ªç±»ï¼ˆåˆ¤æ–­æ˜¯å¦JPAé¡¹ç›®ï¼‰
- ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥æœ‰æ²¡æœ‰åˆ›å»º`EntityManagerFactory`å®ä¾‹ï¼ˆåˆ¤æ–­JPAæ˜¯å¦å·²åˆå§‹åŒ–ï¼‰
- ç¬¬ä¸‰æ­¥ï¼šå¦‚æœæ²¡æœ‰äº‹åŠ¡ç®¡ç†å™¨ï¼Œå°±åˆ›å»ºJPAä¸“ç”¨çš„

**æ¡ˆä¾‹2ï¼šæ ¹æ®é…ç½®å±æ€§å†³å®šåŠŸèƒ½**

```java
@Configuration
@ConditionalOnProperty(
    prefix = "spring.transaction",
    name = "enabled",
    havingValue = "true",
    matchIfMissing = true  // é…ç½®ç¼ºå¤±æ—¶é»˜è®¤ä¸ºtrue
)
public class TransactionConfig {
    // äº‹åŠ¡ç›¸å…³é…ç½®
}
```

**è§£è¯»**ï¼š
- `prefix`ï¼šé…ç½®å‰ç¼€æ˜¯`spring.transaction`
- `name`ï¼šå…·ä½“é…ç½®é¡¹æ˜¯`enabled`
- `havingValue`ï¼šå€¼ä¸º`true`æ—¶ç”Ÿæ•ˆ
- `matchIfMissing`ï¼šæ²¡é…ç½®æ—¶é»˜è®¤ç”Ÿæ•ˆï¼ˆç”¨æˆ·ä¸é…ä¹Ÿèƒ½ç”¨ï¼‰

### 4.3 æ¡ä»¶åˆ¤æ–­çš„æ‰§è¡Œé¡ºåº


```
é…ç½®ç±»åŠ è½½æµç¨‹ï¼š

1. ç±»çº§åˆ«æ¡ä»¶æ£€æŸ¥
   @ConditionalOnClass â†’ æ£€æŸ¥ç±»æ˜¯å¦å­˜åœ¨
   â†“
2. Beançº§åˆ«æ¡ä»¶æ£€æŸ¥  
   @ConditionalOnBean â†’ æ£€æŸ¥ä¾èµ–Beanæ˜¯å¦å­˜åœ¨
   â†“
3. å±æ€§çº§åˆ«æ¡ä»¶æ£€æŸ¥
   @ConditionalOnProperty â†’ æ£€æŸ¥é…ç½®å±æ€§
   â†“
4. æ–¹æ³•çº§åˆ«æ¡ä»¶æ£€æŸ¥
   @ConditionalOnMissingBean â†’ æ£€æŸ¥Beanæ˜¯å¦å·²åˆ›å»º
   â†“
5. æ¡ä»¶å…¨éƒ¨æ»¡è¶³ â†’ åˆ›å»ºBean
   æ¡ä»¶ä¸æ»¡è¶³ â†’ è·³è¿‡é…ç½®
```

**å®é™…æ„ä¹‰**ï¼š
- âœ… å¿«é€Ÿå¤±è´¥ï¼šç±»éƒ½ä¸å­˜åœ¨ï¼Œåç»­æ£€æŸ¥éƒ½ä¸ç”¨åšäº†
- âœ… ç²¾ç¡®æ§åˆ¶ï¼šå¤šå±‚æ¡ä»¶ä¿è¯é…ç½®ä¸ä¼šå‡ºé”™
- âœ… çµæ´»æ‰©å±•ï¼šå¯ä»¥ç»„åˆå¤šä¸ªæ¡ä»¶å®ç°å¤æ‚é€»è¾‘

---

## 5. ğŸ“Š é…ç½®ä¼˜å…ˆçº§ä¸è¦†ç›–


### 5.1 é…ç½®ä¼˜å…ˆçº§è§„åˆ™


**Spring Booté…ç½®çš„ä¼˜å…ˆçº§ä»é«˜åˆ°ä½**ï¼š

```
ä¼˜å…ˆçº§æ’åºï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰ï¼š

1. ä»£ç ä¸­çš„@Beané…ç½®ï¼ˆç”¨æˆ·æ˜¾å¼é…ç½®ï¼‰
   â†“
2. å‘½ä»¤è¡Œå‚æ•° 
   --spring.datasource.url=...
   â†“
3. application.properties/ymlï¼ˆé¡¹ç›®é…ç½®æ–‡ä»¶ï¼‰
   spring.datasource.url=...
   â†“
4. è‡ªåŠ¨é…ç½®çš„é»˜è®¤å€¼
   DataSourcePropertiesé»˜è®¤å€¼
```

**é€šä¿—ç†è§£**ï¼š
- ä½ è‡ªå·±å†™çš„é…ç½® > å¯åŠ¨æ—¶ä¼ çš„å‚æ•° > é…ç½®æ–‡ä»¶ > æ¡†æ¶é»˜è®¤å€¼
- åŸåˆ™ï¼šç”¨æˆ·é…ç½®æ°¸è¿œä¼˜å…ˆï¼Œæ¡†æ¶æä¾›å…œåº•

### 5.2 è¦†ç›–è‡ªåŠ¨é…ç½®çš„æ–¹å¼


**æ–¹å¼1ï¼šé€šè¿‡@Beanè¦†ç›–**ï¼ˆæœ€ç›´æ¥ï¼‰

```java
@Configuration
public class MyTransactionConfig {
    
    // è‡ªå®šä¹‰äº‹åŠ¡ç®¡ç†å™¨ï¼Œä¼šè¦†ç›–è‡ªåŠ¨é…ç½®çš„
    @Bean
    public PlatformTransactionManager transactionManager(DataSource dataSource) {
        DataSourceTransactionManager tm = new DataSourceTransactionManager(dataSource);
        tm.setDefaultTimeout(30);  // è‡ªå®šä¹‰é»˜è®¤è¶…æ—¶æ—¶é—´30ç§’
        return tm;
    }
}
```

**æ–¹å¼2ï¼šé€šè¿‡é…ç½®æ–‡ä»¶è¦†ç›–**

```properties
# application.properties
# è¦†ç›–é»˜è®¤çš„äº‹åŠ¡è¶…æ—¶æ—¶é—´
spring.transaction.default-timeout=30

# è¦†ç›–é»˜è®¤çš„éš”ç¦»çº§åˆ«
spring.transaction.default-isolation=READ_COMMITTED

# è¦†ç›–é»˜è®¤çš„ä¼ æ’­è¡Œä¸º
spring.transaction.rollback-on-commit-failure=true
```

**æ–¹å¼3ï¼šé€šè¿‡@PrimaryæŒ‡å®šä¼˜å…ˆBean**

```java
@Configuration
public class MultiTransactionConfig {
    
    @Primary  // æ ‡è®°ä¸ºé¦–é€‰
    @Bean
    public PlatformTransactionManager primaryTransactionManager() {
        return new DataSourceTransactionManager(primaryDataSource());
    }
    
    @Bean
    public PlatformTransactionManager secondaryTransactionManager() {
        return new DataSourceTransactionManager(secondaryDataSource());
    }
}
```

### 5.3 è¦†ç›–é…ç½®çš„å®æˆ˜å»ºè®®


**æœ€ä½³å®è·µ**ï¼š

| åœºæ™¯ | æ¨èæ–¹å¼ | åŸå›  |
|-----|---------|------|
| **ä¸´æ—¶è°ƒè¯•** | `å‘½ä»¤è¡Œå‚æ•°` | `ä¸ä¿®æ”¹ä»£ç ï¼Œé‡å¯å³æ¢å¤` |
| **ç¯å¢ƒå·®å¼‚** | `é…ç½®æ–‡ä»¶(profile)` | `ä¸åŒç¯å¢ƒç”¨ä¸åŒé…ç½®æ–‡ä»¶` |
| **å¤æ‚å®šåˆ¶** | `@Beané…ç½®` | `å¯ä»¥å†™å¤æ‚çš„åˆå§‹åŒ–é€»è¾‘` |
| **ç®€å•è°ƒæ•´** | `é…ç½®å±æ€§` | `æ–¹ä¾¿ç»´æŠ¤ï¼Œä¸éœ€è¦ä»£ç ` |

**ç¤ºä¾‹ï¼šä¸åŒç¯å¢ƒçš„äº‹åŠ¡é…ç½®**

```properties
# application-dev.propertiesï¼ˆå¼€å‘ç¯å¢ƒï¼‰
spring.transaction.default-timeout=300
logging.level.org.springframework.transaction=DEBUG

# application-prod.propertiesï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
spring.transaction.default-timeout=30
logging.level.org.springframework.transaction=WARN
```

---

## 6. ğŸ“ application.propertiesäº‹åŠ¡é…ç½®


### 6.1 æ ¸å¿ƒäº‹åŠ¡é…ç½®å±æ€§


**å¸¸ç”¨é…ç½®é¡¹ä¸€è§ˆè¡¨**ï¼š

| é…ç½®é¡¹ | ä½œç”¨è¯´æ˜ | å¯é€‰å€¼ | é»˜è®¤å€¼ | ä½¿ç”¨åœºæ™¯ |
|-------|---------|-------|-------|---------|
| `spring.transaction.default-timeout` | `äº‹åŠ¡è¶…æ—¶æ—¶é—´(ç§’)` | `æ•´æ•°` | `æ— é™åˆ¶` | `é˜²æ­¢é•¿äº‹åŠ¡` |
| `spring.transaction.rollback-on-commit-failure` | `æäº¤å¤±è´¥æ˜¯å¦å›æ»š` | `true/false` | `false` | `ä¸¥æ ¼ä¸€è‡´æ€§è¦æ±‚` |
| `spring.jpa.properties.hibernate.enable_lazy_load_no_trans` | `æ‡’åŠ è½½é…ç½®` | `true/false` | `false` | `JPAå»¶è¿ŸåŠ è½½` |

### 6.2 å®ç”¨é…ç½®ç¤ºä¾‹


**åŸºç¡€é…ç½®**ï¼š
```properties
# ========== äº‹åŠ¡åŸºç¡€é…ç½® ==========
# å…¨å±€é»˜è®¤äº‹åŠ¡è¶…æ—¶æ—¶é—´ï¼š30ç§’
spring.transaction.default-timeout=30

# æäº¤å¤±è´¥æ—¶å›æ»šäº‹åŠ¡
spring.transaction.rollback-on-commit-failure=true
```

**æ•°æ®æºäº‹åŠ¡é…ç½®**ï¼š
```properties
# ========== æ•°æ®æºé…ç½® ==========
spring.datasource.url=jdbc:mysql://localhost:3306/mydb
spring.datasource.username=root
spring.datasource.password=123456
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# è¿æ¥æ± é…ç½®ï¼ˆå½±å“äº‹åŠ¡æ€§èƒ½ï¼‰
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=30000
```

**JPAäº‹åŠ¡é…ç½®**ï¼š
```properties
# ========== JPAäº‹åŠ¡é…ç½® ==========
# æ˜¾ç¤ºSQLï¼ˆæ–¹ä¾¿è°ƒè¯•äº‹åŠ¡ï¼‰
spring.jpa.show-sql=true

# DDLè‡ªåŠ¨æ›´æ–°ç­–ç•¥
spring.jpa.hibernate.ddl-auto=update

# ç¦ç”¨äº‹åŠ¡å¤–æ‡’åŠ è½½ï¼ˆé¿å…LazyInitializationExceptionï¼‰
spring.jpa.properties.hibernate.enable_lazy_load_no_trans=false
```

### 6.3 ä¸åŒåœºæ™¯çš„é…ç½®æ–¹æ¡ˆ


**åœºæ™¯1ï¼šé«˜å¹¶å‘ç³»ç»Ÿ**
```properties
# çŸ­è¶…æ—¶ï¼Œå¿«é€Ÿå¤±è´¥
spring.transaction.default-timeout=5

# è¿æ¥æ± è°ƒå¤§
spring.datasource.hikari.maximum-pool-size=50
spring.datasource.hikari.minimum-idle=10
```

**åœºæ™¯2ï¼šæ‰¹å¤„ç†ç³»ç»Ÿ**
```properties
# é•¿è¶…æ—¶ï¼Œå…è®¸æ‰¹é‡æ“ä½œ
spring.transaction.default-timeout=600

# æ‰¹é‡å¤§å°
spring.jpa.properties.hibernate.jdbc.batch_size=50
```

**åœºæ™¯3ï¼šå¾®æœåŠ¡ç³»ç»Ÿ**
```properties
# é€‚ä¸­è¶…æ—¶
spring.transaction.default-timeout=30

# ä¸¥æ ¼å›æ»š
spring.transaction.rollback-on-commit-failure=true

# é™åˆ¶è¿æ¥æ•°ï¼ˆé¿å…å ç”¨è¿‡å¤šèµ„æºï¼‰
spring.datasource.hikari.maximum-pool-size=10
```

---

## 7. ğŸ“¦ starterä¾èµ–ä¸è‡ªåŠ¨è£…é…


### 7.1 äº‹åŠ¡ç›¸å…³starterä¾èµ–


**æ ¸å¿ƒstarteræ¸…å•**ï¼š

```xml
<!-- 1. JDBCäº‹åŠ¡æ”¯æŒ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-jdbc</artifactId>
</dependency>

<!-- 2. JPAäº‹åŠ¡æ”¯æŒ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>

<!-- 3. MyBatisäº‹åŠ¡æ”¯æŒ -->
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
</dependency>
```

**ä¾èµ–å…³ç³»å›¾**ï¼š
```
spring-boot-starter-jdbc
â”œâ”€â”€ spring-jdbc (æ ¸å¿ƒJDBCæ”¯æŒ)
â”œâ”€â”€ HikariCP (é»˜è®¤è¿æ¥æ± )
â””â”€â”€ spring-boot-starter (æ ¸å¿ƒstarter)

spring-boot-starter-data-jpa
â”œâ”€â”€ spring-boot-starter-jdbc (åŒ…å«JDBC)
â”œâ”€â”€ hibernate-core (JPAå®ç°)
â”œâ”€â”€ spring-data-jpa (Spring Dataæ”¯æŒ)
â””â”€â”€ spring-orm (ORMæ”¯æŒ)
```

### 7.2 starterçš„è‡ªåŠ¨è£…é…æœºåˆ¶


**spring.factoriesæ–‡ä»¶è§£æ**ï¼š

æ¯ä¸ªstarteréƒ½æœ‰ä¸€ä¸ª`META-INF/spring.factories`æ–‡ä»¶ï¼Œé‡Œé¢å®šä¹‰äº†è‡ªåŠ¨é…ç½®ç±»ï¼š

```properties
# spring-boot-autoconfigure åŒ…ä¸‹çš„ spring.factories
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\
org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration,\
org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration
```

**è‡ªåŠ¨è£…é…æµç¨‹**ï¼š
```
åº”ç”¨å¯åŠ¨
   â†“
@SpringBootApplication
   â†“
@EnableAutoConfiguration
   â†“
è¯»å–æ‰€æœ‰jaråŒ…çš„spring.factories
   â†“
åŠ è½½è‡ªåŠ¨é…ç½®ç±»
   â†“
æ ¹æ®@Conditionalæ¡ä»¶è¿‡æ»¤
   â†“
åˆ›å»ºç¬¦åˆæ¡ä»¶çš„Bean
   â†“
äº‹åŠ¡ç®¡ç†å™¨å°±ç»ªï¼Œå¯ä»¥ä½¿ç”¨@Transactional
```

### 7.3 ä¾èµ–é€‰æ‹©æŒ‡å—


**å¦‚ä½•é€‰æ‹©åˆé€‚çš„starterï¼Ÿ**

| æŠ€æœ¯æ ˆ | æ¨èstarter | äº‹åŠ¡ç®¡ç†å™¨ | ä½¿ç”¨åœºæ™¯ |
|-------|------------|-----------|---------|
| **çº¯JDBC** | `spring-boot-starter-jdbc` | `DataSourceTransactionManager` | `ç®€å•SQLæ“ä½œ` |
| **MyBatis** | `mybatis-spring-boot-starter` | `DataSourceTransactionManager` | `SQLçµæ´»æ§åˆ¶` |
| **JPA/Hibernate** | `spring-boot-starter-data-jpa` | `JpaTransactionManager` | `ORMå¯¹è±¡æ“ä½œ` |
| **æ··åˆä½¿ç”¨** | `æŒ‰éœ€ç»„åˆ` | `éœ€æ‰‹åŠ¨é…ç½®` | `å¤æ‚ä¸šåŠ¡åœºæ™¯` |

**æ··åˆä¾èµ–ç¤ºä¾‹**ï¼š
```xml
<!-- JPA + MyBatisæ··åˆ -->
<dependencies>
    <!-- JPAæ”¯æŒ -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    
    <!-- MyBatisæ”¯æŒ -->
    <dependency>
        <groupId>org.mybatis.spring.boot</groupId>
        <artifactId>mybatis-spring-boot-starter</artifactId>
    </dependency>
    
    <!-- æ³¨æ„ï¼šéœ€è¦æ‰‹åŠ¨é…ç½®å“ªä¸ªæ˜¯ä¸»äº‹åŠ¡ç®¡ç†å™¨ -->
</dependencies>
```

**æ‰‹åŠ¨æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨**ï¼š
```java
@Configuration
public class MixedTransactionConfig {
    
    @Primary  // JPAä½œä¸ºä¸»äº‹åŠ¡ç®¡ç†å™¨
    @Bean
    public PlatformTransactionManager jpaTransactionManager(
            EntityManagerFactory emf) {
        return new JpaTransactionManager(emf);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


**ğŸ”¸ è‡ªåŠ¨é…ç½®æœ¬è´¨**ï¼š
- Spring Booté€šè¿‡æ¡ä»¶æ³¨è§£å’Œspring.factorieså®ç°"çº¦å®šä¼˜äºé…ç½®"
- æ ¸å¿ƒç±»æ˜¯`TransactionAutoConfiguration`å’Œ`DataSourceTransactionManagerAutoConfiguration`
- è‡ªåŠ¨é…ç½®ä¼šæ£€æµ‹ä¾èµ–ã€Beanã€å±æ€§ç­‰æ¡ä»¶ï¼ŒæŒ‰éœ€ç”Ÿæ•ˆ

**ğŸ”¸ äº‹åŠ¡ç®¡ç†å™¨é€‰æ‹©é€»è¾‘**ï¼š
```
ä¼˜å…ˆçº§é¡ºåºï¼š
1. ç”¨æˆ·è‡ªå®šä¹‰ > 
2. JpaTransactionManagerï¼ˆæœ‰JPAæ—¶ï¼‰ > 
3. DataSourceTransactionManagerï¼ˆæœ‰DataSourceæ—¶ï¼‰
```

**ğŸ”¸ é…ç½®è¦†ç›–æœºåˆ¶**ï¼š
```
ä¼˜å…ˆçº§é¡ºåºï¼š
ä»£ç @Bean > å‘½ä»¤è¡Œå‚æ•° > é…ç½®æ–‡ä»¶ > è‡ªåŠ¨é…ç½®é»˜è®¤å€¼
```

### 8.2 å®æˆ˜è¦ç‚¹


**âœ… å•æ•°æ®æºåœºæ™¯ï¼ˆæœ€ç®€å•ï¼‰**ï¼š
```java
// 1. æ·»åŠ ä¾èµ–
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-jdbc</artifactId>
</dependency>

// 2. é…ç½®æ•°æ®æº
spring.datasource.url=jdbc:mysql://localhost:3306/db
spring.datasource.username=root
spring.datasource.password=123456

// 3. ç›´æ¥ä½¿ç”¨@Transactionalï¼Œæ— éœ€å…¶ä»–é…ç½®
@Service
public class UserService {
    @Transactional
    public void saveUser(User user) {
        // äº‹åŠ¡è‡ªåŠ¨ç®¡ç†
    }
}
```

**âœ… å¤šæ•°æ®æºåœºæ™¯ï¼ˆéœ€æ‰‹åŠ¨é…ç½®ï¼‰**ï¼š
```java
// å¿…é¡»æŒ‡å®š@Primary
@Configuration
public class DataSourceConfig {
    
    @Primary
    @Bean
    public DataSource primaryDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    public DataSource secondaryDataSource() {
        return DataSourceBuilder.create().build();
    }
}

// ä½¿ç”¨æ—¶æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨
@Transactional(transactionManager = "primaryTxManager")
public void saveUser() { }
```

**âœ… è‡ªå®šä¹‰äº‹åŠ¡è¡Œä¸º**ï¼š
```properties
# é€šè¿‡é…ç½®æ–‡ä»¶è°ƒæ•´
spring.transaction.default-timeout=30
spring.transaction.rollback-on-commit-failure=true
```

### 8.3 å¸¸è§é—®é¢˜ä¸è§£å†³


**é—®é¢˜1ï¼šäº‹åŠ¡ä¸ç”Ÿæ•ˆ**
```
æ£€æŸ¥æ¸…å•ï¼š
â˜‘ï¸ æ˜¯å¦æ·»åŠ äº†äº‹åŠ¡ç›¸å…³ä¾èµ–ï¼Ÿ
â˜‘ï¸ æ˜¯å¦å¼€å¯äº†@EnableTransactionManagementï¼Ÿï¼ˆBooté»˜è®¤å¼€å¯ï¼‰
â˜‘ï¸ @Transactionalæ˜¯å¦åŠ åœ¨publicæ–¹æ³•ä¸Šï¼Ÿ
â˜‘ï¸ æ˜¯å¦åœ¨åŒä¸€ä¸ªç±»å†…éƒ¨è°ƒç”¨ï¼Ÿï¼ˆè‡ªè°ƒç”¨é—®é¢˜ï¼‰
```

**é—®é¢˜2ï¼šå¤šæ•°æ®æºäº‹åŠ¡æ··ä¹±**
```
è§£å†³æ–¹æ¡ˆï¼š
1. æ˜ç¡®æŒ‡å®š@Primaryä¸»æ•°æ®æº
2. ä¸ºæ¯ä¸ªæ•°æ®æºé…ç½®ç‹¬ç«‹çš„äº‹åŠ¡ç®¡ç†å™¨
3. ä½¿ç”¨@Transactionalæ—¶æŒ‡å®štransactionManager
```

**é—®é¢˜3ï¼šæ€§èƒ½é—®é¢˜**
```
ä¼˜åŒ–æ–¹å‘ï¼š
- è°ƒæ•´è¿æ¥æ± å¤§å°ï¼šspring.datasource.hikari.maximum-pool-size
- è®¾ç½®åˆç†è¶…æ—¶ï¼šspring.transaction.default-timeout
- æ‰¹é‡æ“ä½œæ—¶è°ƒæ•´æ‰¹æ¬¡å¤§å°ï¼šhibernate.jdbc.batch_size
```

### 8.4 å­¦ä¹ è·¯çº¿å»ºè®®


**æ–°æ‰‹å­¦ä¹ è·¯å¾„**ï¼š
```
1. ç†è§£è‡ªåŠ¨é…ç½®åŸç†
   â†’ çŸ¥é“Spring Bootå¦‚ä½•è‡ªåŠ¨åˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨
   
2. æŒæ¡å•æ•°æ®æºåœºæ™¯
   â†’ ç†Ÿç»ƒä½¿ç”¨@Transactionalæ³¨è§£
   
3. å­¦ä¹ é…ç½®æ–‡ä»¶è°ƒä¼˜
   â†’ èƒ½æ ¹æ®åœºæ™¯è°ƒæ•´äº‹åŠ¡å‚æ•°
   
4. å¤„ç†å¤šæ•°æ®æºåœºæ™¯
   â†’ æŒæ¡æ‰‹åŠ¨é…ç½®å’Œç®¡ç†å™¨æŒ‡å®š
   
5. æ·±å…¥æºç ç†è§£
   â†’ é˜…è¯»TransactionAutoConfigurationæºç 
```

**å®æˆ˜æŠ€å·§**ï¼š
- ğŸ’¡ **å¯åŠ¨æ—¥å¿—æŸ¥çœ‹**ï¼šå¯åŠ¨æ—¶çœ‹æ—¥å¿—ï¼Œäº†è§£å“ªäº›è‡ªåŠ¨é…ç½®ç”Ÿæ•ˆäº†
- ğŸ’¡ **æ¡ä»¶è¯„ä¼°æŠ¥å‘Š**ï¼š`--debug`å¯åŠ¨æŸ¥çœ‹è¯¦ç»†çš„æ¡ä»¶åˆ¤æ–­ç»“æœ
- ğŸ’¡ **Actuatorç›‘æ§**ï¼šå¼•å…¥`spring-boot-starter-actuator`æŸ¥çœ‹Beanä¿¡æ¯

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
Booté…ç½®çœŸæ™ºèƒ½ï¼Œæ£€æµ‹ä¾èµ–è‡ªåŠ¨è£…
æ¡ä»¶æ³¨è§£ç»†åˆ¤æ–­ï¼Œç”¨æˆ·é…ç½®ä¼˜å…ˆçº§é«˜
å•æºç®€å•å¤šæºéš¾ï¼ŒPrimaryæ ‡è®°è¦è®°ç‰¢
é…ç½®æ–‡ä»¶è°ƒå‚æ•°ï¼Œstarterå¼•å…¥å³å¯ç”¨
```