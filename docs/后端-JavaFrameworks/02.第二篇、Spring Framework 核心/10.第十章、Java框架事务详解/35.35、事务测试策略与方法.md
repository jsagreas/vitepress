---
title: 35ã€äº‹åŠ¡æµ‹è¯•ç­–ç•¥ä¸æ–¹æ³•
---
## ğŸ“š ç›®å½•

1. [äº‹åŠ¡æµ‹è¯•åŸºç¡€æ¦‚å¿µ](#1-äº‹åŠ¡æµ‹è¯•åŸºç¡€æ¦‚å¿µ)
2. [Springäº‹åŠ¡æµ‹è¯•æ³¨è§£](#2-Springäº‹åŠ¡æµ‹è¯•æ³¨è§£)
3. [TestTransactionå·¥å…·è¯¦è§£](#3-TestTransactionå·¥å…·è¯¦è§£)
4. [äº‹åŠ¡å›æ»šæµ‹è¯•å®è·µ](#4-äº‹åŠ¡å›æ»šæµ‹è¯•å®è·µ)
5. [é›†æˆæµ‹è¯•ä¸å•å…ƒæµ‹è¯•](#5-é›†æˆæµ‹è¯•ä¸å•å…ƒæµ‹è¯•)
6. [äº‹åŠ¡æµ‹è¯•æœ€ä½³å®è·µ](#6-äº‹åŠ¡æµ‹è¯•æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ äº‹åŠ¡æµ‹è¯•åŸºç¡€æ¦‚å¿µ


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡æµ‹è¯•


**ğŸ”¸ äº‹åŠ¡æµ‹è¯•çš„å¿…è¦æ€§**

åœ¨å®é™…å¼€å‘ä¸­ï¼Œäº‹åŠ¡é€»è¾‘å¾€å¾€æ˜¯ä¸šåŠ¡ä»£ç æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå®ƒå†³å®šäº†æ•°æ®çš„ä¸€è‡´æ€§ã€‚æƒ³è±¡ä¸€ä¸‹è½¬è´¦åœºæ™¯ï¼š
- å°æ˜è´¦æˆ·æ‰£æ¬¾100å…ƒ
- å°çº¢è´¦æˆ·åŠ æ¬¾100å…ƒ

å¦‚æœç¬¬ä¸€æ­¥æˆåŠŸäº†ï¼Œç¬¬äºŒæ­¥å¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿè¿™å°±éœ€è¦äº‹åŠ¡å›æ»šä¿è¯æ•°æ®æ­£ç¡®ã€‚**æµ‹è¯•å°±æ˜¯éªŒè¯è¿™ç§ä¿æŠ¤æœºåˆ¶æ˜¯å¦çœŸçš„ç”Ÿæ•ˆ**ã€‚

**ç°å®ä¸­çš„é—®é¢˜**ï¼š
```
é—®é¢˜1ï¼šæµ‹è¯•æ•°æ®æ±¡æŸ“
æµ‹è¯•å®Œæˆåï¼Œæ•°æ®åº“ç•™ä¸‹ä¸€å †æµ‹è¯•æ•°æ® â†’ å½±å“ä¸‹æ¬¡æµ‹è¯•

é—®é¢˜2ï¼šäº‹åŠ¡è¡Œä¸ºä¸ç¡®å®š
ä¸ç¡®å®šæµ‹è¯•ä¸­çš„äº‹åŠ¡æ˜¯å¦çœŸçš„ç”Ÿæ•ˆ â†’ å¯èƒ½æ˜¯å‡é€šè¿‡

é—®é¢˜3ï¼šéš¾ä»¥æ¨¡æ‹Ÿå¼‚å¸¸åœºæ™¯
å¦‚ä½•æµ‹è¯•äº‹åŠ¡å›æ»šï¼Ÿæ­£å¸¸ä¸šåŠ¡ä¸ä¼šæ•…æ„æŠ›å¼‚å¸¸
```

### 1.2 äº‹åŠ¡æµ‹è¯•çš„æ ¸å¿ƒç›®æ ‡


**æµ‹è¯•è¦éªŒè¯çš„ä¸‰ä»¶äº‹**ï¼š

**â‘  äº‹åŠ¡æ˜¯å¦æ­£ç¡®å¼€å¯**
```
éªŒè¯ç‚¹ï¼šæ–¹æ³•æ‰§è¡Œæ—¶æ˜¯å¦åœ¨äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­
å·¥å…·ï¼šé€šè¿‡TransactionSynchronizationManageræ£€æŸ¥
```

**â‘¡ äº‹åŠ¡æ˜¯å¦æ­£ç¡®æäº¤**
```
éªŒè¯ç‚¹ï¼šæ­£å¸¸æ‰§è¡Œåæ•°æ®æ˜¯å¦æŒä¹…åŒ–
å·¥å…·ï¼šæŸ¥è¯¢æ•°æ®åº“éªŒè¯æ•°æ®å­˜åœ¨
```

**â‘¢ äº‹åŠ¡æ˜¯å¦æ­£ç¡®å›æ»š**
```
éªŒè¯ç‚¹ï¼šå¼‚å¸¸å‘ç”Ÿæ—¶æ•°æ®æ˜¯å¦å›æ»š
å·¥å…·ï¼šæŠ›å‡ºå¼‚å¸¸åéªŒè¯æ•°æ®ä¸å­˜åœ¨
```

### 1.3 æµ‹è¯•ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒçš„å·®å¼‚


**å…³é”®ç†è§£**ï¼šæµ‹è¯•ç¯å¢ƒçš„äº‹åŠ¡è¡Œä¸ºé»˜è®¤ä¸ç”Ÿäº§ä¸åŒï¼

```
ç”Ÿäº§ç¯å¢ƒäº‹åŠ¡è¡Œä¸ºï¼š
æ–¹æ³•æ‰§è¡Œ â†’ äº‹åŠ¡å¼€å¯ â†’ ä¸šåŠ¡é€»è¾‘ â†’ æäº¤äº‹åŠ¡ â†’ æ•°æ®æŒä¹…åŒ–

æµ‹è¯•ç¯å¢ƒé»˜è®¤è¡Œä¸ºï¼š
æ–¹æ³•æ‰§è¡Œ â†’ äº‹åŠ¡å¼€å¯ â†’ ä¸šåŠ¡é€»è¾‘ â†’ å›æ»šäº‹åŠ¡ â†’ æ•°æ®ä¸ä¿å­˜
                                    â†‘
                              è¿™æ˜¯é»˜è®¤è¡Œä¸ºï¼
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡**ï¼Ÿ
- âœ… **æ•°æ®éš”ç¦»**ï¼šæ¯æ¬¡æµ‹è¯•åè‡ªåŠ¨æ¸…ç†ï¼Œä¸æ±¡æŸ“æ•°æ®åº“
- âœ… **å¯é‡å¤æ‰§è¡Œ**ï¼šæµ‹è¯•å¯ä»¥åå¤è¿è¡Œï¼Œç»“æœä¸€è‡´
- âœ… **å¿«é€Ÿåé¦ˆ**ï¼šä¸éœ€è¦æ‰‹åŠ¨æ¸…ç†æµ‹è¯•æ•°æ®

---

## 2. ğŸ”§ Springäº‹åŠ¡æµ‹è¯•æ³¨è§£


### 2.1 @Transactionalæ³¨è§£åœ¨æµ‹è¯•ä¸­çš„ä½œç”¨


**åŸºç¡€ç”¨æ³•**ï¼šåœ¨æµ‹è¯•ç±»æˆ–æµ‹è¯•æ–¹æ³•ä¸ŠåŠ `@Transactional`

```java
@SpringBootTest
@Transactional  // â† é»˜è®¤è¡Œä¸ºï¼šæµ‹è¯•å®Œæˆåå›æ»š
class UserServiceTest {
    
    @Autowired
    private UserService userService;
    
    @Test
    void testCreateUser() {
        User user = new User("å¼ ä¸‰", "test@example.com");
        userService.createUser(user);
        
        // æµ‹è¯•æ‰§è¡Œå®Œæ¯•åï¼Œæ•°æ®ä¼šè‡ªåŠ¨å›æ»š
        // æ•°æ®åº“ä¸­ä¸ä¼šç•™ä¸‹"å¼ ä¸‰"è¿™æ¡è®°å½•
    }
}
```

**æ ¸å¿ƒæœºåˆ¶è§£æ**ï¼š

```
æµ‹è¯•æ–¹æ³•æ‰§è¡Œæµç¨‹ï¼š

1. Springå®¹å™¨å¯åŠ¨
2. å¼€å¯æµ‹è¯•äº‹åŠ¡ â† @Transactionalç”Ÿæ•ˆ
3. æ‰§è¡Œæµ‹è¯•æ–¹æ³•
4. æµ‹è¯•æ–¹æ³•å®Œæˆ
5. è‡ªåŠ¨å›æ»šäº‹åŠ¡ â† é»˜è®¤è¡Œä¸º
6. æµ‹è¯•ç»“æŸ

ç»“æœï¼šæ•°æ®åº“ä¿æŒå¹²å‡€ï¼Œæ²¡æœ‰æµ‹è¯•æ•°æ®æ®‹ç•™
```

### 2.2 @Rollbackæ³¨è§£è¯¦è§£


**ä½œç”¨**ï¼šæ˜¾å¼æ§åˆ¶æµ‹è¯•åæ˜¯å¦å›æ»š

**â‘  é»˜è®¤å›æ»šè¡Œä¸º**
```java
@Test
@Transactional
@Rollback  // å¯ä»¥çœç•¥ï¼Œé»˜è®¤å°±æ˜¯true
void testWithRollback() {
    // æµ‹è¯•å®Œæˆåä¼šå›æ»š
}
```

**â‘¡ é˜»æ­¢å›æ»šä¿ç•™æ•°æ®**
```java
@Test
@Transactional
@Rollback(false)  // æ˜ç¡®æŒ‡å®šä¸å›æ»š
void testKeepData() {
    User user = new User("æå››", "lisi@example.com");
    userService.createUser(user);
    
    // æµ‹è¯•åæ•°æ®ä¼šä¿ç•™åœ¨æ•°æ®åº“ä¸­
    // é€‚åˆéœ€è¦æ£€æŸ¥æ•°æ®åº“å®é™…çŠ¶æ€çš„åœºæ™¯
}
```

**ä½¿ç”¨åœºæ™¯å¯¹æ¯”**ï¼š

| åœºæ™¯ | é…ç½® | é€‚ç”¨æƒ…å†µ |
|------|------|----------|
| **å¸¸è§„å•å…ƒæµ‹è¯•** | `@Rollback(true)` æˆ–ä¸å†™ | âœ… æœ€å¸¸ç”¨ï¼Œä¿æŒæ•°æ®åº“å¹²å‡€ |
| **æ•°æ®éªŒè¯æµ‹è¯•** | `@Rollback(false)` | éœ€è¦äººå·¥æ£€æŸ¥æ•°æ®åº“å†…å®¹ |
| **æ•°æ®å‡†å¤‡** | `@Rollback(false)` | ä¸ºå…¶ä»–æµ‹è¯•å‡†å¤‡åˆå§‹æ•°æ® |

### 2.3 @Commitæ³¨è§£è¯¦è§£


**ä½œç”¨**ï¼šå¼ºåˆ¶æäº¤äº‹åŠ¡ï¼Œç­‰åŒäº`@Rollback(false)`

```java
@Test
@Transactional
@Commit  // ç­‰ä»·äº @Rollback(false)
void testWithCommit() {
    // åˆ›å»ºè®¢å•æ•°æ®
    Order order = new Order();
    orderService.createOrder(order);
    
    // æ•°æ®ä¼šçœŸæ­£ä¿å­˜åˆ°æ•°æ®åº“
}
```

**@Commit vs @Rollback(false) å¯¹æ¯”**ï¼š

```
è¯­ä¹‰å·®å¼‚ï¼š
@Commit          â†’ å¼ºè°ƒ"æˆ‘è¦æäº¤æ•°æ®"
@Rollback(false) â†’ å¼ºè°ƒ"æˆ‘ä¸è¦å›æ»š"

å®é™…æ•ˆæœï¼šå®Œå…¨ç›¸åŒï¼

æ¨èä½¿ç”¨ï¼š
@Commit æ›´ç›´è§‚ï¼Œä¸€çœ‹å°±çŸ¥é“è¦æäº¤æ•°æ®
```

### 2.4 æ³¨è§£ç»„åˆä½¿ç”¨ç­–ç•¥


**ç±»çº§åˆ« vs æ–¹æ³•çº§åˆ«**

```java
@SpringBootTest
@Transactional  // ç±»çº§åˆ«ï¼šé»˜è®¤æ‰€æœ‰æµ‹è¯•æ–¹æ³•éƒ½å›æ»š
class OrderServiceTest {
    
    @Test
    void testNormalCase() {
        // ç»§æ‰¿ç±»çº§åˆ«é…ç½®ï¼Œä¼šå›æ»š
    }
    
    @Test
    @Commit  // æ–¹æ³•çº§åˆ«è¦†ç›–ç±»çº§åˆ«é…ç½®
    void testNeedCommit() {
        // è¿™ä¸ªæµ‹è¯•ä¼šæäº¤æ•°æ®
    }
    
    @Test
    @Rollback(false)  // å¦ä¸€ç§è¦†ç›–æ–¹å¼
    void testAlsoCommit() {
        // è¿™ä¸ªæµ‹è¯•ä¹Ÿä¼šæäº¤æ•°æ®
    }
}
```

**ä¼˜å…ˆçº§è§„åˆ™**ï¼š
```
æ–¹æ³•çº§åˆ«æ³¨è§£ > ç±»çº§åˆ«æ³¨è§£

ç¤ºä¾‹ï¼š
ç±»ä¸Š @Rollback(false) + æ–¹æ³•ä¸Š @Rollback(true)
â†’ ç»“æœï¼šæ–¹æ³•æ‰§è¡Œåå›æ»šï¼ˆæ–¹æ³•çº§åˆ«ç”Ÿæ•ˆï¼‰
```

---

## 3. ğŸ› ï¸ TestTransactionå·¥å…·è¯¦è§£


### 3.1 TestTransactionæ˜¯ä»€ä¹ˆ


**å®šä¹‰**ï¼šSpringæµ‹è¯•æ¡†æ¶æä¾›çš„å·¥å…·ç±»ï¼Œç”¨äºåœ¨æµ‹è¯•ä¸­ç²¾ç¡®æ§åˆ¶äº‹åŠ¡è¡Œä¸º

**æ ¸å¿ƒèƒ½åŠ›**ï¼š
- æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨äº‹åŠ¡ä¸­
- æ‰‹åŠ¨æ ‡è®°äº‹åŠ¡å›æ»š
- æ‰‹åŠ¨æäº¤å½“å‰äº‹åŠ¡
- ç»“æŸå½“å‰äº‹åŠ¡å¹¶å¼€å¯æ–°äº‹åŠ¡

**åŸºç¡€ç”¨æ³•ç¤ºä¾‹**ï¼š

```java
import static org.springframework.test.context.transaction.TestTransaction.*;

@SpringBootTest
@Transactional
class TransactionToolTest {
    
    @Test
    void testTransactionControl() {
        // 1. æ£€æŸ¥äº‹åŠ¡çŠ¶æ€
        boolean inTransaction = isActive();  // true
        
        // 2. æ ‡è®°å›æ»š
        flagForRollback();
        
        // 3. æ£€æŸ¥æ˜¯å¦æ ‡è®°å›æ»š
        boolean willRollback = isFlaggedForRollback();  // true
    }
}
```

### 3.2 æ ¸å¿ƒAPIè¯¦è§£


**â‘  isActive() - æ£€æŸ¥äº‹åŠ¡æ˜¯å¦æ¿€æ´»**

```java
@Test
@Transactional
void testIsActive() {
    // æµ‹è¯•å¼€å§‹æ—¶äº‹åŠ¡å·²å¼€å¯
    assertTrue(TestTransaction.isActive());
    
    // å¯ä»¥ç”¨äºè°ƒè¯•ï¼Œç¡®è®¤äº‹åŠ¡çŠ¶æ€
    if (!TestTransaction.isActive()) {
        throw new RuntimeException("äº‹åŠ¡æœªå¼€å¯ï¼");
    }
}
```

**â‘¡ flagForRollback() - æ ‡è®°å›æ»š**

```java
@Test
@Transactional
@Rollback(false)  // åŸæœ¬ä¼šæäº¤
void testFlagForRollback() {
    // ä¿å­˜ç”¨æˆ·
    userService.createUser(new User("ç‹äº”", "wangwu@example.com"));
    
    // æŸä¸ªæ¡ä»¶ä¸‹å†³å®šå›æ»š
    if (someCondition) {
        TestTransaction.flagForRollback();  // æ ‡è®°å›æ»š
    }
    
    // æµ‹è¯•ç»“æŸåä¼šå›æ»šï¼Œå³ä½¿æœ‰@Rollback(false)
}
```

**â‘¢ isFlaggedForRollback() - æ£€æŸ¥å›æ»šæ ‡è®°**

```java
@Test
@Transactional
void testCheckRollbackFlag() {
    // åˆå§‹çŠ¶æ€ï¼šé»˜è®¤å›æ»š
    assertTrue(TestTransaction.isFlaggedForRollback());
    
    // æ ‡è®°ä¸ºæäº¤
    TestTransaction.flagForCommit();
    assertFalse(TestTransaction.isFlaggedForRollback());
}
```

**â‘£ end() å’Œ start() - æ‰‹åŠ¨æ§åˆ¶äº‹åŠ¡è¾¹ç•Œ**

```java
@Test
@Transactional
void testManualTransactionControl() {
    // å½“å‰åœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸­
    userService.createUser(new User("èµµå…­", "zhaoliu@example.com"));
    
    // ç»“æŸå½“å‰äº‹åŠ¡ï¼ˆæäº¤ï¼‰
    TestTransaction.end();
    
    // ç°åœ¨ä¸åœ¨äº‹åŠ¡ä¸­
    assertFalse(TestTransaction.isActive());
    
    // å¼€å¯æ–°äº‹åŠ¡
    TestTransaction.start();
    
    // åœ¨æ–°äº‹åŠ¡ä¸­ç»§ç»­æ“ä½œ
    assertTrue(TestTransaction.isActive());
}
```

### 3.3 å®æˆ˜åœºæ™¯ï¼šåˆ†æ®µæµ‹è¯•äº‹åŠ¡


**åœºæ™¯**ï¼šæµ‹è¯•å¤æ‚ä¸šåŠ¡ï¼Œéœ€è¦åˆ†æ®µéªŒè¯æ¯ä¸ªæ­¥éª¤çš„æ•°æ®çŠ¶æ€

```java
@Test
@Transactional
void testMultiStepTransaction() {
    // ç¬¬ä¸€é˜¶æ®µï¼šåˆ›å»ºè®¢å•
    Order order = orderService.createOrder(new Order());
    
    // æäº¤ç¬¬ä¸€é˜¶æ®µäº‹åŠ¡
    TestTransaction.end();
    
    // éªŒè¯ç¬¬ä¸€é˜¶æ®µæ•°æ®å·²æŒä¹…åŒ–
    Order saved = orderRepository.findById(order.getId()).orElse(null);
    assertNotNull(saved, "è®¢å•åº”è¯¥å·²ä¿å­˜");
    
    // å¼€å¯ç¬¬äºŒé˜¶æ®µäº‹åŠ¡
    TestTransaction.start();
    
    // ç¬¬äºŒé˜¶æ®µï¼šæ”¯ä»˜è®¢å•
    paymentService.pay(order.getId(), new BigDecimal("100"));
    
    // ç¬¬äºŒé˜¶æ®µå›æ»š
    TestTransaction.flagForRollback();
    TestTransaction.end();
    
    // éªŒè¯ï¼šè®¢å•å­˜åœ¨ä½†æ”¯ä»˜å¤±è´¥
    Order afterRollback = orderRepository.findById(order.getId()).orElse(null);
    assertEquals(OrderStatus.UNPAID, afterRollback.getStatus());
}
```

---

## 4. ğŸ”„ äº‹åŠ¡å›æ»šæµ‹è¯•å®è·µ


### 4.1 å›æ»šæµ‹è¯•çš„æ ¸å¿ƒæ€è·¯


**å…³é”®ç†è§£**ï¼šå›æ»šæµ‹è¯•ä¸æ˜¯æµ‹è¯•"æ˜¯å¦èƒ½æŠ›å¼‚å¸¸"ï¼Œè€Œæ˜¯æµ‹è¯•"æŠ›å¼‚å¸¸åæ•°æ®æ˜¯å¦æ­£ç¡®å›æ»š"

**æµ‹è¯•æ­¥éª¤**ï¼š
```
æ­¥éª¤1ï¼šæ‰§è¡Œä¼šè§¦å‘å¼‚å¸¸çš„ä¸šåŠ¡é€»è¾‘
æ­¥éª¤2ï¼šæ•è·å¼‚å¸¸ï¼ˆè¯æ˜å¼‚å¸¸ç¡®å®å‘ç”Ÿï¼‰
æ­¥éª¤3ï¼šéªŒè¯æ•°æ®åº“ä¸­æ²¡æœ‰è„æ•°æ®ï¼ˆè¯æ˜å›æ»šæˆåŠŸï¼‰
```

### 4.2 åŸºç¡€å›æ»šæµ‹è¯•ç¤ºä¾‹


**ä¸šåŠ¡ä»£ç **ï¼š
```java
@Service
public class TransferService {
    
    @Transactional
    public void transfer(Long fromId, Long toId, BigDecimal amount) {
        // æ‰£æ¬¾
        accountService.deduct(fromId, amount);
        
        // æ¨¡æ‹Ÿå¼‚å¸¸
        if (amount.compareTo(new BigDecimal("1000")) > 0) {
            throw new RuntimeException("è½¬è´¦é‡‘é¢è¶…é™");
        }
        
        // åŠ æ¬¾
        accountService.add(toId, amount);
    }
}
```

**æµ‹è¯•ä»£ç **ï¼š
```java
@SpringBootTest
@Transactional
class TransferServiceTest {
    
    @Autowired
    private TransferService transferService;
    
    @Autowired
    private AccountRepository accountRepository;
    
    @Test
    void testTransferRollback() {
        // å‡†å¤‡æ•°æ®
        Long fromId = 1L;
        Long toId = 2L;
        BigDecimal initialBalance = new BigDecimal("5000");
        
        // è®°å½•åˆå§‹çŠ¶æ€
        BigDecimal fromBefore = accountRepository.findById(fromId).get().getBalance();
        BigDecimal toBefore = accountRepository.findById(toId).get().getBalance();
        
        // æ‰§è¡Œè½¬è´¦ï¼ˆä¼šæŠ›å¼‚å¸¸ï¼‰
        assertThrows(RuntimeException.class, () -> {
            transferService.transfer(fromId, toId, new BigDecimal("1500"));
        });
        
        // éªŒè¯ä½™é¢æœªå˜åŒ–ï¼ˆå›æ»šæˆåŠŸï¼‰
        BigDecimal fromAfter = accountRepository.findById(fromId).get().getBalance();
        BigDecimal toAfter = accountRepository.findById(toId).get().getBalance();
        
        assertEquals(fromBefore, fromAfter, "æ‰£æ¬¾è´¦æˆ·ä½™é¢åº”è¯¥ä¸å˜");
        assertEquals(toBefore, toAfter, "æ”¶æ¬¾è´¦æˆ·ä½™é¢åº”è¯¥ä¸å˜");
    }
}
```

### 4.3 åµŒå¥—äº‹åŠ¡å›æ»šæµ‹è¯•


**ä¸šåŠ¡ä»£ç **ï¼šå†…å±‚äº‹åŠ¡å¤±è´¥ä¸å½±å“å¤–å±‚

```java
@Service
public class OrderService {
    
    @Autowired
    private LogService logService;
    
    @Transactional
    public void createOrder(Order order) {
        orderRepository.save(order);
        
        try {
            // è®°å½•æ—¥å¿—ï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼‰
            logService.log("è®¢å•åˆ›å»º", order.getId());
        } catch (Exception e) {
            // æ—¥å¿—å¤±è´¥ä¸å½±å“è®¢å•
        }
    }
}

@Service
public class LogService {
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void log(String action, Long orderId) {
        // æ¨¡æ‹Ÿæ—¥å¿—è®°å½•å¤±è´¥
        throw new RuntimeException("æ—¥å¿—æœåŠ¡å¼‚å¸¸");
    }
}
```

**æµ‹è¯•ä»£ç **ï¼š
```java
@Test
void testNestedTransactionRollback() {
    Order order = new Order();
    
    // æ‰§è¡Œä¸šåŠ¡
    orderService.createOrder(order);
    
    // éªŒè¯ç»“æœ
    Order saved = orderRepository.findById(order.getId()).orElse(null);
    
    // è®¢å•åº”è¯¥ä¿å­˜æˆåŠŸï¼ˆå¤–å±‚äº‹åŠ¡æäº¤ï¼‰
    assertNotNull(saved, "è®¢å•åº”è¯¥åˆ›å»ºæˆåŠŸ");
    
    // æ—¥å¿—åº”è¯¥æ²¡æœ‰ï¼ˆå†…å±‚äº‹åŠ¡å›æ»šï¼‰
    List<Log> logs = logRepository.findByOrderId(order.getId());
    assertTrue(logs.isEmpty(), "æ—¥å¿—ä¸åº”è¯¥å­˜åœ¨");
}
```

### 4.4 éƒ¨åˆ†å›æ»šæµ‹è¯•æŠ€å·§


**åœºæ™¯**ï¼šæ‰¹é‡æ“ä½œä¸­éƒ¨åˆ†å¤±è´¥ï¼Œæµ‹è¯•äº‹åŠ¡å¤„ç†

```java
@Service
public class BatchService {
    
    @Transactional
    public void batchImport(List<User> users) {
        for (User user : users) {
            if (user.getEmail() == null) {
                throw new RuntimeException("é‚®ç®±ä¸èƒ½ä¸ºç©º");
            }
            userRepository.save(user);
        }
    }
}
```

**æµ‹è¯•ä»£ç **ï¼š
```java
@Test
void testBatchRollback() {
    // å‡†å¤‡æ•°æ®ï¼šç¬¬3ä¸ªç”¨æˆ·é‚®ç®±ä¸ºç©º
    List<User> users = Arrays.asList(
        new User("ç”¨æˆ·1", "user1@example.com"),
        new User("ç”¨æˆ·2", "user2@example.com"),
        new User("ç”¨æˆ·3", null),  // ä¼šè§¦å‘å¼‚å¸¸
        new User("ç”¨æˆ·4", "user4@example.com")
    );
    
    // æ‰§è¡Œæ‰¹é‡å¯¼å…¥
    assertThrows(RuntimeException.class, () -> {
        batchService.batchImport(users);
    });
    
    // éªŒè¯ï¼šæ‰€æœ‰ç”¨æˆ·éƒ½æ²¡ä¿å­˜ï¼ˆå…¨éƒ¨å›æ»šï¼‰
    List<User> saved = userRepository.findAll();
    assertEquals(0, saved.size(), "å¼‚å¸¸åæ‰€æœ‰æ•°æ®éƒ½åº”å›æ»š");
}
```

---

## 5. ğŸ”¬ é›†æˆæµ‹è¯•ä¸å•å…ƒæµ‹è¯•


### 5.1 å•å…ƒæµ‹è¯•ä¸­çš„äº‹åŠ¡å¤„ç†


**ç‰¹ç‚¹**ï¼šå•å…ƒæµ‹è¯•é€šå¸¸mockæ•°æ®åº“ï¼Œä¸æ¶‰åŠçœŸå®äº‹åŠ¡

```java
@ExtendWith(MockitoExtension.class)  // çº¯å•å…ƒæµ‹è¯•
class UserServiceUnitTest {
    
    @Mock
    private UserRepository userRepository;
    
    @InjectMocks
    private UserService userService;
    
    @Test
    void testCreateUser() {
        // Mockä»“åº“è¡Œä¸º
        User user = new User("æµ‹è¯•ç”¨æˆ·", "test@example.com");
        when(userRepository.save(any())).thenReturn(user);
        
        // æ‰§è¡Œä¸šåŠ¡æ–¹æ³•
        User created = userService.createUser(user);
        
        // éªŒè¯è°ƒç”¨
        verify(userRepository, times(1)).save(user);
        
        // æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰çœŸå®äº‹åŠ¡ï¼
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âš¡ æ‰§è¡Œé€Ÿåº¦å¿«
- ğŸ¯ ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
- ğŸ”§ æ˜“äºæ§åˆ¶æµ‹è¯•æ¡ä»¶

**ç¼ºç‚¹**ï¼š
- âŒ æ— æ³•æµ‹è¯•äº‹åŠ¡è¡Œä¸º
- âŒ æ— æ³•å‘ç°SQLé—®é¢˜
- âŒ æ— æ³•æµ‹è¯•æ•°æ®åº“çº¦æŸ

### 5.2 é›†æˆæµ‹è¯•ä¸­çš„äº‹åŠ¡å¤„ç†


**ç‰¹ç‚¹**ï¼šä½¿ç”¨çœŸå®æ•°æ®åº“ï¼Œæµ‹è¯•å®Œæ•´äº‹åŠ¡æµç¨‹

```java
@SpringBootTest
@Transactional  // é›†æˆæµ‹è¯•
class UserServiceIntegrationTest {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    void testCreateUserWithTransaction() {
        // çœŸå®çš„æ•°æ®åº“æ“ä½œ
        User user = new User("é›†æˆæµ‹è¯•ç”¨æˆ·", "integration@example.com");
        userService.createUser(user);
        
        // éªŒè¯æ•°æ®çœŸçš„ä¿å­˜äº†
        User saved = userRepository.findById(user.getId()).orElse(null);
        assertNotNull(saved);
        
        // æµ‹è¯•ç»“æŸåè‡ªåŠ¨å›æ»š
    }
    
    @Test
    void testTransactionRollbackOnError() {
        // æµ‹è¯•å¼‚å¸¸å›æ»š
        User invalidUser = new User(null, "invalid@example.com");
        
        assertThrows(Exception.class, () -> {
            userService.createUser(invalidUser);
        });
        
        // éªŒè¯æ²¡æœ‰è„æ•°æ®
        assertEquals(0, userRepository.count());
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æµ‹è¯•çœŸå®äº‹åŠ¡è¡Œä¸º
- âœ… å‘ç°æ•°æ®åº“ç›¸å…³é—®é¢˜
- âœ… éªŒè¯å®Œæ•´ä¸šåŠ¡æµç¨‹

**ç¼ºç‚¹**ï¼š
- ğŸŒ æ‰§è¡Œé€Ÿåº¦è¾ƒæ…¢
- ğŸ’¾ éœ€è¦æ•°æ®åº“ç¯å¢ƒ
- ğŸ”§ é…ç½®ç›¸å¯¹å¤æ‚

### 5.3 æµ‹è¯•ç­–ç•¥é€‰æ‹©æŒ‡å—


**é€‰æ‹©å†³ç­–æ ‘**ï¼š
```
éœ€è¦æµ‹è¯•äº‹åŠ¡è¡Œä¸ºï¼Ÿ
    â”œâ”€ æ˜¯ â†’ é›†æˆæµ‹è¯•
    â”‚       â”œâ”€ ä½¿ç”¨ @SpringBootTest
    â”‚       â”œâ”€ ä½¿ç”¨ @Transactional
    â”‚       â””â”€ ä½¿ç”¨çœŸå®æ•°æ®åº“
    â”‚
    â””â”€ å¦ â†’ å•å…ƒæµ‹è¯•
            â”œâ”€ ä½¿ç”¨ @ExtendWith(MockitoExtension.class)
            â”œâ”€ Mockä¾èµ–
            â””â”€ ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
```

**æ¨èç»„åˆç­–ç•¥**ï¼š
```
é‡‘å­—å¡”æ¨¡å‹ï¼š
       /\
      /é›†æˆ\     â† å°‘é‡ï¼Œæµ‹è¯•å…³é”®äº‹åŠ¡åœºæ™¯
     /------\
    /  å•å…ƒ  \   â† å¤§é‡ï¼Œè¦†ç›–ä¸šåŠ¡é€»è¾‘
   /----------\
```

**å®è·µå»ºè®®**ï¼š
- ğŸ¯ **å•å…ƒæµ‹è¯•**ï¼šè¦†ç›–80%ä¸šåŠ¡é€»è¾‘
- ğŸ” **é›†æˆæµ‹è¯•**ï¼šè¦†ç›–å…³é”®äº‹åŠ¡åœºæ™¯
- ğŸš€ **ç«¯åˆ°ç«¯æµ‹è¯•**ï¼šè¦†ç›–æ ¸å¿ƒç”¨æˆ·æµç¨‹

---

## 6. ğŸ’¡ äº‹åŠ¡æµ‹è¯•æœ€ä½³å®è·µ


### 6.1 æµ‹è¯•æ•°æ®å‡†å¤‡ç­–ç•¥


**â‘  ä½¿ç”¨@BeforeEachå‡†å¤‡æ•°æ®**

```java
@SpringBootTest
@Transactional
class ProductServiceTest {
    
    @Autowired
    private ProductRepository productRepository;
    
    private Product testProduct;
    
    @BeforeEach
    void setUp() {
        // æ¯ä¸ªæµ‹è¯•å‰å‡†å¤‡æ•°æ®
        testProduct = new Product("æµ‹è¯•å•†å“", new BigDecimal("99.99"));
        productRepository.save(testProduct);
    }
    
    @Test
    void testUpdateProduct() {
        // ä½¿ç”¨å‡†å¤‡å¥½çš„æ•°æ®
        testProduct.setPrice(new BigDecimal("88.88"));
        productRepository.save(testProduct);
        
        // éªŒè¯æ›´æ–°
        Product updated = productRepository.findById(testProduct.getId()).get();
        assertEquals(new BigDecimal("88.88"), updated.getPrice());
    }
    
    // æµ‹è¯•ç»“æŸåæ•°æ®è‡ªåŠ¨å›æ»šï¼ŒåŒ…æ‹¬@BeforeEachä¸­çš„æ•°æ®
}
```

**â‘¡ ä½¿ç”¨@Sqlå‡†å¤‡æ•°æ®**

```java
@SpringBootTest
@Transactional
class OrderServiceTest {
    
    @Test
    @Sql("/test-data/orders.sql")  // æ‰§è¡ŒSQLè„šæœ¬
    void testOrderQuery() {
        // SQLè„šæœ¬å·²ç»å‡†å¤‡å¥½æ•°æ®
        List<Order> orders = orderRepository.findAll();
        assertFalse(orders.isEmpty());
    }
}
```

**test-data/orders.sql**ï¼š
```sql
INSERT INTO orders (id, user_id, total, status) VALUES 
(1, 1001, 299.00, 'PAID'),
(2, 1002, 399.00, 'PENDING');
```

### 6.2 äº‹åŠ¡éš”ç¦»çº§åˆ«æµ‹è¯•


**æµ‹è¯•ä¸åŒéš”ç¦»çº§åˆ«çš„è¡Œä¸º**ï¼š

```java
@SpringBootTest
class IsolationLevelTest {
    
    @Autowired
    private AccountService accountService;
    
    @Test
    @Transactional(isolation = Isolation.READ_COMMITTED)
    void testReadCommitted() {
        // æµ‹è¯•è¯»å·²æäº¤éš”ç¦»çº§åˆ«
        Account account = accountService.getAccount(1L);
        BigDecimal balance1 = account.getBalance();
        
        // å¦ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æ•°æ®...
        
        // å†æ¬¡è¯»å–ï¼ˆèƒ½çœ‹åˆ°å…¶ä»–äº‹åŠ¡æäº¤çš„æ•°æ®ï¼‰
        Account account2 = accountService.getAccount(1L);
        BigDecimal balance2 = account2.getBalance();
        
        // ä½™é¢å¯èƒ½ä¸åŒï¼ˆä¸å¯é‡å¤è¯»ï¼‰
    }
    
    @Test
    @Transactional(isolation = Isolation.REPEATABLE_READ)
    void testRepeatableRead() {
        // æµ‹è¯•å¯é‡å¤è¯»éš”ç¦»çº§åˆ«
        Account account = accountService.getAccount(1L);
        BigDecimal balance1 = account.getBalance();
        
        // å¦ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æ•°æ®...
        
        // å†æ¬¡è¯»å–ï¼ˆçœ‹ä¸åˆ°å…¶ä»–äº‹åŠ¡çš„ä¿®æ”¹ï¼‰
        Account account2 = accountService.getAccount(1L);
        BigDecimal balance2 = account2.getBalance();
        
        // ä½™é¢ç›¸åŒï¼ˆå¯é‡å¤è¯»ï¼‰
        assertEquals(balance1, balance2);
    }
}
```

### 6.3 å¼‚å¸¸å¤„ç†æµ‹è¯•æ¨¡å¼


**æ¨¡å¼1ï¼šé¢„æœŸå¼‚å¸¸éªŒè¯**

```java
@Test
void testExceptionRollback() {
    // ä½¿ç”¨assertThrowsæ•è·å¼‚å¸¸
    Exception exception = assertThrows(
        IllegalArgumentException.class,
        () -> orderService.createOrder(null)
    );
    
    // éªŒè¯å¼‚å¸¸æ¶ˆæ¯
    assertEquals("è®¢å•ä¸èƒ½ä¸ºç©º", exception.getMessage());
    
    // éªŒè¯æ•°æ®å·²å›æ»š
    assertEquals(0, orderRepository.count());
}
```

**æ¨¡å¼2ï¼šTry-CatchéªŒè¯**

```java
@Test
@Transactional
void testPartialSuccess() {
    try {
        batchService.importUsers(invalidUserList);
        fail("åº”è¯¥æŠ›å‡ºå¼‚å¸¸");
    } catch (BatchException e) {
        // éªŒè¯éƒ¨åˆ†æˆåŠŸçš„æƒ…å†µ
        assertEquals(2, e.getSuccessCount());
        assertEquals(3, e.getFailCount());
    }
    
    // éªŒè¯äº‹åŠ¡çŠ¶æ€
    assertTrue(TestTransaction.isFlaggedForRollback());
}
```

### 6.4 æ€§èƒ½æµ‹è¯•æ³¨æ„äº‹é¡¹


**âš ï¸ é¿å…åœ¨äº‹åŠ¡æµ‹è¯•ä¸­åšæ€§èƒ½æµ‹è¯•**

```java
// âŒ ä¸æ¨èï¼šäº‹åŠ¡æµ‹è¯•ä¸­åšæ€§èƒ½æµ‹è¯•
@Test
@Transactional
void badPerformanceTest() {
    long start = System.currentTimeMillis();
    
    for (int i = 0; i < 10000; i++) {
        userRepository.save(new User("ç”¨æˆ·" + i, "user" + i + "@example.com"));
    }
    
    long end = System.currentTimeMillis();
    
    // è¿™ä¸ªæ—¶é—´ä¸å‡†ç¡®ï¼Œå› ä¸ºï¼š
    // 1. æµ‹è¯•äº‹åŠ¡ä¼šå½±å“æ€§èƒ½
    // 2. æœ€åä¼šå›æ»šï¼Œæ€§èƒ½ç‰¹å¾ä¸ç”Ÿäº§ä¸åŒ
}
```

**âœ… æ¨èï¼šåˆ†ç¦»æ€§èƒ½æµ‹è¯•**

```java
// âœ… æ¨èï¼šä¸“é—¨çš„æ€§èƒ½æµ‹è¯•
@SpringBootTest
@Rollback(false)  // ä¸å›æ»šï¼Œæ¨¡æ‹ŸçœŸå®ç¯å¢ƒ
class PerformanceTest {
    
    @Test
    void performanceTest() {
        long start = System.currentTimeMillis();
        
        batchService.batchImport(largeUserList);
        
        long end = System.currentTimeMillis();
        
        assertTrue(end - start < 5000, "æ‰¹é‡å¯¼å…¥åº”åœ¨5ç§’å†…å®Œæˆ");
        
        // æµ‹è¯•åæ‰‹åŠ¨æ¸…ç†æ•°æ®
        userRepository.deleteAll();
    }
}
```

### 6.5 æµ‹è¯•å‘½åä¸ç»„ç»‡


**æ¸…æ™°çš„æµ‹è¯•å‘½å**ï¼š

```java
@SpringBootTest
@Transactional
class UserServiceTest {
    
    // âœ… å¥½çš„å‘½åï¼šè¯´æ˜æµ‹è¯•ä»€ä¹ˆåœºæ™¯
    @Test
    void shouldCreateUserSuccessfully() { }
    
    @Test
    void shouldThrowExceptionWhenEmailIsDuplicate() { }
    
    @Test
    void shouldRollbackWhenPhoneIsInvalid() { }
    
    // âŒ ä¸å¥½çš„å‘½åï¼šçœ‹ä¸å‡ºæµ‹è¯•ç›®çš„
    @Test
    void test1() { }
    
    @Test
    void testUser() { }
}
```

**æµ‹è¯•åˆ†ç»„ç»„ç»‡**ï¼š

```java
@SpringBootTest
@Transactional
class TransactionTest {
    
    @Nested
    @DisplayName("æ­£å¸¸æäº¤æµ‹è¯•")
    class CommitTests {
        
        @Test
        void shouldCommitWhenAllValidationsPass() { }
        
        @Test
        void shouldCommitWhenDataIsValid() { }
    }
    
    @Nested
    @DisplayName("å›æ»šæµ‹è¯•")
    class RollbackTests {
        
        @Test
        void shouldRollbackWhenExceptionThrown() { }
        
        @Test
        void shouldRollbackWhenConstraintViolated() { }
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒçŸ¥è¯†


**ğŸ”¸ æµ‹è¯•ä¸­çš„äº‹åŠ¡é»˜è®¤è¡Œä¸º**
```
@Transactionalåœ¨æµ‹è¯•ä¸­ = è‡ªåŠ¨å›æ»š
ç›®çš„ï¼šä¿æŒæ•°æ®åº“å¹²å‡€ï¼Œæµ‹è¯•å¯é‡å¤æ‰§è¡Œ
```

**ğŸ”¸ ä¸‰å¤§æ ¸å¿ƒæ³¨è§£**
```
@Transactional  â†’ å¼€å¯æµ‹è¯•äº‹åŠ¡ï¼ˆé»˜è®¤å›æ»šï¼‰
@Rollback       â†’ æ§åˆ¶æ˜¯å¦å›æ»šï¼ˆé»˜è®¤trueï¼‰
@Commit         â†’ å¼ºåˆ¶æäº¤ï¼ˆç­‰äº@Rollback(false)ï¼‰
```

**ğŸ”¸ TestTransactionå·¥å…·**
```
isActive()              â†’ æ£€æŸ¥äº‹åŠ¡æ˜¯å¦æ¿€æ´»
flagForRollback()       â†’ æ ‡è®°å›æ»š
isFlaggedForRollback()  â†’ æ£€æŸ¥å›æ»šæ ‡è®°
end() / start()         â†’ æ‰‹åŠ¨æ§åˆ¶äº‹åŠ¡è¾¹ç•Œ
```

**ğŸ”¸ æµ‹è¯•åˆ†ç±»**
```
å•å…ƒæµ‹è¯•  â†’ Mockæ•°æ®åº“ï¼Œä¸æµ‹äº‹åŠ¡
é›†æˆæµ‹è¯•  â†’ çœŸå®æ•°æ®åº“ï¼Œæµ‹äº‹åŠ¡è¡Œä¸º
```

### 7.2 å®è·µè¦ç‚¹


**âœ… æ¨èåšæ³•**ï¼š
- é»˜è®¤ä½¿ç”¨`@Transactional`è®©æµ‹è¯•è‡ªåŠ¨å›æ»š
- éœ€è¦æ£€æŸ¥æ•°æ®åº“æ—¶ä½¿ç”¨`@Rollback(false)`æˆ–`@Commit`
- å›æ»šæµ‹è¯•å¿…é¡»éªŒè¯æ•°æ®ç¡®å®æ²¡æœ‰ä¿å­˜
- é›†æˆæµ‹è¯•è¦†ç›–å…³é”®äº‹åŠ¡åœºæ™¯
- å•å…ƒæµ‹è¯•è¦†ç›–å¤§éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘

**âŒ é¿å…çš„åšæ³•**ï¼š
- ä¸è¦åœ¨æµ‹è¯•ä¸­æ‰‹åŠ¨æ¸…ç†æ•°æ®ï¼ˆç”¨äº‹åŠ¡å›æ»šä»£æ›¿ï¼‰
- ä¸è¦åœ¨äº‹åŠ¡æµ‹è¯•ä¸­åšæ€§èƒ½æµ‹è¯•
- ä¸è¦å¿½ç•¥å¼‚å¸¸åçš„æ•°æ®éªŒè¯
- ä¸è¦è¿‡åº¦ä½¿ç”¨`@Rollback(false)`æ±¡æŸ“æ•°æ®åº“

### 7.3 æµ‹è¯•ç­–ç•¥æ€»ç»“


**é‡‘å­—å¡”æ¨¡å‹**ï¼š
```
         /\
        /ç«¯\        â† å°‘é‡ç«¯åˆ°ç«¯æµ‹è¯•
       /åˆ°ç«¯\
      /------\
     /  é›†æˆ  \      â† é€‚é‡é›†æˆæµ‹è¯•ï¼ˆå«äº‹åŠ¡æµ‹è¯•ï¼‰
    /----------\
   /    å•å…ƒ    \    â† å¤§é‡å•å…ƒæµ‹è¯•
  /--------------\
```

**äº‹åŠ¡æµ‹è¯•æ ¸å¿ƒéªŒè¯ç‚¹**ï¼š
```
1. æ­£å¸¸æƒ…å†µä¸‹äº‹åŠ¡èƒ½å¦æäº¤ âœ“
2. å¼‚å¸¸æƒ…å†µä¸‹äº‹åŠ¡èƒ½å¦å›æ»š âœ“
3. åµŒå¥—äº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ˜¯å¦æ­£ç¡® âœ“
4. éš”ç¦»çº§åˆ«æ˜¯å¦ç¬¦åˆé¢„æœŸ âœ“
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- æµ‹è¯•äº‹åŠ¡é»˜è®¤å›æ»šï¼Œä¿æŒå¹²å‡€
- ç”¨æ³¨è§£æ§åˆ¶å›æ»šè¡Œä¸ºï¼Œçµæ´»æµ‹è¯•
- TestTransactionå·¥å…·ç²¾ç¡®æ§åˆ¶äº‹åŠ¡
- éªŒè¯å›æ»šå¿…çœ‹æ•°æ®åº“çŠ¶æ€
- é›†æˆæµ‹äº‹åŠ¡ï¼Œå•å…ƒæµ‹é€»è¾‘