---
title: 4ã€Transactionalæ³¨è§£è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯@Transactionalæ³¨è§£](#1-ä»€ä¹ˆæ˜¯transactionalæ³¨è§£)
2. [å£°æ˜å¼äº‹åŠ¡çš„å·¥ä½œåŸç†](#2-å£°æ˜å¼äº‹åŠ¡çš„å·¥ä½œåŸç†)
3. [@Transactionalæ³¨è§£çš„ä½¿ç”¨æ–¹å¼](#3-transactionalæ³¨è§£çš„ä½¿ç”¨æ–¹å¼)
4. [æ³¨è§£å±æ€§è¯¦ç»†é…ç½®](#4-æ³¨è§£å±æ€§è¯¦ç»†é…ç½®)
5. [äº‹åŠ¡è¾¹ç•Œå’ŒAOPä»£ç†æœºåˆ¶](#5-äº‹åŠ¡è¾¹ç•Œå’Œaopä»£ç†æœºåˆ¶)
6. [å¸¸è§é—®é¢˜å’Œæœ€ä½³å®è·µ](#6-å¸¸è§é—®é¢˜å’Œæœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯@Transactionalæ³¨è§£


### 1.1 åŸºæœ¬æ¦‚å¿µ


**@Transactionalæ³¨è§£**ï¼šè¿™æ˜¯Springæ¡†æ¶æä¾›çš„ä¸€ä¸ª"é­”æ³•"æ³¨è§£ï¼Œå°±åƒç»™ä½ çš„æ–¹æ³•è´´ä¸Šä¸€ä¸ª"äº‹åŠ¡å¤„ç†"çš„æ ‡ç­¾ã€‚

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ å»é“¶è¡Œè½¬è´¦ï¼Œ@Transactionalå°±åƒæ˜¯é“¶è¡Œçš„"å®‰å…¨ä¿éšœç³»ç»Ÿ"ï¼Œç¡®ä¿è½¬è´¦è¿‡ç¨‹è¦ä¹ˆå®Œå…¨æˆåŠŸï¼Œè¦ä¹ˆå®Œå…¨å¤±è´¥ï¼Œç»ä¸ä¼šå‡ºç°é’±ä»ä½ è´¦æˆ·æ‰£äº†ä½†å¯¹æ–¹æ²¡æ”¶åˆ°çš„æƒ…å†µã€‚

**æ ¸å¿ƒä½œç”¨**ï¼š
- âœ… **è‡ªåŠ¨ç®¡ç†äº‹åŠ¡**ï¼šä¸éœ€è¦æ‰‹åŠ¨å†™å¼€å§‹ã€æäº¤ã€å›æ»šä»£ç 
- âœ… **ç¡®ä¿æ•°æ®ä¸€è‡´æ€§**ï¼šå¤šä¸ªæ•°æ®åº“æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- âœ… **ç®€åŒ–å¼€å‘**ï¼šä¸€ä¸ªæ³¨è§£æå®šå¤æ‚çš„äº‹åŠ¡å¤„ç†

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡ç®¡ç†


**æ²¡æœ‰äº‹åŠ¡ç®¡ç†çš„é—®é¢˜**ï¼š
```
ç”¨æˆ·ä¸‹å•è´­ä¹°å•†å“çš„è¿‡ç¨‹ï¼š
1. æ‰£å‡å•†å“åº“å­˜ âœ… æˆåŠŸ
2. åˆ›å»ºè®¢å•è®°å½• âœ… æˆåŠŸ  
3. æ‰£å‡ç”¨æˆ·ä½™é¢ âŒ å¤±è´¥ï¼ˆä½™é¢ä¸è¶³ï¼‰

ç»“æœï¼šåº“å­˜è¢«æ‰£äº†ï¼Œè®¢å•ä¹Ÿåˆ›å»ºäº†ï¼Œä½†ç”¨æˆ·ä½™é¢æ²¡æ‰£ï¼Œå•†å®¶äºäº†ï¼
```

**æœ‰äº†äº‹åŠ¡ç®¡ç†**ï¼š
```
åŒæ ·çš„è¿‡ç¨‹ï¼Œä½†åŠ äº†@Transactionalï¼š
1. æ‰£å‡å•†å“åº“å­˜ âœ… æˆåŠŸ
2. åˆ›å»ºè®¢å•è®°å½• âœ… æˆåŠŸ
3. æ‰£å‡ç”¨æˆ·ä½™é¢ âŒ å¤±è´¥

Springè‡ªåŠ¨å›æ»šï¼šåº“å­˜æ¢å¤ï¼Œè®¢å•åˆ é™¤ï¼Œä¿æŒæ•°æ®ä¸€è‡´æ€§ï¼
```

### 1.3 å£°æ˜å¼ vs ç¼–ç¨‹å¼äº‹åŠ¡


| ç‰¹ç‚¹ | **å£°æ˜å¼äº‹åŠ¡(@Transactional)** | **ç¼–ç¨‹å¼äº‹åŠ¡** |
|------|-------------------------------|---------------|
| **ä½¿ç”¨æ–¹å¼** | `ä¸€ä¸ªæ³¨è§£æå®š` | `æ‰‹å†™ä»£ç æ§åˆ¶` |
| **ä»£ç ä¾µå…¥æ€§** | `å‡ ä¹æ— ä¾µå…¥` | `ä¸šåŠ¡ä»£ç æ··æ‚äº‹åŠ¡ä»£ç ` |
| **å¼€å‘æ•ˆç‡** | `æé«˜` | `è¾ƒä½` |
| **é€‚ç”¨åœºæ™¯** | `å¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯` | `å¤æ‚äº‹åŠ¡æ§åˆ¶` |

---

## 2. âš™ï¸ å£°æ˜å¼äº‹åŠ¡çš„å·¥ä½œåŸç†


### 2.1 AOPä»£ç†æœºåˆ¶


**å·¥ä½œåŸç†å›¾è§£**ï¼š
```
å®¢æˆ·ç«¯è°ƒç”¨          Spring AOPä»£ç†          å®é™…ä¸šåŠ¡æ–¹æ³•
    |                    |                     |
    |--[1]è°ƒç”¨æ–¹æ³•------>|                     |
    |                   |--[2]å¼€å§‹äº‹åŠ¡-------->|
    |                   |                     |--[3]æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    |                   |<-[4]è¿”å›ç»“æœ---------|
    |                   |--[5]æäº¤/å›æ»šäº‹åŠ¡--->|
    |<--[6]è¿”å›æœ€ç»ˆç»“æœ---|                     |
```

**é€šä¿—è§£é‡Š**ï¼š
- å½“ä½ è°ƒç”¨ä¸€ä¸ªæ ‡æ³¨äº†`@Transactional`çš„æ–¹æ³•æ—¶
- Springä¼šåœ¨ä½ çš„æ–¹æ³•æ‰§è¡Œå‰å"å·å·"åŠ ä¸Šäº‹åŠ¡ç®¡ç†ä»£ç 
- å°±åƒæ˜¯ç»™ä½ çš„æ–¹æ³•ç©¿ä¸Šäº†ä¸€ä»¶"äº‹åŠ¡é˜²æŠ¤æœ"

### 2.2 ä»£ç†å¯¹è±¡åˆ›å»ºè¿‡ç¨‹


> âš ï¸ **é‡è¦ç†è§£**ï¼šSpringä¸ä¼šç›´æ¥è°ƒç”¨ä½ å†™çš„æ–¹æ³•ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ª"ä»£ç†å¯¹è±¡"æ¥è°ƒç”¨

**ä»£ç†åˆ›å»ºæµç¨‹**ï¼š
```
åŸå§‹å¯¹è±¡ï¼šUserService
    â†“
Springæ‰«æå‘ç°@Transactional
    â†“
åˆ›å»ºä»£ç†å¯¹è±¡ï¼šUserService$Proxy
    â†“
å®¢æˆ·ç«¯å®é™…è°ƒç”¨çš„æ˜¯ä»£ç†å¯¹è±¡
```

### 2.3 äº‹åŠ¡ç®¡ç†å™¨çš„ä½œç”¨


**äº‹åŠ¡ç®¡ç†å™¨**ï¼šè´Ÿè´£å…·ä½“çš„äº‹åŠ¡æ“ä½œï¼Œå°±åƒé“¶è¡Œçš„"é£æ§ç³»ç»Ÿ"

**å¸¸ç”¨äº‹åŠ¡ç®¡ç†å™¨**ï¼š
- `DataSourceTransactionManager`ï¼šç”¨äºå•æ•°æ®åº“æ“ä½œ
- `JtaTransactionManager`ï¼šç”¨äºåˆ†å¸ƒå¼äº‹åŠ¡
- `HibernateTransactionManager`ï¼šç”¨äºHibernateæ“ä½œ

---

## 3. ğŸ“ @Transactionalæ³¨è§£çš„ä½¿ç”¨æ–¹å¼


### 3.1 æ–¹æ³•çº§äº‹åŠ¡ï¼ˆæœ€å¸¸ç”¨ï¼‰


**åŸºæœ¬ç”¨æ³•**ï¼š
```java
@Service
public class UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    // ğŸ¯ æ–¹æ³•çº§äº‹åŠ¡ï¼šåªå¯¹è¿™ä¸ªæ–¹æ³•ç”Ÿæ•ˆ
    @Transactional
    public void transferMoney(Long fromUserId, Long toUserId, BigDecimal amount) {
        // 1. æ£€æŸ¥ä½™é¢
        User fromUser = userMapper.findById(fromUserId);
        if (fromUser.getBalance().compareTo(amount) < 0) {
            throw new RuntimeException("ä½™é¢ä¸è¶³");
        }
        
        // 2. æ‰£å‡å‘é€æ–¹ä½™é¢
        fromUser.setBalance(fromUser.getBalance().subtract(amount));
        userMapper.update(fromUser);
        
        // 3. å¢åŠ æ¥æ”¶æ–¹ä½™é¢
        User toUser = userMapper.findById(toUserId);
        toUser.setBalance(toUser.getBalance().add(amount));
        userMapper.update(toUser);
        
        // ä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ•´ä¸ªæ“ä½œéƒ½ä¼šå›æ»š
    }
    
    // è¿™ä¸ªæ–¹æ³•æ²¡æœ‰äº‹åŠ¡
    public User findUser(Long userId) {
        return userMapper.findById(userId);
    }
}
```

> ğŸ’¡ **å…³é”®ç†è§£**ï¼šåªæœ‰`transferMoney`æ–¹æ³•æœ‰äº‹åŠ¡ä¿æŠ¤ï¼Œ`findUser`æ–¹æ³•æ²¡æœ‰

### 3.2 ç±»çº§äº‹åŠ¡


**ç±»çº§é…ç½®**ï¼š
```java
// ğŸ¯ ç±»çº§äº‹åŠ¡ï¼šå¯¹æ•´ä¸ªç±»çš„æ‰€æœ‰publicæ–¹æ³•éƒ½ç”Ÿæ•ˆ
@Transactional
@Service
public class OrderService {
    
    // è¿™ä¸ªæ–¹æ³•è‡ªåŠ¨ç»§æ‰¿ç±»çº§äº‹åŠ¡é…ç½®
    public void createOrder(Order order) {
        // è®¢å•åˆ›å»ºé€»è¾‘
    }
    
    // è¿™ä¸ªæ–¹æ³•ä¹Ÿç»§æ‰¿ç±»çº§äº‹åŠ¡é…ç½®  
    public void cancelOrder(Long orderId) {
        // è®¢å•å–æ¶ˆé€»è¾‘
    }
    
    // ğŸ”¸ æ–¹æ³•çº§é…ç½®ä¼šè¦†ç›–ç±»çº§é…ç½®
    @Transactional(readOnly = true)
    public Order findOrder(Long orderId) {
        // åªè¯»äº‹åŠ¡ï¼Œæ€§èƒ½æ›´å¥½
        return orderMapper.findById(orderId);
    }
}
```

**ä¼˜å…ˆçº§è§„åˆ™**ï¼š
```
æ–¹æ³•çº§@Transactional > ç±»çº§@Transactional > é»˜è®¤é…ç½®
```

### 3.3 æ¥å£çº§äº‹åŠ¡ï¼ˆä¸æ¨èï¼‰


> âš ï¸ **æ³¨æ„**ï¼šè™½ç„¶å¯ä»¥åœ¨æ¥å£ä¸Šä½¿ç”¨ï¼Œä½†ä¸æ¨èï¼Œå› ä¸ºåªæœ‰ä½¿ç”¨æ¥å£ä»£ç†æ—¶æ‰ç”Ÿæ•ˆ

```java
// âŒ ä¸æ¨èï¼šæ¥å£ä¸Šçš„@Transactional
@Transactional
public interface UserService {
    void transferMoney(Long fromUserId, Long toUserId, BigDecimal amount);
}

// âœ… æ¨èï¼šå®ç°ç±»ä¸Šä½¿ç”¨
@Service
public class UserServiceImpl implements UserService {
    
    @Transactional
    @Override
    public void transferMoney(Long fromUserId, Long toUserId, BigDecimal amount) {
        // å…·ä½“å®ç°
    }
}
```

---

## 4. ğŸ”§ æ³¨è§£å±æ€§è¯¦ç»†é…ç½®


### 4.1 äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼ˆPropagationï¼‰


**ä»€ä¹ˆæ˜¯äº‹åŠ¡ä¼ æ’­**ï¼šå½“ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•è°ƒç”¨å¦ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•æ—¶ï¼Œäº‹åŠ¡åº”è¯¥å¦‚ä½•ä¼ æ’­

**å¸¸ç”¨ä¼ æ’­è¡Œä¸º**ï¼š

| ä¼ æ’­è¡Œä¸º | **å«ä¹‰** | **ä½¿ç”¨åœºæ™¯** |
|---------|---------|-------------|
| **REQUIRED** | `å¦‚æœæœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±æ–°å»ºï¼ˆé»˜è®¤ï¼‰` | `å¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯` |
| **REQUIRES_NEW** | `æ€»æ˜¯æ–°å»ºäº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡` | `æ—¥å¿—è®°å½•ã€å®¡è®¡` |
| **SUPPORTS** | `æœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±éäº‹åŠ¡æ‰§è¡Œ` | `æŸ¥è¯¢æ“ä½œ` |
| **NOT_SUPPORTED** | `æ€»æ˜¯éäº‹åŠ¡æ‰§è¡Œï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡` | `å‘é€é‚®ä»¶ã€ç¼“å­˜æ“ä½œ` |

**REQUIREDç¤ºä¾‹**ï¼ˆæœ€å¸¸ç”¨ï¼‰ï¼š
```java
@Service  
public class OrderService {
    
    @Autowired
    private PaymentService paymentService;
    
    @Transactional // é»˜è®¤REQUIRED
    public void processOrder(Order order) {
        // 1. åˆ›å»ºè®¢å•
        saveOrder(order);
        
        // 2. å¤„ç†æ”¯ä»˜ï¼ˆåŠ å…¥å½“å‰äº‹åŠ¡ï¼‰
        paymentService.processPayment(order.getAmount());
        
        // å¦‚æœæ”¯ä»˜å¤±è´¥ï¼Œæ•´ä¸ªè®¢å•ä¹Ÿä¼šå›æ»š
    }
}

@Service
public class PaymentService {
    
    @Transactional // åŠ å…¥å¤–å±‚äº‹åŠ¡
    public void processPayment(BigDecimal amount) {
        // æ”¯ä»˜é€»è¾‘
        if (amount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new RuntimeException("æ”¯ä»˜é‡‘é¢æ— æ•ˆ");
        }
    }
}
```

**REQUIRES_NEWç¤ºä¾‹**ï¼š
```java
@Service
public class AuditService {
    
    // ğŸ¯ æ€»æ˜¯æ–°å»ºäº‹åŠ¡ï¼Œå³ä½¿å¤–å±‚äº‹åŠ¡å›æ»šï¼Œå®¡è®¡æ—¥å¿—ä¹Ÿè¦ä¿å­˜
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void saveAuditLog(String operation, String details) {
        AuditLog log = new AuditLog();
        log.setOperation(operation);
        log.setDetails(details);
        log.setCreateTime(new Date());
        auditMapper.insert(log);
    }
}
```

### 4.2 äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆIsolationï¼‰


**ä»€ä¹ˆæ˜¯éš”ç¦»çº§åˆ«**ï¼šæ§åˆ¶äº‹åŠ¡ä¹‹é—´çš„å¯è§æ€§ï¼Œè§£å†³å¹¶å‘é—®é¢˜

**éš”ç¦»çº§åˆ«å¯¹æ¯”**ï¼š

| éš”ç¦»çº§åˆ« | **è„è¯»** | **ä¸å¯é‡å¤è¯»** | **å¹»è¯»** | **æ€§èƒ½** |
|----------|---------|--------------|---------|---------|
| **READ_UNCOMMITTED** | `å¯èƒ½` | `å¯èƒ½` | `å¯èƒ½` | `æœ€é«˜` |
| **READ_COMMITTED** | `ä¸å¯èƒ½` | `å¯èƒ½` | `å¯èƒ½` | `è¾ƒé«˜` |
| **REPEATABLE_READ** | `ä¸å¯èƒ½` | `ä¸å¯èƒ½` | `å¯èƒ½` | `è¾ƒä½` |
| **SERIALIZABLE** | `ä¸å¯èƒ½` | `ä¸å¯èƒ½` | `ä¸å¯èƒ½` | `æœ€ä½` |

**å®é™…ä½¿ç”¨**ï¼š
```java
@Service
public class AccountService {
    
    // ğŸ¯ è¯»å·²æäº¤ï¼šé€‚åˆå¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public void transferMoney(Long fromId, Long toId, BigDecimal amount) {
        // è½¬è´¦é€»è¾‘
    }
    
    // ğŸ¯ å¯é‡å¤è¯»ï¼šéœ€è¦ä¸€è‡´æ€§è¯»å–çš„åœºæ™¯
    @Transactional(isolation = Isolation.REPEATABLE_READ)
    public BigDecimal calculateTotalBalance(Long userId) {
        // å¤šæ¬¡è¯»å–éœ€è¦ä¿è¯ä¸€è‡´æ€§
        BigDecimal total = BigDecimal.ZERO;
        List<Account> accounts = accountMapper.findByUserId(userId);
        for (Account account : accounts) {
            // å¤šæ¬¡è¯»å–åŒä¸€è´¦æˆ·ä½™é¢åº”è¯¥ç›¸åŒ
            total = total.add(account.getBalance());
        }
        return total;
    }
}
```

### 4.3 äº‹åŠ¡è¶…æ—¶ï¼ˆtimeoutï¼‰


**ä½œç”¨**ï¼šé˜²æ­¢äº‹åŠ¡é•¿æ—¶é—´å ç”¨èµ„æº

```java
@Service
public class BatchService {
    
    // ğŸ¯ è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º30ç§’
    @Transactional(timeout = 30)
    public void batchProcessOrders(List<Order> orders) {
        for (Order order : orders) {
            processOrder(order);
            // å¦‚æœå¤„ç†æ—¶é—´è¶…è¿‡30ç§’ï¼Œäº‹åŠ¡è‡ªåŠ¨å›æ»š
        }
    }
}
```

### 4.4 åªè¯»äº‹åŠ¡ï¼ˆreadOnlyï¼‰


**ä¼˜åŠ¿**ï¼š
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼šæ•°æ®åº“å¯ä»¥è¿›è¡Œä¼˜åŒ–
- âœ… é˜²æ­¢è¯¯æ“ä½œï¼šå°è¯•ä¿®æ”¹æ•°æ®ä¼šæŠ¥é”™

```java
@Service
public class ReportService {
    
    // ğŸ¯ åªè¯»äº‹åŠ¡ï¼šé€‚åˆæŸ¥è¯¢å’ŒæŠ¥è¡¨æ“ä½œ
    @Transactional(readOnly = true)
    public List<OrderReport> generateOrderReport(Date startDate, Date endDate) {
        // åªè¯»æ“ä½œï¼Œæ€§èƒ½æ›´å¥½
        List<Order> orders = orderMapper.findByDateRange(startDate, endDate);
        return convertToReport(orders);
    }
    
    // âŒ åœ¨åªè¯»äº‹åŠ¡ä¸­å°è¯•ä¿®æ”¹ä¼šæŠ¥é”™
    @Transactional(readOnly = true)  
    public void updateOrderStatus(Long orderId, String status) {
        Order order = orderMapper.findById(orderId);
        order.setStatus(status);
        orderMapper.update(order); // è¿™é‡Œä¼šæŠ›å‡ºå¼‚å¸¸
    }
}
```

### 4.5 å›æ»šè§„åˆ™ï¼ˆrollbackFor/noRollbackForï¼‰


**é»˜è®¤å›æ»šè§„åˆ™**ï¼š
- âœ… **RuntimeExceptionåŠå…¶å­ç±»**ï¼šè‡ªåŠ¨å›æ»š
- âŒ **Exception(éRuntime)**ï¼šä¸å›æ»š

**è‡ªå®šä¹‰å›æ»šè§„åˆ™**ï¼š
```java
@Service
public class OrderService {
    
    // ğŸ¯ æŒ‡å®šç‰¹å®šå¼‚å¸¸å›æ»š
    @Transactional(rollbackFor = {IOException.class, CustomException.class})
    public void processOrder(Order order) throws IOException {
        // å³ä½¿æŠ›å‡ºIOExceptionï¼ˆå—æ£€å¼‚å¸¸ï¼‰ï¼Œä¹Ÿä¼šå›æ»š
        if (order == null) {
            throw new IOException("è®¢å•æ•°æ®å¼‚å¸¸");
        }
        saveOrder(order);
    }
    
    // ğŸ¯ æŒ‡å®šå¼‚å¸¸ä¸å›æ»š
    @Transactional(noRollbackFor = BusinessException.class)
    public void processOrderWithLog(Order order) {
        try {
            saveOrder(order);
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ä¸å›æ»šï¼Œä½†è®°å½•æ—¥å¿—
            logService.saveErrorLog(e.getMessage());
            // äº‹åŠ¡ç»§ç»­æäº¤
        }
    }
}
```

---

## 5. ğŸ”„ äº‹åŠ¡è¾¹ç•Œå’ŒAOPä»£ç†æœºåˆ¶


### 5.1 äº‹åŠ¡è¾¹ç•Œçš„ç†è§£


**ä»€ä¹ˆæ˜¯äº‹åŠ¡è¾¹ç•Œ**ï¼šäº‹åŠ¡å¼€å§‹å’Œç»“æŸçš„æ˜ç¡®ç•Œé™

**äº‹åŠ¡è¾¹ç•Œå›¾è§£**ï¼š
```
æ–¹æ³•è°ƒç”¨æµç¨‹ï¼š

å®¢æˆ·ç«¯è°ƒç”¨
    â†“
è¿›å…¥ä»£ç†å¯¹è±¡ â†â€”â€”â€”â€”â€”â€”â€” äº‹åŠ¡å¼€å§‹è¾¹ç•Œ
    â†“
æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    â†“
æ–¹æ³•æ­£å¸¸ç»“æŸ â†â€”â€”â€”â€”â€”â€”â€” äº‹åŠ¡ç»“æŸè¾¹ç•Œï¼ˆæäº¤ï¼‰
    â†“
è¿”å›ç»™å®¢æˆ·ç«¯

å¼‚å¸¸æƒ…å†µï¼š
ä¸šåŠ¡é€»è¾‘æŠ›å¼‚å¸¸ â†â€”â€”â€”â€”â€”â€”â€” äº‹åŠ¡ç»“æŸè¾¹ç•Œï¼ˆå›æ»šï¼‰
    â†“
è¿”å›å¼‚å¸¸ç»™å®¢æˆ·ç«¯
```

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@Service
public class UserService {
    
    @Transactional
    public void updateUserInfo(User user) {
        // â†â€”â€”â€”â€”â€”â€”â€” äº‹åŠ¡åœ¨è¿™é‡Œå¼€å§‹
        
        userMapper.update(user);
        
        if (user.getAge() < 0) {
            throw new RuntimeException("å¹´é¾„ä¸èƒ½ä¸ºè´Ÿæ•°");
            // â†â€”â€”â€”â€”â€”â€”â€” å¼‚å¸¸å¯¼è‡´äº‹åŠ¡å›æ»š
        }
        
        // â†â€”â€”â€”â€”â€”â€”â€” æ­£å¸¸ç»“æŸï¼Œäº‹åŠ¡æäº¤
    }
}
```

### 5.2 AOPä»£ç†çš„ä¸¤ç§æ–¹å¼


**JDKåŠ¨æ€ä»£ç† vs CGLIBä»£ç†**ï¼š

| ç‰¹ç‚¹ | **JDKåŠ¨æ€ä»£ç†** | **CGLIBä»£ç†** |
|------|----------------|--------------|
| **è¦æ±‚** | `å¿…é¡»æœ‰æ¥å£` | `æ— éœ€æ¥å£` |
| **åŸç†** | `åŸºäºæ¥å£åˆ›å»ºä»£ç†` | `åŸºäºç±»ç»§æ‰¿åˆ›å»ºä»£ç†` |
| **æ€§èƒ½** | `è¾ƒå¿«` | `è¾ƒæ…¢ï¼ˆåˆ›å»ºæ—¶ï¼‰` |
| **ä½¿ç”¨åœºæ™¯** | `å®ç°äº†æ¥å£çš„ç±»` | `æ²¡æœ‰æ¥å£çš„ç±»` |

**JDKä»£ç†ç¤ºä¾‹**ï¼š
```java
// æœ‰æ¥å£çš„æƒ…å†µ
public interface UserService {
    void updateUser(User user);
}

@Service
public class UserServiceImpl implements UserService {
    
    @Transactional
    public void updateUser(User user) {
        // Springä¼šåˆ›å»ºåŸºäºæ¥å£çš„ä»£ç†
    }
}
```

**CGLIBä»£ç†ç¤ºä¾‹**ï¼š
```java
// æ²¡æœ‰æ¥å£çš„æƒ…å†µ
@Service
public class UserService { // æ³¨æ„ï¼šæ²¡æœ‰å®ç°æ¥å£
    
    @Transactional
    public void updateUser(User user) {
        // Springä¼šåˆ›å»ºåŸºäºç±»ç»§æ‰¿çš„ä»£ç†
    }
}
```

### 5.3 ä»£ç†å¤±æ•ˆçš„å¸¸è§æƒ…å†µ


**æƒ…å†µ1ï¼šåŒç±»å†…éƒ¨è°ƒç”¨**
```java
@Service
public class UserService {
    
    public void publicMethod() {
        // âŒ ç›´æ¥è°ƒç”¨åŒç±»æ–¹æ³•ï¼Œä¸ä¼šç»è¿‡ä»£ç†
        this.privateTransactionalMethod();
    }
    
    @Transactional
    private void privateTransactionalMethod() {
        // äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆï¼
    }
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
@Service
public class UserService {
    
    @Autowired
    private UserService self; // æ³¨å…¥è‡ªå·±
    
    public void publicMethod() {
        // âœ… é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨
        self.privateTransactionalMethod();
    }
    
    @Transactional
    public void privateTransactionalMethod() {
        // äº‹åŠ¡ç”Ÿæ•ˆ
    }
}
```

**æƒ…å†µ2ï¼šprivateæ–¹æ³•**
```java
@Service
public class UserService {
    
    // âŒ privateæ–¹æ³•ä¸ä¼šè¢«ä»£ç†
    @Transactional
    private void privateMethod() {
        // äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆ
    }
    
    // âœ… publicæ–¹æ³•æ‰ä¼šè¢«ä»£ç†
    @Transactional
    public void publicMethod() {
        // äº‹åŠ¡ç”Ÿæ•ˆ
    }
}
```

**æƒ…å†µ3ï¼šfinalæ–¹æ³•**
```java
@Service
public class UserService {
    
    // âŒ finalæ–¹æ³•æ— æ³•è¢«CGLIBä»£ç†ç»§æ‰¿
    @Transactional
    public final void finalMethod() {
        // å¯èƒ½ä¸ç”Ÿæ•ˆï¼ˆå–å†³äºä»£ç†æ–¹å¼ï¼‰
    }
}
```

---

## 6. âš ï¸ å¸¸è§é—®é¢˜å’Œæœ€ä½³å®è·µ


### 6.1 å¸¸è§é—®é¢˜æ’æŸ¥


**é—®é¢˜1ï¼šäº‹åŠ¡ä¸ç”Ÿæ•ˆ**

> ğŸ” **æ’æŸ¥æ¸…å•**ï¼š
> - [ ] æ–¹æ³•æ˜¯å¦ä¸ºpublicï¼Ÿ
> - [ ] æ˜¯å¦åŒç±»å†…éƒ¨è°ƒç”¨ï¼Ÿ
> - [ ] æ˜¯å¦æœ‰@EnableTransactionManagementï¼Ÿ
> - [ ] æ˜¯å¦é…ç½®äº†äº‹åŠ¡ç®¡ç†å™¨ï¼Ÿ

**é—®é¢˜2ï¼šäº‹åŠ¡æ„å¤–å›æ»š**
```java
@Service
public class OrderService {
    
    @Transactional
    public void processOrder(Order order) {
        try {
            saveOrder(order);
            paymentService.pay(order.getAmount());
        } catch (Exception e) {
            // âŒ æ•è·å¼‚å¸¸ä½†ä¸é‡æ–°æŠ›å‡ºï¼Œäº‹åŠ¡ä¸ä¼šå›æ»š
            log.error("å¤„ç†è®¢å•å¤±è´¥", e);
        }
    }
}
```

**æ­£ç¡®å¤„ç†**ï¼š
```java
@Transactional
public void processOrder(Order order) {
    try {
        saveOrder(order);
        paymentService.pay(order.getAmount());
    } catch (PaymentException e) {
        log.error("æ”¯ä»˜å¤±è´¥", e);
        // âœ… é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘å›æ»š
        throw e;
    }
}
```

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**å»ºè®®1ï¼šåˆç†è®¾ç½®readOnly**
```java
@Service
public class UserService {
    
    // âœ… æŸ¥è¯¢æ–¹æ³•è®¾ç½®ä¸ºåªè¯»
    @Transactional(readOnly = true)
    public List<User> findUsers() {
        return userMapper.findAll();
    }
    
    // âœ… ä¿®æ”¹æ–¹æ³•ä¸è®¾ç½®åªè¯»
    @Transactional
    public void updateUser(User user) {
        userMapper.update(user);
    }
}
```

**å»ºè®®2ï¼šé¿å…é•¿äº‹åŠ¡**
```java
@Service
public class BatchService {
    
    // âŒ ä¸å¥½çš„åšæ³•ï¼šä¸€ä¸ªå¤§äº‹åŠ¡å¤„ç†æ‰€æœ‰æ•°æ®
    @Transactional
    public void processBatchOrdersBad(List<Order> orders) {
        for (Order order : orders) { // å¯èƒ½æœ‰10000ä¸ªè®¢å•
            processOrder(order);
            // äº‹åŠ¡æ—¶é—´è¿‡é•¿ï¼Œå®¹æ˜“è¶…æ—¶å’Œé”å†²çª
        }
    }
    
    // âœ… å¥½çš„åšæ³•ï¼šåˆ†æ‰¹å¤„ç†
    public void processBatchOrdersGood(List<Order> orders) {
        int batchSize = 100;
        for (int i = 0; i < orders.size(); i += batchSize) {
            List<Order> batch = orders.subList(i, 
                Math.min(i + batchSize, orders.size()));
            processBatch(batch);
        }
    }
    
    @Transactional
    private void processBatch(List<Order> batch) {
        for (Order order : batch) {
            processOrder(order);
        }
    }
}
```

### 6.3 æœ€ä½³å®è·µæ€»ç»“


**âœ… æ¨èåšæ³•**ï¼š
1. **æ–¹æ³•çº§äº‹åŠ¡**ï¼šä¼˜å…ˆä½¿ç”¨æ–¹æ³•çº§@Transactional
2. **publicæ–¹æ³•**ï¼šåªåœ¨publicæ–¹æ³•ä¸Šä½¿ç”¨
3. **å¼‚å¸¸å¤„ç†**ï¼šè®©å¼‚å¸¸æ­£ç¡®ä¼ æ’­ä»¥è§¦å‘å›æ»š
4. **åªè¯»è®¾ç½®**ï¼šæŸ¥è¯¢æ–¹æ³•è®¾ç½®readOnly=true
5. **è¶…æ—¶æ§åˆ¶**ï¼šé•¿æ—¶é—´æ“ä½œè®¾ç½®åˆç†è¶…æ—¶æ—¶é—´

**âŒ é¿å…åšæ³•**ï¼š
1. **privateæ–¹æ³•**ï¼šä¸åœ¨privateæ–¹æ³•ä¸Šä½¿ç”¨
2. **å†…éƒ¨è°ƒç”¨**ï¼šé¿å…åŒç±»å†…éƒ¨æ–¹æ³•è°ƒç”¨
3. **åæ‰å¼‚å¸¸**ï¼šä¸è¦æ•è·å¼‚å¸¸åä¸é‡æŠ›
4. **è¿‡é•¿äº‹åŠ¡**ï¼šé¿å…é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡
5. **æ»¥ç”¨ä¼ æ’­**ï¼šä¸å¿…è¦æ—¶ä¸æ”¹å˜ä¼ æ’­è¡Œä¸º

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ @Transactionalæœ¬è´¨ï¼šAOPä»£ç†å®ç°çš„å£°æ˜å¼äº‹åŠ¡ç®¡ç†
ğŸ”¸ ä½¿ç”¨ä½ç½®ï¼šä¼˜å…ˆæ–¹æ³•çº§ï¼Œå…¶æ¬¡ç±»çº§ï¼Œé¿å…æ¥å£çº§
ğŸ”¸ ä»£ç†æœºåˆ¶ï¼šJDKåŠ¨æ€ä»£ç†ï¼ˆæœ‰æ¥å£ï¼‰æˆ–CGLIBä»£ç†ï¼ˆæ— æ¥å£ï¼‰
ğŸ”¸ äº‹åŠ¡è¾¹ç•Œï¼šæ–¹æ³•å¼€å§‹åˆ°ç»“æŸçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
ğŸ”¸ é…ç½®å±æ€§ï¼šä¼ æ’­ã€éš”ç¦»ã€è¶…æ—¶ã€åªè¯»ã€å›æ»šè§„åˆ™
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ äº‹åŠ¡çš„æœ¬è´¨ç†è§£**
```
äº‹åŠ¡ = æ•°æ®åº“æ“ä½œçš„å®‰å…¨ä¿éšœ
@Transactional = ç»™æ–¹æ³•ç©¿ä¸Š"å®‰å…¨é˜²æŠ¤æœ"
ä»£ç†å¯¹è±¡ = Springåˆ›å»ºçš„"æ™ºèƒ½åŒ…è£…å™¨"
```

**ğŸ”¹ ä»£ç†å¤±æ•ˆçš„æ ¹æœ¬åŸå› **
```
æ ¸å¿ƒåŸç†ï¼šå¿…é¡»é€šè¿‡Springä»£ç†å¯¹è±¡è°ƒç”¨æ‰èƒ½è§¦å‘äº‹åŠ¡
å†…éƒ¨è°ƒç”¨ï¼šthis.method() â†’ ç»•è¿‡ä»£ç† â†’ äº‹åŠ¡å¤±æ•ˆ
å¤–éƒ¨è°ƒç”¨ï¼šproxyObject.method() â†’ ç»è¿‡ä»£ç† â†’ äº‹åŠ¡ç”Ÿæ•ˆ
```

**ğŸ”¹ å±æ€§é…ç½®çš„é€‰æ‹©åŸåˆ™**
```
ä¼ æ’­è¡Œä¸ºï¼š90%åœºæ™¯ç”¨é»˜è®¤REQUIRED
éš”ç¦»çº§åˆ«ï¼šå¤§éƒ¨åˆ†ç”¨READ_COMMITTED  
åªè¯»è®¾ç½®ï¼šæŸ¥è¯¢ç”¨trueï¼Œä¿®æ”¹ç”¨false
è¶…æ—¶è®¾ç½®ï¼šé•¿æ“ä½œè®¾ç½®åˆç†æ—¶é—´
å›æ»šè§„åˆ™ï¼šç‰¹æ®Šéœ€æ±‚æ‰è‡ªå®šä¹‰
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **è®¢å•å¤„ç†**ï¼šä¸‹å•ã€æ”¯ä»˜ã€åº“å­˜æ‰£å‡çš„åŸå­æ€§æ“ä½œ
- **è´¦æˆ·è½¬è´¦**ï¼šè½¬å‡ºã€è½¬å…¥æ“ä½œçš„ä¸€è‡´æ€§ä¿éšœ
- **æ‰¹é‡å¤„ç†**ï¼šå¤§æ‰¹é‡æ•°æ®æ“ä½œçš„æ€§èƒ½å’Œå®‰å…¨å¹³è¡¡
- **å®¡è®¡æ—¥å¿—**ï¼šä¸šåŠ¡æ“ä½œå’Œæ—¥å¿—è®°å½•çš„åè°ƒå¤„ç†

**ğŸ”§ å¼€å‘å®è·µ**
- **äº‹åŠ¡è®¾è®¡**ï¼šåˆç†åˆ’åˆ†äº‹åŠ¡è¾¹ç•Œï¼Œé¿å…è¿‡å¤§è¿‡å°
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåªè¯»äº‹åŠ¡ã€è¶…æ—¶æ§åˆ¶ã€æ‰¹é‡å¤„ç†
- **å¼‚å¸¸å¤„ç†**ï¼šæ­£ç¡®çš„å¼‚å¸¸ä¼ æ’­å’Œå›æ»šæ§åˆ¶
- **æµ‹è¯•éªŒè¯**ï¼šäº‹åŠ¡è¡Œä¸ºçš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å£°æ˜å¼äº‹åŠ¡çœŸæ–¹ä¾¿ï¼Œä¸€ä¸ªæ³¨è§£ä¿å®‰å…¨
- ä»£ç†æœºåˆ¶æ˜¯å…³é”®ï¼Œå†…éƒ¨è°ƒç”¨è¦å°å¿ƒ
- ä¼ æ’­éš”ç¦»é…ç½®å¥½ï¼Œå¼‚å¸¸å›æ»šåˆ«å¿˜äº†
- åªè¯»è¶…æ—¶æ€§èƒ½ä½³ï¼Œæœ€ä½³å®è·µè®°å¿ƒé—´