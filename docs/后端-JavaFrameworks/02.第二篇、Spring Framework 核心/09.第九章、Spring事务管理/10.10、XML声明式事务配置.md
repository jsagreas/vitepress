---
title: 10、XML声明式事务配置
---
## 📚 目录

1. [什么是XML声明式事务](#1-什么是XML声明式事务)
2. [核心配置元素详解](#2-核心配置元素详解)
3. [事务属性配置深入](#3-事务属性配置深入)
4. [切入点表达式实战](#4-切入点表达式实战)
5. [完整配置示例](#5-完整配置示例)
6. [配置优化与最佳实践](#6-配置优化与最佳实践)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🌟 什么是XML声明式事务


### 1.1 声明式事务的本质


**简单理解**：就像给方法贴个"事务标签"，Spring自动帮你管理事务的开始、提交和回滚。

```
传统编程式事务：           声明式事务：
手动开启事务              自动开启事务
try {                   只需要配置文件
  // 业务代码             @Transactional
  手动提交事务            或XML配置
} catch {               Spring自动处理
  手动回滚事务
}
```

### 1.2 为什么选择XML配置方式


**💡 XML配置的优势**：
- **集中管理**：所有事务规则在一个地方配置
- **无侵入性**：业务代码完全不需要修改
- **灵活控制**：可以精确控制哪些方法需要事务
- **团队协作**：配置和业务代码分离，便于维护

### 1.3 基本工作原理


```
用户调用业务方法
       ↓
Spring AOP拦截器
       ↓
检查事务配置规则
       ↓
自动开启事务
       ↓
执行业务方法
       ↓
成功→提交事务 | 异常→回滚事务
```

---

## 2. 🔧 核心配置元素详解


### 2.1 tx命名空间详解


**什么是tx命名空间**：Spring专门为事务配置提供的XML标签集合，就像工具箱里的专用工具。

```xml
<!-- 在Spring配置文件头部声明tx命名空间 -->
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="
           http://www.springframework.org/schema/tx
           http://www.springframework.org/schema/tx/spring-tx.xsd">
```

**🔍 命名空间的作用**：
- **tx:advice** - 定义事务通知规则
- **tx:attributes** - 配置事务属性
- **tx:method** - 指定方法级别的事务规则

### 2.2 transaction-manager配置


**事务管理器是什么**：就像银行的出纳员，负责管理所有的事务操作。

```xml
<!-- 配置数据源事务管理器 -->
<bean id="transactionManager" 
      class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
    <property name="dataSource" ref="dataSource"/>
</bean>
```

**📊 常用事务管理器对比**：

| 事务管理器类型 | 适用场景 | 特点 |
|---------------|---------|------|
| `DataSourceTransactionManager` | 单数据源JDBC | 简单轻量，最常用 |
| `JpaTransactionManager` | JPA/Hibernate | 支持JPA规范 |
| `JtaTransactionManager` | 分布式事务 | 支持多数据源 |

### 2.3 aop:advisor配置详解


**什么是aop:advisor**：就像给方法安装一个"事务管家"，自动处理事务相关的事情。

```xml
<!-- 配置事务AOP切面 -->
<aop:config>
    <aop:advisor advice-ref="txAdvice" 
                 pointcut="execution(* com.example.service.*.*(..))"/>
</aop:config>
```

**🎯 advisor配置要素**：
- **advice-ref**：引用事务通知的配置
- **pointcut**：指定哪些方法需要事务管理
- **order**：设置切面执行顺序（可选）

---

## 3. ⚙️ 事务属性配置深入


### 3.1 tx:advice事务通知配置


```xml
<!-- 定义事务通知 -->
<tx:advice id="txAdvice" transaction-manager="transactionManager">
    <tx:attributes>
        <!-- 查询方法：只读事务 -->
        <tx:method name="get*" read-only="true" propagation="SUPPORTS"/>
        <tx:method name="find*" read-only="true" propagation="SUPPORTS"/>
        <tx:method name="query*" read-only="true" propagation="SUPPORTS"/>
        
        <!-- 修改方法：读写事务 -->
        <tx:method name="save*" propagation="REQUIRED" rollback-for="Exception"/>
        <tx:method name="update*" propagation="REQUIRED" rollback-for="Exception"/>
        <tx:method name="delete*" propagation="REQUIRED" rollback-for="Exception"/>
        
        <!-- 默认配置 -->
        <tx:method name="*" propagation="REQUIRED" read-only="false"/>
    </tx:attributes>
</tx:advice>
```

### 3.2 事务传播行为详解


**什么是传播行为**：当一个事务方法调用另一个事务方法时，如何处理事务的"传递"问题。

```
情况1：方法A调用方法B，都需要事务
REQUIRED: B加入A的事务（最常用）
REQUIRES_NEW: B开启新事务，暂停A的事务

情况2：方法A有事务，调用方法B
SUPPORTS: B支持A的事务，但B自己不开事务
MANDATORY: B强制要求A必须有事务
```

**📋 传播行为对照表**：

| 传播行为 | 说明 | 使用场景 |
|---------|------|---------|
| `REQUIRED` | 必须有事务，没有就创建 | 增删改操作（默认） |
| `SUPPORTS` | 支持事务，有就用，没有也行 | 查询操作 |
| `REQUIRES_NEW` | 总是创建新事务 | 日志记录、审计操作 |
| `NOT_SUPPORTED` | 不支持事务，有也挂起 | 发送邮件、文件操作 |

### 3.3 隔离级别配置


**什么是隔离级别**：控制事务之间的"隔离程度"，就像房间的隔音效果。

```xml
<tx:method name="transfer*" 
           isolation="READ_COMMITTED" 
           propagation="REQUIRED"/>
```

**🔒 隔离级别说明**：

```
READ_UNCOMMITTED (读未提交)
- 隔离程度：最低
- 问题：脏读、不可重复读、幻读
- 使用：几乎不用

READ_COMMITTED (读已提交)  
- 隔离程度：中等
- 问题：不可重复读、幻读
- 使用：最常用，MySQL默认

REPEATABLE_READ (可重复读)
- 隔离程度：较高  
- 问题：幻读
- 使用：InnoDB默认

SERIALIZABLE (串行化)
- 隔离程度：最高
- 问题：性能最差
- 使用：极少使用
```

---

## 4. 🎯 切入点表达式实战


### 4.1 切入点表达式语法


**基本语法结构**：
```
execution(修饰符? 返回类型 包名.类名.方法名(参数) 异常?)
```

### 4.2 常用表达式模式


```xml
<!-- 1. 匹配所有Service层方法 -->
<aop:advisor advice-ref="txAdvice" 
             pointcut="execution(* com.example.service.*.*(..))"/>

<!-- 2. 匹配特定包下的所有方法 -->
<aop:advisor advice-ref="txAdvice" 
             pointcut="execution(* com.example..*Service.*(..))"/>

<!-- 3. 匹配特定方法名模式 -->
<aop:advisor advice-ref="txAdvice" 
             pointcut="execution(* *.save*(..)) || execution(* *.update*(..))"/>

<!-- 4. 匹配带有特定注解的方法 -->
<aop:advisor advice-ref="txAdvice" 
             pointcut="@annotation(org.springframework.transaction.annotation.Transactional)"/>
```

**🔍 表达式解读**：

```
execution(* com.example.service.*.*(..))
         ↑ ↑                    ↑ ↑  ↑
         │ │                    │ │  └─ 任意参数
         │ │                    │ └─ 任意方法名
         │ │                    └─ 任意类名
         │ └─ 包路径
         └─ 任意返回类型
```

### 4.3 切入点表达式最佳实践


**✅ 推荐写法**：
```xml
<!-- 按层次划分事务 -->
<aop:config>
    <!-- Service层：完整事务 -->
    <aop:advisor advice-ref="serviceAdvice" 
                 pointcut="execution(* com.example.service.*Service.*(..))"/>
    
    <!-- DAO层：简单事务 -->
    <aop:advisor advice-ref="daoAdvice" 
                 pointcut="execution(* com.example.dao.*Dao.*(..))"/>
</aop:config>
```

**❌ 避免的写法**：
```xml
<!-- 过于宽泛，影响性能 -->
<aop:advisor pointcut="execution(* com.example..*.*(..))"/>

<!-- 过于复杂，难以维护 -->
<aop:advisor pointcut="execution(* *.save*(..)) && 
                      execution(* *.update*(..)) && 
                      execution(* *.delete*(..))"/>
```

---

## 5. 📄 完整配置示例


### 5.1 基础配置模板


```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/tx
           http://www.springframework.org/schema/tx/spring-tx.xsd
           http://www.springframework.org/schema/aop
           http://www.springframework.org/schema/aop/spring-aop.xsd">

    <!-- 1. 数据源配置 -->
    <bean id="dataSource" class="com.alibaba.druid.pool.DruidDataSource">
        <property name="driverClassName" value="com.mysql.cj.jdbc.Driver"/>
        <property name="url" value="jdbc:mysql://localhost:3306/testdb"/>
        <property name="username" value="root"/>
        <property name="password" value="123456"/>
    </bean>

    <!-- 2. 事务管理器 -->
    <bean id="transactionManager" 
          class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
    </bean>

    <!-- 3. 事务通知配置 -->
    <tx:advice id="txAdvice" transaction-manager="transactionManager">
        <tx:attributes>
            <!-- 查询方法配置 -->
            <tx:method name="get*" read-only="true" propagation="SUPPORTS"/>
            <tx:method name="find*" read-only="true" propagation="SUPPORTS"/>
            <tx:method name="list*" read-only="true" propagation="SUPPORTS"/>
            <tx:method name="query*" read-only="true" propagation="SUPPORTS"/>
            <tx:method name="select*" read-only="true" propagation="SUPPORTS"/>
            
            <!-- 修改方法配置 -->
            <tx:method name="save*" propagation="REQUIRED" rollback-for="Exception"/>
            <tx:method name="insert*" propagation="REQUIRED" rollback-for="Exception"/>
            <tx:method name="add*" propagation="REQUIRED" rollback-for="Exception"/>
            <tx:method name="create*" propagation="REQUIRED" rollback-for="Exception"/>
            
            <tx:method name="update*" propagation="REQUIRED" rollback-for="Exception"/>
            <tx:method name="modify*" propagation="REQUIRED" rollback-for="Exception"/>
            <tx:method name="edit*" propagation="REQUIRED" rollback-for="Exception"/>
            
            <tx:method name="delete*" propagation="REQUIRED" rollback-for="Exception"/>
            <tx:method name="remove*" propagation="REQUIRED" rollback-for="Exception"/>
            
            <!-- 批量操作 -->
            <tx:method name="batch*" propagation="REQUIRED" rollback-for="Exception"/>
            
            <!-- 其他方法默认配置 -->
            <tx:method name="*" propagation="REQUIRED" read-only="false"/>
        </tx:attributes>
    </tx:advice>

    <!-- 4. AOP配置 -->
    <aop:config>
        <aop:advisor advice-ref="txAdvice" 
                     pointcut="execution(* com.example.service..*Service.*(..))"/>
    </aop:config>

</beans>
```

### 5.2 多数据源事务配置


```xml
<!-- 主数据源事务管理器 -->
<bean id="primaryTransactionManager" 
      class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
    <property name="dataSource" ref="primaryDataSource"/>
</bean>

<!-- 从数据源事务管理器 -->
<bean id="secondaryTransactionManager" 
      class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
    <property name="dataSource" ref="secondaryDataSource"/>
</bean>

<!-- 主数据源事务通知 -->
<tx:advice id="primaryTxAdvice" transaction-manager="primaryTransactionManager">
    <tx:attributes>
        <tx:method name="*" propagation="REQUIRED" rollback-for="Exception"/>
    </tx:attributes>
</tx:advice>

<!-- 从数据源事务通知 -->
<tx:advice id="secondaryTxAdvice" transaction-manager="secondaryTransactionManager">
    <tx:attributes>
        <tx:method name="*" propagation="REQUIRED" rollback-for="Exception"/>
    </tx:attributes>
</tx:advice>

<!-- AOP配置 -->
<aop:config>
    <!-- 主数据源Service -->
    <aop:advisor advice-ref="primaryTxAdvice" 
                 pointcut="execution(* com.example.primary.service.*.*(..))"/>
    
    <!-- 从数据源Service -->
    <aop:advisor advice-ref="secondaryTxAdvice" 
                 pointcut="execution(* com.example.secondary.service.*.*(..))"/>
</aop:config>
```

---

## 6. 🚀 配置优化与最佳实践


### 6.1 配置驱动优化


**开启配置驱动**：
```xml
<!-- 启用注解驱动事务 -->
<tx:annotation-driven transaction-manager="transactionManager"/>

<!-- 启用AspectJ代理 -->
<aop:aspectj-autoproxy proxy-target-class="true"/>
```

**💡 配置驱动的好处**：
- **自动代理**：Spring自动创建事务代理
- **注解支持**：可以混合使用`@Transactional`注解
- **性能优化**：使用CGLIB代理提升性能

### 6.2 事务超时配置


```xml
<tx:advice id="txAdvice" transaction-manager="transactionManager">
    <tx:attributes>
        <!-- 长时间运行的批量操作 -->
        <tx:method name="batch*" 
                   propagation="REQUIRED" 
                   timeout="300" 
                   rollback-for="Exception"/>
        
        <!-- 普通操作 -->
        <tx:method name="*" 
                   propagation="REQUIRED" 
                   timeout="30" 
                   rollback-for="Exception"/>
    </tx:attributes>
</tx:advice>
```

### 6.3 异常处理优化


```xml
<tx:advice id="txAdvice" transaction-manager="transactionManager">
    <tx:attributes>
        <!-- 精确控制回滚异常 -->
        <tx:method name="save*" 
                   propagation="REQUIRED"
                   rollback-for="java.lang.Exception"
                   no-rollback-for="com.example.exception.BusinessException"/>
        
        <!-- 只对RuntimeException回滚 -->
        <tx:method name="update*" 
                   propagation="REQUIRED"
                   rollback-for="java.lang.RuntimeException"/>
    </tx:attributes>
</tx:advice>
```

### 6.4 性能优化建议


**🎯 优化策略**：

```xml
<!-- 1. 合理设置只读事务 -->
<tx:method name="get*" read-only="true" propagation="SUPPORTS"/>

<!-- 2. 避免过长事务 -->
<tx:method name="longRunningTask" timeout="600"/>

<!-- 3. 合理选择传播行为 -->
<tx:method name="auditLog*" propagation="REQUIRES_NEW"/>
```

**📊 配置性能对比**：

| 配置方式 | 性能影响 | 建议使用场景 |
|---------|---------|-------------|
| 只读事务 | 🟢 性能最好 | 查询操作 |
| REQUIRED | 🟡 性能中等 | 标准CRUD |
| REQUIRES_NEW | 🔴 性能较差 | 日志、审计 |

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心概念


```
🔸 XML声明式事务：通过配置文件管理事务，业务代码无侵入
🔸 tx命名空间：Spring提供的事务配置专用标签
🔸 transaction-manager：事务管理器，负责实际的事务操作
🔸 aop:advisor：AOP切面配置，指定事务应用范围
🔸 切入点表达式：精确控制哪些方法需要事务管理
🔸 事务属性：传播行为、隔离级别、超时时间等配置
```

### 7.2 关键配置要点


**🔹 配置文件结构**：
```
1. 声明命名空间 (tx, aop)
2. 配置事务管理器
3. 定义事务通知 (tx:advice)
4. 配置AOP切面 (aop:advisor)
5. 指定切入点表达式
```

**🔹 事务属性配置原则**：
```
查询方法：read-only="true", propagation="SUPPORTS"
增删改方法：propagation="REQUIRED", rollback-for="Exception"
批量操作：设置合适的timeout值
特殊操作：选择合适的传播行为
```

**🔹 切入点表达式规范**：
```
按层次划分：service层、dao层分别配置
命名规范：按方法名前缀匹配（get*, save*, update*）
避免过宽：不要匹配过多不需要事务的方法
```

### 7.3 实际应用指导


**✅ 适用场景**：
- 大型项目中需要统一的事务管理策略
- 业务代码不能修改，需要外部控制事务
- 需要精确控制不同方法的事务属性
- 团队开发中需要统一的事务配置规范

**⚠️ 注意事项**：
- XML配置较注解方式更繁琐，适合大型项目
- 切入点表达式要精确，避免性能损失
- 事务管理器必须正确配置，否则事务不生效
- 异常处理配置要合理，避免业务异常导致不必要的回滚

**🎯 配置建议**：
- 优先使用约定命名（get*, save*, update*, delete*）
- 合理设置事务超时时间，避免长时间锁定资源
- 读操作配置为只读事务，提升性能
- 重要操作设置合适的隔离级别，保证数据一致性

**核心记忆**：
- XML声明式事务配置 = tx命名空间 + 事务管理器 + aop:advisor
- 事务属性配置要按业务需求精确设置
- 切入点表达式决定事务应用范围
- 配置驱动可以提升开发效率和运行性能