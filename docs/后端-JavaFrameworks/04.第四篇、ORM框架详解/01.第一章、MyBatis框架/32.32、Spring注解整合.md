---
title: 32ã€Springæ³¨è§£æ•´åˆ
---
## ğŸ“š ç›®å½•

1. [æ³¨è§£æ•´åˆæ¦‚è¿°](#1-æ³¨è§£æ•´åˆæ¦‚è¿°)
2. [æ ¸å¿ƒæ‰«ææ³¨è§£](#2-æ ¸å¿ƒæ‰«ææ³¨è§£)
3. [ä¾èµ–æ³¨å…¥æ³¨è§£](#3-ä¾èµ–æ³¨å…¥æ³¨è§£)
4. [äº‹åŠ¡ç®¡ç†æ³¨è§£](#4-äº‹åŠ¡ç®¡ç†æ³¨è§£)
5. [é…ç½®ç®¡ç†æ³¨è§£](#5-é…ç½®ç®¡ç†æ³¨è§£)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ³¨è§£æ•´åˆæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ³¨è§£æ•´åˆ


**é€šä¿—ç†è§£**ï¼šä¼ ç»ŸXMLé…ç½®å°±åƒæ‰‹å†™é…ç½®æ–‡ä»¶ï¼Œè€Œæ³¨è§£æ•´åˆå°±åƒç»™ä»£ç "è´´æ ‡ç­¾"ï¼ŒSpringçœ‹åˆ°è¿™äº›æ ‡ç­¾å°±çŸ¥é“è¯¥æ€ä¹ˆå¤„ç†ã€‚

```
ä¼ ç»ŸXMLæ–¹å¼ï¼ˆç¹çï¼‰ï¼š
éœ€è¦å†™ä¸€å †é…ç½®æ–‡ä»¶ â†’ Springè¯»å–é…ç½® â†’ åˆ›å»ºå¯¹è±¡ â†’ æ³¨å…¥ä¾èµ–

æ³¨è§£æ–¹å¼ï¼ˆç®€æ´ï¼‰ï¼š
åœ¨ç±»ä¸Šè´´ä¸ªæ ‡ç­¾ â†’ Springè‡ªåŠ¨æ‰«æ â†’ è‡ªåŠ¨åˆ›å»º â†’ è‡ªåŠ¨æ³¨å…¥

å°±åƒï¼š
XML = æ‰‹å†™è¯´æ˜ä¹¦ï¼ˆè¯¦ç»†ä½†éº»çƒ¦ï¼‰
æ³¨è§£ = æ™ºèƒ½æ ‡ç­¾ï¼ˆç®€å•ä½†é«˜æ•ˆï¼‰
```

### 1.2 ä¸ºä»€ä¹ˆè¦ç”¨æ³¨è§£æ•´åˆ


**ğŸ”¸ æ ¸å¿ƒä¼˜åŠ¿**
- **ä»£ç æ›´ç®€æ´**ï¼šä¸éœ€è¦å¤§é‡XMLé…ç½®æ–‡ä»¶
- **ç»´æŠ¤æ›´æ–¹ä¾¿**ï¼šé…ç½®å’Œä»£ç åœ¨ä¸€èµ·ï¼Œä¿®æ”¹æ›´ç›´è§‚
- **å¼€å‘æ›´é«˜æ•ˆ**ï¼šSpring Booté»˜è®¤å°±æ˜¯æ³¨è§£é©±åŠ¨

**ğŸ’¡ å®é™…åœºæ™¯å¯¹æ¯”**
```
åœºæ™¯ï¼šè¦é…ç½®100ä¸ªMapperæ¥å£

XMLæ–¹å¼ï¼š
éœ€è¦åœ¨é…ç½®æ–‡ä»¶é‡Œå†™100ä¸ª<bean>æ ‡ç­¾
æ¯æ¬¡æ–°å¢Mapperè¿˜è¦æ‰‹åŠ¨æ·»åŠ é…ç½®

æ³¨è§£æ–¹å¼ï¼š
ä¸€ä¸ª@MapperScanæ³¨è§£æå®š
æ–°å¢Mapperè‡ªåŠ¨è¯†åˆ«ï¼Œä¸éœ€è¦é¢å¤–é…ç½®
```

---

## 2. ğŸ” æ ¸å¿ƒæ‰«ææ³¨è§£


### 2.1 @MapperScanæ‰«ææ³¨è§£


**ğŸ”¸ æ ¸å¿ƒä½œç”¨**ï¼šå‘Šè¯‰Springå»å“ªé‡Œæ‰¾Mapperæ¥å£ï¼Œè‡ªåŠ¨åˆ›å»ºå®ç°ç±»

**é€šä¿—ç†è§£**ï¼š
```
æŠŠå®ƒæƒ³è±¡æˆ"å¿«é€’å‘˜çš„å·¥ä½œèŒƒå›´"
ä½ å‘Šè¯‰å¿«é€’å‘˜ï¼š"å»Aå°åŒºæ‰¾æ‰€æœ‰åŒ…è£¹"
@MapperScanå°±æ˜¯å‘Šè¯‰Springï¼š"å»è¿™ä¸ªåŒ…ä¸‹æ‰¾æ‰€æœ‰Mapperæ¥å£"
```

**ğŸ“ åŸºç¡€ä½¿ç”¨**
```java
@Configuration
@MapperScan("com.example.mapper")  // æ‰«æè¿™ä¸ªåŒ…ä¸‹æ‰€æœ‰æ¥å£
public class MyBatisConfig {
    // Springä¼šè‡ªåŠ¨ä¸ºè¯¥åŒ…ä¸‹æ‰€æœ‰Mapperæ¥å£åˆ›å»ºä»£ç†å¯¹è±¡
}

// å®é™…æ•ˆæœï¼š
// UserMapperæ¥å£ â†’ Springè‡ªåŠ¨åˆ›å»ºå®ç°
// OrderMapperæ¥å£ â†’ Springè‡ªåŠ¨åˆ›å»ºå®ç°
// ProductMapperæ¥å£ â†’ Springè‡ªåŠ¨åˆ›åˆ›å»ºå®ç°
```

**ğŸ¯ é«˜çº§é…ç½®**
```java
@MapperScan(
    basePackages = "com.example.mapper",     // æ‰«æçš„åŒ…è·¯å¾„
    sqlSessionFactoryRef = "sqlSessionFactory", // æŒ‡å®šSqlSessionFactory
    annotationClass = Repository.class       // åªæ‰«æå¸¦@Repositoryçš„æ¥å£
)
```

**âš ï¸ å¸¸è§é—®é¢˜è§£å†³**
```
é—®é¢˜1ï¼šMapperæ³¨å…¥å¤±è´¥
åŸå› ï¼šåŒ…è·¯å¾„å†™é”™äº†
è§£å†³ï¼šæ£€æŸ¥@MapperScançš„è·¯å¾„æ˜¯å¦æ­£ç¡®

é—®é¢˜2ï¼šæ‰«æä¸åˆ°æŸäº›Mapper
åŸå› ï¼šå¯èƒ½åœ¨å­åŒ…é‡Œ
è§£å†³ï¼šä½¿ç”¨é€šé…ç¬¦ "com.example.mapper.**"

é—®é¢˜3ï¼šå¤šä¸ªæ•°æ®æºå†²çª
åŸå› ï¼šæ²¡æŒ‡å®šç”¨å“ªä¸ªSqlSessionFactory
è§£å†³ï¼šç”¨sqlSessionFactoryRefæ˜ç¡®æŒ‡å®š
```

### 2.2 @Repositoryä»“å‚¨æ³¨è§£


**ğŸ”¸ æ ¸å¿ƒä½œç”¨**ï¼šæ ‡è®°è¿™æ˜¯ä¸€ä¸ªæ•°æ®è®¿é—®å±‚çš„ç±»ï¼ŒåŒæ—¶ä¹Ÿæ˜¯Springçš„Bean

**é€šä¿—ç†è§£**ï¼š
```
@Repository = å‘Šè¯‰Spring"è¿™æ˜¯ä¸ªä»“åº“ç®¡ç†å‘˜"
å°±åƒè¶…å¸‚çš„ä»“åº“ï¼Œä¸“é—¨ç®¡ç†æ•°æ®çš„è¿›å‡º
```

**ğŸ“ ä½¿ç”¨æ–¹å¼**
```java
// æ–¹å¼1ï¼šåœ¨æ¥å£ä¸Šæ ‡æ³¨ï¼ˆæ¨èï¼‰
@Repository
public interface UserMapper {
    User findById(Long id);
}

// æ–¹å¼2ï¼šåœ¨å®ç°ç±»ä¸Šæ ‡æ³¨
@Repository
public class UserMapperImpl implements UserMapper {
    // å®ç°ä»£ç 
}

// ä¸ºä»€ä¹ˆè¦ç”¨@Repositoryï¼Ÿ
// 1. è®©Springç®¡ç†è¿™ä¸ªç±»
// 2. å¼‚å¸¸è½¬æ¢ï¼šæ•°æ®åº“å¼‚å¸¸â†’Springçš„DataAccessException
// 3. è¯­ä¹‰æ¸…æ™°ï¼šä¸€çœ‹å°±çŸ¥é“è¿™æ˜¯æ•°æ®è®¿é—®å±‚
```

**ğŸ’¡ ä¸å…¶ä»–æ³¨è§£çš„åŒºåˆ«**
| æ³¨è§£ | ä½œç”¨å±‚æ¬¡ | é€šä¿—ç†è§£ |
|------|---------|----------|
| `@Repository` | **æ•°æ®è®¿é—®å±‚** | `ä»“åº“ç®¡ç†å‘˜ï¼Œä¸“ç®¡æ•°æ®` |
| `@Service` | **ä¸šåŠ¡é€»è¾‘å±‚** | `æœåŠ¡å‘˜ï¼Œå¤„ç†ä¸šåŠ¡` |
| `@Controller` | **æ§åˆ¶å±‚** | `å‰å°æ¥å¾…ï¼Œå¤„ç†è¯·æ±‚` |
| `@Component` | **é€šç”¨ç»„ä»¶** | `ä¸‡èƒ½å·¥ï¼Œå•¥éƒ½èƒ½å¹²` |

**ğŸ”§ å®é™…åº”ç”¨åœºæ™¯**
```java
// åœºæ™¯ï¼šç”¨æˆ·æœåŠ¡éœ€è¦ç”¨åˆ°UserMapper
@Service
public class UserService {
    
    @Autowired
    private UserMapper userMapper;  // è‡ªåŠ¨æ³¨å…¥å¸¦@Repositoryçš„Mapper
    
    public User getUser(Long id) {
        return userMapper.findById(id);
    }
}

// Springçš„å·¥ä½œæµç¨‹ï¼š
// 1. æ‰«æåˆ°@Repository â†’ åˆ›å»ºUserMapperçš„ä»£ç†å¯¹è±¡
// 2. æ‰«æåˆ°@Service â†’ åˆ›å»ºUserServiceå¯¹è±¡
// 3. çœ‹åˆ°@Autowired â†’ è‡ªåŠ¨æ³¨å…¥UserMapperåˆ°UserService
```

---

## 3. ğŸ’‰ ä¾èµ–æ³¨å…¥æ³¨è§£


### 3.1 @Autowiredè‡ªåŠ¨æ³¨å…¥


**ğŸ”¸ æ ¸å¿ƒä½œç”¨**ï¼šè‡ªåŠ¨æ‰¾åˆ°éœ€è¦çš„å¯¹è±¡å¹¶æ³¨å…¥è¿›æ¥ï¼Œä¸ç”¨æ‰‹åŠ¨åˆ›å»º

**é€šä¿—ç†è§£**ï¼š
```
ä¼ ç»Ÿæ–¹å¼ï¼ˆæ‰‹åŠ¨ï¼‰ï¼š
UserMapper mapper = new UserMapperImpl();  // è‡ªå·±åˆ›å»ºå¯¹è±¡

@Autowiredæ–¹å¼ï¼ˆè‡ªåŠ¨ï¼‰ï¼š
@Autowired
private UserMapper mapper;  // Springè‡ªåŠ¨ç»™ä½ æ‰¾åˆ°å¹¶æ³¨å…¥

å°±åƒï¼š
æ‰‹åŠ¨ = è‡ªå·±å»ä»“åº“æ‹¿å·¥å…·
è‡ªåŠ¨ = è¯´ä¸€å£°éœ€è¦ä»€ä¹ˆï¼Œä»“åº“ç®¡ç†å‘˜ç›´æ¥ç»™ä½ é€æ¥
```

**ğŸ“ ä¸‰ç§æ³¨å…¥æ–¹å¼**
```java
// æ–¹å¼1ï¼šå­—æ®µæ³¨å…¥ï¼ˆæœ€å¸¸ç”¨ï¼Œç®€æ´ï¼‰
@Service
public class UserService {
    @Autowired
    private UserMapper userMapper;  // ç›´æ¥æ³¨å…¥åˆ°å­—æ®µ
}

// æ–¹å¼2ï¼šæ„é€ å™¨æ³¨å…¥ï¼ˆæ¨èï¼Œæ›´å®‰å…¨ï¼‰
@Service
public class UserService {
    private final UserMapper userMapper;
    
    @Autowired  // Spring 4.3+å¯çœç•¥
    public UserService(UserMapper userMapper) {
        this.userMapper = userMapper;
    }
}

// æ–¹å¼3ï¼šSetteræ³¨å…¥ï¼ˆçµæ´»ï¼Œå¯é€‰ä¾èµ–ï¼‰
@Service
public class UserService {
    private UserMapper userMapper;
    
    @Autowired
    public void setUserMapper(UserMapper userMapper) {
        this.userMapper = userMapper;
    }
}
```

**âš™ï¸ æ³¨å…¥æ—¶çš„æŸ¥æ‰¾è§„åˆ™**
```
SpringæŸ¥æ‰¾Beançš„é¡ºåºï¼š
1. å…ˆæŒ‰ç±»å‹æ‰¾ï¼ˆbyTypeï¼‰
   - æ‰¾åˆ°å”¯ä¸€çš„ â†’ ç›´æ¥æ³¨å…¥ âœ…
   - æ‰¾åˆ°å¤šä¸ª â†’ å†æŒ‰åç§°æ‰¾
   - æ‰¾ä¸åˆ° â†’ æŠ¥é”™ âŒ

2. æŒ‰åç§°æ‰¾ï¼ˆbyNameï¼‰
   - å˜é‡å = Beanåç§° â†’ æ³¨å…¥ âœ…
   - ä¸åŒ¹é… â†’ æŠ¥é”™ âŒ
```

### 3.2 @Qualifieré™å®šç¬¦


**ğŸ”¸ æ ¸å¿ƒä½œç”¨**ï¼šå½“æœ‰å¤šä¸ªç›¸åŒç±»å‹çš„Beanæ—¶ï¼Œæ˜ç¡®æŒ‡å®šè¦ç”¨å“ªä¸€ä¸ª

**é€šä¿—ç†è§£**ï¼š
```
åœºæ™¯ï¼šè¶…å¸‚æœ‰ä¸‰ç§å¯ä¹ï¼ˆéƒ½æ˜¯å¯ä¹ç±»å‹ï¼‰
- å¯å£å¯ä¹
- ç™¾äº‹å¯ä¹  
- é›¶åº¦å¯ä¹

ä¸ç”¨@Qualifierï¼šè¯´"ç»™æˆ‘å¯ä¹" â†’ åº—å‘˜ä¸çŸ¥é“ç»™å“ªä¸ª
ç”¨@Qualifierï¼šè¯´"ç»™æˆ‘ç™¾äº‹å¯ä¹" â†’ æ˜ç¡®æŒ‡å®š
```

**ğŸ“ ä½¿ç”¨ç¤ºä¾‹**
```java
// é…ç½®å¤šä¸ªæ•°æ®æºçš„æƒ…å†µ
@Configuration
public class DataSourceConfig {
    
    @Bean("masterDB")
    public DataSource masterDataSource() {
        // ä¸»åº“é…ç½®
        return new HikariDataSource();
    }
    
    @Bean("slaveDB")
    public DataSource slaveDataSource() {
        // ä»åº“é…ç½®
        return new HikariDataSource();
    }
}

// ä½¿ç”¨æ—¶æ˜ç¡®æŒ‡å®š
@Service
public class UserService {
    
    @Autowired
    @Qualifier("masterDB")  // æ˜ç¡®è¦ä¸»åº“
    private DataSource masterDataSource;
    
    @Autowired
    @Qualifier("slaveDB")   // æ˜ç¡®è¦ä»åº“
    private DataSource slaveDataSource;
}
```

**ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯**
```
åœºæ™¯1ï¼šå¤šæ•°æ®æº
@Qualifier("orderDB")    // è®¢å•åº“
@Qualifier("productDB")  // å•†å“åº“

åœºæ™¯2ï¼šå¤šç§å®ç°
@Qualifier("aliPayService")   // æ”¯ä»˜å®æ”¯ä»˜
@Qualifier("wechatPayService") // å¾®ä¿¡æ”¯ä»˜

åœºæ™¯3ï¼šä¸åŒç¯å¢ƒ
@Qualifier("devCache")   // å¼€å‘ç¯å¢ƒç¼“å­˜
@Qualifier("prodCache")  // ç”Ÿäº§ç¯å¢ƒç¼“å­˜
```

### 3.3 @Primaryä¸»è¦Bean


**ğŸ”¸ æ ¸å¿ƒä½œç”¨**ï¼šå½“æœ‰å¤šä¸ªç›¸åŒç±»å‹Beanæ—¶ï¼Œæ ‡è®°é»˜è®¤ä½¿ç”¨å“ªä¸€ä¸ª

**é€šä¿—ç†è§£**ï¼š
```
@Primary = è®¾ç½®"é¦–é€‰é¡¹"
å°±åƒæ‰‹æœºè”ç³»äººé‡Œçš„"é»˜è®¤å·ç "
æœ‰å¤šä¸ªå·ç æ—¶ï¼Œé»˜è®¤æ‰“è¿™ä¸ª
```

**ğŸ“ ä½¿ç”¨ç¤ºä¾‹**
```java
@Configuration
public class CacheConfig {
    
    @Bean
    @Primary  // é»˜è®¤ç”¨Redisç¼“å­˜
    public CacheService redisCacheService() {
        return new RedisCacheService();
    }
    
    @Bean
    public CacheService localCacheService() {
        return new LocalCacheService();
    }
}

// ä½¿ç”¨æ—¶ï¼š
@Service
public class ProductService {
    
    @Autowired  // ä¸ç”¨@Qualifierï¼Œè‡ªåŠ¨ç”¨@Primaryçš„
    private CacheService cacheService;  // æ³¨å…¥çš„æ˜¯Redisç¼“å­˜
    
    @Autowired
    @Qualifier("localCacheService")  // æƒ³ç”¨å…¶ä»–çš„æ‰æ˜ç¡®æŒ‡å®š
    private CacheService localCache;
}
```

**ğŸ”„ @Primary vs @Qualifier**
```
@Primaryï¼šè®¾ç½®é»˜è®¤å€¼
- ä¼˜ç‚¹ï¼šä¸ç”¨æ¯æ¬¡éƒ½æŒ‡å®šï¼Œç®€åŒ–ä»£ç 
- ç¼ºç‚¹ï¼šåªèƒ½æœ‰ä¸€ä¸ªä¸»è¦çš„
- åœºæ™¯ï¼šæœ‰æ˜ç¡®çš„"é¦–é€‰"å®ç°

@Qualifierï¼šæ˜ç¡®æŒ‡å®š
- ä¼˜ç‚¹ï¼šç²¾ç¡®æ§åˆ¶ç”¨å“ªä¸ª
- ç¼ºç‚¹ï¼šæ¯æ¬¡éƒ½è¦å†™
- åœºæ™¯ï¼šéœ€è¦çµæ´»åˆ‡æ¢ä¸åŒå®ç°
```

---

## 4. ğŸ”„ äº‹åŠ¡ç®¡ç†æ³¨è§£


### 4.1 @Transactionaläº‹åŠ¡æ³¨è§£


**ğŸ”¸ æ ¸å¿ƒä½œç”¨**ï¼šä¿è¯ä¸€ç»„æ•°æ®åº“æ“ä½œ"è¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥"

**é€šä¿—ç†è§£**ï¼š
```
è½¬è´¦åœºæ™¯ï¼š
Aè´¦æˆ· -100å…ƒ
Bè´¦æˆ· +100å…ƒ

æ²¡æœ‰äº‹åŠ¡ï¼š
å¯èƒ½å‡ºç°Aæ‰£äº†é’±ï¼ŒBæ²¡æ”¶åˆ° â†’ é’±ä¸¢äº†ï¼

æœ‰äº‹åŠ¡ï¼š
Aæ‰£é’±å¤±è´¥ â†’ Bä¹Ÿä¸åŠ é’±
Aæ‰£é’±æˆåŠŸï¼ŒBåŠ é’±å¤±è´¥ â†’ Açš„é’±å›æ»šï¼Œæ¢å¤åŸçŠ¶

å°±åƒï¼š
äº‹åŠ¡ = é“¶è¡Œè½¬è´¦çš„"å®‰å…¨é”"
è¦ä¹ˆä¸€èµ·æˆåŠŸï¼Œè¦ä¹ˆä¸€èµ·å¤±è´¥ï¼Œä¸ä¼šå‡ºç°ä¸­é—´çŠ¶æ€
```

**ğŸ“ åŸºç¡€ä½¿ç”¨**
```java
@Service
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private AccountMapper accountMapper;
    
    // æ·»åŠ äº‹åŠ¡ï¼šä¸€æ—¦å‡ºé”™ï¼Œæ‰€æœ‰æ“ä½œéƒ½å›æ»š
    @Transactional
    public void createOrder(Order order) {
        // æ“ä½œ1ï¼šåˆ›å»ºè®¢å•
        orderMapper.insert(order);
        
        // æ“ä½œ2ï¼šæ‰£å‡åº“å­˜
        orderMapper.updateStock(order.getProductId());
        
        // æ“ä½œ3ï¼šæ‰£æ¬¾
        accountMapper.deduct(order.getUserId(), order.getAmount());
        
        // å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œå‰é¢çš„æ“ä½œéƒ½ä¼šæ’¤é”€
    }
}
```

**âš™ï¸ é‡è¦å±æ€§é…ç½®**
```java
@Transactional(
    // 1. ä¼ æ’­è¡Œä¸ºï¼šäº‹åŠ¡å¦‚ä½•ä¼ é€’
    propagation = Propagation.REQUIRED,  // é»˜è®¤ï¼šæœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±æ–°å»º
    
    // 2. éš”ç¦»çº§åˆ«ï¼šå¹¶å‘æ—¶çš„æ•°æ®éš”ç¦»ç¨‹åº¦
    isolation = Isolation.DEFAULT,  // é»˜è®¤ï¼šä½¿ç”¨æ•°æ®åº“é»˜è®¤éš”ç¦»çº§åˆ«
    
    // 3. è¶…æ—¶æ—¶é—´ï¼šå¤šä¹…æ²¡å®Œæˆå°±å›æ»š
    timeout = 30,  // 30ç§’
    
    // 4. åªè¯»äº‹åŠ¡ï¼šä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
    readOnly = false,  // falseè¡¨ç¤ºå¯ä»¥ä¿®æ”¹æ•°æ®
    
    // 5. å›æ»šè§„åˆ™ï¼šä»€ä¹ˆå¼‚å¸¸æ—¶å›æ»š
    rollbackFor = Exception.class  // æ‰€æœ‰å¼‚å¸¸éƒ½å›æ»š
)
public void complexOperation() {
    // å¤æ‚ä¸šåŠ¡é€»è¾‘
}
```

**ğŸ¯ å¸¸ç”¨ä¼ æ’­è¡Œä¸ºè§£é‡Š**
```
æƒ³è±¡ä½ åœ¨åšäº‹æƒ…ï¼Œåˆ«äººæ¥æ‰¾ä½ ï¼š

REQUIREDï¼ˆé»˜è®¤ï¼‰ï¼š
åˆ«äººæœ‰äº‹åŠ¡ â†’ åŠ å…¥ä»–çš„äº‹åŠ¡ï¼ˆä¸€èµ·å¹²ï¼‰
åˆ«äººæ²¡äº‹åŠ¡ â†’ è‡ªå·±å¼€å¯äº‹åŠ¡ï¼ˆè‡ªå·±å¹²ï¼‰

REQUIRES_NEWï¼š
ä¸ç®¡åˆ«äººæœ‰æ²¡æœ‰äº‹åŠ¡ â†’ æ€»æ˜¯å¼€å¯æ–°äº‹åŠ¡ï¼ˆå•ç‹¬å¹²ï¼‰
å°±åƒï¼šä¸ç®¡åˆ«äººåœ¨å¹²å•¥ï¼Œæˆ‘è‡ªå·±é‡æ–°å¼€å§‹

SUPPORTSï¼š
åˆ«äººæœ‰äº‹åŠ¡ â†’ åŠ å…¥ï¼ˆä¸€èµ·å¹²ï¼‰
åˆ«äººæ²¡äº‹åŠ¡ â†’ ä¸ç”¨äº‹åŠ¡ï¼ˆéšä¾¿å¹²ï¼‰

NOT_SUPPORTEDï¼š
ä¸ç®¡åˆ«äººæœ‰æ²¡æœ‰ â†’ éƒ½ä¸ç”¨äº‹åŠ¡ï¼ˆè£¸å¥”ï¼‰
```

**âš ï¸ äº‹åŠ¡å¤±æ•ˆçš„å¸¸è§åŸå› **
```
é—®é¢˜1ï¼šæ–¹æ³•ä¸æ˜¯public
@Transactional
private void save() { }  // âŒ äº‹åŠ¡ä¸ç”Ÿæ•ˆ
è§£å†³ï¼šæ”¹æˆpublic

é—®é¢˜2ï¼šè‡ªå·±è°ƒç”¨è‡ªå·±
public void methodA() {
    this.methodB();  // âŒ äº‹åŠ¡ä¸ç”Ÿæ•ˆ
}
@Transactional
public void methodB() { }
è§£å†³ï¼šé€šè¿‡Springä»£ç†å¯¹è±¡è°ƒç”¨

é—®é¢˜3ï¼šå¼‚å¸¸è¢«æ•è·äº†
@Transactional
public void save() {
    try {
        // æ“ä½œ
    } catch (Exception e) {
        // åƒæ‰å¼‚å¸¸  âŒ äº‹åŠ¡ä¸ä¼šå›æ»š
    }
}
è§£å†³ï¼šè¦ä¹ˆä¸æ•è·ï¼Œè¦ä¹ˆæ‰‹åŠ¨æŠ›å‡º

é—®é¢˜4ï¼šå¼‚å¸¸ç±»å‹ä¸åŒ¹é…
@Transactional  // é»˜è®¤åªå›æ»šRuntimeException
public void save() throws Exception {
    throw new Exception();  // âŒ ä¸ä¼šå›æ»š
}
è§£å†³ï¼šæŒ‡å®š rollbackFor = Exception.class
```

**ğŸ’¡ å®é™…åº”ç”¨ç¤ºä¾‹**
```java
// åœºæ™¯ï¼šç”µå•†ä¸‹å•æµç¨‹
@Service
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private StockMapper stockMapper;
    
    @Autowired
    private AccountMapper accountMapper;
    
    @Transactional(
        rollbackFor = Exception.class,
        timeout = 30
    )
    public void placeOrder(OrderDTO orderDTO) {
        // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•è®°å½•
        Order order = new Order();
        // ... è®¾ç½®è®¢å•ä¿¡æ¯
        orderMapper.insert(order);
        
        // æ­¥éª¤2ï¼šæ‰£å‡å•†å“åº“å­˜
        int updated = stockMapper.decreaseStock(
            orderDTO.getProductId(), 
            orderDTO.getQuantity()
        );
        if (updated == 0) {
            throw new RuntimeException("åº“å­˜ä¸è¶³");
        }
        
        // æ­¥éª¤3ï¼šæ‰£å‡ç”¨æˆ·ä½™é¢
        accountMapper.deduct(
            orderDTO.getUserId(), 
            orderDTO.getTotalAmount()
        );
        
        // ä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ‰€æœ‰æ“ä½œéƒ½å›æ»š
        // ä¿è¯æ•°æ®ä¸€è‡´æ€§
    }
}
```

---

## 5. âš™ï¸ é…ç½®ç®¡ç†æ³¨è§£


### 5.1 @ConfigurationPropertiesé…ç½®å±æ€§


**ğŸ”¸ æ ¸å¿ƒä½œç”¨**ï¼šæŠŠé…ç½®æ–‡ä»¶çš„å±æ€§è‡ªåŠ¨ç»‘å®šåˆ°Javaå¯¹è±¡ä¸Š

**é€šä¿—ç†è§£**ï¼š
```
ä¼ ç»Ÿæ–¹å¼ï¼š
ä¸€ä¸ªä¸ªè¯»é…ç½® â†’ @Value("${db.url}") â†’ å¾ˆéº»çƒ¦

@ConfigurationPropertiesï¼š
æ‰¹é‡è¯»å–é…ç½® â†’ è‡ªåŠ¨ç»‘å®šåˆ°å¯¹è±¡ â†’ å¾ˆæ–¹ä¾¿

å°±åƒï¼š
ä¼ ç»Ÿ = ä¸€ä»¶ä»¶æ¬è¡Œæ
æ–°æ–¹å¼ = ç”¨è´­ç‰©è½¦ä¸€æ¬¡æ€§è£…èµ°
```

**ğŸ“ ä½¿ç”¨ç¤ºä¾‹**
```java
// 1. é…ç½®æ–‡ä»¶ application.yml
mybatis:
  config-location: classpath:mybatis-config.xml
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.example.entity
  configuration:
    map-underscore-to-camel-case: true
    cache-enabled: true

// 2. åˆ›å»ºé…ç½®ç±»
@Component
@ConfigurationProperties(prefix = "mybatis")
public class MyBatisProperties {
    
    private String configLocation;
    private String mapperLocations;
    private String typeAliasesPackage;
    private Configuration configuration;
    
    // è‡ªåŠ¨ç”Ÿæˆgetter/setter
    // Springä¼šè‡ªåŠ¨æŠŠé…ç½®æ³¨å…¥è¿›æ¥
}

// 3. ä½¿ç”¨é…ç½®
@Service
public class MyBatisService {
    
    @Autowired
    private MyBatisProperties mybatisProperties;
    
    public void printConfig() {
        System.out.println(mybatisProperties.getConfigLocation());
        // è¾“å‡ºï¼šclasspath:mybatis-config.xml
    }
}
```

**ğŸ¯ é«˜çº§ç‰¹æ€§ï¼šé…ç½®éªŒè¯**
```java
@Component
@ConfigurationProperties(prefix = "datasource")
@Validated  // å¼€å¯éªŒè¯
public class DataSourceProperties {
    
    @NotBlank(message = "æ•°æ®åº“URLä¸èƒ½ä¸ºç©º")
    private String url;
    
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    private String username;
    
    @Min(value = 1, message = "æœ€å°è¿æ¥æ•°è‡³å°‘ä¸º1")
    private int minIdle;
    
    @Max(value = 100, message = "æœ€å¤§è¿æ¥æ•°ä¸èƒ½è¶…è¿‡100")
    private int maxActive;
}

// é…ç½®é”™è¯¯æ—¶ï¼Œåº”ç”¨å¯åŠ¨å°±ä¼šæŠ¥é”™
// é¿å…è¿è¡Œæ—¶æ‰å‘ç°é…ç½®é—®é¢˜
```

### 5.2 @Valueå±æ€§æ³¨å…¥


**ğŸ”¸ æ ¸å¿ƒä½œç”¨**ï¼šè¯»å–é…ç½®æ–‡ä»¶ä¸­çš„å•ä¸ªå±æ€§å€¼

**é€šä¿—ç†è§£**ï¼š
```
@Value = ç²¾ç¡®å–ä¸€ä¸ªå€¼
@ConfigurationProperties = æ‰¹é‡å–ä¸€å †å€¼

å°±åƒï¼š
@Value = å»è¶…å¸‚åªä¹°ä¸€ç“¶å¯ä¹
@ConfigurationProperties = å»è¶…å¸‚ä¹°ä¸€è½¦ä¸œè¥¿
```

**ğŸ“ ä½¿ç”¨æ–¹å¼**
```java
@Component
public class DatabaseConfig {
    
    // 1. è¯»å–æ™®é€šå±æ€§
    @Value("${spring.datasource.url}")
    private String dbUrl;
    
    // 2. è¯»å–å¸¦é»˜è®¤å€¼çš„å±æ€§
    @Value("${app.timeout:30}")  // æ²¡é…ç½®å°±ç”¨30
    private int timeout;
    
    // 3. è¯»å–åˆ—è¡¨
    @Value("${app.servers}")
    private List<String> servers;
    
    // 4. ä½¿ç”¨SpELè¡¨è¾¾å¼
    @Value("#{systemProperties['user.home']}")
    private String userHome;
    
    // 5. è¯»å–ç¯å¢ƒå˜é‡
    @Value("${JAVA_HOME}")
    private String javaHome;
}
```

**ğŸ’¡ @Value vs @ConfigurationPropertieså¯¹æ¯”**
```
ä½¿ç”¨åœºæ™¯ï¼š

@Valueé€‚åˆï¼š
âœ… åªéœ€è¦1-2ä¸ªé…ç½®å€¼
âœ… é…ç½®å€¼åˆ†æ•£åœ¨ä¸åŒåœ°æ–¹
âœ… éœ€è¦SpELè¡¨è¾¾å¼è®¡ç®—

@ConfigurationPropertiesé€‚åˆï¼š
âœ… éœ€è¦ä¸€ç»„ç›¸å…³é…ç½®
âœ… é…ç½®æœ‰å±‚æ¬¡ç»“æ„
âœ… éœ€è¦é…ç½®éªŒè¯
âœ… é…ç½®å¤ç”¨æ€§é«˜

å®é™…é€‰æ‹©ï¼š
å°‘é‡é…ç½® â†’ @Value
å¤§é‡é…ç½® â†’ @ConfigurationProperties
```

### 5.3 @Conditionalæ¡ä»¶è£…é…


**ğŸ”¸ æ ¸å¿ƒä½œç”¨**ï¼šæ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦åˆ›å»ºBeanï¼Œå®ç°çµæ´»é…ç½®

**é€šä¿—ç†è§£**ï¼š
```
å°±åƒç‚¹å¤–å–ï¼š
"å¦‚æœä¸‹é›¨ï¼Œå°±ç‚¹å¤–å–"
"å¦‚æœä¸ä¸‹é›¨ï¼Œå°±è‡ªå·±åšé¥­"

@Conditionalå°±æ˜¯è¿™ä¸ª"å¦‚æœ"
æ»¡è¶³æ¡ä»¶ â†’ åˆ›å»ºBean
ä¸æ»¡è¶³ â†’ è·³è¿‡
```

**ğŸ“ å¸¸ç”¨æ¡ä»¶æ³¨è§£**
```java
// 1. æ ¹æ®é…ç½®å†³å®š
@Configuration
public class CacheConfig {
    
    @Bean
    @ConditionalOnProperty(
        name = "cache.type",
        havingValue = "redis",  // é…ç½®å€¼ä¸ºredisæ—¶æ‰åˆ›å»º
        matchIfMissing = false  // æ²¡é…ç½®æ—¶ä¸åˆ›å»º
    )
    public CacheService redisCache() {
        return new RedisCacheService();
    }
    
    @Bean
    @ConditionalOnProperty(
        name = "cache.type",
        havingValue = "local"
    )
    public CacheService localCache() {
        return new LocalCacheService();
    }
}

// 2. æ ¹æ®ç±»æ˜¯å¦å­˜åœ¨
@Configuration
public class WebConfig {
    
    @Bean
    @ConditionalOnClass(name = "com.alibaba.fastjson.JSON")
    public JsonConverter fastJsonConverter() {
        // Fastjsonå­˜åœ¨æ—¶æ‰åˆ›å»º
        return new FastJsonConverter();
    }
}

// 3. æ ¹æ®Beanæ˜¯å¦å­˜åœ¨
@Configuration
public class DataSourceConfig {
    
    @Bean
    @ConditionalOnMissingBean(DataSource.class)
    public DataSource defaultDataSource() {
        // æ²¡æœ‰å…¶ä»–DataSourceæ—¶æ‰åˆ›å»ºé»˜è®¤çš„
        return new HikariDataSource();
    }
}
```

**ğŸ¯ å®é™…åº”ç”¨åœºæ™¯**
```java
// åœºæ™¯ï¼šå¤šç¯å¢ƒé…ç½®
@Configuration
public class EnvironmentConfig {
    
    @Bean
    @ConditionalOnProperty(
        name = "spring.profiles.active",
        havingValue = "dev"
    )
    public DataSource devDataSource() {
        // å¼€å‘ç¯å¢ƒçš„æ•°æ®æº
        HikariDataSource ds = new HikariDataSource();
        ds.setJdbcUrl("jdbc:h2:mem:testdb");
        return ds;
    }
    
    @Bean
    @ConditionalOnProperty(
        name = "spring.profiles.active",
        havingValue = "prod"
    )
    public DataSource prodDataSource() {
        // ç”Ÿäº§ç¯å¢ƒçš„æ•°æ®æº
        HikariDataSource ds = new HikariDataSource();
        ds.setJdbcUrl("jdbc:mysql://prod-server:3306/db");
        return ds;
    }
}

// é…ç½®æ–‡ä»¶åˆ‡æ¢ï¼š
// application-dev.yml â†’ spring.profiles.active=dev â†’ ç”¨å¼€å‘åº“
// application-prod.yml â†’ spring.profiles.active=prod â†’ ç”¨ç”Ÿäº§åº“
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ æ‰«ææ³¨è§£**
- `@MapperScan`ï¼šå‘Šè¯‰Springå»å“ªæ‰¾Mapperæ¥å£ï¼Œè‡ªåŠ¨åˆ›å»ºä»£ç†å¯¹è±¡
- `@Repository`ï¼šæ ‡è®°æ•°æ®è®¿é—®å±‚ï¼Œè®©Springç®¡ç†å¹¶æä¾›å¼‚å¸¸è½¬æ¢

**ğŸ”¸ ä¾èµ–æ³¨å…¥**
- `@Autowired`ï¼šè‡ªåŠ¨æ³¨å…¥éœ€è¦çš„å¯¹è±¡ï¼Œä¸ç”¨æ‰‹åŠ¨åˆ›å»º
- `@Qualifier`ï¼šå¤šä¸ªåŒç±»å‹Beanæ—¶æ˜ç¡®é€‰å“ªä¸ª
- `@Primary`ï¼šè®¾ç½®é»˜è®¤Beanï¼Œä¸ç”¨æ¯æ¬¡æŒ‡å®š

**ğŸ”¸ äº‹åŠ¡ç®¡ç†**
- `@Transactional`ï¼šä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¦ä¹ˆå…¨æˆåŠŸè¦ä¹ˆå…¨å¤±è´¥
- æ³¨æ„ï¼šæ–¹æ³•å¿…é¡»æ˜¯publicï¼Œå¼‚å¸¸è¦èƒ½æŠ›å‡ºï¼Œé¿å…è‡ªè°ƒç”¨

**ğŸ”¸ é…ç½®ç®¡ç†**
- `@ConfigurationProperties`ï¼šæ‰¹é‡è¯»å–é…ç½®åˆ°å¯¹è±¡
- `@Value`ï¼šè¯»å–å•ä¸ªé…ç½®å€¼
- `@Conditional`ï¼šæ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦åˆ›å»ºBean

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ¯ æ³¨è§£çš„æœ¬è´¨**
```
æ³¨è§£ = ç»™ä»£ç è´´æ ‡ç­¾
Springæ‰«ææ ‡ç­¾ â†’ çŸ¥é“è¯¥åšä»€ä¹ˆ
ä¸æ˜¯é­”æ³•ï¼Œæ˜¯æ¡†æ¶çš„çº¦å®š
```

**ğŸ¯ è‡ªåŠ¨è£…é…åŸç†**
```
æµç¨‹ï¼š
1. Springå¯åŠ¨ â†’ æ‰«ææ‰€æœ‰ç±»
2. çœ‹åˆ°æ³¨è§£ â†’ åˆ›å»ºå¯¹åº”çš„Bean
3. çœ‹åˆ°@Autowired â†’ æŸ¥æ‰¾åŒ¹é…çš„Beanæ³¨å…¥
4. æŸ¥æ‰¾è§„åˆ™ â†’ å…ˆæŒ‰ç±»å‹ï¼Œå†æŒ‰åç§°
```

**ğŸ¯ äº‹åŠ¡çš„å…³é”®**
```
æ ¸å¿ƒï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§
åŸç†ï¼šåŸºäºAOPä»£ç†å®ç°
è¦ç‚¹ï¼š
- æ–¹æ³•å¿…é¡»é€šè¿‡ä»£ç†è°ƒç”¨
- å¼‚å¸¸è¦èƒ½å‘å¤–ä¼ æ’­
- æ³¨æ„ä¼ æ’­è¡Œä¸ºçš„é€‰æ‹©
```

### 6.3 å®é™…å¼€å‘å»ºè®®


**ğŸ“Œ æ³¨è§£é€‰æ‹©åŸåˆ™**
```
æ•°æ®è®¿é—®å±‚ï¼š
- æ¥å£ç”¨ @Repository
- é…åˆ @MapperScan æ‰«æ

ä¸šåŠ¡é€»è¾‘å±‚ï¼š
- ç±»ç”¨ @Service
- æ–¹æ³•åŠ  @Transactional

é…ç½®ç®¡ç†ï¼š
- å°‘é‡é…ç½®ç”¨ @Value
- å¤§é‡é…ç½®ç”¨ @ConfigurationProperties
- æ¡ä»¶è£…é…ç”¨ @Conditional
```

**ğŸ“Œ å¸¸è§é—®é¢˜é¿å…**
```
1. äº‹åŠ¡å¤±æ•ˆ
âœ… æ–¹æ³•ç”¨public
âœ… é€šè¿‡Springä»£ç†è°ƒç”¨
âœ… ä¸æ•è·å¼‚å¸¸æˆ–æ‰‹åŠ¨æŠ›å‡º

2. å¾ªç¯ä¾èµ–
âœ… ç”¨æ„é€ å™¨æ³¨å…¥
âœ… æˆ–è€…ç”¨@Lazyå»¶è¿ŸåŠ è½½

3. é…ç½®å†²çª
âœ… ç”¨@Qualifieræ˜ç¡®æŒ‡å®š
âœ… æˆ–è€…ç”¨@Primaryè®¾ç½®é»˜è®¤
```

**ğŸ“Œ æœ€ä½³å®è·µ**
```
1. ä¾èµ–æ³¨å…¥
æ¨èï¼šæ„é€ å™¨æ³¨å…¥ï¼ˆä¸å¯å˜ï¼Œæ˜“æµ‹è¯•ï¼‰
é¿å…ï¼šå­—æ®µæ³¨å…¥ï¼ˆéš¾æµ‹è¯•ï¼Œå¯èƒ½ç©ºæŒ‡é’ˆï¼‰

2. äº‹åŠ¡ç²’åº¦
æ¨èï¼šåœ¨Serviceå±‚åŠ äº‹åŠ¡
é¿å…ï¼šåœ¨Controlleræˆ–Mapperå±‚åŠ 

3. é…ç½®ç®¡ç†
æ¨èï¼šç›¸å…³é…ç½®ç”¨@ConfigurationPropertiesç»Ÿä¸€ç®¡ç†
é¿å…ï¼šåˆ°å¤„ç”¨@Valueåˆ†æ•£é…ç½®
```

**ğŸ¯ æ ¸å¿ƒè®°å¿†å£è¯€**
```
æ‰«ææ³¨è§£æ‰¾å¯¹è±¡ï¼Œä¾èµ–æ³¨å…¥è‡ªåŠ¨è£…
äº‹åŠ¡ä¿è¯åŸå­æ€§ï¼Œé…ç½®ç®¡ç†çµæ´»ç”¨
æ³¨è§£ç®€åŒ–XMLé…ï¼ŒSpring Booté»˜è®¤é€‰
```

**ğŸ’¡ å­¦ä¹ å»ºè®®**
```
1. ç†è§£æ³¨è§£çš„ä½œç”¨ï¼Œä¸è¦æ­»è®°ç¡¬èƒŒ
2. å¤šå†™ä»£ç å®è·µï¼Œä½“ä¼šæ³¨è§£çš„ä¾¿åˆ©
3. é‡åˆ°é—®é¢˜çœ‹æ—¥å¿—ï¼Œç†è§£Springçš„è£…é…è¿‡ç¨‹
4. æŒæ¡å¸¸è§å‘ç‚¹ï¼Œé¿å…é‡å¤è¸©å‘
```