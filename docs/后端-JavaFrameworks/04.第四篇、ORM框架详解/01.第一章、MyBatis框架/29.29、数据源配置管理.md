---
title: 29、数据源配置管理
---
## 📚 目录

1. [数据源的基本概念](#1-数据源的基本概念)
2. [MyBatis内置数据源](#2-MyBatis内置数据源)
3. [第三方连接池集成](#3-第三方连接池集成)
4. [连接池参数调优](#4-连接池参数调优)
5. [连接泄漏检测与监控](#5-连接泄漏检测与监控)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 💧 数据源的基本概念


### 1.1 什么是数据源


**通俗理解**：数据源就像是"水龙头"，你的应用程序需要用数据库时，就从这个"水龙头"里取连接，用完了再还回去。

```
传统方式（每次都创建新连接）：
应用 → 创建连接 → 使用 → 关闭 → 再创建 → 使用 → 关闭
问题：就像每次用水都要挖一口井，太慢了！

数据源方式（连接池）：
应用 → 从池中取 → 使用 → 还回池中 → 再取 → 使用 → 还回
优势：就像水龙头，打开就能用，关上水还在管道里
```

**📌 核心作用**
- **提升性能**：避免频繁创建和销毁数据库连接
- **资源管理**：限制并发连接数，保护数据库
- **连接复用**：一个连接可以被多次使用

### 1.2 数据源在MyBatis中的位置


```
MyBatis工作流程：
┌─────────────┐
│  应用程序    │
└──────┬──────┘
       ↓
┌─────────────┐
│  SqlSession │ ← 会话工厂
└──────┬──────┘
       ↓
┌─────────────┐
│  数据源      │ ← 连接管理器（本节重点）
└──────┬──────┘
       ↓
┌─────────────┐
│  数据库连接  │
└─────────────┘
```

---

## 2. 🔧 MyBatis内置数据源


MyBatis自带了三种数据源类型，就像三种不同档次的"水龙头"系统。

### 2.1 UNPOOLED数据源（无连接池）


**通俗比喻**：就像每次用水都要重新挖井、接管道，用完就拆掉。

**🔸 特点说明**
- **工作方式**：每次需要连接时临时创建，用完立即销毁
- **适用场景**：测试环境、简单的一次性脚本
- **性能表现**：慢，但配置简单

**配置示例**
```xml
<!-- mybatis-config.xml -->
<dataSource type="UNPOOLED">
    <!-- 数据库驱动类 -->
    <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
    <!-- 数据库地址 -->
    <property name="url" value="jdbc:mysql://localhost:3306/test"/>
    <!-- 登录用户名 -->
    <property name="username" value="root"/>
    <!-- 登录密码 -->
    <property name="password" value="123456"/>
</dataSource>
```

> ⚠️ **注意事项**  
> UNPOOLED不适合生产环境，仅用于学习和测试！每次都创建新连接会严重影响性能。

### 2.2 POOLED数据源（连接池）


**通俗比喻**：就像小区的自来水系统，提前准备好一些连接（水管），随时可以打开使用。

**🔸 工作原理**
```
连接池运作流程：
┌─────────────────────────────────┐
│        连接池（池子里的水）        │
│  [连接1] [连接2] [连接3] [连接4]  │
└─────────────────────────────────┘
         ↓取出            ↑归还
┌─────────────┐    ┌─────────────┐
│  应用使用    │    │  使用完毕    │
└─────────────┘    └─────────────┘
```

**配置示例**
```xml
<dataSource type="POOLED">
    <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
    <property name="url" value="jdbc:mysql://localhost:3306/test"/>
    <property name="username" value="root"/>
    <property name="password" value="123456"/>
    
    <!-- 连接池专属配置 -->
    <property name="poolMaximumActiveConnections" value="20"/>
    <property name="poolMaximumIdleConnections" value="5"/>
    <property name="poolMaximumCheckoutTime" value="20000"/>
</dataSource>
```

**📊 关键参数说明**

| 参数名称 | **含义** | **推荐值** | **通俗理解** |
|---------|---------|-----------|-------------|
| `poolMaximumActiveConnections` | 最大活动连接数 | 20-50 | 池子里最多能同时借出几个连接 |
| `poolMaximumIdleConnections` | 最大空闲连接数 | 5-10 | 池子里最多保留几个空闲连接 |
| `poolMaximumCheckoutTime` | 最大借出时间(ms) | 20000 | 一个连接最多能被借走多久 |
| `poolTimeToWait` | 等待时间(ms) | 20000 | 没有可用连接时，最多等多久 |

### 2.3 JNDI数据源（企业级）


**通俗理解**：就像使用物业公司统一提供的水源，不需要自己管理，由应用服务器（如Tomcat）统一配置。

**使用场景**
- 大型企业应用
- 需要跨应用共享连接池
- 使用JavaEE应用服务器

```xml
<dataSource type="JNDI">
    <!-- JNDI名称，指向服务器配置的数据源 -->
    <property name="data_source" value="java:comp/env/jdbc/testDB"/>
</dataSource>
```

> 💡 **实用技巧**  
> 对于新手来说，POOLED是最常用的选择。JNDI需要应用服务器配置，较为复杂。

---

## 3. 🚀 第三方连接池集成


虽然MyBatis自带POOLED够用，但第三方连接池功能更强大，就像从普通水龙头升级到智能净水系统。

### 3.1 为什么要用第三方连接池


**功能对比**

| 功能特性 | **MyBatis POOLED** | **第三方连接池** |
|---------|-------------------|-----------------|
| 基本连接管理 | ✅ 支持 | ✅ 支持 |
| 连接泄漏检测 | ❌ 不支持 | ✅ 支持 |
| 性能监控 | ❌ 不支持 | ✅ 支持 |
| 连接健康检查 | ⚠️ 简单 | ✅ 强大 |
| SQL监控分析 | ❌ 不支持 | ✅ 支持（Druid） |

### 3.2 HikariCP（光速连接池）


**特点**：号称最快的Java连接池，Spring Boot默认使用。

**🌱 入门级配置**
```xml
<!-- 1. 添加依赖（pom.xml） -->
<dependency>
    <groupId>com.zaxxer</groupId>
    <artifactId>HikariCP</artifactId>
    <version>5.0.1</version>
</dependency>

<!-- 2. MyBatis配置 -->
<dataSource type="com.zaxxer.hikari.HikariDataSource">
    <property name="jdbcUrl" value="jdbc:mysql://localhost:3306/test"/>
    <property name="username" value="root"/>
    <property name="password" value="123456"/>
    <property name="driverClassName" value="com.mysql.cj.jdbc.Driver"/>
    
    <!-- 核心参数 -->
    <property name="maximumPoolSize" value="20"/>
    <property name="minimumIdle" value="5"/>
    <property name="connectionTimeout" value="30000"/>
</dataSource>
```

**📊 核心参数速查**

```
maximumPoolSize=20      ← 池子最多20个连接
minimumIdle=5          ← 池子最少保留5个空闲连接
connectionTimeout=30000 ← 获取连接超时时间30秒
idleTimeout=600000     ← 空闲连接10分钟后回收
maxLifetime=1800000    ← 连接最长存活30分钟
```

### 3.3 Druid（阿里出品，监控神器）


**特点**：不仅是连接池，还提供强大的监控和SQL分析功能。

**配置示例**
```xml
<!-- 1. 添加依赖 -->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid</artifactId>
    <version>1.2.20</version>
</dependency>

<!-- 2. MyBatis配置 -->
<dataSource type="com.alibaba.druid.pool.DruidDataSource">
    <property name="url" value="jdbc:mysql://localhost:3306/test"/>
    <property name="username" value="root"/>
    <property name="password" value="123456"/>
    <property name="driverClassName" value="com.mysql.cj.jdbc.Driver"/>
    
    <!-- 连接池配置 -->
    <property name="initialSize" value="5"/>
    <property name="maxActive" value="20"/>
    <property name="minIdle" value="5"/>
    <property name="maxWait" value="60000"/>
    
    <!-- 监控配置 -->
    <property name="filters" value="stat,wall"/>
    <property name="connectionProperties" 
              value="druid.stat.mergeSql=true"/>
</dataSource>
```

**🔥 Druid监控界面**

访问 `http://localhost:8080/druid` 可以看到：
- SQL执行统计（哪些SQL最慢）
- 连接池状态（活跃/空闲连接数）
- SQL防火墙（检测危险SQL）

### 3.4 C3P0（老牌连接池）


**特点**：历史悠久，配置丰富，但性能不如前两者。

```xml
<dataSource type="com.mchange.v2.c3p0.ComboPooledDataSource">
    <property name="jdbcUrl" value="jdbc:mysql://localhost:3306/test"/>
    <property name="user" value="root"/>
    <property name="password" value="123456"/>
    <property name="driverClass" value="com.mysql.cj.jdbc.Driver"/>
    
    <property name="initialPoolSize" value="5"/>
    <property name="maxPoolSize" value="20"/>
    <property name="minPoolSize" value="5"/>
</dataSource>
```

> 📌 **选择建议**  
> - 追求性能：HikariCP  
> - 需要监控：Druid  
> - 老项目兼容：C3P0

---

## 4. ⚙️ 连接池参数调优


### 4.1 核心参数理解


**1️⃣ 最大连接数（maximumPoolSize）**

```
设置原则：
✅ 正确：根据并发量计算
   并发100 → 设置20-30个连接
   并发1000 → 设置50-100个连接

❌ 错误：盲目设置很大的值
   设置500个连接 → 数据库压力过大
```

**2️⃣ 最小空闲连接（minimumIdle）**

```
设置原则：
✅ 正确：保持一定数量的热连接
   设置为最大连接数的20-30%
   例：最大20，最小设置5-6个

❌ 错误：设置为0
   每次都需要新建连接，失去连接池意义
```

**3️⃣ 连接超时时间（connectionTimeout）**

```
设置原则：
✅ 正确：给用户合理的等待时间
   Web应用：30秒
   批处理：60秒以上

❌ 错误：设置过长
   用户等待时间过长，体验差
```

### 4.2 不同场景的推荐配置


**🌱 小型Web应用（日访问<1万）**
```properties
# HikariCP配置
maximumPoolSize=10
minimumIdle=5
connectionTimeout=30000
idleTimeout=600000
```

**🌿 中型应用（日访问1-10万）**
```properties
maximumPoolSize=30
minimumIdle=10
connectionTimeout=30000
idleTimeout=300000
maxLifetime=1800000
```

**🌳 大型应用（日访问>10万）**
```properties
maximumPoolSize=100
minimumIdle=20
connectionTimeout=20000
idleTimeout=180000
maxLifetime=900000
```

### 4.3 性能调优实战


**场景1：连接经常不够用**
```
症状：日志出现 "Connection timeout"

诊断步骤：
1️⃣ 检查当前活跃连接数
2️⃣ 分析慢SQL（是否有查询卡住）
3️⃣ 检查是否存在连接泄漏

解决方案：
✅ 增大maximumPoolSize
✅ 优化慢SQL
✅ 修复连接泄漏代码
```

**场景2：数据库压力过大**
```
症状：数据库CPU使用率高

诊断步骤：
1️⃣ 检查连接池配置是否过大
2️⃣ 查看慢查询日志
3️⃣ 分析索引使用情况

解决方案：
✅ 降低maximumPoolSize
✅ 添加必要的索引
✅ 优化查询语句
```

---

## 5. 🔍 连接泄漏检测与监控


### 5.1 什么是连接泄漏


**通俗理解**：就像借书不还，连接从池子里拿出去后，忘记还回来了。

```
正常流程：
try {
    连接 = 从池中获取();
    执行SQL();
} finally {
    归还连接();  ← 这一步很重要！
}

泄漏场景：
try {
    连接 = 从池中获取();
    执行SQL();
    // 忘记关闭连接！
}
// 连接永远丢失，池子越来越小
```

**常见泄漏原因**
- 异常时没有关闭连接
- 使用完忘记调用`close()`
- 代码逻辑错误导致提前返回

### 5.2 使用HikariCP检测泄漏


```xml
<dataSource type="com.zaxxer.hikari.HikariDataSource">
    <!-- 基础配置... -->
    
    <!-- 开启泄漏检测 -->
    <property name="leakDetectionThreshold" value="60000"/>
</dataSource>
```

**工作原理**
```
设置leakDetectionThreshold=60000：
含义：连接借出超过60秒未归还，就发出警告

日志输出：
[WARN] Connection leak detection triggered for connection
持有连接的代码堆栈信息...
```

> ⚠️ **注意事项**  
> 不要设置太小的值，否则会误报。一般设置为最长SQL执行时间的2-3倍。

### 5.3 使用Druid监控


**1️⃣ 开启监控功能**
```xml
<dataSource type="com.alibaba.druid.pool.DruidDataSource">
    <!-- 基础配置... -->
    
    <!-- 开启监控统计 -->
    <property name="filters" value="stat"/>
    
    <!-- SQL合并统计 -->
    <property name="connectionProperties" 
              value="druid.stat.mergeSql=true;druid.stat.slowSqlMillis=2000"/>
</dataSource>
```

**2️⃣ 配置监控页面（Spring Boot环境）**
```java
@Configuration
public class DruidConfig {
    
    @Bean
    public ServletRegistrationBean druidStatViewServlet() {
        ServletRegistrationBean bean = 
            new ServletRegistrationBean(new StatViewServlet(), "/druid/*");
        
        // 设置访问账号密码
        bean.addInitParameter("loginUsername", "admin");
        bean.addInitParameter("loginPassword", "123456");
        
        return bean;
    }
}
```

**3️⃣ 监控页面功能**

访问 `http://localhost:8080/druid/index.html`

```
📊 数据源监控：
┌──────────────────────────┐
│ 活跃连接：5              │
│ 空闲连接：10             │
│ 等待线程：0              │
│ 连接泄漏：0              │
└──────────────────────────┘

📈 SQL统计：
执行次数最多的SQL TOP 10
执行最慢的SQL TOP 10
```

### 5.4 连接泄漏排查步骤


**步骤流程**
```
第1步：开启泄漏检测
     ↓
第2步：重现问题场景
     ↓
第3步：查看日志堆栈
     ↓
第4步：定位问题代码
     ↓
第5步：修复并验证
```

**常见修复方案**
```java
// ❌ 错误写法：可能泄漏
public void badExample() {
    SqlSession session = factory.openSession();
    // 使用session...
    // 忘记关闭！
}

// ✅ 正确写法：保证关闭
public void goodExample() {
    try (SqlSession session = factory.openSession()) {
        // 使用session...
    } // 自动关闭
}
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的核心概念


```
🔸 数据源本质：管理数据库连接的"水龙头系统"
🔸 连接池作用：复用连接，避免频繁创建销毁
🔸 MyBatis内置：UNPOOLED、POOLED、JNDI三种类型
🔸 第三方选择：HikariCP（快）、Druid（监控）、C3P0（兼容）
🔸 参数调优：根据并发量合理设置连接数
🔸 泄漏检测：必须确保连接正确关闭
```

### 6.2 数据源选型建议


| 场景 | **推荐方案** | **理由** |
|-----|------------|---------|
| 🌱 学习测试 | MyBatis POOLED | 配置简单，够用 |
| 🌿 小型项目 | HikariCP | 性能好，配置少 |
| 🌳 企业应用 | Druid | 监控强大，便于运维 |
| 🏢 老项目升级 | C3P0 | 兼容性好 |

### 6.3 关键配置记忆


**📖 记忆口诀**
```
最大连接看并发，设置过大反而慢
最小连接保热备，节省启动建连时
超时时间要合理，用户体验第一位
定期回收老连接，避免堆积影响性能
```

**🎯 快速配置参考**

```
日访问 < 1万：
maximumPoolSize = 10-20
minimumIdle = 5

日访问 1-10万：
maximumPoolSize = 30-50
minimumIdle = 10-15

日访问 > 10万：
maximumPoolSize = 50-100
minimumIdle = 20-30
```

### 6.4 实战检验清单


✅ **自检清单**：
- [ ] 理解连接池的工作原理
- [ ] 能配置MyBatis POOLED数据源
- [ ] 会集成HikariCP或Druid
- [ ] 知道如何根据并发量调优参数
- [ ] 能开启泄漏检测并排查问题
- [ ] 会使用Druid监控页面

### 6.5 常见问题速查


**Q1：连接池满了怎么办？**
```
诊断：
1. 查看活跃连接数是否达到上限
2. 检查是否有慢SQL
3. 排查连接泄漏

解决：
✅ 优化慢SQL
✅ 增大连接池
✅ 修复泄漏代码
```

**Q2：如何选择合适的连接池大小？**
```
公式参考：
连接数 = (核心线程数 × 2) + 有效磁盘数

实际经验：
小应用：10-20个
中应用：30-50个
大应用：50-100个

压测验证：
逐步增加连接数，找到性能拐点
```

**Q3：必须用第三方连接池吗？**
```
看情况：
✅ 需要监控 → 用Druid
✅ 追求性能 → 用HikariCP
✅ 简单应用 → MyBatis POOLED就够

新手建议：
先用MyBatis POOLED学习
熟悉后再升级第三方连接池
```

**核心记忆**：
- 数据源是连接管理器，连接池避免频繁创建
- 内置POOLED够用，第三方功能更强
- 参数根据并发调，监控检测不可少
- 连接必须正确关，泄漏排查看日志