---
title: 11、动态SQL条件判断
---
## 📚 目录

1. [动态SQL是什么](#1-动态SQL是什么)
2. [if条件判断详解](#2-if条件判断详解)
3. [choose选择语句详解](#3-choose选择语句详解)
4. [test表达式全面解析](#4-test表达式全面解析)
5. [实战应用场景](#5-实战应用场景)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🎯 动态SQL是什么


### 1.1 什么是动态SQL


**通俗理解**：
动态SQL就像是"会变化的SQL语句"。根据不同的条件，自动拼接出不同的SQL。

```
传统写法（写死了）：
SELECT * FROM user WHERE name = '张三' AND age = 18

动态SQL（灵活变化）：
- 如果传了name，就加上 name = ?
- 如果传了age，就加上 age = ?
- 如果都没传，就查全部
```

**为什么需要动态SQL**：

现实开发中，查询条件经常是可选的：
- 🔍 **搜索功能**：用户可能只填写部分条件
- 📋 **列表筛选**：每次筛选的字段不一样
- 🎯 **多条件查询**：条件组合千变万化

**传统做法的问题**：
```java
// ❌ 传统做法：需要写很多if-else拼接SQL
String sql = "SELECT * FROM user WHERE 1=1";
if (name != null) {
    sql += " AND name = '" + name + "'";
}
if (age != null) {
    sql += " AND age = " + age;
}
// 代码冗长，容易出错，SQL注入风险
```

**MyBatis动态SQL的优势**：
```xml
<!-- ✅ MyBatis做法：配置化，安全简洁 -->
<select id="findUser" resultType="User">
    SELECT * FROM user
    WHERE 1=1
    <if test="name != null">
        AND name = #{name}
    </if>
    <if test="age != null">
        AND age = #{age}
    </if>
</select>
```

### 1.2 动态SQL的核心思想


```
核心原理图：

参数输入 → 条件判断 → SQL拼接 → 执行查询
   ↓          ↓          ↓          ↓
{name:张三}  name不为空  加name条件  最终SQL
{age:18}     age不为空   加age条件
```

**三大核心能力**：
- 🔸 **条件判断**：判断参数是否存在、是否为空
- 🔸 **动态拼接**：根据判断结果拼接SQL片段
- 🔸 **安全防护**：自动防止SQL注入

---

## 2. 🔍 if条件判断详解


### 2.1 if标签基本用法


**基本语法**：
```xml
<if test="判断条件">
    SQL片段
</if>
```

**工作原理**：
- **test属性**：填写判断表达式
- **表达式为true**：包含这段SQL
- **表达式为false**：忽略这段SQL

### 2.2 单条件判断


**场景1：根据姓名查询**
```xml
<select id="findByName" resultType="User">
    SELECT * FROM user
    WHERE 1=1
    <if test="name != null and name != ''">
        AND name = #{name}
    </if>
</select>
```

**执行效果对比**：

| 传入参数 | test结果 | 最终SQL |
|---------|---------|---------|
| `name = "张三"` | `true` | `SELECT * FROM user WHERE 1=1 AND name = '张三'` |
| `name = null` | `false` | `SELECT * FROM user WHERE 1=1` |
| `name = ""` | `false` | `SELECT * FROM user WHERE 1=1` |

> 💡 **小技巧**：`WHERE 1=1` 是为了后面方便拼接 `AND` 条件，避免SQL语法错误

### 2.3 多条件组合判断


**场景2：多字段搜索**
```xml
<select id="searchUser" resultType="User">
    SELECT * FROM user
    WHERE 1=1
    <if test="name != null and name != ''">
        AND name LIKE CONCAT('%', #{name}, '%')
    </if>
    <if test="age != null">
        AND age = #{age}
    </if>
    <if test="email != null and email != ''">
        AND email = #{email}
    </if>
</select>
```

**运行示例**：
```
输入：{name: "张", age: 18}
生成SQL：SELECT * FROM user WHERE 1=1 
         AND name LIKE '%张%' 
         AND age = 18

输入：{age: 18}
生成SQL：SELECT * FROM user WHERE 1=1 
         AND age = 18

输入：{}（空参数）
生成SQL：SELECT * FROM user WHERE 1=1
```

### 2.4 不同类型参数的判断


#### 📝 字符串判断


```xml
<!-- 判断字符串不为空 -->
<if test="username != null and username != ''">
    AND username = #{username}
</if>

<!-- 判断字符串包含内容 -->
<if test="keyword != null and keyword.length() > 0">
    AND content LIKE CONCAT('%', #{keyword}, '%')
</if>
```

**注意事项**：
- ✅ 同时判断 `!= null` 和 `!= ''`
- ✅ 空字符串和null是不同的
- ❌ 只判断 `!= null` 可能遇到空串问题

#### 🔢 数字判断


```xml
<!-- 判断数字存在 -->
<if test="age != null">
    AND age = #{age}
</if>

<!-- 判断数字范围 -->
<if test="minAge != null">
    AND age >= #{minAge}
</if>
<if test="maxAge != null">
    AND age &lt;= #{maxAge}
</if>
```

> ⚠️ **特别注意**：XML中 `<` 要写成 `&lt;`，`>` 要写成 `&gt;`

**范围查询示例**：
```
输入：{minAge: 18, maxAge: 30}
生成SQL：... AND age >= 18 AND age <= 30

输入：{minAge: 18}
生成SQL：... AND age >= 18
```

#### 📅 日期判断


```xml
<!-- 判断日期存在 -->
<if test="createTime != null">
    AND create_time = #{createTime}
</if>

<!-- 日期范围查询 -->
<if test="startDate != null">
    AND create_time &gt;= #{startDate}
</if>
<if test="endDate != null">
    AND create_time &lt;= #{endDate}
</if>
```

#### 📦 集合判断


```xml
<!-- 判断List不为空 -->
<if test="idList != null and idList.size() > 0">
    AND id IN
    <foreach collection="idList" item="id" open="(" close=")" separator=",">
        #{id}
    </foreach>
</if>
```

**集合判断要点**：
- 🔸 先判断 `!= null`
- 🔸 再判断 `size() > 0`
- 🔸 两个条件缺一不可

---

## 3. 🎯 choose选择语句详解


### 3.1 choose语句是什么


**通俗理解**：
choose就像Java中的 `switch-case`，或者 `if-else if-else`，**只会选择其中一个分支执行**。

```
if语句：可以同时满足多个条件
choose语句：只能满足一个条件（互斥选择）
```

**基本结构**：
```xml
<choose>
    <when test="条件1">SQL片段1</when>
    <when test="条件2">SQL片段2</when>
    <when test="条件3">SQL片段3</when>
    <otherwise>默认SQL片段</otherwise>
</choose>
```

### 3.2 when条件分支


**场景：按优先级排序**
```xml
<select id="findUserWithOrder" resultType="User">
    SELECT * FROM user
    ORDER BY
    <choose>
        <when test="orderBy == 'age'">
            age DESC
        </when>
        <when test="orderBy == 'name'">
            name ASC
        </when>
        <when test="orderBy == 'createTime'">
            create_time DESC
        </when>
        <otherwise>
            id ASC
        </otherwise>
    </choose>
</select>
```

**执行流程**：
```
输入：{orderBy: "age"}
流程：
1. 检查第1个when → orderBy == 'age' ✓ → 选择 "age DESC"
2. 后面的when和otherwise都不执行

输入：{orderBy: "score"}
流程：
1. 检查第1个when → orderBy == 'age' ✗
2. 检查第2个when → orderBy == 'name' ✗
3. 检查第3个when → orderBy == 'createTime' ✗
4. 执行otherwise → 选择 "id ASC"
```

### 3.3 otherwise默认分支


**作用**：当所有when条件都不满足时，执行otherwise中的内容。

**实战案例：搜索策略选择**
```xml
<select id="searchStrategy" resultType="User">
    SELECT * FROM user WHERE 1=1
    <choose>
        <!-- 优先按ID精确查找 -->
        <when test="id != null">
            AND id = #{id}
        </when>
        <!-- 其次按手机号查找 -->
        <when test="phone != null and phone != ''">
            AND phone = #{phone}
        </when>
        <!-- 再按邮箱查找 -->
        <when test="email != null and email != ''">
            AND email = #{email}
        </when>
        <!-- 最后按姓名模糊查找 -->
        <otherwise>
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>
        </otherwise>
    </choose>
</select>
```

**业务逻辑**：
- 🔸 有ID → 直接精确查询（最快）
- 🔸 有手机号 → 按手机号查询（次优）
- 🔸 有邮箱 → 按邮箱查询
- 🔸 都没有 → 按姓名模糊查询（兜底）

### 3.4 choose vs if 对比


| 对比项 | **if标签** | **choose标签** |
|-------|-----------|---------------|
| **执行方式** | `可以同时执行多个if` | `只执行一个when` |
| **适用场景** | `多条件同时生效` | `条件互斥，选其一` |
| **是否有默认** | `无` | `有otherwise兜底` |

**示例对比**：
```xml
<!-- if：可能同时添加多个条件 -->
<if test="name != null">AND name = #{name}</if>
<if test="age != null">AND age = #{age}</if>
结果：可能同时满足，拼接两个条件

<!-- choose：只会选择一个 -->
<choose>
    <when test="name != null">AND name = #{name}</when>
    <when test="age != null">AND age = #{age}</when>
</choose>
结果：只会选择第一个满足的条件
```

---

## 4. 📝 test表达式全面解析


### 4.1 test表达式语法规则


**基本语法**：
```xml
<if test="表达式">
```

**表达式支持的操作**：

| 操作类型 | **语法** | **示例** |
|---------|---------|---------|
| **判空** | `!= null` | `name != null` |
| **判等** | `==` | `status == 1` |
| **判不等** | `!=` | `type != 'admin'` |
| **逻辑与** | `and` | `name != null and name != ''` |
| **逻辑或** | `or` | `age == 18 or age == 19` |
| **大于** | `&gt;` | `age &gt; 18` |
| **小于** | `&lt;` | `age &lt; 60` |

### 4.2 参数null判断


**null判断要点**：
```xml
<!-- ✅ 正确：先判断null -->
<if test="name != null and name != ''">

<!-- ❌ 错误：可能空指针 -->
<if test="name.length() > 0">
    <!-- 如果name是null，调用length()会报错 -->
</if>
```

**安全判断模式**：
```xml
<!-- 字符串安全判断 -->
<if test="username != null and username != ''">

<!-- 集合安全判断 -->
<if test="list != null and list.size() > 0">

<!-- 对象安全判断 -->
<if test="user != null and user.name != null">
```

### 4.3 字符串空值判断


**三种空值情况**：
- **null**：对象不存在
- **空字符串**：`""`
- **空白字符串**：`"   "`（只有空格）

**完整判断方案**：
```xml
<!-- 方案1：基础判断 -->
<if test="name != null and name != ''">
    AND name = #{name}
</if>

<!-- 方案2：严格判断（排除空格） -->
<if test="name != null and name.trim() != ''">
    AND name = #{name}
</if>
```

**字符串比较**：
```xml
<!-- 字符串相等判断 -->
<if test="status == 'active'">
    AND status = 'active'
</if>

<!-- 字符串包含判断 -->
<if test="name.contains('张')">
    AND name LIKE CONCAT('%', #{name}, '%')
</if>
```

### 4.4 集合空值判断


**List判断**：
```xml
<!-- 基础判断 -->
<if test="idList != null and idList.size() > 0">
    AND id IN (...)
</if>

<!-- 使用!empty语法 -->
<if test="idList != null and !idList.isEmpty()">
    AND id IN (...)
</if>
```

**Map判断**：
```xml
<!-- 判断Map不为空 -->
<if test="params != null and params.size() > 0">
    ...
</if>

<!-- 判断Map中的key存在 -->
<if test="params != null and params.containsKey('age')">
    AND age = #{params.age}
</if>
```

### 4.5 数字范围判断


**区间查询**：
```xml
<!-- 年龄区间 -->
<if test="minAge != null and maxAge != null">
    AND age BETWEEN #{minAge} AND #{maxAge}
</if>

<!-- 价格范围 -->
<if test="minPrice != null">
    AND price &gt;= #{minPrice}
</if>
<if test="maxPrice != null">
    AND price &lt;= #{maxPrice}
</if>
```

**数字比较**：
```xml
<!-- 大于18 -->
<if test="age != null and age &gt; 18">
    AND age > 18
</if>

<!-- 等于0的判断（注意：0也是有效值） -->
<if test="status != null">
    AND status = #{status}
</if>
<!-- 不能写 status != null and status != 0，因为status可能就是0 -->
```

> 💡 **重要提示**：数字0也是有效值，判断时只需 `!= null` 即可

### 4.6 日期条件判断


**日期范围查询**：
```xml
<!-- 创建时间区间 -->
<if test="startDate != null">
    AND create_time &gt;= #{startDate}
</if>
<if test="endDate != null">
    AND create_time &lt;= #{endDate}
</if>
```

**日期比较**：
```xml
<!-- 今天之后的数据 -->
<if test="afterToday != null and afterToday">
    AND create_time > NOW()
</if>

<!-- 本月数据 -->
<if test="currentMonth != null and currentMonth">
    AND DATE_FORMAT(create_time, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
</if>
```

---

## 5. 🚀 实战应用场景


### 5.1 用户搜索功能


**需求**：支持多条件组合搜索用户
```xml
<select id="searchUser" resultType="User">
    SELECT * FROM user
    WHERE 1=1
    
    <!-- 按姓名搜索 -->
    <if test="name != null and name != ''">
        AND name LIKE CONCAT('%', #{name}, '%')
    </if>
    
    <!-- 按年龄范围搜索 -->
    <if test="minAge != null">
        AND age &gt;= #{minAge}
    </if>
    <if test="maxAge != null">
        AND age &lt;= #{maxAge}
    </if>
    
    <!-- 按状态搜索 -->
    <if test="status != null">
        AND status = #{status}
    </if>
    
    <!-- 按注册时间搜索 -->
    <if test="startDate != null">
        AND create_time &gt;= #{startDate}
    </if>
    <if test="endDate != null">
        AND create_time &lt;= #{endDate}
    </if>
</select>
```

**使用示例**：
```java
// 只按姓名搜索
searchUser(name: "张三")
→ SQL: ... WHERE 1=1 AND name LIKE '%张三%'

// 姓名+年龄搜索
searchUser(name: "张三", minAge: 18, maxAge: 30)
→ SQL: ... WHERE 1=1 AND name LIKE '%张三%' AND age >= 18 AND age <= 30
```

### 5.2 商品筛选功能


**需求**：支持分类、价格、品牌等多维度筛选
```xml
<select id="filterProduct" resultType="Product">
    SELECT * FROM product
    WHERE 1=1
    
    <!-- 按分类筛选 -->
    <if test="categoryId != null">
        AND category_id = #{categoryId}
    </if>
    
    <!-- 按价格区间筛选 -->
    <if test="minPrice != null">
        AND price &gt;= #{minPrice}
    </if>
    <if test="maxPrice != null">
        AND price &lt;= #{maxPrice}
    </if>
    
    <!-- 按品牌筛选（多选） -->
    <if test="brandList != null and brandList.size() > 0">
        AND brand_id IN
        <foreach collection="brandList" item="brand" open="(" close=")" separator=",">
            #{brand}
        </foreach>
    </if>
    
    <!-- 排序策略 -->
    ORDER BY
    <choose>
        <when test="orderBy == 'price_asc'">price ASC</when>
        <when test="orderBy == 'price_desc'">price DESC</when>
        <when test="orderBy == 'sales'">sales DESC</when>
        <otherwise>id DESC</otherwise>
    </choose>
</select>
```

### 5.3 订单查询功能


**需求**：支持订单状态、时间、金额等条件查询
```xml
<select id="queryOrder" resultType="Order">
    SELECT * FROM orders
    WHERE 1=1
    
    <!-- 按订单号精确查询 -->
    <if test="orderNo != null and orderNo != ''">
        AND order_no = #{orderNo}
    </if>
    
    <!-- 按用户ID查询 -->
    <if test="userId != null">
        AND user_id = #{userId}
    </if>
    
    <!-- 按订单状态查询 -->
    <if test="statusList != null and statusList.size() > 0">
        AND status IN
        <foreach collection="statusList" item="status" open="(" close=")" separator=",">
            #{status}
        </foreach>
    </if>
    
    <!-- 按金额范围查询 -->
    <if test="minAmount != null">
        AND total_amount &gt;= #{minAmount}
    </if>
    <if test="maxAmount != null">
        AND total_amount &lt;= #{maxAmount}
    </if>
    
    <!-- 按下单时间查询 -->
    <if test="startTime != null">
        AND create_time &gt;= #{startTime}
    </if>
    <if test="endTime != null">
        AND create_time &lt;= #{endTime}
    </if>
</select>
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的核心概念


```
🔸 动态SQL本质：根据条件动态拼接SQL，让SQL变得灵活
🔸 if标签作用：判断条件，决定是否包含某段SQL
🔸 choose标签作用：多个条件中选择一个，类似switch-case
🔸 test表达式：编写判断逻辑的地方，支持各种条件判断
🔸 参数判断：先判null，再判空，避免空指针异常
```

### 6.2 关键理解要点


**🔹 if vs choose 的本质区别**
```
if标签：
- 每个if独立判断
- 可以同时满足多个if
- 用于需要组合多个条件的场景

choose标签：
- 只会选择一个when分支
- 满足第一个就停止
- 用于互斥选择的场景
```

**🔹 test表达式注意事项**
```
✅ 正确做法：
- 字符串：name != null and name != ''
- 数字：age != null（0也是有效值）
- 集合：list != null and list.size() > 0
- XML符号：< 写成 &lt;，> 写成 &gt;

❌ 常见错误：
- 忘记判null直接调用方法
- 数字判断写成 != null and != 0
- XML中直接写 < 和 >
```

**🔹 参数判断优先级**
```
1. 先判断对象是否为null
2. 再判断是否为空（空字符串、空集合）
3. 最后进行业务逻辑判断

顺序不能乱，否则空指针异常！
```

### 6.3 实战建议


**📝 SQL编写建议**：
- 使用 `WHERE 1=1` 方便后续拼接AND条件
- 多条件查询优先使用if标签
- 互斥条件选择使用choose标签
- 复杂条件可以嵌套使用

**🔧 代码优化建议**：
- 提取公共判断条件为sql片段
- 参数对象统一封装，避免参数过多
- 复杂SQL可以分步拼接，提高可读性

**⚠️ 常见问题避坑**：
- 字符串判断别忘了 `!= ''`
- XML特殊符号要转义（`&lt;` `&gt;`）
- 集合判断要先判null再判size
- 数字0是有效值，只需判null

**核心记忆口诀**：
```
动态SQL条件判，if和choose要分清
if可以多条件，choose只选一个行
test表达式要会写，先判null再判空
字符数字集合日期，不同类型不同判
实战场景要灵活，组合使用效率高
```