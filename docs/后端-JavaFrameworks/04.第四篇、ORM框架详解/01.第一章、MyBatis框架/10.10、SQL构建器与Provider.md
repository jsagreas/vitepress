---
title: 10ã€SQLæ„å»ºå™¨ä¸Provider
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯Provider](#1-ä»€ä¹ˆæ˜¯Provider)
2. [å››å¤§Provideræ³¨è§£è¯¦è§£](#2-å››å¤§Provideræ³¨è§£è¯¦è§£)
3. [SQLæ„å»ºå™¨æ ¸å¿ƒæŠ€æœ¯](#3-SQLæ„å»ºå™¨æ ¸å¿ƒæŠ€æœ¯)
4. [Providerç±»ç¼–å†™å®æˆ˜](#4-Providerç±»ç¼–å†™å®æˆ˜)
5. [å‚æ•°ä¼ é€’ä¸å¤„ç†](#5-å‚æ•°ä¼ é€’ä¸å¤„ç†)
6. [åŠ¨æ€SQLæ„å»ºæŠ€å·§](#6-åŠ¨æ€SQLæ„å»ºæŠ€å·§)
7. [æœ€ä½³å®è·µä¸è§„èŒƒ](#7-æœ€ä½³å®è·µä¸è§„èŒƒ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯Provider


### 1.1 ç†è§£Providerçš„æœ¬è´¨


**é€šä¿—è§£é‡Š**ï¼šProviderå°±æ˜¯"SQLè¯­å¥çš„æä¾›è€…"ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸“é—¨ç”¨æ¥**åŠ¨æ€ç”ŸæˆSQLè¯­å¥**çš„å·¥å…·ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆå†™æ­»çš„SQLï¼‰ï¼š
@Select("SELECT * FROM user WHERE id = #{id}")
User findById(Long id);

â†“ é—®é¢˜æ¥äº† â†“

å¦‚æœæŸ¥è¯¢æ¡ä»¶ä¸ç¡®å®šæ€ä¹ˆåŠï¼Ÿ
- æœ‰æ—¶å€™éœ€è¦æŒ‰idæŸ¥
- æœ‰æ—¶å€™éœ€è¦æŒ‰nameæŸ¥  
- æœ‰æ—¶å€™éœ€è¦å¤šæ¡ä»¶ç»„åˆæŸ¥

âŒ ä¸èƒ½ä¸ºæ¯ç§æƒ…å†µéƒ½å†™ä¸€ä¸ªæ–¹æ³•ï¼

âœ… è§£å†³æ–¹æ¡ˆï¼šç”¨ProvideråŠ¨æ€ç”ŸæˆSQLï¼
@SelectProvider(type = UserSqlProvider.class, method = "buildFindSql")
User dynamicFind(Map<String, Object> params);
```

**æ ¸å¿ƒç†è§£**ï¼š
- Provider = ä¸€ä¸ªä¸“é—¨çš„Javaç±»
- è¿™ä¸ªç±»é‡Œæœ‰æ–¹æ³•ä¸“é—¨**åŠ¨æ€æ‹¼æ¥SQLè¯­å¥**
- MyBatisä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•è·å–SQLï¼Œç„¶åå»æ‰§è¡Œ

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Provider


**å®é™…åœºæ™¯å¯¹æ¯”**ï¼š

| åœºæ™¯ | ä¼ ç»ŸXMLæ–¹å¼ | Provideræ–¹å¼ | ä¼˜åŠ¿ |
|------|-----------|-------------|------|
| ç®€å•å›ºå®šæŸ¥è¯¢ | `<select>SELECT * FROM user</select>` | `@Select("SELECT * FROM user")` | XMLæ›´ç›´è§‚ |
| å¤æ‚åŠ¨æ€æŸ¥è¯¢ | XMLä¸­å†™å¤§é‡`<if>` `<choose>` | Javaä»£ç çµæ´»æ‹¼æ¥ | **Provideræ›´çµæ´»** |
| æ¡ä»¶ä¸ç¡®å®š | XMLåµŒå¥—åˆ¤æ–­ï¼Œéš¾ç»´æŠ¤ | Javaé€»è¾‘æ¸…æ™° | **Provideræ˜“ç»´æŠ¤** |
| å¤šè¡¨å…³è” | XMLå†™å¤æ‚ | Javaå¯å¤ç”¨é€»è¾‘ | **Provideræ˜“å¤ç”¨** |

**Providerçš„åº”ç”¨åœºæ™¯**ï¼š
- âœ… æŸ¥è¯¢æ¡ä»¶**åŠ¨æ€å˜åŒ–**ï¼ˆä»Šå¤©æŸ¥åå­—ï¼Œæ˜å¤©æŸ¥å¹´é¾„ï¼‰
- âœ… å¤šæ¡ä»¶**ç»„åˆæœç´¢**ï¼ˆå¯èƒ½1ä¸ªæ¡ä»¶ï¼Œå¯èƒ½5ä¸ªæ¡ä»¶ï¼‰
- âœ… æ‰¹é‡æ“ä½œçš„SQLæ‹¼æ¥ï¼ˆæ’å…¥100æ¡ï¼Œæ’å…¥1000æ¡ï¼‰
- âœ… å¤æ‚ä¸šåŠ¡é€»è¾‘çš„SQLæ„å»º

### 1.3 Providerå·¥ä½œåŸç†å›¾ç¤º


```
åº”ç”¨ç¨‹åºè°ƒç”¨Mapperæ–¹æ³•
         â†“
    @SelectProvideræŒ‡å‘Providerç±»
         â†“
Providerç±»ä¸­çš„æ–¹æ³•è¢«æ‰§è¡Œ
         â†“
    è¿”å›åŠ¨æ€ç”Ÿæˆçš„SQLå­—ç¬¦ä¸²
         â†“
   MyBatisæ‰§è¡Œè¿™ä¸ªSQLè¯­å¥
         â†“
    è¿”å›æŸ¥è¯¢ç»“æœç»™åº”ç”¨ç¨‹åº

ç®€åŒ–ç†è§£ï¼š
åº”ç”¨ â†’ æ‰¾Providerè¦SQL â†’ Providerç”ŸæˆSQL â†’ MyBatisæ‰§è¡Œ â†’ è¿”å›ç»“æœ
```

---

## 2. ğŸ”§ å››å¤§Provideræ³¨è§£è¯¦è§£


### 2.1 @SelectProvider - åŠ¨æ€æŸ¥è¯¢


**æ¦‚å¿µè®²è§£**ï¼š
`@SelectProvider`å°±æ˜¯å‘Šè¯‰MyBatisï¼š"è¿™ä¸ªæŸ¥è¯¢æ–¹æ³•çš„SQLä¸æ˜¯å›ºå®šçš„ï¼Œå»æŸä¸ªç±»çš„æŸä¸ªæ–¹æ³•é‡Œ**åŠ¨æ€ç”Ÿæˆ**"ã€‚

**åŸºæœ¬ç”¨æ³•**ï¼š

```java
// Mapperæ¥å£
public interface UserMapper {
    
    /**
     * å‚æ•°è¯´æ˜ï¼š
     * type = UserSqlProvider.class  â†’ æŒ‡å®šProviderç±»æ˜¯è°
     * method = "findUserSql"        â†’ æŒ‡å®šè°ƒç”¨å“ªä¸ªæ–¹æ³•ç”ŸæˆSQL
     */
    @SelectProvider(type = UserSqlProvider.class, method = "findUserSql")
    List<User> findUsers(Map<String, Object> params);
}

// Providerç±» - ä¸“é—¨ç”ŸæˆSQLçš„å·¥å…·ç±»
public class UserSqlProvider {
    
    /**
     * è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨ï¼šæ ¹æ®å‚æ•°åŠ¨æ€ç”ŸæˆSQL
     * è¿”å›å€¼ï¼šStringç±»å‹çš„SQLè¯­å¥
     */
    public String findUserSql(Map<String, Object> params) {
        StringBuilder sql = new StringBuilder("SELECT * FROM user WHERE 1=1");
        
        // å¦‚æœä¼ äº†nameå‚æ•°ï¼Œå°±åŠ ä¸Šnameæ¡ä»¶
        if (params.containsKey("name")) {
            sql.append(" AND name = #{name}");
        }
        
        // å¦‚æœä¼ äº†ageå‚æ•°ï¼Œå°±åŠ ä¸Šageæ¡ä»¶
        if (params.containsKey("age")) {
            sql.append(" AND age > #{age}");
        }
        
        return sql.toString();
        // å¯èƒ½è¿”å›ï¼šSELECT * FROM user WHERE 1=1 AND name = #{name}
        // ä¹Ÿå¯èƒ½è¿”å›ï¼šSELECT * FROM user WHERE 1=1 AND name = #{name} AND age > #{age}
    }
}
```

**å…³é”®ç†è§£ç‚¹**ï¼š
- `type`å‚æ•° â†’ æŒ‡å®šå»å“ªä¸ªç±»æ‰¾SQL
- `method`å‚æ•° â†’ æŒ‡å®šè°ƒç”¨å“ªä¸ªæ–¹æ³•
- Provideræ–¹æ³•**å¿…é¡»è¿”å›String** â†’ è¿™ä¸ªStringå°±æ˜¯SQLè¯­å¥
- SQLä¸­çš„`#{å‚æ•°å}`ä¼šè‡ªåŠ¨æ›¿æ¢æˆå®é™…å€¼

### 2.2 @InsertProvider - åŠ¨æ€æ’å…¥


**æ¦‚å¿µè®²è§£**ï¼š
æ’å…¥æ•°æ®æ—¶ï¼Œæœ‰æ—¶å€™**ä¸æ˜¯æ‰€æœ‰å­—æ®µéƒ½è¦æ’å…¥**ï¼ˆæ¯”å¦‚æŸäº›å­—æ®µä¸ºç©ºå°±ä¸æ’ï¼‰ï¼Œç”¨`@InsertProvider`å¯ä»¥åŠ¨æ€å†³å®šæ’å…¥å“ªäº›å­—æ®µã€‚

```java
// Mapperæ¥å£
@InsertProvider(type = UserSqlProvider.class, method = "insertUserSql")
@Options(useGeneratedKeys = true, keyProperty = "id")
int insertUser(User user);

// Providerç±»
public class UserSqlProvider {
    
    public String insertUserSql(User user) {
        // åŠ¨æ€å†³å®šæ’å…¥å“ªäº›å­—æ®µ
        StringBuilder sql = new StringBuilder("INSERT INTO user");
        StringBuilder columns = new StringBuilder("(");
        StringBuilder values = new StringBuilder("VALUES (");
        
        // å¦‚æœnameä¸ä¸ºç©ºï¼Œå°±æ’å…¥name
        if (user.getName() != null) {
            columns.append("name,");
            values.append("#{name},");
        }
        
        // å¦‚æœageä¸ä¸ºç©ºï¼Œå°±æ’å…¥age
        if (user.getAge() != null) {
            columns.append("age,");
            values.append("#{age},");
        }
        
        // å»æ‰æœ€åçš„é€—å·
        columns.deleteCharAt(columns.length() - 1).append(")");
        values.deleteCharAt(values.length() - 1).append(")");
        
        sql.append(columns).append(" ").append(values);
        return sql.toString();
        // ç»“æœï¼šINSERT INTO user(name,age) VALUES (#{name},#{age})
    }
}
```

**å®é™…æ•ˆæœ**ï¼š
- ä¼ å…¥`User(name="å¼ ä¸‰", age=null)` â†’ åªæ’å…¥nameå­—æ®µ
- ä¼ å…¥`User(name="æå››", age=25)` â†’ æ’å…¥nameå’Œageå­—æ®µ

### 2.3 @UpdateProvider - åŠ¨æ€æ›´æ–°


**æ¦‚å¿µè®²è§£**ï¼š
æ›´æ–°æ•°æ®æ—¶ï¼Œç”¨æˆ·å¯èƒ½åªæ”¹äº†1ä¸ªå­—æ®µï¼Œä¹Ÿå¯èƒ½æ”¹äº†å¤šä¸ªå­—æ®µï¼Œç”¨`@UpdateProvider`å¯ä»¥**åªæ›´æ–°æœ‰å˜åŒ–çš„å­—æ®µ**ã€‚

```java
// Mapperæ¥å£
@UpdateProvider(type = UserSqlProvider.class, method = "updateUserSql")
int updateUser(User user);

// Providerç±»
public class UserSqlProvider {
    
    public String updateUserSql(User user) {
        StringBuilder sql = new StringBuilder("UPDATE user SET ");
        
        boolean hasField = false; // æ ‡è®°æ˜¯å¦æœ‰å­—æ®µéœ€è¦æ›´æ–°
        
        if (user.getName() != null) {
            sql.append("name = #{name},");
            hasField = true;
        }
        
        if (user.getAge() != null) {
            sql.append("age = #{age},");
            hasField = true;
        }
        
        if (!hasField) {
            throw new RuntimeException("è‡³å°‘è¦æ›´æ–°ä¸€ä¸ªå­—æ®µï¼");
        }
        
        // å»æ‰æœ€åçš„é€—å·ï¼ŒåŠ ä¸ŠWHEREæ¡ä»¶
        sql.deleteCharAt(sql.length() - 1);
        sql.append(" WHERE id = #{id}");
        
        return sql.toString();
        // ç»“æœï¼šUPDATE user SET name = #{name} WHERE id = #{id}
    }
}
```

**å®‰å…¨æç¤º**ï¼š
- âš ï¸ æ›´æ–°æ—¶**å¿…é¡»æœ‰WHEREæ¡ä»¶**ï¼Œå¦åˆ™ä¼šæ›´æ–°æ‰€æœ‰æ•°æ®ï¼
- âš ï¸ è‡³å°‘è¦æ›´æ–°ä¸€ä¸ªå­—æ®µï¼Œå¦åˆ™SQLæ— æ„ä¹‰

### 2.4 @DeleteProvider - åŠ¨æ€åˆ é™¤


**æ¦‚å¿µè®²è§£**ï¼š
åˆ é™¤æ“ä½œç›¸å¯¹ç®€å•ï¼Œä½†å¯ä»¥æ ¹æ®ä¸åŒæ¡ä»¶**åŠ¨æ€å†³å®šåˆ é™¤é€»è¾‘**ï¼ˆæŒ‰IDåˆ ã€æŒ‰æ¡ä»¶æ‰¹é‡åˆ ç­‰ï¼‰ã€‚

```java
// Mapperæ¥å£
@DeleteProvider(type = UserSqlProvider.class, method = "deleteUserSql")
int deleteUser(Map<String, Object> params);

// Providerç±»
public class UserSqlProvider {
    
    public String deleteUserSql(Map<String, Object> params) {
        StringBuilder sql = new StringBuilder("DELETE FROM user WHERE 1=1");
        
        // æŒ‰IDåˆ é™¤
        if (params.containsKey("id")) {
            sql.append(" AND id = #{id}");
        }
        
        // æŒ‰å¹´é¾„èŒƒå›´åˆ é™¤
        if (params.containsKey("minAge")) {
            sql.append(" AND age >= #{minAge}");
        }
        
        if (params.containsKey("maxAge")) {
            sql.append(" AND age <= #{maxAge}");
        }
        
        return sql.toString();
        // å¯èƒ½ï¼šDELETE FROM user WHERE 1=1 AND id = #{id}
        // å¯èƒ½ï¼šDELETE FROM user WHERE 1=1 AND age >= #{minAge} AND age <= #{maxAge}
    }
}
```

**å®é™…åº”ç”¨**ï¼š
- å•æ¡åˆ é™¤ï¼š`params.put("id", 1)`
- æ‰¹é‡åˆ é™¤ï¼š`params.put("minAge", 18); params.put("maxAge", 60)`

---

## 3. ğŸ› ï¸ SQLæ„å»ºå™¨æ ¸å¿ƒæŠ€æœ¯


### 3.1 SQLæ„å»ºå™¨æ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼š
åˆšæ‰æˆ‘ä»¬ç”¨`StringBuilder`æ‰‹åŠ¨æ‹¼æ¥SQLï¼Œå®¹æ˜“å‡ºé”™ã€‚MyBatisæä¾›äº†ä¸€ä¸ª**ä¸“ä¸šå·¥å…·ç±»å«SQLæ„å»ºå™¨**ï¼Œè®©æ‹¼æ¥SQLå˜å¾—æ›´**ç®€å•ã€å®‰å…¨ã€è§„èŒƒ**ã€‚

**å¯¹æ¯”ç†è§£**ï¼š

```
æ‰‹åŠ¨æ‹¼æ¥ï¼ˆå®¹æ˜“å‡ºé”™ï¼‰ï¼š
StringBuilder sql = new StringBuilder("SELECT * FROM user");
sql.append(" WHERE name = #{name}"); // ç©ºæ ¼å¿˜äº†åŠ ï¼Ÿ
sql.append("AND age > #{age}");      // ANDå‰å¿˜äº†åŠ ç©ºæ ¼ï¼

â†“ ä½¿ç”¨SQLæ„å»ºå™¨ï¼ˆå®‰å…¨è§„èŒƒï¼‰ â†“

new SQL()
    .SELECT("*")
    .FROM("user")
    .WHERE("name = #{name}")
    .WHERE("age > #{age}")
    .toString();

ç»“æœè‡ªåŠ¨æ‹¼æ¥æ­£ç¡®ï¼š
SELECT * FROM user WHERE name = #{name} AND age > #{age}
```

### 3.2 SQLæ„å»ºå™¨åŸºæœ¬ç”¨æ³•


**SELECTæŸ¥è¯¢æ„å»º**ï¼š

```java
public String findUserSql(Map<String, Object> params) {
    return new SQL() {{
        SELECT("id, name, age, email");  // æŸ¥è¯¢å­—æ®µ
        FROM("user");                     // è¡¨å
        
        // åŠ¨æ€æ·»åŠ æ¡ä»¶
        if (params.containsKey("name")) {
            WHERE("name = #{name}");
        }
        
        if (params.containsKey("age")) {
            WHERE("age > #{age}");  // å¤šä¸ªWHEREè‡ªåŠ¨ç”¨ANDè¿æ¥
        }
        
        ORDER_BY("id DESC");  // æ’åº
    }}.toString();
}
```

**INSERTæ’å…¥æ„å»º**ï¼š

```java
public String insertUserSql(User user) {
    return new SQL() {{
        INSERT_INTO("user");
        
        if (user.getName() != null) {
            VALUES("name", "#{name}");
        }
        
        if (user.getAge() != null) {
            VALUES("age", "#{age}");
        }
        
        // è‡ªåŠ¨ç”Ÿæˆï¼šINSERT INTO user (name, age) VALUES (#{name}, #{age})
    }}.toString();
}
```

**UPDATEæ›´æ–°æ„å»º**ï¼š

```java
public String updateUserSql(User user) {
    return new SQL() {{
        UPDATE("user");
        
        if (user.getName() != null) {
            SET("name = #{name}");
        }
        
        if (user.getAge() != null) {
            SET("age = #{age}");
        }
        
        WHERE("id = #{id}");  // å¿…é¡»æœ‰WHEREï¼Œé˜²æ­¢å…¨è¡¨æ›´æ–°
    }}.toString();
}
```

**DELETEåˆ é™¤æ„å»º**ï¼š

```java
public String deleteUserSql(Long id) {
    return new SQL() {{
        DELETE_FROM("user");
        WHERE("id = #{id}");
    }}.toString();
}
```

### 3.3 SQLæ„å»ºå™¨æ–¹æ³•é€ŸæŸ¥è¡¨


| æ–¹æ³•å | ä½œç”¨ | ç¤ºä¾‹ | ç”ŸæˆSQL |
|--------|------|------|---------|
| `SELECT(...)` | æŸ¥è¯¢å­—æ®µ | `SELECT("id, name")` | `SELECT id, name` |
| `FROM(...)` | æŒ‡å®šè¡¨å | `FROM("user")` | `FROM user` |
| `WHERE(...)` | æ·»åŠ æ¡ä»¶ | `WHERE("age > 18")` | `WHERE age > 18` |
| `ORDER_BY(...)` | æ’åº | `ORDER_BY("id DESC")` | `ORDER BY id DESC` |
| `INSERT_INTO(...)` | æ’å…¥è¡¨ | `INSERT_INTO("user")` | `INSERT INTO user` |
| `VALUES(...)` | æ’å…¥å€¼ | `VALUES("name", "#{name}")` | `(name) VALUES (#{name})` |
| `UPDATE(...)` | æ›´æ–°è¡¨ | `UPDATE("user")` | `UPDATE user` |
| `SET(...)` | è®¾ç½®å€¼ | `SET("age = #{age}")` | `SET age = #{age}` |
| `DELETE_FROM(...)` | åˆ é™¤è¡¨ | `DELETE_FROM("user")` | `DELETE FROM user` |
| `JOIN(...)` | å†…è¿æ¥ | `JOIN("order o ON u.id = o.user_id")` | `JOIN order o ON ...` |
| `LEFT_JOIN(...)` | å·¦è¿æ¥ | `LEFT_JOIN("address a ON u.id = a.user_id")` | `LEFT JOIN address a ON ...` |

---

## 4. ğŸ’¼ Providerç±»ç¼–å†™å®æˆ˜


### 4.1 Providerç±»çš„åŸºæœ¬ç»“æ„


**è§„èŒƒå†™æ³•**ï¼š

```java
/**
 * UserSqlProviderï¼šç”¨æˆ·è¡¨SQLæä¾›è€…
 * ä½œç”¨ï¼šä¸“é—¨ä¸ºUserMapperæä¾›åŠ¨æ€SQLè¯­å¥
 */
public class UserSqlProvider {
    
    // ================== æŸ¥è¯¢ç›¸å…³ ==================
    
    /**
     * åŠ¨æ€æŸ¥è¯¢ç”¨æˆ·
     * @param params æŸ¥è¯¢æ¡ä»¶ï¼ˆå¯èƒ½åŒ…å«nameã€ageã€emailç­‰ï¼‰
     * @return SQLè¯­å¥
     */
    public String selectUsers(Map<String, Object> params) {
        return new SQL() {{
            SELECT("*");
            FROM("user");
            
            // æ ¹æ®ä¼ å…¥å‚æ•°åŠ¨æ€æ·»åŠ æ¡ä»¶
            if (params.containsKey("name")) {
                WHERE("name LIKE CONCAT('%', #{name}, '%')");
            }
            
            if (params.containsKey("minAge")) {
                WHERE("age >= #{minAge}");
            }
            
            if (params.containsKey("maxAge")) {
                WHERE("age <= #{maxAge}");
            }
        }}.toString();
    }
    
    // ================== æ’å…¥ç›¸å…³ ==================
    
    public String insertUser(User user) {
        return new SQL() {{
            INSERT_INTO("user");
            
            // åªæ’å…¥éç©ºå­—æ®µ
            if (user.getName() != null) VALUES("name", "#{name}");
            if (user.getAge() != null) VALUES("age", "#{age}");
            if (user.getEmail() != null) VALUES("email", "#{email}");
        }}.toString();
    }
    
    // ================== æ›´æ–°ç›¸å…³ ==================
    
    public String updateUser(User user) {
        return new SQL() {{
            UPDATE("user");
            
            // åªæ›´æ–°éç©ºå­—æ®µ
            if (user.getName() != null) SET("name = #{name}");
            if (user.getAge() != null) SET("age = #{age}");
            if (user.getEmail() != null) SET("email = #{email}");
            
            WHERE("id = #{id}");
        }}.toString();
    }
}
```

### 4.2 Providerç±»å‘½åè§„èŒƒ


**æ¨èçš„å‘½åçº¦å®š**ï¼š

```
è¡¨å + SqlProvider

âœ… å¥½çš„å‘½åï¼š
- UserSqlProvider      â†’ ç”¨æˆ·è¡¨SQLæä¾›è€…
- OrderSqlProvider     â†’ è®¢å•è¡¨SQLæä¾›è€…
- ProductSqlProvider   â†’ å•†å“è¡¨SQLæä¾›è€…

âŒ ä¸å¥½çš„å‘½åï¼š
- UserProvider         â†’ å¤ªæ³›äº†ï¼Œä¸çŸ¥é“æä¾›ä»€ä¹ˆ
- SqlBuilder           â†’ å¤ªé€šç”¨ï¼Œä¸çŸ¥é“æ˜¯å“ªä¸ªè¡¨çš„
- UserSql              â†’ ä¸è§„èŒƒ
```

### 4.3 å¤šè¡¨å…³è”æŸ¥è¯¢å®æˆ˜


**åœºæ™¯**ï¼šæŸ¥è¯¢ç”¨æˆ·åŠå…¶è®¢å•ä¿¡æ¯

```java
public class UserOrderSqlProvider {
    
    /**
     * æŸ¥è¯¢ç”¨æˆ·åŠè®¢å•ä¿¡æ¯
     * @param params å¯èƒ½åŒ…å«ï¼šuserIdã€startDateã€endDateç­‰
     */
    public String findUserWithOrders(Map<String, Object> params) {
        return new SQL() {{
            // æŸ¥è¯¢å­—æ®µ
            SELECT("u.id as userId");
            SELECT("u.name as userName");
            SELECT("o.id as orderId");
            SELECT("o.amount as orderAmount");
            SELECT("o.create_time as orderTime");
            
            // ä¸»è¡¨
            FROM("user u");
            
            // è¿æ¥è®¢å•è¡¨
            LEFT_JOIN("orders o ON u.id = o.user_id");
            
            // åŠ¨æ€æ¡ä»¶
            if (params.containsKey("userId")) {
                WHERE("u.id = #{userId}");
            }
            
            if (params.containsKey("startDate")) {
                WHERE("o.create_time >= #{startDate}");
            }
            
            if (params.containsKey("endDate")) {
                WHERE("o.create_time <= #{endDate}");
            }
            
            ORDER_BY("o.create_time DESC");
            
        }}.toString();
    }
}
```

**ç”Ÿæˆçš„SQLæ•ˆæœ**ï¼š

```sql
SELECT 
    u.id as userId,
    u.name as userName,
    o.id as orderId,
    o.amount as orderAmount,
    o.create_time as orderTime
FROM user u
LEFT JOIN orders o ON u.id = o.user_id
WHERE u.id = ?
  AND o.create_time >= ?
  AND o.create_time <= ?
ORDER BY o.create_time DESC
```

---

## 5. ğŸ“¦ å‚æ•°ä¼ é€’ä¸å¤„ç†


### 5.1 å‚æ•°ä¼ é€’çš„ä¸‰ç§æ–¹å¼


**æ–¹å¼ä¸€ï¼šå•ä¸ªå‚æ•°**

```java
// Mapperæ¥å£
@SelectProvider(type = UserSqlProvider.class, method = "findById")
User findById(Long id);

// Providerç±»
public String findById(Long id) {
    return new SQL() {{
        SELECT("*");
        FROM("user");
        WHERE("id = #{id}");  // ç›´æ¥ç”¨#{id}
    }}.toString();
}
```

**æ–¹å¼äºŒï¼šMapå‚æ•°ï¼ˆæ¨èï¼Œçµæ´»ï¼‰**

```java
// Mapperæ¥å£
@SelectProvider(type = UserSqlProvider.class, method = "findUsers")
List<User> findUsers(Map<String, Object> params);

// ä½¿ç”¨æ—¶
Map<String, Object> params = new HashMap<>();
params.put("name", "å¼ ä¸‰");
params.put("minAge", 18);
userMapper.findUsers(params);

// Providerç±»
public String findUsers(Map<String, Object> params) {
    return new SQL() {{
        SELECT("*");
        FROM("user");
        
        if (params.containsKey("name")) {
            WHERE("name = #{name}");
        }
        if (params.containsKey("minAge")) {
            WHERE("age >= #{minAge}");
        }
    }}.toString();
}
```

**æ–¹å¼ä¸‰ï¼šå®ä½“å¯¹è±¡å‚æ•°**

```java
// Mapperæ¥å£
@InsertProvider(type = UserSqlProvider.class, method = "insertUser")
int insertUser(User user);

// Providerç±»
public String insertUser(User user) {
    return new SQL() {{
        INSERT_INTO("user");
        
        // ç›´æ¥è®¿é—®å¯¹è±¡å±æ€§
        if (user.getName() != null) {
            VALUES("name", "#{name}");  // #{name}ä¼šè‡ªåŠ¨å–user.getName()
        }
        if (user.getAge() != null) {
            VALUES("age", "#{age}");
        }
    }}.toString();
}
```

### 5.2 @Paramæ³¨è§£çš„ä½¿ç”¨


**åœºæ™¯**ï¼šå¤šä¸ªå‚æ•°æ—¶ï¼Œéœ€è¦æ˜ç¡®å‚æ•°å

```java
// Mapperæ¥å£ - ä½¿ç”¨@ParamæŒ‡å®šå‚æ•°å
@SelectProvider(type = UserSqlProvider.class, method = "findByNameAndAge")
List<User> findByNameAndAge(
    @Param("name") String userName,    // å‚æ•°åæŒ‡å®šä¸ºname
    @Param("age") Integer userAge      // å‚æ•°åæŒ‡å®šä¸ºage
);

// Providerç±» - å‚æ•°è¦å¯¹åº”
public String findByNameAndAge(
    @Param("name") String userName,
    @Param("age") Integer userAge
) {
    return new SQL() {{
        SELECT("*");
        FROM("user");
        WHERE("name = #{name}");    // ç”¨@ParamæŒ‡å®šçš„name
        WHERE("age = #{age}");      // ç”¨@ParamæŒ‡å®šçš„age
    }}.toString();
}
```

**ä¸ç”¨@Paramçš„é—®é¢˜**ï¼š

```java
// âŒ ä¸æ¨èï¼šå‚æ•°åä¸æ˜ç¡®
List<User> findByNameAndAge(String name, Integer age);

// MyBatisé»˜è®¤ä¼šç”¨param1ã€param2ä»£æ›¿
WHERE("name = #{param1}");  // ä¸ç›´è§‚ï¼
WHERE("age = #{param2}");

// âœ… æ¨èï¼šç”¨@Paramæ˜ç¡®å‚æ•°
List<User> findByNameAndAge(@Param("name") String name, @Param("age") Integer age);

WHERE("name = #{name}");   // æ¸…æ™°ï¼
WHERE("age = #{age}");
```

### 5.3 å¤æ‚å‚æ•°å¤„ç†æŠ€å·§


**åœºæ™¯ï¼šæœç´¢æ¡ä»¶å¯¹è±¡**

```java
// å®šä¹‰æŸ¥è¯¢æ¡ä»¶å¯¹è±¡
public class UserQueryDTO {
    private String name;
    private Integer minAge;
    private Integer maxAge;
    private String email;
    // getter/setter...
}

// Mapperæ¥å£
@SelectProvider(type = UserSqlProvider.class, method = "searchUsers")
List<User> searchUsers(@Param("query") UserQueryDTO query);

// Providerç±»
public String searchUsers(@Param("query") UserQueryDTO query) {
    return new SQL() {{
        SELECT("*");
        FROM("user");
        
        // é€šè¿‡query.å±æ€§è®¿é—®
        if (query.getName() != null) {
            WHERE("name LIKE CONCAT('%', #{query.name}, '%')");
        }
        
        if (query.getMinAge() != null) {
            WHERE("age >= #{query.minAge}");
        }
        
        if (query.getMaxAge() != null) {
            WHERE("age <= #{query.maxAge}");
        }
        
        if (query.getEmail() != null) {
            WHERE("email = #{query.email}");
        }
    }}.toString();
}
```

---

## 6. ğŸš€ åŠ¨æ€SQLæ„å»ºæŠ€å·§


### 6.1 æ¡ä»¶åˆ¤æ–­æœ€ä½³å®è·µ


**æŠ€å·§ä¸€ï¼šç»Ÿä¸€åˆ¤ç©ºæ–¹å¼**

```java
public String dynamicQuery(Map<String, Object> params) {
    return new SQL() {{
        SELECT("*");
        FROM("user");
        
        // âœ… æ¨èï¼šç”¨containsKeyåˆ¤æ–­
        if (params.containsKey("name") && params.get("name") != null) {
            WHERE("name = #{name}");
        }
        
        // âŒ ä¸æ¨èï¼šåªåˆ¤æ–­containsKey
        if (params.containsKey("age")) {  // ageå¯èƒ½æ˜¯nullï¼
            WHERE("age = #{age}");
        }
        
        // âœ… æ›´å¥½ï¼šå°è£…åˆ¤ç©ºæ–¹æ³•
        addCondition(params, "email", "email = #{email}");
    }}.toString();
}

// å°è£…çš„å·¥å…·æ–¹æ³•
private void addCondition(Map<String, Object> params, String key, String condition) {
    if (params.containsKey(key) && params.get(key) != null) {
        WHERE(condition);
    }
}
```

### 6.2 æ¨¡ç³ŠæŸ¥è¯¢å¤„ç†


**å¤šç§æ¨¡ç³ŠæŸ¥è¯¢æ–¹å¼**ï¼š

```java
public String fuzzySearch(String keyword) {
    return new SQL() {{
        SELECT("*");
        FROM("user");
        
        if (keyword != null && !keyword.trim().isEmpty()) {
            // æ–¹å¼1ï¼šå‰åæ¨¡ç³Š
            WHERE("name LIKE CONCAT('%', #{keyword}, '%')");
            
            // æ–¹å¼2ï¼šå‰ç¼€æ¨¡ç³Š
            // WHERE("name LIKE CONCAT(#{keyword}, '%')");
            
            // æ–¹å¼3ï¼šåç¼€æ¨¡ç³Š
            // WHERE("name LIKE CONCAT('%', #{keyword})");
        }
    }}.toString();
}
```

### 6.3 æ‰¹é‡æ“ä½œSQLæ„å»º


**æ‰¹é‡æ’å…¥**ï¼š

```java
public String batchInsert(List<User> users) {
    StringBuilder sql = new StringBuilder();
    sql.append("INSERT INTO user (name, age) VALUES ");
    
    for (int i = 0; i < users.size(); i++) {
        sql.append("(#{list[").append(i).append("].name}, ");
        sql.append("#{list[").append(i).append("].age})");
        
        if (i < users.size() - 1) {
            sql.append(", ");
        }
    }
    
    return sql.toString();
    // ç»“æœï¼šINSERT INTO user (name, age) VALUES 
    //       (#{list[0].name}, #{list[0].age}), 
    //       (#{list[1].name}, #{list[1].age}), ...
}
```

**æ‰¹é‡åˆ é™¤**ï¼š

```java
public String batchDelete(List<Long> ids) {
    return new SQL() {{
        DELETE_FROM("user");
        
        // INæŸ¥è¯¢
        StringBuilder inClause = new StringBuilder("id IN (");
        for (int i = 0; i < ids.size(); i++) {
            inClause.append("#{list[").append(i).append("]}");
            if (i < ids.size() - 1) {
                inClause.append(", ");
            }
        }
        inClause.append(")");
        
        WHERE(inClause.toString());
    }}.toString();
    // ç»“æœï¼šDELETE FROM user WHERE id IN (#{list[0]}, #{list[1]}, ...)
}
```

### 6.4 æ’åºä¸åˆ†é¡µ


**åŠ¨æ€æ’åº**ï¼š

```java
public String dynamicSort(Map<String, Object> params) {
    return new SQL() {{
        SELECT("*");
        FROM("user");
        
        // é»˜è®¤æ’åº
        String sortField = (String) params.getOrDefault("sortField", "id");
        String sortOrder = (String) params.getOrDefault("sortOrder", "ASC");
        
        // å®‰å…¨çš„æ’åºå­—æ®µç™½åå•
        List<String> allowedFields = Arrays.asList("id", "name", "age", "create_time");
        
        if (allowedFields.contains(sortField)) {
            ORDER_BY(sortField + " " + sortOrder);
        } else {
            ORDER_BY("id ASC");  // é»˜è®¤æ’åº
        }
    }}.toString();
}
```

**åˆ†é¡µæŸ¥è¯¢**ï¼š

```java
public String pageQuery(Map<String, Object> params) {
    Integer page = (Integer) params.getOrDefault("page", 1);
    Integer pageSize = (Integer) params.getOrDefault("pageSize", 10);
    
    // è®¡ç®—åç§»é‡
    int offset = (page - 1) * pageSize;
    
    return new SQL() {{
        SELECT("*");
        FROM("user");
        
        // å…¶ä»–æ¡ä»¶...
        
        ORDER_BY("id DESC");
    }}.toString() + " LIMIT " + offset + ", " + pageSize;
    
    // ç»“æœï¼šSELECT * FROM user ORDER BY id DESC LIMIT 0, 10
}
```

---

## 7. âœ… æœ€ä½³å®è·µä¸è§„èŒƒ


### 7.1 Providerç±»ç»„ç»‡è§„èŒƒ


**æŒ‰åŠŸèƒ½åˆ†ç»„**ï¼š

```java
public class UserSqlProvider {
    
    // ========== æŸ¥è¯¢ç±»æ–¹æ³• ==========
    
    public String findById(Long id) { ... }
    
    public String findByCondition(Map<String, Object> params) { ... }
    
    public String countByCondition(Map<String, Object> params) { ... }
    
    // ========== æ’å…¥ç±»æ–¹æ³• ==========
    
    public String insert(User user) { ... }
    
    public String batchInsert(List<User> users) { ... }
    
    // ========== æ›´æ–°ç±»æ–¹æ³• ==========
    
    public String update(User user) { ... }
    
    public String updateSelective(User user) { ... }
    
    // ========== åˆ é™¤ç±»æ–¹æ³• ==========
    
    public String delete(Long id) { ... }
    
    public String batchDelete(List<Long> ids) { ... }
    
    // ========== ç§æœ‰å·¥å…·æ–¹æ³• ==========
    
    private String buildWhereClause(Map<String, Object> params) { ... }
}
```

### 7.2 SQLå®‰å…¨æ³¨æ„äº‹é¡¹


**âš ï¸ é˜²æ­¢SQLæ³¨å…¥**ï¼š

```java
// âŒ å±é™©ï¼šç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥
public String dangerousQuery(String input) {
    return "SELECT * FROM user WHERE name = '" + input + "'";
    // å¦‚æœinput = "' OR '1'='1"ï¼Œä¼šå˜æˆï¼š
    // SELECT * FROM user WHERE name = '' OR '1'='1'
    // è¿™ä¼šè¿”å›æ‰€æœ‰æ•°æ®ï¼
}

// âœ… å®‰å…¨ï¼šä½¿ç”¨å ä½ç¬¦
public String safeQuery(String name) {
    return new SQL() {{
        SELECT("*");
        FROM("user");
        WHERE("name = #{name}");  // MyBatisä¼šè‡ªåŠ¨è½¬ä¹‰
    }}.toString();
}
```

**å­—æ®µç™½åå•éªŒè¯**ï¼š

```java
public String dynamicSort(String sortField) {
    // âœ… æ¨èï¼šç™½åå•éªŒè¯
    List<String> allowedFields = Arrays.asList("id", "name", "age");
    
    if (!allowedFields.contains(sortField)) {
        throw new IllegalArgumentException("éæ³•çš„æ’åºå­—æ®µï¼š" + sortField);
    }
    
    return new SQL() {{
        SELECT("*");
        FROM("user");
        ORDER_BY(sortField + " ASC");
    }}.toString();
}
```

### 7.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**é¿å…SELECT * **ï¼š

```java
// âŒ ä¸æ¨èï¼šæŸ¥è¯¢æ‰€æœ‰å­—æ®µ
SELECT("*");

// âœ… æ¨èï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
SELECT("id, name, age");  // å‡å°‘æ•°æ®ä¼ è¾“é‡
```

**åˆç†ä½¿ç”¨ç´¢å¼•å­—æ®µ**ï¼š

```java
public String optimizedQuery(String email) {
    return new SQL() {{
        SELECT("id, name, age");
        FROM("user");
        WHERE("email = #{email}");  // emailæ˜¯ç´¢å¼•å­—æ®µï¼ŒæŸ¥è¯¢å¿«
    }}.toString();
}
```

### 7.4 ä»£ç å¤ç”¨æŠ€å·§


**æå–å…¬å…±SQLç‰‡æ®µ**ï¼š

```java
public class UserSqlProvider {
    
    // å…¬å…±å­—æ®µå®šä¹‰
    private static final String BASE_COLUMNS = "id, name, age, email, create_time, update_time";
    
    // å…¬å…±æ¡ä»¶æ„å»º
    private SQL addCommonConditions(SQL sql, Map<String, Object> params) {
        if (params.containsKey("name")) {
            sql.WHERE("name = #{name}");
        }
        if (params.containsKey("minAge")) {
            sql.WHERE("age >= #{minAge}");
        }
        return sql;
    }
    
    // ä½¿ç”¨å…¬å…±æ–¹æ³•
    public String findUsers(Map<String, Object> params) {
        SQL sql = new SQL() {{
            SELECT(BASE_COLUMNS);
            FROM("user");
        }};
        
        addCommonConditions(sql, params);
        
        return sql.toString();
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…çŸ¥å¿…ä¼šçš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ¯ Provideræœ¬è´¨
- Provider = SQLè¯­å¥çš„åŠ¨æ€ç”Ÿæˆå™¨
- é€šè¿‡Javaä»£ç çµæ´»æ‹¼æ¥SQL
- è§£å†³å›ºå®šSQLæ— æ³•åº”å¯¹åŠ¨æ€æ¡ä»¶çš„é—®é¢˜

ğŸ”§ å››å¤§Provideræ³¨è§£
- @SelectProvider â†’ åŠ¨æ€æŸ¥è¯¢
- @InsertProvider â†’ åŠ¨æ€æ’å…¥
- @UpdateProvider â†’ åŠ¨æ€æ›´æ–°  
- @DeleteProvider â†’ åŠ¨æ€åˆ é™¤

ğŸ› ï¸ SQLæ„å»ºå™¨ä¼˜åŠ¿
- æ¯”æ‰‹åŠ¨æ‹¼æ¥æ›´å®‰å…¨ã€è§„èŒƒ
- è‡ªåŠ¨å¤„ç†ç©ºæ ¼ã€å…³é”®å­—
- ä»£ç å¯è¯»æ€§æ›´å¥½
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**Providerå·¥ä½œæµç¨‹**ï¼š
```
â‘  Mapperæ–¹æ³•è¢«è°ƒç”¨
â‘¡ MyBatisæ ¹æ®@Provideræ³¨è§£æ‰¾åˆ°Providerç±»
â‘¢ è°ƒç”¨æŒ‡å®šæ–¹æ³•ï¼Œä¼ å…¥å‚æ•°
â‘£ Provideræ–¹æ³•è¿”å›SQLå­—ç¬¦ä¸²
â‘¤ MyBatisæ‰§è¡ŒSQLï¼Œè¿”å›ç»“æœ
```

**ä½•æ—¶ä½¿ç”¨Provider**ï¼š
- âœ… æŸ¥è¯¢æ¡ä»¶åŠ¨æ€å˜åŒ–
- âœ… éœ€è¦æ ¹æ®ä¸šåŠ¡é€»è¾‘æ‹¼æ¥SQL
- âœ… æ‰¹é‡æ“ä½œéœ€è¦åŠ¨æ€SQL
- âŒ ç®€å•å›ºå®šæŸ¥è¯¢ï¼ˆç”¨@Selectæ›´ç®€å•ï¼‰

**å‚æ•°ä¼ é€’æœ€ä½³å®è·µ**ï¼š
- å•ä¸ªå‚æ•°ï¼šç›´æ¥ä¼ é€’
- å¤šä¸ªå‚æ•°ï¼šç”¨@Paramæˆ–Map
- å¤æ‚æ¡ä»¶ï¼šå°è£…DTOå¯¹è±¡

### 8.3 å®‰å…¨ä¸æ€§èƒ½è¦ç‚¹


**å®‰å…¨è§„èŒƒ** âš ï¸ï¼š
- å¿…é¡»ç”¨`#{}`å ä½ç¬¦ï¼Œä¸è¦ç›´æ¥æ‹¼æ¥å­—ç¬¦ä¸²
- æ’åºå­—æ®µã€è¡¨åç­‰è¦ç™½åå•éªŒè¯
- UPDATE/DELETEå¿…é¡»æœ‰WHEREæ¡ä»¶

**æ€§èƒ½ä¼˜åŒ–** ğŸš€ï¼š
- åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Œé¿å…SELECT *
- åˆ©ç”¨ç´¢å¼•å­—æ®µä½œä¸ºæŸ¥è¯¢æ¡ä»¶
- æ‰¹é‡æ“ä½œä¼˜äºå¾ªç¯å•æ¡æ“ä½œ

**ä»£ç è§„èŒƒ** ğŸ“ï¼š
- Providerç±»æŒ‰åŠŸèƒ½åˆ†ç»„æ–¹æ³•
- æå–å…¬å…±SQLç‰‡æ®µå¤ç”¨
- æ–¹æ³•å‘½åæ¸…æ™°è¡¨è¾¾æ„å›¾

### 8.4 å®æˆ˜åº”ç”¨åœºæ™¯


| åœºæ™¯ | è§£å†³æ–¹æ¡ˆ | å…³é”®ç‚¹ |
|------|---------|--------|
| **é«˜çº§æœç´¢** | Mapä¼ å‚+åŠ¨æ€WHERE | çµæ´»æ·»åŠ æœç´¢æ¡ä»¶ |
| **æ¡ä»¶å¯¼å‡º** | å¤ç”¨æŸ¥è¯¢SQL | å¯¼å‡ºå’ŒæŸ¥è¯¢ç”¨åŒä¸€é€»è¾‘ |
| **æ‰¹é‡æ“ä½œ** | å¾ªç¯æ‹¼æ¥VALUES/IN | æ³¨æ„SQLé•¿åº¦é™åˆ¶ |
| **å¤šè¡¨æŸ¥è¯¢** | JOIN+åŠ¨æ€æ¡ä»¶ | åˆç†ä½¿ç”¨LEFT_JOIN |
| **åˆ†é¡µæ’åº** | LIMIT+åŠ¨æ€ORDER BY | æ’åºå­—æ®µç™½åå•éªŒè¯ |

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ProvideråŠ¨æ€ç”ŸæˆSQLï¼Œ
æ ¹æ®å‚æ•°çµæ´»æ‹¼æ¥èµ°ã€‚
å››å¤§æ³¨è§£å„å¸èŒï¼Œ
SQLæ„å»ºå™¨æ›´å®‰å…¨ä¼˜ã€‚
å‚æ•°ä¼ é€’è¦è§„èŒƒï¼Œ
å®‰å…¨æ€§èƒ½è®°å¿ƒå¤´ï¼
```