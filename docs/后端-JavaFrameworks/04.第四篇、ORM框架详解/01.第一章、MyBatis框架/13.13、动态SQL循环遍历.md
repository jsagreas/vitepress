---
title: 13ã€åŠ¨æ€SQLå¾ªç¯éå†
---
## ğŸ“š ç›®å½•

1. [foreachå¾ªç¯è¯­å¥åŸºç¡€](#1-foreachå¾ªç¯è¯­å¥åŸºç¡€)
2. [æ ¸å¿ƒå±æ€§è¯¦è§£](#2-æ ¸å¿ƒå±æ€§è¯¦è§£)
3. [æ‰¹é‡æ“ä½œå®æˆ˜](#3-æ‰¹é‡æ“ä½œå®æˆ˜)
4. [é«˜çº§åº”ç”¨æŠ€å·§](#4-é«˜çº§åº”ç”¨æŠ€å·§)
5. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#5-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” foreachå¾ªç¯è¯­å¥åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯foreachå¾ªç¯


**é€šä¿—ç†è§£**ï¼šforeachå°±åƒæ˜¯åœ¨SQLè¯­å¥ä¸­ä½¿ç”¨"forå¾ªç¯"ï¼Œå¸®ä½ æŠŠä¸€ç»„æ•°æ®è‡ªåŠ¨æ‹¼æ¥åˆ°SQLä¸­ã€‚

```
æƒ³è±¡è¿™æ ·çš„åœºæ™¯ï¼š
ä½ è¦åˆ é™¤ç¼–å·ä¸º 1, 3, 5, 7, 9 çš„ç”¨æˆ·

ä¼ ç»Ÿæ–¹å¼ï¼ˆç¬¨åŠæ³•ï¼‰ï¼š
DELETE FROM user WHERE id=1;
DELETE FROM user WHERE id=3;
DELETE FROM user WHERE id=5;
...æ‰§è¡Œ5æ¬¡SQL

ä½¿ç”¨foreachï¼ˆèªæ˜åŠæ³•ï¼‰ï¼š
DELETE FROM user WHERE id IN (1, 3, 5, 7, 9);
åªæ‰§è¡Œ1æ¬¡SQLï¼
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ”¸ éå†é›†åˆå‚æ•°ï¼ˆListã€æ•°ç»„ã€Mapç­‰ï¼‰
- ğŸ”¸ è‡ªåŠ¨æ‹¼æ¥SQLç‰‡æ®µ
- ğŸ”¸ å‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•°
- ğŸ”¸ æé«˜æ‰¹é‡æ“ä½œæ•ˆç‡

### 1.2 åŸºæœ¬è¯­æ³•ç»“æ„


```xml
<foreach collection="é›†åˆå‚æ•°å" 
         item="å¾ªç¯å˜é‡å" 
         index="ç´¢å¼•å˜é‡å"
         open="å¼€å§‹ç¬¦å·" 
         close="ç»“æŸç¬¦å·" 
         separator="åˆ†éš”ç¬¦">
    #{item}
</foreach>
```

**è¯­æ³•æ‹†è§£**ï¼š
```
å°±åƒå†™forå¾ªç¯ï¼š
for (User user : userList) {
    // userå°±æ˜¯item
    // userListå°±æ˜¯collection
}

foreachå°±æ˜¯æŠŠè¿™ä¸ªå¾ªç¯é€»è¾‘æ”¾åˆ°SQLé‡Œæ‰§è¡Œ
```

### 1.3 å¿«é€Ÿå…¥é—¨ç¤ºä¾‹


**åœºæ™¯**ï¼šæ ¹æ®å¤šä¸ªIDæŸ¥è¯¢ç”¨æˆ·

```xml
<!-- Mapper XML -->
<select id="findUsersByIds" resultType="User">
    SELECT * FROM user 
    WHERE id IN
    <foreach collection="ids" item="id" 
             open="(" close=")" separator=",">
        #{id}
    </foreach>
</select>
```

**æ‰§è¡Œè¿‡ç¨‹**ï¼š
```
ä¼ å…¥å‚æ•°ï¼šids = [1, 3, 5]

ç¬¬1æ­¥ï¼šopen="(" â†’ ç”Ÿæˆ "("
ç¬¬2æ­¥ï¼šéå†ids
  - id=1 â†’ ç”Ÿæˆ "?"
  - separator="," â†’ ç”Ÿæˆ ","
  - id=3 â†’ ç”Ÿæˆ "?"
  - separator="," â†’ ç”Ÿæˆ ","
  - id=5 â†’ ç”Ÿæˆ "?"
ç¬¬3æ­¥ï¼šclose=")" â†’ ç”Ÿæˆ ")"

æœ€ç»ˆSQLï¼š
SELECT * FROM user WHERE id IN (?, ?, ?)
å‚æ•°ç»‘å®šï¼š[1, 3, 5]
```

---

## 2. ğŸ”§ æ ¸å¿ƒå±æ€§è¯¦è§£


### 2.1 collectionå±æ€§ - æŒ‡å®šæ•°æ®æº


**ä½œç”¨**ï¼šå‘Šè¯‰foreachè¦éå†å“ªä¸ªé›†åˆ

**ğŸ”¸ ä¼ å…¥Listé›†åˆ**
```java
// Mapperæ¥å£
List<User> findUsers(@Param("userList") List<Integer> ids);
```

```xml
<!-- XMLé…ç½® -->
<foreach collection="userList" item="id">
    #{id}
</foreach>
```

**ğŸ”¸ ä¼ å…¥æ•°ç»„**
```java
List<User> findUsers(@Param("idArray") int[] ids);
```

```xml
<foreach collection="idArray" item="id">
    #{id}
</foreach>
```

**ğŸ”¸ ä¼ å…¥Map**
```java
List<User> findUsers(@Param("paramMap") Map<String, Object> params);
```

```xml
<!-- éå†Mapçš„values -->
<foreach collection="paramMap.values()" item="value">
    #{value}
</foreach>
```

**ğŸ“Œ é‡è¦æç¤º**ï¼š
> âš ï¸ **æ³¨æ„**ï¼šcollectionçš„å€¼å¿…é¡»ä¸@Paramæ³¨è§£çš„å‚æ•°åä¸€è‡´ï¼
> 
> ä¸ä¸€è‡´ä¼šæŠ¥é”™ï¼š`BindingException: Parameter 'xxx' not found`

### 2.2 itemå±æ€§ - å½“å‰å…ƒç´ 


**ä½œç”¨**ï¼šå®šä¹‰å¾ªç¯ä¸­çš„"ä¸´æ—¶å˜é‡"ï¼Œä»£è¡¨å½“å‰éå†çš„å…ƒç´ 

```xml
<!-- ç¤ºä¾‹1ï¼šéå†ç®€å•ç±»å‹ -->
<foreach collection="ids" item="userId">
    #{userId}  <!-- userIdä»£è¡¨å½“å‰IDå€¼ -->
</foreach>

<!-- ç¤ºä¾‹2ï¼šéå†å¯¹è±¡é›†åˆ -->
<foreach collection="userList" item="user">
    #{user.id}, #{user.name}  <!-- userä»£è¡¨å½“å‰ç”¨æˆ·å¯¹è±¡ -->
</foreach>
```

**å˜é‡å‘½åå»ºè®®**ï¼š
```
List<Integer>  â†’ item="id" æˆ– item="userId"
List<String>   â†’ item="name" æˆ– item="userName"  
List<User>     â†’ item="user" æˆ– item="userObj"

èµ·ä¸ªè§åçŸ¥æ„çš„åå­—ï¼
```

### 2.3 indexå±æ€§ - ç´¢å¼•ä½ç½®


**ä½œç”¨**ï¼šè®°å½•å½“å‰å…ƒç´ çš„ä½ç½®ä¿¡æ¯

**ğŸ”¸ Listé›†åˆä¸­çš„index**
```xml
<foreach collection="list" item="user" index="i">
    <!-- indexä»0å¼€å§‹é€’å¢ï¼š0, 1, 2, 3... -->
    ç¬¬#{i}ä¸ªç”¨æˆ·ï¼š#{user.name}
</foreach>
```

**ğŸ”¸ Mapé›†åˆä¸­çš„index**
```xml
<foreach collection="map" item="value" index="key">
    <!-- indexä»£è¡¨Mapçš„key -->
    #{key} = #{value}
</foreach>
```

**å®é™…åº”ç”¨**ï¼š
```xml
<!-- æ›´æ–°æ—¶ç”Ÿæˆåºå· -->
<update id="batchUpdateWithOrder">
    UPDATE user SET 
    sort_num = CASE id
    <foreach collection="userList" item="user" index="idx">
        WHEN #{user.id} THEN #{idx}
    </foreach>
    END
</update>
```

### 2.4 open/closeå±æ€§ - åŒ…è£¹ç¬¦å·


**ä½œç”¨**ï¼šåœ¨æ‹¼æ¥ç»“æœçš„å¼€å¤´å’Œç»“å°¾æ·»åŠ ç¬¦å·

**å¸¸è§ç”¨æ³•**ï¼š

| åœºæ™¯ | open | close | ç¤ºä¾‹SQL |
|------|------|-------|---------|
| **INæ¡ä»¶** | `"("` | `")"` | `WHERE id IN (1,2,3)` |
| **VALUESè¯­å¥** | `"("` | `")"` | `VALUES (1,'å¼ ä¸‰')` |
| **æ‰¹é‡æ’å…¥** | `""` | `""` | `(1,'a'),(2,'b')` |

```xml
<!-- INæ¡ä»¶ç¤ºä¾‹ -->
<foreach collection="ids" item="id" 
         open="(" close=")" separator=",">
    #{id}
</foreach>
<!-- ç”Ÿæˆï¼š(1, 2, 3) -->

<!-- æ‰¹é‡æ’å…¥ç¤ºä¾‹ -->
<foreach collection="users" item="user" 
         open="" close="" separator=",">
    (#{user.id}, #{user.name})
</foreach>
<!-- ç”Ÿæˆï¼š(1,'å¼ ä¸‰'), (2,'æå››'), (3,'ç‹äº”') -->
```

### 2.5 separatorå±æ€§ - åˆ†éš”ç¬¦


**ä½œç”¨**ï¼šåœ¨æ¯ä¸¤ä¸ªå…ƒç´ ä¹‹é—´æ·»åŠ åˆ†éš”ç¬¦

**å¸¸ç”¨åˆ†éš”ç¬¦**ï¼š

```xml
<!-- é€—å·åˆ†éš”ï¼ˆæœ€å¸¸ç”¨ï¼‰ -->
<foreach separator=",">
<!-- ç”Ÿæˆï¼š1, 2, 3 -->

<!-- ORåˆ†éš” -->
<foreach separator="OR">
<!-- ç”Ÿæˆï¼šid=1 OR id=2 OR id=3 -->

<!-- ANDåˆ†éš” -->
<foreach separator="AND">
<!-- ç”Ÿæˆï¼šname='å¼ ä¸‰' AND name='æå››' -->
```

**æ™ºèƒ½å¤„ç†**ï¼š
```
MyBatisä¼šè‡ªåŠ¨å¤„ç†é¦–å°¾çš„åˆ†éš”ç¬¦é—®é¢˜

ä¾‹å¦‚ï¼šseparator=","
ä¸ä¼šç”Ÿæˆï¼š,1,2,3,
è€Œæ˜¯ç”Ÿæˆï¼š1,2,3

ä¸ç”¨æ‹…å¿ƒå¤šä½™çš„é€—å·ï¼
```

---

## 3. ğŸš€ æ‰¹é‡æ“ä½œå®æˆ˜


### 3.1 æ‰¹é‡æ’å…¥ä¼˜åŒ–


**åœºæ™¯**ï¼šä¸€æ¬¡æ€§æ’å…¥1000æ¡ç”¨æˆ·æ•°æ®

**âŒ ä½æ•ˆå†™æ³•**ï¼š
```java
// å¾ªç¯æ’å…¥ï¼Œæ‰§è¡Œ1000æ¬¡SQL
for (User user : userList) {
    userMapper.insert(user);  // æ¯æ¬¡éƒ½è¿æ¥æ•°æ®åº“
}
```

**âœ… é«˜æ•ˆå†™æ³•**ï¼š
```xml
<insert id="batchInsert">
    INSERT INTO user (id, name, age, email) VALUES
    <foreach collection="userList" item="user" separator=",">
        (#{user.id}, #{user.name}, #{user.age}, #{user.email})
    </foreach>
</insert>
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
```
æ•°æ®é‡ï¼š1000æ¡
âŒ å¾ªç¯æ’å…¥ï¼š~10ç§’ï¼ˆ1000æ¬¡ç½‘ç»œå¾€è¿”ï¼‰
âœ… æ‰¹é‡æ’å…¥ï¼š~0.5ç§’ï¼ˆ1æ¬¡ç½‘ç»œå¾€è¿”ï¼‰

æ€§èƒ½æå‡ï¼š20å€ï¼
```

**è¿›é˜¶ä¼˜åŒ–**ï¼šåˆ†æ‰¹å¤„ç†å¤§é‡æ•°æ®
```java
// æ¯1000æ¡ä¸€æ‰¹ï¼Œé¿å…SQLè¿‡é•¿
List<User> allUsers = ...; // 10ä¸‡æ¡æ•°æ®
int batchSize = 1000;

for (int i = 0; i < allUsers.size(); i += batchSize) {
    List<User> batch = allUsers.subList(
        i, Math.min(i + batchSize, allUsers.size())
    );
    userMapper.batchInsert(batch);
}
```

### 3.2 æ‰¹é‡æ›´æ–°ä¼˜åŒ–


**åœºæ™¯**ï¼šä¿®æ”¹å¤šä¸ªç”¨æˆ·çš„çŠ¶æ€

**æ–¹æ¡ˆ1ï¼šCASE WHENæ–¹å¼**
```xml
<update id="batchUpdate">
    UPDATE user SET
    status = CASE id
    <foreach collection="userList" item="user">
        WHEN #{user.id} THEN #{user.status}
    </foreach>
    END,
    update_time = NOW()
    WHERE id IN
    <foreach collection="userList" item="user" 
             open="(" close=")" separator=",">
        #{user.id}
    </foreach>
</update>
```

**æ‰§è¡Œæµç¨‹**ï¼š
```
ä¼ å…¥æ•°æ®ï¼š
userList = [
    {id:1, status:1},
    {id:2, status:2},
    {id:3, status:1}
]

ç”ŸæˆSQLï¼š
UPDATE user SET
status = CASE id
    WHEN 1 THEN 1
    WHEN 2 THEN 2  
    WHEN 3 THEN 1
END,
update_time = NOW()
WHERE id IN (1, 2, 3)

ä¸€æ¬¡SQLæ›´æ–°3æ¡è®°å½•ï¼
```

**æ–¹æ¡ˆ2ï¼šå¤šå­—æ®µæ›´æ–°**
```xml
<update id="batchUpdateMultiField">
    UPDATE user SET
    <trim suffixOverrides=",">
        name = CASE id
        <foreach collection="list" item="user">
            WHEN #{user.id} THEN #{user.name}
        </foreach>
        END,
        age = CASE id
        <foreach collection="list" item="user">
            WHEN #{user.id} THEN #{user.age}
        </foreach>
        END,
    </trim>
    WHERE id IN
    <foreach collection="list" item="user" 
             open="(" close=")" separator=",">
        #{user.id}
    </foreach>
</update>
```

### 3.3 æ‰¹é‡åˆ é™¤ä¼˜åŒ–


**æ–¹æ¡ˆ1ï¼šINæ¡ä»¶åˆ é™¤**
```xml
<delete id="batchDeleteByIds">
    DELETE FROM user WHERE id IN
    <foreach collection="ids" item="id" 
             open="(" close=")" separator=",">
        #{id}
    </foreach>
</delete>
```

**æ–¹æ¡ˆ2ï¼šORæ¡ä»¶åˆ é™¤**
```xml
<delete id="batchDeleteByCondition">
    DELETE FROM user WHERE
    <foreach collection="conditions" item="cond" separator="OR">
        (name = #{cond.name} AND age = #{cond.age})
    </foreach>
</delete>
```

**å®‰å…¨æ£€æŸ¥**ï¼š
```xml
<delete id="safeDelete">
    DELETE FROM user WHERE
    <if test="ids != null and ids.size() > 0">
        id IN
        <foreach collection="ids" item="id" 
                 open="(" close=")" separator=",">
            #{id}
        </foreach>
    </if>
    <if test="ids == null or ids.size() == 0">
        1 = 2  <!-- é˜²æ­¢è¯¯åˆ å…¨è¡¨ -->
    </if>
</delete>
```

### 3.4 INæ¡ä»¶æ„å»º


**åŸºç¡€INæŸ¥è¯¢**
```xml
<select id="findByIds" resultType="User">
    SELECT * FROM user 
    WHERE id IN
    <foreach collection="ids" item="id" 
             open="(" close=")" separator=",">
        #{id}
    </foreach>
</select>
```

**å¤æ‚INæŸ¥è¯¢**
```xml
<select id="findByMultiCondition" resultType="User">
    SELECT * FROM user WHERE
    (name, age) IN
    <foreach collection="conditions" item="cond" 
             open="(" close=")" separator=",">
        (#{cond.name}, #{cond.age})
    </foreach>
</select>
```

**NOT INæŸ¥è¯¢**
```xml
<select id="findExcludeIds" resultType="User">
    SELECT * FROM user 
    WHERE id NOT IN
    <foreach collection="excludeIds" item="id" 
             open="(" close=")" separator=",">
        #{id}
    </foreach>
</select>
```

---

## 4. ğŸ’¡ é«˜çº§åº”ç”¨æŠ€å·§


### 4.1 åŠ¨æ€VALUESæ„å»º


**çµæ´»æ’å…¥ä¸åŒå­—æ®µ**
```xml
<insert id="dynamicInsert">
    INSERT INTO user
    <trim prefix="(" suffix=")" suffixOverrides=",">
        <if test="id != null">id,</if>
        <if test="name != null">name,</if>
        <if test="age != null">age,</if>
    </trim>
    VALUES
    <trim prefix="(" suffix=")" suffixOverrides=",">
        <if test="id != null">#{id},</if>
        <if test="name != null">#{name},</if>
        <if test="age != null">#{age},</if>
    </trim>
</insert>
```

**æ‰¹é‡åŠ¨æ€æ’å…¥**
```xml
<insert id="batchDynamicInsert">
    INSERT INTO user (name, age) VALUES
    <foreach collection="list" item="user" separator=",">
        <trim prefix="(" suffix=")" suffixOverrides=",">
            #{user.name},
            <if test="user.age != null">#{user.age}</if>
            <if test="user.age == null">18</if>
        </trim>
    </foreach>
</insert>
```

### 4.2 åµŒå¥—foreachå¤„ç†


**åœºæ™¯**ï¼šæ‰¹é‡æ’å…¥ç”¨æˆ·åŠå…¶è§’è‰²å…³ç³»

```xml
<insert id="batchInsertUserRoles">
    INSERT INTO user_role (user_id, role_id) VALUES
    <foreach collection="userRoleMap" item="roleIds" index="userId" separator=",">
        <!-- å¤–å±‚ï¼šéå†ç”¨æˆ· -->
        <foreach collection="roleIds" item="roleId" separator=",">
            <!-- å†…å±‚ï¼šéå†è¯¥ç”¨æˆ·çš„è§’è‰² -->
            (#{userId}, #{roleId})
        </foreach>
    </foreach>
</insert>
```

**æ‰§è¡Œç¤ºä¾‹**ï¼š
```
è¾“å…¥æ•°æ®ï¼š
userRoleMap = {
    1: [10, 20],      // ç”¨æˆ·1æœ‰è§’è‰²10å’Œ20
    2: [10, 30],      // ç”¨æˆ·2æœ‰è§’è‰²10å’Œ30
    3: [20, 30, 40]   // ç”¨æˆ·3æœ‰è§’è‰²20ã€30å’Œ40
}

ç”ŸæˆSQLï¼š
INSERT INTO user_role (user_id, role_id) VALUES
(1, 10), (1, 20),
(2, 10), (2, 30),
(3, 20), (3, 30), (3, 40)
```

### 4.3 ç»“åˆå…¶ä»–åŠ¨æ€æ ‡ç­¾


**foreach + ifç»„åˆ**
```xml
<select id="dynamicSearch" resultType="User">
    SELECT * FROM user
    <where>
        <if test="ids != null and ids.size() > 0">
            AND id IN
            <foreach collection="ids" item="id" 
                     open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        <if test="names != null and names.size() > 0">
            AND name IN
            <foreach collection="names" item="name" 
                     open="(" close=")" separator=",">
                #{name}
            </foreach>
        </if>
    </where>
</select>
```

**foreach + trimç»„åˆ**
```xml
<update id="batchUpdateSelective">
    <foreach collection="list" item="user" separator=";">
        UPDATE user
        <set>
            <if test="user.name != null">name = #{user.name},</if>
            <if test="user.age != null">age = #{user.age},</if>
        </set>
        WHERE id = #{user.id}
    </foreach>
</update>
```

---

## 5. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 5.1 æ§åˆ¶æ‰¹é‡å¤§å°


**é—®é¢˜**ï¼šä¸€æ¬¡æ’å…¥å¤ªå¤šæ•°æ®ä¼šå¯¼è‡´SQLè¿‡é•¿

```java
// âŒ é”™è¯¯ï¼šä¸€æ¬¡æ’å…¥10ä¸‡æ¡
List<User> users = ...; // 10ä¸‡æ¡
userMapper.batchInsert(users);  
// å¯èƒ½å¯¼è‡´ï¼šMySQL packetè¿‡å¤§ã€å†…å­˜æº¢å‡º

// âœ… æ­£ç¡®ï¼šåˆ†æ‰¹å¤„ç†
int batchSize = 1000;  // æ¯æ‰¹1000æ¡
for (int i = 0; i < users.size(); i += batchSize) {
    List<User> batch = users.subList(
        i, Math.min(i + batchSize, users.size())
    );
    userMapper.batchInsert(batch);
}
```

**æ¨èæ‰¹é‡å¤§å°**ï¼š
```
æ’å…¥æ“ä½œï¼š500-1000æ¡/æ‰¹
æ›´æ–°æ“ä½œï¼š100-500æ¡/æ‰¹
åˆ é™¤æ“ä½œï¼š1000-2000æ¡/æ‰¹

æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼
```

### 5.2 ä½¿ç”¨rewriteBatchedStatements


**JDBC URLé…ç½®**ï¼š
```properties
# application.properties
spring.datasource.url=jdbc:mysql://localhost:3306/db?rewriteBatchedStatements=true
```

**åŸç†è¯´æ˜**ï¼š
```
æœªå¼€å¯ï¼š
INSERT INTO user VALUES (1,'a');
INSERT INTO user VALUES (2,'b');
INSERT INTO user VALUES (3,'c');
â†’ å‘é€3æ¬¡è¯·æ±‚

å¼€å¯åï¼š
INSERT INTO user VALUES (1,'a'),(2,'b'),(3,'c');
â†’ å‘é€1æ¬¡è¯·æ±‚

æ€§èƒ½æå‡ï¼š3-10å€ï¼
```

### 5.3 ç´¢å¼•ä¼˜åŒ–å»ºè®®


**æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–**ï¼š
```sql
-- INæ¡ä»¶æŸ¥è¯¢ï¼Œéœ€è¦åœ¨æŸ¥è¯¢å­—æ®µä¸Šå»ºç´¢å¼•
CREATE INDEX idx_user_id ON user(id);

-- å¤šå­—æ®µINæŸ¥è¯¢ï¼Œéœ€è¦å¤åˆç´¢å¼•
CREATE INDEX idx_name_age ON user(name, age);
```

**æ‰¹é‡æ›´æ–°ä¼˜åŒ–**ï¼š
```sql
-- WHEREæ¡ä»¶å­—æ®µå»ºç´¢å¼•
CREATE INDEX idx_user_id ON user(id);

-- é¢‘ç¹æ›´æ–°çš„å­—æ®µä¸å»ºè®®å»ºç´¢å¼•ï¼ˆé™ä½æ›´æ–°æ€§èƒ½ï¼‰
```

### 5.4 é¿å…å¸¸è§é™·é˜±


**é™·é˜±1ï¼šINæ¡ä»¶æ•°é‡é™åˆ¶**
```
MySQL INæ¡ä»¶å»ºè®®ä¸è¶…è¿‡1000ä¸ª
è¶…è¿‡å»ºè®®æ‹†åˆ†ï¼š
WHERE id IN (1-1000)
OR id IN (1001-2000)
...
```

**é™·é˜±2ï¼šç©ºé›†åˆå¤„ç†**
```xml
<!-- âŒ å±é™©ï¼šç©ºé›†åˆä¼šç”ŸæˆWHERE id IN () -->
<select id="find">
    SELECT * FROM user WHERE id IN
    <foreach collection="ids" ...>
    </foreach>
</select>

<!-- âœ… å®‰å…¨ï¼šå…ˆåˆ¤æ–­é›†åˆæ˜¯å¦ä¸ºç©º -->
<select id="find">
    SELECT * FROM user
    <where>
        <if test="ids != null and ids.size() > 0">
            id IN
            <foreach collection="ids" ...>
            </foreach>
        </if>
    </where>
</select>
```

**é™·é˜±3ï¼šäº‹åŠ¡å¤„ç†**
```java
// å¤§æ‰¹é‡æ“ä½œå»ºè®®å¼€å¯äº‹åŠ¡
@Transactional
public void batchProcess(List<User> users) {
    int batchSize = 1000;
    for (int i = 0; i < users.size(); i += batchSize) {
        List<User> batch = users.subList(...);
        userMapper.batchInsert(batch);
    }
    // ç»Ÿä¸€æäº¤ï¼Œå¤±è´¥ç»Ÿä¸€å›æ»š
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ foreachæœ¬è´¨ï¼šåœ¨SQLä¸­å®ç°å¾ªç¯éå†é›†åˆ
ğŸ”¸ æ ¸å¿ƒå±æ€§ï¼šcollectionã€itemã€indexã€openã€closeã€separator
ğŸ”¸ ä¸»è¦ç”¨é€”ï¼šæ‰¹é‡æ’å…¥ã€æ‰¹é‡æ›´æ–°ã€æ‰¹é‡åˆ é™¤ã€INæ¡ä»¶
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šåˆ†æ‰¹å¤„ç†ã€rewriteBatchedStatementsã€ç´¢å¼•ä¼˜åŒ–
ğŸ”¸ å®‰å…¨é˜²æŠ¤ï¼šç©ºé›†åˆæ£€æŸ¥ã€æ•°é‡é™åˆ¶ã€äº‹åŠ¡æ§åˆ¶
```

### 6.2 å±æ€§ä½¿ç”¨é€Ÿè®°è¡¨


| å±æ€§ | ä½œç”¨ | å¿…å¡« | å¸¸ç”¨å€¼ |
|------|------|------|--------|
| **collection** | æŒ‡å®šé›†åˆ | âœ…æ˜¯ | `list`ã€`array`ã€è‡ªå®šä¹‰å |
| **item** | å½“å‰å…ƒç´  | âœ…æ˜¯ | `id`ã€`user`ã€`item` |
| **index** | ç´¢å¼•/key | âŒå¦ | `i`ã€`idx`ã€`key` |
| **open** | å¼€å§‹ç¬¦å· | âŒå¦ | `"("`ã€`""` |
| **close** | ç»“æŸç¬¦å· | âŒå¦ | `")"`ã€`""` |
| **separator** | åˆ†éš”ç¬¦ | âŒå¦ | `","`ã€`" OR "`ã€`" AND "` |

### 6.3 å…¸å‹åº”ç”¨åœºæ™¯æ¨¡æ¿


**INæ¡ä»¶æŸ¥è¯¢**
```xml
WHERE id IN
<foreach collection="ids" item="id" 
         open="(" close=")" separator=",">
    #{id}
</foreach>
```

**æ‰¹é‡æ’å…¥**
```xml
INSERT INTO user (name, age) VALUES
<foreach collection="list" item="user" separator=",">
    (#{user.name}, #{user.age})
</foreach>
```

**æ‰¹é‡æ›´æ–°**
```xml
UPDATE user SET status = CASE id
<foreach collection="list" item="user">
    WHEN #{user.id} THEN #{user.status}
</foreach>
END
WHERE id IN
<foreach collection="list" item="user" 
         open="(" close=")" separator=",">
    #{user.id}
</foreach>
```

**æ‰¹é‡åˆ é™¤**
```xml
DELETE FROM user WHERE id IN
<foreach collection="ids" item="id" 
         open="(" close=")" separator=",">
    #{id}
</foreach>
```

### 6.4 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•


**âœ… å¼€å‘é˜¶æ®µ**
- [ ] åˆç†è®¾ç½®æ‰¹é‡å¤§å°ï¼ˆ500-2000æ¡ï¼‰
- [ ] å¯ç”¨rewriteBatchedStatementså‚æ•°
- [ ] ç›¸å…³å­—æ®µå»ºç«‹ç´¢å¼•
- [ ] åšå¥½ç©ºé›†åˆåˆ¤æ–­

**âœ… æµ‹è¯•é˜¶æ®µ**
- [ ] æµ‹è¯•è¾¹ç•Œæƒ…å†µï¼ˆç©ºé›†åˆã€å•æ¡ã€å¤§æ‰¹é‡ï¼‰
- [ ] å‹æµ‹æ€§èƒ½ç“¶é¢ˆ
- [ ] éªŒè¯äº‹åŠ¡å›æ»š

**âœ… ç”Ÿäº§é˜¶æ®µ**
- [ ] ç›‘æ§æ…¢SQLæ—¥å¿—
- [ ] æ§åˆ¶å•æ¬¡æ•°æ®é‡
- [ ] è®¾ç½®è¶…æ—¶æ—¶é—´

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
foreachéå†å¾ˆç®€å•ï¼ŒcollectionæŒ‡å®šæ•°æ®æº
itemå®šä¹‰å¾ªç¯å˜é‡ï¼Œindexè®°å½•ç´¢å¼•ä½
open closeåŒ…ä¸¤è¾¹ï¼Œseparatoræ¥åˆ†éš”
æ‰¹é‡æ“ä½œæ•ˆç‡é«˜ï¼Œåˆ†æ‰¹å¤„ç†æ›´å®‰å…¨
```