---
title: 30ã€å¤šæ•°æ®æºé…ç½®
---
## ğŸ“š ç›®å½•

1. [å¤šæ•°æ®æºåŸºç¡€æ¦‚å¿µ](#1-å¤šæ•°æ®æºåŸºç¡€æ¦‚å¿µ)
2. [å¤šæ•°æ®æºæ¶æ„è®¾è®¡](#2-å¤šæ•°æ®æºæ¶æ„è®¾è®¡)
3. [åŠ¨æ€æ•°æ®æºåˆ‡æ¢å®ç°](#3-åŠ¨æ€æ•°æ®æºåˆ‡æ¢å®ç°)
4. [è¯»å†™åˆ†ç¦»é…ç½®](#4-è¯»å†™åˆ†ç¦»é…ç½®)
5. [ä¸»ä»æ•°æ®åº“é…ç½®](#5-ä¸»ä»æ•°æ®åº“é…ç½®)
6. [åˆ†åº“åˆ†è¡¨é…ç½®](#6-åˆ†åº“åˆ†è¡¨é…ç½®)
7. [æ•°æ®æºè·¯ç”±ç­–ç•¥](#7-æ•°æ®æºè·¯ç”±ç­–ç•¥)
8. [äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯](#8-äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯)
9. [æ•…éšœè½¬ç§»æœºåˆ¶](#9-æ•…éšœè½¬ç§»æœºåˆ¶)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å¤šæ•°æ®æºåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¤šæ•°æ®æº


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> å°±åƒä½ å®¶é‡Œå¯èƒ½æœ‰å¤šä¸ªæ°´é¾™å¤´ï¼šå¨æˆ¿çš„ã€å«ç”Ÿé—´çš„ã€é˜³å°çš„ã€‚æ¯ä¸ªæ°´é¾™å¤´è¿æ¥çš„æ°´æºå¯èƒ½ä¸åŒï¼ˆè‡ªæ¥æ°´ã€å‡€åŒ–æ°´ã€ä¸­æ°´ï¼‰ï¼Œä½ éœ€è¦æ ¹æ®ç”¨é€”é€‰æ‹©åˆé€‚çš„æ°´é¾™å¤´ã€‚å¤šæ•°æ®æºå°±æ˜¯è¿™ä¸ªé“ç†â€”â€”ä¸€ä¸ªåº”ç”¨éœ€è¦è¿æ¥å¤šä¸ªæ•°æ®åº“ï¼Œæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ•°æ®åº“ã€‚

**ğŸ“ æ ¸å¿ƒå®šä¹‰**
```
å¤šæ•°æ®æºï¼ˆMultiple DataSourceï¼‰ï¼š
â€¢ ä¸€ä¸ªåº”ç”¨ç³»ç»ŸåŒæ—¶è¿æ¥å’Œæ“ä½œå¤šä¸ªæ•°æ®åº“
â€¢ æ¯ä¸ªæ•°æ®åº“å¯èƒ½å­˜å‚¨ä¸åŒç±»å‹çš„æ•°æ®
â€¢ æ ¹æ®ä¸šåŠ¡é€»è¾‘åŠ¨æ€é€‰æ‹©ä½¿ç”¨å“ªä¸ªæ•°æ®åº“
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å¤šæ•°æ®æº


**ğŸ¤” å®é™…ä¸šåŠ¡åœºæ™¯**

| åœºæ™¯ç±»å‹ | **ä¸šåŠ¡éœ€æ±‚** | **è§£å†³æ–¹æ¡ˆ** |
|---------|-------------|-------------|
| ğŸ“Š **è¯»å†™åˆ†ç¦»** | å†™æ“ä½œå‹åŠ›å¤§ï¼Œè¯»æ“ä½œæ›´é¢‘ç¹ | ä¸»åº“å†™å…¥ï¼Œä»åº“è¯»å–ï¼Œæå‡æ€§èƒ½ |
| ğŸ¢ **ä¸šåŠ¡éš”ç¦»** | è®¢å•ç³»ç»Ÿã€ç”¨æˆ·ç³»ç»Ÿã€å•†å“ç³»ç»Ÿ | ä¸åŒä¸šåŠ¡ä½¿ç”¨ä¸åŒæ•°æ®åº“ |
| ğŸŒ **è·¨åœ°åŸŸéƒ¨ç½²** | åŒ—äº¬æœºæˆ¿ã€ä¸Šæµ·æœºæˆ¿ã€å¹¿å·æœºæˆ¿ | æ¯ä¸ªåœ°åŸŸç‹¬ç«‹æ•°æ®åº“ |
| ğŸ“ˆ **å†å²æ•°æ®å½’æ¡£** | å½“å‰æ•°æ®ã€å†å²æ•°æ®åˆ†å¼€å­˜å‚¨ | çƒ­æ•°æ®åº“ + å†·æ•°æ®åº“ |
| ğŸ”„ **æ•°æ®åº“è¿ç§»** | ä»MySQLè¿ç§»åˆ°PostgreSQL | åŒå†™è¿‡æ¸¡ï¼Œé€æ­¥è¿ç§» |

**ğŸ’¡ å…³é”®ç†è§£**
```
å•æ•°æ®æºçš„é—®é¢˜ï¼š
âŒ æ‰€æœ‰ä¸šåŠ¡æŒ¤åœ¨ä¸€ä¸ªæ•°æ®åº“ â†’ æ€§èƒ½ç“¶é¢ˆ
âŒ æ•°æ®åº“æ•…éšœå…¨ç³»ç»Ÿç˜«ç—ª â†’ é£é™©é›†ä¸­
âŒ ä¸åŒä¸šåŠ¡äº’ç›¸å½±å“ â†’ èµ„æºç«äº‰

å¤šæ•°æ®æºçš„ä¼˜åŠ¿ï¼š
âœ… è´Ÿè½½åˆ†æ•£ â†’ æ€§èƒ½æå‡
âœ… æ•…éšœéš”ç¦» â†’ é£é™©é™ä½
âœ… ä¸šåŠ¡è§£è€¦ â†’ ç»´æŠ¤æ–¹ä¾¿
```

### 1.3 å¤šæ•°æ®æºçš„åŸºæœ¬ç±»å‹


**ğŸ“‹ ä¸‰å¤§æ ¸å¿ƒç±»å‹**

```
ç±»å‹ä¸€ï¼šè¯»å†™åˆ†ç¦»å‹
åº”ç”¨ â”€â”€å†™æ“ä½œâ”€â”€â†’ ä¸»æ•°æ®åº“ï¼ˆMasterï¼‰
    â”€â”€è¯»æ“ä½œâ”€â”€â†’ ä»æ•°æ®åº“ï¼ˆSlave1ã€Slave2...ï¼‰
ç”¨é€”ï¼šæå‡è¯»å–æ€§èƒ½ï¼Œé™ä½ä¸»åº“å‹åŠ›

ç±»å‹äºŒï¼šä¸šåŠ¡åˆ†åº“å‹  
åº”ç”¨ â”€â”€ç”¨æˆ·ä¸šåŠ¡â”€â”€â†’ ç”¨æˆ·æ•°æ®åº“
    â”€â”€è®¢å•ä¸šåŠ¡â”€â”€â†’ è®¢å•æ•°æ®åº“
    â”€â”€å•†å“ä¸šåŠ¡â”€â”€â†’ å•†å“æ•°æ®åº“
ç”¨é€”ï¼šä¸šåŠ¡éš”ç¦»ï¼Œæ•°æ®åˆ†ç¦»

ç±»å‹ä¸‰ï¼šåˆ†ç‰‡åˆ†åº“å‹
åº”ç”¨ â”€â”€IDèŒƒå›´0-1000â”€â”€â†’ DB1
    â”€â”€IDèŒƒå›´1001-2000â”€â”€â†’ DB2
    â”€â”€IDèŒƒå›´2001-3000â”€â”€â†’ DB3
ç”¨é€”ï¼šæµ·é‡æ•°æ®åˆ†æ•£å­˜å‚¨
```

---

## 2. ğŸ—ï¸ å¤šæ•°æ®æºæ¶æ„è®¾è®¡


### 2.1 å¤šæ•°æ®æºæ¶æ„å›¾


**ğŸ¨ æ•´ä½“æ¶æ„**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åº”ç”¨å±‚ (Application)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Service â”‚  â”‚  Service â”‚  â”‚  Service â”‚  â”‚
â”‚  â”‚    A     â”‚  â”‚    B     â”‚  â”‚    C     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚             â”‚             â”‚
         â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ•°æ®æºè·¯ç”±å±‚ (DataSource Router)      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    AbstractRoutingDataSource         â”‚  â”‚
â”‚  â”‚  (åŠ¨æ€æ•°æ®æºé€‰æ‹©å™¨)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚             â”‚             â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚  ä¸»åº“   â”‚   â”‚  ä»åº“1  â”‚   â”‚  ä»åº“2  â”‚
    â”‚ Master  â”‚   â”‚ Slave1 â”‚   â”‚ Slave2 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç»„ä»¶è¯´æ˜


**ğŸ”§ å…³é”®æŠ€æœ¯ç»„ä»¶**

**1ï¸âƒ£ æ•°æ®æºé…ç½®ç±»**
```
ä½œç”¨ï¼šå®šä¹‰å¤šä¸ªæ•°æ®æºçš„è¿æ¥ä¿¡æ¯
å†…å®¹ï¼š
â€¢ ä¸»æ•°æ®åº“é…ç½®ï¼ˆmasterï¼‰
â€¢ ä»æ•°æ®åº“é…ç½®ï¼ˆslave1, slave2...ï¼‰
â€¢ ä¸šåŠ¡æ•°æ®åº“é…ç½®ï¼ˆorder, user, product...ï¼‰
```

**2ï¸âƒ£ åŠ¨æ€æ•°æ®æºï¼ˆDynamicDataSourceï¼‰**
```
ä½œç”¨ï¼šè¿è¡Œæ—¶åŠ¨æ€é€‰æ‹©ä½¿ç”¨å“ªä¸ªæ•°æ®æº
åŸç†ï¼šç»§æ‰¿AbstractRoutingDataSource
æ ¸å¿ƒæ–¹æ³•ï¼šdetermineCurrentLookupKey()
è¿”å›å€¼ï¼šæ•°æ®æºçš„æ ‡è¯†key
```

**3ï¸âƒ£ æ•°æ®æºä¸Šä¸‹æ–‡ï¼ˆDataSourceContextï¼‰**
```
ä½œç”¨ï¼šå­˜å‚¨å½“å‰çº¿ç¨‹ä½¿ç”¨çš„æ•°æ®æºæ ‡è¯†
å®ç°ï¼šThreadLocalä¿è¯çº¿ç¨‹éš”ç¦»
æ–¹æ³•ï¼š
â€¢ set(String key) - è®¾ç½®æ•°æ®æº
â€¢ get() - è·å–æ•°æ®æº
â€¢ clear() - æ¸…é™¤æ•°æ®æº
```

**4ï¸âƒ£ æ•°æ®æºåˆ‡æ¢æ³¨è§£ï¼ˆ@DSï¼‰**
```
ä½œç”¨ï¼šå£°æ˜å¼æŒ‡å®šä½¿ç”¨å“ªä¸ªæ•°æ®æº
ä½ç½®ï¼šç±»ä¸Šæˆ–æ–¹æ³•ä¸Š
ä¼˜å…ˆçº§ï¼šæ–¹æ³•æ³¨è§£ > ç±»æ³¨è§£ > é»˜è®¤æ•°æ®æº
```

### 2.3 å·¥ä½œæµç¨‹è¯¦è§£


**âš™ï¸ å®Œæ•´æ‰§è¡Œæµç¨‹**
```
æ­¥éª¤1ï¼šç”¨æˆ·å‘èµ·è¯·æ±‚
   â†“
æ­¥éª¤2ï¼šè¿›å…¥Serviceæ–¹æ³•
   â†“
æ­¥éª¤3ï¼šAOPæ‹¦æˆªå™¨è¯»å–@DSæ³¨è§£
   â†“
æ­¥éª¤4ï¼šå°†æ•°æ®æºkeyå­˜å…¥ThreadLocal
   DataSourceContext.set("slave1")
   â†“
æ­¥éª¤5ï¼šæ‰§è¡ŒSQLæŸ¥è¯¢
   â†“
æ­¥éª¤6ï¼šDynamicDataSource.determineCurrentLookupKey()
   ä»ThreadLocalè·å–key = "slave1"
   â†“
æ­¥éª¤7ï¼šæ ¹æ®keyè·å–å¯¹åº”çš„DataSource
   è¿”å›slave1æ•°æ®æº
   â†“
æ­¥éª¤8ï¼šä½¿ç”¨è¯¥æ•°æ®æºæ‰§è¡ŒSQL
   â†“
æ­¥éª¤9ï¼šæ¸…ç†ThreadLocal
   DataSourceContext.clear()
```

**ğŸ” æ·±å…¥ç†è§£**
> **ä¸ºä»€ä¹ˆç”¨ThreadLocalï¼Ÿ**
> æƒ³è±¡ä¸€ä¸ªé¤å…ï¼Œæ¯ä¸ªæœåŠ¡å‘˜ï¼ˆçº¿ç¨‹ï¼‰æ‰‹é‡Œæ‹¿ç€ä¸€ä¸ªè®°äº‹æœ¬ï¼ˆThreadLocalï¼‰ã€‚è®°äº‹æœ¬ä¸Šå†™ç€"è¿™æ¡Œå®¢äººè¦å»äºŒæ¥¼ç”¨é¤"ï¼ˆæ•°æ®æºæ ‡è¯†ï¼‰ã€‚æ¯ä¸ªæœåŠ¡å‘˜åªçœ‹è‡ªå·±çš„è®°äº‹æœ¬ï¼Œäº’ä¸å¹²æ‰°ã€‚è¿™æ ·å³ä½¿åŒæ—¶æœåŠ¡å¤šæ¡Œå®¢äººï¼ˆå¤šçº¿ç¨‹ï¼‰ï¼Œä¹Ÿä¸ä¼šææ··ã€‚

---

## 3. ğŸ”„ åŠ¨æ€æ•°æ®æºåˆ‡æ¢å®ç°


### 3.1 æ ¸å¿ƒå®ç°æ­¥éª¤


**ğŸ“‹ å®ç°æ¸…å•**
- [ ] é…ç½®å¤šä¸ªæ•°æ®æº
- [ ] åˆ›å»ºåŠ¨æ€æ•°æ®æºç±»
- [ ] å®ç°æ•°æ®æºä¸Šä¸‹æ–‡
- [ ] ç¼–å†™åˆ‡æ¢æ³¨è§£
- [ ] é…ç½®AOPåˆ‡é¢

### 3.2 é…ç½®å¤šä¸ªæ•°æ®æº


**ğŸ”§ é…ç½®æ–‡ä»¶ï¼ˆapplication.ymlï¼‰**
```yaml
spring:
  datasource:
    # ä¸»æ•°æ®æºé…ç½®
    master:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/db_master
      username: root
      password: 123456
      
    # ä»æ•°æ®æºé…ç½®
    slave1:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/db_slave1
      username: root
      password: 123456
      
    slave2:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/db_slave2
      username: root
      password: 123456
```

**ğŸ’¡ å…³é”®è¯´æ˜**
- `master`ï¼šä¸»æ•°æ®æºï¼Œç”¨äºå†™æ“ä½œ
- `slave1/slave2`ï¼šä»æ•°æ®æºï¼Œç”¨äºè¯»æ“ä½œ
- æ¯ä¸ªæ•°æ®æºç‹¬ç«‹é…ç½®è¿æ¥å‚æ•°

### 3.3 åˆ›å»ºåŠ¨æ€æ•°æ®æºç±»


**ğŸ“ DynamicDataSource.java**
```java
/**
 * åŠ¨æ€æ•°æ®æº - æ ¸å¿ƒç±»
 * ä½œç”¨ï¼šæ ¹æ®ä¸Šä¸‹æ–‡åŠ¨æ€è¿”å›ä¸åŒçš„æ•°æ®æº
 */
public class DynamicDataSource extends AbstractRoutingDataSource {
    
    /**
     * å†³å®šä½¿ç”¨å“ªä¸ªæ•°æ®æº
     * è¿™ä¸ªæ–¹æ³•åœ¨æ¯æ¬¡è·å–è¿æ¥æ—¶éƒ½ä¼šè¢«è°ƒç”¨
     */
    @Override
    protected Object determineCurrentLookupKey() {
        // ä»ThreadLocalè·å–æ•°æ®æºæ ‡è¯†
        String key = DataSourceContextHolder.get();
        
        // å¦‚æœæ²¡è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤çš„master
        return key != null ? key : "master";
    }
}
```

**ğŸ¯ ç†è§£è¦ç‚¹**
```
AbstractRoutingDataSourceæ˜¯ä»€ä¹ˆï¼Ÿ
â€¢ Springæä¾›çš„æŠ½è±¡ç±»
â€¢ å†…éƒ¨ç»´æŠ¤å¤šä¸ªæ•°æ®æºçš„Map
â€¢ æ ¹æ®keyåŠ¨æ€é€‰æ‹©æ•°æ®æº

determineCurrentLookupKey()åšä»€ä¹ˆï¼Ÿ
â€¢ è¿”å›ä¸€ä¸ªkeyï¼ˆå­—ç¬¦ä¸²ï¼‰
â€¢ Springç”¨è¿™ä¸ªkeyå»Mapé‡Œæ‰¾å¯¹åº”çš„æ•°æ®æº
â€¢ æ‰¾ä¸åˆ°å°±ç”¨é»˜è®¤æ•°æ®æº
```

### 3.4 å®ç°æ•°æ®æºä¸Šä¸‹æ–‡


**ğŸ“ DataSourceContextHolder.java**
```java
/**
 * æ•°æ®æºä¸Šä¸‹æ–‡æŒæœ‰è€…
 * ä½¿ç”¨ThreadLocalä¿è¯çº¿ç¨‹å®‰å…¨
 */
public class DataSourceContextHolder {
    
    // ThreadLocalï¼šæ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹å­˜å‚¨
    private static final ThreadLocal<String> CONTEXT = new ThreadLocal<>();
    
    /**
     * è®¾ç½®æ•°æ®æº
     */
    public static void set(String key) {
        CONTEXT.set(key);
    }
    
    /**
     * è·å–æ•°æ®æº
     */
    public static String get() {
        return CONTEXT.get();
    }
    
    /**
     * æ¸…é™¤æ•°æ®æº
     * âš ï¸ éå¸¸é‡è¦ï¼ç”¨å®Œå¿…é¡»æ¸…ç†ï¼Œå¦åˆ™å†…å­˜æ³„æ¼
     */
    public static void clear() {
        CONTEXT.remove();
    }
}
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
> **ä¸ºä»€ä¹ˆå¿…é¡»æ¸…ç†ThreadLocalï¼Ÿ**
> çº¿ç¨‹æ± ä¼šå¤ç”¨çº¿ç¨‹ã€‚å¦‚æœä¸æ¸…ç†ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚å¤ç”¨è¿™ä¸ªçº¿ç¨‹æ—¶ï¼Œä¼šæ‹¿åˆ°ä¸Šä¸€ä¸ªè¯·æ±‚çš„æ•°æ®æºé…ç½®ï¼Œå¯¼è‡´æ•°æ®é”™ä¹±ï¼

### 3.5 é…ç½®æ•°æ®æºBean


**ğŸ“ DataSourceConfig.java**
```java
@Configuration
public class DataSourceConfig {
    
    /**
     * åˆ›å»ºä¸»æ•°æ®æº
     */
    @Bean
    @ConfigurationProperties(prefix = "spring.datasource.master")
    public DataSource masterDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    /**
     * åˆ›å»ºä»æ•°æ®æº1
     */
    @Bean
    @ConfigurationProperties(prefix = "spring.datasource.slave1")
    public DataSource slave1DataSource() {
        return DataSourceBuilder.create().build();
    }
    
    /**
     * åˆ›å»ºä»æ•°æ®æº2
     */
    @Bean
    @ConfigurationProperties(prefix = "spring.datasource.slave2")
    public DataSource slave2DataSource() {
        return DataSourceBuilder.create().build();
    }
    
    /**
     * é…ç½®åŠ¨æ€æ•°æ®æº
     */
    @Bean
    @Primary  // ä¸»æ•°æ®æºæ ‡è¯†
    public DataSource dynamicDataSource() {
        DynamicDataSource dynamic = new DynamicDataSource();
        
        // è®¾ç½®æ‰€æœ‰æ•°æ®æº
        Map<Object, Object> targetDataSources = new HashMap<>();
        targetDataSources.put("master", masterDataSource());
        targetDataSources.put("slave1", slave1DataSource());
        targetDataSources.put("slave2", slave2DataSource());
        
        dynamic.setTargetDataSources(targetDataSources);
        
        // è®¾ç½®é»˜è®¤æ•°æ®æº
        dynamic.setDefaultTargetDataSource(masterDataSource());
        
        return dynamic;
    }
}
```

**ğŸ” é…ç½®è¯´æ˜**
```
@Primaryçš„ä½œç”¨ï¼š
â€¢ å½“æœ‰å¤šä¸ªç›¸åŒç±»å‹çš„Beanæ—¶
â€¢ æ ‡æ³¨@Primaryçš„Beanä¼šè¢«ä¼˜å…ˆæ³¨å…¥
â€¢ è¿™é‡Œè®©åŠ¨æ€æ•°æ®æºæˆä¸ºé»˜è®¤æ•°æ®æº

targetDataSourcesï¼š
â€¢ Mapç»“æ„ï¼škeyæ˜¯æ•°æ®æºæ ‡è¯†ï¼Œvalueæ˜¯DataSourceå¯¹è±¡
â€¢ è¿™ä¸ªMapå°±æ˜¯determineCurrentLookupKey()æŸ¥æ‰¾çš„æ¥æº

defaultTargetDataSourceï¼š
â€¢ å½“æ²¡æœ‰æŒ‡å®šæ•°æ®æºæ—¶ä½¿ç”¨çš„é»˜è®¤å€¼
â€¢ é€šå¸¸è®¾ç½®ä¸ºmasterä¸»åº“
```

---

## 4. ğŸ“– è¯»å†™åˆ†ç¦»é…ç½®


### 4.1 è¯»å†™åˆ†ç¦»åŸç†


**ğŸ¯ æ ¸å¿ƒæ€æƒ³**
```
å†™æ“ä½œï¼ˆINSERT/UPDATE/DELETEï¼‰
    â†“
  ä¸»åº“ï¼ˆMasterï¼‰
    â†“
  è‡ªåŠ¨åŒæ­¥
    â†“
ä»åº“ï¼ˆSlave1ã€Slave2...ï¼‰
    â†‘
è¯»æ“ä½œï¼ˆSELECTï¼‰
```

**ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**
> å°±åƒå›¾ä¹¦é¦†ï¼šå€Ÿä¹¦ã€è¿˜ä¹¦ï¼ˆå†™æ“ä½œï¼‰å¿…é¡»å»æ€»æœåŠ¡å°ï¼ˆä¸»åº“ï¼‰ï¼Œä½†æŸ¥é˜…å›¾ä¹¦ï¼ˆè¯»æ“ä½œï¼‰å¯ä»¥å»ä»»ä½•ä¸€ä¸ªé˜…è§ˆå®¤ï¼ˆä»åº“ï¼‰ã€‚æ€»æœåŠ¡å°ä¼šå®šæœŸæŠŠæ–°ä¹¦ç›®å½•åŒæ­¥åˆ°å„ä¸ªé˜…è§ˆå®¤ã€‚

### 4.2 ä½¿ç”¨@DSæ³¨è§£å®ç°è¯»å†™åˆ†ç¦»


**ğŸ“ åˆ›å»º@DSæ³¨è§£**
```java
/**
 * æ•°æ®æºåˆ‡æ¢æ³¨è§£
 */
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
public @interface DS {
    /**
     * æ•°æ®æºåç§°
     */
    String value() default "master";
}
```

**ğŸ“ åˆ›å»ºAOPåˆ‡é¢**
```java
@Aspect
@Component
public class DataSourceAspect {
    
    /**
     * æ‹¦æˆªæ‰€æœ‰å¸¦@DSæ³¨è§£çš„æ–¹æ³•
     */
    @Around("@annotation(ds)")
    public Object around(ProceedingJoinPoint point, DS ds) throws Throwable {
        try {
            // 1. è®¾ç½®æ•°æ®æº
            String dsKey = ds.value();
            DataSourceContextHolder.set(dsKey);
            
            // 2. æ‰§è¡Œæ–¹æ³•
            return point.proceed();
            
        } finally {
            // 3. æ¸…ç†æ•°æ®æºï¼ˆéå¸¸é‡è¦ï¼ï¼‰
            DataSourceContextHolder.clear();
        }
    }
}
```

**ğŸ”§ å®é™…ä½¿ç”¨ç¤ºä¾‹**
```java
@Service
public class UserService {
    
    /**
     * æŸ¥è¯¢ç”¨æˆ· - ä½¿ç”¨ä»åº“
     */
    @DS("slave1")
    public User getUserById(Long id) {
        return userMapper.selectById(id);
    }
    
    /**
     * åˆ›å»ºç”¨æˆ· - ä½¿ç”¨ä¸»åº“
     */
    @DS("master")
    public void createUser(User user) {
        userMapper.insert(user);
    }
    
    /**
     * æ‰¹é‡æŸ¥è¯¢ - ä½¿ç”¨ä»åº“2
     */
    @DS("slave2")
    public List<User> listUsers() {
        return userMapper.selectList(null);
    }
}
```

**ğŸ“Š ä½¿ç”¨æ•ˆæœå¯¹æ¯”**

| æ“ä½œç±»å‹ | **æ•°æ®æº** | **æ€§èƒ½æå‡** | **è¯´æ˜** |
|---------|-----------|-------------|---------|
| SELECT | slave1/slave2 | â­â­â­â­â­ | è¯»è¯·æ±‚åˆ†æ•£åˆ°ä»åº“ |
| INSERT | master | â­â­â­ | å†™æ“ä½œé›†ä¸­åœ¨ä¸»åº“ |
| UPDATE | master | â­â­â­ | å†™æ“ä½œé›†ä¸­åœ¨ä¸»åº“ |
| DELETE | master | â­â­â­ | å†™æ“ä½œé›†ä¸­åœ¨ä¸»åº“ |

### 4.3 è‡ªåŠ¨è¯»å†™åˆ†ç¦»


**ğŸš€ é«˜çº§ç”¨æ³•ï¼šè‡ªåŠ¨è¯†åˆ«è¯»å†™**
```java
@Aspect
@Component
public class AutoDataSourceAspect {
    
    // å†™æ“ä½œçš„æ–¹æ³•åå‰ç¼€
    private static final String[] WRITE_PREFIX = {
        "save", "insert", "add", "update", "edit", "delete", "remove"
    };
    
    @Around("execution(* com.example.service.*.*(..))")
    public Object around(ProceedingJoinPoint point) throws Throwable {
        try {
            String methodName = point.getSignature().getName();
            
            // æ ¹æ®æ–¹æ³•åè‡ªåŠ¨åˆ¤æ–­è¯»å†™
            if (isWriteMethod(methodName)) {
                DataSourceContextHolder.set("master");
            } else {
                // è¯»æ“ä½œéšæœºé€‰æ‹©ä»åº“
                DataSourceContextHolder.set(getRandomSlave());
            }
            
            return point.proceed();
            
        } finally {
            DataSourceContextHolder.clear();
        }
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºå†™æ–¹æ³•
     */
    private boolean isWriteMethod(String methodName) {
        for (String prefix : WRITE_PREFIX) {
            if (methodName.startsWith(prefix)) {
                return true;
            }
        }
        return false;
    }
    
    /**
     * éšæœºè·å–ä»åº“
     */
    private String getRandomSlave() {
        String[] slaves = {"slave1", "slave2"};
        int index = new Random().nextInt(slaves.length);
        return slaves[index];
    }
}
```

**ğŸ’ª ä¼˜åŠ¿åˆ†æ**
```
æ‰‹åŠ¨@DSæ³¨è§£æ–¹å¼ï¼š
âœ… ç²¾ç¡®æ§åˆ¶æ¯ä¸ªæ–¹æ³•çš„æ•°æ®æº
âœ… çµæ´»æ€§é«˜
âŒ éœ€è¦åœ¨æ¯ä¸ªæ–¹æ³•ä¸ŠåŠ æ³¨è§£
âŒ ä»£ç ä¾µå…¥æ€§å¼º

è‡ªåŠ¨è¯†åˆ«æ–¹å¼ï¼š
âœ… æ— éœ€æ‰‹åŠ¨æ·»åŠ æ³¨è§£
âœ… ä»£ç ç®€æ´
âœ… æ ¹æ®æ–¹æ³•åè‡ªåŠ¨åˆ¤æ–­
âŒ çµæ´»æ€§ç¨å·®
âŒ éœ€è¦éµå¾ªå‘½åè§„èŒƒ
```

---

## 5. ğŸ”— ä¸»ä»æ•°æ®åº“é…ç½®


### 5.1 MySQLä¸»ä»å¤åˆ¶åŸç†


**ğŸ“Š ä¸»ä»å¤åˆ¶æ¶æ„**
```
ä¸»åº“ï¼ˆMasterï¼‰                ä»åº“ï¼ˆSlaveï¼‰
    â”‚                             â”‚
    â”‚  1. æ‰§è¡ŒSQLå†™å…¥             â”‚
    â”‚  2. è®°å½•binlog              â”‚
    â”‚                             â”‚
    â”œâ”€â”€â”€â”€ 3. å‘é€binlog â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚
    â”‚                             â”‚ 4. æ¥æ”¶binlog
    â”‚                             â”‚ 5. å†™å…¥relay log
    â”‚                             â”‚ 6. é‡æ”¾SQL
    â”‚                             â”‚
    â–¼                             â–¼
  ä¸»åº“æ•°æ®                      ä»åº“æ•°æ®
  (å®æ—¶)                       (ç•¥æœ‰å»¶è¿Ÿ)
```

**ğŸ” æ·±å…¥ç†è§£**
> **ä»€ä¹ˆæ˜¯binlogï¼Ÿ**
> binlogï¼ˆbinary logï¼‰æ˜¯MySQLçš„äºŒè¿›åˆ¶æ—¥å¿—ï¼Œè®°å½•äº†æ‰€æœ‰ä¿®æ”¹æ•°æ®çš„SQLè¯­å¥ã€‚å°±åƒä¸€æœ¬"æ“ä½œæ—¥è®°"ï¼Œä»åº“é€šè¿‡é‡æ”¾è¿™æœ¬æ—¥è®°æ¥åŒæ­¥æ•°æ®ã€‚

### 5.2 é…ç½®MySQLä¸»ä»å¤åˆ¶


**âš™ï¸ ä¸»åº“é…ç½®ï¼ˆmy.cnfï¼‰**
```ini
[mysqld]
# æœåŠ¡å™¨å”¯ä¸€ID
server-id = 1

# å¼€å¯binlog
log-bin = mysql-bin

# binlogæ ¼å¼ï¼ˆæ¨èROWï¼‰
binlog-format = ROW

# éœ€è¦åŒæ­¥çš„æ•°æ®åº“
binlog-do-db = db_example
```

**âš™ï¸ ä»åº“é…ç½®ï¼ˆmy.cnfï¼‰**
```ini
[mysqld]
# æœåŠ¡å™¨å”¯ä¸€IDï¼ˆä¸èƒ½å’Œä¸»åº“ç›¸åŒï¼‰
server-id = 2

# å¼€å¯ä¸­ç»§æ—¥å¿—
relay-log = mysql-relay-bin

# åªè¯»æ¨¡å¼ï¼ˆä»åº“ä¸å…è®¸å†™å…¥ï¼‰
read-only = 1
```

**ğŸ”§ å»ºç«‹ä¸»ä»å…³ç³»**
```sql
-- 1. åœ¨ä¸»åº“åˆ›å»ºå¤åˆ¶ç”¨æˆ·
CREATE USER 'repl'@'%' IDENTIFIED BY 'password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';

-- 2. æŸ¥çœ‹ä¸»åº“çŠ¶æ€
SHOW MASTER STATUS;
-- è®°å½•Fileå’ŒPositionå€¼ï¼Œä¾‹å¦‚ï¼š
-- File: mysql-bin.000001
-- Position: 154

-- 3. åœ¨ä»åº“é…ç½®ä¸»åº“ä¿¡æ¯
CHANGE MASTER TO
  MASTER_HOST='192.168.1.100',
  MASTER_USER='repl',
  MASTER_PASSWORD='password',
  MASTER_LOG_FILE='mysql-bin.000001',
  MASTER_LOG_POS=154;

-- 4. å¯åŠ¨ä»åº“å¤åˆ¶
START SLAVE;

-- 5. æŸ¥çœ‹ä»åº“çŠ¶æ€
SHOW SLAVE STATUS\G
-- é‡ç‚¹å…³æ³¨ï¼š
-- Slave_IO_Running: Yes
-- Slave_SQL_Running: Yes
```

**ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•**
- [ ] ä¸»åº“å¼€å¯binlog
- [ ] ä»åº“é…ç½®relay-log
- [ ] server-idä¸é‡å¤
- [ ] åˆ›å»ºå¤åˆ¶ç”¨æˆ·
- [ ] ä»åº“æ­£ç¡®é…ç½®ä¸»åº“ä¿¡æ¯
- [ ] Slave_IO_Runningå’ŒSlave_SQL_Runningéƒ½æ˜¯Yes

### 5.3 ä¸»ä»å»¶è¿Ÿé—®é¢˜å¤„ç†


**âš ï¸ ä¸»ä»å»¶è¿Ÿäº§ç”ŸåŸå› **
```
å¸¸è§åŸå› ï¼š
1. ç½‘ç»œå»¶è¿Ÿ â†’ ä¸»ä»ä¹‹é—´ç½‘ç»œä¸ç¨³å®š
2. ä»åº“æ€§èƒ½å·® â†’ ä»åº“é…ç½®ä½äºä¸»åº“
3. å¤§äº‹åŠ¡ â†’ ä¸»åº“æ‰§è¡Œå¤§æ‰¹é‡æ“ä½œ
4. é”å†²çª â†’ ä»åº“é‡æ”¾æ—¶é‡åˆ°é”ç­‰å¾…
```

**ğŸ”§ å»¶è¿Ÿç›‘æ§ä¸å¤„ç†**
```java
@Service
public class DataSourceMonitor {
    
    /**
     * æ£€æŸ¥ä¸»ä»å»¶è¿Ÿ
     */
    public long checkReplicationDelay() {
        // åœ¨ä»åº“æ‰§è¡Œ
        String sql = "SHOW SLAVE STATUS";
        
        // Seconds_Behind_Masterï¼šå»¶è¿Ÿç§’æ•°
        // 0ï¼šæ— å»¶è¿Ÿ
        // NULLï¼šå¤åˆ¶æœªè¿è¡Œ
        // æ•°å­—ï¼šå»¶è¿Ÿç§’æ•°
        
        Long delay = jdbcTemplate.queryForObject(sql, 
            rs -> rs.getLong("Seconds_Behind_Master"));
        
        return delay != null ? delay : -1;
    }
    
    /**
     * å»¶è¿Ÿè¿‡å¤§æ—¶åˆ‡æ¢åˆ°ä¸»åº“
     */
    public void switchIfDelayTooHigh() {
        long delay = checkReplicationDelay();
        
        if (delay > 5) {  // å»¶è¿Ÿè¶…è¿‡5ç§’
            // å¼ºåˆ¶ä½¿ç”¨ä¸»åº“
            DataSourceContextHolder.set("master");
        } else {
            // ä½¿ç”¨ä»åº“
            DataSourceContextHolder.set("slave1");
        }
    }
}
```

**ğŸ’¡ å¤„ç†ç­–ç•¥**

| å»¶è¿Ÿçº§åˆ« | **å»¶è¿Ÿæ—¶é—´** | **å¤„ç†ç­–ç•¥** |
|---------|-------------|-------------|
| ğŸŸ¢ æ­£å¸¸ | 0-1ç§’ | æ­£å¸¸ä½¿ç”¨ä»åº“ |
| ğŸŸ¡ è½»å¾® | 1-5ç§’ | éå…³é”®æŸ¥è¯¢ç”¨ä»åº“ |
| ğŸ”´ ä¸¥é‡ | >5ç§’ | åˆ‡æ¢åˆ°ä¸»åº“æŸ¥è¯¢ |

---

## 6. ğŸ“¦ åˆ†åº“åˆ†è¡¨é…ç½®


### 6.1 ä»€ä¹ˆæ˜¯åˆ†åº“åˆ†è¡¨


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> æƒ³è±¡ä¸€ä¸ªè¶…å¤§çš„å›¾ä¹¦é¦†ï¼Œä¹¦å¤ªå¤šäº†ä¸€ä¸ªé¦†æ”¾ä¸ä¸‹ã€‚æ€ä¹ˆåŠï¼Ÿ
> - **åˆ†åº“**ï¼šåœ¨ä¸åŒåŸå¸‚å»ºç«‹å¤šä¸ªå›¾ä¹¦é¦†åˆ†é¦†
> - **åˆ†è¡¨**ï¼šæ¯ä¸ªåˆ†é¦†å†…éƒ¨æŒ‰ç…§ç±»åˆ«åˆ†æˆå¤šä¸ªä¹¦æ¶

**ğŸ“ æ ¸å¿ƒæ¦‚å¿µ**
```
åˆ†åº“ï¼ˆSharding Databaseï¼‰ï¼š
â€¢ å°†æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªæ•°æ®åº“
â€¢ å‡è½»å•åº“å‹åŠ›
â€¢ ä¾‹ï¼šç”¨æˆ·åº“ã€è®¢å•åº“ã€å•†å“åº“

åˆ†è¡¨ï¼ˆSharding Tableï¼‰ï¼š
â€¢ å°†ä¸€å¼ å¤§è¡¨æ‹†åˆ†æˆå¤šå¼ å°è¡¨
â€¢ é™ä½å•è¡¨æ•°æ®é‡
â€¢ ä¾‹ï¼šuser_0, user_1, user_2...
```

### 6.2 åˆ†åº“åˆ†è¡¨ç­–ç•¥


**ğŸ¯ å¸¸è§åˆ†ç‰‡ç­–ç•¥**

**1ï¸âƒ£ èŒƒå›´åˆ†ç‰‡**
```
æ ¹æ®IDèŒƒå›´åˆ†ç‰‡ï¼š
0-100ä¸‡     â†’ db1.user_0
100ä¸‡-200ä¸‡  â†’ db2.user_1
200ä¸‡-300ä¸‡  â†’ db3.user_2

ä¼˜ç‚¹ï¼šç®€å•ç›´è§‚ï¼Œæ‰©å®¹æ–¹ä¾¿
ç¼ºç‚¹ï¼šæ•°æ®åˆ†å¸ƒå¯èƒ½ä¸å‡åŒ€
```

**2ï¸âƒ£ å“ˆå¸Œåˆ†ç‰‡**
```
æ ¹æ®IDå–æ¨¡ï¼š
user_id % 3 = 0 â†’ db1.user_0
user_id % 3 = 1 â†’ db2.user_1
user_id % 3 = 2 â†’ db3.user_2

ä¼˜ç‚¹ï¼šæ•°æ®åˆ†å¸ƒå‡åŒ€
ç¼ºç‚¹ï¼šæ‰©å®¹éœ€è¦æ•°æ®è¿ç§»
```

**3ï¸âƒ£ åœ°ç†ä½ç½®åˆ†ç‰‡**
```
æ ¹æ®åœ°åŒºåˆ†ç‰‡ï¼š
åŒ—äº¬ç”¨æˆ· â†’ db_beijing
ä¸Šæµ·ç”¨æˆ· â†’ db_shanghai
å¹¿å·ç”¨æˆ· â†’ db_guangzhou

ä¼˜ç‚¹ï¼šå°±è¿‘è®¿é—®ï¼Œæ€§èƒ½å¥½
ç¼ºç‚¹ï¼šä¸šåŠ¡è€¦åˆåº¦é«˜
```

### 6.3 ä½¿ç”¨Sharding-JDBCå®ç°åˆ†åº“åˆ†è¡¨


**ğŸ“¦ å¼•å…¥ä¾èµ–**
```xml
<dependency>
    <groupId>org.apache.shardingsphere</groupId>
    <artifactId>sharding-jdbc-spring-boot-starter</artifactId>
    <version>4.1.1</version>
</dependency>
```

**ğŸ”§ é…ç½®æ–‡ä»¶ï¼ˆapplication.ymlï¼‰**
```yaml
spring:
  shardingsphere:
    datasource:
      names: ds0,ds1,ds2
      
      # æ•°æ®æº1
      ds0:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://localhost:3306/db0
        username: root
        password: 123456
      
      # æ•°æ®æº2
      ds1:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://localhost:3306/db1
        username: root
        password: 123456
        
      # æ•°æ®æº3
      ds2:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://localhost:3306/db2
        username: root
        password: 123456
    
    sharding:
      tables:
        # ç”¨æˆ·è¡¨åˆ†ç‰‡è§„åˆ™
        t_user:
          # å®é™…èŠ‚ç‚¹
          actual-data-nodes: ds$->{0..2}.t_user_$->{0..2}
          
          # åˆ†åº“ç­–ç•¥
          database-strategy:
            inline:
              sharding-column: user_id
              algorithm-expression: ds$->{user_id % 3}
          
          # åˆ†è¡¨ç­–ç•¥
          table-strategy:
            inline:
              sharding-column: user_id
              algorithm-expression: t_user_$->{user_id % 3}
      
      # é»˜è®¤æ•°æ®æº
      default-data-source-name: ds0
    
    props:
      # æ˜¾ç¤ºSQL
      sql:
        show: true
```

**ğŸ¯ é…ç½®è¯´æ˜**
```
actual-data-nodes: ds$->{0..2}.t_user_$->{0..2}
å«ä¹‰ï¼š
â€¢ ds0.t_user_0, ds0.t_user_1, ds0.t_user_2
â€¢ ds1.t_user_0, ds1.t_user_1, ds1.t_user_2
â€¢ ds2.t_user_0, ds2.t_user_1, ds2.t_user_2
å…±9ä¸ªå®é™…è¡¨èŠ‚ç‚¹

database-strategy: ds$->{user_id % 3}
â€¢ user_id=1 â†’ 1%3=1 â†’ ds1
â€¢ user_id=5 â†’ 5%3=2 â†’ ds2
â€¢ user_id=9 â†’ 9%3=0 â†’ ds0

table-strategy: t_user_$->{user_id % 3}
â€¢ user_id=1 â†’ 1%3=1 â†’ t_user_1
â€¢ user_id=5 â†’ 5%3=2 â†’ t_user_2
â€¢ user_id=9 â†’ 9%3=0 â†’ t_user_0
```

**ğŸ“ ä»£ç ä½¿ç”¨ç¤ºä¾‹**
```java
@Service
public class UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    /**
     * æ’å…¥ç”¨æˆ· - è‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”åˆ†ç‰‡
     */
    public void saveUser(User user) {
        // user_id=10
        // åˆ†åº“ï¼š10%3=1 â†’ ds1
        // åˆ†è¡¨ï¼š10%3=1 â†’ t_user_1
        // æœ€ç»ˆï¼šæ’å…¥ ds1.t_user_1
        userMapper.insert(user);
    }
    
    /**
     * æŸ¥è¯¢ç”¨æˆ· - è‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”åˆ†ç‰‡
     */
    public User getUser(Long userId) {
        // æ ¹æ®userIdè‡ªåŠ¨è·¯ç”±åˆ°æ­£ç¡®çš„åº“è¡¨
        return userMapper.selectById(userId);
    }
}
```

**âš¡ åˆ†ç‰‡æ•ˆæœ**
```
åŸæ¥ï¼šæ‰€æœ‰æ•°æ®åœ¨ä¸€å¼ è¡¨
db.t_user (1000ä¸‡æ¡æ•°æ®) â†’ æŸ¥è¯¢æ…¢ï¼Œæ’å…¥æ…¢

ç°åœ¨ï¼šæ•°æ®åˆ†æ•£åˆ°9ä¸ªè¡¨
ds0.t_user_0 (111ä¸‡)
ds0.t_user_1 (111ä¸‡)
ds0.t_user_2 (111ä¸‡)
ds1.t_user_0 (111ä¸‡)
... å…±9ä¸ªè¡¨

å•è¡¨æ•°æ®é‡ï¼š1000ä¸‡/9 â‰ˆ 111ä¸‡
æ€§èƒ½æå‡ï¼šæŸ¥è¯¢å’Œæ’å…¥é€Ÿåº¦æå‡3-5å€
```

---

## 7. ğŸ§­ æ•°æ®æºè·¯ç”±ç­–ç•¥


### 7.1 è·¯ç”±ç­–ç•¥ç±»å‹


**ğŸ“Š å››å¤§è·¯ç”±ç­–ç•¥**

**1ï¸âƒ£ è½®è¯¢ç­–ç•¥ï¼ˆRound Robinï¼‰**
```
å·¥ä½œæ–¹å¼ï¼š
è¯·æ±‚1 â†’ slave1
è¯·æ±‚2 â†’ slave2
è¯·æ±‚3 â†’ slave1
è¯·æ±‚4 â†’ slave2
...å¾ªç¯å¾€å¤

ä¼˜ç‚¹ï¼šè´Ÿè½½å‡è¡¡ï¼Œç®€å•å…¬å¹³
ç¼ºç‚¹ï¼šä¸è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½å·®å¼‚
```

**2ï¸âƒ£ éšæœºç­–ç•¥ï¼ˆRandomï¼‰**
```
å·¥ä½œæ–¹å¼ï¼š
æ¯æ¬¡è¯·æ±‚éšæœºé€‰æ‹©ä¸€ä¸ªä»åº“

ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œåˆ†å¸ƒå‡åŒ€ï¼ˆå¤§é‡è¯·æ±‚ä¸‹ï¼‰
ç¼ºç‚¹ï¼šçŸ­æœŸå†…å¯èƒ½ä¸å‡åŒ€
```

**3ï¸âƒ£ åŠ æƒç­–ç•¥ï¼ˆWeightedï¼‰**
```
å·¥ä½œæ–¹å¼ï¼š
slave1(æƒé‡3) â†’ 60%çš„è¯·æ±‚
slave2(æƒé‡2) â†’ 40%çš„è¯·æ±‚

ä¼˜ç‚¹ï¼šæ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆ†é…
ç¼ºç‚¹ï¼šéœ€è¦æ‰‹åŠ¨é…ç½®æƒé‡
```

**4ï¸âƒ£ æœ€å°‘è¿æ¥ç­–ç•¥ï¼ˆLeast Connectionï¼‰**
```
å·¥ä½œæ–¹å¼ï¼š
é€‰æ‹©å½“å‰æ´»è·ƒè¿æ¥æ•°æœ€å°‘çš„ä»åº“

ä¼˜ç‚¹ï¼šåŠ¨æ€è´Ÿè½½å‡è¡¡
ç¼ºç‚¹ï¼šéœ€è¦ç»´æŠ¤è¿æ¥è®¡æ•°
```

### 7.2 å®ç°è·¯ç”±ç­–ç•¥


**ğŸ“ è·¯ç”±ç­–ç•¥æ¥å£**
```java
public interface DataSourceRouter {
    /**
     * é€‰æ‹©æ•°æ®æº
     */
    String route();
}
```

**ğŸ“ è½®è¯¢ç­–ç•¥å®ç°**
```java
@Component
public class RoundRobinRouter implements DataSourceRouter {
    
    private final List<String> slaves = Arrays.asList("slave1", "slave2");
    private final AtomicInteger counter = new AtomicInteger(0);
    
    @Override
    public String route() {
        int index = counter.getAndIncrement() % slaves.size();
        return slaves.get(index);
    }
}
```

**ğŸ“ éšæœºç­–ç•¥å®ç°**
```java
@Component
public class RandomRouter implements DataSourceRouter {
    
    private final List<String> slaves = Arrays.asList("slave1", "slave2");
    private final Random random = new Random();
    
    @Override
    public String route() {
        int index = random.nextInt(slaves.size());
        return slaves.get(index);
    }
}
```

**ğŸ“ åŠ æƒç­–ç•¥å®ç°**
```java
@Component
public class WeightedRouter implements DataSourceRouter {
    
    // æ•°æ®æºæƒé‡é…ç½®
    private final Map<String, Integer> weights = new HashMap<String, Integer>() {{
        put("slave1", 3);  // æƒé‡3
        put("slave2", 2);  // æƒé‡2
    }};
    
    @Override
    public String route() {
        // è®¡ç®—æ€»æƒé‡ï¼š3+2=5
        int totalWeight = weights.values().stream()
            .mapToInt(Integer::intValue).sum();
        
        // ç”Ÿæˆéšæœºæ•°ï¼š0-4
        int random = new Random().nextInt(totalWeight);
        
        // æ ¹æ®æƒé‡é€‰æ‹©
        // random=0,1,2 â†’ slave1
        // random=3,4   â†’ slave2
        int currentWeight = 0;
        for (Map.Entry<String, Integer> entry : weights.entrySet()) {
            currentWeight += entry.getValue();
            if (random < currentWeight) {
                return entry.getKey();
            }
        }
        
        return "slave1";  // é»˜è®¤è¿”å›
    }
}
```

**ğŸ”§ åœ¨AOPä¸­ä½¿ç”¨è·¯ç”±ç­–ç•¥**
```java
@Aspect
@Component
public class DataSourceAspect {
    
    @Autowired
    private DataSourceRouter router;  // æ³¨å…¥è·¯ç”±ç­–ç•¥
    
    @Around("@annotation(ds)")
    public Object around(ProceedingJoinPoint point, DS ds) throws Throwable {
        try {
            String dsKey = ds.value();
            
            // å¦‚æœæ˜¯slaveï¼Œä½¿ç”¨è·¯ç”±ç­–ç•¥é€‰æ‹©å…·ä½“ä»åº“
            if ("slave".equals(dsKey)) {
                dsKey = router.route();
            }
            
            DataSourceContextHolder.set(dsKey);
            return point.proceed();
            
        } finally {
            DataSourceContextHolder.clear();
        }
    }
}
```

**ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹**
```java
@Service
public class UserService {
    
    /**
     * ä½¿ç”¨è·¯ç”±ç­–ç•¥é€‰æ‹©ä»åº“
     */
    @DS("slave")  // ä¸æŒ‡å®šå…·ä½“ä»åº“ï¼Œç”±è·¯ç”±ç­–ç•¥å†³å®š
    public List<User> listUsers() {
        return userMapper.selectList(null);
    }
}
```

---

## 8. ğŸ” äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯


### 8.1 å¤šæ•°æ®æºäº‹åŠ¡é—®é¢˜


**âš ï¸ é—®é¢˜åœºæ™¯**
```
åœºæ™¯ï¼šè®¢å•æœåŠ¡éœ€è¦åŒæ—¶æ“ä½œä¸¤ä¸ªåº“
1. åœ¨è®¢å•åº“åˆ›å»ºè®¢å•
2. åœ¨åº“å­˜åº“å‡å°‘åº“å­˜

é—®é¢˜ï¼šå¦‚æœç¬¬2æ­¥å¤±è´¥ï¼Œç¬¬1æ­¥å·²ç»æäº¤äº†æ€ä¹ˆåŠï¼Ÿ
```

**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> å°±åƒç½‘ä¸Šè´­ç‰©ï¼šä½ ä¸‹å•äº†ï¼ˆè®¢å•åº“å†™å…¥ï¼‰ï¼Œä½†æ‰£åº“å­˜å¤±è´¥ï¼ˆåº“å­˜åº“æ“ä½œå¤±è´¥ï¼‰ã€‚å¦‚æœè®¢å•å·²ç»ç”Ÿæˆï¼Œä½†æ²¡æœ‰åº“å­˜ï¼Œå°±ä¼šå¯¼è‡´"è¶…å–"é—®é¢˜ã€‚æˆ‘ä»¬éœ€è¦ä¿è¯ï¼šè¦ä¹ˆä¸¤ä¸ªæ“ä½œéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ã€‚

### 8.2 åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ


**ğŸ“Š ä¸‰ç§ä¸»æµæ–¹æ¡ˆ**

**1ï¸âƒ£ ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰**
```
é˜¶æ®µä¸€ï¼šå‡†å¤‡é˜¶æ®µ
äº‹åŠ¡åè°ƒè€… â†’ è¯¢é—®å„ä¸ªæ•°æ®åº“"èƒ½å¦æäº¤ï¼Ÿ"
å„ä¸ªæ•°æ®åº“ â†’ é¢„æäº¤ï¼Œé”å®šèµ„æº

é˜¶æ®µäºŒï¼šæäº¤é˜¶æ®µ
æ‰€æœ‰æ•°æ®åº“éƒ½OK â†’ åè°ƒè€…å‘é€"æäº¤"å‘½ä»¤
æœ‰æ•°æ®åº“å¤±è´¥   â†’ åè°ƒè€…å‘é€"å›æ»š"å‘½ä»¤

ä¼˜ç‚¹ï¼šå¼ºä¸€è‡´æ€§
ç¼ºç‚¹ï¼šæ€§èƒ½å·®ï¼Œå•ç‚¹æ•…éšœé£é™©
```

**2ï¸âƒ£ TCCï¼ˆTry-Confirm-Cancelï¼‰**
```
Tryé˜¶æ®µï¼š
â€¢ å°è¯•æ‰§è¡Œï¼Œé¢„ç•™èµ„æº
â€¢ è®¢å•åº“ï¼šåˆ›å»ºè®¢å•ï¼ˆå¾…ç¡®è®¤çŠ¶æ€ï¼‰
â€¢ åº“å­˜åº“ï¼šå†»ç»“åº“å­˜

Confirmé˜¶æ®µï¼ˆæˆåŠŸï¼‰ï¼š
â€¢ è®¢å•åº“ï¼šè®¢å•çŠ¶æ€æ”¹ä¸ºå·²ç¡®è®¤
â€¢ åº“å­˜åº“ï¼šæ‰£å‡å†»ç»“çš„åº“å­˜

Cancelé˜¶æ®µï¼ˆå¤±è´¥ï¼‰ï¼š
â€¢ è®¢å•åº“ï¼šåˆ é™¤è®¢å•
â€¢ åº“å­˜åº“ï¼šé‡Šæ”¾å†»ç»“çš„åº“å­˜

ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½ï¼Œä¸šåŠ¡å¯æ§
ç¼ºç‚¹ï¼šä»£ç ä¾µå…¥æ€§å¼º
```

**3ï¸âƒ£ æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰**
```
æ­¥éª¤1ï¼šè®¢å•åº“äº‹åŠ¡
â€¢ åˆ›å»ºè®¢å•
â€¢ åˆ›å»ºæ¶ˆæ¯è®°å½•ï¼ˆå¾…å‘é€ï¼‰
â€¢ ä¸€èµ·æäº¤

æ­¥éª¤2ï¼šå®šæ—¶ä»»åŠ¡
â€¢ æ‰«æå¾…å‘é€æ¶ˆæ¯
â€¢ å‘é€åˆ°MQ

æ­¥éª¤3ï¼šåº“å­˜æœåŠ¡æ¶ˆè´¹MQ
â€¢ å‡åº“å­˜
â€¢ æ ‡è®°æ¶ˆæ¯å·²å¤„ç†

ä¼˜ç‚¹ï¼šè§£è€¦ï¼Œæ€§èƒ½å¥½
ç¼ºç‚¹ï¼šæœ€ç»ˆä¸€è‡´ï¼Œæœ‰å»¶è¿Ÿ
```

### 8.3 ä½¿ç”¨Seataå®ç°åˆ†å¸ƒå¼äº‹åŠ¡


**ğŸ“¦ å¼•å…¥Seata**
```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
</dependency>
```

**ğŸ”§ é…ç½®Seata**
```yaml
seata:
  application-id: order-service
  tx-service-group: order-group
  
  config:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      
  registry:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
```

**ğŸ“ ä»£ç ä½¿ç”¨**
```java
@Service
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private StockService stockService;  // Feignè°ƒç”¨åº“å­˜æœåŠ¡
    
    /**
     * åˆ›å»ºè®¢å• - åˆ†å¸ƒå¼äº‹åŠ¡
     */
    @GlobalTransactional  // Seataå…¨å±€äº‹åŠ¡æ³¨è§£
    public void createOrder(Order order) {
        
        // 1. æœ¬åœ°è®¢å•åº“ï¼šåˆ›å»ºè®¢å•
        orderMapper.insert(order);
        
        // 2. è¿œç¨‹åº“å­˜æœåŠ¡ï¼šå‡åº“å­˜
        stockService.decreaseStock(order.getProductId(), order.getQuantity());
        
        // å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼ŒSeataä¼šè‡ªåŠ¨å›æ»šæ‰€æœ‰æ“ä½œ
    }
}
```

**âš™ï¸ Seataå·¥ä½œæµç¨‹**
```
1. TMå¼€å¯å…¨å±€äº‹åŠ¡
   â†“
2. ç”Ÿæˆå…¨å±€äº‹åŠ¡IDï¼ˆXIDï¼‰
   â†“
3. æ‰§è¡Œè®¢å•åº“æ“ä½œï¼ˆæ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼‰
   â†“
4. æ‰§è¡Œåº“å­˜åº“æ“ä½œï¼ˆæ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼‰
   â†“
5. TMå†³å®šæäº¤æˆ–å›æ»š
   â†“
6. RMæ‰§è¡Œå…·ä½“çš„æäº¤æˆ–å›æ»š
```

**ğŸ’¡ å…³é”®ç†è§£**
```
TMï¼ˆTransaction Managerï¼‰ï¼šäº‹åŠ¡ç®¡ç†å™¨
â€¢ è´Ÿè´£å…¨å±€äº‹åŠ¡çš„å¼€å¯ã€æäº¤ã€å›æ»š

RMï¼ˆResource Managerï¼‰ï¼šèµ„æºç®¡ç†å™¨
â€¢ è´Ÿè´£åˆ†æ”¯äº‹åŠ¡çš„æ³¨å†Œã€æäº¤ã€å›æ»š

TCï¼ˆTransaction Coordinatorï¼‰ï¼šäº‹åŠ¡åè°ƒè€…
â€¢ Seata Serverï¼Œåè°ƒå…¨å±€äº‹åŠ¡
```

### 8.4 åŒåº“å¤šæ•°æ®æºäº‹åŠ¡å¤„ç†


**ğŸ”§ é…ç½®åŠ¨æ€æ•°æ®æºæ”¯æŒäº‹åŠ¡**
```java
@Configuration
public class DataSourceConfig {
    
    @Bean
    @Primary
    public DataSource dynamicDataSource() {
        DynamicDataSource dynamic = new DynamicDataSource();
        
        // ... é…ç½®æ•°æ®æº ...
        
        return dynamic;
    }
    
    /**
     * é…ç½®äº‹åŠ¡ç®¡ç†å™¨
     */
    @Bean
    public PlatformTransactionManager transactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

**ğŸ“ äº‹åŠ¡ä¼ æ’­è¡Œä¸º**
```java
@Service
public class UserService {
    
    /**
     * å¤–å±‚äº‹åŠ¡ï¼šä½¿ç”¨ä¸»åº“
     */
    @DS("master")
    @Transactional
    public void outerMethod() {
        // æ“ä½œä¸»åº“
        userMapper.insert(user);
        
        // è°ƒç”¨å†…å±‚æ–¹æ³•
        innerMethod();  // ä¼šç»§æ‰¿å¤–å±‚äº‹åŠ¡çš„æ•°æ®æº
    }
    
    /**
     * å†…å±‚äº‹åŠ¡ï¼šæŒ‡å®šä»åº“ï¼ˆä½†å®é™…ä¼šç”¨ä¸»åº“ï¼‰
     */
    @DS("slave1")
    @Transactional(propagation = Propagation.REQUIRED)
    public void innerMethod() {
        // ç”±äºä¼ æ’­è¡Œä¸ºæ˜¯REQUIREDï¼Œä¼šåŠ å…¥å¤–å±‚äº‹åŠ¡
        // å®é™…ä½¿ç”¨çš„æ•°æ®æºæ˜¯masterï¼Œè€Œä¸æ˜¯slave1
        userMapper.update(user);
    }
}
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
```
åŒä¸€äº‹åŠ¡ä¸­ä¸èƒ½åˆ‡æ¢æ•°æ®æºï¼

åŸå› ï¼š
â€¢ äº‹åŠ¡å¼€å§‹æ—¶å°±å·²ç»è·å–äº†æ•°æ®åº“è¿æ¥
â€¢ è¿æ¥ç»‘å®šåˆ°å½“å‰çº¿ç¨‹
â€¢ äº‹åŠ¡æ‰§è¡ŒæœŸé—´ä¸èƒ½æ›´æ¢è¿æ¥

è§£å†³æ–¹æ¡ˆï¼š
1. ä¸€ä¸ªäº‹åŠ¡åªç”¨ä¸€ä¸ªæ•°æ®æº
2. å¤šä¸ªæ•°æ®æºç”¨åˆ†å¸ƒå¼äº‹åŠ¡
3. æ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹äº‹åŠ¡ï¼ˆæ…ç”¨ï¼‰
```

---

## 9. ğŸ›¡ï¸ æ•…éšœè½¬ç§»æœºåˆ¶


### 9.1 æ•…éšœè½¬ç§»åŸç†


**ğŸ¯ ä»€ä¹ˆæ˜¯æ•…éšœè½¬ç§»**
```
åœºæ™¯ï¼šä»åº“slave1çªç„¶å®•æœº
ä¼ ç»Ÿæ–¹æ¡ˆï¼šæ‰€æœ‰è¯·æ±‚å¤±è´¥ï¼ŒæœåŠ¡ä¸å¯ç”¨
æ•…éšœè½¬ç§»ï¼šè‡ªåŠ¨åˆ‡æ¢åˆ°slave2ï¼ŒæœåŠ¡ç»§ç»­

æ•…éšœè½¬ç§»æµç¨‹ï¼š
1. æ£€æµ‹åˆ°æ•°æ®æºæ•…éšœ
2. ä»å¯ç”¨æ•°æ®æºä¸­é€‰æ‹©ä¸€ä¸ª
3. åˆ‡æ¢åˆ°æ–°æ•°æ®æº
4. æ ‡è®°æ•…éšœæ•°æ®æº
5. å®šæœŸæ£€æµ‹æ•…éšœæ•°æ®æºæ˜¯å¦æ¢å¤
```

**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> å°±åƒé«˜é€Ÿå…¬è·¯ä¸Šçš„è½¦é“ï¼šå¦‚æœ1å·è½¦é“æ–½å·¥å°é—­äº†ï¼ŒGPSä¼šè‡ªåŠ¨å¼•å¯¼ä½ èµ°2å·è½¦é“ï¼Œè€Œä¸æ˜¯è®©ä½ åŸåœ°ç­‰å¾…ã€‚ç­‰1å·è½¦é“ä¿®å¥½äº†ï¼Œå†é‡æ–°å¼€æ”¾ã€‚

### 9.2 å®ç°å¥åº·æ£€æŸ¥


**ğŸ“ æ•°æ®æºå¥åº·æ£€æŸ¥å™¨**
```java
@Component
public class DataSourceHealthChecker {
    
    @Autowired
    private Map<String, DataSource> dataSources;
    
    // å­˜å‚¨ä¸å¯ç”¨çš„æ•°æ®æº
    private final Set<String> unavailableDataSources = new ConcurrentHashSet<>();
    
    /**
     * æ£€æŸ¥æ•°æ®æºæ˜¯å¦å¯ç”¨
     */
    public boolean isAvailable(String dsKey) {
        if (unavailableDataSources.contains(dsKey)) {
            return false;
        }
        
        DataSource ds = dataSources.get(dsKey);
        if (ds == null) {
            return false;
        }
        
        try (Connection conn = ds.getConnection()) {
            // æ‰§è¡Œç®€å•æŸ¥è¯¢æµ‹è¯•è¿æ¥
            PreparedStatement ps = conn.prepareStatement("SELECT 1");
            ps.executeQuery();
            return true;
        } catch (Exception e) {
            // æ ‡è®°ä¸ºä¸å¯ç”¨
            unavailableDataSources.add(dsKey);
            return false;
        }
    }
    
    /**
     * å®šæœŸæ£€æµ‹æ•…éšœæ•°æ®æºæ˜¯å¦æ¢å¤
     */
    @Scheduled(fixedDelay = 30000)  // æ¯30ç§’æ£€æµ‹ä¸€æ¬¡
    public void checkRecovery() {
        Iterator<String> iterator = unavailableDataSources.iterator();
        
        while (iterator.hasNext()) {
            String dsKey = iterator.next();
            
            if (isAvailable(dsKey)) {
                // æ•°æ®æºå·²æ¢å¤
                iterator.remove();
                System.out.println("æ•°æ®æºæ¢å¤: " + dsKey);
            }
        }
    }
}
```

### 9.3 å®ç°æ•…éšœè½¬ç§»è·¯ç”±


**ğŸ“ æ•…éšœè½¬ç§»è·¯ç”±å™¨**
```java
@Component
public class FailoverRouter implements DataSourceRouter {
    
    @Autowired
    private DataSourceHealthChecker healthChecker;
    
    private final List<String> slaves = Arrays.asList("slave1", "slave2", "slave3");
    
    @Override
    public String route() {
        // å°è¯•æŒ‰ä¼˜å…ˆçº§é€‰æ‹©å¯ç”¨ä»åº“
        for (String slave : slaves) {
            if (healthChecker.isAvailable(slave)) {
                return slave;
            }
        }
        
        // æ‰€æœ‰ä»åº“éƒ½ä¸å¯ç”¨ï¼Œé™çº§åˆ°ä¸»åº“
        System.out.println("âš ï¸ æ‰€æœ‰ä»åº“ä¸å¯ç”¨ï¼Œé™çº§ä½¿ç”¨ä¸»åº“");
        return "master";
    }
}
```

**ğŸ”§ é›†æˆåˆ°AOPåˆ‡é¢**
```java
@Aspect
@Component
public class DataSourceAspect {
    
    @Autowired
    private FailoverRouter failoverRouter;
    
    @Autowired
    private DataSourceHealthChecker healthChecker;
    
    @Around("@annotation(ds)")
    public Object around(ProceedingJoinPoint point, DS ds) throws Throwable {
        try {
            String dsKey = ds.value();
            
            // å¦‚æœæ˜¯ä»åº“ï¼Œæ£€æŸ¥å¥åº·çŠ¶æ€
            if (dsKey.startsWith("slave")) {
                if (!healthChecker.isAvailable(dsKey)) {
                    // æ•…éšœè½¬ç§»ï¼šé€‰æ‹©å…¶ä»–ä»åº“
                    dsKey = failoverRouter.route();
                    System.out.println("ğŸ”„ æ•…éšœè½¬ç§»: " + ds.value() + " â†’ " + dsKey);
                }
            }
            
            DataSourceContextHolder.set(dsKey);
            return point.proceed();
            
        } finally {
            DataSourceContextHolder.clear();
        }
    }
}
```

### 9.4 æ•…éšœè½¬ç§»ç­–ç•¥


**ğŸ“Š å¤šç§è½¬ç§»ç­–ç•¥**

**1ï¸âƒ£ ä¼˜å…ˆçº§ç­–ç•¥**
```
é…ç½®ä¼˜å…ˆçº§ï¼š
slave1 (ä¼˜å…ˆçº§1) â†’ slave2 (ä¼˜å…ˆçº§2) â†’ slave3 (ä¼˜å…ˆçº§3) â†’ master (æœ€å)

å·¥ä½œæ–¹å¼ï¼š
â€¢ slave1æ•…éšœ â†’ åˆ‡æ¢åˆ°slave2
â€¢ slave2æ•…éšœ â†’ åˆ‡æ¢åˆ°slave3
â€¢ æ‰€æœ‰ä»åº“æ•…éšœ â†’ é™çº§åˆ°master
```

**2ï¸âƒ£ è½®è¯¢ç­–ç•¥**
```
å½“å‰å¯ç”¨ä»åº“åˆ—è¡¨ï¼š
[slave2, slave3]  (slave1å·²æ•…éšœ)

å·¥ä½œæ–¹å¼ï¼š
è¯·æ±‚1 â†’ slave2
è¯·æ±‚2 â†’ slave3
è¯·æ±‚3 â†’ slave2
...å¾ªç¯
```

**3ï¸âƒ£ å°±è¿‘ç­–ç•¥**
```
æ ¹æ®å»¶è¿Ÿé€‰æ‹©ï¼š
slave1: å»¶è¿Ÿ5ms  (æ­£å¸¸)
slave2: å»¶è¿Ÿ200ms (ç½‘ç»œæŠ–åŠ¨)
slave3: è¿æ¥è¶…æ—¶  (æ•…éšœ)

é€‰æ‹©ï¼šslave1 (å»¶è¿Ÿæœ€ä½ä¸”å¯ç”¨)
```

**ğŸ“ ç»¼åˆç­–ç•¥å®ç°**
```java
@Component
public class SmartFailoverRouter {
    
    @Autowired
    private DataSourceHealthChecker healthChecker;
    
    /**
     * æ™ºèƒ½é€‰æ‹©æ•°æ®æº
     */
    public String smartRoute() {
        List<DataSourceInfo> available = new ArrayList<>();
        
        // 1. æ”¶é›†å¯ç”¨æ•°æ®æºåŠå…¶çŠ¶æ€
        for (String ds : getAllSlaves()) {
            if (healthChecker.isAvailable(ds)) {
                DataSourceInfo info = new DataSourceInfo();
                info.setName(ds);
                info.setLatency(getLatency(ds));  // è·å–å»¶è¿Ÿ
                info.setPriority(getPriority(ds));  // è·å–ä¼˜å…ˆçº§
                available.add(info);
            }
        }
        
        // 2. æŒ‰ä¼˜å…ˆçº§å’Œå»¶è¿Ÿæ’åº
        available.sort(Comparator
            .comparing(DataSourceInfo::getPriority)
            .thenComparing(DataSourceInfo::getLatency));
        
        // 3. é€‰æ‹©æœ€ä½³æ•°æ®æº
        return available.isEmpty() ? "master" : available.get(0).getName();
    }
    
    /**
     * æµ‹é‡æ•°æ®æºå»¶è¿Ÿ
     */
    private long getLatency(String dsKey) {
        long start = System.currentTimeMillis();
        healthChecker.isAvailable(dsKey);
        return System.currentTimeMillis() - start;
    }
}
```

### 9.5 æ•…éšœæŠ¥è­¦æœºåˆ¶


**ğŸ“§ æŠ¥è­¦é…ç½®**
```java
@Component
public class DataSourceAlertService {
    
    @Autowired
    private EmailService emailService;
    
    /**
     * æ•°æ®æºæ•…éšœæŠ¥è­¦
     */
    public void alertFailure(String dsKey, Exception e) {
        String message = String.format(
            "ğŸš¨ æ•°æ®æºæ•…éšœæŠ¥è­¦\n" +
            "æ•°æ®æºï¼š%s\n" +
            "æ—¶é—´ï¼š%s\n" +
            "å¼‚å¸¸ï¼š%s",
            dsKey,
            LocalDateTime.now(),
            e.getMessage()
        );
        
        // å‘é€é‚®ä»¶
        emailService.send("admin@example.com", "æ•°æ®æºæ•…éšœ", message);
        
        // è®°å½•æ—¥å¿—
        System.err.println(message);
        
        // å‘é€ç›‘æ§æŒ‡æ ‡
        sendMetrics(dsKey, "FAILURE");
    }
    
    /**
     * æ•°æ®æºæ¢å¤é€šçŸ¥
     */
    public void alertRecovery(String dsKey) {
        String message = String.format(
            "âœ… æ•°æ®æºæ¢å¤é€šçŸ¥\n" +
            "æ•°æ®æºï¼š%s\n" +
            "æ—¶é—´ï¼š%s",
            dsKey,
            LocalDateTime.now()
        );
        
        emailService.send("admin@example.com", "æ•°æ®æºæ¢å¤", message);
        sendMetrics(dsKey, "RECOVERED");
    }
}
```

**ğŸ“Š ç›‘æ§æŒ‡æ ‡**
```java
@Component
public class DataSourceMetrics {
    
    // æ•°æ®æºåˆ‡æ¢æ¬¡æ•°
    private final Map<String, AtomicLong> switchCount = new ConcurrentHashMap<>();
    
    // æ•°æ®æºæ•…éšœæ¬¡æ•°
    private final Map<String, AtomicLong> failureCount = new ConcurrentHashMap<>();
    
    /**
     * è®°å½•åˆ‡æ¢
     */
    public void recordSwitch(String from, String to) {
        switchCount.computeIfAbsent(to, k -> new AtomicLong()).incrementAndGet();
    }
    
    /**
     * è®°å½•æ•…éšœ
     */
    public void recordFailure(String dsKey) {
        failureCount.computeIfAbsent(dsKey, k -> new AtomicLong()).incrementAndGet();
    }
    
    /**
     * è·å–ç»Ÿè®¡æ•°æ®
     */
    public Map<String, Object> getMetrics() {
        Map<String, Object> metrics = new HashMap<>();
        metrics.put("switchCount", switchCount);
        metrics.put("failureCount", failureCount);
        return metrics;
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


ğŸ¯ **å¤šæ•°æ®æºä¸‰å¤§æ ¸å¿ƒ**
```
1ï¸âƒ£ åŠ¨æ€æ•°æ®æºåˆ‡æ¢
â€¢ AbstractRoutingDataSourceå®ç°åŠ¨æ€é€‰æ‹©
â€¢ ThreadLocalä¿è¯çº¿ç¨‹éš”ç¦»
â€¢ @DSæ³¨è§£å£°æ˜å¼åˆ‡æ¢

2ï¸âƒ£ è¯»å†™åˆ†ç¦»
â€¢ ä¸»åº“è´Ÿè´£å†™æ“ä½œï¼ˆINSERT/UPDATE/DELETEï¼‰
â€¢ ä»åº“è´Ÿè´£è¯»æ“ä½œï¼ˆSELECTï¼‰
â€¢ è‡ªåŠ¨è·¯ç”±æˆ–æ‰‹åŠ¨æŒ‡å®š

3ï¸âƒ£ åˆ†åº“åˆ†è¡¨
â€¢ åˆ†åº“ï¼šæ•°æ®åˆ†æ•£åˆ°å¤šä¸ªæ•°æ®åº“
â€¢ åˆ†è¡¨ï¼šå¤§è¡¨æ‹†åˆ†æˆå¤šä¸ªå°è¡¨
â€¢ Sharding-JDBCè‡ªåŠ¨è·¯ç”±
```

### 10.2 å…³é”®æŠ€æœ¯ç†è§£


**ğŸ” æ·±åº¦ç†è§£è¦ç‚¹**

**ä¸ºä»€ä¹ˆç”¨ThreadLocalï¼Ÿ**
```
é—®é¢˜ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œå¦‚ä½•ä¿è¯æ•°æ®æºä¸æ··ä¹±ï¼Ÿ
ç­”æ¡ˆï¼šThreadLocalä¸ºæ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹å­˜å‚¨æ•°æ®æºæ ‡è¯†

ç±»æ¯”ï¼šæ¯ä¸ªäººæœ‰è‡ªå·±çš„è®°äº‹æœ¬ï¼Œäº’ä¸å½±å“
```

**ä¸ºä»€ä¹ˆè¦æ¸…ç†ThreadLocalï¼Ÿ**
```
é—®é¢˜ï¼šä¸æ¸…ç†ä¼šæ€æ ·ï¼Ÿ
ç­”æ¡ˆï¼šçº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹ï¼Œä¸‹ä¸ªè¯·æ±‚ä¼šç”¨é”™æ•°æ®æº

ç±»æ¯”ï¼šç”¨å®Œè®°äº‹æœ¬è¦æ“¦æ‰ï¼Œå¦åˆ™ä¸‹ä¸ªäººçœ‹åˆ°çš„æ˜¯ä¸Šä¸ªäººçš„å†…å®¹
```

**ä¸»ä»å»¶è¿Ÿå¦‚ä½•å¤„ç†ï¼Ÿ**
```
æ–¹æ¡ˆ1ï¼šç›‘æ§å»¶è¿Ÿï¼Œè¶…è¿‡é˜ˆå€¼åˆ‡ä¸»åº“
æ–¹æ¡ˆ2ï¼šé‡è¦æŸ¥è¯¢ç›´æ¥èµ°ä¸»åº“
æ–¹æ¡ˆ3ï¼šä¸šåŠ¡æ¥å—æœ€ç»ˆä¸€è‡´æ€§
```

### 10.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ’¼ ä¸šåŠ¡åœºæ™¯å¯¹ç…§è¡¨**

| ä¸šåŠ¡éœ€æ±‚ | **æŠ€æœ¯æ–¹æ¡ˆ** | **æ ¸å¿ƒè¦ç‚¹** |
|---------|-------------|-------------|
| ğŸ“Š **é«˜å¹¶å‘è¯»** | è¯»å†™åˆ†ç¦» + å¤šä»åº“ | åˆ†æ•£è¯»å‹åŠ›ï¼Œæå‡æ€§èƒ½ |
| ğŸ¢ **ä¸šåŠ¡éš”ç¦»** | æŒ‰ä¸šåŠ¡åˆ†åº“ | è®¢å•åº“ã€ç”¨æˆ·åº“ã€å•†å“åº“ |
| ğŸ“ˆ **æµ·é‡æ•°æ®** | åˆ†åº“åˆ†è¡¨ | é™ä½å•è¡¨æ•°æ®é‡ |
| ğŸŒ **å¤šåœ°åŸŸ** | åœ°ç†åˆ†åº“ | å°±è¿‘è®¿é—®ï¼Œé™ä½å»¶è¿Ÿ |
| ğŸ”„ **æ•°æ®åº“è¿ç§»** | åŒå†™æ–¹æ¡ˆ | æ–°æ—§åº“åŒæ—¶å†™å…¥ |

### 10.4 é…ç½®æœ€ä½³å®è·µ


**âœ… æ¨èé…ç½®**
```
1. ä¸»ä»æ¯”ä¾‹ï¼š1ä¸»2ä»æˆ–1ä¸»3ä»
   â€¢ 1ä¸ªä¸»åº“è¶³å¤Ÿï¼ˆåªè´Ÿè´£å†™ï¼‰
   â€¢ 2-3ä¸ªä»åº“ï¼ˆåˆ†æ‹…è¯»å‹åŠ›ï¼‰

2. è·¯ç”±ç­–ç•¥ï¼šåŠ æƒè½®è¯¢
   â€¢ æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è®¾ç½®æƒé‡
   â€¢ æ€§èƒ½å¥½çš„ä»åº“åˆ†é…æ›´å¤šæµé‡

3. æ•…éšœè½¬ç§»ï¼šå¥åº·æ£€æŸ¥ + è‡ªåŠ¨åˆ‡æ¢
   â€¢ 30ç§’æ£€æµ‹ä¸€æ¬¡å¥åº·çŠ¶æ€
   â€¢ æ•…éšœç«‹å³åˆ‡æ¢åˆ°å¤‡ç”¨åº“

4. äº‹åŠ¡å¤„ç†ï¼š
   â€¢ åŒåº“å¤šè¡¨ï¼šæœ¬åœ°äº‹åŠ¡
   â€¢ è·¨åº“æ“ä½œï¼šSeataåˆ†å¸ƒå¼äº‹åŠ¡
   â€¢ å¯æ¥å—å»¶è¿Ÿï¼šMQæœ€ç»ˆä¸€è‡´
```

### 10.5 å¸¸è§é—®é¢˜ä¸è§£å†³


**â“ é—®é¢˜é€ŸæŸ¥è¡¨**

**Q1: äº‹åŠ¡ä¸­åˆ‡æ¢æ•°æ®æºå¤±è´¥ï¼Ÿ**
```
åŸå› ï¼šäº‹åŠ¡å¼€å§‹æ—¶å·²ç»‘å®šæ•°æ®æºï¼Œæ— æ³•åˆ‡æ¢
è§£å†³ï¼šä¸€ä¸ªäº‹åŠ¡åªç”¨ä¸€ä¸ªæ•°æ®æºï¼Œè·¨åº“ç”¨åˆ†å¸ƒå¼äº‹åŠ¡
```

**Q2: ä¸»ä»å»¶è¿Ÿå¯¼è‡´æŸ¥ä¸åˆ°åˆšå†™å…¥çš„æ•°æ®ï¼Ÿ**
```
åŸå› ï¼šä¸»åº“å†™å…¥åç«‹å³ä»ä»åº“æŸ¥è¯¢ï¼Œæ•°æ®è¿˜æœªåŒæ­¥
è§£å†³ï¼š
â€¢ å¼ºåˆ¶è¯»ä¸»åº“ï¼š@DS("master")
â€¢ å»¶è¿ŸæŸ¥è¯¢ï¼šå†™å…¥åç­‰å¾…ä¸€å°æ®µæ—¶é—´
â€¢ ä¸šåŠ¡æ¥å—ï¼šæç¤º"æ•°æ®å¤„ç†ä¸­"
```

**Q3: ThreadLocalå†…å­˜æ³„æ¼ï¼Ÿ**
```
åŸå› ï¼šç”¨å®Œä¸æ¸…ç†ï¼Œçº¿ç¨‹æ± å¤ç”¨å¯¼è‡´ç´¯ç§¯
è§£å†³ï¼šfinallyå—ä¸­å¿…é¡»è°ƒç”¨clear()
```

**Q4: æ•°æ®æºé…ç½®å¤ªå¤šå¾ˆä¹±ï¼Ÿ**
```
è§£å†³ï¼š
â€¢ ä½¿ç”¨é…ç½®ä¸­å¿ƒï¼ˆNacosã€Apolloï¼‰
â€¢ æŒ‰ç¯å¢ƒåˆ†ç¦»ï¼ˆdevã€testã€prodï¼‰
â€¢ ä½¿ç”¨é…ç½®ç±»ç»Ÿä¸€ç®¡ç†
```

**Q5: å¦‚ä½•æµ‹è¯•å¤šæ•°æ®æºé…ç½®ï¼Ÿ**
```
æµ‹è¯•æ–¹æ³•ï¼š
1. å•å…ƒæµ‹è¯•ï¼šMockæ•°æ®æº
2. é›†æˆæµ‹è¯•ï¼šH2å†…å­˜æ•°æ®åº“æ¨¡æ‹Ÿå¤šåº“
3. å‹åŠ›æµ‹è¯•ï¼šJMeteræµ‹è¯•è´Ÿè½½å‡è¡¡
4. æ•…éšœæµ‹è¯•ï¼šæ‰‹åŠ¨åœæ­¢æŸä¸ªæ•°æ®æº
```

### 10.6 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**âš¡ ä¼˜åŒ–æ¸…å•**

**æ•°æ®åº“å±‚é¢ï¼š**
```
âœ… ä¸»ä»å¤åˆ¶ä¼˜åŒ–
â€¢ ä½¿ç”¨SSDç¡¬ç›˜æå‡IO
â€¢ å¼€å¯å¹¶è¡Œå¤åˆ¶
â€¢ è°ƒæ•´binlogæ ¼å¼ä¸ºROW

âœ… è¿æ¥æ± ä¼˜åŒ–
â€¢ åˆç†è®¾ç½®æœ€å¤§è¿æ¥æ•°
â€¢ é…ç½®è¿æ¥è¶…æ—¶æ—¶é—´
â€¢ ä½¿ç”¨HikariCPï¼ˆæ€§èƒ½æœ€ä¼˜ï¼‰
```

**åº”ç”¨å±‚é¢ï¼š**
```
âœ… ç¼“å­˜ç­–ç•¥
â€¢ çƒ­ç‚¹æ•°æ®Redisç¼“å­˜
â€¢ å‡å°‘æ•°æ®åº“æŸ¥è¯¢å‹åŠ›

âœ… æ‰¹é‡æ“ä½œ
â€¢ æ‰¹é‡æ’å…¥ä»£æ›¿é€æ¡æ’å…¥
â€¢ æ‰¹é‡æŸ¥è¯¢ä»£æ›¿å¤šæ¬¡å•æŸ¥

âœ… å¼‚æ­¥å¤„ç†
â€¢ éæ ¸å¿ƒæ“ä½œå¼‚æ­¥åŒ–
â€¢ ä½¿ç”¨MQå‰Šå³°å¡«è°·
```

**ç›‘æ§å‘Šè­¦ï¼š**
```
âœ… å…³é”®æŒ‡æ ‡ç›‘æ§
â€¢ ä¸»ä»å»¶è¿Ÿæ—¶é—´
â€¢ æ•°æ®æºåˆ‡æ¢é¢‘ç‡
â€¢ è¿æ¥æ± ä½¿ç”¨ç‡
â€¢ SQLæ‰§è¡Œæ—¶é—´

âœ… å‘Šè­¦é˜ˆå€¼è®¾ç½®
â€¢ å»¶è¿Ÿ>5ç§’ï¼šå‘é€å‘Šè­¦
â€¢ ä»åº“æ•…éšœï¼šç«‹å³é€šçŸ¥
â€¢ è¿æ¥æ± >90%ï¼šæ‰©å®¹é¢„è­¦
```

### 10.7 å­¦ä¹ è·¯çº¿å›¾


**ğŸ¯ ä»å…¥é—¨åˆ°ç²¾é€š**

```
é˜¶æ®µä¸€ï¼šåŸºç¡€ç†è§£ï¼ˆ1-2å¤©ï¼‰
â”œâ”€â”€ ç†è§£å¤šæ•°æ®æºæ¦‚å¿µ
â”œâ”€â”€ æŒæ¡ThreadLocalåŸç†
â”œâ”€â”€ å­¦ä¼šé…ç½®å¤šä¸ªæ•°æ®æº
â””â”€â”€ å®ç°ç®€å•çš„æ‰‹åŠ¨åˆ‡æ¢

é˜¶æ®µäºŒï¼šæ ¸å¿ƒå®ç°ï¼ˆ3-5å¤©ï¼‰
â”œâ”€â”€ æŒæ¡AbstractRoutingDataSource
â”œâ”€â”€ å®ç°åŠ¨æ€æ•°æ®æºç±»
â”œâ”€â”€ ç¼–å†™@DSæ³¨è§£å’ŒAOPåˆ‡é¢
â””â”€â”€ é…ç½®è¯»å†™åˆ†ç¦»

é˜¶æ®µä¸‰ï¼šé«˜çº§ç‰¹æ€§ï¼ˆ5-7å¤©ï¼‰
â”œâ”€â”€ å®ç°å¤šç§è·¯ç”±ç­–ç•¥
â”œâ”€â”€ é…ç½®åˆ†åº“åˆ†è¡¨
â”œâ”€â”€ å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡
â””â”€â”€ å®ç°æ•…éšœè½¬ç§»

é˜¶æ®µå››ï¼šç”Ÿäº§å®è·µï¼ˆæŒç»­ï¼‰
â”œâ”€â”€ æ€§èƒ½è°ƒä¼˜
â”œâ”€â”€ ç›‘æ§å‘Šè­¦
â”œâ”€â”€ æ•…éšœæ¼”ç»ƒ
â””â”€â”€ æ¶æ„ä¼˜åŒ–
```

### 10.8 å¿«é€Ÿä¸Šæ‰‹æŒ‡å—


**ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿé…ç½®**

**æ­¥éª¤1ï¸âƒ£ï¼šæ·»åŠ ä¾èµ–**
```xml
<!-- åªéœ€è¿™ä¸€ä¸ªä¾èµ– -->
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>dynamic-datasource-spring-boot-starter</artifactId>
    <version>3.5.0</version>
</dependency>
```

**æ­¥éª¤2ï¸âƒ£ï¼šé…ç½®æ•°æ®æº**
```yaml
spring:
  datasource:
    dynamic:
      primary: master  # é»˜è®¤æ•°æ®æº
      datasource:
        master:
          url: jdbc:mysql://localhost:3306/db_master
          username: root
          password: 123456
        slave:
          url: jdbc:mysql://localhost:3306/db_slave
          username: root
          password: 123456
```

**æ­¥éª¤3ï¸âƒ£ï¼šä½¿ç”¨æ³¨è§£**
```java
@Service
public class UserService {
    
    @DS("slave")  // å°±è¿™ä¹ˆç®€å•ï¼
    public User getUser(Long id) {
        return userMapper.selectById(id);
    }
    
    @DS("master")
    public void saveUser(User user) {
        userMapper.insert(user);
    }
}
```

**å®Œæˆï¼ğŸ‰ å¤šæ•°æ®æºé…ç½®å°±æ˜¯è¿™ä¹ˆç®€å•**

### 10.9 è®°å¿†å£è¯€


**ğŸ“ å¤šæ•°æ®æºé€Ÿè®°**

```
å¤šæ•°æ®æºè®°å¿ƒé—´ï¼ŒåŠ¨æ€åˆ‡æ¢æ˜¯å…³é”®
ThreadLocalä¿çº¿ç¨‹ï¼Œç”¨å®Œæ¸…ç†é˜²æ³„æ¼
ä¸»åº“è´Ÿè´£å†™æ“ä½œï¼Œä»åº“ä¸“é—¨å¹²æŸ¥è¯¢
åˆ†åº“åˆ†è¡¨è§£å‹åŠ›ï¼Œè·¯ç”±ç­–ç•¥è¦é€‰å¥½
äº‹åŠ¡ä¸€è‡´æ˜¯éš¾ç‚¹ï¼ŒSeataå¸®ä½ æ¥è§£å†³
æ•…éšœè½¬ç§»ä¿å¯ç”¨ï¼Œç›‘æ§å‘Šè­¦ä¸èƒ½å°‘
```

### 10.10 å®æˆ˜æ£€æŸ¥æ¸…å•


**âœ… ä¸Šçº¿å‰å¿…æŸ¥é¡¹**

**é…ç½®æ£€æŸ¥ï¼š**
- [ ] æ•°æ®æºè¿æ¥ä¿¡æ¯æ­£ç¡®
- [ ] ä¸»ä»å¤åˆ¶çŠ¶æ€æ­£å¸¸
- [ ] ThreadLocalæ­£ç¡®æ¸…ç†
- [ ] äº‹åŠ¡ä¼ æ’­è¡Œä¸ºåˆç†
- [ ] è¿æ¥æ± å‚æ•°ä¼˜åŒ–

**åŠŸèƒ½æ£€æŸ¥ï¼š**
- [ ] è¯»æ“ä½œèµ°ä»åº“
- [ ] å†™æ“ä½œèµ°ä¸»åº“
- [ ] æ•°æ®æºåˆ‡æ¢æ­£å¸¸
- [ ] æ•…éšœè½¬ç§»ç”Ÿæ•ˆ
- [ ] åˆ†å¸ƒå¼äº‹åŠ¡æ­£ç¡®

**æ€§èƒ½æ£€æŸ¥ï¼š**
- [ ] ä¸»ä»å»¶è¿Ÿåœ¨å¯æ§èŒƒå›´
- [ ] è¿æ¥æ± ä½¿ç”¨ç‡æ­£å¸¸
- [ ] SQLæ‰§è¡Œæ—¶é—´åˆç†
- [ ] æ— æ…¢æŸ¥è¯¢å †ç§¯

**ç›‘æ§æ£€æŸ¥ï¼š**
- [ ] æ•°æ®æºçŠ¶æ€ç›‘æ§
- [ ] åˆ‡æ¢é¢‘ç‡ç›‘æ§
- [ ] æ•…éšœå‘Šè­¦é…ç½®
- [ ] æ—¥å¿—è®°å½•å®Œæ•´

---

## ğŸ“ æ€»ç»“ä¸å±•æœ›


**æ ¸å¿ƒæ”¶è·ï¼š**

æœ¬ç« å­¦ä¹ äº†MyBatiså¤šæ•°æ®æºé…ç½®çš„å®Œæ•´çŸ¥è¯†ä½“ç³»ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°é«˜çº§å®è·µï¼Œæ¶µç›–äº†ï¼š

1. **åŸºç¡€ç†è®º**ï¼šç†è§£å¤šæ•°æ®æºçš„æœ¬è´¨å’Œåº”ç”¨åœºæ™¯
2. **æ ¸å¿ƒå®ç°**ï¼šæŒæ¡åŠ¨æ€æ•°æ®æºçš„å®ç°åŸç†
3. **å®æˆ˜æŠ€èƒ½**ï¼šä¼šé…ç½®è¯»å†™åˆ†ç¦»ã€åˆ†åº“åˆ†è¡¨
4. **é«˜çº§ç‰¹æ€§**ï¼šèƒ½å¤„ç†äº‹åŠ¡ä¸€è‡´æ€§å’Œæ•…éšœè½¬ç§»
5. **ä¼˜åŒ–ç­–ç•¥**ï¼šæ‡‚å¾—å¦‚ä½•ç›‘æ§ã€è°ƒä¼˜å’Œæ’é”™

**è¿›é˜¶æ–¹å‘ï¼š**

```
æ·±å…¥å­¦ä¹ ï¼š
â€¢ åˆ†å¸ƒå¼äº‹åŠ¡åŸç†ï¼ˆ2PCã€TCCã€Sagaï¼‰
â€¢ æ•°æ®åº“ä¸­é—´ä»¶ï¼ˆMyCatã€ShardingSphereï¼‰
â€¢ äº‘åŸç”Ÿæ•°æ®åº“ï¼ˆPolarDBã€TiDBï¼‰
â€¢ æ•°æ®åº“æ€§èƒ½è°ƒä¼˜ï¼ˆç´¢å¼•ã€æŸ¥è¯¢ä¼˜åŒ–ï¼‰

å®æˆ˜é¡¹ç›®ï¼š
â€¢ æ„å»ºé«˜å¯ç”¨ç”µå•†ç³»ç»Ÿ
â€¢ å®ç°åƒä¸‡çº§æ•°æ®åˆ†åº“åˆ†è¡¨
â€¢ è®¾è®¡è·¨åŒºåŸŸæ•°æ®åŒæ­¥æ–¹æ¡ˆ
â€¢ æ­å»ºæ•°æ®åº“ç›‘æ§å¹³å°
```

**æœ€åå»ºè®®ï¼š**

> å¤šæ•°æ®æºä¸æ˜¯é“¶å¼¹ï¼Œè¦æ ¹æ®å®é™…ä¸šåŠ¡é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚å°é¡¹ç›®å•åº“è¶³å¤Ÿï¼Œå¤§é¡¹ç›®æ‰è€ƒè™‘å¤šæ•°æ®æºã€‚è®°ä½ï¼šæ¶æ„ä¸ºä¸šåŠ¡æœåŠ¡ï¼Œä¸è¦è¿‡åº¦è®¾è®¡ï¼

**æŒç»­å­¦ä¹ èµ„æºï¼š**
- ğŸ“– å®˜æ–¹æ–‡æ¡£ï¼šMyBatisã€Sharding-JDBCã€Seata
- ğŸ¥ è§†é¢‘æ•™ç¨‹ï¼šBç«™æœç´¢"MyBatiså¤šæ•°æ®æº"
- ğŸ’» å¼€æºé¡¹ç›®ï¼šGitHubæœç´¢"dynamic-datasource"
- ğŸ¤ æŠ€æœ¯ç¤¾åŒºï¼šæ˜é‡‘ã€æ€å¦ã€CSDN

---

**ğŸ‰ æ­å–œä½ å®Œæˆäº†å¤šæ•°æ®æºé…ç½®çš„å­¦ä¹ ï¼**

ä»å•æ•°æ®æºåˆ°å¤šæ•°æ®æºï¼Œä»æ‰‹åŠ¨åˆ‡æ¢åˆ°è‡ªåŠ¨è·¯ç”±ï¼Œä»æœ¬åœ°äº‹åŠ¡åˆ°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä½ å·²ç»æŒæ¡äº†æ„å»ºé«˜å¯ç”¨æ•°æ®åº“æ¶æ„çš„æ ¸å¿ƒæŠ€èƒ½ã€‚

è®°ä½ï¼š**å®è·µæ˜¯æœ€å¥½çš„è€å¸ˆ**ã€‚åŠ¨æ‰‹æ­å»ºä¸€ä¸ªå¤šæ•°æ®æºé¡¹ç›®ï¼Œåœ¨å®è·µä¸­åŠ æ·±ç†è§£ï¼Œåœ¨é—®é¢˜ä¸­ç§¯ç´¯ç»éªŒã€‚

**ä¸‹ä¸€æ­¥ï¼š** ç»“åˆå®é™…ä¸šåŠ¡åœºæ™¯ï¼Œè®¾è®¡å¹¶å®ç°ä¸€å¥—å®Œæ•´çš„å¤šæ•°æ®æºè§£å†³æ–¹æ¡ˆï¼Œå°†ç†è®ºè½¬åŒ–ä¸ºç”Ÿäº§åŠ›ï¼

ğŸ’ª **åŠ æ²¹ï¼ä½ å·²ç»æ˜¯å¤šæ•°æ®æºé…ç½®çš„ä¸“å®¶äº†ï¼**