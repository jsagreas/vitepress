---
title: 36ã€è°ƒè¯•ä¸æµ‹è¯•
---
## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆè¦æµ‹è¯•MyBatis](#1-ä¸ºä»€ä¹ˆè¦æµ‹è¯•mybatis)
2. [å•å…ƒæµ‹è¯•åŸºç¡€](#2-å•å…ƒæµ‹è¯•åŸºç¡€)
3. [é›†æˆæµ‹è¯•ç­–ç•¥](#3-é›†æˆæµ‹è¯•ç­–ç•¥)
4. [æµ‹è¯•æ•°æ®ç®¡ç†](#4-æµ‹è¯•æ•°æ®ç®¡ç†)
5. [äº‹åŠ¡ä¸å›æ»šæµ‹è¯•](#5-äº‹åŠ¡ä¸å›æ»šæµ‹è¯•)
6. [æ€§èƒ½æµ‹è¯•ä¸ä¼˜åŒ–](#6-æ€§èƒ½æµ‹è¯•ä¸ä¼˜åŒ–)
7. [è°ƒè¯•æŠ€å·§æ±‡æ€»](#7-è°ƒè¯•æŠ€å·§æ±‡æ€»)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤” ä¸ºä»€ä¹ˆè¦æµ‹è¯•MyBatis


### 1.1 æµ‹è¯•çš„é‡è¦æ€§


**ç®€å•æ¥è¯´**ï¼šæµ‹è¯•å°±åƒæ˜¯ç»™ä»£ç åšä½“æ£€ï¼Œç¡®ä¿å®ƒèƒ½æ­£å¸¸å·¥ä½œã€‚

```
æ²¡æœ‰æµ‹è¯•çš„å¼€å‘æµç¨‹ï¼š
å†™ä»£ç  â†’ å¯åŠ¨é¡¹ç›® â†’ æ‰‹åŠ¨ç‚¹å‡»æµ‹è¯• â†’ å‘ç°é—®é¢˜ â†’ æ”¹ä»£ç  â†’ é‡æ–°å¯åŠ¨...
é—®é¢˜ï¼šè€—æ—¶é•¿ã€å®¹æ˜“é—æ¼ã€éš¾ä»¥é‡å¤

æœ‰æµ‹è¯•çš„å¼€å‘æµç¨‹ï¼š
å†™ä»£ç  â†’ å†™æµ‹è¯• â†’ è¿è¡Œæµ‹è¯•(å‡ ç§’é’Ÿ) â†’ å‘ç°é—®é¢˜ â†’ æ”¹ä»£ç  â†’ é‡æ–°æµ‹è¯•...
ä¼˜åŠ¿ï¼šå¿«é€Ÿã€å…¨é¢ã€å¯é‡å¤
```

**ğŸ”¸ MyBatisæµ‹è¯•çš„ç‰¹æ®Šæ€§**

MyBatisæ¶‰åŠæ•°æ®åº“æ“ä½œï¼Œæ‰€ä»¥æµ‹è¯•éœ€è¦è€ƒè™‘ï¼š
- **SQLæ˜¯å¦æ­£ç¡®**ï¼šæŸ¥è¯¢ã€æ’å…¥ã€æ›´æ–°ã€åˆ é™¤é€»è¾‘å¯¹ä¸å¯¹
- **æ˜ å°„æ˜¯å¦å‡†ç¡®**ï¼šJavaå¯¹è±¡å’Œæ•°æ®åº“è¡¨å¯¹åº”å…³ç³»æ˜¯å¦æ­£ç¡®
- **æ•°æ®å®Œæ•´æ€§**ï¼šæ“ä½œåæ•°æ®çŠ¶æ€æ˜¯å¦ç¬¦åˆé¢„æœŸ
- **æ€§èƒ½æ˜¯å¦è¾¾æ ‡**ï¼šSQLæ‰§è¡Œæ•ˆç‡å¤Ÿä¸å¤Ÿå¿«

### 1.2 æµ‹è¯•åˆ†ç±»å¯¹æ¯”


| æµ‹è¯•ç±»å‹ | **æµ‹è¯•å¯¹è±¡** | **æ˜¯å¦è¿æ¥çœŸå®æ•°æ®åº“** | **é€Ÿåº¦** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|---------------------|---------|------------|
| **å•å…ƒæµ‹è¯•** | `å•ä¸ªMapperæ–¹æ³•` | `âŒ ä½¿ç”¨Mockæ¨¡æ‹Ÿ` | `âš¡ éå¸¸å¿«` | `éªŒè¯ä¸šåŠ¡é€»è¾‘` |
| **é›†æˆæµ‹è¯•** | `Mapper+æ•°æ®åº“äº¤äº’` | `âœ… è¿æ¥æµ‹è¯•æ•°æ®åº“` | `ğŸ¢ è¾ƒæ…¢` | `éªŒè¯SQLå’Œæ˜ å°„` |
| **æ€§èƒ½æµ‹è¯•** | `SQLæ‰§è¡Œæ•ˆç‡` | `âœ… è¿æ¥ç±»ç”Ÿäº§ç¯å¢ƒ` | `ğŸŒ æ…¢` | `ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½` |

---

## 2. âœ… å•å…ƒæµ‹è¯•åŸºç¡€


### 2.1 ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•


**é€šä¿—ç†è§£**ï¼šå•å…ƒæµ‹è¯•å°±æ˜¯æµ‹è¯•æœ€å°çš„åŠŸèƒ½å•å…ƒï¼Œæ¯”å¦‚ä¸€ä¸ªMapperæ–¹æ³•ã€‚

```
ä¸¾ä¸ªç”Ÿæ´»ä¾‹å­ï¼š
å°±åƒæ£€éªŒä¸€ä¸ªç¯æ³¡æ˜¯å¦èƒ½äº®ï¼š
- ä¸éœ€è¦æŠŠå®ƒè£…åˆ°æ•´ä¸ªæˆ¿é—´çš„ç”µè·¯ç³»ç»Ÿé‡Œ
- åªéœ€è¦å•ç‹¬æ¥ä¸Šç”µæºè¯•ä¸€ä¸‹å°±çŸ¥é“äº†

å•å…ƒæµ‹è¯•ä¹Ÿæ˜¯è¿™ä¸ªæ€è·¯ï¼š
- ä¸éœ€è¦å¯åŠ¨æ•´ä¸ªSpringåº”ç”¨
- åªæµ‹è¯•ä¸€ä¸ªæ–¹æ³•æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œ
```

### 2.2 æµ‹è¯•ç¯å¢ƒå‡†å¤‡


**ç¬¬ä¸€æ­¥ï¼šæ·»åŠ æµ‹è¯•ä¾èµ–**

```xml
<!-- pom.xml -->
<dependencies>
    <!-- JUnit5ï¼šJavaæµ‹è¯•æ¡†æ¶ -->
    <dependency>
        <groupId>org.junit.jupiter</groupId>
        <artifactId>junit-jupiter</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- Spring Testï¼šSpringæµ‹è¯•æ”¯æŒ -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- MyBatis Testï¼šMyBatisæµ‹è¯•å·¥å…· -->
    <dependency>
        <groupId>org.mybatis.spring.boot</groupId>
        <artifactId>mybatis-spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

ğŸ’¡ **`scope=test`çš„å«ä¹‰**ï¼šè¿™ä¸ªä¾èµ–åªåœ¨æµ‹è¯•æ—¶ä½¿ç”¨ï¼Œæ‰“åŒ…æ—¶ä¸ä¼šåŒ…å«è¿›å»ï¼Œå‡å°é¡¹ç›®ä½“ç§¯ã€‚

### 2.3 ç¬¬ä¸€ä¸ªå•å…ƒæµ‹è¯•


**æµ‹è¯•ä¸€ä¸ªç®€å•çš„æŸ¥è¯¢æ–¹æ³•**

```java
// UserMapper.java - è¦æµ‹è¯•çš„Mapper
public interface UserMapper {
    User selectById(Long id);
}
```

```java
// UserMapperTest.java - æµ‹è¯•ç±»
@SpringBootTest  // â‘  å¯åŠ¨Springæµ‹è¯•ç¯å¢ƒ
class UserMapperTest {
    
    @Autowired  // â‘¡ æ³¨å…¥è¦æµ‹è¯•çš„Mapper
    private UserMapper userMapper;
    
    @Test  // â‘¢ æ ‡è®°è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–¹æ³•
    void testSelectById() {
        // æ‰§è¡ŒæŸ¥è¯¢
        User user = userMapper.selectById(1L);
        
        // éªŒè¯ç»“æœ
        assertNotNull(user);  // ç¡®ä¿æŸ¥åˆ°æ•°æ®
        assertEquals("å¼ ä¸‰", user.getName());  // éªŒè¯å§“å
        assertEquals(25, user.getAge());  // éªŒè¯å¹´é¾„
    }
}
```

**ä»£ç è§£è¯»**ï¼š
- `@SpringBootTest`ï¼šå‘Šè¯‰Springå¯åŠ¨æµ‹è¯•å®¹å™¨ï¼ŒåŠ è½½é…ç½®
- `@Autowired`ï¼šè‡ªåŠ¨æ³¨å…¥Mapperï¼Œå°±åƒåœ¨æ­£å¸¸ä»£ç é‡Œç”¨ä¸€æ ·
- `@Test`ï¼šJUnitè¯†åˆ«è¿™æ˜¯æµ‹è¯•æ–¹æ³•ï¼Œä¼šè‡ªåŠ¨è¿è¡Œ
- `assertXxx`ï¼šæ–­è¨€æ–¹æ³•ï¼Œç”¨æ¥éªŒè¯ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸ

### 2.4 æµ‹è¯•çš„ä¸‰æ®µå¼ç»“æ„


**è®°ä½è¿™ä¸ªæ¨¡å¼ï¼šå‡†å¤‡ â†’ æ‰§è¡Œ â†’ éªŒè¯**

```java
@Test
void testInsertUser() {
    // â‘  å‡†å¤‡é˜¶æ®µ(Arrange)ï¼šå‡†å¤‡æµ‹è¯•æ•°æ®
    User user = new User();
    user.setName("æå››");
    user.setAge(30);
    
    // â‘¡ æ‰§è¡Œé˜¶æ®µ(Act)ï¼šæ‰§è¡Œè¦æµ‹è¯•çš„æ–¹æ³•
    int result = userMapper.insert(user);
    
    // â‘¢ éªŒè¯é˜¶æ®µ(Assert)ï¼šæ£€æŸ¥ç»“æœæ˜¯å¦æ­£ç¡®
    assertEquals(1, result);  // æ’å…¥æˆåŠŸè¿”å›1
    assertNotNull(user.getId());  // IDåº”è¯¥è‡ªåŠ¨ç”Ÿæˆäº†
}
```

ğŸ’¡ **è®°å¿†æŠ€å·§**ï¼šAAAæ¨¡å¼ - Arrangeã€Actã€Assertï¼ˆå®‰æ’ã€è¡ŒåŠ¨ã€æ–­è¨€ï¼‰

---

## 3. ğŸ”— é›†æˆæµ‹è¯•ç­–ç•¥


### 3.1 å•å…ƒæµ‹è¯• vs é›†æˆæµ‹è¯•


**åŒºåˆ«ä¸€ç›®äº†ç„¶**ï¼š

```
å•å…ƒæµ‹è¯•(Unit Test)ï¼š
UserService â†’ [Mock] â†’ UserMapper
              å‡çš„         çœŸå®ä¸šåŠ¡é€»è¾‘
              
ä¼˜ç‚¹ï¼šå¿«é€Ÿã€éš”ç¦»ã€ä¸ä¾èµ–å¤–éƒ¨
ç¼ºç‚¹ï¼šä¸èƒ½éªŒè¯çœŸå®çš„æ•°æ®åº“äº¤äº’

é›†æˆæµ‹è¯•(Integration Test)ï¼š
UserService â†’ UserMapper â†’ æµ‹è¯•æ•°æ®åº“
   çœŸå®        çœŸå®           çœŸå®
   
ä¼˜ç‚¹ï¼šéªŒè¯å®Œæ•´é“¾è·¯ã€å‘ç°é›†æˆé—®é¢˜
ç¼ºç‚¹ï¼šé€Ÿåº¦æ…¢ã€éœ€è¦æ•°æ®åº“ç¯å¢ƒ
```

### 3.2 æµ‹è¯•æ•°æ®åº“é…ç½®


**ä¸ºä»€ä¹ˆéœ€è¦å•ç‹¬çš„æµ‹è¯•æ•°æ®åº“ï¼Ÿ**
- é¿å…æ±¡æŸ“å¼€å‘æ•°æ®åº“
- å¯ä»¥éšæ„å¢åˆ æ”¹æŸ¥ï¼Œä¸æ€•å¼„åæ•°æ®
- æ¯æ¬¡æµ‹è¯•éƒ½æ˜¯å¹²å‡€çš„ç¯å¢ƒ

**é…ç½®æ–¹å¼ä¸€ï¼šä½¿ç”¨H2å†…å­˜æ•°æ®åº“**

```yaml
# application-test.yml
spring:
  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:testdb  # memè¡¨ç¤ºå†…å­˜æ•°æ®åº“
    username: sa
    password: 
    
  h2:
    console:
      enabled: true  # å¯ç”¨H2æ§åˆ¶å°ï¼Œæ–¹ä¾¿æŸ¥çœ‹æ•°æ®
      
mybatis:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl  # æ‰“å°SQL
```

ğŸ’¡ **H2çš„ä¼˜åŠ¿**ï¼š
- çº¯Javaç¼–å†™ï¼Œæ— éœ€å®‰è£…
- è¿è¡Œåœ¨å†…å­˜ä¸­ï¼Œé€Ÿåº¦æå¿«
- æµ‹è¯•ç»“æŸè‡ªåŠ¨æ¸…ç©ºï¼Œä¸ç•™ç—•è¿¹

**é…ç½®æ–¹å¼äºŒï¼šä½¿ç”¨æµ‹è¯•ä¸“ç”¨MySQLåº“**

```yaml
# application-test.yml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/test_db?useSSL=false
    username: test_user
    password: test_pwd
```

### 3.3 å®Œæ•´çš„é›†æˆæµ‹è¯•ç¤ºä¾‹


```java
@SpringBootTest
@ActiveProfiles("test")  // ä½¿ç”¨testé…ç½®æ–‡ä»¶
class UserIntegrationTest {
    
    @Autowired
    private UserMapper userMapper;
    
    @Test
    void testCompleteUserFlow() {
        // â‘  æ’å…¥æµ‹è¯•
        User newUser = new User("ç‹äº”", 28);
        userMapper.insert(newUser);
        Long userId = newUser.getId();
        
        // â‘¡ æŸ¥è¯¢æµ‹è¯•
        User foundUser = userMapper.selectById(userId);
        assertEquals("ç‹äº”", foundUser.getName());
        
        // â‘¢ æ›´æ–°æµ‹è¯•
        foundUser.setAge(29);
        userMapper.update(foundUser);
        User updatedUser = userMapper.selectById(userId);
        assertEquals(29, updatedUser.getAge());
        
        // â‘£ åˆ é™¤æµ‹è¯•
        userMapper.deleteById(userId);
        User deletedUser = userMapper.selectById(userId);
        assertNull(deletedUser);
    }
}
```

**è¿™ä¸ªæµ‹è¯•éªŒè¯äº†ä»€ä¹ˆï¼Ÿ**
- å¢åˆ æ”¹æŸ¥çš„å®Œæ•´é“¾è·¯
- SQLæ˜ å°„æ˜¯å¦æ­£ç¡®
- æ•°æ®åº“æ“ä½œæ˜¯å¦ç¬¦åˆé¢„æœŸ

---

## 4. ğŸ“¦ æµ‹è¯•æ•°æ®ç®¡ç†


### 4.1 ä¸ºä»€ä¹ˆè¦ç®¡ç†æµ‹è¯•æ•°æ®


**é—®é¢˜åœºæ™¯**ï¼š

```
ç¬¬ä¸€æ¬¡è¿è¡Œæµ‹è¯•ï¼šæ’å…¥ID=1çš„ç”¨æˆ· â†’ æˆåŠŸâœ…
ç¬¬äºŒæ¬¡è¿è¡Œæµ‹è¯•ï¼šæ’å…¥ID=1çš„ç”¨æˆ· â†’ å¤±è´¥âŒ(ä¸»é”®å†²çª)

åŸå› ï¼šæµ‹è¯•æ•°æ®æ²¡æœ‰æ¸…ç†ï¼Œé—ç•™åœ¨æ•°æ®åº“é‡Œäº†
```

### 4.2 Mockæ•°æ®å‡†å¤‡ç­–ç•¥


**æ–¹å¼ä¸€ï¼šä½¿ç”¨@BeforeEachå‡†å¤‡æ•°æ®**

```java
@SpringBootTest
class UserServiceTest {
    
    @Autowired
    private UserMapper userMapper;
    
    private User testUser;
    
    @BeforeEach  // æ¯ä¸ªæµ‹è¯•æ–¹æ³•å‰éƒ½ä¼šæ‰§è¡Œ
    void setUp() {
        testUser = new User();
        testUser.setName("æµ‹è¯•ç”¨æˆ·");
        testUser.setAge(20);
        userMapper.insert(testUser);
    }
    
    @Test
    void testFindUser() {
        User found = userMapper.selectById(testUser.getId());
        assertNotNull(found);
    }
}
```

ğŸ’¡ **@BeforeEachä½œç”¨**ï¼šåƒæ˜¯æµ‹è¯•å‰çš„"å‡†å¤‡å·¥ä½œ"ï¼Œç¡®ä¿æ¯æ¬¡æµ‹è¯•éƒ½æœ‰å¹²å‡€çš„æ•°æ®ã€‚

**æ–¹å¼äºŒï¼šä½¿ç”¨SQLè„šæœ¬åˆå§‹åŒ–**

```sql
-- test-data.sql
INSERT INTO users (id, name, age) VALUES (1, 'å¼ ä¸‰', 25);
INSERT INTO users (id, name, age) VALUES (2, 'æå››', 30);
```

```java
@SpringBootTest
@Sql("/test-data.sql")  // æµ‹è¯•å‰æ‰§è¡ŒSQLè„šæœ¬
class UserMapperTest {
    
    @Test
    void testSelectAll() {
        List<User> users = userMapper.selectAll();
        assertEquals(2, users.size());
    }
}
```

### 4.3 æµ‹è¯•æ•°æ®æ¸…ç†


**æ–¹å¼ä¸€ï¼šä½¿ç”¨@AfterEachæ¸…ç†**

```java
@AfterEach  // æ¯ä¸ªæµ‹è¯•åæ‰§è¡Œ
void tearDown() {
    userMapper.deleteAll();  // æ¸…ç©ºæ‰€æœ‰æµ‹è¯•æ•°æ®
}
```

**æ–¹å¼äºŒï¼šä½¿ç”¨@Sqlçš„cleanup**

```java
@Sql(scripts = "/test-data.sql")  // æµ‹è¯•å‰æ‰§è¡Œ
@Sql(scripts = "/cleanup.sql", 
     executionPhase = AFTER_TEST_METHOD)  // æµ‹è¯•åæ‰§è¡Œ
class UserMapperTest {
    // ...
}
```

---

## 5. ğŸ”„ äº‹åŠ¡ä¸å›æ»šæµ‹è¯•


### 5.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡æµ‹è¯•


**é€šä¿—ç†è§£äº‹åŠ¡**ï¼š

```
å»é“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼š
å¼ ä¸‰è´¦æˆ· -100å…ƒ
æå››è´¦æˆ· +100å…ƒ

è¿™ä¸¤æ­¥è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½ä¸åš
ä¸­é—´å‡ºé”™äº†å°±å…¨éƒ¨æ’¤é”€(å›æ»š)
è¿™å°±æ˜¯äº‹åŠ¡
```

åœ¨æµ‹è¯•ä¸­ï¼š
- æµ‹è¯•è¿‡ç¨‹ä¸­çš„æ•°æ®ä¿®æ”¹å¯èƒ½å½±å“å…¶ä»–æµ‹è¯•
- æˆ‘ä»¬å¸Œæœ›**æµ‹è¯•å®Œè‡ªåŠ¨æ’¤é”€æ‰€æœ‰æ”¹åŠ¨**
- è¿™å°±æ˜¯äº‹åŠ¡å›æ»šæµ‹è¯•

### 5.2 @Transactionalæµ‹è¯•


**åŸºæœ¬ç”¨æ³•**ï¼š

```java
@SpringBootTest
@Transactional  // å¼€å¯äº‹åŠ¡
class UserTransactionTest {
    
    @Autowired
    private UserMapper userMapper;
    
    @Test
    void testInsert() {
        User user = new User("æµ‹è¯•", 25);
        userMapper.insert(user);
        
        // æµ‹è¯•å®Œæˆåï¼Œè¿™æ¡æ•°æ®ä¼šè‡ªåŠ¨å›æ»š
        // ä¸ä¼šçœŸçš„æ’å…¥åˆ°æ•°æ®åº“
    }
}
```

**æ‰§è¡Œæµç¨‹**ï¼š

```
1. å¼€å§‹äº‹åŠ¡ â†’ 2. æ‰§è¡Œæµ‹è¯• â†’ 3. è‡ªåŠ¨å›æ»š
    â†“              â†“              â†“
  å¼€å¯          æ’å…¥æ•°æ®        æ’¤é”€æ’å…¥
```

ğŸ’¡ **å¥½å¤„**ï¼šæ¯æ¬¡æµ‹è¯•åæ•°æ®åº“éƒ½æ¢å¤åŸçŠ¶ï¼Œæµ‹è¯•ä¹‹é—´äº’ä¸å½±å“ã€‚

### 5.3 @Rollbackæ§åˆ¶å›æ»š


**é»˜è®¤è¡Œä¸º**ï¼šæµ‹è¯•æ–¹æ³•ä¸Šçš„`@Transactional`ä¼šè‡ªåŠ¨å›æ»š

```java
@Test
@Transactional  // é»˜è®¤rollback=true
void testWithAutoRollback() {
    userMapper.insert(new User("ä¸´æ—¶", 20));
    // æµ‹è¯•ç»“æŸè‡ªåŠ¨å›æ»šï¼Œæ•°æ®ä¸ä¿ç•™
}
```

**æ‰‹åŠ¨æ§åˆ¶å›æ»š**ï¼š

```java
@Test
@Transactional
@Rollback(false)  // æ˜ç¡®æŒ‡å®šä¸å›æ»š
void testWithCommit() {
    userMapper.insert(new User("æ°¸ä¹…", 30));
    // æ•°æ®ä¼šçœŸçš„æ’å…¥ï¼Œæµ‹è¯•åä¿ç•™
}
```

âš ï¸ **ä½¿ç”¨åœºæ™¯**ï¼š
- `@Rollback(true)`ï¼šé»˜è®¤ï¼Œé€‚åˆå¤§éƒ¨åˆ†æµ‹è¯•
- `@Rollback(false)`ï¼šéœ€è¦ä¿ç•™æ•°æ®æ—¶ä½¿ç”¨ï¼Œæ¯”å¦‚å‡†å¤‡æ¼”ç¤ºæ•°æ®

### 5.4 äº‹åŠ¡ä¼ æ’­è¡Œä¸ºæµ‹è¯•


**åœºæ™¯**ï¼šæµ‹è¯•Serviceå±‚çš„äº‹åŠ¡ç®¡ç†

```java
@Service
public class UserService {
    
    @Transactional  // Serviceå±‚çš„äº‹åŠ¡
    public void transferMoney(Long fromId, Long toId, int amount) {
        // å‡å°‘fromIdçš„ä½™é¢
        accountMapper.deduct(fromId, amount);
        
        // æ¨¡æ‹Ÿå¼‚å¸¸
        if (amount > 1000) {
            throw new RuntimeException("é‡‘é¢è¿‡å¤§");
        }
        
        // å¢åŠ toIdçš„ä½™é¢
        accountMapper.add(toId, amount);
    }
}
```

```java
@SpringBootTest
class UserServiceTest {
    
    @Autowired
    private UserService userService;
    
    @Test
    void testTransactionRollback() {
        // è½¬è´¦1500ï¼Œä¼šæŠ›å¼‚å¸¸
        assertThrows(RuntimeException.class, () -> {
            userService.transferMoney(1L, 2L, 1500);
        });
        
        // éªŒè¯ï¼šå¼‚å¸¸åä¸¤ä¸ªè´¦æˆ·ä½™é¢éƒ½æ²¡å˜
        assertEquals(1000, accountMapper.getBalance(1L));
        assertEquals(2000, accountMapper.getBalance(2L));
    }
}
```

**æµ‹è¯•éªŒè¯äº†ä»€ä¹ˆï¼Ÿ**
- äº‹åŠ¡çš„åŸå­æ€§ï¼šè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
- å¼‚å¸¸æ—¶çš„å›æ»šæœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

## 6. ğŸ“Š æ€§èƒ½æµ‹è¯•ä¸ä¼˜åŒ–


### 6.1 æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥


**ä»€ä¹ˆæ˜¯æµ‹è¯•è¦†ç›–ç‡ï¼Ÿ**

```
ä»£ç è¦†ç›–ç‡ = è¢«æµ‹è¯•è¦†ç›–çš„ä»£ç è¡Œæ•° / æ€»ä»£ç è¡Œæ•°

ä¾‹å¦‚ï¼š
æ€»å…±100è¡Œä»£ç ï¼Œæµ‹è¯•æ‰§è¡Œäº†80è¡Œ
è¦†ç›–ç‡ = 80%
```

**ä½¿ç”¨JaCoCoæ£€æŸ¥è¦†ç›–ç‡**ï¼š

```xml
<!-- pom.xml -->
<plugin>
    <groupId>org.jacoco</groupId>
    <artifactId>jacoco-maven-plugin</artifactId>
    <executions>
        <execution>
            <goals>
                <goal>prepare-agent</goal>
                <goal>report</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
mvn clean test jacoco:report

# æŸ¥çœ‹æŠ¥å‘Šï¼štarget/site/jacoco/index.html
```

**è¦†ç›–ç‡æŠ¥å‘Šç¤ºä¾‹**ï¼š

```
UserMapper.java
â”œâ”€ selectById()    âœ… 100% å·²æµ‹è¯•
â”œâ”€ selectAll()     âœ… 100% å·²æµ‹è¯•  
â”œâ”€ insert()        âš ï¸ 60% éƒ¨åˆ†æµ‹è¯•
â””â”€ update()        âŒ 0% æœªæµ‹è¯•
```

ğŸ’¡ **ç›®æ ‡å»ºè®®**ï¼š
- æ ¸å¿ƒä¸šåŠ¡ä»£ç ï¼š80%ä»¥ä¸Š
- å·¥å…·ç±»ä»£ç ï¼š70%ä»¥ä¸Š
- é…ç½®ç±»ä»£ç ï¼šå¯ä»¥ä½ä¸€äº›

### 6.2 SQLæ‰§è¡Œè®¡åˆ’åˆ†æ


**ä¸ºä»€ä¹ˆè¦åˆ†ææ‰§è¡Œè®¡åˆ’ï¼Ÿ**

```
åŒæ ·çš„æŸ¥è¯¢ï¼Œä¸åŒå†™æ³•æ€§èƒ½å·®å¼‚å·¨å¤§ï¼š

æ–¹å¼1ï¼šå…¨è¡¨æ‰«æ
SELECT * FROM users WHERE name LIKE '%å¼ %'
æ‰§è¡Œæ—¶é—´ï¼š500ms (æ‰«æ100ä¸‡è¡Œ)

æ–¹å¼2ï¼šä½¿ç”¨ç´¢å¼•
SELECT * FROM users WHERE name = 'å¼ ä¸‰'
æ‰§è¡Œæ—¶é—´ï¼š5ms (å‘½ä¸­ç´¢å¼•)
```

**åœ¨æµ‹è¯•ä¸­åˆ†æSQL**ï¼š

```java
@Test
void testSlowQuery() {
    long start = System.currentTimeMillis();
    
    List<User> users = userMapper.selectByNameLike("%å¼ %");
    
    long cost = System.currentTimeMillis() - start;
    
    // éªŒè¯æ€§èƒ½è¦æ±‚
    assertTrue(cost < 100, "æŸ¥è¯¢è€—æ—¶ï¼š" + cost + "ms");
}
```

**æŸ¥çœ‹MySQLæ‰§è¡Œè®¡åˆ’**ï¼š

```sql
-- åœ¨MyBatisæ—¥å¿—ä¸­æ‰¾åˆ°å®é™…æ‰§è¡Œçš„SQLï¼Œç„¶åï¼š
EXPLAIN SELECT * FROM users WHERE name LIKE '%å¼ %';

ç»“æœåˆ†æï¼š
+----+------+-------+------+---------+------+
| id | type | key   | rows | filtered| Extra|
+----+------+-------+------+---------+------+
| 1  | ALL  | NULL  | 1000 | 100.00  | ...  |
+----+------+-------+------+---------+------+

type=ALLï¼šå…¨è¡¨æ‰«æï¼Œæ€§èƒ½å·®âŒ
rows=1000ï¼šæ‰«æäº†1000è¡Œ
```

ğŸ’¡ **ä¼˜åŒ–å»ºè®®**ï¼š
- `type=const`ï¼šæœ€å¥½ï¼Œä½¿ç”¨ä¸»é”®
- `type=ref`ï¼šå¥½ï¼Œä½¿ç”¨æ™®é€šç´¢å¼•
- `type=ALL`ï¼šå·®ï¼Œå…¨è¡¨æ‰«æï¼Œéœ€è¦ä¼˜åŒ–

### 6.3 æ€§èƒ½æµ‹è¯•æ–¹æ³•


**æ‰¹é‡æ•°æ®æ€§èƒ½æµ‹è¯•**ï¼š

```java
@Test
void testBatchInsertPerformance() {
    List<User> users = new ArrayList<>();
    for (int i = 0; i < 1000; i++) {
        users.add(new User("ç”¨æˆ·" + i, 20 + i % 50));
    }
    
    long start = System.currentTimeMillis();
    
    // æ–¹å¼1ï¼šé€æ¡æ’å…¥
    // users.forEach(userMapper::insert);
    
    // æ–¹å¼2ï¼šæ‰¹é‡æ’å…¥
    userMapper.batchInsert(users);
    
    long cost = System.currentTimeMillis() - start;
    System.out.println("æ‰¹é‡æ’å…¥1000æ¡è€—æ—¶ï¼š" + cost + "ms");
    
    assertTrue(cost < 1000, "æ€§èƒ½ä¸è¾¾æ ‡");
}
```

**å¯¹æ¯”ç»“æœ**ï¼š

| æ’å…¥æ–¹å¼ | **1000æ¡è€—æ—¶** | **10000æ¡è€—æ—¶** |
|---------|--------------|---------------|
| é€æ¡æ’å…¥ | `~5000ms` | `~50000ms` |
| æ‰¹é‡æ’å…¥ | `~500ms` | `~3000ms` |

ğŸ“Š **æ€§èƒ½æå‡10å€ï¼**

---

## 7. ğŸ” è°ƒè¯•æŠ€å·§æ±‡æ€»


### 7.1 æ‰“å°SQLæ—¥å¿—


**æ–¹æ³•ä¸€ï¼šMyBatisé…ç½®**

```yaml
mybatis:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
```

**è¾“å‡ºæ•ˆæœ**ï¼š

```
==> Preparing: SELECT * FROM users WHERE id = ?
==> Parameters: 1(Long)
<== Total: 1
<== Columns: id, name, age
<== Row: 1, å¼ ä¸‰, 25
```

**æ–¹æ³•äºŒï¼šä½¿ç”¨Logback**

```xml
<!-- logback-test.xml -->
<configuration>
    <logger name="com.example.mapper" level="DEBUG"/>
</configuration>
```

### 7.2 ä½¿ç”¨æ–­ç‚¹è°ƒè¯•


**åœ¨æµ‹è¯•ä¸­æ‰“æ–­ç‚¹**ï¼š

```java
@Test
void testDebug() {
    User user = userMapper.selectById(1L);
    
    // â† åœ¨è¿™é‡Œæ‰“æ–­ç‚¹ï¼ŒæŸ¥çœ‹userçš„å€¼
    System.out.println(user);
    
    // å¯ä»¥åœ¨Variablesçª—å£çœ‹åˆ°ï¼š
    // user = User{id=1, name='å¼ ä¸‰', age=25}
}
```

**è°ƒè¯•æŠ€å·§**ï¼š
- **Step Into (F7)**ï¼šè¿›å…¥æ–¹æ³•å†…éƒ¨
- **Step Over (F8)**ï¼šæ‰§è¡Œå½“å‰è¡Œ
- **Evaluate Expression (Alt+F8)**ï¼šè®¡ç®—è¡¨è¾¾å¼å€¼

### 7.3 å¸¸è§é—®é¢˜æ’æŸ¥


**é—®é¢˜1ï¼šç©ºæŒ‡é’ˆå¼‚å¸¸**

```java
@Test
void testNullPointer() {
    User user = userMapper.selectById(999L);  // ä¸å­˜åœ¨çš„ID
    
    // âŒ ç›´æ¥è°ƒç”¨ä¼šç©ºæŒ‡é’ˆ
    // user.getName();
    
    // âœ… å…ˆåˆ¤ç©º
    assertNotNull(user, "ç”¨æˆ·ä¸å­˜åœ¨");
    assertEquals("å¼ ä¸‰", user.getName());
}
```

**é—®é¢˜2ï¼šå‚æ•°ç»‘å®šé”™è¯¯**

```xml
<!-- é”™è¯¯å†™æ³• -->
<select id="selectByName" resultType="User">
    SELECT * FROM users WHERE name = #{username}
</select>
```

```java
// å®é™…å‚æ•°åæ˜¯nameï¼Œä¸æ˜¯username
userMapper.selectByName("å¼ ä¸‰");  // âŒ å‚æ•°ç»‘å®šå¤±è´¥
```

**è§£å†³æ–¹æ³•**ï¼š

```xml
<!-- æ–¹å¼1ï¼šä½¿ç”¨@Paramæ³¨è§£ -->
User selectByName(@Param("username") String name);

<!-- æ–¹å¼2ï¼šXMLä¸­æ”¹æˆname -->
<select id="selectByName" resultType="User">
    SELECT * FROM users WHERE name = #{name}
</select>
```

### 7.4 Mockæµ‹è¯•éš”ç¦»


**åœºæ™¯**ï¼šæµ‹è¯•UserServiceï¼Œä½†ä¸æƒ³ä¾èµ–çœŸå®çš„UserMapper

```java
@ExtendWith(MockitoExtension.class)  // ä½¿ç”¨Mockito
class UserServiceMockTest {
    
    @Mock  // åˆ›å»ºMockå¯¹è±¡
    private UserMapper userMapper;
    
    @InjectMocks  // æ³¨å…¥Mock
    private UserService userService;
    
    @Test
    void testGetUserById() {
        // å®šä¹‰Mockè¡Œä¸ºï¼šå½“è°ƒç”¨selectById(1L)æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®
        User mockUser = new User(1L, "Mockç”¨æˆ·", 25);
        when(userMapper.selectById(1L)).thenReturn(mockUser);
        
        // æµ‹è¯•Serviceæ–¹æ³•
        User result = userService.getUserById(1L);
        
        // éªŒè¯
        assertEquals("Mockç”¨æˆ·", result.getName());
        
        // éªŒè¯Mapperè¢«è°ƒç”¨äº†1æ¬¡
        verify(userMapper, times(1)).selectById(1L);
    }
}
```

**Mockçš„å¥½å¤„**ï¼š
- ä¸éœ€è¦æ•°æ®åº“ï¼Œé€Ÿåº¦å¿«
- å¯ä»¥æ¨¡æ‹Ÿå„ç§åœºæ™¯ï¼ˆæ­£å¸¸ã€å¼‚å¸¸ã€è¾¹ç•Œï¼‰
- æµ‹è¯•æ›´ç¨³å®šï¼Œä¸å—å¤–éƒ¨å½±å“

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 æµ‹è¯•ç±»å‹é€‰æ‹©æŒ‡å—


```
ğŸ¯ é€‰æ‹©æµ‹è¯•ç±»å‹çš„å†³ç­–æ ‘ï¼š

éœ€è¦éªŒè¯SQLå’Œæ•°æ®åº“äº¤äº’ï¼Ÿ
â”œâ”€ æ˜¯ â†’ é›†æˆæµ‹è¯•(@SpringBootTest + çœŸå®DB)
â””â”€ å¦ â†’ å•å…ƒæµ‹è¯•(Mock)
    â”‚
    â”œâ”€ éœ€è¦æµ‹è¯•äº‹åŠ¡ï¼Ÿ
    â”‚   â”œâ”€ æ˜¯ â†’ @Transactional + @Rollback
    â”‚   â””â”€ å¦ â†’ æ™®é€šMockæµ‹è¯•
    â”‚
    â””â”€ éœ€è¦æµ‹è¯•æ€§èƒ½ï¼Ÿ
        â”œâ”€ æ˜¯ â†’ æ€§èƒ½æµ‹è¯• + SQLæ‰§è¡Œè®¡åˆ’åˆ†æ
        â””â”€ å¦ â†’ ç®€å•çš„åŠŸèƒ½éªŒè¯æµ‹è¯•
```

### 8.2 å¿…è®°çš„æµ‹è¯•æ³¨è§£


| æ³¨è§£ | **ä½œç”¨** | **ä½¿ç”¨åœºæ™¯** |
|-----|---------|------------|
| `@SpringBootTest` | `å¯åŠ¨å®Œæ•´Springå®¹å™¨` | `é›†æˆæµ‹è¯•` |
| `@Test` | `æ ‡è®°æµ‹è¯•æ–¹æ³•` | `æ‰€æœ‰æµ‹è¯•` |
| `@BeforeEach` | `æ¯ä¸ªæµ‹è¯•å‰æ‰§è¡Œ` | `å‡†å¤‡æµ‹è¯•æ•°æ®` |
| `@AfterEach` | `æ¯ä¸ªæµ‹è¯•åæ‰§è¡Œ` | `æ¸…ç†æµ‹è¯•æ•°æ®` |
| `@Transactional` | `å¼€å¯äº‹åŠ¡` | `éœ€è¦å›æ»šçš„æµ‹è¯•` |
| `@Rollback` | `æ§åˆ¶æ˜¯å¦å›æ»š` | `éœ€è¦ä¿ç•™æ•°æ®æ—¶` |
| `@Mock` | `åˆ›å»ºMockå¯¹è±¡` | `å•å…ƒæµ‹è¯•éš”ç¦»` |

### 8.3 æµ‹è¯•æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**

```java
// 1. æµ‹è¯•æ–¹æ³•å‘½åæ¸…æ™°
@Test
void testSelectByIdShouldReturnUserWhenExists() { }

// 2. ä¸€ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªç‚¹
@Test
void testInsert() {
    // åªæµ‹æ’å…¥ï¼Œä¸æµ‹å…¶ä»–
}

// 3. ä½¿ç”¨æ–­è¨€éªŒè¯
assertEquals(expected, actual);
assertNotNull(result);

// 4. æµ‹è¯•è¾¹ç•Œæƒ…å†µ
@Test
void testSelectByIdWhenNotExists() {
    User user = userMapper.selectById(-1L);
    assertNull(user);
}
```

**âŒ é¿å…çš„åšæ³•**

```java
// âŒ æµ‹è¯•æ–¹æ³•åä¸æ¸…æ¥š
@Test
void test1() { }

// âŒ ä¸€ä¸ªæµ‹è¯•åšå¤ªå¤šäº‹
@Test
void testEverything() {
    insert();
    update();
    delete();  // å¤ªå¤æ‚
}

// âŒ æ²¡æœ‰æ–­è¨€ï¼Œåªæ‰“å°
@Test
void test() {
    User user = mapper.selectById(1L);
    System.out.println(user);  // ä¸å¤Ÿä¸¥è°¨
}
```

### 8.4 è°ƒè¯•æŠ€å·§é€ŸæŸ¥


| é—®é¢˜ | **è§£å†³æ–¹æ³•** |
|-----|-----------|
| **SQLæ²¡æ‰§è¡Œ** | `æ£€æŸ¥Mapperæ‰«æè·¯å¾„ã€XMLä½ç½®` |
| **å‚æ•°ç»‘å®šé”™è¯¯** | `ä½¿ç”¨@Paramæˆ–æ£€æŸ¥XMLå‚æ•°å` |
| **ç©ºæŒ‡é’ˆå¼‚å¸¸** | `å…ˆåˆ¤ç©ºå†ä½¿ç”¨ï¼ŒassertNotNull` |
| **äº‹åŠ¡ä¸å›æ»š** | `æ£€æŸ¥@Transactionalä½ç½®` |
| **æ€§èƒ½æ…¢** | `EXPLAINåˆ†æï¼Œæ£€æŸ¥ç´¢å¼•` |

### 8.5 å®æˆ˜æ£€æŸ¥æ¸…å•


**æ¯æ¬¡å†™å®ŒMapperåçš„è‡ªæ£€**ï¼š

- [ ] å†™äº†å¯¹åº”çš„æµ‹è¯•ç±»ï¼Ÿ
- [ ] æµ‹è¯•äº†æ­£å¸¸æƒ…å†µï¼Ÿ
- [ ] æµ‹è¯•äº†å¼‚å¸¸æƒ…å†µï¼ˆnullã€ä¸å­˜åœ¨ç­‰ï¼‰ï¼Ÿ
- [ ] ä½¿ç”¨äº†@Transactionalå›æ»šï¼Ÿ
- [ ] æ‰“å°äº†SQLæ—¥å¿—ç¡®è®¤æ­£ç¡®ï¼Ÿ
- [ ] æµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡ï¼Ÿï¼ˆ>70%ï¼‰

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æµ‹è¯•ä¸‰æ­¥èµ°ï¼šå‡†å¤‡-æ‰§è¡Œ-éªŒè¯
å•å…ƒå¿«é›†æˆç¨³ï¼Œæ€§èƒ½çœ‹è®¡åˆ’
äº‹åŠ¡åŠ å›æ»šï¼Œæ•°æ®ä¸æ±¡æŸ“
Mockéš”ç¦»å¥½ï¼Œè°ƒè¯•æœ‰æŠ€å·§
```

---

## ğŸ¯ æ€»ç»“


MyBatisçš„è°ƒè¯•ä¸æµ‹è¯•æ˜¯ä¿è¯ä»£ç è´¨é‡çš„å…³é”®ï¼š

1. **å•å…ƒæµ‹è¯•**éªŒè¯ä¸šåŠ¡é€»è¾‘ï¼Œé€Ÿåº¦å¿«ï¼Œéš”ç¦»æ€§å¥½
2. **é›†æˆæµ‹è¯•**éªŒè¯SQLå’Œæ˜ å°„ï¼Œæ¥è¿‘çœŸå®ç¯å¢ƒ
3. **äº‹åŠ¡å›æ»š**ä¿è¯æµ‹è¯•åæ•°æ®å¹²å‡€ï¼Œäº’ä¸å½±å“
4. **æ€§èƒ½æµ‹è¯•**æ‰¾å‡ºæ…¢SQLï¼Œä¼˜åŒ–æŸ¥è¯¢æ•ˆç‡
5. **MockæŠ€æœ¯**éš”ç¦»ä¾èµ–ï¼Œæé«˜æµ‹è¯•ç¨³å®šæ€§

è®°ä½ï¼š**å¥½çš„æµ‹è¯•æ˜¯ä»£ç è´¨é‡çš„ä¿è¯ï¼Œä¹Ÿæ˜¯é‡æ„çš„åº•æ°”**ï¼