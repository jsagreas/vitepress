---
title: 7ã€é«˜çº§ç»“æœæ˜ å°„
---
## ğŸ“š ç›®å½•

1. [ç»“æœæ˜ å°„åŸºç¡€æ¦‚å¿µ](#1-ç»“æœæ˜ å°„åŸºç¡€æ¦‚å¿µ)
2. [ResultMapæ ¸å¿ƒå…ƒç´ è¯¦è§£](#2-ResultMapæ ¸å¿ƒå…ƒç´ è¯¦è§£)
3. [å…³è”å…³ç³»æ˜ å°„](#3-å…³è”å…³ç³»æ˜ å°„)
4. [é«˜çº§æ˜ å°„æŠ€æœ¯](#4-é«˜çº§æ˜ å°„æŠ€æœ¯)
5. [å»¶è¿ŸåŠ è½½ä¸æ€§èƒ½ä¼˜åŒ–](#5-å»¶è¿ŸåŠ è½½ä¸æ€§èƒ½ä¼˜åŒ–)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ç»“æœæ˜ å°„åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ç»“æœæ˜ å°„


**ç®€å•ç†è§£**ï¼šç»“æœæ˜ å°„å°±æ˜¯å‘Šè¯‰MyBatis"æ•°æ®åº“æŸ¥å‡ºæ¥çš„æ•°æ®è¯¥æ€ä¹ˆè£…åˆ°Javaå¯¹è±¡é‡Œ"

```
æ•°æ®åº“æŸ¥è¯¢ç»“æœï¼š              Javaå¯¹è±¡ï¼š
+----+-------+-----+          Userå¯¹è±¡
| id | name  | age |    â†’    - id: 1
+----+-------+-----+          - name: "å¼ ä¸‰"
| 1  | å¼ ä¸‰  | 25  |          - age: 25
+----+-------+-----+
```

**ä¸ºä»€ä¹ˆéœ€è¦ç»“æœæ˜ å°„**ï¼š
- **å­—æ®µåä¸ä¸€è‡´**ï¼šæ•°æ®åº“å­—æ®µ`user_name`ï¼ŒJavaå±æ€§`userName`
- **ç±»å‹è½¬æ¢**ï¼šæ•°æ®åº“çš„æ—¥æœŸã€æšä¸¾éœ€è¦è½¬æ¢æˆJavaå¯¹è±¡
- **å¤æ‚å…³ç³»**ï¼šç”¨æˆ·å…³è”è®¢å•ã€è®¢å•å…³è”å•†å“ç­‰å¤šè¡¨å…³è”
- **åµŒå¥—å¯¹è±¡**ï¼šæŸ¥è¯¢ç»“æœéœ€è¦ç»„è£…æˆåµŒå¥—çš„å¯¹è±¡ç»“æ„

### 1.2 è‡ªåŠ¨æ˜ å°„ vs æ‰‹åŠ¨æ˜ å°„


**è‡ªåŠ¨æ˜ å°„ï¼ˆç®€å•åœºæ™¯ï¼‰**ï¼š
```
æ•°æ®åº“ï¼šuser_id, user_name, age
Javaç±»ï¼šuserId,  userName,  age

åªè¦å¼€å¯é©¼å³°å‘½åè½¬æ¢ï¼ŒMyBatisè‡ªåŠ¨å¸®ä½ å¯¹åº”å¥½
```

**æ‰‹åŠ¨æ˜ å°„ï¼ˆå¤æ‚åœºæ™¯ï¼‰**ï¼š
```
å½“é‡åˆ°ä»¥ä¸‹æƒ…å†µï¼Œå¿…é¡»æ‰‹åŠ¨é…ç½®ResultMapï¼š
â€¢ å¤šè¡¨å…³è”æŸ¥è¯¢
â€¢ ä¸€å¯¹å¤šã€å¤šå¯¹å¤šå…³ç³»
â€¢ å­—æ®µåå®Œå…¨ä¸å¯¹åº”
â€¢ éœ€è¦è‡ªå®šä¹‰ç±»å‹è½¬æ¢
```

### 1.3 ResultMapçš„ä½œç”¨


```
æ ¸å¿ƒåŠŸèƒ½ï¼š

ğŸ”¸ å­—æ®µæ˜ å°„ï¼šæ•°æ®åº“åˆ— â†’ Javaå±æ€§
ğŸ”¸ ç±»å‹è½¬æ¢ï¼šæ•°æ®åº“ç±»å‹ â†’ Javaç±»å‹  
ğŸ”¸ å…³ç³»å¤„ç†ï¼šä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤š
ğŸ”¸ åµŒå¥—ç»„è£…ï¼šå°†å¹³é“ºæ•°æ®ç»„è£…æˆå¯¹è±¡æ ‘
ğŸ”¸ å»¶è¿ŸåŠ è½½ï¼šæŒ‰éœ€åŠ è½½å…³è”æ•°æ®
```

---

## 2. ğŸ“‹ ResultMapæ ¸å¿ƒå…ƒç´ è¯¦è§£


### 2.1 åŸºç¡€ç»“æ„


**ResultMapçš„ç»„æˆéƒ¨åˆ†**ï¼š
```xml
<resultMap id="å”¯ä¸€æ ‡è¯†" type="ç»“æœç±»å‹">
    <!-- ä¸»é”®æ˜ å°„ -->
    <id column="æ•°æ®åº“åˆ—" property="Javaå±æ€§"/>
    
    <!-- æ™®é€šå­—æ®µæ˜ å°„ -->
    <result column="æ•°æ®åº“åˆ—" property="Javaå±æ€§"/>
    
    <!-- æ„é€ æ–¹æ³•æ˜ å°„ -->
    <constructor>...</constructor>
    
    <!-- ä¸€å¯¹ä¸€å…³è” -->
    <association>...</association>
    
    <!-- ä¸€å¯¹å¤šå…³è” -->
    <collection>...</collection>
    
    <!-- é‰´åˆ«å™¨ -->
    <discriminator>...</discriminator>
</resultMap>
```

### 2.2 id ä¸»é”®æ˜ å°„


**idå…ƒç´ çš„ä½œç”¨**ï¼š
- **æ ‡è¯†ä¸»é”®**ï¼šå‘Šè¯‰MyBatiså“ªä¸ªæ˜¯ä¸»é”®å­—æ®µ
- **æ€§èƒ½ä¼˜åŒ–**ï¼šMyBatiså¯ä»¥é€šè¿‡ä¸»é”®æ›´é«˜æ•ˆåœ°ç¼“å­˜å’Œæ¯”è¾ƒå¯¹è±¡
- **å…³è”ä¼˜åŒ–**ï¼šå¤šè¡¨å…³è”æ—¶æé«˜åŒ¹é…æ•ˆç‡

```xml
<!-- åŸºæœ¬ç”¨æ³• -->
<resultMap id="userMap" type="User">
    <id column="user_id" property="id"/>
    <result column="user_name" property="name"/>
</resultMap>
```

> ğŸ’¡ **å°è´´å£«**ï¼šè™½ç„¶ä¸é…ç½®idä¹Ÿèƒ½å·¥ä½œï¼Œä½†é…ç½®äº†æ€§èƒ½æ›´å¥½

**å¤åˆä¸»é”®æ˜ å°„**ï¼š
```xml
<resultMap id="orderItemMap" type="OrderItem">
    <!-- å¤åˆä¸»é”®ï¼šè®¢å•ID + å•†å“ID -->
    <id column="order_id" property="orderId"/>
    <id column="product_id" property="productId"/>
    <result column="quantity" property="quantity"/>
</resultMap>
```

### 2.3 result æ™®é€šå­—æ®µæ˜ å°„


**resultå…ƒç´ ç”¨æ³•**ï¼š
```xml
<result 
    column="æ•°æ®åº“åˆ—å" 
    property="Javaå±æ€§å"
    javaType="Javaç±»å‹ï¼ˆå¯é€‰ï¼‰"
    jdbcType="JDBCç±»å‹ï¼ˆå¯é€‰ï¼‰"
    typeHandler="ç±»å‹å¤„ç†å™¨ï¼ˆå¯é€‰ï¼‰"/>
```

**å¸¸è§æ˜ å°„åœºæ™¯**ï¼š

| åœºæ™¯ | æ•°æ®åº“ | Java | é…ç½®ç¤ºä¾‹ |
|------|--------|------|---------|
| é©¼å³°è½¬æ¢ | `user_name` | `userName` | `<result column="user_name" property="userName"/>` |
| ç±»å‹è½¬æ¢ | `VARCHAR` | `String` | è‡ªåŠ¨è½¬æ¢ï¼Œæ— éœ€é…ç½® |
| æ—¥æœŸè½¬æ¢ | `DATETIME` | `LocalDateTime` | `javaType="java.time.LocalDateTime"` |
| æšä¸¾è½¬æ¢ | `TINYINT` | `Genderæšä¸¾` | `typeHandler="org.apache.ibatis.type.EnumOrdinalTypeHandler"` |

**å®é™…ä¾‹å­**ï¼š
```xml
<resultMap id="userDetailMap" type="User">
    <id column="id" property="id"/>
    <result column="user_name" property="name"/>
    <result column="birth_date" property="birthDate" 
            javaType="java.time.LocalDate"/>
    <result column="gender" property="gender" 
            javaType="com.example.enums.Gender"
            typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
</resultMap>
```

### 2.4 constructor æ„é€ æ–¹æ³•æ˜ å°„


**ä»€ä¹ˆæ—¶å€™ç”¨æ„é€ æ–¹æ³•æ˜ å°„**ï¼š
- Javaç±»**æ²¡æœ‰æ— å‚æ„é€ **
- ä½¿ç”¨**ä¸å¯å˜å¯¹è±¡**ï¼ˆfinalå­—æ®µï¼‰
- æƒ³é€šè¿‡**æ„é€ å™¨åˆå§‹åŒ–**å¯¹è±¡

```java
// ä¸å¯å˜çš„ç”¨æˆ·å¯¹è±¡
public class User {
    private final Long id;
    private final String name;
    
    // å¿…é¡»é€šè¿‡æ„é€ å™¨åˆ›å»º
    public User(Long id, String name) {
        this.id = id;
        this.name = name;
    }
    
    // åªæœ‰getterï¼Œæ²¡æœ‰setter
    public Long getId() { return id; }
    public String getName() { return name; }
}
```

**å¯¹åº”çš„ResultMapé…ç½®**ï¼š
```xml
<resultMap id="immutableUserMap" type="User">
    <constructor>
        <!-- å‚æ•°é¡ºåºå¿…é¡»å’Œæ„é€ å™¨ä¸€è‡´ -->
        <idArg column="user_id" javaType="long"/>
        <arg column="user_name" javaType="string"/>
    </constructor>
</resultMap>
```

> âš ï¸ **æ³¨æ„**ï¼š`<idArg>`å¯¹åº”ä¸»é”®å‚æ•°ï¼Œ`<arg>`å¯¹åº”æ™®é€šå‚æ•°ï¼Œé¡ºåºå¿…é¡»å’Œæ„é€ å™¨å‚æ•°é¡ºåºä¸€è‡´

---

## 3. ğŸ”— å…³è”å…³ç³»æ˜ å°„


### 3.1 å…³è”å…³ç³»æ¦‚è¿°


**æ•°æ®åº“å…³ç³»çš„ä¸‰ç§ç±»å‹**ï¼š

```
ä¸€å¯¹ä¸€ï¼ˆ1:1ï¼‰              ä¸€å¯¹å¤šï¼ˆ1:Nï¼‰              å¤šå¯¹å¤šï¼ˆM:Nï¼‰
ç”¨æˆ· â†â†’ èº«ä»½è¯             ç”¨æˆ· â†â†’ è®¢å•               å­¦ç”Ÿ â†â†’ è¯¾ç¨‹
User    IdCard           User    Order             Student  Course
                                                   (é€šè¿‡ä¸­é—´è¡¨å…³è”)
```

**MyBatisçš„ä¸¤ç§æ˜ å°„æ–¹å¼**ï¼š

| æ–¹å¼ | å®ç° | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|------|
| **åµŒå¥—æŸ¥è¯¢** | å‘é€å¤šæ¡SQL | çµæ´»ã€æ”¯æŒå»¶è¿ŸåŠ è½½ | å¯èƒ½äº§ç”ŸN+1é—®é¢˜ |
| **åµŒå¥—ç»“æœ** | ä¸€æ¡SQL JOINæŸ¥è¯¢ | æ€§èƒ½å¥½ã€ä¸€æ¬¡æŸ¥è¯¢ | ä¸æ”¯æŒå»¶è¿ŸåŠ è½½ |

### 3.2 ä¸€å¯¹ä¸€å…³ç³»æ˜ å°„


**ä¸šåŠ¡åœºæ™¯**ï¼šç”¨æˆ·å’Œèº«ä»½è¯æ˜¯ä¸€å¯¹ä¸€å…³ç³»

```
ç”¨æˆ·è¡¨(user)                 èº«ä»½è¯è¡¨(id_card)
+----+-------+               +----+---------+--------+
| id | name  |               | id | user_id | number |
+----+-------+               +----+---------+--------+
| 1  | å¼ ä¸‰  |      â†â†’       | 1  |    1    | 123456 |
+----+-------+               +----+---------+--------+
```

**Javaå¯¹è±¡ç»“æ„**ï¼š
```java
public class User {
    private Long id;
    private String name;
    private IdCard idCard;  // å…³è”çš„èº«ä»½è¯å¯¹è±¡
}

public class IdCard {
    private Long id;
    private Long userId;
    private String number;
}
```

**æ–¹å¼1ï¼šåµŒå¥—æŸ¥è¯¢ï¼ˆåˆ†æ­¥æŸ¥è¯¢ï¼‰**
```xml
<!-- ç”¨æˆ·æ˜ å°„ -->
<resultMap id="userWithCardMap" type="User">
    <id column="id" property="id"/>
    <result column="name" property="name"/>
    <!-- associationï¼šä¸€å¯¹ä¸€å…³è” -->
    <association 
        property="idCard" 
        column="id" 
        select="selectIdCardByUserId"/>
</resultMap>

<select id="selectUser" resultMap="userWithCardMap">
    SELECT id, name FROM user WHERE id = #{id}
</select>

<!-- ç¬¬äºŒæ­¥ï¼šæŸ¥è¯¢èº«ä»½è¯ -->
<select id="selectIdCardByUserId" resultType="IdCard">
    SELECT * FROM id_card WHERE user_id = #{userId}
</select>
```

**æ‰§è¡Œæµç¨‹**ï¼š
```
1. æ‰§è¡Œï¼šSELECT id, name FROM user WHERE id = 1
   å¾—åˆ°ï¼šUser(id=1, name="å¼ ä¸‰")

2. å‘ç°éœ€è¦åŠ è½½idCardï¼Œæ‰§è¡Œï¼š
   SELECT * FROM id_card WHERE user_id = 1
   å¾—åˆ°ï¼šIdCard(number="123456")

3. ç»„è£…ï¼šUserå¯¹è±¡.idCard = IdCardå¯¹è±¡
```

**æ–¹å¼2ï¼šåµŒå¥—ç»“æœï¼ˆJOINæŸ¥è¯¢ï¼‰**
```xml
<resultMap id="userWithCardMap2" type="User">
    <id column="user_id" property="id"/>
    <result column="user_name" property="name"/>
    <!-- ç›´æ¥æ˜ å°„åµŒå¥—ç»“æœ -->
    <association property="idCard" javaType="IdCard">
        <id column="card_id" property="id"/>
        <result column="card_number" property="number"/>
    </association>
</resultMap>

<select id="selectUserWithCard" resultMap="userWithCardMap2">
    SELECT 
        u.id as user_id,
        u.name as user_name,
        c.id as card_id,
        c.number as card_number
    FROM user u
    LEFT JOIN id_card c ON u.id = c.user_id
    WHERE u.id = #{id}
</select>
```

**æ‰§è¡Œæµç¨‹**ï¼š
```
1. ä¸€æ¬¡JOINæŸ¥è¯¢å¾—åˆ°ï¼š
   user_id | user_name | card_id | card_number
   1       | å¼ ä¸‰      | 1       | 123456

2. MyBatisè‡ªåŠ¨ç»„è£…ï¼š
   User(id=1, name="å¼ ä¸‰", 
        idCard=IdCard(id=1, number="123456"))
```

### 3.3 ä¸€å¯¹å¤šå…³ç³»æ˜ å°„


**ä¸šåŠ¡åœºæ™¯**ï¼šä¸€ä¸ªç”¨æˆ·æœ‰å¤šä¸ªè®¢å•

```
ç”¨æˆ·è¡¨(user)                 è®¢å•è¡¨(orders)
+----+-------+               +----+---------+--------+
| id | name  |               | id | user_id | amount |
+----+-------+               +----+---------+--------+
| 1  | å¼ ä¸‰  |      â†â†’       | 1  |    1    | 100.0  |
+----+-------+               | 2  |    1    | 200.0  |
                             +----+---------+--------+
```

**Javaå¯¹è±¡ç»“æ„**ï¼š
```java
public class User {
    private Long id;
    private String name;
    private List<Order> orders;  // ä¸€å¯¹å¤šï¼šè®¢å•é›†åˆ
}

public class Order {
    private Long id;
    private Long userId;
    private BigDecimal amount;
}
```

**æ–¹å¼1ï¼šåµŒå¥—æŸ¥è¯¢**
```xml
<resultMap id="userWithOrdersMap" type="User">
    <id column="id" property="id"/>
    <result column="name" property="name"/>
    <!-- collectionï¼šä¸€å¯¹å¤šå…³è” -->
    <collection 
        property="orders" 
        column="id" 
        select="selectOrdersByUserId"/>
</resultMap>

<select id="selectUser" resultMap="userWithOrdersMap">
    SELECT id, name FROM user WHERE id = #{id}
</select>

<select id="selectOrdersByUserId" resultType="Order">
    SELECT * FROM orders WHERE user_id = #{userId}
</select>
```

**æ–¹å¼2ï¼šåµŒå¥—ç»“æœ**
```xml
<resultMap id="userWithOrdersMap2" type="User">
    <id column="user_id" property="id"/>
    <result column="user_name" property="name"/>
    <!-- ofTypeï¼šé›†åˆä¸­å…ƒç´ çš„ç±»å‹ -->
    <collection property="orders" ofType="Order">
        <id column="order_id" property="id"/>
        <result column="order_amount" property="amount"/>
    </collection>
</resultMap>

<select id="selectUserWithOrders" resultMap="userWithOrdersMap2">
    SELECT 
        u.id as user_id,
        u.name as user_name,
        o.id as order_id,
        o.amount as order_amount
    FROM user u
    LEFT JOIN orders o ON u.id = o.user_id
    WHERE u.id = #{id}
</select>
```

**æŸ¥è¯¢ç»“æœç»„è£…è¿‡ç¨‹**ï¼š
```
æ•°æ®åº“è¿”å›ï¼š
user_id | user_name | order_id | order_amount
1       | å¼ ä¸‰      | 1        | 100.0
1       | å¼ ä¸‰      | 2        | 200.0

MyBatisè¯†åˆ«ï¼š
- user_idç›¸åŒ â†’ æ˜¯åŒä¸€ä¸ªUserå¯¹è±¡
- order_idä¸åŒ â†’ æ˜¯ä¸åŒçš„Orderå¯¹è±¡

æœ€ç»ˆç»„è£…ï¼š
User(id=1, name="å¼ ä¸‰", 
     orders=[
         Order(id=1, amount=100.0),
         Order(id=2, amount=200.0)
     ])
```

### 3.4 å¤šå¯¹å¤šå…³ç³»æ˜ å°„


**ä¸šåŠ¡åœºæ™¯**ï¼šå­¦ç”Ÿå’Œè¯¾ç¨‹æ˜¯å¤šå¯¹å¤šå…³ç³»

```
å­¦ç”Ÿè¡¨(student)        ä¸­é—´è¡¨(student_course)        è¯¾ç¨‹è¡¨(course)
+----+-------+         +------------+----------+      +----+--------+
| id | name  |         | student_id | course_id|      | id | name   |
+----+-------+         +------------+----------+      +----+--------+
| 1  | å¼ ä¸‰  |    â†â†’   | 1          | 1        | â†â†’   | 1  | æ•°å­¦   |
| 2  | æå››  |         | 1          | 2        |      | 2  | è‹±è¯­   |
+----+-------+         | 2          | 1        |      +----+--------+
                       +------------+----------+
```

**Javaå¯¹è±¡ç»“æ„**ï¼š
```java
public class Student {
    private Long id;
    private String name;
    private List<Course> courses;  // å­¦ç”Ÿé€‰çš„è¯¾ç¨‹
}

public class Course {
    private Long id;
    private String name;
}
```

**ResultMapé…ç½®**ï¼š
```xml
<resultMap id="studentWithCoursesMap" type="Student">
    <id column="student_id" property="id"/>
    <result column="student_name" property="name"/>
    <collection property="courses" ofType="Course">
        <id column="course_id" property="id"/>
        <result column="course_name" property="name"/>
    </collection>
</resultMap>

<select id="selectStudentWithCourses" resultMap="studentWithCoursesMap">
    SELECT 
        s.id as student_id,
        s.name as student_name,
        c.id as course_id,
        c.name as course_name
    FROM student s
    LEFT JOIN student_course sc ON s.id = sc.student_id
    LEFT JOIN course c ON sc.course_id = c.id
    WHERE s.id = #{id}
</select>
```

---

## 4. ğŸš€ é«˜çº§æ˜ å°„æŠ€æœ¯


### 4.1 discriminator é‰´åˆ«å™¨æ˜ å°„


**ä»€ä¹ˆæ˜¯é‰´åˆ«å™¨**ï¼šæ ¹æ®æŸä¸ªå­—æ®µçš„å€¼ï¼Œå†³å®šç”¨å“ªä¸ªResultMapæ¥æ˜ å°„ç»“æœ

**ä¸šåŠ¡åœºæ™¯**ï¼šè½¦è¾†è¡¨ï¼Œæ ¹æ®è½¦è¾†ç±»å‹ï¼ˆå°æ±½è½¦/å¡è½¦ï¼‰æ˜ å°„åˆ°ä¸åŒçš„å¯¹è±¡

```java
// åŸºç±»
public class Vehicle {
    private Long id;
    private String type;  // "CAR" æˆ– "TRUCK"
}

// å°æ±½è½¦ï¼šæœ‰åº§ä½æ•°
public class Car extends Vehicle {
    private Integer seatCount;
}

// å¡è½¦ï¼šæœ‰è½½é‡é‡
public class Truck extends Vehicle {
    private Integer loadCapacity;
}
```

**é‰´åˆ«å™¨é…ç½®**ï¼š
```xml
<resultMap id="vehicleMap" type="Vehicle">
    <id column="id" property="id"/>
    <result column="type" property="type"/>
    
    <!-- æ ¹æ®typeå­—æ®µçš„å€¼é€‰æ‹©ä¸åŒçš„æ˜ å°„ -->
    <discriminator javaType="string" column="type">
        <!-- type = 'CAR' æ—¶ç”¨è¿™ä¸ªæ˜ å°„ -->
        <case value="CAR" resultType="Car">
            <result column="seat_count" property="seatCount"/>
        </case>
        <!-- type = 'TRUCK' æ—¶ç”¨è¿™ä¸ªæ˜ å°„ -->
        <case value="TRUCK" resultType="Truck">
            <result column="load_capacity" property="loadCapacity"/>
        </case>
    </discriminator>
</resultMap>
```

**æ‰§è¡Œæ•ˆæœ**ï¼š
```
æŸ¥è¯¢ï¼šSELECT * FROM vehicle WHERE id = 1
ç»“æœï¼šid=1, type='CAR', seat_count=5

MyBatiså¤„ç†ï¼š
1. è¯»å–typeå­—æ®µå€¼ä¸º'CAR'
2. åŒ¹é…åˆ°<case value="CAR">
3. åˆ›å»ºCarå¯¹è±¡å¹¶æ˜ å°„seatCountå±æ€§
4. è¿”å›ï¼šCar(id=1, type="CAR", seatCount=5)
```

### 4.2 çº§è”æŸ¥è¯¢ä¼˜åŒ–


**N+1æŸ¥è¯¢é—®é¢˜**ï¼š

```
å‡è®¾æŸ¥è¯¢10ä¸ªç”¨æˆ·åŠå…¶è®¢å•ï¼š

åµŒå¥—æŸ¥è¯¢æ–¹å¼ï¼š
1. SELECT * FROM user          -- 1æ¬¡æŸ¥è¯¢
2. SELECT * FROM orders WHERE user_id = 1   -- ç”¨æˆ·1çš„è®¢å•
3. SELECT * FROM orders WHERE user_id = 2   -- ç”¨æˆ·2çš„è®¢å•
...
11. SELECT * FROM orders WHERE user_id = 10  -- ç”¨æˆ·10çš„è®¢å•

æ€»å…±ï¼š1 + 10 = 11æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼ˆN+1é—®é¢˜ï¼‰
```

**ä¼˜åŒ–æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | SQLæ¬¡æ•° | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|------|------|
| åµŒå¥—æŸ¥è¯¢ | N+1æ¬¡ | æ”¯æŒå»¶è¿ŸåŠ è½½ | æŸ¥è¯¢æ¬¡æ•°å¤š |
| åµŒå¥—ç»“æœ | 1æ¬¡ | æ€§èƒ½å¥½ | æ•°æ®å†—ä½™ |
| æ‰¹é‡æŸ¥è¯¢ | 2æ¬¡ | å¹³è¡¡æ€§èƒ½ | éœ€è¦è‡ªå®šä¹‰ |

**æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹**ï¼š
```xml
<!-- å…ˆæŸ¥æ‰€æœ‰ç”¨æˆ· -->
<select id="selectUsers" resultType="User">
    SELECT * FROM user
</select>

<!-- å†æ‰¹é‡æŸ¥è¿™äº›ç”¨æˆ·çš„è®¢å• -->
<select id="selectOrdersByUserIds" resultType="Order">
    SELECT * FROM orders 
    WHERE user_id IN
    <foreach collection="userIds" item="id" open="(" close=")" separator=",">
        #{id}
    </foreach>
</select>
```

> ğŸ’¡ **æœ€ä½³å®è·µ**ï¼šå°‘é‡æ•°æ®ç”¨JOINï¼Œå¤§é‡æ•°æ®ç”¨åˆ†æ­¥+æ‰¹é‡æŸ¥è¯¢

---

## 5. âš¡ å»¶è¿ŸåŠ è½½ä¸æ€§èƒ½ä¼˜åŒ–


### 5.1 ä»€ä¹ˆæ˜¯å»¶è¿ŸåŠ è½½


**æ¦‚å¿µç†è§£**ï¼šå»¶è¿ŸåŠ è½½ï¼ˆLazy Loadingï¼‰å°±æ˜¯"ç”¨åˆ°çš„æ—¶å€™å†æŸ¥è¯¢ï¼Œä¸ç”¨ä¸æŸ¥"

```
ç«‹å³åŠ è½½ï¼š
ç”¨æˆ· user = userMapper.selectById(1);
System.out.println(user.getName());      // æŸ¥ç”¨æˆ·
System.out.println(user.getOrders());    // æŸ¥è®¢å•ï¼ˆåŒæ—¶æŸ¥è¯¢ï¼‰

å»¶è¿ŸåŠ è½½ï¼š
ç”¨æˆ· user = userMapper.selectById(1);
System.out.println(user.getName());      // åªæŸ¥ç”¨æˆ·
// æ­¤æ—¶è¿˜æ²¡æŸ¥è®¢å•
System.out.println(user.getOrders());    // è®¿é—®æ—¶æ‰æŸ¥è®¢å•
```

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… å…³è”æ•°æ®**ä¸ä¸€å®šç”¨åˆ°**
- âœ… å…³è”æ•°æ®**æ•°æ®é‡å¤§**
- âœ… å¸Œæœ›**å‡å°‘ä¸å¿…è¦çš„æŸ¥è¯¢**

### 5.2 å»¶è¿ŸåŠ è½½é…ç½®


**å…¨å±€é…ç½®ï¼ˆmybatis-config.xmlï¼‰**ï¼š
```xml
<settings>
    <!-- å¼€å¯å»¶è¿ŸåŠ è½½ -->
    <setting name="lazyLoadingEnabled" value="true"/>
    <!-- æŒ‰éœ€åŠ è½½ï¼ˆæ¨èï¼‰ -->
    <setting name="aggressiveLazyLoading" value="false"/>
</settings>
```

**å±€éƒ¨é…ç½®ï¼ˆResultMapä¸­ï¼‰**ï¼š
```xml
<resultMap id="userMap" type="User">
    <id column="id" property="id"/>
    <result column="name" property="name"/>
    <!-- fetchType="lazy"ï¼šå»¶è¿ŸåŠ è½½ -->
    <collection 
        property="orders" 
        column="id" 
        select="selectOrdersByUserId"
        fetchType="lazy"/>
</resultMap>
```

**é…ç½®é€‰é¡¹è¯´æ˜**ï¼š

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| `lazyLoadingEnabled` | `true/false` | æ˜¯å¦å¯ç”¨å»¶è¿ŸåŠ è½½ |
| `aggressiveLazyLoading` | `true/false` | `false`=æŒ‰éœ€åŠ è½½ï¼Œ`true`=è®¿é—®ä»»ä½•å±æ€§éƒ½åŠ è½½å…¨éƒ¨ |
| `fetchType` | `lazy/eager` | å±€éƒ¨é…ç½®ï¼š`lazy`å»¶è¿Ÿï¼Œ`eager`ç«‹å³ |

### 5.3 å»¶è¿ŸåŠ è½½åŸç†


**MyBatiså»¶è¿ŸåŠ è½½å®ç°**ï¼š
```
1. æŸ¥è¯¢ä¸»å¯¹è±¡æ—¶ï¼Œå…³è”å¯¹è±¡è®¾ä¸ºä»£ç†å¯¹è±¡
   User user = new User();
   user.orders = ProxyOrders;  // ä»£ç†å¯¹è±¡

2. è®¿é—®å…³è”å¯¹è±¡æ—¶ï¼Œè§¦å‘ä»£ç†æ‰§è¡ŒæŸ¥è¯¢
   user.getOrders() 
   â†’ ä»£ç†æ‹¦æˆª
   â†’ æ‰§è¡Œ selectOrdersByUserId
   â†’ è¿”å›çœŸå®è®¢å•æ•°æ®

3. åç»­è®¿é—®ç›´æ¥è¿”å›å·²åŠ è½½çš„æ•°æ®
   user.getOrders()  // ç›´æ¥è¿”å›ï¼Œä¸å†æŸ¥è¯¢
```

> âš ï¸ **æ³¨æ„**ï¼šå»¶è¿ŸåŠ è½½**åªå¯¹åµŒå¥—æŸ¥è¯¢æœ‰æ•ˆ**ï¼ŒåµŒå¥—ç»“æœï¼ˆJOINï¼‰ä¸æ”¯æŒå»¶è¿ŸåŠ è½½

### 5.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ä¼˜åŒ–ç­–ç•¥æ€»ç»“**ï¼š

```
ğŸ”¸ åœºæ™¯1ï¼šæ•°æ®é‡å°ã€ç»å¸¸ä¸€èµ·ç”¨
   â†’ ä½¿ç”¨JOINåµŒå¥—ç»“æœï¼Œä¸€æ¬¡æŸ¥è¯¢å…¨éƒ¨

ğŸ”¸ åœºæ™¯2ï¼šå…³è”æ•°æ®ä¸ä¸€å®šç”¨
   â†’ ä½¿ç”¨åµŒå¥—æŸ¥è¯¢ + å»¶è¿ŸåŠ è½½

ğŸ”¸ åœºæ™¯3ï¼šå…³è”æ•°æ®é‡å¤§
   â†’ ä½¿ç”¨åˆ†é¡µ + æŒ‰éœ€åŠ è½½

ğŸ”¸ åœºæ™¯4ï¼šé«˜å¹¶å‘åœºæ™¯
   â†’ é¿å…N+1é—®é¢˜ï¼Œç”¨æ‰¹é‡æŸ¥è¯¢
```

**å®é™…ä¾‹å­**ï¼š
```java
// åœºæ™¯ï¼šæŸ¥è¯¢è®¢å•åˆ—è¡¨ï¼Œå¯èƒ½éœ€è¦æŸ¥çœ‹è®¢å•è¯¦æƒ…
public class OrderService {
    
    // åˆ—è¡¨é¡µï¼šåªéœ€è¦è®¢å•åŸºæœ¬ä¿¡æ¯
    public List<Order> listOrders() {
        // ä¸åŠ è½½è®¢å•è¯¦æƒ…ï¼Œæé«˜åˆ—è¡¨æ€§èƒ½
        return orderMapper.selectOrders();
    }
    
    // è¯¦æƒ…é¡µï¼šéœ€è¦å®Œæ•´ä¿¡æ¯
    public Order getOrderDetail(Long id) {
        // ä½¿ç”¨JOINä¸€æ¬¡æ€§æŸ¥è¯¢ï¼Œé¿å…N+1
        return orderMapper.selectOrderWithDetails(id);
    }
}
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | æŸ¥è¯¢100ä¸ªè®¢å•è€—æ—¶ | é€‚ç”¨åœºæ™¯ |
|------|------------------|----------|
| ä¸åŠ è½½å…³è” | ~10ms | åˆ—è¡¨å±•ç¤º |
| å»¶è¿ŸåŠ è½½ | ~10ms + æŒ‰éœ€æŸ¥è¯¢ | éƒ¨åˆ†éœ€è¦è¯¦æƒ… |
| JOINæŸ¥è¯¢ | ~50ms | å¿…å®šéœ€è¦è¯¦æƒ… |
| N+1æŸ¥è¯¢ | ~1000ms âŒ | åº”è¯¥é¿å… |

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ResultMapä½œç”¨ï¼šå‘Šè¯‰MyBatiså¦‚ä½•æŠŠæŸ¥è¯¢ç»“æœè£…åˆ°Javaå¯¹è±¡
ğŸ”¸ id vs resultï¼šidæ ‡è¯†ä¸»é”®ï¼Œresultæ˜ å°„æ™®é€šå­—æ®µ
ğŸ”¸ associationï¼šå¤„ç†ä¸€å¯¹ä¸€å…³è”
ğŸ”¸ collectionï¼šå¤„ç†ä¸€å¯¹å¤šå…³è”
ğŸ”¸ åµŒå¥—æŸ¥è¯¢ vs åµŒå¥—ç»“æœï¼šåˆ†æ­¥æŸ¥è¯¢ vs JOINæŸ¥è¯¢
ğŸ”¸ å»¶è¿ŸåŠ è½½ï¼šç”¨åˆ°æ‰æŸ¥ï¼Œæé«˜æ€§èƒ½
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä½•æ—¶ç”¨ResultMap**
```
ç®€å•åœºæ™¯ï¼šå­—æ®µåä¸€è‡´ â†’ è‡ªåŠ¨æ˜ å°„
å¤æ‚åœºæ™¯ï¼š
â€¢ å¤šè¡¨å…³è”
â€¢ ä¸€å¯¹å¤š/å¤šå¯¹å¤š
â€¢ å­—æ®µåä¸å¯¹åº”
â€¢ éœ€è¦ç±»å‹è½¬æ¢
â†’ å¿…é¡»ç”¨ResultMap
```

**ğŸ”¹ å…³è”æ˜ å°„é€‰æ‹©**
```
ä¸€å¯¹ä¸€ï¼š
â€¢ ç”¨<association>
â€¢ é€šå¸¸ç”¨JOINæ€§èƒ½æ›´å¥½

ä¸€å¯¹å¤šï¼š
â€¢ ç”¨<collection>  
â€¢ æ•°æ®é‡å°ç”¨JOINï¼Œæ•°æ®é‡å¤§ç”¨åµŒå¥—æŸ¥è¯¢+å»¶è¿ŸåŠ è½½

å¤šå¯¹å¤šï¼š
â€¢ ä¹Ÿæ˜¯ç”¨<collection>
â€¢ éœ€è¦å…³è”ä¸­é—´è¡¨
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–æ€è·¯**
```
é¿å…N+1é—®é¢˜ï¼š
â€¢ ä¼˜å…ˆç”¨JOINï¼ˆåµŒå¥—ç»“æœï¼‰
â€¢ æ— æ³•JOINæ—¶ç”¨æ‰¹é‡æŸ¥è¯¢
â€¢ æˆ–è€…ç”¨å»¶è¿ŸåŠ è½½æŒ‰éœ€æŸ¥è¯¢

æƒè¡¡å–èˆï¼š
â€¢ JOINï¼šä¸€æ¬¡æŸ¥è¯¢ï¼Œæ•°æ®å¯èƒ½å†—ä½™
â€¢ åˆ†æ­¥ï¼šæŸ¥è¯¢çµæ´»ï¼Œå¯èƒ½å¤šæ¬¡æŸ¥è¯¢
â€¢ æ ¹æ®å®é™…åœºæ™¯é€‰æ‹©
```

### 6.3 å®é™…åº”ç”¨å»ºè®®


**é…ç½®å»ºè®®**ï¼š
```xml
<!-- æ¨èçš„å…¨å±€é…ç½® -->
<settings>
    <!-- é©¼å³°å‘½åè½¬æ¢ -->
    <setting name="mapUnderscoreToCamelCase" value="true"/>
    <!-- å»¶è¿ŸåŠ è½½ -->
    <setting name="lazyLoadingEnabled" value="true"/>
    <setting name="aggressiveLazyLoading" value="false"/>
</settings>
```

**ä½¿ç”¨æŠ€å·§**ï¼š
- âœ… ä¸»é”®ä¸€å®šè¦ç”¨`<id>`ï¼Œè€Œä¸æ˜¯`<result>`
- âœ… åµŒå¥—ç»“æœçš„åˆ—åè¦ç”¨åˆ«åé¿å…é‡å
- âœ… collectionçš„`ofType`æŒ‡å®šé›†åˆå…ƒç´ ç±»å‹
- âœ… å»¶è¿ŸåŠ è½½åªåœ¨sessionå†…æœ‰æ•ˆ
- âœ… å¤æ‚æŸ¥è¯¢ä¼˜å…ˆè€ƒè™‘JOINæ€§èƒ½

**å¸¸è§é”™è¯¯é¿å…**ï¼š
- âŒ å¿˜è®°é…ç½®ä¸»é”®æ˜ å°„å¯¼è‡´ç¼“å­˜å¤±æ•ˆ
- âŒ åµŒå¥—ç»“æœåˆ—åé‡å¤å¯¼è‡´æ•°æ®é”™ä¹±
- âŒ å»¶è¿ŸåŠ è½½sessionå…³é—­åè®¿é—®æŠ¥é”™
- âŒ N+1é—®é¢˜å¯¼è‡´æ€§èƒ½æ€¥å‰§ä¸‹é™

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ç»“æœæ˜ å°„è§£å†³å­—æ®µå¯¹åº”ï¼Œ
idæ ‡ä¸»é”®resultæ™®é€šï¼Œ
ä¸€å¯¹ä¸€ç”¨associationï¼Œ
ä¸€å¯¹å¤šç”¨collectionè£…ï¼Œ
åµŒå¥—æŸ¥è¯¢æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Œ
åµŒå¥—ç»“æœJOINæ€§èƒ½å¥½ï¼Œ
æ ¹æ®åœºæ™¯çµæ´»é€‰æ‹©ï¼Œ
é¿å…N+1æ˜¯å…³é”®è¦ç‚¹
```