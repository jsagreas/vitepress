---
title: 2ã€MyBatisè¿è¡Œæ¶æ„
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯MyBatisæ¶æ„](#1-ä»€ä¹ˆæ˜¯MyBatisæ¶æ„)
2. [ä¸‰å±‚æ¶æ„è®¾è®¡](#2-ä¸‰å±‚æ¶æ„è®¾è®¡)
3. [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#3-æ ¸å¿ƒç»„ä»¶è¯¦è§£)
4. [ç»„ä»¶åä½œæµç¨‹](#4-ç»„ä»¶åä½œæµç¨‹)
5. [ç”Ÿå‘½å‘¨æœŸç®¡ç†](#5-ç”Ÿå‘½å‘¨æœŸç®¡ç†)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ ä»€ä¹ˆæ˜¯MyBatisæ¶æ„


### 1.1 æ¶æ„çš„æœ¬è´¨


**é€šä¿—ç†è§£**ï¼šæŠŠMyBatisæƒ³è±¡æˆä¸€ä¸ªé¤å…

```
é¡¾å®¢ç‚¹èœï¼ˆåº”ç”¨è°ƒç”¨ï¼‰
    â†“
æœåŠ¡å‘˜æ¥å•ï¼ˆæ¥å£å±‚ï¼‰
    â†“
å¨æˆ¿åšèœï¼ˆæ•°æ®å¤„ç†å±‚ï¼‰
    â†“
åŸºç¡€è®¾æ–½ï¼ˆæ°´ç”µç…¤æ°” - æ”¯æŒå±‚ï¼‰
```

MyBatisçš„æ¶æ„å°±æ˜¯æŠŠè¿™ä¸ª"é¤å…"çš„å„ä¸ªéƒ¨é—¨ç»„ç»‡èµ·æ¥ï¼Œè®©å®ƒä»¬**åˆ†å·¥æ˜ç¡®ã€åä½œé«˜æ•ˆ**ã€‚

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ¶æ„è®¾è®¡


**é—®é¢˜åœºæ™¯**ï¼š
- å¦‚æœæ‰€æœ‰ä»£ç æ··åœ¨ä¸€èµ· â†’ éš¾ä»¥ç»´æŠ¤ã€æ”¹åŠ¨ç‰µä¸€å‘åŠ¨å…¨èº«
- å¦‚æœèŒè´£ä¸æ¸…æ™° â†’ å‡ºäº†é—®é¢˜ä¸çŸ¥é“æ‰¾å“ªä¸ªæ¨¡å—

**æ¶æ„è®¾è®¡çš„å¥½å¤„**ï¼š
- âœ… **èŒè´£åˆ†æ˜**ï¼šæ¯ä¸ªæ¨¡å—åªåšè‡ªå·±çš„äº‹
- âœ… **æ˜“äºæ‰©å±•**ï¼šæƒ³åŠ åŠŸèƒ½ä¸å½±å“å…¶ä»–éƒ¨åˆ†
- âœ… **æ–¹ä¾¿ç»´æŠ¤**ï¼šå‡ºé—®é¢˜çŸ¥é“å»å“ªæ‰¾
- âœ… **æé«˜å¤ç”¨**ï¼šé€šç”¨åŠŸèƒ½å¯ä»¥è¢«é‡å¤ä½¿ç”¨

---

## 2. ğŸ¯ ä¸‰å±‚æ¶æ„è®¾è®¡


### 2.1 æ•´ä½“æ¶æ„å›¾ç¤º


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          åº”ç”¨ç¨‹åºï¼ˆä½ çš„ä»£ç ï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ã€æ¥å£å±‚ - Interfaceã€‘           â”‚  â† å¯¹å¤–æä¾›æœåŠ¡
â”‚    SqlSessionã€Mapperæ¥å£                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ã€æ•°æ®å¤„ç†å±‚ - Coreã€‘               â”‚  â† æ ¸å¿ƒä¸šåŠ¡å¤„ç†
â”‚  Executorã€StatementHandlerã€             â”‚
â”‚  ParameterHandlerã€ResultSetHandler      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ã€åŸºç¡€æ”¯æŒå±‚ - Supportã€‘            â”‚  â† æä¾›åŸºç¡€èƒ½åŠ›
â”‚  è¿æ¥ç®¡ç†ã€äº‹åŠ¡ç®¡ç†ã€ç¼“å­˜ã€æ—¥å¿—           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            æ•°æ®åº“ï¼ˆMySQL/Oracleç­‰ï¼‰
```

### 2.2 ä¸‰å±‚èŒè´£è¯´æ˜


| å±‚æ¬¡ | **ä½œç”¨** | **ç±»æ¯”è¯´æ˜** | **æ ¸å¿ƒç»„ä»¶** |
|------|---------|-------------|-------------|
| **æ¥å£å±‚** | `å¯¹å¤–æä¾›APIæœåŠ¡` | `é¤å…å‰å°æœåŠ¡å‘˜` | `SqlSessionã€Mapper` |
| **æ•°æ®å¤„ç†å±‚** | `æ‰§è¡ŒSQLå’Œæ•°æ®æ˜ å°„` | `åå¨å¨å¸ˆå›¢é˜Ÿ` | `Executorã€Handler` |
| **åŸºç¡€æ”¯æŒå±‚** | `æä¾›åº•å±‚æ”¯æŒèƒ½åŠ›` | `æ°´ç”µç…¤æ°”è®¾æ–½` | `è¿æ¥æ± ã€ç¼“å­˜ã€äº‹åŠ¡` |

### 2.3 å±‚æ¬¡é—´çš„è°ƒç”¨å…³ç³»


```
ç”¨æˆ·è°ƒç”¨ â†’ æ¥å£å±‚æ¥æ”¶è¯·æ±‚
         â†“
      æ¥å£å±‚å§”æ‰˜ç»™æ•°æ®å¤„ç†å±‚
         â†“
      æ•°æ®å¤„ç†å±‚ä½¿ç”¨åŸºç¡€æ”¯æŒå±‚
         â†“
      åŸºç¡€æ”¯æŒå±‚è®¿é—®æ•°æ®åº“
         â†“
      ç»“æœé€å±‚è¿”å›ç»™ç”¨æˆ·
```

**å…³é”®ç†è§£**ï¼š
- ä¸Šå±‚ä¾èµ–ä¸‹å±‚ï¼Œä¸‹å±‚ä¸çŸ¥é“ä¸Šå±‚å­˜åœ¨
- æ¯ä¸€å±‚åªå…³å¿ƒè‡ªå·±çš„èŒè´£
- å±‚ä¸å±‚ä¹‹é—´é€šè¿‡æ¥å£é€šä¿¡

---

## 3. ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£


### 3.1 æ¥å£å±‚ç»„ä»¶ â­â­â­


#### SqlSessionFactoryBuilderï¼ˆå»ºé€ è€…ï¼‰


**æ˜¯ä»€ä¹ˆ**ï¼šSqlSessionFactoryçš„æ„å»ºå·¥å…·ï¼Œå°±åƒ**å»ºç­‘å·¥ç¨‹é˜Ÿ**

**ä½œç”¨**ï¼š
- è¯»å–é…ç½®æ–‡ä»¶ï¼ˆ`mybatis-config.xml`ï¼‰
- åˆ›å»ºSqlSessionFactoryå·¥å‚å¯¹è±¡
- ä¸€æ¬¡æ€§å·¥å…·ï¼Œç”¨å®Œå³ä¸¢

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// 1. è¯»é…ç½®æ–‡ä»¶
InputStream inputStream = Resources.getResourceAsStream("mybatis-config.xml");

// 2. åˆ›å»ºå·¥å‚ï¼ˆå»ºé€ è€…å·¥ä½œï¼‰
SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(inputStream);

// 3. Builderä½¿å‘½å®Œæˆï¼Œå¯ä»¥ä¸¢å¼ƒäº†
```

**ç”Ÿå‘½å‘¨æœŸ**ï¼š`æ–¹æ³•çº§åˆ«` - åˆ›å»ºå®Œå·¥å‚å°±ä¸éœ€è¦äº†

---

#### SqlSessionFactoryï¼ˆå·¥å‚ï¼‰


**æ˜¯ä»€ä¹ˆ**ï¼šSqlSessionçš„ç”Ÿäº§å·¥å‚ï¼Œå°±åƒ**æ±½è½¦ç”Ÿäº§çº¿**

**ä½œç”¨**ï¼š
- åˆ›å»ºSqlSessionä¼šè¯å¯¹è±¡
- ç®¡ç†å…¨å±€é…ç½®ä¿¡æ¯
- åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºä¸€æ¬¡ï¼Œå…¨å±€å…±äº«

**é€šä¿—ç±»æ¯”**ï¼š
```
SqlSessionFactory = æ±½è½¦å·¥å‚
SqlSession = ç”Ÿäº§å‡ºæ¥çš„æ±½è½¦

å·¥å‚åªéœ€è¦ä¸€ä¸ªï¼Œä½†å¯ä»¥ç”Ÿäº§å¾ˆå¤šæ±½è½¦
```

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// åˆ›å»ºä¼šè¯ï¼ˆç”Ÿäº§æ±½è½¦ï¼‰
SqlSession session = factory.openSession();

// å¯ä»¥åˆ›å»ºå¤šä¸ªä¼šè¯
SqlSession session1 = factory.openSession();
SqlSession session2 = factory.openSession();
```

**ç”Ÿå‘½å‘¨æœŸ**ï¼š`åº”ç”¨çº§åˆ«` - å•ä¾‹æ¨¡å¼ï¼Œå…¨å±€å…±äº«

---

#### SqlSessionï¼ˆä¼šè¯ï¼‰


**æ˜¯ä»€ä¹ˆ**ï¼šMyBatisçš„æ ¸å¿ƒæ¥å£ï¼Œå°±åƒ**æ•°æ®åº“çš„ä¸€æ¬¡ä¼šè¯é€šé“**

**ä½œç”¨**ï¼š
- æ‰§è¡ŒSQLå‘½ä»¤ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
- è·å–Mapperæ¥å£
- ç®¡ç†äº‹åŠ¡ï¼ˆæäº¤ã€å›æ»šï¼‰

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```java
// æ–¹å¼1ï¼šç›´æ¥æ‰§è¡ŒSQLï¼ˆä¸æ¨èï¼‰
User user = session.selectOne("com.example.UserMapper.selectById", 1);

// æ–¹å¼2ï¼šé€šè¿‡Mapperæ¥å£ï¼ˆæ¨èï¼‰
UserMapper mapper = session.getMapper(UserMapper.class);
User user = mapper.selectById(1);

// äº‹åŠ¡ç®¡ç†
session.commit();   // æäº¤äº‹åŠ¡
session.rollback(); // å›æ»šäº‹åŠ¡
session.close();    // å…³é—­ä¼šè¯
```

**ç”Ÿå‘½å‘¨æœŸ**ï¼š`è¯·æ±‚çº§åˆ«` - ç”¨å®Œå¿…é¡»å…³é—­

> âš ï¸ **æ³¨æ„**ï¼šSqlSessionæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½è¦æœ‰è‡ªå·±çš„å®ä¾‹

---

### 3.2 æ•°æ®å¤„ç†å±‚ç»„ä»¶ â­â­â­


#### Executorï¼ˆæ‰§è¡Œå™¨ï¼‰


**æ˜¯ä»€ä¹ˆ**ï¼šSQLçš„çœŸæ­£æ‰§è¡Œè€…ï¼Œå°±åƒ**å¨æˆ¿çš„ä¸»å¨**

**ä¸‰ç§ç±»å‹**ï¼š

| ç±»å‹ | **è¯´æ˜** | **ä½¿ç”¨åœºæ™¯** |
|------|---------|-------------|
| **SimpleExecutor** | `ç®€å•æ‰§è¡Œå™¨ï¼Œæ¯æ¬¡éƒ½åˆ›å»ºæ–°Statement` | `é»˜è®¤æ‰§è¡Œå™¨` |
| **ReuseExecutor** | `é‡ç”¨æ‰§è¡Œå™¨ï¼Œå¤ç”¨Statementå¯¹è±¡` | `SQLè¯­å¥é‡å¤å¤šçš„åœºæ™¯` |
| **BatchExecutor** | `æ‰¹å¤„ç†æ‰§è¡Œå™¨ï¼Œæ‰¹é‡æ‰§è¡ŒSQL` | `å¤§æ‰¹é‡æ’å…¥/æ›´æ–°` |

**å·¥ä½œæµç¨‹**ï¼š
```
1. æ¥æ”¶SqlSessionçš„æŒ‡ä»¤
   â†“
2. è°ƒç”¨StatementHandlerå‡†å¤‡SQL
   â†“
3. è°ƒç”¨ParameterHandlerè®¾ç½®å‚æ•°
   â†“
4. æ‰§è¡ŒSQL
   â†“
5. è°ƒç”¨ResultSetHandlerå¤„ç†ç»“æœ
```

**é…ç½®æ‰§è¡Œå™¨**ï¼š
```java
// åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®š
<settings>
  <setting name="defaultExecutorType" value="SIMPLE"/>
  <!-- å¯é€‰ï¼šSIMPLEã€REUSEã€BATCH -->
</settings>
```

---

#### StatementHandlerï¼ˆè¯­å¥å¤„ç†å™¨ï¼‰


**æ˜¯ä»€ä¹ˆ**ï¼šè´Ÿè´£å¤„ç†SQLè¯­å¥ï¼Œå°±åƒ**æŠŠèœå•ç¿»è¯‘æˆèœå“æŒ‡ä»¤**

**ä½œç”¨**ï¼š
- åˆ›å»ºStatementå¯¹è±¡ï¼ˆPreparedStatement/CallableStatementï¼‰
- è®¾ç½®å‚æ•°
- æ‰§è¡ŒSQL
- å°è£…ç»“æœé›†

**å¤„ç†ç±»å‹**ï¼š
```
SimpleStatementHandler   â†’ å¤„ç†æ™®é€šStatement
PreparedStatementHandler â†’ å¤„ç†é¢„ç¼–è¯‘PreparedStatementï¼ˆå¸¸ç”¨ï¼‰
CallableStatementHandler â†’ å¤„ç†å­˜å‚¨è¿‡ç¨‹CallableStatement
```

---

#### ParameterHandlerï¼ˆå‚æ•°å¤„ç†å™¨ï¼‰


**æ˜¯ä»€ä¹ˆ**ï¼šè´Ÿè´£è®¾ç½®SQLå‚æ•°ï¼Œå°±åƒ**ç»™èœå“é…æ–™**

**ä½œç”¨**ï¼š
```java
// SQL: SELECT * FROM user WHERE id = ? AND name = ?
// 
// ParameterHandlerçš„å·¥ä½œï¼š
// 1. æŠŠJavaå¯¹è±¡çš„å€¼å–å‡ºæ¥
// 2. è®¾ç½®åˆ°SQLçš„ ? å ä½ç¬¦ä¸Š
// 3. å¤„ç†ç±»å‹è½¬æ¢ï¼ˆString â†’ VARCHARã€Integer â†’ INTç­‰ï¼‰
```

**å·¥ä½œç¤ºä¾‹**ï¼š
```
Javaå‚æ•°ï¼šid=1, name="å¼ ä¸‰"
        â†“
ParameterHandlerå¤„ç†
        â†“
SQLå˜æˆï¼šSELECT * FROM user WHERE id = 1 AND name = 'å¼ ä¸‰'
```

---

#### ResultSetHandlerï¼ˆç»“æœå¤„ç†å™¨ï¼‰


**æ˜¯ä»€ä¹ˆ**ï¼šè´Ÿè´£å¤„ç†æŸ¥è¯¢ç»“æœï¼Œå°±åƒ**æŠŠåšå¥½çš„èœè£…ç›˜**

**ä½œç”¨**ï¼š
```java
// æ•°æ®åº“è¿”å›ï¼š
// id | name  | age
// 1  | å¼ ä¸‰  | 20
//
// ResultSetHandlerçš„å·¥ä½œï¼š
// 1. è¯»å–ResultSetç»“æœé›†
// 2. æ˜ å°„åˆ°Javaå¯¹è±¡
// 3. å¤„ç†ç±»å‹è½¬æ¢
//
// æœ€ç»ˆè¿”å›ï¼šUserå¯¹è±¡(id=1, name="å¼ ä¸‰", age=20)
```

**æ˜ å°„æ–¹å¼**ï¼š
- è‡ªåŠ¨æ˜ å°„ï¼šå­—æ®µåå’Œå±æ€§åä¸€è‡´
- æ‰‹åŠ¨æ˜ å°„ï¼šé€šè¿‡`resultMap`é…ç½®

---

### 3.3 åŸºç¡€æ”¯æŒå±‚ç»„ä»¶ â­â­


#### è¿æ¥ç®¡ç†


**æ˜¯ä»€ä¹ˆ**ï¼šç®¡ç†æ•°æ®åº“è¿æ¥ï¼Œå°±åƒ**ç®¡ç†é¤å…çš„æ¡Œä½**

**æ ¸å¿ƒæœºåˆ¶**ï¼š
```
è¿æ¥æ± ï¼ˆConnection Poolï¼‰
â”œâ”€â”€ åˆå§‹åŒ–æ—¶åˆ›å»ºè‹¥å¹²è¿æ¥
â”œâ”€â”€ éœ€è¦æ—¶ä»æ± ä¸­è·å–
â”œâ”€â”€ ç”¨å®Œå½’è¿˜åˆ°æ± ä¸­
â””â”€â”€ é¿å…é¢‘ç¹åˆ›å»º/å…³é—­è¿æ¥
```

**é…ç½®ç¤ºä¾‹**ï¼š
```xml
<dataSource type="POOLED">
  <property name="driver" value="com.mysql.jdbc.Driver"/>
  <property name="url" value="jdbc:mysql://localhost:3306/test"/>
  <property name="poolMaximumActiveConnections" value="10"/>
  <!-- æœ€å¤š10ä¸ªæ´»è·ƒè¿æ¥ -->
</dataSource>
```

---

#### äº‹åŠ¡ç®¡ç†


**æ˜¯ä»€ä¹ˆ**ï¼šæ§åˆ¶äº‹åŠ¡çš„æäº¤å’Œå›æ»šï¼Œå°±åƒ**è®¢å•çš„ç¡®è®¤å’Œå–æ¶ˆ**

**ä¸¤ç§ç®¡ç†æ–¹å¼**ï¼š

```
ã€JDBCäº‹åŠ¡ã€‘- MyBatisè‡ªå·±ç®¡ç†
- æ‰‹åŠ¨commit()æäº¤
- æ‰‹åŠ¨rollback()å›æ»š

ã€MANAGEDäº‹åŠ¡ã€‘- äº¤ç»™å®¹å™¨ç®¡ç†ï¼ˆSpringç­‰ï¼‰
- å®¹å™¨æ§åˆ¶äº‹åŠ¡è¾¹ç•Œ
- MyBatisä¸ä¸»åŠ¨æäº¤
```

**å®é™…ä½¿ç”¨**ï¼š
```java
SqlSession session = factory.openSession(); // é»˜è®¤æ‰‹åŠ¨æäº¤

try {
    // æ‰§è¡ŒSQLæ“ä½œ
    userMapper.insert(user);
    
    session.commit(); // æˆåŠŸåˆ™æäº¤
} catch (Exception e) {
    session.rollback(); // å¤±è´¥åˆ™å›æ»š
} finally {
    session.close();
}
```

---

#### ç¼“å­˜æœºåˆ¶


**æ˜¯ä»€ä¹ˆ**ï¼šæŠŠæŸ¥è¯¢ç»“æœæš‚å­˜èµ·æ¥ï¼Œå°±åƒ**è®°ä½å¸¸ç‚¹çš„èœ**

**ä¸¤çº§ç¼“å­˜**ï¼š

| ç¼“å­˜çº§åˆ« | **ä½œç”¨èŒƒå›´** | **ç”Ÿå‘½å‘¨æœŸ** | **é»˜è®¤å¼€å¯** |
|---------|------------|------------|------------|
| **ä¸€çº§ç¼“å­˜** | `SqlSessionå†…éƒ¨` | `ä¼šè¯çº§åˆ«` | `æ˜¯` |
| **äºŒçº§ç¼“å­˜** | `Mapperçº§åˆ«` | `åº”ç”¨çº§åˆ«` | `å¦ï¼ˆéœ€é…ç½®ï¼‰` |

**ç¼“å­˜ç¤ºä¾‹**ï¼š
```java
// ä¸€çº§ç¼“å­˜ç¤ºä¾‹
SqlSession session = factory.openSession();
UserMapper mapper = session.getMapper(UserMapper.class);

User user1 = mapper.selectById(1); // æŸ¥æ•°æ®åº“
User user2 = mapper.selectById(1); // èµ°ç¼“å­˜ï¼Œä¸æŸ¥æ•°æ®åº“
// user1 == user2 (åŒä¸€ä¸ªå¯¹è±¡)

session.close();
```

**ç¼“å­˜å¤±æ•ˆåœºæ™¯**ï¼š
- æ‰§è¡Œäº†å¢åˆ æ”¹æ“ä½œ
- æ‰‹åŠ¨æ¸…ç©ºç¼“å­˜
- è·¨SqlSessionæŸ¥è¯¢ï¼ˆä¸€çº§ç¼“å­˜å¤±æ•ˆï¼‰

---

## 4. ğŸ”„ ç»„ä»¶åä½œæµç¨‹


### 4.1 å®Œæ•´æ‰§è¡Œæµç¨‹


```
ã€åº”ç”¨ç¨‹åºã€‘
    â†“
è°ƒç”¨Mapperæ¥å£æ–¹æ³•
    â†“
ã€SqlSessionã€‘æ¥æ”¶è¯·æ±‚
    â†“
å§”æ‰˜ç»™ã€Executoræ‰§è¡Œå™¨ã€‘
    â†“
ã€Executorã€‘åˆ›å»ºã€StatementHandlerã€‘
    â†“
ã€StatementHandlerã€‘å‡†å¤‡SQLè¯­å¥
    â†“
è°ƒç”¨ã€ParameterHandlerã€‘è®¾ç½®å‚æ•°
    â†“
æ‰§è¡ŒSQLæŸ¥è¯¢æ•°æ®åº“
    â†“
ã€ResultSetHandlerã€‘å¤„ç†ç»“æœé›†
    â†“
å°è£…æˆJavaå¯¹è±¡è¿”å›
    â†“
ã€åº”ç”¨ç¨‹åºã€‘æ”¶åˆ°ç»“æœ
```

### 4.2 è¯¦ç»†åä½œç¤ºä¾‹


**åœºæ™¯**ï¼šæ‰§è¡Œ `userMapper.selectById(1)`

```
æ­¥éª¤1ï¼šåº”ç”¨è°ƒç”¨
userMapper.selectById(1)

æ­¥éª¤2ï¼šSqlSessionæ¥æ”¶
â†’ æ‰¾åˆ°å¯¹åº”çš„MappedStatementï¼ˆSQLé…ç½®ï¼‰
â†’ å§”æ‰˜ç»™Executoræ‰§è¡Œ

æ­¥éª¤3ï¼šExecutorå·¥ä½œ
â†’ æ£€æŸ¥ç¼“å­˜ï¼ˆæœ‰åˆ™ç›´æ¥è¿”å›ï¼‰
â†’ åˆ›å»ºStatementHandler

æ­¥éª¤4ï¼šStatementHandlerå‡†å¤‡
â†’ SQLï¼šSELECT * FROM user WHERE id = ?
â†’ åˆ›å»ºPreparedStatementå¯¹è±¡

æ­¥éª¤5ï¼šParameterHandlerè®¾ç½®å‚æ•°
â†’ æŠŠå‚æ•°1è®¾ç½®åˆ° ? å ä½ç¬¦
â†’ SQLå˜æˆï¼šSELECT * FROM user WHERE id = 1

æ­¥éª¤6ï¼šæ‰§è¡ŒSQL
â†’ å‘é€åˆ°æ•°æ®åº“æ‰§è¡Œ
â†’ è·å¾—ResultSetç»“æœé›†

æ­¥éª¤7ï¼šResultSetHandlerå¤„ç†
â†’ è¯»å–ResultSetæ•°æ®
â†’ æ˜ å°„åˆ°Userå¯¹è±¡
â†’ User(id=1, name="å¼ ä¸‰", age=20)

æ­¥éª¤8ï¼šè¿”å›ç»“æœ
â†’ å­˜å…¥ç¼“å­˜
â†’ è¿”å›ç»™åº”ç”¨ç¨‹åº
```

### 4.3 æµç¨‹å›¾ç¤º


```
åº”ç”¨ä»£ç 
   â†“
[Mapperæ¥å£]
   â†“
[SqlSession] â†â†’ [ä¸€çº§ç¼“å­˜]
   â†“              â†‘
[Executor] â†â†’ [äºŒçº§ç¼“å­˜]
   â†“
[StatementHandler]
   â†“              â†“
[ParameterHandler] [ResultSetHandler]
   â†“              â†‘
   æ•°æ®åº“äº¤äº’
```

---

## 5. â° ç”Ÿå‘½å‘¨æœŸç®¡ç†


### 5.1 å„ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå¯¹æ¯”


| ç»„ä»¶ | **ç”Ÿå‘½å‘¨æœŸ** | **ä½œç”¨åŸŸ** | **æ³¨æ„äº‹é¡¹** |
|------|------------|-----------|------------|
| **SqlSessionFactoryBuilder** | `æ–¹æ³•çº§` | `å±€éƒ¨å˜é‡` | `ç”¨å®Œå³ä¸¢ï¼Œä¸éœ€è¦ä¿å­˜` |
| **SqlSessionFactory** | `åº”ç”¨çº§` | `å…¨å±€å•ä¾‹` | `ä¸€æ¬¡åˆ›å»ºï¼Œå…¨å±€å¤ç”¨` |
| **SqlSession** | `è¯·æ±‚çº§` | `æ–¹æ³•/çº¿ç¨‹` | `çº¿ç¨‹ä¸å®‰å…¨ï¼Œç”¨å®Œå¿…å…³` |
| **Mapper** | `æ–¹æ³•çº§` | `å±€éƒ¨å˜é‡` | `ä»SqlSessionè·å–ï¼ŒéšSqlSessionå…³é—­` |

### 5.2 ç”Ÿå‘½å‘¨æœŸå›¾ç¤º


```
åº”ç”¨å¯åŠ¨
   â†“
ã€SqlSessionFactoryBuilderã€‘åˆ›å»ºå·¥å‚
   â†“ï¼ˆç”¨å®Œå³é”€æ¯ï¼‰
ã€SqlSessionFactoryã€‘å…¨å±€å•ä¾‹
   â†“ï¼ˆåº”ç”¨è¿è¡ŒæœŸé—´ä¸€ç›´å­˜åœ¨ï¼‰
   
æ¯æ¬¡è¯·æ±‚æ¥ä¸´
   â†“
ã€SqlSessionã€‘åˆ›å»ºä¼šè¯
   â†“ï¼ˆè¯·æ±‚å¤„ç†æœŸé—´å­˜åœ¨ï¼‰
   
ã€Mapperã€‘ä»SqlSessionè·å–
   â†“ï¼ˆéšSqlSessionå…³é—­è€Œå¤±æ•ˆï¼‰
   
è¯·æ±‚ç»“æŸ
   â†“
SqlSession.close()
```

### 5.3 æœ€ä½³å®è·µ


**âœ… æ­£ç¡®å†™æ³•**ï¼š
```java
// å…¨å±€å•ä¾‹å·¥å‚
private static SqlSessionFactory factory;

static {
    // åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºä¸€æ¬¡
    InputStream is = Resources.getResourceAsStream("mybatis-config.xml");
    factory = new SqlSessionFactoryBuilder().build(is);
}

// æ¯æ¬¡è¯·æ±‚åˆ›å»ºæ–°ä¼šè¯
public void doQuery() {
    SqlSession session = factory.openSession();
    try {
        UserMapper mapper = session.getMapper(UserMapper.class);
        User user = mapper.selectById(1);
    } finally {
        session.close(); // å¿…é¡»å…³é—­
    }
}
```

**âŒ é”™è¯¯å†™æ³•**ï¼š
```java
// âŒ é”™è¯¯1ï¼šSqlSessionFactoryé‡å¤åˆ›å»º
public void doQuery() {
    SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(...);
    // æ¯æ¬¡éƒ½åˆ›å»ºå·¥å‚ï¼Œæµªè´¹èµ„æº
}

// âŒ é”™è¯¯2ï¼šSqlSessionä¸å…³é—­
SqlSession session = factory.openSession();
UserMapper mapper = session.getMapper(UserMapper.class);
// æ²¡æœ‰close()ï¼Œè¿æ¥æ³„æ¼

// âŒ é”™è¯¯3ï¼šSqlSessionå…±äº«ç»™å¤šçº¿ç¨‹
private SqlSession session; // æˆå‘˜å˜é‡
// å¤šçº¿ç¨‹å…±äº«ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 æ¶æ„è®¾è®¡è¦ç‚¹


```
ğŸ¯ ä¸‰å±‚æ¶æ„
â”œâ”€â”€ æ¥å£å±‚ï¼šå¯¹å¤–æä¾›APIï¼ˆSqlSessionã€Mapperï¼‰
â”œâ”€â”€ æ•°æ®å¤„ç†å±‚ï¼šæ‰§è¡ŒSQLå’Œæ˜ å°„ï¼ˆExecutorã€Handlerï¼‰
â””â”€â”€ åŸºç¡€æ”¯æŒå±‚ï¼šåº•å±‚èƒ½åŠ›ï¼ˆè¿æ¥ã€äº‹åŠ¡ã€ç¼“å­˜ï¼‰

ğŸ”§ æ ¸å¿ƒç»„ä»¶
â”œâ”€â”€ SqlSessionFactoryBuilder â†’ å»ºé€ å·¥å‚ï¼ˆä¸€æ¬¡æ€§ï¼‰
â”œâ”€â”€ SqlSessionFactory â†’ ç”Ÿäº§ä¼šè¯ï¼ˆå…¨å±€å•ä¾‹ï¼‰
â”œâ”€â”€ SqlSession â†’ æ•°æ®åº“ä¼šè¯ï¼ˆè¯·æ±‚çº§åˆ«ï¼‰
â””â”€â”€ Executor â†’ SQLæ‰§è¡Œå™¨ï¼ˆæ ¸å¿ƒå¼•æ“ï¼‰

ğŸ”„ æ‰§è¡Œæµç¨‹
åº”ç”¨ â†’ SqlSession â†’ Executor â†’ StatementHandler 
â†’ ParameterHandler â†’ æ•°æ®åº“ â†’ ResultSetHandler â†’ åº”ç”¨
```

### 6.2 å…³é”®ç†è§£ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆè¦åˆ†å±‚**ï¼š
- èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
- ä¸Šå±‚ä¾èµ–ä¸‹å±‚ï¼Œä¸‹å±‚ç‹¬ç«‹
- æ–¹ä¾¿æ‰©å±•å’Œæ›¿æ¢

**ğŸ”¹ ä¸ºä»€ä¹ˆè¦å·¥å‚æ¨¡å¼**ï¼š
- SqlSessionFactoryåˆ›å»ºæˆæœ¬é«˜ï¼ˆè¯»é…ç½®æ–‡ä»¶ï¼‰
- å•ä¾‹æ¨¡å¼å…¨å±€å…±äº«ï¼ŒèŠ‚çœèµ„æº
- SqlSessionåˆ›å»ºæˆæœ¬ä½ï¼Œå¯ä»¥é¢‘ç¹åˆ›å»º

**ğŸ”¹ ä¸ºä»€ä¹ˆSqlSessionä¸èƒ½å…±äº«**ï¼š
- å†…éƒ¨æœ‰çŠ¶æ€ï¼ˆç¼“å­˜ã€äº‹åŠ¡ï¼‰
- å¤šçº¿ç¨‹è®¿é—®ä¼šæ··ä¹±
- æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹çš„ä¼šè¯æ›´å®‰å…¨

### 6.3 å®æˆ˜åº”ç”¨å»ºè®®


**åœºæ™¯1ï¼šSpringæ•´åˆ**
```java
// Springä¼šè‡ªåŠ¨ç®¡ç†SqlSessionFactoryå•ä¾‹
@Autowired
private SqlSessionFactory factory;

// æ¯æ¬¡ä½¿ç”¨SqlSessionTemplateï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
@Autowired
private SqlSessionTemplate template;
```

**åœºæ™¯2ï¼šæ‰‹åŠ¨ç®¡ç†**
```java
// å·¥å…·ç±»ç®¡ç†Factory
public class MyBatisUtil {
    private static SqlSessionFactory factory;
    
    static {
        // åº”ç”¨å¯åŠ¨åˆ›å»º
        factory = new SqlSessionFactoryBuilder().build(...);
    }
    
    public static SqlSession getSession() {
        return factory.openSession();
    }
}
```

**åœºæ™¯3ï¼šæ‰¹å¤„ç†ä¼˜åŒ–**
```java
// å¤§æ‰¹é‡æ’å…¥ç”¨BatchExecutor
SqlSession session = factory.openSession(ExecutorType.BATCH);
try {
    UserMapper mapper = session.getMapper(UserMapper.class);
    for (User user : userList) {
        mapper.insert(user);
    }
    session.commit(); // æ‰¹é‡æäº¤
} finally {
    session.close();
}
```

---

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ä¸‰å±‚æ¶æ„èŒè´£æ˜ï¼Œæ¥å£æ•°æ®åŸºç¡€åˆ†
å·¥å‚å•ä¾‹åˆ›ä¼šè¯ï¼Œæ‰§è¡Œæµç¨‹è¦è®°æ¸…
Builderå»ºå‚ä¸€æ¬¡æ€§ï¼ŒFactoryå…¨å±€æ¥å¤ç”¨
Sessionè¯·æ±‚å¿…é¡»å…³ï¼Œå››å¤§Handlerå„å¸èŒ
```