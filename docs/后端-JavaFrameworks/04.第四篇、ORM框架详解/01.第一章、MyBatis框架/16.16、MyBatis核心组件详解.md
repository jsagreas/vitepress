---
title: 16ã€MyBatisæ ¸å¿ƒç»„ä»¶è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [ORMæ¡†æ¶åŸºç¡€è®¤çŸ¥](#1-ORMæ¡†æ¶åŸºç¡€è®¤çŸ¥)
2. [MyBatisæ ¸å¿ƒç»„ä»¶æ€»è§ˆ](#2-MyBatisæ ¸å¿ƒç»„ä»¶æ€»è§ˆ)
3. [é…ç½®æ ¸å¿ƒï¼šConfigurationå¯¹è±¡](#3-é…ç½®æ ¸å¿ƒConfigurationå¯¹è±¡)
4. [æ˜ å°„æ ¸å¿ƒï¼šMappedStatement](#4-æ˜ å°„æ ¸å¿ƒMappedStatement)
5. [SQLæ ¸å¿ƒï¼šBoundSql](#5-SQLæ ¸å¿ƒBoundSql)
6. [æ‰§è¡Œå±‚ç»„ä»¶è¯¦è§£](#6-æ‰§è¡Œå±‚ç»„ä»¶è¯¦è§£)
7. [ç»„ä»¶åä½œæœºåˆ¶](#7-ç»„ä»¶åä½œæœºåˆ¶)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ORMæ¡†æ¶åŸºç¡€è®¤çŸ¥


### 1.1 ä»€ä¹ˆæ˜¯ORMæ¡†æ¶


**é€šä¿—ç†è§£**ï¼šORMå°±åƒæ˜¯"ç¿»è¯‘å®˜"ï¼Œå¸®ä½ æŠŠJavaå¯¹è±¡å’Œæ•°æ®åº“è¡¨ä¹‹é—´äº’ç›¸ç¿»è¯‘

```
ä½ çš„Javaä»£ç ï¼šUserå¯¹è±¡           æ•°æ®åº“ï¼šuserè¡¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User user   â”‚                 â”‚ id  | name   â”‚
â”‚ id = 1      â”‚  â† ORMç¿»è¯‘ â†’    â”‚ 1   | å¼ ä¸‰   â”‚
â”‚ name = å¼ ä¸‰ â”‚                 â”‚ 2   | æå››   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸“ä¸šå®šä¹‰**ï¼š
- **ORMï¼ˆObject Relational Mappingï¼‰**ï¼šå¯¹è±¡å…³ç³»æ˜ å°„
- **æ ¸å¿ƒä½œç”¨**ï¼šè®©å¼€å‘è€…ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼æ“ä½œæ•°æ®åº“
- **æœ¬è´¨**ï¼šå»ºç«‹Javaå¯¹è±¡å’Œæ•°æ®åº“è¡¨çš„æ˜ å°„å…³ç³»

**ä¸ºä»€ä¹ˆéœ€è¦ORM**ï¼š
```
ä¼ ç»ŸJDBCæ–¹å¼ï¼š
String sql = "SELECT * FROM user WHERE id = ?";
PreparedStatement ps = conn.prepareStatement(sql);
ps.setInt(1, userId);
ResultSet rs = ps.executeQuery();
User user = new User();
user.setId(rs.getInt("id"));
user.setName(rs.getString("name"));
// å¤ªç¹çäº†ï¼

ä½¿ç”¨ORMæ¡†æ¶ï¼š
User user = userMapper.selectById(userId);
// ä¸€è¡Œä»£ç æå®šï¼
```

### 1.2 MyBatisåœ¨ORMå®¶æ—ä¸­çš„å®šä½


**ORMæ¡†æ¶åˆ†ç±»**ï¼š

| æ¡†æ¶ç±»å‹ | ä»£è¡¨æ¡†æ¶ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|---------|------|---------|
| ğŸ”¸ **å…¨è‡ªåŠ¨ORM** | Hibernateã€JPA | å®Œå…¨ä¸å†™SQLï¼Œè‡ªåŠ¨ç”Ÿæˆ | ç®€å•CRUDï¼Œè¡¨ç»“æ„è§„èŒƒ |
| ğŸ”¸ **åŠè‡ªåŠ¨ORM** | MyBatis | éœ€è¦å†™SQLï¼Œçµæ´»æ§åˆ¶ | å¤æ‚æŸ¥è¯¢ï¼Œæ€§èƒ½ä¼˜åŒ– |

**MyBatisçš„å®šä½**ï¼š
- âœ… **åŠè‡ªåŠ¨ORM**ï¼šä½ å†™SQLï¼Œæ¡†æ¶å¸®ä½ å¤„ç†ç»“æœ
- âœ… **çµæ´»å¯æ§**ï¼šSQLå®Œå…¨ç”±ä½ æ§åˆ¶
- âœ… **å­¦ä¹ æˆæœ¬ä½**ï¼šæ‡‚SQLå°±èƒ½ä¸Šæ‰‹

---

## 2. ğŸ—ï¸ MyBatisæ ¸å¿ƒç»„ä»¶æ€»è§ˆ


### 2.1 æ ¸å¿ƒç»„ä»¶æ¶æ„å›¾


```
MyBatisæ ¸å¿ƒç»„ä»¶æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åº”ç”¨å±‚ä»£ç                        â”‚
â”‚            userMapper.selectById(1)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Configuration (é…ç½®ä¸­å¿ƒ)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å­˜å‚¨æ‰€æœ‰é…ç½®ä¿¡æ¯å’ŒMappedStatement        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           MappedStatement (SQLæ˜ å°„å¯¹è±¡)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  SQLè¯­å¥ã€å‚æ•°æ˜ å°„ã€ç»“æœæ˜ å°„             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                BoundSql (ç»‘å®šçš„SQL)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  SELECT * FROM user WHERE id = ?        â”‚   â”‚
â”‚  â”‚  å‚æ•°ï¼š1                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ‰§è¡Œå±‚å››å¤§ç»„ä»¶                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚StatementHandlerâ”‚  â”‚ParameterHandlerâ”‚         â”‚
â”‚  â”‚  (è¯­å¥å¤„ç†)   â”‚  â”‚  (å‚æ•°å¤„ç†)   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ResultSetHandlerâ”‚ â”‚ TypeHandler  â”‚            â”‚
â”‚  â”‚  (ç»“æœå¤„ç†)   â”‚  â”‚  (ç±»å‹è½¬æ¢)   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
              æ•°æ®åº“æ‰§è¡Œ
```

### 2.2 ç»„ä»¶èŒè´£ä¸€è§ˆè¡¨


| ç»„ä»¶åç§° | ğŸ¯æ ¸å¿ƒèŒè´£ | ğŸ“é€šä¿—ç†è§£ | ğŸ’¡å…³é”®ä½œç”¨ |
|---------|----------|-----------|----------|
| **Configuration** | é…ç½®ä¸­å¿ƒ | åƒæ˜¯"æ€»æŒ‡æŒ¥éƒ¨"ï¼Œå­˜å‚¨æ‰€æœ‰é…ç½® | åˆå§‹åŒ–å’Œç®¡ç†æ‰€æœ‰ç»„ä»¶ |
| **MappedStatement** | SQLæ˜ å°„ | åƒæ˜¯"æ“ä½œæ‰‹å†Œ"ï¼Œè®°å½•SQLæ€ä¹ˆæ‰§è¡Œ | å­˜å‚¨ä¸€æ¡SQLçš„å®Œæ•´ä¿¡æ¯ |
| **BoundSql** | ç»‘å®šSQL | åƒæ˜¯"å‡†å¤‡å¥½çš„SQL"ï¼Œå‚æ•°å·²å¡«å…… | å¸¦å‚æ•°çš„å¯æ‰§è¡ŒSQL |
| **StatementHandler** | è¯­å¥å¤„ç† | åƒæ˜¯"æ‰§è¡Œå‘˜"ï¼Œè´Ÿè´£æ‰§è¡ŒSQL | åˆ›å»ºStatementï¼Œæ‰§è¡ŒæŸ¥è¯¢ |
| **ParameterHandler** | å‚æ•°å¤„ç† | åƒæ˜¯"å¡«ç©ºå‘˜"ï¼Œå¡«å……å‚æ•°åˆ°SQL | å°†Javaå‚æ•°è®¾ç½®åˆ°SQL |
| **ResultSetHandler** | ç»“æœå¤„ç† | åƒæ˜¯"ç¿»è¯‘å‘˜"ï¼ŒæŠŠç»“æœå˜å¯¹è±¡ | å°†ResultSetè½¬ä¸ºJavaå¯¹è±¡ |
| **TypeHandler** | ç±»å‹è½¬æ¢ | åƒæ˜¯"è½¬æ¢å™¨"ï¼ŒJavaå’Œæ•°æ®åº“ç±»å‹äº’è½¬ | å¤„ç†ä¸åŒç±»å‹çš„è½¬æ¢ |

---

## 3. ğŸ”§ é…ç½®æ ¸å¿ƒï¼šConfigurationå¯¹è±¡


### 3.1 Configurationæ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼šConfigurationå°±åƒæ˜¯MyBatisçš„"å¤§è„‘"ï¼Œå­˜å‚¨äº†æ¡†æ¶è¿è¡Œéœ€è¦çš„æ‰€æœ‰ä¿¡æ¯

**ä¸“ä¸šå®šä¹‰**ï¼š
- **Configurationå¯¹è±¡**ï¼šMyBatisçš„æ ¸å¿ƒé…ç½®ç±»
- **ä½œç”¨èŒƒå›´**ï¼šå…¨å±€å”¯ä¸€ï¼Œè´¯ç©¿æ•´ä¸ªMyBatisç”Ÿå‘½å‘¨æœŸ
- **å­˜å‚¨å†…å®¹**ï¼šé…ç½®ä¿¡æ¯ã€Mapperæ˜ å°„ã€ç¼“å­˜é…ç½®ç­‰

### 3.2 Configurationå­˜å‚¨äº†ä»€ä¹ˆ


**æ ¸å¿ƒå­˜å‚¨å†…å®¹**ï¼š

```
Configurationå¯¹è±¡ç»“æ„ï¼š

Configuration
â”œâ”€â”€ ğŸ“‹ é…ç½®ä¿¡æ¯
â”‚   â”œâ”€â”€ mapperRegistry (Mapperæ³¨å†Œå™¨)
â”‚   â”œâ”€â”€ typeAliasRegistry (ç±»å‹åˆ«åæ³¨å†Œå™¨)
â”‚   â”œâ”€â”€ typeHandlerRegistry (ç±»å‹å¤„ç†å™¨æ³¨å†Œå™¨)
â”‚   â””â”€â”€ settings (å„ç§é…ç½®é¡¹)
â”‚
â”œâ”€â”€ ğŸ“ SQLæ˜ å°„
â”‚   â”œâ”€â”€ mappedStatements (æ‰€æœ‰SQLæ˜ å°„)
â”‚   â”‚   â”œâ”€â”€ "selectUser" â†’ MappedStatementå¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ "insertUser" â†’ MappedStatementå¯¹è±¡
â”‚   â”‚   â””â”€â”€ "updateUser" â†’ MappedStatementå¯¹è±¡
â”‚   â””â”€â”€ caches (äºŒçº§ç¼“å­˜)
â”‚
â””â”€â”€ ğŸ”Œ ç¯å¢ƒé…ç½®
    â”œâ”€â”€ environment (æ•°æ®æºã€äº‹åŠ¡)
    â””â”€â”€ databaseId (æ•°æ®åº“æ ‡è¯†)
```

**å…³é”®å±æ€§è¯´æ˜**ï¼š

| å±æ€§åç§° | ç±»å‹ | ğŸ”¸ä½œç”¨è¯´æ˜ |
|---------|------|-----------|
| `mappedStatements` | Mapé›†åˆ | å­˜å‚¨æ‰€æœ‰çš„SQLæ˜ å°„è¯­å¥ |
| `mapperRegistry` | MapperRegistry | ç®¡ç†æ‰€æœ‰Mapperæ¥å£çš„æ³¨å†Œ |
| `typeHandlerRegistry` | TypeHandlerRegistry | ç®¡ç†Javaç±»å‹å’Œæ•°æ®åº“ç±»å‹çš„è½¬æ¢å™¨ |
| `environment` | Environment | å­˜å‚¨æ•°æ®æºå’Œäº‹åŠ¡ç®¡ç†å™¨ |

### 3.3 Configurationåˆå§‹åŒ–æµç¨‹


**åˆå§‹åŒ–è¿‡ç¨‹**ï¼š

```
Configurationåˆå§‹åŒ–ä¸‰æ­¥éª¤ï¼š

æ­¥éª¤ 1ï¸âƒ£ è§£æé…ç½®æ–‡ä»¶
    â†“
è¯»å– mybatis-config.xml
è§£æ <settings>ã€<typeAliases>ã€<mappers> ç­‰æ ‡ç­¾
    â†“
æ­¥éª¤ 2ï¸âƒ£ æ³¨å†Œç»„ä»¶
    â†“
æ³¨å†ŒTypeHandlerã€Mapperæ¥å£ç­‰
å°†æ‰€æœ‰é…ç½®å­˜å…¥Configurationå¯¹è±¡
    â†“
æ­¥éª¤ 3ï¸âƒ£ æ„å»ºSqlSessionFactory
    â†“
åŸºäºConfigurationåˆ›å»ºSqlSessionFactory
åç»­æ‰€æœ‰æ“ä½œéƒ½ä¾èµ–è¿™ä¸ªConfiguration
```

**ç®€åŒ–ä»£ç ç¤ºä¾‹**ï¼š

```java
// åˆå§‹åŒ–Configurationçš„æ ¸å¿ƒä»£ç 
String resource = "mybatis-config.xml";
InputStream inputStream = Resources.getResourceAsStream(resource);

// XMLConfigBuilderä¼šåˆ›å»ºConfigurationå¯¹è±¡
XMLConfigBuilder parser = new XMLConfigBuilder(inputStream);
Configuration configuration = parser.parse();

// åŸºäºConfigurationåˆ›å»ºSqlSessionFactory
SqlSessionFactory factory = new SqlSessionFactoryBuilder()
    .build(configuration);
```

### 3.4 Configurationçš„å…³é”®ä½œç”¨


**ä¸‰å¤§æ ¸å¿ƒä½œç”¨**ï¼š

ğŸ”¸ **ä½œç”¨ä¸€ï¼šç»Ÿä¸€é…ç½®ç®¡ç†**
```
æ‰€æœ‰é…ç½®ç»Ÿä¸€å­˜å‚¨ï¼Œé¿å…é…ç½®åˆ†æ•£
æ¯”å¦‚ï¼šæ•°æ®æºé…ç½®ã€ç¼“å­˜é…ç½®ã€æ’ä»¶é…ç½®ç­‰
```

ğŸ”¸ **ä½œç”¨äºŒï¼šç»„ä»¶æ³¨å†Œä¸­å¿ƒ**
```
æ‰€æœ‰ç»„ä»¶éƒ½åœ¨è¿™é‡Œæ³¨å†Œå’Œè·å–
æ¯”å¦‚ï¼šMapperæ¥å£ã€TypeHandlerã€æ‹¦æˆªå™¨ç­‰
```

ğŸ”¸ **ä½œç”¨ä¸‰ï¼šåˆ›å»ºå…¶ä»–ç»„ä»¶**
```
Configurationå¯ä»¥åˆ›å»ºï¼š
- Executor (æ‰§è¡Œå™¨)
- StatementHandler (è¯­å¥å¤„ç†å™¨)
- ParameterHandler (å‚æ•°å¤„ç†å™¨)
- ResultSetHandler (ç»“æœå¤„ç†å™¨)
```

---

## 4. ğŸ“ æ˜ å°„æ ¸å¿ƒï¼šMappedStatement


### 4.1 MappedStatementæ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼šMappedStatementå°±åƒæ˜¯"ä¸€å¼ æ“ä½œè¯´æ˜ä¹¦"ï¼Œè¯¦ç»†è®°å½•äº†å¦‚ä½•æ‰§è¡Œä¸€æ¡SQL

**ä¸“ä¸šå®šä¹‰**ï¼š
- **MappedStatement**ï¼šSQLæ˜ å°„è¯­å¥å¯¹è±¡
- **ä½œç”¨**ï¼šå°è£…ä¸€æ¡SQLè¯­å¥çš„å®Œæ•´ä¿¡æ¯
- **ç‰¹ç‚¹**ï¼šæ¯ä¸ª`<select>`ã€`<insert>`ç­‰æ ‡ç­¾å¯¹åº”ä¸€ä¸ªMappedStatement

### 4.2 MappedStatementåŒ…å«ä»€ä¹ˆ


**æ ¸å¿ƒå±æ€§è¯¦è§£**ï¼š

```
MappedStatementå¯¹è±¡ç»“æ„ï¼š

MappedStatement
â”œâ”€â”€ ğŸ†” åŸºæœ¬ä¿¡æ¯
â”‚   â”œâ”€â”€ id (è¯­å¥IDï¼Œå¦‚ï¼šcom.example.UserMapper.selectById)
â”‚   â”œâ”€â”€ sqlCommandType (SQLç±»å‹ï¼šSELECT/INSERT/UPDATE/DELETE)
â”‚   â””â”€â”€ statementType (è¯­å¥ç±»å‹ï¼šPREPARED/CALLABLEç­‰)
â”‚
â”œâ”€â”€ ğŸ“‹ SQLä¿¡æ¯
â”‚   â”œâ”€â”€ sqlSource (SQLæºå¯¹è±¡ï¼ŒåŠ¨æ€SQLçš„æ ¸å¿ƒ)
â”‚   â”‚   â””â”€â”€ getBoundSql() â†’ ç”ŸæˆBoundSqlå¯¹è±¡
â”‚   â””â”€â”€ parameterMap (å‚æ•°æ˜ å°„é…ç½®)
â”‚
â”œâ”€â”€ ğŸ“¤ ç»“æœæ˜ å°„
â”‚   â”œâ”€â”€ resultMaps (ç»“æœæ˜ å°„é›†åˆ)
â”‚   â”œâ”€â”€ resultSetType (ç»“æœé›†ç±»å‹)
â”‚   â””â”€â”€ fetchSize (æ¯æ¬¡è·å–æ•°é‡)
â”‚
â””â”€â”€ ğŸ”§ å…¶ä»–é…ç½®
    â”œâ”€â”€ timeout (è¶…æ—¶æ—¶é—´)
    â”œâ”€â”€ cache (äºŒçº§ç¼“å­˜å¼•ç”¨)
    â””â”€â”€ useCache (æ˜¯å¦ä½¿ç”¨ç¼“å­˜)
```

**å…³é”®å±æ€§å¯¹ç…§è¡¨**ï¼š

| å±æ€§åç§° | æ•°æ®ç±»å‹ | ğŸ”¸å«ä¹‰è¯´æ˜ | ğŸ’¡ç¤ºä¾‹ |
|---------|---------|-----------|--------|
| `id` | String | SQLè¯­å¥çš„å”¯ä¸€æ ‡è¯† | `com.example.UserMapper.selectById` |
| `sqlCommandType` | SqlCommandTypeæšä¸¾ | SQLæ“ä½œç±»å‹ | SELECT / INSERT / UPDATE / DELETE |
| `sqlSource` | SqlSourceæ¥å£ | SQLæºå¯¹è±¡ï¼Œç”ŸæˆSQLçš„æ ¸å¿ƒ | DynamicSqlSource (åŠ¨æ€SQL) |
| `resultMaps` | List | ç»“æœæ˜ å°„é…ç½®åˆ—è¡¨ | å®šä¹‰å¦‚ä½•æŠŠæ•°æ®åº“è®°å½•è½¬æˆJavaå¯¹è±¡ |
| `parameterMap` | ParameterMap | å‚æ•°æ˜ å°„é…ç½® | å®šä¹‰å¦‚ä½•æŠŠJavaå‚æ•°ä¼ ç»™SQL |

### 4.3 MappedStatementçš„åˆ›å»ºè¿‡ç¨‹


**åˆ›å»ºæµç¨‹**ï¼š

```
ä»Mapper.xmlåˆ°MappedStatementçš„è½¬æ¢è¿‡ç¨‹ï¼š

åŸå§‹Mapper.xmlï¼š
<select id="selectById" resultType="User">
  SELECT * FROM user WHERE id = #{id}
</select>
         â†“
XMLStatementBuilderè§£æ
         â†“
åˆ›å»ºMappedStatementå¯¹è±¡ï¼š
{
  id: "com.example.UserMapper.selectById"
  sqlCommandType: SELECT
  sqlSource: DynamicSqlSource
  resultMaps: [ResultMapå¯¹è±¡]
  parameterMap: å‚æ•°æ˜ å°„
}
         â†“
æ³¨å†Œåˆ°Configurationï¼š
configuration.addMappedStatement(mappedStatement)
```

**ç®€åŒ–ç†è§£**ï¼š
```java
// Mapper.xmlä¸­çš„SQL
<select id="selectById" resultType="User">
  SELECT * FROM user WHERE id = #{id}
</select>

// æœ€ç»ˆä¼šå˜æˆMappedStatementå¯¹è±¡ï¼Œå­˜å‚¨ä»¥ä¸‹ä¿¡æ¯ï¼š
MappedStatement ms = new MappedStatement.Builder()
    .id("com.example.UserMapper.selectById")  // è¯­å¥ID
    .sqlCommandType(SqlCommandType.SELECT)    // SQLç±»å‹
    .sqlSource(sqlSource)                     // SQLæº
    .resultMaps(resultMaps)                   // ç»“æœæ˜ å°„
    .build();
```

### 4.4 MappedStatementçš„æ ¸å¿ƒä½œç”¨


**ä¸‰å¤§å…³é”®ä½œç”¨**ï¼š

ğŸ”¸ **ä½œç”¨ä¸€ï¼šå­˜å‚¨SQLä¿¡æ¯**
```
ä¿å­˜SQLè¯­å¥çš„æ‰€æœ‰é…ç½®ä¿¡æ¯
åŒ…æ‹¬ï¼šSQLæ–‡æœ¬ã€å‚æ•°ã€ç»“æœæ˜ å°„ç­‰
```

ğŸ”¸ **ä½œç”¨äºŒï¼šç”ŸæˆBoundSql**
```
é€šè¿‡sqlSource.getBoundSql(å‚æ•°)æ–¹æ³•
ç”Ÿæˆå¸¦å‚æ•°çš„å¯æ‰§è¡ŒSQLï¼ˆBoundSqlå¯¹è±¡ï¼‰
```

ğŸ”¸ **ä½œç”¨ä¸‰ï¼šæŒ‡å¯¼SQLæ‰§è¡Œ**
```
StatementHandleræ ¹æ®MappedStatement
çŸ¥é“å¦‚ä½•å¤„ç†å‚æ•°ã€æ‰§è¡ŒSQLã€å¤„ç†ç»“æœ
```

---

## 5. ğŸ¯ SQLæ ¸å¿ƒï¼šBoundSql


### 5.1 BoundSqlæ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼šBoundSqlå°±åƒæ˜¯"å¡«å¥½ç©ºçš„SQL"ï¼Œæ‰€æœ‰å‚æ•°éƒ½å‡†å¤‡å¥½äº†ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œ

**ä¸“ä¸šå®šä¹‰**ï¼š
- **BoundSql**ï¼šç»‘å®šäº†å‚æ•°çš„SQLå¯¹è±¡
- **ä½œç”¨**ï¼šå°è£…è§£æåçš„SQLå’Œå‚æ•°ä¿¡æ¯
- **ç‰¹ç‚¹**ï¼šç”±MappedStatementçš„SqlSourceç”Ÿæˆ

### 5.2 BoundSqlåŒ…å«ä»€ä¹ˆ


**æ ¸å¿ƒå†…å®¹**ï¼š

```
BoundSqlå¯¹è±¡ç»“æ„ï¼š

BoundSql
â”œâ”€â”€ ğŸ“„ SQLè¯­å¥
â”‚   â””â”€â”€ sql (è§£æåçš„SQLå­—ç¬¦ä¸²)
â”‚       ç¤ºä¾‹ï¼š"SELECT * FROM user WHERE id = ? AND name = ?"
â”‚
â”œâ”€â”€ ğŸ”¢ å‚æ•°æ˜ å°„
â”‚   â”œâ”€â”€ parameterMappings (å‚æ•°æ˜ å°„åˆ—è¡¨)
â”‚   â”‚   â”œâ”€â”€ ParameterMapping {property: "id", javaType: Integer}
â”‚   â”‚   â””â”€â”€ ParameterMapping {property: "name", javaType: String}
â”‚   â””â”€â”€ parameterObject (å®é™…å‚æ•°å€¼)
â”‚       ç¤ºä¾‹ï¼š{id: 1, name: "å¼ ä¸‰"}
â”‚
â””â”€â”€ ğŸ“‹ é™„åŠ ä¿¡æ¯
    â”œâ”€â”€ additionalParameters (é¢å¤–å‚æ•°)
    â””â”€â”€ metaParameters (å…ƒæ•°æ®å‚æ•°)
```

**å…³é”®å±æ€§è¯´æ˜**ï¼š

| å±æ€§åç§° | ç±»å‹ | ğŸ”¸ä½œç”¨è¯´æ˜ | ğŸ’¡ç¤ºä¾‹ |
|---------|------|-----------|--------|
| `sql` | String | è§£æåçš„SQLè¯­å¥ï¼ˆå«å ä½ç¬¦ï¼‰ | `SELECT * FROM user WHERE id = ?` |
| `parameterMappings` | List | å‚æ•°æ˜ å°„åˆ—è¡¨ | `[{property:"id", jdbcType:INTEGER}]` |
| `parameterObject` | Object | å®é™…çš„å‚æ•°å€¼ | `1` æˆ– `{id:1, name:"å¼ ä¸‰"}` |

### 5.3 BoundSqlçš„ç”Ÿæˆè¿‡ç¨‹


**ä»åŠ¨æ€SQLåˆ°BoundSql**ï¼š

```
åŠ¨æ€SQLè§£æè¿‡ç¨‹ï¼š

æ­¥éª¤ 1ï¸âƒ£ åŸå§‹SQLæ¨¡æ¿
<select id="selectUser">
  SELECT * FROM user 
  WHERE 1=1
  <if test="id != null">
    AND id = #{id}
  </if>
  <if test="name != null">
    AND name = #{name}
  </if>
</select>
         â†“
æ­¥éª¤ 2ï¸âƒ£ æ¡ä»¶åˆ¤æ–­ (å‡è®¾ä¼ å…¥ {id: 1, name: null})
æ ¹æ®ifæ¡ä»¶åˆ¤æ–­ï¼Œnameä¸ºnullï¼Œè¯¥æ¡ä»¶ä¸ç”Ÿæ•ˆ
         â†“
æ­¥éª¤ 3ï¸âƒ£ ç”ŸæˆSQL (å»æ‰æ— æ•ˆæ¡ä»¶)
SELECT * FROM user WHERE 1=1 AND id = #{id}
         â†“
æ­¥éª¤ 4ï¸âƒ£ æ›¿æ¢å ä½ç¬¦
SELECT * FROM user WHERE 1=1 AND id = ?
         â†“
æ­¥éª¤ 5ï¸âƒ£ åˆ›å»ºBoundSqlå¯¹è±¡
{
  sql: "SELECT * FROM user WHERE 1=1 AND id = ?"
  parameterMappings: [{property:"id", jdbcType:INTEGER}]
  parameterObject: 1
}
```

**ç®€åŒ–ä»£ç ç¤ºä¾‹**ï¼š

```java
// è·å–BoundSqlçš„è¿‡ç¨‹
MappedStatement ms = configuration.getMappedStatement("selectUser");
SqlSource sqlSource = ms.getSqlSource();

// ä¼ å…¥å‚æ•°ï¼Œç”ŸæˆBoundSql
Object parameterObject = 1; // å‡è®¾ä¼ å…¥id=1
BoundSql boundSql = sqlSource.getBoundSql(parameterObject);

// BoundSqlåŒ…å«çš„å†…å®¹
String sql = boundSql.getSql(); // "SELECT * FROM user WHERE id = ?"
List<ParameterMapping> mappings = boundSql.getParameterMappings();
Object params = boundSql.getParameterObject(); // 1
```

### 5.4 BoundSqlçš„æ ¸å¿ƒä»·å€¼


**ä¸‰ä¸ªå…³é”®ä½œç”¨**ï¼š

ğŸ”¸ **ä½œç”¨ä¸€ï¼šåŠ¨æ€SQLçš„æœ€ç»ˆå½¢æ€**
```
æ— è®ºå¤šå¤æ‚çš„åŠ¨æ€SQL
æœ€ç»ˆéƒ½ä¼šè§£ææˆBoundSqlå¯¹è±¡
è¿™æ˜¯å¯ä»¥æ‰§è¡Œçš„SQL
```

ğŸ”¸ **ä½œç”¨äºŒï¼šå‚æ•°å’ŒSQLçš„ç»‘å®š**
```
æ˜ç¡®äº†SQLä¸­æœ‰å‡ ä¸ªå ä½ç¬¦
æ¯ä¸ªå ä½ç¬¦å¯¹åº”ä»€ä¹ˆå‚æ•°
å‚æ•°æ˜¯ä»€ä¹ˆç±»å‹
```

ğŸ”¸ **ä½œç”¨ä¸‰ï¼šä¼ é€’ç»™æ‰§è¡Œå±‚**
```
BoundSqlä¼ ç»™StatementHandler
StatementHandleræ ¹æ®å®ƒåˆ›å»ºPreparedStatement
ParameterHandleræ ¹æ®å®ƒè®¾ç½®å‚æ•°
```

---

## 6. âš™ï¸ æ‰§è¡Œå±‚ç»„ä»¶è¯¦è§£


### 6.1 æ‰§è¡Œå±‚å››å¤§ç»„ä»¶æ¦‚è§ˆ


**å››å¤§ç»„ä»¶å…³ç³»å›¾**ï¼š

```
SQLæ‰§è¡Œæµç¨‹ - å››å¤§ç»„ä»¶åä½œï¼š

ä¼ å…¥ï¼šBoundSql + å‚æ•°
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   StatementHandler       â”‚ â† æ€»æŒ‡æŒ¥
â”‚   åˆ›å»ºStatement          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ParameterHandler       â”‚ â† å¡«å‚æ•°
â”‚   è®¾ç½®å‚æ•°åˆ°Statement     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
      æ‰§è¡ŒSQLæŸ¥è¯¢
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ResultSetHandler       â”‚ â† å¤„ç†ç»“æœ
â”‚   ResultSet â†’ Javaå¯¹è±¡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
      è¿”å›ç»“æœå¯¹è±¡
```

### 6.2 StatementHandlerè¯¦è§£


**é€šä¿—ç†è§£**ï¼šStatementHandleræ˜¯"æ‰§è¡Œæ€»æŒ‡æŒ¥"ï¼Œè´Ÿè´£åˆ›å»ºStatementå¹¶åè°ƒå…¶ä»–ç»„ä»¶

**æ ¸å¿ƒèŒè´£**ï¼š

| èŒè´£ç±»å‹ | ğŸ”¸å…·ä½“å·¥ä½œ | ğŸ’¡ä½œç”¨è¯´æ˜ |
|---------|-----------|----------|
| **åˆ›å»ºStatement** | æ ¹æ®é…ç½®åˆ›å»ºStatementå¯¹è±¡ | å¯ä»¥æ˜¯PreparedStatementã€CallableStatementç­‰ |
| **å‚æ•°è®¾ç½®** | è°ƒç”¨ParameterHandlerè®¾ç½®å‚æ•° | æŠŠJavaå‚æ•°è®¾ç½®åˆ°SQLçš„å ä½ç¬¦ |
| **SQLæ‰§è¡Œ** | æ‰§è¡ŒStatement.execute() | æ‰§è¡ŒçœŸæ­£çš„æ•°æ®åº“æ“ä½œ |
| **ç»“æœå¤„ç†** | è°ƒç”¨ResultSetHandlerå¤„ç†ç»“æœ | æŠŠResultSetè½¬æˆJavaå¯¹è±¡ |

**StatementHandlerç±»å‹**ï¼š

```
StatementHandlerä¸‰ç§å®ç°ï¼š

SimpleStatementHandler
â”œâ”€â”€ ä½¿ç”¨Statement (ä¸é¢„ç¼–è¯‘)
â”œâ”€â”€ SQLç›´æ¥æ‹¼æ¥ï¼Œæœ‰SQLæ³¨å…¥é£é™©
â””â”€â”€ é€‚ç”¨åœºæ™¯ï¼šç®€å•é™æ€SQL

PreparedStatementHandler  â† æœ€å¸¸ç”¨
â”œâ”€â”€ ä½¿ç”¨PreparedStatement (é¢„ç¼–è¯‘)
â”œâ”€â”€ ç”¨å ä½ç¬¦é˜²æ­¢SQLæ³¨å…¥
â””â”€â”€ é€‚ç”¨åœºæ™¯ï¼šå¤§éƒ¨åˆ†SQLåœºæ™¯

CallableStatementHandler
â”œâ”€â”€ ä½¿ç”¨CallableStatement
â”œâ”€â”€ ç”¨äºè°ƒç”¨å­˜å‚¨è¿‡ç¨‹
â””â”€â”€ é€‚ç”¨åœºæ™¯ï¼šå¤æ‚å­˜å‚¨è¿‡ç¨‹è°ƒç”¨
```

**æ‰§è¡Œç¤ºä¾‹**ï¼š

```java
// StatementHandlerçš„æ ¸å¿ƒå·¥ä½œæµç¨‹
public <E> List<E> query(Statement stmt) {
    // 1. è·å–SQL
    String sql = boundSql.getSql();
    
    // 2. åˆ›å»ºPreparedStatement
    PreparedStatement ps = connection.prepareStatement(sql);
    
    // 3. è®¾ç½®å‚æ•°ï¼ˆå§”æ‰˜ç»™ParameterHandlerï¼‰
    parameterHandler.setParameters(ps);
    
    // 4. æ‰§è¡ŒæŸ¥è¯¢
    ResultSet rs = ps.executeQuery();
    
    // 5. å¤„ç†ç»“æœï¼ˆå§”æ‰˜ç»™ResultSetHandlerï¼‰
    return resultSetHandler.handleResultSets(rs);
}
```

### 6.3 ParameterHandlerè¯¦è§£


**é€šä¿—ç†è§£**ï¼šParameterHandleræ˜¯"å‚æ•°å¡«å……å‘˜"ï¼Œè´Ÿè´£æŠŠJavaå‚æ•°å¡«åˆ°SQLçš„é—®å·å ä½ç¬¦

**æ ¸å¿ƒå·¥ä½œ**ï¼š

```
å‚æ•°è®¾ç½®æµç¨‹ï¼š

è¾“å…¥ï¼šparameterObject = {id: 1, name: "å¼ ä¸‰"}
SQLï¼šSELECT * FROM user WHERE id = ? AND name = ?
         â†“
æ­¥éª¤ 1ï¸âƒ£ éå†ParameterMapping
ç¬¬1ä¸ªæ˜ å°„ï¼šproperty="id", jdbcType=INTEGER
ç¬¬2ä¸ªæ˜ å°„ï¼šproperty="name", jdbcType=VARCHAR
         â†“
æ­¥éª¤ 2ï¸âƒ£ ä»å‚æ•°å¯¹è±¡è·å–å€¼
è·å–idçš„å€¼ï¼š1
è·å–nameçš„å€¼ï¼š"å¼ ä¸‰"
         â†“
æ­¥éª¤ 3ï¸âƒ£ è®¾ç½®åˆ°PreparedStatement
ps.setInt(1, 1);        // ç¬¬1ä¸ªå ä½ç¬¦è®¾ç½®ä¸º1
ps.setString(2, "å¼ ä¸‰"); // ç¬¬2ä¸ªå ä½ç¬¦è®¾ç½®ä¸º"å¼ ä¸‰"
         â†“
æœ€ç»ˆSQLï¼šSELECT * FROM user WHERE id = 1 AND name = 'å¼ ä¸‰'
```

**å…³é”®æ–¹æ³•**ï¼š

```java
public void setParameters(PreparedStatement ps) {
    // è·å–å‚æ•°æ˜ å°„åˆ—è¡¨
    List<ParameterMapping> mappings = boundSql.getParameterMappings();
    
    // éå†æ¯ä¸ªå‚æ•°æ˜ å°„
    for (int i = 0; i < mappings.size(); i++) {
        ParameterMapping mapping = mappings.get(i);
        
        // è·å–å‚æ•°å€¼
        Object value = è·å–å‚æ•°å€¼(mapping.getProperty());
        
        // è·å–TypeHandler
        TypeHandler typeHandler = mapping.getTypeHandler();
        
        // è®¾ç½®å‚æ•°åˆ°PreparedStatement
        typeHandler.setParameter(ps, i + 1, value, mapping.getJdbcType());
    }
}
```

**å‚æ•°ç±»å‹å¤„ç†**ï¼š

| Javaç±»å‹ | æ•°æ®åº“ç±»å‹ | TypeHandler | ğŸ”¸å¤„ç†æ–¹å¼ |
|---------|-----------|-------------|----------|
| Integer | INTEGER | IntegerTypeHandler | `ps.setInt(index, value)` |
| String | VARCHAR | StringTypeHandler | `ps.setString(index, value)` |
| Date | TIMESTAMP | DateTypeHandler | `ps.setTimestamp(index, value)` |
| è‡ªå®šä¹‰å¯¹è±¡ | JSON | è‡ªå®šä¹‰Handler | åºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸² |

### 6.4 ResultSetHandlerè¯¦è§£


**é€šä¿—ç†è§£**ï¼šResultSetHandleræ˜¯"ç»“æœç¿»è¯‘å‘˜"ï¼ŒæŠŠæ•°æ®åº“è¿”å›çš„ResultSetç¿»è¯‘æˆJavaå¯¹è±¡

**æ ¸å¿ƒå·¥ä½œæµç¨‹**ï¼š

```
ç»“æœé›†å¤„ç†æµç¨‹ï¼š

è¾“å…¥ï¼šResultSet
id  | name   | age
----|--------|----
1   | å¼ ä¸‰   | 25
2   | æå››   | 30
         â†“
æ­¥éª¤ 1ï¸âƒ£ è·å–ResultMapé…ç½®
<resultMap id="UserMap" type="User">
  <id property="id" column="id"/>
  <result property="name" column="name"/>
  <result property="age" column="age"/>
</resultMap>
         â†“
æ­¥éª¤ 2ï¸âƒ£ éå†ResultSetæ¯ä¸€è¡Œ
ç¬¬1è¡Œï¼šid=1, name=å¼ ä¸‰, age=25
ç¬¬2è¡Œï¼šid=2, name=æå››, age=30
         â†“
æ­¥éª¤ 3ï¸âƒ£ åˆ›å»ºJavaå¯¹è±¡å¹¶èµ‹å€¼
User user1 = new User();
user1.setId(1);
user1.setName("å¼ ä¸‰");
user1.setAge(25);
         â†“
æ­¥éª¤ 4ï¸âƒ£ è¿”å›ç»“æœåˆ—è¡¨
List<User> = [user1, user2]
```

**å…³é”®å¤„ç†é€»è¾‘**ï¼š

```java
public List<Object> handleResultSets(ResultSet rs) {
    List<Object> resultList = new ArrayList<>();
    
    // è·å–ResultMap
    ResultMap resultMap = mappedStatement.getResultMaps().get(0);
    
    // éå†ResultSet
    while (rs.next()) {
        // åˆ›å»ºç»“æœå¯¹è±¡
        Object resultObject = åˆ›å»ºå¯¹è±¡(resultMap.getType());
        
        // éå†æ¯ä¸ªåˆ—æ˜ å°„
        for (ResultMapping mapping : resultMap.getResultMappings()) {
            String column = mapping.getColumn();      // æ•°æ®åº“åˆ—å
            String property = mapping.getProperty();  // Javaå±æ€§å
            
            // ä»ResultSetè·å–å€¼
            Object value = rs.getObject(column);
            
            // é€šè¿‡TypeHandlerè½¬æ¢ç±»å‹
            TypeHandler handler = mapping.getTypeHandler();
            value = handler.getResult(rs, column);
            
            // è®¾ç½®åˆ°å¯¹è±¡
            è®¾ç½®å±æ€§å€¼(resultObject, property, value);
        }
        
        resultList.add(resultObject);
    }
    
    return resultList;
}
```

**å¤æ‚åœºæ™¯å¤„ç†**ï¼š

ğŸ”¸ **åµŒå¥—æŸ¥è¯¢ï¼ˆN+1é—®é¢˜ï¼‰**
```
<resultMap id="UserMap" type="User">
  <id property="id" column="id"/>
  <association property="dept" select="selectDept" column="dept_id"/>
</resultMap>

å¤„ç†ï¼šå…ˆæŸ¥è¯¢Userï¼Œå†æ ¹æ®dept_idæŸ¥è¯¢éƒ¨é—¨
å¯èƒ½è§¦å‘N+1é—®é¢˜ï¼ˆæŸ¥1æ¬¡Userï¼ŒæŸ¥Næ¬¡Deptï¼‰
```

ğŸ”¸ **åµŒå¥—ç»“æœæ˜ å°„**
```
ä¸€æ¡SQLå…³è”æŸ¥è¯¢ï¼Œç»“æœæ˜ å°„åˆ°åµŒå¥—å¯¹è±¡
User {
  id: 1
  name: "å¼ ä¸‰"
  dept: {
    id: 10
    name: "æŠ€æœ¯éƒ¨"
  }
}
```

### 6.5 TypeHandlerè¯¦è§£


**é€šä¿—ç†è§£**ï¼šTypeHandleræ˜¯"ç±»å‹è½¬æ¢å™¨"ï¼Œè´Ÿè´£Javaç±»å‹å’Œæ•°æ®åº“ç±»å‹ä¹‹é—´çš„äº’ç›¸è½¬æ¢

**ä¸¤å¤§æ ¸å¿ƒåŠŸèƒ½**ï¼š

```
TypeHandleråŒå‘è½¬æ¢ï¼š

æ–¹å‘ä¸€ï¼šJava â†’ æ•°æ®åº“ (è®¾ç½®å‚æ•°æ—¶)
Javaçš„Integer (1)  â†’  TypeHandler  â†’  æ•°æ®åº“çš„INTEGER
         â†“
ps.setInt(1, value);

æ–¹å‘äºŒï¼šæ•°æ®åº“ â†’ Java (è·å–ç»“æœæ—¶)
æ•°æ®åº“çš„INTEGER  â†’  TypeHandler  â†’  Javaçš„Integer
         â†“
Integer value = rs.getInt("id");
```

**å¸¸ç”¨TypeHandler**ï¼š

| TypeHandler | Javaç±»å‹ | JDBCç±»å‹ | ğŸ”¸å¤„ç†æ–¹å¼ |
|------------|----------|----------|----------|
| IntegerTypeHandler | Integer | INTEGER | `setInt()` / `getInt()` |
| StringTypeHandler | String | VARCHAR | `setString()` / `getString()` |
| DateTypeHandler | Date | TIMESTAMP | `setTimestamp()` / `getTimestamp()` |
| BooleanTypeHandler | Boolean | BOOLEAN/BIT | `setBoolean()` / `getBoolean()` |
| EnumTypeHandler | æšä¸¾ | VARCHAR | æšä¸¾åç§°å­—ç¬¦ä¸²è½¬æ¢ |

**è‡ªå®šä¹‰TypeHandlerç¤ºä¾‹**ï¼š

```java
// è‡ªå®šä¹‰TypeHandlerï¼šå¤„ç†JSONå­—æ®µ
public class JsonTypeHandler implements TypeHandler<Object> {
    
    // è®¾ç½®å‚æ•°ï¼šJavaå¯¹è±¡ â†’ JSONå­—ç¬¦ä¸²
    @Override
    public void setParameter(PreparedStatement ps, int i, 
                           Object parameter, JdbcType jdbcType) {
        String json = JSON.toJSONString(parameter);
        ps.setString(i, json);
    }
    
    // è·å–ç»“æœï¼šJSONå­—ç¬¦ä¸² â†’ Javaå¯¹è±¡
    @Override
    public Object getResult(ResultSet rs, String columnName) {
        String json = rs.getString(columnName);
        return JSON.parseObject(json, Object.class);
    }
}
```

---

## 7. ğŸ”„ ç»„ä»¶åä½œæœºåˆ¶


### 7.1 å®Œæ•´æ‰§è¡Œæµç¨‹


**ä»ä»£ç åˆ°æ•°æ®åº“çš„å®Œæ•´è¿‡ç¨‹**ï¼š

```
å®Œæ•´SQLæ‰§è¡Œæµç¨‹ï¼š

åº”ç”¨å±‚è°ƒç”¨
userMapper.selectById(1)
         â†“
æ­¥éª¤ 1ï¸âƒ£ è·å–MappedStatement
ä»Configurationä¸­è·å–å¯¹åº”çš„MappedStatement
         â†“
æ­¥éª¤ 2ï¸âƒ£ ç”ŸæˆBoundSql
sqlSource.getBoundSql(å‚æ•°) â†’ BoundSqlå¯¹è±¡
         â†“
æ­¥éª¤ 3ï¸âƒ£ åˆ›å»ºStatementHandler
configuration.newStatementHandler(...)
         â†“
æ­¥éª¤ 4ï¸âƒ£ åˆ›å»ºPreparedStatement
connection.prepareStatement(sql)
         â†“
æ­¥éª¤ 5ï¸âƒ£ è®¾ç½®å‚æ•°
parameterHandler.setParameters(ps)
é€šè¿‡TypeHandlerè®¾ç½®æ¯ä¸ªå‚æ•°
         â†“
æ­¥éª¤ 6ï¸âƒ£ æ‰§è¡ŒSQL
ps.execute() æˆ– ps.executeQuery()
         â†“
æ­¥éª¤ 7ï¸âƒ£ å¤„ç†ç»“æœ
resultSetHandler.handleResultSets(rs)
é€šè¿‡TypeHandlerè½¬æ¢æ¯ä¸ªå­—æ®µ
         â†“
æ­¥éª¤ 8ï¸âƒ£ è¿”å›ç»“æœ
è¿”å›List<User>æˆ–å•ä¸ªUserå¯¹è±¡
```

### 7.2 ç»„ä»¶äº¤äº’æ—¶åº


```
ç»„ä»¶åä½œæ—¶åºå›¾ï¼š

åº”ç”¨ä»£ç         Configuration    MappedStatement    StatementHandler    ParameterHandler    ResultSetHandler
   |                |                 |                   |                    |                   |
   |--è°ƒç”¨æ–¹æ³•------>|                 |                   |                    |                   |
   |                |--è·å–MS--------->|                   |                    |                   |
   |                |<---è¿”å›MS--------|                   |                    |                   |
   |                |--ç”ŸæˆBoundSql--->|                   |                    |                   |
   |                |<--è¿”å›BoundSql---|                   |                    |                   |
   |                |--åˆ›å»ºHandler---->|                   |                    |                   |
   |                |                  |--å‡†å¤‡Statement--->|                    |                   |
   |                |                  |                   |--è®¾ç½®å‚æ•°--------->|                   |
   |                |                  |                   |<--å‚æ•°è®¾ç½®å®Œæˆ-----|                   |
   |                |                  |--æ‰§è¡ŒSQL--------->|                    |                   |
   |                |                  |<--è¿”å›ResultSet---|                    |                   |
   |                |                  |--å¤„ç†ç»“æœ-------------------------------->|                   |
   |                |                  |<--è¿”å›Javaå¯¹è±¡---------------------------------|                   |
   |<--è¿”å›ç»“æœ-----|                  |                   |                    |                   |
```

### 7.3 ç»„ä»¶åˆå§‹åŒ–æ—¶æœº


**åˆå§‹åŒ–æµç¨‹**ï¼š

```
MyBatiså¯åŠ¨åˆå§‹åŒ–ï¼š

é˜¶æ®µ 1ï¸âƒ£ é…ç½®è§£æ
è¯»å–mybatis-config.xml
åˆ›å»ºConfigurationå¯¹è±¡
         â†“
é˜¶æ®µ 2ï¸âƒ£ Mapperè§£æ
æ‰«æMapper.xmlæ–‡ä»¶
ä¸ºæ¯ä¸ªSQLåˆ›å»ºMappedStatement
æ³¨å†Œåˆ°Configuration
         â†“
é˜¶æ®µ 3ï¸âƒ£ ç»„ä»¶æ³¨å†Œ
æ³¨å†ŒTypeHandler
æ³¨å†ŒTypeAlias
æ³¨å†Œæ’ä»¶Interceptor
         â†“
é˜¶æ®µ 4ï¸âƒ£ åˆ›å»ºSqlSessionFactory
åŸºäºConfigurationåˆ›å»ºå·¥å‚
åç»­ä½¿ç”¨å·¥å‚åˆ›å»ºSqlSession
         â†“
é˜¶æ®µ 5ï¸âƒ£ æ‰§è¡Œæ—¶åˆ›å»º
æ¯æ¬¡æ‰§è¡ŒSQLæ—¶åŠ¨æ€åˆ›å»ºï¼š
- StatementHandler
- ParameterHandler  
- ResultSetHandler
```

**ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ**ï¼š

| ç»„ä»¶ | ç”Ÿå‘½å‘¨æœŸ | ğŸ”¸ä½œç”¨åŸŸ | ğŸ’¡åˆ›å»ºæ—¶æœº |
|------|---------|---------|----------|
| Configuration | å…¨å±€å”¯ä¸€ | Applicationçº§ | åº”ç”¨å¯åŠ¨æ—¶ |
| MappedStatement | å…¨å±€å”¯ä¸€ | Applicationçº§ | é…ç½®è§£ææ—¶ |
| SqlSession | ä¸€æ¬¡ä¼šè¯ | Requestçº§ | æ¯æ¬¡è¯·æ±‚æ—¶ |
| StatementHandler | ä¸€æ¬¡SQLæ‰§è¡Œ | Methodçº§ | æ¯æ¬¡SQLæ‰§è¡Œæ—¶ |
| ParameterHandler | ä¸€æ¬¡SQLæ‰§è¡Œ | Methodçº§ | æ¯æ¬¡SQLæ‰§è¡Œæ—¶ |
| ResultSetHandler | ä¸€æ¬¡SQLæ‰§è¡Œ | Methodçº§ | æ¯æ¬¡SQLæ‰§è¡Œæ—¶ |

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ¯ ä¸ƒå¤§æ ¸å¿ƒç»„ä»¶**ï¼š

| ç»„ä»¶ | ğŸ”¸æ ¸å¿ƒä½œç”¨ | ğŸ’¡è®°å¿†è¦ç‚¹ |
|------|-----------|----------|
| **Configuration** | é…ç½®ä¸­å¿ƒ | MyBatisçš„"å¤§è„‘"ï¼Œå­˜å‚¨æ‰€æœ‰é…ç½® |
| **MappedStatement** | SQLæ˜ å°„ | ä¸€æ¡SQLçš„"æ“ä½œæ‰‹å†Œ" |
| **BoundSql** | ç»‘å®šSQL | å¡«å¥½å‚æ•°çš„"å¯æ‰§è¡ŒSQL" |
| **StatementHandler** | è¯­å¥å¤„ç† | æ‰§è¡ŒSQLçš„"æ€»æŒ‡æŒ¥" |
| **ParameterHandler** | å‚æ•°å¤„ç† | Javaå‚æ•°çš„"å¡«å……å‘˜" |
| **ResultSetHandler** | ç»“æœå¤„ç† | ç»“æœé›†çš„"ç¿»è¯‘å‘˜" |
| **TypeHandler** | ç±»å‹è½¬æ¢ | Javaå’Œæ•°æ®åº“çš„"è½¬æ¢å™¨" |

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¸ ç»„ä»¶å…³ç³»é“¾**ï¼š
```
é…ç½®å±‚ï¼šConfiguration â†’ å­˜å‚¨æ‰€æœ‰é…ç½®å’ŒMappedStatement
æ˜ å°„å±‚ï¼šMappedStatement â†’ åŒ…å«SqlSource
SQLå±‚ï¼šSqlSource â†’ ç”ŸæˆBoundSql
æ‰§è¡Œå±‚ï¼šStatementHandler â†’ åè°ƒParameterHandlerå’ŒResultSetHandler
è½¬æ¢å±‚ï¼šTypeHandler â†’ åœ¨æ‰§è¡Œå±‚å„ç¯èŠ‚è¿›è¡Œç±»å‹è½¬æ¢
```

**ğŸ”¸ æ‰§è¡Œæµç¨‹ç²¾ç®€ç‰ˆ**ï¼š
```
1. ä»Configurationè·å–MappedStatement
2. MappedStatementç”ŸæˆBoundSql
3. åˆ›å»ºStatementHandler
4. ParameterHandlerè®¾ç½®å‚æ•°
5. æ‰§è¡ŒSQL
6. ResultSetHandlerå¤„ç†ç»“æœ
7. è¿”å›Javaå¯¹è±¡
```

**ğŸ”¸ åˆå§‹åŒ–vsæ‰§è¡Œæ—¶**ï¼š
- â±ï¸ **åˆå§‹åŒ–ä¸€æ¬¡**ï¼šConfigurationã€MappedStatement
- â±ï¸ **æ¯æ¬¡åˆ›å»º**ï¼šStatementHandlerã€ParameterHandlerã€ResultSetHandler

### 8.3 å­¦ä¹ å»ºè®®


**ğŸŸ¢ å…¥é—¨é˜¶æ®µ**ï¼š
- âœ… ç†è§£ORMæ¡†æ¶çš„æœ¬è´¨ä½œç”¨
- âœ… æŒæ¡Configurationå’ŒMappedStatementçš„æ¦‚å¿µ
- âœ… äº†è§£æ‰§è¡Œå±‚å››å¤§ç»„ä»¶çš„èŒè´£

**ğŸŸ¡ è¿›é˜¶é˜¶æ®µ**ï¼š
- âœ… æ·±å…¥BoundSqlçš„ç”Ÿæˆè¿‡ç¨‹
- âœ… ç†è§£åŠ¨æ€SQLå¦‚ä½•è§£æ
- âœ… æŒæ¡TypeHandlerçš„è‡ªå®šä¹‰

**ğŸ”´ é«˜çº§é˜¶æ®µ**ï¼š
- âœ… ç ”ç©¶ç»„ä»¶çš„åˆå§‹åŒ–æµç¨‹
- âœ… åˆ†ææ’ä»¶æœºåˆ¶å¦‚ä½•æ‹¦æˆªç»„ä»¶
- âœ… ä¼˜åŒ–SQLæ‰§è¡Œæ€§èƒ½

### 8.4 å¸¸è§é—®é¢˜è§£ç­”


**â“ Configurationä»€ä¹ˆæ—¶å€™åˆ›å»º**ï¼Ÿ
```
ç­”ï¼šåº”ç”¨å¯åŠ¨æ—¶ï¼Œè§£æé…ç½®æ–‡ä»¶ååˆ›å»º
å…¨å±€å”¯ä¸€ï¼Œè´¯ç©¿æ•´ä¸ªåº”ç”¨ç”Ÿå‘½å‘¨æœŸ
```

**â“ ä¸€ä¸ªMapper.xmlä¸­çš„å¤šä¸ªSQLå¯¹åº”å‡ ä¸ªMappedStatement**ï¼Ÿ
```
ç­”ï¼šæ¯ä¸ª<select>ã€<insert>ç­‰æ ‡ç­¾å¯¹åº”ä¸€ä¸ªMappedStatement
æ¯”å¦‚ï¼š5ä¸ª<select>æ ‡ç­¾ = 5ä¸ªMappedStatementå¯¹è±¡
```

**â“ BoundSqlæ¯æ¬¡éƒ½é‡æ–°ç”Ÿæˆå—**ï¼Ÿ
```
ç­”ï¼šæ˜¯çš„ï¼Œæ¯æ¬¡æ‰§è¡ŒSQLéƒ½ä¼šç”Ÿæˆæ–°çš„BoundSql
å› ä¸ºå‚æ•°å¯èƒ½ä¸åŒï¼ŒåŠ¨æ€SQLç»“æœä¹Ÿå¯èƒ½ä¸åŒ
```

**â“ TypeHandleræ˜¯ä½•æ—¶è¢«è°ƒç”¨çš„**ï¼Ÿ
```
ç­”ï¼šä¸¤ä¸ªæ—¶æœº
1. è®¾ç½®å‚æ•°æ—¶ï¼šParameterHandlerè°ƒç”¨TypeHandler.setParameter()
2. è·å–ç»“æœæ—¶ï¼šResultSetHandlerè°ƒç”¨TypeHandler.getResult()
```

### 8.5 è®°å¿†å£è¯€


```
ğŸ¯ MyBatisæ ¸å¿ƒç»„ä»¶è®°å¿†å£è¯€ï¼š

Configurationæ˜¯å¤§è„‘ï¼Œå­˜å‚¨é…ç½®å’Œæ˜ å°„
MappedStatementæ“ä½œä¹¦ï¼Œè®°å½•SQLæ€ä¹ˆæ
SqlSourceç”ŸæˆBoundSqlï¼ŒåŠ¨æ€SQLå…¨é å®ƒ
StatementHandleræ€»æŒ‡æŒ¥ï¼Œæ‰§è¡Œæµç¨‹å®ƒå®‰æ’
ParameterHandlerå¡«å‚æ•°ï¼Œé—®å·å ä½å®ƒæ¥å¡«
ResultSetHandlerç¿»è¯‘å®˜ï¼Œæ•°æ®åº“å˜Javaå¯¹è±¡
TypeHandlerè½¬æ¢å™¨ï¼ŒJavaæ•°æ®åº“äº’è½¬æ¢

æ‰§è¡Œæµç¨‹è¦è®°ç‰¢ï¼š
è·å–MS â†’ ç”ŸæˆBoundSql â†’ åˆ›å»ºHandler
è®¾ç½®å‚æ•° â†’ æ‰§è¡ŒSQL â†’ å¤„ç†ç»“æœ
```

---

**ğŸ“ å­¦ä¹ æç¤º**ï¼š
- ğŸ’¡ ç†è§£ç»„ä»¶æ¯”è®°å¿†ä»£ç æ›´é‡è¦
- ğŸ’¡ ç”»å›¾æ¢³ç†ç»„ä»¶å…³ç³»æœ‰åŠ©äºç†è§£
- ğŸ’¡ ç»“åˆå®é™…SQLæ‰§è¡Œè¿‡ç¨‹å­¦ä¹ 
- ğŸ’¡ åŠ¨æ‰‹è°ƒè¯•æºç åŠ æ·±å°è±¡