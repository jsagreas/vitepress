---
title: 23ã€è‡ªå®šä¹‰ç¼“å­˜å®ç°
---
## ğŸ“š ç›®å½•

1. [è‡ªå®šä¹‰ç¼“å­˜æ¦‚è¿°](#1-è‡ªå®šä¹‰ç¼“å­˜æ¦‚è¿°)
2. [Cacheæ¥å£æ·±å…¥ç†è§£](#2-Cacheæ¥å£æ·±å…¥ç†è§£)
3. [è£…é¥°å™¨æ¨¡å¼åœ¨ç¼“å­˜ä¸­çš„åº”ç”¨](#3-è£…é¥°å™¨æ¨¡å¼åœ¨ç¼“å­˜ä¸­çš„åº”ç”¨)
4. [Redisç¼“å­˜é›†æˆå®æˆ˜](#4-Redisç¼“å­˜é›†æˆå®æˆ˜)
5. [å…¶ä»–ç¼“å­˜æ–¹æ¡ˆé›†æˆ](#5-å…¶ä»–ç¼“å­˜æ–¹æ¡ˆé›†æˆ)
6. [åˆ†å¸ƒå¼ç¼“å­˜è§£å†³æ–¹æ¡ˆ](#6-åˆ†å¸ƒå¼ç¼“å­˜è§£å†³æ–¹æ¡ˆ)
7. [ç¼“å­˜ç­–ç•¥ä¸ä¼˜åŒ–](#7-ç¼“å­˜ç­–ç•¥ä¸ä¼˜åŒ–)
8. [ç¼“å­˜ç›‘æ§ä¸è°ƒä¼˜](#8-ç¼“å­˜ç›‘æ§ä¸è°ƒä¼˜)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è‡ªå®šä¹‰ç¼“å­˜æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰ç¼“å­˜


**ç”Ÿæ´»åŒ–ç†è§£**ï¼š
æƒ³è±¡ä½ åœ¨ç©ä¸€ä¸ªæ”¶é›†æ¸¸æˆï¼Œç³»ç»Ÿè‡ªå¸¦çš„èƒŒåŒ…ï¼ˆMyBatisé»˜è®¤ç¼“å­˜ï¼‰åªèƒ½è£…100ä¸ªç‰©å“ã€‚ä½†ä½ æ”¶é›†çš„å®è´è¶Šæ¥è¶Šå¤šï¼Œéœ€è¦ä¸€ä¸ªæ›´å¤§çš„ä»“åº“ï¼ˆRedisï¼‰æˆ–è€…æ›´æ™ºèƒ½çš„æ”¶çº³ç›’ï¼ˆCaffeineï¼‰ã€‚è¿™å°±æ˜¯è‡ªå®šä¹‰ç¼“å­˜çš„æ„ä¹‰ã€‚

```
ğŸ  MyBatisé»˜è®¤ç¼“å­˜çš„å±€é™ï¼š
âŒ åªèƒ½å­˜åœ¨å†…å­˜ä¸­ï¼ŒæœåŠ¡é‡å¯å°±ä¸¢å¤±
âŒ å•æœºç¼“å­˜ï¼Œå¤šå°æœåŠ¡å™¨æ— æ³•å…±äº«
âŒ å®¹é‡æœ‰é™ï¼Œç¼“å­˜ç­–ç•¥å•ä¸€
âŒ æ— æ³•æŒä¹…åŒ–ï¼Œæ•°æ®ä¸å¤Ÿå®‰å…¨

ğŸš€ è‡ªå®šä¹‰ç¼“å­˜èƒ½è§£å†³ä»€ä¹ˆï¼š
âœ… æ•°æ®æŒä¹…åŒ– - å­˜åˆ°Redisç­‰å¤–éƒ¨å­˜å‚¨
âœ… åˆ†å¸ƒå¼å…±äº« - å¤šå°æœåŠ¡å™¨å…±ç”¨ä¸€ä¸ªç¼“å­˜
âœ… çµæ´»ç­–ç•¥ - è‡ªå®šä¹‰è¿‡æœŸæ—¶é—´ã€æ·˜æ±°ç®—æ³•
âœ… æ›´å¼ºæ€§èƒ½ - ä¸“ä¸šç¼“å­˜æ¡†æ¶çš„ä¼˜åŒ–
```

### 1.2 è‡ªå®šä¹‰ç¼“å­˜çš„åº”ç”¨åœºæ™¯


**ğŸ® å®é™…ä¸šåŠ¡åœºæ™¯**ï¼š

| åœºæ™¯ | **é»˜è®¤ç¼“å­˜** | **è‡ªå®šä¹‰ç¼“å­˜** | **æ¨èæ–¹æ¡ˆ** |
|------|-------------|---------------|--------------|
| **å°å‹å•æœºåº”ç”¨** | `âœ… å¤Ÿç”¨` | `ä¸å¿…è¦` | `PerpetualCache` |
| **åˆ†å¸ƒå¼ç³»ç»Ÿ** | `âŒ æ•°æ®ä¸åŒæ­¥` | `âœ… å¿…é¡»` | `Redisç¼“å­˜` |
| **é«˜å¹¶å‘è¯»å–** | `âŒ æ€§èƒ½ç“¶é¢ˆ` | `âœ… éœ€è¦` | `Caffeineæœ¬åœ°+Redis` |
| **æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜** | `âŒ ä¸å¯é ` | `âœ… éœ€è¦` | `åˆ†å¸ƒå¼ç¼“å­˜+åŒæ­¥æœºåˆ¶` |

**ğŸ’¡ é€‰æ‹©å»ºè®®**ï¼š
```
ğŸ“Š å†³ç­–æµç¨‹ï¼š
å¼€å§‹
  â†“
å•æœºåº”ç”¨ï¼Ÿ â”€â”€æ˜¯â”€â”€> ä½¿ç”¨é»˜è®¤ç¼“å­˜
  â†“ å¦
æ•°æ®é‡å¤§ï¼Ÿ â”€â”€æ˜¯â”€â”€> è€ƒè™‘Redis
  â†“ å¦
é«˜å¹¶å‘ï¼Ÿ â”€â”€æ˜¯â”€â”€> Caffeine + Redis
  â†“ å¦
ä½¿ç”¨é»˜è®¤ç¼“å­˜å³å¯
```

---

## 2. ğŸ”§ Cacheæ¥å£æ·±å…¥ç†è§£


### 2.1 Cacheæ¥å£çš„æœ¬è´¨


**é€šä¿—è§£é‡Š**ï¼š
Cacheæ¥å£å°±åƒä¸€ä»½"ç¼“å­˜ç›’å­"çš„è®¾è®¡å›¾çº¸ï¼Œè§„å®šäº†è¿™ä¸ªç›’å­å¿…é¡»èƒ½åšä»€ä¹ˆï¼šå­˜ä¸œè¥¿ã€å–ä¸œè¥¿ã€åˆ ä¸œè¥¿ã€æ¸…ç©ºç­‰ã€‚ä½ å¯ä»¥æŒ‰ç…§è¿™ä»½å›¾çº¸åšæœ¨ç›’å­ï¼ˆå†…å­˜ç¼“å­˜ï¼‰ã€é“ç›’å­ï¼ˆRedisï¼‰ã€æ™ºèƒ½ç›’å­ï¼ˆCaffeineï¼‰ã€‚

**ğŸ“‹ Cacheæ¥å£æ ¸å¿ƒæ–¹æ³•**ï¼š
```java
public interface Cache {
    // è·å–ç¼“å­˜çš„å”¯ä¸€æ ‡è¯†ï¼ˆå‘½åç©ºé—´ï¼‰
    String getId();
    
    // å­˜å…¥ç¼“å­˜
    void putObject(Object key, Object value);
    
    // ä»ç¼“å­˜è·å–
    Object getObject(Object key);
    
    // åˆ é™¤æŒ‡å®šç¼“å­˜
    Object removeObject(Object key);
    
    // æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
    void clear();
    
    // è·å–ç¼“å­˜æ•°é‡ï¼ˆå¯é€‰ï¼‰
    int getSize();
}
```

### 2.2 å®ç°è‡ªå·±çš„ç¼“å­˜


**ğŸ› ï¸ æœ€ç®€å•çš„è‡ªå®šä¹‰ç¼“å­˜**ï¼š

```java
public class SimpleCache implements Cache {
    // ç¼“å­˜çš„å”¯ä¸€æ ‡è¯†
    private final String id;
    
    // ç”¨Mapå­˜å‚¨ç¼“å­˜æ•°æ®ï¼ˆæ ¸å¿ƒå­˜å‚¨ï¼‰
    private Map<Object, Object> cache = new HashMap<>();
    
    public SimpleCache(String id) {
        this.id = id;
    }
    
    @Override
    public String getId() {
        return id;
    }
    
    @Override
    public void putObject(Object key, Object value) {
        cache.put(key, value);  // å­˜å…¥ç¼“å­˜
    }
    
    @Override
    public Object getObject(Object key) {
        return cache.get(key);  // è·å–ç¼“å­˜
    }
    
    @Override
    public Object removeObject(Object key) {
        return cache.remove(key);  // åˆ é™¤ç¼“å­˜
    }
    
    @Override
    public void clear() {
        cache.clear();  // æ¸…ç©ºç¼“å­˜
    }
    
    @Override
    public int getSize() {
        return cache.size();  // è¿”å›ç¼“å­˜æ•°é‡
    }
}
```

**ğŸ” ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜**ï¼š
```xml
<!-- åœ¨Mapper.xmlä¸­é…ç½® -->
<cache type="com.example.cache.SimpleCache">
    <!-- typeæŒ‡å®šä½ è‡ªå·±çš„ç¼“å­˜å®ç°ç±» -->
</cache>
```

### 2.3 ç¼“å­˜å·¥ä½œæµç¨‹


**ğŸ“Š ç¼“å­˜è°ƒç”¨æµç¨‹å›¾**ï¼š
```
SQLæŸ¥è¯¢è¯·æ±‚
    â†“
MyBatisæ‹¦æˆª
    â†“
æ£€æŸ¥æ˜¯å¦å¯ç”¨ç¼“å­˜ï¼Ÿ
    â†“ æ˜¯
è°ƒç”¨Cache.getObject(key)
    â†“
ç¼“å­˜å‘½ä¸­ï¼Ÿ â”€â”€æ˜¯â”€â”€> ç›´æ¥è¿”å›æ•°æ®
    â†“ å¦
æŸ¥è¯¢æ•°æ®åº“
    â†“
è°ƒç”¨Cache.putObject(key, value)
    â†“
è¿”å›æ•°æ®ç»™ç”¨æˆ·
```

**ğŸ¯ å…³é”®ç†è§£**ï¼š
```
ç¼“å­˜Keyçš„ç”Ÿæˆï¼š
â€¢ SQLè¯­å¥ + å‚æ•°å€¼ + åˆ†é¡µä¿¡æ¯ = å”¯ä¸€Key
â€¢ ä¾‹ï¼šSELECT * FROM user WHERE id = 1
  ç”Ÿæˆkeyï¼šnamespace:sql:params

ç¼“å­˜Valueçš„å­˜å‚¨ï¼š
â€¢ ç›´æ¥å­˜å‚¨æŸ¥è¯¢ç»“æœå¯¹è±¡
â€¢ å¯ä»¥æ˜¯å•ä¸ªå¯¹è±¡æˆ–Listé›†åˆ
```

---

## 3. ğŸ¨ è£…é¥°å™¨æ¨¡å¼åœ¨ç¼“å­˜ä¸­çš„åº”ç”¨


### 3.1 ä»€ä¹ˆæ˜¯è£…é¥°å™¨æ¨¡å¼


**ç”Ÿæ´»åŒ–æ¯”å–»**ï¼š
è£…é¥°å™¨æ¨¡å¼å°±åƒ"ä¿„ç½—æ–¯å¥—å¨ƒ"ï¼Œä¸€å±‚å¥—ä¸€å±‚ï¼Œæ¯å±‚éƒ½å¢åŠ æ–°åŠŸèƒ½ã€‚

```
åŸºç¡€ç¼“å­˜ï¼ˆæ ¸å¿ƒå¨ƒå¨ƒï¼‰
  â†“ åŒ…è£…
+ è¿‡æœŸåŠŸèƒ½ï¼ˆç¬¬ä¸€å±‚ï¼‰
  â†“ åŒ…è£…  
+ æ—¥å¿—åŠŸèƒ½ï¼ˆç¬¬äºŒå±‚ï¼‰
  â†“ åŒ…è£…
+ åŒæ­¥åŠŸèƒ½ï¼ˆç¬¬ä¸‰å±‚ï¼‰
= æœ€ç»ˆçš„åŠŸèƒ½å®Œæ•´çš„ç¼“å­˜
```

### 3.2 MyBatiså†…ç½®è£…é¥°å™¨


**ğŸ”¸ å¸¸ç”¨è£…é¥°å™¨ç¼“å­˜**ï¼š

**1. LruCache - æœ€è¿‘æœ€å°‘ä½¿ç”¨æ·˜æ±°**
```
å·¥ä½œåŸç†ï¼š
å°±åƒä½ çš„è¡£æŸœï¼Œé•¿æ—¶é—´ä¸ç©¿çš„è¡£æœå°±æ‰”æ‰

é…ç½®æ–¹å¼ï¼š
<cache eviction="LRU" size="512"/>
  â†“
åŒ…è£…å…³ç³»ï¼š
LruCache â†’ PerpetualCache
```

**2. FifoCache - å…ˆè¿›å…ˆå‡ºæ·˜æ±°**
```
å·¥ä½œåŸç†ï¼š
å°±åƒæ’é˜Ÿä¹°ç¥¨ï¼Œå…ˆæ¥çš„å…ˆèµ°

é…ç½®æ–¹å¼ï¼š
<cache eviction="FIFO" size="512"/>
```

**3. SoftCache - è½¯å¼•ç”¨ç¼“å­˜**
```
å·¥ä½œåŸç†ï¼š
å†…å­˜ç´§å¼ æ—¶ï¼ŒJVMè‡ªåŠ¨å›æ”¶

é€‚ç”¨åœºæ™¯ï¼š
â€¢ æ•°æ®å¯ä»¥é‡æ–°è·å–
â€¢ å¸Œæœ›å……åˆ†åˆ©ç”¨å†…å­˜
```

**4. ScheduledCache - å®šæ—¶æ¸…ç©ºç¼“å­˜**
```
å·¥ä½œåŸç†ï¼š
æ¯éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨æ¸…ç©ºç¼“å­˜

é…ç½®æ–¹å¼ï¼š
<cache flushInterval="60000"/>  <!-- 60ç§’ -->
```

### 3.3 è£…é¥°å™¨é“¾çš„ç»„åˆ


**ğŸ”— å¤šå±‚è£…é¥°å™¨å åŠ **ï¼š
```xml
<cache 
    eviction="LRU"           <!-- LRUè£…é¥°å™¨ -->
    flushInterval="60000"    <!-- å®šæ—¶æ¸…ç©ºè£…é¥°å™¨ -->
    size="512"               <!-- å®¹é‡é™åˆ¶ -->
    readOnly="false">        <!-- åºåˆ—åŒ–è£…é¥°å™¨ -->
</cache>
```

**å®é™…åŒ…è£…é¡ºåº**ï¼š
```
æœ€å¤–å±‚ï¼šSynchronizedCacheï¼ˆåŒæ­¥é”ï¼‰
  â†“
LoggingCacheï¼ˆæ—¥å¿—è®°å½•ï¼‰
  â†“
ScheduledCacheï¼ˆå®šæ—¶æ¸…ç©ºï¼‰
  â†“
LruCacheï¼ˆLRUæ·˜æ±°ï¼‰
  â†“
SerializedCacheï¼ˆåºåˆ—åŒ–ï¼‰
  â†“
PerpetualCacheï¼ˆåŸºç¡€ç¼“å­˜ï¼‰
```

**ğŸ’¡ ç†è§£è¦ç‚¹**ï¼š
```
ä¸ºä»€ä¹ˆè¦å¤šå±‚åŒ…è£…ï¼Ÿ
â€¢ æ¯å±‚è´Ÿè´£ä¸€ä¸ªåŠŸèƒ½ï¼ŒèŒè´£å•ä¸€
â€¢ çµæ´»ç»„åˆï¼ŒæŒ‰éœ€é€‰æ‹©
â€¢ ä¾¿äºæ‰©å±•ï¼Œæ–°åŠŸèƒ½åªéœ€åŠ ä¸€å±‚

è°ƒç”¨è¿‡ç¨‹ï¼š
getObject() â†’ ä»å¤–åˆ°å†…é€å±‚è°ƒç”¨
putObject() â†’ ä»å¤–åˆ°å†…é€å±‚æ‰§è¡Œ
```

---

## 4. ğŸ”´ Redisç¼“å­˜é›†æˆå®æˆ˜


### 4.1 ä¸ºä»€ä¹ˆé€‰æ‹©Redis


**Redisçš„ç‹¬ç‰¹ä¼˜åŠ¿**ï¼š
```
ğŸš€ æ€§èƒ½ä¼˜åŠ¿ï¼š
â€¢ å†…å­˜å­˜å‚¨ï¼Œè¯»å†™è¶…å¿«
â€¢ å•çº¿ç¨‹æ¨¡å‹ï¼Œæ— é”ç«äº‰
â€¢ æ”¯æŒæ•°æ®ç»“æ„ä¸°å¯Œ

ğŸ“¡ åˆ†å¸ƒå¼ä¼˜åŠ¿ï¼š
â€¢ å¤šå°æœåŠ¡å™¨å…±äº«ç¼“å­˜
â€¢ æ•°æ®æŒä¹…åŒ–ï¼Œé‡å¯ä¸ä¸¢å¤±
â€¢ ä¸»ä»å¤åˆ¶ï¼Œé«˜å¯ç”¨

ğŸ”§ åŠŸèƒ½ä¼˜åŠ¿ï¼š
â€¢ æ”¯æŒè¿‡æœŸæ—¶é—´
â€¢ å‘å¸ƒè®¢é˜…åŠŸèƒ½
â€¢ äº‹åŠ¡æ”¯æŒ
```

### 4.2 Redisç¼“å­˜å®ç°


**ğŸ› ï¸ ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ–**
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

**ğŸ’» ç¬¬äºŒæ­¥ï¼šå®ç°Cacheæ¥å£**
```java
public class RedisCache implements Cache {
    private final String id;
    private RedisTemplate<String, Object> redisTemplate;
    
    // é»˜è®¤è¿‡æœŸæ—¶é—´ï¼š30åˆ†é’Ÿ
    private static final long EXPIRE_TIME = 1800;
    
    public RedisCache(String id) {
        this.id = id;
    }
    
    @Override
    public String getId() {
        return id;
    }
    
    @Override
    public void putObject(Object key, Object value) {
        // ç”ŸæˆRedisçš„keyï¼šnamespace:cacheKey
        String redisKey = id + ":" + key;
        
        // å­˜å…¥Rediså¹¶è®¾ç½®è¿‡æœŸæ—¶é—´
        redisTemplate.opsForValue().set(
            redisKey, 
            value, 
            EXPIRE_TIME, 
            TimeUnit.SECONDS
        );
    }
    
    @Override
    public Object getObject(Object key) {
        String redisKey = id + ":" + key;
        return redisTemplate.opsForValue().get(redisKey);
    }
    
    @Override
    public Object removeObject(Object key) {
        String redisKey = id + ":" + key;
        Object value = redisTemplate.opsForValue().get(redisKey);
        redisTemplate.delete(redisKey);
        return value;
    }
    
    @Override
    public void clear() {
        // æ¸…ç©ºå½“å‰namespaceä¸‹çš„æ‰€æœ‰ç¼“å­˜
        Set<String> keys = redisTemplate.keys(id + ":*");
        if (keys != null && !keys.isEmpty()) {
            redisTemplate.delete(keys);
        }
    }
}
```

**ğŸ“ ç¬¬ä¸‰æ­¥ï¼šé…ç½®ä½¿ç”¨**
```xml
<cache type="com.example.cache.RedisCache"/>
```

### 4.3 Redisç¼“å­˜ä¼˜åŒ–


**âš¡ åºåˆ—åŒ–ä¼˜åŒ–**ï¼š
```java
// ä½¿ç”¨æ›´é«˜æ•ˆçš„åºåˆ—åŒ–æ–¹å¼
@Configuration
public class RedisConfig {
    @Bean
    public RedisTemplate<String, Object> redisTemplate(
        RedisConnectionFactory factory) {
        
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        
        // ä½¿ç”¨Jacksonåºåˆ—åŒ–ï¼ˆæ¯”JDKåºåˆ—åŒ–å¿«ï¼‰
        Jackson2JsonRedisSerializer<Object> serializer = 
            new Jackson2JsonRedisSerializer<>(Object.class);
        
        template.setValueSerializer(serializer);
        template.setKeySerializer(new StringRedisSerializer());
        
        return template;
    }
}
```

**ğŸ”‘ Keyè®¾è®¡ä¼˜åŒ–**ï¼š
```
è‰¯å¥½çš„Keyè®¾è®¡ï¼š
âœ… user:info:1              # æ¸…æ™°çš„å±‚æ¬¡ç»“æ„
âœ… order:detail:20231201    # åŒ…å«ä¸šåŠ¡å«ä¹‰
âœ… product:list:hot         # ä¾¿äºæ‰¹é‡æ“ä½œ

ä¸å¥½çš„Keyè®¾è®¡ï¼š
âŒ u1                       # å«ä¹‰ä¸æ˜
âŒ 123456                   # æ— ä¸šåŠ¡è¯­ä¹‰
âŒ verylongkeyname12345     # è¿‡é•¿æµªè´¹å†…å­˜
```

---

## 5. ğŸ¯ å…¶ä»–ç¼“å­˜æ–¹æ¡ˆé›†æˆ


### 5.1 EhCacheæœ¬åœ°ç¼“å­˜


**EhCacheç‰¹ç‚¹**ï¼š
å°±åƒåœ¨å®¶é‡Œï¼ˆå†…å­˜ï¼‰æ”¾ä¸ªä¿é™©æŸœï¼Œå¿«ä½†å®¹é‡æœ‰é™ã€‚

```java
public class EhCacheCache implements Cache {
    private final String id;
    private final CacheManager cacheManager;
    
    public EhCacheCache(String id) {
        this.id = id;
        // åˆ›å»ºEhCacheç®¡ç†å™¨
        this.cacheManager = CacheManager.getInstance();
        
        // å¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
        if (!cacheManager.cacheExists(id)) {
            cacheManager.addCache(id);
        }
    }
    
    @Override
    public void putObject(Object key, Object value) {
        getCache().put(new Element(key, value));
    }
    
    @Override
    public Object getObject(Object key) {
        Element element = getCache().get(key);
        return element != null ? element.getObjectValue() : null;
    }
    
    private net.sf.ehcache.Cache getCache() {
        return cacheManager.getCache(id);
    }
}
```

**âš™ï¸ EhCacheé…ç½®**ï¼š
```xml
<!-- ehcache.xml -->
<ehcache>
    <defaultCache
        maxElementsInMemory="10000"    <!-- æœ€å¤§ç¼“å­˜æ•°é‡ -->
        eternal="false"                <!-- ä¸æ˜¯æ°¸ä¹…ç¼“å­˜ -->
        timeToIdleSeconds="600"        <!-- ç©ºé—²10åˆ†é’Ÿè¿‡æœŸ -->
        timeToLiveSeconds="1800"       <!-- å­˜æ´»30åˆ†é’Ÿè¿‡æœŸ -->
        overflowToDisk="false"/>       <!-- ä¸æº¢å‡ºåˆ°ç£ç›˜ -->
</ehcache>
```

### 5.2 Caffeineé«˜æ€§èƒ½ç¼“å­˜


**Caffeineç‰¹ç‚¹**ï¼š
Googleå‡ºå“çš„é«˜æ€§èƒ½æœ¬åœ°ç¼“å­˜ï¼Œæ¯”EhCacheæ›´å¿«æ›´å¼ºã€‚

```java
public class CaffeineCache implements Cache {
    private final String id;
    private final com.github.benmanes.caffeine.cache.Cache<Object, Object> cache;
    
    public CaffeineCache(String id) {
        this.id = id;
        
        // æ„å»ºCaffeineç¼“å­˜
        this.cache = Caffeine.newBuilder()
            .maximumSize(10000)              // æœ€å¤§10000æ¡
            .expireAfterWrite(30, TimeUnit.MINUTES)  // å†™å…¥30åˆ†é’Ÿè¿‡æœŸ
            .expireAfterAccess(10, TimeUnit.MINUTES) // è®¿é—®10åˆ†é’Ÿè¿‡æœŸ
            .recordStats()                   // è®°å½•ç»Ÿè®¡ä¿¡æ¯
            .build();
    }
    
    @Override
    public void putObject(Object key, Object value) {
        cache.put(key, value);
    }
    
    @Override
    public Object getObject(Object key) {
        return cache.getIfPresent(key);
    }
}
```

**ğŸ“Š æ€§èƒ½å¯¹æ¯”**ï¼š
```
æœ¬åœ°ç¼“å­˜æ€§èƒ½æ’åï¼š
Caffeine > Guava > EhCache > ConcurrentHashMap

é€‰æ‹©å»ºè®®ï¼š
â€¢ è¿½æ±‚æè‡´æ€§èƒ½ â†’ Caffeine
â€¢ éœ€è¦å¤æ‚é…ç½® â†’ EhCache
â€¢ ç®€å•åœºæ™¯ â†’ ConcurrentHashMap
```

### 5.3 å¤šçº§ç¼“å­˜æ–¹æ¡ˆ


**ğŸ—ï¸ æœ¬åœ°ç¼“å­˜ + RedisäºŒçº§ç¼“å­˜**ï¼š

```java
public class MultiLevelCache implements Cache {
    private final String id;
    private final Cache localCache;   // ä¸€çº§ï¼šæœ¬åœ°ç¼“å­˜ï¼ˆå¿«ï¼‰
    private final Cache redisCache;   // äºŒçº§ï¼šRedisç¼“å­˜ï¼ˆå…±äº«ï¼‰
    
    public MultiLevelCache(String id) {
        this.id = id;
        this.localCache = new CaffeineCache(id);
        this.redisCache = new RedisCache(id);
    }
    
    @Override
    public Object getObject(Object key) {
        // 1. å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        Object value = localCache.getObject(key);
        if (value != null) {
            return value;  // å‘½ä¸­æœ¬åœ°ç¼“å­˜ï¼Œç›´æ¥è¿”å›
        }
        
        // 2. æœ¬åœ°æ²¡æœ‰ï¼ŒæŸ¥Redis
        value = redisCache.getObject(key);
        if (value != null) {
            // å›å†™åˆ°æœ¬åœ°ç¼“å­˜
            localCache.putObject(key, value);
        }
        
        return value;
    }
    
    @Override
    public void putObject(Object key, Object value) {
        // åŒæ—¶å†™å…¥ä¸¤çº§ç¼“å­˜
        localCache.putObject(key, value);
        redisCache.putObject(key, value);
    }
}
```

**ğŸ¯ å¤šçº§ç¼“å­˜ä¼˜åŠ¿**ï¼š
```
æŸ¥è¯¢æµç¨‹ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ æœ¬åœ°ç¼“å­˜ï¼ˆæ¯«ç§’çº§ï¼‰â†’ Redisç¼“å­˜ï¼ˆå‡ æ¯«ç§’ï¼‰â†’ æ•°æ®åº“ï¼ˆåå‡ æ¯«ç§’ï¼‰

å¥½å¤„ï¼š
âœ… æœ¬åœ°ç¼“å­˜ï¼šæé€Ÿå“åº”ï¼Œå‡å°‘ç½‘ç»œå¼€é”€
âœ… Redisç¼“å­˜ï¼šåˆ†å¸ƒå¼å…±äº«ï¼Œæ•°æ®ä¸€è‡´
âœ… é™ä½Rediså‹åŠ›ï¼šå¤§éƒ¨åˆ†è¯·æ±‚æœ¬åœ°è§£å†³
```

---

## 6. ğŸŒ åˆ†å¸ƒå¼ç¼“å­˜è§£å†³æ–¹æ¡ˆ


### 6.1 åˆ†å¸ƒå¼ç¼“å­˜çš„æŒ‘æˆ˜


**ğŸ¤” åˆ†å¸ƒå¼ç¯å¢ƒçš„é—®é¢˜**ï¼š

```
å•æœºç¼“å­˜çš„é—®é¢˜ï¼š
æœåŠ¡å™¨A  [ç¼“å­˜ï¼šuser:1 = {name:"å¼ ä¸‰"}]
æœåŠ¡å™¨B  [ç¼“å­˜ï¼šuser:1 = {name:"å¼ ä¸‰"}]
æœåŠ¡å™¨C  [ç¼“å­˜ï¼šuser:1 = {name:"å¼ ä¸‰"}]

Aæ›´æ–°æ•°æ®åº“ï¼šuser:1 = {name:"æå››"}
Aæ¸…ç©ºè‡ªå·±çš„ç¼“å­˜
ä½†Bå’ŒCçš„ç¼“å­˜è¿˜æ˜¯æ—§æ•°æ®ï¼âŒ

ç»“æœï¼š
â€¢ è¯·æ±‚åˆ°Aï¼šè¿”å›æå››ï¼ˆæ­£ç¡®ï¼‰
â€¢ è¯·æ±‚åˆ°Bï¼šè¿”å›å¼ ä¸‰ï¼ˆé”™è¯¯ï¼‰
â€¢ è¯·æ±‚åˆ°Cï¼šè¿”å›å¼ ä¸‰ï¼ˆé”™è¯¯ï¼‰
```

### 6.2 ç¼“å­˜åŒæ­¥ç­–ç•¥


**ğŸ“¡ ç­–ç•¥ä¸€ï¼šæ¶ˆæ¯é˜Ÿåˆ—åŒæ­¥**

```
æ›´æ–°æµç¨‹ï¼š
æœåŠ¡å™¨Aæ›´æ–°æ•°æ®
    â†“
å‘é€æ¶ˆæ¯åˆ°MQï¼ˆå†…å®¹ï¼šæ¸…ç©ºuser:1çš„ç¼“å­˜ï¼‰
    â†“
æœåŠ¡å™¨Aã€Bã€Céƒ½è®¢é˜…è¯¥æ¶ˆæ¯
    â†“
å„è‡ªæ¸…ç©ºè‡ªå·±çš„ç¼“å­˜
    â†“
ä¸‹æ¬¡æŸ¥è¯¢æ—¶é‡æ–°åŠ è½½æ–°æ•°æ®
```

**ğŸ’» å®ç°ç¤ºä¾‹**ï¼š
```java
public class RedisCacheWithMQ implements Cache {
    private RedisTemplate redisTemplate;
    private RabbitTemplate rabbitTemplate;
    
    @Override
    public void putObject(Object key, Object value) {
        redisTemplate.opsForValue().set(key, value);
    }
    
    @Override
    public Object removeObject(Object key) {
        // åˆ é™¤Redisç¼“å­˜
        Object value = redisTemplate.opsForValue().get(key);
        redisTemplate.delete(key);
        
        // å‘é€æ¶ˆæ¯é€šçŸ¥å…¶ä»–èŠ‚ç‚¹
        rabbitTemplate.convertAndSend(
            "cache.exchange", 
            "cache.clear", 
            key
        );
        
        return value;
    }
    
    // ç›‘å¬æ¸…é™¤ç¼“å­˜çš„æ¶ˆæ¯
    @RabbitListener(queues = "cache.clear.queue")
    public void handleCacheClear(Object key) {
        redisTemplate.delete(key);
    }
}
```

**ğŸ“¡ ç­–ç•¥äºŒï¼šRediså‘å¸ƒè®¢é˜…**

```java
// ä½¿ç”¨Redisçš„pub/subåŠŸèƒ½
public void notifyCacheClear(Object key) {
    // å‘å¸ƒæ¸…é™¤ç¼“å­˜çš„æ¶ˆæ¯
    redisTemplate.convertAndSend("cache:clear", key);
}

// è®¢é˜…ç¼“å­˜æ¸…é™¤æ¶ˆæ¯
@RedisListener(topics = "cache:clear")
public void onCacheClear(Object key) {
    localCache.removeObject(key);  // æ¸…é™¤æœ¬åœ°ç¼“å­˜
}
```

### 6.3 ç¼“å­˜ä¸€è‡´æ€§ä¿éšœ


**ğŸ”’ å¼ºä¸€è‡´æ€§æ–¹æ¡ˆ**ï¼š
```
æ–¹æ¡ˆï¼šåˆ†å¸ƒå¼é” + åŒåˆ ç­–ç•¥

æµç¨‹ï¼š
1. è·å–åˆ†å¸ƒå¼é”
2. åˆ é™¤ç¼“å­˜
3. æ›´æ–°æ•°æ®åº“
4. å»¶è¿Ÿåå†åˆ é™¤ä¸€æ¬¡ç¼“å­˜
5. é‡Šæ”¾é”

ä¼˜ç‚¹ï¼šä¿è¯å¼ºä¸€è‡´æ€§
ç¼ºç‚¹ï¼šæ€§èƒ½å¼€é”€å¤§
```

**âš–ï¸ æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ**ï¼š
```
æ–¹æ¡ˆï¼šè®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´

æµç¨‹ï¼š
1. æ›´æ–°æ•°æ®åº“
2. åˆ é™¤ç¼“å­˜
3. è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆå¦‚5ç§’ï¼‰

ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œæ€§èƒ½å¥½
ç¼ºç‚¹ï¼šçŸ­æ—¶é—´å†…å¯èƒ½è¯»åˆ°æ—§æ•°æ®
```

**ğŸ’¡ é€‰æ‹©å»ºè®®**ï¼š
```
ä¸šåŠ¡åœºæ™¯é€‰æ‹©ï¼š
â€¢ é‡‘èäº¤æ˜“ â†’ å¼ºä¸€è‡´æ€§æ–¹æ¡ˆ
â€¢ ç”µå•†åº“å­˜ â†’ å¼ºä¸€è‡´æ€§æ–¹æ¡ˆ  
â€¢ ç”¨æˆ·ä¿¡æ¯ â†’ æœ€ç»ˆä¸€è‡´æ€§
â€¢ æ–‡ç« å†…å®¹ â†’ æœ€ç»ˆä¸€è‡´æ€§
```

---

## 7. ğŸš€ ç¼“å­˜ç­–ç•¥ä¸ä¼˜åŒ–


### 7.1 ç¼“å­˜é¢„çƒ­ç­–ç•¥


**ä»€ä¹ˆæ˜¯ç¼“å­˜é¢„çƒ­ï¼Ÿ**
å°±åƒå†¬å¤©æå‰æŠŠæš–æ°”æ‰“å¼€ï¼Œç­‰ä½ å›å®¶æ—¶å±‹é‡Œå·²ç»æš–å’Œäº†ã€‚ç¼“å­˜é¢„çƒ­å°±æ˜¯åº”ç”¨å¯åŠ¨æ—¶æå‰åŠ è½½çƒ­ç‚¹æ•°æ®ã€‚

**ğŸ”¥ é¢„çƒ­å®ç°æ–¹å¼**ï¼š

```java
@Component
public class CacheWarmUp {
    @Autowired
    private UserMapper userMapper;
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    // åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œ
    @PostConstruct
    public void warmUpCache() {
        // 1. åŠ è½½çƒ­é—¨ç”¨æˆ·æ•°æ®
        List<User> hotUsers = userMapper.selectHotUsers(100);
        for (User user : hotUsers) {
            String key = "user:info:" + user.getId();
            redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS);
        }
        
        // 2. åŠ è½½çƒ­é—¨å•†å“æ•°æ®
        List<Product> hotProducts = productMapper.selectHotProducts(200);
        for (Product product : hotProducts) {
            String key = "product:detail:" + product.getId();
            redisTemplate.opsForValue().set(key, product, 30, TimeUnit.MINUTES);
        }
        
        System.out.println("ç¼“å­˜é¢„çƒ­å®Œæˆï¼");
    }
}
```

**ğŸ“Š é¢„çƒ­ç­–ç•¥é€‰æ‹©**ï¼š
```
å…¨é‡é¢„çƒ­ï¼š
â€¢ é€‚åˆæ•°æ®é‡å°çš„åœºæ™¯
â€¢ åº”ç”¨å¯åŠ¨æ—¶é—´é•¿
â€¢ ç¼“å­˜å‘½ä¸­ç‡é«˜

å¢é‡é¢„çƒ­ï¼š
â€¢ åªåŠ è½½çƒ­ç‚¹æ•°æ®
â€¢ å¯åŠ¨å¿«
â€¢ éœ€è¦åˆ†æçƒ­ç‚¹æ•°æ®

å®šæ—¶é¢„çƒ­ï¼š
â€¢ å®šæ—¶åˆ·æ–°ç¼“å­˜
â€¢ ä¿æŒæ•°æ®æ–°é²œåº¦
â€¢ é€‚åˆæœ‰è§„å¾‹çš„ä¸šåŠ¡
```

### 7.2 ç¼“å­˜æ›´æ–°ç­–ç•¥


**ğŸ”„ å¸¸è§æ›´æ–°ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ | **æè¿°** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|------|---------|---------|---------|--------------|
| **Cache Aside** | `å…ˆæ›´æ–°DBï¼Œå†åˆ ç¼“å­˜` | `ç®€å•å¯é ` | `çŸ­æš‚ä¸ä¸€è‡´` | `å¤§éƒ¨åˆ†åœºæ™¯` |
| **Read Through** | `ç¼“å­˜ä»£ç†è¯»DB` | `ä¸šåŠ¡è§£è€¦` | `å®ç°å¤æ‚` | `è¯»å¤šå†™å°‘` |
| **Write Through** | `å…ˆå†™ç¼“å­˜ï¼ŒåŒæ­¥å†™DB` | `ä¸€è‡´æ€§å¥½` | `æ€§èƒ½å¼€é”€å¤§` | `å¼ºä¸€è‡´æ€§è¦æ±‚` |
| **Write Behind** | `å…ˆå†™ç¼“å­˜ï¼Œå¼‚æ­¥å†™DB` | `æ€§èƒ½æœ€å¥½` | `å¯èƒ½ä¸¢æ•°æ®` | `å…è®¸å»¶è¿Ÿå†™å…¥` |

**ğŸ’» Cache Asideæ¨¡å¼å®ç°**ï¼š
```java
// è¯»å–æ•°æ®
public User getUser(Long id) {
    // 1. å…ˆæŸ¥ç¼“å­˜
    String key = "user:" + id;
    User user = (User) redisTemplate.opsForValue().get(key);
    
    if (user != null) {
        return user;  // ç¼“å­˜å‘½ä¸­
    }
    
    // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
    user = userMapper.selectById(id);
    
    // 3. å†™å…¥ç¼“å­˜
    if (user != null) {
        redisTemplate.opsForValue().set(key, user, 30, TimeUnit.MINUTES);
    }
    
    return user;
}

// æ›´æ–°æ•°æ®
public void updateUser(User user) {
    // 1. å…ˆæ›´æ–°æ•°æ®åº“
    userMapper.updateById(user);
    
    // 2. åˆ é™¤ç¼“å­˜ï¼ˆè®©ä¸‹æ¬¡è¯»å–æ—¶é‡æ–°åŠ è½½ï¼‰
    String key = "user:" + user.getId();
    redisTemplate.delete(key);
}
```

### 7.3 ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©


**ğŸ•³ï¸ ç¼“å­˜ç©¿é€é—®é¢˜**ï¼š
```
ä»€ä¹ˆæ˜¯ç©¿é€ï¼Ÿ
æŸ¥è¯¢ä¸€ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜å’Œæ•°æ®åº“éƒ½æ²¡æœ‰ï¼Œæ¯æ¬¡éƒ½æ‰“åˆ°æ•°æ®åº“

ä¾‹å­ï¼š
æŸ¥è¯¢ç”¨æˆ·ID = -1ï¼ˆæ ¹æœ¬ä¸å­˜åœ¨ï¼‰
â†’ ç¼“å­˜æ²¡æœ‰
â†’ æŸ¥æ•°æ®åº“ï¼Œä¹Ÿæ²¡æœ‰
â†’ ä¸èƒ½ç¼“å­˜ï¼Œä¸‹æ¬¡è¿˜è¦æŸ¥æ•°æ®åº“
â†’ å¦‚æœæœ‰äººæ¶æ„æ”»å‡»ï¼Œç–¯ç‹‚æŸ¥ä¸å­˜åœ¨çš„ID
â†’ æ•°æ®åº“è¢«æ‰“å®ï¼
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// æ–¹æ¡ˆ1ï¼šç¼“å­˜ç©ºå¯¹è±¡
public User getUser(Long id) {
    String key = "user:" + id;
    User user = (User) redisTemplate.opsForValue().get(key);
    
    if (user != null) {
        return user;
    }
    
    // æŸ¥æ•°æ®åº“
    user = userMapper.selectById(id);
    
    if (user != null) {
        // å­˜åœ¨åˆ™ç¼“å­˜
        redisTemplate.opsForValue().set(key, user, 30, TimeUnit.MINUTES);
    } else {
        // ä¸å­˜åœ¨ä¹Ÿç¼“å­˜ï¼Œä½†æ—¶é—´çŸ­ä¸€ç‚¹
        redisTemplate.opsForValue().set(key, "", 5, TimeUnit.MINUTES);
    }
    
    return user;
}

// æ–¹æ¡ˆ2ï¼šå¸ƒéš†è¿‡æ»¤å™¨
// å¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰æœ‰æ•ˆIDåˆ°å¸ƒéš†è¿‡æ»¤å™¨
BloomFilter<Long> bloomFilter = BloomFilter.create(Funnels.longFunnel(), 1000000);

public User getUser(Long id) {
    // å…ˆç”¨å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­
    if (!bloomFilter.mightContain(id)) {
        return null;  // è‚¯å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
    }
    
    // å¯èƒ½å­˜åœ¨ï¼Œç»§ç»­æŸ¥è¯¢
    // ... åç»­é€»è¾‘
}
```

**âš¡ ç¼“å­˜å‡»ç©¿é—®é¢˜**ï¼š
```
ä»€ä¹ˆæ˜¯å‡»ç©¿ï¼Ÿ
ä¸€ä¸ªçƒ­ç‚¹æ•°æ®ï¼Œç¼“å­˜è¿‡æœŸçš„ç¬é—´ï¼Œå¤§é‡å¹¶å‘è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“

ä¾‹å­ï¼š
ç§’æ€å•†å“è¯¦æƒ…ï¼Œç¼“å­˜åˆšå¥½è¿‡æœŸ
â†’ 10000ä¸ªå¹¶å‘è¯·æ±‚
â†’ ç¼“å­˜éƒ½æ²¡æœ‰
â†’ 10000ä¸ªè¯·æ±‚åŒæ—¶æŸ¥æ•°æ®åº“
â†’ æ•°æ®åº“æ‰›ä¸ä½ï¼
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// æ–¹æ¡ˆï¼šåˆ†å¸ƒå¼é”ï¼Œåªè®©ä¸€ä¸ªè¯·æ±‚å»æŸ¥æ•°æ®åº“
public User getUser(Long id) {
    String key = "user:" + id;
    User user = (User) redisTemplate.opsForValue().get(key);
    
    if (user != null) {
        return user;
    }
    
    // ä½¿ç”¨åˆ†å¸ƒå¼é”
    String lockKey = "lock:user:" + id;
    Boolean locked = redisTemplate.opsForValue()
        .setIfAbsent(lockKey, "1", 10, TimeUnit.SECONDS);
    
    if (locked) {
        try {
            // è·å¾—é”ï¼ŒæŸ¥æ•°æ®åº“
            user = userMapper.selectById(id);
            if (user != null) {
                redisTemplate.opsForValue().set(key, user, 30, TimeUnit.MINUTES);
            }
        } finally {
            // é‡Šæ”¾é”
            redisTemplate.delete(lockKey);
        }
    } else {
        // æ²¡è·å¾—é”ï¼Œç­‰ä¸€ä¼šå†æŸ¥ç¼“å­˜
        Thread.sleep(100);
        return getUser(id);  // é€’å½’è°ƒç”¨
    }
    
    return user;
}
```

**â„ï¸ ç¼“å­˜é›ªå´©é—®é¢˜**ï¼š
```
ä»€ä¹ˆæ˜¯é›ªå´©ï¼Ÿ
å¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œæ‰€æœ‰è¯·æ±‚éƒ½æ‰“åˆ°æ•°æ®åº“

ä¾‹å­ï¼š
å‡Œæ™¨3ç‚¹ï¼Œå¤§é‡ç¼“å­˜è®¾ç½®çš„è¿‡æœŸæ—¶é—´éƒ½æ˜¯1å°æ—¶
â†’ 3ç‚¹æ•´ï¼Œç¼“å­˜é›†ä½“è¿‡æœŸ
â†’ æ‰€æœ‰è¯·æ±‚åŒæ—¶æŸ¥æ•°æ®åº“
â†’ æ•°æ®åº“å´©æºƒï¼
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// æ–¹æ¡ˆ1ï¼šéšæœºè¿‡æœŸæ—¶é—´
int randomExpire = 30 + new Random().nextInt(10);  // 30-40åˆ†é’Ÿéšæœº
redisTemplate.opsForValue().set(key, value, randomExpire, TimeUnit.MINUTES);

// æ–¹æ¡ˆ2ï¼šæ°¸ä¸è¿‡æœŸï¼ˆåå°å¼‚æ­¥æ›´æ–°ï¼‰
@Scheduled(fixedRate = 1800000)  // æ¯30åˆ†é’Ÿæ‰§è¡Œ
public void refreshCache() {
    // å¼‚æ­¥åˆ·æ–°çƒ­ç‚¹ç¼“å­˜
    List<User> hotUsers = userMapper.selectHotUsers(100);
    for (User user : hotUsers) {
        String key = "user:" + user.getId();
        redisTemplate.opsForValue().set(key, user, 1, TimeUnit.HOURS);
    }
}

// æ–¹æ¡ˆ3ï¼šå¤šçº§ç¼“å­˜
// å³ä½¿RedisæŒ‚äº†ï¼Œæœ¬åœ°ç¼“å­˜è¿˜èƒ½æ’‘ä¸€ä¼š
```

---

## 8. ğŸ“Š ç¼“å­˜ç›‘æ§ä¸è°ƒä¼˜


### 8.1 ç¼“å­˜ç›‘æ§æŒ‡æ ‡


**ğŸ“ˆ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**ï¼š

```
ğŸ¯ å‘½ä¸­ç‡æŒ‡æ ‡ï¼š
â€¢ å‘½ä¸­ç‡ = ç¼“å­˜å‘½ä¸­æ¬¡æ•° / æ€»è¯·æ±‚æ¬¡æ•°
â€¢ è‰¯å¥½æ ‡å‡†ï¼š> 80%
â€¢ ä¼˜ç§€æ ‡å‡†ï¼š> 95%

â±ï¸ æ€§èƒ½æŒ‡æ ‡ï¼š
â€¢ å¹³å‡å“åº”æ—¶é—´
â€¢ P99å“åº”æ—¶é—´ï¼ˆ99%çš„è¯·æ±‚å“åº”æ—¶é—´ï¼‰
â€¢ QPSï¼ˆæ¯ç§’æŸ¥è¯¢æ•°ï¼‰

ğŸ’¾ å®¹é‡æŒ‡æ ‡ï¼š
â€¢ ç¼“å­˜ä½¿ç”¨é‡
â€¢ ç¼“å­˜æ¡ç›®æ•°
â€¢ å†…å­˜å ç”¨ç‡
```

**ğŸ’» å®ç°ç›‘æ§ç»Ÿè®¡**ï¼š
```java
public class MonitoredCache implements Cache {
    private final Cache delegate;
    private AtomicLong hitCount = new AtomicLong(0);
    private AtomicLong missCount = new AtomicLong(0);
    
    @Override
    public Object getObject(Object key) {
        Object value = delegate.getObject(key);
        
        if (value != null) {
            hitCount.incrementAndGet();  // å‘½ä¸­+1
        } else {
            missCount.incrementAndGet();  // æœªå‘½ä¸­+1
        }
        
        return value;
    }
    
    // è·å–å‘½ä¸­ç‡
    public double getHitRate() {
        long total = hitCount.get() + missCount.get();
        return total == 0 ? 0 : (double) hitCount.get() / total;
    }
    
    // å®šæ—¶è¾“å‡ºç»Ÿè®¡
    @Scheduled(fixedRate = 60000)  // æ¯åˆ†é’Ÿ
    public void printStats() {
        System.out.printf("ç¼“å­˜ç»Ÿè®¡ - å‘½ä¸­:%d æœªå‘½ä¸­:%d å‘½ä¸­ç‡:%.2f%%\n",
            hitCount.get(), missCount.get(), getHitRate() * 100);
    }
}
```

### 8.2 æ€§èƒ½è°ƒä¼˜ç­–ç•¥


**âš¡ è°ƒä¼˜æ£€æŸ¥æ¸…å•**ï¼š

```
âœ… åºåˆ—åŒ–ä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨é«˜æ•ˆåºåˆ—åŒ–ï¼ˆJSONã€Protobufï¼‰
â€¢ é¿å…å¤§å¯¹è±¡ç¼“å­˜
â€¢ å‹ç¼©å¤§æ•°æ®

âœ… ç½‘ç»œä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨è¿æ¥æ± 
â€¢ æ‰¹é‡æ“ä½œ
â€¢ Pipelineç®¡é“åŒ–

âœ… è¿‡æœŸç­–ç•¥ï¼š
â€¢ åˆç†è®¾ç½®TTL
â€¢ éšæœºè¿‡æœŸæ—¶é—´
â€¢ æƒ°æ€§åˆ é™¤

âœ… å®¹é‡æ§åˆ¶ï¼š
â€¢ è®¾ç½®æœ€å¤§å®¹é‡
â€¢ æ·˜æ±°ç­–ç•¥é€‰æ‹©
â€¢ å®šæœŸæ¸…ç†
```

**ğŸ”§ å®æˆ˜è°ƒä¼˜ç¤ºä¾‹**ï¼š
```java
// æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¼€é”€
public Map<Long, User> batchGetUsers(List<Long> ids) {
    // æ‰¹é‡æŸ¥è¯¢Redis
    List<String> keys = ids.stream()
        .map(id -> "user:" + id)
        .collect(Collectors.toList());
    
    List<Object> values = redisTemplate.opsForValue().multiGet(keys);
    
    // æ„å»ºç»“æœMap
    Map<Long, User> result = new HashMap<>();
    for (int i = 0; i < ids.size(); i++) {
        if (values.get(i) != null) {
            result.put(ids.get(i), (User) values.get(i));
        }
    }
    
    return result;
}
```

### 8.3 é—®é¢˜æ’æŸ¥æ–¹æ³•


**ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­**ï¼š

```
é—®é¢˜1ï¼šç¼“å­˜å‘½ä¸­ç‡ä½
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥ç¼“å­˜è¿‡æœŸæ—¶é—´æ˜¯å¦å¤ªçŸ­
2. æŸ¥çœ‹æ˜¯å¦é¢‘ç¹æ›´æ–°å¯¼è‡´ç¼“å­˜å¤±æ•ˆ
3. åˆ†æä¸šåŠ¡æ˜¯å¦æœ‰å¤§é‡æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®
4. æ£€æŸ¥ç¼“å­˜å®¹é‡æ˜¯å¦è¶³å¤Ÿ

é—®é¢˜2ï¼šå“åº”æ—¶é—´é•¿
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥æ˜¯å¦æœ‰å¤§å¯¹è±¡ç¼“å­˜
2. æŸ¥çœ‹ç½‘ç»œå»¶è¿Ÿ
3. åˆ†æåºåˆ—åŒ–è€—æ—¶
4. æ£€æŸ¥æ˜¯å¦æœ‰é”ç«äº‰

é—®é¢˜3ï¼šå†…å­˜å ç”¨é«˜
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥ç¼“å­˜å®¹é‡é…ç½®
2. æŸ¥çœ‹æ˜¯å¦æœ‰å†…å­˜æ³„æ¼
3. åˆ†æç¼“å­˜æ•°æ®å¤§å°
4. æ£€æŸ¥æ·˜æ±°ç­–ç•¥æ˜¯å¦ç”Ÿæ•ˆ
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ è‡ªå®šä¹‰ç¼“å­˜æœ¬è´¨ï¼šå®ç°Cacheæ¥å£ï¼Œæ›¿æ¢MyBatisé»˜è®¤ç¼“å­˜
ğŸ”¸ è£…é¥°å™¨æ¨¡å¼ï¼šä¸€å±‚å¥—ä¸€å±‚ï¼Œé€æ­¥å¢åŠ åŠŸèƒ½
ğŸ”¸ Redisé›†æˆï¼šåˆ†å¸ƒå¼ç¯å¢ƒçš„æ ‡é…ç¼“å­˜æ–¹æ¡ˆ
ğŸ”¸ å¤šçº§ç¼“å­˜ï¼šæœ¬åœ°ç¼“å­˜+Redisï¼Œæ€§èƒ½ä¸ä¸€è‡´æ€§å…¼é¡¾
ğŸ”¸ ç¼“å­˜ç­–ç•¥ï¼šé¢„çƒ­ã€æ›´æ–°ã€æ·˜æ±°ï¼Œä¸‰å¤§æ ¸å¿ƒç­–ç•¥
ğŸ”¸ ä¸‰å¤§é—®é¢˜ï¼šç©¿é€ã€å‡»ç©¿ã€é›ªå´©ï¼Œå¿…é¡»é˜²èŒƒ
ğŸ”¸ ç›‘æ§è°ƒä¼˜ï¼šå‘½ä¸­ç‡ã€å“åº”æ—¶é—´ã€å®¹é‡ï¼ŒæŒç»­ä¼˜åŒ–
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰ç¼“å­˜**ï¼š
```
æ ¹æœ¬åŸå› ï¼š
â€¢ é»˜è®¤ç¼“å­˜åŠŸèƒ½æœ‰é™
â€¢ åˆ†å¸ƒå¼ç¯å¢ƒéœ€è¦å…±äº«ç¼“å­˜
â€¢ ä¸šåŠ¡éœ€è¦æ›´çµæ´»çš„ç¼“å­˜ç­–ç•¥

è§£å†³æ€è·¯ï¼š
â€¢ å®ç°Cacheæ¥å£
â€¢ é›†æˆä¸“ä¸šç¼“å­˜æ¡†æ¶
â€¢ æ ¹æ®ä¸šåŠ¡å®šåˆ¶åŠŸèƒ½
```

**ğŸ”¹ å¦‚ä½•é€‰æ‹©ç¼“å­˜æ–¹æ¡ˆ**ï¼š
```
é€‰æ‹©å› ç´ ï¼š
â€¢ å•æœº vs åˆ†å¸ƒå¼
â€¢ æ€§èƒ½ vs ä¸€è‡´æ€§
â€¢ ç®€å• vs å¤æ‚
â€¢ æˆæœ¬ vs æ”¶ç›Š

å¸¸è§é€‰æ‹©ï¼š
â€¢ å°å‹å•æœº â†’ PerpetualCache
â€¢ é«˜æ€§èƒ½æœ¬åœ° â†’ Caffeine
â€¢ åˆ†å¸ƒå¼ç³»ç»Ÿ â†’ Redis
â€¢ æè‡´æ€§èƒ½ â†’ Caffeine + Redis
```

**ğŸ”¹ ç¼“å­˜ä¸€è‡´æ€§å¦‚ä½•ä¿éšœ**ï¼š
```
ç†è§£è¦ç‚¹ï¼š
â€¢ å®Œç¾ä¸€è‡´æ€§å¾ˆéš¾å®ç°
â€¢ å¤§å¤šæ•°åœºæ™¯æ¥å—æœ€ç»ˆä¸€è‡´
â€¢ æ ¹æ®ä¸šåŠ¡é€‰æ‹©ä¸€è‡´æ€§çº§åˆ«

å®ç°æ–¹å¼ï¼š
â€¢ æ›´æ–°DBååˆ é™¤ç¼“å­˜
â€¢ è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
â€¢ ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—åŒæ­¥
â€¢ å¿…è¦æ—¶ä½¿ç”¨åˆ†å¸ƒå¼é”
```

### 9.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ’¼ ä¼ä¸šçº§å®è·µ**ï¼š
```
åŸºç¡€é…ç½®ï¼š
â€¢ ä½¿ç”¨Redisä½œä¸ºäºŒçº§ç¼“å­˜
â€¢ è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆ5-30åˆ†é’Ÿï¼‰
â€¢ é…ç½®ç¼“å­˜å®¹é‡é™åˆ¶
â€¢ å¯ç”¨ç¼“å­˜ç›‘æ§

ä¼˜åŒ–ç­–ç•¥ï¼š
â€¢ çƒ­ç‚¹æ•°æ®é¢„çƒ­
â€¢ å†·æ•°æ®è‡ªåŠ¨æ·˜æ±°
â€¢ å¤šçº§ç¼“å­˜æ¶æ„
â€¢ å®šæœŸæ¸…ç†å’Œç»´æŠ¤

å®‰å…¨ä¿éšœï¼š
â€¢ é˜²æ­¢ç¼“å­˜ç©¿é€ï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰
â€¢ é˜²æ­¢ç¼“å­˜å‡»ç©¿ï¼ˆåˆ†å¸ƒå¼é”ï¼‰
â€¢ é˜²æ­¢ç¼“å­˜é›ªå´©ï¼ˆéšæœºè¿‡æœŸï¼‰
```

**ğŸ¯ å­¦ä¹ è·¯å¾„å»ºè®®**ï¼š
```
ç¬¬ä¸€é˜¶æ®µï¼šç†è§£åŸç†
â€¢ MyBatisç¼“å­˜æœºåˆ¶
â€¢ Cacheæ¥å£è®¾è®¡
â€¢ è£…é¥°å™¨æ¨¡å¼

ç¬¬äºŒé˜¶æ®µï¼šå®è·µé›†æˆ
â€¢ Redisç¼“å­˜é›†æˆ
â€¢ å¤šçº§ç¼“å­˜å®ç°
â€¢ ç¼“å­˜ç­–ç•¥é…ç½®

ç¬¬ä¸‰é˜¶æ®µï¼šæ·±å…¥ä¼˜åŒ–
â€¢ æ€§èƒ½ç›‘æ§åˆ†æ
â€¢ é—®é¢˜æ’æŸ¥è§£å†³
â€¢ é«˜çº§ç‰¹æ€§åº”ç”¨
```

### 9.4 å¸¸è§é—®é¢˜è§£ç­”


**â“ ä»€ä¹ˆæ—¶å€™éœ€è¦è‡ªå®šä¹‰ç¼“å­˜ï¼Ÿ**
```
éœ€è¦çš„åœºæ™¯ï¼š
â€¢ åˆ†å¸ƒå¼ç¯å¢ƒï¼Œéœ€è¦å¤šèŠ‚ç‚¹å…±äº«ç¼“å­˜
â€¢ å¯¹ç¼“å­˜æ€§èƒ½æœ‰æé«˜è¦æ±‚
â€¢ éœ€è¦å¤æ‚çš„ç¼“å­˜ç­–ç•¥
â€¢ ç¼“å­˜æ•°æ®éœ€è¦æŒä¹…åŒ–

ä¸éœ€è¦çš„åœºæ™¯ï¼š
â€¢ å°å‹å•æœºåº”ç”¨
â€¢ æ•°æ®å®æ—¶æ€§è¦æ±‚æé«˜
â€¢ ç¼“å­˜æ”¶ç›Šä¸æ˜æ˜¾
```

**â“ Redisç¼“å­˜å’Œæœ¬åœ°ç¼“å­˜å¦‚ä½•é€‰æ‹©ï¼Ÿ**
```
Redisç¼“å­˜ï¼š
âœ… åˆ†å¸ƒå¼å…±äº«
âœ… æ•°æ®æŒä¹…åŒ–
âœ… åŠŸèƒ½ä¸°å¯Œ
âŒ ç½‘ç»œå¼€é”€

æœ¬åœ°ç¼“å­˜ï¼š
âœ… é€Ÿåº¦æå¿«
âœ… æ— ç½‘ç»œå¼€é”€
âŒ æ— æ³•å…±äº«
âŒ å†…å­˜æœ‰é™

å»ºè®®ï¼šä¸¤è€…ç»“åˆï¼Œæ„å»ºå¤šçº§ç¼“å­˜
```

**â“ å¦‚ä½•ä¿è¯ç¼“å­˜æ•°æ®çš„æ­£ç¡®æ€§ï¼Ÿ**
```
æ ¸å¿ƒåŸåˆ™ï¼š
â€¢ ä»¥æ•°æ®åº“ä¸ºå‡†
â€¢ ç¼“å­˜å‡ºé”™å¯ä»¥é‡å»º
â€¢ è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´

å®ç°æ–¹å¼ï¼š
â€¢ æ›´æ–°æ•°æ®åº“ååˆ é™¤ç¼“å­˜
â€¢ ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶
â€¢ å®šæœŸåˆ·æ–°ç¼“å­˜
â€¢ ç›‘æ§ç¼“å­˜çŠ¶æ€
```

**ğŸ§  è®°å¿†å£è¯€**ï¼š
- Cacheæ¥å£äº”æ–¹æ³•ï¼Œå­˜å–åˆ æ¸…æŸ¥å¤§å°
- è£…é¥°å™¨æ¨¡å¼å±‚å±‚å¥—ï¼ŒåŠŸèƒ½æ‰©å±•å¾ˆçµæ´»
- Redisç¼“å­˜åˆ†å¸ƒå¼ï¼Œå¤šçº§ç¼“å­˜æ€§èƒ½é«˜
- ç©¿é€å‡»ç©¿åŠ é›ªå´©ï¼Œä¸‰å¤§é—®é¢˜è¦é˜²èŒƒ
- ç›‘æ§ç»Ÿè®¡ä¸èƒ½å°‘ï¼ŒæŒç»­ä¼˜åŒ–æ˜¯ç‹é“

**æœ€åçš„è¯**ï¼šç¼“å­˜æ˜¯æŠŠåŒåˆƒå‰‘ï¼Œç”¨å¥½äº†æ€§èƒ½é£™å‡ï¼Œç”¨ä¸å¥½åè€Œæ·»ä¹±ã€‚ç†è§£åŸç†ã€é€‰å¯¹æ–¹æ¡ˆã€æŒç»­ä¼˜åŒ–ï¼Œæ‰èƒ½çœŸæ­£å‘æŒ¥ç¼“å­˜çš„ä»·å€¼ï¼