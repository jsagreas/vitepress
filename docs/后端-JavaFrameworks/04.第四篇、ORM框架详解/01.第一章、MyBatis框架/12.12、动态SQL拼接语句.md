---
title: 12、动态SQL拼接语句
---
## 📚 目录

1. [SQL拼接问题的本质](#1-SQL拼接问题的本质)
2. [where条件拼接](#2-where条件拼接)
3. [set更新拼接](#3-set更新拼接)
4. [trim自定义拼接](#4-trim自定义拼接)
5. [拼接安全与性能](#5-拼接安全与性能)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🤔 SQL拼接问题的本质


### 1.1 为什么需要SQL拼接


**现实场景**：假设你在开发一个商品搜索功能

```
用户可能的搜索条件：
• 只输入商品名称
• 只选择价格区间
• 同时输入名称和价格
• 什么都不输入（查全部）

传统做法的困境：
需要写4个不同的SQL？太麻烦了！
```

**问题的核心**：
- 查询条件是**动态的**，用户可能只填写部分条件
- 我们需要根据**实际情况**灵活拼接SQL语句
- 但手动拼接容易出现**语法错误**

**常见的拼接陷阱**：

```sql
-- 错误示例1：多余的AND
SELECT * FROM product WHERE AND price < 100

-- 错误示例2：多余的逗号  
UPDATE product SET name = ?, price = ?, WHERE id = ?

-- 错误示例3：缺少WHERE
SELECT * FROM product price < 100
```

### 1.2 MyBatis的解决方案


**核心思路**：用智能标签自动处理SQL语法

```
传统方式：你自己拼字符串 → 容易出错
MyBatis方式：框架帮你拼接 → 自动处理语法
```

**MyBatis提供的拼接武器**：

| 标签 | 作用 | 使用场景 |
|------|------|---------|
| `<where>` | 智能处理WHERE条件 | 动态查询条件 |
| `<set>` | 智能处理SET更新 | 动态更新字段 |
| `<trim>` | 自定义拼接规则 | 复杂SQL拼接 |

---

## 2. 🔍 where条件拼接


### 2.1 where标签的作用


**`<where>`标签做了什么**：
1. 自动添加`WHERE`关键字（当有条件时）
2. 自动去掉第一个多余的`AND`或`OR`
3. 没有条件时不添加`WHERE`

**对比理解**：

```
不用<where>标签：
WHERE AND name LIKE ? AND price < ?  ❌ 语法错误

用了<where>标签：  
WHERE name LIKE ? AND price < ?  ✅ 自动去掉多余AND
```

### 2.2 基础用法示例


```xml
<!-- 商品搜索功能 -->
<select id="searchProduct" resultType="Product">
    SELECT * FROM product
    <where>
        <!-- 如果用户输入了商品名 -->
        <if test="name != null and name != ''">
            AND name LIKE CONCAT('%', #{name}, '%')
        </if>
        
        <!-- 如果用户选择了最低价格 -->
        <if test="minPrice != null">
            AND price >= #{minPrice}
        </if>
        
        <!-- 如果用户选择了最高价格 -->
        <if test="maxPrice != null">
            AND price &lt;= #{maxPrice}
        </if>
    </where>
    ORDER BY create_time DESC
</select>
```

**执行效果分析**：

```
场景1：用户只输入name = "手机"
生成SQL：
SELECT * FROM product 
WHERE name LIKE '%手机%'  
ORDER BY create_time DESC

场景2：用户只选择minPrice = 1000
生成SQL：
SELECT * FROM product 
WHERE price >= 1000
ORDER BY create_time DESC

场景3：用户什么都不输入
生成SQL：
SELECT * FROM product
ORDER BY create_time DESC
-- 注意：没有WHERE关键字
```

### 2.3 where标签的工作原理


**智能处理流程**：

```
步骤1：收集所有<if>标签生成的SQL片段
       片段1：AND name LIKE ?
       片段2：AND price >= ?
       
步骤2：检查是否有内容
       有内容 → 添加WHERE关键字
       无内容 → 不添加WHERE
       
步骤3：去掉第一个AND或OR
       WHERE AND name LIKE ? 
       变成：WHERE name LIKE ?
```

**💡 记忆要点**：
- `<where>`像个智能助手，帮你处理WHERE后面的条件
- 它只去掉**第一个**多余的AND/OR
- 空条件时会自动消失，不留痕迹

---

## 3. ✏️ set更新拼接


### 3.1 set标签的作用


**`<set>`标签做了什么**：
1. 自动添加`SET`关键字
2. 自动去掉最后一个多余的逗号
3. 至少要有一个更新字段

**对比理解**：

```
不用<set>标签：
UPDATE product SET name = ?, price = ?,  WHERE id = ?  
❌ 多余的逗号

用了<set>标签：
UPDATE product SET name = ?, price = ? WHERE id = ?  
✅ 自动去掉逗号
```

### 3.2 基础用法示例


```xml
<!-- 更新商品信息 -->
<update id="updateProduct">
    UPDATE product
    <set>
        <!-- 如果要更新商品名 -->
        <if test="name != null and name != ''">
            name = #{name},
        </if>
        
        <!-- 如果要更新价格 -->
        <if test="price != null">
            price = #{price},
        </if>
        
        <!-- 如果要更新库存 -->
        <if test="stock != null">
            stock = #{stock},
        </if>
        
        <!-- 更新时间总是更新 -->
        update_time = NOW()
    </set>
    WHERE id = #{id}
</update>
```

**执行效果分析**：

```
场景1：只更新商品名
传入参数：{id: 1, name: "新手机"}
生成SQL：
UPDATE product 
SET name = '新手机', update_time = NOW()
WHERE id = 1

场景2：同时更新价格和库存
传入参数：{id: 1, price: 2999, stock: 100}
生成SQL：
UPDATE product 
SET price = 2999, stock = 100, update_time = NOW()
WHERE id = 1
```

### 3.3 set标签的工作原理


**智能处理流程**：

```
步骤1：收集所有<if>标签生成的SQL片段
       片段1：name = ?,
       片段2：price = ?,
       片段3：update_time = NOW()
       
步骤2：添加SET关键字
       SET name = ?, price = ?, update_time = NOW()
       
步骤3：去掉最后的逗号（如果有）
       原本：SET name = ?, price = ?,
       处理后：SET name = ?, price = ?
```

**⚠️ 注意事项**：

```
常见错误：所有字段都不更新
<set>
    <if test="name != null">name = #{name},</if>
    <if test="price != null">price = #{price},</if>
</set>

如果name和price都是null：
UPDATE product SET WHERE id = ?  ❌ 语法错误

解决方案：保证至少有一个字段
<set>
    <if test="name != null">name = #{name},</if>
    <if test="price != null">price = #{price},</if>
    update_time = NOW()  ← 保底字段
</set>
```

---

## 4. 🔧 trim自定义拼接


### 4.1 trim标签是什么


**通俗理解**：
- `<where>`和`<set>`是MyBatis预设的拼接规则
- `<trim>`是自定义拼接规则的"万能工具"
- 你可以用它实现任何拼接逻辑

**核心参数**：

| 参数 | 含义 | 作用 |
|------|------|------|
| `prefix` | 前缀 | 在SQL片段前面加什么 |
| `suffix` | 后缀 | 在SQL片段后面加什么 |
| `prefixOverrides` | 前缀覆盖 | 去掉开头的什么内容 |
| `suffixOverrides` | 后缀覆盖 | 去掉结尾的什么内容 |

### 4.2 用trim实现where功能


**where标签的本质**：

```xml
<!-- where标签实际上是这样工作的 -->
<trim prefix="WHERE" prefixOverrides="AND |OR ">
    <!-- 条件内容 -->
</trim>
```

**参数解释**：
- `prefix="WHERE"` → 前面加WHERE关键字
- `prefixOverrides="AND |OR "` → 去掉开头的AND或OR

**完整示例**：

```xml
<select id="searchProduct" resultType="Product">
    SELECT * FROM product
    <trim prefix="WHERE" prefixOverrides="AND |OR ">
        <if test="name != null">
            AND name LIKE #{name}
        </if>
        <if test="price != null">
            AND price >= #{price}
        </if>
    </trim>
</select>
```

**执行过程**：

```
步骤1：收集内容
       AND name LIKE ? AND price >= ?
       
步骤2：去掉开头的"AND "
       name LIKE ? AND price >= ?
       
步骤3：添加前缀"WHERE"
       WHERE name LIKE ? AND price >= ?
```

### 4.3 用trim实现set功能


**set标签的本质**：

```xml
<!-- set标签实际上是这样工作的 -->
<trim prefix="SET" suffixOverrides=",">
    <!-- 更新字段 -->
</trim>
```

**参数解释**：
- `prefix="SET"` → 前面加SET关键字
- `suffixOverrides=","` → 去掉结尾的逗号

**完整示例**：

```xml
<update id="updateProduct">
    UPDATE product
    <trim prefix="SET" suffixOverrides=",">
        <if test="name != null">
            name = #{name},
        </if>
        <if test="price != null">
            price = #{price},
        </if>
        update_time = NOW()
    </trim>
    WHERE id = #{id}
</update>
```

### 4.4 trim的高级应用


**场景：批量插入时动态选择字段**

```xml
<insert id="batchInsert">
    INSERT INTO product
    <trim prefix="(" suffix=")" suffixOverrides=",">
        id,
        <if test="name != null">name,</if>
        <if test="price != null">price,</if>
        create_time
    </trim>
    VALUES
    <foreach collection="list" item="item" separator=",">
        <trim prefix="(" suffix=")" suffixOverrides=",">
            #{item.id},
            <if test="item.name != null">#{item.name},</if>
            <if test="item.price != null">#{item.price},</if>
            NOW()
        </trim>
    </foreach>
</insert>
```

**生成SQL示例**：

```sql
-- 当name和price都存在时：
INSERT INTO product (id, name, price, create_time)
VALUES (1, '手机', 2999, NOW()),
       (2, '电脑', 4999, NOW())

-- 当只有price存在时：
INSERT INTO product (id, price, create_time)
VALUES (1, 2999, NOW()),
       (2, 4999, NOW())
```

### 4.5 prefix和suffix的组合使用


**前后缀同时使用**：

```xml
<!-- 动态拼接IN条件 -->
<select id="findByIds" resultType="Product">
    SELECT * FROM product
    WHERE id IN
    <trim prefix="(" suffix=")" suffixOverrides=",">
        <foreach collection="ids" item="id">
            #{id},
        </foreach>
    </trim>
</select>
```

**执行效果**：

```
传入ids = [1, 2, 3]

生成SQL：
SELECT * FROM product
WHERE id IN (1, 2, 3)

trim的处理过程：
1. foreach生成：1, 2, 3,
2. 去掉结尾逗号：1, 2, 3
3. 添加前缀"("：(1, 2, 3
4. 添加后缀")"：(1, 2, 3)
```

### 4.6 prefixOverrides和suffixOverrides的细节


**覆盖规则详解**：

```xml
<!-- 可以指定多个覆盖内容，用|分隔 -->
<trim prefixOverrides="AND |OR |WHERE ">
    <!-- 可以去掉AND、OR、WHERE任意一个 -->
</trim>

<trim suffixOverrides=", |; |) ">
    <!-- 可以去掉逗号、分号、右括号任意一个 -->
</trim>
```

**⚠️ 注意空格**：

```xml
<!-- 正确：AND后面有空格 -->
prefixOverrides="AND |OR "  ✅

<!-- 错误：没有空格 -->
prefixOverrides="AND|OR"  ❌
<!-- 这样只能匹配"AND"，匹配不了"AND " -->
```

---

## 5. 🛡️ 拼接安全与性能


### 5.1 SQL注入风险


**什么是SQL注入**：

```
假设用户输入：name = "' OR '1'='1"

不安全的拼接：
SELECT * FROM product 
WHERE name = '' OR '1'='1'
-- 永远返回true，查出所有数据！
```

**MyBatis的防护机制**：

```xml
<!-- 安全方式：使用#{}预编译 -->
<select id="findByName">
    SELECT * FROM product
    WHERE name = #{name}
</select>

<!-- 生成的SQL -->
SELECT * FROM product 
WHERE name = ?  ← 预编译占位符
-- 框架会自动转义特殊字符
```

**${}的危险性**：

```xml
<!-- 危险方式：使用${}直接拼接 -->
<select id="findByName">
    SELECT * FROM product
    WHERE name = '${name}'
</select>

<!-- 如果name = "' OR '1'='1" -->
SELECT * FROM product 
WHERE name = '' OR '1'='1'  ❌ SQL注入
```

**💡 安全原则**：
- ✅ **优先使用`#{}`**：安全的预编译方式
- ❌ **避免使用`${}`**：仅用于表名、列名等不能预编译的场景
- ✅ **做参数校验**：在Java代码中验证输入

### 5.2 性能优化建议


**优化1：减少不必要的条件判断**

```xml
<!-- 不推荐：条件太复杂 -->
<where>
    <if test="name != null and name != '' and name.length() > 0">
        AND name = #{name}
    </if>
</where>

<!-- 推荐：简化条件 -->
<where>
    <if test="name != null and name != ''">
        AND name = #{name}
    </if>
</where>
```

**优化2：合理使用索引**

```xml
<!-- 注意：LIKE '%keyword%' 不会使用索引 -->
<where>
    <if test="name != null">
        AND name LIKE CONCAT('%', #{name}, '%')  ❌ 慢
    </if>
</where>

<!-- 如果可以，用前缀匹配 -->
<where>
    <if test="name != null">
        AND name LIKE CONCAT(#{name}, '%')  ✅ 快
    </if>
</where>
```

**优化3：避免过多的动态SQL**

```xml
<!-- 不推荐：每个字段都动态 -->
<select id="search">
    SELECT 
    <if test="needId">id,</if>
    <if test="needName">name,</if>
    <if test="needPrice">price,</if>
    FROM product
</select>

<!-- 推荐：固定常用字段 -->
<select id="search">
    SELECT id, name, price
    FROM product
</select>
```

### 5.3 拼接语法检查清单


**常见语法问题**：

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| `WHERE AND` | 第一个条件前有AND | 使用`<where>`标签 |
| `SET ,` | 最后字段后有逗号 | 使用`<set>`标签 |
| `IN ()` | IN后面空括号 | 判断集合非空 |
| `ORDER BY #{field}` | 排序字段用了#{} | 改用${}并校验 |

**检查清单**：

```
✅ 所有<if>标签都有test属性
✅ AND/OR的位置正确
✅ 逗号的位置正确
✅ 括号成对出现
✅ 字符串条件加引号
✅ 数值条件不加引号
✅ 使用#{}防止注入
```

---

## 6. 📋 核心要点总结


### 6.1 三大拼接标签对比


```
🔸 <where>标签
作用：智能处理WHERE条件
核心能力：自动加WHERE，去掉第一个AND/OR
使用场景：动态查询条件

🔸 <set>标签
作用：智能处理SET更新
核心能力：自动加SET，去掉最后的逗号
使用场景：动态更新字段

🔸 <trim>标签
作用：自定义拼接规则
核心能力：灵活控制前后缀和覆盖
使用场景：复杂SQL拼接
```

### 6.2 参数详解速记


**trim的四个参数**：

```
prefix：往前加什么
       WHERE、SET、(、VALUES

suffix：往后加什么  
       )、;

prefixOverrides：去掉开头的什么
       AND |OR |WHERE 

suffixOverrides：去掉结尾的什么
       , |; |)
```

### 6.3 安全使用原则


```
✅ 优先使用<where>和<set>，够用就不用<trim>
✅ 条件值用#{}预编译，表名列名才用${}
✅ 保证至少有一个更新字段（SET）或一个查询条件（WHERE可选）
✅ 复杂拼接前先在数据库测试SQL语法
✅ 记得处理空集合、null值等边界情况
```

### 6.4 实战技巧


**记忆口诀**：
```
WHERE条件动态拼，<where>标签帮你干
SET更新去逗号，<set>标签少不了  
复杂拼接用<trim>，前后覆盖全搞定
井号防注入安全，美元符号要谨慎
```

**调试建议**：
1. 开启MyBatis的SQL日志：`mybatis.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl`
2. 查看实际生成的SQL语句
3. 在数据库中直接测试SQL是否正确
4. 测试各种参数组合的边界情况

**最佳实践**：
- 简单场景用`<where>`和`<set>`
- 复杂场景才用`<trim>`
- 所有动态SQL都要考虑"空值情况"
- 定期review SQL日志，优化慢查询