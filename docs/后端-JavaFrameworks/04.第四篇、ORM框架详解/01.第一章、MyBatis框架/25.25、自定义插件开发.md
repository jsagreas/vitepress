---
title: 25ã€è‡ªå®šä¹‰æ’ä»¶å¼€å‘
---
## ğŸ“š ç›®å½•

1. [æ’ä»¶å¼€å‘åŸºç¡€æ¦‚å¿µ](#1-æ’ä»¶å¼€å‘åŸºç¡€æ¦‚å¿µ)
2. [æ ¸å¿ƒæ¥å£ä¸æ–¹æ³•è¯¦è§£](#2-æ ¸å¿ƒæ¥å£ä¸æ–¹æ³•è¯¦è§£)
3. [å‚æ•°ä¸è¿”å›å€¼å¤„ç†](#3-å‚æ•°ä¸è¿”å›å€¼å¤„ç†)
4. [å¼‚å¸¸å¤„ç†æœºåˆ¶](#4-å¼‚å¸¸å¤„ç†æœºåˆ¶)
5. [æ’ä»¶é…ç½®ä¸æµ‹è¯•](#5-æ’ä»¶é…ç½®ä¸æµ‹è¯•)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ’ä»¶å¼€å‘åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯MyBatisæ’ä»¶


**é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ åœ¨é¤å…ç‚¹é¤ï¼ŒæœåŠ¡å‘˜æŠŠèœå•äº¤ç»™å¨å¸ˆä¹‹å‰ï¼Œå¯èƒ½ä¼šå…ˆæ£€æŸ¥ä¸€ä¸‹èœå•ã€è®°å½•ä¸‹ç‚¹é¤æ—¶é—´ã€æˆ–è€…ç»™ç‰¹æ®Šå®¢æˆ·æ‰“ä¸ªæŠ˜æ‰£ã€‚MyBatisæ’ä»¶å°±åƒè¿™ä¸ª"ä¸­é—´æœåŠ¡å‘˜"ï¼Œå¯ä»¥åœ¨SQLæ‰§è¡Œçš„å…³é”®ç¯èŠ‚æ’æ‰‹åšäº›é¢å¤–å·¥ä½œã€‚

```
æ²¡æœ‰æ’ä»¶çš„æµç¨‹ï¼š
åº”ç”¨ä»£ç  â†’ MyBatis â†’ æ•°æ®åº“
         ç›´æ¥æ‰§è¡Œ

æœ‰æ’ä»¶çš„æµç¨‹ï¼š
åº”ç”¨ä»£ç  â†’ MyBatis â†’ ğŸ”§æ’ä»¶æ‹¦æˆª â†’ æ•°æ®åº“
                    â†“
              å¢å¼ºåŠŸèƒ½(æ—¥å¿—/æƒé™/ç¼“å­˜)
```

**ğŸ”¸ æ ¸å¿ƒä½œç”¨**ï¼š
- **æ—¥å¿—è®°å½•**ï¼šè®°å½•æ¯æ¡SQLçš„æ‰§è¡Œæ—¶é—´å’Œå‚æ•°
- **æƒé™æ§åˆ¶**ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ‰§è¡ŒæŸä¸ªSQL
- **æ€§èƒ½ç›‘æ§**ï¼šç»Ÿè®¡æ…¢SQLï¼Œåˆ†ææ€§èƒ½ç“¶é¢ˆ
- **æ•°æ®åŠ å¯†**ï¼šè‡ªåŠ¨åŠ å¯†æ•æ„Ÿæ•°æ®
- **åˆ†é¡µä¼˜åŒ–**ï¼šè‡ªåŠ¨æ·»åŠ åˆ†é¡µé€»è¾‘

### 1.2 æ’ä»¶çš„å·¥ä½œåŸç†


**æ‹¦æˆªç‚¹ä½ç½®**ï¼š
```
SQLæ‰§è¡Œå…¨æµç¨‹ï¼š

1. Executoræ‰§è¡Œå™¨ â† å¯ä»¥æ‹¦æˆª
   â†“
2. StatementHandlerè¯­å¥å¤„ç†å™¨ â† å¯ä»¥æ‹¦æˆª
   â†“
3. ParameterHandlerå‚æ•°å¤„ç†å™¨ â† å¯ä»¥æ‹¦æˆª
   â†“
4. ResultSetHandlerç»“æœå¤„ç†å™¨ â† å¯ä»¥æ‹¦æˆª
   â†“
5. è¿”å›ç»“æœ
```

**ğŸ”¸ å››å¤§æ‹¦æˆªç‚¹è¯´æ˜**ï¼š

| æ‹¦æˆªç‚¹ | **ä½œç”¨** | **å…¸å‹åº”ç”¨** |
|--------|----------|-------------|
| **Executor** | `SQLæ‰§è¡Œçš„æ€»æŒ‡æŒ¥` | `æ…¢SQLç›‘æ§ã€ç¼“å­˜æ§åˆ¶` |
| **StatementHandler** | `SQLè¯­å¥å‡†å¤‡å’Œæ‰§è¡Œ` | `SQLé‡å†™ã€åˆ†é¡µå¤„ç†` |
| **ParameterHandler** | `å‚æ•°è®¾ç½®` | `å‚æ•°åŠ å¯†ã€å‚æ•°éªŒè¯` |
| **ResultSetHandler** | `ç»“æœæ˜ å°„` | `ç»“æœè„±æ•ã€æ ¼å¼è½¬æ¢` |

---

## 2. âš™ï¸ æ ¸å¿ƒæ¥å£ä¸æ–¹æ³•è¯¦è§£


### 2.1 Interceptoræ¥å£ä¸‰å¤§æ–¹æ³•


MyBatisæ’ä»¶å¿…é¡»å®ç° `Interceptor` æ¥å£ï¼Œè¿™ä¸ªæ¥å£æœ‰ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼Œæ¯ä¸ªéƒ½æœ‰ç‰¹å®šç”¨é€”ï¼š

```java
public interface Interceptor {
    // 1. æ‹¦æˆªçš„æ ¸å¿ƒé€»è¾‘
    Object intercept(Invocation invocation) throws Throwable;
    
    // 2. åŒ…è£…ç›®æ ‡å¯¹è±¡
    Object plugin(Object target);
    
    // 3. è¯»å–é…ç½®å‚æ•°
    void setProperties(Properties properties);
}
```

### 2.2 interceptæ–¹æ³• - æ ¸å¿ƒæ‹¦æˆªé€»è¾‘


**ğŸ”¸ æ–¹æ³•ä½œç”¨**ï¼šè¿™æ˜¯æ’ä»¶çš„"å¿ƒè„"ï¼Œæ‰€æœ‰æ‹¦æˆªåçš„å¤„ç†é€»è¾‘éƒ½å†™åœ¨è¿™é‡Œ

**é€šä¿—è§£é‡Š**ï¼š
å°±åƒé—¨å«æ£€æŸ¥èº«ä»½è¯ï¼Œ`intercept` æ–¹æ³•å°±æ˜¯é—¨å«çš„å·¥ä½œæµç¨‹ï¼š
1. å…ˆçœ‹çœ‹æ¥çš„æ˜¯è°ï¼ˆè·å–å‚æ•°ï¼‰
2. å†³å®šæ”¾ä¸æ”¾è¡Œï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
3. å¯èƒ½æ”¹ä¸€ä¸‹ç™»è®°ä¿¡æ¯ï¼ˆä¿®æ”¹å‚æ•°ï¼‰
4. æœ€åè®©ä»–è¿›å»ï¼ˆç»§ç»­æ‰§è¡Œæˆ–è¿”å›ç»“æœï¼‰

**å®Œæ•´ç¤ºä¾‹ - æ…¢SQLç›‘æ§æ’ä»¶**ï¼š

```java
@Intercepts({
    @Signature(
        type = Executor.class,           // æ‹¦æˆªExecutor
        method = "update",               // æ‹¦æˆªupdateæ–¹æ³•
        args = {MappedStatement.class, Object.class}  // æ–¹æ³•å‚æ•°ç±»å‹
    )
})
public class SlowSqlPlugin implements Interceptor {
    
    private long slowSqlThreshold = 1000; // æ…¢SQLé˜ˆå€¼ï¼š1ç§’
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // 1. è®°å½•å¼€å§‹æ—¶é—´
        long startTime = System.currentTimeMillis();
        
        // 2. è·å–SQLç›¸å…³ä¿¡æ¯
        MappedStatement ms = (MappedStatement) invocation.getArgs()[0];
        String sqlId = ms.getId();  // SQLçš„IDï¼Œå¦‚ï¼šUserMapper.selectById
        
        // 3. æ‰§è¡ŒåŸå§‹æ–¹æ³•ï¼ˆæ”¾è¡Œï¼‰
        Object result = invocation.proceed();
        
        // 4. è®¡ç®—æ‰§è¡Œæ—¶é—´
        long endTime = System.currentTimeMillis();
        long executeTime = endTime - startTime;
        
        // 5. æ…¢SQLå‘Šè­¦
        if (executeTime > slowSqlThreshold) {
            System.err.println("âš ï¸ æ…¢SQLå‘Šè­¦ï¼");
            System.err.println("SQL ID: " + sqlId);
            System.err.println("æ‰§è¡Œæ—¶é—´: " + executeTime + "ms");
        }
        
        return result;
    }
    
    // ... å…¶ä»–æ–¹æ³•çœç•¥
}
```

**ğŸ”¹ æ ¸å¿ƒè¦ç‚¹è§£æ**ï¼š

```
invocation.proceed() çš„ç†è§£ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è¿™ä¸ªæ–¹æ³•å°±åƒ"æ”¾è¡Œé€šè¡Œè¯"

ä¸è°ƒç”¨proceed()ï¼š
â†’ åŸæ–¹æ³•ä¸ä¼šæ‰§è¡Œ
â†’ ç›¸å½“äºæ‹¦æˆªä¸æ”¾è¡Œ

è°ƒç”¨proceed()ï¼š  
â†’ ç»§ç»­æ‰§è¡ŒåŸæ–¹æ³•
â†’ ç›¸å½“äºæ£€æŸ¥å®Œæ¯•ï¼Œæ”¾è¡Œ

åœ¨proceed()å‰åï¼š
â†’ å‰é¢å¯ä»¥åšå‡†å¤‡å·¥ä½œ
â†’ åé¢å¯ä»¥åšæ”¶å°¾å·¥ä½œ
```

### 2.3 pluginæ–¹æ³• - åˆ›å»ºä»£ç†å¯¹è±¡


**ğŸ”¸ æ–¹æ³•ä½œç”¨**ï¼šå†³å®šæ˜¯å¦æ‹¦æˆªç›®æ ‡å¯¹è±¡

**é€šä¿—è§£é‡Š**ï¼š
å°±åƒå®‰æ£€å£å†³å®šå“ªäº›äººéœ€è¦æ£€æŸ¥ã€‚ä¸æ˜¯æ‰€æœ‰äººéƒ½è¦æ‹¦æˆªï¼Œpluginæ–¹æ³•è´Ÿè´£ç­›é€‰"è¿™ä¸ªå¯¹è±¡éœ€ä¸éœ€è¦æˆ‘ç®¡"ã€‚

```java
@Override
public Object plugin(Object target) {
    // MyBatisæä¾›çš„å·¥å…·æ–¹æ³•ï¼Œè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆª
    return Plugin.wrap(target, this);
}
```

**å·¥ä½œæµç¨‹å›¾ç¤º**ï¼š
```
MyBatisåˆ›å»ºå¯¹è±¡æ—¶ï¼š
  
å¯¹è±¡A â†’ plugin()æ–¹æ³•åˆ¤æ–­ â†’ âŒä¸åŒ¹é… â†’ è¿”å›åŸå¯¹è±¡
å¯¹è±¡B â†’ plugin()æ–¹æ³•åˆ¤æ–­ â†’ âœ…åŒ¹é…   â†’ è¿”å›ä»£ç†å¯¹è±¡
                              â†“
                        åç»­è°ƒç”¨ä¼šè¢«æ‹¦æˆª
```

**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ–¹æ³•**ï¼š
- MyBatisä¼šæŠŠå››å¤§å¯¹è±¡ï¼ˆExecutorã€StatementHandlerç­‰ï¼‰éƒ½ä¼ è¿›æ¥
- æˆ‘ä»¬åªæ‹¦æˆªéœ€è¦çš„å¯¹è±¡ï¼Œä¸ç›¸å…³çš„ç›´æ¥æ”¾è¿‡
- `Plugin.wrap()` ä¼šè‡ªåŠ¨æ£€æŸ¥ `@Signature` æ³¨è§£åˆ¤æ–­æ˜¯å¦åŒ¹é…

### 2.4 setPropertiesæ–¹æ³• - è¯»å–é…ç½®


**ğŸ”¸ æ–¹æ³•ä½œç”¨**ï¼šä»é…ç½®æ–‡ä»¶è¯»å–æ’ä»¶å‚æ•°

**é€šä¿—è§£é‡Š**ï¼š
å°±åƒç»™é—¨å«å‘å·¥ä½œæ‰‹å†Œï¼Œå‘Šè¯‰ä»–"æ…¢SQLçš„æ ‡å‡†æ˜¯å¤šå°‘ç§’""æ˜¯å¦è¦è®°å½•æ—¥å¿—"ç­‰è§„åˆ™ã€‚

```java
@Override
public void setProperties(Properties properties) {
    // ä»é…ç½®æ–‡ä»¶è¯»å–å‚æ•°
    String threshold = properties.getProperty("slowSqlThreshold");
    if (threshold != null) {
        this.slowSqlThreshold = Long.parseLong(threshold);
    }
    
    String enableLog = properties.getProperty("enableLog");
    this.enableLog = "true".equals(enableLog);
}
```

**é…ç½®æ–‡ä»¶ç¤ºä¾‹**ï¼š
```xml
<!-- mybatis-config.xml -->
<plugins>
    <plugin interceptor="com.example.SlowSqlPlugin">
        <property name="slowSqlThreshold" value="2000"/>
        <property name="enableLog" value="true"/>
    </plugin>
</plugins>
```

---

## 3. ğŸ”§ å‚æ•°ä¸è¿”å›å€¼å¤„ç†


### 3.1 Invocationè°ƒç”¨å¯¹è±¡è¯¦è§£


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**ï¼š
`Invocation` å°±åƒä¸€ä¸ª"ä¿¡æ¯åŒ…è£¹"ï¼Œé‡Œé¢è£…ç€è¢«æ‹¦æˆªæ–¹æ³•çš„æ‰€æœ‰ä¿¡æ¯ã€‚

```java
public class Invocation {
    private Object target;      // è¢«æ‹¦æˆªçš„å¯¹è±¡
    private Method method;      // è¢«æ‹¦æˆªçš„æ–¹æ³•
    private Object[] args;      // æ–¹æ³•çš„å‚æ•°
    
    public Object proceed() throws Throwable; // ç»§ç»­æ‰§è¡Œ
}
```

**é€šä¿—ç±»æ¯”**ï¼š
```
æƒ³è±¡å¿«é€’åŒ…è£¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¦ Invocation      â”‚
â”‚                    â”‚
â”‚ æ”¶ä»¶äººï¼šExecutor    â”‚ â† target
â”‚ ç‰©å“ï¼šupdateæ–¹æ³•    â”‚ â† method  
â”‚ å†…å®¹ï¼šå‚æ•°æ•°ç»„      â”‚ â† args
â”‚                    â”‚
â”‚ [ç­¾æ”¶æŒ‰é’®] proceed â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è·å–å’Œä¿®æ”¹å‚æ•°


**å®æˆ˜ç¤ºä¾‹ - å‚æ•°åŠ å¯†æ’ä»¶**ï¼š

```java
@Intercepts({
    @Signature(
        type = ParameterHandler.class,
        method = "setParameters",
        args = {PreparedStatement.class}
    )
})
public class EncryptPlugin implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // 1. è·å–ParameterHandler
        ParameterHandler paramHandler = (ParameterHandler) invocation.getTarget();
        
        // 2. é€šè¿‡åå°„è·å–å‚æ•°å¯¹è±¡
        Field paramField = paramHandler.getClass()
            .getDeclaredField("parameterObject");
        paramField.setAccessible(true);
        Object paramObject = paramField.get(paramHandler);
        
        // 3. å¦‚æœæ˜¯Userå¯¹è±¡ï¼ŒåŠ å¯†å¯†ç 
        if (paramObject instanceof User) {
            User user = (User) paramObject;
            String password = user.getPassword();
            
            // åŠ å¯†å¤„ç†
            String encryptedPwd = encrypt(password);
            user.setPassword(encryptedPwd);
            
            System.out.println("å¯†ç å·²åŠ å¯†å¤„ç†");
        }
        
        // 4. ç»§ç»­æ‰§è¡Œ
        return invocation.proceed();
    }
    
    private String encrypt(String password) {
        // ç®€å•ç¤ºä¾‹ï¼Œå®é™…åº”ä½¿ç”¨å®‰å…¨ç®—æ³•
        return "encrypted_" + password;
    }
}
```

**ğŸ”¹ å‚æ•°è·å–æŠ€å·§**ï¼š

```
è·å–å‚æ•°çš„ä¸‰ç§æ–¹å¼ï¼š

æ–¹å¼1ï¼šç›´æ¥ä»argsè·å–
Object[] args = invocation.getArgs();
MappedStatement ms = (MappedStatement) args[0];

æ–¹å¼2ï¼šé€šè¿‡åå°„è·å–å­—æ®µ
Field field = target.getClass().getDeclaredField("xxx");
field.setAccessible(true);
Object value = field.get(target);

æ–¹å¼3ï¼šä½¿ç”¨MetaObjectå·¥å…·
MetaObject metaObject = SystemMetaObject.forObject(target);
Object value = metaObject.getValue("xxx");
```

### 3.3 è¿”å›å€¼å¤„ç†


**å®æˆ˜ç¤ºä¾‹ - ç»“æœè„±æ•æ’ä»¶**ï¼š

```java
@Intercepts({
    @Signature(
        type = ResultSetHandler.class,
        method = "handleResultSets",
        args = {Statement.class}
    )
})
public class DesensitizePlugin implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // 1. å…ˆè·å–åŸå§‹ç»“æœ
        Object result = invocation.proceed();
        
        // 2. å¤„ç†ç»“æœï¼ˆå¦‚æœæ˜¯åˆ—è¡¨ï¼‰
        if (result instanceof List) {
            List<?> list = (List<?>) result;
            for (Object obj : list) {
                if (obj instanceof User) {
                    desensitizeUser((User) obj);
                }
            }
        }
        // 3. å¤„ç†ç»“æœï¼ˆå¦‚æœæ˜¯å•ä¸ªå¯¹è±¡ï¼‰
        else if (result instanceof User) {
            desensitizeUser((User) result);
        }
        
        return result;
    }
    
    private void desensitizeUser(User user) {
        // æ‰‹æœºå·è„±æ•ï¼š138****5678
        String phone = user.getPhone();
        if (phone != null && phone.length() == 11) {
            String masked = phone.substring(0, 3) + "****" + phone.substring(7);
            user.setPhone(masked);
        }
    }
}
```

**ğŸ”¹ è¿”å›å€¼å¤„ç†æ³¨æ„äº‹é¡¹**ï¼š

> âš ï¸ **é‡è¦æç¤º**
> 
> è¿”å›å€¼å¿…é¡»ä¸åŸæ–¹æ³•è¿”å›ç±»å‹åŒ¹é…ï¼
> - åŸæ–¹æ³•è¿”å›Listï¼Œä½ ä¹Ÿè¦è¿”å›List
> - åŸæ–¹æ³•è¿”å›Integerï¼Œä½ ä¹Ÿè¦è¿”å›Integer
> - å¯ä»¥ä¿®æ”¹å†…å®¹ï¼Œä½†ä¸èƒ½æ”¹å˜ç±»å‹

---

## 4. ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†æœºåˆ¶


### 4.1 å¼‚å¸¸å¤„ç†çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆè¦å¤„ç†å¼‚å¸¸**ï¼š
æ’ä»¶å‡ºé”™ä¸åº”è¯¥å½±å“æ­£å¸¸ä¸šåŠ¡ã€‚å°±åƒå¿«é€’ä¸­é€”æ£€æŸ¥ï¼Œå°±ç®—æ£€æŸ¥ç¯èŠ‚å‡ºé—®é¢˜ï¼Œå¿«é€’ä¹Ÿè¦èƒ½æ­£å¸¸é€è¾¾ã€‚

```
å¼‚å¸¸å¤„ç†ç­–ç•¥ï¼š

å¥½çš„åšæ³• âœ…ï¼š
try {
    // æ’ä»¶é€»è¾‘
} catch (Exception e) {
    è®°å½•æ—¥å¿—
    ç»§ç»­æ‰§è¡ŒåŸæ–¹æ³•
}

ä¸å¥½çš„åšæ³• âŒï¼š
ç›´æ¥æŠ›å‡ºå¼‚å¸¸
â†’ ä¸šåŠ¡ä¸­æ–­
â†’ ç”¨æˆ·çœ‹åˆ°é”™è¯¯
```

### 4.2 å®Œæ•´çš„å¼‚å¸¸å¤„ç†ç¤ºä¾‹


```java
@Intercepts({
    @Signature(
        type = Executor.class,
        method = "query",
        args = {MappedStatement.class, Object.class, 
                RowBounds.class, ResultHandler.class}
    )
})
public class SafePlugin implements Interceptor {
    
    private static final Logger logger = LoggerFactory.getLogger(SafePlugin.class);
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        long startTime = System.currentTimeMillis();
        Object result = null;
        
        try {
            // 1. å‰ç½®å¤„ç†
            beforeProcess(invocation);
            
            // 2. æ‰§è¡ŒåŸæ–¹æ³•
            result = invocation.proceed();
            
            // 3. åç½®å¤„ç†  
            afterProcess(result);
            
        } catch (Exception e) {
            // 4. å¼‚å¸¸å¤„ç†
            handleException(invocation, e);
            
            // é‡è¦ï¼šå¼‚å¸¸åä»ç„¶æ‰§è¡ŒåŸæ–¹æ³•
            if (result == null) {
                result = invocation.proceed();
            }
            
        } finally {
            // 5. æ¸…ç†å·¥ä½œ
            cleanup(startTime);
        }
        
        return result;
    }
    
    private void beforeProcess(Invocation invocation) {
        try {
            // å‰ç½®é€»è¾‘ï¼Œå¯èƒ½å‡ºé”™
            logger.info("å¼€å§‹æ‹¦æˆªå¤„ç†");
        } catch (Exception e) {
            logger.error("å‰ç½®å¤„ç†å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ", e);
            // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œç»§ç»­æ‰§è¡Œ
        }
    }
    
    private void handleException(Invocation invocation, Exception e) {
        MappedStatement ms = (MappedStatement) invocation.getArgs()[0];
        logger.error("æ’ä»¶å¤„ç†å¼‚å¸¸, SQL ID: {}", ms.getId(), e);
        
        // å¯ä»¥é€‰æ‹©ï¼š
        // 1. åªè®°å½•æ—¥å¿—
        // 2. å‘é€å‘Šè­¦
        // 3. é™çº§å¤„ç†
    }
    
    private void cleanup(long startTime) {
        long cost = System.currentTimeMillis() - startTime;
        logger.debug("æ’ä»¶å¤„ç†è€—æ—¶: {}ms", cost);
    }
}
```

**ğŸ”¹ å¼‚å¸¸å¤„ç†åŸåˆ™**ï¼š

```
1. åˆ†å±‚å¤„ç†ï¼š
   â”œâ”€ å‰ç½®å¤„ç†å¼‚å¸¸ â†’ è®°å½•æ—¥å¿—ï¼Œç»§ç»­
   â”œâ”€ æ ¸å¿ƒé€»è¾‘å¼‚å¸¸ â†’ å‘Šè­¦ï¼Œå¿…è¦æ—¶é™çº§
   â””â”€ åç½®å¤„ç†å¼‚å¸¸ â†’ è®°å½•æ—¥å¿—ï¼Œç»§ç»­

2. ä¸è¦å½±å“ä¸šåŠ¡ï¼š
   âœ… æ’ä»¶å¤±è´¥ï¼Œä¸šåŠ¡æ­£å¸¸
   âŒ æ’ä»¶å¤±è´¥ï¼Œä¸šåŠ¡ä¸­æ–­

3. æ—¥å¿—è¦æ¸…æ™°ï¼š
   âœ… è®°å½•å¼‚å¸¸ä¸Šä¸‹æ–‡ï¼ˆSQL IDã€å‚æ•°ç­‰ï¼‰
   âŒ åªè®°å½•Exception.getMessage()
```

---

## 5. âš™ï¸ æ’ä»¶é…ç½®ä¸æµ‹è¯•


### 5.1 æ’ä»¶æ³¨å†Œé…ç½®


**é…ç½®æ–¹å¼ä¸€ï¼šXMLé…ç½®**

```xml
<!-- mybatis-config.xml -->
<configuration>
    <plugins>
        <!-- æ…¢SQLç›‘æ§æ’ä»¶ -->
        <plugin interceptor="com.example.plugin.SlowSqlPlugin">
            <property name="slowSqlThreshold" value="2000"/>
            <property name="enableLog" value="true"/>
        </plugin>
        
        <!-- æ•°æ®è„±æ•æ’ä»¶ -->
        <plugin interceptor="com.example.plugin.DesensitizePlugin">
            <property name="fields" value="phone,idCard"/>
        </plugin>
    </plugins>
</configuration>
```

**é…ç½®æ–¹å¼äºŒï¼šSpring Booté…ç½®**

```java
@Configuration
public class MyBatisConfig {
    
    @Bean
    public ConfigurationCustomizer configurationCustomizer() {
        return configuration -> {
            // æ·»åŠ æ…¢SQLæ’ä»¶
            SlowSqlPlugin slowSqlPlugin = new SlowSqlPlugin();
            slowSqlPlugin.setSlowSqlThreshold(2000L);
            configuration.addInterceptor(slowSqlPlugin);
            
            // æ·»åŠ è„±æ•æ’ä»¶
            DesensitizePlugin desensitizePlugin = new DesensitizePlugin();
            configuration.addInterceptor(desensitizePlugin);
        };
    }
}
```

**ğŸ”¹ å¤šæ’ä»¶æ‰§è¡Œé¡ºåº**ï¼š

```
æ’ä»¶æ‰§è¡Œé¡ºåº = é…ç½®é¡ºåºçš„é€†åº

é…ç½®é¡ºåºï¼š
1. æ’ä»¶A
2. æ’ä»¶B  
3. æ’ä»¶C

å®é™…æ‰§è¡Œï¼š
è¯·æ±‚ â†’ C â†’ B â†’ A â†’ ç›®æ ‡æ–¹æ³• â†’ A â†’ B â†’ C â†’ å“åº”
      â†“       â†‘
    (é€†åº)  (é¡ºåº)

è®°å¿†æŠ€å·§ï¼šåƒæ´‹è‘±ä¸€æ ·ï¼Œä¸€å±‚å±‚åŒ…è£¹
```

### 5.2 æ’ä»¶æµ‹è¯•ç­–ç•¥


**å•å…ƒæµ‹è¯•ç¤ºä¾‹**ï¼š

```java
@Test
public void testSlowSqlPlugin() throws Throwable {
    // 1. å‡†å¤‡æ’ä»¶
    SlowSqlPlugin plugin = new SlowSqlPlugin();
    Properties props = new Properties();
    props.setProperty("slowSqlThreshold", "100");
    plugin.setProperties(props);
    
    // 2. æ¨¡æ‹ŸInvocation
    Executor executor = mock(Executor.class);
    Method method = Executor.class.getMethod("update", 
        MappedStatement.class, Object.class);
    
    MappedStatement ms = mock(MappedStatement.class);
    when(ms.getId()).thenReturn("com.example.UserMapper.insert");
    
    Object[] args = {ms, new User()};
    Invocation invocation = new Invocation(executor, method, args);
    
    // 3. æ¨¡æ‹Ÿæ…¢SQLï¼ˆä¼‘çœ 150msï¼‰
    when(executor.update(any(), any())).thenAnswer(inv -> {
        Thread.sleep(150);
        return 1;
    });
    
    // 4. æ‰§è¡Œæ’ä»¶
    Object result = plugin.intercept(invocation);
    
    // 5. éªŒè¯ç»“æœ
    assertNotNull(result);
    // éªŒè¯æ—¥å¿—è¾“å‡ºï¼ˆä½¿ç”¨æ—¥å¿—æ•è·å·¥å…·ï¼‰
}
```

**é›†æˆæµ‹è¯•ç¤ºä¾‹**ï¼š

```java
@SpringBootTest
@Transactional
public class PluginIntegrationTest {
    
    @Autowired
    private UserMapper userMapper;
    
    @Test
    public void testPluginInRealScenario() {
        // 1. æ‰§è¡ŒçœŸå®SQL
        User user = new User();
        user.setName("å¼ ä¸‰");
        user.setPhone("13812345678");
        user.setPassword("123456");
        
        userMapper.insert(user);
        
        // 2. æŸ¥è¯¢éªŒè¯ï¼ˆä¼šè§¦å‘è„±æ•æ’ä»¶ï¼‰
        User result = userMapper.selectById(user.getId());
        
        // 3. éªŒè¯è„±æ•æ•ˆæœ
        assertEquals("138****5678", result.getPhone());
        
        // 4. éªŒè¯åŠ å¯†æ•ˆæœ
        assertTrue(result.getPassword().startsWith("encrypted_"));
    }
}
```

**ğŸ”¹ æµ‹è¯•æ£€æŸ¥æ¸…å•**ï¼š

```
âœ… åŠŸèƒ½æµ‹è¯•ï¼š
   â–¡ æ­£å¸¸åœºæ™¯èƒ½å¦æ­£ç¡®æ‹¦æˆª
   â–¡ å‚æ•°è·å–æ˜¯å¦å‡†ç¡®
   â–¡ è¿”å›å€¼å¤„ç†æ˜¯å¦æ­£ç¡®

âœ… å¼‚å¸¸æµ‹è¯•ï¼š
   â–¡ å‚æ•°ä¸ºnullæ—¶çš„å¤„ç†
   â–¡ åå°„å¤±è´¥æ—¶çš„é™çº§
   â–¡ å¼‚å¸¸ä¸å½±å“ä¸šåŠ¡

âœ… æ€§èƒ½æµ‹è¯•ï¼š
   â–¡ æ’ä»¶æœ¬èº«çš„è€—æ—¶
   â–¡ å¯¹æ•´ä½“æ€§èƒ½çš„å½±å“
   â–¡ å¹¶å‘åœºæ™¯ä¸‹çš„è¡¨ç°

âœ… å…¼å®¹æ€§æµ‹è¯•ï¼š
   â–¡ ä¸å…¶ä»–æ’ä»¶çš„å…¼å®¹æ€§
   â–¡ ä¸åŒMyBatisç‰ˆæœ¬çš„å…¼å®¹æ€§
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ’ä»¶ä¸‰å¤§æ–¹æ³•ï¼š
  â€¢ intercept()  - æ‹¦æˆªé€»è¾‘çš„æ ¸å¿ƒå®ç°
  â€¢ plugin()     - å†³å®šæ˜¯å¦æ‹¦æˆªç›®æ ‡å¯¹è±¡
  â€¢ setProperties() - è¯»å–é…ç½®å‚æ•°

ğŸ”¸ Invocationå¯¹è±¡ï¼š
  â€¢ target - è¢«æ‹¦æˆªçš„å¯¹è±¡
  â€¢ method - è¢«æ‹¦æˆªçš„æ–¹æ³•
  â€¢ args   - æ–¹æ³•å‚æ•°æ•°ç»„
  â€¢ proceed() - ç»§ç»­æ‰§è¡ŒåŸæ–¹æ³•

ğŸ”¸ å››å¤§æ‹¦æˆªç‚¹ï¼š
  â€¢ Executor        - SQLæ‰§è¡Œå…¥å£
  â€¢ StatementHandler - SQLè¯­å¥å¤„ç†
  â€¢ ParameterHandler - å‚æ•°è®¾ç½®
  â€¢ ResultSetHandler - ç»“æœæ˜ å°„
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ interceptæ–¹æ³•çš„æ‰§è¡Œæµç¨‹**ï¼š
```
1. è·å–å‚æ•°ä¿¡æ¯ï¼ˆé€šè¿‡Invocationï¼‰
   â†“
2. æ‰§è¡Œå‰ç½®å¤„ç†ï¼ˆè®°å½•ã€éªŒè¯ã€ä¿®æ”¹ï¼‰
   â†“
3. è°ƒç”¨proceed()ç»§ç»­æ‰§è¡Œ
   â†“
4. æ‰§è¡Œåç½®å¤„ç†ï¼ˆè®°å½•ã€è½¬æ¢ã€è„±æ•ï¼‰
   â†“
5. è¿”å›æœ€ç»ˆç»“æœ
```

**ğŸ”¹ å‚æ•°è·å–çš„ä¸‰ç§æ–¹å¼**ï¼š
```
ç›´æ¥è·å–ï¼šinvocation.getArgs()[0]
åå°„è·å–ï¼šfield.get(target)  
å·¥å…·è·å–ï¼šMetaObject.getValue("xxx")

æ¨èï¼šç®€å•å‚æ•°ç”¨ç›´æ¥è·å–ï¼Œå¤æ‚å¯¹è±¡ç”¨MetaObject
```

**ğŸ”¹ å¼‚å¸¸å¤„ç†åŸåˆ™**ï¼š
```
è®°ä½ä¸€å¥è¯ï¼šæ’ä»¶å¤±è´¥ä¸èƒ½å½±å“ä¸šåŠ¡

å…·ä½“åšæ³•ï¼š
â€¢ try-catchåŒ…è£¹æ ¸å¿ƒé€»è¾‘
â€¢ å¼‚å¸¸åªè®°å½•æ—¥å¿—ï¼Œä¸æŠ›å‡º
â€¢ finallyæ¸…ç†èµ„æº
â€¢ å¿…è¦æ—¶é™çº§å¤„ç†
```

### 6.3 å®æˆ˜åº”ç”¨æŒ‡å—


**ğŸ¯ å¸¸è§æ’ä»¶åœºæ™¯**ï¼š

| åœºæ™¯ | **æ‹¦æˆªç‚¹** | **æ ¸å¿ƒå¤„ç†** |
|------|-----------|-------------|
| **æ…¢SQLç›‘æ§** | `Executor` | `è®°å½•æ—¶é—´ï¼Œè¶…æ—¶å‘Šè­¦` |
| **SQLæ—¥å¿—** | `StatementHandler` | `æ‰“å°å®Œæ•´SQLè¯­å¥` |
| **æ•°æ®åŠ å¯†** | `ParameterHandler` | `ä¿®æ”¹å‚æ•°å€¼` |
| **ç»“æœè„±æ•** | `ResultSetHandler` | `å¤„ç†è¿”å›å€¼` |
| **åˆ†é¡µæ’ä»¶** | `StatementHandler` | `æ”¹å†™SQLè¯­å¥` |

**ğŸ”¹ å¼€å‘å»ºè®®**ï¼š
```
1. èŒè´£å•ä¸€ï¼šä¸€ä¸ªæ’ä»¶åªåšä¸€ä»¶äº‹
   âœ… æ…¢SQLç›‘æ§æ’ä»¶
   âŒ æ—¢ç›‘æ§åˆåˆ†é¡µåˆåŠ å¯†çš„"å…¨èƒ½æ’ä»¶"

2. æ€§èƒ½ä¼˜å…ˆï¼šæ’ä»¶é€»è¾‘è¦é«˜æ•ˆ
   âœ… ä½¿ç”¨ç¼“å­˜ã€é¿å…é‡å¤è®¡ç®—
   âŒ æ¯æ¬¡éƒ½åå°„ã€å¤æ‚è®¡ç®—

3. é…ç½®çµæ´»ï¼šé€šè¿‡Propertiesé…ç½®
   âœ… é˜ˆå€¼ã€å¼€å…³å¯é…ç½®
   âŒ å†™æ­»åœ¨ä»£ç é‡Œ

4. æµ‹è¯•å……åˆ†ï¼šå•å…ƒæµ‹è¯•+é›†æˆæµ‹è¯•
   âœ… è¦†ç›–æ­£å¸¸å’Œå¼‚å¸¸åœºæ™¯
   âŒ åªæµ‹è¯•æ­£å¸¸æµç¨‹
```

### 6.4 å­¦ä¹ æ£€æŸ¥æ¸…å•


```
âœ… æ¦‚å¿µç†è§£ï¼š
   â–¡ èƒ½è¯´å‡ºæ’ä»¶çš„ä½œç”¨å’Œå·¥ä½œåŸç†
   â–¡ èƒ½è§£é‡Šå››å¤§æ‹¦æˆªç‚¹çš„åŒºåˆ«
   â–¡ ç†è§£Invocationå¯¹è±¡çš„ç»„æˆ

âœ… ä»£ç å®ç°ï¼š
   â–¡ èƒ½å®ç°å®Œæ•´çš„interceptæ–¹æ³•
   â–¡ èƒ½è·å–å’Œä¿®æ”¹å‚æ•°
   â–¡ èƒ½å¤„ç†è¿”å›å€¼
   â–¡ èƒ½æ­£ç¡®å¤„ç†å¼‚å¸¸

âœ… é…ç½®ä½¿ç”¨ï¼š
   â–¡ ä¼šé…ç½®plugin
   â–¡ ä¼šè®¾ç½®properties
   â–¡ ç†è§£å¤šæ’ä»¶æ‰§è¡Œé¡ºåº

âœ… å®æˆ˜èƒ½åŠ›ï¼š
   â–¡ èƒ½å¼€å‘æ…¢SQLç›‘æ§æ’ä»¶
   â–¡ èƒ½å¼€å‘æ•°æ®è„±æ•æ’ä»¶
   â–¡ èƒ½ç¼–å†™æµ‹è¯•ç”¨ä¾‹
```

### 6.5 è®°å¿†å£è¯€


```
ğŸ§  æ’ä»¶ä¸‰æ–¹æ³•ï¼š
interceptæ‹¦æˆªçœŸåˆ€å¹²ï¼Œ
pluginåŒ…è£…åˆ¤æ–­é€‰ï¼Œ
setPropertiesè¯»é…ç½®å‚

ğŸ§  Invocationä¸‰è¦ç´ ï¼š
targetå¯¹è±¡methodæ–¹æ³•ï¼Œ
argså‚æ•°è¦è®°ç‰¢ï¼Œ
proceedæ”¾è¡Œä¸èƒ½å¿˜

ğŸ§  å¼‚å¸¸å¤„ç†åŸåˆ™ï¼š
tryåŒ…è£¹catchè®°å½•ï¼Œ
ä¸æŠ›å¼‚å¸¸è¦è®°ä½ï¼Œ
ä¸šåŠ¡ä¼˜å…ˆæ’ä»¶è®©è·¯
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- MyBatisæ’ä»¶å°±æ˜¯åœ¨å…³é”®ç¯èŠ‚æ’å…¥è‡ªå®šä¹‰é€»è¾‘
- interceptæ˜¯æ ¸å¿ƒï¼Œproceedæ˜¯æ”¾è¡Œï¼Œå¼‚å¸¸è¦å…œåº•
- å››å¤§æ‹¦æˆªç‚¹å„å¸å…¶èŒï¼Œé€‰å¯¹ç‚¹ä½äº‹åŠåŠŸå€
- æµ‹è¯•è¦å……åˆ†ï¼Œæ€§èƒ½è¦è€ƒè™‘ï¼Œé…ç½®è¦çµæ´»