---
title: 22ã€SessionFactoryç®¡ç†
---
## ğŸ“š ç›®å½•

1. [SessionFactoryæ˜¯ä»€ä¹ˆ](#1-sessionfactoryæ˜¯ä»€ä¹ˆ)
2. [SessionFactoryçš„åˆ›å»ºè¿‡ç¨‹](#2-sessionfactoryçš„åˆ›å»ºè¿‡ç¨‹)
3. [çº¿ç¨‹å®‰å…¨ç‰¹æ€§](#3-çº¿ç¨‹å®‰å…¨ç‰¹æ€§)
4. [å•ä¾‹æ¨¡å¼åº”ç”¨](#4-å•ä¾‹æ¨¡å¼åº”ç”¨)
5. [ç”Ÿå‘½å‘¨æœŸç®¡ç†](#5-ç”Ÿå‘½å‘¨æœŸç®¡ç†)
6. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#6-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
7. [èµ„æºé‡Šæ”¾ä¸å…³é—­](#7-èµ„æºé‡Šæ”¾ä¸å…³é—­)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ­ SessionFactoryæ˜¯ä»€ä¹ˆ


### 1.1 é€šä¿—ç†è§£SessionFactory


æŠŠSessionFactoryæƒ³è±¡æˆä¸€ä¸ª**ç”Ÿäº§Sessionçš„å·¥å‚**ï¼š

```
ç°å®ä¸­çš„å·¥å‚ï¼š                  Hibernateä¸­çš„SessionFactoryï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ±½è½¦å·¥å‚   â”‚                â”‚  SessionFactory  â”‚
â”‚             â”‚                â”‚                  â”‚
â”‚  [åŸææ–™]    â”‚                â”‚  [é…ç½®ä¿¡æ¯]      â”‚
â”‚  [ç”Ÿäº§çº¿]    â”‚  ç”Ÿäº§æ±½è½¦  â†’   â”‚  [æ˜ å°„å…ƒæ•°æ®]    â”‚  ç”Ÿäº§Session
â”‚  [è´¨æ£€ç³»ç»Ÿ]  â”‚                â”‚  [è¿æ¥æ± ]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                              â†“
   ç”Ÿäº§å‡ºæ±½è½¦                    ç”Ÿäº§å‡ºSessionå¯¹è±¡
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ“¦ **å·¥å‚èŒè´£**ï¼šä¸“é—¨ç”¨æ¥åˆ›å»ºSessionå¯¹è±¡
- ğŸ”§ **é…ç½®ç®¡ç†**ï¼šä¿å­˜æ‰€æœ‰çš„Hibernateé…ç½®ä¿¡æ¯
- ğŸ—„ï¸ **å…ƒæ•°æ®å­˜å‚¨**ï¼šä¿å­˜å®ä½“ç±»ä¸æ•°æ®åº“è¡¨çš„æ˜ å°„å…³ç³»
- ğŸ”Œ **èµ„æºæ± ç®¡ç†**ï¼šç®¡ç†æ•°æ®åº“è¿æ¥æ± 

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦SessionFactory


**é—®é¢˜åœºæ™¯**ï¼š
```
å¦‚æœæ²¡æœ‰SessionFactoryï¼Œæ¯æ¬¡æ“ä½œæ•°æ®åº“éƒ½è¦ï¼š
1. è¯»å–é…ç½®æ–‡ä»¶ âŒ è€—æ—¶
2. è§£ææ˜ å°„æ–‡ä»¶ âŒ è€—æ—¶  
3. åˆ›å»ºè¿æ¥æ±    âŒ è€—æ—¶
4. åˆå§‹åŒ–å„ç§ç»„ä»¶ âŒ è€—æ—¶

è¿™æ ·å¤ªæ…¢äº†ï¼
```

**ä½¿ç”¨SessionFactoryçš„å¥½å¤„**ï¼š
```
æœ‰äº†SessionFactoryåï¼š
1. åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–ä¸€æ¬¡ âœ… ä¸€æ¬¡æ€§æˆæœ¬
2. åç»­ç›´æ¥è·å–Session âœ… å¿«é€Ÿ
3. é‡ç”¨é…ç½®å’Œè¿æ¥ âœ… é«˜æ•ˆ
4. ç»Ÿä¸€ç®¡ç†èµ„æº âœ… å®‰å…¨

å°±åƒå·¥å‚å»ºå¥½åï¼Œéšæ—¶å¯ä»¥ç”Ÿäº§äº§å“ï¼
```

### 1.3 SessionFactoryä¸Sessionçš„å…³ç³»


```
å…³ç³»å›¾ç¤ºï¼š
                  SessionFactory (1ä¸ª)
                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚           â”‚           â”‚
         Session1    Session2    Session3 (å¤šä¸ª)
            â”‚           â”‚           â”‚
         æ“ä½œæ•°æ®åº“   æ“ä½œæ•°æ®åº“   æ“ä½œæ•°æ®åº“
```

**å…³ç³»è¯´æ˜**ï¼š
- **ä¸€å¯¹å¤šå…³ç³»**ï¼šä¸€ä¸ªSessionFactoryå¯ä»¥åˆ›å»ºå¤šä¸ªSession
- **å·¥å‚æ¨¡å¼**ï¼šSessionFactoryæ˜¯å·¥å‚ï¼ŒSessionæ˜¯äº§å“
- **é‡é‡çº§vsè½»é‡çº§**ï¼šSessionFactoryé‡é‡çº§ï¼ˆåˆ›å»ºæ…¢ï¼‰ï¼ŒSessionè½»é‡çº§ï¼ˆåˆ›å»ºå¿«ï¼‰

---

## 2. ğŸ”¨ SessionFactoryçš„åˆ›å»ºè¿‡ç¨‹


### 2.1 åˆ›å»ºæ–¹å¼æ¼”å˜


**ä¼ ç»Ÿæ–¹å¼ï¼ˆHibernate 4.xä¹‹å‰ï¼‰**ï¼š
```java
// 1. è¯»å–é…ç½®æ–‡ä»¶
Configuration cfg = new Configuration();
cfg.configure("hibernate.cfg.xml");

// 2. åˆ›å»ºSessionFactory
SessionFactory factory = cfg.buildSessionFactory();
```

**ç°ä»£æ–¹å¼ï¼ˆHibernate 5.xæ¨èï¼‰**ï¼š
```java
// ä½¿ç”¨StandardServiceRegistryæ„å»º
StandardServiceRegistry registry = new StandardServiceRegistryBuilder()
    .configure("hibernate.cfg.xml")  // åŠ è½½é…ç½®
    .build();

SessionFactory factory = new MetadataSources(registry)
    .buildMetadata()
    .buildSessionFactory();
```

### 2.2 åˆ›å»ºè¿‡ç¨‹è§£æ


**åˆå§‹åŒ–æµç¨‹å›¾**ï¼š
```
å¼€å§‹
  â”‚
  â†“
[1] åŠ è½½é…ç½®æ–‡ä»¶ (hibernate.cfg.xml)
  â”‚  â”œâ”€ æ•°æ®åº“è¿æ¥ä¿¡æ¯
  â”‚  â”œâ”€ æ–¹è¨€è®¾ç½®
  â”‚  â””â”€ å…¶ä»–é…ç½®å‚æ•°
  â†“
[2] è§£ææ˜ å°„æ–‡ä»¶ (*.hbm.xml æˆ–æ³¨è§£)
  â”‚  â”œâ”€ å®ä½“ç±»ä¿¡æ¯
  â”‚  â”œâ”€ å±æ€§æ˜ å°„
  â”‚  â””â”€ å…³ç³»æ˜ å°„
  â†“
[3] æ„å»ºå…ƒæ•°æ® (Metadata)
  â”‚  â”œâ”€ è¡¨ç»“æ„ä¿¡æ¯
  â”‚  â”œâ”€ SQLæ–¹è¨€
  â”‚  â””â”€ ç¼“å­˜ç­–ç•¥
  â†“
[4] åˆ›å»ºè¿æ¥æ± 
  â”‚  â””â”€ åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
  â†“
[5] æ„å»ºSessionFactory
  â”‚
  â†“
å®Œæˆï¼ˆå¯ä»¥ä½¿ç”¨äº†ï¼‰
```

### 2.3 é…ç½®æ–‡ä»¶ç¤ºä¾‹


**hibernate.cfg.xmlæ ¸å¿ƒé…ç½®**ï¼š
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-configuration PUBLIC
    "-//Hibernate/Hibernate Configuration DTD 3.0//EN"
    "http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd">
<hibernate-configuration>
    <session-factory>
        <!-- æ•°æ®åº“è¿æ¥é…ç½® -->
        <property name="connection.driver_class">com.mysql.jdbc.Driver</property>
        <property name="connection.url">jdbc:mysql://localhost:3306/mydb</property>
        <property name="connection.username">root</property>
        <property name="connection.password">123456</property>
        
        <!-- æ•°æ®åº“æ–¹è¨€ -->
        <property name="dialect">org.hibernate.dialect.MySQL5Dialect</property>
        
        <!-- è¿æ¥æ± é…ç½® -->
        <property name="c3p0.min_size">5</property>
        <property name="c3p0.max_size">20</property>
        
        <!-- æ˜ å°„æ–‡ä»¶ -->
        <mapping resource="User.hbm.xml"/>
    </session-factory>
</hibernate-configuration>
```

---

## 3. ğŸ”’ çº¿ç¨‹å®‰å…¨ç‰¹æ€§


### 3.1 ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨


**é€šä¿—è§£é‡Š**ï¼š
```
æƒ³è±¡ä¸€ä¸ªå…¬å…±å›¾ä¹¦é¦†ï¼š

âŒ ä¸å®‰å…¨çš„æƒ…å†µï¼š
å›¾ä¹¦ç®¡ç†å‘˜    å¼ ä¸‰    æå››    ç‹äº”
    â†“         â†“      â†“      â†“
  åŒæ—¶ä¿®æ”¹åŒä¸€æœ¬ä¹¦çš„ä¿¡æ¯ â†’ æ•°æ®æ··ä¹±

âœ… å®‰å…¨çš„æƒ…å†µï¼š
å›¾ä¹¦ç®¡ç†å‘˜ï¼ˆåŠ é”ï¼‰
    â†“
  å¼ ä¸‰å€Ÿä¹¦ â†’ ç­‰å¾…
  æå››è¿˜ä¹¦ â†’ æ’é˜Ÿ
  ç‹äº”æŸ¥è¯¢ â†’ ä¾æ¬¡è¿›è¡Œ
```

### 3.2 SessionFactoryçš„çº¿ç¨‹å®‰å…¨æ€§


**æ ¸å¿ƒç‰¹ç‚¹**ï¼šSessionFactoryæ˜¯**çº¿ç¨‹å®‰å…¨**çš„

```java
// å¤šä¸ªçº¿ç¨‹å¯ä»¥å®‰å…¨åœ°å…±äº«åŒä¸€ä¸ªSessionFactory
public class MultiThreadExample {
    // å…¨å±€å”¯ä¸€çš„SessionFactory
    private static SessionFactory factory;
    
    public static void main(String[] args) {
        // çº¿ç¨‹1
        new Thread(() -> {
            Session session = factory.openSession();
            // æ“ä½œæ•°æ®åº“...
            session.close();
        }).start();
        
        // çº¿ç¨‹2
        new Thread(() -> {
            Session session = factory.openSession();
            // æ“ä½œæ•°æ®åº“...
            session.close();
        }).start();
        
        // ä¸¤ä¸ªçº¿ç¨‹ä½¿ç”¨åŒä¸€ä¸ªfactoryï¼Œå®Œå…¨å®‰å…¨ï¼
    }
}
```

**ä¸ºä»€ä¹ˆçº¿ç¨‹å®‰å…¨**ï¼š
- ğŸ“Œ **ä¸å¯å˜å¯¹è±¡**ï¼šSessionFactoryåˆ›å»ºåï¼Œé…ç½®ä¿¡æ¯ä¸ä¼šæ”¹å˜
- ğŸ” **å†…éƒ¨åŒæ­¥**ï¼šå…³é”®æ“ä½œæœ‰åŒæ­¥æœºåˆ¶ä¿æŠ¤
- ğŸ¯ **æ— çŠ¶æ€è®¾è®¡**ï¼šä¸ä¿å­˜ä¼šè¯ç›¸å…³çš„çŠ¶æ€ä¿¡æ¯

### 3.3 Sessionä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„


> âš ï¸ **é‡è¦åŒºåˆ«**ï¼šSessionFactoryçº¿ç¨‹å®‰å…¨ï¼Œä½†Sessionä¸æ˜¯ï¼

```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šå¤šçº¿ç¨‹å…±äº«Session
Session session = factory.openSession();

new Thread(() -> {
    session.save(user1);  // å±é™©ï¼
}).start();

new Thread(() -> {
    session.save(user2);  // å±é™©ï¼å¯èƒ½å†²çª
}).start();

// âœ… æ­£ç¡®åšæ³•ï¼šæ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹Session
new Thread(() -> {
    Session session1 = factory.openSession();
    session1.save(user1);
    session1.close();
}).start();

new Thread(() -> {
    Session session2 = factory.openSession();
    session2.save(user2);
    session2.close();
}).start();
```

---

## 4. ğŸ¯ å•ä¾‹æ¨¡å¼åº”ç”¨


### 4.1 ä¸ºä»€ä¹ˆè¦ç”¨å•ä¾‹æ¨¡å¼


**åŸå› åˆ†æ**ï¼š
```
SessionFactoryåˆ›å»ºæˆæœ¬å¾ˆé«˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»ºSessionFactoryè€—æ—¶ï¼š â”‚
â”‚                         â”‚
â”‚ â€¢ è§£æé…ç½®æ–‡ä»¶ï¼š100ms    â”‚
â”‚ â€¢ åŠ è½½æ˜ å°„å…ƒæ•°æ®ï¼š200ms  â”‚
â”‚ â€¢ åˆå§‹åŒ–è¿æ¥æ± ï¼š300ms    â”‚
â”‚ â€¢ æ„å»ºå…¶ä»–ç»„ä»¶ï¼š400ms    â”‚
â”‚                         â”‚
â”‚ æ€»è€—æ—¶ï¼šçº¦1ç§’ï¼          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰€ä»¥ï¼š
âœ… åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºä¸€æ¬¡
âŒ ä¸è¦æ¯æ¬¡ä½¿ç”¨éƒ½åˆ›å»º
```

### 4.2 å•ä¾‹æ¨¡å¼å®ç°æ–¹å¼


**æ–¹å¼ä¸€ï¼šé¥¿æ±‰å¼ï¼ˆæ¨èï¼‰**
```java
public class HibernateUtil {
    // ç±»åŠ è½½æ—¶å°±åˆ›å»ºï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
    private static final SessionFactory factory;
    
    static {
        try {
            // åˆå§‹åŒ–é…ç½®
            Configuration cfg = new Configuration();
            cfg.configure();
            factory = cfg.buildSessionFactory();
        } catch (Exception e) {
            throw new ExceptionInInitializerError(e);
        }
    }
    
    // è·å–SessionFactory
    public static SessionFactory getSessionFactory() {
        return factory;
    }
    
    // è·å–Sessionï¼ˆä¾¿æ·æ–¹æ³•ï¼‰
    public static Session openSession() {
        return factory.openSession();
    }
}
```

**æ–¹å¼äºŒï¼šæ‡’æ±‰å¼ï¼ˆåŒé‡æ£€æŸ¥é”ï¼‰**
```java
public class HibernateUtil {
    private static volatile SessionFactory factory;
    
    // ç§æœ‰æ„é€ å‡½æ•°
    private HibernateUtil() {}
    
    public static SessionFactory getSessionFactory() {
        if (factory == null) {  // ç¬¬ä¸€æ¬¡æ£€æŸ¥
            synchronized (HibernateUtil.class) {
                if (factory == null) {  // ç¬¬äºŒæ¬¡æ£€æŸ¥
                    Configuration cfg = new Configuration();
                    cfg.configure();
                    factory = cfg.buildSessionFactory();
                }
            }
        }
        return factory;
    }
}
```

### 4.3 ä½¿ç”¨ç¤ºä¾‹


```java
// åº”ç”¨ä¸­ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è¿™æ ·ä½¿ç”¨
public class UserDao {
    public void saveUser(User user) {
        // è·å–SessionFactoryï¼ˆå…¨å±€å”¯ä¸€ï¼‰
        SessionFactory factory = HibernateUtil.getSessionFactory();
        
        // åˆ›å»ºSession
        Session session = factory.openSession();
        Transaction tx = session.beginTransaction();
        
        try {
            session.save(user);
            tx.commit();
        } catch (Exception e) {
            tx.rollback();
        } finally {
            session.close();
        }
    }
}
```

---

## 5. â±ï¸ ç”Ÿå‘½å‘¨æœŸç®¡ç†


### 5.1 SessionFactoryçš„ç”Ÿå‘½å‘¨æœŸ


**å®Œæ•´ç”Ÿå‘½å‘¨æœŸå›¾**ï¼š
```
åº”ç”¨å¯åŠ¨
   â”‚
   â†“
[åˆ›å»º] SessionFactory.build()
   â”‚  â”œâ”€ åŠ è½½é…ç½®
   â”‚  â”œâ”€ è§£ææ˜ å°„
   â”‚  â””â”€ åˆå§‹åŒ–è¿æ¥æ± 
   â†“
[è¿è¡Œ] æŒç»­æä¾›Session
   â”‚  â”œâ”€ openSession() â†’ åˆ›å»ºSession1
   â”‚  â”œâ”€ openSession() â†’ åˆ›å»ºSession2
   â”‚  â””â”€ openSession() â†’ åˆ›å»ºSession3...
   â†“
[é”€æ¯] factory.close()
   â”‚  â”œâ”€ å…³é—­è¿æ¥æ± 
   â”‚  â”œâ”€ é‡Šæ”¾ç¼“å­˜
   â”‚  â””â”€ æ¸…ç†èµ„æº
   â†“
åº”ç”¨å…³é—­
```

### 5.2 ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ€ä½³å®è·µ


**æ–¹æ¡ˆä¸€ï¼šæ‰‹åŠ¨ç®¡ç†**
```java
public class Application {
    private static SessionFactory factory;
    
    public static void main(String[] args) {
        try {
            // 1. åº”ç”¨å¯åŠ¨æ—¶åˆ›å»º
            factory = new Configuration()
                .configure()
                .buildSessionFactory();
            
            // 2. åº”ç”¨è¿è¡ŒæœŸé—´ä½¿ç”¨
            doBusinessLogic();
            
        } finally {
            // 3. åº”ç”¨å…³é—­æ—¶é”€æ¯
            if (factory != null) {
                factory.close();
            }
        }
    }
}
```

**æ–¹æ¡ˆäºŒï¼šä½¿ç”¨å…³é—­é’©å­**
```java
public class HibernateUtil {
    private static final SessionFactory factory;
    
    static {
        factory = new Configuration()
            .configure()
            .buildSessionFactory();
        
        // æ³¨å†Œå…³é—­é’©å­ï¼ˆJVMé€€å‡ºæ—¶è‡ªåŠ¨æ‰§è¡Œï¼‰
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            if (factory != null) {
                factory.close();
                System.out.println("SessionFactoryå·²å…³é—­");
            }
        }));
    }
}
```

### 5.3 Webåº”ç”¨ä¸­çš„ç®¡ç†


**åœ¨Servletä¸­ç®¡ç†**ï¼š
```java
public class HibernateListener implements ServletContextListener {
    
    @Override
    public void contextInitialized(ServletContextEvent sce) {
        // Webåº”ç”¨å¯åŠ¨æ—¶åˆ›å»º
        SessionFactory factory = new Configuration()
            .configure()
            .buildSessionFactory();
        
        // å­˜å…¥ServletContext
        sce.getServletContext()
           .setAttribute("sessionFactory", factory);
    }
    
    @Override
    public void contextDestroyed(ServletContextEvent sce) {
        // Webåº”ç”¨å…³é—­æ—¶é”€æ¯
        SessionFactory factory = (SessionFactory) sce
            .getServletContext()
            .getAttribute("sessionFactory");
        
        if (factory != null) {
            factory.close();
        }
    }
}
```

---

## 6. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 6.1 è¿æ¥æ± ä¼˜åŒ–


**C3P0è¿æ¥æ± é…ç½®**ï¼š
```xml
<property name="hibernate.c3p0.min_size">5</property>
<property name="hibernate.c3p0.max_size">20</property>
<property name="hibernate.c3p0.timeout">300</property>
<property name="hibernate.c3p0.max_statements">50</property>
<property name="hibernate.c3p0.idle_test_period">3000</property>
```

**å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | å«ä¹‰ | æ¨èå€¼ | ä½œç”¨ |
|------|------|--------|------|
| `min_size` | æœ€å°è¿æ¥æ•° | 5-10 | ä¿æŒåŸºæœ¬è¿æ¥ï¼Œé¿å…é¢‘ç¹åˆ›å»º |
| `max_size` | æœ€å¤§è¿æ¥æ•° | 20-50 | æ§åˆ¶æœ€å¤§å¹¶å‘ï¼Œé˜²æ­¢èµ„æºè€—å°½ |
| `timeout` | è¿æ¥è¶…æ—¶(ç§’) | 300 | é—²ç½®è¿æ¥è¶…æ—¶å›æ”¶ |
| `max_statements` | ç¼“å­˜è¯­å¥æ•° | 50-100 | æé«˜SQLæ‰§è¡Œæ•ˆç‡ |
| `idle_test_period` | æ£€æµ‹é—´éš”(ms) | 3000 | å®šæœŸæ£€æµ‹è¿æ¥æœ‰æ•ˆæ€§ |

### 6.2 äºŒçº§ç¼“å­˜é…ç½®


**å¯ç”¨äºŒçº§ç¼“å­˜**ï¼š
```xml
<!-- å¼€å¯äºŒçº§ç¼“å­˜ -->
<property name="hibernate.cache.use_second_level_cache">true</property>

<!-- é€‰æ‹©ç¼“å­˜å®ç°ï¼ˆEhCacheï¼‰ -->
<property name="hibernate.cache.region.factory_class">
    org.hibernate.cache.ehcache.EhCacheRegionFactory
</property>

<!-- æŸ¥è¯¢ç¼“å­˜ -->
<property name="hibernate.cache.use_query_cache">true</property>
```

**ç¼“å­˜å±‚æ¬¡å›¾**ï¼š
```
è¯·æ±‚æ•°æ®
   â”‚
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸€çº§ç¼“å­˜(Session) â”‚ â† é»˜è®¤å¼€å¯ï¼ŒSessionçº§åˆ«
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ miss
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äºŒçº§ç¼“å­˜(Factory)â”‚ â† éœ€é…ç½®ï¼Œåº”ç”¨çº§åˆ«
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ miss
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“æŸ¥è¯¢   â”‚ â† æœ€åæ‰æŸ¥æ•°æ®åº“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 æ‰¹å¤„ç†ä¼˜åŒ–


```java
// æ‰¹é‡æ’å…¥ä¼˜åŒ–
Session session = factory.openSession();
Transaction tx = session.beginTransaction();

for (int i = 0; i < 10000; i++) {
    User user = new User("user" + i);
    session.save(user);
    
    // æ¯50æ¡flushä¸€æ¬¡ï¼ˆé‡Šæ”¾å†…å­˜ï¼‰
    if (i % 50 == 0) {
        session.flush();
        session.clear();
    }
}

tx.commit();
session.close();
```

---

## 7. ğŸ”š èµ„æºé‡Šæ”¾ä¸å…³é—­


### 7.1 å…³é—­SessionFactoryçš„é‡è¦æ€§


> âš ï¸ **ä¸ºä»€ä¹ˆå¿…é¡»å…³é—­**ï¼š

```
ä¸å…³é—­SessionFactoryçš„åæœï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ•°æ®åº“è¿æ¥ä¸é‡Šæ”¾  â”‚ â†’ è¿æ¥æ± è€—å°½
â”‚ 2. å†…å­˜ä¸å›æ”¶        â”‚ â†’ å†…å­˜æ³„æ¼
â”‚ 3. çº¿ç¨‹ä¸ç»ˆæ­¢        â”‚ â†’ åº”ç”¨æ— æ³•æ­£å¸¸é€€å‡º
â”‚ 4. é”èµ„æºä¸é‡Šæ”¾      â”‚ â†’ å½±å“å…¶ä»–åº”ç”¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ­£ç¡®çš„å…³é—­æ–¹å¼


**æ ‡å‡†å…³é—­æµç¨‹**ï¼š
```java
SessionFactory factory = null;
try {
    // 1. åˆ›å»ºSessionFactory
    factory = new Configuration()
        .configure()
        .buildSessionFactory();
    
    // 2. ä½¿ç”¨SessionFactory
    // ...ä¸šåŠ¡é€»è¾‘...
    
} catch (Exception e) {
    e.printStackTrace();
} finally {
    // 3. å…³é—­SessionFactory
    if (factory != null && !factory.isClosed()) {
        factory.close();
        System.out.println("SessionFactoryå·²å…³é—­");
    }
}
```

### 7.3 ä½¿ç”¨try-with-resources


**Java 7+çš„ä¼˜é›…æ–¹å¼**ï¼š
```java
// SessionFactoryå®ç°äº†AutoCloseableæ¥å£
try (SessionFactory factory = new Configuration()
        .configure()
        .buildSessionFactory()) {
    
    // ä½¿ç”¨factory...
    Session session = factory.openSession();
    // ...
    
} // è‡ªåŠ¨å…³é—­ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨close()
```

### 7.4 å…³é—­æ£€æŸ¥æ¸…å•


**å…³é—­å‰æ£€æŸ¥**ï¼š
```java
public class ShutdownHelper {
    
    public static void safeClose(SessionFactory factory) {
        if (factory == null) {
            System.out.println("SessionFactoryä¸ºnullï¼Œæ— éœ€å…³é—­");
            return;
        }
        
        if (factory.isClosed()) {
            System.out.println("SessionFactoryå·²å…³é—­");
            return;
        }
        
        // æ‰§è¡Œå…³é—­
        try {
            factory.close();
            System.out.println("âœ… SessionFactoryå…³é—­æˆåŠŸ");
        } catch (Exception e) {
            System.err.println("âŒ å…³é—­å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


```
ğŸ”¸ SessionFactoryæœ¬è´¨ï¼šç”Ÿäº§Sessionçš„é‡é‡çº§å·¥å‚
ğŸ”¸ åˆ›å»ºæ—¶æœºï¼šåº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºä¸€æ¬¡ï¼Œå…¨å±€å…±äº«
ğŸ”¸ çº¿ç¨‹å®‰å…¨æ€§ï¼šSessionFactoryçº¿ç¨‹å®‰å…¨ï¼ŒSessionä¸å®‰å…¨
ğŸ”¸ å•ä¾‹æ¨¡å¼ï¼šä½¿ç”¨å•ä¾‹ä¿è¯å…¨å±€å”¯ä¸€
ğŸ”¸ ç”Ÿå‘½å‘¨æœŸï¼šéšåº”ç”¨å¯åŠ¨åˆ›å»ºï¼Œéšåº”ç”¨å…³é—­é”€æ¯
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šè¿æ¥æ± ã€äºŒçº§ç¼“å­˜ã€æ‰¹å¤„ç†
ğŸ”¸ èµ„æºç®¡ç†ï¼šå¿…é¡»æ­£ç¡®å…³é—­ï¼Œé‡Šæ”¾èµ„æº
```

### 8.2 å…³é”®å¯¹æ¯”ç†è§£


**SessionFactory vs Session**ï¼š

| ç‰¹æ€§ | SessionFactory | Session |
|------|---------------|---------|
| **åˆ›å»ºæˆæœ¬** | é‡é‡çº§ï¼Œè€—æ—¶é•¿ | è½»é‡çº§ï¼Œå¿«é€Ÿ |
| **ç”Ÿå‘½å‘¨æœŸ** | åº”ç”¨çº§ï¼Œé•¿æœŸå­˜åœ¨ | è¯·æ±‚çº§ï¼ŒçŸ­æš‚å­˜åœ¨ |
| **çº¿ç¨‹å®‰å…¨** | âœ… çº¿ç¨‹å®‰å…¨ | âŒ éçº¿ç¨‹å®‰å…¨ |
| **å®ä¾‹æ•°é‡** | å…¨å±€å”¯ä¸€ï¼ˆå•ä¾‹ï¼‰ | å¤šä¸ªå®ä¾‹ |
| **èŒè´£** | åˆ›å»ºSession | æ“ä½œæ•°æ®åº“ |

### 8.3 æœ€ä½³å®è·µå»ºè®®


**âœ… æ¨èåšæ³•**ï¼š
- ä½¿ç”¨å•ä¾‹æ¨¡å¼ç®¡ç†SessionFactory
- åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºï¼Œå…³é—­æ—¶é”€æ¯
- é…ç½®åˆé€‚çš„è¿æ¥æ± å‚æ•°
- å¯ç”¨äºŒçº§ç¼“å­˜æå‡æ€§èƒ½
- ä½¿ç”¨å…³é—­é’©å­è‡ªåŠ¨æ¸…ç†èµ„æº

**âŒ é¿å…é”™è¯¯**ï¼š
- ä¸è¦é‡å¤åˆ›å»ºSessionFactory
- ä¸è¦è·¨çº¿ç¨‹å…±äº«Session
- ä¸è¦å¿˜è®°å…³é—­SessionFactory
- ä¸è¦åœ¨Sessionä¸­æ‰§è¡Œé•¿æ—¶é—´æ“ä½œ
- ä¸è¦æ»¥ç”¨äºŒçº§ç¼“å­˜

### 8.4 å®é™…åº”ç”¨åœºæ™¯


**Webåº”ç”¨ä¸­çš„å…¸å‹æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Webå®¹å™¨å¯åŠ¨             â”‚
â”‚  (ServletContextListeneråˆå§‹åŒ–)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
        åˆ›å»ºSessionFactoryï¼ˆå…¨å±€å”¯ä¸€ï¼‰
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å¤„ç†ç”¨æˆ·è¯·æ±‚             â”‚
â”‚  Servlet/Controller â†’ DAO        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
        è·å–Session â†’ æ“ä½œæ•°æ®åº“
                 â†“
             å…³é—­Session
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Webå®¹å™¨å…³é—­             â”‚
â”‚   (contextDestroyedè§¦å‘)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
        å…³é—­SessionFactory
```

### 8.5 è®°å¿†å£è¯€


> ğŸ§  **SessionFactoryè®°å¿†æ³•**ï¼š
> 
> - **ä¸€ç”Ÿä¸€ä¸–**ï¼šåº”ç”¨ä¸€ç”Ÿåªåˆ›å»ºä¸€æ¬¡
> - **å·¥å‚æ¨¡å¼**ï¼šä¸“é—¨ç”Ÿäº§Sessionçš„å·¥å‚
> - **çº¿ç¨‹å®‰å…¨**ï¼šå¤šçº¿ç¨‹å…±äº«æ— éœ€æ‹…å¿ƒ
> - **å•ä¾‹ç®¡ç†**ï¼šå…¨å±€å”¯ä¸€ä¸é‡å¤é€ 
> - **æ­£ç¡®å…³é—­**ï¼šåº”ç”¨ç»“æŸå¿…é¡»å…³

**æ ¸å¿ƒç†å¿µ**ï¼š
- SessionFactoryæ˜¯é‡é‡çº§èµ„æºï¼Œåˆ›å»ºæˆæœ¬é«˜ï¼Œè¦çæƒœä½¿ç”¨
- å•ä¾‹æ¨¡å¼ä¿è¯å…¨å±€å”¯ä¸€ï¼Œé¿å…èµ„æºæµªè´¹
- çº¿ç¨‹å®‰å…¨ç‰¹æ€§å…è®¸å¤šçº¿ç¨‹å…±äº«ï¼Œç®€åŒ–å¼€å‘
- åˆç†é…ç½®å’Œä¼˜åŒ–ï¼Œå‘æŒ¥æœ€å¤§æ€§èƒ½
- æ­£ç¡®ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œé¿å…èµ„æºæ³„æ¼