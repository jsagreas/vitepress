---
title: 15ã€çº§è”æ“ä½œä¸ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [çº§è”æ“ä½œæ˜¯ä»€ä¹ˆ](#1-çº§è”æ“ä½œæ˜¯ä»€ä¹ˆ)
2. [CascadeTypeç±»å‹è¯¦è§£](#2-CascadeTypeç±»å‹è¯¦è§£)
3. [å„ç§çº§è”æ“ä½œå®æˆ˜](#3-å„ç§çº§è”æ“ä½œå®æˆ˜)
4. [çº§è”é™·é˜±ä¸æ³¨æ„äº‹é¡¹](#4-çº§è”é™·é˜±ä¸æ³¨æ„äº‹é¡¹)
5. [æ€§èƒ½å½±å“åˆ†æ](#5-æ€§èƒ½å½±å“åˆ†æ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ çº§è”æ“ä½œæ˜¯ä»€ä¹ˆ


### 1.1 ä»€ä¹ˆæ˜¯çº§è”æ“ä½œ


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ æ˜¯å…¬å¸è€æ¿ï¼Œå½“ä½ å†³å®šæ¬å®¶æ—¶ï¼Œä½ çš„å‘˜å·¥ä¹Ÿè·Ÿç€æ¬ã€‚è¿™å°±æ˜¯"çº§è”"çš„æ¦‚å¿µã€‚

åœ¨Hibernateä¸­ï¼š
- **ä½ ï¼ˆçˆ¶å¯¹è±¡ï¼‰** åšäº†æŸä¸ªæ“ä½œ
- **ä½ çš„å‘˜å·¥ï¼ˆå­å¯¹è±¡ï¼‰** è‡ªåŠ¨è·Ÿç€åšç›¸åŒæ“ä½œ
- ä¸éœ€è¦ä½ æ‰‹åŠ¨å»å¤„ç†æ¯ä¸ªå‘˜å·¥

```
ç°å®åœºæ™¯ç±»æ¯”ï¼š

åˆ é™¤éƒ¨é—¨ â†’ è‡ªåŠ¨åˆ é™¤éƒ¨é—¨ä¸‹æ‰€æœ‰å‘˜å·¥
ä¿å­˜è®¢å• â†’ è‡ªåŠ¨ä¿å­˜è®¢å•ä¸­çš„æ‰€æœ‰å•†å“
æ›´æ–°ç­çº§ â†’ è‡ªåŠ¨æ›´æ–°ç­çº§ä¸­çš„æ‰€æœ‰å­¦ç”Ÿ
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦çº§è”æ“ä½œ


**é—®é¢˜åœºæ™¯**ï¼šä¸ä½¿ç”¨çº§è”æ—¶çš„éº»çƒ¦
```java
// ä¿å­˜ä¸€ä¸ªè®¢å•å’Œå®ƒçš„è®¢å•é¡¹
Order order = new Order();
OrderItem item1 = new OrderItem();
OrderItem item2 = new OrderItem();

// ğŸ˜« å¿…é¡»ä¸€ä¸ªä¸ªæ‰‹åŠ¨ä¿å­˜
session.save(order);      // å…ˆä¿å­˜è®¢å•
session.save(item1);      // å†ä¿å­˜è®¢å•é¡¹1
session.save(item2);      // å†ä¿å­˜è®¢å•é¡¹2
```

**ä½¿ç”¨çº§è”åçš„ä¾¿åˆ©**ï¼š
```java
// ğŸ˜Š åªéœ€ä¿å­˜è®¢å•ï¼Œè®¢å•é¡¹è‡ªåŠ¨ä¿å­˜
Order order = new Order();
order.addItem(new OrderItem());
order.addItem(new OrderItem());

session.save(order);  // ä¸€æ¡è¯­å¥æå®šï¼
```

### 1.3 çº§è”æ“ä½œçš„æœ¬è´¨


**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **æ“ä½œä¼ æ’­**ï¼šçˆ¶å¯¹è±¡çš„æ“ä½œä¼šä¼ æ’­åˆ°å­å¯¹è±¡
- **å…³ç³»ç»‘å®š**ï¼šåŸºäºå¯¹è±¡ä¹‹é—´çš„å…³è”å…³ç³»
- **è‡ªåŠ¨åŒ–ç®¡ç†**ï¼šå‡å°‘é‡å¤ä»£ç ï¼Œæé«˜å¼€å‘æ•ˆç‡

**çº§è”æµç¨‹å›¾ç¤º**ï¼š
```
çˆ¶å¯¹è±¡æ“ä½œ          çº§è”ä¼ æ’­          å­å¯¹è±¡è‡ªåŠ¨æ“ä½œ
   |                  |                    |
[ä¿å­˜è®¢å•] -------> [æ£€æµ‹çº§è”é…ç½®] -----> [ä¿å­˜æ‰€æœ‰è®¢å•é¡¹]
   |                  |                    |
[åˆ é™¤éƒ¨é—¨] -------> [æ£€æµ‹çº§è”é…ç½®] -----> [åˆ é™¤æ‰€æœ‰å‘˜å·¥]
   |                  |                    |
[æ›´æ–°ç­çº§] -------> [æ£€æµ‹çº§è”é…ç½®] -----> [æ›´æ–°æ‰€æœ‰å­¦ç”Ÿ]
```

---

## 2. ğŸ“‹ CascadeTypeç±»å‹è¯¦è§£


### 2.1 çº§è”ç±»å‹å…¨è§ˆ


Hibernateæä¾›äº†7ç§çº§è”ç±»å‹ï¼Œæ¯ç§å¯¹åº”ä¸åŒçš„æ“ä½œåœºæ™¯ï¼š

| çº§è”ç±»å‹ | **ä½œç”¨** | **ä½¿ç”¨åœºæ™¯** |
|---------|---------|-------------|
| **PERSIST** | `ä¿å­˜æ—¶çº§è”` | æ–°å¢æ•°æ®ï¼Œçˆ¶ä¿å­˜å­ä¹Ÿä¿å­˜ |
| **MERGE** | `åˆå¹¶æ—¶çº§è”` | æ›´æ–°æ•°æ®ï¼Œçˆ¶åˆå¹¶å­ä¹Ÿåˆå¹¶ |
| **REMOVE** | `åˆ é™¤æ—¶çº§è”` | åˆ é™¤æ•°æ®ï¼Œçˆ¶åˆ é™¤å­ä¹Ÿåˆ é™¤ |
| **REFRESH** | `åˆ·æ–°æ—¶çº§è”` | ä»æ•°æ®åº“é‡æ–°åŠ è½½ï¼Œçˆ¶åˆ·æ–°å­ä¹Ÿåˆ·æ–° |
| **DETACH** | `åˆ†ç¦»æ—¶çº§è”` | è„±ç¦»æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼Œçˆ¶åˆ†ç¦»å­ä¹Ÿåˆ†ç¦» |
| **ALL** | `æ‰€æœ‰æ“ä½œçº§è”` | åŒ…å«ä¸Šè¿°æ‰€æœ‰çº§è” |
| **REPLICATE** | `å¤åˆ¶æ—¶çº§è”` | ä¸å¸¸ç”¨ï¼Œç‰¹æ®Šåœºæ™¯ |

### 2.2 çº§è”ç±»å‹å…³ç³»å›¾


```
                    CascadeType.ALL
                          |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |                 |                 |
    PERSIST           MERGE             REMOVE
        |                 |                 |
    ä¿å­˜çº§è”           åˆå¹¶çº§è”           åˆ é™¤çº§è”
        |                 |                 |
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          |
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                |                   |
            REFRESH              DETACH
                |                   |
            åˆ·æ–°çº§è”              åˆ†ç¦»çº§è”
```

---

## 3. ğŸ”§ å„ç§çº§è”æ“ä½œå®æˆ˜


### 3.1 PERSIST - ä¿å­˜çº§è”


**å«ä¹‰**ï¼šå½“ä½ ä¿å­˜çˆ¶å¯¹è±¡æ—¶ï¼Œè‡ªåŠ¨ä¿å­˜å…³è”çš„å­å¯¹è±¡

**å®ä½“é…ç½®**ï¼š
```java
@Entity
public class Department {
    @Id
    @GeneratedValue
    private Long id;
    
    private String name;
    
    // ğŸ”‘ å…³é”®é…ç½®ï¼šcascade = CascadeType.PERSIST
    @OneToMany(mappedBy = "department", cascade = CascadeType.PERSIST)
    private List<Employee> employees = new ArrayList<>();
    
    // ä¾¿æ·æ–¹æ³•ï¼šæ·»åŠ å‘˜å·¥
    public void addEmployee(Employee emp) {
        employees.add(emp);
        emp.setDepartment(this);
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// åˆ›å»ºéƒ¨é—¨å’Œå‘˜å·¥
Department dept = new Department();
dept.setName("ç ”å‘éƒ¨");

Employee emp1 = new Employee();
emp1.setName("å¼ ä¸‰");

Employee emp2 = new Employee();
emp2.setName("æå››");

// å»ºç«‹å…³ç³»
dept.addEmployee(emp1);
dept.addEmployee(emp2);

// âœ… åªéœ€ä¿å­˜éƒ¨é—¨ï¼Œå‘˜å·¥è‡ªåŠ¨ä¿å­˜
session.save(dept);  

// ğŸ’¾ æ‰§è¡Œçš„SQLï¼š
// INSERT INTO department...
// INSERT INTO employee... (å¼ ä¸‰)
// INSERT INTO employee... (æå››)
```

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
- åªåœ¨`session.save()`æˆ–`session.persist()`æ—¶ç”Ÿæ•ˆ
- å­å¯¹è±¡å¿…é¡»æ˜¯**ç¬æ—¶çŠ¶æ€**ï¼ˆæ–°å»ºçš„ï¼Œæ²¡ä¿å­˜è¿‡çš„ï¼‰
- å¦‚æœå­å¯¹è±¡å·²å­˜åœ¨äºæ•°æ®åº“ï¼Œä¼šæŠ¥é”™

### 3.2 MERGE - åˆå¹¶çº§è”


**å«ä¹‰**ï¼šå½“ä½ æ›´æ–°çˆ¶å¯¹è±¡æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°å…³è”çš„å­å¯¹è±¡

**å®ä½“é…ç½®**ï¼š
```java
@Entity
public class Order {
    @Id
    @GeneratedValue
    private Long id;
    
    private String orderNo;
    
    // ğŸ”‘ é…ç½®åˆå¹¶çº§è”
    @OneToMany(mappedBy = "order", cascade = CascadeType.MERGE)
    private List<OrderItem> items = new ArrayList<>();
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// ä»æ•°æ®åº“æŸ¥è¯¢è®¢å•ï¼ˆæŒä¹…åŒ–çŠ¶æ€ï¼‰
Order order = session.get(Order.class, 1L);

// ä¿®æ”¹è®¢å•ä¿¡æ¯
order.setOrderNo("NEW-001");

// ä¿®æ”¹è®¢å•é¡¹ä¿¡æ¯
OrderItem item = order.getItems().get(0);
item.setQuantity(10);

// âœ… åªéœ€åˆå¹¶è®¢å•ï¼Œè®¢å•é¡¹è‡ªåŠ¨æ›´æ–°
session.merge(order);

// ğŸ’¾ æ‰§è¡Œçš„SQLï¼š
// UPDATE orders SET order_no = 'NEW-001'...
// UPDATE order_items SET quantity = 10...
```

**mergeä¸persistçš„åŒºåˆ«**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ“ä½œ      â”‚    PERSIST     â”‚     MERGE      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é’ˆå¯¹å¯¹è±¡    â”‚   æ–°å»ºå¯¹è±¡     â”‚  å·²å­˜åœ¨å¯¹è±¡    â”‚
â”‚ ä¸»è¦ç”¨é€”    â”‚   æ’å…¥æ•°æ®     â”‚  æ›´æ–°æ•°æ®      â”‚
â”‚ å¯¹è±¡çŠ¶æ€    â”‚   ç¬æ—¶â†’æŒä¹…åŒ–  â”‚  æ¸¸ç¦»â†’æŒä¹…åŒ–   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 REMOVE - åˆ é™¤çº§è”


**å«ä¹‰**ï¼šåˆ é™¤çˆ¶å¯¹è±¡æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤å…³è”çš„å­å¯¹è±¡

**âš ï¸ å±é™©æ“ä½œ**ï¼šè¿™æ˜¯æœ€å±é™©çš„çº§è”ï¼Œä½¿ç”¨éœ€è°¨æ…ï¼

**å®ä½“é…ç½®**ï¼š
```java
@Entity
public class User {
    @Id
    @GeneratedValue
    private Long id;
    
    private String username;
    
    // ğŸ”‘ é…ç½®åˆ é™¤çº§è”
    @OneToMany(mappedBy = "user", cascade = CascadeType.REMOVE)
    private List<Post> posts = new ArrayList<>();
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// æŸ¥è¯¢ç”¨æˆ·
User user = session.get(User.class, 1L);

// âœ… åˆ é™¤ç”¨æˆ·ï¼Œè‡ªåŠ¨åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰å¸–å­
session.remove(user);

// ğŸ’¾ æ‰§è¡Œçš„SQLï¼š
// DELETE FROM posts WHERE user_id = 1
// DELETE FROM users WHERE id = 1
```

**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š
- âœ… **å¼ºä¾èµ–å…³ç³»**ï¼šè®¢å•-è®¢å•é¡¹ï¼ˆåˆ è®¢å•å¿…åˆ è®¢å•é¡¹ï¼‰
- âœ… **ä»å±å…³ç³»**ï¼šåšå®¢æ–‡ç« -è¯„è®ºï¼ˆåˆ æ–‡ç« å¯åˆ è¯„è®ºï¼‰
- âŒ **ç‹¬ç«‹å…³ç³»**ï¼šéƒ¨é—¨-å‘˜å·¥ï¼ˆåˆ éƒ¨é—¨ä¸åº”åˆ å‘˜å·¥ï¼ï¼‰

### 3.4 REFRESH - åˆ·æ–°çº§è”


**å«ä¹‰**ï¼šä»æ•°æ®åº“é‡æ–°åŠ è½½çˆ¶å¯¹è±¡æ—¶ï¼ŒåŒæ—¶é‡æ–°åŠ è½½å­å¯¹è±¡

**ä½¿ç”¨åœºæ™¯**ï¼šå½“æ€€ç–‘å†…å­˜ä¸­çš„æ•°æ®è¿‡æœŸï¼Œéœ€è¦ä»æ•°æ®åº“è·å–æœ€æ–°æ•°æ®

**å®ä½“é…ç½®**ï¼š
```java
@Entity
public class Product {
    @Id
    private Long id;
    
    private String name;
    private BigDecimal price;
    
    // ğŸ”‘ é…ç½®åˆ·æ–°çº§è”
    @OneToMany(mappedBy = "product", cascade = CascadeType.REFRESH)
    private List<ProductImage> images = new ArrayList<>();
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// åœºæ™¯ï¼šå¤šä¸ªç”¨æˆ·åŒæ—¶æ“ä½œåŒä¸€å•†å“
Product product = session.get(Product.class, 1L);
System.out.println("ä»·æ ¼ï¼š" + product.getPrice());  // 100å…ƒ

// æ­¤æ—¶å¦ä¸€ä¸ªç”¨æˆ·ä¿®æ”¹äº†æ•°æ®åº“ä¸­çš„ä»·æ ¼ä¸º200å…ƒ

// âœ… åˆ·æ–°å•†å“ï¼Œå›¾ç‰‡ä¿¡æ¯ä¹Ÿä¸€èµ·åˆ·æ–°
session.refresh(product);
System.out.println("ä»·æ ¼ï¼š" + product.getPrice());  // 200å…ƒï¼ˆæœ€æ–°ï¼‰

// ğŸ’¾ æ‰§è¡Œçš„SQLï¼š
// SELECT * FROM products WHERE id = 1
// SELECT * FROM product_images WHERE product_id = 1
```

### 3.5 DETACH - åˆ†ç¦»çº§è”


**å«ä¹‰**ï¼šå°†çˆ¶å¯¹è±¡ä»æŒä¹…åŒ–ä¸Šä¸‹æ–‡ä¸­åˆ†ç¦»æ—¶ï¼Œå­å¯¹è±¡ä¹Ÿä¸€èµ·åˆ†ç¦»

**ä»€ä¹ˆæ˜¯åˆ†ç¦»**ï¼š
```
æŒä¹…åŒ–çŠ¶æ€    â†’   æ¸¸ç¦»çŠ¶æ€
(è¢«Sessionç®¡ç†)   (ä¸è¢«ç®¡ç†ï¼Œä½†æ•°æ®åº“æœ‰è®°å½•)

åˆ†ç¦»åçš„å¯¹è±¡ï¼š
- ä¸å†è‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“
- ä¸èƒ½ä½¿ç”¨æ‡’åŠ è½½
- éœ€è¦é‡æ–°attachæ‰èƒ½æ“ä½œ
```

**å®ä½“é…ç½®**ï¼š
```java
@Entity
public class Course {
    @Id
    private Long id;
    
    private String name;
    
    // ğŸ”‘ é…ç½®åˆ†ç¦»çº§è”
    @OneToMany(mappedBy = "course", cascade = CascadeType.DETACH)
    private List<Student> students = new ArrayList<>();
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
Course course = session.get(Course.class, 1L);  // æŒä¹…åŒ–çŠ¶æ€

// ä¿®æ”¹è¯¾ç¨‹åç§°
course.setName("é«˜çº§Java");  // ä¼šè‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“

// âœ… åˆ†ç¦»è¯¾ç¨‹ï¼Œå­¦ç”Ÿä¹Ÿä¸€èµ·åˆ†ç¦»
session.detach(course);

// æ­¤æ—¶å†ä¿®æ”¹ï¼Œä¸ä¼šåŒæ­¥åˆ°æ•°æ®åº“
course.setName("Javaå…¥é—¨");  // âŒ ä¸ä¼šä¿å­˜
```

### 3.6 ALL - å…¨éƒ¨çº§è”


**å«ä¹‰**ï¼šåŒ…å«æ‰€æœ‰çº§è”ç±»å‹ï¼Œçˆ¶å¯¹è±¡çš„ä»»ä½•æ“ä½œéƒ½ä¼šçº§è”åˆ°å­å¯¹è±¡

**å®ä½“é…ç½®**ï¼š
```java
@Entity
public class ShoppingCart {
    @Id
    private Long id;
    
    private String userName;
    
    // ğŸ”‘ é…ç½®å…¨éƒ¨çº§è”
    @OneToMany(mappedBy = "cart", cascade = CascadeType.ALL)
    private List<CartItem> items = new ArrayList<>();
    
    public void addItem(CartItem item) {
        items.add(item);
        item.setCart(this);
    }
}
```

**ç›¸å½“äº**ï¼š
```java
cascade = {
    CascadeType.PERSIST,   // ä¿å­˜çº§è”
    CascadeType.MERGE,     // åˆå¹¶çº§è”
    CascadeType.REMOVE,    // åˆ é™¤çº§è”
    CascadeType.REFRESH,   // åˆ·æ–°çº§è”
    CascadeType.DETACH     // åˆ†ç¦»çº§è”
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
ShoppingCart cart = new ShoppingCart();
cart.setUserName("å¼ ä¸‰");

cart.addItem(new CartItem("å•†å“A", 2));
cart.addItem(new CartItem("å•†å“B", 1));

// âœ… ä¿å­˜è´­ç‰©è½¦ï¼Œè´­ç‰©é¡¹è‡ªåŠ¨ä¿å­˜
session.save(cart);

// âœ… åˆ é™¤è´­ç‰©è½¦ï¼Œè´­ç‰©é¡¹è‡ªåŠ¨åˆ é™¤
session.remove(cart);

// âœ… åˆ·æ–°è´­ç‰©è½¦ï¼Œè´­ç‰©é¡¹è‡ªåŠ¨åˆ·æ–°
session.refresh(cart);
```

### 3.7 å¤šä¸ªçº§è”ç±»å‹ç»„åˆ


**å¯ä»¥é…ç½®å¤šä¸ªçº§è”ç±»å‹**ï¼š
```java
@Entity
public class Blog {
    @Id
    private Long id;
    
    private String title;
    
    // ğŸ”‘ åªé…ç½®ä¿å­˜å’Œåˆå¹¶çº§è”ï¼Œä¸é…ç½®åˆ é™¤
    @OneToMany(
        mappedBy = "blog",
        cascade = {CascadeType.PERSIST, CascadeType.MERGE}
    )
    private List<Comment> comments = new ArrayList<>();
}
```

**æ•ˆæœå¯¹æ¯”**ï¼š
```java
Blog blog = new Blog();
blog.addComment(new Comment("å¥½æ–‡ç« "));

// âœ… ä¿å­˜åšå®¢ï¼Œè¯„è®ºè‡ªåŠ¨ä¿å­˜ï¼ˆæœ‰PERSISTçº§è”ï¼‰
session.save(blog);

// âœ… æ›´æ–°åšå®¢ï¼Œè¯„è®ºè‡ªåŠ¨æ›´æ–°ï¼ˆæœ‰MERGEçº§è”ï¼‰
session.merge(blog);

// âŒ åˆ é™¤åšå®¢ï¼Œè¯„è®ºä¸ä¼šåˆ é™¤ï¼ˆæ²¡æœ‰REMOVEçº§è”ï¼‰
session.remove(blog);  // åªåˆ é™¤åšå®¢ï¼Œè¯„è®ºä¿ç•™
```

---

## 4. âš ï¸ çº§è”é™·é˜±ä¸æ³¨æ„äº‹é¡¹


### 4.1 å¸¸è§é™·é˜±


**é™·é˜±1ï¼šREMOVEçº§è”å¯¼è‡´è¯¯åˆ æ•°æ®**

```java
// ğŸ˜± å±é™©é…ç½®
@Entity
public class Department {
    @OneToMany(cascade = CascadeType.ALL)  // åŒ…å«REMOVE
    private List<Employee> employees;
}

// åˆ é™¤éƒ¨é—¨
Department dept = session.get(Department.class, 1L);
session.remove(dept);  
// ğŸ’€ æ‰€æœ‰å‘˜å·¥éƒ½è¢«åˆ é™¤äº†ï¼å¯èƒ½åªæ˜¯æƒ³è§£æ•£éƒ¨é—¨
```

**æ­£ç¡®åšæ³•**ï¼š
```java
// ğŸ˜Š å®‰å…¨é…ç½®
@Entity
public class Department {
    @OneToMany(
        cascade = {CascadeType.PERSIST, CascadeType.MERGE}  // ä¸åŒ…å«REMOVE
    )
    private List<Employee> employees;
}

// åˆ é™¤éƒ¨é—¨å‰ï¼Œå…ˆè§£é™¤å‘˜å·¥å…³ç³»
Department dept = session.get(Department.class, 1L);
for (Employee emp : dept.getEmployees()) {
    emp.setDepartment(null);  // è§£é™¤å…³ç³»
}
session.remove(dept);  // åªåˆ é™¤éƒ¨é—¨
```

**é™·é˜±2ï¼šçº§è”å¯¼è‡´çš„å¾ªç¯æ“ä½œ**

```java
// ğŸ˜± åŒå‘çº§è”å¯èƒ½å¯¼è‡´æ— é™å¾ªç¯
@Entity
public class User {
    @ManyToMany(cascade = CascadeType.ALL)
    private List<Role> roles;
}

@Entity  
public class Role {
    @ManyToMany(cascade = CascadeType.ALL)  // åŒå‘éƒ½é…ç½®çº§è”
    private List<User> users;
}

// ğŸ’€ å¯èƒ½å¯¼è‡´ï¼š
// ä¿å­˜User â†’ çº§è”ä¿å­˜Role â†’ çº§è”ä¿å­˜User â†’ çº§è”ä¿å­˜Role â†’ ...
```

**æ­£ç¡®åšæ³•**ï¼š
```java
// ğŸ˜Š åªåœ¨ä¸€æ–¹é…ç½®çº§è”
@Entity
public class User {
    @ManyToMany(cascade = {CascadeType.PERSIST, CascadeType.MERGE})
    private List<Role> roles;
}

@Entity
public class Role {
    @ManyToMany  // ä¸é…ç½®çº§è”
    private List<User> users;
}
```

### 4.2 ä½¿ç”¨å»ºè®®


**âœ… æ¨èåšæ³•**ï¼š

1. **å¼ºä¾èµ–å…³ç³»ä½¿ç”¨çº§è”**
   - è®¢å• â†’ è®¢å•é¡¹ï¼ˆALLçº§è”ï¼‰
   - åšå®¢æ–‡ç«  â†’ è¯„è®ºï¼ˆPERSISTã€MERGEçº§è”ï¼‰

2. **ç‹¬ç«‹å®ä½“é¿å…çº§è”**
   - éƒ¨é—¨ â†’ å‘˜å·¥ï¼ˆä¸ç”¨çº§è”ï¼‰
   - å­¦ç”Ÿ â†’ è¯¾ç¨‹ï¼ˆä¸ç”¨çº§è”ï¼‰

3. **çº§è”é…ç½®ä¼˜å…ˆçº§**
   ```
   å¸¸ç”¨ï¼šPERSIST + MERGE
   è°¨æ…ï¼šREMOVE
   å°‘ç”¨ï¼šREFRESHã€DETACH
   ```

**âŒ é¿å…åšæ³•**ï¼š

1. **å¤šå¯¹å¤šå…³ç³»é¿å…REMOVEçº§è”**
2. **åŒå‘å…³ç³»é¿å…åŒå‘çº§è”**
3. **ä¸ç¡®å®šæ—¶ï¼Œä¸é…ç½®çº§è”**

### 4.3 çº§è”é…ç½®å†³ç­–æ ‘


```
æ˜¯å¦éœ€è¦çº§è”ï¼Ÿ
    |
    â”œâ”€ æ˜¯ â†’ å¯¹è±¡é—´æ˜¯å¼ºä¾èµ–å…³ç³»å—ï¼Ÿ
    |       |
    |       â”œâ”€ æ˜¯ â†’ å¯ä»¥é…ç½® PERSIST + MERGE
    |       |       |
    |       |       â””â”€ åˆ é™¤çˆ¶å¯¹è±¡å¿…é¡»åˆ é™¤å­å¯¹è±¡ï¼Ÿ
    |       |           |
    |       |           â”œâ”€ æ˜¯ â†’ åŠ ä¸Š REMOVE
    |       |           â””â”€ å¦ â†’ ä¸åŠ  REMOVE
    |       |
    |       â””â”€ å¦ â†’ ä¸é…ç½®çº§è”
    |
    â””â”€ å¦ â†’ ä¸é…ç½®çº§è”
```

---

## 5. ğŸ“Š æ€§èƒ½å½±å“åˆ†æ


### 5.1 çº§è”æ“ä½œçš„æ€§èƒ½å½±å“


**æ­£é¢å½±å“**ï¼š
- âœ… å‡å°‘ä»£ç é‡ï¼Œæé«˜å¼€å‘æ•ˆç‡
- âœ… ä¿è¯æ•°æ®ä¸€è‡´æ€§
- âœ… è‡ªåŠ¨ç®¡ç†å…³è”å…³ç³»

**è´Ÿé¢å½±å“**ï¼š
- âŒ å¯èƒ½äº§ç”Ÿå¤§é‡SQLè¯­å¥
- âŒ å¯èƒ½åŠ è½½ä¸éœ€è¦çš„æ•°æ®
- âŒ åˆ é™¤æ“ä½œé£é™©å¤§

### 5.2 æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹


**åœºæ™¯**ï¼šåˆ é™¤ä¸€ä¸ªæœ‰100ä¸ªè®¢å•é¡¹çš„è®¢å•

```java
// æ–¹å¼1ï¼šé…ç½®REMOVEçº§è”
@OneToMany(cascade = CascadeType.REMOVE)
private List<OrderItem> items;

session.remove(order);
// ğŸ’¾ æ‰§è¡Œçš„SQLï¼š
// DELETE FROM order_items WHERE id = 1
// DELETE FROM order_items WHERE id = 2
// ... (100æ¡DELETEè¯­å¥)
// DELETE FROM orders WHERE id = 1
// â±ï¸ è€—æ—¶ï¼šçº¦500ms
```

```java
// æ–¹å¼2ï¼šæ‰¹é‡åˆ é™¤
session.createQuery("DELETE FROM OrderItem WHERE order.id = :orderId")
       .setParameter("orderId", orderId)
       .executeUpdate();
session.remove(order);
// ğŸ’¾ æ‰§è¡Œçš„SQLï¼š
// DELETE FROM order_items WHERE order_id = 1  (1æ¡è¯­å¥)
// DELETE FROM orders WHERE id = 1
// â±ï¸ è€—æ—¶ï¼šçº¦50ms
```

### 5.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ä¼˜åŒ–ç­–ç•¥å¯¹æ¯”**ï¼š

| åœºæ™¯ | **çº§è”æ–¹å¼** | **æ‰‹åŠ¨æ–¹å¼** | **æ¨è** |
|------|------------|-------------|---------|
| ä¿å­˜è®¢å•(5ä¸ªè®¢å•é¡¹) | `5æ¡INSERT` | `æ‰¹é‡INSERT` | çº§è”æ–¹å¼ |
| åˆ é™¤è®¢å•(100ä¸ªè®¢å•é¡¹) | `100æ¡DELETE` | `1æ¡æ‰¹é‡DELETE` | æ‰‹åŠ¨æ–¹å¼ |
| æ›´æ–°å•†å“ä¿¡æ¯ | `è‡ªåŠ¨UPDATE` | `æ‰‹åŠ¨UPDATE` | çº§è”æ–¹å¼ |
| åˆ é™¤ç”¨æˆ·(1000ä¸ªå¸–å­) | `1000æ¡DELETE` | `æ‰¹é‡DELETE` | æ‰‹åŠ¨æ–¹å¼ |

**æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**ï¼š
```
1. å°æ‰¹é‡æ•°æ®ï¼ˆ<20æ¡ï¼‰â†’ ä½¿ç”¨çº§è”
2. å¤§æ‰¹é‡æ•°æ®ï¼ˆ>50æ¡ï¼‰â†’ ä½¿ç”¨æ‰¹é‡æ“ä½œ
3. å¤æ‚å…³è”åˆ é™¤ â†’ ä½¿ç”¨æ•°æ®åº“çº§è”åˆ é™¤
4. å¯ç”¨æ‰¹é‡å¤„ç†ï¼šhibernate.jdbc.batch_size=20
```

### 5.4 ç›‘æ§SQLæ‰§è¡Œ


**å¼€å¯SQLæ—¥å¿—æŸ¥çœ‹æ€§èƒ½**ï¼š
```properties
# application.properties
# æ˜¾ç¤ºSQLè¯­å¥
spring.jpa.show-sql=true
# æ ¼å¼åŒ–SQL
spring.jpa.properties.hibernate.format_sql=true
# æ˜¾ç¤ºSQLå‚æ•°
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
```

**åˆ†æç¤ºä¾‹**ï¼š
```sql
-- çº§è”ä¿å­˜æ—¶çš„SQL
Hibernate: insert into orders (order_no, id) values (?, ?)
Hibernate: insert into order_items (name, quantity, order_id, id) values (?, ?, ?, ?)
Hibernate: insert into order_items (name, quantity, order_id, id) values (?, ?, ?, ?)

-- ğŸ’¡ å¦‚æœçœ‹åˆ°å¤§é‡é‡å¤SQLï¼Œè€ƒè™‘ä¼˜åŒ–çº§è”é…ç½®
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ çº§è”æœ¬è´¨ï¼šçˆ¶å¯¹è±¡æ“ä½œè‡ªåŠ¨ä¼ æ’­åˆ°å­å¯¹è±¡
ğŸ”¸ 7ç§çº§è”ç±»å‹ï¼šPERSISTã€MERGEã€REMOVEã€REFRESHã€DETACHã€ALLã€REPLICATE
ğŸ”¸ é…ç½®ä½ç½®ï¼šåœ¨å…³è”å…³ç³»æ³¨è§£ä¸Šé…ç½®cascadeå±æ€§
ğŸ”¸ ä½¿ç”¨åŸåˆ™ï¼šåªåœ¨å¼ºä¾èµ–å…³ç³»ä¸­é…ç½®çº§è”
ğŸ”¸ æ€§èƒ½è€ƒè™‘ï¼šå¤§æ‰¹é‡æ“ä½œé¿å…ä½¿ç”¨çº§è”
```

### 6.2 çº§è”ç±»å‹é€Ÿè®°


```
ğŸ“Œ çº§è”ç±»å‹è®°å¿†å£è¯€ï¼š

PERSIST - ä¿å­˜æ—¶çº§è”ï¼Œæ–°å¢æ•°æ®ç”¨
MERGE   - åˆå¹¶æ—¶çº§è”ï¼Œæ›´æ–°æ•°æ®ç”¨
REMOVE  - åˆ é™¤æ—¶çº§è”ï¼Œè°¨æ…ä½¿ç”¨
REFRESH - åˆ·æ–°æ—¶çº§è”ï¼Œé‡è½½æ•°æ®ç”¨
DETACH  - åˆ†ç¦»æ—¶çº§è”ï¼Œæ–­å¼€ç®¡ç†ç”¨
ALL     - å…¨éƒ¨çº§è”ï¼Œæ…é‡é…ç½®
```

### 6.3 å®é™…åº”ç”¨å†³ç­–è¡¨


**ä»€ä¹ˆæ—¶å€™é…ç½®çº§è”**ï¼š

| å…³ç³»ç±»å‹ | **æ˜¯å¦çº§è”** | **çº§è”ç±»å‹** | **å…¸å‹ä¾‹å­** |
|---------|------------|-------------|-------------|
| è®¢å•-è®¢å•é¡¹ | âœ… æ˜¯ | `ALL` | è®¢å•å’Œæ˜ç»†å¼ºç»‘å®š |
| éƒ¨é—¨-å‘˜å·¥ | âŒ å¦ | `æ— ` | å‘˜å·¥å¯ç‹¬ç«‹å­˜åœ¨ |
| æ–‡ç« -è¯„è®º | âœ… æ˜¯ | `PERSIST, MERGE` | è¯„è®ºä»å±æ–‡ç«  |
| å­¦ç”Ÿ-è¯¾ç¨‹ | âŒ å¦ | `æ— ` | å¤šå¯¹å¤šç‹¬ç«‹å…³ç³» |
| è´­ç‰©è½¦-å•†å“ | âœ… æ˜¯ | `PERSIST, MERGE` | è´­ç‰©è½¦ç®¡ç†å•†å“ |

### 6.4 å…³é”®æ³¨æ„äº‹é¡¹


**âš ï¸ ä¸‰å¤§é™·é˜±**ï¼š
1. **REMOVEçº§è”è¯¯åˆ æ•°æ®**ï¼šåˆ éƒ¨é—¨æŠŠå‘˜å·¥éƒ½åˆ äº†
2. **åŒå‘çº§è”æ­»å¾ªç¯**ï¼šUserçº§è”Roleï¼ŒRoleåˆçº§è”User
3. **æ€§èƒ½é—®é¢˜**ï¼š100æ¡æ•°æ®çº§è”åˆ é™¤äº§ç”Ÿ100æ¡SQL

**âœ… æœ€ä½³å®è·µ**ï¼š
1. ä¼˜å…ˆä½¿ç”¨`PERSIST + MERGE`ç»„åˆ
2. `REMOVE`çº§è”è¦ä¸‰æ€è€Œåè¡Œ
3. å¤šå¯¹å¤šå…³ç³»é¿å…çº§è”
4. å¤§æ‰¹é‡æ“ä½œç”¨æ‰¹é‡SQLä»£æ›¿çº§è”
5. å¼€å¯SQLæ—¥å¿—ç›‘æ§æ€§èƒ½

**æ ¸å¿ƒè®°å¿†**ï¼š
- çº§è”æ˜¯æŠŠåŒåˆƒå‰‘ï¼Œç”¨å¯¹ä¾¿åˆ©ï¼Œç”¨é”™å±é™©
- å¼ºä¾èµ–å…³ç³»æ‰é…çº§è”ï¼Œç‹¬ç«‹å®ä½“ä¸è¦çº§è”
- æ€§èƒ½ç¬¬ä¸€ï¼Œçº§è”ç¬¬äºŒï¼Œå°æ‰¹é‡ç”¨çº§è”ï¼Œå¤§æ‰¹é‡ç”¨SQL