---
title: 34ã€Queryæ¥å£è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [Queryæ¥å£åŸºæœ¬æ¦‚å¿µ](#1-Queryæ¥å£åŸºæœ¬æ¦‚å¿µ)
2. [Queryå¯¹è±¡çš„åˆ›å»º](#2-Queryå¯¹è±¡çš„åˆ›å»º)
3. [å‚æ•°ç»‘å®šæœºåˆ¶](#3-å‚æ•°ç»‘å®šæœºåˆ¶)
4. [æŸ¥è¯¢ç»“æœè·å–](#4-æŸ¥è¯¢ç»“æœè·å–)
5. [åˆ†é¡µæŸ¥è¯¢å®ç°](#5-åˆ†é¡µæŸ¥è¯¢å®ç°)
6. [æ€§èƒ½ä¼˜åŒ–æŠ€å·§](#6-æ€§èƒ½ä¼˜åŒ–æŠ€å·§)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Queryæ¥å£åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Queryæ¥å£


**é€šä¿—ç†è§£**ï¼šQueryæ¥å£å°±åƒä¸€ä¸ª"æŸ¥è¯¢æ‰§è¡Œå™¨"ï¼ŒæŠŠä½ å†™çš„HQLè¯­å¥ç¿»è¯‘æˆæ•°æ®åº“èƒ½å¬æ‡‚çš„SQLï¼Œç„¶åå¸®ä½ æ‰§è¡Œå¹¶è¿”å›ç»“æœã€‚

```
æˆ‘ä»¬çš„æµç¨‹ï¼š
å†™HQL â†’ åˆ›å»ºQueryå¯¹è±¡ â†’ è®¾ç½®å‚æ•° â†’ æ‰§è¡ŒæŸ¥è¯¢ â†’ è·å–ç»“æœ

å°±åƒç‚¹å¤–å–ï¼š
å†™è®¢å• â†’ æäº¤è®¢å• â†’ å¡«å†™åœ°å€ â†’ ç­‰å¾…é…é€ â†’ æ”¶åˆ°å¤–å–
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- **æ‰§è¡ŒHQLæŸ¥è¯¢** - æŠŠé¢å‘å¯¹è±¡çš„æŸ¥è¯¢è¯­å¥å‘é€ç»™æ•°æ®åº“
- **å‚æ•°ç»‘å®š** - å®‰å…¨åœ°ä¼ é€’æŸ¥è¯¢æ¡ä»¶ï¼Œé˜²æ­¢SQLæ³¨å…¥
- **ç»“æœå¤„ç†** - æŠŠæ•°æ®åº“è¿”å›çš„æ•°æ®è½¬æ¢æˆJavaå¯¹è±¡
- **åˆ†é¡µæ”¯æŒ** - è½»æ¾å®ç°å¤§æ•°æ®é‡çš„åˆ†é¡µæŸ¥è¯¢

### 1.2 Queryæ¥å£åœ¨Hibernateä¸­çš„ä½ç½®


```
æ•°æ®æŸ¥è¯¢æµç¨‹å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨å±‚     â”‚ â† ç¼–å†™HQLè¯­å¥
â”‚  (Service)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Queryæ¥å£  â”‚ â† å°è£…æŸ¥è¯¢é€»è¾‘
â”‚  (æ‰§è¡Œå™¨)   â”‚    ç»‘å®šå‚æ•°ã€æ‰§è¡ŒæŸ¥è¯¢
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hibernate   â”‚ â† HQLè½¬SQL
â”‚   (ç¿»è¯‘å™¨)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“     â”‚ â† æ‰§è¡ŒSQL
â”‚  (MySQLç­‰)  â”‚    è¿”å›ç»“æœ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ”¨ Queryå¯¹è±¡çš„åˆ›å»º


### 2.1 åŸºæœ¬åˆ›å»ºæ–¹å¼


**æ–¹å¼ä¸€ï¼šé€šè¿‡Sessionåˆ›å»º**
```java
// 1. è·å–Sessionå¯¹è±¡
Session session = sessionFactory.openSession();

// 2. ç¼–å†™HQLè¯­å¥
String hql = "from User where age > 18";

// 3. åˆ›å»ºQueryå¯¹è±¡
Query query = session.createQuery(hql);
```

**ç†è§£è¦ç‚¹**ï¼š
- `session.createQuery()` æ˜¯æœ€å¸¸ç”¨çš„åˆ›å»ºæ–¹å¼
- å‚æ•°æ˜¯HQLè¯­å¥å­—ç¬¦ä¸²
- Queryå¯¹è±¡è´Ÿè´£åç»­çš„å‚æ•°è®¾ç½®å’Œæ‰§è¡Œ

**æ–¹å¼äºŒï¼šé“¾å¼è°ƒç”¨åˆ›å»º**
```java
// ä¸€è¡Œä»£ç æå®š
List<User> users = session.createQuery("from User")
                         .list();
```

### 2.2 åˆ›å»ºè¿‡ç¨‹è¯¦è§£


```
åˆ›å»ºQueryçš„å†…éƒ¨æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è§£æHQLè¯­å¥                â”‚
â”‚    æ£€æŸ¥è¯­æ³•æ˜¯å¦æ­£ç¡®           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åˆ›å»ºQueryå®ç°ç±»å¯¹è±¡        â”‚
â”‚    (é€šå¸¸æ˜¯QueryImpl)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ç»‘å®šåˆ°å½“å‰Session          â”‚
â”‚    ç¡®ä¿æŸ¥è¯¢åœ¨åŒä¸€äº‹åŠ¡ä¸­       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®é™…ç¤ºä¾‹**ï¼š
```java
public List<User> findAdultUsers() {
    Session session = sessionFactory.openSession();
    
    // HQLè¯­å¥ï¼šæŸ¥è¯¢æˆå¹´ç”¨æˆ·
    String hql = "from User u where u.age >= :minAge";
    
    // åˆ›å»ºQueryå¯¹è±¡
    Query<User> query = session.createQuery(hql, User.class);
    
    // åç»­æ“ä½œï¼šè®¾ç½®å‚æ•°ã€æ‰§è¡ŒæŸ¥è¯¢...
    return query.list();
}
```

---

## 3. ğŸ”§ å‚æ•°ç»‘å®šæœºåˆ¶


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦å‚æ•°ç»‘å®š


**é—®é¢˜åœºæ™¯**ï¼š
```java
// âŒ é”™è¯¯åšæ³•ï¼šå­—ç¬¦ä¸²æ‹¼æ¥
String username = "admin";
String hql = "from User where username = '" + username + "'";

// å±é™©ï¼å¦‚æœusername = "admin' or '1'='1"
// å°±ä¼šå˜æˆï¼šfrom User where username = 'admin' or '1'='1'
// è¿™å°±æ˜¯SQLæ³¨å…¥æ”»å‡»ï¼
```

**æ­£ç¡®åšæ³•**ï¼šä½¿ç”¨å‚æ•°ç»‘å®š
```java
// âœ… å®‰å…¨åšæ³•ï¼šå‚æ•°ç»‘å®š
String hql = "from User where username = :username";
Query query = session.createQuery(hql);
query.setParameter("username", username);

// Hibernateä¼šè‡ªåŠ¨å¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢æ³¨å…¥
```

### 3.2 ä½ç½®å‚æ•°ç»‘å®š


**æ¦‚å¿µ**ï¼šç”¨`?`å’Œä½ç½®ç´¢å¼•ä¼ é€’å‚æ•°

```java
// å®šä¹‰HQLï¼Œä½¿ç”¨?ä½œä¸ºå ä½ç¬¦
String hql = "from User where age > ? and city = ?";

Query query = session.createQuery(hql);

// æŒ‰ä½ç½®è®¾ç½®å‚æ•°ï¼ˆç´¢å¼•ä»0å¼€å§‹ï¼‰
query.setParameter(0, 18);      // ç¬¬1ä¸ªå‚æ•°ï¼šå¹´é¾„
query.setParameter(1, "åŒ—äº¬");   // ç¬¬2ä¸ªå‚æ•°ï¼šåŸå¸‚

List<User> users = query.list();
```

**ä½ç½®å‚æ•°ç‰¹ç‚¹**ï¼š
- âœ… **ä¼˜ç‚¹** - ç®€æ´ï¼Œé€‚åˆå‚æ•°å°‘çš„åœºæ™¯
- âŒ **ç¼ºç‚¹** - å‚æ•°å¤šæ—¶å®¹æ˜“ææ··é¡ºåº
- âš ï¸ **æ³¨æ„** - ç´¢å¼•ä»0å¼€å§‹ï¼Œä¸æ˜¯ä»1å¼€å§‹

**å¯¹æ¯”è¯´æ˜**ï¼š
```
ä½ç½®å‚æ•°å°±åƒæ’é˜Ÿï¼š
ç¬¬1ä¸ªäºº(ç´¢å¼•0) â†’ å‚æ•°1
ç¬¬2ä¸ªäºº(ç´¢å¼•1) â†’ å‚æ•°2
ç¬¬3ä¸ªäºº(ç´¢å¼•2) â†’ å‚æ•°3

å¿…é¡»æŒ‰é¡ºåºï¼Œä¸èƒ½è·³è¿‡æˆ–ä¹±åº
```

### 3.3 å‘½åå‚æ•°ç»‘å®šï¼ˆæ¨èï¼‰


**æ¦‚å¿µ**ï¼šç”¨`:å‚æ•°å`ä¼ é€’å‚æ•°ï¼Œæ›´æ¸…æ™°æ˜“è¯»

```java
// ä½¿ç”¨å‘½åå‚æ•°
String hql = "from User where age > :minAge and city = :cityName";

Query query = session.createQuery(hql);

// æŒ‰åç§°è®¾ç½®å‚æ•°ï¼ˆé¡ºåºæ— å…³ï¼‰
query.setParameter("minAge", 18);
query.setParameter("cityName", "åŒ—äº¬");

// ä¹Ÿå¯ä»¥è¿™æ ·å†™ï¼ˆé¡ºåºéšæ„ï¼‰
query.setParameter("cityName", "åŒ—äº¬");
query.setParameter("minAge", 18);

List<User> users = query.list();
```

**å‘½åå‚æ•°ä¼˜åŠ¿**ï¼š
- âœ… **å¯è¯»æ€§å¼º** - ä¸€çœ¼çœ‹å‡ºå‚æ•°å«ä¹‰
- âœ… **ä¸æ€•é¡ºåº** - æŒ‰åç§°è®¾ç½®ï¼Œä¸ä¼šæé”™
- âœ… **æ˜“äºç»´æŠ¤** - ä¿®æ”¹HQLæ—¶ä¸å½±å“å‚æ•°è®¾ç½®
- âœ… **å¯é‡ç”¨** - åŒä¸€ä¸ªå‚æ•°åå¯ä»¥åœ¨HQLä¸­å¤šæ¬¡ä½¿ç”¨

**å®é™…å¯¹æ¯”**ï¼š
```java
// ä½ç½®å‚æ•°ï¼ˆä¸æ¨èï¼‰
String hql1 = "from Order where price > ? and status = ? and createTime > ?";
query.setParameter(0, 100);
query.setParameter(1, "PAID");
query.setParameter(2, startDate);
// å‚æ•°å¤šäº†å°±å®¹æ˜“ææ··

// å‘½åå‚æ•°ï¼ˆæ¨èï¼‰
String hql2 = "from Order where price > :minPrice and status = :orderStatus and createTime > :startDate";
query.setParameter("minPrice", 100);
query.setParameter("orderStatus", "PAID");
query.setParameter("startDate", startDate);
// ä¸€ç›®äº†ç„¶ï¼
```

### 3.4 setParameteræ–¹æ³•è¯¦è§£


**åŸºæœ¬ç”¨æ³•**ï¼š
```java
// è®¾ç½®å„ç§ç±»å‹çš„å‚æ•°
query.setParameter("age", 25);              // Integer
query.setParameter("name", "å¼ ä¸‰");          // String
query.setParameter("price", 99.99);         // Double
query.setParameter("createTime", new Date()); // Date
query.setParameter("isVip", true);          // Boolean
```

**ç‰¹æ®Šç±»å‹å¤„ç†**ï¼š
```java
// æ—¥æœŸç±»å‹ï¼ˆéœ€è¦æŒ‡å®šç±»å‹ï¼‰
query.setParameter("birthday", birthday, TemporalType.DATE);

// æ—¶é—´ç±»å‹
query.setParameter("loginTime", loginTime, TemporalType.TIMESTAMP);

// æšä¸¾ç±»å‹
query.setParameter("userType", UserType.ADMIN);
```

**æ‰¹é‡è®¾ç½®å‚æ•°**ï¼š
```java
// æ–¹å¼1ï¼šä½¿ç”¨Mapæ‰¹é‡è®¾ç½®
Map<String, Object> params = new HashMap<>();
params.put("minAge", 18);
params.put("city", "åŒ—äº¬");

query.setProperties(params);

// æ–¹å¼2ï¼šä½¿ç”¨Beanå¯¹è±¡è®¾ç½®
User searchCondition = new User();
searchCondition.setAge(18);
searchCondition.setCity("åŒ—äº¬");

query.setProperties(searchCondition);
```

---

## 4. ğŸ“Š æŸ¥è¯¢ç»“æœè·å–


### 4.1 list() - è·å–ç»“æœåˆ—è¡¨


**æ¦‚å¿µ**ï¼šæŠŠæ‰€æœ‰æŸ¥è¯¢ç»“æœå°è£…æˆListé›†åˆè¿”å›

```java
// æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
String hql = "from User";
Query<User> query = session.createQuery(hql, User.class);

// è·å–ç»“æœåˆ—è¡¨
List<User> users = query.list();

// å¤„ç†ç»“æœ
for (User user : users) {
    System.out.println(user.getName());
}
```

**list()ç‰¹ç‚¹**ï¼š
- âœ… **è¿”å›é›†åˆ** - å³ä½¿æ²¡æœ‰ç»“æœä¹Ÿè¿”å›ç©ºListï¼Œä¸ä¼šnull
- âœ… **åŠ è½½å…¨éƒ¨** - ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®
- âš ï¸ **å†…å­˜å ç”¨** - æ•°æ®é‡å¤§æ—¶è¦æ³¨æ„å†…å­˜

**ä½¿ç”¨åœºæ™¯**ï¼š
```
é€‚åˆlist()çš„åœºæ™¯ï¼š
â€¢ æ•°æ®é‡å¯æ§ï¼ˆå‡ ç™¾æ¡ä»¥å†…ï¼‰
â€¢ éœ€è¦éå†æ‰€æœ‰ç»“æœ
â€¢ è¦å¯¹ç»“æœè¿›è¡Œæ‰¹é‡å¤„ç†

ä¸é€‚åˆlist()çš„åœºæ™¯ï¼š
â€¢ æ•°æ®é‡å·¨å¤§ï¼ˆæˆåƒä¸Šä¸‡æ¡ï¼‰
â€¢ åªéœ€è¦æŸ¥çœ‹éƒ¨åˆ†æ•°æ®
â€¢ å†…å­˜èµ„æºç´§å¼ 
```

### 4.2 uniqueResult() - è·å–å”¯ä¸€ç»“æœ


**æ¦‚å¿µ**ï¼šåªè¿”å›ä¸€æ¡è®°å½•ï¼Œé€šå¸¸ç”¨äºæ ¹æ®ä¸»é”®æˆ–å”¯ä¸€å­—æ®µæŸ¥è¯¢

```java
// æ ¹æ®IDæŸ¥è¯¢ç”¨æˆ·
String hql = "from User where id = :userId";
Query<User> query = session.createQuery(hql, User.class);
query.setParameter("userId", 1L);

// è·å–å”¯ä¸€ç»“æœ
User user = query.uniqueResult();

if (user != null) {
    System.out.println("æ‰¾åˆ°ç”¨æˆ·ï¼š" + user.getName());
} else {
    System.out.println("ç”¨æˆ·ä¸å­˜åœ¨");
}
```

**uniqueResult()ç‰¹ç‚¹**ï¼š
- âœ… **è¿”å›å•ä¸ª** - åªè¿”å›ä¸€ä¸ªå¯¹è±¡
- âš ï¸ **å¯èƒ½ä¸ºnull** - æ²¡æœ‰ç»“æœæ—¶è¿”å›null
- âŒ **å¤šæ¡æŠ¥é”™** - å¦‚æœæŸ¥è¯¢ç»“æœè¶…è¿‡1æ¡ï¼Œä¼šæŠ›å¼‚å¸¸

**å¼‚å¸¸å¤„ç†**ï¼š
```java
try {
    // å¦‚æœç»“æœè¶…è¿‡1æ¡ï¼Œä¼šæŠ›NonUniqueResultException
    User user = query.uniqueResult();
} catch (NonUniqueResultException e) {
    System.out.println("æŸ¥è¯¢ç»“æœä¸å”¯ä¸€ï¼");
}
```

**å®é™…åº”ç”¨**ï¼š
```java
// åœºæ™¯1ï¼šæ ¹æ®ä¸»é”®æŸ¥è¯¢
public User findById(Long id) {
    String hql = "from User where id = :id";
    return session.createQuery(hql, User.class)
                 .setParameter("id", id)
                 .uniqueResult();
}

// åœºæ™¯2ï¼šæ ¹æ®å”¯ä¸€å­—æ®µæŸ¥è¯¢
public User findByUsername(String username) {
    String hql = "from User where username = :username";
    return session.createQuery(hql, User.class)
                 .setParameter("username", username)
                 .uniqueResult();
}

// åœºæ™¯3ï¼šèšåˆæŸ¥è¯¢
public Long countUsers() {
    String hql = "select count(*) from User";
    return session.createQuery(hql, Long.class)
                 .uniqueResult();
}
```

### 4.3 iterate() - è¿­ä»£å™¨æ–¹å¼ï¼ˆäº†è§£ï¼‰


**æ¦‚å¿µ**ï¼šè¿”å›è¿­ä»£å™¨ï¼Œé€æ¡å¤„ç†ç»“æœ

```java
String hql = "from User";
Query<User> query = session.createQuery(hql, User.class);

// è·å–è¿­ä»£å™¨
Iterator<User> iterator = query.iterate();

// é€æ¡å¤„ç†
while (iterator.hasNext()) {
    User user = iterator.next();
    System.out.println(user.getName());
}
```

**iterate()ç‰¹ç‚¹**ï¼š
- ğŸ”¸ **åˆ†æ‰¹åŠ è½½** - å…ˆæŸ¥IDï¼Œç”¨åˆ°æ—¶å†æŸ¥è¯¦æƒ…
- ğŸ”¸ **èŠ‚çœå†…å­˜** - ä¸ä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨æ•°æ®
- âš ï¸ **N+1é—®é¢˜** - å¯èƒ½å¯¼è‡´å¤šæ¬¡æŸ¥è¯¢

**å¯¹æ¯”è¯´æ˜**ï¼š
```
list() vs iterate():

list()æ‰§è¡Œæµç¨‹ï¼š
1. æ‰§è¡Œä¸€æ¬¡SQLï¼ŒæŸ¥è¯¢æ‰€æœ‰æ•°æ®
2. æŠŠç»“æœå…¨éƒ¨åŠ è½½åˆ°å†…å­˜
3. è¿”å›Listé›†åˆ

iterate()æ‰§è¡Œæµç¨‹ï¼š
1. æ‰§è¡ŒSQLï¼ŒåªæŸ¥è¯¢IDåˆ—è¡¨
2. ç”¨æˆ·è°ƒç”¨next()æ—¶å†æ ¹æ®IDæŸ¥è¯¢è¯¦æƒ…
3. æ¯ä¸ªå¯¹è±¡éƒ½å¯èƒ½è§¦å‘ä¸€æ¬¡SQLï¼ˆN+1é—®é¢˜ï¼‰

é€šå¸¸å»ºè®®ï¼šä¼˜å…ˆä½¿ç”¨list()ï¼Œiterate()ç”¨äºç‰¹æ®Šåœºæ™¯
```

---

## 5. ğŸ“„ åˆ†é¡µæŸ¥è¯¢å®ç°


### 5.1 åˆ†é¡µæŸ¥è¯¢çš„å¿…è¦æ€§


**é—®é¢˜åœºæ™¯**ï¼š
```
æ•°æ®åº“æœ‰100ä¸‡æ¡ç”¨æˆ·æ•°æ®
å¦‚æœä¸€æ¬¡æ€§æŸ¥è¯¢ï¼š
â€¢ å†…å­˜å ç”¨ï¼š100ä¸‡å¯¹è±¡ â‰ˆ å‡ ç™¾MB
â€¢ æŸ¥è¯¢æ—¶é—´ï¼šå¯èƒ½éœ€è¦å‡ åç§’
â€¢ ç”¨æˆ·ä½“éªŒï¼šé¡µé¢å¡æ­»

ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢ï¼š
â€¢ æ¯æ¬¡åªæŸ¥20æ¡æ•°æ®
â€¢ å†…å­˜å ç”¨ï¼š20ä¸ªå¯¹è±¡ â‰ˆ å‡ KB
â€¢ æŸ¥è¯¢æ—¶é—´ï¼šæ¯«ç§’çº§
â€¢ ç”¨æˆ·ä½“éªŒï¼šæµç•…
```

### 5.2 åˆ†é¡µæŸ¥è¯¢æ ¸å¿ƒæ–¹æ³•


**ä¸¤ä¸ªå…³é”®æ–¹æ³•**ï¼š
```java
// setFirstResult(int firstResult)
// ä½œç”¨ï¼šè®¾ç½®ä»ç¬¬å‡ æ¡å¼€å§‹æŸ¥è¯¢ï¼ˆä»0å¼€å§‹ï¼‰

// setMaxResults(int maxResults)  
// ä½œç”¨ï¼šè®¾ç½®æœ€å¤šæŸ¥è¯¢å¤šå°‘æ¡
```

**åŸºæœ¬ç”¨æ³•**ï¼š
```java
// æŸ¥è¯¢ç¬¬1é¡µï¼Œæ¯é¡µ10æ¡
String hql = "from User order by id";
Query<User> query = session.createQuery(hql, User.class);

query.setFirstResult(0);   // ä»ç¬¬0æ¡å¼€å§‹
query.setMaxResults(10);   // æœ€å¤š10æ¡

List<User> page1 = query.list();

// æŸ¥è¯¢ç¬¬2é¡µï¼Œæ¯é¡µ10æ¡
query.setFirstResult(10);  // ä»ç¬¬10æ¡å¼€å§‹
query.setMaxResults(10);   // æœ€å¤š10æ¡

List<User> page2 = query.list();
```

### 5.3 åˆ†é¡µæŸ¥è¯¢å°è£…å®ç°


**é€šç”¨åˆ†é¡µæ–¹æ³•**ï¼š
```java
public class PageHelper {
    
    /**
     * åˆ†é¡µæŸ¥è¯¢
     * @param hql HQLè¯­å¥
     * @param currentPage å½“å‰é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
     * @param pageSize æ¯é¡µæ¡æ•°
     */
    public static <T> List<T> findByPage(Session session, 
                                         String hql, 
                                         int currentPage, 
                                         int pageSize,
                                         Class<T> resultClass) {
        
        Query<T> query = session.createQuery(hql, resultClass);
        
        // è®¡ç®—èµ·å§‹ä½ç½®
        int firstResult = (currentPage - 1) * pageSize;
        
        // è®¾ç½®åˆ†é¡µå‚æ•°
        query.setFirstResult(firstResult);
        query.setMaxResults(pageSize);
        
        return query.list();
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// æŸ¥è¯¢ç¬¬1é¡µï¼Œæ¯é¡µ20æ¡
List<User> users = PageHelper.findByPage(
    session, 
    "from User order by createTime desc",
    1,      // ç¬¬1é¡µ
    20,     // æ¯é¡µ20æ¡
    User.class
);

// æŸ¥è¯¢ç¬¬3é¡µï¼Œæ¯é¡µ20æ¡
List<User> users = PageHelper.findByPage(
    session,
    "from User order by createTime desc", 
    3,      // ç¬¬3é¡µ
    20,     // æ¯é¡µ20æ¡
    User.class
);
```

### 5.4 å®Œæ•´åˆ†é¡µæ–¹æ¡ˆ


**åˆ†é¡µå¯¹è±¡å°è£…**ï¼š
```java
public class PageResult<T> {
    private int currentPage;    // å½“å‰é¡µç 
    private int pageSize;       // æ¯é¡µæ¡æ•°
    private long totalCount;    // æ€»è®°å½•æ•°
    private int totalPages;     // æ€»é¡µæ•°
    private List<T> data;       // å½“å‰é¡µæ•°æ®
    
    // è®¡ç®—æ€»é¡µæ•°
    public void calculateTotalPages() {
        this.totalPages = (int) Math.ceil(totalCount * 1.0 / pageSize);
    }
    
    // getter/setterçœç•¥...
}
```

**å®Œæ•´åˆ†é¡µæ–¹æ³•**ï¼š
```java
public <T> PageResult<T> findPage(String hql, 
                                  int currentPage, 
                                  int pageSize,
                                  Class<T> resultClass) {
    
    PageResult<T> result = new PageResult<>();
    
    // 1. æŸ¥è¯¢æ€»è®°å½•æ•°
    String countHql = "select count(*) " + hql;
    Long totalCount = session.createQuery(countHql, Long.class)
                            .uniqueResult();
    result.setTotalCount(totalCount);
    
    // 2. æŸ¥è¯¢å½“å‰é¡µæ•°æ®
    Query<T> query = session.createQuery(hql, resultClass);
    query.setFirstResult((currentPage - 1) * pageSize);
    query.setMaxResults(pageSize);
    result.setData(query.list());
    
    // 3. è®¾ç½®åˆ†é¡µä¿¡æ¯
    result.setCurrentPage(currentPage);
    result.setPageSize(pageSize);
    result.calculateTotalPages();
    
    return result;
}
```

**å®é™…åº”ç”¨**ï¼š
```java
// æ§åˆ¶å™¨å±‚è°ƒç”¨
public PageResult<User> getUserList(int page, int size) {
    Session session = sessionFactory.openSession();
    
    String hql = "from User where status = 1 order by createTime desc";
    
    PageResult<User> result = findPage(hql, page, size, User.class);
    
    session.close();
    
    return result;
}
```

### 5.5 åˆ†é¡µSQLç”ŸæˆåŸç†


**Hibernateå¦‚ä½•å®ç°åˆ†é¡µ**ï¼š
```
ä¸åŒæ•°æ®åº“çš„åˆ†é¡µè¯­æ³•ï¼š

MySQLï¼š
SELECT * FROM user 
ORDER BY id 
LIMIT 10 OFFSET 20

PostgreSQLï¼š
SELECT * FROM user 
ORDER BY id 
LIMIT 10 OFFSET 20

Oracleï¼š
SELECT * FROM (
  SELECT a.*, ROWNUM rn FROM (
    SELECT * FROM user ORDER BY id
  ) a WHERE ROWNUM <= 30
) WHERE rn > 20

SQL Serverï¼š
SELECT * FROM user 
ORDER BY id 
OFFSET 20 ROWS 
FETCH NEXT 10 ROWS ONLY

Hibernateä¼šæ ¹æ®é…ç½®çš„æ•°æ®åº“æ–¹è¨€è‡ªåŠ¨é€‰æ‹©å¯¹åº”è¯­æ³•
```

---

## 6. âš¡ æ€§èƒ½ä¼˜åŒ–æŠ€å·§


### 6.1 ä½¿ç”¨æŠ•å½±å‡å°‘æ•°æ®ä¼ è¾“


**é—®é¢˜**ï¼šä¸éœ€è¦å…¨éƒ¨å­—æ®µæ—¶é¿å…æŸ¥è¯¢æ‰€æœ‰åˆ—

```java
// âŒ æŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼ˆæµªè´¹ï¼‰
String hql = "from User";
List<User> users = session.createQuery(hql, User.class).list();

// âœ… åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
String hql = "select new User(u.id, u.name, u.email) from User u";
List<User> users = session.createQuery(hql, User.class).list();
```

**å¯¹æ¯”è¯´æ˜**ï¼š
```
å…¨å­—æ®µæŸ¥è¯¢ï¼š
SELECT id, name, email, phone, address, ... (20ä¸ªå­—æ®µ)
FROM user

æŠ•å½±æŸ¥è¯¢ï¼š
SELECT id, name, email 
FROM user

æ•°æ®ä¼ è¾“é‡å‡å°‘60%ä»¥ä¸Šï¼
```

### 6.2 åˆç†ä½¿ç”¨ç¼“å­˜


**ä¸€çº§ç¼“å­˜ï¼ˆSessionç¼“å­˜ï¼‰**ï¼š
```java
Session session = sessionFactory.openSession();

// ç¬¬1æ¬¡æŸ¥è¯¢ï¼šè®¿é—®æ•°æ®åº“
User user1 = session.get(User.class, 1L);

// ç¬¬2æ¬¡æŸ¥è¯¢ï¼šä»ç¼“å­˜è·å–ï¼Œä¸è®¿é—®æ•°æ®åº“
User user2 = session.get(User.class, 1L);

System.out.println(user1 == user2); // trueï¼ŒåŒä¸€ä¸ªå¯¹è±¡
```

**QueryæŸ¥è¯¢ç¼“å­˜**ï¼š
```java
Query<User> query = session.createQuery("from User", User.class);

// å¯ç”¨æŸ¥è¯¢ç¼“å­˜
query.setCacheable(true);
query.setCacheRegion("userCache"); // æŒ‡å®šç¼“å­˜åŒºåŸŸ

List<User> users = query.list();
```

### 6.3 æ‰¹é‡æ“ä½œä¼˜åŒ–


**æ‰¹é‡æŸ¥è¯¢INè¯­å¥**ï¼š
```java
// âŒ å¾ªç¯æŸ¥è¯¢ï¼ˆNæ¬¡æŸ¥è¯¢ï¼‰
for (Long id : userIds) {
    User user = session.get(User.class, id);
}

// âœ… INæŸ¥è¯¢ï¼ˆ1æ¬¡æŸ¥è¯¢ï¼‰
String hql = "from User where id in (:ids)";
List<User> users = session.createQuery(hql, User.class)
                         .setParameterList("ids", userIds)
                         .list();
```

**é¿å…N+1æŸ¥è¯¢é—®é¢˜**ï¼š
```java
// âŒ N+1é—®é¢˜
String hql = "from User";
List<User> users = session.createQuery(hql, User.class).list();
for (User user : users) {
    // æ¯æ¬¡è®¿é—®orderséƒ½ä¼šè§¦å‘ä¸€æ¬¡æŸ¥è¯¢
    System.out.println(user.getOrders().size());
}

// âœ… ä½¿ç”¨JOIN FETCH
String hql = "from User u left join fetch u.orders";
List<User> users = session.createQuery(hql, User.class).list();
for (User user : users) {
    // ä¸ä¼šè§¦å‘é¢å¤–æŸ¥è¯¢
    System.out.println(user.getOrders().size());
}
```

### 6.4 å‚æ•°åŒ–æŸ¥è¯¢ä¸é¢„ç¼–è¯‘


**é¢„ç¼–è¯‘çš„å¥½å¤„**ï¼š
```java
// Hibernateä¼šç¼“å­˜é¢„ç¼–è¯‘çš„SQL
String hql = "from User where name = :name";

// ç¬¬1æ¬¡æ‰§è¡Œï¼šç¼–è¯‘HQL â†’ ç”ŸæˆSQL â†’ é¢„ç¼–è¯‘
Query query1 = session.createQuery(hql);
query1.setParameter("name", "å¼ ä¸‰");
query1.list();

// ç¬¬2æ¬¡æ‰§è¡Œï¼šç›´æ¥ä½¿ç”¨ç¼“å­˜çš„é¢„ç¼–è¯‘SQL
Query query2 = session.createQuery(hql);
query2.setParameter("name", "æå››");
query2.list();

// æ•ˆç‡æå‡æ˜æ˜¾ï¼
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Queryæ¥å£ï¼šHibernateæ‰§è¡ŒHQLæŸ¥è¯¢çš„æ ¸å¿ƒæ¥å£
ğŸ”¸ å‚æ•°ç»‘å®šï¼šé€šè¿‡setParameterå®‰å…¨ä¼ é€’æŸ¥è¯¢æ¡ä»¶
ğŸ”¸ ç»“æœè·å–ï¼šlist()è·å–åˆ—è¡¨ï¼ŒuniqueResult()è·å–å•ä¸ª
ğŸ”¸ åˆ†é¡µæŸ¥è¯¢ï¼šsetFirstResult()å’ŒsetMaxResults()å®ç°
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šæŠ•å½±æŸ¥è¯¢ã€ç¼“å­˜ã€æ‰¹é‡æ“ä½œ
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å‚æ•°ç»‘å®šä¸ºä»€ä¹ˆé‡è¦**
```
é˜²æ­¢SQLæ³¨å…¥ï¼š
é”™è¯¯ï¼šæ‹¼æ¥å­—ç¬¦ä¸² â†’ å¯èƒ½è¢«æ³¨å…¥æ¶æ„SQL
æ­£ç¡®ï¼šå‚æ•°ç»‘å®š â†’ Hibernateè‡ªåŠ¨è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦

æå‡æ€§èƒ½ï¼š
å‚æ•°åŒ–æŸ¥è¯¢ â†’ SQLé¢„ç¼–è¯‘ â†’ é‡å¤æ‰§è¡Œæ›´å¿«
```

**ğŸ”¹ list() vs uniqueResult() å¦‚ä½•é€‰æ‹©**
```
ä½¿ç”¨list()ï¼š
â€¢ æŸ¥è¯¢ç»“æœå¯èƒ½æ˜¯0æ¡ã€1æ¡æˆ–å¤šæ¡
â€¢ éœ€è¦éå†å¤„ç†æ‰€æœ‰ç»“æœ
â€¢ è¿”å›å€¼æ˜¯Listï¼Œä¸ä¼šnull

ä½¿ç”¨uniqueResult()ï¼š
â€¢ æ˜ç¡®çŸ¥é“ç»“æœåªæœ‰1æ¡ï¼ˆå¦‚æ ¹æ®ä¸»é”®æŸ¥è¯¢ï¼‰
â€¢ ç»“æœè¶…è¿‡1æ¡ä¼šæŠ›å¼‚å¸¸
â€¢ è¿”å›å€¼å¯èƒ½æ˜¯null
```

**ğŸ”¹ åˆ†é¡µæŸ¥è¯¢çš„æ ¸å¿ƒåŸç†**
```
åˆ†é¡µä¸‰è¦ç´ ï¼š
1. å½“å‰é¡µç ï¼ˆcurrentPageï¼‰
2. æ¯é¡µæ¡æ•°ï¼ˆpageSizeï¼‰
3. èµ·å§‹ä½ç½® = (currentPage - 1) * pageSize

ç¤ºä¾‹ï¼š
ç¬¬1é¡µï¼šèµ·å§‹ä½ç½® = (1-1) * 10 = 0ï¼ŒæŸ¥è¯¢10æ¡
ç¬¬2é¡µï¼šèµ·å§‹ä½ç½® = (2-1) * 10 = 10ï¼ŒæŸ¥è¯¢10æ¡
ç¬¬3é¡µï¼šèµ·å§‹ä½ç½® = (3-1) * 10 = 20ï¼ŒæŸ¥è¯¢10æ¡
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ä½¿ç”¨åœºæ™¯æ€»ç»“**ï¼š

| æ–¹æ³• | ä½¿ç”¨åœºæ™¯ | è¿”å›å€¼ | æ³¨æ„äº‹é¡¹ |
|------|---------|--------|----------|
| **list()** | æŸ¥è¯¢å¤šæ¡æ•°æ® | `List<T>` | æ•°æ®é‡å¤§æ—¶æ³¨æ„å†…å­˜ |
| **uniqueResult()** | æŸ¥è¯¢å•æ¡æ•°æ® | `T` æˆ– `null` | ç»“æœè¶…è¿‡1æ¡ä¼šæŠ¥é”™ |
| **iterate()** | å¤§æ•°æ®é€æ¡å¤„ç† | `Iterator<T>` | å¯èƒ½æœ‰N+1é—®é¢˜ |
| **setFirstResult()** | åˆ†é¡µæŸ¥è¯¢èµ·å§‹ä½ç½® | - | ä»0å¼€å§‹è®¡æ•° |
| **setMaxResults()** | åˆ†é¡µæŸ¥è¯¢æ¡æ•°é™åˆ¶ | - | é…åˆsetFirstResultä½¿ç”¨ |

**æœ€ä½³å®è·µå»ºè®®**ï¼š
```
âœ… ä¼˜å…ˆä½¿ç”¨å‘½åå‚æ•°ï¼Œæé«˜ä»£ç å¯è¯»æ€§
âœ… æŸ¥è¯¢å¤§æ•°æ®é‡æ—¶å¿…é¡»åˆ†é¡µï¼Œé¿å…å†…å­˜æº¢å‡º
âœ… åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“
âœ… åˆç†ä½¿ç”¨ç¼“å­˜ï¼Œé¿å…é‡å¤æŸ¥è¯¢
âœ… ä½¿ç”¨JOIN FETCHé¿å…N+1é—®é¢˜
```

**æ€§èƒ½ä¼˜åŒ–checklist**ï¼š
- [ ] å‚æ•°éƒ½ä½¿ç”¨äº†ç»‘å®šè€Œä¸æ˜¯æ‹¼æ¥
- [ ] æŠ•å½±æŸ¥è¯¢åªé€‰æ‹©éœ€è¦çš„å­—æ®µ
- [ ] å¤§æ•°æ®é‡æŸ¥è¯¢ä½¿ç”¨äº†åˆ†é¡µ
- [ ] å…³è”æŸ¥è¯¢ä½¿ç”¨äº†JOIN FETCH
- [ ] é‡å¤æŸ¥è¯¢å¯ç”¨äº†æŸ¥è¯¢ç¼“å­˜

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
QueryæŸ¥è¯¢ä¸‰æ­¥èµ°ï¼šåˆ›å»ºå¯¹è±¡ã€ç»‘å®šå‚æ•°ã€è·å–ç»“æœ
å‚æ•°ç»‘å®šä¿å®‰å…¨ï¼šå‘½åå‚æ•°æœ€æ¸…æ¥šï¼Œä½ç½®å‚æ•°æ˜“æ··æ·†
ç»“æœè·å–çœ‹åœºæ™¯ï¼šliståˆ—è¡¨ã€uniqueå•ä¸ªã€iterateè¿­ä»£
åˆ†é¡µæŸ¥è¯¢è¦ç‰¢è®°ï¼šèµ·å§‹ä½ç½®åŠ æ¡æ•°ï¼Œå…¬å¼è®¡ç®—åˆ«æé”™
æ€§èƒ½ä¼˜åŒ–é æŠ€å·§ï¼šæŠ•å½±ç¼“å­˜æ‰¹é‡æŸ¥ï¼ŒJOIN FETCHè§£N+1
```