---
title: 62ã€Springé›†æˆè¯¦è§£
---
## ğŸ“š ç›®å½•

1. [Springé›†æˆHibernateæ¦‚è¿°](#1-Springé›†æˆHibernateæ¦‚è¿°)
2. [LocalSessionFactoryBeané…ç½®](#2-LocalSessionFactoryBeané…ç½®)
3. [HibernateTransactionManageräº‹åŠ¡ç®¡ç†](#3-HibernateTransactionManageräº‹åŠ¡ç®¡ç†)
4. [å£°æ˜å¼äº‹åŠ¡é…ç½®](#4-å£°æ˜å¼äº‹åŠ¡é…ç½®)
5. [@Transactionalæ³¨è§£è¯¦è§£](#5-Transactionalæ³¨è§£è¯¦è§£)
6. [äº‹åŠ¡ä¼ æ’­å±æ€§](#6-äº‹åŠ¡ä¼ æ’­å±æ€§)
7. [å¼‚å¸¸å¤„ç†æœºåˆ¶](#7-å¼‚å¸¸å¤„ç†æœºåˆ¶)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”— Springé›†æˆHibernateæ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆè¦é›†æˆSpringå’ŒHibernate


**é—®é¢˜åœºæ™¯**ï¼šæƒ³è±¡ä½ åœ¨å¼€å‘ä¸€ä¸ªç”µå•†ç³»ç»Ÿ

```
âŒ ä¸é›†æˆçš„ç—›ç‚¹ï¼š
- æ‰‹åŠ¨ç®¡ç†SessionFactory â†’ æ¯æ¬¡éƒ½è¦è‡ªå·±åˆ›å»ºå’Œå…³é—­
- æ‰‹åŠ¨æ§åˆ¶äº‹åŠ¡ â†’ è¦å†™å¤§é‡try-catch-finallyä»£ç 
- é…ç½®åˆ†æ•£ â†’ Hibernateé…ç½®å’Œä¸šåŠ¡ä»£ç æ··åœ¨ä¸€èµ·
- éš¾ä»¥æµ‹è¯• â†’ æ•°æ®åº“æ“ä½œå’Œä¸šåŠ¡é€»è¾‘è€¦åˆç´§å¯†

âœ… é›†æˆåçš„å¥½å¤„ï¼š
- Springå¸®ä½ ç®¡ç†SessionFactory â†’ è‡ªåŠ¨åˆ›å»ºå’Œé”€æ¯
- å£°æ˜å¼äº‹åŠ¡ â†’ åŠ ä¸ªæ³¨è§£å°±æå®šäº‹åŠ¡æ§åˆ¶
- ç»Ÿä¸€é…ç½® â†’ æ‰€æœ‰é…ç½®é›†ä¸­ç®¡ç†
- æ˜“äºæµ‹è¯• â†’ å¯ä»¥è½»æ¾mockæ•°æ®å±‚
```

### 1.2 é›†æˆæ¶æ„æ¦‚è§ˆ


**æ•´ä½“ç»“æ„å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Springå®¹å™¨ (IoC)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Serviceå±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰           â”‚    â”‚
â”‚  â”‚  @Transactional å£°æ˜å¼äº‹åŠ¡       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚              â†“                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  DAOå±‚ï¼ˆæ•°æ®è®¿é—®ï¼‰               â”‚    â”‚
â”‚  â”‚  ä½¿ç”¨SessionFactory             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚              â†“                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  HibernateTransactionManager    â”‚    â”‚
â”‚  â”‚  ç®¡ç†äº‹åŠ¡çš„å¼€å¯ã€æäº¤ã€å›æ»š       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚              â†“                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  LocalSessionFactoryBean        â”‚    â”‚
â”‚  â”‚  åˆ›å»ºå’Œç®¡ç†SessionFactory        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
      æ•°æ®åº“ï¼ˆMySQL/Oracleç­‰ï¼‰
```

### 1.3 æ ¸å¿ƒç»„ä»¶è¯´æ˜


| ç»„ä»¶åç§° | **ä½œç”¨** | **é€šä¿—ç†è§£** |
|---------|---------|-------------|
| **LocalSessionFactoryBean** | åˆ›å»ºSessionFactory | å°±åƒä¸€ä¸ª"æ•°æ®åº“è¿æ¥å·¥å‚çš„å·¥å‚"ï¼Œè´Ÿè´£ç”Ÿäº§SessionFactory |
| **HibernateTransactionManager** | ç®¡ç†äº‹åŠ¡ | å°±åƒä¸€ä¸ª"äº‹åŠ¡ç®¡å®¶"ï¼Œå¸®ä½ è‡ªåŠ¨å¼€å¯ã€æäº¤ã€å›æ»šäº‹åŠ¡ |
| **@Transactional** | å£°æ˜å¼äº‹åŠ¡ | å°±åƒä¸€ä¸ª"äº‹åŠ¡æ ‡ç­¾"ï¼Œè´´åœ¨æ–¹æ³•ä¸Šå°±è‡ªåŠ¨æœ‰äº‹åŠ¡åŠŸèƒ½ |
| **SessionFactory** | æ•°æ®åº“ä¼šè¯å·¥å‚ | å°±åƒä¸€ä¸ª"æ•°æ®åº“è¿æ¥æ± "ï¼Œç”¨æ¥åˆ›å»ºSessionæ“ä½œæ•°æ®åº“ |

---

## 2. âš™ï¸ LocalSessionFactoryBeané…ç½®


### 2.1 ä»€ä¹ˆæ˜¯LocalSessionFactoryBean


**æ¦‚å¿µç†è§£**ï¼š
- **SessionFactory**ï¼šHibernateçš„æ ¸å¿ƒå¯¹è±¡ï¼Œç”¨æ¥åˆ›å»ºSessionï¼ˆæ•°æ®åº“ä¼šè¯ï¼‰
- **LocalSessionFactoryBean**ï¼šSpringæä¾›çš„å·¥å‚Beanï¼Œä¸“é—¨ç”¨æ¥åˆ›å»ºå’Œç®¡ç†SessionFactory
- **ä¸ºä»€ä¹ˆå«"Bean"**ï¼šå› ä¸ºå®ƒæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªSpringç®¡ç†çš„å¯¹è±¡

**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
SessionFactory â†’ å°±åƒä¸€ä¸ª"æ±½è½¦å·¥å‚"
LocalSessionFactoryBean â†’ å°±åƒ"å»ºæ±½è½¦å·¥å‚çš„å»ºç­‘å…¬å¸"

ä½ ä¸ç”¨è‡ªå·±å»ºå·¥å‚ï¼Œäº¤ç»™å»ºç­‘å…¬å¸ï¼ˆLocalSessionFactoryBeanï¼‰
å»ºç­‘å…¬å¸å»ºå¥½å·¥å‚ï¼ˆSessionFactoryï¼‰åäº¤ç»™ä½ ç”¨
```

### 2.2 åŸºç¡€é…ç½®æ–¹å¼


**é…ç½®æ­¥éª¤æµç¨‹**ï¼š
```
ç¬¬1æ­¥ï¼šé…ç½®æ•°æ®æºï¼ˆDataSourceï¼‰
   â†“
ç¬¬2æ­¥ï¼šé…ç½®LocalSessionFactoryBean
   â†“  
ç¬¬3æ­¥ï¼šè®¾ç½®Hibernateå±æ€§
   â†“
ç¬¬4æ­¥ï¼šæŒ‡å®šå®ä½“ç±»æ‰«æè·¯å¾„
```

**Javaé…ç½®æ–¹å¼**ï¼ˆæ¨èä½¿ç”¨ï¼‰ï¼š

```java
@Configuration
@EnableTransactionManagement  // å¼€å¯äº‹åŠ¡ç®¡ç†
public class HibernateConfig {
    
    // ç¬¬1æ­¥ï¼šé…ç½®æ•°æ®æº
    @Bean
    public DataSource dataSource() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource();
        dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
        dataSource.setUrl("jdbc:mysql://localhost:3306/mydb");
        dataSource.setUsername("root");
        dataSource.setPassword("123456");
        return dataSource;
    }
    
    // ç¬¬2æ­¥ï¼šé…ç½®SessionFactory
    @Bean
    public LocalSessionFactoryBean sessionFactory() {
        LocalSessionFactoryBean factoryBean = new LocalSessionFactoryBean();
        
        // è®¾ç½®æ•°æ®æº
        factoryBean.setDataSource(dataSource());
        
        // è®¾ç½®å®ä½“ç±»æ‰«æè·¯å¾„
        factoryBean.setPackagesToScan("com.example.entity");
        
        // è®¾ç½®Hibernateå±æ€§
        Properties properties = new Properties();
        properties.put("hibernate.dialect", "org.hibernate.dialect.MySQL8Dialect");
        properties.put("hibernate.show_sql", "true");
        properties.put("hibernate.hbm2ddl.auto", "update");
        factoryBean.setHibernateProperties(properties);
        
        return factoryBean;
    }
}
```

### 2.3 é‡è¦é…ç½®é¡¹è¯¦è§£


**Hibernateå±æ€§è¯´æ˜**ï¼š

| é…ç½®é¡¹ | **å«ä¹‰** | **å¸¸ç”¨å€¼** | **æ–°æ‰‹å»ºè®®** |
|-------|---------|-----------|-------------|
| `hibernate.dialect` | æ•°æ®åº“æ–¹è¨€ | `MySQL8Dialect`ã€`OracleDialect` | æ ¹æ®æ•°æ®åº“ç±»å‹é€‰æ‹© |
| `hibernate.show_sql` | æ˜¾ç¤ºSQLè¯­å¥ | `true`/`false` | å¼€å‘æ—¶ç”¨`true`ï¼Œç”Ÿäº§ç”¨`false` |
| `hibernate.hbm2ddl.auto` | è‡ªåŠ¨å»ºè¡¨ç­–ç•¥ | `update`ã€`create`ã€`validate` | å­¦ä¹ ç”¨`update`ï¼Œç”Ÿäº§ç”¨`validate` |
| `hibernate.format_sql` | æ ¼å¼åŒ–SQL | `true`/`false` | å»ºè®®è®¾ä¸º`true`ï¼Œä¾¿äºæŸ¥çœ‹ |

**hbm2ddl.autoè¯¦è§£**ï¼š
```
ğŸ”¸ createï¼šæ¯æ¬¡å¯åŠ¨åˆ é™¤æ—§è¡¨ï¼Œåˆ›å»ºæ–°è¡¨ï¼ˆä¼šä¸¢æ•°æ®ï¼ï¼‰
ğŸ”¸ updateï¼šè¡¨ä¸å­˜åœ¨å°±åˆ›å»ºï¼Œå­˜åœ¨å°±æ›´æ–°ç»“æ„ï¼ˆå¸¸ç”¨ï¼‰
ğŸ”¸ validateï¼šåªéªŒè¯è¡¨ç»“æ„ï¼Œä¸åšä¿®æ”¹ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
ğŸ”¸ noneï¼šä»€ä¹ˆéƒ½ä¸åš
```

### 2.4 XMLé…ç½®æ–¹å¼ï¼ˆäº†è§£å³å¯ï¼‰


```xml
<!-- applicationContext.xml -->
<bean id="sessionFactory" 
      class="org.springframework.orm.hibernate5.LocalSessionFactoryBean">
    
    <!-- æ•°æ®æº -->
    <property name="dataSource" ref="dataSource"/>
    
    <!-- å®ä½“ç±»æ‰«æ -->
    <property name="packagesToScan" value="com.example.entity"/>
    
    <!-- Hibernateå±æ€§ -->
    <property name="hibernateProperties">
        <props>
            <prop key="hibernate.dialect">org.hibernate.dialect.MySQL8Dialect</prop>
            <prop key="hibernate.show_sql">true</prop>
            <prop key="hibernate.hbm2ddl.auto">update</prop>
        </props>
    </property>
</bean>
```

---

## 3. ğŸ’¼ HibernateTransactionManageräº‹åŠ¡ç®¡ç†


### 3.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ç®¡ç†å™¨


**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **äº‹åŠ¡ï¼ˆTransactionï¼‰**ï¼šä¸€ç»„æ•°æ®åº“æ“ä½œï¼Œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
- **äº‹åŠ¡ç®¡ç†å™¨ï¼ˆTransactionManagerï¼‰**ï¼šè´Ÿè´£äº‹åŠ¡çš„å¼€å¯ã€æäº¤ã€å›æ»šçš„"ç®¡å®¶"

**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
é“¶è¡Œè½¬è´¦åœºæ™¯ï¼š
å°æ˜è½¬è´¦ç»™å°çº¢100å…ƒ

äº‹åŠ¡ç®¡ç†å™¨çš„å·¥ä½œï¼š
1. å¼€å¯äº‹åŠ¡ â†’ "å¼€å§‹è½¬è´¦æ“ä½œ"
2. å°æ˜è´¦æˆ·-100 â†’ "æ‰£æ¬¾"
3. å°çº¢è´¦æˆ·+100 â†’ "åˆ°è´¦"
4. æäº¤äº‹åŠ¡ â†’ "è½¬è´¦æˆåŠŸç¡®è®¤"

å¦‚æœç¬¬3æ­¥å¤±è´¥ï¼š
4. å›æ»šäº‹åŠ¡ â†’ "æ’¤é”€æ‰£æ¬¾ï¼Œæ¢å¤åŸçŠ¶"
```

### 3.2 HibernateTransactionManageré…ç½®


**é…ç½®ç¤ºä¾‹**ï¼š

```java
@Configuration
@EnableTransactionManagement
public class HibernateConfig {
    
    @Bean
    public LocalSessionFactoryBean sessionFactory() {
        // ... SessionFactoryé…ç½®ï¼ˆå‰é¢å·²è®²ï¼‰
    }
    
    // é…ç½®äº‹åŠ¡ç®¡ç†å™¨
    @Bean
    public HibernateTransactionManager transactionManager(SessionFactory sessionFactory) {
        HibernateTransactionManager txManager = new HibernateTransactionManager();
        txManager.setSessionFactory(sessionFactory);
        return txManager;
    }
}
```

**å…³é”®ç†è§£**ï¼š
- `HibernateTransactionManager`éœ€è¦`SessionFactory`æ‰èƒ½å·¥ä½œ
- Springä¼šè‡ªåŠ¨æŠŠ`SessionFactory`æ³¨å…¥åˆ°äº‹åŠ¡ç®¡ç†å™¨
- æœ‰äº†äº‹åŠ¡ç®¡ç†å™¨ï¼Œ`@Transactional`æ³¨è§£æ‰èƒ½ç”Ÿæ•ˆ

### 3.3 äº‹åŠ¡ç®¡ç†å™¨å·¥ä½œåŸç†


**æ‰§è¡Œæµç¨‹å›¾**ï¼š
```
ç”¨æˆ·è°ƒç”¨ä¸šåŠ¡æ–¹æ³•ï¼ˆå¸¦@Transactionalï¼‰
        â†“
äº‹åŠ¡ç®¡ç†å™¨æ‹¦æˆªæ–¹æ³•è°ƒç”¨
        â†“
å¼€å¯äº‹åŠ¡ï¼štxManager.beginTransaction()
        â†“
æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        â†“
        â†™ æˆåŠŸ          â†˜ å¤±è´¥
æäº¤äº‹åŠ¡ï¼šcommit()    å›æ»šäº‹åŠ¡ï¼šrollback()
        â†“                 â†“
è¿”å›ç»“æœ            æŠ›å‡ºå¼‚å¸¸
```

**ä»£ç å±‚é¢çš„ç†è§£**ï¼š

```java
// ä½ å†™çš„ä»£ç 
@Transactional
public void transfer(Long fromId, Long toId, Double amount) {
    accountDao.deduct(fromId, amount);  // æ‰£æ¬¾
    accountDao.add(toId, amount);       // åˆ°è´¦
}

// SpringèƒŒåå¸®ä½ åšçš„äº‹
public void transfer(Long fromId, Long toId, Double amount) {
    Transaction tx = null;
    try {
        tx = session.beginTransaction();  // å¼€å¯äº‹åŠ¡
        
        accountDao.deduct(fromId, amount);
        accountDao.add(toId, amount);
        
        tx.commit();  // æäº¤äº‹åŠ¡
    } catch (Exception e) {
        if (tx != null) {
            tx.rollback();  // å›æ»šäº‹åŠ¡
        }
        throw e;
    }
}
```

---

## 4. ğŸ“ å£°æ˜å¼äº‹åŠ¡é…ç½®


### 4.1 ä»€ä¹ˆæ˜¯å£°æ˜å¼äº‹åŠ¡


**æ¦‚å¿µå¯¹æ¯”**ï¼š

```
ç¼–ç¨‹å¼äº‹åŠ¡ï¼ˆæ‰‹åŠ¨ç®¡ç†ï¼‰ï¼š
ä½ è‡ªå·±å†™ä»£ç æ§åˆ¶äº‹åŠ¡
beginTransaction() â†’ ä¸šåŠ¡é€»è¾‘ â†’ commit/rollback

å£°æ˜å¼äº‹åŠ¡ï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰ï¼š
ä½ åªéœ€åŠ ä¸ªæ³¨è§£ï¼ŒSpringå¸®ä½ ç®¡ç†
@Transactional â†’ ä¸šåŠ¡é€»è¾‘ â†’ è‡ªåŠ¨æäº¤/å›æ»š
```

**ä¼˜åŠ¿å¯¹æ¯”**ï¼š

| æ–¹å¼ | **ä»£ç é‡** | **çµæ´»æ€§** | **ç»´æŠ¤æ€§** | **æ¨èåº¦** |
|-----|-----------|-----------|-----------|-----------|
| **ç¼–ç¨‹å¼äº‹åŠ¡** | å¤šï¼ˆé‡å¤ä»£ç ï¼‰ | é«˜ï¼ˆç²¾ç¡®æ§åˆ¶ï¼‰ | å·®ï¼ˆä»£ç æ··ä¹±ï¼‰ | â­â­ |
| **å£°æ˜å¼äº‹åŠ¡** | å°‘ï¼ˆä¸€ä¸ªæ³¨è§£ï¼‰ | ä¸­ï¼ˆé…ç½®æ§åˆ¶ï¼‰ | å¥½ï¼ˆå…³æ³¨ç‚¹åˆ†ç¦»ï¼‰ | â­â­â­â­â­ |

### 4.2 å¼€å¯å£°æ˜å¼äº‹åŠ¡


**æ­¥éª¤è¯´æ˜**ï¼š

**ç¬¬1æ­¥ï¼šæ·»åŠ æ³¨è§£æ”¯æŒ**
```java
@Configuration
@EnableTransactionManagement  // è¿™ä¸ªæ³¨è§£æ˜¯å…³é”®ï¼
public class AppConfig {
    // ... å…¶ä»–é…ç½®
}
```

**ç¬¬2æ­¥ï¼šé…ç½®äº‹åŠ¡ç®¡ç†å™¨**
```java
@Bean
public PlatformTransactionManager transactionManager(SessionFactory sessionFactory) {
    return new HibernateTransactionManager(sessionFactory);
}
```

**ç¬¬3æ­¥ï¼šä½¿ç”¨@Transactionalæ³¨è§£**
```java
@Service
public class UserService {
    
    @Transactional  // å°±è¿™ä¹ˆç®€å•ï¼
    public void registerUser(User user) {
        userDao.save(user);
        // å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œè‡ªåŠ¨å›æ»š
    }
}
```

### 4.3 æ³¨è§£ä½¿ç”¨ä½ç½®


**å¯ä»¥åŠ åœ¨å“ªé‡Œ**ï¼š

```java
// 1. ç±»çº§åˆ«ï¼šæ•´ä¸ªç±»çš„æ‰€æœ‰publicæ–¹æ³•éƒ½æœ‰äº‹åŠ¡
@Service
@Transactional
public class UserService {
    
    public void method1() { }  // æœ‰äº‹åŠ¡
    public void method2() { }  // æœ‰äº‹åŠ¡
}

// 2. æ–¹æ³•çº§åˆ«ï¼šåªæœ‰è¿™ä¸ªæ–¹æ³•æœ‰äº‹åŠ¡ï¼ˆä¼šè¦†ç›–ç±»çº§åˆ«é…ç½®ï¼‰
@Service
public class UserService {
    
    @Transactional
    public void method1() { }  // æœ‰äº‹åŠ¡
    
    public void method2() { }  // æ²¡æœ‰äº‹åŠ¡
}

// 3. ç»„åˆä½¿ç”¨ï¼šç±»çº§åˆ«è®¾é»˜è®¤ï¼Œæ–¹æ³•çº§åˆ«ç‰¹æ®Šé…ç½®
@Service
@Transactional(readOnly = true)  // é»˜è®¤åªè¯»äº‹åŠ¡
public class UserService {
    
    public void queryUser() { }  // åªè¯»äº‹åŠ¡
    
    @Transactional(readOnly = false)  // è¦†ç›–ç±»çº§åˆ«é…ç½®
    public void updateUser() { }  // è¯»å†™äº‹åŠ¡
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ åªå¯¹`public`æ–¹æ³•æœ‰æ•ˆ
- âš ï¸ è‡ªè°ƒç”¨ï¼ˆåŒç±»æ–¹æ³•äº’è°ƒï¼‰äº‹åŠ¡ä¼šå¤±æ•ˆ
- âš ï¸ å¼‚å¸¸ç±»å‹ä¼šå½±å“æ˜¯å¦å›æ»š

---

## 5. ğŸ·ï¸ @Transactionalæ³¨è§£è¯¦è§£


### 5.1 æ ¸å¿ƒå±æ€§è¯´æ˜


**@Transactionalå¯é…ç½®çš„å±æ€§**ï¼š

| å±æ€§å | **ä½œç”¨** | **å¸¸ç”¨å€¼** | **ä½¿ç”¨åœºæ™¯** |
|-------|---------|-----------|-------------|
| `propagation` | äº‹åŠ¡ä¼ æ’­è¡Œä¸º | `REQUIRED`ã€`REQUIRES_NEW` | æ§åˆ¶äº‹åŠ¡å¦‚ä½•ä¼ æ’­ |
| `isolation` | äº‹åŠ¡éš”ç¦»çº§åˆ« | `READ_COMMITTED`ã€`REPEATABLE_READ` | æ§åˆ¶å¹¶å‘è¯»å†™ |
| `timeout` | äº‹åŠ¡è¶…æ—¶æ—¶é—´ | ç§’æ•°ï¼Œå¦‚`30` | é˜²æ­¢é•¿æ—¶é—´å ç”¨èµ„æº |
| `readOnly` | åªè¯»äº‹åŠ¡ | `true`/`false` | æŸ¥è¯¢æ“ä½œè®¾ä¸ºtrueä¼˜åŒ–æ€§èƒ½ |
| `rollbackFor` | å›æ»šå¼‚å¸¸ç±»å‹ | `Exception.class` | æŒ‡å®šå“ªäº›å¼‚å¸¸å›æ»š |
| `noRollbackFor` | ä¸å›æ»šå¼‚å¸¸ | `CustomException.class` | æŒ‡å®šå“ªäº›å¼‚å¸¸ä¸å›æ»š |

### 5.2 readOnlyåªè¯»äº‹åŠ¡


**ä»€ä¹ˆæ˜¯åªè¯»äº‹åŠ¡**ï¼š
- å‘Šè¯‰æ•°æ®åº“è¿™ä¸ªäº‹åŠ¡åªæŸ¥è¯¢ï¼Œä¸ä¿®æ”¹æ•°æ®
- æ•°æ®åº“å¯ä»¥åšä¼˜åŒ–ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
- å¦‚æœå°è¯•ä¿®æ”¹æ•°æ®ä¼šæŠ¥é”™

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
@Service
public class UserService {
    
    // æŸ¥è¯¢æ“ä½œï¼šè®¾ç½®ä¸ºåªè¯»
    @Transactional(readOnly = true)
    public User getUserById(Long id) {
        return userDao.findById(id);
    }
    
    // ä¿®æ”¹æ“ä½œï¼šä¸èƒ½è®¾ä¸ºåªè¯»
    @Transactional(readOnly = false)  // æˆ–è€…ä¸å†™ï¼Œé»˜è®¤false
    public void updateUser(User user) {
        userDao.update(user);
    }
}
```

**æ€§èƒ½ä¼˜åŒ–æ•ˆæœ**ï¼š
```
åªè¯»äº‹åŠ¡çš„å¥½å¤„ï¼š
âœ… æ•°æ®åº“ä¸éœ€è¦åŠ å†™é”
âœ… ä¸éœ€è¦è®°å½•undoæ—¥å¿—
âœ… æŸ¥è¯¢æ€§èƒ½æå‡10%-30%
```

### 5.3 timeoutè¶…æ—¶è®¾ç½®


**ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶æ§åˆ¶**ï¼š

```
åœºæ™¯ï¼šç”¨æˆ·ä¸‹å•æ“ä½œ
- æ­£å¸¸æƒ…å†µï¼š0.5ç§’å®Œæˆ
- å¼‚å¸¸æƒ…å†µï¼šæ•°æ®åº“æ­»é”ï¼Œä¸€ç›´ç­‰å¾…

å¦‚æœä¸è®¾è¶…æ—¶ï¼š
âŒ çº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œå ç”¨èµ„æº
âŒ ç”¨æˆ·ä½“éªŒå·®ï¼Œé¡µé¢ä¸€ç›´è½¬åœˆ
âŒ å¯èƒ½å¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½

è®¾ç½®è¶…æ—¶åï¼š
âœ… è¶…è¿‡è®¾å®šæ—¶é—´è‡ªåŠ¨å›æ»š
âœ… é‡Šæ”¾èµ„æºï¼Œé¿å…é˜»å¡
âœ… å¿«é€Ÿå¤±è´¥ï¼Œè¿”å›é”™è¯¯æç¤º
```

**é…ç½®ç¤ºä¾‹**ï¼š

```java
// è®¾ç½®30ç§’è¶…æ—¶
@Transactional(timeout = 30)
public void processOrder(Order order) {
    // å¦‚æœ30ç§’å†…æ²¡å®Œæˆï¼Œè‡ªåŠ¨å›æ»šå¹¶æŠ›å‡ºå¼‚å¸¸
    orderDao.save(order);
    inventoryDao.reduce(order.getProductId(), order.getQuantity());
}
```

### 5.4 rollbackForå¼‚å¸¸æ§åˆ¶


**é»˜è®¤å›æ»šè§„åˆ™**ï¼š
```
é»˜è®¤æƒ…å†µï¼š
âœ… RuntimeExceptionåŠå…¶å­ç±» â†’ å›æ»š
âœ… ErroråŠå…¶å­ç±» â†’ å›æ»š  
âŒ å—æ£€å¼‚å¸¸ï¼ˆChecked Exceptionï¼‰ â†’ ä¸å›æ»š
```

**ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰**ï¼š

```java
// é—®é¢˜åœºæ™¯
@Transactional
public void updateUser(User user) throws IOException {
    userDao.update(user);
    fileService.uploadAvatar(user.getId());  // å¯èƒ½æŠ›å‡ºIOException
}

// IOExceptionæ˜¯å—æ£€å¼‚å¸¸ï¼Œé»˜è®¤ä¸å›æ»š
// å¦‚æœä¸Šä¼ å¤±è´¥ï¼Œç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼Œä½†å¤´åƒæœªä¸Šä¼  â†’ æ•°æ®ä¸ä¸€è‡´ï¼

// è§£å†³æ–¹æ¡ˆï¼šæŒ‡å®šIOExceptionä¹Ÿè¦å›æ»š
@Transactional(rollbackFor = Exception.class)  // æ‰€æœ‰å¼‚å¸¸éƒ½å›æ»š
public void updateUser(User user) throws IOException {
    userDao.update(user);
    fileService.uploadAvatar(user.getId());
}
```

**å®ç”¨é…ç½®å»ºè®®**ï¼š

```java
// æ¨èé…ç½®ï¼šè®©æ‰€æœ‰å¼‚å¸¸éƒ½å›æ»šï¼Œæ›´å®‰å…¨
@Transactional(rollbackFor = Exception.class)

// å¦‚æœæœ‰ç‰¹æ®Šå¼‚å¸¸ä¸éœ€è¦å›æ»š
@Transactional(
    rollbackFor = Exception.class,
    noRollbackFor = CustomBusinessException.class  // ä¸šåŠ¡å¼‚å¸¸ä¸å›æ»š
)
```

---

## 6. ğŸ”„ äº‹åŠ¡ä¼ æ’­å±æ€§


### 6.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ä¼ æ’­


**æ ¸å¿ƒé—®é¢˜**ï¼šå½“ä¸€ä¸ªå¸¦äº‹åŠ¡çš„æ–¹æ³•è°ƒç”¨å¦ä¸€ä¸ªå¸¦äº‹åŠ¡çš„æ–¹æ³•ï¼Œäº‹åŠ¡è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ

**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
åœºæ™¯ï¼šå…¬å¸éƒ¨é—¨åä½œ

æƒ…å†µ1ï¼šé”€å”®éƒ¨å·²ç»å¼€äº†ä¼šï¼ˆæœ‰äº‹åŠ¡ï¼‰
      å«æŠ€æœ¯éƒ¨è¿‡æ¥å‚ä¸è®¨è®ºï¼ˆè°ƒç”¨å¸¦äº‹åŠ¡æ–¹æ³•ï¼‰
      â†’ æŠ€æœ¯éƒ¨åŠ å…¥è¿™ä¸ªä¼šï¼Ÿè¿˜æ˜¯å¦å¼€ä¸€ä¸ªä¼šï¼Ÿ

æƒ…å†µ2ï¼šæŠ€æœ¯éƒ¨è‡ªå·±åœ¨å¼€ä¼šï¼ˆæœ‰äº‹åŠ¡ï¼‰
      é”€å”®éƒ¨æ¥æ‰¾ï¼ˆè°ƒç”¨æ–¹æ³•ï¼‰
      â†’ æŠ€æœ¯éƒ¨æš‚åœè‡ªå·±çš„ä¼šï¼Œå‚åŠ é”€å”®éƒ¨çš„ä¼šï¼Ÿ
```

### 6.2 ä¸ƒç§ä¼ æ’­è¡Œä¸º


**ä¼ æ’­è¡Œä¸ºå¯¹ç…§è¡¨**ï¼š

| ä¼ æ’­è¡Œä¸º | **å«ä¹‰** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|-------------|
| `REQUIRED` ğŸ”¥ | æœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±æ–°å»ºï¼ˆé»˜è®¤ï¼‰ | æœ€å¸¸ç”¨ï¼Œ95%çš„åœºæ™¯ |
| `REQUIRES_NEW` | æ€»æ˜¯å¼€å¯æ–°äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ | ç‹¬ç«‹äº‹åŠ¡ï¼Œå¦‚æ—¥å¿—è®°å½• |
| `SUPPORTS` | æœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±ä¸ç”¨äº‹åŠ¡ | å¯æœ‰å¯æ— çš„æ“ä½œ |
| `NOT_SUPPORTED` | ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ | ä¸éœ€è¦äº‹åŠ¡çš„æ“ä½œ |
| `MANDATORY` | å¿…é¡»åœ¨äº‹åŠ¡ä¸­è¿è¡Œï¼Œå¦åˆ™æŠ›å¼‚å¸¸ | å¼ºåˆ¶äº‹åŠ¡çš„åœºæ™¯ |
| `NEVER` | ä¸èƒ½åœ¨äº‹åŠ¡ä¸­è¿è¡Œï¼Œå¦åˆ™æŠ›å¼‚å¸¸ | ä¸¥ç¦äº‹åŠ¡çš„æ“ä½œ |
| `NESTED` | åµŒå¥—äº‹åŠ¡ï¼Œå¯ä»¥ç‹¬ç«‹å›æ»š | éƒ¨åˆ†å›æ»šçš„åœºæ™¯ |

### 6.3 REQUIREDï¼ˆé»˜è®¤ï¼Œæœ€å¸¸ç”¨ï¼‰


**å·¥ä½œåŸç†**ï¼š
```
æ–¹æ³•Aï¼ˆæœ‰äº‹åŠ¡ï¼‰è°ƒç”¨ æ–¹æ³•Bï¼ˆREQUIREDï¼‰
â†“
æ–¹æ³•BåŠ å…¥æ–¹æ³•Açš„äº‹åŠ¡
â†“
Aå’ŒBåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­
â†“
ä»»ä½•ä¸€ä¸ªå¤±è´¥ï¼Œå…¨éƒ¨å›æ»š
```

**ä»£ç ç¤ºä¾‹**ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private InventoryService inventoryService;
    
    // æ–¹æ³•Aï¼šæœ‰äº‹åŠ¡
    @Transactional
    public void createOrder(Order order) {
        orderDao.save(order);  // ä¿å­˜è®¢å•
        
        // è°ƒç”¨æ–¹æ³•B
        inventoryService.reduceStock(order.getProductId(), order.getQuantity());
        
        // Aå’ŒBåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œä»»ä½•ä¸€ä¸ªå¤±è´¥éƒ½å›æ»š
    }
}

@Service
public class InventoryService {
    
    // æ–¹æ³•Bï¼šREQUIREDï¼ˆé»˜è®¤ï¼‰
    @Transactional(propagation = Propagation.REQUIRED)
    public void reduceStock(Long productId, Integer quantity) {
        inventoryDao.reduce(productId, quantity);
    }
}
```

**æ‰§è¡Œæµç¨‹**ï¼š
```
1. createOrderå¼€å¯äº‹åŠ¡T1
2. ä¿å­˜è®¢å•ï¼ˆåœ¨T1ä¸­ï¼‰
3. è°ƒç”¨reduceStock
4. reduceStockå‘ç°å·²æœ‰äº‹åŠ¡T1ï¼ŒåŠ å…¥T1
5. å‡åº“å­˜ï¼ˆåœ¨T1ä¸­ï¼‰
6. æäº¤T1ï¼ˆè®¢å•å’Œåº“å­˜ä¸€èµ·æäº¤ï¼‰

å¦‚æœå‡åº“å­˜å¤±è´¥ï¼š
â†’ T1å›æ»š
â†’ è®¢å•å’Œåº“å­˜éƒ½å›æ»š
```

### 6.4 REQUIRES_NEWï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼‰


**å·¥ä½œåŸç†**ï¼š
```
æ–¹æ³•Aï¼ˆæœ‰äº‹åŠ¡T1ï¼‰è°ƒç”¨ æ–¹æ³•Bï¼ˆREQUIRES_NEWï¼‰
â†“
æ–¹æ³•BæŒ‚èµ·T1ï¼Œåˆ›å»ºæ–°äº‹åŠ¡T2
â†“
æ–¹æ³•Båœ¨T2ä¸­æ‰§è¡Œ
â†“
T2æäº¤/å›æ»šï¼Œä¸å½±å“T1
```

**å…¸å‹åœºæ™¯ï¼šæ—¥å¿—è®°å½•**

```java
@Service
public class OrderService {
    
    @Autowired
    private LogService logService;
    
    @Transactional
    public void createOrder(Order order) {
        try {
            orderDao.save(order);
            
            // è®°å½•æ—¥å¿—ï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼‰
            logService.log("è®¢å•åˆ›å»ºæˆåŠŸ");
            
        } catch (Exception e) {
            // å³ä½¿è®¢å•å¤±è´¥å›æ»šï¼Œæ—¥å¿—ä¹Ÿè¦ä¿å­˜
            logService.log("è®¢å•åˆ›å»ºå¤±è´¥: " + e.getMessage());
            throw e;
        }
    }
}

@Service
public class LogService {
    
    // ç‹¬ç«‹äº‹åŠ¡ï¼šæ— è®ºå¤–éƒ¨äº‹åŠ¡å¦‚ä½•ï¼Œæ—¥å¿—éƒ½è¦ä¿å­˜
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void log(String message) {
        logDao.save(new SystemLog(message));
    }
}
```

**æ‰§è¡Œæµç¨‹**ï¼š
```
1. createOrderå¼€å¯äº‹åŠ¡T1
2. ä¿å­˜è®¢å•ï¼ˆåœ¨T1ä¸­ï¼‰
3. è°ƒç”¨logæ–¹æ³•
4. logæ–¹æ³•æŒ‚èµ·T1ï¼Œå¼€å¯æ–°äº‹åŠ¡T2
5. ä¿å­˜æ—¥å¿—ï¼ˆåœ¨T2ä¸­ï¼‰
6. T2æäº¤ï¼ˆæ—¥å¿—ä¿å­˜æˆåŠŸï¼‰
7. æ¢å¤T1
8. T1æäº¤ï¼ˆè®¢å•ä¿å­˜æˆåŠŸï¼‰

å¦‚æœè®¢å•å¤±è´¥ï¼š
â†’ T1å›æ»šï¼ˆè®¢å•å›æ»šï¼‰
â†’ T2å·²æäº¤ï¼ˆæ—¥å¿—ä¿ç•™ï¼‰âœ…
```

### 6.5 NESTEDï¼ˆåµŒå¥—äº‹åŠ¡ï¼‰


**å·¥ä½œåŸç†**ï¼š
```
æ–¹æ³•Aï¼ˆæœ‰äº‹åŠ¡T1ï¼‰è°ƒç”¨ æ–¹æ³•Bï¼ˆNESTEDï¼‰
â†“
æ–¹æ³•Båˆ›å»ºä¿å­˜ç‚¹ï¼ˆSavepointï¼‰
â†“
Bå¤±è´¥ï¼šå›æ»šåˆ°ä¿å­˜ç‚¹ï¼ŒAå¯ç»§ç»­
Aå¤±è´¥ï¼šå…¨éƒ¨å›æ»š
```

**åº”ç”¨åœºæ™¯ï¼šç§¯åˆ†èµ é€**

```java
@Service
public class OrderService {
    
    @Autowired
    private PointService pointService;
    
    @Transactional
    public void createOrder(Order order) {
        // ä¿å­˜è®¢å•ï¼ˆå¿…é¡»æˆåŠŸï¼‰
        orderDao.save(order);
        
        try {
            // èµ é€ç§¯åˆ†ï¼ˆå¯ä»¥å¤±è´¥ï¼‰
            pointService.grantPoints(order.getUserId(), 100);
        } catch (Exception e) {
            // ç§¯åˆ†èµ é€å¤±è´¥ï¼Œä¸å½±å“è®¢å•åˆ›å»º
            log.error("ç§¯åˆ†èµ é€å¤±è´¥", e);
        }
        
        // è®¢å•åˆ›å»ºæˆåŠŸ
    }
}

@Service
public class PointService {
    
    @Transactional(propagation = Propagation.NESTED)
    public void grantPoints(Long userId, Integer points) {
        pointDao.add(userId, points);
    }
}
```

**ä¸REQUIRES_NEWçš„åŒºåˆ«**ï¼š

| ç‰¹æ€§ | **NESTED** | **REQUIRES_NEW** |
|-----|-----------|------------------|
| **äº‹åŠ¡ç‹¬ç«‹æ€§** | éƒ¨åˆ†ç‹¬ç«‹ï¼ˆæœ‰ä¿å­˜ç‚¹ï¼‰ | å®Œå…¨ç‹¬ç«‹ï¼ˆæ–°äº‹åŠ¡ï¼‰ |
| **å­äº‹åŠ¡å¤±è´¥** | å¯ä»¥å›æ»šåˆ°ä¿å­˜ç‚¹ï¼Œçˆ¶äº‹åŠ¡ç»§ç»­ | ä¸å½±å“çˆ¶äº‹åŠ¡ |
| **çˆ¶äº‹åŠ¡å¤±è´¥** | å…¨éƒ¨å›æ»š | ä¸å½±å“å­äº‹åŠ¡ï¼ˆå·²æäº¤ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | å¯é€‰æ“ä½œï¼ˆå¦‚ç§¯åˆ†ï¼‰ | å¿…é¡»è®°å½•ï¼ˆå¦‚æ—¥å¿—ï¼‰ |

---

## 7. âš ï¸ å¼‚å¸¸å¤„ç†æœºåˆ¶


### 7.1 äº‹åŠ¡å›æ»šçš„å¼‚å¸¸è§„åˆ™


**é»˜è®¤å›æ»šè§„åˆ™è¯¦è§£**ï¼š

```
Springäº‹åŠ¡å›æ»šè§„åˆ™ï¼š

âœ… ä¼šå›æ»šçš„å¼‚å¸¸ï¼š
- RuntimeExceptionï¼ˆè¿è¡Œæ—¶å¼‚å¸¸ï¼‰
- Errorï¼ˆé”™è¯¯ï¼‰
- å®ƒä»¬çš„æ‰€æœ‰å­ç±»

âŒ ä¸ä¼šå›æ»šçš„å¼‚å¸¸ï¼š
- Exceptionï¼ˆå—æ£€å¼‚å¸¸ï¼Œé™¤äº†RuntimeExceptionï¼‰
- IOException, SQLExceptionç­‰
```

**å¼‚å¸¸åˆ†ç±»å›¾**ï¼š
```
                Throwable
                /        \
            Error      Exception
            (å›æ»š)     /        \
                RuntimeException  å…¶ä»–Exception
                   (å›æ»š)         (ä¸å›æ»š)
                   
å¸¸è§RuntimeExceptionï¼š
- NullPointerException
- IllegalArgumentException  
- ArithmeticException

å¸¸è§å—æ£€Exceptionï¼š
- IOException
- SQLException
- ClassNotFoundException
```

### 7.2 è‡ªå®šä¹‰å›æ»šè§„åˆ™


**åœºæ™¯1ï¼šè®©å—æ£€å¼‚å¸¸ä¹Ÿå›æ»š**

```java
@Service
public class FileService {
    
    // âŒ é»˜è®¤ä¸å›æ»šIOException
    @Transactional
    public void uploadFile(File file) throws IOException {
        fileDao.saveMetadata(file);
        fileStorage.upload(file);  // å¯èƒ½æŠ›IOException
    }
    
    // âœ… è®©IOExceptionä¹Ÿå›æ»š
    @Transactional(rollbackFor = Exception.class)
    public void uploadFile(File file) throws IOException {
        fileDao.saveMetadata(file);
        fileStorage.upload(file);
    }
}
```

**åœºæ™¯2ï¼šä¸šåŠ¡å¼‚å¸¸ä¸å›æ»š**

```java
// è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸
public class BusinessException extends RuntimeException {
    public BusinessException(String message) {
        super(message);
    }
}

@Service
public class OrderService {
    
    // ä¸šåŠ¡å¼‚å¸¸ä¸å›æ»šï¼Œå…¶ä»–å¼‚å¸¸å›æ»š
    @Transactional(
        rollbackFor = Exception.class,
        noRollbackFor = BusinessException.class
    )
    public void createOrder(Order order) {
        if (order.getAmount() < 0) {
            // æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸ï¼Œä¸å›æ»š
            throw new BusinessException("è®¢å•é‡‘é¢ä¸èƒ½ä¸ºè´Ÿ");
        }
        
        orderDao.save(order);
        
        // å¦‚æœè¿™é‡Œå‡ºç°å…¶ä»–å¼‚å¸¸ï¼Œä¼šå›æ»š
        inventoryDao.reduce(order.getProductId());
    }
}
```

### 7.3 å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ


**æ¨èåšæ³•**ï¼š

```java
@Service
public class UserService {
    
    @Transactional(rollbackFor = Exception.class)
    public void registerUser(User user) {
        try {
            // 1. å‚æ•°æ ¡éªŒ
            if (user == null || user.getName() == null) {
                throw new IllegalArgumentException("å‚æ•°ä¸èƒ½ä¸ºç©º");
            }
            
            // 2. ä¸šåŠ¡æ£€æŸ¥
            if (userDao.existsByName(user.getName())) {
                throw new BusinessException("ç”¨æˆ·åå·²å­˜åœ¨");
            }
            
            // 3. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            userDao.save(user);
            
            // 4. å‘é€é€šçŸ¥ï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼Œå¤±è´¥ä¸å½±å“æ³¨å†Œï¼‰
            notificationService.sendWelcomeEmail(user.getEmail());
            
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—ï¼Œé‡æ–°æŠ›å‡º
            log.warn("ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage());
            throw e;
        } catch (Exception e) {
            // ç³»ç»Ÿå¼‚å¸¸ï¼Œè®°å½•è¯¦ç»†æ—¥å¿—ï¼ŒåŒ…è£…åæŠ›å‡º
            log.error("æ³¨å†Œç”¨æˆ·å¤±è´¥", e);
            throw new SystemException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•", e);
        }
    }
}
```

### 7.4 äº‹åŠ¡å¤±æ•ˆçš„å¸¸è§é™·é˜±


**é™·é˜±1ï¼šè‡ªè°ƒç”¨å¯¼è‡´äº‹åŠ¡å¤±æ•ˆ**

```java
@Service
public class UserService {
    
    // âŒ é”™è¯¯ï¼šæ–¹æ³•Aè°ƒç”¨æ–¹æ³•Bï¼ŒBçš„äº‹åŠ¡ä¸ç”Ÿæ•ˆ
    public void methodA() {
        // ç›´æ¥è°ƒç”¨ï¼Œä¸ç»è¿‡Springä»£ç†
        this.methodB();  // äº‹åŠ¡å¤±æ•ˆï¼
    }
    
    @Transactional
    public void methodB() {
        userDao.save(new User());
    }
    
    // âœ… æ­£ç¡®ï¼šé€šè¿‡å¦ä¸€ä¸ªServiceè°ƒç”¨
    @Autowired
    private UserService self;  // æ³¨å…¥è‡ªå·±
    
    public void methodA() {
        self.methodB();  // äº‹åŠ¡ç”Ÿæ•ˆï¼
    }
}
```

**é™·é˜±2ï¼šå¼‚å¸¸è¢«æ•è·æœªæŠ›å‡º**

```java
@Service
public class UserService {
    
    // âŒ é”™è¯¯ï¼šå¼‚å¸¸è¢«åƒæ‰ï¼Œä¸ä¼šå›æ»š
    @Transactional
    public void updateUser(User user) {
        try {
            userDao.update(user);
        } catch (Exception e) {
            log.error("æ›´æ–°å¤±è´¥", e);
            // å¼‚å¸¸è¢«æ•è·ï¼Œäº‹åŠ¡ä¸ä¼šå›æ»šï¼
        }
    }
    
    // âœ… æ­£ç¡®ï¼šé‡æ–°æŠ›å‡ºå¼‚å¸¸
    @Transactional
    public void updateUser(User user) {
        try {
            userDao.update(user);
        } catch (Exception e) {
            log.error("æ›´æ–°å¤±è´¥", e);
            throw e;  // é‡æ–°æŠ›å‡ºï¼Œè§¦å‘å›æ»š
        }
    }
}
```

**é™·é˜±3ï¼šæ–¹æ³•ä¸æ˜¯public**

```java
@Service
public class UserService {
    
    // âŒ é”™è¯¯ï¼šprivateæ–¹æ³•ï¼Œäº‹åŠ¡ä¸ç”Ÿæ•ˆ
    @Transactional
    private void updateUser(User user) {
        userDao.update(user);
    }
    
    // âœ… æ­£ç¡®ï¼špublicæ–¹æ³•
    @Transactional
    public void updateUser(User user) {
        userDao.update(user);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„çŸ¥è¯†ç‚¹


**é…ç½®ä¸‰ä»¶å¥—**ï¼š
```
1ï¸âƒ£ LocalSessionFactoryBean â†’ åˆ›å»ºSessionFactory
2ï¸âƒ£ HibernateTransactionManager â†’ ç®¡ç†äº‹åŠ¡
3ï¸âƒ£ @EnableTransactionManagement â†’ å¼€å¯äº‹åŠ¡æ”¯æŒ
```

**@Transactionalæ ¸å¿ƒé…ç½®**ï¼š

| é…ç½®é¡¹ | **æ¨èå€¼** | **è®°å¿†è¦ç‚¹** |
|-------|-----------|-------------|
| `propagation` | `REQUIRED` | 95%åœºæ™¯ç”¨é»˜è®¤å€¼ |
| `isolation` | `READ_COMMITTED` | çœ‹æ•°æ®åº“é»˜è®¤å€¼ |
| `readOnly` | æŸ¥è¯¢ç”¨`true` | ä¼˜åŒ–æ€§èƒ½ |
| `rollbackFor` | `Exception.class` | æ‰€æœ‰å¼‚å¸¸éƒ½å›æ»šæ›´å®‰å…¨ |
| `timeout` | `30ç§’` | é˜²æ­¢é•¿æ—¶é—´é˜»å¡ |

### 8.2 äº‹åŠ¡ä¼ æ’­è®°å¿†å£è¯€


```
REQUIREDæœ€å¸¸ç”¨ï¼Œæœ‰å°±åŠ å…¥æ— å°±å»º
REQUIRES_NEWè¦ç‹¬ç«‹ï¼Œæ—¥å¿—è®°å½•å®ƒæœ€è¡Œ  
NESTEDå¯åµŒå¥—ï¼Œéƒ¨åˆ†å›æ»šä¸å½±å“
SUPPORTSéšå¤§æµï¼Œæœ‰æ— äº‹åŠ¡éƒ½èƒ½èµ°
```

### 8.3 å¸¸è§é—®é¢˜è‡ªæŸ¥æ¸…å•


**é—®é¢˜æ’æŸ¥æ­¥éª¤**ï¼š

```
âœ… äº‹åŠ¡ä¸ç”Ÿæ•ˆæ£€æŸ¥ï¼š
1. æ˜¯å¦åŠ äº†@EnableTransactionManagementï¼Ÿ
2. æ–¹æ³•æ˜¯publicå—ï¼Ÿ
3. æ˜¯è‡ªè°ƒç”¨å—ï¼ˆthis.method()ï¼‰ï¼Ÿ
4. å¼‚å¸¸è¢«æ•è·äº†å—ï¼Ÿ

âœ… äº‹åŠ¡ä¸å›æ»šæ£€æŸ¥ï¼š
1. æŠ›çš„æ˜¯å—æ£€å¼‚å¸¸å—ï¼Ÿ
2. rollbackForé…ç½®äº†å—ï¼Ÿ
3. å¼‚å¸¸è¢«catchä½æ²¡æŠ›å‡ºï¼Ÿ

âœ… äº‹åŠ¡éš”ç¦»é—®é¢˜æ£€æŸ¥ï¼š
1. éš”ç¦»çº§åˆ«è®¾ç½®äº†å—ï¼Ÿ
2. æ•°æ®åº“æ”¯æŒè¿™ä¸ªçº§åˆ«å—ï¼Ÿ
3. æ˜¯å¦æœ‰è„è¯»ã€ä¸å¯é‡å¤è¯»ï¼Ÿ
```

### 8.4 æœ€ä½³å®è·µå»ºè®®


**å¼€å‘è§„èŒƒ**ï¼š

```java
// æ¨èçš„Serviceå±‚å†™æ³•
@Service
@Transactional(readOnly = true)  // ç±»çº§åˆ«é»˜è®¤åªè¯»
public class UserService {
    
    // æŸ¥è¯¢æ–¹æ³•ï¼šç»§æ‰¿ç±»çº§åˆ«çš„åªè¯»äº‹åŠ¡
    public User findById(Long id) {
        return userDao.findById(id);
    }
    
    // ä¿®æ”¹æ–¹æ³•ï¼šè¦†ç›–ä¸ºè¯»å†™äº‹åŠ¡
    @Transactional(rollbackFor = Exception.class)
    public void updateUser(User user) {
        userDao.update(user);
    }
    
    // å¤æ‚æ“ä½œï¼šæ˜ç¡®é…ç½®
    @Transactional(
        propagation = Propagation.REQUIRED,
        rollbackFor = Exception.class,
        timeout = 30
    )
    public void processOrder(Order order) {
        // ä¸šåŠ¡é€»è¾‘
    }
}
```

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
```
ğŸ”¸ æŸ¥è¯¢æ“ä½œï¼šè®¾ç½®readOnly=true
ğŸ”¸ æ‰¹é‡æ“ä½œï¼šæ§åˆ¶äº‹åŠ¡ç²’åº¦ï¼Œé¿å…å¤§äº‹åŠ¡
ğŸ”¸ å¼‚æ­¥ä»»åŠ¡ï¼šä¸è¦åœ¨äº‹åŠ¡æ–¹æ³•ä¸­æ‰§è¡Œ
ğŸ”¸ æ—¥å¿—è®°å½•ï¼šä½¿ç”¨REQUIRES_NEWç‹¬ç«‹äº‹åŠ¡
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Springé›†æˆHibernateï¼Œè®©äº‹åŠ¡ç®¡ç†å˜ç®€å•
- @Transactionalæ˜¯æ ¸å¿ƒï¼Œé…ç½®è¦è®°ç‰¢
- ä¼ æ’­è¡Œä¸ºREQUIREDæœ€å¸¸ç”¨ï¼Œç‹¬ç«‹äº‹åŠ¡ç”¨REQUIRES_NEW
- å¼‚å¸¸å¤„ç†è¦å°å¿ƒï¼Œé»˜è®¤åªå›æ»šè¿è¡Œæ—¶å¼‚å¸¸
- è‡ªè°ƒç”¨ã€ç§æœ‰æ–¹æ³•ã€æ•è·å¼‚å¸¸éƒ½ä¼šè®©äº‹åŠ¡å¤±æ•ˆ