---
title: 27ã€çŠ¶æ€è½¬æ¢æ“ä½œ
---
## ğŸ“š ç›®å½•

1. [çŠ¶æ€è½¬æ¢æ ¸å¿ƒæ¦‚å¿µ](#1-çŠ¶æ€è½¬æ¢æ ¸å¿ƒæ¦‚å¿µ)
2. [save()ä¿å­˜æ“ä½œ](#2-saveä¿å­˜æ“ä½œ)
3. [update()æ›´æ–°æ“ä½œ](#3-updateæ›´æ–°æ“ä½œ)
4. [merge()åˆå¹¶æ“ä½œ](#4-mergeåˆå¹¶æ“ä½œ)
5. [delete()åˆ é™¤æ“ä½œ](#5-deleteåˆ é™¤æ“ä½œ)
6. [çŠ¶æ€è½¬æ¢æœ€ä½³å®è·µ](#6-çŠ¶æ€è½¬æ¢æœ€ä½³å®è·µ)

---

## 1. ğŸ¯ çŠ¶æ€è½¬æ¢æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¯¹è±¡çŠ¶æ€è½¬æ¢


**é€šä¿—ç†è§£**ï¼š
```
å°±åƒç‰©å“çš„ä»“å‚¨ç®¡ç†ï¼š
- ä¸´æ—¶æ€(Transient)   = å•†å“åœ¨ä»“åº“å¤–ï¼Œè¿˜æ²¡å…¥åº“ç™»è®°
- æŒä¹…æ€(Persistent)  = å•†å“å·²å…¥åº“ï¼Œç³»ç»Ÿå®æ—¶è·Ÿè¸ª
- æ¸¸ç¦»æ€(Detached)    = å•†å“æ›¾å…¥åº“ä½†ç°åœ¨ä¸åœ¨ç³»ç»Ÿç›‘æ§ä¸­
- åˆ é™¤æ€(Removed)     = å•†å“æ ‡è®°ä¸ºå¾…æ¸…ç†

Hibernateçš„æ–¹æ³•å°±æ˜¯æ§åˆ¶è¿™äº›çŠ¶æ€è½¬æ¢çš„"å¼€å…³"
```

### 1.2 çŠ¶æ€è½¬æ¢å…¨æ™¯å›¾


```
        ä¸´æ—¶æ€å¯¹è±¡
         (Transient)
              |
              | save()
              | persist()
              â†“
         æŒä¹…æ€å¯¹è±¡  â†â”€â”€â”€â”€â”€â”€â”€â”€ update()
        (Persistent)          merge()
              |                 â†‘
              | evict()         |
              | close()      saveOrUpdate()
              â†“                 |
         æ¸¸ç¦»æ€å¯¹è±¡  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         (Detached)
              |
              | delete()
              â†“
         åˆ é™¤æ€å¯¹è±¡
         (Removed)
```

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦ç†è§£çŠ¶æ€è½¬æ¢


**æ ¸å¿ƒä»·å€¼**ï¼š
- âœ… **é¿å…å¼‚å¸¸**ï¼šçŸ¥é“ä»€ä¹ˆæ—¶å€™èƒ½ç”¨ä»€ä¹ˆæ–¹æ³•
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šé€‰æ‹©åˆé€‚çš„æ–¹æ³•å‡å°‘æ•°æ®åº“æ“ä½œ
- âœ… **ä¸šåŠ¡æ­£ç¡®**ï¼šç¡®ä¿æ•°æ®æŒ‰é¢„æœŸä¿å­˜å’Œæ›´æ–°
- âœ… **é—®é¢˜æ’æŸ¥**ï¼šå¿«é€Ÿå®šä½çŠ¶æ€ç›¸å…³çš„bug

---

## 2. ğŸ’¾ save()ä¿å­˜æ“ä½œ


### 2.1 save()æ–¹æ³•çš„ä½œç”¨


**æœ¬è´¨å«ä¹‰**ï¼š
- å°†**ä¸´æ—¶æ€**å¯¹è±¡è½¬ä¸º**æŒä¹…æ€**
- ç«‹å³åˆ†é…æ•°æ®åº“ä¸»é”®ID
- å¹¶ä¸æ˜¯ç«‹åˆ»æ‰§è¡ŒINSERTï¼Œè€Œæ˜¯ç­‰äº‹åŠ¡æäº¤æ—¶

**é€šä¿—ç±»æ¯”**ï¼š
```
åƒç½‘è´­ä¸‹å•ï¼š
1. ä½ åœ¨è´­ç‰©è½¦é€‰å•†å“ â†’ ä¸´æ—¶æ€å¯¹è±¡
2. ç‚¹å‡»"æäº¤è®¢å•" â†’ save()æ–¹æ³•
3. ç³»ç»Ÿç”Ÿæˆè®¢å•å· â†’ åˆ†é…ä¸»é”®ID
4. è®¢å•è¿›å…¥ç³»ç»Ÿè·Ÿè¸ª â†’ å¯¹è±¡å˜ä¸ºæŒä¹…æ€
5. ä»˜æ¬¾æ—¶æ‰çœŸæ­£æ‰£æ¬¾ â†’ äº‹åŠ¡æäº¤æ—¶æ‰§è¡ŒINSERT
```

### 2.2 save()çŠ¶æ€è½¬æ¢è¿‡ç¨‹


```java
// åˆ›å»ºä¸´æ—¶æ€å¯¹è±¡
User user = new User();
user.setName("å¼ ä¸‰");
user.setAge(25);
// æ­¤æ—¶ï¼šuseræ˜¯ä¸´æ—¶æ€ï¼Œæ²¡æœ‰IDï¼ŒHibernateä¸ç®¡ç†

Session session = sessionFactory.openSession();
Transaction tx = session.beginTransaction();

// æ‰§è¡Œsave()
Serializable id = session.save(user);  
// è½¬æ¢å‘ç”Ÿï¼šä¸´æ—¶æ€ â†’ æŒä¹…æ€
// â‘  åˆ†é…IDï¼šuser.getId()ç°åœ¨æœ‰å€¼äº†
// â‘¡ çº³å…¥ç®¡ç†ï¼šHibernateå¼€å§‹è·Ÿè¸ªè¿™ä¸ªå¯¹è±¡
// â‘¢ æ ‡è®°å¾…æ’å…¥ï¼šç­‰äº‹åŠ¡æäº¤æ—¶æ‰§è¡ŒINSERT

System.out.println("åˆ†é…çš„ID: " + id);  // æ¯”å¦‚è¾“å‡ºï¼š1

tx.commit();  // è¿™æ—¶æ‰çœŸæ­£æ‰§è¡Œ INSERT INTO user...
session.close();
```

**çŠ¶æ€å˜åŒ–ç»†èŠ‚**ï¼š
```
æ‰§è¡Œå‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸´æ—¶æ€å¯¹è±¡   â”‚
â”‚  id = null   â”‚  â† Hibernateä¸è®¤è¯†
â”‚ name = "å¼ ä¸‰" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰§è¡Œsave()åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŒä¹…æ€å¯¹è±¡   â”‚
â”‚   id = 1     â”‚  â† Hibernateåˆ†é…çš„ID
â”‚ name = "å¼ ä¸‰" â”‚  â† Hibernateå¼€å§‹ç›‘æ§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   [ä¸€çº§ç¼“å­˜ä¸­]
        â†“
   commit()æ—¶æ‰§è¡Œ
   INSERTè¯­å¥
```

### 2.3 save()çš„ç‰¹æ®Šè¡Œä¸º


**â‘  ä¸»é”®ç”Ÿæˆç­–ç•¥å½±å“**

| ç­–ç•¥ç±»å‹ | save()æ—¶çš„è¡Œä¸º | è¯´æ˜ |
|---------|---------------|------|
| **assigned** | éœ€è¦æ‰‹åŠ¨è®¾ç½®ID | ä¸ä¼šè‡ªåŠ¨åˆ†é…ï¼Œå¿…é¡»å…ˆ`setId()` |
| **identity** | ç«‹å³æ‰§è¡ŒINSERT | MySQLè‡ªå¢ï¼Œéœ€è¦é©¬ä¸Šæ’å…¥è·å–ID |
| **sequence** | æŸ¥è¯¢åºåˆ—è·å–ID | Oracle/PostgreSQLï¼Œå…ˆæŸ¥åºåˆ— |
| **uuid** | ç”ŸæˆUUIDå­—ç¬¦ä¸² | ä¸ä¾èµ–æ•°æ®åº“ï¼Œç›´æ¥ç”Ÿæˆ |

**â‘¡ çº§è”ä¿å­˜**
```java
// éƒ¨é—¨å¯¹è±¡(å·²æŒä¹…åŒ–)
Department dept = session.get(Department.class, 1);

// æ–°å‘˜å·¥(ä¸´æ—¶æ€)
Employee emp = new Employee();
emp.setName("æå››");
emp.setDepartment(dept);  // å…³è”éƒ¨é—¨

session.save(emp);  
// å¦‚æœé…ç½®äº†cascade="save-update"
// ä¼šè‡ªåŠ¨ä¿å­˜å…³è”çš„ä¸´æ—¶æ€å¯¹è±¡
```

### 2.4 save()å¸¸è§é—®é¢˜


**â— é—®é¢˜1ï¼šé‡å¤saveå·²æŒä¹…åŒ–å¯¹è±¡**
```java
User user = new User("ç‹äº”");
session.save(user);       // ç¬¬ä¸€æ¬¡saveï¼Œæ­£å¸¸
session.save(user);       // ç¬¬äºŒæ¬¡saveï¼ŒæŠ›å¼‚å¸¸ï¼
// NonUniqueObjectExceptionï¼šå·²ç»å­˜åœ¨ç›¸åŒæ ‡è¯†çš„æŒä¹…åŒ–å¯¹è±¡
```

**â— é—®é¢˜2ï¼šsaveæ¸¸ç¦»æ€å¯¹è±¡**
```java
User user = new User();
user.setId(100);  // æ‰‹åŠ¨è®¾ç½®ID
session.save(user);  
// å¦‚æœID=100å·²å­˜åœ¨ â†’ ä¸»é”®å†²çªå¼‚å¸¸
// åº”è¯¥ç”¨update()æˆ–merge()
```

---

## 3. ğŸ”„ update()æ›´æ–°æ“ä½œ


### 3.1 update()æ–¹æ³•çš„ä½œç”¨


**æœ¬è´¨å«ä¹‰**ï¼š
- å°†**æ¸¸ç¦»æ€**å¯¹è±¡é‡æ–°å˜ä¸º**æŒä¹…æ€**
- å‘Šè¯‰Hibernateï¼š"è¿™ä¸ªå¯¹è±¡çš„æ•°æ®å˜äº†ï¼Œè®°å¾—æ›´æ–°åˆ°æ•°æ®åº“"
- ç­‰äº‹åŠ¡æäº¤æ—¶æ‰§è¡ŒUPDATEè¯­å¥

**é€šä¿—ç±»æ¯”**ï¼š
```
åƒå¿«é€’åŒ…è£¹ï¼š
1. åŒ…è£¹ç¦»å¼€ä»“åº“ â†’ å¯¹è±¡å˜æ¸¸ç¦»æ€
2. åŒ…è£¹ä¿¡æ¯å˜äº†(åœ°å€æ”¹äº†) â†’ ä¿®æ”¹æ¸¸ç¦»æ€å¯¹è±¡å±æ€§
3. é‡æ–°å…¥åº“ç™»è®° â†’ update()æ–¹æ³•
4. ç³»ç»Ÿæ›´æ–°åŒ…è£¹ä¿¡æ¯ â†’ æ‰§è¡ŒUPDATEè¯­å¥
```

### 3.2 update()çŠ¶æ€è½¬æ¢è¿‡ç¨‹


```java
Session session1 = sessionFactory.openSession();
Transaction tx1 = session1.beginTransaction();

// æŸ¥è¯¢å¾—åˆ°æŒä¹…æ€å¯¹è±¡
User user = session1.get(User.class, 1);
// userç°åœ¨æ˜¯æŒä¹…æ€

tx1.commit();
session1.close();
// sessionå…³é—­ï¼Œuserå˜ä¸ºæ¸¸ç¦»æ€

// ========== åˆ†ç•Œçº¿ ==========

// ä¿®æ”¹æ¸¸ç¦»æ€å¯¹è±¡
user.setName("æ–°åå­—");  // åªæ”¹äº†å†…å­˜ï¼Œæ•°æ®åº“ä¸çŸ¥é“

Session session2 = sessionFactory.openSession();
Transaction tx2 = session2.beginTransaction();

// æ‰§è¡Œupdate()
session2.update(user);
// è½¬æ¢å‘ç”Ÿï¼šæ¸¸ç¦»æ€ â†’ æŒä¹…æ€
// â‘  é‡æ–°çº³å…¥ç®¡ç†
// â‘¡ æ ‡è®°ä¸ºå·²ä¿®æ”¹
// â‘¢ ç­‰æäº¤æ—¶æ‰§è¡ŒUPDATE

tx2.commit();  // è¿™æ—¶æ‰§è¡Œ UPDATE user SET name='æ–°åå­—' WHERE id=1
session2.close();
```

**çŠ¶æ€å˜åŒ–å›¾ç¤º**ï¼š
```
æ¸¸ç¦»æ€å¯¹è±¡(ä¿®æ”¹å‰)         update()        æŒä¹…æ€å¯¹è±¡(å·²è·Ÿè¸ª)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”€â”€â”€â”€â†’        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   id = 1     â”‚                      â”‚   id = 1     â”‚
â”‚ name="æ—§å"   â”‚                      â”‚ name="æ–°åå­—" â”‚
â”‚ [æœªè¢«è·Ÿè¸ª]    â”‚                      â”‚ [è¢«ç›‘æ§ä¸­]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â†“
                                        commit()æ—¶
                                        æ‰§è¡ŒUPDATE
```

### 3.3 update()çš„æ›´æ–°ç­–ç•¥


**â‘  å…¨å­—æ®µæ›´æ–° vs éƒ¨åˆ†å­—æ®µæ›´æ–°**

é»˜è®¤æƒ…å†µï¼š
```sql
-- update()é»˜è®¤æ›´æ–°æ‰€æœ‰å­—æ®µ
UPDATE user SET name=?, age=?, email=?, update_time=? WHERE id=?
-- å³ä½¿åªæ”¹äº†nameï¼Œå…¶ä»–å­—æ®µä¹Ÿä¼šSET
```

ä¼˜åŒ–é…ç½®ï¼š
```xml
<!-- å®ä½“ç±»é…ç½® -->
<class name="User" table="user" dynamic-update="true">
    <!-- å¼€å¯åŠ¨æ€æ›´æ–°ï¼Œåªæ›´æ–°ä¿®æ”¹è¿‡çš„å­—æ®µ -->
</class>
```

```sql
-- dynamic-update="true"å
UPDATE user SET name=? WHERE id=?
-- åªæ›´æ–°å®é™…ä¿®æ”¹çš„å­—æ®µ
```

**â‘¡ æ›´æ–°æ£€æŸ¥æœºåˆ¶**

| å±æ€§é…ç½® | ä½œç”¨ | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|
| `select-before-update="false"` | ä¸æ£€æŸ¥ï¼Œç›´æ¥æ›´æ–° | **é»˜è®¤**ï¼Œæ€§èƒ½å¥½ |
| `select-before-update="true"` | å…ˆSELECTæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–° | é¿å…æ— æ„ä¹‰UPDATE |

### 3.4 update()å¸¸è§é—®é¢˜


**â— é—®é¢˜1ï¼šupdateä¸´æ—¶æ€å¯¹è±¡**
```java
User user = new User();  // ä¸´æ—¶æ€ï¼Œæ²¡æœ‰ID
user.setName("èµµå…­");
session.update(user);    // æŠ›å¼‚å¸¸ï¼
// TransientObjectExceptionï¼šä¸´æ—¶æ€å¯¹è±¡ä¸èƒ½update
// è§£å†³ï¼šç”¨save()æˆ–è€…å…ˆè®¾ç½®ID
```

**â— é—®é¢˜2ï¼šupdateå·²æŒä¹…åŒ–å¯¹è±¡**
```java
User user = session.get(User.class, 1);  // å·²ç»æ˜¯æŒä¹…æ€
user.setName("å­™ä¸ƒ");
session.update(user);  // æŠ›å¼‚å¸¸ï¼
// NonUniqueObjectExceptionï¼šå·²å­˜åœ¨ç›¸åŒIDçš„æŒä¹…æ€å¯¹è±¡
```

**â— é—®é¢˜3ï¼šå¤šä¸ªSessionçš„updateå†²çª**
```java
// Session1ä¸­çš„æŒä¹…æ€å¯¹è±¡
Session s1 = factory.openSession();
User user1 = s1.get(User.class, 1);

// Session2ä¸­updateåŒä¸€ä¸ªå¯¹è±¡
Session s2 = factory.openSession();
User user2 = new User();
user2.setId(1);
user2.setName("æ–°å€¼");
s2.update(user2);  // å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

// è§£å†³ï¼šç”¨merge()
```

---

## 4. ğŸ”€ merge()åˆå¹¶æ“ä½œ


### 4.1 merge()æ–¹æ³•çš„ä½œç”¨


**æœ¬è´¨å«ä¹‰**ï¼š
- æ™ºèƒ½åˆå¹¶å¯¹è±¡çŠ¶æ€ï¼Œä¸ç®¡æ˜¯ä¸´æ—¶æ€è¿˜æ˜¯æ¸¸ç¦»æ€
- å¦‚æœæ•°æ®åº“æœ‰è¿™æ¡è®°å½• â†’ æ›´æ–°
- å¦‚æœæ•°æ®åº“æ²¡æœ‰ â†’ æ’å…¥
- è¿”å›ä¸€ä¸ªæ–°çš„æŒä¹…æ€å¯¹è±¡

**é€šä¿—ç±»æ¯”**ï¼š
```
åƒGitçš„mergeæ“ä½œï¼š
1. ä½ æœ¬åœ°æ”¹äº†ä»£ç (æ¸¸ç¦»æ€å¯¹è±¡)
2. è¿œç¨‹ä»“åº“ä¹Ÿå¯èƒ½æœ‰æ–°æ”¹åŠ¨(æ•°æ®åº“æ•°æ®)
3. æ‰§è¡Œmerge â†’ æ™ºèƒ½åˆå¹¶ä¸¤è¾¹çš„ä¿®æ”¹
4. ç”Ÿæˆæœ€ç»ˆç‰ˆæœ¬(è¿”å›æ–°çš„æŒä¹…æ€å¯¹è±¡)
```

### 4.2 merge()å·¥ä½œæµç¨‹


```java
Session session = sessionFactory.openSession();
Transaction tx = session.beginTransaction();

// æ¸¸ç¦»æ€å¯¹è±¡
User detachedUser = new User();
detachedUser.setId(1);
detachedUser.setName("åˆå¹¶çš„åå­—");

// æ‰§è¡Œmerge()
User persistentUser = (User) session.merge(detachedUser);

// æ³¨æ„ï¼šdetachedUserä»æ˜¯æ¸¸ç¦»æ€
// persistentUseræ˜¯æ–°çš„æŒä¹…æ€å¯¹è±¡

tx.commit();
session.close();
```

**merge()å†…éƒ¨é€»è¾‘**ï¼š
```
                merge(æ¸¸ç¦»æ€å¯¹è±¡)
                        â†“
                æŸ¥æ•°æ®åº“æœ‰æ²¡æœ‰è¿™ä¸ªID
                        â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â†“                         â†“
    æ•°æ®åº“æœ‰è®°å½•              æ•°æ®åº“æ²¡æœ‰è®°å½•
           â†“                         â†“
   SELECTæŸ¥è¯¢å‡ºæŒä¹…æ€å¯¹è±¡        åˆ›å»ºæ–°çš„æŒä¹…æ€å¯¹è±¡
           â†“                         â†“
   æŠŠæ¸¸ç¦»æ€æ•°æ®å¤åˆ¶è¿‡å»            å¤åˆ¶æ¸¸ç¦»æ€æ•°æ®
           â†“                         â†“
 æ ‡è®°ä¸ºdirtyå¾…UPDATE           æ ‡è®°ä¸ºå¾…INSERT
           â†“                         â†“
           â””â”€â”€â”€â”€â”€â”€â”€â”€ è¿”å›æŒä¹…æ€å¯¹è±¡ â”€â”˜
                        â†“
                commit()æ—¶æ‰§è¡ŒSQL
```

### 4.3 merge() vs update()å¯¹æ¯”


| ç‰¹æ€§ | **merge()** | **update()** |
|------|------------|--------------|
| ğŸ¯ **å¤„ç†å¯¹è±¡** | ä¸´æ—¶æ€ã€æ¸¸ç¦»æ€éƒ½å¯ä»¥ | åªèƒ½æ¸¸ç¦»æ€ |
| ğŸ”„ **è¿”å›å€¼** | è¿”å›æ–°çš„æŒä¹…æ€å¯¹è±¡ | æ— è¿”å›å€¼(void) |
| ğŸ’¾ **æ•°æ®åº“æ“ä½œ** | å…ˆSELECTåUPDATE/INSERT | ç›´æ¥UPDATE |
| âš ï¸ **å¼‚å¸¸é£é™©** | ä¸ä¼šæŠ›NonUniqueObject | å¯èƒ½æŠ›å¼‚å¸¸ |
| ğŸ“Š **æ€§èƒ½** | å¤šä¸€æ¬¡SELECTæŸ¥è¯¢ | ç›´æ¥UPDATEï¼Œå¿« |
| ğŸ“ **é€‚ç”¨åœºæ™¯** | Webå±‚ä¼ æ¥çš„å¯¹è±¡ | ç¡®å®šæ˜¯æ¸¸ç¦»æ€æ—¶ |

**ä½¿ç”¨å»ºè®®**ï¼š
```
â†’ å‰ç«¯ä¼ æ¥çš„å¯¹è±¡ï¼ŒIDä¸ç¡®å®šå­˜ä¸å­˜åœ¨ â†’ ç”¨merge()
â†’ æ˜ç¡®æ˜¯ä»æ•°æ®åº“æŸ¥å‡ºæ¥çš„æ¸¸ç¦»æ€å¯¹è±¡ â†’ ç”¨update()
â†’ åˆ†å¸ƒå¼ç³»ç»Ÿæ¥æ”¶åˆ°çš„å¯¹è±¡ â†’ ç”¨merge()
```

### 4.4 merge()å…¸å‹åœºæ™¯


**åœºæ™¯1ï¼šWebå±‚å¯¹è±¡ä¿å­˜**
```java
// Controlleræ¥æ”¶å‰ç«¯æ•°æ®
@PostMapping("/user/save")
public String saveUser(User user) {  // useræ˜¯ä¸´æ—¶æ€æˆ–æ¸¸ç¦»æ€
    Session session = getSession();
    Transaction tx = session.beginTransaction();
    
    // ä¸ç¡®å®šuser.getId()æ˜¯å¦å­˜åœ¨äºæ•°æ®åº“
    session.merge(user);  // å®‰å…¨ï¼è‡ªåŠ¨åˆ¤æ–­INSERTæˆ–UPDATE
    
    tx.commit();
    return "success";
}
```

**åœºæ™¯2ï¼šåˆ†ç¦»å¯¹è±¡çš„åŒæ­¥**
```java
// Session1ï¼šæŸ¥è¯¢å¯¹è±¡
Session s1 = factory.openSession();
User user = s1.get(User.class, 1);
s1.close();  // userå˜æ¸¸ç¦»

// ä¸šåŠ¡é€»è¾‘å¤„ç†...
user.setAge(30);

// Session2ï¼šåŒæ­¥ä¿®æ”¹
Session s2 = factory.openSession();
Transaction tx = s2.beginTransaction();

User merged = (User) s2.merge(user);  // å®‰å…¨åˆå¹¶
// mergedæ˜¯æŒä¹…æ€ï¼Œuserä»æ˜¯æ¸¸ç¦»æ€

tx.commit();
s2.close();
```

### 4.5 merge()æ³¨æ„äº‹é¡¹


**âš ï¸ å…³é”®ç‚¹1ï¼šè¿”å›å€¼å¿…é¡»ä½¿ç”¨**
```java
User user = new User();
user.setId(1);
session.merge(user);  // âŒ é”™è¯¯ï¼ä¸¢å¼ƒäº†è¿”å›å€¼
user.getName();       // userä»æ˜¯æ¸¸ç¦»æ€ï¼Œåç»­æ“ä½œæ— æ•ˆ

// âœ… æ­£ç¡®å†™æ³•
User persistent = (User) session.merge(user);
persistent.getName();  // ç”¨è¿”å›çš„æŒä¹…æ€å¯¹è±¡
```

**âš ï¸ å…³é”®ç‚¹2ï¼šçº§è”åˆå¹¶**
```xml
<!-- é…ç½®çº§è” -->
<many-to-one name="department" cascade="merge">
    <!-- éƒ¨é—¨ä¹Ÿä¼šè¢«merge -->
</many-to-one>
```

```java
User user = new User();
Department dept = new Department();  // æ¸¸ç¦»æ€éƒ¨é—¨
user.setDepartment(dept);

session.merge(user);  // å¦‚æœé…ç½®cascadeï¼Œdeptä¹Ÿä¼šè¢«merge
```

---

## 5. ğŸ—‘ï¸ delete()åˆ é™¤æ“ä½œ


### 5.1 delete()æ–¹æ³•çš„ä½œç”¨


**æœ¬è´¨å«ä¹‰**ï¼š
- å°†å¯¹è±¡æ ‡è®°ä¸º**åˆ é™¤æ€**
- ç­‰äº‹åŠ¡æäº¤æ—¶æ‰§è¡ŒDELETEè¯­å¥
- å¯ä»¥åˆ é™¤æŒä¹…æ€æˆ–æ¸¸ç¦»æ€å¯¹è±¡

**é€šä¿—ç±»æ¯”**ï¼š
```
åƒåˆ é™¤æ–‡ä»¶åˆ°å›æ”¶ç«™ï¼š
1. æŒä¹…æ€å¯¹è±¡ = æ­£å¸¸æ–‡ä»¶
2. delete() = æ”¾å…¥å›æ”¶ç«™(åˆ é™¤æ€)
3. commit() = æ¸…ç©ºå›æ”¶ç«™(çœŸæ­£åˆ é™¤)
```

### 5.2 delete()çŠ¶æ€è½¬æ¢è¿‡ç¨‹


**â‘  åˆ é™¤æŒä¹…æ€å¯¹è±¡**
```java
Session session = sessionFactory.openSession();
Transaction tx = session.beginTransaction();

User user = session.get(User.class, 1);  // æŒä¹…æ€
session.delete(user);  
// è½¬æ¢ï¼šæŒä¹…æ€ â†’ åˆ é™¤æ€
// â‘  ä»ä¸€çº§ç¼“å­˜ç§»é™¤
// â‘¡ æ ‡è®°ä¸ºå¾…åˆ é™¤
// â‘¢ ç­‰commit()æ—¶æ‰§è¡ŒDELETE

tx.commit();  // æ‰§è¡Œ DELETE FROM user WHERE id=1
session.close();
```

**â‘¡ åˆ é™¤æ¸¸ç¦»æ€å¯¹è±¡**
```java
// å…ˆæŸ¥è¯¢å†å…³é—­session
Session s1 = factory.openSession();
User user = s1.get(User.class, 1);
s1.close();  // userå˜æ¸¸ç¦»æ€

// æ–°sessionä¸­åˆ é™¤
Session s2 = factory.openSession();
Transaction tx = s2.beginTransaction();

s2.delete(user);  
// æ¸¸ç¦»æ€ â†’ åˆ é™¤æ€
// Hibernateä¼šå…ˆSELECTç¡®è®¤å­˜åœ¨ï¼Œå†æ ‡è®°åˆ é™¤

tx.commit();  // æ‰§è¡ŒDELETE
s2.close();
```

**çŠ¶æ€å˜åŒ–å›¾**ï¼š
```
æŒä¹…æ€å¯¹è±¡              delete()           åˆ é™¤æ€å¯¹è±¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”€â”€â”€â”€â†’        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   id = 1     â”‚                    â”‚   id = 1     â”‚
â”‚ name="å¼ ä¸‰"   â”‚                    â”‚ [å¾…åˆ é™¤]      â”‚
â”‚ [ç¼“å­˜ä¸­]      â”‚                    â”‚ [å·²ç§»å‡ºç¼“å­˜]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â†“
                                      commit()æ—¶
                                      æ‰§è¡ŒDELETE
```

### 5.3 delete()çš„åˆ é™¤ç­–ç•¥


**â‘  ç›´æ¥åˆ é™¤ vs çº§è”åˆ é™¤**

é…ç½®çº§è”åˆ é™¤ï¼š
```xml
<class name="Department">
    <set name="employees" cascade="delete">
        <!-- åˆ é™¤éƒ¨é—¨æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤æ‰€æœ‰å‘˜å·¥ -->
    </set>
</class>
```

```java
Department dept = session.get(Department.class, 1);
session.delete(dept);
// å¦‚æœé…ç½®cascade="delete"
// ä¼šè‡ªåŠ¨æ‰§è¡Œï¼š
// DELETE FROM employee WHERE dept_id=1
// DELETE FROM department WHERE id=1
```

**â‘¡ å­¤å„¿åˆ é™¤**
```xml
<set name="employees" cascade="all-delete-orphan">
    <!-- ä»é›†åˆä¸­ç§»é™¤çš„å¯¹è±¡ä¹Ÿä¼šè¢«åˆ é™¤ -->
</set>
```

```java
Department dept = session.get(Department.class, 1);
dept.getEmployees().remove(someEmployee);  
// å‘˜å·¥ä»é›†åˆç§»é™¤åï¼Œä¼šè¢«è‡ªåŠ¨delete
```

### 5.4 delete()å…¸å‹åœºæ™¯


**åœºæ™¯1ï¼šæ‰¹é‡åˆ é™¤**
```java
// æ–¹å¼1ï¼šé€ä¸ªdelete(ä½æ•ˆ)
List<User> users = session.createQuery("from User").list();
for (User user : users) {
    session.delete(user);  // Næ¡DELETEè¯­å¥
}

// æ–¹å¼2ï¼šHQLæ‰¹é‡åˆ é™¤(æ¨è)
session.createQuery("delete from User").executeUpdate();
// ä¸€æ¡DELETEè¯­å¥æå®š
```

**åœºæ™¯2ï¼šè½¯åˆ é™¤**
```java
// ä¸æ‰§è¡ŒçœŸæ­£çš„DELETEï¼Œè€Œæ˜¯æ›´æ–°æ ‡å¿—ä½
User user = session.get(User.class, 1);
user.setDeleted(true);  // æ ‡è®°åˆ é™¤
// æŒä¹…æ€è‡ªåŠ¨æ›´æ–°ï¼Œæ‰§è¡ŒUPDATEè€ŒéDELETE
```

**åœºæ™¯3ï¼šçº§è”åˆ é™¤æ§åˆ¶**
```java
// åˆ é™¤éƒ¨é—¨å‰å…ˆè§£é™¤å‘˜å·¥å…³è”
Department dept = session.get(Department.class, 1);
for (Employee emp : dept.getEmployees()) {
    emp.setDepartment(null);  // è§£é™¤å…³è”
}
session.delete(dept);  // åªåˆ é™¤éƒ¨é—¨ï¼Œä¸åˆ å‘˜å·¥
```

### 5.5 delete()å¸¸è§é—®é¢˜


**â— é—®é¢˜1ï¼šåˆ é™¤ä¸´æ—¶æ€å¯¹è±¡**
```java
User user = new User();  // ä¸´æ—¶æ€
session.delete(user);    // æŠ›å¼‚å¸¸ï¼
// TransientObjectExceptionï¼šä¸´æ—¶æ€å¯¹è±¡ä¸èƒ½åˆ é™¤
```

**â— é—®é¢˜2ï¼šå¤–é”®çº¦æŸå†²çª**
```java
Department dept = session.get(Department.class, 1);
// deptä¸‹è¿˜æœ‰å‘˜å·¥è®°å½•
session.delete(dept);  
// å¯èƒ½æŠ›å¼‚å¸¸ï¼šConstraintViolationException
// è¿åå¤–é”®çº¦æŸï¼Œä¸èƒ½åˆ é™¤æœ‰å…³è”çš„è®°å½•
```

**â— é—®é¢˜3ï¼šåˆ é™¤åå†è®¿é—®**
```java
User user = session.get(User.class, 1);
session.delete(user);
user.getName();  // å¯ä»¥è®¿é—®ï¼Œå†…å­˜ä¸­è¿˜æœ‰æ•°æ®

tx.commit();     // æ‰§è¡ŒDELETEå
user.getName();  // ä»å¯è®¿é—®ï¼Œä½†å¯¹è±¡å·²æ˜¯"åƒµå°¸çŠ¶æ€"
```

---

## 6. âœ… çŠ¶æ€è½¬æ¢æœ€ä½³å®è·µ


### 6.1 æ–¹æ³•é€‰æ‹©å†³ç­–æ ‘


```
         éœ€è¦æ“ä½œå¯¹è±¡ï¼Ÿ
              |
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                   â†“
  æ–°å»ºå¯¹è±¡            å·²æœ‰å¯¹è±¡
    |                   |
 save()          â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
 persist()       â†“             â†“
              ç¡®å®šæ¸¸ç¦»       ä¸ç¡®å®šçŠ¶æ€
                |               |
             update()        merge()
              
         éœ€è¦åˆ é™¤ï¼Ÿ
              |
         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
         â†“         â†“
      å•ä¸ªåˆ é™¤   æ‰¹é‡åˆ é™¤
         |         |
     delete()   HQLæ‰¹é‡
```

### 6.2 æ ¸å¿ƒåŸåˆ™æ€»ç»“


**â‘  æ–¹æ³•é€‚ç”¨æ€§åŸåˆ™**

| æ“ä½œ | æœ€ä½³é€‰æ‹© | è¯´æ˜ |
|------|---------|------|
| ğŸ†• **æ–°å¢æ•°æ®** | `save()` | ä¸´æ—¶æ€â†’æŒä¹…æ€ï¼Œåˆ†é…ID |
| ğŸ”„ **æ›´æ–°æ•°æ®** | `update()` | æ¸¸ç¦»æ€â†’æŒä¹…æ€ï¼Œç›´æ¥æ›´æ–° |
| ğŸ”€ **æ™ºèƒ½ä¿å­˜** | `merge()` | ä¸ç¡®å®šçŠ¶æ€æ—¶å®‰å…¨é€‰æ‹© |
| ğŸ—‘ï¸ **åˆ é™¤æ•°æ®** | `delete()` | æŒä¹…æ€/æ¸¸ç¦»æ€â†’åˆ é™¤æ€ |
| ğŸ“¦ **æ‰¹é‡æ“ä½œ** | `HQL/Criteria` | é¿å…é€ä¸ªæ“ä½œæ€§èƒ½å·® |

**â‘¡ æ€§èƒ½ä¼˜åŒ–åŸåˆ™**

```
âœ… ä¼˜å…ˆä½¿ç”¨æŒä¹…æ€å¯¹è±¡è‡ªåŠ¨åŒæ­¥
   User user = session.get(User.class, 1);
   user.setName("æ–°åå­—");  // è‡ªåŠ¨UPDATEï¼Œæ— éœ€è°ƒç”¨update()

âœ… æ‰¹é‡æ“ä½œç”¨HQL
   session.createQuery("update User set status=1").executeUpdate();
   // ä¸€æ¡SQLå®Œæˆï¼Œä¸è¦å¾ªç¯update()

âœ… åˆç†é…ç½®dynamic-update
   <class dynamic-update="true">  <!-- åªæ›´æ–°ä¿®æ”¹å­—æ®µ -->

âœ… é¿å…ä¸å¿…è¦çš„merge()
   æ˜ç¡®æ˜¯æ¸¸ç¦»æ€æ—¶ï¼Œç”¨update()æ›´å¿«
```

**â‘¢ å¼‚å¸¸é¿å…åŸåˆ™**

```
âŒ ä¸è¦å¯¹åŒä¸€å¯¹è±¡é‡å¤save()
âŒ ä¸è¦å¯¹æŒä¹…æ€å¯¹è±¡è°ƒç”¨update()
âŒ ä¸è¦å¯¹ä¸´æ—¶æ€å¯¹è±¡è°ƒç”¨update()
âŒ ä¸è¦å¿½ç•¥merge()çš„è¿”å›å€¼

âœ… ä½¿ç”¨å‰æ£€æŸ¥å¯¹è±¡çŠ¶æ€
âœ… ä¸ç¡®å®šçŠ¶æ€æ—¶ç”¨merge()
âœ… åˆ é™¤å‰æ£€æŸ¥å¤–é”®çº¦æŸ
âœ… åˆç†é…ç½®çº§è”æ“ä½œ
```

### 6.3 å®æˆ˜ä»£ç æ¨¡æ¿


**æ¨¡æ¿1ï¼šé€šç”¨ä¿å­˜/æ›´æ–°**
```java
public void saveOrUpdate(User user) {
    Session session = getSession();
    Transaction tx = session.beginTransaction();
    
    try {
        if (user.getId() == null) {
            // IDä¸ºç©ºï¼Œè‚¯å®šæ˜¯æ–°å¢
            session.save(user);
        } else {
            // IDæœ‰å€¼ï¼Œåˆå¹¶å¤„ç†
            session.merge(user);
        }
        tx.commit();
    } catch (Exception e) {
        tx.rollback();
        throw e;
    } finally {
        session.close();
    }
}
```

**æ¨¡æ¿2ï¼šå®‰å…¨åˆ é™¤**
```java
public void safeDelete(Integer id) {
    Session session = getSession();
    Transaction tx = session.beginTransaction();
    
    try {
        User user = session.get(User.class, id);
        if (user != null) {
            // æ£€æŸ¥æ˜¯å¦æœ‰å…³è”æ•°æ®
            if (user.getOrders().isEmpty()) {
                session.delete(user);
            } else {
                // è½¯åˆ é™¤æˆ–æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸
                user.setDeleted(true);
            }
        }
        tx.commit();
    } catch (Exception e) {
        tx.rollback();
        throw e;
    } finally {
        session.close();
    }
}
```

**æ¨¡æ¿3ï¼šæ‰¹é‡æ›´æ–°**
```java
public void batchUpdate(List<User> users) {
    Session session = getSession();
    Transaction tx = session.beginTransaction();
    
    try {
        int count = 0;
        for (User user : users) {
            session.update(user);
            
            // æ¯20æ¡åˆ·æ–°ä¸€æ¬¡ï¼Œé¿å…å†…å­˜æº¢å‡º
            if (++count % 20 == 0) {
                session.flush();
                session.clear();
            }
        }
        tx.commit();
    } catch (Exception e) {
        tx.rollback();
        throw e;
    } finally {
        session.close();
    }
}
```

### 6.4 æ ¸å¿ƒè®°å¿†è¦ç‚¹


```
ğŸ“Œ çŠ¶æ€è½¬æ¢å£è¯€ï¼š
   saveæ–°å¢åˆ†é…IDï¼Œupdateæ¸¸ç¦»é‡ç®¡ç†
   mergeæ™ºèƒ½èƒ½åˆå¹¶ï¼Œdeleteæ ‡è®°ç­‰æäº¤

ğŸ“Œ æ–¹æ³•é€‰æ‹©è¯€çªï¼š
   æ–°å»ºç”¨saveï¼Œæ›´æ–°ç”¨update
   ä¸ç¡®å®šç”¨mergeï¼Œåˆ é™¤ç”¨delete

ğŸ“Œ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹ï¼š
   æŒä¹…æ€è‡ªåŠ¨åŒæ­¥ï¼Œæ‰¹é‡æ“ä½œç”¨HQL
   é…ç½®åŠ¨æ€æ›´æ–°ï¼Œé¿å…é‡å¤æ“ä½œ

ğŸ“Œ å¼‚å¸¸é¢„é˜²ï¼š
   æ£€æŸ¥å¯¹è±¡çŠ¶æ€ï¼Œä¸è¦é‡å¤save
   mergeè®°å¾—è¿”å›ï¼Œåˆ é™¤æŸ¥å¤–é”®
```

---

## ğŸ’¡ æ€»ç»“


**æœ¬ç« æ ¸å¿ƒæŒæ¡ç‚¹**ï¼š
1. âœ… ç†è§£å››å¤§æ–¹æ³•çš„çŠ¶æ€è½¬æ¢é€»è¾‘
2. âœ… æŒæ¡save/update/merge/deleteçš„åŒºåˆ«å’Œé€‰æ‹©
3. âœ… ç†Ÿæ‚‰å¸¸è§å¼‚å¸¸åœºæ™¯å’Œè§£å†³æ–¹æ¡ˆ
4. âœ… èƒ½æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©æœ€ä¼˜æ–¹æ³•
5. âœ… æŒæ¡æ€§èƒ½ä¼˜åŒ–å’Œæœ€ä½³å®è·µ

**ä¸‹ä¸€ç« é¢„å‘Š**ï¼šHibernateæŸ¥è¯¢æœºåˆ¶ï¼ˆHQL/Criteria/åŸç”ŸSQLï¼‰