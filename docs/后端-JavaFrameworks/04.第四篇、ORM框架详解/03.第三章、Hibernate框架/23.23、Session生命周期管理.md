---
title: 23ã€Sessionç”Ÿå‘½å‘¨æœŸç®¡ç†
---
## ğŸ“š ç›®å½•

1. [Sessionæ ¸å¿ƒæ¦‚å¿µ](#1-Sessionæ ¸å¿ƒæ¦‚å¿µ)
2. [Sessionçš„åˆ›å»ºä¸å…³é—­](#2-Sessionçš„åˆ›å»ºä¸å…³é—­)
3. [Sessionç”Ÿå‘½å‘¨æœŸè¯¦è§£](#3-Sessionç”Ÿå‘½å‘¨æœŸè¯¦è§£)
4. [çº¿ç¨‹ç»‘å®šæœºåˆ¶](#4-çº¿ç¨‹ç»‘å®šæœºåˆ¶)
5. [getCurrentSessionè¯¦è§£](#5-getCurrentSessionè¯¦è§£)
6. [openSessionè¯¦è§£](#6-openSessionè¯¦è§£)
7. [ä¼šè¯ç®¡ç†æœ€ä½³å®è·µ](#7-ä¼šè¯ç®¡ç†æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Sessionæ ¸å¿ƒæ¦‚å¿µ


### 1.1 Sessionæ˜¯ä»€ä¹ˆ


**ç”¨ç”Ÿæ´»åŒ–çš„æ¯”å–»æ¥ç†è§£**ï¼š

æƒ³è±¡ä½ å»å›¾ä¹¦é¦†å€Ÿä¹¦ï¼ŒSessionå°±åƒæ˜¯ä½ å’Œå›¾ä¹¦é¦†ä¹‹é—´çš„"å€Ÿé˜…å…³ç³»"ï¼š

```
ğŸ“š å›¾ä¹¦é¦†å€Ÿä¹¦æµç¨‹ï¼š
1. è¿›é¦†ç™»è®°ï¼ˆåˆ›å»ºSessionï¼‰
2. å€Ÿä¹¦è¿˜ä¹¦ï¼ˆæ•°æ®åº“æ“ä½œï¼‰
3. ç¦»é¦†æ³¨é”€ï¼ˆå…³é—­Sessionï¼‰

ğŸ’» Hibernate Sessionï¼š
1. æ‰“å¼€ä¼šè¯ï¼ˆè·å–Sessionï¼‰
2. å¢åˆ æ”¹æŸ¥ï¼ˆæ“ä½œå®ä½“å¯¹è±¡ï¼‰
3. å…³é—­ä¼šè¯ï¼ˆé‡Šæ”¾èµ„æºï¼‰
```

**Sessionçš„æœ¬è´¨ä½œç”¨**ï¼š

```
ğŸ”¸ Sessionæ˜¯ä»€ä¹ˆï¼š
â€¢ åº”ç”¨ç¨‹åºä¸æ•°æ®åº“ä¹‹é—´çš„"æ¡¥æ¢"
â€¢ ç®¡ç†æŒä¹…åŒ–å¯¹è±¡çš„"å®¹å™¨"
â€¢ æ‰§è¡Œæ•°æ®åº“æ“ä½œçš„"å·¥ä½œå°"

ğŸ”¸ Sessionä¸æ˜¯ä»€ä¹ˆï¼š
â€¢ ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆä¸èƒ½å¤šçº¿ç¨‹å…±äº«ï¼‰
â€¢ ä¸æ˜¯é•¿æœŸå­˜åœ¨çš„ï¼ˆç”¨å®Œå°±å…³ï¼‰
â€¢ ä¸æ˜¯æ•°æ®åº“è¿æ¥æœ¬èº«ï¼ˆå®ƒç®¡ç†è¿æ¥ï¼‰
```

### 1.2 Sessionåœ¨Hibernateä¸­çš„ä½ç½®


**æ¶æ„å±‚æ¬¡ç†è§£**ï¼š

```
åº”ç”¨ç¨‹åºå±‚
    â†“ è°ƒç”¨
Sessionæ¥å£ï¼ˆä¼šè¯ç®¡ç†å™¨ï¼‰
    â†“ ç®¡ç†
æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼ˆä¸€çº§ç¼“å­˜ï¼‰
    â†“ ä½¿ç”¨
æ•°æ®åº“è¿æ¥ï¼ˆJDBC Connectionï¼‰
    â†“ è®¿é—®
å®é™…æ•°æ®åº“
```

**ğŸ”„ Sessionä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»**ï¼š

| ç»„ä»¶ | **å…³ç³»è¯´æ˜** | **ç”Ÿå‘½å‘¨æœŸ** |
|------|------------|------------|
| **SessionFactory** | `Sessionçš„å·¥å‚ç±»ï¼Œåˆ›å»ºSession` | `åº”ç”¨çº§åˆ«ï¼Œå¯åŠ¨æ—¶åˆ›å»ºï¼Œå…³é—­æ—¶é”€æ¯` |
| **Session** | `æ‰§è¡Œæ•°æ®åº“æ“ä½œçš„å®ä¾‹` | `è¯·æ±‚çº§åˆ«ï¼Œç”¨å®Œå³å…³` |
| **Transaction** | `Sessionå†…çš„äº‹åŠ¡ç®¡ç†` | `Sessionç”Ÿå‘½å‘¨æœŸå†…` |
| **Query/Criteria** | `Sessionåˆ›å»ºçš„æŸ¥è¯¢å¯¹è±¡` | `éšSessionå…³é—­è€Œå¤±æ•ˆ` |

---

## 2. ğŸš€ Sessionçš„åˆ›å»ºä¸å…³é—­


### 2.1 Sessionåˆ›å»ºæ–¹å¼


Hibernateæä¾›äº†ä¸¤ç§ä¸»è¦çš„Sessionè·å–æ–¹å¼ï¼Œå®ƒä»¬å°±åƒæ˜¯ä¸¤ç§ä¸åŒçš„"å€Ÿä¹¦æ–¹å¼"ï¼š

**ğŸ“‹ ä¸¤ç§åˆ›å»ºæ–¹å¼å¯¹æ¯”**ï¼š

```
æ–¹å¼ä¸€ï¼šopenSession()
å°±åƒï¼šæ¯æ¬¡éƒ½åŠæ–°çš„å€Ÿä¹¦å¡
ç‰¹ç‚¹ï¼šæ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºå…¨æ–°Session

æ–¹å¼äºŒï¼šgetCurrentSession()  
å°±åƒï¼šä½¿ç”¨åŒä¸€å¼ å€Ÿä¹¦å¡
ç‰¹ç‚¹ï¼šåŒä¸€çº¿ç¨‹å†…å¤ç”¨åŒä¸€ä¸ªSession
```

**åŸºæœ¬åˆ›å»ºç¤ºä¾‹**ï¼š

```java
// æ–¹å¼ä¸€ï¼šæ‰‹åŠ¨åˆ›å»ºSession
Session session = sessionFactory.openSession();
try {
    // æ‰§è¡Œæ•°æ®åº“æ“ä½œ
    User user = session.get(User.class, 1L);
    System.out.println(user.getName());
} finally {
    // å¿…é¡»æ‰‹åŠ¨å…³é—­
    session.close();
}

// æ–¹å¼äºŒï¼šè·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„Session
Session session = sessionFactory.getCurrentSession();
// æ‰§è¡Œæ“ä½œ
User user = session.get(User.class, 1L);
// äº‹åŠ¡æäº¤æ—¶è‡ªåŠ¨å…³é—­ï¼Œæ— éœ€æ‰‹åŠ¨close
```

### 2.2 Sessionå…³é—­çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆå¿…é¡»å…³é—­Sessionï¼Ÿ**

```
ğŸš¨ ä¸å…³é—­Sessionçš„åæœï¼š

1. å†…å­˜æ³„æ¼ï¼š
   Session â†’ æŒæœ‰Connection â†’ å ç”¨æ•°æ®åº“è¿æ¥
   â†“
   è¿æ¥æ± è€—å°½ â†’ æ–°è¯·æ±‚æ— æ³•è·å–è¿æ¥ â†’ åº”ç”¨å¡æ­»

2. èµ„æºæµªè´¹ï¼š
   â€¢ æ•°æ®åº“è¿æ¥æ˜¯å®è´µèµ„æºï¼Œæ•°é‡æœ‰é™
   â€¢ é•¿æœŸå ç”¨å½±å“ç³»ç»Ÿæ€§èƒ½
   â€¢ å¯èƒ½å¯¼è‡´æ•°æ®åº“è¿æ¥è¶…æ—¶

3. æ•°æ®ä¸ä¸€è‡´ï¼š
   â€¢ æœªæäº¤çš„äº‹åŠ¡å¯èƒ½ä¸¢å¤±
   â€¢ ç¼“å­˜æ•°æ®ä¸æ•°æ®åº“ä¸åŒæ­¥
```

**ğŸ”§ æ­£ç¡®çš„å…³é—­æ¨¡å¼**ï¼š

```java
// âŒ é”™è¯¯åšæ³•ï¼šå¿˜è®°å…³é—­
public void badExample() {
    Session session = sessionFactory.openSession();
    User user = session.get(User.class, 1L);
    // æ–¹æ³•ç»“æŸï¼Œsessionæ²¡å…³é—­ï¼
}

// âœ… åŸºç¡€åšæ³•ï¼štry-finallyä¿è¯å…³é—­
public void basicExample() {
    Session session = sessionFactory.openSession();
    try {
        User user = session.get(User.class, 1L);
        // ä¸šåŠ¡é€»è¾‘
    } finally {
        if (session != null) {
            session.close();
        }
    }
}

// â­ æœ€ä½³åšæ³•ï¼štry-with-resourcesè‡ªåŠ¨å…³é—­
public void bestExample() {
    try (Session session = sessionFactory.openSession()) {
        User user = session.get(User.class, 1L);
        // ä»£ç å—ç»“æŸæ—¶è‡ªåŠ¨å…³é—­
    }
}
```

---

## 3. ğŸ”„ Sessionç”Ÿå‘½å‘¨æœŸè¯¦è§£


### 3.1 Sessionçš„å››ç§çŠ¶æ€


Sessionå¯¹è±¡æœ¬èº«ä¼šç»å†ä¸åŒçš„çŠ¶æ€ï¼Œç†è§£è¿™äº›çŠ¶æ€å¯¹æ­£ç¡®ä½¿ç”¨è‡³å…³é‡è¦ï¼š

**ğŸ“Š SessionçŠ¶æ€æµè½¬**ï¼š

```
çŠ¶æ€æµè½¬å›¾ï¼š
åˆ›å»º â†’ æ‰“å¼€(Open) â†’ å…³é—­(Closed) â†’ åºŸå¼ƒ
         â†“
      ä½¿ç”¨ä¸­ â† â†’ åˆ·æ–°(Flush)
```

**ğŸ”¸ è¯¦ç»†çŠ¶æ€è¯´æ˜**ï¼š

```
1. æ‰“å¼€çŠ¶æ€ï¼ˆOpenï¼‰ï¼š
   â€¢ åˆšåˆ›å»ºæˆ–è·å–çš„Session
   â€¢ å¯ä»¥æ‰§è¡Œæ•°æ®åº“æ“ä½œ
   â€¢ æŒæœ‰æ•°æ®åº“è¿æ¥ï¼ˆå¯èƒ½æ˜¯å»¶è¿Ÿè·å–ï¼‰
   
2. ä½¿ç”¨ä¸­ï¼ˆActiveï¼‰ï¼š
   â€¢ æ­£åœ¨æ‰§è¡Œæ“ä½œçš„Session
   â€¢ äº‹åŠ¡å¯èƒ½å·²å¼€å¯
   â€¢ ä¸€çº§ç¼“å­˜æ­£åœ¨å·¥ä½œ

3. åˆ·æ–°çŠ¶æ€ï¼ˆFlushingï¼‰ï¼š
   â€¢ æ­£åœ¨åŒæ­¥ç¼“å­˜åˆ°æ•°æ®åº“
   â€¢ æ‰§è¡Œflush()æˆ–äº‹åŠ¡æäº¤æ—¶
   â€¢ çŸ­æš‚çš„è¿‡æ¸¡çŠ¶æ€

4. å…³é—­çŠ¶æ€ï¼ˆClosedï¼‰ï¼š
   â€¢ Sessionå·²å…³é—­
   â€¢ ä¸èƒ½å†æ‰§è¡Œä»»ä½•æ“ä½œ
   â€¢ è¿æ¥å·²å½’è¿˜åˆ°è¿æ¥æ± 
```

### 3.2 Sessionç”Ÿå‘½å‘¨æœŸå®Œæ•´æµç¨‹


**ğŸ”„ å…¸å‹Sessionç”Ÿå‘½å‘¨æœŸ**ï¼š

```
é˜¶æ®µä¸€ï¼šåˆ›å»ºSession
sessionFactory.openSession()
    â†“
Sessionå¯¹è±¡åˆ›å»ºå®Œæˆï¼ˆå¯èƒ½è¿˜æœªè·å–è¿æ¥ï¼‰

é˜¶æ®µäºŒï¼šå¼€å¯äº‹åŠ¡
session.beginTransaction()
    â†“
ä»è¿æ¥æ± è·å–æ•°æ®åº“è¿æ¥
    â†“
å¼€å¯æ•°æ®åº“äº‹åŠ¡

é˜¶æ®µä¸‰ï¼šæ‰§è¡Œæ“ä½œ
session.save(entity)
session.get(Entity.class, id)
    â†“
æ“ä½œè¢«è®°å½•åˆ°ä¸€çº§ç¼“å­˜
    â†“
è§¦å‘flushï¼šåŒæ­¥åˆ°æ•°æ®åº“
    â†“
æ•°æ®å†™å…¥æ•°æ®åº“ï¼ˆä½†æœªæäº¤ï¼‰

é˜¶æ®µå››ï¼šæäº¤äº‹åŠ¡
transaction.commit()
    â†“
æ‰§è¡Œflushï¼ˆå¦‚æœè¿˜æœ‰æœªåŒæ­¥çš„æ“ä½œï¼‰
    â†“
æäº¤æ•°æ®åº“äº‹åŠ¡
    â†“
é‡Šæ”¾æ•°æ®åº“è¿æ¥

é˜¶æ®µäº”ï¼šå…³é—­Session
session.close()
    â†“
æ¸…ç©ºä¸€çº§ç¼“å­˜
    â†“
SessionçŠ¶æ€å˜ä¸ºClosed
```

**ğŸ’¡ å®é™…ä»£ç æ¼”ç¤º**ï¼š

```java
public void completeLifecycle() {
    Session session = null;
    Transaction tx = null;
    
    try {
        // 1. åˆ›å»ºSession
        session = sessionFactory.openSession();
        System.out.println("Sessionåˆ›å»º: " + session.isOpen()); // true
        
        // 2. å¼€å¯äº‹åŠ¡
        tx = session.beginTransaction();
        
        // 3. æ‰§è¡Œæ“ä½œ
        User user = new User("å¼ ä¸‰", 25);
        session.save(user); // æ­¤æ—¶è¿˜åœ¨ç¼“å­˜ä¸­
        
        // 4. æäº¤äº‹åŠ¡ï¼ˆè§¦å‘flushå’Œcommitï¼‰
        tx.commit();
        System.out.println("äº‹åŠ¡å·²æäº¤");
        
    } catch (Exception e) {
        // å‡ºé”™æ—¶å›æ»š
        if (tx != null) tx.rollback();
        e.printStackTrace();
    } finally {
        // 5. å…³é—­Session
        if (session != null) {
            session.close();
            System.out.println("Sessionå…³é—­: " + !session.isOpen()); // true
        }
    }
}
```

### 3.3 Sessionä¸æŒä¹…åŒ–ä¸Šä¸‹æ–‡


**ä»€ä¹ˆæ˜¯æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼Ÿ**

æŒä¹…åŒ–ä¸Šä¸‹æ–‡å°±åƒSessionçš„"å·¥ä½œè®°äº‹æœ¬"ï¼Œè®°å½•äº†å½“å‰Sessionç®¡ç†çš„æ‰€æœ‰å¯¹è±¡çŠ¶æ€ã€‚

```
ğŸ—‚ï¸ æŒä¹…åŒ–ä¸Šä¸‹æ–‡çš„ä½œç”¨ï¼š

1. å¯¹è±¡çŠ¶æ€ç®¡ç†ï¼š
   ä¸´æ—¶(Transient) â†’ save/persist â†’ æŒä¹…(Persistent)
   æŒä¹…(Persistent) â†’ delete â†’ åˆ é™¤(Removed)
   æŒä¹…(Persistent) â†’ close â†’ æ¸¸ç¦»(Detached)

2. ä¸€çº§ç¼“å­˜ï¼š
   â€¢ Sessionå†…éƒ¨çš„ç¼“å­˜
   â€¢ åŒä¸€Sessionå†…getåŒä¸€å¯¹è±¡ä¼šä»ç¼“å­˜å–
   â€¢ Sessionå…³é—­åˆ™ç¼“å­˜æ¸…ç©º

3. è„æ£€æŸ¥æœºåˆ¶ï¼š
   â€¢ è‡ªåŠ¨æ£€æµ‹å¯¹è±¡æ˜¯å¦è¢«ä¿®æ”¹
   â€¢ äº‹åŠ¡æäº¤æ—¶è‡ªåŠ¨æ›´æ–°æ•°æ®åº“
   â€¢ æ— éœ€æ‰‹åŠ¨è°ƒç”¨update
```

**ğŸ“ æŒä¹…åŒ–ä¸Šä¸‹æ–‡ç¤ºä¾‹**ï¼š

```java
public void contextExample() {
    try (Session session = sessionFactory.openSession()) {
        session.beginTransaction();
        
        // ç¬¬ä¸€æ¬¡getï¼šä»æ•°æ®åº“åŠ è½½
        User user1 = session.get(User.class, 1L);
        System.out.println("ç¬¬ä¸€æ¬¡æŸ¥è¯¢: " + user1.getName());
        
        // ç¬¬äºŒæ¬¡getï¼šä»ä¸€çº§ç¼“å­˜è·å–ï¼ˆä¸æŸ¥æ•°æ®åº“ï¼‰
        User user2 = session.get(User.class, 1L);
        System.out.println("ç¬¬äºŒæ¬¡æŸ¥è¯¢: " + user2.getName());
        
        // ä¸¤ä¸ªå¼•ç”¨æŒ‡å‘åŒä¸€å¯¹è±¡
        System.out.println(user1 == user2); // true
        
        // ä¿®æ”¹å¯¹è±¡ï¼ˆè„æ£€æŸ¥ä¼šè‡ªåŠ¨æ›´æ–°ï¼‰
        user1.setName("æå››");
        // æ— éœ€è°ƒç”¨updateï¼Œæäº¤äº‹åŠ¡æ—¶è‡ªåŠ¨æ›´æ–°
        
        session.getTransaction().commit();
    }
}
```

---

## 4. ğŸ§µ çº¿ç¨‹ç»‘å®šæœºåˆ¶


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹ç»‘å®š


**é—®é¢˜åœºæ™¯**ï¼š

æƒ³è±¡ä¸€ä¸ªç½‘ç«™ï¼Œæ¯ä¸ªç”¨æˆ·è¯·æ±‚éƒ½åœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸­å¤„ç†ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹å…±äº«åŒä¸€ä¸ªSessionä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

```
âŒ å¤šçº¿ç¨‹å…±äº«Sessionçš„é—®é¢˜ï¼š

çº¿ç¨‹Aï¼šæŸ¥è¯¢ç”¨æˆ·1
çº¿ç¨‹Bï¼šæŸ¥è¯¢ç”¨æˆ·2    â† åŒä¸€ä¸ªSession
    â†“
Sessionå†…éƒ¨çŠ¶æ€æ··ä¹±
    â†“
æ•°æ®é”™ä¹±ã€å¼‚å¸¸ã€ç¨‹åºå´©æºƒ

æ ¸å¿ƒåŸå› ï¼š
Sessionä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼
```

**âœ… è§£å†³æ–¹æ¡ˆï¼šçº¿ç¨‹ç»‘å®š**

```
çº¿ç¨‹ç»‘å®šçš„æ€æƒ³ï¼š
æ¯ä¸ªçº¿ç¨‹ â†’ ç»‘å®šè‡ªå·±çš„Session â†’ äº’ä¸å¹²æ‰°

çº¿ç¨‹A â†’ SessionA â†’ æ•°æ®åº“æ“ä½œA
çº¿ç¨‹B â†’ SessionB â†’ æ•°æ®åº“æ“ä½œB
çº¿ç¨‹C â†’ SessionC â†’ æ•°æ®åº“æ“ä½œC

å¥½å¤„ï¼š
â€¢ çº¿ç¨‹å®‰å…¨ï¼šæ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹Session
â€¢ è‡ªåŠ¨ç®¡ç†ï¼šæ¡†æ¶è‡ªåŠ¨åˆ›å»ºå’Œå…³é—­
â€¢ ä»£ç ç®€æ´ï¼šæ— éœ€æ‰‹åŠ¨ç®¡ç†Session
```

### 4.2 çº¿ç¨‹ç»‘å®šçš„å®ç°åŸç†


**Hibernateçš„çº¿ç¨‹ç»‘å®šæœºåˆ¶**ï¼š

```
ğŸ”§ åº•å±‚å®ç°ï¼šThreadLocal

ThreadLocal<Session> çº¿ç¨‹æœ¬åœ°å­˜å‚¨
    â†“
æ¯ä¸ªçº¿ç¨‹å­˜å‚¨è‡ªå·±çš„Sessionå‰¯æœ¬
    â†“
çº¿ç¨‹1 â†’ Session1
çº¿ç¨‹2 â†’ Session2
çº¿ç¨‹3 â†’ Session3

å·¥ä½œæµç¨‹ï¼š
1. è°ƒç”¨getCurrentSession()
2. æ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦å·²æœ‰Session
3. æœ‰åˆ™è¿”å›ï¼Œæ— åˆ™åˆ›å»ºå¹¶ç»‘å®š
4. äº‹åŠ¡ç»“æŸæ—¶è‡ªåŠ¨è§£ç»‘å’Œå…³é—­
```

**é…ç½®çº¿ç¨‹ç»‘å®šç­–ç•¥**ï¼š

åœ¨`hibernate.cfg.xml`ä¸­é…ç½®ï¼š

```xml
<!-- çº¿ç¨‹ç»‘å®šç­–ç•¥é…ç½® -->
<property name="hibernate.current_session_context_class">
    thread
    <!-- 
    å¯é€‰å€¼ï¼š
    thread - çº¿ç¨‹ç»‘å®šï¼ˆå•ä½“åº”ç”¨ï¼‰
    jta - JTAäº‹åŠ¡ç»‘å®šï¼ˆJavaEEç¯å¢ƒï¼‰
    managed - å®¹å™¨ç®¡ç†ï¼ˆSpringç­‰ï¼‰
    -->
</property>
```

### 4.3 çº¿ç¨‹ç»‘å®šçš„ç”Ÿå‘½å‘¨æœŸ


**ğŸ“… ç»‘å®šSessionçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š

```
è¯·æ±‚å¼€å§‹
    â†“
è°ƒç”¨getCurrentSession()
    â†“
æ£€æŸ¥ThreadLocal
    â†“
    â”œâ”€ å·²æœ‰Session â†’ ç›´æ¥è¿”å›
    â””â”€ æ— Session â†’ åˆ›å»ºæ–°Sessionå¹¶ç»‘å®š
    â†“
æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆå¯å¤šæ¬¡è°ƒç”¨getCurrentSessionï¼Œè¿”å›åŒä¸€å®ä¾‹ï¼‰
    â†“
äº‹åŠ¡æäº¤/å›æ»š
    â†“
è‡ªåŠ¨å…³é—­Session
    â†“
ä»ThreadLocalè§£ç»‘
    â†“
è¯·æ±‚ç»“æŸ
```

**âš ï¸ çº¿ç¨‹ç»‘å®šçš„æ³¨æ„äº‹é¡¹**ï¼š

```
1. äº‹åŠ¡è¾¹ç•Œï¼š
   â€¢ getCurrentSession()å¿…é¡»åœ¨äº‹åŠ¡å†…ä½¿ç”¨
   â€¢ æ— äº‹åŠ¡è°ƒç”¨ä¼šæŠ›å¼‚å¸¸

2. è‡ªåŠ¨å…³é—­ï¼š
   â€¢ äº‹åŠ¡æäº¤åSessionè‡ªåŠ¨å…³é—­
   â€¢ ä¸èƒ½æ‰‹åŠ¨è°ƒç”¨close()

3. çº¿ç¨‹å®‰å…¨ï¼š
   â€¢ åªåœ¨å½“å‰çº¿ç¨‹æœ‰æ•ˆ
   â€¢ ä¸è¦ä¼ é€’ç»™å…¶ä»–çº¿ç¨‹ä½¿ç”¨

4. Webåº”ç”¨ï¼š
   â€¢ é€šå¸¸ä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªSession
   â€¢ ä½¿ç”¨è¿‡æ»¤å™¨æˆ–æ‹¦æˆªå™¨ç»Ÿä¸€ç®¡ç†
```

---

## 5. ğŸ”‘ getCurrentSessionè¯¦è§£


### 5.1 getCurrentSessionçš„å·¥ä½œæœºåˆ¶


**æ ¸å¿ƒç‰¹ç‚¹è§£æ**ï¼š

```
ğŸ¯ getCurrentSession()çš„ä¸‰å¤§ç‰¹ç‚¹ï¼š

1. çº¿ç¨‹ç»‘å®šï¼š
   åŒä¸€çº¿ç¨‹å†…å¤šæ¬¡è°ƒç”¨è¿”å›åŒä¸€Session
   
2. è‡ªåŠ¨ç®¡ç†ï¼š
   äº‹åŠ¡æäº¤æ—¶è‡ªåŠ¨close
   æ— éœ€æ‰‹åŠ¨å…³é—­
   
3. äº‹åŠ¡å¼ºå…³è”ï¼š
   å¿…é¡»åœ¨äº‹åŠ¡å†…ä½¿ç”¨
   æ— äº‹åŠ¡ä¼šæŠ›HibernateException
```

**ä½¿ç”¨ç¤ºä¾‹å¯¹æ¯”**ï¼š

```java
// âœ… æ­£ç¡®ç”¨æ³•ï¼šåœ¨äº‹åŠ¡å†…ä½¿ç”¨
public void correctUsage() {
    Session session = sessionFactory.getCurrentSession();
    session.beginTransaction();
    
    // ç¬¬ä¸€æ¬¡è°ƒç”¨
    User user = session.get(User.class, 1L);
    
    // å†æ¬¡è°ƒç”¨getCurrentSession
    Session session2 = sessionFactory.getCurrentSession();
    // session == session2 (åŒä¸€ä¸ªå®ä¾‹)
    
    session.getTransaction().commit();
    // è¿™é‡ŒSessionè‡ªåŠ¨å…³é—­
}

// âŒ é”™è¯¯ç”¨æ³•ï¼šæ— äº‹åŠ¡è°ƒç”¨
public void wrongUsage() {
    Session session = sessionFactory.getCurrentSession();
    // æŠ›å‡ºå¼‚å¸¸ï¼šNo Hibernate Session bound to thread
    User user = session.get(User.class, 1L);
}
```

### 5.2 getCurrentSessionçš„å…¸å‹åº”ç”¨åœºæ™¯


**ğŸŒ Webåº”ç”¨ä¸­çš„Sessionç®¡ç†**ï¼š

```
å…¸å‹è¯·æ±‚å¤„ç†æµç¨‹ï¼š

HTTPè¯·æ±‚
    â†“
è¿‡æ»¤å™¨/æ‹¦æˆªå™¨ï¼šå¼€å¯äº‹åŠ¡
    â†“
Serviceå±‚ï¼šgetCurrentSession()
    â†“
DAOå±‚ï¼šgetCurrentSession()ï¼ˆå¤ç”¨åŒä¸€Sessionï¼‰
    â†“
äº‹åŠ¡æäº¤ï¼šSessionè‡ªåŠ¨å…³é—­
    â†“
è¿”å›å“åº”
```

**å®é™…ä»£ç ç¤ºä¾‹**ï¼š

```java
// DAOå±‚
public class UserDao {
    private SessionFactory sessionFactory;
    
    public User findById(Long id) {
        // è·å–å½“å‰çº¿ç¨‹çš„Session
        Session session = sessionFactory.getCurrentSession();
        return session.get(User.class, id);
    }
    
    public void save(User user) {
        Session session = sessionFactory.getCurrentSession();
        session.save(user);
    }
}

// Serviceå±‚
public class UserService {
    private UserDao userDao;
    
    public void updateUser(Long id, String newName) {
        // å¼€å¯äº‹åŠ¡
        Session session = sessionFactory.getCurrentSession();
        session.beginTransaction();
        
        try {
            // å¤šæ¬¡è°ƒç”¨DAOï¼Œå…±ç”¨åŒä¸€Session
            User user = userDao.findById(id);
            user.setName(newName);
            userDao.save(user);
            
            // æäº¤äº‹åŠ¡ï¼ŒSessionè‡ªåŠ¨å…³é—­
            session.getTransaction().commit();
        } catch (Exception e) {
            session.getTransaction().rollback();
            throw e;
        }
    }
}
```

### 5.3 getCurrentSessionçš„ä¼˜ç¼ºç‚¹


**âš–ï¸ ä¼˜åŠ¿ä¸å±€é™**ï¼š

```
âœ… ä¼˜åŠ¿ï¼š
1. ä»£ç ç®€æ´ï¼š
   â€¢ æ— éœ€æ‰‹åŠ¨å…³é—­Session
   â€¢ è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
   
2. çº¿ç¨‹å®‰å…¨ï¼š
   â€¢ æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹Session
   â€¢ é¿å…å¹¶å‘é—®é¢˜
   
3. ç»Ÿä¸€ç®¡ç†ï¼š
   â€¢ æ¡†æ¶ç»Ÿä¸€æ§åˆ¶
   â€¢ å‡å°‘èµ„æºæ³„æ¼é£é™©

âŒ å±€é™ï¼š
1. äº‹åŠ¡ä¾èµ–ï¼š
   â€¢ å¿…é¡»åœ¨äº‹åŠ¡å†…ä½¿ç”¨
   â€¢ å¢åŠ äº†ä½¿ç”¨çº¦æŸ
   
2. çµæ´»æ€§å—é™ï¼š
   â€¢ Sessionç”Ÿå‘½å‘¨æœŸå›ºå®š
   â€¢ ä¸é€‚åˆé•¿ä¼šè¯åœºæ™¯
   
3. é…ç½®è¦æ±‚ï¼š
   â€¢ éœ€è¦æ­£ç¡®é…ç½®ç»‘å®šç­–ç•¥
   â€¢ é”™è¯¯é…ç½®å¯¼è‡´å¼‚å¸¸
```

---

## 6. ğŸ”“ openSessionè¯¦è§£


### 6.1 openSessionçš„ç‰¹ç‚¹


**ä¸getCurrentSessionçš„æœ¬è´¨åŒºåˆ«**ï¼š

```
openSession()å°±åƒï¼š
æ¯æ¬¡éƒ½å¼€ä¸€ä¸ªæ–°çš„"å·¥ä½œå°"

getCurrentSession()å°±åƒï¼š
ç”¨åŒä¸€ä¸ª"å·¥ä½œå°"å¹²æ´»
```

**ğŸ”¸ openSessionæ ¸å¿ƒç‰¹å¾**ï¼š

```
1. å®Œå…¨ç‹¬ç«‹ï¼š
   æ¯æ¬¡è°ƒç”¨åˆ›å»ºå…¨æ–°Session
   
2. æ‰‹åŠ¨ç®¡ç†ï¼š
   å¿…é¡»æ‰‹åŠ¨close()
   å¿˜è®°å…³é—­ä¼šå¯¼è‡´èµ„æºæ³„æ¼
   
3. æ— äº‹åŠ¡é™åˆ¶ï¼š
   å¯ä»¥åœ¨äº‹åŠ¡å¤–ä½¿ç”¨
   çµæ´»æ€§æ›´é«˜
   
4. éœ€è¦æ˜¾å¼å…³é—­ï¼š
   å³ä½¿åœ¨try-with-resourcesä¸­ä¹Ÿè¦æ˜ç¡®
```

### 6.2 openSessionçš„ä½¿ç”¨åœºæ™¯


**ğŸ“‹ é€‚åˆä½¿ç”¨openSessionçš„æƒ…å†µ**ï¼š

```
åœºæ™¯ä¸€ï¼šæ‰¹é‡å¤„ç†
æ¯å¤„ç†Næ¡è®°å½•å°±å…³é—­Sessionï¼Œé¿å…å†…å­˜æº¢å‡º

åœºæ™¯äºŒï¼šå¤šæ•°æ®åº“æ“ä½œ
åŒæ—¶æ“ä½œå¤šä¸ªæ•°æ®åº“éœ€è¦å¤šä¸ªSession

åœºæ™¯ä¸‰ï¼šå¼‚æ­¥ä»»åŠ¡
åå°çº¿ç¨‹éœ€è¦ç‹¬ç«‹çš„Session

åœºæ™¯å››ï¼šäº‹åŠ¡å¤–æŸ¥è¯¢
åªè¯»æ“ä½œï¼Œä¸éœ€è¦äº‹åŠ¡æ”¯æŒ
```

**ğŸ’» æ‰¹é‡å¤„ç†ç¤ºä¾‹**ï¼š

```java
public void batchProcess() {
    Session session = sessionFactory.openSession();
    Transaction tx = session.beginTransaction();
    
    try {
        for (int i = 0; i < 10000; i++) {
            User user = new User("ç”¨æˆ·" + i, 20 + i % 50);
            session.save(user);
            
            // æ¯100æ¡è®°å½•åˆ·æ–°ä¸€æ¬¡
            if (i % 100 == 0) {
                session.flush();  // åŒæ­¥åˆ°æ•°æ®åº“
                session.clear();  // æ¸…ç©ºä¸€çº§ç¼“å­˜
            }
        }
        
        tx.commit();
    } catch (Exception e) {
        if (tx != null) tx.rollback();
        throw e;
    } finally {
        session.close();  // å¿…é¡»æ‰‹åŠ¨å…³é—­
    }
}
```

**ğŸ”„ å¤šSessionå¹¶å‘ç¤ºä¾‹**ï¼š

```java
public void multiSessionExample() {
    // Session1ï¼šå¤„ç†ç”¨æˆ·æ•°æ®
    Session session1 = sessionFactory.openSession();
    try {
        session1.beginTransaction();
        User user = session1.get(User.class, 1L);
        user.setName("æ›´æ–°çš„åå­—");
        session1.getTransaction().commit();
    } finally {
        session1.close();
    }
    
    // Session2ï¼šç‹¬ç«‹çš„è®¢å•å¤„ç†
    Session session2 = sessionFactory.openSession();
    try {
        session2.beginTransaction();
        Order order = new Order();
        session2.save(order);
        session2.getTransaction().commit();
    } finally {
        session2.close();
    }
}
```

### 6.3 openSessionçš„æ³¨æ„äº‹é¡¹


**âš ï¸ å¸¸è§é™·é˜±ä¸é˜²èŒƒ**ï¼š

```
é™·é˜±1ï¼šå¿˜è®°å…³é—­
âŒ Session session = sessionFactory.openSession();
   // ä¸šåŠ¡é€»è¾‘
   // å¿˜è®°close() â†’ èµ„æºæ³„æ¼

âœ… ä½¿ç”¨try-with-resources
   try (Session session = sessionFactory.openSession()) {
       // ä¸šåŠ¡é€»è¾‘
   } // è‡ªåŠ¨å…³é—­

é™·é˜±2ï¼šè¿‡åº¦ä½¿ç”¨
âŒ é¢‘ç¹åˆ›å»ºé”€æ¯Session
   for (int i = 0; i < 1000; i++) {
       Session s = openSession();
       // æ“ä½œ
       s.close();
   }

âœ… åˆç†æ‰¹é‡å¤„ç†
   Session s = openSession();
   for (int i = 0; i < 1000; i++) {
       // æ‰¹é‡æ“ä½œ
       if (i % 100 == 0) flush and clear
   }
   s.close();

é™·é˜±3ï¼šè·¨çº¿ç¨‹ä½¿ç”¨
âŒ Session session = openSession();
   new Thread(() -> {
       session.get(...); // çº¿ç¨‹ä¸å®‰å…¨ï¼
   }).start();

âœ… æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹Session
   new Thread(() -> {
       Session s = openSession();
       try {
           s.get(...);
       } finally {
           s.close();
       }
   }).start();
```

---

## 7. ğŸ’ ä¼šè¯ç®¡ç†æœ€ä½³å®è·µ


### 7.1 é€‰æ‹©åˆé€‚çš„Sessionè·å–æ–¹å¼


**ğŸ¯ å†³ç­–æ ‘**ï¼š

```
å¼€å§‹é€‰æ‹©
    â†“
æ˜¯Webåº”ç”¨ï¼Ÿ
    â†“ æ˜¯
ä½¿ç”¨getCurrentSession()
    â†“ é…ç½®çº¿ç¨‹ç»‘å®š
    â†“ åœ¨æ‹¦æˆªå™¨/è¿‡æ»¤å™¨ä¸­ç»Ÿä¸€ç®¡ç†äº‹åŠ¡
    â†“ å®Œæˆ

    â†“ å¦
éœ€è¦æ‰¹é‡å¤„ç†å¤§é‡æ•°æ®ï¼Ÿ
    â†“ æ˜¯
ä½¿ç”¨openSession()
    â†“ æ‰‹åŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
    â†“ åˆ†æ‰¹flushå’Œclear
    â†“ å®Œæˆ

    â†“ å¦
éœ€è¦çµæ´»æ§åˆ¶Sessionï¼Ÿ
    â†“ æ˜¯
ä½¿ç”¨openSession()
    â†“ å®Œæˆ

    â†“ å¦
é»˜è®¤ä½¿ç”¨getCurrentSession()
    â†“ å®Œæˆ
```

### 7.2 Sessionç®¡ç†æ¨¡å¼


**ğŸ—ï¸ å¸¸ç”¨ç®¡ç†æ¨¡å¼**ï¼š

**æ¨¡å¼ä¸€ï¼šSession-per-Requestï¼ˆæœ€å¸¸ç”¨ï¼‰**

```
è¯·æ±‚çº§åˆ«çš„Sessionç®¡ç†ï¼š

HTTPè¯·æ±‚ â†’ è¿‡æ»¤å™¨å¼€å¯Session â†’ ä¸šåŠ¡å¤„ç† â†’ å…³é—­Session â†’ å“åº”

ä¼˜ç‚¹ï¼š
âœ… ç®€å•æ˜äº†
âœ… äº‹åŠ¡è¾¹ç•Œæ¸…æ™°
âœ… é¿å…èµ„æºæ³„æ¼

ä»£ç ç¤ºä¾‹ï¼š
public class HibernateFilter implements Filter {
    public void doFilter(ServletRequest req, ServletResponse res, 
                        FilterChain chain) {
        Session session = sessionFactory.getCurrentSession();
        try {
            session.beginTransaction();
            chain.doFilter(req, res);  // æ‰§è¡Œä¸šåŠ¡
            session.getTransaction().commit();
        } catch (Exception e) {
            session.getTransaction().rollback();
            throw e;
        }
    }
}
```

**æ¨¡å¼äºŒï¼šSession-per-Conversationï¼ˆé•¿ä¼šè¯ï¼‰**

```
è·¨å¤šä¸ªè¯·æ±‚çš„ä¼šè¯ï¼š

è¯·æ±‚1 â†’ å¼€å¯Session â†’ æ“ä½œ â†’ Sessionæ¸¸ç¦»
è¯·æ±‚2 â†’ é‡æ–°å…³è”Session â†’ æ“ä½œ â†’ Sessionæ¸¸ç¦»
è¯·æ±‚3 â†’ é‡æ–°å…³è”Session â†’ æ“ä½œ â†’ å…³é—­Session

é€‚ç”¨åœºæ™¯ï¼š
â€¢ å‘å¯¼å¼è¡¨å•
â€¢ åˆ†æ­¥æ“ä½œæµç¨‹

æ³¨æ„ï¼šéœ€è¦æ‰‹åŠ¨ç®¡ç†Sessionå­˜å‚¨ï¼ˆHttpSessionç­‰ï¼‰
```

**æ¨¡å¼ä¸‰ï¼šSession-per-Operationï¼ˆæ“ä½œçº§ï¼‰**

```
æ¯ä¸ªç‹¬ç«‹æ“ä½œä¸€ä¸ªSessionï¼š

æ“ä½œ1 â†’ openSession() â†’ æ‰§è¡Œ â†’ close()
æ“ä½œ2 â†’ openSession() â†’ æ‰§è¡Œ â†’ close()

é€‚ç”¨åœºæ™¯ï¼š
â€¢ æ‰¹é‡å¤„ç†
â€¢ åå°ä»»åŠ¡
â€¢ ç®€å•çš„æ•°æ®è®¿é—®
```

### 7.3 äº‹åŠ¡ç®¡ç†æœ€ä½³å®è·µ


**ğŸ” äº‹åŠ¡å¤„ç†è§„èŒƒ**ï¼š

```
åŸºæœ¬åŸåˆ™ï¼š
1. äº‹åŠ¡å°½å¯èƒ½çŸ­
   â€¢ å‡å°‘é”å®šæ—¶é—´
   â€¢ æé«˜å¹¶å‘æ€§èƒ½
   
2. äº‹åŠ¡è¾¹ç•Œæ˜ç¡®
   â€¢ Serviceå±‚ç®¡ç†äº‹åŠ¡
   â€¢ DAOå±‚åªè´Ÿè´£æ•°æ®è®¿é—®
   
3. å¼‚å¸¸å¤„ç†å®Œæ•´
   â€¢ æ‰€æœ‰å¼‚å¸¸éƒ½è¦æ•è·
   â€¢ ç¡®ä¿äº‹åŠ¡æ­£ç¡®å›æ»š
```

**ğŸ’» äº‹åŠ¡æ¨¡æ¿ä»£ç **ï¼š

```java
// å°è£…äº‹åŠ¡å¤„ç†çš„å·¥å…·æ–¹æ³•
public class TransactionUtil {
    
    public static <T> T executeInTransaction(
            SessionFactory factory, 
            Function<Session, T> action) {
        
        Session session = factory.getCurrentSession();
        Transaction tx = session.beginTransaction();
        
        try {
            T result = action.apply(session);
            tx.commit();
            return result;
        } catch (Exception e) {
            if (tx != null) tx.rollback();
            throw new RuntimeException("äº‹åŠ¡æ‰§è¡Œå¤±è´¥", e);
        }
    }
    
    // æ— è¿”å›å€¼çš„äº‹åŠ¡
    public static void executeInTransaction(
            SessionFactory factory,
            Consumer<Session> action) {
        
        Session session = factory.getCurrentSession();
        Transaction tx = session.beginTransaction();
        
        try {
            action.accept(session);
            tx.commit();
        } catch (Exception e) {
            if (tx != null) tx.rollback();
            throw new RuntimeException("äº‹åŠ¡æ‰§è¡Œå¤±è´¥", e);
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public void businessLogic() {
    // æœ‰è¿”å›å€¼çš„äº‹åŠ¡
    User user = TransactionUtil.executeInTransaction(
        sessionFactory,
        session -> session.get(User.class, 1L)
    );
    
    // æ— è¿”å›å€¼çš„äº‹åŠ¡
    TransactionUtil.executeInTransaction(
        sessionFactory,
        session -> {
            User newUser = new User("å¼ ä¸‰", 25);
            session.save(newUser);
        }
    );
}
```

### 7.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**âš¡ Sessionä½¿ç”¨ä¼˜åŒ–**ï¼š

```
ä¼˜åŒ–ç­–ç•¥ï¼š

1. åˆç†ä½¿ç”¨flushå’Œclear
   æ‰¹é‡æ“ä½œæ—¶ï¼š
   â€¢ æ¯Næ¡è®°å½•flush()ä¸€æ¬¡
   â€¢ flush()åç«‹å³clear()æ¸…ç©ºç¼“å­˜
   â€¢ é¿å…ä¸€çº§ç¼“å­˜å ç”¨è¿‡å¤šå†…å­˜

2. é¿å…N+1æŸ¥è¯¢é—®é¢˜
   âŒ å¾ªç¯ä¸­getå¯¹è±¡ï¼ˆæ¯æ¬¡ä¸€æ¡SQLï¼‰
   âœ… ä½¿ç”¨join fetchä¸€æ¬¡æ€§åŠ è½½

3. åªè¯»æ“ä½œä¼˜åŒ–
   â€¢ ä½¿ç”¨setReadOnly(true)
   â€¢ é¿å…è„æ£€æŸ¥å¼€é”€
   â€¢ é€‚åˆæŸ¥è¯¢åœºæ™¯

4. è¿æ¥æ± é…ç½®
   â€¢ è®¾ç½®åˆç†çš„æœ€å¤§è¿æ¥æ•°
   â€¢ é…ç½®è¿æ¥æµ‹è¯•æŸ¥è¯¢
   â€¢ å¯ç”¨è¿æ¥å›æ”¶æœºåˆ¶
```

**ğŸ“Š æ€§èƒ½ç›‘æ§**ï¼š

```java
// å¼€å¯SQLæ—¥å¿—
<property name="hibernate.show_sql">true</property>
<property name="hibernate.format_sql">true</property>
<property name="hibernate.use_sql_comments">true</property>

// ç»Ÿè®¡ä¿¡æ¯
Session session = sessionFactory.getCurrentSession();
Statistics stats = sessionFactory.getStatistics();
System.out.println("Sessionæ‰“å¼€æ•°: " + stats.getSessionOpenCount());
System.out.println("Sessionå…³é—­æ•°: " + stats.getSessionCloseCount());
System.out.println("äº‹åŠ¡æ•°: " + stats.getTransactionCount());
```

### 7.5 å¸¸è§é”™è¯¯ä¸è§£å†³æ–¹æ¡ˆ


**ğŸ› å…¸å‹é—®é¢˜æ’æŸ¥**ï¼š

```
é—®é¢˜1ï¼šNo Hibernate Session bound to thread
åŸå› ï¼šgetCurrentSession()åœ¨äº‹åŠ¡å¤–è°ƒç”¨
è§£å†³ï¼šç¡®ä¿åœ¨äº‹åŠ¡å†…ä½¿ç”¨

é—®é¢˜2ï¼šSession is closed
åŸå› ï¼šSessionå·²å…³é—­åä»ç„¶è®¿é—®
è§£å†³ï¼šæ£€æŸ¥Sessionç”Ÿå‘½å‘¨æœŸç®¡ç†

é—®é¢˜3ï¼šNonUniqueObjectException
åŸå› ï¼šåŒä¸€Sessionä¸­å­˜åœ¨ä¸¤ä¸ªç›¸åŒIDçš„å¯¹è±¡
è§£å†³ï¼šä½¿ç”¨merge()ä»£æ›¿save()

é—®é¢˜4ï¼šLazyInitializationException  
åŸå› ï¼šSessionå…³é—­åè®¿é—®æ‡’åŠ è½½å±æ€§
è§£å†³ï¼š
â€¢ ä½¿ç”¨JOIN FETCHæå‰åŠ è½½
â€¢ åœ¨Sessionå†…å®Œæˆæ‰€æœ‰è®¿é—®
â€¢ é…ç½®OpenSessionInViewï¼ˆWebåº”ç”¨ï¼‰

é—®é¢˜5ï¼šæ•°æ®åº“è¿æ¥æ³„æ¼
åŸå› ï¼šSessionæœªæ­£ç¡®å…³é—­
è§£å†³ï¼š
â€¢ ä½¿ç”¨try-with-resources
â€¢ ç¡®ä¿finallyå—ä¸­å…³é—­
â€¢ é…ç½®è¿æ¥æ± è¶…æ—¶
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Sessionæœ¬è´¨ï¼šåº”ç”¨ä¸æ•°æ®åº“ä¹‹é—´çš„å·¥ä½œä¼šè¯
ğŸ”¸ ç”Ÿå‘½å‘¨æœŸï¼šåˆ›å»ºâ†’ä½¿ç”¨â†’å…³é—­ï¼Œå¿…é¡»åŠæ—¶é‡Šæ”¾
ğŸ”¸ çº¿ç¨‹å®‰å…¨ï¼šSessionä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸èƒ½å…±äº«
ğŸ”¸ ä¸¤ç§è·å–æ–¹å¼ï¼šgetCurrentSession vs openSession
ğŸ”¸ æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼šä¸€çº§ç¼“å­˜ + å¯¹è±¡çŠ¶æ€ç®¡ç†
ğŸ”¸ äº‹åŠ¡å…³è”ï¼šgetCurrentSessionå¿…é¡»åœ¨äº‹åŠ¡å†…ä½¿ç”¨
ğŸ”¸ èµ„æºç®¡ç†ï¼šå¿˜è®°å…³é—­ä¼šå¯¼è‡´è¿æ¥æ³„æ¼
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Sessionä¸è¿æ¥çš„å…³ç³»**

```
Session â‰  æ•°æ®åº“è¿æ¥

å…³ç³»è¯´æ˜ï¼š
â€¢ Sessionç®¡ç†è¿æ¥ï¼Œä½†ä¸æ˜¯è¿æ¥æœ¬èº«
â€¢ ä¸€ä¸ªSessionå¯èƒ½ä½¿ç”¨å¤šä¸ªè¿æ¥ï¼ˆç‰¹æ®Šæƒ…å†µï¼‰
â€¢ Sessionå…³é—­æ—¶å½’è¿˜è¿æ¥åˆ°è¿æ¥æ± 
â€¢ è¿æ¥æ˜¯å®è´µèµ„æºï¼ŒSessionæ˜¯ä¸šåŠ¡æŠ½è±¡
```

**ğŸ”¹ getCurrentSession vs openSessionçš„é€‰æ‹©**

```
Webåº”ç”¨åœºæ™¯ï¼š
é¦–é€‰ï¼šgetCurrentSession()
ç†ç”±ï¼š
âœ… è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
âœ… çº¿ç¨‹ç»‘å®šå®‰å…¨
âœ… ä»£ç æ›´ç®€æ´

æ‰¹é‡å¤„ç†åœºæ™¯ï¼š
é¦–é€‰ï¼šopenSession()
ç†ç”±ï¼š
âœ… æ‰‹åŠ¨æ§åˆ¶ç”Ÿå‘½å‘¨æœŸ
âœ… çµæ´»çš„flush/clearæ—¶æœº
âœ… é¿å…å†…å­˜æº¢å‡º

è§„åˆ™ï¼š
â€¢ é»˜è®¤ç”¨getCurrentSession
â€¢ ç‰¹æ®Šéœ€æ±‚ç”¨openSession
â€¢ ç†è§£å·®å¼‚ï¼Œæ­£ç¡®é€‰æ‹©
```

**ğŸ”¹ äº‹åŠ¡ç®¡ç†çš„é‡è¦æ€§**

```
äº‹åŠ¡çš„ä½œç”¨ï¼š
1. æ•°æ®ä¸€è‡´æ€§ä¿è¯
2. Sessionç”Ÿå‘½å‘¨æœŸç®¡ç†
3. è§¦å‘flushæ“ä½œ
4. è‡ªåŠ¨å…³é—­Sessionï¼ˆgetCurrentSessionï¼‰

æœ€ä½³å®è·µï¼š
â€¢ Serviceå±‚ç®¡ç†äº‹åŠ¡è¾¹ç•Œ
â€¢ äº‹åŠ¡å°½å¯èƒ½çŸ­
â€¢ å¼‚å¸¸æ—¶å¿…é¡»å›æ»š
â€¢ ä¸è¦åœ¨Controllerå±‚å¼€äº‹åŠ¡
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¼ å¼€å‘å»ºè®®**

```
1. æ¶æ„è®¾è®¡ï¼š
   Controller â†’ Service â†’ DAO
   â€¢ Controllerï¼šä¸æŒæœ‰Session
   â€¢ Serviceï¼šç®¡ç†äº‹åŠ¡
   â€¢ DAOï¼šä½¿ç”¨Sessionæ‰§è¡ŒSQL

2. å¼‚å¸¸å¤„ç†ï¼š
   æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½è¦try-catch
   æ•è·å¼‚å¸¸åï¼š
   âœ… å›æ»šäº‹åŠ¡
   âœ… è®°å½•æ—¥å¿—
   âœ… æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸

3. æ€§èƒ½è€ƒè™‘ï¼š
   â€¢ æ‰¹é‡æ“ä½œåˆ†æ‰¹å¤„ç†
   â€¢ å®šæœŸflushå’Œclear
   â€¢ ç›‘æ§Sessionå’Œè¿æ¥æ•°é‡
   â€¢ åˆç†é…ç½®è¿æ¥æ± 

4. æµ‹è¯•å»ºè®®ï¼š
   â€¢ å•å…ƒæµ‹è¯•ä¸­æ‰‹åŠ¨ç®¡ç†Session
   â€¢ é›†æˆæµ‹è¯•éªŒè¯äº‹åŠ¡è¡Œä¸º
   â€¢ å‹åŠ›æµ‹è¯•æ£€æŸ¥èµ„æºæ³„æ¼
```

**ğŸ¯ å­¦ä¹ è·¯å¾„**

```
é˜¶æ®µä¸€ï¼šåŸºç¡€ç†è§£
â€¢ ç†è§£Sessionçš„ä½œç”¨å’Œç”Ÿå‘½å‘¨æœŸ
â€¢ æŒæ¡åŸºæœ¬çš„åˆ›å»ºå’Œå…³é—­æ–¹æ³•
â€¢ äº†è§£getCurrentSessionå’ŒopenSessionåŒºåˆ«

é˜¶æ®µäºŒï¼šå®è·µåº”ç”¨
â€¢ åœ¨é¡¹ç›®ä¸­å®é™…ä½¿ç”¨Session
â€¢ å¤„ç†äº‹åŠ¡ç®¡ç†
â€¢ è§£å†³å¸¸è§é—®é¢˜

é˜¶æ®µä¸‰ï¼šæ·±å…¥ä¼˜åŒ–
â€¢ æ€§èƒ½è°ƒä¼˜
â€¢ é«˜çº§ç‰¹æ€§åº”ç”¨
â€¢ æºç ç†è§£
```

### 8.4 å¸¸è§è¯¯åŒºæ¾„æ¸…


**â“ è¯¯åŒºä¸çœŸç›¸**

```
è¯¯åŒº1ï¼šSessionå¯ä»¥å¤šçº¿ç¨‹å…±äº«
çœŸç›¸ï¼šç»å¯¹ä¸è¡Œï¼æ¯ä¸ªçº¿ç¨‹å¿…é¡»æœ‰ç‹¬ç«‹Session

è¯¯åŒº2ï¼šgetCurrentSessionä¸éœ€è¦å…³é—­
çœŸç›¸ï¼šå®ƒæ˜¯è‡ªåŠ¨å…³é—­ï¼Œä¸æ˜¯ä¸éœ€è¦å…³é—­

è¯¯åŒº3ï¼šopenSessionæ›´å®‰å…¨
çœŸç›¸ï¼šåªæ˜¯ç®¡ç†æ–¹å¼ä¸åŒï¼Œå®‰å…¨æ€§ä¸€æ ·

è¯¯åŒº4ï¼šSessionå°±æ˜¯æ•°æ®åº“è¿æ¥
çœŸç›¸ï¼šSessionç®¡ç†è¿æ¥ï¼Œä½†å®ƒæ˜¯æ›´é«˜å±‚çš„æŠ½è±¡

è¯¯åŒº5ï¼šå¯ä»¥éšæ„åˆ›å»ºSession
çœŸç›¸ï¼šSessionåˆ›å»ºæœ‰å¼€é”€ï¼Œè¦åˆç†ä½¿ç”¨
```

**ğŸ“ å­¦ä¹ æ£€éªŒ**

```
è‡ªæˆ‘æ£€æµ‹é¢˜ï¼š

1. getCurrentSession()å’ŒopenSession()çš„ä¸»è¦åŒºåˆ«ï¼Ÿ
   ç­”ï¼šå‰è€…è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œåè€…éœ€æ‰‹åŠ¨å…³é—­

2. ä¸ºä»€ä¹ˆSessionä¸èƒ½å¤šçº¿ç¨‹å…±äº«ï¼Ÿ
   ç­”ï¼šä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¼šå¯¼è‡´çŠ¶æ€æ··ä¹±

3. Sessionå…³é—­æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ
   ç­”ï¼šæ¸…ç©ºç¼“å­˜ã€å½’è¿˜è¿æ¥ã€çŠ¶æ€å˜ä¸ºClosed

4. ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨openSessionï¼Ÿ
   ç­”ï¼šæ‰¹é‡å¤„ç†ã€å¤šSessionå¹¶å‘ã€äº‹åŠ¡å¤–æ“ä½œ

5. Sessionçš„ä¸€çº§ç¼“å­˜ä½•æ—¶æ¸…ç©ºï¼Ÿ
   ç­”ï¼šSessionå…³é—­æ—¶æˆ–æ‰‹åŠ¨clear()æ—¶
```

**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**

```
Sessionç®¡ç†è¦ç‰¢è®°ï¼Œ
åˆ›å»ºå…³é—­æˆå¯¹æ¯”ã€‚
getCurrent è¦äº‹åŠ¡ï¼Œ
openSession æ‰‹åŠ¨ç†ã€‚

çº¿ç¨‹ç»‘å®šä¸èƒ½ä¸¢ï¼Œ
ä¸€çº§ç¼“å­˜å¿ƒé‡Œç•™ã€‚
äº‹åŠ¡è¾¹ç•Œè¦æ˜ç¡®ï¼Œ
æ€§èƒ½ä¼˜åŒ–ç»†ç¢ç£¨ã€‚
```

**æ ¸å¿ƒç†å¿µ**ï¼šSessionæ˜¯Hibernateçš„æ ¸å¿ƒï¼Œç†è§£å®ƒçš„ç”Ÿå‘½å‘¨æœŸå’Œç®¡ç†æœºåˆ¶ï¼Œæ˜¯æŒæ¡Hibernateçš„å…³é”®ã€‚è®°ä½ï¼šSessionä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒåŠæ—¶å…³é—­æ˜¯è´£ä»»ï¼Œé€‰æ‹©åˆé€‚çš„è·å–æ–¹å¼æ˜¯æ™ºæ…§ï¼