---
title: 42ã€SQLç»“æœæ˜ å°„ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [SQLç»“æœæ˜ å°„æ¦‚è¿°](#1-SQLç»“æœæ˜ å°„æ¦‚è¿°)
2. [ResultTransformerç»“æœè½¬æ¢](#2-ResultTransformerç»“æœè½¬æ¢)
3. [AliasToBeanResultTransformerè¯¦è§£](#3-AliasToBeanResultTransformerè¯¦è§£)
4. [DTOæ˜ å°„å®æˆ˜](#4-DTOæ˜ å°„å®æˆ˜)
5. [Mapç»“æœæ˜ å°„](#5-Mapç»“æœæ˜ å°„)
6. [æ ‡é‡ç»“æœå¤„ç†](#6-æ ‡é‡ç»“æœå¤„ç†)
7. [è‡ªå®šä¹‰è½¬æ¢å™¨å¼€å‘](#7-è‡ªå®šä¹‰è½¬æ¢å™¨å¼€å‘)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ SQLç»“æœæ˜ å°„æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯SQLç»“æœæ˜ å°„


**ğŸ”¸ é€šä¿—ç†è§£**
```
æƒ³è±¡ä½ å»é¤å…ç‚¹é¤ï¼š
- åŸå§‹æ•°æ®ï¼šå¨æˆ¿åšå¥½çš„èœå“ï¼ˆæ•°æ®åº“æŸ¥è¯¢ç»“æœï¼‰
- ç»“æœæ˜ å°„ï¼šæœåŠ¡å‘˜æŒ‰ä½ çš„è¦æ±‚è£…ç›˜ï¼ˆè½¬æ¢æˆä½ éœ€è¦çš„æ ¼å¼ï¼‰
- æœ€ç»ˆè·å¾—ï¼šç²¾ç¾æ‘†ç›˜çš„èœå“ï¼ˆJavaå¯¹è±¡ï¼‰

åœ¨Hibernateä¸­ï¼š
æ•°æ®åº“æŸ¥è¯¢ç»“æœ â†’ ç»“æœæ˜ å°„ â†’ Javaå¯¹è±¡
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ¯ **æ ¼å¼è½¬æ¢**ï¼šå°†æ•°æ®åº“åŸå§‹ç»“æœè½¬æˆJavaå¯¹è±¡
- ğŸ”„ **çµæ´»é€‚é…**ï¼šæ”¯æŒå¤šç§ç›®æ ‡ç±»å‹ï¼ˆå®ä½“ã€DTOã€Mapç­‰ï¼‰
- âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…åŠ è½½ä¸éœ€è¦çš„å­—æ®µ

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç»“æœæ˜ å°„


**å®é™…é—®é¢˜åœºæ™¯**ï¼š
```
åœºæ™¯1ï¼šæŸ¥è¯¢ç»Ÿè®¡æ•°æ®
SQL: SELECT user_name, COUNT(*) FROM orders GROUP BY user_name
é—®é¢˜ï¼šç»“æœä¸æ˜¯å®Œæ•´å®ä½“ï¼Œæ€ä¹ˆæ¥æ”¶ï¼Ÿ

åœºæ™¯2ï¼šå…³è”æŸ¥è¯¢
SQL: SELECT u.name, o.total FROM user u JOIN orders o
é—®é¢˜ï¼šè·¨è¡¨æ•°æ®æ€ä¹ˆç»„è£…åˆ°ä¸€ä¸ªå¯¹è±¡ï¼Ÿ

åœºæ™¯3ï¼šæ€§èƒ½ä¼˜åŒ–
SQL: SELECT id, name FROM userï¼ˆåªæŸ¥éƒ¨åˆ†å­—æ®µï¼‰
é—®é¢˜ï¼šä¸æƒ³åŠ è½½æ•´ä¸ªå®ä½“ï¼Œæ€ä¹ˆåŠï¼Ÿ

ç­”æ¡ˆï¼šä½¿ç”¨ç»“æœæ˜ å°„ï¼
```

### 1.3 æ˜ å°„æ–¹å¼å¯¹æ¯”


| æ˜ å°„æ–¹å¼ | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | ğŸ”¥é‡è¦ç¨‹åº¦ |
|---------|------------|---------|---------|-----------|
| **ResultTransformer** | `é€šç”¨è½¬æ¢` | `çµæ´»ã€å¼ºå¤§` | `Hibernate5.2å·²åºŸå¼ƒ` | â­â­â­ |
| **AliasToBeanResultTransformer** | `å¿«é€ŸDTOæ˜ å°„` | `ç®€å•æ˜“ç”¨` | `å­—æ®µåå¿…é¡»åŒ¹é…` | â­â­â­â­ |
| **DTOæŠ•å½±** | `ç±»å‹å®‰å…¨æŸ¥è¯¢` | `ç¼–è¯‘æœŸæ£€æŸ¥` | `éœ€è¦æ„é€ å™¨` | â­â­â­â­â­ |
| **Mapæ˜ å°„** | `åŠ¨æ€ç»“æœ` | `è¶…çº§çµæ´»` | `æ— ç±»å‹å®‰å…¨` | â­â­â­ |
| **æ ‡é‡æŸ¥è¯¢** | `å•å€¼æˆ–ç®€å•ç±»å‹` | `æ€§èƒ½æœ€ä¼˜` | `åŠŸèƒ½å—é™` | â­â­â­ |

---

## 2. ğŸ”„ ResultTransformerç»“æœè½¬æ¢


### 2.1 ResultTransformeræ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ å·¥ä½œåŸç†å›¾ç¤º**
```
æ•°æ®åº“æŸ¥è¯¢ç»“æœï¼ˆObject[]æ•°ç»„ï¼‰
         â†“
   ResultTransformer
    è½¬æ¢å¤„ç†é€»è¾‘
         â†“
    ç›®æ ‡Javaå¯¹è±¡
```

**æœ¬è´¨ç†è§£**ï¼š
```
ResultTransformeræ˜¯ä¸€ä¸ª"ç¿»è¯‘å®˜"ï¼š
- è¾“å…¥ï¼šæ•°æ®åº“è¿”å›çš„åŸå§‹æ•°æ®è¡Œï¼ˆObject[]ï¼‰
- å¤„ç†ï¼šæŒ‰ç…§è§„åˆ™è½¬æ¢
- è¾“å‡ºï¼šä½ æƒ³è¦çš„Javaå¯¹è±¡

å°±åƒï¼š
åŸå§‹æ•°æ®ï¼š["å¼ ä¸‰", 25, "åŒ—äº¬"]
è½¬æ¢è§„åˆ™ï¼šç¬¬1ä¸ªæ˜¯å§“åï¼Œç¬¬2ä¸ªæ˜¯å¹´é¾„ï¼Œç¬¬3ä¸ªæ˜¯åŸå¸‚
æœ€ç»ˆå¯¹è±¡ï¼šUser{name="å¼ ä¸‰", age=25, city="åŒ—äº¬"}
```

### 2.2 ResultTransformeråŸºæœ¬ä½¿ç”¨


> âš ï¸ **é‡è¦æé†’**ï¼šResultTransformeråœ¨Hibernate 5.2åå·²è¢«åºŸå¼ƒï¼Œæ¨èä½¿ç”¨JPAæ ‡å‡†çš„ResultTransformeræˆ–TupleTransformer

**åŸºç¡€ç¤ºä¾‹**ï¼š
```java
// åŸå§‹SQLæŸ¥è¯¢ï¼ˆè¿”å›Object[]æ•°ç»„ï¼‰
String sql = "SELECT name, age FROM user WHERE age > 18";
Query query = session.createSQLQuery(sql);

// ä¸ä½¿ç”¨è½¬æ¢å™¨ï¼šå¾—åˆ°Object[]æ•°ç»„
List<Object[]> results = query.list();
for (Object[] row : results) {
    String name = (String) row[0];  // éœ€è¦æ‰‹åŠ¨ç±»å‹è½¬æ¢
    Integer age = (Integer) row[1];
    // æ‰‹åŠ¨åˆ›å»ºå¯¹è±¡...éº»çƒ¦ï¼
}

// ä½¿ç”¨è½¬æ¢å™¨ï¼šç›´æ¥å¾—åˆ°å¯¹è±¡ï¼ˆè™½ç„¶å·²åºŸå¼ƒï¼Œä½†ç†è§£åŸç†å¾ˆé‡è¦ï¼‰
query.setResultTransformer(Transformers.aliasToBean(UserDTO.class));
List<UserDTO> users = query.list();  // è‡ªåŠ¨è½¬æ¢ï¼
```

### 2.3 å†…ç½®è½¬æ¢å™¨ç±»å‹


**Hibernateæä¾›çš„å¸¸ç”¨è½¬æ¢å™¨**ï¼š

ğŸ”¹ **ALIAS_TO_ENTITY_MAP**
```java
// åœºæ™¯ï¼šç»“æœè½¬æˆMapé›†åˆ
String sql = "SELECT name AS userName, age AS userAge FROM user";
query.setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP);

List<Map<String, Object>> results = query.list();
// ç»“æœï¼š[{userName="å¼ ä¸‰", userAge=25}, {userName="æå››", userAge=30}]
```

ğŸ”¹ **TO_LIST**
```java
// åœºæ™¯ï¼šæ¯è¡Œè½¬æˆList
query.setResultTransformer(Transformers.TO_LIST);
List<List<Object>> results = query.list();
// ç»“æœï¼š[["å¼ ä¸‰", 25], ["æå››", 30]]
```

ğŸ”¹ **ALIAS_TO_BEAN**
```java
// åœºæ™¯ï¼šæœ€å¸¸ç”¨ï¼Œè½¬æˆJavaBean
query.setResultTransformer(Transformers.aliasToBean(UserDTO.class));
List<UserDTO> results = query.list();
```

---

## 3. ğŸ¯ AliasToBeanResultTransformerè¯¦è§£


### 3.1 æ ¸å¿ƒå·¥ä½œæœºåˆ¶


**ğŸ”¸ æ˜ å°„åŸç†**ï¼š
```
å·¥ä½œæ­¥éª¤ï¼š
1. è¯»å–SQLæŸ¥è¯¢çš„å­—æ®µåˆ«åï¼ˆASåé¢çš„åå­—ï¼‰
2. åœ¨ç›®æ ‡ç±»ä¸­æŸ¥æ‰¾åŒåçš„setteræ–¹æ³•
3. è°ƒç”¨setteræ–¹æ³•è®¾ç½®å€¼
4. è¿”å›å¡«å……å¥½çš„å¯¹è±¡

ç¤ºä¾‹è¯´æ˜ï¼š
SQL: SELECT user_name AS userName, user_age AS age FROM user
              â†“                    â†“
      è°ƒç”¨setUserName()      è°ƒç”¨setAge()
              â†“                    â†“
          UserDTOå¯¹è±¡å¡«å……å®Œæˆ
```

**å…³é”®è¦æ±‚**ï¼š
- âœ… SQLå­—æ®µåˆ«åå¿…é¡»ä¸DTOå±æ€§åä¸€è‡´ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰
- âœ… DTOå¿…é¡»æœ‰æ— å‚æ„é€ å™¨
- âœ… DTOå¿…é¡»æœ‰å¯¹åº”çš„setteræ–¹æ³•
- âŒ ä¸éœ€è¦getteræ–¹æ³•

### 3.2 å®æˆ˜æ¡ˆä¾‹ï¼šç”¨æˆ·è®¢å•ç»Ÿè®¡


**ä¸šåŠ¡åœºæ™¯**ï¼šæŸ¥è¯¢ç”¨æˆ·è®¢å•ç»Ÿè®¡ä¿¡æ¯

**æ­¥éª¤1ï¼šåˆ›å»ºDTOç±»**
```java
// ç”¨æˆ·è®¢å•ç»Ÿè®¡DTO
public class UserOrderStatsDTO {
    private String userName;      // ç”¨æˆ·å
    private Long orderCount;      // è®¢å•æ•°é‡
    private BigDecimal totalAmount;  // æ€»é‡‘é¢
    
    // å¿…é¡»æœ‰æ— å‚æ„é€ å™¨
    public UserOrderStatsDTO() {}
    
    // å¿…é¡»æœ‰setteræ–¹æ³•ï¼ˆå­—æ®µåè¦åŒ¹é…ï¼‰
    public void setUserName(String userName) {
        this.userName = userName;
    }
    
    public void setOrderCount(Long orderCount) {
        this.orderCount = orderCount;
    }
    
    public void setTotalAmount(BigDecimal totalAmount) {
        this.totalAmount = totalAmount;
    }
    
    // getteræ–¹æ³•ï¼ˆç”¨äºè·å–æ•°æ®ï¼‰
    public String getUserName() { return userName; }
    public Long getOrderCount() { return orderCount; }
    public BigDecimal getTotalAmount() { return totalAmount; }
}
```

**æ­¥éª¤2ï¼šç¼–å†™æŸ¥è¯¢SQL**
```java
// å…³é”®ï¼šåˆ«åè¦å’ŒDTOå±æ€§åä¸€è‡´ï¼
String sql = """
    SELECT 
        u.name AS userName,           -- å¯¹åº”userNameå±æ€§
        COUNT(o.id) AS orderCount,    -- å¯¹åº”orderCountå±æ€§  
        SUM(o.total) AS totalAmount   -- å¯¹åº”totalAmountå±æ€§
    FROM user u
    LEFT JOIN orders o ON u.id = o.user_id
    GROUP BY u.id, u.name
    """;

// åˆ›å»ºæŸ¥è¯¢å¹¶è®¾ç½®è½¬æ¢å™¨
List<UserOrderStatsDTO> stats = session.createNativeQuery(sql)
    .setResultTransformer(Transformers.aliasToBean(UserOrderStatsDTO.class))
    .list();

// ä½¿ç”¨ç»“æœ
stats.forEach(stat -> {
    System.out.println("ç”¨æˆ·ï¼š" + stat.getUserName());
    System.out.println("è®¢å•æ•°ï¼š" + stat.getOrderCount());
    System.out.println("æ€»é‡‘é¢ï¼š" + stat.getTotalAmount());
});
```

### 3.3 å¸¸è§é—®é¢˜ä¸è§£å†³


**â— é—®é¢˜1ï¼šå­—æ®µåä¸åŒ¹é…**
```java
// é”™è¯¯ç¤ºä¾‹
SELECT user_name FROM user  // åˆ«åuser_name
// DTOä¸­æ˜¯ï¼š
private String userName;    // å±æ€§åuserName
// ç»“æœï¼šæ˜ å°„å¤±è´¥ï¼userNameä¸ºnull

// æ­£ç¡®å†™æ³•1ï¼šä¿®æ”¹SQLåˆ«å
SELECT user_name AS userName FROM user

// æ­£ç¡®å†™æ³•2ï¼šä¿®æ”¹DTOå±æ€§å
private String user_name;
```

**â— é—®é¢˜2ï¼šç¼ºå°‘setteræ–¹æ³•**
```java
// é”™è¯¯ï¼šåªæœ‰å±æ€§ï¼Œæ²¡æœ‰setter
public class UserDTO {
    public String name;  // publicå±æ€§ä¹Ÿä¸è¡Œï¼
}

// æ­£ç¡®ï¼šå¿…é¡»æœ‰setter
public class UserDTO {
    private String name;
    public void setName(String name) {
        this.name = name;
    }
}
```

**â— é—®é¢˜3ï¼šç±»å‹ä¸åŒ¹é…**
```java
// SQLè¿”å›Longç±»å‹
SELECT COUNT(*) AS total FROM orders

// DTOå®šä¹‰é”™è¯¯
private Integer total;  // ç±»å‹ä¸åŒ¹é…ï¼Œå¯èƒ½å¼‚å¸¸ï¼

// æ­£ç¡®å®šä¹‰
private Long total;     // ç±»å‹è¦åŒ¹é…
```

---

## 4. ğŸ“¦ DTOæ˜ å°„å®æˆ˜


### 4.1 ä»€ä¹ˆæ˜¯DTOæ¨¡å¼


**ğŸ”¸ DTOæ ¸å¿ƒæ¦‚å¿µ**
```
DTOï¼ˆData Transfer Objectï¼‰= æ•°æ®ä¼ è¾“å¯¹è±¡

æ¯”å–»ç†è§£ï¼š
- å®ä½“(Entity)ï¼šå®Œæ•´çš„å•†å“ï¼ˆåŒ…å«æ‰€æœ‰å±æ€§ï¼‰
- DTOï¼šåŒ…è£…å¥½çš„ç¤¼ç›’ï¼ˆåªåŒ…å«éœ€è¦çš„éƒ¨åˆ†ï¼‰

ä¸ºä»€ä¹ˆç”¨DTOï¼Ÿ
âœ… æ€§èƒ½ä¼˜åŒ–ï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
âœ… å®‰å…¨æ€§ï¼šä¸æš´éœ²æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼‰
âœ… çµæ´»æ€§ï¼šç»„åˆå¤šä¸ªè¡¨çš„æ•°æ®
âœ… å‡å°‘ä¾èµ–ï¼šå‰ç«¯ä¸ä¾èµ–å®ä½“ç±»
```

**å®ä½“ vs DTOå¯¹æ¯”**ï¼š
```
ç”¨æˆ·å®ä½“ï¼ˆEntityï¼‰ï¼š
- id, username, password, email, phone, 
  address, createTime, updateTime, isDeleted...
  ï¼ˆåŒ…å«æ‰€æœ‰æ•°æ®åº“å­—æ®µï¼‰

ç”¨æˆ·DTOï¼ˆä»…å±•ç¤ºéœ€è¦çš„ï¼‰ï¼š
- username, email
  ï¼ˆåªæœ‰å‰ç«¯éœ€è¦çš„å­—æ®µï¼‰
```

### 4.2 JPAæ„é€ å™¨æ˜ å°„ï¼ˆæ¨èæ–¹å¼ï¼‰


**ğŸŸ¢ æœ€ä½³å®è·µï¼šä½¿ç”¨æ„é€ å™¨è¡¨è¾¾å¼**

```java
// æ­¥éª¤1ï¼šåˆ›å»ºDTOï¼ˆå¸¦æ„é€ å™¨ï¼‰
public class UserSimpleDTO {
    private Long id;
    private String username;
    private String email;
    
    // å…³é”®ï¼šæä¾›å…¨å‚æ„é€ å™¨
    public UserSimpleDTO(Long id, String username, String email) {
        this.id = id;
        this.username = username;
        this.email = email;
    }
    
    // getteræ–¹æ³•
    public Long getId() { return id; }
    public String getUsername() { return username; }
    public String getEmail() { return email; }
}

// æ­¥éª¤2ï¼šä½¿ç”¨æ„é€ å™¨è¡¨è¾¾å¼æŸ¥è¯¢ï¼ˆJPQLæ–¹å¼ï¼‰
String jpql = """
    SELECT new com.example.dto.UserSimpleDTO(
        u.id, 
        u.username, 
        u.email
    )
    FROM User u
    WHERE u.age > :age
    """;

List<UserSimpleDTO> users = session.createQuery(jpql, UserSimpleDTO.class)
    .setParameter("age", 18)
    .getResultList();
```

**ä¼˜åŠ¿å¯¹æ¯”**ï¼š
| ç‰¹æ€§ | **æ„é€ å™¨æ˜ å°„** | **AliasToBeanTransformer** |
|------|--------------|---------------------------|
| ç±»å‹å®‰å…¨ | âœ… ç¼–è¯‘æœŸæ£€æŸ¥ | âŒ è¿è¡Œæ—¶æ‰çŸ¥é“é”™è¯¯ |
| æ€§èƒ½ | âš¡ æ›´å¿«ï¼ˆç›´æ¥æ„é€ ï¼‰ | ğŸŒ æ…¢ä¸€äº›ï¼ˆåå°„è°ƒç”¨ï¼‰ |
| ä½¿ç”¨æ–¹å¼ | JPQL/HQL | Native SQL |
| æ¨èç¨‹åº¦ | ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ | ğŸ”¥ğŸ”¥ğŸ”¥ |

### 4.3 å¤æ‚DTOæ˜ å°„åœºæ™¯


**åœºæ™¯ï¼šè·¨è¡¨å…³è”æŸ¥è¯¢**

```java
// è®¢å•è¯¦æƒ…DTOï¼ˆåŒ…å«ç”¨æˆ·å’Œå•†å“ä¿¡æ¯ï¼‰
public class OrderDetailDTO {
    private Long orderId;
    private String userName;
    private String productName;
    private Integer quantity;
    private BigDecimal totalPrice;
    
    // å…¨å‚æ„é€ å™¨
    public OrderDetailDTO(Long orderId, String userName, 
                          String productName, Integer quantity, 
                          BigDecimal totalPrice) {
        this.orderId = orderId;
        this.userName = userName;
        this.productName = productName;
        this.quantity = quantity;
        this.totalPrice = totalPrice;
    }
    
    // getteræ–¹æ³•...
}

// JPQLå…³è”æŸ¥è¯¢
String jpql = """
    SELECT new com.example.dto.OrderDetailDTO(
        o.id,
        u.username,
        p.productName,
        oi.quantity,
        oi.quantity * p.price
    )
    FROM Order o
    JOIN o.user u
    JOIN o.orderItems oi
    JOIN oi.product p
    WHERE o.status = 'COMPLETED'
    """;

List<OrderDetailDTO> details = session.createQuery(jpql, OrderDetailDTO.class)
    .getResultList();
```

---

## 5. ğŸ—ºï¸ Mapç»“æœæ˜ å°„


### 5.1 Mapæ˜ å°„çš„ä½¿ç”¨åœºæ™¯


**ğŸ”¸ ä»€ä¹ˆæ—¶å€™ç”¨Mapï¼Ÿ**
```
é€‚åˆåœºæ™¯ï¼š
âœ… åŠ¨æ€æŸ¥è¯¢ï¼šä¸ç¡®å®šè¿”å›å“ªäº›å­—æ®µ
âœ… ä¸´æ—¶æŸ¥è¯¢ï¼šä¸€æ¬¡æ€§ç»Ÿè®¡ï¼Œä¸æƒ³å»ºDTO
âœ… çµæ´»å±•ç¤ºï¼šå‰ç«¯è‡ªå·±è§£æJSON
âœ… èšåˆæŸ¥è¯¢ï¼šGROUP BYç»Ÿè®¡ç»“æœ

ä¸é€‚åˆåœºæ™¯ï¼š
âŒ å›ºå®šæ ¼å¼ï¼šæ˜ç¡®çŸ¥é“è¿”å›å­—æ®µï¼ˆç”¨DTOæ›´å¥½ï¼‰
âŒ ç±»å‹å®‰å…¨ï¼šéœ€è¦ç¼–è¯‘æœŸæ£€æŸ¥ï¼ˆç”¨DTOï¼‰
âŒ å¤æ‚é€»è¾‘ï¼šéœ€è¦ä¸šåŠ¡æ–¹æ³•ï¼ˆç”¨DTOï¼‰
```

### 5.2 Mapæ˜ å°„å®ç°æ–¹å¼


**æ–¹å¼1ï¼šHibernate Transformerï¼ˆå·²åºŸå¼ƒä½†è¦ç†è§£ï¼‰**
```java
String sql = """
    SELECT 
        u.id AS userId,
        u.name AS userName,
        COUNT(o.id) AS orderCount
    FROM user u
    LEFT JOIN orders o ON u.id = o.user_id
    GROUP BY u.id, u.name
    """;

// æ¯è¡Œè½¬æˆä¸€ä¸ªMap
List<Map<String, Object>> results = session.createNativeQuery(sql)
    .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP)
    .list();

// ä½¿ç”¨ç»“æœ
results.forEach(map -> {
    System.out.println("ç”¨æˆ·IDï¼š" + map.get("userId"));
    System.out.println("ç”¨æˆ·åï¼š" + map.get("userName"));
    System.out.println("è®¢å•æ•°ï¼š" + map.get("orderCount"));
});
```

**æ–¹å¼2ï¼šTupleæ˜ å°„ï¼ˆJPAæ¨èï¼‰**
```java
String jpql = """
    SELECT 
        u.id AS userId,
        u.username AS userName,
        COUNT(o) AS orderCount
    FROM User u
    LEFT JOIN u.orders o
    GROUP BY u.id, u.username
    """;

// ä½¿ç”¨Tupleæ¥æ”¶ï¼ˆæ›´ç±»å‹å®‰å…¨ï¼‰
List<Tuple> tuples = session.createQuery(jpql, Tuple.class)
    .getResultList();

tuples.forEach(tuple -> {
    Long userId = tuple.get("userId", Long.class);
    String userName = tuple.get("userName", String.class);
    Long orderCount = tuple.get("orderCount", Long.class);
    
    System.out.println(userId + " - " + userName + ": " + orderCount);
});
```

### 5.3 Map vs DTO é€‰æ‹©æŒ‡å—


```
ä½¿ç”¨Mapçš„æƒ…å†µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ä¸€æ¬¡æ€§ä¸´æ—¶æŸ¥è¯¢        â”‚
â”‚ 2. å­—æ®µæ•°é‡ä¸ç¡®å®š        â”‚
â”‚ 3. å¿«é€ŸåŸå‹å¼€å‘          â”‚
â”‚ 4. èšåˆç»Ÿè®¡æŠ¥è¡¨          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½¿ç”¨DTOçš„æƒ…å†µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å›ºå®šæ ¼å¼çš„æŸ¥è¯¢        â”‚
â”‚ 2. éœ€è¦ç±»å‹å®‰å…¨          â”‚
â”‚ 3. åŒ…å«ä¸šåŠ¡é€»è¾‘          â”‚
â”‚ 4. APIæ¥å£è¿”å›å¯¹è±¡       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. ğŸ”¢ æ ‡é‡ç»“æœå¤„ç†


### 6.1 ä»€ä¹ˆæ˜¯æ ‡é‡æŸ¥è¯¢


**ğŸ”¸ æ ‡é‡çš„æ¦‚å¿µ**
```
æ ‡é‡ï¼ˆScalarï¼‰= å•ä¸€å€¼ï¼Œä¸æ˜¯å¯¹è±¡

ç±»æ¯”ç†è§£ï¼š
- å¯¹è±¡æŸ¥è¯¢ï¼šä¹°ä¸€æ•´ç›’æœˆé¥¼ï¼ˆå¤šä¸ªå€¼ç»„æˆçš„å¯¹è±¡ï¼‰
- æ ‡é‡æŸ¥è¯¢ï¼šåªä¹°ä¸€ä¸ªæœˆé¥¼ï¼ˆå•ä¸ªå€¼ï¼‰

å¸¸è§æ ‡é‡æŸ¥è¯¢ï¼š
âœ… ç»Ÿè®¡æ€»æ•°ï¼šSELECT COUNT(*) FROM user
âœ… æ±‚å’Œï¼šSELECT SUM(price) FROM orders  
âœ… å¹³å‡å€¼ï¼šSELECT AVG(age) FROM user
âœ… å•ä¸ªå­—æ®µï¼šSELECT name FROM user WHERE id = 1
```

### 6.2 æ ‡é‡æŸ¥è¯¢å®ç°


**å•ä¸ªæ ‡é‡å€¼**
```java
// åœºæ™¯1ï¼šç»Ÿè®¡æ€»æ•°
String sql = "SELECT COUNT(*) FROM user";
Long userCount = (Long) session.createNativeQuery(sql)
    .getSingleResult();
System.out.println("ç”¨æˆ·æ€»æ•°ï¼š" + userCount);

// åœºæ™¯2ï¼šæ±‚å’Œ
String sql2 = "SELECT SUM(price) FROM orders WHERE status = 'PAID'";
BigDecimal totalSales = (BigDecimal) session.createNativeQuery(sql2)
    .getSingleResult();
System.out.println("é”€å”®æ€»é¢ï¼š" + totalSales);

// åœºæ™¯3ï¼šè·å–å•ä¸ªå­—æ®µ
String sql3 = "SELECT email FROM user WHERE username = :username";
String email = (String) session.createNativeQuery(sql3)
    .setParameter("username", "zhangsan")
    .getSingleResult();
```

**å¤šä¸ªæ ‡é‡å€¼åˆ—è¡¨**
```java
// æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·å¹´é¾„
String sql = "SELECT age FROM user ORDER BY age";
List<Integer> ages = session.createNativeQuery(sql)
    .getResultList();

ages.forEach(age -> System.out.println("å¹´é¾„ï¼š" + age));
```

### 6.3 æ ‡é‡ç±»å‹è½¬æ¢


**å¸¸è§ç±»å‹æ˜ å°„**
```java
// æ—¥æœŸç±»å‹å¤„ç†
String sql = "SELECT create_time FROM orders WHERE id = :id";
Date createTime = (Date) session.createNativeQuery(sql)
    .setParameter("id", 1L)
    .getSingleResult();

// Booleanç±»å‹å¤„ç†ï¼ˆæ•°æ®åº“å­˜0/1ï¼‰
String sql2 = "SELECT is_active FROM user WHERE id = :id";
Integer activeFlag = (Integer) session.createNativeQuery(sql2)
    .setParameter("id", 1L)
    .getSingleResult();
boolean isActive = activeFlag == 1;  // æ‰‹åŠ¨è½¬æ¢

// æšä¸¾ç±»å‹å¤„ç†
String sql3 = "SELECT status FROM orders WHERE id = :id";
String statusStr = (String) session.createNativeQuery(sql3)
    .setParameter("id", 1L)
    .getSingleResult();
OrderStatus status = OrderStatus.valueOf(statusStr);  // è½¬æ¢ä¸ºæšä¸¾
```

---

## 7. ğŸ› ï¸ è‡ªå®šä¹‰è½¬æ¢å™¨å¼€å‘


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰è½¬æ¢å™¨


**ä½¿ç”¨åœºæ™¯**ï¼š
```
åœºæ™¯1ï¼šå¤æ‚æ•°æ®å¤„ç†
- éœ€è¦å¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œè®¡ç®—
- éœ€è¦ç»„åˆå¤šä¸ªå­—æ®µ
- éœ€è¦æ ¼å¼åŒ–å¤„ç†

åœºæ™¯2ï¼šç‰¹æ®Šç±»å‹è½¬æ¢  
- JSONå­—ç¬¦ä¸²è½¬å¯¹è±¡
- è‡ªå®šä¹‰æšä¸¾è½¬æ¢
- åŠ å¯†å­—æ®µè§£å¯†

åœºæ™¯3ï¼šæ€§èƒ½ä¼˜åŒ–
- æ‰¹é‡æ•°æ®é¢„å¤„ç†
- ç¼“å­˜ç»“æœè½¬æ¢
```

### 7.2 å®ç°è‡ªå®šä¹‰è½¬æ¢å™¨


**æ¥å£å®šä¹‰ï¼ˆç†è§£æ¦‚å¿µï¼‰**
```java
// ResultTransformeræ¥å£ï¼ˆç®€åŒ–ç‰ˆç†è§£ï¼‰
public interface ResultTransformer {
    // è½¬æ¢å•è¡Œç»“æœ
    Object transformTuple(Object[] tuple, String[] aliases);
    
    // è½¬æ¢æ•´ä¸ªç»“æœé›†ï¼ˆå¯é€‰ï¼‰
    List transformList(List collection);
}
```

**å®æˆ˜ç¤ºä¾‹ï¼šè®¢å•é‡‘é¢è®¡ç®—è½¬æ¢å™¨**
```java
// è‡ªå®šä¹‰è½¬æ¢å™¨ï¼šè®¡ç®—è®¢å•å®ä»˜é‡‘é¢
public class OrderAmountTransformer implements ResultTransformer {
    
    @Override
    public Object transformTuple(Object[] tuple, String[] aliases) {
        // tupleæ•°ç»„ï¼š[orderId, originalPrice, discount, taxRate]
        Long orderId = (Long) tuple[0];
        BigDecimal originalPrice = (BigDecimal) tuple[1];
        BigDecimal discount = (BigDecimal) tuple[2];
        BigDecimal taxRate = (BigDecimal) tuple[3];
        
        // è®¡ç®—å®ä»˜é‡‘é¢ = (åŸä»· - æŠ˜æ‰£) * (1 + ç¨ç‡)
        BigDecimal finalPrice = originalPrice
            .subtract(discount)
            .multiply(BigDecimal.ONE.add(taxRate));
        
        // è¿”å›è‡ªå®šä¹‰å¯¹è±¡
        return new OrderAmount(orderId, originalPrice, 
                               discount, taxRate, finalPrice);
    }
    
    @Override
    public List transformList(List collection) {
        return collection;  // ä¸åšé¢å¤–å¤„ç†
    }
}

// ç»“æœå¯¹è±¡
public class OrderAmount {
    private Long orderId;
    private BigDecimal originalPrice;
    private BigDecimal discount;
    private BigDecimal taxRate;
    private BigDecimal finalPrice;  // è®¡ç®—å¾—å‡º
    
    // æ„é€ å™¨ã€getter...
}

// ä½¿ç”¨è‡ªå®šä¹‰è½¬æ¢å™¨
String sql = """
    SELECT 
        id, original_price, discount, tax_rate
    FROM orders
    WHERE status = 'PENDING'
    """;

List<OrderAmount> results = session.createNativeQuery(sql)
    .setResultTransformer(new OrderAmountTransformer())
    .list();
```

### 7.3 è‡ªå®šä¹‰è½¬æ¢å™¨æœ€ä½³å®è·µ


**ğŸ’¡ å®è·µå»ºè®®**

> **âœ¨ æ¨èåšæ³•**ï¼šä¼˜å…ˆè€ƒè™‘ä»¥ä¸‹æ–¹æ¡ˆ
> - ä½¿ç”¨JPAæ„é€ å™¨è¡¨è¾¾å¼ï¼ˆç±»å‹å®‰å…¨ï¼‰
> - ä½¿ç”¨æ•°æ®åº“è§†å›¾æˆ–è®¡ç®—å­—æ®µ
> - åœ¨Serviceå±‚å¤„ç†ä¸šåŠ¡é€»è¾‘
>
> **âš ï¸ è°¨æ…ä½¿ç”¨**ï¼šè‡ªå®šä¹‰è½¬æ¢å™¨é€‚åˆ
> - å¤æ‚çš„æ•°æ®æ ¼å¼è½¬æ¢
> - é€šç”¨çš„ç»“æœå¤„ç†é€»è¾‘
> - æ€§èƒ½æ•æ„Ÿçš„æ‰¹é‡å¤„ç†

**è½¬æ¢å™¨æ€§èƒ½è€ƒè™‘**ï¼š
```
æ€§èƒ½å¯¹æ¯”ï¼ˆ10000æ¡è®°å½•ï¼‰ï¼š

ç›´æ¥æŸ¥è¯¢å®ä½“ï¼š        ~200ms
æ ‡é‡æŸ¥è¯¢ï¼š            ~100ms
DTOæ„é€ å™¨æ˜ å°„ï¼š       ~150ms
è‡ªå®šä¹‰è½¬æ¢å™¨ï¼š        ~180msï¼ˆå«ä¸šåŠ¡é€»è¾‘ï¼‰
Mapæ˜ å°„ï¼š             ~120ms

ç»“è®ºï¼šæ ¹æ®åœºæ™¯é€‰æ‹©ï¼Œä¸è¦è¿‡åº¦ä¼˜åŒ–
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


ğŸ”¸ **ç»“æœæ˜ å°„æœ¬è´¨**ï¼šå°†æ•°æ®åº“åŸå§‹ç»“æœè½¬æ¢æˆJavaå¯¹è±¡çš„è¿‡ç¨‹

ğŸ”¸ **äº”ç§æ˜ å°„æ–¹å¼**ï¼š
```
1. ResultTransformerï¼ˆå·²åºŸå¼ƒï¼Œç†è§£åŸç†ï¼‰
2. AliasToBeanResultTransformerï¼ˆå¿«é€ŸDTOæ˜ å°„ï¼‰  
3. JPAæ„é€ å™¨æ˜ å°„ï¼ˆæœ€æ¨èï¼‰
4. Map/Tupleæ˜ å°„ï¼ˆçµæ´»ä½†æ— ç±»å‹å®‰å…¨ï¼‰
5. æ ‡é‡æŸ¥è¯¢ï¼ˆå•å€¼æŸ¥è¯¢ï¼‰
```

ğŸ”¸ **é€‰æ‹©å†³ç­–æ ‘**ï¼š
```
éœ€è¦ä»€ä¹ˆç±»å‹çš„ç»“æœï¼Ÿ
    â†“
å•ä¸ªå€¼ â†’ æ ‡é‡æŸ¥è¯¢
    â†“
ä¸´æ—¶/åŠ¨æ€æŸ¥è¯¢ â†’ Map/Tuple
    â†“
å›ºå®šæ ¼å¼å¯¹è±¡ â†’ DTOæ˜ å°„
    â†“
    ç”¨JPQLï¼Ÿâ†’ æ„é€ å™¨è¡¨è¾¾å¼ï¼ˆæ¨èï¼‰
    ç”¨SQLï¼Ÿâ†’ AliasToBeanTransformer
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ DTOæ˜ å°„çš„ä¸‰è¦ç´ **
```
1. åˆ«ååŒ¹é…ï¼šSQLåˆ«å = DTOå±æ€§å
2. ç±»å‹åŒ¹é…ï¼šæ•°æ®åº“ç±»å‹ â†’ Javaç±»å‹
3. è®¿é—®æ–¹æ³•ï¼šsetteræ–¹æ³•æˆ–æ„é€ å™¨
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–åŸåˆ™**
```
âœ… åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼ˆç”¨DTOä»£æ›¿å®Œæ•´å®ä½“ï¼‰
âœ… ä½¿ç”¨æ„é€ å™¨æ˜ å°„ï¼ˆæ¯”åå°„å¿«ï¼‰
âœ… åˆç†ä½¿ç”¨ç¼“å­˜
âŒ é¿å…N+1æŸ¥è¯¢é—®é¢˜
âŒ ä¸è¦è¿‡åº¦æŠ½è±¡è½¬æ¢é€»è¾‘
```

**ğŸ”¹ å¸¸è§è¯¯åŒºé¿å‘**
```
â— è¯¯åŒº1ï¼šå­—æ®µåä¸åŒ¹é…å¯¼è‡´null
   â†’ è§£å†³ï¼šæ£€æŸ¥SQLåˆ«åå’ŒDTOå±æ€§å

â— è¯¯åŒº2ï¼šç±»å‹è½¬æ¢å¼‚å¸¸
   â†’ è§£å†³ï¼šç¡®ä¿Javaç±»å‹å’Œæ•°æ®åº“ç±»å‹å…¼å®¹

â— è¯¯åŒº3ï¼šä½¿ç”¨å·²åºŸå¼ƒçš„API
   â†’ è§£å†³ï¼šä¼˜å…ˆä½¿ç”¨JPAæ ‡å‡†æ–¹å¼
```

### 8.3 å®æˆ˜åº”ç”¨å»ºè®®


**ğŸ“š å­¦ä¹ è·¯å¾„**
```
ç¬¬ä¸€æ­¥ï¼šæŒæ¡åŸºç¡€
â”œâ”€ ç†è§£ResultTransformeråŸç†
â”œâ”€ å­¦ä¼šAliasToBeanResultTransformer
â””â”€ æŒæ¡æ ‡é‡æŸ¥è¯¢

ç¬¬äºŒæ­¥ï¼šè¿›é˜¶æŠ€å·§  
â”œâ”€ JPAæ„é€ å™¨è¡¨è¾¾å¼
â”œâ”€ Tupleæ˜ å°„
â””â”€ å¤æ‚DTOè®¾è®¡

ç¬¬ä¸‰æ­¥ï¼šé«˜çº§åº”ç”¨
â”œâ”€ è‡ªå®šä¹‰è½¬æ¢å™¨
â”œâ”€ æ€§èƒ½ä¼˜åŒ–
â””â”€ æœ€ä½³å®è·µ
```

**ğŸ¯ å®é™…é¡¹ç›®å»ºè®®**
- **80%åœºæ™¯**ï¼šä½¿ç”¨JPAæ„é€ å™¨è¡¨è¾¾å¼ï¼ˆç±»å‹å®‰å…¨ã€æ€§èƒ½å¥½ï¼‰
- **15%åœºæ™¯**ï¼šä½¿ç”¨Map/Tupleï¼ˆä¸´æ—¶æŸ¥è¯¢ã€ç»Ÿè®¡æŠ¥è¡¨ï¼‰
- **5%åœºæ™¯**ï¼šè‡ªå®šä¹‰è½¬æ¢å™¨ï¼ˆå¤æ‚ä¸šåŠ¡é€»è¾‘ï¼‰

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ğŸµ ç»“æœæ˜ å°„æœ‰äº”ç§ï¼Œæ„é€ å™¨æ˜ å°„æœ€å¸¸ç”¨
   åˆ«åå±æ€§è¦åŒ¹é…ï¼Œç±»å‹è½¬æ¢è«å‡ºé”™  
   æ ‡é‡æŸ¥è¯¢æœ€ç®€å•ï¼ŒMapæ˜ å°„æœ€çµæ´»
   æ€§èƒ½ä¼˜åŒ–é€‰DTOï¼ŒåªæŸ¥éœ€è¦çš„å­—æ®µ
```

---

> ğŸ’¡ **å­¦ä¹ å»ºè®®**ï¼š
> - å…ˆç†è§£ResultTransformeråŸç†ï¼ˆè™½ç„¶å·²åºŸå¼ƒï¼‰
> - é‡ç‚¹æŒæ¡JPAæ„é€ å™¨è¡¨è¾¾å¼ï¼ˆå®é™…é¡¹ç›®é¦–é€‰ï¼‰
> - æ ¹æ®åœºæ™¯çµæ´»é€‰æ‹©æ˜ å°„æ–¹å¼
> - æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ˜¯å‡å°‘æŸ¥è¯¢å­—æ®µå’Œæ¬¡æ•°

> ğŸ”— **ç›¸å…³ä¸»é¢˜**ï¼š
> - `HQL/JPQLæŸ¥è¯¢è¯­æ³•` - å¯¹è±¡æŸ¥è¯¢è¯­è¨€
> - `Criteria API` - ç±»å‹å®‰å…¨çš„æŸ¥è¯¢
> - `æ€§èƒ½ä¼˜åŒ–ç­–ç•¥` - æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§