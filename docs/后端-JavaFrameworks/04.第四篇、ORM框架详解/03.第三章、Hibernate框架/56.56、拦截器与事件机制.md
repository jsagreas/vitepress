---
title: 56ã€æ‹¦æˆªå™¨ä¸äº‹ä»¶æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨ä¸äº‹ä»¶æœºåˆ¶](#1-ä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨ä¸äº‹ä»¶æœºåˆ¶)
2. [Interceptoræ‹¦æˆªå™¨è¯¦è§£](#2-Interceptoræ‹¦æˆªå™¨è¯¦è§£)
3. [äº‹ä»¶ç›‘å¬å™¨EventListener](#3-äº‹ä»¶ç›‘å¬å™¨EventListener)
4. [Loadäº‹ä»¶è¯¦è§£](#4-Loadäº‹ä»¶è¯¦è§£)
5. [Insertäº‹ä»¶è¯¦è§£](#5-Insertäº‹ä»¶è¯¦è§£)
6. [Updateäº‹ä»¶è¯¦è§£](#6-Updateäº‹ä»¶è¯¦è§£)
7. [Deleteäº‹ä»¶è¯¦è§£](#7-Deleteäº‹ä»¶è¯¦è§£)
8. [å®é™…åº”ç”¨åœºæ™¯](#8-å®é™…åº”ç”¨åœºæ™¯)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨ä¸äº‹ä»¶æœºåˆ¶


### 1.1 æ ¸å¿ƒæ¦‚å¿µç†è§£


**ğŸ¤” ä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨å’Œäº‹ä»¶ï¼Ÿ**

æƒ³è±¡ä½ åœ¨ç½‘ä¸Šè´­ç‰©ï¼Œä»ä¸‹å•åˆ°æ”¶è´§çš„æ•´ä¸ªè¿‡ç¨‹ï¼š

```
ä¸‹å• â†’ æ”¯ä»˜ â†’ å‘è´§ â†’ é…é€ â†’ ç­¾æ”¶
 â†“      â†“      â†“      â†“      â†“
è®°å½•   æ‰£æ¬¾   é€šçŸ¥   è·Ÿè¸ª   è¯„ä»·
```

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªç¯èŠ‚éƒ½å¯èƒ½è§¦å‘ä¸€äº›"é¢å¤–æ“ä½œ"ï¼ˆæ¯”å¦‚è®°å½•æ—¥å¿—ã€å‘é€é€šçŸ¥ï¼‰ã€‚Hibernateçš„æ‹¦æˆªå™¨å’Œäº‹ä»¶æœºåˆ¶å°±æ˜¯è¿™ä¸ªé“ç†ï¼š

- **æ‹¦æˆªå™¨**ï¼šåƒä¸€ä¸ª"ä¸‡èƒ½ç®¡å®¶"ï¼Œå¯ä»¥åœ¨æ•°æ®åº“æ“ä½œçš„å„ä¸ªç¯èŠ‚æ’æ‰‹
- **äº‹ä»¶ç›‘å¬å™¨**ï¼šåƒä¸€ä¸ª"ä¸“èŒåŠ©æ‰‹"ï¼Œåªè´Ÿè´£æŸä¸ªç‰¹å®šç¯èŠ‚çš„å·¥ä½œ

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæœºåˆ¶


**ğŸ“‹ å®é™…éœ€æ±‚åœºæ™¯**

| éœ€æ±‚åœºæ™¯ | **ä¼ ç»Ÿåšæ³•** | **ä½¿ç”¨æ‹¦æˆªå™¨/äº‹ä»¶** |
|---------|------------|------------------|
| ğŸ”¸ **æ“ä½œæ—¥å¿—** | `æ¯ä¸ªä¿å­˜æ–¹æ³•éƒ½å†™æ—¥å¿—ä»£ç ` | `è‡ªåŠ¨è®°å½•æ‰€æœ‰æ“ä½œ` |
| ğŸ”¸ **æ•°æ®å®¡è®¡** | `æ‰‹åŠ¨è®°å½•ä¿®æ”¹äººå’Œæ—¶é—´` | `è‡ªåŠ¨å¡«å……å®¡è®¡å­—æ®µ` |
| ğŸ”¸ **æ•°æ®æ ¡éªŒ** | `ä¸šåŠ¡ä»£ç ä¸­åˆ°å¤„å†™æ ¡éªŒ` | `ç»Ÿä¸€æ ¡éªŒå…¥å£` |
| ğŸ”¸ **ç¼“å­˜åŒæ­¥** | `æ¯æ¬¡ä¿®æ”¹éƒ½è¦æ›´æ–°ç¼“å­˜` | `è‡ªåŠ¨ç›‘å¬å˜åŒ–æ›´æ–°` |

> ğŸ’¡ **æ ¸å¿ƒä»·å€¼**  
> æŠŠ"é‡å¤çš„ã€é€šç”¨çš„ã€æ¨ªåˆ‡çš„"é€»è¾‘ä»ä¸šåŠ¡ä»£ç ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œè®©ä»£ç æ›´å¹²å‡€ã€æ›´æ˜“ç»´æŠ¤

### 1.3 ä¸¤è€…çš„åŒºåˆ«


**æ‹¦æˆªå™¨ vs äº‹ä»¶ç›‘å¬å™¨**

```
æ‹¦æˆªå™¨(Interceptor)           äº‹ä»¶ç›‘å¬å™¨(EventListener)
      â”‚                              â”‚
      â”œâ”€ å…¨èƒ½å‹é€‰æ‰‹                   â”œâ”€ ä¸“ä¸šå‹é€‰æ‰‹
      â”œâ”€ ä¸€ä¸ªç±»å¤„ç†å¤šç§äº‹ä»¶            â”œâ”€ ä¸€ä¸ªç±»åªå¤„ç†ä¸€ç§äº‹ä»¶
      â”œâ”€ å¯ä»¥ä¿®æ”¹æ•°æ®                 â”œâ”€ é€šå¸¸åªåšç›‘å¬
      â”œâ”€ é…ç½®ç›¸å¯¹ç®€å•                 â”œâ”€ é…ç½®æ›´çµæ´»
      â””â”€ å…¨å±€ç”Ÿæ•ˆ                     â””â”€ å¯ä»¥ç²¾ç¡®æ§åˆ¶
```

ğŸŒ° **ç”Ÿæ´»ç±»æ¯”**ï¼š
- **æ‹¦æˆªå™¨**ï¼šåƒä¸€ä¸ªå…¨ç§‘åŒ»ç”Ÿï¼Œä»€ä¹ˆç—…éƒ½èƒ½çœ‹
- **äº‹ä»¶ç›‘å¬å™¨**ï¼šåƒä¸“ç§‘åŒ»ç”Ÿï¼Œåªçœ‹æŸä¸€ç±»ç—…ï¼Œä½†æ›´ä¸“ä¸š

---

## 2. ğŸ”§ Interceptoræ‹¦æˆªå™¨è¯¦è§£


### 2.1 Interceptoræ˜¯ä»€ä¹ˆ


**ğŸ“– é€šä¿—è§£é‡Š**

Interceptorï¼ˆæ‹¦æˆªå™¨ï¼‰å°±åƒä¸€ä¸ª"ç›‘å·¥"ï¼Œåœ¨Hibernateæ‰§è¡Œæ•°æ®åº“æ“ä½œçš„å…³é”®æ—¶åˆ»ï¼Œå®ƒä¼š"æ’ä¸€è„š"ï¼Œè®©ä½ æœ‰æœºä¼šåšä¸€äº›é¢å¤–çš„äº‹æƒ…ã€‚

```
æ­£å¸¸æµç¨‹:  ä¸šåŠ¡ä»£ç  â”€â”€â–¶ Hibernate â”€â”€â–¶ æ•°æ®åº“

åŠ äº†æ‹¦æˆªå™¨: ä¸šåŠ¡ä»£ç  â”€â”€â–¶ ã€æ‹¦æˆªå™¨ä»‹å…¥ã€‘â”€â”€â–¶ Hibernate â”€â”€â–¶ æ•°æ®åº“
                           â†“
                      (å¯ä»¥è®°æ—¥å¿—ã€æ”¹æ•°æ®ã€åšæ ¡éªŒç­‰)
```

### 2.2 Interceptoræ¥å£æ ¸å¿ƒæ–¹æ³•


**ğŸ”¸ æœ€å¸¸ç”¨çš„æ–¹æ³•**

```java
public interface Interceptor {
    
    // ğŸ”¹ ä¿å­˜ä¹‹å‰è°ƒç”¨
    boolean onSave(Object entity, Serializable id, 
                   Object[] state, String[] propertyNames, Type[] types);
    
    // ğŸ”¹ æ›´æ–°ä¹‹å‰è°ƒç”¨
    boolean onFlushDirty(Object entity, Serializable id, 
                         Object[] currentState, Object[] previousState, 
                         String[] propertyNames, Type[] types);
    
    // ğŸ”¹ åˆ é™¤ä¹‹å‰è°ƒç”¨
    void onDelete(Object entity, Serializable id, 
                  Object[] state, String[] propertyNames, Type[] types);
    
    // ğŸ”¹ åŠ è½½ä¹‹åè°ƒç”¨
    boolean onLoad(Object entity, Serializable id, 
                   Object[] state, String[] propertyNames, Type[] types);
}
```

**ğŸ“ æ–¹æ³•å‚æ•°è¯´æ˜**ï¼š

- `entity`: å½“å‰æ“ä½œçš„å®ä½“å¯¹è±¡ï¼ˆæ¯”å¦‚Userå¯¹è±¡ï¼‰
- `id`: å®ä½“çš„ä¸»é”®å€¼
- `state`: å®ä½“çš„å±æ€§å€¼æ•°ç»„ï¼ˆå½“å‰çŠ¶æ€ï¼‰
- `propertyNames`: å±æ€§åç§°æ•°ç»„
- `types`: å±æ€§ç±»å‹æ•°ç»„

### 2.3 å®æˆ˜ç¤ºä¾‹ï¼šå®¡è®¡æ‹¦æˆªå™¨


**ğŸ’¼ éœ€æ±‚**ï¼šè‡ªåŠ¨è®°å½•æ¯æ¡æ•°æ®çš„åˆ›å»ºæ—¶é—´å’Œä¿®æ”¹æ—¶é—´

```java
// å®¡è®¡æ‹¦æˆªå™¨ - è‡ªåŠ¨å¡«å……æ—¶é—´å­—æ®µ
public class AuditInterceptor extends EmptyInterceptor {
    
    @Override
    public boolean onSave(Object entity, Serializable id, 
                          Object[] state, String[] propertyNames, 
                          Type[] types) {
        
        // æ‰¾åˆ°createTimeå±æ€§çš„ä½ç½®
        for (int i = 0; i < propertyNames.length; i++) {
            if ("createTime".equals(propertyNames[i])) {
                state[i] = new Date(); // è®¾ç½®åˆ›å»ºæ—¶é—´
            }
        }
        return true; // è¿”å›trueè¡¨ç¤ºstateè¢«ä¿®æ”¹äº†
    }
    
    @Override
    public boolean onFlushDirty(Object entity, Serializable id,
                                Object[] currentState, Object[] previousState,
                                String[] propertyNames, Type[] types) {
        
        // æ‰¾åˆ°updateTimeå±æ€§çš„ä½ç½®
        for (int i = 0; i < propertyNames.length; i++) {
            if ("updateTime".equals(propertyNames[i])) {
                currentState[i] = new Date(); // æ›´æ–°ä¿®æ”¹æ—¶é—´
            }
        }
        return true;
    }
}
```

**ğŸ”§ é…ç½®æ‹¦æˆªå™¨**

```java
// æ–¹å¼1: å…¨å±€é…ç½®
SessionFactory factory = new Configuration()
    .setInterceptor(new AuditInterceptor())
    .buildSessionFactory();

// æ–¹å¼2: å•ä¸ªSessioné…ç½®
Session session = factory
    .withOptions()
    .interceptor(new AuditInterceptor())
    .openSession();
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**  
> æ‹¦æˆªå™¨ä¸­ä¸è¦æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œå¯èƒ½å¯¼è‡´æ— é™å¾ªç¯ï¼

---

## 3. ğŸ§ äº‹ä»¶ç›‘å¬å™¨EventListener


### 3.1 äº‹ä»¶ç›‘å¬å™¨æ˜¯ä»€ä¹ˆ


**ğŸ“– é€šä¿—ç†è§£**

äº‹ä»¶ç›‘å¬å™¨å°±åƒ"ä¸“èŒä¿å®‰"ï¼Œæ¯ä¸ªä¿å®‰åªè´Ÿè´£ä¸€ä¸ªå²—ä½ï¼š

```
æ•°æ®åº“æ“ä½œæµç¨‹:
   åŠ è½½ â”€â”€â–¶ ä¿®æ”¹ â”€â”€â–¶ ä¿å­˜ â”€â”€â–¶ åˆ é™¤
    â†“        â†“        â†“        â†“
 LoadListener UpdateListener SaveListener DeleteListener
(åŠ è½½ç›‘å¬å™¨) (æ›´æ–°ç›‘å¬å™¨) (ä¿å­˜ç›‘å¬å™¨) (åˆ é™¤ç›‘å¬å™¨)
```

### 3.2 äº‹ä»¶ç›‘å¬å™¨çš„ç±»å‹


**ğŸ”¸ ä¸»è¦çš„äº‹ä»¶ç±»å‹**

| äº‹ä»¶é˜¶æ®µ | **Preäº‹ä»¶** | **Postäº‹ä»¶** | **è¯´æ˜** |
|---------|-----------|------------|---------|
| ğŸ”¸ **Load** | `PreLoadEvent` | `PostLoadEvent` | `åŠ è½½æ•°æ®å‰å` |
| ğŸ”¸ **Insert** | `PreInsertEvent` | `PostInsertEvent` | `æ’å…¥æ•°æ®å‰å` |
| ğŸ”¸ **Update** | `PreUpdateEvent` | `PostUpdateEvent` | `æ›´æ–°æ•°æ®å‰å` |
| ğŸ”¸ **Delete** | `PreDeleteEvent` | `PostDeleteEvent` | `åˆ é™¤æ•°æ®å‰å` |

> ğŸ’¡ **Pre vs Post**  
> - **Preäº‹ä»¶**ï¼šæ“ä½œæ‰§è¡Œä¹‹å‰è§¦å‘ï¼Œå¯ä»¥ä¿®æ”¹æ•°æ®
> - **Postäº‹ä»¶**ï¼šæ“ä½œæ‰§è¡Œä¹‹åè§¦å‘ï¼Œç”¨äºé€šçŸ¥å’Œè®°å½•

### 3.3 é…ç½®äº‹ä»¶ç›‘å¬å™¨


**ğŸ“‹ é…ç½®æ–¹å¼**

```java
// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
EventListenerRegistry registry = 
    ((SessionFactoryImpl) sessionFactory)
        .getServiceRegistry()
        .getService(EventListenerRegistry.class);

// æ·»åŠ æ’å…¥äº‹ä»¶ç›‘å¬å™¨
registry.getEventListenerGroup(EventType.POST_INSERT)
        .appendListener(new MyInsertListener());

// æ·»åŠ æ›´æ–°äº‹ä»¶ç›‘å¬å™¨        
registry.getEventListenerGroup(EventType.POST_UPDATE)
        .appendListener(new MyUpdateListener());
```

---

## 4. ğŸ“¥ Loadäº‹ä»¶è¯¦è§£


### 4.1 åŠ è½½äº‹ä»¶çš„ä½œç”¨


**ğŸ¤” ä»€ä¹ˆæ—¶å€™è§¦å‘Loadäº‹ä»¶ï¼Ÿ**

å½“ä½ ä»æ•°æ®åº“è¯»å–æ•°æ®æ—¶ï¼Œå°±ä¼šè§¦å‘åŠ è½½äº‹ä»¶ï¼š

```java
// è¿™äº›æ“ä½œéƒ½ä¼šè§¦å‘Loadäº‹ä»¶
User user = session.get(User.class, 1L);    // âœ“ è§¦å‘
User user2 = session.load(User.class, 2L);  // âœ“ è§¦å‘
List<User> users = session.createQuery("from User").list(); // âœ“ è§¦å‘
```

### 4.2 PreLoadäº‹ä»¶


**ğŸ”¸ PreLoadEvent - æ•°æ®åŠ è½½å‰**

```java
public class MyPreLoadListener implements PreLoadEventListener {
    
    @Override
    public void onPreLoad(PreLoadEvent event) {
        Object entity = event.getEntity();
        
        // åœ¨æ•°æ®å¡«å……åˆ°å¯¹è±¡ä¹‹å‰ï¼Œå¯ä»¥åšä¸€äº›å‡†å¤‡å·¥ä½œ
        System.out.println("å‡†å¤‡åŠ è½½å®ä½“: " + entity.getClass().getName());
        
        // ğŸ“ å¸¸ç”¨åœºæ™¯ï¼šè®°å½•è®¿é—®æ—¥å¿—
        logAccess(entity);
    }
}
```

**ğŸ“‹ åº”ç”¨åœºæ™¯**ï¼š
- è®°å½•æ•°æ®è®¿é—®æ—¥å¿—
- æƒé™é¢„æ£€æŸ¥
- ç¼“å­˜é¢„çƒ­

### 4.3 PostLoadäº‹ä»¶


**ğŸ”¸ PostLoadEvent - æ•°æ®åŠ è½½å**

```java
public class MyPostLoadListener implements PostLoadEventListener {
    
    @Override
    public void onPostLoad(PostLoadEvent event) {
        Object entity = event.getEntity();
        
        // æ•°æ®å·²ç»å¡«å……å®Œæ¯•ï¼Œå¯ä»¥å¯¹æ•°æ®åšåå¤„ç†
        if (entity instanceof User) {
            User user = (User) entity;
            // è§£å¯†æ•æ„Ÿä¿¡æ¯
            user.setPhone(decrypt(user.getPhone()));
        }
    }
}
```

**ğŸ“‹ åº”ç”¨åœºæ™¯**ï¼š
- æ•°æ®è§£å¯†/ååºåˆ—åŒ–
- è®¡ç®—è¡ç”Ÿå­—æ®µ
- è§¦å‘ç¼“å­˜åŠ è½½

---

## 5. ğŸ“ Insertäº‹ä»¶è¯¦è§£


### 5.1 æ’å…¥äº‹ä»¶çš„è§¦å‘æ—¶æœº


**ğŸ“Š æ‰§è¡Œæµç¨‹**

```
session.save(user)
        â†“
   PreInsertEvent è§¦å‘  â† å¯ä»¥ä¿®æ”¹è¦ä¿å­˜çš„æ•°æ®
        â†“
  æ‰§è¡ŒINSERT SQLè¯­å¥
        â†“
   PostInsertEvent è§¦å‘ â† å¯ä»¥åšåç»­å¤„ç†
        â†“
     ä¿å­˜å®Œæˆ
```

### 5.2 PreInsertäº‹ä»¶


**ğŸ”¸ PreInsertEvent - æ’å…¥å‰å¤„ç†**

```java
public class MyPreInsertListener implements PreInsertEventListener {
    
    @Override
    public boolean onPreInsert(PreInsertEvent event) {
        Object entity = event.getEntity();
        Object[] state = event.getState();
        String[] propertyNames = event.getPersister()
                                      .getPropertyNames();
        
        // ğŸ”¹ è‡ªåŠ¨è®¾ç½®é»˜è®¤å€¼
        for (int i = 0; i < propertyNames.length; i++) {
            if ("status".equals(propertyNames[i]) && state[i] == null) {
                state[i] = "ACTIVE"; // é»˜è®¤çŠ¶æ€ä¸ºæ¿€æ´»
            }
        }
        
        return false; // falseè¡¨ç¤ºç»§ç»­æ‰§è¡Œï¼Œtrueè¡¨ç¤ºå–æ¶ˆæ“ä½œ
    }
}
```

**ğŸ“‹ å…¸å‹åº”ç”¨**ï¼š
- âœ… è®¾ç½®é»˜è®¤å€¼
- âœ… æ•°æ®åŠ å¯†
- âœ… æ•°æ®æ ¡éªŒ
- âœ… è‡ªåŠ¨ç”Ÿæˆç¼–å·

### 5.3 PostInsertäº‹ä»¶


**ğŸ”¸ PostInsertEvent - æ’å…¥åå¤„ç†**

```java
public class MyPostInsertListener implements PostInsertEventListener {
    
    @Override
    public void onPostInsert(PostInsertEvent event) {
        Object entity = event.getEntity();
        
        // ğŸ“§ å‘é€é€šçŸ¥
        if (entity instanceof User) {
            User user = (User) entity;
            sendWelcomeEmail(user.getEmail());
        }
        
        // ğŸ”„ æ¸…é™¤ç¼“å­˜
        clearCache(entity.getClass().getName());
    }
}
```

**ğŸ“‹ å…¸å‹åº”ç”¨**ï¼š
- ğŸ“§ å‘é€é€šçŸ¥é‚®ä»¶
- ğŸ”„ æ›´æ–°ç¼“å­˜
- ğŸ“Š è®°å½•æ“ä½œæ—¥å¿—
- ğŸ”” è§¦å‘ä¸šåŠ¡æµç¨‹

---

## 6. âœï¸ Updateäº‹ä»¶è¯¦è§£


### 6.1 æ›´æ–°äº‹ä»¶çš„è§¦å‘æ—¶æœº


**ğŸ“Š æ‰§è¡Œæµç¨‹**

```
session.update(user) æˆ– æ•°æ®è¢«ä¿®æ”¹
        â†“
   PreUpdateEvent è§¦å‘  â† å¯ä»¥ä¿®æ”¹è¦æ›´æ–°çš„æ•°æ®
        â†“
  æ‰§è¡ŒUPDATE SQLè¯­å¥
        â†“
   PostUpdateEvent è§¦å‘ â† å¯ä»¥åšåç»­å¤„ç†
        â†“
     æ›´æ–°å®Œæˆ
```

### 6.2 PreUpdateäº‹ä»¶


**ğŸ”¸ PreUpdateEvent - æ›´æ–°å‰å¤„ç†**

```java
public class MyPreUpdateListener implements PreUpdateEventListener {
    
    @Override
    public boolean onPreUpdate(PreUpdateEvent event) {
        Object entity = event.getEntity();
        Object[] oldState = event.getOldState(); // ä¿®æ”¹å‰çš„å€¼
        Object[] newState = event.getState();    // ä¿®æ”¹åçš„å€¼
        String[] propertyNames = event.getPersister()
                                      .getPropertyNames();
        
        // ğŸ”¹ è‡ªåŠ¨æ›´æ–°ä¿®æ”¹æ—¶é—´
        for (int i = 0; i < propertyNames.length; i++) {
            if ("updateTime".equals(propertyNames[i])) {
                newState[i] = new Date();
            }
            
            // ğŸ“ è®°å½•å˜æ›´å†…å®¹
            if (!Objects.equals(oldState[i], newState[i])) {
                logChange(propertyNames[i], oldState[i], newState[i]);
            }
        }
        
        return false;
    }
}
```

**ğŸ“‹ å…¸å‹åº”ç”¨**ï¼š
- â° è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³
- ğŸ“ è®°å½•å˜æ›´å†å²
- ğŸ” æ•æ„Ÿæ•°æ®åŠ å¯†
- âœ… æ•°æ®æ ¡éªŒ

### 6.3 PostUpdateäº‹ä»¶


**ğŸ”¸ PostUpdateEvent - æ›´æ–°åå¤„ç†**

```java
public class MyPostUpdateListener implements PostUpdateEventListener {
    
    @Override
    public void onPostUpdate(PostUpdateEvent event) {
        Object entity = event.getEntity();
        
        // ğŸ”„ åŒæ­¥ç¼“å­˜
        if (entity instanceof Product) {
            Product product = (Product) entity;
            updateProductCache(product);
        }
        
        // ğŸ“Š æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        updateStatistics(entity);
    }
}
```

**ğŸ“‹ å…¸å‹åº”ç”¨**ï¼š
- ğŸ”„ ç¼“å­˜åŒæ­¥
- ğŸ“Š ç»Ÿè®¡æ•°æ®æ›´æ–°
- ğŸ”” å˜æ›´é€šçŸ¥
- ğŸ” å…¨æ–‡ç´¢å¼•æ›´æ–°

---

## 7. ğŸ—‘ï¸ Deleteäº‹ä»¶è¯¦è§£


### 7.1 åˆ é™¤äº‹ä»¶çš„è§¦å‘æ—¶æœº


**ğŸ“Š æ‰§è¡Œæµç¨‹**

```
session.delete(user)
        â†“
   PreDeleteEvent è§¦å‘  â† å¯ä»¥é˜»æ­¢åˆ é™¤
        â†“
  æ‰§è¡ŒDELETE SQLè¯­å¥
        â†“
   PostDeleteEvent è§¦å‘ â† å¯ä»¥åšæ¸…ç†å·¥ä½œ
        â†“
     åˆ é™¤å®Œæˆ
```

### 7.2 PreDeleteäº‹ä»¶


**ğŸ”¸ PreDeleteEvent - åˆ é™¤å‰å¤„ç†**

```java
public class MyPreDeleteListener implements PreDeleteEventListener {
    
    @Override
    public boolean onPreDelete(PreDeleteEvent event) {
        Object entity = event.getEntity();
        
        // ğŸš« é˜»æ­¢åˆ é™¤é‡è¦æ•°æ®
        if (entity instanceof User) {
            User user = (User) entity;
            if ("admin".equals(user.getRole())) {
                throw new RuntimeException("ç®¡ç†å‘˜è´¦å·ä¸èƒ½åˆ é™¤ï¼");
            }
        }
        
        // ğŸ“ è®°å½•åˆ é™¤æ—¥å¿—
        logDeletion(entity);
        
        return false;
    }
}
```

**ğŸ“‹ å…¸å‹åº”ç”¨**ï¼š
- ğŸš« åˆ é™¤æƒé™æ§åˆ¶
- ğŸ“ åˆ é™¤æ—¥å¿—è®°å½•
- ğŸ—„ï¸ è½¯åˆ é™¤å®ç°
- âœ… å…³è”æ•°æ®æ£€æŸ¥

### 7.3 PostDeleteäº‹ä»¶


**ğŸ”¸ PostDeleteEvent - åˆ é™¤åå¤„ç†**

```java
public class MyPostDeleteListener implements PostDeleteEventListener {
    
    @Override
    public void onPostDelete(PostDeleteEvent event) {
        Object entity = event.getEntity();
        
        // ğŸ—‘ï¸ æ¸…ç†å…³è”æ•°æ®
        if (entity instanceof User) {
            User user = (User) entity;
            // åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰è®¢å•
            deleteUserOrders(user.getId());
            // åˆ é™¤ç”¨æˆ·æ–‡ä»¶
            deleteUserFiles(user.getId());
        }
        
        // ğŸ”„ æ¸…é™¤ç¼“å­˜
        clearCache(entity);
    }
}
```

**ğŸ“‹ å…¸å‹åº”ç”¨**ï¼š
- ğŸ—‘ï¸ å…³è”æ•°æ®æ¸…ç†
- ğŸ”„ ç¼“å­˜æ¸…é™¤
- ğŸ“ æ–‡ä»¶ç³»ç»Ÿæ¸…ç†
- ğŸ“Š ç»Ÿè®¡æ•°æ®æ›´æ–°

---

## 8. ğŸš€ å®é™…åº”ç”¨åœºæ™¯


### 8.1 åœºæ™¯ä¸€ï¼šæ•°æ®å®¡è®¡ç³»ç»Ÿ


**ğŸ’¼ éœ€æ±‚**ï¼šè®°å½•æ‰€æœ‰æ•°æ®çš„å˜æ›´å†å²

```java
// å®¡è®¡ç›‘å¬å™¨ - è®°å½•æ‰€æœ‰å˜æ›´
public class AuditEventListener implements 
    PreInsertEventListener, PreUpdateEventListener, PreDeleteEventListener {
    
    @Override
    public boolean onPreInsert(PreInsertEvent event) {
        AuditLog log = new AuditLog();
        log.setAction("INSERT");
        log.setEntityName(event.getEntity().getClass().getSimpleName());
        log.setOperateTime(new Date());
        log.setOperator(getCurrentUser());
        saveAuditLog(log);
        return false;
    }
    
    @Override
    public boolean onPreUpdate(PreUpdateEvent event) {
        // è®°å½•ä¿®æ”¹äº†å“ªäº›å­—æ®µ
        StringBuilder changes = new StringBuilder();
        for (int i = 0; i < event.getOldState().length; i++) {
            if (!Objects.equals(event.getOldState()[i], event.getState()[i])) {
                changes.append(event.getPersister().getPropertyNames()[i])
                       .append(": ")
                       .append(event.getOldState()[i])
                       .append(" â†’ ")
                       .append(event.getState()[i])
                       .append("; ");
            }
        }
        
        AuditLog log = new AuditLog();
        log.setAction("UPDATE");
        log.setChanges(changes.toString());
        saveAuditLog(log);
        return false;
    }
}
```

### 8.2 åœºæ™¯äºŒï¼šè‡ªåŠ¨å¡«å……ç³»ç»Ÿå­—æ®µ


**ğŸ’¼ éœ€æ±‚**ï¼šè‡ªåŠ¨è®¾ç½®åˆ›å»ºäººã€ä¿®æ”¹äººã€æ—¶é—´æˆ³ç­‰

```java
public class AutoFillInterceptor extends EmptyInterceptor {
    
    @Override
    public boolean onSave(Object entity, Serializable id, 
                          Object[] state, String[] propertyNames, 
                          Type[] types) {
        
        String currentUser = getCurrentUser();
        Date now = new Date();
        
        for (int i = 0; i < propertyNames.length; i++) {
            if ("createBy".equals(propertyNames[i])) {
                state[i] = currentUser;
            }
            if ("createTime".equals(propertyNames[i])) {
                state[i] = now;
            }
        }
        return true;
    }
}
```

### 8.3 åœºæ™¯ä¸‰ï¼šç¼“å­˜åŒæ­¥


**ğŸ’¼ éœ€æ±‚**ï¼šæ•°æ®å˜æ›´æ—¶è‡ªåŠ¨æ›´æ–°Redisç¼“å­˜

```java
public class CacheSyncListener implements 
    PostInsertEventListener, PostUpdateEventListener, PostDeleteEventListener {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    @Override
    public void onPostInsert(PostInsertEvent event) {
        updateCache(event.getEntity());
    }
    
    @Override
    public void onPostUpdate(PostUpdateEvent event) {
        updateCache(event.getEntity());
    }
    
    @Override
    public void onPostDelete(PostDeleteEvent event) {
        deleteCache(event.getEntity());
    }
    
    private void updateCache(Object entity) {
        String key = getCacheKey(entity);
        redisTemplate.opsForValue().set(key, entity);
    }
}
```

### 8.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ“‹ ä½¿ç”¨å»ºè®®å¯¹æ¯”**

| åœºæ™¯ | **æ¨èæ–¹æ¡ˆ** | **åŸå› ** |
|-----|------------|---------|
| ğŸ”¸ **ç®€å•é€šç”¨é€»è¾‘** | `Interceptoræ‹¦æˆªå™¨` | `ä¸€ä¸ªç±»æå®šï¼Œé…ç½®ç®€å•` |
| ğŸ”¸ **ç‰¹å®šäº‹ä»¶å¤„ç†** | `EventListenerç›‘å¬å™¨` | `èŒè´£å•ä¸€ï¼Œæ˜“äºç»´æŠ¤` |
| ğŸ”¸ **éœ€è¦ä¿®æ”¹æ•°æ®** | `Preäº‹ä»¶ç›‘å¬å™¨` | `å¯ä»¥æ”¹å˜å³å°†ä¿å­˜çš„æ•°æ®` |
| ğŸ”¸ **åç»­å¤„ç†** | `Postäº‹ä»¶ç›‘å¬å™¨` | `æ•°æ®å·²ä¿å­˜ï¼Œåšé€šçŸ¥æ¸…ç†` |

> âš ï¸ **æ€§èƒ½æç¤º**  
> ç›‘å¬å™¨ä¼šå½±å“æ€§èƒ½ï¼Œåªåœ¨å¿…è¦æ—¶ä½¿ç”¨ï¼Œé¿å…å¤æ‚é€»è¾‘

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 çŸ¥è¯†ç‚¹å›é¡¾


**ğŸ”¸ æ‹¦æˆªå™¨ vs äº‹ä»¶ç›‘å¬å™¨**

```
Interceptoræ‹¦æˆªå™¨:
âœ… ä¸€ä¸ªç±»å¤„ç†å¤šç§äº‹ä»¶
âœ… é…ç½®ç®€å•ï¼Œå…¨å±€ç”Ÿæ•ˆ
âœ… é€‚åˆé€šç”¨é€»è¾‘å¤„ç†
âŒ çµæ´»æ€§ç›¸å¯¹è¾ƒä½

EventListenerç›‘å¬å™¨:
âœ… ä¸“æ³¨æŸä¸€ç§äº‹ä»¶
âœ… é…ç½®çµæ´»ï¼Œå¯é€‰æ‹©æ€§æ³¨å†Œ
âœ… èŒè´£å•ä¸€ï¼Œæ˜“æ‰©å±•
âŒ éœ€è¦æ³¨å†Œå¤šä¸ªç›‘å¬å™¨
```

**ğŸ”¸ äº‹ä»¶ç±»å‹é€Ÿè®°**

| äº‹ä»¶ | **Preé˜¶æ®µ** | **Posté˜¶æ®µ** |
|-----|-----------|------------|
| ğŸ”¸ **Load** | `æ•°æ®åŠ è½½å‰å‡†å¤‡` | `æ•°æ®åŠ è½½åå¤„ç†` |
| ğŸ”¸ **Insert** | `æ’å…¥å‰æ ¡éªŒ/è®¾ç½®` | `æ’å…¥åé€šçŸ¥/ç¼“å­˜` |
| ğŸ”¸ **Update** | `æ›´æ–°å‰æ ¡éªŒ/è®°å½•` | `æ›´æ–°ååŒæ­¥/é€šçŸ¥` |
| ğŸ”¸ **Delete** | `åˆ é™¤å‰æ£€æŸ¥/æ—¥å¿—` | `åˆ é™¤åæ¸…ç†/ç¼“å­˜` |

### 9.2 å®ç”¨æŠ€å·§æ€»ç»“


**ğŸ’¡ å¼€å‘å»ºè®®**

1ï¸âƒ£ **é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆ**
- ç®€å•åœºæ™¯ç”¨Interceptor
- å¤æ‚åœºæ™¯ç”¨EventListener

2ï¸âƒ£ **æ€§èƒ½ä¼˜åŒ–**
- é¿å…åœ¨ç›‘å¬å™¨ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
- ä¸è¦åœ¨ç›‘å¬å™¨ä¸­è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢
- å¼‚æ­¥å¤„ç†éå…³é”®é€»è¾‘

3ï¸âƒ£ **é”™è¯¯å¤„ç†**
- Preäº‹ä»¶å¯ä»¥æŠ›å¼‚å¸¸é˜»æ­¢æ“ä½œ
- Postäº‹ä»¶å¼‚å¸¸ä¼šå½±å“äº‹åŠ¡
- åšå¥½æ—¥å¿—è®°å½•å’Œç›‘æ§

4ï¸âƒ£ **å¸¸è§åº”ç”¨åœºæ™¯**
- âœ… è‡ªåŠ¨å¡«å……ç³»ç»Ÿå­—æ®µï¼ˆåˆ›å»ºæ—¶é—´ã€ä¿®æ”¹äººç­‰ï¼‰
- âœ… æ•°æ®å®¡è®¡å’Œå˜æ›´å†å²
- âœ… ç¼“å­˜åŒæ­¥å’Œæ¸…ç†
- âœ… æ¶ˆæ¯é€šçŸ¥å’Œäº‹ä»¶å‘å¸ƒ
- âœ… æ•°æ®åŠ å¯†å’Œè„±æ•

### 9.3 å­¦ä¹ æ£€æŸ¥æ¸…å•


**ğŸ“ˆ æŒæ¡ç¨‹åº¦è‡ªæµ‹**

- [ ] èƒ½è¯´å‡ºæ‹¦æˆªå™¨å’Œäº‹ä»¶ç›‘å¬å™¨çš„åŒºåˆ«
- [ ] çŸ¥é“Preå’ŒPostäº‹ä»¶çš„è§¦å‘æ—¶æœº
- [ ] ä¼šç¼–å†™ç®€å•çš„Interceptor
- [ ] ä¼šæ³¨å†Œå’Œä½¿ç”¨EventListener
- [ ] ç†è§£å„ä¸ªäº‹ä»¶çš„åº”ç”¨åœºæ™¯
- [ ] èƒ½åœ¨é¡¹ç›®ä¸­åº”ç”¨è¿™äº›æŠ€æœ¯

### 9.4 ä¸‹ä¸€æ­¥å­¦ä¹ 


**ğŸ”— æ‰©å±•å­¦ä¹ æ–¹å‘**

- **æ·±å…¥å­¦ä¹ **: Hibernateäº‹ä»¶ç³»ç»Ÿæºç åˆ†æ
- **å®æˆ˜é¡¹ç›®**: æ„å»ºå®Œæ•´çš„å®¡è®¡æ—¥å¿—ç³»ç»Ÿ
- **æ€§èƒ½ä¼˜åŒ–**: ç›‘å¬å™¨æ€§èƒ½è°ƒä¼˜æŠ€å·§
- **Springé›†æˆ**: ä¸Springäº‹ä»¶æœºåˆ¶çš„ç»“åˆä½¿ç”¨

---

**ğŸ§  è®°å¿†å£è¯€**ï¼š
```
æ‹¦æˆªå™¨å…¨èƒ½ç®¡å®¶ï¼Œäº‹ä»¶ç›‘å¬ä¸“èŒåŠ©æ‰‹
Preäº‹ä»¶ä¿®æ”¹æ•°æ®ï¼ŒPostäº‹ä»¶åç»­å¤„ç†
åŠ è½½æ’å…¥æ›´æ–°åˆ é™¤ï¼Œå‰åç›‘å¬å„å¸å…¶èŒ
å®¡è®¡ç¼“å­˜é€šçŸ¥æ—¥å¿—ï¼Œå®é™…åº”ç”¨åœºæ™¯ä¸°å¯Œ
```