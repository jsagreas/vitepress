---
title: 77ã€å¼€å‘æœ€ä½³å®è·µ
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯æœ€ä½³å®è·µ](#1-ä»€ä¹ˆæ˜¯æœ€ä½³å®è·µ)
2. [å®ä½“è®¾è®¡åŸåˆ™](#2-å®ä½“è®¾è®¡åŸåˆ™)
3. [æ˜ å°„é…ç½®è§„èŒƒ](#3-æ˜ å°„é…ç½®è§„èŒƒ)
4. [Sessionç®¡ç†è§„èŒƒ](#4-sessionç®¡ç†è§„èŒƒ)
5. [äº‹åŠ¡ç®¡ç†è§„èŒƒ](#5-äº‹åŠ¡ç®¡ç†è§„èŒƒ)
6. [æŸ¥è¯¢ä¼˜åŒ–è§„èŒƒ](#6-æŸ¥è¯¢ä¼˜åŒ–è§„èŒƒ)
7. [ç¼“å­˜ä½¿ç”¨è§„èŒƒ](#7-ç¼“å­˜ä½¿ç”¨è§„èŒƒ)
8. [æ€§èƒ½ä¼˜åŒ–è§„èŒƒ](#8-æ€§èƒ½ä¼˜åŒ–è§„èŒƒ)
9. [å¼‚å¸¸å¤„ç†è§„èŒƒ](#9-å¼‚å¸¸å¤„ç†è§„èŒƒ)
10. [æ—¥å¿—è®°å½•è§„èŒƒ](#10-æ—¥å¿—è®°å½•è§„èŒƒ)
11. [å›¢é˜Ÿåä½œè§„èŒƒ](#11-å›¢é˜Ÿåä½œè§„èŒƒ)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯æœ€ä½³å®è·µ


### 1.1 æœ€ä½³å®è·µçš„å«ä¹‰


**ç®€å•ç†è§£**ï¼šæœ€ä½³å®è·µå°±æ˜¯"å‰äººè¸©è¿‡å‘åæ€»ç»“å‡ºçš„å¥½æ–¹æ³•"ã€‚

```
å°±åƒåšé¥­ï¼š
âŒ æ–°æ‰‹ï¼šéšä¾¿ç‚’ï¼Œå¯èƒ½ç³Šé”…ã€å¤ªå’¸ã€ä¸ç†Ÿ
âœ… è€æ‰‹ï¼šæŒæ¡ç«å€™ã€è°ƒæ–™æ¯”ä¾‹ã€ä¸‹é”…é¡ºåº

ç¼–ç¨‹ä¹Ÿä¸€æ ·ï¼š
âŒ éšä¾¿å†™ï¼šèƒ½è·‘ä½†æ…¢ã€å®¹æ˜“å‡ºé”™ã€éš¾ç»´æŠ¤
âœ… æœ€ä½³å®è·µï¼šæ€§èƒ½å¥½ã€ä¸æ˜“å‡ºé”™ã€æ˜“ç»´æŠ¤
```

**ä¸ºä»€ä¹ˆéœ€è¦æœ€ä½³å®è·µ**ï¼š
- ğŸ”¸ **é¿å…å¸¸è§é”™è¯¯**ï¼šåˆ«äººè¸©è¿‡çš„å‘ï¼Œä½ ä¸ç”¨å†è¸©
- ğŸ”¸ **æå‡ä»£ç è´¨é‡**ï¼šå†™å‡ºæ¥çš„ä»£ç æ›´ä¸“ä¸š
- ğŸ”¸ **æé«˜å¼€å‘æ•ˆç‡**ï¼šçŸ¥é“æ€ä¹ˆåšæœ€å¿«æœ€å¥½
- ğŸ”¸ **æ–¹ä¾¿å›¢é˜Ÿåä½œ**ï¼šå¤§å®¶éƒ½æŒ‰åŒæ ·çš„è§„èŒƒæ¥

### 1.2 æœ¬ç« è¦†ç›–çš„å†…å®¹


```
è®¾è®¡å±‚é¢ï¼šå®ä½“æ€ä¹ˆè®¾è®¡ã€æ˜ å°„æ€ä¹ˆé…ç½®
ä½¿ç”¨å±‚é¢ï¼šSessionæ€ä¹ˆç”¨ã€äº‹åŠ¡æ€ä¹ˆç®¡ç†
ä¼˜åŒ–å±‚é¢ï¼šæŸ¥è¯¢æ€ä¹ˆä¼˜åŒ–ã€ç¼“å­˜æ€ä¹ˆç”¨
è´¨é‡å±‚é¢ï¼šå¼‚å¸¸æ€ä¹ˆå¤„ç†ã€æ—¥å¿—æ€ä¹ˆè®°å½•
å›¢é˜Ÿå±‚é¢ï¼šä»£ç æ€ä¹ˆå®¡æŸ¥ã€æ–‡æ¡£æ€ä¹ˆå†™
```

---

## 2. ğŸ“¦ å®ä½“è®¾è®¡åŸåˆ™


### 2.1 å®ä½“ç±»çš„åŸºæœ¬è¦æ±‚


**ä»€ä¹ˆæ˜¯å¥½çš„å®ä½“ç±»**ï¼š

```java
// âœ… å¥½çš„å®ä½“ç±»ç¤ºä¾‹
@Entity
@Table(name = "user")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String username;
    private String email;
    
    // æ— å‚æ„é€ å™¨ï¼ˆHibernateå¿…éœ€ï¼‰
    public User() {}
    
    // getter/setter
    // equals/hashCode
}
```

**æ ¸å¿ƒè¦æ±‚**ï¼š

| è¦æ±‚ | è¯´æ˜ | ä¸ºä»€ä¹ˆè¿™æ ·åš |
|------|------|------------|
| ğŸ“Œ **æ— å‚æ„é€ å™¨** | å¿…é¡»æœ‰ä¸€ä¸ªpublicæˆ–protectedçš„æ— å‚æ„é€  | Hibernateéœ€è¦ç”¨åå°„åˆ›å»ºå¯¹è±¡ |
| ğŸ“Œ **å®ç°Serializable** | æ¨èå®ç°åºåˆ—åŒ–æ¥å£ | æ”¯æŒç¼“å­˜å’Œåˆ†å¸ƒå¼åœºæ™¯ |
| ğŸ“Œ **é‡å†™equals/hashCode** | åŸºäºä¸šåŠ¡ä¸»é”®è€Œéid | ç¡®ä¿é›†åˆæ“ä½œæ­£ç¡® |
| ğŸ“Œ **ä½¿ç”¨åŒ…è£…ç±»å‹** | ç”¨Integerè€Œéint | nullå¯ä»¥è¡¨ç¤ºæœªèµ‹å€¼çŠ¶æ€ |

### 2.2 å®ä½“ç±»è®¾è®¡åŸåˆ™è¯¦è§£


**åŸåˆ™1ï¼šä¿æŒç®€å•çº¯ç²¹**

```java
// âŒ ä¸å¥½çš„è®¾è®¡ï¼šå®ä½“ç±»åŒ…å«ä¸šåŠ¡é€»è¾‘
@Entity
public class Order {
    private Long id;
    private BigDecimal totalAmount;
    
    // âŒ ä¸è¦åœ¨å®ä½“ç±»é‡Œå†™ä¸šåŠ¡é€»è¾‘
    public void calculateDiscount() {
        // å¤æ‚çš„æŠ˜æ‰£è®¡ç®—é€»è¾‘...
    }
}

// âœ… å¥½çš„è®¾è®¡ï¼šå®ä½“ç±»åªè´Ÿè´£æ•°æ®
@Entity
public class Order {
    private Long id;
    private BigDecimal totalAmount;
    
    // åªæœ‰ç®€å•çš„getter/setter
}

// ä¸šåŠ¡é€»è¾‘æ”¾åœ¨Serviceå±‚
public class OrderService {
    public void applyDiscount(Order order) {
        // æŠ˜æ‰£è®¡ç®—é€»è¾‘
    }
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·åš**ï¼š
- å®ä½“ç±»åªæ˜¯"æ•°æ®å®¹å™¨"ï¼Œä¸åº”è¯¥åŒ…å«å¤æ‚ä¸šåŠ¡é€»è¾‘
- ä¸šåŠ¡é€»è¾‘å˜åŒ–é¢‘ç¹ï¼Œå®ä½“ç»“æ„åº”è¯¥ç¨³å®š
- ä¾¿äºæµ‹è¯•å’Œç»´æŠ¤

**åŸåˆ™2ï¼šåˆç†ä½¿ç”¨æ‡’åŠ è½½**

```java
// å…³è”å…³ç³»çš„åŠ è½½ç­–ç•¥é€‰æ‹©
@Entity
public class Order {
    // âœ… ä¸€å¯¹å¤šå…³ç³»é»˜è®¤ç”¨æ‡’åŠ è½½
    @OneToMany(fetch = FetchType.LAZY)
    private List<OrderItem> items;
    
    // âœ… å¤šå¯¹ä¸€å…³ç³»æ ¹æ®ä½¿ç”¨é¢‘ç‡å†³å®š
    @ManyToOne(fetch = FetchType.EAGER)  // å‡ ä¹æ€»æ˜¯éœ€è¦çš„
    private User user;
    
    @ManyToOne(fetch = FetchType.LAZY)   // ä¸å¸¸ç”¨çš„
    private Address shippingAddress;
}
```

**é€‰æ‹©ç­–ç•¥**ï¼š

```
ä½¿ç”¨é¢‘ç‡é«˜çš„å…³è” â†’ EAGERï¼ˆç«‹å³åŠ è½½ï¼‰
ä½¿ç”¨é¢‘ç‡ä½çš„å…³è” â†’ LAZYï¼ˆæ‡’åŠ è½½ï¼‰
é›†åˆç±»å‹çš„å…³è” â†’ LAZYï¼ˆé¿å…åŠ è½½å¤§é‡æ•°æ®ï¼‰
```

**åŸåˆ™3ï¼šequalså’ŒhashCodeçš„æ­£ç¡®å®ç°**

```java
@Entity
public class User {
    @Id
    @GeneratedValue
    private Long id;
    
    @Column(unique = true)
    private String username;  // ä¸šåŠ¡ä¸»é”®
    
    // âœ… åŸºäºä¸šåŠ¡ä¸»é”®å®ç°
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        User user = (User) o;
        return username.equals(user.username);
    }
    
    @Override
    public int hashCode() {
        return username.hashCode();
    }
}
```

**å¸¸è§é”™è¯¯**ï¼š

```java
// âŒ é”™è¯¯1ï¼šåŸºäºidå®ç°
@Override
public boolean equals(Object o) {
    User user = (User) o;
    return id.equals(user.id);  // æ–°å»ºå¯¹è±¡idä¸ºnullä¼šå‡ºé”™ï¼
}

// âŒ é”™è¯¯2ï¼šåŒ…å«æ‰€æœ‰å­—æ®µ
@Override
public boolean equals(Object o) {
    // åŒ…å«äº†æ‰€æœ‰å­—æ®µï¼Œä¿®æ”¹ä»»ä½•å­—æ®µéƒ½ä¼šå½±å“equalsç»“æœ
    return Objects.equals(id, user.id) &&
           Objects.equals(name, user.name) &&
           Objects.equals(email, user.email);
}
```

---

## 3. ğŸ—ºï¸ æ˜ å°„é…ç½®è§„èŒƒ


### 3.1 æ³¨è§£è¿˜æ˜¯XMLï¼Ÿ


**ç°ä»£æ¨èæ–¹å¼**ï¼š

```
æ³¨è§£æ–¹å¼ï¼ˆæ¨èï¼‰ âœ…
- é…ç½®å’Œä»£ç åœ¨ä¸€èµ·ï¼Œç›´è§‚
- IDEæ”¯æŒå¥½ï¼Œå¼€å‘æ•ˆç‡é«˜
- é€‚åˆç»å¤§å¤šæ•°åœºæ™¯

XMLæ–¹å¼ï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰ âš ï¸
- éœ€è¦åŠ¨æ€ä¿®æ”¹æ˜ å°„æ—¶
- é—ç•™ç³»ç»Ÿç»´æŠ¤
```

### 3.2 å‘½åè§„èŒƒ


**è¡¨åå’Œå­—æ®µåè§„èŒƒ**ï¼š

```java
// âœ… æ˜ç¡®æŒ‡å®šè¡¨åå’Œå­—æ®µå
@Entity
@Table(name = "sys_user")  // è¡¨åå¸¦ä¸šåŠ¡å‰ç¼€
public class User {
    
    @Column(name = "user_name", length = 50, nullable = false)
    private String username;
    
    @Column(name = "email_address", length = 100)
    private String email;
}
```

**ä¸ºä»€ä¹ˆè¦æ˜ç¡®æŒ‡å®š**ï¼š
- ğŸ”¸ ä¸ä¾èµ–é»˜è®¤å‘½åç­–ç•¥ï¼ˆä¸åŒæ•°æ®åº“å¯èƒ½ä¸åŒï¼‰
- ğŸ”¸ ä»£ç é‡æ„ä¸å½±å“æ•°æ®åº“ç»“æ„
- ğŸ”¸ å›¢é˜Ÿæˆå‘˜ç†è§£ä¸€è‡´

### 3.3 å…³è”æ˜ å°„çš„æœ€ä½³é…ç½®


**å•å‘è¿˜æ˜¯åŒå‘**ï¼š

```java
// âœ… æ¨èï¼šæ ¹æ®ä¸šåŠ¡éœ€è¦é€‰æ‹©
// åœºæ™¯1ï¼šåªéœ€è¦ä»è®¢å•æŸ¥è¯¢ç”¨æˆ·
@Entity
public class Order {
    @ManyToOne
    private User user;  // å•å‘å…³è”ï¼Œç®€å•å¤Ÿç”¨
}

// åœºæ™¯2ï¼šéœ€è¦ä»ç”¨æˆ·æŸ¥è¯¢æ‰€æœ‰è®¢å•
@Entity
public class User {
    @OneToMany(mappedBy = "user")
    private List<Order> orders;  // åŒå‘å…³è”
}

@Entity  
public class Order {
    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;
}
```

**é…ç½®è¦ç‚¹**ï¼š

| é…ç½®é¡¹ | è¯´æ˜ | æ¨èå€¼ |
|--------|------|--------|
| `cascade` | çº§è”æ“ä½œ | è°¨æ…ä½¿ç”¨ï¼Œåªåœ¨åˆç†çš„åœºæ™¯ |
| `orphanRemoval` | å­¤å„¿åˆ é™¤ | ä¸€å¯¹å¤šåœºæ™¯ä¸‹å¯ç”¨ |
| `fetch` | åŠ è½½ç­–ç•¥ | é›†åˆç”¨LAZYï¼Œå…¶ä»–çœ‹æƒ…å†µ |
| `mappedBy` | å…³ç³»ç»´æŠ¤æ–¹ | åŒå‘å…³è”å¿…é¡»æŒ‡å®š |

**çº§è”æ“ä½œçš„ä½¿ç”¨**ï¼š

```java
// âœ… åˆç†çš„çº§è”
@Entity
public class Order {
    // è®¢å•åˆ é™¤æ—¶ï¼Œè®¢å•é¡¹ä¹Ÿåº”è¯¥åˆ é™¤
    @OneToMany(cascade = CascadeType.ALL, orphanRemoval = true)
    private List<OrderItem> items;
}

// âŒ å±é™©çš„çº§è”
@Entity
public class Order {
    // åˆ é™¤è®¢å•ä¸åº”è¯¥åˆ é™¤ç”¨æˆ·ï¼
    @ManyToOne(cascade = CascadeType.REMOVE)  // å±é™©ï¼
    private User user;
}
```

---

## 4. ğŸ”Œ Sessionç®¡ç†è§„èŒƒ


### 4.1 Sessionæ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼šSessionå°±åƒæ˜¯"æ•°æ®åº“æ“ä½œçš„å·¥ä½œå°"ã€‚

```
ç±»æ¯”ç†è§£ï¼š
Session = å·¥ä½œå°
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å¢åˆ æ”¹æŸ¥å·¥å…·    â”‚ â† save/delete/update/get
    â”‚  ä¸´æ—¶å­˜å‚¨åŒº      â”‚ â† ä¸€çº§ç¼“å­˜
    â”‚  æ“ä½œè®°å½•æœ¬      â”‚ â† è„æ£€æŸ¥æœºåˆ¶
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
ç”¨å®Œè¦æ”¶æ‹¾ â†’ session.close()
```

### 4.2 Sessionçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†


**æ ¸å¿ƒåŸåˆ™ï¼šä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªSession**

```java
// âœ… Webç¯å¢ƒæ¨èæ¨¡å¼ï¼ˆSpringæ•´åˆï¼‰
@Service
@Transactional
public class UserService {
    
    @Autowired
    private SessionFactory sessionFactory;
    
    public User findUser(Long id) {
        // Springè‡ªåŠ¨ç®¡ç†Sessionçš„å¼€å¯å’Œå…³é—­
        Session session = sessionFactory.getCurrentSession();
        return session.get(User.class, id);
    }
}
```

**æ‰‹åŠ¨ç®¡ç†Sessionçš„æ­£ç¡®å§¿åŠ¿**ï¼š

```java
// âœ… æ ‡å‡†çš„Sessionä½¿ç”¨æ¨¡å¼
public void doSomething() {
    Session session = null;
    Transaction tx = null;
    
    try {
        session = sessionFactory.openSession();
        tx = session.beginTransaction();
        
        // æ‰§è¡Œæ•°æ®åº“æ“ä½œ
        User user = new User();
        session.save(user);
        
        tx.commit();
    } catch (Exception e) {
        if (tx != null) tx.rollback();
        throw e;
    } finally {
        if (session != null) session.close();
    }
}
```

### 4.3 å¸¸è§çš„Sessionä½¿ç”¨é”™è¯¯


**é”™è¯¯1ï¼šSessionä¸å…³é—­**

```java
// âŒ å†…å­˜æ³„æ¼çš„å†™æ³•
public User getUser(Long id) {
    Session session = sessionFactory.openSession();
    return session.get(User.class, id);
    // å¿˜è®°å…³é—­Sessionï¼
}

// âœ… æ­£ç¡®å†™æ³•
public User getUser(Long id) {
    try (Session session = sessionFactory.openSession()) {
        return session.get(User.class, id);
    }  // try-with-resourcesè‡ªåŠ¨å…³é—­
}
```

**é”™è¯¯2ï¼šè·¨çº¿ç¨‹ä½¿ç”¨Session**

```java
// âŒ å±é™©çš„å†™æ³•
private Session session;  // æˆå‘˜å˜é‡

public void method1() {
    session = sessionFactory.openSession();
    // ...
}

public void method2() {
    session.save(user);  // å¯èƒ½åœ¨ä¸åŒçº¿ç¨‹ï¼
}

// âœ… æ­£ç¡®å†™æ³•ï¼šSessionæ˜¯çº¿ç¨‹ç‹¬ç«‹çš„
public void method1() {
    Session session = sessionFactory.getCurrentSession();
    // æ¯ä¸ªæ–¹æ³•è‡ªå·±è·å–Session
}
```

**é”™è¯¯3ï¼šSessionå…³é—­åè®¿é—®æ‡’åŠ è½½æ•°æ®**

```java
// âŒ ç»å…¸çš„LazyInitializationException
public User getUserWithOrders(Long id) {
    Session session = sessionFactory.openSession();
    User user = session.get(User.class, id);
    session.close();
    
    user.getOrders().size();  // å¼‚å¸¸ï¼Sessionå·²å…³é—­
    return user;
}

// âœ… è§£å†³æ–¹æ¡ˆ1ï¼šåœ¨Sessionå†…è®¿é—®
public User getUserWithOrders(Long id) {
    try (Session session = sessionFactory.openSession()) {
        User user = session.get(User.class, id);
        user.getOrders().size();  // è§¦å‘åŠ è½½
        return user;
    }
}

// âœ… è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨JOIN FETCH
public User getUserWithOrders(Long id) {
    try (Session session = sessionFactory.openSession()) {
        return session.createQuery(
            "FROM User u JOIN FETCH u.orders WHERE u.id = :id",
            User.class
        ).setParameter("id", id).uniqueResult();
    }
}
```

---

## 5. ğŸ’¼ äº‹åŠ¡ç®¡ç†è§„èŒƒ


### 5.1 äº‹åŠ¡æ˜¯ä»€ä¹ˆ


**ç”Ÿæ´»åŒ–ç†è§£**ï¼šäº‹åŠ¡å°±æ˜¯"è¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆå…¨ä¸åš"ã€‚

```
è½¬è´¦ä¾‹å­ï¼š
æ“ä½œ1ï¼šAè´¦æˆ·å‡100å…ƒ
æ“ä½œ2ï¼šBè´¦æˆ·åŠ 100å…ƒ

äº‹åŠ¡ä¿è¯ï¼š
âœ… ä¸¤ä¸ªæ“ä½œéƒ½æˆåŠŸ â†’ æäº¤
âŒ ä»»ä½•ä¸€ä¸ªå¤±è´¥ â†’ å…¨éƒ¨å›æ»š
```

### 5.2 äº‹åŠ¡ç®¡ç†çš„åŸºæœ¬åŸåˆ™


**åŸåˆ™1ï¼šäº‹åŠ¡è¾¹ç•Œè¦æ¸…æ™°**

```java
// âœ… æ¨èï¼šServiceå±‚ç®¡ç†äº‹åŠ¡
@Service
public class OrderService {
    
    @Transactional  // æ–¹æ³•çº§åˆ«çš„äº‹åŠ¡
    public void createOrder(Order order) {
        // 1. ä¿å­˜è®¢å•
        orderDao.save(order);
        
        // 2. æ‰£å‡åº“å­˜
        inventoryService.deduct(order);
        
        // 3. åˆ›å»ºæ”¯ä»˜è®°å½•
        paymentService.create(order);
        
        // ä»»ä½•ä¸€æ­¥å¤±è´¥éƒ½ä¼šå›æ»š
    }
}
```

**åŸåˆ™2ï¼šé¿å…äº‹åŠ¡åµŒå¥—**

```java
// âŒ äº‹åŠ¡åµŒå¥—å¯èƒ½å¯¼è‡´é—®é¢˜
@Transactional
public void outerMethod() {
    // å¤–å±‚äº‹åŠ¡
    innerMethod();  // å†…å±‚ä¹Ÿæœ‰äº‹åŠ¡ï¼Ÿ
}

@Transactional
public void innerMethod() {
    // å†…å±‚äº‹åŠ¡
}

// âœ… æ˜ç¡®äº‹åŠ¡ä¼ æ’­è¡Œä¸º
@Transactional
public void outerMethod() {
    innerMethod();
}

@Transactional(propagation = Propagation.REQUIRED)  // åŠ å…¥å¤–å±‚äº‹åŠ¡
public void innerMethod() {
    // ä½¿ç”¨å¤–å±‚äº‹åŠ¡
}
```

### 5.3 äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºé€‰æ‹©


**å¸¸ç”¨ä¼ æ’­è¡Œä¸º**ï¼š

| ä¼ æ’­è¡Œä¸º | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|---------|------|---------|
| `REQUIRED` â­â­â­ | æœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±æ–°å»º | **é»˜è®¤é€‰æ‹©ï¼Œ99%çš„åœºæ™¯** |
| `REQUIRES_NEW` âš ï¸ | æ€»æ˜¯æ–°å»ºç‹¬ç«‹äº‹åŠ¡ | æ—¥å¿—è®°å½•ã€å®¡è®¡æ“ä½œ |
| `SUPPORTS` | æœ‰äº‹åŠ¡å°±ç”¨ï¼Œæ²¡æœ‰å°±ç®—äº† | æŸ¥è¯¢æ“ä½œ |
| `NOT_SUPPORTED` | ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œ | ä¸éœ€è¦äº‹åŠ¡çš„æ“ä½œ |

**å®é™…åº”ç”¨**ï¼š

```java
// åœºæ™¯ï¼šå³ä½¿è®¢å•åˆ›å»ºå¤±è´¥ï¼Œä¹Ÿè¦è®°å½•æ“ä½œæ—¥å¿—
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(Order order) {
        try {
            orderDao.save(order);
            // ... å…¶ä»–æ“ä½œ
        } finally {
            // æ—¥å¿—è®°å½•ç”¨ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸å—è®¢å•äº‹åŠ¡å½±å“
            auditService.log("CREATE_ORDER", order.getId());
        }
    }
}

@Service
public class AuditService {
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void log(String action, Long orderId) {
        // ç‹¬ç«‹äº‹åŠ¡ï¼Œå³ä½¿å¤–å±‚å›æ»šï¼Œæ—¥å¿—ä¹Ÿä¼šä¿å­˜
        AuditLog log = new AuditLog(action, orderId);
        auditDao.save(log);
    }
}
```

### 5.4 äº‹åŠ¡è¶…æ—¶å’Œåªè¯»ä¼˜åŒ–


```java
// é•¿æ—¶é—´æ“ä½œè®¾ç½®è¶…æ—¶
@Transactional(timeout = 30)  // 30ç§’è¶…æ—¶
public void batchProcess(List<Order> orders) {
    // æ‰¹é‡å¤„ç†
}

// åªè¯»äº‹åŠ¡ä¼˜åŒ–
@Transactional(readOnly = true)
public List<User> findActiveUsers() {
    // åªè¯»æ“ä½œï¼Œæ•°æ®åº“å¯ä»¥ä¼˜åŒ–
    return userDao.findByStatus("ACTIVE");
}
```

---

## 6. ğŸš€ æŸ¥è¯¢ä¼˜åŒ–è§„èŒƒ


### 6.1 N+1æŸ¥è¯¢é—®é¢˜


**ä»€ä¹ˆæ˜¯N+1æŸ¥è¯¢**ï¼š

```
æŸ¥è¯¢è®¢å•åˆ—è¡¨ï¼ˆ1æ¬¡æŸ¥è¯¢ï¼‰
    â†“
æ¯ä¸ªè®¢å•æŸ¥è¯¢ç”¨æˆ·ï¼ˆNæ¬¡æŸ¥è¯¢ï¼‰
    â†“
æ€»å…±æ‰§è¡Œäº† 1+N æ¬¡SQL â†’ æ€§èƒ½æ€æ‰‹ï¼
```

**é—®é¢˜ç¤ºä¾‹**ï¼š

```java
// âŒ äº§ç”ŸN+1æŸ¥è¯¢
List<Order> orders = session.createQuery("FROM Order", Order.class)
    .getResultList();

for (Order order : orders) {
    // æ¯æ¬¡å¾ªç¯éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡SQLæŸ¥è¯¢ç”¨æˆ·
    System.out.println(order.getUser().getName());
}

// ç»“æœï¼š
// SELECT * FROM order;           -- 1æ¬¡
// SELECT * FROM user WHERE id=1; -- Næ¬¡
// SELECT * FROM user WHERE id=2;
// ...
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// âœ… ä½¿ç”¨JOIN FETCHä¸€æ¬¡æ€§åŠ è½½
List<Order> orders = session.createQuery(
    "FROM Order o JOIN FETCH o.user", 
    Order.class
).getResultList();

// ç»“æœï¼šåªæ‰§è¡Œ1æ¬¡SQL
// SELECT o.*, u.* FROM order o JOIN user u ON o.user_id = u.id;
```

### 6.2 æŸ¥è¯¢æ–¹å¼çš„é€‰æ‹©


**HQL vs Criteria vs SQL**ï¼š

```
HQLï¼ˆæ¨èï¼‰ â­â­â­
- é¢å‘å¯¹è±¡çš„æŸ¥è¯¢è¯­è¨€
- ç±»å‹å®‰å…¨ã€æ˜“ç»´æŠ¤
- é€‚åˆ90%çš„åœºæ™¯

Criteriaï¼ˆæ¡ä»¶æŸ¥è¯¢ï¼‰â­â­
- åŠ¨æ€æŸ¥è¯¢æ¡ä»¶
- å®Œå…¨ç±»å‹å®‰å…¨
- ä»£ç ç¨æ˜¾å†—é•¿

åŸç”ŸSQL âš ï¸
- å¤æ‚ç»Ÿè®¡æŸ¥è¯¢
- æ•°æ®åº“ç‰¹å®šåŠŸèƒ½
- éœ€è¦æ‰‹åŠ¨æ˜ å°„ç»“æœ
```

**ç¤ºä¾‹å¯¹æ¯”**ï¼š

```java
// HQLæ–¹å¼ï¼ˆæ¨èï¼‰
List<User> users = session.createQuery(
    "FROM User u WHERE u.status = :status AND u.age > :age",
    User.class
)
.setParameter("status", "ACTIVE")
.setParameter("age", 18)
.getResultList();

// Criteriaæ–¹å¼ï¼ˆåŠ¨æ€æ¡ä»¶ï¼‰
CriteriaBuilder cb = session.getCriteriaBuilder();
CriteriaQuery<User> cq = cb.createQuery(User.class);
Root<User> root = cq.from(User.class);

List<Predicate> predicates = new ArrayList<>();
if (status != null) {
    predicates.add(cb.equal(root.get("status"), status));
}
if (minAge != null) {
    predicates.add(cb.gt(root.get("age"), minAge));
}

cq.where(predicates.toArray(new Predicate[0]));
List<User> users = session.createQuery(cq).getResultList();
```

### 6.3 åˆ†é¡µæŸ¥è¯¢è§„èŒƒ


```java
// âœ… æ ‡å‡†çš„åˆ†é¡µæŸ¥è¯¢
public Page<User> findUsers(int pageNum, int pageSize) {
    Session session = sessionFactory.getCurrentSession();
    
    // æŸ¥è¯¢æ€»æ•°
    Long total = session.createQuery(
        "SELECT COUNT(u) FROM User u",
        Long.class
    ).uniqueResult();
    
    // æŸ¥è¯¢åˆ†é¡µæ•°æ®
    List<User> users = session.createQuery(
        "FROM User u ORDER BY u.createTime DESC",
        User.class
    )
    .setFirstResult((pageNum - 1) * pageSize)
    .setMaxResults(pageSize)
    .getResultList();
    
    return new Page<>(users, total, pageNum, pageSize);
}
```

**åˆ†é¡µæ€§èƒ½ä¼˜åŒ–**ï¼š

```java
// âŒ å¤§æ•°æ®é‡æ—¶æ·±åº¦åˆ†é¡µå¾ˆæ…¢
SELECT * FROM user LIMIT 1000000, 20;  -- æ‰«æ100ä¸‡è¡Œ

// âœ… ä½¿ç”¨ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€å¤§ID
SELECT * FROM user WHERE id > 1000000 LIMIT 20;  -- ç›´æ¥å®šä½
```

---

## 7. ğŸ’¾ ç¼“å­˜ä½¿ç”¨è§„èŒƒ


### 7.1 ç¼“å­˜çš„å±‚æ¬¡


**Hibernateçš„ä¸¤çº§ç¼“å­˜**ï¼š

```
ä¸€çº§ç¼“å­˜ï¼ˆSessionçº§åˆ«ï¼‰
    â†“ ç”Ÿå‘½å‘¨æœŸçŸ­ï¼Œè‡ªåŠ¨ç®¡ç†
    æ¯ä¸ªSessionç‹¬ç«‹çš„ç¼“å­˜
    
äºŒçº§ç¼“å­˜ï¼ˆSessionFactoryçº§åˆ«ï¼‰  
    â†“ ç”Ÿå‘½å‘¨æœŸé•¿ï¼Œéœ€è¦é…ç½®
    æ‰€æœ‰Sessionå…±äº«çš„ç¼“å­˜
```

**å½¢è±¡ç†è§£**ï¼š

```
ä¸€çº§ç¼“å­˜ = ä½ çš„è´­ç‰©è½¦ï¼ˆä¸ªäººç”¨ï¼‰
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å•†å“A Ã— 2  â”‚
    â”‚  å•†å“B Ã— 1  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ç»“è´¦åæ¸…ç©º

äºŒçº§ç¼“å­˜ = è¶…å¸‚ä»“åº“ï¼ˆå¤§å®¶å…±ç”¨ï¼‰
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  çƒ­é—¨å•†å“   â”‚ â† é¢‘ç¹è®¿é—®çš„æ•°æ®
    â”‚  åº“å­˜ä¿¡æ¯   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    é•¿æœŸå­˜åœ¨
```

### 7.2 ä¸€çº§ç¼“å­˜çš„ä½¿ç”¨


**ä¸€çº§ç¼“å­˜è‡ªåŠ¨å·¥ä½œ**ï¼š

```java
Session session = sessionFactory.openSession();

// ç¬¬1æ¬¡æŸ¥è¯¢ï¼šä»æ•°æ®åº“åŠ è½½ï¼Œæ”¾å…¥ç¼“å­˜
User user1 = session.get(User.class, 1L);

// ç¬¬2æ¬¡æŸ¥è¯¢ï¼šç›´æ¥ä»ç¼“å­˜è·å–ï¼Œä¸æŸ¥æ•°æ®åº“
User user2 = session.get(User.class, 1L);

System.out.println(user1 == user2);  // trueï¼ŒåŒä¸€ä¸ªå¯¹è±¡
```

**æ¸…ç†ä¸€çº§ç¼“å­˜**ï¼š

```java
// åœºæ™¯ï¼šæ‰¹é‡æ“ä½œæ—¶é¿å…å†…å­˜æº¢å‡º
for (int i = 0; i < 10000; i++) {
    User user = new User();
    session.save(user);
    
    if (i % 100 == 0) {
        session.flush();   // åŒæ­¥åˆ°æ•°æ®åº“
        session.clear();   // æ¸…ç†ç¼“å­˜
    }
}
```

### 7.3 äºŒçº§ç¼“å­˜çš„é…ç½®


**å¯ç”¨äºŒçº§ç¼“å­˜**ï¼š

```java
// 1. é…ç½®æ–‡ä»¶å¯ç”¨
hibernate.cache.use_second_level_cache=true
hibernate.cache.region.factory_class=org.hibernate.cache.ehcache.EhCacheRegionFactory

// 2. å®ä½“ç±»æ ‡è®°å¯ç¼“å­˜
@Entity
@Cacheable
@Cache(usage = CacheConcurrencyStrategy.READ_WRITE)
public class Product {
    // å•†å“ä¿¡æ¯å˜åŒ–ä¸é¢‘ç¹ï¼Œé€‚åˆç¼“å­˜
}
```

**ç¼“å­˜ç­–ç•¥é€‰æ‹©**ï¼š

| ç­–ç•¥ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| `READ_ONLY` | åªè¯» | é…ç½®æ•°æ®ã€å­—å…¸è¡¨ |
| `READ_WRITE` â­ | è¯»å†™ | **å¤§éƒ¨åˆ†ä¸šåŠ¡æ•°æ®** |
| `NONSTRICT_READ_WRITE` | éä¸¥æ ¼è¯»å†™ | å…è®¸çŸ­æš‚ä¸ä¸€è‡´ |
| `TRANSACTIONAL` | äº‹åŠ¡æ€§ | åˆ†å¸ƒå¼ç¯å¢ƒ |

### 7.4 ç¼“å­˜ä½¿ç”¨çš„æ³¨æ„äº‹é¡¹


**ä»€ä¹ˆæ•°æ®é€‚åˆç¼“å­˜**ï¼š

```
âœ… é€‚åˆç¼“å­˜çš„æ•°æ®ï¼š
- è¯»å¤šå†™å°‘ï¼ˆäº§å“ä¿¡æ¯ã€é…ç½®æ•°æ®ï¼‰
- æ•°æ®é‡ä¸å¤§ï¼ˆå­—å…¸è¡¨ã€åˆ†ç±»æ•°æ®ï¼‰
- å˜åŒ–ä¸é¢‘ç¹ï¼ˆç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼‰

âŒ ä¸é€‚åˆç¼“å­˜çš„æ•°æ®ï¼š
- é¢‘ç¹ä¿®æ”¹ï¼ˆè®¢å•çŠ¶æ€ã€åº“å­˜ï¼‰
- æ•°æ®é‡å·¨å¤§ï¼ˆæ—¥å¿—ã€å†å²è®°å½•ï¼‰
- å®æ—¶æ€§è¦æ±‚é«˜ï¼ˆä»·æ ¼ã€ä½™é¢ï¼‰
```

---

## 8. âš¡ æ€§èƒ½ä¼˜åŒ–è§„èŒƒ


### 8.1 æ‰¹é‡æ“ä½œä¼˜åŒ–


**æ‰¹é‡æ’å…¥ä¼˜åŒ–**ï¼š

```java
// âŒ ä½æ•ˆçš„æ–¹å¼
for (int i = 0; i < 10000; i++) {
    User user = new User("user" + i);
    session.save(user);  // æ¯æ¬¡ä¸€æ¡SQL
}

// âœ… æ‰¹é‡å¤„ç†
Session session = sessionFactory.openSession();
Transaction tx = session.beginTransaction();

for (int i = 0; i < 10000; i++) {
    User user = new User("user" + i);
    session.save(user);
    
    if (i % 50 == 0) {  // æ¯50æ¡æ‰¹é‡æäº¤
        session.flush();
        session.clear();
    }
}

tx.commit();
```

**é…ç½®æ‰¹é‡å¤§å°**ï¼š

```properties
hibernate.jdbc.batch_size=50
hibernate.order_inserts=true
hibernate.order_updates=true
```

### 8.2 å»¶è¿ŸåŠ è½½ä¼˜åŒ–


**åˆç†ä½¿ç”¨å»¶è¿ŸåŠ è½½**ï¼š

```java
// åœºæ™¯ï¼šåªæ˜¾ç¤ºè®¢å•åˆ—è¡¨ï¼Œä¸éœ€è¦è®¢å•è¯¦æƒ…
@Entity
public class Order {
    @OneToMany(fetch = FetchType.LAZY)  // æ‡’åŠ è½½
    private List<OrderItem> items;
}

// æŸ¥è¯¢åˆ—è¡¨æ—¶ä¸åŠ è½½items
List<Order> orders = session.createQuery(
    "FROM Order", 
    Order.class
).getResultList();

// åªåœ¨éœ€è¦æ—¶æ‰åŠ è½½
for (Order order : orders) {
    if (needDetails) {
        order.getItems().size();  // è¿™æ—¶æ‰æŸ¥è¯¢
    }
}
```

### 8.3 æŠ•å½±æŸ¥è¯¢ä¼˜åŒ–


**åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ**ï¼š

```java
// âŒ æŸ¥è¯¢å®Œæ•´å®ä½“ï¼ˆ10ä¸ªå­—æ®µï¼‰
List<User> users = session.createQuery(
    "FROM User", 
    User.class
).getResultList();

// âœ… åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
List<Object[]> userNames = session.createQuery(
    "SELECT u.id, u.username FROM User u",
    Object[].class
).getResultList();

// âœ… æˆ–ä½¿ç”¨DTO
List<UserDTO> users = session.createQuery(
    "SELECT new com.example.UserDTO(u.id, u.username) FROM User u",
    UserDTO.class
).getResultList();
```

### 8.4 SQLæ‰§è¡Œè®¡åˆ’åˆ†æ


**å¼€å¯SQLæ—¥å¿—**ï¼š

```properties
# æ˜¾ç¤ºSQLè¯­å¥
hibernate.show_sql=true

# æ ¼å¼åŒ–SQL
hibernate.format_sql=true

# æ˜¾ç¤ºSQLå‚æ•°
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
```

**åˆ†ææ…¢æŸ¥è¯¢**ï¼š

```java
// ç›‘æ§SQLæ‰§è¡Œæ—¶é—´
Session session = sessionFactory.openSession();
session.doWork(connection -> {
    Statement stmt = connection.createStatement();
    stmt.execute("EXPLAIN SELECT * FROM user WHERE age > 18");
    ResultSet rs = stmt.getResultSet();
    // åˆ†ææ‰§è¡Œè®¡åˆ’
});
```

---

## 9. ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†è§„èŒƒ


### 9.1 Hibernateå¸¸è§å¼‚å¸¸


**å¼‚å¸¸åˆ†ç±»å’Œå¤„ç†**ï¼š

| å¼‚å¸¸ç±»å‹ | å«ä¹‰ | å¤„ç†æ–¹å¼ |
|---------|------|---------|
| `HibernateException` | HibernateåŸºç¡€å¼‚å¸¸ | æ•è·å¹¶è½¬æ¢ä¸ºä¸šåŠ¡å¼‚å¸¸ |
| `LazyInitializationException` | æ‡’åŠ è½½å¼‚å¸¸ | JOIN FETCHæˆ–åœ¨Sessionå†…è®¿é—® |
| `StaleStateException` | ä¹è§‚é”å†²çª | æç¤ºç”¨æˆ·åˆ·æ–°é‡è¯• |
| `ConstraintViolationException` | çº¦æŸè¿å | è¿”å›å‹å¥½é”™è¯¯ä¿¡æ¯ |

### 9.2 å¼‚å¸¸å¤„ç†çš„æœ€ä½³å®è·µ


**ç»Ÿä¸€å¼‚å¸¸å¤„ç†**ï¼š

```java
@Service
public class UserService {
    
    public User createUser(User user) {
        try {
            Session session = sessionFactory.getCurrentSession();
            session.save(user);
            return user;
            
        } catch (ConstraintViolationException e) {
            // å”¯ä¸€çº¦æŸå†²çª
            throw new BusinessException("ç”¨æˆ·åå·²å­˜åœ¨");
            
        } catch (HibernateException e) {
            // Hibernateå¼‚å¸¸
            log.error("ä¿å­˜ç”¨æˆ·å¤±è´¥", e);
            throw new SystemException("ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
}

// å…¨å±€å¼‚å¸¸å¤„ç†
@ControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<String> handleBusinessException(BusinessException e) {
        return ResponseEntity.badRequest().body(e.getMessage());
    }
}
```

### 9.3 æ‡’åŠ è½½å¼‚å¸¸çš„è§£å†³


**å¸¸è§åœºæ™¯å’Œè§£å†³æ–¹æ¡ˆ**ï¼š

```java
// âŒ é—®é¢˜ä»£ç 
@GetMapping("/users/{id}")
public User getUser(@PathVariable Long id) {
    User user = userService.findById(id);
    return user;  // JSONåºåˆ—åŒ–æ—¶è®¿é—®æ‡’åŠ è½½å­—æ®µä¼šå¼‚å¸¸
}

// âœ… è§£å†³æ–¹æ¡ˆ1ï¼šDTOè½¬æ¢
@GetMapping("/users/{id}")
public UserDTO getUser(@PathVariable Long id) {
    User user = userService.findById(id);
    return new UserDTO(user);  // åªåŒ…å«éœ€è¦çš„å­—æ®µ
}

// âœ… è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨@JsonIgnore
@Entity
public class User {
    @OneToMany
    @JsonIgnore  // JSONåºåˆ—åŒ–æ—¶å¿½ç•¥
    private List<Order> orders;
}

// âœ… è§£å†³æ–¹æ¡ˆ3ï¼šOpen Session In Viewï¼ˆæ…ç”¨ï¼‰
spring.jpa.open-in-view=true  // å»¶é•¿Sessionç”Ÿå‘½å‘¨æœŸåˆ°è§†å›¾å±‚
```

---

## 10. ğŸ“ æ—¥å¿—è®°å½•è§„èŒƒ


### 10.1 SQLæ—¥å¿—é…ç½®


**å¼€å‘ç¯å¢ƒ**ï¼š

```properties
# è¯¦ç»†çš„SQLæ—¥å¿—
hibernate.show_sql=true
hibernate.format_sql=true
hibernate.use_sql_comments=true

# å‚æ•°ç»‘å®šæ—¥å¿—
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
```

**ç”Ÿäº§ç¯å¢ƒ**ï¼š

```properties
# å…³é—­SQLæ—¥å¿—ï¼Œä½¿ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
hibernate.show_sql=false

# åªè®°å½•è­¦å‘Šå’Œé”™è¯¯
logging.level.org.hibernate=WARN
```

### 10.2 ä¸šåŠ¡æ—¥å¿—è®°å½•


**å…³é”®æ“ä½œè®°å½•**ï¼š

```java
@Service
public class OrderService {
    
    private static final Logger log = LoggerFactory.getLogger(OrderService.class);
    
    @Transactional
    public Order createOrder(Order order) {
        log.info("å¼€å§‹åˆ›å»ºè®¢å•ï¼Œç”¨æˆ·IDï¼š{}", order.getUserId());
        
        try {
            orderDao.save(order);
            log.info("è®¢å•åˆ›å»ºæˆåŠŸï¼Œè®¢å•IDï¼š{}", order.getId());
            return order;
            
        } catch (Exception e) {
            log.error("è®¢å•åˆ›å»ºå¤±è´¥ï¼Œç”¨æˆ·IDï¼š{}ï¼Œé”™è¯¯ï¼š{}", 
                order.getUserId(), e.getMessage(), e);
            throw e;
        }
    }
}
```

### 10.3 æ€§èƒ½æ—¥å¿—ç›‘æ§


**æ…¢æŸ¥è¯¢ç›‘æ§**ï¼š

```java
// ä½¿ç”¨AOPè®°å½•æ…¢æŸ¥è¯¢
@Aspect
@Component
public class SlowQueryLogger {
    
    @Around("execution(* com.example.dao.*.*(..))")
    public Object logSlowQuery(ProceedingJoinPoint pjp) throws Throwable {
        long start = System.currentTimeMillis();
        Object result = pjp.proceed();
        long elapsed = System.currentTimeMillis() - start;
        
        if (elapsed > 1000) {  // è¶…è¿‡1ç§’è®°å½•
            log.warn("æ…¢æŸ¥è¯¢ï¼š{}ï¼Œè€—æ—¶ï¼š{}ms", 
                pjp.getSignature(), elapsed);
        }
        
        return result;
    }
}
```

---

## 11. ğŸ‘¥ å›¢é˜Ÿåä½œè§„èŒƒ


### 11.1 ä»£ç å®¡æŸ¥è¦ç‚¹


**å®¡æŸ¥æ¸…å•**ï¼š

```
âœ… å®ä½“è®¾è®¡æ£€æŸ¥
  - [ ] æ˜¯å¦æœ‰æ— å‚æ„é€ å™¨
  - [ ] equals/hashCodeæ˜¯å¦æ­£ç¡®å®ç°
  - [ ] æ˜¯å¦ä½¿ç”¨äº†åŒ…è£…ç±»å‹

âœ… æ˜ å°„é…ç½®æ£€æŸ¥
  - [ ] è¡¨åå’Œå­—æ®µåæ˜¯å¦æ˜ç¡®æŒ‡å®š
  - [ ] å…³è”å…³ç³»æ˜¯å¦åˆç†
  - [ ] çº§è”æ“ä½œæ˜¯å¦å®‰å…¨

âœ… æŸ¥è¯¢æ€§èƒ½æ£€æŸ¥
  - [ ] æ˜¯å¦å­˜åœ¨N+1æŸ¥è¯¢
  - [ ] æ˜¯å¦ä½¿ç”¨äº†JOIN FETCH
  - [ ] åˆ†é¡µæŸ¥è¯¢æ˜¯å¦ä¼˜åŒ–

âœ… äº‹åŠ¡ç®¡ç†æ£€æŸ¥
  - [ ] äº‹åŠ¡è¾¹ç•Œæ˜¯å¦æ¸…æ™°
  - [ ] æ˜¯å¦æ­£ç¡®å¤„ç†å¼‚å¸¸
  - [ ] æ˜¯å¦æœ‰äº‹åŠ¡åµŒå¥—é—®é¢˜
```

### 11.2 æ–‡æ¡£ç¼–å†™è§„èŒƒ


**å®ä½“æ–‡æ¡£**ï¼š

```java
/**
 * ç”¨æˆ·å®ä½“
 * 
 * è¡¨åï¼šsys_user
 * ä¸»è¦ç”¨é€”ï¼šå­˜å‚¨ç³»ç»Ÿç”¨æˆ·åŸºæœ¬ä¿¡æ¯
 * 
 * å…³è”å…³ç³»ï¼š
 * - ä¸€å¯¹å¤šï¼šOrderï¼ˆè®¢å•ï¼‰
 * - å¤šå¯¹å¤šï¼šRoleï¼ˆè§’è‰²ï¼‰
 * 
 * æ³¨æ„äº‹é¡¹ï¼š
 * - usernameå­—æ®µæœ‰å”¯ä¸€ç´¢å¼•
 * - passwordå­—æ®µéœ€è¦åŠ å¯†å­˜å‚¨
 * 
 * @author å¼ ä¸‰
 * @since 1.0
 */
@Entity
@Table(name = "sys_user")
public class User {
    // ...
}
```

### 11.3 æµ‹è¯•ç­–ç•¥


**å•å…ƒæµ‹è¯•ç¤ºä¾‹**ï¼š

```java
@SpringBootTest
@Transactional
public class UserServiceTest {
    
    @Autowired
    private UserService userService;
    
    @Test
    public void testCreateUser() {
        // å‡†å¤‡æ•°æ®
        User user = new User();
        user.setUsername("testuser");
        user.setEmail("test@example.com");
        
        // æ‰§è¡Œæ“ä½œ
        User saved = userService.createUser(user);
        
        // éªŒè¯ç»“æœ
        assertNotNull(saved.getId());
        assertEquals("testuser", saved.getUsername());
    }
    
    @Test
    public void testFindUserWithOrders() {
        // æµ‹è¯•å…³è”æŸ¥è¯¢ä¸ä¼šäº§ç”ŸN+1é—®é¢˜
        User user = userService.findUserWithOrders(1L);
        assertNotNull(user.getOrders());
    }
}
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒåŸåˆ™


```
ğŸ¯ å®ä½“è®¾è®¡ï¼šç®€å•çº¯ç²¹ï¼Œä¸šåŠ¡é€»è¾‘åˆ†ç¦»
ğŸ¯ Sessionç®¡ç†ï¼šä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªSessionï¼Œç”¨å®Œç«‹å³å…³é—­
ğŸ¯ äº‹åŠ¡ç®¡ç†ï¼šè¾¹ç•Œæ¸…æ™°ï¼Œè°¨æ…åµŒå¥—
ğŸ¯ æŸ¥è¯¢ä¼˜åŒ–ï¼šé¿å…N+1ï¼Œåˆç†ä½¿ç”¨JOIN FETCH
ğŸ¯ ç¼“å­˜ä½¿ç”¨ï¼šäº†è§£ä¸¤çº§ç¼“å­˜ï¼Œé€‰æ‹©åˆé€‚çš„æ•°æ®
ğŸ¯ å¼‚å¸¸å¤„ç†ï¼šç»Ÿä¸€å¤„ç†ï¼Œå‹å¥½æç¤º
```

### 12.2 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•


| æ£€æŸ¥é¡¹ | è¯´æ˜ | ä¼˜åŒ–æ–¹æ³• |
|--------|------|---------|
| **N+1æŸ¥è¯¢** | æœ€å¸¸è§çš„æ€§èƒ½é—®é¢˜ | ä½¿ç”¨JOIN FETCH |
| **æ‡’åŠ è½½å¼‚å¸¸** | Sessionå…³é—­åè®¿é—® | Sessionå†…è®¿é—®æˆ–DTOè½¬æ¢ |
| **æ‰¹é‡æ“ä½œ** | å¤§é‡æ•°æ®æ’å…¥æ›´æ–° | å¼€å¯æ‰¹é‡å¤„ç† |
| **æ·±åº¦åˆ†é¡µ** | å¤§åç§»é‡æŸ¥è¯¢ | ä½¿ç”¨æ¸¸æ ‡æˆ–IDèŒƒå›´ |
| **å…¨è¡¨æ‰«æ** | ç¼ºå°‘ç´¢å¼• | æ·»åŠ åˆé€‚çš„ç´¢å¼• |

### 12.3 å¼€å‘è§„èŒƒé€ŸæŸ¥è¡¨


**å®ä½“ç±»è§„èŒƒ**ï¼š
```
âœ… å¿…é¡»æœ‰æ— å‚æ„é€ å™¨
âœ… å®ç°Serializableæ¥å£
âœ… é‡å†™equals/hashCodeï¼ˆåŸºäºä¸šåŠ¡ä¸»é”®ï¼‰
âœ… ä½¿ç”¨åŒ…è£…ç±»å‹è€ŒéåŸºæœ¬ç±»å‹
âœ… æ˜ç¡®æŒ‡å®šè¡¨åå’Œå­—æ®µå
```

**Sessionä½¿ç”¨è§„èŒƒ**ï¼š
```
âœ… ä½¿ç”¨try-with-resourcesæˆ–finallyå…³é—­
âœ… ä¸è¦è·¨çº¿ç¨‹ä½¿ç”¨Session
âœ… æ‰¹é‡æ“ä½œå®šæœŸflushå’Œclear
âœ… Webç¯å¢ƒä½¿ç”¨getCurrentSession()
```

**æŸ¥è¯¢ä¼˜åŒ–è§„èŒƒ**ï¼š
```
âœ… ä¼˜å…ˆä½¿ç”¨HQL
âœ… ä½¿ç”¨JOIN FETCHè§£å†³N+1
âœ… åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼ˆæŠ•å½±ï¼‰
âœ… åˆ†é¡µæŸ¥è¯¢è¦ä¼˜åŒ–
âœ… å¼€å¯SQLæ—¥å¿—åˆ†æ
```

**äº‹åŠ¡ç®¡ç†è§„èŒƒ**ï¼š
```
âœ… Serviceå±‚ç®¡ç†äº‹åŠ¡
âœ… è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
âœ… åªè¯»æ“ä½œç”¨readOnly=true
âœ… æ­£ç¡®å¤„ç†å¼‚å¸¸å’Œå›æ»š
```

### 12.4 è®°å¿†å£è¯€


```
å®ä½“è®¾è®¡è¦ç®€å•ï¼Œæ„é€ equalsä¸èƒ½å¿˜
Sessionç”¨å®Œè¦å…³é—­ï¼Œè·¨çº¿ç¨‹ç”¨æ˜¯ç¥¸ç«¯
äº‹åŠ¡è¾¹ç•Œè¦æ¸…æ™°ï¼ŒåµŒå¥—ä¼ æ’­ææ˜ç™½
æŸ¥è¯¢ä¼˜åŒ–é˜²N+1ï¼ŒJOIN FETCHæ˜¯è‰¯æ–¹
ç¼“å­˜åˆ†çº§è¦ç†è§£ï¼Œè¯»å¤šå†™å°‘æ‰é€‚åˆ
å¼‚å¸¸å¤„ç†è¦ç»Ÿä¸€ï¼Œæ—¥å¿—è®°å½•åŠ©æ’æŸ¥
å›¢é˜Ÿåä½œé è§„èŒƒï¼Œä»£ç å®¡æŸ¥ä¿è´¨é‡
```

### 12.5 å­¦ä¹ è·¯çº¿å»ºè®®


**æ–°æ‰‹é˜¶æ®µ**ï¼ˆ1-2ä¸ªæœˆï¼‰ï¼š
- âœ… æŒæ¡åŸºæœ¬çš„CRUDæ“ä½œ
- âœ… ç†è§£Sessionå’ŒTransaction
- âœ… å­¦ä¼šé…ç½®å®ä½“æ˜ å°„

**è¿›é˜¶é˜¶æ®µ**ï¼ˆ3-6ä¸ªæœˆï¼‰ï¼š
- âœ… æŒæ¡HQLå’ŒCriteriaæŸ¥è¯¢
- âœ… ç†è§£ç¼“å­˜æœºåˆ¶
- âœ… å­¦ä¼šæ€§èƒ½ä¼˜åŒ–

**é«˜çº§é˜¶æ®µ**ï¼ˆ6ä¸ªæœˆä»¥ä¸Šï¼‰ï¼š
- âœ… æ·±å…¥ç†è§£HibernateåŸç†
- âœ… èƒ½å¤Ÿè§£å†³å¤æ‚é—®é¢˜
- âœ… åˆ¶å®šå›¢é˜Ÿå¼€å‘è§„èŒƒ

> ğŸ’¡ **å­¦ä¹ å»ºè®®**ï¼šç†è®ºç»“åˆå®è·µï¼Œå¤šå†™ä»£ç å¤šæ€»ç»“ï¼Œé‡åˆ°é—®é¢˜å¤šæŸ¥æ—¥å¿—å¤šæ€è€ƒã€‚Hibernateè™½ç„¶å¼ºå¤§ï¼Œä½†è¦ç”¨å¥½éœ€è¦ç†è§£å®ƒçš„å·¥ä½œåŸç†ï¼Œä¸èƒ½åªåœç•™åœ¨APIè°ƒç”¨å±‚é¢ã€‚