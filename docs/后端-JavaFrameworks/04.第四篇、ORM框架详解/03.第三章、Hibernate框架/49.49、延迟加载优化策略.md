---
title: 49ã€å»¶è¿ŸåŠ è½½ä¼˜åŒ–ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [å»¶è¿ŸåŠ è½½åŸºæœ¬æ¦‚å¿µ](#1-å»¶è¿ŸåŠ è½½åŸºæœ¬æ¦‚å¿µ)
2. [å»¶è¿ŸåŠ è½½å·¥ä½œæœºåˆ¶](#2-å»¶è¿ŸåŠ è½½å·¥ä½œæœºåˆ¶)
3. [Lazyé…ç½®è¯¦è§£](#3-lazyé…ç½®è¯¦è§£)
4. [ä»£ç†å¯¹è±¡åŸç†](#4-ä»£ç†å¯¹è±¡åŸç†)
5. [LazyInitializationExceptionå¤„ç†](#5-lazyinitializationexceptionå¤„ç†)
6. [OpenSessionInViewæ¨¡å¼](#6-opensessioninviewæ¨¡å¼)
7. [åŠ è½½ç­–ç•¥é€‰æ‹©æŒ‡å—](#7-åŠ è½½ç­–ç•¥é€‰æ‹©æŒ‡å—)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å»¶è¿ŸåŠ è½½åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å»¶è¿ŸåŠ è½½


**é€šä¿—ç†è§£**ï¼šå»¶è¿ŸåŠ è½½å°±åƒ"æŒ‰éœ€ç‚¹èœ"

```
ç±»æ¯”ç”Ÿæ´»åœºæ™¯ï¼š
- ç«‹å³åŠ è½½ï¼šè¿›é¤å…æ—¶å¨å¸ˆæŠŠæ‰€æœ‰èœéƒ½åšå¥½ç«¯ä¸Šæ¥ï¼ˆæµªè´¹ï¼‰
- å»¶è¿ŸåŠ è½½ï¼šå®¢äººç‚¹ä»€ä¹ˆèœï¼Œå¨å¸ˆæ‰åšä»€ä¹ˆèœï¼ˆæŒ‰éœ€ï¼‰

åœ¨Hibernateä¸­ï¼š
- ç«‹å³åŠ è½½ï¼šæŸ¥è¯¢å¯¹è±¡æ—¶ï¼Œå…³è”å¯¹è±¡ä¹Ÿä¸€èµ·æŸ¥å‡ºæ¥
- å»¶è¿ŸåŠ è½½ï¼šæŸ¥è¯¢å¯¹è±¡æ—¶ï¼Œå…³è”å¯¹è±¡å…ˆä¸æŸ¥ï¼Œç”¨çš„æ—¶å€™å†æŸ¥
```

**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
å»¶è¿ŸåŠ è½½ï¼ˆLazy Loadingï¼‰ï¼š
â€¢ å«ä¹‰ï¼šå…³è”å¯¹è±¡åœ¨çœŸæ­£ä½¿ç”¨æ—¶æ‰ä»æ•°æ®åº“åŠ è½½
â€¢ ç›®çš„ï¼šå‡å°‘ä¸å¿…è¦çš„æ•°æ®åº“æŸ¥è¯¢ï¼Œæå‡æ€§èƒ½
â€¢ åŸç†ï¼šé€šè¿‡ä»£ç†å¯¹è±¡å»¶è¿Ÿæ•°æ®åº“è®¿é—®
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å»¶è¿ŸåŠ è½½


**ğŸ’¡ æ€§èƒ½ä¼˜åŒ–çš„å…³é”®**

```
åœºæ™¯å¯¹æ¯”ï¼š

âŒ æ²¡æœ‰å»¶è¿ŸåŠ è½½çš„é—®é¢˜ï¼š
æŸ¥è¯¢ä¸€ä¸ªè®¢å• â†’ è‡ªåŠ¨æŸ¥è¯¢å®¢æˆ·ä¿¡æ¯
              â†’ è‡ªåŠ¨æŸ¥è¯¢æ‰€æœ‰è®¢å•é¡¹
              â†’ è‡ªåŠ¨æŸ¥è¯¢æ¯ä¸ªå•†å“ä¿¡æ¯
              â†’ è‡ªåŠ¨æŸ¥è¯¢å•†å“åˆ†ç±»...
ç»“æœï¼šä¸€ä¸ªç®€å•æŸ¥è¯¢è§¦å‘å‡ åæ¬¡SQL

âœ… ä½¿ç”¨å»¶è¿ŸåŠ è½½çš„ä¼˜åŠ¿ï¼š
æŸ¥è¯¢ä¸€ä¸ªè®¢å• â†’ åªæŸ¥è®¢å•åŸºæœ¬ä¿¡æ¯
éœ€è¦å®¢æˆ·æ—¶  â†’ æ‰æŸ¥å®¢æˆ·ä¿¡æ¯
éœ€è¦è®¢å•é¡¹  â†’ æ‰æŸ¥è®¢å•é¡¹
æŒ‰éœ€åŠ è½½ï¼Œæ€§èƒ½æå‡æ˜æ˜¾
```

**ğŸ” å®é™…æ”¶ç›Š**
- **å‡å°‘æŸ¥è¯¢**ï¼šé¿å…ä¸å¿…è¦çš„å…³è”æŸ¥è¯¢
- **èŠ‚çœå†…å­˜**ï¼šä¸åŠ è½½ç”¨ä¸åˆ°çš„æ•°æ®
- **æå‡å“åº”**ï¼šé¦–æ¬¡æŸ¥è¯¢é€Ÿåº¦æ›´å¿«
- **é™ä½è´Ÿè½½**ï¼šå‡å°‘æ•°æ®åº“å‹åŠ›

---

## 2. âš™ï¸ å»¶è¿ŸåŠ è½½å·¥ä½œæœºåˆ¶


### 2.1 åŠ è½½æ—¶æœºå¯¹æ¯”


**ğŸ“Š ç«‹å³åŠ è½½ vs å»¶è¿ŸåŠ è½½**

```
ç«‹å³åŠ è½½æµç¨‹ï¼š
ç”¨æˆ·æŸ¥è¯¢è®¢å•
    â†“
Hibernateæ‰§è¡ŒSQL
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰å…³è”æ•°æ®    â”‚
â”‚ â€¢ è®¢å•åŸºæœ¬ä¿¡æ¯          â”‚
â”‚ â€¢ å®¢æˆ·å®Œæ•´ä¿¡æ¯          â”‚
â”‚ â€¢ æ‰€æœ‰è®¢å•é¡¹            â”‚
â”‚ â€¢ æ¯ä¸ªå•†å“ä¿¡æ¯          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å›å®Œæ•´å¯¹è±¡å›¾

å»¶è¿ŸåŠ è½½æµç¨‹ï¼š
ç”¨æˆ·æŸ¥è¯¢è®¢å•
    â†“
Hibernateæ‰§è¡ŒSQL
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åªåŠ è½½è®¢å•åŸºæœ¬ä¿¡æ¯       â”‚
â”‚ å…³è”å¯¹è±¡ç”¨ä»£ç†å ä½       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å›è®¢å•å¯¹è±¡ï¼ˆå…³è”æ˜¯ä»£ç†ï¼‰
    â†“
ç”¨æˆ·è®¿é—®å®¢æˆ·ä¿¡æ¯
    â†“
è§¦å‘é¢å¤–SQLæŸ¥è¯¢å®¢æˆ·
```

### 2.2 å»¶è¿ŸåŠ è½½çš„è§¦å‘æ—¶æœº


**ğŸ”¸ ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘åŠ è½½**

```java
// å®ä½“å®šä¹‰
@Entity
public class Order {
    @Id
    private Long id;
    
    @ManyToOne(fetch = FetchType.LAZY)  // å»¶è¿ŸåŠ è½½
    private Customer customer;
    
    @OneToMany(fetch = FetchType.LAZY)
    private List<OrderItem> items;
}

// ä½¿ç”¨åœºæ™¯
Order order = session.get(Order.class, 1L);
// æ­¤æ—¶åªæŸ¥è¯¢äº†è®¢å•ä¿¡æ¯ï¼Œcustomerå’Œitemsæ˜¯ä»£ç†å¯¹è±¡

System.out.println(order.getId());        // âœ… ä¸è§¦å‘åŠ è½½
System.out.println(order.getCustomer());  // âŒ è§¦å‘customeråŠ è½½
order.getItems().size();                  // âŒ è§¦å‘itemsåŠ è½½
```

**è§¦å‘åŠ è½½çš„æ“ä½œ**ï¼š
- è®¿é—®å…³è”å¯¹è±¡çš„ä»»ä½•å±æ€§
- è°ƒç”¨å…³è”é›†åˆçš„size()ã€isEmpty()
- éå†å…³è”é›†åˆ
- è°ƒç”¨å…³è”å¯¹è±¡çš„toString()ï¼ˆå¦‚æœè®¿é—®äº†å»¶è¿Ÿå±æ€§ï¼‰

---

## 3. ğŸ”§ Lazyé…ç½®è¯¦è§£


### 3.1 @Lazyæ³¨è§£é…ç½®


**ğŸ”¸ å•å‘å…³è”é…ç½®**

```java
@Entity
public class Order {
    // å¤šå¯¹ä¸€ï¼šé»˜è®¤ç«‹å³åŠ è½½ï¼Œéœ€æ‰‹åŠ¨è®¾ç½®å»¶è¿Ÿ
    @ManyToOne(fetch = FetchType.LAZY)
    private Customer customer;
    
    // ä¸€å¯¹å¤šï¼šé»˜è®¤å»¶è¿ŸåŠ è½½
    @OneToMany(mappedBy = "order", fetch = FetchType.LAZY)
    private List<OrderItem> items;
    
    // ä¸€å¯¹ä¸€ï¼šé»˜è®¤ç«‹å³åŠ è½½ï¼Œéœ€æ‰‹åŠ¨è®¾ç½®å»¶è¿Ÿ
    @OneToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "shipping_id")
    private ShippingInfo shipping;
}
```

**ğŸ“‹ åŠ è½½ç­–ç•¥å¯¹ç…§è¡¨**

| å…³è”ç±»å‹ | é»˜è®¤ç­–ç•¥ | æ¨èç­–ç•¥ | è¯´æ˜ |
|---------|---------|---------|------|
| `@ManyToOne` | **EAGER** | `LAZY` | å¤šå¯¹ä¸€é€šå¸¸åº”è¯¥å»¶è¿ŸåŠ è½½ |
| `@OneToMany` | **LAZY** | `LAZY` | ä¸€å¯¹å¤šé»˜è®¤å»¶è¿Ÿï¼Œä¿æŒå³å¯ |
| `@OneToOne` | **EAGER** | `LAZY` | ä¸€å¯¹ä¸€çœ‹æƒ…å†µï¼Œå»ºè®®å»¶è¿Ÿ |
| `@ManyToMany` | **LAZY** | `LAZY` | å¤šå¯¹å¤šé»˜è®¤å»¶è¿Ÿï¼Œä¿æŒå³å¯ |

### 3.2 æ‰¹é‡åŠ è½½é…ç½®


**ğŸš€ @BatchSizeä¼˜åŒ–**

```java
@Entity
public class Order {
    @OneToMany(mappedBy = "order")
    @BatchSize(size = 10)  // æ‰¹é‡åŠ è½½ï¼šä¸€æ¬¡æœ€å¤šåŠ è½½10ä¸ªè®¢å•çš„è®¢å•é¡¹
    private List<OrderItem> items;
}

// ä½¿ç”¨æ•ˆæœå¯¹æ¯”ï¼š
List<Order> orders = session.createQuery("from Order", Order.class)
                           .setMaxResults(20)
                           .getResultList();

// ä¸ä½¿ç”¨@BatchSizeï¼š
// è®¿é—®itemsæ—¶ï¼Œæ¯ä¸ªè®¢å•è§¦å‘1æ¬¡æŸ¥è¯¢ = 20æ¬¡SQL

// ä½¿ç”¨@BatchSize(size=10)ï¼š
// è®¿é—®itemsæ—¶ï¼Œ10ä¸ªè®¢å•ä¸€æ‰¹æŸ¥è¯¢ = 2æ¬¡SQL
for (Order order : orders) {
    order.getItems().size();  // è§¦å‘æ‰¹é‡åŠ è½½
}
```

**ğŸ’¡ BatchSizeå·¥ä½œåŸç†**

```
åœºæ™¯ï¼šæŸ¥è¯¢20ä¸ªè®¢å•ï¼Œæ¯ä¸ªè®¢å•æœ‰è®¢å•é¡¹ï¼ˆå»¶è¿ŸåŠ è½½ï¼‰

ä¸ä½¿ç”¨BatchSizeï¼š
Order1è®¿é—®items â†’ SELECT * FROM items WHERE order_id = 1
Order2è®¿é—®items â†’ SELECT * FROM items WHERE order_id = 2
...
Order20è®¿é—®items â†’ SELECT * FROM items WHERE order_id = 20
æ€»è®¡ï¼š20æ¬¡SQLæŸ¥è¯¢

ä½¿ç”¨@BatchSize(size=10)ï¼š
Order1è®¿é—®items â†’ SELECT * FROM items WHERE order_id IN (1,2,3...10)
Order11è®¿é—®items â†’ SELECT * FROM items WHERE order_id IN (11,12...20)
æ€»è®¡ï¼š2æ¬¡SQLæŸ¥è¯¢ï¼ˆæ€§èƒ½æå‡10å€ï¼‰
```

### 3.3 æ‡’åŠ è½½ç»„åˆç­–ç•¥


```java
@Entity
public class Product {
    @Id
    private Long id;
    
    // åŸºæœ¬å±æ€§ï¼šç«‹å³åŠ è½½
    private String name;
    private BigDecimal price;
    
    // ç®€å•å…³è”ï¼šå»¶è¿ŸåŠ è½½
    @ManyToOne(fetch = FetchType.LAZY)
    private Category category;
    
    // é›†åˆå…³è”ï¼šå»¶è¿Ÿ+æ‰¹é‡åŠ è½½
    @OneToMany(mappedBy = "product")
    @BatchSize(size = 20)
    private List<Review> reviews;
    
    // å¤§å­—æ®µï¼šå»¶è¿ŸåŠ è½½
    @Lob
    @Basic(fetch = FetchType.LAZY)
    private byte[] image;
}
```

---

## 4. ğŸ­ ä»£ç†å¯¹è±¡åŸç†


### 4.1 ä»£ç†å¯¹è±¡æ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£ï¼šä»£ç†å°±åƒ"æ›¿èº«æ¼”å‘˜"**

```
ç”µå½±æ‹æ‘„åœºæ™¯ï¼š
- çœŸå®æ¼”å‘˜ï¼šæ•°æ®åº“ä¸­çš„çœŸå®æ•°æ®
- æ›¿èº«æ¼”å‘˜ï¼šHibernateåˆ›å»ºçš„ä»£ç†å¯¹è±¡
- å±é™©åœºæ™¯ï¼šéœ€è¦è®¿é—®æ•°æ®æ—¶æ‰è®©çœŸå®æ¼”å‘˜ä¸Šåœº

ä»£ç†å¯¹è±¡ç‰¹ç‚¹ï¼š
1. å¤–è¡¨å’ŒçœŸå®å¯¹è±¡ä¸€æ ·ï¼ˆç»§æ‰¿åŒä¸€ä¸ªç±»ï¼‰
2. å†…éƒ¨æ˜¯ç©ºçš„ï¼ˆæ•°æ®æœªåŠ è½½ï¼‰
3. è¢«ä½¿ç”¨æ—¶æ‰å»æ•°æ®åº“è·å–çœŸå®æ•°æ®
```

### 4.2 ä»£ç†ç”Ÿæˆæœºåˆ¶


**ğŸ”¸ Hibernateå¦‚ä½•åˆ›å»ºä»£ç†**

```
ä»£ç†åˆ›å»ºè¿‡ç¨‹ï¼š

1. å®šä¹‰å®ä½“ç±»
   â””â”€â”€ Customer.javaï¼ˆçœŸå®ç±»ï¼‰

2. Hibernateå¯åŠ¨æ—¶
   â””â”€â”€ ä½¿ç”¨å­—èŠ‚ç å¢å¼ºå·¥å…·ï¼ˆcglib/javassistï¼‰
       â””â”€â”€ åŠ¨æ€ç”Ÿæˆå­ç±»ï¼šCustomer$HibernateProxy

3. æŸ¥è¯¢æ—¶è¿”å›ä»£ç†
   â””â”€â”€ session.get() è¿”å› Customer$HibernateProxyå®ä¾‹

4. è®¿é—®å±æ€§æ—¶
   â””â”€â”€ ä»£ç†æ‹¦æˆªæ–¹æ³•è°ƒç”¨
       â””â”€â”€ åˆ¤æ–­æ˜¯å¦å·²åŠ è½½
           â”œâ”€â”€ å·²åŠ è½½ï¼šç›´æ¥è¿”å›
           â””â”€â”€ æœªåŠ è½½ï¼šæ‰§è¡ŒSQLåŠ è½½æ•°æ®
```

**ğŸ’» ä»£ç†å¯¹è±¡å®ç°ç¤ºä¾‹**

```java
// Hibernateå†…éƒ¨ç”Ÿæˆçš„ä»£ç†ç±»ï¼ˆç®€åŒ–ç‰ˆï¼‰
public class Customer$HibernateProxy extends Customer {
    private Customer target;  // çœŸå®å¯¹è±¡
    private boolean initialized = false;
    
    @Override
    public String getName() {
        if (!initialized) {
            // è§¦å‘æ•°æ®åº“åŠ è½½
            target = loadFromDatabase();
            initialized = true;
        }
        return target.getName();
    }
    
    @Override
    public String toString() {
        if (!initialized) {
            return "Customer$HibernateProxy@" + id;
        }
        return target.toString();
    }
}
```

### 4.3 ä»£ç†å¯¹è±¡çš„è¯†åˆ«


**ğŸ” å¦‚ä½•åˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸ºä»£ç†**

```java
Order order = session.get(Order.class, 1L);
Customer customer = order.getCustomer();

// æ–¹æ³•1ï¼šä½¿ç”¨instanceofï¼ˆä¸å‡†ç¡®ï¼‰
if (customer instanceof Customer) {
    // ä»£ç†å¯¹è±¡ä¹Ÿä¼šè¿”å›true
}

// æ–¹æ³•2ï¼šæ£€æŸ¥ç±»å
String className = customer.getClass().getName();
if (className.contains("$HibernateProxy")) {
    System.out.println("è¿™æ˜¯ä»£ç†å¯¹è±¡");
}

// æ–¹æ³•3ï¼šä½¿ç”¨Hibernateå·¥å…·ç±»ï¼ˆæ¨èï¼‰
if (Hibernate.isInitialized(customer)) {
    System.out.println("å·²åˆå§‹åŒ–");
} else {
    System.out.println("æ˜¯ä»£ç†å¯¹è±¡ï¼Œæœªåˆå§‹åŒ–");
}

// æ–¹æ³•4ï¼šå¼ºåˆ¶åˆå§‹åŒ–
Hibernate.initialize(customer);  // è§¦å‘åŠ è½½
```

---

## 5. âš ï¸ LazyInitializationExceptionå¤„ç†


### 5.1 å¼‚å¸¸äº§ç”ŸåŸå› 


**ğŸ”¸ ä»€ä¹ˆæ˜¯LazyInitializationException**

```
é”™è¯¯åœºæ™¯ï¼šSessionå…³é—­åè®¿é—®å»¶è¿ŸåŠ è½½å¯¹è±¡

try (Session session = sessionFactory.openSession()) {
    Order order = session.get(Order.class, 1L);
    return order;  // Sessionå³å°†å…³é—­
}

// åœ¨è¿™é‡Œè®¿é—®å»¶è¿ŸåŠ è½½çš„å±æ€§
order.getCustomer().getName();  // âŒ æŠ›å‡ºLazyInitializationException
```

**é”™è¯¯ä¿¡æ¯è§£è¯»**ï¼š
```
LazyInitializationException: could not initialize proxy - no Session

ç¿»è¯‘ï¼šæ— æ³•åˆå§‹åŒ–ä»£ç†å¯¹è±¡ï¼Œå› ä¸ºSessionå·²ç»å…³é—­äº†
åŸå› ï¼šå»¶è¿ŸåŠ è½½éœ€è¦Sessionæ¥æ‰§è¡ŒSQLï¼Œä½†Sessionå·²å…³é—­
```

### 5.2 å¼‚å¸¸è§£å†³æ–¹æ¡ˆ


**âœ… æ–¹æ¡ˆ1ï¼šåœ¨Sessionå†…å®Œæˆæ‰€æœ‰æ“ä½œ**

```java
// æ¨èåšæ³•ï¼šåœ¨Serviceå±‚äº‹åŠ¡å†…å¤„ç†
@Transactional
public OrderDTO getOrderWithCustomer(Long orderId) {
    Order order = orderRepository.findById(orderId);
    
    // åœ¨Sessionå†…è®¿é—®å»¶è¿ŸåŠ è½½çš„å±æ€§
    String customerName = order.getCustomer().getName();
    List<OrderItem> items = order.getItems();
    
    // è½¬æ¢ä¸ºDTOè¿”å›ï¼ˆä¸åŒ…å«ä»£ç†å¯¹è±¡ï¼‰
    return new OrderDTO(order, customerName, items);
}
```

**âœ… æ–¹æ¡ˆ2ï¼šä½¿ç”¨JOIN FETCHæå‰åŠ è½½**

```java
// HQLæ–¹å¼
@Query("SELECT o FROM Order o JOIN FETCH o.customer WHERE o.id = :id")
Order findByIdWithCustomer(@Param("id") Long id);

// Criteria APIæ–¹å¼
CriteriaBuilder cb = session.getCriteriaBuilder();
CriteriaQuery<Order> query = cb.createQuery(Order.class);
Root<Order> root = query.from(Order.class);
root.fetch("customer", JoinType.LEFT);  // æå‰åŠ è½½
query.where(cb.equal(root.get("id"), orderId));
```

**âœ… æ–¹æ¡ˆ3ï¼šä½¿ç”¨@EntityGraph**

```java
@Entity
@NamedEntityGraph(
    name = "Order.withCustomer",
    attributeNodes = @NamedAttributeNode("customer")
)
public class Order { ... }

// ä½¿ç”¨
@EntityGraph("Order.withCustomer")
Order findById(Long id);
```

**âœ… æ–¹æ¡ˆ4ï¼šæ‰‹åŠ¨åˆå§‹åŒ–**

```java
@Transactional
public Order getOrder(Long id) {
    Order order = session.get(Order.class, id);
    
    // æ‰‹åŠ¨åˆå§‹åŒ–éœ€è¦çš„å…³è”å¯¹è±¡
    Hibernate.initialize(order.getCustomer());
    Hibernate.initialize(order.getItems());
    
    return order;
}
```

### 5.3 æœ€ä½³å®è·µå»ºè®®


> ğŸ’¡ **é˜²æ­¢LazyInitializationExceptionçš„ç­–ç•¥**
> 
> 1. **DTOæ¨¡å¼**ï¼šåœ¨Serviceå±‚è½¬æ¢ä¸ºDTOï¼Œåªä¼ è¾“éœ€è¦çš„æ•°æ®
> 2. **æ˜ç¡®åŠ è½½**ï¼šä½¿ç”¨JOIN FETCHæˆ–EntityGraphæ˜ç¡®æŒ‡å®šåŠ è½½å†…å®¹
> 3. **äº‹åŠ¡è¾¹ç•Œ**ï¼šç¡®ä¿åœ¨äº‹åŠ¡èŒƒå›´å†…å®Œæˆæ‰€æœ‰æ•°æ®è®¿é—®
> 4. **é¿å…è¿”å›å®ä½“**ï¼šä¸è¦å°†Hibernateå®ä½“ç›´æ¥è¿”å›åˆ°è¡¨ç°å±‚

---

## 6. ğŸŒ OpenSessionInViewæ¨¡å¼


### 6.1 OSIVæ¨¡å¼åŸç†


**ğŸ”¸ ä»€ä¹ˆæ˜¯OpenSessionInView**

```
ä¼ ç»Ÿæ¨¡å¼ï¼š
Controller â†’ Serviceï¼ˆæ‰“å¼€Sessionï¼‰â†’ DAO â†’ æ•°æ®åº“
                    â†“ï¼ˆå…³é—­Sessionï¼‰
            è¿”å›å®ä½“å¯¹è±¡ï¼ˆå¯èƒ½æœ‰ä»£ç†ï¼‰
            â†“
Controllerè®¿é—®å»¶è¿Ÿå±æ€§ â†’ âŒ LazyInitializationException

OSIVæ¨¡å¼ï¼š
Filteræ‰“å¼€Session
    â†“
Controller â†’ Service â†’ DAO â†’ æ•°æ®åº“
    â†“
Controllerè®¿é—®å»¶è¿Ÿå±æ€§ â†’ âœ… å¯ä»¥è®¿é—®ï¼ˆSessionæœªå…³é—­ï¼‰
    â†“
Filterå…³é—­Sessionï¼ˆè¯·æ±‚ç»“æŸæ—¶ï¼‰
```

**å·¥ä½œæµç¨‹å›¾ç¤º**ï¼š

```
HTTPè¯·æ±‚
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenSessionInView Filter       â”‚
â”‚  1. æ‰“å¼€Session                 â”‚
â”‚  2. ç»‘å®šåˆ°å½“å‰çº¿ç¨‹              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Controller                     â”‚
â”‚  è°ƒç”¨Serviceå±‚æ–¹æ³•              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service                        â”‚
â”‚  æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å†…ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Controller                     â”‚
â”‚  è®¿é—®å»¶è¿ŸåŠ è½½å±æ€§ï¼ˆå¯ä»¥æˆåŠŸï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenSessionInView Filter       â”‚
â”‚  1. å…³é—­Session                 â”‚
â”‚  2. æ¸…ç†èµ„æº                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
è¿”å›å“åº”
```

### 6.2 Spring Bootä¸­çš„OSIVé…ç½®


```properties
# application.properties

# æ–¹å¼1ï¼šå¯ç”¨OSIVï¼ˆSpring Boot 2.0+é»˜è®¤å¼€å¯ï¼‰
spring.jpa.open-in-view=true

# æ–¹å¼2ï¼šç¦ç”¨OSIVï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
spring.jpa.open-in-view=false
```

```java
// è‡ªå®šä¹‰OSIV Filterï¼ˆå¦‚éœ€ç²¾ç»†æ§åˆ¶ï¼‰
@Configuration
public class HibernateConfig {
    
    @Bean
    public FilterRegistrationBean<OpenSessionInViewFilter> openSessionInViewFilter() {
        FilterRegistrationBean<OpenSessionInViewFilter> filter = 
            new FilterRegistrationBean<>();
        filter.setFilter(new OpenSessionInViewFilter());
        filter.addUrlPatterns("/api/*");  // åªå¯¹APIæ¥å£å¯ç”¨
        filter.setOrder(5);
        return filter;
    }
}
```

### 6.3 OSIVçš„ä¼˜ç¼ºç‚¹åˆ†æ


**âš–ï¸ ä¼˜ç¼ºç‚¹å¯¹æ¯”**

| æ–¹é¢ | ä¼˜åŠ¿ âœ… | åŠ£åŠ¿ âŒ |
|------|---------|---------|
| **å¼€å‘ä¾¿åˆ©æ€§** | æ— éœ€æ‹…å¿ƒå»¶è¿ŸåŠ è½½å¼‚å¸¸<br>ä»£ç æ›´ç®€æ´ | å¯èƒ½éšè—æ€§èƒ½é—®é¢˜<br>è¿‡åº¦ä¾èµ–è‡ªåŠ¨åŠ è½½ |
| **æ€§èƒ½å½±å“** | æŒ‰éœ€åŠ è½½ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½ | å¯èƒ½äº§ç”ŸN+1æŸ¥è¯¢<br>Sessionç”Ÿå‘½å‘¨æœŸè¿‡é•¿ |
| **æ•°æ®åº“è¿æ¥** | å»¶è¿ŸåŠ è½½æ—¶å¯ä»¥è®¿é—®æ•°æ®åº“ | å ç”¨è¿æ¥æ—¶é—´é•¿<br>é«˜å¹¶å‘æ—¶è¿æ¥æ± å‹åŠ›å¤§ |
| **äº‹åŠ¡ä¸€è‡´æ€§** | Viewå±‚å¯ä»¥è®¿é—®æœ€æ–°æ•°æ® | å¯èƒ½åœ¨Viewå±‚è§¦å‘æ›´æ–°<br>äº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™° |

**ğŸš¨ OSIVå­˜åœ¨çš„é—®é¢˜**

```java
// é—®é¢˜1ï¼šN+1æŸ¥è¯¢
@GetMapping("/orders")
public List<Order> getOrders() {
    List<Order> orders = orderService.findAll();  // 1æ¬¡æŸ¥è¯¢
    
    // Viewå±‚è®¿é—®å»¶è¿Ÿå±æ€§
    for (Order order : orders) {
        order.getCustomer().getName();  // Næ¬¡æŸ¥è¯¢
    }
    return orders;
}

// é—®é¢˜2ï¼šè¿æ¥å ç”¨æ—¶é—´é•¿
è¯·æ±‚å¼€å§‹ â”€â”€â”€â”€â”€â”€ Sessionæ‰“å¼€ â”€â”€â”€â”€â”€â”€ ä¸šåŠ¡å¤„ç† â”€â”€â”€â”€â”€â”€ è§†å›¾æ¸²æŸ“ â”€â”€â”€â”€â”€â”€ Sessionå…³é—­
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ•°æ®åº“è¿æ¥è¢«å ç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         ï¼ˆæ•´ä¸ªè¯·æ±‚å‘¨æœŸéƒ½å ç”¨è¿æ¥ï¼Œé«˜å¹¶å‘æ—¶è¿æ¥æ± å¯èƒ½è€—å°½ï¼‰
```

### 6.4 OSIVæ›¿ä»£æ–¹æ¡ˆ


**âœ… æ¨èæ–¹æ¡ˆï¼šDTO + æ˜ç¡®åŠ è½½**

```java
// 1. å®šä¹‰DTO
public class OrderDTO {
    private Long id;
    private String customerName;
    private List<OrderItemDTO> items;
    
    // æ„é€ å‡½æ•°è½¬æ¢
    public OrderDTO(Order order) {
        this.id = order.getId();
        // åœ¨Serviceå±‚ä¸»åŠ¨åŠ è½½
        this.customerName = order.getCustomer().getName();
        this.items = order.getItems().stream()
            .map(OrderItemDTO::new)
            .collect(Collectors.toList());
    }
}

// 2. Serviceå±‚è½¬æ¢
@Transactional(readOnly = true)
public OrderDTO getOrderDetail(Long id) {
    Order order = orderRepository.findByIdWithCustomerAndItems(id);
    return new OrderDTO(order);  // åœ¨äº‹åŠ¡å†…å®Œæˆæ‰€æœ‰åŠ è½½å’Œè½¬æ¢
}

// 3. Controllerè¿”å›DTO
@GetMapping("/orders/{id}")
public OrderDTO getOrder(@PathVariable Long id) {
    return orderService.getOrderDetail(id);  // ä¸ä¼šæœ‰å»¶è¿ŸåŠ è½½é—®é¢˜
}
```

> ğŸ’¡ **æœ€ä½³å®è·µå»ºè®®**
> 
> - **ç”Ÿäº§ç¯å¢ƒ**ï¼šå…³é—­OSIVï¼Œä½¿ç”¨DTOæ¨¡å¼
> - **å¼€å‘é˜¶æ®µ**ï¼šå¯ä»¥å¯ç”¨OSIVå¿«é€Ÿå¼€å‘ï¼Œä½†è¦æ³¨æ„æ€§èƒ½ç›‘æ§
> - **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨JOIN FETCHæˆ–EntityGraphæ˜ç¡®åŠ è½½ç­–ç•¥
> - **æ¶æ„è®¾è®¡**ï¼šServiceå±‚è´Ÿè´£æ•°æ®åŠ è½½ï¼ŒControllerå±‚åªåšè½¬å‘

---

## 7. ğŸ¯ åŠ è½½ç­–ç•¥é€‰æ‹©æŒ‡å—


### 7.1 ç­–ç•¥é€‰æ‹©å†³ç­–æ ‘


```
éœ€è¦åŠ è½½å…³è”æ•°æ®ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ å…³è”å¯¹è±¡æ€»æ˜¯ä¼šç”¨åˆ°ï¼Ÿ
    â”‚      â”œâ”€ æ˜¯ â†’ ä½¿ç”¨EAGERï¼ˆç«‹å³åŠ è½½ï¼‰
    â”‚      â”‚      ç¤ºä¾‹ï¼šè®¢å•å¿…ç„¶éœ€è¦å®¢æˆ·ä¿¡æ¯
    â”‚      â”‚
    â”‚      â””â”€ å¦ â†’ ä½¿ç”¨LAZYï¼ˆå»¶è¿ŸåŠ è½½ï¼‰
    â”‚             â””â”€ æ•°æ®é‡å¤§å—ï¼Ÿ
    â”‚                â”œâ”€ æ˜¯ â†’ LAZY + @BatchSize
    â”‚                â”‚      ç¤ºä¾‹ï¼šè®¢å•çš„è®¢å•é¡¹åˆ—è¡¨
    â”‚                â”‚
    â”‚                â””â”€ å¦ â†’ LAZY + JOIN FETCHï¼ˆæŒ‰éœ€ï¼‰
    â”‚                       ç¤ºä¾‹ï¼šå¶å°”éœ€è¦çš„è¯„è®ºåˆ—è¡¨
    â”‚
    â””â”€ å¦ â†’ ä¸é…ç½®å…³è”ï¼ˆDTOä¼ è¾“ï¼‰
           ç¤ºä¾‹ï¼šåªéœ€è¦è®¢å•IDå’Œé‡‘é¢
```

### 7.2 å¸¸è§åœºæ™¯åŠ è½½ç­–ç•¥


**ğŸ“‹ ä¸šåŠ¡åœºæ™¯æœ€ä½³å®è·µ**

| åœºæ™¯ | æ¨èç­–ç•¥ | é…ç½®ç¤ºä¾‹ | è¯´æ˜ |
|------|---------|---------|------|
| **è®¢å•-å®¢æˆ·** | `LAZY` + æŒ‰éœ€JOIN FETCH | `@ManyToOne(fetch=LAZY)` | ä¸æ˜¯æ¯æ¬¡éƒ½éœ€è¦å®¢æˆ·ä¿¡æ¯ |
| **è®¢å•-è®¢å•é¡¹** | `LAZY` + BatchSize | `@OneToMany(fetch=LAZY)`<br>`@BatchSize(size=10)` | æ‰¹é‡åŠ è½½é¿å…N+1 |
| **ç”¨æˆ·-è§’è‰²** | `EAGER` | `@ManyToMany(fetch=EAGER)` | è§’è‰²ä¿¡æ¯æ€»æ˜¯éœ€è¦çš„ |
| **æ–‡ç« -è¯„è®º** | `LAZY` | `@OneToMany(fetch=LAZY)` | è¯„è®ºåˆ—è¡¨æŒ‰éœ€åŠ è½½ |
| **å•†å“-è¯¦æƒ…** | `LAZY` + å¤§å­—æ®µ | `@OneToOne(fetch=LAZY)`<br>`@Lob @Basic(fetch=LAZY)` | è¯¦æƒ…å’Œå›¾ç‰‡æŒ‰éœ€åŠ è½½ |

### 7.3 æ€§èƒ½ä¼˜åŒ–ç»„åˆæ‹³


**ğŸš€ ç»¼åˆä¼˜åŒ–ç­–ç•¥**

```java
@Entity
public class Order {
    @Id
    private Long id;
    
    // ç­–ç•¥1ï¼šæ ¸å¿ƒå…³è”ç”¨LAZYï¼Œéœ€è¦æ—¶JOIN FETCH
    @ManyToOne(fetch = FetchType.LAZY)
    private Customer customer;
    
    // ç­–ç•¥2ï¼šé›†åˆå…³è”ç”¨LAZY + BatchSize
    @OneToMany(mappedBy = "order")
    @BatchSize(size = 20)
    private List<OrderItem> items;
    
    // ç­–ç•¥3ï¼šå¤§å­—æ®µç‹¬ç«‹å»¶è¿ŸåŠ è½½
    @Lob
    @Basic(fetch = FetchType.LAZY)
    private String description;
}

// Repositoryå±‚ï¼šæä¾›ä¸åŒçš„æŸ¥è¯¢æ–¹æ³•
public interface OrderRepository extends JpaRepository<Order, Long> {
    
    // åªæŸ¥è®¢å•åŸºæœ¬ä¿¡æ¯
    Order findById(Long id);
    
    // æŸ¥è¯¢è®¢å•+å®¢æˆ·
    @Query("SELECT o FROM Order o JOIN FETCH o.customer WHERE o.id = :id")
    Order findByIdWithCustomer(@Param("id") Long id);
    
    // æŸ¥è¯¢è®¢å•+å®¢æˆ·+è®¢å•é¡¹
    @Query("SELECT o FROM Order o " +
           "JOIN FETCH o.customer " +
           "LEFT JOIN FETCH o.items " +
           "WHERE o.id = :id")
    Order findByIdWithDetails(@Param("id") Long id);
    
    // æ‰¹é‡æŸ¥è¯¢+æ‰¹é‡åŠ è½½
    @Query("SELECT o FROM Order o JOIN FETCH o.customer")
    @QueryHints(@QueryHint(name = "hibernate.query.passDistinctThrough", value = "false"))
    List<Order> findAllWithCustomer();
}
```

### 7.4 ç›‘æ§ä¸è¯Šæ–­


**ğŸ” æ€§èƒ½ç›‘æ§è¦ç‚¹**

```properties
# å¼€å¯SQLæ—¥å¿—
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true

# æ˜¾ç¤ºSQLå‚æ•°ï¼ˆç”Ÿäº§ç¯å¢ƒå…³é—­ï¼‰
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE

# ç»Ÿè®¡ä¿¡æ¯
spring.jpa.properties.hibernate.generate_statistics=true
logging.level.org.hibernate.stat=DEBUG
```

```java
// ä»£ç ä¸­ç›‘æ§åŠ è½½è¡Œä¸º
SessionFactory sf = entityManager.getEntityManagerFactory()
    .unwrap(SessionFactory.class);
Statistics stats = sf.getStatistics();

// æ¸…ç©ºç»Ÿè®¡
stats.clear();

// æ‰§è¡Œæ“ä½œ
orderService.findAll();

// æŸ¥çœ‹ç»Ÿè®¡
System.out.println("æŸ¥è¯¢æ¬¡æ•°: " + stats.getQueryExecutionCount());
System.out.println("åŠ è½½å®ä½“æ•°: " + stats.getEntityLoadCount());
System.out.println("é›†åˆåŠ è½½æ¬¡æ•°: " + stats.getCollectionLoadCount());
```

> âš¡ **æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•**
> 
> - [ ] æ˜¯å¦æœ‰N+1æŸ¥è¯¢é—®é¢˜ï¼ˆæ‰¹é‡æŸ¥è¯¢æ—¶è¦ç‰¹åˆ«æ³¨æ„ï¼‰
> - [ ] æ˜¯å¦é…ç½®äº†åˆé€‚çš„@BatchSize
> - [ ] æ˜¯å¦ä½¿ç”¨äº†JOIN FETCHä¼˜åŒ–å¸¸ç”¨æŸ¥è¯¢
> - [ ] æ˜¯å¦å¯ç”¨äº†æŸ¥è¯¢ç¼“å­˜ï¼ˆé€‚åˆè¯»å¤šå†™å°‘åœºæ™¯ï¼‰
> - [ ] æ˜¯å¦ç›‘æ§äº†Sessionç”Ÿå‘½å‘¨æœŸå’Œè¿æ¥å ç”¨æ—¶é—´

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å»¶è¿ŸåŠ è½½æœ¬è´¨ï¼šæŒ‰éœ€åŠ è½½ï¼Œç”¨ä»£ç†å¯¹è±¡å»¶è¿Ÿæ•°æ®åº“è®¿é—®
ğŸ”¸ ä»£ç†å¯¹è±¡åŸç†ï¼šç»§æ‰¿å®ä½“ç±»ï¼Œæ‹¦æˆªæ–¹æ³•è°ƒç”¨ï¼Œè§¦å‘åŠ è½½
ğŸ”¸ LazyInitializationExceptionï¼šSessionå…³é—­åè®¿é—®å»¶è¿Ÿå¯¹è±¡æŠ¥é”™
ğŸ”¸ OSIVæ¨¡å¼ï¼šå»¶é•¿Sessionç”Ÿå‘½å‘¨æœŸï¼Œæ–¹ä¾¿ä½†æœ‰æ€§èƒ½éšæ‚£
ğŸ”¸ åŠ è½½ç­–ç•¥ï¼šLAZYä¸ºä¸»ï¼ŒEAGERä¸ºè¾…ï¼ŒæŒ‰ä¸šåŠ¡åœºæ™¯é€‰æ‹©
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å»¶è¿ŸåŠ è½½çš„æ ¸å¿ƒæ€æƒ³**
```
ç±»æ¯”ï¼šå›¾ä¹¦é¦†å€Ÿä¹¦
- ç«‹å³åŠ è½½ï¼šä¸€æ¬¡æŠŠæ‰€æœ‰ç›¸å…³ä¹¦éƒ½å€Ÿå‡ºæ¥ï¼ˆå¯èƒ½ç”¨ä¸ä¸Šï¼‰
- å»¶è¿ŸåŠ è½½ï¼šå…ˆå€Ÿä¸»è¦çš„ä¹¦ï¼Œéœ€è¦æ—¶å†å€Ÿç›¸å…³çš„ï¼ˆæŒ‰éœ€å€Ÿé˜…ï¼‰

å®é™…æ•ˆæœï¼š
â€¢ é¦–æ¬¡æŸ¥è¯¢æ›´å¿«ï¼ˆåªæŸ¥ä¸»è¡¨ï¼‰
â€¢ æŒ‰éœ€åŠ è½½å…³è”æ•°æ®ï¼ˆé¿å…æµªè´¹ï¼‰
â€¢ éœ€è¦æ³¨æ„Sessionç”Ÿå‘½å‘¨æœŸï¼ˆå¦åˆ™æŠ¥é”™ï¼‰
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„å¹³è¡¡**
```
ä¼˜åŒ–ç›®æ ‡ï¼š
â€¢ å‡å°‘SQLæŸ¥è¯¢æ¬¡æ•°
â€¢ é™ä½å•æ¬¡æŸ¥è¯¢æ•°æ®é‡
â€¢ ä¿æŒSessionç”Ÿå‘½å‘¨æœŸåˆç†

ä¼˜åŒ–æ‰‹æ®µï¼š
â€¢ LAZYï¼šå‡å°‘ä¸å¿…è¦çš„æ•°æ®åŠ è½½
â€¢ BatchSizeï¼šåˆå¹¶å¤šæ¬¡æŸ¥è¯¢ä¸ºæ‰¹é‡æŸ¥è¯¢
â€¢ JOIN FETCHï¼šä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰éœ€è¦çš„æ•°æ®
â€¢ DTOï¼šåœ¨Serviceå±‚å®Œæˆè½¬æ¢ï¼Œé¿å…å»¶è¿ŸåŠ è½½é—®é¢˜
```

**ğŸ”¹ å¸¸è§é—®é¢˜ä¸è§£å†³**
```
é—®é¢˜1ï¼šLazyInitializationException
åŸå› ï¼šSessionå…³é—­åè®¿é—®å»¶è¿Ÿå¯¹è±¡
æ–¹æ¡ˆï¼šåœ¨Sessionå†…å®Œæˆæ“ä½œï¼Œæˆ–ä½¿ç”¨JOIN FETCHæå‰åŠ è½½

é—®é¢˜2ï¼šN+1æŸ¥è¯¢
åŸå› ï¼šæ‰¹é‡æŸ¥è¯¢åï¼Œé€ä¸ªè®¿é—®å»¶è¿Ÿå±æ€§
æ–¹æ¡ˆï¼šä½¿ç”¨@BatchSizeæˆ–JOIN FETCH

é—®é¢˜3ï¼šOSIVå¯¼è‡´è¿æ¥å ç”¨
åŸå› ï¼šSessionç”Ÿå‘½å‘¨æœŸè¿‡é•¿
æ–¹æ¡ˆï¼šå…³é—­OSIVï¼Œä½¿ç”¨DTOæ¨¡å¼
```

### 8.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ¯ æ¨èå®è·µæ¨¡å¼**

```java
// 1. é»˜è®¤ä½¿ç”¨LAZY
@ManyToOne(fetch = FetchType.LAZY)
private Customer customer;

// 2. æä¾›ä¸“é—¨çš„æŸ¥è¯¢æ–¹æ³•
@Query("SELECT o FROM Order o JOIN FETCH o.customer WHERE o.id = :id")
Order findByIdWithCustomer(@Param("id") Long id);

// 3. é›†åˆå…³è”é…ç½®BatchSize
@OneToMany(mappedBy = "order")
@BatchSize(size = 20)
private List<OrderItem> items;

// 4. Serviceå±‚è½¬æ¢ä¸ºDTO
@Transactional(readOnly = true)
public OrderDTO getOrderDetail(Long id) {
    Order order = repository.findByIdWithCustomerAndItems(id);
    return new OrderDTO(order);  // åœ¨äº‹åŠ¡å†…å®Œæˆæ‰€æœ‰åŠ è½½
}

// 5. å…³é—­OSIVï¼Œæ˜ç¡®äº‹åŠ¡è¾¹ç•Œ
spring.jpa.open-in-view=false
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
å»¶è¿ŸåŠ è½½æŒ‰éœ€æŸ¥ï¼Œä»£ç†å¯¹è±¡æŠŠé—¨æŠŠ
Sessionå…³é—­éœ€æ³¨æ„ï¼Œæå‰åŠ è½½æˆ–è½¬åŒ–
BatchSizeæ‰¹é‡ä¼˜ï¼ŒJOIN FETCHä¸€æ¬¡æ‹¿
DTOæ¨¡å¼æœ€ç¨³å¦¥ï¼Œæ€§èƒ½ä¼˜åŒ–å…¨é å®ƒ
```

**ğŸ”§ æ•…éšœæ’æŸ¥æŒ‡å—**ï¼š
1. **é‡åˆ°LazyInitializationException**ï¼šæ£€æŸ¥Sessionæ˜¯å¦å·²å…³é—­
2. **æ€§èƒ½æ…¢**ï¼šæ£€æŸ¥æ˜¯å¦æœ‰N+1æŸ¥è¯¢ï¼Œä½¿ç”¨JOIN FETCHæˆ–BatchSize
3. **å†…å­˜å ç”¨é«˜**ï¼šæ£€æŸ¥æ˜¯å¦åŠ è½½äº†ä¸å¿…è¦çš„å¤§å¯¹è±¡ï¼Œä½¿ç”¨LAZY
4. **è¿æ¥æ± è€—å°½**ï¼šæ£€æŸ¥OSIVæ˜¯å¦å¯ç”¨ï¼ŒSessionç”Ÿå‘½å‘¨æœŸæ˜¯å¦è¿‡é•¿