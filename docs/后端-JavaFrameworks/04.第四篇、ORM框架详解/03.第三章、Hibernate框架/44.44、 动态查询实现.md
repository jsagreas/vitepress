---
title: 44ã€ åŠ¨æ€æŸ¥è¯¢å®ç°
---
## ğŸ“š ç›®å½•

1. [åŠ¨æ€æŸ¥è¯¢åŸºç¡€æ¦‚å¿µ](#1-åŠ¨æ€æŸ¥è¯¢åŸºç¡€æ¦‚å¿µ)
2. [æ¡ä»¶åŠ¨æ€ç»„è£…](#2-æ¡ä»¶åŠ¨æ€ç»„è£…)
3. [å‚æ•°åŠ¨æ€ç»‘å®š](#3-å‚æ•°åŠ¨æ€ç»‘å®š)
4. [QueryBuilderæ¨¡å¼](#4-querybuilderæ¨¡å¼)
5. [åŠ¨æ€HQLæ„å»º](#5-åŠ¨æ€hqlæ„å»º)
6. [åŠ¨æ€Criteriaæ„å»º](#6-åŠ¨æ€criteriaæ„å»º)
7. [æœ€ä½³å®è·µä¸æ€»ç»“](#7-æœ€ä½³å®è·µä¸æ€»ç»“)

---

## 1. ğŸ¯ åŠ¨æ€æŸ¥è¯¢åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åŠ¨æ€æŸ¥è¯¢


**é€šä¿—ç†è§£**ï¼šå°±åƒç‚¹å¤–å–ä¸€æ ·ï¼Œä½ å¯ä»¥æ ¹æ®å¿ƒæƒ…é€‰æ‹©ä¸åŒçš„æ¡ä»¶
```
åœºæ™¯ç±»æ¯”ï¼š
å›ºå®šæŸ¥è¯¢ = å¥—é¤ï¼ˆå›ºå®šæ­é…ï¼Œä¸èƒ½æ”¹ï¼‰
åŠ¨æ€æŸ¥è¯¢ = è‡ªé€‰ï¼ˆæƒ³è¦ä»€ä¹ˆå°±åŠ ä»€ä¹ˆï¼‰

æ¯”å¦‚æœç´¢å•†å“ï¼š
- æœ‰æ—¶åªæŒ‰ä»·æ ¼æœç´¢
- æœ‰æ—¶åªæŒ‰å“ç‰Œæœç´¢  
- æœ‰æ—¶ä»·æ ¼+å“ç‰Œ+ç±»åˆ«ä¸€èµ·æœç´¢
åŠ¨æ€æŸ¥è¯¢å°±æ˜¯æ ¹æ®ç”¨æˆ·å®é™…è¾“å…¥çš„æ¡ä»¶æ¥ç»„è£…æŸ¥è¯¢è¯­å¥
```

**ä¸“ä¸šå®šä¹‰**ï¼š
- **åŠ¨æ€æŸ¥è¯¢**ï¼šæ ¹æ®è¿è¡Œæ—¶çš„ä¸åŒæ¡ä»¶åŠ¨æ€æ„å»ºæŸ¥è¯¢è¯­å¥
- **æ ¸å¿ƒä»·å€¼**ï¼šé¿å…ä¸ºæ¯ç§æ¡ä»¶ç»„åˆéƒ½å†™ä¸€ä¸ªæŸ¥è¯¢æ–¹æ³•
- **å®ç°ç›®æ ‡**ï¼šä¸€ä¸ªæ–¹æ³•åº”å¯¹å¤šç§æŸ¥è¯¢åœºæ™¯

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€æŸ¥è¯¢


**å®é™…é—®é¢˜åœºæ™¯**ï¼š
```
ç”µå•†ç½‘ç«™å•†å“æœç´¢åŠŸèƒ½ï¼š
ç”¨æˆ·å¯èƒ½çš„æœç´¢æ¡ä»¶ï¼š
âœ“ åªè¾“å…¥å•†å“åç§°
âœ“ åªé€‰æ‹©ä»·æ ¼åŒºé—´
âœ“ åªé€‰æ‹©å“ç‰Œ
âœ“ å•†å“åç§° + ä»·æ ¼åŒºé—´
âœ“ å•†å“åç§° + å“ç‰Œ + ä»·æ ¼åŒºé—´
âœ“ ... å„ç§ç»„åˆ

å¦‚æœç”¨å›ºå®šæŸ¥è¯¢ï¼šéœ€è¦å†™ 2^n ç§æ–¹æ³•ï¼ˆnæ˜¯æ¡ä»¶æ•°ï¼‰
å¦‚æœç”¨åŠ¨æ€æŸ¥è¯¢ï¼šåªéœ€è¦ 1 ä¸ªæ–¹æ³•å°±å¤Ÿäº†
```

**ä¼ ç»Ÿåšæ³•çš„é—®é¢˜**ï¼š

| æ–¹å¼ | é—®é¢˜ | ç¤ºä¾‹ |
|------|------|------|
| **å†™å¤šä¸ªæ–¹æ³•** | ä»£ç å†—ä½™ï¼Œç»´æŠ¤å›°éš¾ | `findByName()`, `findByPrice()`, `findByNameAndPrice()`... |
| **æ‹¼æ¥SQLå­—ç¬¦ä¸²** | å®¹æ˜“å‡ºé”™ï¼ŒSQLæ³¨å…¥é£é™© | `"SELECT * FROM product WHERE name='" + name + "'"` |
| **å…¨å‚æ•°æ–¹æ³•** | ä¸çµæ´»ï¼Œnullå€¼å¤„ç†éº»çƒ¦ | `findProduct(name, price, brand)` éƒ½è¦ä¼ å€¼ |

### 1.3 åŠ¨æ€æŸ¥è¯¢çš„æ ¸å¿ƒæ€æƒ³


**åŸºæœ¬åŸç†**ï¼š
```
æ¡ä»¶åˆ¤æ–­æµç¨‹ï¼š
   ç”¨æˆ·è¾“å…¥
      â†“
   æ¡ä»¶æ£€æŸ¥ï¼ˆæ˜¯å¦ä¸ºç©º/nullï¼‰
      â†“
   åŠ¨æ€æ‹¼æ¥æŸ¥è¯¢æ¡ä»¶
      â†“
   æ‰§è¡ŒæŸ¥è¯¢
      â†“
   è¿”å›ç»“æœ

å®é™…ä»£ç æ€è·¯ï¼š
if (æ¡ä»¶1ä¸ä¸ºç©º) {
    æ·»åŠ æ¡ä»¶1åˆ°æŸ¥è¯¢
}
if (æ¡ä»¶2ä¸ä¸ºç©º) {
    æ·»åŠ æ¡ä»¶2åˆ°æŸ¥è¯¢
}
... æœ€åæ‰§è¡Œç»„è£…å¥½çš„æŸ¥è¯¢
```

---

## 2. ğŸ”§ æ¡ä»¶åŠ¨æ€ç»„è£…


### 2.1 åŸºç¡€æ¡ä»¶ç»„è£…æ–¹å¼


**æ–¹å¼ä¸€ï¼šå­—ç¬¦ä¸²æ‹¼æ¥HQLï¼ˆä¸æ¨èï¼‰**

âŒ **ä¸ºä»€ä¹ˆä¸æ¨è**ï¼š
- å®¹æ˜“å‡ºé”™ï¼ˆç©ºæ ¼ã€é€—å·å®¹æ˜“å¿˜ï¼‰
- SQLæ³¨å…¥é£é™©
- ä»£ç å¯è¯»æ€§å·®

```java
// è¿™ç§æ–¹å¼æœ‰å®‰å…¨éšæ‚£ï¼Œä»…ä½œæ¼”ç¤º
public List<Product> searchProducts(String name, Double minPrice) {
    String hql = "FROM Product p WHERE 1=1";  // 1=1 æ˜¯ä¸ªå°æŠ€å·§
    
    if (name != null && !name.isEmpty()) {
        hql += " AND p.name LIKE '%" + name + "%'";  // å±é™©ï¼
    }
    if (minPrice != null) {
        hql += " AND p.price >= " + minPrice;
    }
    
    return session.createQuery(hql, Product.class).list();
}
```

**æ–¹å¼äºŒï¼šCriteria APIï¼ˆæ¨èï¼‰**

âœ… **ä¸ºä»€ä¹ˆæ¨è**ï¼š
- ç±»å‹å®‰å…¨ï¼ˆç¼–è¯‘æ—¶æ£€æŸ¥ï¼‰
- ä¸ä¼šæœ‰SQLæ³¨å…¥
- ä»£ç æ›´æ¸…æ™°æ˜“è¯»

```java
public List<Product> searchProducts(String name, Double minPrice, String brand) {
    CriteriaBuilder cb = session.getCriteriaBuilder();
    CriteriaQuery<Product> query = cb.createQuery(Product.class);
    Root<Product> root = query.from(Product.class);
    
    // åˆ›å»ºæ¡ä»¶åˆ—è¡¨ï¼ˆæƒ³è±¡æˆä¸€ä¸ªè´­ç‰©è½¦ï¼ŒæŠŠæ¡ä»¶éƒ½æ”¾è¿›å»ï¼‰
    List<Predicate> predicates = new ArrayList<>();
    
    // æœ‰åç§°å°±åŠ åç§°æ¡ä»¶
    if (name != null && !name.isEmpty()) {
        predicates.add(cb.like(root.get("name"), "%" + name + "%"));
    }
    
    // æœ‰æœ€ä½ä»·å°±åŠ ä»·æ ¼æ¡ä»¶
    if (minPrice != null) {
        predicates.add(cb.ge(root.get("price"), minPrice));
    }
    
    // æœ‰å“ç‰Œå°±åŠ å“ç‰Œæ¡ä»¶
    if (brand != null && !brand.isEmpty()) {
        predicates.add(cb.equal(root.get("brand"), brand));
    }
    
    // æŠŠæ‰€æœ‰æ¡ä»¶ç”¨ANDè¿æ¥èµ·æ¥
    query.where(cb.and(predicates.toArray(new Predicate[0])));
    
    return session.createQuery(query).getResultList();
}
```

### 2.2 å¤æ‚æ¡ä»¶ç»„è£…


**AND å’Œ OR æ··åˆä½¿ç”¨**ï¼š
```
ä¸šåŠ¡éœ€æ±‚ï¼š
æŸ¥æ‰¾ç¬¦åˆä»¥ä¸‹æ¡ä»¶çš„å•†å“ï¼š
(å“ç‰Œæ˜¯A æˆ– å“ç‰Œæ˜¯B) å¹¶ä¸” (ä»·æ ¼>100)

SQLè¡¨è¾¾ï¼š
WHERE (brand='A' OR brand='B') AND price>100
```

```java
public List<Product> searchWithComplexConditions(
    List<String> brands, Double minPrice) {
    
    CriteriaBuilder cb = session.getCriteriaBuilder();
    CriteriaQuery<Product> query = cb.createQuery(Product.class);
    Root<Product> root = query.from(Product.class);
    
    List<Predicate> conditions = new ArrayList<>();
    
    // å“ç‰Œæ¡ä»¶ï¼ˆå¤šä¸ªå“ç‰Œç”¨ORï¼‰
    if (brands != null && !brands.isEmpty()) {
        List<Predicate> brandPredicates = new ArrayList<>();
        for (String brand : brands) {
            brandPredicates.add(cb.equal(root.get("brand"), brand));
        }
        // æŠŠæ‰€æœ‰å“ç‰Œæ¡ä»¶ç”¨ORè¿èµ·æ¥
        conditions.add(cb.or(brandPredicates.toArray(new Predicate[0])));
    }
    
    // ä»·æ ¼æ¡ä»¶ï¼ˆå•ä¸ªæ¡ä»¶ç›´æ¥åŠ ï¼‰
    if (minPrice != null) {
        conditions.add(cb.ge(root.get("price"), minPrice));
    }
    
    // æœ€åæ‰€æœ‰å¤§æ¡ä»¶ç”¨ANDè¿æ¥
    query.where(cb.and(conditions.toArray(new Predicate[0])));
    
    return session.createQuery(query).getResultList();
}
```

### 2.3 æ¡ä»¶ç»„è£…çš„å¸¸ç”¨æ¨¡å¼


**æ¨¡å¼æ€»ç»“**ï¼š

| æ¨¡å¼ | ä½¿ç”¨åœºæ™¯ | ä»£ç ç¤ºä¾‹ |
|------|----------|----------|
| **ç­‰å€¼åŒ¹é…** | ç²¾ç¡®æŸ¥æ‰¾ | `cb.equal(root.get("status"), "ACTIVE")` |
| **æ¨¡ç³ŠåŒ¹é…** | å…³é”®è¯æœç´¢ | `cb.like(root.get("name"), "%å…³é”®è¯%")` |
| **èŒƒå›´æŸ¥è¯¢** | ä»·æ ¼åŒºé—´ã€æ—¥æœŸåŒºé—´ | `cb.between(root.get("price"), min, max)` |
| **INæŸ¥è¯¢** | å¤šå€¼åŒ¹é… | `root.get("category").in(categoryList)` |
| **NULLåˆ¤æ–­** | æ£€æŸ¥æ˜¯å¦ä¸ºç©º | `cb.isNull(root.get("deleteTime"))` |
| **æ¯”è¾ƒè¿ç®—** | å¤§äºã€å°äºç­‰ | `cb.gt()`, `cb.lt()`, `cb.ge()`, `cb.le()` |

---

## 3. ğŸ”— å‚æ•°åŠ¨æ€ç»‘å®š


### 3.1 ä»€ä¹ˆæ˜¯å‚æ•°ç»‘å®š


**é€šä¿—è§£é‡Š**ï¼š
```
å‚æ•°ç»‘å®š = å ä½ç¬¦ + åæœŸèµ‹å€¼

å°±åƒå¡«ç©ºé¢˜ï¼š
é¢˜ç›®ï¼šæˆ‘ä»Šå¹´___å²ï¼Œä½åœ¨___
ç­”æ¡ˆï¼šæˆ‘ä»Šå¹´25å²ï¼Œä½åœ¨åŒ—äº¬

SQLä¸­çš„å‚æ•°ç»‘å®šï¼š
æ¨¡æ¿ï¼šSELECT * FROM user WHERE age=? AND city=?
æ‰§è¡Œï¼šæŠŠ25å’Œ'åŒ—äº¬'åˆ†åˆ«å¡«å…¥?çš„ä½ç½®
```

**ä¸ºä»€ä¹ˆè¦ç”¨å‚æ•°ç»‘å®š**ï¼š

âœ… **ä¼˜ç‚¹**ï¼š
- **é˜²æ­¢SQLæ³¨å…¥**ï¼šå‚æ•°ä¼šè¢«è‡ªåŠ¨è½¬ä¹‰
- **æé«˜æ€§èƒ½**ï¼šæ•°æ®åº“å¯ä»¥ç¼“å­˜æ‰§è¡Œè®¡åˆ’
- **ä»£ç æ¸…æ™°**ï¼šæŸ¥è¯¢è¯­å¥å’Œæ•°æ®åˆ†ç¦»

âŒ **ä¸ç”¨å‚æ•°ç»‘å®šçš„é—®é¢˜**ï¼š
```java
// å±é™©ç¤ºä¾‹
String hql = "FROM User WHERE name='" + userName + "'";
// å¦‚æœ userName = "admin' OR '1'='1"
// å®é™…æ‰§è¡Œï¼šFROM User WHERE name='admin' OR '1'='1'
// ç»“æœï¼šè¿”å›æ‰€æœ‰ç”¨æˆ·ï¼ï¼ˆSQLæ³¨å…¥ï¼‰
```

### 3.2 å‘½åå‚æ•°ç»‘å®š


**ä½¿ç”¨æ–¹å¼**ï¼šç”¨æœ‰æ„ä¹‰çš„åå­—ä½œä¸ºå‚æ•°å ä½ç¬¦

```java
public List<Product> findByNameAndPrice(String name, Double minPrice) {
    String hql = "FROM Product p WHERE p.name LIKE :productName " +
                 "AND p.price >= :minPrice";
    
    return session.createQuery(hql, Product.class)
            .setParameter("productName", "%" + name + "%")  // è®¾ç½®productNameå‚æ•°
            .setParameter("minPrice", minPrice)              // è®¾ç½®minPriceå‚æ•°
            .getResultList();
}
```

**åŠ¨æ€ç»‘å®šå‚æ•°ç¤ºä¾‹**ï¼š
```java
public List<Product> dynamicSearch(String name, Double minPrice, String brand) {
    StringBuilder hql = new StringBuilder("FROM Product p WHERE 1=1");
    Map<String, Object> params = new HashMap<>();  // å­˜å‚¨æ‰€æœ‰å‚æ•°
    
    if (name != null && !name.isEmpty()) {
        hql.append(" AND p.name LIKE :name");
        params.put("name", "%" + name + "%");
    }
    
    if (minPrice != null) {
        hql.append(" AND p.price >= :minPrice");
        params.put("minPrice", minPrice);
    }
    
    if (brand != null && !brand.isEmpty()) {
        hql.append(" AND p.brand = :brand");
        params.put("brand", brand);
    }
    
    Query<Product> query = session.createQuery(hql.toString(), Product.class);
    
    // æ‰¹é‡è®¾ç½®æ‰€æœ‰å‚æ•°
    params.forEach(query::setParameter);
    
    return query.getResultList();
}
```

### 3.3 ä½ç½®å‚æ•°ç»‘å®š


**ä½¿ç”¨æ–¹å¼**ï¼šç”¨æ•°å­—ä½ç½®ä½œä¸ºå‚æ•°å ä½ç¬¦

```java
public List<Product> findByPosition(String name, Double price) {
    String hql = "FROM Product p WHERE p.name = ?1 AND p.price >= ?2";
    
    return session.createQuery(hql, Product.class)
            .setParameter(1, name)   // ç¬¬1ä¸ª?
            .setParameter(2, price)  // ç¬¬2ä¸ª?
            .getResultList();
}
```

ğŸ’¡ **å»ºè®®**ï¼šä¼˜å…ˆä½¿ç”¨å‘½åå‚æ•°ï¼Œæ›´æ¸…æ™°æ˜“ç»´æŠ¤

**å¯¹æ¯”æ€»ç»“**ï¼š

| ç»‘å®šæ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|----------|------|------|----------|
| **å‘½åå‚æ•°** | å¯è¯»æ€§å¼ºï¼Œä¸æ˜“å‡ºé”™ | ä»£ç ç¨é•¿ | å¤æ‚æŸ¥è¯¢ï¼Œæ¨èä½¿ç”¨ |
| **ä½ç½®å‚æ•°** | ä»£ç ç®€æ´ | ä½ç½®å®¹æ˜“ææ·· | ç®€å•æŸ¥è¯¢ |

---

## 4. ğŸ—ï¸ QueryBuilderæ¨¡å¼


### 4.1 QueryBuilderæ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼š
```
QueryBuilder = æŸ¥è¯¢æ„å»ºå™¨ = æ­ç§¯æœ¨å¼å†™æŸ¥è¯¢

å°±åƒæ­ä¹é«˜ï¼š
1. é€‰æ‹©åŸºç¡€æ¿ï¼ˆFROMè¡¨ï¼‰
2. åŠ æ¡ä»¶å—ï¼ˆWHEREï¼‰
3. åŠ æ’åºå—ï¼ˆORDER BYï¼‰
4. åŠ åˆ†ç»„å—ï¼ˆGROUP BYï¼‰
... ä¸€æ­¥æ­¥ç»„è£…æˆå®Œæ•´æŸ¥è¯¢
```

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **é“¾å¼è°ƒç”¨**ï¼šä¸€è¡Œæ¥ä¸€è¡Œï¼Œé€»è¾‘æ¸…æ™°
- **æŒ‰éœ€æ·»åŠ **ï¼šéœ€è¦ä»€ä¹ˆæ¡ä»¶å°±åŠ ä»€ä¹ˆ
- **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æ—¶å°±èƒ½æ£€æŸ¥é”™è¯¯

### 4.2 è‡ªå®šä¹‰QueryBuilderå®ç°


**åŸºç¡€ç‰ˆQueryBuilder**ï¼š

```java
public class ProductQueryBuilder {
    private Session session;
    private CriteriaBuilder cb;
    private CriteriaQuery<Product> query;
    private Root<Product> root;
    private List<Predicate> predicates = new ArrayList<>();
    
    public ProductQueryBuilder(Session session) {
        this.session = session;
        this.cb = session.getCriteriaBuilder();
        this.query = cb.createQuery(Product.class);
        this.root = query.from(Product.class);
    }
    
    // æ·»åŠ åç§°æ¡ä»¶
    public ProductQueryBuilder withName(String name) {
        if (name != null && !name.isEmpty()) {
            predicates.add(cb.like(root.get("name"), "%" + name + "%"));
        }
        return this;  // è¿”å›è‡ªå·±ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨
    }
    
    // æ·»åŠ ä»·æ ¼åŒºé—´æ¡ä»¶
    public ProductQueryBuilder withPriceRange(Double min, Double max) {
        if (min != null) {
            predicates.add(cb.ge(root.get("price"), min));
        }
        if (max != null) {
            predicates.add(cb.le(root.get("price"), max));
        }
        return this;
    }
    
    // æ·»åŠ å“ç‰Œæ¡ä»¶
    public ProductQueryBuilder withBrand(String brand) {
        if (brand != null && !brand.isEmpty()) {
            predicates.add(cb.equal(root.get("brand"), brand));
        }
        return this;
    }
    
    // æ·»åŠ æ’åº
    public ProductQueryBuilder orderByPrice(boolean ascending) {
        if (ascending) {
            query.orderBy(cb.asc(root.get("price")));
        } else {
            query.orderBy(cb.desc(root.get("price")));
        }
        return this;
    }
    
    // æ‰§è¡ŒæŸ¥è¯¢
    public List<Product> build() {
        query.where(cb.and(predicates.toArray(new Predicate[0])));
        return session.createQuery(query).getResultList();
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// é“¾å¼è°ƒç”¨ï¼Œéå¸¸æ¸…æ™°
List<Product> products = new ProductQueryBuilder(session)
    .withName("æ‰‹æœº")           // åŠ åç§°æ¡ä»¶
    .withPriceRange(1000.0, 5000.0)  // åŠ ä»·æ ¼åŒºé—´
    .withBrand("å°ç±³")          // åŠ å“ç‰Œæ¡ä»¶
    .orderByPrice(true)         // ä»·æ ¼å‡åº
    .build();                   // æ‰§è¡ŒæŸ¥è¯¢

// æ ¹æ®ä¸åŒæ¡ä»¶çµæ´»ç»„åˆ
List<Product> cheapProducts = new ProductQueryBuilder(session)
    .withPriceRange(null, 1000.0)  // åªè¦1000ä»¥ä¸‹çš„
    .orderByPrice(true)
    .build();
```

### 4.3 é€šç”¨QueryBuilderè®¾è®¡


**æ”¯æŒå¤šç§å®ä½“çš„é€šç”¨æ„å»ºå™¨**ï¼š

```java
public class GenericQueryBuilder<T> {
    private Session session;
    private CriteriaBuilder cb;
    private CriteriaQuery<T> query;
    private Root<T> root;
    private List<Predicate> predicates = new ArrayList<>();
    
    public GenericQueryBuilder(Session session, Class<T> entityClass) {
        this.session = session;
        this.cb = session.getCriteriaBuilder();
        this.query = cb.createQuery(entityClass);
        this.root = query.from(entityClass);
    }
    
    // ç­‰å€¼æ¡ä»¶
    public GenericQueryBuilder<T> eq(String property, Object value) {
        if (value != null) {
            predicates.add(cb.equal(root.get(property), value));
        }
        return this;
    }
    
    // æ¨¡ç³ŠåŒ¹é…
    public GenericQueryBuilder<T> like(String property, String value) {
        if (value != null && !value.isEmpty()) {
            predicates.add(cb.like(root.get(property), "%" + value + "%"));
        }
        return this;
    }
    
    // å¤§äºç­‰äº
    public GenericQueryBuilder<T> ge(String property, Comparable value) {
        if (value != null) {
            predicates.add(cb.ge(root.get(property), value));
        }
        return this;
    }
    
    // å°äºç­‰äº
    public GenericQueryBuilder<T> le(String property, Comparable value) {
        if (value != null) {
            predicates.add(cb.le(root.get(property), value));
        }
        return this;
    }
    
    // INæŸ¥è¯¢
    public GenericQueryBuilder<T> in(String property, Collection<?> values) {
        if (values != null && !values.isEmpty()) {
            predicates.add(root.get(property).in(values));
        }
        return this;
    }
    
    // æ‰§è¡ŒæŸ¥è¯¢
    public List<T> getResultList() {
        query.where(cb.and(predicates.toArray(new Predicate[0])));
        return session.createQuery(query).getResultList();
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// æŸ¥è¯¢ç”¨æˆ·
List<User> users = new GenericQueryBuilder<>(session, User.class)
    .like("username", "admin")
    .ge("age", 18)
    .eq("status", "ACTIVE")
    .getResultList();

// æŸ¥è¯¢è®¢å•
List<Order> orders = new GenericQueryBuilder<>(session, Order.class)
    .eq("userId", 1001)
    .ge("createTime", startDate)
    .in("status", Arrays.asList("PAID", "SHIPPED"))
    .getResultList();
```

---

## 5. ğŸ“ åŠ¨æ€HQLæ„å»º


### 5.1 HQLåŠ¨æ€æ„å»ºåŸºç¡€


**åŸºæœ¬æ€è·¯**ï¼š
```
åŠ¨æ€HQLæ„å»º = å­—ç¬¦ä¸²æ‹¼æ¥ + æ¡ä»¶åˆ¤æ–­ + å‚æ•°ç»‘å®š

æ­¥éª¤ï¼š
1. å‡†å¤‡åŸºç¡€HQLï¼ˆSELECT ... FROM ...ï¼‰
2. æ ¹æ®æ¡ä»¶åŠ¨æ€æ·»åŠ WHEREå­å¥
3. åŠ¨æ€æ·»åŠ ORDER BYã€GROUP BYç­‰
4. ç»‘å®šå‚æ•°
5. æ‰§è¡ŒæŸ¥è¯¢
```

**ç®€å•ç¤ºä¾‹**ï¼š
```java
public List<Product> dynamicHQLSearch(String name, Double minPrice, 
                                      Integer categoryId, String sortBy) {
    StringBuilder hql = new StringBuilder("FROM Product p WHERE 1=1");
    Map<String, Object> params = new HashMap<>();
    
    // åŠ¨æ€æ·»åŠ åç§°æ¡ä»¶
    if (name != null && !name.isEmpty()) {
        hql.append(" AND p.name LIKE :name");
        params.put("name", "%" + name + "%");
    }
    
    // åŠ¨æ€æ·»åŠ ä»·æ ¼æ¡ä»¶
    if (minPrice != null) {
        hql.append(" AND p.price >= :minPrice");
        params.put("minPrice", minPrice);
    }
    
    // åŠ¨æ€æ·»åŠ åˆ†ç±»æ¡ä»¶
    if (categoryId != null) {
        hql.append(" AND p.category.id = :categoryId");
        params.put("categoryId", categoryId);
    }
    
    // åŠ¨æ€æ·»åŠ æ’åº
    if (sortBy != null) {
        hql.append(" ORDER BY p.").append(sortBy);
    }
    
    Query<Product> query = session.createQuery(hql.toString(), Product.class);
    params.forEach(query::setParameter);
    
    return query.getResultList();
}
```

### 5.2 HQLç‰‡æ®µç®¡ç†


**é—®é¢˜**ï¼šHQLå­—ç¬¦ä¸²åˆ†æ•£åœ¨å„å¤„ï¼Œéš¾ä»¥ç»´æŠ¤

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨å¸¸é‡ç±»ç»Ÿä¸€ç®¡ç†

```java
public class HQLFragments {
    // åŸºç¡€æŸ¥è¯¢ç‰‡æ®µ
    public static final String PRODUCT_BASE = "FROM Product p WHERE 1=1";
    public static final String ORDER_BASE = "FROM Order o WHERE 1=1";
    
    // æ¡ä»¶ç‰‡æ®µ
    public static final String NAME_LIKE = " AND p.name LIKE :name";
    public static final String PRICE_GE = " AND p.price >= :minPrice";
    public static final String PRICE_LE = " AND p.price <= :maxPrice";
    public static final String BRAND_EQ = " AND p.brand = :brand";
    public static final String CATEGORY_EQ = " AND p.category.id = :categoryId";
    
    // æ’åºç‰‡æ®µ
    public static final String ORDER_BY_PRICE_ASC = " ORDER BY p.price ASC";
    public static final String ORDER_BY_PRICE_DESC = " ORDER BY p.price DESC";
    public static final String ORDER_BY_CREATE_TIME = " ORDER BY p.createTime DESC";
}
```

**ä½¿ç”¨ç‰‡æ®µæ„å»ºæŸ¥è¯¢**ï¼š
```java
public List<Product> searchWithFragments(String name, Double minPrice, 
                                         Double maxPrice, String brand) {
    StringBuilder hql = new StringBuilder(HQLFragments.PRODUCT_BASE);
    Map<String, Object> params = new HashMap<>();
    
    if (name != null && !name.isEmpty()) {
        hql.append(HQLFragments.NAME_LIKE);
        params.put("name", "%" + name + "%");
    }
    
    if (minPrice != null) {
        hql.append(HQLFragments.PRICE_GE);
        params.put("minPrice", minPrice);
    }
    
    if (maxPrice != null) {
        hql.append(HQLFragments.PRICE_LE);
        params.put("maxPrice", maxPrice);
    }
    
    if (brand != null && !brand.isEmpty()) {
        hql.append(HQLFragments.BRAND_EQ);
        params.put("brand", brand);
    }
    
    hql.append(HQLFragments.ORDER_BY_PRICE_ASC);
    
    Query<Product> query = session.createQuery(hql.toString(), Product.class);
    params.forEach(query::setParameter);
    
    return query.getResultList();
}
```

### 5.3 å¤æ‚HQLåŠ¨æ€æ„å»º


**å¤æ‚åœºæ™¯**ï¼šå…³è”æŸ¥è¯¢ + åˆ†ç»„ç»Ÿè®¡ + åŠ¨æ€æ¡ä»¶

```java
public class OrderStatisticsBuilder {
    
    /**
     * æŸ¥è¯¢è®¢å•ç»Ÿè®¡ä¿¡æ¯
     * @param startDate å¼€å§‹æ—¥æœŸï¼ˆå¯é€‰ï¼‰
     * @param endDate ç»“æŸæ—¥æœŸï¼ˆå¯é€‰ï¼‰
     * @param status è®¢å•çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
     * @param groupByUser æ˜¯å¦æŒ‰ç”¨æˆ·åˆ†ç»„
     */
    public List<Object[]> getOrderStatistics(Date startDate, Date endDate, 
                                             String status, boolean groupByUser) {
        StringBuilder hql = new StringBuilder();
        hql.append("SELECT ");
        
        // åŠ¨æ€é€‰æ‹©å­—æ®µ
        if (groupByUser) {
            hql.append("o.user.username, ");
        }
        hql.append("COUNT(o.id), SUM(o.totalAmount) ");
        hql.append("FROM Order o WHERE 1=1");
        
        Map<String, Object> params = new HashMap<>();
        
        // åŠ¨æ€æ·»åŠ æ—¥æœŸèŒƒå›´
        if (startDate != null) {
            hql.append(" AND o.createTime >= :startDate");
            params.put("startDate", startDate);
        }
        
        if (endDate != null) {
            hql.append(" AND o.createTime <= :endDate");
            params.put("endDate", endDate);
        }
        
        // åŠ¨æ€æ·»åŠ çŠ¶æ€æ¡ä»¶
        if (status != null && !status.isEmpty()) {
            hql.append(" AND o.status = :status");
            params.put("status", status);
        }
        
        // åŠ¨æ€åˆ†ç»„
        if (groupByUser) {
            hql.append(" GROUP BY o.user.username");
        }
        
        Query query = session.createQuery(hql.toString());
        params.forEach(query::setParameter);
        
        return query.getResultList();
    }
}
```

---

## 6. ğŸ” åŠ¨æ€Criteriaæ„å»º


### 6.1 Criteria APIåŸºç¡€å›é¡¾


**Criteria APIæ ¸å¿ƒç»„ä»¶**ï¼š
```
CriteriaBuilder  = æ„å»ºå™¨å·¥å‚ï¼ˆç”Ÿäº§å„ç§æ¡ä»¶ï¼‰
CriteriaQuery    = æŸ¥è¯¢å¯¹è±¡ï¼ˆæ•´ä½“æŸ¥è¯¢ç»“æ„ï¼‰
Root             = æŸ¥è¯¢æ ¹ï¼ˆFROMçš„è¡¨ï¼‰
Predicate        = æ¡ä»¶è°“è¯ï¼ˆWHEREçš„æ¡ä»¶ï¼‰

å…³ç³»ç¤ºæ„ï¼š
CriteriaBuilder
    â†“ åˆ›å»º
CriteriaQuery<T>
    â†“ æŒ‡å®šFROM
Root<T>
    â†“ æ„å»ºæ¡ä»¶
Predicate[]
    â†“ åº”ç”¨æ¡ä»¶
æœ€ç»ˆæŸ¥è¯¢
```

### 6.2 åŸºç¡€åŠ¨æ€Criteriaç¤ºä¾‹


```java
public List<Product> criteriaSearch(String name, Double minPrice, 
                                    Double maxPrice, List<String> brands) {
    CriteriaBuilder cb = session.getCriteriaBuilder();
    CriteriaQuery<Product> query = cb.createQuery(Product.class);
    Root<Product> root = query.from(Product.class);
    
    List<Predicate> predicates = new ArrayList<>();
    
    // åç§°æ¨¡ç³ŠæŸ¥è¯¢
    if (name != null && !name.isEmpty()) {
        Predicate namePredicate = cb.like(root.get("name"), "%" + name + "%");
        predicates.add(namePredicate);
    }
    
    // ä»·æ ¼åŒºé—´æŸ¥è¯¢
    if (minPrice != null && maxPrice != null) {
        Predicate pricePredicate = cb.between(root.get("price"), minPrice, maxPrice);
        predicates.add(pricePredicate);
    } else if (minPrice != null) {
        predicates.add(cb.ge(root.get("price"), minPrice));
    } else if (maxPrice != null) {
        predicates.add(cb.le(root.get("price"), maxPrice));
    }
    
    // å“ç‰ŒINæŸ¥è¯¢
    if (brands != null && !brands.isEmpty()) {
        Predicate brandPredicate = root.get("brand").in(brands);
        predicates.add(brandPredicate);
    }
    
    // ç»„åˆæ‰€æœ‰æ¡ä»¶
    query.where(cb.and(predicates.toArray(new Predicate[0])));
    
    return session.createQuery(query).getResultList();
}
```

### 6.3 CriteriaåŠ¨æ€å…³è”æŸ¥è¯¢


**åœºæ™¯**ï¼šæ ¹æ®è®¢å•ä¿¡æ¯æŸ¥è¯¢ç”¨æˆ·ï¼Œæ¡ä»¶å¯èƒ½åŒ…å«è®¢å•çŠ¶æ€ã€ç”¨æˆ·ä¿¡æ¯ç­‰

```java
public List<User> findUsersByOrderCriteria(String userName, String orderStatus, 
                                           Double minOrderAmount) {
    CriteriaBuilder cb = session.getCriteriaBuilder();
    CriteriaQuery<User> query = cb.createQuery(User.class);
    Root<User> userRoot = query.from(User.class);
    
    // å…³è”è®¢å•è¡¨
    Join<User, Order> orderJoin = userRoot.join("orders", JoinType.LEFT);
    
    List<Predicate> predicates = new ArrayList<>();
    
    // ç”¨æˆ·åæ¡ä»¶
    if (userName != null && !userName.isEmpty()) {
        predicates.add(cb.like(userRoot.get("username"), "%" + userName + "%"));
    }
    
    // è®¢å•çŠ¶æ€æ¡ä»¶
    if (orderStatus != null && !orderStatus.isEmpty()) {
        predicates.add(cb.equal(orderJoin.get("status"), orderStatus));
    }
    
    // è®¢å•é‡‘é¢æ¡ä»¶
    if (minOrderAmount != null) {
        predicates.add(cb.ge(orderJoin.get("totalAmount"), minOrderAmount));
    }
    
    query.where(cb.and(predicates.toArray(new Predicate[0])));
    query.distinct(true);  // å»é‡
    
    return session.createQuery(query).getResultList();
}
```

### 6.4 Criteriaåˆ†é¡µä¸æ’åº


```java
public class CriteriaPageBuilder<T> {
    
    public PageResult<T> getPage(Session session, Class<T> entityClass,
                                 List<Predicate> predicates, 
                                 int pageNum, int pageSize,
                                 String sortField, boolean ascending) {
        CriteriaBuilder cb = session.getCriteriaBuilder();
        
        // æŸ¥è¯¢æ€»æ•°
        CriteriaQuery<Long> countQuery = cb.createQuery(Long.class);
        Root<T> countRoot = countQuery.from(entityClass);
        countQuery.select(cb.count(countRoot));
        countQuery.where(predicates.toArray(new Predicate[0]));
        Long total = session.createQuery(countQuery).getSingleResult();
        
        // æŸ¥è¯¢æ•°æ®
        CriteriaQuery<T> dataQuery = cb.createQuery(entityClass);
        Root<T> dataRoot = dataQuery.from(entityClass);
        dataQuery.where(predicates.toArray(new Predicate[0]));
        
        // åŠ¨æ€æ’åº
        if (sortField != null && !sortField.isEmpty()) {
            if (ascending) {
                dataQuery.orderBy(cb.asc(dataRoot.get(sortField)));
            } else {
                dataQuery.orderBy(cb.desc(dataRoot.get(sortField)));
            }
        }
        
        List<T> data = session.createQuery(dataQuery)
                .setFirstResult((pageNum - 1) * pageSize)
                .setMaxResults(pageSize)
                .getResultList();
        
        return new PageResult<>(data, total, pageNum, pageSize);
    }
}

// åˆ†é¡µç»“æœå°è£…
class PageResult<T> {
    private List<T> data;
    private long total;
    private int pageNum;
    private int pageSize;
    
    // æ„é€ å™¨ã€getterçœç•¥...
}
```

---

## 7. ğŸ’¡ æœ€ä½³å®è·µä¸æ€»ç»“


### 7.1 æŠ€æœ¯é€‰æ‹©æŒ‡å—


**å„ç§æ–¹å¼å¯¹æ¯”**ï¼š

| æŠ€æœ¯æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|----------|
| **HQLå­—ç¬¦ä¸²æ‹¼æ¥** | ç®€å•ç›´è§‚ï¼Œå­¦ä¹ æˆæœ¬ä½ | å®¹æ˜“å‡ºé”™ï¼ŒSQLæ³¨å…¥é£é™© | ç®€å•æŸ¥è¯¢ï¼Œæ¡ä»¶å°‘ |
| **Criteria API** | ç±»å‹å®‰å…¨ï¼Œä¸ä¼šSQLæ³¨å…¥ | ä»£ç ç¨å¤æ‚ï¼Œå­¦ä¹ æ›²çº¿é™¡ | å¤æ‚åŠ¨æ€æŸ¥è¯¢ |
| **QueryBuilder** | é“¾å¼è°ƒç”¨æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤ | éœ€è¦é¢å¤–ç¼–å†™ | é¡¹ç›®é€šç”¨æŸ¥è¯¢ |
| **Specification** | Spring Dataæ”¯æŒå¥½ | ä¾èµ–Springæ¡†æ¶ | Springé¡¹ç›® |

### 7.2 åŠ¨æ€æŸ¥è¯¢æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**ï¼š

1. **å‚æ•°æ ¡éªŒåœ¨å‰**
```java
public List<Product> search(ProductQuery query) {
    // å…ˆæ ¡éªŒå‚æ•°
    if (query == null) {
        return Collections.emptyList();
    }
    
    // å†æ„å»ºæŸ¥è¯¢
    CriteriaBuilder cb = session.getCriteriaBuilder();
    // ...
}
```

2. **ä½¿ç”¨å‚æ•°å¯¹è±¡**
```java
// ä¸æ¨èï¼šå‚æ•°å¤ªå¤š
public List<Product> search(String name, Double minPrice, Double maxPrice, 
                            String brand, Integer categoryId, String sortBy) {
    // ...
}

// æ¨èï¼šä½¿ç”¨å‚æ•°å¯¹è±¡
public class ProductSearchParam {
    private String name;
    private Double minPrice;
    private Double maxPrice;
    private String brand;
    private Integer categoryId;
    private String sortBy;
    // getter/setter...
}

public List<Product> search(ProductSearchParam param) {
    // æ¸…æ™°å¤šäº†
}
```

3. **æ¡ä»¶å°è£…å¤ç”¨**
```java
public class PredicateFactory {
    
    public static Predicate nameLike(CriteriaBuilder cb, Root<?> root, 
                                     String fieldName, String value) {
        if (value != null && !value.isEmpty()) {
            return cb.like(root.get(fieldName), "%" + value + "%");
        }
        return null;
    }
    
    public static Predicate between(CriteriaBuilder cb, Root<?> root,
                                    String fieldName, Comparable min, Comparable max) {
        if (min != null && max != null) {
            return cb.between(root.get(fieldName), min, max);
        }
        // ...
        return null;
    }
}
```

4. **ç»Ÿä¸€å¼‚å¸¸å¤„ç†**
```java
public List<Product> search(ProductSearchParam param) {
    try {
        CriteriaBuilder cb = session.getCriteriaBuilder();
        // æ„å»ºæŸ¥è¯¢...
        return session.createQuery(query).getResultList();
    } catch (IllegalArgumentException e) {
        log.error("æŸ¥è¯¢å‚æ•°é”™è¯¯: {}", e.getMessage());
        throw new BusinessException("æŸ¥è¯¢å‚æ•°ä¸æ­£ç¡®");
    } catch (Exception e) {
        log.error("æŸ¥è¯¢å¤±è´¥", e);
        throw new BusinessException("æŸ¥è¯¢å¤±è´¥,è¯·ç¨åé‡è¯•");
    }
}
```

### 7.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**å…³é”®ä¼˜åŒ–ç‚¹**ï¼š

```
ğŸ”¸ é¿å…N+1æŸ¥è¯¢é—®é¢˜
ä½¿ç”¨JOIN FETCHé¢„åŠ è½½å…³è”æ•°æ®
ä¸è¦åœ¨å¾ªç¯ä¸­æ‰§è¡ŒæŸ¥è¯¢

ğŸ”¸ åˆç†ä½¿ç”¨ç´¢å¼•
ç¡®ä¿WHEREæ¡ä»¶å­—æ®µæœ‰ç´¢å¼•
é¿å…åœ¨ç´¢å¼•å­—æ®µä¸Šä½¿ç”¨å‡½æ•°

ğŸ”¸ é™åˆ¶ç»“æœé›†å¤§å°
å¿…è¦æ—¶æ·»åŠ åˆ†é¡µ
é¿å…SELECT *ï¼ŒåªæŸ¥éœ€è¦çš„å­—æ®µ

ğŸ”¸ ç¼“å­˜æŸ¥è¯¢ç»“æœ
å¯¹ä¸å¸¸å˜åŒ–çš„æ•°æ®å¯ç”¨æŸ¥è¯¢ç¼“å­˜
åˆç†è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´
```

**å…·ä½“ç¤ºä¾‹**ï¼š
```java
// âŒ N+1é—®é¢˜
List<Order> orders = session.createQuery("FROM Order", Order.class).list();
for (Order order : orders) {
    order.getUser().getUsername();  // æ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“
}

// âœ… ä½¿ç”¨JOIN FETCH
List<Order> orders = session.createQuery(
    "FROM Order o JOIN FETCH o.user", Order.class
).list();
for (Order order : orders) {
    order.getUser().getUsername();  // ä¸ä¼šå†æŸ¥è¯¢æ•°æ®åº“
}
```

### 7.4 æ ¸å¿ƒè¦ç‚¹æ€»ç»“


**å¿…é¡»æŒæ¡çš„æ¦‚å¿µ**ï¼š
```
ğŸ¯ åŠ¨æ€æŸ¥è¯¢æœ¬è´¨ï¼šæ ¹æ®è¿è¡Œæ—¶æ¡ä»¶çµæ´»æ„å»ºæŸ¥è¯¢
ğŸ¯ æ ¸å¿ƒä»·å€¼ï¼šä¸€ä¸ªæ–¹æ³•åº”å¯¹å¤šç§æŸ¥è¯¢åœºæ™¯
ğŸ¯ å®‰å…¨ç¬¬ä¸€ï¼šå¿…é¡»ä½¿ç”¨å‚æ•°ç»‘å®šé˜²æ­¢SQLæ³¨å…¥
ğŸ¯ ç±»å‹å®‰å…¨ï¼šä¼˜å…ˆä½¿ç”¨Criteria APIè€Œéå­—ç¬¦ä¸²æ‹¼æ¥
```

**æŠ€æœ¯è¦ç‚¹**ï¼š
```
1ï¸âƒ£ æ¡ä»¶ç»„è£…ï¼šä½¿ç”¨List<Predicate>æ”¶é›†æ¡ä»¶
2ï¸âƒ£ å‚æ•°ç»‘å®šï¼šå‘½åå‚æ•°ä¼˜äºä½ç½®å‚æ•°
3ï¸âƒ£ QueryBuilderï¼šé“¾å¼è°ƒç”¨æå‡å¯è¯»æ€§
4ï¸âƒ£ ä»£ç å¤ç”¨ï¼šå°è£…å¸¸ç”¨æ¡ä»¶ä¸ºå·¥å…·æ–¹æ³•
```

**å®æˆ˜å»ºè®®**ï¼š
```
âœ… ç®€å•æŸ¥è¯¢ï¼šHQL + å‚æ•°ç»‘å®š
âœ… å¤æ‚æŸ¥è¯¢ï¼šCriteria API
âœ… é€šç”¨æŸ¥è¯¢ï¼šè‡ªå®šä¹‰QueryBuilder
âœ… å‚æ•°ä¼ é€’ï¼šä½¿ç”¨å‚æ•°å¯¹è±¡è€Œéæ•£å‚æ•°
âœ… æ€§èƒ½ä¼˜åŒ–ï¼šJOIN FETCH + åˆ†é¡µ + ç´¢å¼•
```

**ğŸ§  è®°å¿†å£è¯€**ï¼š
```
åŠ¨æ€æŸ¥è¯¢çµæ´»å˜ï¼Œæ¡ä»¶å‚æ•°è¦åˆ†å¼€
Criteriaç±»å‹å®‰å…¨å¥½ï¼ŒBuilderé“¾å¼æ›´æ¸…æ™°
å‚æ•°ç»‘å®šé˜²æ³¨å…¥ï¼Œæ€§èƒ½ä¼˜åŒ–åˆ«å¿˜è®°
```