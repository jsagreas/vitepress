---
title: 67ã€è‡ªå®šä¹‰éªŒè¯å™¨å®ç°
---
## ğŸ“š ç›®å½•

1. [è‡ªå®šä¹‰éªŒè¯å™¨æ¦‚è¿°](#1-è‡ªå®šä¹‰éªŒè¯å™¨æ¦‚è¿°)
2. [ConstraintValidatoræ¥å£è¯¦è§£](#2-ConstraintValidatoræ¥å£è¯¦è§£)
3. [è‡ªå®šä¹‰éªŒè¯æ³¨è§£](#3-è‡ªå®šä¹‰éªŒè¯æ³¨è§£)
4. [å¤åˆéªŒè¯å™¨](#4-å¤åˆéªŒè¯å™¨)
5. [æ¡ä»¶éªŒè¯](#5-æ¡ä»¶éªŒè¯)
6. [è·¨å­—æ®µéªŒè¯](#6-è·¨å­—æ®µéªŒè¯)
7. [æ•°æ®åº“éªŒè¯](#7-æ•°æ®åº“éªŒè¯)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è‡ªå®šä¹‰éªŒè¯å™¨æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰éªŒè¯å™¨


**å®é™…åœºæ™¯ç†è§£**ï¼š
```
å†…ç½®éªŒè¯å™¨çš„å±€é™ï¼š
âŒ @NotNullã€@Size åªèƒ½éªŒè¯åŸºæœ¬è§„åˆ™
âŒ ä¸šåŠ¡è§„åˆ™å¤æ‚ï¼šæ‰‹æœºå·æ ¼å¼ã€èº«ä»½è¯æ ¡éªŒã€ç‰¹å®šä¸šåŠ¡é€»è¾‘
âŒ æ— æ³•æ»¡è¶³ä¼ä¸šçº§åº”ç”¨çš„ä¸ªæ€§åŒ–éœ€æ±‚

è‡ªå®šä¹‰éªŒè¯å™¨çš„ä»·å€¼ï¼š
âœ… å°è£…å¤æ‚çš„ä¸šåŠ¡éªŒè¯é€»è¾‘
âœ… è®©éªŒè¯è§„åˆ™å¯å¤ç”¨
âœ… ä»£ç æ›´æ¸…æ™°ï¼ŒéªŒè¯é€»è¾‘é›†ä¸­ç®¡ç†
```

**é€šä¿—ç±»æ¯”**ï¼š
```
å†…ç½®éªŒè¯å™¨ = æ ‡å‡†åŒ–å·¥å…·
- å°±åƒèºä¸åˆ€ã€æ‰³æ‰‹ï¼Œé€‚åˆå¸¸è§„åœºæ™¯

è‡ªå®šä¹‰éªŒè¯å™¨ = å®šåˆ¶åŒ–å·¥å…·  
- å°±åƒä¸ºç‰¹æ®Šé›¶ä»¶å®šåˆ¶çš„ä¸“ç”¨å·¥å…·
- è§£å†³ç‰¹å®šä¸šåŠ¡åœºæ™¯çš„éªŒè¯éœ€æ±‚
```

### 1.2 è‡ªå®šä¹‰éªŒè¯å™¨çš„å·¥ä½œåŸç†


**æ ¸å¿ƒæœºåˆ¶**ï¼š
```
éªŒè¯æµç¨‹ï¼š
                 
ç”¨æˆ·æäº¤æ•°æ®
    â†“
è§¦å‘éªŒè¯æ³¨è§£ï¼ˆå¦‚ @PhoneNumberï¼‰
    â†“
è°ƒç”¨å¯¹åº”çš„éªŒè¯å™¨ï¼ˆPhoneValidatorï¼‰
    â†“
æ‰§è¡Œè‡ªå®šä¹‰éªŒè¯é€»è¾‘
    â†“
è¿”å›éªŒè¯ç»“æœï¼ˆtrue/falseï¼‰
    â†“
é€šè¿‡/å¤±è´¥ + é”™è¯¯æ¶ˆæ¯
```

**ç»„æˆéƒ¨åˆ†**ï¼š
- **éªŒè¯æ³¨è§£**ï¼šå®šä¹‰éªŒè¯è§„åˆ™çš„"æ ‡ç­¾"ï¼ˆå¦‚ `@PhoneNumber`ï¼‰
- **éªŒè¯å™¨ç±»**ï¼šå®ç°å…·ä½“éªŒè¯é€»è¾‘çš„"æ‰§è¡Œå™¨"
- **é”™è¯¯æ¶ˆæ¯**ï¼šéªŒè¯å¤±è´¥æ—¶çš„æç¤ºä¿¡æ¯

---

## 2. ğŸ”§ ConstraintValidatoræ¥å£è¯¦è§£


### 2.1 æ¥å£æ ¸å¿ƒç»“æ„


**æ¥å£å®šä¹‰**ï¼š
```java
public interface ConstraintValidator<A extends Annotation, T> {
    
    // åˆå§‹åŒ–æ–¹æ³•ï¼šè·å–æ³¨è§£çš„é…ç½®ä¿¡æ¯
    void initialize(A constraintAnnotation);
    
    // éªŒè¯æ–¹æ³•ï¼šæ ¸å¿ƒéªŒè¯é€»è¾‘
    boolean isValid(T value, ConstraintValidatorContext context);
}
```

**æ³›å‹å‚æ•°è§£è¯»**ï¼š
```
A extends Annotationï¼šéªŒè¯æ³¨è§£ç±»å‹
- ä¾‹å¦‚ï¼š@PhoneNumber æ³¨è§£

Tï¼šè¢«éªŒè¯çš„æ•°æ®ç±»å‹
- ä¾‹å¦‚ï¼šStringï¼ˆæ‰‹æœºå·å­—ç¬¦ä¸²ï¼‰
- å¯ä»¥æ˜¯ä»»ä½•ç±»å‹ï¼šIntegerã€Dateã€è‡ªå®šä¹‰ç±»ç­‰
```

### 2.2 initializeæ–¹æ³•è¯¦è§£


**æ–¹æ³•ä½œç”¨**ï¼šåœ¨éªŒè¯å™¨åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼Œè·å–æ³¨è§£ä¸­çš„é…ç½®å‚æ•°

```java
// ç¤ºä¾‹ï¼šå¸¦å‚æ•°çš„éªŒè¯æ³¨è§£
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = LengthValidator.class)
public @interface Length {
    int min() default 0;
    int max() default Integer.MAX_VALUE;
    String message() default "é•¿åº¦ä¸ç¬¦åˆè¦æ±‚";
    // ...å…¶ä»–å¿…éœ€æ–¹æ³•
}

// éªŒè¯å™¨å®ç°
public class LengthValidator implements ConstraintValidator<Length, String> {
    
    private int min;
    private int max;
    
    @Override
    public void initialize(Length annotation) {
        // ä»æ³¨è§£ä¸­è·å–é…ç½®çš„æœ€å°å€¼å’Œæœ€å¤§å€¼
        this.min = annotation.min();
        this.max = annotation.max();
    }
    
    @Override
    public boolean isValid(String value, ConstraintValidatorContext context) {
        if (value == null) return true;  // nullå€¼äº¤ç»™@NotNullå¤„ç†
        int length = value.length();
        return length >= min && length <= max;
    }
}
```

**å…³é”®ç†è§£**ï¼š
- `initialize` åªæ‰§è¡Œä¸€æ¬¡ï¼Œåœ¨éªŒè¯å™¨åˆ›å»ºæ—¶
- ç”¨äºè¯»å–æ³¨è§£é…ç½®ï¼Œå‡†å¤‡éªŒè¯æ‰€éœ€çš„å‚æ•°
- ä¸è¦åœ¨è¿™é‡ŒåšéªŒè¯é€»è¾‘

### 2.3 isValidæ–¹æ³•è¯¦è§£


**æ–¹æ³•ä½œç”¨**ï¼šæ¯æ¬¡éªŒè¯æ—¶è°ƒç”¨ï¼Œæ‰§è¡Œå®é™…çš„éªŒè¯é€»è¾‘

```java
@Override
public boolean isValid(String value, ConstraintValidatorContext context) {
    // å‚æ•°è¯´æ˜ï¼š
    // value: è¢«éªŒè¯çš„å­—æ®µå€¼
    // context: éªŒè¯ä¸Šä¸‹æ–‡ï¼Œå¯ç”¨äºè‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯
    
    // è¿”å›å€¼ï¼š
    // true: éªŒè¯é€šè¿‡
    // false: éªŒè¯å¤±è´¥
}
```

**å¤„ç†nullå€¼çš„çº¦å®š**ï¼š
```java
@Override
public boolean isValid(String value, ConstraintValidatorContext context) {
    // âœ… æ¨èåšæ³•ï¼šnullå€¼è¿”å›true
    if (value == null) {
        return true;  // nullå€¼äº¤ç»™ @NotNull æ³¨è§£å¤„ç†
    }
    
    // çœŸæ­£çš„éªŒè¯é€»è¾‘
    return value.matches("^1[3-9]\\d{9}$");
}
```

**ä¸ºä»€ä¹ˆnullè¿”å›true**ï¼š
- èŒè´£åˆ†ç¦»ï¼šnullæ£€æŸ¥ç”± `@NotNull` ä¸“é—¨å¤„ç†
- çµæ´»æ€§ï¼šå­—æ®µå¯ä»¥é€‰æ‹©æ€§åœ°æ ‡è®° `@NotNull`
- é¿å…é‡å¤éªŒè¯

---

## 3. ğŸ“ è‡ªå®šä¹‰éªŒè¯æ³¨è§£


### 3.1 å®Œæ•´çš„æ‰‹æœºå·éªŒè¯å™¨ç¤ºä¾‹


**æ­¥éª¤1ï¼šå®šä¹‰éªŒè¯æ³¨è§£**

```java
import javax.validation.Constraint;
import javax.validation.Payload;
import java.lang.annotation.*;

@Target({ElementType.FIELD, ElementType.PARAMETER})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = PhoneValidator.class)  // æŒ‡å®šéªŒè¯å™¨
@Documented
public @interface PhoneNumber {
    
    // å¿…éœ€çš„ä¸‰ä¸ªæ–¹æ³•
    String message() default "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®";
    
    Class<?>[] groups() default {};
    
    Class<? extends Payload>[] payload() default {};
    
    // å¯é€‰ï¼šè‡ªå®šä¹‰é…ç½®å‚æ•°
    boolean strict() default true;  // æ˜¯å¦ä¸¥æ ¼æ¨¡å¼
}
```

**æ³¨è§£å…ƒç´ è§£é‡Š**ï¼š

| å…ƒç´  | ä½œç”¨ | æ˜¯å¦å¿…éœ€ |
|------|------|---------|
| `message()` | éªŒè¯å¤±è´¥æ—¶çš„é”™è¯¯æ¶ˆæ¯ | âœ… å¿…éœ€ |
| `groups()` | éªŒè¯åˆ†ç»„ï¼ˆåç»­ç« èŠ‚è¯¦è§£ï¼‰ | âœ… å¿…éœ€ |
| `payload()` | é™„åŠ å…ƒæ•°æ® | âœ… å¿…éœ€ |
| è‡ªå®šä¹‰å‚æ•° | å¦‚ `strict()` æ§åˆ¶éªŒè¯ä¸¥æ ¼ç¨‹åº¦ | âŒ å¯é€‰ |

**æ­¥éª¤2ï¼šå®ç°éªŒè¯å™¨**

```java
import javax.validation.ConstraintValidator;
import javax.validation.ConstraintValidatorContext;
import java.util.regex.Pattern;

public class PhoneValidator implements ConstraintValidator<PhoneNumber, String> {
    
    private boolean strict;
    
    // ä¸¥æ ¼æ¨¡å¼ï¼šå¿…é¡»1å¼€å¤´ + ç¬¬äºŒä½3-9 + åé¢9ä½æ•°å­—
    private static final Pattern STRICT_PATTERN = 
        Pattern.compile("^1[3-9]\\d{9}$");
    
    // å®½æ¾æ¨¡å¼ï¼š11ä½æ•°å­—å³å¯
    private static final Pattern LOOSE_PATTERN = 
        Pattern.compile("^\\d{11}$");
    
    @Override
    public void initialize(PhoneNumber annotation) {
        this.strict = annotation.strict();
    }
    
    @Override
    public boolean isValid(String value, ConstraintValidatorContext context) {
        if (value == null) {
            return true;  // nulläº¤ç»™@NotNullå¤„ç†
        }
        
        Pattern pattern = strict ? STRICT_PATTERN : LOOSE_PATTERN;
        return pattern.matcher(value).matches();
    }
}
```

**æ­¥éª¤3ï¼šä½¿ç”¨éªŒè¯å™¨**

```java
public class User {
    
    @PhoneNumber  // é»˜è®¤ä¸¥æ ¼æ¨¡å¼
    private String mobile;
    
    @PhoneNumber(strict = false)  // å®½æ¾æ¨¡å¼
    private String backupPhone;
    
    @PhoneNumber(message = "è”ç³»ç”µè¯æ ¼å¼é”™è¯¯")  // è‡ªå®šä¹‰æ¶ˆæ¯
    private String contactPhone;
}
```

### 3.2 èº«ä»½è¯éªŒè¯å™¨ç¤ºä¾‹


```java
// éªŒè¯æ³¨è§£
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = IdCardValidator.class)
public @interface IdCard {
    String message() default "èº«ä»½è¯å·æ ¼å¼ä¸æ­£ç¡®";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}

// éªŒè¯å™¨å®ç°
public class IdCardValidator implements ConstraintValidator<IdCard, String> {
    
    @Override
    public boolean isValid(String idCard, ConstraintValidatorContext context) {
        if (idCard == null) return true;
        
        // 18ä½èº«ä»½è¯åŸºæœ¬æ ¼å¼æ£€æŸ¥
        if (!idCard.matches("^\\d{17}[0-9Xx]$")) {
            return false;
        }
        
        // æ ¡éªŒç éªŒè¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
        return validateChecksum(idCard);
    }
    
    private boolean validateChecksum(String idCard) {
        // æƒé‡å› å­
        int[] weights = {7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2};
        char[] checkCodes = {'1','0','X','9','8','7','6','5','4','3','2'};
        
        int sum = 0;
        for (int i = 0; i < 17; i++) {
            sum += (idCard.charAt(i) - '0') * weights[i];
        }
        
        char checkCode = checkCodes[sum % 11];
        return checkCode == Character.toUpperCase(idCard.charAt(17));
    }
}
```

---

## 4. ğŸ”„ å¤åˆéªŒè¯å™¨


### 4.1 å¤åˆéªŒè¯å™¨æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯å¤åˆéªŒè¯å™¨**ï¼š
```
å¤åˆéªŒè¯å™¨ = å¤šä¸ªéªŒè¯è§„åˆ™çš„ç»„åˆ

å•ä¸€éªŒè¯å™¨ï¼š
@PhoneNumber  // åªéªŒè¯æ‰‹æœºå·æ ¼å¼

å¤åˆéªŒè¯å™¨ï¼š
@ValidContact  // åŒæ—¶éªŒè¯å¤šé¡¹è§„åˆ™
- æ‰‹æœºå·æ ¼å¼æ­£ç¡®
- é‚®ç®±æ ¼å¼æ­£ç¡®
- è‡³å°‘å¡«å†™ä¸€é¡¹è”ç³»æ–¹å¼
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- å¤šä¸ªéªŒè¯è§„åˆ™ç»å¸¸åŒæ—¶ä½¿ç”¨
- ä¸šåŠ¡è§„åˆ™éœ€è¦ç»„åˆéªŒè¯
- å‡å°‘é‡å¤çš„æ³¨è§£å£°æ˜

### 4.2 ç»„åˆæ³¨è§£å®ç°


```java
// å®šä¹‰ç»„åˆæ³¨è§£
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = ContactValidator.class)
@NotNull(message = "è”ç³»ä¿¡æ¯ä¸èƒ½ä¸ºç©º")
@Size(min = 1, message = "è‡³å°‘éœ€è¦ä¸€ç§è”ç³»æ–¹å¼")
public @interface ValidContact {
    String message() default "è”ç³»ä¿¡æ¯éªŒè¯å¤±è´¥";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}

// è”ç³»ä¿¡æ¯ç±»
public class ContactInfo {
    @PhoneNumber
    private String phone;
    
    @Email
    private String email;
    
    private String wechat;
}

// ç»„åˆéªŒè¯å™¨
public class ContactValidator 
    implements ConstraintValidator<ValidContact, ContactInfo> {
    
    @Override
    public boolean isValid(ContactInfo contact, ConstraintValidatorContext context) {
        if (contact == null) return true;
        
        // è‡³å°‘æœ‰ä¸€é¡¹è”ç³»æ–¹å¼ä¸ä¸ºç©º
        boolean hasPhone = contact.getPhone() != null && !contact.getPhone().isEmpty();
        boolean hasEmail = contact.getEmail() != null && !contact.getEmail().isEmpty();
        boolean hasWechat = contact.getWechat() != null && !contact.getWechat().isEmpty();
        
        if (!hasPhone && !hasEmail && !hasWechat) {
            // è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯
            context.disableDefaultConstraintViolation();
            context.buildConstraintViolationWithTemplate(
                "è‡³å°‘éœ€è¦æä¾›ä¸€ç§è”ç³»æ–¹å¼ï¼ˆæ‰‹æœºã€é‚®ç®±æˆ–å¾®ä¿¡ï¼‰"
            ).addConstraintViolation();
            return false;
        }
        
        return true;
    }
}
```

### 4.3 ä½¿ç”¨å¤åˆéªŒè¯å™¨


```java
public class UserRegistration {
    
    @NotBlank
    private String username;
    
    @ValidContact  // ä¸€ä¸ªæ³¨è§£å®Œæˆå¤šé¡¹éªŒè¯
    private ContactInfo contact;
}
```

---

## 5. âš¡ æ¡ä»¶éªŒè¯


### 5.1 æ¡ä»¶éªŒè¯çš„åœºæ™¯


**ä»€ä¹ˆæ˜¯æ¡ä»¶éªŒè¯**ï¼š
```
æ ¹æ®æŸä¸ªå­—æ®µçš„å€¼ï¼Œå†³å®šæ˜¯å¦éªŒè¯å…¶ä»–å­—æ®µ

åœºæ™¯ç¤ºä¾‹ï¼š
å¦‚æœç”¨æˆ·ç±»å‹ = "ä¸ªäºº"
    â†’ å¿…é¡»å¡«å†™èº«ä»½è¯å·
å¦‚æœç”¨æˆ·ç±»å‹ = "ä¼ä¸š"  
    â†’ å¿…é¡»å¡«å†™è¥ä¸šæ‰§ç…§å·
```

### 5.2 åŸºäºå­—æ®µå€¼çš„æ¡ä»¶éªŒè¯


```java
// æ¡ä»¶éªŒè¯æ³¨è§£
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = ConditionalValidator.class)
public @interface ConditionalValidation {
    String message() default "æ¡ä»¶éªŒè¯å¤±è´¥";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
    
    String conditionField();      // æ¡ä»¶å­—æ®µå
    String conditionValue();      // æ¡ä»¶å€¼
    String targetField();         // ç›®æ ‡éªŒè¯å­—æ®µå
}

// å®ä½“ç±»
public class UserInfo {
    
    private String userType;  // "PERSONAL" æˆ– "COMPANY"
    
    private String idCard;          // èº«ä»½è¯å·
    private String businessLicense; // è¥ä¸šæ‰§ç…§å·
}

// æ¡ä»¶éªŒè¯å™¨
public class ConditionalValidator 
    implements ConstraintValidator<ConditionalValidation, Object> {
    
    private String conditionField;
    private String conditionValue;
    private String targetField;
    
    @Override
    public void initialize(ConditionalValidation annotation) {
        this.conditionField = annotation.conditionField();
        this.conditionValue = annotation.conditionValue();
        this.targetField = annotation.targetField();
    }
    
    @Override
    public boolean isValid(Object obj, ConstraintValidatorContext context) {
        try {
            // ä½¿ç”¨åå°„è·å–å­—æ®µå€¼
            Object conditionFieldValue = getFieldValue(obj, conditionField);
            Object targetFieldValue = getFieldValue(obj, targetField);
            
            // å¦‚æœæ¡ä»¶åŒ¹é…ï¼ŒéªŒè¯ç›®æ ‡å­—æ®µä¸èƒ½ä¸ºç©º
            if (conditionValue.equals(conditionFieldValue)) {
                if (targetFieldValue == null || 
                    targetFieldValue.toString().isEmpty()) {
                    return false;
                }
            }
            
            return true;
        } catch (Exception e) {
            return false;
        }
    }
    
    private Object getFieldValue(Object obj, String fieldName) throws Exception {
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        return field.get(obj);
    }
}
```

### 5.3 å®é™…åº”ç”¨ç¤ºä¾‹


```java
@ConditionalValidation(
    conditionField = "userType",
    conditionValue = "PERSONAL",
    targetField = "idCard",
    message = "ä¸ªäººç”¨æˆ·å¿…é¡»å¡«å†™èº«ä»½è¯å·"
)
@ConditionalValidation(
    conditionField = "userType", 
    conditionValue = "COMPANY",
    targetField = "businessLicense",
    message = "ä¼ä¸šç”¨æˆ·å¿…é¡»å¡«å†™è¥ä¸šæ‰§ç…§å·"
)
public class UserRegistration {
    
    @NotBlank
    private String userType;
    
    private String idCard;
    private String businessLicense;
}
```

---

## 6. ğŸ”— è·¨å­—æ®µéªŒè¯


### 6.1 è·¨å­—æ®µéªŒè¯æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯è·¨å­—æ®µéªŒè¯**ï¼š
```
éªŒè¯è§„åˆ™æ¶‰åŠå¤šä¸ªå­—æ®µä¹‹é—´çš„å…³ç³»

å¸¸è§åœºæ™¯ï¼š
âœ… å¯†ç å’Œç¡®è®¤å¯†ç å¿…é¡»ä¸€è‡´
âœ… å¼€å§‹æ—¥æœŸå¿…é¡»æ—©äºç»“æŸæ—¥æœŸ
âœ… æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼
```

### 6.2 å¯†ç ç¡®è®¤éªŒè¯ç¤ºä¾‹


```java
// è·¨å­—æ®µéªŒè¯æ³¨è§£
@Target(ElementType.TYPE)  // æ³¨æ„ï¼šä½œç”¨åœ¨ç±»ä¸Š
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = PasswordMatchValidator.class)
public @interface PasswordMatch {
    String message() default "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
    
    String password();         // å¯†ç å­—æ®µå
    String confirmPassword();  // ç¡®è®¤å¯†ç å­—æ®µå
}

// éªŒè¯å™¨å®ç°
public class PasswordMatchValidator 
    implements ConstraintValidator<PasswordMatch, Object> {
    
    private String passwordField;
    private String confirmPasswordField;
    
    @Override
    public void initialize(PasswordMatch annotation) {
        this.passwordField = annotation.password();
        this.confirmPasswordField = annotation.confirmPassword();
    }
    
    @Override
    public boolean isValid(Object obj, ConstraintValidatorContext context) {
        try {
            Object password = getFieldValue(obj, passwordField);
            Object confirmPassword = getFieldValue(obj, confirmPasswordField);
            
            if (password == null && confirmPassword == null) {
                return true;
            }
            
            boolean isValid = password != null && password.equals(confirmPassword);
            
            if (!isValid) {
                // è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ä½ç½®
                context.disableDefaultConstraintViolation();
                context.buildConstraintViolationWithTemplate(context.getDefaultConstraintMessageTemplate())
                       .addPropertyNode(confirmPasswordField)
                       .addConstraintViolation();
            }
            
            return isValid;
            
        } catch (Exception e) {
            return false;
        }
    }
    
    private Object getFieldValue(Object obj, String fieldName) throws Exception {
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        return field.get(obj);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@PasswordMatch(
    password = "password",
    confirmPassword = "confirmPassword",
    message = "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç å¿…é¡»ä¸€è‡´"
)
public class UserRegistrationForm {
    
    @NotBlank
    @Size(min = 6, max = 20)
    private String password;
    
    @NotBlank
    private String confirmPassword;
}
```

### 6.3 æ—¥æœŸèŒƒå›´éªŒè¯


```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = DateRangeValidator.class)
public @interface DateRange {
    String message() default "æ—¥æœŸèŒƒå›´ä¸æ­£ç¡®";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
    
    String startDate();
    String endDate();
}

public class DateRangeValidator 
    implements ConstraintValidator<DateRange, Object> {
    
    private String startDateField;
    private String endDateField;
    
    @Override
    public void initialize(DateRange annotation) {
        this.startDateField = annotation.startDate();
        this.endDateField = annotation.endDate();
    }
    
    @Override
    public boolean isValid(Object obj, ConstraintValidatorContext context) {
        try {
            LocalDate startDate = (LocalDate) getFieldValue(obj, startDateField);
            LocalDate endDate = (LocalDate) getFieldValue(obj, endDateField);
            
            if (startDate == null || endDate == null) {
                return true;  // nullæ£€æŸ¥äº¤ç»™@NotNull
            }
            
            return !startDate.isAfter(endDate);
            
        } catch (Exception e) {
            return false;
        }
    }
    
    private Object getFieldValue(Object obj, String fieldName) throws Exception {
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        return field.get(obj);
    }
}
```

---

## 7. ğŸ’¾ æ•°æ®åº“éªŒè¯


### 7.1 æ•°æ®åº“éªŒè¯åœºæ™¯


**ä»€ä¹ˆæ˜¯æ•°æ®åº“éªŒè¯**ï¼š
```
éœ€è¦æŸ¥è¯¢æ•°æ®åº“æ‰èƒ½å®Œæˆçš„éªŒè¯

å…¸å‹åœºæ™¯ï¼š
âœ… ç”¨æˆ·åå”¯ä¸€æ€§æ£€æŸ¥
âœ… é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ
âœ… å¤–é”®å…³è”æ•°æ®æ˜¯å¦å­˜åœ¨
```

**æ³¨æ„äº‹é¡¹**ï¼š
```
âš ï¸ æ€§èƒ½å½±å“ï¼šæ¯æ¬¡éªŒè¯éƒ½æŸ¥è¯¢æ•°æ®åº“
âš ï¸ äº‹åŠ¡é—®é¢˜ï¼šéªŒè¯åœ¨äº‹åŠ¡å¤–æ‰§è¡Œ
âš ï¸ å¹¶å‘é—®é¢˜ï¼šå¯èƒ½å‡ºç°ç«æ€æ¡ä»¶

å»ºè®®ï¼š
âœ… æ•°æ®åº“å±‚é¢æ·»åŠ å”¯ä¸€çº¦æŸï¼ˆæœ€ç»ˆé˜²çº¿ï¼‰
âœ… ç¼“å­˜æŸ¥è¯¢ç»“æœ
âœ… æ‰¹é‡éªŒè¯ä¼˜åŒ–
```

### 7.2 å”¯ä¸€æ€§éªŒè¯å®ç°


```java
// å”¯ä¸€æ€§éªŒè¯æ³¨è§£
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = UniqueValidator.class)
public @interface Unique {
    String message() default "è¯¥å€¼å·²å­˜åœ¨";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
    
    Class<?> entity();       // å®ä½“ç±»
    String fieldName();      // å­—æ®µå
}

// éªŒè¯å™¨å®ç°
public class UniqueValidator implements ConstraintValidator<Unique, Object> {
    
    @Autowired
    private EntityManager entityManager;
    
    private Class<?> entityClass;
    private String fieldName;
    
    @Override
    public void initialize(Unique annotation) {
        this.entityClass = annotation.entity();
        this.fieldName = annotation.fieldName();
    }
    
    @Override
    public boolean isValid(Object value, ConstraintValidatorContext context) {
        if (value == null) {
            return true;
        }
        
        try {
            // æ„å»ºæŸ¥è¯¢
            String queryStr = String.format(
                "SELECT COUNT(e) FROM %s e WHERE e.%s = :value",
                entityClass.getSimpleName(),
                fieldName
            );
            
            Long count = entityManager.createQuery(queryStr, Long.class)
                .setParameter("value", value)
                .getSingleResult();
            
            return count == 0;  // ä¸å­˜åœ¨åˆ™éªŒè¯é€šè¿‡
            
        } catch (Exception e) {
            return false;
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public class User {
    
    @Unique(
        entity = User.class,
        fieldName = "username",
        message = "ç”¨æˆ·åå·²è¢«ä½¿ç”¨"
    )
    private String username;
    
    @Unique(
        entity = User.class,
        fieldName = "email",
        message = "é‚®ç®±å·²è¢«æ³¨å†Œ"
    )
    private String email;
}
```

### 7.3 ä¼˜åŒ–çš„æ•°æ®åº“éªŒè¯


```java
// å¸¦ç¼“å­˜çš„å”¯ä¸€æ€§éªŒè¯
public class CachedUniqueValidator implements ConstraintValidator<Unique, Object> {
    
    @Autowired
    private EntityManager entityManager;
    
    @Autowired
    private CacheManager cacheManager;
    
    private Class<?> entityClass;
    private String fieldName;
    
    @Override
    public boolean isValid(Object value, ConstraintValidatorContext context) {
        if (value == null) {
            return true;
        }
        
        String cacheKey = entityClass.getSimpleName() + ":" + fieldName + ":" + value;
        
        // å…ˆæŸ¥ç¼“å­˜
        Boolean cached = cacheManager.getCache("uniqueCheck").get(cacheKey, Boolean.class);
        if (cached != null) {
            return !cached;  // ç¼“å­˜ä¸­å­˜åœ¨åˆ™éªŒè¯å¤±è´¥
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        try {
            String queryStr = String.format(
                "SELECT COUNT(e) FROM %s e WHERE e.%s = :value",
                entityClass.getSimpleName(),
                fieldName
            );
            
            Long count = entityManager.createQuery(queryStr, Long.class)
                .setParameter("value", value)
                .getSingleResult();
            
            boolean exists = count > 0;
            
            // å­˜å…¥ç¼“å­˜ï¼ˆè®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰
            cacheManager.getCache("uniqueCheck").put(cacheKey, exists);
            
            return !exists;
            
        } catch (Exception e) {
            return false;
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è‡ªå®šä¹‰éªŒè¯å™¨ = éªŒè¯æ³¨è§£ + éªŒè¯å™¨ç±»
ğŸ”¸ ConstraintValidatoræ¥å£ï¼šinitializeåˆå§‹åŒ– + isValidéªŒè¯é€»è¾‘
ğŸ”¸ nullå€¼å¤„ç†ï¼šé€šå¸¸è¿”å›trueï¼Œäº¤ç»™@NotNullå¤„ç†
ğŸ”¸ éªŒè¯æ³¨è§£å¿…éœ€ä¸‰è¦ç´ ï¼šmessageã€groupsã€payload
ğŸ”¸ éªŒè¯å™¨å¯ä»¥è®¿é—®Springå®¹å™¨ä¸­çš„Beanï¼ˆå¦‚EntityManagerï¼‰
```

### 8.2 å…³é”®å®ç°è¦ç‚¹


**ğŸ”¹ è‡ªå®šä¹‰éªŒè¯å™¨çš„æ ‡å‡†æµç¨‹**ï¼š
```
1ï¸âƒ£ å®šä¹‰éªŒè¯æ³¨è§£
   - @ConstraintæŒ‡å®šéªŒè¯å™¨ç±»
   - å¿…éœ€çš„messageã€groupsã€payload
   - å¯é€‰çš„è‡ªå®šä¹‰é…ç½®å‚æ•°

2ï¸âƒ£ å®ç°éªŒè¯å™¨ç±»
   - å®ç°ConstraintValidatoræ¥å£
   - initializeè·å–æ³¨è§£é…ç½®
   - isValidæ‰§è¡ŒéªŒè¯é€»è¾‘

3ï¸âƒ£ ä½¿ç”¨éªŒè¯æ³¨è§£
   - æ ‡æ³¨åœ¨å­—æ®µæˆ–ç±»ä¸Š
   - é…ç½®é”™è¯¯æ¶ˆæ¯å’Œå‚æ•°
```

**ğŸ”¹ å¤æ‚éªŒè¯çš„å¤„ç†ç­–ç•¥**ï¼š
```
è·¨å­—æ®µéªŒè¯ï¼š
- æ³¨è§£ä½œç”¨åœ¨ç±»ä¸Šï¼ˆ@Target(ElementType.TYPE)ï¼‰
- ä½¿ç”¨åå°„è·å–å¤šä¸ªå­—æ®µå€¼
- è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ä½ç½®

æ¡ä»¶éªŒè¯ï¼š
- æ ¹æ®æŸå­—æ®µå€¼å†³å®šéªŒè¯é€»è¾‘
- ä½¿ç”¨åå°„åŠ¨æ€è·å–å­—æ®µ

æ•°æ®åº“éªŒè¯ï¼š
- æ³¨å…¥EntityManageræˆ–Repository
- è€ƒè™‘æ€§èƒ½å’Œç¼“å­˜
- æ•°æ®åº“çº¦æŸæ˜¯æœ€ç»ˆé˜²çº¿
```

### 8.3 å®é™…åº”ç”¨å»ºè®®


**éªŒè¯å™¨é€‰æ‹©åŸåˆ™**ï¼š
```
ç®€å•æ ¼å¼éªŒè¯ â†’ æ­£åˆ™è¡¨è¾¾å¼
å¤æ‚ä¸šåŠ¡è§„åˆ™ â†’ è‡ªå®šä¹‰éªŒè¯å™¨
å¤šå­—æ®µå…³è” â†’ è·¨å­—æ®µéªŒè¯å™¨
æ•°æ®åº“æ£€æŸ¥ â†’ æ•°æ®åº“éªŒè¯å™¨ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
```

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
```
âœ… ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼ä¸ºé™æ€å¸¸é‡ï¼ˆPattern.compileï¼‰
âœ… æ•°æ®åº“éªŒè¯ä½¿ç”¨ç¼“å­˜
âœ… é¿å…åœ¨éªŒè¯å™¨ä¸­è¿›è¡Œå¤æ‚è®¡ç®—
âœ… æ‰¹é‡éªŒè¯æ—¶è€ƒè™‘åˆå¹¶æ•°æ®åº“æŸ¥è¯¢
```

**é”™è¯¯æ¶ˆæ¯æœ€ä½³å®è·µ**ï¼š
```
âœ… æ¶ˆæ¯æ¸…æ™°æ˜äº†ï¼Œå‘Šè¯‰ç”¨æˆ·å¦‚ä½•ä¿®æ­£
âœ… æ”¯æŒå›½é™…åŒ–ï¼ˆä½¿ç”¨èµ„æºæ–‡ä»¶ï¼‰
âœ… å¯ä»¥åœ¨éªŒè¯å™¨ä¸­åŠ¨æ€æ„å»ºæ¶ˆæ¯
âœ… ä½¿ç”¨ConstraintValidatorContextè‡ªå®šä¹‰é”™è¯¯ä½ç½®
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- è‡ªå®šä¹‰éªŒè¯å™¨è§£å†³ä¸ªæ€§åŒ–éªŒè¯éœ€æ±‚
- èŒè´£åˆ†ç¦»ï¼šnullæ£€æŸ¥äº¤ç»™@NotNull
- è·¨å­—æ®µéªŒè¯ä½œç”¨åœ¨ç±»ä¸Šï¼Œä½¿ç”¨åå°„è·å–å€¼
- æ•°æ®åº“éªŒè¯éœ€è°¨æ…ï¼Œæ³¨æ„æ€§èƒ½å’Œç¼“å­˜