---
title: 59ã€è‡ªå®šä¹‰ç±»å‹å®ç°
---
## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ç±»å‹](#1-ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ç±»å‹)
2. [UserTypeæ¥å£è¯¦è§£](#2-UserTypeæ¥å£è¯¦è§£)
3. [CompositeUserTypeå¤åˆç±»å‹](#3-CompositeUserTypeå¤åˆç±»å‹)
4. [AttributeConverterè½¬æ¢å™¨](#4-AttributeConverterè½¬æ¢å™¨)
5. [æšä¸¾ç±»å‹å¤„ç†](#5-æšä¸¾ç±»å‹å¤„ç†)
6. [JSONç±»å‹å¤„ç†](#6-JSONç±»å‹å¤„ç†)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ç±»å‹


### 1.1 å®é™…é—®é¢˜åœºæ™¯


> ğŸ’¡ **æƒ³è±¡è¿™æ ·çš„åœºæ™¯**ï¼šä½ çš„Javaå¯¹è±¡æœ‰ä¸ª"é‡‘é¢"å­—æ®µï¼Œç”¨`BigDecimal`å­˜å‚¨ï¼Œä½†æ•°æ®åº“é‡Œæƒ³å­˜æˆ"åˆ†"ï¼ˆæ•´æ•°ï¼‰ï¼›æˆ–è€…ä½ æœ‰ä¸ª"åœ°å€"å¯¹è±¡ï¼ŒåŒ…å«çœå¸‚åŒºï¼Œä½†æ•°æ®åº“åªæœ‰ä¸€ä¸ªVARCHARå­—æ®µã€‚è¿™æ—¶å€™Hibernateé»˜è®¤çš„æ˜ å°„å°±ä¸å¤Ÿç”¨äº†ã€‚

**ç°å®å¼€å‘ä¸­çš„å…¸å‹éœ€æ±‚**ï¼š

```
åœºæ™¯1ï¼šé‡‘é¢å¤„ç†
Javaç«¯: BigDecimal amount = 99.99å…ƒ
æ•°æ®åº“: INTEGER = 9999åˆ†

åœºæ™¯2ï¼šå¤æ‚å¯¹è±¡
Javaç«¯: Address { province, city, district }
æ•°æ®åº“: VARCHAR = "å¹¿ä¸œçœ-æ·±åœ³å¸‚-å—å±±åŒº"

åœºæ™¯3ï¼šæšä¸¾æ˜ å°„
Javaç«¯: OrderStatus.PAID
æ•°æ®åº“: VARCHAR = "å·²æ”¯ä»˜" (ä¸­æ–‡æè¿°)

åœºæ™¯4ï¼šJSONå­˜å‚¨
Javaç«¯: Map<String, Object> extraInfo
æ•°æ®åº“: TEXT = {"color":"red","size":"L"}
```

### 1.2 Hibernateçš„é»˜è®¤æ˜ å°„é™åˆ¶


**Hibernateè‡ªå¸¦çš„ç±»å‹æ˜ å°„**ï¼š
- âœ… åŸºæœ¬ç±»å‹ï¼šString â†’ VARCHARï¼ŒInteger â†’ INT
- âœ… æ—¥æœŸç±»å‹ï¼šDate â†’ TIMESTAMP
- âœ… æšä¸¾ç±»å‹ï¼šEnum â†’ VARCHARï¼ˆå­˜åç§°ï¼‰æˆ– INTï¼ˆå­˜åºå·ï¼‰

**ä½†æ˜¯é‡åˆ°è¿™äº›å°±ä¸è¡Œäº†**ï¼š
- âŒ è‡ªå®šä¹‰å€¼å¯¹è±¡ï¼ˆå¦‚é‡‘é¢ã€åæ ‡ï¼‰
- âŒ éœ€è¦åŠ å¯†å­˜å‚¨çš„æ•æ„Ÿä¿¡æ¯
- âŒ å¤æ‚æ ¼å¼è½¬æ¢ï¼ˆå¦‚JSONã€XMLï¼‰
- âŒ ä¸šåŠ¡ç‰¹å®šçš„ç¼–ç è§„åˆ™

> âš ï¸ **æ ¸å¿ƒç†è§£**ï¼šè‡ªå®šä¹‰ç±»å‹å°±æ˜¯å‘Šè¯‰Hibernateï¼š"è¿™ä¸ªJavaç±»å‹è¦æ€ä¹ˆè½¬æˆæ•°æ®åº“ç±»å‹ï¼Œæ•°æ®åº“ç±»å‹åˆæ€ä¹ˆè½¬å›Javaç±»å‹"

---

## 2. ğŸ”§ UserTypeæ¥å£è¯¦è§£


### 2.1 UserTypeæ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼š`UserType`å°±åƒä¸€ä¸ª"ç¿»è¯‘å®˜"ï¼Œè´Ÿè´£åœ¨Javaå¯¹è±¡å’Œæ•°æ®åº“ä¹‹é—´äº’ç›¸ç¿»è¯‘ã€‚

```
Javaå¯¹è±¡ â†â†’ [UserTypeç¿»è¯‘] â†â†’ æ•°æ®åº“å€¼

æ¯”å¦‚ï¼š
BigDecimal(99.99) â†â†’ [MoneyType] â†â†’ Integer(9999)
```

### 2.2 UserTypeæ ¸å¿ƒæ–¹æ³•


| æ–¹æ³• | ä½œç”¨ | é€šä¿—ç†è§£ |
|------|------|---------|
| `sqlTypes()` | å‘Šè¯‰æ•°æ®åº“ç”¨ä»€ä¹ˆç±»å‹å­˜å‚¨ | "æˆ‘è¦ç”¨INTEGERå­˜" |
| `returnedClass()` | å‘Šè¯‰Javaè¿™æ˜¯ä»€ä¹ˆç±»å‹ | "æˆ‘å¯¹åº”BigDecimalç±»" |
| `nullSafeGet()` | ä»æ•°æ®åº“è¯»æ•°æ® | "æŠŠæ•°æ®åº“çš„9999è½¬æˆ99.99" |
| `nullSafeSet()` | å†™æ•°æ®åˆ°æ•°æ®åº“ | "æŠŠ99.99è½¬æˆ9999å­˜è¿›å»" |
| `deepCopy()` | å¤åˆ¶å¯¹è±¡ | "åˆ›å»ºä¸€ä¸ªå‰¯æœ¬" |
| `isMutable()` | å¯¹è±¡èƒ½å¦ä¿®æ”¹ | "è¿™ä¸ªå¯¹è±¡æ”¹äº†è¦é‡æ–°ä¿å­˜å—" |

### 2.3 å®æˆ˜æ¡ˆä¾‹ï¼šé‡‘é¢ç±»å‹


> ğŸ“– **éœ€æ±‚**ï¼šJavaç”¨å…ƒï¼ˆBigDecimalï¼‰ï¼Œæ•°æ®åº“å­˜åˆ†ï¼ˆIntegerï¼‰

```java
// ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºé‡‘é¢ç±»å‹è½¬æ¢å™¨
public class MoneyUserType implements UserType<BigDecimal> {
    
    // å‘Šè¯‰æ•°æ®åº“ï¼šæˆ‘è¦ç”¨INTEGERç±»å‹å­˜å‚¨
    @Override
    public int getSqlType() {
        return Types.INTEGER;
    }
    
    // å‘Šè¯‰Javaï¼šæˆ‘å¯¹åº”çš„æ˜¯BigDecimalç±»
    @Override
    public Class<BigDecimal> returnedClass() {
        return BigDecimal.class;
    }
    
    // ä»æ•°æ®åº“è¯»ï¼šæŠŠåˆ†è½¬æˆå…ƒ
    @Override
    public BigDecimal nullSafeGet(ResultSet rs, int position, 
                                   SharedSessionContractImplementor session) 
            throws SQLException {
        Integer cents = rs.getInt(position);
        if (rs.wasNull()) return null;
        
        // 9999åˆ† â†’ 99.99å…ƒ
        return BigDecimal.valueOf(cents).divide(BigDecimal.valueOf(100));
    }
    
    // å†™å…¥æ•°æ®åº“ï¼šæŠŠå…ƒè½¬æˆåˆ†
    @Override
    public void nullSafeSet(PreparedStatement st, BigDecimal value, 
                            int index, SharedSessionContractImplementor session) 
            throws SQLException {
        if (value == null) {
            st.setNull(index, Types.INTEGER);
        } else {
            // 99.99å…ƒ â†’ 9999åˆ†
            int cents = value.multiply(BigDecimal.valueOf(100)).intValue();
            st.setInt(index, cents);
        }
    }
    
    // å…¶ä»–å¿…é¡»å®ç°çš„æ–¹æ³•
    @Override
    public BigDecimal deepCopy(BigDecimal value) {
        return value; // BigDecimalæœ¬èº«ä¸å¯å˜ï¼Œç›´æ¥è¿”å›
    }
    
    @Override
    public boolean isMutable() {
        return false; // BigDecimalä¸å¯å˜
    }
}
```

**ç¬¬äºŒæ­¥ï¼šåœ¨å®ä½“ç±»ä¸­ä½¿ç”¨**

```java
@Entity
public class Product {
    
    @Id
    private Long id;
    
    private String name;
    
    // ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹
    @Type(MoneyUserType.class)
    @Column(name = "price") // æ•°æ®åº“å­—æ®µæ˜¯INTEGERç±»å‹
    private BigDecimal price; // Javaæ˜¯BigDecimalç±»å‹
    
    // å­˜99.99å…ƒï¼Œæ•°æ®åº“å®é™…å­˜9999
}
```

### 2.4 @Typeæ³¨è§£è¯´æ˜


**@Typeæ³¨è§£çš„ä½œç”¨**ï¼šæŒ‡å®šå­—æ®µä½¿ç”¨å“ªä¸ªè‡ªå®šä¹‰ç±»å‹å¤„ç†

```java
// æ–¹å¼1ï¼šç›´æ¥æŒ‡å®šç±»
@Type(MoneyUserType.class)
private BigDecimal price;

// æ–¹å¼2ï¼šä½¿ç”¨ç±»å‹å®šä¹‰ï¼ˆæ¨èï¼‰
@TypeDef(name = "money", typeClass = MoneyUserType.class)
@Entity
public class Product {
    @Type(type = "money")
    private BigDecimal price;
}
```

> ğŸ’¡ **å»ºè®®**ï¼šç”¨`@TypeDef`åœ¨package-info.javaä¸­ç»Ÿä¸€å®šä¹‰ï¼Œæ–¹ä¾¿å¤ç”¨

---

## 3. ğŸ§© CompositeUserTypeå¤åˆç±»å‹


### 3.1 ä»€ä¹ˆæ˜¯å¤åˆç±»å‹


**é€šä¿—ç†è§£**ï¼šä¸€ä¸ªJavaå¯¹è±¡å¯¹åº”æ•°æ®åº“çš„**å¤šä¸ªå­—æ®µ**ï¼Œå°±å«å¤åˆç±»å‹ã€‚

```
Javaå¯¹è±¡ï¼ˆä¸€ä¸ªï¼‰        æ•°æ®åº“ï¼ˆå¤šä¸ªå­—æ®µï¼‰
Address {             â”Œâ”€ province VARCHAR
  province: "å¹¿ä¸œ",   â”œâ”€ city VARCHAR
  city: "æ·±åœ³",       â””â”€ district VARCHAR
  district: "å—å±±"
}
```

### 3.2 å®æˆ˜æ¡ˆä¾‹ï¼šåœ°å€ç±»å‹


```java
// åœ°å€å€¼å¯¹è±¡
public class Address {
    private String province;
    private String city;
    private String district;
    
    // æ„é€ å™¨ã€getter/setterçœç•¥
}

// åœ°å€å¤åˆç±»å‹è½¬æ¢å™¨
public class AddressCompositeType implements CompositeUserType<Address> {
    
    @Override
    public Class<Address> returnedClass() {
        return Address.class;
    }
    
    // å®šä¹‰å¯¹åº”å“ªäº›æ•°æ®åº“å­—æ®µï¼ˆå…³é”®ï¼ï¼‰
    @Override
    public String[] getPropertyNames() {
        return new String[]{"province", "city", "district"};
    }
    
    // å®šä¹‰æ¯ä¸ªå­—æ®µçš„æ•°æ®åº“ç±»å‹
    @Override
    public Type[] getPropertyTypes() {
        return new Type[]{
            StringType.INSTANCE,
            StringType.INSTANCE,
            StringType.INSTANCE
        };
    }
    
    // ä»æ•°æ®åº“è¯»ï¼šç»„è£…æˆAddresså¯¹è±¡
    @Override
    public Address nullSafeGet(ResultSet rs, String[] names, 
                               SharedSessionContractImplementor session) 
            throws SQLException {
        String province = rs.getString(names[0]);
        String city = rs.getString(names[1]);
        String district = rs.getString(names[2]);
        
        if (province == null && city == null && district == null) {
            return null;
        }
        
        return new Address(province, city, district);
    }
    
    // å†™å…¥æ•°æ®åº“ï¼šæ‹†åˆ†Addresså¯¹è±¡
    @Override
    public void nullSafeSet(PreparedStatement st, Address value, 
                           int index, SharedSessionContractImplementor session) 
            throws SQLException {
        if (value == null) {
            st.setNull(index, Types.VARCHAR);
            st.setNull(index + 1, Types.VARCHAR);
            st.setNull(index + 2, Types.VARCHAR);
        } else {
            st.setString(index, value.getProvince());
            st.setString(index + 1, value.getCity());
            st.setString(index + 2, value.getDistrict());
        }
    }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```java
@Entity
@Table(name = "users")
public class User {
    
    @Id
    private Long id;
    
    // ä¸€ä¸ªAddresså¯¹è±¡å¯¹åº”3ä¸ªæ•°æ®åº“å­—æ®µ
    @Type(AddressCompositeType.class)
    @AttributeOverrides({
        @AttributeOverride(name = "province", column = @Column(name = "addr_province")),
        @AttributeOverride(name = "city", column = @Column(name = "addr_city")),
        @AttributeOverride(name = "district", column = @Column(name = "addr_district"))
    })
    private Address address;
}
```

**æ•°æ®åº“è¡¨ç»“æ„**ï¼š

```
usersè¡¨
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ name â”‚ addr_provinceâ”‚ addr_city  â”‚ addr_districtâ”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ å¼ ä¸‰ â”‚ å¹¿ä¸œçœ        â”‚ æ·±åœ³å¸‚      â”‚ å—å±±åŒº       â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ğŸ”„ AttributeConverterè½¬æ¢å™¨


### 4.1 AttributeConverteræ˜¯ä»€ä¹ˆ


> ğŸ’¡ **ç®€å•ç†è§£**ï¼šAttributeConverteræ˜¯JPAæ ‡å‡†çš„è½¬æ¢å™¨ï¼Œæ¯”UserTypeæ›´ç®€å•ã€æ›´æ¨èï¼

**AttributeConverter vs UserType å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | AttributeConverter | UserType |
|------|-------------------|----------|
| **æ ‡å‡†** | JPAæ ‡å‡†ï¼Œé€šç”¨æ€§å¼º | Hibernateä¸“ç”¨ |
| **å¤æ‚åº¦** | â­ç®€å•ï¼Œåªéœ€2ä¸ªæ–¹æ³• | â­â­â­å¤æ‚ï¼Œéœ€å®ç°10+æ–¹æ³• |
| **é€‚ç”¨åœºæ™¯** | å•å­—æ®µè½¬æ¢ | å•å­—æ®µæˆ–å¤šå­—æ®µ |
| **æ¨èåº¦** | ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ ä¼˜å…ˆä½¿ç”¨ | å¤æ‚åœºæ™¯æ‰ç”¨ |

### 4.2 AttributeConverteræ ¸å¿ƒæ–¹æ³•


```java
public interface AttributeConverter<X, Y> {
    // X: Javaç±»å‹ï¼ˆå®ä½“å±æ€§ï¼‰
    // Y: æ•°æ®åº“ç±»å‹ï¼ˆæ•°æ®åº“å­—æ®µï¼‰
    
    // è½¬æ¢åˆ°æ•°æ®åº“ï¼šJava â†’ Database
    Y convertToDatabaseColumn(X attribute);
    
    // è½¬æ¢åˆ°å®ä½“ï¼šDatabase â†’ Java
    X convertToEntityAttribute(Y dbData);
}
```

### 4.3 å®æˆ˜æ¡ˆä¾‹ï¼šå¸ƒå°”å€¼è½¬æ¢


> ğŸ“– **éœ€æ±‚**ï¼šJavaç”¨Booleanï¼Œæ•°æ®åº“ç”¨Y/Nå­—ç¬¦

```java
// è½¬æ¢å™¨å®ç°
@Converter(autoApply = true) // autoApply=trueè¡¨ç¤ºè‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰Booleanç±»å‹
public class BooleanToYNConverter implements AttributeConverter<Boolean, String> {
    
    // Javaçš„true/false â†’ æ•°æ®åº“çš„Y/N
    @Override
    public String convertToDatabaseColumn(Boolean attribute) {
        if (attribute == null) return null;
        return attribute ? "Y" : "N";
    }
    
    // æ•°æ®åº“çš„Y/N â†’ Javaçš„true/false
    @Override
    public String convertToEntityAttribute(String dbData) {
        if (dbData == null) return null;
        return "Y".equalsIgnoreCase(dbData);
    }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```java
@Entity
public class User {
    @Id
    private Long id;
    
    // æ–¹å¼1ï¼šè‡ªåŠ¨åº”ç”¨ï¼ˆå› ä¸ºConverterè®¾ç½®äº†autoApply=trueï¼‰
    private Boolean active; // æ•°æ®åº“å­˜Yæˆ–N
    
    // æ–¹å¼2ï¼šæ‰‹åŠ¨æŒ‡å®šè½¬æ¢å™¨
    @Convert(converter = BooleanToYNConverter.class)
    private Boolean enabled;
}
```

### 4.4 @Converteræ³¨è§£è¯¦è§£


```java
@Converter(
    autoApply = true  // æ˜¯å¦è‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰åŒ¹é…ç±»å‹
)
```

**autoApplyå‚æ•°è¯´æ˜**ï¼š
- âœ… `true`ï¼šè‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰å¯¹åº”ç±»å‹çš„å­—æ®µ
- âŒ `false`ï¼šéœ€è¦åœ¨å­—æ®µä¸Šç”¨`@Convert`æ‰‹åŠ¨æŒ‡å®š

> âš ï¸ **æ³¨æ„**ï¼šautoApply=trueæ—¶è¦è°¨æ…ï¼Œç¡®ä¿æ‰€æœ‰è¯¥ç±»å‹å­—æ®µéƒ½éœ€è¦è½¬æ¢

---

## 5. ğŸ“‹ æšä¸¾ç±»å‹å¤„ç†


### 5.1 æšä¸¾æ˜ å°„çš„ä¸‰ç§æ–¹å¼


**æ–¹å¼å¯¹æ¯”**ï¼š

| æ–¹å¼ | å­˜å‚¨å†…å®¹ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|------|------|
| **@Enumerated(STRING)** | æšä¸¾åç§° | å¯è¯»æ€§å¥½ | ä¸èƒ½æ”¹æšä¸¾å |
| **@Enumerated(ORDINAL)** | æšä¸¾åºå·(0,1,2) | èŠ‚çœç©ºé—´ | ä¸èƒ½è°ƒæ•´é¡ºåº |
| **è‡ªå®šä¹‰è½¬æ¢å™¨** | è‡ªå®šä¹‰å€¼ | çµæ´»å¯æ§ | éœ€è¦å†™ä»£ç  |

### 5.2 é»˜è®¤æ–¹å¼ï¼š@Enumerated


```java
// è®¢å•çŠ¶æ€æšä¸¾
public enum OrderStatus {
    PENDING,    // å¾…æ”¯ä»˜
    PAID,       // å·²æ”¯ä»˜
    SHIPPED,    // å·²å‘è´§
    COMPLETED   // å·²å®Œæˆ
}

@Entity
public class Order {
    @Id
    private Long id;
    
    // æ–¹å¼1ï¼šå­˜æšä¸¾åç§°ï¼ˆæ¨èï¼‰
    @Enumerated(EnumType.STRING)
    @Column(length = 20)
    private OrderStatus status; // æ•°æ®åº“å­˜"PAID"
    
    // æ–¹å¼2ï¼šå­˜æšä¸¾åºå·ï¼ˆä¸æ¨èï¼ï¼‰
    @Enumerated(EnumType.ORDINAL)
    private OrderStatus statusOld; // æ•°æ®åº“å­˜1
}
```

**å­˜å‚¨æ•ˆæœ**ï¼š

```
EnumType.STRING â†’ æ•°æ®åº“å­˜å‚¨
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id   â”‚ status â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1    â”‚ PAID   â”‚  â† å­˜çš„æ˜¯æšä¸¾å
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EnumType.ORDINAL â†’ æ•°æ®åº“å­˜å‚¨
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id   â”‚ status â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1    â”‚ 1      â”‚  â† å­˜çš„æ˜¯åºå·ï¼ˆPAIDæ˜¯ç¬¬1ä¸ªï¼Œä»0å¼€å§‹ï¼‰
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> âš ï¸ **ä¸ºä»€ä¹ˆä¸æ¨èORDINAL**ï¼š
> - å¦‚æœåœ¨PENDINGå‰åŠ æ–°çŠ¶æ€ï¼Œæ‰€æœ‰åºå·éƒ½ä¼šé”™ä½ï¼
> - æ•°æ®åº“é‡Œçš„1æœ¬æ¥æ˜¯PAIDï¼Œå¯èƒ½å˜æˆå…¶ä»–çŠ¶æ€

### 5.3 è‡ªå®šä¹‰æšä¸¾è½¬æ¢ï¼ˆå­˜ä¸­æ–‡æè¿°ï¼‰


> ğŸ“– **éœ€æ±‚**ï¼šæ•°æ®åº“æƒ³å­˜"å·²æ”¯ä»˜"è€Œä¸æ˜¯"PAID"

```java
// æšä¸¾å®šä¹‰ï¼ˆå¸¦ä¸­æ–‡æè¿°ï¼‰
public enum OrderStatus {
    PENDING("å¾…æ”¯ä»˜"),
    PAID("å·²æ”¯ä»˜"),
    SHIPPED("å·²å‘è´§"),
    COMPLETED("å·²å®Œæˆ");
    
    private final String description;
    
    OrderStatus(String description) {
        this.description = description;
    }
    
    public String getDescription() {
        return description;
    }
    
    // æ ¹æ®æè¿°æ‰¾æšä¸¾
    public static OrderStatus fromDescription(String desc) {
        for (OrderStatus status : values()) {
            if (status.description.equals(desc)) {
                return status;
            }
        }
        return null;
    }
}

// è‡ªå®šä¹‰è½¬æ¢å™¨
@Converter(autoApply = true)
public class OrderStatusConverter 
        implements AttributeConverter<OrderStatus, String> {
    
    @Override
    public String convertToDatabaseColumn(OrderStatus status) {
        return status == null ? null : status.getDescription();
    }
    
    @Override
    public OrderStatus convertToEntityAttribute(String dbData) {
        return dbData == null ? null : OrderStatus.fromDescription(dbData);
    }
}
```

**å­˜å‚¨æ•ˆæœ**ï¼š

```
æ•°æ®åº“è¡¨
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id   â”‚ status  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1    â”‚ å·²æ”¯ä»˜  â”‚  â† å­˜çš„æ˜¯ä¸­æ–‡æè¿°
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. ğŸ“¦ JSONç±»å‹å¤„ç†


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦JSONç±»å‹


**å®é™…åœºæ™¯**ï¼š
- å•†å“çš„æ‰©å±•å±æ€§ï¼ˆé¢œè‰²ã€å°ºå¯¸ç­‰ï¼‰ä¸å›ºå®š
- ç”¨æˆ·çš„ä¸ªæ€§åŒ–é…ç½®ä¿¡æ¯
- è®¢å•çš„é¢å¤–ä¿¡æ¯ï¼ˆå¤‡æ³¨ã€æ ‡ç­¾ç­‰ï¼‰

```
ä¼ ç»Ÿæ–¹å¼ï¼šæ¯ä¸ªå±æ€§å»ºä¸€ä¸ªå­—æ®µ
productsè¡¨
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ id  â”‚ color  â”‚ size  â”‚ brandâ”‚ ...  â”‚ â† å­—æ®µå¤ªå¤šï¼
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜

JSONæ–¹å¼ï¼šçµæ´»å­˜å‚¨
productsè¡¨
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id  â”‚ extra_info (TEXT)            â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1   â”‚ {"color":"red","size":"L"}   â”‚ â† ä¸€ä¸ªå­—æ®µæå®š
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 JSONè½¬æ¢å™¨å®ç°


```java
// JSONè½¬æ¢å™¨ï¼ˆä½¿ç”¨Jacksonåº“ï¼‰
@Converter
public class JsonConverter implements AttributeConverter<Map<String, Object>, String> {
    
    private static final ObjectMapper mapper = new ObjectMapper();
    
    // Java Map â†’ JSONå­—ç¬¦ä¸²
    @Override
    public String convertToDatabaseColumn(Map<String, Object> attribute) {
        if (attribute == null || attribute.isEmpty()) {
            return null;
        }
        
        try {
            return mapper.writeValueAsString(attribute);
        } catch (JsonProcessingException e) {
            throw new RuntimeException("JSONåºåˆ—åŒ–å¤±è´¥", e);
        }
    }
    
    // JSONå­—ç¬¦ä¸² â†’ Java Map
    @Override
    public Map<String, Object> convertToEntityAttribute(String dbData) {
        if (dbData == null || dbData.isEmpty()) {
            return new HashMap<>();
        }
        
        try {
            return mapper.readValue(dbData, 
                new TypeReference<Map<String, Object>>() {});
        } catch (JsonProcessingException e) {
            throw new RuntimeException("JSONååºåˆ—åŒ–å¤±è´¥", e);
        }
    }
}
```

**å®ä½“ç±»ä½¿ç”¨**ï¼š

```java
@Entity
public class Product {
    @Id
    private Long id;
    
    private String name;
    
    // æ‰©å±•å±æ€§å­˜ä¸ºJSON
    @Convert(converter = JsonConverter.class)
    @Column(name = "extra_info", columnDefinition = "TEXT")
    private Map<String, Object> extraInfo;
    
    // ä½¿ç”¨ç¤ºä¾‹
    public void setColor(String color) {
        if (extraInfo == null) {
            extraInfo = new HashMap<>();
        }
        extraInfo.put("color", color);
    }
}
```

**æ•°æ®å­˜å‚¨ç¤ºä¾‹**ï¼š

```java
Product product = new Product();
product.setName("Tæ¤");
product.setColor("red");
product.getExtraInfo().put("size", "L");
product.getExtraInfo().put("brand", "Nike");

// æ•°æ®åº“å®é™…å­˜å‚¨
// extra_infoå­—æ®µ: {"color":"red","size":"L","brand":"Nike"}
```

### 6.3 æ³›å‹JSONè½¬æ¢å™¨ï¼ˆè¿›é˜¶ï¼‰


> ğŸš€ **æ›´çµæ´»çš„æ–¹å¼**ï¼šæ”¯æŒä»»æ„ç±»å‹è½¬JSON

```java
// æ³›å‹JSONè½¬æ¢å™¨åŸºç±»
public abstract class AbstractJsonConverter<T> 
        implements AttributeConverter<T, String> {
    
    private static final ObjectMapper mapper = new ObjectMapper();
    private final TypeReference<T> typeReference;
    
    protected AbstractJsonConverter(TypeReference<T> typeReference) {
        this.typeReference = typeReference;
    }
    
    @Override
    public String convertToDatabaseColumn(T attribute) {
        try {
            return attribute == null ? null : mapper.writeValueAsString(attribute);
        } catch (JsonProcessingException e) {
            throw new RuntimeException(e);
        }
    }
    
    @Override
    public T convertToEntityAttribute(String dbData) {
        try {
            return dbData == null ? null : mapper.readValue(dbData, typeReference);
        } catch (JsonProcessingException e) {
            throw new RuntimeException(e);
        }
    }
}

// å…·ä½“è½¬æ¢å™¨ï¼šList<String>ç±»å‹
@Converter
public class StringListJsonConverter extends AbstractJsonConverter<List<String>> {
    public StringListJsonConverter() {
        super(new TypeReference<List<String>>() {});
    }
}

// ä½¿ç”¨
@Entity
public class Article {
    @Convert(converter = StringListJsonConverter.class)
    @Column(columnDefinition = "TEXT")
    private List<String> tags; // å­˜å‚¨ä¸º ["Java","Spring","Hibernate"]
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è‡ªå®šä¹‰ç±»å‹ç”¨é€”ï¼šå¤„ç†Hibernateé»˜è®¤æ˜ å°„æ— æ³•æ»¡è¶³çš„ç±»å‹è½¬æ¢
ğŸ”¸ UserTypeï¼šHibernateä¸“ç”¨ï¼ŒåŠŸèƒ½å¼ºå¤§ä½†å¤æ‚
ğŸ”¸ CompositeUserTypeï¼šä¸€ä¸ªJavaå¯¹è±¡å¯¹åº”å¤šä¸ªæ•°æ®åº“å­—æ®µ
ğŸ”¸ AttributeConverterï¼šJPAæ ‡å‡†ï¼Œç®€å•æ˜“ç”¨ï¼Œä¼˜å…ˆæ¨è
ğŸ”¸ æšä¸¾æ˜ å°„ï¼šSTRINGæ–¹å¼æœ€å®‰å…¨ï¼Œè‡ªå®šä¹‰è½¬æ¢å™¨æœ€çµæ´»
ğŸ”¸ JSONç±»å‹ï¼šé€‚åˆå­˜å‚¨éå›ºå®šç»“æ„çš„æ‰©å±•æ•°æ®
```

### 7.2 æŠ€æœ¯é€‰å‹å»ºè®®


**é€‰æ‹©è½¬æ¢å™¨çš„å†³ç­–æ ‘**ï¼š

```
éœ€è¦ç±»å‹è½¬æ¢ï¼Ÿ
    â”‚
    â”œâ”€ å•å­—æ®µè½¬æ¢ï¼Ÿ
    â”‚   â”‚
    â”‚   â”œâ”€ æ˜¯ â†’ ä¼˜å…ˆç”¨ AttributeConverter
    â”‚   â”‚       (ç®€å•ã€æ ‡å‡†ã€æ¨èï¼)
    â”‚   â”‚
    â”‚   â””â”€ å¦ â†’ å¤šå­—æ®µ â†’ ç”¨ CompositeUserType
    â”‚
    â””â”€ éœ€è¦Hibernateç‰¹å®šåŠŸèƒ½ï¼Ÿ
        â”‚
        â””â”€ æ˜¯ â†’ ç”¨ UserType
```

### 7.3 æœ€ä½³å®è·µ


> ğŸ’¡ **å®ç”¨å»ºè®®**ï¼š

**1. è½¬æ¢å™¨çš„å¤ç”¨**
```java
// åœ¨package-info.javaä¸­ç»Ÿä¸€æ³¨å†Œ
@TypeDef(name = "json", typeClass = JsonConverter.class)
@TypeDef(name = "money", typeClass = MoneyUserType.class)
package com.example.domain;
```

**2. å¼‚å¸¸å¤„ç†**
```java
@Override
public String convertToDatabaseColumn(Object value) {
    try {
        return mapper.writeValueAsString(value);
    } catch (Exception e) {
        // è®°å½•æ—¥å¿—ï¼Œä¸è¦åæ‰å¼‚å¸¸
        log.error("JSONè½¬æ¢å¤±è´¥: {}", value, e);
        throw new RuntimeException("è½¬æ¢å¤±è´¥", e);
    }
}
```

**3. æ€§èƒ½è€ƒè™‘**
- âœ… JSONè½¬æ¢å™¨ï¼šå¤ç”¨ObjectMapperå¯¹è±¡
- âœ… æšä¸¾è½¬æ¢ï¼šç¼“å­˜æšä¸¾æŸ¥æ‰¾ç»“æœ
- âœ… å¤æ‚è®¡ç®—ï¼šè€ƒè™‘ç¼“å­˜è½¬æ¢ç»“æœ

**4. æ•°æ®åº“å…¼å®¹æ€§**
```java
// æ˜ç¡®æŒ‡å®šæ•°æ®åº“ç±»å‹ï¼Œé¿å…ä¸åŒæ•°æ®åº“å·®å¼‚
@Column(name = "data", columnDefinition = "TEXT") // MySQL
@Column(name = "data", columnDefinition = "CLOB") // Oracle
```

### 7.4 å¸¸è§é—®é¢˜è§£å†³


| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| **è½¬æ¢å™¨ä¸ç”Ÿæ•ˆ** | æœªæ³¨å†Œæˆ–è·¯å¾„é”™è¯¯ | æ£€æŸ¥@Converteræ³¨è§£å’ŒåŒ…æ‰«æ |
| **JSONåºåˆ—åŒ–å¤±è´¥** | ç±»å‹ä¸å…¼å®¹ | ä½¿ç”¨TypeReferenceæŒ‡å®šç±»å‹ |
| **æšä¸¾å€¼é”™ä¹±** | ä½¿ç”¨äº†ORDINAL | æ”¹ç”¨STRINGæˆ–è‡ªå®šä¹‰è½¬æ¢å™¨ |
| **æ€§èƒ½ä¸‹é™** | æ¯æ¬¡éƒ½newå¯¹è±¡ | å¤ç”¨ObjectMapperç­‰å·¥å…·ç±» |

### 7.5 å®æˆ˜è®°å¿†å£è¯€


```
ç±»å‹è½¬æ¢æœ‰å¦™æ‹›ï¼ŒHibernateå¸®ä½ æ­ä¸ªæ¡¥
å•å­—æ®µç”¨Converterï¼Œå¤šå­—æ®µCompositeType
æšä¸¾åƒä¸‡åˆ«ORDINALï¼ŒSTRINGç¨³å¦¥åˆå¯é 
JSONçµæ´»å­˜æ‰©å±•ï¼ŒMapè½¬å­—ç¬¦ä¸²ä¸€æ°”å‘µæˆ
è‡ªå®šä¹‰ç±»å‹è™½å¤æ‚ï¼ŒæŒæ¡åŸç†ä¸æ…Œå¼ 
```

**æ ¸å¿ƒç†è§£**ï¼š
- è‡ªå®šä¹‰ç±»å‹ = Javaç±»å‹ä¸æ•°æ®åº“ç±»å‹çš„åŒå‘ç¿»è¯‘å™¨
- AttributeConverter = ç®€åŒ–ç‰ˆçš„UserTypeï¼ˆä¼˜å…ˆç”¨å®ƒï¼ï¼‰
- é€‰å¯¹è½¬æ¢å™¨ï¼Œè®©æ•°æ®å­˜å–æ›´çµæ´»ã€æ›´å¯æ§