---
title: 61ã€å¤šæ•°æ®æºé…ç½®
---
## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆéœ€è¦å¤šæ•°æ®æº](#1-ä¸ºä»€ä¹ˆéœ€è¦å¤šæ•°æ®æº)
2. [å¤šæ•°æ®æºé…ç½®](#2-å¤šæ•°æ®æºé…ç½®)
3. [æ•°æ®æºåŠ¨æ€åˆ‡æ¢](#3-æ•°æ®æºåŠ¨æ€åˆ‡æ¢)
4. [è¯»å†™åˆ†ç¦»å®æˆ˜](#4-è¯»å†™åˆ†ç¦»å®æˆ˜)
5. [æ°´å¹³åˆ†ç‰‡è¯¦è§£](#5-æ°´å¹³åˆ†ç‰‡è¯¦è§£)
6. [å‚ç›´åˆ†ç‰‡è¯¦è§£](#6-å‚ç›´åˆ†ç‰‡è¯¦è§£)
7. [åˆ†å¸ƒå¼äº‹åŠ¡](#7-åˆ†å¸ƒå¼äº‹åŠ¡)
8. [æ•°æ®ä¸€è‡´æ€§ä¿éšœ](#8-æ•°æ®ä¸€è‡´æ€§ä¿éšœ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦å¤šæ•°æ®æº


### 1.1 ä»€ä¹ˆæ˜¯å¤šæ•°æ®æº


**é€šä¿—ç†è§£**ï¼šå°±åƒä½ å®¶é‡Œæœ‰å¤šä¸ªæ°´é¾™å¤´ï¼ˆæ•°æ®åº“ï¼‰ï¼Œä¸åŒçš„ç”¨é€”ç”¨ä¸åŒçš„æ°´é¾™å¤´ã€‚

```
ä¼ ç»Ÿå•æ•°æ®æºï¼š
åº”ç”¨ç¨‹åº â†’ ä¸€ä¸ªæ•°æ®åº“ï¼ˆæ‰€æœ‰æ•°æ®éƒ½åœ¨è¿™é‡Œï¼‰

å¤šæ•°æ®æºåœºæ™¯ï¼š
åº”ç”¨ç¨‹åº â”¬â†’ æ•°æ®åº“Aï¼ˆç”¨æˆ·æ•°æ®ï¼‰
         â”œâ†’ æ•°æ®åº“Bï¼ˆè®¢å•æ•°æ®ï¼‰
         â””â†’ æ•°æ®åº“Cï¼ˆæ—¥å¿—æ•°æ®ï¼‰
```

> ğŸ’¡ **æ ¸å¿ƒæ¦‚å¿µ**ï¼šå¤šæ•°æ®æºå°±æ˜¯ä¸€ä¸ªåº”ç”¨åŒæ—¶è¿æ¥å’Œæ“ä½œå¤šä¸ªæ•°æ®åº“ã€‚

### 1.2 å®é™…åº”ç”¨åœºæ™¯


**ğŸ“Œ å¸¸è§ä½¿ç”¨åœºæ™¯**ï¼š

ğŸ”¹ **ä¸šåŠ¡éš”ç¦»**
```
ç”¨æˆ·ç³»ç»Ÿ â†’ ç”¨æˆ·æ•°æ®åº“
è®¢å•ç³»ç»Ÿ â†’ è®¢å•æ•°æ®åº“
è´¢åŠ¡ç³»ç»Ÿ â†’ è´¢åŠ¡æ•°æ®åº“

ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ
â€¢ å®‰å…¨æ€§ï¼šè´¢åŠ¡æ•°æ®ç‹¬ç«‹å­˜å‚¨
â€¢ æ€§èƒ½ï¼šå„ä¸šåŠ¡äº’ä¸å½±å“
â€¢ ç»´æŠ¤ï¼šå¯ä»¥ç‹¬ç«‹å‡çº§ç»´æŠ¤
```

ğŸ”¹ **è¯»å†™åˆ†ç¦»**
```
å†™æ“ä½œ â†’ ä¸»æ•°æ®åº“ï¼ˆMasterï¼‰
è¯»æ“ä½œ â†’ ä»æ•°æ®åº“ï¼ˆSlaveï¼‰

å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ
â€¢ ä¸»åº“è´Ÿè´£å†™ï¼Œå‹åŠ›å°
â€¢ å¤šä¸ªä»åº“åˆ†æ‹…è¯»å‹åŠ›
â€¢ æå‡æ•´ä½“æ€§èƒ½
```

ğŸ”¹ **åˆ†åº“åˆ†è¡¨**
```
ç”¨æˆ·1-100ä¸‡   â†’ æ•°æ®åº“1
ç”¨æˆ·100-200ä¸‡ â†’ æ•°æ®åº“2
ç”¨æˆ·200-300ä¸‡ â†’ æ•°æ®åº“3

ä¸ºä»€ä¹ˆè¦åˆ†ï¼Ÿ
â€¢ å•è¡¨æ•°æ®å¤ªå¤§ï¼ŒæŸ¥è¯¢æ…¢
â€¢ åˆ†æ•£å­˜å‚¨ï¼Œæå‡æ€§èƒ½
â€¢ çªç ´å•åº“å­˜å‚¨é™åˆ¶
```

### 1.3 é¢ä¸´çš„æŒ‘æˆ˜


**âš ï¸ éœ€è¦è§£å†³çš„é—®é¢˜**ï¼š

| é—®é¢˜ | è¯´æ˜ | å½±å“ |
|------|------|------|
| **å¦‚ä½•åˆ‡æ¢æ•°æ®æº** | ç¨‹åºæ€ä¹ˆçŸ¥é“è¯¥ç”¨å“ªä¸ªåº“ | è·¯ç”±é—®é¢˜ |
| **äº‹åŠ¡æ€ä¹ˆå¤„ç†** | è·¨å¤šä¸ªåº“çš„äº‹åŠ¡å¦‚ä½•ä¿è¯ | ä¸€è‡´æ€§é—®é¢˜ |
| **æ•°æ®å¦‚ä½•åˆ†é…** | æ•°æ®è¯¥æ”¾åˆ°å“ªä¸ªåº“ | åˆ†ç‰‡è§„åˆ™ |
| **æ•°æ®å¦‚ä½•åŒæ­¥** | ä¸»ä»åº“æ•°æ®å¦‚ä½•ä¿æŒä¸€è‡´ | åŒæ­¥é—®é¢˜ |

---

## 2. ğŸ”§ å¤šæ•°æ®æºé…ç½®


### 2.1 åŸºç¡€æ¦‚å¿µç†è§£


**ä»€ä¹ˆæ˜¯æ•°æ®æºé…ç½®**ï¼šå‘Šè¯‰ç¨‹åº"æœ‰å“ªäº›æ•°æ®åº“å¯ä»¥ç”¨ï¼Œæ€ä¹ˆè¿æ¥å®ƒä»¬"ã€‚

> ğŸ’¡ **ç±»æ¯”ç†è§£**ï¼šå°±åƒåœ¨é€šè®¯å½•é‡Œå­˜å¤šä¸ªè”ç³»äººï¼Œæ¯ä¸ªäººçš„ç”µè¯å·ç ä¸åŒï¼Œéœ€è¦æ—¶èƒ½å¿«é€Ÿæ‰¾åˆ°ã€‚

### 2.2 Spring Booté…ç½®æ–¹å¼


**ğŸ“‹ é…ç½®æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šé…ç½®æ–‡ä»¶å®šä¹‰å¤šä¸ªæ•°æ®æº**

```yaml
spring:
  datasource:
    # ä¸»æ•°æ®æºï¼ˆç”¨æˆ·æ•°æ®ï¼‰
    primary:
      url: jdbc:mysql://localhost:3306/user_db
      username: root
      password: 123456
      driver-class-name: com.mysql.cj.jdbc.Driver
    
    # ä»æ•°æ®æºï¼ˆè®¢å•æ•°æ®ï¼‰
    secondary:
      url: jdbc:mysql://localhost:3306/order_db
      username: root
      password: 123456
      driver-class-name: com.mysql.cj.jdbc.Driver
```

> ğŸ“ **é…ç½®è¯´æ˜**ï¼š
> - `primary`ï¼šä¸»æ•°æ®æºåç§°ï¼ˆè‡ªå·±å®šä¹‰çš„ï¼‰
> - `url`ï¼šæ•°æ®åº“è¿æ¥åœ°å€
> - æ¯ä¸ªæ•°æ®æºéƒ½æœ‰ç‹¬ç«‹çš„è¿æ¥ä¿¡æ¯

**æ­¥éª¤2ï¼šåˆ›å»ºæ•°æ®æºé…ç½®ç±»**

```java
@Configuration
public class DataSourceConfig {
    
    // åˆ›å»ºä¸»æ•°æ®æº
    @Bean
    @Primary  // æ ‡è®°ä¸ºä¸»è¦æ•°æ®æº
    @ConfigurationProperties("spring.datasource.primary")
    public DataSource primaryDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    // åˆ›å»ºä»æ•°æ®æº
    @Bean
    @ConfigurationProperties("spring.datasource.secondary")
    public DataSource secondaryDataSource() {
        return DataSourceBuilder.create().build();
    }
}
```

> ğŸ” **ä»£ç è§£è¯»**ï¼š
> - `@Primary`ï¼šå½“æœ‰å¤šä¸ªæ•°æ®æºæ—¶ï¼Œä¼˜å…ˆä½¿ç”¨è¿™ä¸ª
> - `@ConfigurationProperties`ï¼šè‡ªåŠ¨è¯»å–é…ç½®æ–‡ä»¶çš„å€¼
> - `DataSourceBuilder`ï¼šå¸®æˆ‘ä»¬æ„å»ºæ•°æ®æºå¯¹è±¡

### 2.3 é…ç½®SessionFactory


**ä¸ºä»€ä¹ˆéœ€è¦é…ç½®SessionFactory**ï¼Ÿ

```
æ•°æ®æºï¼ˆDataSourceï¼‰ â†’ åªæ˜¯æ•°æ®åº“è¿æ¥ä¿¡æ¯
SessionFactory       â†’ Hibernateå·¥ä½œçš„æ ¸å¿ƒå¯¹è±¡

å…³ç³»ï¼š
DataSourceæä¾›è¿æ¥ â†’ SessionFactoryä½¿ç”¨è¿æ¥ â†’ æ‰§è¡Œæ•°æ®åº“æ“ä½œ
```

**é…ç½®ç¤ºä¾‹**ï¼š

```java
@Configuration
public class HibernateConfig {
    
    // ä¸»åº“çš„SessionFactory
    @Bean
    @Primary
    public LocalSessionFactoryBean primarySessionFactory(
            @Qualifier("primaryDataSource") DataSource dataSource) {
        
        LocalSessionFactoryBean factory = new LocalSessionFactoryBean();
        factory.setDataSource(dataSource);
        factory.setPackagesToScan("com.example.entity.user");
        
        Properties props = new Properties();
        props.put("hibernate.dialect", "org.hibernate.dialect.MySQL5Dialect");
        props.put("hibernate.show_sql", "true");
        factory.setHibernateProperties(props);
        
        return factory;
    }
    
    // ä»åº“çš„SessionFactoryï¼ˆç±»ä¼¼é…ç½®ï¼Œçœç•¥...ï¼‰
}
```

> ğŸ“Œ **å…³é”®é…ç½®è¯´æ˜**ï¼š
> - `setPackagesToScan`ï¼šæ‰«æå“ªä¸ªåŒ…ä¸‹çš„å®ä½“ç±»
> - `hibernate.dialect`ï¼šå‘Šè¯‰Hibernateç”¨çš„ä»€ä¹ˆæ•°æ®åº“
> - `hibernate.show_sql`ï¼šæ˜¯å¦æ‰“å°SQLè¯­å¥

---

## 3. ğŸ”„ æ•°æ®æºåŠ¨æ€åˆ‡æ¢


### 3.1 ä»€ä¹ˆæ˜¯åŠ¨æ€åˆ‡æ¢


**é€šä¿—è§£é‡Š**ï¼šç¨‹åºè¿è¡Œæ—¶æ ¹æ®éœ€è¦è‡ªåŠ¨é€‰æ‹©ç”¨å“ªä¸ªæ•°æ®åº“ï¼Œå°±åƒå¯¼èˆªè‡ªåŠ¨é€‰æœ€ä¼˜è·¯çº¿ã€‚

```
ç”¨æˆ·è¯·æ±‚ â†’ åˆ¤æ–­æ“ä½œç±»å‹ â†’ é€‰æ‹©å¯¹åº”æ•°æ®æº

ç¤ºä¾‹æµç¨‹ï¼š
æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ â†’ åˆ‡æ¢åˆ°user_db
æŸ¥è¯¢è®¢å•ä¿¡æ¯ â†’ åˆ‡æ¢åˆ°order_db
```

### 3.2 å®ç°åŸç†


**ğŸ”¸ æ ¸å¿ƒæ€è·¯**ï¼šä½¿ç”¨ThreadLocalä¿å­˜å½“å‰çº¿ç¨‹è¦ç”¨çš„æ•°æ®æº

```
ThreadLocalçš„ä½œç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  çº¿ç¨‹Aï¼šä½¿ç”¨DB1  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  çº¿ç¨‹Bï¼šä½¿ç”¨DB2  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  çº¿ç¨‹Cï¼šä½¿ç”¨DB1  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹ï¼Œäº’ä¸å½±å“
```

### 3.3 ä»£ç å®ç°


**æ­¥éª¤1ï¼šåˆ›å»ºæ•°æ®æºä¸Šä¸‹æ–‡**

```java
public class DataSourceContextHolder {
    
    // çº¿ç¨‹æœ¬åœ°å˜é‡ï¼Œå­˜å‚¨å½“å‰æ•°æ®æºæ ‡è¯†
    private static final ThreadLocal<String> CONTEXT = new ThreadLocal<>();
    
    // è®¾ç½®æ•°æ®æº
    public static void setDataSource(String dataSource) {
        CONTEXT.set(dataSource);
    }
    
    // è·å–æ•°æ®æº
    public static String getDataSource() {
        return CONTEXT.get();
    }
    
    // æ¸…é™¤æ•°æ®æºï¼ˆé¿å…å†…å­˜æ³„æ¼ï¼‰
    public static void clear() {
        CONTEXT.remove();
    }
}
```

> ğŸ’¡ **è®¾è®¡æ€è·¯**ï¼š
> - ç”¨ThreadLocalè®©æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„æ•°æ®æºæ ‡è¯†
> - ä½¿ç”¨å®Œè®°å¾—æ¸…é™¤ï¼Œé¿å…å½±å“åç»­è¯·æ±‚

**æ­¥éª¤2ï¼šåˆ›å»ºåŠ¨æ€æ•°æ®æº**

```java
public class DynamicDataSource extends AbstractRoutingDataSource {
    
    @Override
    protected Object determineCurrentLookupKey() {
        // è¿”å›å½“å‰çº¿ç¨‹è¦ä½¿ç”¨çš„æ•°æ®æºkey
        return DataSourceContextHolder.getDataSource();
    }
}
```

**æ­¥éª¤3ï¼šé…ç½®åŠ¨æ€æ•°æ®æº**

```java
@Bean
public DataSource dynamicDataSource() {
    DynamicDataSource dynamic = new DynamicDataSource();
    
    // è®¾ç½®æ‰€æœ‰æ•°æ®æº
    Map<Object, Object> targetDataSources = new HashMap<>();
    targetDataSources.put("primary", primaryDataSource());
    targetDataSources.put("secondary", secondaryDataSource());
    
    dynamic.setTargetDataSources(targetDataSources);
    dynamic.setDefaultTargetDataSource(primaryDataSource());
    
    return dynamic;
}
```

### 3.4 ä½¿ç”¨æ–¹å¼


**æ–¹å¼1ï¼šæ‰‹åŠ¨åˆ‡æ¢**

```java
// ä½¿ç”¨ä¸»æ•°æ®æº
DataSourceContextHolder.setDataSource("primary");
User user = userDao.findById(1L);
DataSourceContextHolder.clear();

// ä½¿ç”¨ä»æ•°æ®æº
DataSourceContextHolder.setDataSource("secondary");
Order order = orderDao.findById(1L);
DataSourceContextHolder.clear();
```

**æ–¹å¼2ï¼šæ³¨è§£åˆ‡æ¢ï¼ˆæ›´ä¼˜é›…ï¼‰**

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface DataSource {
    String value() default "primary";
}

// ä½¿ç”¨æ³¨è§£
@Service
public class UserService {
    
    @DataSource("primary")  // è‡ªåŠ¨åˆ‡æ¢åˆ°primaryæ•°æ®æº
    public User getUser(Long id) {
        return userRepository.findById(id);
    }
    
    @DataSource("secondary")  // è‡ªåŠ¨åˆ‡æ¢åˆ°secondaryæ•°æ®æº
    public Order getOrder(Long id) {
        return orderRepository.findById(id);
    }
}
```

---

## 4. ğŸ“– è¯»å†™åˆ†ç¦»å®æˆ˜


### 4.1 è¯»å†™åˆ†ç¦»åŸç†


**ä»€ä¹ˆæ˜¯è¯»å†™åˆ†ç¦»**ï¼Ÿ

```
æ²¡æœ‰è¯»å†™åˆ†ç¦»ï¼š
æ‰€æœ‰æ“ä½œ â†’ ä¸€ä¸ªæ•°æ®åº“ï¼ˆå‹åŠ›å¤§ï¼‰

è¯»å†™åˆ†ç¦»åï¼š
å†™æ“ä½œ(INSERT/UPDATE/DELETE) â†’ ä¸»åº“ï¼ˆMasterï¼‰
è¯»æ“ä½œ(SELECT)                â†’ ä»åº“ï¼ˆSlaveï¼‰

å¥½å¤„ï¼š
âœ… ä¸»åº“ä¸“æ³¨å†™æ“ä½œï¼Œæ€§èƒ½æå‡
âœ… å¤šä¸ªä»åº“åˆ†æ‹…è¯»å‹åŠ›
âœ… æ•°æ®åº“å‹åŠ›åˆ†æ•£
```

**æ•°æ®åŒæ­¥æœºåˆ¶**ï¼š

```
ä¸»åº“å†™å…¥æ•°æ® â†’ è‡ªåŠ¨åŒæ­¥åˆ°ä»åº“

ä¸»åº“(Master)
    â†“ åŒæ­¥
ä»åº“1(Slave1)
ä»åº“2(Slave2)
ä»åº“3(Slave3)
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼šåŒæ­¥æœ‰å»¶è¿Ÿï¼ˆæ¯«ç§’åˆ°ç§’çº§ï¼‰ï¼Œéœ€è¦è€ƒè™‘æ•°æ®ä¸€è‡´æ€§

### 4.2 é…ç½®è¯»å†™åˆ†ç¦»


**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
spring:
  datasource:
    master:  # ä¸»åº“
      url: jdbc:mysql://192.168.1.100:3306/mydb
      username: root
      password: 123456
    
    slave1:  # ä»åº“1
      url: jdbc:mysql://192.168.1.101:3306/mydb
      username: root
      password: 123456
    
    slave2:  # ä»åº“2
      url: jdbc:mysql://192.168.1.102:3306/mydb
      username: root
      password: 123456
```

### 4.3 å®ç°è¯»å†™è·¯ç”±


```java
public class ReadWriteDataSource extends AbstractRoutingDataSource {
    
    @Override
    protected Object determineCurrentLookupKey() {
        // åˆ¤æ–­æ˜¯è¯»æ“ä½œè¿˜æ˜¯å†™æ“ä½œ
        if (DataSourceContextHolder.isRead()) {
            // è¯»æ“ä½œï¼šä»å¤šä¸ªslaveä¸­éšæœºé€‰ä¸€ä¸ªï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
            return chooseSlaveRandomly();
        } else {
            // å†™æ“ä½œï¼šä½¿ç”¨master
            return "master";
        }
    }
    
    private String chooseSlaveRandomly() {
        List<String> slaves = Arrays.asList("slave1", "slave2");
        int index = new Random().nextInt(slaves.size());
        return slaves.get(index);
    }
}
```

### 4.4 å®é™…ä½¿ç”¨


```java
@Service
public class ProductService {
    
    @ReadOnly  // è‡ªå®šä¹‰æ³¨è§£ï¼Œæ ‡è®°ä¸ºè¯»æ“ä½œ
    public Product getProduct(Long id) {
        // è‡ªåŠ¨è·¯ç”±åˆ°slaveåº“
        return productRepository.findById(id);
    }
    
    @Transactional  // å†™æ“ä½œ
    public void saveProduct(Product product) {
        // è‡ªåŠ¨è·¯ç”±åˆ°masteråº“
        productRepository.save(product);
    }
}
```

---

## 5. âš¡ æ°´å¹³åˆ†ç‰‡è¯¦è§£


### 5.1 ä»€ä¹ˆæ˜¯æ°´å¹³åˆ†ç‰‡


**é€šä¿—è§£é‡Š**ï¼šæŠŠä¸€å¼ å¤§è¡¨çš„æ•°æ®æŒ‰è¡Œæ‹†åˆ†åˆ°å¤šä¸ªåº“ï¼Œå°±åƒæŠŠä¸€æ‘ä¹¦åˆ†æˆå‡ å †ã€‚

```
åŸå§‹æƒ…å†µï¼ˆå•è¡¨ï¼‰ï¼š
ç”¨æˆ·è¡¨ï¼ˆ1000ä¸‡æ¡æ•°æ®ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id  â”‚ name â”‚ age â”‚
â”‚ 1   â”‚ å¼ ä¸‰  â”‚ 20  â”‚
â”‚ 2   â”‚ æå››  â”‚ 25  â”‚
â”‚ ... â”‚ ...  â”‚ ... â”‚
â”‚1000ä¸‡â”‚ ...  â”‚ ... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ°´å¹³åˆ†ç‰‡åï¼š
DB1: ç”¨æˆ·è¡¨1ï¼ˆ1-333ä¸‡ï¼‰
DB2: ç”¨æˆ·è¡¨2ï¼ˆ334-666ä¸‡ï¼‰
DB3: ç”¨æˆ·è¡¨3ï¼ˆ667-1000ä¸‡ï¼‰

æ¯ä¸ªåº“çš„è¡¨ç»“æ„ç›¸åŒï¼Œæ•°æ®ä¸åŒ
```

### 5.2 åˆ†ç‰‡ç­–ç•¥


**ğŸ”¹ å¸¸ç”¨åˆ†ç‰‡è§„åˆ™**ï¼š

**1. å–æ¨¡åˆ†ç‰‡ï¼ˆæœ€å¸¸ç”¨ï¼‰**

```java
// æ ¹æ®ç”¨æˆ·IDå–æ¨¡
int dbIndex = userId % 3;  // 3ä¸ªæ•°æ®åº“

ç¤ºä¾‹ï¼š
userId = 10001 â†’ 10001 % 3 = 1 â†’ DB1
userId = 10002 â†’ 10002 % 3 = 2 â†’ DB2
userId = 10003 â†’ 10003 % 3 = 0 â†’ DB0
```

> âœ… **ä¼˜ç‚¹**ï¼šç®€å•ï¼Œæ•°æ®åˆ†å¸ƒå‡åŒ€  
> âŒ **ç¼ºç‚¹**ï¼šæ‰©å®¹å›°éš¾ï¼ˆå¢åŠ åº“éœ€è¦é‡æ–°å–æ¨¡ï¼‰

**2. èŒƒå›´åˆ†ç‰‡**

```java
// æ ¹æ®IDèŒƒå›´åˆ†é…
if (userId <= 100_0000) {
    return "DB1";
} else if (userId <= 200_0000) {
    return "DB2";
} else {
    return "DB3";
}
```

> âœ… **ä¼˜ç‚¹**ï¼šæ‰©å®¹æ–¹ä¾¿ï¼ŒèŒƒå›´æŸ¥è¯¢æ•ˆç‡é«˜  
> âŒ **ç¼ºç‚¹**ï¼šå¯èƒ½æ•°æ®åˆ†å¸ƒä¸å‡ï¼ˆæ–°ç”¨æˆ·å¤šåœ¨åé¢çš„åº“ï¼‰

**3. å“ˆå¸Œåˆ†ç‰‡**

```java
// ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œ
int hash = userId.hashCode();
int dbIndex = Math.abs(hash) % dbCount;
```

### 5.3 å®ç°æ°´å¹³åˆ†ç‰‡


```java
@Component
public class ShardingStrategy {
    
    private static final int DB_COUNT = 3;
    
    // æ ¹æ®ç”¨æˆ·IDç¡®å®šæ•°æ®æº
    public String determineDataSource(Long userId) {
        int index = (int) (userId % DB_COUNT);
        return "user_db_" + index;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class UserService {
    
    @Autowired
    private ShardingStrategy shardingStrategy;
    
    public User getUser(Long userId) {
        // æ ¹æ®userIdç¡®å®šæ•°æ®æº
        String dataSource = shardingStrategy.determineDataSource(userId);
        DataSourceContextHolder.setDataSource(dataSource);
        
        try {
            return userRepository.findById(userId);
        } finally {
            DataSourceContextHolder.clear();
        }
    }
}
```

### 5.4 è·¨åº“æŸ¥è¯¢é—®é¢˜


**æŒ‘æˆ˜**ï¼šæ•°æ®åˆ†æ•£åœ¨å¤šä¸ªåº“ï¼Œæ€ä¹ˆæŸ¥è¯¢ï¼Ÿ

```
æŸ¥è¯¢æ¡ä»¶æœ‰åˆ†ç‰‡é”®ï¼ˆuserIdï¼‰ï¼š
â†’ ç›´æ¥å®šä½åˆ°å…·ä½“åº“ï¼Œæ•ˆç‡é«˜

æŸ¥è¯¢æ¡ä»¶æ²¡æœ‰åˆ†ç‰‡é”®ï¼ˆæŒ‰nameæŸ¥è¯¢ï¼‰ï¼š
â†’ éœ€è¦æŸ¥æ‰€æœ‰åº“å†åˆå¹¶ï¼Œæ•ˆç‡ä½
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

| æ–¹æ¡ˆ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **å†—ä½™å­—æ®µ** | åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­åŠ å…¥åˆ†ç‰‡é”® | æŸ¥è¯¢æ—¶èƒ½æä¾›userId |
| **å…¨åº“æ‰«æ** | å¹¶è¡ŒæŸ¥æ‰€æœ‰åº“å†åˆå¹¶ | æ•°æ®é‡å°ï¼ŒæŸ¥è¯¢é¢‘ç‡ä½ |
| **ESæœç´¢** | ç”¨æœç´¢å¼•æ“åšå¤æ‚æŸ¥è¯¢ | å¤æ‚æŸ¥è¯¢åœºæ™¯ |

---

## 6. ğŸ“Š å‚ç›´åˆ†ç‰‡è¯¦è§£


### 6.1 ä»€ä¹ˆæ˜¯å‚ç›´åˆ†ç‰‡


**é€šä¿—è§£é‡Š**ï¼šæŒ‰ä¸šåŠ¡æŠŠä¸åŒè¡¨æ‹†åˆ†åˆ°ä¸åŒåº“ï¼Œå°±åƒæŠŠä¸åŒç§‘ç›®çš„ä¹¦åˆ†ç±»å­˜æ”¾ã€‚

```
åŸå§‹æƒ…å†µï¼ˆæ‰€æœ‰è¡¨åœ¨ä¸€ä¸ªåº“ï¼‰ï¼š
Main_DB
â”œâ”€â”€ ç”¨æˆ·è¡¨
â”œâ”€â”€ è®¢å•è¡¨
â”œâ”€â”€ å•†å“è¡¨
â”œâ”€â”€ æ”¯ä»˜è¡¨
â””â”€â”€ æ—¥å¿—è¡¨

å‚ç›´åˆ†ç‰‡åï¼š
User_DB    â†’ ç”¨æˆ·è¡¨
Order_DB   â†’ è®¢å•è¡¨
Product_DB â†’ å•†å“è¡¨
Pay_DB     â†’ æ”¯ä»˜è¡¨
Log_DB     â†’ æ—¥å¿—è¡¨

æŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ†
```

### 6.2 æ°´å¹³åˆ†ç‰‡ vs å‚ç›´åˆ†ç‰‡


**å¯¹æ¯”ç†è§£**ï¼š

```
æ°´å¹³åˆ†ç‰‡ï¼š
åŒä¸€å¼ è¡¨æ‹†åˆ°å¤šä¸ªåº“
Userè¡¨ â†’ User_DB1, User_DB2, User_DB3
ï¼ˆæ¨ªå‘æ‹†åˆ†æ•°æ®ï¼‰

å‚ç›´åˆ†ç‰‡ï¼š
ä¸åŒè¡¨æ‹†åˆ°ä¸åŒåº“
Userè¡¨ â†’ User_DB
Orderè¡¨ â†’ Order_DB
ï¼ˆçºµå‘æ‹†åˆ†ä¸šåŠ¡ï¼‰

å®é™…åº”ç”¨ï¼š
é€šå¸¸ä¸¤è€…ç»“åˆä½¿ç”¨ï¼
```

**ç»„åˆç¤ºä¾‹**ï¼š

```
å…ˆå‚ç›´åˆ†ç‰‡ï¼ˆæŒ‰ä¸šåŠ¡ï¼‰ï¼š
Userä¸šåŠ¡  â†’ Useråº“ç¾¤
Orderä¸šåŠ¡ â†’ Orderåº“ç¾¤

å†æ°´å¹³åˆ†ç‰‡ï¼ˆæŒ‰æ•°æ®é‡ï¼‰ï¼š
Useråº“ç¾¤ â†’ User_DB1, User_DB2, User_DB3
Orderåº“ç¾¤ â†’ Order_DB1, Order_DB2
```

### 6.3 å‚ç›´åˆ†ç‰‡å®ç°


**é…ç½®å¤šä¸šåŠ¡æ•°æ®æº**ï¼š

```java
@Configuration
public class VerticalShardingConfig {
    
    // ç”¨æˆ·ä¸šåŠ¡æ•°æ®æº
    @Bean
    public DataSource userDataSource() {
        return createDataSource("user_db");
    }
    
    // è®¢å•ä¸šåŠ¡æ•°æ®æº
    @Bean
    public DataSource orderDataSource() {
        return createDataSource("order_db");
    }
    
    // å•†å“ä¸šåŠ¡æ•°æ®æº
    @Bean
    public DataSource productDataSource() {
        return createDataSource("product_db");
    }
}
```

**æŒ‰ä¸šåŠ¡åˆ’åˆ†Repository**ï¼š

```java
// ç”¨æˆ·Repository - ä½¿ç”¨userDataSource
@Repository
public interface UserRepository {
    @PersistenceContext(unitName = "userEntityManager")
    EntityManager em;
}

// è®¢å•Repository - ä½¿ç”¨orderDataSource
@Repository
public interface OrderRepository {
    @PersistenceContext(unitName = "orderEntityManager")
    EntityManager em;
}
```

### 6.4 å‚ç›´åˆ†ç‰‡çš„æŒ‘æˆ˜


**âš ï¸ ä¸»è¦é—®é¢˜**ï¼š

ğŸ”¸ **è·¨åº“å…³è”æŸ¥è¯¢**
```
é—®é¢˜ï¼šç”¨æˆ·è¡¨å’Œè®¢å•è¡¨åœ¨ä¸åŒåº“ï¼Œå¦‚ä½•å…³è”ï¼Ÿ

ä¼ ç»ŸSQLï¼ˆä¸å¯è¡Œï¼‰ï¼š
SELECT * FROM user u 
JOIN order o ON u.id = o.user_id

è§£å†³æ–¹æ¡ˆï¼š
1. åº”ç”¨å±‚å…³è”ï¼ˆå…ˆæŸ¥ç”¨æˆ·ï¼Œå†æŸ¥è®¢å•ï¼Œä»£ç ç»„è£…ï¼‰
2. å†—ä½™å…³è”å­—æ®µï¼ˆorderè¡¨å†—ä½™userä¿¡æ¯ï¼‰
3. æ•°æ®èšåˆå¹³å°ï¼ˆç”¨ä¸­é—´ä»¶èšåˆï¼‰
```

ğŸ”¸ **åˆ†å¸ƒå¼äº‹åŠ¡**
```
é—®é¢˜ï¼šä¸€ä¸ªä¸šåŠ¡æ¶‰åŠå¤šä¸ªåº“çš„ä¿®æ”¹

ç¤ºä¾‹ï¼šä¸‹å•æµç¨‹
â†’ æ‰£å‡å•†å“åº“å­˜ï¼ˆProduct_DBï¼‰
â†’ åˆ›å»ºè®¢å•ï¼ˆOrder_DBï¼‰
â†’ æ‰£å‡ç”¨æˆ·ä½™é¢ï¼ˆUser_DBï¼‰

éœ€è¦ä¿è¯ï¼šè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
```

---

## 7. ğŸ” åˆ†å¸ƒå¼äº‹åŠ¡


### 7.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡


**é€šä¿—ç†è§£**ï¼šå¤šä¸ªæ•°æ®åº“çš„æ“ä½œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥ï¼Œå°±åƒå›¢é˜Ÿåä½œã€‚

```
å•åº“äº‹åŠ¡ï¼ˆç®€å•ï¼‰ï¼š
å¼€å§‹äº‹åŠ¡ â†’ æ“ä½œ1 â†’ æ“ä½œ2 â†’ æäº¤/å›æ»š

åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆå¤æ‚ï¼‰ï¼š
å¼€å§‹äº‹åŠ¡ â†’ DB1æ“ä½œ â†’ DB2æ“ä½œ â†’ DB3æ“ä½œ â†’ å…¨éƒ¨æäº¤/å›æ»š

æŒ‘æˆ˜ï¼šæ€ä¹ˆä¿è¯å¤šä¸ªåº“åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Ÿ
```

### 7.2 ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰


**ğŸ”¹ å·¥ä½œåŸç†**ï¼š

```
é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µï¼ˆPrepareï¼‰
åè°ƒè€… â†’ DB1: èƒ½æäº¤å—ï¼Ÿ
       â†’ DB2: èƒ½æäº¤å—ï¼Ÿ
       â†’ DB3: èƒ½æäº¤å—ï¼Ÿ

DB1/DB2/DB3 â†’ é”å®šèµ„æºï¼Œè¿”å›"å‡†å¤‡å¥½äº†"

é˜¶æ®µ2ï¼šæäº¤é˜¶æ®µï¼ˆCommitï¼‰
å¦‚æœéƒ½å‡†å¤‡å¥½ï¼š
åè°ƒè€… â†’ DB1/DB2/DB3: æ‰§è¡Œæäº¤

å¦‚æœæœ‰ä»»ä½•å¤±è´¥ï¼š
åè°ƒè€… â†’ DB1/DB2/DB3: æ‰§è¡Œå›æ»š
```

**ä»£ç ç¤ºä¾‹**ï¼š

```java
@Service
public class OrderService {
    
    @Transactional
    @GlobalTransactional  // Seataåˆ†å¸ƒå¼äº‹åŠ¡æ³¨è§£
    public void createOrder(Order order) {
        // æ‰£å‡åº“å­˜ï¼ˆProduct_DBï¼‰
        productService.reduceStock(order.getProductId());
        
        // åˆ›å»ºè®¢å•ï¼ˆOrder_DBï¼‰
        orderRepository.save(order);
        
        // æ‰£å‡ä½™é¢ï¼ˆUser_DBï¼‰
        userService.reduceBalance(order.getUserId(), order.getAmount());
        
        // ä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œå…¨éƒ¨å›æ»š
    }
}
```

> âš ï¸ **2PCç¼ºç‚¹**ï¼š
> - æ€§èƒ½å·®ï¼šé”å®šæ—¶é—´é•¿
> - åŒæ­¥é˜»å¡ï¼šç­‰å¾…æ‰€æœ‰å‚ä¸è€…å“åº”
> - å•ç‚¹æ•…éšœï¼šåè°ƒè€…æŒ‚äº†æ€ä¹ˆåŠ

### 7.3 TCCäº‹åŠ¡æ¨¡å¼


**ä»€ä¹ˆæ˜¯TCC**ï¼Ÿ

```
TCC = Try-Confirm-Cancel

Tryé˜¶æ®µï¼š    é¢„ç•™èµ„æºï¼ˆä¸çœŸæ­£æ‰§è¡Œï¼‰
Confirmé˜¶æ®µï¼šç¡®è®¤æ‰§è¡Œï¼ˆæäº¤ï¼‰
Cancelé˜¶æ®µï¼š å–æ¶ˆæ‰§è¡Œï¼ˆå›æ»šï¼‰
```

**å®é™…åº”ç”¨**ï¼š

```java
// æ‰£æ¬¾æœåŠ¡
public class AccountService {
    
    // Try: å†»ç»“é‡‘é¢
    public boolean tryDeduct(Long userId, BigDecimal amount) {
        Account account = getAccount(userId);
        if (account.getBalance() >= amount) {
            account.setFrozen(account.getFrozen() + amount);
            return true;
        }
        return false;
    }
    
    // Confirm: çœŸæ­£æ‰£æ¬¾
    public void confirmDeduct(Long userId, BigDecimal amount) {
        Account account = getAccount(userId);
        account.setBalance(account.getBalance() - amount);
        account.setFrozen(account.getFrozen() - amount);
    }
    
    // Cancel: è§£å†»é‡‘é¢
    public void cancelDeduct(Long userId, BigDecimal amount) {
        Account account = getAccount(userId);
        account.setFrozen(account.getFrozen() - amount);
    }
}
```

> ğŸ’¡ **TCCä¼˜ç‚¹**ï¼š
> - æ— é”ï¼Œæ€§èƒ½å¥½
> - çµæ´»æ€§é«˜
> 
> âŒ **TCCç¼ºç‚¹**ï¼š
> - ä»£ç å¤æ‚åº¦é«˜
> - éœ€è¦ä¸šåŠ¡é…åˆ

### 7.4 æœ€ç»ˆä¸€è‡´æ€§ï¼ˆæ¨èï¼‰


**æ ¸å¿ƒæ€æƒ³**ï¼šå…è®¸çŸ­æš‚ä¸ä¸€è‡´ï¼Œæœ€ç»ˆè¾¾åˆ°ä¸€è‡´ã€‚

```
å¼ºä¸€è‡´æ€§ï¼ˆ2PCï¼‰ï¼š
æ“ä½œå®Œæˆæ—¶ï¼Œæ‰€æœ‰åº“æ•°æ®ä¸€è‡´ï¼ˆå®æ—¶ï¼‰

æœ€ç»ˆä¸€è‡´æ€§ï¼š
æ“ä½œå®Œæˆæ—¶ï¼Œå¯èƒ½ä¸ä¸€è‡´
ä½†ç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œæœ€ç»ˆä¼šä¸€è‡´

ç±»æ¯”ï¼š
å¼ºä¸€è‡´æ€§ = å®æ—¶åŒæ­¥é€šè¯
æœ€ç»ˆä¸€è‡´æ€§ = å¼‚æ­¥æ¶ˆæ¯ï¼ˆå»¶è¿Ÿä½†ä¼šæ”¶åˆ°ï¼‰
```

**å®ç°æ–¹å¼ï¼šæ¶ˆæ¯é˜Ÿåˆ—**

```java
@Service
public class OrderService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void createOrder(Order order) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
        orderRepository.save(order);
        
        // 2. å‘é€æ¶ˆæ¯é€šçŸ¥å…¶ä»–æœåŠ¡
        rabbitTemplate.convertAndSend("order.created", order);
    }
}

// åº“å­˜æœåŠ¡ç›‘å¬æ¶ˆæ¯
@Component
public class StockListener {
    
    @RabbitListener(queues = "order.created")
    public void handleOrderCreated(Order order) {
        // å¼‚æ­¥æ‰£å‡åº“å­˜
        stockService.reduceStock(order.getProductId());
    }
}
```

**ä¼˜ç¼ºç‚¹å¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | ä¸€è‡´æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|--------|------|--------|----------|
| **2PC** | å¼ºä¸€è‡´ | å·® | ä¸­ | é‡‘èæ ¸å¿ƒä¸šåŠ¡ |
| **TCC** | å¼ºä¸€è‡´ | å¥½ | é«˜ | å¯¹ä¸€è‡´æ€§è¦æ±‚é«˜çš„ä¸šåŠ¡ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | æœ€ç»ˆä¸€è‡´ | å¾ˆå¥½ | ä½ | å¤§éƒ¨åˆ†äº’è”ç½‘ä¸šåŠ¡ |

---

## 8. âœ… æ•°æ®ä¸€è‡´æ€§ä¿éšœ


### 8.1 ä¸»ä»åŒæ­¥å»¶è¿Ÿ


**é—®é¢˜åœºæ™¯**ï¼š

```
æ—¶åˆ»1: å‘ä¸»åº“å†™å…¥æ•°æ®
      â†“
æ—¶åˆ»2: æ•°æ®åŒæ­¥åˆ°ä»åº“ï¼ˆå»¶è¿Ÿ100msï¼‰
      â†“
é—®é¢˜: å¦‚æœç«‹å³è¯»ä»åº“ï¼Œå¯èƒ½è¯»åˆ°æ—§æ•°æ®
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ1ï¼šå¼ºåˆ¶è¯»ä¸»åº“**
```java
@Service
public class UserService {
    
    public void updateUser(User user) {
        // æ›´æ–°ä¸»åº“
        masterRepository.save(user);
    }
    
    public User getUser(Long id) {
        // åˆšæ›´æ–°åçš„æŸ¥è¯¢ï¼Œå¼ºåˆ¶è¯»ä¸»åº“
        if (isJustUpdated(id)) {
            return masterRepository.findById(id);
        }
        // å¦åˆ™è¯»ä»åº“
        return slaveRepository.findById(id);
    }
}
```

**æ–¹æ¡ˆ2ï¼šå»¶è¿Ÿè¯»å–**
```java
public User getUserAfterUpdate(Long id) {
    // ç­‰å¾…åŒæ­¥å®Œæˆ
    Thread.sleep(200);  // ç®€å•ç²—æš´
    return slaveRepository.findById(id);
}
```

**æ–¹æ¡ˆ3ï¼šç‰ˆæœ¬å·æœºåˆ¶**
```java
// å†™å…¥æ—¶å¸¦ç‰ˆæœ¬å·
user.setVersion(System.currentTimeMillis());
masterRepository.save(user);

// è¯»å–æ—¶å¯¹æ¯”ç‰ˆæœ¬
User user = slaveRepository.findById(id);
if (user.getVersion() < expectedVersion) {
    // ä»åº“æ•°æ®è¿‡æœŸï¼Œè¯»ä¸»åº“
    return masterRepository.findById(id);
}
```

### 8.2 åˆ†ç‰‡æ•°æ®èšåˆ


**æŒ‘æˆ˜**ï¼šæ•°æ®åˆ†æ•£åœ¨å¤šä¸ªåº“ï¼Œå¦‚ä½•ç»Ÿè®¡ï¼Ÿ

```
éœ€æ±‚ï¼šç»Ÿè®¡æ€»ç”¨æˆ·æ•°

åˆ†ç‰‡æƒ…å†µï¼š
DB1: 100ä¸‡ç”¨æˆ·
DB2: 150ä¸‡ç”¨æˆ·  
DB3: 200ä¸‡ç”¨æˆ·

å¦‚ä½•å¾—åˆ°æ€»æ•°ï¼Ÿ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ1ï¼šå¹¶è¡ŒæŸ¥è¯¢åˆå¹¶**
```java
public long getTotalUserCount() {
    List<String> dataSources = Arrays.asList("db1", "db2", "db3");
    
    // å¹¶è¡ŒæŸ¥è¯¢
    List<Long> counts = dataSources.parallelStream()
        .map(ds -> {
            DataSourceContextHolder.setDataSource(ds);
            return userRepository.count();
        })
        .collect(Collectors.toList());
    
    // æ±‡æ€»ç»“æœ
    return counts.stream().mapToLong(Long::longValue).sum();
}
```

**æ–¹æ¡ˆ2ï¼šæ±‡æ€»è¡¨**
```
å®šæœŸç»Ÿè®¡ï¼š
æ¯å°æ—¶ç»Ÿè®¡å„åˆ†ç‰‡æ•°æ® â†’ å†™å…¥æ±‡æ€»è¡¨

æŸ¥è¯¢æ—¶ï¼š
ç›´æ¥æŸ¥æ±‡æ€»è¡¨ï¼ˆç‰ºç‰²å®æ—¶æ€§ï¼Œæ¢å–æ€§èƒ½ï¼‰
```

### 8.3 æ•°æ®è¿ç§»


**åœºæ™¯**ï¼šæ‰©å®¹å¢åŠ æ•°æ®åº“ï¼Œéœ€è¦é‡æ–°åˆ†ç‰‡

```
åŸæœ‰3ä¸ªåº“ï¼š
DB1, DB2, DB3

æ‰©å®¹åˆ°5ä¸ªåº“ï¼š
DB1, DB2, DB3, DB4, DB5

é—®é¢˜ï¼šæ•°æ®è¦é‡æ–°åˆ†é…
```

**è¿ç§»æ­¥éª¤**ï¼š

```
æ­¥éª¤1: åŒå†™ç­–ç•¥
      æ–°æ•°æ®åŒæ—¶å†™æ—§åº“å’Œæ–°åº“

æ­¥éª¤2: æ•°æ®è¿ç§»
      åå°ä»»åŠ¡è¿ç§»æ—§æ•°æ®

æ­¥éª¤3: éªŒè¯æ•°æ®
      å¯¹æ¯”æ–°æ—§åº“æ•°æ®ä¸€è‡´æ€§

æ­¥éª¤4: åˆ‡æ¢è¯»å–
      é€æ­¥åˆ‡æ¢åˆ°æ–°åº“

æ­¥éª¤5: ä¸‹çº¿æ—§åº“
      æ•°æ®è¿ç§»å®Œæˆï¼Œä¸‹çº¿æ—§åº“
```

**å¹³æ»‘è¿ç§»ç¤ºä¾‹**ï¼š

```java
@Service
public class MigrationService {
    
    private boolean migrationMode = true;  // è¿ç§»æ¨¡å¼å¼€å…³
    
    public void saveUser(User user) {
        if (migrationMode) {
            // åŒå†™ï¼šåŒæ—¶å†™æ–°æ—§åº“
            saveToOldDB(user);
            saveToNewDB(user);
        } else {
            // åªå†™æ–°åº“
            saveToNewDB(user);
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å…³é”®æ¦‚å¿µå›é¡¾


**ğŸ”¸ å¤šæ•°æ®æºæ ¸å¿ƒ**
```
å¤šæ•°æ®æº = ä¸€ä¸ªåº”ç”¨è¿æ¥å¤šä¸ªæ•°æ®åº“
ç›®çš„ï¼šä¸šåŠ¡éš”ç¦»ã€æ€§èƒ½æå‡ã€æ•°æ®åˆ†æ•£
å®ç°ï¼šé…ç½®å¤šä¸ªDataSource + åŠ¨æ€åˆ‡æ¢
```

**ğŸ”¸ è¯»å†™åˆ†ç¦»æœ¬è´¨**
```
ä¸»åº“(Master) â†’ è´Ÿè´£å†™
ä»åº“(Slave)  â†’ è´Ÿè´£è¯»
ä¼˜åŠ¿ï¼šåˆ†æ•£å‹åŠ›ï¼Œæå‡æ€§èƒ½
æ³¨æ„ï¼šä¸»ä»å»¶è¿Ÿé—®é¢˜
```

**ğŸ”¸ åˆ†ç‰‡ç­–ç•¥å¯¹æ¯”**

| ç±»å‹ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| **æ°´å¹³åˆ†ç‰‡** | åŒè¡¨æ•°æ®æ‹†åˆ°å¤šåº“ | å•è¡¨æ•°æ®é‡å¤§ |
| **å‚ç›´åˆ†ç‰‡** | ä¸åŒè¡¨æ‹†åˆ°ä¸åŒåº“ | æŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ† |
| **ä¸¤è€…ç»“åˆ** | å…ˆå‚ç›´å†æ°´å¹³ | å¤§å‹ç³»ç»Ÿ |

**ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡é€‰æ‹©**

```
é‡‘èç³»ç»Ÿ     â†’ 2PCï¼ˆå¼ºä¸€è‡´ï¼‰
æ™®é€šä¸šåŠ¡     â†’ TCCï¼ˆæ€§èƒ½å¥½ï¼‰
äº’è”ç½‘ç³»ç»Ÿ   â†’ æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆæœ€ç»ˆä¸€è‡´ï¼‰
```

### 9.2 å®æˆ˜å»ºè®®


**âœ… æœ€ä½³å®è·µ**ï¼š

1. **èƒ½ä¸åˆ†å°±ä¸åˆ†**
   - å•åº“èƒ½æ’‘ä½å°±ç”¨å•åº“
   - è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æº

2. **åˆ†ç‰‡ç­–ç•¥é€‰æ‹©**
   - ä¼˜å…ˆæŒ‰ä¸šåŠ¡å‚ç›´åˆ†ç‰‡
   - æ•°æ®é‡å¤§å†æ°´å¹³åˆ†ç‰‡

3. **ä¸€è‡´æ€§æƒè¡¡**
   - ä¸æ˜¯æ‰€æœ‰åœºæ™¯éƒ½éœ€è¦å¼ºä¸€è‡´
   - å¤§éƒ¨åˆ†å¯ä»¥æ¥å—æœ€ç»ˆä¸€è‡´

4. **ç›‘æ§å¾ˆé‡è¦**
   - ç›‘æ§ä¸»ä»å»¶è¿Ÿ
   - ç›‘æ§å„åˆ†ç‰‡è´Ÿè½½
   - åŠæ—¶å‘ç°é—®é¢˜

**âš ï¸ å¸¸è§é™·é˜±**ï¼š

```
âŒ è¿‡åº¦åˆ†ç‰‡ï¼šæ•°æ®é‡ä¸å¤§å°±åˆ†ç‰‡
âŒ æ²¡æœ‰å›æ»šæ–¹æ¡ˆï¼šè¿ç§»å¤±è´¥æ— æ³•å›é€€  
âŒ å¿½è§†å»¶è¿Ÿï¼šä¸»ä»å»¶è¿Ÿå¯¼è‡´è¯»åˆ°è„æ•°æ®
âŒ è·¨åº“å…³è”ï¼šåˆ†ç‰‡åå¤§é‡è·¨åº“æŸ¥è¯¢
```

### 9.3 æŠ€æœ¯é€‰å‹å‚è€ƒ


**å¼€æºæ–¹æ¡ˆæ¨è**ï¼š

| å·¥å…· | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **ShardingSphere** | åŠŸèƒ½å…¨é¢ï¼Œæ˜“ç”¨ | ä¸­å°å‹é¡¹ç›® |
| **Seata** | åˆ†å¸ƒå¼äº‹åŠ¡ | éœ€è¦äº‹åŠ¡ä¿è¯ |
| **Canal** | MySQLæ•°æ®åŒæ­¥ | æ•°æ®åŒæ­¥åœºæ™¯ |
| **MyCat** | æ•°æ®åº“ä¸­é—´ä»¶ | å¤æ‚åˆ†ç‰‡ |

**å­¦ä¹ è·¯å¾„**ï¼š

```
åŸºç¡€é˜¶æ®µï¼š
â†’ æŒæ¡å•æ•°æ®æºé…ç½®
â†’ ç†è§£å¤šæ•°æ®æºåˆ‡æ¢

è¿›é˜¶é˜¶æ®µï¼š
â†’ å®ç°è¯»å†™åˆ†ç¦»
â†’ æŒæ¡åˆ†ç‰‡ç­–ç•¥

é«˜çº§é˜¶æ®µï¼š
â†’ åˆ†å¸ƒå¼äº‹åŠ¡
â†’ æ•°æ®ä¸€è‡´æ€§ä¿éšœ
```

---

> ğŸ’¡ **å­¦ä¹ å°è´´å£«**ï¼š
> - å¤šæ•°æ®æºä¸æ˜¯é“¶å¼¹ï¼Œè¦æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©
> - åˆ†å¸ƒå¼å¸¦æ¥çš„å¤æ‚åº¦è¿œè¶…æƒ³è±¡ï¼Œå¾ªåºæ¸è¿›
> - å®è·µæ˜¯æœ€å¥½çš„è€å¸ˆï¼ŒåŠ¨æ‰‹æ­å»ºä¸€ä¸ªdemo
> - å…³æ³¨å¼€æºæ–¹æ¡ˆï¼Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š

**æ ¸å¿ƒè®°å¿†**ï¼š
- ğŸ”¸ å¤šæ•°æ®æºè§£å†³æ€§èƒ½å’Œéš”ç¦»é—®é¢˜
- ğŸ”¸ è¯»å†™åˆ†ç¦»è¦æ³¨æ„ä¸»ä»å»¶è¿Ÿ
- ğŸ”¸ æ°´å¹³åˆ†ç‰‡æŒ‰æ•°æ®ï¼Œå‚ç›´åˆ†ç‰‡æŒ‰ä¸šåŠ¡
- ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡é€‰æ‹©çœ‹åœºæ™¯éœ€æ±‚
- ğŸ”¸ æ•°æ®ä¸€è‡´æ€§éœ€è¦æƒè¡¡å’Œç›‘æ§