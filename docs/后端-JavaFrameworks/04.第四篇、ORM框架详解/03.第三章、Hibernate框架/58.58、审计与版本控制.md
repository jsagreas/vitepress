---
title: 58ã€å®¡è®¡ä¸ç‰ˆæœ¬æ§åˆ¶
---
## ğŸ“š ç›®å½•

1. [å®¡è®¡ä¸ç‰ˆæœ¬ç®¡ç†æ¦‚è¿°](#1-å®¡è®¡ä¸ç‰ˆæœ¬ç®¡ç†æ¦‚è¿°)
2. [Hibernate Enversæ ¸å¿ƒæ¦‚å¿µ](#2-Hibernate-Enversæ ¸å¿ƒæ¦‚å¿µ)
3. [@Auditedå®¡è®¡æ³¨è§£è¯¦è§£](#3-Auditedå®¡è®¡æ³¨è§£è¯¦è§£)
4. [å®¡è®¡è¡¨è®¾è®¡ä¸è‡ªåŠ¨ç”Ÿæˆ](#4-å®¡è®¡è¡¨è®¾è®¡ä¸è‡ªåŠ¨ç”Ÿæˆ)
5. [å†å²ç‰ˆæœ¬æŸ¥è¯¢æ“ä½œ](#5-å†å²ç‰ˆæœ¬æŸ¥è¯¢æ“ä½œ)
6. [ç‰ˆæœ¬æ•°æ®ç®¡ç†ç­–ç•¥](#6-ç‰ˆæœ¬æ•°æ®ç®¡ç†ç­–ç•¥)
7. [å®¡è®¡é…ç½®ä¸ä¼˜åŒ–](#7-å®¡è®¡é…ç½®ä¸ä¼˜åŒ–)
8. [æ€§èƒ½è€ƒè™‘ä¸æœ€ä½³å®è·µ](#8-æ€§èƒ½è€ƒè™‘ä¸æœ€ä½³å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” å®¡è®¡ä¸ç‰ˆæœ¬ç®¡ç†æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®å®¡è®¡


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ åœ¨ç”¨Wordå†™æ–‡æ¡£ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•"è°åœ¨ä»€ä¹ˆæ—¶å€™åšäº†ä»€ä¹ˆä¿®æ”¹"ï¼Œè¿™å°±æ˜¯å®¡è®¡çš„æ ¸å¿ƒæ€æƒ³ã€‚

```
ç°å®åœºæ™¯ç±»æ¯”ï¼š

é“¶è¡Œè´¦æˆ·æ“ä½œè®°å½•ï¼š
2025-01-01 10:30  å¼ ä¸‰  å­˜æ¬¾  +1000å…ƒ
2025-01-02 14:20  å¼ ä¸‰  å–æ¬¾  -500å…ƒ
2025-01-03 09:15  å¼ ä¸‰  è½¬è´¦  -200å…ƒ

æ•°æ®åº“å®¡è®¡ä¹Ÿæ˜¯åŒæ ·é“ç†ï¼š
è®°å½•æ¯æ¡æ•°æ®çš„"è°ã€ä½•æ—¶ã€åšäº†ä»€ä¹ˆ"
```

**æ ¸å¿ƒä»·å€¼**ï¼š
- âœ… **è¿½æº¯å†å²**ï¼šçŸ¥é“æ•°æ®æ˜¯æ€ä¹ˆå˜æˆç°åœ¨è¿™æ ·çš„
- âœ… **è´£ä»»è¿½è¸ª**ï¼šæ˜ç¡®è°ä¿®æ”¹äº†æ•°æ®
- âœ… **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³æ³•å¾‹æ³•è§„å¯¹æ•°æ®è®°å½•çš„è¦æ±‚
- âœ… **æ•°æ®æ¢å¤**ï¼šå‡ºé—®é¢˜æ—¶å¯ä»¥å›é€€åˆ°å†å²ç‰ˆæœ¬

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å®¡è®¡


**ä¸šåŠ¡åœºæ™¯éœ€æ±‚**ï¼š

| åœºæ™¯ | å®¡è®¡éœ€æ±‚ | å®é™…ä¾‹å­ |
|------|---------|---------|
| ğŸ’° **é‡‘èç³»ç»Ÿ** | `æ³•å¾‹å¼ºåˆ¶è¦æ±‚` | æ¯ç¬”äº¤æ˜“éƒ½è¦æœ‰å®Œæ•´è®°å½•ï¼Œä¿å­˜7å¹´ä»¥ä¸Š |
| ğŸ¥ **åŒ»ç–—ç³»ç»Ÿ** | `åŒ»ç–—çº çº·ä¸¾è¯` | ç—…å†ä¿®æ”¹è®°å½•ï¼Œè°æ”¹äº†ä»€ä¹ˆå†…å®¹ |
| ğŸ“ **åˆåŒç®¡ç†** | `ç‰ˆæœ¬è¿½æº¯` | åˆåŒæ¡æ¬¾çš„æ¯æ¬¡ä¿®æ”¹éƒ½è¦ç•™ç—• |
| ğŸ›’ **ç”µå•†è®¢å•** | `çº çº·å¤„ç†` | è®¢å•çŠ¶æ€å˜æ›´å†å²è®°å½• |

### 1.3 ç‰ˆæœ¬ç®¡ç† vs å®¡è®¡


```
ç‰ˆæœ¬ç®¡ç†ï¼š          å®¡è®¡æ—¥å¿—ï¼š
å¼ºè°ƒæ•°æ®å¿«ç…§        å¼ºè°ƒæ“ä½œè®°å½•

è®¢å•V1 â†’ è®¢å•V2    2025-01-01 åˆ›å»ºè®¢å•
      â†’ è®¢å•V3    2025-01-02 ä¿®æ”¹é‡‘é¢
                  2025-01-03 å–æ¶ˆè®¢å•

ä¾§é‡ï¼šæ•°æ®æœ¬èº«      ä¾§é‡ï¼šè°åšçš„ã€ä½•æ—¶åšçš„
```

---

## 2. ğŸ¯ Hibernate Enversæ ¸å¿ƒæ¦‚å¿µ


### 2.1 Enversæ˜¯ä»€ä¹ˆ


> ğŸ’¡ **æ ¸å¿ƒå®šä¹‰**ï¼šHibernate Envers æ˜¯ Hibernate çš„å®¡è®¡æ¨¡å—ï¼Œè‡ªåŠ¨ä¸ºä½ çš„å®ä½“ç±»ç”Ÿæˆå†å²ç‰ˆæœ¬è®°å½•ã€‚

**ç®€å•ç†è§£**ï¼šå°±åƒç»™ä½ çš„æ•°æ®è¡¨åŠ äº†ä¸€ä¸ª"æ—¶å…‰æœº"ï¼Œèƒ½çœ‹åˆ°æ•°æ®çš„è¿‡å»æ ·å­ã€‚

```
åŸå§‹è¡¨ï¼šuser
id  name    age
1   å¼ ä¸‰    25

åŠ ä¸ŠEnversåè‡ªåŠ¨ç”Ÿæˆå®¡è®¡è¡¨ï¼šuser_aud
id  name    age  rev  revtype
1   å¼ ä¸‰    25   1    0        â† åˆ›å»ºæ—¶çš„è®°å½•
1   æå››    25   2    1        â† ä¿®æ”¹nameåçš„è®°å½•
1   æå››    26   3    1        â† ä¿®æ”¹ageåçš„è®°å½•
```

### 2.2 æ ¸å¿ƒç»„ä»¶


**ğŸ”¸ ä¸‰å¼ å…³é”®è¡¨**ï¼š

â‘  **ä¸šåŠ¡è¡¨**ï¼ˆåŸè¡¨ï¼‰
```
user è¡¨ï¼šå­˜å‚¨å½“å‰æœ€æ–°æ•°æ®
id | name | age
1  | æå›› | 26   â† å½“å‰çŠ¶æ€
```

â‘¡ **å®¡è®¡è¡¨**ï¼ˆ_audè¡¨ï¼‰
```
user_aud è¡¨ï¼šå­˜å‚¨æ‰€æœ‰å†å²ç‰ˆæœ¬
id | name | age | rev | revtype
1  | å¼ ä¸‰ | 25  | 1   | 0       â† ç‰ˆæœ¬1ï¼šåˆ›å»º
1  | æå›› | 25  | 2   | 1       â† ç‰ˆæœ¬2ï¼šä¿®æ”¹name
1  | æå›› | 26  | 3   | 1       â† ç‰ˆæœ¬3ï¼šä¿®æ”¹age
```

â‘¢ **ç‰ˆæœ¬ä¿¡æ¯è¡¨**ï¼ˆREVINFOï¼‰
```
revinfo è¡¨ï¼šè®°å½•æ¯ä¸ªç‰ˆæœ¬çš„å…ƒæ•°æ®
rev | revtstmp           | username
1   | 2025-01-01 10:00  | admin
2   | 2025-01-02 14:30  | zhangsan
3   | 2025-01-03 09:20  | admin
```

**ğŸ”¸ REVTYPE å«ä¹‰**ï¼š
- `0` = ADDï¼ˆæ–°å¢ï¼‰
- `1` = MODï¼ˆä¿®æ”¹ï¼‰
- `2` = DELï¼ˆåˆ é™¤ï¼‰

### 2.3 å·¥ä½œåŸç†


```
åº”ç”¨ç¨‹åºæ“ä½œæµç¨‹ï¼š

ç”¨æˆ·æ“ä½œ â†’ Hibernateä¿å­˜å®ä½“
              â†“
         Enversç›‘å¬å™¨è§¦å‘
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                   â†“
æ›´æ–°ä¸šåŠ¡è¡¨          æ’å…¥å®¡è®¡è¡¨
(userè¡¨)          (user_audè¡¨)
    â†“                   â†“
ä¿å­˜å½“å‰çŠ¶æ€      è®°å½•å†å²ç‰ˆæœ¬
```

**å…³é”®ç‚¹ç†è§£**ï¼š
- ä¸šåŠ¡è¡¨åªä¿å­˜æœ€æ–°æ•°æ®ï¼ˆè¦†ç›–å¼æ›´æ–°ï¼‰
- å®¡è®¡è¡¨ä¿å­˜æ‰€æœ‰å†å²ï¼ˆè¿½åŠ å¼è®°å½•ï¼‰
- ä¸¤è€…è‡ªåŠ¨åŒæ­¥ï¼Œå¼€å‘è€…æ— éœ€æ‰‹åŠ¨ç»´æŠ¤

---

## 3. ğŸ“ @Auditedå®¡è®¡æ³¨è§£è¯¦è§£


### 3.1 åŸºç¡€ä½¿ç”¨


**â­ å¯ç”¨å®¡è®¡æœ€ç®€å•æ–¹å¼**ï¼šåœ¨å®ä½“ç±»ä¸ŠåŠ  `@Audited`

```java
@Entity
@Audited  // å°±è¿™ä¸€ä¸ªæ³¨è§£ï¼Œå®¡è®¡åŠŸèƒ½å°±å¯ç”¨äº†ï¼
public class User {
    @Id
    @GeneratedValue
    private Long id;
    
    private String name;
    private Integer age;
    
    // getter/setterçœç•¥
}
```

**æ•ˆæœè¯´æ˜**ï¼š
- âœ… è‡ªåŠ¨åˆ›å»º `user_aud` å®¡è®¡è¡¨
- âœ… æ¯æ¬¡å¢åˆ æ”¹éƒ½ä¼šè®°å½•åˆ°å®¡è®¡è¡¨
- âœ… æ‰€æœ‰å­—æ®µéƒ½ä¼šè¢«å®¡è®¡

### 3.2 é€‰æ‹©æ€§å®¡è®¡


**åœºæ™¯**ï¼šæœ‰äº›æ•æ„Ÿå­—æ®µä¸æƒ³è®°å½•å†å²æ€ä¹ˆåŠï¼Ÿ

```java
@Entity
@Audited
public class User {
    @Id
    private Long id;
    
    private String name;
    
    @NotAudited  // è¿™ä¸ªå­—æ®µä¸è®°å½•å†å²
    private String password;
    
    @Audited(targetAuditMode = RelationTargetAuditMode.NOT_AUDITED)
    @ManyToOne
    private Department dept;  // å…³è”å¯¹è±¡ä¸å®¡è®¡
}
```

**ä½¿ç”¨å»ºè®®**ï¼š
- ğŸ” å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ï¼šä½¿ç”¨ `@NotAudited`
- ğŸ“Š ç»Ÿè®¡ç±»å­—æ®µï¼šä¸éœ€è¦å®¡è®¡çš„ç”¨ `@NotAudited`
- ğŸ”— å…³è”å¯¹è±¡ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®šæ˜¯å¦å®¡è®¡

### 3.3 å…³è”å…³ç³»å®¡è®¡


**ğŸ”¸ ä¸€å¯¹å¤šå…³ç³»å®¡è®¡**ï¼š

```java
@Entity
@Audited
public class Order {
    @Id
    private Long id;
    
    private String orderNo;
    
    // è®¢å•é¡¹ä¹Ÿä¼šè¢«å®¡è®¡
    @OneToMany(mappedBy = "order")
    @Audited
    private List<OrderItem> items;
}

@Entity
@Audited
public class OrderItem {
    @Id
    private Long id;
    
    private String productName;
    private Integer quantity;
    
    @ManyToOne
    private Order order;
}
```

**å®¡è®¡è¡¨ç»“æ„**ï¼š
```
order_audï¼šè®°å½•è®¢å•å˜æ›´
order_item_audï¼šè®°å½•è®¢å•é¡¹å˜æ›´
order_order_item_audï¼šè®°å½•å…³è”å…³ç³»å˜æ›´ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
```

### 3.4 å®¡è®¡ç­–ç•¥é€‰é¡¹


| æ³¨è§£å‚æ•° | ä½œç”¨è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|---------|---------|---------|
| `@Audited` | å…¨å­—æ®µå®¡è®¡ | é€šç”¨åœºæ™¯ |
| `@NotAudited` | æ’é™¤å­—æ®µ | æ•æ„Ÿæ•°æ® |
| `modifiedColumnName` | è‡ªå®šä¹‰åˆ—å | ç‰¹æ®Šéœ€æ±‚ |
| `targetAuditMode` | å…³è”å®¡è®¡ç­–ç•¥ | å¤æ‚å…³è” |

---

## 4. ğŸ—„ï¸ å®¡è®¡è¡¨è®¾è®¡ä¸è‡ªåŠ¨ç”Ÿæˆ


### 4.1 å®¡è®¡è¡¨å‘½åè§„åˆ™


**é»˜è®¤å‘½åè§„åˆ™**ï¼š
```
ä¸šåŠ¡è¡¨å + _aud åç¼€

user         â†’ user_aud
order_info   â†’ order_info_aud
sys_config   â†’ sys_config_aud
```

**è‡ªå®šä¹‰è¡¨å**ï¼š
```java
@Entity
@Table(name = "t_user")
@Audited
@AuditTable("t_user_history")  // è‡ªå®šä¹‰å®¡è®¡è¡¨å
public class User {
    // ...
}
```

### 4.2 å®¡è®¡è¡¨ç»“æ„è§£æ


**å®Œæ•´å®¡è®¡è¡¨ç»“æ„ç¤ºä¾‹**ï¼š

```sql
-- åŸä¸šåŠ¡è¡¨
CREATE TABLE user (
    id BIGINT PRIMARY KEY,
    name VARCHAR(50),
    age INT,
    email VARCHAR(100),
    create_time DATETIME
);

-- è‡ªåŠ¨ç”Ÿæˆçš„å®¡è®¡è¡¨
CREATE TABLE user_aud (
    id BIGINT,              -- ä¸šåŠ¡ä¸»é”®ï¼ˆå¤åˆä¸»é”®ä¸€éƒ¨åˆ†ï¼‰
    rev INT,                -- ç‰ˆæœ¬å·ï¼ˆå¤åˆä¸»é”®ä¸€éƒ¨åˆ†ï¼‰
    revtype TINYINT,        -- æ“ä½œç±»å‹ 0æ–°å¢/1ä¿®æ”¹/2åˆ é™¤
    name VARCHAR(50),       -- ä¸šåŠ¡å­—æ®µ
    age INT,                -- ä¸šåŠ¡å­—æ®µ
    email VARCHAR(100),     -- ä¸šåŠ¡å­—æ®µ
    create_time DATETIME,   -- ä¸šåŠ¡å­—æ®µ
    PRIMARY KEY (id, rev),  -- å¤åˆä¸»é”®
    FOREIGN KEY (rev) REFERENCES revinfo(rev)
);

-- ç‰ˆæœ¬ä¿¡æ¯è¡¨
CREATE TABLE revinfo (
    rev INT PRIMARY KEY AUTO_INCREMENT,
    revtstmp BIGINT  -- æ—¶é—´æˆ³
);
```

**å­—æ®µè¯´æ˜**ï¼š
- `rev`ï¼šç‰ˆæœ¬å·ï¼Œå…¨å±€è‡ªå¢
- `revtype`ï¼šæ“ä½œç±»å‹ï¼ˆå¢åˆ æ”¹ï¼‰
- å…¶ä»–å­—æ®µï¼šä¸ä¸šåŠ¡è¡¨å®Œå…¨ä¸€è‡´

### 4.3 æ‰©å±•ç‰ˆæœ¬ä¿¡æ¯è¡¨


**é»˜è®¤REVINFOè¡¨å¤ªç®€å•ï¼Ÿè‡ªå®šä¹‰æ‰©å±•**ï¼š

```java
@Entity
@RevisionEntity(CustomRevisionListener.class)
public class CustomRevisionEntity {
    @Id
    @GeneratedValue
    @RevisionNumber
    private int id;
    
    @RevisionTimestamp
    private long timestamp;
    
    // æ‰©å±•å­—æ®µï¼šè®°å½•æ“ä½œäºº
    private String username;
    
    // æ‰©å±•å­—æ®µï¼šè®°å½•IPåœ°å€
    private String ipAddress;
    
    // getter/setter
}

// ç›‘å¬å™¨ï¼šè‡ªåŠ¨å¡«å……æ‰©å±•ä¿¡æ¯
public class CustomRevisionListener implements RevisionListener {
    @Override
    public void newRevision(Object revisionEntity) {
        CustomRevisionEntity revision = (CustomRevisionEntity) revisionEntity;
        
        // ä»ä¸Šä¸‹æ–‡è·å–å½“å‰ç”¨æˆ·
        String username = SecurityContextHolder.getContext()
            .getAuthentication().getName();
        revision.setUsername(username);
        
        // è·å–IPåœ°å€ï¼ˆå®é™…é¡¹ç›®ä¸­ä»Requestè·å–ï¼‰
        revision.setIpAddress("192.168.1.100");
    }
}
```

**æ•ˆæœ**ï¼š
```
åŸREVINFOè¡¨ï¼š        æ‰©å±•åçš„REVINFOè¡¨ï¼š
rev | revtstmp       rev | revtstmp | username | ipAddress
1   | 1234567890     1   | 1234567890 | admin   | 192.168.1.100
2   | 1234567900     2   | 1234567900 | zhangsan| 192.168.1.101
```

---

## 5. ğŸ“– å†å²ç‰ˆæœ¬æŸ¥è¯¢æ“ä½œ


### 5.1 è·å–å®¡è®¡æŸ¥è¯¢å™¨


**ç¬¬ä¸€æ­¥ï¼šè·å–AuditReader**

```java
// ä»EntityManagerè·å–å®¡è®¡æŸ¥è¯¢å™¨
AuditReader auditReader = AuditReaderFactory.get(entityManager);
```

> ğŸ’¡ **ç†è§£**ï¼šAuditReader å°±åƒä¸€ä¸ª"æ—¶å…‰æœºé¥æ§å™¨"ï¼Œç”¨å®ƒå¯ä»¥æŸ¥çœ‹å†å²æ•°æ®

### 5.2 æŸ¥è¯¢æŒ‡å®šç‰ˆæœ¬æ•°æ®


**åœºæ™¯1ï¼šæŸ¥çœ‹æŸä¸ªç‰ˆæœ¬çš„å®ä½“çŠ¶æ€**

```java
// æŸ¥è¯¢ç”¨æˆ·ID=1åœ¨ç‰ˆæœ¬5æ—¶çš„çŠ¶æ€
User userAtRev5 = auditReader.find(User.class, 1L, 5);

System.out.println("ç‰ˆæœ¬5æ—¶ç”¨æˆ·åï¼š" + userAtRev5.getName());
```

**å®é™…ä¾‹å­**ï¼š
```
å‡è®¾ç”¨æˆ·ä¿®æ”¹å†å²ï¼š
ç‰ˆæœ¬1ï¼šname=å¼ ä¸‰, age=25
ç‰ˆæœ¬2ï¼šname=æå››, age=25  â† ä¿®æ”¹äº†name
ç‰ˆæœ¬3ï¼šname=æå››, age=26  â† ä¿®æ”¹äº†age

auditReader.find(User.class, 1L, 2)
â†’ è¿”å›ï¼šname=æå››, age=25
```

### 5.3 æŸ¥è¯¢æ‰€æœ‰å†å²ç‰ˆæœ¬


**åœºæ™¯2ï¼šè·å–æŸå®ä½“çš„æ‰€æœ‰ç‰ˆæœ¬å·**

```java
// è·å–ç”¨æˆ·ID=1çš„æ‰€æœ‰ç‰ˆæœ¬å·
List<Number> revisions = auditReader.getRevisions(User.class, 1L);

// è¾“å‡ºï¼š[1, 2, 3, 5, 7]  è¡¨ç¤ºè¯¥ç”¨æˆ·åœ¨è¿™äº›ç‰ˆæœ¬æœ‰å˜æ›´
```

**éå†æ‰€æœ‰ç‰ˆæœ¬**ï¼š
```java
for (Number rev : revisions) {
    User historicalUser = auditReader.find(User.class, 1L, rev);
    System.out.println("ç‰ˆæœ¬" + rev + ": " + historicalUser.getName());
}

// è¾“å‡ºï¼š
// ç‰ˆæœ¬1: å¼ ä¸‰
// ç‰ˆæœ¬2: æå››
// ç‰ˆæœ¬3: æå››
```

### 5.4 é«˜çº§æŸ¥è¯¢


**åœºæ™¯3ï¼šæ¡ä»¶æŸ¥è¯¢å†å²æ•°æ®**

```java
// æŸ¥è¯¢æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®
AuditQuery query = auditReader.createQuery()
    .forEntitiesAtRevision(User.class, 5)
    .add(AuditEntity.property("age").gt(20))  // å¹´é¾„>20
    .add(AuditEntity.property("name").like("å¼ %"));  // åå­—å§“å¼ 

List<User> users = query.getResultList();
```

**åœºæ™¯4ï¼šæŸ¥è¯¢æŸæ—¶é—´æ®µçš„å˜æ›´è®°å½•**

```java
// æŸ¥è¯¢2025å¹´1æœˆçš„æ‰€æœ‰å˜æ›´
Date start = parseDate("2025-01-01");
Date end = parseDate("2025-01-31");

AuditQuery query = auditReader.createQuery()
    .forRevisionsOfEntity(User.class, false, true)
    .add(AuditEntity.revisionProperty("timestamp").ge(start.getTime()))
    .add(AuditEntity.revisionProperty("timestamp").le(end.getTime()));

List<Object[]> results = query.getResultList();

for (Object[] result : results) {
    User user = (User) result[0];           // å®ä½“æ•°æ®
    CustomRevisionEntity rev = (CustomRevisionEntity) result[1]; // ç‰ˆæœ¬ä¿¡æ¯
    RevisionType type = (RevisionType) result[2];  // æ“ä½œç±»å‹
    
    System.out.println(rev.getUsername() + " åœ¨ " + 
        new Date(rev.getTimestamp()) + " " + type + " äº†ç”¨æˆ·ï¼š" + user.getName());
}
```

### 5.5 å¸¸ç”¨æŸ¥è¯¢APIå¯¹ç…§


| æ–¹æ³• | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|
| `find(Class, id, revision)` | æŸ¥æŒ‡å®šç‰ˆæœ¬æ•°æ® | `find(User.class, 1L, 5)` |
| `getRevisions(Class, id)` | è·å–æ‰€æœ‰ç‰ˆæœ¬å· | `getRevisions(User.class, 1L)` |
| `forEntitiesAtRevision()` | æŸ¥æŸç‰ˆæœ¬çš„å¤šæ¡æ•°æ® | æŸ¥è¯¢ç‰ˆæœ¬5æ—¶æ‰€æœ‰ç”¨æˆ· |
| `forRevisionsOfEntity()` | æŸ¥æŸå®ä½“çš„å˜æ›´å†å² | æŸ¥è¯¢ç”¨æˆ·1çš„æ‰€æœ‰å˜æ›´ |

---

## 6. ğŸ”§ ç‰ˆæœ¬æ•°æ®ç®¡ç†ç­–ç•¥


### 6.1 å®¡è®¡æ•°æ®æ¸…ç†


**é—®é¢˜**ï¼šå®¡è®¡è¡¨æ•°æ®ä¼šè¶Šæ¥è¶Šå¤šï¼Œæ€ä¹ˆåŠï¼Ÿ

**ç­–ç•¥1ï¼šå®šæœŸå½’æ¡£**
```java
// å°†1å¹´å‰çš„å®¡è®¡æ•°æ®å½’æ¡£åˆ°å†å²åº“
@Scheduled(cron = "0 0 2 * * ?")  // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
public void archiveOldAuditData() {
    Date oneYearAgo = DateUtils.addYears(new Date(), -1);
    
    // æŸ¥è¯¢1å¹´å‰çš„å®¡è®¡æ•°æ®
    String sql = "SELECT * FROM user_aud WHERE rev IN " +
                 "(SELECT rev FROM revinfo WHERE revtstmp < ?)";
    
    // 1. å¯¼å‡ºåˆ°å½’æ¡£è¡¨
    // 2. åˆ é™¤åŸè¡¨æ•°æ®
}
```

**ç­–ç•¥2ï¼šä¿ç•™æœ€è¿‘Nä¸ªç‰ˆæœ¬**
```java
// åªä¿ç•™æ¯ä¸ªå®ä½“æœ€è¿‘10ä¸ªç‰ˆæœ¬
public void keepRecentVersions(Long userId, int keepCount) {
    List<Number> allRevisions = auditReader.getRevisions(User.class, userId);
    
    if (allRevisions.size() > keepCount) {
        // åˆ é™¤æ—§ç‰ˆæœ¬ï¼ˆä¿ç•™æœ€æ–°çš„keepCountä¸ªï¼‰
        List<Number> toDelete = allRevisions.subList(0, 
            allRevisions.size() - keepCount);
        
        // æ‰§è¡Œåˆ é™¤SQL
        String sql = "DELETE FROM user_aud WHERE id = ? AND rev IN (?)";
    }
}
```

### 6.2 å®¡è®¡æ•°æ®å¯¼å‡º


**åœºæ™¯ï¼šå¯¼å‡ºä¸ºExcelä¾›å®¡è®¡éƒ¨é—¨æŸ¥çœ‹**

```java
public void exportAuditLog(Long userId, OutputStream out) {
    List<Number> revisions = auditReader.getRevisions(User.class, userId);
    
    // åˆ›å»ºExcel
    Workbook workbook = new XSSFWorkbook();
    Sheet sheet = workbook.createSheet("å®¡è®¡æ—¥å¿—");
    
    // è¡¨å¤´
    Row header = sheet.createRow(0);
    header.createCell(0).setCellValue("ç‰ˆæœ¬å·");
    header.createCell(1).setCellValue("æ“ä½œæ—¶é—´");
    header.createCell(2).setCellValue("æ“ä½œäºº");
    header.createCell(3).setCellValue("æ“ä½œç±»å‹");
    header.createCell(4).setCellValue("å§“å");
    header.createCell(5).setCellValue("å¹´é¾„");
    
    // æ•°æ®è¡Œ
    int rowNum = 1;
    for (Number rev : revisions) {
        User user = auditReader.find(User.class, userId, rev);
        CustomRevisionEntity revInfo = auditReader
            .findRevision(CustomRevisionEntity.class, rev);
        
        Row row = sheet.createRow(rowNum++);
        row.createCell(0).setCellValue(rev.intValue());
        row.createCell(1).setCellValue(new Date(revInfo.getTimestamp()));
        row.createCell(2).setCellValue(revInfo.getUsername());
        row.createCell(3).setCellValue(getRevType(rev));
        row.createCell(4).setCellValue(user.getName());
        row.createCell(5).setCellValue(user.getAge());
    }
    
    workbook.write(out);
}
```

### 6.3 ç‰ˆæœ¬å¯¹æ¯”åŠŸèƒ½


**å®ç°"æŸ¥çœ‹ä¸¤ä¸ªç‰ˆæœ¬çš„å·®å¼‚"**

```java
public Map<String, String> compareVersions(Long userId, int rev1, int rev2) {
    User version1 = auditReader.find(User.class, userId, rev1);
    User version2 = auditReader.find(User.class, userId, rev2);
    
    Map<String, String> diff = new HashMap<>();
    
    if (!Objects.equals(version1.getName(), version2.getName())) {
        diff.put("name", version1.getName() + " â†’ " + version2.getName());
    }
    
    if (!Objects.equals(version1.getAge(), version2.getAge())) {
        diff.put("age", version1.getAge() + " â†’ " + version2.getAge());
    }
    
    return diff;
}

// ä½¿ç”¨ç¤ºä¾‹
Map<String, String> changes = compareVersions(1L, 2, 5);
// ç»“æœï¼š{"name": "å¼ ä¸‰ â†’ æå››", "age": "25 â†’ 26"}
```

---

## 7. âš™ï¸ å®¡è®¡é…ç½®ä¸ä¼˜åŒ–


### 7.1 åŸºç¡€é…ç½®


**application.propertiesé…ç½®**

```properties
# å¼€å¯Enverså®¡è®¡
spring.jpa.properties.org.hibernate.envers.audit_table_suffix=_aud
spring.jpa.properties.org.hibernate.envers.revision_field_name=rev
spring.jpa.properties.org.hibernate.envers.revision_type_field_name=revtype

# è‡ªå®šä¹‰ç‰ˆæœ¬ä¿¡æ¯è¡¨å
spring.jpa.properties.org.hibernate.envers.revision_table_name=my_revinfo

# ä¸å®¡è®¡åˆ é™¤æ“ä½œï¼ˆé»˜è®¤ä¼šè®°å½•ï¼‰
spring.jpa.properties.org.hibernate.envers.store_data_at_delete=false
```

**é…ç½®é¡¹è¯´æ˜**ï¼š

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|-------|------|
| `audit_table_suffix` | `_aud` | å®¡è®¡è¡¨åç¼€ |
| `revision_field_name` | `rev` | ç‰ˆæœ¬å·å­—æ®µå |
| `revision_type_field_name` | `revtype` | æ“ä½œç±»å‹å­—æ®µå |
| `store_data_at_delete` | `true` | åˆ é™¤æ—¶æ˜¯å¦ä¿å­˜æ•°æ® |

### 7.2 å®¡è®¡ç­–ç•¥é…ç½®


**é…ç½®ä¸åŒè¡¨çš„å®¡è®¡ç­–ç•¥**

```java
@Configuration
public class EnversConfig {
    
    @Bean
    public RevisionListener revisionListener() {
        return new RevisionListener() {
            @Override
            public void newRevision(Object revisionEntity) {
                // å…¨å±€å®¡è®¡é€»è¾‘
                CustomRevisionEntity rev = (CustomRevisionEntity) revisionEntity;
                
                // è®¾ç½®æ“ä½œäººï¼ˆä»Securityä¸Šä¸‹æ–‡è·å–ï¼‰
                Authentication auth = SecurityContextHolder.getContext()
                    .getAuthentication();
                if (auth != null) {
                    rev.setUsername(auth.getName());
                }
                
                // è®¾ç½®æ“ä½œæ¨¡å—ï¼ˆä»çº¿ç¨‹å˜é‡è·å–ï¼‰
                String module = AuditContext.getModule();
                rev.setModule(module);
            }
        };
    }
}
```

### 7.3 æ¡ä»¶å®¡è®¡


**åœºæ™¯ï¼šåªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹å®¡è®¡**

```java
@Entity
@Audited(withModifiedFlag = true)  // å¢åŠ ä¿®æ”¹æ ‡è®°
public class User {
    @Id
    private Long id;
    
    private String name;
    private Integer age;
    
    // ä¼šè‡ªåŠ¨ç”Ÿæˆ name_MOD å’Œ age_MOD å­—æ®µ
}
```

**å®¡è®¡è¡¨ç»“æ„å˜åŒ–**ï¼š
```sql
-- user_aud è¡¨ä¼šå¤šå‡ºä¿®æ”¹æ ‡è®°å­—æ®µ
CREATE TABLE user_aud (
    id BIGINT,
    rev INT,
    revtype TINYINT,
    name VARCHAR(50),
    name_MOD BOOLEAN,      -- nameå­—æ®µæ˜¯å¦è¢«ä¿®æ”¹
    age INT,
    age_MOD BOOLEAN,       -- ageå­—æ®µæ˜¯å¦è¢«ä¿®æ”¹
    PRIMARY KEY (id, rev)
);
```

**æŸ¥è¯¢æ—¶ä½¿ç”¨**ï¼š
```java
// åªæŸ¥è¯¢nameå­—æ®µæœ‰å˜åŒ–çš„ç‰ˆæœ¬
AuditQuery query = auditReader.createQuery()
    .forRevisionsOfEntity(User.class, false, true)
    .add(AuditEntity.property("name_MOD").eq(true));
```

---

## 8. âš¡ æ€§èƒ½è€ƒè™‘ä¸æœ€ä½³å®è·µ


### 8.1 æ€§èƒ½å½±å“åˆ†æ


**å®¡è®¡å¸¦æ¥çš„æ€§èƒ½å¼€é”€**ï¼š

```
å†™æ“ä½œæ€§èƒ½å½±å“ï¼š

æ— å®¡è®¡ï¼š            æœ‰å®¡è®¡ï¼š
INSERT user        INSERT user
(1æ¡SQL)           INSERT user_aud
                   INSERT revinfo
                   (3æ¡SQL) â† æ€§èƒ½ä¸‹é™çº¦30-50%

UPDATE user        UPDATE user
(1æ¡SQL)           INSERT user_aud
                   (2æ¡SQL) â† æ€§èƒ½ä¸‹é™çº¦20-30%
```

**æ€§èƒ½å¯¹æ¯”æ•°æ®**ï¼š

| æ“ä½œç±»å‹ | æ— å®¡è®¡è€—æ—¶ | æœ‰å®¡è®¡è€—æ—¶ | æ€§èƒ½ä¸‹é™ |
|---------|----------|----------|---------|
| å•æ¡æ’å…¥ | 5ms | 8ms | 60% |
| æ‰¹é‡æ’å…¥(100æ¡) | 200ms | 350ms | 75% |
| å•æ¡æ›´æ–° | 3ms | 5ms | 66% |
| æ‰¹é‡æ›´æ–°(100æ¡) | 150ms | 240ms | 60% |

### 8.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ç­–ç•¥1ï¼šé€‰æ‹©æ€§å®¡è®¡**

```java
// âŒ ä¸å¥½çš„åšæ³•ï¼šå…¨éƒ¨è¡¨éƒ½å®¡è®¡
@Entity
@Audited  
public class SystemLog {  // æ—¥å¿—è¡¨æœ¬èº«å°±æ˜¯å†å²è®°å½•ï¼Œä¸éœ€è¦å®¡è®¡
    // ...
}

// âœ… å¥½çš„åšæ³•ï¼šåªå®¡è®¡æ ¸å¿ƒä¸šåŠ¡è¡¨
@Entity
@Audited
public class Order {  // è®¢å•éœ€è¦å®¡è®¡
    // ...
}

@Entity
// ä¸åŠ @Audited
public class OrderStatistics {  // ç»Ÿè®¡è¡¨ä¸éœ€è¦å®¡è®¡
    // ...
}
```

**ç­–ç•¥2ï¼šå¼‚æ­¥å®¡è®¡**

```java
@Configuration
public class AsyncAuditConfig {
    
    @Bean
    public TaskExecutor auditExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(2);
        executor.setMaxPoolSize(5);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("audit-");
        return executor;
    }
}

// è‡ªå®šä¹‰å®¡è®¡ç›‘å¬å™¨ï¼Œå¼‚æ­¥å†™å…¥
public class AsyncRevisionListener implements RevisionListener {
    
    @Autowired
    private TaskExecutor auditExecutor;
    
    @Override
    public void newRevision(Object revisionEntity) {
        // å¼‚æ­¥æ‰§è¡Œå®¡è®¡é€»è¾‘
        auditExecutor.execute(() -> {
            // è®¾ç½®å®¡è®¡ä¿¡æ¯
            CustomRevisionEntity rev = (CustomRevisionEntity) revisionEntity;
            rev.setUsername(getCurrentUser());
        });
    }
}
```

**ç­–ç•¥3ï¼šæ‰¹é‡æ“ä½œä¼˜åŒ–**

```java
// âŒ ä¸å¥½çš„åšæ³•ï¼šé€æ¡ä¿å­˜
for (User user : users) {
    userRepository.save(user);  // æ¯æ¡éƒ½ä¼šè§¦å‘å®¡è®¡
}

// âœ… å¥½çš„åšæ³•ï¼šæ‰¹é‡ä¿å­˜
@Transactional
public void batchSave(List<User> users) {
    userRepository.saveAll(users);  // ä¸€æ¬¡äº‹åŠ¡ï¼Œå‡å°‘å®¡è®¡å¼€é”€
    entityManager.flush();
}

// é…ç½®æ‰¹é‡å¤§å°
spring.jpa.properties.hibernate.jdbc.batch_size=50
```

### 8.3 å®¡è®¡è¡¨ç´¢å¼•ä¼˜åŒ–


**å¿…é¡»æ·»åŠ çš„ç´¢å¼•**ï¼š

```sql
-- 1. å¤åˆä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
ALTER TABLE user_aud ADD PRIMARY KEY (id, rev);

-- 2. revå­—æ®µç´¢å¼•ï¼ˆæŸ¥è¯¢å†å²æ—¶å¸¸ç”¨ï¼‰
CREATE INDEX idx_user_aud_rev ON user_aud(rev);

-- 3. æ—¶é—´èŒƒå›´æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_revinfo_timestamp ON revinfo(revtstmp);

-- 4. æ“ä½œäººæŸ¥è¯¢ç´¢å¼•ï¼ˆå¦‚æœæœ‰æ‰©å±•å­—æ®µï¼‰
CREATE INDEX idx_revinfo_username ON revinfo(username);

-- 5. ä¸šåŠ¡å­—æ®µç´¢å¼•ï¼ˆæ ¹æ®æŸ¥è¯¢éœ€æ±‚ï¼‰
CREATE INDEX idx_user_aud_name ON user_aud(name);
```

### 8.4 æ•°æ®å­˜å‚¨ä¼˜åŒ–


**å‹ç¼©å®¡è®¡è¡¨**ï¼š

```sql
-- MySQLä½¿ç”¨å‹ç¼©è¡¨
ALTER TABLE user_aud ROW_FORMAT=COMPRESSED;
ALTER TABLE revinfo ROW_FORMAT=COMPRESSED;

-- åˆ†åŒºè¡¨ï¼ˆæŒ‰æ—¶é—´åˆ†åŒºï¼‰
ALTER TABLE user_aud PARTITION BY RANGE (rev) (
    PARTITION p2024 VALUES LESS THAN (100000),
    PARTITION p2025 VALUES LESS THAN (200000),
    PARTITION pfuture VALUES LESS THAN MAXVALUE
);
```

### 8.5 æœ€ä½³å®è·µæ¸…å•


> âœ… **DO - åº”è¯¥åšçš„**

- âœ… åªå®¡è®¡æ ¸å¿ƒä¸šåŠ¡è¡¨ï¼Œä¸æ˜¯æ‰€æœ‰è¡¨éƒ½åŠ `@Audited`
- âœ… æ•æ„Ÿå­—æ®µä½¿ç”¨`@NotAudited`æ’é™¤
- âœ… å®šæœŸå½’æ¡£æˆ–æ¸…ç†å†å²æ•°æ®
- âœ… ä¸ºå®¡è®¡è¡¨æ·»åŠ åˆé€‚çš„ç´¢å¼•
- âœ… ç›‘æ§å®¡è®¡è¡¨å¤§å°ï¼ŒåŠæ—¶ä¼˜åŒ–

> âŒ **DON'T - ä¸åº”è¯¥åšçš„**

- âŒ ä¸è¦åœ¨é«˜é¢‘å†™å…¥çš„è¡¨ä¸Šå¯ç”¨å®¡è®¡
- âŒ ä¸è¦ä¿ç•™æ— é™æœŸçš„å®¡è®¡æ•°æ®
- âŒ ä¸è¦åœ¨å®¡è®¡è¡¨ä¸Šåšå¤æ‚å…³è”æŸ¥è¯¢
- âŒ ä¸è¦å¿˜è®°å¤„ç†å®¡è®¡è¡¨çš„æ•°æ®å¢é•¿
- âŒ ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒéšæ„å¼€å¯å…¨è¡¨å®¡è®¡

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Hibernate Enversï¼šHibernateçš„å®¡è®¡æ¨¡å—ï¼Œè‡ªåŠ¨è®°å½•æ•°æ®å˜æ›´å†å²
ğŸ”¸ @Auditedæ³¨è§£ï¼šæ ‡è®°éœ€è¦å®¡è®¡çš„å®ä½“ï¼Œè‡ªåŠ¨ç”Ÿæˆå®¡è®¡è¡¨
ğŸ”¸ ä¸‰å¼ è¡¨ç»“æ„ï¼šä¸šåŠ¡è¡¨ã€å®¡è®¡è¡¨(_aud)ã€ç‰ˆæœ¬ä¿¡æ¯è¡¨(revinfo)
ğŸ”¸ REVTYPEå«ä¹‰ï¼š0=æ–°å¢ã€1=ä¿®æ”¹ã€2=åˆ é™¤
ğŸ”¸ AuditReaderï¼šæŸ¥è¯¢å†å²æ•°æ®çš„æ ¸å¿ƒAPI
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å®¡è®¡çš„æœ¬è´¨**ï¼š
```
æ•°æ®å®¡è®¡ = åœ¨æ•°æ®å˜æ›´æ—¶è‡ªåŠ¨è®°å½•"è°ã€ä½•æ—¶ã€åšäº†ä»€ä¹ˆ"

ç±»æ¯”ï¼šå°±åƒGitçš„commitå†å²ï¼Œæ¯æ¬¡æäº¤éƒ½æœ‰è®°å½•
     å¯ä»¥çœ‹åˆ°ä»»ä½•æ—¶é—´ç‚¹çš„ä»£ç çŠ¶æ€
```

**ğŸ”¹ æ€§èƒ½æƒè¡¡**ï¼š
```
å¥½å¤„ï¼š              ä»£ä»·ï¼š
æ•°æ®å¯è¿½æº¯          å†™æ“ä½œæ€§èƒ½ä¸‹é™30-50%
åˆè§„æ€§ä¿éšœ          å­˜å‚¨ç©ºé—´å¢åŠ 1-3å€
é—®é¢˜å¯å›æº¯          æŸ¥è¯¢å¤æ‚åº¦æå‡

å»ºè®®ï¼šæ ¸å¿ƒä¸šåŠ¡è¡¨æ‰å¯ç”¨å®¡è®¡ï¼Œä¸æ˜¯å…¨éƒ¨è¡¨
```

**ğŸ”¹ æŸ¥è¯¢å†å²çš„æ€è·¯**ï¼š
```
ä¸‰ç§å¸¸è§æŸ¥è¯¢ï¼š
1. çœ‹æŸä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼šfind(Class, id, revision)
2. çœ‹æŸå®ä½“çš„å˜æ›´å†å²ï¼šgetRevisions(Class, id)  
3. çœ‹æŸæ—¶é—´æ®µçš„å˜æ›´ï¼šæ¡ä»¶æŸ¥è¯¢ + æ—¶é—´è¿‡æ»¤
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**åº”ç”¨åœºæ™¯åˆ¤æ–­**ï¼š

| åœºæ™¯ | æ˜¯å¦éœ€è¦å®¡è®¡ | åŸå›  |
|------|------------|------|
| ğŸ’° è®¢å•è¡¨ | âœ… å¿…é¡» | é‡‘é¢å˜æ›´éœ€è¦è¿½æº¯ |
| ğŸ‘¤ ç”¨æˆ·è¡¨ | âœ… å»ºè®® | è´¦æˆ·ä¿¡æ¯å˜æ›´è®°å½• |
| ğŸ“ åˆåŒè¡¨ | âœ… å¿…é¡» | æ³•å¾‹è¦æ±‚ |
| ğŸ“Š ç»Ÿè®¡è¡¨ | âŒ ä¸éœ€è¦ | å®æ—¶è®¡ç®—çš„æ•°æ® |
| ğŸ“‹ æ—¥å¿—è¡¨ | âŒ ä¸éœ€è¦ | æœ¬èº«å°±æ˜¯å†å²è®°å½• |
| ğŸ”§ é…ç½®è¡¨ | âœ… å»ºè®® | é…ç½®å˜æ›´è¿½è¸ª |

**å®æ–½æ­¥éª¤**ï¼š

```
â‘  è¯„ä¼°éœ€æ±‚
   â””â†’ å“ªäº›è¡¨éœ€è¦å®¡è®¡ï¼Ÿä¿ç•™å¤šä¹…ï¼Ÿ

â‘¡ é…ç½®Envers
   â””â†’ åŠ @Auditedæ³¨è§£
   â””â†’ é…ç½®application.properties

â‘¢ æ‰©å±•ç‰ˆæœ¬ä¿¡æ¯
   â””â†’ åˆ›å»ºCustomRevisionEntity
   â””â†’ å®ç°RevisionListener

â‘£ å®ç°æŸ¥è¯¢åŠŸèƒ½
   â””â†’ å†å²ç‰ˆæœ¬æŸ¥çœ‹
   â””â†’ å˜æ›´è®°å½•å¯¼å‡º

â‘¤ æ€§èƒ½ä¼˜åŒ–
   â””â†’ æ·»åŠ ç´¢å¼•
   â””â†’ å®šæœŸå½’æ¡£

â‘¥ è¿ç»´ç›‘æ§
   â””â†’ ç›‘æ§å®¡è®¡è¡¨å¤§å°
   â””â†’ å®šæœŸæ•°æ®æ¸…ç†
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
å®¡è®¡è®°å½•ä¸‰è¦ç´ ï¼šè°ã€ä½•æ—¶ã€åšäº†å•¥
Enversè‡ªåŠ¨å»ºè¡¨ï¼Œ_audåç¼€è§„èŒƒåŒ–
AuditReaderæŸ¥å†å²ï¼Œç‰ˆæœ¬å·æ˜¯å…³é”®
æ€§èƒ½å¼€é”€è¦è€ƒè™‘ï¼Œæ ¸å¿ƒä¸šåŠ¡æ‰å¯ç”¨
```