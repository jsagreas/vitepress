---
title: 30ã€æŸ¥è¯¢ç¼“å­˜è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [æŸ¥è¯¢ç¼“å­˜åŸºæœ¬æ¦‚å¿µ](#1-æŸ¥è¯¢ç¼“å­˜åŸºæœ¬æ¦‚å¿µ)
2. [Query Cacheå·¥ä½œåŸç†](#2-query-cacheå·¥ä½œåŸç†)
3. [æŸ¥è¯¢ç¼“å­˜é…ç½®ä¸ä½¿ç”¨](#3-æŸ¥è¯¢ç¼“å­˜é…ç½®ä¸ä½¿ç”¨)
4. [ç»“æœé›†ç¼“å­˜æœºåˆ¶](#4-ç»“æœé›†ç¼“å­˜æœºåˆ¶)
5. [ç¼“å­˜å¤±æ•ˆä¸æ›´æ–°](#5-ç¼“å­˜å¤±æ•ˆä¸æ›´æ–°)
6. [åº”ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ](#6-åº”ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ)
7. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#7-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æŸ¥è¯¢ç¼“å­˜åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æŸ¥è¯¢ç¼“å­˜


**é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ å»å›¾ä¹¦é¦†æŸ¥èµ„æ–™ï¼Œå¦‚æœæ¯æ¬¡éƒ½è¦ä»å¤´åˆ°å°¾ç¿»ä¹¦æ‰¾ï¼Œä¼šå¾ˆç´¯ã€‚èªæ˜çš„åšæ³•æ˜¯æŠŠæ‰¾åˆ°çš„å†…å®¹è®°åœ¨å°æœ¬å­ä¸Šï¼Œä¸‹æ¬¡ç›´æ¥çœ‹æœ¬å­å°±è¡Œã€‚æŸ¥è¯¢ç¼“å­˜å°±æ˜¯Hibernateçš„"å°æœ¬å­"ã€‚

**æ ¸å¿ƒå®šä¹‰**ï¼š
```
æŸ¥è¯¢ç¼“å­˜ï¼ˆQuery Cacheï¼‰ï¼š
â€¢ ç”¨é€”ï¼šç¼“å­˜æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œç»“æœ
â€¢ æœ¬è´¨ï¼šå­˜å‚¨HQL/SQLæŸ¥è¯¢çš„ç»“æœé›†
â€¢ ç›®æ ‡ï¼šé¿å…é‡å¤æ‰§è¡Œç›¸åŒçš„æ•°æ®åº“æŸ¥è¯¢
â€¢ èŒƒå›´ï¼šSessionFactoryçº§åˆ«ï¼Œæ‰€æœ‰Sessionå…±äº«
```

### 1.2 æŸ¥è¯¢ç¼“å­˜ vs äºŒçº§ç¼“å­˜


**ğŸ” ä¸¤è€…åŒºåˆ«å¯¹æ¯”**

```
ç”Ÿæ´»ç±»æ¯”ç†è§£ï¼š

äºŒçº§ç¼“å­˜ï¼š
å°±åƒå•†åº—çš„å•†å“è´§æ¶
â€¢ æŒ‰å•†å“IDå­˜æ”¾ï¼ˆæ ¹æ®å®ä½“IDç¼“å­˜å¯¹è±¡ï¼‰
â€¢ ç›´æ¥æ‹¿IDå»æ‰¾è´§ç‰©
â€¢ é€‚åˆï¼šæ ¹æ®IDæŸ¥è¯¢å•ä¸ªå¯¹è±¡

æŸ¥è¯¢ç¼“å­˜ï¼š
å°±åƒå•†åº—çš„è´­ç‰©æ¸…å•
â€¢ æŒ‰æ¸…å•å†…å®¹å­˜æ”¾ï¼ˆæ ¹æ®æŸ¥è¯¢æ¡ä»¶ç¼“å­˜ç»“æœï¼‰
â€¢ æ‹¿ç€æ¸…å•æ‰¾ä¸€æ‰¹è´§ç‰©
â€¢ é€‚åˆï¼šå¤æ‚æŸ¥è¯¢æ¡ä»¶çš„ç»“æœé›†
```

| å¯¹æ¯”ç»´åº¦ | **äºŒçº§ç¼“å­˜** | **æŸ¥è¯¢ç¼“å­˜** |
|---------|------------|------------|
| ğŸ”‘ **ç¼“å­˜é”®** | `å®ä½“ç±» + ID` | `HQLè¯­å¥ + å‚æ•°å€¼` |
| ğŸ“¦ **ç¼“å­˜å†…å®¹** | `å•ä¸ªå®ä½“å¯¹è±¡` | `IDåˆ—è¡¨ + æŸ¥è¯¢å…ƒæ•°æ®` |
| ğŸ¯ **é€‚ç”¨åœºæ™¯** | `get/loadå•ä¸ªå¯¹è±¡` | `list/queryæ‰¹é‡æŸ¥è¯¢` |
| ğŸ”„ **ä¾èµ–å…³ç³»** | `ç‹¬ç«‹å·¥ä½œ` | `å¿…é¡»é…åˆäºŒçº§ç¼“å­˜` |
| âš¡ **æ€§èƒ½ç‰¹ç‚¹** | `æŸ¥è¯¢å¿«ï¼Œå‘½ä¸­ç‡é«˜` | `éœ€è¦ä¸¤æ¬¡ç¼“å­˜æŸ¥è¯¢` |

### 1.3 æŸ¥è¯¢ç¼“å­˜çš„å·¥ä½œæœºåˆ¶


**ğŸ“Š æŸ¥è¯¢ç¼“å­˜å­˜å‚¨ç»“æ„**

```
ç¬¬ä¸€æ¬¡æŸ¥è¯¢æµç¨‹ï¼š
ç”¨æˆ·æŸ¥è¯¢ â†’ Hibernate â†’ æ•°æ®åº“
         â†“
    æŸ¥è¯¢ç¼“å­˜ï¼ˆå­˜å‚¨ï¼‰
    [HQL + å‚æ•°] â†’ [IDåˆ—è¡¨]

ç¬¬äºŒæ¬¡ç›¸åŒæŸ¥è¯¢ï¼š
ç”¨æˆ·æŸ¥è¯¢ â†’ æŸ¥è¯¢ç¼“å­˜ â†’ äºŒçº§ç¼“å­˜ â†’ è¿”å›ç»“æœ
         (æ‰¾IDåˆ—è¡¨)   (æ ¹æ®IDæ‰¾å¯¹è±¡)
```

**ğŸ’¡ å…³é”®ç†è§£**

::: tip æŸ¥è¯¢ç¼“å­˜å­˜ä»€ä¹ˆï¼Ÿ
æŸ¥è¯¢ç¼“å­˜**ä¸ç›´æ¥å­˜å¯¹è±¡**ï¼Œè€Œæ˜¯å­˜ï¼š
1. **æŸ¥è¯¢çš„ç»“æœIDåˆ—è¡¨**ï¼š`[1, 5, 8, 12...]`
2. **æŸ¥è¯¢å…ƒæ•°æ®**ï¼šæŸ¥è¯¢æ—¶é—´ã€å‚æ•°ç­‰
3. **ä¾èµ–äºŒçº§ç¼“å­˜**ï¼šæ ¹æ®IDå»äºŒçº§ç¼“å­˜å–å®Œæ•´å¯¹è±¡
:::

---

## 2. âš™ï¸ Query Cacheå·¥ä½œåŸç†


### 2.1 ç¼“å­˜çš„å®Œæ•´æ‰§è¡Œæµç¨‹


**ğŸ”„ é¦–æ¬¡æŸ¥è¯¢è¿‡ç¨‹**

```
æ‰§è¡Œæµç¨‹å›¾ï¼š

å¼€å§‹æŸ¥è¯¢
    â†“
æ£€æŸ¥æŸ¥è¯¢ç¼“å­˜
    â†“ (æœªå‘½ä¸­)
æ‰§è¡ŒSQLæŸ¥è¯¢æ•°æ®åº“
    â†“
è·å–ç»“æœé›† [User1, User2, User3...]
    â†“
æå–IDåˆ—è¡¨ [1, 2, 3]
    â†“
å­˜å…¥æŸ¥è¯¢ç¼“å­˜ï¼škey=(HQL+å‚æ•°), value=IDåˆ—è¡¨
    â†“
åŒæ—¶å­˜å…¥äºŒçº§ç¼“å­˜ï¼šæ¯ä¸ªå®ä½“å¯¹è±¡
    â†“
è¿”å›ç»“æœç»™ç”¨æˆ·
```

**ç¤ºä¾‹ç†è§£**ï¼š
```java
// ç¬¬ä¸€æ¬¡æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢
String hql = "FROM User WHERE age > :age";
Query query = session.createQuery(hql);
query.setParameter("age", 18);
query.setCacheable(true);  // å¼€å¯æŸ¥è¯¢ç¼“å­˜
List<User> users = query.list();

// å†…éƒ¨è¿‡ç¨‹ï¼š
// 1. æŸ¥è¯¢ç¼“å­˜ï¼šæœªæ‰¾åˆ°
// 2. æ‰§è¡ŒSQLï¼šSELECT * FROM user WHERE age > 18
// 3. ç»“æœï¼š[User(id=1), User(id=5), User(id=8)]
// 4. ç¼“å­˜å­˜å‚¨ï¼š
//    æŸ¥è¯¢ç¼“å­˜ -> {key: "FROM User WHERE age > 18, age=18", value: [1,5,8]}
//    äºŒçº§ç¼“å­˜ -> {User.1, User.5, User.8}
```

### 2.2 ç¼“å­˜å‘½ä¸­çš„æ‰§è¡Œæµç¨‹


**âš¡ å†æ¬¡æŸ¥è¯¢è¿‡ç¨‹**

```
ç¼“å­˜å‘½ä¸­æµç¨‹ï¼š

ç›¸åŒæŸ¥è¯¢è¯·æ±‚
    â†“
æ£€æŸ¥æŸ¥è¯¢ç¼“å­˜ âœ“ (å‘½ä¸­)
    â†“
è·å–IDåˆ—è¡¨ [1, 5, 8]
    â†“
éå†IDåˆ—è¡¨ï¼š
  â”œâ”€ æ£€æŸ¥äºŒçº§ç¼“å­˜(User.1) âœ“ å‘½ä¸­
  â”œâ”€ æ£€æŸ¥äºŒçº§ç¼“å­˜(User.5) âœ“ å‘½ä¸­  
  â””â”€ æ£€æŸ¥äºŒçº§ç¼“å­˜(User.8) âœ“ å‘½ä¸­
    â†“
ç»„è£…å®Œæ•´å¯¹è±¡åˆ—è¡¨
    â†“
è¿”å›ç»“æœï¼ˆæ— æ•°æ®åº“æŸ¥è¯¢ï¼ï¼‰
```

**ğŸ¯ æ€§èƒ½æå‡çš„ç§˜å¯†**

```
æ€§èƒ½å¯¹æ¯”ï¼š

æ— ç¼“å­˜ï¼š
  æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ï¼š100ms
  
ä»…äºŒçº§ç¼“å­˜ï¼š
  ä»éœ€æ‰§è¡ŒSQLè·å–IDï¼š50ms
  
æŸ¥è¯¢ç¼“å­˜ + äºŒçº§ç¼“å­˜ï¼š
  å†…å­˜è·å–IDï¼š1ms
  å†…å­˜è·å–å¯¹è±¡ï¼š2ms
  æ€»æ—¶é—´ï¼š3ms âš¡
  
æ€§èƒ½æå‡ï¼š30å€ä»¥ä¸Šï¼
```

### 2.3 ç¼“å­˜é”®çš„ç”Ÿæˆæœºåˆ¶


**ğŸ”‘ ç¼“å­˜Keyçš„ç»„æˆ**

```
ç¼“å­˜Key = HQLè¯­å¥ + å‚æ•°å€¼ + å…¶ä»–å› å­

è¯¦ç»†ç»„æˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HQL/SQLè¯­å¥æ–‡æœ¬             â”‚ â† "FROM User WHERE age > :age"
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‚æ•°åå’Œå€¼                  â”‚ â† age=18
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ FirstResultèµ·å§‹ä½ç½®         â”‚ â† 0
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MaxResultsæœ€å¤§ç»“æœæ•°        â”‚ â† 100
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æŸ¥è¯¢ç©ºé—´ï¼ˆæ¶‰åŠçš„è¡¨ï¼‰         â”‚ â† [User]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
   ç”Ÿæˆå”¯ä¸€ç¼“å­˜Key
```

**âš ï¸ ç¼“å­˜Keyçš„æ•æ„Ÿæ€§**

::: warning æ³¨æ„
ä»¥ä¸‹ä»»ä½•å˜åŒ–éƒ½ä¼šå¯¼è‡´ç¼“å­˜Keyä¸åŒï¼š
- âœ… å‚æ•°å€¼å˜åŒ–ï¼š`age=18` vs `age=20`
- âœ… å‚æ•°é¡ºåºï¼š`name='A' AND age=18` vs `age=18 AND name='A'`
- âœ… ç©ºæ ¼å·®å¼‚ï¼š`FROM User` vs `FROM  User`
- âœ… å¤§å°å†™ï¼š`from User` vs `FROM User`
- âœ… åˆ†é¡µå‚æ•°ï¼š`setFirstResult(0)` vs `setFirstResult(10)`
:::

**å®é™…ç¤ºä¾‹**ï¼š
```java
// è¿™ä¸¤ä¸ªæŸ¥è¯¢ä¼šäº§ç”Ÿä¸åŒçš„ç¼“å­˜Key
Query q1 = session.createQuery("FROM User WHERE age = :age");
q1.setParameter("age", 18);

Query q2 = session.createQuery("FROM User WHERE age = :userAge");
q2.setParameter("userAge", 18);

// å³ä½¿æŸ¥è¯¢ç»“æœç›¸åŒï¼Œä½†å‚æ•°åä¸åŒ -> ä¸åŒçš„ç¼“å­˜Keyï¼
```

---

## 3. ğŸ”§ æŸ¥è¯¢ç¼“å­˜é…ç½®ä¸ä½¿ç”¨


### 3.1 åŸºç¡€é…ç½®æ­¥éª¤


**ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•**

- [ ] **1. å¯ç”¨äºŒçº§ç¼“å­˜**ï¼ˆå¿…éœ€å‰æï¼‰
- [ ] **2. å¼€å¯æŸ¥è¯¢ç¼“å­˜å…¨å±€å¼€å…³**
- [ ] **3. é…ç½®ç¼“å­˜æä¾›è€…**
- [ ] **4. å•ä¸ªæŸ¥è¯¢å¯ç”¨ç¼“å­˜**

**ğŸ”¸ æ­¥éª¤1ï¼šhibernate.cfg.xmlé…ç½®**

```xml
<hibernate-configuration>
    <session-factory>
        <!-- å¿…é¡»å…ˆå¯ç”¨äºŒçº§ç¼“å­˜ -->
        <property name="hibernate.cache.use_second_level_cache">true</property>
        
        <!-- å¼€å¯æŸ¥è¯¢ç¼“å­˜å…¨å±€å¼€å…³ -->
        <property name="hibernate.cache.use_query_cache">true</property>
        
        <!-- é…ç½®ç¼“å­˜æä¾›è€…ï¼ˆæ¨èEhCacheï¼‰ -->
        <property name="hibernate.cache.region.factory_class">
            org.hibernate.cache.ehcache.EhCacheRegionFactory
        </property>
        
        <!-- å¯é€‰ï¼šæ›´æ–°æ—¶é—´æˆ³ç¼“å­˜ï¼ˆç”¨äºå¤±æ•ˆæ£€æµ‹ï¼‰ -->
        <property name="hibernate.cache.use_structured_entries">true</property>
    </session-factory>
</hibernate-configuration>
```

**ğŸ”¸ æ­¥éª¤2ï¼šå®ä½“ç±»ç¼“å­˜é…ç½®**

```java
@Entity
@Table(name = "users")
@Cache(usage = CacheConcurrencyStrategy.READ_WRITE)  // å¿…é¡»ï¼
public class User {
    @Id
    private Long id;
    private String name;
    private Integer age;
    // getters/setters...
}
```

### 3.2 æŸ¥è¯¢çº§åˆ«çš„ç¼“å­˜å¯ç”¨


**ğŸ’» ä»£ç ç¤ºä¾‹ï¼šHQLæŸ¥è¯¢**

```java
public class UserDAO {
    
    // âœ… æ­£ç¡®ç”¨æ³•ï¼šå¯ç”¨æŸ¥è¯¢ç¼“å­˜
    public List<User> findUsersByAge(int minAge) {
        Session session = sessionFactory.getCurrentSession();
        
        Query<User> query = session.createQuery(
            "FROM User WHERE age > :age", User.class
        );
        query.setParameter("age", minAge);
        
        // å…³é”®ï¼šè®¾ç½®æŸ¥è¯¢å¯ç¼“å­˜
        query.setCacheable(true);
        
        // å¯é€‰ï¼šæŒ‡å®šç¼“å­˜åŒºåŸŸ
        query.setCacheRegion("userQueryCache");
        
        return query.list();
    }
    
    // âŒ é”™è¯¯ç”¨æ³•ï¼šå¿˜è®°setCacheable
    public List<User> findUsersWrong(int minAge) {
        Query<User> query = session.createQuery(
            "FROM User WHERE age > :age", User.class
        );
        query.setParameter("age", minAge);
        
        // æ²¡æœ‰setCacheable(true) -> ä¸ä¼šç¼“å­˜ï¼
        return query.list();
    }
}
```

**ğŸ’» Criteria APIæ–¹å¼**

```java
public List<User> findUsersWithCriteria(int minAge) {
    CriteriaBuilder cb = session.getCriteriaBuilder();
    CriteriaQuery<User> cq = cb.createQuery(User.class);
    Root<User> root = cq.from(User.class);
    
    cq.where(cb.gt(root.get("age"), minAge));
    
    Query<User> query = session.createQuery(cq);
    
    // åŒæ ·éœ€è¦è®¾ç½®
    query.setCacheable(true);
    query.setCacheRegion("userCriteriaCache");
    
    return query.list();
}
```

### 3.3 ç¼“å­˜åŒºåŸŸé…ç½®


**ğŸ—‚ï¸ ç¼“å­˜åŒºåŸŸçš„ä½œç”¨**

```
ç¼“å­˜åŒºåŸŸï¼ˆCache Regionï¼‰å°±åƒæ–‡ä»¶å¤¹åˆ†ç±»ï¼š

é»˜è®¤åŒºåŸŸï¼š
org.hibernate.cache.internal.StandardQueryCache
  â”œâ”€ æ‰€æœ‰æŸ¥è¯¢æ··åœ¨ä¸€èµ·
  â””â”€ å¤±æ•ˆæ—¶å½±å“æ‰€æœ‰æŸ¥è¯¢

è‡ªå®šä¹‰åŒºåŸŸï¼š
userQueryCache
  â”œâ”€ ç”¨æˆ·ç›¸å…³æŸ¥è¯¢
  â””â”€ ç‹¬ç«‹å¤±æ•ˆæ§åˆ¶
  
orderQueryCache
  â”œâ”€ è®¢å•ç›¸å…³æŸ¥è¯¢
  â””â”€ ç‹¬ç«‹å¤±æ•ˆæ§åˆ¶
```

**ğŸ”§ EhCacheé…ç½®ç¤ºä¾‹**

```xml
<!-- ehcache.xml -->
<ehcache>
    <!-- é»˜è®¤æŸ¥è¯¢ç¼“å­˜åŒºåŸŸ -->
    <cache name="org.hibernate.cache.internal.StandardQueryCache"
           maxEntriesLocalHeap="1000"
           timeToLiveSeconds="3600"
           timeToIdleSeconds="1800"/>
    
    <!-- è‡ªå®šä¹‰ç”¨æˆ·æŸ¥è¯¢ç¼“å­˜åŒºåŸŸ -->
    <cache name="userQueryCache"
           maxEntriesLocalHeap="500"
           timeToLiveSeconds="600"
           timeToIdleSeconds="300"/>
    
    <!-- æ›´æ–°æ—¶é—´æˆ³ç¼“å­˜ï¼ˆä¸è¦ä¿®æ”¹ï¼‰ -->
    <cache name="org.hibernate.cache.spi.UpdateTimestampsCache"
           maxEntriesLocalHeap="5000"
           eternal="true"/>
</ehcache>
```

**ğŸ¯ åŒºåŸŸå‘½åæœ€ä½³å®è·µ**

```java
public interface CacheRegions {
    String USER_QUERY = "userQueryCache";
    String ORDER_QUERY = "orderQueryCache";
    String PRODUCT_QUERY = "productQueryCache";
}

// ä½¿ç”¨å¸¸é‡
query.setCacheRegion(CacheRegions.USER_QUERY);
```

---

## 4. ğŸ“¦ ç»“æœé›†ç¼“å­˜æœºåˆ¶


### 4.1 ç»“æœé›†çš„å­˜å‚¨ç»“æ„


**ğŸ” æŸ¥è¯¢ç¼“å­˜åˆ°åº•å­˜äº†ä»€ä¹ˆï¼Ÿ**

```
æŸ¥è¯¢ç¼“å­˜å­˜å‚¨å†…å®¹ï¼š

ç¼“å­˜Entryç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¼“å­˜Key                      â”‚
â”‚  - HQLè¯­å¥                   â”‚
â”‚  - å‚æ•°å€¼                     â”‚
â”‚  - åˆ†é¡µä¿¡æ¯                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¼“å­˜Value                    â”‚
â”‚  - ç»“æœIDåˆ—è¡¨: [1, 5, 8, 12] â”‚
â”‚  - æŸ¥è¯¢æ—¶é—´æˆ³: 1234567890    â”‚
â”‚  - æ¶‰åŠçš„è¡¨: [User]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ é‡è¦ç†è§£**

::: tip ä¸ºä»€ä¹ˆåªå­˜IDï¼Ÿ
1. **èŠ‚çœç©ºé—´**ï¼šIDé€šå¸¸åªæœ‰4-8å­—èŠ‚ï¼Œå®Œæ•´å¯¹è±¡å¯èƒ½å‡ KB
2. **å¤ç”¨äºŒçº§ç¼“å­˜**ï¼šå®Œæ•´å¯¹è±¡å·²åœ¨äºŒçº§ç¼“å­˜ä¸­
3. **é¿å…é‡å¤**ï¼šåŒä¸€å¯¹è±¡ä¸ä¼šåœ¨ä¸¤ä¸ªç¼“å­˜ä¸­å„å­˜ä¸€ä»½
4. **æ›´æ–°ç®€å•**ï¼šå¯¹è±¡å˜åŒ–åªéœ€æ›´æ–°äºŒçº§ç¼“å­˜
:::

### 4.2 æŠ•å½±æŸ¥è¯¢çš„ç¼“å­˜


**ğŸ¯ ä¸åŒæŸ¥è¯¢ç±»å‹çš„ç¼“å­˜è¡¨ç°**

```java
// åœºæ™¯1ï¼šå®Œæ•´å®ä½“æŸ¥è¯¢ï¼ˆæ¨èï¼‰
public List<User> findUsers() {
    Query<User> query = session.createQuery(
        "FROM User WHERE age > 18", User.class
    );
    query.setCacheable(true);
    return query.list();
    
    // ç¼“å­˜å†…å®¹ï¼š
    // Key: "FROM User WHERE age > 18"
    // Value: [1, 5, 8] -> äºŒçº§ç¼“å­˜è·å–å®Œæ•´Userå¯¹è±¡
}

// åœºæ™¯2ï¼šæŠ•å½±æŸ¥è¯¢ï¼ˆéƒ¨åˆ†å­—æ®µï¼‰
public List<Object[]> findUserNames() {
    Query query = session.createQuery(
        "SELECT u.id, u.name FROM User u WHERE age > 18"
    );
    query.setCacheable(true);
    return query.list();
    
    // ç¼“å­˜å†…å®¹ï¼š
    // Key: "SELECT u.id, u.name FROM User u WHERE age > 18"  
    // Value: [[1,"å¼ ä¸‰"], [5,"æå››"], [8,"ç‹äº”"]] -> ç›´æ¥å­˜ç»“æœï¼
    // âš ï¸ æ³¨æ„ï¼šä¸ä¼šåˆ©ç”¨äºŒçº§ç¼“å­˜
}

// åœºæ™¯3ï¼šèšåˆæŸ¥è¯¢
public Long countUsers() {
    Query<Long> query = session.createQuery(
        "SELECT COUNT(u) FROM User u", Long.class
    );
    query.setCacheable(true);
    return query.uniqueResult();
    
    // ç¼“å­˜å†…å®¹ï¼š
    // Key: "SELECT COUNT(u) FROM User u"
    // Value: 150 -> ç›´æ¥å­˜è®¡æ•°ç»“æœ
}
```

**ğŸ“Š æŠ•å½±æŸ¥è¯¢ç¼“å­˜å¯¹æ¯”**

| æŸ¥è¯¢ç±»å‹ | **ç¼“å­˜å†…å®¹** | **åˆ©ç”¨äºŒçº§ç¼“å­˜** | **é€‚åˆç¼“å­˜** |
|---------|------------|----------------|------------|
| ğŸŸ¢ **å®Œæ•´å®ä½“** | `IDåˆ—è¡¨` | `âœ… æ˜¯` | `âœ… æ¨è` |
| ğŸŸ¡ **éƒ¨åˆ†å­—æ®µ** | `å­—æ®µå€¼æ•°ç»„` | `âŒ å¦` | `âš ï¸ è°¨æ…` |
| ğŸŸ¡ **èšåˆå‡½æ•°** | `è®¡ç®—ç»“æœ` | `âŒ å¦` | `âœ… é€‚åˆ` |
| ğŸ”´ **å…³è”æŸ¥è¯¢** | `å¤æ‚ç»“æœé›†` | `âš ï¸ éƒ¨åˆ†` | `âŒ ä¸æ¨è` |

### 4.3 åˆ†é¡µæŸ¥è¯¢çš„ç¼“å­˜


**ğŸ“„ åˆ†é¡µå¯¹ç¼“å­˜çš„å½±å“**

```java
// ä¸åŒåˆ†é¡µå‚æ•° = ä¸åŒç¼“å­˜Key
public List<User> findUsersPage(int pageNum, int pageSize) {
    Query<User> query = session.createQuery(
        "FROM User ORDER BY id", User.class
    );
    
    query.setFirstResult((pageNum - 1) * pageSize);  // å½±å“ç¼“å­˜Key
    query.setMaxResults(pageSize);                    // å½±å“ç¼“å­˜Key
    query.setCacheable(true);
    
    return query.list();
}

// è°ƒç”¨ç¤ºä¾‹ï¼š
findUsersPage(1, 10);  // ç¼“å­˜Key1: HQL + firstResult=0 + maxResults=10
findUsersPage(2, 10);  // ç¼“å­˜Key2: HQL + firstResult=10 + maxResults=10
findUsersPage(1, 20);  // ç¼“å­˜Key3: HQL + firstResult=0 + maxResults=20

// ä¸‰ä¸ªä¸åŒçš„ç¼“å­˜Entryï¼
```

**ğŸ¯ åˆ†é¡µç¼“å­˜ä¼˜åŒ–ç­–ç•¥**

::: warning åˆ†é¡µç¼“å­˜é™·é˜±
æ¯ä¸ªåˆ†é¡µéƒ½äº§ç”Ÿç‹¬ç«‹ç¼“å­˜ -> ç¼“å­˜åˆ©ç”¨ç‡ä½ï¼

ä¼˜åŒ–æ–¹æ¡ˆï¼š
1. **å›ºå®šåˆ†é¡µå¤§å°**ï¼šç»Ÿä¸€ä½¿ç”¨pageSize=20
2. **ç¼“å­˜é¦–é¡µ**ï¼šåªç¼“å­˜ç¬¬ä¸€é¡µå¸¸ç”¨æ•°æ®
3. **ç¼“å­˜æ€»æ•°**ï¼šå•ç‹¬ç¼“å­˜COUNTæŸ¥è¯¢
4. **é™åˆ¶é¡µæ•°**ï¼šåªç¼“å­˜å‰Né¡µ
:::

```java
// ä¼˜åŒ–åçš„åˆ†é¡µæŸ¥è¯¢
public class UserService {
    
    // 1. ç¼“å­˜æ€»æ•°æŸ¥è¯¢
    public Long getTotalUsers() {
        Query<Long> countQuery = session.createQuery(
            "SELECT COUNT(u) FROM User u", Long.class
        );
        countQuery.setCacheable(true);
        countQuery.setCacheRegion("userCountCache");
        return countQuery.uniqueResult();
    }
    
    // 2. åªç¼“å­˜å‰3é¡µ
    public List<User> findUsersPage(int pageNum, int pageSize) {
        Query<User> query = session.createQuery(
            "FROM User ORDER BY id", User.class
        );
        
        query.setFirstResult((pageNum - 1) * pageSize);
        query.setMaxResults(pageSize);
        
        // åªæœ‰å‰3é¡µæ‰ç¼“å­˜
        if (pageNum <= 3) {
            query.setCacheable(true);
            query.setCacheRegion("userPageCache");
        }
        
        return query.list();
    }
}
```

---

## 5. ğŸ”„ ç¼“å­˜å¤±æ•ˆä¸æ›´æ–°


### 5.1 è‡ªåŠ¨å¤±æ•ˆæœºåˆ¶


**â° UpdateTimestampsCacheåŸç†**

```
UpdateTimestampsCacheï¼ˆæ›´æ–°æ—¶é—´æˆ³ç¼“å­˜ï¼‰ï¼š
å°±åƒä¸€ä¸ª"æœ€åä¿®æ”¹æ—¶é—´"è®°å½•æœ¬

å·¥ä½œæœºåˆ¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¡¨å    â”‚  æœ€åæ›´æ–°æ—¶é—´      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ User    â”‚  2024-01-15 10:30 â”‚
â”‚ Order   â”‚  2024-01-15 09:20 â”‚
â”‚ Product â”‚  2024-01-15 11:45 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ£€æŸ¥é€»è¾‘ï¼š
æŸ¥è¯¢ç¼“å­˜æ—¶é—´ < è¡¨æ›´æ–°æ—¶é—´ â†’ ç¼“å­˜å¤±æ•ˆï¼
```

**ğŸ” å¤±æ•ˆæ£€æµ‹æµç¨‹**

```
æŸ¥è¯¢ç¼“å­˜éªŒè¯è¿‡ç¨‹ï¼š

1. ç”¨æˆ·å‘èµ·æŸ¥è¯¢
    â†“
2. æŸ¥æ‰¾æŸ¥è¯¢ç¼“å­˜
    â†“ (æ‰¾åˆ°)
3. è·å–ç¼“å­˜çš„æŸ¥è¯¢æ—¶é—´æˆ³ (t1)
    â†“
4. æŸ¥è¯¢UpdateTimestampsCacheè·å–è¡¨æ›´æ–°æ—¶é—´ (t2)
    â†“
5. æ¯”è¾ƒæ—¶é—´æˆ³
    â”œâ”€ t1 >= t2 â†’ ç¼“å­˜æœ‰æ•ˆï¼Œä½¿ç”¨ç¼“å­˜ç»“æœ âœ…
    â””â”€ t1 < t2  â†’ ç¼“å­˜å¤±æ•ˆï¼Œé‡æ–°æŸ¥è¯¢æ•°æ®åº“ âŒ
    â†“
6. æ›´æ–°æŸ¥è¯¢ç¼“å­˜
```

**ğŸ’» ä»£ç æ¼”ç¤ºå¤±æ•ˆè¿‡ç¨‹**

```java
// ç¬¬ä¸€æ¬¡æŸ¥è¯¢ - åˆ›å»ºç¼“å­˜
@Test
public void testCacheInvalidation() {
    Session session1 = sessionFactory.openSession();
    
    // 1. ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼Œç¼“å­˜ç»“æœ
    Query<User> query1 = session1.createQuery(
        "FROM User WHERE age > 18", User.class
    );
    query1.setCacheable(true);
    List<User> users1 = query1.list();  // æ‰§è¡ŒSQLï¼Œç¼“å­˜ç»“æœ
    
    session1.close();
    
    // 2. æ›´æ–°æ•°æ®
    Session session2 = sessionFactory.openSession();
    Transaction tx = session2.beginTransaction();
    
    User user = session2.get(User.class, 1L);
    user.setAge(25);  // ä¿®æ”¹å¹´é¾„
    
    tx.commit();  // æäº¤æ—¶æ›´æ–°UpdateTimestampsCache
    session2.close();
    
    // 3. ç¬¬äºŒæ¬¡ç›¸åŒæŸ¥è¯¢
    Session session3 = sessionFactory.openSession();
    
    Query<User> query2 = session3.createQuery(
        "FROM User WHERE age > 18", User.class
    );
    query2.setCacheable(true);
    List<User> users2 = query2.list();  
    // æ£€æµ‹åˆ°Userè¡¨æœ‰æ›´æ–° -> ç¼“å­˜å¤±æ•ˆ -> é‡æ–°æŸ¥è¯¢æ•°æ®åº“
    
    session3.close();
}
```

### 5.2 æ‰‹åŠ¨å¤±æ•ˆæ§åˆ¶


**ğŸ”§ evictæ–¹æ³•ä½¿ç”¨**

```java
public class CacheManager {
    
    @Autowired
    private SessionFactory sessionFactory;
    
    // 1. æ¸…é™¤æŒ‡å®šæŸ¥è¯¢ç¼“å­˜åŒºåŸŸ
    public void evictQueryRegion(String regionName) {
        Cache cache = sessionFactory.getCache();
        cache.evictQueryRegion(regionName);
        
        System.out.println("å·²æ¸…é™¤æŸ¥è¯¢ç¼“å­˜åŒºåŸŸ: " + regionName);
    }
    
    // 2. æ¸…é™¤æ‰€æœ‰æŸ¥è¯¢ç¼“å­˜
    public void evictAllQueryCache() {
        Cache cache = sessionFactory.getCache();
        cache.evictQueryRegions();
        
        System.out.println("å·²æ¸…é™¤æ‰€æœ‰æŸ¥è¯¢ç¼“å­˜");
    }
    
    // 3. æ¸…é™¤ç‰¹å®šå®ä½“çš„äºŒçº§ç¼“å­˜
    public void evictEntityCache(Class<?> entityClass, Serializable id) {
        Cache cache = sessionFactory.getCache();
        cache.evictEntity(entityClass, id);
        
        System.out.println("å·²æ¸…é™¤å®ä½“ç¼“å­˜: " + entityClass.getSimpleName() + "#" + id);
    }
    
    // 4. æ¸…é™¤æ•´ä¸ªå®ä½“ç±»çš„ç¼“å­˜
    public void evictEntityRegion(Class<?> entityClass) {
        Cache cache = sessionFactory.getCache();
        cache.evictEntityRegion(entityClass);
        
        System.out.println("å·²æ¸…é™¤å®ä½“åŒºåŸŸç¼“å­˜: " + entityClass.getSimpleName());
    }
}
```

**ğŸ¯ å®é™…åº”ç”¨åœºæ™¯**

```java
@Service
public class UserService {
    
    @Autowired
    private SessionFactory sessionFactory;
    
    @Autowired
    private CacheManager cacheManager;
    
    // æ‰¹é‡å¯¼å…¥ç”¨æˆ·åæ¸…é™¤ç¼“å­˜
    @Transactional
    public void batchImportUsers(List<User> users) {
        Session session = sessionFactory.getCurrentSession();
        
        for (int i = 0; i < users.size(); i++) {
            session.save(users.get(i));
            
            if (i % 50 == 0) {
                session.flush();
                session.clear();
            }
        }
        
        // å¯¼å…¥å®Œæˆï¼Œæ‰‹åŠ¨æ¸…é™¤æŸ¥è¯¢ç¼“å­˜
        cacheManager.evictQueryRegion("userQueryCache");
        cacheManager.evictEntityRegion(User.class);
    }
    
    // ä¿®æ”¹ç”¨æˆ·æ—¶æ¸…é™¤ç›¸å…³ç¼“å­˜
    @Transactional
    public void updateUserAge(Long userId, int newAge) {
        Session session = sessionFactory.getCurrentSession();
        User user = session.get(User.class, userId);
        user.setAge(newAge);
        
        // æäº¤åè‡ªåŠ¨å¤±æ•ˆUpdateTimestamps
        // ä½†ä¸ºäº†æ›´åŠæ—¶ï¼Œä¹Ÿå¯æ‰‹åŠ¨æ¸…é™¤
        cacheManager.evictQueryRegion("userQueryCache");
    }
}
```

### 5.3 ç¼“å­˜å¤±æ•ˆçš„æœ€ä½³å®è·µ


**âœ… å¤±æ•ˆç­–ç•¥é€‰æ‹©**

```
åœºæ™¯åˆ†æï¼š

ğŸŸ¢ åœºæ™¯1ï¼šæ•°æ®å¾ˆå°‘å˜åŒ–
ç­–ç•¥ï¼šä¾èµ–è‡ªåŠ¨å¤±æ•ˆæœºåˆ¶
ç¤ºä¾‹ï¼šç³»ç»Ÿé…ç½®ã€å­—å…¸è¡¨
ä»£ç ï¼šæ­£å¸¸ä½¿ç”¨ç¼“å­˜ï¼Œä¸éœ€æ‰‹åŠ¨å¹²é¢„

ğŸŸ¡ åœºæ™¯2ï¼šæ•°æ®å®šæœŸæ‰¹é‡æ›´æ–°  
ç­–ç•¥ï¼šæ›´æ–°åæ‰‹åŠ¨æ¸…é™¤ç¼“å­˜
ç¤ºä¾‹ï¼šæ¯æ—¥æ•°æ®å¯¼å…¥ã€æŠ¥è¡¨è®¡ç®—
ä»£ç ï¼š
session.flush();
cacheManager.evictQueryRegion("dataRegion");

ğŸ”´ åœºæ™¯3ï¼šæ•°æ®é¢‘ç¹å˜åŒ–
ç­–ç•¥ï¼šä¸ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜
ç¤ºä¾‹ï¼šè®¢å•çŠ¶æ€ã€åº“å­˜æ•°é‡
ä»£ç ï¼šquery.setCacheable(false);
```

**âš ï¸ å¸¸è§å¤±æ•ˆé™·é˜±**

::: warning ç¼“å­˜å¤±æ•ˆé™·é˜±
**é™·é˜±1ï¼šåŸç”ŸSQLä¸è§¦å‘å¤±æ•ˆ**
```java
// âŒ åŸç”ŸSQLæ›´æ–°ä¸ä¼šæ›´æ–°UpdateTimestamps
session.createNativeQuery("UPDATE users SET age = 20 WHERE id = 1")
       .executeUpdate();
// æŸ¥è¯¢ç¼“å­˜ä¸ä¼šå¤±æ•ˆï¼

// âœ… è§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨æ¸…é™¤
session.createNativeQuery("UPDATE users SET age = 20 WHERE id = 1")
       .addSynchronizedEntityClass(User.class)  // å…³é”®
       .executeUpdate();
```

**é™·é˜±2ï¼šè·¨SessionFactoryç¼“å­˜ä¸åŒæ­¥**
```java
// ä¸åŒåº”ç”¨å®ä¾‹çš„ç¼“å­˜æ— æ³•è‡ªåŠ¨åŒæ­¥
// éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰
```

**é™·é˜±3ï¼šå¿˜è®°é…ç½®UpdateTimestampsCache**
```xml
<!-- å¿…é¡»é…ç½®ï¼Œå¦åˆ™å¤±æ•ˆæœºåˆ¶ä¸å·¥ä½œ -->
<cache name="org.hibernate.cache.spi.UpdateTimestampsCache"
       eternal="true"/>
```
:::

---

## 6. ğŸ¯ åº”ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ


### 6.1 é€‚åˆä½¿ç”¨æŸ¥è¯¢ç¼“å­˜çš„åœºæ™¯


**âœ… ç†æƒ³åœºæ™¯åˆ†æ**

```
åœºæ™¯1ï¼šé™æ€æ•°æ®æŸ¥è¯¢
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç¤ºä¾‹ï¼š
â€¢ çœå¸‚åŒºå­—å…¸è¡¨
â€¢ å•†å“åˆ†ç±»åˆ—è¡¨
â€¢ ç³»ç»Ÿé…ç½®é¡¹

ç‰¹ç‚¹ï¼š
âœ“ æ•°æ®å¾ˆå°‘å˜åŒ–
âœ“ æŸ¥è¯¢é¢‘ç‡æé«˜
âœ“ æŸ¥è¯¢æ¡ä»¶å›ºå®š

ä»£ç ç¤ºä¾‹ï¼š
@Cacheable(region = "dictionaryCache")
public List<Province> getAllProvinces() {
    return session.createQuery(
        "FROM Province ORDER BY code", Province.class
    ).setCacheable(true).list();
}
```

```
åœºæ™¯2ï¼šå¤æ‚æŠ¥è¡¨æŸ¥è¯¢
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç¤ºä¾‹ï¼š
â€¢ é”€å”®æ•°æ®ç»Ÿè®¡
â€¢ ç”¨æˆ·è¡Œä¸ºåˆ†æ
â€¢ è´¢åŠ¡æŠ¥è¡¨æ±‡æ€»

ç‰¹ç‚¹ï¼š
âœ“ æŸ¥è¯¢é€»è¾‘å¤æ‚
âœ“ æ‰§è¡Œæ—¶é—´é•¿
âœ“ ç»“æœç›¸å¯¹ç¨³å®š

ä»£ç ç¤ºä¾‹ï¼š
public SalesReport getDailySalesReport(Date date) {
    Query<Object[]> query = session.createQuery(
        "SELECT p.category, SUM(o.amount), COUNT(o) " +
        "FROM Order o JOIN o.product p " +
        "WHERE DATE(o.createTime) = :date " +
        "GROUP BY p.category"
    );
    query.setParameter("date", date);
    query.setCacheable(true);
    query.setCacheRegion("salesReportCache");
    return query.list();
}
```

```
åœºæ™¯3ï¼šåˆ†é¡µé¦–é¡µæŸ¥è¯¢
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç¤ºä¾‹ï¼š
â€¢ æ–‡ç« åˆ—è¡¨é¦–é¡µ
â€¢ å•†å“æ¨èé¦–é¡µ
â€¢ çƒ­é—¨è¯é¢˜é¦–é¡µ

ç‰¹ç‚¹ï¼š
âœ“ é¦–é¡µè®¿é—®é‡å¤§
âœ“ ç›¸åŒåˆ†é¡µå‚æ•°å¤š
âœ“ æ•°æ®å¯æ¥å—å»¶è¿Ÿ

ä»£ç ç¤ºä¾‹ï¼š
@Cacheable
public List<Article> getHotArticles() {
    return session.createQuery(
        "FROM Article WHERE status = 'PUBLISHED' " +
        "ORDER BY viewCount DESC", Article.class
    )
    .setMaxResults(10)
    .setCacheable(true)
    .setCacheRegion("hotArticleCache")
    .list();
}
```

### 6.2 ä¸é€‚åˆä½¿ç”¨çš„åœºæ™¯


**âŒ é¿å…ä½¿ç”¨çš„æƒ…å†µ**

```
åœºæ™¯1ï¼šé«˜é¢‘æ›´æ–°æ•°æ®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç¤ºä¾‹ï¼š
â€¢ å•†å“åº“å­˜
â€¢ è®¢å•çŠ¶æ€
â€¢ åœ¨çº¿ç”¨æˆ·æ•°

é—®é¢˜ï¼š
âœ— é¢‘ç¹å¤±æ•ˆ -> ç¼“å­˜å‘½ä¸­ç‡ä½
âœ— åè€Œå¢åŠ ç³»ç»Ÿå¼€é”€
âœ— æ•°æ®ä¸€è‡´æ€§é£é™©

// âŒ é”™è¯¯ç¤ºä¾‹
public int getProductStock(Long productId) {
    // åº“å­˜é¢‘ç¹å˜åŒ–ï¼Œç¼“å­˜æ— æ„ä¹‰
    Query<Integer> query = session.createQuery(
        "SELECT p.stock FROM Product p WHERE p.id = :id"
    );
    query.setParameter("id", productId);
    query.setCacheable(true);  // ä¸åº”è¯¥ç¼“å­˜ï¼
    return query.uniqueResult();
}
```

```
åœºæ™¯2ï¼šä¸ªæ€§åŒ–æŸ¥è¯¢
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç¤ºä¾‹ï¼š
â€¢ ç”¨æˆ·ä¸ªäººè®¢å•åˆ—è¡¨
â€¢ è´­ç‰©è½¦å†…å®¹
â€¢ ä¸ªäººæ¶ˆæ¯é€šçŸ¥

é—®é¢˜ï¼š
âœ— æ¯ä¸ªç”¨æˆ·æŸ¥è¯¢æ¡ä»¶ä¸åŒ
âœ— ç¼“å­˜Keyç¢ç‰‡åŒ–ä¸¥é‡
âœ— å†…å­˜å ç”¨é«˜ï¼Œå‘½ä¸­ç‡ä½

// âŒ é”™è¯¯ç¤ºä¾‹
public List<Order> getUserOrders(Long userId) {
    // æ¯ä¸ªç”¨æˆ·éƒ½æœ‰ä¸åŒçš„æŸ¥è¯¢ -> ç¼“å­˜åˆ©ç”¨ç‡æä½
    return session.createQuery(
        "FROM Order WHERE userId = :userId", Order.class
    )
    .setParameter("userId", userId)
    .setCacheable(true)  // æµªè´¹å†…å­˜ï¼
    .list();
}
```

```
åœºæ™¯3ï¼šå®æ—¶æ€§è¦æ±‚é«˜
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç¤ºä¾‹ï¼š
â€¢ æ”¯ä»˜ç»“æœæŸ¥è¯¢
â€¢ ç§’æ€å•†å“çŠ¶æ€
â€¢ å®æ—¶é€šçŸ¥æ¶ˆæ¯

é—®é¢˜ï¼š
âœ— ç¼“å­˜æœ‰å»¶è¿Ÿ
âœ— å¯èƒ½æ˜¾ç¤ºè¿‡æœŸæ•°æ®
âœ— å½±å“ç”¨æˆ·ä½“éªŒ

// âŒ é”™è¯¯ç¤ºä¾‹
public PaymentStatus getPaymentStatus(String orderId) {
    // æ”¯ä»˜çŠ¶æ€éœ€è¦å®æ—¶ï¼Œä¸èƒ½ç¼“å­˜
    return session.createQuery(
        "SELECT p.status FROM Payment p WHERE p.orderId = :orderId"
    )
    .setParameter("orderId", orderId)
    .setCacheable(true)  // å±é™©ï¼å¯èƒ½æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
    .uniqueResult();
}
```

### 6.3 æœ€ä½³å®è·µæ€»ç»“


**ğŸ† æŸ¥è¯¢ç¼“å­˜ä½¿ç”¨æŒ‡å—**

```
å®è·µ1ï¼šç¼“å­˜åŒºåŸŸè§„åˆ’
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æŒ‰ä¸šåŠ¡æ¨¡å—åˆ’åˆ†ç¼“å­˜åŒºåŸŸï¼š

CacheRegions.java:
public interface CacheRegions {
    // å­—å…¸ç±»æ•°æ®ï¼šé•¿æœŸç¼“å­˜
    String DICTIONARY = "dictionaryCache";
    String CATEGORY = "categoryCache";
    
    // å†…å®¹ç±»æ•°æ®ï¼šä¸­æœŸç¼“å­˜
    String ARTICLE = "articleCache";
    String PRODUCT = "productCache";
    
    // ç»Ÿè®¡ç±»æ•°æ®ï¼šçŸ­æœŸç¼“å­˜
    String REPORT = "reportCache";
    String STATISTICS = "statisticsCache";
}

ä½¿ç”¨ç¤ºä¾‹ï¼š
query.setCacheRegion(CacheRegions.DICTIONARY);
```

```
å®è·µ2ï¼šç¼“å­˜æ—¶é—´æ§åˆ¶
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ ¹æ®æ•°æ®ç‰¹æ€§è®¾ç½®TTLï¼š

ehcache.xml:
<!-- å­—å…¸æ•°æ®ï¼š1å°æ—¶è¿‡æœŸ -->
<cache name="dictionaryCache"
       timeToLiveSeconds="3600"/>

<!-- æ–‡ç« æ•°æ®ï¼š10åˆ†é’Ÿè¿‡æœŸ -->  
<cache name="articleCache"
       timeToLiveSeconds="600"/>

<!-- ç»Ÿè®¡æ•°æ®ï¼š5åˆ†é’Ÿè¿‡æœŸ -->
<cache name="reportCache"
       timeToLiveSeconds="300"/>
```

```
å®è·µ3ï¼šæ¡ä»¶æ€§å¯ç”¨ç¼“å­˜
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ ¹æ®æŸ¥è¯¢å‚æ•°å†³å®šæ˜¯å¦ç¼“å­˜ï¼š

public List<Article> searchArticles(
    String keyword, 
    String category,
    int pageNum
) {
    Query<Article> query = buildQuery(keyword, category);
    
    // åªæœ‰æŸ¥è¯¢çƒ­é—¨åˆ†ç±»ä¸”æ˜¯é¦–é¡µæ—¶æ‰ç¼“å­˜
    boolean shouldCache = 
        isHotCategory(category) && pageNum == 1;
    
    if (shouldCache) {
        query.setCacheable(true);
        query.setCacheRegion(CacheRegions.ARTICLE);
    }
    
    return query.list();
}
```

**ğŸ“‹ å†³ç­–æµç¨‹å›¾**

```
æ˜¯å¦ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ï¼Ÿ

å¼€å§‹
  â†“
æŸ¥è¯¢é¢‘ç‡é«˜ï¼Ÿ
  â”œâ”€ å¦ â†’ ä¸ä½¿ç”¨ç¼“å­˜ âŒ
  â””â”€ æ˜¯
      â†“
  æ•°æ®å˜åŒ–é¢‘ç¹ï¼Ÿ
      â”œâ”€ æ˜¯ â†’ ä¸ä½¿ç”¨ç¼“å­˜ âŒ
      â””â”€ å¦
          â†“
      æŸ¥è¯¢æ¡ä»¶å›ºå®šï¼Ÿ
          â”œâ”€ å¦ â†’ è°¨æ…ä½¿ç”¨ âš ï¸
          â””â”€ æ˜¯
              â†“
          å¯¹å»¶è¿Ÿå®¹å¿ï¼Ÿ
              â”œâ”€ å¦ â†’ ä¸ä½¿ç”¨ç¼“å­˜ âŒ
              â””â”€ æ˜¯
                  â†“
              ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ âœ…
```

---

## 7. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 7.1 æŸ¥è¯¢ç¼“å­˜æ€§èƒ½åˆ†æ


**ğŸ“Š æ€§èƒ½æŒ‡æ ‡ç›‘æ§**

```java
@Component
public class QueryCacheMonitor {
    
    @Autowired
    private SessionFactory sessionFactory;
    
    // è·å–æŸ¥è¯¢ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
    public void printCacheStatistics() {
        Statistics stats = sessionFactory.getStatistics();
        
        if (!stats.isStatisticsEnabled()) {
            stats.setStatisticsEnabled(true);
        }
        
        System.out.println("â”â”â”â” æŸ¥è¯¢ç¼“å­˜ç»Ÿè®¡ â”â”â”â”");
        System.out.println("æŸ¥è¯¢æ‰§è¡Œæ¬¡æ•°: " + stats.getQueryExecutionCount());
        System.out.println("ç¼“å­˜å‘½ä¸­æ¬¡æ•°: " + stats.getQueryCacheHitCount());
        System.out.println("ç¼“å­˜æœªå‘½ä¸­: " + stats.getQueryCacheMissCount());
        System.out.println("ç¼“å­˜å­˜å…¥æ¬¡æ•°: " + stats.getQueryCachePutCount());
        
        // è®¡ç®—å‘½ä¸­ç‡
        long hits = stats.getQueryCacheHitCount();
        long total = hits + stats.getQueryCacheMissCount();
        double hitRate = total > 0 ? (hits * 100.0 / total) : 0;
        
        System.out.println("ç¼“å­˜å‘½ä¸­ç‡: " + String.format("%.2f%%", hitRate));
        
        // å„åŒºåŸŸç»Ÿè®¡
        String[] regions = stats.getSecondLevelCacheRegionNames();
        for (String region : regions) {
            SecondLevelCacheStatistics regionStats = 
                stats.getSecondLevelCacheStatistics(region);
            
            System.out.println("\nåŒºåŸŸ: " + region);
            System.out.println("  å‘½ä¸­: " + regionStats.getHitCount());
            System.out.println("  æœªå‘½ä¸­: " + regionStats.getMissCount());
            System.out.println("  å†…å­˜å ç”¨: " + regionStats.getSizeInMemory() + " bytes");
        }
    }
    
    // æ¸…é™¤ç»Ÿè®¡
    public void clearStatistics() {
        sessionFactory.getStatistics().clear();
    }
}
```

**ğŸ¯ æ€§èƒ½ç“¶é¢ˆè¯†åˆ«**

```
æ€§èƒ½é—®é¢˜è¯Šæ–­ï¼š

é—®é¢˜1ï¼šç¼“å­˜å‘½ä¸­ç‡ä½ (<30%)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å¯èƒ½åŸå› ï¼š
â€¢ æŸ¥è¯¢æ¡ä»¶å˜åŒ–å¤ªé¢‘ç¹
â€¢ ç¼“å­˜åŒºåŸŸé…ç½®å¤ªå°
â€¢ ç¼“å­˜è¿‡æœŸæ—¶é—´å¤ªçŸ­

è§£å†³æ–¹æ¡ˆï¼š
1. æ£€æŸ¥æŸ¥è¯¢æ¨¡å¼ï¼Œå›ºå®šå¸¸ç”¨æŸ¥è¯¢
2. å¢å¤§ç¼“å­˜åŒºåŸŸmaxEntries
3. é€‚å½“å»¶é•¿TTLæ—¶é—´

é—®é¢˜2ï¼šå†…å­˜å ç”¨è¿‡é«˜
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å¯èƒ½åŸå› ï¼š
â€¢ ç¼“å­˜äº†å¤§é‡æŠ•å½±æŸ¥è¯¢ç»“æœ
â€¢ ç¼“å­˜Keyç¢ç‰‡åŒ–
â€¢ æ²¡æœ‰è®¾ç½®æ·˜æ±°ç­–ç•¥

è§£å†³æ–¹æ¡ˆï¼š
1. é¿å…ç¼“å­˜æŠ•å½±æŸ¥è¯¢
2. é™åˆ¶ç¼“å­˜æ¡ç›®æ•°é‡
3. å¯ç”¨LRUæ·˜æ±°ç®—æ³•

é—®é¢˜3ï¼šç¼“å­˜é¢‘ç¹å¤±æ•ˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å¯èƒ½åŸå› ï¼š
â€¢ æ•°æ®æ›´æ–°å¤ªé¢‘ç¹
â€¢ UpdateTimestampsç²’åº¦å¤ªç²—
â€¢ ä¸é€‚åˆä½¿ç”¨æŸ¥è¯¢ç¼“å­˜

è§£å†³æ–¹æ¡ˆï¼š
1. è¯„ä¼°æ˜¯å¦çœŸçš„éœ€è¦ç¼“å­˜
2. è€ƒè™‘åº”ç”¨å±‚ç¼“å­˜ï¼ˆRedisï¼‰
3. ç¼©çŸ­ç¼“å­˜æ—¶é—´æˆ–ä¸ç¼“å­˜
```

### 7.2 ç¼“å­˜é…ç½®ä¼˜åŒ–


**ğŸ”§ EhCacheé«˜çº§é…ç½®**

```xml
<!-- ehcache.xml ä¼˜åŒ–é…ç½® -->
<ehcache>
    <!-- é€šç”¨é…ç½® -->
    <defaultCache
        maxEntriesLocalHeap="1000"
        eternal="false"
        timeToIdleSeconds="600"
        timeToLiveSeconds="1800"
        memoryStoreEvictionPolicy="LRU"/>
    
    <!-- çƒ­ç‚¹æŸ¥è¯¢ç¼“å­˜ï¼šå¤§å®¹é‡ã€é•¿æ—¶é—´ -->
    <cache name="hotQueryCache"
           maxEntriesLocalHeap="5000"
           timeToLiveSeconds="7200"
           timeToIdleSeconds="3600"
           memoryStoreEvictionPolicy="LFU">
        <persistence strategy="localTempSwap"/>  <!-- æº¢å‡ºåˆ°ç£ç›˜ -->
    </cache>
    
    <!-- ä¸´æ—¶æŸ¥è¯¢ç¼“å­˜ï¼šå°å®¹é‡ã€çŸ­æ—¶é—´ -->
    <cache name="tempQueryCache"
           maxEntriesLocalHeap="500"
           timeToLiveSeconds="300"
           timeToIdleSeconds="180"
           memoryStoreEvictionPolicy="LRU"/>
    
    <!-- æ›´æ–°æ—¶é—´æˆ³ç¼“å­˜ï¼šæ°¸ä¸è¿‡æœŸ -->
    <cache name="org.hibernate.cache.spi.UpdateTimestampsCache"
           maxEntriesLocalHeap="5000"
           eternal="true"/>
    
    <!-- æ ‡å‡†æŸ¥è¯¢ç¼“å­˜ -->
    <cache name="org.hibernate.cache.internal.StandardQueryCache"
           maxEntriesLocalHeap="2000"
           timeToLiveSeconds="3600"
           statistics="true"/>  <!-- å¯ç”¨ç»Ÿè®¡ -->
</ehcache>
```

**ğŸ¯ Hibernateé…ç½®ä¼˜åŒ–**

```xml
<!-- hibernate.cfg.xml -->
<hibernate-configuration>
    <session-factory>
        <!-- æŸ¥è¯¢ç¼“å­˜åŸºç¡€é…ç½® -->
        <property name="hibernate.cache.use_query_cache">true</property>
        <property name="hibernate.cache.use_second_level_cache">true</property>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯æ”¶é›† -->
        <property name="hibernate.generate_statistics">true</property>
        
        <!-- æŸ¥è¯¢ç¼“å­˜å·¥å‚ï¼ˆå¯é€‰é…ç½®ï¼‰ -->
        <property name="hibernate.cache.query_cache_factory">
            org.hibernate.cache.internal.StandardQueryCacheFactory
        </property>
        
        <!-- æ‰¹å¤„ç†ä¼˜åŒ– -->
        <property name="hibernate.jdbc.batch_size">50</property>
        <property name="hibernate.order_inserts">true</property>
        <property name="hibernate.order_updates">true</property>
        
        <!-- SQLæ—¥å¿—ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ -->
        <property name="hibernate.show_sql">true</property>
        <property name="hibernate.format_sql">true</property>
        <property name="hibernate.use_sql_comments">true</property>
    </session-factory>
</hibernate-configuration>
```

### 7.3 ç»¼åˆä¼˜åŒ–å®è·µ


**ğŸš€ å®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆ**

```java
@Service
public class OptimizedQueryService {
    
    @Autowired
    private SessionFactory sessionFactory;
    
    // ä¼˜åŒ–1ï¼šæŸ¥è¯¢ç»“æœé¢„çƒ­
    @PostConstruct
    public void warmUpCache() {
        Session session = sessionFactory.openSession();
        
        try {
            // é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
            session.createQuery("FROM Category ORDER BY sort", Category.class)
                   .setCacheable(true)
                   .setCacheRegion(CacheRegions.DICTIONARY)
                   .list();
            
            session.createQuery("FROM Province ORDER BY code", Province.class)
                   .setCacheable(true)
                   .setCacheRegion(CacheRegions.DICTIONARY)
                   .list();
            
            System.out.println("ç¼“å­˜é¢„çƒ­å®Œæˆ");
        } finally {
            session.close();
        }
    }
    
    // ä¼˜åŒ–2ï¼šæ™ºèƒ½ç¼“å­˜ç­–ç•¥
    public List<Article> findArticles(
        String category,
        String keyword,
        int pageNum
    ) {
        Session session = sessionFactory.getCurrentSession();
        
        StringBuilder hql = new StringBuilder("FROM Article WHERE 1=1");
        
        if (category != null) {
            hql.append(" AND category = :category");
        }
        if (keyword != null) {
            hql.append(" AND title LIKE :keyword");
        }
        hql.append(" ORDER BY createTime DESC");
        
        Query<Article> query = session.createQuery(hql.toString(), Article.class);
        
        if (category != null) {
            query.setParameter("category", category);
        }
        if (keyword != null) {
            query.setParameter("keyword", "%" + keyword + "%");
        }
        
        query.setFirstResult((pageNum - 1) * 20);
        query.setMaxResults(20);
        
        // åªæœ‰ç®€å•æŸ¥è¯¢ä¸”é¦–é¡µæ‰ç¼“å­˜
        if (keyword == null && pageNum == 1) {
            query.setCacheable(true);
            query.setCacheRegion(CacheRegions.ARTICLE);
        }
        
        return query.list();
    }
    
    // ä¼˜åŒ–3ï¼šæ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
    @Transactional(readOnly = true)
    public Map<Long, User> batchGetUsers(List<Long> userIds) {
        if (userIds.isEmpty()) {
            return Collections.emptyMap();
        }
        
        Session session = sessionFactory.getCurrentSession();
        
        // å…ˆä»äºŒçº§ç¼“å­˜æ‰¹é‡è·å–
        Map<Long, User> result = new HashMap<>();
        List<Long> missedIds = new ArrayList<>();
        
        for (Long id : userIds) {
            User user = session.get(User.class, id);
            if (user != null) {
                result.put(id, user);
            } else {
                missedIds.add(id);
            }
        }
        
        // å¦‚æœæœ‰æœªå‘½ä¸­çš„ï¼Œæ‰¹é‡æŸ¥è¯¢
        if (!missedIds.isEmpty()) {
            List<User> users = session.createQuery(
                "FROM User WHERE id IN :ids", User.class
            )
            .setParameterList("ids", missedIds)
            .setCacheable(true)
            .list();
            
            users.forEach(u -> result.put(u.getId(), u));
        }
        
        return result;
    }
    
    // ä¼˜åŒ–4ï¼šå®šæœŸç¼“å­˜ç»´æŠ¤
    @Scheduled(cron = "0 0 2 * * ?")  // æ¯å¤©å‡Œæ™¨2ç‚¹
    public void maintainCache() {
        Cache cache = sessionFactory.getCache();
        Statistics stats = sessionFactory.getStatistics();
        
        // æ‰“å°ç»Ÿè®¡
        System.out.println("ç¼“å­˜ç»´æŠ¤ - å‘½ä¸­ç‡: " + 
            stats.getQueryCacheHitCount() * 100.0 / 
            (stats.getQueryCacheHitCount() + stats.getQueryCacheMissCount()));
        
        // æ¸…ç†ä½æ•ˆç¼“å­˜åŒºåŸŸ
        if (stats.getQueryCacheHitCount() < 100) {
            cache.evictQueryRegion("tempQueryCache");
        }
        
        // é‡ç½®ç»Ÿè®¡
        stats.clear();
    }
}
```

**ğŸ“Š æ€§èƒ½å¯¹æ¯”ç»“æœ**

```
ä¼˜åŒ–å‰ vs ä¼˜åŒ–åæ€§èƒ½å¯¹æ¯”ï¼š

æµ‹è¯•åœºæ™¯ï¼š1000æ¬¡ç›¸åŒæŸ¥è¯¢
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ä¼˜åŒ–å‰    ä¼˜åŒ–å    æå‡
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ•°æ®åº“æŸ¥è¯¢  1000æ¬¡   1æ¬¡      99.9% â¬‡ï¸
å¹³å‡å“åº”    150ms    3ms      98% â¬‡ï¸
ååé‡     66/s     3333/s    50å€ â¬†ï¸
ç¼“å­˜å‘½ä¸­ç‡   0%      99%      -
å†…å­˜å ç”¨    50MB     120MB    140% â¬†ï¸
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç»“è®ºï¼š
âœ… å“åº”é€Ÿåº¦æå‡98%
âœ… ååé‡æå‡50å€
âœ… æ•°æ®åº“å‹åŠ›é™ä½99%
âš ï¸  å†…å­˜å ç”¨å¢åŠ 40%ï¼ˆå¯æ¥å—ï¼‰
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æŸ¥è¯¢ç¼“å­˜æœ¬è´¨ï¼šç¼“å­˜HQLæŸ¥è¯¢çš„IDåˆ—è¡¨ï¼Œé…åˆäºŒçº§ç¼“å­˜ä½¿ç”¨
ğŸ”¸ ç¼“å­˜æœºåˆ¶ï¼šQuery Cacheå­˜IDï¼ŒSecond Level Cacheå­˜å¯¹è±¡
ğŸ”¸ å¤±æ•ˆæœºåˆ¶ï¼šUpdateTimestampsCacheè‡ªåŠ¨æ£€æµ‹è¡¨æ›´æ–°
ğŸ”¸ ç¼“å­˜ç²’åº¦ï¼šæ¯ä¸ªæŸ¥è¯¢ï¼ˆHQL+å‚æ•°ï¼‰éƒ½æ˜¯ç‹¬ç«‹çš„ç¼“å­˜Key
ğŸ”¸ ä¾èµ–å…³ç³»ï¼šæŸ¥è¯¢ç¼“å­˜å¿…é¡»ä¾èµ–äºŒçº§ç¼“å­˜æ‰èƒ½å·¥ä½œ
```

### 8.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•**

- [x] **å¯ç”¨äºŒçº§ç¼“å­˜**ï¼š`hibernate.cache.use_second_level_cache=true`
- [x] **å¯ç”¨æŸ¥è¯¢ç¼“å­˜**ï¼š`hibernate.cache.use_query_cache=true`
- [x] **é…ç½®ç¼“å­˜æä¾›è€…**ï¼šEhCacheæˆ–å…¶ä»–
- [x] **å®ä½“ç±»æ·»åŠ @Cacheæ³¨è§£**
- [x] **æŸ¥è¯¢è®¾ç½®setCacheable(true)**
- [x] **é…ç½®UpdateTimestampsCache**ï¼ˆeternal=trueï¼‰
- [x] **åˆç†åˆ’åˆ†ç¼“å­˜åŒºåŸŸ**

### 8.3 ä½¿ç”¨å†³ç­–æŒ‡å—


**ğŸ¯ ä»€ä¹ˆæ—¶å€™ç”¨æŸ¥è¯¢ç¼“å­˜ï¼Ÿ**

```
âœ… ä½¿ç”¨åœºæ™¯ï¼ˆå‘½ä¸­ç‡>50%ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ æ•°æ®å˜åŒ–å°‘ã€æŸ¥è¯¢é¢‘ç¹
â€¢ æŸ¥è¯¢æ¡ä»¶å›ºå®šã€é‡å¤åº¦é«˜
â€¢ å¤æ‚æŸ¥è¯¢ã€æ‰§è¡Œæ—¶é—´é•¿
â€¢ å¯¹æ•°æ®å»¶è¿Ÿä¸æ•æ„Ÿ

ç¤ºä¾‹ï¼š
- å­—å…¸è¡¨ã€é…ç½®è¡¨
- åˆ†ç±»åˆ—è¡¨ã€æ ‡ç­¾äº‘
- ç»Ÿè®¡æŠ¥è¡¨ã€æ’è¡Œæ¦œ
- é¦–é¡µæ¨èã€çƒ­é—¨æ•°æ®

âŒ é¿å…åœºæ™¯ï¼ˆå‘½ä¸­ç‡<30%ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ æ•°æ®æ›´æ–°é¢‘ç¹
â€¢ æŸ¥è¯¢æ¡ä»¶ä¸ªæ€§åŒ–
â€¢ å®æ—¶æ€§è¦æ±‚é«˜
â€¢ ç»“æœé›†è¿‡å¤§

ç¤ºä¾‹ï¼š
- åº“å­˜æ•°é‡ã€è®¢å•çŠ¶æ€
- ç”¨æˆ·ä¸ªäººæ•°æ®
- æ”¯ä»˜ç»“æœã€ç§’æ€
- å…¨è¡¨æ‰«æ
```

### 8.4 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹


**âš¡ ä¼˜åŒ–ç­–ç•¥æ€»ç»“**

```
1ï¸âƒ£ ç¼“å­˜åŒºåŸŸè§„åˆ’
   â€¢ æŒ‰ä¸šåŠ¡æ¨¡å—åˆ’åˆ†
   â€¢ è®¾ç½®åˆç†çš„TTL
   â€¢ é™åˆ¶æ¡ç›®æ•°é‡

2ï¸âƒ£ æŸ¥è¯¢ä¼˜åŒ–
   â€¢ ä¼˜å…ˆç¼“å­˜å®Œæ•´å®ä½“æŸ¥è¯¢
   â€¢ æ…é‡ç¼“å­˜æŠ•å½±æŸ¥è¯¢
   â€¢ æ§åˆ¶åˆ†é¡µç¼“å­˜èŒƒå›´

3ï¸âƒ£ å¤±æ•ˆæ§åˆ¶
   â€¢ ä¾èµ–è‡ªåŠ¨å¤±æ•ˆæœºåˆ¶
   â€¢ æ‰¹é‡æ“ä½œåæ‰‹åŠ¨æ¸…é™¤
   â€¢ åŸç”ŸSQLéœ€è¦addSynchronized

4ï¸âƒ£ ç›‘æ§è°ƒä¼˜
   â€¢ å¼€å¯statisticsç»Ÿè®¡
   â€¢ å®šæœŸåˆ†æå‘½ä¸­ç‡
   â€¢ æ·˜æ±°ä½æ•ˆç¼“å­˜åŒºåŸŸ
```

### 8.5 å¸¸è§é—®é¢˜è§£å†³


**ğŸ”§ é—®é¢˜æ’æŸ¥æ¸…å•**

| é—®é¢˜ç°è±¡ | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|---------|------------|------------|
| ğŸ”´ **ç¼“å­˜ä¸ç”Ÿæ•ˆ** | `æœªå¼€å¯å…¨å±€å¼€å…³` | `æ£€æŸ¥hibernate.cache.use_query_cache` |
| ğŸ”´ **å‘½ä¸­ç‡ä¸º0** | `å¿˜è®°setCacheable` | `query.setCacheable(true)` |
| ğŸŸ¡ **ç¼“å­˜ä¸å¤±æ•ˆ** | `UpdateTimestampsæœªé…ç½®` | `é…ç½®eternal=trueçš„ç¼“å­˜åŒºåŸŸ` |
| ğŸŸ¡ **å†…å­˜å ç”¨é«˜** | `ç¼“å­˜äº†å¤§é‡æŠ•å½±æŸ¥è¯¢` | `åªç¼“å­˜å®ä½“æŸ¥è¯¢` |
| ğŸŸ¡ **å‘½ä¸­ç‡ä½** | `æŸ¥è¯¢æ¡ä»¶å˜åŒ–å¤§` | `è¯„ä¼°æ˜¯å¦é€‚åˆç¼“å­˜` |
| ğŸŸ¢ **æ€§èƒ½åé™** | `é¢‘ç¹å¤±æ•ˆ+æŸ¥è¯¢å¼€é”€` | `å…³é—­ç¼“å­˜æˆ–å»¶é•¿TTL` |

### 8.6 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š è¿›é˜¶å­¦ä¹ æ­¥éª¤**

```
ç¬¬1æ­¥ï¼šç†è§£åŸºç¡€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ æŸ¥è¯¢ç¼“å­˜ vs äºŒçº§ç¼“å­˜çš„åŒºåˆ«
âœ“ ç¼“å­˜çš„å­˜å‚¨ç»“æ„å’Œå·¥ä½œæµç¨‹
âœ“ UpdateTimestampsCacheå¤±æ•ˆæœºåˆ¶

ç¬¬2æ­¥ï¼šå®è·µé…ç½®
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ æ­å»ºHibernate + EhCacheç¯å¢ƒ
âœ“ é…ç½®æŸ¥è¯¢ç¼“å­˜å¹¶éªŒè¯ç”Ÿæ•ˆ
âœ“ ä½¿ç”¨Statisticsç›‘æ§ç¼“å­˜çŠ¶æ€

ç¬¬3æ­¥ï¼šåœºæ™¯åº”ç”¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ è¯†åˆ«é€‚åˆç¼“å­˜çš„ä¸šåŠ¡åœºæ™¯
âœ“ å®ç°ç¼“å­˜é¢„çƒ­å’Œæ‰‹åŠ¨å¤±æ•ˆ
âœ“ åˆ’åˆ†ç¼“å­˜åŒºåŸŸå¹¶ä¼˜åŒ–é…ç½®

ç¬¬4æ­¥ï¼šæ€§èƒ½è°ƒä¼˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ åˆ†æç¼“å­˜å‘½ä¸­ç‡å’Œå†…å­˜å ç”¨
âœ“ ä¼˜åŒ–æŸ¥è¯¢è¯­å¥å’Œç¼“å­˜ç­–ç•¥
âœ“ å¤„ç†ç¼“å­˜å¤±æ•ˆå’Œä¸€è‡´æ€§é—®é¢˜

ç¬¬5æ­¥ï¼šåˆ†å¸ƒå¼ç¼“å­˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ äº†è§£é›†ç¾¤ç¯å¢ƒçš„ç¼“å­˜åŒæ­¥
âœ“ å­¦ä¹ Redisç­‰åˆ†å¸ƒå¼ç¼“å­˜æ–¹æ¡ˆ
âœ“ æŒæ¡ç¼“å­˜ä¸€è‡´æ€§ä¿è¯æœºåˆ¶
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æŸ¥è¯¢ç¼“å­˜å­˜IDè¡¨ï¼Œé…åˆäºŒçº§æ‰¾å¯¹è±¡
æ¡ä»¶å›ºå®šé¢‘ç‡é«˜ï¼Œç¼“å­˜æ•ˆæœæ‰èƒ½å¥½
æ›´æ–°é¢‘ç¹æ…ä½¿ç”¨ï¼Œå‘½ä¸­ç‡ä½åæ‹–ç´¯
ç›‘æ§ç»Ÿè®¡å‹¤åˆ†æ,ä¼˜åŒ–è°ƒæ•´ä¸æ”¾æ¾
```

**ğŸ¯ ä¸€å¥è¯æ€»ç»“**ï¼š
æŸ¥è¯¢ç¼“å­˜é€šè¿‡ç¼“å­˜æŸ¥è¯¢ç»“æœçš„IDåˆ—è¡¨ï¼Œé…åˆäºŒçº§ç¼“å­˜å¿«é€Ÿè·å–å¯¹è±¡ï¼Œé€‚åˆæ•°æ®ç¨³å®šã€æŸ¥è¯¢é¢‘ç¹çš„åœºæ™¯ï¼Œæ˜¯æå‡HibernateæŸ¥è¯¢æ€§èƒ½çš„é‡è¦æ‰‹æ®µï¼Œä½†éœ€è¦æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹åˆç†ä½¿ç”¨å’Œç›‘æ§ä¼˜åŒ–ã€‚