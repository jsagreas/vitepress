---
title: 51ã€æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [SQLä¼˜åŒ–ç­–ç•¥](#1-SQLä¼˜åŒ–ç­–ç•¥)
2. [ç´¢å¼•ä½¿ç”¨åŸåˆ™](#2-ç´¢å¼•ä½¿ç”¨åŸåˆ™)
3. [æ‰§è¡Œè®¡åˆ’åˆ†æ](#3-æ‰§è¡Œè®¡åˆ’åˆ†æ)
4. [ç»Ÿè®¡ä¿¡æ¯ç»´æŠ¤](#4-ç»Ÿè®¡ä¿¡æ¯ç»´æŠ¤)
5. [æŸ¥è¯¢ç¼“å­˜ä½¿ç”¨](#5-æŸ¥è¯¢ç¼“å­˜ä½¿ç”¨)
6. [åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–](#6-åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–)
7. [è¿æ¥æŸ¥è¯¢ä¼˜åŒ–](#7-è¿æ¥æŸ¥è¯¢ä¼˜åŒ–)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ SQLä¼˜åŒ–ç­–ç•¥


### 1.1 ä»€ä¹ˆæ˜¯SQLä¼˜åŒ–


**ğŸ’¡ é€šä¿—ç†è§£**

æƒ³è±¡ä½ å»å›¾ä¹¦é¦†æ‰¾ä¹¦ï¼š
- **ç¬¨åŠæ³•**ï¼šä»ç¬¬ä¸€æ’ä¹¦æ¶å¼€å§‹ï¼Œä¸€æœ¬æœ¬ç¿»çœ‹ï¼Œç›´åˆ°æ‰¾åˆ°ç›®æ ‡ä¹¦ç±
- **èªæ˜åŠæ³•**ï¼šå…ˆæŸ¥ç›®å½•å¡ç‰‡ï¼Œç›´æ¥å®šä½åˆ°å…·ä½“ä¹¦æ¶ï¼Œå¿«é€Ÿæ‰¾åˆ°ä¹¦

SQLä¼˜åŒ–å°±æ˜¯æ•™Hibernateç”¨"èªæ˜åŠæ³•"æŸ¥æ•°æ®åº“ï¼Œè®©æŸ¥è¯¢é€Ÿåº¦æ›´å¿«ã€èµ„æºæ¶ˆè€—æ›´å°‘ã€‚

> **æ ¸å¿ƒç›®æ ‡**ï¼šç”¨æœ€å°‘çš„èµ„æºã€æœ€å¿«çš„é€Ÿåº¦ï¼Œå¾—åˆ°æˆ‘ä»¬éœ€è¦çš„æ•°æ®

### 1.2 åªæŸ¥éœ€è¦çš„å­—æ®µ


**âŒ å¸¸è§é”™è¯¯åšæ³•**

```java
// é”™è¯¯ï¼šæŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼Œä½†åªç”¨äº†name
List<User> users = session.createQuery(
    "from User", User.class
).list();

for(User user : users) {
    System.out.println(user.getName()); // åªç”¨name
}
```

**âœ… ä¼˜åŒ–ååšæ³•**

```java
// æ­£ç¡®ï¼šåªæŸ¥éœ€è¦çš„å­—æ®µ
List<String> names = session.createQuery(
    "select u.name from User u", String.class
).list();

for(String name : names) {
    System.out.println(name);
}
```

**ğŸ“Š æ€§èƒ½å¯¹æ¯”**

| å¯¹æ¯”é¡¹ | æŸ¥å…¨éƒ¨å­—æ®µ | åªæŸ¥éœ€è¦å­—æ®µ | æ€§èƒ½æå‡ |
|-------|-----------|------------|---------|
| **æ•°æ®ä¼ è¾“é‡** | `100MB` | `10MB` | `â†“ 90%` |
| **å†…å­˜å ç”¨** | `é«˜` | `ä½` | `â†“ 80%` |
| **æŸ¥è¯¢é€Ÿåº¦** | `æ…¢` | `å¿«` | `â†‘ 3-5å€` |

> **ğŸ’¡ è®°ä½**ï¼šæ•°æ®åº“å°±åƒå¤–å–ï¼Œåªç‚¹éœ€è¦çš„èœï¼Œä¸è¦ä»€ä¹ˆéƒ½è¦ï¼

### 1.3 é¿å…N+1æŸ¥è¯¢é—®é¢˜


**ğŸ” ä»€ä¹ˆæ˜¯N+1é—®é¢˜**

```
ä¸¾ä¸ªç”Ÿæ´»ä¾‹å­ï¼š
ä½ è¦ä¹°10æœ¬ä¹¦ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š

æ–¹å¼1ï¼ˆN+1é—®é¢˜ï¼‰ï¼š
- å»ä¹¦åº—10æ¬¡ï¼Œæ¯æ¬¡ä¹°1æœ¬ â†’ è·‘äº†11è¶Ÿï¼ˆ1æ¬¡çœ‹ç›®å½• + 10æ¬¡ä¹°ä¹¦ï¼‰

æ–¹å¼2ï¼ˆä¼˜åŒ–æ–¹æ¡ˆï¼‰ï¼š
- å»ä¹¦åº—1æ¬¡ï¼Œä¸€å£æ°”ä¹°10æœ¬ â†’ åªè·‘1è¶Ÿ
```

**âŒ äº§ç”ŸN+1é—®é¢˜çš„ä»£ç **

```java
// æŸ¥è¯¢10ä¸ªéƒ¨é—¨ï¼ˆ1æ¬¡æŸ¥è¯¢ï¼‰
List<Department> depts = session.createQuery(
    "from Department", Department.class
).list();

// æ¯ä¸ªéƒ¨é—¨åˆæŸ¥å‘˜å·¥ï¼ˆ10æ¬¡æŸ¥è¯¢ï¼‰
for(Department dept : depts) {
    System.out.println(dept.getEmployees()); // åˆè§¦å‘æŸ¥è¯¢ï¼
}
// æ€»å…±ï¼š1 + 10 = 11æ¬¡æ•°æ®åº“æŸ¥è¯¢
```

**âœ… ä½¿ç”¨JOIN FETCHä¼˜åŒ–**

```java
// ä¸€æ¬¡æŸ¥è¯¢æå®šæ‰€æœ‰æ•°æ®
List<Department> depts = session.createQuery(
    "from Department d join fetch d.employees", 
    Department.class
).list();

for(Department dept : depts) {
    System.out.println(dept.getEmployees()); // ä¸å†æŸ¥è¯¢
}
// æ€»å…±ï¼šåªæœ‰1æ¬¡æ•°æ®åº“æŸ¥è¯¢
```

**æ€§èƒ½å·®å¼‚ç¤ºæ„å›¾**

```
N+1é—®é¢˜ï¼ˆ11æ¬¡æŸ¥è¯¢ï¼‰ï¼š
DB â†[æŸ¥éƒ¨é—¨]â†’ App
DB â†[æŸ¥å‘˜å·¥1]â†’ App
DB â†[æŸ¥å‘˜å·¥2]â†’ App
   ...ï¼ˆé‡å¤10æ¬¡ï¼‰
è€—æ—¶ï¼š~500ms

JOIN FETCHä¼˜åŒ–ï¼ˆ1æ¬¡æŸ¥è¯¢ï¼‰ï¼š
DB â†[æŸ¥æ‰€æœ‰æ•°æ®]â†’ App
è€—æ—¶ï¼š~50ms ï¼ˆå¿«10å€ï¼ï¼‰
```

### 1.4 åˆç†ä½¿ç”¨æ‰¹é‡æ“ä½œ


**ğŸ“¦ æ‰¹é‡æ’å…¥ä¼˜åŒ–**

```java
// âŒ é”™è¯¯ï¼šä¸€æ¡æ¡æ’å…¥
for(int i = 0; i < 1000; i++) {
    User user = new User("user" + i);
    session.save(user);
    // æ¯æ¬¡éƒ½è®¿é—®æ•°æ®åº“
}

// âœ… æ­£ç¡®ï¼šæ‰¹é‡æ’å…¥
for(int i = 0; i < 1000; i++) {
    User user = new User("user" + i);
    session.save(user);
    
    if(i % 50 == 0) { // æ¯50æ¡æäº¤ä¸€æ¬¡
        session.flush();
        session.clear();
    }
}
```

**é…ç½®æ‰¹é‡å¤§å°**

```properties
# hibernate.cfg.xml
hibernate.jdbc.batch_size=50
hibernate.order_inserts=true
hibernate.order_updates=true
```

---

## 2. ğŸ“‘ ç´¢å¼•ä½¿ç”¨åŸåˆ™


### 2.1 ç´¢å¼•æ˜¯ä»€ä¹ˆ


**ğŸ” ç”Ÿæ´»åŒ–ç†è§£**

```
ç´¢å¼• = ä¹¦çš„ç›®å½•

æ²¡æœ‰ç›®å½•çš„ä¹¦ï¼š
- æ‰¾"ç¬¬äº”ç« "è¦ä»å¤´ç¿»åˆ°å°¾ â†’ æ…¢

æœ‰ç›®å½•çš„ä¹¦ï¼š
- æŸ¥ç›®å½• â†’ ç›´æ¥ç¿»åˆ°ç¬¬85é¡µ â†’ å¿«
```

**æ•°æ®åº“ç´¢å¼•åŸç†**

```
æ²¡æœ‰ç´¢å¼•ï¼š
æ•°æ®åº“è¦æ‰«æå…¨è¡¨ â”Œâ”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”
               â”‚1â”‚2â”‚3â”‚4â”‚5â”‚6â”‚7â”‚8â”‚9â”‚10â”‚ â† æŒ¨ä¸ªæŸ¥æ‰¾
               â””â”€â”´â”€â”´â”€â”´â”€â”´â”€â”´â”€â”´â”€â”´â”€â”´â”€â”´â”€â”˜
               
æœ‰ç´¢å¼•ï¼š
å»ºç«‹ç›®å½•ç»“æ„     â”Œâ”€â”€ç´¢å¼•æ ‘â”€â”€â”
                â”‚    5    â”‚
              â”Œâ”€â”´â”€â”    â”Œâ”€â”´â”€â”
              â”‚ 2 â”‚    â”‚ 8 â”‚
              â””â”€â”€â”€â”˜    â””â”€â”€â”€â”˜
                â†“ å¿«é€Ÿå®šä½
```

### 2.2 å“ªäº›å­—æ®µéœ€è¦åŠ ç´¢å¼•


**âœ… åº”è¯¥åŠ ç´¢å¼•çš„å­—æ®µ**

| åœºæ™¯ | ç¤ºä¾‹ | åŸå›  |
|-----|------|------|
| **é¢‘ç¹æŸ¥è¯¢æ¡ä»¶** | `WHERE user_id = ?` | æé«˜æŸ¥æ‰¾é€Ÿåº¦ |
| **å¤–é”®å­—æ®µ** | `department_id` | å…³è”æŸ¥è¯¢å¸¸ç”¨ |
| **æ’åºå­—æ®µ** | `ORDER BY create_time` | é¿å…å…¨è¡¨æ’åº |
| **åˆ†ç»„å­—æ®µ** | `GROUP BY category` | æå‡åˆ†ç»„æ•ˆç‡ |

**âŒ ä¸é€‚åˆåŠ ç´¢å¼•çš„å­—æ®µ**

| åœºæ™¯ | ç¤ºä¾‹ | åŸå›  |
|-----|------|------|
| **å¾ˆå°‘æŸ¥è¯¢çš„å­—æ®µ** | `description` | æµªè´¹ç©ºé—´ |
| **å€¼é‡å¤åº¦é«˜** | `gender (ç”·/å¥³)` | ç´¢å¼•æ•ˆæœå·® |
| **é¢‘ç¹æ›´æ–°çš„å­—æ®µ** | `update_time` | ç»´æŠ¤ç´¢å¼•æˆæœ¬é«˜ |
| **æ•°æ®é‡å¾ˆå°çš„è¡¨** | `<1000æ¡` | å…¨è¡¨æ‰«ææ›´å¿« |

### 2.3 ç´¢å¼•ä½¿ç”¨æŠ€å·§


**ğŸ”¸ å¤åˆç´¢å¼•çš„æœ€å·¦åŒ¹é…åŸåˆ™**

```java
// åˆ›å»ºå¤åˆç´¢å¼•ï¼š(name, age, city)

// âœ… ä¼šç”¨åˆ°ç´¢å¼•
"select * from User where name = 'å¼ ä¸‰'" 
"select * from User where name = 'å¼ ä¸‰' and age = 20"
"select * from User where name = 'å¼ ä¸‰' and age = 20 and city = 'åŒ—äº¬'"

// âŒ ä¸ä¼šç”¨åˆ°ç´¢å¼•ï¼ˆè·³è¿‡äº†nameï¼‰
"select * from User where age = 20"
"select * from User where city = 'åŒ—äº¬'"
```

**è®°å¿†æŠ€å·§**

```
å¤åˆç´¢å¼• (name, age, city) å°±åƒç”µè¯æœ¬ï¼š

æŒ‰ã€å§“åâ†’å¹´é¾„â†’åŸå¸‚ã€‘æ’åº

æŸ¥è¯¢æ—¶ï¼š
âœ… èƒ½æŸ¥ï¼šå¼ ä¸‰
âœ… èƒ½æŸ¥ï¼šå¼ ä¸‰ï¼Œ20å²  
âœ… èƒ½æŸ¥ï¼šå¼ ä¸‰ï¼Œ20å²ï¼ŒåŒ—äº¬
âŒ ä¸èƒ½æŸ¥ï¼š20å²ï¼ˆå§“åæœªçŸ¥ï¼Œæ— æ³•å®šä½ï¼‰
```

**ğŸ”¸ é¿å…ç´¢å¼•å¤±æ•ˆ**

```java
// âŒ ä½¿ç”¨å‡½æ•°å¯¼è‡´ç´¢å¼•å¤±æ•ˆ
"where YEAR(create_time) = 2024"

// âœ… æ”¹å†™åä½¿ç”¨ç´¢å¼•
"where create_time >= '2024-01-01' and create_time < '2025-01-01'"

// âŒ ä½¿ç”¨LIKEå‰ç½®é€šé…ç¬¦
"where name like '%å¼ ä¸‰'"

// âœ… æ”¹ä¸ºåç½®é€šé…ç¬¦
"where name like 'å¼ ä¸‰%'"

// âŒ ä½¿ç”¨ORè¿æ¥ä¸åŒå­—æ®µ
"where name = 'å¼ ä¸‰' or age = 20"

// âœ… æ”¹ç”¨UNION
"where name = 'å¼ ä¸‰' UNION where age = 20"
```

---

## 3. ğŸ“Š æ‰§è¡Œè®¡åˆ’åˆ†æ


### 3.1 ä»€ä¹ˆæ˜¯æ‰§è¡Œè®¡åˆ’


**ğŸ’¡ é€šä¿—è§£é‡Š**

```
æ‰§è¡Œè®¡åˆ’ = æ•°æ®åº“æŸ¥æ•°æ®çš„"å¯¼èˆªè·¯çº¿å›¾"

å°±åƒå¼€è½¦å»ç›®çš„åœ°ï¼š
- æ–¹æ¡ˆAï¼šèµ°é«˜é€Ÿï¼Œ30åˆ†é’Ÿ
- æ–¹æ¡ˆBï¼šèµ°å›½é“ï¼Œ2å°æ—¶
- æ–¹æ¡ˆCï¼šèµ°å°è·¯ï¼Œ5å°æ—¶

æ•°æ®åº“ä¹Ÿä¼šé€‰æ‹©æœ€ä¼˜è·¯çº¿æŸ¥æ•°æ®
```

### 3.2 æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’


**MySQLä¸­æŸ¥çœ‹**

```sql
EXPLAIN SELECT * FROM user WHERE name = 'å¼ ä¸‰';
```

**æ‰§è¡Œè®¡åˆ’ç»“æœè§£è¯»**

```
+----+-------------+-------+------+---------------+------+
| id | select_type | table | type | key           | rows |
+----+-------------+-------+------+---------------+------+
| 1  | SIMPLE      | user  | ref  | idx_name      | 1    |
+----+-------------+-------+------+---------------+------+

æ ¸å¿ƒå­—æ®µè¯´æ˜ï¼š
```

| å­—æ®µ | å«ä¹‰ | å¥½ååˆ¤æ–­ |
|-----|------|---------|
| **type** | è®¿é—®ç±»å‹ | `const > eq_ref > ref > range > index > ALL` |
| **key** | ä½¿ç”¨çš„ç´¢å¼• | æœ‰å€¼=ä½¿ç”¨ç´¢å¼• âœ…ï¼ŒNULL=æœªä½¿ç”¨ âŒ |
| **rows** | æ‰«æè¡Œæ•° | è¶Šå°è¶Šå¥½ |
| **Extra** | é¢å¤–ä¿¡æ¯ | `Using index`å¥½ âœ…ï¼Œ`Using filesort`å·® âŒ |

**ğŸ¯ typeå­—æ®µè¯¦è§£**

```
æ€§èƒ½ä»å¥½åˆ°åï¼š

const     â†’ å¸¸é‡æŸ¥è¯¢ï¼ˆæœ€å¿«ï¼‰
            ç¤ºä¾‹ï¼šwhere id = 1

eq_ref    â†’ å”¯ä¸€ç´¢å¼•æŸ¥è¯¢
            ç¤ºä¾‹ï¼šè¿æ¥æŸ¥è¯¢çš„ä¸»é”®æˆ–å”¯ä¸€é”®

ref       â†’ éå”¯ä¸€ç´¢å¼•æŸ¥è¯¢
            ç¤ºä¾‹ï¼šwhere name = 'å¼ ä¸‰'ï¼ˆæ™®é€šç´¢å¼•ï¼‰

range     â†’ èŒƒå›´æŸ¥è¯¢
            ç¤ºä¾‹ï¼šwhere age > 18

index     â†’ ç´¢å¼•å…¨æ‰«æ
            ç¤ºä¾‹ï¼šselect id from userï¼ˆåªæŸ¥ç´¢å¼•åˆ—ï¼‰

ALL       â†’ å…¨è¡¨æ‰«æï¼ˆæœ€æ…¢ï¼‰âŒ
            ç¤ºä¾‹ï¼šæ²¡æœ‰whereæ¡ä»¶ï¼Œæˆ–æ¡ä»¶åˆ—æ— ç´¢å¼•
```

### 3.3 Hibernateä¸­å¯ç”¨SQLæ—¥å¿—


```properties
# æ˜¾ç¤ºç”Ÿæˆçš„SQL
hibernate.show_sql=true

# æ ¼å¼åŒ–SQLï¼ˆæ›´æ˜“è¯»ï¼‰
hibernate.format_sql=true

# æ˜¾ç¤ºSQLå‚æ•°ç»‘å®š
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
```

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹**

```sql
Hibernate: 
    select
        user0_.id as id1_0_,
        user0_.name as name2_0_ 
    from
        user user0_ 
    where
        user0_.name=?
        
binding parameter [1] as [VARCHAR] - [å¼ ä¸‰]
```

---

## 4. ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯ç»´æŠ¤


### 4.1 ä»€ä¹ˆæ˜¯ç»Ÿè®¡ä¿¡æ¯


**ğŸ” å½¢è±¡æ¯”å–»**

```
ç»Ÿè®¡ä¿¡æ¯ = æ•°æ®åº“çš„"äººå£æ™®æŸ¥æ•°æ®"

æ•°æ®åº“æ ¹æ®ç»Ÿè®¡ä¿¡æ¯å†³å®šæŸ¥è¯¢ç­–ç•¥ï¼š
- è¡¨æœ‰å¤šå°‘è¡Œï¼Ÿ
- æŸä¸ªå€¼å‡ºç°çš„é¢‘ç‡ï¼Ÿ
- æ•°æ®åˆ†å¸ƒæƒ…å†µï¼Ÿ

å°±åƒï¼š
- å°åŸå¸‚ â†’ éª‘è‡ªè¡Œè½¦å¤Ÿç”¨
- å¤§åŸå¸‚ â†’ å¿…é¡»ååœ°é“
```

### 4.2 ç»Ÿè®¡ä¿¡æ¯çš„ä½œç”¨


**æŸ¥è¯¢ä¼˜åŒ–å™¨ä¾èµ–ç»Ÿè®¡ä¿¡æ¯**

```
åœºæ™¯ï¼šæŸ¥è¯¢ age > 50 çš„ç”¨æˆ·

å¦‚æœç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºï¼š
- 90%ç”¨æˆ·å¹´é¾„>50 â†’ å…¨è¡¨æ‰«ææ›´å¿«
- åªæœ‰1%ç”¨æˆ·å¹´é¾„>50 â†’ ç”¨ç´¢å¼•æ›´å¿«

æ•°æ®åº“ä¼šè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆ
```

### 4.3 æ›´æ–°ç»Ÿè®¡ä¿¡æ¯


**MySQLä¸­æ›´æ–°**

```sql
-- åˆ†æå•ä¸ªè¡¨
ANALYZE TABLE user;

-- åˆ†æå¤šä¸ªè¡¨
ANALYZE TABLE user, department, employee;
```

**å®šæœŸç»´æŠ¤å»ºè®®**

| æ—¶æœº | æ“ä½œ | åŸå›  |
|-----|------|------|
| **å¤§é‡æ•°æ®å˜æ›´å** | ç«‹å³æ›´æ–°ç»Ÿè®¡ | ä¿è¯å‡†ç¡®æ€§ |
| **æ¯å¤©å‡Œæ™¨** | å®šæ—¶æ›´æ–° | æ•°æ®é‡å¤§æ—¶æ›´æ–° |
| **æŸ¥è¯¢å˜æ…¢æ—¶** | æ£€æŸ¥å¹¶æ›´æ–° | å¯èƒ½ç»Ÿè®¡è¿‡æœŸ |

---

## 5. ğŸ’¾ æŸ¥è¯¢ç¼“å­˜ä½¿ç”¨


### 5.1 Hibernateç¼“å­˜ä½“ç³»


**ğŸ—ï¸ ç¼“å­˜å±‚æ¬¡ç»“æ„**

```
åº”ç”¨å±‚
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ä¸€çº§ç¼“å­˜ï¼ˆSessionç¼“å­˜ï¼‰         â”‚  â† é»˜è®¤å¼€å¯
â”‚    ä½œç”¨èŒƒå›´ï¼šå•ä¸ªSession            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      äºŒçº§ç¼“å­˜ï¼ˆSessionFactoryç¼“å­˜ï¼‰  â”‚  â† éœ€è¦é…ç½®
â”‚    ä½œç”¨èŒƒå›´ï¼šæ•´ä¸ªåº”ç”¨               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æŸ¥è¯¢ç¼“å­˜                       â”‚  â† éœ€è¦å¯ç”¨
â”‚    ä½œç”¨èŒƒå›´ï¼šæŸ¥è¯¢ç»“æœé›†             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
æ•°æ®åº“
```

### 5.2 ä¸€çº§ç¼“å­˜ï¼ˆSessionç¼“å­˜ï¼‰


**ğŸ’¡ è‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ— éœ€é…ç½®**

```java
Session session = sessionFactory.openSession();

// ç¬¬ä¸€æ¬¡æŸ¥è¯¢ â†’ è®¿é—®æ•°æ®åº“
User user1 = session.get(User.class, 1L);

// ç¬¬äºŒæ¬¡æŸ¥è¯¢ â†’ ç›´æ¥ä»ç¼“å­˜å–ï¼Œä¸è®¿é—®æ•°æ®åº“
User user2 = session.get(User.class, 1L);

System.out.println(user1 == user2); // trueï¼Œæ˜¯åŒä¸€ä¸ªå¯¹è±¡
```

**ç¼“å­˜å¤±æ•ˆæƒ…å†µ**

```java
// 1. å…³é—­Sessionåç¼“å­˜å¤±æ•ˆ
session.close();

// 2. æ‰‹åŠ¨æ¸…ç©ºç¼“å­˜
session.clear();

// 3. æ‰‹åŠ¨åˆ·æ–°æŸä¸ªå¯¹è±¡
session.evict(user);
```

### 5.3 äºŒçº§ç¼“å­˜é…ç½®


**ğŸ”§ å¯ç”¨äºŒçº§ç¼“å­˜**

```xml
<!-- hibernate.cfg.xml -->
<property name="hibernate.cache.use_second_level_cache">true</property>
<property name="hibernate.cache.region.factory_class">
    org.hibernate.cache.ehcache.EhCacheRegionFactory
</property>
```

**åœ¨å®ä½“ä¸Šå¯ç”¨ç¼“å­˜**

```java
@Entity
@Cacheable
@org.hibernate.annotations.Cache(usage = CacheConcurrencyStrategy.READ_WRITE)
public class User {
    // ...
}
```

**ç¼“å­˜ç­–ç•¥é€‰æ‹©**

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | è¯´æ˜ |
|-----|---------|------|
| **READ_ONLY** | åªè¯»æ•°æ® | æ€§èƒ½æœ€å¥½ï¼Œå¦‚å­—å…¸è¡¨ |
| **READ_WRITE** | è¯»å¤šå†™å°‘ | å¸¸ç”¨ç­–ç•¥ï¼Œæ”¯æŒä¿®æ”¹ |
| **NONSTRICT_READ_WRITE** | å…è®¸å¶å°”è„è¯» | æ€§èƒ½å¥½ï¼Œä¸€è‡´æ€§ç¨å·® |
| **TRANSACTIONAL** | ä¸¥æ ¼ä¸€è‡´æ€§ | åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯ |

### 5.4 æŸ¥è¯¢ç¼“å­˜ä½¿ç”¨


**å¯ç”¨æŸ¥è¯¢ç¼“å­˜**

```java
Query<User> query = session.createQuery(
    "from User where age > :age", User.class
);
query.setParameter("age", 18);
query.setCacheable(true); // å¯ç”¨æŸ¥è¯¢ç¼“å­˜
query.setCacheRegion("userQueryCache"); // æŒ‡å®šç¼“å­˜åŒºåŸŸ

List<User> users = query.list();
```

> **âš ï¸ æ³¨æ„**ï¼šæŸ¥è¯¢ç¼“å­˜åªç¼“å­˜IDåˆ—è¡¨ï¼Œå®é™…å¯¹è±¡ä»äºŒçº§ç¼“å­˜è·å–

---

## 6. ğŸ“„ åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–


### 6.1 åˆ†é¡µæŸ¥è¯¢çš„é—®é¢˜


**ğŸŒ æ·±åº¦åˆ†é¡µé—®é¢˜**

```
ä¸¾ä¾‹è¯´æ˜ï¼š
æŸ¥è¯¢ç¬¬10000é¡µï¼Œæ¯é¡µ10æ¡

æ•°æ®åº“éœ€è¦ï¼š
1. å…ˆæŸ¥å‡º 10000 Ã— 10 = 100000 æ¡æ•°æ®
2. æ‰”æ‰å‰ 99990 æ¡
3. åªè¿”å›æœ€å 10 æ¡

è¿™å¤ªæµªè´¹äº†ï¼
```

### 6.2 ä¼ ç»Ÿåˆ†é¡µæ–¹å¼


```java
// âŒ ä¼ ç»Ÿæ–¹å¼ï¼ˆæ·±åº¦åˆ†é¡µæ…¢ï¼‰
Query<User> query = session.createQuery("from User order by id", User.class);
query.setFirstResult(10000 * 10); // è·³è¿‡10ä¸‡æ¡
query.setMaxResults(10);          // å–10æ¡
List<User> users = query.list();
```

### 6.3 æ¸¸æ ‡åˆ†é¡µä¼˜åŒ–


**âœ… ä½¿ç”¨IDæ¸¸æ ‡åˆ†é¡µ**

```java
// è®°å½•ä¸Šä¸€é¡µçš„æœ€åä¸€ä¸ªID
Long lastId = 99999L;

Query<User> query = session.createQuery(
    "from User where id > :lastId order by id", 
    User.class
);
query.setParameter("lastId", lastId);
query.setMaxResults(10);
List<User> users = query.list();
```

**æ€§èƒ½å¯¹æ¯”**

| æ–¹å¼ | ç¬¬1é¡µ | ç¬¬100é¡µ | ç¬¬10000é¡µ |
|-----|-------|---------|----------|
| **ä¼ ç»Ÿåˆ†é¡µ** | `10ms` | `50ms` | `5000ms` âŒ |
| **æ¸¸æ ‡åˆ†é¡µ** | `10ms` | `10ms` | `10ms` âœ… |

### 6.4 å»¶è¿Ÿå…³è”åˆ†é¡µ


```java
// âŒ ç›´æ¥åˆ†é¡µï¼ˆå¯èƒ½æŸ¥è¯¢å¤§é‡å…³è”æ•°æ®ï¼‰
Query<User> query = session.createQuery(
    "from User u join fetch u.department", 
    User.class
);
query.setMaxResults(10);

// âœ… å…ˆåˆ†é¡µæŸ¥IDï¼Œå†å…³è”
List<Long> ids = session.createQuery(
    "select u.id from User u order by u.id", 
    Long.class
).setMaxResults(10).list();

List<User> users = session.createQuery(
    "from User u join fetch u.department where u.id in :ids", 
    User.class
).setParameter("ids", ids).list();
```

---

## 7. ğŸ”— è¿æ¥æŸ¥è¯¢ä¼˜åŒ–


### 7.1 JOINçš„ç±»å‹é€‰æ‹©


**JOINç±»å‹å¯¹æ¯”**

```
åœºæ™¯ï¼šæŸ¥è¯¢ç”¨æˆ·åŠå…¶éƒ¨é—¨ä¿¡æ¯

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User  â”‚         â”‚Departmentâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id     â”‚â”€â”€â”€â”€â”    â”‚ id       â”‚
â”‚ name   â”‚    â””â”€â”€â”€â†’â”‚ name     â”‚
â”‚ dept_idâ”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸‰ç§JOINæ–¹å¼**

```java
// 1. INNER JOINï¼ˆåªè¿”å›åŒ¹é…çš„ï¼‰
"from User u inner join u.department d"
â†’ ç”¨æˆ·å¿…é¡»æœ‰éƒ¨é—¨

// 2. LEFT JOINï¼ˆè¿”å›æ‰€æœ‰ç”¨æˆ·ï¼‰
"from User u left join u.department d"  
â†’ ç”¨æˆ·å¯ä»¥æ²¡æœ‰éƒ¨é—¨

// 3. FETCH JOINï¼ˆç«‹å³åŠ è½½å…³è”ï¼‰
"from User u left join fetch u.department"
â†’ ä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰æ•°æ®
```

### 7.2 FETCH JOINä¼˜åŒ–


**é—®é¢˜ï¼šç¬›å¡å°”ç§¯**

```java
// âŒ å¤šä¸ªfetch joinå¯èƒ½äº§ç”Ÿç¬›å¡å°”ç§¯
"from User u " +
"left join fetch u.department " +
"left join fetch u.roles"

// å¦‚æœ1ä¸ªç”¨æˆ·æœ‰3ä¸ªè§’è‰²ï¼Œæ•°æ®ä¼šé‡å¤3æ¬¡ï¼
```

**âœ… è§£å†³æ–¹æ¡ˆ**

```java
// æ–¹æ¡ˆ1ï¼šåˆ†æ‰¹fetch
List<User> users = session.createQuery(
    "from User u left join fetch u.department",
    User.class
).list();

// å†è·å–è§’è‰²
session.createQuery(
    "from User u left join fetch u.roles where u in :users",
    User.class
).setParameter("users", users).list();

// æ–¹æ¡ˆ2ï¼šä½¿ç”¨@BatchSize
@Entity
public class User {
    @ManyToMany(fetch = FetchType.LAZY)
    @BatchSize(size = 10) // æ‰¹é‡åŠ è½½
    private Set<Role> roles;
}
```

### 7.3 å­æŸ¥è¯¢ä¼˜åŒ–


**âŒ ä½æ•ˆçš„å­æŸ¥è¯¢**

```java
"from User u where u.id in " +
"(select e.userId from Employee e where e.salary > 10000)"
```

**âœ… æ”¹ä¸ºJOIN**

```java
"from User u join Employee e on u.id = e.userId " +
"where e.salary > 10000"
```

**æ€§èƒ½æå‡åŸç†**

```
å­æŸ¥è¯¢ï¼š
1. å…ˆæ‰§è¡Œå­æŸ¥è¯¢ â†’ å¾—åˆ°IDåˆ—è¡¨
2. å†ç”¨IDåˆ—è¡¨æŸ¥User â†’ ä¸¤æ¬¡æ•°æ®åº“è®¿é—®

JOINï¼š
1. ä¸€æ¬¡æŸ¥è¯¢å®Œæˆ â†’ æ•°æ®åº“å†…éƒ¨ä¼˜åŒ–
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™


```
ğŸ¯ ä¼˜åŒ–ä¸‰åŸåˆ™ï¼š
1. åªæŸ¥éœ€è¦çš„å­—æ®µ â†’ å‡å°‘æ•°æ®ä¼ è¾“
2. å‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•° â†’ é¿å…N+1é—®é¢˜
3. åˆç†ä½¿ç”¨ç´¢å¼•å’Œç¼“å­˜ â†’ æå‡æŸ¥è¯¢é€Ÿåº¦
```

### 8.2 ä¼˜åŒ–æ£€æŸ¥æ¸…å•


**âœ… SQLå±‚é¢**
- [ ] é¿å…SELECT *ï¼ŒåªæŸ¥éœ€è¦çš„å­—æ®µ
- [ ] ä½¿ç”¨JOIN FETCHè§£å†³N+1é—®é¢˜
- [ ] æ‰¹é‡æ“ä½œé…ç½®batch_size
- [ ] é¿å…åœ¨å¾ªç¯ä¸­æ‰§è¡ŒæŸ¥è¯¢

**âœ… ç´¢å¼•å±‚é¢**
- [ ] é¢‘ç¹æŸ¥è¯¢çš„å­—æ®µå»ºç´¢å¼•
- [ ] æ³¨æ„å¤åˆç´¢å¼•çš„æœ€å·¦åŒ¹é…
- [ ] é¿å…ç´¢å¼•å¤±æ•ˆï¼ˆå‡½æ•°ã€LIKEå‰ç¼€ï¼‰
- [ ] å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯

**âœ… ç¼“å­˜å±‚é¢**
- [ ] ä¸€çº§ç¼“å­˜é»˜è®¤ç”Ÿæ•ˆ
- [ ] åªè¯»æ•°æ®å¯ç”¨äºŒçº§ç¼“å­˜
- [ ] æŸ¥è¯¢ç¼“å­˜é…åˆäºŒçº§ç¼“å­˜ä½¿ç”¨
- [ ] æ³¨æ„ç¼“å­˜å¤±æ•ˆç­–ç•¥

**âœ… åˆ†é¡µå±‚é¢**
- [ ] æ·±åº¦åˆ†é¡µç”¨æ¸¸æ ‡æ–¹å¼
- [ ] å»¶è¿ŸåŠ è½½å…³è”æ•°æ®
- [ ] é¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®

**âœ… è¿æ¥æŸ¥è¯¢**
- [ ] æ ¹æ®éœ€æ±‚é€‰æ‹©JOINç±»å‹
- [ ] é¿å…ç¬›å¡å°”ç§¯
- [ ] å­æŸ¥è¯¢æ”¹ä¸ºJOIN
- [ ] ä½¿ç”¨@BatchSizeæ‰¹é‡åŠ è½½

### 8.3 æ€§èƒ½é—®é¢˜æ’æŸ¥æµç¨‹


```
å‘ç°æŸ¥è¯¢æ…¢
    â†“
å¯ç”¨SQLæ—¥å¿—
    â†“
æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼ˆEXPLAINï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ˜¯å¦å…¨è¡¨æ‰«æï¼Ÿ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“YES           â†“NO
æ·»åŠ ç´¢å¼•       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ æ˜¯å¦N+1é—®é¢˜ï¼Ÿ    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“YES        â†“NO
              ä½¿ç”¨FETCH    æ£€æŸ¥æ˜¯å¦ç¼“å­˜å¤±æ•ˆ
                           æˆ–æ•°æ®é‡è¿‡å¤§
```

### 8.4 å®æˆ˜ç»éªŒæ€»ç»“


**ğŸ”¸ å¸¸è§æ€§èƒ½ç“¶é¢ˆ**

| é—®é¢˜ | è¡¨ç° | è§£å†³æ–¹æ¡ˆ |
|-----|------|---------|
| **N+1æŸ¥è¯¢** | å¾ªç¯å†…æœ‰SQL | ç”¨JOIN FETCH |
| **æ·±åº¦åˆ†é¡µ** | ç¿»åˆ°åé¢é¡µå¾ˆæ…¢ | æ”¹ç”¨æ¸¸æ ‡åˆ†é¡µ |
| **ç¼“å­˜ç©¿é€** | ç¼“å­˜æœªå‘½ä¸­ | å¯ç”¨äºŒçº§ç¼“å­˜ |
| **ç¬›å¡å°”ç§¯** | æ•°æ®é‡å¤ | åˆ†æ‰¹FETCH |

**ğŸ”¸ ä¼˜åŒ–æ•ˆæœè¯„ä¼°**

```
ä¼˜åŒ–å‰åå¯¹æ¯”ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ“ä½œ       â”‚ ä¼˜åŒ–å‰ â”‚ ä¼˜åŒ–å â”‚ æå‡   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆ—è¡¨æŸ¥è¯¢     â”‚ 500ms  â”‚  50ms  â”‚ 10å€   â”‚
â”‚ å…³è”æŸ¥è¯¢     â”‚  2s    â”‚ 200ms  â”‚ 10å€   â”‚
â”‚ åˆ†é¡µæŸ¥è¯¢     â”‚  5s    â”‚  10ms  â”‚ 500å€  â”‚
â”‚ æ‰¹é‡æ’å…¥     â”‚ 30s    â”‚  3s    â”‚ 10å€   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æŸ¥è¯¢ä¼˜åŒ–è®°ä¸‰ç‚¹ï¼Œå­—æ®µç´¢å¼•ç¼“å­˜è¿
N+1é—®é¢˜ç”¨FETCHï¼Œæ·±åº¦åˆ†é¡µæ¸¸æ ‡è½¬
æ‰§è¡Œè®¡åˆ’å¸¸åˆ†æï¼Œç»Ÿè®¡ä¿¡æ¯è¦æ›´æ–°
æ‰¹é‡æ“ä½œé…å¤§å°ï¼Œæ€§èƒ½æå‡çœ‹å¾—è§
```