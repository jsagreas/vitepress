---
title: 70ã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ
---
## ğŸ“š ç›®å½•

1. [æ‡’åŠ è½½å¼‚å¸¸é—®é¢˜](#1-æ‡’åŠ è½½å¼‚å¸¸é—®é¢˜)
2. [å¯¹è±¡çŠ¶æ€å¼‚å¸¸](#2-å¯¹è±¡çŠ¶æ€å¼‚å¸¸)
3. [æŸ¥è¯¢ä¸æ˜ å°„å¼‚å¸¸](#3-æŸ¥è¯¢ä¸æ˜ å°„å¼‚å¸¸)
4. [æ€§èƒ½ä¸èµ„æºé—®é¢˜](#4-æ€§èƒ½ä¸èµ„æºé—®é¢˜)
5. [äº‹åŠ¡ç®¡ç†é—®é¢˜](#5-äº‹åŠ¡ç®¡ç†é—®é¢˜)
6. [è°ƒè¯•æŠ€å·§ä¸å·¥å…·](#6-è°ƒè¯•æŠ€å·§ä¸å·¥å…·)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ æ‡’åŠ è½½å¼‚å¸¸é—®é¢˜


### 1.1 LazyInitializationException æ˜¯ä»€ä¹ˆ


**ğŸ”¸ é€šä¿—ç†è§£**
```
æƒ³è±¡ä½ å»å›¾ä¹¦é¦†å€Ÿä¹¦ï¼š
- æ‡’åŠ è½½ï¼šå›¾ä¹¦ç®¡ç†å‘˜åªç»™ä½ ä¹¦åå¡ç‰‡ï¼Œè¦çœ‹å†…å®¹æ—¶æ‰å»å–ä¹¦
- é—®é¢˜ï¼šä½ æ‹¿ç€å¡ç‰‡å›å®¶äº†ï¼Œå›¾ä¹¦é¦†å…³é—¨äº†(Sessionå…³é—­)
- ç»“æœï¼šä½ æƒ³çœ‹ä¹¦å†…å®¹æ—¶ï¼Œæ²¡æ³•å»å–äº† â†’ LazyInitializationException

Hibernateä¸­ï¼š
Sessionå…³é—­å â†’ è®¿é—®æ‡’åŠ è½½æ•°æ® â†’ æŠ¥é”™ï¼
```

**ğŸ’¡ é”™è¯¯ç°è±¡**
```
é”™è¯¯ä¿¡æ¯ï¼š
org.hibernate.LazyInitializationException: 
could not initialize proxy - no Session

ä»€ä¹ˆæ—¶å€™å‡ºç°ï¼š
âœ— Sessionå…³é—­åè®¿é—®å…³è”å¯¹è±¡
âœ— äº‹åŠ¡ç»“æŸåè®¿é—®é›†åˆå±æ€§
âœ— åœ¨Controllerå±‚è®¿é—®Entityçš„æ‡’åŠ è½½å­—æ®µ
```

### 1.2 ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜


**ğŸ” æ ¹æœ¬åŸå› **
```java
// é—®é¢˜åœºæ™¯ç¤ºä¾‹
public User findUser(Long id) {
    Session session = factory.openSession();
    User user = session.get(User.class, id);
    session.close();  // â† Sessionå…³é—­äº†
    return user;
}

// ä½¿ç”¨æ—¶
User user = findUser(1L);
user.getOrders().size();  // â† è®¿é—®æ‡’åŠ è½½é›†åˆ â†’ æŠ¥é”™ï¼
```

**åŸç†å›¾è§£**
```
æ­£å¸¸æµç¨‹ï¼š
Sessionæ‰“å¼€ â†’ åŠ è½½User â†’ è®¿é—®Orders â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ æˆåŠŸ

é”™è¯¯æµç¨‹ï¼š
Sessionæ‰“å¼€ â†’ åŠ è½½User â†’ Sessionå…³é—­ â†’ è®¿é—®Orders â†’ æ— æ³•æŸ¥è¯¢ â†’ å¼‚å¸¸ï¼

æ•°æ®çŠ¶æ€ï¼š
Userå¯¹è±¡      Ordersé›†åˆ
[å·²åŠ è½½]  â†’  [ä»£ç†å¯¹è±¡ï¼ŒæœªåŠ è½½]
            â†“
        è®¿é—®æ—¶éœ€è¦Session
            â†“
        Sessionå·²å…³é—­ â†’ å¼‚å¸¸
```

### 1.3 è§£å†³æ–¹æ¡ˆå¯¹æ¯”


| æ–¹æ¡ˆ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|------|---------|---------|-------------|
| **ç«‹å³åŠ è½½** | `ç®€å•ç›´æ¥` | `å¯èƒ½åŠ è½½æ— ç”¨æ•°æ®` | `ç¡®å®šä¼šç”¨åˆ°çš„å…³è”` |
| **JOIN FETCH** | `ä¸€æ¬¡æŸ¥è¯¢è·å–` | `éœ€è¦æ”¹HQLè¯­å¥` | `ç‰¹å®šæŸ¥è¯¢éœ€æ±‚` |
| **ä¿æŒSession** | `å»¶é•¿ç”Ÿå‘½å‘¨æœŸ` | `èµ„æºå ç”¨é•¿` | `Webåº”ç”¨(OSIV)` |
| **DTOæŠ•å½±** | `åªæŸ¥éœ€è¦çš„å­—æ®µ` | `éœ€è¦é¢å¤–ç±»` | `æ€§èƒ½æ•æ„Ÿåœºæ™¯` |

**âœ… å®ç”¨è§£å†³æ–¹æ³•**

**æ–¹æ³•ä¸€ï¼šä½¿ç”¨ JOIN FETCHï¼ˆæ¨èï¼‰**
```java
// HQLä¸­ä½¿ç”¨JOIN FETCH
public User findUserWithOrders(Long id) {
    Session session = factory.openSession();
    String hql = "FROM User u JOIN FETCH u.orders WHERE u.id = :id";
    User user = session.createQuery(hql, User.class)
                       .setParameter("id", id)
                       .uniqueResult();
    session.close();  // ç°åœ¨å¯ä»¥å®‰å…¨å…³é—­äº†
    return user;
}

// ğŸ’¡ JOIN FETCHçš„ä½œç”¨ï¼šä¸€æ¬¡æ€§æŠŠUserå’ŒOrderséƒ½æŸ¥å‡ºæ¥
```

**æ–¹æ³•äºŒï¼šæ”¹ä¸ºç«‹å³åŠ è½½**
```java
// å®ä½“ç±»é…ç½®
@OneToMany(fetch = FetchType.EAGER)  // æ”¹ä¸ºç«‹å³åŠ è½½
private Set<Order> orders;

// âš ï¸ æ³¨æ„ï¼šä¼šå½±å“æ‰€æœ‰æŸ¥è¯¢ï¼Œæ…ç”¨ï¼
```

**æ–¹æ³•ä¸‰ï¼šåœ¨Sessionå†…å®Œæˆæ“ä½œ**
```java
// åœ¨Sessionå…³é—­å‰åˆå§‹åŒ–æ•°æ®
public User findUser(Long id) {
    Session session = factory.openSession();
    User user = session.get(User.class, id);
    
    // å¼ºåˆ¶åˆå§‹åŒ–
    Hibernate.initialize(user.getOrders());
    
    session.close();
    return user;  // ç°åœ¨orderså·²ç»åŠ è½½äº†
}
```

**ğŸ¯ é€‰æ‹©å»ºè®®**
- **å›ºå®šéœ€è¦å…³è”æ•°æ®** â†’ ç”¨ `JOIN FETCH`
- **å¶å°”éœ€è¦å…³è”æ•°æ®** â†’ ç”¨ `Hibernate.initialize()`
- **Webåº”ç”¨** â†’ è€ƒè™‘ `Open Session In View` æ¨¡å¼
- **æ€§èƒ½ä¼˜å…ˆ** â†’ ç”¨ `DTOæŠ•å½±`ï¼ŒåªæŸ¥éœ€è¦çš„å­—æ®µ

---

## 2. âš ï¸ å¯¹è±¡çŠ¶æ€å¼‚å¸¸


### 2.1 NonUniqueObjectException è¯¦è§£


**ğŸ”¸ é—®é¢˜æœ¬è´¨**
```
Sessionçš„èº«ä»½æ ‡è¯†è§„åˆ™ï¼š
åŒä¸€ä¸ªSessionä¸­ï¼Œç›¸åŒIDçš„å¯¹è±¡åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹

è¿åè§„åˆ™ â†’ NonUniqueObjectException

å°±åƒï¼š
æ•™å®¤é‡Œ(Session)ä¸èƒ½æœ‰ä¸¤ä¸ªå­¦å·ç›¸åŒçš„å­¦ç”Ÿ(åŒIDå¯¹è±¡)
```

**ğŸ’¥ å…¸å‹é”™è¯¯åœºæ™¯**
```java
// åœºæ™¯1ï¼šé‡å¤æ·»åŠ ç›¸åŒIDå¯¹è±¡
Session session = factory.openSession();
User user1 = new User();
user1.setId(1L);
session.save(user1);

User user2 = new User();
user2.setId(1L);  // ç›¸åŒID
session.save(user2);  // â† æŠ¥é”™ï¼
```

**ğŸ” é”™è¯¯ä¿¡æ¯è§£è¯»**
```
org.hibernate.NonUniqueObjectException: 
A different object with the same identifier value was already 
associated with the session: [User#1]

ç¿»è¯‘ï¼š
Sessionä¸­å·²ç»æœ‰IDä¸º1çš„Userå¯¹è±¡äº†ï¼Œ
ä½ åˆæƒ³æ·»åŠ å¦ä¸€ä¸ªIDä¸º1çš„User â†’ ä¸å…è®¸ï¼
```

### 2.2 é—®é¢˜æ ¹æºåˆ†æ


**åŸå› å¯¹æ¯”è¡¨**

| åœºæ™¯ | **é—®é¢˜åŸå› ** | **è§£å†³æ–¹æ³•** |
|------|-------------|-------------|
| **é‡å¤åŠ è½½** | `å¤šæ¬¡get()/load()åŒä¸€ID` | `Sessionç¼“å­˜ä¼šè¿”å›åŒä¸€å¯¹è±¡` |
| **æ‰‹åŠ¨è®¾ç½®ID** | `newå¯¹è±¡åè®¾ç½®å·²å­˜åœ¨çš„ID` | `ç”¨merge()ä»£æ›¿save()` |
| **æ‰¹é‡å¯¼å…¥** | `æ²¡æ¸…ç†Sessionç¼“å­˜` | `å®šæœŸflush()å’Œclear()` |
| **å…³è”å¯¹è±¡** | `çº§è”ä¿å­˜æ—¶IDå†²çª` | `æ£€æŸ¥å…³è”å¯¹è±¡çŠ¶æ€` |

**âœ… è§£å†³æ–¹æ¡ˆ**

**æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ merge() ä»£æ›¿ save()**
```java
// âŒ é”™è¯¯åšæ³•
User user = new User();
user.setId(1L);
session.save(user);  // å¯èƒ½æŠ¥é”™

// âœ… æ­£ç¡®åšæ³•
User user = new User();
user.setId(1L);
session.merge(user);  // mergeä¼šæ™ºèƒ½å¤„ç†
```

**merge() çš„å·¥ä½œåŸç†**
```
merge()çš„æ™ºèƒ½é€»è¾‘ï¼š
1. æ£€æŸ¥Sessionä¸­æ˜¯å¦å·²æœ‰è¯¥IDå¯¹è±¡
   â”œâ”€ æœ‰ï¼šæ›´æ–°å·²æœ‰å¯¹è±¡
   â””â”€ æ²¡æœ‰ï¼šæ£€æŸ¥æ•°æ®åº“
       â”œâ”€ æœ‰ï¼šåŠ è½½å¹¶æ›´æ–°
       â””â”€ æ²¡æœ‰ï¼šæ’å…¥æ–°è®°å½•

ä¸ä¼šå†²çªï¼
```

**æ–¹æ¡ˆäºŒï¼šæ‰¹é‡æ“ä½œæ—¶æ¸…ç†ç¼“å­˜**
```java
// æ‰¹é‡å¯¼å…¥æ•°æ®
for (int i = 0; i < 10000; i++) {
    User user = new User();
    user.setName("User" + i);
    session.save(user);
    
    // æ¯100æ¡æ¸…ç†ä¸€æ¬¡ç¼“å­˜
    if (i % 100 == 0) {
        session.flush();   // åŒæ­¥åˆ°æ•°æ®åº“
        session.clear();   // æ¸…ç©ºSessionç¼“å­˜
    }
}
```

### 2.3 StaleObjectStateException ä¹è§‚é”å†²çª


**ğŸ”¸ ä»€ä¹ˆæ˜¯ä¹è§‚é”å†²çª**
```
åœºæ™¯ï¼šä¸¤ä¸ªäººåŒæ—¶ç¼–è¾‘åŒä¸€æ¡æ•°æ®

ç”¨æˆ·A                      ç”¨æˆ·B
è¯»å–æ•°æ®(version=1)        è¯»å–æ•°æ®(version=1)
  â†“                         â†“
ä¿®æ”¹æ•°æ®                   ä¿®æ”¹æ•°æ®
  â†“                         â†“
ä¿å­˜(version=2) âœ“          ä¿å­˜(version=2) âœ—
                          æ£€æµ‹åˆ°versionä¸åŒ¹é…
                          â†’ StaleObjectStateException
```

**ğŸ’¡ å®ä½“é…ç½®**
```java
@Entity
public class Product {
    @Id
    private Long id;
    
    private String name;
    private Double price;
    
    @Version  // ç‰ˆæœ¬å·å­—æ®µ
    private Integer version;
}
```

**ğŸ” å†²çªè¿‡ç¨‹è¯¦è§£**
```
æ•°æ®åº“çŠ¶æ€ï¼šProduct(id=1, name="å•†å“A", price=100, version=1)

äº‹åŠ¡A                          äº‹åŠ¡B
è¯»å–ï¼šversion=1                è¯»å–ï¼šversion=1
ä¿®æ”¹ï¼šprice=90                 ä¿®æ”¹ï¼šprice=95
æäº¤ï¼šversionâ†’2 æˆåŠŸ           æäº¤ï¼šæ£€æµ‹version=1 â‰  2
                              â†’ æŠ›å‡ºå¼‚å¸¸ï¼

åŸç†ï¼š
UPDATE product 
SET price=95, version=2 
WHERE id=1 AND version=1  â† æ¡ä»¶ä¸æ»¡è¶³ï¼Œæ›´æ–°å¤±è´¥
```

**âœ… å¤„ç†ç­–ç•¥**

**ç­–ç•¥å¯¹æ¯”**

| ç­–ç•¥ | **å®ç°æ–¹å¼** | **é€‚ç”¨åœºæ™¯** |
|------|------------|-------------|
| **é‡è¯•æœºåˆ¶** | `æ•è·å¼‚å¸¸ï¼Œé‡æ–°è¯»å–å¹¶æ›´æ–°` | `å†²çªæ¦‚ç‡ä½` |
| **æç¤ºç”¨æˆ·** | `å‘ŠçŸ¥æ•°æ®å·²å˜æ›´ï¼Œè®©ç”¨æˆ·å†³å®š` | `éœ€è¦äººå·¥åˆ¤æ–­` |
| **åˆå¹¶æ›´æ–°** | `æ™ºèƒ½åˆå¹¶åŒæ–¹ä¿®æ”¹` | `å­—æ®µç‹¬ç«‹ï¼Œå¯åˆ†åˆ«æ›´æ–°` |
| **æœ€åå†™å…¥ä¼˜å…ˆ** | `ä¸ç”¨ç‰ˆæœ¬å·ï¼Œç›´æ¥è¦†ç›–` | `ä¸åœ¨æ„å†²çª` |

**å®ç°é‡è¯•æœºåˆ¶**
```java
public void updateProduct(Long id, Double newPrice) {
    int maxRetries = 3;
    int attempt = 0;
    
    while (attempt < maxRetries) {
        try {
            Session session = factory.openSession();
            Transaction tx = session.beginTransaction();
            
            Product product = session.get(Product.class, id);
            product.setPrice(newPrice);
            
            tx.commit();
            session.close();
            return;  // æˆåŠŸï¼Œé€€å‡º
            
        } catch (StaleObjectStateException e) {
            attempt++;
            if (attempt >= maxRetries) {
                throw new RuntimeException("æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
            }
            // ç­‰å¾…éšæœºæ—¶é—´åé‡è¯•
            Thread.sleep(100 * attempt);
        }
    }
}
```

### 2.4 TransientObjectException ç¬æ—¶å¯¹è±¡å¼‚å¸¸


**ğŸ”¸ å¯¹è±¡çŠ¶æ€ç†è§£**
```
Hibernateå¯¹è±¡çš„ä¸‰ç§çŠ¶æ€ï¼š

ç¬æ—¶(Transient)      æŒä¹…(Persistent)      æ¸¸ç¦»(Detached)
[newå‡ºæ¥çš„]   â†’    [Sessionç®¡ç†ä¸­]   â†’   [Sessionå…³é—­å]
  â†“                      â†“                     â†“
æœªå…³è”Session          å·²å…³è”Session          æ›¾å…³è”Session
æ— IDæˆ–IDæœªä¿å­˜         æœ‰IDä¸”åœ¨Sessionä¸­       æœ‰IDä½†Sessionå·²å…³é—­

çŠ¶æ€è½¬æ¢ï¼š
newå¯¹è±¡ --save()--> æŒä¹…æ€ --session.close()--> æ¸¸ç¦»æ€
                      â†‘
               --merge()--
```

**ğŸ’¥ ä½•æ—¶å‡ºç°å¼‚å¸¸**
```java
// é”™è¯¯åœºæ™¯ï¼šå…³è”ç¬æ—¶å¯¹è±¡
User user = session.get(User.class, 1L);  // æŒä¹…æ€

Order order = new Order();  // ç¬æ—¶æ€ï¼Œæ— ID
user.getOrders().add(order);  

session.flush();  // â† å¼‚å¸¸ï¼šorderæ˜¯ç¬æ—¶æ€ï¼Œä¸èƒ½ç›´æ¥å…³è”
```

**âœ… æ­£ç¡®å¤„ç†æ–¹å¼**

**æ–¹å¼ä¸€ï¼šä½¿ç”¨çº§è”ä¿å­˜**
```java
// å®ä½“é…ç½®
@OneToMany(cascade = CascadeType.ALL)
private Set<Order> orders;

// ä½¿ç”¨
User user = session.get(User.class, 1L);
Order order = new Order();  // ç¬æ—¶æ€
user.getOrders().add(order);
session.flush();  // çº§è”ä¿å­˜order â†’ è‡ªåŠ¨å˜ä¸ºæŒä¹…æ€
```

**æ–¹å¼äºŒï¼šå…ˆä¿å­˜å…³è”å¯¹è±¡**
```java
User user = session.get(User.class, 1L);

Order order = new Order();
session.save(order);  // å…ˆä¿å­˜ï¼Œå˜ä¸ºæŒä¹…æ€

user.getOrders().add(order);  // ç°åœ¨å¯ä»¥å…³è”äº†
```

**çŠ¶æ€åˆ¤æ–­å·¥å…·**
```java
// åˆ¤æ–­å¯¹è±¡çŠ¶æ€
SessionFactory factory = ...;
Object obj = ...;

if (factory.getCurrentSession().contains(obj)) {
    // æŒä¹…æ€
} else if (obj != null && getId(obj) != null) {
    // æ¸¸ç¦»æ€
} else {
    // ç¬æ—¶æ€
}
```

---

## 3. ğŸ” æŸ¥è¯¢ä¸æ˜ å°„å¼‚å¸¸


### 3.1 QuerySyntaxException HQLè¯­æ³•é”™è¯¯


**ğŸ”¸ å¸¸è§è¯­æ³•é”™è¯¯ç±»å‹**

**é”™è¯¯1ï¼šå®ä½“ç±»åæ‹¼å†™é”™è¯¯**
```java
// âŒ é”™è¯¯ï¼šè¡¨åè€Œéç±»å
String hql = "FROM user";  // useræ˜¯è¡¨å
Query query = session.createQuery(hql);  // â† QuerySyntaxException

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å®ä½“ç±»å
String hql = "FROM User";  // Useræ˜¯ç±»å
Query query = session.createQuery(hql);
```

**é”™è¯¯2ï¼šå±æ€§åæ‹¼å†™é”™è¯¯**
```java
// âŒ é”™è¯¯ï¼šå±æ€§åå†™é”™
String hql = "FROM User WHERE userName = :name";  // å±æ€§æ˜¯username

// âœ… æ­£ç¡®ï¼šç²¾ç¡®åŒ¹é…å±æ€§å
String hql = "FROM User WHERE username = :name";
```

**é”™è¯¯3ï¼šåˆ«åä½¿ç”¨é”™è¯¯**
```java
// âŒ é”™è¯¯ï¼šSELECTåæ²¡ç”¨åˆ«å
String hql = "SELECT name FROM User u";  // nameæœªé™å®š

// âœ… æ­£ç¡®ï¼šä½¿ç”¨åˆ«å
String hql = "SELECT u.name FROM User u";
```

**ğŸ” é”™è¯¯å®šä½æŠ€å·§**
```
é”™è¯¯ä¿¡æ¯ç¤ºä¾‹ï¼š
org.hibernate.hql.internal.ast.QuerySyntaxException: 
User is not mapped [FROM User]
                    ^^^^^^^^
                    è¿™é‡ŒæŒ‡å‡ºé”™è¯¯ä½ç½®

å®šä½æ­¥éª¤ï¼š
1. çœ‹å¼‚å¸¸æ¶ˆæ¯ä¸­çš„[æ–¹æ‹¬å·] â†’ é”™è¯¯çš„HQLç‰‡æ®µ
2. æ£€æŸ¥å®ä½“ç±»åæ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥å±æ€§åæ˜¯å¦æ‹¼å†™æ­£ç¡®
4. æ£€æŸ¥æ˜¯å¦é—æ¼åˆ«å
```

**âœ… é¿å…è¯­æ³•é”™è¯¯çš„æ–¹æ³•**

| æ–¹æ³• | **è¯´æ˜** | **ç¤ºä¾‹** |
|------|---------|---------|
| **IDEæç¤º** | `ç”¨IDEçš„HQLè¯­æ³•æ£€æŸ¥` | `IntelliJ IDEAæä¾›è¯­æ³•é«˜äº®` |
| **å­—ç¬¦ä¸²å¸¸é‡** | `å°†HQLå®šä¹‰ä¸ºå¸¸é‡` | `private static final String HQL_FIND_USER = "..."` |
| **Criteria API** | `ç”¨ç±»å‹å®‰å…¨çš„APIä»£æ›¿HQL` | `session.createCriteria(User.class)` |
| **å•å…ƒæµ‹è¯•** | `æµ‹è¯•æ‰€æœ‰HQLè¯­å¥` | `æ¯ä¸ªHQLå†™å¯¹åº”æµ‹è¯•` |

### 3.2 MappingException æ˜ å°„é…ç½®é”™è¯¯


**ğŸ”¸ å¸¸è§æ˜ å°„é”™è¯¯**

**é”™è¯¯1ï¼šç¼ºå°‘ä¸»é”®æ˜ å°„**
```java
// âŒ é”™è¯¯ï¼šå®ä½“ç±»æ²¡æœ‰@Id
@Entity
public class Product {
    private Long id;  // æ²¡æœ‰@Idæ³¨è§£
    private String name;
}

// é”™è¯¯ä¿¡æ¯ï¼š
// org.hibernate.MappingException: 
// No identifier specified for entity: Product

// âœ… æ­£ç¡®ï¼šå¿…é¡»æœ‰@Id
@Entity
public class Product {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
}
```

**é”™è¯¯2ï¼šå…³è”æ˜ å°„ä¸åŒ¹é…**
```java
// âŒ é”™è¯¯ï¼šåŒå‘å…³è”é…ç½®ä¸ä¸€è‡´
@Entity
public class User {
    @OneToMany
    private Set<Order> orders;
}

@Entity
public class Order {
    @ManyToOne
    @JoinColumn(name = "customer_id")  // å­—æ®µåä¸åŒ¹é…
    private User user;
}

// âœ… æ­£ç¡®ï¼šmappedByæŒ‡å®šå…³ç³»ç»´æŠ¤æ–¹
@Entity
public class User {
    @OneToMany(mappedBy = "user")  // æŒ‡å‘Order.userå±æ€§
    private Set<Order> orders;
}

@Entity
public class Order {
    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;
}
```

**é”™è¯¯3ï¼šæ•°æ®ç±»å‹ä¸åŒ¹é…**
```java
// âŒ é”™è¯¯ï¼šJavaç±»å‹ä¸æ•°æ®åº“ç±»å‹ä¸åŒ¹é…
@Entity
public class Product {
    @Id
    private Long id;
    
    @Column(columnDefinition = "VARCHAR(50)")
    private Integer code;  // Integeræ˜ å°„åˆ°VARCHAR â†’ é”™è¯¯
}

// âœ… æ­£ç¡®ï¼šç±»å‹åŒ¹é…
@Entity
public class Product {
    @Id
    private Long id;
    
    @Column(length = 50)
    private String code;  // Stringæ˜ å°„åˆ°VARCHAR
}
```

**ğŸ”§ æ˜ å°„æ£€æŸ¥æ¸…å•**

```
å¿…é¡»æ£€æŸ¥é¡¹ï¼š
â–¡ æ¯ä¸ªå®ä½“éƒ½æœ‰@Idä¸»é”®
â–¡ å…³è”å…³ç³»çš„mappedByæ­£ç¡®
â–¡ @JoinColumnçš„nameä¸æ•°æ®åº“ä¸€è‡´
â–¡ æ•°æ®ç±»å‹Javaä¸DBåŒ¹é…
â–¡ @Tableçš„nameä¸å®é™…è¡¨åä¸€è‡´
â–¡ å­—æ®µé•¿åº¦çº¦æŸåˆç†

å¸¸ç”¨éªŒè¯æ–¹å¼ï¼š
1. å¯åŠ¨æ—¶æ£€æŸ¥ï¼šhibernate.hbm2ddl.auto=validate
2. æ—¥å¿—è¾“å‡ºï¼šhibernate.show_sql=true
3. å•å…ƒæµ‹è¯•ï¼šæµ‹è¯•æ‰€æœ‰å®ä½“çš„CRUD
```

### 3.3 PropertyAccessException å±æ€§è®¿é—®é”™è¯¯


**ğŸ”¸ é—®é¢˜åŸå› **
```
Hibernateè®¿é—®å±æ€§çš„ä¸¤ç§æ–¹å¼ï¼š
1. å­—æ®µè®¿é—®(Field Access)ï¼šç›´æ¥è®¿é—®å­—æ®µ
2. å±æ€§è®¿é—®(Property Access)ï¼šé€šè¿‡getter/setter

ä¸åŒ¹é… â†’ PropertyAccessException
```

**ğŸ’¥ å…¸å‹é”™è¯¯**
```java
// åœºæ™¯1ï¼šç¼ºå°‘getter/setter
@Entity
@Access(AccessType.PROPERTY)  // æŒ‡å®šç”¨å±æ€§è®¿é—®
public class User {
    private Long id;
    private String name;
    
    @Id
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    
    // âŒ ç¼ºå°‘nameçš„getter/setter
}

// åœºæ™¯2ï¼šgetter/setterå‘½åä¸è§„èŒƒ
@Entity
public class Product {
    private Boolean isActive;
    
    // âŒ é”™è¯¯ï¼šåº”è¯¥æ˜¯getIsActiveæˆ–isActive
    public Boolean getactive() { return isActive; }
}

// âœ… æ­£ç¡®çš„å‘½å
public Boolean getIsActive() { return isActive; }
// æˆ–
public Boolean isActive() { return isActive; }
```

**âœ… è§£å†³æ–¹æ³•**

**æ–¹æ³•ä¸€ï¼šç»Ÿä¸€ä½¿ç”¨å­—æ®µè®¿é—®**
```java
@Entity
@Access(AccessType.FIELD)  // æ˜ç¡®æŒ‡å®šå­—æ®µè®¿é—®
public class User {
    @Id
    private Long id;
    private String name;
    
    // å¯ä»¥ä¸éœ€è¦getter/setter
    // Hibernateç›´æ¥è®¿é—®å­—æ®µ
}
```

**æ–¹æ³•äºŒï¼šå®Œå–„getter/setter**
```java
@Entity
public class User {
    private Long id;
    private String name;
    
    @Id
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
}
```

**è®¿é—®æ¨¡å¼å¯¹æ¯”**

| è®¿é—®æ–¹å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| **å­—æ®µè®¿é—®** | `ä¸éœ€è¦getter/setter` | `æ— æ³•æ·»åŠ ä¸šåŠ¡é€»è¾‘` | `ç®€å•å®ä½“ç±»` |
| **å±æ€§è®¿é—®** | `å¯åœ¨getter/setteråŠ é€»è¾‘` | `å¿…é¡»æœ‰getter/setter` | `éœ€è¦éªŒè¯/è½¬æ¢` |

---

## 4. ğŸš€ æ€§èƒ½ä¸èµ„æºé—®é¢˜


### 4.1 å†…å­˜æ³„æ¼é—®é¢˜å®šä½ä¸è§£å†³


**ğŸ”¸ Sessionæœªå…³é—­å¯¼è‡´çš„å†…å­˜æ³„æ¼**

**é—®é¢˜ç°è±¡**
```
åº”ç”¨è¿è¡Œä¸€æ®µæ—¶é—´åï¼š
- å†…å­˜æŒç»­å¢é•¿
- GCé¢‘ç¹ä½†å›æ”¶æ•ˆæœå·®
- æœ€ç»ˆOutOfMemoryError

æ ¹æœ¬åŸå› ï¼š
SessionæŒæœ‰å¤§é‡å¯¹è±¡å¼•ç”¨ â†’ æ— æ³•è¢«GCå›æ”¶
```

**æ³„æ¼åœºæ™¯å›¾è§£**
```
æ­£å¸¸æƒ…å†µï¼š
è¯·æ±‚1: Sessionæ‰“å¼€ â†’ å¤„ç† â†’ Sessionå…³é—­ â†’ GCå›æ”¶ âœ“
è¯·æ±‚2: Sessionæ‰“å¼€ â†’ å¤„ç† â†’ Sessionå…³é—­ â†’ GCå›æ”¶ âœ“

å†…å­˜æ³„æ¼ï¼š
è¯·æ±‚1: Sessionæ‰“å¼€ â†’ å¤„ç† â†’ å¿˜è®°å…³é—­ â†’ å†…å­˜ä¿ç•™ âœ—
è¯·æ±‚2: Sessionæ‰“å¼€ â†’ å¤„ç† â†’ å¿˜è®°å…³é—­ â†’ å†…å­˜ç´¯ç§¯ âœ—
è¯·æ±‚3: Sessionæ‰“å¼€ â†’ å¤„ç† â†’ å¿˜è®°å…³é—­ â†’ å†…å­˜è†¨èƒ€ âœ—
...
å†…å­˜æº¢å‡ºï¼
```

**âœ… è§„èŒƒçš„Sessionç®¡ç†**
```java
// âŒ é”™è¯¯ï¼šå¯èƒ½å¿˜è®°å…³é—­
public User findUser(Long id) {
    Session session = factory.openSession();
    User user = session.get(User.class, id);
    return user;  // å¿˜è®°session.close()
}

// âœ… æ­£ç¡®ï¼štry-with-resourcesè‡ªåŠ¨å…³é—­
public User findUser(Long id) {
    try (Session session = factory.openSession()) {
        return session.get(User.class, id);
    }  // è‡ªåŠ¨å…³é—­
}

// âœ… æ­£ç¡®ï¼šfinallyç¡®ä¿å…³é—­
public User findUser(Long id) {
    Session session = null;
    try {
        session = factory.openSession();
        return session.get(User.class, id);
    } finally {
        if (session != null) {
            session.close();
        }
    }
}
```

**ğŸ” ä¸€çº§ç¼“å­˜è†¨èƒ€**

**é—®é¢˜åœºæ™¯**
```java
// âŒ é—®é¢˜ï¼šå¤§æ‰¹é‡æ“ä½œä¸æ¸…ç†ç¼“å­˜
Session session = factory.openSession();
Transaction tx = session.beginTransaction();

for (int i = 0; i < 100000; i++) {
    User user = new User();
    user.setName("User" + i);
    session.save(user);  // å¯¹è±¡ä¿ç•™åœ¨Sessionç¼“å­˜ä¸­
}
// 10ä¸‡ä¸ªå¯¹è±¡éƒ½åœ¨å†…å­˜ä¸­ â†’ å†…å­˜æº¢å‡º

tx.commit();
session.close();
```

**âœ… æ­£ç¡®åšæ³•ï¼šå®šæœŸæ¸…ç†ç¼“å­˜**
```java
Session session = factory.openSession();
Transaction tx = session.beginTransaction();

for (int i = 0; i < 100000; i++) {
    User user = new User();
    user.setName("User" + i);
    session.save(user);
    
    // æ¯100æ¡è®°å½•æ¸…ç†ä¸€æ¬¡
    if (i % 100 == 0) {
        session.flush();   // åŒæ­¥åˆ°æ•°æ®åº“
        session.clear();   // æ¸…ç©ºä¸€çº§ç¼“å­˜
    }
}

tx.commit();
session.close();
```

**å†…å­˜ç›‘æ§æ–¹æ³•**
```java
// é…ç½®Hibernateç»Ÿè®¡ä¿¡æ¯
<property name="hibernate.generate_statistics">true</property>

// ä»£ç ä¸­è·å–ç»Ÿè®¡
SessionFactory factory = ...;
Statistics stats = factory.getStatistics();

System.out.println("Sessionæ‰“å¼€æ•°: " + stats.getSessionOpenCount());
System.out.println("Sessionå…³é—­æ•°: " + stats.getSessionCloseCount());
System.out.println("å®ä½“åŠ è½½æ•°: " + stats.getEntityLoadCount());

// å¦‚æœæ‰“å¼€æ•° > å…³é—­æ•° â†’ æœ‰æ³„æ¼
```

### 4.2 æ€§èƒ½ç“¶é¢ˆåˆ†æ


**ğŸ”¸ N+1æŸ¥è¯¢é—®é¢˜**

**é—®é¢˜åŸç†**
```
åœºæ™¯ï¼šæŸ¥è¯¢ç”¨æˆ·åŠå…¶è®¢å•

ç¬¬1æ¡SQLï¼šæŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
SELECT * FROM user

ç¬¬2~N+1æ¡SQLï¼šæ¯ä¸ªç”¨æˆ·æŸ¥è¯¢ä¸€æ¬¡è®¢å•
SELECT * FROM order WHERE user_id = 1
SELECT * FROM order WHERE user_id = 2
SELECT * FROM order WHERE user_id = 3
...

æ€»å…±N+1æ¡SQL â†’ æ€§èƒ½æå·®
```

**é—®é¢˜ä»£ç ç¤ºä¾‹**
```java
// âŒ è§¦å‘N+1é—®é¢˜
List<User> users = session.createQuery("FROM User", User.class)
                          .list();

for (User user : users) {
    // æ¯æ¬¡å¾ªç¯è§¦å‘ä¸€æ¬¡æŸ¥è¯¢
    System.out.println(user.getOrders().size());
}

// å¦‚æœæœ‰100ä¸ªç”¨æˆ· â†’ æ‰§è¡Œ101æ¡SQL
```

**âœ… è§£å†³æ–¹æ³•**

**æ–¹æ³•ä¸€ï¼šJOIN FETCH ä¸€æ¬¡æŸ¥è¯¢**
```java
String hql = "FROM User u JOIN FETCH u.orders";
List<User> users = session.createQuery(hql, User.class).list();

// åªæ‰§è¡Œ1æ¡SQLï¼ŒåŒ…å«JOIN
// SELECT u.*, o.* FROM user u LEFT JOIN order o ON u.id = o.user_id
```

**æ–¹æ³•äºŒï¼šæ‰¹é‡åŠ è½½**
```java
// é…ç½®æ–‡ä»¶
<property name="hibernate.default_batch_fetch_size">10</property>

// æ•ˆæœï¼š10ä¸ªç”¨æˆ·çš„è®¢å•ä¸€æ¬¡æŸ¥è¯¢
// 100ä¸ªç”¨æˆ· â†’ åªéœ€11æ¡SQLï¼ˆ1æ¡ç”¨æˆ· + 10æ¡æ‰¹é‡è®¢å•ï¼‰
```

**æ–¹æ³•ä¸‰ï¼šäºŒçº§ç¼“å­˜**
```java
// å¯ç”¨äºŒçº§ç¼“å­˜
<property name="hibernate.cache.use_second_level_cache">true</property>

@Entity
@Cacheable
@org.hibernate.annotations.Cache(usage = CacheConcurrencyStrategy.READ_WRITE)
public class Order {
    // è®¢å•ç¼“å­˜ï¼Œå‡å°‘æŸ¥è¯¢
}
```

**æ€§èƒ½å¯¹æ¯”è¡¨**

| æ–¹æ¡ˆ | **SQLæ•°é‡** | **å†…å­˜å ç”¨** | **é€‚ç”¨åœºæ™¯** |
|------|-----------|------------|-------------|
| **N+1æŸ¥è¯¢** | `N+1æ¡` | `è¾ƒä½` | `âŒ é¿å…ä½¿ç”¨` |
| **JOIN FETCH** | `1æ¡` | `è¾ƒé«˜` | `âœ… ç¡®å®šéœ€è¦å…³è”æ•°æ®` |
| **æ‰¹é‡åŠ è½½** | `çº¦N/batch_size` | `ä¸­ç­‰` | `âœ… ä¸ç¡®å®šæ˜¯å¦éœ€è¦` |
| **äºŒçº§ç¼“å­˜** | `é¦–æ¬¡å0æ¡` | `é«˜` | `âœ… è¯»å¤šå†™å°‘` |

### 4.3 æ•°æ®åº“è¿æ¥é—®é¢˜


**ğŸ”¸ è¿æ¥æ± è€—å°½**

**é—®é¢˜ç°è±¡**
```
é”™è¯¯ä¿¡æ¯ï¼š
org.hibernate.exception.JDBCConnectionException: 
Could not open connection

åŸå› ï¼š
æ‰€æœ‰è¿æ¥éƒ½è¢«å ç”¨ï¼Œæ–°è¯·æ±‚è·å–ä¸åˆ°è¿æ¥
```

**é—®é¢˜åœºæ™¯**
```
è¿æ¥æ± é…ç½®ï¼šæœ€å¤§10ä¸ªè¿æ¥

è¯·æ±‚1: è·å–è¿æ¥1 â†’ æœªé‡Šæ”¾
è¯·æ±‚2: è·å–è¿æ¥2 â†’ æœªé‡Šæ”¾
...
è¯·æ±‚10: è·å–è¿æ¥10 â†’ æœªé‡Šæ”¾
è¯·æ±‚11: ç­‰å¾…è·å–è¿æ¥ â†’ è¶…æ—¶å¼‚å¸¸

è¿æ¥æ± ç¤ºæ„ï¼š
[å ç”¨][å ç”¨][å ç”¨][å ç”¨][å ç”¨]
[å ç”¨][å ç”¨][å ç”¨][å ç”¨][å ç”¨]
[ç­‰å¾…...ç­‰å¾…...è¶…æ—¶!]
```

**âœ… è¿æ¥æ± é…ç½®ä¼˜åŒ–**
```xml
<!-- æ¨èçš„è¿æ¥æ± é…ç½® -->
<property name="hibernate.c3p0.min_size">5</property>
<property name="hibernate.c3p0.max_size">20</property>
<property name="hibernate.c3p0.timeout">300</property>
<property name="hibernate.c3p0.max_statements">50</property>
<property name="hibernate.c3p0.idle_test_period">3000</property>
```

**å‚æ•°è¯´æ˜**

| å‚æ•° | **å«ä¹‰** | **æ¨èå€¼** |
|------|---------|-----------|
| `min_size` | `æœ€å°è¿æ¥æ•°` | `5-10` |
| `max_size` | `æœ€å¤§è¿æ¥æ•°` | `20-50` |
| `timeout` | `è¿æ¥è¶…æ—¶(ç§’)` | `300` |
| `idle_test_period` | `ç©ºé—²æ£€æµ‹é—´éš”(ms)` | `3000` |

**ç›‘æ§è¿æ¥ä½¿ç”¨**
```java
// è·å–C3P0è¿æ¥æ± ç»Ÿè®¡
ComboPooledDataSource cpds = (ComboPooledDataSource) dataSource;
System.out.println("æ´»è·ƒè¿æ¥: " + cpds.getNumBusyConnections());
System.out.println("ç©ºé—²è¿æ¥: " + cpds.getNumIdleConnections());
System.out.println("æ€»è¿æ¥æ•°: " + cpds.getNumConnections());

// å‘Šè­¦åˆ¤æ–­
if (cpds.getNumBusyConnections() > cpds.getMaxPoolSize() * 0.8) {
    System.err.println("è¿æ¥æ± ä½¿ç”¨ç‡è¶…è¿‡80%ï¼Œéœ€è¦ä¼˜åŒ–");
}
```

---

## 5. ğŸ’¼ äº‹åŠ¡ç®¡ç†é—®é¢˜


### 5.1 äº‹åŠ¡æœªæäº¤æ•°æ®ä¸¢å¤±


**ğŸ”¸ é—®é¢˜åœºæ™¯**
```java
// âŒ é”™è¯¯ï¼šå¿˜è®°æäº¤äº‹åŠ¡
Session session = factory.openSession();
Transaction tx = session.beginTransaction();

User user = new User();
user.setName("å¼ ä¸‰");
session.save(user);

session.close();  // æœªæäº¤ï¼Œæ•°æ®ä¸¢å¤±
```

**äº‹åŠ¡çŠ¶æ€å›¾è§£**
```
æ­£å¸¸æµç¨‹ï¼š
å¼€å¯äº‹åŠ¡ â†’ æ“ä½œæ•°æ® â†’ æäº¤äº‹åŠ¡ â†’ æ•°æ®æŒä¹…åŒ– âœ“

é”™è¯¯æµç¨‹ï¼š
å¼€å¯äº‹åŠ¡ â†’ æ“ä½œæ•°æ® â†’ å…³é—­Session â†’ äº‹åŠ¡å›æ»š â†’ æ•°æ®ä¸¢å¤± âœ—

å†…å­˜ä¸æ•°æ®åº“çŠ¶æ€ï¼š
                    å†…å­˜Session              æ•°æ®åº“
æ“ä½œåï¼š          [User: å¼ ä¸‰]              []
æœªæäº¤å…³é—­ï¼š      [æ¸…ç©º]                    []  â† æ•°æ®ä¸¢äº†
æäº¤åï¼š          [User: å¼ ä¸‰]              [User: å¼ ä¸‰] âœ“
```

**âœ… è§„èŒƒçš„äº‹åŠ¡å¤„ç†**
```java
Session session = null;
Transaction tx = null;

try {
    session = factory.openSession();
    tx = session.beginTransaction();
    
    // ä¸šåŠ¡æ“ä½œ
    User user = new User();
    user.setName("å¼ ä¸‰");
    session.save(user);
    
    tx.commit();  // æäº¤äº‹åŠ¡
    
} catch (Exception e) {
    if (tx != null) {
        tx.rollback();  // å‡ºé”™å›æ»š
    }
    throw e;
} finally {
    if (session != null) {
        session.close();
    }
}
```

### 5.2 äº‹åŠ¡éš”ç¦»çº§åˆ«é—®é¢˜


**ğŸ”¸ éš”ç¦»çº§åˆ«ç†è§£**

**å››ç§éš”ç¦»çº§åˆ«å¯¹æ¯”**

| çº§åˆ« | **è„è¯»** | **ä¸å¯é‡å¤è¯»** | **å¹»è¯»** | **æ€§èƒ½** |
|------|---------|--------------|---------|---------|
| `READ_UNCOMMITTED` | `å¯èƒ½` | `å¯èƒ½` | `å¯èƒ½` | `æœ€é«˜` |
| `READ_COMMITTED` | `ä¸ä¼š` | `å¯èƒ½` | `å¯èƒ½` | `è¾ƒé«˜` |
| `REPEATABLE_READ` | `ä¸ä¼š` | `ä¸ä¼š` | `å¯èƒ½` | `è¾ƒä½` |
| `SERIALIZABLE` | `ä¸ä¼š` | `ä¸ä¼š` | `ä¸ä¼š` | `æœ€ä½` |

**é—®é¢˜ç¤ºä¾‹**
```
è„è¯»åœºæ™¯ï¼š
äº‹åŠ¡A                       äº‹åŠ¡B
è¯»å–ï¼šprice=100            
                           ä¿®æ”¹ï¼šprice=90
è¯»å–ï¼šprice=90(è„æ•°æ®)     
                           å›æ»šï¼šprice=100
ä½¿ç”¨90è®¡ç®—(é”™è¯¯)           

ä¸å¯é‡å¤è¯»ï¼š
äº‹åŠ¡A                       äº‹åŠ¡B
è¯»å–ï¼šprice=100            
                           ä¿®æ”¹ï¼šprice=90
                           æäº¤
è¯»å–ï¼šprice=90(ä¸ä¸€è‡´)     

å¹»è¯»ï¼š
äº‹åŠ¡A                       äº‹åŠ¡B
æŸ¥è¯¢ï¼š3æ¡è®°å½•              
                           æ’å…¥1æ¡
                           æäº¤
å†æŸ¥ï¼š4æ¡è®°å½•(å‡ºç°å¹»å½±)    
```

**âœ… é…ç½®éš”ç¦»çº§åˆ«**
```xml
<!-- hibernate.cfg.xml -->
<property name="hibernate.connection.isolation">2</property>

<!-- 
  1 = READ_UNCOMMITTED (æœ€ä½éš”ç¦»)
  2 = READ_COMMITTED   (æ¨èï¼ŒOracleé»˜è®¤)
  4 = REPEATABLE_READ  (MySQLé»˜è®¤)
  8 = SERIALIZABLE     (æœ€é«˜éš”ç¦»)
-->
```

**é€‰æ‹©å»ºè®®**
- **é‡‘èç³»ç»Ÿ** â†’ `SERIALIZABLE` (æ•°æ®ä¸€è‡´æ€§æœ€é‡è¦)
- **ä¸€èˆ¬Webåº”ç”¨** â†’ `READ_COMMITTED` (å¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§)
- **é«˜å¹¶å‘è¯»å–** â†’ `READ_UNCOMMITTED` (å¯æ¥å—è„è¯»)

### 5.3 åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜


**ğŸ”¸ è·¨åº“æ“ä½œçš„æŒ‘æˆ˜**
```
å•åº“äº‹åŠ¡(ç®€å•)ï¼š
[æ•°æ®åº“A]
  â”œâ”€ æ“ä½œ1
  â”œâ”€ æ“ä½œ2
  â””â”€ æäº¤/å›æ»š

åˆ†å¸ƒå¼äº‹åŠ¡(å¤æ‚)ï¼š
[æ•°æ®åº“A]           [æ•°æ®åº“B]
  â”œâ”€ æ“ä½œ1            â”œâ”€ æ“ä½œ3
  â”œâ”€ æ“ä½œ2            â””â”€ æ“ä½œ4
  â””â”€ æäº¤ï¼Ÿ           â””â”€ æäº¤ï¼Ÿ

é—®é¢˜ï¼šAæäº¤æˆåŠŸï¼ŒBå¤±è´¥ â†’ æ•°æ®ä¸ä¸€è‡´
```

**è§£å†³æ–¹æ¡ˆå¯¹æ¯”**

| æ–¹æ¡ˆ | **ä¸€è‡´æ€§** | **æ€§èƒ½** | **å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|------|-----------|---------|-----------|-------------|
| **JTA/XAåè®®** | `å¼ºä¸€è‡´` | `ä½` | `é«˜` | `é“¶è¡Œè½¬è´¦` |
| **æ¶ˆæ¯é˜Ÿåˆ—è¡¥å¿** | `æœ€ç»ˆä¸€è‡´` | `é«˜` | `ä¸­` | `è®¢å•ç³»ç»Ÿ` |
| **Sagaæ¨¡å¼** | `æœ€ç»ˆä¸€è‡´` | `é«˜` | `é«˜` | `å¾®æœåŠ¡` |
| **TCCæ¨¡å¼** | `å¼ºä¸€è‡´` | `ä¸­` | `é«˜` | `æ”¯ä»˜ç³»ç»Ÿ` |

**ç®€å•ç¤ºä¾‹ï¼šè¡¥å¿æœºåˆ¶**
```java
public void transferMoney(Long fromId, Long toId, Double amount) {
    Session sessionA = factoryA.openSession();
    Session sessionB = factoryB.openSession();
    
    try {
        // æ•°æ®åº“Aæ‰£æ¬¾
        sessionA.beginTransaction();
        Account from = sessionA.get(Account.class, fromId);
        from.setBalance(from.getBalance() - amount);
        sessionA.getTransaction().commit();
        
        try {
            // æ•°æ®åº“BåŠ æ¬¾
            sessionB.beginTransaction();
            Account to = sessionB.get(Account.class, toId);
            to.setBalance(to.getBalance() + amount);
            sessionB.getTransaction().commit();
            
        } catch (Exception e) {
            // Bå¤±è´¥ï¼Œè¡¥å¿A
            sessionA.beginTransaction();
            from.setBalance(from.getBalance() + amount);
            sessionA.getTransaction().commit();
            throw e;
        }
        
    } finally {
        sessionA.close();
        sessionB.close();
    }
}
```

---

## 6. ğŸ› ï¸ è°ƒè¯•æŠ€å·§ä¸å·¥å…·


### 6.1 SQLæ—¥å¿—åˆ†æ


**ğŸ”¸ å¼€å¯SQLæ—¥å¿—**
```xml
<!-- è¯¦ç»†SQLæ—¥å¿—é…ç½® -->
<property name="hibernate.show_sql">true</property>
<property name="hibernate.format_sql">true</property>
<property name="hibernate.use_sql_comments">true</property>

<!-- æ—¥å¿—æ¡†æ¶é…ç½® -->
<logger name="org.hibernate.SQL" level="DEBUG"/>
<logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="TRACE"/>
```

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹**
```sql
Hibernate: 
    /* FROM User u WHERE u.age > :age */ 
    select
        user0_.id as id1_0_,
        user0_.name as name2_0_,
        user0_.age as age3_0_ 
    from
        user user0_ 
    where
        user0_.age>?

-- å‚æ•°ç»‘å®š
binding parameter [1] as [INTEGER] - [18]
```

**ğŸ” é—®é¢˜è¯Šæ–­æŠ€å·§**

| é—®é¢˜ | **æ—¥å¿—ç‰¹å¾** | **è§£å†³æ–¹æ³•** |
|------|------------|-------------|
| **N+1æŸ¥è¯¢** | `å¤§é‡ç›¸ä¼¼SELECT` | `ä½¿ç”¨JOIN FETCH` |
| **æ…¢æŸ¥è¯¢** | `æ‰§è¡Œæ—¶é—´é•¿` | `æ·»åŠ ç´¢å¼•ï¼Œä¼˜åŒ–SQL` |
| **é‡å¤æŸ¥è¯¢** | `ç›¸åŒSQLå¤šæ¬¡æ‰§è¡Œ` | `å¯ç”¨äºŒçº§ç¼“å­˜` |
| **å…¨è¡¨æ‰«æ** | `æ— WHEREæ¡ä»¶` | `æ·»åŠ æŸ¥è¯¢æ¡ä»¶` |

### 6.2 æ€§èƒ½åˆ†æå·¥å…·


**ğŸ”¸ Hibernate Statistics**
```java
// å¯ç”¨ç»Ÿè®¡
Configuration cfg = new Configuration();
cfg.setProperty("hibernate.generate_statistics", "true");

SessionFactory factory = cfg.buildSessionFactory();
Statistics stats = factory.getStatistics();

// æŸ¥è¯¢æ€§èƒ½æ•°æ®
System.out.println("æŸ¥è¯¢æ‰§è¡Œæ¬¡æ•°: " + stats.getQueryExecutionCount());
System.out.println("æŸ¥è¯¢ç¼“å­˜å‘½ä¸­: " + stats.getQueryCacheHitCount());
System.out.println("æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­: " + stats.getQueryCacheMissCount());
System.out.println("äºŒçº§ç¼“å­˜å‘½ä¸­ç‡: " + 
    stats.getSecondLevelCacheHitCount() * 100.0 / 
    stats.getSecondLevelCachePutCount() + "%");

// æŒ‰å®ä½“ç»Ÿè®¡
String[] entities = stats.getEntityNames();
for (String entity : entities) {
    EntityStatistics entityStats = stats.getEntityStatistics(entity);
    System.out.println(entity + " åŠ è½½æ¬¡æ•°: " + entityStats.getLoadCount());
}
```

**ğŸ”§ æ€§èƒ½ç›‘æ§ç¤ºä¾‹**
```java
// æ€§èƒ½ç›‘æ§å·¥å…·ç±»
public class HibernateMonitor {
    
    public static void printStatistics(SessionFactory factory) {
        Statistics stats = factory.getStatistics();
        
        System.out.println("\n========== Hibernateæ€§èƒ½ç»Ÿè®¡ ==========");
        System.out.println("Sessionæ“ä½œ:");
        System.out.println("  æ‰“å¼€: " + stats.getSessionOpenCount());
        System.out.println("  å…³é—­: " + stats.getSessionCloseCount());
        
        System.out.println("\næ•°æ®åº“æ“ä½œ:");
        System.out.println("  æŸ¥è¯¢æ¬¡æ•°: " + stats.getQueryExecutionCount());
        System.out.println("  æ›´æ–°æ¬¡æ•°: " + stats.getEntityUpdateCount());
        System.out.println("  æ’å…¥æ¬¡æ•°: " + stats.getEntityInsertCount());
        System.out.println("  åˆ é™¤æ¬¡æ•°: " + stats.getEntityDeleteCount());
        
        System.out.println("\nç¼“å­˜æ•ˆæœ:");
        double hitRate = stats.getSecondLevelCacheHitCount() * 100.0 
                        / (stats.getSecondLevelCacheHitCount() 
                           + stats.getSecondLevelCacheMissCount());
        System.out.println("  äºŒçº§ç¼“å­˜å‘½ä¸­ç‡: " + String.format("%.2f%%", hitRate));
        
        System.out.println("=========================================\n");
    }
}
```

### 6.3 å¸¸ç”¨è°ƒè¯•å‘½ä»¤


**ğŸ”¸ IDEAæ–­ç‚¹è°ƒè¯•æŠ€å·§**
```
å…³é”®æ–­ç‚¹ä½ç½®ï¼š
â–¡ session.save/update/delete â†’ æŸ¥çœ‹å¯¹è±¡çŠ¶æ€
â–¡ transaction.commit â†’ æ£€æŸ¥æ˜¯å¦æäº¤
â–¡ query.list/uniqueResult â†’ æŸ¥çœ‹æŸ¥è¯¢ç»“æœ
â–¡ getteræ–¹æ³• â†’ æ£€æµ‹æ‡’åŠ è½½è§¦å‘

æ¡ä»¶æ–­ç‚¹ç¤ºä¾‹ï¼š
user.getId() == 1L  // åªåœ¨ID=1æ—¶åœæ­¢
orders.size() > 100 // è®¢å•è¶…è¿‡100æ—¶åœæ­¢
```

**ğŸ”§ å®ç”¨è°ƒè¯•ä»£ç **
```java
// è°ƒè¯•å·¥å…·æ–¹æ³•
public class DebugUtils {
    
    // æ‰“å°å¯¹è±¡çŠ¶æ€
    public static void printEntityState(Object entity, Session session) {
        String state;
        if (session.contains(entity)) {
            state = "æŒä¹…æ€(Persistent)";
        } else if (entity != null) {
            state = "æ¸¸ç¦»æ€(Detached)";
        } else {
            state = "ç¬æ—¶æ€(Transient)";
        }
        System.out.println("å¯¹è±¡çŠ¶æ€: " + state);
    }
    
    // æ‰“å°SQLæ‰§è¡Œä¿¡æ¯
    public static void logQuery(String hql, Map<String, Object> params) {
        System.out.println("=== HQLæŸ¥è¯¢ ===");
        System.out.println("è¯­å¥: " + hql);
        System.out.println("å‚æ•°: " + params);
        System.out.println("===============");
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¼‚å¸¸å¤„ç†é€ŸæŸ¥è¡¨


| å¼‚å¸¸ | **æ ¹æœ¬åŸå› ** | **å¿«é€Ÿè§£å†³** |
|------|------------|------------|
| `LazyInitializationException` | `Sessionå…³é—­åè®¿é—®æ‡’åŠ è½½` | `ç”¨JOIN FETCHæˆ–ä¿æŒSession` |
| `NonUniqueObjectException` | `Sessionä¸­é‡å¤IDå¯¹è±¡` | `ç”¨merge()ä»£æ›¿save()` |
| `StaleObjectStateException` | `ä¹è§‚é”ç‰ˆæœ¬å†²çª` | `é‡è¯•æˆ–æç¤ºç”¨æˆ·` |
| `QuerySyntaxException` | `HQLè¯­æ³•é”™è¯¯` | `æ£€æŸ¥ç±»åã€å±æ€§åæ‹¼å†™` |
| `MappingException` | `æ˜ å°„é…ç½®é”™è¯¯` | `æ£€æŸ¥@Idå’Œå…³è”å…³ç³»` |
| `PropertyAccessException` | `getter/setteré—®é¢˜` | `ç”¨@AccessæŒ‡å®šè®¿é—®æ–¹å¼` |
| `TransientObjectException` | `å…³è”ç¬æ—¶å¯¹è±¡` | `å…ˆsave()æˆ–ç”¨çº§è”` |

### 7.2 æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒç­–ç•¥


```
ğŸ¯ ä¼˜åŒ–é‡‘å­—å¡”ï¼ˆä»ä¸Šåˆ°ä¸‹ä¼˜å…ˆçº§é€’å‡ï¼‰ï¼š

ç¬¬1å±‚ï¼šé¿å…N+1æŸ¥è¯¢
â””â”€ ä½¿ç”¨JOIN FETCH / æ‰¹é‡åŠ è½½

ç¬¬2å±‚ï¼šåˆç†ä½¿ç”¨ç¼“å­˜
â””â”€ ä¸€çº§ç¼“å­˜(Session) + äºŒçº§ç¼“å­˜(SessionFactory)

ç¬¬3å±‚ï¼šSQLä¼˜åŒ–
â””â”€ å»ºç´¢å¼• / åªæŸ¥éœ€è¦çš„å­—æ®µ / åˆ†é¡µæŸ¥è¯¢

ç¬¬4å±‚ï¼šè¿æ¥æ± ä¼˜åŒ–
â””â”€ åˆç†é…ç½®è¿æ¥æ•° / ç›‘æ§è¿æ¥ä½¿ç”¨

ç¬¬5å±‚ï¼šJVMè°ƒä¼˜
â””â”€ å †å¤§å° / GCç­–ç•¥
```

### 7.3 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•


**ğŸ“ å¼€å‘è§„èŒƒ**
```
â–¡ æ€»æ˜¯ç”¨try-with-resourcesæˆ–finallyå…³é—­Session
â–¡ æ‰¹é‡æ“ä½œæ—¶å®šæœŸflushå’Œclear
â–¡ é¿å…åœ¨å¾ªç¯ä¸­æ‰§è¡ŒæŸ¥è¯¢
â–¡ ä½¿ç”¨JOIN FETCHè€Œéå¤šæ¬¡æŸ¥è¯¢
â–¡ åˆç†è®¾ç½®fetchç­–ç•¥(LAZY/EAGER)
â–¡ ä¸ºé«˜é¢‘æŸ¥è¯¢å¯ç”¨äºŒçº§ç¼“å­˜
â–¡ æ‰€æœ‰äº‹åŠ¡å¿…é¡»commitæˆ–rollback
â–¡ å¼€å‘ç¯å¢ƒå¼€å¯SQLæ—¥å¿—
â–¡ ç”Ÿäº§ç¯å¢ƒå¼€å¯æ€§èƒ½ç»Ÿè®¡
```

**ğŸ” é—®é¢˜æ’æŸ¥æ­¥éª¤**
```
æ­¥éª¤1ï¼šæŸ¥çœ‹å¼‚å¸¸æ ˆä¿¡æ¯
    â†“
æ­¥éª¤2ï¼šæ£€æŸ¥SQLæ—¥å¿—
    â†“
æ­¥éª¤3ï¼šåˆ†æHibernateç»Ÿè®¡
    â†“
æ­¥éª¤4ï¼šä½¿ç”¨è°ƒè¯•æ–­ç‚¹
    â†“
æ­¥éª¤5ï¼šç›‘æ§å†…å­˜å’Œè¿æ¥
```

**ğŸ’¡ è®°å¿†å£è¯€**
```
æ‡’åŠ è½½å¼‚å¸¸Sessionå…³ï¼Œ
å¯¹è±¡çŠ¶æ€è¦åˆ†æ¸…ã€‚
N+1æŸ¥è¯¢æ€§èƒ½æ€æ‰‹ï¼Œ
JOIN FETCHæ‰¹é‡æ˜¯è‰¯æ–¹ã€‚

äº‹åŠ¡æäº¤åˆ«å¿˜è®°ï¼Œ
è¿æ¥å…³é—­è®°å¿ƒé—´ã€‚
ç¼“å­˜ç­–ç•¥ç”¨å¾—å¥½ï¼Œ
æ€§èƒ½æå‡è·‘å¾—æ¬¢ã€‚

SQLæ—¥å¿—å¼€èµ·æ¥ï¼Œ
é—®é¢˜å®šä½ä¸å†éš¾ã€‚
ç»Ÿè®¡ç›‘æ§åšåˆ°ä½ï¼Œ
ç³»ç»Ÿç¨³å®šä¿å¹³å®‰ã€‚
```

---

**ğŸ¯ å­¦ä¹ å»ºè®®**
- **ç†è§£åŸç†**ï¼šçŸ¥é“ä¸ºä»€ä¹ˆä¼šå‡ºé—®é¢˜ï¼Œè€Œä¸åªæ˜¯è®°è§£å†³æ–¹æ³•
- **å®è·µä¸ºä¸»**ï¼šè‡ªå·±é‡åˆ°é”™è¯¯æ‰å°è±¡æ·±åˆ»
- **å–„ç”¨å·¥å…·**ï¼šSQLæ—¥å¿—ã€ç»Ÿè®¡ä¿¡æ¯æ˜¯æœ€å¥½çš„è€å¸ˆ
- **å½¢æˆä¹ æƒ¯**ï¼šè§„èŒƒçš„ä»£ç ä¹ æƒ¯èƒ½é¿å…90%çš„é—®é¢˜