---
title: 74ã€æ€§èƒ½ç›‘æ§ä¸è°ƒè¯•
---
## ğŸ“š ç›®å½•

1. [æ€§èƒ½ç›‘æ§æ¦‚è¿°](#1-æ€§èƒ½ç›‘æ§æ¦‚è¿°)
2. [SQLè¯­å¥ç›‘æ§](#2-SQLè¯­å¥ç›‘æ§)
3. [Hibernate Statisticsç»Ÿè®¡](#3-Hibernate-Statisticsç»Ÿè®¡)
4. [p6spy SQLç›‘æ§å·¥å…·](#4-p6spy-SQLç›‘æ§å·¥å…·)
5. [æ€§èƒ½åˆ†æå·¥å…·](#5-æ€§èƒ½åˆ†æå·¥å…·)
6. [æ€§èƒ½é—®é¢˜è¯Šæ–­](#6-æ€§èƒ½é—®é¢˜è¯Šæ–­)
7. [æœ€ä½³å®è·µæ€»ç»“](#7-æœ€ä½³å®è·µæ€»ç»“)

---

## 1. ğŸ” æ€§èƒ½ç›‘æ§æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦æ€§èƒ½ç›‘æ§


**å®é™…é—®é¢˜åœºæ™¯**ï¼š
```
ä½ çš„ç³»ç»Ÿä¸Šçº¿åï¼š
ç”¨æˆ·åé¦ˆï¼šé¡µé¢åŠ è½½å¾ˆæ…¢ï¼Œè¦ç­‰5ç§’
å¼€å‘äººå‘˜ä¸€è„¸æ‡µï¼šæœ¬åœ°æµ‹è¯•æ˜æ˜å¾ˆå¿«å•Šï¼Ÿ

é—®é¢˜åœ¨å“ªï¼Ÿ
- æ˜¯SQLæŸ¥è¯¢æ…¢äº†ï¼Ÿ
- æ˜¯å‘é€çš„SQLå¤ªå¤šäº†ï¼Ÿ
- è¿˜æ˜¯å†…å­˜å ç”¨å¤ªé«˜ï¼Ÿ

æ²¡æœ‰ç›‘æ§ = ç›²äººæ‘¸è±¡ï¼
```

**ç›‘æ§çš„æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ“Š **å‘ç°é—®é¢˜**ï¼šæ…¢åœ¨å“ªé‡Œï¼Ÿä¸ºä»€ä¹ˆæ…¢ï¼Ÿ
- ğŸ¯ **å®šä½ç“¶é¢ˆ**ï¼šæ˜¯æ•°æ®åº“ï¼Ÿä»£ç ï¼Ÿè¿˜æ˜¯ç½‘ç»œï¼Ÿ
- ğŸ“ˆ **éªŒè¯ä¼˜åŒ–**ï¼šæ”¹å®Œä¹‹åçœŸçš„å¿«äº†å—ï¼Ÿ
- âš ï¸ **é¢„é˜²æ•…éšœ**ï¼šæå‰å‘ç°éšæ‚£

### 1.2 ç›‘æ§çš„ä¸‰ä¸ªå±‚é¢


```
åº”ç”¨å±‚é¢                æ•°æ®åº“å±‚é¢              ç³»ç»Ÿå±‚é¢
   â†“                      â†“                     â†“
Hibernateç»Ÿè®¡         SQLè¯­å¥åˆ†æ           CPU/å†…å­˜ç›‘æ§
ä»£ç æ‰§è¡Œæ—¶é—´          æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’           è¿æ¥æ± çŠ¶æ€
ç¼“å­˜å‘½ä¸­ç‡            æ…¢æŸ¥è¯¢æ—¥å¿—             ç½‘ç»œIO
```

**ç›‘æ§ç­–ç•¥**ï¼š
- ğŸŸ¢ **å¼€å‘é˜¶æ®µ**ï¼šå¼€å¯è¯¦ç»†æ—¥å¿—ï¼Œå‘ç°æ½œåœ¨é—®é¢˜
- ğŸŸ¡ **æµ‹è¯•é˜¶æ®µ**ï¼šæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œå‹åŠ›æµ‹è¯•
- ğŸ”´ **ç”Ÿäº§ç¯å¢ƒ**ï¼šç²¾ç®€ç›‘æ§ï¼Œåªçœ‹å…³é”®æŒ‡æ ‡

---

## 2. ğŸ“ SQLè¯­å¥ç›‘æ§


### 2.1 åŸºç¡€SQLæ—¥å¿—é…ç½®


**æœ€ç®€å•çš„ç›‘æ§æ–¹å¼**ï¼šæ‰“å¼€Hibernateçš„SQLæ—¥å¿—

```properties
# application.properties
# æ˜¾ç¤ºæ‰§è¡Œçš„SQLè¯­å¥
spring.jpa.show-sql=true

# æ ¼å¼åŒ–SQLï¼ˆæ–¹ä¾¿é˜…è¯»ï¼‰
spring.jpa.properties.hibernate.format_sql=true

# æ˜¾ç¤ºSQLå‚æ•°å€¼
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```sql
-- çœ‹åˆ°çš„SQLæ—¥å¿—
Hibernate: 
    select
        user0_.id as id1_0_,
        user0_.name as name2_0_,
        user0_.email as email3_0_ 
    from
        user user0_ 
    where
        user0_.id=?

-- çœ‹åˆ°çš„å‚æ•°ç»‘å®š
binding parameter [1] as [BIGINT] - [1]
```

**æ—¥å¿—è§£è¯»**ï¼š
- âœ… **ä¼˜ç‚¹**ï¼šé…ç½®ç®€å•ï¼Œç«‹å³å¯ç”¨
- âŒ **ç¼ºç‚¹**ï¼šåªèƒ½çœ‹SQLï¼Œçœ‹ä¸åˆ°æ‰§è¡Œæ—¶é—´
- ğŸ’¡ **é€‚ç”¨**ï¼šå¼€å‘è°ƒè¯•é˜¶æ®µ

### 2.2 SQLæ‰§è¡Œæ—¶é—´ç›‘æ§


**é…ç½®å¸¦æ—¶é—´çš„æ—¥å¿—**ï¼š

```properties
# æ˜¾ç¤ºSQLæ‰§è¡Œç»Ÿè®¡
spring.jpa.properties.hibernate.generate_statistics=true

# SQLæ‰§è¡Œæ—¶é—´æ—¥å¿—
logging.level.org.hibernate.stat=DEBUG
```

**è¾“å‡ºæ•ˆæœ**ï¼š
```
æ‰§è¡ŒSQL: select * from user where id = ?
å‚æ•°: [1]
æ‰§è¡Œæ—¶é—´: 15ms  â† å…³é”®ä¿¡æ¯ï¼
```

### 2.3 è¯†åˆ«é—®é¢˜SQL


**å¸¸è§é—®é¢˜æ¨¡å¼**ï¼š

| é—®é¢˜ç±»å‹ | ç—‡çŠ¶ | ç¤ºä¾‹ |
|---------|------|------|
| **N+1æŸ¥è¯¢** | `å¾ªç¯ä¸­æ‰§è¡ŒSQL` | æŸ¥1æ¬¡ç”¨æˆ· + æŸ¥Næ¬¡è®¢å• |
| **æ…¢æŸ¥è¯¢** | `å•æ¡SQLè¶…è¿‡100ms` | å…¨è¡¨æ‰«æã€æ²¡ç´¢å¼• |
| **é‡å¤æŸ¥è¯¢** | `ç›¸åŒSQLæ‰§è¡Œå¤šæ¬¡` | ç¼“å­˜æœªç”Ÿæ•ˆ |
| **å¤§ç»“æœé›†** | `è¿”å›å‡ åƒä¸Šä¸‡æ¡æ•°æ®` | æœªåˆ†é¡µæŸ¥è¯¢ |

**è¯†åˆ«N+1é—®é¢˜ç¤ºä¾‹**ï¼š
```java
// âŒ é—®é¢˜ä»£ç 
List<User> users = userRepository.findAll();  // SQL 1æ¬¡
for(User user : users) {
    List<Order> orders = user.getOrders();     // SQL Næ¬¡ï¼
    // æ€»å…±ï¼š1 + N æ¬¡SQL
}

// æ—¥å¿—ä¼šçœ‹åˆ°ï¼š
// SELECT * FROM user
// SELECT * FROM orders WHERE user_id = 1
// SELECT * FROM orders WHERE user_id = 2
// SELECT * FROM orders WHERE user_id = 3
// ... Næ¬¡æŸ¥è¯¢ï¼
```

---

## 3. ğŸ“Š Hibernate Statisticsç»Ÿè®¡


### 3.1 Statisticsæ˜¯ä»€ä¹ˆ


**ç®€å•ç†è§£**ï¼š
```
Hibernate Statistics = Hibernateå†…ç½®çš„"ä½“æ£€æŠ¥å‘Š"

å®ƒä¼šè®°å½•ï¼š
- æ‰§è¡Œäº†å¤šå°‘æ¬¡æŸ¥è¯¢
- ç¼“å­˜å‘½ä¸­äº†å¤šå°‘æ¬¡
- æ•°æ®åº“è¿æ¥ç”¨äº†å¤šä¹…
- å“ªäº›æ“ä½œæœ€æ…¢

å°±åƒæ±½è½¦ä»ªè¡¨ç›˜ï¼Œå‘Šè¯‰ä½ ï¼š
æ²¹è€—å¤šå°‘ã€é€Ÿåº¦å¤šå¿«ã€å“ªé‡Œæœ‰é—®é¢˜
```

### 3.2 å¼€å¯Statisticsç»Ÿè®¡


```properties
# application.properties
spring.jpa.properties.hibernate.generate_statistics=true
logging.level.org.hibernate.stat=DEBUG
```

```java
// åœ¨ä»£ç ä¸­è·å–ç»Ÿè®¡ä¿¡æ¯
@Autowired
private EntityManagerFactory entityManagerFactory;

public void printStatistics() {
    SessionFactory sessionFactory = 
        entityManagerFactory.unwrap(SessionFactory.class);
    Statistics stats = sessionFactory.getStatistics();
    
    // æ‰“å°ç»Ÿè®¡ä¿¡æ¯
    System.out.println("æŸ¥è¯¢æ¬¡æ•°: " + stats.getQueryExecutionCount());
    System.out.println("æŸ¥è¯¢æ€»è€—æ—¶: " + stats.getQueryExecutionMaxTime() + "ms");
    System.out.println("äºŒçº§ç¼“å­˜å‘½ä¸­: " + stats.getSecondLevelCacheHitCount());
}
```

### 3.3 å…³é”®ç»Ÿè®¡æŒ‡æ ‡è¯¦è§£


**ğŸ”¸ æŸ¥è¯¢ç»Ÿè®¡**ï¼š
```java
stats.getQueryExecutionCount()       // æ‰§è¡Œäº†å‡ æ¬¡æŸ¥è¯¢
stats.getQueryExecutionMaxTime()     // æœ€æ…¢çš„æŸ¥è¯¢è€—æ—¶
stats.getQueryExecutionMaxTimeQueryString() // å“ªæ¡SQLæœ€æ…¢
```

**å®é™…æ¡ˆä¾‹**ï¼š
```
æŸ¥è¯¢æ‰§è¡Œæ¬¡æ•°: 156æ¬¡
æœ€æ…¢æŸ¥è¯¢: 850ms
æœ€æ…¢SQL: SELECT * FROM order WHERE user_id IN (...)

åˆ†æï¼š
âŒ 156æ¬¡æŸ¥è¯¢å¤ªå¤šäº†ï¼å¯èƒ½æœ‰N+1é—®é¢˜
âŒ 850mså¤ªæ…¢äº†ï¼è¿™æ¡SQLéœ€è¦ä¼˜åŒ–
```

**ğŸ”¸ ç¼“å­˜ç»Ÿè®¡**ï¼š
```java
// ä¸€çº§ç¼“å­˜ï¼ˆSessionç¼“å­˜ï¼‰
stats.getEntityLoadCount()        // ä»æ•°æ®åº“åŠ è½½å®ä½“æ¬¡æ•°
stats.getEntityFetchCount()       // å®ä½“æŠ“å–æ¬¡æ•°

// äºŒçº§ç¼“å­˜ç»Ÿè®¡
stats.getSecondLevelCacheHitCount()   // äºŒçº§ç¼“å­˜å‘½ä¸­æ¬¡æ•°
stats.getSecondLevelCacheMissCount()  // äºŒçº§ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°
```

**ç¼“å­˜å‘½ä¸­ç‡è®¡ç®—**ï¼š
```java
long hits = stats.getSecondLevelCacheHitCount();
long misses = stats.getSecondLevelCacheMissCount();
double hitRate = (double)hits / (hits + misses) * 100;

System.out.println("äºŒçº§ç¼“å­˜å‘½ä¸­ç‡: " + hitRate + "%");

// æœŸæœ›å€¼ï¼š
// âœ… å‘½ä¸­ç‡ > 80%  = ç¼“å­˜æ•ˆæœå¥½
// âš ï¸ å‘½ä¸­ç‡ < 50%  = ç¼“å­˜é…ç½®æœ‰é—®é¢˜
```

**ğŸ”¸ è¿æ¥æ± ç»Ÿè®¡**ï¼š
```java
stats.getConnectCount()           // è·å–è¿æ¥æ¬¡æ•°
stats.getSessionOpenCount()       // Sessionæ‰“å¼€æ¬¡æ•°
stats.getSessionCloseCount()      // Sessionå…³é—­æ¬¡æ•°
```

### 3.4 å®æˆ˜ï¼šæ€§èƒ½ç›‘æ§æ¥å£


```java
@RestController
@RequestMapping("/admin")
public class MonitorController {
    
    @Autowired
    private EntityManagerFactory emf;
    
    @GetMapping("/stats")
    public Map<String, Object> getStatistics() {
        Statistics stats = emf.unwrap(SessionFactory.class)
                              .getStatistics();
        
        Map<String, Object> result = new HashMap<>();
        
        // æŸ¥è¯¢ç»Ÿè®¡
        result.put("æŸ¥è¯¢æ€»æ¬¡æ•°", stats.getQueryExecutionCount());
        result.put("æœ€æ…¢æŸ¥è¯¢æ—¶é—´", stats.getQueryExecutionMaxTime() + "ms");
        result.put("æœ€æ…¢SQL", stats.getQueryExecutionMaxTimeQueryString());
        
        // ç¼“å­˜ç»Ÿè®¡
        long hits = stats.getSecondLevelCacheHitCount();
        long misses = stats.getSecondLevelCacheMissCount();
        double hitRate = hits + misses > 0 
            ? (double)hits / (hits + misses) * 100 
            : 0;
        result.put("ç¼“å­˜å‘½ä¸­ç‡", String.format("%.2f%%", hitRate));
        
        // è¿æ¥ç»Ÿè®¡
        result.put("æ•°æ®åº“è¿æ¥æ¬¡æ•°", stats.getConnectCount());
        
        return result;
    }
    
    // æ¸…ç©ºç»Ÿè®¡æ•°æ®
    @PostMapping("/stats/clear")
    public String clearStatistics() {
        Statistics stats = emf.unwrap(SessionFactory.class)
                              .getStatistics();
        stats.clear();
        return "ç»Ÿè®¡æ•°æ®å·²æ¸…ç©º";
    }
}
```

**è®¿é—®ç›‘æ§æ¥å£**ï¼š
```json
GET /admin/stats

{
  "æŸ¥è¯¢æ€»æ¬¡æ•°": 1250,
  "æœ€æ…¢æŸ¥è¯¢æ—¶é—´": "320ms",
  "æœ€æ…¢SQL": "SELECT * FROM order o LEFT JOIN user u...",
  "ç¼“å­˜å‘½ä¸­ç‡": "78.50%",
  "æ•°æ®åº“è¿æ¥æ¬¡æ•°": 45
}
```

---

## 4. ğŸ”¬ p6spy SQLç›‘æ§å·¥å…·


### 4.1 p6spyæ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼š
```
æƒ³è±¡ä½ å®¶çš„æ°´è¡¨ï¼š
- è®°å½•æ¯æ¬¡ç”¨æ°´é‡
- æ˜¾ç¤ºç”¨æ°´æ—¶é—´
- ç»Ÿè®¡ç”¨æ°´é«˜å³°æœŸ

p6spyå°±æ˜¯"SQLæ°´è¡¨"ï¼š
- æ‹¦æˆªæ¯æ¡SQL
- è®°å½•æ‰§è¡Œæ—¶é—´
- æ˜¾ç¤ºå®Œæ•´å‚æ•°ï¼ˆä¸æ˜¯?å ä½ç¬¦ï¼‰
- ç»Ÿè®¡æ…¢æŸ¥è¯¢
```

**p6spyçš„ä¼˜åŠ¿**ï¼š
- âœ… æ˜¾ç¤ºçœŸå®SQLï¼ˆå‚æ•°å·²æ›¿æ¢ï¼‰
- âœ… ç²¾ç¡®è®°å½•æ‰§è¡Œæ—¶é—´
- âœ… ä¸éœ€è¦ä¿®æ”¹ä»£ç 
- âœ… æ”¯æŒå¤šç§æ•°æ®åº“

### 4.2 å¿«é€Ÿé›†æˆp6spy


**æ­¥éª¤1ï¼šæ·»åŠ ä¾èµ–**
```xml
<dependency>
    <groupId>p6spy</groupId>
    <artifactId>p6spy</artifactId>
    <version>3.9.1</version>
</dependency>
```

**æ­¥éª¤2ï¼šä¿®æ”¹æ•°æ®æºé…ç½®**
```properties
# application.propertiesï¼ˆåŸé…ç½®ï¼‰
# spring.datasource.url=jdbc:mysql://localhost:3306/mydb
# spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# æ”¹ä¸ºp6spyä»£ç†
spring.datasource.url=jdbc:p6spy:mysql://localhost:3306/mydb
spring.datasource.driver-class-name=com.p6spy.engine.spy.P6SpyDriver
```

**æ­¥éª¤3ï¼šåˆ›å»ºé…ç½®æ–‡ä»¶**
```properties
# resources/spy.properties
# æ—¥å¿—è¾“å‡ºæ–¹å¼
appender=com.p6spy.engine.spy.appender.Slf4JLogger

# æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´
logMessageFormat=com.p6spy.engine.spy.appender.CustomLineFormat
customLogMessageFormat=æ‰§è¡Œæ—¶é—´: %(executionTime)ms | SQL: %(sql)

# æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆè¶…è¿‡100msè®°å½•ï¼‰
executionThreshold=100
```

### 4.3 p6spyè¾“å‡ºç¤ºä¾‹


**åŸæ¥çš„æ—¥å¿—**ï¼ˆçœ‹ä¸æ¸…å‚æ•°ï¼‰ï¼š
```sql
Hibernate: select * from user where id = ?
```

**p6spyè¾“å‡º**ï¼ˆä¸€ç›®äº†ç„¶ï¼‰ï¼š
```
æ‰§è¡Œæ—¶é—´: 15ms | SQL: select * from user where id = 1
æ‰§è¡Œæ—¶é—´: 245ms | SQL: select * from order where user_id in (1,2,3,4,5,...)
æ‰§è¡Œæ—¶é—´: 890ms | SQL: select * from product where category = 'ç”µå­äº§å“'
```

**æ…¢æŸ¥è¯¢è­¦å‘Š**ï¼š
```
âš ï¸ æ…¢æŸ¥è¯¢å‘Šè­¦ï¼
æ‰§è¡Œæ—¶é—´: 1250ms | SQL: SELECT * FROM order o 
    LEFT JOIN user u ON o.user_id = u.id 
    LEFT JOIN product p ON o.product_id = p.id 
    WHERE o.create_time > '2024-01-01'
```

### 4.4 è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼


```java
// è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ç±»
public class CustomLineFormat implements MessageFormattingStrategy {
    
    @Override
    public String formatMessage(int connectionId, String now, 
                                 long elapsed, String category, 
                                 String prepared, String sql, 
                                 String url) {
        
        // åªè®°å½•æ…¢æŸ¥è¯¢ï¼ˆè¶…è¿‡100msï¼‰
        if(elapsed > 100) {
            return String.format(
                "ğŸŒ æ…¢æŸ¥è¯¢å‘Šè­¦ï¼\n" +
                "æ‰§è¡Œæ—¶é—´: %dms\n" +
                "SQLç±»å‹: %s\n" +
                "SQLè¯­å¥: %s\n" +
                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n",
                elapsed, category, sql
            );
        }
        
        return String.format("[%dms] %s", elapsed, sql);
    }
}
```

**é…ç½®ä½¿ç”¨**ï¼š
```properties
# spy.properties
logMessageFormat=å®Œæ•´ç±»å.CustomLineFormat
```

---

## 5. ğŸ”§ æ€§èƒ½åˆ†æå·¥å…·


### 5.1 JProfileræ€§èƒ½åˆ†æ


**JProfilerèƒ½åšä»€ä¹ˆ**ï¼š
```
åŠŸèƒ½ä¸€è§ˆï¼š
ğŸ“Š CPUåˆ†æ    â†’ å“ªä¸ªæ–¹æ³•æœ€è€—CPU
ğŸ’¾ å†…å­˜åˆ†æ   â†’ å“ªé‡Œå ç”¨å†…å­˜æœ€å¤š
ğŸ” çº¿ç¨‹åˆ†æ   â†’ æ˜¯å¦æœ‰æ­»é”ã€çº¿ç¨‹æ³„æ¼
ğŸ“ˆ å®æ—¶ç›‘æ§   â†’ å†…å­˜ã€CPUå®æ—¶æ›²çº¿
```

**å…¸å‹ä½¿ç”¨åœºæ™¯**ï¼š
```java
// é—®é¢˜ä»£ç 
@Transactional
public List<OrderDTO> getAllOrders() {
    List<Order> orders = orderRepository.findAll();
    
    // JProfilerå‘ç°ï¼šè¿™é‡Œæœ€è€—æ—¶ï¼
    return orders.stream()
        .map(this::convertToDTO)  // æ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“
        .collect(Collectors.toList());
}

// JProfileråˆ†æç»“æœï¼š
// convertToDTO() æ–¹æ³•æ‰§è¡Œäº†10000æ¬¡
// æ¯æ¬¡è€—æ—¶50ms
// æ€»è€—æ—¶ï¼š500ç§’ï¼â† é—®é¢˜æ‰¾åˆ°äº†
```

**å…³é”®æ­¥éª¤**ï¼š
1. å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ JVMå‚æ•°
2. è¿æ¥JProfileråˆ°åº”ç”¨
3. å½•åˆ¶æ€§èƒ½æ•°æ®
4. åˆ†æçƒ­ç‚¹æ–¹æ³•

### 5.2 æ…¢æŸ¥è¯¢åˆ†æ


**è¯†åˆ«æ…¢æŸ¥è¯¢çš„æ ‡å‡†**ï¼š
```
å“åº”æ—¶é—´æ ‡å‡†ï¼š
ğŸŸ¢ < 50ms    æ­£å¸¸æŸ¥è¯¢
ğŸŸ¡ 50-100ms  éœ€è¦å…³æ³¨
ğŸŸ  100-500ms éœ€è¦ä¼˜åŒ–
ğŸ”´ > 500ms   ä¸¥é‡é—®é¢˜
```

**æ…¢æŸ¥è¯¢åˆ†ææ¸…å•**ï¼š

| æ£€æŸ¥é¡¹ | é—®é¢˜è¡¨ç° | è§£å†³æ–¹æ¡ˆ |
|-------|---------|---------|
| **ç´¢å¼•** | `å…¨è¡¨æ‰«æ` | æ·»åŠ ç´¢å¼• |
| **JOIN** | `å¤šè¡¨å…³è”å¤ªå¤š` | å‡å°‘JOINï¼Œè€ƒè™‘å†—ä½™å­—æ®µ |
| **æ•°æ®é‡** | `ä¸€æ¬¡æŸ¥å‡ ä¸‡æ¡` | æ·»åŠ åˆ†é¡µ |
| **å­æŸ¥è¯¢** | `åµŒå¥—æŸ¥è¯¢å¤ªæ·±` | æ”¹ä¸ºJOINæˆ–åˆ†æ­¥æŸ¥è¯¢ |

**å®æˆ˜ç¤ºä¾‹**ï¼š
```java
// âŒ æ…¢æŸ¥è¯¢ï¼ˆ890msï¼‰
@Query("SELECT o FROM Order o WHERE o.user.vipLevel = 'GOLD'")
List<Order> findGoldUserOrders();

// ç”ŸæˆSQLï¼š
// SELECT * FROM order o 
// LEFT JOIN user u ON o.user_id = u.id 
// WHERE u.vip_level = 'GOLD'

// âœ… ä¼˜åŒ–åï¼ˆ15msï¼‰
@Query("SELECT o FROM Order o WHERE o.userId IN " +
       "(SELECT u.id FROM User u WHERE u.vipLevel = 'GOLD')")
List<Order> findGoldUserOrders();

// æˆ–è€…ï¼šæ·»åŠ ç´¢å¼•
// CREATE INDEX idx_user_vip ON user(vip_level);
```

### 5.3 å†…å­˜ä½¿ç”¨åˆ†æ


**å†…å­˜é—®é¢˜è¡¨ç°**ï¼š
```
ç—‡çŠ¶ï¼š
- åº”ç”¨è¶Šæ¥è¶Šæ…¢
- é¢‘ç¹Full GC
- æœ€åOutOfMemoryError

å¸¸è§åŸå› ï¼š
1. ä¸€æ¬¡æŸ¥è¯¢å¤ªå¤šæ•°æ®ï¼ˆå‡ ä¸‡æ¡ï¼‰
2. ä¸€çº§ç¼“å­˜æ²¡æœ‰æ¸…ç†
3. å¾ªç¯ä¸­åˆ›å»ºå¤§é‡å¯¹è±¡
```

**ä¸€çº§ç¼“å­˜å¯¼è‡´çš„å†…å­˜é—®é¢˜**ï¼š
```java
// âŒ å†…å­˜æ³„æ¼é£é™©
@Transactional
public void processLargeData() {
    for(int i = 0; i < 100000; i++) {
        User user = userRepository.findById(i);
        // å¤„ç†user...
        // é—®é¢˜ï¼šuserä¸€ç›´ä¿å­˜åœ¨Sessionä¸­ï¼
    }
    // äº‹åŠ¡ç»“æŸå‰ï¼Œ10ä¸‡ä¸ªuseréƒ½åœ¨å†…å­˜ä¸­
}

// âœ… å®šæœŸæ¸…ç†Session
@Transactional
public void processLargeData() {
    for(int i = 0; i < 100000; i++) {
        User user = userRepository.findById(i);
        // å¤„ç†user...
        
        if(i % 100 == 0) {
            entityManager.flush();   // åˆ·æ–°åˆ°æ•°æ®åº“
            entityManager.clear();   // æ¸…ç©ºä¸€çº§ç¼“å­˜
        }
    }
}
```

---

## 6. ğŸ” æ€§èƒ½é—®é¢˜è¯Šæ–­


### 6.1 è¯Šæ–­æµç¨‹


```
æ­¥éª¤1ï¼šå‘ç°é—®é¢˜
   â†“
   ç”¨æˆ·åé¦ˆæ…¢ / ç›‘æ§å‘Šè­¦

æ­¥éª¤2ï¼šæ”¶é›†æ•°æ®
   â†“
   æŸ¥çœ‹SQLæ—¥å¿—ã€Statisticsç»Ÿè®¡

æ­¥éª¤3ï¼šå®šä½ç“¶é¢ˆ
   â†“
   æ‰¾åˆ°æœ€æ…¢çš„æŸ¥è¯¢/æ“ä½œ

æ­¥éª¤4ï¼šåˆ†æåŸå› 
   â†“
   N+1é—®é¢˜ï¼Ÿæ…¢æŸ¥è¯¢ï¼Ÿå†…å­˜æ³„æ¼ï¼Ÿ

æ­¥éª¤5ï¼šä¼˜åŒ–éªŒè¯
   â†“
   ä¿®æ”¹ä»£ç ï¼Œå¯¹æ¯”æ€§èƒ½æ•°æ®
```

### 6.2 å¸¸è§é—®é¢˜æ¸…å•


**ğŸ”¸ N+1æŸ¥è¯¢é—®é¢˜**

**ç—‡çŠ¶**ï¼š
```
æ—¥å¿—ä¸­çœ‹åˆ°ï¼š
SELECT * FROM user              -- 1æ¬¡
SELECT * FROM order WHERE user_id = 1  -- Næ¬¡
SELECT * FROM order WHERE user_id = 2
SELECT * FROM order WHERE user_id = 3
...
```

**è¯Šæ–­**ï¼š
```java
// æ£€æŸ¥ä»£ç 
List<User> users = userRepository.findAll();
for(User user : users) {
    user.getOrders().size();  // â† è¿™é‡Œè§¦å‘Næ¬¡æŸ¥è¯¢
}
```

**è§£å†³**ï¼š
```java
// ä½¿ç”¨JOIN FETCHä¸€æ¬¡æŸ¥è¯¢
@Query("SELECT u FROM User u LEFT JOIN FETCH u.orders")
List<User> findAllWithOrders();
```

**ğŸ”¸ ç¼“å­˜æœªç”Ÿæ•ˆ**

**ç—‡çŠ¶**ï¼š
```
Statisticsæ˜¾ç¤ºï¼š
äºŒçº§ç¼“å­˜å‘½ä¸­ç‡ï¼š5%  â† å¤ªä½äº†ï¼
```

**è¯Šæ–­æ­¥éª¤**ï¼š
1. æ£€æŸ¥å®ä½“ç±»æ˜¯å¦åŠ äº†`@Cacheable`
2. æ£€æŸ¥é…ç½®æ˜¯å¦å¼€å¯äº†äºŒçº§ç¼“å­˜
3. æ£€æŸ¥æŸ¥è¯¢æ˜¯å¦è®¾ç½®äº†`setCacheable(true)`

**ğŸ”¸ è¿æ¥æ± è€—å°½**

**ç—‡çŠ¶**ï¼š
```
é”™è¯¯æ—¥å¿—ï¼š
Unable to acquire JDBC Connection
Connection pool exhausted
```

**è¯Šæ–­**ï¼š
```properties
# æŸ¥çœ‹é…ç½®
spring.datasource.hikari.maximum-pool-size=10  â† å¤ªå°
spring.datasource.hikari.connection-timeout=30000
```

**è§£å†³**ï¼š
```properties
# æ ¹æ®å¹¶å‘é‡è°ƒæ•´
spring.datasource.hikari.maximum-pool-size=50
spring.datasource.hikari.minimum-idle=10

# è®¾ç½®è¿æ¥æ³„æ¼æ£€æµ‹
spring.datasource.hikari.leak-detection-threshold=60000
```

### 6.3 æ€§èƒ½åŸºå‡†æµ‹è¯•


**å»ºç«‹æ€§èƒ½åŸºçº¿**ï¼š
```java
@Test
public void performanceBenchmark() {
    // è®°å½•ä¼˜åŒ–å‰çš„æ€§èƒ½
    long start = System.currentTimeMillis();
    
    List<Order> orders = orderService.findAllWithDetails();
    
    long duration = System.currentTimeMillis() - start;
    
    System.out.println("æŸ¥è¯¢1000æ¡è®¢å•è€—æ—¶: " + duration + "ms");
    // è®°å½•ï¼šä¼˜åŒ–å‰ = 850ms
}
```

**ä¼˜åŒ–åå¯¹æ¯”**ï¼š
```
ä¼˜åŒ–å‰ï¼š850ms
ä¼˜åŒ–åï¼š120ms
æå‡ï¼š85.9%  âœ… æ•ˆæœæ˜¾è‘—
```

---

## 7. ğŸ“‹ æœ€ä½³å®è·µæ€»ç»“


### 7.1 ç›‘æ§é…ç½®å»ºè®®


**ğŸ”¸ å¼€å‘ç¯å¢ƒ**ï¼š
```properties
# è¯¦ç»†æ—¥å¿—ï¼Œå‘ç°æ‰€æœ‰é—®é¢˜
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.properties.hibernate.generate_statistics=true
logging.level.org.hibernate.type=TRACE
```

**ğŸ”¸ æµ‹è¯•ç¯å¢ƒ**ï¼š
```properties
# p6spyç›‘æ§ + æ…¢æŸ¥è¯¢å‘Šè­¦
spring.datasource.driver-class-name=com.p6spy.engine.spy.P6SpyDriver
executionThreshold=100
```

**ğŸ”¸ ç”Ÿäº§ç¯å¢ƒ**ï¼š
```properties
# å…³é—­è¯¦ç»†æ—¥å¿—ï¼Œåªè®°å½•æ…¢æŸ¥è¯¢
spring.jpa.show-sql=false
logging.level.org.hibernate.SQL=WARN

# å®šæœŸå¯¼å‡ºStatisticsæ•°æ®
spring.jpa.properties.hibernate.generate_statistics=true
```

### 7.2 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•


**æŸ¥è¯¢ä¼˜åŒ–**ï¼š
- [ ] æ˜¯å¦æœ‰N+1æŸ¥è¯¢ï¼Ÿä½¿ç”¨JOIN FETCHè§£å†³
- [ ] æ˜¯å¦æœ‰æ…¢æŸ¥è¯¢ï¼Ÿæ·»åŠ ç´¢å¼•æˆ–ä¼˜åŒ–SQL
- [ ] æ˜¯å¦ä½¿ç”¨äº†åˆ†é¡µï¼Ÿé¿å…ä¸€æ¬¡æŸ¥è¯¢è¿‡å¤šæ•°æ®
- [ ] å…³è”æŸ¥è¯¢æ˜¯å¦åˆç†ï¼Ÿå‡å°‘ä¸å¿…è¦çš„JOIN

**ç¼“å­˜ä¼˜åŒ–**ï¼š
- [ ] å¸¸ç”¨æ•°æ®æ˜¯å¦å¼€å¯äºŒçº§ç¼“å­˜ï¼Ÿ
- [ ] ç¼“å­˜å‘½ä¸­ç‡æ˜¯å¦ > 80%ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨äº†æŸ¥è¯¢ç¼“å­˜ï¼Ÿ
- [ ] æ‰¹é‡æ“ä½œæ˜¯å¦å®šæœŸæ¸…ç†ä¸€çº§ç¼“å­˜ï¼Ÿ

**è¿æ¥æ± ä¼˜åŒ–**ï¼š
- [ ] è¿æ¥æ± å¤§å°æ˜¯å¦åˆç†ï¼Ÿ
- [ ] æ˜¯å¦æœ‰è¿æ¥æ³„æ¼ï¼Ÿ
- [ ] è¿æ¥è¶…æ—¶è®¾ç½®æ˜¯å¦åˆé€‚ï¼Ÿ

### 7.3 æ ¸å¿ƒè¦ç‚¹è®°å¿†


```
ğŸ¯ ç›‘æ§ä¸‰ä»¶å¥—ï¼š
1ï¸âƒ£ SQLæ—¥å¿— â†’ çœ‹æ‰§è¡Œäº†ä»€ä¹ˆSQL
2ï¸âƒ£ Statistics â†’ çœ‹æ•´ä½“æ€§èƒ½æ•°æ®
3ï¸âƒ£ p6spy â†’ çœ‹SQLçœŸå®å‚æ•°å’Œè€—æ—¶

ğŸ” é—®é¢˜å®šä½ä¸‰æ­¥èµ°ï¼š
æ­¥éª¤1ï¼šå¼€å¯ç›‘æ§ï¼Œæ”¶é›†æ•°æ®
æ­¥éª¤2ï¼šæ‰¾åˆ°æ…¢çš„åœ°æ–¹ï¼ˆSQL/ç¼“å­˜/è¿æ¥ï¼‰
æ­¥éª¤3ï¼šé’ˆå¯¹æ€§ä¼˜åŒ–ï¼ŒéªŒè¯æ•ˆæœ

âš¡ æ€§èƒ½ä¼˜åŒ–é‡ç‚¹ï¼š
- è§£å†³N+1æŸ¥è¯¢é—®é¢˜
- ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼ˆç´¢å¼•ã€åˆ†é¡µï¼‰
- åˆç†ä½¿ç”¨ç¼“å­˜
- å®šæœŸæ¸…ç†ä¸€çº§ç¼“å­˜
- ç›‘æ§è¿æ¥æ± çŠ¶æ€

ğŸ’¡ è®°ä½ï¼š
æ²¡æœ‰ç›‘æ§ = ç›²äººæ‘¸è±¡
ç›‘æ§æ˜¯ä¼˜åŒ–çš„ç¬¬ä¸€æ­¥ï¼
```

---

> ğŸ’¡ **å­¦ä¹ å»ºè®®**
> 
> - å¼€å‘æ—¶å…»æˆçœ‹SQLæ—¥å¿—çš„ä¹ æƒ¯
> - å®šæœŸæŸ¥çœ‹Statisticsç»Ÿè®¡æ•°æ®
> - ä¸Šçº¿å‰åŠ¡å¿…åšæ€§èƒ½æµ‹è¯•
> - ç”Ÿäº§ç¯å¢ƒä¿ç•™å¿…è¦ç›‘æ§æ‰‹æ®µ

> âš ï¸ **æ³¨æ„äº‹é¡¹**
> 
> - ç”Ÿäº§ç¯å¢ƒä¸è¦å¼€å¯è¯¦ç»†SQLæ—¥å¿—ï¼ˆå½±å“æ€§èƒ½ï¼‰
> - p6spyæœ‰è½»å¾®æ€§èƒ½æŸè€—ï¼Œç”Ÿäº§ç¯å¢ƒè°¨æ…ä½¿ç”¨
> - Statisticsæ•°æ®è¦å®šæœŸæ¸…ç©ºï¼Œé¿å…å†…å­˜å ç”¨

> ğŸš€ **è¿›é˜¶æ–¹å‘**
> 
> - å­¦ä¹ æ•°æ®åº“æ‰§è¡Œè®¡åˆ’åˆ†æ
> - æŒæ¡APMå·¥å…·ï¼ˆå¦‚SkyWalkingï¼‰
> - ç ”ç©¶æ•°æ®åº“å±‚é¢çš„æ€§èƒ½ä¼˜åŒ–