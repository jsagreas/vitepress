---
title: 71ã€æµ‹è¯•æ•°æ®ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [æµ‹è¯•æ•°æ®ç®¡ç†çš„æ ¸å¿ƒä»·å€¼](#1-æµ‹è¯•æ•°æ®ç®¡ç†çš„æ ¸å¿ƒä»·å€¼)
2. [schema.sqlè¡¨ç»“æ„è„šæœ¬](#2-schemasqlè¡¨ç»“æ„è„šæœ¬)
3. [data.sqlåˆå§‹æ•°æ®](#3-datasqlåˆå§‹æ•°æ®)
4. [@Sqlæ³¨è§£ä½¿ç”¨](#4-sqlæ³¨è§£ä½¿ç”¨)
5. [è¿ç§»è„šæœ¬å¤ç”¨](#5-è¿ç§»è„šæœ¬å¤ç”¨)
6. [åŸºå‡†æ•°æ®è®¾è®¡](#6-åŸºå‡†æ•°æ®è®¾è®¡)
7. [æµ‹è¯•æ•°æ®æ¸…ç†ç­–ç•¥](#7-æµ‹è¯•æ•°æ®æ¸…ç†ç­–ç•¥)
8. [æ•°æ®å·¥å‚æ¨¡å¼](#8-æ•°æ®å·¥å‚æ¨¡å¼)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æµ‹è¯•æ•°æ®ç®¡ç†çš„æ ¸å¿ƒä»·å€¼


### 1.1 ä¸ºä»€ä¹ˆæµ‹è¯•æ•°æ®å¾ˆé‡è¦

**ğŸ’¡ ç®€å•ç†è§£**ï¼šæµ‹è¯•æ•°æ®å°±åƒçƒ¹é¥ªå‰å‡†å¤‡å¥½çš„é£Ÿæ

```
ç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼š
åšèœå‰å‡†å¤‡é£Ÿæ â†’ ç¡®ä¿çƒ¹é¥ªé¡ºåˆ©è¿›è¡Œ
å†™æµ‹è¯•å‰å‡†å¤‡æ•°æ® â†’ ç¡®ä¿æµ‹è¯•æ­£å¸¸è¿è¡Œ

æ²¡æœ‰å‡†å¤‡å¥½æ•°æ®çš„é—®é¢˜ï¼š
- æµ‹è¯•æ— æ³•å¯åŠ¨ï¼ˆç¼ºå°‘å¿…è¦çš„åŸºç¡€æ•°æ®ï¼‰
- æµ‹è¯•ç»“æœä¸ç¨³å®šï¼ˆæ•°æ®çŠ¶æ€ä¸ä¸€è‡´ï¼‰
- æµ‹è¯•ç›¸äº’å¹²æ‰°ï¼ˆå…±äº«æ•°æ®è¢«ä¿®æ”¹ï¼‰
```

### 1.2 æµ‹è¯•æ•°æ®ç®¡ç†çš„æ ¸å¿ƒç›®æ ‡

**ğŸ”¸ ä¸‰å¤§æ ¸å¿ƒç›®æ ‡**

```
1ï¸âƒ£ éš”ç¦»æ€§ï¼ˆIsolationï¼‰
   æ¯ä¸ªæµ‹è¯•éƒ½æœ‰ç‹¬ç«‹çš„æ•°æ®
   æµ‹è¯•ä¹‹é—´äº’ä¸å¹²æ‰°
   å°±åƒæ¯ä¸ªå¨å¸ˆæœ‰è‡ªå·±çš„é£Ÿæå°

2ï¸âƒ£ å¯é‡å¤æ€§ï¼ˆRepeatabilityï¼‰
   ç›¸åŒçš„æµ‹è¯•æ€»æ˜¯å¾—åˆ°ç›¸åŒçš„ç»“æœ
   æ•°æ®çŠ¶æ€å¯ä»¥é‡ç½®
   å°±åƒæ¯æ¬¡åšèœéƒ½ä»æ–°é²œé£Ÿæå¼€å§‹

3ï¸âƒ£ çœŸå®æ€§ï¼ˆRealismï¼‰
   æµ‹è¯•æ•°æ®è¦æ¨¡æ‹ŸçœŸå®ä¸šåŠ¡åœºæ™¯
   è¦†ç›–å„ç§è¾¹ç•Œæƒ…å†µ
   å°±åƒé£Ÿæè¦ç¬¦åˆçœŸå®çƒ¹é¥ªéœ€æ±‚
```

### 1.3 æµ‹è¯•æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸ

**ğŸ“Š æ•°æ®åœ¨æµ‹è¯•ä¸­çš„æµè½¬è¿‡ç¨‹**

```
æµ‹è¯•æ•°æ®ç”Ÿå‘½å‘¨æœŸï¼š

å‡†å¤‡é˜¶æ®µï¼ˆSetupï¼‰
  â†“
åˆ›å»ºåŸºç¡€æ•°æ® â†’ åˆ›å»ºæµ‹è¯•æ•°æ®
  â†“              â†“
æ‰§è¡Œæµ‹è¯•ï¼ˆExecuteï¼‰
  â†“
éªŒè¯ç»“æœï¼ˆVerifyï¼‰
  â†“
æ¸…ç†æ•°æ®ï¼ˆCleanupï¼‰
  â†“
æ¢å¤åˆå§‹çŠ¶æ€ï¼ˆResetï¼‰
```

---

## 2. ğŸ“ schema.sqlè¡¨ç»“æ„è„šæœ¬


### 2.1 ä»€ä¹ˆæ˜¯schema.sql

**ğŸ”¸ è¡¨ç»“æ„è„šæœ¬çš„ä½œç”¨**

```
schema.sqlå°±åƒå»ºç­‘å›¾çº¸ï¼š
- å®šä¹‰æ•°æ®åº“çš„è¡¨ç»“æ„
- è®¾ç½®å­—æ®µç±»å‹å’Œçº¦æŸ
- å»ºç«‹è¡¨ä¹‹é—´çš„å…³ç³»

ä¸ºä»€ä¹ˆéœ€è¦schema.sqlï¼š
âœ… æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨å»ºè¡¨
âœ… ç¡®ä¿è¡¨ç»“æ„ä¸€è‡´æ€§
âœ… ç‹¬ç«‹äºJPAè‡ªåŠ¨å»ºè¡¨
âœ… ç‰ˆæœ¬æ§åˆ¶å‹å¥½
```

### 2.2 schema.sqlæ–‡ä»¶ç»“æ„

**ğŸ“‹ æ ‡å‡†çš„è¡¨ç»“æ„è„šæœ¬**

```sql
-- src/test/resources/schema.sql

-- æ¸…ç†å·²æœ‰è¡¨ï¼ˆå¯é€‰ï¼Œç¡®ä¿å¹²å‡€ç¯å¢ƒï¼‰
DROP TABLE IF EXISTS order_item;
DROP TABLE IF EXISTS orders;
DROP TABLE IF EXISTS user;

-- åˆ›å»ºç”¨æˆ·è¡¨
CREATE TABLE user (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL,
    age INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- åˆ›å»ºè®¢å•è¡¨
CREATE TABLE orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    order_no VARCHAR(50) NOT NULL UNIQUE,
    user_id BIGINT NOT NULL,
    total_amount DECIMAL(10, 2) NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES user(id)
);

-- åˆ›å»ºè®¢å•é¡¹è¡¨
CREATE TABLE order_item (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    order_id BIGINT NOT NULL,
    product_name VARCHAR(100) NOT NULL,
    quantity INT NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
);

-- åˆ›å»ºç´¢å¼•æé«˜æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_user_username ON user(username);
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
```

**ğŸ’¡ å…³é”®ç‚¹è§£é‡Š**

```
DROP TABLE IF EXISTSï¼š
â†’ å…ˆåˆ é™¤å·²æœ‰è¡¨ï¼Œç¡®ä¿æ¯æ¬¡éƒ½æ˜¯å¹²å‡€çš„å¼€å§‹
â†’ æ³¨æ„åˆ é™¤é¡ºåºï¼šå…ˆåˆ å­è¡¨ï¼Œå†åˆ çˆ¶è¡¨

å­—æ®µç±»å‹é€‰æ‹©ï¼š
â†’ VARCHARï¼šå­˜å‚¨å¯å˜é•¿åº¦æ–‡æœ¬
â†’ DECIMALï¼šå­˜å‚¨ç²¾ç¡®çš„é‡‘é¢
â†’ TIMESTAMPï¼šè®°å½•æ—¶é—´ä¿¡æ¯

çº¦æŸè®¾ç½®ï¼š
â†’ PRIMARY KEYï¼šä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†æ¯æ¡è®°å½•
â†’ FOREIGN KEYï¼šå¤–é”®ï¼Œå»ºç«‹è¡¨ä¹‹é—´å…³ç³»
â†’ UNIQUEï¼šç¡®ä¿å­—æ®µå€¼å”¯ä¸€
â†’ NOT NULLï¼šå­—æ®µä¸èƒ½ä¸ºç©º
```

### 2.3 Spring Bootè‡ªåŠ¨åŠ è½½é…ç½®

**âš™ï¸ è®©Springè‡ªåŠ¨æ‰§è¡Œè„šæœ¬**

```yaml
# src/test/resources/application-test.yml

spring:
  datasource:
    # ä½¿ç”¨å†…å­˜æ•°æ®åº“H2
    url: jdbc:h2:mem:testdb
    driver-class-name: org.h2.Driver
    username: sa
    password: 
    
  jpa:
    # ç¦ç”¨Hibernateè‡ªåŠ¨å»ºè¡¨ï¼Œä½¿ç”¨æˆ‘ä»¬çš„schema.sql
    hibernate:
      ddl-auto: none
    show-sql: true
    
  sql:
    init:
      # æŒ‡å®šè¡¨ç»“æ„è„šæœ¬
      schema-locations: classpath:schema.sql
      # æŒ‡å®šåˆå§‹æ•°æ®è„šæœ¬
      data-locations: classpath:data.sql
      # æ€»æ˜¯æ‰§è¡Œè„šæœ¬ï¼ˆæ¯æ¬¡æµ‹è¯•éƒ½é‡æ–°åˆå§‹åŒ–ï¼‰
      mode: always
```

**ğŸ” é…ç½®é¡¹è¯¦è§£**

```
ddl-auto: none
â†’ å…³é—­Hibernateè‡ªåŠ¨å»ºè¡¨
â†’ ä½¿ç”¨æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„schema.sql
â†’ æ›´å¯æ§ï¼Œé¿å…è¡¨ç»“æ„ä¸ä¸€è‡´

mode: always
â†’ æ¯æ¬¡å¯åŠ¨éƒ½æ‰§è¡Œè„šæœ¬
â†’ ç¡®ä¿æµ‹è¯•ç¯å¢ƒå¹²å‡€
â†’ å¼€å‘ç¯å¢ƒå¯ä»¥ç”¨embeddedï¼ˆä»…åµŒå…¥å¼æ•°æ®åº“ï¼‰
```

---

## 3. ğŸ’¾ data.sqlåˆå§‹æ•°æ®


### 3.1 åˆå§‹æ•°æ®çš„ä½œç”¨

**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦é¢„ç½®æ•°æ®**

```
data.sqlå°±åƒä»“åº“çš„åº“å­˜ï¼š
- æä¾›æµ‹è¯•çš„åŸºç¡€æ•°æ®
- æ¨¡æ‹ŸçœŸå®ä¸šåŠ¡çŠ¶æ€
- æ”¯æŒä¸åŒæµ‹è¯•åœºæ™¯

å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š
ğŸ“Œ åŸºç¡€é…ç½®æ•°æ®ï¼ˆç³»ç»Ÿå‚æ•°ã€å­—å…¸è¡¨ï¼‰
ğŸ“Œ æµ‹è¯•è´¦å·æ•°æ®ï¼ˆç®¡ç†å‘˜ã€æ™®é€šç”¨æˆ·ï¼‰
ğŸ“Œ å…³è”æ•°æ®ï¼ˆæµ‹è¯•éœ€è¦çš„å…³è”è®°å½•ï¼‰
```

### 3.2 data.sqlç¼–å†™å®è·µ

**ğŸ“ æ ‡å‡†çš„åˆå§‹æ•°æ®è„šæœ¬**

```sql
-- src/test/resources/data.sql

-- æ’å…¥æµ‹è¯•ç”¨æˆ·
INSERT INTO user (id, username, email, age) VALUES
(1, 'admin', 'admin@test.com', 30),
(2, 'zhangsan', 'zhangsan@test.com', 25),
(3, 'lisi', 'lisi@test.com', 28);

-- æ’å…¥æµ‹è¯•è®¢å•
INSERT INTO orders (id, order_no, user_id, total_amount, status) VALUES
(1, 'ORD20240101001', 1, 299.99, 'PAID'),
(2, 'ORD20240101002', 2, 159.50, 'PENDING'),
(3, 'ORD20240101003', 2, 89.00, 'CANCELLED');

-- æ’å…¥è®¢å•é¡¹
INSERT INTO order_item (order_id, product_name, quantity, price) VALUES
(1, 'ç¬”è®°æœ¬ç”µè„‘', 1, 299.99),
(2, 'é¼ æ ‡', 2, 79.75),
(3, 'é”®ç›˜', 1, 89.00);
```

**ğŸ’¡ ç¼–å†™æŠ€å·§**

```
æŒ‡å®šIDå€¼çš„å¥½å¤„ï¼š
â†’ æµ‹è¯•æ—¶å¯ä»¥ç²¾ç¡®å¼•ç”¨æ•°æ®
â†’ å¤šä¸ªè„šæœ¬ä¹‹é—´å…³è”æ¸…æ™°
â†’ ä¾¿äºè°ƒè¯•å’Œé—®é¢˜å®šä½

æ•°æ®è¦†ç›–è€ƒè™‘ï¼š
âœ… æ­£å¸¸æ•°æ®ï¼šéªŒè¯å¸¸è§„ä¸šåŠ¡é€»è¾‘
âœ… è¾¹ç•Œæ•°æ®ï¼šæµ‹è¯•æç«¯æƒ…å†µ
âœ… å¼‚å¸¸æ•°æ®ï¼šæµ‹è¯•é”™è¯¯å¤„ç†
```

### 3.3 æ•°æ®è„šæœ¬çš„æ‰§è¡Œé¡ºåº

**â° ç†è§£è„šæœ¬æ‰§è¡Œæ—¶æœº**

```
Spring Bootå¯åŠ¨æµç¨‹ï¼š

1. åˆ›å»ºæ•°æ®æºï¼ˆDataSourceï¼‰
   â†“
2. æ‰§è¡Œschema.sqlï¼ˆå»ºè¡¨ï¼‰
   â†“
3. æ‰§è¡Œdata.sqlï¼ˆæ’å…¥æ•°æ®ï¼‰
   â†“
4. åˆå§‹åŒ–JPAï¼ˆEntityManagerFactoryï¼‰
   â†“
5. åº”ç”¨å°±ç»ªï¼Œå¯ä»¥è¿è¡Œæµ‹è¯•
```

**âš ï¸ å¸¸è§é™·é˜±**

```
é—®é¢˜ï¼šå¤–é”®çº¦æŸè¿å
åŸå› ï¼šæ’å…¥é¡ºåºé”™è¯¯ï¼Œå…ˆæ’å…¥å­è¡¨æ•°æ®
è§£å†³ï¼šå…ˆæ’å…¥çˆ¶è¡¨ï¼ˆuserï¼‰ï¼Œå†æ’å…¥å­è¡¨ï¼ˆordersï¼‰

é—®é¢˜ï¼šä¸»é”®å†²çª
åŸå› ï¼šJPAè‡ªå¢IDä¸data.sqlçš„IDé‡å¤
è§£å†³ï¼šåœ¨data.sqlä¸­ä½¿ç”¨è¶³å¤Ÿå¤§çš„IDï¼ˆå¦‚ä»1000å¼€å§‹ï¼‰
      æˆ–è€…ä½¿ç”¨UUIDç­–ç•¥
```

---

## 4. ğŸ”§ @Sqlæ³¨è§£ä½¿ç”¨


### 4.1 @Sqlæ³¨è§£çš„åŸºæœ¬æ¦‚å¿µ

**ğŸ¯ æ›´çµæ´»çš„æ•°æ®å‡†å¤‡æ–¹å¼**

```
@Sqlæ³¨è§£å°±åƒé¥æ§å™¨ï¼š
- å¯ä»¥åœ¨æµ‹è¯•æ–¹æ³•ä¸Šç²¾ç¡®æ§åˆ¶æ•°æ®
- æ”¯æŒæ‰§è¡Œç‰¹å®šçš„SQLè„šæœ¬
- æ¯”å…¨å±€çš„data.sqlæ›´çµæ´»

ä½¿ç”¨æ—¶æœºï¼š
ğŸ”¸ ä¸åŒæµ‹è¯•éœ€è¦ä¸åŒçš„åˆå§‹æ•°æ®
ğŸ”¸ éœ€è¦åœ¨æµ‹è¯•å‰åæ‰§è¡Œç‰¹å®šSQL
ğŸ”¸ éœ€è¦æ¸…ç†æˆ–é‡ç½®æ•°æ®
```

### 4.2 @Sqlæ³¨è§£çš„åŸºæœ¬ç”¨æ³•

**ğŸ“Œ åœ¨æµ‹è¯•ä¸­ä½¿ç”¨@Sql**

```java
import org.springframework.test.context.jdbc.Sql;

@SpringBootTest
@Transactional
public class OrderServiceTest {
    
    @Autowired
    private OrderService orderService;
    
    // åœ¨æµ‹è¯•æ–¹æ³•æ‰§è¡Œå‰è¿è¡ŒSQLè„šæœ¬
    @Test
    @Sql("/test-data/init-orders.sql")
    public void testFindOrdersByUserId() {
        List<Order> orders = orderService.findByUserId(1L);
        assertThat(orders).hasSize(2);
    }
    
    // æ‰§è¡Œå¤šä¸ªè„šæœ¬
    @Test
    @Sql({
        "/test-data/init-users.sql",
        "/test-data/init-orders.sql"
    })
    public void testComplexScenario() {
        // æµ‹è¯•é€»è¾‘
    }
    
    // æµ‹è¯•åæ¸…ç†æ•°æ®
    @Test
    @Sql("/test-data/init-data.sql")
    @Sql(
        scripts = "/test-data/cleanup.sql",
        executionPhase = Sql.ExecutionPhase.AFTER_TEST_METHOD
    )
    public void testWithCleanup() {
        // æµ‹è¯•é€»è¾‘
        // æµ‹è¯•åè‡ªåŠ¨æ‰§è¡Œcleanup.sql
    }
}
```

**ğŸ” å…³é”®å±æ€§è¯´æ˜**

```
executionPhaseï¼ˆæ‰§è¡Œæ—¶æœºï¼‰ï¼š
â†’ BEFORE_TEST_METHODï¼šæµ‹è¯•å‰æ‰§è¡Œï¼ˆé»˜è®¤ï¼‰
â†’ AFTER_TEST_METHODï¼šæµ‹è¯•åæ‰§è¡Œ

configï¼ˆé…ç½®ï¼‰ï¼š
â†’ encodingï¼šè„šæœ¬ç¼–ç 
â†’ separatorï¼šSQLè¯­å¥åˆ†éš”ç¬¦
â†’ commentPrefixï¼šæ³¨é‡Šå‰ç¼€
```

### 4.3 ç±»çº§åˆ«çš„@Sqlæ³¨è§£

**ğŸ“¦ ä¸ºæ•´ä¸ªæµ‹è¯•ç±»å‡†å¤‡æ•°æ®**

```java
// ä¸ºæ•´ä¸ªæµ‹è¯•ç±»å‡†å¤‡åŸºç¡€æ•°æ®
@SpringBootTest
@Sql("/test-data/base-data.sql")
public class UserServiceTest {
    
    // è¿™ä¸ªæµ‹è¯•ä¼šä½¿ç”¨base-data.sqlçš„æ•°æ®
    @Test
    public void testFindUser() {
        // æµ‹è¯•é€»è¾‘
    }
    
    // è¿™ä¸ªæµ‹è¯•ä¹Ÿä¼šä½¿ç”¨base-data.sqlçš„æ•°æ®
    @Test
    public void testUpdateUser() {
        // æµ‹è¯•é€»è¾‘
    }
    
    // è¿™ä¸ªæµ‹è¯•é™¤äº†base-data.sqlï¼Œè¿˜ä¼šåŠ è½½é¢å¤–æ•°æ®
    @Test
    @Sql("/test-data/extra-users.sql")
    public void testSpecialCase() {
        // æµ‹è¯•é€»è¾‘
    }
}
```

### 4.4 @SqlConfigé«˜çº§é…ç½®

**âš™ï¸ ç²¾ç»†æ§åˆ¶SQLæ‰§è¡Œ**

```java
@SpringBootTest
public class AdvancedSqlTest {
    
    @Test
    @Sql(
        scripts = "/test-data/chinese-data.sql",
        config = @SqlConfig(
            encoding = "UTF-8",              // æŒ‡å®šç¼–ç 
            separator = ";",                 // SQLåˆ†éš”ç¬¦
            commentPrefix = "--",            // æ³¨é‡Šå‰ç¼€
            blockCommentStartDelimiter = "/*", 
            blockCommentEndDelimiter = "*/",
            errorMode = SqlConfig.ErrorMode.FAIL_ON_ERROR // é‡é”™å³åœ
        )
    )
    public void testWithCustomConfig() {
        // æµ‹è¯•é€»è¾‘
    }
}
```

**ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯**

| åœºæ™¯ | **é…ç½®æ–¹æ¡ˆ** | **è¯´æ˜** |
|------|-------------|---------|
| ğŸ”¸ **åŒ…å«ä¸­æ–‡æ•°æ®** | `encoding = "UTF-8"` | é˜²æ­¢ä¸­æ–‡ä¹±ç  |
| ğŸ”¸ **å­˜å‚¨è¿‡ç¨‹è„šæœ¬** | `separator = "$$"` | æ”¯æŒå¤æ‚SQL |
| ğŸ”¸ **å¿½ç•¥SQLé”™è¯¯** | `errorMode = CONTINUE_ON_ERROR` | éƒ¨åˆ†å¤±è´¥ç»§ç»­æ‰§è¡Œ |
| ğŸ”¸ **å¤§æ‰¹é‡æ•°æ®** | `transactionMode = ISOLATED` | ç‹¬ç«‹äº‹åŠ¡æ‰§è¡Œ |

---

## 5. ğŸ”„ è¿ç§»è„šæœ¬å¤ç”¨


### 5.1 ä»€ä¹ˆæ˜¯è¿ç§»è„šæœ¬

**ğŸ¯ æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†å·¥å…·**

```
è¿ç§»è„šæœ¬å°±åƒè½¯ä»¶çš„ç‰ˆæœ¬æ›´æ–°ï¼š
- è®°å½•æ•°æ®åº“ç»“æ„çš„æ¯æ¬¡å˜æ›´
- æ”¯æŒç‰ˆæœ¬å›æ»š
- ä¿è¯å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒä¸€è‡´

å¸¸ç”¨å·¥å…·ï¼š
ğŸ“Œ Flywayï¼šç®€å•æ˜“ç”¨ï¼ŒåŠŸèƒ½å¼ºå¤§
ğŸ“Œ Liquibaseï¼šåŠŸèƒ½å…¨é¢ï¼Œæ”¯æŒå¤šç§æ ¼å¼
```

### 5.2 Flywayè¿ç§»è„šæœ¬ç»“æ„

**ğŸ“‚ æ ‡å‡†çš„Flywayè„šæœ¬ç»„ç»‡**

```
é¡¹ç›®ç»“æ„ï¼š
src/
â”œâ”€â”€ main/
â”‚   â””â”€â”€ resources/
â”‚       â””â”€â”€ db/migration/
â”‚           â”œâ”€â”€ V1__create_user_table.sql
â”‚           â”œâ”€â”€ V2__create_order_table.sql
â”‚           â””â”€â”€ V3__add_user_age_column.sql
â””â”€â”€ test/
    â””â”€â”€ resources/
        â””â”€â”€ db/migration/
            â””â”€â”€ V99__test_data.sql
```

**å‘½åè§„èŒƒè§£é‡Š**

```
V{version}__{description}.sql

ç»„æˆéƒ¨åˆ†ï¼š
â†’ Vï¼šå›ºå®šå‰ç¼€ï¼Œè¡¨ç¤ºç‰ˆæœ¬è„šæœ¬
â†’ versionï¼šç‰ˆæœ¬å·ï¼ˆ1, 2, 3...æˆ–1.1, 1.2ï¼‰
â†’ __ï¼šåŒä¸‹åˆ’çº¿åˆ†éš”ç¬¦
â†’ descriptionï¼šæè¿°ä¿¡æ¯ï¼ˆç”¨ä¸‹åˆ’çº¿è¿æ¥ï¼‰

ç¤ºä¾‹ï¼š
V1__create_user_table.sql    â†’ ç‰ˆæœ¬1ï¼šåˆ›å»ºç”¨æˆ·è¡¨
V2.1__add_index.sql          â†’ ç‰ˆæœ¬2.1ï¼šæ·»åŠ ç´¢å¼•
V10__refactor_schema.sql     â†’ ç‰ˆæœ¬10ï¼šé‡æ„è¡¨ç»“æ„
```

### 5.3 æµ‹è¯•ç¯å¢ƒå¤ç”¨è¿ç§»è„šæœ¬

**â™»ï¸ å…±äº«ç”Ÿäº§ç¯å¢ƒçš„è¡¨ç»“æ„**

```yaml
# application-test.yml

spring:
  flyway:
    enabled: true
    # å¤ç”¨ç”Ÿäº§ç¯å¢ƒçš„è¿ç§»è„šæœ¬
    locations: 
      - classpath:db/migration
      # é¢å¤–çš„æµ‹è¯•æ•°æ®è„šæœ¬
      - classpath:db/testdata
    # æµ‹è¯•ç¯å¢ƒå…è®¸æ¸…ç†æ•°æ®åº“
    clean-disabled: false
    # åŸºçº¿ç‰ˆæœ¬ï¼Œä»æ­¤ç‰ˆæœ¬å¼€å§‹æ‰§è¡Œ
    baseline-version: 1
    baseline-on-migrate: true
```

**ğŸ“‹ æµ‹è¯•æ•°æ®è¿ç§»è„šæœ¬**

```sql
-- db/testdata/V99__test_data.sql
-- ä½¿ç”¨é«˜ç‰ˆæœ¬å·é¿å…ä¸ç”Ÿäº§è„šæœ¬å†²çª

-- æµ‹è¯•ç”¨æˆ·æ•°æ®
INSERT INTO user (username, email, age) VALUES
('test_admin', 'admin@test.com', 30),
('test_user1', 'user1@test.com', 25),
('test_user2', 'user2@test.com', 28);

-- æµ‹è¯•è®¢å•æ•°æ®
INSERT INTO orders (order_no, user_id, total_amount, status) 
SELECT 
    CONCAT('TEST_', LPAD(seq, 6, '0')),
    MOD(seq, 3) + 1,
    ROUND(RAND() * 1000, 2),
    CASE MOD(seq, 3)
        WHEN 0 THEN 'PAID'
        WHEN 1 THEN 'PENDING'
        ELSE 'CANCELLED'
    END
FROM (SELECT @seq := @seq + 1 AS seq FROM user, (SELECT @seq := 0) init LIMIT 100) t;
```

**ğŸ’¡ å¤ç”¨è¿ç§»è„šæœ¬çš„ä¼˜åŠ¿**

```
ä¸€è‡´æ€§ä¿è¯ï¼š
â†’ æµ‹è¯•ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒè¡¨ç»“æ„å®Œå…¨ä¸€è‡´
â†’ é¿å…å› è¡¨ç»“æ„å·®å¼‚å¯¼è‡´çš„æµ‹è¯•å¤±æ•ˆ
â†’ æ–°å­—æ®µã€æ–°ç´¢å¼•è‡ªåŠ¨åŒæ­¥åˆ°æµ‹è¯•

ç‰ˆæœ¬è¿½è¸ªï¼š
â†’ æ¯æ¬¡å˜æ›´éƒ½æœ‰è®°å½•
â†’ å¯ä»¥å›æ»šåˆ°ä»»æ„ç‰ˆæœ¬
â†’ æ¸…æ™°çš„å˜æ›´å†å²

å›¢é˜Ÿåä½œï¼š
â†’ æ‰€æœ‰æˆå‘˜ä½¿ç”¨ç›¸åŒçš„æ•°æ®åº“ç‰ˆæœ¬
â†’ é¿å…"åœ¨æˆ‘æœºå™¨ä¸Šå¯ä»¥è¿è¡Œ"çš„é—®é¢˜
â†’ ä»£ç å®¡æŸ¥æ—¶èƒ½çœ‹åˆ°æ•°æ®åº“å˜æ›´
```

---

## 6. ğŸ“Š åŸºå‡†æ•°æ®è®¾è®¡


### 6.1 ä»€ä¹ˆæ˜¯åŸºå‡†æ•°æ®

**ğŸ¯ æµ‹è¯•çš„æ•°æ®åŸºç¡€**

```
åŸºå‡†æ•°æ®å°±åƒæ ‡å‡†ç­”æ¡ˆï¼š
- å®šä¹‰æµ‹è¯•çš„é¢„æœŸç»“æœ
- æä¾›å¯¹æ¯”çš„å‚ç…§ç‰©
- ç¡®ä¿æµ‹è¯•çš„å¯é‡å¤æ€§

åŸºå‡†æ•°æ®çš„ç‰¹ç‚¹ï¼š
âœ… ç¨³å®šï¼šä¸éšæµ‹è¯•å˜åŒ–
âœ… å®Œæ•´ï¼šè¦†ç›–ä¸»è¦æµ‹è¯•åœºæ™¯
âœ… çœŸå®ï¼šç¬¦åˆä¸šåŠ¡é€»è¾‘
âœ… ç²¾ç®€ï¼šé¿å…æ•°æ®å†—ä½™
```

### 6.2 åŸºå‡†æ•°æ®çš„è®¾è®¡åŸåˆ™

**ğŸ“ å¦‚ä½•è®¾è®¡å¥½çš„åŸºå‡†æ•°æ®**

```
1ï¸âƒ£ æœ€å°å®Œå¤‡åŸåˆ™
   åªåŒ…å«æµ‹è¯•å¿…éœ€çš„æ•°æ®
   é¿å…è¿‡å¤šæ— å…³æ•°æ®å¹²æ‰°

2ï¸âƒ£ è¾¹ç•Œè¦†ç›–åŸåˆ™
   åŒ…å«æ­£å¸¸ã€è¾¹ç•Œã€å¼‚å¸¸æƒ…å†µ
   
3ï¸âƒ£ å…³è”å®Œæ•´åŸåˆ™
   ä¸»è¡¨å’Œå…³è”è¡¨æ•°æ®è¦åŒ¹é…
   é¿å…å­¤å„¿æ•°æ®

4ï¸âƒ£ å¯è¯»æ€§åŸåˆ™
   æ•°æ®è¦æœ‰æ˜ç¡®å«ä¹‰
   ä¾¿äºç†è§£å’Œç»´æŠ¤
```

**ğŸ“‹ åŸºå‡†æ•°æ®è®¾è®¡ç¤ºä¾‹**

```sql
-- åŸºå‡†ç”¨æˆ·æ•°æ®ï¼šè¦†ç›–ä¸åŒè§’è‰²å’ŒçŠ¶æ€
INSERT INTO user (id, username, email, age, role, status) VALUES
-- æ­£å¸¸ç”¨æˆ·
(1001, 'normal_user', 'normal@test.com', 25, 'USER', 'ACTIVE'),
-- ç®¡ç†å‘˜
(1002, 'admin_user', 'admin@test.com', 30, 'ADMIN', 'ACTIVE'),
-- å·²åˆ é™¤ç”¨æˆ·
(1003, 'deleted_user', 'deleted@test.com', 28, 'USER', 'DELETED'),
-- æœªæ¿€æ´»ç”¨æˆ·
(1004, 'inactive_user', 'inactive@test.com', 22, 'USER', 'INACTIVE'),
-- è¾¹ç•Œæƒ…å†µï¼šå¹´é¾„ä¸ºç©º
(1005, 'boundary_user', 'boundary@test.com', NULL, 'USER', 'ACTIVE');
```

### 6.3 åŸºå‡†æ•°æ®çš„åˆ†ç±»ç®¡ç†

**ğŸ—‚ï¸ æŒ‰åœºæ™¯ç»„ç»‡åŸºå‡†æ•°æ®**

```
æ•°æ®åˆ†ç±»ç­–ç•¥ï¼š

1. æ ¸å¿ƒåŸºå‡†æ•°æ®ï¼ˆå¿…éœ€ï¼‰
   - ç³»ç»ŸåŸºç¡€é…ç½®
   - é»˜è®¤è§’è‰²æƒé™
   - å¿…è¦çš„å­—å…¸æ•°æ®

2. åœºæ™¯åŸºå‡†æ•°æ®ï¼ˆæŒ‰éœ€ï¼‰
   - è®¢å•æµ‹è¯•æ•°æ®é›†
   - ç”¨æˆ·æµ‹è¯•æ•°æ®é›†
   - å•†å“æµ‹è¯•æ•°æ®é›†

3. è¾¹ç•ŒåŸºå‡†æ•°æ®ï¼ˆä¸“é¡¹ï¼‰
   - æå€¼æ•°æ®
   - å¼‚å¸¸æ•°æ®
   - æ€§èƒ½æµ‹è¯•æ•°æ®
```

**ğŸ“‚ æ–‡ä»¶ç»„ç»‡ç¤ºä¾‹**

```
test/resources/testdata/
â”œâ”€â”€ baseline/                    # åŸºå‡†æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒæ•°æ®
â”‚   â”‚   â”œâ”€â”€ system-config.sql
â”‚   â”‚   â””â”€â”€ roles-permissions.sql
â”‚   â”œâ”€â”€ business/               # ä¸šåŠ¡æ•°æ®
â”‚   â”‚   â”œâ”€â”€ users-baseline.sql
â”‚   â”‚   â”œâ”€â”€ orders-baseline.sql
â”‚   â”‚   â””â”€â”€ products-baseline.sql
â”‚   â””â”€â”€ boundary/               # è¾¹ç•Œæ•°æ®
â”‚       â”œâ”€â”€ edge-cases.sql
â”‚       â””â”€â”€ performance-data.sql
â””â”€â”€ scenarios/                   # åœºæ™¯ä¸“ç”¨æ•°æ®
    â”œâ”€â”€ user-registration-scenario.sql
    â””â”€â”€ order-checkout-scenario.sql
```

### 6.4 åŸºå‡†æ•°æ®çš„ç‰ˆæœ¬ç®¡ç†

**ğŸ”– è·Ÿè¸ªåŸºå‡†æ•°æ®å˜åŒ–**

```java
/**
 * åŸºå‡†æ•°æ®ç‰ˆæœ¬æ§åˆ¶
 * é€šè¿‡æ³¨é‡Šè®°å½•æ•°æ®å˜æ›´å†å²
 */
 
-- users-baseline.sql
-- Version: 1.0.0
-- Date: 2024-01-01
-- Description: åˆå§‹ç”¨æˆ·åŸºå‡†æ•°æ®

-- Version: 1.1.0 (2024-02-01)
-- Added: VIPç”¨æˆ·æ•°æ®
INSERT INTO user (id, username, role, vip_level) VALUES
(2001, 'vip_user', 'USER', 'GOLD');

-- Version: 1.2.0 (2024-03-01)
-- Modified: æ·»åŠ ç”¨æˆ·é‚®ç®±å­—æ®µ
UPDATE user SET email = CONCAT(username, '@test.com') 
WHERE email IS NULL;
```

**ğŸ’¡ åŸºå‡†æ•°æ®ç»´æŠ¤å»ºè®®**

```
å®šæœŸå®¡æŸ¥ï¼š
â†’ æ¯ä¸ªè¿­ä»£æ£€æŸ¥åŸºå‡†æ•°æ®æ˜¯å¦éœ€è¦æ›´æ–°
â†’ åˆ é™¤è¿‡æ—¶çš„æµ‹è¯•æ•°æ®
â†’ æ·»åŠ æ–°åŠŸèƒ½çš„åŸºå‡†æ•°æ®

æ–‡æ¡£è®°å½•ï¼š
â†’ è®°å½•æ¯ç»„åŸºå‡†æ•°æ®çš„ç”¨é€”
â†’ è¯´æ˜æ•°æ®é—´çš„å…³è”å…³ç³»
â†’ æ ‡æ³¨ç‰¹æ®Šæ•°æ®çš„å«ä¹‰

å›¢é˜Ÿå…±è¯†ï¼š
â†’ ç»Ÿä¸€åŸºå‡†æ•°æ®çš„å‘½åè§„èŒƒ
â†’ æ˜ç¡®æ•°æ®çš„ç»´æŠ¤è´£ä»»
â†’ å®šæœŸåŒæ­¥æ•°æ®å˜æ›´
```

---

## 7. ğŸ§¹ æµ‹è¯•æ•°æ®æ¸…ç†ç­–ç•¥


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦æ¸…ç†æµ‹è¯•æ•°æ®

**ğŸ¯ æ¸…ç†çš„é‡è¦æ€§**

```
æµ‹è¯•æ•°æ®å°±åƒå¨æˆ¿å°é¢ï¼š
- ç”¨å®Œè¦æ¸…ç†å¹²å‡€
- ä¸‹æ¬¡ä½¿ç”¨æ‰é¡ºç•…
- é¿å…æ®‹ç•™ç‰©æ±¡æŸ“

ä¸æ¸…ç†çš„é—®é¢˜ï¼š
âŒ æµ‹è¯•æ•°æ®ç´¯ç§¯å½±å“æ€§èƒ½
âŒ è„æ•°æ®å¯¼è‡´æµ‹è¯•å¤±è´¥
âŒ æ•°æ®å†²çªï¼ˆä¸»é”®ã€å”¯ä¸€ç´¢å¼•ï¼‰
âŒ å†…å­˜æº¢å‡ºï¼ˆå†…å­˜æ•°æ®åº“ï¼‰
```

### 7.2 Spring Testçš„è‡ªåŠ¨å›æ»š

**â™»ï¸ æœ€ç®€å•çš„æ¸…ç†æ–¹å¼**

```java
@SpringBootTest
@Transactional  // å…³é”®æ³¨è§£ï¼šæµ‹è¯•æ–¹æ³•åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
public class UserServiceTest {
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    public void testSaveUser() {
        User user = new User("test", "test@example.com");
        userRepository.save(user);
        
        // æµ‹è¯•ç»“æŸåï¼Œ@Transactionalä¼šè‡ªåŠ¨å›æ»š
        // æ•°æ®åº“æ¢å¤åˆ°æµ‹è¯•å‰çš„çŠ¶æ€
    }
}
```

**ğŸ” è‡ªåŠ¨å›æ»šçš„åŸç†**

```
äº‹åŠ¡å›æ»šæœºåˆ¶ï¼š

1. æµ‹è¯•å¼€å§‹å‰ï¼šå¼€å¯äº‹åŠ¡
   â†“
2. æ‰§è¡Œæµ‹è¯•æ–¹æ³•ï¼šåœ¨äº‹åŠ¡ä¸­æ“ä½œæ•°æ®
   â†“
3. æµ‹è¯•ç»“æŸåï¼šå›æ»šäº‹åŠ¡
   â†“
4. æ•°æ®åº“æ¢å¤åˆ°æµ‹è¯•å‰çŠ¶æ€
```

**âš ï¸ è‡ªåŠ¨å›æ»šçš„å±€é™**

```
ä¸é€‚ç”¨çš„åœºæ™¯ï¼š

1. æµ‹è¯•äº‹åŠ¡æäº¤é€»è¾‘
   @Transactionalä¼šå¹²æ‰°ä¸šåŠ¡äº‹åŠ¡
   
2. æµ‹è¯•å¼‚æ­¥æ“ä½œ
   å¼‚æ­¥çº¿ç¨‹ä¸åœ¨åŒä¸€äº‹åŠ¡ä¸­
   
3. æµ‹è¯•éJPAæ“ä½œ
   JDBCæ¨¡æ¿çš„æŸäº›æ“ä½œå¯èƒ½ä¸å›æ»š

è§£å†³æ–¹æ¡ˆï¼š
â†’ ä½¿ç”¨@Rollback(false)ç¦ç”¨å›æ»š
â†’ æ‰‹åŠ¨æ¸…ç†æ•°æ®
â†’ ä½¿ç”¨@Sqlçš„AFTER_TEST_METHOD
```

### 7.3 æ‰‹åŠ¨æ¸…ç†ç­–ç•¥

**ğŸ”§ çµæ´»çš„æ•°æ®æ¸…ç†æ–¹æ³•**

```java
@SpringBootTest
public class ManualCleanupTest {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private OrderRepository orderRepository;
    
    @AfterEach
    public void cleanup() {
        // æ¸…ç†é¡ºåºï¼šå…ˆæ¸…ç†å­è¡¨ï¼Œå†æ¸…ç†çˆ¶è¡¨
        orderRepository.deleteAll();
        userRepository.deleteAll();
        
        // æˆ–è€…ä½¿ç”¨åŸç”ŸSQLæ‰¹é‡åˆ é™¤
        entityManager.createNativeQuery("DELETE FROM order_item").executeUpdate();
        entityManager.createNativeQuery("DELETE FROM orders").executeUpdate();
        entityManager.createNativeQuery("DELETE FROM user").executeUpdate();
    }
    
    @Test
    public void testCreateOrder() {
        // æµ‹è¯•é€»è¾‘
        // cleanup()ä¼šåœ¨æµ‹è¯•åè‡ªåŠ¨æ‰§è¡Œ
    }
}
```

### 7.4 SQLè„šæœ¬æ¸…ç†

**ğŸ“ ä½¿ç”¨ä¸“é—¨çš„æ¸…ç†è„šæœ¬**

```sql
-- test/resources/cleanup.sql
-- æ¸…ç†æµ‹è¯•æ•°æ®çš„SQLè„šæœ¬

-- ç¦ç”¨å¤–é”®æ£€æŸ¥ï¼ˆMySQLï¼‰
SET FOREIGN_KEY_CHECKS = 0;

-- åˆ é™¤æ‰€æœ‰æ•°æ®
TRUNCATE TABLE order_item;
TRUNCATE TABLE orders;
TRUNCATE TABLE user;

-- é‡ç½®è‡ªå¢ID
ALTER TABLE user AUTO_INCREMENT = 1;
ALTER TABLE orders AUTO_INCREMENT = 1;
ALTER TABLE order_item AUTO_INCREMENT = 1;

-- å¯ç”¨å¤–é”®æ£€æŸ¥
SET FOREIGN_KEY_CHECKS = 1;
```

**ä½¿ç”¨æ¸…ç†è„šæœ¬**

```java
@SpringBootTest
public class SqlCleanupTest {
    
    @Test
    @Sql("/test-data/init-data.sql")  // æµ‹è¯•å‰å‡†å¤‡æ•°æ®
    @Sql(
        scripts = "/cleanup.sql",      // æµ‹è¯•åæ¸…ç†æ•°æ®
        executionPhase = Sql.ExecutionPhase.AFTER_TEST_METHOD
    )
    public void testWithSqlCleanup() {
        // æµ‹è¯•é€»è¾‘
    }
}
```

### 7.5 æ•°æ®åº“çº§åˆ«çš„æ¸…ç†

**ğŸ’¾ é‡ç½®æ•´ä¸ªæ•°æ®åº“**

```java
@SpringBootTest
@DirtiesContext(classMode = DirtiesContext.ClassMode.AFTER_EACH_TEST_METHOD)
public class DatabaseResetTest {
    
    // @DirtiesContextä¼šåœ¨æ¯ä¸ªæµ‹è¯•åé‡æ–°åŠ è½½Springä¸Šä¸‹æ–‡
    // åŒ…æ‹¬é‡å»ºæ•°æ®åº“è¿æ¥å’Œé‡æ–°æ‰§è¡Œschema.sqlã€data.sql
    
    @Test
    public void test1() {
        // æµ‹è¯•åæ•°æ®åº“ä¼šå®Œå…¨é‡ç½®
    }
    
    @Test
    public void test2() {
        // ä½¿ç”¨å…¨æ–°çš„æ•°æ®åº“çŠ¶æ€
    }
}
```

**âš ï¸ æ€§èƒ½è€ƒè™‘**

```
@DirtiesContextçš„ä»£ä»·ï¼š
â†’ é‡å»ºSpringä¸Šä¸‹æ–‡è€—æ—¶è¾ƒé•¿
â†’ æ¯ä¸ªæµ‹è¯•éƒ½é‡æ–°åˆå§‹åŒ–æ•°æ®åº“
â†’ é€‚åˆé›†æˆæµ‹è¯•ï¼Œä¸é€‚åˆå•å…ƒæµ‹è¯•

ä¼˜åŒ–å»ºè®®ï¼š
â†’ ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨
â†’ è€ƒè™‘ä½¿ç”¨@Transactionalæ›¿ä»£
â†’ åˆå¹¶ç›¸å…³æµ‹è¯•åˆ°ä¸€ä¸ªç±»ä¸­
```

---

## 8. ğŸ­ æ•°æ®å·¥å‚æ¨¡å¼


### 8.1 ä»€ä¹ˆæ˜¯æ•°æ®å·¥å‚æ¨¡å¼

**ğŸ¯ æµ‹è¯•æ•°æ®çš„è®¾è®¡æ¨¡å¼**

```
æ•°æ®å·¥å‚å°±åƒç”Ÿäº§çº¿ï¼š
- æ ‡å‡†åŒ–åˆ›å»ºæµ‹è¯•å¯¹è±¡
- å‡å°‘é‡å¤ä»£ç 
- æé«˜æ•°æ®å¯ç»´æŠ¤æ€§

å¯¹æ¯”ç†è§£ï¼š
âŒ æ¯ä¸ªæµ‹è¯•éƒ½æ‰‹åŠ¨åˆ›å»ºæ•°æ® â†’ ä»£ç é‡å¤ï¼Œéš¾ä»¥ç»´æŠ¤
âœ… ä½¿ç”¨å·¥å‚ç»Ÿä¸€åˆ›å»ºæ•°æ® â†’ ä»£ç å¤ç”¨ï¼Œæ˜“äºä¿®æ”¹
```

### 8.2 ç®€å•çš„æ•°æ®å·¥å‚å®ç°

**ğŸ”¨ åŸºç¡€ç‰ˆæœ¬çš„å·¥å‚ç±»**

```java
/**
 * ç”¨æˆ·æ•°æ®å·¥å‚
 * æä¾›åˆ›å»ºæµ‹è¯•ç”¨æˆ·çš„ä¾¿æ·æ–¹æ³•
 */
public class UserFactory {
    
    private static long idCounter = 1000L;
    
    // åˆ›å»ºé»˜è®¤ç”¨æˆ·
    public static User createUser() {
        return User.builder()
                .id(idCounter++)
                .username("user_" + idCounter)
                .email("user" + idCounter + "@test.com")
                .age(25)
                .role("USER")
                .build();
    }
    
    // åˆ›å»ºæŒ‡å®šç”¨æˆ·åçš„ç”¨æˆ·
    public static User createUser(String username) {
        return User.builder()
                .id(idCounter++)
                .username(username)
                .email(username + "@test.com")
                .age(25)
                .role("USER")
                .build();
    }
    
    // åˆ›å»ºç®¡ç†å‘˜
    public static User createAdmin() {
        return User.builder()
                .id(idCounter++)
                .username("admin_" + idCounter)
                .email("admin" + idCounter + "@test.com")
                .age(30)
                .role("ADMIN")
                .build();
    }
    
    // åˆ›å»ºæ‰¹é‡ç”¨æˆ·
    public static List<User> createUsers(int count) {
        List<User> users = new ArrayList<>();
        for (int i = 0; i < count; i++) {
            users.add(createUser());
        }
        return users;
    }
}
```

**ä½¿ç”¨æ•°æ®å·¥å‚**

```java
@SpringBootTest
public class UserServiceTest {
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    public void testSaveUser() {
        // ä½¿ç”¨å·¥å‚åˆ›å»ºæµ‹è¯•æ•°æ®ï¼Œç®€æ´æ˜äº†
        User user = UserFactory.createUser("zhangsan");
        userRepository.save(user);
        
        assertThat(user.getId()).isNotNull();
    }
    
    @Test
    public void testBatchSave() {
        // æ‰¹é‡åˆ›å»ºæµ‹è¯•æ•°æ®
        List<User> users = UserFactory.createUsers(10);
        userRepository.saveAll(users);
        
        assertThat(userRepository.count()).isEqualTo(10);
    }
}
```

### 8.3 Builderæ¨¡å¼çš„æ•°æ®å·¥å‚

**ğŸ—ï¸ æ›´çµæ´»çš„æ„é€ æ–¹å¼**

```java
/**
 * è®¢å•æ•°æ®æ„é€ å™¨
 * æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œçµæ´»è®¾ç½®å±æ€§
 */
public class OrderTestBuilder {
    
    private Order order;
    
    private OrderTestBuilder() {
        this.order = new Order();
        // è®¾ç½®é»˜è®¤å€¼
        this.order.setOrderNo("TEST_" + System.currentTimeMillis());
        this.order.setStatus("PENDING");
        this.order.setTotalAmount(BigDecimal.ZERO);
    }
    
    public static OrderTestBuilder anOrder() {
        return new OrderTestBuilder();
    }
    
    public OrderTestBuilder withOrderNo(String orderNo) {
        this.order.setOrderNo(orderNo);
        return this;
    }
    
    public OrderTestBuilder withUser(User user) {
        this.order.setUser(user);
        this.order.setUserId(user.getId());
        return this;
    }
    
    public OrderTestBuilder withStatus(String status) {
        this.order.setStatus(status);
        return this;
    }
    
    public OrderTestBuilder withTotalAmount(BigDecimal amount) {
        this.order.setTotalAmount(amount);
        return this;
    }
    
    public OrderTestBuilder addItem(String productName, int quantity, BigDecimal price) {
        OrderItem item = new OrderItem();
        item.setProductName(productName);
        item.setQuantity(quantity);
        item.setPrice(price);
        item.setOrder(this.order);
        
        if (this.order.getItems() == null) {
            this.order.setItems(new ArrayList<>());
        }
        this.order.getItems().add(item);
        
        return this;
    }
    
    public Order build() {
        return this.order;
    }
}
```

**Builderæ¨¡å¼çš„ä½¿ç”¨**

```java
@Test
public void testCreateOrder() {
    // é“¾å¼è°ƒç”¨ï¼Œæ¸…æ™°åœ°è¡¨è¾¾æµ‹è¯•æ„å›¾
    User user = UserFactory.createUser("zhangsan");
    
    Order order = OrderTestBuilder.anOrder()
            .withOrderNo("ORD20240101001")
            .withUser(user)
            .withStatus("PAID")
            .withTotalAmount(new BigDecimal("299.99"))
            .addItem("ç¬”è®°æœ¬ç”µè„‘", 1, new BigDecimal("299.99"))
            .build();
    
    orderRepository.save(order);
    
    assertThat(order.getItems()).hasSize(1);
}
```

### 8.4 å®Œæ•´çš„æ•°æ®å·¥å‚ç”Ÿæ€

**ğŸŒ³ ä¼ä¸šçº§æ•°æ®å·¥å‚æ¶æ„**

```java
/**
 * æ•°æ®å·¥å‚ç®¡ç†å™¨
 * ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æµ‹è¯•æ•°æ®çš„åˆ›å»º
 */
public class TestDataFactory {
    
    private EntityManager entityManager;
    
    public TestDataFactory(EntityManager entityManager) {
        this.entityManager = entityManager;
    }
    
    // åˆ›å»ºå®Œæ•´çš„ä¸šåŠ¡åœºæ™¯æ•°æ®
    public OrderScenario createOrderScenario() {
        // åˆ›å»ºç”¨æˆ·
        User user = UserFactory.createUser("customer");
        entityManager.persist(user);
        
        // åˆ›å»ºè®¢å•
        Order order = OrderTestBuilder.anOrder()
                .withUser(user)
                .withStatus("PENDING")
                .addItem("å•†å“A", 2, new BigDecimal("50.00"))
                .addItem("å•†å“B", 1, new BigDecimal("100.00"))
                .build();
        entityManager.persist(order);
        
        entityManager.flush();
        
        return new OrderScenario(user, order);
    }
    
    // åœºæ™¯æ•°æ®åŒ…è£…ç±»
    public static class OrderScenario {
        public final User user;
        public final Order order;
        
        public OrderScenario(User user, Order order) {
            this.user = user;
            this.order = order;
        }
    }
}
```

**åœºæ™¯åŒ–ä½¿ç”¨**

```java
@SpringBootTest
public class OrderWorkflowTest {
    
    @Autowired
    private EntityManager entityManager;
    
    private TestDataFactory dataFactory;
    
    @BeforeEach
    public void setup() {
        dataFactory = new TestDataFactory(entityManager);
    }
    
    @Test
    public void testOrderCheckoutWorkflow() {
        // ä¸€é”®åˆ›å»ºå®Œæ•´çš„æµ‹è¯•åœºæ™¯
        TestDataFactory.OrderScenario scenario = dataFactory.createOrderScenario();
        
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        orderService.checkout(scenario.order.getId());
        
        // éªŒè¯ç»“æœ
        Order updatedOrder = orderRepository.findById(scenario.order.getId()).get();
        assertThat(updatedOrder.getStatus()).isEqualTo("PAID");
    }
}
```

**ğŸ’¡ æ•°æ®å·¥å‚çš„ä¼˜åŠ¿**

```
ä»£ç å¤ç”¨ï¼š
â†’ é¿å…é‡å¤çš„å¯¹è±¡åˆ›å»ºä»£ç 
â†’ ç»Ÿä¸€çš„æ•°æ®åˆ›å»ºé€»è¾‘

æ˜“äºç»´æŠ¤ï¼š
â†’ å®ä½“ç±»ä¿®æ”¹æ—¶åªéœ€è°ƒæ•´å·¥å‚
â†’ æµ‹è¯•ä»£ç ä¸å—å½±å“

è¡¨è¾¾æ¸…æ™°ï¼š
â†’ æµ‹è¯•æ„å›¾ä¸€ç›®äº†ç„¶
â†’ ä¾¿äºä»£ç å®¡æŸ¥

çµæ´»æ‰©å±•ï¼š
â†’ æ”¯æŒå„ç§æµ‹è¯•åœºæ™¯
â†’ æ˜“äºæ·»åŠ æ–°çš„å·¥å‚æ–¹æ³•
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ schema.sqlï¼šå®šä¹‰è¡¨ç»“æ„ï¼Œè‡ªåŠ¨å»ºè¡¨
ğŸ”¸ data.sqlï¼šæä¾›åˆå§‹æ•°æ®ï¼Œæµ‹è¯•åŸºç¡€
ğŸ”¸ @Sqlæ³¨è§£ï¼šçµæ´»æ§åˆ¶æµ‹è¯•æ•°æ®ï¼Œç²¾ç¡®ç®¡ç†
ğŸ”¸ è¿ç§»è„šæœ¬ï¼šç‰ˆæœ¬ç®¡ç†ï¼Œç”Ÿäº§æµ‹è¯•ä¸€è‡´
ğŸ”¸ åŸºå‡†æ•°æ®ï¼šæ ‡å‡†å‚ç…§ï¼Œå¯é‡å¤æµ‹è¯•
ğŸ”¸ æ¸…ç†ç­–ç•¥ï¼šä¿æŒç¯å¢ƒå¹²å‡€ï¼Œé¿å…å¹²æ‰°
ğŸ”¸ æ•°æ®å·¥å‚ï¼šä»£ç å¤ç”¨ï¼Œä¾¿äºç»´æŠ¤
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æµ‹è¯•æ•°æ®çš„ä¸‰ä¸ªå…³é”®ç‰¹æ€§**
```
éš”ç¦»æ€§ï¼š
â†’ æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹æ•°æ®
â†’ æµ‹è¯•ä¹‹é—´ä¸ç›¸äº’å½±å“
â†’ @Transactionalè‡ªåŠ¨å›æ»š

å¯é‡å¤æ€§ï¼š
â†’ ç›¸åŒæµ‹è¯•å¾—åˆ°ç›¸åŒç»“æœ
â†’ æ•°æ®çŠ¶æ€å¯ä»¥é‡ç½®
â†’ åŸºå‡†æ•°æ®ä¿è¯ä¸€è‡´æ€§

çœŸå®æ€§ï¼š
â†’ æ¨¡æ‹ŸçœŸå®ä¸šåŠ¡åœºæ™¯
â†’ è¦†ç›–è¾¹ç•Œæƒ…å†µ
â†’ åŒ…å«å¼‚å¸¸æ•°æ®æµ‹è¯•
```

**ğŸ”¹ æ•°æ®å‡†å¤‡çš„å››ç§æ–¹å¼å¯¹æ¯”**

| æ–¹å¼ | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|------|-------------|---------|---------|
| ğŸ”¸ **schema.sql** | `å…¨å±€è¡¨ç»“æ„` | `è‡ªåŠ¨æ‰§è¡Œï¼Œç®€å•` | `ä¸å¤Ÿçµæ´»` |
| ğŸ”¸ **data.sql** | `åŸºç¡€æ•°æ®` | `å¯åŠ¨åŠ è½½ï¼Œçœäº‹` | `æ‰€æœ‰æµ‹è¯•å…±äº«` |
| ğŸ”¸ **@Sqlæ³¨è§£** | `ç‰¹å®šæµ‹è¯•` | `çµæ´»æ§åˆ¶ï¼Œç²¾ç¡®` | `éœ€è¦ç®¡ç†è„šæœ¬` |
| ğŸ”¸ **æ•°æ®å·¥å‚** | `å¤æ‚åœºæ™¯` | `ä»£ç å¤ç”¨ï¼Œæ˜“ç»´æŠ¤` | `éœ€è¦ç¼–å†™å·¥å‚ç±»` |

**ğŸ”¹ æ¸…ç†ç­–ç•¥çš„é€‰æ‹©**

```
è‡ªåŠ¨å›æ»šï¼ˆ@Transactionalï¼‰ï¼š
â†’ æœ€ç®€å•çš„æ–¹å¼
â†’ é€‚åˆå¤§éƒ¨åˆ†å•å…ƒæµ‹è¯•
â†’ ä¸é€‚åˆæµ‹è¯•äº‹åŠ¡æœ¬èº«

æ‰‹åŠ¨æ¸…ç†ï¼ˆ@AfterEachï¼‰ï¼š
â†’ çµæ´»æ§åˆ¶æ¸…ç†é€»è¾‘
â†’ é€‚åˆå¤æ‚åœºæ™¯
â†’ éœ€è¦æ³¨æ„æ¸…ç†é¡ºåº

SQLè„šæœ¬æ¸…ç†ï¼ˆ@Sqlï¼‰ï¼š
â†’ ç»Ÿä¸€çš„æ¸…ç†è„šæœ¬
â†’ ä¾¿äºå¤ç”¨
â†’ é€‚åˆæ ‡å‡†åŒ–åœºæ™¯

å®Œå…¨é‡ç½®ï¼ˆ@DirtiesContextï¼‰ï¼š
â†’ å½»åº•çš„ç¯å¢ƒé‡ç½®
â†’ æ€§èƒ½å¼€é”€å¤§
â†’ ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¼ä¸šçº§æµ‹è¯•æ•°æ®ç®¡ç†å®è·µ**
- **æµ‹è¯•éš”ç¦»**ï¼šç¡®ä¿æµ‹è¯•ä¹‹é—´äº’ä¸å¹²æ‰°
- **æ•°æ®ä¸€è‡´**ï¼šç”Ÿäº§å’Œæµ‹è¯•ç¯å¢ƒç»“æ„åŒæ­¥
- **å¿«é€Ÿåé¦ˆ**ï¼šè‡ªåŠ¨åŒ–æ•°æ®å‡†å¤‡å’Œæ¸…ç†
- **å›¢é˜Ÿåä½œ**ï¼šæ ‡å‡†åŒ–çš„æ•°æ®ç®¡ç†æµç¨‹

**ğŸ”§ æœ€ä½³å®è·µå»ºè®®**
- **åˆ†å±‚ç®¡ç†**ï¼šåŸºå‡†æ•°æ®ã€åœºæ™¯æ•°æ®ã€æµ‹è¯•æ•°æ®åˆ†ç¦»
- **å·¥å‚æ¨¡å¼**ï¼šä½¿ç”¨æ•°æ®å·¥å‚æé«˜ä»£ç å¤ç”¨
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šè¿ç§»è„šæœ¬çº³å…¥ç‰ˆæœ¬ç®¡ç†
- **æ–‡æ¡£å®Œå–„**ï¼šè®°å½•æµ‹è¯•æ•°æ®çš„å«ä¹‰å’Œç”¨é€”

**ğŸ“ˆ è¿›é˜¶å­¦ä¹ æ–¹å‘**
- **æ€§èƒ½æµ‹è¯•æ•°æ®**ï¼šå¤§é‡æ•°æ®çš„ç”Ÿæˆç­–ç•¥
- **æ•°æ®è„±æ•**ï¼šç”Ÿäº§æ•°æ®ç”¨äºæµ‹è¯•çš„å¤„ç†
- **å®¹å™¨åŒ–æµ‹è¯•**ï¼šDockerä¸­çš„æ•°æ®ç®¡ç†
- **å¤šæ•°æ®æºæµ‹è¯•**ï¼šå¤æ‚æ¶æ„çš„æ•°æ®å‡†å¤‡

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- schemaå»ºè¡¨ç»“æ„ç¨³ï¼Œdataæä¾›åˆå§‹æ ¹
- @Sqlæ³¨è§£çµæ´»æ§ï¼Œå·¥å‚æ¨¡å¼å¤ç”¨å‹¤
- è¿ç§»è„šæœ¬ç‰ˆæœ¬æ¸…ï¼ŒåŸºå‡†æ•°æ®æ ‡å‡†å‡†
- æ¸…ç†ç­–ç•¥é€‰å¯¹è·¯ï¼Œæµ‹è¯•æ•°æ®ä¸çº·ä¹±