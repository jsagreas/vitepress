---
title: 26ã€å®ä½“çŠ¶æ€ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [å®ä½“çŠ¶æ€æ¦‚è¿°](#1-å®ä½“çŠ¶æ€æ¦‚è¿°)
2. [å››ç§å®ä½“çŠ¶æ€è¯¦è§£](#2-å››ç§å®ä½“çŠ¶æ€è¯¦è§£)
3. [å®ä½“çŠ¶æ€æµè½¬](#3-å®ä½“çŠ¶æ€æµè½¬)
4. [å…¸å‹åº”ç”¨åœºæ™¯](#4-å…¸å‹åº”ç”¨åœºæ™¯)
5. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#5-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å®ä½“çŠ¶æ€æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å®ä½“çŠ¶æ€


**é€šä¿—ç†è§£**ï¼šå°±åƒä¸€ä¸ªäººçš„èº«ä»½çŠ¶æ€ä¼šå˜åŒ–ï¼ˆå­¦ç”Ÿâ†’å‘˜å·¥â†’é€€ä¼‘ï¼‰ä¸€æ ·ï¼ŒJPAä¸­çš„å®ä½“å¯¹è±¡ä¹Ÿæœ‰ä¸åŒçš„çŠ¶æ€

```
ç°å®ç”Ÿæ´»ç±»æ¯”ï¼š
å°æ˜ï¼ˆäººï¼‰çš„çŠ¶æ€å˜åŒ–ï¼š
åˆšå‡ºç”Ÿ â†’ å­¦ç”Ÿ â†’ å‘˜å·¥ â†’ é€€ä¼‘

JPAå®ä½“çš„çŠ¶æ€å˜åŒ–ï¼š
æ–°å»ºå¯¹è±¡ â†’ æŒä¹…åŒ– â†’ æ¸¸ç¦» â†’ åˆ é™¤
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- å®ä½“çŠ¶æ€æ˜¯æŒ‡å®ä½“å¯¹è±¡ä¸æ•°æ®åº“ã€æŒä¹…åŒ–ä¸Šä¸‹æ–‡ä¹‹é—´çš„å…³ç³»
- ä¸åŒçŠ¶æ€ä¸‹ï¼Œå®ä½“å¯¹è±¡çš„è¡Œä¸ºå’Œç‰¹æ€§å®Œå…¨ä¸åŒ
- ç†è§£çŠ¶æ€æµè½¬æ˜¯æŒæ¡JPAçš„å…³é”®

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦çŠ¶æ€ç®¡ç†


**é—®é¢˜åœºæ™¯**ï¼š
```java
// åœºæ™¯1ï¼šåŒä¸€ä¸ªå¯¹è±¡ï¼Œä¸ºä»€ä¹ˆæœ‰æ—¶ä¿®æ”¹ä¼šä¿å­˜ï¼Œæœ‰æ—¶ä¸ä¼šï¼Ÿ
User user = new User();
user.setName("å¼ ä¸‰");
// è¿™é‡Œä¿®æ”¹æœ‰æ•ˆå—ï¼Ÿâ“

User user2 = userRepository.findById(1L);
user2.setName("æå››");  
// è¿™é‡Œä¿®æ”¹ä¼šè‡ªåŠ¨ä¿å­˜å—ï¼Ÿâ“
```

**çŠ¶æ€ç®¡ç†çš„ä½œç”¨**ï¼š
- **è‡ªåŠ¨åŒæ­¥**ï¼šæŒä¹…åŒ–çŠ¶æ€çš„å¯¹è±¡ä¿®æ”¹ä¼šè‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…ä¸å¿…è¦çš„æ•°æ®åº“æ“ä½œ
- **äº‹åŠ¡æ§åˆ¶**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **ç¼“å­˜ç®¡ç†**ï¼šä¸€çº§ç¼“å­˜ä¾èµ–çŠ¶æ€ç®¡ç†

---

## 2. ğŸ“‹ å››ç§å®ä½“çŠ¶æ€è¯¦è§£


### 2.1 Transientï¼ˆç¬æ—¶çŠ¶æ€ï¼‰


**ğŸ”¸ çŠ¶æ€å®šä¹‰**
```
ç¬æ—¶æ€ = åˆšç”¨newåˆ›å»ºçš„å¯¹è±¡
ç‰¹ç‚¹ï¼šä¸æ•°æ®åº“ã€æŒä¹…åŒ–ä¸Šä¸‹æ–‡éƒ½æ²¡æœ‰å…³ç³»
```

**é€šä¿—ç†è§£**ï¼šå°±åƒä¸€ä¸ªåˆšå†™åœ¨è‰ç¨¿çº¸ä¸Šçš„ç¬”è®°ï¼Œè¿˜æ²¡ä¿å­˜åˆ°ç¬”è®°æœ¬é‡Œ

```java
// åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡
User user = new User();
user.setName("å¼ ä¸‰");
user.setAge(25);

// æ­¤æ—¶userå¤„äºTransientçŠ¶æ€ï¼š
// âœ… åªæ˜¯ä¸€ä¸ªæ™®é€šJavaå¯¹è±¡
// âŒ æ•°æ®åº“ä¸­æ²¡æœ‰å¯¹åº”è®°å½•
// âŒ EntityManagerä¸çŸ¥é“è¿™ä¸ªå¯¹è±¡çš„å­˜åœ¨
// âŒ ä¿®æ”¹å±æ€§ä¸ä¼šå½±å“æ•°æ®åº“
```

**å…³é”®ç‰¹å¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Transientç¬æ—¶çŠ¶æ€      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Œ åˆšnewå‡ºæ¥çš„å¯¹è±¡      â”‚
â”‚ ğŸ“Œ æ²¡æœ‰IDï¼ˆä¸»é”®ä¸ºnullï¼‰  â”‚
â”‚ ğŸ“Œ ä¸åœ¨æŒä¹…åŒ–ä¸Šä¸‹æ–‡ä¸­    â”‚
â”‚ ğŸ“Œ æ•°æ®åº“ä¸­æ— å¯¹åº”è®°å½•    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Persistentï¼ˆæŒä¹…åŒ–çŠ¶æ€ï¼‰


**ğŸ”¸ çŠ¶æ€å®šä¹‰**
```
æŒä¹…åŒ–æ€ = è¢«EntityManagerç®¡ç†çš„å¯¹è±¡
ç‰¹ç‚¹ï¼šä¸æ•°æ®åº“ä¿æŒåŒæ­¥ï¼Œä¿®æ”¹ä¼šè‡ªåŠ¨ä¿å­˜
```

**é€šä¿—ç†è§£**ï¼šå°±åƒå·²ç»ä¿å­˜åˆ°äº‘ç«¯çš„æ–‡æ¡£ï¼Œä»»ä½•ä¿®æ”¹éƒ½ä¼šè‡ªåŠ¨åŒæ­¥

```java
// æ–¹å¼1ï¼šä¿å­˜åå˜ä¸ºæŒä¹…åŒ–çŠ¶æ€
User user = new User();
user.setName("å¼ ä¸‰");
entityManager.persist(user);  // Transient â†’ Persistent

// æ–¹å¼2ï¼šæŸ¥è¯¢å¾—åˆ°çš„å°±æ˜¯æŒä¹…åŒ–çŠ¶æ€
User user2 = entityManager.find(User.class, 1L);  // ç›´æ¥æ˜¯Persistent

// æŒä¹…åŒ–çŠ¶æ€çš„ç¥å¥‡ä¹‹å¤„ï¼š
user2.setName("æå››");  
// âœ… ä¸éœ€è¦è°ƒç”¨save()
// âœ… äº‹åŠ¡æäº¤æ—¶ä¼šè‡ªåŠ¨UPDATEåˆ°æ•°æ®åº“
// âœ… è¿™å°±æ˜¯JPAçš„"è‡ªåŠ¨è„æ£€æŸ¥"æœºåˆ¶
```

**å…³é”®ç‰¹å¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PersistentæŒä¹…åŒ–çŠ¶æ€       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Œ æœ‰IDï¼ˆä¸»é”®æœ‰å€¼ï¼‰         â”‚
â”‚ ğŸ“Œ åœ¨æŒä¹…åŒ–ä¸Šä¸‹æ–‡ä¸­         â”‚
â”‚ ğŸ“Œ æ•°æ®åº“ä¸­æœ‰å¯¹åº”è®°å½•       â”‚
â”‚ ğŸ“Œ ä¿®æ”¹ä¼šè‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“   â”‚
â”‚ ğŸ“Œ äº«å—ä¸€çº§ç¼“å­˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ’¡ **æ–°æ‰‹è¦ç‚¹**ï¼šæŒä¹…åŒ–çŠ¶æ€æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯"è‡ªåŠ¨ä¿å­˜"ï¼Œä½ åªç®¡ä¿®æ”¹å¯¹è±¡å±æ€§ï¼ŒJPAä¼šåœ¨äº‹åŠ¡æäº¤æ—¶è‡ªåŠ¨å¸®ä½ UPDATEåˆ°æ•°æ®åº“ï¼

### 2.3 Detachedï¼ˆæ¸¸ç¦»çŠ¶æ€ï¼‰


**ğŸ”¸ çŠ¶æ€å®šä¹‰**
```
æ¸¸ç¦»æ€ = æ›¾ç»è¢«ç®¡ç†è¿‡ï¼Œç°åœ¨è„±ç¦»äº†ç®¡ç†
ç‰¹ç‚¹ï¼šæœ‰IDï¼Œä½†ä¸æŒä¹…åŒ–ä¸Šä¸‹æ–‡æ–­å¼€äº†è”ç³»
```

**é€šä¿—ç†è§£**ï¼šå°±åƒç¦»çº¿çš„æ–‡æ¡£ï¼Œæœ‰å†…å®¹ä½†ä¸ä¼šè‡ªåŠ¨åŒæ­¥äº†

```java
// åœºæ™¯1ï¼šäº‹åŠ¡ç»“æŸåå˜ä¸ºæ¸¸ç¦»çŠ¶æ€
@Transactional
public void updateUser() {
    User user = entityManager.find(User.class, 1L);  // Persistent
    user.setName("å¼ ä¸‰");
}  // äº‹åŠ¡ç»“æŸï¼Œuserå˜ä¸ºDetached

// åœºæ™¯2ï¼šæ‰‹åŠ¨åˆ†ç¦»
User user = entityManager.find(User.class, 1L);  // Persistent
entityManager.detach(user);  // ä¸»åŠ¨å˜ä¸ºDetached

// æ¸¸ç¦»çŠ¶æ€çš„ç‰¹ç‚¹ï¼š
user.setName("æå››");  
// âŒ è¿™ä¸ªä¿®æ”¹ä¸ä¼šä¿å­˜åˆ°æ•°æ®åº“
// âŒ å› ä¸ºå·²ç»è„±ç¦»äº†EntityManagerçš„ç®¡ç†

// å¦‚ä½•é‡æ–°ä¿å­˜ï¼Ÿéœ€è¦mergeåˆå¹¶
User managedUser = entityManager.merge(user);  // Detached â†’ Persistent
```

**å…³é”®ç‰¹å¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Detachedæ¸¸ç¦»çŠ¶æ€           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Œ æœ‰IDï¼ˆä¸»é”®æœ‰å€¼ï¼‰         â”‚
â”‚ ğŸ“Œ ä¸åœ¨æŒä¹…åŒ–ä¸Šä¸‹æ–‡ä¸­       â”‚
â”‚ ğŸ“Œ æ•°æ®åº“ä¸­æœ‰å¯¹åº”è®°å½•       â”‚
â”‚ ğŸ“Œ ä¿®æ”¹ä¸ä¼šè‡ªåŠ¨ä¿å­˜         â”‚
â”‚ ğŸ“Œ éœ€è¦mergeé‡æ–°å˜ä¸ºæŒä¹…åŒ–  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> âš ï¸ **å¸¸è§å›°æƒ‘**ï¼šä¸ºä»€ä¹ˆæˆ‘ä¿®æ”¹äº†å¯¹è±¡ï¼Œæ•°æ®åº“å´æ²¡å˜ï¼Ÿå¾ˆå¯èƒ½å°±æ˜¯å¯¹è±¡å¤„äºDetachedçŠ¶æ€ï¼

### 2.4 Removedï¼ˆåˆ é™¤çŠ¶æ€ï¼‰


**ğŸ”¸ çŠ¶æ€å®šä¹‰**
```
åˆ é™¤æ€ = è¢«æ ‡è®°ä¸ºåˆ é™¤çš„å¯¹è±¡
ç‰¹ç‚¹ï¼šäº‹åŠ¡æäº¤æ—¶ä¼šä»æ•°æ®åº“ä¸­åˆ é™¤
```

**é€šä¿—ç†è§£**ï¼šå°±åƒæ”¾è¿›å›æ”¶ç«™çš„æ–‡ä»¶ï¼Œè¿˜æ²¡çœŸæ­£åˆ é™¤ï¼Œä½†å·²ç»æ ‡è®°è¦åˆ äº†

```java
// åˆ é™¤æ“ä½œ
User user = entityManager.find(User.class, 1L);  // Persistent
entityManager.remove(user);  // Persistent â†’ Removed

// åˆ é™¤çŠ¶æ€çš„ç‰¹ç‚¹ï¼š
// âœ… è¿˜åœ¨æŒä¹…åŒ–ä¸Šä¸‹æ–‡ä¸­ï¼ˆè¢«ç®¡ç†ç€ï¼‰
// âœ… äº‹åŠ¡æäº¤æ—¶ä¼šæ‰§è¡ŒDELETEè¯­å¥
// âœ… åˆ é™¤åå¯¹è±¡è¿˜å­˜åœ¨ï¼Œä½†IDä¼šå˜ä¸ºnull
```

**å…³é”®ç‰¹å¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Removedåˆ é™¤çŠ¶æ€            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Œ åœ¨æŒä¹…åŒ–ä¸Šä¸‹æ–‡ä¸­         â”‚
â”‚ ğŸ“Œ è¢«æ ‡è®°ä¸ºåˆ é™¤             â”‚
â”‚ ğŸ“Œ äº‹åŠ¡æäº¤æ—¶æ‰§è¡ŒDELETE     â”‚
â”‚ ğŸ“Œ åˆ é™¤åIDå˜ä¸ºnull         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ğŸ”„ å®ä½“çŠ¶æ€æµè½¬


### 3.1 å®Œæ•´çŠ¶æ€æµè½¬å›¾


```
          newåˆ›å»ºå¯¹è±¡
               â†“
         [Transient]  â†â”€â”€â”€â”€â”€â”€ persist()ä¿å­˜
               â†“                    â†‘
         persist()                  |
               â†“                    |
         [Persistent] â†â”€â”€â”€ merge()åˆå¹¶
          â†—    â†“    â†–              â†‘
    find() detach() remove()       |
         â†™      â†“      â†˜           |
               â†“        [Removed]  |
        [Detached] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
          äº‹åŠ¡ç»“æŸ/clear()
```

### 3.2 çŠ¶æ€è½¬æ¢è¯¦ç»†è¯´æ˜


**ğŸ”¸ Transient â†’ Persistent**
```java
// æ–¹å¼1ï¼špersistä¿å­˜æ–°å¯¹è±¡
User user = new User();  // Transient
entityManager.persist(user);  // â†’ Persistent

// æ–¹å¼2ï¼šæŸ¥è¯¢å¾—åˆ°æŒä¹…åŒ–å¯¹è±¡
User user = entityManager.find(User.class, 1L);  // ç›´æ¥Persistent
```

**ğŸ”¸ Persistent â†’ Detached**
```java
// æ–¹å¼1ï¼šäº‹åŠ¡ç»“æŸè‡ªåŠ¨æ¸¸ç¦»
@Transactional
public User getUser() {
    return entityManager.find(User.class, 1L);  // Persistent
}  // æ–¹æ³•ç»“æŸï¼Œè¿”å›çš„userå˜ä¸ºDetached

// æ–¹å¼2ï¼šæ‰‹åŠ¨åˆ†ç¦»
entityManager.detach(user);  // â†’ Detached

// æ–¹å¼3ï¼šæ¸…ç©ºä¸Šä¸‹æ–‡
entityManager.clear();  // æ‰€æœ‰å¯¹è±¡ â†’ Detached
```

**ğŸ”¸ Detached â†’ Persistent**
```java
// ä½¿ç”¨mergeåˆå¹¶
User detachedUser = ...;  // DetachedçŠ¶æ€
User persistentUser = entityManager.merge(detachedUser);  // â†’ Persistent

// æ³¨æ„ï¼šmergeè¿”å›çš„æ˜¯æ–°çš„æŒä¹…åŒ–å¯¹è±¡ï¼
detachedUser.setName("å¼ ä¸‰");  // âŒ æ— æ•ˆï¼Œè¿˜æ˜¯æ¸¸ç¦»æ€
persistentUser.setName("å¼ ä¸‰");  // âœ… æœ‰æ•ˆï¼Œä¼šè‡ªåŠ¨ä¿å­˜
```

**ğŸ”¸ Persistent â†’ Removed**
```java
// åˆ é™¤æ“ä½œ
User user = entityManager.find(User.class, 1L);  // Persistent
entityManager.remove(user);  // â†’ Removed
// äº‹åŠ¡æäº¤æ—¶æ‰§è¡ŒDELETE
```

### 3.3 çŠ¶æ€åˆ¤æ–­æ–¹æ³•


```java
// JPAæä¾›äº†åˆ¤æ–­å®ä½“çŠ¶æ€çš„æ–¹æ³•
EntityManager em = ...;

// åˆ¤æ–­æ˜¯å¦åœ¨æŒä¹…åŒ–ä¸Šä¸‹æ–‡ä¸­
boolean isPersistent = em.contains(user);

// å„çŠ¶æ€çš„åˆ¤æ–­é€»è¾‘ï¼š
TransientçŠ¶æ€ï¼š
- em.contains(entity) == false
- entity.getId() == null

PersistentçŠ¶æ€ï¼š
- em.contains(entity) == true
- entity.getId() != null

DetachedçŠ¶æ€ï¼š
- em.contains(entity) == false  
- entity.getId() != null

RemovedçŠ¶æ€ï¼š
- em.contains(entity) == true
- è¢«æ ‡è®°ä¸ºåˆ é™¤
```

---

## 4. ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯


### 4.1 åœºæ™¯1ï¼šæ•°æ®ä¿®æ”¹ä¸ä¿å­˜


**éœ€æ±‚**ï¼šä¿®æ”¹ç”¨æˆ·ä¿¡æ¯

```java
// âŒ é”™è¯¯åšæ³•ï¼šæ¸¸ç¦»çŠ¶æ€ä¿®æ”¹æ— æ•ˆ
@Service
public class UserService {
    
    public void updateUserWrong(Long userId) {
        User user = userRepository.findById(userId).get();  
        // æŸ¥è¯¢ç»“æŸï¼Œäº‹åŠ¡å…³é—­ï¼Œuserå˜ä¸ºDetached
        
        user.setName("æ–°åå­—");  
        // âŒ ä¿®æ”¹æ— æ•ˆï¼å› ä¸ºå·²ç»æ¸¸ç¦»äº†
    }
    
    // âœ… æ­£ç¡®åšæ³•1ï¼šåœ¨äº‹åŠ¡å†…ä¿®æ”¹
    @Transactional
    public void updateUserRight(Long userId) {
        User user = userRepository.findById(userId).get();  
        // åœ¨äº‹åŠ¡å†…ï¼Œuseræ˜¯Persistent
        
        user.setName("æ–°åå­—");  
        // âœ… è‡ªåŠ¨ä¿å­˜ï¼äº‹åŠ¡æäº¤æ—¶UPDATE
    }
    
    // âœ… æ­£ç¡®åšæ³•2ï¼šä½¿ç”¨merge
    public void updateUserWithMerge(User detachedUser) {
        User managed = entityManager.merge(detachedUser);
        // mergeåmanagedæ˜¯Persistentï¼Œä¼šè‡ªåŠ¨ä¿å­˜
    }
}
```

### 4.2 åœºæ™¯2ï¼šæ‰¹é‡æ“ä½œä¼˜åŒ–


**éœ€æ±‚**ï¼šæ‰¹é‡æ’å…¥ç”¨æˆ·

```java
@Service
public class UserService {
    
    // âŒ æ€§èƒ½å·®ï¼šæ¯æ¬¡éƒ½flush
    public void batchInsertSlow(List<User> users) {
        for (User user : users) {
            entityManager.persist(user);
            // é»˜è®¤ä¼šç«‹å³flushï¼Œè§¦å‘SQL
        }
    }
    
    // âœ… ä¼˜åŒ–ï¼šæ‰¹é‡flush
    @Transactional
    public void batchInsertFast(List<User> users) {
        int batchSize = 50;
        for (int i = 0; i < users.size(); i++) {
            entityManager.persist(users.get(i));
            
            if (i % batchSize == 0 && i > 0) {
                entityManager.flush();   // æ‰¹é‡æ‰§è¡ŒSQL
                entityManager.clear();   // æ¸…ç©ºç¼“å­˜ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
            }
        }
    }
}
```

### 4.3 åœºæ™¯3ï¼šåˆ†å±‚æ¶æ„ä¸­çš„çŠ¶æ€ç®¡ç†


**éœ€æ±‚**ï¼šControllerå±‚æ¥æ”¶å¯¹è±¡ï¼ŒServiceå±‚ä¿å­˜

```java
// Controllerå±‚
@RestController
public class UserController {
    
    @PostMapping("/users")
    public User createUser(@RequestBody User user) {
        // æ­¤æ—¶useræ˜¯TransientçŠ¶æ€
        return userService.save(user);
    }
    
    @PutMapping("/users/{id}")  
    public User updateUser(@PathVariable Long id, @RequestBody User user) {
        // æ­¤æ—¶useræ˜¯DetachedçŠ¶æ€ï¼ˆæœ‰IDä½†ä¸åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼‰
        user.setId(id);
        return userService.update(user);
    }
}

// Serviceå±‚
@Service
public class UserService {
    
    @Transactional
    public User save(User user) {
        // useræ˜¯Transientï¼Œéœ€è¦persist
        entityManager.persist(user);
        return user;  // ç°åœ¨æ˜¯Persistent
    }
    
    @Transactional
    public User update(User detachedUser) {
        // detachedUseræ˜¯Detachedï¼Œéœ€è¦merge
        return entityManager.merge(detachedUser);
    }
}
```

### 4.4 åœºæ™¯4ï¼šæ‡’åŠ è½½ä¸çŠ¶æ€


**éœ€æ±‚**ï¼šè·å–ç”¨æˆ·åŠå…¶è®¢å•

```java
@Entity
public class User {
    @OneToMany(fetch = FetchType.LAZY)
    private List<Order> orders;
}

@Service
public class UserService {
    
    // âŒ æ‡’åŠ è½½å¼‚å¸¸
    public List<Order> getUserOrdersWrong(Long userId) {
        User user = userRepository.findById(userId).get();
        // äº‹åŠ¡ç»“æŸï¼Œuserå˜ä¸ºDetached
        
        return user.getOrders();  
        // âŒ LazyInitializationException!
        // å› ä¸ºuserå·²ç»æ¸¸ç¦»ï¼Œæ— æ³•æ‡’åŠ è½½
    }
    
    // âœ… æ–¹å¼1ï¼šåœ¨äº‹åŠ¡å†…è®¿é—®
    @Transactional
    public List<Order> getUserOrdersRight(Long userId) {
        User user = userRepository.findById(userId).get();
        // useræ˜¯Persistent
        
        return user.getOrders();  
        // âœ… å¯ä»¥æ‡’åŠ è½½
    }
    
    // âœ… æ–¹å¼2ï¼šé¢„åŠ è½½
    @Transactional
    public User getUserWithOrders(Long userId) {
        User user = userRepository.findById(userId).get();
        user.getOrders().size();  // è§¦å‘åŠ è½½
        return user;  // è¿”å›åè™½ç„¶Detachedï¼Œä½†orderså·²åŠ è½½
    }
}
```

---

## 5. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 5.1 å››ç§çŠ¶æ€å¯¹æ¯”è¡¨


| çŠ¶æ€ | **æœ‰ID** | **åœ¨ä¸Šä¸‹æ–‡ä¸­** | **æ•°æ®åº“ä¸­** | **ä¿®æ”¹æ˜¯å¦è‡ªåŠ¨ä¿å­˜** |
|------|---------|--------------|------------|-------------------|
| **Transient** | âŒ | âŒ | âŒ | âŒ |
| **Persistent** | âœ… | âœ… | âœ… | âœ… |
| **Detached** | âœ… | âŒ | âœ… | âŒ |
| **Removed** | âœ… | âœ… | âœ… | âŒï¼ˆå°†è¢«åˆ é™¤ï¼‰|

### 5.2 çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ


**ğŸ”¸ ä½¿ç”¨@Transactional**
```java
// âœ… ç¡®ä¿æ“ä½œåœ¨äº‹åŠ¡å†…
@Transactional
public void modifyUser(Long id) {
    User user = userRepository.findById(id).get();
    user.setName("æ–°åå­—");  // è‡ªåŠ¨ä¿å­˜
}
```

**ğŸ”¸ ç†è§£mergeçš„è¡Œä¸º**
```java
// âŒ é”™è¯¯ï¼šä»¥ä¸ºmergeä¼šä¿®æ”¹åŸå¯¹è±¡
User detached = ...;
entityManager.merge(detached);
detached.setName("æ–°åå­—");  // âŒ æ— æ•ˆï¼

// âœ… æ­£ç¡®ï¼šä½¿ç”¨mergeè¿”å›çš„å¯¹è±¡
User persistent = entityManager.merge(detached);
persistent.setName("æ–°åå­—");  // âœ… æœ‰æ•ˆï¼
```

**ğŸ”¸ é¿å…æ¸¸ç¦»æ€é™·é˜±**
```java
// âŒ å¸¸è§é”™è¯¯
public User getUser(Long id) {
    return entityManager.find(User.class, id);
    // è¿”å›åæ˜¯Detachedï¼Œä¿®æ”¹æ— æ•ˆ
}

// âœ… ä¸¤ç§è§£å†³æ–¹æ¡ˆ
// æ–¹æ¡ˆ1ï¼šåœ¨äº‹åŠ¡å†…å®Œæˆæ‰€æœ‰æ“ä½œ
@Transactional
public void processUser(Long id) {
    User user = entityManager.find(User.class, id);
    user.setName("æ–°åå­—");  // åœ¨äº‹åŠ¡å†…ä¿®æ”¹
}

// æ–¹æ¡ˆ2ï¼šè¿”å›å‰é¢„åŠ è½½éœ€è¦çš„æ•°æ®
@Transactional  
public User getUserWithData(Long id) {
    User user = entityManager.find(User.class, id);
    user.getOrders().size();  // é¢„åŠ è½½å…³è”æ•°æ®
    return user;
}
```

### 5.3 å¸¸è§é—®é¢˜ä¸è§£å†³


> â“ **é—®é¢˜1ï¼šä¸ºä»€ä¹ˆä¿®æ”¹äº†å¯¹è±¡ï¼Œæ•°æ®åº“æ²¡å˜ï¼Ÿ**
> 
> ğŸ’¡ **åŸå› **ï¼šå¯¹è±¡å¾ˆå¯èƒ½å¤„äºDetachedçŠ¶æ€
> 
> âœ… **è§£å†³**ï¼šç¡®ä¿åœ¨@Transactionaläº‹åŠ¡å†…ä¿®æ”¹ï¼Œæˆ–ä½¿ç”¨merge

> â“ **é—®é¢˜2ï¼šLazyInitializationExceptionæ€ä¹ˆè§£å†³ï¼Ÿ**
> 
> ğŸ’¡ **åŸå› **ï¼šåœ¨DetachedçŠ¶æ€è®¿é—®æ‡’åŠ è½½å±æ€§
> 
> âœ… **è§£å†³**ï¼šåœ¨PersistentçŠ¶æ€æ—¶è®¿é—®ï¼Œæˆ–ä½¿ç”¨JOIN FETCHé¢„åŠ è½½

> â“ **é—®é¢˜3ï¼šmergeå’Œpersistæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
> 
> ğŸ’¡ **åŒºåˆ«**ï¼š
> - persistï¼šåªèƒ½ä¿å­˜Transientå¯¹è±¡ï¼Œä¼šå˜ä¸ºPersistent
> - mergeï¼šå¯ä»¥åˆå¹¶Detachedå¯¹è±¡ï¼Œè¿”å›æ–°çš„Persistentå¯¹è±¡

### 5.4 æ ¸å¿ƒè®°å¿†è¦ç‚¹


```
ğŸ§  è®°å¿†å£è¯€ï¼š
- Newå¯¹è±¡æ˜¯ç¬æ—¶ï¼Œpersistå˜æŒä¹…
- æŸ¥è¯¢å¾—åˆ°æ˜¯æŒä¹…ï¼Œäº‹åŠ¡ç»“æŸå˜æ¸¸ç¦»  
- æ¸¸ç¦»å¯¹è±¡éœ€mergeï¼Œæ‰èƒ½é‡æ–°ç®¡ç†
- æŒä¹…å¯¹è±¡è‡ªåŠ¨å­˜ï¼Œä¿®æ”¹æ— éœ€è°ƒsave

ğŸ¯ å…³é”®ç†è§£ï¼š
- PersistentçŠ¶æ€æœ€é‡è¦ï¼šè‡ªåŠ¨ä¿å­˜ã€äº«å—ç¼“å­˜
- DetachedçŠ¶æ€æœ€æ˜“é”™ï¼šä¿®æ”¹æ— æ•ˆã€æ‡’åŠ è½½å¤±è´¥
- å§‹ç»ˆåœ¨@Transactionalå†…æ“ä½œï¼Œé¿å…çŠ¶æ€é—®é¢˜
```

**å®æˆ˜å»ºè®®**ï¼š
- ğŸ”¥ **æ–°æ‰‹é˜¶æ®µ**ï¼šæ‰€æœ‰æ•°æ®æ“ä½œéƒ½åŠ @Transactionalï¼Œç¡®ä¿åœ¨æŒä¹…åŒ–çŠ¶æ€
- âš¡ **è¿›é˜¶é˜¶æ®µ**ï¼šç†è§£çŠ¶æ€æµè½¬ï¼Œåˆç†ä½¿ç”¨mergeå’Œdetach
- ğŸš€ **é«˜çº§é˜¶æ®µ**ï¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯ä¼˜åŒ–çŠ¶æ€ç®¡ç†ï¼Œæå‡æ€§èƒ½