---
title: 48ã€Queryè‡ªå®šä¹‰æŸ¥è¯¢ä¸SpEL
---
## ğŸ“š ç›®å½•

1. [@Queryæ³¨è§£åŸºç¡€](#1-Queryæ³¨è§£åŸºç¡€)
2. [JPQLè‡ªå®šä¹‰æŸ¥è¯¢](#2-JPQLè‡ªå®šä¹‰æŸ¥è¯¢)
3. [åŸç”ŸSQLæŸ¥è¯¢](#3-åŸç”ŸSQLæŸ¥è¯¢)
4. [å‚æ•°ç»‘å®šæ–¹å¼](#4-å‚æ•°ç»‘å®šæ–¹å¼)
5. [SpELè¡¨è¾¾å¼åº”ç”¨](#5-SpELè¡¨è¾¾å¼åº”ç”¨)
6. [ä¿®æ”¹æŸ¥è¯¢æ“ä½œ](#6-ä¿®æ”¹æŸ¥è¯¢æ“ä½œ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” @Queryæ³¨è§£åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯@Queryæ³¨è§£


**ğŸ¯ ç®€å•ç†è§£**ï¼š
æƒ³è±¡ä½ åœ¨é¤å…ç‚¹èœï¼Œæ–¹æ³•å‘½åæŸ¥è¯¢å°±åƒ"å¥—é¤1ã€å¥—é¤2"è¿™æ ·å›ºå®šçš„èœå•ï¼Œè€Œ@Queryå°±åƒ**è‡ªå·±ç»„åˆèœå“**ï¼Œæƒ³è¦ä»€ä¹ˆå°±ç‚¹ä»€ä¹ˆï¼Œçµæ´»æ€§æ›´é«˜ã€‚

**ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ**ï¼š
```
@Queryæ˜¯Spring Data JPAæä¾›çš„è‡ªå®šä¹‰æŸ¥è¯¢æ³¨è§£
ä½œç”¨ï¼šè®©ä½ å¯ä»¥å†™è‡ªå·±çš„æŸ¥è¯¢è¯­å¥ï¼Œä¸å—æ–¹æ³•å‘½åè§„åˆ™é™åˆ¶
å¥½å¤„ï¼šå¤æ‚æŸ¥è¯¢æ›´çµæ´»ï¼Œä»£ç æ›´æ¸…æ™°æ˜“æ‡‚
```

**ğŸ“ åŸºæœ¬ä½¿ç”¨**ï¼š
```java
public interface UserRepository extends JpaRepository<User, Long> {
    
    // æ–¹æ³•å‘½åæŸ¥è¯¢ - å±€é™æ€§å¤§
    List<User> findByUsernameAndAge(String username, Integer age);
    
    // @QueryæŸ¥è¯¢ - æ›´çµæ´»
    @Query("SELECT u FROM User u WHERE u.username = ?1 AND u.age = ?2")
    List<User> searchUsers(String username, Integer age);
}
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦@Query


**ğŸ”¸ æ–¹æ³•å‘½åçš„å±€é™æ€§**ï¼š
```
é—®é¢˜åœºæ™¯ï¼š
1. å¤æ‚æ¡ä»¶ç»„åˆ - æ–¹æ³•åä¼šå˜å¾—ç‰¹åˆ«é•¿
   findByUsernameAndAgeGreaterThanAndCreateTimeBetween...ï¼ˆå¤ªé•¿äº†ï¼ï¼‰

2. å¤šè¡¨å…³è”æŸ¥è¯¢ - æ–¹æ³•å‘½åæ— æ³•è¡¨è¾¾
   æŸ¥è¯¢ç”¨æˆ·åŠå…¶è®¢å•ä¿¡æ¯

3. èšåˆç»Ÿè®¡æŸ¥è¯¢ - æ–¹æ³•å‘½ååšä¸åˆ°
   ç»Ÿè®¡æ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„

4. åŠ¨æ€æ’åºåˆ†ç»„ - éœ€è¦æ›´çµæ´»çš„æ§åˆ¶
   æŒ‰å¤šä¸ªå­—æ®µæ’åºå’Œåˆ†ç»„
```

**âœ… @Queryçš„ä¼˜åŠ¿**ï¼š

| å¯¹æ¯”ç»´åº¦ | **æ–¹æ³•å‘½åæŸ¥è¯¢** | **@QueryæŸ¥è¯¢** |
|---------|-----------------|---------------|
| ğŸƒ **ç®€å•æŸ¥è¯¢** | ç®€æ´ç›´è§‚ | éœ€è¦å†™SQL |
| ğŸ¯ **å¤æ‚æŸ¥è¯¢** | æ–¹æ³•åå¤ªé•¿ | æ¸…æ™°çµæ´» |
| ğŸ”— **å…³è”æŸ¥è¯¢** | æ”¯æŒæœ‰é™ | å®Œå…¨æ”¯æŒ |
| ğŸ“Š **ç»Ÿè®¡æŸ¥è¯¢** | æ— æ³•å®ç° | è½»æ¾å®ç° |
| ğŸ› ï¸ **ç»´æŠ¤æ€§** | æ”¹åŠ¨é¢‘ç¹ | ä¿®æ”¹æ–¹ä¾¿ |

---

## 2. ğŸ“ JPQLè‡ªå®šä¹‰æŸ¥è¯¢


### 2.1 JPQLåŸºç¡€è¯­æ³•


**ğŸ¯ ä»€ä¹ˆæ˜¯JPQL**ï¼š
JPQLï¼ˆJava Persistence Query Languageï¼‰æ˜¯JPAçš„æŸ¥è¯¢è¯­è¨€ï¼Œå®ƒ**é¢å‘å¯¹è±¡**è€Œä¸æ˜¯é¢å‘æ•°æ®åº“è¡¨ã€‚

**æ ¸å¿ƒåŒºåˆ«**ï¼š
```
SQLæŸ¥è¯¢ï¼ˆé¢å‘è¡¨ï¼‰ï¼š
SELECT * FROM t_user WHERE user_name = 'jack'
      â†‘è¡¨å       â†‘åˆ—å

JPQLæŸ¥è¯¢ï¼ˆé¢å‘å¯¹è±¡ï¼‰ï¼š
SELECT u FROM User u WHERE u.username = 'jack'
      â†‘å®ä½“ç±»    â†‘å±æ€§å
```

**ğŸ’¡ é‡è¦ç†è§£**ï¼š
```
åœ¨JPQLä¸­ï¼š
âœ… ä½¿ç”¨å®ä½“ç±»åï¼ˆUserï¼‰ï¼Œä¸æ˜¯è¡¨åï¼ˆt_userï¼‰
âœ… ä½¿ç”¨å±æ€§åï¼ˆusernameï¼‰ï¼Œä¸æ˜¯åˆ—åï¼ˆuser_nameï¼‰
âœ… æ“ä½œçš„æ˜¯Javaå¯¹è±¡ï¼Œä¸æ˜¯æ•°æ®åº“è®°å½•
```

### 2.2 åŸºç¡€æŸ¥è¯¢ç¤ºä¾‹


**ğŸ”¸ ç®€å•æ¡ä»¶æŸ¥è¯¢**ï¼š
```java
// å•æ¡ä»¶æŸ¥è¯¢
@Query("SELECT u FROM User u WHERE u.username = ?1")
User findByName(String username);

// å¤šæ¡ä»¶æŸ¥è¯¢
@Query("SELECT u FROM User u WHERE u.age > ?1 AND u.status = ?2")
List<User> findByAgeAndStatus(Integer age, String status);

// æ¨¡ç³ŠæŸ¥è¯¢
@Query("SELECT u FROM User u WHERE u.username LIKE %?1%")
List<User> searchByUsername(String keyword);
```

**ğŸ”¸ æ’åºå’Œåˆ†é¡µ**ï¼š
```java
// æ’åºæŸ¥è¯¢
@Query("SELECT u FROM User u WHERE u.age > ?1 ORDER BY u.createTime DESC")
List<User> findByAgeOrderByTime(Integer age);

// åˆ†é¡µæŸ¥è¯¢ï¼ˆè‡ªåŠ¨æ”¯æŒï¼‰
@Query("SELECT u FROM User u WHERE u.status = ?1")
Page<User> findByStatus(String status, Pageable pageable);
```

### 2.3 èšåˆç»Ÿè®¡æŸ¥è¯¢


**ğŸ“Š ç»Ÿè®¡å‡½æ•°ä½¿ç”¨**ï¼š
```java
// ç»Ÿè®¡æ•°é‡
@Query("SELECT COUNT(u) FROM User u WHERE u.age > ?1")
Long countByAge(Integer age);

// æ±‚å’Œ
@Query("SELECT SUM(o.amount) FROM Order o WHERE o.userId = ?1")
BigDecimal sumOrderAmount(Long userId);

// å¹³å‡å€¼
@Query("SELECT AVG(u.age) FROM User u WHERE u.department = ?1")
Double avgAgeByDept(String dept);

// æœ€å¤§æœ€å°å€¼
@Query("SELECT MAX(u.salary) FROM User u")
BigDecimal maxSalary();
```

**ğŸ“ˆ åˆ†ç»„ç»Ÿè®¡**ï¼š
```java
// æŒ‰éƒ¨é—¨ç»Ÿè®¡äººæ•°
@Query("SELECT u.department, COUNT(u) FROM User u GROUP BY u.department")
List<Object[]> countByDepartment();

// æŒ‰å¹´é¾„æ®µç»Ÿè®¡ï¼ˆéœ€è¦è‡ªå·±å¤„ç†ç»“æœï¼‰
@Query("SELECT CASE " +
       "WHEN u.age < 20 THEN '20å²ä»¥ä¸‹' " +
       "WHEN u.age < 30 THEN '20-30å²' " +
       "ELSE '30å²ä»¥ä¸Š' END, COUNT(u) " +
       "FROM User u GROUP BY CASE WHEN u.age < 20 THEN '20å²ä»¥ä¸‹' " +
       "WHEN u.age < 30 THEN '20-30å²' ELSE '30å²ä»¥ä¸Š' END")
List<Object[]> countByAgeGroup();
```

### 2.4 å…³è”æŸ¥è¯¢


**ğŸ”— ä¸€å¯¹å¤šå…³è”**ï¼š
```java
// æŸ¥è¯¢ç”¨æˆ·åŠå…¶è®¢å•ï¼ˆJOIN FETCHé¿å…N+1é—®é¢˜ï¼‰
@Query("SELECT u FROM User u LEFT JOIN FETCH u.orders WHERE u.id = ?1")
User findUserWithOrders(Long userId);

// å¤šè¡¨å…³è”æŸ¥è¯¢
@Query("SELECT u FROM User u " +
       "INNER JOIN u.orders o " +
       "WHERE o.status = ?1 AND u.age > ?2")
List<User> findUsersWithOrders(String orderStatus, Integer age);
```

**ğŸ’¡ å…³è”æŸ¥è¯¢ç†è§£**ï¼š
```
åœºæ™¯è¯´æ˜ï¼š
ç”¨æˆ·è¡¨ï¼ˆUserï¼‰ 1 : N è®¢å•è¡¨ï¼ˆOrderï¼‰
ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè®¢å•

å…³è”æ–¹å¼ï¼š
â€¢ JOIN FETCH - ä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰æ•°æ®ï¼ˆæ¨èï¼‰
â€¢ æ™®é€šJOIN - å¯èƒ½äº§ç”ŸN+1é—®é¢˜
â€¢ å­æŸ¥è¯¢ - é€‚åˆå¤æ‚æ¡ä»¶è¿‡æ»¤
```

---

## 3. ğŸ—„ï¸ åŸç”ŸSQLæŸ¥è¯¢


### 3.1 nativeQueryå‚æ•°è¯¦è§£


**ğŸ”¸ ä»€ä¹ˆæ—¶å€™ç”¨åŸç”ŸSQL**ï¼š
```
ä½¿ç”¨åœºæ™¯ï¼š
âœ… æ•°æ®åº“ç‰¹å®šå‡½æ•°ï¼ˆå¦‚MySQLçš„DATE_FORMATï¼‰
âœ… å¤æ‚çš„æ€§èƒ½ä¼˜åŒ–æŸ¥è¯¢
âœ… å·²æœ‰çš„SQLè¯­å¥ç›´æ¥å¤ç”¨
âœ… ç‰¹æ®Šçš„è¡¨è¿æ¥æ–¹å¼

æ³¨æ„äº‹é¡¹ï¼š
âš ï¸ å¤±å»äº†æ•°æ®åº“æ— å…³æ€§
âš ï¸ å­—æ®µåè¦ç”¨æ•°æ®åº“åˆ—åï¼Œä¸æ˜¯å±æ€§å
âš ï¸ è¡¨åè¦ç”¨çœŸå®è¡¨åï¼Œä¸æ˜¯å®ä½“ç±»å
```

**ğŸ’» åŸºæœ¬ä½¿ç”¨**ï¼š
```java
// å¼€å¯åŸç”ŸSQLæŸ¥è¯¢
@Query(value = "SELECT * FROM t_user WHERE user_name = ?1", 
       nativeQuery = true)
User findByUsernameNative(String username);

// ä½¿ç”¨æ•°æ®åº“ç‰¹å®šå‡½æ•°
@Query(value = "SELECT * FROM t_user WHERE DATE_FORMAT(create_time, '%Y-%m') = ?1",
       nativeQuery = true)
List<User> findByMonth(String month);
```

### 3.2 åŸç”ŸSQLè¿›é˜¶


**ğŸ”¸ å¤æ‚ç»Ÿè®¡æŸ¥è¯¢**ï¼š
```java
// å¤šè¡¨å…³è”ç»Ÿè®¡
@Query(value = "SELECT u.department, COUNT(*), AVG(o.amount) " +
               "FROM t_user u LEFT JOIN t_order o ON u.id = o.user_id " +
               "GROUP BY u.department", 
       nativeQuery = true)
List<Object[]> departmentOrderStats();

// å­æŸ¥è¯¢
@Query(value = "SELECT * FROM t_user WHERE age > " +
               "(SELECT AVG(age) FROM t_user)", 
       nativeQuery = true)
List<User> findAboveAvgAge();
```

**ğŸ“‹ ç»“æœé›†æ˜ å°„**ï¼š
```java
// æ–¹å¼1ï¼šè¿”å›Object[]æ•°ç»„
@Query(value = "SELECT user_name, age FROM t_user", nativeQuery = true)
List<Object[]> findUserInfo();

// æ–¹å¼2ï¼šä½¿ç”¨æ¥å£æŠ•å½±
public interface UserInfo {
    String getUsername();
    Integer getAge();
}

@Query(value = "SELECT user_name as username, age FROM t_user", 
       nativeQuery = true)
List<UserInfo> findUserInfoProjection();
```

---

## 4. ğŸ”— å‚æ•°ç»‘å®šæ–¹å¼


### 4.1 ä½ç½®å‚æ•°ç»‘å®š


**ğŸ”¸ ä½¿ç”¨?åŠ æ•°å­—å ä½ç¬¦**ï¼š
```java
// ?1 è¡¨ç¤ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ?2 è¡¨ç¤ºç¬¬äºŒä¸ªå‚æ•°
@Query("SELECT u FROM User u WHERE u.username = ?1 AND u.age = ?2")
List<User> findByParams(String username, Integer age);

// å‚æ•°é¡ºåºå¿…é¡»å¯¹åº”
// è°ƒç”¨ï¼šfindByParams("jack", 25)
//      usernameå¯¹åº”?1, ageå¯¹åº”?2
```

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
```
ä½ç½®å‚æ•°çš„é—®é¢˜ï¼š
âŒ å‚æ•°é¡ºåºæ”¹å˜ä¼šå‡ºé”™
âŒ å‚æ•°å¤šäº†å®¹æ˜“æ··æ·†
âŒ ä»£ç å¯è¯»æ€§å·®

å»ºè®®ï¼š
âœ… ç®€å•æŸ¥è¯¢ï¼ˆ1-2ä¸ªå‚æ•°ï¼‰å¯ä»¥ç”¨
âœ… å¤æ‚æŸ¥è¯¢å»ºè®®ç”¨å‘½åå‚æ•°
```

### 4.2 å‘½åå‚æ•°ç»‘å®š


**ğŸ¯ ä½¿ç”¨@Paramæ³¨è§£**ï¼š
```java
// ä½¿ç”¨:å‚æ•°åçš„æ–¹å¼
@Query("SELECT u FROM User u WHERE u.username = :name AND u.age > :minAge")
List<User> findByNamedParams(@Param("name") String username, 
                               @Param("minAge") Integer age);

// å‚æ•°åæ¸…æ™°ï¼Œé¡ºåºæ— å…³
// è°ƒç”¨ï¼šfindByNamedParams("jack", 18)
```

**âœ… å‘½åå‚æ•°çš„ä¼˜åŠ¿**ï¼š
```
å¥½å¤„ï¼š
1. ä»£ç å¯è¯»æ€§å¼º - ä¸€çœ¼çœ‹å‡ºå‚æ•°å«ä¹‰
2. å‚æ•°é¡ºåºæ— å…³ - è°ƒæ•´å‚æ•°ä½ç½®ä¸å½±å“
3. ç»´æŠ¤æ€§å¥½ - ä¿®æ”¹æŸ¥è¯¢æ¡ä»¶æ›´æ–¹ä¾¿
4. IDEå‹å¥½ - æ›´å¥½çš„ä»£ç æç¤º

æ¨èå†™æ³•ï¼š
@Query("SELECT u FROM User u " +
       "WHERE u.username = :username " +
       "AND u.age BETWEEN :minAge AND :maxAge " +
       "AND u.status = :status")
List<User> search(@Param("username") String name,
                  @Param("minAge") Integer min,
                  @Param("maxAge") Integer max,
                  @Param("status") String status);
```

### 4.3 é›†åˆå‚æ•°ç»‘å®š


**ğŸ“¦ INæŸ¥è¯¢ä½¿ç”¨é›†åˆ**ï¼š
```java
// ä¼ å…¥é›†åˆå‚æ•°
@Query("SELECT u FROM User u WHERE u.id IN :ids")
List<User> findByIds(@Param("ids") List<Long> ids);

// è°ƒç”¨ç¤ºä¾‹
List<Long> userIds = Arrays.asList(1L, 2L, 3L);
List<User> users = userRepository.findByIds(userIds);
```

---

## 5. ğŸš€ SpELè¡¨è¾¾å¼åº”ç”¨


### 5.1 ä»€ä¹ˆæ˜¯SpELè¡¨è¾¾å¼


**ğŸ¯ é€šä¿—ç†è§£**ï¼š
SpELï¼ˆSpring Expression Languageï¼‰æ˜¯Springçš„è¡¨è¾¾å¼è¯­è¨€ï¼Œåœ¨@Queryä¸­å¯ä»¥**åŠ¨æ€è·å–å®ä½“ç±»ä¿¡æ¯**ï¼Œè®©æŸ¥è¯¢æ›´åŠ çµæ´»ã€‚

**ğŸ’¡ æ ¸å¿ƒä½œç”¨**ï¼š
```
SpELåœ¨@Queryä¸­çš„ç”¨é€”ï¼š
âœ… åŠ¨æ€è·å–å®ä½“ç±»å - #{#entityName}
âœ… å¼•ç”¨å…¶ä»–Bean - å®ç°å¤æ‚é€»è¾‘
âœ… æ„å»ºåŠ¨æ€æŸ¥è¯¢ç‰‡æ®µ - æé«˜ä»£ç å¤ç”¨
```

**ğŸ”¸ åŸºç¡€è¯­æ³•**ï¼š
```java
// #{#entityName} ä¼šè¢«æ›¿æ¢ä¸ºå®é™…çš„å®ä½“ç±»å
@Query("SELECT e FROM #{#entityName} e WHERE e.status = ?1")
List<User> findByStatus(String status);

// å®é™…æ‰§è¡Œæ—¶å˜æˆï¼š
// SELECT e FROM User e WHERE e.status = ?1
```

### 5.2 åŠ¨æ€å®ä½“ååº”ç”¨


**ğŸ“ ä½¿ç”¨åœºæ™¯**ï¼š
```
é€‚ç”¨åœºæ™¯ï¼š
1. é€šç”¨Repositoryæ¥å£ - å¤šä¸ªå®ä½“å¤ç”¨åŒä¸€æŸ¥è¯¢
2. æŠ½è±¡çˆ¶ç±»æŸ¥è¯¢ - å­ç±»è‡ªåŠ¨é€‚é…å®ä½“å
3. æ¡†æ¶çº§åˆ«å°è£… - å‡å°‘é‡å¤ä»£ç 
```

**ğŸ’» å®æˆ˜ç¤ºä¾‹**ï¼š
```java
// é€šç”¨åŸºç¡€Repository
public interface BaseRepository<T, ID> extends JpaRepository<T, ID> {
    
    // ä½¿ç”¨#{#entityName}å®ç°é€šç”¨æŸ¥è¯¢
    @Query("SELECT e FROM #{#entityName} e WHERE e.status = :status")
    List<T> findByStatus(@Param("status") String status);
    
    // é€šç”¨çš„è½¯åˆ é™¤æŸ¥è¯¢
    @Query("SELECT e FROM #{#entityName} e WHERE e.deleted = false")
    List<T> findAllActive();
}

// å…·ä½“çš„Repositoryç›´æ¥ç»§æ‰¿
public interface UserRepository extends BaseRepository<User, Long> {
    // è‡ªåŠ¨è·å¾—findByStatuså’ŒfindAllActiveæ–¹æ³•
    // æŸ¥è¯¢æ—¶#{#entityName}ä¼šè¢«æ›¿æ¢ä¸ºUser
}

public interface OrderRepository extends BaseRepository<Order, Long> {
    // åŒæ ·è·å¾—è¿™äº›æ–¹æ³•
    // æŸ¥è¯¢æ—¶#{#entityName}ä¼šè¢«æ›¿æ¢ä¸ºOrder
}
```

### 5.3 å¼•ç”¨Beanå®ç°å¤æ‚é€»è¾‘


**ğŸ”§ è°ƒç”¨Spring Bean**ï¼š
```java
// å®šä¹‰ä¸€ä¸ªæŸ¥è¯¢æ¡ä»¶æ„å»ºå™¨Bean
@Component("queryBuilder")
public class QueryBuilder {
    public String buildUserCondition(String type) {
        if ("active".equals(type)) {
            return "u.status = 'ACTIVE' AND u.deleted = false";
        } else if ("vip".equals(type)) {
            return "u.level >= 3 AND u.status = 'ACTIVE'";
        }
        return "1=1";
    }
}

// åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨
@Query("SELECT u FROM User u WHERE #{@queryBuilder.buildUserCondition(?1)}")
List<User> findByType(String type);
```

**âš ï¸ ä½¿ç”¨æ³¨æ„**ï¼š
```
SpELçš„é™åˆ¶ï¼š
1. åªèƒ½åœ¨ç¼–è¯‘æ—¶ç¡®å®š - ä¸èƒ½å®Œå…¨åŠ¨æ€
2. è°ƒè¯•å›°éš¾ - è¡¨è¾¾å¼é”™è¯¯ä¸å¥½æ’æŸ¥
3. æ€§èƒ½è€ƒè™‘ - å¤æ‚è¡¨è¾¾å¼å½±å“æ€§èƒ½

å»ºè®®ï¼š
âœ… ç®€å•çš„åŠ¨æ€å®ä½“å - æ¨èä½¿ç”¨
âœ… å¤æ‚é€»è¾‘ - å»ºè®®ç”¨Specification
âœ… ä¿æŒç®€å• - ä¸è¦è¿‡åº¦ä½¿ç”¨
```

---

## 6. âœï¸ ä¿®æ”¹æŸ¥è¯¢æ“ä½œ


### 6.1 @Modifyingæ³¨è§£è¯¦è§£


**ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ**ï¼š
```
@Modifyingçš„ä½œç”¨ï¼š
æ ‡è®°è¿™æ˜¯ä¸€ä¸ªä¿®æ”¹æ“ä½œï¼ˆUPDATE/DELETEï¼‰ï¼Œä¸æ˜¯æŸ¥è¯¢
å‘Šè¯‰JPAéœ€è¦æ‰§è¡Œæ›´æ–°ï¼Œè€Œä¸æ˜¯è¿”å›ç»“æœé›†

å¿…é¡»é…åˆ@Queryä½¿ç”¨ï¼
```

**ğŸ’¡ åŸºæœ¬ä½¿ç”¨**ï¼š
```java
// æ›´æ–°æ“ä½œ
@Modifying
@Query("UPDATE User u SET u.status = ?1 WHERE u.id = ?2")
int updateStatus(String status, Long id);

// åˆ é™¤æ“ä½œ
@Modifying
@Query("DELETE FROM User u WHERE u.age < ?1")
int deleteByAge(Integer age);
```

### 6.2 äº‹åŠ¡æ§åˆ¶


**ğŸ”¸ @Transactionalé…åˆä½¿ç”¨**ï¼š
```java
// ä¿®æ”¹æ“ä½œå¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
@Modifying
@Transactional
@Query("UPDATE User u SET u.level = u.level + 1 WHERE u.id = ?1")
int upgradeMember(Long userId);

// æ‰¹é‡æ›´æ–°
@Modifying
@Transactional
@Query("UPDATE User u SET u.status = 'INACTIVE' WHERE u.lastLoginTime < ?1")
int disableInactiveUsers(LocalDateTime time);
```

**âš ï¸ é‡è¦æé†’**ï¼š
```
äº‹åŠ¡ç®¡ç†æ³¨æ„ç‚¹ï¼š

âŒ é”™è¯¯åšæ³•ï¼š
@Modifying  // ç¼ºå°‘@Transactional
@Query("UPDATE User...")
int update();  // è¿è¡Œæ—¶æŠ¥é”™ï¼

âœ… æ­£ç¡®åšæ³•ï¼š
@Modifying
@Transactional  // å¿…é¡»åŠ äº‹åŠ¡
@Query("UPDATE User...")
int update();

è¯´æ˜ï¼š
ä¿®æ”¹æ“ä½œå¿…é¡»åœ¨äº‹åŠ¡ä¸­ï¼Œå¦åˆ™JPAä¼šæŠ›å‡ºå¼‚å¸¸
å»ºè®®åœ¨Serviceå±‚ç»Ÿä¸€æ·»åŠ @Transactional
```

### 6.3 clearAutomaticallyå‚æ•°


**ğŸ”„ æ¸…é™¤æŒä¹…åŒ–ä¸Šä¸‹æ–‡**ï¼š
```java
// ä¿®æ”¹åæ¸…é™¤ç¼“å­˜
@Modifying(clearAutomatically = true)
@Transactional
@Query("UPDATE User u SET u.status = ?1 WHERE u.id = ?2")
int updateStatus(String status, Long id);
```

**ğŸ’¡ å‚æ•°è¯´æ˜**ï¼š
```
clearAutomatically = true çš„ä½œç”¨ï¼š

é—®é¢˜åœºæ™¯ï¼š
1. å…ˆæŸ¥è¯¢ç”¨æˆ· - ç”¨æˆ·è¿›å…¥ä¸€çº§ç¼“å­˜
2. æ‰§è¡Œ@Modifyingæ›´æ–° - æ•°æ®åº“å·²ä¿®æ”¹
3. å†æ¬¡æŸ¥è¯¢ç”¨æˆ· - è¿”å›çš„æ˜¯ç¼“å­˜ä¸­çš„æ—§æ•°æ®ï¼

è§£å†³æ–¹æ¡ˆï¼š
è®¾ç½®clearAutomatically = true
æ‰§è¡Œå®Œæ›´æ–°åè‡ªåŠ¨æ¸…é™¤EntityManagerçš„ç¼“å­˜
ä¸‹æ¬¡æŸ¥è¯¢ä¼šä»æ•°æ®åº“é‡æ–°åŠ è½½æœ€æ–°æ•°æ®

ä½¿ç”¨å»ºè®®ï¼š
âœ… æ›´æ–°åéœ€è¦ç«‹å³æŸ¥è¯¢ - è®¾ç½®ä¸ºtrue
âŒ çº¯ç²¹çš„æ›´æ–°æ“ä½œ - å¯ä»¥ä¸è®¾ç½®ï¼ˆé»˜è®¤falseï¼‰
```

### 6.4 æ‰¹é‡æ“ä½œä¼˜åŒ–


**ğŸ“Š æ‰¹é‡æ›´æ–°ç¤ºä¾‹**ï¼š
```java
// æ‰¹é‡æ›´æ–°ç”¨æˆ·ç­‰çº§
@Modifying
@Transactional
@Query("UPDATE User u SET u.level = :level WHERE u.id IN :ids")
int batchUpdateLevel(@Param("level") Integer level, 
                      @Param("ids") List<Long> ids);

// æ¡ä»¶æ‰¹é‡åˆ é™¤
@Modifying
@Transactional
@Query("DELETE FROM Order o WHERE o.status = :status " +
       "AND o.createTime < :time")
int cleanupOrders(@Param("status") String status, 
                   @Param("time") LocalDateTime time);
```

**ğŸ”¸ è¿”å›å€¼è¯´æ˜**ï¼š
```
ä¿®æ”¹æ“ä½œçš„è¿”å›å€¼ï¼š

intè¿”å›å€¼å«ä¹‰ï¼š
- è¡¨ç¤ºå—å½±å“çš„è®°å½•æ•°
- 0è¡¨ç¤ºæ²¡æœ‰è®°å½•è¢«ä¿®æ”¹
- >0è¡¨ç¤ºå®é™…ä¿®æ”¹çš„è®°å½•æ•°

ä½¿ç”¨ç¤ºä¾‹ï¼š
int count = userRepository.updateStatus("ACTIVE", 1L);
if (count > 0) {
    System.out.println("æ›´æ–°æˆåŠŸï¼Œå½±å“" + count + "æ¡è®°å½•");
} else {
    System.out.println("æ²¡æœ‰è®°å½•è¢«æ›´æ–°");
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ @Queryæ³¨è§£ï¼šè‡ªå®šä¹‰æŸ¥è¯¢çš„æ ¸å¿ƒå·¥å…·
ğŸ”¸ JPQL vs SQLï¼šé¢å‘å¯¹è±¡ vs é¢å‘è¡¨
ğŸ”¸ å‚æ•°ç»‘å®šï¼šä½ç½®å‚æ•°(?1) vs å‘½åå‚æ•°(:name)
ğŸ”¸ SpELè¡¨è¾¾å¼ï¼š#{#entityName}åŠ¨æ€å®ä½“å
ğŸ”¸ @Modifyingï¼šæ ‡è®°ä¿®æ”¹æ“ä½œï¼Œé…åˆ@Transactionalä½¿ç”¨
```

### 7.2 æŸ¥è¯¢æ–¹å¼é€‰æ‹©æŒ‡å—


**ğŸ¯ å†³ç­–æµç¨‹**ï¼š
```
æŸ¥è¯¢éœ€æ±‚åˆ†æï¼š
    â†“
ç®€å•æ¡ä»¶æŸ¥è¯¢ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ æ–¹æ³•å‘½åæŸ¥è¯¢
  â””â”€ å¦ â†’ ç»§ç»­åˆ¤æ–­
         â†“
     å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Ÿ
       â”œâ”€ æ˜¯ â†’ JPQL @Query
       â””â”€ å¦ â†’ ç»§ç»­åˆ¤æ–­
              â†“
          éœ€è¦æ•°æ®åº“ç‰¹å®šåŠŸèƒ½ï¼Ÿ
            â”œâ”€ æ˜¯ â†’ åŸç”ŸSQL (nativeQuery=true)
            â””â”€ å¦ â†’ åŠ¨æ€æ¡ä»¶ï¼Ÿ
                   â”œâ”€ æ˜¯ â†’ Specification
                   â””â”€ å¦ â†’ JPQL @Query
```

### 7.3 æœ€ä½³å®è·µå»ºè®®


**âœ… æ¨èåšæ³•**ï¼š

| åœºæ™¯ | **æ¨èæ–¹æ¡ˆ** | **åŸå› ** |
|------|-------------|---------|
| ğŸ”¸ **ç®€å•æŸ¥è¯¢** | `æ–¹æ³•å‘½å` | ç®€æ´ç›´è§‚ï¼Œä»£ç å°‘ |
| ğŸ”¸ **å¤æ‚æ¡ä»¶** | `JPQL @Query` | çµæ´»æ¸…æ™°ï¼Œæ˜“ç»´æŠ¤ |
| ğŸ”¸ **ç»Ÿè®¡åˆ†æ** | `JPQLèšåˆ` | é¢å‘å¯¹è±¡ï¼Œæ•°æ®åº“æ— å…³ |
| ğŸ”¸ **æ€§èƒ½ä¼˜åŒ–** | `åŸç”ŸSQL` | ä½¿ç”¨æ•°æ®åº“ç‰¹æ€§ |
| ğŸ”¸ **åŠ¨æ€æŸ¥è¯¢** | `Specification` | ç±»å‹å®‰å…¨ï¼Œå®Œå…¨åŠ¨æ€ |

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
```
å¸¸è§é™·é˜±ï¼š
1. å¿˜è®°@Transactionalå¯¼è‡´ä¿®æ”¹æ“ä½œå¤±è´¥
2. æ··æ·†JPQLå’ŒSQLçš„è¯­æ³•ï¼ˆå®ä½“å vs è¡¨åï¼‰
3. N+1æŸ¥è¯¢é—®é¢˜ï¼ˆè®°å¾—ç”¨JOIN FETCHï¼‰
4. åŸç”ŸSQLå¤±å»æ•°æ®åº“æ— å…³æ€§

æ€§èƒ½ä¼˜åŒ–ï¼š
1. å¤æ‚æŸ¥è¯¢è€ƒè™‘ç´¢å¼•
2. å¤§æ•°æ®é‡ç”¨åˆ†é¡µ
3. é¿å…SELECT * 
4. æ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“äº¤äº’
```

### 7.4 å­¦ä¹ æ£€æŸ¥æ¸…å•


```
âœ… å­¦ä¹ éªŒè¯ï¼š
- [ ] èƒ½è§£é‡Š@Queryå’Œæ–¹æ³•å‘½åçš„åŒºåˆ«
- [ ] èƒ½å†™å‡ºJPQLå’ŒåŸç”ŸSQLæŸ¥è¯¢
- [ ] ç†è§£ä½ç½®å‚æ•°å’Œå‘½åå‚æ•°çš„ä½¿ç”¨
- [ ] æŒæ¡SpELè¡¨è¾¾å¼#{#entityName}çš„ä½œç”¨
- [ ] ä¼šä½¿ç”¨@Modifyingæ‰§è¡Œæ›´æ–°æ“ä½œ
- [ ] ç†è§£clearAutomaticallyçš„ç”¨é€”
- [ ] èƒ½æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„æŸ¥è¯¢æ–¹å¼
```

**ğŸ§  è®°å¿†å£è¯€**ï¼š
```
æŸ¥è¯¢æ³¨è§£@Queryç”¨ï¼ŒJPQLé¢å‘å¯¹è±¡èµ°
å‚æ•°ç»‘å®šå‘½åå¥½ï¼ŒSpELåŠ¨æ€å®ä½“å
ä¿®æ”¹æ“ä½œModifyingï¼Œäº‹åŠ¡ç®¡ç†ä¸èƒ½å¿˜
æ¸…é™¤ç¼“å­˜è¦è®°å¾—ï¼Œæ‰¹é‡æ›´æ–°æ•ˆç‡é«˜
```

**æ ¸å¿ƒç†è§£**ï¼š
- @Queryè®©æŸ¥è¯¢æ›´çµæ´»ï¼Œä½†è¦æŒæ¡JPQLå’ŒSQLçš„åŒºåˆ«
- å‚æ•°ç»‘å®šä¼˜å…ˆç”¨å‘½åå‚æ•°ï¼Œä»£ç æ›´æ¸…æ™°
- SpELä¸»è¦ç”¨äºåŠ¨æ€å®ä½“åï¼Œä¸è¦è¿‡åº¦ä½¿ç”¨
- ä¿®æ”¹æ“ä½œå¿…é¡»åŠ @Modifyingå’Œ@Transactional
- æ ¹æ®å®é™…åœºæ™¯é€‰æ‹©æœ€åˆé€‚çš„æŸ¥è¯¢æ–¹å¼