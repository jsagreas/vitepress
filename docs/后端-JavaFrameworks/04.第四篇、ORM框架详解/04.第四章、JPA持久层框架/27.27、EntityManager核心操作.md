---
title: 27ã€EntityManageræ ¸å¿ƒæ“ä½œ
---
## ğŸ“š ç›®å½•

1. [EntityManageræ˜¯ä»€ä¹ˆ](#1-EntityManageræ˜¯ä»€ä¹ˆ)
2. [persistä¿å­˜æ“ä½œ](#2-persistä¿å­˜æ“ä½œ)
3. [findç«‹å³æŸ¥è¯¢](#3-findç«‹å³æŸ¥è¯¢)
4. [getReferenceæ‡’åŠ è½½å¼•ç”¨](#4-getReferenceæ‡’åŠ è½½å¼•ç”¨)
5. [mergeåˆå¹¶æ“ä½œ](#5-mergeåˆå¹¶æ“ä½œ)
6. [removeåˆ é™¤æ“ä½œ](#6-removeåˆ é™¤æ“ä½œ)
7. [detachåˆ†ç¦»æ“ä½œ](#7-detachåˆ†ç¦»æ“ä½œ)
8. [refreshåˆ·æ–°æ“ä½œ](#8-refreshåˆ·æ–°æ“ä½œ)
9. [flushå¼ºåˆ¶åŒæ­¥](#9-flushå¼ºåˆ¶åŒæ­¥)
10. [clearæ¸…ç©ºä¸Šä¸‹æ–‡](#10-clearæ¸…ç©ºä¸Šä¸‹æ–‡)
11. [APIå¯¹æ¯”ä¸é€‰æ‹©](#11-APIå¯¹æ¯”ä¸é€‰æ‹©)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ EntityManageræ˜¯ä»€ä¹ˆ


### 1.1 ç”Ÿæ´»åŒ–ç†è§£


**æƒ³è±¡ä¸€ä¸ªå›¾ä¹¦ç®¡ç†å‘˜**ï¼š
```
ä½ ï¼ˆç¨‹åºå‘˜ï¼‰          å›¾ä¹¦ç®¡ç†å‘˜ï¼ˆEntityManagerï¼‰        å›¾ä¹¦é¦†ï¼ˆæ•°æ®åº“ï¼‰
     |                        |                              |
  å€Ÿä¹¦è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> å¸®ä½ æ‰¾ä¹¦ã€ç™»è®° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> å®é™…å–ä¹¦
  è¿˜ä¹¦è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> å¸®ä½ åŠç†è¿˜ä¹¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> å®é™…å½’è¿˜
  æŸ¥è¯¢å›¾ä¹¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æŸ¥è¯¢ç›®å½•ã€è®°å½• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æ£€ç´¢å›¾ä¹¦
```

**EntityManagerå°±æ˜¯è¿™ä¸ª"ç®¡ç†å‘˜"**ï¼š
- ğŸ”¸ å®ƒå¸®ä½ ç®¡ç†Javaå¯¹è±¡å’Œæ•°æ®åº“ä¹‹é—´çš„äº¤äº’
- ğŸ”¸ ä½ ä¸éœ€è¦ç›´æ¥å†™SQLï¼Œåªéœ€è¦å‘Šè¯‰å®ƒè¦åšä»€ä¹ˆ
- ğŸ”¸ å®ƒè´Ÿè´£æŠŠä½ çš„æ“ä½œç¿»è¯‘æˆæ•°æ®åº“èƒ½ç†è§£çš„è¯­è¨€

### 1.2 æ ¸å¿ƒæ¦‚å¿µ


> ğŸ’¡ **EntityManagerï¼ˆå®ä½“ç®¡ç†å™¨ï¼‰**ï¼šJPAä¸­è´Ÿè´£ç®¡ç†å®ä½“ç”Ÿå‘½å‘¨æœŸçš„æ ¸å¿ƒæ¥å£ï¼Œå°±åƒä¸€ä¸ª"æ™ºèƒ½ä¸­ä»‹"ï¼Œå¸®ä½ å¤„ç†Javaå¯¹è±¡å’Œæ•°æ®åº“è®°å½•ä¹‹é—´çš„æ‰€æœ‰æ“ä½œã€‚

**ä¸»è¦èŒè´£**ï¼š
- â‘  **å¯¹è±¡æŒä¹…åŒ–**ï¼šæŠŠJavaå¯¹è±¡ä¿å­˜åˆ°æ•°æ®åº“
- â‘¡ **å¯¹è±¡æŸ¥è¯¢**ï¼šä»æ•°æ®åº“è¯»å–æ•°æ®å˜æˆJavaå¯¹è±¡
- â‘¢ **çŠ¶æ€ç®¡ç†**ï¼šè·Ÿè¸ªå¯¹è±¡çš„å˜åŒ–ï¼Œè‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“
- â‘£ **ç¼“å­˜ç®¡ç†**ï¼šåœ¨å†…å­˜ä¸­ç¼“å­˜å¯¹è±¡ï¼Œæé«˜æ€§èƒ½

---

## 2. ğŸ’¾ persistä¿å­˜æ“ä½œ


### 2.1 ä»€ä¹ˆæ˜¯persist


> **persist** = åšæŒã€æŒä¹…åŒ–ï¼ŒæŠŠä¸€ä¸ª**æ–°åˆ›å»º**çš„å¯¹è±¡ä¿å­˜åˆ°æ•°æ®åº“

**é€šä¿—ç†è§£**ï¼š
```
å°±åƒä½ å†™äº†ä¸€ç¯‡æ–°æ—¥è®°ï¼š
â‘  ä½ åœ¨æœ¬å­ä¸Šå†™å¥½å†…å®¹ï¼ˆåˆ›å»ºJavaå¯¹è±¡ï¼‰
â‘¡ è°ƒç”¨persistï¼ˆå‘Šè¯‰ç®¡ç†å‘˜"è¿™æ˜¯æ–°æ—¥è®°ï¼Œè¯·ä¿å­˜"ï¼‰
â‘¢ ç®¡ç†å‘˜ä¼šåœ¨åˆé€‚çš„æ—¶æœºæŠŠå®ƒå­˜å…¥æ•°æ®åº“ï¼ˆæ‰§è¡ŒINSERTè¯­å¥ï¼‰
```

### 2.2 åŸºæœ¬ç”¨æ³•


```java
// åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·å¯¹è±¡
User user = new User();
user.setName("å¼ ä¸‰");
user.setAge(25);

// ä¿å­˜åˆ°æ•°æ®åº“
entityManager.persist(user);

// ğŸ“Œ æ³¨æ„ï¼šæ­¤æ—¶å¯èƒ½è¿˜æ²¡æœ‰çœŸæ­£æ‰§è¡ŒINSERT
// åªæ˜¯æŠŠå¯¹è±¡æ ‡è®°ä¸º"å¾…ä¿å­˜"çŠ¶æ€
```

### 2.3 persistçš„ç‰¹ç‚¹


| ç‰¹ç‚¹ | **è¯´æ˜** | **æ–°æ‰‹ç†è§£** |
|------|---------|-------------|
| ğŸ”¸ **åªèƒ½ä¿å­˜æ–°å¯¹è±¡** | `å¯¹è±¡å¿…é¡»æ˜¯newå‡ºæ¥çš„` | `ä¸èƒ½ç”¨æ¥æ›´æ–°å·²æœ‰æ•°æ®` |
| ğŸ”¸ **å»¶è¿Ÿæ‰§è¡Œ** | `ä¸ä¼šç«‹å³æ‰§è¡ŒSQL` | `ç­‰åˆ°flushæˆ–äº‹åŠ¡æäº¤æ—¶æ‰çœŸæ­£ä¿å­˜` |
| ğŸ”¸ **ä¼šç”ŸæˆID** | `ä¿å­˜åå¯¹è±¡ä¼šè·å¾—ä¸»é”®å€¼` | `åŸæœ¬nullçš„IDä¼šè¢«èµ‹å€¼` |
| ğŸ”¸ **çº§è”ä¿å­˜** | `å¯ä»¥çº§è”ä¿å­˜å…³è”å¯¹è±¡` | `ä¸€æ¬¡æ“ä½œä¿å­˜å¤šä¸ªç›¸å…³å¯¹è±¡` |

### 2.4 å¸¸è§åœºæ™¯ç¤ºä¾‹


**åœºæ™¯â‘ ï¼šä¿å­˜å•ä¸ªå¯¹è±¡**
```java
User user = new User("æå››", 28);
entityManager.persist(user);
// userå¯¹è±¡ç°åœ¨å¤„äº"æ‰˜ç®¡çŠ¶æ€"ï¼Œè¢«EntityManagerç®¡ç†

System.out.println(user.getId()); // å¯èƒ½è¾“å‡ºï¼š1ï¼ˆè‡ªåŠ¨ç”Ÿæˆçš„IDï¼‰
```

**åœºæ™¯â‘¡ï¼šçº§è”ä¿å­˜å…³è”å¯¹è±¡**
```java
// ç”¨æˆ·å‘è¡¨äº†ä¸€ç¯‡æ–‡ç« 
User user = new User("ç‹äº”", 30);
Article article = new Article("JPAå­¦ä¹ ç¬”è®°");
article.setAuthor(user); // å…³è”å…³ç³»

entityManager.persist(user);
// å¦‚æœé…ç½®äº†çº§è”ä¿å­˜ï¼Œarticleä¹Ÿä¼šè‡ªåŠ¨ä¿å­˜
```

**åœºæ™¯â‘¢ï¼špersiståå¯¹è±¡çš„å˜åŒ–**
```java
User user = new User("èµµå…­", 22);
System.out.println(user.getId()); // nullï¼ˆä¿å­˜å‰æ²¡æœ‰IDï¼‰

entityManager.persist(user);
System.out.println(user.getId()); // 1ï¼ˆä¿å­˜åè‡ªåŠ¨ç”ŸæˆIDï¼‰

// æ­¤åå¯¹userçš„ä¿®æ”¹ä¼šè¢«è‡ªåŠ¨è¿½è¸ª
user.setAge(23); // è¿™ä¸ªä¿®æ”¹ä¼šåœ¨flushæ—¶è‡ªåŠ¨æ›´æ–°åˆ°æ•°æ®åº“
```

### 2.5 æ³¨æ„äº‹é¡¹


> âš ï¸ **persiståªèƒ½ç”¨äºæ–°å¯¹è±¡**

```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šå¯¹å·²å­˜åœ¨çš„å¯¹è±¡ä½¿ç”¨persist
User user = entityManager.find(User.class, 1L); // æŸ¥è¯¢å·²å­˜åœ¨çš„å¯¹è±¡
user.setName("æ–°åå­—");
entityManager.persist(user); // ğŸš« ä¼šæŠ¥é”™ï¼persistä¸èƒ½ç”¨äºå·²å­˜åœ¨çš„å¯¹è±¡

// âœ… æ­£ç¡®åšæ³•ï¼šå·²å­˜åœ¨çš„å¯¹è±¡ä¿®æ”¹åä¼šè‡ªåŠ¨åŒæ­¥
User user = entityManager.find(User.class, 1L);
user.setName("æ–°åå­—"); // ç›´æ¥ä¿®æ”¹ï¼ŒEntityManagerä¼šè‡ªåŠ¨è¿½è¸ª
// äº‹åŠ¡æäº¤æ—¶è‡ªåŠ¨æ‰§è¡ŒUPDATE
```

---

## 3. ğŸ” findç«‹å³æŸ¥è¯¢


### 3.1 ä»€ä¹ˆæ˜¯find


> **find** = æŸ¥æ‰¾ï¼Œæ ¹æ®ä¸»é”®IDç«‹å³ä»æ•°æ®åº“æŸ¥è¯¢å¯¹è±¡

**é€šä¿—ç†è§£**ï¼š
```
å°±åƒåœ¨å›¾ä¹¦é¦†æ‰¾ä¹¦ï¼š
â‘  ä½ å‘Šè¯‰ç®¡ç†å‘˜ä¹¦çš„ç¼–å·ï¼ˆä¸»é”®IDï¼‰
â‘¡ ç®¡ç†å‘˜ç«‹åˆ»å»ä¹¦æ¶ä¸Šæ‰¾ï¼ˆæŸ¥è¯¢æ•°æ®åº“ï¼‰
â‘¢ æ‰¾åˆ°åé©¬ä¸Šç»™ä½ ï¼ˆè¿”å›å®Œæ•´å¯¹è±¡ï¼‰
â‘£ å¦‚æœæ‰¾ä¸åˆ°å°±å‘Šè¯‰ä½ "æ²¡æœ‰"ï¼ˆè¿”å›nullï¼‰
```

### 3.2 åŸºæœ¬ç”¨æ³•


```java
// æ ¹æ®IDæŸ¥è¯¢ç”¨æˆ·
User user = entityManager.find(User.class, 1L);

if (user != null) {
    System.out.println(user.getName()); // å¯ä»¥ç›´æ¥ä½¿ç”¨
} else {
    System.out.println("ç”¨æˆ·ä¸å­˜åœ¨");
}
```

### 3.3 findçš„å·¥ä½œæµç¨‹


```
è°ƒç”¨findæ–¹æ³•
    â†“
å…ˆæŸ¥ä¸€çº§ç¼“å­˜ï¼ˆEntityManagerå†…éƒ¨ï¼‰
    â†“
æ‰¾åˆ°äº†ï¼Ÿ â”€â”€â†’ æ˜¯ â”€â”€â†’ ç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„å¯¹è±¡
    â†“
   å¦
    â†“
ç«‹å³æ‰§è¡ŒSELECTæŸ¥è¯¢æ•°æ®åº“
    â†“
æ‰¾åˆ°äº†ï¼Ÿ â”€â”€â†’ æ˜¯ â”€â”€â†’ è½¬æ¢æˆå¯¹è±¡ï¼Œæ”¾å…¥ç¼“å­˜ï¼Œè¿”å›
    â†“
   å¦
    â†“
è¿”å›null
```

### 3.4 findçš„ç‰¹ç‚¹


| ç‰¹ç‚¹ | **è¯´æ˜** | **å®é™…æ•ˆæœ** |
|------|---------|-------------|
| âš¡ **ç«‹å³åŠ è½½** | `è°ƒç”¨åç«‹åˆ»æŸ¥è¯¢æ•°æ®åº“` | `æ–¹æ³•è¿”å›æ—¶æ•°æ®å·²ç»åŠ è½½å®Œæˆ` |
| ğŸ”¸ **è¿”å›å®ä½“å¯¹è±¡** | `è¿”å›çš„æ˜¯å®Œæ•´çš„Javaå¯¹è±¡` | `æ‰€æœ‰å±æ€§éƒ½å·²ç»èµ‹å€¼å¥½äº†` |
| ğŸ”¸ **å¯èƒ½è¿”å›null** | `æ‰¾ä¸åˆ°æ—¶è¿”å›null` | `éœ€è¦åˆ¤ç©ºå¤„ç†` |
| ğŸ’¾ **æ”¯æŒç¼“å­˜** | `ä¼˜å…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰¾` | `åŒä¸€å¯¹è±¡å¤šæ¬¡æŸ¥è¯¢åªæ‰§è¡Œä¸€æ¬¡SQL` |

### 3.5 å®ç”¨åœºæ™¯


**åœºæ™¯â‘ ï¼šæ ¹æ®IDè·å–å¯¹è±¡**
```java
// è·å–IDä¸º1çš„ç”¨æˆ·ä¿¡æ¯
User user = entityManager.find(User.class, 1L);
System.out.println(user.getName()); // ç›´æ¥ä½¿ç”¨ï¼Œä¸ä¼šæœ‰æ‡’åŠ è½½é—®é¢˜
```

**åœºæ™¯â‘¡ï¼šåˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜åœ¨**
```java
User user = entityManager.find(User.class, 999L);
if (user == null) {
    System.out.println("ç”¨æˆ·ä¸å­˜åœ¨ï¼Œå¯ä»¥åˆ›å»ºæ–°ç”¨æˆ·");
}
```

**åœºæ™¯â‘¢ï¼šç¼“å­˜çš„ä½œç”¨**
```java
// ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼šæ‰§è¡ŒSQL
User user1 = entityManager.find(User.class, 1L);
// SELECT * FROM user WHERE id = 1

// ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼šä¸æ‰§è¡ŒSQLï¼Œç›´æ¥ä»ç¼“å­˜è¿”å›
User user2 = entityManager.find(User.class, 1L);
// ä¸æ‰§è¡ŒSQL

System.out.println(user1 == user2); // trueï¼ˆåŒä¸€ä¸ªå¯¹è±¡å®ä¾‹ï¼‰
```

---

## 4. ğŸ·ï¸ getReferenceæ‡’åŠ è½½å¼•ç”¨


### 4.1 ä»€ä¹ˆæ˜¯getReference


> **getReference** = è·å–å¼•ç”¨ï¼Œè¿”å›ä¸€ä¸ª"ç©ºå£³"å¯¹è±¡ï¼Œç­‰çœŸæ­£ä½¿ç”¨æ—¶æ‰æŸ¥è¯¢æ•°æ®åº“

**é€šä¿—ç†è§£**ï¼š
```
å°±åƒè®¢ä¹¦ï¼š
â‘  ä½ å‘Šè¯‰ç®¡ç†å‘˜è¦å“ªæœ¬ä¹¦ï¼ˆè°ƒç”¨getReferenceï¼‰
â‘¡ ç®¡ç†å‘˜ç»™ä½ ä¸€å¼ "å€Ÿä¹¦å•"ï¼ˆä»£ç†å¯¹è±¡ï¼‰ï¼Œä½†ä¸å»æ‹¿ä¹¦
â‘¢ ç­‰ä½ çœŸæ­£è¦çœ‹ä¹¦æ—¶ï¼ˆè®¿é—®å±æ€§ï¼‰
â‘£ ç®¡ç†å‘˜æ‰å»ä¹¦æ¶æ‹¿ä¹¦ï¼ˆæŸ¥è¯¢æ•°æ®åº“ï¼‰
```

### 4.2 find vs getReferenceå¯¹æ¯”


```
findï¼ˆç«‹å³æŸ¥è¯¢ï¼‰ï¼š
User user = entityManager.find(User.class, 1L);
â”€â†’ ç«‹åˆ»æ‰§è¡ŒSQL
â”€â†’ è¿”å›çœŸå®å¯¹è±¡
â”€â†’ å¯ä»¥ç›´æ¥ä½¿ç”¨

getReferenceï¼ˆæ‡’åŠ è½½ï¼‰ï¼š
User user = entityManager.getReference(User.class, 1L);
â”€â†’ ä¸æ‰§è¡ŒSQL
â”€â†’ è¿”å›ä»£ç†å¯¹è±¡ï¼ˆç©ºå£³ï¼‰
â”€â†’ è®¿é—®å±æ€§æ—¶æ‰çœŸæ­£åŠ è½½
```

### 4.3 åŸºæœ¬ç”¨æ³•


```java
// è·å–æ‡’åŠ è½½å¼•ç”¨
User userRef = entityManager.getReference(User.class, 1L);
// æ­¤æ—¶è¿˜æ²¡æœ‰æ‰§è¡ŒSQL

System.out.println(userRef.getClass()); 
// è¾“å‡ºï¼šUser$HibernateProxy$xxxï¼ˆä»£ç†ç±»ï¼‰

// å½“è®¿é—®å±æ€§æ—¶æ‰æ‰§è¡ŒSQL
String name = userRef.getName(); 
// ç°åœ¨æ‰æ‰§è¡Œï¼šSELECT * FROM user WHERE id = 1
```

### 4.4 getReferenceçš„ç‰¹ç‚¹


| ç‰¹ç‚¹ | **è¯´æ˜** | **ä½¿ç”¨åœºæ™¯** |
|------|---------|-------------|
| ğŸš€ **å»¶è¿ŸåŠ è½½** | `è°ƒç”¨æ—¶ä¸æŸ¥æ•°æ®åº“` | `åªéœ€è¦è®¾ç½®å¤–é”®å…³è”æ—¶` |
| ğŸ”¸ **è¿”å›ä»£ç†** | `è¿”å›çš„æ˜¯ä»£ç†å¯¹è±¡` | `ä¸æ˜¯çœŸå®çš„å®ä½“å¯¹è±¡` |
| âš ï¸ **å¯èƒ½æŠ›å¼‚å¸¸** | `IDä¸å­˜åœ¨æ—¶è®¿é—®å±æ€§ä¼šæŠ¥é”™` | `EntityNotFoundException` |
| ğŸ’¾ **èŠ‚çœèµ„æº** | `ä¸éœ€è¦æ—¶ä¸æŸ¥è¯¢` | `æé«˜æ€§èƒ½` |

### 4.5 å®ç”¨åœºæ™¯


**åœºæ™¯â‘ ï¼šåªéœ€è¦è®¾ç½®å…³è”å…³ç³»**
```java
// âŒ ä½¿ç”¨findï¼šä¼šç«‹å³æŸ¥è¯¢å®Œæ•´ç”¨æˆ·ä¿¡æ¯ï¼ˆæµªè´¹ï¼‰
User author = entityManager.find(User.class, 1L);
Article article = new Article("æ ‡é¢˜");
article.setAuthor(author); // åªæ˜¯ä¸ºäº†è®¾ç½®å¤–é”®
entityManager.persist(article);

// âœ… ä½¿ç”¨getReferenceï¼šä¸æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆé«˜æ•ˆï¼‰
User author = entityManager.getReference(User.class, 1L);
Article article = new Article("æ ‡é¢˜");
article.setAuthor(author); // åªæ˜¯ä¸ºäº†è®¾ç½®å¤–é”®
entityManager.persist(article);
```

**åœºæ™¯â‘¡ï¼šæ‡’åŠ è½½çš„é™·é˜±**
```java
User userRef = entityManager.getReference(User.class, 999L);
// æ­¤æ—¶ä¸æŠ¥é”™ï¼Œå› ä¸ºè¿˜æ²¡æŸ¥æ•°æ®åº“

// âŒ å½“è®¿é—®å±æ€§æ—¶æ‰å‘ç°IDä¸å­˜åœ¨
try {
    String name = userRef.getName(); // æŠ›å‡ºEntityNotFoundException
} catch (EntityNotFoundException e) {
    System.out.println("ç”¨æˆ·ä¸å­˜åœ¨");
}
```

**åœºæ™¯â‘¢ï¼šä»€ä¹ˆæ—¶å€™ç”¨getReference**
```java
// âœ… é€‚åˆï¼šæ‰¹é‡è®¾ç½®å…³è”ï¼Œä¸éœ€è¦å¯¹è±¡æ•°æ®
for (Long userId : userIds) {
    User user = entityManager.getReference(User.class, userId);
    // ä¸è®¿é—®userçš„å±æ€§ï¼Œåªç”¨æ¥è®¾ç½®å…³è”
    someOperation.setUser(user);
}

// âŒ ä¸é€‚åˆï¼šéœ€è¦ç«‹å³ä½¿ç”¨å¯¹è±¡æ•°æ®
User user = entityManager.getReference(User.class, 1L);
System.out.println(user.getName()); // è¿˜æ˜¯ä¼šæŸ¥æ•°æ®åº“ï¼Œä¸å¦‚ç›´æ¥ç”¨find
```

---

## 5. ğŸ”„ mergeåˆå¹¶æ“ä½œ


### 5.1 ä»€ä¹ˆæ˜¯merge


> **merge** = åˆå¹¶ï¼ŒæŠŠä¸€ä¸ª**æ¸¸ç¦»çŠ¶æ€**çš„å¯¹è±¡"åˆå¹¶"å›æŒä¹…åŒ–ä¸Šä¸‹æ–‡

**é€šä¿—ç†è§£**ï¼š
```
å°±åƒä½ å¸¦ç€ä¿®æ”¹åçš„æ–‡ä»¶å›åˆ°åŠå…¬å®¤ï¼š
â‘  ä½ åœ¨å®¶é‡Œä¿®æ”¹äº†æ–‡ä»¶ï¼ˆæ¸¸ç¦»çŠ¶æ€çš„å¯¹è±¡ï¼‰
â‘¡ å›åˆ°å…¬å¸è°ƒç”¨mergeï¼ˆåˆå¹¶åˆ°ç®¡ç†ç³»ç»Ÿï¼‰
â‘¢ ç³»ç»Ÿæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ â”€â”€â†’ å­˜åœ¨ï¼šæ›´æ–° / ä¸å­˜åœ¨ï¼šæ’å…¥
â‘£ è¿”å›ä¸€ä¸ªå—ç®¡ç†çš„å‰¯æœ¬
```

### 5.2 ä»€ä¹ˆæ—¶å€™éœ€è¦merge


```
å¯¹è±¡çš„ä¸‰ç§çŠ¶æ€ï¼š

â‘  ç¬æ—¶çŠ¶æ€ï¼ˆTransientï¼‰
   â””â”€ newå‡ºæ¥çš„å¯¹è±¡ï¼Œæ²¡æœ‰IDï¼Œæ•°æ®åº“é‡Œä¹Ÿæ²¡æœ‰

â‘¡ æŒä¹…åŒ–çŠ¶æ€ï¼ˆManaged/Persistentï¼‰
   â””â”€ è¢«EntityManagerç®¡ç†ï¼Œæ•°æ®åº“æœ‰å¯¹åº”è®°å½•

â‘¢ æ¸¸ç¦»çŠ¶æ€ï¼ˆDetachedï¼‰
   â””â”€ æ›¾ç»è¢«ç®¡ç†è¿‡ï¼Œä½†ç°åœ¨è„±ç¦»äº†ç®¡ç†
   â””â”€ æ¯”å¦‚ï¼šä»å…¶ä»–åœ°æ–¹ä¼ è¿‡æ¥çš„å¯¹è±¡ã€Sessionå…³é—­åçš„å¯¹è±¡
```

**mergeå°±æ˜¯ç”¨æ¥å¤„ç†"æ¸¸ç¦»çŠ¶æ€"å¯¹è±¡çš„**ï¼š
```
æ¸¸ç¦»å¯¹è±¡ï¼ˆæœ‰IDï¼Œä½†ä¸å—ç®¡ç†ï¼‰
    â†“
è°ƒç”¨merge
    â†“
è¿”å›ä¸€ä¸ªæ–°çš„æ‰˜ç®¡å¯¹è±¡ï¼ˆå—EntityManagerç®¡ç†ï¼‰
```

### 5.3 åŸºæœ¬ç”¨æ³•


```java
// å‡è®¾è¿™æ˜¯ä¸€ä¸ªæ¸¸ç¦»çŠ¶æ€çš„å¯¹è±¡ï¼ˆä»å…¶ä»–åœ°æ–¹ä¼ æ¥çš„ï¼‰
User detachedUser = new User();
detachedUser.setId(1L);  // æœ‰ID
detachedUser.setName("æ–°åå­—");
detachedUser.setAge(30);

// åˆå¹¶åˆ°æŒä¹…åŒ–ä¸Šä¸‹æ–‡
User managedUser = entityManager.merge(detachedUser);

// ğŸ“Œ é‡è¦ï¼šè¿”å›çš„managedUseræ‰æ˜¯å—ç®¡ç†çš„å¯¹è±¡
// detachedUserä»ç„¶æ˜¯æ¸¸ç¦»çŠ¶æ€
```

### 5.4 mergeçš„å·¥ä½œæµç¨‹


```
è°ƒç”¨merge(å¯¹è±¡)
    â†“
æ£€æŸ¥å¯¹è±¡æ˜¯å¦æœ‰IDï¼Ÿ
    â†“
æœ‰ID â”€â”€â†’ æ•°æ®åº“å­˜åœ¨ï¼Ÿ â”€â”€â†’ æ˜¯ â”€â”€â†’ æ‰§è¡ŒUPDATE
    â†“                              â””â”€ è¿”å›æ‰˜ç®¡å¯¹è±¡
   å¦                      â†“
    â†“                     å¦
    â†“                      â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ‰§è¡ŒINSERT
                          â””â”€ è¿”å›æ‰˜ç®¡å¯¹è±¡
```

### 5.5 merge vs persist å¯¹æ¯”


| æ“ä½œ | **persist** | **merge** |
|------|------------|-----------|
| ğŸ”¸ **é€‚ç”¨å¯¹è±¡** | `åªèƒ½æ˜¯æ–°å¯¹è±¡ï¼ˆç¬æ—¶çŠ¶æ€ï¼‰` | `å¯ä»¥æ˜¯æ–°å¯¹è±¡æˆ–æ¸¸ç¦»å¯¹è±¡` |
| ğŸ”¸ **æ“ä½œç±»å‹** | `åªåšINSERT` | `æ ¹æ®æƒ…å†µINSERTæˆ–UPDATE` |
| ğŸ”¸ **è¿”å›å€¼** | `voidï¼ˆæ— è¿”å›å€¼ï¼‰` | `è¿”å›æ‰˜ç®¡å¯¹è±¡` |
| ğŸ”¸ **å¯¹è±¡çŠ¶æ€** | `åŸå¯¹è±¡å˜ä¸ºæ‰˜ç®¡` | `åŸå¯¹è±¡ä»æ˜¯æ¸¸ç¦»ï¼Œè¿”å›æ–°çš„æ‰˜ç®¡å¯¹è±¡` |

### 5.6 å®ç”¨åœºæ™¯


**åœºæ™¯â‘ ï¼šæ›´æ–°ä»å‰ç«¯ä¼ æ¥çš„å¯¹è±¡**
```java
// å‰ç«¯ä¼ æ¥çš„ç”¨æˆ·å¯¹è±¡ï¼ˆæœ‰IDï¼Œä½†ä¸å—ç®¡ç†ï¼‰
User userFromWeb = new User();
userFromWeb.setId(1L);
userFromWeb.setName("ä¿®æ”¹åçš„åå­—");

// âŒ ä¸èƒ½ç”¨persistï¼ˆä¼šæŠ¥é”™ï¼Œå› ä¸ºæœ‰IDï¼‰
// entityManager.persist(userFromWeb); // é”™è¯¯ï¼

// âœ… ä½¿ç”¨merge
User managed = entityManager.merge(userFromWeb);
// æ‰§è¡ŒUPDATEï¼Œè¿”å›æ‰˜ç®¡å¯¹è±¡
```

**åœºæ™¯â‘¡ï¼šmergeçš„è¿”å›å€¼å¾ˆé‡è¦**
```java
User detached = new User();
detached.setId(1L);
detached.setName("å¼ ä¸‰");

// âŒ é”™è¯¯ï¼šå¿½ç•¥è¿”å›å€¼
entityManager.merge(detached);
detached.setAge(30); // è¿™ä¸ªä¿®æ”¹ä¸ä¼šä¿å­˜ï¼ï¼ˆdetachedä»æ˜¯æ¸¸ç¦»ï¼‰

// âœ… æ­£ç¡®ï¼šä½¿ç”¨è¿”å›çš„æ‰˜ç®¡å¯¹è±¡
User managed = entityManager.merge(detached);
managed.setAge(30); // è¿™ä¸ªä¿®æ”¹ä¼šä¿å­˜ï¼ˆmanagedæ˜¯æ‰˜ç®¡çŠ¶æ€ï¼‰
```

**åœºæ™¯â‘¢ï¼šmergeä¹Ÿå¯ä»¥æ’å…¥**
```java
// æ²¡æœ‰IDçš„å¯¹è±¡
User newUser = new User();
newUser.setName("æå››"); // æ²¡æœ‰setId

// mergeä¼šåˆ¤æ–­ï¼šæ²¡æœ‰ID â†’ æ‰§è¡ŒINSERT
User managed = entityManager.merge(newUser);
System.out.println(managed.getId()); // è¾“å‡ºç”Ÿæˆçš„ID
```

---

## 6. ğŸ—‘ï¸ removeåˆ é™¤æ“ä½œ


### 6.1 ä»€ä¹ˆæ˜¯remove


> **remove** = ç§»é™¤ï¼Œä»æ•°æ®åº“ä¸­åˆ é™¤ä¸€ä¸ªå¯¹è±¡å¯¹åº”çš„è®°å½•

**é€šä¿—ç†è§£**ï¼š
```
å°±åƒä»å›¾ä¹¦é¦†æ³¨é”€ä¸€æœ¬ä¹¦ï¼š
â‘  ä½ æŠŠè¦åˆ é™¤çš„ä¹¦äº¤ç»™ç®¡ç†å‘˜ï¼ˆä¼ å…¥å¯¹è±¡ï¼‰
â‘¡ ç®¡ç†å‘˜æ ‡è®°ä¸º"å¾…åˆ é™¤"ï¼ˆå¯¹è±¡å˜ä¸ºremovedçŠ¶æ€ï¼‰
â‘¢ äº‹åŠ¡æäº¤æ—¶æ‰§è¡ŒçœŸæ­£åˆ é™¤ï¼ˆDELETEè¯­å¥ï¼‰
```

### 6.2 åŸºæœ¬ç”¨æ³•


```java
// å…ˆæŸ¥è¯¢è¦åˆ é™¤çš„å¯¹è±¡ï¼ˆå¿…é¡»æ˜¯æ‰˜ç®¡çŠ¶æ€ï¼‰
User user = entityManager.find(User.class, 1L);

// åˆ é™¤å¯¹è±¡
entityManager.remove(user);
// æ­¤æ—¶å¯¹è±¡æ ‡è®°ä¸º"å¾…åˆ é™¤"ï¼Œè¿˜æ²¡æ‰§è¡ŒDELETE

// äº‹åŠ¡æäº¤æ—¶æ‰çœŸæ­£åˆ é™¤
transaction.commit(); // æ‰§è¡Œï¼šDELETE FROM user WHERE id = 1
```

### 6.3 removeçš„ç‰¹ç‚¹


| ç‰¹ç‚¹ | **è¯´æ˜** | **æ³¨æ„äº‹é¡¹** |
|------|---------|-------------|
| ğŸ”¸ **å¿…é¡»æ˜¯æ‰˜ç®¡çŠ¶æ€** | `å¯¹è±¡å¿…é¡»æ˜¯è¢«EntityManagerç®¡ç†çš„` | `ä¸èƒ½ç›´æ¥åˆ é™¤newçš„å¯¹è±¡æˆ–æ¸¸ç¦»å¯¹è±¡` |
| ğŸ”¸ **å»¶è¿Ÿåˆ é™¤** | `è°ƒç”¨removeä¸ç«‹å³æ‰§è¡ŒSQL` | `äº‹åŠ¡æäº¤æ—¶æ‰æ‰§è¡ŒDELETE` |
| ğŸ”¸ **çº§è”åˆ é™¤** | `å¯ä»¥çº§è”åˆ é™¤å…³è”å¯¹è±¡` | `å°å¿ƒçº§è”ï¼Œé¿å…è¯¯åˆ ` |
| âš ï¸ **å¯¹è±¡å˜ä¸ºremoved** | `åˆ é™¤åå¯¹è±¡å˜ä¸ºremovedçŠ¶æ€` | `ä¸èƒ½å†ä½¿ç”¨è¯¥å¯¹è±¡` |

### 6.4 å®ç”¨åœºæ™¯


**åœºæ™¯â‘ ï¼šåˆ é™¤å•ä¸ªå¯¹è±¡**
```java
// æŸ¥è¯¢ååˆ é™¤
User user = entityManager.find(User.class, 1L);
if (user != null) {
    entityManager.remove(user);
    System.out.println("åˆ é™¤æˆåŠŸ");
}
```

**åœºæ™¯â‘¡ï¼šä¸èƒ½åˆ é™¤æ¸¸ç¦»å¯¹è±¡**
```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šåˆ é™¤æ¸¸ç¦»å¯¹è±¡
User detached = new User();
detached.setId(1L);
entityManager.remove(detached); // æŠ¥é”™ï¼å¯¹è±¡ä¸æ˜¯æ‰˜ç®¡çŠ¶æ€

// âœ… æ­£ç¡®åšæ³•ï¼šå…ˆmergeå†åˆ é™¤
User managed = entityManager.merge(detached);
entityManager.remove(managed);
```

**åœºæ™¯â‘¢ï¼šçº§è”åˆ é™¤**
```java
// å‡è®¾Useré…ç½®äº†çº§è”åˆ é™¤å…³è”çš„Article
@OneToMany(cascade = CascadeType.REMOVE)
private List<Article> articles;

// åˆ é™¤ç”¨æˆ·æ—¶ï¼Œå…³è”çš„æ–‡ç« ä¹Ÿä¼šè¢«åˆ é™¤
User user = entityManager.find(User.class, 1L);
entityManager.remove(user);
// ä¼šæ‰§è¡Œï¼š
// DELETE FROM article WHERE author_id = 1
// DELETE FROM user WHERE id = 1
```

---

## 7. ğŸ”Œ detachåˆ†ç¦»æ“ä½œ


### 7.1 ä»€ä¹ˆæ˜¯detach


> **detach** = åˆ†ç¦»ï¼ŒæŠŠä¸€ä¸ªæ‰˜ç®¡å¯¹è±¡ä»æŒä¹…åŒ–ä¸Šä¸‹æ–‡ä¸­"æ‹¿å‡ºæ¥"ï¼Œå˜æˆæ¸¸ç¦»çŠ¶æ€

**é€šä¿—ç†è§£**ï¼š
```
å°±åƒæŠŠä¹¦ä»å›¾ä¹¦é¦†å€Ÿå‡ºæ¥ï¼š
â‘  ä¹¦åŸæœ¬åœ¨å›¾ä¹¦é¦†ç®¡ç†ï¼ˆæ‰˜ç®¡çŠ¶æ€ï¼‰
â‘¡ è°ƒç”¨detachæŠŠä¹¦å€Ÿèµ°ï¼ˆå˜ä¸ºæ¸¸ç¦»çŠ¶æ€ï¼‰
â‘¢ ç°åœ¨ä¿®æ”¹ä¹¦ä¸ä¼šå½±å“å›¾ä¹¦é¦†çš„è®°å½•ï¼ˆä¸ä¼šåŒæ­¥åˆ°æ•°æ®åº“ï¼‰
â‘£ æƒ³è¦å½’è¿˜éœ€è¦å†mergeï¼ˆåˆå¹¶å›å»ï¼‰
```

### 7.2 ä¸ºä»€ä¹ˆéœ€è¦detach


```
æœ‰æ—¶å€™ä½ ä¸å¸Œæœ›å¯¹è±¡è¢«è‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“ï¼š

åœºæ™¯1ï¼šåªæ˜¯ä¸´æ—¶è®¡ç®—ï¼Œä¸æƒ³ä¿å­˜
   â†“
ç”¨detachè„±ç¦»ç®¡ç†
   â†“
ä¿®æ”¹å¯¹è±¡ä¸ä¼šè§¦å‘UPDATE

åœºæ™¯2ï¼šé•¿æ—¶é—´æŒæœ‰å¯¹è±¡ï¼Œé¿å…å ç”¨èµ„æº
   â†“
ç”¨detaché‡Šæ”¾ç®¡ç†
   â†“
å‡å°‘å†…å­˜å ç”¨
```

### 7.3 åŸºæœ¬ç”¨æ³•


```java
// æŸ¥è¯¢ä¸€ä¸ªæ‰˜ç®¡å¯¹è±¡
User user = entityManager.find(User.class, 1L);
System.out.println(entityManager.contains(user)); // trueï¼ˆæ‰˜ç®¡çŠ¶æ€ï¼‰

// åˆ†ç¦»å¯¹è±¡
entityManager.detach(user);
System.out.println(entityManager.contains(user)); // falseï¼ˆæ¸¸ç¦»çŠ¶æ€ï¼‰

// ä¿®æ”¹å¯¹è±¡ä¸ä¼šåŒæ­¥åˆ°æ•°æ®åº“
user.setName("æ–°åå­—");
transaction.commit(); // ä¸ä¼šæ‰§è¡ŒUPDATE
```

### 7.4 detachçš„ç‰¹ç‚¹


| ç‰¹ç‚¹ | **è¯´æ˜** | **å®é™…æ•ˆæœ** |
|------|---------|-------------|
| ğŸ”¸ **è„±ç¦»ç®¡ç†** | `å¯¹è±¡ä¸å†è¢«EntityManagerè¿½è¸ª` | `ä¿®æ”¹ä¸ä¼šè‡ªåŠ¨åŒæ­¥` |
| ğŸ”¸ **ä»æœ‰æ•°æ®** | `å¯¹è±¡çš„æ•°æ®ä»ç„¶å­˜åœ¨` | `å¯ä»¥æ­£å¸¸è®¿é—®å±æ€§` |
| ğŸ”¸ **å¯ä»¥åˆå¹¶** | `å¯ä»¥ç”¨mergeé‡æ–°æ‰˜ç®¡` | `æŠŠä¿®æ”¹åˆå¹¶å›æ•°æ®åº“` |
| ğŸ’¾ **èŠ‚çœèµ„æº** | `å‡å°‘å†…å­˜å ç”¨` | `é€‚åˆé•¿æ—¶é—´æŒæœ‰çš„å¯¹è±¡` |

---

## 8. ğŸ”„ refreshåˆ·æ–°æ“ä½œ


### 8.1 ä»€ä¹ˆæ˜¯refresh


> **refresh** = åˆ·æ–°ï¼Œä»æ•°æ®åº“é‡æ–°åŠ è½½å¯¹è±¡ï¼Œè¦†ç›–å†…å­˜ä¸­çš„ä¿®æ”¹

**é€šä¿—ç†è§£**ï¼š
```
å°±åƒåˆ·æ–°ç½‘é¡µï¼š
â‘  ä½ åœ¨å†…å­˜ä¸­ä¿®æ”¹äº†å¯¹è±¡ï¼ˆæœ¬åœ°ä¿®æ”¹ï¼‰
â‘¡ ä½†æ€€ç–‘æ•°æ®åº“å¯èƒ½è¢«åˆ«äººæ”¹äº†
â‘¢ è°ƒç”¨refreshé‡æ–°ä»æ•°æ®åº“åŠ è½½ï¼ˆåˆ·æ–°ï¼‰
â‘£ æœ¬åœ°çš„ä¿®æ”¹ä¼šè¢«ä¸¢å¼ƒï¼Œæ¢å¤æˆæ•°æ®åº“çš„æœ€æ–°å€¼
```

### 8.2 åŸºæœ¬ç”¨æ³•


```java
// æŸ¥è¯¢å¯¹è±¡
User user = entityManager.find(User.class, 1L);
System.out.println(user.getName()); // "åŸå§‹åå­—"

// ä¿®æ”¹å¯¹è±¡ï¼ˆè¿˜æ²¡æäº¤ï¼‰
user.setName("ä¿®æ”¹åçš„åå­—");
System.out.println(user.getName()); // "ä¿®æ”¹åçš„åå­—"

// åˆ·æ–°å¯¹è±¡ï¼ˆä»æ•°æ®åº“é‡æ–°åŠ è½½ï¼‰
entityManager.refresh(user);
System.out.println(user.getName()); // "åŸå§‹åå­—"ï¼ˆä¿®æ”¹è¢«ä¸¢å¼ƒï¼‰
```

### 8.3 refreshçš„ç‰¹ç‚¹


| ç‰¹ç‚¹ | **è¯´æ˜** | **ä½¿ç”¨åœºæ™¯** |
|------|---------|-------------|
| âš¡ **ç«‹å³æ‰§è¡Œ** | `è°ƒç”¨refreshç«‹åˆ»æŸ¥è¯¢æ•°æ®åº“` | `éœ€è¦æœ€æ–°æ•°æ®æ—¶` |
| ğŸ”¸ **è¦†ç›–ä¿®æ”¹** | `æœ¬åœ°æœªæäº¤çš„ä¿®æ”¹ä¼šä¸¢å¤±` | `æ’¤é”€æœ¬åœ°ä¿®æ”¹` |
| ğŸ”¸ **å¿…é¡»æ˜¯æ‰˜ç®¡** | `å¯¹è±¡å¿…é¡»æ˜¯æ‰˜ç®¡çŠ¶æ€` | `ä¸èƒ½refreshæ¸¸ç¦»å¯¹è±¡` |
| ğŸ’¾ **è·å–æœ€æ–°** | `ä¿è¯æ‹¿åˆ°æ•°æ®åº“æœ€æ–°å€¼` | `å¤šçº¿ç¨‹/åˆ†å¸ƒå¼ç¯å¢ƒ` |

---

## 9. ğŸ’¨ flushå¼ºåˆ¶åŒæ­¥


### 9.1 ä»€ä¹ˆæ˜¯flush


> **flush** = å†²åˆ·ï¼Œå¼ºåˆ¶æŠŠå†…å­˜ä¸­çš„ä¿®æ”¹ç«‹å³åŒæ­¥åˆ°æ•°æ®åº“

**é€šä¿—ç†è§£**ï¼š
```
å°±åƒä¿å­˜Wordæ–‡æ¡£ï¼š
â‘  ä½ åœ¨å†…å­˜ä¸­ä¿®æ”¹äº†å¾ˆå¤šå†…å®¹ï¼ˆå¯¹è±¡çš„ä¿®æ”¹ï¼‰
â‘¡ å¹³æ—¶ä¿®æ”¹ä¼šæš‚å­˜åœ¨å†…å­˜ï¼ˆç­‰äº‹åŠ¡æäº¤ï¼‰
â‘¢ è°ƒç”¨flushç›¸å½“äºç‚¹å‡»"ä¿å­˜"æŒ‰é’®
â‘£ ç«‹å³æŠŠä¿®æ”¹å†™å…¥æ•°æ®åº“ï¼ˆæ‰§è¡ŒSQLï¼‰
â‘¤ ä½†äº‹åŠ¡è¿˜æ²¡æäº¤ï¼ˆå¯ä»¥å›æ»šï¼‰
```

### 9.2 åŸºæœ¬ç”¨æ³•


```java
// ä¿®æ”¹å¯¹è±¡
User user = entityManager.find(User.class, 1L);
user.setName("æ–°åå­—");

// æ­¤æ—¶ä¿®æ”¹åªåœ¨å†…å­˜ä¸­ï¼Œæ•°æ®åº“è¿˜æ˜¯æ—§å€¼

// å¼ºåˆ¶åŒæ­¥åˆ°æ•°æ®åº“
entityManager.flush();
// ç«‹å³æ‰§è¡Œï¼šUPDATE user SET name='æ–°åå­—' WHERE id=1

// ğŸ“Œ æ³¨æ„ï¼šflushåäº‹åŠ¡è¿˜æ²¡æäº¤ï¼Œä»å¯ä»¥å›æ»š
```

### 9.3 flush vs commit çš„åŒºåˆ«


```
flushï¼ˆå†²åˆ·ï¼‰ï¼š
â”œâ”€ æŠŠä¿®æ”¹å†™å…¥æ•°æ®åº“
â”œâ”€ ä½†äº‹åŠ¡è¿˜æ²¡æäº¤
â”œâ”€ è¿˜å¯ä»¥å›æ»šï¼ˆrollbackï¼‰
â””â”€ å…¶ä»–äº‹åŠ¡çœ‹ä¸åˆ°ä¿®æ”¹ï¼ˆéš”ç¦»æ€§ï¼‰

commitï¼ˆæäº¤ï¼‰ï¼š
â”œâ”€ å…ˆè‡ªåŠ¨flush
â”œâ”€ ç„¶åæäº¤äº‹åŠ¡
â”œâ”€ ä¸èƒ½å›æ»š
â””â”€ å…¶ä»–äº‹åŠ¡å¯ä»¥çœ‹åˆ°ä¿®æ”¹
```

### 9.4 flushçš„ç‰¹ç‚¹


| ç‰¹ç‚¹ | **è¯´æ˜** | **å®é™…æ•ˆæœ** |
|------|---------|-------------|
| âš¡ **ç«‹å³æ‰§è¡Œ** | `è°ƒç”¨åç«‹åˆ»æ‰§è¡ŒSQL` | `ä¸ç­‰äº‹åŠ¡æäº¤` |
| ğŸ”¸ **å¯ä»¥å›æ»š** | `flushåä»å¯ä»¥rollback` | `äº‹åŠ¡è¿˜æ²¡ç»“æŸ` |
| ğŸ”¸ **åŒæ­¥é¡ºåº** | `æŒ‰ç…§æ“ä½œé¡ºåºæ‰§è¡ŒSQL` | `INSERTâ†’UPDATEâ†’DELETE` |
| ğŸ’¾ **è·å–ID** | `flushåå¯ä»¥è·å–è‡ªåŠ¨ç”Ÿæˆçš„ID` | `persiståflushèƒ½æ‹¿åˆ°ID` |

---

## 10. ğŸ§¹ clearæ¸…ç©ºä¸Šä¸‹æ–‡


### 10.1 ä»€ä¹ˆæ˜¯clear


> **clear** = æ¸…ç©ºï¼Œæ¸…é™¤æŒä¹…åŒ–ä¸Šä¸‹æ–‡ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼Œé‡Šæ”¾å†…å­˜

**é€šä¿—ç†è§£**ï¼š
```
å°±åƒæ¸…ç©ºè´­ç‰©è½¦ï¼š
â‘  EntityManagerç®¡ç†ç€å¾ˆå¤šå¯¹è±¡ï¼ˆè´­ç‰©è½¦é‡Œçš„å•†å“ï¼‰
â‘¡ è°ƒç”¨clearæŠŠæ‰€æœ‰å¯¹è±¡ç§»é™¤ï¼ˆæ¸…ç©ºè´­ç‰©è½¦ï¼‰
â‘¢ æ‰€æœ‰å¯¹è±¡å˜ä¸ºæ¸¸ç¦»çŠ¶æ€ï¼ˆå•†å“ä¸‹æ¶ï¼‰
â‘£ é‡Šæ”¾å†…å­˜ï¼ˆè…¾å‡ºç©ºé—´ï¼‰
```

### 10.2 åŸºæœ¬ç”¨æ³•


```java
// æŸ¥è¯¢å¤šä¸ªå¯¹è±¡
User user1 = entityManager.find(User.class, 1L);
User user2 = entityManager.find(User.class, 2L);

System.out.println(entityManager.contains(user1)); // true
System.out.println(entityManager.contains(user2)); // true

// æ¸…ç©ºæ‰€æœ‰å¯¹è±¡
entityManager.clear();

System.out.println(entityManager.contains(user1)); // falseï¼ˆæ¸¸ç¦»ï¼‰
System.out.println(entityManager.contains(user2)); // falseï¼ˆæ¸¸ç¦»ï¼‰

// ä¿®æ”¹å¯¹è±¡ä¸ä¼šåŒæ­¥åˆ°æ•°æ®åº“
user1.setName("æ–°åå­—"); // æ— æ•ˆï¼Œå·²ç»æ¸¸ç¦»
```

### 10.3 clearçš„ç‰¹ç‚¹


| ç‰¹ç‚¹ | **è¯´æ˜** | **æ³¨æ„äº‹é¡¹** |
|------|---------|-------------|
| ğŸ”¸ **å…¨éƒ¨æ¸¸ç¦»** | `æ‰€æœ‰æ‰˜ç®¡å¯¹è±¡å˜ä¸ºæ¸¸ç¦»` | `ä¿®æ”¹ä¸ä¼šåŒæ­¥` |
| ğŸ”¸ **æ¸…ç©ºç¼“å­˜** | `ä¸€çº§ç¼“å­˜è¢«æ¸…ç©º` | `å†æ¬¡æŸ¥è¯¢ä¼šæ‰§è¡ŒSQL` |
| ğŸ’¾ **é‡Šæ”¾å†…å­˜** | `é‡Šæ”¾å¯¹è±¡å ç”¨çš„å†…å­˜` | `é€‚åˆæ‰¹é‡æ“ä½œ` |
| âš ï¸ **æœªæäº¤ä¿®æ”¹ä¸¢å¤±** | `æœªflushçš„ä¿®æ”¹ä¼šä¸¢å¤±` | `å…ˆflushå†clear` |

---

## 11. ğŸ“Š APIå¯¹æ¯”ä¸é€‰æ‹©


### 11.1 ä¿å­˜ä¸æ›´æ–°æ“ä½œå¯¹æ¯”


| æ“ä½œ | **persist** | **merge** |
|------|------------|-----------|
| **é€‚ç”¨å¯¹è±¡** | `æ–°å¯¹è±¡ï¼ˆç¬æ—¶ï¼‰` | `æ–°å¯¹è±¡æˆ–æ¸¸ç¦»å¯¹è±¡` |
| **æ•°æ®åº“æ“ä½œ** | `INSERT` | `INSERTæˆ–UPDATE` |
| **è¿”å›å€¼** | `void` | `è¿”å›æ‰˜ç®¡å¯¹è±¡` |
| **ä½¿ç”¨åœºæ™¯** | `æ˜ç¡®æ˜¯æ–°å¢` | `ä¸ç¡®å®šæ˜¯æ–°å¢è¿˜æ˜¯æ›´æ–°` |

### 11.2 æŸ¥è¯¢æ“ä½œå¯¹æ¯”


| æ“ä½œ | **find** | **getReference** |
|------|---------|-----------------|
| **åŠ è½½æ—¶æœº** | `ç«‹å³åŠ è½½` | `æ‡’åŠ è½½` |
| **è¿”å›ç±»å‹** | `å®ä½“å¯¹è±¡` | `ä»£ç†å¯¹è±¡` |
| **SQLæ‰§è¡Œ** | `ç«‹å³æ‰§è¡Œ` | `è®¿é—®å±æ€§æ—¶æ‰§è¡Œ` |
| **ä¸å­˜åœ¨æ—¶** | `è¿”å›null` | `æŠ›EntityNotFoundException` |

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¯¹è±¡çš„ä¸‰ç§çŠ¶æ€


```
â‘  ç¬æ—¶ï¼ˆTransientï¼‰
   â””â”€ newå‡ºæ¥çš„ï¼Œæ— IDï¼Œæ•°æ®åº“æ— è®°å½•
   â””â”€ ç”¨persistå˜ä¸ºæ‰˜ç®¡

â‘¡ æ‰˜ç®¡ï¼ˆManagedï¼‰
   â””â”€ è¢«EntityManagerç®¡ç†
   â””â”€ ä¿®æ”¹ä¼šè‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“

â‘¢ æ¸¸ç¦»ï¼ˆDetachedï¼‰
   â””â”€ æœ‰IDï¼Œä½†ä¸è¢«ç®¡ç†
   â””â”€ ç”¨mergeå˜å›æ‰˜ç®¡
```

### 12.2 APIå¿«é€Ÿé€‰æ‹©æŒ‡å—


**ğŸ¯ æ–°å¢æ•°æ®**ï¼š
- æ˜ç¡®æ˜¯æ–°å¢ â†’ `persist`
- ä¸ç¡®å®šçŠ¶æ€ â†’ `merge`

**ğŸ¯ æŸ¥è¯¢æ•°æ®**ï¼š
- éœ€è¦ä½¿ç”¨æ•°æ® â†’ `find`
- åªè®¾ç½®å…³è” â†’ `getReference`

**ğŸ¯ æ›´æ–°æ•°æ®**ï¼š
- æ‰˜ç®¡å¯¹è±¡ â†’ ç›´æ¥ä¿®æ”¹
- æ¸¸ç¦»å¯¹è±¡ â†’ `merge`

**ğŸ¯ åˆ é™¤æ•°æ®**ï¼š
- æ‰˜ç®¡å¯¹è±¡ â†’ `remove`
- æ¸¸ç¦»å¯¹è±¡ â†’ å…ˆ`merge`å†`remove`

**ğŸ¯ æ‰¹é‡æ“ä½œ**ï¼š
- å®šæœŸ`flush` + `clear`é¿å…å†…å­˜æº¢å‡º

**è®°å¿†å£è¯€**ï¼š
```
persistä¿å­˜æ–°å¯¹è±¡ï¼Œfindç«‹å³æŠŠå®ƒæ‰¾
getReferenceæ‡’åŠ è½½ï¼Œmergeåˆå¹¶æœ€å¯é 
removeåˆ é™¤è¦æ‰˜ç®¡ï¼Œdetachåˆ†ç¦»ä¸åŒæ­¥
refreshé‡è½½æ–°æ•°æ®ï¼ŒflushåŒæ­¥ä¸æäº¤
clearæ¸…ç©ºé‡Šå†…å­˜ï¼Œæ‰¹é‡æ“ä½œå¥½å¸®æ‰‹
```