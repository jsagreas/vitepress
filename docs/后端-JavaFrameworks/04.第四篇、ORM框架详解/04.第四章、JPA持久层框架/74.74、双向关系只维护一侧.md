---
title: 74ã€åŒå‘å…³ç³»åªç»´æŠ¤ä¸€ä¾§
---
## ğŸ“š ç›®å½•

1. [åŒå‘å…³ç³»çš„æ ¸å¿ƒå›°æƒ‘](#1-åŒå‘å…³ç³»çš„æ ¸å¿ƒå›°æƒ‘)
2. [æ‹¥æœ‰æ–¹ä¸è¢«æ‹¥æœ‰æ–¹](#2-æ‹¥æœ‰æ–¹ä¸è¢«æ‹¥æœ‰æ–¹)
3. [å…³ç³»åŒæ­¥çš„é»„é‡‘æ³•åˆ™](#3-å…³ç³»åŒæ­¥çš„é»„é‡‘æ³•åˆ™)
4. [Helperæ–¹æ³•æœ€ä½³å®è·µ](#4-Helperæ–¹æ³•æœ€ä½³å®è·µ)
5. [çº§è”æ“ä½œçš„æ­£ç¡®ä½¿ç”¨](#5-çº§è”æ“ä½œçš„æ­£ç¡®ä½¿ç”¨)
6. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#6-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤” åŒå‘å…³ç³»çš„æ ¸å¿ƒå›°æƒ‘


### 1.1 æ–°æ‰‹å¸¸è§ç–‘é—®


**ğŸ¯ æœ€å¸¸è§çš„å›°æƒ‘**ï¼š
```
ç–‘é—®ï¼š"æ—¢ç„¶æ˜¯åŒå‘å…³ç³»ï¼Œä¸ºä»€ä¹ˆåªç»´æŠ¤ä¸€ä¾§ï¼Ÿ"
ç–‘é—®ï¼š"ä¸¤è¾¹éƒ½è®¾ç½®å…³ç³»ä¸æ˜¯æ›´å®‰å…¨å—ï¼Ÿ"
ç–‘é—®ï¼š"mappedByåˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ"
```

**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ å’Œæœ‹å‹çš„å…³ç³»ï¼š
- ä½ çš„é€šè®¯å½•é‡Œæœ‰æœ‹å‹çš„ç”µè¯ï¼ˆä½ è¿™è¾¹è®°å½•äº†å…³ç³»ï¼‰
- æœ‹å‹çš„é€šè®¯å½•é‡Œæœ‰ä½ çš„ç”µè¯ï¼ˆæœ‹å‹é‚£è¾¹ä¹Ÿè®°å½•äº†å…³ç³»ï¼‰
- ä½†å®é™…ä¸Šï¼Œ"ä½ ä»¬æ˜¯æœ‹å‹"è¿™ä¸ªäº‹å®åªéœ€è¦è®°å½•ä¸€æ¬¡
- åœ¨æ•°æ®åº“é‡Œï¼Œå°±æ˜¯ç”¨**å¤–é”®**æ¥è®°å½•è¿™ä¸ªå…³ç³»

ğŸ”— **å…³é”®ç†è§£**ï¼š
```
Javaå¯¹è±¡ä¸­ï¼šéœ€è¦åŒå‘å¼•ç”¨ï¼Œæ–¹ä¾¿ä»£ç æ“ä½œ
æ•°æ®åº“ä¸­ï¼šåªéœ€ä¸€ä¸ªå¤–é”®ï¼Œé¿å…æ•°æ®å†—ä½™
JPAçš„ä½œç”¨ï¼šåè°ƒè¿™ä¸¤è€…çš„å·®å¼‚
```

### 1.2 åŒå‘å…³ç³»çš„æœ¬è´¨


**ğŸ“Š æ•°æ®å­˜å‚¨è§†è§’**ï¼š
```
ç”¨æˆ·è¡¨ (User)          è®¢å•è¡¨ (Order)
+----+-------+        +----+--------+---------+
| id | name  |        | id | amount | user_id |  â† å¤–é”®åœ¨è¿™é‡Œ
+----+-------+        +----+--------+---------+
| 1  | å¼ ä¸‰  |        | 1  | 100    | 1       |
| 2  | æå››  |        | 2  | 200    | 1       |
+----+-------+        | 3  | 150    | 2       |
                      +----+--------+---------+

å…³é”®ç‚¹ï¼šå¤–é”®user_idåœ¨Orderè¡¨ï¼Œæ‰€ä»¥Orderæ˜¯"æ‹¥æœ‰æ–¹"
```

**ğŸ”„ Javaå¯¹è±¡è§†è§’**ï¼š
```java
// Javaä¸­éœ€è¦åŒå‘å¼•ç”¨æ‰èƒ½æ–¹ä¾¿æ“ä½œ
User user = new User();
Order order = new Order();

// ä»ç”¨æˆ·æ‰¾è®¢å•
user.getOrders().add(order);  

// ä»è®¢å•æ‰¾ç”¨æˆ·
order.setUser(user);

// ä½†æ•°æ®åº“åªéœ€è¦ä¸€ä¸ªå¤–é”®ï¼
```

---

## 2. ğŸ¯ æ‹¥æœ‰æ–¹ä¸è¢«æ‹¥æœ‰æ–¹


### 2.1 æ ¸å¿ƒæ¦‚å¿µè§£æ


**ğŸ”‘ æ‹¥æœ‰æ–¹ï¼ˆOwning Sideï¼‰**ï¼š
```
å®šä¹‰ï¼šæ‹¥æœ‰å¤–é”®çš„ä¸€æ–¹ï¼Œè´Ÿè´£çœŸæ­£æ›´æ–°æ•°æ®åº“
ç‰¹å¾ï¼šä½¿ç”¨ @JoinColumn æ³¨è§£
è´£ä»»ï¼šç»´æŠ¤å…³ç³»çš„å®é™…å­˜å‚¨
```

**ğŸ“Œ è¢«æ‹¥æœ‰æ–¹ï¼ˆInverse Sideï¼‰**ï¼š
```
å®šä¹‰ï¼šä¸æ‹¥æœ‰å¤–é”®çš„ä¸€æ–¹ï¼Œä½¿ç”¨ mappedBy æŒ‡å‘æ‹¥æœ‰æ–¹
ç‰¹å¾ï¼šä½¿ç”¨ mappedBy å±æ€§
è´£ä»»ï¼šåªæ˜¯Javaå¯¹è±¡çš„ä¾¿åˆ©å¼•ç”¨ï¼Œä¸å½±å“æ•°æ®åº“
```

### 2.2 å…¸å‹ç¤ºä¾‹å¯¹æ¯”


**ğŸ“ ä¸€å¯¹å¤šå…³ç³»ç¤ºä¾‹**ï¼š

```java
// è¢«æ‹¥æœ‰æ–¹ - Userï¼ˆä¸€çš„ä¸€æ–¹ï¼‰
@Entity
public class User {
    @Id
    private Long id;
    
    // mappedBy = "user" è¡¨ç¤ºï¼š
    // 1. æˆ‘ä¸è´Ÿè´£ç»´æŠ¤å…³ç³»
    // 2. å…³ç³»ç”±Orderå®ä½“çš„userå±æ€§ç»´æŠ¤
    // 3. æˆ‘åªæ˜¯ä¸ºäº†ä»£ç æ–¹ä¾¿æ‰æœ‰è¿™ä¸ªé›†åˆ
    @OneToMany(mappedBy = "user")
    private List<Order> orders = new ArrayList<>();
    
    // è¿™ä¸ªæ–¹æ³•åªæ”¹å˜Javaå¯¹è±¡ï¼Œä¸å½±å“æ•°æ®åº“ï¼
    public void addOrder(Order order) {
        orders.add(order);
    }
}

// æ‹¥æœ‰æ–¹ - Orderï¼ˆå¤šçš„ä¸€æ–¹ï¼‰
@Entity
public class Order {
    @Id
    private Long id;
    
    // @JoinColumnæŒ‡å®šå¤–é”®åˆ—å
    // è¿™ä¸ªå±æ€§çš„å˜åŒ–ä¼šç›´æ¥å½±å“æ•°æ®åº“
    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;
    
    // è¿™ä¸ªæ–¹æ³•ä¼šçœŸæ­£å½±å“æ•°æ®åº“ï¼
    public void setUser(User user) {
        this.user = user;
    }
}
```

### 2.3 åˆ¤æ–­æ‹¥æœ‰æ–¹çš„æ–¹æ³•


**ğŸ¯ åˆ¤æ–­æ ‡å‡†**ï¼š
```
æ–¹æ³•1ï¼šçœ‹å¤–é”®ä½ç½®
â†’ å¤–é”®åœ¨å“ªä¸ªè¡¨ï¼Œå“ªä¸ªå®ä½“å°±æ˜¯æ‹¥æœ‰æ–¹

æ–¹æ³•2ï¼šçœ‹æ³¨è§£
â†’ æœ‰ @JoinColumn çš„æ˜¯æ‹¥æœ‰æ–¹
â†’ æœ‰ mappedBy çš„æ˜¯è¢«æ‹¥æœ‰æ–¹

æ–¹æ³•3ï¼šçœ‹å…³ç³»ç±»å‹
â†’ @ManyToOne ä¸€å®šæ˜¯æ‹¥æœ‰æ–¹
â†’ @OneToMany é€šå¸¸æ˜¯è¢«æ‹¥æœ‰æ–¹ï¼ˆé™¤éå•å‘ï¼‰
```

**ğŸ’¡ è®°å¿†æŠ€å·§**ï¼š
```
ä¸€å¯¹å¤šå…³ç³»ï¼šå¤šçš„ä¸€æ–¹æ˜¯æ‹¥æœ‰æ–¹ï¼ˆOrderæ‹¥æœ‰å¤–é”®ï¼‰
å¤šå¯¹å¤šå…³ç³»ï¼šä»»æ„æŒ‡å®šä¸€æ–¹ä¸ºæ‹¥æœ‰æ–¹
ä¸€å¯¹ä¸€å…³ç³»ï¼šçœ‹ä¸šåŠ¡é€»è¾‘å†³å®šè°æ‹¥æœ‰å¤–é”®
```

---

## 3. âš–ï¸ å…³ç³»åŒæ­¥çš„é»„é‡‘æ³•åˆ™


### 3.1 åªæ›´æ–°æ‹¥æœ‰æ–¹çš„åŸåˆ™


**ğŸ”¸ æ ¸å¿ƒåŸåˆ™**ï¼š
```
åªæœ‰æ›´æ–°æ‹¥æœ‰æ–¹çš„å±æ€§ï¼ŒJPAæ‰ä¼šçœŸæ­£ä¿®æ”¹æ•°æ®åº“
æ›´æ–°è¢«æ‹¥æœ‰æ–¹çš„é›†åˆï¼Œä¸ä¼šå½±å“æ•°æ®åº“ï¼
```

**âŒ å¸¸è§é”™è¯¯ç¤ºä¾‹**ï¼š

```java
// é”™è¯¯åšæ³•ï¼šåªæ›´æ–°è¢«æ‹¥æœ‰æ–¹
User user = new User();
Order order = new Order();

// åªæ·»åŠ åˆ°userçš„ordersé›†åˆ
user.getOrders().add(order);

entityManager.persist(user);
entityManager.persist(order);

// ç»“æœï¼šorderè¡¨çš„user_idå­—æ®µä»ç„¶æ˜¯NULLï¼
// åŸå› ï¼šuserçš„ordersæœ‰mappedByï¼Œä¸è´Ÿè´£æ›´æ–°æ•°æ®åº“
```

**âœ… æ­£ç¡®åšæ³•ç¤ºä¾‹**ï¼š

```java
// æ­£ç¡®åšæ³•ï¼šæ›´æ–°æ‹¥æœ‰æ–¹
User user = new User();
Order order = new Order();

// è®¾ç½®æ‹¥æœ‰æ–¹çš„å…³ç³»
order.setUser(user);  // â† è¿™ä¸ªä¼šæ›´æ–°æ•°æ®åº“

entityManager.persist(user);
entityManager.persist(order);

// ç»“æœï¼šorderè¡¨çš„user_idæ­£ç¡®è®¾ç½®ä¸ºuserçš„id
```

### 3.2 ä¸ºä»€ä¹ˆmappedByä¸æ›´æ–°æ•°æ®åº“


**ğŸ” æ·±å±‚åŸç†**ï¼š

```
JPAçš„æ›´æ–°é€»è¾‘ï¼š
1. æ£€æŸ¥å®ä½“çš„å˜åŒ–
2. å¦‚æœå±æ€§æœ‰ @JoinColumn â†’ ç”ŸæˆUPDATE SQL
3. å¦‚æœå±æ€§æœ‰ mappedBy â†’ è·³è¿‡ï¼Œä¸ç”ŸæˆSQL

åŸå› ï¼š
- mappedByè¡¨ç¤º"æˆ‘åªæ˜¯é•œåƒï¼ŒçœŸæ­£çš„æ•°æ®åœ¨å¯¹æ–¹é‚£é‡Œ"
- é¿å…åŒä¸€ä¸ªå¤–é”®è¢«ä¸¤è¾¹éƒ½ä¿®æ”¹ï¼Œé€ æˆå†²çª
- ä¿è¯æ•°æ®åº“ä¸€è‡´æ€§
```

**ğŸ“Š æ‰§è¡ŒSQLå¯¹æ¯”**ï¼š

```sql
-- åªæ›´æ–°è¢«æ‹¥æœ‰æ–¹æ—¶ï¼ˆé”™è¯¯ï¼‰
-- JPAç”Ÿæˆçš„SQLï¼š
INSERT INTO user (id, name) VALUES (1, 'å¼ ä¸‰');
INSERT INTO order (id, amount, user_id) VALUES (1, 100, NULL);
-- æ³¨æ„ï¼šuser_idæ˜¯NULLï¼

-- æ›´æ–°æ‹¥æœ‰æ–¹æ—¶ï¼ˆæ­£ç¡®ï¼‰  
-- JPAç”Ÿæˆçš„SQLï¼š
INSERT INTO user (id, name) VALUES (1, 'å¼ ä¸‰');
INSERT INTO order (id, amount, user_id) VALUES (1, 100, 1);
-- user_idæ­£ç¡®è®¾ç½®ä¸º1
```

---

## 4. ğŸ”§ Helperæ–¹æ³•æœ€ä½³å®è·µ


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦Helperæ–¹æ³•


**ğŸ¯ é—®é¢˜åœºæ™¯**ï¼š
```
æŒ‘æˆ˜ï¼šæˆ‘ä»¬éœ€è¦ç»´æŠ¤Javaå¯¹è±¡çš„åŒå‘å¼•ç”¨
éš¾ç‚¹ï¼šæ¯æ¬¡éƒ½æ‰‹åŠ¨è®¾ç½®ä¸¤è¾¹å¾ˆå®¹æ˜“é—æ¼
è§£å†³ï¼šç”¨Helperæ–¹æ³•è‡ªåŠ¨åŒæ­¥ä¸¤è¾¹
```

**ğŸ’¡ Helperæ–¹æ³•çš„ä½œç”¨**ï¼š
```
1. è‡ªåŠ¨åŒæ­¥åŒå‘å¼•ç”¨
2. ä¿è¯Javaå¯¹è±¡çš„ä¸€è‡´æ€§
3. é¿å…äººä¸ºç–å¿½
4. æä¾›ä¾¿æ·çš„API
```

### 4.2 æ ‡å‡†Helperæ–¹æ³•æ¨¡æ¿


**âœ… æ¨èå®ç°æ–¹å¼**ï¼š

```java
@Entity
public class User {
    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL)
    private List<Order> orders = new ArrayList<>();
    
    // Helperæ–¹æ³•ï¼šåŒæ—¶ç»´æŠ¤ä¸¤è¾¹çš„å¼•ç”¨
    public void addOrder(Order order) {
        // 1. æ·»åŠ åˆ°é›†åˆï¼ˆç»´æŠ¤ä¸€æ–¹çš„å¼•ç”¨ï¼‰
        orders.add(order);
        
        // 2. è®¾ç½®æ‹¥æœ‰æ–¹ï¼ˆç»´æŠ¤å¤šæ–¹çš„å¼•ç”¨ï¼‰
        order.setUser(this);  // â† å…³é”®ï¼šæ›´æ–°æ‹¥æœ‰æ–¹
    }
    
    public void removeOrder(Order order) {
        // 1. ä»é›†åˆç§»é™¤
        orders.remove(order);
        
        // 2. æ¸…é™¤æ‹¥æœ‰æ–¹çš„å¼•ç”¨
        order.setUser(null);
    }
}

@Entity  
public class Order {
    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;
    
    // å¯é€‰ï¼šæä¾›è®¾ç½®æ–¹æ³•ï¼Œä½†ä¸å»ºè®®ç›´æ¥ä½¿ç”¨
    public void setUser(User user) {
        this.user = user;
    }
}
```

**ğŸ¯ ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
// ä½¿ç”¨Helperæ–¹æ³•ï¼ˆæ¨èï¼‰
User user = new User();
Order order = new Order();

user.addOrder(order);  // ä¸€è¡Œä»£ç æå®šåŒå‘å…³è”

entityManager.persist(user);
// æ•°æ®åº“æ­£ç¡®ä¿å­˜ï¼š
// - userè¡¨æ’å…¥ç”¨æˆ·
// - orderè¡¨æ’å…¥è®¢å•ï¼Œuser_idæ­£ç¡®è®¾ç½®
```

### 4.3 é«˜çº§Helperæ–¹æ³•æŠ€å·§


**ğŸ”¸ é˜²æ­¢é‡å¤æ·»åŠ **ï¼š

```java
public void addOrder(Order order) {
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if (orders.contains(order)) {
        return;
    }
    
    orders.add(order);
    order.setUser(this);
}
```

**ğŸ”¸ å¤„ç†æ—§å…³ç³»**ï¼š

```java
public void addOrder(Order order) {
    // å¦‚æœorderä¹‹å‰å±äºå…¶ä»–userï¼Œå…ˆè§£é™¤
    if (order.getUser() != null) {
        order.getUser().getOrders().remove(order);
    }
    
    orders.add(order);
    order.setUser(this);
}
```

**ğŸ”¸ Builderæ¨¡å¼ç»“åˆ**ï¼š

```java
public User addOrders(Order... newOrders) {
    for (Order order : newOrders) {
        addOrder(order);
    }
    return this;  // æ”¯æŒé“¾å¼è°ƒç”¨
}

// ä½¿ç”¨
user.addOrders(order1, order2, order3)
    .setName("å¼ ä¸‰");
```

---

## 5. ğŸ”„ çº§è”æ“ä½œçš„æ­£ç¡®ä½¿ç”¨


### 5.1 çº§è”æ“ä½œåŸºç¡€


**ğŸ“š çº§è”ç±»å‹è¯´æ˜**ï¼š

| çº§è”ç±»å‹ | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ | æ³¨æ„äº‹é¡¹ |
|---------|------|---------|---------|
| `PERSIST` | ä¿å­˜æ—¶çº§è” | æ–°å¢ä¸»å¯¹è±¡æ—¶è‡ªåŠ¨ä¿å­˜å­å¯¹è±¡ | é¿å…å­¤å„¿å¯¹è±¡ |
| `MERGE` | æ›´æ–°æ—¶çº§è” | æ›´æ–°ä¸»å¯¹è±¡æ—¶åŒæ­¥æ›´æ–°å­å¯¹è±¡ | æ³¨æ„æ€§èƒ½ |
| `REMOVE` | åˆ é™¤æ—¶çº§è” | åˆ é™¤ä¸»å¯¹è±¡æ—¶è‡ªåŠ¨åˆ é™¤å­å¯¹è±¡ | âš ï¸ å±é™©æ“ä½œ |
| `REFRESH` | åˆ·æ–°æ—¶çº§è” | é‡æ–°åŠ è½½ä¸»å¯¹è±¡æ—¶åˆ·æ–°å­å¯¹è±¡ | è¾ƒå°‘ä½¿ç”¨ |
| `DETACH` | åˆ†ç¦»æ—¶çº§è” | åˆ†ç¦»ä¸»å¯¹è±¡æ—¶åŒæ—¶åˆ†ç¦»å­å¯¹è±¡ | ç®¡ç†çŠ¶æ€ |
| `ALL` | æ‰€æœ‰æ“ä½œçº§è” | å®Œå…¨çš„çˆ¶å­å…³ç³» | âš ï¸ æ…ç”¨ |

### 5.2 å¸¸ç”¨çº§è”é…ç½®


**âœ… ä¸€å¯¹å¤šå…³ç³»æ¨èé…ç½®**ï¼š

```java
@Entity
public class User {
    // æ¨èï¼šPERSISTå’ŒMERGE
    // åŸå› ï¼šæ–°å¢å’Œæ›´æ–°æ—¶è‡ªåŠ¨å¤„ç†è®¢å•
    @OneToMany(mappedBy = "user", 
               cascade = {CascadeType.PERSIST, CascadeType.MERGE})
    private List<Order> orders = new ArrayList<>();
}
```

**âš ï¸ æ…ç”¨REMOVEçº§è”**ï¼š

```java
// å±é™©ç¤ºä¾‹
@OneToMany(mappedBy = "user", 
           cascade = CascadeType.ALL)  // åŒ…å«REMOVE
private List<Order> orders;

// åˆ é™¤ç”¨æˆ·æ—¶
entityManager.remove(user);
// æ‰€æœ‰è®¢å•ä¹Ÿè¢«åˆ é™¤ï¼å¯èƒ½ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„
```

**ğŸ¯ å®‰å…¨çš„åˆ é™¤å¤„ç†**ï¼š

```java
@Entity
public class User {
    // ä¸ä½¿ç”¨REMOVEçº§è”
    @OneToMany(mappedBy = "user", 
               cascade = {CascadeType.PERSIST, CascadeType.MERGE})
    private List<Order> orders;
    
    // æä¾›ä¸šåŠ¡æ–¹æ³•å¤„ç†åˆ é™¤
    public void deleteWithOrders(EntityManager em) {
        // æ˜ç¡®çš„ä¸šåŠ¡é€»è¾‘
        for (Order order : orders) {
            em.remove(order);
        }
        em.remove(this);
    }
}
```

### 5.3 çº§è”ä¸å…³ç³»ç»´æŠ¤çš„é…åˆ


**ğŸ’¡ æœ€ä½³å®è·µç»„åˆ**ï¼š

```java
@Entity
public class User {
    @OneToMany(mappedBy = "user", 
               cascade = {CascadeType.PERSIST, CascadeType.MERGE},
               orphanRemoval = true)  // è‡ªåŠ¨åˆ é™¤å­¤å„¿å¯¹è±¡
    private List<Order> orders = new ArrayList<>();
    
    public void addOrder(Order order) {
        orders.add(order);
        order.setUser(this);  // ç»´æŠ¤æ‹¥æœ‰æ–¹
    }
    
    public void removeOrder(Order order) {
        orders.remove(order);
        order.setUser(null);  // æ¸…é™¤å…³ç³»ï¼Œè§¦å‘orphanRemoval
    }
}

// ä½¿ç”¨
User user = entityManager.find(User.class, 1L);
Order order = user.getOrders().get(0);

user.removeOrder(order);
// orphanRemoval=true ä¼šè‡ªåŠ¨åˆ é™¤order
```

---

## 6. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 6.1 æ‡’åŠ è½½ä¸æ€¥åŠ è½½é€‰æ‹©


**ğŸ¯ åŠ è½½ç­–ç•¥å¯¹æ¯”**ï¼š

```java
// æ‡’åŠ è½½ï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰
@OneToMany(mappedBy = "user", fetch = FetchType.LAZY)
private List<Order> orders;

// ä½¿ç”¨åœºæ™¯ï¼š
User user = entityManager.find(User.class, 1L);
// æ­¤æ—¶ä¸æŸ¥è¯¢orders

if (needOrders) {
    user.getOrders().size();  // è§¦å‘æŸ¥è¯¢
}

// æ€¥åŠ è½½ï¼ˆæ…ç”¨ï¼‰
@OneToMany(mappedBy = "user", fetch = FetchType.EAGER)
private List<Order> orders;

// ä½¿ç”¨åœºæ™¯ï¼š
User user = entityManager.find(User.class, 1L);
// ç«‹å³æŸ¥è¯¢æ‰€æœ‰ordersï¼Œå¯èƒ½é€ æˆN+1é—®é¢˜
```

**ğŸ“Š N+1é—®é¢˜ç¤ºä¾‹**ï¼š

```java
// æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
List<User> users = entityManager
    .createQuery("SELECT u FROM User u", User.class)
    .getResultList();

// å¦‚æœordersæ˜¯EAGERï¼š
// SQL1: SELECT * FROM user
// SQL2: SELECT * FROM order WHERE user_id = 1
// SQL3: SELECT * FROM order WHERE user_id = 2
// ...
// æ€»å…±ï¼š1 + N æ¡SQLï¼ˆNæ˜¯ç”¨æˆ·æ•°é‡ï¼‰
```

### 6.2 æ‰¹é‡æ“ä½œä¼˜åŒ–


**âœ… JOIN FETCHä¼˜åŒ–**ï¼š

```java
// ä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰æ•°æ®
List<User> users = entityManager
    .createQuery(
        "SELECT u FROM User u " +
        "LEFT JOIN FETCH u.orders", 
        User.class)
    .getResultList();

// ç”Ÿæˆçš„SQLï¼š
// SELECT u.*, o.* 
// FROM user u 
// LEFT JOIN order o ON u.id = o.user_id
// åªæœ‰ä¸€æ¡SQLï¼
```

**ğŸ”¸ åˆ†é¡µæ—¶çš„æ³¨æ„äº‹é¡¹**ï¼š

```java
// é”™è¯¯ï¼šJOIN FETCH + åˆ†é¡µå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º
List<User> users = entityManager
    .createQuery("SELECT u FROM User u JOIN FETCH u.orders", User.class)
    .setFirstResult(0)
    .setMaxResults(10)  // åˆ†é¡µå¯èƒ½å¤±æ•ˆ
    .getResultList();

// æ­£ç¡®ï¼šå…ˆæŸ¥è¯¢IDï¼Œå†æ‰¹é‡åŠ è½½
List<Long> userIds = entityManager
    .createQuery("SELECT u.id FROM User u", Long.class)
    .setFirstResult(0)
    .setMaxResults(10)
    .getResultList();

List<User> users = entityManager
    .createQuery(
        "SELECT u FROM User u " +
        "LEFT JOIN FETCH u.orders " +
        "WHERE u.id IN :ids", 
        User.class)
    .setParameter("ids", userIds)
    .getResultList();
```

### 6.3 å…³ç³»ç»´æŠ¤çš„æ€§èƒ½ä¼˜åŒ–


**ğŸ¯ æ‰¹é‡ç»´æŠ¤ç­–ç•¥**ï¼š

```java
// åœºæ™¯ï¼šä¸ºç”¨æˆ·æ·»åŠ å¤šä¸ªè®¢å•

// âŒ ä½æ•ˆæ–¹å¼
for (Order order : orders) {
    user.addOrder(order);
    entityManager.persist(order);  // æ¯ä¸ªè®¢å•ä¸€æ¬¡æ•°æ®åº“æ“ä½œ
}

// âœ… ä¼˜åŒ–æ–¹å¼
@Entity
public class User {
    public void addOrders(List<Order> newOrders) {
        for (Order order : newOrders) {
            orders.add(order);
            order.setUser(this);
        }
    }
}

// ä½¿ç”¨
user.addOrders(orderList);
entityManager.flush();  // ä¸€æ¬¡æ€§æ‰¹é‡ä¿å­˜
```

**ğŸ”§ æ›´æ–°ä¼˜åŒ–**ï¼š

```java
// åªæ›´æ–°å¿…è¦çš„å…³ç³»
@Modifying
@Query("UPDATE Order o SET o.user.id = :userId WHERE o.id IN :orderIds")
int batchUpdateUser(@Param("userId") Long userId, 
                    @Param("orderIds") List<Long> orderIds);

// æ‰¹é‡æ›´æ–°ï¼Œé¿å…åŠ è½½æ•´ä¸ªå¯¹è±¡å›¾
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å…³é”®åŸåˆ™


```
ğŸ”¸ æ‹¥æœ‰æ–¹åŸåˆ™ï¼šåªæœ‰æ‹¥æœ‰æ–¹çš„æ›´æ–°æ‰ä¼šå½±å“æ•°æ®åº“
ğŸ”¸ mappedByè§„åˆ™ï¼šæœ‰mappedByçš„ä¸€æ–¹ä¸è´Ÿè´£ç»´æŠ¤å…³ç³»
ğŸ”¸ Helperæ–¹æ³•ï¼šé€šè¿‡è¾…åŠ©æ–¹æ³•è‡ªåŠ¨åŒæ­¥åŒå‘å¼•ç”¨
ğŸ”¸ çº§è”é€‰æ‹©ï¼šæ ¹æ®ä¸šåŠ¡éœ€è¦è°¨æ…é€‰æ‹©çº§è”ç±»å‹
ğŸ”¸ æ€§èƒ½ä¼˜å…ˆï¼šä½¿ç”¨æ‡’åŠ è½½å’ŒJOIN FETCHä¼˜åŒ–æŸ¥è¯¢
```

### 7.2 å®æˆ˜æ£€æŸ¥æ¸…å•


**âœ… å…³ç³»é…ç½®æ£€æŸ¥**ï¼š
- [ ] ç¡®å®šäº†æ‹¥æœ‰æ–¹å’Œè¢«æ‹¥æœ‰æ–¹
- [ ] æ‹¥æœ‰æ–¹ä½¿ç”¨@JoinColumn
- [ ] è¢«æ‹¥æœ‰æ–¹ä½¿ç”¨mappedBy
- [ ] çº§è”ç±»å‹é…ç½®åˆç†

**âœ… ä»£ç å®ç°æ£€æŸ¥**ï¼š
- [ ] æä¾›äº†Helperæ–¹æ³•ç»´æŠ¤åŒå‘å¼•ç”¨
- [ ] æ›´æ–°æ‹¥æœ‰æ–¹çš„å±æ€§æ¥ä¿®æ”¹å…³ç³»
- [ ] é¿å…åªæ›´æ–°è¢«æ‹¥æœ‰æ–¹çš„é›†åˆ
- [ ] å¤„ç†äº†æ—§å…³ç³»çš„è§£é™¤

**âœ… æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥**ï¼š
- [ ] ä½¿ç”¨æ‡’åŠ è½½ä½œä¸ºé»˜è®¤ç­–ç•¥
- [ ] å¿…è¦æ—¶ä½¿ç”¨JOIN FETCH
- [ ] é¿å…N+1æŸ¥è¯¢é—®é¢˜
- [ ] æ‰¹é‡æ“ä½œä½¿ç”¨æ‰¹å¤„ç†

### 7.3 å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ


| é™·é˜± | ç°è±¡ | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| ğŸ”´ åªæ›´æ–°è¢«æ‹¥æœ‰æ–¹ | æ•°æ®åº“å¤–é”®ä¸ºNULL | æ›´æ–°æ‹¥æœ‰æ–¹çš„å±æ€§ |
| ğŸ”´ å¿˜è®°åŒæ­¥åŒå‘å¼•ç”¨ | Javaå¯¹è±¡ä¸ä¸€è‡´ | ä½¿ç”¨Helperæ–¹æ³• |
| ğŸ”´ æ»¥ç”¨REMOVEçº§è” | æ„å¤–åˆ é™¤æ•°æ® | æ˜ç¡®ä¸šåŠ¡é€»è¾‘ |
| ğŸ”´ EAGERåŠ è½½ | N+1æ€§èƒ½é—®é¢˜ | æ”¹ç”¨LAZY+JOIN FETCH |
| ğŸ”´ åˆ†é¡µ+JOIN FETCH | å†…å­˜æº¢å‡º | å…ˆæŸ¥IDå†æ‰¹é‡åŠ è½½ |

### 7.4 æœ€ä½³å®è·µæ€»ç»“


**ğŸ¯ æ¨èæ¨¡å¼**ï¼š

```java
@Entity
public class User {
    @OneToMany(mappedBy = "user", 
               cascade = {CascadeType.PERSIST, CascadeType.MERGE},
               orphanRemoval = true,
               fetch = FetchType.LAZY)
    private List<Order> orders = new ArrayList<>();
    
    // Helperæ–¹æ³•
    public void addOrder(Order order) {
        if (order.getUser() != null) {
            order.getUser().getOrders().remove(order);
        }
        orders.add(order);
        order.setUser(this);
    }
    
    public void removeOrder(Order order) {
        orders.remove(order);
        order.setUser(null);
    }
}

@Entity
public class Order {
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    private User user;
}
```

**ğŸ§  è®°å¿†å£è¯€**ï¼š
```
æ‹¥æœ‰æ–¹æŒæœ‰é”®ï¼Œæ›´æ–°å®ƒæ‰å˜
è¢«æ‹¥æœ‰mappedByï¼Œåªæ˜¯ä¾¿åˆ©çœ‹
Helperæ–¹æ³•å¦™ï¼ŒåŒå‘è‡ªåŠ¨è”
çº§è”è¦æ…é‡ï¼Œåˆ é™¤éœ€ä¸‰æ€
æ‡’åŠ è½½é»˜è®¤ï¼Œæ€¥æ—¶ç”¨JOIN FETCH
```

**æ ¸å¿ƒç†è§£**ï¼š
- åŒå‘å…³ç³»åœ¨Javaä¸­æ˜¯ä¸¤ä¸ªå¼•ç”¨ï¼Œåœ¨æ•°æ®åº“ä¸­æ˜¯ä¸€ä¸ªå¤–é”®
- JPAé€šè¿‡æ‹¥æœ‰æ–¹å’ŒmappedByæ¥åè°ƒè¿™ä¸ªå·®å¼‚
- Helperæ–¹æ³•æ˜¯ç»´æŠ¤å¯¹è±¡ä¸€è‡´æ€§çš„æœ€ä½³å®è·µ
- æ€§èƒ½ä¼˜åŒ–çš„å…³é”®æ˜¯æ­£ç¡®é€‰æ‹©åŠ è½½ç­–ç•¥