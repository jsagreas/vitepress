---
title: 73ã€å®ä½“ç­‰å€¼æ€§ä¸é›†åˆè¡Œä¸º
---
## ğŸ“š ç›®å½•

1. [å®ä½“ç­‰å€¼æ€§æ ¸å¿ƒæ¦‚å¿µ](#1-å®ä½“ç­‰å€¼æ€§æ ¸å¿ƒæ¦‚å¿µ)
2. [equalsä¸hashCodeæœ€ä½³å®è·µ](#2-equalsä¸hashCodeæœ€ä½³å®è·µ)
3. [é›†åˆæ“ä½œä¸­çš„å¸¸è§é™·é˜±](#3-é›†åˆæ“ä½œä¸­çš„å¸¸è§é™·é˜±)
4. [ä»£ç†å¯¹è±¡çš„ç‰¹æ®Šå¤„ç†](#4-ä»£ç†å¯¹è±¡çš„ç‰¹æ®Šå¤„ç†)
5. [å®ä½“æ ‡è¯†ç¬¦è®¾è®¡ç­–ç•¥](#5-å®ä½“æ ‡è¯†ç¬¦è®¾è®¡ç­–ç•¥)
6. [ä¸å¯å˜æ€§è®¾è®¡è€ƒè™‘](#6-ä¸å¯å˜æ€§è®¾è®¡è€ƒè™‘)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å®ä½“ç­‰å€¼æ€§æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å®ä½“ç­‰å€¼æ€§


**é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ åœ¨ç®¡ç†å­¦ç”Ÿä¿¡æ¯ï¼Œæ€ä¹ˆåˆ¤æ–­ä¸¤ä¸ªå­¦ç”Ÿè®°å½•æ˜¯"åŒä¸€ä¸ªäºº"ï¼Ÿæ˜¯çœ‹å­¦å·ï¼Ÿå§“åï¼Ÿè¿˜æ˜¯å…¶ä»–ï¼Ÿè¿™å°±æ˜¯å®ä½“ç­‰å€¼æ€§è¦è§£å†³çš„é—®é¢˜ã€‚

```
ç°å®åœºæ™¯ç±»æ¯”ï¼š
ä½ çš„èº«ä»½è¯å· = å®ä½“çš„ä¸šåŠ¡å”¯ä¸€é”®
â€¢ å³ä½¿åå­—æ”¹äº†ï¼Œèº«ä»½è¯å·ä¸å˜ï¼Œè¿˜æ˜¯ä½ 
â€¢ å³ä½¿æ¬å®¶äº†ï¼Œèº«ä»½è¯å·ä¸å˜ï¼Œè¿˜æ˜¯ä½ 
â€¢ èº«ä»½è¯å·æ‰æ˜¯è¯†åˆ«"æ˜¯ä¸æ˜¯åŒä¸€ä¸ªäºº"çš„å…³é”®

å®ä½“ç­‰å€¼æ€§ï¼š
â€¢ equalsæ–¹æ³• â†’ åˆ¤æ–­ä¸¤ä¸ªå®ä½“æ˜¯å¦"ç›¸åŒ"
â€¢ hashCodeæ–¹æ³• â†’ ç”¨äºé›†åˆï¼ˆSet/Mapï¼‰ä¸­å¿«é€ŸæŸ¥æ‰¾
â€¢ ä¸šåŠ¡å”¯ä¸€é”® â†’ çœŸæ­£èƒ½åŒºåˆ†å®ä½“çš„å…³é”®å±æ€§
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ­£ç¡®å®ç°equalså’ŒhashCode


**é—®é¢˜åœºæ™¯**ï¼š
```java
// âŒ æ²¡æœ‰é‡å†™equalsçš„é—®é¢˜
@Entity
public class Student {
    @Id
    private Long id;
    private String studentNo;  // å­¦å·ï¼ˆä¸šåŠ¡å”¯ä¸€é”®ï¼‰
    private String name;
    
    // ä½¿ç”¨é»˜è®¤çš„Object.equalsï¼ˆæ¯”è¾ƒå†…å­˜åœ°å€ï¼‰
}

// æµ‹è¯•ä»£ç 
Student s1 = new Student();
s1.setStudentNo("2024001");
s1.setName("å¼ ä¸‰");

Student s2 = new Student();
s2.setStudentNo("2024001");
s2.setName("å¼ ä¸‰");

System.out.println(s1.equals(s2));  // falseï¼è™½ç„¶å­¦å·ç›¸åŒ
// åŸå› ï¼šé»˜è®¤equalsæ¯”è¾ƒçš„æ˜¯å¯¹è±¡å¼•ç”¨ï¼Œs1å’Œs2æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡
```

**å®é™…å½±å“**ï¼š
```
åœ¨é›†åˆä¸­çš„é—®é¢˜ï¼š
Set<Student> students = new HashSet<>();
students.add(s1);
students.add(s2);  // è™½ç„¶å­¦å·ç›¸åŒï¼Œä½†è¢«å½“ä½œä¸¤ä¸ªä¸åŒå­¦ç”Ÿï¼

System.out.println(students.size());  // è¾“å‡º2ï¼Œä½†å®é™…åº”è¯¥æ˜¯1

åœ¨ä¸šåŠ¡é€»è¾‘ä¸­ï¼š
if (students.contains(s2)) {  // falseï¼æ˜æ˜å­¦å·ç›¸åŒ
    // è¿™æ®µä»£ç ä¸ä¼šæ‰§è¡Œ
}
```

---

## 2. âœ… equalsä¸hashCodeæœ€ä½³å®è·µ


### 2.1 åŸºäºä¸šåŠ¡å”¯ä¸€é”®å®ç°


**æ ¸å¿ƒåŸåˆ™**ï¼šä½¿ç”¨ä¸ä¼šæ”¹å˜çš„ä¸šåŠ¡å±æ€§ä½œä¸ºç­‰å€¼æ€§åˆ¤æ–­ä¾æ®

```java
@Entity
public class Student {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true, nullable = false)
    private String studentNo;  // å­¦å· - ä¸šåŠ¡å”¯ä¸€é”®
    
    private String name;
    
    // âœ… æ­£ç¡®å®ç°ï¼šåŸºäºä¸šåŠ¡å”¯ä¸€é”®
    @Override
    public boolean equals(Object o) {
        // 1. æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡
        if (this == o) return true;
        
        // 2. æ£€æŸ¥ç±»å‹
        if (o == null || getClass() != o.getClass()) return false;
        
        Student student = (Student) o;
        
        // 3. æ¯”è¾ƒä¸šåŠ¡å”¯ä¸€é”®ï¼ˆå­¦å·ï¼‰
        return studentNo != null && studentNo.equals(student.studentNo);
    }
    
    @Override
    public int hashCode() {
        // åŸºäºä¸šåŠ¡å”¯ä¸€é”®è®¡ç®—
        return studentNo != null ? studentNo.hashCode() : 0;
    }
}
```

**ä¸ºä»€ä¹ˆä¸ç”¨æ•°æ®åº“IDï¼Ÿ**
```
âŒ åŸºäºæ•°æ®åº“IDçš„é—®é¢˜ï¼š

@Override
public boolean equals(Object o) {
    Student student = (Student) o;
    return id != null && id.equals(student.id);
}

é—®é¢˜åœºæ™¯ï¼š
Student newStudent = new Student();
newStudent.setStudentNo("2024001");
// æ­¤æ—¶idè¿˜æ˜¯nullï¼ˆæœªä¿å­˜åˆ°æ•°æ®åº“ï¼‰

Set<Student> students = new HashSet<>();
students.add(newStudent);

// ä¿å­˜åidè¢«èµ‹å€¼
entityManager.persist(newStudent);  // idç°åœ¨æœ‰å€¼äº†

// å°è¯•æŸ¥æ‰¾
students.contains(newStudent);  // falseï¼
// åŸå› ï¼šhashCodeå˜äº†ï¼ˆä¹‹å‰æ˜¯0ï¼Œç°åœ¨æ˜¯idçš„å“ˆå¸Œå€¼ï¼‰
```

### 2.2 é¿å…ä½¿ç”¨å»¶è¿ŸåŠ è½½å­—æ®µ


**å»¶è¿ŸåŠ è½½é™·é˜±**ï¼š
```java
@Entity
public class Order {
    @Id
    private Long id;
    
    private String orderNo;  // è®¢å•å· - ä¸šåŠ¡å”¯ä¸€é”®
    
    @ManyToOne(fetch = FetchType.LAZY)  // å»¶è¿ŸåŠ è½½
    private Customer customer;
    
    // âŒ é”™è¯¯ï¼šä½¿ç”¨å»¶è¿ŸåŠ è½½å­—æ®µ
    @Override
    public boolean equals(Object o) {
        Order order = (Order) o;
        // è®¿é—®customerå¯èƒ½è§¦å‘é¢å¤–æ•°æ®åº“æŸ¥è¯¢ï¼
        return customer != null && customer.equals(order.customer);
    }
}
```

**æ­£ç¡®åšæ³•**ï¼š
```java
@Entity
public class Order {
    @Id
    private Long id;
    
    private String orderNo;  // è®¢å•å·
    
    @ManyToOne(fetch = FetchType.LAZY)
    private Customer customer;
    
    // âœ… æ­£ç¡®ï¼šåªç”¨ç«‹å³åŠ è½½çš„ä¸šåŠ¡å”¯ä¸€é”®
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        
        Order order = (Order) o;
        return orderNo != null && orderNo.equals(order.orderNo);
    }
    
    @Override
    public int hashCode() {
        return orderNo != null ? orderNo.hashCode() : 0;
    }
}
```

**ä¸ºä»€ä¹ˆè¦é¿å…ï¼Ÿ**
```
æ€§èƒ½é—®é¢˜ï¼š
Set<Order> orders = new HashSet<>();
orders.add(order1);
orders.add(order2);  // å¦‚æœequalsç”¨äº†customer
                     // å¯èƒ½è§¦å‘2æ¬¡é¢å¤–çš„æ•°æ®åº“æŸ¥è¯¢ï¼

æœ€ä½³å®è·µï¼š
âœ… åªä½¿ç”¨åŸºæœ¬ç±»å‹æˆ–Stringç±»å‹çš„ä¸šåŠ¡å­—æ®µ
âœ… ç¡®ä¿è¿™äº›å­—æ®µæ˜¯ç«‹å³åŠ è½½çš„ï¼ˆä¸æ˜¯LAZYï¼‰
âœ… å­—æ®µå€¼ç¨³å®šï¼Œä¸ä¼šé¢‘ç¹æ”¹å˜
```

---

## 3. ğŸª¤ é›†åˆæ“ä½œä¸­çš„å¸¸è§é™·é˜±


### 3.1 Setå»é‡é™·é˜±è¯¦è§£


**é—®é¢˜åœºæ™¯ï¼šç¬æ€å¯¹è±¡åŠ å…¥Set**
```java
@Entity
public class Product {
    @Id
    @GeneratedValue
    private Long id;
    
    @Column(unique = true)
    private String sku;  // å•†å“ç¼–ç 
    
    // åŸºäºSKUçš„equals/hashCode
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Product product = (Product) o;
        return sku != null && sku.equals(product.sku);
    }
    
    @Override
    public int hashCode() {
        return sku != null ? sku.hashCode() : 0;
    }
}

// ä½¿ç”¨Setå­˜å‚¨
Set<Product> productSet = new HashSet<>();

// åœºæ™¯1ï¼šç¬æ€å¯¹è±¡ï¼ˆæœªä¿å­˜ï¼‰
Product p1 = new Product();
p1.setSku("PROD-001");
productSet.add(p1);

Product p2 = new Product();
p2.setSku("PROD-001");
productSet.add(p2);  // SKUç›¸åŒï¼ŒSetåº”è¯¥æ‹’ç»

System.out.println(productSet.size());  // è¾“å‡º1 âœ… æ­£ç¡®å»é‡äº†
```

**é™·é˜±ï¼šä¿®æ”¹ä¸šåŠ¡å”¯ä¸€é”®**
```java
// é™·é˜±åœºæ™¯ï¼šä¿®æ”¹äº†SKU
Product p1 = new Product();
p1.setSku("PROD-001");

Set<Product> productSet = new HashSet<>();
productSet.add(p1);
System.out.println(productSet.contains(p1));  // true

// âš ï¸ ä¿®æ”¹äº†ä¸šåŠ¡å”¯ä¸€é”®
p1.setSku("PROD-002");

System.out.println(productSet.contains(p1));  // falseï¼
// åŸå› ï¼šhashCodeå˜äº†ï¼Œåœ¨Setä¸­æ‰¾ä¸åˆ°åŸæ¥çš„ä½ç½®äº†

// Setå†…éƒ¨ç»“æ„ç¤ºæ„ï¼š
å“ˆå¸Œè¡¨ä½ç½®ï¼š
[PROD-001çš„hashä½ç½®] â†’ p1å¯¹è±¡
                     â†“
                ä¿®æ”¹SKUå...
                     â†“
[PROD-002çš„hashä½ç½®] â†’ ç©ºï¼ˆp1åº”è¯¥åœ¨è¿™ï¼Œä½†ä¸åœ¨ï¼‰
[PROD-001çš„hashä½ç½®] â†’ p1å¯¹è±¡ï¼ˆè¿˜åœ¨æ—§ä½ç½®ï¼Œæˆäº†"å¹½çµ"ï¼‰
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// âœ… æ–¹æ¡ˆ1ï¼šä¸šåŠ¡å”¯ä¸€é”®è®¾ä¸ºfinalï¼ˆä¸å¯ä¿®æ”¹ï¼‰
@Entity
public class Product {
    @Column(unique = true, updatable = false)
    private final String sku;
    
    protected Product() {
        this.sku = null;  // JPAéœ€è¦æ— å‚æ„é€ å™¨
    }
    
    public Product(String sku) {
        this.sku = sku;  // åªèƒ½åœ¨åˆ›å»ºæ—¶è®¾ç½®
    }
}

// âœ… æ–¹æ¡ˆ2ï¼šæ°¸è¿œä¸è¦ä¿®æ”¹Setä¸­å¯¹è±¡çš„ä¸šåŠ¡å”¯ä¸€é”®
Set<Product> products = new HashSet<>();
products.add(product);

// å¦‚æœéœ€è¦ä¿®æ”¹ï¼Œå…ˆç§»é™¤å†ä¿®æ”¹å†æ·»åŠ 
products.remove(product);
product.setSku("NEW-SKU");
products.add(product);

// âœ… æ–¹æ¡ˆ3ï¼šä½¿ç”¨Listä»£æ›¿Set
List<Product> products = new ArrayList<>();
// æ‰‹åŠ¨å»é‡æˆ–ä½¿ç”¨Stream
```

### 3.2 Setä¸Listçš„é€‰æ‹©ç­–ç•¥


**å¯¹æ¯”åˆ†æ**ï¼š

| åœºæ™¯ | **æ¨èä½¿ç”¨** | **åŸå› ** |
|------|-------------|---------|
| ä¸€å¯¹å¤šå…³ç³» | `List` | `é¡ºåºé‡è¦ï¼Œå…è®¸é‡å¤` |
| å¤šå¯¹å¤šå…³ç³»ï¼ˆå›ºå®šä¸å˜ï¼‰ | `Set` | `è‡ªç„¶å»é‡ï¼Œæ— åº` |
| éœ€è¦æ’åº | `List` | `å¯ä»¥æ’åºï¼Œæ§åˆ¶é¡ºåº` |
| é¢‘ç¹ä¿®æ”¹å®ä½“å±æ€§ | `List` | `é¿å…hashCodeå˜åŒ–é—®é¢˜` |
| ç®€å•å€¼å¯¹è±¡é›†åˆ | `Set` | `å¦‚Set<String>ï¼Œä¸ä¼šå˜åŒ–` |

**å®é™…å»ºè®®**ï¼š
```java
// åœºæ™¯1ï¼šè®¢å•æ˜ç»†ï¼ˆæœ‰é¡ºåºï¼Œå¯é‡å¤ï¼‰
@Entity
public class Order {
    @OneToMany(mappedBy = "order")
    @OrderColumn(name = "line_number")  // æ˜ç¡®é¡ºåº
    private List<OrderItem> items = new ArrayList<>();
}

// åœºæ™¯2ï¼šæ ‡ç­¾ï¼ˆæ— åºï¼Œä¸é‡å¤ï¼Œä¸ä¼šä¿®æ”¹ï¼‰
@Entity
public class Article {
    @ElementCollection
    private Set<String> tags = new HashSet<>();  // å­—ç¬¦ä¸²ä¸ä¼šå˜
}

// åœºæ™¯3ï¼šæƒé™ï¼ˆå¤šå¯¹å¤šï¼Œå›ºå®šä¸å˜ï¼‰
@Entity
public class Role {
    @ManyToMany
    private Set<Permission> permissions = new HashSet<>();
}

// åœºæ™¯4ï¼šå¤æ‚å®ä½“å…³ç³»ï¼ˆæ¨èç”¨Listï¼‰
@Entity
public class Department {
    @OneToMany(mappedBy = "department")
    private List<Employee> employees = new ArrayList<>();
    // å‘˜å·¥ä¿¡æ¯å¯èƒ½å˜åŒ–ï¼Œç”¨Listæ›´å®‰å…¨
}
```

---

## 4. ğŸ‘» ä»£ç†å¯¹è±¡çš„ç‰¹æ®Šå¤„ç†


### 4.1 Hibernateä»£ç†å¯¹è±¡æœºåˆ¶


**ä»€ä¹ˆæ˜¯ä»£ç†å¯¹è±¡ï¼Ÿ**
```
å»¶è¿ŸåŠ è½½åŸç†ï¼š
æ•°æ®åº“å®ä½“ â†’ Hibernateåˆ›å»ºä»£ç†å¯¹è±¡ â†’ ä½ è·å¾—çš„å¯¹è±¡

ä»£ç†å¯¹è±¡ç‰¹ç‚¹ï¼š
â€¢ è¡¨é¢ä¸Šçœ‹èµ·æ¥æ˜¯ä½ çš„å®ä½“ç±»
â€¢ å®é™…ä¸Šæ˜¯Hibernateç”Ÿæˆçš„å­ç±»
â€¢ ç¬¬ä¸€æ¬¡è®¿é—®å±æ€§æ—¶æ‰çœŸæ­£æŸ¥è¯¢æ•°æ®åº“

ç±»ç»§æ‰¿å…³ç³»ï¼š
Student (ä½ çš„å®ä½“ç±»)
   â†‘
Student_$$_HibernateProxy$... (Hibernateç”Ÿæˆçš„ä»£ç†)
```

**ä»£ç†å¯¹è±¡å¯¼è‡´çš„equalsé—®é¢˜**ï¼š
```java
@Entity
public class Student {
    @Id
    private Long id;
    private String studentNo;
    
    // âŒ é—®é¢˜å®ç°
    @Override
    public boolean equals(Object o) {
        if (getClass() != o.getClass()) return false;  // è¿™é‡Œæœ‰é—®é¢˜
        // ...
    }
}

// ä½¿ç”¨åœºæ™¯
@Entity
public class Course {
    @ManyToOne(fetch = FetchType.LAZY)
    private Student student;  // è¿™æ˜¯ä¸ªä»£ç†å¯¹è±¡
}

Course course = em.find(Course.class, 1L);
Student proxy = course.getStudent();  // ä»£ç†å¯¹è±¡

Student real = new Student();
real.setId(proxy.getId());

System.out.println(proxy.getClass());  // Student_$$_HibernateProxy$...
System.out.println(real.getClass());   // Student

// equalsæ¯”è¾ƒ
proxy.equals(real);  // falseï¼
// åŸå› ï¼šgetClass()ä¸ç›¸ç­‰
// proxy: Student_$$_HibernateProxy
// real:  Student
```

### 4.2 æ­£ç¡®å¤„ç†ä»£ç†å¯¹è±¡


**âœ… æ–¹æ¡ˆ1ï¼šä½¿ç”¨instanceof**
```java
@Entity
public class Student {
    @Id
    private Long id;
    private String studentNo;
    
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        
        // âœ… ä½¿ç”¨instanceofä»£æ›¿getClass()
        if (!(o instanceof Student)) return false;
        
        Student student = (Student) o;
        return studentNo != null && 
               studentNo.equals(student.studentNo);
    }
    
    @Override
    public int hashCode() {
        return studentNo != null ? studentNo.hashCode() : 0;
    }
}

// æµ‹è¯•
Student proxy = course.getStudent();  // ä»£ç†å¯¹è±¡
Student real = new Student();
real.setStudentNo("2024001");
proxy.setStudentNo("2024001");

proxy.equals(real);  // true âœ… æ­£ç¡®ï¼
```

**âœ… æ–¹æ¡ˆ2ï¼šHibernateå·¥å…·ç±»**
```java
import org.hibernate.Hibernate;

@Override
public boolean equals(Object o) {
    if (this == o) return true;
    if (o == null) return false;
    
    // è·å–çœŸå®ç±»ï¼ˆå¤„ç†ä»£ç†ï¼‰
    Class<?> thisClass = Hibernate.getClass(this);
    Class<?> otherClass = Hibernate.getClass(o);
    
    if (thisClass != otherClass) return false;
    
    Student student = (Student) o;
    return studentNo != null && 
           studentNo.equals(student.studentNo);
}
```

**å®Œæ•´å¯¹æ¯”**ï¼š
```
æ–¹æ¡ˆå¯¹æ¯”ï¼š

instanceofæ–¹å¼ï¼š
âœ… ç®€å•ç›´è§‚
âœ… ä¸ä¾èµ–Hibernate API
âŒ å­ç±»ä¹Ÿä¼šåŒ¹é…ï¼ˆå¦‚æœæœ‰ç»§æ‰¿ï¼‰

Hibernate.getClass()æ–¹å¼ï¼š
âœ… ç²¾ç¡®ç±»å‹åŒ¹é…
âœ… æ­£ç¡®å¤„ç†ä»£ç†
âŒ ä¾èµ–Hibernate API

ä¸šåŠ¡å”¯ä¸€é”®æ–¹å¼ï¼ˆæ¨èï¼‰ï¼š
âœ… ä¸å…³å¿ƒç±»å‹ç»†èŠ‚
âœ… å…³æ³¨ä¸šåŠ¡è¯­ä¹‰
âœ… ä»£ç†å¯¹è±¡é—®é¢˜è‡ªç„¶è§£å†³
```

---

## 5. ğŸ”‘ å®ä½“æ ‡è¯†ç¬¦è®¾è®¡ç­–ç•¥


### 5.1 è‡ªç„¶é”® vs ä»£ç†é”®


**è‡ªç„¶é”®ï¼ˆä¸šåŠ¡å”¯ä¸€é”®ï¼‰**ï¼š
```java
// è‡ªç„¶é”®ç¤ºä¾‹
@Entity
public class Country {
    @Id
    @Column(length = 2)
    private String code;  // å›½å®¶ä»£ç ï¼šCN, US, JP
    
    private String name;
    
    // åŸºäºè‡ªç„¶é”®çš„equals
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof Country)) return false;
        Country country = (Country) o;
        return code != null && code.equals(country.code);
    }
    
    @Override
    public int hashCode() {
        return code != null ? code.hashCode() : 0;
    }
}

ä¼˜ç‚¹ï¼š
âœ… æœ‰ä¸šåŠ¡å«ä¹‰
âœ… ä¸ä¼šæ”¹å˜
âœ… equals/hashCodeå®ç°ç®€å•
âœ… æŸ¥è¯¢æ—¶ç›´æ¥ç”¨ä¸šåŠ¡é”®

ç¼ºç‚¹ï¼š
âŒ å¯èƒ½æ˜¯å¤åˆé”®
âŒ æœ‰äº›ä¸šåŠ¡å¯èƒ½æ²¡æœ‰è‡ªç„¶é”®
```

**ä»£ç†é”®ï¼ˆæ•°æ®åº“è‡ªå¢IDï¼‰**ï¼š
```java
// ä»£ç†é”®ç¤ºä¾‹
@Entity
public class Order {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;  // æ•°æ®åº“è‡ªå¢ID
    
    @Column(unique = true)
    private String orderNo;  // è®¢å•å·ï¼ˆä¸šåŠ¡å”¯ä¸€é”®ï¼‰
    
    // âœ… è™½ç„¶ç”¨ä»£ç†é”®åšä¸»é”®ï¼ŒequalsåŸºäºä¸šåŠ¡é”®
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof Order)) return false;
        Order order = (Order) o;
        return orderNo != null && orderNo.equals(order.orderNo);
    }
    
    @Override
    public int hashCode() {
        return orderNo != null ? orderNo.hashCode() : 0;
    }
}

ä¼˜ç‚¹ï¼š
âœ… ç®€å•ç»Ÿä¸€ï¼ˆæ‰€æœ‰è¡¨éƒ½ç”¨Long idï¼‰
âœ… æ•°æ®åº“æ€§èƒ½å¥½ï¼ˆæ•°å­—ç´¢å¼•å¿«ï¼‰
âœ… ä¸šåŠ¡è§„åˆ™å˜åŒ–ä¸å½±å“ä¸»é”®

ç¼ºç‚¹ï¼š
âŒ æ— ä¸šåŠ¡å«ä¹‰
âŒ ç¬æ€å¯¹è±¡idä¸ºnull
```

### 5.2 UUIDä½œä¸ºä¸šåŠ¡æ ‡è¯†ç¬¦


**UUIDçš„ä¼˜åŠ¿**ï¼š
```java
@Entity
public class Document {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    // UUIDä½œä¸ºä¸šåŠ¡å”¯ä¸€æ ‡è¯†
    @Column(unique = true, nullable = false, updatable = false)
    private String uuid = UUID.randomUUID().toString();
    
    private String title;
    
    // åŸºäºUUIDçš„equals
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof Document)) return false;
        Document document = (Document) o;
        return uuid != null && uuid.equals(document.uuid);
    }
    
    @Override
    public int hashCode() {
        return uuid != null ? uuid.hashCode() : 0;
    }
}

ä½¿ç”¨åœºæ™¯ï¼š
Document doc1 = new Document();
doc1.setTitle("æŠ¥å‘Š");

Set<Document> docs = new HashSet<>();
docs.add(doc1);

// å³ä½¿æœªä¿å­˜ï¼ˆidä¸ºnullï¼‰ï¼Œä¹Ÿèƒ½æ­£ç¡®å»é‡
Document doc2 = new Document();
doc2.setTitle("æŠ¥å‘Š");
docs.add(doc2);  // UUIDä¸åŒï¼Œæ­£å¸¸æ·»åŠ 

System.out.println(docs.size());  // 2
```

**UUIDæœ€ä½³å®è·µ**ï¼š
```
UUIDä¼˜åŠ¿ï¼š
âœ… åˆ›å»ºå³å¯ç”¨ï¼Œä¸ä¾èµ–æ•°æ®åº“
âœ… å…¨å±€å”¯ä¸€ï¼Œåˆ†å¸ƒå¼å‹å¥½
âœ… ç¬æ€å¯¹è±¡ä¹Ÿæœ‰ç¨³å®šæ ‡è¯†
âœ… é€‚åˆåšequals/hashCodeä¾æ®

æ³¨æ„äº‹é¡¹ï¼š
âš ï¸ å­—ç¬¦ä¸²é•¿åº¦å¤§ï¼ˆ36å­—ç¬¦ï¼‰
âš ï¸ ç´¢å¼•æ€§èƒ½ä¸å¦‚æ•°å­—
âš ï¸ ä¸é€‚åˆä½œä¸º@Idï¼ˆç”¨ä½œä¸šåŠ¡é”®å³å¯ï¼‰

æ¨èæ¨¡å¼ï¼š
@Id
@GeneratedValue
private Long id;  // æ•°æ®åº“ä¸»é”®

@Column(unique = true)
private String uuid;  // ä¸šåŠ¡å”¯ä¸€æ ‡è¯†
```

---

## 6. ğŸ”’ ä¸å¯å˜æ€§è®¾è®¡è€ƒè™‘


### 6.1 ä¸ºä»€ä¹ˆè€ƒè™‘ä¸å¯å˜æ€§


**å¯å˜æ€§å¸¦æ¥çš„é—®é¢˜**ï¼š
```java
// å¯å˜å®ä½“çš„é—®é¢˜
@Entity
public class Product {
    @Id
    private Long id;
    
    private String sku;  // å¯ä»¥ä¿®æ”¹
    private String name; // å¯ä»¥ä¿®æ”¹
    
    @Override
    public boolean equals(Object o) {
        Product product = (Product) o;
        return sku != null && sku.equals(product.sku);
    }
    
    @Override
    public int hashCode() {
        return sku != null ? sku.hashCode() : 0;
    }
}

// é—®é¢˜åœºæ™¯
Set<Product> products = new HashSet<>();
Product p = new Product();
p.setSku("PROD-001");
products.add(p);

// ä¿®æ”¹SKU
p.setSku("PROD-002");  // hashCodeå˜äº†ï¼

// Setå¤±æ•ˆ
products.contains(p);  // falseï¼ˆæ‰¾ä¸åˆ°äº†ï¼‰
products.size();       // 1ï¼ˆä½†å†…éƒ¨ç»“æ„å·²æ··ä¹±ï¼‰
```

### 6.2 å®ç°éƒ¨åˆ†ä¸å¯å˜æ€§


**ä¸šåŠ¡å”¯ä¸€é”®ä¸å¯å˜**ï¼š
```java
@Entity
public class Employee {
    @Id
    @GeneratedValue
    private Long id;
    
    // ä¸šåŠ¡å”¯ä¸€é”®ï¼šå‘˜å·¥ç¼–å·ï¼ˆä¸å¯å˜ï¼‰
    @Column(unique = true, nullable = false, updatable = false)
    private String employeeNo;
    
    // å…¶ä»–å±æ€§å¯å˜
    private String name;
    private String email;
    private String department;
    
    // æ„é€ å™¨è®¾ç½®ä¸å¯å˜å­—æ®µ
    protected Employee() {}
    
    public Employee(String employeeNo) {
        this.employeeNo = employeeNo;
    }
    
    // åªæä¾›getterï¼Œæ²¡æœ‰setter
    public String getEmployeeNo() {
        return employeeNo;
    }
    
    // å…¶ä»–å­—æ®µæœ‰setter
    public void setName(String name) {
        this.name = name;
    }
    
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof Employee)) return false;
        Employee employee = (Employee) o;
        return employeeNo != null && 
               employeeNo.equals(employee.employeeNo);
    }
    
    @Override
    public int hashCode() {
        return employeeNo != null ? employeeNo.hashCode() : 0;
    }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š
```java
// âœ… æ­£ç¡®ä½¿ç”¨
Employee emp = new Employee("EMP-2024001");
emp.setName("å¼ ä¸‰");
emp.setEmail("zhangsan@company.com");

Set<Employee> employees = new HashSet<>();
employees.add(emp);

// å¯ä»¥ä¿®æ”¹å…¶ä»–å±æ€§
emp.setName("å¼ ä¸‰ä¸°");
emp.setDepartment("ç ”å‘éƒ¨");

// equals/hashCodeç¨³å®š
employees.contains(emp);  // trueï¼ˆemployeeNoæœªå˜ï¼‰

// âŒ æ— æ³•ä¿®æ”¹ä¸šåŠ¡å”¯ä¸€é”®
// emp.setEmployeeNo("EMP-2024002");  // ç¼–è¯‘é”™è¯¯ï¼Œæ²¡æœ‰setter
```

### 6.3 å€¼å¯¹è±¡çš„å®Œå…¨ä¸å¯å˜æ€§


**å€¼å¯¹è±¡è®¾è®¡**ï¼š
```java
// å®Œå…¨ä¸å¯å˜çš„å€¼å¯¹è±¡
@Embeddable
public class Money {
    private final BigDecimal amount;
    private final String currency;
    
    // JPAéœ€è¦
    protected Money() {
        this.amount = null;
        this.currency = null;
    }
    
    public Money(BigDecimal amount, String currency) {
        this.amount = amount;
        this.currency = currency;
    }
    
    // åªæœ‰getter
    public BigDecimal getAmount() { return amount; }
    public String getCurrency() { return currency; }
    
    // æä¾›æ–°å»ºå¯¹è±¡çš„æ–¹æ³•ï¼Œè€Œéä¿®æ”¹
    public Money add(Money other) {
        if (!this.currency.equals(other.currency)) {
            throw new IllegalArgumentException("è´§å¸ç±»å‹ä¸åŒ¹é…");
        }
        return new Money(
            this.amount.add(other.amount), 
            this.currency
        );
    }
    
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof Money)) return false;
        Money money = (Money) o;
        return amount.equals(money.amount) && 
               currency.equals(money.currency);
    }
    
    @Override
    public int hashCode() {
        return Objects.hash(amount, currency);
    }
}

// ä½¿ç”¨å€¼å¯¹è±¡
@Entity
public class Product {
    @Id
    private Long id;
    
    @Embedded
    private Money price;
    
    // ä¿®æ”¹ä»·æ ¼ï¼šåˆ›å»ºæ–°å¯¹è±¡ï¼Œè€Œéä¿®æ”¹åŸå¯¹è±¡
    public void increasePrice(BigDecimal increment) {
        this.price = new Money(
            price.getAmount().add(increment),
            price.getCurrency()
        );
    }
}
```

**ä¸å¯å˜æ€§çš„å¥½å¤„**ï¼š
```
çº¿ç¨‹å®‰å…¨ï¼š
â€¢ ä¸å¯å˜å¯¹è±¡å¤©ç„¶çº¿ç¨‹å®‰å…¨
â€¢ å¯ä»¥å®‰å…¨åœ°åœ¨å¤šçº¿ç¨‹é—´å…±äº«

é›†åˆå®‰å…¨ï¼š
â€¢ æ”¾å…¥Set/Mapåä¸ä¼šå‡ºé—®é¢˜
â€¢ hashCodeæ°¸è¿œä¸å˜

ä»£ç æ¸…æ™°ï¼š
â€¢ å€¼ä¸ä¼šæ„å¤–æ”¹å˜
â€¢ å‡å°‘å‰¯ä½œç”¨
â€¢ æ˜“äºç†è§£å’Œç»´æŠ¤

æ¨èå®è·µï¼š
âœ… ä¸šåŠ¡å”¯ä¸€é”®è®¾ä¸ºä¸å¯å˜
âœ… å€¼å¯¹è±¡è®¾è®¡ä¸ºä¸å¯å˜
âœ… èƒ½ç”¨finalçš„åœ°æ–¹ç”¨final
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å®ä½“ç­‰å€¼æ€§ï¼šåˆ¤æ–­ä¸¤ä¸ªå®ä½“æ˜¯å¦"ç›¸åŒ"çš„ä¾æ®
ğŸ”¸ ä¸šåŠ¡å”¯ä¸€é”®ï¼šçœŸæ­£èƒ½åŒºåˆ†å®ä½“çš„ä¸šåŠ¡å±æ€§
ğŸ”¸ equals/hashCodeï¼šå¿…é¡»æˆå¯¹å®ç°ï¼Œä¿æŒä¸€è‡´æ€§
ğŸ”¸ é¿å…å»¶è¿ŸåŠ è½½å­—æ®µï¼šequalsä¸­ä¸è¦è®¿é—®LAZYå­—æ®µ
ğŸ”¸ Setå»é‡é™·é˜±ï¼šä¿®æ”¹ä¸šåŠ¡é”®ä¼šå¯¼è‡´é›†åˆæ··ä¹±
ğŸ”¸ ä»£ç†å¯¹è±¡å¤„ç†ï¼šä½¿ç”¨instanceofè€ŒégetClass()
ğŸ”¸ æ ‡è¯†ç¬¦é€‰æ‹©ï¼šè‡ªç„¶é”®ã€ä»£ç†é”®ã€UUIDå„æœ‰é€‚ç”¨åœºæ™¯
ğŸ”¸ ä¸å¯å˜æ€§ï¼šä¸šåŠ¡å”¯ä¸€é”®åº”è®¾ä¸ºä¸å¯å˜
```

### 7.2 å®ç°equals/hashCodeçš„é»„é‡‘æ³•åˆ™


**ğŸ“œ å¿…é¡»éµå®ˆçš„è§„åˆ™**ï¼š

```
1ï¸âƒ£ åŸºäºä¸šåŠ¡å”¯ä¸€é”®å®ç°
   âœ… ä½¿ç”¨ç¨³å®šçš„ä¸šåŠ¡å±æ€§ï¼ˆå­¦å·ã€è®¢å•å·ã€UUIDï¼‰
   âŒ ä¸è¦ç”¨æ•°æ®åº“IDï¼ˆç¬æ€å¯¹è±¡IDä¸ºnullï¼‰
   âŒ ä¸è¦ç”¨å¯å˜å±æ€§

2ï¸âƒ£ é¿å…å»¶è¿ŸåŠ è½½å­—æ®µ
   âœ… åªç”¨åŸºæœ¬ç±»å‹å’ŒString
   âŒ ä¸è¦ç”¨@ManyToOneç­‰å…³è”å­—æ®µ
   åŸå› ï¼šå¯èƒ½è§¦å‘æ„å¤–çš„æ•°æ®åº“æŸ¥è¯¢

3ï¸âƒ£ æ­£ç¡®å¤„ç†null
   âœ… businessKey != null && businessKey.equals(...)
   âŒ businessKey.equals(...)  // å¯èƒ½NPE

4ï¸âƒ£ å¤„ç†ä»£ç†å¯¹è±¡
   âœ… ä½¿ç”¨instanceofæ£€æŸ¥ç±»å‹
   âŒ ä½¿ç”¨getClass()ï¼ˆä»£ç†ç±»å’Œå®ä½“ç±»ä¸ç›¸ç­‰ï¼‰

5ï¸âƒ£ equalså’ŒhashCodeä¸€è‡´
   âœ… ä¸¤ä¸ªæ–¹æ³•ç”¨ç›¸åŒçš„å­—æ®µ
   âŒ equalsç”¨Aå­—æ®µï¼ŒhashCodeç”¨Bå­—æ®µ
```

### 7.3 é›†åˆä½¿ç”¨æœ€ä½³å®è·µ


**ğŸ¯ Set vs List é€‰æ‹©æŒ‡å—**ï¼š

| åœºæ™¯ | **æ¨è** | **åŸå› ** |
|------|---------|----------|
| å®ä½“å¯èƒ½ä¿®æ”¹ | `List` | `é¿å…hashCodeå˜åŒ–é—®é¢˜` |
| éœ€è¦ä¿æŒé¡ºåº | `List` | `@OrderColumnæˆ–Comparator` |
| ç®€å•å€¼ç±»å‹é›†åˆ | `Set` | `å¦‚Set<String>ï¼Œç¨³å®šä¸å˜` |
| å¤šå¯¹å¤šå…³ç³» | `Set` | `è‡ªç„¶è¯­ä¹‰ï¼Œéœ€è¦å»é‡` |
| ä¸€å¯¹å¤šå…³ç³» | `List` | `é€šå¸¸éœ€è¦é¡ºåº` |

**âš ï¸ Setä½¿ç”¨æ³¨æ„äº‹é¡¹**ï¼š
```
ä½¿ç”¨Setæ—¶çš„çº¦æŸï¼š
1. æ·»åŠ åˆ°Setåï¼Œä¸è¦ä¿®æ”¹ä¸šåŠ¡å”¯ä¸€é”®
2. è€ƒè™‘ç”¨Listä»£æ›¿Setï¼ˆæ‰‹åŠ¨å»é‡ï¼‰
3. å¦‚æœå¿…é¡»ç”¨Setï¼Œä¸šåŠ¡é”®è®¾ä¸ºä¸å¯å˜

// âŒ å±é™©æ“ä½œ
Set<Entity> set = new HashSet<>();
Entity e = new Entity("KEY-1");
set.add(e);
e.setBusinessKey("KEY-2");  // ä¸è¦è¿™æ ·åšï¼

// âœ… å®‰å…¨æ“ä½œ
List<Entity> list = new ArrayList<>();
Entity e = new Entity("KEY-1");
list.add(e);
e.setBusinessKey("KEY-2");  // å¯ä»¥ä¿®æ”¹ï¼Œä½†è¦æ³¨æ„å»é‡é€»è¾‘
```

### 7.4 å®ä½“è®¾è®¡æ£€æŸ¥æ¸…å•


**âœ… å®ä½“è®¾è®¡è‡ªæ£€è¡¨**ï¼š

```
[ ] æ˜¯å¦æœ‰æ˜ç¡®çš„ä¸šåŠ¡å”¯ä¸€é”®ï¼Ÿ
    â†’ å­¦å·ã€è®¢å•å·ã€UUIDç­‰

[ ] equals/hashCodeæ˜¯å¦åŸºäºä¸šåŠ¡å”¯ä¸€é”®ï¼Ÿ
    â†’ ä¸è¦ç”¨æ•°æ®åº“ID

[ ] ä¸šåŠ¡å”¯ä¸€é”®æ˜¯å¦å¯èƒ½æ”¹å˜ï¼Ÿ
    â†’ å¦‚æœå¯èƒ½æ”¹å˜ï¼Œè€ƒè™‘è®¾ä¸ºfinalæˆ–ç”¨List

[ ] equalsä¸­æ˜¯å¦ä½¿ç”¨äº†å»¶è¿ŸåŠ è½½å­—æ®µï¼Ÿ
    â†’ é¿å…ä½¿ç”¨@ManyToOneç­‰å…³è”å­—æ®µ

[ ] æ˜¯å¦æ­£ç¡®å¤„ç†ä»£ç†å¯¹è±¡ï¼Ÿ
    â†’ ä½¿ç”¨instanceofè€ŒégetClass()

[ ] æ˜¯å¦æ­£ç¡®å¤„ç†nullï¼Ÿ
    â†’ æ‰€æœ‰æ¯”è¾ƒå‰æ£€æŸ¥null

[ ] å¦‚æœä½¿ç”¨Setï¼Œæ˜¯å¦ç¡®ä¿ä¸šåŠ¡é”®ä¸ä¼šæ”¹å˜ï¼Ÿ
    â†’ æˆ–è€…æ”¹ç”¨List

[ ] æ˜¯å¦è€ƒè™‘äº†çº¿ç¨‹å®‰å…¨ï¼Ÿ
    â†’ ä¸šåŠ¡å”¯ä¸€é”®ä¸å¯å˜å¯ä»¥æé«˜å®‰å…¨æ€§
```

### 7.5 å¸¸è§é”™è¯¯ä¸è§£å†³æ–¹æ¡ˆ


**âŒ é”™è¯¯1ï¼šåŸºäºæ•°æ®åº“IDå®ç°equals**
```java
// âŒ é”™è¯¯
@Override
public boolean equals(Object o) {
    Entity entity = (Entity) o;
    return id != null && id.equals(entity.id);
}

// âœ… æ­£ç¡®
@Override
public boolean equals(Object o) {
    Entity entity = (Entity) o;
    return businessKey != null && 
           businessKey.equals(entity.businessKey);
}
```

**âŒ é”™è¯¯2ï¼šåœ¨equalsä¸­è®¿é—®å»¶è¿ŸåŠ è½½å­—æ®µ**
```java
// âŒ é”™è¯¯
@Override
public boolean equals(Object o) {
    Order order = (Order) o;
    return customer.equals(order.customer);  // å¯èƒ½è§¦å‘æŸ¥è¯¢
}

// âœ… æ­£ç¡®
@Override
public boolean equals(Object o) {
    Order order = (Order) o;
    return orderNo != null && orderNo.equals(order.orderNo);
}
```

**âŒ é”™è¯¯3ï¼šä¿®æ”¹Setä¸­å¯¹è±¡çš„ä¸šåŠ¡é”®**
```java
// âŒ é”™è¯¯
Set<Entity> set = new HashSet<>();
Entity e = new Entity();
e.setBusinessKey("KEY-1");
set.add(e);
e.setBusinessKey("KEY-2");  // Setå†…éƒ¨æ··ä¹±

// âœ… æ­£ç¡®æ–¹æ¡ˆ1ï¼šä½¿ç”¨List
List<Entity> list = new ArrayList<>();
// æ‰‹åŠ¨å¤„ç†å»é‡é€»è¾‘

// âœ… æ­£ç¡®æ–¹æ¡ˆ2ï¼šä¸šåŠ¡é”®ä¸å¯å˜
public class Entity {
    private final String businessKey;
    public Entity(String businessKey) {
        this.businessKey = businessKey;
    }
}
```

### 7.6 å®æˆ˜å»ºè®®


**ğŸ’¡ æ–°æ‰‹å®è·µå»ºè®®**ï¼š

```
åˆå­¦é˜¶æ®µï¼š
1. å…ˆç†è§£equals/hashCodeçš„åŸºæœ¬ä½œç”¨
2. ä½¿ç”¨IDEè‡ªåŠ¨ç”Ÿæˆï¼ˆåŸºäºä¸šåŠ¡é”®ï¼‰
3. é¿å…ä½¿ç”¨Setï¼Œä¼˜å…ˆç”¨List

è¿›é˜¶é˜¶æ®µï¼š
1. æ·±å…¥ç†è§£ä»£ç†å¯¹è±¡æœºåˆ¶
2. æŒæ¡Setçš„ä½¿ç”¨åœºæ™¯å’Œé™·é˜±
3. å­¦ä¼šè®¾è®¡ä¸å¯å˜çš„ä¸šåŠ¡å”¯ä¸€é”®

ä¸“å®¶é˜¶æ®µï¼š
1. æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©æœ€ä½³æ–¹æ¡ˆ
2. æƒè¡¡æ€§èƒ½ã€å®‰å…¨æ€§ã€æ˜“ç”¨æ€§
3. å»ºç«‹å›¢é˜Ÿçš„å®ä½“è®¾è®¡è§„èŒƒ
```

**ğŸ¯ ä¸€å¥è¯æ€»ç»“**ï¼š
```
equals/hashCodeåŸºäºä¸šåŠ¡å”¯ä¸€é”®ï¼Œ
é¿å…å»¶è¿ŸåŠ è½½å­—æ®µï¼Œ
å¤„ç†å¥½ä»£ç†å¯¹è±¡ï¼Œ
Setè°¨æ…ç”¨ï¼ŒListæ›´å®‰å…¨ï¼
```

**ğŸ§  è®°å¿†å£è¯€**ï¼š
```
ä¸šåŠ¡é”®ç¨³å®šï¼Œç­‰å€¼æ‰å¯é 
å»¶è¿Ÿå­—æ®µç¢°ä¸å¾—ï¼Œä»£ç†å¯¹è±¡è¦å°å¿ƒ
Setè™½å¥½ç”¨ï¼Œé™·é˜±è¦æé˜²
ä¸å¯å˜è®¾è®¡ï¼Œä¸€åŠ³æ°¸é€¸ä¿å¹³å®‰
```