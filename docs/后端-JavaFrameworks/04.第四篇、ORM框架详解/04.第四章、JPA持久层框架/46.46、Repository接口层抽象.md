---
title: 46ã€Repositoryæ¥å£å±‚æŠ½è±¡
---
## ğŸ“š ç›®å½•

1. [Repositoryæ¥å£ä½“ç³»æ¦‚è¿°](#1-Repositoryæ¥å£ä½“ç³»æ¦‚è¿°)
2. [Repositoryæ ‡è®°æ¥å£](#2-Repositoryæ ‡è®°æ¥å£)
3. [CrudRepositoryåŸºç¡€CRUD](#3-CrudRepositoryåŸºç¡€CRUD)
4. [PagingAndSortingRepositoryåˆ†é¡µæ’åº](#4-PagingAndSortingRepositoryåˆ†é¡µæ’åº)
5. [JpaRepositoryå®Œæ•´åŠŸèƒ½](#5-JpaRepositoryå®Œæ•´åŠŸèƒ½)
6. [è‡ªåŠ¨ä»£ç†å®ç°æœºåˆ¶](#6-è‡ªåŠ¨ä»£ç†å®ç°æœºåˆ¶)
7. [é…ç½®ç±»è®¾ç½®](#7-é…ç½®ç±»è®¾ç½®)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Repositoryæ¥å£ä½“ç³»æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Repositoryæ¥å£å±‚


**é€šä¿—ç†è§£**ï¼šRepositoryå°±åƒæ˜¯ä¸€ä¸ª"ä»“åº“ç®¡ç†å‘˜"ï¼Œä½ å‘Šè¯‰å®ƒä½ è¦ä»€ä¹ˆæ•°æ®ï¼Œå®ƒå¸®ä½ å»æ•°æ®åº“é‡Œå–ï¼Œè€Œä½ ä¸éœ€è¦å…³å¿ƒSQLæ€ä¹ˆå†™ã€‚

```
ä¼ ç»Ÿå¼€å‘æ–¹å¼ï¼š                 Spring Data JPAæ–¹å¼ï¼š
å¼€å‘è€… â†’ å†™SQL â†’ DAOå®ç°      å¼€å‘è€… â†’ å®šä¹‰æ¥å£ â†’ è‡ªåŠ¨å®ç°
     â†“                              â†“
  æ‰§è¡ŒSQL                        è°ƒç”¨æ–¹æ³•
     â†“                              â†“
  è·å–ç»“æœ                        è·å–ç»“æœ

ä¼˜åŠ¿ï¼šçœå»å¤§é‡é‡å¤çš„CRUDä»£ç ç¼–å†™
```

### 1.2 Repositoryæ¥å£å±‚æ¬¡ç»“æ„


**æ¥å£ç»§æ‰¿å…³ç³»å›¾**ï¼š
```
                Repository<T, ID>
                      â†‘
                      |ï¼ˆæ ‡è®°æ¥å£ï¼Œæ²¡æœ‰æ–¹æ³•ï¼‰
                      |
           CrudRepository<T, ID>
                      â†‘
                      |ï¼ˆåŸºç¡€å¢åˆ æ”¹æŸ¥ï¼‰
                      |
      PagingAndSortingRepository<T, ID>
                      â†‘
                      |ï¼ˆå¢åŠ åˆ†é¡µå’Œæ’åºï¼‰
                      |
            JpaRepository<T, ID>
                      â†‘
                      |ï¼ˆJPAç‰¹æœ‰åŠŸèƒ½ï¼‰
                      |
              ä½ çš„è‡ªå®šä¹‰æ¥å£
           ï¼ˆå¦‚ï¼šUserRepositoryï¼‰
```

**å±‚æ¬¡è¯´æ˜**ï¼š
- `Repository` - æœ€é¡¶å±‚ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œåªæ˜¯ä¸€ä¸ª**æ ‡è®°**
- `CrudRepository` - æä¾›**åŸºç¡€**çš„å¢åˆ æ”¹æŸ¥
- `PagingAndSortingRepository` - å¢åŠ **åˆ†é¡µ**å’Œ**æ’åº**åŠŸèƒ½
- `JpaRepository` - **æœ€å¼ºå¤§**ï¼ŒåŒ…å«æ‰€æœ‰åŠŸèƒ½
- ä½ çš„æ¥å£ - ç»§æ‰¿ä¸Šé¢ä»»æ„ä¸€ä¸ªï¼Œè·å¾—å¯¹åº”èƒ½åŠ›

---

## 2. ğŸ·ï¸ Repositoryæ ‡è®°æ¥å£


### 2.1 Repositoryæ¥å£çš„ä½œç”¨


**æ ¸å¿ƒå®šä¹‰**ï¼š
```java
// Spring Dataçš„é¡¶å±‚æ¥å£
package org.springframework.data.repository;

public interface Repository<T, ID> {
    // ç©ºæ¥å£ï¼æ²¡æœ‰ä»»ä½•æ–¹æ³•å®šä¹‰
}
```

**é€šä¿—è§£é‡Š**ï¼š
- Repositoryæ¥å£æœ¬èº«**ä»€ä¹ˆéƒ½ä¸åš**
- å®ƒåªæ˜¯ä¸€ä¸ª**æ ‡è®°**ï¼Œå‘Šè¯‰Springï¼š"è¿™æ˜¯ä¸€ä¸ªæ•°æ®è®¿é—®æ¥å£"
- å°±åƒåœ¨é—¨ä¸Šè´´ä¸ªæ ‡ç­¾ï¼š"è¿™æ˜¯ä»“åº“"

### 2.2 ä¸ºä»€ä¹ˆéœ€è¦æ ‡è®°æ¥å£


**è®¾è®¡ç†å¿µ**ï¼š**çº¦å®šä¼˜äºé…ç½®**ï¼ˆConvention over Configurationï¼‰

```
ä¼ ç»Ÿæ–¹å¼éœ€è¦é…ç½®ï¼š
@Component
public class UserDaoImpl implements UserDao {
    // éœ€è¦å†™å¤§é‡ä»£ç 
}

Spring Dataæ–¹å¼ï¼ˆçº¦å®šï¼‰ï¼š
public interface UserRepository extends Repository<User, Long> {
    // ä»€ä¹ˆéƒ½ä¸å†™ï¼ŒSpringè‡ªåŠ¨è¯†åˆ«å¹¶å®ç°
}

åªè¦ç»§æ‰¿äº†Repositoryï¼ŒSpringå°±çŸ¥é“è¿™æ˜¯æ•°æ®è®¿é—®å±‚ï¼
```

**å®é™…æ„ä¹‰**ï¼š
- **è¯†åˆ«ä½œç”¨**ï¼šSpringæ‰«æåˆ°è¿™ä¸ªæ¥å£ï¼ŒçŸ¥é“è¦è‡ªåŠ¨ç”Ÿæˆå®ç°ç±»
- **ç±»å‹å®‰å…¨**ï¼šæ³›å‹`<T, ID>`ç¡®ä¿å®ä½“ç±»å‹å’ŒIDç±»å‹æ­£ç¡®
- **çµæ´»æ‰©å±•**ï¼šä½ å¯ä»¥é€‰æ‹©ç»§æ‰¿Repositoryçš„å­æ¥å£è·å¾—æ›´å¤šåŠŸèƒ½

---

## 3. âœ… CrudRepositoryåŸºç¡€CRUD


### 3.1 CrudRepositoryæä¾›çš„æ–¹æ³•


**æ¥å£å®šä¹‰**ï¼š
```java
public interface CrudRepository<T, ID> extends Repository<T, ID> {
    
    // ä¿å­˜å•ä¸ªå®ä½“
    <S extends T> S save(S entity);
    
    // æ‰¹é‡ä¿å­˜
    <S extends T> Iterable<S> saveAll(Iterable<S> entities);
    
    // æ ¹æ®IDæŸ¥è¯¢
    Optional<T> findById(ID id);
    
    // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
    boolean existsById(ID id);
    
    // æŸ¥è¯¢æ‰€æœ‰
    Iterable<T> findAll();
    
    // æ ¹æ®IDé›†åˆæŸ¥è¯¢
    Iterable<T> findAllById(Iterable<ID> ids);
    
    // ç»Ÿè®¡æ•°é‡
    long count();
    
    // æ ¹æ®IDåˆ é™¤
    void deleteById(ID id);
    
    // åˆ é™¤å®ä½“
    void delete(T entity);
    
    // æ‰¹é‡åˆ é™¤
    void deleteAll(Iterable<? extends T> entities);
    
    // åˆ é™¤æ‰€æœ‰
    void deleteAll();
}
```

### 3.2 å®é™…ä½¿ç”¨ç¤ºä¾‹


**å®šä¹‰è‡ªå·±çš„Repository**ï¼š
```java
// 1. åˆ›å»ºå®ä½“ç±»
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String username;
    private String email;
    
    // getter/setterçœç•¥
}

// 2. åˆ›å»ºRepositoryæ¥å£ï¼ˆç»§æ‰¿CrudRepositoryï¼‰
public interface UserRepository extends CrudRepository<User, Long> {
    // ä¸éœ€è¦å†™ä»»ä½•ä»£ç ï¼æ‰€æœ‰åŸºç¡€æ–¹æ³•å·²ç»æœ‰äº†
}

// 3. ä½¿ç”¨ï¼ˆåœ¨Serviceå±‚ï¼‰
@Service
public class UserService {
    @Autowired
    private UserRepository userRepository;
    
    public void basicOperations() {
        // ä¿å­˜ç”¨æˆ·
        User user = new User();
        user.setUsername("å¼ ä¸‰");
        user.setEmail("zhangsan@example.com");
        userRepository.save(user);  // è‡ªåŠ¨æ’å…¥æ•°æ®åº“
        
        // æŸ¥è¯¢ç”¨æˆ·
        Optional<User> found = userRepository.findById(1L);
        if (found.isPresent()) {
            System.out.println("æ‰¾åˆ°ç”¨æˆ·ï¼š" + found.get().getUsername());
        }
        
        // ç»Ÿè®¡æ•°é‡
        long count = userRepository.count();
        System.out.println("æ€»å…±æœ‰ " + count + " ä¸ªç”¨æˆ·");
        
        // åˆ é™¤ç”¨æˆ·
        userRepository.deleteById(1L);
    }
}
```

### 3.3 saveæ–¹æ³•çš„æ™ºèƒ½åˆ¤æ–­


**æ ¸å¿ƒç‰¹ç‚¹**ï¼š`save()`æ–¹æ³•ä¼š**è‡ªåŠ¨åˆ¤æ–­**æ˜¯æ–°å¢è¿˜æ˜¯æ›´æ–°

```
åˆ¤æ–­é€»è¾‘ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è°ƒç”¨ save(entity)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å®ä½“IDæ˜¯å¦ä¸ºnull?â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â†“       â†“
      æ˜¯(null) å¦(æœ‰å€¼)
         â†“       â†“
    æ‰§è¡ŒINSERT  æ‰§è¡ŒUPDATE
```

**å®é™…æ¡ˆä¾‹**ï¼š
```java
// åœºæ™¯1ï¼šæ–°å¢ï¼ˆIDä¸ºnullï¼‰
User newUser = new User();
newUser.setUsername("æå››");  // IDæ²¡è®¾ç½®ï¼Œé»˜è®¤null
userRepository.save(newUser);  // æ‰§è¡ŒINSERT

// åœºæ™¯2ï¼šæ›´æ–°ï¼ˆIDæœ‰å€¼ï¼‰
User existingUser = userRepository.findById(1L).get();
existingUser.setEmail("new@example.com");  // ID=1
userRepository.save(existingUser);  // æ‰§è¡ŒUPDATE
```

---

## 4. ğŸ“„ PagingAndSortingRepositoryåˆ†é¡µæ’åº


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†é¡µæ’åº


**å®é™…åœºæ™¯**ï¼š
```
é—®é¢˜ï¼šæ•°æ®åº“æœ‰10ä¸‡æ¡ç”¨æˆ·æ•°æ®
     ä¸€æ¬¡æ€§æŸ¥è¯¢ findAll() â†’ å†…å­˜çˆ†ç‚¸ï¼

è§£å†³ï¼šåˆ†é¡µæŸ¥è¯¢
     æ¯é¡µæ˜¾ç¤º20æ¡ â†’ å¤šæ¬¡æŸ¥è¯¢ â†’ å†…å­˜å‹å¥½
```

### 4.2 æ¥å£å®šä¹‰


```java
public interface PagingAndSortingRepository<T, ID> 
        extends CrudRepository<T, ID> {
    
    // åˆ†é¡µæŸ¥è¯¢
    Page<T> findAll(Pageable pageable);
    
    // æ’åºæŸ¥è¯¢
    Iterable<T> findAll(Sort sort);
}
```

**æ–°å¢çš„æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- `Pageable` - åˆ†é¡µå‚æ•°ï¼ˆç¬¬å‡ é¡µã€æ¯é¡µå¤šå°‘æ¡ï¼‰
- `Page` - åˆ†é¡µç»“æœï¼ˆåŒ…å«æ•°æ®å’Œåˆ†é¡µä¿¡æ¯ï¼‰
- `Sort` - æ’åºå‚æ•°ï¼ˆæŒ‰ä»€ä¹ˆå­—æ®µæ’åºï¼‰

### 4.3 åˆ†é¡µæŸ¥è¯¢å®æˆ˜


**å®Œæ•´ç¤ºä¾‹**ï¼š
```java
// 1. Repositoryæ¥å£
public interface UserRepository 
        extends PagingAndSortingRepository<User, Long> {
    // è‡ªåŠ¨æ‹¥æœ‰åˆ†é¡µå’Œæ’åºèƒ½åŠ›
}

// 2. Serviceå±‚ä½¿ç”¨
@Service
public class UserService {
    @Autowired
    private UserRepository userRepository;
    
    // åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·
    public Page<User> getUsersByPage(int pageNo, int pageSize) {
        // åˆ›å»ºåˆ†é¡µå‚æ•°ï¼ˆé¡µç ä»0å¼€å§‹ï¼‰
        Pageable pageable = PageRequest.of(pageNo, pageSize);
        
        // æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢
        Page<User> userPage = userRepository.findAll(pageable);
        
        // åˆ†é¡µä¿¡æ¯
        System.out.println("æ€»è®°å½•æ•°: " + userPage.getTotalElements());
        System.out.println("æ€»é¡µæ•°: " + userPage.getTotalPages());
        System.out.println("å½“å‰é¡µç : " + userPage.getNumber());
        
        return userPage;
    }
    
    // å¸¦æ’åºçš„åˆ†é¡µæŸ¥è¯¢
    public Page<User> getUsersSorted(int pageNo, int pageSize) {
        // åˆ›å»ºæ’åºï¼ˆæŒ‰ç”¨æˆ·åå‡åºï¼‰
        Sort sort = Sort.by(Sort.Direction.ASC, "username");
        
        // åˆ†é¡µ+æ’åº
        Pageable pageable = PageRequest.of(pageNo, pageSize, sort);
        
        return userRepository.findAll(pageable);
    }
}
```

### 4.4 åˆ†é¡µå¯¹è±¡Pageè¯¦è§£


**Pageå¯¹è±¡åŒ…å«çš„ä¿¡æ¯**ï¼š

| æ–¹æ³• | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `getContent()` | è·å–å½“å‰é¡µæ•°æ® | `[User1, User2, ...]` |
| `getTotalElements()` | æ€»è®°å½•æ•° | `10000` |
| `getTotalPages()` | æ€»é¡µæ•° | `500`ï¼ˆæ¯é¡µ20æ¡ï¼‰ |
| `getNumber()` | å½“å‰é¡µç  | `0`ï¼ˆç¬¬ä¸€é¡µï¼‰ |
| `getSize()` | æ¯é¡µæ¡æ•° | `20` |
| `hasNext()` | æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ | `true/false` |
| `hasPrevious()` | æ˜¯å¦æœ‰ä¸Šä¸€é¡µ | `true/false` |

---

## 5. ğŸš€ JpaRepositoryå®Œæ•´åŠŸèƒ½


### 5.1 JpaRepositoryæ˜¯ä»€ä¹ˆ


**æ ¸å¿ƒå®šä½**ï¼šJpaRepositoryæ˜¯**æœ€å¼ºå¤§**çš„Repositoryæ¥å£ï¼ŒåŒ…å«äº†æ‰€æœ‰å¸¸ç”¨åŠŸèƒ½ã€‚

**ç»§æ‰¿å…³ç³»**ï¼š
```
JpaRepository åŒ…å«äº†ï¼š
â”œâ”€â”€ Repositoryï¼ˆæ ‡è®°ï¼‰
â”œâ”€â”€ CrudRepositoryï¼ˆåŸºç¡€CRUDï¼‰
â”œâ”€â”€ PagingAndSortingRepositoryï¼ˆåˆ†é¡µæ’åºï¼‰
â””â”€â”€ JpaRepositoryè‡ªå·±çš„ç‰¹æ®Šæ–¹æ³•
```

### 5.2 JpaRepositoryæ–°å¢çš„æ–¹æ³•


```java
public interface JpaRepository<T, ID> 
        extends PagingAndSortingRepository<T, ID> {
    
    // æ‰¹é‡ä¿å­˜å¹¶ç«‹å³åˆ·æ–°åˆ°æ•°æ®åº“
    <S extends T> List<S> saveAllAndFlush(Iterable<S> entities);
    
    // ä¿å­˜å¹¶ç«‹å³åˆ·æ–°
    <S extends T> S saveAndFlush(S entity);
    
    // æ‰¹é‡åˆ é™¤ï¼ˆä¸€æ¡SQLåˆ é™¤å¤šæ¡ï¼‰
    void deleteAllInBatch(Iterable<T> entities);
    
    // æ ¹æ®IDæ‰¹é‡åˆ é™¤
    void deleteAllByIdInBatch(Iterable<ID> ids);
    
    // åˆ é™¤æ‰€æœ‰ï¼ˆä¸€æ¡SQLï¼‰
    void deleteAllInBatch();
    
    // è·å–å¼•ç”¨ï¼ˆå»¶è¿ŸåŠ è½½ï¼‰
    T getReferenceById(ID id);
    
    // åˆ·æ–°åˆ°æ•°æ®åº“
    void flush();
    
    // æŸ¥è¯¢æ‰€æœ‰å¹¶æ’åºï¼ˆè¿”å›Listï¼‰
    List<T> findAll(Sort sort);
    
    // æ ¹æ®IDæŸ¥è¯¢å¤šä¸ªï¼ˆè¿”å›Listï¼‰
    List<T> findAllById(Iterable<ID> ids);
}
```

### 5.3 æ ¸å¿ƒæ–¹æ³•å¯¹æ¯”


**flush vs save**ï¼š

| æ“ä½œ | save() | saveAndFlush() |
|------|--------|----------------|
| **ä¿å­˜æ—¶æœº** | äº‹åŠ¡æäº¤æ—¶ | ç«‹å³æ‰§è¡ŒSQL |
| **æ€§èƒ½** | è¾ƒå¥½ï¼ˆæ‰¹é‡æäº¤ï¼‰ | è¾ƒå·®ï¼ˆæ¯æ¬¡éƒ½æ‰§è¡Œï¼‰ |
| **é€‚ç”¨åœºæ™¯** | ä¸€èˆ¬ä¿å­˜ | éœ€è¦ç«‹å³è·å–ID |

**ç¤ºä¾‹**ï¼š
```java
// åœºæ™¯ï¼šä¿å­˜ç”¨æˆ·åç«‹å³éœ€è¦ID
@Service
public class UserService {
    @Autowired
    private UserRepository userRepository;
    
    public Long createUserAndGetId() {
        User user = new User();
        user.setUsername("ç‹äº”");
        
        // ä½¿ç”¨saveAndFlushç«‹å³è·å–ID
        User saved = userRepository.saveAndFlush(user);
        return saved.getId();  // IDå·²ç»ç”Ÿæˆ
    }
}
```

**æ‰¹é‡åˆ é™¤å¯¹æ¯”**ï¼š

| æ–¹æ³• | SQLæ‰§è¡Œæ–¹å¼ | æ€§èƒ½ |
|------|------------|------|
| `deleteAll()` | é€æ¡DELETE | æ…¢ |
| `deleteAllInBatch()` | ä¸€æ¡DELETE WHERE IN | å¿« |

```java
// æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹
// æ–¹å¼1ï¼šé€æ¡åˆ é™¤ï¼ˆæ…¢ï¼‰
userRepository.deleteAll(users);  
// æ‰§è¡Œï¼šDELETE FROM users WHERE id=1
//      DELETE FROM users WHERE id=2
//      DELETE FROM users WHERE id=3

// æ–¹å¼2ï¼šæ‰¹é‡åˆ é™¤ï¼ˆå¿«ï¼‰
userRepository.deleteAllInBatch(users);
// æ‰§è¡Œï¼šDELETE FROM users WHERE id IN (1,2,3)
```

### 5.4 å®é™…å¼€å‘ä¸­çš„é€‰æ‹©


**æ¨èåšæ³•**ï¼š
> â­ **ä¸€èˆ¬æƒ…å†µç›´æ¥ç»§æ‰¿JpaRepository**ï¼Œå› ä¸ºå®ƒåŠŸèƒ½æœ€å…¨ï¼

```java
// æ¨èå†™æ³•
public interface UserRepository extends JpaRepository<User, Long> {
    // è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰åŠŸèƒ½ï¼š
    // - åŸºç¡€CRUD
    // - åˆ†é¡µæ’åº  
    // - JPAç‰¹æœ‰åŠŸèƒ½
}

// é™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå¦åˆ™ä¸è¦ç»§æ‰¿CrudRepositoryæˆ–PagingAndSortingRepository
```

---

## 6. ğŸ”§ è‡ªåŠ¨ä»£ç†å®ç°æœºåˆ¶


### 6.1 è‡ªåŠ¨ä»£ç†æ˜¯ä»€ä¹ˆ


**æ ¸å¿ƒåŸç†**ï¼šä½ å®šä¹‰æ¥å£ï¼ŒSpringè‡ªåŠ¨ç”Ÿæˆå®ç°ç±»ã€‚

**å·¥ä½œæµç¨‹**ï¼š
```
å¼€å‘è€…å†™çš„ä»£ç ï¼š                Springåšçš„äº‹æƒ…ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UserRepository   â”‚          â”‚ æ‰«æåˆ°Repositoryæ¥å£â”‚
â”‚ (åªæ˜¯æ¥å£)        â”‚   â†’      â”‚ è‡ªåŠ¨ç”Ÿæˆå®ç°ç±»      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ (SimpleJpaRepository)â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â†“
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ æ³¨å†Œä¸ºSpring Bean   â”‚
                              â”‚ å¯ä»¥@Autowiredä½¿ç”¨  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 åº•å±‚å®ç°åŸç†


**æŠ€æœ¯æ‰‹æ®µ**ï¼š**JDKåŠ¨æ€ä»£ç†** + **åå°„**

```java
// Springå†…éƒ¨å¤§è‡´å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
public class SimpleJpaRepository<T, ID> implements JpaRepository<T, ID> {
    
    private EntityManager entityManager;  // JPAæ“ä½œæ•°æ®åº“çš„æ ¸å¿ƒ
    
    @Override
    public <S extends T> S save(S entity) {
        if (entityçš„IDä¸ºnull) {
            entityManager.persist(entity);  // æ–°å¢
        } else {
            return entityManager.merge(entity);  // æ›´æ–°
        }
        return entity;
    }
    
    @Override
    public Optional<T> findById(ID id) {
        T entity = entityManager.find(å®ä½“ç±».class, id);
        return Optional.ofNullable(entity);
    }
    
    // å…¶ä»–æ–¹æ³•åŒç†...
}
```

**å…³é”®ç‚¹**ï¼š
- `EntityManager` - JPAçš„æ ¸å¿ƒAPIï¼Œè´Ÿè´£æ‰§è¡ŒSQL
- Springè‡ªåŠ¨åˆ›å»º`SimpleJpaRepository`çš„å®ä¾‹
- ä½ çš„`UserRepository`æ¥å£è¢«ä»£ç†åˆ°è¿™ä¸ªå®ç°ç±»

### 6.3 è‡ªåŠ¨ä»£ç†çš„å¥½å¤„


**å¯¹æ¯”ä¼ ç»Ÿå¼€å‘**ï¼š

| å¯¹æ¯”é¡¹ | ä¼ ç»Ÿå¼€å‘ | Spring Data JPA |
|--------|----------|-----------------|
| **ä»£ç é‡** | æ¯ä¸ªDAOéƒ½è¦å†™å®ç°ç±» | åªå†™æ¥å£ï¼Œ0å®ç°ä»£ç  |
| **ç»´æŠ¤æ€§** | ä¿®æ”¹éœ€è¦æ”¹å¤šå¤„ | æ¥å£ç»Ÿä¸€ï¼Œæ˜“ç»´æŠ¤ |
| **æµ‹è¯•æ€§** | éœ€è¦Mockå®ç°ç±» | ç›´æ¥Mockæ¥å£ |
| **å¼€å‘æ•ˆç‡** | ä½ | é«˜ |

---

## 7. âš™ï¸ é…ç½®ç±»è®¾ç½®


### 7.1 å¯ç”¨Spring Data JPA


**Javaé…ç½®æ–¹å¼**ï¼š
```java
@Configuration
@EnableJpaRepositories(
    basePackages = "com.example.repository",  // Repositoryæ¥å£æ‰€åœ¨åŒ…
    entityManagerFactoryRef = "entityManagerFactory",
    transactionManagerRef = "transactionManager"
)
public class JpaConfig {
    
    @Bean
    public LocalContainerEntityManagerFactoryBean entityManagerFactory(
            DataSource dataSource) {
        
        LocalContainerEntityManagerFactoryBean factory = 
            new LocalContainerEntityManagerFactoryBean();
        
        factory.setDataSource(dataSource);
        factory.setPackagesToScan("com.example.entity");  // å®ä½“ç±»åŒ…
        factory.setJpaVendorAdapter(new HibernateJpaVendorAdapter());
        
        return factory;
    }
    
    @Bean
    public PlatformTransactionManager transactionManager(
            EntityManagerFactory entityManagerFactory) {
        return new JpaTransactionManager(entityManagerFactory);
    }
}
```

### 7.2 é…ç½®é¡¹è¯´æ˜


**@EnableJpaRepositoriesæ ¸å¿ƒå‚æ•°**ï¼š

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `basePackages` | **Repositoryæ¥å£æ‰«æè·¯å¾„** | `"com.example.repository"` |
| `entityManagerFactoryRef` | EntityManagerå·¥å‚Beanåç§° | `"entityManagerFactory"` |
| `transactionManagerRef` | äº‹åŠ¡ç®¡ç†å™¨Beanåç§° | `"transactionManager"` |
| `repositoryImplementationPostfix` | è‡ªå®šä¹‰å®ç°ç±»åç¼€ | `"Impl"`ï¼ˆé»˜è®¤ï¼‰ |

### 7.3 Spring Bootè‡ªåŠ¨é…ç½®


**ç®€åŒ–é…ç½®**ï¼ˆä½¿ç”¨Spring Bootæ—¶ï¼‰ï¼š

```yaml
# application.yml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/mydb
    username: root
    password: 123456
  
  jpa:
    hibernate:
      ddl-auto: update  # è‡ªåŠ¨å»ºè¡¨
    show-sql: true      # æ˜¾ç¤ºSQL
    properties:
      hibernate:
        format_sql: true  # æ ¼å¼åŒ–SQL
```

**Spring Bootè‡ªåŠ¨åšçš„äº‹**ï¼š
- âœ… è‡ªåŠ¨é…ç½®`EntityManagerFactory`
- âœ… è‡ªåŠ¨é…ç½®`TransactionManager`
- âœ… è‡ªåŠ¨æ‰«æ`@Entity`å’ŒRepositoryæ¥å£
- âœ… ä¸éœ€è¦`@EnableJpaRepositories`ï¼ˆé»˜è®¤æ‰«æä¸»ç±»åŒ…ï¼‰

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Repositoryæ¥å£ä½“ç³»ï¼š
   Repository â†’ CrudRepository â†’ PagingAndSortingRepository â†’ JpaRepository
   
ğŸ”¸ å››å±‚æ¥å£çš„ä½œç”¨ï¼š
   - Repositoryï¼šæ ‡è®°æ¥å£ï¼Œå‘Šè¯‰Springè¿™æ˜¯æ•°æ®è®¿é—®å±‚
   - CrudRepositoryï¼šåŸºç¡€å¢åˆ æ”¹æŸ¥
   - PagingAndSortingRepositoryï¼šåˆ†é¡µå’Œæ’åº
   - JpaRepositoryï¼šæœ€å…¨åŠŸèƒ½ï¼ˆæ¨èä½¿ç”¨ï¼‰
   
ğŸ”¸ çº¦å®šä¼˜äºé…ç½®ï¼š
   åªå®šä¹‰æ¥å£ â†’ Springè‡ªåŠ¨ç”Ÿæˆå®ç° â†’ é›¶ä»£ç å®ç°CRUD
   
ğŸ”¸ è‡ªåŠ¨ä»£ç†æœºåˆ¶ï¼š
   æ¥å£ â†’ åŠ¨æ€ä»£ç† â†’ SimpleJpaRepository â†’ EntityManager â†’ æ•°æ®åº“
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆåªå†™æ¥å£å°±èƒ½ç”¨**
```
åŸå› ï¼šSpringçš„è‡ªåŠ¨ä»£ç†æœºåˆ¶
1. æ‰«æåˆ°ç»§æ‰¿Repositoryçš„æ¥å£
2. è‡ªåŠ¨ç”ŸæˆSimpleJpaRepositoryå®ç°ç±»
3. æ³¨å†Œä¸ºSpring Bean
4. ä½ å°±å¯ä»¥@Autowiredä½¿ç”¨äº†
```

**ğŸ”¹ saveæ–¹æ³•çš„æ™ºèƒ½ä¹‹å¤„**
```
save(entity)ä¼šè‡ªåŠ¨åˆ¤æ–­ï¼š
- IDä¸ºnull â†’ æ‰§è¡ŒINSERTï¼ˆæ–°å¢ï¼‰
- IDæœ‰å€¼ â†’ æ‰§è¡ŒUPDATEï¼ˆæ›´æ–°ï¼‰

ä¸éœ€è¦ä½ åˆ¤æ–­ï¼ŒSpringå¸®ä½ åšäº†ï¼
```

**ğŸ”¹ é€‰æ‹©å“ªä¸ªæ¥å£ç»§æ‰¿**
```
ä¸€èˆ¬å¼€å‘ï¼šç›´æ¥ç»§æ‰¿JpaRepository
ç‰¹æ®Šåœºæ™¯ï¼š
- åªéœ€è¦åŸºç¡€CRUD â†’ CrudRepository
- éœ€è¦åˆ†é¡µæ’åº â†’ PagingAndSortingRepository
- éœ€è¦æ‰€æœ‰åŠŸèƒ½ â†’ JpaRepositoryï¼ˆæ¨èï¼‰
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… æœ€ä½³å®è·µ**ï¼š
```java
// 1. å®ä½“ç±»æ ‡æ³¨@Entity
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue
    private Long id;
    // å…¶ä»–å­—æ®µ...
}

// 2. Repositoryç»§æ‰¿JpaRepository
public interface UserRepository extends JpaRepository<User, Long> {
    // 0ä»£ç ï¼Œæ‰€æœ‰åŠŸèƒ½éƒ½æœ‰äº†
}

// 3. Serviceå±‚æ³¨å…¥ä½¿ç”¨
@Service
public class UserService {
    @Autowired
    private UserRepository userRepository;
    
    // ç›´æ¥è°ƒç”¨æ–¹æ³•
    public void doSomething() {
        userRepository.save(user);
        userRepository.findById(1L);
        // ...
    }
}
```

**âŒ å¸¸è§è¯¯åŒº**ï¼š
- âŒ ä¸è¦è‡ªå·±å®ç°Repositoryæ¥å£ï¼ˆSpringä¼šè‡ªåŠ¨å®ç°ï¼‰
- âŒ ä¸è¦åœ¨Repositoryé‡Œå†™ä¸šåŠ¡é€»è¾‘ï¼ˆåº”è¯¥åœ¨Serviceå±‚ï¼‰
- âŒ ä¸è¦å¿˜è®°åŠ `@Autowired`æ³¨å…¥Repository

### 8.4 é…ç½®è¦ç‚¹


**Spring Booté¡¹ç›®**ï¼ˆæ¨èï¼‰ï¼š
```yaml
# åªéœ€é…ç½®æ•°æ®æº
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/mydb
  jpa:
    show-sql: true  # å¯é€‰ï¼šæ˜¾ç¤ºSQL
```

**ä¼ ç»ŸSpringé¡¹ç›®**ï¼š
```java
// éœ€è¦æ‰‹åŠ¨é…ç½®
@EnableJpaRepositories(basePackages = "com.example.repository")
```

---

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Repositoryæ ‡è®°èº«ä»½ï¼ŒSpringè¯†åˆ«å®ƒ
- CRUDåŸºç¡€å¢åˆ æŸ¥ï¼Œåˆ†é¡µæ’åºä¸å¯å°‘
- JPAåŠŸèƒ½æœ€å¼ºå¤§ï¼Œä¸€èˆ¬å¼€å‘å°±ç”¨å®ƒ
- æ¥å£å®šä¹‰é›¶ä»£ç ï¼Œè‡ªåŠ¨ä»£ç†å¸®å®ç°
- é…ç½®ç®€å•æ•ˆç‡é«˜ï¼Œçº¦å®šä¼˜äºé…ç½®å¥½