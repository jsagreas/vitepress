---
title: 76ã€äº‹åŠ¡ç²’åº¦ä¸æ‡’åŠ è½½å¼‚å¸¸
---
## ğŸ“š ç›®å½•

1. [äº‹åŠ¡è¾¹ç•Œè®¾è®¡åŸºç¡€](#1-äº‹åŠ¡è¾¹ç•Œè®¾è®¡åŸºç¡€)
2. [æœåŠ¡å±‚äº‹åŠ¡ç®¡ç†](#2-æœåŠ¡å±‚äº‹åŠ¡ç®¡ç†)
3. [æ‡’åŠ è½½å¼‚å¸¸é—®é¢˜](#3-æ‡’åŠ è½½å¼‚å¸¸é—®é¢˜)
4. [äº‹åŠ¡ç²’åº¦æ§åˆ¶ç­–ç•¥](#4-äº‹åŠ¡ç²’åº¦æ§åˆ¶ç­–ç•¥)
5. [å¼‚å¸¸å›æ»šç­–ç•¥](#5-å¼‚å¸¸å›æ»šç­–ç•¥)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ äº‹åŠ¡è¾¹ç•Œè®¾è®¡åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡è¾¹ç•Œ


**é€šä¿—ç†è§£**ï¼šäº‹åŠ¡è¾¹ç•Œå°±åƒæ˜¯ä¸€ä¸ª"å·¥ä½œèŒƒå›´"çš„èµ·ç‚¹å’Œç»ˆç‚¹

```
æƒ³è±¡ä½ åœ¨é“¶è¡Œè½¬è´¦ï¼š
æ­¥éª¤1ï¼šä»Aè´¦æˆ·æ‰£é’±  â”
æ­¥éª¤2ï¼šç»™Bè´¦æˆ·åŠ é’±  â”œâ”€ è¿™å°±æ˜¯ä¸€ä¸ªäº‹åŠ¡è¾¹ç•Œ
æ­¥éª¤3ï¼šè®°å½•è½¬è´¦æ—¥å¿—  â”˜

è¦ä¹ˆ3æ­¥å…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥ï¼
```

**ä¸“ä¸šå®šä¹‰**ï¼š
- **äº‹åŠ¡è¾¹ç•Œï¼ˆTransaction Boundaryï¼‰**ï¼šæ ‡è®°äº‹åŠ¡å¼€å§‹å’Œç»“æŸçš„ä½ç½®
- **ä½œç”¨**ï¼šç¡®ä¿ä¸€ç»„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
- **æ ¸å¿ƒåŸåˆ™**ï¼šäº‹åŠ¡èŒƒå›´è¦å°½å¯èƒ½å°ï¼Œä½†è¦åŒ…å«å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘

### 1.2 ä¸ºä»€ä¹ˆè¦è®¾è®¡äº‹åŠ¡è¾¹ç•Œ


**å¸¸è§é—®é¢˜åœºæ™¯**ï¼š

```
âŒ é”™è¯¯ç¤ºä¾‹ï¼šäº‹åŠ¡èŒƒå›´å¤ªå¤§
@Transactional  // æ•´ä¸ªæ–¹æ³•éƒ½æ˜¯äº‹åŠ¡
public void processOrder(Order order) {
    // 1. ä¿å­˜è®¢å•ï¼ˆéœ€è¦äº‹åŠ¡ï¼‰
    orderRepository.save(order);
    
    // 2. å‘é€é‚®ä»¶ï¼ˆä¸éœ€è¦äº‹åŠ¡ï¼Œä½†å ç”¨äº†äº‹åŠ¡æ—¶é—´ï¼‰
    emailService.sendEmail(order.getCustomer());
    
    // 3. è°ƒç”¨ç¬¬ä¸‰æ–¹APIï¼ˆä¸éœ€è¦äº‹åŠ¡ï¼Œå¯èƒ½å¾ˆæ…¢ï¼‰
    paymentService.process(order);
}

é—®é¢˜ï¼šå‘é‚®ä»¶å’Œè°ƒç”¨APIéƒ½åœ¨äº‹åŠ¡ä¸­ï¼Œå¯¼è‡´äº‹åŠ¡æ—¶é—´è¿‡é•¿
```

**æ­£ç¡®çš„è®¾è®¡æ€è·¯**ï¼š

```
âœ… æ­£ç¡®ç¤ºä¾‹ï¼šç¼©å°äº‹åŠ¡èŒƒå›´
public void processOrder(Order order) {
    // åªæœ‰æ•°æ®åº“æ“ä½œåœ¨äº‹åŠ¡ä¸­
    Order savedOrder = saveOrderInTransaction(order);
    
    // é‚®ä»¶å’ŒAPIè°ƒç”¨åœ¨äº‹åŠ¡å¤–
    emailService.sendEmail(savedOrder.getCustomer());
    paymentService.process(savedOrder);
}

@Transactional
private Order saveOrderInTransaction(Order order) {
    return orderRepository.save(order);
}
```

### 1.3 äº‹åŠ¡è¾¹ç•Œçš„ä¸‰å±‚æ¶æ„


**æ ‡å‡†åˆ†å±‚ç»“æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ§åˆ¶å±‚ (Controller)    â”‚ â† ä¸åº”è¯¥æœ‰äº‹åŠ¡
â”‚   - æ¥æ”¶è¯·æ±‚            â”‚
â”‚   - è¿”å›å“åº”            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æœåŠ¡å±‚ (Service)       â”‚ â† äº‹åŠ¡çš„æœ€ä½³ä½ç½® â­
â”‚   - ä¸šåŠ¡é€»è¾‘            â”‚
â”‚   - äº‹åŠ¡ç®¡ç†            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æŒä¹…å±‚ (Repository)    â”‚ â† ä¸åº”è¯¥æ§åˆ¶äº‹åŠ¡
â”‚   - æ•°æ®è®¿é—®            â”‚
â”‚   - SQLæ‰§è¡Œ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å±‚æ¬¡èŒè´£è¯´æ˜**ï¼š

| å±‚æ¬¡ | **èŒè´£** | **æ˜¯å¦éœ€è¦äº‹åŠ¡** | **åŸå› ** |
|------|---------|----------------|---------|
| **Controller** | `å¤„ç†HTTPè¯·æ±‚` | âŒ ä¸éœ€è¦ | `äº‹åŠ¡ä¸åº”è·¨è¶Šç½‘ç»œè¾¹ç•Œ` |
| **Service** | `ç¼–æ’ä¸šåŠ¡é€»è¾‘` | âœ… éœ€è¦ | `æœ€æ¸…æ¥šä¸šåŠ¡å®Œæ•´æ€§è¦æ±‚` |
| **Repository** | `æ‰§è¡Œæ•°æ®æ“ä½œ` | âŒ ä¸éœ€è¦ | `åº”ç”±Serviceç»Ÿä¸€ç®¡ç†` |

---

## 2. ğŸ”§ æœåŠ¡å±‚äº‹åŠ¡ç®¡ç†


### 2.1 ä¸ºä»€ä¹ˆäº‹åŠ¡è¦åœ¨Serviceå±‚


**æ ¸å¿ƒåŸå› **ï¼šä¸šåŠ¡é€»è¾‘çš„å®Œæ•´æ€§ç”±Serviceå±‚å†³å®š

```java
// âŒ é”™è¯¯ï¼šåœ¨Repositoryå±‚åŠ äº‹åŠ¡
@Repository
public class OrderRepository {
    @Transactional  // ä¸åº”è¯¥åœ¨è¿™é‡Œï¼
    public void save(Order order) {
        // åªæ˜¯å•ä¸ªä¿å­˜æ“ä½œ
    }
}

// âœ… æ­£ç¡®ï¼šåœ¨Serviceå±‚ç®¡ç†äº‹åŠ¡
@Service
public class OrderService {
    @Transactional  // åº”è¯¥åœ¨è¿™é‡Œï¼
    public void createOrder(Order order) {
        // å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
        orderRepository.save(order);
        orderItemRepository.saveAll(order.getItems());
        inventoryService.updateStock(order.getItems());
        // è¿™äº›æ“ä½œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
    }
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡**ï¼š

> ğŸ’¡ **å…³é”®ç†è§£**ï¼š
> - RepositoryåªçŸ¥é“"æ€ä¹ˆä¿å­˜æ•°æ®"
> - Serviceæ‰çŸ¥é“"ä¿å­˜å“ªäº›æ•°æ®æ‰ç®—å®Œæˆä¸šåŠ¡"
> - äº‹åŠ¡è¾¹ç•Œåº”è¯¥ç”±"æœ€äº†è§£ä¸šåŠ¡çš„é‚£ä¸€å±‚"æ¥æ§åˆ¶

### 2.2 Serviceå±‚äº‹åŠ¡çš„æ ‡å‡†å†™æ³•


**åŸºç¡€é…ç½®**ï¼š

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    // æ ‡å‡†çš„äº‹åŠ¡æ–¹æ³•
    @Transactional
    public User createUser(UserDTO dto) {
        User user = new User();
        user.setUsername(dto.getUsername());
        user.setEmail(dto.getEmail());
        return userRepository.save(user);
    }
}
```

**å…³é”®é…ç½®å‚æ•°**ï¼š

```java
@Transactional(
    // ä¼ æ’­è¡Œä¸ºï¼šå¦‚ä½•å¤„ç†å·²å­˜åœ¨çš„äº‹åŠ¡
    propagation = Propagation.REQUIRED,  // é»˜è®¤å€¼
    
    // éš”ç¦»çº§åˆ«ï¼šå¹¶å‘æ§åˆ¶
    isolation = Isolation.DEFAULT,  // ä½¿ç”¨æ•°æ®åº“é»˜è®¤éš”ç¦»çº§åˆ«
    
    // è¶…æ—¶æ—¶é—´ï¼šé˜²æ­¢é•¿äº‹åŠ¡
    timeout = 30,  // 30ç§’è¶…æ—¶
    
    // åªè¯»ä¼˜åŒ–ï¼šæŸ¥è¯¢æ“ä½œ
    readOnly = false,  // é»˜è®¤å¯è¯»å†™
    
    // å›æ»šè§„åˆ™ï¼šå“ªäº›å¼‚å¸¸å›æ»š
    rollbackFor = Exception.class  // æ‰€æœ‰å¼‚å¸¸éƒ½å›æ»š
)
public void complexOperation() {
    // ä¸šåŠ¡é€»è¾‘
}
```

### 2.3 äº‹åŠ¡ä¼ æ’­è¡Œä¸ºè¯¦è§£


**ä»€ä¹ˆæ˜¯ä¼ æ’­è¡Œä¸º**ï¼šå½“ä¸€ä¸ªæœ‰äº‹åŠ¡çš„æ–¹æ³•è°ƒç”¨å¦ä¸€ä¸ªæœ‰äº‹åŠ¡çš„æ–¹æ³•æ—¶ï¼Œæ€ä¹ˆåŠï¼Ÿ

```java
@Service
public class OrderService {
    
    @Autowired
    private InventoryService inventoryService;
    
    @Transactional  // å¤–å±‚äº‹åŠ¡
    public void createOrder(Order order) {
        orderRepository.save(order);
        
        // è°ƒç”¨å¦ä¸€ä¸ªæœ‰äº‹åŠ¡çš„æ–¹æ³•
        inventoryService.updateStock(order);  // å†…å±‚äº‹åŠ¡
    }
}

@Service
public class InventoryService {
    
    @Transactional  // è¿™ä¸ªäº‹åŠ¡æ€ä¹ˆå¤„ç†ï¼Ÿ
    public void updateStock(Order order) {
        // æ›´æ–°åº“å­˜
    }
}
```

**å¸¸ç”¨ä¼ æ’­è¡Œä¸ºå¯¹æ¯”**ï¼š

| ä¼ æ’­è¡Œä¸º | **å«ä¹‰** | **ä½¿ç”¨åœºæ™¯** |
|---------|---------|-------------|
| **REQUIRED** | `å¦‚æœæœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±æ–°å»º` | â­ æœ€å¸¸ç”¨ï¼Œé»˜è®¤è¡Œä¸º |
| **REQUIRES_NEW** | `æ€»æ˜¯æ–°å»ºäº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡` | `ç‹¬ç«‹çš„æ“ä½œï¼Œå¦‚æ—¥å¿—è®°å½•` |
| **NESTED** | `åµŒå¥—äº‹åŠ¡ï¼Œå¤–å±‚å›æ»šä¼šå½±å“å†…å±‚` | `éƒ¨åˆ†å›æ»šåœºæ™¯` |
| **SUPPORTS** | `æœ‰äº‹åŠ¡å°±ç”¨ï¼Œæ²¡æœ‰å°±ä¸ç”¨` | `æŸ¥è¯¢æ“ä½œ` |
| **NOT_SUPPORTED** | `æ€»æ˜¯éäº‹åŠ¡æ‰§è¡Œï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡` | `ä¸éœ€è¦äº‹åŠ¡çš„æ“ä½œ` |

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š

```java
@Service
public class LogService {
    
    // æ—¥å¿—è®°å½•åº”è¯¥ç‹¬ç«‹äºä¸šåŠ¡äº‹åŠ¡
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void saveLog(String message) {
        Log log = new Log();
        log.setMessage(message);
        logRepository.save(log);
    }
}

// ä½¿ç”¨åœºæ™¯
@Service
public class OrderService {
    
    @Autowired
    private LogService logService;
    
    @Transactional
    public void createOrder(Order order) {
        try {
            orderRepository.save(order);
        } catch (Exception e) {
            // å³ä½¿è®¢å•åˆ›å»ºå¤±è´¥ï¼Œæ—¥å¿—ä¹Ÿè¦ä¿å­˜
            logService.saveLog("è®¢å•åˆ›å»ºå¤±è´¥: " + e.getMessage());
            throw e;
        }
    }
}
```

---

## 3. âš ï¸ æ‡’åŠ è½½å¼‚å¸¸é—®é¢˜


### 3.1 ä»€ä¹ˆæ˜¯æ‡’åŠ è½½å¼‚å¸¸


**é€šä¿—è§£é‡Š**ï¼šå°±åƒä½ ä¹°äº†ä¸€æœ¬ä¹¦ï¼Œä½†ä¹¦çš„æŸäº›ç« èŠ‚éœ€è¦è”ç½‘æ‰èƒ½çœ‹åˆ°

```
ç”¨æˆ·å®ä½“                æ‡’åŠ è½½å¼‚å¸¸ç¤ºä¾‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        
â”‚ User        â”‚         @Transactionalç»“æŸå
â”‚ - id        â”‚         â†“
â”‚ - name      â”‚         try {
â”‚ - orders âš¡  â”‚ â† æ‡’åŠ è½½   user.getOrders(); // ğŸ’¥å¼‚å¸¸ï¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         }
                        
é”™è¯¯ä¿¡æ¯ï¼šLazyInitializationException
åŸå› ï¼šäº‹åŠ¡å·²å…³é—­ï¼Œæ— æ³•åŠ è½½æ•°æ®
```

**ä¸“ä¸šå®šä¹‰**ï¼š
- **LazyInitializationException**ï¼šåœ¨æ²¡æœ‰æ´»åŠ¨Sessionçš„æƒ…å†µä¸‹è®¿é—®æ‡’åŠ è½½å±æ€§
- **æ ¹æœ¬åŸå› **ï¼šJPAé»˜è®¤ä½¿ç”¨æ‡’åŠ è½½ï¼Œå…³è”æ•°æ®åªåœ¨çœŸæ­£è®¿é—®æ—¶æ‰åŠ è½½
- **è§¦å‘æ—¶æœº**ï¼šäº‹åŠ¡ç»“æŸåï¼Œåœ¨Controlleræˆ–Viewå±‚è®¿é—®æ‡’åŠ è½½å±æ€§

### 3.2 æ‡’åŠ è½½å¼‚å¸¸çš„å…¸å‹åœºæ™¯


**åœºæ™¯1ï¼šControllerå±‚è®¿é—®å…³è”æ•°æ®**

```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šä¼šæŠ›å‡ºå¼‚å¸¸
@RestController
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @GetMapping("/users/{id}")
    public UserDTO getUser(@PathVariable Long id) {
        User user = userService.findById(id);  // Serviceäº‹åŠ¡ç»“æŸ
        
        // è¿™é‡Œè®¿é—®ordersä¼šæŠ¥é”™ï¼
        List<Order> orders = user.getOrders();  // ğŸ’¥ LazyInitializationException
        
        return new UserDTO(user, orders);
    }
}
```

**ä¸ºä»€ä¹ˆä¼šæŠ¥é”™**ï¼š

```
æ—¶é—´çº¿ï¼š
1. Controllerè°ƒç”¨Service.findById()
2. Serviceä¸­@Transactionalå¼€å¯äº‹åŠ¡
3. æŸ¥è¯¢Userï¼Œä½†ordersæ˜¯æ‡’åŠ è½½ï¼ˆæœªåŠ è½½ï¼‰
4. Serviceæ–¹æ³•ç»“æŸï¼Œ@Transactionalå…³é—­äº‹åŠ¡ â† å…³é”®ç‚¹ï¼
5. è¿”å›Controller
6. Controllerè®¿é—®user.getOrders()
7. æ­¤æ—¶äº‹åŠ¡å·²å…³é—­ï¼Œæ— æ³•åŠ è½½æ•°æ® â†’ å¼‚å¸¸ï¼
```

**åœºæ™¯2ï¼šå¼‚æ­¥æ–¹æ³•è®¿é—®æ‡’åŠ è½½å±æ€§**

```java
@Service
public class OrderService {
    
    @Transactional
    public void processOrder(Long orderId) {
        Order order = orderRepository.findById(orderId);
        
        // å¼‚æ­¥å‘é€é‚®ä»¶
        emailService.sendOrderEmail(order);  // ä¼ é€’äº†æ‡’åŠ è½½å¯¹è±¡
    }
}

@Service
public class EmailService {
    
    @Async  // å¼‚æ­¥æ‰§è¡Œï¼Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹
    public void sendOrderEmail(Order order) {
        // ğŸ’¥ å¼‚å¸¸ï¼å¼‚æ­¥çº¿ç¨‹æ²¡æœ‰äº‹åŠ¡ä¸Šä¸‹æ–‡
        String customerEmail = order.getCustomer().getEmail();
    }
}
```

### 3.3 è§£å†³æ‡’åŠ è½½å¼‚å¸¸çš„æ–¹æ³•


**æ–¹æ³•1ï¼šæå‰åŠ è½½ï¼ˆJOIN FETCHï¼‰â­ æ¨è**

```java
// âœ… æ­£ç¡®ï¼šåœ¨Serviceå±‚æå‰åŠ è½½
@Service
public class UserService {
    
    @Transactional(readOnly = true)
    public User findByIdWithOrders(Long id) {
        // ä½¿ç”¨JOIN FETCHä¸€æ¬¡æ€§åŠ è½½
        return entityManager.createQuery(
            "SELECT u FROM User u " +
            "LEFT JOIN FETCH u.orders " +
            "WHERE u.id = :id", User.class)
            .setParameter("id", id)
            .getSingleResult();
    }
}

// Controllerç°åœ¨å¯ä»¥å®‰å…¨è®¿é—®
@GetMapping("/users/{id}")
public UserDTO getUser(@PathVariable Long id) {
    User user = userService.findByIdWithOrders(id);
    return new UserDTO(user, user.getOrders());  // âœ… ä¸ä¼šæŠ¥é”™
}
```

**æ–¹æ³•2ï¼šä½¿ç”¨DTOè½¬æ¢ï¼ˆæœ€ä½³å®è·µï¼‰â­â­ å¼ºçƒˆæ¨è**

```java
// DTOï¼šæ•°æ®ä¼ è¾“å¯¹è±¡ï¼ŒåªåŒ…å«éœ€è¦çš„æ•°æ®
public class UserDTO {
    private Long id;
    private String name;
    private List<OrderDTO> orders;
    
    // åœ¨Serviceäº‹åŠ¡å†…å®Œæˆè½¬æ¢
    public static UserDTO from(User user) {
        UserDTO dto = new UserDTO();
        dto.setId(user.getId());
        dto.setName(user.getName());
        // åœ¨äº‹åŠ¡å†…è®¿é—®ordersï¼Œç„¶åè½¬æ¢
        dto.setOrders(user.getOrders().stream()
            .map(OrderDTO::from)
            .collect(Collectors.toList()));
        return dto;
    }
}

// Serviceè¿”å›DTO
@Service
public class UserService {
    
    @Transactional(readOnly = true)
    public UserDTO getUserWithOrders(Long id) {
        User user = userRepository.findById(id);
        return UserDTO.from(user);  // åœ¨äº‹åŠ¡å†…è½¬æ¢
    }
}

// Controlleræ¥æ”¶DTO
@GetMapping("/users/{id}")
public UserDTO getUser(@PathVariable Long id) {
    return userService.getUserWithOrders(id);  // âœ… å®Œå…¨å®‰å…¨
}
```

**æ–¹æ³•3ï¼šEntityGraphï¼ˆSpring Data JPAï¼‰**

```java
public interface UserRepository extends JpaRepository<User, Long> {
    
    // ä½¿ç”¨@EntityGraphæŒ‡å®šè¦åŠ è½½çš„å±æ€§
    @EntityGraph(attributePaths = {"orders", "orders.items"})
    Optional<User> findById(Long id);
}
```

**ä¸‰ç§æ–¹æ³•å¯¹æ¯”**ï¼š

| æ–¹æ³• | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **æ¨èåº¦** |
|------|---------|---------|-----------|
| **JOIN FETCH** | `æŸ¥è¯¢æ•ˆç‡é«˜ï¼Œä¸€æ¬¡åŠ è½½` | `éœ€è¦å†™JPQL` | â­â­â­ |
| **DTOè½¬æ¢** | `è§£è€¦å¥½ï¼Œæ€§èƒ½å¯æ§` | `éœ€è¦å†™è½¬æ¢ä»£ç ` | â­â­â­â­â­ |
| **EntityGraph** | `é…ç½®ç®€å•` | `çµæ´»æ€§ç¨å·®` | â­â­â­â­ |

---

## 4. ğŸ“ äº‹åŠ¡ç²’åº¦æ§åˆ¶ç­–ç•¥


### 4.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ç²’åº¦


**é€šä¿—ç†è§£**ï¼šäº‹åŠ¡ç²’åº¦å°±æ˜¯"ä¸€ä¸ªäº‹åŠ¡åŒ…å«å¤šå°‘æ“ä½œ"

```
ç²—ç²’åº¦äº‹åŠ¡ï¼ˆèŒƒå›´å¤§ï¼‰ï¼š
@Transactional
public void processEverything() {
    step1();  â”
    step2();  â”‚
    step3();  â”œâ”€ å…¨åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­
    step4();  â”‚
    step5();  â”˜
}

ç»†ç²’åº¦äº‹åŠ¡ï¼ˆèŒƒå›´å°ï¼‰ï¼š
public void processEverything() {
    doStep1InTransaction();  â† äº‹åŠ¡1
    doStep2InTransaction();  â† äº‹åŠ¡2
    doStep3InTransaction();  â† äº‹åŠ¡3
}
```

### 4.2 äº‹åŠ¡ç²’åº¦çš„è®¾è®¡åŸåˆ™


**æ ¸å¿ƒåŸåˆ™**ï¼š

> ğŸ“Œ **é»„é‡‘æ³•åˆ™**ï¼š
> - äº‹åŠ¡è¦å°½å¯èƒ½å°ï¼Œä½†è¦ä¿è¯ä¸šåŠ¡å®Œæ•´æ€§
> - åªæœ‰å¿…é¡»ä¸€èµ·æˆåŠŸæˆ–å¤±è´¥çš„æ“ä½œæ‰æ”¾åœ¨åŒä¸€äº‹åŠ¡ä¸­
> - è€—æ—¶æ“ä½œå°½é‡ç§»åˆ°äº‹åŠ¡å¤–

**åˆ¤æ–­æ ‡å‡†**ï¼š

```
æ˜¯å¦éœ€è¦åœ¨åŒä¸€äº‹åŠ¡ï¼Ÿé—®è‡ªå·±3ä¸ªé—®é¢˜ï¼š

1ï¸âƒ£ è¿™äº›æ“ä½œå¿…é¡»åŒæ—¶æˆåŠŸå—ï¼Ÿ
   - æ˜¯ â†’ åŒä¸€äº‹åŠ¡
   - å¦ â†’ åˆ†å¼€äº‹åŠ¡

2ï¸âƒ£ å…¶ä¸­ä¸€ä¸ªå¤±è´¥ï¼Œå…¶ä»–çš„è¦å›æ»šå—ï¼Ÿ
   - æ˜¯ â†’ åŒä¸€äº‹åŠ¡
   - å¦ â†’ åˆ†å¼€äº‹åŠ¡

3ï¸âƒ£ æ“ä½œä¹‹é—´æœ‰ä¾èµ–å…³ç³»å—ï¼Ÿ
   - æ˜¯ â†’ åŒä¸€äº‹åŠ¡
   - å¦ â†’ å¯ä»¥åˆ†å¼€
```

### 4.3 äº‹åŠ¡ç²’åº¦çš„å®è·µæ¡ˆä¾‹


**æ¡ˆä¾‹1ï¼šè®¢å•åˆ›å»ºæµç¨‹**

```java
// âŒ ç²—ç²’åº¦ï¼šæ‰€æœ‰æ“ä½œåœ¨ä¸€ä¸ªäº‹åŠ¡
@Transactional
public void createOrder(OrderDTO dto) {
    // 1. ä¿å­˜è®¢å•ï¼ˆå¿…é¡»äº‹åŠ¡ï¼‰
    Order order = orderRepository.save(dto.toEntity());
    
    // 2. å‘é€é‚®ä»¶ï¼ˆä¸éœ€è¦äº‹åŠ¡ï¼Œä½†è€—æ—¶é•¿ï¼‰
    emailService.sendOrderConfirmation(order);
    
    // 3. è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜ï¼ˆä¸éœ€è¦äº‹åŠ¡ï¼Œå¯èƒ½å¤±è´¥ï¼‰
    paymentService.createPayment(order);
    
    // 4. æ›´æ–°åº“å­˜ï¼ˆå¿…é¡»äº‹åŠ¡ï¼‰
    inventoryService.reduceStock(order.getItems());
}
// é—®é¢˜ï¼šé‚®ä»¶å’Œæ”¯ä»˜å ç”¨äº†äº‹åŠ¡æ—¶é—´ï¼Œå¢åŠ äº†é”çš„æŒæœ‰æ—¶é—´
```

```java
// âœ… ç»†ç²’åº¦ï¼šåˆç†æ‹†åˆ†
public void createOrder(OrderDTO dto) {
    // ç¬¬ä¸€ä¸ªäº‹åŠ¡ï¼šä¿å­˜è®¢å•å’Œæ›´æ–°åº“å­˜ï¼ˆåŸå­æ“ä½œï¼‰
    Order order = createOrderInTransaction(dto);
    
    // äº‹åŠ¡å¤–ï¼šå‘é€é‚®ä»¶
    emailService.sendOrderConfirmation(order);
    
    // äº‹åŠ¡å¤–ï¼šè°ƒç”¨æ”¯ä»˜ï¼ˆå¦‚æœå¤±è´¥å¯ä»¥åç»­å¤„ç†ï¼‰
    try {
        paymentService.createPayment(order);
    } catch (Exception e) {
        // è®°å½•å¤±è´¥ï¼Œåç»­è¡¥å¿
        logService.logPaymentFailure(order, e);
    }
}

@Transactional
private Order createOrderInTransaction(OrderDTO dto) {
    Order order = orderRepository.save(dto.toEntity());
    inventoryService.reduceStock(order.getItems());
    return order;
}
```

**æ¡ˆä¾‹2ï¼šæ‰¹é‡æ•°æ®å¤„ç†**

```java
// âŒ å¤§äº‹åŠ¡ï¼šå¤„ç†10000æ¡æ•°æ®
@Transactional
public void importUsers(List<UserDTO> users) {
    for (UserDTO dto : users) {  // 10000æ¬¡å¾ªç¯
        userRepository.save(dto.toEntity());
    }
}
// é—®é¢˜ï¼šäº‹åŠ¡æ—¶é—´å¤ªé•¿ï¼Œé”ä½è¡¨å¤ªä¹…ï¼Œå®¹æ˜“è¶…æ—¶
```

```java
// âœ… åˆ†æ‰¹å¤„ç†ï¼šå°äº‹åŠ¡
public void importUsers(List<UserDTO> users) {
    int batchSize = 100;
    
    for (int i = 0; i < users.size(); i += batchSize) {
        int end = Math.min(i + batchSize, users.size());
        List<UserDTO> batch = users.subList(i, end);
        
        // æ¯100æ¡ä¸€ä¸ªäº‹åŠ¡
        importBatch(batch);
    }
}

@Transactional
private void importBatch(List<UserDTO> batch) {
    batch.forEach(dto -> userRepository.save(dto.toEntity()));
}
```

### 4.4 äº‹åŠ¡è¶…æ—¶è®¾ç½®


**ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶è®¾ç½®**ï¼š

```
æ²¡æœ‰è¶…æ—¶çš„é—®é¢˜ï¼š
æ•°æ®åº“æ­»é” â†’ äº‹åŠ¡æ°¸è¿œç­‰å¾… â†’ å ç”¨è¿æ¥æ±  â†’ ç³»ç»Ÿç˜«ç—ª

æœ‰è¶…æ—¶çš„å¥½å¤„ï¼š
è¶…è¿‡30ç§’ â†’ è‡ªåŠ¨å›æ»š â†’ é‡Šæ”¾èµ„æº â†’ ç³»ç»Ÿæ­£å¸¸
```

**è¶…æ—¶é…ç½®**ï¼š

```java
@Service
public class OrderService {
    
    // è®¾ç½®30ç§’è¶…æ—¶
    @Transactional(timeout = 30)
    public void processOrder(Order order) {
        // å¦‚æœè¶…è¿‡30ç§’æœªå®Œæˆï¼Œè‡ªåŠ¨å›æ»š
    }
    
    // æŸ¥è¯¢æ“ä½œå¯ä»¥è®¾ç½®æ›´çŸ­çš„è¶…æ—¶
    @Transactional(readOnly = true, timeout = 5)
    public List<Order> searchOrders(String keyword) {
        // 5ç§’è¶…æ—¶ï¼Œé˜²æ­¢æ…¢æŸ¥è¯¢
    }
}
```

**è¶…æ—¶æ—¶é—´å»ºè®®**ï¼š

| æ“ä½œç±»å‹ | **æ¨èè¶…æ—¶** | **è¯´æ˜** |
|---------|------------|---------|
| **ç®€å•æŸ¥è¯¢** | `3-5ç§’` | `å¿«é€Ÿè¿”å›ï¼Œé¿å…æ…¢æŸ¥è¯¢` |
| **å•æ¡æ›´æ–°** | `10-15ç§’` | `æ­£å¸¸ä¸šåŠ¡æ“ä½œ` |
| **æ‰¹é‡å¤„ç†** | `30-60ç§’` | `å…è®¸è¾ƒé•¿æ—¶é—´` |
| **å¤æ‚ä¸šåŠ¡** | `60-120ç§’` | `ç‰¹æ®Šåœºæ™¯ï¼Œéœ€è¦ç›‘æ§` |

---

## 5. ğŸ”„ å¼‚å¸¸å›æ»šç­–ç•¥


### 5.1 é»˜è®¤å›æ»šè¡Œä¸º


**Springäº‹åŠ¡çš„é»˜è®¤è§„åˆ™**ï¼š

```
RuntimeExceptionï¼ˆè¿è¡Œæ—¶å¼‚å¸¸ï¼‰
  â”œâ”€ NullPointerException      â†’ å›æ»š âœ…
  â”œâ”€ IllegalArgumentException   â†’ å›æ»š âœ…
  â””â”€ ...å…¶ä»–è¿è¡Œæ—¶å¼‚å¸¸         â†’ å›æ»š âœ…

Exceptionï¼ˆæ£€æŸ¥å¼‚å¸¸ï¼‰
  â”œâ”€ IOException                â†’ ä¸å›æ»š âŒ
  â”œâ”€ SQLException               â†’ ä¸å›æ»š âŒ
  â””â”€ ...å…¶ä»–æ£€æŸ¥å¼‚å¸¸            â†’ ä¸å›æ»š âŒ
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡**ï¼š

> ğŸ’¡ **è®¾è®¡ç†ç”±**ï¼š
> - RuntimeExceptioné€šå¸¸æ˜¯ç¼–ç¨‹é”™è¯¯ï¼Œåº”è¯¥å›æ»š
> - æ£€æŸ¥å¼‚å¸¸å¯èƒ½æ˜¯ä¸šåŠ¡å¼‚å¸¸ï¼Œä¸ä¸€å®šéœ€è¦å›æ»š
> - ä½†å®é™…ä½¿ç”¨ä¸­ï¼Œå»ºè®®æ˜ç¡®æŒ‡å®šå›æ»šè§„åˆ™

### 5.2 è‡ªå®šä¹‰å›æ»šè§„åˆ™


**æŒ‡å®šå›æ»šå¼‚å¸¸**ï¼š

```java
@Service
public class PaymentService {
    
    // æ‰€æœ‰å¼‚å¸¸éƒ½å›æ»šï¼ˆæ¨èï¼‰
    @Transactional(rollbackFor = Exception.class)
    public void processPayment(Payment payment) {
        try {
            paymentRepository.save(payment);
            thirdPartyApi.charge(payment);
        } catch (IOException e) {
            // IOExceptionä¹Ÿä¼šè§¦å‘å›æ»š
            throw new PaymentException("æ”¯ä»˜å¤±è´¥", e);
        }
    }
    
    // æŒ‡å®šä¸å›æ»šçš„å¼‚å¸¸
    @Transactional(noRollbackFor = BusinessException.class)
    public void createOrder(Order order) {
        orderRepository.save(order);
        
        try {
            inventoryService.reduceStock(order);
        } catch (BusinessException e) {
            // BusinessExceptionä¸ä¼šå›æ»šäº‹åŠ¡
            // åªè®°å½•æ—¥å¿—ï¼Œç»§ç»­æ‰§è¡Œ
            logger.warn("åº“å­˜ä¸è¶³: {}", e.getMessage());
        }
    }
}
```

### 5.3 å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ


**å®è·µ1ï¼šä¸šåŠ¡å¼‚å¸¸ä¸ç³»ç»Ÿå¼‚å¸¸åˆ†ç¦»**

```java
// ä¸šåŠ¡å¼‚å¸¸ï¼šä¸å›æ»š
public class BusinessException extends RuntimeException {
    public BusinessException(String message) {
        super(message);
    }
}

// ç³»ç»Ÿå¼‚å¸¸ï¼šå›æ»š
public class SystemException extends RuntimeException {
    public SystemException(String message, Throwable cause) {
        super(message, cause);
    }
}

// ä½¿ç”¨
@Service
public class OrderService {
    
    @Transactional(
        rollbackFor = SystemException.class,
        noRollbackFor = BusinessException.class
    )
    public void createOrder(Order order) {
        // ä¸šåŠ¡éªŒè¯å¤±è´¥ï¼Œä¸å›æ»š
        if (order.getAmount() < 0) {
            throw new BusinessException("é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°");
        }
        
        try {
            orderRepository.save(order);
        } catch (DataAccessException e) {
            // æ•°æ®åº“å¼‚å¸¸ï¼Œå›æ»š
            throw new SystemException("è®¢å•ä¿å­˜å¤±è´¥", e);
        }
    }
}
```

**å®è·µ2ï¼šå¼‚å¸¸è½¬æ¢ä¸æ—¥å¿—è®°å½•**

```java
@Service
public class UserService {
    
    @Transactional(rollbackFor = Exception.class)
    public void updateUser(Long id, UserDTO dto) {
        try {
            User user = userRepository.findById(id)
                .orElseThrow(() -> new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨"));
            
            user.setName(dto.getName());
            user.setEmail(dto.getEmail());
            
            userRepository.save(user);
            
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼Œè®°å½•å¹¶æŠ›å‡º
            logger.warn("ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage());
            throw e;
            
        } catch (Exception e) {
            // ç³»ç»Ÿå¼‚å¸¸ï¼Œè®°å½•è¯¦ç»†ä¿¡æ¯å¹¶è½¬æ¢
            logger.error("æ›´æ–°ç”¨æˆ·å¤±è´¥, userId={}", id, e);
            throw new SystemException("ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•", e);
        }
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ äº‹åŠ¡è¾¹ç•Œï¼šæ ‡è®°äº‹åŠ¡å¼€å§‹å’Œç»“æŸçš„ä½ç½®ï¼Œåº”è¯¥åœ¨Serviceå±‚
ğŸ”¸ æ‡’åŠ è½½å¼‚å¸¸ï¼šäº‹åŠ¡å…³é—­åè®¿é—®æ‡’åŠ è½½å±æ€§å¯¼è‡´çš„å¼‚å¸¸
ğŸ”¸ äº‹åŠ¡ç²’åº¦ï¼šä¸€ä¸ªäº‹åŠ¡åŒ…å«çš„æ“ä½œèŒƒå›´ï¼Œè¦å°è€Œå®Œæ•´
ğŸ”¸ å›æ»šç­–ç•¥ï¼šå“ªäº›å¼‚å¸¸è§¦å‘å›æ»šï¼Œå“ªäº›ä¸è§¦å‘
```

### 6.2 å…³é”®å®è·µåŸåˆ™


**åŸåˆ™1ï¼šäº‹åŠ¡åœ¨Serviceå±‚**
```
âœ… Serviceå±‚ï¼šè´Ÿè´£äº‹åŠ¡ç®¡ç†å’Œä¸šåŠ¡ç¼–æ’
âŒ Controllerå±‚ï¼šä¸åº”è¯¥æœ‰äº‹åŠ¡
âŒ Repositoryå±‚ï¼šä¸åº”è¯¥æ§åˆ¶äº‹åŠ¡
```

**åŸåˆ™2ï¼šé¿å…æ‡’åŠ è½½å¼‚å¸¸**
```
â­ æœ€ä½³æ–¹æ¡ˆï¼šä½¿ç”¨DTOï¼Œåœ¨äº‹åŠ¡å†…è½¬æ¢æ•°æ®
â­ å¤‡é€‰æ–¹æ¡ˆï¼šJOIN FETCHæå‰åŠ è½½
â­ ç®€ä¾¿æ–¹æ¡ˆï¼šä½¿ç”¨@EntityGraph
```

**åŸåˆ™3ï¼šæ§åˆ¶äº‹åŠ¡ç²’åº¦**
```
- äº‹åŠ¡è¦å°½å¯èƒ½å°
- åªåŒ…å«å¿…é¡»åŸå­æ‰§è¡Œçš„æ“ä½œ
- è€—æ—¶æ“ä½œç§»åˆ°äº‹åŠ¡å¤–ï¼ˆIOã€ç½‘ç»œè°ƒç”¨ç­‰ï¼‰
- å¤§æ‰¹é‡å¤„ç†è¦åˆ†æ‰¹æ‰§è¡Œ
```

**åŸåˆ™4ï¼šæ˜ç¡®å›æ»šè§„åˆ™**
```
@Transactional(
    rollbackFor = Exception.class,  // æ‰€æœ‰å¼‚å¸¸å›æ»š
    timeout = 30                     // 30ç§’è¶…æ—¶
)
```

### 6.3 å¸¸è§é—®é¢˜é€ŸæŸ¥


| é—®é¢˜ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|------|---------|-------------|
| ğŸ’¥ **LazyInitializationException** | `äº‹åŠ¡å¤–è®¿é—®æ‡’åŠ è½½å±æ€§` | `ä½¿ç”¨DTOæˆ–JOIN FETCH` |
| â±ï¸ **äº‹åŠ¡è¶…æ—¶** | `äº‹åŠ¡æ—¶é—´è¿‡é•¿` | `ç¼©å°äº‹åŠ¡ç²’åº¦ï¼Œè®¾ç½®åˆç†è¶…æ—¶` |
| ğŸ”’ **æ•°æ®åº“æ­»é”** | `äº‹åŠ¡æŒæœ‰é”æ—¶é—´é•¿` | `å‡å°‘äº‹åŠ¡èŒƒå›´ï¼Œä¼˜åŒ–æŸ¥è¯¢` |
| ğŸ”„ **å¼‚å¸¸ä¸å›æ»š** | `æ£€æŸ¥å¼‚å¸¸é»˜è®¤ä¸å›æ»š` | `é…ç½®rollbackFor=Exception.class` |

### 6.4 å®æˆ˜æ£€æŸ¥æ¸…å•


**å¼€å‘æ—¶è‡ªæŸ¥**ï¼š
- [ ] äº‹åŠ¡æ˜¯å¦åœ¨Serviceå±‚ï¼Ÿ
- [ ] æ˜¯å¦æœ‰æ‡’åŠ è½½å¼‚å¸¸é£é™©ï¼Ÿ
- [ ] äº‹åŠ¡èŒƒå›´æ˜¯å¦åˆç†ï¼ˆä¸åŒ…å«IOæ“ä½œï¼‰ï¼Ÿ
- [ ] æ˜¯å¦è®¾ç½®äº†è¶…æ—¶æ—¶é—´ï¼Ÿ
- [ ] å›æ»šè§„åˆ™æ˜¯å¦æ˜ç¡®ï¼Ÿ

**ä»£ç å®¡æŸ¥è¦ç‚¹**ï¼š
- [ ] æŸ¥çœ‹@Transactionalçš„ä½ç½®
- [ ] æ£€æŸ¥æ˜¯å¦æœ‰Controllerå±‚äº‹åŠ¡
- [ ] ç¡®è®¤æ‡’åŠ è½½æ•°æ®çš„å¤„ç†æ–¹å¼
- [ ] è¯„ä¼°äº‹åŠ¡æ‰§è¡Œæ—¶é—´
- [ ] éªŒè¯å¼‚å¸¸å¤„ç†é€»è¾‘

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
äº‹åŠ¡è¾¹ç•ŒServiceå±‚ï¼Œæ‡’åŠ è½½é—®é¢˜DTOè½¬
ç²’åº¦æ§åˆ¶è¦ç²¾å‡†ï¼Œè€—æ—¶æ“ä½œå¾€å¤–æ¬
å›æ»šè§„åˆ™è¦æ˜ç¡®ï¼Œè¶…æ—¶è®¾ç½®é˜²é£é™©
å¼‚å¸¸å¤„ç†åˆ†ä¸šåŠ¡ï¼Œæ—¥å¿—è®°å½•åŠ©æ’æŸ¥
```