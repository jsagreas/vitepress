---
title: 28ã€è„æ£€æŸ¥dirty_checkingåŸç†
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯è„æ£€æŸ¥](#1-ä»€ä¹ˆæ˜¯è„æ£€æŸ¥)
2. [å˜æ›´è·Ÿè¸ªåŸç†](#2-å˜æ›´è·Ÿè¸ªåŸç†)
3. [å¿«ç…§æ¯”è¾ƒæœºåˆ¶](#3-å¿«ç…§æ¯”è¾ƒæœºåˆ¶)
4. [flushæ—¶æœºæ§åˆ¶](#4-flushæ—¶æœºæ§åˆ¶)
5. [æ‰¹é‡æ›´æ–°æ³¨æ„äº‹é¡¹](#5-æ‰¹é‡æ›´æ–°æ³¨æ„äº‹é¡¹)
6. [æ€§èƒ½å½±å“åˆ†æ](#6-æ€§èƒ½å½±å“åˆ†æ)
7. [æ‰‹åŠ¨flushä½¿ç”¨](#7-æ‰‹åŠ¨flushä½¿ç”¨)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ä»€ä¹ˆæ˜¯è„æ£€æŸ¥


### 1.1 è„æ£€æŸ¥çš„é€šä¿—ç†è§£


**ç”Ÿæ´»ä¸­çš„ä¾‹å­**ï¼š
```
æƒ³è±¡ä½ åœ¨å›¾ä¹¦é¦†å€Ÿä¹¦ï¼š
ğŸ“– å€Ÿä¹¦æ—¶ï¼šå›¾ä¹¦ç®¡ç†å‘˜ä¼šè®°å½•ä¹¦çš„çŠ¶æ€ï¼ˆæœ‰æ— ç ´æŸã€é¡µæ•°ç­‰ï¼‰
ğŸ“ è¿˜ä¹¦æ—¶ï¼šç®¡ç†å‘˜ä¼šå¯¹æ¯”ç°åœ¨çš„ä¹¦å’Œå€Ÿä¹¦æ—¶çš„è®°å½•
ğŸ”„ å‘ç°å˜åŒ–ï¼šå¦‚æœä¹¦æœ‰ç ´æŸï¼Œå°±ä¼šè®°å½•å¹¶è¦æ±‚èµ”å¿

JPAçš„è„æ£€æŸ¥å°±æ˜¯è¿™ä¸ªé“ç†ï¼
```

**ğŸ”¸ ä»€ä¹ˆæ˜¯"è„"ï¼ˆDirtyï¼‰ï¼Ÿ**
```
åœ¨æ•°æ®åº“æœ¯è¯­ä¸­ï¼š
â€¢ "è„" = è¢«ä¿®æ”¹è¿‡ä½†è¿˜æ²¡ä¿å­˜åˆ°æ•°æ®åº“
â€¢ "å¹²å‡€" = å’Œæ•°æ®åº“ä¸­çš„æ•°æ®å®Œå…¨ä¸€è‡´

å°±åƒï¼š
è„è¡£æœ = ç©¿è¿‡éœ€è¦æ´—çš„è¡£æœ
å¹²å‡€è¡£æœ = åˆšæ´—å¥½å’Œæ–°ä¹°çš„ä¸€æ ·
```

### 1.2 è„æ£€æŸ¥çš„æ ¸å¿ƒä½œç”¨


**ğŸ¯ æ ¸å¿ƒåŠŸèƒ½**
> JPAçš„è„æ£€æŸ¥æœºåˆ¶ï¼šè‡ªåŠ¨æ£€æµ‹å®ä½“å¯¹è±¡çš„å˜åŒ–ï¼Œå¹¶åœ¨é€‚å½“æ—¶æœºè‡ªåŠ¨ç”ŸæˆUPDATEè¯­å¥åŒæ­¥åˆ°æ•°æ®åº“

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦è„æ£€æŸ¥ï¼Ÿ**

ä¼ ç»ŸJDBCæ–¹å¼çš„éº»çƒ¦ï¼š
```
é—®é¢˜åœºæ™¯ï¼šä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
1. æŸ¥è¯¢ç”¨æˆ·æ•°æ®
2. ä¿®æ”¹å¯¹è±¡å±æ€§
3. æ‰‹åŠ¨å†™UPDATEè¯­å¥ âŒ å®¹æ˜“å¿˜è®°
4. æ‰‹åŠ¨æ‰§è¡Œæ›´æ–°
5. è¿˜è¦åˆ¤æ–­å“ªäº›å­—æ®µæ”¹äº†

å¤ªç¹çäº†ï¼
```

æœ‰äº†è„æ£€æŸ¥çš„ä¾¿åˆ©ï¼š
```
JPAè‡ªåŠ¨åŒ–æ–¹å¼ï¼š
1. æŸ¥è¯¢ç”¨æˆ·æ•°æ®
2. ä¿®æ”¹å¯¹è±¡å±æ€§
3. JPAè‡ªåŠ¨æ£€æµ‹å˜åŒ– âœ… 
4. JPAè‡ªåŠ¨ç”ŸæˆUPDATE âœ…
5. äº‹åŠ¡æäº¤æ—¶è‡ªåŠ¨ä¿å­˜ âœ…

çœå¿ƒçœåŠ›ï¼
```

**ğŸ“Š å¯¹æ¯”ç¤ºæ„**
```
ä¼ ç»Ÿæ–¹å¼ï¼š
å¼€å‘è€… â†’ ä¿®æ”¹å¯¹è±¡ â†’ æ‰‹å†™SQL â†’ æ‰§è¡Œæ›´æ–° â†’ æäº¤äº‹åŠ¡
        â†‘ å®¹æ˜“å‡ºé”™      â†‘ å®¹æ˜“é—æ¼

JPAæ–¹å¼ï¼š
å¼€å‘è€… â†’ ä¿®æ”¹å¯¹è±¡ â†’ [JPAè‡ªåŠ¨å®Œæˆ] â†’ æäº¤äº‹åŠ¡
                    â†‘ æ£€æµ‹+ç”Ÿæˆ+æ‰§è¡Œ
```

---

## 2. ğŸ”¬ å˜æ›´è·Ÿè¸ªåŸç†


### 2.1 JPAå¦‚ä½•çŸ¥é“å¯¹è±¡å˜äº†ï¼Ÿ


**ğŸ”¸ è·Ÿè¸ªæœºåˆ¶æ ¸å¿ƒæ€è·¯**

```
å°±åƒç›‘æ§æ‘„åƒå¤´çš„å·¥ä½œæ–¹å¼ï¼š
1ï¸âƒ£ ä¿å­˜åˆå§‹ç”»é¢ï¼ˆå¿«ç…§ï¼‰
2ï¸âƒ£ æŒç»­ç›‘æ§å½“å‰ç”»é¢
3ï¸âƒ£ å¯¹æ¯”å‘ç°å˜åŒ–
4ï¸âƒ£ è§¦å‘è­¦æŠ¥å¹¶è®°å½•

JPAçš„è·Ÿè¸ªè¿‡ç¨‹ï¼š
åŠ è½½å®ä½“ â†’ ä¿å­˜å¿«ç…§ â†’ ä¿®æ”¹å¯¹è±¡ â†’ å¯¹æ¯”å¿«ç…§ â†’ å‘ç°å˜åŒ– â†’ ç”ŸæˆUPDATE
```

### 2.2 æŒä¹…åŒ–ä¸Šä¸‹æ–‡çš„è§’è‰²


**ğŸ›ï¸ ä»€ä¹ˆæ˜¯æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼Ÿ**

> æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼ˆPersistence Contextï¼‰= JPAçš„"å¯¹è±¡ç®¡ç†ä»“åº“"
> å°±åƒä½ çš„"è´­ç‰©è½¦"ï¼Œä¸´æ—¶å­˜æ”¾ä½ æ­£åœ¨å¤„ç†çš„å•†å“ï¼ˆå®ä½“å¯¹è±¡ï¼‰

**å·¥ä½œæµç¨‹å›¾ç¤º**ï¼š
```
æ•°æ®åº“                æŒä¹…åŒ–ä¸Šä¸‹æ–‡              Javaåº”ç”¨ç¨‹åº
  â”‚                       â”‚                        â”‚
  â”‚â†â”€â”€â”€ æŸ¥è¯¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
  â”‚                       â”‚                        â”‚
  â”‚                  [åˆ›å»ºå¿«ç…§]                    â”‚
  â”‚                       â”‚                        â”‚
  â”‚                   å­˜å‚¨å¯¹è±¡ â”€â”€â†’ è¿”å›å¯¹è±¡ç»™åº”ç”¨  â”‚
  â”‚                   å­˜å‚¨å¿«ç…§                     â”‚
  â”‚                       â†“                        â†“
  â”‚                   æŒç»­ç›‘æ§          åº”ç”¨ä¿®æ”¹å¯¹è±¡å±æ€§
  â”‚                       â”‚                        â”‚
  â”‚                   [å¯¹æ¯”æ£€æµ‹]                   â”‚
  â”‚                       â”‚                        â”‚
  â”‚                   å‘ç°å˜åŒ–                     â”‚
  â”‚                       â”‚                        â”‚
  â”‚â†â”€â”€â”€ ç”ŸæˆUPDATE â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
  â”‚                       â”‚                        â”‚
```

**ğŸ”¸ å¿«ç…§å­˜å‚¨ç¤ºä¾‹**

å‡è®¾æŸ¥è¯¢ç”¨æˆ·ï¼š
```java
User user = entityManager.find(User.class, 1L);
// æ­¤æ—¶JPAåšäº†ä»€ä¹ˆï¼Ÿ

å†…å­˜ä¸­çš„æ•°æ®ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æŒä¹…åŒ–ä¸Šä¸‹æ–‡               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“¦ å®ä½“ç¼“å­˜åŒº                â”‚
â”‚   userå¯¹è±¡ (id=1)            â”‚
â”‚   â”œâ”€ name: "å¼ ä¸‰"            â”‚
â”‚   â”œâ”€ age: 25                 â”‚
â”‚   â””â”€ email: "zhang@..."      â”‚
â”‚                              â”‚
â”‚ ğŸ“¸ å¿«ç…§åŒº                    â”‚
â”‚   userå¿«ç…§ (id=1)            â”‚
â”‚   â”œâ”€ name: "å¼ ä¸‰"   â† åˆå§‹å€¼ â”‚
â”‚   â”œâ”€ age: 25       â† åˆå§‹å€¼ â”‚
â”‚   â””â”€ email: "zhang@..." â†åˆå§‹â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 å˜æ›´æ£€æµ‹çš„è§¦å‘æ—¶æœº


**â° ä»€ä¹ˆæ—¶å€™æ£€æŸ¥å˜åŒ–ï¼Ÿ**

JPAä¸æ˜¯æ—¶æ—¶åˆ»åˆ»éƒ½åœ¨æ£€æŸ¥ï¼Œè€Œæ˜¯åœ¨å…³é”®æ—¶åˆ»ï¼š

| æ—¶æœº | è¯´æ˜ | ç”Ÿæ´»ç±»æ¯” |
|------|------|----------|
| **äº‹åŠ¡æäº¤å‰** | `transaction.commit()` | ç¦»å¼€å•†åœºå‰ç»“è´¦ |
| **æ‰§è¡ŒæŸ¥è¯¢å‰** | `SELECT`è¯­å¥æ‰§è¡Œå‰ | çœ‹æ–°è´§å‰å…ˆæ¸…ç‚¹æ—§è´§ |
| **æ‰‹åŠ¨flush** | `entityManager.flush()` | ä¸»åŠ¨è¦æ±‚æ”¶é“¶å‘˜ç»“è´¦ |

**ğŸ’¡ ä¸ºä»€ä¹ˆæŸ¥è¯¢å‰è¦æ£€æŸ¥ï¼Ÿ**
```
åœºæ™¯è¯´æ˜ï¼š
user.setName("æå››");                    // ä¿®æ”¹è¿˜æ²¡ä¿å­˜
List<User> users = query.getResultList(); // æ‰§è¡ŒæŸ¥è¯¢

å¦‚æœä¸å…ˆflushï¼š
â€¢ æ•°æ®åº“ä¸­nameè¿˜æ˜¯"å¼ ä¸‰"
â€¢ æŸ¥è¯¢å¯èƒ½æŸ¥åˆ°æ—§æ•°æ®
â€¢ å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼

æ‰€ä»¥JPAä¼šï¼š
æŸ¥è¯¢å‰è‡ªåŠ¨flush â†’ ç¡®ä¿æ•°æ®åº“æœ€æ–° â†’ å†æ‰§è¡ŒæŸ¥è¯¢ âœ…
```

---

## 3. ğŸ“¸ å¿«ç…§æ¯”è¾ƒæœºåˆ¶


### 3.1 å¿«ç…§æ˜¯ä»€ä¹ˆï¼Ÿ


**ğŸ”¸ å¿«ç…§çš„æœ¬è´¨**

> å¿«ç…§ = å®ä½“å¯¹è±¡åŠ è½½æ—¶çš„"åŸå§‹æ•°æ®å‰¯æœ¬"
> å°±åƒæ‹ç…§ï¼Œè®°å½•æŸä¸ªæ—¶åˆ»çš„çŠ¶æ€

**å†…å­˜ç»“æ„ç¤ºæ„**ï¼š
```
å®ä½“å¯¹è±¡ï¼ˆä¼šå˜åŒ–ï¼‰          å¿«ç…§ï¼ˆä¸å˜ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Userå¯¹è±¡     â”‚          â”‚ Userå¿«ç…§     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ name: "æå››" â”‚ å¯¹æ¯” â†â†’  â”‚ name: "å¼ ä¸‰" â”‚ â† å‘ç°ä¸åŒï¼
â”‚ age: 26      â”‚ å¯¹æ¯” â†â†’  â”‚ age: 25      â”‚ â† å‘ç°ä¸åŒï¼
â”‚ email: ...   â”‚ å¯¹æ¯” â†â†’  â”‚ email: ...   â”‚ â† ç›¸åŒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    æ£€æµ‹ç»“æœï¼šnameå’Œageè¢«ä¿®æ”¹
         â†“
    ç”ŸæˆSQLï¼šUPDATE user SET name='æå››', age=26 WHERE id=1
```

### 3.2 æ¯”è¾ƒè¿‡ç¨‹è¯¦è§£


**ğŸ”¬ é€å­—æ®µå¯¹æ¯”æµç¨‹**

```
è„æ£€æŸ¥ç®—æ³•ä¼ªä»£ç ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ for æ¯ä¸ªè¢«ç®¡ç†çš„å®ä½“ {         â”‚
â”‚   originalSnapshot = è·å–å¿«ç…§  â”‚
â”‚   currentState = å½“å‰å¯¹è±¡çŠ¶æ€  â”‚
â”‚                                â”‚
â”‚   for æ¯ä¸ªå±æ€§å­—æ®µ {           â”‚
â”‚     if (currentState[å­—æ®µ] !=  â”‚
â”‚         originalSnapshot[å­—æ®µ]){â”‚
â”‚       æ ‡è®°ä¸ºè„                 â”‚
â”‚       è®°å½•å˜åŒ–å­—æ®µ             â”‚
â”‚     }                          â”‚
â”‚   }                            â”‚
â”‚                                â”‚
â”‚   if (æœ‰è„æ•°æ®) {              â”‚
â”‚     ç”ŸæˆUPDATEè¯­å¥             â”‚
â”‚     åŠ å…¥æ‰§è¡Œé˜Ÿåˆ—               â”‚
â”‚   }                            â”‚
â”‚ }                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ å¯¹æ¯”è§„åˆ™**

åŸºæœ¬ç±»å‹å¯¹æ¯”ï¼š
```java
// ç›´æ¥å€¼æ¯”è¾ƒ
Integer oldAge = 25;
Integer newAge = 26;
isDirty = !oldAge.equals(newAge); // trueï¼Œéœ€è¦æ›´æ–°
```

å¯¹è±¡å¼•ç”¨å¯¹æ¯”ï¼š
```java
// æ¯”è¾ƒå¼•ç”¨åœ°å€
Address oldAddress = snapshot.getAddress();
Address newAddress = entity.getAddress();
isDirty = (oldAddress != newAddress); // å¼•ç”¨å˜äº†å°±è®¤ä¸ºè„äº†
```

é›†åˆå¯¹æ¯”ï¼š
```java
// æ¯”è¾ƒé›†åˆå†…å®¹
List<Order> oldOrders = snapshot.getOrders();
List<Order> newOrders = entity.getOrders();
isDirty = !oldOrders.equals(newOrders); // å†…å®¹å˜åŒ–
```

### 3.3 å¿«ç…§æ›´æ–°æ—¶æœº


**ğŸ”„ å¿«ç…§ä½•æ—¶åˆ·æ–°ï¼Ÿ**

å¿«ç…§ç”Ÿå‘½å‘¨æœŸï¼š
```
åŠ è½½å®ä½“
   â†“
åˆ›å»ºå¿«ç…§ â†â”€â”€â”€â”€â”€â”€â”€â”€â”
   â†“              â”‚
æ£€æµ‹å˜åŒ–          â”‚
   â†“              â”‚
ç”ŸæˆUPDATE        â”‚
   â†“              â”‚
æ‰§è¡ŒSQL           â”‚
   â†“              â”‚
æ›´æ–°å¿«ç…§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â† åŒæ­¥æ–°çŠ¶æ€
   â†“
ç»§ç»­ç›‘æ§...
```

**é‡è¦ç‰¹æ€§**ï¼š
> âœ… flushåå¿«ç…§ä¼šæ›´æ–°ä¸ºå½“å‰å¯¹è±¡çŠ¶æ€
> âœ… ä¸‹æ¬¡æ£€æŸ¥å°±ä¼šä»¥æ–°å¿«ç…§ä¸ºåŸºå‡†
> âŒ ä¸flushï¼Œå¿«ç…§æ°¸è¿œæ˜¯åŠ è½½æ—¶çš„æ—§æ•°æ®

---

## 4. â±ï¸ flushæ—¶æœºæ§åˆ¶


### 4.1 ä»€ä¹ˆæ˜¯flushï¼Ÿ


**ğŸ”¸ flushçš„é€šä¿—è§£é‡Š**

> flush = "å†²æ°´"ï¼ŒæŠŠå†…å­˜ä¸­çš„å˜åŒ–"å†²"åˆ°æ•°æ®åº“
> å°±åƒé©¬æ¡¶å†²æ°´ï¼ŒæŠŠè„ä¸œè¥¿å†²èµ°

**flushåšäº†ä»€ä¹ˆï¼Ÿ**
```
flushæ“ä½œæµç¨‹ï¼š
1. éå†æŒä¹…åŒ–ä¸Šä¸‹æ–‡ä¸­çš„æ‰€æœ‰å®ä½“
2. å¯¹æ¯”å¿«ç…§ï¼Œæ£€æµ‹å˜åŒ–
3. ç”ŸæˆINSERT/UPDATE/DELETEè¯­å¥
4. æ‰§è¡ŒSQLï¼ŒåŒæ­¥åˆ°æ•°æ®åº“
5. æ›´æ–°å¿«ç…§ä¸ºæœ€æ–°çŠ¶æ€
```

### 4.2 è‡ªåŠ¨flushæ—¶æœº


**â° JPAé»˜è®¤çš„flushæ—¶æœº**

æ—¶æœº1ï¼šäº‹åŠ¡æäº¤æ—¶
```java
@Transactional
public void updateUser() {
    User user = userRepository.findById(1L);
    user.setName("æ–°åå­—");
    // æ–¹æ³•ç»“æŸï¼Œäº‹åŠ¡æäº¤
    // â†‘ è¿™é‡Œè‡ªåŠ¨flushï¼ŒUPDATEè¢«æ‰§è¡Œ
}
```

æ—¶æœº2ï¼šæ‰§è¡ŒæŸ¥è¯¢å‰
```java
user.setAge(30);                              // ä¿®æ”¹ï¼Œè¿˜åœ¨å†…å­˜
List<User> users = entityManager
    .createQuery("SELECT u FROM User u", User.class)
    .getResultList();                         // æŸ¥è¯¢å‰è‡ªåŠ¨flush âœ…
```

æ—¶æœº3ï¼šæ‰‹åŠ¨è°ƒç”¨flush
```java
user.setEmail("new@email.com");
entityManager.flush();  // ç«‹å³flush âœ…
```

**ğŸ”¸ FlushModeé…ç½®**

| æ¨¡å¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `AUTO` | è‡ªåŠ¨flushï¼ˆé»˜è®¤ï¼‰ | å¤§éƒ¨åˆ†åœºæ™¯ |
| `COMMIT` | ä»…äº‹åŠ¡æäº¤æ—¶flush | æ‰¹é‡æ“ä½œä¼˜åŒ– |
| `ALWAYS` | æ¯æ¬¡æŸ¥è¯¢éƒ½flush | æ•°æ®å¼ºä¸€è‡´æ€§è¦æ±‚ |
| `MANUAL` | ä»…æ‰‹åŠ¨flush | å®Œå…¨æ‰‹åŠ¨æ§åˆ¶ |

è®¾ç½®æ–¹å¼ï¼š
```java
// å…¨å±€è®¾ç½®
entityManager.setFlushMode(FlushModeType.COMMIT);

// å•ä¸ªæŸ¥è¯¢è®¾ç½®
query.setFlushMode(FlushModeType.AUTO);
```

### 4.3 flushä¸commitçš„åŒºåˆ«


**ğŸ”„ å®¹æ˜“æ··æ·†çš„ä¸¤ä¸ªæ¦‚å¿µ**

```
flushï¼ˆåˆ·æ–°ï¼‰ï¼š
å†…å­˜å˜åŒ– â†’ ç”ŸæˆSQL â†’ å‘é€åˆ°æ•°æ®åº“ â†’ æ•°æ®åº“æ‰§è¡Œ
              â†‘
          ä½†è¿˜æ²¡æäº¤ï¼äº‹åŠ¡è¿˜å¯ä»¥å›æ»š

commitï¼ˆæäº¤ï¼‰ï¼š
ç¡®è®¤äº‹åŠ¡ â†’ æ•°æ®åº“æ°¸ä¹…ä¿å­˜ â†’ ä¸å¯å›æ»š
              â†‘
        flushæ˜¯commitçš„å‰ç½®æ­¥éª¤
```

**å®ä¾‹è¯´æ˜**ï¼š
```java
// åœºæ™¯ï¼šflushåå›æ»š
@Transactional
public void testFlushVsCommit() {
    User user = entityManager.find(User.class, 1L);
    user.setName("ä¸´æ—¶åå­—");
    
    entityManager.flush();  // â† è¿™é‡ŒSQLå·²æ‰§è¡Œ
    // æ•°æ®åº“æš‚æ—¶æœ‰"ä¸´æ—¶åå­—"
    
    throw new RuntimeException("å›æ»š");  // â† äº‹åŠ¡å›æ»š
    // æœ€ç»ˆæ•°æ®åº“æ¢å¤åŸå€¼ âœ…
}
```

**å…³ç³»å›¾ç¤º**ï¼š
```
æ“ä½œé¡ºåºï¼š
ä¿®æ”¹å¯¹è±¡ â†’ flush â†’ commit
   â†“        â†“       â†“
  å†…å­˜     æ•°æ®åº“   æ°¸ä¹…åŒ–
  å˜åŒ–     ä¸´æ—¶     ä¸å¯æ’¤é”€
```

---

## 5. âš ï¸ æ‰¹é‡æ›´æ–°æ³¨æ„äº‹é¡¹


### 5.1 æ‰¹é‡æ›´æ–°ç»•è¿‡è„æ£€æŸ¥


**ğŸ”¸ é—®é¢˜åœºæ™¯**

ä½¿ç”¨JPQL/Native SQLæ‰¹é‡æ›´æ–°ï¼š
```java
// ç›´æ¥æ‰§è¡ŒSQLï¼Œç»•è¿‡æŒä¹…åŒ–ä¸Šä¸‹æ–‡
int count = entityManager.createQuery(
    "UPDATE User u SET u.status = 'ACTIVE' WHERE u.age > 18"
).executeUpdate();

// âŒ é—®é¢˜ï¼šå¦‚æœå†…å­˜ä¸­æœ‰è¿™äº›Userå¯¹è±¡
User user = entityManager.find(User.class, 1L); // age=20
user.getStatus(); // è¿˜æ˜¯æ—§å€¼ï¼å¿«ç…§ä¹Ÿæ²¡æ›´æ–°
```

**åŸå› åˆ†æ**ï¼š
```
æ‰¹é‡æ›´æ–°æ‰§è¡Œè·¯å¾„ï¼š
JPQL â†’ ç›´æ¥è½¬SQL â†’ æ•°æ®åº“æ‰§è¡Œ
  â†“
è·³è¿‡äº†æŒä¹…åŒ–ä¸Šä¸‹æ–‡
  â†“
å†…å­˜å¿«ç…§å®Œå…¨ä¸çŸ¥é“æ•°æ®åº“å˜äº†ï¼
```

### 5.2 æ‰¹é‡æ›´æ–°åçš„å¤„ç†


**âœ… è§£å†³æ–¹æ¡ˆå¯¹æ¯”**

æ–¹æ¡ˆ1ï¼šæ¸…ç©ºæŒä¹…åŒ–ä¸Šä¸‹æ–‡
```java
// æ‰¹é‡æ›´æ–°
entityManager.createQuery(
    "UPDATE User u SET u.status = 'ACTIVE'"
).executeUpdate();

// æ¸…ç©ºä¸Šä¸‹æ–‡ï¼Œå¿«ç…§å…¨éƒ¨å¤±æ•ˆ
entityManager.clear();  

// é‡æ–°åŠ è½½
User user = entityManager.find(User.class, 1L); // ä»æ•°æ®åº“æŸ¥æœ€æ–°
```

æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨refresh
```java
// æ‰¹é‡æ›´æ–°
entityManager.createQuery("UPDATE ...").executeUpdate();

// åˆ·æ–°ç‰¹å®šå¯¹è±¡
User user = entityManager.find(User.class, 1L);
entityManager.refresh(user);  // å¼ºåˆ¶ä»æ•°æ®åº“é‡æ–°åŠ è½½
```

æ–¹æ¡ˆ3ï¼šä½¿ç”¨@Modifyingæ³¨è§£ï¼ˆSpring Data JPAï¼‰
```java
@Modifying
@Query("UPDATE User u SET u.status = 'ACTIVE' WHERE u.age > 18")
int updateStatus();
// Springä¼šè‡ªåŠ¨æ¸…ç©ºä¸Šä¸‹æ–‡
```

**ğŸ“Š æ–¹æ¡ˆé€‰æ‹©**

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| `clear()` | ç®€å•ï¼Œä¸€æ¬¡æ€§æ¸…ç† | æ‰€æœ‰å®ä½“å¤±æ•ˆ | æ‰¹é‡æ“ä½œåä¸å†ä½¿ç”¨ç¼“å­˜ |
| `refresh()` | ç²¾å‡†æ§åˆ¶ | éœ€è¦çŸ¥é“å“ªäº›å¯¹è±¡å—å½±å“ | å°‘é‡å¯¹è±¡éœ€è¦åˆ·æ–° |
| `@Modifying` | è‡ªåŠ¨åŒ– | ä»…Spring Data JPA | Springé¡¹ç›®æ¨è |

### 5.3 æ‰¹é‡æ“ä½œæ€§èƒ½ä¼˜åŒ–


**ğŸš€ ä¼˜åŒ–æŠ€å·§**

æŠ€å·§1ï¼šç¦ç”¨è‡ªåŠ¨flush
```java
@Transactional
public void batchUpdate(List<User> users) {
    // æš‚æ—¶å…³é—­è‡ªåŠ¨flush
    entityManager.setFlushMode(FlushModeType.COMMIT);
    
    for (User user : users) {
        user.setStatus("ACTIVE");
        // è¿™é‡Œä¸ä¼šæ¯æ¬¡éƒ½flush
    }
    
    // æœ€åç»Ÿä¸€flush
    entityManager.flush();
}
```

æŠ€å·§2ï¼šåˆ†æ‰¹flush
```java
int batchSize = 50;
for (int i = 0; i < users.size(); i++) {
    entityManager.persist(users.get(i));
    
    if (i % batchSize == 0) {
        entityManager.flush();   // æ¯50æ¡flushä¸€æ¬¡
        entityManager.clear();   // æ¸…ç©ºç¼“å­˜é‡Šæ”¾å†…å­˜
    }
}
```

æŠ€å·§3ï¼šç›´æ¥ç”¨JPQLæ‰¹é‡
```java
// ä¸è¦è¿™æ ·ï¼šé€ä¸ªæ›´æ–°ï¼Œæ¯ä¸ªéƒ½è„æ£€æŸ¥
for (User user : users) {
    user.setStatus("ACTIVE");
}

// æ¨èè¿™æ ·ï¼šä¸€æ¡SQLæå®š
entityManager.createQuery(
    "UPDATE User u SET u.status = 'ACTIVE' WHERE u.id IN :ids"
).setParameter("ids", userIds)
 .executeUpdate();
```

---

## 6. ğŸ“Š æ€§èƒ½å½±å“åˆ†æ


### 6.1 è„æ£€æŸ¥çš„æ€§èƒ½å¼€é”€


**ğŸ”¸ æ€§èƒ½æ¶ˆè€—ç‚¹**

æ¶ˆè€—1ï¼šå¿«ç…§å­˜å‚¨
```
æ¯ä¸ªå®ä½“å¯¹è±¡ = åŸå¯¹è±¡ + å¿«ç…§å‰¯æœ¬
å®ä½“è¶Šå¤šï¼Œå†…å­˜å ç”¨è¶Šå¤§

ç¤ºä¾‹ï¼š
10000ä¸ªUserå¯¹è±¡
æ¯ä¸ªUser 1KB
å¿«ç…§å ç”¨ï¼š10000 Ã— 1KB = 10MB âŒ
```

æ¶ˆè€—2ï¼šå¯¹æ¯”è®¡ç®—
```
flushæ—¶çš„è®¡ç®—é‡ï¼š
å¯¹è±¡æ•°é‡ Ã— å­—æ®µæ•°é‡ = å¯¹æ¯”æ¬¡æ•°

ç¤ºä¾‹ï¼š
1000ä¸ªå®ä½“ Ã— 20ä¸ªå­—æ®µ = 20000æ¬¡å¯¹æ¯”
å¦‚æœå­—æ®µç±»å‹å¤æ‚ï¼ˆé›†åˆã€å¯¹è±¡ï¼‰ï¼Œå¼€é”€æ›´å¤§
```

æ¶ˆè€—3ï¼šä¸å¿…è¦çš„UPDATE
```
é—®é¢˜ï¼šå³ä½¿å€¼æ²¡å˜ï¼Œå¯¹æ¯”ä¹Ÿæœ‰å¼€é”€
user.setName(user.getName()); // è®¾ç½®ç›¸åŒå€¼
// JPAè¿˜æ˜¯ä¼šå¯¹æ¯”ï¼Œè™½ç„¶æœ€ç»ˆä¸UPDATE
```

### 6.2 æ€§èƒ½é—®é¢˜åœºæ™¯


**âŒ æ€§èƒ½é™·é˜±ç¤ºä¾‹**

é™·é˜±1ï¼šå¤§é‡å®ä½“åŒæ—¶åŠ è½½
```java
// æŸ¥è¯¢10000æ¡æ•°æ®
List<User> users = entityManager
    .createQuery("SELECT u FROM User u", User.class)
    .getResultList();

// å†…å­˜ä¸­ï¼š
// 10000ä¸ªUserå¯¹è±¡ + 10000ä¸ªå¿«ç…§ = å·¨å¤§å¼€é”€ âŒ
```

é™·é˜±2ï¼šé¢‘ç¹è§¦å‘flush
```java
// FlushMode.AUTOé»˜è®¤è®¾ç½®
for (int i = 0; i < 1000; i++) {
    user.setName("name" + i);
    
    // æ¯æ¬¡æŸ¥è¯¢éƒ½flushï¼Œ1000æ¬¡è„æ£€æŸ¥ï¼
    entityManager.createQuery("SELECT ...").getResultList();
}
```

é™·é˜±3ï¼šå¤æ‚å¯¹è±¡å›¾
```java
@Entity
class Order {
    @OneToMany
    List<OrderItem> items; // 100ä¸ªitem
    
    @ManyToOne
    Customer customer;
}

// å¯¹æ¯”Orderæ—¶ï¼Œè¿˜è¦å¯¹æ¯”itemsé›†åˆï¼ˆ100æ¬¡ï¼‰å’Œcustomer
```

### 6.3 æ€§èƒ½ä¼˜åŒ–å®è·µ


**âœ… ä¼˜åŒ–ç­–ç•¥**

ç­–ç•¥1ï¼šåªåŠ è½½éœ€è¦çš„æ•°æ®
```java
// âŒ ä¸å¥½ï¼šæŸ¥è¯¢å…¨éƒ¨å­—æ®µ
List<User> users = entityManager
    .createQuery("SELECT u FROM User u", User.class)
    .getResultList();

// âœ… å¥½ï¼šåªæŸ¥éœ€è¦çš„å­—æ®µï¼ˆDTOæŠ•å½±ï¼‰
List<UserDTO> users = entityManager.createQuery(
    "SELECT new UserDTO(u.id, u.name) FROM User u", 
    UserDTO.class
).getResultList();
// DTOä¸å—è„æ£€æŸ¥ç®¡ç†ï¼Œæ— å¿«ç…§å¼€é”€ âœ…
```

ç­–ç•¥2ï¼šæ‰¹é‡æ“ä½œç”¨JPQL
```java
// âŒ ä¸å¥½ï¼šé€ä¸ªæ›´æ–°
for (User user : users) {
    user.setStatus("ACTIVE"); // æ¯ä¸ªéƒ½è„æ£€æŸ¥
}

// âœ… å¥½ï¼šæ‰¹é‡UPDATE
entityManager.createQuery(
    "UPDATE User u SET u.status = 'ACTIVE' WHERE u.id IN :ids"
).setParameter("ids", ids).executeUpdate();
```

ç­–ç•¥3ï¼šåˆç†ä½¿ç”¨FlushMode
```java
// æ‰¹é‡æ“ä½œæ—¶
entityManager.setFlushMode(FlushModeType.COMMIT);
// å‡å°‘ä¸­é—´flushæ¬¡æ•°

// è¯»å¤šå†™å°‘æ—¶
query.setFlushMode(FlushModeType.MANUAL);
// å®Œå…¨æ‰‹åŠ¨æ§åˆ¶
```

ç­–ç•¥4ï¼šåˆ†ç¦»å®ä½“ï¼ˆdetachï¼‰
```java
User user = entityManager.find(User.class, 1L);

// ä¸å†éœ€è¦è·Ÿè¸ªè¿™ä¸ªå¯¹è±¡
entityManager.detach(user);
// ä»æ­¤ä¸å†å‚ä¸è„æ£€æŸ¥ï¼Œé‡Šæ”¾å¿«ç…§å†…å­˜ âœ…

// æˆ–è€…
entityManager.clear(); // æ¸…ç©ºæ‰€æœ‰
```

**ğŸ“ˆ æ€§èƒ½å¯¹æ¯”**

| æ“ä½œ | è„æ£€æŸ¥æ–¹å¼ | æ‰¹é‡SQLæ–¹å¼ | æ€§èƒ½å·®è· |
|------|-----------|------------|---------|
| æ›´æ–°1000æ¡ | 1000æ¬¡å¯¹æ¯”+1000æ¡UPDATE | 1æ¡UPDATE | 100å€+ |
| å†…å­˜å ç”¨ | å¯¹è±¡+å¿«ç…§ | ä»…æ‰§è¡Œ | 50%èŠ‚çœ |
| äº‹åŠ¡æ—¶é—´ | é•¿ï¼ˆå¯¹æ¯”+æ‰§è¡Œï¼‰ | çŸ­ï¼ˆä»…æ‰§è¡Œï¼‰ | 10å€+ |

---

## 7. ğŸ› ï¸ æ‰‹åŠ¨flushä½¿ç”¨


### 7.1 ä½•æ—¶éœ€è¦æ‰‹åŠ¨flush


**ğŸ”¸ æ‰‹åŠ¨flushçš„å…¸å‹åœºæ™¯**

åœºæ™¯1ï¼šç«‹å³éœ€è¦æ•°æ®åº“ç”Ÿæˆçš„ID
```java
@Entity
class Order {
    @Id @GeneratedValue
    private Long id;  // æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆ
}

// éœ€æ±‚ï¼šç«‹å³è·å–ID
Order order = new Order();
entityManager.persist(order);

System.out.println(order.getId());  // null âŒ

entityManager.flush();  // æ‰‹åŠ¨flushï¼Œæ‰§è¡ŒINSERT

System.out.println(order.getId());  // 123 âœ… æœ‰å€¼äº†
```

åœºæ™¯2ï¼šæ‰§è¡ŒåŸç”ŸSQLå‰ä¿è¯æ•°æ®ä¸€è‡´
```java
user.setBalance(1000);  // ä¿®æ”¹ä½™é¢

// æƒ³ç”¨åŸç”ŸSQLæŸ¥è¯¢
List<User> richUsers = entityManager.createNativeQuery(
    "SELECT * FROM user WHERE balance > 500", User.class
).getResultList();

// âŒ å¦‚æœä¸flushï¼ŒSQLæŸ¥åˆ°çš„æ˜¯æ—§ä½™é¢
// âœ… åº”è¯¥å…ˆflush
entityManager.flush();
List<User> richUsers = ...  // ç°åœ¨èƒ½æŸ¥åˆ°æœ€æ–°æ•°æ®
```

åœºæ™¯3ï¼šåˆ†æ­¥æ“ä½œéœ€è¦ä¸­é—´ç»“æœ
```java
// æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
Order order = new Order();
entityManager.persist(order);
entityManager.flush();  // ç«‹å³ç”ŸæˆID

// æ­¥éª¤2ï¼šç”¨è®¢å•IDåˆ›å»ºæ”¯ä»˜è®°å½•
Payment payment = new Payment();
payment.setOrderId(order.getId());  // éœ€è¦ç”¨åˆ°åˆšç”Ÿæˆçš„ID
entityManager.persist(payment);
```

### 7.2 æ‰‹åŠ¨flushæœ€ä½³å®è·µ


**âœ… ä½¿ç”¨æŒ‡å—**

æŒ‡å—1ï¼šflushå‰è¦åœ¨äº‹åŠ¡å†…
```java
// âŒ é”™è¯¯ï¼šäº‹åŠ¡å¤–flush
User user = entityManager.find(User.class, 1L);
user.setName("æ–°åå­—");
entityManager.flush();  // æŠ¥é”™ï¼šNo transaction!

// âœ… æ­£ç¡®ï¼šäº‹åŠ¡å†…flush
@Transactional
public void update() {
    User user = entityManager.find(User.class, 1L);
    user.setName("æ–°åå­—");
    entityManager.flush();  // OK
}
```

æŒ‡å—2ï¼šflushä¸ç­‰äºcommit
```java
@Transactional
public void test() {
    user.setName("ä¸´æ—¶");
    entityManager.flush();  // SQLæ‰§è¡Œäº†
    
    // æ•°æ®åº“æ­¤æ—¶æœ‰"ä¸´æ—¶"
    
    throw new RuntimeException();  // ä½†äº‹åŠ¡å›æ»š
    // æœ€ç»ˆæ•°æ®åº“æ¢å¤åŸå€¼ âœ…
}
```

æŒ‡å—3ï¼šæ‰¹é‡æ“ä½œåˆ†æ®µflush
```java
int batchSize = 100;
for (int i = 0; i < users.size(); i++) {
    User user = users.get(i);
    user.setStatus("PROCESSED");
    
    if ((i + 1) % batchSize == 0) {
        entityManager.flush();  // æ¯100æ¡flush
        entityManager.clear();  // é‡Šæ”¾å†…å­˜
    }
}
// å‰©ä½™çš„
entityManager.flush();
```

### 7.3 flushçš„æ³¨æ„äº‹é¡¹


**âš ï¸ å¸¸è§é—®é¢˜**

é—®é¢˜1ï¼šè¿‡åº¦flush
```java
// âŒ ä¸å¿…è¦çš„flush
for (User user : users) {
    user.setStatus("ACTIVE");
    entityManager.flush();  // æ¯æ¬¡å¾ªç¯éƒ½flushï¼Œå¤ªé¢‘ç¹
}

// âœ… åº”è¯¥ä¸€æ¬¡flush
for (User user : users) {
    user.setStatus("ACTIVE");
}
entityManager.flush();  // ç»Ÿä¸€flush
```

é—®é¢˜2ï¼šflushé¡ºåº
```java
// JPAä¼šè‡ªåŠ¨è°ƒæ•´SQLæ‰§è¡Œé¡ºåº
entityManager.persist(order);       // INSERT
user.setName("xxx");                // UPDATE
entityManager.remove(oldOrder);     // DELETE

entityManager.flush();
// å®é™…æ‰§è¡Œé¡ºåºï¼šINSERT â†’ UPDATE â†’ DELETE âœ…
// JPAè‡ªåŠ¨ä¼˜åŒ–ï¼Œä¸ä¼šæœ‰çº¦æŸå†²çª
```

é—®é¢˜3ï¼šflushå¼‚å¸¸å¤„ç†
```java
try {
    user.setEmail("invalid");  // å‡è®¾è¿åçº¦æŸ
    entityManager.flush();
} catch (Exception e) {
    // âŒ æ­¤æ—¶äº‹åŠ¡å·²è¢«æ ‡è®°å›æ»š
    // åç»­ä»»ä½•æ“ä½œéƒ½ä¼šå¤±è´¥
    
    // âœ… åº”è¯¥ï¼š
    // 1. æ•è·å…·ä½“å¼‚å¸¸
    // 2. å›æ»šäº‹åŠ¡
    // 3. å¼€å¯æ–°äº‹åŠ¡é‡è¯•
}
```

**ğŸ”¸ flushæ£€æŸ¥æ¸…å•**

ä½¿ç”¨flushå‰é—®è‡ªå·±ï¼š
- [ ] æ˜¯å¦åœ¨äº‹åŠ¡å†…ï¼Ÿ
- [ ] æ˜¯å¦çœŸçš„éœ€è¦ç«‹å³åŒæ­¥ï¼Ÿ
- [ ] èƒ½å¦æ”¹ç”¨äº‹åŠ¡æäº¤æ—¶è‡ªåŠ¨flushï¼Ÿ
- [ ] æ‰¹é‡æ“ä½œæ˜¯å¦å·²ä¼˜åŒ–flushé¢‘ç‡ï¼Ÿ
- [ ] æ˜¯å¦å¤„ç†äº†flushå¯èƒ½çš„å¼‚å¸¸ï¼Ÿ

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ¯ è„æ£€æŸ¥äº”è¦ç´ **
```
1. å¿«ç…§æœºåˆ¶ï¼šåŠ è½½æ—¶ä¿å­˜åŸå§‹çŠ¶æ€
2. å˜æ›´æ£€æµ‹ï¼šå¯¹æ¯”å¿«ç…§å‘ç°ä¿®æ”¹
3. è‡ªåŠ¨UPDATEï¼šæ£€æµ‹åˆ°å˜åŒ–è‡ªåŠ¨ç”ŸæˆSQL
4. flushæ—¶æœºï¼šäº‹åŠ¡æäº¤ã€æŸ¥è¯¢å‰ã€æ‰‹åŠ¨flush
5. æ€§èƒ½å½±å“ï¼šå¤§é‡å®ä½“ã€é¢‘ç¹å¯¹æ¯”æœ‰å¼€é”€
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è„æ£€æŸ¥çš„æœ¬è´¨**
```
è‡ªåŠ¨åŒ–çš„å˜æ›´è·Ÿè¸ªå’ŒåŒæ­¥æœºåˆ¶
= çœå»æ‰‹åŠ¨å†™UPDATEçš„éº»çƒ¦
= ä½†è¦æ³¨æ„æ€§èƒ½å¼€é”€
```

**ğŸ”¹ å¿«ç…§æ¯”è¾ƒåŸç†**
```
å¯¹è±¡å±æ€§é€ä¸€å¯¹æ¯”ï¼š
å½“å‰å€¼ vs å¿«ç…§å€¼
  â†“
ä¸åŒ â†’ æ ‡è®°è„ â†’ ç”ŸæˆUPDATE
ç›¸åŒ â†’ è·³è¿‡
```

**ğŸ”¹ flushä¸commitçš„å…³ç³»**
```
flushï¼šå†…å­˜ â†’ æ•°æ®åº“ï¼ˆSQLæ‰§è¡Œï¼‰
commitï¼šç¡®è®¤ â†’ æ°¸ä¹…åŒ–ï¼ˆä¸å¯å›æ»šï¼‰

é¡ºåºï¼šä¿®æ”¹ â†’ flush â†’ commit
```

**ğŸ”¹ æ‰¹é‡æ›´æ–°çš„é™·é˜±**
```
JPQLæ‰¹é‡æ›´æ–° â†’ ç»•è¿‡æŒä¹…åŒ–ä¸Šä¸‹æ–‡
  â†“
å¿«ç…§ä¸æ›´æ–° â†’ å†…å­˜æ•°æ®è¿‡æœŸ
  â†“
è§£å†³ï¼šclear() æˆ– refresh()
```

### 8.3 å®è·µåº”ç”¨æŒ‡å—


**âœ… ä½¿ç”¨å»ºè®®**

æ—¥å¸¸å¼€å‘ï¼š
- é»˜è®¤è®©JPAè‡ªåŠ¨è„æ£€æŸ¥ï¼Œä¸è¦è¿‡åº¦å¹²é¢„
- ä¿®æ”¹å¯¹è±¡åä¸ç”¨æ‰‹åŠ¨UPDATEï¼ŒJPAè‡ªåŠ¨å¤„ç†
- å…³æ³¨äº‹åŠ¡è¾¹ç•Œï¼Œç¡®ä¿flushæ—¶æœºæ­£ç¡®

æ€§èƒ½ä¼˜åŒ–ï¼š
- å¤§é‡æ•°æ®ç”¨JPQLæ‰¹é‡æ“ä½œ
- æŸ¥è¯¢ç”¨DTOæŠ•å½±é¿å…å¿«ç…§å¼€é”€
- æ‰¹é‡æ“ä½œåˆç†æ§åˆ¶FlushMode

é—®é¢˜æ’æŸ¥ï¼š
- æ•°æ®ä¸åŒæ­¥ â†’ æ£€æŸ¥æ˜¯å¦flush
- æ€§èƒ½æ…¢ â†’ æ£€æŸ¥è„æ£€æŸ¥å¯¹è±¡æ•°é‡
- å†…å­˜é«˜ â†’ è€ƒè™‘clearé‡Šæ”¾å¿«ç…§

**ğŸ”¸ å¯¹æ¯”è®°å¿†**

| æ¦‚å¿µ | ä½œç”¨ | æ—¶æœº | æ³¨æ„ç‚¹ |
|------|------|------|--------|
| **è„æ£€æŸ¥** | æ£€æµ‹å˜åŒ– | flushæ—¶ | æœ‰æ€§èƒ½å¼€é”€ |
| **å¿«ç…§** | è®°å½•åŸå€¼ | åŠ è½½æ—¶ | å ç”¨å†…å­˜ |
| **flush** | åŒæ­¥æ•°æ®åº“ | äº‹åŠ¡æäº¤/æŸ¥è¯¢å‰/æ‰‹åŠ¨ | ä¸ç­‰äºcommit |
| **æ‰¹é‡æ›´æ–°** | ç»•è¿‡è„æ£€æŸ¥ | æ‰§è¡Œæ—¶ | éœ€æ¸…ç©ºä¸Šä¸‹æ–‡ |

### 8.4 å­¦ä¹ æ£€æŸ¥æ¸…å•


**âœ… æŒæ¡æ£€æŸ¥**
- [ ] ç†è§£è„æ£€æŸ¥çš„ç”Ÿæ´»åŒ–ç±»æ¯”ï¼ˆå€Ÿä¹¦è¿˜ä¹¦ï¼‰
- [ ] çŸ¥é“å¿«ç…§ä½•æ—¶åˆ›å»ºã€ä½•æ—¶å¯¹æ¯”ã€ä½•æ—¶æ›´æ–°
- [ ] æŒæ¡ä¸‰ç§flushæ—¶æœºçš„è§¦å‘æ¡ä»¶
- [ ] äº†è§£æ‰¹é‡æ›´æ–°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
- [ ] ä¼šåˆ†æè„æ£€æŸ¥å¯¹æ€§èƒ½çš„å½±å“
- [ ] èƒ½æ­£ç¡®ä½¿ç”¨æ‰‹åŠ¨flush

**ğŸ¯ æ ¸å¿ƒè®°å¿†å£è¯€**
```
è„æ£€æŸ¥åƒå€Ÿä¹¦ï¼Œå¿«ç…§è®°åˆå§‹
å¯¹æ¯”å‘ç°å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨UPDATEæ–½
flushåŒæ­¥æ•°æ®åº“ï¼Œcommitæ‰è½åœ°
æ‰¹é‡ç»•è¿‡è¦å°å¿ƒï¼Œclearåˆ·æ–°åŠæ—¶
æ€§èƒ½ä¼˜åŒ–åˆ†åœºæ™¯ï¼ŒDTOæ‰¹é‡æ˜¯è‰¯æœº
```

**ğŸ’¡ æœ€åæé†’**

è„æ£€æŸ¥æ˜¯JPAçš„æ ¸å¿ƒç‰¹æ€§ï¼Œç†è§£å®ƒçš„åŸç†èƒ½è®©ä½ ï¼š
1. **å†™å‡ºæ­£ç¡®çš„ä»£ç ** - çŸ¥é“ä»€ä¹ˆæ—¶å€™æ•°æ®ä¼šåŒæ­¥
2. **é¿å…æ€§èƒ½é—®é¢˜** - çŸ¥é“ä»€ä¹ˆæ“ä½œä¼šå½±å“æ€§èƒ½
3. **é«˜æ•ˆè§£å†³bug** - çŸ¥é“æ•°æ®ä¸ä¸€è‡´çš„åŸå› 

è®°ä½ï¼š**è„æ£€æŸ¥æ˜¯è‡ªåŠ¨åŒ–çš„ï¼Œä½†ä¸æ˜¯é­”æ³•**ã€‚ç†è§£å…¶å·¥ä½œåŸç†ï¼Œæ‰èƒ½ç”¨å¥½å®ƒï¼