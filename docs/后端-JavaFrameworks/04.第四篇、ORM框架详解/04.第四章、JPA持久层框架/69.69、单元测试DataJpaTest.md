---
title: 69ã€å•å…ƒæµ‹è¯•DataJpaTest
---
## ğŸ“š ç›®å½•

1. [å•å…ƒæµ‹è¯•åŸºç¡€æ¦‚å¿µ](#1-å•å…ƒæµ‹è¯•åŸºç¡€æ¦‚å¿µ)
2. [DataJpaTeståˆ‡ç‰‡æµ‹è¯•](#2-DataJpaTeståˆ‡ç‰‡æµ‹è¯•)
3. [æµ‹è¯•æ•°æ®åº“é…ç½®](#3-æµ‹è¯•æ•°æ®åº“é…ç½®)
4. [TestEntityManagerè¯¦è§£](#4-TestEntityManagerè¯¦è§£)
5. [æµ‹è¯•æ•°æ®å‡†å¤‡ç­–ç•¥](#5-æµ‹è¯•æ•°æ®å‡†å¤‡ç­–ç•¥)
6. [Mockå¯¹è±¡ä½¿ç”¨](#6-Mockå¯¹è±¡ä½¿ç”¨)
7. [æ–­è¨€æœ€ä½³å®è·µ](#7-æ–­è¨€æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å•å…ƒæµ‹è¯•åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•


**é€šä¿—ç†è§£**ï¼šå•å…ƒæµ‹è¯•å°±åƒæ˜¯ç»™ä»£ç åš"ä½“æ£€"ï¼Œç¡®ä¿æ¯ä¸ªå°åŠŸèƒ½éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚

```
ç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼š
é€ æ±½è½¦æ—¶ï¼Œä¸æ˜¯ç­‰æ•´è½¦ç»„è£…å®Œæ‰æµ‹è¯•
è€Œæ˜¯æ¯ä¸ªé›¶ä»¶ï¼ˆå¼•æ“ã€åˆ¹è½¦ã€è½®èƒï¼‰éƒ½å•ç‹¬æµ‹è¯•
è¿™æ ·å‡ºé—®é¢˜èƒ½ç«‹åˆ»å‘ç°ï¼Œè€Œä¸æ˜¯ç­‰åˆ°å¼€ä¸Šè·¯æ‰çŸ¥é“

ä»£ç ä¹Ÿä¸€æ ·ï¼š
ä¸æ˜¯ç­‰æ•´ä¸ªç³»ç»Ÿå®Œæˆæ‰æµ‹è¯•
è€Œæ˜¯æ¯ä¸ªæ–¹æ³•ã€æ¯ä¸ªåŠŸèƒ½éƒ½å•ç‹¬æµ‹è¯•
è¿™å°±æ˜¯"å•å…ƒæµ‹è¯•"
```

### 1.2 ä¸ºä»€ä¹ˆè¦åšå•å…ƒæµ‹è¯•


**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ” **æ—©å‘ç°é—®é¢˜**ï¼šå†™å®Œä»£ç ç«‹åˆ»æµ‹è¯•ï¼Œbugæ— å¤„è—èº«
- ğŸ›¡ï¸ **é˜²æ­¢æ”¹åä»£ç **ï¼šä¿®æ”¹ä»£ç åè·‘æµ‹è¯•ï¼Œç¡®ä¿æ²¡ç ´ååŸæœ‰åŠŸèƒ½
- ğŸ“ **ä»£ç å³æ–‡æ¡£**ï¼šçœ‹æµ‹è¯•ä»£ç å°±çŸ¥é“åŠŸèƒ½æ€ä¹ˆç”¨
- ğŸš€ **æå‡ä¿¡å¿ƒ**ï¼šæœ‰æµ‹è¯•ä¿æŠ¤ï¼Œæ”¹ä»£ç ä¸æ‹…å¿ƒ

**å®é™…åœºæ™¯**ï¼š
```
æ²¡æœ‰æµ‹è¯•æ—¶ï¼š
å¼€å‘ï¼šæ”¹äº†æŸ¥è¯¢æ–¹æ³•
æ‹…å¿ƒï¼šä¼šä¸ä¼šå½±å“å…¶ä»–åŠŸèƒ½ï¼Ÿ
åªèƒ½ï¼šå…¨éƒ¨æ‰‹åŠ¨æµ‹ä¸€éï¼ˆè€—æ—¶ä¸”å®¹æ˜“æ¼ï¼‰

æœ‰æµ‹è¯•æ—¶ï¼š
å¼€å‘ï¼šæ”¹äº†æŸ¥è¯¢æ–¹æ³•
éªŒè¯ï¼šè·‘ä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹
ç»“æœï¼š30ç§’çŸ¥é“æœ‰æ²¡æœ‰é—®é¢˜
```

### 1.3 JPAæµ‹è¯•çš„ç‰¹æ®Šæ€§


**ä¸ºä»€ä¹ˆJPAæµ‹è¯•ä¸ä¸€æ ·**ï¼š
```
æ™®é€šJavaä»£ç æµ‹è¯•ï¼š
è¾“å…¥ â†’ æ–¹æ³•å¤„ç† â†’ è¾“å‡º
åªéœ€è¦éªŒè¯é€»è¾‘æ­£ç¡®

JPAä»£ç æµ‹è¯•ï¼š
è¾“å…¥ â†’ æ•°æ®åº“æ“ä½œ â†’ è¾“å‡º
éœ€è¦éªŒè¯ï¼š
âœ… SQLè¯­å¥å¯¹ä¸å¯¹
âœ… æ•°æ®åº“æ“ä½œæˆåŠŸæ²¡æœ‰
âœ… äº‹åŠ¡å¤„ç†æ­£ç¡®å—
âœ… å…³è”å…³ç³»åŠ è½½äº†å—
```

---

## 2. ğŸ”¬ DataJpaTeståˆ‡ç‰‡æµ‹è¯•


### 2.1 ä»€ä¹ˆæ˜¯@DataJpaTest


**é€šä¿—è§£é‡Š**ï¼š`@DataJpaTest` æ˜¯Springæä¾›çš„"æµ‹è¯•ä¸“ç”¨æ ‡ç­¾"ï¼Œå®ƒä¼šå¸®ä½ åªå¯åŠ¨æ•°æ®åº“ç›¸å…³çš„ä¸œè¥¿ï¼Œä¸å¯åŠ¨æ•´ä¸ªåº”ç”¨ã€‚

```
å®Œæ•´å¯åŠ¨ vs åˆ‡ç‰‡æµ‹è¯•ï¼š

@SpringBootTestï¼ˆå®Œæ•´å¯åŠ¨ï¼‰ï¼š
å¯åŠ¨ï¼šæ•´ä¸ªSpringå®¹å™¨
åŒ…å«ï¼šWebå±‚ã€ä¸šåŠ¡å±‚ã€æ•°æ®å±‚ã€é…ç½®...
æ—¶é—´ï¼šæ…¢ï¼ˆ10-30ç§’ï¼‰
ç”¨é€”ï¼šé›†æˆæµ‹è¯•

@DataJpaTestï¼ˆåˆ‡ç‰‡æµ‹è¯•ï¼‰ï¼š
å¯åŠ¨ï¼šåªæœ‰JPAç›¸å…³ç»„ä»¶
åŒ…å«ï¼šRepositoryã€å®ä½“ã€æ•°æ®åº“é…ç½®
æ—¶é—´ï¼šå¿«ï¼ˆ2-5ç§’ï¼‰
ç”¨é€”ï¼šæ•°æ®å±‚æµ‹è¯•
```

### 2.2 åŸºç¡€ä½¿ç”¨ç¤ºä¾‹


```java
@DataJpaTest  // ğŸ”‘ æ ¸å¿ƒæ³¨è§£ï¼šå¯åŠ¨JPAæµ‹è¯•ç¯å¢ƒ
class UserRepositoryTest {
    
    @Autowired
    private UserRepository userRepository;  // è¦æµ‹è¯•çš„Repository
    
    @Test
    void ä¿å­˜ç”¨æˆ·_åº”è¯¥æˆåŠŸ() {
        // å‡†å¤‡æ•°æ®
        User user = new User("å¼ ä¸‰", "zhangsan@example.com");
        
        // æ‰§è¡Œä¿å­˜
        User saved = userRepository.save(user);
        
        // éªŒè¯ç»“æœ
        assertThat(saved.getId()).isNotNull();  // IDåº”è¯¥è‡ªåŠ¨ç”Ÿæˆ
        assertThat(saved.getName()).isEqualTo("å¼ ä¸‰");
    }
}
```

**ä»£ç è§£è¯»**ï¼š
- `@DataJpaTest`ï¼šå‘Šè¯‰Spring"æˆ‘åªæµ‹è¯•æ•°æ®å±‚ï¼Œåˆ«å¯åŠ¨å…¶ä»–çš„"
- `@Autowired`ï¼šè‡ªåŠ¨æ³¨å…¥è¦æµ‹è¯•çš„Repository
- `@Test`ï¼šæ ‡è®°è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–¹æ³•
- `assertThat`ï¼šæ–­è¨€éªŒè¯ï¼Œç›¸å½“äº"æ£€æŸ¥ç»“æœå¯¹ä¸å¯¹"

### 2.3 @DataJpaTeståšäº†ä»€ä¹ˆ


**è‡ªåŠ¨é…ç½®å†…å®¹**ï¼š
```
@DataJpaTestä¼šè‡ªåŠ¨å¸®ä½ ï¼š

âœ… é…ç½®H2å†…å­˜æ•°æ®åº“ï¼ˆä¸éœ€è¦çœŸå®æ•°æ®åº“ï¼‰
âœ… å¯ç”¨JPAç›¸å…³é…ç½®
âœ… æ‰«æ@Entityå®ä½“ç±»
âœ… æ‰«æ@Repositoryæ¥å£
âœ… é…ç½®äº‹åŠ¡ï¼ˆæ¯ä¸ªæµ‹è¯•å®Œè‡ªåŠ¨å›æ»šï¼‰
âœ… ç¦ç”¨å®Œæ•´çš„è‡ªåŠ¨é…ç½®

ä¸ä¼šå¯åŠ¨ï¼š
âŒ Webå®¹å™¨ï¼ˆTomcatï¼‰
âŒ @Serviceä¸šåŠ¡å±‚
âŒ @Controlleræ§åˆ¶å±‚
âŒ å…¶ä»–æ— å…³Bean
```

### 2.4 å¸¸ç”¨é…ç½®é€‰é¡¹


```java
@DataJpaTest(
    // åªåŠ è½½æŒ‡å®šçš„Repository
    includeFilters = @ComponentScan.Filter(
        type = FilterType.ASSIGNABLE_TYPE,
        classes = UserRepository.class
    )
)
@AutoConfigureTestDatabase(replace = Replace.NONE)  // ä½¿ç”¨çœŸå®æ•°æ®åº“
@Transactional(propagation = Propagation.NOT_SUPPORTED)  // ä¸ä½¿ç”¨äº‹åŠ¡
class CustomJpaTest {
    // æµ‹è¯•ä»£ç ...
}
```

---

## 3. ğŸ—„ï¸ æµ‹è¯•æ•°æ®åº“é…ç½®


### 3.1 H2å†…å­˜æ•°æ®åº“ï¼ˆé»˜è®¤æ–¹æ¡ˆï¼‰


**ä»€ä¹ˆæ˜¯H2å†…å­˜æ•°æ®åº“**ï¼š
```
å†…å­˜æ•°æ®åº“ vs çœŸå®æ•°æ®åº“ï¼š

MySQL/PostgreSQLï¼ˆçœŸå®æ•°æ®åº“ï¼‰ï¼š
æ•°æ®å­˜å‚¨ï¼šç£ç›˜æ–‡ä»¶
é€Ÿåº¦ï¼šè¾ƒæ…¢ï¼ˆè¦è¯»å†™ç¡¬ç›˜ï¼‰
æŒä¹…åŒ–ï¼šé‡å¯åæ•°æ®è¿˜åœ¨
ç”¨é€”ï¼šç”Ÿäº§ç¯å¢ƒ

H2ï¼ˆå†…å­˜æ•°æ®åº“ï¼‰ï¼š
æ•°æ®å­˜å‚¨ï¼šå†…å­˜
é€Ÿåº¦ï¼šè¶…å¿«ï¼ˆç›´æ¥å†…å­˜æ“ä½œï¼‰
æŒä¹…åŒ–ï¼šç¨‹åºç»“æŸæ•°æ®æ¶ˆå¤±
ç”¨é€”ï¼šæµ‹è¯•ç¯å¢ƒ
```

**ä¸ºä»€ä¹ˆæµ‹è¯•ç”¨H2**ï¼š
- âš¡ **é€Ÿåº¦å¿«**ï¼šå†…å­˜æ“ä½œæ¯”ç£ç›˜å¿«100å€
- ğŸ§¹ **è‡ªåŠ¨æ¸…ç†**ï¼šæ¯æ¬¡æµ‹è¯•å®Œæ•°æ®è‡ªåŠ¨æ¶ˆå¤±ï¼Œä¸ç•™åƒåœ¾
- ğŸ”„ **éš”ç¦»æ€§å¥½**ï¼šæ¯ä¸ªæµ‹è¯•éƒ½æ˜¯å…¨æ–°ç¯å¢ƒ
- ğŸ“¦ **é›¶é…ç½®**ï¼šSpringè‡ªåŠ¨é…ç½®ï¼Œå¼€ç®±å³ç”¨

### 3.2 H2åŸºç¡€é…ç½®


**é»˜è®¤é…ç½®**ï¼ˆæ— éœ€ä»»ä½•è®¾ç½®ï¼‰ï¼š
```java
@DataJpaTest  // è‡ªåŠ¨ä½¿ç”¨H2å†…å­˜æ•°æ®åº“
class SimpleTest {
    // ç›´æ¥ä½¿ç”¨ï¼ŒSpringå·²ç»é…ç½®å¥½äº†
}
```

**è‡ªå®šä¹‰H2é…ç½®**ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
```yaml
# application-test.yml
spring:
  datasource:
    url: jdbc:h2:mem:testdb  # å†…å­˜æ•°æ®åº“
    driver-class-name: org.h2.Driver
  jpa:
    show-sql: true  # æ˜¾ç¤ºSQLè¯­å¥
    properties:
      hibernate:
        format_sql: true  # æ ¼å¼åŒ–SQL
```

### 3.3 ä½¿ç”¨çœŸå®æ•°æ®åº“æµ‹è¯•


**ä»€ä¹ˆæ—¶å€™éœ€è¦çœŸå®æ•°æ®åº“**ï¼š
```
å†…å­˜æ•°æ®åº“H2çš„å±€é™ï¼š
âŒ ä¸æ”¯æŒæŸäº›ç‰¹å®šSQLè¯­æ³•
âŒ ä¸èƒ½æµ‹è¯•æ•°æ®åº“ç‰¹æœ‰åŠŸèƒ½
âŒ ä¸ç”Ÿäº§ç¯å¢ƒå¯èƒ½æœ‰å·®å¼‚

çœŸå®æ•°æ®åº“çš„ä¼˜åŠ¿ï¼š
âœ… å®Œå…¨çœŸå®çš„ç¯å¢ƒ
âœ… æµ‹è¯•æ•°æ®åº“ç‰¹å®šåŠŸèƒ½
âœ… éªŒè¯å¤æ‚SQLè¯­å¥
```

**é…ç½®ä½¿ç”¨çœŸå®MySQL**ï¼š
```java
@DataJpaTest
@AutoConfigureTestDatabase(replace = Replace.NONE)  // ğŸ”‘ ä¸æ›¿æ¢æ•°æ®æº
class RealDatabaseTest {
    // ä½¿ç”¨application.ymlä¸­é…ç½®çš„çœŸå®æ•°æ®åº“
}
```

**æµ‹è¯•é…ç½®æ–‡ä»¶**ï¼š
```yaml
# application-test.yml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/test_db
    username: test_user
    password: test_pass
  jpa:
    hibernate:
      ddl-auto: create-drop  # æµ‹è¯•å¼€å§‹åˆ›å»ºè¡¨ï¼Œç»“æŸåˆ é™¤è¡¨
```

### 3.4 æµ‹è¯•æ•°æ®åº“é€‰æ‹©å»ºè®®


| åœºæ™¯ | æ¨èæ•°æ®åº“ | åŸå›  |
|------|-----------|------|
| **åŸºç¡€CRUDæµ‹è¯•** | `H2å†…å­˜æ•°æ®åº“` | é€Ÿåº¦å¿«ï¼Œå¤Ÿç”¨ |
| **å¤æ‚æŸ¥è¯¢æµ‹è¯•** | `H2å†…å­˜æ•°æ®åº“` | æ”¯æŒå¤§éƒ¨åˆ†SQL |
| **ç‰¹å®šSQLè¯­æ³•** | `çœŸå®æ•°æ®åº“` | ç¡®ä¿å…¼å®¹æ€§ |
| **å­˜å‚¨è¿‡ç¨‹æµ‹è¯•** | `çœŸå®æ•°æ®åº“` | H2ä¸å®Œå…¨æ”¯æŒ |
| **æ€§èƒ½æµ‹è¯•** | `çœŸå®æ•°æ®åº“` | æ¨¡æ‹ŸçœŸå®ç¯å¢ƒ |

---

## 4. ğŸ§ª TestEntityManagerè¯¦è§£


### 4.1 ä»€ä¹ˆæ˜¯TestEntityManager


**é€šä¿—ç†è§£**ï¼š`TestEntityManager` æ˜¯æµ‹è¯•ä¸“ç”¨çš„"æ•°æ®åº“åŠ©æ‰‹"ï¼Œå¸®ä½ åœ¨æµ‹è¯•ä¸­ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œä¸é€šè¿‡Repositoryã€‚

```
ä¸ºä»€ä¹ˆéœ€è¦TestEntityManagerï¼š

æµ‹è¯•åœºæ™¯ï¼šæµ‹è¯•æ ¹æ®IDæŸ¥è¯¢ç”¨æˆ·
é—®é¢˜ï¼šå…ˆè¦åœ¨æ•°æ®åº“é‡Œæœ‰æ•°æ®æ‰èƒ½æŸ¥è¯¢
æ–¹æ¡ˆ1ï¼šç”¨Repositoryæ’å…¥æ•°æ®ï¼ˆæ­£åœ¨æµ‹è¯•çš„å¯¹è±¡ï¼‰
      âŒ ä¸å¥½ï¼šç”¨è¢«æµ‹è¯•å¯¹è±¡å‡†å¤‡æ•°æ®ï¼Œä¸çº¯ç²¹
æ–¹æ¡ˆ2ï¼šç”¨TestEntityManageræ’å…¥æ•°æ®
      âœ… å¥½ï¼šä¸“é—¨çš„å·¥å…·å‡†å¤‡æ•°æ®ï¼Œæµ‹è¯•æ›´ç‹¬ç«‹
```

### 4.2 åŸºç¡€ä½¿ç”¨ç¤ºä¾‹


```java
@DataJpaTest
class UserRepositoryTest {
    
    @Autowired
    private TestEntityManager entityManager;  // æµ‹è¯•ä¸“ç”¨çš„æ•°æ®åº“æ“ä½œå·¥å…·
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    void æ ¹æ®IDæŸ¥è¯¢ç”¨æˆ·_åº”è¯¥è¿”å›æ­£ç¡®æ•°æ®() {
        // ğŸ”§ ç”¨TestEntityManagerå‡†å¤‡æµ‹è¯•æ•°æ®
        User user = new User("æå››", "lisi@example.com");
        entityManager.persist(user);  // ä¿å­˜åˆ°æ•°æ®åº“
        entityManager.flush();  // ç«‹å³æ‰§è¡ŒSQL
        
        // ğŸ¯ æ‰§è¡Œè¦æµ‹è¯•çš„åŠŸèƒ½
        User found = userRepository.findById(user.getId()).orElse(null);
        
        // âœ… éªŒè¯ç»“æœ
        assertThat(found).isNotNull();
        assertThat(found.getName()).isEqualTo("æå››");
    }
}
```

### 4.3 æ ¸å¿ƒæ–¹æ³•è¯´æ˜


**persist() - ä¿å­˜å®ä½“**ï¼š
```java
User user = new User("ç‹äº”", "wangwu@example.com");
entityManager.persist(user);  // ä¿å­˜åˆ°æ•°æ®åº“
// æ­¤æ—¶userå¯¹è±¡æœ‰äº†ID
```

**flush() - ç«‹å³æ‰§è¡ŒSQL**ï¼š
```java
entityManager.persist(user);
entityManager.flush();  // ğŸ”‘ å¼ºåˆ¶æ‰§è¡ŒINSERTè¯­å¥

// ä¸ºä»€ä¹ˆéœ€è¦flushï¼š
// JPAé»˜è®¤ä¼šå»¶è¿Ÿæ‰§è¡ŒSQLï¼ˆæ‰¹é‡ä¼˜åŒ–ï¼‰
// æµ‹è¯•æ—¶éœ€è¦ç«‹å³æ‰§è¡Œï¼Œç¡®ä¿æ•°æ®çœŸçš„ä¿å­˜äº†
```

**clear() - æ¸…ç©ºç¼“å­˜**ï¼š
```java
entityManager.persist(user);
entityManager.flush();
entityManager.clear();  // ğŸ”‘ æ¸…ç©ºä¸€çº§ç¼“å­˜

// ä¸ºä»€ä¹ˆéœ€è¦clearï¼š
// æ¸…ç©ºç¼“å­˜åå†æŸ¥è¯¢ï¼Œä¼šçœŸæ­£ä»æ•°æ®åº“æŸ¥
// ä¸æ¸…ç©ºçš„è¯ï¼Œå¯èƒ½ç›´æ¥ä»ç¼“å­˜è¿”å›ï¼Œæµ‹è¯•ä¸å‡†ç¡®
```

**find() - æŸ¥è¯¢å®ä½“**ï¼š
```java
User user = entityManager.find(User.class, 1L);
// ç›´æ¥é€šè¿‡IDæŸ¥è¯¢ï¼Œæµ‹è¯•æ•°æ®éªŒè¯ç”¨
```

### 4.4 å®Œæ•´ä½¿ç”¨ç¤ºä¾‹


```java
@Test
void æµ‹è¯•çº§è”ä¿å­˜_åº”è¯¥ä¿å­˜å…³è”å®ä½“() {
    // å‡†å¤‡æ•°æ®
    Department dept = new Department("ç ”å‘éƒ¨");
    User user = new User("èµµå…­", "zhaoliu@example.com");
    user.setDepartment(dept);
    
    // ä¿å­˜å¹¶åˆ·æ–°
    entityManager.persist(dept);
    entityManager.persist(user);
    entityManager.flush();
    entityManager.clear();  // æ¸…ç©ºç¼“å­˜ï¼Œç¡®ä¿ä¸‹æ¬¡æŸ¥è¯¢èµ°æ•°æ®åº“
    
    // ä»æ•°æ®åº“é‡æ–°æŸ¥è¯¢
    User found = entityManager.find(User.class, user.getId());
    
    // éªŒè¯
    assertThat(found.getDepartment()).isNotNull();
    assertThat(found.getDepartment().getName()).isEqualTo("ç ”å‘éƒ¨");
}
```

---

## 5. ğŸ“‹ æµ‹è¯•æ•°æ®å‡†å¤‡ç­–ç•¥


### 5.1 æ•°æ®å‡†å¤‡çš„ä¸‰ç§æ–¹å¼


**æ–¹å¼å¯¹æ¯”**ï¼š

| æ–¹å¼ | ä½¿ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|------|------|
| **ä»£ç å‡†å¤‡** | ç®€å•æµ‹è¯• | çµæ´»ï¼Œæ˜“ä¿®æ”¹ | ä»£ç å¤šï¼Œé‡å¤ |
| **SQLè„šæœ¬** | å¤æ‚åœºæ™¯ | æ‰¹é‡å‡†å¤‡ï¼ŒçœŸå® | ç»´æŠ¤éº»çƒ¦ |
| **æµ‹è¯•å·¥å…·ç±»** | é€šç”¨æ•°æ® | å¤ç”¨æ€§é«˜ | éœ€è¦é¢å¤–ç¼–å†™ |

### 5.2 ä»£ç å‡†å¤‡æ•°æ®ï¼ˆæ¨èï¼‰


```java
@DataJpaTest
class UserRepositoryTest {
    
    @Autowired
    private TestEntityManager entityManager;
    
    // ğŸ”§ æ¯ä¸ªæµ‹è¯•å‰å‡†å¤‡æ•°æ®
    private User testUser;
    
    @BeforeEach
    void setUp() {
        testUser = new User("æµ‹è¯•ç”¨æˆ·", "test@example.com");
        testUser.setAge(25);
        entityManager.persist(testUser);
        entityManager.flush();
    }
    
    @Test
    void æµ‹è¯•æŸ¥è¯¢() {
        // ç›´æ¥ä½¿ç”¨testUserï¼Œä¸éœ€è¦é‡å¤å‡†å¤‡
        User found = userRepository.findById(testUser.getId()).orElse(null);
        assertThat(found).isNotNull();
    }
}
```

**è¦ç‚¹è¯´æ˜**ï¼š
- `@BeforeEach`ï¼šæ¯ä¸ªæµ‹è¯•æ–¹æ³•å‰è‡ªåŠ¨æ‰§è¡Œ
- ä¼˜ç‚¹ï¼šæ•°æ®éš”ç¦»ï¼Œæ¯ä¸ªæµ‹è¯•éƒ½æ˜¯å…¨æ–°ç¯å¢ƒ
- é€‚åˆï¼šæ¯ä¸ªæµ‹è¯•éœ€è¦ä¸åŒçš„åˆå§‹æ•°æ®

### 5.3 SQLè„šæœ¬å‡†å¤‡æ•°æ®


**ä»€ä¹ˆæ—¶å€™ç”¨SQLè„šæœ¬**ï¼š
```
é€‚åˆåœºæ™¯ï¼š
âœ… éœ€è¦å¤§é‡æµ‹è¯•æ•°æ®
âœ… æ•°æ®ç»“æ„å¤æ‚ï¼ˆå¤šè¡¨å…³è”ï¼‰
âœ… éœ€è¦ç‰¹å®šçš„æ•°æ®çŠ¶æ€
âœ… å›¢é˜Ÿå…±äº«æµ‹è¯•æ•°æ®
```

**ä½¿ç”¨æ–¹å¼**ï¼š
```java
@DataJpaTest
@Sql("/test-data/users.sql")  // ğŸ”‘ æŒ‡å®šSQLè„šæœ¬
class UserRepositoryTest {
    // æµ‹è¯•æ–¹æ³•æ‰§è¡Œå‰ä¼šå…ˆæ‰§è¡ŒSQLè„šæœ¬
}
```

**SQLè„šæœ¬ç¤ºä¾‹**ï¼š
```sql
-- test-data/users.sql
INSERT INTO user (id, name, email, age) VALUES 
(1, 'å¼ ä¸‰', 'zhangsan@example.com', 25),
(2, 'æå››', 'lisi@example.com', 30),
(3, 'ç‹äº”', 'wangwu@example.com', 28);

INSERT INTO department (id, name) VALUES
(1, 'ç ”å‘éƒ¨'),
(2, 'å¸‚åœºéƒ¨');

INSERT INTO user_department (user_id, dept_id) VALUES
(1, 1),
(2, 1),
(3, 2);
```

### 5.4 æµ‹è¯•å·¥å…·ç±»å‡†å¤‡ï¼ˆé«˜çº§ï¼‰


**åˆ›å»ºæµ‹è¯•æ•°æ®å·¥å‚**ï¼š
```java
// æµ‹è¯•å·¥å…·ç±»
public class TestDataFactory {
    
    // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
    public static User createUser(String name) {
        return createUser(name, name.toLowerCase() + "@example.com");
    }
    
    public static User createUser(String name, String email) {
        User user = new User(name, email);
        user.setAge(25);
        return user;
    }
    
    // åˆ›å»ºå¸¦éƒ¨é—¨çš„ç”¨æˆ·
    public static User createUserWithDept(String name, Department dept) {
        User user = createUser(name);
        user.setDepartment(dept);
        return user;
    }
}
```

**ä½¿ç”¨å·¥å…·ç±»**ï¼š
```java
@Test
void æµ‹è¯•æ‰¹é‡æ’å…¥() {
    // å¿«é€Ÿåˆ›å»ºå¤šä¸ªæµ‹è¯•ç”¨æˆ·
    List<User> users = List.of(
        TestDataFactory.createUser("ç”¨æˆ·1"),
        TestDataFactory.createUser("ç”¨æˆ·2"),
        TestDataFactory.createUser("ç”¨æˆ·3")
    );
    
    users.forEach(entityManager::persist);
    entityManager.flush();
    
    // æµ‹è¯•é€»è¾‘...
}
```

---

## 6. ğŸ­ Mockå¯¹è±¡ä½¿ç”¨


### 6.1 ä»€ä¹ˆæ˜¯Mock


**é€šä¿—è§£é‡Š**ï¼šMockå°±æ˜¯"æ›¿èº«æ¼”å‘˜"ï¼Œç”¨å‡å¯¹è±¡ä»£æ›¿çœŸå¯¹è±¡ï¼Œæ§åˆ¶å®ƒçš„è¡Œä¸ºã€‚

```
ç”µå½±æ‹æ‘„çš„ç±»æ¯”ï¼š

çœŸå®æ‹æ‘„ï¼š
æ¼”å‘˜ï¼šçœŸçš„ä»æ¥¼ä¸Šè·³ä¸‹æ¥
é£é™©ï¼šå¯èƒ½å—ä¼¤
æˆæœ¬ï¼šé«˜

ç”¨æ›¿èº«ï¼ˆMockï¼‰ï¼š
æ¼”å‘˜ï¼šæ›¿èº«æ¼”å‘˜è·³
é£é™©ï¼šä¸“ä¸šäººå‘˜ï¼Œå®‰å…¨
æˆæœ¬ï¼šä½
æ•ˆæœï¼šä¸€æ ·å¥½çœ‹

æµ‹è¯•ä¸­çš„Mockï¼š
çœŸå®å¯¹è±¡ï¼šè°ƒç”¨å¤–éƒ¨æœåŠ¡ï¼ˆæ•°æ®åº“ã€APIï¼‰
é—®é¢˜ï¼šæ…¢ã€ä¸ç¨³å®šã€ä¾èµ–å¤–éƒ¨
Mockå¯¹è±¡ï¼šå‡å¯¹è±¡ï¼Œæ¨¡æ‹Ÿè¿”å›ç»“æœ
ä¼˜ç‚¹ï¼šå¿«ã€ç¨³å®šã€å¯æ§
```

### 6.2 ä¸ºä»€ä¹ˆJPAæµ‹è¯•éœ€è¦Mock


**JPAæµ‹è¯•ä¸­çš„Mockåœºæ™¯**ï¼š
```
åœºæ™¯1ï¼šServiceå±‚è°ƒç”¨Repository
é—®é¢˜ï¼šRepositoryä¾èµ–æ•°æ®åº“ï¼Œæµ‹è¯•Serviceæ—¶ä¸æƒ³å¯åŠ¨æ•°æ®åº“
æ–¹æ¡ˆï¼šMock Repositoryï¼Œè¿”å›å‡æ•°æ®

åœºæ™¯2ï¼šæµ‹è¯•ä¸šåŠ¡é€»è¾‘
é—®é¢˜ï¼šåªæƒ³æµ‹è¯•é€»è¾‘ï¼Œä¸å…³å¿ƒæ•°æ®åº“æ“ä½œ
æ–¹æ¡ˆï¼šMockæ•°æ®å±‚ï¼Œä¸“æ³¨ä¸šåŠ¡æµ‹è¯•
```

### 6.3 MockitoåŸºç¡€ä½¿ç”¨


```java
@ExtendWith(MockitoExtension.class)  // å¯ç”¨Mockito
class UserServiceTest {
    
    @Mock
    private UserRepository userRepository;  // Mockå¯¹è±¡
    
    @InjectMocks
    private UserService userService;  // è¢«æµ‹è¯•å¯¹è±¡ï¼Œè‡ªåŠ¨æ³¨å…¥Mock
    
    @Test
    void æ ¹æ®é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·_åº”è¯¥è°ƒç”¨Repository() {
        // ğŸ­ è®¾å®šMockè¡Œä¸ºï¼šå½“è°ƒç”¨findByEmailæ—¶ï¼Œè¿”å›æŒ‡å®šç”¨æˆ·
        User mockUser = new User("Mockç”¨æˆ·", "mock@example.com");
        when(userRepository.findByEmail("mock@example.com"))
            .thenReturn(Optional.of(mockUser));
        
        // ğŸ¯ æ‰§è¡Œæµ‹è¯•
        User found = userService.getUserByEmail("mock@example.com");
        
        // âœ… éªŒè¯
        assertThat(found).isNotNull();
        assertThat(found.getName()).isEqualTo("Mockç”¨æˆ·");
        
        // âœ… éªŒè¯Repositoryè¢«è°ƒç”¨äº†
        verify(userRepository).findByEmail("mock@example.com");
    }
}
```

**ä»£ç è§£è¯»**ï¼š
- `@Mock`ï¼šåˆ›å»ºMockå¯¹è±¡
- `@InjectMocks`ï¼šè‡ªåŠ¨æ³¨å…¥Mockå¯¹è±¡åˆ°è¢«æµ‹è¯•å¯¹è±¡
- `when().thenReturn()`ï¼šè®¾å®šMockè¡Œä¸º
- `verify()`ï¼šéªŒè¯æ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨

### 6.4 å¸¸ç”¨Mockåœºæ™¯


**åœºæ™¯1ï¼šæ¨¡æ‹ŸæŸ¥è¯¢è¿”å›ç©º**
```java
@Test
void æŸ¥è¯¢ä¸å­˜åœ¨çš„ç”¨æˆ·_åº”è¯¥è¿”å›ç©º() {
    when(userRepository.findById(999L))
        .thenReturn(Optional.empty());  // æ¨¡æ‹Ÿè¿”å›ç©º
    
    User found = userService.getUserById(999L);
    assertThat(found).isNull();
}
```

**åœºæ™¯2ï¼šæ¨¡æ‹ŸæŠ›å‡ºå¼‚å¸¸**
```java
@Test
void æ•°æ®åº“å¼‚å¸¸_åº”è¯¥æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸() {
    when(userRepository.save(any(User.class)))
        .thenThrow(new DataAccessException("æ•°æ®åº“é”™è¯¯") {});
    
    assertThrows(BusinessException.class, () -> {
        userService.createUser(new User("test", "test@example.com"));
    });
}
```

**åœºæ™¯3ï¼šéªŒè¯æ–¹æ³•è°ƒç”¨æ¬¡æ•°**
```java
@Test
void æ‰¹é‡ä¿å­˜_åº”è¯¥è°ƒç”¨å¤šæ¬¡save() {
    List<User> users = List.of(new User("u1"), new User("u2"));
    
    userService.batchSave(users);
    
    verify(userRepository, times(2)).save(any(User.class));
}
```

---

## 7. âœ… æ–­è¨€æœ€ä½³å®è·µ


### 7.1 AssertJ vs JUnitæ–­è¨€


**ä¸ºä»€ä¹ˆæ¨èAssertJ**ï¼š
```
JUnitæ–­è¨€ï¼ˆä¼ ç»Ÿï¼‰ï¼š
assertEquals(expected, actual);
âŒ å¯è¯»æ€§å·®ï¼šå“ªä¸ªæ˜¯æœŸæœ›å€¼ï¼Ÿ
âŒ é”™è¯¯ä¿¡æ¯å°‘ï¼šåªè¯´ä¸ç›¸ç­‰ï¼Œæ²¡ç»†èŠ‚

AssertJæ–­è¨€ï¼ˆæ¨èï¼‰ï¼š
assertThat(actual).isEqualTo(expected);
âœ… æ›´æ˜“è¯»ï¼šåƒè¯´è¯ä¸€æ ·
âœ… é”™è¯¯ä¿¡æ¯è¯¦ç»†ï¼šæ˜ç¡®æŒ‡å‡ºå“ªé‡Œä¸ä¸€æ ·
âœ… é“¾å¼è°ƒç”¨ï¼šä¸€è¡ŒéªŒè¯å¤šä¸ªæ¡ä»¶
```

### 7.2 åŸºç¡€æ–­è¨€ç¤ºä¾‹


```java
@Test
void æ–­è¨€ç¤ºä¾‹() {
    User user = new User("å¼ ä¸‰", "zhangsan@example.com");
    user.setAge(25);
    
    // åŸºç¡€æ–­è¨€
    assertThat(user).isNotNull();
    assertThat(user.getName()).isEqualTo("å¼ ä¸‰");
    assertThat(user.getAge()).isGreaterThan(18);
    
    // å­—ç¬¦ä¸²æ–­è¨€
    assertThat(user.getEmail())
        .isNotEmpty()
        .contains("@")
        .endsWith(".com");
    
    // é›†åˆæ–­è¨€
    List<User> users = List.of(user);
    assertThat(users)
        .hasSize(1)
        .contains(user);
}
```

### 7.3 JPAç‰¹å®šæ–­è¨€


**å®ä½“å¯¹è±¡æ–­è¨€**ï¼š
```java
@Test
void å®ä½“æ–­è¨€() {
    User user = userRepository.findById(1L).orElse(null);
    
    // éªŒè¯å®ä½“å±æ€§
    assertThat(user)
        .isNotNull()
        .extracting("name", "email")
        .containsExactly("å¼ ä¸‰", "zhangsan@example.com");
    
    // éªŒè¯å…³è”å®ä½“
    assertThat(user.getDepartment())
        .isNotNull()
        .extracting("name")
        .isEqualTo("ç ”å‘éƒ¨");
}
```

**é›†åˆæŸ¥è¯¢æ–­è¨€**ï¼š
```java
@Test
void æŸ¥è¯¢ç»“æœæ–­è¨€() {
    List<User> users = userRepository.findByAgeGreaterThan(20);
    
    assertThat(users)
        .isNotEmpty()
        .hasSize(3)
        .extracting("name")
        .containsExactlyInAnyOrder("å¼ ä¸‰", "æå››", "ç‹äº”");
}
```

### 7.4 è‡ªå®šä¹‰æ–­è¨€ï¼ˆé«˜çº§ï¼‰


```java
// è‡ªå®šä¹‰ç”¨æˆ·æ–­è¨€
public class UserAssert extends AbstractAssert<UserAssert, User> {
    
    public UserAssert(User user) {
        super(user, UserAssert.class);
    }
    
    public static UserAssert assertThatUser(User user) {
        return new UserAssert(user);
    }
    
    public UserAssert hasName(String name) {
        isNotNull();
        if (!actual.getName().equals(name)) {
            failWithMessage("æœŸæœ›åå­—æ˜¯ <%s> ä½†å®é™…æ˜¯ <%s>", 
                name, actual.getName());
        }
        return this;
    }
    
    public UserAssert isAdult() {
        isNotNull();
        if (actual.getAge() < 18) {
            failWithMessage("ç”¨æˆ·åº”è¯¥æˆå¹´ï¼Œä½†å¹´é¾„æ˜¯ <%s>", actual.getAge());
        }
        return this;
    }
}

// ä½¿ç”¨è‡ªå®šä¹‰æ–­è¨€
@Test
void ä½¿ç”¨è‡ªå®šä¹‰æ–­è¨€() {
    User user = new User("å¼ ä¸‰", "zhangsan@example.com");
    user.setAge(25);
    
    assertThatUser(user)
        .hasName("å¼ ä¸‰")
        .isAdult();
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ @DataJpaTest**ï¼šJPAæµ‹è¯•ä¸“ç”¨æ³¨è§£ï¼Œåªå¯åŠ¨æ•°æ®å±‚
**ğŸ”¸ H2å†…å­˜æ•°æ®åº“**ï¼šæµ‹è¯•ä¸“ç”¨æ•°æ®åº“ï¼Œå¿«é€Ÿä¸”è‡ªåŠ¨æ¸…ç†
**ğŸ”¸ TestEntityManager**ï¼šæµ‹è¯•è¾…åŠ©å·¥å…·ï¼Œå‡†å¤‡æµ‹è¯•æ•°æ®
**ğŸ”¸ Mockå¯¹è±¡**ï¼šæ¨¡æ‹Ÿä¾èµ–ï¼Œéš”ç¦»æµ‹è¯•
**ğŸ”¸ AssertJæ–­è¨€**ï¼šæ›´å¥½çš„æ–­è¨€åº“ï¼Œå¯è¯»æ€§å¼º

### 8.2 æµ‹è¯•ç¼–å†™æµç¨‹


```
å®Œæ•´çš„æµ‹è¯•æµç¨‹ï¼š

1ï¸âƒ£ å‡†å¤‡é˜¶æ®µï¼ˆGivenï¼‰
   â†“ ç”¨TestEntityManageræˆ–SQLå‡†å¤‡æµ‹è¯•æ•°æ®
   
2ï¸âƒ£ æ‰§è¡Œé˜¶æ®µï¼ˆWhenï¼‰
   â†“ è°ƒç”¨è¦æµ‹è¯•çš„Repositoryæ–¹æ³•
   
3ï¸âƒ£ éªŒè¯é˜¶æ®µï¼ˆThenï¼‰
   â†“ ç”¨AssertJéªŒè¯ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸ
   
4ï¸âƒ£ è‡ªåŠ¨æ¸…ç†
   â†“ äº‹åŠ¡å›æ»šï¼Œæ•°æ®è‡ªåŠ¨æ¸…ç©º
```

### 8.3 æœ€ä½³å®è·µå»ºè®®


**âœ… æ¨èåšæ³•**ï¼š
- æ¯ä¸ªæµ‹è¯•åªæµ‹ä¸€ä¸ªåŠŸèƒ½ç‚¹
- æµ‹è¯•æ–¹æ³•åæ¸…æ™°æè¿°æµ‹è¯•å†…å®¹
- ç”¨`@BeforeEach`å‡†å¤‡å…¬å…±æ•°æ®
- ä¼˜å…ˆä½¿ç”¨H2å†…å­˜æ•°æ®åº“
- ç”¨AssertJå†™æ–­è¨€ï¼Œæ›´æ¸…æ™°

**âŒ é¿å…åšæ³•**ï¼š
- æµ‹è¯•ä¹‹é—´æœ‰ä¾èµ–å…³ç³»
- ä¸€ä¸ªæµ‹è¯•éªŒè¯å¤šä¸ªåŠŸèƒ½
- æµ‹è¯•ä»£ç è¿‡äºå¤æ‚
- å¿½ç•¥è¾¹ç•Œæ¡ä»¶æµ‹è¯•
- ä¸æ¸…ç†æµ‹è¯•æ•°æ®

### 8.4 å¸¸è§é—®é¢˜è§£å†³


| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| **æµ‹è¯•å¾ˆæ…¢** | æ¯æ¬¡éƒ½åˆ›å»ºæ•°æ® | ç”¨`@BeforeEach`å¤ç”¨æ•°æ® |
| **æµ‹è¯•ç›¸äº’å½±å“** | æ•°æ®æ²¡æ¸…ç† | ç¡®ä¿`@Transactional`ç”Ÿæ•ˆ |
| **æŸ¥è¯¢ç»“æœä¸ºç©º** | æ•°æ®æœªflush | è°ƒç”¨`entityManager.flush()` |
| **ç¼“å­˜å¹²æ‰°æµ‹è¯•** | ä¸€çº§ç¼“å­˜æœªæ¸…ç©º | è°ƒç”¨`entityManager.clear()` |

### 8.5 å®Œæ•´æµ‹è¯•ç¤ºä¾‹æ¨¡æ¿


```java
@DataJpaTest
class UserRepositoryTest {
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Autowired
    private UserRepository userRepository;
    
    private User testUser;
    
    @BeforeEach
    void setUp() {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        testUser = new User("æµ‹è¯•ç”¨æˆ·", "test@example.com");
        testUser.setAge(25);
        entityManager.persist(testUser);
        entityManager.flush();
    }
    
    @Test
    void æ ¹æ®é‚®ç®±æŸ¥è¯¢_åº”è¯¥è¿”å›æ­£ç¡®ç”¨æˆ·() {
        // When: æ‰§è¡ŒæŸ¥è¯¢
        User found = userRepository.findByEmail("test@example.com");
        
        // Then: éªŒè¯ç»“æœ
        assertThat(found)
            .isNotNull()
            .extracting("name", "age")
            .containsExactly("æµ‹è¯•ç”¨æˆ·", 25);
    }
    
    @Test
    void ä¿å­˜æ–°ç”¨æˆ·_åº”è¯¥ç”ŸæˆID() {
        // Given: å‡†å¤‡æ–°ç”¨æˆ·
        User newUser = new User("æ–°ç”¨æˆ·", "new@example.com");
        
        // When: ä¿å­˜
        User saved = userRepository.save(newUser);
        
        // Then: éªŒè¯
        assertThat(saved.getId()).isNotNull();
    }
}
```

---

> ğŸ’¡ **å­¦ä¹ å»ºè®®**  
> å•å…ƒæµ‹è¯•æ˜¯ä¿è¯ä»£ç è´¨é‡çš„åŸºç¡€ï¼Œå»ºè®®æ¯å†™ä¸€ä¸ªRepositoryæ–¹æ³•å°±å†™å¯¹åº”çš„æµ‹è¯•ã€‚å¼€å§‹å¯èƒ½è§‰å¾—éº»çƒ¦ï¼Œä½†å…»æˆä¹ æƒ¯åä¼šå‘ç°ï¼š**å†™æµ‹è¯•æ¯”è°ƒè¯•bugè½»æ¾å¤šäº†ï¼**

> âš ï¸ **æ³¨æ„äº‹é¡¹**  
> æµ‹è¯•ä»£ç ä¹Ÿæ˜¯ä»£ç ï¼Œè¦ä¿æŒç®€æ´æ¸…æ™°ã€‚å¦‚æœæµ‹è¯•ä»£ç æ¯”ä¸šåŠ¡ä»£ç è¿˜å¤æ‚ï¼Œè¯´æ˜è®¾è®¡æœ‰é—®é¢˜ï¼Œéœ€è¦é‡æ–°æ€è€ƒã€‚

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- æµ‹è¯•æ•°æ®å±‚ç”¨DataJpaTest
- H2å†…å­˜åº“å¿«åˆå¹²å‡€
- TestEntityManagerå‡†å¤‡æ•°æ®
- AssertJæ–­è¨€æ›´æ¸…æ™°
- Given-When-Thenå†™æµ‹è¯•