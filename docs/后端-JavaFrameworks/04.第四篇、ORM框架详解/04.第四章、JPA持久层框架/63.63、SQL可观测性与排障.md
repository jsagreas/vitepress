---
title: 63ã€SQLå¯è§‚æµ‹æ€§ä¸æ’éšœ
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯SQLå¯è§‚æµ‹æ€§](#1-ä»€ä¹ˆæ˜¯SQLå¯è§‚æµ‹æ€§)
2. [SQLæ—¥å¿—é…ç½®è¯¦è§£](#2-SQLæ—¥å¿—é…ç½®è¯¦è§£)
3. [æ…¢SQLåˆ†æä¸è¯Šæ–­](#3-æ…¢SQLåˆ†æä¸è¯Šæ–­)
4. [æ‰§è¡Œè®¡åˆ’æŸ¥çœ‹æŠ€å·§](#4-æ‰§è¡Œè®¡åˆ’æŸ¥çœ‹æŠ€å·§)
5. [æ€§èƒ½æŒ‡æ ‡ç›‘æ§](#5-æ€§èƒ½æŒ‡æ ‡ç›‘æ§)
6. [é—®é¢˜æ’æŸ¥å®æˆ˜æµç¨‹](#6-é—®é¢˜æ’æŸ¥å®æˆ˜æµç¨‹)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ä»€ä¹ˆæ˜¯SQLå¯è§‚æµ‹æ€§


### 1.1 æ ¸å¿ƒæ¦‚å¿µç†è§£


**ä»€ä¹ˆæ˜¯å¯è§‚æµ‹æ€§ï¼Ÿ**
```
ç®€å•æ¥è¯´å°±æ˜¯ï¼šè®©ä½ èƒ½"çœ‹åˆ°"ç¨‹åºåœ¨åšä»€ä¹ˆ

ä¼ ç»Ÿå¼€å‘ï¼š
åº”ç”¨ç¨‹åº â†’ æ•°æ®åº“ï¼ˆé»‘ç›’ï¼Œçœ‹ä¸åˆ°ï¼‰

æœ‰å¯è§‚æµ‹æ€§ï¼š
åº”ç”¨ç¨‹åº â†’ ğŸ“Šæ˜¾ç¤ºSQLè¯­å¥ â†’ ğŸ“ˆå±•ç¤ºæ‰§è¡Œæ—¶é—´ â†’ ğŸ“‹è®°å½•æŸ¥è¯¢ç»“æœ
```

**ä¸ºä»€ä¹ˆéœ€è¦SQLå¯è§‚æµ‹æ€§ï¼Ÿ**

| åœºæ™¯ | **æ²¡æœ‰å¯è§‚æµ‹æ€§** | **æœ‰äº†å¯è§‚æµ‹æ€§** |
|------|---------------|---------------|
| ğŸŒ **é¡µé¢åŠ è½½æ…¢** | `ä¸çŸ¥é“æ˜¯å“ªä¸ªSQLæ…¢` | `ä¸€çœ¼çœ‹å‡ºæ˜¯JOINæŸ¥è¯¢å¤ªå¤æ‚` |
| ğŸ”¥ **CPUå ç”¨é«˜** | `çŒœæµ‹å¯èƒ½æ˜¯æ•°æ®åº“é—®é¢˜` | `å‘ç°æŸä¸ªSQLæ‰§è¡Œäº†1000æ¬¡` |
| ğŸ’¾ **æ•°æ®ä¸å¯¹** | `ä¸çŸ¥é“ä¿å­˜äº†ä»€ä¹ˆ` | `çœ‹åˆ°å®é™…æ‰§è¡Œçš„UPDATEè¯­å¥` |
| ğŸ› **åŠŸèƒ½å¼‚å¸¸** | `åªèƒ½ç›²ç›®è°ƒè¯•` | `æ¸…æ¥šçœ‹åˆ°SQLæ‰§è¡Œé¡ºåº` |

> ğŸ’¡ **æ–°æ‰‹ç†è§£**ï¼šå°±åƒç»™æ±½è½¦è£…ä¸Šä»ªè¡¨ç›˜ï¼Œä½ èƒ½çœ‹åˆ°é€Ÿåº¦ã€æ²¹è€—ã€è½¬é€Ÿç­‰ä¿¡æ¯ï¼Œå¼€è½¦å°±æ›´æœ‰æŠŠæ¡äº†

### 1.2 JPAä¸­çš„å¯è§‚æµ‹æ€§ä½“ç³»


**JPA/Hibernateæä¾›çš„è§‚å¯Ÿæ‰‹æ®µ**
```
ç¬¬ä¸€å±‚ï¼šSQLè¯­å¥æ—¥å¿—
â”œâ”€ çœ‹åˆ°æ‰§è¡Œäº†ä»€ä¹ˆSQL
â”œâ”€ æŸ¥çœ‹å‚æ•°ç»‘å®šæƒ…å†µ
â””â”€ äº†è§£SQLæ‰§è¡Œé¡ºåº

ç¬¬äºŒå±‚ï¼šæ€§èƒ½ç»Ÿè®¡ä¿¡æ¯
â”œâ”€ SQLæ‰§è¡Œæ¬¡æ•°
â”œâ”€ æ‰§è¡Œè€—æ—¶
â””â”€ ç¼“å­˜å‘½ä¸­ç‡

ç¬¬ä¸‰å±‚ï¼šæ‰§è¡Œè®¡åˆ’åˆ†æ
â”œâ”€ æŸ¥çœ‹æ•°æ®åº“å¦‚ä½•æ‰§è¡ŒSQL
â”œâ”€ æ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆ
â””â”€ ä¼˜åŒ–æŸ¥è¯¢ç­–ç•¥
```

---

## 2. âš™ï¸ SQLæ—¥å¿—é…ç½®è¯¦è§£


### 2.1 åŸºç¡€æ—¥å¿—å¼€å…³ - show_sql


**ğŸ”¸ hibernate.show_sql é…ç½®**

è¿™æ˜¯æœ€åŸºç¡€çš„SQLæ—¥å¿—å¼€å…³ï¼Œæ‰“å¼€åèƒ½çœ‹åˆ°æ‰§è¡Œçš„SQLè¯­å¥ã€‚

**é…ç½®æ–¹å¼ä¸€ï¼šapplication.properties**
```properties
# å¼€å¯SQLè¯­å¥æ˜¾ç¤ºï¼ˆè¾“å‡ºåˆ°æ§åˆ¶å°ï¼‰
spring.jpa.show-sql=true

# ç­‰ä»·çš„Hibernateé…ç½®
spring.jpa.properties.hibernate.show_sql=true
```

**é…ç½®æ–¹å¼äºŒï¼šapplication.yml**
```yaml
spring:
  jpa:
    show-sql: true
    properties:
      hibernate:
        show_sql: true
```

**å®é™…æ•ˆæœå¯¹æ¯”**
```
å…³é—­show_sqlæ—¶ï¼š
ï¼ˆä»€ä¹ˆéƒ½çœ‹ä¸åˆ°ï¼Œç¨‹åºé»˜é»˜æ‰§è¡Œï¼‰

å¼€å¯show_sqlåï¼š
Hibernate: select user0_.id as id1_0_, user0_.name as name2_0_ from users user0_
Hibernate: insert into users (name, id) values (?, ?)
```

> âš ï¸ **æ³¨æ„**ï¼šshow_sqlåªä¼šè¾“å‡ºåˆ°**æ§åˆ¶å°**ï¼Œä¸ä¼šå†™å…¥æ—¥å¿—æ–‡ä»¶

### 2.2 SQLæ ¼å¼åŒ– - format_sql


**ğŸ”¸ hibernate.format_sql é…ç½®**

SQLæ ¼å¼åŒ–è®©å¤æ‚çš„SQLæ›´æ˜“è¯»ï¼Œå°±åƒä»£ç æ ¼å¼åŒ–ä¸€æ ·ã€‚

```properties
# å¼€å¯SQLæ ¼å¼åŒ–ï¼ˆè‡ªåŠ¨æ¢è¡Œå’Œç¼©è¿›ï¼‰
spring.jpa.properties.hibernate.format_sql=true
```

**æ ¼å¼åŒ–æ•ˆæœå¯¹æ¯”**
```sql
-- æœªæ ¼å¼åŒ–ï¼ˆä¸€è¡Œæ˜¾ç¤ºï¼Œéš¾ä»¥é˜…è¯»ï¼‰
Hibernate: select user0_.id as id1_0_, user0_.name as name2_0_, user0_.email as email3_0_ from users user0_ inner join orders order1_ on user0_.id=order1_.user_id where user0_.status=?

-- å·²æ ¼å¼åŒ–ï¼ˆç»“æ„æ¸…æ™°ï¼‰
Hibernate: 
    select
        user0_.id as id1_0_,
        user0_.name as name2_0_,
        user0_.email as email3_0_ 
    from
        users user0_ 
    inner join
        orders order1_ 
            on user0_.id=order1_.user_id 
    where
        user0_.status=?
```

> ğŸ’¡ **å»ºè®®**ï¼šå¼€å‘ç¯å¢ƒ**å¿…å¼€**ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼›ç”Ÿäº§ç¯å¢ƒ**å…³é—­**ï¼ŒèŠ‚çœæ—¥å¿—ç©ºé—´

### 2.3 æ˜¾ç¤ºå‚æ•°ç»‘å®šå€¼


**é—®é¢˜åœºæ™¯**
```java
// ä½ çš„ä»£ç 
userRepository.findByNameAndAge("å¼ ä¸‰", 25);

// åªå¼€å¯show_sqlçœ‹åˆ°çš„
Hibernate: select ... from users where name=? and age=?

// ç–‘é—®ï¼š? åˆ°åº•æ˜¯ä»€ä¹ˆå€¼ï¼Ÿ
```

**è§£å†³æ–¹æ¡ˆï¼šé…ç½®æ—¥å¿—çº§åˆ«**
```properties
# æ–¹å¼ä¸€ï¼šä½¿ç”¨Hibernateæ—¥å¿—ï¼ˆæ¨èï¼‰
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE

# æ–¹å¼äºŒï¼šä½¿ç”¨P6Spyæ’ä»¶ï¼ˆåŠŸèƒ½æ›´å¼ºï¼‰
# éœ€è¦æ·»åŠ ä¾èµ–ï¼šp6spy:p6spy
```

**å®Œæ•´æ•ˆæœå±•ç¤º**
```
Hibernate: 
    select
        user0_.id as id1_0_,
        user0_.name as name2_0_ 
    from
        users user0_ 
    where
        user0_.name=? 
        and user0_.age=?

// å‚æ•°ç»‘å®šæ—¥å¿—
binding parameter [1] as [VARCHAR] - [å¼ ä¸‰]
binding parameter [2] as [INTEGER] - [25]
```

### 2.4 ç»Ÿè®¡ä¿¡æ¯å¼€å…³


**ğŸ”¸ hibernate.generate_statistics é…ç½®**

ç»Ÿè®¡ä¿¡æ¯èƒ½è®©ä½ äº†è§£Hibernateçš„å†…éƒ¨è¿è¡ŒçŠ¶å†µã€‚

```properties
# å¼€å¯ç»Ÿè®¡ä¿¡æ¯æ”¶é›†
spring.jpa.properties.hibernate.generate_statistics=true

# é…ç½®ç»Ÿè®¡æ—¥å¿—çº§åˆ«
logging.level.org.hibernate.stat=DEBUG
```

**ç»Ÿè®¡ä¿¡æ¯åŒ…å«ä»€ä¹ˆï¼Ÿ**
```
ğŸ“Š æ•°æ®åº“æ“ä½œç»Ÿè®¡ï¼š
â”œâ”€ æ‰§è¡Œçš„SQLæ•°é‡
â”œâ”€ å®ä½“åŠ è½½æ¬¡æ•°
â”œâ”€ äº‹åŠ¡æäº¤/å›æ»šæ¬¡æ•°
â””â”€ è¿æ¥è·å–/é‡Šæ”¾æƒ…å†µ

ğŸ“ˆ ç¼“å­˜ç»Ÿè®¡ï¼š
â”œâ”€ ä¸€çº§ç¼“å­˜å‘½ä¸­ç‡
â”œâ”€ äºŒçº§ç¼“å­˜å‘½ä¸­ç‡
â”œâ”€ æŸ¥è¯¢ç¼“å­˜ä½¿ç”¨æƒ…å†µ
â””â”€ ç¼“å­˜çš„æ·»åŠ /åˆ é™¤/æ›´æ–°æ¬¡æ•°

â±ï¸ æ‰§è¡Œæ—¶é—´ç»Ÿè®¡ï¼š
â”œâ”€ SQLæ‰§è¡Œæ€»è€—æ—¶
â”œâ”€ æœ€æ…¢çš„SQL
â””â”€ å¹³å‡æ‰§è¡Œæ—¶é—´
```

**å®é™…è¾“å‡ºç¤ºä¾‹**
```
SessionFactoryImpl - HHH000264: Statistics:
  - Query Executions: 45
  - Query Cache Puts: 12
  - Query Cache Hits: 8
  - Query Cache Misses: 4
  - Entities Loaded: 123
  - Collections Loaded: 34
  - Second Level Cache Puts: 56
  - Second Level Cache Hits: 89
  - Successful Transactions: 15
```

---

## 3. ğŸŒ æ…¢SQLåˆ†æä¸è¯Šæ–­


### 3.1 ä»€ä¹ˆæ˜¯æ…¢SQL


**ç›´è§‚ç†è§£**
```
å¿«SQLï¼š  æ‰§è¡Œæ—¶é—´ < 100ms    âœ… ç”¨æˆ·æ— æ„ŸçŸ¥
æ­£å¸¸SQLï¼šæ‰§è¡Œæ—¶é—´ 100-500ms  âš ï¸ ç¨æœ‰å»¶è¿Ÿ
æ…¢SQLï¼š  æ‰§è¡Œæ—¶é—´ > 500ms    âŒ æ˜æ˜¾å¡é¡¿
```

**æ…¢SQLçš„å±å®³**
```
ç”¨æˆ·ä½“éªŒï¼š
ç½‘é¡µåŠ è½½æ…¢ â†’ ç”¨æˆ·ç­‰å¾… â†’ å¯èƒ½æµå¤±

ç³»ç»Ÿèµ„æºï¼š
å ç”¨æ•°æ®åº“è¿æ¥ â†’ å…¶ä»–è¯·æ±‚ç­‰å¾… â†’ ç³»ç»Ÿå˜æ…¢

æˆæœ¬é—®é¢˜ï¼š
CPU/å†…å­˜å ç”¨é«˜ â†’ éœ€è¦æ›´å¼ºçš„æœåŠ¡å™¨ â†’ æˆæœ¬å¢åŠ 
```

### 3.2 å¼€å¯æ…¢SQLæ—¥å¿—


**JPAé…ç½®æ–¹å¼**
```properties
# æ–¹å¼ä¸€ï¼šä½¿ç”¨æ•°æ®åº“åŸç”Ÿæ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆMySQLç¤ºä¾‹ï¼‰
spring.datasource.url=jdbc:mysql://localhost:3306/mydb?logger=Slf4JLogger&profileSQL=true&slowQueryThresholdMillis=500

# æ–¹å¼äºŒï¼šä½¿ç”¨Hibernateæ‹¦æˆªå™¨
spring.jpa.properties.hibernate.session.events.log.LOG_QUERIES_SLOWER_THAN_MS=500
```

**ä½¿ç”¨P6Spyç›‘æ§ï¼ˆåŠŸèƒ½å¼ºå¤§ï¼‰**
```xml
<!-- pom.xmlæ·»åŠ ä¾èµ– -->
<dependency>
    <groupId>p6spy</groupId>
    <artifactId>p6spy</artifactId>
    <version>3.9.1</version>
</dependency>
```

```properties
# spy.propertiesé…ç½®
# è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
logMessageFormat=com.p6spy.engine.spy.appender.CustomLineFormat
customLogMessageFormat=æ‰§è¡Œæ—¶é—´: %(executionTime)ms | SQL: %(sql)

# æ…¢SQLé˜ˆå€¼ï¼ˆ500msï¼‰
executionThreshold=500

# æ’é™¤ç³»ç»Ÿè¡¨
excludecategories=info,debug
```

**æ…¢SQLæ—¥å¿—ç¤ºä¾‹**
```
âš ï¸ SLOW QUERY (æ‰§è¡Œæ—¶é—´: 1523ms):
Hibernate: 
    select
        u.id,
        u.name,
        o.order_id,
        o.total_amount 
    from
        users u 
    left join
        orders o on u.id = o.user_id 
    where
        u.status = 'active'

ğŸ“Š åˆ†æï¼š
- JOINæ“ä½œæœªä½¿ç”¨ç´¢å¼•
- è¿”å›äº†10000+æ¡æ•°æ®
- å»ºè®®ï¼šæ·»åŠ ç´¢å¼•æˆ–åˆ†é¡µæŸ¥è¯¢
```

### 3.3 æ…¢SQLè¯Šæ–­æŠ€å·§


**ğŸ” å®šä½æ…¢SQLçš„æ­¥éª¤**

**ç¬¬ä¸€æ­¥ï¼šæ‰¾å‡ºæ…¢SQL**
```java
// æ–¹æ³•ä¸€ï¼šä»æ—¥å¿—ä¸­ç­›é€‰
// å…³é”®è¯ï¼šæ‰§è¡Œæ—¶é—´ã€slow query

// æ–¹æ³•äºŒï¼šä½¿ç”¨ç›‘æ§å·¥å…·
// Spring Boot Actuator + Prometheus
```

**ç¬¬äºŒæ­¥ï¼šåˆ†æSQLç»“æ„**
```sql
-- æ£€æŸ¥è¦ç‚¹ï¼š
âœ“ æ˜¯å¦ä½¿ç”¨äº†SELECT *ï¼ˆæŸ¥è¯¢äº†ä¸éœ€è¦çš„å­—æ®µï¼‰
âœ“ æ˜¯å¦æœ‰å¤æ‚çš„JOINï¼ˆå¤šè¡¨å…³è”ï¼‰
âœ“ æ˜¯å¦æœ‰å­æŸ¥è¯¢ï¼ˆåµŒå¥—æŸ¥è¯¢ï¼‰
âœ“ WHEREæ¡ä»¶æ˜¯å¦åˆç†
```

**ç¬¬ä¸‰æ­¥ï¼šæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’**
```sql
-- MySQLæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT u.*, o.* 
FROM users u 
LEFT JOIN orders o ON u.id = o.user_id 
WHERE u.status = 'active';

-- é‡ç‚¹å…³æ³¨ï¼š
type: ALLï¼ˆå…¨è¡¨æ‰«æï¼Œå¾ˆæ…¢ï¼‰ vs refï¼ˆç´¢å¼•æŸ¥è¯¢ï¼Œå¿«ï¼‰
rows: æ‰«æçš„è¡Œæ•°ï¼ˆè¶Šå°‘è¶Šå¥½ï¼‰
Extra: Using filesortï¼ˆéœ€è¦æ’åºï¼Œæ…¢ï¼‰
```

**å¸¸è§æ…¢SQLæ¨¡å¼ä¸è§£å†³æ–¹æ¡ˆ**

| æ…¢SQLç±»å‹ | **å…¸å‹ç‰¹å¾** | **è§£å†³æ–¹æ¡ˆ** |
|----------|------------|------------|
| ğŸ” **å…¨è¡¨æ‰«æ** | `type=ALL, rowså¾ˆå¤§` | `æ·»åŠ ç´¢å¼•` |
| ğŸ”— **JOINè¿‡å¤š** | `å¤šä¸ªLEFT JOIN` | `å‡å°‘JOINæˆ–ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢` |
| ğŸ“Š **æ•°æ®é‡å¤§** | `è¿”å›ä¸Šä¸‡æ¡æ•°æ®` | `ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢` |
| ğŸ”„ **N+1æŸ¥è¯¢** | `åŒä¸€SQLæ‰§è¡Œå¤šæ¬¡` | `ä½¿ç”¨JOIN FETCH` |
| ğŸ“ˆ **æ’åºæ…¢** | `ORDER BYæ— ç´¢å¼•` | `åœ¨æ’åºå­—æ®µä¸Šå»ºç´¢å¼•` |

---

## 4. ğŸ“‹ æ‰§è¡Œè®¡åˆ’æŸ¥çœ‹æŠ€å·§


### 4.1 ä»€ä¹ˆæ˜¯æ‰§è¡Œè®¡åˆ’


**é€šä¿—ç†è§£**
```
æ‰§è¡Œè®¡åˆ’ = æ•°æ®åº“çš„"ä½œæˆ˜æ–¹æ¡ˆ"

ä½ å†™çš„SQLï¼š   å‘Šè¯‰æ•°æ®åº“"è¦ä»€ä¹ˆ"
æ‰§è¡Œè®¡åˆ’ï¼š     æ•°æ®åº“å†³å®š"æ€ä¹ˆå–"

ç±»æ¯”ï¼š
ä½ è¯´ï¼šæˆ‘è¦ä»åŒ—äº¬åˆ°ä¸Šæµ·
æ‰§è¡Œè®¡åˆ’ï¼šåé£æœº vs åç«è½¦ vs å¼€è½¦ï¼ˆæ•°æ®åº“è‡ªå·±é€‰ï¼‰
```

**ä¸ºä»€ä¹ˆè¦çœ‹æ‰§è¡Œè®¡åˆ’ï¼Ÿ**
```
åœºæ™¯1ï¼šSQLå¾ˆæ…¢
â†’ çœ‹æ‰§è¡Œè®¡åˆ’ â†’ å‘ç°å…¨è¡¨æ‰«æ â†’ åŠ ç´¢å¼• â†’ å˜å¿« âœ…

åœºæ™¯2ï¼šåŒæ ·çš„SQLï¼Œæœ‰æ—¶å¿«æœ‰æ—¶æ…¢
â†’ çœ‹æ‰§è¡Œè®¡åˆ’ â†’ å‘ç°æœ‰æ—¶èµ°ç´¢å¼•æœ‰æ—¶ä¸èµ° â†’ ä¼˜åŒ–ç»Ÿè®¡ä¿¡æ¯ âœ…

åœºæ™¯3ï¼šæ•°æ®åº“CPUå ç”¨é«˜
â†’ çœ‹æ‰§è¡Œè®¡åˆ’ â†’ å‘ç°åœ¨åšå¤§é‡æ’åºæ“ä½œ â†’ ä¼˜åŒ–ORDER BY âœ…
```

### 4.2 åœ¨JPAä¸­æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’


**æ–¹æ³•ä¸€ï¼šæ•°æ®åº“åŸç”ŸEXPLAIN**

```java
// 1. å…ˆä»æ—¥å¿—è·å–SQL
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    @Query("SELECT u FROM User u WHERE u.status = :status")
    List<User> findByStatus(String status);
}

// 2. å¤åˆ¶æ—¥å¿—ä¸­çš„SQL
// Hibernate: select ... from users u where u.status=?

// 3. åœ¨æ•°æ®åº“å®¢æˆ·ç«¯æ‰§è¡ŒEXPLAIN
EXPLAIN SELECT * FROM users u WHERE u.status='active';
```

**æ–¹æ³•äºŒï¼šä½¿ç”¨HibernateåŸç”ŸSQL**
```java
@PersistenceContext
private EntityManager em;

public void analyzeQuery() {
    String sql = "SELECT * FROM users WHERE status = 'active'";
    
    // æ‰§è¡ŒEXPLAIN
    Query query = em.createNativeQuery("EXPLAIN " + sql);
    List<Object[]> results = query.getResultList();
    
    // è¾“å‡ºæ‰§è¡Œè®¡åˆ’
    for (Object[] row : results) {
        System.out.println(Arrays.toString(row));
    }
}
```

### 4.3 æ‰§è¡Œè®¡åˆ’å…³é”®æŒ‡æ ‡è§£è¯»


**MySQLæ‰§è¡Œè®¡åˆ’å­—æ®µè¯´æ˜**

```
+----+-------------+-------+------+---------------+--------+
| id | select_type | table | type | possible_keys | key    |
+----+-------------+-------+------+---------------+--------+
|  1 | SIMPLE      | users | ref  | idx_status    | idx_st |
+----+-------------+-------+------+---------------+--------+

å…³é”®å­—æ®µè§£è¯»ï¼š
```

**ğŸ”¸ typeå­—æ®µï¼ˆè®¿é—®ç±»å‹ï¼Œæ€§èƒ½ä»å¥½åˆ°å·®ï¼‰**
```
âœ… system/const:  æœ€ä¼˜ï¼ŒæŸ¥è¯¢å¸¸é‡æˆ–å•è¡Œ
âœ… eq_ref:       å”¯ä¸€ç´¢å¼•æŸ¥æ‰¾
âœ… ref:          éå”¯ä¸€ç´¢å¼•æŸ¥æ‰¾
âš ï¸ range:        ç´¢å¼•èŒƒå›´æ‰«æ
âš ï¸ index:        ç´¢å¼•å…¨æ‰«æ
âŒ ALL:          å…¨è¡¨æ‰«æï¼ˆæœ€å·®ï¼‰

ç¤ºä¾‹ï¼š
type = const    â†’ æ€§èƒ½æå¥½ï¼Œ0.001ç§’
type = ref      â†’ æ€§èƒ½è‰¯å¥½ï¼Œ0.01ç§’
type = ALL      â†’ æ€§èƒ½å¾ˆå·®ï¼Œå¯èƒ½å‡ ç§’
```

**ğŸ”¸ rowså­—æ®µï¼ˆé¢„è®¡æ‰«æè¡Œæ•°ï¼‰**
```
rows = 1        â†’ å¾ˆå¥½
rows = 100      â†’ å¯æ¥å—
rows = 10000    â†’ éœ€è¦ä¼˜åŒ–
rows = 1000000  â†’ ä¸¥é‡é—®é¢˜
```

**ğŸ”¸ Extraå­—æ®µï¼ˆé¢å¤–ä¿¡æ¯ï¼‰**
```
âœ… Using index:         è¦†ç›–ç´¢å¼•ï¼Œæœ€ä¼˜
âš ï¸ Using where:        éœ€è¦å›è¡¨æŸ¥è¯¢
âŒ Using filesort:      éœ€è¦é¢å¤–æ’åºï¼Œæ…¢
âŒ Using temporary:     éœ€è¦ä¸´æ—¶è¡¨ï¼Œå¾ˆæ…¢
```

**å®æˆ˜æ¡ˆä¾‹åˆ†æ**
```sql
-- æ…¢æŸ¥è¯¢SQL
EXPLAIN SELECT * FROM orders 
WHERE user_id = 100 
ORDER BY created_at DESC 
LIMIT 10;

-- æ‰§è¡Œè®¡åˆ’æ˜¾ç¤º
type: ALL
rows: 500000
Extra: Using where; Using filesort

-- é—®é¢˜è¯Šæ–­
âŒ ALLè¡¨ç¤ºå…¨è¡¨æ‰«æ
âŒ æ‰«æ50ä¸‡è¡Œ
âŒ Using filesortè¡¨ç¤ºéœ€è¦æ’åº

-- ä¼˜åŒ–æ–¹æ¡ˆ
âœ… åœ¨user_idä¸Šå»ºç´¢å¼•
âœ… åœ¨(user_id, created_at)ä¸Šå»ºå¤åˆç´¢å¼•
```

---

## 5. ğŸ“Š æ€§èƒ½æŒ‡æ ‡ç›‘æ§


### 5.1 Hibernateå†…ç½®ç»Ÿè®¡æŒ‡æ ‡


**å¼€å¯ç»Ÿè®¡åŠŸèƒ½**
```properties
# å¼€å¯ç»Ÿè®¡ä¿¡æ¯
spring.jpa.properties.hibernate.generate_statistics=true

# é…ç½®æ—¥å¿—çº§åˆ«
logging.level.org.hibernate.stat=DEBUG
```

**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡åˆ†ç±»**

**ğŸ”¸ SQLæ‰§è¡ŒæŒ‡æ ‡**
```
æŒ‡æ ‡åç§°                    å«ä¹‰                      ä¼˜åŒ–ç›®æ ‡
----------------------------------------
queryExecutionCount        SQLæ‰§è¡Œæ€»æ¬¡æ•°              è¶Šå°‘è¶Šå¥½
queryExecutionMaxTime      æœ€æ…¢SQLè€—æ—¶                < 500ms
queryCacheHitCount         æŸ¥è¯¢ç¼“å­˜å‘½ä¸­æ¬¡æ•°           è¶Šå¤šè¶Šå¥½
queryCacheMissCount        æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°         è¶Šå°‘è¶Šå¥½
```

**ğŸ”¸ å®ä½“æ“ä½œæŒ‡æ ‡**
```
entityLoadCount            å®ä½“åŠ è½½æ¬¡æ•°               å…³æ³¨N+1é—®é¢˜
entityInsertCount          å®ä½“æ’å…¥æ¬¡æ•°               æ‰¹é‡æ“ä½œä¼˜åŒ–
entityUpdateCount          å®ä½“æ›´æ–°æ¬¡æ•°               æ§åˆ¶æ›´æ–°é¢‘ç‡
entityDeleteCount          å®ä½“åˆ é™¤æ¬¡æ•°               è½¯åˆ é™¤è€ƒè™‘
```

**ğŸ”¸ ç¼“å­˜æ•ˆç‡æŒ‡æ ‡**
```
secondLevelCacheHitCount   äºŒçº§ç¼“å­˜å‘½ä¸­               > 80%ç†æƒ³
secondLevelCacheMissCount  äºŒçº§ç¼“å­˜æœªå‘½ä¸­             < 20%ç†æƒ³
secondLevelCachePutCount   äºŒçº§ç¼“å­˜å†™å…¥               åˆç†å³å¯
```

### 5.2 é€šè¿‡ä»£ç è·å–ç»Ÿè®¡ä¿¡æ¯


```java
@Service
public class PerformanceMonitor {
    
    @PersistenceContext
    private EntityManager em;
    
    public void printStatistics() {
        // è·å–SessionFactory
        SessionFactory sf = em.getEntityManagerFactory()
            .unwrap(SessionFactory.class);
        
        // è·å–ç»Ÿè®¡å¯¹è±¡
        Statistics stats = sf.getStatistics();
        
        // è¾“å‡ºå…³é”®æŒ‡æ ‡
        System.out.println("=== Hibernateæ€§èƒ½ç»Ÿè®¡ ===");
        System.out.println("SQLæ‰§è¡Œæ¬¡æ•°: " + stats.getQueryExecutionCount());
        System.out.println("æœ€æ…¢SQLè€—æ—¶: " + stats.getQueryExecutionMaxTime() + "ms");
        System.out.println("å®ä½“åŠ è½½æ¬¡æ•°: " + stats.getEntityLoadCount());
        System.out.println("äºŒçº§ç¼“å­˜å‘½ä¸­ç‡: " + calculateCacheHitRate(stats) + "%");
        
        // æŸ¥çœ‹æœ€æ…¢çš„SQL
        String[] queries = stats.getQueries();
        for (String query : queries) {
            QueryStatistics qs = stats.getQueryStatistics(query);
            if (qs.getExecutionMaxTime() > 500) { // è¶…è¿‡500ms
                System.out.println("âš ï¸ æ…¢æŸ¥è¯¢: " + query);
                System.out.println("   æ‰§è¡Œæ¬¡æ•°: " + qs.getExecutionCount());
                System.out.println("   æœ€å¤§è€—æ—¶: " + qs.getExecutionMaxTime() + "ms");
            }
        }
    }
    
    private double calculateCacheHitRate(Statistics stats) {
        long hits = stats.getSecondLevelCacheHitCount();
        long total = hits + stats.getSecondLevelCacheMissCount();
        return total > 0 ? (hits * 100.0 / total) : 0;
    }
}
```

### 5.3 ä½¿ç”¨Spring Boot Actuatorç›‘æ§


**æ·»åŠ ä¾èµ–**
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

**é…ç½®ç›‘æ§ç«¯ç‚¹**
```properties
# å¼€å¯æ‰€æœ‰ç›‘æ§ç«¯ç‚¹
management.endpoints.web.exposure.include=*

# å¼€å¯Hibernateç»Ÿè®¡ç«¯ç‚¹
management.endpoint.health.show-details=always
```

**è®¿é—®ç›‘æ§ä¿¡æ¯**
```
æµè§ˆå™¨è®¿é—®ï¼š
http://localhost:8080/actuator/metrics/hibernate.query.executions
http://localhost:8080/actuator/metrics/hibernate.cache.hits
http://localhost:8080/actuator/metrics/hibernate.cache.misses

è¿”å›JSONæ ¼å¼ï¼š
{
  "name": "hibernate.query.executions",
  "measurements": [
    {
      "statistic": "COUNT",
      "value": 1234
    }
  ]
}
```

---

## 6. ğŸ”§ é—®é¢˜æ’æŸ¥å®æˆ˜æµç¨‹


### 6.1 æ€§èƒ½é—®é¢˜æ’æŸ¥æ­¥éª¤


**æ ‡å‡†æ’æŸ¥æµç¨‹å›¾**
```
å‘ç°é—®é¢˜
   â†“
ç¬¬ä¸€æ­¥ï¼šç¡®è®¤ç°è±¡
â”œâ”€ å“ªä¸ªåŠŸèƒ½æ…¢ï¼Ÿ
â”œâ”€ æ…¢åˆ°ä»€ä¹ˆç¨‹åº¦ï¼Ÿ
â””â”€ æ˜¯å¶å‘è¿˜æ˜¯å¿…ç°ï¼Ÿ
   â†“
ç¬¬äºŒæ­¥ï¼šå¼€å¯SQLæ—¥å¿—
â”œâ”€ show_sql=true
â”œâ”€ format_sql=true
â””â”€ æŸ¥çœ‹å‚æ•°ç»‘å®š
   â†“
ç¬¬ä¸‰æ­¥ï¼šå®šä½æ…¢SQL
â”œâ”€ æ‰¾å‡ºè€—æ—¶>500msçš„SQL
â”œâ”€ è®°å½•SQLè¯­å¥
â””â”€ ç»Ÿè®¡æ‰§è¡Œæ¬¡æ•°
   â†“
ç¬¬å››æ­¥ï¼šåˆ†ææ‰§è¡Œè®¡åˆ’
â”œâ”€ ä½¿ç”¨EXPLAIN
â”œâ”€ æ£€æŸ¥typeå’Œrows
â””â”€ å…³æ³¨Extraä¿¡æ¯
   â†“
ç¬¬äº”æ­¥ï¼šåˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆ
â”œâ”€ åŠ ç´¢å¼•
â”œâ”€ æ”¹æŸ¥è¯¢
â””â”€ ç”¨ç¼“å­˜
   â†“
ç¬¬å…­æ­¥ï¼šéªŒè¯æ•ˆæœ
â”œâ”€ å¯¹æ¯”ä¼˜åŒ–å‰å
â”œâ”€ å‹åŠ›æµ‹è¯•
â””â”€ ä¸Šçº¿è§‚å¯Ÿ
```

### 6.2 å…¸å‹é—®é¢˜æ¡ˆä¾‹


**æ¡ˆä¾‹1ï¼šN+1æŸ¥è¯¢é—®é¢˜**

**é—®é¢˜ç°è±¡**
```java
// ä»£ç 
List<User> users = userRepository.findAll();
for (User user : users) {
    System.out.println(user.getOrders().size()); // è§¦å‘æ‡’åŠ è½½
}

// SQLæ—¥å¿—æ˜¾ç¤º
Hibernate: select * from users           -- 1æ¬¡
Hibernate: select * from orders where user_id=1  -- Næ¬¡
Hibernate: select * from orders where user_id=2
Hibernate: select * from orders where user_id=3
...ï¼ˆæ‰§è¡Œäº†N+1æ¬¡SQLï¼‰
```

**æ’æŸ¥æ­¥éª¤**
```
1. å¼€å¯SQLæ—¥å¿— â†’ å‘ç°åŒæ ·çš„SQLæ‰§è¡Œäº†å¾ˆå¤šæ¬¡
2. å®šä½ä»£ç ä½ç½® â†’ æ‰¾åˆ°å¾ªç¯ä¸­è®¿é—®å…³è”å¯¹è±¡
3. æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ â†’ æ¯æ¬¡éƒ½æ˜¯å•æ¡æŸ¥è¯¢
4. åˆ†ææ€§èƒ½å½±å“ â†’ 100ä¸ªç”¨æˆ· = 101æ¬¡SQL
```

**è§£å†³æ–¹æ¡ˆ**
```java
// æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨JOIN FETCHï¼ˆæ¨èï¼‰
@Query("SELECT u FROM User u LEFT JOIN FETCH u.orders")
List<User> findAllWithOrders();

// ä¼˜åŒ–åæ—¥å¿—
Hibernate: 
    select
        u.*, o.* 
    from
        users u 
    left join
        orders o on u.id=o.user_id
-- åªæ‰§è¡Œ1æ¬¡SQL âœ…

// æ–¹æ¡ˆäºŒï¼šä½¿ç”¨@EntityGraph
@EntityGraph(attributePaths = {"orders"})
List<User> findAll();

// æ–¹æ¡ˆä¸‰ï¼šæ‰¹é‡åŠ è½½
spring.jpa.properties.hibernate.default_batch_fetch_size=10
```

**æ¡ˆä¾‹2ï¼šç¼ºå°‘ç´¢å¼•å¯¼è‡´æ…¢æŸ¥è¯¢**

**é—®é¢˜ç°è±¡**
```java
// ä»£ç 
userRepository.findByEmail("test@example.com");

// SQLæ‰§è¡Œå¾ˆæ…¢ï¼ˆ2ç§’+ï¼‰
Hibernate: select * from users where email=?
```

**æ’æŸ¥æ­¥éª¤**
```sql
-- 1. æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM users WHERE email='test@example.com';

-- 2. æ‰§è¡Œè®¡åˆ’æ˜¾ç¤º
+----+-------+------+------+---------+
| id | table | type | rows | Extra   |
+----+-------+------+------+---------+
|  1 | users | ALL  | 1M   | Using w |
+----+-------+------+------+---------+

-- 3. é—®é¢˜è¯Šæ–­
âŒ type=ALL â†’ å…¨è¡¨æ‰«æ
âŒ rows=1M â†’ æ‰«æ100ä¸‡è¡Œ
âŒ æ²¡æœ‰ä½¿ç”¨ä»»ä½•ç´¢å¼•
```

**è§£å†³æ–¹æ¡ˆ**
```sql
-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_email ON users(email);

-- ä¼˜åŒ–åæ‰§è¡Œè®¡åˆ’
+----+-------+------+------+-----------+
| id | table | type | rows | key       |
+----+-------+------+------+-----------+
|  1 | users | ref  | 1    | idx_email |
+----+-------+------+------+-----------+

-- æ€§èƒ½å¯¹æ¯”
ä¼˜åŒ–å‰ï¼š2000ms
ä¼˜åŒ–åï¼š5ms  âœ… ï¼ˆæå‡400å€ï¼‰
```

### 6.3 æ’æŸ¥å·¥å…·æ¨è


**ğŸ”§ å¸¸ç”¨å·¥å…·æ¸…å•**

| å·¥å…·åç§° | **ç”¨é€”** | **ä¼˜åŠ¿** |
|---------|---------|---------|
| **P6Spy** | `SQLæ—¥å¿—å¢å¼º` | `æ˜¾ç¤ºå‚æ•°å€¼ã€æ‰§è¡Œæ—¶é—´` |
| **Spring Boot Actuator** | `åº”ç”¨ç›‘æ§` | `å®æ—¶æ€§èƒ½æŒ‡æ ‡` |
| **MySQL Workbench** | `æ‰§è¡Œè®¡åˆ’åˆ†æ` | `å¯è§†åŒ–æŸ¥çœ‹` |
| **JProfiler** | `æ€§èƒ½åˆ†æ` | `å®šä½ä»£ç ç“¶é¢ˆ` |
| **Arthas** | `åœ¨çº¿è¯Šæ–­` | `ä¸åœæœºæ’æŸ¥` |

**å¿«é€Ÿæ£€æŸ¥æ¸…å•**
```
â–¡ SQLæ—¥å¿—å·²å¼€å¯
â–¡ å‚æ•°ç»‘å®šå¯è§
â–¡ æ…¢SQLå·²å®šä½
â–¡ æ‰§è¡Œè®¡åˆ’å·²æŸ¥çœ‹
â–¡ ç´¢å¼•ä½¿ç”¨æƒ…å†µå·²ç¡®è®¤
â–¡ N+1æŸ¥è¯¢å·²æ’æŸ¥
â–¡ ç¼“å­˜å‘½ä¸­ç‡å·²æ£€æŸ¥
â–¡ è¿æ¥æ± çŠ¶æ€æ­£å¸¸
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„é…ç½®


**ğŸ”¸ å¼€å‘ç¯å¢ƒå¿…å¤‡é…ç½®**
```properties
# åŸºç¡€SQLæ—¥å¿—
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true

# å‚æ•°ç»‘å®šæ—¥å¿—
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE

# ç»Ÿè®¡ä¿¡æ¯
spring.jpa.properties.hibernate.generate_statistics=true
```

**ğŸ”¸ ç”Ÿäº§ç¯å¢ƒé…ç½®**
```properties
# å…³é—­æ§åˆ¶å°è¾“å‡º
spring.jpa.show-sql=false

# åªè®°å½•æ…¢SQLåˆ°æ—¥å¿—æ–‡ä»¶
logging.level.org.hibernate.SQL=WARN

# å¼€å¯ç»Ÿè®¡ï¼ˆä½å¼€é”€ï¼‰
spring.jpa.properties.hibernate.generate_statistics=true
```

### 7.2 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥ç‚¹


**ğŸ“Š æ—¥å¸¸æ£€æŸ¥æ¸…å•**
```
âœ“ SQLæ‰§è¡Œæ¬¡æ•°æ˜¯å¦åˆç†
âœ“ æ˜¯å¦å­˜åœ¨N+1æŸ¥è¯¢
âœ“ æ…¢SQLæ˜¯å¦æœ‰ç´¢å¼•
âœ“ ç¼“å­˜å‘½ä¸­ç‡æ˜¯å¦è¾¾æ ‡ï¼ˆ>80%ï¼‰
âœ“ è¿æ¥æ± æ˜¯å¦å¤Ÿç”¨
âœ“ æ‰¹é‡æ“ä½œæ˜¯å¦ç”Ÿæ•ˆ
```

### 7.3 å®ç”¨æŠ€å·§æ€»ç»“


> ğŸ’¡ **æ–°æ‰‹é¿å‘æŒ‡å—**

```
1. å¼€å‘æ—¶æ°¸è¿œå¼€å¯SQLæ—¥å¿—
   â†’ åŠæ—¶å‘ç°é—®é¢˜

2. çœ‹åˆ°é‡å¤SQLç«‹å³æ£€æŸ¥
   â†’ å¯èƒ½æ˜¯N+1é—®é¢˜

3. æ…¢æŸ¥è¯¢å…ˆçœ‹æ‰§è¡Œè®¡åˆ’
   â†’ æ‰¾åˆ°æ ¹æœ¬åŸå› 

4. ç”Ÿäº§ç¯å¢ƒç›‘æ§ç»Ÿè®¡ä¿¡æ¯
   â†’ æå‰å‘ç°éšæ‚£

5. å®šæœŸReviewæ…¢SQLæ—¥å¿—
   â†’ æŒç»­ä¼˜åŒ–æ€§èƒ½
```

**æ ¸å¿ƒè®°å¿†å£è¯€**
```
æ—¥å¿—å¼€å¯çœ‹SQLæ˜ï¼Œ
æ…¢æŸ¥è¯¢æ¥å…ˆåˆ†æã€‚
æ‰§è¡Œè®¡åˆ’æ‰¾ç“¶é¢ˆï¼Œ
ç´¢å¼•ä¼˜åŒ–æ€§èƒ½å‡ã€‚
ç»Ÿè®¡ç›‘æ§ä¸èƒ½åœï¼Œ
é—®é¢˜æ’æŸ¥æœ‰ç« ç¨‹ã€‚
```

---

## ğŸ“š è¡¥å……ï¼šå®Œæ•´é…ç½®ç¤ºä¾‹


**application.ymlå®Œæ•´é…ç½®**
```yaml
spring:
  jpa:
    # æ˜¾ç¤ºSQL
    show-sql: true
    properties:
      hibernate:
        # æ ¼å¼åŒ–SQL
        format_sql: true
        # å¼€å¯ç»Ÿè®¡
        generate_statistics: true
        # SQLæ³¨é‡Š
        use_sql_comments: true
        # æ‰¹é‡å¤§å°
        jdbc:
          batch_size: 20
        # æ…¢SQLé˜ˆå€¼
        session:
          events:
            log:
              LOG_QUERIES_SLOWER_THAN_MS: 500

# æ—¥å¿—é…ç½®
logging:
  level:
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.hibernate.stat: DEBUG
```

**å®é™…ä½¿ç”¨å»ºè®®**
```
å¼€å‘ç¯å¢ƒï¼šå…¨å¼€ï¼Œæ–¹ä¾¿è°ƒè¯•
æµ‹è¯•ç¯å¢ƒï¼šå¼€ç»Ÿè®¡ï¼Œå…³è¯¦ç»†æ—¥å¿—
ç”Ÿäº§ç¯å¢ƒï¼šåªå¼€ç»Ÿè®¡å’Œæ…¢SQLæ—¥å¿—
```