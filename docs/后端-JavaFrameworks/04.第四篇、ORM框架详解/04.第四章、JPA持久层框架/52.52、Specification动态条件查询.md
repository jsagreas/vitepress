---
title: 52ã€SpecificationåŠ¨æ€æ¡ä»¶æŸ¥è¯¢
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯SpecificationåŠ¨æ€æŸ¥è¯¢](#1-ä»€ä¹ˆæ˜¯SpecificationåŠ¨æ€æŸ¥è¯¢)
2. [æ ¸å¿ƒæ¥å£å’Œæ¦‚å¿µ](#2-æ ¸å¿ƒæ¥å£å’Œæ¦‚å¿µ)
3. [æ¡ä»¶æ„å»ºå™¨CriteriaBuilder](#3-æ¡ä»¶æ„å»ºå™¨CriteriaBuilder)
4. [è°“è¯Predicateç»„åˆ](#4-è°“è¯Predicateç»„åˆ)
5. [å®æˆ˜åº”ç”¨åœºæ™¯](#5-å®æˆ˜åº”ç”¨åœºæ™¯)
6. [æœ€ä½³å®è·µä¸ä¼˜åŒ–](#6-æœ€ä½³å®è·µä¸ä¼˜åŒ–)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯SpecificationåŠ¨æ€æŸ¥è¯¢


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€æŸ¥è¯¢


**ç°å®åœºæ™¯ç†è§£**ï¼š
æƒ³è±¡ä½ åœ¨å¼€å‘ä¸€ä¸ªç”µå•†ç½‘ç«™çš„å•†å“æœç´¢åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å¤šä¸ªæ¡ä»¶ç­›é€‰å•†å“ï¼š

```
ç”¨æˆ·æœç´¢æ¡ä»¶ï¼ˆå¯é€‰çš„ï¼‰ï¼š
â˜‘ï¸ å•†å“åç§°åŒ…å«"æ‰‹æœº"
â˜ ä»·æ ¼èŒƒå›´ï¼š1000-5000å…ƒ
â˜‘ï¸ å“ç‰Œï¼šåä¸º
â˜ åº“å­˜çŠ¶æ€ï¼šæœ‰è´§
â˜‘ï¸ ä¸Šæ¶æ—¶é—´ï¼šæœ€è¿‘30å¤©

é—®é¢˜ï¼šç”¨æˆ·å‹¾é€‰çš„æ¡ä»¶æ˜¯åŠ¨æ€çš„ï¼Œæ€ä¹ˆæ„å»ºæŸ¥è¯¢ï¼Ÿ
```

**ä¼ ç»Ÿæ–¹æ³•çš„å›°å¢ƒ**ï¼š
- å†™å›ºå®šæŸ¥è¯¢æ–¹æ³•ï¼Ÿéœ€è¦ä¸ºæ¯ç§æ¡ä»¶ç»„åˆå†™ä¸€ä¸ªæ–¹æ³•ï¼ˆç»„åˆçˆ†ç‚¸ï¼ï¼‰
- ç”¨å­—ç¬¦ä¸²æ‹¼æ¥SQLï¼Ÿå®¹æ˜“å‡ºé”™ä¸”ä¸å®‰å…¨
- ç”¨@Queryæ³¨è§£ï¼Ÿåªèƒ½å†™å›ºå®šæ¡ä»¶çš„æŸ¥è¯¢

**Specificationçš„è§£å†³æ–¹æ¡ˆ**ï¼š
å¯ä»¥åƒæ­ç§¯æœ¨ä¸€æ ·ï¼Œæ ¹æ®ç”¨æˆ·å®é™…é€‰æ‹©çš„æ¡ä»¶ï¼ŒåŠ¨æ€ç»„è£…æŸ¥è¯¢è¯­å¥ï¼Œæ—¢çµæ´»åˆå®‰å…¨ï¼

### 1.2 ä»€ä¹ˆæ˜¯Specification


**é€šä¿—è§£é‡Š**ï¼š
Specificationå°±åƒæ˜¯ä¸€ä¸ª"æŸ¥è¯¢æ¡ä»¶çš„é…æ–¹"ï¼Œä½ å¯ä»¥æŠŠå„ç§ç­›é€‰æ¡ä»¶ç»„åˆåœ¨ä¸€èµ·ï¼Œæœ€ç»ˆç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„æ•°æ®åº“æŸ¥è¯¢ã€‚

```
ç±»æ¯”ç†è§£ï¼š

åšèœé…æ–¹ï¼š                  SpecificationæŸ¥è¯¢é…æ–¹ï¼š
1. é€‰æ‹©é£Ÿæï¼ˆæ¡ä»¶ï¼‰          1. é€‰æ‹©æŸ¥è¯¢å­—æ®µ
2. æ·»åŠ è°ƒæ–™ï¼ˆç»„åˆï¼‰          2. æ·»åŠ ç­›é€‰æ¡ä»¶
3. æŒ‰æ­¥éª¤çƒ¹é¥ª              3. ç»„åˆæŸ¥è¯¢é€»è¾‘
4. å¾—åˆ°æˆå“èœ              4. å¾—åˆ°æŸ¥è¯¢ç»“æœ

å…³é”®ï¼šé…æ–¹å¯ä»¥çµæ´»è°ƒæ•´ï¼Œé£Ÿæå¯ä»¥æŒ‰éœ€æ·»åŠ æˆ–å‡å°‘
```

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- ç±»å‹å®‰å…¨ âœ… - ç¼–è¯‘æœŸå°±èƒ½æ£€æŸ¥é”™è¯¯
- åŠ¨æ€çµæ´» âœ… - æ¡ä»¶å¯ä»¥éšæ—¶å¢å‡
- å¯é‡ç”¨ âœ… - æ¡ä»¶ç‰‡æ®µå¯ä»¥ç»„åˆå¤ç”¨
- æ˜“ç»´æŠ¤ âœ… - é€»è¾‘æ¸…æ™°ä¸æ˜“å‡ºé”™

### 1.3 Specificationçš„å·¥ä½œåŸç†


**å·¥ä½œæµç¨‹å›¾ç¤º**ï¼š
```
ç”¨æˆ·è¯·æ±‚ï¼ˆåŠ¨æ€æ¡ä»¶ï¼‰
        â†“
Specificationæ¥å£ï¼ˆå®šä¹‰æŸ¥è¯¢è§„åˆ™ï¼‰
        â†“
CriteriaBuilderï¼ˆæ¡ä»¶æ„å»ºå·¥å…·ï¼‰
        â†“
ç”Ÿæˆç±»å‹å®‰å…¨çš„æŸ¥è¯¢æ¡ä»¶
        â†“
JPAè‡ªåŠ¨è½¬æ¢ä¸ºSQLè¯­å¥
        â†“
è¿”å›æŸ¥è¯¢ç»“æœ
```

---

## 2. ğŸ”§ æ ¸å¿ƒæ¥å£å’Œæ¦‚å¿µ


### 2.1 JpaSpecificationExecutoræ¥å£


**æ¥å£ä½œç”¨**ï¼š
è¿™æ˜¯Spring Data JPAæä¾›çš„ç‰¹æ®Šæ¥å£ï¼Œåªè¦ä½ çš„Repositoryç»§æ‰¿å®ƒï¼Œå°±èƒ½ä½¿ç”¨SpecificationæŸ¥è¯¢ã€‚

**ä½¿ç”¨æ–¹å¼**ï¼š
```java
// è®©Repositoryç»§æ‰¿JpaSpecificationExecutor
public interface ProductRepository extends JpaRepository<Product, Long>, 
                                           JpaSpecificationExecutor<Product> {
    // ä¸éœ€è¦å†™ä»»ä½•æ–¹æ³•ï¼Œè‡ªåŠ¨æ‹¥æœ‰SpecificationæŸ¥è¯¢èƒ½åŠ›ï¼
}
```

**è‡ªåŠ¨è·å¾—çš„æŸ¥è¯¢æ–¹æ³•**ï¼š

| æ–¹æ³•å | ä½œç”¨è¯´æ˜ | è¿”å›ç±»å‹ |
|-------|---------|---------|
| `findOne(Specification)` | æŸ¥è¯¢å•ä¸ªç»“æœ | `Optional<T>` |
| `findAll(Specification)` | æŸ¥è¯¢æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„ç»“æœ | `List<T>` |
| `findAll(Specification, Pageable)` | åˆ†é¡µæŸ¥è¯¢ | `Page<T>` |
| `findAll(Specification, Sort)` | æ’åºæŸ¥è¯¢ | `List<T>` |
| `count(Specification)` | ç»Ÿè®¡æ•°é‡ | `long` |

### 2.2 Specificationæ¥å£è¯¦è§£


**æ¥å£å®šä¹‰**ï¼š
```java
@FunctionalInterface  // å‡½æ•°å¼æ¥å£ï¼Œå¯ä»¥ç”¨Lambdaè¡¨è¾¾å¼
public interface Specification<T> {
    // å”¯ä¸€çš„æŠ½è±¡æ–¹æ³•ï¼šå®šä¹‰æŸ¥è¯¢æ¡ä»¶
    Predicate toPredicate(Root<T> root, 
                         CriteriaQuery<?> query, 
                         CriteriaBuilder cb);
}
```

**ä¸‰ä¸ªæ ¸å¿ƒå‚æ•°è§£é‡Š**ï¼š

```
å‚æ•°1ï¼šRoot<T> root
ä½œç”¨ï¼šä»£è¡¨æŸ¥è¯¢çš„æ ¹å¯¹è±¡ï¼ˆå°±æ˜¯ä½ è¦æŸ¥è¯¢çš„å®ä½“ç±»ï¼‰
é€šä¿—ç†è§£ï¼šæŒ‡å®šä»å“ªå¼ è¡¨æŸ¥æ•°æ®
ç”¨é€”ï¼šé€šè¿‡å®ƒè·å–å®ä½“ç±»çš„å­—æ®µï¼Œç”¨äºæ„å»ºæ¡ä»¶

å‚æ•°2ï¼šCriteriaQuery<?> query  
ä½œç”¨ï¼šä»£è¡¨æ•´ä¸ªæŸ¥è¯¢å¯¹è±¡
é€šä¿—ç†è§£ï¼šå®šä¹‰æŸ¥è¯¢çš„æ•´ä½“ç»“æ„ï¼ˆé€‰ä»€ä¹ˆã€æ’åºç­‰ï¼‰
ç”¨é€”ï¼šè®¾ç½®æŸ¥è¯¢ç»“æœç±»å‹ã€åˆ†ç»„ã€æ’åºç­‰

å‚æ•°3ï¼šCriteriaBuilder cb
ä½œç”¨ï¼šæ¡ä»¶æ„å»ºå™¨ï¼Œæœ€é‡è¦çš„å·¥å…·ï¼
é€šä¿—ç†è§£ï¼šæä¾›å„ç§æ„å»ºæŸ¥è¯¢æ¡ä»¶çš„æ–¹æ³•
ç”¨é€”ï¼šåˆ›å»ºå„ç§æŸ¥è¯¢æ¡ä»¶ï¼ˆç­‰äºã€å¤§äºã€æ¨¡ç³ŠæŸ¥è¯¢ç­‰ï¼‰
```

**å‚æ•°å…³ç³»å›¾ç¤º**ï¼š
```
SpecificationæŸ¥è¯¢
    â”œâ”€â”€ Root (ä»å“ªæŸ¥)
    â”‚   â””â”€â”€ æŒ‡å®šå®ä½“ç±»å’Œå­—æ®µ
    â”‚
    â”œâ”€â”€ CriteriaQuery (æ€ä¹ˆæŸ¥)
    â”‚   â””â”€â”€ å®šä¹‰æŸ¥è¯¢ç»“æ„
    â”‚
    â””â”€â”€ CriteriaBuilder (æŸ¥ä»€ä¹ˆ)
        â””â”€â”€ æ„å»ºå…·ä½“æ¡ä»¶
```

### 2.3 åŸºç¡€ä½¿ç”¨ç¤ºä¾‹


**ç®€å•çš„å•æ¡ä»¶æŸ¥è¯¢**ï¼š
```java
// æŸ¥è¯¢åç§°ä¸º"iPhone 15"çš„å•†å“
Specification<Product> spec = (root, query, cb) -> {
    // root.get("name") - è·å–nameå­—æ®µ
    // cb.equal() - åˆ›å»º"ç­‰äº"æ¡ä»¶
    return cb.equal(root.get("name"), "iPhone 15");
};

List<Product> products = productRepository.findAll(spec);
```

**ä»£ç è§£è¯»**ï¼š
```
1. root.get("name") 
   â†’ å‘Šè¯‰JPAï¼š"æˆ‘è¦ç”¨Productå®ä½“çš„nameå­—æ®µ"
   
2. cb.equal(å­—æ®µ, å€¼)
   â†’ å‘Šè¯‰JPAï¼š"æˆ‘è¦æŸ¥nameç­‰äºæŸä¸ªå€¼çš„æ•°æ®"
   
3. return è¿™ä¸ªæ¡ä»¶
   â†’ å‘Šè¯‰JPAï¼š"ç”¨è¿™ä¸ªæ¡ä»¶å»æŸ¥è¯¢"
```

---

## 3. ğŸ› ï¸ æ¡ä»¶æ„å»ºå™¨CriteriaBuilder


### 3.1 CriteriaBuilderæ ¸å¿ƒæ–¹æ³•


**å¸¸ç”¨æ¡ä»¶æ„å»ºæ–¹æ³•**ï¼š

| æ–¹æ³•ç±»å‹ | æ–¹æ³•å | è¯´æ˜ | SQLå¯¹åº” |
|---------|-------|------|---------|
| **ç›¸ç­‰æ¯”è¾ƒ** | `equal(x, y)` | ç­‰äº | `WHERE x = y` |
| **ä¸ç­‰æ¯”è¾ƒ** | `notEqual(x, y)` | ä¸ç­‰äº | `WHERE x != y` |
| **å¤§å°æ¯”è¾ƒ** | `gt(x, y)` | å¤§äº | `WHERE x > y` |
| | `ge(x, y)` | å¤§äºç­‰äº | `WHERE x >= y` |
| | `lt(x, y)` | å°äº | `WHERE x < y` |
| | `le(x, y)` | å°äºç­‰äº | `WHERE x <= y` |
| **æ¨¡ç³ŠæŸ¥è¯¢** | `like(x, pattern)` | æ¨¡ç³ŠåŒ¹é… | `WHERE x LIKE pattern` |
| **èŒƒå›´æŸ¥è¯¢** | `between(x, y, z)` | åŒºé—´èŒƒå›´ | `WHERE x BETWEEN y AND z` |
| **ç©ºå€¼åˆ¤æ–­** | `isNull(x)` | æ˜¯å¦ä¸ºç©º | `WHERE x IS NULL` |
| | `isNotNull(x)` | æ˜¯å¦éç©º | `WHERE x IS NOT NULL` |
| **é›†åˆæŸ¥è¯¢** | `in(x)` | åœ¨é›†åˆä¸­ | `WHERE x IN (...)` |

### 3.2 å®é™…åº”ç”¨ç¤ºä¾‹


**ç¤ºä¾‹1ï¼šä»·æ ¼åŒºé—´æŸ¥è¯¢**
```java
// æŸ¥è¯¢ä»·æ ¼åœ¨1000-5000ä¹‹é—´çš„å•†å“
Specification<Product> spec = (root, query, cb) -> {
    return cb.between(root.get("price"), 1000.0, 5000.0);
};
```

**ç¤ºä¾‹2ï¼šæ¨¡ç³ŠæŸ¥è¯¢**
```java
// æŸ¥è¯¢åç§°åŒ…å«"æ‰‹æœº"çš„å•†å“
Specification<Product> spec = (root, query, cb) -> {
    // %æ˜¯SQLçš„é€šé…ç¬¦ï¼Œè¡¨ç¤ºä»»æ„å­—ç¬¦
    return cb.like(root.get("name"), "%æ‰‹æœº%");
};
```

**ç¤ºä¾‹3ï¼šæ—¥æœŸèŒƒå›´æŸ¥è¯¢**
```java
// æŸ¥è¯¢æœ€è¿‘30å¤©ä¸Šæ¶çš„å•†å“
Specification<Product> spec = (root, query, cb) -> {
    LocalDateTime thirtyDaysAgo = LocalDateTime.now().minusDays(30);
    return cb.greaterThanOrEqualTo(root.get("createTime"), thirtyDaysAgo);
};
```

### 3.3 å­—æ®µè·å–æŠ€å·§


**è·å–ç®€å•å­—æ®µ**ï¼š
```java
// ç›´æ¥å­—æ®µ
root.get("name")      // å•†å“åç§°
root.get("price")     // å•†å“ä»·æ ¼
root.get("stock")     // åº“å­˜æ•°é‡
```

**è·å–å…³è”å¯¹è±¡å­—æ®µ**ï¼š
```java
// å‡è®¾Productæœ‰categoryå…³è”ï¼ˆå¤šå¯¹ä¸€ï¼‰
// æŸ¥è¯¢åˆ†ç±»åç§°ä¸º"æ‰‹æœº"çš„å•†å“
Specification<Product> spec = (root, query, cb) -> {
    // é€šè¿‡joinè·å–å…³è”å¯¹è±¡çš„å­—æ®µ
    return cb.equal(root.join("category").get("name"), "æ‰‹æœº");
};
```

**å…³è”æŸ¥è¯¢å›¾ç¤º**ï¼š
```
Productè¡¨           Categoryè¡¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id       â”‚       â”‚ id       â”‚
â”‚ name     â”‚       â”‚ name     â”‚
â”‚ price    â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ category â”œâ”€â”€â”€â”€â”€â”€â†’ (å…³è”å…³ç³»)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥è¯¢é€»è¾‘ï¼š
root.join("category")     â†’ è¿æ¥Categoryè¡¨
    .get("name")         â†’ è·å–Categoryçš„nameå­—æ®µ
```

---

## 4. ğŸ”— è°“è¯Predicateç»„åˆ


### 4.1 ä»€ä¹ˆæ˜¯Predicate


**é€šä¿—ç†è§£**ï¼š
Predicateï¼ˆè°“è¯ï¼‰å°±æ˜¯ä¸€ä¸ª"åˆ¤æ–­æ¡ä»¶"ï¼Œå®ƒä¼šè¿”å›trueæˆ–falseã€‚åœ¨æŸ¥è¯¢ä¸­ï¼Œtrueè¡¨ç¤ºç¬¦åˆæ¡ä»¶ï¼Œfalseè¡¨ç¤ºä¸ç¬¦åˆã€‚

```
ç°å®ä¾‹å­ï¼š

ç­›é€‰è‹¹æœï¼š
- æ¡ä»¶1ï¼šé‡é‡ > 200å…‹ (Predicate 1)
- æ¡ä»¶2ï¼šé¢œè‰² = çº¢è‰² (Predicate 2)
- æ¡ä»¶3ï¼šä»·æ ¼ < 10å…ƒ (Predicate 3)

æœ€ç»ˆç­›é€‰ï¼šåŒæ—¶æ»¡è¶³æ¡ä»¶1 AND æ¡ä»¶2 AND æ¡ä»¶3
```

### 4.2 é€»è¾‘è¿ç®—ç¬¦


**ä¸‰ç§ç»„åˆæ–¹å¼**ï¼š

| è¿ç®—ç¬¦ | æ–¹æ³• | è¯´æ˜ | SQLå¯¹åº” |
|-------|------|------|---------|
| **ä¸** | `cb.and(p1, p2)` | æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³ | `WHERE p1 AND p2` |
| **æˆ–** | `cb.or(p1, p2)` | æ»¡è¶³ä»»ä¸€æ¡ä»¶ | `WHERE p1 OR p2` |
| **é** | `cb.not(p1)` | æ¡ä»¶å–å | `WHERE NOT p1` |

### 4.3 ANDç»„åˆç¤ºä¾‹


**éœ€æ±‚**ï¼šæŸ¥è¯¢ä»·æ ¼åœ¨1000-5000ä¹‹é—´ **ä¸”** åº“å­˜å¤§äº0çš„å•†å“

```java
Specification<Product> spec = (root, query, cb) -> {
    // æ¡ä»¶1ï¼šä»·æ ¼èŒƒå›´
    Predicate p1 = cb.between(root.get("price"), 1000.0, 5000.0);
    
    // æ¡ä»¶2ï¼šåº“å­˜å¤§äº0
    Predicate p2 = cb.greaterThan(root.get("stock"), 0);
    
    // ç»„åˆï¼šä¸¤ä¸ªæ¡ä»¶éƒ½è¦æ»¡è¶³
    return cb.and(p1, p2);
};
```

**é€»è¾‘å›¾ç¤º**ï¼š
```
å•†å“ç­›é€‰æµç¨‹ï¼š
    æ‰€æœ‰å•†å“
       â†“
    [ä»·æ ¼1000-5000ï¼Ÿ]  â†’ ä¸ç¬¦åˆ â†’ æ’é™¤
       â†“ ç¬¦åˆ
    [åº“å­˜ > 0ï¼Ÿ]       â†’ ä¸ç¬¦åˆ â†’ æ’é™¤
       â†“ ç¬¦åˆ
    è¿”å›ç»“æœ
```

### 4.4 ORç»„åˆç¤ºä¾‹


**éœ€æ±‚**ï¼šæŸ¥è¯¢å“ç‰Œæ˜¯"åä¸º" **æˆ–è€…** å“ç‰Œæ˜¯"å°ç±³"çš„å•†å“

```java
Specification<Product> spec = (root, query, cb) -> {
    // æ¡ä»¶1ï¼šå“ç‰Œ=åä¸º
    Predicate p1 = cb.equal(root.get("brand"), "åä¸º");
    
    // æ¡ä»¶2ï¼šå“ç‰Œ=å°ç±³
    Predicate p2 = cb.equal(root.get("brand"), "å°ç±³");
    
    // ç»„åˆï¼šæ»¡è¶³ä»»ä¸€æ¡ä»¶å³å¯
    return cb.or(p1, p2);
};
```

### 4.5 å¤æ‚ç»„åˆç¤ºä¾‹


**éœ€æ±‚**ï¼šæŸ¥è¯¢ï¼ˆå“ç‰Œæ˜¯åä¸º **ä¸”** ä»·æ ¼<3000ï¼‰**æˆ–è€…**ï¼ˆå“ç‰Œæ˜¯å°ç±³ **ä¸”** ä»·æ ¼<2000ï¼‰çš„å•†å“

```java
Specification<Product> spec = (root, query, cb) -> {
    // åä¸ºçš„æ¡ä»¶
    Predicate huawei = cb.equal(root.get("brand"), "åä¸º");
    Predicate huaweiPrice = cb.lessThan(root.get("price"), 3000.0);
    Predicate huaweiCondition = cb.and(huawei, huaweiPrice);
    
    // å°ç±³çš„æ¡ä»¶
    Predicate xiaomi = cb.equal(root.get("brand"), "å°ç±³");
    Predicate xiaomiPrice = cb.lessThan(root.get("price"), 2000.0);
    Predicate xiaomiCondition = cb.and(xiaomi, xiaomiPrice);
    
    // æœ€ç»ˆç»„åˆï¼šåä¸ºæ¡ä»¶ OR å°ç±³æ¡ä»¶
    return cb.or(huaweiCondition, xiaomiCondition);
};
```

**é€»è¾‘ç»“æ„å›¾**ï¼š
```
æŸ¥è¯¢æ¡ä»¶ç»“æ„ï¼š
    OR (æˆ–)
    â”œâ”€â”€ AND (ä¸”)
    â”‚   â”œâ”€â”€ å“ç‰Œ=åä¸º
    â”‚   â””â”€â”€ ä»·æ ¼<3000
    â”‚
    â””â”€â”€ AND (ä¸”)
        â”œâ”€â”€ å“ç‰Œ=å°ç±³
        â””â”€â”€ ä»·æ ¼<2000
```

### 4.6 åŠ¨æ€æ¡ä»¶ç»„åˆæŠ€å·§


**å®é™…å¼€å‘åœºæ™¯**ï¼šç”¨æˆ·å¯èƒ½è¾“å…¥éƒ¨åˆ†æ¡ä»¶ï¼Œéœ€è¦åŠ¨æ€ç»„è£…

```java
public Specification<Product> buildSpec(String name, Double minPrice, 
                                       Double maxPrice, String brand) {
    return (root, query, cb) -> {
        List<Predicate> predicates = new ArrayList<>();
        
        // å¦‚æœnameä¸ä¸ºç©ºï¼Œæ·»åŠ åç§°æ¡ä»¶
        if (name != null && !name.isEmpty()) {
            predicates.add(cb.like(root.get("name"), "%" + name + "%"));
        }
        
        // å¦‚æœminPriceä¸ä¸ºç©ºï¼Œæ·»åŠ æœ€ä½ä»·æ ¼æ¡ä»¶
        if (minPrice != null) {
            predicates.add(cb.ge(root.get("price"), minPrice));
        }
        
        // å¦‚æœmaxPriceä¸ä¸ºç©ºï¼Œæ·»åŠ æœ€é«˜ä»·æ ¼æ¡ä»¶
        if (maxPrice != null) {
            predicates.add(cb.le(root.get("price"), maxPrice));
        }
        
        // å¦‚æœbrandä¸ä¸ºç©ºï¼Œæ·»åŠ å“ç‰Œæ¡ä»¶
        if (brand != null && !brand.isEmpty()) {
            predicates.add(cb.equal(root.get("brand"), brand));
        }
        
        // å°†æ‰€æœ‰æ¡ä»¶ç”¨ANDè¿æ¥
        return cb.and(predicates.toArray(new Predicate[0]));
    };
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// åœºæ™¯1ï¼šåªæœç´¢åç§°
Specification<Product> spec1 = buildSpec("æ‰‹æœº", null, null, null);
// ç”ŸæˆSQL: WHERE name LIKE '%æ‰‹æœº%'

// åœºæ™¯2ï¼šæœç´¢åç§°å’Œä»·æ ¼èŒƒå›´
Specification<Product> spec2 = buildSpec("æ‰‹æœº", 1000.0, 5000.0, null);
// ç”ŸæˆSQL: WHERE name LIKE '%æ‰‹æœº%' AND price >= 1000 AND price <= 5000

// åœºæ™¯3ï¼šå…¨æ¡ä»¶æœç´¢
Specification<Product> spec3 = buildSpec("æ‰‹æœº", 1000.0, 5000.0, "åä¸º");
// ç”ŸæˆSQL: WHERE name LIKE '%æ‰‹æœº%' AND price >= 1000 
//          AND price <= 5000 AND brand = 'åä¸º'
```

---

## 5. ğŸ’¼ å®æˆ˜åº”ç”¨åœºæ™¯


### 5.1 å®Œæ•´çš„å•†å“æœç´¢åŠŸèƒ½


**ä¸šåŠ¡éœ€æ±‚**ï¼š
- æ”¯æŒå•†å“åç§°æ¨¡ç³Šæœç´¢
- æ”¯æŒä»·æ ¼åŒºé—´ç­›é€‰
- æ”¯æŒå“ç‰Œç­›é€‰
- æ”¯æŒåº“å­˜çŠ¶æ€ç­›é€‰
- æ”¯æŒåˆ†é¡µå’Œæ’åº

**å®ä½“ç±»å®šä¹‰**ï¼š
```java
@Entity
public class Product {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;      // å•†å“åç§°
    private Double price;     // ä»·æ ¼
    private String brand;     // å“ç‰Œ
    private Integer stock;    // åº“å­˜
    private LocalDateTime createTime;  // åˆ›å»ºæ—¶é—´
    
    // getter/setterçœç•¥
}
```

**Repositoryå®šä¹‰**ï¼š
```java
public interface ProductRepository extends JpaRepository<Product, Long>,
                                           JpaSpecificationExecutor<Product> {
}
```

**Serviceå±‚å®ç°**ï¼š
```java
@Service
public class ProductService {
    
    @Autowired
    private ProductRepository productRepository;
    
    // åŠ¨æ€æ¡ä»¶æŸ¥è¯¢æ–¹æ³•
    public Page<Product> searchProducts(ProductSearchDTO searchDTO, 
                                        Pageable pageable) {
        
        Specification<Product> spec = (root, query, cb) -> {
            List<Predicate> predicates = new ArrayList<>();
            
            // 1. åç§°æ¨¡ç³ŠæŸ¥è¯¢
            if (searchDTO.getName() != null && !searchDTO.getName().isEmpty()) {
                predicates.add(
                    cb.like(root.get("name"), "%" + searchDTO.getName() + "%")
                );
            }
            
            // 2. ä»·æ ¼èŒƒå›´æŸ¥è¯¢
            if (searchDTO.getMinPrice() != null) {
                predicates.add(
                    cb.ge(root.get("price"), searchDTO.getMinPrice())
                );
            }
            if (searchDTO.getMaxPrice() != null) {
                predicates.add(
                    cb.le(root.get("price"), searchDTO.getMaxPrice())
                );
            }
            
            // 3. å“ç‰Œç­›é€‰
            if (searchDTO.getBrand() != null && !searchDTO.getBrand().isEmpty()) {
                predicates.add(
                    cb.equal(root.get("brand"), searchDTO.getBrand())
                );
            }
            
            // 4. åº“å­˜çŠ¶æ€ç­›é€‰
            if (searchDTO.getInStock() != null && searchDTO.getInStock()) {
                predicates.add(
                    cb.greaterThan(root.get("stock"), 0)
                );
            }
            
            // ç»„åˆæ‰€æœ‰æ¡ä»¶
            return cb.and(predicates.toArray(new Predicate[0]));
        };
        
        return productRepository.findAll(spec, pageable);
    }
}
```

**æœç´¢å‚æ•°DTO**ï¼š
```java
@Data
public class ProductSearchDTO {
    private String name;        // å•†å“åç§°ï¼ˆå¯é€‰ï¼‰
    private Double minPrice;    // æœ€ä½ä»·æ ¼ï¼ˆå¯é€‰ï¼‰
    private Double maxPrice;    // æœ€é«˜ä»·æ ¼ï¼ˆå¯é€‰ï¼‰
    private String brand;       // å“ç‰Œï¼ˆå¯é€‰ï¼‰
    private Boolean inStock;    // æ˜¯å¦æœ‰è´§ï¼ˆå¯é€‰ï¼‰
}
```

**Controllerè°ƒç”¨**ï¼š
```java
@RestController
@RequestMapping("/products")
public class ProductController {
    
    @Autowired
    private ProductService productService;
    
    @GetMapping("/search")
    public Page<Product> search(ProductSearchDTO searchDTO,
                               @RequestParam(defaultValue = "0") int page,
                               @RequestParam(defaultValue = "10") int size) {
        
        // åˆ›å»ºåˆ†é¡µå’Œæ’åºå‚æ•°
        Pageable pageable = PageRequest.of(page, size, 
                           Sort.by("createTime").descending());
        
        return productService.searchProducts(searchDTO, pageable);
    }
}
```

### 5.2 Specificationå¯é‡ç”¨è®¾è®¡


**åˆ›å»ºå¯å¤ç”¨çš„Specificationå·¥å…·ç±»**ï¼š
```java
public class ProductSpecs {
    
    // æŒ‰åç§°æ¨¡ç³ŠæŸ¥è¯¢
    public static Specification<Product> nameLike(String name) {
        return (root, query, cb) -> {
            if (name == null || name.isEmpty()) {
                return null;  // è¿”å›nullè¡¨ç¤ºä¸æ·»åŠ æ­¤æ¡ä»¶
            }
            return cb.like(root.get("name"), "%" + name + "%");
        };
    }
    
    // æŒ‰ä»·æ ¼åŒºé—´æŸ¥è¯¢
    public static Specification<Product> priceBetween(Double min, Double max) {
        return (root, query, cb) -> {
            List<Predicate> predicates = new ArrayList<>();
            if (min != null) {
                predicates.add(cb.ge(root.get("price"), min));
            }
            if (max != null) {
                predicates.add(cb.le(root.get("price"), max));
            }
            return cb.and(predicates.toArray(new Predicate[0]));
        };
    }
    
    // æŒ‰å“ç‰ŒæŸ¥è¯¢
    public static Specification<Product> brandEquals(String brand) {
        return (root, query, cb) -> {
            if (brand == null || brand.isEmpty()) {
                return null;
            }
            return cb.equal(root.get("brand"), brand);
        };
    }
    
    // æœ‰åº“å­˜çš„å•†å“
    public static Specification<Product> inStock() {
        return (root, query, cb) -> cb.greaterThan(root.get("stock"), 0);
    }
}
```

**ä½¿ç”¨Specificationç»„åˆ**ï¼š
```java
@Service
public class ProductService {
    
    public Page<Product> searchProducts(ProductSearchDTO dto, Pageable pageable) {
        // ä½¿ç”¨Specification.where()æ–¹æ³•ä¼˜é›…ç»„åˆ
        Specification<Product> spec = Specification
            .where(ProductSpecs.nameLike(dto.getName()))
            .and(ProductSpecs.priceBetween(dto.getMinPrice(), dto.getMaxPrice()))
            .and(ProductSpecs.brandEquals(dto.getBrand()))
            .and(dto.getInStock() ? ProductSpecs.inStock() : null);
        
        return productRepository.findAll(spec, pageable);
    }
}
```

**ç»„åˆä¼˜åŠ¿è¯´æ˜**ï¼š
```
ä¼ ç»Ÿæ–¹å¼ï¼š
âœ— æ‰€æœ‰é€»è¾‘å †åœ¨ä¸€ä¸ªæ–¹æ³•é‡Œ
âœ— ä»£ç é‡å¤
âœ— éš¾ä»¥ç»´æŠ¤

Specificationæ–¹å¼ï¼š
âœ“ æ¯ä¸ªæ¡ä»¶ç‹¬ç«‹å°è£…
âœ“ å¯é‡ç”¨ã€å¯ç»„åˆ
âœ“ ä»£ç æ¸…æ™°æ˜“ç»´æŠ¤
âœ“ å•å…ƒæµ‹è¯•å‹å¥½
```

---

## 6. ğŸ¯ æœ€ä½³å®è·µä¸ä¼˜åŒ–


### 6.1 ç±»å‹å®‰å…¨ä¿è¯


**é—®é¢˜åœºæ™¯**ï¼šå­—æ®µåå†™é”™å¯¼è‡´è¿è¡Œæ—¶æŠ¥é”™
```java
// ä¸å¥½çš„å†™æ³•ï¼šå­—ç¬¦ä¸²ç¡¬ç¼–ç ï¼Œå®¹æ˜“å†™é”™
Specification<Product> spec = (root, query, cb) -> {
    return cb.equal(root.get("nmae"), "iPhone");  // æ‹¼å†™é”™è¯¯ï¼
};
// è¿è¡Œæ—¶æ‰æŠ¥é”™ï¼šæ‰¾ä¸åˆ°å­—æ®µ"nmae"
```

**è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨å…ƒæ¨¡å‹ï¼ˆMetamodelï¼‰**

**æ­¥éª¤1ï¼šå¯ç”¨å…ƒæ¨¡å‹ç”Ÿæˆ**
```xml
<!-- pom.xmlæ·»åŠ ä¾èµ– -->
<dependency>
    <groupId>org.hibernate</groupId>
    <artifactId>hibernate-jpamodelgen</artifactId>
</dependency>
```

**æ­¥éª¤2ï¼šè‡ªåŠ¨ç”Ÿæˆå…ƒæ¨¡å‹ç±»**
```java
// ç¼–è¯‘åè‡ªåŠ¨ç”ŸæˆProduct_ç±»
@Generated(value = "org.hibernate.jpamodelgen.JPAMetaModelEntityProcessor")
@StaticMetamodel(Product.class)
public abstract class Product_ {
    public static volatile SingularAttribute<Product, Long> id;
    public static volatile SingularAttribute<Product, String> name;
    public static volatile SingularAttribute<Product, Double> price;
    public static volatile SingularAttribute<Product, String> brand;
    // ...
}
```

**æ­¥éª¤3ï¼šä½¿ç”¨å…ƒæ¨¡å‹ï¼ˆç¼–è¯‘æœŸç±»å‹æ£€æŸ¥ï¼‰**
```java
// ç±»å‹å®‰å…¨çš„å†™æ³•
Specification<Product> spec = (root, query, cb) -> {
    return cb.equal(root.get(Product_.name), "iPhone");
    // å¦‚æœå†™é”™å­—æ®µåï¼Œç¼–è¯‘æ—¶å°±æŠ¥é”™ï¼
};
```

**ç±»å‹å®‰å…¨å¯¹æ¯”**ï¼š
```
å­—ç¬¦ä¸²æ–¹å¼ï¼š
root.get("name")  â† è¿è¡Œæ—¶æ£€æŸ¥ï¼Œå®¹æ˜“å‡ºé”™

å…ƒæ¨¡å‹æ–¹å¼ï¼š
root.get(Product_.name)  â† ç¼–è¯‘æœŸæ£€æŸ¥ï¼Œå®‰å…¨å¯é 
```

### 6.2 ç©ºå€¼å¤„ç†æŠ€å·§


**é—®é¢˜**ï¼šæŸ¥è¯¢æ¡ä»¶ä¸ºnullæ—¶çš„å¤„ç†

**æ–¹æ¡ˆ1ï¼šåœ¨Specificationä¸­åˆ¤æ–­**
```java
public static Specification<Product> nameLike(String name) {
    return (root, query, cb) -> {
        // å¦‚æœnameä¸ºnullï¼Œè¿”å›nullè¡¨ç¤ºå¿½ç•¥æ­¤æ¡ä»¶
        if (name == null || name.isEmpty()) {
            return null;
        }
        return cb.like(root.get(Product_.name), "%" + name + "%");
    };
}
```

**æ–¹æ¡ˆ2ï¼šä½¿ç”¨OptionalåŒ…è£…**
```java
public Page<Product> search(String name, Pageable pageable) {
    Specification<Product> spec = Optional.ofNullable(name)
        .map(ProductSpecs::nameLike)
        .orElse(null);
    
    return productRepository.findAll(spec, pageable);
}
```

### 6.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ä¼˜åŒ–ç‚¹1ï¼šé¿å…N+1æŸ¥è¯¢é—®é¢˜**
```java
// ä¸å¥½ï¼šå…³è”æŸ¥è¯¢å¯èƒ½äº§ç”ŸN+1é—®é¢˜
Specification<Product> spec = (root, query, cb) -> {
    // å¦‚æœæœ‰å…³è”å¯¹è±¡ï¼Œè®°å¾—fetch
    root.fetch("category", JoinType.LEFT);  // ä¸€æ¬¡æ€§åŠ è½½å…³è”æ•°æ®
    return cb.equal(root.join("category").get("name"), "æ‰‹æœº");
};
```

**ä¼˜åŒ–ç‚¹2ï¼šåˆç†ä½¿ç”¨ç´¢å¼•**
```java
@Entity
@Table(indexes = {
    @Index(name = "idx_name", columnList = "name"),      // ä¸ºå¸¸æŸ¥å­—æ®µå»ºç´¢å¼•
    @Index(name = "idx_brand", columnList = "brand"),
    @Index(name = "idx_price", columnList = "price")
})
public class Product {
    // ...
}
```

**ä¼˜åŒ–ç‚¹3ï¼šåˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–**
```java
// å¤§æ•°æ®é‡æ—¶é¿å…countæŸ¥è¯¢
Page<Product> page = productRepository.findAll(spec, pageable);

// å¦‚æœä¸éœ€è¦æ€»æ•°ï¼Œå¯ä»¥ç”¨Slice
Slice<Product> slice = productRepository.findAll(spec, pageable);
// Sliceä¸æ‰§è¡ŒcountæŸ¥è¯¢ï¼Œæ€§èƒ½æ›´å¥½
```

### 6.4 å¸¸è§é™·é˜±é¿å…


**é™·é˜±1ï¼šå¿˜è®°å¤„ç†nullå€¼**
```java
// âŒ é”™è¯¯ï¼šdto.getName()å¯èƒ½ä¸ºnull
predicates.add(cb.like(root.get(Product_.name), "%" + dto.getName() + "%"));

// âœ… æ­£ç¡®ï¼šå…ˆåˆ¤æ–­null
if (dto.getName() != null && !dto.getName().isEmpty()) {
    predicates.add(cb.like(root.get(Product_.name), "%" + dto.getName() + "%"));
}
```

**é™·é˜±2ï¼šæ¡ä»¶ç»„åˆé€»è¾‘é”™è¯¯**
```java
// âŒ é”™è¯¯ï¼šç©ºPredicateæ•°ç»„
List<Predicate> predicates = new ArrayList<>();
return cb.and(predicates.toArray(new Predicate[0]));  // å¦‚æœåˆ—è¡¨ä¸ºç©ºä¼šæŠ¥é”™

// âœ… æ­£ç¡®ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºç©º
if (predicates.isEmpty()) {
    return null;  // æˆ–è€…è¿”å›ä¸€ä¸ªæ°¸çœŸæ¡ä»¶
}
return cb.and(predicates.toArray(new Predicate[0]));
```

**é™·é˜±3ï¼šå…³è”æŸ¥è¯¢é‡å¤join**
```java
// âŒ é”™è¯¯ï¼šå¤šæ¬¡joinåŒä¸€ä¸ªå…³è”
cb.equal(root.join("category").get("name"), "æ‰‹æœº");
cb.equal(root.join("category").get("status"), "ACTIVE");  // åˆjoinäº†ä¸€æ¬¡

// âœ… æ­£ç¡®ï¼šå¤ç”¨joinå¯¹è±¡
Join<Product, Category> categoryJoin = root.join("category");
cb.equal(categoryJoin.get("name"), "æ‰‹æœº");
cb.equal(categoryJoin.get("status"), "ACTIVE");
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ JpaSpecificationExecutorï¼šè®©Repositoryå…·å¤‡SpecificationæŸ¥è¯¢èƒ½åŠ›
ğŸ”¸ Specificationæ¥å£ï¼šå®šä¹‰æŸ¥è¯¢è§„åˆ™çš„å‡½æ•°å¼æ¥å£
ğŸ”¸ Rootï¼šä»£è¡¨æŸ¥è¯¢çš„æ ¹å¯¹è±¡ï¼Œç”¨äºè·å–å®ä½“å­—æ®µ
ğŸ”¸ CriteriaBuilderï¼šæ¡ä»¶æ„å»ºå™¨ï¼Œæä¾›å„ç§æŸ¥è¯¢æ¡ä»¶æ–¹æ³•
ğŸ”¸ Predicateï¼šæŸ¥è¯¢è°“è¯ï¼Œä»£è¡¨ä¸€ä¸ªå…·ä½“çš„æŸ¥è¯¢æ¡ä»¶
ğŸ”¸ åŠ¨æ€ç»„åˆï¼šæ ¹æ®å®é™…éœ€æ±‚çµæ´»ç»„è£…æŸ¥è¯¢æ¡ä»¶
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**Specificationçš„æœ¬è´¨**ï¼š
```
ä¼ ç»Ÿå›ºå®šæŸ¥è¯¢ï¼š
WHERE name = 'æ‰‹æœº' AND price > 1000
â†‘ æ¡ä»¶å›ºå®šï¼Œä¸çµæ´»

SpecificationåŠ¨æ€æŸ¥è¯¢ï¼š
WHERE
  (name = 'æ‰‹æœº' IF nameä¸ä¸ºnull)
  AND (price > 1000 IF minPriceä¸ä¸ºnull)
  AND (brand = 'åä¸º' IF brandä¸ä¸ºnull)
â†‘ æ¡ä»¶åŠ¨æ€ï¼ŒæŒ‰éœ€ç»„åˆ
```

**ä¸‰ä¸ªæ ¸å¿ƒå‚æ•°çš„ä½œç”¨**ï¼š
```
Root (ä»å“ªæŸ¥)ï¼š
- æŒ‡å®šå®ä½“ç±»
- è·å–å­—æ®µä¿¡æ¯
- å¤„ç†å…³è”å…³ç³»

CriteriaQuery (æ€ä¹ˆæŸ¥)ï¼š
- å®šä¹‰æŸ¥è¯¢ç»“æ„
- è®¾ç½®æ’åºåˆ†ç»„
- æŒ‡å®šè¿”å›ç±»å‹

CriteriaBuilder (æŸ¥ä»€ä¹ˆ)ï¼š
- æ„å»ºæŸ¥è¯¢æ¡ä»¶
- ç»„åˆé€»è¾‘è¿ç®—
- ç”ŸæˆPredicate
```

### 7.3 å®æˆ˜å¼€å‘å»ºè®®


**å¼€å‘æ­¥éª¤**ï¼š
```
1. Repositoryç»§æ‰¿JpaSpecificationExecutor
   â†“
2. åˆ›å»ºSpecificationå·¥å…·ç±»å°è£…å¸¸ç”¨æ¡ä»¶
   â†“
3. Serviceå±‚ç»„åˆSpecificationå®Œæˆä¸šåŠ¡é€»è¾‘
   â†“
4. é…åˆåˆ†é¡µã€æ’åºæå‡ç”¨æˆ·ä½“éªŒ
   â†“
5. ä½¿ç”¨å…ƒæ¨¡å‹ä¿è¯ç±»å‹å®‰å…¨
```

**é€‚ç”¨åœºæ™¯åˆ¤æ–­**ï¼š
```
âœ… é€‚åˆç”¨Specificationï¼š
- æœç´¢åŠŸèƒ½ï¼ˆå¤šæ¡ä»¶å¯é€‰ï¼‰
- å¤æ‚ç­›é€‰ï¼ˆæ¡ä»¶åŠ¨æ€ç»„åˆï¼‰
- é«˜çº§æŸ¥è¯¢ï¼ˆå…³è”ã€åˆ†ç»„ã€èšåˆï¼‰

âŒ ä¸é€‚åˆç”¨Specificationï¼š
- ç®€å•å›ºå®šæŸ¥è¯¢ï¼ˆç”¨æ–¹æ³•å‘½åæŸ¥è¯¢ï¼‰
- é«˜æ€§èƒ½åœºæ™¯ï¼ˆè€ƒè™‘åŸç”ŸSQLï¼‰
- ç»Ÿè®¡æŠ¥è¡¨ï¼ˆç”¨@Queryæ›´ç›´è§‚ï¼‰
```

### 7.4 è®°å¿†è¦ç‚¹


**æ ¸å¿ƒAPIè®°å¿†**ï¼š
```
ç›¸ç­‰åˆ¤æ–­ï¼šcb.equal(å­—æ®µ, å€¼)
å¤§å°æ¯”è¾ƒï¼šcb.gt/ge/lt/le(å­—æ®µ, å€¼)
æ¨¡ç³ŠæŸ¥è¯¢ï¼šcb.like(å­—æ®µ, "%å€¼%")
åŒºé—´èŒƒå›´ï¼šcb.between(å­—æ®µ, æœ€å°å€¼, æœ€å¤§å€¼)
ç©ºå€¼åˆ¤æ–­ï¼šcb.isNull/isNotNull(å­—æ®µ)

é€»è¾‘ç»„åˆï¼š
- ANDï¼šcb.and(æ¡ä»¶1, æ¡ä»¶2)
- ORï¼šcb.or(æ¡ä»¶1, æ¡ä»¶2)
- NOTï¼šcb.not(æ¡ä»¶)
```

**æœ€ä½³å®è·µå£è¯€**ï¼š
```
æ¡ä»¶å°è£…å¯é‡ç”¨ï¼Œ
åŠ¨æ€ç»„åˆæ›´çµæ´»ï¼Œ
ç©ºå€¼åˆ¤æ–­è¦è®°ç‰¢ï¼Œ
å…ƒæ¨¡å‹ä¿ç±»å‹ï¼Œ
æ€§èƒ½ä¼˜åŒ–åˆ«å¿˜è®°ï¼Œ
ç´¢å¼•åˆ†é¡µææ•ˆç‡ã€‚
```