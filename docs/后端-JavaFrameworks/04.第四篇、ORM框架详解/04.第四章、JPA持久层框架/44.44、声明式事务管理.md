---
title: 44ã€å£°æ˜å¼äº‹åŠ¡ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯å£°æ˜å¼äº‹åŠ¡](#1-ä»€ä¹ˆæ˜¯å£°æ˜å¼äº‹åŠ¡)
2. [@Transactionalæ³¨è§£è¯¦è§£](#2-transactionalæ³¨è§£è¯¦è§£)
3. [äº‹åŠ¡ä¼ æ’­è¡Œä¸º](#3-äº‹åŠ¡ä¼ æ’­è¡Œä¸º)
4. [äº‹åŠ¡å›æ»šè§„åˆ™](#4-äº‹åŠ¡å›æ»šè§„åˆ™)
5. [äº‹åŠ¡ä¼˜åŒ–æŠ€å·§](#5-äº‹åŠ¡ä¼˜åŒ–æŠ€å·§)
6. [äº‹åŠ¡ç®¡ç†å™¨é…ç½®](#6-äº‹åŠ¡ç®¡ç†å™¨é…ç½®)
7. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#7-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯å£°æ˜å¼äº‹åŠ¡


### 1.1 å…ˆä»ç”Ÿæ´»ä¾‹å­ç†è§£äº‹åŠ¡


**ç”Ÿæ´»ä¸­çš„äº‹åŠ¡åœºæ™¯**ï¼š
```
ç½‘è´­ä»˜æ¬¾è¿‡ç¨‹ = ä¸€ä¸ªäº‹åŠ¡
ç¬¬1æ­¥ï¼šæ‰£é™¤è´¦æˆ·ä½™é¢
ç¬¬2æ­¥ï¼šå¢åŠ å•†å®¶æ”¶å…¥
ç¬¬3æ­¥ï¼šç”Ÿæˆè®¢å•è®°å½•
ç¬¬4æ­¥ï¼šæ‰£å‡åº“å­˜

è¦ä¹ˆï¼šå…¨éƒ¨æˆåŠŸ âœ…
è¦ä¹ˆï¼šå…¨éƒ¨å›æ»š âŒï¼ˆä»»ä½•ä¸€æ­¥å¤±è´¥éƒ½è¦å…¨éƒ¨æ’¤é”€ï¼‰
```

è¿™å°±æ˜¯**äº‹åŠ¡çš„æœ¬è´¨**ï¼šä¸€ç»„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸ,è¦ä¹ˆå…¨éƒ¨å¤±è´¥,ä¸èƒ½åªåšä¸€åŠã€‚

### 1.2 ä»€ä¹ˆæ˜¯å£°æ˜å¼äº‹åŠ¡


**é€šä¿—ç†è§£**ï¼š
- **ç¼–ç¨‹å¼äº‹åŠ¡**ï¼šå°±åƒä½ è‡ªå·±æ‰‹åŠ¨å¼€è½¦,æ²¹é—¨åˆ¹è½¦éƒ½è¦è‡ªå·±æ§åˆ¶
- **å£°æ˜å¼äº‹åŠ¡**ï¼šå°±åƒåå‡ºç§Ÿè½¦,ä½ åªéœ€è¦å‘Šè¯‰å¸æœºå»å“ª,å‰©ä¸‹çš„éƒ½ä¸ç”¨ç®¡

**æŠ€æœ¯è§’åº¦ç†è§£**ï¼š
```
å£°æ˜å¼äº‹åŠ¡ = ç”¨æ³¨è§£æ ‡è®° + Springè‡ªåŠ¨ç®¡ç†

ä½ åªéœ€è¦ï¼šåœ¨æ–¹æ³•ä¸ŠåŠ ä¸ª @Transactional æ³¨è§£
Springå¸®ä½ ï¼šå¼€å¯äº‹åŠ¡ â†’ æ‰§è¡Œä¸šåŠ¡ â†’ æäº¤/å›æ»š
```

### 1.3 ä¸ºä»€ä¹ˆè¦ç”¨å£°æ˜å¼äº‹åŠ¡


**å¯¹æ¯”ä¸¤ç§æ–¹å¼**ï¼š

| ç»´åº¦ | **ç¼–ç¨‹å¼äº‹åŠ¡** | **å£°æ˜å¼äº‹åŠ¡** |
|------|--------------|--------------|
| **ä»£ç é‡** | ğŸ˜° å¤§é‡é‡å¤ä»£ç  | ğŸ˜Š åªéœ€ä¸€ä¸ªæ³¨è§£ |
| **å¯ç»´æŠ¤æ€§** | ğŸ˜“ ä¸šåŠ¡ä»£ç å’Œäº‹åŠ¡ä»£ç æ··åœ¨ä¸€èµ· | ğŸ˜ƒ ä¸šåŠ¡ä»£ç æ¸…æ™° |
| **æ˜“é”™æ€§** | ğŸ˜± å®¹æ˜“å¿˜è®°æäº¤æˆ–å›æ»š | ğŸ˜Œ Springè‡ªåŠ¨å¤„ç† |
| **å­¦ä¹ æˆæœ¬** | ğŸ“ˆ éœ€è¦ç†è§£äº‹åŠ¡API | ğŸ“‰ ç†è§£æ³¨è§£å³å¯ |

**å®é™…å¯¹æ¯”**ï¼š
```java
// âŒ ç¼–ç¨‹å¼äº‹åŠ¡ - ä»£ç ç¹ç
public void transfer(Long fromId, Long toId, BigDecimal amount) {
    TransactionStatus status = txManager.getTransaction(new DefaultTransactionDefinition());
    try {
        // ä¸šåŠ¡ä»£ç 
        accountDao.deduct(fromId, amount);
        accountDao.add(toId, amount);
        
        txManager.commit(status);  // æ‰‹åŠ¨æäº¤
    } catch (Exception e) {
        txManager.rollback(status);  // æ‰‹åŠ¨å›æ»š
        throw e;
    }
}

// âœ… å£°æ˜å¼äº‹åŠ¡ - ç®€æ´æ¸…æ™°
@Transactional
public void transfer(Long fromId, Long toId, BigDecimal amount) {
    // åªå…³æ³¨ä¸šåŠ¡é€»è¾‘
    accountDao.deduct(fromId, amount);
    accountDao.add(toId, amount);
    // Springè‡ªåŠ¨æäº¤æˆ–å›æ»š
}
```

---

## 2. ğŸ“ @Transactionalæ³¨è§£è¯¦è§£


### 2.1 æ³¨è§£å¯ä»¥åŠ åœ¨å“ªé‡Œ


**ä¸‰ä¸ªä½ç½®éƒ½å¯ä»¥ç”¨**ï¼š
```
1ï¸âƒ£ ç±»ä¸Šï¼šæ•´ä¸ªç±»çš„æ‰€æœ‰publicæ–¹æ³•éƒ½æœ‰äº‹åŠ¡
2ï¸âƒ£ æ–¹æ³•ä¸Šï¼šåªæœ‰è¿™ä¸ªæ–¹æ³•æœ‰äº‹åŠ¡
3ï¸âƒ£ æ¥å£ä¸Šï¼šå®ç°ç±»ç»§æ‰¿äº‹åŠ¡é…ç½®ï¼ˆä¸æ¨èï¼‰
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// æ–¹å¼1ï¼šåŠ åœ¨ç±»ä¸Š - æ‰€æœ‰æ–¹æ³•éƒ½æœ‰äº‹åŠ¡
@Service
@Transactional
public class UserService {
    public void createUser(User user) { }
    public void updateUser(User user) { }
    public void deleteUser(Long id) { }
}

// æ–¹å¼2ï¼šåŠ åœ¨æ–¹æ³•ä¸Š - åªæœ‰è¿™ä¸ªæ–¹æ³•æœ‰äº‹åŠ¡
@Service
public class UserService {
    @Transactional
    public void createUser(User user) { }
    
    // è¿™ä¸ªæ–¹æ³•æ²¡æœ‰äº‹åŠ¡
    public User findUser(Long id) { }
}

// æ–¹å¼3ï¼šæ··åˆä½¿ç”¨ - ç±»é»˜è®¤é…ç½® + æ–¹æ³•ç‰¹æ®Šé…ç½®
@Service
@Transactional(readOnly = true)  // é»˜è®¤åªè¯»
public class UserService {
    // ç»§æ‰¿ç±»çš„åªè¯»äº‹åŠ¡
    public User findUser(Long id) { }
    
    // è¦†ç›–ä¸ºå¯å†™äº‹åŠ¡
    @Transactional(readOnly = false)
    public void createUser(User user) { }
}
```

### 2.2 æ³¨è§£çš„æ ¸å¿ƒå±æ€§


**@Transactionalçš„é‡è¦é…ç½®é¡¹**ï¼š

| å±æ€§ | **ä½œç”¨** | **å¸¸ç”¨å€¼** | **é€šä¿—ç†è§£** |
|------|---------|----------|------------|
| `propagation` | ä¼ æ’­è¡Œä¸º | REQUIRED, REQUIRES_NEW | é‡åˆ°å·²æœ‰äº‹åŠ¡æ€ä¹ˆåŠ |
| `isolation` | éš”ç¦»çº§åˆ« | READ_COMMITTED | äº‹åŠ¡é—´äº’ç›¸å½±å“ç¨‹åº¦ |
| `timeout` | è¶…æ—¶æ—¶é—´ | 30(ç§’) | æ‰§è¡Œå¤ªä¹…å°±å›æ»š |
| `readOnly` | åªè¯»æ ‡è®° | true/false | åªæŸ¥è¯¢ä¸ä¿®æ”¹ |
| `rollbackFor` | å›æ»šå¼‚å¸¸ | Exception.class | é‡åˆ°è¿™äº›å¼‚å¸¸å°±å›æ»š |

**å®Œæ•´é…ç½®ç¤ºä¾‹**ï¼š
```java
@Transactional(
    propagation = Propagation.REQUIRED,      // å¿…é¡»æœ‰äº‹åŠ¡
    isolation = Isolation.READ_COMMITTED,    // è¯»å·²æäº¤
    timeout = 30,                            // 30ç§’è¶…æ—¶
    readOnly = false,                        // å¯å†™äº‹åŠ¡
    rollbackFor = Exception.class            // æ‰€æœ‰å¼‚å¸¸éƒ½å›æ»š
)
public void processOrder(Order order) {
    // ä¸šåŠ¡é€»è¾‘
}
```

---

## 3. ğŸ”„ äº‹åŠ¡ä¼ æ’­è¡Œä¸º


### 3.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ä¼ æ’­è¡Œä¸º


**ç”Ÿæ´»åœºæ™¯ç†è§£**ï¼š
```
ä½ åœ¨å¼€è½¦ï¼ˆå¤–å±‚äº‹åŠ¡ï¼‰
æœ‹å‹è¦ä¸Šè½¦ï¼ˆå†…å±‚æ–¹æ³•ï¼‰

é—®é¢˜ï¼šæœ‹å‹ä¸Šè½¦åæ€ä¹ˆç®—ï¼Ÿ
- å’Œä½ ä¸€èµ·åä½ çš„è½¦ï¼Ÿï¼ˆREQUIRED - åŠ å…¥ç°æœ‰äº‹åŠ¡ï¼‰
- è‡ªå·±å¦å¤–æ‰“è½¦ï¼Ÿï¼ˆREQUIRES_NEW - æ–°å¼€äº‹åŠ¡ï¼‰
- å°±åœ¨è·¯è¾¹ç­‰ä½ ï¼Ÿï¼ˆNOT_SUPPORTED - ä¸è¦äº‹åŠ¡ï¼‰
```

è¿™å°±æ˜¯**ä¼ æ’­è¡Œä¸º**ï¼šæ–¹æ³•è°ƒç”¨æ—¶,æ–°æ–¹æ³•çš„äº‹åŠ¡å’Œæ—§äº‹åŠ¡å¦‚ä½•é…åˆã€‚

### 3.2 ä¸ƒç§ä¼ æ’­è¡Œä¸ºè¯¦è§£


**ğŸ”¸ REQUIREDï¼ˆæœ€å¸¸ç”¨ï¼‰**
```
å«ä¹‰ï¼šå¿…é¡»æœ‰äº‹åŠ¡
è§„åˆ™ï¼š
- å¦‚æœå¤–å±‚æœ‰äº‹åŠ¡ â†’ åŠ å…¥å¤–å±‚äº‹åŠ¡
- å¦‚æœå¤–å±‚æ²¡äº‹åŠ¡ â†’ è‡ªå·±æ–°å»ºäº‹åŠ¡

åœºæ™¯ï¼š99%çš„ä¸šåŠ¡æ–¹æ³•ç”¨è¿™ä¸ª
```

```java
@Transactional(propagation = Propagation.REQUIRED)
public void methodA() {
    // ... ä¸šåŠ¡ä»£ç 
    methodB();  // BåŠ å…¥Açš„äº‹åŠ¡
}

@Transactional(propagation = Propagation.REQUIRED)
public void methodB() {
    // å’ŒmethodAåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­
}
```

**ğŸ”¸ REQUIRES_NEWï¼ˆæ–°å»ºç‹¬ç«‹äº‹åŠ¡ï¼‰**
```
å«ä¹‰ï¼šå¿…é¡»æ–°å»ºäº‹åŠ¡
è§„åˆ™ï¼š
- æŒ‚èµ·å¤–å±‚äº‹åŠ¡
- æ–°å»ºè‡ªå·±çš„äº‹åŠ¡
- æ‰§è¡Œå®Œæ¢å¤å¤–å±‚äº‹åŠ¡

åœºæ™¯ï¼šè®°å½•æ—¥å¿—ã€å‘é€é€šçŸ¥ç­‰ç‹¬ç«‹æ“ä½œ
```

```java
// è®¢å•å¤„ç†
@Transactional
public void createOrder(Order order) {
    orderDao.save(order);
    
    // è®°å½•æ—¥å¿— - ä¸å—è®¢å•äº‹åŠ¡å½±å“
    logService.saveLog(log);  // ç”¨REQUIRES_NEW
    
    // å¦‚æœåé¢æŠ›å¼‚å¸¸,è®¢å•å›æ»š,ä½†æ—¥å¿—å·²ä¿å­˜
}

// æ—¥å¿—æœåŠ¡
@Transactional(propagation = Propagation.REQUIRES_NEW)
public void saveLog(Log log) {
    logDao.save(log);
}
```

**ğŸ”¸ NESTEDï¼ˆåµŒå¥—äº‹åŠ¡ï¼‰**
```
å«ä¹‰ï¼šåµŒå¥—åœ¨å¤–å±‚äº‹åŠ¡ä¸­
è§„åˆ™ï¼š
- æœ‰å¤–å±‚äº‹åŠ¡ â†’ åˆ›å»ºä¿å­˜ç‚¹,å‡ºé”™å¯ä»¥å›æ»šåˆ°ä¿å­˜ç‚¹
- æ— å¤–å±‚äº‹åŠ¡ â†’ ç­‰åŒäºREQUIRED

åœºæ™¯ï¼šéƒ¨åˆ†å¤±è´¥ä¸å½±å“æ•´ä½“
```

```java
@Transactional
public void batchImport(List<User> users) {
    for (User user : users) {
        try {
            // å•ä¸ªç”¨æˆ·å¯¼å…¥å¤±è´¥ä¸å½±å“å…¶ä»–
            importUser(user);  // ç”¨NESTED
        } catch (Exception e) {
            log.error("å¯¼å…¥å¤±è´¥: " + user.getName());
        }
    }
}

@Transactional(propagation = Propagation.NESTED)
public void importUser(User user) {
    userDao.save(user);
}
```

**ğŸ“Š ä¼ æ’­è¡Œä¸ºå¯¹æ¯”è¡¨**

| ä¼ æ’­è¡Œä¸º | **å¤–å±‚æœ‰äº‹åŠ¡** | **å¤–å±‚æ— äº‹åŠ¡** | **ä½¿ç”¨åœºæ™¯** |
|---------|--------------|--------------|------------|
| **REQUIRED** | åŠ å…¥å¤–å±‚äº‹åŠ¡ | æ–°å»ºäº‹åŠ¡ | ğŸŒŸ é»˜è®¤é€‰æ‹©,99%åœºæ™¯ |
| **REQUIRES_NEW** | æŒ‚èµ·å¤–å±‚,æ–°å»ºäº‹åŠ¡ | æ–°å»ºäº‹åŠ¡ | æ—¥å¿—ã€é€šçŸ¥ç­‰ç‹¬ç«‹æ“ä½œ |
| **NESTED** | åµŒå¥—äº‹åŠ¡(ä¿å­˜ç‚¹) | æ–°å»ºäº‹åŠ¡ | æ‰¹å¤„ç†ã€éƒ¨åˆ†å¤±è´¥å…è®¸ |
| **SUPPORTS** | åŠ å…¥å¤–å±‚äº‹åŠ¡ | æ— äº‹åŠ¡æ‰§è¡Œ | æŸ¥è¯¢æ–¹æ³• |
| **NOT_SUPPORTED** | æŒ‚èµ·å¤–å±‚äº‹åŠ¡ | æ— äº‹åŠ¡æ‰§è¡Œ | ä¸éœ€è¦äº‹åŠ¡çš„æ“ä½œ |
| **MANDATORY** | åŠ å…¥å¤–å±‚äº‹åŠ¡ | âŒ æŠ›å¼‚å¸¸ | å¿…é¡»åœ¨äº‹åŠ¡ä¸­è°ƒç”¨ |
| **NEVER** | âŒ æŠ›å¼‚å¸¸ | æ— äº‹åŠ¡æ‰§è¡Œ | ç»ä¸èƒ½åœ¨äº‹åŠ¡ä¸­ |

### 3.3 ä¼ æ’­è¡Œä¸ºæµç¨‹å›¾


```
è°ƒç”¨æµç¨‹ç¤ºä¾‹ï¼š

methodA() [REQUIRED]
    |
    â”œâ”€â†’ methodB() [REQUIRED]      â†’ åŠ å…¥Açš„äº‹åŠ¡
    |
    â”œâ”€â†’ methodC() [REQUIRES_NEW]  â†’ æ–°å»ºç‹¬ç«‹äº‹åŠ¡
    |       |
    |       â””â”€â†’ å®Œæˆåæ¢å¤Açš„äº‹åŠ¡
    |
    â””â”€â†’ methodD() [NESTED]        â†’ åˆ›å»ºä¿å­˜ç‚¹
            |
            â””â”€â†’ å¤±è´¥å›æ»šåˆ°ä¿å­˜ç‚¹,Aç»§ç»­
```

---

## 4. â†©ï¸ äº‹åŠ¡å›æ»šè§„åˆ™


### 4.1 é»˜è®¤å›æ»šè§„åˆ™


**Springçš„é»˜è®¤è¡Œä¸º**ï¼š
```
âœ… RuntimeExceptionï¼ˆè¿è¡Œæ—¶å¼‚å¸¸ï¼‰ â†’ è‡ªåŠ¨å›æ»š
âœ… Errorï¼ˆé”™è¯¯ï¼‰                  â†’ è‡ªåŠ¨å›æ»š
âŒ CheckedExceptionï¼ˆå—æ£€å¼‚å¸¸ï¼‰    â†’ ä¸å›æ»š
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡**ï¼Ÿ
```
è¿è¡Œæ—¶å¼‚å¸¸ï¼šé€šå¸¸æ˜¯ä»£ç bug,åº”è¯¥å›æ»š
  ä¾‹å¦‚ï¼šNullPointerExceptionã€IllegalArgumentException

å—æ£€å¼‚å¸¸ï¼šé€šå¸¸æ˜¯ä¸šåŠ¡å¼‚å¸¸,å¯èƒ½éœ€è¦éƒ¨åˆ†æäº¤
  ä¾‹å¦‚ï¼šIOExceptionã€SQLException
```

### 4.2 è‡ªå®šä¹‰å›æ»šè§„åˆ™


**ä¸‰ç§è‡ªå®šä¹‰æ–¹å¼**ï¼š

```java
// æ–¹å¼1ï¼šrollbackFor - æŒ‡å®šå›æ»šå¼‚å¸¸ï¼ˆæœ€å¸¸ç”¨ï¼‰
@Transactional(rollbackFor = Exception.class)
public void method1() {
    // æ‰€æœ‰å¼‚å¸¸éƒ½å›æ»š
}

// æ–¹å¼2ï¼šnoRollbackFor - æŒ‡å®šä¸å›æ»šå¼‚å¸¸
@Transactional(noRollbackFor = BusinessException.class)
public void method2() {
    // ä¸šåŠ¡å¼‚å¸¸ä¸å›æ»š,å…¶ä»–å¼‚å¸¸å›æ»š
}

// æ–¹å¼3ï¼šç»„åˆä½¿ç”¨
@Transactional(
    rollbackFor = Exception.class,
    noRollbackFor = {ValidationException.class, DuplicateException.class}
)
public void method3() {
    // é™¤äº†éªŒè¯å¼‚å¸¸å’Œé‡å¤å¼‚å¸¸,å…¶ä»–éƒ½å›æ»š
}
```

### 4.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ¯ åœºæ™¯1ï¼šé“¶è¡Œè½¬è´¦ - æ‰€æœ‰å¼‚å¸¸å¿…é¡»å›æ»š**
```java
@Transactional(rollbackFor = Exception.class)
public void transfer(Long fromId, Long toId, BigDecimal amount) {
    accountDao.deduct(fromId, amount);    // æ‰£æ¬¾
    accountDao.add(toId, amount);         // åŠ æ¬¾
    
    // ä»»ä½•å¼‚å¸¸éƒ½å¿…é¡»å›æ»š,ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
}
```

**ğŸ¯ åœºæ™¯2ï¼šç”¨æˆ·æ³¨å†Œ - ä¸šåŠ¡å¼‚å¸¸ä¸å›æ»š**
```java
@Transactional(
    rollbackFor = Exception.class,
    noRollbackFor = DuplicateUserException.class
)
public void register(User user) {
    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦é‡å¤
    if (userDao.existsByUsername(user.getUsername())) {
        // è¿™ä¸ªå¼‚å¸¸ä¸å›æ»š,å› ä¸ºæ˜¯æ­£å¸¸ä¸šåŠ¡åˆ¤æ–­
        throw new DuplicateUserException("ç”¨æˆ·åå·²å­˜åœ¨");
    }
    
    userDao.save(user);
    // å…¶ä»–å¼‚å¸¸å›æ»š
}
```

**ğŸ¯ åœºæ™¯3ï¼šæ‰¹é‡æ“ä½œ - éƒ¨åˆ†å¤±è´¥ç»§ç»­**
```java
@Transactional
public void batchProcess(List<Item> items) {
    for (Item item : items) {
        try {
            processItem(item);
        } catch (BusinessException e) {
            // å•ä¸ªå¤±è´¥è®°å½•æ—¥å¿—,ç»§ç»­å¤„ç†
            log.error("å¤„ç†å¤±è´¥: {}", item.getId(), e);
        } catch (Exception e) {
            // ç³»ç»Ÿå¼‚å¸¸åˆ™å…¨éƒ¨å›æ»š
            throw e;
        }
    }
}
```

### 4.4 æ‰‹åŠ¨æ§åˆ¶å›æ»š


**æœ‰æ—¶å€™éœ€è¦æ‰‹åŠ¨å†³å®šå›æ»š**ï¼š
```java
@Transactional
public void complexOperation() {
    try {
        // ä¸šåŠ¡æ“ä½œ
        doSomething();
        
    } catch (BusinessException e) {
        // æ ¹æ®ä¸šåŠ¡è§„åˆ™å†³å®šæ˜¯å¦å›æ»š
        if (e.needRollback()) {
            TransactionAspectSupport.currentTransactionStatus()
                .setRollbackOnly();  // æ‰‹åŠ¨æ ‡è®°å›æ»š
        }
    }
}
```

---

## 5. âš¡ äº‹åŠ¡ä¼˜åŒ–æŠ€å·§


### 5.1 åªè¯»äº‹åŠ¡ä¼˜åŒ–


**ä»€ä¹ˆæ˜¯åªè¯»äº‹åŠ¡**ï¼Ÿ
```
åªè¯»äº‹åŠ¡ = åªæŸ¥è¯¢æ•°æ®,ä¸ä¿®æ”¹æ•°æ®çš„äº‹åŠ¡

å¥½å¤„ï¼š
âœ… æ•°æ®åº“å¯ä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
âœ… æŸäº›æ•°æ®åº“ä¸åŠ é”
âœ… æç¤ºå¼€å‘è€…è¿™æ˜¯æŸ¥è¯¢æ–¹æ³•
```

**ä½¿ç”¨æ–¹æ³•**ï¼š
```java
// æŸ¥è¯¢æ–¹æ³•æ ‡è®°ä¸ºåªè¯»
@Transactional(readOnly = true)
public User findUserById(Long id) {
    return userDao.findById(id);
}

// åˆ—è¡¨æŸ¥è¯¢ä¹Ÿç”¨åªè¯»
@Transactional(readOnly = true)
public List<User> findAllUsers() {
    return userDao.findAll();
}

// ç±»çº§åˆ«é»˜è®¤åªè¯»,ä¸ªåˆ«æ–¹æ³•å¯å†™
@Service
@Transactional(readOnly = true)
public class UserService {
    
    // ç»§æ‰¿åªè¯»
    public User findUser(Long id) { }
    
    // è¦†ç›–ä¸ºå¯å†™
    @Transactional(readOnly = false)
    public void createUser(User user) { }
}
```

### 5.2 è®¾ç½®è¶…æ—¶æ—¶é—´


**ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶**ï¼Ÿ
```
é˜²æ­¢åœºæ™¯ï¼š
âŒ SQLæ‰§è¡Œå¤ªæ…¢,å ç”¨è¿æ¥
âŒ æ­»é”å¯¼è‡´ä¸€ç›´ç­‰å¾…
âŒ ç½‘ç»œé—®é¢˜å¯¼è‡´æŒ‚èµ·

è§£å†³æ–¹æ¡ˆï¼šè®¾ç½®è¶…æ—¶è‡ªåŠ¨å›æ»š
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// è®¾ç½®30ç§’è¶…æ—¶
@Transactional(timeout = 30)
public void longRunningOperation() {
    // å¦‚æœ30ç§’è¿˜æ²¡å®Œæˆ,è‡ªåŠ¨å›æ»š
}

// ä¸åŒæ“ä½œä¸åŒè¶…æ—¶
@Transactional(timeout = 5)  // å¿«é€Ÿæ“ä½œ5ç§’
public void quickOperation() { }

@Transactional(timeout = 300)  // æ‰¹é‡æ“ä½œ5åˆ†é’Ÿ
public void batchOperation() { }
```

### 5.3 äº‹åŠ¡èŒƒå›´æœ€å°åŒ–


**åŸåˆ™ï¼šäº‹åŠ¡è¶Šå°è¶Šå¥½**

```java
// âŒ ä¸å¥½çš„åšæ³• - äº‹åŠ¡èŒƒå›´å¤ªå¤§
@Transactional
public void processOrder(Order order) {
    // æŸ¥è¯¢æ“ä½œä¸éœ€è¦äº‹åŠ¡
    Product product = productService.findById(order.getProductId());
    
    // å¤æ‚è®¡ç®—ä¸éœ€è¦äº‹åŠ¡
    BigDecimal discount = calculateDiscount(order);
    
    // è°ƒç”¨å¤–éƒ¨æœåŠ¡ä¸éœ€è¦äº‹åŠ¡
    paymentService.notify(order);
    
    // åªæœ‰è¿™é‡Œéœ€è¦äº‹åŠ¡
    orderDao.save(order);
}

// âœ… å¥½çš„åšæ³• - äº‹åŠ¡åªåŒ…å«å¿…è¦æ“ä½œ
public void processOrder(Order order) {
    // æŸ¥è¯¢
    Product product = productService.findById(order.getProductId());
    
    // è®¡ç®—
    BigDecimal discount = calculateDiscount(order);
    
    // åªåœ¨ä¿å­˜æ—¶å¼€å¯äº‹åŠ¡
    saveOrder(order);
    
    // å¤–éƒ¨é€šçŸ¥
    paymentService.notify(order);
}

@Transactional
private void saveOrder(Order order) {
    orderDao.save(order);
}
```

### 5.4 é¿å…äº‹åŠ¡åµŒå¥—è¿‡æ·±


**åµŒå¥—å¤ªæ·±çš„é—®é¢˜**ï¼š
```
é—®é¢˜ï¼š
âŒ äº‹åŠ¡æ—¶é—´å˜é•¿
âŒ é”æŒæœ‰æ—¶é—´å¢åŠ 
âŒ å®¹æ˜“è¶…æ—¶
âŒ éš¾ä»¥è°ƒè¯•

åŸåˆ™ï¼š
âœ… äº‹åŠ¡æ–¹æ³•è°ƒç”¨äº‹åŠ¡æ–¹æ³• â‰¤ 3å±‚
âœ… å¤æ‚ä¸šåŠ¡æ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹äº‹åŠ¡
```

**ä¼˜åŒ–ç¤ºä¾‹**ï¼š
```java
// âŒ åµŒå¥—å¤ªæ·±
@Transactional
public void level1() {
    level2();
}

@Transactional
public void level2() {
    level3();
}

@Transactional
public void level3() {
    level4();  // å¤ªæ·±äº†!
}

// âœ… æ‹†åˆ†ä¸ºç‹¬ç«‹äº‹åŠ¡
@Transactional
public void operation1() {
    // å®Œæˆä¸€éƒ¨åˆ†å·¥ä½œ
}

@Transactional
public void operation2() {
    // å®Œæˆå¦ä¸€éƒ¨åˆ†å·¥ä½œ
}

public void coordinator() {
    operation1();
    operation2();
}
```

---

## 6. âš™ï¸ äº‹åŠ¡ç®¡ç†å™¨é…ç½®


### 6.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ç®¡ç†å™¨


**é€šä¿—ç†è§£**ï¼š
```
äº‹åŠ¡ç®¡ç†å™¨ = äº‹åŠ¡çš„æ€»ç®¡å®¶

å·¥ä½œå†…å®¹ï¼š
1ï¸âƒ£ å¼€å¯äº‹åŠ¡
2ï¸âƒ£ æäº¤äº‹åŠ¡
3ï¸âƒ£ å›æ»šäº‹åŠ¡
4ï¸âƒ£ ç®¡ç†äº‹åŠ¡çŠ¶æ€
```

### 6.2 å¸¸ç”¨äº‹åŠ¡ç®¡ç†å™¨


**JPA/Hibernate ç¯å¢ƒ**ï¼š
```java
@Configuration
@EnableTransactionManagement
public class TransactionConfig {
    
    @Bean
    public PlatformTransactionManager transactionManager(
            EntityManagerFactory entityManagerFactory) {
        
        JpaTransactionManager txManager = new JpaTransactionManager();
        txManager.setEntityManagerFactory(entityManagerFactory);
        return txManager;
    }
}
```

**Spring Boot è‡ªåŠ¨é…ç½®**ï¼š
```yaml
# application.yml
spring:
  jpa:
    properties:
      hibernate:
        # æ˜¾ç¤ºSQL
        show_sql: true
        # æ ¼å¼åŒ–SQL
        format_sql: true
    # äº‹åŠ¡è¶…æ—¶é»˜è®¤å€¼
    transaction:
      default-timeout: 30
```

### 6.3 å¤šæ•°æ®æºäº‹åŠ¡é…ç½®


**åœºæ™¯ï¼šä¸€ä¸ªé¡¹ç›®ç”¨å¤šä¸ªæ•°æ®åº“**

```java
@Configuration
public class MultiDataSourceConfig {
    
    // ä¸»æ•°æ®æºäº‹åŠ¡ç®¡ç†å™¨
    @Bean
    @Primary
    public PlatformTransactionManager primaryTxManager(
            @Qualifier("primaryEntityManagerFactory") EntityManagerFactory emf) {
        return new JpaTransactionManager(emf);
    }
    
    // æ¬¡æ•°æ®æºäº‹åŠ¡ç®¡ç†å™¨
    @Bean
    public PlatformTransactionManager secondaryTxManager(
            @Qualifier("secondaryEntityManagerFactory") EntityManagerFactory emf) {
        return new JpaTransactionManager(emf);
    }
}

// ä½¿ç”¨æ—¶æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨
@Service
public class UserService {
    
    @Transactional(transactionManager = "primaryTxManager")
    public void saveToPrimary(User user) {
        // ä¿å­˜åˆ°ä¸»æ•°æ®åº“
    }
    
    @Transactional(transactionManager = "secondaryTxManager")
    public void saveToSecondary(Log log) {
        // ä¿å­˜åˆ°æ—¥å¿—æ•°æ®åº“
    }
}
```

---

## 7. âš ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


### 7.1 äº‹åŠ¡ä¸ç”Ÿæ•ˆçš„åŸå› 


**ğŸ”¸ é—®é¢˜1ï¼šæ–¹æ³•ä¸æ˜¯public**
```java
// âŒ privateæ–¹æ³•äº‹åŠ¡ä¸ç”Ÿæ•ˆ
@Transactional
private void saveUser(User user) {
    userDao.save(user);
}

// âœ… å¿…é¡»æ˜¯public
@Transactional
public void saveUser(User user) {
    userDao.save(user);
}
```

**ğŸ”¸ é—®é¢˜2ï¼šå†…éƒ¨æ–¹æ³•è°ƒç”¨**
```java
// âŒ ç±»å†…éƒ¨è°ƒç”¨,äº‹åŠ¡ä¸ç”Ÿæ•ˆ
@Service
public class UserService {
    
    public void methodA() {
        methodB();  // ç›´æ¥è°ƒç”¨,ä¸èµ°ä»£ç†
    }
    
    @Transactional
    public void methodB() {
        // äº‹åŠ¡ä¸ç”Ÿæ•ˆ!
    }
}

// âœ… è§£å†³æ–¹æ¡ˆï¼šé€šè¿‡Springä»£ç†è°ƒç”¨
@Service
public class UserService {
    
    @Autowired
    private UserService self;  // æ³¨å…¥è‡ªå·±
    
    public void methodA() {
        self.methodB();  // é€šè¿‡ä»£ç†è°ƒç”¨
    }
    
    @Transactional
    public void methodB() {
        // äº‹åŠ¡ç”Ÿæ•ˆ
    }
}
```

**ğŸ”¸ é—®é¢˜3ï¼šå¼‚å¸¸è¢«æ•è·**
```java
// âŒ å¼‚å¸¸è¢«åƒæ‰,ä¸å›æ»š
@Transactional
public void saveUser(User user) {
    try {
        userDao.save(user);
    } catch (Exception e) {
        e.printStackTrace();  // åªæ‰“å°,ä¸æŠ›å‡º
    }
}

// âœ… å¿…é¡»æŠ›å‡ºå¼‚å¸¸
@Transactional
public void saveUser(User user) {
    try {
        userDao.save(user);
    } catch (Exception e) {
        log.error("ä¿å­˜å¤±è´¥", e);
        throw e;  // é‡æ–°æŠ›å‡º
    }
}
```

### 7.2 æ€§èƒ½é—®é¢˜


**ğŸ¯ é—®é¢˜ï¼šäº‹åŠ¡è¶…æ—¶**
```java
// åŸå› åˆ†æï¼š
1. SQLæ‰§è¡Œæ…¢
2. é”ç­‰å¾…æ—¶é—´é•¿
3. äº‹åŠ¡èŒƒå›´å¤ªå¤§

// è§£å†³æ–¹æ¡ˆ
@Transactional(timeout = 60)  // å¢åŠ è¶…æ—¶æ—¶é—´
public void batchProcess() {
    // æˆ–è€…ä¼˜åŒ–SQL
    // æˆ–è€…æ‹†åˆ†äº‹åŠ¡
}
```

**ğŸ¯ é—®é¢˜ï¼šæ­»é”**
```java
// åœºæ™¯ï¼šä¸¤ä¸ªäº‹åŠ¡äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”

// è§£å†³æ–¹æ¡ˆ1ï¼šç»Ÿä¸€åŠ é”é¡ºåº
@Transactional
public void transfer(Long fromId, Long toId, BigDecimal amount) {
    // æ€»æ˜¯å…ˆé”IDå°çš„è´¦æˆ·
    Long firstId = Math.min(fromId, toId);
    Long secondId = Math.max(fromId, toId);
    
    Account first = accountDao.lockById(firstId);
    Account second = accountDao.lockById(secondId);
    
    // æ‰§è¡Œè½¬è´¦
}

// è§£å†³æ–¹æ¡ˆ2ï¼šè®¾ç½®è¶…æ—¶
@Transactional(timeout = 30)
public void transfer(...) {
    // è¶…æ—¶è‡ªåŠ¨å›æ»š,é‡Šæ”¾é”
}
```

### 7.3 è°ƒè¯•æŠ€å·§


**å¦‚ä½•ç¡®è®¤äº‹åŠ¡æ˜¯å¦ç”Ÿæ•ˆ**ï¼Ÿ

```java
@Transactional
public void testTransaction() {
    // 1. æ‰“å°äº‹åŠ¡ä¿¡æ¯
    boolean active = TransactionSynchronizationManager.isActualTransactionActive();
    System.out.println("äº‹åŠ¡æ¿€æ´»: " + active);
    
    // 2. è·å–äº‹åŠ¡åç§°
    String name = TransactionSynchronizationManager.getCurrentTransactionName();
    System.out.println("äº‹åŠ¡åç§°: " + name);
    
    // 3. æ£€æŸ¥æ˜¯å¦åªè¯»
    boolean readOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();
    System.out.println("åªè¯»äº‹åŠ¡: " + readOnly);
}
```

**å¼€å¯äº‹åŠ¡æ—¥å¿—**ï¼š
```yaml
# application.yml
logging:
  level:
    org.springframework.transaction: DEBUG
    org.springframework.orm.jpa: DEBUG
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å£°æ˜å¼äº‹åŠ¡æœ¬è´¨ï¼šç”¨æ³¨è§£ä»£æ›¿æ‰‹åŠ¨ç¼–ç¨‹,Springè‡ªåŠ¨ç®¡ç†äº‹åŠ¡
ğŸ”¸ @Transactionalæ ¸å¿ƒå±æ€§ï¼šä¼ æ’­è¡Œä¸ºã€éš”ç¦»çº§åˆ«ã€è¶…æ—¶ã€åªè¯»ã€å›æ»šè§„åˆ™
ğŸ”¸ ä¼ æ’­è¡Œä¸ºï¼šREQUIRED(é»˜è®¤)ã€REQUIRES_NEW(ç‹¬ç«‹)ã€NESTED(åµŒå¥—)
ğŸ”¸ å›æ»šè§„åˆ™ï¼šè¿è¡Œæ—¶å¼‚å¸¸é»˜è®¤å›æ»š,å—æ£€å¼‚å¸¸é»˜è®¤ä¸å›æ»š
ğŸ”¸ ä¼˜åŒ–æŠ€å·§ï¼šåªè¯»äº‹åŠ¡ã€è®¾ç½®è¶…æ—¶ã€æœ€å°åŒ–äº‹åŠ¡èŒƒå›´
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ äº‹åŠ¡ä¼ æ’­è¡Œä¸ºé€‰æ‹©**
```
æ—¥å¸¸ä¸šåŠ¡ â†’ REQUIREDï¼ˆåŠ å…¥å·²æœ‰äº‹åŠ¡ï¼‰
ç‹¬ç«‹æ—¥å¿— â†’ REQUIRES_NEWï¼ˆæ–°å»ºç‹¬ç«‹äº‹åŠ¡ï¼‰
æ‰¹é‡å¤„ç† â†’ NESTEDï¼ˆéƒ¨åˆ†å¤±è´¥ä¸å½±å“æ•´ä½“ï¼‰
```

**ğŸ”¹ å›æ»šè§„åˆ™è®¾ç½®**
```
é‡‘èä¸šåŠ¡ â†’ rollbackFor = Exception.classï¼ˆæ‰€æœ‰å¼‚å¸¸éƒ½å›æ»šï¼‰
ä¸€èˆ¬ä¸šåŠ¡ â†’ é»˜è®¤è§„åˆ™ï¼ˆè¿è¡Œæ—¶å¼‚å¸¸å›æ»šï¼‰
ç‰¹æ®Šåœºæ™¯ â†’ noRollbackForï¼ˆä¸šåŠ¡å¼‚å¸¸ä¸å›æ»šï¼‰
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–åŸåˆ™**
```
æŸ¥è¯¢æ–¹æ³• â†’ æ ‡è®° readOnly = true
é•¿äº‹åŠ¡ â†’ è®¾ç½® timeout é˜²æ­¢è¶…æ—¶
å¤æ‚ä¸šåŠ¡ â†’ æ‹†åˆ†äº‹åŠ¡,ç¼©å°èŒƒå›´
```

### 8.3 æœ€ä½³å®è·µæ¸…å•


âœ… **ç¼–ç è§„èŒƒ**
- [ ] äº‹åŠ¡æ–¹æ³•å¿…é¡»æ˜¯public
- [ ] å¼‚å¸¸å¿…é¡»æŠ›å‡º,ä¸èƒ½åªæ•è·
- [ ] æŸ¥è¯¢æ–¹æ³•æ ‡è®°readOnly=true
- [ ] è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´

âœ… **æ€§èƒ½ä¼˜åŒ–**
- [ ] äº‹åŠ¡èŒƒå›´æœ€å°åŒ–
- [ ] é¿å…åµŒå¥—è¿‡æ·±
- [ ] ä¸åœ¨äº‹åŠ¡ä¸­è°ƒç”¨å¤–éƒ¨æœåŠ¡
- [ ] æ‰¹é‡æ“ä½œåˆç†åˆ†æ‰¹

âœ… **å¼‚å¸¸å¤„ç†**
- [ ] æ˜ç¡®æŒ‡å®šå›æ»šå¼‚å¸¸ç±»å‹
- [ ] åŒºåˆ†ä¸šåŠ¡å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸
- [ ] å…³é”®æ“ä½œè®°å½•æ—¥å¿—
- [ ] æ‰‹åŠ¨å›æ»šæ—¶æ ‡è®°æ¸…æ¥š

### 8.4 å¸¸è§é”™è¯¯æ’æŸ¥


```
ğŸ” äº‹åŠ¡ä¸ç”Ÿæ•ˆæ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥æ–¹æ³•æ˜¯å¦public
2. æ£€æŸ¥æ˜¯å¦å†…éƒ¨è°ƒç”¨ï¼ˆæ²¡èµ°ä»£ç†ï¼‰
3. æ£€æŸ¥å¼‚å¸¸æ˜¯å¦è¢«æ•è·
4. æ£€æŸ¥@EnableTransactionManagementæ˜¯å¦å¼€å¯
5. æŸ¥çœ‹äº‹åŠ¡ç®¡ç†å™¨é…ç½®æ˜¯å¦æ­£ç¡®

ğŸ” äº‹åŠ¡å›æ»šå¼‚å¸¸æ’æŸ¥ï¼š
1. æ£€æŸ¥rollbackForé…ç½®
2. ç¡®è®¤å¼‚å¸¸ç±»å‹æ˜¯å¦åŒ¹é…
3. æ£€æŸ¥æ˜¯å¦æ‰‹åŠ¨æ•è·å¼‚å¸¸
4. æŸ¥çœ‹äº‹åŠ¡ä¼ æ’­è¡Œä¸ºè®¾ç½®
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
å£°æ˜å¼äº‹åŠ¡ç®€å•ç”¨,ä¸€ä¸ªæ³¨è§£å…¨æå®š
ä¼ æ’­è¡Œä¸ºé€‰å¯¹è·¯,REQUIREDæœ€å¸¸ç”¨
å›æ»šè§„åˆ™è¦æ˜ç¡®,å¼‚å¸¸ç±»å‹åˆ†æ¸…æ¥š
åªè¯»äº‹åŠ¡æ€§èƒ½å¥½,æŸ¥è¯¢æ–¹æ³•åˆ«å¿˜äº†
äº‹åŠ¡èŒƒå›´è¦æœ€å°,æ€§èƒ½ä¼˜åŒ–æ˜¯å…³é”®
```