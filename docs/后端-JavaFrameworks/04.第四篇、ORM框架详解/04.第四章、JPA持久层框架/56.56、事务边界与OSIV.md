---
title: 56ã€äº‹åŠ¡è¾¹ç•Œä¸OSIV
---
## ğŸ“š ç›®å½•å¯¼èˆª

1. [ä»€ä¹ˆæ˜¯äº‹åŠ¡è¾¹ç•Œ](#1-ä»€ä¹ˆæ˜¯äº‹åŠ¡è¾¹ç•Œ)
2. [OSIVæœºåˆ¶è¯¦è§£](#2-OSIVæœºåˆ¶è¯¦è§£)
3. [æ‡’åŠ è½½å¼‚å¸¸é—®é¢˜](#3-æ‡’åŠ è½½å¼‚å¸¸é—®é¢˜)
4. [OSIVé…ç½®ä¸æ§åˆ¶](#4-OSIVé…ç½®ä¸æ§åˆ¶)
5. [æœ€ä½³å®è·µæ–¹æ¡ˆ](#5-æœ€ä½³å®è·µæ–¹æ¡ˆ)
6. [æ€§èƒ½å½±å“åˆ†æ](#6-æ€§èƒ½å½±å“åˆ†æ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯äº‹åŠ¡è¾¹ç•Œ


### 1.1 é€šä¿—ç†è§£äº‹åŠ¡è¾¹ç•Œ


**ğŸŒ° ç”Ÿæ´»ç±»æ¯”**

æƒ³è±¡ä½ å»é“¶è¡Œè½¬è´¦ï¼š
```
å¼€å§‹è½¬è´¦ï¼ˆå¼€å¯äº‹åŠ¡ï¼‰
    â”œâ”€ ä»ä½ è´¦æˆ·æ‰£é’±
    â”œâ”€ å¾€å¯¹æ–¹è´¦æˆ·åŠ é’±
    â””â”€ è®°å½•è½¬è´¦æµæ°´
æäº¤è½¬è´¦ï¼ˆæäº¤äº‹åŠ¡ï¼‰
```

è¿™ä¸ª"ä»å¼€å§‹åˆ°æäº¤"çš„èŒƒå›´ï¼Œå°±å«**äº‹åŠ¡è¾¹ç•Œ**ã€‚åœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œè¦ä¹ˆæ‰€æœ‰æ“ä½œéƒ½æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨æ’¤é”€ã€‚

### 1.2 Springä¸­çš„äº‹åŠ¡è¾¹ç•Œ


åœ¨Springåº”ç”¨ä¸­ï¼Œäº‹åŠ¡è¾¹ç•Œé€šå¸¸æ˜¯è¿™æ ·çš„ï¼š

```
è¯·æ±‚è¿›å…¥
   â†“
Controllerï¼ˆæ¥æ”¶è¯·æ±‚ï¼‰
   â†“
Serviceï¼ˆ@Transactional äº‹åŠ¡å¼€å§‹ï¼‰
   â”œâ”€ æŸ¥è¯¢æ•°æ®åº“
   â”œâ”€ ä¿®æ”¹æ•°æ®
   â””â”€ ä¿å­˜æ•°æ®
Serviceæ–¹æ³•ç»“æŸï¼ˆäº‹åŠ¡æäº¤/å›æ»šï¼‰
   â†“
Controllerï¼ˆè¿”å›ç»“æœï¼‰
   â†“
å“åº”è¿”å›
```

> ğŸ’¡ **æ ¸å¿ƒæ¦‚å¿µ**  
> äº‹åŠ¡è¾¹ç•Œå°±æ˜¯**æ•°æ®åº“è¿æ¥æœ‰æ•ˆçš„èŒƒå›´**ã€‚è¶…å‡ºè¿™ä¸ªèŒƒå›´ï¼Œæ•°æ®åº“è¿æ¥å°±æ–­å¼€äº†ï¼Œå°±ä¸èƒ½å†è®¿é—®æ•°æ®åº“äº†ã€‚

### 1.3 é»˜è®¤çš„äº‹åŠ¡è¾¹ç•Œä½ç½®


**ğŸ”¸ æ ‡å‡†åšæ³•**

```java
@Service
public class UserService {
    
    @Transactional  // â† äº‹åŠ¡è¾¹ç•Œå¼€å§‹
    public User getUserById(Long id) {
        User user = userRepository.findById(id).get();
        // è¿™é‡Œå¯ä»¥è®¿é—®userçš„æ‰€æœ‰å±æ€§ï¼ŒåŒ…æ‹¬æ‡’åŠ è½½çš„
        return user;
    } // â† äº‹åŠ¡è¾¹ç•Œç»“æŸï¼Œæ•°æ®åº“è¿æ¥å…³é—­
}

@RestController
public class UserController {
    
    public UserDTO getUser(Long id) {
        User user = userService.getUserById(id);
        // âš ï¸ è¿™é‡Œäº‹åŠ¡å·²ç»ç»“æŸäº†ï¼
        // å¦‚æœuseræœ‰æ‡’åŠ è½½å±æ€§ï¼Œè®¿é—®ä¼šæŠ¥é”™
        return convertToDTO(user);
    }
}
```

**ğŸ“Š äº‹åŠ¡è¾¹ç•Œç¤ºæ„å›¾**

```
Controllerå±‚        Serviceå±‚         Repositoryå±‚       æ•°æ®åº“
    â”‚                 â”‚                   â”‚                â”‚
    â”‚â”€[1]è°ƒç”¨â”€â”€â”€â”€â”€â–¶â”‚                   â”‚                â”‚
    â”‚                 â”‚â”€[å¼€å¯äº‹åŠ¡]â”€â”€â”€â”€â–¶â”‚                â”‚
    â”‚                 â”‚                   â”‚â”€[æŸ¥è¯¢]â”€â”€â”€â–¶â”‚
    â”‚                 â”‚                   â”‚â—€â”€[è¿”å›æ•°æ®]â”€â”‚
    â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
    â”‚                 â”‚â”€[æäº¤äº‹åŠ¡]â”€â”€â”€â”€â–¶â”‚                â”‚
    â”‚â—€â”€[2]è¿”å›â”€â”€â”€â”€â”€â”‚                   â”‚                â”‚
    â”‚                 â”‚                   â”‚                â”‚
   âŒè¿™é‡Œäº‹åŠ¡å·²ç»“æŸ                                      
   âŒä¸èƒ½å†è®¿é—®æ‡’åŠ è½½å±æ€§                                
```

---

## 2. ğŸ”“ OSIVæœºåˆ¶è¯¦è§£


### 2.1 OSIVæ˜¯ä»€ä¹ˆ


**ğŸ”¸ å…¨ç§°è§£æ**

- **O**penï¼šæ‰“å¼€
- **S**essionï¼šä¼šè¯ï¼ˆæ•°æ®åº“è¿æ¥ï¼‰
- **I**nï¼šåœ¨...ä¸­
- **V**iewï¼šè§†å›¾ï¼ˆControllerå±‚å’ŒViewå±‚ï¼‰

**ğŸŒ° é€šä¿—è§£é‡Š**

OSIVå°±æ˜¯è®©æ•°æ®åº“è¿æ¥**æ´»å¾—æ›´ä¹…ä¸€ç‚¹**ï¼Œä¸æ˜¯åœ¨Serviceå±‚ç»“æŸå°±å…³é—­ï¼Œè€Œæ˜¯ä¸€ç›´ä¿æŒåˆ°Controllerç”šè‡³å‰ç«¯é¡µé¢æ¸²æŸ“å®Œæˆæ‰å…³é—­ã€‚

### 2.2 OSIVçš„å·¥ä½œåŸç†


**ğŸ”¸ ä¼ ç»Ÿæ–¹å¼ï¼ˆOSIVå…³é—­ï¼‰**

```
è¯·æ±‚ â†’ Controller â†’ Service â†’ æ•°æ®åº“
                      â†‘
                   äº‹åŠ¡èŒƒå›´
                   ï¼ˆè¿æ¥æœ‰æ•ˆæœŸï¼‰
                   
Serviceç»“æŸåï¼š
- æ•°æ®åº“è¿æ¥å…³é—­ âŒ
- ä¸èƒ½è®¿é—®æ‡’åŠ è½½å±æ€§ âŒ
```

**ğŸ”¸ OSIVæ–¹å¼ï¼ˆOSIVå¼€å¯ï¼‰**

```
è¯·æ±‚ â†’ Controller â†’ Service â†’ æ•°æ®åº“
  â†‘_________________________________â†‘
           æ•´ä¸ªè¯·æ±‚èŒƒå›´
         ï¼ˆè¿æ¥ä¿æŒæ‰“å¼€ï¼‰
         
æ•´ä¸ªè¯·æ±‚æœŸé—´ï¼š
- æ•°æ®åº“è¿æ¥ä¿æŒæ‰“å¼€ âœ…
- å¯ä»¥éšæ—¶è®¿é—®æ‡’åŠ è½½å±æ€§ âœ…
```

### 2.3 å›¾è§£OSIVæœºåˆ¶


```
ã€OSIVå…³é—­æ—¶ã€‘
HTTPè¯·æ±‚
   â”‚
   â”œâ”€ Controller
   â”‚     â”œâ”€ è°ƒç”¨Service
   â”‚     â”‚     â”œâ”€[äº‹åŠ¡å¼€å§‹]
   â”‚     â”‚     â”œâ”€ æŸ¥è¯¢æ•°æ®
   â”‚     â”‚     â””â”€[äº‹åŠ¡ç»“æŸ] â† è¿æ¥å…³é—­
   â”‚     â”‚
   â”‚     â””â”€ å¤„ç†æ•°æ® âŒ è¿™é‡Œè®¿é—®æ‡’åŠ è½½ä¼šæŠ¥é”™
   â”‚
   â””â”€ è¿”å›å“åº”

ã€OSIVå¼€å¯æ—¶ã€‘
HTTPè¯·æ±‚  [Sessionå¼€å¯]
   â”‚
   â”œâ”€ Controller
   â”‚     â”œâ”€ è°ƒç”¨Service
   â”‚     â”‚     â”œâ”€[äº‹åŠ¡å¼€å§‹]
   â”‚     â”‚     â”œâ”€ æŸ¥è¯¢æ•°æ®
   â”‚     â”‚     â””â”€[äº‹åŠ¡ç»“æŸ]
   â”‚     â”‚
   â”‚     â””â”€ å¤„ç†æ•°æ® âœ… è¿™é‡Œä»å¯è®¿é—®æ‡’åŠ è½½
   â”‚
   â””â”€ è¿”å›å“åº” [Sessionå…³é—­]
```

### 2.4 OSIVçš„ä¸¤ä¸ªå…³é”®ç‚¹


**ğŸ”¸ å…³é”®ç‚¹1ï¼šä¼šè¯ vs äº‹åŠ¡**

| æ¦‚å¿µ | **ç”Ÿå‘½å‘¨æœŸ** | **ä½œç”¨èŒƒå›´** | **é€šä¿—ç†è§£** |
|------|------------|------------|-------------|
| ğŸ”¹ **Sessionä¼šè¯** | `æ•´ä¸ªè¯·æ±‚æœŸé—´` | `å¯ä»¥æŸ¥è¯¢æ•°æ®` | `æ•°æ®åº“è¿æ¥ä¿æŒæ‰“å¼€` |
| ğŸ”¹ **Transactionäº‹åŠ¡** | `@Transactionalæ–¹æ³•å†…` | `å¯ä»¥ä¿®æ”¹æ•°æ®` | `å¯ä»¥å†™å…¥æ•°æ®åº“çš„æ—¶é—´æ®µ` |

> ğŸ’¡ **é‡è¦ç†è§£**  
> OSIVå»¶é•¿çš„æ˜¯**Sessionä¼šè¯**ï¼ˆå¯ä»¥è¯»ï¼‰ï¼Œä¸æ˜¯**Transactionäº‹åŠ¡**ï¼ˆå¯ä»¥å†™ï¼‰ï¼

**ğŸ”¸ å…³é”®ç‚¹2ï¼šåªè¯»æ¨¡å¼**

```java
// OSIVå¼€å¯åçš„çŠ¶æ€
Controllerå±‚ {
    Session: æ‰“å¼€ âœ… â†’ å¯ä»¥æŸ¥è¯¢ã€å¯ä»¥è®¿é—®æ‡’åŠ è½½
    Transaction: å…³é—­ âŒ â†’ ä¸èƒ½ä¿®æ”¹æ•°æ®ã€ä¸èƒ½ä¿å­˜
}
```

---

## 3. âš ï¸ æ‡’åŠ è½½å¼‚å¸¸é—®é¢˜


### 3.1 ä»€ä¹ˆæ˜¯æ‡’åŠ è½½å¼‚å¸¸


**ğŸ”¸ å¼‚å¸¸åç§°**

`LazyInitializationException`ï¼ˆæ‡’åŠ è½½åˆå§‹åŒ–å¼‚å¸¸ï¼‰

**ğŸ”¸ å¼‚å¸¸åŸå› **

å½“ä½ æƒ³è®¿é—®ä¸€ä¸ªæ‡’åŠ è½½çš„å±æ€§æ—¶ï¼ŒJPAéœ€è¦å»æ•°æ®åº“æŸ¥è¯¢ï¼Œä½†æ­¤æ—¶æ•°æ®åº“è¿æ¥å·²ç»å…³é—­äº†ï¼Œå°±ä¼šæŠ¥è¿™ä¸ªé”™ã€‚

### 3.2 æ‡’åŠ è½½å¼‚å¸¸åœºæ™¯æ¼”ç¤º


**ğŸ”¸ é—®é¢˜åœºæ™¯**

```java
// å®ä½“ç±»
@Entity
public class User {
    @Id
    private Long id;
    private String name;
    
    // æ‡’åŠ è½½ï¼šé»˜è®¤ä¸æŸ¥è¯¢è®¢å•
    @OneToMany(fetch = FetchType.LAZY)
    private List<Order> orders;
}

// Serviceå±‚
@Service
public class UserService {
    
    @Transactional
    public User getUser(Long id) {
        return userRepository.findById(id).get();
        // æ–¹æ³•ç»“æŸï¼Œäº‹åŠ¡å…³é—­ï¼Œè¿æ¥æ–­å¼€
    }
}

// Controllerå±‚
@RestController
public class UserController {
    
    @GetMapping("/user/{id}")
    public UserDTO getUser(@PathVariable Long id) {
        User user = userService.getUser(id);
        
        // âŒ è¿™é‡Œè®¿é—®ordersä¼šæŠ¥é”™ï¼
        // å› ä¸ºäº‹åŠ¡å·²ç»“æŸï¼Œæ— æ³•æŸ¥è¯¢orders
        List<Order> orders = user.getOrders();
        
        return new UserDTO(user, orders);
    }
}
```

**ğŸ”¸ å¼‚å¸¸ä¿¡æ¯**

```
org.hibernate.LazyInitializationException: 
failed to lazily initialize a collection of role: 
com.example.User.orders, 
could not initialize proxy - no Session

ç¿»è¯‘ï¼š
æ‡’åŠ è½½åˆå§‹åŒ–å¤±è´¥ï¼š
æ— æ³•åˆå§‹åŒ–Userçš„ordersé›†åˆï¼Œ
åŸå› æ˜¯æ²¡æœ‰Sessionï¼ˆæ•°æ®åº“è¿æ¥å·²å…³é—­ï¼‰
```

### 3.3 ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆå¯¹æ¯”


| æ–¹æ¡ˆ | **åšæ³•** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|------|---------|---------|---------|
| ğŸ”¹ **ç«‹å³åŠ è½½** | `@OneToMany(fetch=EAGER)` | `ä¸ä¼šæŠ¥é”™` | `æ€»æ˜¯æŸ¥è¯¢ï¼Œæµªè´¹æ€§èƒ½` |
| ğŸ”¹ **æ‰‹åŠ¨åŠ è½½** | `åœ¨Serviceå±‚è°ƒç”¨getOrders()` | `çµæ´»æ§åˆ¶` | `éœ€è¦é¢„çŸ¥å“ªäº›å±æ€§ä¼šç”¨` |
| ğŸ”¹ **DTOè½¬æ¢** | `Serviceå±‚è½¬DTO` | `è§£è€¦æ¸…æ™°` | `éœ€è¦å†™è½¬æ¢ä»£ç ` |
| ğŸ”¹ **å¼€å¯OSIV** | `spring.jpa.open-in-view=true` | `è‡ªåŠ¨è§£å†³` | `å¯èƒ½å½±å“æ€§èƒ½` |

---

## 4. ğŸ”§ OSIVé…ç½®ä¸æ§åˆ¶


### 4.1 OSIVå¼€å…³é…ç½®


**ğŸ”¸ é…ç½®æ–‡ä»¶è®¾ç½®**

```yaml
# application.yml

spring:
  jpa:
    open-in-view: true   # é»˜è®¤å€¼æ˜¯trueï¼Œè¡¨ç¤ºå¼€å¯OSIV
```

```properties
# application.properties

spring.jpa.open-in-view=true
```

**ğŸ”¸ é…ç½®æ•ˆæœå¯¹æ¯”**

| é…ç½®å€¼ | **æ•ˆæœ** | **é€‚ç”¨åœºæ™¯** | **æ³¨æ„äº‹é¡¹** |
|--------|---------|------------|-------------|
| âœ… **true** | `Sessionä¿æŒåˆ°è¯·æ±‚ç»“æŸ` | `å¿«é€Ÿå¼€å‘ï¼Œç®€å•é¡¹ç›®` | `å¯èƒ½æœ‰æ€§èƒ½é—®é¢˜` |
| âŒ **false** | `Sessionåœ¨Serviceå±‚ç»“æŸ` | `é«˜æ€§èƒ½è¦æ±‚ï¼Œå¤§é¡¹ç›®` | `éœ€è¦å¤„ç†æ‡’åŠ è½½` |

### 4.2 OSIVå¯åŠ¨æç¤º


**ğŸ”¸ å¯åŠ¨æ—¥å¿—**

```
2024-09-23 10:00:00.123  WARN 12345 --- [main] 
JpaBaseConfiguration$JpaWebConfiguration : 

spring.jpa.open-in-view is enabled by default. 
Therefore, database queries may be performed during view rendering. 
Explicitly configure spring.jpa.open-in-view to disable this warning
```

> ğŸ’¡ **æ—¥å¿—å«ä¹‰**  
> Springæé†’ä½ ï¼šOSIVé»˜è®¤å¼€å¯ï¼Œå¯èƒ½åœ¨æ¸²æŸ“é¡µé¢æ—¶æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢ï¼ˆN+1é—®é¢˜ï¼‰ï¼Œå»ºè®®æ˜ç¡®é…ç½®ã€‚

### 4.3 ä¸åŒé…ç½®ä¸‹çš„è¡Œä¸º


**ğŸ”¸ OSIV=true çš„æƒ…å†µ**

```java
@RestController
public class UserController {
    
    @GetMapping("/user/{id}")
    public UserDTO getUser(@PathVariable Long id) {
        User user = userService.getUser(id);
        
        // âœ… å¯ä»¥è®¿é—®ï¼Œä¼šè‡ªåŠ¨æŸ¥è¯¢æ•°æ®åº“
        user.getOrders().size();  
        
        // âœ… å¯ä»¥è®¿é—®åµŒå¥—çš„æ‡’åŠ è½½
        user.getOrders().get(0).getProducts().size();
        
        return toDTO(user);
    }
}
```

**ğŸ”¸ OSIV=false çš„æƒ…å†µ**

```java
@RestController
public class UserController {
    
    @GetMapping("/user/{id}")
    public UserDTO getUser(@PathVariable Long id) {
        User user = userService.getUser(id);
        
        // âŒ æŠ¥é”™ï¼šLazyInitializationException
        user.getOrders().size();
        
        return toDTO(user);
    }
}
```

### 4.4 ç¼–ç¨‹å¼æ§åˆ¶ï¼ˆé«˜çº§ç”¨æ³•ï¼‰


**ğŸ”¸ æ‰‹åŠ¨ç®¡ç†Session**

```java
@RestController
public class UserController {
    
    @Autowired
    private EntityManager entityManager;
    
    @GetMapping("/user/{id}")
    public UserDTO getUser(@PathVariable Long id) {
        User user = userService.getUser(id);
        
        // æ‰‹åŠ¨è§¦å‘æ‡’åŠ è½½åˆå§‹åŒ–
        Hibernate.initialize(user.getOrders());
        
        return toDTO(user);
    }
}
```

---

## 5. ğŸ¯ æœ€ä½³å®è·µæ–¹æ¡ˆ


### 5.1 æ¨èåšæ³•ï¼šç¦ç”¨OSIV


**ğŸ”¸ ä¸ºä»€ä¹ˆè¦ç¦ç”¨**

```
OSIVçš„é—®é¢˜ï¼š
1. è¿æ¥å ç”¨æ—¶é—´é•¿ â†’ è¿æ¥æ± å¯èƒ½è€—å°½
2. å¯èƒ½äº§ç”ŸN+1æŸ¥è¯¢ â†’ æ€§èƒ½éšæ‚£
3. äº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™° â†’ ä»£ç éš¾ä»¥ç»´æŠ¤
```

**ğŸ”¸ æ­£ç¡®é…ç½®**

```yaml
spring:
  jpa:
    open-in-view: false  # å…³é—­OSIV
```

### 5.2 Serviceå±‚å®Œæ•´å¤„ç†


**ğŸ”¸ æ–¹æ¡ˆ1ï¼šDTOè½¬æ¢**

```java
// DTOç±»
public class UserDTO {
    private Long id;
    private String name;
    private List<OrderDTO> orders;
    
    // æ„é€ æ–¹æ³•...
}

// Serviceå±‚
@Service
@Transactional(readOnly = true)
public class UserService {
    
    public UserDTO getUserWithOrders(Long id) {
        User user = userRepository.findById(id)
            .orElseThrow(() -> new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        // åœ¨äº‹åŠ¡å†…è®¿é—®æ‡’åŠ è½½å±æ€§
        List<OrderDTO> orderDTOs = user.getOrders()
            .stream()
            .map(order -> new OrderDTO(order))
            .collect(Collectors.toList());
        
        // è¿”å›DTOï¼Œä¸è¿”å›Entity
        return new UserDTO(user.getId(), user.getName(), orderDTOs);
    }
}

// Controllerå±‚
@RestController
public class UserController {
    
    @GetMapping("/user/{id}")
    public UserDTO getUser(@PathVariable Long id) {
        // âœ… æ¥æ”¶DTOï¼Œä¸ä¼šæœ‰æ‡’åŠ è½½é—®é¢˜
        return userService.getUserWithOrders(id);
    }
}
```

**ğŸ”¸ æ–¹æ¡ˆ2ï¼šEntityGraph**

```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    
    // ä½¿ç”¨EntityGraphæŒ‡å®šè¦åŠ è½½çš„å…³è”
    @EntityGraph(attributePaths = {"orders", "orders.products"})
    Optional<User> findWithOrdersById(Long id);
}

@Service
@Transactional(readOnly = true)
public class UserService {
    
    public User getUserWithOrders(Long id) {
        // ä¸€æ¬¡æŸ¥è¯¢åŠ è½½æ‰€æœ‰éœ€è¦çš„æ•°æ®
        return userRepository.findWithOrdersById(id)
            .orElseThrow(() -> new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨"));
    }
}
```

### 5.3 Controllerå±‚ç¦æ­¢æ‡’åŠ è½½


**ğŸ”¸ åŸåˆ™**

> ğŸš¨ **é‡è¦è§„åˆ™**  
> Controllerå±‚**ç»å¯¹ä¸è¦**è®¿é—®Entityçš„æ‡’åŠ è½½å±æ€§ï¼

**ğŸ”¸ æ­£ç¡®åšæ³•**

```java
@RestController
public class UserController {
    
    @GetMapping("/user/{id}")
    public UserDTO getUser(@PathVariable Long id) {
        
        // âœ… æ–¹å¼1ï¼šServiceè¿”å›DTO
        return userService.getUserDTO(id);
        
        // âœ… æ–¹å¼2ï¼šServiceæå‰åŠ è½½å®Œæ•´Entity
        User user = userService.getUserWithOrders(id);
        return convertToDTO(user); // ç›´æ¥è½¬æ¢ï¼Œä¸è§¦å‘æŸ¥è¯¢
    }
    
    @GetMapping("/user/{id}/bad")
    public UserDTO getUserBad(@PathVariable Long id) {
        User user = userService.getUser(id);
        
        // âŒ é”™è¯¯ï¼šControllerå±‚è®¿é—®æ‡’åŠ è½½
        user.getOrders().size();
        
        return convertToDTO(user);
    }
}
```

### 5.4 äº‹åŠ¡è¾¹ç•Œè®¾è®¡åŸåˆ™


**ğŸ”¸ æ¸…æ™°çš„åˆ†å±‚èŒè´£**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Controller å±‚               â”‚
â”‚  - æ¥æ”¶è¯·æ±‚ï¼Œå‚æ•°éªŒè¯                 â”‚
â”‚  - è°ƒç”¨Serviceï¼Œå¤„ç†å“åº”              â”‚
â”‚  - åªå¤„ç†DTOï¼Œä¸æ¥è§¦Entity            â”‚
â”‚  âŒ ä¸èƒ½æœ‰æ•°æ®åº“æ“ä½œ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Service å±‚                  â”‚
â”‚  - ä¸šåŠ¡é€»è¾‘å¤„ç†                      â”‚
â”‚  - @Transactionaläº‹åŠ¡æ§åˆ¶            â”‚
â”‚  - åŠ è½½éœ€è¦çš„æ‰€æœ‰æ•°æ®                 â”‚
â”‚  - Entityè½¬DTOåå†è¿”å›               â”‚
â”‚  âœ… äº‹åŠ¡è¾¹ç•Œåœ¨è¿™é‡Œ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Repository å±‚                 â”‚
â”‚  - æ•°æ®åº“è®¿é—®                        â”‚
â”‚  - åªè´Ÿè´£CRUD                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. ğŸ“Š æ€§èƒ½å½±å“åˆ†æ


### 6.1 OSIVå¯¹æ€§èƒ½çš„å½±å“


**ğŸ”¸ è¿æ¥å ç”¨æ—¶é—´å¯¹æ¯”**

| åœºæ™¯ | **OSIV=false** | **OSIV=true** | **å½±å“** |
|------|---------------|--------------|---------|
| ğŸ”¹ **ç®€å•æŸ¥è¯¢** | `10ms` | `50ms` | `è¿æ¥å ç”¨æ—¶é—´å¢åŠ 5å€` |
| ğŸ”¹ **å¤æ‚ä¸šåŠ¡** | `100ms` | `500ms` | `å¯èƒ½å¯¼è‡´è¿æ¥æ± è€—å°½` |
| ğŸ”¹ **é«˜å¹¶å‘** | `1000 QPS` | `200 QPS` | `ååé‡æ˜¾è‘—ä¸‹é™` |

**ğŸ”¸ è¿æ¥å ç”¨ç¤ºæ„å›¾**

```
ã€OSIV=false è¿æ¥ä½¿ç”¨æƒ…å†µã€‘
è¯·æ±‚1: â”€â”€[è·å–è¿æ¥]â”€[æŸ¥è¯¢]â”€[é‡Šæ”¾]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¯·æ±‚2: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[è·å–]â”€[æŸ¥è¯¢]â”€[é‡Šæ”¾]â”€â”€
è¯·æ±‚3: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[è·å–]â”€[æŸ¥è¯¢]â”€[é‡Šæ”¾]
                           
è¿æ¥å¤ç”¨å¿«ï¼Œæ”¯æŒé«˜å¹¶å‘ âœ…

ã€OSIV=true è¿æ¥ä½¿ç”¨æƒ…å†µã€‘  
è¯·æ±‚1: â”€â”€[è·å–è¿æ¥]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[é‡Šæ”¾]â”€â”€
è¯·æ±‚2: â”€â”€â”€â”€[ç­‰å¾…]â”€â”€â”€â”€â”€[è·å–]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[é‡Šæ”¾]
è¯·æ±‚3: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ç­‰å¾…]â”€â”€â”€â”€â”€â”€â”€â”€â”€[è·å–]â”€â”€â”€â”€â”€â”€[é‡Šæ”¾]

è¿æ¥é•¿æœŸå ç”¨ï¼Œå¹¶å‘èƒ½åŠ›å·® âŒ
```

### 6.2 N+1æŸ¥è¯¢é—®é¢˜


**ğŸ”¸ é—®é¢˜æ¼”ç¤º**

```java
// OSIV=trueæ—¶ï¼Œè¿™æ ·å†™ä¼šäº§ç”ŸN+1æŸ¥è¯¢
@GetMapping("/users")
public List<UserDTO> getUsers() {
    List<User> users = userService.getAllUsers(); // 1æ¬¡æŸ¥è¯¢
    
    return users.stream()
        .map(user -> {
            // æ¯ä¸ªuserè®¿é—®orderséƒ½ä¼šè§¦å‘1æ¬¡æŸ¥è¯¢
            // å¦‚æœæœ‰100ä¸ªç”¨æˆ·ï¼Œå°±æ˜¯100æ¬¡æŸ¥è¯¢ï¼
            int orderCount = user.getOrders().size();
            return new UserDTO(user, orderCount);
        })
        .collect(Collectors.toList());
}
```

**ğŸ”¸ SQLæ‰§è¡Œæƒ…å†µ**

```sql
-- ç¬¬1æ¬¡æŸ¥è¯¢ï¼šè·å–æ‰€æœ‰ç”¨æˆ·
SELECT * FROM user;  

-- ç¬¬2æ¬¡æŸ¥è¯¢ï¼šè·å–ç”¨æˆ·1çš„è®¢å•
SELECT * FROM orders WHERE user_id = 1;

-- ç¬¬3æ¬¡æŸ¥è¯¢ï¼šè·å–ç”¨æˆ·2çš„è®¢å•  
SELECT * FROM orders WHERE user_id = 2;

-- ...
-- ç¬¬101æ¬¡æŸ¥è¯¢ï¼šè·å–ç”¨æˆ·100çš„è®¢å•
SELECT * FROM orders WHERE user_id = 100;

æ€»è®¡ï¼š1 + 100 = 101æ¬¡æŸ¥è¯¢ï¼
```

### 6.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ğŸ”¸ ä¼˜åŒ–ç­–ç•¥å¯¹æ¯”**

| ç­–ç•¥ | **å®ç°æ–¹å¼** | **æŸ¥è¯¢æ¬¡æ•°** | **æ€§èƒ½** |
|------|------------|------------|---------|
| âŒ **OSIVæ‡’åŠ è½½** | `Controllerè®¿é—®æ‡’åŠ è½½` | `1 + Næ¬¡` | `æå·®` |
| âœ… **JOIN FETCH** | `JPQL: JOIN FETCH` | `1æ¬¡` | `ä¼˜ç§€` |
| âœ… **EntityGraph** | `@EntityGraph` | `1æ¬¡` | `ä¼˜ç§€` |
| âœ… **æ‰¹é‡æŸ¥è¯¢** | `INæŸ¥è¯¢` | `2æ¬¡` | `è‰¯å¥½` |

**ğŸ”¸ ä¼˜åŒ–ç¤ºä¾‹**

```java
// ä¼˜åŒ–æ–¹æ¡ˆ1ï¼šJOIN FETCH
@Query("SELECT u FROM User u JOIN FETCH u.orders WHERE u.id IN :ids")
List<User> findUsersWithOrders(@Param("ids") List<Long> ids);

// ä¼˜åŒ–æ–¹æ¡ˆ2ï¼šEntityGraph
@EntityGraph(attributePaths = {"orders"})
List<User> findAll();

// ä¼˜åŒ–æ–¹æ¡ˆ3ï¼šåˆ†æ‰¹æŸ¥è¯¢
List<User> users = userRepository.findAll();
List<Long> userIds = users.stream()
    .map(User::getId)
    .collect(Collectors.toList());
List<Order> allOrders = orderRepository.findByUserIdIn(userIds);
// æ‰‹åŠ¨ç»„è£…æ•°æ®
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å…³é”®æ¦‚å¿µç†è§£


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”**

```
äº‹åŠ¡è¾¹ç•Œ vs Sessionè¾¹ç•Œ

äº‹åŠ¡è¾¹ç•Œï¼ˆTransaction Boundaryï¼‰ï¼š
- èƒ½å¤Ÿä¿®æ”¹æ•°æ®çš„èŒƒå›´
- ç”±@Transactionalæ§åˆ¶
- é€šå¸¸åœ¨Serviceå±‚

Sessionè¾¹ç•Œï¼ˆSession Boundaryï¼‰ï¼š
- èƒ½å¤ŸæŸ¥è¯¢æ•°æ®çš„èŒƒå›´  
- ç”±OSIVæ§åˆ¶
- å¯ä»¥å»¶ä¼¸åˆ°Controllerå±‚
```

**ğŸ”¸ OSIVæœºåˆ¶æœ¬è´¨**

> ğŸ’¡ **ä¸€å¥è¯ç†è§£**  
> OSIVå°±æ˜¯è®©æ•°æ®åº“è¿æ¥æ´»å¾—ä¹…ä¸€ç‚¹ï¼Œæ–¹ä¾¿è®¿é—®æ‡’åŠ è½½å±æ€§ï¼Œä½†ä»£ä»·æ˜¯å ç”¨è¿æ¥æ—¶é—´é•¿ï¼Œå¯èƒ½å½±å“æ€§èƒ½ã€‚

### 7.2 å®æˆ˜ä½¿ç”¨å»ºè®®


**ğŸ¯ æ¨èé…ç½®**

```yaml
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®

spring:
  jpa:
    open-in-view: false  # å…³é—­OSIVï¼Œæ€§èƒ½ä¼˜å…ˆ
```

**ğŸ¯ ç¼–ç åŸåˆ™**

```
âœ… æ­£ç¡®åšæ³•ï¼š
1. Serviceå±‚åŠ è½½æ‰€æœ‰éœ€è¦çš„æ•°æ®
2. Serviceå±‚è½¬æ¢ä¸ºDTO
3. Controlleråªå¤„ç†DTO
4. ä½¿ç”¨EntityGraphæˆ–JOIN FETCHä¼˜åŒ–æŸ¥è¯¢

âŒ é”™è¯¯åšæ³•ï¼š
1. ä¾èµ–OSIVè§£å†³æ‡’åŠ è½½
2. Controllerè®¿é—®Entityçš„æ‡’åŠ è½½å±æ€§
3. è®©æŸ¥è¯¢å»¶è¿Ÿåˆ°Viewå±‚
4. ä¸å…³å¿ƒN+1æŸ¥è¯¢é—®é¢˜
```

### 7.3 é—®é¢˜å¤„ç†æµç¨‹


**ğŸ”¸ é‡åˆ°LazyInitializationExceptionæ€ä¹ˆåŠ**

```
é—®é¢˜è¯Šæ–­æµç¨‹ï¼š

1ï¸âƒ£ æ£€æŸ¥OSIVé…ç½®
   â”œâ”€ å¦‚æœæ˜¯false â†’ ç¬¦åˆé¢„æœŸ
   â””â”€ å¦‚æœæ˜¯true â†’ æ£€æŸ¥ä»£ç é€»è¾‘

2ï¸âƒ£ æ‰¾åˆ°è®¿é—®æ‡’åŠ è½½çš„ä½ç½®
   â”œâ”€ åœ¨Serviceå±‚ â†’ ç¡®ä¿åœ¨@Transactionalæ–¹æ³•å†…
   â””â”€ åœ¨Controllerå±‚ â†’ éœ€è¦ä¿®æ”¹ä»£ç 

3ï¸âƒ£ é€‰æ‹©è§£å†³æ–¹æ¡ˆ
   â”œâ”€ æ–¹æ¡ˆ1ï¼šServiceå±‚åŠ è½½æ•°æ®
   â”œâ”€ æ–¹æ¡ˆ2ï¼šä½¿ç”¨DTOè½¬æ¢
   â”œâ”€ æ–¹æ¡ˆ3ï¼šEntityGraph
   â””â”€ æ–¹æ¡ˆ4ï¼šJOIN FETCHæŸ¥è¯¢
```

### 7.4 è®°å¿†è¦ç‚¹


**ğŸ§  æ ¸å¿ƒè®°å¿†**

```
OSIVä¸‰è¦ç´ ï¼š
1. Openï¼ˆå¼€å¯ï¼‰- ä¿æŒè¿æ¥æ‰“å¼€
2. Sessionï¼ˆä¼šè¯ï¼‰- å»¶é•¿çš„æ˜¯ä¼šè¯ä¸æ˜¯äº‹åŠ¡
3. Viewï¼ˆè§†å›¾ï¼‰- å»¶é•¿åˆ°Controller/Viewå±‚

æ‡’åŠ è½½å¼‚å¸¸ï¼š
- åŸå› ï¼šSessionå…³é—­åè®¿é—®æ‡’åŠ è½½
- ç—‡çŠ¶ï¼šLazyInitializationException
- è§£å†³ï¼šåœ¨äº‹åŠ¡å†…åŠ è½½æˆ–ä½¿ç”¨DTO

æ€§èƒ½å½±å“ï¼š
- è¿æ¥å ç”¨æ—¶é—´é•¿
- å¯èƒ½N+1æŸ¥è¯¢
- å¹¶å‘èƒ½åŠ›ä¸‹é™
```

**ğŸ¯ æœ€ä½³å®è·µé€Ÿè®°**

| åœºæ™¯ | **æ¨èæ–¹æ¡ˆ** | **å…³é”®ç‚¹** |
|------|------------|----------|
| ğŸ”¹ **æ–°é¡¹ç›®** | `OSIV=false` | `ä»ä¸€å¼€å§‹å°±è§„èŒƒè®¾è®¡` |
| ğŸ”¹ **è€é¡¹ç›®** | `é€æ­¥è¿ç§»` | `å…ˆå…³é—­ï¼Œå†ä¿®å¤å¼‚å¸¸` |
| ğŸ”¹ **ç®€å•åº”ç”¨** | `OSIV=trueå¯æ¥å—` | `ç¡®ä¿å¹¶å‘é‡ä¸å¤§` |
| ğŸ”¹ **é«˜æ€§èƒ½åº”ç”¨** | `å¿…é¡»OSIV=false` | `ä¸¥æ ¼æ§åˆ¶äº‹åŠ¡è¾¹ç•Œ` |

---

**å­¦ä¹ æ£€æŸ¥æ¸…å•**

- [ ] ç†è§£äº‹åŠ¡è¾¹ç•Œå’ŒSessionè¾¹ç•Œçš„åŒºåˆ«
- [ ] çŸ¥é“OSIVçš„å·¥ä½œåŸç†å’Œä½œç”¨
- [ ] èƒ½è¯†åˆ«å’Œè§£å†³LazyInitializationException
- [ ] æŒæ¡OSIVçš„é…ç½®æ–¹æ³•
- [ ] äº†è§£OSIVå¯¹æ€§èƒ½çš„å½±å“
- [ ] ä¼šä½¿ç”¨DTOå’ŒEntityGraphä¼˜åŒ–æŸ¥è¯¢
- [ ] èƒ½åœ¨é¡¹ç›®ä¸­æ­£ç¡®è®¾è®¡äº‹åŠ¡è¾¹ç•Œ