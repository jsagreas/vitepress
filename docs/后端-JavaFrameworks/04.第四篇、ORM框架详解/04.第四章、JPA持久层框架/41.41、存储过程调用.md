---
title: 41ã€å­˜å‚¨è¿‡ç¨‹è°ƒç”¨
---
## ğŸ“š ç›®å½•

1. [å­˜å‚¨è¿‡ç¨‹åŸºç¡€æ¦‚å¿µ](#1-å­˜å‚¨è¿‡ç¨‹åŸºç¡€æ¦‚å¿µ)
2. [JPAè°ƒç”¨å­˜å‚¨è¿‡ç¨‹çš„æ–¹å¼](#2-JPAè°ƒç”¨å­˜å‚¨è¿‡ç¨‹çš„æ–¹å¼)
3. [å‚æ•°å¤„ç†è¯¦è§£](#3-å‚æ•°å¤„ç†è¯¦è§£)
4. [ç»“æœé›†å¤„ç†](#4-ç»“æœé›†å¤„ç†)
5. [å®æˆ˜åº”ç”¨åœºæ™¯](#5-å®æˆ˜åº”ç”¨åœºæ™¯)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å­˜å‚¨è¿‡ç¨‹åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å­˜å‚¨è¿‡ç¨‹


**ğŸ·ï¸ é€šä¿—ç†è§£**ï¼š
```
å­˜å‚¨è¿‡ç¨‹å°±åƒæ˜¯æ•°æ®åº“ä¸­é¢„å…ˆå†™å¥½çš„"ç¨‹åºè„šæœ¬"

ç”Ÿæ´»ç±»æ¯”ï¼š
- æ™®é€šSQLæŸ¥è¯¢ = æ¯æ¬¡éƒ½è¦ä»å¤´åšä¸€é“èœ
- å­˜å‚¨è¿‡ç¨‹ = æå‰å‡†å¤‡å¥½çš„"é¢„åˆ¶èœåŒ…"ï¼Œéœ€è¦æ—¶ç›´æ¥åŠ çƒ­

ä¼˜åŠ¿ï¼š
âœ… ç¼–è¯‘ä¸€æ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œï¼Œæ€§èƒ½æ›´å¥½
âœ… å‡å°‘ç½‘ç»œä¼ è¾“ï¼ˆä¸ç”¨æ¯æ¬¡å‘é€é•¿SQLï¼‰
âœ… å°è£…å¤æ‚ä¸šåŠ¡é€»è¾‘
âœ… æé«˜å®‰å…¨æ€§ï¼ˆé€šè¿‡æƒé™æ§åˆ¶ï¼‰
```

**ğŸ’­ ä¸ºä»€ä¹ˆéœ€è¦å­˜å‚¨è¿‡ç¨‹**ï¼š
```
é€‚ç”¨åœºæ™¯ï¼š
1. å¤æ‚çš„æ•°æ®å¤„ç†é€»è¾‘ï¼ˆå¤šè¡¨å…³è”ã€æ¡ä»¶åˆ¤æ–­ï¼‰
2. æ‰¹é‡æ•°æ®æ“ä½œï¼ˆå¤§é‡æ’å…¥ã€æ›´æ–°ï¼‰
3. å®šæ—¶ä»»åŠ¡æ‰§è¡Œ
4. éœ€è¦æ•°æ®åº“ç«¯è®¡ç®—çš„åœºæ™¯

ç¤ºä¾‹ï¼š
ç”µå•†ç³»ç»Ÿçš„è®¢å•ç»“ç®—ï¼š
- éœ€è¦æ›´æ–°è®¢å•çŠ¶æ€
- æ‰£å‡åº“å­˜
- ç”Ÿæˆç‰©æµå•
- è®¡ç®—ç§¯åˆ†
â†’ è¿™äº›æ“ä½œæ”¾åœ¨ä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹ä¸­ï¼Œä¿è¯äº‹åŠ¡ä¸€è‡´æ€§
```

### 1.2 å­˜å‚¨è¿‡ç¨‹çš„åŸºæœ¬ç»“æ„


**ğŸ“‹ å­˜å‚¨è¿‡ç¨‹ç¤ºä¾‹ï¼ˆMySQLï¼‰**ï¼š
```sql
-- åˆ›å»ºä¸€ä¸ªç®€å•çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER $$

CREATE PROCEDURE getUserInfo(
    IN userId INT,              -- è¾“å…¥å‚æ•°
    OUT userName VARCHAR(50),   -- è¾“å‡ºå‚æ•°
    OUT userAge INT
)
BEGIN
    SELECT name, age 
    INTO userName, userAge
    FROM users 
    WHERE id = userId;
END$$

DELIMITER ;
```

**ğŸ” æ·±å…¥ç†è§£**ï¼š
```
å­˜å‚¨è¿‡ç¨‹çš„ä¸‰è¦ç´ ï¼š

1. å‚æ•°ç±»å‹ï¼š
   IN    â†’ è¾“å…¥å‚æ•°ï¼ˆJavaè°ƒç”¨æ—¶ä¼ å…¥ï¼‰
   OUT   â†’ è¾“å‡ºå‚æ•°ï¼ˆJavaè°ƒç”¨åè·å–ï¼‰
   INOUT â†’ æ—¢å¯è¾“å…¥ä¹Ÿå¯è¾“å‡º

2. ä¸šåŠ¡é€»è¾‘ï¼š
   BEGIN...END ä¹‹é—´çš„SQLè¯­å¥å’Œé€»è¾‘æ§åˆ¶

3. è¿”å›æ–¹å¼ï¼š
   - é€šè¿‡OUTå‚æ•°è¿”å›å•ä¸ªå€¼
   - é€šè¿‡ResultSetè¿”å›æŸ¥è¯¢ç»“æœ
   - å¯ä»¥åŒæ—¶è¿”å›å¤šä¸ªç»“æœé›†
```

---

## 2. âš™ï¸ JPAè°ƒç”¨å­˜å‚¨è¿‡ç¨‹çš„æ–¹å¼


### 2.1 æ–¹å¼ä¸€ï¼š@NamedStoredProcedureQueryæ³¨è§£


**ğŸ“ å­¦ä¹ ç›®æ ‡**ï¼šæŒæ¡åœ¨å®ä½“ç±»ä¸Šå£°æ˜å­˜å‚¨è¿‡ç¨‹æ˜ å°„

**ğŸ“ åŸºç¡€ç”¨æ³•**ï¼š
```java
@Entity
@Table(name = "users")
@NamedStoredProcedureQuery(
    name = "User.getUserInfo",           // ç»™è¿™ä¸ªå­˜å‚¨è¿‡ç¨‹è°ƒç”¨èµ·ä¸ªåå­—
    procedureName = "getUserInfo",       // æ•°æ®åº“ä¸­å®é™…çš„å­˜å‚¨è¿‡ç¨‹å
    parameters = {
        @StoredProcedureParameter(
            name = "userId",             // å‚æ•°å
            type = Integer.class,        // å‚æ•°ç±»å‹
            mode = ParameterMode.IN      // è¾“å…¥å‚æ•°
        ),
        @StoredProcedureParameter(
            name = "userName",
            type = String.class,
            mode = ParameterMode.OUT     // è¾“å‡ºå‚æ•°
        ),
        @StoredProcedureParameter(
            name = "userAge",
            type = Integer.class,
            mode = ParameterMode.OUT
        )
    }
)
public class User {
    @Id
    private Integer id;
    private String name;
    private Integer age;
    // getters and setters
}
```

**ğŸ’¡ å…³é”®ç‚¹è§£é‡Š**ï¼š

| å±æ€§ | è¯´æ˜ | ä¸¾ä¾‹ |
|------|------|------|
| **name** | JPAä¸­ä½¿ç”¨çš„é€»è¾‘åç§° | `"User.getUserInfo"` |
| **procedureName** | æ•°æ®åº“ä¸­çš„å®é™…å­˜å‚¨è¿‡ç¨‹å | `"getUserInfo"` |
| **parameters** | å‚æ•°å®šä¹‰æ•°ç»„ | åŒ…å«IN/OUT/INOUTå‚æ•° |
| **resultClasses** | è¿”å›çš„å®ä½“ç±»å‹ï¼ˆæŸ¥è¯¢åœºæ™¯ï¼‰ | `User.class` |

**ğŸ”§ ä½¿ç”¨æ–¹å¼**ï¼š
```java
@Service
public class UserService {
    
    @PersistenceContext
    private EntityManager em;
    
    public Map<String, Object> getUserInfo(Integer userId) {
        // é€šè¿‡åç§°åˆ›å»ºå­˜å‚¨è¿‡ç¨‹æŸ¥è¯¢
        StoredProcedureQuery query = em.createNamedStoredProcedureQuery("User.getUserInfo");
        
        // è®¾ç½®è¾“å…¥å‚æ•°
        query.setParameter("userId", userId);
        
        // æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹
        query.execute();
        
        // è·å–è¾“å‡ºå‚æ•°
        String userName = (String) query.getOutputParameterValue("userName");
        Integer userAge = (Integer) query.getOutputParameterValue("userAge");
        
        // è¿”å›ç»“æœ
        Map<String, Object> result = new HashMap<>();
        result.put("userName", userName);
        result.put("userAge", userAge);
        return result;
    }
}
```

### 2.2 æ–¹å¼äºŒï¼šåŠ¨æ€åˆ›å»ºStoredProcedureQuery


**ğŸŒ° ä¸¾ä¸ªä¾‹å­**ï¼šä¸åœ¨å®ä½“ç±»ä¸Šé¢„å®šä¹‰ï¼Œç›´æ¥åœ¨ä»£ç ä¸­è°ƒç”¨

```java
@Service
public class UserService {
    
    @PersistenceContext
    private EntityManager em;
    
    public Map<String, Object> getDynamicUserInfo(Integer userId) {
        // åŠ¨æ€åˆ›å»ºå­˜å‚¨è¿‡ç¨‹æŸ¥è¯¢
        StoredProcedureQuery query = em.createStoredProcedureQuery("getUserInfo");
        
        // æ³¨å†Œå‚æ•°
        query.registerStoredProcedureParameter("userId", Integer.class, ParameterMode.IN);
        query.registerStoredProcedureParameter("userName", String.class, ParameterMode.OUT);
        query.registerStoredProcedureParameter("userAge", Integer.class, ParameterMode.OUT);
        
        // è®¾ç½®è¾“å…¥å‚æ•°
        query.setParameter("userId", userId);
        
        // æ‰§è¡Œ
        query.execute();
        
        // è·å–è¾“å‡º
        Map<String, Object> result = new HashMap<>();
        result.put("userName", query.getOutputParameterValue("userName"));
        result.put("userAge", query.getOutputParameterValue("userAge"));
        return result;
    }
}
```

**ğŸ”„ ä¸¤ç§æ–¹å¼å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | @NamedStoredProcedureQuery | åŠ¨æ€åˆ›å»º |
|------|---------------------------|----------|
| **å®šä¹‰ä½ç½®** | å®ä½“ç±»ä¸Šï¼Œå¯åŠ¨æ—¶åŠ è½½ | ä»£ç ä¸­åŠ¨æ€åˆ›å»º |
| **æ€§èƒ½** | æ›´å¥½ï¼ˆé¢„ç¼–è¯‘ï¼‰ | ç•¥å·®ï¼ˆæ¯æ¬¡åˆ›å»ºï¼‰ |
| **çµæ´»æ€§** | è¾ƒä½ï¼ˆå›ºå®šé…ç½®ï¼‰ | é«˜ï¼ˆå¯åŠ¨æ€è°ƒæ•´ï¼‰ |
| **ç»´æŠ¤æ€§** | é›†ä¸­ç®¡ç†ï¼Œæ¸…æ™° | åˆ†æ•£åœ¨ä»£ç ä¸­ |
| **é€‚ç”¨åœºæ™¯** | å¸¸ç”¨çš„å›ºå®šå­˜å‚¨è¿‡ç¨‹ | ä¸´æ—¶æˆ–åŠ¨æ€çš„è°ƒç”¨ |

---

## 3. ğŸ”§ å‚æ•°å¤„ç†è¯¦è§£


### 3.1 ä¸‰ç§å‚æ•°ç±»å‹


**ğŸ“– å‚æ•°æ¨¡å¼è¯´æ˜**ï¼š

```
å­˜å‚¨è¿‡ç¨‹å‚æ•°æ–¹å‘ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Javaåº”ç”¨ç¨‹åº               â”‚
â”‚                                     â”‚
â”‚  INå‚æ•°  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                             â†“       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      æ•°æ®åº“å­˜å‚¨è¿‡ç¨‹         â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚  BEGIN                      â”‚   â”‚
â”‚  â”‚    å¤„ç†ä¸šåŠ¡é€»è¾‘...          â”‚   â”‚
â”‚  â”‚  END                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â†‘       â”‚
â”‚  OUTå‚æ•° â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                     â”‚
â”‚  INOUTå‚æ•° â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’        â”‚
â”‚           (åŒå‘ä¼ é€’)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ å®æˆ˜ç¤ºä¾‹**ï¼š
```java
// ç¤ºä¾‹å­˜å‚¨è¿‡ç¨‹ï¼šè®¡ç®—ç”¨æˆ·è®¢å•æ€»é‡‘é¢å¹¶æ›´æ–°ç§¯åˆ†
@NamedStoredProcedureQuery(
    name = "Order.calculateTotal",
    procedureName = "calculateOrderTotal",
    parameters = {
        @StoredProcedureParameter(
            name = "orderId",
            type = Long.class,
            mode = ParameterMode.IN        // è¾“å…¥ï¼šè®¢å•ID
        ),
        @StoredProcedureParameter(
            name = "discountRate",
            type = Double.class,
            mode = ParameterMode.INOUT     // è¾“å…¥æŠ˜æ‰£ç‡ï¼Œè¾“å‡ºå®é™…æŠ˜æ‰£ç‡
        ),
        @StoredProcedureParameter(
            name = "totalAmount",
            type = BigDecimal.class,
            mode = ParameterMode.OUT       // è¾“å‡ºï¼šæ€»é‡‘é¢
        ),
        @StoredProcedureParameter(
            name = "earnedPoints",
            type = Integer.class,
            mode = ParameterMode.OUT       // è¾“å‡ºï¼šè·å¾—ç§¯åˆ†
        )
    }
)
```

**ğŸ” ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
public OrderResult calculateOrder(Long orderId, Double discountRate) {
    StoredProcedureQuery query = em.createNamedStoredProcedureQuery("Order.calculateTotal");
    
    // è®¾ç½®INå‚æ•°
    query.setParameter("orderId", orderId);
    
    // è®¾ç½®INOUTå‚æ•°ï¼ˆæ—¢è¦è¾“å…¥ä¹Ÿè¦è¾“å‡ºï¼‰
    query.setParameter("discountRate", discountRate);
    
    // æ‰§è¡Œ
    query.execute();
    
    // è·å–INOUTå‚æ•°çš„è¾“å‡ºå€¼ï¼ˆå¯èƒ½å·²è¢«å­˜å‚¨è¿‡ç¨‹ä¿®æ”¹ï¼‰
    Double actualDiscount = (Double) query.getOutputParameterValue("discountRate");
    
    // è·å–OUTå‚æ•°
    BigDecimal total = (BigDecimal) query.getOutputParameterValue("totalAmount");
    Integer points = (Integer) query.getOutputParameterValue("earnedPoints");
    
    return new OrderResult(total, points, actualDiscount);
}
```

### 3.2 å‚æ•°å‘½åä¸ä½ç½®


**âš ï¸ é‡è¦æé†’**ï¼š

```
å‚æ•°ä¼ é€’çš„ä¸¤ç§æ–¹å¼ï¼š

æ–¹å¼1ï¼šæŒ‰åç§°ä¼ é€’ï¼ˆæ¨èï¼‰
âœ… æ¸…æ™°æ˜“è¯»
âœ… é¡ºåºæ— å…³
âœ… é€‚åˆå‚æ•°è¾ƒå¤šçš„åœºæ™¯

query.setParameter("userId", 123);
query.getOutputParameterValue("userName");

æ–¹å¼2ï¼šæŒ‰ä½ç½®ä¼ é€’
âŒ å®¹æ˜“å‡ºé”™
âŒ é¡ºåºæ•æ„Ÿ
âŒ ä»£ç å¯è¯»æ€§å·®

query.setParameter(1, 123);
query.getOutputParameterValue(2);
```

**ğŸ¯ æœ€ä½³å®è·µ**ï¼š
```java
// æ¨èï¼šä½¿ç”¨å‘½åå‚æ•°
StoredProcedureQuery query = em.createStoredProcedureQuery("getUserInfo");
query.registerStoredProcedureParameter("userId", Integer.class, ParameterMode.IN);
query.registerStoredProcedureParameter("userName", String.class, ParameterMode.OUT);
query.setParameter("userId", 123);
String name = (String) query.getOutputParameterValue("userName");

// é¿å…ï¼šä½¿ç”¨ä½ç½®å‚æ•°ï¼ˆé™¤éå­˜å‚¨è¿‡ç¨‹æœ¬èº«ä¸æ”¯æŒå‘½åï¼‰
query.registerStoredProcedureParameter(1, Integer.class, ParameterMode.IN);
query.setParameter(1, 123);
```

---

## 4. ğŸ“Š ç»“æœé›†å¤„ç†


### 4.1 è¿”å›å®ä½“å¯¹è±¡


**ğŸŒ° åœºæ™¯ç¤ºä¾‹**ï¼šæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨

**æ•°æ®åº“å­˜å‚¨è¿‡ç¨‹**ï¼š
```sql
CREATE PROCEDURE getUserList(IN deptId INT)
BEGIN
    SELECT id, name, age, email
    FROM users
    WHERE department_id = deptId;
END
```

**Javaå®ä½“æ˜ å°„**ï¼š
```java
@Entity
@NamedStoredProcedureQuery(
    name = "User.getUserList",
    procedureName = "getUserList",
    resultClasses = User.class,    // æŒ‡å®šè¿”å›çš„å®ä½“ç±»å‹
    parameters = {
        @StoredProcedureParameter(
            name = "deptId",
            type = Integer.class,
            mode = ParameterMode.IN
        )
    }
)
public class User {
    @Id
    private Integer id;
    private String name;
    private Integer age;
    private String email;
    // getters and setters
}
```

**è°ƒç”¨ä»£ç **ï¼š
```java
public List<User> getUsersByDept(Integer deptId) {
    StoredProcedureQuery query = em.createNamedStoredProcedureQuery("User.getUserList");
    query.setParameter("deptId", deptId);
    
    // è·å–ç»“æœåˆ—è¡¨
    List<User> users = query.getResultList();
    return users;
}
```

### 4.2 è¿”å›å¤šä¸ªç»“æœé›†


**ğŸ’­ æ€è€ƒä¸€ä¸‹**ï¼šæœ‰äº›å­˜å‚¨è¿‡ç¨‹ä¼šè¿”å›å¤šä¸ªæŸ¥è¯¢ç»“æœï¼Œæ€ä¹ˆå¤„ç†ï¼Ÿ

**å­˜å‚¨è¿‡ç¨‹ç¤ºä¾‹**ï¼š
```sql
CREATE PROCEDURE getOrderSummary(IN userId INT)
BEGIN
    -- ç¬¬ä¸€ä¸ªç»“æœé›†ï¼šç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    SELECT id, name, email FROM users WHERE id = userId;
    
    -- ç¬¬äºŒä¸ªç»“æœé›†ï¼šè¯¥ç”¨æˆ·çš„è®¢å•åˆ—è¡¨
    SELECT order_id, order_date, total_amount 
    FROM orders 
    WHERE user_id = userId;
    
    -- ç¬¬ä¸‰ä¸ªç»“æœé›†ï¼šè®¢å•ç»Ÿè®¡
    SELECT COUNT(*) as orderCount, SUM(total_amount) as totalSpent
    FROM orders
    WHERE user_id = userId;
END
```

**å¤„ç†å¤šç»“æœé›†**ï¼š
```java
public OrderSummaryDTO getOrderSummary(Integer userId) {
    StoredProcedureQuery query = em.createStoredProcedureQuery("getOrderSummary");
    query.registerStoredProcedureParameter("userId", Integer.class, ParameterMode.IN);
    query.setParameter("userId", userId);
    
    boolean hasResult = query.execute();
    
    OrderSummaryDTO summary = new OrderSummaryDTO();
    
    // å¤„ç†ç¬¬ä¸€ä¸ªç»“æœé›†ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰
    if (hasResult) {
        List<Object[]> userInfo = query.getResultList();
        if (!userInfo.isEmpty()) {
            Object[] row = userInfo.get(0);
            summary.setUserId((Integer) row[0]);
            summary.setUserName((String) row[1]);
            summary.setEmail((String) row[2]);
        }
    }
    
    // ç§»åŠ¨åˆ°ç¬¬äºŒä¸ªç»“æœé›†ï¼ˆè®¢å•åˆ—è¡¨ï¼‰
    hasResult = query.hasMoreResults();
    if (hasResult) {
        List<Object[]> orders = query.getResultList();
        summary.setOrders(orders);
    }
    
    // ç§»åŠ¨åˆ°ç¬¬ä¸‰ä¸ªç»“æœé›†ï¼ˆç»Ÿè®¡ä¿¡æ¯ï¼‰
    hasResult = query.hasMoreResults();
    if (hasResult) {
        List<Object[]> stats = query.getResultList();
        if (!stats.isEmpty()) {
            Object[] row = stats.get(0);
            summary.setOrderCount((Long) row[0]);
            summary.setTotalSpent((BigDecimal) row[1]);
        }
    }
    
    return summary;
}
```

**ğŸ”‘ å…³é”®æ–¹æ³•è¯´æ˜**ï¼š

| æ–¹æ³• | ä½œç”¨ | è¿”å›å€¼ |
|------|------|--------|
| `execute()` | æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹ | æ˜¯å¦æœ‰ç»“æœé›†ï¼ˆtrue/falseï¼‰ |
| `getResultList()` | è·å–å½“å‰ç»“æœé›† | Listå¯¹è±¡ |
| `hasMoreResults()` | æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€ä¸ªç»“æœé›† | true/false |
| `getUpdateCount()` | è·å–æ›´æ–°è¡Œæ•° | intï¼ˆ-1è¡¨ç¤ºæ— æ›´æ–°ï¼‰ |

### 4.3 è¿”å›ç®€å•å€¼ç±»å‹


**ğŸ“‹ åœºæ™¯**ï¼šå­˜å‚¨è¿‡ç¨‹åªè¿”å›å•ä¸ªç»Ÿè®¡å€¼

```java
// å­˜å‚¨è¿‡ç¨‹ï¼šSELECT COUNT(*) FROM users WHERE status = 'active'
public Long getActiveUserCount() {
    StoredProcedureQuery query = em.createStoredProcedureQuery("getActiveUserCount");
    query.execute();
    
    // è·å–å•ä¸ªç»“æœ
    Long count = (Long) query.getSingleResult();
    return count;
}
```

---

## 5. ğŸ› ï¸ å®æˆ˜åº”ç”¨åœºæ™¯


### 5.1 æ‰¹é‡æ•°æ®å¤„ç†


**ğŸ¢ å®é™…åº”ç”¨**ï¼šæœˆåº¦è®¢å•ç»“ç®—

```java
@NamedStoredProcedureQuery(
    name = "Order.monthlySettle",
    procedureName = "monthly_order_settlement",
    parameters = {
        @StoredProcedureParameter(
            name = "yearMonth",
            type = String.class,
            mode = ParameterMode.IN
        ),
        @StoredProcedureParameter(
            name = "processedCount",
            type = Integer.class,
            mode = ParameterMode.OUT
        ),
        @StoredProcedureParameter(
            name = "totalAmount",
            type = BigDecimal.class,
            mode = ParameterMode.OUT
        )
    }
)
```

**è°ƒç”¨é€»è¾‘**ï¼š
```java
public SettlementResult settleMonthlyOrders(String yearMonth) {
    StoredProcedureQuery query = em.createNamedStoredProcedureQuery("Order.monthlySettle");
    query.setParameter("yearMonth", yearMonth);
    query.execute();
    
    Integer count = (Integer) query.getOutputParameterValue("processedCount");
    BigDecimal amount = (BigDecimal) query.getOutputParameterValue("totalAmount");
    
    return new SettlementResult(yearMonth, count, amount);
}
```

### 5.2 å¤æ‚ä¸šåŠ¡é€»è¾‘å°è£…


**ğŸ® åœºæ™¯æ¨¡æ‹Ÿ**ï¼šç”µå•†ä¸‹å•æµç¨‹

```
è®¢å•åˆ›å»ºå­˜å‚¨è¿‡ç¨‹æ‰§è¡Œæµç¨‹ï¼š

ç”¨æˆ·ä¸‹å•
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. æ£€æŸ¥åº“å­˜            â”‚
â”‚  2. é”å®šå•†å“            â”‚
â”‚  3. åˆ›å»ºè®¢å•è®°å½•        â”‚
â”‚  4. æ‰£å‡åº“å­˜            â”‚
â”‚  5. ç”Ÿæˆæ”¯ä»˜å•          â”‚
â”‚  6. æ›´æ–°ç”¨æˆ·ç§¯åˆ†        â”‚
â”‚  7. è®°å½•æ“ä½œæ—¥å¿—        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å›è®¢å•IDå’Œæ”¯ä»˜ä¿¡æ¯
```

```java
@Service
public class OrderService {
    
    public OrderCreationResult createOrder(OrderRequest request) {
        StoredProcedureQuery query = em.createStoredProcedureQuery("createOrder");
        
        // è¾“å…¥å‚æ•°
        query.registerStoredProcedureParameter("userId", Long.class, ParameterMode.IN);
        query.registerStoredProcedureParameter("productId", Long.class, ParameterMode.IN);
        query.registerStoredProcedureParameter("quantity", Integer.class, ParameterMode.IN);
        
        // è¾“å‡ºå‚æ•°
        query.registerStoredProcedureParameter("orderId", Long.class, ParameterMode.OUT);
        query.registerStoredProcedureParameter("paymentId", String.class, ParameterMode.OUT);
        query.registerStoredProcedureParameter("errorCode", Integer.class, ParameterMode.OUT);
        query.registerStoredProcedureParameter("errorMsg", String.class, ParameterMode.OUT);
        
        query.setParameter("userId", request.getUserId());
        query.setParameter("productId", request.getProductId());
        query.setParameter("quantity", request.getQuantity());
        
        query.execute();
        
        Integer errorCode = (Integer) query.getOutputParameterValue("errorCode");
        
        if (errorCode != 0) {
            String errorMsg = (String) query.getOutputParameterValue("errorMsg");
            throw new BusinessException(errorMsg);
        }
        
        Long orderId = (Long) query.getOutputParameterValue("orderId");
        String paymentId = (String) query.getOutputParameterValue("paymentId");
        
        return new OrderCreationResult(orderId, paymentId);
    }
}
```

### 5.3 æ•°æ®åº“ç§»æ¤æ€§è€ƒè™‘


**âš ï¸ å®¹æ˜“å‡ºé”™**ï¼šä¸åŒæ•°æ®åº“çš„å­˜å‚¨è¿‡ç¨‹è¯­æ³•å·®å¼‚

```
æ•°æ®åº“å·®å¼‚å¯¹æ¯”ï¼š

MySQLï¼š
DELIMITER $$
CREATE PROCEDURE proc_name(IN param INT)
BEGIN
    SELECT * FROM users WHERE id = param;
END$$
DELIMITER ;

Oracleï¼š
CREATE OR REPLACE PROCEDURE proc_name(
    param IN NUMBER,
    result OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN result FOR
    SELECT * FROM users WHERE id = param;
END;

PostgreSQLï¼š
CREATE OR REPLACE FUNCTION proc_name(param INTEGER)
RETURNS TABLE(id INTEGER, name VARCHAR) AS $$
BEGIN
    RETURN QUERY
    SELECT id, name FROM users WHERE id = param;
END;
$$ LANGUAGE plpgsql;
```

**ğŸ¯ æœ€ä½³å®è·µ**ï¼š
```java
// 1. ä½¿ç”¨é…ç½®æ–‡ä»¶ç®¡ç†ä¸åŒæ•°æ®åº“çš„å­˜å‚¨è¿‡ç¨‹å
@Value("${db.procedure.getUserInfo}")
private String getUserInfoProcedure;

// 2. é€šè¿‡æ•°æ®åº“ç±»å‹åŠ¨æ€é€‰æ‹©
public List<User> getUserInfo(Integer userId) {
    String procedureName;
    
    if (isMySQL()) {
        procedureName = "getUserInfo";
    } else if (isOracle()) {
        procedureName = "PKG_USER.GET_INFO";
    } else {
        procedureName = "func_get_user_info";
    }
    
    StoredProcedureQuery query = em.createStoredProcedureQuery(procedureName);
    // ... åç»­å¤„ç†
}

// 3. æŠ½è±¡å±‚å°è£…
public interface StoredProcedureService {
    List<User> getUserInfo(Integer userId);
}

@Service
@Profile("mysql")
public class MySQLStoredProcedureService implements StoredProcedureService {
    // MySQLç‰¹å®šå®ç°
}

@Service
@Profile("oracle")
public class OracleStoredProcedureService implements StoredProcedureService {
    // Oracleç‰¹å®šå®ç°
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å­˜å‚¨è¿‡ç¨‹ = æ•°æ®åº“ä¸­é¢„ç¼–è¯‘çš„SQLç¨‹åºï¼Œæå‡æ€§èƒ½å’Œå®‰å…¨æ€§
ğŸ”¸ å‚æ•°æ¨¡å¼ï¼šINè¾“å…¥ã€OUTè¾“å‡ºã€INOUTåŒå‘
ğŸ”¸ ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼š@NamedStoredProcedureQueryæ³¨è§£ vs åŠ¨æ€åˆ›å»º
ğŸ”¸ ç»“æœå¤„ç†ï¼šå•ç»“æœé›†ã€å¤šç»“æœé›†ã€ç®€å•å€¼
ğŸ”¸ æ•°æ®åº“ç§»æ¤æ€§ï¼šæ³¨æ„ä¸åŒæ•°æ®åº“è¯­æ³•å·®å¼‚
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä½•æ—¶ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹**ï¼š
```
é€‚åˆï¼š
âœ… å¤æ‚çš„å¤šæ­¥éª¤äº‹åŠ¡æ“ä½œ
âœ… å¤§æ‰¹é‡æ•°æ®å¤„ç†
âœ… éœ€è¦æ•°æ®åº“ç«¯è®¡ç®—çš„é€»è¾‘
âœ… å¯¹æ€§èƒ½è¦æ±‚æé«˜çš„åœºæ™¯

ä¸é€‚åˆï¼š
âŒ ç®€å•çš„CRUDæ“ä½œï¼ˆç”¨JPAæ›´æ–¹ä¾¿ï¼‰
âŒ éœ€è¦é¢‘ç¹ä¿®æ”¹çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå­˜å‚¨è¿‡ç¨‹ä¿®æ”¹æˆæœ¬é«˜ï¼‰
âŒ è·¨æ•°æ®åº“ç§»æ¤çš„ç³»ç»Ÿï¼ˆè¯­æ³•å·®å¼‚å¤§ï¼‰
```

**ğŸ”¹ @NamedStoredProcedureQuery vs åŠ¨æ€åˆ›å»º**ï¼š
```
é€‰æ‹©å»ºè®®ï¼š
- å¸¸ç”¨ä¸”ç¨³å®šçš„å­˜å‚¨è¿‡ç¨‹ â†’ ä½¿ç”¨@NamedStoredProcedureQuery
- ä¸´æ—¶æˆ–åŠ¨æ€è°ƒç”¨ â†’ ä½¿ç”¨åŠ¨æ€åˆ›å»º
- å‚æ•°å¤æ‚å¤šå˜ â†’ ä½¿ç”¨åŠ¨æ€åˆ›å»º
- è¿½æ±‚æ€§èƒ½ â†’ ä½¿ç”¨@NamedStoredProcedureQueryï¼ˆé¢„ç¼–è¯‘ï¼‰
```

**ğŸ”¹ å‚æ•°å¤„ç†æŠ€å·§**ï¼š
```
1. ä¼˜å…ˆä½¿ç”¨å‘½åå‚æ•°ï¼Œæé«˜å¯è¯»æ€§
2. OUTå‚æ•°ç”¨äºè·å–å•ä¸ªè¿”å›å€¼
3. INOUTå‚æ•°ç”¨äºå€¼çš„åŒå‘ä¼ é€’ï¼ˆå¦‚ç´¯åŠ å™¨ï¼‰
4. å¤æ‚å¯¹è±¡è¿”å›ç”¨ResultSetï¼Œç®€å•å€¼ç”¨OUTå‚æ•°
```

### 6.3 å®æˆ˜å¼€å‘å»ºè®®


**ğŸ“ ä»£ç è§„èŒƒ**ï¼š
- ç»Ÿä¸€ç®¡ç†å­˜å‚¨è¿‡ç¨‹å®šä¹‰ï¼ˆç‹¬ç«‹çš„é…ç½®ç±»æˆ–å®ä½“ç±»ï¼‰
- å°è£…é€šç”¨çš„è°ƒç”¨é€»è¾‘ï¼ˆå‡å°‘é‡å¤ä»£ç ï¼‰
- å¼‚å¸¸å¤„ç†è¦å®Œå–„ï¼ˆå­˜å‚¨è¿‡ç¨‹æ‰§è¡Œå¯èƒ½å¤±è´¥ï¼‰
- åšå¥½æ—¥å¿—è®°å½•ï¼ˆä¾¿äºæ’æŸ¥é—®é¢˜ï¼‰

**ğŸ”§ è°ƒè¯•æŠ€å·§**ï¼š
- å…ˆåœ¨æ•°æ®åº“ä¸­æµ‹è¯•å­˜å‚¨è¿‡ç¨‹æ˜¯å¦æ­£å¸¸
- æ£€æŸ¥å‚æ•°åç§°æ˜¯å¦ä¸å­˜å‚¨è¿‡ç¨‹ä¸€è‡´
- æ³¨æ„å‚æ•°ç±»å‹åŒ¹é…ï¼ˆJavaç±»å‹ vs æ•°æ®åº“ç±»å‹ï¼‰
- ä½¿ç”¨æ—¥å¿—æ‰“å°å‚æ•°å€¼å’Œè¿”å›å€¼

**âš¡ æ€§èƒ½ä¼˜åŒ–**ï¼š
- å­˜å‚¨è¿‡ç¨‹å†…éƒ¨è¦æœ‰ç´¢å¼•ä¼˜åŒ–
- é¿å…åœ¨å¾ªç¯ä¸­è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
- æ‰¹é‡æ“ä½œä¼˜å…ˆè€ƒè™‘å­˜å‚¨è¿‡ç¨‹
- åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´

**æ ¸å¿ƒè®°å¿†**ï¼š
```
å­˜å‚¨è¿‡ç¨‹åƒé¢„åˆ¶èœï¼Œç¼–è¯‘ä¸€æ¬¡å¤šæ¬¡ç”¨
INä¼ å‚OUTå–å€¼ï¼ŒINOUTåŒå‘è¦åˆ†æ¸…
å‘½åå‚æ•°æ›´æ¸…æ™°ï¼Œç»“æœé›†å¤„ç†è¦ä»”ç»†
è·¨åº“ç§»æ¤éœ€è°¨æ…ï¼Œå°è£…æŠ½è±¡ä¿çµæ´»
```