---
title: 19ã€çº§è”æ“ä½œé…ç½®
---
## ğŸ“š ç›®å½•

1. [çº§è”æ“ä½œåŸºæœ¬æ¦‚å¿µ](#1-çº§è”æ“ä½œåŸºæœ¬æ¦‚å¿µ)
2. [å…­ç§çº§è”ç±»å‹è¯¦è§£](#2-å…­ç§çº§è”ç±»å‹è¯¦è§£)
3. [å­¤å„¿åˆ é™¤æœºåˆ¶](#3-å­¤å„¿åˆ é™¤æœºåˆ¶)
4. [çº§è”æ“ä½œå®æˆ˜åº”ç”¨](#4-çº§è”æ“ä½œå®æˆ˜åº”ç”¨)
5. [çº§è”åˆ é™¤é£é™©æ§åˆ¶](#5-çº§è”åˆ é™¤é£é™©æ§åˆ¶)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ çº§è”æ“ä½œåŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯çº§è”æ“ä½œ


**é€šä¿—ç†è§£**ï¼šçº§è”æ“ä½œå°±åƒ"è¿é”ååº”"

```
ç°å®åœºæ™¯ç±»æ¯”ï¼š
åˆ é™¤ä¸€ä¸ªéƒ¨é—¨ â†’ éƒ¨é—¨ä¸‹çš„å‘˜å·¥ä¹Ÿä¸€èµ·åˆ é™¤
ä¿å­˜ä¸€ä¸ªè®¢å• â†’ è®¢å•ä¸‹çš„å•†å“æ˜ç»†ä¹Ÿä¸€èµ·ä¿å­˜
å°±åƒæ¨å€’å¤šç±³è¯ºéª¨ç‰Œï¼Œä¸€ä¸ªæ“ä½œå¼•å‘ä¸€è¿ä¸²çš„è¿é”æ“ä½œ
```

**ğŸ”¸ æŠ€æœ¯å®šä¹‰**
- çº§è”ï¼ˆCascadeï¼‰ï¼šå¯¹ä¸»å®ä½“çš„æ“ä½œä¼šè‡ªåŠ¨ä¼ æ’­åˆ°å…³è”å®ä½“
- ç›®çš„ï¼šç®€åŒ–å¼€å‘ï¼Œé¿å…æ‰‹åŠ¨å¤„ç†å…³è”å¯¹è±¡çš„å¢åˆ æ”¹æ“ä½œ
- æ ¸å¿ƒï¼šé€šè¿‡ `@OneToMany`ã€`@ManyToOne` ç­‰æ³¨è§£çš„ `cascade` å±æ€§é…ç½®

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦çº§è”æ“ä½œ


**æ²¡æœ‰çº§è”çš„éº»çƒ¦åœºæ™¯**ï¼š
```java
// åœºæ™¯ï¼šä¿å­˜ä¸€ä¸ªè®¢å•å’Œå®ƒçš„å•†å“æ˜ç»†

// âŒ æ²¡æœ‰çº§è” - éœ€è¦æ‰‹åŠ¨ä¿å­˜æ¯ä¸ªå¯¹è±¡
Order order = new Order();
OrderItem item1 = new OrderItem();
OrderItem item2 = new OrderItem();

entityManager.persist(order);        // å…ˆä¿å­˜è®¢å•
entityManager.persist(item1);        // å†ä¿å­˜æ˜ç»†1
entityManager.persist(item2);        // å†ä¿å­˜æ˜ç»†2
// ä»£ç ç¹çï¼Œå®¹æ˜“é—æ¼
```

**ä½¿ç”¨çº§è”çš„ä¾¿æ·**ï¼š
```java
// âœ… æœ‰çº§è” - ä¸€æ¬¡æ€§æå®š
Order order = new Order();
order.addItem(new OrderItem());
order.addItem(new OrderItem());

entityManager.persist(order);  // è‡ªåŠ¨çº§è”ä¿å­˜æ‰€æœ‰æ˜ç»†
// ç®€å•æ¸…æ™°ï¼Œä¸ä¼šé—æ¼
```

### 1.3 çº§è”æ“ä½œçš„ä½œç”¨èŒƒå›´


**çº§è”ä¼ æ’­æ–¹å‘**ï¼š
```
å•å‘çº§è”ï¼š
Order â†’ OrderItem     è®¢å•å¯ä»¥çº§è”æ“ä½œæ˜ç»†
OrderItem â†› Order     æ˜ç»†ä¸èƒ½çº§è”æ“ä½œè®¢å•

åŒå‘çº§è”ï¼š
Order â†” OrderItem     äº’ç›¸éƒ½å¯ä»¥çº§è”æ“ä½œ
ï¼ˆé€šå¸¸ä¸æ¨èï¼Œå®¹æ˜“å‡ºé—®é¢˜ï¼‰
```

**âš ï¸ é‡è¦æé†’**
> çº§è”æ“ä½œæ˜¯"ä¼ æ’­"å…³ç³»ï¼Œä¸æ˜¯"å…±äº«"å…³ç³»
> - ä¸»å®ä½“çš„æ“ä½œä¼šå½±å“å…³è”å®ä½“
> - å…³è”å®ä½“çš„ç‹¬ç«‹æ“ä½œä¸ä¼šåå‘å½±å“ä¸»å®ä½“

---

## 2. ğŸ“‹ å…­ç§çº§è”ç±»å‹è¯¦è§£


### 2.1 CascadeType.PERSIST - çº§è”ä¿å­˜


**ğŸ”¸ å«ä¹‰**ï¼šä¿å­˜ä¸»å®ä½“æ—¶ï¼Œè‡ªåŠ¨ä¿å­˜å…³è”çš„æ–°å®ä½“

**é€‚ç”¨åœºæ™¯**ï¼š
- è®¢å•ä¿å­˜æ—¶ï¼Œè‡ªåŠ¨ä¿å­˜è®¢å•æ˜ç»†
- ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œè‡ªåŠ¨ä¿å­˜ç”¨æˆ·è¯¦æƒ…
- åˆ›å»ºæ–‡ç« æ—¶ï¼Œè‡ªåŠ¨ä¿å­˜æ ‡ç­¾

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@Entity
public class Order {
    @Id
    @GeneratedValue
    private Long id;
    
    // ğŸ”¸ é…ç½®çº§è”ä¿å­˜
    @OneToMany(cascade = CascadeType.PERSIST)
    private List<OrderItem> items = new ArrayList<>();
}

// ä½¿ç”¨ç¤ºä¾‹
Order order = new Order();
order.getItems().add(new OrderItem("å•†å“A", 100));
order.getItems().add(new OrderItem("å•†å“B", 200));

entityManager.persist(order);
// âœ… order å’Œæ‰€æœ‰ items éƒ½ä¼šè¢«ä¿å­˜åˆ°æ•°æ®åº“
```

**æ‰§è¡Œæµç¨‹å›¾ç¤º**ï¼š
```
æ“ä½œæµç¨‹ï¼š
entityManager.persist(order)
         â†“
    ä¿å­˜ Order
         â†“
    æ£€æµ‹åˆ° cascade = PERSIST
         â†“
    è‡ªåŠ¨ä¿å­˜ OrderItem[0]
         â†“
    è‡ªåŠ¨ä¿å­˜ OrderItem[1]
         â†“
    å®Œæˆ
```

**ğŸ’¡ æ³¨æ„äº‹é¡¹**
- åªå¯¹"æ–°"å®ä½“æœ‰æ•ˆï¼ˆçŠ¶æ€ä¸º Transientï¼‰
- å¦‚æœå…³è”å®ä½“å·²ç»å­˜åœ¨äºæ•°æ®åº“ï¼Œä¸ä¼šé‡å¤ä¿å­˜
- å¿…é¡»æ­£ç¡®è®¾ç½®å…³è”å…³ç³»ï¼Œå¦åˆ™å¤–é”®å¯èƒ½ä¸ºç©º

### 2.2 CascadeType.MERGE - çº§è”åˆå¹¶


**ğŸ”¸ å«ä¹‰**ï¼šåˆå¹¶ä¸»å®ä½“æ—¶ï¼Œè‡ªåŠ¨åˆå¹¶å…³è”å®ä½“çš„ä¿®æ”¹

**é€‚ç”¨åœºæ™¯**ï¼š
- æ›´æ–°è®¢å•åŒæ—¶æ›´æ–°è®¢å•æ˜ç»†
- ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯åŒæ—¶æ›´æ–°å…³è”çš„åœ°å€
- ç¼–è¾‘æ–‡ç« åŒæ—¶æ›´æ–°æ ‡ç­¾

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@Entity
public class User {
    @Id
    private Long id;
    private String name;
    
    @OneToOne(cascade = CascadeType.MERGE)
    private UserProfile profile;
}

// ä½¿ç”¨ç¤ºä¾‹
User user = entityManager.find(User.class, 1L);
user.setName("æ–°åå­—");
user.getProfile().setAge(25);  // ä¿®æ”¹å…³è”å¯¹è±¡

entityManager.merge(user);
// âœ… user å’Œ profile çš„ä¿®æ”¹éƒ½ä¼šåŒæ­¥åˆ°æ•°æ®åº“
```

**MERGE vs PERSIST çš„åŒºåˆ«**ï¼š

| å¯¹æ¯”é¡¹ | **PERSIST** | **MERGE** |
|--------|-------------|-----------|
| **ä½œç”¨å¯¹è±¡** | `æ–°å®ä½“ï¼ˆTransientï¼‰` | `å·²å­˜åœ¨çš„å®ä½“ï¼ˆDetachedï¼‰` |
| **è§¦å‘æ—¶æœº** | `é¦–æ¬¡ä¿å­˜` | `æ›´æ–°ä¿®æ”¹` |
| **å…¸å‹åœºæ™¯** | `åˆ›å»ºè®¢å•` | `ç¼–è¾‘è®¢å•` |
| **è¿”å›å€¼** | `æ— ` | `è¿”å›åˆå¹¶åçš„å®ä½“` |

### 2.3 CascadeType.REMOVE - çº§è”åˆ é™¤


**ğŸ”¸ å«ä¹‰**ï¼šåˆ é™¤ä¸»å®ä½“æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤å…³è”çš„å®ä½“

**é€‚ç”¨åœºæ™¯**ï¼š
- åˆ é™¤è®¢å•æ—¶ï¼Œåˆ é™¤æ‰€æœ‰è®¢å•æ˜ç»†
- åˆ é™¤éƒ¨é—¨æ—¶ï¼Œåˆ é™¤éƒ¨é—¨ä¸‹çš„å‘˜å·¥ï¼ˆâš ï¸ éœ€è°¨æ…ï¼‰
- åˆ é™¤æ–‡ç« æ—¶ï¼Œåˆ é™¤æ–‡ç« çš„è¯„è®º

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@Entity
public class Order {
    @Id
    private Long id;
    
    // ğŸ”¸ é…ç½®çº§è”åˆ é™¤
    @OneToMany(cascade = CascadeType.REMOVE)
    private List<OrderItem> items;
}

// ä½¿ç”¨ç¤ºä¾‹
Order order = entityManager.find(Order.class, 1L);
entityManager.remove(order);
// âœ… order å’Œæ‰€æœ‰å…³è”çš„ items éƒ½ä¼šè¢«åˆ é™¤
```

**âš ï¸ å±é™©è­¦å‘Š**
> **çº§è”åˆ é™¤æ˜¯æœ€å±é™©çš„çº§è”æ“ä½œï¼**
> 
> è¯¯ç”¨æ¡ˆä¾‹ï¼š
> - åˆ é™¤ä¸€ä¸ªéƒ¨é—¨ â†’ è¯¯åˆ æ‰€æœ‰å‘˜å·¥
> - åˆ é™¤ä¸€ä¸ªåˆ†ç±» â†’ è¯¯åˆ æ‰€æœ‰å•†å“
> - åˆ é™¤ä¸€ä¸ªç”¨æˆ· â†’ è¯¯åˆ æ‰€æœ‰è®¢å•

**å®‰å…¨ä½¿ç”¨å»ºè®®**ï¼š
- âœ… è®¢å• â†’ è®¢å•æ˜ç»†ï¼ˆå¼ºä»å±å…³ç³»ï¼‰
- âœ… æ–‡ç«  â†’ æ–‡ç« è¯„è®ºï¼ˆé™„å±å†…å®¹ï¼‰
- âŒ éƒ¨é—¨ â†’ å‘˜å·¥ï¼ˆç‹¬ç«‹å®ä½“ï¼‰
- âŒ åˆ†ç±» â†’ å•†å“ï¼ˆç‹¬ç«‹å®ä½“ï¼‰

### 2.4 CascadeType.REFRESH - çº§è”åˆ·æ–°


**ğŸ”¸ å«ä¹‰**ï¼šåˆ·æ–°ä¸»å®ä½“æ—¶ï¼Œè‡ªåŠ¨åˆ·æ–°å…³è”å®ä½“çš„æ•°æ®

**ä»€ä¹ˆæ˜¯åˆ·æ–°**ï¼š
```
æ•°æ®åº“çš„å€¼ï¼šname = "å¼ ä¸‰"
å†…å­˜ä¸­çš„å€¼ï¼šname = "æå››"ï¼ˆè¢«ä¿®æ”¹äº†ä½†æœªæäº¤ï¼‰

æ‰§è¡Œ refresh() åï¼š
å†…å­˜ä¸­çš„å€¼å˜å›ï¼šname = "å¼ ä¸‰"ï¼ˆä»æ•°æ®åº“é‡æ–°åŠ è½½ï¼‰
```

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@Entity
public class Order {
    @Id
    private Long id;
    
    @OneToMany(cascade = CascadeType.REFRESH)
    private List<OrderItem> items;
}

// ä½¿ç”¨åœºæ™¯
Order order = entityManager.find(Order.class, 1L);
order.setStatus("å·²æ”¯ä»˜");  // ä¿®æ”¹äº†ä½†ä¸æƒ³è¦è¿™ä¸ªä¿®æ”¹

entityManager.refresh(order);
// âœ… order å’Œ items éƒ½ä¼šä»æ•°æ®åº“é‡æ–°åŠ è½½ï¼Œä¸¢å¼ƒæœªæäº¤çš„ä¿®æ”¹
```

**é€‚ç”¨åœºæ™¯**ï¼š
- æ’¤é”€æœªä¿å­˜çš„ä¿®æ”¹
- ç¡®ä¿æ•°æ®æ˜¯æœ€æ–°çš„æ•°æ®åº“çŠ¶æ€
- å¤šç”¨æˆ·å¹¶å‘æ—¶é‡æ–°åŠ è½½æ•°æ®

### 2.5 CascadeType.DETACH - çº§è”åˆ†ç¦»


**ğŸ”¸ å«ä¹‰**ï¼šåˆ†ç¦»ä¸»å®ä½“æ—¶ï¼Œè‡ªåŠ¨åˆ†ç¦»å…³è”å®ä½“

**ä»€ä¹ˆæ˜¯åˆ†ç¦»**ï¼š
```
å®ä½“çš„ä¸‰ç§çŠ¶æ€ï¼š
Managedï¼ˆæ‰˜ç®¡ï¼‰  â†’ EntityManager æ­£åœ¨ç®¡ç†
Detachedï¼ˆåˆ†ç¦»ï¼‰ â†’ è„±ç¦» EntityManager çš„ç®¡ç†
Transientï¼ˆä¸´æ—¶ï¼‰â†’ å…¨æ–°çš„å¯¹è±¡ï¼Œä»æœªè¢«ç®¡ç†
```

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@Entity
public class Order {
    @OneToMany(cascade = CascadeType.DETACH)
    private List<OrderItem> items;
}

// ä½¿ç”¨ç¤ºä¾‹
Order order = entityManager.find(Order.class, 1L);  // Managed çŠ¶æ€
entityManager.detach(order);  // åˆ†ç¦»æ“ä½œ
// âœ… order å’Œ items éƒ½å˜æˆ Detached çŠ¶æ€
```

**åˆ†ç¦»åçš„å½±å“**ï¼š
- å¯¹å®ä½“çš„ä¿®æ”¹ä¸ä¼šè‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“
- éœ€è¦ä½¿ç”¨ `merge()` é‡æ–°å…³è”æ‰èƒ½ä¿å­˜ä¿®æ”¹
- é€‚åˆåœ¨ Web å±‚ä¼ é€’æ•°æ®ï¼ˆé¿å…æ‡’åŠ è½½å¼‚å¸¸ï¼‰

### 2.6 CascadeType.ALL - å…¨éƒ¨çº§è”


**ğŸ”¸ å«ä¹‰**ï¼šåŒ…å«ä»¥ä¸Šæ‰€æœ‰çº§è”ç±»å‹

```java
// ç­‰ä»·äºåŒæ—¶é…ç½®æ‰€æœ‰çº§è”ç±»å‹
@OneToMany(cascade = CascadeType.ALL)
// ç›¸å½“äº
@OneToMany(cascade = {
    CascadeType.PERSIST,
    CascadeType.MERGE,
    CascadeType.REMOVE,
    CascadeType.REFRESH,
    CascadeType.DETACH
})
```

**ä½¿ç”¨å»ºè®®**ï¼š
- âœ… å¼ºä»å±å…³ç³»å¯ä»¥ä½¿ç”¨ï¼ˆè®¢å• â†’ è®¢å•æ˜ç»†ï¼‰
- âš ï¸ æ™®é€šå…³è”æ…ç”¨ï¼ˆå¯èƒ½è¯¯åˆ æ•°æ®ï¼‰
- ğŸ”§ æŒ‰éœ€é…ç½®æ›´å®‰å…¨ï¼ˆåªé…ç½®éœ€è¦çš„çº§è”ç±»å‹ï¼‰

---

## 3. ğŸ—‘ï¸ å­¤å„¿åˆ é™¤æœºåˆ¶


### 3.1 ä»€ä¹ˆæ˜¯å­¤å„¿åˆ é™¤


**é€šä¿—ç†è§£**ï¼šå­¤å„¿åˆ é™¤å°±æ˜¯"æ¸…ç†æ— ä¸»å¯¹è±¡"

```
ç°å®åœºæ™¯ï¼š
è®¢å•ä¸­æœ‰3ä¸ªå•†å“æ˜ç»†ï¼šAã€Bã€C
åˆ é™¤äº†æ˜ç»†B â†’ Bæˆä¸º"å­¤å„¿"ï¼ˆæ²¡æœ‰è®¢å•æ‹¥æœ‰å®ƒäº†ï¼‰
å­¤å„¿åˆ é™¤æœºåˆ¶ â†’ è‡ªåŠ¨ä»æ•°æ®åº“åˆ é™¤B
```

**ğŸ”¸ æŠ€æœ¯å®šä¹‰**
- `orphanRemoval = true`ï¼šå½“å…³è”å…³ç³»æ–­å¼€æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤"å­¤å„¿"å®ä½“
- ä¸ `CascadeType.REMOVE` çš„åŒºåˆ«ï¼š
  - REMOVEï¼šåˆ é™¤ä¸»å®ä½“æ—¶åˆ é™¤å…³è”å®ä½“
  - orphanRemovalï¼šç§»é™¤å…³è”å…³ç³»æ—¶åˆ é™¤è¢«ç§»é™¤çš„å®ä½“

### 3.2 å­¤å„¿åˆ é™¤é…ç½®


```java
@Entity
public class Order {
    @Id
    private Long id;
    
    // ğŸ”¸ å¯ç”¨å­¤å„¿åˆ é™¤
    @OneToMany(orphanRemoval = true)
    private List<OrderItem> items = new ArrayList<>();
}
```

### 3.3 å­¤å„¿åˆ é™¤çš„è§¦å‘åœºæ™¯


**åœºæ™¯1ï¼šä»é›†åˆä¸­ç§»é™¤å…ƒç´ **
```java
Order order = entityManager.find(Order.class, 1L);
OrderItem itemToRemove = order.getItems().get(0);

order.getItems().remove(itemToRemove);  // ä»é›†åˆç§»é™¤
entityManager.flush();
// âœ… itemToRemove ä¼šä»æ•°æ®åº“ä¸­åˆ é™¤
```

**åœºæ™¯2ï¼šæ¸…ç©ºæ•´ä¸ªé›†åˆ**
```java
Order order = entityManager.find(Order.class, 1L);
order.getItems().clear();  // æ¸…ç©ºæ‰€æœ‰æ˜ç»†
entityManager.flush();
// âœ… æ‰€æœ‰ items éƒ½ä¼šä»æ•°æ®åº“ä¸­åˆ é™¤
```

**åœºæ™¯3ï¼šè®¾ç½®æ–°çš„é›†åˆ**
```java
Order order = entityManager.find(Order.class, 1L);
order.setItems(new ArrayList<>());  // æ›¿æ¢æ•´ä¸ªé›†åˆ
entityManager.flush();
// âœ… åŸæ¥çš„ items éƒ½ä¼šè¢«åˆ é™¤
```

### 3.4 å­¤å„¿åˆ é™¤ vs çº§è”åˆ é™¤


**å¯¹æ¯”ç¤ºä¾‹**ï¼š

| æ“ä½œ | **orphanRemoval** | **CascadeType.REMOVE** |
|------|-------------------|------------------------|
| `åˆ é™¤ä¸»å®ä½“` | âœ… åˆ é™¤å…³è”å®ä½“ | âœ… åˆ é™¤å…³è”å®ä½“ |
| `ä»é›†åˆç§»é™¤` | âœ… åˆ é™¤è¢«ç§»é™¤å®ä½“ | âŒ ä¸åˆ é™¤ |
| `æ¸…ç©ºé›†åˆ` | âœ… åˆ é™¤æ‰€æœ‰å®ä½“ | âŒ ä¸åˆ é™¤ |
| `è§£é™¤å…³è”` | âœ… åˆ é™¤å­¤å„¿å®ä½“ | âŒ ä¸åˆ é™¤ |

**è®°å¿†å£è¯€**ï¼š
> çº§è”åˆ é™¤çœ‹ä¸»ä½“ï¼Œå­¤å„¿åˆ é™¤çœ‹å…³ç³»
> - çº§è”åˆ é™¤ï¼šä¸»ä½“æ²¡äº†ï¼Œå…³è”çš„ä¹Ÿæ²¡
> - å­¤å„¿åˆ é™¤ï¼šå…³ç³»æ–­äº†ï¼Œå­¤å„¿ä¹Ÿæ²¡

---

## 4. ğŸ’¼ çº§è”æ“ä½œå®æˆ˜åº”ç”¨


### 4.1 è®¢å•ä¸è®¢å•æ˜ç»†ï¼ˆæ¨èä½¿ç”¨çº§è”ï¼‰


**ä¸šåŠ¡ç‰¹ç‚¹**ï¼š
- è®¢å•æ˜ç»†å®Œå…¨ä¾é™„äºè®¢å•
- åˆ é™¤è®¢å•åº”è¯¥åˆ é™¤æ‰€æœ‰æ˜ç»†
- ä¿å­˜è®¢å•åº”è¯¥ä¿å­˜æ‰€æœ‰æ˜ç»†

**å®Œæ•´é…ç½®**ï¼š
```java
@Entity
public class Order {
    @Id
    @GeneratedValue
    private Long id;
    
    private String orderNo;
    
    @OneToMany(
        mappedBy = "order",
        cascade = CascadeType.ALL,        // å…¨éƒ¨çº§è”
        orphanRemoval = true              // å­¤å„¿åˆ é™¤
    )
    private List<OrderItem> items = new ArrayList<>();
    
    // ğŸ”¸ ä¾¿æ·æ–¹æ³•ï¼šæ·»åŠ æ˜ç»†
    public void addItem(OrderItem item) {
        items.add(item);
        item.setOrder(this);  // ç»´æŠ¤åŒå‘å…³ç³»
    }
    
    // ğŸ”¸ ä¾¿æ·æ–¹æ³•ï¼šç§»é™¤æ˜ç»†
    public void removeItem(OrderItem item) {
        items.remove(item);
        item.setOrder(null);  // è§£é™¤å…³ç³»
    }
}

@Entity
public class OrderItem {
    @Id
    @GeneratedValue
    private Long id;
    
    private String productName;
    private Integer quantity;
    
    @ManyToOne
    @JoinColumn(name = "order_id")
    private Order order;
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// åˆ›å»ºè®¢å•
Order order = new Order();
order.setOrderNo("ORD001");
order.addItem(new OrderItem("å•†å“A", 2));
order.addItem(new OrderItem("å•†å“B", 1));

entityManager.persist(order);
// âœ… è®¢å•å’Œæ˜ç»†éƒ½ä¿å­˜äº†

// ç§»é™¤æŸä¸ªæ˜ç»†
OrderItem item = order.getItems().get(0);
order.removeItem(item);
entityManager.flush();
// âœ… è¯¥æ˜ç»†ä»æ•°æ®åº“åˆ é™¤ï¼ˆå­¤å„¿åˆ é™¤ï¼‰

// åˆ é™¤è®¢å•
entityManager.remove(order);
// âœ… è®¢å•å’Œæ‰€æœ‰æ˜ç»†éƒ½åˆ é™¤äº†
```

### 4.2 ç”¨æˆ·ä¸ç”¨æˆ·è¯¦æƒ…ï¼ˆé€‚åº¦ä½¿ç”¨çº§è”ï¼‰


**ä¸šåŠ¡ç‰¹ç‚¹**ï¼š
- ç”¨æˆ·å’Œè¯¦æƒ…æ˜¯ä¸€å¯¹ä¸€å…³ç³»
- é€šå¸¸ä¸€èµ·åˆ›å»ºå’Œæ›´æ–°
- åˆ é™¤ç”¨æˆ·æ—¶å¯èƒ½éœ€è¦ä¿ç•™è¯¦æƒ…è®°å½•

**æ¨èé…ç½®**ï¼š
```java
@Entity
public class User {
    @Id
    @GeneratedValue
    private Long id;
    
    private String username;
    
    @OneToOne(
        cascade = {
            CascadeType.PERSIST,   // ä¸€èµ·ä¿å­˜
            CascadeType.MERGE      // ä¸€èµ·æ›´æ–°
        }
        // âš ï¸ ä¸é…ç½® REMOVE - åˆ é™¤ç”¨æˆ·ä¸åˆ è¯¦æƒ…
    )
    @JoinColumn(name = "profile_id")
    private UserProfile profile;
}
```

### 4.3 éƒ¨é—¨ä¸å‘˜å·¥ï¼ˆè°¨æ…ä½¿ç”¨çº§è”ï¼‰


**ä¸šåŠ¡ç‰¹ç‚¹**ï¼š
- å‘˜å·¥æ˜¯ç‹¬ç«‹å®ä½“ï¼Œå¯ä»¥æ¢éƒ¨é—¨
- åˆ é™¤éƒ¨é—¨ä¸åº”è¯¥åˆ é™¤å‘˜å·¥
- å‘˜å·¥æ•°æ®éœ€è¦ç‹¬ç«‹ç®¡ç†

**æ¨èé…ç½®**ï¼š
```java
@Entity
public class Department {
    @Id
    private Long id;
    
    private String name;
    
    @OneToMany(
        mappedBy = "department"
        // âŒ ä¸è¦é…ç½®ä»»ä½•çº§è”ï¼Œç‰¹åˆ«æ˜¯ REMOVE
        // âŒ ä¸è¦è®¾ç½® orphanRemoval = true
    )
    private List<Employee> employees;
}

@Entity
public class Employee {
    @Id
    private Long id;
    
    private String name;
    
    @ManyToOne
    @JoinColumn(name = "dept_id")
    private Department department;
}
```

**æ­£ç¡®çš„åˆ é™¤æ–¹å¼**ï¼š
```java
// âŒ é”™è¯¯ï¼šç›´æ¥åˆ é™¤éƒ¨é—¨
Department dept = entityManager.find(Department.class, 1L);
entityManager.remove(dept);  
// æŠ¥é”™ï¼æœ‰å‘˜å·¥å…³è”ï¼Œå¤–é”®çº¦æŸå†²çª

// âœ… æ­£ç¡®ï¼šå…ˆå¤„ç†å‘˜å·¥
Department dept = entityManager.find(Department.class, 1L);
for (Employee emp : dept.getEmployees()) {
    emp.setDepartment(null);  // è§£é™¤å…³è”
}
entityManager.remove(dept);  // å†åˆ é™¤éƒ¨é—¨
```

---

## 5. âš ï¸ çº§è”åˆ é™¤é£é™©æ§åˆ¶


### 5.1 å¸¸è§çš„çº§è”åˆ é™¤é™·é˜±


**é™·é˜±1ï¼šåŒå‘çº§è”åˆ é™¤**
```java
// âŒ å±é™©é…ç½®
@Entity
public class Order {
    @OneToMany(
        mappedBy = "order",
        cascade = CascadeType.ALL  // Order å¯ä»¥çº§è”åˆ é™¤ Customer
    )
    private List<Customer> customers;
}

@Entity 
public class Customer {
    @ManyToOne(
        cascade = CascadeType.ALL  // Customer ä¹Ÿå¯ä»¥çº§è”åˆ é™¤ Order
    )
    private Order order;
}

// åæœï¼šåˆ é™¤ä¸€ä¸ªè®¢å• â†’ åˆ é™¤å®¢æˆ· â†’ åˆ é™¤å®¢æˆ·çš„å…¶ä»–è®¢å• â†’ è¿é”åˆ é™¤
```

**é™·é˜±2ï¼šå¤šå¯¹å¤šçº§è”åˆ é™¤**
```java
// âŒ å±é™©é…ç½®
@Entity
public class Student {
    @ManyToMany(cascade = CascadeType.REMOVE)
    private List<Course> courses;
}

// åæœï¼šåˆ é™¤ä¸€ä¸ªå­¦ç”Ÿ â†’ åˆ é™¤æ‰€æœ‰è¯¾ç¨‹ â†’ å…¶ä»–å­¦ç”Ÿä¹Ÿæ²¡è¯¾ä¸Šäº†ï¼
```

### 5.2 çº§è”åˆ é™¤å®‰å…¨æ£€æŸ¥æ¸…å•


**é…ç½®å‰çš„è‡ªæ£€é—®é¢˜**ï¼š

- [ ] **ä»å±å…³ç³»æ˜ç¡®å—**ï¼Ÿ
  - âœ… è®¢å•æ˜ç»†å®Œå…¨ä¾é™„è®¢å• â†’ å¯ä»¥çº§è”åˆ é™¤
  - âŒ å‘˜å·¥å¯ä»¥ç‹¬ç«‹å­˜åœ¨ â†’ ä¸èƒ½çº§è”åˆ é™¤

- [ ] **åˆ é™¤å½±å“èŒƒå›´æ¸…æ¥šå—**ï¼Ÿ
  - âœ… åªå½±å“å½“å‰ä¸šåŠ¡çš„æ•°æ® â†’ å¯ä»¥çº§è”
  - âŒ ä¼šå½±å“å…¶ä»–ä¸šåŠ¡æ•°æ® â†’ ç¦æ­¢çº§è”

- [ ] **æ˜¯å¦æœ‰å…±äº«å…³ç³»**ï¼Ÿ
  - âœ… æ•°æ®ä¸è¢«å…¶ä»–å®ä½“å…±äº« â†’ å¯ä»¥çº§è”
  - âŒ å¤šä¸ªå®ä½“å…±äº«åŒä¸€æ•°æ® â†’ ç¦æ­¢çº§è”

- [ ] **èƒ½å¦é€šè¿‡ä¸šåŠ¡é€»è¾‘æ§åˆ¶**ï¼Ÿ
  - âœ… å¯ä»¥æ‰‹åŠ¨å¤„ç†å…³è” â†’ ä¸ç”¨çº§è”
  - âš ï¸ å…³è”å¤ªå¤šæ‰‹åŠ¨éº»çƒ¦ â†’ è°¨æ…ä½¿ç”¨çº§è”

### 5.3 æ¨èçš„çº§è”é…ç½®ç­–ç•¥


**ç­–ç•¥1ï¼šå¼ºä»å±å…³ç³» - å…¨é¢çº§è”**
```java
// âœ… é€‚ç”¨ï¼šè®¢å•â†’æ˜ç»†ã€æ–‡ç« â†’è¯„è®º
@OneToMany(
    cascade = CascadeType.ALL,
    orphanRemoval = true
)
```

**ç­–ç•¥2ï¼šå¼±å…³è”å…³ç³» - éƒ¨åˆ†çº§è”**
```java
// âœ… é€‚ç”¨ï¼šç”¨æˆ·â†’åœ°å€ã€å•†å“â†’å›¾ç‰‡
@OneToMany(
    cascade = {
        CascadeType.PERSIST,  // åªçº§è”ä¿å­˜
        CascadeType.MERGE     // åªçº§è”æ›´æ–°
    }
    // âŒ ä¸çº§è”åˆ é™¤
)
```

**ç­–ç•¥3ï¼šç‹¬ç«‹å®ä½“ - ä¸ç”¨çº§è”**
```java
// âœ… é€‚ç”¨ï¼šéƒ¨é—¨â†’å‘˜å·¥ã€åˆ†ç±»â†’å•†å“
@OneToMany(mappedBy = "department")
// å®Œå…¨ä¸é…ç½®çº§è”
```

### 5.4 çº§è”åˆ é™¤çš„æ›¿ä»£æ–¹æ¡ˆ


**æ–¹æ¡ˆ1ï¼šé€»è¾‘åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰**
```java
@Entity
public class Order {
    @Id
    private Long id;
    
    private Boolean deleted = false;  // åˆ é™¤æ ‡è®°
    
    @OneToMany
    private List<OrderItem> items;
    
    // é€»è¾‘åˆ é™¤æ–¹æ³•
    public void logicDelete() {
        this.deleted = true;
        items.forEach(item -> item.setDeleted(true));
    }
}
```

**æ–¹æ¡ˆ2ï¼šæ˜¾å¼åˆ é™¤**
```java
// åœ¨ Service å±‚æ˜ç¡®æ§åˆ¶åˆ é™¤é€»è¾‘
public void deleteOrder(Long orderId) {
    Order order = orderRepository.findById(orderId);
    
    // å…ˆåˆ é™¤æ˜ç»†
    orderItemRepository.deleteByOrderId(orderId);
    
    // å†åˆ é™¤è®¢å•
    orderRepository.delete(order);
}
```

**æ–¹æ¡ˆ3ï¼šæ•°æ®åº“è§¦å‘å™¨**
```sql
-- åœ¨æ•°æ®åº“å±‚é¢æ§åˆ¶çº§è”åˆ é™¤
CREATE TRIGGER before_delete_order
BEFORE DELETE ON orders
FOR EACH ROW
BEGIN
    DELETE FROM order_items WHERE order_id = OLD.id;
END;
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ çº§è”æ“ä½œæœ¬è´¨ï¼šä¸»å®ä½“æ“ä½œè‡ªåŠ¨ä¼ æ’­åˆ°å…³è”å®ä½“
ğŸ”¸ å…­ç§çº§è”ç±»å‹ï¼šPERSISTã€MERGEã€REMOVEã€REFRESHã€DETACHã€ALL
ğŸ”¸ å­¤å„¿åˆ é™¤ï¼šorphanRemoval = trueï¼Œæ–­å¼€å…³è”æ—¶è‡ªåŠ¨åˆ é™¤
ğŸ”¸ çº§è”æ–¹å‘ï¼šå•å‘ä¼ æ’­ï¼Œä¸ä¼šåå‘å½±å“
ğŸ”¸ é£é™©æ§åˆ¶ï¼šçº§è”åˆ é™¤æœ€å±é™©ï¼Œå¿…é¡»è°¨æ…é…ç½®
```

### 6.2 çº§è”ç±»å‹å¿«é€Ÿè®°å¿†


| çº§è”ç±»å‹ | **è®°å¿†å£è¯€** | **å…¸å‹åœºæ™¯** | **é£é™©ç­‰çº§** |
|---------|------------|------------|------------|
| `PERSIST` | `ä¿å­˜ä¸»ä½“å¸¦å…³è”` | åˆ›å»ºè®¢å•ä¿å­˜æ˜ç»† | ğŸŸ¢ ä½é£é™© |
| `MERGE` | `æ›´æ–°ä¸»ä½“å¸¦å…³è”` | ç¼–è¾‘è®¢å•æ›´æ–°æ˜ç»† | ğŸŸ¢ ä½é£é™© |
| `REMOVE` | `åˆ é™¤ä¸»ä½“å¸¦å…³è”` | åˆ é™¤è®¢å•åˆ é™¤æ˜ç»† | ğŸ”´ é«˜é£é™© |
| `REFRESH` | `åˆ·æ–°ä¸»ä½“å¸¦å…³è”` | é‡æ–°åŠ è½½æœ€æ–°æ•°æ® | ğŸŸ¢ ä½é£é™© |
| `DETACH` | `åˆ†ç¦»ä¸»ä½“å¸¦å…³è”` | è„±ç¦»æŒä¹…åŒ–ç®¡ç† | ğŸŸ¡ ä¸­é£é™© |
| `ALL` | `ä»¥ä¸Šå…¨åŒ…å«` | å¼ºä»å±å…³ç³» | ğŸ”´ é«˜é£é™© |

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼åŸåˆ™


**âœ… æ¨èé…ç½®**
```java
// å¼ºä»å±å…³ç³»ï¼ˆè®¢å•â†’æ˜ç»†ï¼‰
cascade = CascadeType.ALL
orphanRemoval = true

// ä¸€èˆ¬å…³è”ï¼ˆç”¨æˆ·â†’åœ°å€ï¼‰  
cascade = {CascadeType.PERSIST, CascadeType.MERGE}

// ç‹¬ç«‹å®ä½“ï¼ˆéƒ¨é—¨â†’å‘˜å·¥ï¼‰
ä¸é…ç½®ä»»ä½•çº§è”
```

**âŒ å±é™©é…ç½®**
```java
// åŒå‘çº§è”åˆ é™¤
A â†’ B (cascade = REMOVE)
B â†’ A (cascade = REMOVE)

// å¤šå¯¹å¤šçº§è”åˆ é™¤
@ManyToMany(cascade = CascadeType.REMOVE)

// å…±äº«å®ä½“çº§è”åˆ é™¤
å¤šä¸ªå®ä½“å…±äº«åŒä¸€å…³è”ï¼Œé…ç½® REMOVE
```

### 6.4 é—®é¢˜æ’æŸ¥è¦ç‚¹


**é—®é¢˜1ï¼šçº§è”ä¿å­˜ä¸ç”Ÿæ•ˆ**
- æ£€æŸ¥æ˜¯å¦é…ç½®äº† `CascadeType.PERSIST`
- æ£€æŸ¥å…³è”å…³ç³»æ˜¯å¦æ­£ç¡®è®¾ç½®
- æ£€æŸ¥æ˜¯å¦æ˜¯æ–°å®ä½“ï¼ˆTransient çŠ¶æ€ï¼‰

**é—®é¢˜2ï¼šæ•°æ®è¢«è¯¯åˆ **
- æ£€æŸ¥æ˜¯å¦é…ç½®äº† `CascadeType.REMOVE`
- æ£€æŸ¥æ˜¯å¦è®¾ç½®äº† `orphanRemoval = true`
- æ£€æŸ¥æ˜¯å¦æœ‰åŒå‘çº§è”åˆ é™¤

**é—®é¢˜3ï¼šå­¤å„¿åˆ é™¤ä¸ç”Ÿæ•ˆ**
- ç¡®è®¤ä½¿ç”¨çš„æ˜¯é›†åˆæ“ä½œï¼ˆremoveã€clearï¼‰
- ç¡®è®¤ `orphanRemoval = true` å·²é…ç½®
- ç¡®è®¤å·²æ‰§è¡Œ `flush()` æˆ–æäº¤äº‹åŠ¡

**è®°å¿†å£è¯€**ï¼š
```
çº§è”æ“ä½œåƒå¤šç±³è¯ºï¼Œé…ç½®ä¸å½“å€’ä¸€ç‰‡
ä¿å­˜æ›´æ–°é£é™©å°ï¼Œåˆ é™¤æ“ä½œè¦ä¸‰æ€
å­¤å„¿åˆ é™¤æ¸…å…³è”ï¼Œå¼ºä»å±æ‰èƒ½ç”¨
ç‹¬ç«‹å®ä½“è«çº§è”ï¼Œæ‰‹åŠ¨å¤„ç†æ›´å®‰å…¨
```