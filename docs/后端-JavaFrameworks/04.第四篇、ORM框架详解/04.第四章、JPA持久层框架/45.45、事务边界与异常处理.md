---
title: 45ã€äº‹åŠ¡è¾¹ç•Œä¸å¼‚å¸¸å¤„ç†
---
## ğŸ“š ç›®å½•

1. [äº‹åŠ¡è¾¹ç•ŒåŸºç¡€æ¦‚å¿µ](#1-äº‹åŠ¡è¾¹ç•ŒåŸºç¡€æ¦‚å¿µ)
2. [æœåŠ¡å±‚äº‹åŠ¡è¾¹ç•Œè®¾è®¡](#2-æœåŠ¡å±‚äº‹åŠ¡è¾¹ç•Œè®¾è®¡)
3. [å¼‚å¸¸å¤„ç†æœºåˆ¶](#3-å¼‚å¸¸å¤„ç†æœºåˆ¶)
4. [äº‹åŠ¡å›æ»šç­–ç•¥](#4-äº‹åŠ¡å›æ»šç­–ç•¥)
5. [èµ„æºæ¸…ç†ä¸æœ€ä½³å®è·µ](#5-èµ„æºæ¸…ç†ä¸æœ€ä½³å®è·µ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ äº‹åŠ¡è¾¹ç•ŒåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡è¾¹ç•Œ


**é€šä¿—ç†è§£ï¼š**
äº‹åŠ¡è¾¹ç•Œå°±åƒä¸€ä¸ª"å·¥ä½œåŒºåŸŸçš„èŒƒå›´"ï¼Œå‘Šè¯‰ç³»ç»Ÿ"ä»å“ªé‡Œå¼€å§‹å·¥ä½œï¼Œåˆ°å“ªé‡Œç»“æŸ"ã€‚

```
ç”Ÿæ´»ä¾‹å­ï¼š
å»é“¶è¡Œè½¬è´¦ â†’ è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„äº‹åŠ¡
â”œâ”€â”€ å¼€å§‹ï¼šèµ°è¿›é“¶è¡Œ
â”œâ”€â”€ æ“ä½œï¼šå¡«å•ã€è½¬è´¦ã€ç¡®è®¤
â””â”€â”€ ç»“æŸï¼šæ‹¿åˆ°å›æ‰§ç¦»å¼€

å¦‚æœä¸­é€”å‡ºé”™ï¼š
â€¢ è¦ä¹ˆå…¨éƒ¨å®Œæˆï¼ˆè½¬è´¦æˆåŠŸï¼‰
â€¢ è¦ä¹ˆå…¨éƒ¨æ’¤é”€ï¼ˆé’±é€€å›æ¥ï¼‰
```

**æ ¸å¿ƒå®šä¹‰ï¼š**
```
äº‹åŠ¡è¾¹ç•Œ = äº‹åŠ¡çš„å¼€å§‹ç‚¹ + ç»“æŸç‚¹

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         äº‹åŠ¡è¾¹ç•ŒèŒƒå›´             â”‚
â”‚                                 â”‚
â”‚  å¼€å§‹ â”€â”€â†’ [ä¸šåŠ¡æ“ä½œ] â”€â”€â†’ æäº¤   â”‚
â”‚            â†“                    â”‚
â”‚          å‡ºé”™ï¼Ÿ                  â”‚
â”‚            â†“                    â”‚
â”‚          å›æ»š                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ˜ç¡®äº‹åŠ¡è¾¹ç•Œ


**ğŸ”¸ æ•°æ®ä¸€è‡´æ€§ä¿éšœ**
```
æ²¡æœ‰æ˜ç¡®è¾¹ç•Œçš„é—®é¢˜ï¼š
ç”¨æˆ·æ³¨å†Œåœºæ™¯ï¼š
1. ä¿å­˜ç”¨æˆ·ä¿¡æ¯ âœ“
2. å‘é€æ¬¢è¿é‚®ä»¶ âœ— (å¤±è´¥äº†)
3. åˆ›å»ºé»˜è®¤è®¾ç½® âœ“

ç»“æœï¼šç”¨æˆ·æ•°æ®ä¸å®Œæ•´ï¼Œäº§ç”Ÿè„æ•°æ®
```

**ğŸ”¸ èµ„æºæ­£ç¡®ç®¡ç†**
```
æ˜ç¡®è¾¹ç•Œçš„å¥½å¤„ï¼š
â€¢ çŸ¥é“ä½•æ—¶å¼€å¯æ•°æ®åº“è¿æ¥
â€¢ çŸ¥é“ä½•æ—¶é‡Šæ”¾èµ„æº
â€¢ é¿å…è¿æ¥æ³„éœ²
â€¢ æé«˜ç³»ç»Ÿæ€§èƒ½
```

### 1.3 äº‹åŠ¡è¾¹ç•Œçš„å±‚æ¬¡


**æ¶æ„åˆ†å±‚è§†è§’ï¼š**
```
Controllerå±‚ï¼ˆæ§åˆ¶å™¨ï¼‰
    â†“ ã€ä¸åº”è¯¥æœ‰äº‹åŠ¡ã€‘
Serviceå±‚ï¼ˆæœåŠ¡å±‚ï¼‰
    â†“ ã€äº‹åŠ¡è¾¹ç•Œåº”è¯¥åœ¨è¿™é‡Œã€‘
DAOå±‚ï¼ˆæ•°æ®è®¿é—®å±‚ï¼‰
    â†“ ã€æ‰§è¡ŒSQLæ“ä½œã€‘
Databaseï¼ˆæ•°æ®åº“ï¼‰
```

> **ğŸ’¡ æ ¸å¿ƒåŸåˆ™**
> 
> äº‹åŠ¡è¾¹ç•Œåº”è¯¥è®¾ç½®åœ¨**ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆServiceå±‚ï¼‰**ï¼Œä¸è¦æ”¾åœ¨Controlleræˆ–DAOå±‚

---

## 2. ğŸ—ï¸ æœåŠ¡å±‚äº‹åŠ¡è¾¹ç•Œè®¾è®¡


### 2.1 åŸºæœ¬äº‹åŠ¡è¾¹ç•Œæ¨¡å¼


**æ ‡å‡†åšæ³•ï¼š**
```java
@Service
public class UserService {
    
    @PersistenceContext
    private EntityManager em;
    
    // âœ… æ­£ç¡®ï¼šäº‹åŠ¡è¾¹ç•Œåœ¨Serviceæ–¹æ³•ä¸Š
    @Transactional
    public void registerUser(UserDTO dto) {
        // è¿™æ•´ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªäº‹åŠ¡
        User user = new User();
        user.setUsername(dto.getUsername());
        user.setEmail(dto.getEmail());
        
        em.persist(user);  // æ“ä½œ1
        
        // åˆ›å»ºé»˜è®¤é…ç½®
        UserProfile profile = new UserProfile();
        profile.setUser(user);
        em.persist(profile);  // æ“ä½œ2
        
        // ä¸¤ä¸ªæ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥
    }
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼š**
```
Serviceå±‚è´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼š
â€¢ ä¸€ä¸ªä¸šåŠ¡æ“ä½œ = ä¸€ä¸ªå®Œæ•´äº‹åŠ¡
â€¢ åŒ…å«å¤šä¸ªæ•°æ®åº“æ“ä½œ
â€¢ ä¿è¯ä¸šåŠ¡æ•°æ®ä¸€è‡´æ€§

é”™è¯¯ç¤ºèŒƒ âŒï¼š
@Transactional
public void saveUser(User user) {
    em.persist(user);
}

@Transactional  
public void saveProfile(UserProfile profile) {
    em.persist(profile);
}

// é—®é¢˜ï¼šä¸¤ä¸ªç‹¬ç«‹äº‹åŠ¡ï¼Œæ— æ³•ä¿è¯ä¸€è‡´æ€§
```

### 2.2 äº‹åŠ¡è¾¹ç•Œçš„ä¼ æ’­


**ä»€ä¹ˆæ˜¯äº‹åŠ¡ä¼ æ’­ï¼š**
å½“ä¸€ä¸ªæœ‰äº‹åŠ¡çš„æ–¹æ³•è°ƒç”¨å¦ä¸€ä¸ªæœ‰äº‹åŠ¡çš„æ–¹æ³•æ—¶ï¼Œæ€ä¹ˆå¤„ç†è¿™ä¸¤ä¸ªäº‹åŠ¡çš„å…³ç³»ã€‚

**å¸¸ç”¨ä¼ æ’­è¡Œä¸ºï¼š**

| ä¼ æ’­ç±»å‹ | **å«ä¹‰** | **ä½¿ç”¨åœºæ™¯** |
|---------|---------|-------------|
| `REQUIRED`<br>(é»˜è®¤) | å¦‚æœæœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œ<br>æ²¡æœ‰å°±æ–°å»º | æœ€å¸¸ç”¨ï¼Œ<br>é€‚åˆå¤§éƒ¨åˆ†ä¸šåŠ¡ |
| `REQUIRES_NEW` | æ€»æ˜¯æ–°å»ºäº‹åŠ¡ï¼Œ<br>æŒ‚èµ·å½“å‰äº‹åŠ¡ | æ—¥å¿—è®°å½•ã€<br>ç‹¬ç«‹æ“ä½œ |
| `SUPPORTS` | æœ‰äº‹åŠ¡å°±ç”¨ï¼Œ<br>æ²¡æœ‰å°±ä¸ç”¨ | æŸ¥è¯¢æ“ä½œ |
| `MANDATORY` | å¿…é¡»åœ¨äº‹åŠ¡ä¸­ï¼Œ<br>å¦åˆ™æŠ¥é”™ | ä¸¥æ ¼çš„æ•°æ®æ“ä½œ |

**å®é™…åº”ç”¨ç¤ºä¾‹ï¼š**

```java
@Service
public class OrderService {
    
    @Autowired
    private LogService logService;
    
    // ä¸»äº‹åŠ¡
    @Transactional
    public void createOrder(Order order) {
        em.persist(order);  // ä¿å­˜è®¢å•
        
        // è®°å½•æ—¥å¿—ï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼‰
        logService.saveLog("è®¢å•åˆ›å»º");
        
        // å¦‚æœåé¢å‡ºé”™ï¼Œè®¢å•å›æ»š
        // ä½†æ—¥å¿—å·²ç»ä¿å­˜ï¼ˆå› ä¸ºæ˜¯ç‹¬ç«‹äº‹åŠ¡ï¼‰
    }
}

@Service  
public class LogService {
    
    // ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸å—å¤–éƒ¨äº‹åŠ¡å½±å“
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void saveLog(String message) {
        Log log = new Log();
        log.setMessage(message);
        log.setTime(new Date());
        em.persist(log);
    }
}
```

**ä¼ æ’­è¡Œä¸ºå›¾ç¤ºï¼š**
```
åœºæ™¯1ï¼šREQUIREDï¼ˆé»˜è®¤ï¼‰
methodA() æœ‰äº‹åŠ¡
  â””â”€> methodB() REQUIRED
      ç»“æœï¼šBåŠ å…¥Açš„äº‹åŠ¡
      
      A â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        â””â”€> B â”€â”€â”€â”˜
        
åœºæ™¯2ï¼šREQUIRES_NEW
methodA() æœ‰äº‹åŠ¡  
  â””â”€> methodB() REQUIRES_NEW
      ç»“æœï¼šBåˆ›å»ºæ–°äº‹åŠ¡ï¼ŒAæš‚åœ
      
      A â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€
             â””â”€ B â”€â”˜
```

### 2.3 äº‹åŠ¡è¾¹ç•Œæœ€ä½³å®è·µ


**ğŸ”¸ ç²’åº¦æ§åˆ¶**
```java
// âœ… å¥½çš„åšæ³•ï¼šç²’åº¦é€‚ä¸­
@Transactional
public void processOrder(Long orderId) {
    Order order = findOrder(orderId);  // æŸ¥è¯¢
    order.setStatus("PROCESSING");     // ä¿®æ”¹
    inventory.reduce(order.getItems());// åº“å­˜æ“ä½œ
    em.flush();                        // ç«‹å³åŒæ­¥
}

// âŒ ä¸å¥½çš„åšæ³•ï¼šç²’åº¦å¤ªå¤§
@Transactional
public void processAllOrders() {
    List<Order> orders = findAllOrders();  // å¯èƒ½ä¸Šä¸‡æ¡
    for (Order order : orders) {
        // å¤„ç†æ¯ä¸ªè®¢å•
    }
    // äº‹åŠ¡å¤ªå¤§ï¼Œå®¹æ˜“è¶…æ—¶ï¼Œé”è¡¨æ—¶é—´é•¿
}
```

**ğŸ”¸ åªè¯»äº‹åŠ¡ä¼˜åŒ–**
```java
// æŸ¥è¯¢æ“ä½œæ ‡è®°ä¸ºåªè¯»
@Transactional(readOnly = true)
public User findUser(Long id) {
    return em.find(User.class, id);
}

// å¥½å¤„ï¼š
// â€¢ æ•°æ®åº“å¯ä»¥ä¼˜åŒ–æŸ¥è¯¢
// â€¢ é˜²æ­¢æ„å¤–çš„æ•°æ®ä¿®æ”¹
// â€¢ æé«˜æ€§èƒ½
```

**ğŸ”¸ è¶…æ—¶è®¾ç½®**
```java
// è®¾ç½®äº‹åŠ¡è¶…æ—¶ï¼ˆç§’ï¼‰
@Transactional(timeout = 30)
public void longRunningTask() {
    // 30ç§’å†…å¿…é¡»å®Œæˆï¼Œå¦åˆ™è‡ªåŠ¨å›æ»š
}
```

---

## 3. âš ï¸ å¼‚å¸¸å¤„ç†æœºåˆ¶


### 3.1 å¼‚å¸¸ç±»å‹ä¸äº‹åŠ¡å›æ»š


**æ ¸å¿ƒè§„åˆ™ï¼š**
```
è¿è¡Œæ—¶å¼‚å¸¸ï¼ˆRuntimeExceptionï¼‰â†’ è‡ªåŠ¨å›æ»š
æ£€æŸ¥å¼‚å¸¸ï¼ˆChecked Exceptionï¼‰â†’ ä¸å›æ»šï¼ˆéœ€æ‰‹åŠ¨é…ç½®ï¼‰
```

**å¼‚å¸¸åˆ†ç±»å›¾ç¤ºï¼š**
```
Exceptionï¼ˆå¼‚å¸¸ï¼‰
â”œâ”€â”€ RuntimeExceptionï¼ˆè¿è¡Œæ—¶å¼‚å¸¸ï¼‰
â”‚   â”œâ”€â”€ NullPointerException
â”‚   â”œâ”€â”€ IllegalArgumentException  
â”‚   â””â”€â”€ ... â†’ è‡ªåŠ¨å›æ»š
â”‚
â””â”€â”€ Checked Exceptionï¼ˆæ£€æŸ¥å¼‚å¸¸ï¼‰
    â”œâ”€â”€ IOException
    â”œâ”€â”€ SQLException
    â””â”€â”€ ... â†’ é»˜è®¤ä¸å›æ»š
```

**å®ä¾‹è¯´æ˜ï¼š**
```java
@Service
public class PaymentService {
    
    // åœºæ™¯1ï¼šè¿è¡Œæ—¶å¼‚å¸¸ â†’ è‡ªåŠ¨å›æ»š
    @Transactional
    public void processPayment(Payment payment) {
        em.persist(payment);
        
        if (payment.getAmount() < 0) {
            // æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ï¼Œäº‹åŠ¡è‡ªåŠ¨å›æ»š
            throw new IllegalArgumentException("é‡‘é¢ä¸èƒ½ä¸ºè´Ÿ");
        }
    }
    
    // åœºæ™¯2ï¼šæ£€æŸ¥å¼‚å¸¸ â†’ é»˜è®¤ä¸å›æ»š
    @Transactional
    public void sendReceipt(Payment payment) throws IOException {
        em.persist(payment);  // å·²ä¿å­˜
        
        emailService.send(payment.getEmail());  
        // å¦‚æœæŠ›å‡ºIOExceptionï¼Œpaymentä¸ä¼šå›æ»šï¼
    }
    
    // åœºæ™¯3ï¼šé…ç½®æ£€æŸ¥å¼‚å¸¸ä¹Ÿå›æ»š
    @Transactional(rollbackFor = Exception.class)
    public void sendReceiptSafe(Payment payment) throws IOException {
        em.persist(payment);
        emailService.send(payment.getEmail());
        // ç°åœ¨IOExceptionä¹Ÿä¼šè§¦å‘å›æ»š
    }
}
```

### 3.2 RollbackExceptionå¤„ç†


**ä»€ä¹ˆæ˜¯RollbackExceptionï¼š**
```
RollbackException = äº‹åŠ¡æäº¤æ—¶å‘ç°æœ‰é”™è¯¯ï¼Œå¼ºåˆ¶å›æ»šæŠ›å‡ºçš„å¼‚å¸¸

å¸¸è§åŸå› ï¼š
â€¢ äº‹åŠ¡å·²è¢«æ ‡è®°ä¸ºå›æ»š
â€¢ è¿åæ•°æ®åº“çº¦æŸ
â€¢ å®ä½“éªŒè¯å¤±è´¥
```

**å…¸å‹åœºæ™¯ï¼š**
```java
@Transactional
public void updateUser(User user) {
    try {
        em.merge(user);  // å°è¯•æ›´æ–°
        em.flush();      // ç«‹å³æ‰§è¡Œ
        
    } catch (RollbackException e) {
        // å¤„ç†å›æ»šå¼‚å¸¸
        
        // 1. æ£€æŸ¥æ˜¯å¦çº¦æŸå†²çª
        if (e.getCause() instanceof ConstraintViolationException) {
            System.out.println("è¿åå”¯ä¸€æ€§çº¦æŸ");
        }
        
        // 2. æ£€æŸ¥æ˜¯å¦éªŒè¯å¤±è´¥
        if (e.getCause() instanceof ValidationException) {
            System.out.println("æ•°æ®éªŒè¯å¤±è´¥");
        }
        
        // 3. è®°å½•æ—¥å¿—
        log.error("äº‹åŠ¡å›æ»š", e);
        
        // 4. æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸
        throw new BusinessException("ç”¨æˆ·æ›´æ–°å¤±è´¥");
    }
}
```

### 3.3 å¼‚å¸¸ä¼ æ’­æœºåˆ¶


**å¼‚å¸¸å¦‚ä½•åœ¨äº‹åŠ¡ä¸­ä¼ æ’­ï¼š**
```
Controller
    â†“ è°ƒç”¨
Service A (@Transactional)
    â†“ è°ƒç”¨  
Service B (@Transactional)
    â†“ æŠ›å‡ºå¼‚å¸¸
    
ä¼ æ’­è·¯å¾„ï¼š
BæŠ›å¼‚å¸¸ â†’ Aæ•è·åˆ°å¼‚å¸¸ â†’ Açš„äº‹åŠ¡è¢«æ ‡è®°å›æ»š
â†’ å³ä½¿Aç»§ç»­æ‰§è¡Œï¼Œæäº¤æ—¶ä¹Ÿä¼šå›æ»š
```

**å®ä¾‹ä»£ç ï¼š**
```java
@Service
public class OrderService {
    
    @Autowired
    private InventoryService inventoryService;
    
    @Transactional
    public void createOrder(Order order) {
        em.persist(order);  // ä¿å­˜è®¢å•
        
        try {
            // è°ƒç”¨åº“å­˜æœåŠ¡
            inventoryService.reduceStock(order.getItems());
            
        } catch (StockException e) {
            // åº“å­˜ä¸è¶³
            // æ­¤æ—¶æ•´ä¸ªäº‹åŠ¡å·²è¢«æ ‡è®°ä¸ºrollback-only
            
            // âŒ é”™è¯¯ï¼šä»¥ä¸ºæ•è·äº†å°±æ²¡äº‹
            order.setStatus("PENDING");  // æ— æ•ˆæ“ä½œ
            
            // âœ… æ­£ç¡®ï¼šé‡æ–°æŠ›å‡ºæˆ–å¤„ç†
            throw new OrderException("åº“å­˜ä¸è¶³", e);
        }
        
        // å³ä½¿è¿™é‡Œçœ‹èµ·æ¥æ­£å¸¸ç»“æŸ
        // æäº¤æ—¶ä»ä¼šå› ä¸ºrollback-onlyè€Œå›æ»š
    }
}
```

**å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µï¼š**

> **ğŸ’¡ æ ¸å¿ƒå»ºè®®**
> 
> 1. **ä¸è¦åæ‰å¼‚å¸¸**ï¼šæ•è·åè¦é‡æ–°æŠ›å‡ºæˆ–æ ‡è®°äº‹åŠ¡å›æ»š
> 2. **æ£€æŸ¥äº‹åŠ¡çŠ¶æ€**ï¼šå¯ä»¥ç”¨`TransactionStatus`æ£€æŸ¥æ˜¯å¦å·²æ ‡è®°å›æ»š
> 3. **ä¸šåŠ¡å¼‚å¸¸åˆ†å±‚**ï¼šå®šä¹‰æ¸…æ™°çš„ä¸šåŠ¡å¼‚å¸¸ä½“ç³»

```java
// å¥½çš„åšæ³•ï¼šä¸šåŠ¡å¼‚å¸¸åˆ†å±‚
public class BusinessException extends RuntimeException {
    private String errorCode;
    
    public BusinessException(String code, String message) {
        super(message);
        this.errorCode = code;
    }
}

public class OrderException extends BusinessException {
    public OrderException(String message) {
        super("ORDER_ERROR", message);
    }
}

// Serviceä¸­ä½¿ç”¨
@Transactional
public void placeOrder(Order order) {
    if (order.getAmount() <= 0) {
        throw new OrderException("è®¢å•é‡‘é¢å¿…é¡»å¤§äº0");
        // è‡ªåŠ¨å›æ»šï¼Œå¼‚å¸¸å‘ä¸Šä¼ æ’­
    }
    
    em.persist(order);
}
```

---

## 4. ğŸ”„ äº‹åŠ¡å›æ»šç­–ç•¥


### 4.1 äº‹åŠ¡çŠ¶æ€æ£€æŸ¥


**å¦‚ä½•æ£€æŸ¥äº‹åŠ¡çŠ¶æ€ï¼š**
```java
@Service
public class PaymentService {
    
    @PersistenceContext
    private EntityManager em;
    
    @Transactional
    public void processPayment(Payment payment) {
        try {
            em.persist(payment);
            
            // è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜
            externalPaymentService.pay(payment);
            
        } catch (Exception e) {
            // æ£€æŸ¥äº‹åŠ¡æ˜¯å¦å·²æ ‡è®°å›æ»š
            if (TransactionAspectSupport
                .currentTransactionStatus()
                .isRollbackOnly()) {
                
                System.out.println("äº‹åŠ¡å·²æ ‡è®°å›æ»š");
                // ä¸å†ç»§ç»­ä¸šåŠ¡æ“ä½œ
                return;
            }
            
            // æ‰‹åŠ¨æ ‡è®°å›æ»š
            TransactionAspectSupport
                .currentTransactionStatus()
                .setRollbackOnly();
        }
    }
}
```

### 4.2 éƒ¨åˆ†å›æ»šå¤„ç†


**åœºæ™¯ï¼šæ‰¹é‡æ“ä½œä¸­éƒ¨åˆ†å¤±è´¥**
```java
@Service
public class BatchService {
    
    // âŒ é”™è¯¯åšæ³•ï¼šå…¨éƒ¨å›æ»š
    @Transactional
    public void batchInsertWrong(List<User> users) {
        for (User user : users) {
            em.persist(user);
            // ä¸€ä¸ªå¤±è´¥ï¼Œå…¨éƒ¨å›æ»š
        }
    }
    
    // âœ… æ­£ç¡®åšæ³•ï¼šåˆ†æ‰¹å¤„ç†
    public void batchInsertRight(List<User> users) {
        for (User user : users) {
            try {
                // æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹äº‹åŠ¡
                saveUserInNewTransaction(user);
                
            } catch (Exception e) {
                log.error("ä¿å­˜ç”¨æˆ·å¤±è´¥: " + user.getId(), e);
                // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª
            }
        }
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void saveUserInNewTransaction(User user) {
        em.persist(user);
    }
}
```

**ä¿å­˜ç‚¹ï¼ˆSavepointï¼‰æœºåˆ¶ï¼š**
```java
// JPAæœ¬èº«ä¸ç›´æ¥æ”¯æŒä¿å­˜ç‚¹
// ä½†å¯ä»¥é€šè¿‡JDBCå®ç°

@Transactional
public void complexOperation() {
    Connection conn = em.unwrap(Connection.class);
    Savepoint savepoint = null;
    
    try {
        // æ“ä½œ1
        em.persist(entity1);
        
        // è®¾ç½®ä¿å­˜ç‚¹
        savepoint = conn.setSavepoint("point1");
        
        // æ“ä½œ2ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
        em.persist(entity2);
        
        // æ“ä½œ3
        riskyOperation();
        
    } catch (Exception e) {
        if (savepoint != null) {
            // å›æ»šåˆ°ä¿å­˜ç‚¹ï¼Œæ“ä½œ1ä»ç„¶æœ‰æ•ˆ
            conn.rollback(savepoint);
        }
    }
}
```

### 4.3 å›æ»šåçš„å¤„ç†


**å›æ»šåå®ä½“çŠ¶æ€ï¼š**
```
äº‹åŠ¡å›æ»šåï¼š
â€¢ æŒä¹…åŒ–å®ä½“ â†’ å˜æˆæ¸¸ç¦»çŠ¶æ€ï¼ˆDetachedï¼‰
â€¢ æ–°å»ºå®ä½“ â†’ ä¿æŒæ–°å»ºçŠ¶æ€
â€¢ æ•°æ®åº“æ“ä½œ â†’ å…¨éƒ¨æ’¤é”€
```

**å®ä¾‹ä»£ç ï¼š**
```java
@Service
public class UserService {
    
    @Transactional
    public void updateUserInfo(Long userId, String newName) {
        User user = em.find(User.class, userId);  // æŒä¹…åŒ–çŠ¶æ€
        user.setName(newName);
        
        try {
            // å¯èƒ½å¤±è´¥çš„æ“ä½œ
            sendNotification(user);
            
        } catch (Exception e) {
            // äº‹åŠ¡å°†å›æ»š
            // userå˜æˆæ¸¸ç¦»çŠ¶æ€
            // æ•°æ®åº“ä¸­nameä¸ä¼šæ”¹å˜
            
            // âš ï¸ æ³¨æ„ï¼šuserå¯¹è±¡çš„nameå·²ç»æ”¹äº†
            System.out.println(user.getName());  // è¾“å‡ºï¼šnewName
            
            throw e;  // ç»§ç»­æŠ›å‡ºï¼Œè§¦å‘å›æ»š
        }
    }
    
    // æ­£ç¡®çš„å¤„ç†æ–¹å¼
    @Transactional
    public void updateUserSafe(Long userId, String newName) {
        User user = em.find(User.class, userId);
        String oldName = user.getName();  // ä¿å­˜æ—§å€¼
        
        try {
            user.setName(newName);
            sendNotification(user);
            
        } catch (Exception e) {
            // å›æ»šåæ¢å¤å¯¹è±¡çŠ¶æ€
            user.setName(oldName);
            throw new UpdateException("æ›´æ–°å¤±è´¥", e);
        }
    }
}
```

---

## 5. ğŸ§¹ èµ„æºæ¸…ç†ä¸æœ€ä½³å®è·µ


### 5.1 èµ„æºè‡ªåŠ¨æ¸…ç†


**Springç®¡ç†çš„èµ„æºï¼š**
```java
@Service
public class UserService {
    
    // âœ… Springç®¡ç†çš„EntityManagerï¼Œè‡ªåŠ¨æ¸…ç†
    @PersistenceContext
    private EntityManager em;
    
    @Transactional
    public void saveUser(User user) {
        em.persist(user);
        // æ–¹æ³•ç»“æŸï¼ŒSpringè‡ªåŠ¨ï¼š
        // 1. æäº¤æˆ–å›æ»šäº‹åŠ¡
        // 2. å…³é—­EntityManager
        // 3. é‡Šæ”¾æ•°æ®åº“è¿æ¥
    }
}
```

**æ‰‹åŠ¨ç®¡ç†éœ€è¦æ³¨æ„ï¼š**
```java
// âŒ ä¸æ¨èï¼šæ‰‹åŠ¨ç®¡ç†èµ„æº
public void manualTransaction() {
    EntityManager em = emf.createEntityManager();
    EntityTransaction tx = em.getTransaction();
    
    try {
        tx.begin();
        
        User user = new User();
        em.persist(user);
        
        tx.commit();
        
    } catch (Exception e) {
        if (tx.isActive()) {
            tx.rollback();
        }
        throw e;
        
    } finally {
        // å¿…é¡»æ‰‹åŠ¨å…³é—­
        em.close();
    }
}
```

### 5.2 è¿æ¥æ± ä¸èµ„æºæ³„éœ²


**ä»€ä¹ˆæ˜¯èµ„æºæ³„éœ²ï¼š**
```
èµ„æºæ³„éœ² = æ•°æ®åº“è¿æ¥æ²¡æœ‰æ­£ç¡®å½’è¿˜ç»™è¿æ¥æ± 

åæœï¼š
â€¢ è¿æ¥æ± è€—å°½
â€¢ æ–°è¯·æ±‚æ— æ³•è·å–è¿æ¥
â€¢ ç³»ç»Ÿå¡æ­»

å¸¸è§åŸå› ï¼š
â€¢ äº‹åŠ¡æ²¡æœ‰æäº¤/å›æ»š
â€¢ EntityManageræ²¡æœ‰å…³é—­
â€¢ å¼‚å¸¸å¤„ç†ä¸å½“
```

**æ£€æµ‹å’Œé¢„é˜²ï¼š**
```java
// é…ç½®è¿æ¥æ± ç›‘æ§
spring.datasource.hikari.leak-detection-threshold=60000
// è¿æ¥æŒæœ‰è¶…è¿‡60ç§’æŠ¥è­¦

// é…ç½®æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
spring.datasource.hikari.max-lifetime=1800000
// 30åˆ†é’Ÿå¼ºåˆ¶å›æ”¶è¿æ¥

// é…ç½®è¿æ¥è¶…æ—¶
spring.datasource.hikari.connection-timeout=30000
// 30ç§’è·å–ä¸åˆ°è¿æ¥å°±æŠ¥é”™
```

### 5.3 äº‹åŠ¡ç®¡ç†æœ€ä½³å®è·µæ¸…å•


**âœ… å¿…é¡»åšçš„ï¼š**
```
1. äº‹åŠ¡è¾¹ç•Œæ”¾åœ¨Serviceå±‚
   @Service
   public class XXXService {
       @Transactional
       public void businessMethod() { }
   }

2. æ˜ç¡®æŒ‡å®šå›æ»šå¼‚å¸¸
   @Transactional(rollbackFor = Exception.class)

3. è®¾ç½®åˆç†çš„è¶…æ—¶
   @Transactional(timeout = 30)

4. åªè¯»äº‹åŠ¡ä¼˜åŒ–
   @Transactional(readOnly = true)

5. å¼‚å¸¸è¦é‡æ–°æŠ›å‡º
   catch (Exception e) {
       log.error("é”™è¯¯", e);
       throw new BusinessException(e);
   }
```

**âŒ ä¸è¦åšçš„ï¼š**
```
1. ä¸åœ¨Controllerä¸­ä½¿ç”¨@Transactional

2. ä¸æ•è·å¼‚å¸¸åä¸å¤„ç†
   catch (Exception e) {
       // ä»€ä¹ˆéƒ½ä¸åš âŒ
   }

3. ä¸åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
   @Transactional
   public void bad() {
       Thread.sleep(10000);  // âŒ
   }

4. ä¸åœ¨å¾ªç¯ä¸­å¼€å¯äº‹åŠ¡
   for (Item item : items) {
       @Transactional  // âŒ
       saveItem(item);
   }

5. ä¸æ··ç”¨å¤šä¸ªäº‹åŠ¡ç®¡ç†å™¨
```

**ğŸ”§ é—®é¢˜æ’æŸ¥æ£€æŸ¥è¡¨ï¼š**
```
äº‹åŠ¡ä¸ç”Ÿæ•ˆï¼Ÿ
â–¡ æ–¹æ³•æ˜¯publicçš„å—ï¼Ÿ
â–¡ åœ¨åŒä¸€ä¸ªç±»å†…éƒ¨è°ƒç”¨å—ï¼Ÿï¼ˆä»£ç†å¤±æ•ˆï¼‰
â–¡ å¼‚å¸¸è¢«æ•è·äº†å—ï¼Ÿ
â–¡ Springé…ç½®æ­£ç¡®å—ï¼Ÿ

äº‹åŠ¡å›æ»šäº†ï¼Ÿ
â–¡ æ£€æŸ¥å¼‚å¸¸ç±»å‹
â–¡ æŸ¥çœ‹rollbackForé…ç½®
â–¡ ç¡®è®¤æ²¡æœ‰æ‰‹åŠ¨commit

æ€§èƒ½é—®é¢˜ï¼Ÿ  
â–¡ äº‹åŠ¡ç²’åº¦æ˜¯å¦å¤ªå¤§
â–¡ æ˜¯å¦æœ‰æ­»é”
â–¡ è¿æ¥æ± é…ç½®æ˜¯å¦åˆç†
â–¡ æ˜¯å¦æœ‰æ…¢SQL
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ äº‹åŠ¡è¾¹ç•Œï¼šå®šä¹‰åœ¨Serviceå±‚ï¼Œä¸€ä¸ªä¸šåŠ¡æ–¹æ³•ä¸€ä¸ªäº‹åŠ¡
ğŸ”¸ å¼‚å¸¸å›æ»šï¼šRuntimeExceptionè‡ªåŠ¨å›æ»šï¼ŒCheckedéœ€é…ç½®
ğŸ”¸ äº‹åŠ¡ä¼ æ’­ï¼šç†è§£REQUIREDå’ŒREQUIRES_NEWçš„åŒºåˆ«
ğŸ”¸ èµ„æºç®¡ç†ï¼šSpringè‡ªåŠ¨ç®¡ç†ï¼Œé¿å…æ‰‹åŠ¨æ“ä½œ
ğŸ”¸ çŠ¶æ€æ£€æŸ¥ï¼šå¯ä»¥æ£€æŸ¥å’Œæ ‡è®°äº‹åŠ¡å›æ»šçŠ¶æ€
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ äº‹åŠ¡è¾¹ç•Œä¸ºä»€ä¹ˆåœ¨Serviceå±‚**
```
å› ä¸ºï¼š
â€¢ ServiceåŒ…å«å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘
â€¢ ä¸€ä¸ªä¸šåŠ¡æ“ä½œå¯èƒ½åŒ…å«å¤šä¸ªæ•°æ®åº“æ“ä½œ
â€¢ ä¿è¯ä¸šåŠ¡æ•°æ®çš„ä¸€è‡´æ€§

ä¸åœ¨Controllerï¼š
â€¢ Controlleråªè´Ÿè´£è¯·æ±‚å“åº”
â€¢ å¯èƒ½è°ƒç”¨å¤šä¸ªService
â€¢ ç²’åº¦å¤ªç²—

ä¸åœ¨DAOï¼š  
â€¢ DAOåªè´Ÿè´£æ•°æ®è®¿é—®
â€¢ ç²’åº¦å¤ªç»†
â€¢ æ— æ³•ä¿è¯ä¸šåŠ¡ä¸€è‡´æ€§
```

**ğŸ”¹ å¼‚å¸¸å¤„ç†çš„æ­£ç¡®å§¿åŠ¿**
```
1. æ•è·å¼‚å¸¸åè¦å¤„ç†ï¼š
   â€¢ è®°å½•æ—¥å¿—
   â€¢ è½¬æ¢ä¸ºä¸šåŠ¡å¼‚å¸¸
   â€¢ é‡æ–°æŠ›å‡º

2. ä¸è¦åæ‰å¼‚å¸¸ï¼š
   catch (Exception e) {
       // ä»€ä¹ˆéƒ½ä¸åš âŒ
   }

3. ç†è§£å›æ»šè§„åˆ™ï¼š
   â€¢ è¿è¡Œæ—¶å¼‚å¸¸ â†’ è‡ªåŠ¨å›æ»š
   â€¢ æ£€æŸ¥å¼‚å¸¸ â†’ éœ€è¦é…ç½®
   â€¢ rollbackFor = Exception.class
```

**ğŸ”¹ äº‹åŠ¡å›æ»šåçš„æ³¨æ„äº‹é¡¹**
```
å›æ»šå½±å“ï¼š
â€¢ æ•°æ®åº“æ“ä½œå…¨éƒ¨æ’¤é”€
â€¢ å®ä½“å˜æˆæ¸¸ç¦»çŠ¶æ€  
â€¢ å¯¹è±¡å†…å­˜ä¸­çš„å€¼ä¸ä¼šæ¢å¤

å¤„ç†æ–¹å¼ï¼š
â€¢ ä¿å­˜åŸå§‹å€¼
â€¢ å›æ»šåæ¢å¤å¯¹è±¡çŠ¶æ€
â€¢ æˆ–é‡æ–°ä»æ•°æ®åº“åŠ è½½
```

### 6.3 å®è·µåº”ç”¨æŒ‡å—


**ğŸ“ æ–°æ‰‹å¸¸è§é”™è¯¯ï¼š**
```
é”™è¯¯1ï¼šäº‹åŠ¡ç²’åº¦å¤ªå¤§
@Transactional
public void processAll() {
    for (int i = 0; i < 10000; i++) {
        // å¤„ç†å¤§é‡æ•°æ®
    }
    // äº‹åŠ¡å¤ªé•¿ï¼Œå®¹æ˜“è¶…æ—¶å’Œé”è¡¨
}

æ­£ç¡®ï¼šåˆ†æ‰¹å¤„ç†ï¼Œç‹¬ç«‹äº‹åŠ¡

é”™è¯¯2ï¼šæ•è·å¼‚å¸¸ä¸å¤„ç†  
@Transactional
public void save(User user) {
    try {
        em.persist(user);
    } catch (Exception e) {
        // æ²¡æœ‰é‡æ–°æŠ›å‡ºï¼Œäº‹åŠ¡ä¸ä¼šå›æ»š
    }
}

æ­£ç¡®ï¼šè®°å½•æ—¥å¿—åé‡æ–°æŠ›å‡º

é”™è¯¯3ï¼šåœ¨åŒä¸€ä¸ªç±»å†…éƒ¨è°ƒç”¨
public void methodA() {
    methodB();  // ä»£ç†å¤±æ•ˆï¼Œäº‹åŠ¡ä¸ç”Ÿæ•ˆ
}

@Transactional
public void methodB() { }

æ­£ç¡®ï¼šé€šè¿‡æ³¨å…¥è‡ªå·±çš„ä»£ç†å¯¹è±¡è°ƒç”¨
```

**ğŸ¯ å®é™…å¼€å‘å»ºè®®ï¼š**
```
1. ç»Ÿä¸€äº‹åŠ¡é…ç½®ï¼š
   â€¢ åˆ›å»ºåŸºç¡€Serviceç±»
   â€¢ ç»Ÿä¸€é…ç½®@Transactionalå±æ€§
   
2. å¼‚å¸¸ä½“ç³»è®¾è®¡ï¼š
   â€¢ ä¸šåŠ¡å¼‚å¸¸ç»§æ‰¿RuntimeException
   â€¢ åˆ†ç±»å®šä¹‰å¼‚å¸¸ç 
   
3. æ—¥å¿—è®°å½•ï¼š
   â€¢ äº‹åŠ¡å¼€å§‹/ç»“æŸ
   â€¢ å¼‚å¸¸ä¿¡æ¯
   â€¢ å›æ»šåŸå› 
   
4. æ€§èƒ½ç›‘æ§ï¼š
   â€¢ äº‹åŠ¡æ‰§è¡Œæ—¶é—´
   â€¢ æ•°æ®åº“è¿æ¥ä½¿ç”¨æƒ…å†µ
   â€¢ æ…¢SQLåˆ†æ
```

**æ ¸å¿ƒè®°å¿†å£è¯€ï¼š**
```
äº‹åŠ¡è¾¹ç•ŒServiceå®šï¼Œä¸šåŠ¡é€»è¾‘ä¸€ä¸ªæ•´
è¿è¡Œå¼‚å¸¸è‡ªåŠ¨æ»šï¼Œæ£€æŸ¥å¼‚å¸¸è¦é…æ¸…  
æ•è·å¼‚å¸¸åˆ«åæ‰ï¼Œæ—¥å¿—è®°å½•å†ä¸ŠæŠ›
èµ„æºç®¡ç†Springå¸®ï¼Œæ‰‹åŠ¨æ“ä½œè¦å°å¿ƒ
```