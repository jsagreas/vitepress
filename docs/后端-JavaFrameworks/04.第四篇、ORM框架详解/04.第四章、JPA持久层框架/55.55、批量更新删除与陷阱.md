---
title: 55ã€æ‰¹é‡æ›´æ–°åˆ é™¤ä¸é™·é˜±
---
## ğŸ“š ç›®å½•

1. [æ‰¹é‡æ“ä½œåŸºç¡€æ¦‚å¿µ](#1-æ‰¹é‡æ“ä½œåŸºç¡€æ¦‚å¿µ)
2. [@Modifyingæ³¨è§£è¯¦è§£](#2-modifyingæ³¨è§£è¯¦è§£)
3. [æ‰¹é‡æ›´æ–°æ“ä½œ](#3-æ‰¹é‡æ›´æ–°æ“ä½œ)
4. [æ‰¹é‡åˆ é™¤æ“ä½œ](#4-æ‰¹é‡åˆ é™¤æ“ä½œ)
5. [ä¸€çº§ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜](#5-ä¸€çº§ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜)
6. [æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ](#6-æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ‰¹é‡æ“ä½œåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ‰¹é‡æ“ä½œ


**é€šä¿—ç†è§£**ï¼šæ‰¹é‡æ“ä½œå°±åƒæ˜¯"æ‰¹å‘å¤„ç†æ•°æ®"

```
æ™®é€šæ“ä½œï¼ˆé›¶å”®æ¨¡å¼ï¼‰ï¼š
for (User user : users) {
    user.setStatus("ACTIVE");
    repository.save(user);  // æ¯æ¬¡ä¸€ä¸ªSQL
}
æ‰§è¡Œ100æ¬¡å¾ªç¯ = å‘é€100æ¡SQLè¯­å¥

æ‰¹é‡æ“ä½œï¼ˆæ‰¹å‘æ¨¡å¼ï¼‰ï¼š
UPDATE user SET status = 'ACTIVE' WHERE department = 'IT'
æ‰§è¡Œ1æ¬¡ = å‘é€1æ¡SQLè¯­å¥ï¼Œç›´æ¥åœ¨æ•°æ®åº“å±‚é¢å¤„ç†
```

**æ ¸å¿ƒåŒºåˆ«**ï¼š

| å¯¹æ¯”ç»´åº¦ | **æ™®é€šæ“ä½œ** | **æ‰¹é‡æ“ä½œ** |
|---------|------------|------------|
| ğŸ“Š **æ‰§è¡Œæ–¹å¼** | `é€æ¡åŠ è½½åˆ°å†…å­˜ï¼Œé€ä¸ªä¿®æ”¹` | `ç›´æ¥åœ¨æ•°æ®åº“æ‰§è¡ŒSQL` |
| âš¡ **æ€§èƒ½** | `æ…¢ï¼Œæ¯æ¡éƒ½è¦æŸ¥è¯¢+æ›´æ–°` | `å¿«ï¼Œä¸€æ¡SQLæå®š` |
| ğŸ’¾ **å†…å­˜å ç”¨** | `é«˜ï¼Œè¦æŠŠæ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜` | `ä½ï¼Œä¸åŠ è½½æ•°æ®åˆ°å†…å­˜` |
| ğŸ”„ **ä¸€çº§ç¼“å­˜** | `ä¼šåŒæ­¥ç¼“å­˜` | `ä¸ç»è¿‡ç¼“å­˜ï¼Œéœ€æ‰‹åŠ¨å¤„ç†` |

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡æ“ä½œ


**å®é™…åœºæ™¯ä¸¾ä¾‹**ï¼š

```
åœºæ™¯1ï¼šä¿®æ”¹éƒ¨é—¨çš„æ‰€æœ‰å‘˜å·¥çŠ¶æ€
- æ™®é€šæ–¹å¼ï¼šæŸ¥å‡º1000ä¸ªå‘˜å·¥ â†’ å¾ªç¯ä¿®æ”¹ â†’ ä¿å­˜1000æ¬¡
- æ‰¹é‡æ–¹å¼ï¼šä¸€æ¡SQLï¼šUPDATE employee SET status='ç¦»èŒ' WHERE dept='é”€å”®éƒ¨'

åœºæ™¯2ï¼šåˆ é™¤è¿‡æœŸçš„ä¸´æ—¶æ•°æ®
- æ™®é€šæ–¹å¼ï¼šæŸ¥å‡º10000æ¡è®°å½• â†’ å¾ªç¯åˆ é™¤10000æ¬¡
- æ‰¹é‡æ–¹å¼ï¼šä¸€æ¡SQLï¼šDELETE FROM temp_data WHERE create_time < '2024-01-01'

æ€§èƒ½å¯¹æ¯”ï¼š
æ™®é€šæ–¹å¼å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ
æ‰¹é‡æ–¹å¼å¯èƒ½åªéœ€è¦å‡ ç§’é’Ÿ
```

**æ‰¹é‡æ“ä½œçš„ä¼˜åŠ¿**ï¼š

ğŸ”¸ **æ€§èƒ½ä¼˜åŠ¿**
- å‡å°‘æ•°æ®åº“å¾€è¿”æ¬¡æ•°ï¼ˆç½‘ç»œå¼€é”€ï¼‰
- å‡å°‘SQLè§£æå’Œæ‰§è¡Œè®¡åˆ’ç”Ÿæˆæ¬¡æ•°
- ç›´æ¥åœ¨æ•°æ®åº“å±‚é¢æ‰¹é‡å¤„ç†ï¼Œé€Ÿåº¦å¿«

ğŸ”¸ **èµ„æºä¼˜åŠ¿**
- ä¸éœ€è¦æŠŠå¤§é‡æ•°æ®åŠ è½½åˆ°åº”ç”¨å†…å­˜
- å‡è½»åº”ç”¨æœåŠ¡å™¨çš„å†…å­˜å‹åŠ›
- æ•°æ®åº“æœåŠ¡å™¨ç›´æ¥å¤„ç†ï¼Œæ•ˆç‡æ›´é«˜

### 1.3 æ‰¹é‡æ“ä½œçš„ä½¿ç”¨åœºæ™¯


**âœ… é€‚åˆä½¿ç”¨æ‰¹é‡æ“ä½œ**ï¼š

```
æ‰¹é‡ä¿®æ”¹åœºæ™¯ï¼š
- æ‰¹é‡ä¿®æ”¹ç”¨æˆ·çŠ¶æ€
- æ‰¹é‡æ›´æ–°åº“å­˜æ•°é‡
- æ‰¹é‡è°ƒæ•´ä»·æ ¼
- æ‰¹é‡æ ‡è®°å·²è¯»/æœªè¯»

æ‰¹é‡åˆ é™¤åœºæ™¯ï¼š
- åˆ é™¤è¿‡æœŸæ•°æ®
- æ¸…ç†æµ‹è¯•æ•°æ®
- åˆ é™¤æ— æ•ˆè®°å½•
- å½’æ¡£å†å²æ•°æ®
```

**âŒ ä¸é€‚åˆä½¿ç”¨æ‰¹é‡æ“ä½œ**ï¼š

```
éœ€è¦ä¸šåŠ¡é€»è¾‘å¤„ç†çš„åœºæ™¯ï¼š
- ä¿®æ”¹å‰éœ€è¦å¤æ‚è®¡ç®—
- éœ€è¦è§¦å‘ä¸šåŠ¡äº‹ä»¶
- éœ€è¦è®°å½•è¯¦ç»†æ—¥å¿—
- éœ€è¦æ•°æ®éªŒè¯

è¿™äº›æƒ…å†µè¿˜æ˜¯è¦è€è€å®å®æŸ¥å‡ºæ¥ï¼Œä¸€æ¡ä¸€æ¡å¤„ç†
```

---

## 2. ğŸ“ @Modifyingæ³¨è§£è¯¦è§£


### 2.1 @Modifyingæ³¨è§£çš„ä½œç”¨


**ç®€å•ç†è§£**ï¼š`@Modifying`å°±æ˜¯å‘Šè¯‰Springï¼š"è¿™ä¸ªæ–¹æ³•ä¸æ˜¯æŸ¥è¯¢ï¼Œæ˜¯è¦ä¿®æ”¹æ•°æ®çš„ï¼"

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰@Modifyingï¼ŒSpringä¼šå½“æˆæŸ¥è¯¢
@Query("UPDATE User u SET u.status = ?1 WHERE u.id = ?2")
int updateStatus(String status, Long id);  // è¿è¡Œæ—¶æŠ¥é”™ï¼

// âœ… æ­£ç¡®ï¼šåŠ ä¸Š@Modifyingï¼ŒSpringçŸ¥é“è¿™æ˜¯ä¿®æ”¹æ“ä½œ
@Modifying
@Query("UPDATE User u SET u.status = ?1 WHERE u.id = ?2")
int updateStatus(String status, Long id);  // æ­£å¸¸æ‰§è¡Œ
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ³¨è§£ï¼Ÿ**

```
Spring Data JPAçš„é»˜è®¤è¡Œä¸ºï¼š
1. çœ‹åˆ°@Query â†’ è®¤ä¸ºæ˜¯æŸ¥è¯¢æ“ä½œ
2. æ‰§è¡Œæ–¹å¼ â†’ ç”¨entityManager.createQuery()
3. æœŸæœ›è¿”å› â†’ æŸ¥è¯¢ç»“æœ

åŠ ä¸Š@Modifyingåï¼š
1. çœ‹åˆ°@Modifying â†’ çŸ¥é“æ˜¯ä¿®æ”¹æ“ä½œ
2. æ‰§è¡Œæ–¹å¼ â†’ ç”¨query.executeUpdate()
3. æœŸæœ›è¿”å› â†’ å—å½±å“çš„è¡Œæ•°
```

### 2.2 @Modifyingçš„é‡è¦å±æ€§


**æ ¸å¿ƒå±æ€§å¯¹ç…§è¡¨**ï¼š

| å±æ€§å | **ä½œç”¨** | **é»˜è®¤å€¼** | **ä½¿ç”¨åœºæ™¯** |
|-------|---------|-----------|------------|
| `clearAutomatically` | `æ‰§è¡Œåè‡ªåŠ¨æ¸…ç©ºä¸€çº§ç¼“å­˜` | `false` | `é˜²æ­¢ç¼“å­˜ä¸ä¸€è‡´` |
| `flushAutomatically` | `æ‰§è¡Œå‰è‡ªåŠ¨åˆ·æ–°ç¼“å­˜` | `false` | `ç¡®ä¿å¾…ä¿å­˜æ•°æ®å…ˆå†™å…¥` |

### 2.3 clearAutomaticallyè¯¦è§£


**ä½œç”¨**ï¼šæ‰§è¡Œå®Œæ‰¹é‡æ“ä½œåï¼Œè‡ªåŠ¨æ¸…ç©ºä¸€çº§ç¼“å­˜

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ** çœ‹ä¸€ä¸ªå®é™…é—®é¢˜ï¼š

```java
// åœºæ™¯ï¼šå…ˆæŸ¥è¯¢ï¼Œåæ‰¹é‡æ›´æ–°ï¼Œå†æŸ¥è¯¢
User user = repository.findById(1L);  // æŸ¥è¯¢ç”¨æˆ·ï¼Œæ­¤æ—¶ç¼“å­˜ä¸­æœ‰user
System.out.println(user.getStatus());  // è¾“å‡ºï¼šINACTIVE

// æ‰¹é‡æ›´æ–°æ•°æ®åº“
@Modifying
@Query("UPDATE User u SET u.status = 'ACTIVE' WHERE u.id = 1")
int updateStatus();  // æ•°æ®åº“å·²æ›´æ–°

// å†æ¬¡æŸ¥è¯¢
User userAgain = repository.findById(1L);  // ä»ç¼“å­˜å–ï¼
System.out.println(userAgain.getStatus());  // è¾“å‡ºï¼šINACTIVEï¼ˆé”™äº†ï¼ï¼‰
```

**é—®é¢˜åˆ†æ**ï¼š

```
æ‰§è¡Œè¿‡ç¨‹ï¼š
1. ç¬¬ä¸€æ¬¡æŸ¥è¯¢ â†’ useråŠ è½½åˆ°ä¸€çº§ç¼“å­˜
2. æ‰¹é‡æ›´æ–° â†’ ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œç»•è¿‡ç¼“å­˜
3. ç¬¬äºŒæ¬¡æŸ¥è¯¢ â†’ ç¼“å­˜å‘½ä¸­ï¼Œè¿”å›æ—§æ•°æ®

æ•°æ®åº“ä¸­çš„å€¼ï¼šACTIVE
ç¼“å­˜ä¸­çš„å€¼ï¼šINACTIVE
çœ‹åˆ°çš„å€¼ï¼šINACTIVEï¼ˆé”™è¯¯çš„æ—§å€¼ï¼‰
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// âœ… ä½¿ç”¨clearAutomatically
@Modifying(clearAutomatically = true)
@Query("UPDATE User u SET u.status = 'ACTIVE' WHERE u.id = 1")
int updateStatus();

// æ‰§è¡Œåä¼šè‡ªåŠ¨è°ƒç”¨ï¼š
entityManager.clear();  // æ¸…ç©ºä¸€çº§ç¼“å­˜

// å†æ¬¡æŸ¥è¯¢æ—¶ä¼šä»æ•°æ®åº“é‡æ–°åŠ è½½
User userAgain = repository.findById(1L);  // ä»æ•°æ®åº“æŸ¥
System.out.println(userAgain.getStatus());  // è¾“å‡ºï¼šACTIVEï¼ˆæ­£ç¡®ï¼ï¼‰
```

### 2.4 flushAutomaticallyè¯¦è§£


**ä½œç”¨**ï¼šæ‰§è¡Œæ‰¹é‡æ“ä½œå‰ï¼Œå…ˆæŠŠç¼“å­˜ä¸­æœªä¿å­˜çš„æ•°æ®åˆ·åˆ°æ•°æ®åº“

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ** çœ‹å¦ä¸€ä¸ªé—®é¢˜ï¼š

```java
// åœºæ™¯ï¼šå…ˆä¿®æ”¹å®ä½“ï¼Œå†æ‰¹é‡æ›´æ–°
User user = repository.findById(1L);
user.setName("å¼ ä¸‰");  // ä¿®æ”¹äº†ï¼Œä½†è¿˜åœ¨ç¼“å­˜ä¸­ï¼Œæ²¡å†™æ•°æ®åº“

// æ‰¹é‡æ›´æ–°
@Modifying
@Query("UPDATE User u SET u.status = 'ACTIVE' WHERE u.id = 1")
int updateStatus();  // æ­¤æ—¶æ•°æ®åº“ä¸­nameè¿˜æ˜¯æ—§å€¼ï¼

// äº‹åŠ¡æäº¤æ—¶
// æ•°æ®åº“æ“ä½œé¡ºåºï¼š
// 1. UPDATE user SET status='ACTIVE' WHERE id=1  (æ‰¹é‡æ›´æ–°)
// 2. UPDATE user SET name='å¼ ä¸‰' WHERE id=1      (ä¿å­˜å®ä½“)
// ç»“æœï¼šnameè¢«æ›´æ–°äº†ï¼Œä½†statuså¯èƒ½è¢«è¦†ç›–å›æ—§å€¼ï¼
```

**é—®é¢˜åˆ†æ**ï¼š

```
æ‰§è¡Œé¡ºåºé—®é¢˜ï¼š
1. ä¿®æ”¹å®ä½“ â†’ æ•°æ®åœ¨å†…å­˜ä¸­ï¼Œæ ‡è®°ä¸ºè„æ•°æ®
2. æ‰¹é‡æ›´æ–° â†’ ç›´æ¥æ“ä½œæ•°æ®åº“
3. äº‹åŠ¡æäº¤ â†’ è„æ•°æ®åŒæ­¥åˆ°æ•°æ®åº“ï¼ˆè¦†ç›–æ‰¹é‡æ›´æ–°ç»“æœï¼‰

æ•°æ®åº“çœ‹åˆ°çš„é¡ºåºï¼š
æ‰¹é‡UPDATE â†’ å®ä½“UPDATEï¼ˆå¯èƒ½å†²çªï¼‰
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// âœ… ä½¿ç”¨flushAutomatically
@Modifying(flushAutomatically = true)
@Query("UPDATE User u SET u.status = 'ACTIVE' WHERE u.id = 1")
int updateStatus();

// æ‰§è¡Œå‰ä¼šè‡ªåŠ¨è°ƒç”¨ï¼š
entityManager.flush();  // å…ˆæŠŠç¼“å­˜æ•°æ®åˆ·åˆ°æ•°æ®åº“

// æ•°æ®åº“çœ‹åˆ°çš„é¡ºåºï¼š
// 1. UPDATE user SET name='å¼ ä¸‰' WHERE id=1      (å…ˆä¿å­˜å®ä½“)
// 2. UPDATE user SET status='ACTIVE' WHERE id=1  (å†æ‰¹é‡æ›´æ–°)
// ç»“æœï¼šä¸¤ä¸ªæ“ä½œéƒ½ç”Ÿæ•ˆï¼Œæ²¡æœ‰å†²çª
```

### 2.5 ä¸¤ä¸ªå±æ€§çš„é…åˆä½¿ç”¨


**æœ€ä½³å®è·µ**ï¼š

```java
// ğŸŒŸ æ¨èï¼šä¸¤ä¸ªå±æ€§ä¸€èµ·ç”¨
@Modifying(clearAutomatically = true, flushAutomatically = true)
@Query("UPDATE User u SET u.status = ?1 WHERE u.department = ?2")
int updateStatusByDept(String status, String dept);

æ‰§è¡Œè¿‡ç¨‹ï¼š
1. flushAutomatically=true  â†’ å…ˆä¿å­˜ç¼“å­˜ä¸­çš„ä¿®æ”¹
2. æ‰§è¡Œæ‰¹é‡æ›´æ–°            â†’ æ“ä½œæ•°æ®åº“
3. clearAutomatically=true â†’ æ¸…ç©ºç¼“å­˜
4. åç»­æŸ¥è¯¢               â†’ ä»æ•°æ®åº“è·å–æœ€æ–°æ•°æ®
```

**è®°å¿†å£è¯€**ï¼š

```
ğŸ“Œ æ‰¹é‡æ“ä½œè®°å¿ƒé—´ï¼Œä¸¤ä¸ªå±æ€§ä¿å¹³å®‰
   flushå…ˆåˆ·é˜²å†²çªï¼Œclearåæ¸…ä¿ä¸€è‡´
   ä¸€èµ·ä½¿ç”¨æœ€ä¿é™©ï¼Œæ•°æ®å‡†ç¡®ä¸å‡ºé”™
```

---

## 3. ğŸ”„ æ‰¹é‡æ›´æ–°æ“ä½œ


### 3.1 åŸºç¡€æ‰¹é‡æ›´æ–°


**ç®€å•æ›´æ–°ç¤ºä¾‹**ï¼š

```java
public interface UserRepository extends JpaRepository<User, Long> {
    
    // ğŸ”¸ æ ¹æ®IDæ›´æ–°çŠ¶æ€
    @Modifying
    @Query("UPDATE User u SET u.status = ?1 WHERE u.id = ?2")
    int updateStatus(String status, Long id);
    
    // ğŸ”¸ æ ¹æ®éƒ¨é—¨æ‰¹é‡æ›´æ–°
    @Modifying
    @Query("UPDATE User u SET u.status = ?1 WHERE u.department = ?2")
    int updateStatusByDept(String status, String department);
    
    // ğŸ”¸ æ›´æ–°å¤šä¸ªå­—æ®µ
    @Modifying
    @Query("UPDATE User u SET u.status = ?1, u.updateTime = ?2 WHERE u.id = ?3")
    int updateStatusAndTime(String status, LocalDateTime time, Long id);
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Transactional  // âš ï¸ å¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
    public void batchUpdateStatus() {
        // å°†ITéƒ¨é—¨æ‰€æœ‰å‘˜å·¥æ”¹ä¸ºæ¿€æ´»çŠ¶æ€
        int count = userRepository.updateStatusByDept("ACTIVE", "IT");
        System.out.println("æ›´æ–°äº†" + count + "æ¡è®°å½•");
    }
}
```

### 3.2 æ¡ä»¶æ‰¹é‡æ›´æ–°


**å¤æ‚æ¡ä»¶ç¤ºä¾‹**ï¼š

```java
public interface OrderRepository extends JpaRepository<Order, Long> {
    
    // ğŸ”¸ å¤šæ¡ä»¶æ›´æ–°
    @Modifying
    @Query("UPDATE Order o SET o.status = ?1 " +
           "WHERE o.orderDate < ?2 AND o.status = 'PENDING'")
    int updateExpiredOrders(String newStatus, LocalDate beforeDate);
    
    // ğŸ”¸ ä½¿ç”¨å‘½åå‚æ•°ï¼ˆæ›´æ¸…æ™°ï¼‰
    @Modifying
    @Query("UPDATE Order o SET o.status = :status " +
           "WHERE o.totalAmount > :amount AND o.paymentStatus = 'UNPAID'")
    int updateHighValueOrders(@Param("status") String status, 
                              @Param("amount") BigDecimal amount);
    
    // ğŸ”¸ å­æŸ¥è¯¢æ›´æ–°
    @Modifying
    @Query("UPDATE Product p SET p.stock = p.stock - 1 " +
           "WHERE p.id IN (SELECT oi.product.id FROM OrderItem oi WHERE oi.order.id = ?1)")
    int decreaseStockByOrder(Long orderId);
}
```

### 3.3 è®¡ç®—æ›´æ–°


**æ•°å€¼è®¡ç®—ç¤ºä¾‹**ï¼š

```java
public interface ProductRepository extends JpaRepository<Product, Long> {
    
    // ğŸ”¸ å¢åŠ åº“å­˜
    @Modifying
    @Query("UPDATE Product p SET p.stock = p.stock + ?1 WHERE p.id = ?2")
    int increaseStock(Integer quantity, Long productId);
    
    // ğŸ”¸ æ‰¹é‡æ‰“æŠ˜
    @Modifying
    @Query("UPDATE Product p SET p.price = p.price * ?1 WHERE p.category = ?2")
    int discountByCategory(BigDecimal rate, String category);
    
    // ğŸ”¸ é‡ç½®è®¡æ•°å™¨
    @Modifying
    @Query("UPDATE Product p SET p.viewCount = 0 WHERE p.updateTime < ?1")
    int resetOldViewCount(LocalDateTime beforeDate);
}
```

### 3.4 æ‰¹é‡æ›´æ–°è¿”å›å€¼


**è¿”å›å€¼ç±»å‹è¯´æ˜**ï¼š

```java
public interface UserRepository extends JpaRepository<User, Long> {
    
    // âœ… è¿”å›intï¼šå—å½±å“çš„è¡Œæ•°ï¼ˆæ¨èï¼‰
    @Modifying
    @Query("UPDATE User u SET u.status = ?1 WHERE u.department = ?2")
    int updateStatus(String status, String dept);
    
    // âœ… è¿”å›Integerï¼šå—å½±å“çš„è¡Œæ•°ï¼ˆå¯ä¸ºnullï¼‰
    @Modifying
    @Query("UPDATE User u SET u.status = ?1 WHERE u.department = ?2")
    Integer updateStatusReturnInteger(String status, String dept);
    
    // âœ… è¿”å›voidï¼šä¸å…³å¿ƒå½±å“è¡Œæ•°
    @Modifying
    @Query("UPDATE User u SET u.status = ?1 WHERE u.department = ?2")
    void updateStatusNoReturn(String status, String dept);
    
    // âŒ é”™è¯¯ï¼šæ‰¹é‡æ›´æ–°ä¸èƒ½è¿”å›å®ä½“
    @Modifying
    @Query("UPDATE User u SET u.status = ?1 WHERE u.id = ?2")
    User updateAndReturn(String status, Long id);  // ç¼–è¯‘é”™è¯¯ï¼
}
```

**è¿”å›å€¼å¤„ç†ç¤ºä¾‹**ï¼š

```java
@Service
public class UserService {
    
    @Transactional
    public void updateWithCheck() {
        int count = userRepository.updateStatus("ACTIVE", "IT");
        
        if (count == 0) {
            throw new BusinessException("æ²¡æœ‰æ‰¾åˆ°è¦æ›´æ–°çš„æ•°æ®");
        }
        
        System.out.println("æˆåŠŸæ›´æ–°" + count + "æ¡è®°å½•");
    }
}
```

---

## 4. ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤æ“ä½œ


### 4.1 åŸºç¡€æ‰¹é‡åˆ é™¤


**ç®€å•åˆ é™¤ç¤ºä¾‹**ï¼š

```java
public interface UserRepository extends JpaRepository<User, Long> {
    
    // ğŸ”¸ æ ¹æ®çŠ¶æ€åˆ é™¤
    @Modifying
    @Query("DELETE FROM User u WHERE u.status = ?1")
    int deleteByStatus(String status);
    
    // ğŸ”¸ æ ¹æ®éƒ¨é—¨åˆ é™¤
    @Modifying
    @Query("DELETE FROM User u WHERE u.department = ?1")
    int deleteByDepartment(String department);
    
    // ğŸ”¸ åˆ é™¤æŒ‡å®šIDåˆ—è¡¨
    @Modifying
    @Query("DELETE FROM User u WHERE u.id IN ?1")
    int deleteByIdList(List<Long> ids);
}
```

**ä½¿ç”¨æ³¨æ„**ï¼š

```java
@Service
public class UserService {
    
    @Transactional  // âš ï¸ åˆ é™¤ä¹Ÿå¿…é¡»åœ¨äº‹åŠ¡ä¸­
    public void cleanInactiveUsers() {
        int count = userRepository.deleteByStatus("INACTIVE");
        System.out.println("åˆ é™¤äº†" + count + "ä¸ªä¸æ´»è·ƒç”¨æˆ·");
    }
}
```

### 4.2 æ¡ä»¶æ‰¹é‡åˆ é™¤


**å¤æ‚æ¡ä»¶åˆ é™¤**ï¼š

```java
public interface LogRepository extends JpaRepository<Log, Long> {
    
    // ğŸ”¸ åˆ é™¤è¿‡æœŸæ—¥å¿—
    @Modifying
    @Query("DELETE FROM Log l WHERE l.createTime < ?1")
    int deleteOldLogs(LocalDateTime beforeDate);
    
    // ğŸ”¸ å¤šæ¡ä»¶åˆ é™¤
    @Modifying
    @Query("DELETE FROM Log l WHERE l.level = ?1 AND l.createTime < ?2")
    int deleteByLevelAndDate(String level, LocalDateTime beforeDate);
    
    // ğŸ”¸ åˆ é™¤å…³è”æ•°æ®ï¼ˆéœ€è¦æ³¨æ„å¤–é”®ï¼‰
    @Modifying
    @Query("DELETE FROM OrderItem oi WHERE oi.order.id = ?1")
    int deleteOrderItems(Long orderId);
}
```

### 4.3 æ‰¹é‡åˆ é™¤çš„é™·é˜±


**âš ï¸ çº§è”åˆ é™¤é—®é¢˜**ï¼š

```java
// å®ä½“å®šä¹‰
@Entity
public class User {
    @Id
    private Long id;
    
    // ä¸€å¯¹å¤šå…³ç³»
    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL)
    private List<Order> orders;
}

// âŒ å±é™©ï¼šç›´æ¥åˆ é™¤çˆ¶å®ä½“
@Modifying
@Query("DELETE FROM User u WHERE u.status = 'INACTIVE'")
int deleteInactiveUsers();  
// é—®é¢˜ï¼šå¯èƒ½è¿åå¤–é”®çº¦æŸï¼Œæˆ–è€…é—ç•™å­¤å„¿æ•°æ®

// âœ… å®‰å…¨åšæ³•1ï¼šå…ˆåˆ é™¤å…³è”æ•°æ®
@Transactional
public void safeDeleteUser(Long userId) {
    orderRepository.deleteByUserId(userId);  // å…ˆåˆ è®¢å•
    userRepository.deleteById(userId);        // å†åˆ ç”¨æˆ·
}

// âœ… å®‰å…¨åšæ³•2ï¼šè®©æ•°æ®åº“å¤„ç†çº§è”
@Modifying
@Query(value = "DELETE FROM user WHERE status = ?1", nativeSQL = true)
int deleteInactiveUsersNative(String status);
// å‰æï¼šæ•°æ®åº“ä¸­é…ç½®äº†ON DELETE CASCADE
```

**ğŸ”¸ è½¯åˆ é™¤ vs ç¡¬åˆ é™¤**ï¼š

```java
// ç¡¬åˆ é™¤ï¼šçœŸæ­£åˆ é™¤æ•°æ®
@Modifying
@Query("DELETE FROM User u WHERE u.id = ?1")
int hardDelete(Long id);

// è½¯åˆ é™¤ï¼šåªæ ‡è®°åˆ é™¤ï¼ˆæ¨èï¼‰
@Modifying
@Query("UPDATE User u SET u.deleted = true, u.deleteTime = ?2 WHERE u.id = ?1")
int softDelete(Long id, LocalDateTime deleteTime);

// è½¯åˆ é™¤çš„å¥½å¤„ï¼š
// 1. æ•°æ®å¯æ¢å¤
// 2. ä¸ç ´åå…³è”å…³ç³»
// 3. å¯ä»¥ä¿ç•™å®¡è®¡è®°å½•
```

---

## 5. ğŸ’¾ ä¸€çº§ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜


### 5.1 ä»€ä¹ˆæ˜¯ä¸€çº§ç¼“å­˜


**é€šä¿—ç†è§£**ï¼šä¸€çº§ç¼“å­˜å°±åƒæ˜¯JPAçš„"è®°äº‹æœ¬"

```
æ²¡æœ‰ç¼“å­˜çš„æƒ…å†µï¼š
æ¯æ¬¡æŸ¥è¯¢éƒ½è¦å»æ•°æ®åº“
â”Œâ”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº”ç”¨ â”‚ â”€â”€â”€â”€â†’ â”‚ æ•°æ®åº“   â”‚
â”‚     â”‚ â†â”€â”€â”€â”€ â”‚          â”‚
â””â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æŸ¥10æ¬¡ = 10æ¬¡æ•°æ®åº“è®¿é—®

æœ‰ä¸€çº§ç¼“å­˜çš„æƒ…å†µï¼š
ç¬¬ä¸€æ¬¡æŸ¥è¯¢åï¼Œæ•°æ®å­˜åœ¨"è®°äº‹æœ¬"
â”Œâ”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº”ç”¨ â”‚ â”€â”€â”€â”€â†’ â”‚ ä¸€çº§ç¼“å­˜  â”‚ â”€â”€â”€â”€â†’ â”‚ æ•°æ®åº“ â”‚
â”‚     â”‚ â†â”€â”€â”€â”€ â”‚(è®°äº‹æœ¬)  â”‚ â†â”€â”€â”€â”€ â”‚        â”‚
â””â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æŸ¥10æ¬¡ = 1æ¬¡æ•°æ®åº“ + 9æ¬¡ç¼“å­˜
```

**ä¸€çº§ç¼“å­˜çš„ç‰¹ç‚¹**ï¼š

```
ğŸ”¸ ä½œç”¨èŒƒå›´ï¼šä¸€ä¸ªäº‹åŠ¡å†…
ğŸ”¸ ç”Ÿå‘½å‘¨æœŸï¼šäº‹åŠ¡ç»“æŸå°±é”€æ¯
ğŸ”¸ é»˜è®¤å¼€å¯ï¼šä¸éœ€è¦é…ç½®ï¼ŒJPAè‡ªåŠ¨ç®¡ç†
ğŸ”¸ ç¼“å­˜å†…å®¹ï¼šæŸ¥è¯¢è¿‡çš„å®ä½“å¯¹è±¡
```

### 5.2 æ‰¹é‡æ“ä½œä¸ç¼“å­˜å†²çª


**é—®é¢˜åœºæ™¯æ¼”ç¤º**ï¼š

```java
@Service
public class UserService {
    
    @Transactional
    public void problematicUpdate() {
        // æ­¥éª¤1ï¼šæŸ¥è¯¢ç”¨æˆ·ï¼ˆè¿›å…¥ç¼“å­˜ï¼‰
        User user = userRepository.findById(1L).get();
        System.out.println("æŸ¥è¯¢ç»“æœï¼š" + user.getStatus());  // INACTIVE
        
        // æ­¥éª¤2ï¼šæ‰¹é‡æ›´æ–°æ•°æ®åº“
        userRepository.updateStatus("ACTIVE", 1L);
        // æ­¤æ—¶ï¼šæ•°æ®åº“æ˜¯ACTIVEï¼Œç¼“å­˜è¿˜æ˜¯INACTIVE
        
        // æ­¥éª¤3ï¼šå†æ¬¡æŸ¥è¯¢ï¼ˆä»ç¼“å­˜å–ï¼‰
        User user2 = userRepository.findById(1L).get();
        System.out.println("å†æ¬¡æŸ¥è¯¢ï¼š" + user2.getStatus());  // INACTIVEï¼ˆé”™äº†ï¼ï¼‰
        
        // æ­¥éª¤4ï¼šç›´æ¥ä½¿ç”¨ä¹‹å‰çš„å¯¹è±¡
        System.out.println("åŸå¯¹è±¡ï¼š" + user.getStatus());  // INACTIVEï¼ˆé”™äº†ï¼ï¼‰
    }
}
```

**é—®é¢˜åˆ†æå›¾ç¤º**ï¼š

```
æ—¶é—´çº¿ï¼š
T1: findById(1) â”€â†’ æŸ¥æ•°æ®åº“ â”€â†’ userå¯¹è±¡åŠ å…¥ç¼“å­˜
                   status = INACTIVE
                   
T2: æ‰¹é‡UPDATE  â”€â†’ ç›´æ¥æ”¹æ•°æ®åº“ â”€â†’ æ•°æ®åº“status = ACTIVE
                   â†“
                   ç¼“å­˜ä¸çŸ¥é“ï¼userå¯¹è±¡è¿˜æ˜¯INACTIVE
                   
T3: findById(1) â”€â†’ ä»ç¼“å­˜å– â”€â†’ è¿”å›INACTIVEï¼ˆé”™è¯¯ï¼ï¼‰

æ•°æ®åº“ï¼šACTIVE
ç¼“å­˜ï¼š  INACTIVE
çœ‹åˆ°ï¼š  INACTIVE  â† æ•°æ®ä¸ä¸€è‡´ï¼
```

### 5.3 è§£å†³æ–¹æ¡ˆè¯¦è§£


**æ–¹æ¡ˆ1ï¼šä½¿ç”¨clearAutomatically**

```java
// âœ… è‡ªåŠ¨æ¸…ç©ºç¼“å­˜
@Modifying(clearAutomatically = true)
@Query("UPDATE User u SET u.status = ?1 WHERE u.id = ?2")
int updateStatus(String status, Long id);

@Transactional
public void updateWithClear() {
    User user = userRepository.findById(1L).get();
    
    userRepository.updateStatus("ACTIVE", 1L);
    // è‡ªåŠ¨æ‰§è¡Œï¼šentityManager.clear()
    
    User user2 = userRepository.findById(1L).get();  // é‡æ–°ä»æ•°æ®åº“æŸ¥
    System.out.println(user2.getStatus());  // ACTIVEï¼ˆæ­£ç¡®ï¼ï¼‰
}
```

**æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨åˆ·æ–°å®ä½“**

```java
@Transactional
public void updateWithRefresh() {
    User user = userRepository.findById(1L).get();
    
    userRepository.updateStatus("ACTIVE", 1L);
    
    entityManager.refresh(user);  // ä»æ•°æ®åº“åˆ·æ–°è¿™ä¸ªå¯¹è±¡
    System.out.println(user.getStatus());  // ACTIVEï¼ˆæ­£ç¡®ï¼ï¼‰
}
```

**æ–¹æ¡ˆ3ï¼šæ‰‹åŠ¨æ¸…ç©ºç¼“å­˜**

```java
@Transactional
public void updateWithManualClear() {
    User user = userRepository.findById(1L).get();
    
    userRepository.updateStatus("ACTIVE", 1L);
    
    entityManager.clear();  // æ¸…ç©ºæ•´ä¸ªç¼“å­˜
    
    User user2 = userRepository.findById(1L).get();  // é‡æ–°æŸ¥
    System.out.println(user2.getStatus());  // ACTIVEï¼ˆæ­£ç¡®ï¼ï¼‰
}
```

**æ–¹æ¡ˆ4ï¼šåˆ†å¼€äº‹åŠ¡**

```java
// æ‰¹é‡æ›´æ–°ç”¨ç‹¬ç«‹äº‹åŠ¡
@Transactional(propagation = Propagation.REQUIRES_NEW)
public void batchUpdate() {
    userRepository.updateStatus("ACTIVE", 1L);
}

// æŸ¥è¯¢ç”¨å¦ä¸€ä¸ªäº‹åŠ¡
@Transactional
public void query() {
    batchUpdate();  // ç‹¬ç«‹äº‹åŠ¡ï¼Œç»“æŸåè‡ªåŠ¨æ¸…ç¼“å­˜
    User user = userRepository.findById(1L).get();  // æ–°äº‹åŠ¡ï¼Œé‡æ–°æŸ¥
    System.out.println(user.getStatus());  // ACTIVEï¼ˆæ­£ç¡®ï¼ï¼‰
}
```

### 5.4 æœ€ä½³å®è·µæ€»ç»“


**æ¨èæ–¹æ¡ˆå¯¹æ¯”**ï¼š

| åœºæ™¯ | **æ¨èæ–¹æ¡ˆ** | **åŸå› ** |
|-----|------------|---------|
| ğŸ“Œ **æ‰¹é‡æ›´æ–°åè¿˜è¦æŸ¥è¯¢** | `clearAutomatically=true` | `æœ€ç®€å•ï¼Œè‡ªåŠ¨å¤„ç†` |
| ğŸ“Œ **åªæ›´æ–°ä¸æŸ¥è¯¢** | `ä¸éœ€è¦å¤„ç†` | `æ²¡æœ‰ç¼“å­˜å†²çªé—®é¢˜` |
| ğŸ“Œ **éœ€è¦ç«‹å³çœ‹åˆ°æ›´æ–°ç»“æœ** | `refresh(entity)` | `åªåˆ·æ–°ç‰¹å®šå¯¹è±¡` |
| ğŸ“Œ **å¤§é‡æ‰¹é‡æ“ä½œ** | `ç‹¬ç«‹äº‹åŠ¡+clear()` | `æ€§èƒ½æ›´å¥½` |

**è®°å¿†å£è¯€**ï¼š

```
ğŸ“Œ æ‰¹é‡æ“ä½œè¦å°å¿ƒï¼Œç¼“å­˜é—®é¢˜è®°åœ¨å¿ƒ
   æ›´æ–°ç»•è¿‡ç¼“å­˜èµ°ï¼ŒæŸ¥è¯¢è¿˜ä»ç¼“å­˜å–
   clearAutomaticallyï¼Œä¸€é”®è§£å†³ä¸è´¹åŠ›
   æ‰‹åŠ¨åˆ·æ–°ä¹Ÿå¯è¡Œï¼Œé€‰å¯¹æ–¹æ¡ˆæœ€é‡è¦
```

---

## 6. ğŸ¯ æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ


### 6.1 äº‹åŠ¡ç®¡ç†


**å¿…é¡»ä½¿ç”¨äº‹åŠ¡**ï¼š

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰äº‹åŠ¡
public void updateWithoutTransaction() {
    userRepository.updateStatus("ACTIVE", 1L);
    // è¿è¡Œæ—¶å¼‚å¸¸ï¼šNo EntityManager with actual transaction available
}

// âœ… æ­£ç¡®ï¼šåŠ ä¸Š@Transactional
@Transactional
public void updateWithTransaction() {
    userRepository.updateStatus("ACTIVE", 1L);  // æ­£å¸¸æ‰§è¡Œ
}
```

**äº‹åŠ¡ä¼ æ’­è¡Œä¸º**ï¼š

```java
@Service
public class BatchService {
    
    // åœºæ™¯ï¼šæ‰¹é‡æ“ä½œè¦ç‹¬ç«‹æäº¤
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void independentBatchUpdate() {
        userRepository.updateAllStatus("ACTIVE");
        // è¿™ä¸ªæ“ä½œä¼šç«‹å³æäº¤ï¼Œä¸å—å¤–éƒ¨äº‹åŠ¡å½±å“
    }
    
    @Transactional
    public void outerTransaction() {
        // åšä¸€äº›æ“ä½œ
        independentBatchUpdate();  // ç‹¬ç«‹äº‹åŠ¡æ‰§è¡Œ
        // å³ä½¿è¿™é‡Œå‡ºé”™å›æ»šï¼Œæ‰¹é‡æ›´æ–°ä¹Ÿå·²ç»æäº¤äº†
    }
}
```

### 6.2 æ€§èƒ½ä¼˜åŒ–æŠ€å·§


**æ‰¹é‡æ“ä½œ vs å¾ªç¯ä¿å­˜**ï¼š

```java
// âŒ ä½æ•ˆæ–¹å¼ï¼šå¾ªç¯ä¿å­˜
@Transactional
public void inefficientUpdate(List<Long> userIds) {
    for (Long id : userIds) {
        User user = userRepository.findById(id).get();
        user.setStatus("ACTIVE");
        userRepository.save(user);
    }
    // 1000ä¸ªç”¨æˆ· = 1000æ¬¡SELECT + 1000æ¬¡UPDATE
}

// âœ… é«˜æ•ˆæ–¹å¼ï¼šæ‰¹é‡æ›´æ–°
@Transactional
public void efficientUpdate(List<Long> userIds) {
    userRepository.updateStatusByIds("ACTIVE", userIds);
    // 1000ä¸ªç”¨æˆ· = 1æ¬¡UPDATE
}

@Modifying
@Query("UPDATE User u SET u.status = ?1 WHERE u.id IN ?2")
int updateStatusByIds(String status, List<Long> ids);
```

**åˆ†æ‰¹å¤„ç†å¤§æ•°æ®é‡**ï¼š

```java
@Service
public class LargeDataService {
    
    private static final int BATCH_SIZE = 1000;
    
    @Transactional
    public void updateLargeDataset(List<Long> allIds) {
        // å°†100ä¸‡æ¡æ•°æ®åˆ†æ‰¹å¤„ç†
        for (int i = 0; i < allIds.size(); i += BATCH_SIZE) {
            int end = Math.min(i + BATCH_SIZE, allIds.size());
            List<Long> batch = allIds.subList(i, end);
            
            userRepository.updateStatusByIds("ACTIVE", batch);
            
            // æ¯æ‰¹å¤„ç†åæ¸…ç†ç¼“å­˜ï¼Œé‡Šæ”¾å†…å­˜
            entityManager.clear();
        }
    }
}
```

### 6.3 å®‰å…¨æ€§æ£€æŸ¥


**è¿”å›å€¼éªŒè¯**ï¼š

```java
@Transactional
public void updateWithValidation(String dept) {
    int count = userRepository.updateStatusByDept("ACTIVE", dept);
    
    if (count == 0) {
        throw new BusinessException("éƒ¨é—¨" + dept + "ä¸å­˜åœ¨æˆ–æ²¡æœ‰æ•°æ®");
    }
    
    if (count > 1000) {
        throw new BusinessException("æ›´æ–°æ•°é‡è¿‡å¤šï¼Œè¯·æ£€æŸ¥æ¡ä»¶");
    }
    
    System.out.println("æˆåŠŸæ›´æ–°" + count + "æ¡æ•°æ®");
}
```

**SQLæ³¨å…¥é˜²æŠ¤**ï¼š

```java
// âŒ å±é™©ï¼šå­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆå¯èƒ½SQLæ³¨å…¥ï¼‰
@Modifying
@Query("UPDATE User u SET u.status = '" + status + "' WHERE u.id = " + id)
int unsafeUpdate();  // ä¸è¦è¿™æ ·å†™ï¼

// âœ… å®‰å…¨ï¼šä½¿ç”¨å‚æ•°ç»‘å®š
@Modifying
@Query("UPDATE User u SET u.status = ?1 WHERE u.id = ?2")
int safeUpdate(String status, Long id);

// âœ… å®‰å…¨ï¼šä½¿ç”¨å‘½åå‚æ•°
@Modifying
@Query("UPDATE User u SET u.status = :status WHERE u.id = :id")
int safeUpdateNamed(@Param("status") String status, @Param("id") Long id);
```

### 6.4 å¼‚å¸¸å¤„ç†


**å®Œæ•´çš„å¼‚å¸¸å¤„ç†ç¤ºä¾‹**ï¼š

```java
@Service
public class SafeBatchService {
    
    @Transactional(rollbackFor = Exception.class)
    public void safeUpdate(String dept) {
        try {
            // æ‰§è¡Œæ‰¹é‡æ›´æ–°
            int count = userRepository.updateStatusByDept("ACTIVE", dept);
            
            // è®°å½•æ—¥å¿—
            System.out.println("æ›´æ–°äº†" + count + "æ¡è®°å½•");
            
            // æ¸…ç†ç¼“å­˜
            entityManager.clear();
            
        } catch (DataIntegrityViolationException e) {
            // æ•°æ®å®Œæ•´æ€§å¼‚å¸¸ï¼ˆå¦‚å¤–é”®çº¦æŸï¼‰
            throw new BusinessException("æ›´æ–°å¤±è´¥ï¼šå­˜åœ¨å…³è”æ•°æ®çº¦æŸ", e);
            
        } catch (PersistenceException e) {
            // æŒä¹…åŒ–å¼‚å¸¸
            throw new BusinessException("æ•°æ®åº“æ“ä½œå¤±è´¥", e);
            
        } catch (Exception e) {
            // å…¶ä»–å¼‚å¸¸
            throw new BusinessException("æ›´æ–°å¤±è´¥ï¼š" + e.getMessage(), e);
        }
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ‰¹é‡æ“ä½œæœ¬è´¨ï¼šç›´æ¥åœ¨æ•°æ®åº“æ‰§è¡ŒSQLï¼Œä¸ç»è¿‡JPAç¼“å­˜
ğŸ”¸ @Modifyingä½œç”¨ï¼šæ ‡è®°ä¿®æ”¹æ“ä½œï¼Œå‘Šè¯‰Springè¿™ä¸æ˜¯æŸ¥è¯¢
ğŸ”¸ clearAutomaticallyï¼šæ‰§è¡Œåæ¸…ç©ºç¼“å­˜ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
ğŸ”¸ flushAutomaticallyï¼šæ‰§è¡Œå‰åˆ·æ–°ç¼“å­˜ï¼Œé¿å…æ“ä½œå†²çª
ğŸ”¸ ä¸€çº§ç¼“å­˜é—®é¢˜ï¼šæ‰¹é‡æ“ä½œç»•è¿‡ç¼“å­˜ï¼Œå¯èƒ½å¯¼è‡´è„è¯»
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ‰¹é‡æ“ä½œçš„æœ¬è´¨**

```
æ™®é€šä¿å­˜æµç¨‹ï¼š
æŸ¥è¯¢ â†’ åŠ è½½åˆ°å†…å­˜ â†’ ä¿®æ”¹å¯¹è±¡ â†’ ç”ŸæˆSQL â†’ æ‰§è¡Œ
ï¼ˆç»è¿‡ç¼“å­˜ï¼Œæœ‰å¯¹è±¡çŠ¶æ€ç®¡ç†ï¼‰

æ‰¹é‡æ“ä½œæµç¨‹ï¼š
ç›´æ¥æ‰§è¡ŒSQL â†’ ä¿®æ”¹æ•°æ®åº“
ï¼ˆä¸ç»è¿‡ç¼“å­˜ï¼Œçº¯SQLæ“ä½œï¼‰

ä¼˜åŠ¿ï¼šå¿«é€Ÿé«˜æ•ˆ
åŠ£åŠ¿ï¼šç»•è¿‡ç¼“å­˜ï¼Œéœ€è¦æ‰‹åŠ¨ç»´æŠ¤ä¸€è‡´æ€§
```

**ğŸ”¹ ä¸¤ä¸ªå±æ€§çš„é…åˆ**

```
flushAutomatically = trueï¼š
ä½œç”¨æ—¶æœºï¼šæ‰¹é‡æ“ä½œæ‰§è¡Œã€å‰ã€‘
ç›®çš„ï¼šæŠŠç¼“å­˜ä¸­æœªä¿å­˜çš„æ•°æ®å…ˆå†™å…¥æ•°æ®åº“
é˜²æ­¢ï¼šç¼“å­˜æ•°æ®åœ¨äº‹åŠ¡æäº¤æ—¶è¦†ç›–æ‰¹é‡æ›´æ–°ç»“æœ

clearAutomatically = trueï¼š
ä½œç”¨æ—¶æœºï¼šæ‰¹é‡æ“ä½œæ‰§è¡Œã€åã€‘
ç›®çš„ï¼šæ¸…ç©ºç¼“å­˜ä¸­çš„æ—§æ•°æ®
é˜²æ­¢ï¼šåç»­æŸ¥è¯¢è¯»åˆ°è¿‡æœŸçš„ç¼“å­˜æ•°æ®

è®°å¿†ï¼šflushåœ¨å‰ä¿å†™å…¥ï¼Œclearåœ¨åä¿è¯»å–
```

**ğŸ”¹ äº‹åŠ¡çš„å¿…è¦æ€§**

```
ä¸ºä»€ä¹ˆå¿…é¡»åŠ @Transactionalï¼š

1. æ‰¹é‡æ“ä½œéœ€è¦EntityManager
   @Transactional â†’ åˆ›å»ºEntityManager
   æ²¡æœ‰äº‹åŠ¡ â†’ æ²¡æœ‰EntityManager â†’ è¿è¡ŒæŠ¥é”™

2. ä¿è¯æ•°æ®ä¸€è‡´æ€§
   å¤šä¸ªæ“ä½œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥

3. ç®¡ç†ç¼“å­˜ç”Ÿå‘½å‘¨æœŸ
   äº‹åŠ¡è¾¹ç•Œ = ç¼“å­˜è¾¹ç•Œ
```

### 7.3 å®é™…åº”ç”¨å»ºè®®


**âœ… æ¨èåšæ³•**ï¼š

```java
// 1. æ ‡å‡†çš„æ‰¹é‡æ›´æ–°æ¨¡æ¿
@Modifying(clearAutomatically = true, flushAutomatically = true)
@Transactional
@Query("UPDATE User u SET u.status = ?1 WHERE u.department = ?2")
int updateByDept(String status, String dept);

// 2. å¤§æ•°æ®é‡åˆ†æ‰¹å¤„ç†
@Transactional
public void batchProcess(List<Long> ids) {
    for (int i = 0; i < ids.size(); i += 1000) {
        List<Long> batch = ids.subList(i, Math.min(i + 1000, ids.size()));
        repository.updateBatch(batch);
        entityManager.clear();  // æ¯æ‰¹æ¸…ç†ç¼“å­˜
    }
}

// 3. æ›´æ–°åéªŒè¯ç»“æœ
int count = repository.updateStatus("ACTIVE", "IT");
if (count == 0) {
    throw new BusinessException("æ²¡æœ‰æ‰¾åˆ°è¦æ›´æ–°çš„æ•°æ®");
}
```

**âŒ é¿å…çš„åšæ³•**ï¼š

```java
// 1. å¿˜è®°åŠ @Modifying
@Query("UPDATE User u SET u.status = ?1")
int update(String status);  // è¿è¡Œæ—¶æŠ¥é”™

// 2. å¿˜è®°åŠ @Transactional
public void update() {
    repository.updateStatus("ACTIVE", 1L);  // è¿è¡Œæ—¶æŠ¥é”™
}

// 3. æ‰¹é‡æ›´æ–°åç›´æ¥ä½¿ç”¨ç¼“å­˜å¯¹è±¡
@Transactional
public void wrong() {
    User user = repository.findById(1L).get();
    repository.updateStatus("ACTIVE", 1L);
    System.out.println(user.getStatus());  // è¾“å‡ºæ—§å€¼ï¼
}

// 4. å¤§æ•°æ®é‡ä¸€æ¬¡æ€§å¤„ç†
repository.updateByIds(millionIds);  // å¯èƒ½OOMæˆ–è¶…æ—¶
```

### 7.4 è®°å¿†å£è¯€


```
ğŸ“Œ æ‰¹é‡æ“ä½œä¸‰è¦ç´ ï¼ŒModifyingäº‹åŠ¡ç¼“å­˜æ¸…
   ç›´æ¥æ•°æ®åº“æ‰§è¡Œå¿«ï¼Œç»•è¿‡ç¼“å­˜è¦å°å¿ƒ
   ä¸¤ä¸ªå±æ€§é…åˆç”¨ï¼Œflushåœ¨å‰clearåœ¨å
   å¤§æ•°æ®åˆ†æ‰¹å¤„ç†å¥½ï¼ŒéªŒè¯ç»“æœåˆ«å¿˜æ‰
```

### 7.5 å¸¸è§é—®é¢˜é€ŸæŸ¥


| é—®é¢˜ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|-----|---------|------------|
| â“ **No EntityManager** | `æ²¡æœ‰äº‹åŠ¡` | `åŠ @Transactional` |
| â“ **æŸ¥è¯¢ç»“æœæ˜¯æ—§å€¼** | `ç¼“å­˜æ²¡æ¸…ç†` | `clearAutomatically=true` |
| â“ **æ‰¹é‡æ›´æ–°è¢«è¦†ç›–** | `ç¼“å­˜æ•°æ®åæäº¤` | `flushAutomatically=true` |
| â“ **å†…å­˜æº¢å‡º** | `æ•°æ®é‡å¤ªå¤§` | `åˆ†æ‰¹å¤„ç†+æ¸…ç†ç¼“å­˜` |
| â“ **è¿”å›å€¼æ˜¯0** | `æ¡ä»¶ä¸åŒ¹é…æˆ–æ•°æ®ä¸å­˜åœ¨` | `æ£€æŸ¥æ¡ä»¶+éªŒè¯è¿”å›å€¼` |

---

**æ ¸å¿ƒè®°å¿†**ï¼š
- æ‰¹é‡æ“ä½œå°±æ˜¯ç›´æ¥æ“ä½œæ•°æ®åº“çš„SQLï¼Œå¿«ä½†è¦æ³¨æ„ç¼“å­˜
- @Modifying + @Transactional æ˜¯æ ‡é…ï¼Œç¼ºä¸€ä¸å¯
- clearAutomaticallyå’ŒflushAutomaticallyä¿è¯æ•°æ®ä¸€è‡´æ€§
- å¤§æ•°æ®é‡è¦åˆ†æ‰¹ï¼Œæ¯æ‰¹è¦æ¸…ç¼“å­˜
- è¿”å›å€¼è¦éªŒè¯ï¼Œå¼‚å¸¸è¦å¤„ç†