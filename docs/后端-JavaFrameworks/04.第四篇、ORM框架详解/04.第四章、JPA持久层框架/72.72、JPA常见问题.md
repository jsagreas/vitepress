---
title: 72ã€JPAå¸¸è§é—®é¢˜
---
## ğŸ“š ç›®å½•

1. [å¸¸è§å¼‚å¸¸æ·±åº¦è§£æ](#1-å¸¸è§å¼‚å¸¸æ·±åº¦è§£æ)
2. [æ€§èƒ½é—®é¢˜æ’æŸ¥ä¸ä¼˜åŒ–](#2-æ€§èƒ½é—®é¢˜æ’æŸ¥ä¸ä¼˜åŒ–)
3. [æœ€ä½³å®è·µæŒ‡å—](#3-æœ€ä½³å®è·µæŒ‡å—)
4. [è°ƒè¯•æŠ€å·§ä¸å·¥å…·](#4-è°ƒè¯•æŠ€å·§ä¸å·¥å…·)
5. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#5-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš¨ å¸¸è§å¼‚å¸¸æ·±åº¦è§£æ


### 1.1 LazyInitializationException - æ‡’åŠ è½½å¼‚å¸¸


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ‡’åŠ è½½å¼‚å¸¸ï¼Ÿ**

ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä½ æƒ³è®¿é—®å…³è”æ•°æ®æ—¶ï¼Œæ•°æ®åº“è¿æ¥å·²ç»å…³é—­äº†ã€‚å°±åƒä½ æƒ³ä»å†°ç®±æ‹¿ä¸œè¥¿ï¼Œä½†å†°ç®±é—¨å·²ç»é”ä¸Šäº†ã€‚

```
åœºæ™¯æ¨¡æ‹Ÿï¼š

ç”¨æˆ·åœ¨é¡µé¢æŸ¥çœ‹è®¢å•è¯¦æƒ… â†’ éœ€è¦æ˜¾ç¤ºè®¢å•å•†å“
1. Serviceå±‚æŸ¥è¯¢è®¢å•ï¼ˆæ•°æ®åº“è¿æ¥æ‰“å¼€ï¼‰
2. è¿”å›è®¢å•å¯¹è±¡ï¼ˆæ•°æ®åº“è¿æ¥å…³é—­ï¼‰
3. é¡µé¢å°è¯•è®¿é—®order.getItems()ï¼ˆè¿æ¥å·²å…³é—­ï¼‰
4. ğŸ’¥ LazyInitializationExceptionï¼
```

**ğŸ’¡ ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿï¼Ÿ**

```java
// å®ä½“ç±»å®šä¹‰
@Entity
public class Order {
    @Id
    private Long id;
    
    // é»˜è®¤æ˜¯æ‡’åŠ è½½ï¼šç”¨åˆ°æ—¶æ‰æŸ¥è¯¢
    @OneToMany(fetch = FetchType.LAZY)
    private List<OrderItem> items;
}

// æœåŠ¡å±‚ä»£ç 
@Transactional
public Order getOrder(Long id) {
    return orderRepository.findById(id).get();
    // æ–¹æ³•ç»“æŸï¼Œäº‹åŠ¡å…³é—­ï¼Œæ•°æ®åº“è¿æ¥é‡Šæ”¾
}

// æ§åˆ¶å™¨ä»£ç 
public String showOrder(Long id) {
    Order order = orderService.getOrder(id);
    // âš ï¸ æ­¤æ—¶æ•°æ®åº“è¿æ¥å·²å…³é—­
    order.getItems().size(); // ğŸ’¥ å¼‚å¸¸åœ¨è¿™é‡ŒæŠ›å‡ºï¼
}
```

**âœ… è§£å†³æ–¹æ¡ˆå¯¹æ¯”**

| æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|------|------|
| **æ”¹ä¸ºç«‹å³åŠ è½½** | æ€»æ˜¯éœ€è¦å…³è”æ•°æ® | ç®€å•ç›´æ¥ | å¯èƒ½åŠ è½½ä¸éœ€è¦çš„æ•°æ® |
| **JOIN FETCH** | ç‰¹å®šæŸ¥è¯¢éœ€è¦ | ä¸€æ¡SQLå®Œæˆ | éœ€è¦è‡ªå®šä¹‰æŸ¥è¯¢ |
| **DTOæŠ•å½±** | åªéœ€éƒ¨åˆ†å­—æ®µ | æ€§èƒ½æœ€ä¼˜ | éœ€è¦é¢å¤–ç±» |
| **Open Session in View** | å¿«é€Ÿä¿®å¤ | æ— éœ€æ”¹ä»£ç  | å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜ |

**ğŸ”§ æ¨èè§£å†³æ–¹æ¡ˆ**

```java
// æ–¹æ¡ˆ1ï¼šä½¿ç”¨JOIN FETCHï¼ˆæ¨èï¼‰
@Query("SELECT o FROM Order o JOIN FETCH o.items WHERE o.id = :id")
Order findByIdWithItems(@Param("id") Long id);

// æ–¹æ¡ˆ2ï¼šä½¿ç”¨DTOæŠ•å½±
public interface OrderDTO {
    Long getId();
    String getOrderNumber();
    List<OrderItemDTO> getItems();
}

@Query("SELECT o FROM Order o LEFT JOIN FETCH o.items WHERE o.id = :id")
OrderDTO findOrderDTO(@Param("id") Long id);

// æ–¹æ¡ˆ3ï¼šåœ¨äº‹åŠ¡å†…è®¿é—®ï¼ˆé€‚åˆç®€å•åœºæ™¯ï¼‰
@Transactional(readOnly = true)
public OrderVO getOrderDetail(Long id) {
    Order order = orderRepository.findById(id).get();
    // åœ¨äº‹åŠ¡å†…è®¿é—®ï¼Œè¿æ¥æœªå…³é—­
    order.getItems().size(); // âœ… æ­£å¸¸å·¥ä½œ
    return convertToVO(order);
}
```

> ğŸ’¡ **æ–°æ‰‹æç¤º**ï¼šä¼˜å…ˆä½¿ç”¨JOIN FETCHï¼Œå®ƒæ—¢è§£å†³é—®é¢˜åˆä¿æŒæ€§èƒ½ã€‚é¿å…ä½¿ç”¨Open Session in Viewï¼Œå®ƒä¼šè®©æ•°æ®åº“è¿æ¥ä¿æŒå¤ªä¹…ã€‚

---

### 1.2 MultipleBagFetchException - å¤šåŒ…è·å–å¼‚å¸¸


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¤šåŒ…å¼‚å¸¸ï¼Ÿ**

å½“ä½ åŒæ—¶æ‡’åŠ è½½å¤šä¸ªé›†åˆå…³ç³»æ—¶ï¼ŒHibernateä¼š"è’™åœˆ"ï¼Œä¸çŸ¥é“è¯¥æ€ä¹ˆç»„è£…æ•°æ®ã€‚å°±åƒè®©ä½ åŒæ—¶ç”¨ä¸¤åªæ‰‹åˆ†åˆ«è£…ä¸¤è¢‹ä¸œè¥¿ï¼Œä¼šå¾ˆæ··ä¹±ã€‚

```
é”™è¯¯ç¤ºä¾‹ï¼š

è®¢å•æœ‰å¤šä¸ªå•†å“ (items)
è®¢å•æœ‰å¤šä¸ªä»˜æ¬¾è®°å½• (payments)
åŒæ—¶JOIN FETCHè¿™ä¸¤ä¸ªé›†åˆ â†’ ğŸ’¥ å¼‚å¸¸ï¼
```

**ğŸ’¡ ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿï¼Ÿ**

```java
// å®ä½“å®šä¹‰
@Entity
public class Order {
    @OneToMany
    private List<OrderItem> items;      // é›†åˆ1
    
    @OneToMany
    private List<Payment> payments;     // é›†åˆ2
}

// âŒ é”™è¯¯çš„æŸ¥è¯¢
@Query("SELECT o FROM Order o " +
       "JOIN FETCH o.items " +      // ç¬¬ä¸€ä¸ªé›†åˆ
       "JOIN FETCH o.payments " +   // ç¬¬äºŒä¸ªé›†åˆ
       "WHERE o.id = :id")
Order findWithAll(@Param("id") Long id);
// ğŸ’¥ MultipleBagFetchException
```

**åŸç†è§£é‡Šï¼š**

```
æ•°æ®åº“è¿”å›çš„ç¬›å¡å°”ç§¯ï¼š

Order  |  Item     |  Payment
-------|-----------|----------
1      |  item1    |  pay1
1      |  item1    |  pay2
1      |  item2    |  pay1
1      |  item2    |  pay2

Hibernateä¸çŸ¥é“å¦‚ä½•æ­£ç¡®åˆ†ç»„ï¼
åº”è¯¥æ˜¯ï¼š
- Order 1 æœ‰ items [item1, item2]
- Order 1 æœ‰ payments [pay1, pay2]
```

**âœ… è§£å†³æ–¹æ¡ˆ**

```java
// æ–¹æ¡ˆ1ï¼šåˆ†æ‰¹æŸ¥è¯¢ï¼ˆæ¨èæ–°æ‰‹ï¼‰
@Transactional(readOnly = true)
public OrderVO getOrderComplete(Long id) {
    // ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼šè®¢å• + å•†å“
    Order order = orderRepository.findByIdWithItems(id);
    
    // ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼šåŠ è½½ä»˜æ¬¾è®°å½•
    order.getPayments().size(); // è§¦å‘ç¬¬äºŒæ¬¡æŸ¥è¯¢
    
    return convertToVO(order);
}

// æ–¹æ¡ˆ2ï¼šä½¿ç”¨Setä»£æ›¿Listï¼ˆHibernateçš„é™åˆ¶ï¼‰
@Entity
public class Order {
    @OneToMany
    private Set<OrderItem> items;    // æ”¹ç”¨Set
    
    @OneToMany
    private Set<Payment> payments;   // æ”¹ç”¨Set
}
// ç°åœ¨å¯ä»¥åŒæ—¶JOIN FETCH

// æ–¹æ¡ˆ3ï¼šä½¿ç”¨@EntityGraphï¼ˆæ¨èï¼‰
@EntityGraph(attributePaths = {"items", "payments"})
@Query("SELECT o FROM Order o WHERE o.id = :id")
Order findByIdWithGraph(@Param("id") Long id);

// æ–¹æ¡ˆ4ï¼šåˆ†å¼€ä¸¤ä¸ªæŸ¥è¯¢æ–¹æ³•
@Query("SELECT o FROM Order o JOIN FETCH o.items WHERE o.id = :id")
Order findByIdWithItems(Long id);

@Query("SELECT o FROM Order o JOIN FETCH o.payments WHERE o.id = :id")
Order findByIdWithPayments(Long id);
```

> âš ï¸ **æ³¨æ„**ï¼šå¦‚æœå¿…é¡»ä½¿ç”¨Listï¼Œå°±åˆ†æ‰¹æŸ¥è¯¢ã€‚å¦‚æœå¯ä»¥ç”¨Setï¼Œå¯ä»¥åŒæ—¶åŠ è½½ï¼Œä½†è¦æ³¨æ„Setçš„æ— åºæ€§ã€‚

---

### 1.3 NonUniqueResultException - éå”¯ä¸€ç»“æœå¼‚å¸¸


**ğŸ”¸ ä»€ä¹ˆæ˜¯éå”¯ä¸€ç»“æœå¼‚å¸¸ï¼Ÿ**

ä½ æœŸæœ›æŸ¥è¯¢è¿”å›ä¸€æ¡æ•°æ®ï¼Œä½†å®é™…è¿”å›äº†å¤šæ¡ã€‚å°±åƒä½ é—®"è°æ˜¯ç­é•¿"ï¼Œç»“æœæœ‰ä¸¤ä¸ªäººåŒæ—¶ä¸¾æ‰‹ã€‚

```java
// âŒ é”™è¯¯åœºæ™¯
@Query("SELECT u FROM User u WHERE u.name = :name")
User findByName(@Param("name") String name);

// è°ƒç”¨
User user = userRepository.findByName("å¼ ä¸‰");
// å¦‚æœæœ‰ä¸¤ä¸ªå«"å¼ ä¸‰"çš„ç”¨æˆ· â†’ ğŸ’¥ NonUniqueResultException
```

**ğŸ’¡ å¸¸è§åŸå› **

```
1. æ•°æ®è´¨é‡é—®é¢˜
   â”œâ”€ æ•°æ®é‡å¤å½•å…¥
   â”œâ”€ ç¼ºå°‘å”¯ä¸€çº¦æŸ
   â””â”€ å†å²æ•°æ®æ¸…ç†ä¸å½“

2. æŸ¥è¯¢æ¡ä»¶ä¸å¤Ÿç²¾ç¡®
   â”œâ”€ åªç”¨nameæŸ¥è¯¢ï¼Œåº”è¯¥åŠ å…¶ä»–æ¡ä»¶
   â”œâ”€ è½¯åˆ é™¤æ•°æ®æœªè¿‡æ»¤
   â””â”€ å¤šç§Ÿæˆ·æ•°æ®æœªéš”ç¦»

3. è¿”å›ç±»å‹é”™è¯¯
   â””â”€ åº”è¯¥è¿”å›Listï¼Œå´å£°æ˜ä¸ºå•ä¸ªå¯¹è±¡
```

**âœ… è§£å†³æ–¹æ¡ˆ**

```java
// æ–¹æ¡ˆ1ï¼šè¿”å›Listï¼ˆæ¨èï¼‰
@Query("SELECT u FROM User u WHERE u.name = :name")
List<User> findByName(@Param("name") String name);

// æ–¹æ¡ˆ2ï¼šæ·»åŠ æ›´å¤šæ¡ä»¶
@Query("SELECT u FROM User u WHERE u.name = :name AND u.email = :email")
User findByNameAndEmail(@Param("name") String name, 
                        @Param("email") String email);

// æ–¹æ¡ˆ3ï¼šä½¿ç”¨Optionalå¤„ç†
@Query("SELECT u FROM User u WHERE u.username = :username")
Optional<User> findByUsername(@Param("username") String username);

// è°ƒç”¨æ—¶æ£€æŸ¥
Optional<User> userOpt = userRepository.findByUsername("admin");
if (userOpt.isPresent()) {
    User user = userOpt.get();
    // ä¸šåŠ¡é€»è¾‘
}

// æ–¹æ¡ˆ4ï¼šæ·»åŠ LIMITï¼ˆä»…å–ç¬¬ä¸€æ¡ï¼‰
@Query(value = "SELECT * FROM user WHERE name = :name LIMIT 1", 
       nativeSQL = true)
User findFirstByName(@Param("name") String name);

// æ–¹æ¡ˆ5ï¼šä½¿ç”¨Spring Dataçš„Firstå…³é”®å­—
User findFirstByName(String name); // è‡ªåŠ¨åŠ LIMIT 1
```

> ğŸ’¡ **æœ€ä½³å®è·µ**ï¼šå¦‚æœæŸ¥è¯¢æ¡ä»¶å¯èƒ½åŒ¹é…å¤šæ¡ï¼Œå§‹ç»ˆè¿”å›Listã€‚åªæœ‰ç»å¯¹å”¯ä¸€çš„å­—æ®µï¼ˆå¦‚IDã€usernameï¼‰æ‰è¿”å›å•ä¸ªå¯¹è±¡ã€‚

---

### 1.4 OptimisticLockException - ä¹è§‚é”å¼‚å¸¸


**ğŸ”¸ ä»€ä¹ˆæ˜¯ä¹è§‚é”å¼‚å¸¸ï¼Ÿ**

ä¸¤ä¸ªäººåŒæ—¶ç¼–è¾‘åŒä¸€æ¡æ•°æ®ï¼Œç¬¬äºŒä¸ªäººä¿å­˜æ—¶å‘ç°æ•°æ®å·²ç»è¢«æ”¹è¿‡äº†ã€‚å°±åƒä¸¤ä¸ªäººåŒæ—¶ç¼–è¾‘åŒä¸€ä¸ªWordæ–‡æ¡£ï¼Œåä¿å­˜çš„ä¼šæç¤º"æ–‡ä»¶å·²è¢«ä¿®æ”¹"ã€‚

**ğŸ’¡ å·¥ä½œåŸç†æ¼”ç¤º**

```java
// å®ä½“å®šä¹‰
@Entity
public class Product {
    @Id
    private Long id;
    
    private String name;
    private BigDecimal price;
    
    @Version  // ç‰ˆæœ¬å·å­—æ®µï¼Œè‡ªåŠ¨ç®¡ç†
    private Long version;
}
```

**æ—¶é—´çº¿æ¨¡æ‹Ÿï¼š**

```
æ—¶åˆ»    ç”¨æˆ·A                          ç”¨æˆ·B
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
10:00   æŸ¥è¯¢å•†å“(id=1, price=100, version=1)
10:01                                æŸ¥è¯¢å•†å“(id=1, price=100, version=1)
10:02   ä¿®æ”¹ä»·æ ¼ä¸º120
10:03   ä¿å­˜æˆåŠŸ(versionè‡ªåŠ¨å˜ä¸º2)
10:04                                ä¿®æ”¹ä»·æ ¼ä¸º110
10:05                                ä¿å­˜å¤±è´¥ ğŸ’¥
                                     OptimisticLockException
                                     (æœŸæœ›version=1ï¼Œå®é™…æ˜¯2)
```

**å®é™…SQLæ‰§è¡Œï¼š**

```sql
-- ç”¨æˆ·Aä¿å­˜æ—¶çš„SQL
UPDATE product 
SET price = 120, version = 2 
WHERE id = 1 AND version = 1;  -- âœ… å½±å“1è¡Œï¼ŒæˆåŠŸ

-- ç”¨æˆ·Bä¿å­˜æ—¶çš„SQL  
UPDATE product 
SET price = 110, version = 2
WHERE id = 1 AND version = 1;  -- âŒ å½±å“0è¡Œï¼Œå¤±è´¥
```

**âœ… å¤„ç†æ–¹æ¡ˆ**

```java
// æ–¹æ¡ˆ1ï¼šæ•è·å¼‚å¸¸å¹¶é‡è¯•ï¼ˆæ¨èï¼‰
@Service
public class ProductService {
    
    @Transactional
    public void updatePrice(Long id, BigDecimal newPrice) {
        int maxRetries = 3;
        int attempt = 0;
        
        while (attempt < maxRetries) {
            try {
                Product product = productRepository.findById(id).get();
                product.setPrice(newPrice);
                productRepository.save(product);
                return; // æˆåŠŸï¼Œé€€å‡º
                
            } catch (OptimisticLockException e) {
                attempt++;
                if (attempt >= maxRetries) {
                    throw new BusinessException("å•†å“æ­£åœ¨è¢«ä»–äººä¿®æ”¹ï¼Œè¯·ç¨åå†è¯•");
                }
                // çŸ­æš‚ç­‰å¾…åé‡è¯•
                Thread.sleep(100 * attempt);
            }
        }
    }
}

// æ–¹æ¡ˆ2ï¼šæç¤ºç”¨æˆ·åˆ·æ–°
@ExceptionHandler(OptimisticLockException.class)
public ResponseEntity<?> handleOptimisticLock(OptimisticLockException e) {
    return ResponseEntity
        .status(HttpStatus.CONFLICT)
        .body("æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•");
}

// æ–¹æ¡ˆ3ï¼šå¼ºåˆ¶è¦†ç›–ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
@Modifying
@Query("UPDATE Product p SET p.price = :price WHERE p.id = :id")
void forceUpdatePrice(@Param("id") Long id, 
                      @Param("price") BigDecimal price);
// âš ï¸ ç»•è¿‡ç‰ˆæœ¬æ£€æŸ¥ï¼Œå¯èƒ½ä¸¢å¤±å…¶ä»–äººçš„ä¿®æ”¹
```

> ğŸ’¡ **ä½¿ç”¨å»ºè®®**ï¼š
> - é‡è¦æ•°æ®ï¼ˆä»·æ ¼ã€åº“å­˜ï¼‰ï¼šä½¿ç”¨ä¹è§‚é” + é‡è¯•
> - ä¸€èˆ¬æ•°æ®ï¼ˆæè¿°ã€å¤‡æ³¨ï¼‰ï¼šæç¤ºç”¨æˆ·åˆ·æ–°
> - ä¸é‡è¦æ•°æ®ï¼šå¯ä»¥è€ƒè™‘å¼ºåˆ¶è¦†ç›–

---

### 1.5 PersistenceException - æŒä¹…åŒ–å¼‚å¸¸


**ğŸ”¸ ä»€ä¹ˆæ˜¯æŒä¹…åŒ–å¼‚å¸¸ï¼Ÿ**

è¿™æ˜¯JPAçš„é€šç”¨å¼‚å¸¸ï¼ŒåŒ…å«å„ç§æ•°æ®åº“æ“ä½œå¤±è´¥çš„æƒ…å†µã€‚å°±åƒ"ç³»ç»Ÿé”™è¯¯"ä¸€æ ·ï¼Œéœ€è¦çœ‹å…·ä½“åŸå› ã€‚

**ğŸ’¡ å¸¸è§å­ç±»å‹**

```
PersistenceException
â”œâ”€ EntityExistsException (å®ä½“å·²å­˜åœ¨)
â”œâ”€ EntityNotFoundException (å®ä½“æœªæ‰¾åˆ°)
â”œâ”€ NonUniqueResultException (ç»“æœä¸å”¯ä¸€)
â”œâ”€ OptimisticLockException (ä¹è§‚é”å†²çª)
â”œâ”€ PessimisticLockException (æ‚²è§‚é”å†²çª)
â””â”€ TransactionRequiredException (ç¼ºå°‘äº‹åŠ¡)
```

**æ¡ˆä¾‹1ï¼šå®ä½“å·²å­˜åœ¨**

```java
// âŒ é”™è¯¯ä»£ç 
@Transactional
public void createUser(User user) {
    user.setId(1L); // æ‰‹åŠ¨è®¾ç½®ID
    userRepository.save(user); 
    // å¦‚æœID=1å·²å­˜åœ¨ â†’ EntityExistsException
}

// âœ… æ­£ç¡®åšæ³•
@Transactional
public void createUser(User user) {
    // è®©æ•°æ®åº“è‡ªåŠ¨ç”ŸæˆID
    userRepository.save(user);
}

// æˆ–è€…ï¼šå…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨
@Transactional
public void saveUser(User user) {
    if (user.getId() != null && userRepository.existsById(user.getId())) {
        throw new BusinessException("ç”¨æˆ·å·²å­˜åœ¨");
    }
    userRepository.save(user);
}
```

**æ¡ˆä¾‹2ï¼šç¼ºå°‘äº‹åŠ¡**

```java
// âŒ é”™è¯¯ä»£ç 
public void updateUser(Long id, String name) {
    // æ²¡æœ‰@Transactional
    User user = userRepository.findById(id).get();
    user.setName(name);
    // ğŸ’¥ TransactionRequiredException
    // ä¿®æ”¹æ“ä½œéœ€è¦äº‹åŠ¡ï¼
}

// âœ… æ­£ç¡®åšæ³•
@Transactional  // æ·»åŠ äº‹åŠ¡æ³¨è§£
public void updateUser(Long id, String name) {
    User user = userRepository.findById(id).get();
    user.setName(name);
    // save()ä¼šè‡ªåŠ¨æäº¤
}
```

**æ¡ˆä¾‹3ï¼šæ‚²è§‚é”å†²çª**

```java
// åœºæ™¯ï¼šé«˜å¹¶å‘æŠ¢è´­
@Transactional
public void purchaseProduct(Long productId) {
    // ä½¿ç”¨æ‚²è§‚é”
    Product product = productRepository
        .findById(productId, LockModeType.PESSIMISTIC_WRITE);
    
    if (product.getStock() > 0) {
        product.setStock(product.getStock() - 1);
    } else {
        throw new BusinessException("åº“å­˜ä¸è¶³");
    }
}
// å¦‚æœç­‰å¾…é”è¶…æ—¶ â†’ PessimisticLockException
```

**âœ… é€šç”¨å¤„ç†ç­–ç•¥**

```java
@ControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(PersistenceException.class)
    public ResponseEntity<?> handlePersistence(PersistenceException e) {
        
        // æ ¹æ®å…·ä½“ç±»å‹å¤„ç†
        if (e instanceof EntityExistsException) {
            return ResponseEntity
                .status(HttpStatus.CONFLICT)
                .body("æ•°æ®å·²å­˜åœ¨ï¼Œè¯·å‹¿é‡å¤æäº¤");
        }
        
        if (e instanceof EntityNotFoundException) {
            return ResponseEntity
                .status(HttpStatus.NOT_FOUND)
                .body("æ•°æ®ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤");
        }
        
        if (e instanceof OptimisticLockException) {
            return ResponseEntity
                .status(HttpStatus.CONFLICT)
                .body("æ•°æ®å·²è¢«ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•");
        }
        
        // å…¶ä»–æƒ…å†µè®°å½•æ—¥å¿—
        log.error("æŒä¹…åŒ–å¼‚å¸¸", e);
        return ResponseEntity
            .status(HttpStatus.INTERNAL_SERVER_ERROR)
            .body("æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

---

### 1.6 å¾ªç¯ä¾èµ–é—®é¢˜


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ–ï¼Ÿ**

ä¸¤ä¸ªå®ä½“äº’ç›¸å¼•ç”¨ï¼Œåœ¨åºåˆ—åŒ–ï¼ˆè½¬JSONï¼‰æˆ–åŠ è½½æ—¶é™·å…¥æ­»å¾ªç¯ã€‚å°±åƒä¸¤é¢é•œå­äº’ç›¸ç…§å°„ï¼Œå½¢æˆæ— é™é•œåƒã€‚

**ğŸ’¡ å…¸å‹åœºæ™¯**

```java
// å®ä½“å®šä¹‰
@Entity
public class User {
    @Id
    private Long id;
    
    @OneToMany(mappedBy = "user")
    private List<Order> orders;  // ç”¨æˆ·çš„è®¢å•
}

@Entity
public class Order {
    @Id
    private Long id;
    
    @ManyToOne
    private User user;  // è®¢å•çš„ç”¨æˆ·
}

// è½¬JSONæ—¶çš„é—®é¢˜
User user = userRepository.findById(1L).get();
String json = objectMapper.writeValueAsString(user);

/* æ­»å¾ªç¯è¿‡ç¨‹ï¼š
åºåˆ—åŒ–User 
â†’ åºåˆ—åŒ–ordersåˆ—è¡¨ 
â†’ åºåˆ—åŒ–Order 
â†’ åºåˆ—åŒ–userå­—æ®µ 
â†’ åˆåºåˆ—åŒ–User 
â†’ åˆåºåˆ—åŒ–orders 
â†’ æ— é™å¾ªç¯ ğŸ’¥ StackOverflowError
*/
```

**âœ… è§£å†³æ–¹æ¡ˆ**

```java
// æ–¹æ¡ˆ1ï¼šä½¿ç”¨@JsonManagedReferenceå’Œ@JsonBackReferenceï¼ˆæ¨èæ–°æ‰‹ï¼‰
@Entity
public class User {
    @OneToMany(mappedBy = "user")
    @JsonManagedReference  // æ­£å‘å¼•ç”¨ï¼Œä¼šåºåˆ—åŒ–
    private List<Order> orders;
}

@Entity  
public class Order {
    @ManyToOne
    @JsonBackReference  // åå‘å¼•ç”¨ï¼Œä¸åºåˆ—åŒ–
    private User user;
}
// ç»“æœï¼šUseråŒ…å«ordersï¼Œä½†Orderä¸åŒ…å«user

// æ–¹æ¡ˆ2ï¼šä½¿ç”¨@JsonIgnoreï¼ˆå•å‘å¿½ç•¥ï¼‰
@Entity
public class Order {
    @ManyToOne
    @JsonIgnore  // åºåˆ—åŒ–æ—¶å¿½ç•¥userå­—æ®µ
    private User user;
}

// æ–¹æ¡ˆ3ï¼šä½¿ç”¨DTOï¼ˆæœ€ä½³å®è·µï¼‰
public class UserDTO {
    private Long id;
    private String name;
    private List<OrderDTO> orders;
}

public class OrderDTO {
    private Long id;
    private String orderNumber;
    private BigDecimal amount;
    // ä¸åŒ…å«userå­—æ®µï¼
}

// Serviceå±‚è½¬æ¢
public UserDTO getUserInfo(Long id) {
    User user = userRepository.findById(id).get();
    return convertToDTO(user); // æ‰‹åŠ¨æ§åˆ¶è½¬æ¢
}

// æ–¹æ¡ˆ4ï¼šä½¿ç”¨@JsonIdentityInfoï¼ˆä¿ç•™åŒå‘å¼•ç”¨ï¼‰
@Entity
@JsonIdentityInfo(
    generator = ObjectIdGenerators.PropertyGenerator.class,
    property = "id"
)
public class User {
    // ...
}

@Entity
@JsonIdentityInfo(
    generator = ObjectIdGenerators.PropertyGenerator.class,
    property = "id"
)
public class Order {
    // ...
}
// ç»“æœï¼šé¦–æ¬¡åºåˆ—åŒ–å®Œæ•´å¯¹è±¡ï¼Œåç»­åªæ˜¾ç¤ºID
```

> ğŸ’¡ **æ¨èä½¿ç”¨DTOæ–¹æ¡ˆ**ï¼Œå› ä¸ºï¼š
> - å®Œå…¨æ§åˆ¶è¾“å‡ºå†…å®¹
> - é¿å…æš´éœ²æ•æ„Ÿå­—æ®µ
> - æ€§èƒ½æ›´å¥½ï¼ˆä¸åŠ è½½ä¸éœ€è¦çš„æ•°æ®ï¼‰

---

## 2. ğŸ” æ€§èƒ½é—®é¢˜æ’æŸ¥ä¸ä¼˜åŒ–


### 2.1 N+1æŸ¥è¯¢é—®é¢˜


**ğŸ”¸ ä»€ä¹ˆæ˜¯N+1é—®é¢˜ï¼Ÿ**

æŸ¥è¯¢Næ¡ä¸»è®°å½•æ—¶ï¼Œåˆå¯¹æ¯æ¡è®°å½•æ‰§è¡Œ1æ¬¡é¢å¤–æŸ¥è¯¢ï¼Œæ€»å…±æ‰§è¡ŒN+1æ¬¡SQLã€‚è¿™æ˜¯JPAæœ€å¸¸è§çš„æ€§èƒ½æ€æ‰‹ã€‚

**ç¤ºä¾‹åœºæ™¯ï¼š**

```java
// æŸ¥è¯¢æ‰€æœ‰è®¢å•å¹¶æ˜¾ç¤ºç”¨æˆ·å
List<Order> orders = orderRepository.findAll(); // 1æ¬¡æŸ¥è¯¢

for (Order order : orders) {
    System.out.println(order.getUser().getName()); 
    // æ¯ä¸ªorderæ‰§è¡Œ1æ¬¡æŸ¥è¯¢ â†’ Næ¬¡æŸ¥è¯¢
}
// æ€»å…±ï¼š1 + N æ¬¡SQL
```

**SQLæ‰§è¡Œè¿‡ç¨‹ï¼š**

```sql
-- ç¬¬1æ¬¡ï¼šæŸ¥è¯¢æ‰€æœ‰è®¢å•
SELECT * FROM orders;  -- å‡è®¾è¿”å›100æ¡

-- ç¬¬2-101æ¬¡ï¼šä¸ºæ¯ä¸ªè®¢å•æŸ¥è¯¢ç”¨æˆ·
SELECT * FROM users WHERE id = 1;
SELECT * FROM users WHERE id = 2;
SELECT * FROM users WHERE id = 3;
...
SELECT * FROM users WHERE id = 100;

-- ğŸ˜± æ€»å…±101æ¬¡æ•°æ®åº“è®¿é—®ï¼
```

**âœ… è§£å†³æ–¹æ¡ˆ**

```java
// æ–¹æ¡ˆ1ï¼šJOIN FETCHï¼ˆä¸€æ¬¡æŸ¥è¯¢å®Œæˆï¼‰
@Query("SELECT o FROM Order o JOIN FETCH o.user")
List<Order> findAllWithUser();

// æ‰§è¡Œçš„SQL
SELECT o.*, u.* 
FROM orders o 
INNER JOIN users u ON o.user_id = u.id;
// âœ… åªéœ€1æ¬¡æŸ¥è¯¢

// æ–¹æ¡ˆ2ï¼š@EntityGraph
@EntityGraph(attributePaths = {"user"})
List<Order> findAll();

// æ–¹æ¡ˆ3ï¼šæ‰¹é‡INæŸ¥è¯¢ï¼ˆHibernateè‡ªåŠ¨ä¼˜åŒ–ï¼‰
@Entity
public class Order {
    @ManyToOne(fetch = FetchType.LAZY)
    @Fetch(FetchMode.SUBSELECT)  // ä½¿ç”¨å­æŸ¥è¯¢
    private User user;
}

// æ‰§è¡Œçš„SQL
SELECT * FROM orders;
SELECT * FROM users WHERE id IN (1, 2, 3, ...); 
// âœ… åªéœ€2æ¬¡æŸ¥è¯¢

// æ–¹æ¡ˆ4ï¼šä½¿ç”¨DTOæŠ•å½±
@Query("SELECT new com.example.OrderDTO(o.id, o.number, u.name) " +
       "FROM Order o JOIN o.user u")
List<OrderDTO> findOrderDTOs();
```

**ğŸ“Š æ€§èƒ½å¯¹æ¯”**

| æ–¹æ¡ˆ | SQLæ¬¡æ•° | æ•°æ®é‡ | é€‚ç”¨åœºæ™¯ |
|------|---------|--------|---------|
| N+1é—®é¢˜ | 101æ¬¡ | å®Œæ•´ | âŒ é¿å…ä½¿ç”¨ |
| JOIN FETCH | 1æ¬¡ | å®Œæ•´ | âœ… éœ€è¦å®Œæ•´æ•°æ® |
| INæŸ¥è¯¢ | 2æ¬¡ | å®Œæ•´ | âœ… å…³è”æ•°æ®è¾ƒå¤š |
| DTOæŠ•å½± | 1æ¬¡ | ç²¾ç®€ | âœ… åªéœ€éƒ¨åˆ†å­—æ®µ |

---

### 2.2 æ‰¹é‡æ“ä½œä¼˜åŒ–


**ğŸ”¸ ä¸ºä»€ä¹ˆæ‰¹é‡æ“ä½œæ…¢ï¼Ÿ**

é»˜è®¤æƒ…å†µä¸‹ï¼ŒJPAä¸€æ¡ä¸€æ¡åœ°æ’å…¥æˆ–æ›´æ–°æ•°æ®ï¼Œæ¯æ¬¡éƒ½è¦ä¸æ•°æ®åº“äº¤äº’ã€‚å°±åƒå¯„å¿«é€’ï¼Œä¸€ä¸ªä¸€ä¸ªå¯„è‚¯å®šæ¯”æ‰“åŒ…ä¸€èµ·å¯„æ…¢ã€‚

```java
// âŒ æ…¢é€Ÿæ‰¹é‡æ’å…¥
@Transactional
public void importUsers(List<User> users) {
    for (User user : users) {
        userRepository.save(user);  
        // æ¯æ¬¡saveéƒ½ç«‹å³æ‰§è¡ŒSQL
    }
}
// 1000æ¡æ•°æ® = 1000æ¬¡æ•°æ®åº“è®¿é—®
```

**âœ… æ‰¹é‡ä¼˜åŒ–æ–¹æ¡ˆ**

```java
// æ–¹æ¡ˆ1ï¼šé…ç½®æ‰¹å¤„ç†ï¼ˆæ¨èï¼‰
# application.yml
spring:
  jpa:
    properties:
      hibernate:
        jdbc:
          batch_size: 50  # æ¯æ‰¹å¤„ç†50æ¡
        order_inserts: true
        order_updates: true

// ä»£ç 
@Transactional
public void importUsers(List<User> users) {
    int batchSize = 50;
    for (int i = 0; i < users.size(); i++) {
        userRepository.save(users.get(i));
        
        if (i % batchSize == 0 && i > 0) {
            entityManager.flush();  // æ‰¹é‡æäº¤
            entityManager.clear();  // æ¸…ç©ºç¼“å­˜
        }
    }
}
// 1000æ¡æ•°æ® = 20æ‰¹ = 20æ¬¡æ•°æ®åº“è®¿é—®

// æ–¹æ¡ˆ2ï¼šä½¿ç”¨saveAll
@Transactional
public void importUsers(List<User> users) {
    userRepository.saveAll(users);
    // Spring Dataä¼šè‡ªåŠ¨æ‰¹å¤„ç†
}

// æ–¹æ¡ˆ3ï¼šä½¿ç”¨JDBCæ‰¹å¤„ç†ï¼ˆæœ€å¿«ï¼‰
@Transactional
public void batchInsert(List<User> users) {
    jdbcTemplate.batchUpdate(
        "INSERT INTO users (name, email) VALUES (?, ?)",
        users,
        users.size(),
        (ps, user) -> {
            ps.setString(1, user.getName());
            ps.setString(2, user.getEmail());
        }
    );
}
```

**ğŸ“ˆ æ€§èƒ½æå‡å¯¹æ¯”**

```
æµ‹è¯•ï¼šæ’å…¥10000æ¡æ•°æ®

æ™®é€šå¾ªç¯saveï¼š
â”œâ”€ æ—¶é—´ï¼š45ç§’
â”œâ”€ SQLæ¬¡æ•°ï¼š10000æ¬¡
â””â”€ å¹³å‡ï¼š4.5ms/æ¡

æ‰¹é‡å¤„ç†(batch_size=50)ï¼š
â”œâ”€ æ—¶é—´ï¼š8ç§’
â”œâ”€ SQLæ¬¡æ•°ï¼š200æ‰¹
â””â”€ å¹³å‡ï¼š0.8ms/æ¡

JDBCæ‰¹å¤„ç†ï¼š
â”œâ”€ æ—¶é—´ï¼š2ç§’  
â”œâ”€ SQLæ¬¡æ•°ï¼š1æ¬¡
â””â”€ å¹³å‡ï¼š0.2ms/æ¡
```

---

### 2.3 æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§


**ğŸ”§ ç´¢å¼•ä¼˜åŒ–**

```java
// âŒ æœªå»ºç´¢å¼•ï¼Œå…¨è¡¨æ‰«æ
@Entity
public class User {
    private String email;  // ç»å¸¸ç”¨æ¥æŸ¥è¯¢
}

// âœ… æ·»åŠ ç´¢å¼•
@Entity
@Table(indexes = {
    @Index(name = "idx_email", columnList = "email"),
    @Index(name = "idx_name_status", columnList = "name, status")
})
public class User {
    private String email;
    private String name;
    private String status;
}

// æŸ¥è¯¢ä¼šè‡ªåŠ¨ä½¿ç”¨ç´¢å¼•
List<User> findByEmail(String email);  // ä½¿ç”¨idx_email
List<User> findByNameAndStatus(String name, String status);  // ä½¿ç”¨è”åˆç´¢å¼•
```

**ğŸ¯ åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ**

```java
// âŒ æŸ¥è¯¢å…¨éƒ¨å­—æ®µ
@Query("SELECT u FROM User u WHERE u.status = :status")
List<User> findByStatus(@Param("status") String status);
// SQL: SELECT id, name, email, phone, address, ... FROM users

// âœ… åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
@Query("SELECT u.id, u.name FROM User u WHERE u.status = :status")
List<Object[]> findIdAndNameByStatus(@Param("status") String status);

// æˆ–ä½¿ç”¨DTO
@Query("SELECT new com.example.UserDTO(u.id, u.name) " +
       "FROM User u WHERE u.status = :status")
List<UserDTO> findUserDTOByStatus(@Param("status") String status);
```

**âš¡ åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–**

```java
// âŒ æ·±åˆ†é¡µæ€§èƒ½å·®
Pageable pageable = PageRequest.of(1000, 20);  // ç¬¬1000é¡µ
Page<User> users = userRepository.findAll(pageable);
// SQL: SELECT * FROM users LIMIT 20000, 20
// éœ€è¦è·³è¿‡20000æ¡æ•°æ®ï¼Œå¾ˆæ…¢ï¼

// âœ… ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼ˆæ¨èå¤§æ•°æ®é‡ï¼‰
@Query("SELECT u FROM User u WHERE u.id > :lastId ORDER BY u.id")
List<User> findNextPage(@Param("lastId") Long lastId, Pageable pageable);

// ä½¿ç”¨æ–¹å¼
Long lastId = 0L;
Pageable pageable = PageRequest.of(0, 20);

while (true) {
    List<User> page = userRepository.findNextPage(lastId, pageable);
    if (page.isEmpty()) break;
    
    // å¤„ç†æ•°æ®
    processUsers(page);
    
    // æ›´æ–°æ¸¸æ ‡
    lastId = page.get(page.size() - 1).getId();
}
```

---

## 3. ğŸ¯ æœ€ä½³å®è·µæŒ‡å—


### 3.1 å®ä½“è®¾è®¡æœ€ä½³å®è·µ


**âœ… DOï¼ˆåº”è¯¥åšï¼‰**

```java
// 1. åˆç†ä½¿ç”¨æ‡’åŠ è½½
@Entity
public class Order {
    @ManyToOne(fetch = FetchType.LAZY)  // âœ… å…³è”å®ä½“é»˜è®¤æ‡’åŠ è½½
    private User user;
    
    @OneToMany(fetch = FetchType.LAZY)  // âœ… é›†åˆå…³è”æ‡’åŠ è½½
    private List<OrderItem> items;
}

// 2. ä½¿ç”¨åˆé€‚çš„ç”Ÿæˆç­–ç•¥
@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)  // MySQLæ¨è
private Long id;

@Id
@GeneratedValue(strategy = GenerationType.SEQUENCE)  // Oracle/PostgreSQLæ¨è
private Long id;

// 3. æ·»åŠ å®¡è®¡å­—æ®µ
@Entity
@EntityListeners(AuditingEntityListener.class)
public class BaseEntity {
    @CreatedDate
    private LocalDateTime createTime;
    
    @LastModifiedDate
    private LocalDateTime updateTime;
    
    @CreatedBy
    private String createBy;
    
    @LastModifiedBy
    private String updateBy;
}

// 4. åˆç†ä½¿ç”¨çº§è”æ“ä½œ
@OneToMany(cascade = CascadeType.ALL, orphanRemoval = true)
private List<OrderItem> items;
// åˆ é™¤è®¢å•æ—¶è‡ªåŠ¨åˆ é™¤è®¢å•é¡¹
```

**âŒ DON'Tï¼ˆä¸åº”è¯¥åšï¼‰**

```java
// 1. é¿å…åŒå‘å…³è”éƒ½è®¾ç½®çº§è”
@Entity
public class User {
    @OneToMany(cascade = CascadeType.ALL)  // âŒ å±é™©ï¼
    private List<Order> orders;
}

@Entity
public class Order {
    @ManyToOne(cascade = CascadeType.ALL)  // âŒ å¯èƒ½è¯¯åˆ ç”¨æˆ·ï¼
    private User user;
}

// 2. é¿å…æ‰€æœ‰å…³è”éƒ½ç«‹å³åŠ è½½
@ManyToOne(fetch = FetchType.EAGER)  // âŒ å¯èƒ½å¯¼è‡´å¤§é‡æ•°æ®åŠ è½½
private User user;

// 3. é¿å…åœ¨å®ä½“ä¸­å†™ä¸šåŠ¡é€»è¾‘
@Entity
public class Order {
    public void processPayment() {  // âŒ ä¸šåŠ¡é€»è¾‘åº”åœ¨Serviceå±‚
        // å¤æ‚çš„æ”¯ä»˜å¤„ç†...
    }
}
```

---

### 3.2 äº‹åŠ¡ç®¡ç†æœ€ä½³å®è·µ


```java
// âœ… æ­£ç¡®çš„äº‹åŠ¡ä½¿ç”¨

// 1. åªè¯»äº‹åŠ¡ï¼ˆæå‡æ€§èƒ½ï¼‰
@Transactional(readOnly = true)
public User getUserInfo(Long id) {
    return userRepository.findById(id).get();
}

// 2. åˆç†çš„äº‹åŠ¡è¾¹ç•Œ
@Transactional
public void processOrder(OrderDTO orderDTO) {
    // åˆ›å»ºè®¢å•
    Order order = createOrder(orderDTO);
    
    // å‡åº“å­˜
    decreaseStock(order.getItems());
    
    // å‘é€é€šçŸ¥ï¼ˆä¸åœ¨äº‹åŠ¡å†…ï¼‰
    applicationEventPublisher.publishEvent(
        new OrderCreatedEvent(order.getId())
    );
}

// 3. äº‹åŠ¡ä¼ æ’­è¡Œä¸º
@Transactional(propagation = Propagation.REQUIRES_NEW)
public void saveLog(String message) {
    // ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸å—å¤–éƒ¨äº‹åŠ¡å½±å“
    logRepository.save(new Log(message));
}

// 4. å¼‚å¸¸å›æ»šæ§åˆ¶
@Transactional(rollbackFor = Exception.class)
public void updateUser(User user) {
    userRepository.save(user);
    // ä»»ä½•å¼‚å¸¸éƒ½å›æ»šï¼ŒåŒ…æ‹¬æ£€æŸ¥å¼‚å¸¸
}
```

**âš ï¸ å¸¸è§äº‹åŠ¡é™·é˜±**

```java
// é™·é˜±1ï¼šå†…éƒ¨æ–¹æ³•è°ƒç”¨äº‹åŠ¡å¤±æ•ˆ
@Service
public class UserService {
    
    public void outerMethod() {
        this.innerMethod();  // âŒ äº‹åŠ¡ä¸ç”Ÿæ•ˆï¼
    }
    
    @Transactional
    public void innerMethod() {
        // ...
    }
}

// è§£å†³æ–¹æ¡ˆï¼šé€šè¿‡ä»£ç†è°ƒç”¨
@Service
public class UserService {
    @Autowired
    private UserService self;  // æ³¨å…¥è‡ªå·±
    
    public void outerMethod() {
        self.innerMethod();  // âœ… äº‹åŠ¡ç”Ÿæ•ˆ
    }
}

// é™·é˜±2ï¼šå¼‚æ­¥æ–¹æ³•çš„äº‹åŠ¡
@Async
@Transactional  // âŒ äº‹åŠ¡å¯èƒ½ä¸ç”Ÿæ•ˆ
public void asyncMethod() {
    // ...
}

// è§£å†³æ–¹æ¡ˆï¼šåœ¨å¼‚æ­¥æ–¹æ³•å†…éƒ¨å¼€å¯äº‹åŠ¡
@Async
public void asyncMethod() {
    transactionTemplate.execute(status -> {
        // äº‹åŠ¡ä»£ç 
        return null;
    });
}
```

---

## 4. ğŸ› ï¸ è°ƒè¯•æŠ€å·§ä¸å·¥å…·


### 4.1 SQLæ—¥å¿—åˆ†æ


```yaml
# application.yml - å¼€å‘ç¯å¢ƒé…ç½®
spring:
  jpa:
    show-sql: true  # æ§åˆ¶å°æ˜¾ç¤ºSQL
    properties:
      hibernate:
        format_sql: true  # æ ¼å¼åŒ–SQL
        use_sql_comments: true  # æ˜¾ç¤ºSQLæ³¨é‡Š
        
# ä½¿ç”¨logbackæ˜¾ç¤ºå‚æ•°å€¼
logging:
  level:
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
```

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹ï¼š**

```
Hibernate: 
    /* SELECT u FROM User u WHERE u.email = :email */
    select
        user0_.id as id1_0_,
        user0_.email as email2_0_,
        user0_.name as name3_0_ 
    from
        users user0_ 
    where
        user0_.email=?
        
binding parameter [1] as [VARCHAR] - [user@example.com]
```

---

### 4.2 æ€§èƒ½ç›‘æ§å·¥å…·


```java
// æ–¹æ¡ˆ1ï¼šä½¿ç”¨P6Spyç›‘æ§
<!-- pom.xml -->
<dependency>
    <groupId>p6spy</groupId>
    <artifactId>p6spy</artifactId>
    <version>3.9.1</version>
</dependency>

# application.yml
spring:
  datasource:
    driver-class-name: com.p6spy.engine.spy.P6SpyDriver
    url: jdbc:p6spy:mysql://localhost:3306/db

# spy.properties
appender=com.p6spy.engine.spy.appender.Slf4JLogger
logMessageFormat=com.p6spy.engine.spy.appender.CustomLineFormat
customLogMessageFormat=%(executionTime)ms | %(category) | %(sql)

// è¾“å‡ºç¤ºä¾‹ï¼š
// 15ms | statement | SELECT * FROM users WHERE email = 'user@example.com'

// æ–¹æ¡ˆ2ï¼šä½¿ç”¨Spring Boot Actuator
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>

# application.yml
management:
  endpoints:
    web:
      exposure:
        include: metrics,health
  metrics:
    enable:
      jpa: true

// è®¿é—®: http://localhost:8080/actuator/metrics/jpa.sessions.open
```

---

### 4.3 å¸¸ç”¨è°ƒè¯•æŠ€å·§


**æŠ€å·§1ï¼šæŸ¥çœ‹å®é™…æ‰§è¡Œçš„SQL**

```java
@Autowired
private EntityManager em;

public void debugQuery() {
    Query query = em.createQuery("SELECT u FROM User u WHERE u.name = :name");
    query.setParameter("name", "å¼ ä¸‰");
    
    // è·å–Hibernate Queryå¯¹è±¡
    org.hibernate.query.Query hibernateQuery = query.unwrap(org.hibernate.query.Query.class);
    
    // æ‰“å°SQL
    System.out.println(hibernateQuery.getQueryString());
}
```

**æŠ€å·§2ï¼šæ£€æŸ¥æ‡’åŠ è½½çŠ¶æ€**

```java
User user = userRepository.findById(1L).get();

// æ£€æŸ¥å…³è”æ˜¯å¦å·²åŠ è½½
boolean isLoaded = Hibernate.isInitialized(user.getOrders());
System.out.println("Orders loaded: " + isLoaded);

// å¼ºåˆ¶åŠ è½½
Hibernate.initialize(user.getOrders());
```

**æŠ€å·§3ï¼šç›‘æ§æŸ¥è¯¢æ¬¡æ•°**

```java
// ä½¿ç”¨ç»Ÿè®¡åŠŸèƒ½
@Service
public class QueryCountService {
    
    @PersistenceContext
    private EntityManager em;
    
    public void executeWithStats(Runnable action) {
        Session session = em.unwrap(Session.class);
        Statistics stats = session.getSessionFactory().getStatistics();
        
        stats.clear();
        stats.setStatisticsEnabled(true);
        
        action.run();
        
        System.out.println("æŸ¥è¯¢æ¬¡æ•°: " + stats.getQueryExecutionCount());
        System.out.println("å®ä½“åŠ è½½æ¬¡æ•°: " + stats.getEntityLoadCount());
        System.out.println("äºŒçº§ç¼“å­˜å‘½ä¸­ç‡: " + stats.getSecondLevelCacheHitCount());
    }
}

// ä½¿ç”¨
queryCountService.executeWithStats(() -> {
    List<Order> orders = orderRepository.findAll();
    orders.forEach(order -> order.getUser().getName());
});
```

---

## 5. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 5.1 å¼‚å¸¸å¤„ç†é€ŸæŸ¥è¡¨


| å¼‚å¸¸ç±»å‹ | å¸¸è§åŸå›  | å¿«é€Ÿè§£å†³ |
|---------|---------|---------|
| **LazyInitializationException** | äº‹åŠ¡å¤–è®¿é—®æ‡’åŠ è½½ | ä½¿ç”¨JOIN FETCHæˆ–DTO |
| **MultipleBagFetchException** | åŒæ—¶åŠ è½½å¤šä¸ªé›†åˆ | æ”¹ç”¨Setæˆ–åˆ†æ‰¹æŸ¥è¯¢ |
| **NonUniqueResultException** | æŸ¥è¯¢è¿”å›å¤šæ¡ | æ”¹è¿”å›Listæˆ–åŠ æ¡ä»¶ |
| **OptimisticLockException** | ç‰ˆæœ¬å†²çª | æ•è·å¼‚å¸¸å¹¶é‡è¯• |
| **N+1æŸ¥è¯¢** | å¾ªç¯æŸ¥è¯¢å…³è” | ä½¿ç”¨JOIN FETCH |

### 5.2 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•


```
â–¡ æ˜¯å¦åˆç†ä½¿ç”¨æ‡’åŠ è½½ï¼Ÿ
â–¡ æ˜¯å¦é¿å…äº†N+1æŸ¥è¯¢ï¼Ÿ
â–¡ æ˜¯å¦åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Ÿ
â–¡ æ˜¯å¦å¯¹å¸¸ç”¨æŸ¥è¯¢å­—æ®µå»ºç«‹ç´¢å¼•ï¼Ÿ
â–¡ æ‰¹é‡æ“ä½œæ˜¯å¦ä½¿ç”¨æ‰¹å¤„ç†ï¼Ÿ
â–¡ æ˜¯å¦ä½¿ç”¨äº†æŸ¥è¯¢ç¼“å­˜ï¼Ÿ
â–¡ æ·±åˆ†é¡µæ˜¯å¦ä½¿ç”¨æ¸¸æ ‡æ–¹å¼ï¼Ÿ
â–¡ æ˜¯å¦åˆç†è®¾ç½®äº†äº‹åŠ¡è¾¹ç•Œï¼Ÿ
```

### 5.3 å…³é”®è®°å¿†è¦ç‚¹


> ğŸ”¸ **æ‡’åŠ è½½ä¸‰åŸåˆ™**ï¼š
> 1. é»˜è®¤æ‡’åŠ è½½
> 2. éœ€è¦æ—¶JOIN FETCH
> 3. ä¼˜å…ˆç”¨DTO

> ğŸ”¸ **æ€§èƒ½ä¼˜åŒ–ä¸‰æ¿æ–§**ï¼š
> 1. é¿å…N+1æŸ¥è¯¢
> 2. æ‰¹é‡æ“ä½œç”¨æ‰¹å¤„ç†  
> 3. åªæŸ¥è¯¢éœ€è¦çš„æ•°æ®

> ğŸ”¸ **å¼‚å¸¸å¤„ç†ä¸‰æ­¥èµ°**ï¼š
> 1. çœ‹å¼‚å¸¸ç±»å‹
> 2. æ‰¾æ ¹æœ¬åŸå› 
> 3. é€‰å¯¹è§£å†³æ–¹æ¡ˆ

> ğŸ’¡ **æ–°æ‰‹å»ºè®®**ï¼š
> - å¼€å‘æ—¶æ‰“å¼€SQLæ—¥å¿—
> - é‡åˆ°é—®é¢˜å…ˆæŸ¥çœ‹æ‰§è¡Œçš„SQL
> - æ€§èƒ½é—®é¢˜ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æœ‰N+1æŸ¥è¯¢
> - ä½¿ç”¨DTOé¿å…å¤§éƒ¨åˆ†åºåˆ—åŒ–é—®é¢˜