---
title: 60ã€æ‰¹å¤„ç†å†™å…¥ä¸å†…å­˜æ§åˆ¶
---
## ğŸ“š ç›®å½•

1. [æ‰¹é‡æ“ä½œåŸºç¡€æ¦‚å¿µ](#1-æ‰¹é‡æ“ä½œåŸºç¡€æ¦‚å¿µ)
2. [æ‰¹é‡æ’å…¥ä¼˜åŒ–](#2-æ‰¹é‡æ’å…¥ä¼˜åŒ–)
3. [æ‰¹é‡æ›´æ–°ä¼˜åŒ–](#3-æ‰¹é‡æ›´æ–°ä¼˜åŒ–)
4. [æ‰¹é‡åˆ é™¤ä¼˜åŒ–](#4-æ‰¹é‡åˆ é™¤ä¼˜åŒ–)
5. [å†…å­˜æ§åˆ¶ä¸æ€§èƒ½è°ƒä¼˜](#5-å†…å­˜æ§åˆ¶ä¸æ€§èƒ½è°ƒä¼˜)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ‰¹é‡æ“ä½œåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ‰¹é‡æ“ä½œ


**ç®€å•ç†è§£**ï¼šæ‰¹é‡æ“ä½œå°±æ˜¯ä¸€æ¬¡æ€§å¤„ç†å¾ˆå¤šæ¡æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¡ä¸€æ¡åœ°å¤„ç†ã€‚

```
âŒ ä¼ ç»Ÿæ–¹å¼ï¼ˆé€æ¡å¤„ç†ï¼‰ï¼š
ä¿å­˜ç¬¬1æ¡æ•°æ® â†’ å‘é€SQLåˆ°æ•°æ®åº“
ä¿å­˜ç¬¬2æ¡æ•°æ® â†’ å‘é€SQLåˆ°æ•°æ®åº“
ä¿å­˜ç¬¬3æ¡æ•°æ® â†’ å‘é€SQLåˆ°æ•°æ®åº“
...å…±1000æ¬¡æ•°æ®åº“äº¤äº’

âœ… æ‰¹é‡æ–¹å¼ï¼ˆæˆæ‰¹å¤„ç†ï¼‰ï¼š
æ”¶é›†50æ¡æ•°æ® â†’ ä¸€æ¬¡æ€§å‘é€åˆ°æ•°æ®åº“
æ”¶é›†50æ¡æ•°æ® â†’ ä¸€æ¬¡æ€§å‘é€åˆ°æ•°æ®åº“
...å…±20æ¬¡æ•°æ®åº“äº¤äº’

æ€§èƒ½æå‡ï¼šå‡å°‘äº†ç½‘ç»œå¾€è¿”æ¬¡æ•°ï¼Œå¤§å¹…æé«˜æ•ˆç‡
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡å¤„ç†


**æ ¸å¿ƒé—®é¢˜**ï¼šé€æ¡å¤„ç†å¤§é‡æ•°æ®æ—¶çš„æ€§èƒ½ç“¶é¢ˆ

```
åœºæ™¯ç¤ºä¾‹ï¼šå¯¼å…¥10000æ¡ç”¨æˆ·æ•°æ®

é€æ¡å¤„ç†çš„é—®é¢˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨ç¨‹åº   â”‚      â”‚  æ•°æ®åº“     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                     â”‚
      â”‚â”€â”€INSERT user1â”€â”€â”€â”€â”€â”€>â”‚
      â”‚<â”€â”€â”€â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚â”€â”€INSERT user2â”€â”€â”€â”€â”€â”€>â”‚  â† 10000æ¬¡ç½‘ç»œå¾€è¿”
      â”‚<â”€â”€â”€â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     è€—æ—¶ï¼šçº¦30-60ç§’
      â”‚â”€â”€INSERT user3â”€â”€â”€â”€â”€â”€>â”‚
      â”‚     ......          â”‚

æ‰¹é‡å¤„ç†çš„ä¼˜åŠ¿ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨ç¨‹åº   â”‚      â”‚  æ•°æ®åº“     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                     â”‚
      â”‚â”€â”€æ‰¹é‡INSERT 50æ¡â”€â”€â”€>â”‚
      â”‚<â”€â”€â”€â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â† 200æ¬¡ç½‘ç»œå¾€è¿”
      â”‚â”€â”€æ‰¹é‡INSERT 50æ¡â”€â”€â”€>â”‚     è€—æ—¶ï¼šçº¦2-5ç§’
      â”‚     ......          â”‚

æ€§èƒ½æå‡ï¼š10å€ä»¥ä¸Šï¼
```

### 1.3 æ‰¹å¤„ç†çš„æ ¸å¿ƒåŸç†


**å·¥ä½œæœºåˆ¶**ï¼šJDBCå±‚é¢çš„æ‰¹é‡å¤„ç†

```
æ™®é€šæ‰§è¡Œæµç¨‹ï¼š
åº”ç”¨ä»£ç  â†’ Hibernate â†’ JDBC â†’ æ•°æ®åº“
æ¯æ¬¡éƒ½æ˜¯ï¼šå‡†å¤‡SQL â†’ æ‰§è¡Œ â†’ æäº¤

æ‰¹å¤„ç†æ‰§è¡Œæµç¨‹ï¼š
åº”ç”¨ä»£ç  â†’ Hibernate â†’ JDBCæ‰¹å¤„ç†ç¼“å†²åŒº â†’ æ•°æ®åº“
æµç¨‹å˜ä¸ºï¼š
1. å‡†å¤‡SQL â†’ åŠ å…¥æ‰¹å¤„ç†
2. å‡†å¤‡SQL â†’ åŠ å…¥æ‰¹å¤„ç†
3. ...æ”¶é›†åˆ°ä¸€å®šæ•°é‡
4. ä¸€æ¬¡æ€§æ‰¹é‡æ‰§è¡Œ â†’ æäº¤

å…³é”®ä¼˜åŠ¿ï¼š
â€¢ å‡å°‘ç½‘ç»œå¾€è¿”ï¼ˆNetwork Round-Tripï¼‰
â€¢ æ•°æ®åº“å¯ä»¥ä¼˜åŒ–æ‰¹é‡æ‰§è¡Œ
â€¢ å‡å°‘äº‹åŠ¡å¼€é”€
```

---

## 2. ğŸ“ æ‰¹é‡æ’å…¥ä¼˜åŒ–


### 2.1 æ‰¹é‡æ’å…¥é…ç½®


**ç¬¬ä¸€æ­¥ï¼šé…ç½®æ‰¹å¤„ç†å¤§å°**

```properties
# application.properties
# è®¾ç½®æ¯æ‰¹å¤„ç†çš„æ•°é‡ï¼ˆæ¨è20-50ï¼‰
spring.jpa.properties.hibernate.jdbc.batch_size=50

# å¼€å¯æ‰¹å¤„ç†æ’åºï¼ˆé‡è¦ï¼æå‡æ‰¹å¤„ç†æ•ˆç‡ï¼‰
spring.jpa.properties.hibernate.order_inserts=true

# å¼€å¯æ‰¹å¤„ç†è¯­å¥åˆå¹¶ï¼ˆåŒç±»å‹SQLä¸€èµ·æ‰§è¡Œï¼‰
spring.jpa.properties.hibernate.order_updates=true
```

**é…ç½®è¯´æ˜**ï¼š
- `batch_size=50`ï¼šè¡¨ç¤ºæ¯æ”¶é›†50æ¡SQLè¯­å¥ï¼Œå°±æ‰“åŒ…å‘é€ä¸€æ¬¡
- `order_inserts=true`ï¼šæŠŠç›¸åŒè¡¨çš„INSERTè¯­å¥æ’åºç»„åˆï¼Œæé«˜æ‰¹å¤„ç†æ•ˆç‡
- æ•°å­—ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œ50é€šå¸¸æ˜¯ä¸ªä¸é”™çš„å¹³è¡¡ç‚¹

### 2.2 æ‰¹é‡æ’å…¥ä»£ç å®ç°


**æ ‡å‡†æ‰¹é‡æ’å…¥æ¨¡å¼**ï¼š

```java
@Service
public class UserBatchService {
    
    @Autowired
    private EntityManager entityManager;
    
    /**
     * æ‰¹é‡æ’å…¥ç”¨æˆ·æ•°æ®
     * æ ¸å¿ƒæ€è·¯ï¼šæ¯å¤„ç†ä¸€å®šæ•°é‡å°±flush+clearï¼Œé¿å…å†…å­˜æº¢å‡º
     */
    @Transactional
    public void batchInsertUsers(List<User> users) {
        int batchSize = 50; // ä¸é…ç½®çš„batch_sizeä¿æŒä¸€è‡´
        
        for (int i = 0; i < users.size(); i++) {
            // 1. æŒä¹…åŒ–å®ä½“
            entityManager.persist(users.get(i));
            
            // 2. æ¯å¤„ç†50æ¡å°±æ‰§è¡Œä¸€æ¬¡flushå’Œclear
            if (i > 0 && i % batchSize == 0) {
                entityManager.flush();  // ç«‹å³æ‰§è¡ŒSQL
                entityManager.clear();  // æ¸…ç©ºä¸€çº§ç¼“å­˜
            }
        }
        
        // 3. å¤„ç†å‰©ä½™æ•°æ®
        entityManager.flush();
        entityManager.clear();
    }
}
```

**ä»£ç è§£é‡Š**ï¼š
- `persist()`ï¼šå°†å¯¹è±¡æ ‡è®°ä¸ºå¾…ä¿å­˜çŠ¶æ€
- `flush()`ï¼šå¼ºåˆ¶Hibernateæ‰§è¡ŒSQLï¼ŒæŠŠæ•°æ®çœŸæ­£å†™å…¥æ•°æ®åº“
- `clear()`ï¼šæ¸…ç©ºç¼“å­˜ï¼Œé‡Šæ”¾å†…å­˜ï¼ˆéå¸¸é‡è¦ï¼ï¼‰
- å¾ªç¯æ¨¡å¼ï¼šæ¯50æ¡å°±`flush + clear`ï¼Œé˜²æ­¢å†…å­˜å †ç§¯

### 2.3 æ‰¹é‡æ’å…¥çš„å®Œæ•´ç¤ºä¾‹


**å®é™…ä¸šåŠ¡åœºæ™¯**ï¼šå¯¼å…¥Excelç”¨æˆ·æ•°æ®

```java
@Service
public class UserImportService {
    
    @Autowired
    private EntityManager em;
    
    @Transactional
    public int importUsers(List<UserDTO> userDTOs) {
        int batchSize = 50;
        int count = 0;
        
        for (int i = 0; i < userDTOs.size(); i++) {
            // â‘  è½¬æ¢DTOä¸ºå®ä½“
            User user = convertToEntity(userDTOs.get(i));
            
            // â‘¡ æŒä¹…åŒ–
            em.persist(user);
            count++;
            
            // â‘¢ æ‰¹é‡æäº¤ï¼ˆå…³é”®æ­¥éª¤ï¼‰
            if (i > 0 && i % batchSize == 0) {
                em.flush();  // æ‰§è¡Œæ‰¹é‡INSERT
                em.clear();  // é‡Šæ”¾å†…å­˜
                
                System.out.println("å·²å¤„ç†: " + count + " æ¡");
            }
        }
        
        // â‘£ æœ€åä¸€æ‰¹æ•°æ®
        em.flush();
        em.clear();
        
        return count;
    }
    
    private User convertToEntity(UserDTO dto) {
        User user = new User();
        user.setUsername(dto.getUsername());
        user.setEmail(dto.getEmail());
        return user;
    }
}
```

**æ‰§è¡Œè¿‡ç¨‹ç¤ºæ„**ï¼š
```
å¤„ç†1-50æ¡ â†’ persiståˆ°ç¼“å­˜
ç¬¬50æ¡æ—¶ â†’ flush(æ‰§è¡Œæ‰¹é‡INSERT) â†’ clear(æ¸…ç©ºç¼“å­˜)

å¤„ç†51-100æ¡ â†’ persiståˆ°ç¼“å­˜
ç¬¬100æ¡æ—¶ â†’ flush(æ‰§è¡Œæ‰¹é‡INSERT) â†’ clear(æ¸…ç©ºç¼“å­˜)

...å¾ªç¯å¾€å¤

æœ€å1-10æ¡ â†’ persiståˆ°ç¼“å­˜
ç»“æŸæ—¶ â†’ flush(æ‰§è¡Œæœ€åçš„INSERT) â†’ clear(æ¸…ç©ºç¼“å­˜)
```

---

## 3. ğŸ”„ æ‰¹é‡æ›´æ–°ä¼˜åŒ–


### 3.1 æ‰¹é‡æ›´æ–°é…ç½®


**é…ç½®è¦ç‚¹**ï¼š

```properties
# æ‰¹å¤„ç†å¤§å°ï¼ˆåŒæ’å…¥é…ç½®ï¼‰
spring.jpa.properties.hibernate.jdbc.batch_size=50

# å¼€å¯æ‰¹é‡æ›´æ–°æ’åºï¼ˆé‡è¦ï¼‰
spring.jpa.properties.hibernate.order_updates=true

# æ‰¹é‡æ›´æ–°ç‰ˆæœ¬å­—æ®µï¼ˆå¦‚æœæœ‰ä¹è§‚é”ï¼‰
spring.jpa.properties.hibernate.batch_versioned_data=true
```

### 3.2 æ‰¹é‡æ›´æ–°å®ç°æ–¹å¼


**æ–¹å¼ä¸€ï¼šEntityManageræ›´æ–°**

```java
@Service
public class UserBatchUpdateService {
    
    @Autowired
    private EntityManager em;
    
    /**
     * æ‰¹é‡æ›´æ–°ç”¨æˆ·çŠ¶æ€
     */
    @Transactional
    public void batchUpdateStatus(List<Long> userIds, String status) {
        int batchSize = 50;
        
        for (int i = 0; i < userIds.size(); i++) {
            // â‘  æŸ¥è¯¢å®ä½“ï¼ˆä¼šæ”¾å…¥ç¼“å­˜ï¼‰
            User user = em.find(User.class, userIds.get(i));
            
            // â‘¡ ä¿®æ”¹å±æ€§ï¼ˆHibernateä¼šè¿½è¸ªå˜åŒ–ï¼‰
            if (user != null) {
                user.setStatus(status);
            }
            
            // â‘¢ æ‰¹é‡flush+clear
            if (i > 0 && i % batchSize == 0) {
                em.flush();  // æ‰§è¡ŒUPDATEè¯­å¥
                em.clear();  // æ¸…ç©ºç¼“å­˜
            }
        }
        
        em.flush();
        em.clear();
    }
}
```

**æ–¹å¼äºŒï¼šJPQLæ‰¹é‡æ›´æ–°ï¼ˆæ¨èï¼‰**

```java
@Service
public class UserBatchUpdateService {
    
    @Autowired
    private EntityManager em;
    
    /**
     * ä½¿ç”¨JPQLæ‰¹é‡æ›´æ–°ï¼ˆä¸èµ°ç¼“å­˜ï¼Œç›´æ¥æ‰§è¡ŒSQLï¼‰
     * é€‚åˆå¤§æ‰¹é‡æ›´æ–°åŒä¸€å­—æ®µ
     */
    @Transactional
    public int batchUpdateStatusByJPQL(List<Long> userIds, String status) {
        // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…SQLè¿‡é•¿
        int batchSize = 1000;  // JPQLæ‰¹é‡å¯ä»¥è®¾ç½®å¤§ä¸€äº›
        int totalUpdated = 0;
        
        for (int i = 0; i < userIds.size(); i += batchSize) {
            int end = Math.min(i + batchSize, userIds.size());
            List<Long> batch = userIds.subList(i, end);
            
            // æ‰§è¡Œæ‰¹é‡æ›´æ–°SQL
            int updated = em.createQuery(
                "UPDATE User u SET u.status = :status WHERE u.id IN :ids")
                .setParameter("status", status)
                .setParameter("ids", batch)
                .executeUpdate();
            
            totalUpdated += updated;
        }
        
        return totalUpdated;
    }
}
```

**ä¸¤ç§æ–¹å¼å¯¹æ¯”**ï¼š

| å¯¹æ¯”é¡¹ | EntityManageræ–¹å¼ | JPQLæ‰¹é‡æ›´æ–° |
|--------|------------------|--------------|
| **æ‰§è¡Œé€Ÿåº¦** | è¾ƒæ…¢ï¼ˆéœ€è¦æŸ¥è¯¢+æ›´æ–°ï¼‰ | å¿«ï¼ˆç›´æ¥UPDATEï¼‰ |
| **å†…å­˜å ç”¨** | é«˜ï¼ˆå®ä½“åŠ è½½åˆ°ç¼“å­˜ï¼‰ | ä½ï¼ˆä¸åŠ è½½å®ä½“ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | æ›´æ–°é€»è¾‘å¤æ‚ | ç®€å•å­—æ®µæ›´æ–° |
| **ç¼“å­˜åŒæ­¥** | è‡ªåŠ¨åŒæ­¥ | âš ï¸ éœ€æ‰‹åŠ¨å¤„ç† |
| **æ¨èåº¦** | ğŸŸ¡ ä¸­ | ğŸŸ¢ é«˜ |

### 3.3 æ‰¹é‡æ›´æ–°æ³¨æ„äº‹é¡¹


**ç¼“å­˜åŒæ­¥é—®é¢˜**ï¼š

```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šJPQLæ›´æ–°åç¼“å­˜ä¸åŒæ­¥
@Transactional
public void updateUserStatus(Long userId, String newStatus) {
    // 1. å…ˆæŸ¥è¯¢ç”¨æˆ·ï¼ˆåŠ è½½åˆ°ç¼“å­˜ï¼‰
    User user = em.find(User.class, userId);
    System.out.println("çŠ¶æ€: " + user.getStatus()); // è¾“å‡ºï¼šACTIVE
    
    // 2. JPQLæ‰¹é‡æ›´æ–°ï¼ˆç»•è¿‡ç¼“å­˜ï¼‰
    em.createQuery("UPDATE User u SET u.status = :status WHERE u.id = :id")
      .setParameter("status", newStatus)
      .setParameter("id", userId)
      .executeUpdate();
    
    // 3. å†æ¬¡è¯»å–ï¼ˆè¯»åˆ°ç¼“å­˜çš„æ—§æ•°æ®ï¼‰
    User user2 = em.find(User.class, userId);
    System.out.println("çŠ¶æ€: " + user2.getStatus()); // è¿˜æ˜¯ï¼šACTIVE âŒ
}

// âœ… æ­£ç¡®åšæ³•ï¼šæ›´æ–°åæ¸…ç©ºç¼“å­˜
@Transactional
public void updateUserStatusCorrect(Long userId, String newStatus) {
    em.createQuery("UPDATE User u SET u.status = :status WHERE u.id = :id")
      .setParameter("status", newStatus)
      .setParameter("id", userId)
      .executeUpdate();
    
    // æ¸…ç©ºç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°æŸ¥è¯¢
    em.clear();
    
    User user = em.find(User.class, userId);
    System.out.println("çŠ¶æ€: " + user.getStatus()); // è¾“å‡ºï¼šæ–°çŠ¶æ€ âœ…
}
```

---

## 4. ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤ä¼˜åŒ–


### 4.1 æ‰¹é‡åˆ é™¤çš„å®ç°æ–¹å¼


**æ–¹å¼ä¸€ï¼šé€ä¸ªåˆ é™¤ï¼ˆä¸æ¨èï¼‰**

```java
// âŒ æ€§èƒ½å·®ï¼šæ¯æ¡éƒ½è¦æŸ¥è¯¢+åˆ é™¤
@Transactional
public void deleteUsersSlow(List<Long> userIds) {
    for (Long id : userIds) {
        User user = em.find(User.class, id); // æŸ¥è¯¢
        if (user != null) {
            em.remove(user); // åˆ é™¤
        }
    }
}
```

**æ–¹å¼äºŒï¼šJPQLæ‰¹é‡åˆ é™¤ï¼ˆæ¨èï¼‰**

```java
@Service
public class UserBatchDeleteService {
    
    @Autowired
    private EntityManager em;
    
    /**
     * JPQLæ‰¹é‡åˆ é™¤ï¼ˆé«˜æ•ˆï¼‰
     */
    @Transactional
    public int batchDeleteUsers(List<Long> userIds) {
        if (userIds.isEmpty()) {
            return 0;
        }
        
        // åˆ†æ‰¹åˆ é™¤ï¼ˆé˜²æ­¢SQLå¤ªé•¿ï¼‰
        int batchSize = 1000;
        int totalDeleted = 0;
        
        for (int i = 0; i < userIds.size(); i += batchSize) {
            int end = Math.min(i + batchSize, userIds.size());
            List<Long> batch = userIds.subList(i, end);
            
            // æ‰§è¡Œæ‰¹é‡åˆ é™¤
            int deleted = em.createQuery(
                "DELETE FROM User u WHERE u.id IN :ids")
                .setParameter("ids", batch)
                .executeUpdate();
            
            totalDeleted += deleted;
        }
        
        // æ¸…ç©ºç¼“å­˜ï¼ˆé‡è¦ï¼ï¼‰
        em.clear();
        
        return totalDeleted;
    }
}
```

### 4.2 çº§è”åˆ é™¤çš„æ‰¹é‡å¤„ç†


**åœºæ™¯**ï¼šåˆ é™¤ç”¨æˆ·åŠå…¶å…³è”çš„è®¢å•

```java
@Service
public class UserCascadeDeleteService {
    
    @Autowired
    private EntityManager em;
    
    /**
     * æ‰¹é‡åˆ é™¤ç”¨æˆ·åŠå…³è”æ•°æ®
     * æ³¨æ„ï¼šéœ€è¦å…ˆåˆ é™¤å­è¡¨ï¼Œå†åˆ é™¤ä¸»è¡¨
     */
    @Transactional
    public void batchDeleteUsersWithOrders(List<Long> userIds) {
        int batchSize = 1000;
        
        for (int i = 0; i < userIds.size(); i += batchSize) {
            List<Long> batch = userIds.subList(
                i, Math.min(i + batchSize, userIds.size())
            );
            
            // â‘  å…ˆåˆ é™¤è®¢å•ï¼ˆå­è¡¨ï¼‰
            em.createQuery("DELETE FROM Order o WHERE o.user.id IN :ids")
              .setParameter("ids", batch)
              .executeUpdate();
            
            // â‘¡ å†åˆ é™¤ç”¨æˆ·ï¼ˆä¸»è¡¨ï¼‰
            em.createQuery("DELETE FROM User u WHERE u.id IN :ids")
              .setParameter("ids", batch)
              .executeUpdate();
        }
        
        // æ¸…ç©ºç¼“å­˜
        em.clear();
    }
}
```

**åˆ é™¤é¡ºåº**ï¼š
```
æ•°æ®åº“å¤–é”®çº¦æŸï¼š
User (ä¸»è¡¨) â† Order (ä»è¡¨ï¼Œå¤–é”®ï¼šuser_id)

åˆ é™¤é¡ºåºå¿…é¡»ï¼š
1. DELETE FROM orders WHERE user_id IN (...)  â† å…ˆåˆ å­è¡¨
2. DELETE FROM users WHERE id IN (...)        â† ååˆ ä¸»è¡¨

å¦‚æœé¡ºåºåäº† â†’ å¤–é”®çº¦æŸå†²çª â†’ åˆ é™¤å¤±è´¥ âŒ
```

---

## 5. ğŸ§  å†…å­˜æ§åˆ¶ä¸æ€§èƒ½è°ƒä¼˜


### 5.1 å†…å­˜æ³„æ¼é˜²æŠ¤


**æ ¸å¿ƒé—®é¢˜**ï¼šæ‰¹é‡æ“ä½œæ—¶å®ä½“å †ç§¯å¯¼è‡´å†…å­˜æº¢å‡º

```
é—®é¢˜åœºæ™¯ï¼š
æ’å…¥10ä¸‡æ¡æ•°æ®ï¼Œä¸æ¸…ç†ç¼“å­˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hibernateä¸€çº§ç¼“å­˜          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚user1â”‚â”‚user2â”‚â”‚user3â”‚ ... â”‚  â† 10ä¸‡ä¸ªå¯¹è±¡
â”‚  â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜     â”‚     å…¨éƒ¨é©»ç•™å†…å­˜
â”‚  å†…å­˜å ç”¨ï¼šçº¦500MB-1GB      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
         OutOfMemoryError âŒ

è§£å†³æ–¹æ¡ˆï¼šå®šæœŸflush + clear

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hibernateä¸€çº§ç¼“å­˜          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚user1â”‚â”‚user2â”‚â”‚ ... â”‚     â”‚  â† åªä¿ç•™50ä¸ªå¯¹è±¡
â”‚  â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  å¤„ç†50ä¸ª â†’ flush â†’ clear   â”‚  â† ç«‹å³æ¸…ç©º
â”‚  å†…å­˜å ç”¨ï¼šçº¦2-5MBï¼ˆç¨³å®šï¼‰  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 flush/clearå¾ªç¯æ¨¡å¼


**æ ‡å‡†æ¨¡å¼**ï¼š

```java
@Transactional
public void safeBatchProcess(List<Entity> entities) {
    int batchSize = 50;
    
    for (int i = 0; i < entities.size(); i++) {
        // ä¸šåŠ¡å¤„ç†
        em.persist(entities.get(i));
        
        // å®šæœŸæ¸…ç†ï¼ˆæ ¸å¿ƒï¼‰
        if (i > 0 && i % batchSize == 0) {
            em.flush();   // â‘  æ‰§è¡ŒSQL
            em.clear();   // â‘¡ æ¸…ç©ºç¼“å­˜
        }
    }
    
    // æœ€åä¸€æ‰¹
    em.flush();
    em.clear();
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·åš**ï¼š

| æ­¥éª¤ | ä½œç”¨ | ä¸åšä¼šæ€æ · |
|------|------|-----------|
| `flush()` | å¼ºåˆ¶æ‰§è¡ŒSQLï¼Œå†™å…¥æ•°æ®åº“ | æ•°æ®ç§¯å‹åœ¨å†…å­˜ï¼Œä¸ä¼šçœŸæ­£ä¿å­˜ |
| `clear()` | æ¸…ç©ºä¸€çº§ç¼“å­˜ï¼Œé‡Šæ”¾å¯¹è±¡ | å¯¹è±¡è¶Šç§¯è¶Šå¤šï¼Œæœ€ç»ˆå†…å­˜æº¢å‡º |
| **ç»„åˆä½¿ç”¨** | è¾¹å¤„ç†è¾¹ä¿å­˜è¾¹é‡Šæ”¾ | é«˜æ•ˆä¸”å®‰å…¨ âœ… |

### 5.3 åˆ†æ®µæäº¤ç­–ç•¥


**å¤§äº‹åŠ¡æ‹†åˆ†**ï¼š

```java
@Service
public class LargeDataImportService {
    
    @Autowired
    private EntityManager em;
    
    @Autowired
    private TransactionTemplate transactionTemplate;
    
    /**
     * è¶…å¤§æ•°æ®é‡å¯¼å…¥ï¼ˆ10ä¸‡+ï¼‰
     * ç­–ç•¥ï¼šåˆ†æ®µæäº¤ï¼Œé™ä½äº‹åŠ¡é£é™©
     */
    public void importLargeData(List<User> users) {
        int batchSize = 50;      // æ‰¹å¤„ç†å¤§å°
        int commitSize = 1000;   // æäº¤é—´éš”
        
        for (int i = 0; i < users.size(); i += commitSize) {
            int end = Math.min(i + commitSize, users.size());
            List<User> segment = users.subList(i, end);
            
            // æ¯1000æ¡å¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡
            transactionTemplate.execute(status -> {
                processSegment(segment, batchSize);
                return null;
            });
            
            System.out.println("å·²æäº¤: " + end + " æ¡");
        }
    }
    
    private void processSegment(List<User> segment, int batchSize) {
        for (int i = 0; i < segment.size(); i++) {
            em.persist(segment.get(i));
            
            if (i > 0 && i % batchSize == 0) {
                em.flush();
                em.clear();
            }
        }
        em.flush();
        em.clear();
    }
}
```

**åˆ†æ®µæäº¤çš„ä¼˜åŠ¿**ï¼š

```
å•ä¸€å¤§äº‹åŠ¡ï¼ˆ10ä¸‡æ¡ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  äº‹åŠ¡1ï¼šå¤„ç†10ä¸‡æ¡              â”‚
â”‚  é£é™©ï¼š                         â”‚
â”‚  â€¢ æ‰§è¡Œæ—¶é—´é•¿ï¼ˆ5-10åˆ†é’Ÿï¼‰       â”‚
â”‚  â€¢ é”è¡¨æ—¶é—´é•¿                   â”‚
â”‚  â€¢ å¤±è´¥å…¨éƒ¨å›æ»š                 â”‚
â”‚  â€¢ å†…å­˜å‹åŠ›å¤§                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†æ®µå°äº‹åŠ¡ï¼ˆæ¯æ¬¡1000æ¡ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚äº‹åŠ¡1 â”‚â”‚äº‹åŠ¡2 â”‚â”‚äº‹åŠ¡3 â”‚â”‚ ... â”‚â”‚
â”‚1000æ¡â”‚â”‚1000æ¡â”‚â”‚1000æ¡â”‚â”‚     â”‚â”‚
â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜
ä¼˜åŠ¿ï¼š
â€¢ å•ä¸ªäº‹åŠ¡å¿«ï¼ˆ5-10ç§’ï¼‰
â€¢ é”è¡¨æ—¶é—´çŸ­
â€¢ éƒ¨åˆ†å¤±è´¥ä¸å½±å“å…¨å±€
â€¢ å†…å­˜å ç”¨ç¨³å®š
```

### 5.4 æ‰¹å¤„ç†æ€§èƒ½ç›‘æ§


**ç›‘æ§å…³é”®æŒ‡æ ‡**ï¼š

```java
@Service
public class MonitoredBatchService {
    
    @Autowired
    private EntityManager em;
    
    @Transactional
    public void monitoredBatchInsert(List<User> users) {
        int batchSize = 50;
        long startTime = System.currentTimeMillis();
        int processedCount = 0;
        
        for (int i = 0; i < users.size(); i++) {
            em.persist(users.get(i));
            processedCount++;
            
            if (i > 0 && i % batchSize == 0) {
                em.flush();
                em.clear();
                
                // æ€§èƒ½ç»Ÿè®¡
                long elapsed = System.currentTimeMillis() - startTime;
                double rate = processedCount / (elapsed / 1000.0);
                
                System.out.printf(
                    "è¿›åº¦: %d/%d, é€Ÿç‡: %.0fæ¡/ç§’, å†…å­˜: %dMB%n",
                    processedCount, users.size(), rate,
                    getUsedMemoryMB()
                );
            }
        }
        
        em.flush();
        em.clear();
        
        // æœ€ç»ˆç»Ÿè®¡
        long totalTime = System.currentTimeMillis() - startTime;
        System.out.printf("å®Œæˆ! æ€»è€—æ—¶: %dç§’%n", totalTime / 1000);
    }
    
    private long getUsedMemoryMB() {
        Runtime runtime = Runtime.getRuntime();
        return (runtime.totalMemory() - runtime.freeMemory()) / 1024 / 1024;
    }
}
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
è¿›åº¦: 50/10000, é€Ÿç‡: 250æ¡/ç§’, å†…å­˜: 45MB
è¿›åº¦: 100/10000, é€Ÿç‡: 238æ¡/ç§’, å†…å­˜: 47MB
è¿›åº¦: 150/10000, é€Ÿç‡: 245æ¡/ç§’, å†…å­˜: 46MB
...
å®Œæˆ! æ€»è€—æ—¶: 42ç§’
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ‰¹é‡å¤„ç†æœ¬è´¨ï¼šå‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•°ï¼Œæˆæ‰¹æ‰§è¡ŒSQL
ğŸ”¸ é…ç½®å…³é”®ï¼šbatch_size=50ï¼Œorder_inserts=true
ğŸ”¸ å†…å­˜æ§åˆ¶ï¼šå®šæœŸflush+clearï¼Œé˜²æ­¢ç¼“å­˜å †ç§¯
ğŸ”¸ åˆ†æ®µæäº¤ï¼šå¤§æ•°æ®é‡æ‹†åˆ†å¤šä¸ªå°äº‹åŠ¡æ‰§è¡Œ
ğŸ”¸ æ€§èƒ½å¯¹æ¯”ï¼šæ‰¹é‡æ¯”é€æ¡å¿«10-50å€
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ flushå’Œclearçš„ä½œç”¨**
```
flush()ï¼š
â€¢ ä½œç”¨ï¼šå¼ºåˆ¶æ‰§è¡ŒSQLï¼Œæ•°æ®å†™å…¥æ•°æ®åº“
â€¢ æ—¶æœºï¼šç¼“å­˜è¾¾åˆ°batch_sizeæˆ–æ‰‹åŠ¨è°ƒç”¨
â€¢ ä¸ä¼šæ¸…ç©ºç¼“å­˜

clear()ï¼š
â€¢ ä½œç”¨ï¼šæ¸…ç©ºä¸€çº§ç¼“å­˜ï¼Œé‡Šæ”¾å¯¹è±¡å†…å­˜
â€¢ å¿…è¦æ€§ï¼šé˜²æ­¢å†…å­˜æº¢å‡º
â€¢ å‰¯ä½œç”¨ï¼šåç»­è®¿é—®éœ€é‡æ–°æŸ¥è¯¢

ç»„åˆä½¿ç”¨ï¼š
flush() â†’ ä¿å­˜æ•°æ®åˆ°DB
clear() â†’ é‡Šæ”¾å†…å­˜
ä¸¤è€…ç¼ºä¸€ä¸å¯ï¼
```

**ğŸ”¹ æ‰¹å¤„ç†å¤§å°çš„é€‰æ‹©**
```
batch_sizeè®¾ç½®å»ºè®®ï¼š

å¤ªå°ï¼ˆ<20ï¼‰ï¼š
âŒ æ‰¹å¤„ç†æ•ˆæœä¸æ˜æ˜¾
âŒ ä»æœ‰è¾ƒå¤šç½‘ç»œå¾€è¿”

åˆé€‚ï¼ˆ20-50ï¼‰ï¼š
âœ… æ€§èƒ½æå‡æ˜æ˜¾
âœ… å†…å­˜å ç”¨å¯æ§
âœ… æ¨èé…ç½®

å¤ªå¤§ï¼ˆ>100ï¼‰ï¼š
âŒ å†…å­˜å‹åŠ›å¢å¤§
âŒ å•æ‰¹å¤±è´¥å½±å“é¢å¤§
âŒ æ•°æ®åº“å¤„ç†å‹åŠ›å¤§
```

**ğŸ”¹ ä¸åŒæ“ä½œçš„æœ€ä½³å®è·µ**

| æ“ä½œç±»å‹ | æ¨èæ–¹å¼ | æ‰¹å¤„ç†å¤§å° | æ³¨æ„äº‹é¡¹ |
|---------|---------|-----------|---------|
| **æ’å…¥** | EntityManager | 50 | å®šæœŸflush+clear |
| **æ›´æ–°** | JPQLæ‰¹é‡æ›´æ–° | 1000 | æ³¨æ„ç¼“å­˜åŒæ­¥ |
| **åˆ é™¤** | JPQLæ‰¹é‡åˆ é™¤ | 1000 | å…ˆåˆ å­è¡¨ååˆ ä¸»è¡¨ |
| **å¤§æ•°æ®é‡** | åˆ†æ®µæäº¤ | æ¯æ®µ1000 | é™ä½äº‹åŠ¡é£é™© |

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… æ‰¹é‡æ’å…¥æ ‡å‡†æ¨¡æ¿**
```java
@Transactional
public void batchInsert(List<Entity> entities) {
    int batchSize = 50;
    for (int i = 0; i < entities.size(); i++) {
        em.persist(entities.get(i));
        if (i > 0 && i % batchSize == 0) {
            em.flush();
            em.clear();
        }
    }
    em.flush();
    em.clear();
}
```

**âœ… æ‰¹é‡æ›´æ–°æ ‡å‡†æ¨¡æ¿**
```java
@Transactional
public int batchUpdate(List<Long> ids, String field, Object value) {
    int batchSize = 1000;
    int total = 0;
    for (int i = 0; i < ids.size(); i += batchSize) {
        List<Long> batch = ids.subList(
            i, Math.min(i + batchSize, ids.size())
        );
        total += em.createQuery(
            "UPDATE Entity e SET e." + field + " = :val WHERE e.id IN :ids")
            .setParameter("val", value)
            .setParameter("ids", batch)
            .executeUpdate();
    }
    em.clear();
    return total;
}
```

**âœ… å¤§æ•°æ®é‡å¯¼å…¥æ¨¡æ¿**
```java
public void importLargeData(List<Entity> entities) {
    int batchSize = 50;
    int commitSize = 1000;
    
    for (int i = 0; i < entities.size(); i += commitSize) {
        List<Entity> segment = entities.subList(
            i, Math.min(i + commitSize, entities.size())
        );
        
        transactionTemplate.execute(status -> {
            for (int j = 0; j < segment.size(); j++) {
                em.persist(segment.get(j));
                if (j > 0 && j % batchSize == 0) {
                    em.flush();
                    em.clear();
                }
            }
            em.flush();
            em.clear();
            return null;
        });
    }
}
```

### 6.4 å¸¸è§é—®é¢˜ä¸è§£å†³


**é—®é¢˜1ï¼šæ‰¹å¤„ç†ä¸ç”Ÿæ•ˆ**
```
ç°è±¡ï¼šé…ç½®äº†batch_sizeï¼Œä½†SQLè¿˜æ˜¯ä¸€æ¡æ¡æ‰§è¡Œ

åŸå› ï¼š
âŒ ä½¿ç”¨äº†IDENTITYä¸»é”®ç­–ç•¥
âŒ æ²¡æœ‰é…ç½®order_inserts

è§£å†³ï¼š
âœ… æ”¹ç”¨SEQUENCEæˆ–TABLEä¸»é”®ç­–ç•¥
âœ… æ·»åŠ é…ç½®ï¼š
   hibernate.order_inserts=true
   hibernate.order_updates=true
```

**é—®é¢˜2ï¼šå†…å­˜æº¢å‡º**
```
ç°è±¡ï¼šOutOfMemoryError: Java heap space

åŸå› ï¼š
âŒ å¿˜è®°è°ƒç”¨clear()æ¸…ç©ºç¼“å­˜
âŒ batch_sizeå¤ªå¤§

è§£å†³ï¼š
âœ… å®šæœŸflush+clear
âœ… å‡å°batch_sizeåˆ°20-50
âœ… å¢åŠ JVMå†…å­˜ï¼š-Xmx2g
```

**é—®é¢˜3ï¼šæ€§èƒ½æå‡ä¸æ˜æ˜¾**
```
ç°è±¡ï¼šæ‰¹é‡æ“ä½œé€Ÿåº¦è¿˜æ˜¯å¾ˆæ…¢

æ£€æŸ¥ç‚¹ï¼š
1ï¸âƒ£ æ˜¯å¦æœ‰å¤šä½™çš„æŸ¥è¯¢ï¼Ÿ
2ï¸âƒ£ æ˜¯å¦è§¦å‘äº†çº§è”æ“ä½œï¼Ÿ
3ï¸âƒ£ æ•°æ®åº“æ˜¯å¦æœ‰ç´¢å¼•ï¼Ÿ
4ï¸âƒ£ ç½‘ç»œå»¶è¿Ÿæ˜¯å¦å¾ˆé«˜ï¼Ÿ

ä¼˜åŒ–æ–¹å‘ï¼š
â€¢ å…³é—­ä¸å¿…è¦çš„çº§è”
â€¢ ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•
â€¢ è°ƒæ•´batch_sizeå¤§å°
â€¢ ä½¿ç”¨JPQLä»£æ›¿EntityManager
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æ‰¹é‡æ“ä½œè¦é«˜æ•ˆï¼Œé…ç½®ä¼˜åŒ–æ˜¯å…³é”®
flushæ¸…SQLå…¥åº“å¿«ï¼Œclearé‡Šæ”¾å†…å­˜å®‰
åˆ†æ®µæäº¤é™é£é™©ï¼Œç›‘æ§æŒ‡æ ‡ä¿å¹³å®‰
JPQLæ›´æ–°æœ€è¿…é€Ÿï¼Œç¼“å­˜åŒæ­¥åˆ«å¿˜å®Œ
```