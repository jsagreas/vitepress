---
title: 30ã€å®ä½“ç›‘å¬å™¨ä¸å®¡è®¡
---
## ğŸ“š ç›®å½•

1. [å®ä½“ç›‘å¬å™¨åŸºç¡€æ¦‚å¿µ](#1-å®ä½“ç›‘å¬å™¨åŸºç¡€æ¦‚å¿µ)
2. [ä¸ƒå¤§ç”Ÿå‘½å‘¨æœŸå›è°ƒæ³¨è§£](#2-ä¸ƒå¤§ç”Ÿå‘½å‘¨æœŸå›è°ƒæ³¨è§£)
3. [å®ä½“ç›‘å¬å™¨çš„å®ç°æ–¹å¼](#3-å®ä½“ç›‘å¬å™¨çš„å®ç°æ–¹å¼)
4. [å®¡è®¡å­—æ®µè‡ªåŠ¨å¡«å……](#4-å®¡è®¡å­—æ®µè‡ªåŠ¨å¡«å……)
5. [Enverså˜æ›´å®¡è®¡](#5-enverså˜æ›´å®¡è®¡)
6. [æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹](#6-æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å®ä½“ç›‘å¬å™¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å®ä½“ç›‘å¬å™¨ï¼Ÿ


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> æƒ³è±¡ä½ çš„æˆ¿å­è£…äº†æ™ºèƒ½ç›‘æ§ç³»ç»Ÿï¼Œæ¯å½“æœ‰äººè¿›é—¨ã€å‡ºé—¨ã€å¼€ç¯ã€å…³ç¯æ—¶ï¼Œç³»ç»Ÿéƒ½ä¼šè‡ªåŠ¨è®°å½•æ—¶é—´å’Œæ“ä½œäººã€‚å®ä½“ç›‘å¬å™¨å°±æ˜¯è¿™æ ·çš„"æ•°æ®åº“ç›‘æ§ç³»ç»Ÿ"ï¼Œå®ƒèƒ½åœ¨æ•°æ®ä¿å­˜ã€ä¿®æ”¹ã€åˆ é™¤ç­‰å…³é”®æ—¶åˆ»è‡ªåŠ¨æ‰§è¡Œä½ è®¾å®šçš„æ“ä½œã€‚

**ğŸ“ æ ¸å¿ƒå®šä¹‰**
```
å®ä½“ç›‘å¬å™¨ï¼ˆEntity Listenerï¼‰ï¼š
â€¢ æ˜¯ä»€ä¹ˆï¼šJPAæä¾›çš„å›è°ƒæœºåˆ¶ï¼Œåœ¨å®ä½“ç”Ÿå‘½å‘¨æœŸçš„å…³é”®èŠ‚ç‚¹è‡ªåŠ¨è§¦å‘
â€¢ åšä»€ä¹ˆï¼šåœ¨æ•°æ®ä¿å­˜å‰åã€ä¿®æ”¹å‰åã€åˆ é™¤å‰åç­‰æ—¶åˆ»è‡ªåŠ¨æ‰§è¡Œç‰¹å®šé€»è¾‘
â€¢ ä¸ºä»€ä¹ˆï¼šè‡ªåŠ¨åŒ–å¤„ç†å®¡è®¡ã€éªŒè¯ã€æ—¥å¿—ç­‰é€šç”¨éœ€æ±‚
```

**ğŸ’¡ å…¸å‹åº”ç”¨åœºæ™¯**
- âœ… **è‡ªåŠ¨è®°å½•åˆ›å»ºæ—¶é—´**ï¼šæ–°æ•°æ®ä¿å­˜æ—¶è‡ªåŠ¨å¡«å……åˆ›å»ºæ—¶é—´
- âœ… **è‡ªåŠ¨è®°å½•ä¿®æ”¹æ—¶é—´**ï¼šæ•°æ®æ›´æ–°æ—¶è‡ªåŠ¨æ›´æ–°ä¿®æ”¹æ—¶é—´
- âœ… **è®°å½•æ“ä½œäººä¿¡æ¯**ï¼šè‡ªåŠ¨è®°å½•æ˜¯è°åˆ›å»º/ä¿®æ”¹äº†æ•°æ®
- âœ… **æ•°æ®éªŒè¯**ï¼šä¿å­˜å‰è‡ªåŠ¨æ£€æŸ¥æ•°æ®åˆæ³•æ€§
- âœ… **å˜æ›´å®¡è®¡**ï¼šè®°å½•æ•°æ®çš„å†å²å˜æ›´è®°å½•

### 1.2 ç›‘å¬å™¨çš„å·¥ä½œåŸç†


**ğŸ”„ è§¦å‘æ—¶æœºå›¾ç¤º**
```
æ•°æ®åº“æ“ä½œæµç¨‹ï¼š
                              
  åº”ç”¨ä»£ç                 JPA/Hibernate              æ•°æ®åº“
     |                          |                      |
     |--save(entity)----------->|                      |
     |                          |                      |
     |                    [è§¦å‘@PrePersist]           |
     |                          |                      |
     |                          |--INSERTè¯­å¥--------->|
     |                          |                      |
     |                          |<-----ç¡®è®¤æ‰§è¡Œ--------|
     |                          |                      |
     |                    [è§¦å‘@PostPersist]          |
     |                          |                      |
     |<-------è¿”å›ä¿å­˜ç»“æœ-------|                      |
```

**âš™ï¸ æ‰§è¡Œæµç¨‹è¯´æ˜**
```
1ï¸âƒ£ ä¿å­˜æ“ä½œè§¦å‘
   â†“
2ï¸âƒ£ @PrePersistæ–¹æ³•æ‰§è¡Œï¼ˆä¿å­˜å‰ï¼‰
   â†“  
3ï¸âƒ£ æ‰§è¡ŒSQL INSERTè¯­å¥
   â†“
4ï¸âƒ£ @PostPersistæ–¹æ³•æ‰§è¡Œï¼ˆä¿å­˜åï¼‰
   â†“
5ï¸âƒ£ æ“ä½œå®Œæˆè¿”å›
```

---

## 2. ğŸ“‹ ä¸ƒå¤§ç”Ÿå‘½å‘¨æœŸå›è°ƒæ³¨è§£


### 2.1 @PrePersist - ä¿å­˜å‰è§¦å‘


**ğŸ’¡ æ ¸å¿ƒä½œç”¨**
> åœ¨æ–°æ•°æ®å³å°†ä¿å­˜åˆ°æ•°æ®åº“ä¹‹å‰æ‰§è¡Œï¼Œ**è¿™æ˜¯è®¾ç½®é»˜è®¤å€¼å’Œåˆ›å»ºæ—¶é—´çš„æœ€ä½³æ—¶æœº**ã€‚

**ğŸ¯ å…¸å‹ç”¨é€”**
- è®¾ç½®åˆ›å»ºæ—¶é—´ `createdAt`
- è®¾ç½®åˆ›å»ºäºº `createdBy`
- ç”Ÿæˆå”¯ä¸€æ ‡è¯† `UUID`
- æ•°æ®åˆå§‹åŒ–å¤„ç†

**ğŸ“ ä»£ç ç¤ºä¾‹**
```java
@Entity
public class User {
    @Id
    @GeneratedValue
    private Long id;
    
    private String username;
    private LocalDateTime createdAt;
    
    // ä¿å­˜å‰è‡ªåŠ¨è®¾ç½®åˆ›å»ºæ—¶é—´
    @PrePersist
    public void beforeSave() {
        this.createdAt = LocalDateTime.now();
        System.out.println("å³å°†ä¿å­˜ç”¨æˆ·ï¼š" + username);
    }
}
```

**ğŸ” æ‰§è¡Œæ—¶æœº**
```
User user = new User();
user.setUsername("å¼ ä¸‰");
                            â”Œâ”€ æ­¤æ—¶è§¦å‘ @PrePersist
                            â†“
userRepository.save(user);  â†’ beforeSave()æ‰§è¡Œ â†’ INSERTåˆ°æ•°æ®åº“
```

### 2.2 @PostPersist - ä¿å­˜åè§¦å‘


**ğŸ’¡ æ ¸å¿ƒä½œç”¨**
> åœ¨æ•°æ®æˆåŠŸä¿å­˜åˆ°æ•°æ®åº“ä¹‹åæ‰§è¡Œï¼Œ**æ­¤æ—¶IDå·²ç»ç”Ÿæˆï¼Œå¯ä»¥è·å–åˆ°æ•°æ®åº“è¿”å›çš„ä¸»é”®å€¼**ã€‚

**ğŸ¯ å…¸å‹ç”¨é€”**
- å‘é€é€šçŸ¥ï¼ˆå¦‚æ³¨å†ŒæˆåŠŸé‚®ä»¶ï¼‰
- è®°å½•æ“ä½œæ—¥å¿—
- è§¦å‘åç»­ä¸šåŠ¡æµç¨‹
- ç¼“å­˜é¢„çƒ­

**ğŸ“ ä»£ç ç¤ºä¾‹**
```java
@Entity
public class Order {
    @Id
    @GeneratedValue
    private Long id;
    
    private String orderNo;
    private BigDecimal amount;
    
    // ä¿å­˜åå‘é€é€šçŸ¥
    @PostPersist
    public void afterSave() {
        System.out.println("è®¢å•ä¿å­˜æˆåŠŸï¼ŒIDï¼š" + id);
        // å‘é€è®¢å•åˆ›å»ºé€šçŸ¥
        // emailService.sendOrderNotification(this);
    }
}
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
> åœ¨`@PostPersist`ä¸­ï¼Œå®ä½“çš„IDå·²ç»è¢«èµ‹å€¼ï¼Œå¯ä»¥å®‰å…¨ä½¿ç”¨ã€‚ä½†è¦é¿å…åœ¨è¿™é‡Œå†æ¬¡è°ƒç”¨`save()`æ–¹æ³•ï¼Œä¼šå¯¼è‡´æ— é™å¾ªç¯ï¼

### 2.3 @PreUpdate - æ›´æ–°å‰è§¦å‘


**ğŸ’¡ æ ¸å¿ƒä½œç”¨**
> åœ¨æ•°æ®å³å°†è¢«æ›´æ–°åˆ°æ•°æ®åº“ä¹‹å‰æ‰§è¡Œï¼Œ**è¿™æ˜¯è‡ªåŠ¨è®¾ç½®ä¿®æ”¹æ—¶é—´çš„æœ€ä½³ä½ç½®**ã€‚

**ğŸ¯ å…¸å‹ç”¨é€”**
- æ›´æ–°ä¿®æ”¹æ—¶é—´ `updatedAt`
- è®°å½•ä¿®æ”¹äºº `updatedBy`
- æ•°æ®ç‰ˆæœ¬æ§åˆ¶
- ä¿®æ”¹å‰æ•°æ®éªŒè¯

**ğŸ“ ä»£ç ç¤ºä¾‹**
```java
@Entity
public class Article {
    @Id
    private Long id;
    
    private String title;
    private String content;
    private LocalDateTime updatedAt;
    private Integer version;
    
    // æ›´æ–°å‰è‡ªåŠ¨è®¾ç½®ä¿®æ”¹æ—¶é—´å’Œç‰ˆæœ¬å·
    @PreUpdate
    public void beforeUpdate() {
        this.updatedAt = LocalDateTime.now();
        this.version = (version == null ? 0 : version) + 1;
        System.out.println("å³å°†æ›´æ–°æ–‡ç« ï¼š" + title);
    }
}
```

**ğŸ” æ‰§è¡Œæ—¶æœº**
```
Article article = repository.findById(1L);
article.setContent("æ–°å†…å®¹");
                                  â”Œâ”€ æ­¤æ—¶è§¦å‘ @PreUpdate
                                  â†“
repository.save(article);  â†’ beforeUpdate()æ‰§è¡Œ â†’ UPDATEåˆ°æ•°æ®åº“
```

### 2.4 @PostUpdate - æ›´æ–°åè§¦å‘


**ğŸ’¡ æ ¸å¿ƒä½œç”¨**
> åœ¨æ•°æ®æˆåŠŸæ›´æ–°åˆ°æ•°æ®åº“ä¹‹åæ‰§è¡Œï¼Œ**é€‚åˆæ‰§è¡Œæ›´æ–°åçš„æ¸…ç†å’Œé€šçŸ¥å·¥ä½œ**ã€‚

**ğŸ¯ å…¸å‹ç”¨é€”**
- æ¸…ç†ç¼“å­˜
- å‘é€å˜æ›´é€šçŸ¥
- åŒæ­¥åˆ°å…¶ä»–ç³»ç»Ÿ
- è®°å½•å˜æ›´æ—¥å¿—

**ğŸ“ ä»£ç ç¤ºä¾‹**
```java
@Entity
public class Product {
    @Id
    private Long id;
    
    private String name;
    private BigDecimal price;
    
    // æ›´æ–°åæ¸…ç†ç¼“å­˜
    @PostUpdate
    public void afterUpdate() {
        System.out.println("å•†å“å·²æ›´æ–°ï¼š" + name);
        // æ¸…ç†Redisç¼“å­˜
        // redisTemplate.delete("product:" + id);
    }
}
```

### 2.5 @PreRemove - åˆ é™¤å‰è§¦å‘


**ğŸ’¡ æ ¸å¿ƒä½œç”¨**
> åœ¨æ•°æ®å³å°†è¢«åˆ é™¤ä¹‹å‰æ‰§è¡Œï¼Œ**è¿™æ˜¯æ‰§è¡Œåˆ é™¤å‰æ£€æŸ¥å’Œå…³è”æ¸…ç†çš„æ—¶æœº**ã€‚

**ğŸ¯ å…¸å‹ç”¨é€”**
- æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ é™¤
- æ¸…ç†å…³è”æ•°æ®
- å¤‡ä»½æ•°æ®
- è®°å½•åˆ é™¤åŸå› 

**ğŸ“ ä»£ç ç¤ºä¾‹**
```java
@Entity
public class Department {
    @Id
    private Long id;
    
    private String name;
    
    @OneToMany(mappedBy = "department")
    private List<Employee> employees;
    
    // åˆ é™¤å‰æ£€æŸ¥
    @PreRemove
    public void beforeDelete() {
        if (employees != null && !employees.isEmpty()) {
            throw new RuntimeException("éƒ¨é—¨ä¸‹è¿˜æœ‰å‘˜å·¥ï¼Œä¸èƒ½åˆ é™¤ï¼");
        }
        System.out.println("å³å°†åˆ é™¤éƒ¨é—¨ï¼š" + name);
    }
}
```

**âš ï¸ å®‰å…¨æç¤º**
> åœ¨`@PreRemove`ä¸­æŠ›å‡ºå¼‚å¸¸å¯ä»¥é˜»æ­¢åˆ é™¤æ“ä½œï¼Œè¿™æ˜¯å®ç°"è½¯åˆ é™¤"ä¿æŠ¤çš„é‡è¦æœºåˆ¶ã€‚

### 2.6 @PostRemove - åˆ é™¤åè§¦å‘


**ğŸ’¡ æ ¸å¿ƒä½œç”¨**
> åœ¨æ•°æ®æˆåŠŸä»æ•°æ®åº“åˆ é™¤ä¹‹åæ‰§è¡Œï¼Œ**é€‚åˆæ‰§è¡Œåˆ é™¤åçš„æ¸…ç†å·¥ä½œ**ã€‚

**ğŸ¯ å…¸å‹ç”¨é€”**
- æ¸…ç†å…³è”ç¼“å­˜
- åˆ é™¤å…³è”æ–‡ä»¶
- è®°å½•åˆ é™¤æ—¥å¿—
- è§¦å‘åç»­æµç¨‹

**ğŸ“ ä»£ç ç¤ºä¾‹**
```java
@Entity
public class Attachment {
    @Id
    private Long id;
    
    private String fileName;
    private String filePath;
    
    // åˆ é™¤åæ¸…ç†ç‰©ç†æ–‡ä»¶
    @PostRemove
    public void afterDelete() {
        System.out.println("é™„ä»¶å·²åˆ é™¤ï¼š" + fileName);
        // åˆ é™¤æœåŠ¡å™¨ä¸Šçš„ç‰©ç†æ–‡ä»¶
        // fileService.deleteFile(filePath);
    }
}
```

### 2.7 @PostLoad - åŠ è½½åè§¦å‘


**ğŸ’¡ æ ¸å¿ƒä½œç”¨**
> åœ¨å®ä½“ä»æ•°æ®åº“åŠ è½½åˆ°å†…å­˜ä¹‹åæ‰§è¡Œï¼Œ**è¿™æ˜¯å¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œåå¤„ç†çš„æ—¶æœº**ã€‚

**ğŸ¯ å…¸å‹ç”¨é€”**
- è§£å¯†æ•æ„Ÿæ•°æ®
- æ ¼å¼åŒ–æ˜¾ç¤ºå†…å®¹
- åˆå§‹åŒ–ç¬æ—¶å­—æ®µ
- æƒé™æ£€æŸ¥

**ğŸ“ ä»£ç ç¤ºä¾‹**
```java
@Entity
public class UserProfile {
    @Id
    private Long id;
    
    private String encryptedPhone;  // æ•°æ®åº“ä¸­åŠ å¯†å­˜å‚¨
    
    @Transient  // ä¸å­˜æ•°æ®åº“
    private String phone;  // å†…å­˜ä¸­æ˜æ–‡ä½¿ç”¨
    
    // åŠ è½½åè§£å¯†
    @PostLoad
    public void afterLoad() {
        // è§£å¯†æ‰‹æœºå·ä¾›æ˜¾ç¤ºä½¿ç”¨
        this.phone = decrypt(encryptedPhone);
        System.out.println("ç”¨æˆ·æ•°æ®å·²åŠ è½½å¹¶è§£å¯†");
    }
    
    private String decrypt(String encrypted) {
        // è§£å¯†é€»è¾‘
        return encrypted;  // ç®€åŒ–ç¤ºä¾‹
    }
}
```

**ğŸ“Š ä¸ƒå¤§æ³¨è§£å¯¹æ¯”è¡¨**

| æ³¨è§£ | è§¦å‘æ—¶æœº | å…¸å‹ç”¨é€” | æ˜¯å¦æœ‰ID | èƒ½å¦é˜»æ­¢æ“ä½œ |
|------|---------|---------|---------|------------|
| **@PrePersist** | `ä¿å­˜å‰` | è®¾ç½®åˆ›å»ºæ—¶é—´ã€åˆå§‹åŒ–æ•°æ® | âŒ æ—  | âœ… å¯ä»¥(æŠ›å¼‚å¸¸) |
| **@PostPersist** | `ä¿å­˜å` | å‘é€é€šçŸ¥ã€è®°å½•æ—¥å¿— | âœ… æœ‰ | âŒ ä¸èƒ½ |
| **@PreUpdate** | `æ›´æ–°å‰` | è®¾ç½®ä¿®æ”¹æ—¶é—´ã€ç‰ˆæœ¬æ§åˆ¶ | âœ… æœ‰ | âœ… å¯ä»¥(æŠ›å¼‚å¸¸) |
| **@PostUpdate** | `æ›´æ–°å` | æ¸…ç†ç¼“å­˜ã€åŒæ­¥æ•°æ® | âœ… æœ‰ | âŒ ä¸èƒ½ |
| **@PreRemove** | `åˆ é™¤å‰` | æ£€æŸ¥çº¦æŸã€å¤‡ä»½æ•°æ® | âœ… æœ‰ | âœ… å¯ä»¥(æŠ›å¼‚å¸¸) |
| **@PostRemove** | `åˆ é™¤å` | æ¸…ç†æ–‡ä»¶ã€è®°å½•æ—¥å¿— | âœ… æœ‰ | âŒ ä¸èƒ½ |
| **@PostLoad** | `æŸ¥è¯¢å` | è§£å¯†æ•°æ®ã€æ ¼å¼åŒ–æ˜¾ç¤º | âœ… æœ‰ | âŒ ä¸èƒ½ |

---

## 3. ğŸ”§ å®ä½“ç›‘å¬å™¨çš„å®ç°æ–¹å¼


### 3.1 æ–¹å¼ä¸€ï¼šå®ä½“ç±»å†…éƒ¨æ–¹æ³•ï¼ˆæœ€ç®€å•ï¼‰


**ğŸ’¡ é€‚ç”¨åœºæ™¯**
> å½“ç›‘å¬é€»è¾‘åªé’ˆå¯¹å½“å‰å®ä½“ä¸”æ¯”è¾ƒç®€å•æ—¶ä½¿ç”¨ï¼Œ**è¿™æ˜¯æœ€ç›´è§‚çš„æ–¹å¼**ã€‚

**ğŸ“ å®Œæ•´ç¤ºä¾‹**
```java
@Entity
public class Blog {
    @Id
    @GeneratedValue
    private Long id;
    
    private String title;
    private String content;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    
    // æ–¹æ³•åå¯ä»¥ä»»æ„å–ï¼Œå…³é”®æ˜¯æ³¨è§£
    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
    }
    
    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
    }
    
    @PostLoad
    protected void onLoad() {
        System.out.println("åšå®¢å·²åŠ è½½ï¼š" + title);
    }
}
```

**âœ… ä¼˜ç‚¹**
- ç®€å•ç›´è§‚ï¼Œé€»è¾‘å°±åœ¨å®ä½“ç±»ä¸­
- ä¸éœ€è¦é¢å¤–çš„ç±»æ–‡ä»¶
- é€‚åˆç®€å•çš„ç›‘å¬éœ€æ±‚

**âŒ ç¼ºç‚¹**
- æ— æ³•å¤ç”¨ï¼Œæ¯ä¸ªå®ä½“éƒ½è¦å†™ä¸€é
- å®ä½“ç±»ä»£ç å˜å¤šï¼ŒèŒè´£ä¸æ¸…æ™°

### 3.2 æ–¹å¼äºŒï¼šç‹¬ç«‹ç›‘å¬å™¨ç±»ï¼ˆå¯å¤ç”¨ï¼‰


**ğŸ’¡ é€‚ç”¨åœºæ™¯**
> å½“å¤šä¸ªå®ä½“éœ€è¦ç›¸åŒçš„ç›‘å¬é€»è¾‘æ—¶ä½¿ç”¨ï¼Œ**è¿™æ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼**ã€‚

**ğŸ“ ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºç›‘å¬å™¨ç±»**
```java
// é€šç”¨çš„å®¡è®¡ç›‘å¬å™¨
public class AuditListener {
    
    @PrePersist
    public void setCreatedTime(Object entity) {
        // å¦‚æœå®ä½“æœ‰Auditableæ¥å£
        if (entity instanceof Auditable) {
            Auditable auditable = (Auditable) entity;
            auditable.setCreatedAt(LocalDateTime.now());
            auditable.setCreatedBy(getCurrentUser());
        }
    }
    
    @PreUpdate
    public void setUpdatedTime(Object entity) {
        if (entity instanceof Auditable) {
            Auditable auditable = (Auditable) entity;
            auditable.setUpdatedAt(LocalDateTime.now());
            auditable.setUpdatedBy(getCurrentUser());
        }
    }
    
    private String getCurrentUser() {
        // ä»Spring Securityè·å–å½“å‰ç”¨æˆ·
        return "admin";  // ç®€åŒ–ç¤ºä¾‹
    }
}
```

**ğŸ“ ç¬¬äºŒæ­¥ï¼šå®šä¹‰å®¡è®¡æ¥å£**
```java
public interface Auditable {
    void setCreatedAt(LocalDateTime time);
    void setCreatedBy(String user);
    void setUpdatedAt(LocalDateTime time);
    void setUpdatedBy(String user);
}
```

**ğŸ“ ç¬¬ä¸‰æ­¥ï¼šå®ä½“ç±»åº”ç”¨ç›‘å¬å™¨**
```java
@Entity
@EntityListeners(AuditListener.class)  // å…³é”®ï¼šæŒ‡å®šç›‘å¬å™¨
public class Article implements Auditable {
    @Id
    @GeneratedValue
    private Long id;
    
    private String title;
    private LocalDateTime createdAt;
    private String createdBy;
    private LocalDateTime updatedAt;
    private String updatedBy;
    
    // å®ç°Auditableæ¥å£çš„setteræ–¹æ³•
    @Override
    public void setCreatedAt(LocalDateTime time) {
        this.createdAt = time;
    }
    
    @Override
    public void setCreatedBy(String user) {
        this.createdBy = user;
    }
    
    @Override
    public void setUpdatedAt(LocalDateTime time) {
        this.updatedAt = time;
    }
    
    @Override
    public void setUpdatedBy(String user) {
        this.updatedBy = user;
    }
}
```

**ğŸ“ å¤šä¸ªå®ä½“å…±ç”¨åŒä¸€ä¸ªç›‘å¬å™¨**
```java
@Entity
@EntityListeners(AuditListener.class)
public class Comment implements Auditable {
    // åŒæ ·çš„å®¡è®¡å­—æ®µå’Œå®ç°
    private LocalDateTime createdAt;
    private String createdBy;
    // ...
}

@Entity
@EntityListeners(AuditListener.class)
public class Like implements Auditable {
    // åŒæ ·çš„å®¡è®¡å­—æ®µå’Œå®ç°
    private LocalDateTime createdAt;
    private String createdBy;
    // ...
}
```

**ğŸ¯ å¤ç”¨æ•ˆæœå›¾ç¤º**
```
        AuditListener (ä¸€ä¸ªç›‘å¬å™¨)
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“         â†“         â†“
 Article   Comment    Like
(éƒ½è‡ªåŠ¨å¡«å……å®¡è®¡å­—æ®µ)
```

**âœ… ä¼˜ç‚¹**
- é€»è¾‘å¤ç”¨ï¼Œå¤šä¸ªå®ä½“å…±äº«
- èŒè´£åˆ†ç¦»ï¼Œä»£ç æ›´æ¸…æ™°
- ä¾¿äºç»Ÿä¸€ç®¡ç†å’Œç»´æŠ¤

**âŒ ç¼ºç‚¹**
- éœ€è¦é¢å¤–çš„ç±»æ–‡ä»¶
- éœ€è¦å®šä¹‰æ¥å£è§„èŒƒ

### 3.3 æ–¹å¼ä¸‰ï¼šå…¨å±€é»˜è®¤ç›‘å¬å™¨ï¼ˆé«˜çº§ï¼‰


**ğŸ’¡ é€‚ç”¨åœºæ™¯**
> å½“æ‰€æœ‰å®ä½“éƒ½éœ€è¦æŸä¸ªç›‘å¬é€»è¾‘æ—¶ä½¿ç”¨ï¼Œ**ä¸éœ€è¦åœ¨æ¯ä¸ªå®ä½“ä¸ŠåŠ æ³¨è§£**ã€‚

**ğŸ“ é…ç½®å…¨å±€ç›‘å¬å™¨**
```xml
<!-- META-INF/orm.xml æ–‡ä»¶ä¸­é…ç½® -->
<entity-mappings>
    <persistence-unit-metadata>
        <persistence-unit-defaults>
            <entity-listeners>
                <!-- å…¨å±€ç”Ÿæ•ˆçš„ç›‘å¬å™¨ -->
                <entity-listener class="com.example.listener.GlobalAuditListener"/>
            </entity-listeners>
        </persistence-unit-defaults>
    </persistence-unit-metadata>
</entity-mappings>
```

**ğŸ“ Spring Booté…ç½®æ–¹å¼**
```java
@Configuration
public class JpaConfig {
    
    @Bean
    public AuditorAware<String> auditorProvider() {
        // è¿”å›å½“å‰æ“ä½œç”¨æˆ·
        return () -> Optional.of(getCurrentUser());
    }
    
    private String getCurrentUser() {
        // å®é™…é¡¹ç›®ä¸­ä»Securityè·å–
        return "admin";
    }
}
```

**ğŸ” ä¸‰ç§æ–¹å¼å¯¹æ¯”**

| æ–¹å¼ | é€‚ç”¨åœºæ™¯ | å¤ç”¨æ€§ | é…ç½®å¤æ‚åº¦ |
|------|---------|-------|-----------|
| **å®ä½“å†…éƒ¨æ–¹æ³•** | é€»è¾‘ç®€å•ã€å•ä¸€å®ä½“ | â­ ä½ | â­â­â­ ç®€å• |
| **ç‹¬ç«‹ç›‘å¬å™¨ç±»** | å¤šå®ä½“å…±äº«é€»è¾‘ | â­â­â­ é«˜ | â­â­ ä¸­ç­‰ |
| **å…¨å±€é»˜è®¤ç›‘å¬å™¨** | æ‰€æœ‰å®ä½“é€šç”¨é€»è¾‘ | â­â­â­ é«˜ | â­ å¤æ‚ |

---

## 4. ğŸ“ å®¡è®¡å­—æ®µè‡ªåŠ¨å¡«å……


### 4.1 ä»€ä¹ˆæ˜¯å®¡è®¡å­—æ®µï¼Ÿ


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> å°±åƒæ–‡æ¡£ä¸Šçš„"åˆ›å»ºäººï¼šå¼ ä¸‰ï¼Œåˆ›å»ºæ—¶é—´ï¼š2025-01-01"è¿™æ ·çš„ä¿¡æ¯ï¼Œå®¡è®¡å­—æ®µè®°å½•äº†æ•°æ®çš„"èº«ä»½è¯"ä¿¡æ¯ã€‚

**ğŸ“‹ å¸¸è§å®¡è®¡å­—æ®µ**
```
åŸºç¡€å››ä»¶å¥—ï¼š
â€¢ createdAt   - åˆ›å»ºæ—¶é—´ï¼ˆä½•æ—¶åˆ›å»ºçš„ï¼‰
â€¢ createdBy   - åˆ›å»ºäººï¼ˆè°åˆ›å»ºçš„ï¼‰
â€¢ updatedAt   - ä¿®æ”¹æ—¶é—´ï¼ˆä½•æ—¶ä¿®æ”¹çš„ï¼‰
â€¢ updatedBy   - ä¿®æ”¹äººï¼ˆè°ä¿®æ”¹çš„ï¼‰

æ‰©å±•å­—æ®µï¼š
â€¢ version     - ç‰ˆæœ¬å·ï¼ˆæ”¹äº†å‡ æ¬¡ï¼‰
â€¢ deleted     - æ˜¯å¦åˆ é™¤ï¼ˆè½¯åˆ é™¤æ ‡è®°ï¼‰
â€¢ deletedAt   - åˆ é™¤æ—¶é—´
â€¢ deletedBy   - åˆ é™¤äºº
```

### 4.2 æ‰‹åŠ¨å®ç°å®¡è®¡åŠŸèƒ½


**ğŸ“ åˆ›å»ºåŸºç¡€å®¡è®¡å®ä½“**
```java
@MappedSuperclass  // è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªçˆ¶ç±»ï¼Œä¸æ˜¯ç‹¬ç«‹çš„è¡¨
public abstract class AuditEntity {
    
    @Column(updatable = false)  // åˆ›å»ºåä¸å¯ä¿®æ”¹
    private LocalDateTime createdAt;
    
    @Column(updatable = false)
    private String createdBy;
    
    private LocalDateTime updatedAt;
    private String updatedBy;
    
    @PrePersist
    protected void onCreate() {
        LocalDateTime now = LocalDateTime.now();
        this.createdAt = now;
        this.updatedAt = now;
        
        String user = getCurrentUser();
        this.createdBy = user;
        this.updatedBy = user;
    }
    
    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
        this.updatedBy = getCurrentUser();
    }
    
    private String getCurrentUser() {
        // å®é™…é¡¹ç›®ä¸­ä»Spring Securityè·å–
        return "admin";
    }
    
    // getterå’Œsetteræ–¹æ³•...
}
```

**ğŸ“ ä¸šåŠ¡å®ä½“ç»§æ‰¿å®¡è®¡å®ä½“**
```java
@Entity
public class Product extends AuditEntity {
    @Id
    @GeneratedValue
    private Long id;
    
    private String name;
    private BigDecimal price;
    
    // è‡ªåŠ¨ç»§æ‰¿äº†å®¡è®¡å­—æ®µå’Œç›‘å¬å™¨
    // ä¸éœ€è¦å†™ä»»ä½•å®¡è®¡ç›¸å…³ä»£ç ï¼
}
```

**ğŸ¯ ä½¿ç”¨æ•ˆæœ**
```java
// ä¿å­˜å•†å“
Product product = new Product();
product.setName("iPhone 15");
product.setPrice(new BigDecimal("6999"));

productRepository.save(product);

// æ•°æ®åº“ä¸­è‡ªåŠ¨å¡«å……äº†ï¼š
// created_at = 2025-09-23 15:30:00
// created_by = admin
// updated_at = 2025-09-23 15:30:00
// updated_by = admin
```

### 4.3 Spring Data JPAçš„@CreatedDateå’Œ@LastModifiedDate


**ğŸ’¡ æ›´ç®€å•çš„æ–¹å¼**
> Spring Data JPAæä¾›äº†æ³¨è§£ï¼Œ**è‡ªåŠ¨å¸®ä½ å¤„ç†æ—¶é—´å­—æ®µ**ï¼Œä¸éœ€è¦å†™ç›‘å¬å™¨ä»£ç ï¼

**ğŸ“ ç¬¬ä¸€æ­¥ï¼šå¯ç”¨å®¡è®¡åŠŸèƒ½**
```java
@Configuration
@EnableJpaAuditing  // å…³é”®ï¼šå¼€å¯JPAå®¡è®¡
public class JpaConfig {
    
    // æä¾›å½“å‰ç”¨æˆ·ä¿¡æ¯
    @Bean
    public AuditorAware<String> auditorProvider() {
        return () -> Optional.of("admin");  // å®é™…ä»Securityè·å–
    }
}
```

**ğŸ“ ç¬¬äºŒæ­¥ï¼šä½¿ç”¨å®¡è®¡æ³¨è§£**
```java
@Entity
@EntityListeners(AuditingEntityListener.class)  // ä½¿ç”¨Springçš„å®¡è®¡ç›‘å¬å™¨
public class Order {
    @Id
    @GeneratedValue
    private Long id;
    
    private String orderNo;
    
    @CreatedDate  // è‡ªåŠ¨å¡«å……åˆ›å»ºæ—¶é—´
    private LocalDateTime createdAt;
    
    @CreatedBy  // è‡ªåŠ¨å¡«å……åˆ›å»ºäºº
    private String createdBy;
    
    @LastModifiedDate  // è‡ªåŠ¨å¡«å……ä¿®æ”¹æ—¶é—´
    private LocalDateTime updatedAt;
    
    @LastModifiedBy  // è‡ªåŠ¨å¡«å……ä¿®æ”¹äºº
    private String updatedBy;
}
```

**ğŸš€ å®Œå…¨è‡ªåŠ¨åŒ–**
```java
// ä½ åªéœ€è¦å…³æ³¨ä¸šåŠ¡é€»è¾‘
Order order = new Order();
order.setOrderNo("ORD20250923001");

orderRepository.save(order);
// Springè‡ªåŠ¨å¡«å……æ‰€æœ‰å®¡è®¡å­—æ®µï¼
```

**ğŸ“Š æ‰‹åŠ¨å®ç° vs Springæ³¨è§£å¯¹æ¯”**

| ç‰¹æ€§ | æ‰‹åŠ¨ç›‘å¬å™¨å®ç° | Springå®¡è®¡æ³¨è§£ |
|------|--------------|---------------|
| **é…ç½®å¤æ‚åº¦** | ğŸŸ¡ éœ€è¦å†™ç›‘å¬å™¨ä»£ç  | ğŸŸ¢ åªéœ€åŠ æ³¨è§£ |
| **çµæ´»æ€§** | ğŸŸ¢ å®Œå…¨è‡ªå®šä¹‰ | ğŸŸ¡ å›ºå®šé€»è¾‘ |
| **ä»£ç é‡** | ğŸŸ¡ è¾ƒå¤š | ğŸŸ¢ æå°‘ |
| **æ¨èåº¦** | â­â­â­ | â­â­â­â­â­ |

**ğŸ’¡ å®é™…é¡¹ç›®å»ºè®®**
```
âœ… æ¨èä½¿ç”¨Springå®¡è®¡æ³¨è§£ï¼š
â€¢ ä»£ç ç®€æ´ï¼Œç»´æŠ¤æ–¹ä¾¿
â€¢ Springå®˜æ–¹æ”¯æŒï¼Œç¨³å®šå¯é 
â€¢ æ»¡è¶³å¤§å¤šæ•°å®¡è®¡éœ€æ±‚

âš ï¸ ç‰¹æ®Šåœºæ™¯æ‰æ‰‹åŠ¨å®ç°ï¼š
â€¢ éœ€è¦å¤æ‚çš„å®¡è®¡é€»è¾‘
â€¢ éœ€è¦è‡ªå®šä¹‰å®¡è®¡è§„åˆ™
â€¢ ä¸ä½¿ç”¨Spring Data JPA
```

---

## 5. ğŸ“š Enverså˜æ›´å®¡è®¡


### 5.1 ä»€ä¹ˆæ˜¯Enversï¼Ÿ


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> æƒ³è±¡ä½ ç”¨Wordå†™æ–‡æ¡£ï¼ŒWordä¼šè®°å½•æ¯ä¸€æ¬¡ä¿®æ”¹çš„å†å²ç‰ˆæœ¬ï¼Œä½ å¯ä»¥çœ‹åˆ°"è°åœ¨ä»€ä¹ˆæ—¶é—´æ”¹äº†ä»€ä¹ˆå†…å®¹"ã€‚Enverså°±æ˜¯ç»™æ•°æ®åº“æ•°æ®æä¾›è¿™æ ·çš„"å†å²ç‰ˆæœ¬"åŠŸèƒ½ã€‚

**ğŸ“ æ ¸å¿ƒæ¦‚å¿µ**
```
Hibernate Enversï¼š
â€¢ æ˜¯ä»€ä¹ˆï¼šHibernateæä¾›çš„å®¡è®¡æ¡†æ¶
â€¢ åšä»€ä¹ˆï¼šè‡ªåŠ¨è®°å½•å®ä½“çš„æ‰€æœ‰å˜æ›´å†å²
â€¢ æ€ä¹ˆç”¨ï¼šåŠ ä¸ª@Auditedæ³¨è§£å°±è¡Œ

æ ¸å¿ƒåŠŸèƒ½ï¼š
âœ… è‡ªåŠ¨è®°å½•æ•°æ®å˜æ›´å†å²
âœ… è¿½è¸ªæ¯æ¬¡ä¿®æ”¹çš„å†…å®¹
âœ… è®°å½•ä¿®æ”¹æ—¶é—´å’Œä¿®æ”¹äºº
âœ… æ”¯æŒæŸ¥è¯¢å†å²ç‰ˆæœ¬
âœ… æ”¯æŒæ•°æ®å›æ»š
```

### 5.2 EnversåŸºç¡€ä½¿ç”¨


**ğŸ“ ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ–**
```xml
<dependency>
    <groupId>org.hibernate</groupId>
    <artifactId>hibernate-envers</artifactId>
</dependency>
```

**ğŸ“ ç¬¬äºŒæ­¥ï¼šå®ä½“ç±»åŠ @Auditedæ³¨è§£**
```java
@Entity
@Audited  // å°±è¿™ä¸€ä¸ªæ³¨è§£ï¼è‡ªåŠ¨å¯ç”¨å®¡è®¡
public class Employee {
    @Id
    @GeneratedValue
    private Long id;
    
    private String name;
    private String department;
    private BigDecimal salary;
    
    // getterå’Œsetter...
}
```

**ğŸ“ ç¬¬ä¸‰æ­¥ï¼šè‡ªåŠ¨ç”Ÿæˆå®¡è®¡è¡¨**
```
Enversä¼šè‡ªåŠ¨åˆ›å»ºå®¡è®¡è¡¨ï¼š
employee        ï¼ˆåŸè¡¨ï¼‰
employee_aud    ï¼ˆå®¡è®¡è¡¨ï¼Œè®°å½•æ‰€æœ‰å†å²ï¼‰
revinfo         ï¼ˆç‰ˆæœ¬ä¿¡æ¯è¡¨ï¼Œè®°å½•ä¿®æ”¹æ—¶é—´ç­‰ï¼‰

å®¡è®¡è¡¨ç»“æ„ï¼š
id  | name | department | salary | rev | revtype
----|------|-----------|--------|-----|--------
1   | å¼ ä¸‰  | ITéƒ¨      | 8000   | 1   | 0 (æ–°å¢)
1   | å¼ ä¸‰  | ITéƒ¨      | 9000   | 2   | 1 (ä¿®æ”¹)
1   | å¼ ä¸‰  | ç ”å‘éƒ¨    | 9000   | 3   | 1 (ä¿®æ”¹)
```

**ğŸ¯ æ•°æ®å˜æ›´è¿‡ç¨‹å›¾ç¤º**
```
æ—¶é—´çº¿ï¼š
         
t1: æ–°å¢å‘˜å·¥                    employeeè¡¨          employee_audè¡¨
    name=å¼ ä¸‰, salary=8000  â†’  [æ’å…¥è®°å½•]    â†’   [è®°å½•ç‰ˆæœ¬1ï¼šæ–°å¢]
    
t2: æ¶¨è–ªåˆ°9000              â†’  [æ›´æ–°salary]  â†’   [è®°å½•ç‰ˆæœ¬2ï¼šä¿®æ”¹]
    
t3: è°ƒåˆ°ç ”å‘éƒ¨              â†’  [æ›´æ–°dept]    â†’   [è®°å½•ç‰ˆæœ¬3ï¼šä¿®æ”¹]

å½“å‰çŠ¶æ€ï¼šemployeeè¡¨åªæœ‰æœ€æ–°æ•°æ®
å†å²è®°å½•ï¼šemployee_audè¡¨ä¿å­˜æ‰€æœ‰ç‰ˆæœ¬
```

### 5.3 æŸ¥è¯¢å†å²ç‰ˆæœ¬


**ğŸ“ æŸ¥è¯¢æ‰€æœ‰å†å²ç‰ˆæœ¬**
```java
@Service
public class EmployeeService {
    
    @PersistenceContext
    private EntityManager entityManager;
    
    // æŸ¥è¯¢å‘˜å·¥çš„æ‰€æœ‰å†å²è®°å½•
    public List<Number> getRevisions(Long employeeId) {
        AuditReader reader = AuditReaderFactory.get(entityManager);
        
        // è·å–æ‰€æœ‰ç‰ˆæœ¬å·
        List<Number> revisions = reader.getRevisions(Employee.class, employeeId);
        
        // è¿”å›ï¼š[1, 2, 3] è¡¨ç¤ºæœ‰3ä¸ªå†å²ç‰ˆæœ¬
        return revisions;
    }
    
    // æŸ¥è¯¢æŒ‡å®šç‰ˆæœ¬çš„æ•°æ®
    public Employee getHistoryVersion(Long employeeId, Number revision) {
        AuditReader reader = AuditReaderFactory.get(entityManager);
        
        // è·å–ç¬¬2ç‰ˆæœ¬çš„å‘˜å·¥æ•°æ®
        Employee history = reader.find(Employee.class, employeeId, revision);
        
        return history;  // è¿”å›é‚£ä¸ªæ—¶é—´ç‚¹çš„æ•°æ®å¿«ç…§
    }
    
    // æŸ¥è¯¢æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®
    public Employee getDataAtTime(Long employeeId, LocalDateTime time) {
        AuditReader reader = AuditReaderFactory.get(entityManager);
        
        Date date = Date.from(time.atZone(ZoneId.systemDefault()).toInstant());
        
        // æŸ¥è¯¢æŒ‡å®šæ—¶é—´ç‚¹çš„æ•°æ®çŠ¶æ€
        Employee history = reader.find(
            Employee.class, 
            employeeId, 
            date
        );
        
        return history;
    }
}
```

**ğŸ” ä½¿ç”¨ç¤ºä¾‹**
```java
// æŸ¥çœ‹å‘˜å·¥IDä¸º1çš„æ‰€æœ‰å˜æ›´å†å²
List<Number> versions = service.getRevisions(1L);
// ç»“æœï¼š[1, 2, 3]

// æŸ¥çœ‹ç¬¬2ä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼ˆæ¶¨è–ªåçš„çŠ¶æ€ï¼‰
Employee v2 = service.getHistoryVersion(1L, 2);
System.out.println(v2.getSalary());  // è¾“å‡ºï¼š9000

// æŸ¥çœ‹2025å¹´1æœˆ1æ—¥æ—¶çš„æ•°æ®
LocalDateTime date = LocalDateTime.of(2025, 1, 1, 0, 0);
Employee history = service.getDataAtTime(1L, date);
```

### 5.4 Enversé«˜çº§ç‰¹æ€§


**ğŸ¯ é€‰æ‹©æ€§å®¡è®¡å­—æ®µ**
```java
@Entity
@Audited
public class User {
    @Id
    private Long id;
    
    @Audited  // å®¡è®¡
    private String username;
    
    @NotAudited  // ä¸å®¡è®¡å¯†ç å˜æ›´
    private String password;
    
    @Audited
    private String email;
}
```

**ğŸ¯ å…³è”å®ä½“å®¡è®¡**
```java
@Entity
@Audited
public class Order {
    @Id
    private Long id;
    
    @ManyToOne
    @Audited(targetAuditMode = RelationTargetAuditMode.NOT_AUDITED)
    private Customer customer;  // ä¸å®¡è®¡Customerçš„å˜æ›´
    
    @OneToMany
    @Audited  // å®¡è®¡è®¢å•é¡¹çš„å˜æ›´
    private List<OrderItem> items;
}
```

**ğŸ“Š Enversæ ¸å¿ƒä¼˜åŠ¿**

| åŠŸèƒ½ç‰¹æ€§ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|
| **è‡ªåŠ¨åŒ–** | åŠ æ³¨è§£å³å¯ï¼Œæ— éœ€å†™ä»£ç  | æ‰€æœ‰éœ€è¦å®¡è®¡çš„åœºæ™¯ |
| **å®Œæ•´æ€§** | è®°å½•æ‰€æœ‰å­—æ®µå˜æ›´ | é‡‘èã€åŒ»ç–—ç­‰ä¸¥æ ¼å®¡è®¡ |
| **æ—¶é—´æ—…è¡Œ** | æŸ¥è¯¢ä»»æ„æ—¶é—´ç‚¹æ•°æ® | æ•°æ®æ¢å¤ã€å†å²åˆ†æ |
| **ç‰ˆæœ¬å¯¹æ¯”** | å¯ä»¥å¯¹æ¯”ä¸åŒç‰ˆæœ¬ | å˜æ›´å®¡æŸ¥ã€é—®é¢˜æ’æŸ¥ |

**âš ï¸ ä½¿ç”¨æ³¨æ„äº‹é¡¹**

```
ğŸ’¡ æ€§èƒ½è€ƒè™‘ï¼š
â€¢ æ¯æ¬¡ä¿®æ”¹éƒ½ä¼šæ’å…¥å®¡è®¡è¡¨ï¼Œæ•°æ®é‡ä¼šå¢å¤§
â€¢ å»ºè®®å®šæœŸå½’æ¡£æˆ–æ¸…ç†å†å²æ•°æ®
â€¢ å¯¹æ€§èƒ½æ•æ„Ÿçš„è¡¨è°¨æ…ä½¿ç”¨

ğŸ’¡ å­˜å‚¨è€ƒè™‘ï¼š
â€¢ å®¡è®¡è¡¨æ•°æ®é‡ â‰ˆ åŸè¡¨æ•°æ®é‡ Ã— å¹³å‡ä¿®æ”¹æ¬¡æ•°
â€¢ éœ€è¦é¢„ç•™è¶³å¤Ÿçš„å­˜å‚¨ç©ºé—´

ğŸ’¡ æœ€ä½³å®è·µï¼š
â€¢ åªå¯¹æ ¸å¿ƒä¸šåŠ¡è¡¨å¯ç”¨å®¡è®¡
â€¢ ä¸å®¡è®¡é¢‘ç¹å˜åŒ–çš„ä¸´æ—¶æ•°æ®
â€¢ é…åˆåˆ†åŒºè¡¨ç®¡ç†å†å²æ•°æ®
```

---

## 6. ğŸ’¡ æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹


### 6.1 ç›‘å¬å™¨ä½¿ç”¨æœ€ä½³å®è·µ


**âœ… DO - æ¨èåšæ³•**

**1. ä½¿ç”¨åŸºç±»ç»Ÿä¸€ç®¡ç†å®¡è®¡å­—æ®µ**
```java
@MappedSuperclass
public abstract class BaseEntity {
    @CreatedDate
    private LocalDateTime createdAt;
    
    @LastModifiedDate
    private LocalDateTime updatedAt;
}

// æ‰€æœ‰å®ä½“ç»§æ‰¿
@Entity
public class Product extends BaseEntity {
    // è‡ªåŠ¨æ‹¥æœ‰å®¡è®¡å­—æ®µ
}
```

**2. ç›‘å¬å™¨ä¿æŒç®€å•è½»é‡**
```java
@PrePersist
public void beforeSave() {
    // âœ… åªåšç®€å•çš„å­—æ®µèµ‹å€¼
    this.createdAt = LocalDateTime.now();
    
    // âŒ ä¸è¦åšå¤æ‚çš„ä¸šåŠ¡é€»è¾‘
    // this.calculateComplexData();
}
```

**3. é¿å…åœ¨ç›‘å¬å™¨ä¸­æ“ä½œæ•°æ®åº“**
```java
@PostPersist
public void afterSave() {
    // âŒ ä¸è¦åœ¨è¿™é‡ŒæŸ¥è¯¢æˆ–ä¿å­˜å…¶ä»–å®ä½“
    // userRepository.save(otherUser);  // å¯èƒ½å¯¼è‡´æ­»é”
    
    // âœ… å¯ä»¥å‘é€äº‹ä»¶ï¼Œè®©å…¶ä»–åœ°æ–¹å¤„ç†
    // applicationEventPublisher.publish(new UserCreatedEvent(this));
}
```

**âŒ DON'T - é¿å…åšæ³•**

**1. é¿å…å¾ªç¯å¼•ç”¨**
```java
@Entity
public class User {
    @PreUpdate
    public void beforeUpdate() {
        // âŒ åƒä¸‡ä¸è¦å†æ¬¡è°ƒç”¨save
        userRepository.save(this);  // æ— é™å¾ªç¯ï¼
    }
}
```

**2. é¿å…æŠ›å‡ºæœªå¤„ç†çš„å¼‚å¸¸**
```java
@PrePersist
public void beforeSave() {
    // âŒ ä¸è¦éšæ„æŠ›å¼‚å¸¸
    if (this.name == null) {
        throw new RuntimeException("åç§°ä¸èƒ½ä¸ºç©º");  // ä¼šä¸­æ–­ä¿å­˜
    }
    
    // âœ… åº”è¯¥åœ¨Serviceå±‚éªŒè¯
}
```

**3. é¿å…ä¾èµ–äº‹åŠ¡ä¸Šä¸‹æ–‡**
```java
@PostPersist
public void afterSave() {
    // âŒ æ­¤æ—¶äº‹åŠ¡å¯èƒ½è¿˜æœªæäº¤
    // sendEmail();  // é‚®ä»¶å‘é€åäº‹åŠ¡å›æ»šï¼Œæ•°æ®ä¸ä¸€è‡´
    
    // âœ… åº”è¯¥åœ¨äº‹åŠ¡æäº¤åå‘é€
    // TransactionSynchronizationManager.registerSynchronization(...)
}
```

### 6.2 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**ğŸ” é—®é¢˜1ï¼šç›‘å¬å™¨ä¸ç”Ÿæ•ˆ**

```java
// åŸå› ï¼šå¿˜è®°åŠ @EntityListenersæ³¨è§£
@Entity  // âŒ æ²¡æœ‰æŒ‡å®šç›‘å¬å™¨
public class User {
    @PrePersist
    public void onCreate() {
        // è¿™ä¸ªæ–¹æ³•ä¸ä¼šæ‰§è¡Œï¼
    }
}

// è§£å†³ï¼šæ·»åŠ æ³¨è§£
@Entity
@EntityListeners(AuditingEntityListener.class)  // âœ… æŒ‡å®šç›‘å¬å™¨
public class User {
    @CreatedDate
    private LocalDateTime createdAt;
}
```

**ğŸ” é—®é¢˜2ï¼š@CreatedDateç­‰æ³¨è§£ä¸ç”Ÿæ•ˆ**

```java
// åŸå› ï¼šæ²¡æœ‰å¯ç”¨å®¡è®¡åŠŸèƒ½
@SpringBootApplication
// âŒ å¿˜è®°åŠ @EnableJpaAuditing
public class Application {
}

// è§£å†³ï¼šå¯ç”¨å®¡è®¡
@SpringBootApplication
@EnableJpaAuditing  // âœ… å¼€å¯JPAå®¡è®¡
public class Application {
}
```

**ğŸ” é—®é¢˜3ï¼šè·å–ä¸åˆ°å½“å‰ç”¨æˆ·**

```java
// åŸå› ï¼šAuditorAwareæ²¡æœ‰æ­£ç¡®å®ç°
@Bean
public AuditorAware<String> auditorProvider() {
    return () -> Optional.of("admin");  // âŒ å†™æ­»äº†
}

// è§£å†³ï¼šä»Securityè·å–
@Bean
public AuditorAware<String> auditorProvider() {
    return () -> {
        Authentication auth = SecurityContextHolder.getContext()
                                .getAuthentication();
        if (auth != null && auth.isAuthenticated()) {
            return Optional.of(auth.getName());
        }
        return Optional.of("system");
    };
}
```

### 6.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**âš¡ ä¼˜åŒ–å»ºè®®**

**1. æ‰¹é‡æ“ä½œé¿å…è§¦å‘å¤ªå¤šç›‘å¬å™¨**
```java
// âŒ æ•ˆç‡ä½ï¼šæ¯æ¡è®°å½•è§¦å‘ç›‘å¬å™¨
for (User user : users) {
    userRepository.save(user);  // Næ¬¡ç›‘å¬å™¨æ‰§è¡Œ
}

// âœ… æ›´å¥½ï¼šæ‰¹é‡ä¿å­˜
userRepository.saveAll(users);  // ä½†è¿˜æ˜¯ä¼šè§¦å‘Næ¬¡

// âœ… æœ€ä¼˜ï¼šéœ€è¦æ—¶ç¦ç”¨å®¡è®¡
@Modifying
@Query("UPDATE User u SET u.status = :status WHERE u.id IN :ids")
void batchUpdateStatus(List<Long> ids, String status);  // ä¸è§¦å‘ç›‘å¬å™¨
```

**2. å®¡è®¡è¡¨å®šæœŸå½’æ¡£**
```java
// å®šæœŸæ¸…ç†å†å²æ•°æ®
@Scheduled(cron = "0 0 2 * * ?")  // æ¯å¤©å‡Œæ™¨2ç‚¹
public void archiveAuditData() {
    // å°†1å¹´å‰çš„å®¡è®¡æ•°æ®å½’æ¡£åˆ°å†å²åº“
    LocalDateTime oneYearAgo = LocalDateTime.now().minusYears(1);
    // å½’æ¡£é€»è¾‘...
}
```

**ğŸ“Š æ€§èƒ½å¯¹æ¯”**

| åœºæ™¯ | æ— ç›‘å¬å™¨ | ç®€å•ç›‘å¬å™¨ | å¤æ‚ç›‘å¬å™¨ | Enverså®¡è®¡ |
|-----|---------|----------|----------|-----------|
| å•æ¡ä¿å­˜ | 1ms | 1-2ms | 5-10ms | 3-5ms |
| æ‰¹é‡ä¿å­˜(100æ¡) | 100ms | 120ms | 500ms+ | 200ms |
| å­˜å‚¨ç©ºé—´ | 1Ã— | 1Ã— | 1Ã— | 2-3Ã— |

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ ä¸ƒå¤§ç”Ÿå‘½å‘¨æœŸæ³¨è§£**
```
ä¿å­˜ï¼š@PrePersistï¼ˆä¿å­˜å‰ï¼‰ â†’ @PostPersistï¼ˆä¿å­˜åï¼‰
æ›´æ–°ï¼š@PreUpdateï¼ˆæ›´æ–°å‰ï¼‰  â†’ @PostUpdateï¼ˆæ›´æ–°åï¼‰
åˆ é™¤ï¼š@PreRemoveï¼ˆåˆ é™¤å‰ï¼‰  â†’ @PostRemoveï¼ˆåˆ é™¤åï¼‰
æŸ¥è¯¢ï¼š@PostLoadï¼ˆåŠ è½½åï¼‰
```

**ğŸ”¸ å®ç°æ–¹å¼é€‰æ‹©**
```
ç®€å•åœºæ™¯   â†’ å®ä½“å†…éƒ¨æ–¹æ³•
å¤šå®ä½“å¤ç”¨ â†’ ç‹¬ç«‹ç›‘å¬å™¨ç±»  â­æ¨è
å…¨å±€é€šç”¨   â†’ é»˜è®¤ç›‘å¬å™¨é…ç½®
```

**ğŸ”¸ å®¡è®¡åŠŸèƒ½å®ç°**
```
æ‰‹åŠ¨å®ç°   â†’ è‡ªå®šä¹‰ç›‘å¬å™¨ + å®¡è®¡åŸºç±»
Springæ–¹å¼ â†’ @EnableJpaAuditing + @CreatedDateç­‰æ³¨è§£  â­æ¨è
å†å²ç‰ˆæœ¬   â†’ Hibernate Envers + @Auditedæ³¨è§£
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ’¡ ç›‘å¬å™¨çš„æœ¬è´¨**
> ç›‘å¬å™¨å°±æ˜¯åœ¨æ•°æ®ç”Ÿå‘½å‘¨æœŸçš„å…³é”®èŠ‚ç‚¹è‡ªåŠ¨æ‰§è¡Œçš„"é’©å­å‡½æ•°"ï¼Œè®©ä½ ä¸ç”¨æ‰‹åŠ¨è°ƒç”¨å°±èƒ½å®ç°å®¡è®¡ã€éªŒè¯ã€é€šçŸ¥ç­‰åŠŸèƒ½ã€‚

**ğŸ’¡ Preå’ŒPostçš„åŒºåˆ«**
> - **Pre**ï¼ˆå‰ç½®ï¼‰ï¼šå¯ä»¥ä¿®æ”¹æ•°æ®ï¼Œå¯ä»¥é˜»æ­¢æ“ä½œï¼ˆæŠ›å¼‚å¸¸ï¼‰
> - **Post**ï¼ˆåç½®ï¼‰ï¼šæ•°æ®å·²æäº¤ï¼Œåªèƒ½åšåç»­å¤„ç†

**ğŸ’¡ å®¡è®¡åŠŸèƒ½çš„ä»·å€¼**
> - **è¿½æº¯æ€§**ï¼šçŸ¥é“æ•°æ®ä½•æ—¶ã€è¢«è°ã€å¦‚ä½•ä¿®æ”¹çš„
> - **åˆè§„æ€§**ï¼šæ»¡è¶³å®¡è®¡è¦æ±‚ï¼ˆé‡‘èã€åŒ»ç–—ç­‰è¡Œä¸šï¼‰
> - **å®‰å…¨æ€§**ï¼šå‘ç°å¼‚å¸¸æ“ä½œï¼Œè¿½è¸ªæ•°æ®æ³„éœ²

### 7.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ¯ åœºæ™¯ä¸€ï¼šç”¨æˆ·æ³¨å†Œè‡ªåŠ¨è®°å½•**
```java
@Entity
@EntityListeners(AuditingEntityListener.class)
public class User {
    @CreatedDate
    private LocalDateTime registeredAt;  // è‡ªåŠ¨è®°å½•æ³¨å†Œæ—¶é—´
    
    @PostPersist
    public void afterRegister() {
        // å‘é€æ¬¢è¿é‚®ä»¶
    }
}
```

**ğŸ¯ åœºæ™¯äºŒï¼šå•†å“ä»·æ ¼å˜æ›´å®¡è®¡**
```java
@Entity
@Audited  // ä½¿ç”¨Enversè®°å½•æ‰€æœ‰ä»·æ ¼å˜æ›´å†å²
public class Product {
    private BigDecimal price;
    
    @PreUpdate
    public void beforePriceChange() {
        // ä»·æ ¼å˜åŠ¨éœ€è¦å®¡æ‰¹
        if (needsApproval()) {
            throw new PriceChangeException("ä»·æ ¼å˜æ›´éœ€è¦å®¡æ‰¹");
        }
    }
}
```

**ğŸ¯ åœºæ™¯ä¸‰ï¼šè®¢å•çŠ¶æ€å˜æ›´é€šçŸ¥**
```java
@Entity
public class Order {
    private OrderStatus status;
    
    @PostUpdate
    public void afterStatusChange() {
        // è®¢å•çŠ¶æ€å˜æ›´å‘é€çŸ­ä¿¡é€šçŸ¥
        if (status == OrderStatus.SHIPPED) {
            smsService.sendShippingNotice(this);
        }
    }
}
```

### 7.4 å­¦ä¹ æ£€æŸ¥æ¸…å•


**ğŸ“ åŸºç¡€æŒæ¡**
- [ ] ç†è§£ä¸ƒå¤§ç”Ÿå‘½å‘¨æœŸæ³¨è§£çš„è§¦å‘æ—¶æœº
- [ ] æŒæ¡å®ä½“å†…éƒ¨æ–¹æ³•å®ç°ç›‘å¬å™¨
- [ ] ä¼šä½¿ç”¨ç‹¬ç«‹ç›‘å¬å™¨ç±»
- [ ] ç†è§£Preå’ŒPostçš„åŒºåˆ«

**ğŸ“ è¿›é˜¶æŒæ¡**  
- [ ] ä½¿ç”¨Springå®¡è®¡æ³¨è§£è‡ªåŠ¨å¡«å……æ—¶é—´
- [ ] å®ç°AuditorAwareè·å–å½“å‰ç”¨æˆ·
- [ ] åˆ›å»ºå®¡è®¡åŸºç±»ä¾›å¤šå®ä½“ç»§æ‰¿
- [ ] ç†è§£ç›‘å¬å™¨çš„æ‰§è¡Œé¡ºåº

**ğŸ“ é«˜çº§æŒæ¡**
- [ ] ä½¿ç”¨Enverså®ç°å†å²ç‰ˆæœ¬å®¡è®¡
- [ ] æŸ¥è¯¢å’Œæ¢å¤å†å²æ•°æ®
- [ ] è§£å†³ç›‘å¬å™¨æ€§èƒ½é—®é¢˜
- [ ] å®ç°å¤æ‚çš„å®¡è®¡éœ€æ±‚

### 7.5 è®°å¿†å£è¯€


**ğŸ¯ ç”Ÿå‘½å‘¨æœŸè®°å¿†**
```
ä¿å­˜å‰åPreå’ŒPost
æ›´æ–°åˆ é™¤éƒ½æˆåŒ
æŸ¥è¯¢åªæœ‰Postä¸€ä¸ª
LoadåŠ è½½è«å¿˜æ‰
```

**ğŸ¯ å®¡è®¡åŠŸèƒ½è®°å¿†**
```
åˆ›å»ºæ—¶é—´CreatedDate
ä¿®æ”¹æ—¶é—´LastModified
è°æ”¹çš„ç”¨AuditorAware
å†å²ç‰ˆæœ¬æ‰¾Envers
```

**ğŸ¯ æœ€ä½³å®è·µè®°å¿†**
```
ç›‘å¬å™¨è¦ç®€å•è½»
ä¸è¦æ“ä½œåº“äº‹åŠ¡
æ‰¹é‡æ“ä½œè¦æ³¨æ„
å®šæœŸå½’æ¡£ä¿æ€§èƒ½
```

---

**æ ¸å¿ƒæ€»ç»“**ï¼šå®ä½“ç›‘å¬å™¨æ˜¯JPAæä¾›çš„å¼ºå¤§åŠŸèƒ½ï¼Œé€šè¿‡åœ¨æ•°æ®ç”Ÿå‘½å‘¨æœŸçš„å…³é”®èŠ‚ç‚¹è‡ªåŠ¨æ‰§è¡Œä»£ç ï¼Œå¯ä»¥è½»æ¾å®ç°å®¡è®¡ã€éªŒè¯ã€é€šçŸ¥ç­‰éœ€æ±‚ã€‚æŒæ¡å¥½ç›‘å¬å™¨ï¼Œä½ çš„ä»£ç ä¼šæ›´åŠ ä¼˜é›…å’Œè‡ªåŠ¨åŒ–ï¼