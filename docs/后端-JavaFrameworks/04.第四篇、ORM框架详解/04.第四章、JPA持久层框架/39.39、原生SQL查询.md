---
title: 39ã€åŸç”ŸSQLæŸ¥è¯¢
---
## ğŸ“š ç›®å½•

1. [åŸç”ŸSQLæŸ¥è¯¢æ¦‚è¿°](#1-åŸç”ŸSQLæŸ¥è¯¢æ¦‚è¿°)
2. [createNativeQueryåŸºç¡€ç”¨æ³•](#2-createNativeQueryåŸºç¡€ç”¨æ³•)
3. [å‚æ•°ç»‘å®šä¸ç»“æœå¤„ç†](#3-å‚æ•°ç»‘å®šä¸ç»“æœå¤„ç†)
4. [å‘½ååŸç”ŸæŸ¥è¯¢](#4-å‘½ååŸç”ŸæŸ¥è¯¢)
5. [ä½¿ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ](#5-ä½¿ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” åŸç”ŸSQLæŸ¥è¯¢æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯åŸç”ŸSQLæŸ¥è¯¢


**ğŸ”¸ ç®€å•ç†è§£**
```
åŸç”ŸSQL = ç›´æ¥å†™æ•°æ®åº“SQLè¯­å¥

å°±åƒä½ å¹³æ—¶åœ¨æ•°æ®åº“å·¥å…·é‡Œå†™SQLä¸€æ ·ï¼š
SELECT * FROM user WHERE age > 18

JPAçš„åŸç”ŸSQLæŸ¥è¯¢å°±æ˜¯è®©ä½ åœ¨Javaä»£ç é‡Œä¹Ÿèƒ½è¿™æ ·å†™
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦åŸç”ŸSQLï¼Ÿ**

è™½ç„¶JPAæä¾›äº†JPQLï¼ˆé¢å‘å¯¹è±¡çš„æŸ¥è¯¢è¯­è¨€ï¼‰ï¼Œä½†æœ‰äº›æƒ…å†µå¿…é¡»ç”¨åŸç”ŸSQLï¼š

```
ä½¿ç”¨åœºæ™¯å¯¹æ¯”ï¼š

JPQLå¤Ÿç”¨çš„æƒ…å†µï¼š
âœ… ç®€å•çš„å¢åˆ æ”¹æŸ¥
âœ… åŸºæœ¬çš„æ¡ä»¶æŸ¥è¯¢
âœ… è·¨æ•°æ®åº“çš„é€šç”¨æŸ¥è¯¢

å¿…é¡»ç”¨åŸç”ŸSQLçš„æƒ…å†µï¼š
ğŸ”¸ ä½¿ç”¨æ•°æ®åº“ç‰¹å®šå‡½æ•°ï¼ˆMySQLçš„GROUP_CONCATï¼‰
ğŸ”¸ å¤æ‚çš„ç»Ÿè®¡åˆ†ææŸ¥è¯¢
ğŸ”¸ éœ€è¦æ€§èƒ½ä¼˜åŒ–çš„å¤æ‚SQL
ğŸ”¸ è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
ğŸ”¸ ä½¿ç”¨æ•°æ®åº“ç‰¹æœ‰è¯­æ³•
```

### 1.2 åŸç”ŸSQL vs JPQLå¯¹æ¯”


**æ ¸å¿ƒåŒºåˆ«ç†è§£ï¼š**

| å¯¹æ¯”ç»´åº¦ | **JPQLæŸ¥è¯¢** | **åŸç”ŸSQLæŸ¥è¯¢** |
|---------|------------|---------------|
| ğŸ“ **å†™æ³•** | `é¢å‘å®ä½“ç±»å’Œå±æ€§` | `é¢å‘æ•°æ®åº“è¡¨å’Œå­—æ®µ` |
| ğŸ”„ **ç§»æ¤æ€§** | `è·¨æ•°æ®åº“é€šç”¨` | `ä¾èµ–å…·ä½“æ•°æ®åº“` |
| âš¡ **æ€§èƒ½** | `è‡ªåŠ¨ä¼˜åŒ–ï¼Œå¯èƒ½ä¸æ˜¯æœ€ä¼˜` | `æ‰‹åŠ¨ä¼˜åŒ–ï¼Œå¯ä»¥è¾¾åˆ°æœ€ä½³` |
| ğŸ¯ **é€‚ç”¨åœºæ™¯** | `æ—¥å¸¸ä¸šåŠ¡æŸ¥è¯¢` | `å¤æ‚æŸ¥è¯¢ã€æ€§èƒ½ä¼˜åŒ–` |

**å®é™…ä¾‹å­å¯¹æ¯”ï¼š**

```java
// JPQLæ–¹å¼ï¼šé¢å‘å¯¹è±¡
String jpql = "SELECT u FROM User u WHERE u.age > 18";

// åŸç”ŸSQLæ–¹å¼ï¼šç›´æ¥å†™SQL
String sql = "SELECT * FROM t_user WHERE age > 18";
```

---

## 2. ğŸ“‹ createNativeQueryåŸºç¡€ç”¨æ³•


### 2.1 æœ€ç®€å•çš„åŸç”ŸæŸ¥è¯¢


**ğŸ”¸ åŸºç¡€è¯­æ³•**

```java
// åˆ›å»ºåŸç”ŸSQLæŸ¥è¯¢çš„ä¸‰è¦ç´ ï¼š
// 1. EntityManagerå¯¹è±¡
// 2. createNativeQuery()æ–¹æ³•
// 3. SQLè¯­å¥å­—ç¬¦ä¸²

Query query = entityManager.createNativeQuery(
    "SELECT * FROM t_user"  // ç›´æ¥å†™SQL
);
```

**ğŸ’¡ å®Œæ•´ç¤ºä¾‹ï¼šæŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·**

```java
@Service
public class UserService {
    
    @PersistenceContext
    private EntityManager em;
    
    public List<Object[]> findAllUsers() {
        // 1. å†™SQLè¯­å¥ï¼ˆå’Œåœ¨æ•°æ®åº“å·¥å…·é‡Œå†™çš„ä¸€æ¨¡ä¸€æ ·ï¼‰
        String sql = "SELECT * FROM t_user";
        
        // 2. åˆ›å»ºåŸç”ŸæŸ¥è¯¢
        Query query = em.createNativeQuery(sql);
        
        // 3. æ‰§è¡ŒæŸ¥è¯¢ï¼Œè¿”å›ç»“æœ
        List<Object[]> results = query.getResultList();
        
        // æ³¨æ„ï¼šç»“æœæ˜¯Object[]æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€åˆ—
        return results;
    }
}
```

**ğŸ¤” ä¸ºä»€ä¹ˆè¿”å›Object[]ï¼Ÿ**

```
åŸç”ŸSQLç›´æ¥æ“ä½œæ•°æ®åº“ï¼ŒJPAä¸çŸ¥é“è¿”å›ä»€ä¹ˆç±»å‹
æ‰€ä»¥ç”¨Object[]æ•°ç»„æ¥è£…ç»“æœï¼š

ç»“æœç¤ºä¾‹ï¼š
[1, "å¼ ä¸‰", 25]  // ç¬¬ä¸€è¡Œ
[2, "æå››", 30]  // ç¬¬äºŒè¡Œ

Object[0] = idå€¼
Object[1] = nameå€¼  
Object[2] = ageå€¼
```

### 2.2 æ˜ å°„åˆ°å®ä½“ç±»


**ğŸ”¸ è¿”å›å®ä½“å¯¹è±¡çš„å†™æ³•**

```java
// æ–¹å¼1ï¼šæŒ‡å®šå®ä½“ç±».class
Query query = em.createNativeQuery(
    "SELECT * FROM t_user",
    User.class  // å‘Šè¯‰JPAè¦æ˜ å°„æˆUserå¯¹è±¡
);

List<User> users = query.getResultList();  // ç›´æ¥å¾—åˆ°Userå¯¹è±¡åˆ—è¡¨
```

**ğŸ’¡ å®Œæ•´ç¤ºä¾‹ï¼š**

```java
public List<User> findActiveUsers() {
    String sql = "SELECT * FROM t_user WHERE status = 1";
    
    // ç›´æ¥æ˜ å°„åˆ°Userå®ä½“
    Query query = em.createNativeQuery(sql, User.class);
    
    return query.getResultList();  // è¿”å›List<User>
}
```

**âš ï¸ æ³¨æ„äº‹é¡¹ï¼š**

```
æ˜ å°„åˆ°å®ä½“ç±»çš„è¦æ±‚ï¼š
âœ… SQLæŸ¥è¯¢çš„åˆ—åå¿…é¡»å’Œå®ä½“å±æ€§å¯¹åº”
âœ… æœ€å¥½ç”¨SELECT *æˆ–è€…æŸ¥è¯¢æ‰€æœ‰å¿…è¦å­—æ®µ
âœ… å­—æ®µåè¦å’Œ@Columnæ³¨è§£ä¸€è‡´

ä¸åŒ¹é…ä¼šæ€æ ·ï¼Ÿ
âŒ åˆ—åå¯¹ä¸ä¸Š â†’ æ˜ å°„å¤±è´¥
âŒ ç¼ºå°‘å¿…è¦å­—æ®µ â†’ å®ä½“å±æ€§ä¸ºnull
```

### 2.3 éƒ¨åˆ†å­—æ®µæŸ¥è¯¢


**ğŸ”¸ åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ**

```java
// åªæŸ¥è¯¢nameå’Œageä¸¤ä¸ªå­—æ®µ
String sql = "SELECT name, age FROM t_user WHERE age > 18";

Query query = em.createNativeQuery(sql);
List<Object[]> results = query.getResultList();

// ç»“æœå¤„ç†
for (Object[] row : results) {
    String name = (String) row[0];   // ç¬¬ä¸€ä¸ªå­—æ®µ
    Integer age = (Integer) row[1];  // ç¬¬äºŒä¸ªå­—æ®µ
    
    System.out.println(name + " - " + age + "å²");
}
```

---

## 3. ğŸ”§ å‚æ•°ç»‘å®šä¸ç»“æœå¤„ç†


### 3.1 ä½ç½®å‚æ•°ç»‘å®š


**ğŸ”¸ åŸºç¡€ç”¨æ³•**

```java
// SQLä¸­ç”¨ ?1, ?2 è¡¨ç¤ºå‚æ•°ä½ç½®
String sql = "SELECT * FROM t_user WHERE age > ?1 AND city = ?2";

Query query = em.createNativeQuery(sql, User.class);

// æŒ‰ä½ç½®è®¾ç½®å‚æ•°ï¼ˆä»1å¼€å§‹ï¼‰
query.setParameter(1, 18);        // ?1çš„å€¼
query.setParameter(2, "åŒ—äº¬");     // ?2çš„å€¼

List<User> users = query.getResultList();
```

**ğŸ’¡ å®é™…åº”ç”¨ç¤ºä¾‹ï¼š**

```java
public List<User> searchUsers(Integer minAge, String city) {
    String sql = """
        SELECT * FROM t_user 
        WHERE age >= ?1 
        AND city = ?2 
        AND status = 1
        """;
    
    return em.createNativeQuery(sql, User.class)
             .setParameter(1, minAge)    // æœ€å°å¹´é¾„
             .setParameter(2, city)      // åŸå¸‚
             .getResultList();
}
```

### 3.2 å‘½åå‚æ•°ç»‘å®š


**ğŸ”¸ æ›´æ˜“è¯»çš„å‚æ•°æ–¹å¼**

```java
// SQLä¸­ç”¨ :å‚æ•°å çš„å½¢å¼
String sql = """
    SELECT * FROM t_user 
    WHERE age > :minAge 
    AND city = :city
    """;

Query query = em.createNativeQuery(sql, User.class);

// æŒ‰åç§°è®¾ç½®å‚æ•°ï¼ˆæ›´æ¸…æ™°ï¼‰
query.setParameter("minAge", 18);
query.setParameter("city", "åŒ—äº¬");

List<User> users = query.getResultList();
```

**ğŸ¯ æ¨èä½¿ç”¨å‘½åå‚æ•°ï¼š**

```
ä¼˜åŠ¿å¯¹æ¯”ï¼š

ä½ç½®å‚æ•° ?1, ?2ï¼š
âŒ å‚æ•°å¤šäº†å®¹æ˜“ææ··
âŒ SQLæ”¹åŠ¨åå®¹æ˜“å‡ºé”™
âœ… å†™èµ·æ¥ç®€å•

å‘½åå‚æ•° :nameï¼š
âœ… è§åçŸ¥æ„ï¼Œä¸ä¼šæé”™
âœ… SQLæ”¹åŠ¨ä¸å½±å“å‚æ•°
âœ… ä»£ç æ›´æ˜“ç»´æŠ¤
```

### 3.3 ç»“æœé›†å¤„ç†æ–¹å¼


**ğŸ”¸ æ–¹å¼1ï¼šç›´æ¥ä½¿ç”¨Object[]**

```java
List<Object[]> results = query.getResultList();

for (Object[] row : results) {
    Long id = ((Number) row[0]).longValue();
    String name = (String) row[1];
    Integer age = (Integer) row[2];
    
    System.out.printf("ID:%d, å§“å:%s, å¹´é¾„:%d%n", id, name, age);
}
```

**ğŸ”¸ æ–¹å¼2ï¼šè½¬æ¢ä¸ºDTOå¯¹è±¡**

```java
// 1. å®šä¹‰DTOç±»
public class UserDTO {
    private String name;
    private Integer age;
    private String city;
    
    // æ„é€ å™¨ã€getterã€setter
}

// 2. æŸ¥è¯¢å¹¶æ‰‹åŠ¨è½¬æ¢
String sql = "SELECT name, age, city FROM t_user";
List<Object[]> results = em.createNativeQuery(sql).getResultList();

List<UserDTO> dtos = results.stream()
    .map(row -> new UserDTO(
        (String) row[0],   // name
        (Integer) row[1],  // age  
        (String) row[2]    // city
    ))
    .collect(Collectors.toList());
```

**ğŸ”¸ æ–¹å¼3ï¼šä½¿ç”¨ç»“æœé›†æ˜ å°„ï¼ˆæ¨èï¼‰**

```java
// åœ¨å®ä½“ç±»ä¸Šå®šä¹‰ç»“æœæ˜ å°„
@SqlResultSetMapping(
    name = "UserDTOMapping",
    classes = @ConstructorResult(
        targetClass = UserDTO.class,
        columns = {
            @ColumnResult(name = "name", type = String.class),
            @ColumnResult(name = "age", type = Integer.class),
            @ColumnResult(name = "city", type = String.class)
        }
    )
)
@Entity
public class User { ... }

// ä½¿ç”¨ç»“æœæ˜ å°„
Query query = em.createNativeQuery(
    "SELECT name, age, city FROM t_user",
    "UserDTOMapping"  // å¼•ç”¨æ˜ å°„åç§°
);

List<UserDTO> dtos = query.getResultList();
```

---

## 4. ğŸ“Œ å‘½ååŸç”ŸæŸ¥è¯¢


### 4.1 ä»€ä¹ˆæ˜¯å‘½ååŸç”ŸæŸ¥è¯¢


**ğŸ”¸ ç®€å•ç†è§£**

```
å‘½ååŸç”ŸæŸ¥è¯¢ = ç»™SQLèµ·ä¸ªåå­—ï¼Œæ–¹ä¾¿é‡å¤ä½¿ç”¨

å°±åƒæŠŠå¸¸ç”¨çš„SQLä¿å­˜æˆ"å¿«æ·æ–¹å¼"ï¼š
- å®šä¹‰ä¸€æ¬¡ï¼Œåˆ°å¤„ä½¿ç”¨
- ç»Ÿä¸€ç®¡ç†ï¼Œæ–¹ä¾¿ç»´æŠ¤
- é¿å…SQLå­—ç¬¦ä¸²æ•£è½åœ¨ä»£ç å„å¤„
```

**ğŸ’¡ å®šä¹‰æ–¹å¼**

```java
@Entity
@NamedNativeQuery(
    name = "User.findByCity",           // æŸ¥è¯¢çš„åå­—
    query = "SELECT * FROM t_user WHERE city = :city",  // SQLè¯­å¥
    resultClass = User.class            // è¿”å›ç±»å‹
)
public class User {
    // å®ä½“ç±»å®šä¹‰...
}
```

### 4.2 ä½¿ç”¨å‘½ååŸç”ŸæŸ¥è¯¢


**ğŸ”¸ åŸºç¡€è°ƒç”¨**

```java
@Service
public class UserService {
    
    @PersistenceContext
    private EntityManager em;
    
    public List<User> findUsersByCity(String city) {
        // 1. é€šè¿‡åå­—åˆ›å»ºæŸ¥è¯¢
        Query query = em.createNamedQuery("User.findByCity");
        
        // 2. è®¾ç½®å‚æ•°
        query.setParameter("city", city);
        
        // 3. æ‰§è¡ŒæŸ¥è¯¢
        return query.getResultList();
    }
}
```

### 4.3 å®šä¹‰å¤šä¸ªå‘½åæŸ¥è¯¢


**ğŸ”¸ ä½¿ç”¨@NamedNativeQueries**

```java
@Entity
@NamedNativeQueries({
    @NamedNativeQuery(
        name = "User.findByCity",
        query = "SELECT * FROM t_user WHERE city = :city",
        resultClass = User.class
    ),
    @NamedNativeQuery(
        name = "User.findByAgeRange",
        query = """
            SELECT * FROM t_user 
            WHERE age BETWEEN :minAge AND :maxAge
            ORDER BY age
            """,
        resultClass = User.class
    ),
    @NamedNativeQuery(
        name = "User.countByStatus",
        query = "SELECT COUNT(*) FROM t_user WHERE status = :status"
    )
})
public class User {
    // å®ä½“å®šä¹‰...
}
```

**ğŸ’¡ å®é™…åº”ç”¨ï¼š**

```java
// æŒ‰åŸå¸‚æŸ¥è¯¢
List<User> users1 = em.createNamedQuery("User.findByCity")
    .setParameter("city", "åŒ—äº¬")
    .getResultList();

// æŒ‰å¹´é¾„èŒƒå›´æŸ¥è¯¢
List<User> users2 = em.createNamedQuery("User.findByAgeRange")
    .setParameter("minAge", 20)
    .setParameter("maxAge", 30)
    .getResultList();

// ç»Ÿè®¡æŸ¥è¯¢
Long count = (Long) em.createNamedQuery("User.countByStatus")
    .setParameter("status", 1)
    .getSingleResult();
```

### 4.4 å‘½åæŸ¥è¯¢çš„ä¼˜åŠ¿


```
ä¸ºä»€ä¹ˆä½¿ç”¨å‘½åæŸ¥è¯¢ï¼Ÿ

âœ… é›†ä¸­ç®¡ç†ï¼š
   æ‰€æœ‰SQLéƒ½åœ¨å®ä½“ç±»ä¸Šï¼Œæ–¹ä¾¿æŸ¥æ‰¾å’Œç»´æŠ¤

âœ… é‡å¤ä½¿ç”¨ï¼š
   å®šä¹‰ä¸€æ¬¡ï¼Œå¤šå¤„è°ƒç”¨ï¼Œé¿å…é‡å¤ä»£ç 

âœ… å¯åŠ¨æ£€æŸ¥ï¼š
   åº”ç”¨å¯åŠ¨æ—¶JPAä¼šéªŒè¯SQLè¯­æ³•ï¼ŒåŠæ—©å‘ç°é”™è¯¯

âœ… ä»£ç æ•´æ´ï¼š
   ä¸šåŠ¡ä»£ç é‡Œåªæœ‰æŸ¥è¯¢åç§°ï¼Œä¸ç”¨å†™é•¿é•¿çš„SQLå­—ç¬¦ä¸²

âŒ ä¸å¤Ÿçµæ´»ï¼š
   SQLå›ºå®šäº†ï¼Œä¸èƒ½åŠ¨æ€æ‹¼æ¥
   é€‚åˆå›ºå®šçš„å¸¸ç”¨æŸ¥è¯¢ï¼Œä¸é€‚åˆåŠ¨æ€æŸ¥è¯¢
```

---

## 5. ğŸ¯ ä½¿ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ


### 5.1 ä½•æ—¶ä½¿ç”¨åŸç”ŸSQL


**ğŸ”¸ å¿…é¡»ä½¿ç”¨çš„åœºæ™¯**

```
åœºæ™¯1ï¼šæ•°æ®åº“ç‰¹å®šåŠŸèƒ½
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MySQLç‰¹æœ‰å‡½æ•°ï¼š                      â”‚
â”‚ â€¢ GROUP_CONCAT() åˆ†ç»„è¿æ¥            â”‚
â”‚ â€¢ JSON_EXTRACT() JSONè§£æ            â”‚
â”‚ â€¢ MATCH AGAINST å…¨æ–‡æ£€ç´¢             â”‚
â”‚                                     â”‚
â”‚ PostgreSQLç‰¹æœ‰ï¼š                     â”‚
â”‚ â€¢ ARRAYç±»å‹æ“ä½œ                      â”‚
â”‚ â€¢ JSONBæŸ¥è¯¢                          â”‚
â”‚ â€¢ çª—å£å‡½æ•°                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```java
// ç¤ºä¾‹ï¼šä½¿ç”¨MySQLçš„GROUP_CONCAT
String sql = """
    SELECT 
        department,
        GROUP_CONCAT(name ORDER BY name) as names
    FROM t_user
    GROUP BY department
    """;

List<Object[]> results = em.createNativeQuery(sql).getResultList();
```

**ğŸ”¸ æ€§èƒ½ä¼˜åŒ–åœºæ™¯**

```
åœºæ™¯2ï¼šå¤æ‚æŸ¥è¯¢ä¼˜åŒ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éœ€è¦æ‰‹åŠ¨ä¼˜åŒ–çš„æƒ…å†µï¼š                 â”‚
â”‚ â€¢ å¤šè¡¨å…³è”æŸ¥è¯¢ï¼ˆ5ä¸ªè¡¨ä»¥ä¸Šï¼‰          â”‚
â”‚ â€¢ å¤§æ•°æ®é‡ç»Ÿè®¡åˆ†æ                   â”‚
â”‚ â€¢ éœ€è¦ä½¿ç”¨ç‰¹å®šç´¢å¼•                   â”‚
â”‚ â€¢ å¤æ‚çš„å­æŸ¥è¯¢åµŒå¥—                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```java
// ç¤ºä¾‹ï¼šä½¿ç”¨ç´¢å¼•æç¤ºä¼˜åŒ–æŸ¥è¯¢
String sql = """
    SELECT /*+ INDEX(t_user idx_city_age) */ 
           * 
    FROM t_user 
    WHERE city = :city AND age > :age
    """;
```

**ğŸ”¸ é—ç•™ç³»ç»Ÿé›†æˆ**

```
åœºæ™¯3ï¼šå¯¹æ¥å·²æœ‰SQL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®é™…å·¥ä½œåœºæ™¯ï¼š                       â”‚
â”‚ â€¢ å·²æœ‰æˆç†Ÿçš„å­˜å‚¨è¿‡ç¨‹                 â”‚
â”‚ â€¢ DBAæä¾›çš„ä¼˜åŒ–SQL                   â”‚
â”‚ â€¢ æŠ¥è¡¨ç³»ç»Ÿçš„å¤æ‚æŸ¥è¯¢                 â”‚
â”‚ â€¢ æ•°æ®è¿ç§»è„šæœ¬                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å®é™…åº”ç”¨ç¤ºä¾‹


**ğŸ’¡ ç¤ºä¾‹1ï¼šç»Ÿè®¡åˆ†ææŸ¥è¯¢**

```java
public class ReportService {
    
    @PersistenceContext
    private EntityManager em;
    
    // æŒ‰åŸå¸‚ç»Ÿè®¡ç”¨æˆ·å¹´é¾„åˆ†å¸ƒ
    public List<Object[]> getUserAgeDistribution() {
        String sql = """
            SELECT 
                city,
                CASE 
                    WHEN age < 20 THEN '20å²ä»¥ä¸‹'
                    WHEN age BETWEEN 20 AND 30 THEN '20-30å²'
                    WHEN age BETWEEN 31 AND 40 THEN '31-40å²'
                    ELSE '40å²ä»¥ä¸Š'
                END as age_group,
                COUNT(*) as user_count
            FROM t_user
            WHERE status = 1
            GROUP BY city, age_group
            ORDER BY city, age_group
            """;
        
        return em.createNativeQuery(sql).getResultList();
    }
}
```

**ğŸ’¡ ç¤ºä¾‹2ï¼šè°ƒç”¨å­˜å‚¨è¿‡ç¨‹**

```java
// è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
public void callStoredProcedure(Long userId) {
    String sql = "CALL update_user_score(:userId)";
    
    em.createNativeQuery(sql)
      .setParameter("userId", userId)
      .executeUpdate();
}
```

**ğŸ’¡ ç¤ºä¾‹3ï¼šæ‰¹é‡æ›´æ–°æ“ä½œ**

```java
// æ‰¹é‡æ›´æ–°ç”¨æˆ·ç§¯åˆ†ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
public int batchUpdateScore(List<Long> userIds, Integer score) {
    String sql = """
        UPDATE t_user 
        SET score = score + :score,
            update_time = NOW()
        WHERE id IN (:ids)
        """;
    
    return em.createNativeQuery(sql)
             .setParameter("score", score)
             .setParameter("ids", userIds)
             .executeUpdate();
}
```

### 5.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ“‹ å¼€å‘è§„èŒƒ**

```
âœ… æ¨èåšæ³•ï¼š

1. ä¼˜å…ˆä½¿ç”¨JPQLï¼Œå¿…è¦æ—¶æ‰ç”¨åŸç”ŸSQL
   â””â”€ JPQLèƒ½åšçš„å°±åˆ«ç”¨åŸç”ŸSQL

2. å‘½åæŸ¥è¯¢ç”¨äºå¸¸ç”¨SQL
   â””â”€ å›ºå®šçš„æŸ¥è¯¢å®šä¹‰æˆå‘½åæŸ¥è¯¢

3. å‚æ•°ç»‘å®šå¿…é¡»ä½¿ç”¨å ä½ç¬¦
   â””â”€ é˜²æ­¢SQLæ³¨å…¥ï¼Œä¸è¦å­—ç¬¦ä¸²æ‹¼æ¥

4. å¤æ‚æŸ¥è¯¢å†™æ³¨é‡Šè¯´æ˜
   â””â”€ æ–¹ä¾¿åç»­ç»´æŠ¤

5. å…³é”®SQLåšæ€§èƒ½æµ‹è¯•
   â””â”€ ç¡®ä¿æŸ¥è¯¢æ•ˆç‡
```

**âš ï¸ å¸¸è§é”™è¯¯**

```
âŒ é¿å…çš„é”™è¯¯ï¼š

1. å­—ç¬¦ä¸²æ‹¼æ¥SQLï¼ˆå®‰å…¨éšæ‚£ï¼‰
   String sql = "SELECT * FROM t_user WHERE name = '" + name + "'";
   
2. ä¸æŒ‡å®šè¿”å›ç±»å‹ï¼ˆéš¾ä»¥å¤„ç†ç»“æœï¼‰
   Query query = em.createNativeQuery(sql);  // è¿”å›Object[]ä¸æ–¹ä¾¿
   
3. è¿‡åº¦ä½¿ç”¨åŸç”ŸSQLï¼ˆå¤±å»JPAä¼˜åŠ¿ï¼‰
   æ‰€æœ‰æŸ¥è¯¢éƒ½ç”¨åŸç”ŸSQL â†’ ä¸ºå•¥ä¸ç›´æ¥ç”¨JDBCï¼Ÿ
   
4. å¿½ç•¥æ•°æ®åº“å…¼å®¹æ€§
   åªè€ƒè™‘å½“å‰æ•°æ®åº“ â†’ åç»­æ¢æ•°æ®åº“å°±æƒ¨äº†
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åŸç”ŸSQLæŸ¥è¯¢ï¼šç›´æ¥å†™æ•°æ®åº“SQLï¼ŒJPAå¸®ä½ æ‰§è¡Œ
ğŸ”¸ createNativeQueryï¼šåˆ›å»ºåŸç”ŸæŸ¥è¯¢çš„æ–¹æ³•
ğŸ”¸ å‚æ•°ç»‘å®šï¼šä½ç½®å‚æ•°(?1)æˆ–å‘½åå‚æ•°(:name)
ğŸ”¸ ç»“æœæ˜ å°„ï¼šObject[]ã€å®ä½“ç±»ã€DTOä¸‰ç§æ–¹å¼
ğŸ”¸ å‘½åæŸ¥è¯¢ï¼š@NamedNativeQueryç»Ÿä¸€ç®¡ç†SQL
ğŸ”¸ ä½¿ç”¨åœºæ™¯ï¼šæ•°æ®åº“ç‰¹å®šåŠŸèƒ½ã€æ€§èƒ½ä¼˜åŒ–ã€å¤æ‚æŸ¥è¯¢
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ åŸç”ŸSQL vs JPQL çš„é€‰æ‹©**
```
é€‰æ‹©å†³ç­–æ ‘ï¼š
                æŸ¥è¯¢éœ€æ±‚
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚
    ç®€å•ä¸šåŠ¡æŸ¥è¯¢          å¤æ‚æŸ¥è¯¢/æ€§èƒ½ä¼˜åŒ–
        â”‚                     â”‚
    ç”¨JPQL               ç”¨åŸç”ŸSQL
    è·¨æ•°æ®åº“             é’ˆå¯¹æ€§ä¼˜åŒ–
```

**ğŸ”¹ å‚æ•°ç»‘å®šçš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆå¿…é¡»ç”¨å‚æ•°ç»‘å®šï¼Ÿ

å®‰å…¨æ€§ï¼š
String sql = "... WHERE name = '" + name + "'";  âŒ SQLæ³¨å…¥
String sql = "... WHERE name = :name";           âœ… å®‰å…¨

æ€§èƒ½ï¼š
å‚æ•°åŒ–æŸ¥è¯¢ â†’ æ•°æ®åº“å¯ä»¥ç¼“å­˜æ‰§è¡Œè®¡åˆ’ â†’ æ›´å¿«
```

**ğŸ”¹ ç»“æœå¤„ç†çš„ä¸‰ç§å¢ƒç•Œ**
```
Level 1ï¼šObject[] æ•°ç»„
â””â”€ ç®€å•ç›´æ¥ï¼Œä½†ç±»å‹è½¬æ¢éº»çƒ¦

Level 2ï¼šæ˜ å°„åˆ°å®ä½“ç±»  
â””â”€ æ–¹ä¾¿ä½¿ç”¨ï¼Œä½†SQLå¿…é¡»åŒ¹é…å®ä½“

Level 3ï¼šè‡ªå®šä¹‰DTO + ç»“æœæ˜ å°„
â””â”€ çµæ´»å¼ºå¤§ï¼ŒæŒ‰éœ€å®šåˆ¶
```

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä½¿ç”¨åœºæ™¯å†³ç­–è¡¨**

| åœºæ™¯ | **å»ºè®®æ–¹æ¡ˆ** | **ç†ç”±** |
|------|------------|----------|
| ğŸ“Š **ç®€å•æŸ¥è¯¢** | `JPQLæˆ–Spring Data JPA` | `ç®€å•é«˜æ•ˆï¼Œè·¨æ•°æ®åº“` |
| ğŸ”§ **æ•°æ®åº“ç‰¹å®šåŠŸèƒ½** | `åŸç”ŸSQL` | `JPQLä¸æ”¯æŒ` |
| âš¡ **æ€§èƒ½å…³é”®æŸ¥è¯¢** | `åŸç”ŸSQL + æ‰‹åŠ¨ä¼˜åŒ–` | `éœ€è¦ç²¾ç»†æ§åˆ¶` |
| ğŸ“ˆ **å¤æ‚ç»Ÿè®¡æŠ¥è¡¨** | `åŸç”ŸSQL` | `SQLæ›´ç›´è§‚` |
| ğŸ”„ **æ‰¹é‡æ“ä½œ** | `åŸç”ŸSQL + executeUpdate` | `æ•ˆç‡æ›´é«˜` |
| ğŸ’¾ **è°ƒç”¨å­˜å‚¨è¿‡ç¨‹** | `åŸç”ŸSQL` | `JPQLä¸æ”¯æŒ` |

**ğŸ’¡ å®æˆ˜ç»éªŒ**

```
ç»éªŒ1ï¼šèƒ½ç”¨JPQLå°±ç”¨JPQL
â””â”€ åŸç”ŸSQLåº”è¯¥æ˜¯"ä¸å¾—å·²"çš„é€‰æ‹©ï¼Œä¸æ˜¯é¦–é€‰

ç»éªŒ2ï¼šå‘½åæŸ¥è¯¢ç”¨äºç¨³å®šçš„SQL
â””â”€ å¸¸ç”¨çš„ã€ä¸ç»å¸¸æ”¹çš„SQLæ‰å®šä¹‰æˆå‘½åæŸ¥è¯¢

ç»éªŒ3ï¼šæ€§èƒ½æ•æ„Ÿçš„åœ°æ–¹ç”¨åŸç”ŸSQL
â””â”€ æ ¸å¿ƒä¸šåŠ¡ã€é«˜å¹¶å‘åœºæ™¯æ‰‹åŠ¨ä¼˜åŒ–SQL

ç»éªŒ4ï¼šå¤æ‚æŸ¥è¯¢è€ƒè™‘è§†å›¾
â””â”€ ç‰¹åˆ«å¤æ‚çš„SQLå¯ä»¥å»ºæ•°æ®åº“è§†å›¾ï¼Œç„¶åç”¨JPQLæŸ¥

ç»éªŒ5ï¼šè®°å¾—å†™å•å…ƒæµ‹è¯•
â””â”€ åŸç”ŸSQLå®¹æ˜“å‡ºé”™ï¼Œå¿…é¡»æµ‹è¯•å……åˆ†
```

**ğŸ”‘ è®°å¿†è¦ç‚¹**

```
æ ¸å¿ƒè®°å¿†ï¼š
1. åŸç”ŸSQL = ç›´æ¥å†™æ•°æ®åº“SQL
2. createNativeQuery()åˆ›å»ºï¼ŒsetParameter()ç»‘å®šå‚æ•°
3. ç»“æœå¯ä»¥æ˜¯Object[]ã€å®ä½“ç±»æˆ–DTO
4. @NamedNativeQueryå®šä¹‰å¯é‡ç”¨SQL
5. å¿…é¡»ç”¨æ—¶æ‰ç”¨ï¼Œä¼˜å…ˆè€ƒè™‘JPQL
```

**ğŸ“š å­¦ä¹ å»ºè®®**

```
å­¦ä¹ è·¯å¾„ï¼š
ç¬¬1æ­¥ï¼šæŒæ¡åŸºç¡€çš„createNativeQuery()ç”¨æ³•
ç¬¬2æ­¥ï¼šç†Ÿç»ƒä½¿ç”¨å‚æ•°ç»‘å®šå’Œç»“æœæ˜ å°„
ç¬¬3æ­¥ï¼šç†è§£ä½•æ—¶è¯¥ç”¨åŸç”ŸSQLä½•æ—¶ç”¨JPQL
ç¬¬4æ­¥ï¼šå®æˆ˜ç»ƒä¹ å¤æ‚æŸ¥è¯¢å’Œæ€§èƒ½ä¼˜åŒ–

å¸¸è§è¯¯åŒºï¼š
âŒ æ‰€æœ‰æŸ¥è¯¢éƒ½ç”¨åŸç”ŸSQL â†’ ä¸§å¤±JPAä¼˜åŠ¿
âŒ å­—ç¬¦ä¸²æ‹¼æ¥SQL â†’ å®‰å…¨éšæ‚£
âŒ ä¸åšæ€§èƒ½æµ‹è¯• â†’ å¯èƒ½æ¯”JPQLè¿˜æ…¢
```

---

> ğŸ’¡ **ä¸€å¥è¯æ€»ç»“**ï¼šåŸç”ŸSQLæ˜¯JPAçš„"å®‰å…¨å‡ºå£"ï¼Œè®©ä½ åœ¨éœ€è¦æ—¶èƒ½ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œä½†ä¸è¦æ»¥ç”¨ï¼Œä¼˜å…ˆç”¨JPQLä¿æŒè·¨æ•°æ®åº“ç‰¹æ€§ã€‚

> ğŸ¯ **å­¦ä¹ æ£€æŸ¥æ¸…å•**ï¼š
> - [ ] èƒ½ç”¨createNativeQuery()æ‰§è¡ŒåŸºæœ¬SQLæŸ¥è¯¢
> - [ ] ç†è§£ä½ç½®å‚æ•°å’Œå‘½åå‚æ•°çš„ä½¿ç”¨
> - [ ] ä¼šå¤„ç†Object[]ç»“æœå’Œæ˜ å°„åˆ°å®ä½“ç±»
> - [ ] çŸ¥é“ä½•æ—¶è¯¥ç”¨åŸç”ŸSQLä½•æ—¶ç”¨JPQL
> - [ ] èƒ½å®šä¹‰å’Œä½¿ç”¨å‘½ååŸç”ŸæŸ¥è¯¢

> ğŸ“– **ä¸‹ä¸€æ­¥å­¦ä¹ **ï¼šJPAäº‹åŠ¡ç®¡ç†å’Œå¹¶å‘æ§åˆ¶