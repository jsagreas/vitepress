---
title: 35、JPQL函数与表达式
---
## 📚 目录

1. [JPQL函数概述](#1-JPQL函数概述)
2. [字符串函数详解](#2-字符串函数详解)
3. [数值函数详解](#3-数值函数详解)
4. [日期时间函数](#4-日期时间函数)
5. [条件表达式CASE WHEN](#5-条件表达式CASE-WHEN)
6. [空值处理COALESCE](#6-空值处理COALESCE)
7. [算术表达式应用](#7-算术表达式应用)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🎯 JPQL函数概述


### 1.1 什么是JPQL函数


**通俗理解**：JPQL函数就像Excel里的公式，可以在查询时对数据进行处理和计算。

```
类比理解：
Excel中：=UPPER(A1)  把A1单元格文字变大写
JPQL中： UPPER(u.name) 把用户名变大写

都是"处理数据的小工具"
```

**为什么需要函数？**
```
❌ 没有函数的困境：
- 查出数据后在Java代码里处理
- 需要加载完整对象到内存
- 效率低，代码繁琐

✅ 使用函数的优势：
- 数据库直接处理，速度快
- 只返回需要的结果
- 代码简洁优雅
```

### 1.2 JPQL函数分类


```
┌─────────────────────────────────┐
│         JPQL函数体系            │
├─────────────────────────────────┤
│  📝 字符串函数                   │
│     └─ 拼接、截取、转换等        │
├─────────────────────────────────┤
│  🔢 数值函数                     │
│     └─ 计算、取整、求模等        │
├─────────────────────────────────┤
│  📅 日期时间函数                 │
│     └─ 获取当前时间、日期等      │
├─────────────────────────────────┤
│  🔀 条件表达式                   │
│     └─ CASE WHEN、COALESCE      │
├─────────────────────────────────┤
│  ➕ 算术表达式                   │
│     └─ 加减乘除、组合运算        │
└─────────────────────────────────┘
```

---

## 2. 📝 字符串函数详解


### 2.1 CONCAT - 字符串拼接


**作用**：把多个字符串连接成一个

**通俗理解**：就像用胶水把几段文字粘在一起

```java
// 基本用法：拼接姓和名
String jpql = "SELECT CONCAT(u.firstName, ' ', u.lastName) FROM User u";

// 实际场景：生成完整地址
String jpql = "SELECT CONCAT(u.city, '-', u.district, '-', u.street) " +
              "FROM User u WHERE u.id = :id";

// 拼接多个部分
String jpql = "SELECT CONCAT('用户:', u.name, ',年龄:', u.age) FROM User u";
```

**📌 实战案例**：
```java
// 需求：显示"张三(18岁)"格式的用户信息
String jpql = "SELECT CONCAT(u.name, '(', u.age, '岁)') " +
              "FROM User u WHERE u.status = 'ACTIVE'";
List<String> results = em.createQuery(jpql, String.class)
                         .getResultList();
// 结果：["张三(18岁)", "李四(25岁)", ...]
```

### 2.2 SUBSTRING - 字符串截取


**作用**：从字符串中取出一部分

**通俗理解**：像剪刀一样，从文字中剪出需要的部分

```java
// 语法：SUBSTRING(字符串, 起始位置, 长度)
// 注意：位置从1开始计数！

// 截取手机号后4位
String jpql = "SELECT SUBSTRING(u.phone, 8, 4) FROM User u";

// 截取邮箱用户名部分（@之前）
String jpql = "SELECT SUBSTRING(u.email, 1, LOCATE('@', u.email)-1) " +
              "FROM User u";
```

**📌 位置计数说明**：
```
字符串：  H  e  l  l  o
位置：    1  2  3  4  5  （注意：从1开始！）

SUBSTRING('Hello', 1, 3) → 'Hel'
SUBSTRING('Hello', 2, 3) → 'ell'
```

**🔥 实战案例**：
```java
// 需求：脱敏显示手机号（138****5678）
String jpql = "SELECT CONCAT(" +
              "  SUBSTRING(u.phone, 1, 3), " +
              "  '****', " +
              "  SUBSTRING(u.phone, 8, 4)" +
              ") FROM User u";
```

### 2.3 LENGTH - 获取字符串长度


**作用**：统计字符串有多少个字符

```java
// 查询用户名长度
String jpql = "SELECT u.name, LENGTH(u.name) FROM User u";

// 筛选：找出名字超过5个字的用户
String jpql = "SELECT u FROM User u WHERE LENGTH(u.name) > 5";

// 验证：检查密码长度是否符合要求
String jpql = "SELECT u FROM User u " +
              "WHERE LENGTH(u.password) < 6";
```

### 2.4 LOWER/UPPER - 大小写转换


**作用**：转换字符串的大小写

**通俗理解**：LOWER像"缩小键"，UPPER像"放大键"

```java
// LOWER：转小写
String jpql = "SELECT LOWER(u.email) FROM User u";
// zhangsan@example.com

// UPPER：转大写  
String jpql = "SELECT UPPER(u.name) FROM User u";
// ZHANGSAN

// 实战：不区分大小写的搜索
String jpql = "SELECT u FROM User u " +
              "WHERE LOWER(u.email) LIKE LOWER(:email)";
em.createQuery(jpql, User.class)
  .setParameter("email", "%ZHANG%")  // 输入大写也能找到
  .getResultList();
```

**💡 应用场景对比**：

| 函数 | **使用场景** | **示例** |
|------|-------------|---------|
| `CONCAT` | 拼接显示信息 | 生成"姓名-工号"格式 |
| `SUBSTRING` | 数据脱敏、截取 | 隐藏手机号中间4位 |
| `LENGTH` | 数据验证 | 检查用户名长度 |
| `LOWER/UPPER` | 不区分大小写查询 | 搜索邮箱地址 |

---

## 3. 🔢 数值函数详解


### 3.1 ABS - 绝对值


**作用**：取数字的绝对值（去掉负号）

**通俗理解**：不管正负，都变成正数

```java
// 基本用法
String jpql = "SELECT ABS(u.balance) FROM Account u";
// -100 → 100,  50 → 50

// 实战：计算账户亏损金额
String jpql = "SELECT u.name, ABS(u.balance) as deficit " +
              "FROM Account u WHERE u.balance < 0";
```

**📌 应用场景**：
```
场景1：计算温度差
- 今天30度，昨天25度
- 温差 = ABS(30-25) = 5度

场景2：资金波动
- 期初100元，期末80元
- 变化 = ABS(80-100) = 20元
```

### 3.2 SQRT - 平方根


**作用**：计算数字的平方根

```java
// 计算面积对应的边长
String jpql = "SELECT SQRT(r.area) FROM Room r";

// 结合WHERE：面积开方后大于5的房间
String jpql = "SELECT r FROM Room r WHERE SQRT(r.area) > 5";
```

### 3.3 MOD - 取模（求余数）


**作用**：两数相除，取余数

**通俗理解**：10个苹果，3个一组，还剩1个 → MOD(10,3) = 1

```java
// 基本用法
String jpql = "SELECT MOD(u.id, 2) FROM User u";
// id=5: MOD(5,2)=1,  id=6: MOD(6,2)=0

// 实战：找出所有偶数ID的用户
String jpql = "SELECT u FROM User u WHERE MOD(u.id, 2) = 0";

// 实战：按ID分组（每3个一组）
String jpql = "SELECT MOD(u.id, 3) as groupNum, COUNT(u) " +
              "FROM User u GROUP BY MOD(u.id, 3)";
```

**🔥 实战案例**：
```java
// 需求：实现简单的分表逻辑（根据用户ID分到3张表）
String jpql = "SELECT u FROM User u " +
              "WHERE MOD(u.id, 3) = :tableIndex";
// tableIndex=0 → user_0表
// tableIndex=1 → user_1表  
// tableIndex=2 → user_2表
```

**💡 数值函数使用对比**：

| 函数 | **计算含义** | **典型应用** |
|------|-------------|-------------|
| `ABS(x)` | \|x\| 绝对值 | 计算差值、距离 |
| `SQRT(x)` | √x 平方根 | 几何计算、标准差 |
| `MOD(x,y)` | x÷y的余数 | 奇偶判断、分组 |

---

## 4. 📅 日期时间函数


### 4.1 日期时间函数概述


**作用**：获取数据库服务器的当前时间

**通俗理解**：就像问数据库"现在几点了？"

```
CURRENT_DATE      → 今天是哪天？    2025-09-23
CURRENT_TIME      → 现在几点了？    14:30:25
CURRENT_TIMESTAMP → 精确到秒的时间  2025-09-23 14:30:25
```

### 4.2 CURRENT_DATE - 当前日期


**返回格式**：只有年月日，没有时分秒

```java
// 查询今天注册的用户
String jpql = "SELECT u FROM User u " +
              "WHERE u.registerDate = CURRENT_DATE";

// 查询今天之前注册的用户
String jpql = "SELECT u FROM User u " +
              "WHERE u.registerDate < CURRENT_DATE";
```

### 4.3 CURRENT_TIME - 当前时间


**返回格式**：只有时分秒，没有年月日

```java
// 查询当前时间段的班次
String jpql = "SELECT s FROM Shift s " +
              "WHERE s.startTime <= CURRENT_TIME " +
              "AND s.endTime >= CURRENT_TIME";
```

### 4.4 CURRENT_TIMESTAMP - 当前时间戳


**返回格式**：完整的日期+时间

```java
// 查询最近一小时的订单（数据库相关）
String jpql = "SELECT o FROM Order o " +
              "WHERE o.createTime > CURRENT_TIMESTAMP - 1 HOUR";

// 更新最后登录时间
String jpql = "UPDATE User u SET u.lastLoginTime = CURRENT_TIMESTAMP " +
              "WHERE u.id = :userId";
```

**📌 三个函数对比**：

```
假设当前时刻：2025-09-23 14:30:25

CURRENT_DATE      → 2025-09-23
CURRENT_TIME      → 14:30:25
CURRENT_TIMESTAMP → 2025-09-23 14:30:25
```

**🔥 实战案例组合**：
```java
// 需求1：查询今天新增且当前在线的用户
String jpql = "SELECT u FROM User u " +
              "WHERE u.registerDate = CURRENT_DATE " +
              "AND u.lastActiveTime > CURRENT_TIMESTAMP - 5 MINUTE";

// 需求2：统计今日销售额
String jpql = "SELECT SUM(o.amount) FROM Order o " +
              "WHERE DATE(o.createTime) = CURRENT_DATE";

// 需求3：查询过期的会员卡
String jpql = "SELECT c FROM Card c " +
              "WHERE c.expireDate < CURRENT_DATE";
```

**⚠️ 重要提醒**：
```
🔸 时区问题：
- CURRENT_TIMESTAMP返回的是数据库服务器时区的时间
- 如果应用和数据库在不同时区，需要注意转换

🔸 性能考虑：
- 这些函数每次查询都会计算
- 频繁使用时，考虑在应用层传入时间参数
```

---

## 5. 🔀 条件表达式CASE WHEN


### 5.1 CASE WHEN是什么


**通俗理解**：就是JPQL里的"如果...那么..."语句

```
日常语言：
如果成绩>=90分，那么等级是"优秀"
如果成绩>=60分，那么等级是"及格"  
否则，等级是"不及格"

JPQL表达：
CASE 
  WHEN score >= 90 THEN '优秀'
  WHEN score >= 60 THEN '及格'
  ELSE '不及格'
END
```

### 5.2 CASE WHEN语法格式


**两种语法形式**：

**📌 形式1：简单CASE（相等判断）**
```sql
CASE 字段
  WHEN 值1 THEN 结果1
  WHEN 值2 THEN 结果2
  ELSE 默认结果
END
```

**📌 形式2：搜索CASE（条件判断）**
```sql
CASE
  WHEN 条件1 THEN 结果1
  WHEN 条件2 THEN 结果2
  ELSE 默认结果
END
```

### 5.3 简单CASE示例


```java
// 根据状态码显示中文
String jpql = "SELECT u.name, " +
              "CASE u.status " +
              "  WHEN 0 THEN '正常' " +
              "  WHEN 1 THEN '冻结' " +
              "  WHEN 2 THEN '注销' " +
              "  ELSE '未知' " +
              "END as statusText " +
              "FROM User u";
```

**执行效果**：
```
输入数据：
id=1, name='张三', status=0
id=2, name='李四', status=1

查询结果：
张三 - 正常
李四 - 冻结
```

### 5.4 搜索CASE示例


```java
// 根据年龄分组
String jpql = "SELECT u.name, " +
              "CASE " +
              "  WHEN u.age < 18 THEN '未成年' " +
              "  WHEN u.age < 60 THEN '成年人' " +
              "  ELSE '老年人' " +
              "END as ageGroup " +
              "FROM User u";

// 根据成绩评级
String jpql = "SELECT s.name, " +
              "CASE " +
              "  WHEN s.score >= 90 THEN 'A' " +
              "  WHEN s.score >= 80 THEN 'B' " +
              "  WHEN s.score >= 60 THEN 'C' " +
              "  ELSE 'D' " +
              "END as grade " +
              "FROM Student s";
```

### 5.5 CASE WHEN高级应用


**🔥 实战1：动态排序**
```java
// 需求：VIP用户排前面，普通用户排后面
String jpql = "SELECT u FROM User u " +
              "ORDER BY " +
              "CASE u.userType " +
              "  WHEN 'VIP' THEN 1 " +
              "  WHEN 'NORMAL' THEN 2 " +
              "  ELSE 3 " +
              "END, u.createTime DESC";
```

**🔥 实战2：条件统计**
```java
// 需求：统计各年龄段人数
String jpql = "SELECT " +
              "SUM(CASE WHEN u.age < 18 THEN 1 ELSE 0 END) as teen, " +
              "SUM(CASE WHEN u.age >= 18 AND u.age < 60 THEN 1 ELSE 0 END) as adult, " +
              "SUM(CASE WHEN u.age >= 60 THEN 1 ELSE 0 END) as elder " +
              "FROM User u";
```

**🔥 实战3：字段映射转换**
```java
// 需求：根据性别码显示文字
String jpql = "SELECT u.name, " +
              "CASE u.gender " +
              "  WHEN 'M' THEN '男' " +
              "  WHEN 'F' THEN '女' " +
              "  ELSE '未知' " +
              "END as genderText " +
              "FROM User u";
```

**💡 使用技巧**：

| 场景 | **使用建议** | **示例** |
|------|-------------|---------|
| **值相等判断** | 用简单CASE | `CASE status WHEN 0...` |
| **范围条件** | 用搜索CASE | `CASE WHEN age < 18...` |
| **复杂逻辑** | 用搜索CASE | `CASE WHEN...AND...` |
| **结果作排序** | ORDER BY中使用 | `ORDER BY CASE...` |

---

## 6. 🛡️ 空值处理COALESCE


### 6.1 COALESCE是什么


**作用**：返回第一个非空值

**通俗理解**：给一堆选项，从左到右找，哪个不是null就用哪个

```
语法：COALESCE(值1, 值2, 值3, ...)

执行逻辑：
1. 值1不是null → 返回值1
2. 值1是null，值2不是null → 返回值2  
3. 值1、值2都是null，值3不是null → 返回值3
... 以此类推
```

### 6.2 基本用法示例


```java
// 显示用户昵称，如果没昵称就显示用户名
String jpql = "SELECT COALESCE(u.nickname, u.username) FROM User u";

// 显示手机号，没有就显示邮箱，都没有就显示'无'
String jpql = "SELECT COALESCE(u.phone, u.email, '无联系方式') FROM User u";
```

**执行效果演示**：
```
数据：
user1: nickname='小明', username='zhangsan'
user2: nickname=null,  username='lisi'

COALESCE(u.nickname, u.username) 结果：
user1 → '小明'    (nickname不为null，直接返回)
user2 → 'lisi'    (nickname为null，返回username)
```

### 6.3 实战应用场景


**🔥 场景1：提供默认值**
```java
// 显示用户余额，如果为null就显示0
String jpql = "SELECT u.name, COALESCE(u.balance, 0) as balance " +
              "FROM User u";

// 折扣率为null时按原价计算
String jpql = "SELECT p.name, p.price * COALESCE(p.discount, 1.0) as finalPrice " +
              "FROM Product p";
```

**🔥 场景2：优先级显示**
```java
// 显示联系方式（手机>座机>邮箱）
String jpql = "SELECT u.name, " +
              "COALESCE(u.mobile, u.phone, u.email) as contact " +
              "FROM User u";

// 显示地址（详细地址>简略地址>城市名）
String jpql = "SELECT COALESCE(u.detailAddress, u.address, u.city) " +
              "FROM User u";
```

**🔥 场景3：避免运算错误**
```java
// 计算总价（单价*数量），防止null导致结果为null
String jpql = "SELECT o.id, " +
              "COALESCE(o.price, 0) * COALESCE(o.quantity, 1) as total " +
              "FROM Order o";
```

### 6.4 COALESCE vs CASE WHEN


**两种实现方式对比**：

**使用COALESCE（简洁）**：
```java
SELECT COALESCE(u.nickname, u.username, '匿名用户')
```

**使用CASE WHEN（复杂）**：
```java
SELECT 
  CASE 
    WHEN u.nickname IS NOT NULL THEN u.nickname
    WHEN u.username IS NOT NULL THEN u.username
    ELSE '匿名用户'
  END
```

**💡 选择建议**：
```
✅ 用COALESCE：
- 只是简单的空值替换
- 代码更简洁易读

✅ 用CASE WHEN：
- 需要复杂的条件判断
- 不仅仅是null检查
```

**⚠️ 注意事项**：
```
🔸 类型一致：
COALESCE(u.age, '未知')  ❌ 错误！数字和字符串
COALESCE(u.age, 0)       ✅ 正确

🔸 性能考虑：
- COALESCE是数据库函数，不会触发N+1查询
- 推荐在数据库层处理，而不是Java层
```

---

## 7. ➕ 算术表达式应用


### 7.1 基本算术运算


**支持的运算符**：`+` `-` `*` `/`

**通俗理解**：就像用计算器一样，可以直接在查询里做加减乘除

```java
// 加法：计算总价
String jpql = "SELECT o.price + o.tax as total FROM Order o";

// 减法：计算折扣金额
String jpql = "SELECT p.originalPrice - p.currentPrice as discount " +
              "FROM Product p";

// 乘法：计算总金额
String jpql = "SELECT o.quantity * o.unitPrice as amount FROM Order o";

// 除法：计算平均值
String jpql = "SELECT o.totalAmount / o.quantity as avgPrice FROM Order o";
```

### 7.2 算术表达式组合


**可以像数学公式一样组合运算**：

```java
// 计算含税总价：(单价 * 数量) * (1 + 税率)
String jpql = "SELECT o.price * o.quantity * (1 + o.taxRate) as total " +
              "FROM Order o";

// 计算折扣后价格：原价 * (1 - 折扣率)
String jpql = "SELECT p.price * (1 - COALESCE(p.discount, 0)) as finalPrice " +
              "FROM Product p";

// 计算利润率：(售价 - 成本) / 成本 * 100
String jpql = "SELECT p.name, " +
              "(p.salePrice - p.costPrice) / p.costPrice * 100 as profitRate " +
              "FROM Product p";
```

### 7.3 实战应用场景


**🔥 场景1：电商价格计算**
```java
// 计算商品实付金额（原价-优惠券-积分抵扣）
String jpql = "SELECT o.id, " +
              "o.originalPrice - COALESCE(o.couponAmount, 0) - COALESCE(o.pointsDeduction, 0) " +
              "as finalPrice " +
              "FROM Order o";
```

**🔥 场景2：库存预警计算**
```java
// 计算库存余量百分比：当前库存 / 总库存 * 100
String jpql = "SELECT p.name, " +
              "p.currentStock * 100.0 / p.totalStock as stockRate " +
              "FROM Product p " +
              "WHERE p.currentStock * 100.0 / p.totalStock < 20";  // 低于20%预警
```

**🔥 场景3：绩效考核计算**
```java
// 综合得分 = 基础分 * 0.4 + 业绩分 * 0.6
String jpql = "SELECT e.name, " +
              "e.baseScore * 0.4 + e.performanceScore * 0.6 as totalScore " +
              "FROM Employee e " +
              "ORDER BY totalScore DESC";
```

### 7.4 与WHERE条件结合


**算术表达式可以用在WHERE子句中**：

```java
// 查询：折扣力度超过30%的商品
String jpql = "SELECT p FROM Product p " +
              "WHERE (p.originalPrice - p.currentPrice) / p.originalPrice > 0.3";

// 查询：销售额超过10000的订单
String jpql = "SELECT o FROM Order o " +
              "WHERE o.quantity * o.unitPrice > 10000";

// 查询：评分提升超过20%的员工
String jpql = "SELECT e FROM Employee e " +
              "WHERE (e.currentScore - e.lastScore) / e.lastScore > 0.2";
```

### 7.5 与聚合函数结合


```java
// 计算平均利润率
String jpql = "SELECT AVG((p.salePrice - p.costPrice) / p.costPrice * 100) " +
              "FROM Product p";

// 统计总销售额
String jpql = "SELECT SUM(o.quantity * o.price) FROM Order o " +
              "WHERE o.orderDate = CURRENT_DATE";

// 计算加权平均分
String jpql = "SELECT SUM(s.score * s.weight) / SUM(s.weight) " +
              "FROM Score s WHERE s.studentId = :studentId";
```

**💡 算术表达式使用技巧**：

| 技巧 | **说明** | **示例** |
|------|---------|---------|
| **括号优先** | 用括号明确运算顺序 | `(a + b) * c` |
| **小数处理** | 除法时注意整数问题 | `* 100.0` 而不是 `* 100` |
| **防止null** | 配合COALESCE使用 | `COALESCE(a, 0) + b` |
| **别名清晰** | 给计算结果起有意义的名字 | `as totalPrice` |

**⚠️ 除法注意事项**：
```java
// ❌ 整数除法可能丢失精度
SELECT 5 / 2         → 2 (某些数据库)

// ✅ 使用小数确保精度  
SELECT 5.0 / 2       → 2.5
SELECT 5 * 1.0 / 2   → 2.5

// ✅ 防止除零错误
SELECT price / COALESCE(quantity, 1)
```

---

## 8. 📋 核心要点总结


### 8.1 函数分类速查


```
📝 字符串函数：处理文本
├─ CONCAT(s1, s2, ...)    → 拼接字符串
├─ SUBSTRING(s, pos, len) → 截取字符串
├─ LENGTH(s)              → 获取长度
├─ LOWER(s)               → 转小写
└─ UPPER(s)               → 转大写

🔢 数值函数：数学运算
├─ ABS(n)                 → 绝对值
├─ SQRT(n)                → 平方根
└─ MOD(n, m)              → 取模（余数）

📅 日期函数：时间处理
├─ CURRENT_DATE           → 当前日期
├─ CURRENT_TIME           → 当前时间
└─ CURRENT_TIMESTAMP      → 当前时间戳

🔀 条件表达式：逻辑判断
├─ CASE WHEN ... THEN ... → 条件分支
└─ COALESCE(v1, v2, ...)  → 空值处理

➕ 算术表达式：四则运算
└─ + - * /                → 加减乘除
```

### 8.2 使用场景对照表


| 需求 | **推荐方案** | **代码示例** |
|------|------------|-------------|
| **字符串拼接** | CONCAT | `CONCAT(firstName, ' ', lastName)` |
| **数据脱敏** | SUBSTRING | `CONCAT(SUBSTRING(phone,1,3), '****')` |
| **不区分大小写搜索** | LOWER/UPPER | `LOWER(email) LIKE LOWER(:keyword)` |
| **取绝对值** | ABS | `ABS(balance)` |
| **奇偶判断** | MOD | `MOD(id, 2) = 0` |
| **获取当前日期** | CURRENT_DATE | `WHERE date = CURRENT_DATE` |
| **条件分支** | CASE WHEN | `CASE WHEN age<18 THEN '未成年'...` |
| **空值处理** | COALESCE | `COALESCE(nickname, username)` |
| **价格计算** | 算术表达式 | `price * (1 - discount)` |

### 8.3 关键记忆点


**🔸 字符串函数记忆**：
- `CONCAT` = 拼接 = 连起来
- `SUBSTRING` = 截取 = 剪一段
- `LENGTH` = 长度 = 数个数
- `LOWER/UPPER` = 大小写 = 变形

**🔸 数值函数记忆**：
- `ABS` = 绝对值 = 去负号
- `SQRT` = 平方根 = 开根号  
- `MOD` = 取模 = 求余数

**🔸 条件表达式记忆**：
- `CASE WHEN` = 如果那么 = 多条件分支
- `COALESCE` = 空值替换 = 从左往右找非null

**🔸 算术运算记忆**：
- `+` 加、`-` 减、`*` 乘、`/` 除
- 可组合、可嵌套、注意优先级
- 防null、防除零

### 8.4 实战组合技巧


**💡 技巧1：多函数组合**
```java
// 显示：张三(VIP) - 138****5678
CONCAT(
  u.name, 
  '(',
  CASE u.userType WHEN 1 THEN 'VIP' ELSE '普通' END,
  ') - ',
  SUBSTRING(u.phone, 1, 3),
  '****',
  SUBSTRING(u.phone, 8, 4)
)
```

**💡 技巧2：防御性编程**
```java
// 安全的价格计算（防null、防除零）
COALESCE(price, 0) * COALESCE(quantity, 1) * 
(1 - COALESCE(discount, 0))
```

**💡 技巧3：性能优化**
```java
// ✅ 在数据库层计算（推荐）
SELECT price * quantity as total FROM Order

// ❌ 在Java层计算（不推荐，需要加载完整对象）
List<Order> orders = ...;
orders.forEach(o -> o.getPrice() * o.getQuantity());
```

### 8.5 学习建议


**🎯 学习路径**：
1. **先掌握基础函数**：CONCAT、SUBSTRING、LENGTH、ABS、MOD
2. **理解条件表达式**：CASE WHEN、COALESCE的使用场景
3. **练习组合运用**：多个函数配合解决实际问题
4. **关注性能优化**：能在数据库算的，不要在Java算

**📚 练习建议**：
- 每个函数写3个以上的实际案例
- 尝试用不同方式实现同一需求
- 对比JPQL函数和Java实现的性能差异
- 结合实际业务场景设计查询

**⚠️ 常见陷阱**：
- ❌ 忘记SUBSTRING从1开始计数
- ❌ 整数除法精度丢失
- ❌ null值参与运算导致结果为null
- ❌ CASE WHEN分支顺序错误

**✅ 最佳实践**：
- 给计算结果起有意义的别名
- 复杂表达式用括号明确优先级
- 配合COALESCE防止null值
- 注意数据库兼容性（部分函数可能不支持）

---

**🎓 核心掌握标准**：
1. ✅ 能说出每个函数的作用和使用场景
2. ✅ 能独立完成字符串处理、数值计算、日期查询
3. ✅ 能灵活运用CASE WHEN实现业务逻辑
4. ✅ 能用COALESCE优雅处理空值情况
5. ✅ 能组合多个函数解决复杂查询需求