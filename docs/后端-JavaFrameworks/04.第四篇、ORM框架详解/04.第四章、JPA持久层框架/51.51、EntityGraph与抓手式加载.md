---
title: 51ã€EntityGraphä¸æŠ“æ‰‹å¼åŠ è½½
---
## ğŸ“š ç›®å½•

1. [EntityGraphæ˜¯ä»€ä¹ˆ](#1-EntityGraphæ˜¯ä»€ä¹ˆ)
2. [ä¸ºä»€ä¹ˆéœ€è¦EntityGraph](#2-ä¸ºä»€ä¹ˆéœ€è¦EntityGraph)
3. [EntityGraphçš„ä¸¤ç§ç±»å‹](#3-EntityGraphçš„ä¸¤ç§ç±»å‹)
4. [EntityGraphå®æˆ˜åº”ç”¨](#4-EntityGraphå®æˆ˜åº”ç”¨)
5. [æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ](#5-æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ EntityGraphæ˜¯ä»€ä¹ˆ


### 1.1 é€šä¿—ç†è§£EntityGraph


> **ğŸ” ç”Ÿæ´»ä¸­çš„ä¾‹å­**ï¼šå‡è®¾ä½ å»å›¾ä¹¦é¦†å€Ÿä¹¦ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š
> - **æ–¹å¼ä¸€**ï¼šå…ˆå€Ÿã€Šä¸‰å›½æ¼”ä¹‰ã€‹ï¼Œå‘ç°éœ€è¦äº†è§£å†å²èƒŒæ™¯ï¼Œå†è·‘ä¸€è¶Ÿå€Ÿã€Šå²è®°ã€‹ï¼Œåˆè§‰å¾—è¦æ‡‚äººç‰©å…³ç³»ï¼Œå†è·‘ä¸€è¶Ÿå€Ÿã€Šäººç‰©ä¼ ã€‹
> - **æ–¹å¼äºŒ**ï¼šä¸€å¼€å§‹å°±åˆ—ä¸ªæ¸…å•ï¼š"æˆ‘è¦å€Ÿã€Šä¸‰å›½æ¼”ä¹‰ã€‹ä»¥åŠç›¸å…³çš„ã€Šå²è®°ã€‹å’Œã€Šäººç‰©ä¼ ã€‹"ï¼Œä¸€æ¬¡æ€§å…¨å€Ÿå›æ¥

**EntityGraphå°±åƒæ–¹å¼äºŒçš„"å€Ÿä¹¦æ¸…å•"** - å®ƒè®©ä½ æå‰å‘Šè¯‰JPAï¼š"æˆ‘è¿™æ¬¡æŸ¥è¯¢éœ€è¦å“ªäº›å…³è”æ•°æ®ï¼Œè¯·ä¸€æ¬¡æ€§ç»™æˆ‘å–å›æ¥"ã€‚

### 1.2 ä¸“ä¸šå®šä¹‰


```
EntityGraphçš„æœ¬è´¨ï¼š
ä¸€ç§JPAæŸ¥è¯¢æç¤ºæœºåˆ¶ï¼Œç”¨äºåŠ¨æ€æ§åˆ¶å…³è”æ•°æ®çš„åŠ è½½ç­–ç•¥

ä½œç”¨ï¼š
â€¢ è§£å†³N+1æŸ¥è¯¢é—®é¢˜
â€¢ é¿å…æ‡’åŠ è½½å¸¦æ¥çš„é¢å¤–æ•°æ®åº“è®¿é—®
â€¢ çµæ´»æ§åˆ¶æ•°æ®æŠ“å–èŒƒå›´
â€¢ æå‡æŸ¥è¯¢æ€§èƒ½
```

**ğŸ“Š EntityGraphç»„æˆç»“æ„**

```
EntityGraphï¼ˆå®ä½“å›¾ï¼‰
    â”œâ”€â”€ æ ¹å®ä½“ï¼ˆRoot Entityï¼‰
    â”‚   â””â”€â”€ è¦æŸ¥è¯¢çš„ä¸»å®ä½“
    â”‚
    â”œâ”€â”€ å±æ€§è·¯å¾„ï¼ˆAttribute Pathsï¼‰
    â”‚   â”œâ”€â”€ ordersï¼ˆè¦åŠ è½½çš„å…³è”å±æ€§ï¼‰
    â”‚   â”œâ”€â”€ orders.itemsï¼ˆå¤šå±‚çº§å…³è”ï¼‰
    â”‚   â””â”€â”€ address.cityï¼ˆæ·±å±‚å…³è”ï¼‰
    â”‚
    â””â”€â”€ åŠ è½½ç±»å‹ï¼ˆGraph Typeï¼‰
        â”œâ”€â”€ FETCH - åªåŠ è½½å›¾ä¸­æŒ‡å®šçš„å±æ€§
        â””â”€â”€ LOAD - åŠ è½½å›¾ä¸­å±æ€§ + æ‰€æœ‰EAGERå±æ€§
```

### 1.3 EntityGraph vs ä¼ ç»ŸåŠ è½½æ–¹å¼


| **å¯¹æ¯”é¡¹** | **EAGERåŠ è½½** | **LAZYåŠ è½½** | **EntityGraph** |
|-----------|--------------|-------------|----------------|
| **åŠ è½½æ—¶æœº** | æŸ¥è¯¢ä¸»å®ä½“æ—¶ç«‹å³åŠ è½½ | è®¿é—®å…³è”å±æ€§æ—¶æ‰åŠ è½½ | æŸ¥è¯¢æ—¶æŒ‰éœ€åŠ è½½ |
| **çµæ´»æ€§** | âŒ å†™æ­»åœ¨å®ä½“ä¸Š | âš ï¸ å¯èƒ½N+1é—®é¢˜ | âœ… è¿è¡Œæ—¶åŠ¨æ€å†³å®š |
| **æ€§èƒ½æ§åˆ¶** | âŒ å¯èƒ½åŠ è½½ä¸éœ€è¦çš„æ•°æ® | âŒ å¤šæ¬¡æ•°æ®åº“è®¿é—® | âœ… ä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€éœ€æ•°æ® |
| **é€‚ç”¨åœºæ™¯** | æ€»æ˜¯éœ€è¦çš„å…³è” | å¾ˆå°‘ä½¿ç”¨çš„å…³è” | æŒ‰ä¸šåŠ¡åœºæ™¯åŠ¨æ€åŠ è½½ |

---

## 2. ğŸš¨ ä¸ºä»€ä¹ˆéœ€è¦EntityGraph


### 2.1 æ‡’åŠ è½½çš„ç—›ç‚¹ - N+1æŸ¥è¯¢é—®é¢˜


**âŒ é—®é¢˜åœºæ™¯ï¼šæŸ¥è¯¢è®¢å•åŠå…¶å•†å“**

```java
// å®ä½“å®šä¹‰ï¼ˆé»˜è®¤æ‡’åŠ è½½ï¼‰
@Entity
public class Order {
    @Id
    private Long id;
    
    @OneToMany(fetch = FetchType.LAZY)  // æ‡’åŠ è½½
    private List<OrderItem> items;
}

// æŸ¥è¯¢ä»£ç 
List<Order> orders = orderRepository.findAll();  // ç¬¬1æ¬¡æŸ¥è¯¢ï¼šSELECT * FROM orders

for(Order order : orders) {
    order.getItems().size();  // æ¯ä¸ªè®¢å•è§¦å‘ä¸€æ¬¡æŸ¥è¯¢ï¼šSELECT * FROM order_items WHERE order_id = ?
}
```

**ğŸ”´ æ€§èƒ½é—®é¢˜åˆ†æ**ï¼š
```
å‡è®¾æœ‰10ä¸ªè®¢å•ï¼š
- ç¬¬1æ¬¡æŸ¥è¯¢ï¼šè·å–10ä¸ªè®¢å•
- åç»­æŸ¥è¯¢ï¼šæ¯ä¸ªè®¢å•è§¦å‘1æ¬¡æŸ¥è¯¢è·å–å•†å“
- æ€»è®¡ï¼š1 + 10 = 11æ¬¡æ•°æ®åº“è®¿é—®

è¿™å°±æ˜¯ç»å…¸çš„ N+1 æŸ¥è¯¢é—®é¢˜ï¼
N = è®¢å•æ•°é‡
1 = åˆå§‹æŸ¥è¯¢è®¢å•
```

### 2.2 EAGERåŠ è½½çš„é—®é¢˜


```java
@Entity
public class Order {
    @OneToMany(fetch = FetchType.EAGER)  // æ”¹æˆç«‹å³åŠ è½½
    private List<OrderItem> items;
    
    @ManyToOne(fetch = FetchType.EAGER)
    private Customer customer;
}
```

**ğŸ”´ EAGERçš„ä¸‰å¤§é—®é¢˜**ï¼š

```
é—®é¢˜1ï¼šæ€§èƒ½æµªè´¹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŸ¥è¯¢è®¢å•åˆ—è¡¨æ—¶ï¼ˆåªéœ€è¦è®¢å•ä¿¡æ¯ï¼‰     â”‚
â”‚ â†“                                   â”‚
â”‚ è‡ªåŠ¨åŠ è½½äº† items + customer         â”‚
â”‚ â†“                                   â”‚
â”‚ äº§ç”Ÿå¤§é‡ä¸éœ€è¦çš„æ•°æ®ä¼ è¾“             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜2ï¼šæ— æ³•æŒ‰éœ€æ§åˆ¶
â€¢ è®¢å•åˆ—è¡¨é¡µé¢ä¸éœ€è¦å•†å“æ˜ç»†ï¼Œä¹Ÿä¼šåŠ è½½
â€¢ è®¢å•è¯¦æƒ…é¡µé¢éœ€è¦å•†å“ï¼Œå’Œåˆ—è¡¨ç”¨åŒæ ·çš„åŠ è½½ç­–ç•¥
â€¢ ç¼ºä¹çµæ´»æ€§

é—®é¢˜3ï¼šç¬›å¡å°”ç§¯é£é™©
â€¢ å¤šä¸ª@OneToManyåŒæ—¶EAGER
â€¢ JOINäº§ç”Ÿå¤§é‡é‡å¤æ•°æ®
â€¢ æ•°æ®åº“å’Œå†…å­˜å‹åŠ›å€å¢
```

### 2.3 EntityGraphè§£å†³æ–¹æ¡ˆ


**âœ… ä½¿ç”¨EntityGraphä¼˜åŒ–**ï¼š

```java
// åœºæ™¯1ï¼šè®¢å•åˆ—è¡¨é¡µ - ä¸éœ€è¦å…³è”æ•°æ®
List<Order> orders = orderRepository.findAll();  
// åªæŸ¥è¯¢è®¢å•ï¼Œä¸åŠ è½½items

// åœºæ™¯2ï¼šè®¢å•è¯¦æƒ…é¡µ - éœ€è¦å•†å“ä¿¡æ¯
@EntityGraph(attributePaths = "items")  
List<Order> orders = orderRepository.findAll();  
// ä¸€æ¬¡æŸ¥è¯¢è·å–è®¢å•å’Œå•†å“ï¼Œæ— N+1é—®é¢˜
```

**ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿**ï¼š
```
âœ“ åŠ¨æ€å†³å®šï¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åŠ è½½ç­–ç•¥
âœ“ æ€§èƒ½ä¼˜åŒ–ï¼šé¿å…N+1æŸ¥è¯¢å’Œä¸å¿…è¦çš„æ•°æ®åŠ è½½
âœ“ ä»£ç æ¸…æ™°ï¼šæŸ¥è¯¢æ„å›¾æ˜ç¡®ï¼Œæ˜“äºç»´æŠ¤
âœ“ çµæ´»æ§åˆ¶ï¼šåŒä¸€å®ä½“ä¸åŒåœºæ™¯ä¸åŒåŠ è½½ç­–ç•¥
```

---

## 3. ğŸ”§ EntityGraphçš„ä¸¤ç§ç±»å‹


### 3.1 FETCHç±»å‹ - ç²¾ç¡®æ§åˆ¶


**ğŸ“ å®šä¹‰**ï¼šåªåŠ è½½EntityGraphä¸­æŒ‡å®šçš„å±æ€§ï¼Œå…¶ä»–å…³è”å±æ€§ä¿æŒé»˜è®¤ç­–ç•¥ï¼ˆé€šå¸¸æ˜¯æ‡’åŠ è½½ï¼‰

```java
@EntityGraph(
    attributePaths = {"items"},           // æŒ‡å®šåŠ è½½items
    type = EntityGraph.EntityGraphType.FETCH  // FETCHç±»å‹
)
List<Order> findByCustomerId(Long customerId);
```

**ğŸ” FETCHç±»å‹çš„åŠ è½½è§„åˆ™**ï¼š

```
å®ä½“å±æ€§åŠ è½½æƒ…å†µï¼š

Orderå®ä½“ï¼š
â”œâ”€â”€ id              âœ… æ€»æ˜¯åŠ è½½ï¼ˆåŸºæœ¬å±æ€§ï¼‰
â”œâ”€â”€ orderDate       âœ… æ€»æ˜¯åŠ è½½ï¼ˆåŸºæœ¬å±æ€§ï¼‰
â”œâ”€â”€ items           âœ… åŠ è½½ï¼ˆåœ¨å›¾ä¸­æŒ‡å®šï¼‰
â”œâ”€â”€ customer        âŒ ä¸åŠ è½½ï¼ˆä¸åœ¨å›¾ä¸­ï¼Œä¿æŒLAZYï¼‰
â””â”€â”€ shippingAddress âŒ ä¸åŠ è½½ï¼ˆä¸åœ¨å›¾ä¸­ï¼Œä¿æŒLAZYï¼‰
```

**ğŸ’¡ å®é™…æ¡ˆä¾‹**ï¼š

```java
// è®¢å•è¯¦æƒ…é¡µé¢ï¼šåªéœ€è¦è®¢å•å’Œå•†å“ä¿¡æ¯
@EntityGraph(
    attributePaths = "items",
    type = EntityGraph.EntityGraphType.FETCH
)
Optional<Order> findById(Long id);

// ç”ŸæˆSQLï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š
// SELECT o.*, i.* 
// FROM orders o 
// LEFT JOIN order_items i ON o.id = i.order_id 
// WHERE o.id = ?
```

### 3.2 LOADç±»å‹ - å…¼å®¹EAGER


**ğŸ“ å®šä¹‰**ï¼šåŠ è½½EntityGraphæŒ‡å®šçš„å±æ€§ + æ‰€æœ‰æ ‡è®°ä¸ºEAGERçš„å±æ€§

```java
@EntityGraph(
    attributePaths = {"items"},
    type = EntityGraph.EntityGraphType.LOAD  // LOADç±»å‹ï¼ˆé»˜è®¤ï¼‰
)
List<Order> findByStatus(String status);
```

**ğŸ” LOADç±»å‹çš„åŠ è½½è§„åˆ™**ï¼š

```
å®ä½“å®šä¹‰ï¼š
@Entity
public class Order {
    @OneToMany(fetch = FetchType.LAZY)
    private List<OrderItem> items;
    
    @ManyToOne(fetch = FetchType.EAGER)  // æ ‡è®°ä¸ºEAGER
    private Customer customer;
    
    @OneToOne(fetch = FetchType.LAZY)
    private ShippingAddress address;
}

ä½¿ç”¨LOADç±»å‹æŸ¥è¯¢æ—¶ï¼š
â”œâ”€â”€ items       âœ… åŠ è½½ï¼ˆåœ¨å›¾ä¸­æŒ‡å®šï¼‰
â”œâ”€â”€ customer    âœ… åŠ è½½ï¼ˆEAGERå±æ€§ï¼Œå³ä½¿ä¸åœ¨å›¾ä¸­ï¼‰
â””â”€â”€ address     âŒ ä¸åŠ è½½ï¼ˆLAZYä¸”ä¸åœ¨å›¾ä¸­ï¼‰
```

### 3.3 ä¸¤ç§ç±»å‹å¯¹æ¯”


| **å¯¹æ¯”é¡¹** | **FETCHç±»å‹** | **LOADç±»å‹** |
|-----------|--------------|-------------|
| **åŠ è½½èŒƒå›´** | ä»…å›¾ä¸­æŒ‡å®šçš„å±æ€§ | å›¾ä¸­å±æ€§ + EAGERå±æ€§ |
| **EAGERå±æ€§** | âŒ å¿½ç•¥EAGERè®¾ç½® | âœ… åŒæ—¶åŠ è½½EAGERå±æ€§ |
| **ä½¿ç”¨åœºæ™¯** | ç²¾ç¡®æ§åˆ¶ï¼Œæœ€å°åŒ–åŠ è½½ | å…¼å®¹ç°æœ‰EAGERé…ç½® |
| **é»˜è®¤é€‰æ‹©** | éœ€æ˜¾å¼æŒ‡å®š | âœ… é»˜è®¤ç±»å‹ï¼ˆå¯çœç•¥ï¼‰ |
| **æ€§èƒ½** | âš¡ æœ€ä¼˜ï¼ˆæŒ‰éœ€åŠ è½½ï¼‰ | âš ï¸ å¯èƒ½åŠ è½½é¢å¤–æ•°æ® |

**ğŸ¯ é€‰æ‹©å»ºè®®**ï¼š

```
ä¼˜å…ˆä½¿ç”¨FETCHç±»å‹ï¼š
â€¢ æ–°é¡¹ç›®å¼€å‘
â€¢ éœ€è¦ç²¾ç¡®æ§åˆ¶åŠ è½½èŒƒå›´
â€¢ è¿½æ±‚æœ€ä½³æ€§èƒ½

ä½¿ç”¨LOADç±»å‹çš„åœºæ™¯ï¼š
â€¢ è€é¡¹ç›®æ”¹é€ ï¼Œæœ‰å¾ˆå¤šEAGERé…ç½®
â€¢ éœ€è¦å…¼å®¹ç°æœ‰ä¸šåŠ¡é€»è¾‘
â€¢ å¿«é€Ÿè§£å†³N+1é—®é¢˜
```

---

## 4. ğŸ’» EntityGraphå®æˆ˜åº”ç”¨


### 4.1 åŸºç¡€ç”¨æ³• - @EntityGraphæ³¨è§£


**åœºæ™¯ï¼šè®¢å•ç®¡ç†ç³»ç»Ÿ**

```java
@Entity
public class Order {
    @Id
    private Long id;
    private String orderNumber;
    
    @ManyToOne(fetch = FetchType.LAZY)
    private Customer customer;
    
    @OneToMany(fetch = FetchType.LAZY)
    private List<OrderItem> items;
}

// Repositoryæ¥å£
public interface OrderRepository extends JpaRepository<Order, Long> {
    
    // 1. å•å±‚å…³è”åŠ è½½
    @EntityGraph(attributePaths = "customer")
    List<Order> findByStatus(String status);
    
    // 2. å¤šä¸ªå…³è”åŒæ—¶åŠ è½½
    @EntityGraph(attributePaths = {"customer", "items"})
    Optional<Order> findById(Long id);
    
    // 3. å¤šå±‚çº§å…³è”åŠ è½½
    @EntityGraph(attributePaths = {"items", "items.product"})
    List<Order> findByCustomerId(Long customerId);
}
```

**ğŸ” SQLå¯¹æ¯”åˆ†æ**ï¼š

```sql
-- ä¸ä½¿ç”¨EntityGraphï¼ˆN+1é—®é¢˜ï¼‰
SELECT * FROM orders WHERE status = 'PENDING';  -- æŸ¥è¯¢10ä¸ªè®¢å•
SELECT * FROM customers WHERE id = ?;           -- æ‰§è¡Œ10æ¬¡
SELECT * FROM order_items WHERE order_id = ?;   -- æ‰§è¡Œ10æ¬¡
-- æ€»è®¡ï¼š21æ¬¡æŸ¥è¯¢

-- ä½¿ç”¨EntityGraphï¼ˆä¸€æ¬¡æŸ¥è¯¢ï¼‰
SELECT o.*, c.*, i.* 
FROM orders o
LEFT JOIN customers c ON o.customer_id = c.id
LEFT JOIN order_items i ON o.id = i.order_id
WHERE o.status = 'PENDING';
-- æ€»è®¡ï¼š1æ¬¡æŸ¥è¯¢
```

### 4.2 attributePathsè·¯å¾„é…ç½®


**ğŸ›¤ï¸ è·¯å¾„è¡¨è¾¾å¼è¯­æ³•**ï¼š

```java
// 1. å•ä¸ªå±æ€§
@EntityGraph(attributePaths = "items")

// 2. å¤šä¸ªå±æ€§ï¼ˆå¹³çº§ï¼‰
@EntityGraph(attributePaths = {"customer", "items", "address"})

// 3. åµŒå¥—å±æ€§ï¼ˆæ·±å±‚å…³è”ï¼‰
@EntityGraph(attributePaths = "items.product")

// 4. å¤šå±‚çº§ç»„åˆ
@EntityGraph(attributePaths = {
    "customer",                    // å®¢æˆ·ä¿¡æ¯
    "items",                       // è®¢å•æ˜ç»†
    "items.product",               // å•†å“ä¿¡æ¯
    "items.product.category",      // å•†å“åˆ†ç±»
    "shippingAddress.city"         // é…é€åŸå¸‚
})
List<Order> findDetailedOrders();
```

**ğŸ“Š è·¯å¾„å±‚çº§ç¤ºæ„**ï¼š

```
Orderï¼ˆè®¢å•ï¼‰
â”œâ”€â”€ customerï¼ˆå®¢æˆ·ï¼‰âœ…
â”‚   â”œâ”€â”€ name
â”‚   â””â”€â”€ email
â”‚
â”œâ”€â”€ itemsï¼ˆè®¢å•é¡¹ï¼‰âœ…
â”‚   â”œâ”€â”€ quantity
â”‚   â”œâ”€â”€ price
â”‚   â””â”€â”€ productï¼ˆå•†å“ï¼‰âœ…
â”‚       â”œâ”€â”€ name
â”‚       â”œâ”€â”€ price
â”‚       â””â”€â”€ categoryï¼ˆåˆ†ç±»ï¼‰âœ…
â”‚           â”œâ”€â”€ name
â”‚           â””â”€â”€ description
â”‚
â””â”€â”€ shippingAddressï¼ˆåœ°å€ï¼‰âœ…
    â”œâ”€â”€ street
    â””â”€â”€ cityï¼ˆåŸå¸‚ï¼‰âœ…
        â”œâ”€â”€ name
        â””â”€â”€ zipCode
```

### 4.3 å‘½åEntityGraph - å¤ç”¨é…ç½®


**åœºæ™¯ï¼šå®šä¹‰å¯å¤ç”¨çš„å›¾é…ç½®**

```java
@Entity
@NamedEntityGraph(
    name = "Order.withDetails",
    attributeNodes = {
        @NamedAttributeNode("customer"),
        @NamedAttributeNode("items"),
        @NamedAttributeNode("shippingAddress")
    }
)
@NamedEntityGraph(
    name = "Order.withItemsAndProducts",
    attributeNodes = {
        @NamedAttributeNode(
            value = "items",
            subgraph = "items-subgraph"
        )
    },
    subgraphs = {
        @NamedSubgraph(
            name = "items-subgraph",
            attributeNodes = {
                @NamedAttributeNode("product")
            }
        )
    }
)
public class Order {
    // å®ä½“å®šä¹‰
}

// ä½¿ç”¨å‘½åå›¾
public interface OrderRepository extends JpaRepository<Order, Long> {
    
    @EntityGraph("Order.withDetails")
    List<Order> findByCustomerId(Long customerId);
    
    @EntityGraph("Order.withItemsAndProducts")
    Optional<Order> findDetailedById(Long id);
}
```

### 4.4 åŠ¨æ€EntityGraph - ç¼–ç¨‹å¼API


**åœºæ™¯ï¼šè¿è¡Œæ—¶åŠ¨æ€æ„å»ºæŸ¥è¯¢å›¾**

```java
@Service
public class OrderService {
    
    @PersistenceContext
    private EntityManager entityManager;
    
    public List<Order> findOrdersWithDynamicGraph(
        String status, 
        boolean includeCustomer, 
        boolean includeItems
    ) {
        // åŠ¨æ€æ„å»ºEntityGraph
        EntityGraph<Order> graph = entityManager.createEntityGraph(Order.class);
        
        if (includeCustomer) {
            graph.addAttributeNodes("customer");
        }
        if (includeItems) {
            graph.addAttributeNodes("items");
        }
        
        // æ‰§è¡ŒæŸ¥è¯¢
        return entityManager
            .createQuery("SELECT o FROM Order o WHERE o.status = :status", Order.class)
            .setParameter("status", status)
            .setHint("javax.persistence.fetchgraph", graph)
            .getResultList();
    }
}
```

**ğŸ¯ åŠ¨æ€å›¾çš„åº”ç”¨åœºæ™¯**ï¼š

```
âœ“ æ ¹æ®ç”¨æˆ·æƒé™åŠ¨æ€åŠ è½½æ•°æ®
âœ“ APIå‚æ•°æ§åˆ¶è¿”å›å­—æ®µèŒƒå›´
âœ“ å¤æ‚ä¸šåŠ¡é€»è¾‘çš„æ¡ä»¶åŠ è½½
âœ“ å¤šç§Ÿæˆ·åœºæ™¯çš„å·®å¼‚åŒ–åŠ è½½
```

### 4.5 å®æˆ˜æ¡ˆä¾‹ï¼šç”µå•†è®¢å•æŸ¥è¯¢


**å®Œæ•´ä¸šåŠ¡åœºæ™¯å®ç°**ï¼š

```java
// 1. è®¢å•åˆ—è¡¨é¡µï¼ˆåªæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯ï¼‰
@EntityGraph(attributePaths = "customer")
Page<Order> findByStatusOrderByCreatedAtDesc(
    String status, 
    Pageable pageable
);

// 2. è®¢å•è¯¦æƒ…é¡µï¼ˆéœ€è¦å®Œæ•´ä¿¡æ¯ï¼‰
@EntityGraph(
    attributePaths = {
        "customer",
        "items",
        "items.product",
        "shippingAddress"
    },
    type = EntityGraph.EntityGraphType.FETCH
)
Optional<Order> findDetailedById(Long id);

// 3. å¯¼å‡ºæŠ¥è¡¨ï¼ˆéœ€è¦ç»Ÿè®¡ä¿¡æ¯ï¼‰
@EntityGraph(attributePaths = {
    "customer",
    "items",
    "items.product.category"
})
List<Order> findByCreatedAtBetween(
    LocalDateTime start, 
    LocalDateTime end
);

// 4. è´¢åŠ¡å¯¹è´¦ï¼ˆåªéœ€è¦é‡‘é¢ç›¸å…³ï¼‰
@EntityGraph(attributePaths = "items")  // åªåŠ è½½å•†å“è®¡ç®—é‡‘é¢
List<Order> findByPaymentStatus(String status);
```

---

## 5. âš¡ æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ


### 5.1 é¿å…ç¬›å¡å°”ç§¯é—®é¢˜


**âŒ é”™è¯¯ç¤ºä¾‹ï¼šå¤šä¸ªé›†åˆå…³è”**

```java
// å±é™©é…ç½®ï¼šåŒæ—¶åŠ è½½å¤šä¸ª@OneToMany
@EntityGraph(attributePaths = {"items", "payments", "shipments"})
List<Order> findAll();

// äº§ç”Ÿçš„é—®é¢˜ï¼š
// 1ä¸ªè®¢å• Ã— 3ä¸ªå•†å“ Ã— 2ä¸ªæ”¯ä»˜è®°å½• Ã— 1ä¸ªç‰©æµ = 6è¡Œé‡å¤æ•°æ®
```

**âœ… ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```
æ–¹æ¡ˆ1ï¼šåˆ†æ‰¹åŠ è½½
â€¢ å…ˆæŸ¥è¯¢è®¢å•å’Œitems
â€¢ éœ€è¦æ—¶å•ç‹¬æŸ¥è¯¢paymentså’Œshipments

æ–¹æ¡ˆ2ï¼šä½¿ç”¨å­æŸ¥è¯¢
â€¢ é€šè¿‡JPQLå­æŸ¥è¯¢ä¼˜åŒ–

æ–¹æ¡ˆ3ï¼šä½¿ç”¨DTOæŠ•å½±
â€¢ åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Œé¿å…JOIN
```

### 5.2 EntityGraphä½¿ç”¨è§„èŒƒ


**ğŸ¯ æœ€ä½³å®è·µæ¸…å•**ï¼š

```
âœ… DOï¼ˆæ¨èåšæ³•ï¼‰ï¼š
1. ä¼˜å…ˆä½¿ç”¨FETCHç±»å‹ï¼Œç²¾ç¡®æ§åˆ¶åŠ è½½èŒƒå›´
2. é¿å…è¿‡æ·±çš„åµŒå¥—è·¯å¾„ï¼ˆå»ºè®®ä¸è¶…è¿‡3å±‚ï¼‰
3. æ ¹æ®ä¸šåŠ¡åœºæ™¯å®šä¹‰ä¸åŒçš„å›¾
4. ä½¿ç”¨å‘½åå›¾å¤ç”¨å¸¸ç”¨é…ç½®
5. ç»“åˆåˆ†é¡µé¿å…ä¸€æ¬¡åŠ è½½è¿‡å¤šæ•°æ®

âŒ DON'Tï¼ˆé¿å…åšæ³•ï¼‰ï¼š
1. ä¸è¦åœ¨å›¾ä¸­åŠ è½½å¤šä¸ªå¤§å‹é›†åˆ
2. ä¸è¦ç›²ç›®åŠ è½½æ‰€æœ‰å…³è”å±æ€§
3. é¿å…å¾ªç¯å¼•ç”¨çš„å…³è”åŠ è½½
4. ä¸è¦åœ¨é«˜é¢‘æ¥å£ä½¿ç”¨å¤æ‚å›¾
```

### 5.3 ç›‘æ§ä¸è°ƒè¯•


**ğŸ” SQLæ—¥å¿—é…ç½®**ï¼š

```yaml
# application.yml
spring:
  jpa:
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        use_sql_comments: true  # æ˜¾ç¤ºHQLæ¥æº
```

**ğŸ“Š æ€§èƒ½ç›‘æ§æŒ‡æ ‡**ï¼š

```
å…³é”®æŒ‡æ ‡ï¼š
â€¢ æŸ¥è¯¢æ¬¡æ•°ï¼šæ˜¯å¦è§£å†³äº†N+1é—®é¢˜
â€¢ SQLå¤æ‚åº¦ï¼šJOINæ•°é‡æ˜¯å¦åˆç†
â€¢ æ•°æ®é‡ï¼šè¿”å›è¡Œæ•°æ˜¯å¦ç¬¦åˆé¢„æœŸ
â€¢ å“åº”æ—¶é—´ï¼šæŸ¥è¯¢è€—æ—¶æ˜¯å¦åœ¨å¯æ¥å—èŒƒå›´

å·¥å…·æ¨èï¼š
â€¢ P6Spyï¼šSQLæ‹¦æˆªå’Œåˆ†æ
â€¢ Hibernate Statisticsï¼šæŸ¥è¯¢ç»Ÿè®¡
â€¢ Spring Boot Actuatorï¼šæ€§èƒ½æŒ‡æ ‡
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 æ ¸å¿ƒæ¦‚å¿µå›é¡¾


```
ğŸ”¸ EntityGraphæœ¬è´¨
  ä¸€ç§æŸ¥è¯¢æç¤ºæœºåˆ¶ï¼Œå‘Šè¯‰JPA"è¿™æ¬¡æŸ¥è¯¢éœ€è¦å“ªäº›å…³è”æ•°æ®"

ğŸ”¸ è§£å†³çš„é—®é¢˜
  â€¢ N+1æŸ¥è¯¢æ€§èƒ½é—®é¢˜
  â€¢ EAGERåŠ è½½çš„ä¸çµæ´»æ€§
  â€¢ æ‡’åŠ è½½çš„é¢å¤–æŸ¥è¯¢å¼€é”€

ğŸ”¸ ä¸¤ç§ç±»å‹
  â€¢ FETCHï¼šåªåŠ è½½æŒ‡å®šå±æ€§ï¼ˆç²¾ç¡®æ§åˆ¶ï¼‰
  â€¢ LOADï¼šæŒ‡å®šå±æ€§ + EAGERå±æ€§ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰

ğŸ”¸ ä½¿ç”¨æ–¹å¼
  â€¢ @EntityGraphæ³¨è§£ï¼ˆç®€å•ç›´æ¥ï¼‰
  â€¢ å‘½åå›¾ï¼ˆå¯å¤ç”¨é…ç½®ï¼‰
  â€¢ åŠ¨æ€APIï¼ˆè¿è¡Œæ—¶æ„å»ºï¼‰
```

### 6.2 é€‚ç”¨åœºæ™¯åˆ¤æ–­


| **åœºæ™¯** | **æ˜¯å¦ä½¿ç”¨EntityGraph** | **æ¨èæ–¹æ¡ˆ** |
|---------|----------------------|-------------|
| è®¢å•è¯¦æƒ…é¡µ | âœ… é€‚åˆ | ä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰éœ€è¦çš„å…³è”æ•°æ® |
| åˆ—è¡¨åˆ†é¡µ | âš ï¸ è°¨æ… | åŠ è½½åŸºæœ¬ä¿¡æ¯ï¼Œé¿å…å¤šä¸ªé›†åˆå…³è” |
| æ•°æ®å¯¼å‡º | âœ… é€‚åˆ | æ‰¹é‡åŠ è½½é¿å…N+1é—®é¢˜ |
| ç®€å•æŸ¥è¯¢ | âŒ ä¸éœ€è¦ | ç›´æ¥æŸ¥è¯¢å³å¯ |
| å¤šå±‚åµŒå¥— | âš ï¸ è¯„ä¼° | æ·±åº¦ä¸è¶…è¿‡3å±‚ï¼Œè€ƒè™‘åˆ†æ‰¹åŠ è½½ |

### 6.3 å¸¸è§é—®é¢˜è§£ç­”


**Q1ï¼šEntityGraphå’ŒJOIN FETCHæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
```
ç›¸åŒç‚¹ï¼š
â€¢ éƒ½èƒ½ä¸€æ¬¡æŸ¥è¯¢è·å–å…³è”æ•°æ®
â€¢ éƒ½èƒ½è§£å†³N+1é—®é¢˜

ä¸åŒç‚¹ï¼š
EntityGraph           JOIN FETCH
-------------------------------------
å£°æ˜å¼ã€æ³¨è§£é…ç½®      å‘½ä»¤å¼ã€JPQLç¼–å†™
ç±»å‹å®‰å…¨             éœ€è¦æ‰‹å†™æŸ¥è¯¢
æ”¯æŒåŠ¨æ€é…ç½®         ç›¸å¯¹å›ºå®š
Spring Dataå‹å¥½      åŸç”ŸJPA

å»ºè®®ï¼šSpring Data JPAä¼˜å…ˆç”¨EntityGraph
```

**Q2ï¼šä»€ä¹ˆæ—¶å€™ç”¨FETCHï¼Œä»€ä¹ˆæ—¶å€™ç”¨LOADï¼Ÿ**
```
é€‰æ‹©FETCHçš„åœºæ™¯ï¼š
â€¢ æ–°é¡¹ç›®ï¼Œè¿½æ±‚æœ€ä½³æ€§èƒ½
â€¢ ç²¾ç¡®æ§åˆ¶åŠ è½½èŒƒå›´
â€¢ é¿å…ä¸å¿…è¦çš„æ•°æ®ä¼ è¾“

é€‰æ‹©LOADçš„åœºæ™¯ï¼š
â€¢ è€é¡¹ç›®æ”¹é€ ï¼Œå…¼å®¹ç°æœ‰EAGERé…ç½®
â€¢ å¿«é€Ÿè§£å†³N+1é—®é¢˜
â€¢ ä¸šåŠ¡é€»è¾‘ä¾èµ–EAGERå±æ€§
```

**Q3ï¼šEntityGraphä¼šå½±å“å†™æ“ä½œå—ï¼Ÿ**
```
ä¸ä¼šå½±å“ï¼
â€¢ EntityGraphåªå½±å“æŸ¥è¯¢ï¼ˆSELECTï¼‰
â€¢ ä¸å½±å“ä¿å­˜ã€æ›´æ–°ã€åˆ é™¤æ“ä½œ
â€¢ åªæ˜¯æŸ¥è¯¢æ—¶çš„åŠ è½½æç¤º
```

### 6.4 å®æˆ˜è¿›é˜¶å»ºè®®


**ğŸš€ å­¦ä¹ è·¯å¾„**ï¼š
```
å…¥é—¨é˜¶æ®µï¼š
1. ç†è§£N+1é—®é¢˜äº§ç”Ÿçš„åŸå› 
2. æŒæ¡@EntityGraphåŸºç¡€ç”¨æ³•
3. å­¦ä¼šæŸ¥çœ‹ç”Ÿæˆçš„SQLè¯­å¥

è¿›é˜¶é˜¶æ®µï¼š
4. æŒæ¡FETCHå’ŒLOADçš„åŒºåˆ«
5. å­¦ä¼šä½¿ç”¨å‘½åå›¾
6. äº†è§£åŠ¨æ€å›¾çš„æ„å»º

é«˜çº§é˜¶æ®µï¼š
7. æ€§èƒ½è°ƒä¼˜å’Œç›‘æ§
8. ç»“åˆç¼“å­˜ä¼˜åŒ–
9. å¤æ‚ä¸šåŠ¡åœºæ™¯å®æˆ˜
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æ‡’åŠ è½½N+1æ€§èƒ½å·®ï¼Œ
æ€¥åŠ è½½å›ºå®šä¸çµæ´»ï¼Œ
EntityGraphæ¥è§£å†³ï¼Œ
åŠ¨æ€æ§åˆ¶æœ€ä¼˜åŒ–ã€‚

FETCHç²¾ç¡®LOADå…¼å®¹ï¼Œ
è·¯å¾„é…ç½®å±‚çº§æ¸…ï¼Œ
ä¸€æ¬¡æŸ¥è¯¢å…¨æå®šï¼Œ
è¯»è¯·æ±‚æé€Ÿå¿«åˆç¨³ï¼
```