---
title: 77ã€åˆ é™¤è¯­ä¹‰ä¸orphanRemoval
---
## ğŸ“š ç›®å½•

1. [åˆ é™¤æ“ä½œçš„æœ¬è´¨ç†è§£](#1-åˆ é™¤æ“ä½œçš„æœ¬è´¨ç†è§£)
2. [è½¯åˆ é™¤ä¸ç‰©ç†åˆ é™¤](#2-è½¯åˆ é™¤ä¸ç‰©ç†åˆ é™¤)
3. [çº§è”åˆ é™¤æ·±åº¦è§£æ](#3-çº§è”åˆ é™¤æ·±åº¦è§£æ)
4. [orphanRemovalå­¤å„¿åˆ é™¤](#4-orphanRemovalå­¤å„¿åˆ é™¤)
5. [å®¡è®¡ä¸æ•°æ®æ¢å¤](#5-å®¡è®¡ä¸æ•°æ®æ¢å¤)
6. [æ€§èƒ½å½±å“ä¸ä¼˜åŒ–](#6-æ€§èƒ½å½±å“ä¸ä¼˜åŒ–)
7. [æœ€ä½³å®è·µæ€»ç»“](#7-æœ€ä½³å®è·µæ€»ç»“)

---

## 1. ğŸ¯ åˆ é™¤æ“ä½œçš„æœ¬è´¨ç†è§£


### 1.1 ä»€ä¹ˆæ˜¯åˆ é™¤æ“ä½œ


**é€šä¿—ç†è§£**ï¼šåˆ é™¤æ•°æ®å°±åƒå¤„ç†ä¸éœ€è¦çš„ä¸œè¥¿ï¼Œæœ‰ä¸¤ç§æ–¹å¼
- **æ‰”è¿›åƒåœ¾æ¡¶**ï¼šè½¯åˆ é™¤ï¼Œä¸œè¥¿è¿˜åœ¨åªæ˜¯æ ‡è®°ä¸º"åºŸå¼ƒ"
- **å½»åº•é”€æ¯**ï¼šç‰©ç†åˆ é™¤ï¼Œæ•°æ®çœŸçš„æ²¡äº†

```
ç°å®ç±»æ¯”ï¼š

å›¾ä¹¦é¦†å€Ÿä¹¦ç³»ç»Ÿï¼š
è½¯åˆ é™¤ â†’ ä¹¦ç±æ ‡è®°"å·²ä¸‹æ¶"ï¼Œä½†è®°å½•è¿˜åœ¨
ç‰©ç†åˆ é™¤ â†’ ä¹¦ç±è®°å½•å½»åº•ä»ç³»ç»ŸæŠ¹æ‰

ç”µå•†è®¢å•ï¼š
è½¯åˆ é™¤ â†’ è®¢å•çŠ¶æ€æ”¹ä¸º"å·²åˆ é™¤"ï¼Œè®¢å•æ•°æ®ä¿ç•™
ç‰©ç†åˆ é™¤ â†’ è®¢å•ä»æ•°æ®åº“çœŸçš„åˆ æ‰
```

### 1.2 åˆ é™¤æ“ä½œçš„æ ¸å¿ƒé—®é¢˜


**ğŸ”¸ éœ€è¦è€ƒè™‘çš„å…³é”®ç‚¹**
```
â‘  åˆ é™¤åèƒ½å¦æ¢å¤ï¼Ÿ
   è½¯åˆ é™¤ â†’ âœ… å¯ä»¥æ¢å¤
   ç‰©ç†åˆ é™¤ â†’ âŒ æ— æ³•æ¢å¤

â‘¡ å…³è”æ•°æ®æ€ä¹ˆåŠï¼Ÿ
   è®¢å•åˆ äº† â†’ è®¢å•æ˜ç»†è¦ä¸è¦åˆ ï¼Ÿ
   ç”¨æˆ·åˆ äº† â†’ ä»–çš„è¯„è®ºè¦ä¸è¦åˆ ï¼Ÿ

â‘¢ æ˜¯å¦éœ€è¦ç•™ç—•ï¼Ÿ
   æ³•å¾‹è¦æ±‚ â†’ å¿…é¡»ä¿ç•™åˆ é™¤è®°å½•
   å®¡è®¡éœ€è¦ â†’ è¦çŸ¥é“è°åˆ çš„ã€ä»€ä¹ˆæ—¶å€™åˆ çš„

â‘£ æ€§èƒ½å½±å“å¤šå¤§ï¼Ÿ
   è½¯åˆ é™¤ â†’ åªæ”¹çŠ¶æ€ï¼Œå¿«
   ç‰©ç†åˆ é™¤ â†’ è¦çœŸåˆ æ•°æ®ï¼Œå¯èƒ½æ¶‰åŠçº§è”
```

---

## 2. ğŸ—‘ï¸ è½¯åˆ é™¤ä¸ç‰©ç†åˆ é™¤


### 2.1 è½¯åˆ é™¤ï¼ˆé€»è¾‘åˆ é™¤ï¼‰


**æ ¸å¿ƒæ¦‚å¿µ**ï¼šæ•°æ®ä¸çœŸåˆ ï¼Œåªæ˜¯æ‰“ä¸ª"å·²åˆ é™¤"æ ‡è®°

**ğŸ”¸ å®ç°æ–¹å¼**
```java
@Entity
public class User {
    @Id
    private Long id;
    
    private String username;
    
    // è½¯åˆ é™¤æ ‡è®°ï¼ˆæ–¹å¼1ï¼šå¸ƒå°”å€¼ï¼‰
    private Boolean deleted = false;
    
    // è½¯åˆ é™¤æ ‡è®°ï¼ˆæ–¹å¼2ï¼šåˆ é™¤æ—¶é—´ï¼‰
    private LocalDateTime deletedAt;
    
    // æ–¹å¼3ï¼šä½¿ç”¨æšä¸¾çŠ¶æ€
    @Enumerated(EnumType.STRING)
    private Status status = Status.ACTIVE;  // ACTIVE, DELETED
}
```

**ğŸ’¡ æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤å·²åˆ é™¤æ•°æ®**
```java
// Hibernateçš„@Whereæ³¨è§£ï¼ˆè‡ªåŠ¨è¿‡æ»¤ï¼‰
@Entity
@Where(clause = "deleted = false")  // æŸ¥è¯¢æ—¶è‡ªåŠ¨åŠ è¿™ä¸ªæ¡ä»¶
public class User {
    // ...
}

// æˆ–è€…ç”¨@SQLDeleteè‡ªå®šä¹‰åˆ é™¤SQL
@Entity
@SQLDelete(sql = "UPDATE user SET deleted = true WHERE id = ?")
public class User {
    // ...
}
```

**âœ… è½¯åˆ é™¤çš„ä¼˜åŠ¿**
- **å¯æ¢å¤æ€§**ï¼šè¯¯åˆ é™¤å¯ä»¥æ‰¾å›
- **æ•°æ®å®Œæ•´**ï¼šå†å²æ•°æ®ä¿ç•™ï¼Œä¾¿äºåˆ†æ
- **å®¡è®¡å‹å¥½**ï¼šç¬¦åˆæ³•å¾‹æ³•è§„è¦æ±‚
- **å…³è”å®‰å…¨**ï¼šä¸ç ´åå¤–é”®çº¦æŸ

**âŒ è½¯åˆ é™¤çš„åŠ£åŠ¿**
- **æ•°æ®è†¨èƒ€**ï¼šè¡¨è¶Šæ¥è¶Šå¤§ï¼Œæ€§èƒ½ä¸‹é™
- **æŸ¥è¯¢å¤æ‚**ï¼šæ¯æ¬¡éƒ½è¦åŠ `deleted = false`æ¡ä»¶
- **å”¯ä¸€çº¦æŸ**ï¼šå·²åˆ é™¤æ•°æ®å¯èƒ½å†²çªï¼ˆå¦‚ç”¨æˆ·åå”¯ä¸€ï¼‰
- **ç´¢å¼•æµªè´¹**ï¼šå·²åˆ é™¤æ•°æ®å ç”¨ç´¢å¼•ç©ºé—´

### 2.2 ç‰©ç†åˆ é™¤ï¼ˆçœŸåˆ é™¤ï¼‰


**æ ¸å¿ƒæ¦‚å¿µ**ï¼šä»æ•°æ®åº“çœŸçš„æŠŠæ•°æ®åˆ æ‰ï¼Œä¸€å»ä¸å¤è¿”

**ğŸ”¸ åŸºæœ¬æ“ä½œ**
```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    
    // ç‰©ç†åˆ é™¤å•æ¡
    void deleteById(Long id);
    
    // ç‰©ç†åˆ é™¤å®ä½“
    void delete(User user);
    
    // æ‰¹é‡ç‰©ç†åˆ é™¤
    @Modifying
    @Query("DELETE FROM User u WHERE u.status = :status")
    void deleteByStatus(@Param("status") Status status);
}
```

**âœ… ç‰©ç†åˆ é™¤çš„ä¼˜åŠ¿**
- **èŠ‚çœç©ºé—´**ï¼šæ•°æ®å½»åº•åˆ é™¤ï¼Œé‡Šæ”¾å­˜å‚¨
- **æŸ¥è¯¢ç®€å•**ï¼šä¸ç”¨æ¯æ¬¡è¿‡æ»¤åˆ é™¤æ ‡è®°
- **æ€§èƒ½æ›´å¥½**ï¼šè¡¨æ•°æ®å°‘ï¼ŒæŸ¥è¯¢å¿«
- **æ— å†²çª**ï¼šä¸ä¼šæœ‰å”¯ä¸€çº¦æŸå†²çª

**âŒ ç‰©ç†åˆ é™¤çš„åŠ£åŠ¿**
- **ä¸å¯æ¢å¤**ï¼šåˆ äº†å°±çœŸæ²¡äº†
- **ä¸¢å¤±å†å²**ï¼šæ•°æ®åˆ†ææ— æ³•å›æº¯
- **çº§è”é£é™©**ï¼šå¯èƒ½è¯¯åˆ å…³è”æ•°æ®
- **è¿è§„é£é™©**ï¼šå¯èƒ½ä¸ç¬¦åˆå®¡è®¡è¦æ±‚

### 2.3 é€‰æ‹©ç­–ç•¥å¯¹æ¯”


| åœºæ™¯ç±»å‹ | **æ¨èæ–¹æ¡ˆ** | **ç†ç”±** |
|---------|------------|---------|
| ğŸ’° **è®¢å•/äº¤æ˜“** | `è½¯åˆ é™¤` | æ³•å¾‹è¦æ±‚ä¿ç•™ï¼Œå®¡è®¡éœ€è¦ |
| ğŸ‘¤ **ç”¨æˆ·è´¦å·** | `è½¯åˆ é™¤` | ç”¨æˆ·å¯èƒ½è¦æ¢å¤ï¼Œå…³è”æ•°æ®å¤š |
| ğŸ“ **è¯„è®º/å¸–å­** | `è½¯åˆ é™¤` | å¯èƒ½è¯¯åˆ ï¼Œç”¨æˆ·è¦æ±‚æ¢å¤ |
| ğŸ—‚ï¸ **ä¸´æ—¶æ•°æ®** | `ç‰©ç†åˆ é™¤` | æ— ä¿ç•™ä»·å€¼ï¼ŒèŠ‚çœç©ºé—´ |
| ğŸ“Š **æ—¥å¿—è®°å½•** | `è½¯åˆ é™¤` | æ•°æ®åˆ†æéœ€è¦å†å²è®°å½• |
| ğŸ”§ **é…ç½®æ•°æ®** | `è½¯åˆ é™¤` | å¯èƒ½éœ€è¦æ¢å¤ä¹‹å‰é…ç½® |
| ğŸ—‘ï¸ **ç¼“å­˜æ•°æ®** | `ç‰©ç†åˆ é™¤` | ä¸´æ—¶æ€§è´¨ï¼Œæ— ä¿ç•™å¿…è¦ |

---

## 3. âš ï¸ çº§è”åˆ é™¤æ·±åº¦è§£æ


### 3.1 ä»€ä¹ˆæ˜¯çº§è”åˆ é™¤


**é€šä¿—è§£é‡Š**ï¼šå°±åƒå¤šç±³è¯ºéª¨ç‰Œï¼Œåˆ é™¤ä¸€ä¸ªï¼Œç›¸å…³çš„è·Ÿç€å€’

```
å®é™…ä¾‹å­ï¼š

éƒ¨é—¨ â†’ å‘˜å·¥ â†’ è€ƒå‹¤è®°å½•

åˆ é™¤éƒ¨é—¨(çº§è”) â†’ 
  å‘˜å·¥è‡ªåŠ¨åˆ é™¤ â†’ 
    è€ƒå‹¤è®°å½•è‡ªåŠ¨åˆ é™¤

å°±åƒæ‹†æˆ¿å­ï¼š
æ‹†æ‰æ¥¼æ ‹ â†’ æ‰€æœ‰æˆ¿é—´è·Ÿç€æ²¡äº† â†’ æˆ¿é—´é‡Œçš„å®¶å…·ä¹Ÿæ²¡äº†
```

### 3.2 JPAçº§è”åˆ é™¤é…ç½®


**ğŸ”¸ ä¸€å¯¹å¤šå…³ç³»çš„çº§è”åˆ é™¤**
```java
@Entity
public class Department {
    @Id
    private Long id;
    
    private String name;
    
    // é…ç½®çº§è”åˆ é™¤
    @OneToMany(
        mappedBy = "department",
        cascade = CascadeType.REMOVE,  // åˆ é™¤éƒ¨é—¨æ—¶ï¼Œå‘˜å·¥ä¹Ÿåˆ 
        orphanRemoval = true           // å‘˜å·¥è„±ç¦»éƒ¨é—¨ä¹Ÿåˆ ï¼ˆåé¢è¯¦è§£ï¼‰
    )
    private List<Employee> employees;
}

@Entity
public class Employee {
    @Id
    private Long id;
    
    @ManyToOne
    private Department department;
}
```

**ğŸ’¡ çº§è”ç±»å‹è¯´æ˜**
```java
// çº§è”ç±»å‹æšä¸¾
CascadeType.PERSIST   â†’ ä¿å­˜æ—¶çº§è”
CascadeType.MERGE     â†’ æ›´æ–°æ—¶çº§è”
CascadeType.REMOVE    â†’ åˆ é™¤æ—¶çº§è”  â­
CascadeType.REFRESH   â†’ åˆ·æ–°æ—¶çº§è”
CascadeType.DETACH    â†’ åˆ†ç¦»æ—¶çº§è”
CascadeType.ALL       â†’ æ‰€æœ‰æ“ä½œéƒ½çº§è”
```

### 3.3 çº§è”åˆ é™¤çš„é£é™©è¯„ä¼°


**ğŸš¨ é‡å¤§é£é™©åœºæ™¯**

**é£é™©â‘ ï¼šè¯¯åˆ å¤§é‡æ•°æ®**
```java
// å±é™©ç¤ºä¾‹ï¼šåˆ é™¤ä¸€ä¸ªç”¨æˆ·ï¼Œæ‰€æœ‰è®¢å•éƒ½æ²¡äº†
@Entity
public class User {
    @OneToMany(cascade = CascadeType.REMOVE)  // âš ï¸ å±é™©ï¼
    private List<Order> orders;
}

// åæœ
userRepository.delete(user);  
// â†’ åˆ é™¤ç”¨æˆ·çš„åŒæ—¶ï¼Œä»–æ‰€æœ‰è®¢å•éƒ½åˆ äº†ï¼
// â†’ å¦‚æœç”¨æˆ·æœ‰1000ä¸ªè®¢å•ï¼Œå…¨éƒ¨ä¸¢å¤±ï¼
```

**é£é™©â‘¡ï¼šè¿åä¸šåŠ¡è§„åˆ™**
```java
// å±é™©ç¤ºä¾‹ï¼šåˆ é™¤åˆ†ç±»ï¼Œå•†å“ä¹Ÿæ²¡äº†
@Entity
public class Category {
    @OneToMany(cascade = CascadeType.REMOVE)  // âš ï¸ ä¸åˆç†ï¼
    private List<Product> products;
}

// é—®é¢˜ï¼šå•†å“å¯èƒ½å±äºå¤šä¸ªåˆ†ç±»
// åˆ é™¤ä¸€ä¸ªåˆ†ç±»ï¼Œå•†å“ä¸åº”è¯¥è¢«åˆ é™¤
```

**é£é™©â‘¢ï¼šæ€§èƒ½ç¾éš¾**
```java
// å±é™©ç¤ºä¾‹ï¼šçº§è”å±‚çº§å¤ªæ·±
éƒ¨é—¨ â†’ å‘˜å·¥ â†’ è€ƒå‹¤ â†’ æ‰“å¡è®°å½• â†’ æ‰“å¡ç…§ç‰‡
  â†“      â†“      â†“        â†“          â†“
åˆ 1æ¡  åˆ 100æ¡ åˆ 3000æ¡  åˆ 10ä¸‡æ¡   åˆ 50ä¸‡æ¡

// ä¸€æ¬¡åˆ é™¤å¯èƒ½è§¦å‘ç™¾ä¸‡çº§æ•°æ®åˆ é™¤ï¼
```

### 3.4 çº§è”åˆ é™¤å®‰å…¨ç­–ç•¥


**ğŸ›¡ï¸ å®‰å…¨å®è·µ**

**ç­–ç•¥â‘ ï¼šæ˜¾å¼é™åˆ¶çº§è”å±‚çº§**
```java
@Entity
public class Department {
    // âœ… åªçº§è”ä¸€å±‚ï¼Œå‘˜å·¥ä¸å†å‘ä¸‹çº§è”
    @OneToMany(cascade = CascadeType.REMOVE)
    private List<Employee> employees;
}

@Entity
public class Employee {
    // âœ… è€ƒå‹¤è®°å½•ä¸çº§è”åˆ é™¤ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†
    @OneToMany  // ä¸åŠ cascade
    private List<Attendance> attendances;
}
```

**ç­–ç•¥â‘¡ï¼šä½¿ç”¨æ•°æ®åº“çº¦æŸä¿æŠ¤**
```java
@Entity
public class Order {
    @ManyToOne
    @JoinColumn(
        name = "user_id",
        foreignKey = @ForeignKey(
            name = "fk_order_user",
            value = ConstraintMode.CONSTRAINT  // æ•°æ®åº“å±‚é¢é˜»æ­¢åˆ é™¤
        )
    )
    private User user;
}

// å°è¯•åˆ é™¤æœ‰è®¢å•çš„ç”¨æˆ· â†’ æ•°æ®åº“æŠ¥é”™ï¼Œé˜»æ­¢åˆ é™¤
```

**ç­–ç•¥â‘¢ï¼šåˆ é™¤å‰æ£€æŸ¥**
```java
@Service
public class DepartmentService {
    
    public void deleteDepartment(Long deptId) {
        Department dept = repository.findById(deptId)
            .orElseThrow();
        
        // âœ… åˆ é™¤å‰æ£€æŸ¥
        if (!dept.getEmployees().isEmpty()) {
            throw new BusinessException(
                "éƒ¨é—¨ä¸‹è¿˜æœ‰å‘˜å·¥ï¼Œä¸èƒ½åˆ é™¤ï¼"
            );
        }
        
        repository.delete(dept);
    }
}
```

**ç­–ç•¥â‘£ï¼šè½¯åˆ é™¤æ›¿ä»£çº§è”åˆ é™¤**
```java
@Entity
public class Department {
    // âœ… ç”¨è½¯åˆ é™¤ï¼Œæ•°æ®è¿˜åœ¨
    @OneToMany(mappedBy = "department")
    private List<Employee> employees;
    
    private Boolean deleted = false;
}

// åˆ é™¤éƒ¨é—¨æ—¶
department.setDeleted(true);
// å‘˜å·¥å…³è”è¿˜åœ¨ï¼Œåªæ˜¯éƒ¨é—¨æ ‡è®°åˆ é™¤
```

---

## 4. ğŸ‘¶ orphanRemovalå­¤å„¿åˆ é™¤


### 4.1 ä»€ä¹ˆæ˜¯å­¤å„¿åˆ é™¤


**é€šä¿—ç†è§£**ï¼šå­©å­è„±ç¦»çˆ¶æ¯ï¼Œå°±è‡ªåŠ¨æ¶ˆå¤±

```
ç°å®ç±»æ¯”ï¼š

è®¢å• â†’ è®¢å•æ˜ç»†

æƒ…å†µ1ï¼šåˆ é™¤è®¢å•
  â†’ è®¢å•æ˜ç»†æˆä¸º"å­¤å„¿"ï¼ˆæ²¡æœ‰è®¢å•äº†ï¼‰
  â†’ orphanRemoval=true â†’ æ˜ç»†è‡ªåŠ¨åˆ é™¤

æƒ…å†µ2ï¼šè®¢å•.æ˜ç»†åˆ—è¡¨.remove(æŸæ˜ç»†)
  â†’ æ˜ç»†ä»è®¢å•ä¸­ç§»é™¤ï¼Œæˆä¸º"å­¤å„¿"
  â†’ orphanRemoval=true â†’ æ˜ç»†è‡ªåŠ¨åˆ é™¤
```

### 4.2 orphanRemoval vs CascadeType.REMOVE


**æ ¸å¿ƒåŒºåˆ«**

```
ğŸ“‹ å¯¹æ¯”è¯´æ˜ï¼š

CascadeType.REMOVEï¼š
  è§¦å‘æ—¶æœº â†’ åˆ é™¤çˆ¶å®ä½“æ—¶
  æ“ä½œèŒƒå›´ â†’ çˆ¶å®ä½“è¢«delete()
  
orphanRemovalï¼š
  è§¦å‘æ—¶æœº â†’ å­å®ä½“è„±ç¦»çˆ¶å®ä½“æ—¶
  æ“ä½œèŒƒå›´ â†’ ä»é›†åˆä¸­remove() æˆ– è®¾ç½®ä¸ºnull
```

**ğŸ”¸ ä»£ç ç¤ºä¾‹å¯¹æ¯”**
```java
@Entity
public class Order {
    @Id
    private Long id;
    
    // æƒ…å†µ1ï¼šåªæœ‰cascade
    @OneToMany(cascade = CascadeType.REMOVE)
    private List<OrderItem> items1;
    
    // æƒ…å†µ2ï¼šåªæœ‰orphanRemoval
    @OneToMany(orphanRemoval = true)
    private List<OrderItem> items2;
    
    // æƒ…å†µ3ï¼šä¸¤è€…éƒ½æœ‰
    @OneToMany(
        cascade = CascadeType.REMOVE,
        orphanRemoval = true
    )
    private List<OrderItem> items3;
}
```

**ğŸ’¡ è¡Œä¸ºå¯¹æ¯”è¡¨**

| æ“ä½œ | **åªcascade** | **åªorphanRemoval** | **ä¸¤è€…éƒ½æœ‰** |
|------|-------------|-------------------|------------|
| `em.remove(order)` | âœ… æ˜ç»†åˆ é™¤ | âŒ æ˜ç»†ä¸åˆ  | âœ… æ˜ç»†åˆ é™¤ |
| `order.items.remove(item)` | âŒ æ˜ç»†ä¸åˆ  | âœ… æ˜ç»†åˆ é™¤ | âœ… æ˜ç»†åˆ é™¤ |
| `order.setItems(null)` | âŒ æ˜ç»†ä¸åˆ  | âœ… æ˜ç»†åˆ é™¤ | âœ… æ˜ç»†åˆ é™¤ |
| `order.items.clear()` | âŒ æ˜ç»†ä¸åˆ  | âœ… æ˜ç»†åˆ é™¤ | âœ… æ˜ç»†åˆ é™¤ |

### 4.3 orphanRemovalä½¿ç”¨åœºæ™¯


**âœ… é€‚åˆä½¿ç”¨çš„åœºæ™¯**

**åœºæ™¯â‘ ï¼šå¼ºä¾èµ–å…³ç³»**
```java
// è®¢å•æ˜ç»†å®Œå…¨ä¾èµ–è®¢å•
@Entity
public class Order {
    @OneToMany(
        mappedBy = "order",
        cascade = CascadeType.ALL,
        orphanRemoval = true  // âœ… æ˜ç»†ç¦»å¼€è®¢å•å°±åˆ é™¤
    )
    private List<OrderItem> items;
}

// ä¸šåŠ¡é€»è¾‘
order.getItems().remove(item);  // ç§»é™¤æ˜ç»†ï¼Œè‡ªåŠ¨ä»æ•°æ®åº“åˆ é™¤
```

**åœºæ™¯â‘¡ï¼šå€¼å¯¹è±¡ï¼ˆValue Objectï¼‰**
```java
// åœ°å€ä¿¡æ¯å±äºç”¨æˆ·ï¼Œæ²¡æœ‰ç‹¬ç«‹æ„ä¹‰
@Entity
public class User {
    @OneToMany(
        mappedBy = "user",
        cascade = CascadeType.ALL,
        orphanRemoval = true  // âœ… åœ°å€è„±ç¦»ç”¨æˆ·å°±åˆ é™¤
    )
    private List<Address> addresses;
}
```

**åœºæ™¯â‘¢ï¼šç§æœ‰é™„ä»¶**
```java
// æ–‡ç« çš„é™„ä»¶ä¸èƒ½å…±äº«
@Entity
public class Article {
    @OneToMany(
        mappedBy = "article",
        orphanRemoval = true  // âœ… é™„ä»¶è„±ç¦»æ–‡ç« å°±åˆ é™¤
    )
    private List<Attachment> attachments;
}
```

**âŒ ä¸é€‚åˆä½¿ç”¨çš„åœºæ™¯**

**åœºæ™¯â‘ ï¼šå¤šå¯¹å¤šå…³ç³»**
```java
@Entity
public class Student {
    @ManyToMany
    // âŒ ä¸èƒ½ç”¨orphanRemovalï¼
    // åŸå› ï¼šè¯¾ç¨‹å¯èƒ½å±äºå¤šä¸ªå­¦ç”Ÿ
    private Set<Course> courses;
}
```

**åœºæ™¯â‘¡ï¼šå…±äº«å¼•ç”¨**
```java
@Entity
public class Order {
    @ManyToOne
    // âŒ ä¸èƒ½ç”¨orphanRemovalï¼
    // åŸå› ï¼šå•†å“å¯ä»¥è¢«å¤šä¸ªè®¢å•å¼•ç”¨
    private Product product;
}
```

**åœºæ™¯â‘¢ï¼šéœ€è¦å½’æ¡£çš„æ•°æ®**
```java
@Entity
public class Project {
    @OneToMany(mappedBy = "project")
    // âŒ ä¸ç”¨orphanRemoval
    // åŸå› ï¼šä»»åŠ¡å¯èƒ½éœ€è¦å½’æ¡£ï¼Œä¸åº”è¯¥åˆ é™¤
    private List<Task> tasks;
}
```

### 4.4 å­¤å„¿åˆ é™¤çš„é™·é˜±


**ğŸš¨ å¸¸è§é—®é¢˜**

**é—®é¢˜â‘ ï¼šåŒå‘å…³ç³»çš„åŒæ­¥**
```java
// âš ï¸ é”™è¯¯ç¤ºä¾‹
@Entity
public class Order {
    @OneToMany(orphanRemoval = true)
    private List<OrderItem> items;
}

// é—®é¢˜ä»£ç 
OrderItem item = order.getItems().get(0);
order.getItems().remove(item);  // ä»é›†åˆç§»é™¤
item.setOrder(otherOrder);      // ä½†åˆè®¾ç½®ç»™å…¶ä»–è®¢å•
// â†’ ç»“æœï¼šitemè¢«åˆ é™¤äº†ï¼å› ä¸ºorphanRemovalè§¦å‘äº†
```

**è§£å†³æ–¹æ¡ˆ**
```java
// âœ… æ­£ç¡®å¤„ç†
public void transferItem(Order from, Order to, OrderItem item) {
    from.getItems().remove(item);  // ä»åŸè®¢å•ç§»é™¤
    to.getItems().add(item);       // ç«‹å³åŠ å…¥æ–°è®¢å•
    item.setOrder(to);             // åŒæ­¥å…³ç³»
    // â†’ å› ä¸ºitemé©¬ä¸Šæœ‰äº†æ–°çˆ¶äº²ï¼Œä¸ä¼šè¢«åˆ é™¤
}
```

**é—®é¢˜â‘¡ï¼šçº§è”æ“ä½œé¡ºåº**
```java
// âš ï¸ å±é™©ä»£ç 
order.getItems().clear();        // æ¸…ç©ºé›†åˆ â†’ è§¦å‘åˆ é™¤
order.getItems().addAll(newItems); // å†æ·»åŠ æ–°çš„
// â†’ ä¸­é—´æ—¶åˆ»æ‰€æœ‰iteméƒ½æ˜¯å­¤å„¿ï¼Œå¯èƒ½è¢«åˆ é™¤ï¼
```

**è§£å†³æ–¹æ¡ˆ**
```java
// âœ… æ­£ç¡®æ–¹å¼
List<OrderItem> toRemove = new ArrayList<>(order.getItems());
toRemove.removeAll(newItems);    // è®¡ç®—è¦åˆ é™¤çš„
order.getItems().removeAll(toRemove);  // åªåˆ é™¤ä¸è¦çš„
order.getItems().addAll(newItems);     // æ·»åŠ æ–°çš„
```

---

## 5. ğŸ“‹ å®¡è®¡ä¸æ•°æ®æ¢å¤


### 5.1 åˆ é™¤å®¡è®¡è®°å½•


**æ ¸å¿ƒç›®æ ‡**ï¼šè®°å½•è°ã€ä»€ä¹ˆæ—¶å€™ã€åˆ äº†ä»€ä¹ˆ

**ğŸ”¸ å®¡è®¡ä¿¡æ¯è®¾è®¡**
```java
@Entity
public class AuditableEntity {
    @Id
    private Long id;
    
    // è½¯åˆ é™¤æ ‡è®°
    private Boolean deleted = false;
    
    // åˆ é™¤å®¡è®¡å­—æ®µ
    private Long deletedBy;           // è°åˆ çš„
    private LocalDateTime deletedAt;  // ä»€ä¹ˆæ—¶å€™åˆ çš„
    private String deleteReason;      // ä¸ºä»€ä¹ˆåˆ 
    
    // JPAè‡ªåŠ¨å®¡è®¡
    @CreatedBy
    private String createdBy;
    
    @CreatedDate
    private LocalDateTime createdDate;
    
    @LastModifiedBy
    private String lastModifiedBy;
    
    @LastModifiedDate
    private LocalDateTime lastModifiedDate;
}
```

**ğŸ’¡ ä½¿ç”¨JPAå®¡è®¡åŠŸèƒ½**
```java
// 1. å¯ç”¨å®¡è®¡
@Configuration
@EnableJpaAuditing
public class JpaConfig {
    
    // 2. æä¾›å½“å‰æ“ä½œäºº
    @Bean
    public AuditorAware<String> auditorProvider() {
        return () -> Optional.of(
            SecurityContextHolder
                .getContext()
                .getAuthentication()
                .getName()
        );
    }
}

// 3. å®ä½“ä½¿ç”¨å®¡è®¡
@Entity
@EntityListeners(AuditingEntityListener.class)
public class User extends AuditableEntity {
    // è‡ªåŠ¨è®°å½•åˆ›å»ºäººã€ä¿®æ”¹äººã€æ—¶é—´ç­‰
}
```

### 5.2 åˆ é™¤å†å²è¿½è¸ª


**æ–¹æ¡ˆâ‘ ï¼šåˆ é™¤æ—¥å¿—è¡¨**
```java
@Entity
public class DeletionLog {
    @Id
    private Long id;
    
    private String entityType;     // åˆ é™¤çš„å®ä½“ç±»å‹
    private Long entityId;         // åˆ é™¤çš„å®ä½“ID
    private String entityData;     // åˆ é™¤å‰çš„æ•°æ®å¿«ç…§ï¼ˆJSONï¼‰
    
    private String deletedBy;      // æ“ä½œäºº
    private LocalDateTime deletedAt;
    private String reason;         // åˆ é™¤åŸå› 
    private String ipAddress;      // æ“ä½œIP
}

// åˆ é™¤æ‹¦æˆªå™¨
@Service
public class DeletionService {
    
    public void deleteWithLog(User user, String reason) {
        // 1. è®°å½•åˆ é™¤æ—¥å¿—
        DeletionLog log = new DeletionLog();
        log.setEntityType("User");
        log.setEntityId(user.getId());
        log.setEntityData(toJson(user));  // å¿«ç…§
        log.setReason(reason);
        logRepository.save(log);
        
        // 2. æ‰§è¡Œåˆ é™¤
        userRepository.delete(user);
    }
}
```

**æ–¹æ¡ˆâ‘¡ï¼šä½¿ç”¨Enverså†å²ç‰ˆæœ¬**
```java
// 1. ä¾èµ–
<dependency>
    <groupId>org.hibernate</groupId>
    <artifactId>hibernate-envers</artifactId>
</dependency>

// 2. å¯ç”¨å®¡è®¡
@Entity
@Audited  // â­ å¯ç”¨ç‰ˆæœ¬æ§åˆ¶
public class User {
    // ...
}

// 3. æŸ¥è¯¢å†å²ç‰ˆæœ¬
AuditReader reader = AuditReaderFactory.get(entityManager);

// æŸ¥è¯¢æ‰€æœ‰å†å²ç‰ˆæœ¬
List<Number> revisions = reader.getRevisions(User.class, userId);

// æŸ¥è¯¢æŸä¸ªç‰ˆæœ¬çš„æ•°æ®
User historicalUser = reader.find(User.class, userId, revisionNum);

// æŸ¥è¯¢åˆ é™¤è®°å½•
List<User> deleted = reader
    .createQuery()
    .forRevisionsOfEntity(User.class, true, true)
    .add(AuditEntity.revisionType().eq(RevisionType.DEL))
    .getResultList();
```

### 5.3 æ•°æ®æ¢å¤ç­–ç•¥


**æ¢å¤æ–¹æ¡ˆå¯¹æ¯”**

| åˆ é™¤æ–¹å¼ | **æ¢å¤éš¾åº¦** | **æ¢å¤æ–¹æ³•** | **æ•°æ®å®Œæ•´æ€§** |
|---------|------------|------------|--------------|
| è½¯åˆ é™¤ | â­ ç®€å• | æ”¹çŠ¶æ€å³å¯ | âœ… å®Œæ•´ä¿ç•™ |
| ç‰©ç†åˆ é™¤+æ—¥å¿— | â­â­ ä¸­ç­‰ | ä»æ—¥å¿—æ¢å¤ | âš ï¸ çœ‹æ—¥å¿—è¯¦ç»†åº¦ |
| ç‰©ç†åˆ é™¤+Envers | â­â­ ä¸­ç­‰ | ä»å†å²ç‰ˆæœ¬æ¢å¤ | âœ… å®Œæ•´ä¿ç•™ |
| ç‰©ç†åˆ é™¤+å¤‡ä»½ | â­â­â­ å›°éš¾ | ä»æ•°æ®åº“å¤‡ä»½æ¢å¤ | âš ï¸ å¯èƒ½ä¸æ˜¯æœ€æ–° |
| çº¯ç‰©ç†åˆ é™¤ | âŒ ä¸å¯èƒ½ | æ— æ³•æ¢å¤ | âŒ æ•°æ®ä¸¢å¤± |

**ğŸ”¸ è½¯åˆ é™¤æ¢å¤å®ç°**
```java
@Service
public class UserRecoveryService {
    
    // æ¢å¤å•ä¸ªç”¨æˆ·
    public void recoverUser(Long userId) {
        User user = userRepository.findById(userId)
            .orElseThrow(() -> new NotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        if (!user.getDeleted()) {
            throw new BusinessException("ç”¨æˆ·æœªè¢«åˆ é™¤");
        }
        
        // æ¢å¤
        user.setDeleted(false);
        user.setDeletedBy(null);
        user.setDeletedAt(null);
        
        userRepository.save(user);
    }
    
    // æ‰¹é‡æ¢å¤
    @Transactional
    public void batchRecover(List<Long> userIds) {
        List<User> users = userRepository.findAllById(userIds);
        
        users.forEach(user -> {
            user.setDeleted(false);
            user.setDeletedBy(null);
            user.setDeletedAt(null);
        });
        
        userRepository.saveAll(users);
    }
}
```

### 5.4 åˆè§„æ€§è¦æ±‚


**ğŸ“œ æ³•å¾‹æ³•è§„åœºæ™¯**

```
é‡‘èè¡Œä¸šï¼š
âœ… äº¤æ˜“è®°å½•å¿…é¡»ä¿ç•™7å¹´
âœ… åªèƒ½è½¯åˆ é™¤ï¼Œå¸¦å®¡è®¡æ—¥å¿—
âœ… éœ€è¦é˜²ç¯¡æ”¹æœºåˆ¶

åŒ»ç–—è¡Œä¸šï¼š
âœ… ç—…å†æ•°æ®æ°¸ä¹…ä¿ç•™
âœ… åˆ é™¤æ“ä½œéœ€è¦å¤šäººå®¡æ‰¹
âœ… å®Œæ•´çš„æ“ä½œæ—¥å¿—

ç”µå•†å¹³å°ï¼š
âœ… è®¢å•æ•°æ®ä¿ç•™3å¹´ä»¥ä¸Š
âœ… ç”¨æˆ·æ³¨é”€åæ•°æ®åŒ¿ååŒ–è€Œéåˆ é™¤
âœ… å…³é”®æ“ä½œç•™ç—•
```

**ğŸ”¸ åˆè§„åˆ é™¤å®ç°**
```java
@Service
public class CompliantDeletionService {
    
    // é‡‘èåœºæ™¯ï¼šä¸å…è®¸çœŸåˆ é™¤
    public void deleteOrder(Long orderId, String reason) {
        Order order = orderRepository.findById(orderId)
            .orElseThrow();
        
        // åªèƒ½è½¯åˆ é™¤
        order.setDeleted(true);
        order.setDeletedAt(LocalDateTime.now());
        order.setDeleteReason(reason);
        
        // è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆä¸å¯ç¯¡æ”¹ï¼‰
        auditService.log(
            "ORDER_DELETE",
            orderId,
            getCurrentUser(),
            reason
        );
        
        orderRepository.save(order);
    }
    
    // æ•°æ®åŒ¿ååŒ–ï¼ˆGDPRç”¨æˆ·æ³¨é”€ï¼‰
    public void anonymizeUser(Long userId) {
        User user = userRepository.findById(userId)
            .orElseThrow();
        
        // ä¸åˆ é™¤ï¼Œè€Œæ˜¯åŒ¿ååŒ–
        user.setUsername("user_" + userId + "_deleted");
        user.setEmail("deleted_" + userId + "@example.com");
        user.setPhone(null);
        user.setRealName("***");
        user.setStatus(UserStatus.ANONYMIZED);
        
        userRepository.save(user);
    }
}
```

---

## 6. âš¡ æ€§èƒ½å½±å“ä¸ä¼˜åŒ–


### 6.1 åˆ é™¤æ“ä½œçš„æ€§èƒ½å¼€é”€


**ğŸ”¸ æ€§èƒ½å¯¹æ¯”**

```
å•æ¡åˆ é™¤ï¼š
ç‰©ç†åˆ é™¤ â†’ DELETE FROM user WHERE id = ?
è½¯åˆ é™¤   â†’ UPDATE user SET deleted = true WHERE id = ?

æ€§èƒ½å·®å¼‚ï¼šå‡ ä¹ç›¸åŒï¼Œéƒ½æ˜¯å•æ¡SQL
```

```
æ‰¹é‡åˆ é™¤ï¼š
ç‰©ç†åˆ é™¤ â†’ DELETE FROM user WHERE id IN (?,?,?...)
è½¯åˆ é™¤   â†’ UPDATE user SET deleted = true WHERE id IN (?,?,?...)

æ€§èƒ½å·®å¼‚ï¼š
- SQLæ‰§è¡Œæ—¶é—´ç›¸è¿‘
- ä½†è½¯åˆ é™¤æ•°æ®è¿˜åœ¨ï¼Œå ç”¨ç©ºé—´
```

```
çº§è”åˆ é™¤ï¼š
ç‰©ç†åˆ é™¤ â†’ å¯èƒ½è§¦å‘å¤šå±‚çº§è”ï¼ŒNæ¡SQL
è½¯åˆ é™¤   â†’ åªæ”¹çŠ¶æ€ï¼Œ1æ¡SQL

æ€§èƒ½å·®å¼‚ï¼šçº§è”è¶Šæ·±ï¼Œç‰©ç†åˆ é™¤è¶Šæ…¢
```

### 6.2 è½¯åˆ é™¤å¸¦æ¥çš„æ€§èƒ½é—®é¢˜


**é—®é¢˜â‘ ï¼šè¡¨æ•°æ®è†¨èƒ€**
```
å‡è®¾ï¼š
- ç”¨æˆ·è¡¨1000ä¸‡æ¡
- å…¶ä¸­500ä¸‡å·²è½¯åˆ é™¤
- æ¯æ¬¡æŸ¥è¯¢éƒ½è¦è¿‡æ»¤ deleted = false

å½±å“ï¼š
â†’ è¡¨æ‰«ææ•°æ®é‡å¤§
â†’ ç´¢å¼•ä¹ŸåŒ…å«å·²åˆ é™¤æ•°æ®
â†’ æŸ¥è¯¢å˜æ…¢
```

**è§£å†³æ–¹æ¡ˆ**
```java
// æ–¹æ¡ˆ1ï¼šåˆ†åŒºè¡¨ï¼ˆæŒ‰åˆ é™¤çŠ¶æ€åˆ†åŒºï¼‰
@Entity
@Table(name = "user")
@PartitionKey("deleted")  // ä¼ªä»£ç ï¼Œå®é™…çœ‹æ•°æ®åº“æ”¯æŒ
public class User {
    // ...
}

// æ–¹æ¡ˆ2ï¼šå½’æ¡£è¡¨
@Scheduled(cron = "0 0 2 * * ?")  // æ¯å¤©å‡Œæ™¨2ç‚¹
public void archiveDeletedUsers() {
    // 1. å°†6ä¸ªæœˆå‰åˆ é™¤çš„ç”¨æˆ·è½¬ç§»åˆ°å½’æ¡£è¡¨
    List<User> oldDeleted = userRepository
        .findByDeletedTrueAndDeletedAtBefore(
            LocalDateTime.now().minusMonths(6)
        );
    
    // 2. æ’å…¥å½’æ¡£è¡¨
    archivedUserRepository.saveAll(oldDeleted);
    
    // 3. ä»ä¸»è¡¨ç‰©ç†åˆ é™¤
    userRepository.deleteAll(oldDeleted);
}
```

**é—®é¢˜â‘¡ï¼šç´¢å¼•æ•ˆç‡ä¸‹é™**
```sql
-- é—®é¢˜ï¼šç´¢å¼•åŒ…å«å¤§é‡å·²åˆ é™¤æ•°æ®
CREATE INDEX idx_username ON user(username);
-- å¦‚æœ50%æ˜¯å·²åˆ é™¤æ•°æ®ï¼Œç´¢å¼•æµªè´¹50%ç©ºé—´

-- è§£å†³ï¼šéƒ¨åˆ†ç´¢å¼•ï¼ˆPostgreSQLï¼‰
CREATE INDEX idx_active_username 
ON user(username) 
WHERE deleted = false;  -- åªç´¢å¼•æœªåˆ é™¤çš„
```

**é—®é¢˜â‘¢ï¼šæŸ¥è¯¢éœ€è¦é¢å¤–æ¡ä»¶**
```java
// æ¯æ¬¡æŸ¥è¯¢éƒ½è¦åŠ æ¡ä»¶ï¼Œå®¹æ˜“é—æ¼
@Query("SELECT u FROM User u WHERE u.deleted = false AND ...")
List<User> findActiveUsers();

// è§£å†³ï¼šä½¿ç”¨@Whereè‡ªåŠ¨è¿‡æ»¤
@Entity
@Where(clause = "deleted = false")  // è‡ªåŠ¨åŠ æ¡ä»¶
public class User {
    // ...
}
```

### 6.3 çº§è”åˆ é™¤çš„æ€§èƒ½ä¼˜åŒ–


**ä¼˜åŒ–â‘ ï¼šæ‰¹é‡åˆ é™¤ä»£æ›¿é€æ¡åˆ é™¤**
```java
// âŒ æ€§èƒ½å·®ï¼šN+1é—®é¢˜
for (OrderItem item : order.getItems()) {
    itemRepository.delete(item);  // æ¯æ¬¡ä¸€æ¡SQL
}

// âœ… ä¼˜åŒ–ï¼šæ‰¹é‡åˆ é™¤
@Modifying
@Query("DELETE FROM OrderItem i WHERE i.order.id = :orderId")
void deleteByOrderId(@Param("orderId") Long orderId);

// æˆ–ä½¿ç”¨çº§è”åˆ é™¤
order.getItems().clear();  // ä¸€æ¬¡æ€§æ¸…ç©º
entityManager.flush();     // è§¦å‘æ‰¹é‡åˆ é™¤
```

**ä¼˜åŒ–â‘¡ï¼šå»¶è¿Ÿåˆ é™¤ç­–ç•¥**
```java
// æ ‡è®°åˆ é™¤ï¼Œå¼‚æ­¥çœŸæ­£åˆ é™¤
@Service
public class AsyncDeletionService {
    
    // 1. ç«‹å³è½¯åˆ é™¤
    public void markForDeletion(Long userId) {
        User user = userRepository.findById(userId)
            .orElseThrow();
        
        user.setDeleted(true);
        user.setScheduledDeletionAt(
            LocalDateTime.now().plusDays(30)  // 30å¤©åçœŸåˆ 
        );
        
        userRepository.save(user);
    }
    
    // 2. å¼‚æ­¥ä»»åŠ¡çœŸæ­£åˆ é™¤
    @Scheduled(cron = "0 0 3 * * ?")
    public void physicalDelete() {
        List<User> toDelete = userRepository
            .findByScheduledDeletionAtBefore(LocalDateTime.now());
        
        userRepository.deleteAll(toDelete);
    }
}
```

**ä¼˜åŒ–â‘¢ï¼šæ•°æ®åº“å±‚é¢ä¼˜åŒ–**
```sql
-- MySQLï¼šä½¿ç”¨ON DELETE CASCADE
CREATE TABLE order_item (
    id BIGINT PRIMARY KEY,
    order_id BIGINT,
    FOREIGN KEY (order_id) 
        REFERENCES `order`(id) 
        ON DELETE CASCADE  -- æ•°æ®åº“è‡ªåŠ¨çº§è”
);

-- ä¼˜åŠ¿ï¼šæ€§èƒ½æ›´å¥½ï¼Œä¸€æ¬¡æ€§åˆ é™¤
-- åŠ£åŠ¿ï¼šJPAä¸çŸ¥é“åˆ é™¤äº†ä»€ä¹ˆï¼Œç¼“å­˜å¯èƒ½ä¸åŒæ­¥
```

### 6.4 æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜


**ğŸ”¸ ç›‘æ§æŒ‡æ ‡**
```java
@Aspect
@Component
public class DeletionMonitor {
    
    @Around("execution(* com.example.repository.*Repository.delete*(..))")
    public Object monitorDeletion(ProceedingJoinPoint pjp) throws Throwable {
        long start = System.currentTimeMillis();
        String method = pjp.getSignature().getName();
        
        try {
            Object result = pjp.proceed();
            long duration = System.currentTimeMillis() - start;
            
            // è®°å½•æ€§èƒ½
            if (duration > 1000) {  // è¶…è¿‡1ç§’
                log.warn("æ…¢åˆ é™¤: {} è€—æ—¶ {}ms", method, duration);
            }
            
            return result;
        } catch (Exception e) {
            log.error("åˆ é™¤å¤±è´¥: {}", method, e);
            throw e;
        }
    }
}
```

---

## 7. ğŸ¯ æœ€ä½³å®è·µæ€»ç»“


### 7.1 åˆ é™¤ç­–ç•¥å†³ç­–æ ‘


```
å¼€å§‹ï¼šéœ€è¦åˆ é™¤æ•°æ®
         â†“
    æ˜¯å¦æœ‰æ³•è§„è¦æ±‚ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ è½¯åˆ é™¤ + å®¡è®¡æ—¥å¿—
    â””â”€ å¦ â†“
         â†“
    æ˜¯å¦å¯èƒ½éœ€è¦æ¢å¤ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ è½¯åˆ é™¤
    â””â”€ å¦ â†“
         â†“
    æ•°æ®æ˜¯å¦æœ‰åˆ†æä»·å€¼ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ è½¯åˆ é™¤ + å®šæœŸå½’æ¡£
    â””â”€ å¦ â†“
         â†“
    æ˜¯å¦æœ‰å…³è”æ•°æ®ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ è¯„ä¼°çº§è”å½±å“ â†’ è°¨æ…ç‰©ç†åˆ é™¤
    â””â”€ å¦ â†’ ç‰©ç†åˆ é™¤
```

### 7.2 æ ¸å¿ƒè¦ç‚¹é€ŸæŸ¥


**ğŸ”¸ è½¯åˆ é™¤vsç‰©ç†åˆ é™¤**
```
è½¯åˆ é™¤ä¼˜å…ˆåœºæ™¯ï¼š
âœ… è®¢å•ã€äº¤æ˜“ç­‰é‡‘èæ•°æ®
âœ… ç”¨æˆ·ç”Ÿæˆå†…å®¹ï¼ˆå¸–å­ã€è¯„è®ºï¼‰
âœ… é…ç½®å’Œå…ƒæ•°æ®
âœ… éœ€è¦å®¡è®¡çš„ä¸šåŠ¡æ•°æ®

ç‰©ç†åˆ é™¤é€‚ç”¨åœºæ™¯ï¼š
âœ… ä¸´æ—¶æ•°æ®ã€ç¼“å­˜
âœ… æ—¥å¿—æ•°æ®ï¼ˆå·²å½’æ¡£çš„ï¼‰
âœ… æµ‹è¯•æ•°æ®
âœ… çœŸæ­£çš„åƒåœ¾æ•°æ®
```

**ğŸ”¸ çº§è”åˆ é™¤è§„åˆ™**
```
å®‰å…¨ä½¿ç”¨çº§è”ï¼š
âœ… å¼ºä¾èµ–å…³ç³»ï¼ˆè®¢å•â†’æ˜ç»†ï¼‰
âœ… å€¼å¯¹è±¡ï¼ˆç”¨æˆ·â†’åœ°å€ï¼‰
âœ… ç§æœ‰é™„ä»¶ï¼ˆæ–‡ç« â†’å›¾ç‰‡ï¼‰

ç¦æ­¢ä½¿ç”¨çº§è”ï¼š
âŒ å…±äº«å¼•ç”¨ï¼ˆè®¢å•â†’å•†å“ï¼‰
âŒ å¤šå¯¹å¤šå…³ç³»
âŒ å¯èƒ½éœ€è¦ç‹¬ç«‹å­˜åœ¨çš„æ•°æ®
```

**ğŸ”¸ orphanRemovalä½¿ç”¨**
```
æ¨èåœºæ™¯ï¼š
âœ… ä¸€å¯¹å¤šä¸”å­å®ä½“å®Œå…¨ä¾èµ–çˆ¶å®ä½“
âœ… é›†åˆå…ƒç´ ç§»é™¤æ—¶åº”è¯¥åˆ é™¤
âœ… å€¼å¯¹è±¡çš„é›†åˆ

é¿å…åœºæ™¯ï¼š
âŒ å¤šå¯¹å¤šå…³ç³»
âŒ å­å®ä½“å¯èƒ½è¢«å¤šä¸ªçˆ¶å®ä½“å¼•ç”¨
âŒ å­å®ä½“æœ‰ç‹¬ç«‹ä¸šåŠ¡ä»·å€¼
```

### 7.3 å®æ–½æ£€æŸ¥æ¸…å•


**ğŸ“‹ åˆ é™¤åŠŸèƒ½å¼€å‘æ¸…å•**

```
â–¡ ä¸šåŠ¡åˆ†æ
  â–¡ ç¡®å®šåˆ é™¤ç±»å‹ï¼ˆè½¯/ç¡¬ï¼‰
  â–¡ è¯„ä¼°å…³è”æ•°æ®å½±å“
  â–¡ ç¡®è®¤åˆè§„æ€§è¦æ±‚
  
â–¡ æŠ€æœ¯è®¾è®¡
  â–¡ è®¾è®¡åˆ é™¤æ ‡è®°å­—æ®µ
  â–¡ é…ç½®çº§è”ç­–ç•¥
  â–¡ è®¾è®¡å®¡è®¡æ—¥å¿—
  
â–¡ å®‰å…¨æªæ–½
  â–¡ åˆ é™¤å‰æ•°æ®æ ¡éªŒ
  â–¡ æƒé™æ§åˆ¶
  â–¡ è¯¯åˆ é˜²æŠ¤æœºåˆ¶
  
â–¡ æ€§èƒ½ä¼˜åŒ–
  â–¡ æ‰¹é‡æ“ä½œæ”¯æŒ
  â–¡ ç´¢å¼•ä¼˜åŒ–
  â–¡ å½’æ¡£ç­–ç•¥
  
â–¡ æµ‹è¯•éªŒè¯
  â–¡ å•å…ƒæµ‹è¯•
  â–¡ æ€§èƒ½æµ‹è¯•
  â–¡ æ•°æ®æ¢å¤æµ‹è¯•
```

### 7.4 å¸¸è§é”™è¯¯é¿å‘


**âŒ é”™è¯¯â‘ ï¼šç›²ç›®ä½¿ç”¨çº§è”åˆ é™¤**
```java
// é”™è¯¯
@OneToMany(cascade = CascadeType.ALL)
private List<Product> products;

// åæœï¼šåˆ é™¤åˆ†ç±»æ—¶æ‰€æœ‰å•†å“éƒ½æ²¡äº†ï¼
```

**âŒ é”™è¯¯â‘¡ï¼šå¿˜è®°åŒå‘åŒæ­¥**
```java
// é”™è¯¯
order.getItems().remove(item);
// item.setOrder(null);  // å¿˜è®°åŒæ­¥

// åæœï¼šorphanRemovalå¯èƒ½è¡Œä¸ºå¼‚å¸¸
```

**âŒ é”™è¯¯â‘¢ï¼šè½¯åˆ é™¤æ²¡æœ‰è¿‡æ»¤**
```java
// é”™è¯¯
@Query("SELECT u FROM User u WHERE u.age > :age")
// å¿˜è®°åŠ  AND u.deleted = false

// åæœï¼šæŸ¥å‡ºå·²åˆ é™¤çš„ç”¨æˆ·
```

**âœ… æ­£ç¡®åšæ³•**
```java
// 1. è°¨æ…çº§è”ï¼Œä¼˜å…ˆæ˜¾å¼å¤„ç†
@OneToMany(mappedBy = "category")
private List<Product> products;

// 2. å°è£…åŒå‘åŒæ­¥æ–¹æ³•
public void removeItem(OrderItem item) {
    this.items.remove(item);
    item.setOrder(null);
}

// 3. ä½¿ç”¨@Whereè‡ªåŠ¨è¿‡æ»¤
@Entity
@Where(clause = "deleted = false")
public class User { }
```

### 7.5 æ ¸å¿ƒè®°å¿†å£è¯€


```
ğŸ“ åˆ é™¤ç­–ç•¥è®°å¿†æ³•ï¼š

è½¯ç¡¬é€‰æ‹©çœ‹éœ€æ±‚ï¼Œ
åˆè§„å®¡è®¡å¿…è½¯åˆ ã€‚

çº§è”åˆ é™¤éœ€è°¨æ…ï¼Œ
å¼ºä¾èµ–æ‰å¯çº§è”ã€‚

å­¤å„¿åˆ é™¤æ˜¯åˆ©å™¨ï¼Œ
å€¼å¯¹è±¡é‡Œæœ€åˆé€‚ã€‚

æ€§èƒ½ç›‘æ§ä¸èƒ½å¿˜ï¼Œ
å½’æ¡£ç­–ç•¥é˜²è†¨èƒ€ã€‚

åˆ å‰æ£€æŸ¥è¦ä»”ç»†ï¼Œ
æ¢å¤æ–¹æ¡ˆæå‰å¤‡ã€‚
```

---

## ğŸ’¡ æ€»ç»“


**æ ¸å¿ƒè¦ç‚¹å›é¡¾**

1. **åˆ é™¤ç±»å‹é€‰æ‹©**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚ã€åˆè§„è¦æ±‚ã€æ€§èƒ½è€ƒé‡ç»¼åˆå†³ç­–
2. **çº§è”åˆ é™¤**ï¼šç†è§£è§¦å‘æ—¶æœºï¼Œè¯„ä¼°é£é™©ï¼Œè°¨æ…é…ç½®
3. **orphanRemoval**ï¼šé€‚ç”¨äºå¼ºä¾èµ–å…³ç³»ï¼Œæ³¨æ„åŒå‘åŒæ­¥
4. **å®¡è®¡æ¢å¤**ï¼šé‡è¦æ•°æ®å¿…é¡»ç•™ç—•ï¼Œè®¾è®¡æ¢å¤æœºåˆ¶
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹é‡æ“ä½œã€å»¶è¿Ÿåˆ é™¤ã€å®šæœŸå½’æ¡£

**å®è·µå»ºè®®**

- ğŸ¯ é»˜è®¤ä½¿ç”¨è½¯åˆ é™¤ï¼Œé™¤éæœ‰å……åˆ†ç†ç”±
- ğŸ¯ çº§è”åˆ é™¤ä»…ç”¨äºå¼ºä¾èµ–å…³ç³»
- ğŸ¯ é‡è¦æ•°æ®å¿…é¡»æœ‰å®¡è®¡å’Œæ¢å¤æœºåˆ¶
- ğŸ¯ å®šæœŸç›‘æ§æ€§èƒ½ï¼ŒåŠæ—¶å½’æ¡£å†å²æ•°æ®
- ğŸ¯ åˆ é™¤æ“ä½œå‰å¿…é¡»åšå……åˆ†éªŒè¯

è®°ä½ï¼šåˆ é™¤æ˜¯ä¸å¯é€†çš„æ“ä½œï¼Œè°¨æ…è®¾è®¡ã€å……åˆ†æµ‹è¯•ã€åšå¥½å¤‡ä»½ï¼