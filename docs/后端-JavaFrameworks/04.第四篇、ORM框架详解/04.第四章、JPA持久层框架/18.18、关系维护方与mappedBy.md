---
title: 18ã€å…³ç³»ç»´æŠ¤æ–¹ä¸mappedBy
---
## ğŸ“š ç›®å½•

1. [å…³ç³»ç»´æŠ¤çš„æœ¬è´¨é—®é¢˜](#1-å…³ç³»ç»´æŠ¤çš„æœ¬è´¨é—®é¢˜)
2. [æ‹¥æœ‰æ–¹ä¸è¢«æ‹¥æœ‰æ–¹](#2-æ‹¥æœ‰æ–¹ä¸è¢«æ‹¥æœ‰æ–¹)
3. [mappedByè¯¦è§£](#3-mappedByè¯¦è§£)
4. [å…³ç³»ä¸€è‡´æ€§ç»´æŠ¤](#4-å…³ç³»ä¸€è‡´æ€§ç»´æŠ¤)
5. [Helperæ–¹æ³•æœ€ä½³å®è·µ](#5-Helperæ–¹æ³•æœ€ä½³å®è·µ)
6. [å¸¸è§é—®é¢˜ä¸è§£å†³](#6-å¸¸è§é—®é¢˜ä¸è§£å†³)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤” å…³ç³»ç»´æŠ¤çš„æœ¬è´¨é—®é¢˜


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦å…³ç³»ç»´æŠ¤


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ å’Œæœ‹å‹çš„å…³ç³»

```
ç°å®ç”Ÿæ´»ä¸­ï¼š
ä½  â†â†’ æœ‹å‹
- ä½ è¯´"æˆ‘ä»¬æ˜¯æœ‹å‹"
- æœ‹å‹ä¹Ÿè¯´"æˆ‘ä»¬æ˜¯æœ‹å‹"
- éœ€è¦åŒæ–¹éƒ½è®¤å¯å…³ç³»æ‰æˆç«‹

æ•°æ®åº“ä¸­çš„é—®é¢˜ï¼š
å­¦ç”Ÿè¡¨          è¯¾ç¨‹è¡¨
id  name       id  name
1   å¼ ä¸‰       101 Java

é€‰è¯¾è¡¨ï¼ˆå…³è”è¡¨ï¼‰
student_id  course_id
1           101

é—®é¢˜ï¼šè°æ¥è´Ÿè´£ç»´æŠ¤è¿™ä¸ªå…³è”è¡¨çš„æ•°æ®ï¼Ÿ
```

### 1.2 åŒå‘å…³è”çš„å›°å¢ƒ


**æ ¸å¿ƒé—®é¢˜**ï¼šåœ¨åŒå‘å…³è”ä¸­ï¼Œå¦‚æœä¸¤è¾¹éƒ½å¯ä»¥ä¿®æ”¹å…³ç³»ï¼Œä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ

```
å­¦ç”Ÿå®ä½“                è¯¾ç¨‹å®ä½“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Student  â”‚          â”‚ Course   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id       â”‚          â”‚ id       â”‚
â”‚ name     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ name     â”‚
â”‚ courses  â”‚  åŒå‘å…³è”  â”‚ students â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¦‚æœä¸¤è¾¹éƒ½èƒ½ç»´æŠ¤å…³ç³»ï¼š
student.addCourse(course);  // å­¦ç”Ÿè¿™è¾¹æ·»åŠ 
course.addStudent(student); // è¯¾ç¨‹é‚£è¾¹ä¹Ÿæ·»åŠ 

ä¼šå¯¼è‡´ï¼š
âŒ å¤–é”®å¯èƒ½è¢«å†™å…¥ä¸¤æ¬¡
âŒ æ•°æ®ä¸ä¸€è‡´
âŒ ä¸çŸ¥é“ä»¥è°çš„æ•°æ®ä¸ºå‡†
```

**å®é™…é—®é¢˜æ¼”ç¤º**ï¼š

```java
// é”™è¯¯ç¤ºä¾‹ï¼šä¸¤è¾¹éƒ½å°è¯•ç»´æŠ¤å…³ç³»
Student student = new Student("å¼ ä¸‰");
Course course = new Course("Java");

// å­¦ç”Ÿè¿™è¾¹æ·»åŠ è¯¾ç¨‹
student.getCourses().add(course);

// è¯¾ç¨‹é‚£è¾¹ä¹Ÿæ·»åŠ å­¦ç”Ÿ
course.getStudents().add(student);

// ä¿å­˜æ—¶å¯èƒ½å‡ºç°ï¼š
// 1. å¤–é”®é‡å¤æ’å…¥
// 2. å†²çªé”™è¯¯
// 3. æ•°æ®ä¸ä¸€è‡´
```

### 1.3 è§£å†³æ–¹æ¡ˆï¼šå•å‘ç»´æŠ¤


**JPAçš„è§£å†³æ€è·¯**ï¼šæ˜ç¡®æŒ‡å®šåªæœ‰ä¸€æ–¹è´Ÿè´£ç»´æŠ¤å…³ç³»

```
æŒ‡å®š"æ‹¥æœ‰æ–¹"ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Student  â”‚          â”‚ Course   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ courses  â”‚â—„â”€â”€â”€â”€Xâ”€â”€â”€â”€â”‚ students â”‚
â”‚ (æ‹¥æœ‰æ–¹)  â”‚  åªæœ‰è¿™è¾¹  â”‚(è¢«æ‹¥æœ‰æ–¹) â”‚
â”‚ ç»´æŠ¤å…³ç³»  â”‚  ç»´æŠ¤å¤–é”®  â”‚ åªè¯»å…³ç³» â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åªæœ‰æ‹¥æœ‰æ–¹çš„ä¿®æ”¹ä¼šå½±å“æ•°æ®åº“ï¼
```

---

## 2. ğŸ‘‘ æ‹¥æœ‰æ–¹ä¸è¢«æ‹¥æœ‰æ–¹


### 2.1 æ‹¥æœ‰æ–¹ï¼ˆOwning Sideï¼‰çš„å«ä¹‰


**é€šä¿—è§£é‡Š**ï¼šæ‹¥æœ‰æ–¹å°±æ˜¯"è´Ÿè´£ç®¡ç†å…³ç³»"çš„é‚£ä¸€æ–¹

```
æ¯”å–»ç†è§£ï¼š
å‡è®¾æœ‰ä¸ª"å…³ç³»ç™»è®°å¤„"ï¼ˆæ•°æ®åº“çš„å…³è”è¡¨ï¼‰
æ‹¥æœ‰æ–¹ = æœ‰æƒåˆ©å»ç™»è®°å¤„ç™»è®°/ä¿®æ”¹å…³ç³»çš„äºº
è¢«æ‹¥æœ‰æ–¹ = åªèƒ½æŸ¥çœ‹å…³ç³»ï¼Œä¸èƒ½ä¿®æ”¹çš„äºº

æ•°æ®åº“å±‚é¢ï¼š
æ‹¥æœ‰æ–¹ = æ§åˆ¶å¤–é”®åˆ—çš„æ›´æ–°
è¢«æ‹¥æœ‰æ–¹ = ä¸å½±å“å¤–é”®åˆ—
```

**å…³é”®ç‰¹å¾**ï¼š

| ç‰¹å¾ | æ‹¥æœ‰æ–¹ | è¢«æ‹¥æœ‰æ–¹ |
|------|--------|----------|
| **å¤–é”®æ§åˆ¶** | âœ… å¯ä»¥æ›´æ–°å¤–é”® | âŒ ä¸å½±å“å¤–é”® |
| **å…³ç³»ç»´æŠ¤** | âœ… ä¿®æ”¹ä¼šåŒæ­¥åˆ°æ•°æ®åº“ | âŒ ä¿®æ”¹åªåœ¨å†…å­˜ä¸­ |
| **æ˜ å°„é…ç½®** | `@JoinColumn` æˆ– `@JoinTable` | `mappedBy` å±æ€§ |
| **ä¿å­˜é€»è¾‘** | å¿…é¡»ä¿å­˜æ‰èƒ½å»ºç«‹å…³ç³» | å¯é€‰ä¿å­˜ |

### 2.2 å¦‚ä½•é€‰æ‹©æ‹¥æœ‰æ–¹


**é€‰æ‹©åŸåˆ™**ï¼š

```
1ï¸âƒ£ ä¸€å¯¹å¤šå…³ç³»ï¼š
   ä¼˜å…ˆé€‰æ‹©"å¤š"çš„ä¸€æ–¹ä½œä¸ºæ‹¥æœ‰æ–¹
   åŸå› ï¼šå¤šçš„ä¸€æ–¹å¤©ç„¶æŒæœ‰å¤–é”®
   
   éƒ¨é—¨(1) â†â†’ å‘˜å·¥(N)
   âœ… æ¨èï¼šå‘˜å·¥ä½œä¸ºæ‹¥æœ‰æ–¹
   âŒ ä¸æ¨èï¼šéƒ¨é—¨ä½œä¸ºæ‹¥æœ‰æ–¹

2ï¸âƒ£ å¤šå¯¹å¤šå…³ç³»ï¼š
   é€‰æ‹©ä¸šåŠ¡ä¸Š"ä¸»åŠ¨"çš„ä¸€æ–¹
   
   å­¦ç”Ÿ â†â†’ è¯¾ç¨‹
   å¦‚æœæ˜¯"å­¦ç”Ÿé€‰è¯¾"ï¼šå­¦ç”Ÿæ˜¯æ‹¥æœ‰æ–¹
   å¦‚æœæ˜¯"è¯¾ç¨‹æ‹›ç”Ÿ"ï¼šè¯¾ç¨‹æ˜¯æ‹¥æœ‰æ–¹

3ï¸âƒ£ ä¸€å¯¹ä¸€å…³ç³»ï¼š
   é€‰æ‹©æŒæœ‰å¤–é”®çš„ä¸€æ–¹
   
   ç”¨æˆ· â†â†’ èº«ä»½è¯
   å¤–é”®åœ¨å“ªä¸ªè¡¨ï¼Œå“ªä¸ªå°±æ˜¯æ‹¥æœ‰æ–¹
```

### 2.3 æ‹¥æœ‰æ–¹çš„å®é™…æ„ä¹‰


**ä»£ç å±‚é¢çš„å·®å¼‚**ï¼š

```java
// åœºæ™¯ï¼šå­¦ç”Ÿé€‰è¯¾ï¼ˆå­¦ç”Ÿæ˜¯æ‹¥æœ‰æ–¹ï¼‰

// âœ… æ‹¥æœ‰æ–¹æ“ä½œ - ä¼šå½±å“æ•°æ®åº“
Student student = new Student("å¼ ä¸‰");
Course course = new Course("Java");

student.getCourses().add(course);  // è¿™ä¸ªæ“ä½œæœ‰æ•ˆï¼
entityManager.persist(student);
// æ•°æ®åº“ä¼šæ’å…¥ï¼šstudent_courseè¡¨çš„è®°å½•

// âŒ è¢«æ‹¥æœ‰æ–¹æ“ä½œ - ä¸å½±å“æ•°æ®åº“
course.getStudents().add(student); // è¿™ä¸ªæ“ä½œæ— æ•ˆï¼
entityManager.persist(course);
// æ•°æ®åº“ä¸ä¼šæœ‰ä»»ä½•å˜åŒ–
```

---

## 3. ğŸ”— mappedByè¯¦è§£


### 3.1 mappedByæ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼š`mappedBy`å°±æ˜¯ä¸€ä¸ª"æŒ‡è·¯ç‰Œ"ï¼Œå‘Šè¯‰JPA"è¿™ä¸ªå…³ç³»å·²ç»è¢«å¦ä¸€è¾¹ç®¡ç†äº†"

```
mappedByçš„å«ä¹‰ï¼š
mapped = è¢«æ˜ å°„
By = é€šè¿‡ã€ç”±

mappedBy = "ç”±XXXå­—æ®µæ˜ å°„"
æ„æ€æ˜¯ï¼šè¿™ä¸ªå…³ç³»å·²ç»è¢«å¯¹æ–¹çš„XXXå­—æ®µç®¡ç†äº†ï¼Œæˆ‘è¿™è¾¹åªæ˜¯"åå‘å¼•ç”¨"
```

**è¯­æ³•æ ¼å¼**ï¼š

```java
@OneToMany(mappedBy = "å¯¹æ–¹å®ä½“ä¸­æŒ‡å‘æˆ‘çš„å­—æ®µå")
```

### 3.2 mappedByçš„ä½¿ç”¨åœºæ™¯


**ä¸€å¯¹å¤šå…³ç³»ç¤ºä¾‹**ï¼š

```java
// éƒ¨é—¨å®ä½“ï¼ˆä¸€æ–¹ - è¢«æ‹¥æœ‰æ–¹ï¼‰
@Entity
public class Department {
    @Id
    private Long id;
    private String name;
    
    // â­ mappedByæŒ‡å‘Employeeä¸­çš„departmentå­—æ®µ
    @OneToMany(mappedBy = "department")
    private List<Employee> employees;
}

// å‘˜å·¥å®ä½“ï¼ˆå¤šæ–¹ - æ‹¥æœ‰æ–¹ï¼‰
@Entity
public class Employee {
    @Id
    private Long id;
    private String name;
    
    // â­ è¿™æ˜¯çœŸæ­£æ§åˆ¶å¤–é”®çš„å­—æ®µ
    @ManyToOne
    @JoinColumn(name = "dept_id")
    private Department department;
}
```

**å¯¹åº”å…³ç³»å›¾**ï¼š

```
æ•°æ®åº“è¡¨ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ department  â”‚          â”‚ employee    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)     â”‚â—„â”€â”€â”€â”€â”    â”‚ id (PK)     â”‚
â”‚ name        â”‚     â””â”€â”€â”€â”€â”‚ dept_id(FK) â”‚â† å¤–é”®åœ¨è¿™é‡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ name        â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®ä½“å…³ç³»ï¼š
Department.employees â”€â”€mappedByâ”€â”€â–º Employee.department
      (è¢«æ‹¥æœ‰æ–¹)                         (æ‹¥æœ‰æ–¹)
```

**å¤šå¯¹å¤šå…³ç³»ç¤ºä¾‹**ï¼š

```java
// å­¦ç”Ÿå®ä½“ï¼ˆæ‹¥æœ‰æ–¹ï¼‰
@Entity
public class Student {
    @Id
    private Long id;
    
    @ManyToMany
    @JoinTable(
        name = "student_course",
        joinColumns = @JoinColumn(name = "student_id"),
        inverseJoinColumns = @JoinColumn(name = "course_id")
    )
    private Set<Course> courses;
}

// è¯¾ç¨‹å®ä½“ï¼ˆè¢«æ‹¥æœ‰æ–¹ï¼‰
@Entity
public class Course {
    @Id
    private Long id;
    
    // â­ mappedByæŒ‡å‘Studentä¸­çš„courseså­—æ®µ
    @ManyToMany(mappedBy = "courses")
    private Set<Student> students;
}
```

### 3.3 mappedByå¸¸è§é”™è¯¯


**âŒ é”™è¯¯1ï¼šä¸¤è¾¹éƒ½ä¸å†™mappedBy**

```java
// é”™è¯¯ç¤ºä¾‹
@Entity
public class Author {
    @OneToMany
    @JoinColumn(name = "author_id")  // é”™è¯¯ï¼ä¸¤è¾¹éƒ½æƒ³æ§åˆ¶
    private List<Book> books;
}

@Entity
public class Book {
    @ManyToOne
    @JoinColumn(name = "author_id")  // é”™è¯¯ï¼ä¸¤è¾¹éƒ½æƒ³æ§åˆ¶
    private Author author;
}

// åæœï¼šJPAä¼šåˆ›å»ºé¢å¤–çš„ä¸­é—´è¡¨ï¼Œæ•°æ®æ··ä¹±
```

**âŒ é”™è¯¯2ï¼šä¸¤è¾¹éƒ½å†™mappedBy**

```java
// é”™è¯¯ç¤ºä¾‹
@Entity
public class Student {
    @ManyToMany(mappedBy = "students")  // é”™è¯¯ï¼
    private Set<Course> courses;
}

@Entity  
public class Course {
    @ManyToMany(mappedBy = "courses")   // é”™è¯¯ï¼
    private Set<Student> students;
}

// åæœï¼šæ²¡æœ‰æ‹¥æœ‰æ–¹ï¼Œå…³ç³»æ— æ³•å»ºç«‹
```

**âŒ é”™è¯¯3ï¼šmappedByå€¼å†™é”™**

```java
// é”™è¯¯ç¤ºä¾‹
@Entity
public class Department {
    @OneToMany(mappedBy = "dept")  // é”™è¯¯ï¼åº”è¯¥æ˜¯"department"
    private List<Employee> employees;
}

@Entity
public class Employee {
    @ManyToOne
    private Department department;  // å­—æ®µåæ˜¯departmentï¼Œä¸æ˜¯dept
}

// åæœï¼šå¯åŠ¨æ—¶æŠ¥é”™ï¼Œæ‰¾ä¸åˆ°æ˜ å°„å­—æ®µ
```

**âœ… è®°å¿†æŠ€å·§**ï¼š

```
mappedByå¡«å†™å£è¯€ï¼š
1. åªæœ‰è¢«æ‹¥æœ‰æ–¹æ‰å†™mappedBy
2. mappedByçš„å€¼ = å¯¹æ–¹å®ä½“ä¸­æŒ‡å‘æˆ‘çš„å­—æ®µå
3. ä¸€å¯¹å¤šï¼šä¸€çš„è¿™è¾¹å†™mappedBy
4. å¤šå¯¹å¤šï¼šé€‰ä¸€è¾¹å†™mappedBy
5. mappedByå’Œ@JoinColumn/@JoinTableäº’æ–¥
```

---

## 4. ğŸ”„ å…³ç³»ä¸€è‡´æ€§ç»´æŠ¤


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦å…³ç³»ä¸€è‡´æ€§


**é—®é¢˜åœºæ™¯**ï¼šåªåœ¨æ‹¥æœ‰æ–¹æ·»åŠ å…³ç³»

```java
// å­¦ç”Ÿæ˜¯æ‹¥æœ‰æ–¹
Student student = new Student("å¼ ä¸‰");
Course course = new Course("Java");

// åªåœ¨æ‹¥æœ‰æ–¹æ·»åŠ 
student.getCourses().add(course);
entityManager.persist(student);

// æ•°æ®åº“ï¼šâœ… å…³ç³»å·²å»ºç«‹
// ä½†æ˜¯ï¼šâŒ course.getStudents()æ˜¯ç©ºçš„ï¼

System.out.println(course.getStudents().size()); // è¾“å‡ºï¼š0
```

**é—®é¢˜æœ¬è´¨**ï¼š

```
æ•°æ®åº“å±‚é¢ï¼šå…³ç³»å·²å»ºç«‹ âœ…
å†…å­˜å¯¹è±¡å±‚é¢ï¼šå…³ç³»ä¸å®Œæ•´ âŒ

student.courses åŒ…å« course âœ…
course.students ä¸åŒ…å« student âŒ

è¿™ä¼šå¯¼è‡´ï¼š
- ä¸šåŠ¡é€»è¾‘é”™è¯¯
- æ•°æ®å±•ç¤ºä¸ä¸€è‡´  
- éš¾ä»¥è°ƒè¯•çš„bug
```

### 4.2 åŒæ­¥æ›´æ–°çš„å¿…è¦æ€§


**æœ€ä½³å®è·µ**ï¼šåŒæ—¶æ›´æ–°åŒæ–¹çš„é›†åˆ

```java
// âœ… æ­£ç¡®åšæ³•ï¼šåŒå‘åŒæ­¥
Student student = new Student("å¼ ä¸‰");
Course course = new Course("Java");

// 1. æ‹¥æœ‰æ–¹æ·»åŠ ï¼ˆå½±å“æ•°æ®åº“ï¼‰
student.getCourses().add(course);

// 2. è¢«æ‹¥æœ‰æ–¹ä¹Ÿæ·»åŠ ï¼ˆä¿æŒå†…å­˜ä¸€è‡´ï¼‰
course.getStudents().add(student);

// ç°åœ¨ä¸¤è¾¹éƒ½æ˜¯ä¸€è‡´çš„
System.out.println(student.getCourses().contains(course)); // true
System.out.println(course.getStudents().contains(student)); // true
```

**å¯¹æ¯”å›¾ç¤º**ï¼š

```
åªæ›´æ–°æ‹¥æœ‰æ–¹ï¼š
Studentå†…å­˜    æ•°æ®åº“       Courseå†…å­˜
[Course A] â”€â”€å†™å…¥â”€â”€â–º [å…³è”è®°å½•] âœ…  []  â† ä¸ä¸€è‡´ï¼

åŒå‘æ›´æ–°ï¼š
Studentå†…å­˜    æ•°æ®åº“       Courseå†…å­˜  
[Course A] â”€â”€å†™å…¥â”€â”€â–º [å…³è”è®°å½•] âœ…  [Student A] âœ…
   â†‘                                   â†‘
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å†…å­˜ä¸€è‡´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 äº‹åŠ¡ä¸­çš„ä¸€è‡´æ€§


**æ³¨æ„äº‹é¡¹**ï¼š

```java
@Transactional
public void enrollStudent(Long studentId, Long courseId) {
    Student student = studentRepo.findById(studentId).get();
    Course course = courseRepo.findById(courseId).get();
    
    // âš ï¸ å¦‚æœåªæ›´æ–°ä¸€æ–¹
    student.getCourses().add(course);
    
    // åœ¨åŒä¸€ä¸ªäº‹åŠ¡å†…æŸ¥è¯¢
    entityManager.flush();  // å¼ºåˆ¶åŒæ­¥åˆ°æ•°æ®åº“
    entityManager.clear();  // æ¸…ç©ºç¼“å­˜
    
    // é‡æ–°åŠ è½½
    course = courseRepo.findById(courseId).get();
    System.out.println(course.getStudents().size()); 
    // ç°åœ¨èƒ½çœ‹åˆ°äº†ï¼Œä½†è¿™å¾ˆä½æ•ˆï¼
}
```

**âœ… æ­£ç¡®åšæ³•**ï¼šä½¿ç”¨Helperæ–¹æ³•ç»Ÿä¸€ç®¡ç†

---

## 5. ğŸ› ï¸ Helperæ–¹æ³•æœ€ä½³å®è·µ


### 5.1 Helperæ–¹æ³•çš„ä½œç”¨


**æ ¸å¿ƒç›®çš„**ï¼šå°†å…³ç³»ç»´æŠ¤é€»è¾‘å°è£…èµ·æ¥ï¼Œé¿å…é—æ¼

```java
/**
 * Helperæ–¹æ³•çš„ä¸‰å¤§èŒè´£ï¼š
 * 1. ç»´æŠ¤æ‹¥æœ‰æ–¹çš„å…³ç³»ï¼ˆå½±å“æ•°æ®åº“ï¼‰
 * 2. ç»´æŠ¤è¢«æ‹¥æœ‰æ–¹çš„å…³ç³»ï¼ˆä¿æŒå†…å­˜ä¸€è‡´ï¼‰
 * 3. é˜²å¾¡æ€§æ£€æŸ¥ï¼ˆé¿å…ç©ºæŒ‡é’ˆã€é‡å¤æ·»åŠ ç­‰ï¼‰
 */
```

### 5.2 ä¸€å¯¹å¤šå…³ç³»çš„Helperæ–¹æ³•


**æ ‡å‡†æ¨¡æ¿**ï¼š

```java
@Entity
public class Department {
    @Id
    private Long id;
    
    @OneToMany(mappedBy = "department")
    private List<Employee> employees = new ArrayList<>();
    
    // â­ æ·»åŠ å‘˜å·¥çš„Helperæ–¹æ³•
    public void addEmployee(Employee employee) {
        // 1. é˜²å¾¡æ€§æ£€æŸ¥
        if (employee == null) {
            return;
        }
        
        // 2. é¿å…é‡å¤æ·»åŠ 
        if (this.employees.contains(employee)) {
            return;
        }
        
        // 3. æ·»åŠ åˆ°æœ¬æ–¹é›†åˆ
        this.employees.add(employee);
        
        // 4. è®¾ç½®å¯¹æ–¹çš„å¼•ç”¨ï¼ˆæ‹¥æœ‰æ–¹ï¼‰
        employee.setDepartment(this);
    }
    
    // â­ ç§»é™¤å‘˜å·¥çš„Helperæ–¹æ³•
    public void removeEmployee(Employee employee) {
        if (employee == null) {
            return;
        }
        
        this.employees.remove(employee);
        employee.setDepartment(null);  // æ–­å¼€å…³ç³»
    }
}

@Entity
public class Employee {
    @Id
    private Long id;
    
    @ManyToOne
    @JoinColumn(name = "dept_id")
    private Department department;
    
    // â­ ä¹Ÿå¯ä»¥åœ¨è¿™è¾¹æä¾›Helperæ–¹æ³•
    public void setDepartment(Department department) {
        // 1. å¦‚æœä¹‹å‰æœ‰éƒ¨é—¨ï¼Œå…ˆä»æ—§éƒ¨é—¨ç§»é™¤
        if (this.department != null) {
            this.department.getEmployees().remove(this);
        }
        
        // 2. è®¾ç½®æ–°éƒ¨é—¨
        this.department = department;
        
        // 3. æ·»åŠ åˆ°æ–°éƒ¨é—¨çš„å‘˜å·¥åˆ—è¡¨
        if (department != null && !department.getEmployees().contains(this)) {
            department.getEmployees().add(this);
        }
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
Department dept = new Department("æŠ€æœ¯éƒ¨");
Employee emp = new Employee("å¼ ä¸‰");

// åªéœ€è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼ŒåŒå‘å…³ç³»è‡ªåŠ¨ç»´æŠ¤
dept.addEmployee(emp);

// éªŒè¯
System.out.println(dept.getEmployees().contains(emp));  // true
System.out.println(emp.getDepartment() == dept);        // true
```

### 5.3 å¤šå¯¹å¤šå…³ç³»çš„Helperæ–¹æ³•


**å­¦ç”Ÿ-è¯¾ç¨‹ç¤ºä¾‹**ï¼š

```java
@Entity
public class Student {
    @Id
    private Long id;
    
    @ManyToMany
    @JoinTable(
        name = "student_course",
        joinColumns = @JoinColumn(name = "student_id"),
        inverseJoinColumns = @JoinColumn(name = "course_id")
    )
    private Set<Course> courses = new HashSet<>();
    
    // â­ é€‰è¯¾æ–¹æ³•
    public void enrollCourse(Course course) {
        if (course == null) {
            throw new IllegalArgumentException("è¯¾ç¨‹ä¸èƒ½ä¸ºç©º");
        }
        
        // åŒå‘æ·»åŠ 
        this.courses.add(course);
        course.getStudents().add(this);
    }
    
    // â­ é€€è¯¾æ–¹æ³•
    public void dropCourse(Course course) {
        if (course == null) {
            return;
        }
        
        this.courses.remove(course);
        course.getStudents().remove(this);
    }
}

@Entity
public class Course {
    @Id
    private Long id;
    
    @ManyToMany(mappedBy = "courses")
    private Set<Student> students = new HashSet<>();
    
    // Getteræ–¹æ³•
    public Set<Student> getStudents() {
        return students;
    }
}
```

### 5.4 Helperæ–¹æ³•çš„é«˜çº§æŠ€å·§


**æŠ€å·§1ï¼šé˜²æ­¢å¾ªç¯è°ƒç”¨**

```java
@Entity
public class Author {
    @OneToMany(mappedBy = "author")
    private List<Book> books = new ArrayList<>();
    
    public void addBook(Book book) {
        if (book == null || this.books.contains(book)) {
            return;
        }
        
        this.books.add(book);
        
        // âš ï¸ æ£€æŸ¥æ˜¯å¦å·²ç»è®¾ç½®ï¼Œé¿å…å¾ªç¯
        if (book.getAuthor() != this) {
            book.setAuthor(this);  // è¿™é‡Œå¯èƒ½å†æ¬¡è°ƒç”¨addBook
        }
    }
}
```

**æŠ€å·§2ï¼šçº§è”ä¿å­˜æç¤º**

```java
@Entity
public class Order {
    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
    private List<OrderItem> items = new ArrayList<>();
    
    public void addItem(OrderItem item) {
        this.items.add(item);
        item.setOrder(this);
        
        // ğŸ’¡ æç¤ºï¼šå¦‚æœé…ç½®äº†cascadeï¼Œä¿å­˜Orderä¼šè‡ªåŠ¨ä¿å­˜Item
    }
}
```

**æŠ€å·§3ï¼šä¸šåŠ¡æ ¡éªŒé›†æˆ**

```java
@Entity
public class Student {
    private static final int MAX_COURSES = 10;
    
    @ManyToMany
    private Set<Course> courses = new HashSet<>();
    
    public void enrollCourse(Course course) {
        // ä¸šåŠ¡è§„åˆ™æ ¡éªŒ
        if (courses.size() >= MAX_COURSES) {
            throw new BusinessException("é€‰è¯¾æ•°é‡å·²è¾¾ä¸Šé™");
        }
        
        if (courses.contains(course)) {
            throw new BusinessException("å·²ç»é€‰è¿‡è¿™é—¨è¯¾äº†");
        }
        
        this.courses.add(course);
        course.getStudents().add(this);
    }
}
```

---

## 6. âš ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³


### 6.1 é—®é¢˜1ï¼šå…³ç³»æ²¡æœ‰ä¿å­˜åˆ°æ•°æ®åº“


**ç—‡çŠ¶**ï¼š

```java
Student student = new Student("å¼ ä¸‰");
Course course = new Course("Java");

course.getStudents().add(student);  // Courseæ˜¯è¢«æ‹¥æœ‰æ–¹
entityManager.persist(course);

// æ•°æ®åº“ï¼šâŒ æ²¡æœ‰å…³è”è®°å½•
```

**åŸå› åˆ†æ**ï¼š

```
Courseè¢«æ ‡è®°ä¸ºè¢«æ‹¥æœ‰æ–¹(mappedBy)
â†’ Courseçš„ä¿®æ”¹ä¸å½±å“æ•°æ®åº“
â†’ åªæœ‰Student(æ‹¥æœ‰æ–¹)çš„ä¿®æ”¹æ‰æœ‰æ•ˆ
```

**âœ… è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// æ–¹æ¡ˆ1ï¼šåœ¨æ‹¥æœ‰æ–¹æ“ä½œ
student.getCourses().add(course);
entityManager.persist(student);

// æ–¹æ¡ˆ2ï¼šä½¿ç”¨Helperæ–¹æ³•
student.enrollCourse(course);  // è‡ªåŠ¨åŒå‘ç»´æŠ¤
entityManager.persist(student);
```

### 6.2 é—®é¢˜2ï¼šåŒå‘å…³ç³»ä¸ä¸€è‡´


**ç—‡çŠ¶**ï¼š

```java
student.getCourses().add(course);  // åªæ›´æ–°ä¸€è¾¹

System.out.println(student.getCourses().contains(course)); // true
System.out.println(course.getStudents().contains(student)); // false âŒ
```

**åŸå› åˆ†æ**ï¼š

```
åªç»´æŠ¤äº†æ‹¥æœ‰æ–¹ â†’ æ•°æ®åº“æ­£ç¡®
æ²¡ç»´æŠ¤è¢«æ‹¥æœ‰æ–¹ â†’ å†…å­˜å¯¹è±¡ä¸ä¸€è‡´
```

**âœ… è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// ä½¿ç”¨Helperæ–¹æ³•å¼ºåˆ¶åŒå‘ç»´æŠ¤
public void enrollCourse(Course course) {
    this.courses.add(course);      // æ‹¥æœ‰æ–¹
    course.getStudents().add(this); // è¢«æ‹¥æœ‰æ–¹
}
```

### 6.3 é—®é¢˜3ï¼šçº§è”åˆ é™¤å¯¼è‡´æ•°æ®ä¸¢å¤±


**ç—‡çŠ¶**ï¼š

```java
@OneToMany(mappedBy = "department", cascade = CascadeType.ALL)
private List<Employee> employees;

// åˆ é™¤éƒ¨é—¨
entityManager.remove(department);
// ç»“æœï¼šæ‰€æœ‰å‘˜å·¥ä¹Ÿè¢«åˆ é™¤äº†ï¼âŒ
```

**åŸå› åˆ†æ**ï¼š

```
CascadeType.ALL åŒ…å« REMOVE
åˆ é™¤éƒ¨é—¨ â†’ çº§è”åˆ é™¤æ‰€æœ‰å‘˜å·¥
```

**âœ… è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// æ–¹æ¡ˆ1ï¼šè°ƒæ•´çº§è”ç­–ç•¥
@OneToMany(mappedBy = "department", 
    cascade = {CascadeType.PERSIST, CascadeType.MERGE})

// æ–¹æ¡ˆ2ï¼šåˆ é™¤å‰è§£é™¤å…³ç³»
public void deleteDepartment(Department dept) {
    // å…ˆè§£é™¤æ‰€æœ‰å‘˜å·¥å…³ç³»
    for (Employee emp : new ArrayList<>(dept.getEmployees())) {
        dept.removeEmployee(emp);
    }
    // å†åˆ é™¤éƒ¨é—¨
    entityManager.remove(dept);
}
```

### 6.4 é—®é¢˜4ï¼šæ‡’åŠ è½½å¼‚å¸¸


**ç—‡çŠ¶**ï¼š

```java
@Transactional
public Course getCourse(Long id) {
    return courseRepo.findById(id).get();
}

// åœ¨äº‹åŠ¡å¤–è®¿é—®
Course course = getCourse(1L);
course.getStudents().size();  // âŒ LazyInitializationException
```

**åŸå› åˆ†æ**ï¼š

```
studentsæ˜¯æ‡’åŠ è½½
äº‹åŠ¡å·²å…³é—­ â†’ Sessionå·²å…³é—­
æ— æ³•ä»æ•°æ®åº“åŠ è½½æ•°æ®
```

**âœ… è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// æ–¹æ¡ˆ1ï¼šåœ¨äº‹åŠ¡å†…è®¿é—®
@Transactional
public void processCourse(Long id) {
    Course course = courseRepo.findById(id).get();
    course.getStudents().size();  // âœ… äº‹åŠ¡å†…å¯ä»¥æ‡’åŠ è½½
}

// æ–¹æ¡ˆ2ï¼šä½¿ç”¨EAGERåŠ è½½
@ManyToMany(fetch = FetchType.EAGER)

// æ–¹æ¡ˆ3ï¼šä½¿ç”¨JOIN FETCH
@Query("SELECT c FROM Course c JOIN FETCH c.students WHERE c.id = :id")
Course findByIdWithStudents(@Param("id") Long id);
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å…³é”®æ¦‚å¿µè®°å¿†


```
ğŸ”¸ æ‹¥æœ‰æ–¹ = æ§åˆ¶å¤–é”®çš„ä¸€æ–¹ = ä¿®æ”¹ä¼šå½±å“æ•°æ®åº“
ğŸ”¸ è¢«æ‹¥æœ‰æ–¹ = æ ‡è®°mappedByçš„ä¸€æ–¹ = ä¿®æ”¹ä¸å½±å“æ•°æ®åº“
ğŸ”¸ mappedBy = æŒ‡å‘å¯¹æ–¹å®ä½“ä¸­çš„å­—æ®µå
ğŸ”¸ Helperæ–¹æ³• = å°è£…åŒå‘ç»´æŠ¤é€»è¾‘
```

### 7.2 é…ç½®å£è¯€


**ä¸€å¯¹å¤šå…³ç³»**ï¼š
```
ä¸€å¯¹å¤šï¼Œå¤šæ˜¯ä¸»
å¤šæ–¹å†™@JoinColumn
ä¸€æ–¹å†™mappedBy
```

**å¤šå¯¹å¤šå…³ç³»**ï¼š
```
å¤šå¯¹å¤šï¼Œé€‰ä¸€ä¸»
ä¸»æ–¹å†™@JoinTable
ä»æ–¹å†™mappedBy
```

**mappedByè§„åˆ™**ï¼š
```
mappedByåªèƒ½æœ‰ä¸€ä¸ª
å€¼æ˜¯å¯¹æ–¹çš„å­—æ®µå
å’Œ@JoinColumnäº’æ–¥
è¢«æ‹¥æœ‰æ–¹æ‰èƒ½å†™
```

### 7.3 å®æˆ˜æ£€æŸ¥æ¸…å•


**è®¾è®¡é˜¶æ®µ**ï¼š
- [ ] æ˜ç¡®å“ªä¸€æ–¹æ˜¯æ‹¥æœ‰æ–¹
- [ ] ç¡®å®šçº§è”ç­–ç•¥
- [ ] è§„åˆ’æ‡’åŠ è½½ç­–ç•¥

**ç¼–ç é˜¶æ®µ**ï¼š
- [ ] æ‹¥æœ‰æ–¹é…ç½®@JoinColumnæˆ–@JoinTable
- [ ] è¢«æ‹¥æœ‰æ–¹é…ç½®mappedBy
- [ ] ç¼–å†™Helperæ–¹æ³•ç»´æŠ¤åŒå‘å…³ç³»
- [ ] æ·»åŠ å¿…è¦çš„ä¸šåŠ¡æ ¡éªŒ

**æµ‹è¯•é˜¶æ®µ**ï¼š
- [ ] éªŒè¯å…³ç³»èƒ½æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
- [ ] éªŒè¯åŒå‘å…³ç³»å†…å­˜ä¸€è‡´æ€§
- [ ] æµ‹è¯•çº§è”æ“ä½œæ˜¯å¦ç¬¦åˆé¢„æœŸ
- [ ] æµ‹è¯•æ‡’åŠ è½½åœºæ™¯

### 7.4 å¸¸è§é”™è¯¯é¿å…


| é”™è¯¯åœºæ™¯ | é”™è¯¯åšæ³• | æ­£ç¡®åšæ³• |
|---------|---------|---------|
| **åŒå‘éƒ½æƒ³æ§åˆ¶** | ä¸¤è¾¹éƒ½ç”¨`@JoinColumn` | ä¸€æ–¹ç”¨`@JoinColumn`ï¼Œå¦ä¸€æ–¹ç”¨`mappedBy` |
| **éƒ½ä¸æ§åˆ¶** | ä¸¤è¾¹éƒ½ç”¨`mappedBy` | å¿…é¡»æœ‰ä¸€æ–¹æ˜¯æ‹¥æœ‰æ–¹ |
| **mappedByå†™é”™** | `mappedBy="dept"` | å€¼å¿…é¡»æ˜¯å¯¹æ–¹çš„å­—æ®µå |
| **åªæ›´æ–°ä¸€æ–¹** | åªè°ƒç”¨`student.getCourses().add()` | ä½¿ç”¨Helperæ–¹æ³•åŒå‘ç»´æŠ¤ |
| **çº§è”æ»¥ç”¨** | åˆ°å¤„ç”¨`CascadeType.ALL` | æ ¹æ®ä¸šåŠ¡éœ€æ±‚ç²¾ç¡®é…ç½® |

### 7.5 æœ€ä½³å®è·µå»ºè®®


**ğŸ’¡ å»ºè®®1ï¼šä¼˜å…ˆåœ¨æ‹¥æœ‰æ–¹æä¾›Helperæ–¹æ³•**
```java
// âœ… æ¨èï¼šæ‹¥æœ‰æ–¹ä¸»åŠ¨ç»´æŠ¤å…³ç³»
public class Employee {
    public void setDepartment(Department dept) {
        // åŒæ—¶ç»´æŠ¤åŒå‘å…³ç³»
    }
}
```

**ğŸ’¡ å»ºè®®2ï¼šé˜²å¾¡æ€§ç¼–ç¨‹**
```java
public void addEmployee(Employee emp) {
    if (emp == null) return;  // ç©ºå€¼æ£€æŸ¥
    if (employees.contains(emp)) return;  // é‡å¤æ£€æŸ¥
    // ... ç»´æŠ¤é€»è¾‘
}
```

**ğŸ’¡ å»ºè®®3ï¼šå‘½åè¦æ¸…æ™°**
```java
// âœ… å¥½çš„å‘½å
public void enrollCourse(Course course)  // é€‰è¯¾
public void assignDepartment(Department dept)  // åˆ†é…éƒ¨é—¨

// âŒ ä¸å¥½çš„å‘½å  
public void add(Course course)  // å¤ªæ³›åŒ–
public void set(Department dept)  // ä¸æ˜ç¡®
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- mappedBy = "æˆ‘ä¸ç®¡å…³ç³»ï¼Œå¯¹æ–¹ç®¡"
- æ‹¥æœ‰æ–¹è´Ÿè´£æ•°æ®åº“ï¼Œè¢«æ‹¥æœ‰æ–¹åªæ˜¯å¼•ç”¨
- Helperæ–¹æ³•åŒå‘ç»´æŠ¤ï¼Œç¼ºä¸€ä¸å¯
- å…³ç³»ä¸€è‡´æ€§é ä»£ç ä¿è¯ï¼Œä¸é JPAè‡ªåŠ¨