---
title: 66ã€å¤šæ•°æ®æºä¸è·¯ç”±
---
## ğŸ“š ç›®å½•

1. [å¤šæ•°æ®æºåŸºç¡€æ¦‚å¿µ](#1-å¤šæ•°æ®æºåŸºç¡€æ¦‚å¿µ)
2. [å¤šæ•°æ®æºé…ç½®å®ç°](#2-å¤šæ•°æ®æºé…ç½®å®ç°)
3. [è¯»å†™åˆ†ç¦»å®ç°](#3-è¯»å†™åˆ†ç¦»å®ç°)
4. [åŠ¨æ€æ•°æ®æºè·¯ç”±](#4-åŠ¨æ€æ•°æ®æºè·¯ç”±)
5. [äº‹åŠ¡ä¸€è‡´æ€§ç®¡ç†](#5-äº‹åŠ¡ä¸€è‡´æ€§ç®¡ç†)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å¤šæ•°æ®æºåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¤šæ•°æ®æº


**é€šä¿—ç†è§£**ï¼šå°±åƒä½ å®¶é‡Œæœ‰å¤šä¸ªæ°´é¾™å¤´ï¼Œæ¯ä¸ªæ°´é¾™å¤´è¿æ¥ä¸åŒçš„æ°´æºï¼ˆè‡ªæ¥æ°´ã€å‡€æ°´å™¨ã€çƒ­æ°´å™¨ï¼‰ï¼Œå¤šæ•°æ®æºå°±æ˜¯è®©ä½ çš„åº”ç”¨å¯ä»¥è¿æ¥å¤šä¸ªæ•°æ®åº“ã€‚

```
å•æ•°æ®æºåœºæ™¯ï¼š                å¤šæ•°æ®æºåœºæ™¯ï¼š
åº”ç”¨ç¨‹åº                      åº”ç”¨ç¨‹åº
   â†“                           â†“
æ•°æ®åº“A                    â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”
                          â†“    â†“    â†“
                       æ•°æ®åº“A æ•°æ®åº“B æ•°æ®åº“C
```

**ä¸ºä»€ä¹ˆéœ€è¦å¤šæ•°æ®æºï¼Ÿ**
- ğŸ”¸ **ä¸šåŠ¡éš”ç¦»**ï¼šè®¢å•æ•°æ®åº“ã€ç”¨æˆ·æ•°æ®åº“ã€æ—¥å¿—æ•°æ®åº“åˆ†å¼€å­˜å‚¨
- ğŸ”¸ **è¯»å†™åˆ†ç¦»**ï¼šä¸»åº“è´Ÿè´£å†™ï¼Œä»åº“è´Ÿè´£è¯»ï¼Œæå‡æ€§èƒ½
- ğŸ”¸ **å†å²æ•°æ®è¿ç§»**ï¼šæ–°è€ç³»ç»Ÿæ•°æ®åº“å…±å­˜
- ğŸ”¸ **è·¨ç³»ç»Ÿé›†æˆ**ï¼šéœ€è¦è®¿é—®å…¶ä»–ç³»ç»Ÿçš„æ•°æ®åº“

### 1.2 å¤šæ•°æ®æºçš„åº”ç”¨åœºæ™¯


**åœºæ™¯ 1ï¸âƒ£ï¼šä¸šåŠ¡æ•°æ®åˆ†ç¦»**
```
ç”µå•†ç³»ç»Ÿï¼š
â”œâ”€â”€ è®¢å•æ•°æ®åº“ï¼ˆorder_dbï¼‰    â†’ å­˜å‚¨è®¢å•ç›¸å…³æ•°æ®
â”œâ”€â”€ ç”¨æˆ·æ•°æ®åº“ï¼ˆuser_dbï¼‰     â†’ å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
â””â”€â”€ å•†å“æ•°æ®åº“ï¼ˆproduct_dbï¼‰  â†’ å­˜å‚¨å•†å“ä¿¡æ¯

ä¼˜åŠ¿ï¼šæ•°æ®éš”ç¦»ã€ç‹¬ç«‹æ‰©å±•ã€æ•…éšœå½±å“èŒƒå›´å°
```

**åœºæ™¯ 2ï¸âƒ£ï¼šè¯»å†™åˆ†ç¦»**
```
é«˜å¹¶å‘ç³»ç»Ÿï¼š
ä¸»åº“ï¼ˆMasterï¼‰â†’ å¤„ç†å¢åˆ æ”¹æ“ä½œ
   â†“ æ•°æ®åŒæ­¥
ä»åº“ï¼ˆSlaveï¼‰ â†’ å¤„ç†æŸ¥è¯¢æ“ä½œ

ä¼˜åŠ¿ï¼šåˆ†æ‹…ä¸»åº“å‹åŠ›ã€æå‡æŸ¥è¯¢æ€§èƒ½
```

**åœºæ™¯ 3ï¸âƒ£ï¼šæ–°è€ç³»ç»Ÿå¹¶å­˜**
```
ç³»ç»Ÿå‡çº§åœºæ™¯ï¼š
æ—§æ•°æ®åº“ï¼ˆlegacy_dbï¼‰â†’ å†å²æ•°æ®
æ–°æ•°æ®åº“ï¼ˆnew_dbï¼‰   â†’ æ–°ä¸šåŠ¡æ•°æ®

ä¼˜åŠ¿ï¼šå¹³æ»‘è¿ç§»ã€é€æ­¥åˆ‡æ¢
```

### 1.3 æ ¸å¿ƒæ¦‚å¿µè¯´æ˜


| æ¦‚å¿µ | **å«ä¹‰è§£é‡Š** | **é€šä¿—æ¯”å–»** |
|------|------------|------------|
| ğŸ”¸ **DataSource** | `æ•°æ®æºï¼Œä»£è¡¨ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± ` | `æ°´é¾™å¤´ï¼Œè¿æ¥åˆ°æŸä¸ªæ°´æº` |
| ğŸ”¸ **Primary** | `ä¸»æ•°æ®æºï¼Œé»˜è®¤ä½¿ç”¨çš„æ•°æ®åº“` | `ä½ å®¶çš„ä¸»æ°´é¾™å¤´` |
| ğŸ”¸ **Secondary** | `æ¬¡æ•°æ®æºï¼Œå¤‡ç”¨æ•°æ®åº“` | `å¤‡ç”¨æ°´é¾™å¤´` |
| ğŸ”¸ **è·¯ç”±** | `æ ¹æ®æ¡ä»¶é€‰æ‹©ä½¿ç”¨å“ªä¸ªæ•°æ®æº` | `æ ¹æ®éœ€è¦é€‰æ‹©ç”¨å“ªä¸ªæ°´é¾™å¤´` |

---

## 2. ğŸ”§ å¤šæ•°æ®æºé…ç½®å®ç°


### 2.1 é…ç½®æ–‡ä»¶å‡†å¤‡


**Step â‘  é…ç½®å¤šä¸ªæ•°æ®æºä¿¡æ¯**

```yaml
# application.yml
spring:
  datasource:
    # ä¸»æ•°æ®æºï¼ˆè®¢å•åº“ï¼‰
    primary:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/order_db
      username: root
      password: 123456
      
    # æ¬¡æ•°æ®æºï¼ˆç”¨æˆ·åº“ï¼‰
    secondary:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/user_db
      username: root
      password: 123456
```

**é…ç½®è¯´æ˜**ï¼š
- `primary`ï¼šä¸»æ•°æ®æºï¼Œå­˜å‚¨è®¢å•ç›¸å…³æ•°æ®
- `secondary`ï¼šæ¬¡æ•°æ®æºï¼Œå­˜å‚¨ç”¨æˆ·ç›¸å…³æ•°æ®
- æ¯ä¸ªæ•°æ®æºéƒ½éœ€è¦é…ç½®ï¼šé©±åŠ¨ã€è¿æ¥åœ°å€ã€ç”¨æˆ·åã€å¯†ç 

### 2.2 ä¸»æ•°æ®æºé…ç½®


**Step â‘¡ åˆ›å»ºä¸»æ•°æ®æºé…ç½®ç±»**

```java
@Configuration
@EnableJpaRepositories(
    basePackages = "com.example.repository.order",  // è®¢å•ç›¸å…³RepositoryåŒ…è·¯å¾„
    entityManagerFactoryRef = "primaryEntityManagerFactory",
    transactionManagerRef = "primaryTransactionManager"
)
public class PrimaryDataSourceConfig {
    
    // ğŸ”¸ åˆ›å»ºä¸»æ•°æ®æº
    @Primary  // æ ‡è®°ä¸ºä¸»æ•°æ®æº
    @Bean(name = "primaryDataSource")
    @ConfigurationProperties(prefix = "spring.datasource.primary")
    public DataSource primaryDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    // ğŸ”¸ åˆ›å»ºEntityManagerFactory
    @Primary
    @Bean(name = "primaryEntityManagerFactory")
    public LocalContainerEntityManagerFactoryBean primaryEntityManagerFactory(
            EntityManagerFactoryBuilder builder,
            @Qualifier("primaryDataSource") DataSource dataSource) {
        
        return builder
                .dataSource(dataSource)
                .packages("com.example.entity.order")  // è®¢å•å®ä½“ç±»åŒ…è·¯å¾„
                .persistenceUnit("primary")
                .build();
    }
    
    // ğŸ”¸ åˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨
    @Primary
    @Bean(name = "primaryTransactionManager")
    public PlatformTransactionManager primaryTransactionManager(
            @Qualifier("primaryEntityManagerFactory") EntityManagerFactory factory) {
        return new JpaTransactionManager(factory);
    }
}
```

**å…³é”®ç‚¹è§£é‡Š**ï¼š

1ï¸âƒ£ **@Primaryæ³¨è§£**ï¼šå‘Šè¯‰Springè¿™æ˜¯ä¸»æ•°æ®æºï¼Œå½“ä¸ç¡®å®šç”¨å“ªä¸ªæ—¶å°±ç”¨å®ƒ

2ï¸âƒ£ **basePackages**ï¼šæŒ‡å®šè¿™ä¸ªæ•°æ®æºç®¡ç†å“ªäº›Repository
```
com.example.repository.orderåŒ…ä¸‹çš„æ‰€æœ‰Repository
éƒ½ä½¿ç”¨primaryDataSourceæ•°æ®æº
```

3ï¸âƒ£ **packages**ï¼šæŒ‡å®šè¿™ä¸ªæ•°æ®æºç®¡ç†å“ªäº›å®ä½“ç±»
```
com.example.entity.orderåŒ…ä¸‹çš„æ‰€æœ‰å®ä½“
éƒ½æ˜ å°„åˆ°primaryæ•°æ®æºå¯¹åº”çš„æ•°æ®åº“
```

### 2.3 æ¬¡æ•°æ®æºé…ç½®


**Step â‘¢ åˆ›å»ºæ¬¡æ•°æ®æºé…ç½®ç±»**

```java
@Configuration
@EnableJpaRepositories(
    basePackages = "com.example.repository.user",  // ç”¨æˆ·ç›¸å…³Repository
    entityManagerFactoryRef = "secondaryEntityManagerFactory",
    transactionManagerRef = "secondaryTransactionManager"
)
public class SecondaryDataSourceConfig {
    
    @Bean(name = "secondaryDataSource")
    @ConfigurationProperties(prefix = "spring.datasource.secondary")
    public DataSource secondaryDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean(name = "secondaryEntityManagerFactory")
    public LocalContainerEntityManagerFactoryBean secondaryEntityManagerFactory(
            EntityManagerFactoryBuilder builder,
            @Qualifier("secondaryDataSource") DataSource dataSource) {
        
        return builder
                .dataSource(dataSource)
                .packages("com.example.entity.user")  // ç”¨æˆ·å®ä½“ç±»åŒ…è·¯å¾„
                .persistenceUnit("secondary")
                .build();
    }
    
    @Bean(name = "secondaryTransactionManager")
    public PlatformTransactionManager secondaryTransactionManager(
            @Qualifier("secondaryEntityManagerFactory") EntityManagerFactory factory) {
        return new JpaTransactionManager(factory);
    }
}
```

### 2.4 é¡¹ç›®ç»“æ„ç»„ç»‡


**æ¨èçš„åŒ…ç»“æ„**ï¼š
```
com.example
â”œâ”€â”€ entity
â”‚   â”œâ”€â”€ order          â†’ è®¢å•å®ä½“ï¼ˆä½¿ç”¨primaryæ•°æ®æºï¼‰
â”‚   â”‚   â”œâ”€â”€ Order.java
â”‚   â”‚   â””â”€â”€ OrderItem.java
â”‚   â””â”€â”€ user           â†’ ç”¨æˆ·å®ä½“ï¼ˆä½¿ç”¨secondaryæ•°æ®æºï¼‰
â”‚       â”œâ”€â”€ User.java
â”‚       â””â”€â”€ UserProfile.java
â”œâ”€â”€ repository
â”‚   â”œâ”€â”€ order          â†’ è®¢å•Repositoryï¼ˆè¿primaryæ•°æ®æºï¼‰
â”‚   â”‚   â””â”€â”€ OrderRepository.java
â”‚   â””â”€â”€ user           â†’ ç”¨æˆ·Repositoryï¼ˆè¿secondaryæ•°æ®æºï¼‰
â”‚       â””â”€â”€ UserRepository.java
â””â”€â”€ config
    â”œâ”€â”€ PrimaryDataSourceConfig.java
    â””â”€â”€ SecondaryDataSourceConfig.java
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;  // è‡ªåŠ¨ä½¿ç”¨primaryæ•°æ®æº
    
    @Autowired
    private UserRepository userRepository;    // è‡ªåŠ¨ä½¿ç”¨secondaryæ•°æ®æº
    
    public void createOrder(Long userId) {
        // ä»ç”¨æˆ·åº“æŸ¥è¯¢ç”¨æˆ·
        User user = userRepository.findById(userId).orElseThrow();
        
        // åœ¨è®¢å•åº“åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(user.getId());
        orderRepository.save(order);
    }
}
```

---

## 3. ğŸ“– è¯»å†™åˆ†ç¦»å®ç°


### 3.1 è¯»å†™åˆ†ç¦»åŸç†


**è¯»å†™åˆ†ç¦»çš„æ ¸å¿ƒæ€æƒ³**ï¼š
```
å†™æ“ä½œï¼ˆå¢åˆ æ”¹ï¼‰â†’ ä¸»åº“ï¼ˆMasterï¼‰
   â†“
 æ•°æ®åŒæ­¥
   â†“
è¯»æ“ä½œï¼ˆæŸ¥è¯¢ï¼‰ â†’ ä»åº“ï¼ˆSlaveï¼‰

å¥½å¤„ï¼š
âœ… ä¸»åº“ä¸“æ³¨å†™å…¥ï¼Œæ€§èƒ½æ›´å¥½
âœ… ä»åº“åˆ†æ‹…æŸ¥è¯¢ï¼Œé™ä½ä¸»åº“å‹åŠ›
âœ… è¯»æ“ä½œå¯ä»¥æœ‰å¤šä¸ªä»åº“ï¼Œè´Ÿè½½å‡è¡¡
```

**æ•°æ®åŒæ­¥è¯´æ˜**ï¼š
- ä¸»åº“çš„æ•°æ®å˜æ›´ä¼šè‡ªåŠ¨åŒæ­¥åˆ°ä»åº“ï¼ˆé€šè¿‡MySQLçš„ä¸»ä»å¤åˆ¶æœºåˆ¶ï¼‰
- å­˜åœ¨åŒæ­¥å»¶è¿Ÿï¼ˆé€šå¸¸å‡ æ¯«ç§’åˆ°å‡ ç§’ï¼‰
- éœ€è¦è€ƒè™‘è¯»å–åˆ°æ—§æ•°æ®çš„æƒ…å†µ

### 3.2 é…ç½®ä¸»ä»æ•°æ®æº


**é…ç½®æ–‡ä»¶**ï¼š
```yaml
spring:
  datasource:
    # ä¸»åº“é…ç½®ï¼ˆå†™ï¼‰
    master:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://192.168.1.100:3306/mydb
      username: root
      password: 123456
      
    # ä»åº“é…ç½®ï¼ˆè¯»ï¼‰
    slave:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://192.168.1.101:3306/mydb  # ä»åº“åœ°å€
      username: readonly
      password: 123456
```

**æ•°æ®æºé…ç½®ç±»**ï¼š
```java
@Configuration
public class ReadWriteDataSourceConfig {
    
    // ä¸»æ•°æ®æºï¼ˆå†™ï¼‰
    @Bean
    @ConfigurationProperties(prefix = "spring.datasource.master")
    public DataSource masterDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    // ä»æ•°æ®æºï¼ˆè¯»ï¼‰
    @Bean
    @ConfigurationProperties(prefix = "spring.datasource.slave")
    public DataSource slaveDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    // è·¯ç”±æ•°æ®æº
    @Bean
    @Primary
    public DataSource routingDataSource(
            @Qualifier("masterDataSource") DataSource master,
            @Qualifier("slaveDataSource") DataSource slave) {
        
        ReadWriteRoutingDataSource routing = new ReadWriteRoutingDataSource();
        
        // è®¾ç½®æ‰€æœ‰æ•°æ®æº
        Map<Object, Object> targetDataSources = new HashMap<>();
        targetDataSources.put("master", master);
        targetDataSources.put("slave", slave);
        routing.setTargetDataSources(targetDataSources);
        
        // è®¾ç½®é»˜è®¤æ•°æ®æºï¼ˆä¸»åº“ï¼‰
        routing.setDefaultTargetDataSource(master);
        
        return routing;
    }
}
```

### 3.3 è¯»å†™åˆ†ç¦»è·¯ç”±å®ç°


**Step â‘  åˆ›å»ºæ•°æ®æºä¸Šä¸‹æ–‡**ï¼š
```java
// ç”¨ThreadLocalå­˜å‚¨å½“å‰ä½¿ç”¨çš„æ•°æ®æºç±»å‹
public class DataSourceContextHolder {
    
    private static final ThreadLocal<String> CONTEXT = new ThreadLocal<>();
    
    // è®¾ç½®ä¸ºä¸»åº“
    public static void useMaster() {
        CONTEXT.set("master");
    }
    
    // è®¾ç½®ä¸ºä»åº“
    public static void useSlave() {
        CONTEXT.set("slave");
    }
    
    // è·å–å½“å‰æ•°æ®æº
    public static String getDataSource() {
        return CONTEXT.get();
    }
    
    // æ¸…é™¤ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
    public static void clear() {
        CONTEXT.remove();
    }
}
```

**ThreadLocalè§£é‡Š**ï¼š
- æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±ç‹¬ç«‹çš„æ•°æ®å‰¯æœ¬
- çº¿ç¨‹Aè®¾ç½®ä¸ºmasterï¼Œä¸å½±å“çº¿ç¨‹B
- é€‚åˆå¤šçº¿ç¨‹å¹¶å‘åœºæ™¯

**Step â‘¡ å®ç°è·¯ç”±æ•°æ®æº**ï¼š
```java
public class ReadWriteRoutingDataSource extends AbstractRoutingDataSource {
    
    @Override
    protected Object determineCurrentLookupKey() {
        // æ ¹æ®ä¸Šä¸‹æ–‡è¿”å›æ•°æ®æºkey
        return DataSourceContextHolder.getDataSource();
    }
}
```

**å·¥ä½œæµç¨‹**ï¼š
```
1. åº”ç”¨è®¾ç½®æ•°æ®æºç±»å‹
   DataSourceContextHolder.useMaster()
   
2. æ‰§è¡Œæ•°æ®åº“æ“ä½œ
   userRepository.save(user)
   
3. è·¯ç”±æ•°æ®æºè°ƒç”¨determineCurrentLookupKey()
   è¿”å› "master"
   
4. ä½¿ç”¨å¯¹åº”çš„æ•°æ®æºæ‰§è¡ŒSQL
   è¿æ¥åˆ°ä¸»åº“æ‰§è¡Œ
   
5. æ¸…é™¤ä¸Šä¸‹æ–‡
   DataSourceContextHolder.clear()
```

### 3.4 ä½¿ç”¨AOPè‡ªåŠ¨è·¯ç”±


**åˆ›å»ºæ³¨è§£æ ‡è®°è¯»å†™æ“ä½œ**ï¼š
```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface ReadOnly {
    // æ ‡è®°åªè¯»æ“ä½œï¼Œä½¿ç”¨ä»åº“
}
```

**AOPåˆ‡é¢å®ç°è‡ªåŠ¨è·¯ç”±**ï¼š
```java
@Aspect
@Component
public class DataSourceAspect {
    
    @Around("@annotation(readOnly)")
    public Object routeDataSource(ProceedingJoinPoint point, ReadOnly readOnly) 
            throws Throwable {
        try {
            // ä½¿ç”¨ä»åº“
            DataSourceContextHolder.useSlave();
            return point.proceed();
        } finally {
            // æ¸…é™¤ä¸Šä¸‹æ–‡
            DataSourceContextHolder.clear();
        }
    }
    
    @Around("execution(* com.example.service.*.*(..))")
    public Object routeDefault(ProceedingJoinPoint point) throws Throwable {
        try {
            // é»˜è®¤ä½¿ç”¨ä¸»åº“
            DataSourceContextHolder.useMaster();
            return point.proceed();
        } finally {
            DataSourceContextHolder.clear();
        }
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    // å†™æ“ä½œï¼Œè‡ªåŠ¨ä½¿ç”¨ä¸»åº“
    public void saveUser(User user) {
        userRepository.save(user);
    }
    
    // è¯»æ“ä½œï¼Œä½¿ç”¨ä»åº“
    @ReadOnly
    public User findUser(Long id) {
        return userRepository.findById(id).orElse(null);
    }
}
```

---

## 4. ğŸ”€ åŠ¨æ€æ•°æ®æºè·¯ç”±


### 4.1 AbstractRoutingDataSourceåŸç†


**æ ¸å¿ƒç†è§£**ï¼šAbstractRoutingDataSourceå°±åƒä¸€ä¸ªæ™ºèƒ½åˆ†é…å™¨ï¼Œæ ¹æ®è§„åˆ™é€‰æ‹©ä½¿ç”¨å“ªä¸ªæ•°æ®æºã€‚

```
AbstractRoutingDataSourceå·¥ä½œåŸç†ï¼š

   åº”ç”¨è¯·æ±‚
      â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ è·¯ç”±æ•°æ®æº       â”‚
  â”‚ è°ƒç”¨determine   â”‚ â†’ è¿”å›æ•°æ®æºkeyï¼ˆå¦‚"order"ï¼‰
  â”‚ CurrentLookup   â”‚
  â”‚ Key()           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
  æ ¹æ®keyæŸ¥æ‰¾å¯¹åº”çš„çœŸå®æ•°æ®æº
      â†“
  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
  â”‚ orderâ”‚userâ”‚logâ”‚
  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
      â†“
  æ‰§è¡ŒSQLæ“ä½œ
```

### 4.2 å®ç°åŠ¨æ€è·¯ç”±æ•°æ®æº


**Step â‘  åˆ›å»ºè·¯ç”±æ•°æ®æº**ï¼š
```java
public class DynamicDataSource extends AbstractRoutingDataSource {
    
    @Override
    protected Object determineCurrentLookupKey() {
        // ä»ä¸Šä¸‹æ–‡è·å–æ•°æ®æºæ ‡è¯†
        return DynamicDataSourceContextHolder.getDataSourceKey();
    }
}
```

**Step â‘¡ åˆ›å»ºä¸Šä¸‹æ–‡ç®¡ç†å™¨**ï¼š
```java
public class DynamicDataSourceContextHolder {
    
    // æ•°æ®æºæ ‡è¯†å¸¸é‡
    public static final String ORDER_DB = "orderDB";
    public static final String USER_DB = "userDB";
    public static final String LOG_DB = "logDB";
    
    private static final ThreadLocal<String> CONTEXT = new ThreadLocal<>();
    
    // è®¾ç½®æ•°æ®æº
    public static void setDataSourceKey(String key) {
        CONTEXT.set(key);
    }
    
    // è·å–æ•°æ®æº
    public static String getDataSourceKey() {
        return CONTEXT.get();
    }
    
    // æ¸…é™¤
    public static void clear() {
        CONTEXT.remove();
    }
}
```

**Step â‘¢ é…ç½®å¤šä¸ªæ•°æ®æº**ï¼š
```java
@Configuration
public class DynamicDataSourceConfig {
    
    @Bean
    @ConfigurationProperties(prefix = "spring.datasource.order")
    public DataSource orderDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    @ConfigurationProperties(prefix = "spring.datasource.user")
    public DataSource userDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    @ConfigurationProperties(prefix = "spring.datasource.log")
    public DataSource logDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    @Primary
    public DataSource dynamicDataSource() {
        DynamicDataSource dataSource = new DynamicDataSource();
        
        Map<Object, Object> targetDataSources = new HashMap<>();
        targetDataSources.put("orderDB", orderDataSource());
        targetDataSources.put("userDB", userDataSource());
        targetDataSources.put("logDB", logDataSource());
        
        dataSource.setTargetDataSources(targetDataSources);
        dataSource.setDefaultTargetDataSource(orderDataSource());
        
        return dataSource;
    }
}
```

### 4.3 è‡ªå®šä¹‰æ³¨è§£å®ç°è·¯ç”±


**åˆ›å»ºæ•°æ®æºè·¯ç”±æ³¨è§£**ï¼š
```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface TargetDataSource {
    String value();  // æ•°æ®æºæ ‡è¯†
}
```

**AOPåˆ‡é¢å¤„ç†**ï¼š
```java
@Aspect
@Component
public class DataSourceAspect {
    
    @Around("@annotation(targetDataSource)")
    public Object switchDataSource(ProceedingJoinPoint point, 
                                   TargetDataSource targetDataSource) 
            throws Throwable {
        
        String dataSourceKey = targetDataSource.value();
        
        try {
            // åˆ‡æ¢æ•°æ®æº
            DynamicDataSourceContextHolder.setDataSourceKey(dataSourceKey);
            System.out.println("åˆ‡æ¢åˆ°æ•°æ®æºï¼š" + dataSourceKey);
            
            // æ‰§è¡Œæ–¹æ³•
            return point.proceed();
            
        } finally {
            // æ¢å¤é»˜è®¤æ•°æ®æº
            DynamicDataSourceContextHolder.clear();
        }
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
@Service
public class BusinessService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private LogRepository logRepository;
    
    // æ“ä½œè®¢å•åº“
    @TargetDataSource("orderDB")
    public void createOrder(Order order) {
        orderRepository.save(order);
    }
    
    // æ“ä½œç”¨æˆ·åº“
    @TargetDataSource("userDB")
    public User getUser(Long id) {
        return userRepository.findById(id).orElse(null);
    }
    
    // æ“ä½œæ—¥å¿—åº“
    @TargetDataSource("logDB")
    public void saveLog(String message) {
        Log log = new Log();
        log.setMessage(message);
        logRepository.save(log);
    }
}
```

---

## 5. âš ï¸ äº‹åŠ¡ä¸€è‡´æ€§ç®¡ç†


### 5.1 å¤šæ•°æ®æºäº‹åŠ¡é—®é¢˜


**æ ¸å¿ƒé—®é¢˜**ï¼šä¸åŒæ•°æ®æºçš„äº‹åŠ¡æ— æ³•è‡ªåŠ¨åè°ƒ

```
åœºæ™¯ç¤ºä¾‹ï¼š
1. å‘è®¢å•åº“æ’å…¥è®¢å• âœ…
2. å‘ç”¨æˆ·åº“æ‰£å‡ä½™é¢ âŒ å¤±è´¥

é—®é¢˜ï¼šè®¢å•å·²ä¿å­˜ï¼Œä½†ä½™é¢æœªæ‰£å‡ â†’ æ•°æ®ä¸ä¸€è‡´ï¼
```

**é—®é¢˜åˆ†æ**ï¼š
- æ¯ä¸ªæ•°æ®æºæœ‰è‡ªå·±çš„äº‹åŠ¡ç®¡ç†å™¨
- Springçš„`@Transactional`é»˜è®¤åªç®¡ç†ä¸€ä¸ªæ•°æ®æº
- è·¨æ•°æ®æºæ“ä½œéœ€è¦ç‰¹æ®Šå¤„ç†

### 5.2 å•æ•°æ®æºäº‹åŠ¡ä¿è¯


**è§„åˆ™ ğŸ”¥ï¼šä¸€ä¸ªäº‹åŠ¡æ–¹æ³•åªæ“ä½œä¸€ä¸ªæ•°æ®æº**

```java
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;  // primaryæ•°æ®æº
    
    // âœ… æ­£ç¡®ï¼šåªæ“ä½œè®¢å•åº“
    @Transactional(transactionManager = "primaryTransactionManager")
    public void createOrder(Order order) {
        orderRepository.save(order);
        // åªæ“ä½œprimaryæ•°æ®æºï¼Œäº‹åŠ¡æœ‰æ•ˆ
    }
}
```

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;  // secondaryæ•°æ®æº
    
    // âœ… æ­£ç¡®ï¼šåªæ“ä½œç”¨æˆ·åº“
    @Transactional(transactionManager = "secondaryTransactionManager")
    public void updateBalance(Long userId, BigDecimal amount) {
        User user = userRepository.findById(userId).orElseThrow();
        user.setBalance(user.getBalance().subtract(amount));
        userRepository.save(user);
        // åªæ“ä½œsecondaryæ•°æ®æºï¼Œäº‹åŠ¡æœ‰æ•ˆ
    }
}
```

### 5.3 è·¨æ•°æ®æºäº‹åŠ¡æ–¹æ¡ˆ


**æ–¹æ¡ˆ 1ï¸âƒ£ï¼šåº”ç”¨å±‚æ§åˆ¶ï¼ˆæ¨èï¼‰**

```java
@Service
public class BusinessService {
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private UserService userService;
    
    // åº”ç”¨å±‚åè°ƒå¤šä¸ªå•æ•°æ®æºäº‹åŠ¡
    public void placeOrder(Long userId, Order order) {
        try {
            // 1. æ‰£å‡ç”¨æˆ·ä½™é¢ï¼ˆç”¨æˆ·åº“äº‹åŠ¡ï¼‰
            userService.updateBalance(userId, order.getAmount());
            
            // 2. åˆ›å»ºè®¢å•ï¼ˆè®¢å•åº“äº‹åŠ¡ï¼‰
            orderService.createOrder(order);
            
        } catch (Exception e) {
            // æ‰‹åŠ¨è¡¥å¿å›æ»š
            userService.refundBalance(userId, order.getAmount());
            throw e;
        }
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®ç°ç®€å•ï¼Œæ˜“äºç†è§£
- âœ… ä¸ä¾èµ–åˆ†å¸ƒå¼äº‹åŠ¡
- âœ… æ€§èƒ½è¾ƒå¥½

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦æ‰‹åŠ¨ç¼–å†™è¡¥å¿é€»è¾‘
- âŒ å¯èƒ½å­˜åœ¨ä¸­é—´çŠ¶æ€

**æ–¹æ¡ˆ 2ï¸âƒ£ï¼šåˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆå¤æ‚åœºæ™¯ï¼‰**

```java
// éœ€è¦å¼•å…¥åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼ˆå¦‚Seataã€Atomikosï¼‰
@GlobalTransactional  // Seataåˆ†å¸ƒå¼äº‹åŠ¡æ³¨è§£
public void placeOrderWithDistributedTx(Long userId, Order order) {
    // æ‰£å‡ä½™é¢
    userService.updateBalance(userId, order.getAmount());
    
    // åˆ›å»ºè®¢å•
    orderService.createOrder(order);
    
    // åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ä¿è¯å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å›æ»š
}
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ğŸŸ¡ å¼ºä¸€è‡´æ€§è¦æ±‚é«˜
- ğŸŸ¡ ä¸šåŠ¡å¤æ‚ï¼Œè¡¥å¿å›°éš¾
- ğŸŸ¡ å¯ä»¥æ¥å—æ€§èƒ½æŸè€—

### 5.4 äº‹åŠ¡æœ€ä½³å®è·µ


**è§„åˆ™æ€»ç»“**ï¼š

| åœºæ™¯ | **å¤„ç†æ–¹å¼** | **éš¾åº¦** |
|------|------------|---------|
| å•æ•°æ®æºæ“ä½œ | `@TransactionalæŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨` | ğŸŸ¢ç®€å• |
| å¤šæ•°æ®æºé¡ºåºæ“ä½œ | `åº”ç”¨å±‚æ§åˆ¶+è¡¥å¿` | ğŸŸ¡ä¸­ç­‰ |
| å¤šæ•°æ®æºå¼ºä¸€è‡´ | `åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶` | ğŸ”´å¤æ‚ |

**æ³¨æ„äº‹é¡¹ âš ï¸**ï¼š

1ï¸âƒ£ **æ˜ç¡®æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨**
```java
// âŒ é”™è¯¯ï¼šä¸æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨
@Transactional
public void save() { ... }

// âœ… æ­£ç¡®ï¼šæ˜ç¡®æŒ‡å®š
@Transactional(transactionManager = "primaryTransactionManager")
public void save() { ... }
```

2ï¸âƒ£ **é¿å…è·¨æ•°æ®æºåµŒå¥—äº‹åŠ¡**
```java
// âŒ å±é™©ï¼šå¤–å±‚å’Œå†…å±‚ä½¿ç”¨ä¸åŒæ•°æ®æº
@Transactional(transactionManager = "primaryTransactionManager")
public void outerMethod() {
    innerMethod();  // ä½¿ç”¨secondaryTransactionManager
}
```

3ï¸âƒ£ **è¯»å†™åˆ†ç¦»æ³¨æ„äº‹åŠ¡ä¼ æ’­**
```java
@Transactional
public void updateAndRead() {
    userRepository.save(user);  // å†™å…¥ä¸»åº“
    
    // âš ï¸ é—®é¢˜ï¼šå¯èƒ½ä»ä»åº“è¯»å–ï¼Œè¯»åˆ°æ—§æ•°æ®ï¼ˆä¸»ä»å»¶è¿Ÿï¼‰
    User readUser = userRepository.findById(id).get();
}

// âœ… è§£å†³ï¼šäº‹åŠ¡å†…å¼ºåˆ¶ä½¿ç”¨ä¸»åº“
@Transactional
public void updateAndRead() {
    userRepository.save(user);
    
    DataSourceContextHolder.useMaster();  // å¼ºåˆ¶ä¸»åº“
    User readUser = userRepository.findById(id).get();
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å…³é”®çŸ¥è¯†ç‚¹å›é¡¾


```
ğŸ”¸ å¤šæ•°æ®æºæœ¬è´¨ï¼šè®©åº”ç”¨è¿æ¥å¤šä¸ªæ•°æ®åº“
ğŸ”¸ é…ç½®æ ¸å¿ƒï¼šæ¯ä¸ªæ•°æ®æºç‹¬ç«‹é…ç½®EntityManagerFactoryå’ŒTransactionManager
ğŸ”¸ è¯»å†™åˆ†ç¦»ï¼šä¸»åº“å†™ã€ä»åº“è¯»ï¼Œéœ€å¤„ç†åŒæ­¥å»¶è¿Ÿ
ğŸ”¸ åŠ¨æ€è·¯ç”±ï¼šAbstractRoutingDataSource+ThreadLocalå®ç°
ğŸ”¸ äº‹åŠ¡ç®¡ç†ï¼šå•æ•°æ®æºäº‹åŠ¡ or åº”ç”¨å±‚åè°ƒ or åˆ†å¸ƒå¼äº‹åŠ¡
```

### 6.2 é…ç½®æ­¥éª¤é€ŸæŸ¥


**Step â‘ **ï¼šé…ç½®æ–‡ä»¶å®šä¹‰å¤šä¸ªæ•°æ®æº
```yaml
spring.datasource.primary.xxx
spring.datasource.secondary.xxx
```

**Step â‘¡**ï¼šåˆ›å»ºæ•°æ®æºé…ç½®ç±»
- `@Primary`æ ‡è®°ä¸»æ•°æ®æº
- `@EnableJpaRepositories`æŒ‡å®šåŒ…è·¯å¾„

**Step â‘¢**ï¼šç»„ç»‡é¡¹ç›®ç»“æ„
- å®ä½“ç±»åˆ†åŒ…å­˜æ”¾
- Repositoryåˆ†åŒ…å­˜æ”¾

**Step â‘£**ï¼šä½¿ç”¨æ³¨è§£è·¯ç”±ï¼ˆå¯é€‰ï¼‰
- è‡ªå®šä¹‰`@TargetDataSource`
- AOPåˆ‡é¢å¤„ç†

### 6.3 å®æˆ˜æ³¨æ„äº‹é¡¹


**æ€§èƒ½ä¼˜åŒ– âš¡**ï¼š
- è¯»å†™åˆ†ç¦»è¦è€ƒè™‘ä¸»ä»å»¶è¿Ÿï¼ˆé€šå¸¸10ms-1sï¼‰
- ä»åº“å¯ä»¥é…ç½®å¤šä¸ªï¼Œå®ç°è´Ÿè½½å‡è¡¡
- è¿æ¥æ± å‚æ•°è¦åˆ†åˆ«è°ƒä¼˜

**äº‹åŠ¡ç®¡ç† ğŸ”¥**ï¼š
- ä¼˜å…ˆä½¿ç”¨å•æ•°æ®æºäº‹åŠ¡
- è·¨æ•°æ®æºç”¨åº”ç”¨å±‚è¡¥å¿
- åˆ†å¸ƒå¼äº‹åŠ¡è°¨æ…ä½¿ç”¨

**å¸¸è§é”™è¯¯ âŒ**ï¼š
```
é”™è¯¯1ï¼šå¿˜è®°æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨
é”™è¯¯2ï¼šè·¨æ•°æ®æºä½¿ç”¨åŒä¸€ä¸ªEntityManager
é”™è¯¯3ï¼šThreadLocalå¿˜è®°æ¸…ç†å¯¼è‡´å†…å­˜æ³„æ¼
é”™è¯¯4ï¼šè¯»å†™åˆ†ç¦»æ—¶è¯»åˆ°è„æ•°æ®
```

### 6.4 åº”ç”¨åœºæ™¯é€‰æ‹©


| åœºæ™¯ | **æ¨èæ–¹æ¡ˆ** |
|------|-----------|
| ä¸šåŠ¡æ•°æ®éš”ç¦» | `å¤šæ•°æ®æºé…ç½®` |
| é«˜å¹¶å‘æŸ¥è¯¢ | `è¯»å†™åˆ†ç¦»` |
| çµæ´»è·¯ç”± | `åŠ¨æ€æ•°æ®æº+æ³¨è§£` |
| å¼ºä¸€è‡´æ€§ | `åˆ†å¸ƒå¼äº‹åŠ¡` |

**è®°å¿†å£è¯€**ï¼š
```
å¤šæºé…ç½®åˆ†åŒ…ç®¡ï¼Œä¸»æ¬¡æ•°æ®è¦æ ‡æ¸…
è¯»å†™åˆ†ç¦»ä¸»ä»åˆ†ï¼Œå»¶è¿Ÿé—®é¢˜è¦å½“å¿ƒ
åŠ¨æ€è·¯ç”±é æ³¨è§£ï¼ŒThreadLocalæŠŠæºå­˜
äº‹åŠ¡ä¸€è‡´æ˜¯éš¾ç‚¹ï¼Œå•æºä¼˜å…ˆè¡¥å¿è¡Œ
```