---
title: 16ã€å¤šå¯¹ä¸€ä¸ä¸€å¯¹å¤šæ˜ å°„
---
## ğŸ“š ç›®å½•

1. [å…³ç³»æ˜ å°„åŸºç¡€æ¦‚å¿µ](#1-å…³ç³»æ˜ å°„åŸºç¡€æ¦‚å¿µ)
2. [å¤šå¯¹ä¸€æ˜ å°„è¯¦è§£](#2-å¤šå¯¹ä¸€æ˜ å°„è¯¦è§£)
3. [ä¸€å¯¹å¤šæ˜ å°„è¯¦è§£](#3-ä¸€å¯¹å¤šæ˜ å°„è¯¦è§£)
4. [åŒå‘å…³ç³»ç»´æŠ¤](#4-åŒå‘å…³ç³»ç»´æŠ¤)
5. [é›†åˆç±»å‹é€‰æ‹©](#5-é›†åˆç±»å‹é€‰æ‹©)
6. [å¤–é”®çº¦æŸå¤„ç†](#6-å¤–é”®çº¦æŸå¤„ç†)
7. [å…³ç³»æ›´æ–°è¯­ä¹‰](#7-å…³ç³»æ›´æ–°è¯­ä¹‰)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å…³ç³»æ˜ å°„åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¤šå¯¹ä¸€å’Œä¸€å¯¹å¤šå…³ç³»


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä¸€ä¸ªç­çº§å’Œå­¦ç”Ÿçš„å…³ç³»
- å¤šä¸ªå­¦ç”Ÿå±äºåŒä¸€ä¸ªç­çº§ â†’ **å¤šå¯¹ä¸€**ï¼ˆä»å­¦ç”Ÿè§’åº¦çœ‹ï¼‰
- ä¸€ä¸ªç­çº§æ‹¥æœ‰å¤šä¸ªå­¦ç”Ÿ â†’ **ä¸€å¯¹å¤š**ï¼ˆä»ç­çº§è§’åº¦çœ‹ï¼‰

```
ç°å®ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š

å‘˜å·¥å’Œéƒ¨é—¨ï¼š
ğŸ‘¤ å¼ ä¸‰ â”€â”€â”
ğŸ‘¤ æå›› â”€â”€â”¼â”€â†’ ğŸ“¦ ç ”å‘éƒ¨     å¤šå¯¹ä¸€ï¼šå¤šä¸ªå‘˜å·¥å±äºä¸€ä¸ªéƒ¨é—¨
ğŸ‘¤ ç‹äº” â”€â”€â”˜

è®¢å•å’Œè®¢å•é¡¹ï¼š
ğŸ“‹ è®¢å•001 â”€â”€â”
              â”œâ”€â†’ ğŸ“¦ å•†å“A    ä¸€å¯¹å¤šï¼šä¸€ä¸ªè®¢å•åŒ…å«å¤šä¸ªå•†å“
              â””â”€â†’ ğŸ“¦ å•†å“B
```

**æ ¸å¿ƒç†è§£**ï¼š
- **å¤šå¯¹ä¸€**ï¼šç«™åœ¨"å¤š"çš„ä¸€æ–¹çœ‹"ä¸€"çš„ä¸€æ–¹
- **ä¸€å¯¹å¤š**ï¼šç«™åœ¨"ä¸€"çš„ä¸€æ–¹çœ‹"å¤š"çš„ä¸€æ–¹
- **æœ¬è´¨ç›¸åŒ**ï¼šå®ƒä»¬æ˜¯åŒä¸€ä¸ªå…³ç³»çš„ä¸åŒè§†è§’

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å…³ç³»æ˜ å°„


**ğŸ”¸ æ•°æ®åº“å±‚é¢**ï¼š
```
æ•°æ®åº“è¡¨ç»“æ„ï¼š

å­¦ç”Ÿè¡¨ï¼ˆstudentï¼‰              ç­çº§è¡¨ï¼ˆclassï¼‰
+----+------+----------+       +----+----------+
| id | name | class_id |       | id | name     |
+----+------+----------+       +----+----------+
| 1  | å¼ ä¸‰ | 101      |â†â”€â”€â”   | 101| ä¸€å¹´çº§1ç­|
| 2  | æå›› | 101      |â†â”€â”€â”¤   | 102| ä¸€å¹´çº§2ç­|
| 3  | ç‹äº” | 102      |â†â”€â”€â”˜   +----+----------+
+----+------+----------+
         â†‘
      å¤–é”®åˆ—ï¼ˆclass_idï¼‰
```

**ğŸ”¸ Javaå¯¹è±¡å±‚é¢**ï¼š
```java
// æˆ‘ä»¬å¸Œæœ›åœ¨Javaä¸­è¿™æ ·ä½¿ç”¨
Student student = studentRepository.findById(1);
String className = student.getClazz().getName(); // ç›´æ¥è·å–ç­çº§åç§°

Class clazz = classRepository.findById(101);
List<Student> students = clazz.getStudents(); // ç›´æ¥è·å–æ‰€æœ‰å­¦ç”Ÿ
```

**æ˜ å°„çš„ä½œç”¨**ï¼šè®©Javaå¯¹è±¡å…³ç³»å’Œæ•°æ®åº“è¡¨å…³ç³»è‡ªåŠ¨å¯¹åº”èµ·æ¥

---

## 2. ğŸ”— å¤šå¯¹ä¸€æ˜ å°„è¯¦è§£


### 2.1 @ManyToOneæ ¸å¿ƒæ¦‚å¿µ


**å®šä¹‰**ï¼š`@ManyToOne` è¡¨ç¤ºå½“å‰å®ä½“æ˜¯"å¤š"çš„ä¸€æ–¹ï¼Œå…³è”åˆ°"ä¸€"çš„ä¸€æ–¹

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… å‘˜å·¥ â†’ éƒ¨é—¨ï¼ˆå¤šä¸ªå‘˜å·¥å±äºä¸€ä¸ªéƒ¨é—¨ï¼‰
- âœ… è®¢å•é¡¹ â†’ è®¢å•ï¼ˆå¤šä¸ªè®¢å•é¡¹å±äºä¸€ä¸ªè®¢å•ï¼‰
- âœ… è¯„è®º â†’ æ–‡ç« ï¼ˆå¤šæ¡è¯„è®ºå±äºä¸€ç¯‡æ–‡ç« ï¼‰

### 2.2 åŸºç¡€ç”¨æ³•ç¤ºä¾‹


```java
// å­¦ç”Ÿå®ä½“ï¼ˆå¤šçš„ä¸€æ–¹ï¼‰
@Entity
@Table(name = "student")
public class Student {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    
    // å¤šå¯¹ä¸€å…³ç³»ï¼šå¤šä¸ªå­¦ç”Ÿå¯¹åº”ä¸€ä¸ªç­çº§
    @ManyToOne
    @JoinColumn(name = "class_id")  // æŒ‡å®šå¤–é”®åˆ—å
    private Clazz clazz;
    
    // getter/setterçœç•¥
}

// ç­çº§å®ä½“ï¼ˆä¸€çš„ä¸€æ–¹ï¼‰
@Entity
@Table(name = "class")
public class Clazz {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    
    // getter/setterçœç•¥
}
```

**å…³é”®ç†è§£**ï¼š
- `@ManyToOne`ï¼šå£°æ˜è¿™æ˜¯å¤šå¯¹ä¸€å…³ç³»
- `@JoinColumn`ï¼šæŒ‡å®šå¤–é”®åˆ—çš„åç§°ï¼ˆå¦‚æœä¸å†™ï¼Œé»˜è®¤æ˜¯`clazz_id`ï¼‰
- å¤–é”®åˆ—å®é™…å­˜å‚¨çš„æ˜¯ç­çº§çš„ä¸»é”®å€¼

### 2.3 @JoinColumnå¤–é”®åˆ—è¯¦è§£


**ğŸ”¸ ä½œç”¨è¯´æ˜**ï¼š
```java
@ManyToOne
@JoinColumn(name = "class_id")  // è‡ªå®šä¹‰å¤–é”®åˆ—å
private Clazz clazz;

// ä¸å†™@JoinColumnæ—¶ï¼Œé»˜è®¤å¤–é”®åˆ—åä¸ºï¼šå­—æ®µå_id
// å³ï¼šclazz_id
```

**ğŸ”¸ å¸¸ç”¨å±æ€§**ï¼š

| å±æ€§ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `name` | å¤–é”®åˆ—å | `@JoinColumn(name = "dept_id")` |
| `nullable` | æ˜¯å¦å…è®¸ä¸ºç©º | `@JoinColumn(nullable = false)` |
| `unique` | æ˜¯å¦å”¯ä¸€çº¦æŸ | `@JoinColumn(unique = true)` |
| `referencedColumnName` | å¼•ç”¨çš„åˆ—å | `@JoinColumn(referencedColumnName = "code")` |

```java
// å®Œæ•´ç¤ºä¾‹
@ManyToOne
@JoinColumn(
    name = "department_id",        // å¤–é”®åˆ—å
    nullable = false,              // ä¸å…è®¸ä¸ºç©º
    foreignKey = @ForeignKey(      // å¤–é”®çº¦æŸå
        name = "fk_employee_department"
    )
)
private Department department;
```

### 2.4 å¤šå¯¹ä¸€çš„ä½¿ç”¨æ–¹å¼


```java
// åˆ›å»ºå’Œä¿å­˜
Clazz clazz = new Clazz();
clazz.setName("ä¸€å¹´çº§1ç­");
clazzRepository.save(clazz);

Student student = new Student();
student.setName("å¼ ä¸‰");
student.setClazz(clazz);  // è®¾ç½®å…³è”å¯¹è±¡
studentRepository.save(student);

// æŸ¥è¯¢å’Œä½¿ç”¨
Student student = studentRepository.findById(1L).get();
System.out.println(student.getName());           // å¼ ä¸‰
System.out.println(student.getClazz().getName()); // ä¸€å¹´çº§1ç­
```

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
```
å»¶è¿ŸåŠ è½½é—®é¢˜ï¼š

@ManyToOne(fetch = FetchType.LAZY)   // å»¶è¿ŸåŠ è½½ï¼ˆæ¨èï¼‰
@ManyToOne(fetch = FetchType.EAGER)  // ç«‹å³åŠ è½½

é»˜è®¤æ˜¯ç«‹å³åŠ è½½ï¼ˆEAGERï¼‰ï¼Œå¯èƒ½å¯¼è‡´N+1æŸ¥è¯¢é—®é¢˜
å»ºè®®æ˜¾å¼è®¾ç½®ä¸ºLAZYï¼Œéœ€è¦æ—¶å†åŠ è½½
```

---

## 3. ğŸ“¦ ä¸€å¯¹å¤šæ˜ å°„è¯¦è§£


### 3.1 @OneToManyæ ¸å¿ƒæ¦‚å¿µ


**å®šä¹‰**ï¼š`@OneToMany` è¡¨ç¤ºå½“å‰å®ä½“æ˜¯"ä¸€"çš„ä¸€æ–¹ï¼Œå…³è”åˆ°"å¤š"çš„ä¸€æ–¹

**ç‰¹ç‚¹**ï¼š
- ğŸ”¸ é€šå¸¸éœ€è¦ç”¨é›†åˆç±»å‹ï¼ˆListã€Setç­‰ï¼‰
- ğŸ”¸ å¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å’Œ`@ManyToOne`é…åˆå½¢æˆåŒå‘å…³ç³»
- ğŸ”¸ ä¸æ¨èå•ç‹¬ä½¿ç”¨ï¼Œå®¹æ˜“äº§ç”Ÿä¸­é—´è¡¨

### 3.2 åŸºç¡€ç”¨æ³•ç¤ºä¾‹


```java
@Entity
@Table(name = "class")
public class Clazz {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    
    // ä¸€å¯¹å¤šå…³ç³»ï¼šä¸€ä¸ªç­çº§æœ‰å¤šä¸ªå­¦ç”Ÿ
    @OneToMany(mappedBy = "clazz")  // mappedByæŒ‡å‘Studentä¸­çš„å­—æ®µå
    private List<Student> students;
    
    // getter/setterçœç•¥
}
```

**å…³é”®ç†è§£**ï¼š
- `mappedBy = "clazz"`ï¼šè¡¨ç¤ºå…³ç³»ç”±å¯¹æ–¹ï¼ˆStudentï¼‰çš„clazzå­—æ®µç»´æŠ¤
- `mappedBy`çš„å€¼æ˜¯å¯¹æ–¹å®ä½“ä¸­çš„**å­—æ®µå**ï¼Œä¸æ˜¯è¡¨åæˆ–åˆ—å
- æœ‰`mappedBy`çš„ä¸€æ–¹æ˜¯**è¢«åŠ¨æ–¹**ï¼Œä¸è´Ÿè´£ç»´æŠ¤å¤–é”®

### 3.3 mappedByå±æ€§è¯¦è§£


**ğŸ”¸ ä½œç”¨è¯´æ˜**ï¼š
```
mappedByçš„å«ä¹‰ï¼š
"è¿™ä¸ªå…³ç³»ä¸ç”±æˆ‘ç»´æŠ¤ï¼Œç”±å¯¹æ–¹çš„æŸä¸ªå­—æ®µç»´æŠ¤"

@OneToMany(mappedBy = "clazz")
              â†‘
         æŒ‡å‘Studentå®ä½“ä¸­çš„clazzå­—æ®µ
```

**ğŸ”¸ åŒå‘å…³ç³»å¯¹åº”**ï¼š
```java
// Clazzå®ä½“
@OneToMany(mappedBy = "clazz")  // è¢«åŠ¨æ–¹ï¼Œä¸ç»´æŠ¤å¤–é”®
private List<Student> students;

// Studentå®ä½“  
@ManyToOne
@JoinColumn(name = "class_id")  // ä¸»åŠ¨æ–¹ï¼Œç»´æŠ¤å¤–é”®
private Clazz clazz;
```

**âš ï¸ å¸¸è§é”™è¯¯**ï¼š
```java
// âŒ é”™è¯¯ï¼šmappedByå†™æˆäº†è¡¨åæˆ–åˆ—å
@OneToMany(mappedBy = "class_id")  // é”™è¯¯ï¼

// âœ… æ­£ç¡®ï¼šmappedByå†™å­—æ®µå
@OneToMany(mappedBy = "clazz")     // æ­£ç¡®
```

### 3.4 ä¸€å¯¹å¤šçš„ä½¿ç”¨æ–¹å¼


```java
// æŸ¥è¯¢ç­çº§åŠå…¶å­¦ç”Ÿ
Clazz clazz = clazzRepository.findById(101L).get();
System.out.println(clazz.getName());  // ä¸€å¹´çº§1ç­

List<Student> students = clazz.getStudents();
for (Student student : students) {
    System.out.println(student.getName());  // å¼ ä¸‰ã€æå››...
}
```

**ğŸ”¸ çº§è”æ“ä½œ**ï¼š
```java
@OneToMany(
    mappedBy = "clazz",
    cascade = CascadeType.ALL,      // çº§è”æ‰€æœ‰æ“ä½œ
    orphanRemoval = true            // åˆ é™¤å­¤å„¿å¯¹è±¡
)
private List<Student> students;

// ä½¿ç”¨çº§è”
Clazz clazz = new Clazz();
clazz.setName("ä¸€å¹´çº§1ç­");

Student student = new Student();
student.setName("å¼ ä¸‰");
student.setClazz(clazz);

clazz.setStudents(Arrays.asList(student));
clazzRepository.save(clazz);  // ä¼šè‡ªåŠ¨ä¿å­˜å­¦ç”Ÿ
```

---

## 4. ğŸ”„ åŒå‘å…³ç³»ç»´æŠ¤


### 4.1 ä»€ä¹ˆæ˜¯åŒå‘å…³ç³»


**å®šä¹‰**ï¼šä¸¤ä¸ªå®ä½“äº’ç›¸æŒæœ‰å¯¹æ–¹çš„å¼•ç”¨

```
å•å‘å…³ç³»ï¼š               åŒå‘å…³ç³»ï¼š
Student â†’ Clazz        Student â†â†’ Clazz
åªèƒ½ä»å­¦ç”Ÿæ‰¾ç­çº§         å¯ä»¥äº’ç›¸æŸ¥æ‰¾
```

**åŒå‘å…³ç³»é…ç½®**ï¼š
```java
// Studentå®ä½“ï¼ˆå…³ç³»ç»´æŠ¤æ–¹ï¼‰
@ManyToOne
@JoinColumn(name = "class_id")
private Clazz clazz;

// Clazzå®ä½“ï¼ˆå…³ç³»è¢«ç»´æŠ¤æ–¹ï¼‰
@OneToMany(mappedBy = "clazz")
private List<Student> students;
```

### 4.2 å…³ç³»ç»´æŠ¤åŸåˆ™


**æ ¸å¿ƒè§„åˆ™**ï¼š
- ğŸ”¸ **å¤šå¯¹ä¸€æ–¹**æ˜¯å…³ç³»ç»´æŠ¤æ–¹ï¼ˆ@JoinColumnï¼‰
- ğŸ”¸ **ä¸€å¯¹å¤šæ–¹**æ˜¯è¢«ç»´æŠ¤æ–¹ï¼ˆmappedByï¼‰
- ğŸ”¸ åªæœ‰ç»´æŠ¤æ–¹çš„ä¿®æ”¹ä¼šåŒæ­¥åˆ°æ•°æ®åº“

```
å…³ç³»ç»´æŠ¤å›¾ç¤ºï¼š

Studentï¼ˆç»´æŠ¤æ–¹ï¼‰         Clazzï¼ˆè¢«ç»´æŠ¤æ–¹ï¼‰
+----------------+       +----------------+
| @ManyToOne     |       | @OneToMany     |
| @JoinColumn    |------>| mappedBy       |
| æ§åˆ¶å¤–é”®å€¼      |       | ä¸æ§åˆ¶å¤–é”®      |
+----------------+       +----------------+
        â†“
    æ•°æ®åº“å¤–é”®åˆ—
```

### 4.3 åŒå‘å…³ç³»åŒæ­¥


**é—®é¢˜**ï¼šè®¾ç½®ä¸€æ–¹çš„å…³ç³»åï¼Œå¦ä¸€æ–¹ä¸ä¼šè‡ªåŠ¨åŒæ­¥

```java
// âŒ åªè®¾ç½®Studentä¸€æ–¹
Student student = new Student();
student.setClazz(clazz);  // åªè®¾ç½®äº†å­¦ç”Ÿçš„ç­çº§

// æ­¤æ—¶ clazz.getStudents() è¿˜æ˜¯ç©ºçš„ï¼
```

**è§£å†³æ–¹æ¡ˆ**ï¼šæä¾›ä¾¿æ·æ–¹æ³•åŒæ­¥åŒæ–¹

```java
@Entity
public class Clazz {
    
    @OneToMany(mappedBy = "clazz")
    private List<Student> students = new ArrayList<>();
    
    // ä¾¿æ·æ–¹æ³•ï¼šæ·»åŠ å­¦ç”Ÿå¹¶åŒæ­¥å…³ç³»
    public void addStudent(Student student) {
        students.add(student);     // æ·»åŠ åˆ°é›†åˆ
        student.setClazz(this);    // è®¾ç½®åå‘å¼•ç”¨
    }
    
    // ä¾¿æ·æ–¹æ³•ï¼šç§»é™¤å­¦ç”Ÿå¹¶åŒæ­¥å…³ç³»
    public void removeStudent(Student student) {
        students.remove(student);
        student.setClazz(null);
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
Clazz clazz = new Clazz();
clazz.setName("ä¸€å¹´çº§1ç­");

Student student = new Student();
student.setName("å¼ ä¸‰");

// ä½¿ç”¨ä¾¿æ·æ–¹æ³•åŒæ­¥å…³ç³»
clazz.addStudent(student);

// ä¿å­˜ï¼ˆæ³¨æ„çº§è”é…ç½®ï¼‰
clazzRepository.save(clazz);
```

---

## 5. ğŸ“‹ é›†åˆç±»å‹é€‰æ‹©


### 5.1 List vs Setå¯¹æ¯”


**ğŸ”¸ Listé›†åˆ**ï¼š
```java
@OneToMany(mappedBy = "clazz")
private List<Student> students;

ç‰¹ç‚¹ï¼š
âœ… æœ‰åºï¼Œä¿æŒæ’å…¥é¡ºåº
âœ… å…è®¸é‡å¤å…ƒç´ 
âœ… å¯ä»¥é€šè¿‡ç´¢å¼•è®¿é—®
âš ï¸ å¯èƒ½æœ‰æ€§èƒ½é—®é¢˜ï¼ˆequalsåˆ¤æ–­ï¼‰
```

**ğŸ”¸ Seté›†åˆ**ï¼š
```java
@OneToMany(mappedBy = "clazz")
private Set<Student> students = new HashSet<>();

ç‰¹ç‚¹ï¼š
âœ… æ— åºï¼Œå…ƒç´ ä¸é‡å¤
âœ… æ€§èƒ½æ›´å¥½
âœ… é¿å…é‡å¤æ·»åŠ åŒä¸€å¯¹è±¡
âš ï¸ éœ€è¦æ­£ç¡®å®ç°equalså’ŒhashCode
```

### 5.2 é›†åˆç±»å‹é€‰æ‹©å»ºè®®


| åœºæ™¯ | æ¨èç±»å‹ | åŸå›  |
|------|---------|------|
| **éœ€è¦ä¿æŒé¡ºåº** | `List` | è®¢å•é¡¹ã€è¯„è®ºç­‰éœ€è¦æŒ‰æ—¶é—´æ’åº |
| **ä¸å…³å¿ƒé¡ºåº** | `Set` | æ€§èƒ½æ›´å¥½ï¼Œé¿å…é‡å¤ |
| **å¤§é‡æ•°æ®** | `Set` | æ€§èƒ½ä¼˜åŠ¿æ˜æ˜¾ |
| **é¢‘ç¹å¢åˆ ** | `Set` | é¿å…containsæ£€æŸ¥ |

**å®é™…å»ºè®®**ï¼š
```java
// ğŸŸ¢ æ¨èï¼šä½¿ç”¨Setï¼Œæ€§èƒ½æ›´å¥½
@OneToMany(mappedBy = "clazz")
private Set<Student> students = new HashSet<>();

// ğŸŸ¡ å¦‚æœéœ€è¦æ’åºï¼Œä½¿ç”¨@OrderBy
@OneToMany(mappedBy = "clazz")
@OrderBy("name ASC")  // æŒ‰åå­—å‡åº
private List<Student> students;
```

### 5.3 é›†åˆåˆå§‹åŒ–å»ºè®®


```java
// âœ… æ¨èï¼šå­—æ®µå£°æ˜æ—¶åˆå§‹åŒ–
@OneToMany(mappedBy = "clazz")
private List<Student> students = new ArrayList<>();

// é¿å…ç©ºæŒ‡é’ˆå¼‚å¸¸
clazz.getStudents().add(student);  // ä¸ä¼šæŠ¥é”™

// âŒ ä¸æ¨èï¼šä¸åˆå§‹åŒ–
@OneToMany(mappedBy = "clazz")
private List<Student> students;

// å¯èƒ½ç©ºæŒ‡é’ˆ
clazz.getStudents().add(student);  // NullPointerException!
```

---

## 6. ğŸ”§ å¤–é”®çº¦æŸå¤„ç†


### 6.1 å¤–é”®çº¦æŸåŸºç¡€


**ä»€ä¹ˆæ˜¯å¤–é”®çº¦æŸ**ï¼š
```
æ•°æ®åº“å±‚é¢çš„è§„åˆ™ï¼Œä¿è¯æ•°æ®å®Œæ•´æ€§

studentè¡¨                  classè¡¨
+----+------+----------+   +----+----------+
| id | name | class_id |â†’  | id | name     |
+----+------+----------+   +----+----------+
         â†‘
    å¤–é”®çº¦æŸï¼šclass_idå¿…é¡»æ˜¯classè¡¨ä¸­å­˜åœ¨çš„id
```

**JPAä¸­çš„å¤–é”®é…ç½®**ï¼š
```java
@ManyToOne
@JoinColumn(
    name = "class_id",
    foreignKey = @ForeignKey(
        name = "fk_student_class",           // çº¦æŸåç§°
        foreignKeyDefinition = "FOREIGN KEY (class_id) REFERENCES class(id)"
    )
)
private Clazz clazz;
```

### 6.2 åˆ é™¤æ—¶çš„å¤–é”®é—®é¢˜


**é—®é¢˜åœºæ™¯**ï¼šåˆ é™¤ç­çº§æ—¶ï¼Œå¦‚æœè¿˜æœ‰å­¦ç”Ÿæ€ä¹ˆåŠï¼Ÿ

```
æ•°æ®åº“æŠ¥é”™ï¼š
Cannot delete or update a parent row: 
a foreign key constraint fails
```

**ğŸ”¸ è§£å†³æ–¹æ¡ˆ1ï¼šçº§è”åˆ é™¤**
```java
@OneToMany(
    mappedBy = "clazz",
    cascade = CascadeType.REMOVE  // åˆ é™¤ç­çº§æ—¶åˆ é™¤æ‰€æœ‰å­¦ç”Ÿ
)
private List<Student> students;

// æˆ–è€…åœ¨@ManyToOneç«¯è®¾ç½®
@ManyToOne(cascade = CascadeType.REMOVE)
@JoinColumn(name = "class_id")
private Clazz clazz;
```

**ğŸ”¸ è§£å†³æ–¹æ¡ˆ2ï¼šè®¾ç½®ä¸ºNULL**
```java
@ManyToOne
@JoinColumn(
    name = "class_id",
    nullable = true  // å…è®¸ä¸ºç©º
)
private Clazz clazz;

// åˆ é™¤å‰å…ˆè§£é™¤å…³ç³»
List<Student> students = clazz.getStudents();
for (Student student : students) {
    student.setClazz(null);  // è§£é™¤å…³ç³»
}
studentRepository.saveAll(students);
clazzRepository.delete(clazz);
```

**ğŸ”¸ è§£å†³æ–¹æ¡ˆ3ï¼šå…ˆåˆ é™¤å­è®°å½•**
```java
// æ‰‹åŠ¨å…ˆåˆ é™¤å­¦ç”Ÿ
studentRepository.deleteAll(clazz.getStudents());
// å†åˆ é™¤ç­çº§
clazzRepository.delete(clazz);
```

### 6.3 å¤–é”®çº¦æŸå®è·µå»ºè®®


**ğŸŸ¢ æ¨èåšæ³•**ï¼š
```java
// æ˜ç¡®æŒ‡å®šçº¦æŸåç§°ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
@JoinColumn(
    name = "class_id",
    foreignKey = @ForeignKey(name = "fk_student_class")
)

// æ ¹æ®ä¸šåŠ¡å†³å®šæ˜¯å¦å…è®¸NULL
@JoinColumn(
    name = "class_id",
    nullable = false  // å­¦ç”Ÿå¿…é¡»æœ‰ç­çº§
)
```

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
- çº§è”åˆ é™¤è¦è°¨æ…ï¼Œå¯èƒ½è¯¯åˆ æ•°æ®
- ç”Ÿäº§ç¯å¢ƒå»ºè®®æ‰‹åŠ¨ç®¡ç†åˆ é™¤é€»è¾‘
- è€ƒè™‘ä½¿ç”¨è½¯åˆ é™¤ï¼ˆé€»è¾‘åˆ é™¤ï¼‰

---

## 7. ğŸ”„ å…³ç³»æ›´æ–°è¯­ä¹‰


### 7.1 æ–°å¢å…³ç³»


**åœºæ™¯**ï¼šç»™ç­çº§æ·»åŠ æ–°å­¦ç”Ÿ

```java
// æ–¹å¼1ï¼šä»å­¦ç”Ÿç«¯è®¾ç½®ï¼ˆæ¨èï¼Œå› ä¸ºå­¦ç”Ÿæ˜¯ç»´æŠ¤æ–¹ï¼‰
Student newStudent = new Student();
newStudent.setName("èµµå…­");
newStudent.setClazz(clazz);  // è®¾ç½®ç­çº§
studentRepository.save(newStudent);

// æ–¹å¼2ï¼šä»ç­çº§ç«¯æ·»åŠ ï¼ˆéœ€è¦é…ç½®çº§è”ï¼‰
@OneToMany(
    mappedBy = "clazz",
    cascade = CascadeType.PERSIST  // çº§è”ä¿å­˜
)
private List<Student> students;

clazz.addStudent(newStudent);  // ä½¿ç”¨ä¾¿æ·æ–¹æ³•
clazzRepository.save(clazz);   // ä¼šçº§è”ä¿å­˜å­¦ç”Ÿ
```

### 7.2 ä¿®æ”¹å…³ç³»


**åœºæ™¯**ï¼šå­¦ç”Ÿè½¬ç­

```java
// å­¦ç”Ÿä»ä¸€ä¸ªç­çº§è½¬åˆ°å¦ä¸€ä¸ªç­çº§
Student student = studentRepository.findById(1L).get();
Clazz newClazz = clazzRepository.findById(102L).get();

// æ–¹å¼1ï¼šç›´æ¥ä¿®æ”¹ï¼ˆç®€å•ï¼‰
student.setClazz(newClazz);
studentRepository.save(student);

// æ–¹å¼2ï¼šåŒæ­¥åŒæ–¹å…³ç³»ï¼ˆå®Œæ•´ï¼‰
Clazz oldClazz = student.getClazz();
if (oldClazz != null) {
    oldClazz.removeStudent(student);  // ä»æ—§ç­çº§ç§»é™¤
}
newClazz.addStudent(student);         // æ·»åŠ åˆ°æ–°ç­çº§
studentRepository.save(student);
```

**âš ï¸ æ³¨æ„**ï¼š
```
ä¿®æ”¹å…³ç³»æ—¶çš„é™·é˜±ï¼š

// âŒ é”™è¯¯ï¼šåªä¿®æ”¹é›†åˆï¼Œä¸ä¿®æ”¹å¯¹è±¡
clazz.getStudents().remove(student);  
// student.getClazz() è¿˜æ˜¯æŒ‡å‘æ—§ç­çº§ï¼

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ä¾¿æ·æ–¹æ³•åŒæ­¥åŒæ–¹
clazz.removeStudent(student);
```

### 7.3 åˆ é™¤å…³ç³»


**åœºæ™¯1ï¼šåˆ é™¤å­¦ç”Ÿï¼ˆä¿ç•™ç­çº§ï¼‰**
```java
Student student = studentRepository.findById(1L).get();
Clazz clazz = student.getClazz();

// ä»ç­çº§ç§»é™¤å­¦ç”Ÿ
if (clazz != null) {
    clazz.removeStudent(student);
}

// åˆ é™¤å­¦ç”Ÿ
studentRepository.delete(student);
```

**åœºæ™¯2ï¼šåˆ é™¤ç­çº§ï¼ˆå¤„ç†å­¦ç”Ÿï¼‰**
```java
Clazz clazz = clazzRepository.findById(101L).get();

// é€‰é¡¹1ï¼šçº§è”åˆ é™¤å­¦ç”Ÿ
@OneToMany(
    mappedBy = "clazz",
    cascade = CascadeType.REMOVE,
    orphanRemoval = true
)
clazzRepository.delete(clazz);  // è‡ªåŠ¨åˆ é™¤æ‰€æœ‰å­¦ç”Ÿ

// é€‰é¡¹2ï¼šè§£é™¤å…³ç³»ï¼Œä¿ç•™å­¦ç”Ÿ
for (Student student : clazz.getStudents()) {
    student.setClazz(null);
}
studentRepository.saveAll(clazz.getStudents());
clazzRepository.delete(clazz);
```

### 7.4 å­¤å„¿å¯¹è±¡å¤„ç†


**ä»€ä¹ˆæ˜¯å­¤å„¿å¯¹è±¡**ï¼š
```
å­¤å„¿å¯¹è±¡ï¼šå¤±å»çˆ¶å¯¹è±¡å…³è”çš„å­å¯¹è±¡

ä¾‹å¦‚ï¼šå­¦ç”Ÿä»ç­çº§ç§»é™¤åï¼Œstudentå¯¹è±¡å˜æˆå­¤å„¿
```

**orphanRemovalå±æ€§**ï¼š
```java
@OneToMany(
    mappedBy = "clazz",
    orphanRemoval = true  // è‡ªåŠ¨åˆ é™¤å­¤å„¿å¯¹è±¡
)
private List<Student> students;

// ä»é›†åˆä¸­ç§»é™¤ï¼Œä¼šè‡ªåŠ¨åˆ é™¤æ•°æ®åº“è®°å½•
clazz.getStudents().remove(student);
clazzRepository.save(clazz);
// studentä¼šè¢«è‡ªåŠ¨ä»æ•°æ®åº“åˆ é™¤
```

**ä½¿ç”¨å»ºè®®**ï¼š
```
ğŸŸ¢ é€‚ç”¨åœºæ™¯ï¼š
- å­å¯¹è±¡å®Œå…¨ä¾èµ–çˆ¶å¯¹è±¡
- ç§»é™¤å…³ç³»åå­å¯¹è±¡æ— æ„ä¹‰
- ä¾‹å¦‚ï¼šè®¢å•-è®¢å•é¡¹ã€æ–‡ç« -è¯„è®º

ğŸ”´ ä¸é€‚ç”¨åœºæ™¯ï¼š
- å­å¯¹è±¡å¯ä»¥ç‹¬ç«‹å­˜åœ¨
- ç§»é™¤å…³ç³»åä»éœ€ä¿ç•™
- ä¾‹å¦‚ï¼šç­çº§-å­¦ç”Ÿï¼ˆå­¦ç”Ÿå¯ä»¥æ²¡ç­çº§ï¼‰
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¤šå¯¹ä¸€(@ManyToOne)ï¼šå¤šçš„ä¸€æ–¹å…³è”ä¸€çš„ä¸€æ–¹ï¼Œæ˜¯å…³ç³»ç»´æŠ¤æ–¹
ğŸ”¸ ä¸€å¯¹å¤š(@OneToMany)ï¼šä¸€çš„ä¸€æ–¹å…³è”å¤šçš„ä¸€æ–¹ï¼Œé€šå¸¸æ˜¯è¢«ç»´æŠ¤æ–¹
ğŸ”¸ @JoinColumnï¼šæŒ‡å®šå¤–é”®åˆ—ï¼Œæ§åˆ¶æ•°æ®åº“è¡¨ç»“æ„
ğŸ”¸ mappedByï¼šå£°æ˜è¢«ç»´æŠ¤æ–¹ï¼ŒæŒ‡å‘å¯¹æ–¹çš„å­—æ®µå
ğŸ”¸ åŒå‘å…³ç³»ï¼šéœ€è¦åŒæ—¶é…ç½®ä¸¤ç«¯ï¼Œæ³¨æ„å…³ç³»åŒæ­¥
ğŸ”¸ é›†åˆç±»å‹ï¼šListä¿åºå…é‡å¤ï¼ŒSetæ— åºä¸é‡å¤ï¼ŒæŒ‰éœ€é€‰æ‹©
ğŸ”¸ å¤–é”®çº¦æŸï¼šå½±å“åˆ é™¤æ›´æ–°è¡Œä¸ºï¼Œéœ€é…ç½®çº§è”æˆ–æ‰‹åŠ¨å¤„ç†
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å…³ç³»ç»´æŠ¤åŸåˆ™**
```
é“å¾‹ï¼šå¤šå¯¹ä¸€æ–¹æ˜¯å…³ç³»ç»´æŠ¤æ–¹

Studentï¼ˆå¤šï¼‰ â†’ Clazzï¼ˆä¸€ï¼‰
    â†“
@JoinColumn        mappedBy
ç»´æŠ¤å¤–é”®           è¢«ç»´æŠ¤

åªæœ‰Studentç«¯çš„ä¿®æ”¹ä¼šå½±å“æ•°æ®åº“å¤–é”®å€¼
```

**ğŸ”¹ mappedByçš„å«ä¹‰**
```
@OneToMany(mappedBy = "clazz")
           â†‘
    "æˆ‘ä¸ç»´æŠ¤å…³ç³»ï¼Œç”±å¯¹æ–¹çš„clazzå­—æ®µç»´æŠ¤"
    
è®°å¿†ï¼šmappedBy = "å¯¹æ–¹ç»´æŠ¤å…³ç³»çš„å­—æ®µå"
```

**ğŸ”¹ çº§è”æ“ä½œä½¿ç”¨åœºæ™¯**
```
CascadeType.PERSIST   â†’ ä¿å­˜çˆ¶å¯¹è±¡æ—¶ä¿å­˜å­å¯¹è±¡
CascadeType.MERGE     â†’ æ›´æ–°çˆ¶å¯¹è±¡æ—¶æ›´æ–°å­å¯¹è±¡
CascadeType.REMOVE    â†’ åˆ é™¤çˆ¶å¯¹è±¡æ—¶åˆ é™¤å­å¯¹è±¡
CascadeType.ALL       â†’ æ‰€æœ‰æ“ä½œéƒ½çº§è”

orphanRemoval = true  â†’ ç§»é™¤å…³ç³»æ—¶åˆ é™¤å­¤å„¿å¯¹è±¡
```

### 8.3 å®é™…åº”ç”¨å»ºè®®


**âœ… æœ€ä½³å®è·µ**
```java
// 1. æ¨èé…ç½®ï¼šæ¸…æ™°æ˜ç¡®
@ManyToOne(fetch = FetchType.LAZY)  // å»¶è¿ŸåŠ è½½
@JoinColumn(
    name = "class_id",              // æ˜ç¡®å¤–é”®å
    nullable = false,               // æ˜ç¡®æ˜¯å¦å¯ç©º
    foreignKey = @ForeignKey(name = "fk_student_class")
)
private Clazz clazz;

// 2. é›†åˆåˆå§‹åŒ–
@OneToMany(mappedBy = "clazz")
private Set<Student> students = new HashSet<>();

// 3. æä¾›ä¾¿æ·æ–¹æ³•åŒæ­¥å…³ç³»
public void addStudent(Student student) {
    students.add(student);
    student.setClazz(this);
}

// 4. è°¨æ…ä½¿ç”¨çº§è”ï¼Œé¿å…è¯¯åˆ 
@OneToMany(
    mappedBy = "clazz",
    cascade = {CascadeType.PERSIST, CascadeType.MERGE}
    // ä¸åŒ…å«REMOVEï¼Œé¿å…è¯¯åˆ 
)
```

**âš ï¸ å¸¸è§é”™è¯¯**
```java
// âŒ mappedByå†™é”™
@OneToMany(mappedBy = "class_id")  // é”™è¯¯ï¼šåº”è¯¥æ˜¯å­—æ®µå

// âŒ å¿˜è®°åˆå§‹åŒ–é›†åˆ
@OneToMany(mappedBy = "clazz")
private List<Student> students;    // å¯èƒ½NPE

// âŒ åªè®¾ç½®ä¸€æ–¹å…³ç³»
student.setClazz(clazz);
// clazz.getStudents()ä¸­æ²¡æœ‰studentï¼

// âŒ æ»¥ç”¨çº§è”åˆ é™¤
@OneToMany(cascade = CascadeType.ALL)  // å±é™©ï¼
```

### 8.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ğŸŸ¢ æŸ¥è¯¢ä¼˜åŒ–**
```java
// ä½¿ç”¨JOIN FETCHé¿å…N+1é—®é¢˜
@Query("SELECT c FROM Clazz c LEFT JOIN FETCH c.students WHERE c.id = :id")
Clazz findByIdWithStudents(@Param("id") Long id);

// å»¶è¿ŸåŠ è½½é¿å…ä¸å¿…è¦çš„æŸ¥è¯¢
@ManyToOne(fetch = FetchType.LAZY)
private Clazz clazz;
```

**ğŸŸ¢ é›†åˆé€‰æ‹©**
```
æ•°æ®é‡å°(<100)   â†’ Listæˆ–Setéƒ½å¯ä»¥
æ•°æ®é‡å¤§(>1000)  â†’ ä¼˜å…ˆSetï¼Œæ€§èƒ½æ›´å¥½
éœ€è¦æ’åº         â†’ List + @OrderBy
é¢‘ç¹å¢åˆ          â†’ Setï¼Œé¿å…é‡å¤æ£€æŸ¥
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
å¤šå¯¹ä¸€å…³ç³»æ‰¾ç»´æŠ¤æ–¹ï¼Œ
å¤–é”®åˆ—åœ¨å¤šçš„ä¸€æ–¹ã€‚
ä¸€å¯¹å¤šéœ€è¦mappedByï¼Œ
å­—æ®µåç§°åˆ«å†™é”™ã€‚
åŒå‘å…³ç³»è¦åŒæ­¥ï¼Œ
ä¾¿æ·æ–¹æ³•æœ€ç¨³å¦¥ã€‚
çº§è”åˆ é™¤éœ€è°¨æ…ï¼Œ
æ‰‹åŠ¨æ§åˆ¶æ›´å¯é ã€‚
```