---
title: 70ã€é›†æˆæµ‹è¯•Testcontainers
---
## ğŸ“š ç›®å½•

1. [é›†æˆæµ‹è¯•åŸºç¡€æ¦‚å¿µ](#1-é›†æˆæµ‹è¯•åŸºç¡€æ¦‚å¿µ)
2. [Testcontainersæ ¸å¿ƒåŸç†](#2-Testcontainersæ ¸å¿ƒåŸç†)
3. [æ•°æ®åº“å®¹å™¨åŒ–æµ‹è¯•å®æˆ˜](#3-æ•°æ®åº“å®¹å™¨åŒ–æµ‹è¯•å®æˆ˜)
4. [æµ‹è¯•ç¯å¢ƒéš”ç¦»ä¸ç®¡ç†](#4-æµ‹è¯•ç¯å¢ƒéš”ç¦»ä¸ç®¡ç†)
5. [CI/CDé›†æˆæœ€ä½³å®è·µ](#5-CICDé›†æˆæœ€ä½³å®è·µ)
6. [æ€§èƒ½æµ‹è¯•è€ƒè™‘è¦ç‚¹](#6-æ€§èƒ½æµ‹è¯•è€ƒè™‘è¦ç‚¹)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ é›†æˆæµ‹è¯•åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯é›†æˆæµ‹è¯•


**é€šä¿—ç†è§£**ï¼šå•å…ƒæµ‹è¯•å°±åƒæ£€æŸ¥æ±½è½¦çš„æ¯ä¸ªé›¶ä»¶ï¼Œè€Œé›†æˆæµ‹è¯•å°±åƒæŠŠæ‰€æœ‰é›¶ä»¶ç»„è£…èµ·æ¥ï¼Œçœ‹è½¦èƒ½ä¸èƒ½æ­£å¸¸å¼€åŠ¨ã€‚

```
å•å…ƒæµ‹è¯•ï¼šåªæµ‹è¯•ä¸€ä¸ªæ–¹æ³•æˆ–ç±»
   UserService.save() âœ“

é›†æˆæµ‹è¯•ï¼šæµ‹è¯•å¤šä¸ªç»„ä»¶åä½œ
   UserService â†’ JPA â†’ æ•°æ®åº“ 
   æ•´ä¸ªæµç¨‹éƒ½è¦è·‘é€š âœ“
```

**ğŸ”¸ æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”**

| æµ‹è¯•ç±»å‹ | **æµ‹è¯•èŒƒå›´** | **æ•°æ®åº“** | **é€Ÿåº¦** | **å¯é æ€§** |
|---------|------------|-----------|---------|-----------|
| **å•å…ƒæµ‹è¯•** | `å•ä¸ªæ–¹æ³•/ç±»` | `Mockå‡æ•°æ®` | `æå¿«` | `ä¸€èˆ¬` |
| **é›†æˆæµ‹è¯•** | `å¤šç»„ä»¶åä½œ` | `çœŸå®æ•°æ®åº“` | `è¾ƒæ…¢` | `å¾ˆé«˜` |

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦é›†æˆæµ‹è¯•


**ğŸ”¸ å•å…ƒæµ‹è¯•çš„å±€é™æ€§**

```java
// å•å…ƒæµ‹è¯•ï¼šç”¨Mockå‡è£…æ•°æ®åº“
@Test
void testSave() {
    when(userRepository.save(user)).thenReturn(user);
    // åªæµ‹è¯•äº†æ–¹æ³•é€»è¾‘ï¼Œæ²¡æµ‹çœŸå®çš„æ•°æ®åº“æ“ä½œ
}
```

**é—®é¢˜åœ¨å“ª**ï¼š
- âŒ SQLè¯­å¥å¯èƒ½å†™é”™äº†ï¼Œä½†æµ‹è¯•é€šè¿‡
- âŒ æ•°æ®åº“çº¦æŸå¯èƒ½å†²çªï¼Œä½†æµ‹ä¸å‡ºæ¥
- âŒ äº‹åŠ¡å›æ»šå¯èƒ½æœ‰é—®é¢˜ï¼Œæµ‹ä¸åˆ°

**ğŸ”¸ é›†æˆæµ‹è¯•çš„ä»·å€¼**

```
çœŸå®åœºæ™¯ï¼š
   ç”¨æˆ·æ³¨å†Œ â†’ ä¿å­˜æ•°æ®åº“ â†’ å‘é€é‚®ä»¶ â†’ è®°å½•æ—¥å¿—
   
é›†æˆæµ‹è¯•ä¼šæµ‹ï¼š
   âœ“ æ•°æ®çœŸçš„å­˜è¿›å»äº†å—ï¼Ÿ
   âœ“ å”¯ä¸€çº¦æŸçœŸçš„ç”Ÿæ•ˆäº†å—ï¼Ÿ
   âœ“ äº‹åŠ¡å›æ»šçœŸçš„æœ‰ç”¨å—ï¼Ÿ
   âœ“ å„ä¸ªæ¨¡å—é…åˆçœŸçš„æ²¡é—®é¢˜å—ï¼Ÿ
```

### 1.3 ä¼ ç»Ÿé›†æˆæµ‹è¯•çš„ç—›ç‚¹


**ğŸ˜« ä»¥å‰çš„å›°å¢ƒ**

```
ä¼ ç»Ÿåšæ³•ï¼š
   1. æ‰‹åŠ¨å®‰è£…MySQL â†’ éº»çƒ¦
   2. é…ç½®æµ‹è¯•æ•°æ®åº“ â†’ å®¹æ˜“å‡ºé”™
   3. æ¯ä¸ªäººç”µè„‘ç¯å¢ƒä¸åŒ â†’ "æˆ‘è¿™èƒ½è·‘å•Š"
   4. æµ‹è¯•æ•°æ®äº’ç›¸æ±¡æŸ“ â†’ æ—¶å¥½æ—¶å
   5. CI/CDæœåŠ¡å™¨è¿˜è¦å†è£…ä¸€é â†’ å¤´ç–¼
```

**ğŸ’¡ Testcontainersè§£å†³æ–¹æ¡ˆ**

```
ç°åœ¨çš„åšæ³•ï¼š
   1. æµ‹è¯•å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºDockerå®¹å™¨
   2. ç”¨å®Œè‡ªåŠ¨é”€æ¯ï¼Œå¹²å‡€åˆ©è½
   3. æ¯ä¸ªäººã€æ¯æ¬¡æµ‹è¯•éƒ½ç”¨å…¨æ–°ç¯å¢ƒ
   4. æœ¬åœ°å’ŒCI/CDå®Œå…¨ä¸€è‡´
   5. ä¸éœ€è¦æ‰‹åŠ¨å®‰è£…ä»»ä½•æ•°æ®åº“
```

---

## 2. ğŸ³ Testcontainersæ ¸å¿ƒåŸç†


### 2.1 Testcontainersæ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼šå°±æ˜¯ä¸€ä¸ªJavaåº“ï¼Œèƒ½åœ¨æµ‹è¯•æ—¶è‡ªåŠ¨å¯åŠ¨Dockerå®¹å™¨ï¼Œæµ‹å®Œè‡ªåŠ¨å…³é—­ã€‚

```
å·¥ä½œæµç¨‹ï¼š
   
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  è¿è¡Œæµ‹è¯•    â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ å¯åŠ¨Docker   â”‚ â† Testcontainersè‡ªåŠ¨å¹²çš„
   â”‚ MySQLå®¹å™¨    â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹  â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ é”€æ¯å®¹å™¨     â”‚ â† è‡ªåŠ¨æ¸…ç†ï¼Œä¸ç•™åƒåœ¾
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 åŸºæœ¬ä½¿ç”¨æ­¥éª¤


**ğŸ”¸ ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ–**

```xml
<!-- Mavenä¾èµ– -->
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>mysql</artifactId>
    <version>1.19.0</version>
    <scope>test</scope>
</dependency>
```

**ğŸ”¸ ç¬¬äºŒæ­¥ï¼šç¼–å†™æµ‹è¯•ç±»**

```java
@SpringBootTest
@Testcontainers  // å‘Šè¯‰Springï¼šæˆ‘è¦ç”¨å®¹å™¨åŒ–æµ‹è¯•
class UserServiceIntegrationTest {
    
    // å®šä¹‰MySQLå®¹å™¨
    @Container
    static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");
    
    // åŠ¨æ€é…ç½®æ•°æ®åº“è¿æ¥
    @DynamicPropertySource
    static void properties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", mysql::getJdbcUrl);
        registry.add("spring.datasource.username", mysql::getUsername);
        registry.add("spring.datasource.password", mysql::getPassword);
    }
    
    @Autowired
    private UserService userService;
    
    @Test
    void testSaveUser() {
        // è¿™é‡Œç”¨çš„æ˜¯çœŸå®çš„MySQLæ•°æ®åº“ï¼
        User user = new User("å¼ ä¸‰", "zhangsan@qq.com");
        User saved = userService.save(user);
        
        assertNotNull(saved.getId());
    }
}
```

**ğŸ”¸ å…³é”®æ³¨è§£è¯´æ˜**

- **`@Testcontainers`** - å¯ç”¨å®¹å™¨åŒ–æµ‹è¯•åŠŸèƒ½
- **`@Container`** - æ ‡è®°è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å®¹å™¨
- **`static`** - å®¹å™¨åœ¨æ‰€æœ‰æµ‹è¯•é—´å…±äº«ï¼Œåªå¯åŠ¨ä¸€æ¬¡
- **`@DynamicPropertySource`** - åŠ¨æ€è®¾ç½®é…ç½®ï¼Œè¿æ¥å®¹å™¨æ•°æ®åº“

### 2.3 å®¹å™¨ç”Ÿå‘½å‘¨æœŸ


```
å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼š

æµ‹è¯•ç±»åŠ è½½
   â†“
å¯åŠ¨Dockerå®¹å™¨ â† è‡ªåŠ¨æ‹‰å–é•œåƒã€åˆ›å»ºå®¹å™¨
   â†“
åˆå§‹åŒ–æ•°æ®åº“ â† åˆ›å»ºè¡¨ç»“æ„
   â†“
æ‰§è¡Œæµ‹è¯•1 â†’ æ‰§è¡Œæµ‹è¯•2 â†’ æ‰§è¡Œæµ‹è¯•3
   â†“
æ‰€æœ‰æµ‹è¯•å®Œæˆ
   â†“
é”€æ¯å®¹å™¨ â† è‡ªåŠ¨æ¸…ç†ï¼Œé‡Šæ”¾èµ„æº
```

**ğŸ’¡ æ€§èƒ½ä¼˜åŒ–æç¤º**

```java
// âŒ ä¸å¥½çš„åšæ³•ï¼šæ¯ä¸ªæµ‹è¯•éƒ½å¯åŠ¨æ–°å®¹å™¨
class BadTest {
    @Container  // éstaticï¼Œæ¯ä¸ªæµ‹è¯•éƒ½å¯åŠ¨
    MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0");
}

// âœ… å¥½çš„åšæ³•ï¼šæ‰€æœ‰æµ‹è¯•å…±äº«ä¸€ä¸ªå®¹å™¨
class GoodTest {
    @Container
    static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0");
    // staticè®©å®¹å™¨åªå¯åŠ¨ä¸€æ¬¡ï¼Œæ‰€æœ‰æµ‹è¯•å…±ç”¨
}
```

---

## 3. ğŸ’» æ•°æ®åº“å®¹å™¨åŒ–æµ‹è¯•å®æˆ˜


### 3.1 å®Œæ•´æµ‹è¯•ç¤ºä¾‹


**ğŸ”¸ åœºæ™¯ï¼šç”¨æˆ·ç®¡ç†ç³»ç»Ÿæµ‹è¯•**

```java
@SpringBootTest
@Testcontainers
@Transactional  // æ¯ä¸ªæµ‹è¯•åè‡ªåŠ¨å›æ»š
class UserRepositoryIntegrationTest {
    
    @Container
    static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", mysql::getJdbcUrl);
        registry.add("spring.datasource.username", mysql::getUsername);
        registry.add("spring.datasource.password", mysql::getPassword);
        registry.add("spring.jpa.hibernate.ddl-auto", () -> "create-drop");
    }
    
    @Autowired
    private UserRepository userRepository;
    
    @Test
    void æµ‹è¯•ä¿å­˜ç”¨æˆ·() {
        // å‡†å¤‡æ•°æ®
        User user = new User();
        user.setName("æå››");
        user.setEmail("lisi@qq.com");
        
        // æ‰§è¡Œä¿å­˜
        User saved = userRepository.save(user);
        
        // éªŒè¯ç»“æœ
        assertNotNull(saved.getId());  // IDè‡ªåŠ¨ç”Ÿæˆäº†
        assertEquals("æå››", saved.getName());
        
        // éªŒè¯çœŸçš„å­˜åˆ°æ•°æ®åº“äº†
        User found = userRepository.findById(saved.getId()).orElse(null);
        assertNotNull(found);
        assertEquals("lisi@qq.com", found.getEmail());
    }
    
    @Test
    void æµ‹è¯•å”¯ä¸€çº¦æŸ() {
        // ç¬¬ä¸€æ¬¡ä¿å­˜
        User user1 = new User("ç‹äº”", "wangwu@qq.com");
        userRepository.save(user1);
        
        // å°è¯•ä¿å­˜ç›¸åŒé‚®ç®±
        User user2 = new User("èµµå…­", "wangwu@qq.com");
        
        // éªŒè¯æŠ›å‡ºå¼‚å¸¸ï¼ˆå› ä¸ºé‚®ç®±å”¯ä¸€çº¦æŸï¼‰
        assertThrows(DataIntegrityViolationException.class, () -> {
            userRepository.save(user2);
            userRepository.flush();  // å¼ºåˆ¶æ‰§è¡ŒSQL
        });
    }
    
    @Test
    void æµ‹è¯•çº§è”åˆ é™¤() {
        // åˆ›å»ºç”¨æˆ·å’Œè®¢å•
        User user = new User("å­™ä¸ƒ", "sunqi@qq.com");
        Order order1 = new Order(100.0);
        Order order2 = new Order(200.0);
        
        user.addOrder(order1);
        user.addOrder(order2);
        
        userRepository.save(user);
        
        // åˆ é™¤ç”¨æˆ·
        userRepository.delete(user);
        
        // éªŒè¯è®¢å•ä¹Ÿè¢«åˆ é™¤äº†ï¼ˆçº§è”åˆ é™¤ï¼‰
        List<Order> orders = orderRepository.findAll();
        assertTrue(orders.isEmpty());
    }
}
```

### 3.2 æµ‹è¯•ä¸åŒæ•°æ®åº“


**ğŸ”¸ æ”¯æŒå¤šç§æ•°æ®åº“**

```java
// MySQLæµ‹è¯•
@Container
static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0");

// PostgreSQLæµ‹è¯•
@Container
static PostgreSQLContainer<?> postgres = 
    new PostgreSQLContainer<>("postgres:15");

// Oracleæµ‹è¯•
@Container
static OracleContainer oracle = 
    new OracleContainer("gvenzl/oracle-xe:21-slim");

// MongoDBæµ‹è¯•
@Container
static MongoDBContainer mongo = 
    new MongoDBContainer("mongo:6.0");
```

**ğŸ’¡ å¤šæ•°æ®åº“å…¼å®¹æ€§æµ‹è¯•**

```java
// ç”¨å‚æ•°åŒ–æµ‹è¯•ï¼Œä¸€æ¬¡æµ‹è¯•å¤šä¸ªæ•°æ®åº“
@ParameterizedTest
@MethodSource("databases")
void æµ‹è¯•åœ¨ä¸åŒæ•°æ®åº“ä¸Šçš„è¡¨ç°(JdbcDatabaseContainer<?> db) {
    // è¿æ¥ä¸åŒçš„æ•°æ®åº“å®¹å™¨
    // æ‰§è¡Œç›¸åŒçš„æµ‹è¯•é€»è¾‘
}

static Stream<JdbcDatabaseContainer<?>> databases() {
    return Stream.of(
        new MySQLContainer<>("mysql:8.0"),
        new PostgreSQLContainer<>("postgres:15")
    );
}
```

### 3.3 æµ‹è¯•æ•°æ®å‡†å¤‡


**ğŸ”¸ æ–¹å¼ä¸€ï¼šä½¿ç”¨SQLè„šæœ¬**

```java
@Container
static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0")
    .withDatabaseName("testdb")
    .withInitScript("init-test-data.sql");  // è‡ªåŠ¨æ‰§è¡ŒSQLè„šæœ¬
```

```sql
-- init-test-data.sql
INSERT INTO users (name, email) VALUES ('æµ‹è¯•ç”¨æˆ·1', 'test1@qq.com');
INSERT INTO users (name, email) VALUES ('æµ‹è¯•ç”¨æˆ·2', 'test2@qq.com');
```

**ğŸ”¸ æ–¹å¼äºŒï¼šä½¿ç”¨@Sqlæ³¨è§£**

```java
@Test
@Sql("/test-data.sql")  // æµ‹è¯•å‰æ‰§è¡ŒSQL
void æµ‹è¯•æŸ¥è¯¢() {
    List<User> users = userRepository.findAll();
    assertEquals(2, users.size());
}
```

**ğŸ”¸ æ–¹å¼ä¸‰ï¼šä½¿ç”¨@BeforeEach**

```java
@BeforeEach
void setUp() {
    // æ¯ä¸ªæµ‹è¯•å‰å‡†å¤‡æ•°æ®
    User user1 = new User("ç”¨æˆ·1", "user1@qq.com");
    User user2 = new User("ç”¨æˆ·2", "user2@qq.com");
    userRepository.saveAll(List.of(user1, user2));
}
```

---

## 4. ğŸ”’ æµ‹è¯•ç¯å¢ƒéš”ç¦»ä¸ç®¡ç†


### 4.1 æ•°æ®éš”ç¦»ç­–ç•¥


**ğŸ”¸ ç­–ç•¥ä¸€ï¼šäº‹åŠ¡å›æ»š**ï¼ˆæœ€å¸¸ç”¨ï¼‰

```java
@SpringBootTest
@Transactional  // æ¯ä¸ªæµ‹è¯•è‡ªåŠ¨å›æ»š
class UserServiceTest {
    
    @Test
    void æµ‹è¯•1() {
        userRepository.save(new User("ç”¨æˆ·A", "a@qq.com"));
        // æµ‹è¯•ç»“æŸåè‡ªåŠ¨å›æ»šï¼Œæ•°æ®ä¸ä¼šçœŸçš„ä¿å­˜
    }
    
    @Test
    void æµ‹è¯•2() {
        // è¿™é‡Œçœ‹ä¸åˆ°æµ‹è¯•1çš„æ•°æ®ï¼Œå®Œå…¨éš”ç¦»
        List<User> users = userRepository.findAll();
        assertTrue(users.isEmpty());
    }
}
```

**ä¸ºä»€ä¹ˆè¦å›æ»š**ï¼š
- âœ… æµ‹è¯•ä¹‹é—´ä¸äº’ç›¸å½±å“
- âœ… ä¸éœ€è¦æ‰‹åŠ¨æ¸…ç†æ•°æ®
- âœ… æµ‹è¯•å¯ä»¥é‡å¤æ‰§è¡Œ

**ğŸ”¸ ç­–ç•¥äºŒï¼šæ¯ä¸ªæµ‹è¯•ç”¨æ–°å®¹å™¨**ï¼ˆæœ€å½»åº•ä½†æ…¢ï¼‰

```java
class IsolatedTest {
    
    @Container  // æ³¨æ„ï¼šæ²¡æœ‰static
    MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0");
    
    // æ¯ä¸ªæµ‹è¯•éƒ½å¯åŠ¨æ–°å®¹å™¨ï¼Œç»å¯¹éš”ç¦»
}
```

**ğŸ”¸ ç­–ç•¥ä¸‰ï¼šæµ‹è¯•åæ¸…ç†æ•°æ®**

```java
@AfterEach
void tearDown() {
    userRepository.deleteAll();  // æ‰‹åŠ¨æ¸…ç†
    orderRepository.deleteAll();
}
```

### 4.2 å®¹å™¨èµ„æºç®¡ç†


**ğŸ”¸ å•ä¾‹å®¹å™¨æ¨¡å¼**ï¼ˆæ¨èï¼‰

```java
// æŠ½å–ä¸ºåŸºç±»ï¼Œå¤šä¸ªæµ‹è¯•ç±»å…±äº«
@Testcontainers
abstract class BaseIntegrationTest {
    
    @Container
    static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0")
            .withDatabaseName("testdb")
            .withReuse(true);  // å®¹å™¨å¯é‡ç”¨
    
    @DynamicPropertySource
    static void properties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", mysql::getJdbcUrl);
        registry.add("spring.datasource.username", mysql::getUsername);
        registry.add("spring.datasource.password", mysql::getPassword);
    }
}

// å…¶ä»–æµ‹è¯•ç±»ç»§æ‰¿
class UserServiceTest extends BaseIntegrationTest {
    // å…±äº«åŒä¸€ä¸ªå®¹å™¨
}

class OrderServiceTest extends BaseIntegrationTest {
    // å…±äº«åŒä¸€ä¸ªå®¹å™¨
}
```

**ä¼˜ç‚¹**ï¼š
- âš¡ å®¹å™¨åªå¯åŠ¨ä¸€æ¬¡ï¼ŒèŠ‚çœæ—¶é—´
- ğŸ’¾ èŠ‚çœç³»ç»Ÿèµ„æº
- ğŸ”„ é…ç½®ç»Ÿä¸€ç®¡ç†

### 4.3 ç«¯å£å†²çªå¤„ç†


**é—®é¢˜åœºæ™¯**ï¼šå¤šä¸ªæµ‹è¯•åŒæ—¶è¿è¡Œï¼Œç«¯å£å†²çªæ€ä¹ˆåŠï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šTestcontainersè‡ªåŠ¨æ˜ å°„éšæœºç«¯å£

```java
@Container
static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0");

@Test
void æŸ¥çœ‹ç«¯å£() {
    // Testcontainersè‡ªåŠ¨åˆ†é…éšæœºç«¯å£
    Integer port = mysql.getMappedPort(3306);
    System.out.println("MySQLæ˜ å°„åˆ°ç«¯å£ï¼š" + port);
    // è¾“å‡ºå¯èƒ½æ˜¯ï¼šMySQLæ˜ å°„åˆ°ç«¯å£ï¼š32768
}
```

**å®¹å™¨ä¹‹é—´çš„ç½‘ç»œéš”ç¦»**ï¼š

```
æµ‹è¯•1çš„å®¹å™¨ï¼š
   MySQL â†’ ç«¯å£32768
   Redis â†’ ç«¯å£32769

æµ‹è¯•2çš„å®¹å™¨ï¼š
   MySQL â†’ ç«¯å£32770
   Redis â†’ ç«¯å£32771

å®Œå…¨ä¸å†²çªï¼
```

---

## 5. ğŸš€ CI/CDé›†æˆæœ€ä½³å®è·µ


### 5.1 GitHub Actionsé…ç½®


**ğŸ”¸ å®Œæ•´workflowç¤ºä¾‹**

```yaml
name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  integration-test:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - uses: actions/checkout@v3
      
      # 2. å®‰è£…JDK
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      # 3. å¯åŠ¨Dockerï¼ˆGitHub Actionså·²å†…ç½®ï¼‰
      - name: Start Docker
        run: docker --version
      
      # 4. è¿è¡Œé›†æˆæµ‹è¯•
      - name: Run Integration Tests
        run: mvn verify -Pintegration-test
      
      # 5. ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-report
          path: target/surefire-reports/
```

**ä¸ºä»€ä¹ˆCI/CDä¹Ÿèƒ½ç”¨**ï¼š
- âœ… GitHub Actionsç¯å¢ƒè‡ªå¸¦Docker
- âœ… Testcontainersè‡ªåŠ¨ä¸‹è½½é•œåƒ
- âœ… æµ‹è¯•å®Œè‡ªåŠ¨æ¸…ç†ï¼Œä¸å ç©ºé—´

### 5.2 GitLab CIé…ç½®


```yaml
integration-test:
  image: maven:3.8-openjdk-17
  
  services:
    - docker:dind  # Docker in Docker
  
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  
  script:
    - mvn verify -Pintegration-test
  
  artifacts:
    when: always
    reports:
      junit: target/surefire-reports/TEST-*.xml
```

### 5.3 ä¼˜åŒ–CI/CDæ‰§è¡Œé€Ÿåº¦


**ğŸ”¸ ç¼“å­˜Dockeré•œåƒ**

```yaml
# GitHub Actionsç¼“å­˜ç¤ºä¾‹
- name: Cache Docker images
  uses: actions/cache@v3
  with:
    path: /var/lib/docker
    key: docker-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
```

**ğŸ”¸ å¹¶è¡Œæ‰§è¡Œæµ‹è¯•**

```xml
<!-- Mavené…ç½®å¹¶è¡Œæµ‹è¯• -->
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-surefire-plugin</artifactId>
    <configuration>
        <parallel>classes</parallel>
        <threadCount>4</threadCount>
    </configuration>
</plugin>
```

**ğŸ”¸ ä»…åœ¨å¿…è¦æ—¶è¿è¡Œé›†æˆæµ‹è¯•**

```yaml
# åªåœ¨åˆå¹¶åˆ°ä¸»åˆ†æ”¯æ—¶è¿è¡Œ
on:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize ]
```

---

## 6. âš¡ æ€§èƒ½æµ‹è¯•è€ƒè™‘è¦ç‚¹


### 6.1 é›†æˆæµ‹è¯•æ€§èƒ½å¯¹æ¯”


**ğŸ”¸ é€Ÿåº¦å¯¹æ¯”è¡¨**

| æµ‹è¯•æ–¹å¼ | **å¯åŠ¨æ—¶é—´** | **æ‰§è¡Œé€Ÿåº¦** | **å¯é æ€§** |
|---------|------------|------------|-----------|
| **Mockæµ‹è¯•** | `<1ç§’` | `æå¿«` | `ä½` |
| **H2å†…å­˜åº“** | `~2ç§’` | `å¾ˆå¿«` | `ä¸­` |
| **Testcontainers** | `~10ç§’` | `ä¸­ç­‰` | `é«˜` |
| **çœŸå®æ•°æ®åº“** | `éœ€æ‰‹åŠ¨` | `æ…¢` | `æœ€é«˜` |

### 6.2 æ€§èƒ½ä¼˜åŒ–æŠ€å·§


**ğŸ”¸ æŠ€å·§1ï¼šå®¹å™¨é‡ç”¨**

```java
@Container
static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0")
        .withReuse(true);  // å¼€å¯é‡ç”¨

// é…ç½®æ–‡ä»¶ï¼štestcontainers.properties
testcontainers.reuse.enable=true
```

**æ•ˆæœ**ï¼š
- ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼š~10ç§’
- åç»­å¯åŠ¨ï¼š~1ç§’ï¼ˆç›´æ¥è¿æ¥å·²æœ‰å®¹å™¨ï¼‰

**ğŸ”¸ æŠ€å·§2ï¼šä½¿ç”¨è½»é‡çº§é•œåƒ**

```java
// âŒ æ…¢ï¼šå®Œæ•´MySQLé•œåƒ
static MySQLContainer<?> mysql = 
    new MySQLContainer<>("mysql:8.0");  // 500MB+

// âœ… å¿«ï¼šAlpineè½»é‡çº§é•œåƒ
static MySQLContainer<?> mysql = 
    new MySQLContainer<>("mysql:8.0-alpine");  // 200MB
```

**ğŸ”¸ æŠ€å·§3ï¼šé¢„çƒ­å®¹å™¨**

```java
@BeforeAll
static void warmUp() {
    // é¢„å…ˆå¯åŠ¨å®¹å™¨ï¼Œä¸è®¡å…¥æµ‹è¯•æ—¶é—´
    mysql.start();
    // æ‰§è¡Œä¸€äº›é¢„çƒ­æŸ¥è¯¢
    jdbcTemplate.execute("SELECT 1");
}
```

### 6.3 ä½•æ—¶ä½¿ç”¨é›†æˆæµ‹è¯•


**ğŸ”¸ å†³ç­–æ ‘**

```
æ˜¯å¦æ¶‰åŠæ•°æ®åº“æ“ä½œï¼Ÿ
   â”œâ”€ å¦ â†’ ç”¨å•å…ƒæµ‹è¯•ï¼ˆMockï¼‰
   â””â”€ æ˜¯ â†’ ç»§ç»­åˆ¤æ–­
           â”‚
           æ˜¯å¦æµ‹è¯•SQLé€»è¾‘ï¼Ÿ
           â”œâ”€ å¦ â†’ ç”¨å•å…ƒæµ‹è¯•
           â””â”€ æ˜¯ â†’ ç»§ç»­åˆ¤æ–­
                   â”‚
                   æ˜¯å¦éœ€è¦çœŸå®ç¯å¢ƒï¼Ÿ
                   â”œâ”€ å¦ â†’ ç”¨H2å†…å­˜æ•°æ®åº“
                   â””â”€ æ˜¯ â†’ ç”¨Testcontainers
```

**ğŸ’¡ å®è·µå»ºè®®**

```
æµ‹è¯•é‡‘å­—å¡”ï¼š
        
        /\      10%  é›†æˆæµ‹è¯•
       /  \     
      /----\    30%  æ¥å£æµ‹è¯•
     /      \   
    /--------\  60%  å•å…ƒæµ‹è¯•
   
åŸåˆ™ï¼š
- å¤§é‡å•å…ƒæµ‹è¯•ä¿è¯åŸºç¡€é€»è¾‘
- é€‚é‡é›†æˆæµ‹è¯•ä¿è¯åä½œæ­£ç¡®
- å°‘é‡ç«¯åˆ°ç«¯æµ‹è¯•ä¿è¯æ•´ä½“æµç¨‹
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é›†æˆæµ‹è¯•ï¼šæµ‹è¯•å¤šç»„ä»¶åä½œï¼Œä½¿ç”¨çœŸå®ç¯å¢ƒ
ğŸ”¸ Testcontainersï¼šDockerå®¹å™¨åŒ–æµ‹è¯•ï¼Œè‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
ğŸ”¸ æ•°æ®éš”ç¦»ï¼š@Transactionalå›æ»šæˆ–å®¹å™¨é‡å¯
ğŸ”¸ CI/CDé›†æˆï¼šè‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œç¯å¢ƒä¸€è‡´æ€§ä¿è¯
ğŸ”¸ æ€§èƒ½æƒè¡¡ï¼šæµ‹è¯•è¦†ç›–ç‡ vs æ‰§è¡Œé€Ÿåº¦çš„å¹³è¡¡
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆç”¨Testcontainers**

```
ä¼ ç»Ÿå›°å¢ƒï¼š
- ç¯å¢ƒä¸ä¸€è‡´ï¼š"æˆ‘è¿™èƒ½è·‘"é—®é¢˜
- æ•°æ®æ±¡æŸ“ï¼šæµ‹è¯•äº’ç›¸å½±å“
- ç»´æŠ¤æˆæœ¬ï¼šæ‰‹åŠ¨ç®¡ç†æ•°æ®åº“

Testcontainersè§£å†³ï¼š
- è‡ªåŠ¨åŒ–ï¼šå¯åŠ¨å³ç”¨ï¼Œç”¨å®Œå³é”€
- å¯é‡å¤ï¼šæ¯æ¬¡éƒ½æ˜¯å¹²å‡€ç¯å¢ƒ
- çœŸå®æ€§ï¼š100%è¿˜åŸç”Ÿäº§ç¯å¢ƒ
```

**ğŸ”¹ æµ‹è¯•ç­–ç•¥é€‰æ‹©**

```
å•å…ƒæµ‹è¯•ï¼š
âœ“ å¿«é€Ÿåé¦ˆ
âœ“ æµ‹è¯•ä¸šåŠ¡é€»è¾‘
âœ— æ— æ³•å‘ç°é›†æˆé—®é¢˜

é›†æˆæµ‹è¯•ï¼š
âœ“ å‘ç°çœŸå®é—®é¢˜
âœ“ ä¿è¯ç³»ç»Ÿåä½œ
âœ— æ‰§è¡Œè¾ƒæ…¢

ç»„åˆä½¿ç”¨ï¼š
- 70%å•å…ƒæµ‹è¯•ï¼šä¿è¯ä»£ç è´¨é‡
- 30%é›†æˆæµ‹è¯•ï¼šä¿è¯ç³»ç»Ÿå¯é 
```

### 7.3 å®è·µç»éªŒæ€»ç»“


**âœ… æ¨èåšæ³•**

```
1. ç”¨staticå®¹å™¨å…±äº«ï¼ŒèŠ‚çœæ—¶é—´
2. @Transactionalè‡ªåŠ¨å›æ»šï¼Œä¿è¯éš”ç¦»
3. æŠ½å–åŸºç±»ï¼Œé…ç½®ç»Ÿä¸€ç®¡ç†
4. CI/CDé›†æˆï¼Œè‡ªåŠ¨åŒ–æµ‹è¯•
5. å®¹å™¨é‡ç”¨ï¼Œä¼˜åŒ–æ€§èƒ½
```

**âŒ é¿å…é™·é˜±**

```
1. ä¸è¦æ¯ä¸ªæµ‹è¯•éƒ½å¯åŠ¨æ–°å®¹å™¨
2. ä¸è¦å¿˜è®°@DynamicPropertySourceé…ç½®
3. ä¸è¦åœ¨ç”Ÿäº§é…ç½®ä¸­ç”¨æµ‹è¯•å®¹å™¨
4. ä¸è¦è¿‡åº¦ä¾èµ–é›†æˆæµ‹è¯•
5. ä¸è¦å¿½ç•¥æµ‹è¯•æ‰§è¡Œæ—¶é—´
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- é›†æˆæµ‹è¯•ç”¨çœŸç¯å¢ƒï¼ŒTestcontainersè‡ªåŠ¨ç®¡
- å®¹å™¨å¯åŠ¨é”€æ¯å¿«ï¼Œæ•°æ®éš”ç¦»ä¸æ±¡æŸ“
- CI/CDå®Œç¾é…åˆï¼Œæµ‹è¯•ç¨³å®šåˆå¯é 
- å•å…ƒé›†æˆç›¸ç»“åˆï¼Œè´¨é‡é€Ÿåº¦ä¸¤ä¸è¯¯