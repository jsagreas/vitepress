---
title: 58ã€æ…¢æŸ¥è¯¢åˆ†æä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯æ…¢æŸ¥è¯¢](#1-ä»€ä¹ˆæ˜¯æ…¢æŸ¥è¯¢)
2. [æ…¢SQLè¯†åˆ«æ–¹æ³•](#2-æ…¢SQLè¯†åˆ«æ–¹æ³•)
3. [æ‰§è¡Œè®¡åˆ’åˆ†æ](#3-æ‰§è¡Œè®¡åˆ’åˆ†æ)
4. [ç´¢å¼•ä¼˜åŒ–ç­–ç•¥](#4-ç´¢å¼•ä¼˜åŒ–ç­–ç•¥)
5. [æŸ¥è¯¢é‡å†™æŠ€å·§](#5-æŸ¥è¯¢é‡å†™æŠ€å·§)
6. [åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–](#6-åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–)
7. [æ‰¹é‡æ“ä½œä¼˜åŒ–](#7-æ‰¹é‡æ“ä½œä¼˜åŒ–)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ ä»€ä¹ˆæ˜¯æ…¢æŸ¥è¯¢


### 1.1 é€šä¿—ç†è§£æ…¢æŸ¥è¯¢


**ç”Ÿæ´»ä¸­çš„ä¾‹å­**ï¼š
```
æƒ³è±¡ä½ å»å›¾ä¹¦é¦†æ‰¾ä¹¦ï¼š
å¿«é€ŸæŸ¥è¯¢ â†’ ç›´æ¥æŸ¥ç›®å½•å¡ç‰‡ï¼Œ3ç§’æ‰¾åˆ°
æ…¢é€ŸæŸ¥è¯¢ â†’ ä¸€æ’æ’ä¹¦æ¶æ…¢æ…¢æ‰¾ï¼ŒèŠ±äº†30åˆ†é’Ÿ

æ•°æ®åº“æ…¢æŸ¥è¯¢å°±åƒåè€…ï¼Œæ‰§è¡Œæ—¶é—´ç‰¹åˆ«é•¿çš„SQLè¯­å¥
```

> ğŸ’¡ **æ ¸å¿ƒæ¦‚å¿µ**ï¼šæ…¢æŸ¥è¯¢ï¼ˆSlow Queryï¼‰æ˜¯æŒ‡æ‰§è¡Œæ—¶é—´è¶…è¿‡è®¾å®šé˜ˆå€¼çš„SQLè¯­å¥ã€‚å°±åƒå¿«é€’è¶…è¿‡3å¤©æ²¡é€åˆ°ï¼Œæˆ‘ä»¬ä¼šè®¤ä¸ºæ˜¯"æ…¢é€’"ä¸€æ ·ã€‚

### 1.2 æ…¢æŸ¥è¯¢çš„å±å®³


**å¯¹ç³»ç»Ÿçš„å½±å“**ï¼š
- âš ï¸ **ç”¨æˆ·ä½“éªŒå·®**ï¼šé¡µé¢åŠ è½½æ…¢ï¼Œç”¨æˆ·ç­‰å¾…æ—¶é—´é•¿
- âš ï¸ **æ•°æ®åº“å‹åŠ›å¤§**ï¼šå ç”¨è¿æ¥èµ„æºï¼Œå½±å“å…¶ä»–è¯·æ±‚
- âš ï¸ **æœåŠ¡å™¨è´Ÿè½½é«˜**ï¼šCPUã€å†…å­˜ã€ç£ç›˜IOéƒ½è¢«å ç”¨
- âš ï¸ **å¯èƒ½å¯¼è‡´é›ªå´©**ï¼šæ…¢æŸ¥è¯¢å †ç§¯ï¼Œæ•´ä¸ªç³»ç»Ÿå´©æºƒ

```
æ­£å¸¸æƒ…å†µï¼š              æ…¢æŸ¥è¯¢æƒ…å†µï¼š
ç”¨æˆ· â†’ [0.1s] â†’ ç»“æœ    ç”¨æˆ· â†’ [5s] â†’ ç»“æœ
                       â†“
                    å…¶ä»–ç”¨æˆ·ä¹Ÿå—å½±å“
```

### 1.3 æ…¢æŸ¥è¯¢çš„å¸¸è§åŸå› 


| åŸå› ç±»å‹ | å…·ä½“è¡¨ç° | ç±»æ¯”è¯´æ˜ |
|---------|---------|---------|
| ğŸ” **æ²¡æœ‰ç´¢å¼•** | å…¨è¡¨æ‰«æ | æ²¡æœ‰ç›®å½•ï¼Œä¸€é¡µé¡µç¿»ä¹¦æ‰¾å†…å®¹ |
| ğŸ“Š **ç´¢å¼•å¤±æ•ˆ** | ç´¢å¼•æ²¡ç”¨ä¸Š | æœ‰ç›®å½•ä½†æŸ¥çš„æ–¹å¼ä¸å¯¹ |
| ğŸ’¾ **æ•°æ®é‡å¤§** | è¡¨æ•°æ®å¤ªå¤š | å›¾ä¹¦é¦†ä¹¦å¤ªå¤šæ‰¾ä¸åˆ° |
| ğŸ”„ **å¤æ‚æŸ¥è¯¢** | JOINå¤ªå¤š | è¦ä»å¤šä¸ªä¹¦æ¶æ‹¿ä¹¦æ‹¼å‡‘ç­”æ¡ˆ |
| âš™ï¸ **é”ç­‰å¾…** | ç­‰å…¶ä»–äº‹åŠ¡é‡Šæ”¾é” | åˆ«äººåœ¨çœ‹ä¹¦ï¼Œä½ åªèƒ½ç­‰ |

---

## 2. ğŸ” æ…¢SQLè¯†åˆ«æ–¹æ³•


### 2.1 MySQLæ…¢æŸ¥è¯¢æ—¥å¿—


**ä»€ä¹ˆæ˜¯æ…¢æŸ¥è¯¢æ—¥å¿—**ï¼š
> å°±åƒç»™æ•°æ®åº“è£…äº†ä¸ª"è¡Œè½¦è®°å½•ä»ª"ï¼Œä¼šè‡ªåŠ¨è®°å½•æ‰€æœ‰"å¼€å¾—æ…¢"çš„SQLè¯­å¥ã€‚

**å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—**ï¼š

```sql
-- æŸ¥çœ‹æ˜¯å¦å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SHOW VARIABLES LIKE 'slow_query%';

-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';

-- è®¾ç½®æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆè¶…è¿‡2ç§’è®°å½•ï¼‰
SET GLOBAL long_query_time = 2;

-- è®¾ç½®æ—¥å¿—æ–‡ä»¶ä½ç½®
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow.log';
```

**é…ç½®æ–‡ä»¶æ–¹å¼ï¼ˆæ°¸ä¹…ç”Ÿæ•ˆï¼‰**ï¼š

```ini
# my.cnf æˆ– my.ini
[mysqld]
slow_query_log = 1                    # å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2                   # è¶…è¿‡2ç§’è®°å½•
log_queries_not_using_indexes = 1     # è®°å½•æœªä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢
```

### 2.2 MyBatis-Plusæ€§èƒ½åˆ†ææ’ä»¶


**é…ç½®æ€§èƒ½åˆ†ææ‹¦æˆªå™¨**ï¼š

```java
@Configuration
public class MybatisPlusConfig {
    
    /**
     * æ€§èƒ½åˆ†ææ‹¦æˆªå™¨
     * ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºæ¯æ¡SQLçš„æ‰§è¡Œæ—¶é—´
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        
        // æ·»åŠ æ€§èƒ½åˆ†ææ’ä»¶ï¼ˆå¼€å‘ç¯å¢ƒä½¿ç”¨ï¼‰
        interceptor.addInnerInterceptor(new PerformanceInterceptor());
        
        return interceptor;
    }
}
```

**è‡ªå®šä¹‰æ€§èƒ½ç›‘æ§**ï¼š

```java
/**
 * è‡ªå®šä¹‰æ…¢SQLæ‹¦æˆªå™¨
 * å½“æ‰§è¡Œæ—¶é—´è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œè‡ªåŠ¨è®°å½•æ—¥å¿—æˆ–å‘é€å‘Šè­¦
 */
@Component
@Intercepts({
    @Signature(type = Executor.class, method = "query", 
               args = {MappedStatement.class, Object.class, 
                       RowBounds.class, ResultHandler.class})
})
public class SlowSqlInterceptor implements Interceptor {
    
    private static final long SLOW_SQL_THRESHOLD = 2000; // 2ç§’é˜ˆå€¼
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        long startTime = System.currentTimeMillis();
        
        // æ‰§è¡ŒSQL
        Object result = invocation.proceed();
        
        long endTime = System.currentTimeMillis();
        long costTime = endTime - startTime;
        
        // è¶…è¿‡é˜ˆå€¼è®°å½•æ…¢SQL
        if (costTime > SLOW_SQL_THRESHOLD) {
            MappedStatement ms = (MappedStatement) invocation.getArgs()[0];
            String sql = ms.getSqlSource().getBoundSql(
                invocation.getArgs()[1]).getSql();
            
            log.warn("âš ï¸ æ…¢SQLå‘Šè­¦: æ‰§è¡Œæ—¶é—´{}ms, SQL: {}", costTime, sql);
            
            // å¯ä»¥å‘é€é’‰é’‰ã€é‚®ä»¶å‘Šè­¦
            // alertService.sendSlowSqlAlert(sql, costTime);
        }
        
        return result;
    }
}
```

### 2.3 åº”ç”¨å±‚ç›‘æ§æ–¹æ¡ˆ


**ä½¿ç”¨AOPè®°å½•æ…¢æŸ¥è¯¢**ï¼š

```java
@Aspect
@Component
public class SqlPerformanceMonitor {
    
    /**
     * ç›‘æ§æ‰€æœ‰Mapperæ–¹æ³•çš„æ‰§è¡Œæ—¶é—´
     */
    @Around("execution(* com.example.mapper..*.*(..))")
    public Object monitorSql(ProceedingJoinPoint pjp) throws Throwable {
        long start = System.currentTimeMillis();
        
        Object result = pjp.proceed();
        
        long cost = System.currentTimeMillis() - start;
        
        // è®°å½•æ‰§è¡Œæ—¶é—´
        String methodName = pjp.getSignature().getName();
        
        if (cost > 1000) { // è¶…è¿‡1ç§’
            log.warn("â° æ…¢æŸ¥è¯¢: {}.{} è€—æ—¶: {}ms", 
                pjp.getTarget().getClass().getSimpleName(),
                methodName, 
                cost);
        }
        
        return result;
    }
}
```

---

## 3. ğŸ“Š æ‰§è¡Œè®¡åˆ’åˆ†æ


### 3.1 ä»€ä¹ˆæ˜¯æ‰§è¡Œè®¡åˆ’


> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šæ‰§è¡Œè®¡åˆ’å°±æ˜¯MySQLå‘Šè¯‰ä½ "æˆ‘æ‰“ç®—æ€ä¹ˆæ‰§è¡Œè¿™æ¡SQL"ï¼Œå°±åƒå¯¼èˆªå‘Šè¯‰ä½ "æˆ‘æ‰“ç®—èµ°å“ªæ¡è·¯"ã€‚

**æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’**ï¼š

```sql
-- ä½¿ç”¨EXPLAINæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM user WHERE age > 20;

-- ç»“æœç¤ºä¾‹ï¼š
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
| id | select_type | table | type | possible_keys | key  | key_len | ref  | rows | Extra       |
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
|  1 | SIMPLE      | user  | ALL  | NULL          | NULL | NULL    | NULL | 1000 | Using where |
+----+-------------+-------+------+---------------+------+---------+------+------+-------------+
```

### 3.2 æ‰§è¡Œè®¡åˆ’å…³é”®å­—æ®µè§£è¯»


**typeå­—æ®µï¼ˆè®¿é—®ç±»å‹ï¼‰- æœ€é‡è¦ï¼**

```
æ€§èƒ½ä»å¥½åˆ°å·®ï¼š
system > const > eq_ref > ref > range > index > ALL

âœ… constï¼š     ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•æŸ¥è¯¢ï¼Œæœ€å¿«
   ä¾‹ï¼šWHERE id = 1

âœ… refï¼š       æ™®é€šç´¢å¼•æŸ¥è¯¢
   ä¾‹ï¼šWHERE name = 'å¼ ä¸‰'

âš ï¸ rangeï¼š    èŒƒå›´æŸ¥è¯¢
   ä¾‹ï¼šWHERE age > 20

âŒ indexï¼š    ç´¢å¼•å…¨æ‰«æ
   ä¾‹ï¼šSELECT id FROM user

âŒ ALLï¼š      å…¨è¡¨æ‰«æï¼Œæœ€æ…¢
   ä¾‹ï¼šSELECT * FROM user WHERE hobby = 'ç¯®çƒ'
```

**keyå­—æ®µï¼ˆå®é™…ä½¿ç”¨çš„ç´¢å¼•ï¼‰**ï¼š

```sql
-- ç¤ºä¾‹ï¼šæ£€æŸ¥æ˜¯å¦ç”¨ä¸Šç´¢å¼•
EXPLAIN SELECT * FROM user WHERE name = 'å¼ ä¸‰';

-- å¦‚æœkey=NULLï¼Œè¯´æ˜æ²¡ç”¨ç´¢å¼•
-- å¦‚æœkey=idx_nameï¼Œè¯´æ˜ç”¨äº†idx_nameç´¢å¼•
```

**rowså­—æ®µï¼ˆæ‰«æè¡Œæ•°ï¼‰**ï¼š

> ğŸ“ **ç†è§£è¦ç‚¹**ï¼šrowsè¶Šå°è¶Šå¥½ï¼Œè¡¨ç¤ºéœ€è¦æ‰«æçš„æ•°æ®é‡è¶Šå°‘

```
rows = 1      â†’ éå¸¸å¥½ï¼Œç²¾ç¡®å®šä½
rows = 100    â†’ è¾ƒå¥½ï¼Œå°èŒƒå›´æ‰«æ
rows = 10000  â†’ éœ€è¦ä¼˜åŒ–
rows = 100ä¸‡  â†’ å¿…é¡»ä¼˜åŒ–ï¼
```

**Extraå­—æ®µï¼ˆé¢å¤–ä¿¡æ¯ï¼‰**ï¼š

| Extraå€¼ | å«ä¹‰ | æ€§èƒ½ |
|---------|------|------|
| `Using index` | è¦†ç›–ç´¢å¼•ï¼Œä¸éœ€è¦å›è¡¨ | âœ… å¾ˆå¥½ |
| `Using where` | ä½¿ç”¨äº†WHEREè¿‡æ»¤ | âš ï¸ ä¸€èˆ¬ |
| `Using filesort` | éœ€è¦é¢å¤–æ’åº | âŒ æ…¢ |
| `Using temporary` | éœ€è¦ä¸´æ—¶è¡¨ | âŒ å¾ˆæ…¢ |

### 3.3 å®æˆ˜æ¡ˆä¾‹ï¼šæ‰§è¡Œè®¡åˆ’ä¼˜åŒ–


**æ¡ˆä¾‹1ï¼šæœªä½¿ç”¨ç´¢å¼•**

```sql
-- âŒ æ…¢æŸ¥è¯¢ï¼šå…¨è¡¨æ‰«æ
EXPLAIN SELECT * FROM user WHERE age > 20;
-- type=ALL, rows=100ä¸‡

-- âœ… ä¼˜åŒ–ï¼šåˆ›å»ºç´¢å¼•
CREATE INDEX idx_age ON user(age);

-- ä¼˜åŒ–åï¼š
EXPLAIN SELECT * FROM user WHERE age > 20;
-- type=range, rows=1000ï¼ˆå¤§å¹…å‡å°‘ï¼‰
```

**æ¡ˆä¾‹2ï¼šç´¢å¼•å¤±æ•ˆé—®é¢˜**

```sql
-- âŒ ç´¢å¼•å¤±æ•ˆï¼šä½¿ç”¨å‡½æ•°
EXPLAIN SELECT * FROM user WHERE YEAR(birthday) = 2000;
-- type=ALLï¼ˆç´¢å¼•å¤±æ•ˆï¼‰

-- âœ… ä¼˜åŒ–ï¼šæ”¹å†™æŸ¥è¯¢æ¡ä»¶
EXPLAIN SELECT * FROM user 
WHERE birthday >= '2000-01-01' 
  AND birthday < '2001-01-01';
-- type=rangeï¼ˆç´¢å¼•ç”Ÿæ•ˆï¼‰
```

---

## 4. ğŸ¯ ç´¢å¼•ä¼˜åŒ–ç­–ç•¥


### 4.1 ç´¢å¼•åŸºç¡€çŸ¥è¯†


**ä»€ä¹ˆæ˜¯ç´¢å¼•**ï¼š
> ğŸ“š **ç±»æ¯”ç†è§£**ï¼šç´¢å¼•å°±åƒä¹¦çš„ç›®å½•ï¼Œé€šè¿‡ç›®å½•èƒ½å¿«é€Ÿæ‰¾åˆ°å†…å®¹æ‰€åœ¨é¡µç ï¼Œä¸ç”¨ä¸€é¡µé¡µç¿»

```
æ²¡æœ‰ç´¢å¼•ï¼š          æœ‰ç´¢å¼•ï¼š
ä¸€é¡µé¡µç¿» â†’ æ…¢       æŸ¥ç›®å½• â†’ å®šä½é¡µç  â†’ å¿«
```

### 4.2 ä½•æ—¶åˆ›å»ºç´¢å¼•


**âœ… åº”è¯¥åˆ›å»ºç´¢å¼•çš„åœºæ™¯**ï¼š
- WHEREæ¡ä»¶å­—æ®µ
- JOINå…³è”å­—æ®µ
- ORDER BYæ’åºå­—æ®µ
- ç»å¸¸æŸ¥è¯¢çš„å­—æ®µ

**âŒ ä¸é€‚åˆåˆ›å»ºç´¢å¼•çš„åœºæ™¯**ï¼š
- æ•°æ®é‡å¾ˆå°çš„è¡¨ï¼ˆå‡ ç™¾æ¡ï¼‰
- é¢‘ç¹æ›´æ–°çš„å­—æ®µ
- åŒºåˆ†åº¦ä½çš„å­—æ®µï¼ˆå¦‚æ€§åˆ«ï¼‰

### 4.3 ç´¢å¼•ç±»å‹é€‰æ‹©


**å•åˆ—ç´¢å¼• vs è”åˆç´¢å¼•**ï¼š

```sql
-- å•åˆ—ç´¢å¼•
CREATE INDEX idx_name ON user(name);
CREATE INDEX idx_age ON user(age);

-- è”åˆç´¢å¼•ï¼ˆæ›´æ¨èï¼‰
CREATE INDEX idx_name_age ON user(name, age);
```

> ğŸ’¡ **æœ€å·¦å‰ç¼€åŸåˆ™**ï¼šè”åˆç´¢å¼•(name, age)å¯ä»¥ç”¨äºï¼š
> - âœ… WHERE name = 'å¼ ä¸‰'
> - âœ… WHERE name = 'å¼ ä¸‰' AND age = 20
> - âŒ WHERE age = 20ï¼ˆä¸èµ°ç´¢å¼•ï¼‰

**å®æˆ˜ç¤ºä¾‹**ï¼š

```java
// MyBatis-Plusä¸­åˆ©ç”¨ç´¢å¼•æŸ¥è¯¢
@Service
public class UserService extends ServiceImpl<UserMapper, User> {
    
    /**
     * âœ… å¥½çš„æŸ¥è¯¢ï¼šç”¨ä¸Šè”åˆç´¢å¼•
     */
    public List<User> findByNameAndAge(String name, Integer age) {
        return lambdaQuery()
            .eq(User::getName, name)      // ç´¢å¼•ç¬¬ä¸€åˆ—
            .eq(User::getAge, age)        // ç´¢å¼•ç¬¬äºŒåˆ—
            .list();
    }
    
    /**
     * âŒ ä¸å¥½çš„æŸ¥è¯¢ï¼šç´¢å¼•å¤±æ•ˆ
     */
    public List<User> findByAge(Integer age) {
        return lambdaQuery()
            .eq(User::getAge, age)        // è·³è¿‡ç´¢å¼•ç¬¬ä¸€åˆ—
            .list();
    }
}
```

### 4.4 ç´¢å¼•å¤±æ•ˆçš„åœºæ™¯


**å¸¸è§ç´¢å¼•å¤±æ•ˆæƒ…å†µ**ï¼š

```sql
-- âŒ 1. ä½¿ç”¨å‡½æ•°æˆ–è®¡ç®—
SELECT * FROM user WHERE YEAR(create_time) = 2024;
-- âœ… æ”¹ä¸ºï¼š
SELECT * FROM user WHERE create_time >= '2024-01-01' 
  AND create_time < '2025-01-01';

-- âŒ 2. ä½¿ç”¨!=æˆ–<>
SELECT * FROM user WHERE status != 1;
-- âœ… æ”¹ä¸ºï¼š
SELECT * FROM user WHERE status IN (0, 2, 3);

-- âŒ 3. ä½¿ç”¨ORè¿æ¥ï¼ˆéƒ¨åˆ†å­—æ®µæ— ç´¢å¼•ï¼‰
SELECT * FROM user WHERE name = 'å¼ ä¸‰' OR hobby = 'ç¯®çƒ';
-- âœ… æ”¹ä¸ºï¼šä½¿ç”¨UNION
SELECT * FROM user WHERE name = 'å¼ ä¸‰'
UNION
SELECT * FROM user WHERE hobby = 'ç¯®çƒ';

-- âŒ 4. æ¨¡ç³ŠæŸ¥è¯¢å·¦æ¨¡ç³Š
SELECT * FROM user WHERE name LIKE '%å¼ %';
-- âœ… æ”¹ä¸ºï¼šå³æ¨¡ç³Š
SELECT * FROM user WHERE name LIKE 'å¼ %';
```

---

## 5. âœï¸ æŸ¥è¯¢é‡å†™æŠ€å·§


### 5.1 é¿å…SELECT *


**ä¸ºä»€ä¹ˆä¸ç”¨SELECT ***ï¼š
```
SELECT * çš„é—®é¢˜ï¼š
â‘  æŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼Œæ•°æ®ä¼ è¾“é‡å¤§
â‘¡ æ— æ³•ä½¿ç”¨è¦†ç›–ç´¢å¼•
â‘¢ å­—æ®µå˜æ›´å½±å“ç¨‹åº
```

**MyBatis-Plusä¼˜åŒ–å†™æ³•**ï¼š

```java
// âŒ ä¸å¥½çš„å†™æ³•
public List<User> findUsers() {
    return list(); // æŸ¥è¯¢æ‰€æœ‰å­—æ®µ
}

// âœ… å¥½çš„å†™æ³•ï¼šåªæŸ¥éœ€è¦çš„å­—æ®µ
public List<UserVO> findUserNames() {
    return lambdaQuery()
        .select(User::getId, User::getName, User::getAge)
        .list()
        .stream()
        .map(user -> {
            UserVO vo = new UserVO();
            vo.setId(user.getId());
            vo.setName(user.getName());
            vo.setAge(user.getAge());
            return vo;
        })
        .collect(Collectors.toList());
}
```

### 5.2 å­æŸ¥è¯¢ä¼˜åŒ–


**å­æŸ¥è¯¢ vs JOIN**ï¼š

```sql
-- âŒ æ…¢ï¼šå­æŸ¥è¯¢
SELECT * FROM user 
WHERE dept_id IN (
    SELECT id FROM dept WHERE name = 'æŠ€æœ¯éƒ¨'
);

-- âœ… å¿«ï¼šJOINæ”¹å†™
SELECT u.* FROM user u
INNER JOIN dept d ON u.dept_id = d.id
WHERE d.name = 'æŠ€æœ¯éƒ¨';
```

**MyBatis-Pluså®ç°**ï¼š

```java
// âŒ ä¸æ¨èï¼šä¸¤æ¬¡æŸ¥è¯¢
public List<User> findUsersByDeptName(String deptName) {
    // ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼šæŸ¥éƒ¨é—¨ID
    List<Integer> deptIds = deptService.lambdaQuery()
        .eq(Dept::getName, deptName)
        .list()
        .stream()
        .map(Dept::getId)
        .collect(Collectors.toList());
    
    // ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼šæŸ¥ç”¨æˆ·
    return lambdaQuery()
        .in(User::getDeptId, deptIds)
        .list();
}

// âœ… æ¨èï¼šè‡ªå®šä¹‰SQLï¼Œä¸€æ¬¡JOINæŸ¥è¯¢
@Mapper
public interface UserMapper extends BaseMapper<User> {
    
    @Select("SELECT u.* FROM user u " +
            "INNER JOIN dept d ON u.dept_id = d.id " +
            "WHERE d.name = #{deptName}")
    List<User> findUsersByDeptName(@Param("deptName") String deptName);
}
```

### 5.3 EXISTS vs IN


**é€‰æ‹©åŸåˆ™**ï¼š
```
å¤–è¡¨å°ï¼Œå†…è¡¨å¤§ â†’ ç”¨ IN
å¤–è¡¨å¤§ï¼Œå†…è¡¨å° â†’ ç”¨ EXISTS
```

```sql
-- åœºæ™¯ï¼šuserè¡¨100ä¸‡ï¼Œdeptè¡¨10æ¡
-- âœ… ç”¨INï¼ˆå†…è¡¨å°ï¼‰
SELECT * FROM user 
WHERE dept_id IN (SELECT id FROM dept WHERE status = 1);

-- åœºæ™¯ï¼šuserè¡¨100æ¡ï¼Œdeptè¡¨100ä¸‡
-- âœ… ç”¨EXISTSï¼ˆå¤–è¡¨å°ï¼‰
SELECT * FROM user u
WHERE EXISTS (
    SELECT 1 FROM dept d 
    WHERE d.id = u.dept_id AND d.status = 1
);
```

---

## 6. ğŸ“„ åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–


### 6.1 æ·±åˆ†é¡µé—®é¢˜


**ä»€ä¹ˆæ˜¯æ·±åˆ†é¡µ**ï¼š
```
æµ…åˆ†é¡µï¼šSELECT * FROM user LIMIT 0, 10     ï¼ˆç¬¬1é¡µï¼‰
æ·±åˆ†é¡µï¼šSELECT * FROM user LIMIT 100000, 10 ï¼ˆç¬¬10001é¡µï¼‰

æ·±åˆ†é¡µé—®é¢˜ï¼š
MySQLéœ€è¦æ‰«æ100010è¡Œæ•°æ®ï¼Œç„¶åä¸¢å¼ƒå‰100000è¡Œ
éå¸¸æµªè´¹æ€§èƒ½ï¼
```

### 6.2 MyBatis-Plusåˆ†é¡µæ’ä»¶


**é…ç½®åˆ†é¡µæ’ä»¶**ï¼š

```java
@Configuration
public class MybatisPlusConfig {
    
    @Bean
    public MybatisPlusInterceptor paginationInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        
        // æ·»åŠ åˆ†é¡µæ’ä»¶
        PaginationInnerInterceptor paginationInner = 
            new PaginationInnerInterceptor(DbType.MYSQL);
        
        // è®¾ç½®æœ€å¤§åˆ†é¡µæ•°ï¼ˆé˜²æ­¢æ¶æ„åˆ†é¡µï¼‰
        paginationInner.setMaxLimit(500L);
        
        interceptor.addInnerInterceptor(paginationInner);
        return interceptor;
    }
}
```

**åŸºæœ¬åˆ†é¡µæŸ¥è¯¢**ï¼š

```java
@Service
public class UserService extends ServiceImpl<UserMapper, User> {
    
    /**
     * åŸºæœ¬åˆ†é¡µæŸ¥è¯¢
     */
    public IPage<User> pageQuery(int pageNum, int pageSize) {
        Page<User> page = new Page<>(pageNum, pageSize);
        
        return lambdaQuery()
            .eq(User::getStatus, 1)
            .orderByDesc(User::getCreateTime)
            .page(page);
    }
}
```

### 6.3 æ·±åˆ†é¡µä¼˜åŒ–æ–¹æ¡ˆ


**æ–¹æ¡ˆ1ï¼šå­æŸ¥è¯¢ä¼˜åŒ–**

```java
/**
 * ä¼˜åŒ–æ·±åˆ†é¡µï¼šå…ˆæŸ¥IDï¼Œå†å…³è”æŸ¥è¯¢
 */
public IPage<User> pageQueryOptimized(int pageNum, int pageSize) {
    // 1. å…ˆæŸ¥è¯¢IDï¼ˆåªæŸ¥ç´¢å¼•ï¼Œå¿«ï¼‰
    Page<User> page = new Page<>(pageNum, pageSize);
    IPage<User> idPage = lambdaQuery()
        .select(User::getId)
        .orderByDesc(User::getId)
        .page(page);
    
    if (idPage.getRecords().isEmpty()) {
        return idPage;
    }
    
    // 2. æ ¹æ®IDæŸ¥å®Œæ•´æ•°æ®ï¼ˆèŒƒå›´å°ï¼‰
    List<Long> ids = idPage.getRecords()
        .stream()
        .map(User::getId)
        .collect(Collectors.toList());
    
    List<User> users = lambdaQuery()
        .in(User::getId, ids)
        .orderByDesc(User::getId)
        .list();
    
    // 3. ç»„è£…åˆ†é¡µç»“æœ
    Page<User> result = new Page<>(pageNum, pageSize, idPage.getTotal());
    result.setRecords(users);
    
    return result;
}
```

**æ–¹æ¡ˆ2ï¼šæ¸¸æ ‡åˆ†é¡µï¼ˆæ¨èï¼‰**

```java
/**
 * æ¸¸æ ‡åˆ†é¡µï¼šè®°ä½ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€åä¸€æ¡ID
 * é€‚åˆç§»åŠ¨ç«¯ä¸‹æ‹‰åˆ·æ–°åœºæ™¯
 */
public List<User> cursorPage(Long lastId, int pageSize) {
    return lambdaQuery()
        .gt(lastId != null, User::getId, lastId)  // IDå¤§äºä¸Šæ¬¡æœ€åID
        .orderByAsc(User::getId)
        .last("LIMIT " + pageSize)
        .list();
}

// å‰ç«¯ä½¿ç”¨ç¤ºä¾‹ï¼š
// ç¬¬ä¸€é¡µï¼šcursorPage(null, 10)  è¿”å›ID: 1-10
// ç¬¬äºŒé¡µï¼šcursorPage(10, 10)    è¿”å›ID: 11-20
// ç¬¬ä¸‰é¡µï¼šcursorPage(20, 10)    è¿”å›ID: 21-30
```

**æ–¹æ¡ˆ3ï¼šå»¶è¿Ÿå…³è”**

```sql
-- âŒ æ…¢ï¼šç›´æ¥æ·±åˆ†é¡µ
SELECT * FROM user ORDER BY id LIMIT 100000, 10;

-- âœ… å¿«ï¼šå…ˆæŸ¥IDï¼Œå†å…³è”
SELECT u.* FROM user u
INNER JOIN (
    SELECT id FROM user ORDER BY id LIMIT 100000, 10
) t ON u.id = t.id;
```

---

## 7. âš¡ æ‰¹é‡æ“ä½œä¼˜åŒ–


### 7.1 æ‰¹é‡æ’å…¥ä¼˜åŒ–


**æ™®é€šæ’å…¥ vs æ‰¹é‡æ’å…¥**ï¼š

```java
// âŒ æ…¢ï¼šå¾ªç¯æ’å…¥ï¼ˆ100æ¬¡æ•°æ®åº“äº¤äº’ï¼‰
public void insertUsers(List<User> users) {
    for (User user : users) {
        save(user);  // æ¯æ¬¡ä¸€æ¡SQL
    }
}
// è€—æ—¶ï¼šçº¦1000ms

// âœ… å¿«ï¼šæ‰¹é‡æ’å…¥ï¼ˆ1æ¬¡æ•°æ®åº“äº¤äº’ï¼‰
public void batchInsertUsers(List<User> users) {
    saveBatch(users);  // ä¸€æ¬¡æ€§æ’å…¥
}
// è€—æ—¶ï¼šçº¦100ms
```

**å¤§æ‰¹é‡æ’å…¥ä¼˜åŒ–**ï¼š

```java
@Service
public class UserService extends ServiceImpl<UserMapper, User> {
    
    /**
     * è¶…å¤§æ‰¹é‡æ’å…¥ï¼šåˆ†æ‰¹å¤„ç†
     */
    public void batchInsertOptimized(List<User> users) {
        // æ¯æ¬¡æ’å…¥1000æ¡
        int batchSize = 1000;
        
        for (int i = 0; i < users.size(); i += batchSize) {
            int end = Math.min(i + batchSize, users.size());
            List<User> batch = users.subList(i, end);
            
            saveBatch(batch);
            
            log.info("å·²æ’å…¥ï¼š{}/{}", end, users.size());
        }
    }
}
```

### 7.2 æ‰¹é‡æ›´æ–°ä¼˜åŒ–


```java
// âŒ æ…¢ï¼šå¾ªç¯æ›´æ–°
public void updateUsers(List<User> users) {
    for (User user : users) {
        updateById(user);
    }
}

// âœ… å¿«ï¼šæ‰¹é‡æ›´æ–°
public void batchUpdateUsers(List<User> users) {
    updateBatchById(users);
}

// âœ… æ›´å¿«ï¼šSQLæ‰¹é‡æ›´æ–°
public void batchUpdateBySql(List<Long> userIds) {
    lambdaUpdate()
        .set(User::getStatus, 1)
        .in(User::getId, userIds)
        .update();
}
```

### 7.3 æ‰¹é‡åˆ é™¤ä¼˜åŒ–


```java
// âŒ æ…¢ï¼šå¾ªç¯åˆ é™¤
public void deleteUsers(List<Long> ids) {
    for (Long id : ids) {
        removeById(id);
    }
}

// âœ… å¿«ï¼šæ‰¹é‡åˆ é™¤
public void batchDeleteUsers(List<Long> ids) {
    removeByIds(ids);
}

// âœ… å¸¦æ¡ä»¶æ‰¹é‡åˆ é™¤
public void batchDeleteByCondition(Integer status) {
    lambdaUpdate()
        .eq(User::getStatus, status)
        .remove();
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ…¢æŸ¥è¯¢ï¼šæ‰§è¡Œæ—¶é—´è¶…è¿‡é˜ˆå€¼çš„SQLï¼Œæ˜¯æ€§èƒ½æ€æ‰‹
ğŸ”¸ æ‰§è¡Œè®¡åˆ’ï¼šé€šè¿‡EXPLAINåˆ†æSQLæ‰§è¡Œæ–¹å¼
ğŸ”¸ ç´¢å¼•ä¼˜åŒ–ï¼šåˆç†åˆ›å»ºå’Œä½¿ç”¨ç´¢å¼•ï¼Œé¿å…ç´¢å¼•å¤±æ•ˆ
ğŸ”¸ æŸ¥è¯¢é‡å†™ï¼šé¿å…SELECT *ï¼Œå­æŸ¥è¯¢æ”¹JOIN
ğŸ”¸ åˆ†é¡µä¼˜åŒ–ï¼šæ·±åˆ†é¡µç”¨å­æŸ¥è¯¢æˆ–æ¸¸æ ‡æ–¹å¼
ğŸ”¸ æ‰¹é‡æ“ä½œï¼šç”¨æ‰¹é‡æ–¹æ³•æ›¿ä»£å¾ªç¯æ“ä½œ
```

### 8.2 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•


**â­ åŸºç¡€ä¼˜åŒ–ï¼ˆå¿…åšï¼‰**
- [ ] å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ç›‘æ§
- [ ] ä¸ºWHEREã€JOINå­—æ®µåˆ›å»ºç´¢å¼•
- [ ] é¿å…ä½¿ç”¨SELECT *
- [ ] ä½¿ç”¨æ‰¹é‡æ“ä½œä»£æ›¿å¾ªç¯

**â­â­ è¿›é˜¶ä¼˜åŒ–ï¼ˆæ¨èï¼‰**
- [ ] åˆ†ææ‰§è¡Œè®¡åˆ’ï¼Œç¡®ä¿typeä¸æ˜¯ALL
- [ ] æ£€æŸ¥ç´¢å¼•æ˜¯å¦å¤±æ•ˆ
- [ ] ä¼˜åŒ–æ·±åˆ†é¡µæŸ¥è¯¢
- [ ] å­æŸ¥è¯¢æ”¹ä¸ºJOIN

**â­â­â­ é«˜çº§ä¼˜åŒ–ï¼ˆæŒ‰éœ€ï¼‰**
- [ ] ä½¿ç”¨è¦†ç›–ç´¢å¼•å‡å°‘å›è¡¨
- [ ] åˆ†åº“åˆ†è¡¨å¤„ç†å¤§æ•°æ®é‡
- [ ] å¼•å…¥ç¼“å­˜å‡å°‘æ•°æ®åº“å‹åŠ›
- [ ] è¯»å†™åˆ†ç¦»åº”å¯¹é«˜å¹¶å‘

### 8.3 å®æˆ˜ç»éªŒæ€»ç»“


> ğŸ’¡ **æ€§èƒ½ä¼˜åŒ–åŸåˆ™**ï¼š
> - **å…ˆå®šä½é—®é¢˜**ï¼šç”¨æ…¢æŸ¥è¯¢æ—¥å¿—æ‰¾åˆ°æ…¢SQL
> - **å†åˆ†æåŸå› **ï¼šç”¨EXPLAINçœ‹æ‰§è¡Œè®¡åˆ’
> - **æœ€åä¼˜åŒ–**ï¼šåˆ›å»ºç´¢å¼•ã€é‡å†™SQLã€ä¼˜åŒ–é€»è¾‘
> - **æŒç»­ç›‘æ§**ï¼šä¼˜åŒ–åè¦éªŒè¯æ•ˆæœ

**å¸¸è§é—®é¢˜é€ŸæŸ¥è¡¨**ï¼š

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|---------|---------|
| æŸ¥è¯¢å¾ˆæ…¢ | æ²¡æœ‰ç´¢å¼• | åˆ›å»ºåˆé€‚ç´¢å¼• |
| ç´¢å¼•ä¸ç”Ÿæ•ˆ | ä½¿ç”¨äº†å‡½æ•° | æ”¹å†™æŸ¥è¯¢æ¡ä»¶ |
| æ·±åˆ†é¡µæ…¢ | æ‰«æè¡Œæ•°å¤š | ç”¨å­æŸ¥è¯¢æˆ–æ¸¸æ ‡ |
| æ‰¹é‡æ’å…¥æ…¢ | å¾ªç¯æ“ä½œ | æ”¹ç”¨saveBatch |

### 8.4 è®°å¿†å£è¯€


```
æ…¢æŸ¥è¯¢ä¼˜åŒ–è¦è®°ç‰¢ï¼Œ
ç´¢å¼•åˆ›å»ºå¾ˆé‡è¦ã€‚
æ‰§è¡Œè®¡åˆ’å…ˆåˆ†æï¼Œ
typeä¸ºALLè¦æ”¹æ‰ã€‚

æ·±åˆ†é¡µè¦ç”¨æŠ€å·§ï¼Œ
å­æŸ¥è¯¢æ¸¸æ ‡éƒ½å¾ˆå¥½ã€‚
æ‰¹é‡æ“ä½œåˆ«å¾ªç¯ï¼Œ
æ€§èƒ½æå‡ç«‹ç«¿è§å½±ã€‚
```