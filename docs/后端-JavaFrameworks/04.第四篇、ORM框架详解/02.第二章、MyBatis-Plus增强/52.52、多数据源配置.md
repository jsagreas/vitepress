---
title: 52ã€å¤šæ•°æ®æºé…ç½®
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯å¤šæ•°æ®æº](#1-ä»€ä¹ˆæ˜¯å¤šæ•°æ®æº)
2. [ä¸ºä»€ä¹ˆéœ€è¦å¤šæ•°æ®æº](#2-ä¸ºä»€ä¹ˆéœ€è¦å¤šæ•°æ®æº)
3. [åŠ¨æ€æ•°æ®æºé…ç½®](#3-åŠ¨æ€æ•°æ®æºé…ç½®)
4. [@DSæ³¨è§£ä½¿ç”¨è¯¦è§£](#4-dsæ³¨è§£ä½¿ç”¨è¯¦è§£)
5. [æ•°æ®æºåˆ‡æ¢æœºåˆ¶](#5-æ•°æ®æºåˆ‡æ¢æœºåˆ¶)
6. [ä¸»ä»åˆ†ç¦»é…ç½®](#6-ä¸»ä»åˆ†ç¦»é…ç½®)
7. [è¯»å†™åˆ†ç¦»ç­–ç•¥](#7-è¯»å†™åˆ†ç¦»ç­–ç•¥)
8. [æ•°æ®æºè·¯ç”±è§„åˆ™](#8-æ•°æ®æºè·¯ç”±è§„åˆ™)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯å¤šæ•°æ®æº


### 1.1 ç®€å•ç†è§£å¤šæ•°æ®æº


**ç”Ÿæ´»ä¸­çš„ä¾‹å­**ï¼š
```
å°±åƒä½ å®¶é‡Œæœ‰å¤šä¸ªå‚¨ç‰©æŸœï¼š
- å®¢å…æŸœå­ï¼šå­˜æ”¾æ—¥ç”¨å“
- ä¹¦æˆ¿æŸœå­ï¼šå­˜æ”¾ä¹¦ç±æ–‡ä»¶  
- å¨æˆ¿æŸœå­ï¼šå­˜æ”¾é¤å…·é£Ÿæ

æ¯ä¸ªæŸœå­éƒ½æœ‰ç‰¹å®šç”¨é€”ï¼Œä½ éœ€è¦ä»€ä¹ˆå°±å»å¯¹åº”çš„æŸœå­æ‰¾
```

**ç¨‹åºä¸­çš„å¤šæ•°æ®æº**ï¼š
```
åº”ç”¨ç¨‹åºè¿æ¥å¤šä¸ªæ•°æ®åº“ï¼š

ä½ çš„Spring Bootåº”ç”¨
    â”‚
    â”œâ”€â†’ æ•°æ®åº“Aï¼ˆç”¨æˆ·åº“ï¼‰    å­˜æ”¾ç”¨æˆ·ä¿¡æ¯
    â”œâ”€â†’ æ•°æ®åº“Bï¼ˆè®¢å•åº“ï¼‰    å­˜æ”¾è®¢å•æ•°æ®
    â””â”€â†’ æ•°æ®åº“Cï¼ˆæ—¥å¿—åº“ï¼‰    å­˜æ”¾ç³»ç»Ÿæ—¥å¿—

ä¸åŒçš„ä¸šåŠ¡æ“ä½œè®¿é—®ä¸åŒçš„æ•°æ®åº“
```

### 1.2 æ ¸å¿ƒæ¦‚å¿µè§£é‡Š


**æ•°æ®æºï¼ˆDataSourceï¼‰æ˜¯ä»€ä¹ˆ**ï¼š
- **é€šä¿—è¯´æ³•**ï¼šæ•°æ®æºå°±æ˜¯"æ•°æ®åº“è¿æ¥æ± "ï¼Œæ˜¯åº”ç”¨è¿æ¥æ•°æ®åº“çš„æ¡¥æ¢
- **å½¢è±¡æ¯”å–»**ï¼šå°±åƒæ°´é¾™å¤´ï¼Œä½ éœ€è¦æ°´ï¼ˆæ•°æ®ï¼‰æ—¶å°±æ‰“å¼€æ°´é¾™å¤´ï¼ˆæ•°æ®æºï¼‰
- **æŠ€æœ¯å«ä¹‰**ï¼šåŒ…å«æ•°æ®åº“åœ°å€ã€ç”¨æˆ·åã€å¯†ç ç­‰è¿æ¥ä¿¡æ¯çš„é…ç½®å¯¹è±¡

**å¤šæ•°æ®æºçš„æœ¬è´¨**ï¼š
```
å•æ•°æ®æºï¼š
åº”ç”¨ â†’ ä¸€ä¸ªDataSource â†’ ä¸€ä¸ªæ•°æ®åº“

å¤šæ•°æ®æºï¼š
åº”ç”¨ â†’ DataSource1 â†’ æ•°æ®åº“1
     â†’ DataSource2 â†’ æ•°æ®åº“2
     â†’ DataSource3 â†’ æ•°æ®åº“3
```

---

## 2. ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦å¤šæ•°æ®æº


### 2.1 å®é™…ä¸šåŠ¡åœºæ™¯


**åœºæ™¯1ï¼šä¸šåŠ¡æ‹†åˆ†** â­â­â­
```
ç”µå•†ç³»ç»Ÿæ‹†åˆ†æˆå¤šä¸ªå­ç³»ç»Ÿï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¢å•æœåŠ¡    â”‚ â†’ è®¢å•æ•°æ®åº“ï¼ˆå­˜è®¢å•ä¿¡æ¯ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·æœåŠ¡    â”‚ â†’ ç”¨æˆ·æ•°æ®åº“ï¼ˆå­˜ç”¨æˆ·ä¿¡æ¯ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å•†å“æœåŠ¡    â”‚ â†’ å•†å“æ•°æ®åº“ï¼ˆå­˜å•†å“ä¿¡æ¯ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¥½å¤„ï¼šæ¯ä¸ªä¸šåŠ¡ç‹¬ç«‹ï¼Œäº’ä¸å½±å“
```

**åœºæ™¯2ï¼šä¸»ä»æ¶æ„** â­â­â­
```
ä¸€ä¸ªä¸»åº“ + å¤šä¸ªä»åº“ï¼š

ä¸»åº“ï¼ˆMasterï¼‰
  â†“ æ•°æ®åŒæ­¥
ä»åº“1ï¼ˆSlave1ï¼‰ ä»åº“2ï¼ˆSlave2ï¼‰

- ä¸»åº“ï¼šå¤„ç†å†™æ“ä½œï¼ˆå¢åˆ æ”¹ï¼‰
- ä»åº“ï¼šå¤„ç†è¯»æ“ä½œï¼ˆæŸ¥è¯¢ï¼‰

å¥½å¤„ï¼šåˆ†æ‹…å‹åŠ›ï¼Œæé«˜æ€§èƒ½
```

**åœºæ™¯3ï¼šæ–°æ—§ç³»ç»Ÿå¹¶å­˜** â­â­
```
å…¬å¸åœ¨å‡çº§ç³»ç»Ÿï¼š
- æ—§æ•°æ®åº“ï¼šå†å²æ•°æ®ï¼ˆåªè¯»ï¼‰
- æ–°æ•°æ®åº“ï¼šå½“å‰ä¸šåŠ¡æ•°æ®ï¼ˆè¯»å†™ï¼‰

éœ€è¦åŒæ—¶è®¿é—®æ–°æ—§ä¸¤ä¸ªåº“
```

### 2.2 ä½¿ç”¨å¤šæ•°æ®æºçš„å¥½å¤„


| å¥½å¤„ | è¯´æ˜ | åœºæ™¯ä¸¾ä¾‹ |
|------|------|----------|
| **æ•°æ®éš”ç¦»** | ä¸åŒä¸šåŠ¡æ•°æ®åˆ†å¼€å­˜å‚¨ | è®¢å•å’Œç”¨æˆ·æ•°æ®åˆ†åº“å­˜å‚¨ |
| **æ€§èƒ½æå‡** | è¯»å†™åˆ†ç¦»ï¼Œåˆ†æ‹…å‹åŠ› | æŸ¥è¯¢èµ°ä»åº“ï¼Œå†™å…¥èµ°ä¸»åº“ |
| **çµæ´»æ‰©å±•** | æŒ‰éœ€æ·»åŠ æ•°æ®æº | æ–°å¢ä¸€ä¸ªæŠ¥è¡¨åº“ |
| **é™ä½é£é™©** | æŸä¸ªåº“æ•…éšœä¸å½±å“å…¨éƒ¨ | æ—¥å¿—åº“æŒ‚äº†ä¸å½±å“ä¸šåŠ¡åº“ |

---

## 3. ğŸ”§ åŠ¨æ€æ•°æ®æºé…ç½®


### 3.1 ä»€ä¹ˆæ˜¯åŠ¨æ€æ•°æ®æº


**ç®€å•ç†è§£**ï¼š
```
é™æ€é…ç½®ï¼šç¨‹åºå¯åŠ¨æ—¶å°±ç¡®å®šç”¨å“ªä¸ªæ•°æ®åº“ï¼Œä¸èƒ½æ”¹å˜
åŠ¨æ€é…ç½®ï¼šç¨‹åºè¿è¡Œä¸­å¯ä»¥éšæ—¶åˆ‡æ¢ä½¿ç”¨å“ªä¸ªæ•°æ®åº“

å°±åƒï¼š
é™æ€ = å›ºå®šåªçœ‹ä¸€ä¸ªç”µè§†é¢‘é“
åŠ¨æ€ = å¯ä»¥ç”¨é¥æ§å™¨éšæ—¶æ¢å°
```

### 3.2 å¼•å…¥ä¾èµ–


**ç¬¬ä¸€æ­¥ï¼šæ·»åŠ dynamic-datasource**
```xml
<!-- è¿™æ˜¯ä¸€ä¸ªå¸®æˆ‘ä»¬ç®¡ç†å¤šæ•°æ®æºçš„å·¥å…·åŒ… -->
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>dynamic-datasource-spring-boot-starter</artifactId>
    <version>3.6.1</version>
</dependency>
```

### 3.3 é…ç½®æ–‡ä»¶è®¾ç½®


**application.ymlå®Œæ•´é…ç½®** `[æ ¸å¿ƒé…ç½®]`
```yaml
spring:
  datasource:
    dynamic:
      # ä¸»æ•°æ®æºï¼ˆé»˜è®¤ä½¿ç”¨è¿™ä¸ªï¼‰
      primary: master
      # ä¸¥æ ¼æ¨¡å¼ï¼šå¦‚æœæŒ‡å®šçš„æ•°æ®æºä¸å­˜åœ¨ï¼Œä¼šæŠ¥é”™ï¼ˆå»ºè®®å¼€å¯ï¼‰
      strict: true
      
      # é…ç½®å¤šä¸ªæ•°æ®æº
      datasource:
        # ä¸»åº“é…ç½®
        master:
          driver-class-name: com.mysql.cj.jdbc.Driver
          url: jdbc:mysql://localhost:3306/db_master
          username: root
          password: 123456
          
        # ä»åº“é…ç½®
        slave:
          driver-class-name: com.mysql.cj.jdbc.Driver
          url: jdbc:mysql://localhost:3306/db_slave
          username: root
          password: 123456
          
        # è®¢å•åº“é…ç½®
        order:
          driver-class-name: com.mysql.cj.jdbc.Driver
          url: jdbc:mysql://localhost:3306/db_order
          username: root
          password: 123456
```

**é…ç½®è¯´æ˜**ï¼š

| é…ç½®é¡¹ | å«ä¹‰ | ä½œç”¨ |
|--------|------|------|
| `primary` | ä¸»æ•°æ®æºåç§° | æ²¡æœ‰æŒ‡å®šæ—¶é»˜è®¤ç”¨å“ªä¸ªåº“ |
| `strict` | ä¸¥æ ¼æ¨¡å¼ | å¼€å¯åå¦‚æœæ•°æ®æºä¸å­˜åœ¨ä¼šæŠ¥é”™æç¤º |
| `datasource` | æ•°æ®æºåˆ—è¡¨ | å®šä¹‰æ‰€æœ‰å¯ç”¨çš„æ•°æ®åº“è¿æ¥ |

---

## 4. ğŸ“Œ @DSæ³¨è§£ä½¿ç”¨è¯¦è§£


### 4.1 @DSæ³¨è§£æ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼š
- `@DS`å°±åƒç»™æ–¹æ³•è´´äº†ä¸ª"æ ‡ç­¾"ï¼Œå‘Šè¯‰ç¨‹åº"è¿™ä¸ªæ–¹æ³•è¦ç”¨å“ªä¸ªæ•°æ®åº“"
- ç±»æ¯”ï¼šå°±åƒå¿«é€’ä¸Šçš„åœ°å€æ ‡ç­¾ï¼Œå‘Šè¯‰å¿«é€’å‘˜é€åˆ°å“ªé‡Œ

### 4.2 åŸºæœ¬ä½¿ç”¨æ–¹å¼


**æ–¹å¼1ï¼šåœ¨Serviceç±»ä¸Šä½¿ç”¨** â­â­â­
```java
// æ•´ä¸ªç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½ç”¨slaveæ•°æ®æº
@Service
@DS("slave")  // æ ‡è®°ï¼šè¿™ä¸ªç±»ç”¨ä»åº“
public class UserService {
    
    public List<User> getAllUsers() {
        // è¿™ä¸ªæ–¹æ³•ä¼šä»slaveåº“æŸ¥è¯¢
        return userMapper.selectList(null);
    }
    
    public User getUserById(Long id) {
        // è¿™ä¸ªæ–¹æ³•ä¹Ÿä»slaveåº“æŸ¥è¯¢
        return userMapper.selectById(id);
    }
}
```

**æ–¹å¼2ï¼šåœ¨Serviceæ–¹æ³•ä¸Šä½¿ç”¨** â­â­â­
```java
@Service
public class OrderService {
    
    // æŸ¥è¯¢æ“ä½œç”¨ä»åº“
    @DS("slave")
    public List<Order> getOrders() {
        return orderMapper.selectList(null);
    }
    
    // å†™å…¥æ“ä½œç”¨ä¸»åº“
    @DS("master")
    public void createOrder(Order order) {
        orderMapper.insert(order);
    }
}
```

**æ–¹å¼3ï¼šåœ¨Mapperæ¥å£ä¸Šä½¿ç”¨** â­â­
```java
// è¿™ä¸ªMapperçš„æ‰€æœ‰æ–¹æ³•éƒ½ç”¨orderåº“
@DS("order")
public interface OrderMapper extends BaseMapper<Order> {
    // æ‰€æœ‰æ“ä½œéƒ½è®¿é—®orderæ•°æ®æº
}
```

### 4.3 ä¼˜å…ˆçº§è§„åˆ™


**ä¼˜å…ˆçº§ä»é«˜åˆ°ä½**ï¼š
```
æ–¹æ³•ä¸Šçš„@DS  >  ç±»ä¸Šçš„@DS  >  é»˜è®¤æ•°æ®æº

ç¤ºä¾‹è¯´æ˜ï¼š
@Service
@DS("slave")           // ç±»çº§åˆ«ï¼šé»˜è®¤ç”¨slave
public class UserService {
    
    public void method1() {
        // ç”¨slaveï¼ˆç»§æ‰¿ç±»ä¸Šçš„é…ç½®ï¼‰
    }
    
    @DS("master")      // æ–¹æ³•çº§åˆ«ï¼šä¼˜å…ˆçº§æ›´é«˜
    public void method2() {
        // ç”¨masterï¼ˆæ–¹æ³•é…ç½®è¦†ç›–ç±»é…ç½®ï¼‰
    }
}
```

### 4.4 å®é™…ä½¿ç”¨å»ºè®®


> **æœ€ä½³å®è·µ** ğŸ’¡
> 
> - **æŸ¥è¯¢æ–¹æ³•**ï¼šåŠ `@DS("slave")`èµ°ä»åº“
> - **å†™å…¥æ–¹æ³•**ï¼šåŠ `@DS("master")`èµ°ä¸»åº“
> - **ç‰¹å®šä¸šåŠ¡**ï¼šåŠ `@DS("ä¸šåŠ¡åº“å")`èµ°ä¸“ç”¨åº“
> - **æ²¡æœ‰åŠ æ³¨è§£**ï¼šè‡ªåŠ¨ä½¿ç”¨primaryé…ç½®çš„é»˜è®¤åº“

---

## 5. âš™ï¸ æ•°æ®æºåˆ‡æ¢æœºåˆ¶


### 5.1 åˆ‡æ¢åŸç†å›¾è§£


**æ•°æ®æºåˆ‡æ¢æµç¨‹**ï¼š
```
1. è¯·æ±‚è¿›æ¥
   â†“
2. æ£€æŸ¥æ–¹æ³•æ˜¯å¦æœ‰@DSæ³¨è§£
   â†“
3. æœ‰æ³¨è§£ï¼šåˆ‡æ¢åˆ°æŒ‡å®šæ•°æ®æº
   æ²¡æ³¨è§£ï¼šä½¿ç”¨é»˜è®¤æ•°æ®æº
   â†“
4. æ‰§è¡Œæ•°æ®åº“æ“ä½œ
   â†“
5. æ“ä½œå®Œæˆï¼Œæ¢å¤é»˜è®¤æ•°æ®æº
```

### 5.2 æ ¸å¿ƒå®ç°åŸç†


**æŠ€æœ¯å®ç°** `[äº†è§£å³å¯]`ï¼š
```
åº•å±‚ä½¿ç”¨äº†ThreadLocalæ¥å­˜å‚¨å½“å‰çº¿ç¨‹çš„æ•°æ®æºæ ‡è¯†

ç®€å•ç†è§£ï¼š
- æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„"å°ç¬”è®°æœ¬"
- æ‰§è¡Œå‰åœ¨ç¬”è®°æœ¬å†™ä¸Š"ç”¨å“ªä¸ªåº“"
- æ‰§è¡Œæ—¶çœ‹ç¬”è®°æœ¬å†³å®šè¿æ¥å“ªä¸ªåº“
- æ‰§è¡Œå®Œæ“¦æ‰ç¬”è®°æœ¬å†…å®¹
```

### 5.3 åˆ‡æ¢æ—¶æœºè¯´æ˜


**è‡ªåŠ¨åˆ‡æ¢çš„å…³é”®ç‚¹**ï¼š

| æ—¶æœº | è¯´æ˜ | æ³¨æ„äº‹é¡¹ |
|------|------|----------|
| **æ–¹æ³•è°ƒç”¨å‰** | æ ¹æ®@DSæ³¨è§£è®¾ç½®æ•°æ®æº | AOPæ‹¦æˆªå®ç° |
| **æ–¹æ³•æ‰§è¡Œä¸­** | ä½¿ç”¨è®¾ç½®å¥½çš„æ•°æ®æº | å½“å‰çº¿ç¨‹æœ‰æ•ˆ |
| **æ–¹æ³•æ‰§è¡Œå** | æ¸…é™¤æ•°æ®æºè®¾ç½® | é˜²æ­¢å½±å“å…¶ä»–æ“ä½œ |
| **è·¨æ–¹æ³•è°ƒç”¨** | å†…éƒ¨è°ƒç”¨å¯èƒ½å¤±æ•ˆ | æ³¨æ„Spring AOPé™åˆ¶ |

> **é‡è¦æç¤º** âš ï¸
> 
> åœ¨åŒä¸€ä¸ªç±»ä¸­ï¼Œæ–¹æ³•Aè°ƒç”¨æ–¹æ³•Bï¼Œ@DSå¯èƒ½å¤±æ•ˆï¼
> 
> åŸå› ï¼šSpringçš„AOPä»£ç†æœºåˆ¶ï¼Œå†…éƒ¨è°ƒç”¨ä¸ç»è¿‡ä»£ç†
> 
> è§£å†³ï¼šæŠŠæ–¹æ³•Bæ”¾åˆ°å¦ä¸€ä¸ªServiceç±»ä¸­

---

## 6. ğŸ”„ ä¸»ä»åˆ†ç¦»é…ç½®


### 6.1 ä»€ä¹ˆæ˜¯ä¸»ä»åˆ†ç¦»


**å½¢è±¡æ¯”å–»**ï¼š
```
å›¾ä¹¦é¦†çš„å€Ÿä¹¦å’Œè¿˜ä¹¦ï¼š
- å€Ÿä¹¦çª—å£ï¼ˆè¯»ï¼‰ï¼šå¤šä¸ªï¼Œåˆ†æ‹…æŸ¥è¯¢å‹åŠ›
- è¿˜ä¹¦çª—å£ï¼ˆå†™ï¼‰ï¼šä¸€ä¸ªï¼Œç»Ÿä¸€å¤„ç†å½’è¿˜

ä¸»ä»æ¶æ„ï¼š
- ä¸»åº“ï¼ˆMasterï¼‰ï¼šä¸€ä¸ªï¼Œå¤„ç†å†™æ“ä½œ
- ä»åº“ï¼ˆSlaveï¼‰ï¼šå¤šä¸ªï¼Œå¤„ç†è¯»æ“ä½œ
```

**æ¶æ„ç¤ºæ„å›¾**ï¼š
```
åº”ç”¨å±‚
  â”‚
  â”œâ”€â†’ å†™æ“ä½œ â†’ ä¸»åº“ï¼ˆMasterï¼‰
  â”‚              â”‚
  â”‚              â†“ æ•°æ®åŒæ­¥
  â””â”€â†’ è¯»æ“ä½œ â†’ ä»åº“1ï¼ˆSlave1ï¼‰
             â†’ ä»åº“2ï¼ˆSlave2ï¼‰
```

### 6.2 ä¸»ä»åˆ†ç¦»é…ç½®


**é…ç½®å¤šä¸ªä»åº“**ï¼š
```yaml
spring:
  datasource:
    dynamic:
      primary: master
      datasource:
        # ä¸»åº“ï¼šè´Ÿè´£å†™
        master:
          url: jdbc:mysql://192.168.1.10:3306/mydb
          username: root
          password: 123456
          
        # ä»åº“1ï¼šè´Ÿè´£è¯»
        slave1:
          url: jdbc:mysql://192.168.1.11:3306/mydb
          username: root
          password: 123456
          
        # ä»åº“2ï¼šè´Ÿè´£è¯»
        slave2:
          url: jdbc:mysql://192.168.1.12:3306/mydb
          username: root
          password: 123456
```

### 6.3 ä¸»ä»æ¨¡å¼ä»£ç å®ç°


**ä¸šåŠ¡å±‚å®ç°** â­â­â­
```java
@Service
public class ProductService {
    
    @Autowired
    private ProductMapper productMapper;
    
    // æŸ¥è¯¢å•†å“ï¼šä»slaveåº“è¯»å–
    @DS("slave1")
    public Product getProduct(Long id) {
        return productMapper.selectById(id);
    }
    
    // æŸ¥è¯¢å•†å“åˆ—è¡¨ï¼šä»slaveåº“è¯»å–
    @DS("slave1")
    public List<Product> getProductList() {
        return productMapper.selectList(null);
    }
    
    // æ·»åŠ å•†å“ï¼šå‘masteråº“å†™å…¥
    @DS("master")
    public void addProduct(Product product) {
        productMapper.insert(product);
    }
    
    // æ›´æ–°å•†å“ï¼šå‘masteråº“å†™å…¥
    @DS("master")
    public void updateProduct(Product product) {
        productMapper.updateById(product);
    }
    
    // åˆ é™¤å•†å“ï¼šå‘masteråº“å†™å…¥
    @DS("master")
    public void deleteProduct(Long id) {
        productMapper.deleteById(id);
    }
}
```

**ä½¿ç”¨è§„åˆ™æ€»ç»“**ï¼š
- âœ… æŸ¥è¯¢æ“ä½œï¼ˆSELECTï¼‰â†’ ç”¨`@DS("slave")`
- âœ… æ–°å¢æ“ä½œï¼ˆINSERTï¼‰â†’ ç”¨`@DS("master")`
- âœ… æ›´æ–°æ“ä½œï¼ˆUPDATEï¼‰â†’ ç”¨`@DS("master")`
- âœ… åˆ é™¤æ“ä½œï¼ˆDELETEï¼‰â†’ ç”¨`@DS("master")`

---

## 7. ğŸ“– è¯»å†™åˆ†ç¦»ç­–ç•¥


### 7.1 è¯»å†™åˆ†ç¦»çš„æ¦‚å¿µ


**æ ¸å¿ƒæ€æƒ³**ï¼š
```
è¯»å†™åˆ†ç¦» = è¯»æ“ä½œå’Œå†™æ“ä½œç”¨ä¸åŒçš„æ•°æ®åº“

ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ
- è¯»æ“ä½œå¤šï¼ˆæ¯”å¦‚æŸ¥è¯¢å•†å“ï¼‰ï¼šç”¨ä»åº“ï¼Œæœ‰å¤šä¸ªä»åº“å¯ä»¥åˆ†æ‹…
- å†™æ“ä½œå°‘ï¼ˆæ¯”å¦‚ä¸‹å•ï¼‰ï¼šç”¨ä¸»åº“ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
```

**å®é™…åœºæ™¯**ï¼š
```
ç”µå•†ç³»ç»Ÿçš„å…¸å‹æƒ…å†µï¼š
- æµè§ˆå•†å“ï¼ˆè¯»ï¼‰ï¼šæ¯ç§’10000æ¬¡ â†’ ä»åº“å¤„ç†
- ä¸‹å•è´­ä¹°ï¼ˆå†™ï¼‰ï¼šæ¯ç§’100æ¬¡ â†’ ä¸»åº“å¤„ç†

è¯»å†™æ¯”ä¾‹çº¦ 100:1
```

### 7.2 æ‰‹åŠ¨è¯»å†™åˆ†ç¦»å®ç°


**åŸºç¡€Serviceç±»** `[æ¨èæ¨¡å¼]`
```java
@Service
public class BaseService {
    
    // æ‰€æœ‰è¯»æ“ä½œçš„åŸºç¡€æ–¹æ³•
    @DS("slave")
    protected <T> List<T> selectList(BaseMapper<T> mapper, Wrapper<T> wrapper) {
        return mapper.selectList(wrapper);
    }
    
    @DS("slave")
    protected <T> T selectById(BaseMapper<T> mapper, Serializable id) {
        return mapper.selectById(id);
    }
    
    // æ‰€æœ‰å†™æ“ä½œçš„åŸºç¡€æ–¹æ³•
    @DS("master")
    protected <T> int insert(BaseMapper<T> mapper, T entity) {
        return mapper.insert(entity);
    }
    
    @DS("master")
    protected <T> int updateById(BaseMapper<T> mapper, T entity) {
        return mapper.updateById(entity);
    }
}
```

**ä¸šåŠ¡Serviceç»§æ‰¿ä½¿ç”¨**ï¼š
```java
@Service
public class OrderService extends BaseService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    // æŸ¥è¯¢è®¢å• - è‡ªåŠ¨èµ°slave
    public Order getOrder(Long id) {
        return selectById(orderMapper, id);
    }
    
    // åˆ›å»ºè®¢å• - è‡ªåŠ¨èµ°master
    public void createOrder(Order order) {
        insert(orderMapper, order);
    }
}
```

### 7.3 ä»åº“è´Ÿè½½å‡è¡¡


**å¤šä»åº“éšæœºé€‰æ‹©** `[é«˜çº§é…ç½®]`
```yaml
spring:
  datasource:
    dynamic:
      datasource:
        master:
          url: jdbc:mysql://master:3306/db
          
        # ä»åº“ç»„ï¼šé…ç½®å¤šä¸ªä»åº“
        slave:
          - url: jdbc:mysql://slave1:3306/db
          - url: jdbc:mysql://slave2:3306/db
          - url: jdbc:mysql://slave3:3306/db
      
      # ä»åº“è´Ÿè½½å‡è¡¡ç­–ç•¥
      strategy: random  # éšæœºé€‰æ‹©
      # strategy: round  # è½®è¯¢é€‰æ‹©
```

**è´Ÿè½½ç­–ç•¥è¯´æ˜**ï¼š

| ç­–ç•¥ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `random` | éšæœºé€‰æ‹©ä»åº“ | ä»åº“é…ç½®ç›¸åŒ |
| `round` | è½®è¯¢é€‰æ‹©ä»åº“ | å¹³å‡åˆ†é…è¯·æ±‚ |
| `weight` | æƒé‡é€‰æ‹© | ä»åº“æ€§èƒ½ä¸åŒ |

---

## 8. ğŸ›¤ï¸ æ•°æ®æºè·¯ç”±è§„åˆ™


### 8.1 ä»€ä¹ˆæ˜¯è·¯ç”±è§„åˆ™


**é€šä¿—ç†è§£**ï¼š
```
è·¯ç”±è§„åˆ™ = å†³å®šç”¨å“ªä¸ªæ•°æ®åº“çš„"è§„åˆ™"

å°±åƒå¯¼èˆªè½¯ä»¶ï¼š
- è¾“å…¥ç›®çš„åœ°ï¼ˆæ•°æ®æºåç§°ï¼‰
- ç³»ç»Ÿè®¡ç®—è·¯çº¿ï¼ˆæŸ¥æ‰¾æ•°æ®æºé…ç½®ï¼‰
- æŒ‡å¼•ä½ åˆ°è¾¾ï¼ˆè¿æ¥åˆ°æ•°æ®åº“ï¼‰
```

### 8.2 åŸºäºæ³¨è§£çš„è·¯ç”±


**è§„åˆ™1ï¼šç›´æ¥æŒ‡å®šæ•°æ®æº** â­â­â­
```java
@Service
public class UserService {
    
    @DS("user_db")  // æ˜ç¡®æŒ‡å®šä½¿ç”¨user_dbæ•°æ®æº
    public User getUser(Long id) {
        return userMapper.selectById(id);
    }
}
```

**è§„åˆ™2ï¼šä½¿ç”¨è¡¨è¾¾å¼** â­â­
```java
@Service
public class OrderService {
    
    // #headerï¼šä»è¯·æ±‚å¤´è·å–æ•°æ®æºåç§°
    @DS("#header.tenantId")
    public List<Order> getOrders() {
        return orderMapper.selectList(null);
    }
}
```

### 8.3 åŸºäºæ¡ä»¶çš„åŠ¨æ€è·¯ç”±


**è‡ªå®šä¹‰è·¯ç”±é€»è¾‘** `[é«˜çº§ç”¨æ³•]`
```java
@Component
public class DynamicDataSourceAspect {
    
    @Around("@annotation(ds)")
    public Object around(ProceedingJoinPoint point, DS ds) throws Throwable {
        // è·å–å½“å‰æ—¶é—´
        int hour = LocalDateTime.now().getHour();
        
        // æ ¹æ®æ—¶é—´æ®µé€‰æ‹©æ•°æ®æº
        String dsKey;
        if (hour >= 0 && hour < 12) {
            dsKey = "morning_db";  // ä¸Šåˆç”¨è¿™ä¸ªåº“
        } else {
            dsKey = "afternoon_db"; // ä¸‹åˆç”¨è¿™ä¸ªåº“
        }
        
        // è®¾ç½®æ•°æ®æº
        DynamicDataSourceContextHolder.push(dsKey);
        
        try {
            return point.proceed();
        } finally {
            DynamicDataSourceContextHolder.poll();
        }
    }
}
```

### 8.4 å¤šç§Ÿæˆ·æ•°æ®æºè·¯ç”±


**ç§Ÿæˆ·éš”ç¦»åœºæ™¯** `[SaaSç³»ç»Ÿå¸¸ç”¨]`
```java
@Service
public class TenantService {
    
    // æ ¹æ®ç§Ÿæˆ·IDè·¯ç”±åˆ°ä¸åŒæ•°æ®åº“
    public List<User> getTenantUsers(String tenantId) {
        // åŠ¨æ€è®¾ç½®æ•°æ®æº
        DynamicDataSourceContextHolder.push("tenant_" + tenantId);
        
        try {
            return userMapper.selectList(null);
        } finally {
            DynamicDataSourceContextHolder.poll();
        }
    }
}
```

**é…ç½®å¤šç§Ÿæˆ·æ•°æ®æº**ï¼š
```yaml
spring:
  datasource:
    dynamic:
      datasource:
        tenant_001:
          url: jdbc:mysql://localhost:3306/tenant_001
        tenant_002:
          url: jdbc:mysql://localhost:3306/tenant_002
        tenant_003:
          url: jdbc:mysql://localhost:3306/tenant_003
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ¦‚å¿µ


```
ğŸ”¸ å¤šæ•°æ®æºï¼šä¸€ä¸ªåº”ç”¨è¿æ¥å¤šä¸ªæ•°æ®åº“
ğŸ”¸ åŠ¨æ€æ•°æ®æºï¼šè¿è¡Œæ—¶å¯ä»¥åˆ‡æ¢ä½¿ç”¨å“ªä¸ªæ•°æ®åº“
ğŸ”¸ @DSæ³¨è§£ï¼šæ ‡è®°æ–¹æ³•ä½¿ç”¨å“ªä¸ªæ•°æ®æº
ğŸ”¸ ä¸»ä»åˆ†ç¦»ï¼šä¸»åº“å†™ï¼Œä»åº“è¯»
ğŸ”¸ è¯»å†™åˆ†ç¦»ï¼šè¯»å†™æ“ä½œåˆ†å¼€ï¼Œæå‡æ€§èƒ½
ğŸ”¸ æ•°æ®æºè·¯ç”±ï¼šå†³å®šä½¿ç”¨å“ªä¸ªæ•°æ®åº“çš„è§„åˆ™
```

### 9.2 é…ç½®æ­¥éª¤é€Ÿè®°


**ä¸‰æ­¥é…ç½®å¤šæ•°æ®æº** âœ…

1ï¸âƒ£ **æ·»åŠ ä¾èµ–**
```xml
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>dynamic-datasource-spring-boot-starter</artifactId>
</dependency>
```

2ï¸âƒ£ **é…ç½®æ•°æ®æº**
```yaml
spring:
  datasource:
    dynamic:
      primary: master
      datasource:
        master: {...}
        slave: {...}
```

3ï¸âƒ£ **ä½¿ç”¨@DSæ³¨è§£**
```java
@DS("slave")
public void query() {...}

@DS("master")
public void save() {...}
```

### 9.3 ä½¿ç”¨åœºæ™¯å¯¹ç…§è¡¨


| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | é…ç½®æ–¹å¼ |
|------|----------|----------|
| **ä¸šåŠ¡åº“åˆ†ç¦»** | ä¸åŒä¸šåŠ¡ç”¨ä¸åŒåº“ | é…ç½®å¤šä¸ªdatasourceï¼Œç”¨@DSæŒ‡å®š |
| **ä¸»ä»è¯»å†™åˆ†ç¦»** | è¯»ç”¨ä»åº“ï¼Œå†™ç”¨ä¸»åº“ | master+slaveé…ç½®ï¼Œ@DSåˆ†åˆ«æ ‡è®° |
| **å¤šç§Ÿæˆ·éš”ç¦»** | æ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹åº“ | åŠ¨æ€è·¯ç”±ï¼Œæ ¹æ®ç§Ÿæˆ·IDåˆ‡æ¢ |
| **åˆ†åº“åˆ†è¡¨** | æŒ‰è§„åˆ™åˆ†æ•£æ•°æ® | è‡ªå®šä¹‰è·¯ç”±é€»è¾‘ |

### 9.4 å¸¸è§é—®é¢˜ä¸è§£å†³


**é—®é¢˜1ï¼š@DSæ³¨è§£ä¸ç”Ÿæ•ˆ** âš ï¸
```
åŸå› ï¼šåŒç±»å†…éƒ¨æ–¹æ³•è°ƒç”¨ï¼ŒAOPå¤±æ•ˆ
è§£å†³ï¼šæŠŠæ–¹æ³•æ‹†åˆ°ä¸åŒçš„Serviceç±»ä¸­
```

**é—®é¢˜2ï¼šäº‹åŠ¡å’Œå¤šæ•°æ®æºå†²çª** âš ï¸
```
åŸå› ï¼š@Transactionalåœ¨åˆ‡æ¢æ•°æ®æºä¹‹å‰æ‰§è¡Œ
è§£å†³ï¼š@DSæ³¨è§£æ”¾åœ¨@Transactionalä¹‹å‰ï¼Œæˆ–ä½¿ç”¨ç¼–ç¨‹å¼äº‹åŠ¡
```

**é—®é¢˜3ï¼šä»åº“æ•°æ®å»¶è¿Ÿ** âš ï¸
```
åŸå› ï¼šä¸»ä»åŒæ­¥æœ‰å»¶è¿Ÿï¼ˆé€šå¸¸å‡ æ¯«ç§’åˆ°å‡ ç§’ï¼‰
è§£å†³ï¼šé‡è¦æ•°æ®å†™å…¥åç«‹å³è¯»å–è¦èµ°ä¸»åº“
```

### 9.5 æœ€ä½³å®è·µå»ºè®®


> **å¼€å‘å»ºè®®** ğŸ’¡
> 
> âœ… **å‘½åè§„èŒƒ**ï¼šæ•°æ®æºåç§°è¦è§åçŸ¥æ„ï¼ˆmasterã€slaveã€order_dbï¼‰
> 
> âœ… **è¯»å†™åˆ†æ˜**ï¼šæŸ¥è¯¢ç”¨ä»åº“ï¼Œå†™å…¥ç”¨ä¸»åº“
> 
> âœ… **å¼‚å¸¸å¤„ç†**ï¼šæ•°æ®æºåˆ‡æ¢å¤±è´¥è¦æœ‰é™çº§æ–¹æ¡ˆ
> 
> âœ… **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§å„æ•°æ®æºçš„è¿æ¥æ•°å’Œæ€§èƒ½
> 
> âœ… **é…ç½®ç®¡ç†**ï¼šæ•°æ®æºé…ç½®å»ºè®®æ”¾é…ç½®ä¸­å¿ƒç»Ÿä¸€ç®¡ç†

**è®°å¿†å£è¯€**ï¼š
```
å¤šæºé…ç½®ä¸‰æ­¥èµ°ï¼Œä¾èµ–é…ç½®åŠ æ³¨è§£
ä¸»åº“å†™æ¥ä»åº“è¯»ï¼Œè·¯ç”±è§„åˆ™è¦ç†æ¸…
æ³¨è§£å¤±æ•ˆæŸ¥AOPï¼Œäº‹åŠ¡å†²çªè¦æ³¨æ„
```