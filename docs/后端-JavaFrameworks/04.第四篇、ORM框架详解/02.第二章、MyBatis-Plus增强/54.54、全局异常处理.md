---
title: 54ã€å…¨å±€å¼‚å¸¸å¤„ç†
---
## ğŸ“š ç›®å½•

1. [å¼‚å¸¸å¤„ç†åŸºç¡€æ¦‚å¿µ](#1-å¼‚å¸¸å¤„ç†åŸºç¡€æ¦‚å¿µ)
2. [@ControllerAdviceç»Ÿä¸€å¼‚å¸¸æ•è·](#2-controlleradviceç»Ÿä¸€å¼‚å¸¸æ•è·)
3. [å¼‚å¸¸åˆ†ç±»ä¸å¤„ç†ç­–ç•¥](#3-å¼‚å¸¸åˆ†ç±»ä¸å¤„ç†ç­–ç•¥)
4. [é”™è¯¯ä¿¡æ¯å›½é™…åŒ–](#4-é”™è¯¯ä¿¡æ¯å›½é™…åŒ–)
5. [æ—¥å¿—è®°å½•ç­–ç•¥](#5-æ—¥å¿—è®°å½•ç­–ç•¥)
6. [å¼‚å¸¸ç›‘æ§å‘Šè­¦](#6-å¼‚å¸¸ç›‘æ§å‘Šè­¦)
7. [æœ€ä½³å®è·µæ€»ç»“](#7-æœ€ä½³å®è·µæ€»ç»“)

---

## 1. ğŸ¯ å¼‚å¸¸å¤„ç†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å…¨å±€å¼‚å¸¸å¤„ç†


**é€šä¿—ç†è§£**ï¼šå°±åƒç»™æ•´ä¸ªåº”ç”¨è£…äº†ä¸€ä¸ª"å®‰å…¨ç½‘"

```
ç”¨æˆ·æ“ä½œ â†’ Controller â†’ Service â†’ Mapper
    â†“          â†“          â†“         â†“
  å‡ºé”™äº†    å‡ºé”™äº†     å‡ºé”™äº†    å‡ºé”™äº†
    â†“          â†“          â†“         â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
            å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼ˆç»Ÿä¸€æ•è·ï¼‰
                   â†“
            è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
```

**ğŸ”¸ æ ¸å¿ƒä»·å€¼**
- **ç»Ÿä¸€ç®¡ç†**ï¼šæ‰€æœ‰å¼‚å¸¸åœ¨ä¸€ä¸ªåœ°æ–¹å¤„ç†ï¼Œä¸ç”¨åˆ°å¤„å†™try-catch
- **å‹å¥½æç¤º**ï¼šæŠŠæŠ€æœ¯é”™è¯¯ç¿»è¯‘æˆç”¨æˆ·èƒ½æ‡‚çš„è¯
- **æ—¥å¿—è®°å½•**ï¼šè‡ªåŠ¨è®°å½•é”™è¯¯ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜
- **å®‰å…¨ä¿æŠ¤**ï¼šé¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²ç»™å‰ç«¯

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å…¨å±€å¼‚å¸¸å¤„ç†


**âŒ æ²¡æœ‰å…¨å±€å¤„ç†çš„é—®é¢˜**
```java
// æ¯ä¸ªControlleréƒ½è¦å†™é‡å¤çš„å¼‚å¸¸å¤„ç†ä»£ç 
@GetMapping("/user/{id}")
public Result getUser(@PathVariable Long id) {
    try {
        User user = userService.getById(id);
        return Result.ok(user);
    } catch (Exception e) {
        // é‡å¤ä»£ç 1
        log.error("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥", e);
        return Result.fail("ç³»ç»Ÿé”™è¯¯");
    }
}

@PostMapping("/user")
public Result saveUser(@RequestBody User user) {
    try {
        userService.save(user);
        return Result.ok();
    } catch (Exception e) {
        // é‡å¤ä»£ç 2ï¼ˆå’Œä¸Šé¢ä¸€æ ·ï¼‰
        log.error("ä¿å­˜ç”¨æˆ·å¤±è´¥", e);
        return Result.fail("ç³»ç»Ÿé”™è¯¯");
    }
}
```

**âœ… ä½¿ç”¨å…¨å±€å¤„ç†å**
```java
// Controllerä»£ç å˜å¾—ç®€æ´
@GetMapping("/user/{id}")
public Result getUser(@PathVariable Long id) {
    User user = userService.getById(id);
    return Result.ok(user);  // å¼‚å¸¸è‡ªåŠ¨è¢«å…¨å±€å¤„ç†å™¨æ•è·
}

@PostMapping("/user")
public Result saveUser(@RequestBody User user) {
    userService.save(user);
    return Result.ok();  // ä¸ç”¨å†™try-catchäº†
}
```

---

## 2. ğŸ›¡ï¸ @ControllerAdviceç»Ÿä¸€å¼‚å¸¸æ•è·


### 2.1 @ControllerAdviceæ³¨è§£è¯¦è§£


**ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ**
- **ä½œç”¨**ï¼šæ ‡è®°è¿™æ˜¯ä¸€ä¸ªå…¨å±€å¼‚å¸¸å¤„ç†ç±»
- **èŒƒå›´**ï¼šä½œç”¨äºæ‰€æœ‰å¸¦@Controlleræˆ–@RestControllerçš„ç±»
- **æœºåˆ¶**ï¼šSpring AOPåˆ‡é¢ï¼Œè‡ªåŠ¨æ‹¦æˆªå¼‚å¸¸

**ğŸ”¸ åŸºç¡€ä½¿ç”¨**
```java
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;

/**
 * å…¨å±€å¼‚å¸¸å¤„ç†å™¨
 * ç›¸å½“äºç»™æ•´ä¸ªé¡¹ç›®è£…äº†ä¸€ä¸ªå¼‚å¸¸"æ¥æ”¶å™¨"
 */
@ControllerAdvice  // å£°æ˜è¿™æ˜¯å…¨å±€å¤„ç†å™¨
@ResponseBody      // è¿”å›JSONæ•°æ®
public class GlobalExceptionHandler {
    
    /**
     * æ•è·æ‰€æœ‰Exceptionå¼‚å¸¸
     * @ExceptionHandler æŒ‡å®šè¦æ•è·çš„å¼‚å¸¸ç±»å‹
     */
    @ExceptionHandler(Exception.class)
    public Result handleException(Exception e) {
        // ç»Ÿä¸€å¤„ç†é€»è¾‘
        return Result.fail("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
    }
}
```

### 2.2 å¸¸ç”¨æ³¨è§£ç»„åˆ


| æ³¨è§£ | ä½œç”¨ | ä½¿ç”¨åœºæ™¯ |
|------|------|---------|
| **@ControllerAdvice** | `æ ‡è®°å…¨å±€å¤„ç†ç±»` | `å¿…é¡»ä½¿ç”¨` |
| **@RestControllerAdvice** | `@ControllerAdvice + @ResponseBody` | `RESTful APIé¡¹ç›®æ¨è` |
| **@ExceptionHandler** | `æŒ‡å®šå¤„ç†çš„å¼‚å¸¸ç±»å‹` | `æ¯ä¸ªå¤„ç†æ–¹æ³•å¿…é¡»` |
| **@ResponseStatus** | `è®¾ç½®HTTPçŠ¶æ€ç ` | `éœ€è¦è‡ªå®šä¹‰çŠ¶æ€ç æ—¶` |

**ğŸ’¡ å®ç”¨ç¤ºä¾‹**
```java
@RestControllerAdvice  // ç»„åˆæ³¨è§£ï¼Œæ›´ç®€æ´
public class GlobalExceptionHandler {
    
    // å¤„ç†ä¸šåŠ¡å¼‚å¸¸ï¼ˆè‡ªå®šä¹‰ï¼‰
    @ExceptionHandler(BusinessException.class)
    public Result businessException(BusinessException e) {
        return Result.fail(e.getMessage());
    }
    
    // å¤„ç†å‚æ•°æ ¡éªŒå¼‚å¸¸
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result validException(MethodArgumentNotValidException e) {
        String message = e.getBindingResult()
            .getFieldError()
            .getDefaultMessage();
        return Result.fail(message);
    }
    
    // å¤„ç†æ‰€æœ‰æœªçŸ¥å¼‚å¸¸ï¼ˆå…œåº•ï¼‰
    @ExceptionHandler(Exception.class)
    public Result handleException(Exception e) {
        // è®°å½•æ—¥å¿—
        log.error("ç³»ç»Ÿå¼‚å¸¸ï¼š", e);
        // è¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯
        return Result.fail("ç³»ç»Ÿç¹å¿™");
    }
}
```

---

## 3. ğŸ” å¼‚å¸¸åˆ†ç±»ä¸å¤„ç†ç­–ç•¥


### 3.1 å¼‚å¸¸åˆ†ç±»ä½“ç³»


```
å¼‚å¸¸ç±»å‹æ ‘çŠ¶å›¾ï¼š
                    Throwable
                   /         \
              Error          Exception
              (ç³»ç»Ÿçº§)      /          \
                    RuntimeException  CheckedException
                    (è¿è¡Œæ—¶å¼‚å¸¸)      (ç¼–è¯‘æ—¶å¼‚å¸¸)
                    /        |        \
          ä¸šåŠ¡å¼‚å¸¸  å‚æ•°å¼‚å¸¸  æƒé™å¼‚å¸¸  æ•°æ®åº“å¼‚å¸¸
```

**ğŸ”¸ å¸¸è§å¼‚å¸¸åˆ†ç±»**

| å¼‚å¸¸ç±»å‹ | å«ä¹‰ | å¤„ç†æ–¹å¼ | HTTPçŠ¶æ€ç  |
|---------|------|---------|-----------|
| **ä¸šåŠ¡å¼‚å¸¸** | `ç”¨æˆ·æ“ä½œä¸å½“ã€ä¸šåŠ¡è§„åˆ™ä¸æ»¡è¶³` | `è¿”å›å‹å¥½æç¤º` | `200/400` |
| **å‚æ•°å¼‚å¸¸** | `è¯·æ±‚å‚æ•°ä¸åˆæ³•` | `è¿”å›å…·ä½“å­—æ®µé”™è¯¯` | `400` |
| **è®¤è¯å¼‚å¸¸** | `æœªç™»å½•æˆ–tokenè¿‡æœŸ` | `æç¤ºé‡æ–°ç™»å½•` | `401` |
| **æƒé™å¼‚å¸¸** | `æ— è®¿é—®æƒé™` | `æç¤ºæƒé™ä¸è¶³` | `403` |
| **æ•°æ®åº“å¼‚å¸¸** | `SQLæ‰§è¡Œå¤±è´¥ã€æ•°æ®å†²çª` | `è®°å½•æ—¥å¿—ï¼Œè¿”å›é€šç”¨é”™è¯¯` | `500` |
| **ç³»ç»Ÿå¼‚å¸¸** | `æœªçŸ¥é”™è¯¯` | `è®°å½•è¯¦ç»†æ—¥å¿—ï¼Œè¿”å›é€šç”¨æç¤º` | `500` |

### 3.2 è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸


**ğŸ“‹ ä¸šåŠ¡å¼‚å¸¸åŸºç±»**
```java
/**
 * ä¸šåŠ¡å¼‚å¸¸ç±»
 * ç”¨äºå¤„ç†å¯é¢„è§çš„ä¸šåŠ¡é”™è¯¯
 */
public class BusinessException extends RuntimeException {
    
    private Integer code;    // é”™è¯¯ç 
    private String message;  // é”™è¯¯ä¿¡æ¯
    
    public BusinessException(String message) {
        super(message);
        this.code = 500;
        this.message = message;
    }
    
    public BusinessException(Integer code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }
    
    // getteræ–¹æ³•...
}
```

**ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹**
```java
@Service
public class UserServiceImpl {
    
    public User getById(Long id) {
        User user = userMapper.selectById(id);
        
        // ä¸šåŠ¡åˆ¤æ–­ï¼ŒæŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸
        if (user == null) {
            throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        if (user.getStatus() == 0) {
            throw new BusinessException("ç”¨æˆ·å·²è¢«ç¦ç”¨");
        }
        
        return user;
    }
}
```

### 3.3 å®Œæ•´å¼‚å¸¸å¤„ç†ç­–ç•¥


```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    /**
     * ä¸šåŠ¡å¼‚å¸¸ï¼šç”¨æˆ·èƒ½ç†è§£çš„é”™è¯¯
     * ç¤ºä¾‹ï¼šä½™é¢ä¸è¶³ã€åº“å­˜ä¸è¶³ã€ç”¨æˆ·ä¸å­˜åœ¨
     */
    @ExceptionHandler(BusinessException.class)
    public Result businessException(BusinessException e) {
        log.warn("ä¸šåŠ¡å¼‚å¸¸ï¼š{}", e.getMessage());
        return Result.fail(e.getCode(), e.getMessage());
    }
    
    /**
     * å‚æ•°æ ¡éªŒå¼‚å¸¸ï¼šè¡¨å•éªŒè¯å¤±è´¥
     * ç¤ºä¾‹ï¼šæ‰‹æœºå·æ ¼å¼é”™è¯¯ã€é‚®ç®±æ ¼å¼é”™è¯¯
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result validException(MethodArgumentNotValidException e) {
        String msg = e.getBindingResult()
            .getFieldError()
            .getDefaultMessage();
        log.warn("å‚æ•°æ ¡éªŒå¤±è´¥ï¼š{}", msg);
        return Result.fail(400, msg);
    }
    
    /**
     * æ•°æ®åº“å¼‚å¸¸ï¼šSQLæ‰§è¡Œå¤±è´¥
     * ç¤ºä¾‹ï¼šå”¯ä¸€ç´¢å¼•å†²çªã€å¤–é”®çº¦æŸ
     */
    @ExceptionHandler(DataAccessException.class)
    public Result dbException(DataAccessException e) {
        log.error("æ•°æ®åº“å¼‚å¸¸ï¼š", e);
        
        // åˆ¤æ–­å…·ä½“å¼‚å¸¸ç±»å‹
        if (e.getCause() instanceof SQLIntegrityConstraintViolationException) {
            return Result.fail("æ•°æ®é‡å¤ï¼Œè¯·æ£€æŸ¥åé‡è¯•");
        }
        
        return Result.fail("æ•°æ®æ“ä½œå¤±è´¥");
    }
    
    /**
     * æƒé™å¼‚å¸¸ï¼šæ— è®¿é—®æƒé™
     */
    @ExceptionHandler(AccessDeniedException.class)
    public Result accessDenied(AccessDeniedException e) {
        log.warn("æƒé™ä¸è¶³ï¼š{}", e.getMessage());
        return Result.fail(403, "æ‚¨æ²¡æœ‰è®¿é—®æƒé™");
    }
    
    /**
     * å…œåº•å¼‚å¸¸ï¼šæ‰€æœ‰æœªå¤„ç†çš„å¼‚å¸¸
     */
    @ExceptionHandler(Exception.class)
    public Result handleException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸ï¼š", e);
        return Result.fail("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
    }
}
```

---

## 4. ğŸŒ é”™è¯¯ä¿¡æ¯å›½é™…åŒ–


### 4.1 å›½é™…åŒ–åŸºç¡€é…ç½®


**ğŸ“‹ ä»€ä¹ˆæ˜¯å›½é™…åŒ–**
- **å«ä¹‰**ï¼šæ ¹æ®ç”¨æˆ·è¯­è¨€æ˜¾ç¤ºä¸åŒçš„é”™è¯¯æç¤º
- **åœºæ™¯**ï¼šä¸­æ–‡ç”¨æˆ·çœ‹ä¸­æ–‡æç¤ºï¼Œè‹±æ–‡ç”¨æˆ·çœ‹è‹±æ–‡æç¤º
- **å®ç°**ï¼šSpring MessageSourceæœºåˆ¶

**ğŸ”¸ é…ç½®æ­¥éª¤**

**æ­¥éª¤1ï¸âƒ£ï¼šåˆ›å»ºå›½é™…åŒ–èµ„æºæ–‡ä»¶**
```
resources/
  â”œâ”€â”€ i18n/
  â”‚   â”œâ”€â”€ messages.properties        # é»˜è®¤ï¼ˆä¸­æ–‡ï¼‰
  â”‚   â”œâ”€â”€ messages_en_US.properties  # è‹±æ–‡
  â”‚   â””â”€â”€ messages_zh_CN.properties  # ä¸­æ–‡
```

**æ­¥éª¤2ï¸âƒ£ï¼šç¼–å†™é”™è¯¯æ¶ˆæ¯**
```properties
# messages_zh_CN.properties
user.not.found=ç”¨æˆ·ä¸å­˜åœ¨
user.disabled=ç”¨æˆ·å·²è¢«ç¦ç”¨
balance.insufficient=ä½™é¢ä¸è¶³
system.error=ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•

# messages_en_US.properties
user.not.found=User not found
user.disabled=User is disabled
balance.insufficient=Insufficient balance
system.error=System busy, please try again later
```

**æ­¥éª¤3ï¸âƒ£ï¼šé…ç½®MessageSource**
```java
@Configuration
public class I18nConfig {
    
    @Bean
    public MessageSource messageSource() {
        ResourceBundleMessageSource source = new ResourceBundleMessageSource();
        source.setBasename("i18n/messages");  // æŒ‡å®šèµ„æºæ–‡ä»¶ä½ç½®
        source.setDefaultEncoding("UTF-8");
        return source;
    }
}
```

### 4.2 å¼‚å¸¸å¤„ç†ä¸­ä½¿ç”¨å›½é™…åŒ–


```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    @Autowired
    private MessageSource messageSource;
    
    /**
     * è·å–å›½é™…åŒ–æ¶ˆæ¯
     */
    private String getMessage(String code) {
        // ä»è¯·æ±‚å¤´è·å–è¯­è¨€
        Locale locale = LocaleContextHolder.getLocale();
        return messageSource.getMessage(code, null, locale);
    }
    
    /**
     * ä¸šåŠ¡å¼‚å¸¸å¤„ç†ï¼ˆæ”¯æŒå›½é™…åŒ–ï¼‰
     */
    @ExceptionHandler(BusinessException.class)
    public Result businessException(BusinessException e) {
        // ä½¿ç”¨é”™è¯¯ç è·å–å›½é™…åŒ–æ¶ˆæ¯
        String message = getMessage(e.getCode());
        return Result.fail(message);
    }
}
```

**ğŸ’¡ ä¸šåŠ¡ä»£ç ä½¿ç”¨**
```java
@Service
public class UserServiceImpl {
    
    public User getById(Long id) {
        User user = userMapper.selectById(id);
        
        if (user == null) {
            // æŠ›å‡ºå¼‚å¸¸æ—¶ä½¿ç”¨é”™è¯¯ç 
            throw new BusinessException("user.not.found");
        }
        
        return user;
    }
}
```

---

## 5. ğŸ“ æ—¥å¿—è®°å½•ç­–ç•¥


### 5.1 æ—¥å¿—çº§åˆ«åˆ’åˆ†


**ğŸ”¸ æ—¥å¿—ç­‰çº§è¯´æ˜**

| çº§åˆ« | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|---------|------|
| **ERROR** | `ç³»ç»Ÿé”™è¯¯ã€æ•°æ®åº“å¼‚å¸¸` | `æ•°æ®åº“è¿æ¥å¤±è´¥ã€SQLæ‰§è¡Œé”™è¯¯` |
| **WARN** | `ä¸šåŠ¡å¼‚å¸¸ã€å¯é¢„è§çš„é”™è¯¯` | `ç”¨æˆ·ä¸å­˜åœ¨ã€ä½™é¢ä¸è¶³` |
| **INFO** | `é‡è¦ä¸šåŠ¡æ“ä½œ` | `ç”¨æˆ·ç™»å½•ã€è®¢å•åˆ›å»º` |
| **DEBUG** | `å¼€å‘è°ƒè¯•ä¿¡æ¯` | `æ–¹æ³•å‚æ•°ã€è¿”å›å€¼` |

**ğŸ’¡ æ—¥å¿—è®°å½•ç¤ºä¾‹**
```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Result businessException(BusinessException e) {
        // ä¸šåŠ¡å¼‚å¸¸ç”¨WARNçº§åˆ«ï¼ˆè¿™æ˜¯é¢„æœŸå†…çš„é”™è¯¯ï¼‰
        log.warn("ä¸šåŠ¡å¼‚å¸¸ - é”™è¯¯ç ï¼š{}ï¼Œæ¶ˆæ¯ï¼š{}", e.getCode(), e.getMessage());
        return Result.fail(e.getMessage());
    }
    
    @ExceptionHandler(DataAccessException.class)
    public Result dbException(DataAccessException e) {
        // æ•°æ®åº“å¼‚å¸¸ç”¨ERRORçº§åˆ«ï¼ˆè¿™æ˜¯ç³»ç»Ÿé”™è¯¯ï¼‰
        log.error("æ•°æ®åº“å¼‚å¸¸ï¼š", e);
        return Result.fail("æ•°æ®æ“ä½œå¤±è´¥");
    }
    
    @ExceptionHandler(Exception.class)
    public Result handleException(Exception e, HttpServletRequest request) {
        // è®°å½•è¯¦ç»†çš„é”™è¯¯ä¸Šä¸‹æ–‡
        log.error("ç³»ç»Ÿå¼‚å¸¸ - URLï¼š{}ï¼Œæ–¹æ³•ï¼š{}ï¼Œå‚æ•°ï¼š{}ï¼Œå¼‚å¸¸ï¼š",
            request.getRequestURI(),
            request.getMethod(),
            request.getQueryString(),
            e
        );
        return Result.fail("ç³»ç»Ÿç¹å¿™");
    }
}
```

### 5.2 æ—¥å¿—å¢å¼ºç­–ç•¥


**ğŸ”¸ è®°å½•è¯·æ±‚ä¸Šä¸‹æ–‡**
```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    /**
     * æ„å»ºè¯¦ç»†çš„é”™è¯¯æ—¥å¿—ä¿¡æ¯
     */
    private void logError(Exception e, HttpServletRequest request) {
        // è·å–è¯·æ±‚ä¿¡æ¯
        String url = request.getRequestURI();
        String method = request.getMethod();
        String ip = getClientIp(request);
        String userAgent = request.getHeader("User-Agent");
        
        // è®°å½•å®Œæ•´ä¿¡æ¯
        log.error(
            """
            ç³»ç»Ÿå¼‚å¸¸è¯¦æƒ…ï¼š
            - è¯·æ±‚URLï¼š{}
            - è¯·æ±‚æ–¹æ³•ï¼š{}
            - å®¢æˆ·ç«¯IPï¼š{}
            - User-Agentï¼š{}
            - å¼‚å¸¸ä¿¡æ¯ï¼š
            """,
            url, method, ip, userAgent, e
        );
    }
    
    /**
     * è·å–å®¢æˆ·ç«¯çœŸå®IP
     */
    private String getClientIp(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.isEmpty()) {
            ip = request.getRemoteAddr();
        }
        return ip;
    }
}
```

---

## 6. ğŸ“Š å¼‚å¸¸ç›‘æ§å‘Šè­¦


### 6.1 å¼‚å¸¸ç»Ÿè®¡ä¸ç›‘æ§


**ğŸ“‹ ç›‘æ§æŒ‡æ ‡**
- **å¼‚å¸¸é¢‘ç‡**ï¼šæ¯åˆ†é’Ÿå¼‚å¸¸æ¬¡æ•°
- **å¼‚å¸¸ç±»å‹åˆ†å¸ƒ**ï¼šå“ªç§å¼‚å¸¸æœ€å¤š
- **å¼‚å¸¸è¶‹åŠ¿**ï¼šå¼‚å¸¸æ˜¯å¦åœ¨å¢é•¿
- **å½±å“èŒƒå›´**ï¼šå¤šå°‘ç”¨æˆ·å—å½±å“

**ğŸ”¸ ç®€å•è®¡æ•°å™¨å®ç°**
```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    // ä½¿ç”¨Mapç»Ÿè®¡å¼‚å¸¸æ¬¡æ•°
    private final Map<String, AtomicInteger> exceptionCounter = new ConcurrentHashMap<>();
    
    @ExceptionHandler(Exception.class)
    public Result handleException(Exception e) {
        // ç»Ÿè®¡å¼‚å¸¸æ¬¡æ•°
        String exceptionType = e.getClass().getSimpleName();
        exceptionCounter.computeIfAbsent(exceptionType, k -> new AtomicInteger())
            .incrementAndGet();
        
        // è®°å½•æ—¥å¿—
        log.error("å¼‚å¸¸ç»Ÿè®¡ - ç±»å‹ï¼š{}ï¼Œå½“å‰æ¬¡æ•°ï¼š{}", 
            exceptionType, 
            exceptionCounter.get(exceptionType).get()
        );
        
        return Result.fail("ç³»ç»Ÿç¹å¿™");
    }
    
    /**
     * å®šæ—¶è¾“å‡ºå¼‚å¸¸ç»Ÿè®¡
     */
    @Scheduled(cron = "0 */5 * * * ?")  // æ¯5åˆ†é’Ÿ
    public void printExceptionStats() {
        log.info("å¼‚å¸¸ç»Ÿè®¡æŠ¥å‘Šï¼š{}", exceptionCounter);
    }
}
```

### 6.2 å‘Šè­¦é€šçŸ¥æœºåˆ¶


**ğŸ”¸ å‘Šè­¦è§¦å‘æ¡ä»¶**
```
è§¦å‘å‘Šè­¦çš„åœºæ™¯ï¼š
1ï¸âƒ£ å¼‚å¸¸é¢‘ç‡è¿‡é«˜ï¼š5åˆ†é’Ÿå†…åŒç±»å¼‚å¸¸>100æ¬¡
2ï¸âƒ£ ä¸¥é‡ç³»ç»Ÿé”™è¯¯ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥ã€OOM
3ï¸âƒ£ ä¸šåŠ¡å…³é”®å¼‚å¸¸ï¼šæ”¯ä»˜å¤±è´¥ã€è®¢å•å¼‚å¸¸
4ï¸âƒ£ æ–°å¼‚å¸¸ç±»å‹ï¼šä¹‹å‰æ²¡å‡ºç°è¿‡çš„å¼‚å¸¸
```

**ğŸ’¡ é‚®ä»¶å‘Šè­¦ç¤ºä¾‹**
```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    @Autowired
    private MailService mailService;
    
    // ä¸¥é‡å¼‚å¸¸åˆ—è¡¨
    private static final Set<Class<? extends Exception>> CRITICAL_EXCEPTIONS = Set.of(
        OutOfMemoryError.class,
        StackOverflowError.class,
        DataAccessException.class
    );
    
    @ExceptionHandler(Exception.class)
    public Result handleException(Exception e) {
        // åˆ¤æ–­æ˜¯å¦ä¸ºä¸¥é‡å¼‚å¸¸
        if (isCriticalException(e)) {
            // å‘é€å‘Šè­¦é‚®ä»¶
            sendAlertEmail(e);
        }
        
        log.error("ç³»ç»Ÿå¼‚å¸¸ï¼š", e);
        return Result.fail("ç³»ç»Ÿç¹å¿™");
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºä¸¥é‡å¼‚å¸¸
     */
    private boolean isCriticalException(Exception e) {
        return CRITICAL_EXCEPTIONS.stream()
            .anyMatch(clazz -> clazz.isInstance(e));
    }
    
    /**
     * å‘é€å‘Šè­¦é‚®ä»¶
     */
    private void sendAlertEmail(Exception e) {
        String subject = "ã€ä¸¥é‡ã€‘ç³»ç»Ÿå¼‚å¸¸å‘Šè­¦";
        String content = String.format(
            "å¼‚å¸¸ç±»å‹ï¼š%s\nå¼‚å¸¸ä¿¡æ¯ï¼š%s\nå‘ç”Ÿæ—¶é—´ï¼š%s",
            e.getClass().getName(),
            e.getMessage(),
            LocalDateTime.now()
        );
        
        mailService.sendMail("admin@example.com", subject, content);
    }
}
```

---

## 7. ğŸ“‹ æœ€ä½³å®è·µæ€»ç»“


### 7.1 æ ¸å¿ƒè¦ç‚¹


```
ğŸ”¸ å¼‚å¸¸å¤„ç†ä¸‰åŸåˆ™ï¼š
1ï¸âƒ£ ç»Ÿä¸€ç®¡ç†ï¼šæ‰€æœ‰å¼‚å¸¸åœ¨ä¸€ä¸ªåœ°æ–¹å¤„ç†
2ï¸âƒ£ åˆ†ç±»å¤„ç†ï¼šä¸åŒå¼‚å¸¸ç”¨ä¸åŒç­–ç•¥
3ï¸âƒ£ å‹å¥½æç¤ºï¼šæŠ€æœ¯é”™è¯¯è½¬åŒ–ä¸ºç”¨æˆ·èƒ½æ‡‚çš„è¯

ğŸ”¸ æ—¥å¿—è®°å½•ç­–ç•¥ï¼š
ERRORï¼šç³»ç»Ÿé”™è¯¯ã€æ„æ–™ä¹‹å¤–
WARNï¼šä¸šåŠ¡å¼‚å¸¸ã€æ„æ–™ä¹‹ä¸­
INFOï¼šé‡è¦æ“ä½œ
DEBUGï¼šå¼€å‘è°ƒè¯•

ğŸ”¸ å®‰å…¨åŸåˆ™ï¼š
âœ… ç”¨æˆ·çœ‹åˆ°å‹å¥½æç¤º
âœ… æ—¥å¿—è®°å½•è¯¦ç»†ä¿¡æ¯
âŒ ä¸è¦æš´éœ²æŠ€æœ¯ç»†èŠ‚ç»™ç”¨æˆ·
```

### 7.2 å®æˆ˜æ£€æŸ¥æ¸…å•


| æ£€æŸ¥é¡¹ | è¯´æ˜ | çŠ¶æ€ |
|--------|------|------|
| **å¼‚å¸¸åˆ†ç±»** | `æ˜¯å¦å®šä¹‰äº†ä¸šåŠ¡å¼‚å¸¸ç±»` | `â˜‘ï¸` |
| **å…¨å±€å¤„ç†** | `æ˜¯å¦ä½¿ç”¨@ControllerAdvice` | `â˜‘ï¸` |
| **æ—¥å¿—è®°å½•** | `æ˜¯å¦è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯` | `â˜‘ï¸` |
| **å›½é™…åŒ–** | `æ˜¯å¦æ”¯æŒå¤šè¯­è¨€é”™è¯¯æç¤º` | `â˜‘ï¸` |
| **ç›‘æ§å‘Šè­¦** | `æ˜¯å¦æœ‰å¼‚å¸¸ç»Ÿè®¡å’Œå‘Šè­¦` | `â˜‘ï¸` |
| **å®‰å…¨æ€§** | `æ˜¯å¦é¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²` | `â˜‘ï¸` |

### 7.3 å¸¸è§é—®é¢˜è§£ç­”


**â“ Q1ï¼šä»€ä¹ˆæ—¶å€™æŠ›BusinessExceptionï¼Œä»€ä¹ˆæ—¶å€™æŠ›RuntimeExceptionï¼Ÿ**
```
âœ… BusinessExceptionï¼šç”¨æˆ·æ“ä½œé”™è¯¯ã€ä¸šåŠ¡è§„åˆ™ä¸æ»¡è¶³
   ç¤ºä¾‹ï¼šä½™é¢ä¸è¶³ã€åº“å­˜ä¸å¤Ÿã€ç”¨æˆ·ä¸å­˜åœ¨
   
âœ… RuntimeExceptionï¼šç³»ç»Ÿçº§é”™è¯¯ã€æ„æ–™ä¹‹å¤–çš„å¼‚å¸¸
   ç¤ºä¾‹ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥ã€æ–‡ä»¶è¯»å–å¤±è´¥
```

**â“ Q2ï¼šå¼‚å¸¸ä¿¡æ¯åº”è¯¥å¤šè¯¦ç»†ï¼Ÿ**
```
å‰ç«¯ç”¨æˆ·ï¼šç®€æ´å‹å¥½çš„æç¤ºï¼ˆä½™é¢ä¸è¶³ï¼‰
æ—¥å¿—è®°å½•ï¼šè¯¦ç»†çš„æŠ€æœ¯ä¿¡æ¯ï¼ˆåŒ…å«å †æ ˆï¼‰
ç›‘æ§å‘Šè­¦ï¼šå…³é”®ä¸Šä¸‹æ–‡ï¼ˆURLã€IPã€å‚æ•°ï¼‰
```

**â“ Q3ï¼šå¦‚ä½•é¿å…å¼‚å¸¸å¤„ç†æ€§èƒ½é—®é¢˜ï¼Ÿ**
```
âœ… ä¸è¦ç”¨å¼‚å¸¸åšæµç¨‹æ§åˆ¶
âœ… é¿å…åœ¨å¾ªç¯ä¸­æŠ›å¼‚å¸¸
âœ… åˆç†è®¾ç½®æ—¥å¿—çº§åˆ«
âœ… å¼‚æ­¥å¤„ç†å‘Šè­¦é€šçŸ¥
```

**ğŸ§  è®°å¿†å£è¯€**
```
å…¨å±€å¼‚å¸¸ç»Ÿä¸€ç®¡ï¼ŒControllerAdviceæ¥æŠŠå…³
ä¸šåŠ¡å¼‚å¸¸ç”¨æˆ·æ‡‚ï¼Œç³»ç»Ÿé”™è¯¯è®°æ—¥å¿—è¯¦
åˆ†ç±»å¤„ç†æœ‰ç­–ç•¥ï¼Œå›½é™…åŒ–æ”¯æŒä¸èƒ½å¿˜
ç›‘æ§å‘Šè­¦è¦åŠæ—¶ï¼Œå®‰å…¨ç¬¬ä¸€è®°å¿ƒä¸Š
```