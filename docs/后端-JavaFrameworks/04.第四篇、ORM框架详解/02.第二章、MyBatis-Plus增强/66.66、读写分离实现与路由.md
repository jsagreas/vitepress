---
title: 66ã€è¯»å†™åˆ†ç¦»å®ç°ä¸è·¯ç”±
---
## ğŸ“š ç›®å½•

1. [è¯»å†™åˆ†ç¦»åŸºæœ¬æ¦‚å¿µ](#1-è¯»å†™åˆ†ç¦»åŸºæœ¬æ¦‚å¿µ)
2. [@DSæ³¨è§£åŠ¨æ€åˆ‡æ¢](#2-DSæ³¨è§£åŠ¨æ€åˆ‡æ¢)
3. [äº‹åŠ¡å†…è¯»å†™åˆ†ç¦»å¤„ç†](#3-äº‹åŠ¡å†…è¯»å†™åˆ†ç¦»å¤„ç†)
4. [æ•°æ®å»¶è¿Ÿä¸€è‡´æ€§é—®é¢˜](#4-æ•°æ®å»¶è¿Ÿä¸€è‡´æ€§é—®é¢˜)
5. [å¼ºåˆ¶èµ°ä¸»åº“åœºæ™¯](#5-å¼ºåˆ¶èµ°ä¸»åº“åœºæ™¯)
6. [è·¯ç”±ç­–ç•¥é…ç½®](#6-è·¯ç”±ç­–ç•¥é…ç½®)
7. [è´Ÿè½½å‡è¡¡ç®—æ³•](#7-è´Ÿè½½å‡è¡¡ç®—æ³•)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è¯»å†™åˆ†ç¦»åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è¯»å†™åˆ†ç¦»


**é€šä¿—ç†è§£**ï¼šå°±åƒé“¶è¡Œçš„æŸœå°åˆ†å·¥ï¼Œå­˜é’±å–é’±å»ä¸åŒçª—å£åŠç†

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆä¸€ä¸ªæ•°æ®åº“å¹²æ‰€æœ‰æ´»ï¼‰ï¼š
ç”¨æˆ· â†’ æ•°æ®åº“ï¼ˆåˆè¯»åˆå†™ï¼Œå‹åŠ›å¤§ï¼‰

è¯»å†™åˆ†ç¦»ï¼ˆä¸“ä¸šåˆ†å·¥ï¼‰ï¼š
ç”¨æˆ·å†™æ•°æ® â†’ ä¸»åº“ï¼ˆMasterï¼Œä¸“é—¨è´Ÿè´£å†™ï¼‰
ç”¨æˆ·è¯»æ•°æ® â†’ ä»åº“ï¼ˆSlaveï¼Œä¸“é—¨è´Ÿè´£è¯»ï¼‰
```

**æ ¸å¿ƒæ€æƒ³**ï¼š
- ğŸ”¸ **ä¸»åº“ï¼ˆMasterï¼‰**ï¼šè´Ÿè´£å†™æ“ä½œï¼ˆå¢åˆ æ”¹ï¼‰ï¼Œæ•°æ®çš„æƒå¨æ¥æº
- ğŸ”¸ **ä»åº“ï¼ˆSlaveï¼‰**ï¼šè´Ÿè´£è¯»æ“ä½œï¼ˆæŸ¥è¯¢ï¼‰ï¼Œåˆ†æ‹…è¯»å‹åŠ›
- ğŸ”¸ **æ•°æ®åŒæ­¥**ï¼šä¸»åº“çš„æ•°æ®ä¼šè‡ªåŠ¨å¤åˆ¶åˆ°ä»åº“

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è¯»å†™åˆ†ç¦»


**å®é™…åœºæ™¯ä¸¾ä¾‹**ï¼š

å‡è®¾ä½ å¼€å‘ä¸€ä¸ªç”µå•†ç½‘ç«™ï¼š
- ğŸ“Š **è¯»æ“ä½œ**ï¼šç”¨æˆ·æµè§ˆå•†å“ã€æŸ¥çœ‹è®¢å• â†’ å æ¯”90%
- âœï¸ **å†™æ“ä½œ**ï¼šä¸‹å•ã€æ”¯ä»˜ã€ä¿®æ”¹ä¿¡æ¯ â†’ å æ¯”10%

```
é—®é¢˜åˆ†æï¼š
å•ä¸ªæ•°æ®åº“ï¼š
  100ä¸ªè¯·æ±‚ â†’ 1ä¸ªæ•°æ®åº“å¤„ç† â†’ å¯èƒ½å¡é¡¿
  
è¯»å†™åˆ†ç¦»ï¼š
  90ä¸ªè¯»è¯·æ±‚ â†’ 3ä¸ªä»åº“åˆ†æ‹… â†’ æ¯ä¸ªåº“å¤„ç†30ä¸ª
  10ä¸ªå†™è¯·æ±‚ â†’ 1ä¸ªä¸»åº“å¤„ç† â†’ è½»æ¾åº”å¯¹
  
ç»“æœï¼šæ•´ä½“æ€§èƒ½æå‡3-4å€ï¼
```

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âš¡ **æ€§èƒ½æå‡**ï¼šè¯»å†™åˆ†å¼€ï¼Œäº’ä¸å¹²æ‰°
- ğŸ”„ **è´Ÿè½½åˆ†æ‹…**ï¼šå¤šä¸ªä»åº“åˆ†æ‹…è¯»å‹åŠ›
- ğŸ›¡ï¸ **é«˜å¯ç”¨**ï¼šä¸»åº“æŒ‚äº†è¿˜æœ‰ä»åº“èƒ½è¯»æ•°æ®

### 1.3 MyBatis-Plusçš„è¯»å†™åˆ†ç¦»æ¶æ„


**æ¶æ„ç¤ºæ„å›¾**ï¼š

```
åº”ç”¨å±‚
   â†“
@DSæ³¨è§£æ ‡è®°
   â†“
åŠ¨æ€æ•°æ®æºè·¯ç”±
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸»åº“   â”‚  ä»åº“1  â”‚  ä»åº“2  â”‚
â”‚ Master  â”‚ Slave1  â”‚ Slave2  â”‚
â”‚  å†™æ“ä½œ â”‚  è¯»æ“ä½œ â”‚  è¯»æ“ä½œ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“          â†‘         â†‘
   æ•°æ®åŒæ­¥   æ•°æ®åŒæ­¥
```

**å·¥ä½œæµç¨‹ç®€è¿°**ï¼š
1. ç¨‹åºè¿è¡Œæ—¶ï¼Œæ ¹æ®`@DS`æ³¨è§£åˆ¤æ–­ç”¨å“ªä¸ªåº“
2. å†™æ“ä½œè‡ªåŠ¨è·¯ç”±åˆ°ä¸»åº“
3. è¯»æ“ä½œæŒ‰ç…§è´Ÿè½½å‡è¡¡ç­–ç•¥åˆ†é…åˆ°ä»åº“
4. ä¸»åº“æ•°æ®å˜åŒ–ä¼šåŒæ­¥åˆ°ä»åº“

---

## 2. ğŸ”„ @DSæ³¨è§£åŠ¨æ€åˆ‡æ¢


### 2.1 @DSæ³¨è§£æ˜¯ä»€ä¹ˆ


**ç®€å•ç†è§£**ï¼šå°±åƒç»™æ–¹æ³•è´´ä¸ªæ ‡ç­¾ï¼Œå‘Šè¯‰ç¨‹åº"è¿™ä¸ªæ–¹æ³•è¦ç”¨å“ªä¸ªæ•°æ®åº“"

```java
// æ²¡æœ‰@DSæ³¨è§£ï¼šç”¨é»˜è®¤æ•°æ®åº“
public User findById(Long id) {
    return userMapper.selectById(id);
}

// æœ‰@DSæ³¨è§£ï¼šæ˜ç¡®æŒ‡å®šç”¨ä»åº“
@DS("slave")  // ç›¸å½“äºè´´ä¸ª"ç”¨ä»åº“"çš„æ ‡ç­¾
public User findById(Long id) {
    return userMapper.selectById(id);
}
```

### 2.2 åŸºæœ¬ä½¿ç”¨æ–¹å¼


**æ–¹å¼ä¸€ï¼šåœ¨Serviceæ–¹æ³•ä¸Šä½¿ç”¨** ğŸŸ¢å…¥é—¨

```java
@Service
public class UserService {
    
    // å†™æ“ä½œï¼šç”¨ä¸»åº“
    @DS("master")
    public void saveUser(User user) {
        userMapper.insert(user);
    }
    
    // è¯»æ“ä½œï¼šç”¨ä»åº“
    @DS("slave")
    public User getUser(Long id) {
        return userMapper.selectById(id);
    }
}
```

**æ–¹å¼äºŒï¼šåœ¨Serviceç±»ä¸Šä½¿ç”¨** ğŸŸ¡è¿›é˜¶

```java
// æ•´ä¸ªServiceé»˜è®¤éƒ½ç”¨ä»åº“
@DS("slave")
@Service
public class UserQueryService {
    
    // è¿™ä¸ªæ–¹æ³•ç”¨ä»åº“ï¼ˆç»§æ‰¿ç±»ä¸Šçš„@DSï¼‰
    public List<User> listAll() {
        return userMapper.selectList(null);
    }
    
    // ç‰¹æ®Šæƒ…å†µï¼šè¿™ä¸ªæ–¹æ³•å¼ºåˆ¶ç”¨ä¸»åº“ï¼ˆè¦†ç›–ç±»ä¸Šçš„@DSï¼‰
    @DS("master")
    public User getRealTimeUser(Long id) {
        return userMapper.selectById(id);
    }
}
```

**æ–¹å¼ä¸‰ï¼šåœ¨Mapperæ¥å£ä¸Šä½¿ç”¨** ğŸ”´é«˜çº§

```java
// æŸ¥è¯¢ä¸“ç”¨Mapperï¼Œéƒ½ç”¨ä»åº“
@DS("slave")
public interface UserQueryMapper extends BaseMapper<User> {
    // æ‰€æœ‰æ–¹æ³•éƒ½è‡ªåŠ¨ç”¨ä»åº“
}

// å†™å…¥ä¸“ç”¨Mapperï¼Œéƒ½ç”¨ä¸»åº“
@DS("master")
public interface UserWriteMapper extends BaseMapper<User> {
    // æ‰€æœ‰æ–¹æ³•éƒ½è‡ªåŠ¨ç”¨ä¸»åº“
}
```

### 2.3 é…ç½®å¤šä¸ªæ•°æ®æº


**application.ymlé…ç½®**ï¼š

```yaml
spring:
  datasource:
    dynamic:
      primary: master  # é»˜è®¤æ•°æ®æº
      strict: false    # ä¸¥æ ¼æ¨¡å¼ï¼šæ‰¾ä¸åˆ°æ•°æ®æºæ˜¯å¦æŠ¥é”™
      datasource:
        # ä¸»åº“é…ç½®
        master:
          url: jdbc:mysql://localhost:3306/db_master
          username: root
          password: 123456
          driver-class-name: com.mysql.cj.jdbc.Driver
        
        # ä»åº“1é…ç½®
        slave1:
          url: jdbc:mysql://localhost:3307/db_slave1
          username: root
          password: 123456
          driver-class-name: com.mysql.cj.jdbc.Driver
        
        # ä»åº“2é…ç½®
        slave2:
          url: jdbc:mysql://localhost:3308/db_slave2
          username: root
          password: 123456
          driver-class-name: com.mysql.cj.jdbc.Driver
```

**é…ç½®è¯´æ˜**ï¼š
- `primary`ï¼šæ²¡æœ‰@DSæ³¨è§£æ—¶ç”¨å“ªä¸ªåº“ï¼ˆé»˜è®¤åº“ï¼‰
- `strict`ï¼šä¸¥æ ¼æ¨¡å¼ï¼Œ@DSæŒ‡å®šçš„åº“ä¸å­˜åœ¨æ—¶æ˜¯å¦æŠ¥é”™
- `datasource`ï¼šå…·ä½“çš„æ•°æ®åº“é…ç½®ï¼Œåå­—éšä¾¿èµ·

### 2.4 @DSçš„ä¼˜å…ˆçº§è§„åˆ™


**ä¼˜å…ˆçº§ä»é«˜åˆ°ä½**ï¼š

```
æ–¹æ³•ä¸Šçš„@DS  >  ç±»ä¸Šçš„@DS  >  é»˜è®¤æ•°æ®æº

å®ä¾‹è¯´æ˜ï¼š
@DS("slave")              â† ç±»çº§åˆ«ï¼šé»˜è®¤ç”¨ä»åº“
@Service
public class UserService {
    
    public User getUser() {
        // ç”¨slaveï¼ˆç±»ä¸Šçš„ï¼‰
    }
    
    @DS("master")         â† æ–¹æ³•çº§åˆ«ï¼šè¦†ç›–ç±»ä¸Šçš„
    public void saveUser() {
        // ç”¨masterï¼ˆæ–¹æ³•ä¸Šçš„ä¼˜å…ˆï¼‰
    }
}
```

---

## 3. ğŸ” äº‹åŠ¡å†…è¯»å†™åˆ†ç¦»å¤„ç†


### 3.1 äº‹åŠ¡å†…çš„ç‰¹æ®Šæƒ…å†µ


**æ ¸å¿ƒé—®é¢˜**ï¼šäº‹åŠ¡å¼€å¯åï¼Œæ•´ä¸ªäº‹åŠ¡å¿…é¡»ç”¨åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥

**ä¸ºä»€ä¹ˆï¼Ÿ** æƒ³è±¡ä¸€ä¸‹ï¼š
```
é”™è¯¯ç¤ºèŒƒï¼š
1. å¼€å¯äº‹åŠ¡
2. ä¸»åº“ï¼šæ’å…¥æ•°æ® âœ“
3. ä»åº“ï¼šæŸ¥è¯¢æ•°æ® âœ—ï¼ˆä»åº“è¿˜æ²¡åŒæ­¥ï¼ŒæŸ¥ä¸åˆ°ï¼ï¼‰
4. æäº¤äº‹åŠ¡ï¼ˆæ··ä¹±äº†ï¼‰

æ­£ç¡®åšæ³•ï¼š
1. å¼€å¯äº‹åŠ¡
2. ä¸»åº“ï¼šæ’å…¥æ•°æ® âœ“
3. ä¸»åº“ï¼šæŸ¥è¯¢æ•°æ® âœ“ï¼ˆèƒ½æŸ¥åˆ°åˆšæ’å…¥çš„ï¼‰
4. æäº¤äº‹åŠ¡ âœ“
```

### 3.2 @Transactionalä¸@DSçš„é…åˆ


**è§„åˆ™ï¼šäº‹åŠ¡å¼€å¯åï¼Œ@DSä¼šå¤±æ•ˆï¼Œç»Ÿä¸€ç”¨äº‹åŠ¡çš„æ•°æ®æº**

```java
@Service
public class OrderService {
    
    @Transactional  // å¼€å¯äº‹åŠ¡
    @DS("master")   // æŒ‡å®šç”¨ä¸»åº“
    public void createOrder(Order order) {
        // 1. æ’å…¥è®¢å•ï¼ˆä¸»åº“ï¼‰
        orderMapper.insert(order);
        
        // 2. æ‰£å‡åº“å­˜ï¼ˆå³ä½¿è¿™é‡Œæœ‰@DS("slave")ï¼Œä¹Ÿä¼šç”¨ä¸»åº“ï¼‰
        @DS("slave")  // â† è¿™ä¸ªæ³¨è§£åœ¨äº‹åŠ¡å†…ä¼šè¢«å¿½ç•¥ï¼
        inventoryService.reduceStock(order.getProductId());
        
        // 3. æŸ¥è¯¢è®¢å•ï¼ˆä¸»åº“ï¼Œä¿è¯èƒ½æŸ¥åˆ°åˆšæ’å…¥çš„ï¼‰
        Order saved = orderMapper.selectById(order.getId());
    }
}
```

**å…³é”®ç†è§£**ï¼š
- âœ… **äº‹åŠ¡å†…ç»Ÿä¸€æ•°æ®æº**ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§
- âŒ **äº‹åŠ¡å†…@DSå¤±æ•ˆ**ï¼šé˜²æ­¢åˆ‡æ¢æ•°æ®æºå¯¼è‡´é—®é¢˜
- ğŸ’¡ **æœ€ä½³å®è·µ**ï¼šäº‹åŠ¡æ–¹æ³•ä¸Šæ˜ç¡®æŒ‡å®š`@DS("master")`

### 3.3 åµŒå¥—äº‹åŠ¡çš„å¤„ç†


**åœºæ™¯ï¼šServiceæ–¹æ³•äº’ç›¸è°ƒç”¨**

```java
@Service
public class OuterService {
    
    @Autowired
    private InnerService innerService;
    
    @Transactional
    @DS("master")
    public void outerMethod() {
        // å¤–å±‚äº‹åŠ¡ç”¨master
        
        // è°ƒç”¨å†…å±‚æ–¹æ³•
        innerService.innerMethod();  // ä¼šè·Ÿéšå¤–å±‚äº‹åŠ¡ç”¨master
    }
}

@Service
public class InnerService {
    
    @Transactional
    @DS("slave")  // â† è¿™ä¸ªæ³¨è§£ä¸ä¼šç”Ÿæ•ˆï¼
    public void innerMethod() {
        // å®é™…è¿˜æ˜¯ç”¨masterï¼ˆè·Ÿéšå¤–å±‚äº‹åŠ¡ï¼‰
    }
}
```

**é‡ç‚¹æç¤º**ï¼š
- ğŸ”¸ Springäº‹åŠ¡ä¼ æ’­æœºåˆ¶ï¼šå†…å±‚äº‹åŠ¡ä¼šåŠ å…¥å¤–å±‚äº‹åŠ¡
- ğŸ”¸ åŠ å…¥å¤–å±‚äº‹åŠ¡åï¼Œæ•°æ®æºè·Ÿéšå¤–å±‚
- ğŸ”¸ è§£å†³åŠæ³•ï¼šå¦‚æœå†…å±‚å¿…é¡»ç”¨ä¸åŒåº“ï¼Œéœ€è¦ç”¨`REQUIRES_NEW`ä¼ æ’­çº§åˆ«

---

## 4. â±ï¸ æ•°æ®å»¶è¿Ÿä¸€è‡´æ€§é—®é¢˜


### 4.1 ä»€ä¹ˆæ˜¯ä¸»ä»å»¶è¿Ÿ


**é€šä¿—è§£é‡Š**ï¼šä¸»åº“æ”¹äº†æ•°æ®ï¼Œä»åº“è¦è¿‡ä¸€ä¼šå„¿æ‰èƒ½åŒæ­¥è¿‡æ¥

**ç°å®æ¯”å–»**ï¼š
```
ä¸»åº“ = æ€»å…¬å¸å‘å¸ƒé€šçŸ¥
ä»åº“ = åˆ†å…¬å¸æ¥æ”¶é€šçŸ¥

æ€»å…¬å¸ï¼ˆä¸»åº“ï¼‰ï¼š10:00 å‘å¸ƒæ–°é€šçŸ¥
åˆ†å…¬å¸Aï¼ˆä»åº“1ï¼‰ï¼š10:00:02 æ”¶åˆ°ï¼ˆå»¶è¿Ÿ2ç§’ï¼‰
åˆ†å…¬å¸Bï¼ˆä»åº“2ï¼‰ï¼š10:00:05 æ”¶åˆ°ï¼ˆå»¶è¿Ÿ5ç§’ï¼‰
```

**æŠ€æœ¯åŸç†**ï¼š

```
æ—¶é—´è½´ç¤ºæ„ï¼š
10:00:00  ä¸»åº“ï¼šUPDATE user SET name='å¼ ä¸‰' WHERE id=1
10:00:00  ä¸»åº“ï¼šè®°å½•binlogæ—¥å¿—
10:00:01  ä»åº“ï¼šè¯»å–binlog
10:00:02  ä»åº“ï¼šæ‰§è¡ŒUPDATE â† å»¶è¿Ÿ2ç§’ï¼
```

### 4.2 å»¶è¿Ÿå¸¦æ¥çš„é—®é¢˜


**å…¸å‹åœºæ™¯ä¸¾ä¾‹**ï¼š

```java
// ç”¨æˆ·ä¿®æ”¹æ˜µç§°
@DS("master")
public void updateNickname(Long userId, String newName) {
    userMapper.updateById(user);  // ä¸»åº“æ”¹äº†
}

// ç«‹å³æŸ¥è¯¢æ˜¾ç¤º
@DS("slave")
public User getUserInfo(Long userId) {
    return userMapper.selectById(userId);  // ä»åº“è¿˜æ²¡åŒæ­¥ï¼ŒæŸ¥åˆ°çš„æ˜¯æ—§æ•°æ®ï¼
}

ç”¨æˆ·ä½“éªŒï¼š
ç”¨æˆ·ï¼šæˆ‘æŠŠæ˜µç§°æ”¹æˆ"å¼ ä¸‰"äº†
åˆ·æ–°é¡µé¢ï¼šè¿˜æ˜¯æ˜¾ç¤ºæ—§æ˜µç§°"æå››" â† ç”¨æˆ·æ‡µäº†ï¼
```

**é—®é¢˜æ€»ç»“**ï¼š
| æ—¶é—´ç‚¹ | æ“ä½œ | ä¸»åº“æ•°æ® | ä»åº“æ•°æ® | ç”¨æˆ·çœ‹åˆ° |
|--------|------|----------|----------|----------|
| T1 | ä¿®æ”¹æ˜µç§° | å¼ ä¸‰ | æå›› | - |
| T2 | æŸ¥è¯¢æ˜¾ç¤º | å¼ ä¸‰ | æå›› | âŒæå››ï¼ˆé”™è¯¯ï¼‰ |
| T3 | å»¶è¿ŸåŒæ­¥å | å¼ ä¸‰ | å¼ ä¸‰ | âœ…å¼ ä¸‰ï¼ˆæ­£ç¡®ï¼‰ |

### 4.3 è§£å†³å»¶è¿Ÿé—®é¢˜çš„ç­–ç•¥


**ç­–ç•¥ä¸€ï¼šå†™åè¯»å¼ºåˆ¶èµ°ä¸»åº“** â­æœ€å¸¸ç”¨

```java
@Service
public class UserService {
    
    // ä¿®æ”¹æ“ä½œ
    @DS("master")
    public void updateUser(User user) {
        userMapper.updateById(user);
        // ä¿®æ”¹åç«‹å³æŸ¥è¯¢ï¼Œå¼ºåˆ¶èµ°ä¸»åº“
        User latest = this.getUserFromMaster(user.getId());
    }
    
    // å¼ºåˆ¶ä»ä¸»åº“è¯»
    @DS("master")
    public User getUserFromMaster(Long id) {
        return userMapper.selectById(id);
    }
    
    // æ™®é€šæŸ¥è¯¢èµ°ä»åº“
    @DS("slave")
    public User getUser(Long id) {
        return userMapper.selectById(id);
    }
}
```

**ç­–ç•¥äºŒï¼šä½¿ç”¨ç¼“å­˜è¿‡æ¸¡** â­é«˜æ€§èƒ½æ–¹æ¡ˆ

```java
@Service
public class UserService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    @DS("master")
    public void updateUser(User user) {
        // 1. æ›´æ–°ä¸»åº“
        userMapper.updateById(user);
        
        // 2. åŒæ—¶æ›´æ–°ç¼“å­˜ï¼ˆä¿è¯ç«‹å³å¯è§ï¼‰
        String key = "user:" + user.getId();
        redisTemplate.opsForValue().set(key, user, 10, TimeUnit.SECONDS);
    }
    
    public User getUser(Long id) {
        String key = "user:" + id;
        
        // 1. å…ˆæŸ¥ç¼“å­˜
        User user = (User) redisTemplate.opsForValue().get(key);
        if (user != null) {
            return user;  // ç¼“å­˜æœ‰ï¼Œç›´æ¥è¿”å›
        }
        
        // 2. ç¼“å­˜æ²¡æœ‰ï¼ŒæŸ¥ä»åº“
        return getUserFromSlave(id);
    }
}
```

**ç­–ç•¥ä¸‰ï¼šå»¶è¿ŸæŸ¥è¯¢** ğŸŸ¡é€‚ç”¨ç‰¹å®šåœºæ™¯

```java
// é€‚åˆå¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯
@DS("master")
public void updateUserAsync(User user) {
    userMapper.updateById(user);
    
    // å»¶è¿Ÿ1ç§’åæŸ¥è¯¢ï¼ˆç­‰ä»åº“åŒæ­¥ï¼‰
    CompletableFuture.runAsync(() -> {
        try {
            Thread.sleep(1000);  // ç­‰å¾…åŒæ­¥
            User latest = getUserFromSlave(user.getId());
            // æ¨é€ç»™å‰ç«¯...
        } catch (Exception e) {
            // å¤„ç†å¼‚å¸¸
        }
    });
}
```

### 4.4 å¦‚ä½•é€‰æ‹©è§£å†³æ–¹æ¡ˆ


**å†³ç­–æ ‘**ï¼š

```
æ˜¯å¦è¦æ±‚å¼ºä¸€è‡´æ€§ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ å¼ºåˆ¶èµ°ä¸»åº“ âœ“
  â””â”€ å¦ â†’ å¯ä»¥æ¥å—å»¶è¿Ÿï¼Ÿ
        â”œâ”€ èƒ½æ¥å— â†’ æ­£å¸¸èµ°ä»åº“ï¼Œæç¤º"æ•°æ®æ›´æ–°ä¸­"
        â””â”€ ä¸èƒ½æ¥å— â†’ ä½¿ç”¨ç¼“å­˜æ–¹æ¡ˆ âœ“

æ€§èƒ½è¦æ±‚é«˜ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ ç¼“å­˜æ–¹æ¡ˆ âœ“
  â””â”€ å¦ â†’ ä¸»åº“æ–¹æ¡ˆ âœ“
```

---

## 5. ğŸ¯ å¼ºåˆ¶èµ°ä¸»åº“åœºæ™¯


### 5.1 å“ªäº›æƒ…å†µå¿…é¡»èµ°ä¸»åº“


**åœºæ™¯æ¸…å•**ï¼š

**1ï¸âƒ£ å†™åç«‹å³è¯»** ğŸ”¥é«˜é¢‘åœºæ™¯

```java
// å…¸å‹ä¾‹å­ï¼šç”¨æˆ·æ³¨å†Œåç«‹å³ç™»å½•
@DS("master")
@Transactional
public User registerAndLogin(RegisterDTO dto) {
    // 1. æ’å…¥ç”¨æˆ·
    User user = new User();
    user.setUsername(dto.getUsername());
    userMapper.insert(user);
    
    // 2. ç«‹å³æŸ¥è¯¢ï¼ˆå¿…é¡»ä¸»åº“ï¼Œä»åº“å¯èƒ½è¿˜æ²¡åŒæ­¥ï¼‰
    return userMapper.selectById(user.getId());
}
```

**2ï¸âƒ£ å…³é”®ä¸šåŠ¡æŸ¥è¯¢** ğŸ’°æ¶‰åŠé‡‘é¢ã€åº“å­˜

```java
// è®¢å•æ”¯ä»˜ï¼šå¿…é¡»æŸ¥æœ€æ–°åº“å­˜
@DS("master")
public boolean checkStock(Long productId, Integer quantity) {
    Product product = productMapper.selectById(productId);
    return product.getStock() >= quantity;  // å¿…é¡»å‡†ç¡®ï¼
}

// è´¦æˆ·ä½™é¢ï¼šå¿…é¡»æŸ¥æœ€æ–°ä½™é¢
@DS("master")
public BigDecimal getBalance(Long userId) {
    Account account = accountMapper.selectById(userId);
    return account.getBalance();  // ä¸èƒ½æœ‰å»¶è¿Ÿï¼
}
```

**3ï¸âƒ£ äº‹åŠ¡å†…çš„æŸ¥è¯¢** ğŸ”ä¸€è‡´æ€§ä¿è¯

```java
@Transactional
@DS("master")
public void processOrder(Order order) {
    // äº‹åŠ¡å†…æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»ä¸»åº“
    orderMapper.insert(order);
    
    // æŸ¥è¯¢ä¹Ÿå¿…é¡»ä¸»åº“ï¼ˆä¿è¯æŸ¥åˆ°åˆšæ’å…¥çš„ï¼‰
    Order saved = orderMapper.selectById(order.getId());
    
    // æ›´æ–°åº“å­˜
    inventoryMapper.reduceStock(order.getProductId(), order.getQuantity());
}
```

**4ï¸âƒ£ å®æ—¶æ€§è¦æ±‚é«˜çš„æŸ¥è¯¢** â°

```java
// å®æ—¶æ’è¡Œæ¦œ
@DS("master")
public List<User> getRealTimeRanking() {
    return userMapper.selectList(
        Wrappers.<User>lambdaQuery()
            .orderByDesc(User::getScore)
            .last("LIMIT 10")
    );
}

// å®æ—¶åœ¨çº¿äººæ•°
@DS("master")
public Long getOnlineCount() {
    return userMapper.selectCount(
        Wrappers.<User>lambdaQuery()
            .eq(User::getOnlineStatus, 1)
    );
}
```

### 5.2 å¼ºåˆ¶èµ°ä¸»åº“çš„å®ç°æ–¹å¼


**æ–¹å¼ä¸€ï¼šç›´æ¥æŒ‡å®š@DS("master")** ğŸŸ¢æ¨è

```java
@DS("master")
public User getLatestUser(Long id) {
    return userMapper.selectById(id);
}
```

**æ–¹å¼äºŒï¼šç¼–ç¨‹å¼åˆ‡æ¢æ•°æ®æº** ğŸŸ¡çµæ´»

```java
public User getUserDynamic(Long id, boolean forcemaster) {
    if (forceMaster) {
        // æ‰‹åŠ¨åˆ‡æ¢åˆ°ä¸»åº“
        DynamicDataSourceContextHolder.push("master");
        try {
            return userMapper.selectById(id);
        } finally {
            // è®°å¾—æ¢å¤
            DynamicDataSourceContextHolder.poll();
        }
    } else {
        // èµ°ä»åº“
        return userMapper.selectById(id);
    }
}
```

**æ–¹å¼ä¸‰ï¼šé€šè¿‡AOPæ‹¦æˆª** ğŸ”´é«˜çº§

```java
// è‡ªå®šä¹‰æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface ForceMaster {
}

// AOPæ‹¦æˆªå™¨
@Aspect
@Component
public class ForceMasterAspect {
    
    @Around("@annotation(forceMaster)")
    public Object around(ProceedingJoinPoint point, ForceMaster forceMaster) {
        DynamicDataSourceContextHolder.push("master");
        try {
            return point.proceed();
        } finally {
            DynamicDataSourceContextHolder.poll();
        }
    }
}

// ä½¿ç”¨
@ForceMaster
public User getUser(Long id) {
    return userMapper.selectById(id);
}
```

---

## 6. ğŸ›£ï¸ è·¯ç”±ç­–ç•¥é…ç½®


### 6.1 ä»€ä¹ˆæ˜¯è·¯ç”±ç­–ç•¥


**ç®€å•ç†è§£**ï¼šå°±æ˜¯å†³å®š"è¿™æ¬¡æŸ¥è¯¢è¯¥ç”¨å“ªä¸ªä»åº“"çš„è§„åˆ™

**æ¯”å–»è¯´æ˜**ï¼š
```
ä½ æœ‰3ä¸ªä»åº“ï¼ˆslave1ã€slave2ã€slave3ï¼‰
æ¥äº†ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚
è·¯ç”±ç­–ç•¥ = äº¤é€šæŒ‡æŒ¥å‘˜ï¼Œå†³å®šæŠŠè¯·æ±‚åˆ†é…ç»™è°

ç­–ç•¥Aï¼ˆè½®è¯¢ï¼‰ï¼š1â†’2â†’3â†’1â†’2â†’3... ï¼ˆæ’é˜Ÿè½®æµï¼‰
ç­–ç•¥Bï¼ˆéšæœºï¼‰ï¼šéšæœºé€‰ä¸€ä¸ª
ç­–ç•¥Cï¼ˆæƒé‡ï¼‰ï¼šæ€§èƒ½å¥½çš„å¤šåˆ†é…ç‚¹
```

### 6.2 å†…ç½®è·¯ç”±ç­–ç•¥


**ç­–ç•¥ä¸€ï¼šè½®è¯¢ç­–ç•¥ï¼ˆRound Robinï¼‰** ğŸ”„æœ€å…¬å¹³

```yaml
spring:
  datasource:
    dynamic:
      strategy: com.baomidou.dynamic.datasource.strategy.LoadBalanceDynamicDataSourceStrategy
      datasource:
        master:
          url: jdbc:mysql://localhost:3306/db_master
        slave1:
          url: jdbc:mysql://localhost:3307/db_slave1
        slave2:
          url: jdbc:mysql://localhost:3308/db_slave2
```

**å·¥ä½œåŸç†**ï¼š
```
è¯·æ±‚1 â†’ slave1
è¯·æ±‚2 â†’ slave2
è¯·æ±‚3 â†’ slave1
è¯·æ±‚4 â†’ slave2
...å¾ªç¯å¾€å¤
```

**ç­–ç•¥äºŒï¼šéšæœºç­–ç•¥ï¼ˆRandomï¼‰** ğŸ²ç®€å•

```yaml
spring:
  datasource:
    dynamic:
      strategy: com.baomidou.dynamic.datasource.strategy.RandomDynamicDataSourceStrategy
```

**å·¥ä½œåŸç†**ï¼š
```
æ¯æ¬¡è¯·æ±‚éšæœºé€‰æ‹©ä¸€ä¸ªä»åº“
é€‚åˆä»åº“æ€§èƒ½ç›¸è¿‘çš„åœºæ™¯
```

**ç­–ç•¥ä¸‰ï¼šæŒ‡å®šç­–ç•¥** ğŸ¯ç²¾ç¡®æ§åˆ¶

```java
// æ˜ç¡®æŒ‡å®šç”¨æŸä¸ªä»åº“
@DS("slave1")
public List<User> queryFromSlave1() {
    return userMapper.selectList(null);
}
```

### 6.3 è‡ªå®šä¹‰è·¯ç”±ç­–ç•¥


**åœºæ™¯ï¼šæ ¹æ®ç”¨æˆ·IDåˆ†åº“**

```java
// è‡ªå®šä¹‰ç­–ç•¥ç±»
public class UserIdHashStrategy extends AbstractLoadBalanceDynamicDataSourceStrategy {
    
    @Override
    public DataSource determineDataSource(List<DataSource> dataSources) {
        // è·å–å½“å‰ç”¨æˆ·ID
        Long userId = UserContext.getCurrentUserId();
        
        // æ ¹æ®ç”¨æˆ·IDå“ˆå¸Œé€‰æ‹©ä»åº“
        int index = (int) (userId % dataSources.size());
        return dataSources.get(index);
    }
}

// é…ç½®ä½¿ç”¨
@Configuration
public class DataSourceConfig {
    
    @Bean
    public DynamicDataSourceStrategy dynamicDataSourceStrategy() {
        return new UserIdHashStrategy();
    }
}
```

**åœºæ™¯ï¼šæ ¹æ®æ—¶é—´æ®µåˆ†åº“**

```java
public class TimeBasedStrategy implements DynamicDataSourceStrategy {
    
    @Override
    public DataSource determineDataSource(Map<String, DataSource> dataSourceMap) {
        int hour = LocalDateTime.now().getHour();
        
        // é«˜å³°æœŸï¼ˆ9-18ç‚¹ï¼‰ï¼šä¼˜å…ˆç”¨æ€§èƒ½å¥½çš„slave1
        if (hour >= 9 && hour <= 18) {
            return dataSourceMap.get("slave1");
        }
        // ä½å³°æœŸï¼šç”¨slave2èŠ‚çœèµ„æº
        else {
            return dataSourceMap.get("slave2");
        }
    }
}
```

### 6.4 è·¯ç”±ç­–ç•¥é…ç½®æ±‡æ€»


| ç­–ç•¥ç±»å‹ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|---------|------|------|
| **è½®è¯¢** | ä»åº“æ€§èƒ½ç›¸åŒ | åˆ†é…å‡åŒ€ | æ— æ³•åº”å¯¹æ€§èƒ½å·®å¼‚ |
| **éšæœº** | ä»åº“æ€§èƒ½ç›¸è¿‘ | å®ç°ç®€å• | å¯èƒ½åˆ†é…ä¸å‡ |
| **æƒé‡** | ä»åº“æ€§èƒ½ä¸åŒ | å……åˆ†åˆ©ç”¨èµ„æº | é…ç½®å¤æ‚ |
| **å“ˆå¸Œ** | éœ€è¦æ•°æ®äº²å’Œæ€§ | åŒä¸€ç”¨æˆ·å›ºå®šåº“ | å¯èƒ½å€¾æ–œ |
| **è‡ªå®šä¹‰** | ç‰¹æ®Šä¸šåŠ¡éœ€æ±‚ | çµæ´»å¯æ§ | å¼€å‘æˆæœ¬é«˜ |

---

## 7. âš–ï¸ è´Ÿè½½å‡è¡¡ç®—æ³•


### 7.1 è´Ÿè½½å‡è¡¡æ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼šå¤šä¸ªä»åº“ä¸€èµ·å¹²æ´»ï¼Œæ€ä¹ˆåˆ†é…ä»»åŠ¡æ›´åˆç†

**ç”Ÿæ´»æ¯”å–»**ï¼š
```
é¤å…æœ‰3ä¸ªå¨å¸ˆï¼ˆä»åº“ï¼‰
é¡¾å®¢ç‚¹é¤ï¼ˆæŸ¥è¯¢è¯·æ±‚ï¼‰
è´Ÿè½½å‡è¡¡ = å¦‚ä½•åˆ†é…è®¢å•ç»™å¨å¸ˆ

æ–¹æ¡ˆAï¼šè½®æµåšèœï¼ˆè½®è¯¢ï¼‰
æ–¹æ¡ˆBï¼šè°é—²è°åšï¼ˆæœ€å°‘è¿æ¥ï¼‰
æ–¹æ¡ˆCï¼šæ ¹æ®å¨å¸ˆæŠ€èƒ½åˆ†é…ï¼ˆæƒé‡ï¼‰
```

### 7.2 è½®è¯¢ç®—æ³•ï¼ˆRound Robinï¼‰


**å®ç°åŸç†**ï¼š

```java
public class RoundRobinLoadBalancer {
    
    private AtomicInteger index = new AtomicInteger(0);
    private List<String> slaves = Arrays.asList("slave1", "slave2", "slave3");
    
    public String getNextSlave() {
        // æ¯æ¬¡è‡ªå¢ï¼Œè¶…è¿‡åˆ—è¡¨é•¿åº¦å½’é›¶
        int current = index.getAndIncrement() % slaves.size();
        return slaves.get(current);
    }
}

// æ‰§è¡Œæ•ˆæœ
è¯·æ±‚1 â†’ slave1 (index=0)
è¯·æ±‚2 â†’ slave2 (index=1)
è¯·æ±‚3 â†’ slave3 (index=2)
è¯·æ±‚4 â†’ slave1 (index=3 % 3 = 0)
è¯·æ±‚5 â†’ slave2 (index=4 % 3 = 1)
```

**ä¼˜ç¼ºç‚¹åˆ†æ**ï¼š
- âœ… åˆ†é…ç»å¯¹å…¬å¹³
- âœ… å®ç°ç®€å•ï¼Œæ€§èƒ½å¥½
- âŒ æ— æ³•åº”å¯¹ä»åº“æ€§èƒ½å·®å¼‚
- âŒ æ— æ³•æ„ŸçŸ¥ä»åº“è´Ÿè½½

### 7.3 åŠ æƒè½®è¯¢ç®—æ³•ï¼ˆWeighted Round Robinï¼‰


**ä½¿ç”¨åœºæ™¯**ï¼šä»åº“æ€§èƒ½ä¸åŒ

```yaml
spring:
  datasource:
    dynamic:
      datasource:
        slave1:
          url: jdbc:mysql://localhost:3307/db_slave1
          weight: 3  # æƒé‡3ï¼šé…ç½®é«˜ï¼Œå¤šå¹²æ´»
        slave2:
          url: jdbc:mysql://localhost:3308/db_slave2
          weight: 1  # æƒé‡1ï¼šé…ç½®ä½ï¼Œå°‘å¹²æ´»
```

**åˆ†é…æ•ˆæœ**ï¼š
```
10ä¸ªè¯·æ±‚çš„åˆ†é…ï¼š
slave1: 3+3+3 = 9ä¸ªè¯·æ±‚ï¼ˆ75%ï¼‰
slave2: 1ä¸ªè¯·æ±‚ï¼ˆ25%ï¼‰

å®é™…åºåˆ—ï¼š
slave1, slave1, slave1, slave2, slave1, slave1, slave1, slave2, ...
```

**å®ç°ä»£ç **ï¼š

```java
public class WeightedRoundRobinLoadBalancer {
    
    private List<DataSourceNode> nodes;
    private int currentIndex = 0;
    private int currentWeight = 0;
    
    public DataSourceNode getNext() {
        // æ‰¾åˆ°æœ€å¤§æƒé‡
        int maxWeight = nodes.stream()
            .mapToInt(DataSourceNode::getWeight)
            .max()
            .orElse(1);
        
        while (true) {
            currentIndex = (currentIndex + 1) % nodes.size();
            if (currentIndex == 0) {
                currentWeight = currentWeight - 1;
                if (currentWeight <= 0) {
                    currentWeight = maxWeight;
                }
            }
            
            DataSourceNode node = nodes.get(currentIndex);
            if (node.getWeight() >= currentWeight) {
                return node;
            }
        }
    }
}
```

### 7.4 éšæœºç®—æ³•ï¼ˆRandomï¼‰


**å®ç°åŸç†**ï¼š

```java
public class RandomLoadBalancer {
    
    private List<String> slaves = Arrays.asList("slave1", "slave2", "slave3");
    private Random random = new Random();
    
    public String getNextSlave() {
        int index = random.nextInt(slaves.size());
        return slaves.get(index);
    }
}
```

**ä¼˜ç¼ºç‚¹**ï¼š
- âœ… å®ç°æœ€ç®€å•
- âœ… é•¿æœŸçœ‹åˆ†é…å‡åŒ€
- âŒ çŸ­æœŸå¯èƒ½ä¸å‡
- âŒ æ— æ³•åº”å¯¹æ€§èƒ½å·®å¼‚

### 7.5 åŠ æƒéšæœºç®—æ³•


**åº”ç”¨åœºæ™¯**ï¼šå¸Œæœ›æŒ‰æƒé‡åˆ†é…ï¼Œä½†ä¸è¦æ±‚ä¸¥æ ¼é¡ºåº

```java
public class WeightedRandomLoadBalancer {
    
    static class DataSourceNode {
        String name;
        int weight;
    }
    
    private List<DataSourceNode> nodes;
    private Random random = new Random();
    
    public String getNext() {
        // è®¡ç®—æ€»æƒé‡
        int totalWeight = nodes.stream()
            .mapToInt(node -> node.weight)
            .sum();
        
        // ç”Ÿæˆéšæœºæ•°
        int randomWeight = random.nextInt(totalWeight);
        
        // æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹
        int currentWeight = 0;
        for (DataSourceNode node : nodes) {
            currentWeight += node.weight;
            if (randomWeight < currentWeight) {
                return node.name;
            }
        }
        
        return nodes.get(0).name;
    }
}

// ç¤ºä¾‹ï¼šslave1æƒé‡3ï¼Œslave2æƒé‡1
æ€»æƒé‡ = 4
éšæœºæ•° 0 â†’ slave1
éšæœºæ•° 1 â†’ slave1
éšæœºæ•° 2 â†’ slave1
éšæœºæ•° 3 â†’ slave2
```

### 7.6 æœ€å°‘è¿æ¥ç®—æ³•ï¼ˆLeast Connectionï¼‰


**æ ¸å¿ƒæ€æƒ³**ï¼šæŠŠè¯·æ±‚åˆ†é…ç»™è¿æ¥æ•°æœ€å°‘çš„ä»åº“

```java
public class LeastConnectionLoadBalancer {
    
    private Map<String, AtomicInteger> connectionCounts = new ConcurrentHashMap<>();
    
    public String getNextSlave() {
        // æ‰¾åˆ°è¿æ¥æ•°æœ€å°‘çš„ä»åº“
        return connectionCounts.entrySet().stream()
            .min(Map.Entry.comparingByValue((a, b) -> 
                a.get() - b.get()))
            .map(Map.Entry::getKey)
            .orElse("slave1");
    }
    
    // è¯·æ±‚å¼€å§‹ï¼šå¢åŠ è¿æ¥æ•°
    public void incrementConnection(String slave) {
        connectionCounts.computeIfAbsent(slave, k -> new AtomicInteger(0))
            .incrementAndGet();
    }
    
    // è¯·æ±‚ç»“æŸï¼šå‡å°‘è¿æ¥æ•°
    public void decrementConnection(String slave) {
        connectionCounts.get(slave).decrementAndGet();
    }
}
```

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… è¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚å¤§
- âœ… éœ€è¦åŠ¨æ€åº”å¯¹è´Ÿè½½å˜åŒ–
- âŒ å®ç°å¤æ‚ï¼Œç»´æŠ¤å¼€é”€å¤§

### 7.7 ç®—æ³•é€‰æ‹©å»ºè®®


**å†³ç­–è¡¨**ï¼š

```
ä»åº“æ€§èƒ½ç›¸åŒ + è¯·æ±‚æ—¶é—´ç›¸è¿‘ â†’ è½®è¯¢ç®—æ³• âœ“
ä»åº“æ€§èƒ½ä¸åŒ + å¯é¢„çŸ¥å·®å¼‚ â†’ åŠ æƒè½®è¯¢ âœ“
è¯·æ±‚æ—¶é—´å·®å¼‚å¤§ + éœ€åŠ¨æ€è°ƒæ•´ â†’ æœ€å°‘è¿æ¥ âœ“
ç®€å•åœºæ™¯ + ä¸è¿½æ±‚æè‡´ â†’ éšæœºç®—æ³• âœ“
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…çŸ¥å¿…ä¼šçŸ¥è¯†ç‚¹


**ğŸ”¸ è¯»å†™åˆ†ç¦»æ ¸å¿ƒæ¦‚å¿µ**
```
ä¸»åº“ï¼ˆMasterï¼‰ï¼šè´Ÿè´£å†™æ“ä½œï¼Œæ•°æ®æƒå¨æ¥æº
ä»åº“ï¼ˆSlaveï¼‰ï¼šè´Ÿè´£è¯»æ“ä½œï¼Œä¸»åº“æ•°æ®å‰¯æœ¬
æ•°æ®åŒæ­¥ï¼šä¸»åº“ â†’ ä»åº“ï¼ˆæœ‰å»¶è¿Ÿï¼‰
@DSæ³¨è§£ï¼šæŒ‡å®šä½¿ç”¨å“ªä¸ªæ•°æ®æº
```

**ğŸ”¸ å…³é”®åŸåˆ™**
- âœ… **å†™æ“ä½œå¿…èµ°ä¸»åº“**ï¼šä¿è¯æ•°æ®å‡†ç¡®æ€§
- âœ… **äº‹åŠ¡å†…ç»Ÿä¸€æ•°æ®æº**ï¼šä¿è¯ä¸€è‡´æ€§
- âœ… **å†™åè¯»èµ°ä¸»åº“**ï¼šé¿å…å»¶è¿Ÿé—®é¢˜
- âœ… **é‡‘é¢/åº“å­˜èµ°ä¸»åº“**ï¼šå…³é”®ä¸šåŠ¡ä¸èƒ½é”™

### 8.2 å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ


| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **æŸ¥ä¸åˆ°åˆšæ’å…¥çš„æ•°æ®** | ä»åº“åŒæ­¥å»¶è¿Ÿ | å†™åè¯»å¼ºåˆ¶èµ°ä¸»åº“ `@DS("master")` |
| **äº‹åŠ¡å†…@DSå¤±æ•ˆ** | äº‹åŠ¡è¦æ±‚ç»Ÿä¸€è¿æ¥ | åœ¨äº‹åŠ¡æ–¹æ³•ä¸Šæ ‡æ³¨ `@DS("master")` |
| **ä»åº“å‹åŠ›ä¸å‡** | è·¯ç”±ç­–ç•¥ä¸åˆç† | é…ç½®åŠ æƒè½®è¯¢æˆ–è‡ªå®šä¹‰ç­–ç•¥ |
| **å¶å°”æ•°æ®ä¸ä¸€è‡´** | ä¸»ä»å»¶è¿Ÿ | å…³é”®æŸ¥è¯¢èµ°ä¸»åº“ï¼Œæˆ–ä½¿ç”¨ç¼“å­˜ |

### 8.3 æœ€ä½³å®è·µå»ºè®®


**å®è·µæ¸…å•** âœ…

1. **æ˜ç¡®æ ‡æ³¨æ•°æ®æº**
```java
@DS("master")  // å†™æ“ä½œ
public void save() { }

@DS("slave")   // è¯»æ“ä½œ
public void query() { }
```

2. **äº‹åŠ¡æ–¹æ³•å¿…é¡»æŒ‡å®šä¸»åº“**
```java
@Transactional
@DS("master")  // å¿…é¡»ï¼
public void business() { }
```

3. **å…³é”®ä¸šåŠ¡èµ°ä¸»åº“**
```java
// é‡‘é¢ã€åº“å­˜ã€å®æ—¶æ•°æ®
@DS("master")
public BigDecimal getBalance() { }
```

4. **è¯»å†™åˆ†ç¦»é…ç½®æ¨¡æ¿**
```yaml
spring:
  datasource:
    dynamic:
      primary: master
      strict: false
      datasource:
        master: # ä¸»åº“
        slave1: # ä»åº“1
        slave2: # ä»åº“2
```

### 8.4 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹


**ä¼˜åŒ–ç­–ç•¥**ï¼š

```
ğŸ”¸ åˆç†é…ç½®ä»åº“æ•°é‡
  - è¯»å†™æ¯”1:10 â†’ 2-3ä¸ªä»åº“
  - è¯»å†™æ¯”1:100 â†’ 5-10ä¸ªä»åº“

ğŸ”¸ é€‰æ‹©åˆé€‚çš„è´Ÿè½½å‡è¡¡ç®—æ³•
  - ä»åº“æ€§èƒ½ç›¸åŒ â†’ è½®è¯¢
  - ä»åº“æ€§èƒ½ä¸åŒ â†’ åŠ æƒè½®è¯¢
  - åŠ¨æ€è´Ÿè½½ â†’ æœ€å°‘è¿æ¥

ğŸ”¸ é…åˆç¼“å­˜ä½¿ç”¨
  çƒ­ç‚¹æ•°æ® â†’ Redisç¼“å­˜
  å†·æ•°æ® â†’ ä»åº“æŸ¥è¯¢
  å®æ—¶æ•°æ® â†’ ä¸»åº“æŸ¥è¯¢
```

### 8.5 è®°å¿†å£è¯€


```
è¯»å†™åˆ†ç¦»è¦è®°ç‰¢ï¼Œä¸»åº“å†™æ¥ä»åº“æŸ¥
äº‹åŠ¡ä¹‹å†…ç”¨ä¸»åº“ï¼Œå»¶è¿Ÿé—®é¢˜åˆ«å¿½ç•¥
DSæ³¨è§£å¾ˆå…³é”®ï¼Œæ ‡æ³¨æ¸…æ¥šä¸ä¼šä¹±
è´Ÿè½½å‡è¡¡æœ‰ç­–ç•¥ï¼Œè½®è¯¢æƒé‡æœ€å¸¸è§
å…³é”®ä¸šåŠ¡èµ°ä¸»åº“ï¼Œé‡‘é¢åº“å­˜ä¸èƒ½å·®
```