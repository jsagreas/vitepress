---
title: 72ã€æ•°æ®å˜æ›´å®¡è®¡ç³»ç»Ÿ
---
## ğŸ“š ç›®å½•

1. [å®¡è®¡ç³»ç»ŸåŸºç¡€æ¦‚å¿µ](#1-å®¡è®¡ç³»ç»ŸåŸºç¡€æ¦‚å¿µ)
2. [æ“ä½œå®¡è®¡æ—¥å¿—è®°å½•](#2-æ“ä½œå®¡è®¡æ—¥å¿—è®°å½•)
3. [æ•°æ®å˜æ›´è¿½è¸ªå®ç°](#3-æ•°æ®å˜æ›´è¿½è¸ªå®ç°)
4. [å®¡è®¡ä¿¡æ¯å­˜å‚¨ç­–ç•¥](#4-å®¡è®¡ä¿¡æ¯å­˜å‚¨ç­–ç•¥)
5. [åˆè§„è¦æ±‚æ»¡è¶³](#5-åˆè§„è¦æ±‚æ»¡è¶³)
6. [æ—¥å¿—æŸ¥è¯¢ä¼˜åŒ–](#6-æ—¥å¿—æŸ¥è¯¢ä¼˜åŒ–)
7. [å†å²æ•°æ®æ¸…ç†](#7-å†å²æ•°æ®æ¸…ç†)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å®¡è®¡ç³»ç»ŸåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®å®¡è®¡


**é€šä¿—ç†è§£**ï¼šå°±åƒé“¶è¡Œä¼šè®°å½•ä½ çš„æ¯ä¸€ç¬”äº¤æ˜“ä¸€æ ·ï¼Œæ•°æ®å®¡è®¡å°±æ˜¯è®°å½•ç³»ç»Ÿä¸­æ•°æ®çš„æ¯ä¸€æ¬¡å˜åŒ–ã€‚

```
å®é™…åœºæ™¯ä¸¾ä¾‹ï¼š

ç½‘è´­è®¢å•å˜åŒ–ï¼š
åˆ›å»ºè®¢å• â†’ ä»˜æ¬¾ â†’ å‘è´§ â†’ ç­¾æ”¶

æ¯ä¸ªç¯èŠ‚éƒ½è¦è®°å½•ï¼š
- è°æ“ä½œçš„ï¼Ÿï¼ˆç”¨æˆ·/ç®¡ç†å‘˜ï¼‰
- ä»€ä¹ˆæ—¶å€™æ“ä½œçš„ï¼Ÿï¼ˆæ—¶é—´æˆ³ï¼‰
- æ”¹äº†ä»€ä¹ˆï¼Ÿï¼ˆè®¢å•çŠ¶æ€å˜åŒ–ï¼‰
- ä¸ºä»€ä¹ˆæ”¹ï¼Ÿï¼ˆæ“ä½œåŸå› ï¼‰
- æ€ä¹ˆæ”¹çš„ï¼Ÿï¼ˆå…·ä½“å†…å®¹ï¼‰
```

**æ ¸å¿ƒä»·å€¼**ï¼š
- âœ… **è¿½æº¯é—®é¢˜**ï¼šæ•°æ®å‡ºé”™å¯ä»¥æŸ¥åˆ°æ˜¯è°æ”¹çš„
- âœ… **å®‰å…¨åˆè§„**ï¼šæ»¡è¶³æ³•å¾‹æ³•è§„è¦æ±‚
- âœ… **æ•°æ®æ¢å¤**ï¼šå¯ä»¥å›æº¯å†å²çŠ¶æ€
- âœ… **è¡Œä¸ºåˆ†æ**ï¼šäº†è§£ç”¨æˆ·æ“ä½œä¹ æƒ¯

### 1.2 å®¡è®¡ç³»ç»Ÿçš„ç»„æˆéƒ¨åˆ†


```
å®Œæ•´çš„å®¡è®¡ç³»ç»Ÿ = è®°å½• + å­˜å‚¨ + æŸ¥è¯¢ + åˆ†æ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          å®¡è®¡ç³»ç»Ÿæ¶æ„å›¾              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  ä¸šåŠ¡æ“ä½œ â†’ æ‹¦æˆªå™¨ â†’ å®¡è®¡è®°å½•        â”‚
â”‚              â†“                      â”‚
â”‚           å­˜å‚¨å¼•æ“                   â”‚
â”‚              â†“                      â”‚
â”‚      æŸ¥è¯¢æ¥å£ â† æ•°æ®æ¸…ç†             â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å››å¤§æ ¸å¿ƒç¯èŠ‚**ï¼š

ğŸ”¸ **è®°å½•ç¯èŠ‚**ï¼šæ•è·å˜åŒ–äº‹ä»¶
- ä»€ä¹ˆæ—¶å€™è®°å½•ï¼Ÿï¼ˆå¢åˆ æ”¹æ“ä½œæ—¶ï¼‰
- è®°å½•ä»€ä¹ˆå†…å®¹ï¼Ÿï¼ˆå˜åŒ–å‰åå¯¹æ¯”ï¼‰

ğŸ”¸ **å­˜å‚¨ç¯èŠ‚**ï¼šä¿å­˜å®¡è®¡ä¿¡æ¯
- å­˜åˆ°å“ªé‡Œï¼Ÿï¼ˆæ•°æ®åº“/æ—¥å¿—æ–‡ä»¶ï¼‰
- æ€ä¹ˆå­˜ï¼Ÿï¼ˆç»“æ„åŒ–/éç»“æ„åŒ–ï¼‰

ğŸ”¸ **æŸ¥è¯¢ç¯èŠ‚**ï¼šæ£€ç´¢å†å²è®°å½•
- æŒ‰æ—¶é—´æŸ¥è¯¢
- æŒ‰æ“ä½œäººæŸ¥è¯¢
- æŒ‰æ•°æ®ç±»å‹æŸ¥è¯¢

ğŸ”¸ **æ¸…ç†ç¯èŠ‚**ï¼šå¤„ç†è¿‡æœŸæ•°æ®
- ä½•æ—¶æ¸…ç†ï¼Ÿï¼ˆå®šæœŸä»»åŠ¡ï¼‰
- ä¿ç•™å¤šä¹…ï¼Ÿï¼ˆåˆè§„è¦æ±‚ï¼‰

### 1.3 å®¡è®¡çº§åˆ«åˆ’åˆ†


| çº§åˆ« | **è¯´æ˜** | **é€‚ç”¨åœºæ™¯** | **æ€§èƒ½å½±å“** |
|------|---------|-------------|-------------|
| ğŸ”´ **å®Œæ•´å®¡è®¡** | `è®°å½•æ‰€æœ‰å­—æ®µå˜åŒ–` | `è´¢åŠ¡ã€åŒ»ç–—ç­‰æ•æ„Ÿæ•°æ®` | `è¾ƒå¤§` |
| ğŸŸ¡ **å…³é”®å®¡è®¡** | `ä»…è®°å½•é‡è¦å­—æ®µ` | `ä¸€èˆ¬ä¸šåŠ¡æ•°æ®` | `ä¸­ç­‰` |
| ğŸŸ¢ **ç®€å•å®¡è®¡** | `ä»…è®°å½•æ“ä½œè®°å½•` | `æ™®é€šæ—¥å¿—éœ€æ±‚` | `è¾ƒå°` |
| âšª **æ— å®¡è®¡** | `ä¸è®°å½•ä»»ä½•ä¿¡æ¯` | `ä¸´æ—¶æ•°æ®ã€ç¼“å­˜` | `æ— å½±å“` |

---

## 2. ğŸ“ æ“ä½œå®¡è®¡æ—¥å¿—è®°å½•


### 2.1 ä½¿ç”¨MyBatis-Plusæ‹¦æˆªå™¨å®ç°


**æ ¸å¿ƒæ€è·¯**ï¼šåœ¨æ•°æ®åº“æ“ä½œå‰åè‡ªåŠ¨è®°å½•å˜åŒ–

```java
/**
 * å®¡è®¡æ—¥å¿—æ‹¦æˆªå™¨
 * å°±åƒå•†åœºçš„ç›‘æ§æ‘„åƒå¤´ï¼Œè‡ªåŠ¨è®°å½•æ¯ä¸ªæ“ä½œ
 */
@Component
@Intercepts({
    @Signature(type = Executor.class, method = "update", 
               args = {MappedStatement.class, Object.class})
})
public class AuditInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // 1ï¸âƒ£ è·å–æ“ä½œä¿¡æ¯
        MappedStatement ms = (MappedStatement) invocation.getArgs()[0];
        Object parameter = invocation.getArgs()[1];
        
        // 2ï¸âƒ£ åˆ¤æ–­æ˜¯å¢åˆ æ”¹æ“ä½œ
        if (SqlCommandType.INSERT == ms.getSqlCommandType() ||
            SqlCommandType.UPDATE == ms.getSqlCommandType() ||
            SqlCommandType.DELETE == ms.getSqlCommandType()) {
            
            // 3ï¸âƒ£ è®°å½•å®¡è®¡æ—¥å¿—
            recordAuditLog(ms, parameter);
        }
        
        // 4ï¸âƒ£ æ‰§è¡ŒåŸå§‹æ“ä½œ
        return invocation.proceed();
    }
}
```

ğŸ’¡ **å°è´´å£«**ï¼šæ‹¦æˆªå™¨å°±åƒé—¨å«ï¼Œæ¯ä¸ªæ“ä½œéƒ½è¦ç»è¿‡å®ƒçš„æ£€æŸ¥å’Œè®°å½•ã€‚

### 2.2 å®¡è®¡æ—¥å¿—å®ä½“è®¾è®¡


```java
/**
 * å®¡è®¡æ—¥å¿—è¡¨
 * è®°å½•æ¯æ¬¡æ•°æ®å˜åŒ–çš„è¯¦ç»†ä¿¡æ¯
 */
@TableName("sys_audit_log")
public class AuditLog {
    
    @TableId(type = IdType.AUTO)
    private Long id;
    
    // ğŸ“Œ æ“ä½œä¿¡æ¯
    private String tableName;      // æ“ä½œçš„è¡¨å
    private String operationType;  // æ“ä½œç±»å‹ï¼šINSERT/UPDATE/DELETE
    private Long recordId;         // è¢«æ“ä½œçš„è®°å½•ID
    
    // ğŸ‘¤ æ“ä½œäººä¿¡æ¯
    private Long userId;           // æ“ä½œç”¨æˆ·ID
    private String username;       // ç”¨æˆ·å
    private String userIp;         // æ“ä½œIPåœ°å€
    
    // ğŸ“… æ—¶é—´ä¿¡æ¯
    private LocalDateTime operateTime;  // æ“ä½œæ—¶é—´
    
    // ğŸ“„ å˜æ›´å†…å®¹
    private String oldValue;       // ä¿®æ”¹å‰çš„å€¼ï¼ˆJSONæ ¼å¼ï¼‰
    private String newValue;       // ä¿®æ”¹åçš„å€¼ï¼ˆJSONæ ¼å¼ï¼‰
    private String changeFields;   // å˜åŒ–çš„å­—æ®µåˆ—è¡¨
    
    // ğŸ’¬ å¤‡æ³¨ä¿¡æ¯
    private String remark;         // æ“ä½œå¤‡æ³¨
    private String businessType;   // ä¸šåŠ¡ç±»å‹
}
```

**å­—æ®µè®¾è®¡è¯´æ˜**ï¼š

`tableName` - è®°å½•å“ªå¼ è¡¨è¢«æ“ä½œäº†
- ç¤ºä¾‹ï¼š`tb_user`ã€`tb_order`

`operationType` - è®°å½•æ“ä½œç±»å‹
- `INSERT` - æ–°å¢æ•°æ®
- `UPDATE` - ä¿®æ”¹æ•°æ®  
- `DELETE` - åˆ é™¤æ•°æ®

`oldValue` å’Œ `newValue` - è®°å½•å˜åŒ–å¯¹æ¯”
```json
// ä¿®æ”¹å‰
{"status": "å¾…ä»˜æ¬¾", "amount": 100}

// ä¿®æ”¹å
{"status": "å·²ä»˜æ¬¾", "amount": 100}
```

### 2.3 è‡ªåŠ¨è®°å½•å½“å‰æ“ä½œäºº


```java
/**
 * å®¡è®¡ä¿¡æ¯å¡«å……å™¨
 * è‡ªåŠ¨å¡«å……æ“ä½œäººã€æ—¶é—´ç­‰ä¿¡æ¯
 */
@Component
public class AuditMetaHandler implements MetaObjectHandler {
    
    @Override
    public void insertFill(MetaObject metaObject) {
        // è·å–å½“å‰ç™»å½•ç”¨æˆ·
        UserContext user = getCurrentUser();
        
        // è‡ªåŠ¨å¡«å……åˆ›å»ºä¿¡æ¯
        this.setFieldValByName("createUser", user.getId(), metaObject);
        this.setFieldValByName("createTime", LocalDateTime.now(), metaObject);
        this.setFieldValByName("createIp", user.getIp(), metaObject);
    }
    
    @Override
    public void updateFill(MetaObject metaObject) {
        UserContext user = getCurrentUser();
        
        // è‡ªåŠ¨å¡«å……ä¿®æ”¹ä¿¡æ¯
        this.setFieldValByName("updateUser", user.getId(), metaObject);
        this.setFieldValByName("updateTime", LocalDateTime.now(), metaObject);
        this.setFieldValByName("updateIp", user.getIp(), metaObject);
    }
    
    // ä»ThreadLocalæˆ–Spring Securityè·å–å½“å‰ç”¨æˆ·
    private UserContext getCurrentUser() {
        // å®é™…é¡¹ç›®ä¸­ä»SecurityContextHolderè·å–
        return UserContextHolder.get();
    }
}
```

ğŸ’¡ **ç†è§£è¦ç‚¹**ï¼šå°±åƒæ–‡æ¡£çš„"æœ€åç¼–è¾‘äºº"ï¼Œç³»ç»Ÿè‡ªåŠ¨è®°å½•æ˜¯è°æ”¹çš„ã€‚

---

## 3. ğŸ” æ•°æ®å˜æ›´è¿½è¸ªå®ç°


### 3.1 å˜æ›´å¯¹æ¯”æ ¸å¿ƒé€»è¾‘


**ç›®æ ‡**ï¼šæ‰¾å‡ºä¿®æ”¹å‰åçš„å·®å¼‚

```java
/**
 * æ•°æ®å˜æ›´å¯¹æ¯”å·¥å…·
 */
public class DataChangeTracker {
    
    /**
     * å¯¹æ¯”ä¸¤ä¸ªå¯¹è±¡çš„å·®å¼‚
     * 
     * @param oldObj ä¿®æ”¹å‰çš„å¯¹è±¡
     * @param newObj ä¿®æ”¹åçš„å¯¹è±¡
     * @return å˜åŒ–çš„å­—æ®µåˆ—è¡¨
     */
    public static List<FieldChange> compareObjects(Object oldObj, Object newObj) {
        List<FieldChange> changes = new ArrayList<>();
        
        if (oldObj == null || newObj == null) {
            return changes;
        }
        
        // è·å–æ‰€æœ‰å­—æ®µ
        Field[] fields = oldObj.getClass().getDeclaredFields();
        
        for (Field field : fields) {
            field.setAccessible(true);
            
            try {
                Object oldValue = field.get(oldObj);
                Object newValue = field.get(newObj);
                
                // åˆ¤æ–­å€¼æ˜¯å¦å˜åŒ–
                if (!Objects.equals(oldValue, newValue)) {
                    changes.add(new FieldChange(
                        field.getName(),
                        oldValue,
                        newValue
                    ));
                }
            } catch (Exception e) {
                log.error("å­—æ®µå¯¹æ¯”å¤±è´¥", e);
            }
        }
        
        return changes;
    }
}
```

### 3.2 å®é™…åº”ç”¨ç¤ºä¾‹


```java
/**
 * ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹çš„å®¡è®¡
 */
@Service
public class UserService {
    
    @Autowired
    private AuditLogService auditLogService;
    
    public void updateUser(User user) {
        // 1ï¸âƒ£ æŸ¥è¯¢ä¿®æ”¹å‰çš„æ•°æ®
        User oldUser = userMapper.selectById(user.getId());
        
        // 2ï¸âƒ£ æ‰§è¡Œä¿®æ”¹æ“ä½œ
        userMapper.updateById(user);
        
        // 3ï¸âƒ£ å¯¹æ¯”å·®å¼‚å¹¶è®°å½•å®¡è®¡
        List<FieldChange> changes = DataChangeTracker
            .compareObjects(oldUser, user);
        
        if (!changes.isEmpty()) {
            AuditLog log = new AuditLog();
            log.setTableName("tb_user");
            log.setOperationType("UPDATE");
            log.setRecordId(user.getId());
            log.setOldValue(JSON.toJSONString(oldUser));
            log.setNewValue(JSON.toJSONString(user));
            log.setChangeFields(changes.stream()
                .map(FieldChange::getFieldName)
                .collect(Collectors.joining(",")));
            
            auditLogService.save(log);
        }
    }
}
```

### 3.3 æ•æ„Ÿå­—æ®µç‰¹æ®Šå¤„ç†


```java
/**
 * æ•æ„Ÿä¿¡æ¯è„±æ•å¤„ç†
 */
public class SensitiveHandler {
    
    // å®šä¹‰æ•æ„Ÿå­—æ®µ
    private static final Set<String> SENSITIVE_FIELDS = new HashSet<>(
        Arrays.asList("password", "phone", "idCard", "bankCard")
    );
    
    /**
     * è„±æ•å¤„ç†
     */
    public static String maskSensitive(String fieldName, Object value) {
        if (value == null) return null;
        
        String strValue = value.toString();
        
        // å¯†ç ï¼šå®Œå…¨éšè—
        if ("password".equals(fieldName)) {
            return "******";
        }
        
        // æ‰‹æœºå·ï¼šä¸­é—´4ä½éšè—
        if ("phone".equals(fieldName) && strValue.length() == 11) {
            return strValue.substring(0, 3) + "****" + 
                   strValue.substring(7);
        }
        
        // èº«ä»½è¯ï¼šä¸­é—´10ä½éšè—
        if ("idCard".equals(fieldName) && strValue.length() == 18) {
            return strValue.substring(0, 4) + "**********" + 
                   strValue.substring(14);
        }
        
        return strValue;
    }
}
```

âš ï¸ **æ³¨æ„**ï¼šæ•æ„Ÿä¿¡æ¯è¦è„±æ•åå†è®°å½•ï¼Œä¿æŠ¤ç”¨æˆ·éšç§ã€‚

---

## 4. ğŸ’¾ å®¡è®¡ä¿¡æ¯å­˜å‚¨ç­–ç•¥


### 4.1 å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”


| æ–¹æ¡ˆ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|------|---------|---------|-------------|
| ğŸ—„ï¸ **å…³ç³»æ•°æ®åº“** | `äº‹åŠ¡æ”¯æŒå¼ºï¼ŒæŸ¥è¯¢æ–¹ä¾¿` | `å†™å…¥æ€§èƒ½è¾ƒä½` | `ä¸­å°å‹ç³»ç»Ÿ` |
| ğŸ“Š **æ—¶åºæ•°æ®åº“** | `å†™å…¥æ€§èƒ½é«˜ï¼Œå‹ç¼©ç‡å¥½` | `æŸ¥è¯¢åŠŸèƒ½æœ‰é™` | `å¤§é‡å®¡è®¡æ—¥å¿—` |
| ğŸ“ **æ—¥å¿—æ–‡ä»¶** | `æ€§èƒ½æœ€å¥½ï¼Œæˆæœ¬ä½` | `æŸ¥è¯¢å›°éš¾` | `åªéœ€å­˜æ¡£ä¸éœ€æŸ¥è¯¢` |
| ğŸ”¥ **æ··åˆå­˜å‚¨** | `å…¼é¡¾æ€§èƒ½å’ŒæŸ¥è¯¢` | `æ¶æ„å¤æ‚` | `å¤§å‹ç³»ç»Ÿ` |

### 4.2 åˆ†è¡¨å­˜å‚¨ç­–ç•¥


```java
/**
 * æŒ‰æœˆåˆ†è¡¨å­˜å‚¨å®¡è®¡æ—¥å¿—
 * å°±åƒæŠŠæ–‡ä»¶æŒ‰æœˆä»½å½’æ¡£ï¼Œæ–¹ä¾¿ç®¡ç†
 */
@Service
public class AuditLogSharding {
    
    /**
     * æ ¹æ®æ—¶é—´åŠ¨æ€é€‰æ‹©è¡¨å
     */
    public String getTableName(LocalDateTime time) {
        String month = time.format(DateTimeFormatter.ofPattern("yyyyMM"));
        return "sys_audit_log_" + month;
        
        // ç”Ÿæˆçš„è¡¨åç¤ºä¾‹ï¼š
        // sys_audit_log_202501  (2025å¹´1æœˆ)
        // sys_audit_log_202502  (2025å¹´2æœˆ)
    }
    
    /**
     * è‡ªåŠ¨åˆ›å»ºåˆ†è¡¨
     */
    @Scheduled(cron = "0 0 0 1 * ?")  // æ¯æœˆ1å·æ‰§è¡Œ
    public void createMonthlyTable() {
        LocalDateTime nextMonth = LocalDateTime.now().plusMonths(1);
        String tableName = getTableName(nextMonth);
        
        // åˆ›å»ºä¸‹ä¸ªæœˆçš„è¡¨
        String sql = String.format("""
            CREATE TABLE IF NOT EXISTS %s (
                id BIGINT PRIMARY KEY AUTO_INCREMENT,
                table_name VARCHAR(64),
                operation_type VARCHAR(20),
                operate_time DATETIME,
                -- å…¶ä»–å­—æ®µ...
                INDEX idx_operate_time(operate_time)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
            """, tableName);
        
        jdbcTemplate.execute(sql);
    }
}
```

ğŸ’¡ **åˆ†è¡¨å¥½å¤„**ï¼š
- å•è¡¨æ•°æ®é‡å°ï¼ŒæŸ¥è¯¢å¿«
- å¯ä»¥æŒ‰æœˆå½’æ¡£å†å²æ•°æ®
- ä¾¿äºæ¸…ç†è¿‡æœŸæ•°æ®

### 4.3 JSONå­—æ®µå­˜å‚¨å˜æ›´è¯¦æƒ…


```java
/**
 * ä½¿ç”¨JSONå­˜å‚¨å¤æ‚å˜æ›´ä¿¡æ¯
 */
@TableName("sys_audit_log")
public class AuditLog {
    
    // ä½¿ç”¨MyBatis-Plusçš„JSONç±»å‹å¤„ç†å™¨
    @TableField(typeHandler = JacksonTypeHandler.class)
    private ChangeDetail changeDetail;
}

/**
 * å˜æ›´è¯¦æƒ…å¯¹è±¡
 */
@Data
public class ChangeDetail {
    private Map<String, Object> oldValues;   // ä¿®æ”¹å‰
    private Map<String, Object> newValues;   // ä¿®æ”¹å
    private List<String> changedFields;      // å˜åŒ–å­—æ®µ
    
    // ç¤ºä¾‹æ•°æ®ç»“æ„ï¼š
    // {
    //   "oldValues": {"status": "å¾…å®¡æ ¸", "amount": 100},
    //   "newValues": {"status": "å·²é€šè¿‡", "amount": 150},
    //   "changedFields": ["status", "amount"]
    // }
}
```

---

## 5. âš–ï¸ åˆè§„è¦æ±‚æ»¡è¶³


### 5.1 å¸¸è§åˆè§„æ ‡å‡†


**å…³é”®åˆè§„è¦æ±‚**ï¼š

ğŸ”¸ **æ•°æ®ä¿ç•™æœŸé™**
```
é‡‘èè¡Œä¸šï¼šè‡³å°‘ä¿ç•™5-7å¹´
åŒ»ç–—è¡Œä¸šï¼šè‡³å°‘ä¿ç•™15-30å¹´
ç”µå•†è¡Œä¸šï¼šè‡³å°‘ä¿ç•™2-3å¹´
```

ğŸ”¸ **å®¡è®¡å®Œæ•´æ€§**
- ä¸å¯ç¯¡æ”¹ï¼šå·²è®°å½•çš„å®¡è®¡æ—¥å¿—ä¸èƒ½ä¿®æ”¹
- ä¸å¯åˆ é™¤ï¼šå®¡è®¡æ•°æ®ä¸èƒ½éšæ„åˆ é™¤
- å¯è¿½æº¯ï¼šèƒ½è¿½æº¯åˆ°å…·ä½“æ“ä½œäºº

ğŸ”¸ **è®¿é—®æ§åˆ¶**
- åªæœ‰æˆæƒäººå‘˜èƒ½æŸ¥çœ‹å®¡è®¡æ—¥å¿—
- æŸ¥çœ‹å®¡è®¡æ—¥å¿—çš„è¡Œä¸ºä¹Ÿè¦å®¡è®¡

### 5.2 é˜²ç¯¡æ”¹æœºåˆ¶å®ç°


```java
/**
 * å®¡è®¡æ—¥å¿—é˜²ç¯¡æ”¹
 * ä½¿ç”¨æ•°å­—ç­¾åç¡®ä¿æ•°æ®å®Œæ•´æ€§
 */
public class AuditIntegrityChecker {
    
    /**
     * è®¡ç®—å®¡è®¡è®°å½•çš„æ•°å­—ç­¾å
     */
    public String calculateSignature(AuditLog log) {
        // å°†å…³é”®ä¿¡æ¯æ‹¼æ¥
        String data = log.getId() + 
                     log.getOperateTime() + 
                     log.getOldValue() + 
                     log.getNewValue();
        
        // ä½¿ç”¨MD5æˆ–SHA256ç”Ÿæˆç­¾å
        return DigestUtils.md5Hex(data + SECRET_KEY);
    }
    
    /**
     * éªŒè¯ç­¾åæ˜¯å¦æœ‰æ•ˆ
     */
    public boolean verifySignature(AuditLog log) {
        String calculatedSign = calculateSignature(log);
        return calculatedSign.equals(log.getSignature());
    }
}
```

### 5.3 è®¿é—®æƒé™æ§åˆ¶


```java
/**
 * å®¡è®¡æ—¥å¿—æŸ¥è¯¢æƒé™æ§åˆ¶
 */
@RestController
@RequestMapping("/audit")
public class AuditController {
    
    /**
     * æŸ¥çœ‹å®¡è®¡æ—¥å¿—éœ€è¦ç‰¹æ®Šæƒé™
     */
    @PreAuthorize("hasAuthority('audit:view')")
    @GetMapping("/logs")
    public List<AuditLog> queryLogs(AuditQuery query) {
        // åŒæ—¶è®°å½•æŸ¥è¯¢å®¡è®¡æ—¥å¿—çš„è¡Œä¸º
        recordAuditQuery(query);
        
        return auditLogService.queryLogs(query);
    }
    
    /**
     * è®°å½•æŸ¥è¯¢è¡Œä¸º
     */
    private void recordAuditQuery(AuditQuery query) {
        AuditLog log = new AuditLog();
        log.setOperationType("QUERY_AUDIT");
        log.setRemark("æŸ¥è¯¢å®¡è®¡æ—¥å¿—: " + JSON.toJSONString(query));
        auditLogService.save(log);
    }
}
```

âš ï¸ **é‡è¦**ï¼šæŸ¥çœ‹å®¡è®¡æ—¥å¿—çš„è¡Œä¸ºä¹Ÿè¦è¢«å®¡è®¡ï¼Œè¿™å«"å®¡è®¡çš„å®¡è®¡"ã€‚

---

## 6. ğŸš€ æ—¥å¿—æŸ¥è¯¢ä¼˜åŒ–


### 6.1 é«˜æ•ˆæŸ¥è¯¢ç´¢å¼•è®¾è®¡


```sql
-- å®¡è®¡æ—¥å¿—è¡¨ç´¢å¼•è®¾è®¡
CREATE TABLE sys_audit_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    table_name VARCHAR(64),
    operation_type VARCHAR(20),
    user_id BIGINT,
    operate_time DATETIME,
    -- å…¶ä»–å­—æ®µ...
    
    -- æ ¸å¿ƒæŸ¥è¯¢ç´¢å¼•
    INDEX idx_table_time (table_name, operate_time),
    INDEX idx_user_time (user_id, operate_time),
    INDEX idx_operate_time (operate_time),
    INDEX idx_record (table_name, record_id)
) ENGINE=InnoDB;
```

**ç´¢å¼•è®¾è®¡åŸåˆ™**ï¼š

âœ… **æœ€å¸¸ç”¨çš„æŸ¥è¯¢æ¡ä»¶å»ºç´¢å¼•**
```
æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢ â†’ operate_timeç´¢å¼•
æŒ‰ç”¨æˆ·æŸ¥è¯¢ â†’ user_idç´¢å¼•
æŒ‰è¡¨åæŸ¥è¯¢ â†’ table_nameç´¢å¼•
```

âœ… **å¤åˆç´¢å¼•éµå¾ªæœ€å·¦å‰ç¼€**
```
INDEX (table_name, operate_time)

âœ“ å¯ä»¥èµ°ç´¢å¼•ï¼šWHERE table_name = 'tb_user'
âœ“ å¯ä»¥èµ°ç´¢å¼•ï¼šWHERE table_name = 'tb_user' AND operate_time > xxx
âœ— ä¸èƒ½èµ°ç´¢å¼•ï¼šWHERE operate_time > xxx
```

### 6.2 åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–


```java
/**
 * ä¼˜åŒ–çš„å®¡è®¡æ—¥å¿—æŸ¥è¯¢
 */
@Service
public class AuditLogService {
    
    /**
     * ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µé¿å…æ·±åˆ†é¡µé—®é¢˜
     */
    public Page<AuditLog> queryByScroll(Long lastId, int pageSize) {
        LambdaQueryWrapper<AuditLog> wrapper = new LambdaQueryWrapper<>();
        
        // ä½¿ç”¨ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€åä¸€æ¡IDä½œä¸ºèµ·ç‚¹
        if (lastId != null) {
            wrapper.gt(AuditLog::getId, lastId);
        }
        
        wrapper.orderByAsc(AuditLog::getId)
               .last("LIMIT " + pageSize);
        
        return page(new Page<>(1, pageSize), wrapper);
    }
    
    /**
     * æ—¶é—´èŒƒå›´æŸ¥è¯¢ä¼˜åŒ–
     */
    public List<AuditLog> queryByTimeRange(
        LocalDateTime start, 
        LocalDateTime end,
        String tableName) {
        
        return lambdaQuery()
            .eq(AuditLog::getTableName, tableName)
            .between(AuditLog::getOperateTime, start, end)
            .orderByDesc(AuditLog::getOperateTime)
            .list();
    }
}
```

### 6.3 ç¼“å­˜çƒ­ç‚¹æ•°æ®


```java
/**
 * ç¼“å­˜æœ€è¿‘çš„å®¡è®¡è®°å½•
 */
@Service
public class AuditCacheService {
    
    @Autowired
    private RedisTemplate<String, AuditLog> redisTemplate;
    
    /**
     * ç¼“å­˜æœ€è¿‘1å°æ—¶çš„å®¡è®¡æ—¥å¿—
     */
    public void cacheRecentLogs(List<AuditLog> logs) {
        String key = "audit:recent:logs";
        
        logs.forEach(log -> {
            redisTemplate.opsForList().leftPush(key, log);
        });
        
        // åªä¿ç•™æœ€æ–°1000æ¡
        redisTemplate.opsForList().trim(key, 0, 999);
        
        // 1å°æ—¶è¿‡æœŸ
        redisTemplate.expire(key, 1, TimeUnit.HOURS);
    }
    
    /**
     * ä¼˜å…ˆä»ç¼“å­˜è·å–
     */
    public List<AuditLog> getRecentLogs(int limit) {
        String key = "audit:recent:logs";
        
        List<AuditLog> cached = redisTemplate.opsForList()
            .range(key, 0, limit - 1);
        
        if (cached != null && !cached.isEmpty()) {
            return cached;
        }
        
        // ç¼“å­˜missï¼ŒæŸ¥è¯¢æ•°æ®åº“
        return queryFromDatabase(limit);
    }
}
```

---

## 7. ğŸ—‘ï¸ å†å²æ•°æ®æ¸…ç†


### 7.1 è‡ªåŠ¨å½’æ¡£ç­–ç•¥


```java
/**
 * å®¡è®¡æ—¥å¿—è‡ªåŠ¨å½’æ¡£
 * æŠŠæ—§æ•°æ®è½¬ç§»åˆ°å½’æ¡£è¡¨ï¼Œå‡è½»ä¸»è¡¨å‹åŠ›
 */
@Component
public class AuditArchiveTask {
    
    /**
     * æ¯æœˆå½’æ¡£3ä¸ªæœˆå‰çš„æ•°æ®
     */
    @Scheduled(cron = "0 0 2 1 * ?")  // æ¯æœˆ1å·å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void archiveOldLogs() {
        LocalDateTime archiveBefore = LocalDateTime.now().minusMonths(3);
        
        // 1ï¸âƒ£ å°†æ—§æ•°æ®è¿ç§»åˆ°å½’æ¡£è¡¨
        String insertSql = """
            INSERT INTO sys_audit_log_archive
            SELECT * FROM sys_audit_log
            WHERE operate_time < ?
            """;
        jdbcTemplate.update(insertSql, archiveBefore);
        
        // 2ï¸âƒ£ åˆ é™¤ä¸»è¡¨ä¸­çš„æ—§æ•°æ®
        String deleteSql = """
            DELETE FROM sys_audit_log
            WHERE operate_time < ?
            """;
        jdbcTemplate.update(deleteSql, archiveBefore);
        
        log.info("å½’æ¡£å®Œæˆï¼Œå½’æ¡£æ—¶é—´ç‚¹: {}", archiveBefore);
    }
}
```

### 7.2 æŒ‰ä¿ç•™æœŸé™æ¸…ç†


```java
/**
 * æ ¹æ®åˆè§„è¦æ±‚æ¸…ç†è¿‡æœŸæ•°æ®
 */
@Component
public class AuditCleanupTask {
    
    // ä¸åŒä¸šåŠ¡ç±»å‹çš„ä¿ç•™æœŸé™
    private static final Map<String, Integer> RETENTION_POLICY = Map.of(
        "FINANCE", 7 * 365,      // é‡‘èï¼š7å¹´
        "MEDICAL", 15 * 365,     // åŒ»ç–—ï¼š15å¹´
        "GENERAL", 2 * 365       // ä¸€èˆ¬ï¼š2å¹´
    );
    
    /**
     * å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
     */
    @Scheduled(cron = "0 0 3 * * ?")  // æ¯å¤©å‡Œæ™¨3ç‚¹
    public void cleanExpiredLogs() {
        RETENTION_POLICY.forEach((type, days) -> {
            LocalDateTime expireDate = LocalDateTime.now().minusDays(days);
            
            int deleted = lambdaUpdate()
                .eq(AuditLog::getBusinessType, type)
                .lt(AuditLog::getOperateTime, expireDate)
                .remove() ? 1 : 0;
            
            log.info("æ¸…ç†{}ç±»å‹è¿‡æœŸæ—¥å¿—ï¼Œåˆ é™¤{}æ¡", type, deleted);
        });
    }
}
```

### 7.3 å‹ç¼©å­˜å‚¨ä¼˜åŒ–


```java
/**
 * å¯¹å½’æ¡£æ•°æ®è¿›è¡Œå‹ç¼©
 */
public class AuditCompressor {
    
    /**
     * å‹ç¼©JSONå­—æ®µ
     */
    public String compressJson(String json) {
        try {
            byte[] input = json.getBytes(StandardCharsets.UTF_8);
            
            ByteArrayOutputStream out = new ByteArrayOutputStream();
            GZIPOutputStream gzip = new GZIPOutputStream(out);
            gzip.write(input);
            gzip.close();
            
            // è½¬ä¸ºBase64å­˜å‚¨
            return Base64.getEncoder().encodeToString(out.toByteArray());
        } catch (Exception e) {
            log.error("å‹ç¼©å¤±è´¥", e);
            return json;
        }
    }
    
    /**
     * è§£å‹æ•°æ®
     */
    public String decompressJson(String compressed) {
        try {
            byte[] input = Base64.getDecoder().decode(compressed);
            
            ByteArrayInputStream in = new ByteArrayInputStream(input);
            GZIPInputStream gzip = new GZIPInputStream(in);
            
            return new String(gzip.readAllBytes(), StandardCharsets.UTF_8);
        } catch (Exception e) {
            log.error("è§£å‹å¤±è´¥", e);
            return compressed;
        }
    }
}
```

ğŸ’¡ **å‹ç¼©æ•ˆæœ**ï¼šJSONæ•°æ®é€šå¸¸å¯ä»¥å‹ç¼©åˆ°åŸå¤§å°çš„20-30%

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å®¡è®¡æœ¬è´¨ï¼šè®°å½•æ•°æ®å˜åŒ–çš„"ç›‘æ§å½•åƒ"
ğŸ”¸ æ ¸å¿ƒè¦ç´ ï¼šè°ã€ä½•æ—¶ã€æ”¹äº†ä»€ä¹ˆã€ä¸ºä»€ä¹ˆæ”¹
ğŸ”¸ å®ç°æ–¹å¼ï¼šæ‹¦æˆªå™¨ + å¯¹æ¯” + è®°å½•
ğŸ”¸ å­˜å‚¨ç­–ç•¥ï¼šåˆ†è¡¨ + å½’æ¡£ + å‹ç¼©
ğŸ”¸ åˆè§„è¦æ±‚ï¼šé˜²ç¯¡æ”¹ + æƒé™æ§åˆ¶ + ä¿ç•™æœŸé™
```

### 8.2 å®è·µè¦ç‚¹


**âœ… æœ€ä½³å®è·µ**ï¼š

1ï¸âƒ£ **é€‰æ‹©åˆé€‚çš„å®¡è®¡çº§åˆ«**
```
æ•æ„Ÿæ•°æ® â†’ å®Œæ•´å®¡è®¡ï¼ˆè®°å½•æ‰€æœ‰å­—æ®µï¼‰
ä¸€èˆ¬æ•°æ® â†’ å…³é”®å®¡è®¡ï¼ˆåªè®°å½•é‡è¦å­—æ®µï¼‰
ä¸´æ—¶æ•°æ® â†’ ä¸éœ€è¦å®¡è®¡
```

2ï¸âƒ£ **ä¼˜åŒ–å­˜å‚¨æ€§èƒ½**
```
åˆ†è¡¨å­˜å‚¨ â†’ æŒ‰æœˆæˆ–æŒ‰å¹´åˆ†è¡¨
å¼‚æ­¥è®°å½• â†’ ä¸å½±å“ä¸šåŠ¡æ€§èƒ½
å®šæœŸå½’æ¡£ â†’ å‡è½»ä¸»è¡¨å‹åŠ›
```

3ï¸âƒ£ **ä¿æŠ¤æ•æ„Ÿä¿¡æ¯**
```
å¯†ç å­—æ®µ â†’ å®Œå…¨éšè—
æ‰‹æœºå·ç  â†’ ä¸­é—´è„±æ•
èº«ä»½è¯å· â†’ éƒ¨åˆ†éšè—
```

**âŒ å¸¸è§è¯¯åŒº**ï¼š

âŒ æ‰€æœ‰å­—æ®µéƒ½å®¡è®¡ â†’ æ€§èƒ½å·®ï¼Œå­˜å‚¨æµªè´¹
âœ… åªå®¡è®¡å…³é”®å­—æ®µ â†’ å¹³è¡¡æ€§èƒ½å’Œéœ€æ±‚

âŒ å®¡è®¡æ—¥å¿—å­˜ä¸»åº“ â†’ å½±å“ä¸šåŠ¡æ€§èƒ½
âœ… ç‹¬ç«‹å­˜å‚¨æˆ–å¼‚æ­¥ â†’ è§£è€¦ä¸šåŠ¡å’Œå®¡è®¡

âŒ æ°¸ä¹…ä¿ç•™æ‰€æœ‰æ—¥å¿— â†’ å­˜å‚¨æˆæœ¬é«˜
âœ… æŒ‰éœ€ä¿ç•™ + å½’æ¡£ â†’ ç¬¦åˆåˆè§„ä¸”çœæˆæœ¬

### 8.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ“Œ å¸¸è§ä¸šåŠ¡åœºæ™¯**ï¼š

ğŸ”¹ **è®¢å•å®¡è®¡**
```
è®°å½•ï¼šä¸‹å• â†’ ä»˜æ¬¾ â†’ å‘è´§ â†’ ç­¾æ”¶ å…¨æµç¨‹
ç”¨é€”ï¼šçº çº·å¤„ç†ã€æ•°æ®åˆ†æ
```

ğŸ”¹ **æƒé™å®¡è®¡**
```
è®°å½•ï¼šè§’è‰²åˆ†é…ã€æƒé™å˜æ›´
ç”¨é€”ï¼šå®‰å…¨å®¡æŸ¥ã€è´£ä»»è¿½æº¯
```

ğŸ”¹ **è´¢åŠ¡å®¡è®¡**
```
è®°å½•ï¼šé‡‘é¢å˜åŠ¨ã€è´¦æˆ·æ“ä½œ
ç”¨é€”ï¼šåˆè§„æ£€æŸ¥ã€é˜²æ­¢èˆå¼Š
```

ğŸ”¹ **ç”¨æˆ·è¡Œä¸ºå®¡è®¡**
```
è®°å½•ï¼šç™»å½•ã€æ“ä½œã€å¼‚å¸¸è¡Œä¸º
ç”¨é€”ï¼šå®‰å…¨åˆ†æã€ç”¨æˆ·ç”»åƒ
```

### 8.4 å­¦ä¹ è·¯å¾„å»ºè®®


```
å…¥é—¨é˜¶æ®µï¼š
â””â”€ ç†è§£å®¡è®¡æ¦‚å¿µå’Œä»·å€¼
â””â”€ æŒæ¡åŸºç¡€æ‹¦æˆªå™¨å®ç°
â””â”€ å­¦ä¼šè®°å½•ç®€å•å˜æ›´

è¿›é˜¶é˜¶æ®µï¼š
â””â”€ å®ç°æ•°æ®å¯¹æ¯”å’Œè¿½è¸ª
â””â”€ ä¼˜åŒ–å­˜å‚¨å’ŒæŸ¥è¯¢æ€§èƒ½
â””â”€ æ»¡è¶³åŸºæœ¬åˆè§„è¦æ±‚

é«˜çº§é˜¶æ®µï¼š
â””â”€ åˆ†å¸ƒå¼å®¡è®¡æ–¹æ¡ˆ
â””â”€ å¤§æ•°æ®é‡å¤„ç†ä¼˜åŒ–
â””â”€ å®¡è®¡æ•°æ®åˆ†ææŒ–æ˜
```

**ğŸ¯ è®°å¿†å£è¯€**ï¼š

```
å®¡è®¡æ—¥å¿—è¦è®°å…¨ï¼Œè°æ”¹ä»€ä¹ˆéƒ½è¦çœ‹
æ‹¦æˆªå™¨å‰åšå¯¹æ¯”ï¼Œæ–°æ—§æ•°æ®è¦ä¿å­˜
æ•æ„Ÿä¿¡æ¯è¦è„±æ•ï¼Œé˜²ç¯¡æ”¹ç­¾åä¸èƒ½å°‘
åˆ†è¡¨å½’æ¡£å®šæœŸæ¸…ï¼Œæ€§èƒ½åˆè§„ä¸¤ä¸è¯¯
```