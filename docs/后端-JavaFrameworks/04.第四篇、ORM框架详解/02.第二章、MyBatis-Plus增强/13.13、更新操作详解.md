---
title: 13ã€æ›´æ–°æ“ä½œè¯¦è§£
---
## ğŸ“š ç›®å½•

1. [æ›´æ–°æ“ä½œåŸºç¡€æ¦‚å¿µ](#1-æ›´æ–°æ“ä½œåŸºç¡€æ¦‚å¿µ)
2. [updateByIdä¸»é”®æ›´æ–°](#2-updateByIdä¸»é”®æ›´æ–°)
3. [updateæ¡ä»¶æ›´æ–°](#3-updateæ¡ä»¶æ›´æ–°)
4. [UpdateWrapperæ„é€ å™¨](#4-UpdateWrapperæ„é€ å™¨)
5. [é€‰æ‹©æ€§æ›´æ–°ç­–ç•¥](#5-é€‰æ‹©æ€§æ›´æ–°ç­–ç•¥)
6. [æ‰¹é‡æ›´æ–°æ“ä½œ](#6-æ‰¹é‡æ›´æ–°æ“ä½œ)
7. [ä¹è§‚é”æ›´æ–°æœºåˆ¶](#7-ä¹è§‚é”æ›´æ–°æœºåˆ¶)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ›´æ–°æ“ä½œåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®æ›´æ–°


**é€šä¿—ç†è§£**ï¼šå°±åƒä¿®æ”¹ä½ æ‰‹æœºé€šè®¯å½•é‡Œçš„è”ç³»äººä¿¡æ¯ä¸€æ ·ï¼Œæ•°æ®åº“çš„æ›´æ–°å°±æ˜¯ä¿®æ”¹è¡¨é‡Œå·²æœ‰çš„æ•°æ®ã€‚

```
ç°å®åœºæ™¯ç±»æ¯”ï¼š
è´­ç‰©ç½‘ç«™ä¿®æ”¹æ”¶è´§åœ°å€ â†’ æ•°æ®åº“æ›´æ–°åœ°å€å­—æ®µ
ä¿®æ”¹ç”¨æˆ·æ˜µç§° â†’ æ•°æ®åº“æ›´æ–°æ˜µç§°å­—æ®µ
å•†å“é™ä»· â†’ æ•°æ®åº“æ›´æ–°ä»·æ ¼å­—æ®µ
```

### 1.2 ä¼ ç»Ÿæ–¹å¼ vs MyBatis-Plus


**ä¼ ç»ŸJDBCæ›´æ–°çš„ç—›ç‚¹**ï¼š
```java
// ä¼ ç»Ÿæ–¹å¼ï¼šå†™SQLå¾ˆç¹ç
String sql = "UPDATE user SET name=?, age=? WHERE id=?";
PreparedStatement ps = conn.prepareStatement(sql);
ps.setString(1, "å¼ ä¸‰");
ps.setInt(2, 25);
ps.setLong(3, 1L);
ps.executeUpdate();
```

**MyBatis-Plusçš„ç®€åŒ–**ï¼š
```java
// MyBatis-Plusï¼šä¸€è¡Œæå®š
User user = new User();
user.setId(1L);
user.setName("å¼ ä¸‰");
user.setAge(25);
userMapper.updateById(user);
```

### 1.3 MyBatis-Plusæ›´æ–°æ–¹å¼åˆ†ç±»


```
æ›´æ–°æ–¹å¼å…¨æ™¯å›¾ï¼š

æ ¹æ®ä¸»é”®æ›´æ–°              æ ¹æ®æ¡ä»¶æ›´æ–°
    â†“                        â†“
updateById()             update(entity, wrapper)
    â†“                        â†“
ç®€å•ç›´æ¥              åŠŸèƒ½å¼ºå¤§çµæ´»
é€‚åˆå•æ¡æ›´æ–°          é€‚åˆå¤æ‚æ¡ä»¶
```

| æ›´æ–°æ–¹å¼ | **ä½¿ç”¨åœºæ™¯** | **ç‰¹ç‚¹** | **å¤æ‚åº¦** |
|---------|------------|---------|-----------|
| `updateById` | çŸ¥é“IDï¼Œä¿®æ”¹å•æ¡æ•°æ® | ç®€å•ç›´æ¥ | â­ |
| `update + Wrapper` | å¤æ‚æ¡ä»¶ï¼Œæ‰¹é‡ä¿®æ”¹ | çµæ´»å¼ºå¤§ | â­â­â­ |
| `æ‰¹é‡æ›´æ–°` | åŒæ—¶ä¿®æ”¹å¤šæ¡æ•°æ® | æ•ˆç‡é«˜ | â­â­ |
| `ä¹è§‚é”æ›´æ–°` | é˜²æ­¢å¹¶å‘å†²çª | å®‰å…¨æ€§é«˜ | â­â­â­â­ |

---

## 2. ğŸ”‘ updateByIdä¸»é”®æ›´æ–°


### 2.1 æ ¸å¿ƒæ¦‚å¿µ


**ä»€ä¹ˆæ˜¯ä¸»é”®æ›´æ–°**ï¼šæ ¹æ®æ•°æ®çš„å”¯ä¸€æ ‡è¯†ï¼ˆIDï¼‰æ¥ä¿®æ”¹è¿™æ¡æ•°æ®ï¼Œå°±åƒå‡­èº«ä»½è¯å·ä¿®æ”¹ä¸ªäººä¿¡æ¯ä¸€æ ·ã€‚

**å…³é”®ç†è§£**ï¼š
- ğŸ”¸ **å¿…é¡»æœ‰ID**ï¼šå®ä½“å¯¹è±¡å¿…é¡»è®¾ç½®ä¸»é”®å€¼
- ğŸ”¸ **è‡ªåŠ¨è¯†åˆ«**ï¼šMyBatis-Plusä¼šè‡ªåŠ¨æ‰¾åˆ°`@TableId`æ ‡æ³¨çš„å­—æ®µ
- ğŸ”¸ **åªæ›´æ–°éç©º**ï¼šé»˜è®¤åªæ›´æ–°ä½ è®¾ç½®äº†å€¼çš„å­—æ®µ

### 2.2 åŸºç¡€ç”¨æ³•


```java
// å®ä½“ç±»å®šä¹‰
@TableName("user")
public class User {
    @TableId(type = IdType.AUTO)  // ä¸»é”®æ ‡è¯†
    private Long id;
    private String name;
    private Integer age;
    private String email;
}

// åŸºç¡€æ›´æ–°æ“ä½œ
@Test
public void testUpdateById() {
    User user = new User();
    user.setId(1L);           // å¿…é¡»è®¾ç½®IDï¼
    user.setName("æå››");      // è¦ä¿®æ”¹çš„å­—æ®µ
    user.setAge(28);
    
    int rows = userMapper.updateById(user);
    System.out.println("å½±å“è¡Œæ•°ï¼š" + rows);
}
```

**æ‰§è¡Œçš„SQL**ï¼š
```sql
UPDATE user SET name='æå››', age=28 WHERE id=1
```

### 2.3 å­—æ®µæ›´æ–°ç­–ç•¥


**é‡è¦ç‰¹æ€§**ï¼š**åªæ›´æ–°éNULLå­—æ®µ**

```java
// åœºæ™¯ï¼šåªæƒ³ä¿®æ”¹å¹´é¾„ï¼Œä¸åŠ¨å…¶ä»–å­—æ®µ
User user = new User();
user.setId(1L);
user.setAge(30);      // åªè®¾ç½®è¦æ”¹çš„
// nameå’Œemailæ²¡è®¾ç½®ï¼Œä¸ä¼šè¢«æ›´æ–°

userMapper.updateById(user);
// SQL: UPDATE user SET age=30 WHERE id=1
```

> ğŸ’¡ **æ–°æ‰‹æç¤º**ï¼šå¦‚æœä½ æƒ³æŠŠæŸä¸ªå­—æ®µæ”¹æˆNULLï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼ˆåé¢ä¼šè®²ï¼‰

### 2.4 è¿”å›å€¼å«ä¹‰


```java
int rows = userMapper.updateById(user);

// è¿”å›å€¼è§£è¯»ï¼š
rows == 1  â†’ æ›´æ–°æˆåŠŸï¼Œæ‰¾åˆ°äº†ID=1çš„è®°å½•
rows == 0  â†’ æ›´æ–°å¤±è´¥ï¼Œæ•°æ®åº“é‡Œæ²¡æœ‰è¿™ä¸ªID
```

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š
```java
public boolean updateUser(User user) {
    int rows = userMapper.updateById(user);
    if (rows == 0) {
        throw new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨ï¼Œæ›´æ–°å¤±è´¥");
    }
    return true;
}
```

---

## 3. ğŸ² updateæ¡ä»¶æ›´æ–°


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦æ¡ä»¶æ›´æ–°


**åœºæ™¯ç†è§£**ï¼š
```
åœºæ™¯1ï¼šç»™æ‰€æœ‰VIPç”¨æˆ·å¢åŠ 100ç§¯åˆ†
  â†’ ä¸çŸ¥é“å…·ä½“IDï¼Œéœ€è¦æŒ‰æ¡ä»¶æ‰¹é‡æ›´æ–°

åœºæ™¯2ï¼šæŠŠæ‰€æœ‰è¿‡æœŸè®¢å•çŠ¶æ€æ”¹ä¸º"å·²å…³é—­"
  â†’ æ¡ä»¶ï¼šè®¢å•æ—¶é—´ < å½“å‰æ—¶é—´-7å¤©

åœºæ™¯3ï¼šä¿®æ”¹æŸä¸ªéƒ¨é—¨æ‰€æœ‰å‘˜å·¥çš„éƒ¨é—¨åç§°
  â†’ æ¡ä»¶ï¼šéƒ¨é—¨ID = æŸä¸ªå€¼
```

è¿™äº›åœºæ™¯éƒ½éœ€è¦**æ¡ä»¶æ›´æ–°**ï¼

### 3.2 åŸºç¡€è¯­æ³•


```java
// æ–¹æ³•ç­¾å
int update(@Param("et") T entity, @Param("ew") Wrapper<T> updateWrapper);
```

**å‚æ•°è¯´æ˜**ï¼š
- `entity`ï¼šè¦æ›´æ–°æˆä»€ä¹ˆå€¼ï¼ˆæ–°æ•°æ®ï¼‰
- `updateWrapper`ï¼šä»€ä¹ˆæ¡ä»¶ä¸‹æ›´æ–°ï¼ˆWHEREæ¡ä»¶ï¼‰

### 3.3 ç®€å•ç¤ºä¾‹


```java
@Test
public void testUpdate() {
    // 1. å‡†å¤‡æ–°æ•°æ®
    User user = new User();
    user.setAge(30);  // è¦æ”¹æˆ30å²
    
    // 2. è®¾ç½®æ¡ä»¶
    UpdateWrapper<User> wrapper = new UpdateWrapper<>();
    wrapper.eq("name", "å¼ ä¸‰");  // æ¡ä»¶ï¼šåå­—ç­‰äºå¼ ä¸‰
    
    // 3. æ‰§è¡Œæ›´æ–°
    userMapper.update(user, wrapper);
}
```

**ç”ŸæˆSQL**ï¼š
```sql
UPDATE user SET age=30 WHERE name='å¼ ä¸‰'
```

### 3.4 æ¡ä»¶æ›´æ–°çš„æ‰§è¡Œæµç¨‹


```
æ‰§è¡Œæµç¨‹å›¾ï¼š

å‡†å¤‡entityå¯¹è±¡          æ„é€ Wrapperæ¡ä»¶
   (æ–°æ•°æ®)                (WHEREæ¡ä»¶)
      â†“                        â†“
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
          è°ƒç”¨update()
               â†“
      MyBatis-Plusè§£æ
               â†“
          ç”ŸæˆSQLè¯­å¥
               â†“
    UPDATE table SET... WHERE...
               â†“
          æ‰§è¡Œå¹¶è¿”å›å½±å“è¡Œæ•°
```

---

## 4. ğŸ”§ UpdateWrapperæ„é€ å™¨


### 4.1 UpdateWrapperæ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼šUpdateWrapperå°±åƒä¸€ä¸ª"æ¡ä»¶å’Œä¿®æ”¹å†…å®¹çš„é…ç½®å™¨"ï¼Œä½ å‘Šè¯‰å®ƒï¼š
- **WHEREæ¡ä»¶**ï¼šä»€ä¹ˆæƒ…å†µä¸‹æ›´æ–°
- **SETå†…å®¹**ï¼šè¦æ”¹æˆä»€ä¹ˆå€¼

### 4.2 è®¾ç½®WHEREæ¡ä»¶


```java
UpdateWrapper<User> wrapper = new UpdateWrapper<>();

// 1. ç­‰å€¼æ¡ä»¶
wrapper.eq("age", 18);           // age = 18
wrapper.ne("status", 0);         // status != 0

// 2. èŒƒå›´æ¡ä»¶  
wrapper.gt("age", 18);           // age > 18
wrapper.lt("score", 60);         // score < 60
wrapper.between("age", 18, 30);  // age BETWEEN 18 AND 30

// 3. æ¨¡ç³ŠæŸ¥è¯¢
wrapper.like("name", "å¼ ");      // name LIKE '%å¼ %'
wrapper.likeRight("email", "qq"); // email LIKE 'qq%'

// 4. å¤šæ¡ä»¶ç»„åˆ
wrapper.eq("status", 1)
       .gt("age", 18)
       .like("name", "å¼ ");      // ç”¨ANDè¿æ¥
```

**ç”Ÿæˆçš„SQL**ï¼š
```sql
WHERE status=1 AND age>18 AND name LIKE '%å¼ %'
```

### 4.3 è®¾ç½®SETå†…å®¹ï¼ˆä¸¤ç§æ–¹å¼ï¼‰


**æ–¹å¼ä¸€ï¼šé€šè¿‡entityå¯¹è±¡**
```java
User user = new User();
user.setAge(25);
user.setEmail("new@qq.com");

UpdateWrapper<User> wrapper = new UpdateWrapper<>();
wrapper.eq("id", 1);

userMapper.update(user, wrapper);
// SQL: UPDATE user SET age=25, email='new@qq.com' WHERE id=1
```

**æ–¹å¼äºŒï¼šé€šè¿‡wrapper.set()**
```java
UpdateWrapper<User> wrapper = new UpdateWrapper<>();
wrapper.eq("id", 1)                    // WHEREæ¡ä»¶
       .set("age", 25)                 // SETå†…å®¹
       .set("email", "new@qq.com");

userMapper.update(null, wrapper);  // entityä¼ null
// ç”Ÿæˆç›¸åŒçš„SQL
```

> ğŸ’¡ **æ–°æ‰‹å»ºè®®**ï¼šç®€å•æ›´æ–°ç”¨entityï¼Œå¤æ‚SQLç”¨wrapper.set()

### 4.4 åŠ¨æ€SQLåœºæ™¯


```java
public void updateUserByCondition(Long userId, String name, Integer age) {
    UpdateWrapper<User> wrapper = new UpdateWrapper<>();
    wrapper.eq("id", userId);
    
    // åŠ¨æ€æ·»åŠ æ›´æ–°å†…å®¹
    if (name != null) {
        wrapper.set("name", name);
    }
    if (age != null) {
        wrapper.set("age", age);
    }
    
    userMapper.update(null, wrapper);
}
```

**è°ƒç”¨ç¤ºä¾‹**ï¼š
```java
// åªæ›´æ–°name
updateUserByCondition(1L, "æ–°åå­—", null);
// SQL: UPDATE user SET name='æ–°åå­—' WHERE id=1

// åªæ›´æ–°age
updateUserByCondition(1L, null, 30);
// SQL: UPDATE user SET age=30 WHERE id=1
```

### 4.5 å¸¸ç”¨æ¡ä»¶é€ŸæŸ¥


| æ–¹æ³• | **è¯´æ˜** | **ç¤ºä¾‹** | **SQL** |
|------|---------|---------|---------|
| `eq` | ç­‰äº | `eq("name", "å¼ ä¸‰")` | `name = 'å¼ ä¸‰'` |
| `ne` | ä¸ç­‰äº | `ne("status", 0)` | `status != 0` |
| `gt` | å¤§äº | `gt("age", 18)` | `age > 18` |
| `ge` | å¤§äºç­‰äº | `ge("score", 60)` | `score >= 60` |
| `lt` | å°äº | `lt("price", 100)` | `price < 100` |
| `le` | å°äºç­‰äº | `le("age", 60)` | `age <= 60` |
| `between` | åŒºé—´ | `between("age", 18, 30)` | `age BETWEEN 18 AND 30` |
| `like` | æ¨¡ç³Š | `like("name", "å¼ ")` | `name LIKE '%å¼ %'` |
| `in` | åŒ…å« | `in("id", 1,2,3)` | `id IN (1,2,3)` |
| `isNull` | ä¸ºç©º | `isNull("email")` | `email IS NULL` |

---

## 5. âš™ï¸ é€‰æ‹©æ€§æ›´æ–°ç­–ç•¥


### 5.1 ä»€ä¹ˆæ˜¯é€‰æ‹©æ€§æ›´æ–°


**é—®é¢˜åœºæ™¯**ï¼š
```
ç”¨æˆ·ä¿®æ”¹ä¸ªäººèµ„æ–™ï¼Œåªæ”¹äº†æ˜µç§°ï¼Œå…¶ä»–ä¸åŠ¨
â†’ åªæ›´æ–°nicknameå­—æ®µï¼Œå…¶ä»–å­—æ®µä¿æŒåŸå€¼
```

**MyBatis-Plusçš„é»˜è®¤è¡Œä¸º**ï¼š
- âœ… **éNULLå­—æ®µ**ï¼šä¼šæ›´æ–°
- âŒ **NULLå­—æ®µ**ï¼šä¸æ›´æ–°ï¼ˆä¿æŒåŸå€¼ï¼‰

### 5.2 æ›´æ–°NULLå€¼çš„é—®é¢˜


**åœºæ™¯**ï¼šæƒ³æŠŠé‚®ç®±æ¸…ç©ºï¼ˆè®¾ä¸ºNULLï¼‰

```java
// âŒ è¿™æ ·å†™ä¸ç”Ÿæ•ˆ
User user = new User();
user.setId(1L);
user.setEmail(null);  // æƒ³æ¸…ç©ºé‚®ç®±
userMapper.updateById(user);
// SQL: UPDATE user WHERE id=1  (æ²¡æœ‰SET email=NULL)
```

**åŸå› **ï¼šMyBatis-Plusé»˜è®¤å¿½ç•¥NULLå€¼

### 5.3 è§£å†³æ–¹æ¡ˆ


**æ–¹æ³•ä¸€ï¼šä½¿ç”¨UpdateWrapper.set()**
```java
UpdateWrapper<User> wrapper = new UpdateWrapper<>();
wrapper.eq("id", 1)
       .set("email", null);  // æ˜ç¡®è®¾ç½®ä¸ºNULL

userMapper.update(null, wrapper);
// SQL: UPDATE user SET email=NULL WHERE id=1
```

**æ–¹æ³•äºŒï¼šé…ç½®å­—æ®µç­–ç•¥**
```java
@TableField(updateStrategy = FieldStrategy.IGNORED)
private String email;  // è¿™ä¸ªå­—æ®µæ›´æ–°æ—¶ä¸å¿½ç•¥NULL
```

**æ–¹æ³•ä¸‰ï¼šå…¨å±€é…ç½®**
```yaml
mybatis-plus:
  global-config:
    db-config:
      update-strategy: ignored  # å…¨å±€ä¸å¿½ç•¥NULL
```

> âš ï¸ **æ³¨æ„**ï¼šå…¨å±€é…ç½®ä¼šå½±å“æ‰€æœ‰æ›´æ–°ï¼Œå»ºè®®æŒ‰éœ€ä½¿ç”¨

### 5.4 å­—æ®µç­–ç•¥å¯¹æ¯”


| ç­–ç•¥ | **è¯´æ˜** | **NULLå€¼å¤„ç†** | **ä½¿ç”¨åœºæ™¯** |
|------|---------|---------------|-------------|
| `NOT_NULL` | éç©ºåˆ¤æ–­ | å¿½ç•¥NULL | **é»˜è®¤ç­–ç•¥**ï¼Œå®‰å…¨ |
| `IGNORED` | å¿½ç•¥åˆ¤æ–­ | æ›´æ–°NULL | éœ€è¦æ¸…ç©ºå­—æ®µæ—¶ |
| `NOT_EMPTY` | éç©ºéç©ºä¸² | å¿½ç•¥NULLå’Œ"" | å­—ç¬¦ä¸²å­—æ®µ |
| `NEVER` | ä»ä¸æ›´æ–° | æ°¸ä¸æ›´æ–° | åªè¯»å­—æ®µ |

---

## 6. ğŸ“¦ æ‰¹é‡æ›´æ–°æ“ä½œ


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡æ›´æ–°


**åœºæ™¯å¯¹æ¯”**ï¼š
```
å•æ¡æ›´æ–°ï¼šç»™1000ä¸ªç”¨æˆ·åŠ ç§¯åˆ†
for (User user : users) {
    userMapper.updateById(user);  // æ‰§è¡Œ1000æ¬¡SQL
}
â†’ æ€§èƒ½å·®ï¼Œæ•°æ®åº“å‹åŠ›å¤§

æ‰¹é‡æ›´æ–°ï¼šä¸€æ¬¡æ€§å¤„ç†
userMapper.updateBatchById(users);  // 1æ¬¡æˆ–å°‘é‡SQL
â†’ æ€§èƒ½å¥½ï¼Œæ•ˆç‡é«˜
```

### 6.2 æ‰¹é‡æ›´æ–°å®ç°


**æ–¹å¼ä¸€ï¼šä½¿ç”¨æ‰¹é‡æ›´æ–°æ–¹æ³•**
```java
@Test
public void testBatchUpdate() {
    List<User> users = new ArrayList<>();
    users.add(new User(1L, "å¼ ä¸‰", 25));
    users.add(new User(2L, "æå››", 26));
    users.add(new User(3L, "ç‹äº”", 27));
    
    // æ‰¹é‡æ›´æ–°ï¼ˆéœ€è¦å¼•å…¥æ‰©å±•åŒ…ï¼‰
    userService.updateBatchById(users);
}
```

> ğŸ’¡ **æ³¨æ„**ï¼šéœ€è¦å¼•å…¥`mybatis-plus-extension`ä¾èµ–

**æ–¹å¼äºŒï¼šäº‹åŠ¡æ‰¹å¤„ç†**
```java
@Transactional
public void batchUpdate(List<User> users) {
    for (User user : users) {
        userMapper.updateById(user);
    }
    // åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼Œå‡å°‘ç½‘ç»œå¼€é”€
}
```

### 6.3 æ‰¹é‡æ¡ä»¶æ›´æ–°


```java
// åœºæ™¯ï¼šç»™æ‰€æœ‰VIPç”¨æˆ·å¢åŠ 100ç§¯åˆ†
UpdateWrapper<User> wrapper = new UpdateWrapper<>();
wrapper.eq("user_type", "VIP")
       .setSql("score = score + 100");  // ä½¿ç”¨SQLè¡¨è¾¾å¼

userMapper.update(null, wrapper);
// SQL: UPDATE user SET score = score + 100 WHERE user_type='VIP'
```

**å¸¸ç”¨SQLè¡¨è¾¾å¼**ï¼š
```java
// è‡ªå¢
wrapper.setSql("score = score + 10");

// è‡ªå‡
wrapper.setSql("balance = balance - 100");

// æ‹¼æ¥å­—ç¬¦ä¸²
wrapper.setSql("tags = CONCAT(tags, ',new')");

// å½“å‰æ—¶é—´
wrapper.setSql("update_time = NOW()");
```

---

## 7. ğŸ”’ ä¹è§‚é”æ›´æ–°æœºåˆ¶


### 7.1 ä»€ä¹ˆæ˜¯ä¹è§‚é”


**ç”Ÿæ´»åœºæ™¯ç±»æ¯”**ï¼š
```
ä¸¤ä¸ªäººåŒæ—¶ç¼–è¾‘åŒä¸€ä»½æ–‡æ¡£ï¼š
âŒ æ²¡æœ‰é”ï¼šåä¿å­˜çš„äººè¦†ç›–å‰é¢çš„ä¿®æ”¹ï¼ˆæ•°æ®ä¸¢å¤±ï¼‰
âœ… æœ‰ä¹è§‚é”ï¼šæ£€æµ‹åˆ°å†²çªï¼Œæç¤º"æ–‡æ¡£å·²è¢«ä¿®æ”¹ï¼Œè¯·åˆ·æ–°"
```

**æŠ€æœ¯åŸç†**ï¼š
```
æµç¨‹å›¾ï¼š

è¯»å–æ•°æ®(version=1)
      â†“
ä¿®æ”¹æ•°æ®
      â†“
æäº¤æ—¶æ£€æŸ¥version
      â†“
   æ˜¯å¦=1?
   â†™    â†˜
 æ˜¯      å¦
 â†“       â†“
æ›´æ–°    æç¤ºå†²çª
version+1
```

### 7.2 ä¹è§‚é”é…ç½®


**æ­¥éª¤ä¸€ï¼šæ•°æ®åº“æ·»åŠ ç‰ˆæœ¬å­—æ®µ**
```sql
ALTER TABLE user ADD COLUMN version INT DEFAULT 1;
```

**æ­¥éª¤äºŒï¼šå®ä½“ç±»æ·»åŠ æ³¨è§£**
```java
@TableName("user")
public class User {
    @TableId
    private Long id;
    private String name;
    
    @Version  // ä¹è§‚é”ç‰ˆæœ¬å­—æ®µ
    private Integer version;
}
```

**æ­¥éª¤ä¸‰ï¼šé…ç½®æ’ä»¶**
```java
@Configuration
public class MybatisPlusConfig {
    @Bean
    public MybatisPlusInterceptor optimisticLockerInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
        return interceptor;
    }
}
```

### 7.3 ä¹è§‚é”ä½¿ç”¨


```java
@Test
public void testOptimisticLock() {
    // 1. æŸ¥è¯¢ç”¨æˆ·ï¼ˆè·å–å½“å‰versionï¼‰
    User user = userMapper.selectById(1L);
    System.out.println("å½“å‰ç‰ˆæœ¬ï¼š" + user.getVersion());  // version=1
    
    // 2. ä¿®æ”¹æ•°æ®
    user.setName("æ–°åå­—");
    
    // 3. æ›´æ–°ï¼ˆè‡ªåŠ¨æ£€æŸ¥versionï¼‰
    int rows = userMapper.updateById(user);
    if (rows == 1) {
        System.out.println("æ›´æ–°æˆåŠŸï¼Œæ–°ç‰ˆæœ¬ï¼š" + user.getVersion());  // version=2
    } else {
        System.out.println("æ›´æ–°å¤±è´¥ï¼Œæ•°æ®å·²è¢«ä¿®æ”¹");
    }
}
```

**æ‰§è¡Œçš„SQL**ï¼š
```sql
-- è‡ªåŠ¨æ·»åŠ versionæ¡ä»¶å’Œè‡ªå¢
UPDATE user 
SET name='æ–°åå­—', version=2 
WHERE id=1 AND version=1
```

### 7.4 å¹¶å‘å†²çªå¤„ç†


```java
// æ¨¡æ‹Ÿå¹¶å‘åœºæ™¯
@Test
public void testConcurrentUpdate() {
    // ç”¨æˆ·AæŸ¥è¯¢
    User userA = userMapper.selectById(1L);  // version=1
    
    // ç”¨æˆ·BæŸ¥è¯¢
    User userB = userMapper.selectById(1L);  // version=1
    
    // ç”¨æˆ·Aå…ˆæ›´æ–°
    userA.setName("Aä¿®æ”¹");
    userMapper.updateById(userA);  // æˆåŠŸï¼Œversionå˜ä¸º2
    
    // ç”¨æˆ·Båæ›´æ–°
    userB.setName("Bä¿®æ”¹");
    int rows = userMapper.updateById(userB);  // å¤±è´¥ï¼Œversionä¸åŒ¹é…
    
    if (rows == 0) {
        // å¤„ç†å†²çªï¼šé‡æ–°æŸ¥è¯¢æˆ–æç¤ºç”¨æˆ·
        User latest = userMapper.selectById(1L);
        System.out.println("æ•°æ®å·²è¢«ä¿®æ”¹ï¼Œæœ€æ–°ç‰ˆæœ¬ï¼š" + latest.getVersion());
    }
}
```

### 7.5 ä¹è§‚é”æœ€ä½³å®è·µ


```java
public boolean updateWithRetry(User user, int maxRetry) {
    for (int i = 0; i < maxRetry; i++) {
        // é‡æ–°æŸ¥è¯¢æœ€æ–°æ•°æ®
        User latest = userMapper.selectById(user.getId());
        
        // ä½¿ç”¨æœ€æ–°version
        user.setVersion(latest.getVersion());
        
        // å°è¯•æ›´æ–°
        int rows = userMapper.updateById(user);
        if (rows > 0) {
            return true;  // æ›´æ–°æˆåŠŸ
        }
        
        // æ›´æ–°å¤±è´¥ï¼Œé‡è¯•
        System.out.println("ç¬¬" + (i+1) + "æ¬¡æ›´æ–°å¤±è´¥ï¼Œé‡è¯•ä¸­...");
    }
    return false;  // é‡è¯•æ¬¡æ•°ç”¨å®Œ
}
```

> ğŸ’¡ **ä½¿ç”¨å»ºè®®**ï¼š
> - âœ… é€‚ç”¨äºå¹¶å‘ä¿®æ”¹è¾ƒå°‘çš„åœºæ™¯
> - âœ… é…åˆé‡è¯•æœºåˆ¶ä½¿ç”¨
> - âŒ ä¸é€‚åˆé«˜å¹¶å‘æŠ¢è´­ï¼ˆç”¨æ‚²è§‚é”ï¼‰

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 æ›´æ–°æ–¹å¼é€‰æ‹©æŒ‡å—


```
åœºæ™¯å†³ç­–æ ‘ï¼š

çŸ¥é“IDå—ï¼Ÿ
  â†™      â†˜
 æ˜¯       å¦
 â†“        â†“
å•æ¡?   æ¡ä»¶æ›´æ–°
 â†“     (UpdateWrapper)
æ˜¯  å¦
â†“   â†“
updateById  æ‰¹é‡æ›´æ–°
           (updateBatchById)
```

### 8.2 æ ¸å¿ƒæ–¹æ³•å¯¹æ¯”


| æ–¹æ³• | **ä½¿ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **æ³¨æ„äº‹é¡¹** |
|------|------------|---------|-------------|
| `updateById` | çŸ¥é“IDï¼Œç®€å•ä¿®æ”¹ | ç®€å•ç›´æ¥ | å¿…é¡»è®¾ç½®ID |
| `update + Wrapper` | å¤æ‚æ¡ä»¶ | çµæ´»å¼ºå¤§ | æ³¨æ„SQLæ³¨å…¥ |
| `updateBatchById` | æ‰¹é‡ä¿®æ”¹ | æ€§èƒ½å¥½ | éœ€æ‰©å±•åŒ… |
| `ä¹è§‚é”æ›´æ–°` | å¹¶å‘æ§åˆ¶ | é˜²å†²çª | éœ€versionå­—æ®µ |

### 8.3 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒç‚¹


```
ğŸ”¸ updateByIdï¼šæ ¹æ®IDæ›´æ–°ï¼Œé»˜è®¤åªæ›´æ–°éNULLå­—æ®µ
ğŸ”¸ UpdateWrapperï¼šæ„é€ WHEREæ¡ä»¶å’ŒSETå†…å®¹
ğŸ”¸ é€‰æ‹©æ€§æ›´æ–°ï¼šç†è§£NULLå€¼çš„å¤„ç†ç­–ç•¥
ğŸ”¸ æ‰¹é‡æ›´æ–°ï¼šæå‡å¤§é‡æ•°æ®ä¿®æ”¹çš„æ€§èƒ½
ğŸ”¸ ä¹è§‚é”ï¼šé˜²æ­¢å¹¶å‘ä¿®æ”¹å†²çªï¼Œéœ€é…ç½®@Version
```

### 8.4 å¸¸è§é—®é¢˜è§£å†³


**Q1ï¼šNULLå€¼ä¸ç”Ÿæ•ˆæ€ä¹ˆåŠï¼Ÿ**
```java
// ä½¿ç”¨wrapper.set()æ˜ç¡®è®¾ç½®
wrapper.set("email", null);
```

**Q2ï¼šæ‰¹é‡æ›´æ–°å¤±è´¥ï¼Ÿ**
```java
// æ£€æŸ¥æ˜¯å¦å¼•å…¥æ‰©å±•åŒ…
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-extension</artifactId>
</dependency>
```

**Q3ï¼šä¹è§‚é”ä¸ç”Ÿæ•ˆï¼Ÿ**
```java
// æ£€æŸ¥ä¸‰è¦ç´ ï¼š
// 1. å®ä½“ç±»æœ‰@Version
// 2. é…ç½®äº†ä¹è§‚é”æ’ä»¶
// 3. æŸ¥è¯¢æ—¶è·å–äº†versionå€¼
```

### 8.5 å­¦ä¹ å»ºè®®


**æ–°æ‰‹å­¦ä¹ è·¯å¾„**ï¼š
```
1ï¸âƒ£ å…ˆæŒæ¡updateByIdï¼ˆæœ€ç®€å•ï¼‰
2ï¸âƒ£ å­¦ä¹ UpdateWrapperï¼ˆæ ¸å¿ƒï¼‰
3ï¸âƒ£ äº†è§£é€‰æ‹©æ€§æ›´æ–°ï¼ˆé¿å…å‘ï¼‰
4ï¸âƒ£ å®è·µæ‰¹é‡æ›´æ–°ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
5ï¸âƒ£ æœ€åå­¦ä¹è§‚é”ï¼ˆé«˜çº§ç‰¹æ€§ï¼‰
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
IDæ›´æ–°æœ€ç®€å•ï¼Œæ¡ä»¶æ›´æ–°éœ€Wrapper
NULLé»˜è®¤ä¸æ›´æ–°ï¼Œæ˜ç¡®è®¾ç½®æ‰ç”Ÿæ•ˆ
æ‰¹é‡æ“ä½œææ€§èƒ½ï¼Œä¹è§‚é”é˜²å¹¶å‘å†²çª
```