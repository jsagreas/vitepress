---
title: 62ã€ æ‰¹é‡æ“ä½œåº•å±‚åŸç†ä¸è°ƒä¼˜
---
## ğŸ“š ç›®å½•

1. [æ‰¹é‡æ“ä½œæ ¸å¿ƒæ¦‚å¿µ](#1-æ‰¹é‡æ“ä½œæ ¸å¿ƒæ¦‚å¿µ)
2. [JDBCæ‰¹å¤„ç†åŸç†æœºåˆ¶](#2-JDBCæ‰¹å¤„ç†åŸç†æœºåˆ¶)
3. [æ•°æ®åº“é©±åŠ¨é…ç½®ä¼˜åŒ–](#3-æ•°æ®åº“é©±åŠ¨é…ç½®ä¼˜åŒ–)
4. [æ‰¹é‡å¤§å°æœ€ä½³å®è·µ](#4-æ‰¹é‡å¤§å°æœ€ä½³å®è·µ)
5. [å†…å­˜ä½¿ç”¨æ§åˆ¶ç­–ç•¥](#5-å†…å­˜ä½¿ç”¨æ§åˆ¶ç­–ç•¥)
6. [å¼‚å¸¸å¤„ç†æœºåˆ¶](#6-å¼‚å¸¸å¤„ç†æœºåˆ¶)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ‰¹é‡æ“ä½œæ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ‰¹é‡æ“ä½œ


**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
æ™®é€šæ“ä½œï¼šå»å¿«é€’ç«™å¯„ä»¶ï¼Œå¯„ä¸€ä¸ªåŒ…è£¹æ’ä¸€æ¬¡é˜Ÿ
æ‰¹é‡æ“ä½œï¼šæŠŠ10ä¸ªåŒ…è£¹ä¸€èµ·æ‹¿å»ï¼Œåªæ’ä¸€æ¬¡é˜Ÿå°±å…¨éƒ¨å¯„å®Œ

æ•°æ®åº“ä¹Ÿæ˜¯åŒæ ·é“ç†ï¼š
æ™®é€šæ’å…¥ï¼šæ’å…¥1000æ¡æ•°æ®ï¼Œå‘é€1000æ¬¡è¯·æ±‚
æ‰¹é‡æ’å…¥ï¼šæ’å…¥1000æ¡æ•°æ®ï¼Œåªå‘é€1æ¬¡è¯·æ±‚
```

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âš¡ **æ€§èƒ½æå‡** - å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
- ğŸ”„ **äº‹åŠ¡ä¼˜åŒ–** - ç»Ÿä¸€æäº¤æˆ–å›æ»š
- ğŸ’¾ **èµ„æºèŠ‚çœ** - å‡å°‘æ•°æ®åº“è¿æ¥å¼€é”€

### 1.2 MyBatis-Plusæ‰¹é‡æ“ä½œæ–¹å¼


**å¸¸ç”¨æ–¹æ³•å¯¹æ¯”**ï¼š

| æ–¹æ³• | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `saveBatch` | æ‰¹é‡æ’å…¥ | æ–°å¢å¤šæ¡è®°å½• |
| `saveOrUpdateBatch` | æ‰¹é‡æ’å…¥æˆ–æ›´æ–° | ä¸ç¡®å®šæ•°æ®æ˜¯å¦å­˜åœ¨ |
| `updateBatchById` | æ‰¹é‡æ›´æ–° | æ ¹æ®IDä¿®æ”¹å¤šæ¡è®°å½• |
| `removeBatchByIds` | æ‰¹é‡åˆ é™¤ | æ ¹æ®IDåˆ é™¤å¤šæ¡è®°å½• |

**åŸºç¡€ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// æ‰¹é‡æ’å…¥ç”¨æˆ·æ•°æ®
List<User> users = new ArrayList<>();
users.add(new User("å¼ ä¸‰", 20));
users.add(new User("æå››", 25));
users.add(new User("ç‹äº”", 30));

userService.saveBatch(users);  // ä¸€æ¬¡æ€§æ’å…¥å¤šæ¡
```

---

## 2. ğŸ”§ JDBCæ‰¹å¤„ç†åŸç†æœºåˆ¶


### 2.1 æ‰¹å¤„ç†çš„åº•å±‚å·¥ä½œåŸç†


**æ™®é€šæ‰§è¡Œæ–¹å¼**ï¼š
```
åº”ç”¨ç¨‹åº                     æ•°æ®åº“
   |--å‘é€SQL1--------------->|
   |<-è¿”å›ç»“æœ1---------------|
   |--å‘é€SQL2--------------->|
   |<-è¿”å›ç»“æœ2---------------|
   |--å‘é€SQL3--------------->|
   |<-è¿”å›ç»“æœ3---------------|

é—®é¢˜ï¼šæ¯æ¬¡æ“ä½œéƒ½è¦ç½‘ç»œå¾€è¿”ï¼Œæ…¢ï¼
```

**æ‰¹å¤„ç†æ‰§è¡Œæ–¹å¼**ï¼š
```
åº”ç”¨ç¨‹åº                     æ•°æ®åº“
   |--å‘é€SQL1ã€SQL2ã€SQL3--->|
   |                          | æ‰§è¡Œå…¨éƒ¨SQL
   |<-è¿”å›æ‰¹é‡ç»“æœ------------|

ä¼˜åŠ¿ï¼šä¸€æ¬¡ç½‘ç»œå¾€è¿”æå®šï¼Œå¿«ï¼
```

### 2.2 JDBCæ‰¹å¤„ç†ä¸‰ç§æ¨¡å¼


**ğŸ”¸ Statementæ‰¹å¤„ç†**
```java
// é€‚åˆæ‰§è¡Œä¸åŒçš„SQLè¯­å¥
Statement stmt = conn.createStatement();
stmt.addBatch("INSERT INTO user VALUES(1, 'å¼ ä¸‰')");
stmt.addBatch("INSERT INTO user VALUES(2, 'æå››')");
stmt.addBatch("UPDATE user SET age = 20 WHERE id = 1");
stmt.executeBatch();
```

**ğŸ”¸ PreparedStatementæ‰¹å¤„ç†ï¼ˆæ¨èï¼‰**
```java
// é€‚åˆæ‰§è¡Œç›¸åŒSQLï¼Œåªæ˜¯å‚æ•°ä¸åŒ
PreparedStatement pstmt = conn.prepareStatement(
    "INSERT INTO user(name, age) VALUES(?, ?)"
);

pstmt.setString(1, "å¼ ä¸‰");
pstmt.setInt(2, 20);
pstmt.addBatch();  // æ·»åŠ åˆ°æ‰¹å¤„ç†

pstmt.setString(1, "æå››");
pstmt.setInt(2, 25);
pstmt.addBatch();  // æ·»åŠ åˆ°æ‰¹å¤„ç†

pstmt.executeBatch();  // ä¸€æ¬¡æ€§æ‰§è¡Œ
```

**ä¸¤ç§æ¨¡å¼å¯¹æ¯”**ï¼š
- `Statement`ï¼šçµæ´»ä½†å®‰å…¨æ€§ä½ï¼Œæ˜“SQLæ³¨å…¥
- `PreparedStatement`ï¼šæ€§èƒ½å¥½ä¸”å®‰å…¨ï¼Œ**MyBatis-Plusä½¿ç”¨è¿™ç§**

### 2.3 æ‰¹å¤„ç†çš„æ‰§è¡Œæµç¨‹


```
ç¬¬1æ­¥ï¼šå‡†å¤‡SQLæ¨¡æ¿
   â†“
ç¬¬2æ­¥ï¼šå¾ªç¯æ·»åŠ å‚æ•°åˆ°æ‰¹å¤„ç†é˜Ÿåˆ—
   â†“
ç¬¬3æ­¥ï¼šè°ƒç”¨executeBatch()æ‰§è¡Œ
   â†“
ç¬¬4æ­¥ï¼šæ•°æ®åº“æ‰¹é‡å¤„ç†SQL
   â†“
ç¬¬5æ­¥ï¼šè¿”å›æ¯æ¡SQLçš„æ‰§è¡Œç»“æœ
```

**é‡è¦ç†è§£ç‚¹**ï¼š
> ğŸ’¡ æ‰¹å¤„ç†ä¸æ˜¯æŠŠå¤šæ¡SQLåˆå¹¶æˆä¸€æ¡ï¼Œè€Œæ˜¯æŠŠå¤šæ¡SQLæ‰“åŒ…ä¸€èµ·å‘é€ï¼Œå‡å°‘ç½‘ç»œé€šä¿¡æ¬¡æ•°

---

## 3. âš™ï¸ æ•°æ®åº“é©±åŠ¨é…ç½®ä¼˜åŒ–


### 3.1 rewriteBatchedStatementså‚æ•°è¯¦è§£


**è¿™æ˜¯ä»€ä¹ˆ**ï¼š
- MySQLé©±åŠ¨çš„ä¸€ä¸ªé‡è¦å‚æ•°
- æ§åˆ¶æ˜¯å¦çœŸæ­£å¼€å¯æ‰¹å¤„ç†ä¼˜åŒ–
- **ä¸é…ç½®çš„è¯ï¼Œæ‰¹å¤„ç†å¯èƒ½ä¸ç”Ÿæ•ˆï¼**

**é…ç½®æ–¹å¼**ï¼š
```yaml
# application.ymlé…ç½®
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/test?rewriteBatchedStatements=true
    driver-class-name: com.mysql.cj.jdbc.Driver
```

**ä¸ºä»€ä¹ˆå¿…é¡»é…ç½®**ï¼š

```
ä¸é…ç½®rewriteBatchedStatementsï¼š
INSERT INTO user VALUES(1, 'å¼ ä¸‰');
INSERT INTO user VALUES(2, 'æå››');
INSERT INTO user VALUES(3, 'ç‹äº”');
â†’ æ•°æ®åº“æ‰§è¡Œ3æ¬¡

é…ç½®rewriteBatchedStatements=trueï¼š
INSERT INTO user VALUES(1, 'å¼ ä¸‰'),(2, 'æå››'),(3, 'ç‹äº”');
â†’ æ•°æ®åº“æ‰§è¡Œ1æ¬¡ï¼ˆçœŸæ­£çš„æ‰¹é‡æ’å…¥ï¼‰
```

### 3.2 å…¶ä»–é‡è¦é©±åŠ¨å‚æ•°


**è¿æ¥å‚æ•°é…ç½®è¡¨**ï¼š

| å‚æ•° | ä½œç”¨ | æ¨èå€¼ | è¯´æ˜ |
|------|------|--------|------|
| `rewriteBatchedStatements` | æ‰¹å¤„ç†ä¼˜åŒ– | `true` | ğŸ”¥å¿…é¡»å¼€å¯ |
| `useServerPrepStmts` | æœåŠ¡å™¨ç«¯é¢„å¤„ç† | `true` | æå‡æ€§èƒ½ |
| `cachePrepStmts` | ç¼“å­˜é¢„å¤„ç†è¯­å¥ | `true` | å‡å°‘è§£æå¼€é”€ |
| `prepStmtCacheSize` | ç¼“å­˜å¤§å° | `250` | é»˜è®¤25å¤ªå° |
| `prepStmtCacheSqlLimit` | SQLé•¿åº¦é™åˆ¶ | `2048` | é»˜è®¤256å¤ªå° |

**å®Œæ•´é…ç½®ç¤ºä¾‹**ï¼š
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/test?rewriteBatchedStatements=true&useServerPrepStmts=true&cachePrepStmts=true&prepStmtCacheSize=250&prepStmtCacheSqlLimit=2048
```

### 3.3 ä¸åŒæ•°æ®åº“çš„é…ç½®å·®å¼‚


**MySQLé…ç½®**ï¼š
```properties
# MySQL 8.x
jdbc:mysql://localhost:3306/db?rewriteBatchedStatements=true

# æ³¨æ„ï¼šMySQLæ‰æœ‰è¿™ä¸ªå‚æ•°
```

**PostgreSQLé…ç½®**ï¼š
```properties
# PostgreSQLå¤©ç„¶æ”¯æŒæ‰¹å¤„ç†ï¼Œæ— éœ€ç‰¹æ®Šå‚æ•°
jdbc:postgresql://localhost:5432/db
```

**Oracleé…ç½®**ï¼š
```properties
# Oracleä½¿ç”¨defaultBatchValue
jdbc:oracle:thin:@localhost:1521:orcl?defaultBatchValue=100
```

---

## 4. ğŸ“Š æ‰¹é‡å¤§å°æœ€ä½³å®è·µ


### 4.1 æ‰¹é‡å¤§å°çš„å½±å“


**å¤ªå°çš„é—®é¢˜**ï¼š
- æ‰¹é‡100æ¡ â†’ 1ä¸‡æ¡æ•°æ®éœ€è¦100æ¬¡æ‰¹å¤„ç†
- ç½‘ç»œå¾€è¿”æ¬¡æ•°å¤šï¼Œæ€§èƒ½æå‡æœ‰é™

**å¤ªå¤§çš„é—®é¢˜**ï¼š
- æ‰¹é‡1ä¸‡æ¡ â†’ å ç”¨å¤§é‡å†…å­˜
- å¯èƒ½å¯¼è‡´æ•°æ®åº“è¶…æ—¶æˆ–å†…å­˜æº¢å‡º

**æ€§èƒ½æµ‹è¯•æ•°æ®**ï¼š

```
æ’å…¥10000æ¡æ•°æ®çš„è€—æ—¶å¯¹æ¯”ï¼š

æ‰¹é‡å¤§å°100ï¼š   2.5ç§’  â­â­â­â˜†â˜†
æ‰¹é‡å¤§å°500ï¼š   1.2ç§’  â­â­â­â­â˜†
æ‰¹é‡å¤§å°1000ï¼š  0.8ç§’  â­â­â­â­â­ï¼ˆæ¨èï¼‰
æ‰¹é‡å¤§å°5000ï¼š  0.9ç§’  â­â­â­â­â˜†
æ‰¹é‡å¤§å°10000ï¼š 1.5ç§’  â­â­â­â˜†â˜†ï¼ˆå¯èƒ½è¶…æ—¶ï¼‰
```

### 4.2 æ¨èçš„æ‰¹é‡å¤§å°


**é€šç”¨å»ºè®®**ï¼š

| åœºæ™¯ | æ¨èæ‰¹é‡å¤§å° | åŸå›  |
|------|-------------|------|
| **æ™®é€šæ’å…¥** | 500-1000 | æ€§èƒ½å’Œå†…å­˜çš„å¹³è¡¡ç‚¹ |
| **å¤§å­—æ®µæ’å…¥** | 100-200 | é¿å…å•æ‰¹æ•°æ®è¿‡å¤§ |
| **é«˜å¹¶å‘åœºæ™¯** | 200-500 | å‡å°‘é”ç«äº‰ |
| **ä½é…æœåŠ¡å™¨** | 100-300 | èŠ‚çœå†…å­˜ |

**MyBatis-Plusé…ç½®æ–¹å¼**ï¼š
```java
// æ–¹å¼1ï¼šä½¿ç”¨é»˜è®¤æ‰¹é‡å¤§å°ï¼ˆ1000æ¡ï¼‰
userService.saveBatch(userList);

// æ–¹å¼2ï¼šè‡ªå®šä¹‰æ‰¹é‡å¤§å°ï¼ˆ500æ¡ï¼‰
userService.saveBatch(userList, 500);
```

### 4.3 åˆ†æ‰¹å¤„ç†å¤§æ•°æ®é‡


**åœºæ™¯**ï¼šéœ€è¦æ’å…¥10ä¸‡æ¡æ•°æ®

**é”™è¯¯åšæ³•**ï¼š
```java
// âŒ ä¸€æ¬¡æ€§å¤„ç†10ä¸‡æ¡ï¼Œå¯èƒ½å†…å­˜æº¢å‡º
List<User> bigList = new ArrayList<>();  // 10ä¸‡æ¡æ•°æ®
userService.saveBatch(bigList);
```

**æ­£ç¡®åšæ³•**ï¼š
```java
// âœ… åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹1000æ¡
List<User> allUsers = ...; // 10ä¸‡æ¡æ•°æ®
int batchSize = 1000;

for (int i = 0; i < allUsers.size(); i += batchSize) {
    int end = Math.min(i + batchSize, allUsers.size());
    List<User> batch = allUsers.subList(i, end);
    userService.saveBatch(batch);
}
```

**æ›´ä¼˜é›…çš„åˆ†æ‰¹å·¥å…·**ï¼š
```java
// ä½¿ç”¨Guava Lists.partition
List<List<User>> batches = Lists.partition(allUsers, 1000);
batches.forEach(batch -> userService.saveBatch(batch));
```

---

## 5. ğŸ’¾ å†…å­˜ä½¿ç”¨æ§åˆ¶ç­–ç•¥


### 5.1 å†…å­˜å ç”¨åˆ†æ


**æ‰¹é‡æ“ä½œçš„å†…å­˜æ¶ˆè€—ç‚¹**ï¼š

```
åº”ç”¨ç¨‹åºå†…å­˜ä½¿ç”¨ï¼š

1. Javaå¯¹è±¡å†…å­˜ï¼š
   List<User> å­˜å‚¨åœ¨å †å†…å­˜
   æ¯ä¸ªUserå¯¹è±¡çº¦100-200å­—èŠ‚
   
2. JDBCç¼“å†²åŒºï¼š
   PreparedStatementæ‰¹å¤„ç†ç¼“å†²
   æ¯æ¡SQLçº¦500-1000å­—èŠ‚

3. æ•°æ®åº“è¿æ¥ç¼“å†²ï¼š
   ç½‘ç»œå‘é€ç¼“å†²åŒº
   æ¥æ”¶ç»“æœç¼“å†²åŒº

ç¤ºä¾‹è®¡ç®—ï¼š
1000æ¡User Ã— 150å­—èŠ‚ â‰ˆ 150KBï¼ˆå¯¹è±¡ï¼‰
1000æ¡SQL Ã— 800å­—èŠ‚ â‰ˆ 800KBï¼ˆç¼“å†²ï¼‰
æ€»è®¡çº¦1MBæ¯æ‰¹
```

### 5.2 å†…å­˜ä¼˜åŒ–ç­–ç•¥


**ğŸ”¸ ç­–ç•¥1ï¼šæµå¼å¤„ç†**
```java
// ä¸è¦ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®
// âŒ é”™è¯¯ï¼šä¸€æ¬¡æŸ¥10ä¸‡æ¡
List<User> allUsers = userMapper.selectList(null);

// âœ… æ­£ç¡®ï¼šåˆ†é¡µæŸ¥è¯¢+åˆ†æ‰¹æ’å…¥
int pageSize = 1000;
int pageNum = 1;
while (true) {
    Page<User> page = userMapper.selectPage(
        new Page<>(pageNum, pageSize), null
    );
    if (page.getRecords().isEmpty()) break;
    
    // ç«‹å³å¤„ç†å¹¶é‡Šæ”¾å†…å­˜
    userService.saveBatch(page.getRecords());
    pageNum++;
}
```

**ğŸ”¸ ç­–ç•¥2ï¼šåŠæ—¶é‡Šæ”¾å¼•ç”¨**
```java
List<User> batch = new ArrayList<>();
for (User user : sourceData) {
    batch.add(user);
    
    if (batch.size() == 1000) {
        userService.saveBatch(batch);
        batch.clear();  // æ¸…ç©ºåˆ—è¡¨ï¼Œé‡Šæ”¾å†…å­˜
        batch = new ArrayList<>();  // é‡æ–°åˆ›å»º
    }
}
// å¤„ç†å‰©ä½™æ•°æ®
if (!batch.isEmpty()) {
    userService.saveBatch(batch);
}
```

**ğŸ”¸ ç­–ç•¥3ï¼šç›‘æ§å†…å­˜ä½¿ç”¨**
```java
Runtime runtime = Runtime.getRuntime();
long beforeMemory = runtime.totalMemory() - runtime.freeMemory();

userService.saveBatch(largeList);

long afterMemory = runtime.totalMemory() - runtime.freeMemory();
long usedMemory = (afterMemory - beforeMemory) / 1024 / 1024;
System.out.println("æ‰¹é‡æ“ä½œä½¿ç”¨å†…å­˜ï¼š" + usedMemory + "MB");
```

### 5.3 JVMå‚æ•°è°ƒä¼˜


**å†…å­˜ç›¸å…³å‚æ•°**ï¼š
```bash
# è®¾ç½®å †å†…å­˜å¤§å°
java -Xms1g -Xmx2g -jar app.jar

# ä¼˜åŒ–åƒåœ¾å›æ”¶
java -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -jar app.jar

# ç›‘æ§å†…å­˜ä½¿ç”¨
java -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -jar app.jar
```

---

## 6. âš ï¸ å¼‚å¸¸å¤„ç†æœºåˆ¶


### 6.1 æ‰¹é‡æ“ä½œå¸¸è§å¼‚å¸¸


**å¼‚å¸¸ç±»å‹è¡¨**ï¼š

| å¼‚å¸¸ç±»å‹ | è§¦å‘åŸå›  | å½±å“èŒƒå›´ |
|----------|----------|----------|
| **SQLException** | SQLè¯­æ³•é”™è¯¯ã€çº¦æŸè¿å | æ•´æ‰¹å¤±è´¥ |
| **OutOfMemoryError** | æ‰¹é‡æ•°æ®è¿‡å¤§ | åº”ç”¨å´©æºƒ |
| **TimeoutException** | æ‰§è¡Œè¶…æ—¶ | æ•´æ‰¹å¤±è´¥ |
| **DuplicateKeyException** | ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•å†²çª | æ•´æ‰¹å¤±è´¥ |

### 6.2 æ‰¹é‡å¤±è´¥çš„å¤„ç†ç­–ç•¥


**ğŸ”¸ ç­–ç•¥1ï¼šå…¨éƒ¨å›æ»šï¼ˆé»˜è®¤ï¼‰**
```java
@Transactional
public void saveBatchWithRollback(List<User> users) {
    userService.saveBatch(users);
    // ä»»ä½•ä¸€æ¡å¤±è´¥ï¼Œå…¨éƒ¨å›æ»š
}
```

**ğŸ”¸ ç­–ç•¥2ï¼šéƒ¨åˆ†æˆåŠŸ**
```java
// æ–¹æ¡ˆï¼šé€æ¡å¤„ç†ï¼Œè®°å½•å¤±è´¥
List<User> failedUsers = new ArrayList<>();

for (User user : users) {
    try {
        userService.save(user);
    } catch (Exception e) {
        failedUsers.add(user);
        log.error("æ’å…¥å¤±è´¥ï¼š{}", user.getName(), e);
    }
}

// è¿”å›å¤±è´¥åˆ—è¡¨ç»™è°ƒç”¨æ–¹å¤„ç†
return failedUsers;
```

**ğŸ”¸ ç­–ç•¥3ï¼šåˆ†æ‰¹é‡è¯•**
```java
public void saveBatchWithRetry(List<User> users) {
    int retryCount = 0;
    int maxRetry = 3;
    
    while (retryCount < maxRetry) {
        try {
            userService.saveBatch(users);
            return;  // æˆåŠŸåˆ™è¿”å›
        } catch (Exception e) {
            retryCount++;
            log.warn("æ‰¹é‡æ’å…¥å¤±è´¥ï¼Œç¬¬{}æ¬¡é‡è¯•", retryCount);
            
            if (retryCount >= maxRetry) {
                throw new RuntimeException("æ‰¹é‡æ’å…¥å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°", e);
            }
            
            // ç­‰å¾…åé‡è¯•
            Thread.sleep(1000 * retryCount);
        }
    }
}
```

### 6.3 å¼‚å¸¸è¯Šæ–­æŠ€å·§


**é—®é¢˜1ï¼šæ‰¹é‡æ’å…¥æ…¢**
```
è¯Šæ–­æ­¥éª¤ï¼š
1. æ£€æŸ¥æ˜¯å¦é…ç½®rewriteBatchedStatements=true
2. æŸ¥çœ‹æ‰¹é‡å¤§å°æ˜¯å¦åˆç†ï¼ˆ500-1000ï¼‰
3. æ£€æŸ¥æ•°æ®åº“ç´¢å¼•æ˜¯å¦è¿‡å¤š
4. æŸ¥çœ‹æ•°æ®åº“è¿æ¥æ± é…ç½®
```

**é—®é¢˜2ï¼šå†…å­˜æº¢å‡º**
```
è¯Šæ–­æ­¥éª¤ï¼š
1. æ£€æŸ¥æ‰¹é‡å¤§å°æ˜¯å¦è¿‡å¤§
2. æ˜¯å¦æœ‰å¤§å­—æ®µï¼ˆBLOBã€TEXTï¼‰
3. æ˜¯å¦åˆ†æ‰¹å¤„ç†
4. JVMå †å†…å­˜æ˜¯å¦å……è¶³
```

**é—®é¢˜3ï¼šä¸»é”®å†²çª**
```java
// å¤„ç†æ–¹å¼ï¼šå…ˆæŸ¥è¯¢å†æ’å…¥
List<User> toInsert = users.stream()
    .filter(user -> userService.getById(user.getId()) == null)
    .collect(Collectors.toList());

userService.saveBatch(toInsert);
```

### 6.4 æ—¥å¿—è®°å½•æœ€ä½³å®è·µ


```java
public void saveBatchWithLog(List<User> users) {
    log.info("å¼€å§‹æ‰¹é‡æ’å…¥ï¼Œæ•°é‡ï¼š{}", users.size());
    long startTime = System.currentTimeMillis();
    
    try {
        userService.saveBatch(users, 1000);
        long cost = System.currentTimeMillis() - startTime;
        log.info("æ‰¹é‡æ’å…¥æˆåŠŸï¼Œè€—æ—¶ï¼š{}ms", cost);
    } catch (Exception e) {
        log.error("æ‰¹é‡æ’å…¥å¤±è´¥ï¼Œæ•°æ®é‡ï¼š{}", users.size(), e);
        throw e;
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ‰¹é‡æ“ä½œæœ¬è´¨ï¼šå‡å°‘ç½‘ç»œå¾€è¿”ï¼Œæå‡æ€§èƒ½
ğŸ”¸ JDBCæ‰¹å¤„ç†ï¼šPreparedStatement.addBatch() + executeBatch()
ğŸ”¸ MySQLå¿…é…å‚æ•°ï¼šrewriteBatchedStatements=true
ğŸ”¸ æ¨èæ‰¹é‡å¤§å°ï¼š500-1000æ¡
ğŸ”¸ å†…å­˜æ§åˆ¶ï¼šåˆ†æ‰¹å¤„ç†ï¼ŒåŠæ—¶é‡Šæ”¾
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šäº‹åŠ¡æ§åˆ¶ + é‡è¯•æœºåˆ¶
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ‰¹å¤„ç†ä¸ç­‰äºåˆå¹¶SQL**
```
è¯¯åŒºï¼šä»¥ä¸ºæ‰¹å¤„ç†ä¼šæŠŠSQLåˆå¹¶æˆä¸€æ¡
çœŸç›¸ï¼šæ‰¹å¤„ç†æ˜¯æ‰“åŒ…å‘é€ï¼Œå‡å°‘ç½‘ç»œé€šä¿¡
ä¼˜åŒ–ï¼šé…ç½®rewriteBatchedStatementsæ‰çœŸæ­£åˆå¹¶
```

**ğŸ”¹ æ‰¹é‡å¤§å°çš„æƒè¡¡**
```
å¤ªå°ï¼šç½‘ç»œå¾€è¿”å¤šï¼Œæ€§èƒ½æå‡æœ‰é™
å¤ªå¤§ï¼šå†…å­˜å ç”¨é«˜ï¼Œå¯èƒ½è¶…æ—¶
æœ€ä½³ï¼šæ ¹æ®å®é™…æµ‹è¯•è°ƒæ•´ï¼ˆé€šå¸¸500-1000ï¼‰
```

**ğŸ”¹ å†…å­˜æ§åˆ¶çš„é‡è¦æ€§**
```
å¤§æ•°æ®é‡ï¼šå¿…é¡»åˆ†æ‰¹å¤„ç†
æµå¼å¤„ç†ï¼šè¾¹è¯»è¾¹å¤„ç†ï¼Œä¸ä¸€æ¬¡æ€§åŠ è½½
åŠæ—¶é‡Šæ”¾ï¼šå¤„ç†å®Œç«‹å³æ¸…ç©ºé›†åˆ
```

### 7.3 å®ç”¨é…ç½®æ¨¡æ¿


```yaml
# application.ymlå®Œæ•´é…ç½®
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/db?rewriteBatchedStatements=true&useServerPrepStmts=true&cachePrepStmts=true
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000

mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      logic-delete-value: 1
      logic-not-delete-value: 0
```

### 7.4 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•


- âœ… æ˜¯å¦é…ç½®`rewriteBatchedStatements=true`
- âœ… æ‰¹é‡å¤§å°æ˜¯å¦åœ¨500-1000ä¹‹é—´
- âœ… å¤§æ•°æ®é‡æ˜¯å¦åˆ†æ‰¹å¤„ç†
- âœ… æ˜¯å¦åŠæ—¶é‡Šæ”¾å†…å­˜å¼•ç”¨
- âœ… æ˜¯å¦æ·»åŠ å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶
- âœ… æ˜¯å¦è®°å½•æ€§èƒ½æ—¥å¿—
- âœ… æ•°æ®åº“ç´¢å¼•æ˜¯å¦åˆç†

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æ‰¹é‡æ“ä½œæ€§èƒ½é«˜ï¼Œé…ç½®å‚æ•°ä¸èƒ½å°‘
åˆ†æ‰¹å¤„ç†å†…å­˜çœï¼Œå¼‚å¸¸æ•è·è¦åšå¥½
æ—¥å¿—ç›‘æ§å¾ˆé‡è¦ï¼ŒæŒç»­ä¼˜åŒ–æ•ˆæœå¥½
```