---
title: 57ã€æ•°æ®æƒé™æ§åˆ¶
---
## ğŸ“š ç›®å½•

1. [æ•°æ®æƒé™æ§åˆ¶åŸºç¡€æ¦‚å¿µ](#1-æ•°æ®æƒé™æ§åˆ¶åŸºç¡€æ¦‚å¿µ)
2. [å­—æ®µçº§æƒé™æ§åˆ¶](#2-å­—æ®µçº§æƒé™æ§åˆ¶)
3. [è¡Œçº§æ•°æ®è¿‡æ»¤](#3-è¡Œçº§æ•°æ®è¿‡æ»¤)
4. [æƒé™æ³¨è§£åº”ç”¨](#4-æƒé™æ³¨è§£åº”ç”¨)
5. [åŠ¨æ€æƒé™æ£€æŸ¥](#5-åŠ¨æ€æƒé™æ£€æŸ¥)
6. [æ•°æ®è„±æ•å¤„ç†](#6-æ•°æ®è„±æ•å¤„ç†)
7. [å®¡è®¡æ—¥å¿—è®°å½•](#7-å®¡è®¡æ—¥å¿—è®°å½•)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” æ•°æ®æƒé™æ§åˆ¶åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®æƒé™æ§åˆ¶


**é€šä¿—ç†è§£**ï¼šå°±åƒå…¬å¸é‡Œä¸åŒå²—ä½çš„äººèƒ½çœ‹åˆ°ä¸åŒçš„æ–‡ä»¶ä¸€æ ·

```
åœºæ™¯ä¸¾ä¾‹ï¼š
ğŸ‘” æ€»ç»ç†    â†’ èƒ½çœ‹æ‰€æœ‰éƒ¨é—¨çš„é”€å”®æ•°æ®
ğŸ‘¨â€ğŸ’¼ éƒ¨é—¨ç»ç†  â†’ åªèƒ½çœ‹è‡ªå·±éƒ¨é—¨çš„æ•°æ®
ğŸ‘¤ æ™®é€šå‘˜å·¥  â†’ åªèƒ½çœ‹è‡ªå·±è´Ÿè´£çš„å®¢æˆ·æ•°æ®

è¿™å°±æ˜¯æ•°æ®æƒé™æ§åˆ¶ï¼
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **å­—æ®µçº§æƒé™**ï¼šæ§åˆ¶èƒ½çœ‹åˆ°å“ªäº›å­—æ®µï¼ˆåˆ—ï¼‰
- **è¡Œçº§æƒé™**ï¼šæ§åˆ¶èƒ½çœ‹åˆ°å“ªäº›æ•°æ®ï¼ˆè¡Œï¼‰
- **åŠ¨æ€è¿‡æ»¤**ï¼šæ ¹æ®ç”¨æˆ·èº«ä»½è‡ªåŠ¨è¿‡æ»¤æ•°æ®

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®æƒé™æ§åˆ¶


**å®é™…é—®é¢˜**ï¼š
```
âŒ æ²¡æœ‰æƒé™æ§åˆ¶ï¼š
   å‘˜å·¥AæŸ¥è¯¢å®¢æˆ·åˆ—è¡¨ â†’ çœ‹åˆ°æ‰€æœ‰å®¢æˆ·ä¿¡æ¯
   å‘˜å·¥BæŸ¥è¯¢å®¢æˆ·åˆ—è¡¨ â†’ ä¹Ÿçœ‹åˆ°æ‰€æœ‰å®¢æˆ·ä¿¡æ¯
   é—®é¢˜ï¼šæ•°æ®æ³„éœ²é£é™©ï¼

âœ… æœ‰æƒé™æ§åˆ¶ï¼š
   å‘˜å·¥AæŸ¥è¯¢å®¢æˆ·åˆ—è¡¨ â†’ åªçœ‹åˆ°è‡ªå·±è´Ÿè´£çš„å®¢æˆ·
   å‘˜å·¥BæŸ¥è¯¢å®¢æˆ·åˆ—è¡¨ â†’ åªçœ‹åˆ°è‡ªå·±è´Ÿè´£çš„å®¢æˆ·
   ç»“æœï¼šæ•°æ®å®‰å…¨å¯æ§ï¼
```

### 1.3 MyBatis-Pluså¦‚ä½•å®ç°æƒé™æ§åˆ¶


**å®ç°æ€è·¯**ï¼š
```
ç”¨æˆ·å‘èµ·æŸ¥è¯¢
    â†“
MyBatis-Plusæ‹¦æˆªSQL
    â†“
è‡ªåŠ¨æ·»åŠ æƒé™è¿‡æ»¤æ¡ä»¶
    â†“
è¿”å›æœ‰æƒé™çš„æ•°æ®

åŸå§‹SQLï¼šSELECT * FROM customer
å¤„ç†åï¼šSELECT * FROM customer WHERE user_id = å½“å‰ç”¨æˆ·ID
```

---

## 2. ğŸ“Š å­—æ®µçº§æƒé™æ§åˆ¶


### 2.1 ä»€ä¹ˆæ˜¯å­—æ®µçº§æƒé™


**ç®€å•ç†è§£**ï¼šå°±æ˜¯æ§åˆ¶æŸäº›æ•æ„Ÿå­—æ®µåªæœ‰ç‰¹å®šäººèƒ½çœ‹åˆ°

```
å‘˜å·¥ä¿¡æ¯è¡¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å§“å  â”‚  èŒä½   â”‚   å·¥èµ„   â”‚  èº«ä»½è¯ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¼ ä¸‰  â”‚ ç¨‹åºå‘˜ â”‚ Â¥15000  â”‚ 6101.. â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æƒé™è®¾ç½®ï¼š
ğŸ‘¤ æ™®é€šHR â†’ èƒ½çœ‹ å§“åã€èŒä½
ğŸ‘” è´¢åŠ¡   â†’ èƒ½çœ‹ å§“åã€èŒä½ã€å·¥èµ„
ğŸ”‘ é¢†å¯¼   â†’ èƒ½çœ‹ æ‰€æœ‰å­—æ®µ
```

### 2.2 ä½¿ç”¨@TableFieldæ§åˆ¶å­—æ®µ


**åŸºç¡€ç”¨æ³•**ï¼š
```java
@Data
@TableName("employee")
public class Employee {
    private Long id;
    private String name;
    
    // select=false è¡¨ç¤ºæŸ¥è¯¢æ—¶ä¸è¿”å›æ­¤å­—æ®µ
    @TableField(select = false)
    private String idCard;
    
    @TableField(select = false)
    private BigDecimal salary;
}
```

> ğŸ’¡ **æ–°æ‰‹æç¤º**ï¼š`select=false`å°±åƒæ˜¯ç»™å­—æ®µåŠ äº†ä¸€æŠŠé”ï¼Œé»˜è®¤æŸ¥è¯¢æ—¶ä¸ä¼šè¿”å›è¿™ä¸ªå­—æ®µ

### 2.3 åŠ¨æ€å­—æ®µè¿‡æ»¤å®ç°


**å®ç°æ–¹å¼**ï¼šè‡ªå®šä¹‰æ‹¦æˆªå™¨
```java
@Component
@Intercepts({
    @Signature(type = Executor.class, method = "query", 
               args = {MappedStatement.class, Object.class, 
                       RowBounds.class, ResultHandler.class})
})
public class FieldPermissionInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // 1. è·å–å½“å‰ç”¨æˆ·è§’è‰²
        String userRole = SecurityUtils.getCurrentUserRole();
        
        // 2. æ ¹æ®è§’è‰²è¿‡æ»¤å­—æ®µ
        if ("NORMAL_USER".equals(userRole)) {
            // æ™®é€šç”¨æˆ·ç§»é™¤æ•æ„Ÿå­—æ®µ
            removeSensitiveFields(invocation);
        }
        
        // 3. æ‰§è¡ŒæŸ¥è¯¢
        return invocation.proceed();
    }
}
```

**é…ç½®è§’è‰²å­—æ®µæ˜ å°„**ï¼š
```java
@Configuration
public class FieldPermissionConfig {
    
    // å®šä¹‰ä¸åŒè§’è‰²èƒ½çœ‹åˆ°çš„å­—æ®µ
    private static final Map<String, List<String>> ROLE_FIELDS = Map.of(
        "ADMIN", List.of("*"),  // ç®¡ç†å‘˜çœ‹æ‰€æœ‰å­—æ®µ
        "MANAGER", List.of("id", "name", "salary"),
        "NORMAL", List.of("id", "name")  // æ™®é€šç”¨æˆ·åªçœ‹åŸºç¡€å­—æ®µ
    );
    
    public List<String> getAllowedFields(String role) {
        return ROLE_FIELDS.getOrDefault(role, List.of("id", "name"));
    }
}
```

---

## 3. ğŸ¯ è¡Œçº§æ•°æ®è¿‡æ»¤


### 3.1 ä»€ä¹ˆæ˜¯è¡Œçº§è¿‡æ»¤


**é€šä¿—è§£é‡Š**ï¼šå°±æ˜¯è®©ä¸åŒç”¨æˆ·çœ‹åˆ°ä¸åŒçš„æ•°æ®è¡Œ

```
å®¢æˆ·æ•°æ®è¡¨ï¼š
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID â”‚ å®¢æˆ·  â”‚ è´Ÿè´£äºº   â”‚  éƒ¨é—¨    â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ Aå…¬å¸ â”‚  å¼ ä¸‰    â”‚ é”€å”®ä¸€éƒ¨ â”‚
â”‚ 2  â”‚ Bå…¬å¸ â”‚  æå››    â”‚ é”€å”®äºŒéƒ¨ â”‚
â”‚ 3  â”‚ Cå…¬å¸ â”‚  å¼ ä¸‰    â”‚ é”€å”®ä¸€éƒ¨ â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¼ ä¸‰ç™»å½• â†’ åªçœ‹åˆ° 1ã€3 ä¸¤æ¡è®°å½•ï¼ˆè´Ÿè´£äºº=å¼ ä¸‰ï¼‰
æå››ç™»å½• â†’ åªçœ‹åˆ° 2 ä¸€æ¡è®°å½•ï¼ˆè´Ÿè´£äºº=æå››ï¼‰
```

### 3.2 ä½¿ç”¨æ’ä»¶å®ç°è¡Œçº§è¿‡æ»¤


**æ ¸å¿ƒæ’ä»¶**ï¼šDataPermissionInterceptor

```java
@Bean
public DataPermissionInterceptor dataPermissionInterceptor() {
    return new DataPermissionInterceptor(new DataPermissionHandler() {
        
        @Override
        public Expression getSqlSegment(Expression where, String mappedStatementId) {
            // 1. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            Long userId = SecurityUtils.getCurrentUserId();
            String userRole = SecurityUtils.getCurrentUserRole();
            
            // 2. æ ¹æ®è§’è‰²æ·»åŠ è¿‡æ»¤æ¡ä»¶
            if ("ADMIN".equals(userRole)) {
                return where;  // ç®¡ç†å‘˜ä¸è¿‡æ»¤
            }
            
            // 3. æ™®é€šç”¨æˆ·åªèƒ½çœ‹è‡ªå·±çš„æ•°æ®
            Expression userFilter = new EqualsTo(
                new Column("user_id"), 
                new LongValue(userId)
            );
            
            // 4. ç»„åˆåŸæœ‰æ¡ä»¶
            return where == null ? userFilter : new AndExpression(where, userFilter);
        }
    });
}
```

> ğŸ“ **å·¥ä½œåŸç†**ï¼š
> 1. æ‹¦æˆªSQLè¯­å¥
> 2. è‡ªåŠ¨æ·»åŠ `WHERE user_id = å½“å‰ç”¨æˆ·ID`
> 3. ç”¨æˆ·çœ‹åˆ°çš„å°±æ˜¯è¿‡æ»¤åçš„æ•°æ®

### 3.3 å¤šç»´åº¦æ•°æ®è¿‡æ»¤


**å¤æ‚åœºæ™¯**ï¼šéƒ¨é—¨+ä¸ªäººåŒé‡è¿‡æ»¤

| è§’è‰²ç±»å‹ | è¿‡æ»¤è§„åˆ™ | SQLæ¡ä»¶ç¤ºä¾‹ |
|---------|---------|------------|
| ğŸ”‘ **è¶…çº§ç®¡ç†å‘˜** | `æ— è¿‡æ»¤` | `æ— é¢å¤–æ¡ä»¶` |
| ğŸ‘” **éƒ¨é—¨ç»ç†** | `æœ¬éƒ¨é—¨æ•°æ®` | `dept_id = å½“å‰éƒ¨é—¨ID` |
| ğŸ‘¤ **æ™®é€šå‘˜å·¥** | `ä¸ªäººæ•°æ®` | `user_id = å½“å‰ç”¨æˆ·ID` |
| ğŸ” **æ•°æ®åˆ†æå¸ˆ** | `åªè¯»æƒé™` | `status = 'public'` |

**å®ç°ä»£ç **ï¼š
```java
public Expression buildFilterCondition(User currentUser) {
    List<Expression> conditions = new ArrayList<>();
    
    // éƒ¨é—¨è¿‡æ»¤
    if (currentUser.isDeptManager()) {
        conditions.add(new EqualsTo(
            new Column("dept_id"), 
            new LongValue(currentUser.getDeptId())
        ));
    }
    
    // ä¸ªäººè¿‡æ»¤
    if (currentUser.isNormalUser()) {
        conditions.add(new EqualsTo(
            new Column("user_id"), 
            new LongValue(currentUser.getId())
        ));
    }
    
    // ç»„åˆæ¡ä»¶ï¼ˆç”¨ORè¿æ¥ï¼‰
    return conditions.stream()
        .reduce((a, b) -> new OrExpression(a, b))
        .orElse(null);
}
```

---

## 4. ğŸ·ï¸ æƒé™æ³¨è§£åº”ç”¨


### 4.1 è‡ªå®šä¹‰æƒé™æ³¨è§£


**åˆ›å»ºæ³¨è§£**ï¼š
```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface DataPermission {
    
    // æƒé™ç±»å‹
    PermissionType value() default PermissionType.USER;
    
    // è¿‡æ»¤å­—æ®µ
    String filterColumn() default "user_id";
    
    // æ˜¯å¦å¯ç”¨
    boolean enabled() default true;
}

// æƒé™ç±»å‹æšä¸¾
public enum PermissionType {
    USER,      // ç”¨æˆ·çº§åˆ«
    DEPT,      // éƒ¨é—¨çº§åˆ«
    CUSTOM     // è‡ªå®šä¹‰
}
```

### 4.2 æ³¨è§£ä½¿ç”¨ç¤ºä¾‹


**åœ¨Mapperä¸Šä½¿ç”¨**ï¼š
```java
@Mapper
public interface CustomerMapper extends BaseMapper<Customer> {
    
    // æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤ä¸ºå½“å‰ç”¨æˆ·çš„æ•°æ®
    @DataPermission(value = PermissionType.USER, filterColumn = "owner_id")
    List<Customer> selectMyCustomers();
    
    // éƒ¨é—¨çº§åˆ«è¿‡æ»¤
    @DataPermission(value = PermissionType.DEPT, filterColumn = "dept_id")
    List<Customer> selectDeptCustomers();
    
    // ä¸å¯ç”¨æƒé™è¿‡æ»¤ï¼ˆç®¡ç†å‘˜æ¥å£ï¼‰
    @DataPermission(enabled = false)
    List<Customer> selectAllCustomers();
}
```

### 4.3 æ³¨è§£è§£æå™¨å®ç°


```java
@Aspect
@Component
public class DataPermissionAspect {
    
    @Around("@annotation(dataPermission)")
    public Object around(ProceedingJoinPoint point, DataPermission dataPermission) throws Throwable {
        
        if (!dataPermission.enabled()) {
            return point.proceed();  // ä¸å¯ç”¨åˆ™ç›´æ¥æ‰§è¡Œ
        }
        
        try {
            // 1. è®¾ç½®æƒé™ä¸Šä¸‹æ–‡
            DataPermissionContext.set(dataPermission);
            
            // 2. æ‰§è¡Œæ–¹æ³•ï¼ˆæ­¤æ—¶æ‹¦æˆªå™¨ä¼šè¯»å–ä¸Šä¸‹æ–‡ï¼‰
            return point.proceed();
            
        } finally {
            // 3. æ¸…ç†ä¸Šä¸‹æ–‡
            DataPermissionContext.remove();
        }
    }
}
```

> âš ï¸ **é‡è¦æé†’**ï¼šä½¿ç”¨æ³¨è§£æ—¶è¦æ³¨æ„æ¸…ç†ThreadLocalï¼Œé¿å…å†…å­˜æ³„æ¼

---

## 5. ğŸ”„ åŠ¨æ€æƒé™æ£€æŸ¥


### 5.1 ä»€ä¹ˆæ˜¯åŠ¨æ€æƒé™æ£€æŸ¥


**åœºæ™¯è¯´æ˜**ï¼š
```
ç”¨æˆ·æƒé™ä¼šå˜åŒ–ï¼š
æ—¶é—´1ï¼šå¼ ä¸‰æ˜¯æ™®é€šå‘˜å·¥ â†’ åªèƒ½çœ‹è‡ªå·±çš„æ•°æ®
æ—¶é—´2ï¼šå¼ ä¸‰å‡èŒä¸ºç»ç† â†’ èƒ½çœ‹æ•´ä¸ªéƒ¨é—¨çš„æ•°æ®

åŠ¨æ€æƒé™æ£€æŸ¥å°±æ˜¯å®æ—¶è¯»å–ç”¨æˆ·æœ€æ–°æƒé™çŠ¶æ€
```

### 5.2 å®æ—¶æƒé™è·å–


**æƒé™ä¸Šä¸‹æ–‡ç®¡ç†**ï¼š
```java
@Component
public class PermissionContext {
    
    private static final ThreadLocal<UserPermission> PERMISSION_HOLDER = 
        new ThreadLocal<>();
    
    // åŠ è½½ç”¨æˆ·æƒé™
    public static UserPermission loadUserPermission() {
        Long userId = SecurityUtils.getCurrentUserId();
        
        // ä»Redisç¼“å­˜è·å–ï¼ˆé¿å…é¢‘ç¹æŸ¥åº“ï¼‰
        UserPermission permission = redisTemplate.opsForValue()
            .get("user:permission:" + userId);
            
        if (permission == null) {
            // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
            permission = permissionService.getUserPermission(userId);
            // å†™å…¥ç¼“å­˜ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
            redisTemplate.opsForValue()
                .set("user:permission:" + userId, permission, 5, TimeUnit.MINUTES);
        }
        
        PERMISSION_HOLDER.set(permission);
        return permission;
    }
    
    // è·å–å½“å‰æƒé™
    public static UserPermission get() {
        return PERMISSION_HOLDER.get();
    }
    
    // æ¸…ç†
    public static void remove() {
        PERMISSION_HOLDER.remove();
    }
}
```

### 5.3 æƒé™å˜æ›´å®æ—¶ç”Ÿæ•ˆ


**æµç¨‹å›¾ç¤º**ï¼š
```
ç”¨æˆ·æƒé™å˜æ›´
    â†“
æ¸…é™¤Redisç¼“å­˜
    â†“
ä¸‹æ¬¡è¯·æ±‚æ—¶é‡æ–°åŠ è½½
    â†“
æ–°æƒé™ç«‹å³ç”Ÿæ•ˆ
```

**å®ç°ä»£ç **ï¼š
```java
@Service
public class PermissionService {
    
    // æ›´æ–°ç”¨æˆ·æƒé™
    public void updateUserPermission(Long userId, UserPermission newPermission) {
        // 1. æ›´æ–°æ•°æ®åº“
        permissionMapper.updateById(newPermission);
        
        // 2. æ¸…é™¤ç¼“å­˜ï¼ˆé‡è¦ï¼ï¼‰
        redisTemplate.delete("user:permission:" + userId);
        
        // 3. å‘é€æƒé™å˜æ›´äº‹ä»¶
        eventPublisher.publishEvent(new PermissionChangeEvent(userId));
    }
}
```

---

## 6. ğŸ­ æ•°æ®è„±æ•å¤„ç†


### 6.1 ä»€ä¹ˆæ˜¯æ•°æ®è„±æ•


**é€šä¿—ç†è§£**ï¼šå°±æ˜¯æŠŠæ•æ„Ÿä¿¡æ¯éšè—èµ·æ¥ï¼Œåªæ˜¾ç¤ºéƒ¨åˆ†å†…å®¹

```
åŸå§‹æ•°æ®ï¼š     è„±æ•åï¼š
æ‰‹æœºå· 13812345678  â†’  138****5678
èº«ä»½è¯ 610123199001011234  â†’  6101**********1234
é“¶è¡Œå¡ 6222021234567890  â†’  6222************7890
```

### 6.2 ä½¿ç”¨æ³¨è§£å®ç°è„±æ•


**å®šä¹‰è„±æ•æ³¨è§£**ï¼š
```java
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Desensitize {
    
    // è„±æ•ç±»å‹
    DesensitizeType type() default DesensitizeType.CUSTOM;
    
    // è‡ªå®šä¹‰è„±æ•è§„åˆ™
    String regex() default "";
    String replacement() default "****";
}

public enum DesensitizeType {
    PHONE,      // æ‰‹æœºå·
    ID_CARD,    // èº«ä»½è¯
    BANK_CARD,  // é“¶è¡Œå¡
    EMAIL,      // é‚®ç®±
    CUSTOM      // è‡ªå®šä¹‰
}
```

**åœ¨å®ä½“ç±»ä½¿ç”¨**ï¼š
```java
@Data
public class User {
    private Long id;
    private String name;
    
    @Desensitize(type = DesensitizeType.PHONE)
    private String phone;
    
    @Desensitize(type = DesensitizeType.ID_CARD)
    private String idCard;
    
    @Desensitize(type = DesensitizeType.EMAIL)
    private String email;
}
```

### 6.3 è„±æ•å¤„ç†å™¨å®ç°


**æ ¸å¿ƒå¤„ç†é€»è¾‘**ï¼š
```java
@Component
public class DesensitizeHandler {
    
    public String desensitize(String value, DesensitizeType type) {
        if (StringUtils.isBlank(value)) {
            return value;
        }
        
        switch (type) {
            case PHONE:
                // æ‰‹æœºå·ï¼šä¿ç•™å‰3å4ä½
                return value.replaceAll("(\\d{3})\\d{4}(\\d{4})", "$1****$2");
                
            case ID_CARD:
                // èº«ä»½è¯ï¼šä¿ç•™å‰4å4ä½
                return value.replaceAll("(\\d{4})\\d{10}(\\d{4})", "$1**********$2");
                
            case BANK_CARD:
                // é“¶è¡Œå¡ï¼šåªæ˜¾ç¤ºå4ä½
                return value.replaceAll("\\d{12}(\\d{4})", "************$1");
                
            case EMAIL:
                // é‚®ç®±ï¼šéšè—@å‰çš„éƒ¨åˆ†å­—ç¬¦
                return value.replaceAll("(\\w{2})\\w+(\\w@.*)", "$1****$2");
                
            default:
                return value;
        }
    }
}
```

**è„±æ•æ‹¦æˆªå™¨**ï¼š
```java
@Component
public class DesensitizeInterceptor implements ResultSetHandler {
    
    @Override
    public List<Object> handleResultSets(Statement stmt) throws SQLException {
        List<Object> results = new ArrayList<>();
        ResultSet rs = stmt.getResultSet();
        
        while (rs.next()) {
            Object obj = // ... æ˜ å°„å¯¹è±¡
            
            // éå†å­—æ®µï¼Œå¤„ç†å¸¦@Desensitizeæ³¨è§£çš„å­—æ®µ
            for (Field field : obj.getClass().getDeclaredFields()) {
                Desensitize anno = field.getAnnotation(Desensitize.class);
                if (anno != null) {
                    field.setAccessible(true);
                    String value = (String) field.get(obj);
                    String desensitized = desensitizeHandler.desensitize(value, anno.type());
                    field.set(obj, desensitized);
                }
            }
            results.add(obj);
        }
        return results;
    }
}
```

> ğŸ’¡ **å®ç”¨æŠ€å·§**ï¼šè„±æ•åªåœ¨æŸ¥è¯¢æ—¶å¤„ç†ï¼Œå­˜å‚¨æ—¶ä¿å­˜åŸå§‹æ•°æ®ï¼Œè¿™æ ·ä¸å½±å“ä¸šåŠ¡é€»è¾‘

---

## 7. ğŸ“ å®¡è®¡æ—¥å¿—è®°å½•


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦å®¡è®¡æ—¥å¿—


**å®é™…éœ€æ±‚**ï¼š
```
æ•°æ®å®‰å…¨è¦æ±‚ï¼š
â“ è°åœ¨ä»€ä¹ˆæ—¶é—´è®¿é—®äº†ä»€ä¹ˆæ•°æ®ï¼Ÿ
â“ æ•°æ®è¢«è°ä¿®æ”¹äº†ï¼Ÿ
â“ æ•æ„Ÿæ“ä½œçš„å®Œæ•´è®°å½•ï¼Ÿ

å®¡è®¡æ—¥å¿—å°±æ˜¯è®°å½•è¿™äº›æ“ä½œçš„"é»‘åŒ£å­"
```

### 7.2 å®¡è®¡æ—¥å¿—è®¾è®¡


**æ—¥å¿—è¡¨ç»“æ„**ï¼š
```sql
CREATE TABLE audit_log (
    id BIGINT PRIMARY KEY,
    user_id BIGINT COMMENT 'æ“ä½œäººID',
    user_name VARCHAR(50) COMMENT 'æ“ä½œäººå§“å',
    operation VARCHAR(50) COMMENT 'æ“ä½œç±»å‹',
    table_name VARCHAR(50) COMMENT 'è¡¨å',
    record_id BIGINT COMMENT 'è®°å½•ID',
    old_value TEXT COMMENT 'ä¿®æ”¹å‰å€¼',
    new_value TEXT COMMENT 'ä¿®æ”¹åå€¼',
    ip_address VARCHAR(50) COMMENT 'IPåœ°å€',
    create_time DATETIME COMMENT 'æ“ä½œæ—¶é—´'
);
```

**æ—¥å¿—å†…å®¹ç¤ºä¾‹**ï¼š
| æ“ä½œäºº | æ“ä½œ | è¡¨å | è®°å½•ID | ä¿®æ”¹å†…å®¹ | æ—¶é—´ |
|-------|------|------|--------|---------|------|
| å¼ ä¸‰ | UPDATE | customer | 101 | æ‰‹æœºå·:138..â†’139.. | 2025-09-23 10:30 |
| æå›› | SELECT | employee | - | æŸ¥è¯¢å·¥èµ„å­—æ®µ | 2025-09-23 10:35 |

### 7.3 è‡ªåŠ¨å®¡è®¡å®ç°


**å®¡è®¡æ‹¦æˆªå™¨**ï¼š
```java
@Component
@Intercepts({
    @Signature(type = Executor.class, method = "update", 
               args = {MappedStatement.class, Object.class}),
    @Signature(type = Executor.class, method = "query",
               args = {MappedStatement.class, Object.class, 
                       RowBounds.class, ResultHandler.class})
})
public class AuditLogInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // 1. è·å–SQLä¿¡æ¯
        MappedStatement ms = (MappedStatement) invocation.getArgs()[0];
        String sqlId = ms.getId();
        SqlCommandType sqlType = ms.getSqlCommandType();
        
        // 2. è®°å½•æ“ä½œæ—¥å¿—
        AuditLog log = new AuditLog();
        log.setUserId(SecurityUtils.getCurrentUserId());
        log.setUserName(SecurityUtils.getCurrentUserName());
        log.setOperation(sqlType.name());
        log.setIpAddress(RequestUtils.getIpAddress());
        log.setCreateTime(LocalDateTime.now());
        
        // 3. é’ˆå¯¹æ•æ„Ÿæ“ä½œè®°å½•è¯¦ç»†ä¿¡æ¯
        if (isSensitiveOperation(sqlId)) {
            recordDetailInfo(log, invocation);
        }
        
        // 4. å¼‚æ­¥ä¿å­˜æ—¥å¿—ï¼ˆä¸å½±å“ä¸»ä¸šåŠ¡ï¼‰
        asyncSaveLog(log);
        
        // 5. æ‰§è¡ŒåŸæ–¹æ³•
        return invocation.proceed();
    }
    
    private boolean isSensitiveOperation(String sqlId) {
        // åˆ¤æ–­æ˜¯å¦ä¸ºæ•æ„Ÿæ“ä½œ
        return sqlId.contains("salary") || 
               sqlId.contains("password") ||
               sqlId.contains("idCard");
    }
}
```

### 7.4 å®¡è®¡æ—¥å¿—æŸ¥è¯¢


**æ—¥å¿—åˆ†ææ¥å£**ï¼š
```java
@RestController
@RequestMapping("/audit")
public class AuditLogController {
    
    // æŸ¥è¯¢æŸç”¨æˆ·çš„æ“ä½œè®°å½•
    @GetMapping("/user/{userId}")
    public List<AuditLog> getUserLogs(@PathVariable Long userId) {
        return auditLogService.lambdaQuery()
            .eq(AuditLog::getUserId, userId)
            .orderByDesc(AuditLog::getCreateTime)
            .last("LIMIT 100")
            .list();
    }
    
    // æŸ¥è¯¢æ•æ„Ÿæ“ä½œè®°å½•
    @GetMapping("/sensitive")
    public List<AuditLog> getSensitiveLogs() {
        return auditLogService.lambdaQuery()
            .in(AuditLog::getOperation, "UPDATE", "DELETE")
            .like(AuditLog::getTableName, "employee")
            .orderByDesc(AuditLog::getCreateTime)
            .list();
    }
}
```

> ğŸ“Š **æœ€ä½³å®è·µ**ï¼š
> - å¼‚æ­¥è®°å½•æ—¥å¿—ï¼ˆä¸å½±å“ä¸šåŠ¡æ€§èƒ½ï¼‰
> - å®šæœŸå½’æ¡£å†å²æ—¥å¿—ï¼ˆæŒ‰æœˆå½’æ¡£ï¼‰
> - æ•æ„Ÿæ“ä½œå•ç‹¬æ ‡è®°ï¼ˆä¾¿äºå®¡è®¡ï¼‰

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ•°æ®æƒé™æ§åˆ¶ï¼šé™åˆ¶ç”¨æˆ·èƒ½çœ‹åˆ°çš„æ•°æ®èŒƒå›´
ğŸ”¸ å­—æ®µçº§æƒé™ï¼šæ§åˆ¶èƒ½æŸ¥è¯¢çš„å­—æ®µï¼ˆåˆ—ï¼‰
ğŸ”¸ è¡Œçº§æƒé™ï¼šæ§åˆ¶èƒ½æŸ¥è¯¢çš„æ•°æ®ï¼ˆè¡Œï¼‰
ğŸ”¸ æ•°æ®è„±æ•ï¼šéšè—æ•æ„Ÿä¿¡æ¯ï¼Œä¿æŠ¤éšç§
ğŸ”¸ å®¡è®¡æ—¥å¿—ï¼šè®°å½•æ‰€æœ‰æ•°æ®æ“ä½œï¼Œä¾¿äºè¿½æº¯
```

### 8.2 æƒé™æ§åˆ¶å®ç°æ–¹å¼å¯¹æ¯”


| å®ç°æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|---------|
| **æ‹¦æˆªå™¨** | `çµæ´»ã€é€šç”¨` | `éœ€è¦ç¼–å†™ä»£ç ` | `å¤æ‚æƒé™é€»è¾‘` |
| **æ³¨è§£** | `ç®€å•ã€ç›´è§‚` | `ä¸å¤Ÿçµæ´»` | `å›ºå®šæƒé™è§„åˆ™` |
| **MyBatis-Plusæ’ä»¶** | `å¼€ç®±å³ç”¨` | `å®šåˆ¶æ€§å·®` | `æ ‡å‡†æƒé™åœºæ™¯` |
| **AOPåˆ‡é¢** | `ç»Ÿä¸€ç®¡ç†` | `æ€§èƒ½å¼€é”€` | `å®¡è®¡æ—¥å¿—è®°å½•` |

### 8.3 å®æ–½å»ºè®®å’Œæœ€ä½³å®è·µ


**ğŸ¯ å®æ–½æ­¥éª¤**ï¼š
```
ç¬¬1æ­¥ï¼šæ¢³ç†æƒé™éœ€æ±‚
      â†“
ç¬¬2æ­¥ï¼šè®¾è®¡æƒé™æ¨¡å‹ï¼ˆç”¨æˆ·-è§’è‰²-æƒé™ï¼‰
      â†“
ç¬¬3æ­¥ï¼šå®ç°åŸºç¡€è¿‡æ»¤åŠŸèƒ½
      â†“
ç¬¬4æ­¥ï¼šæ·»åŠ è„±æ•å’Œå®¡è®¡
      â†“
ç¬¬5æ­¥ï¼šæ€§èƒ½ä¼˜åŒ–å’Œæµ‹è¯•
```

**âš ï¸ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ**ï¼š

> **é—®é¢˜1**ï¼šæƒé™è¿‡æ»¤å¯¼è‡´æ€§èƒ½ä¸‹é™
> - âœ… ä½¿ç”¨Redisç¼“å­˜æƒé™ä¿¡æ¯
> - âœ… é¿å…åœ¨å¾ªç¯ä¸­æŸ¥è¯¢æƒé™
> - âœ… åˆç†ä½¿ç”¨ç´¢å¼•

> **é—®é¢˜2**ï¼šæƒé™å˜æ›´ä¸åŠæ—¶ç”Ÿæ•ˆ
> - âœ… æ¸…é™¤ç¼“å­˜æœºåˆ¶
> - âœ… ä½¿ç”¨äº‹ä»¶é€šçŸ¥
> - âœ… è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´

> **é—®é¢˜3**ï¼šå®¡è®¡æ—¥å¿—å½±å“æ€§èƒ½
> - âœ… å¼‚æ­¥è®°å½•æ—¥å¿—
> - âœ… æ‰¹é‡æ’å…¥ä¼˜åŒ–
> - âœ… å®šæœŸå½’æ¡£å†å²æ•°æ®

**ğŸ”§ å¼€å‘å»ºè®®**ï¼š

1. **æƒé™è®¾è®¡è¦ç»†åŒ–**
   - åŒºåˆ†æŸ¥è¯¢ã€ä¿®æ”¹ã€åˆ é™¤æƒé™
   - æ”¯æŒä¸´æ—¶æˆæƒæœºåˆ¶
   - è®°å½•æƒé™å˜æ›´å†å²

2. **è„±æ•è§„åˆ™è¦çµæ´»**
   - æ”¯æŒè‡ªå®šä¹‰è„±æ•è§„åˆ™
   - ä¸åŒè§’è‰²ä¸åŒè„±æ•çº§åˆ«
   - å¯¼å‡ºæ•°æ®è‡ªåŠ¨è„±æ•

3. **å®¡è®¡æ—¥å¿—è¦å®Œæ•´**
   - è®°å½•æ“ä½œå‰åå¯¹æ¯”
   - ä¿ç•™å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
   - æ”¯æŒæ—¥å¿—æ£€ç´¢å’Œåˆ†æ

**æ ¸å¿ƒè®°å¿†**ï¼š
- æ•°æ®æƒé™ä¿å®‰å…¨ï¼Œå­—æ®µè¡Œçº§åŒæ§åˆ¶
- è„±æ•å®¡è®¡è¦è®°å½•ï¼Œç¼“å­˜ä¼˜åŒ–æ€§èƒ½å¥½
- æƒé™å˜æ›´è¦åŠæ—¶ï¼Œå¼‚æ­¥å¤„ç†ä¸é˜»å¡