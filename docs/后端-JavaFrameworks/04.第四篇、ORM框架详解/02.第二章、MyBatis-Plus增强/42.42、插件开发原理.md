---
title: 42ã€æ’ä»¶å¼€å‘åŸç†
---
## ğŸ“š ç›®å½•

1. [æ’ä»¶ä½“ç³»æ¦‚è¿°](#1-æ’ä»¶ä½“ç³»æ¦‚è¿°)
2. [InnerInterceptoræ¥å£è¯¦è§£](#2-InnerInterceptoræ¥å£è¯¦è§£)
3. [SQLæ‹¦æˆªæœºåˆ¶åŸç†](#3-SQLæ‹¦æˆªæœºåˆ¶åŸç†)
4. [Mybatisæ‹¦æˆªå™¨åŸç†](#4-Mybatisæ‹¦æˆªå™¨åŸç†)
5. [æ’ä»¶é“¾æ‰§è¡Œé¡ºåº](#5-æ’ä»¶é“¾æ‰§è¡Œé¡ºåº)
6. [æ‹¦æˆªæ—¶æœºé€‰æ‹©](#6-æ‹¦æˆªæ—¶æœºé€‰æ‹©)
7. [æ’ä»¶å¼€å‘è§„èŒƒ](#7-æ’ä»¶å¼€å‘è§„èŒƒ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ’ä»¶ä½“ç³»æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ’ä»¶ä½“ç³»


**ğŸ”¸ é€šä¿—ç†è§£**

æƒ³è±¡ä½ åœ¨ä½¿ç”¨æ‰‹æœºï¼Œç³»ç»Ÿæœ¬èº«åªæœ‰åŸºæœ¬åŠŸèƒ½ï¼Œä½†ä½ å¯ä»¥å®‰è£…å„ç§Appæ¥æ‰©å±•åŠŸèƒ½ã€‚MyBatis-Plusçš„æ’ä»¶ä½“ç³»å°±æ˜¯è¿™ä¸ªé“ç†ï¼š
- **æ ¸å¿ƒæ¡†æ¶** = æ‰‹æœºç³»ç»Ÿï¼ˆæä¾›åŸºç¡€åŠŸèƒ½ï¼‰
- **æ’ä»¶** = å„ç§Appï¼ˆæ‰©å±•ç‰¹å®šåŠŸèƒ½ï¼‰
- **æ’ä»¶æ¥å£** = åº”ç”¨å•†åº—è§„èŒƒï¼ˆè§„å®šAppæ€ä¹ˆå¼€å‘ï¼‰

```
MyBatis-Plusæ ¸å¿ƒåŠŸèƒ½
        â†“
éœ€è¦æ‰©å±•æ–°åŠŸèƒ½ï¼ˆå¦‚åˆ†é¡µã€åŠ å¯†ï¼‰
        â†“
å¼€å‘æ’ä»¶æ¥å®ç°
        â†“
æ’å…¥åˆ°æ‰§è¡Œæµç¨‹ä¸­
```

**ğŸ”¸ æ’ä»¶èƒ½åšä»€ä¹ˆ**

| åº”ç”¨åœºæ™¯ | å…·ä½“åŠŸèƒ½ | å®é™…ä¾‹å­ |
|---------|---------|---------|
| ğŸ” **æ•°æ®å®‰å…¨** | SQLåŠ å¯†/è„±æ• | æŸ¥è¯¢æ—¶è‡ªåŠ¨è§£å¯†æ‰‹æœºå· |
| ğŸ“„ **åˆ†é¡µå¤„ç†** | è‡ªåŠ¨åˆ†é¡µæŸ¥è¯¢ | æŸ¥è¯¢åˆ—è¡¨è‡ªåŠ¨åŠ LIMIT |
| ğŸ” **SQLå®¡è®¡** | è®°å½•SQLæ‰§è¡Œ | ç»Ÿè®¡æ…¢æŸ¥è¯¢SQL |
| ğŸš« **æƒé™æ§åˆ¶** | æ•°æ®æƒé™è¿‡æ»¤ | åªèƒ½æŸ¥çœ‹è‡ªå·±éƒ¨é—¨æ•°æ® |
| âš¡ **æ€§èƒ½ä¼˜åŒ–** | SQLæ”¹å†™ä¼˜åŒ– | è‡ªåŠ¨æ·»åŠ ç´¢å¼•æç¤º |

### 1.2 æ’ä»¶ä½“ç³»æ¶æ„


**æ¶æ„å±‚æ¬¡å…³ç³»**

```
åº”ç”¨å±‚
  â†“
MyBatis-Plusæ‹¦æˆªå™¨
  â†“
InnerInterceptoræ’ä»¶é“¾
  â†“
Mybatisåº•å±‚æ‹¦æˆªå™¨
  â†“
JDBCæ‰§è¡Œ
```

**ä¸‰å±‚æ¶æ„è¯´æ˜**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶å±‚                  â”‚
â”‚  â€¢ åˆ†é¡µæ’ä»¶                       â”‚
â”‚  â€¢ åŠ å¯†æ’ä»¶                       â”‚  â† æˆ‘ä»¬å¼€å‘çš„æ’ä»¶
â”‚  â€¢ å®¡è®¡æ’ä»¶                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MyBatis-Plusæ‹¦æˆªå™¨å±‚             â”‚
â”‚  â€¢ MybatisPlusInterceptor        â”‚  â† MPæä¾›çš„ç»Ÿä¸€å…¥å£
â”‚  â€¢ ç®¡ç†æ’ä»¶é“¾                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mybatisæ‹¦æˆªå™¨å±‚                  â”‚
â”‚  â€¢ Interceptoræ¥å£               â”‚  â† åº•å±‚æ‹¦æˆªæœºåˆ¶
â”‚  â€¢ PluginåŒ…è£…                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¹ å…³é”®ç†è§£**
- **ç”¨æˆ·å±‚**ï¼šç¼–å†™ä¸šåŠ¡é€»è¾‘æ’ä»¶
- **MPå±‚**ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ’ä»¶
- **Mybatiså±‚**ï¼šæä¾›åº•å±‚æ‹¦æˆªèƒ½åŠ›

---

## 2. ğŸ“ InnerInterceptoræ¥å£è¯¦è§£


### 2.1 æ¥å£å®šä¹‰ä¸ä½œç”¨


**ğŸ”¸ æ¥å£æ ¸å¿ƒå®šä¹‰**

InnerInterceptoræ˜¯MyBatis-Plusæä¾›çš„æ’ä»¶æ¥å£ï¼Œæ‰€æœ‰è‡ªå®šä¹‰æ’ä»¶éƒ½è¦å®ç°å®ƒã€‚

**æ¥å£æ–¹æ³•ä¸€è§ˆ**

| æ–¹æ³• | ä½œç”¨æ—¶æœº | ç”¨é€” |
|------|---------|------|
| `beforeQuery()` | æŸ¥è¯¢**æ‰§è¡Œå‰** | ä¿®æ”¹æŸ¥è¯¢SQLã€æ·»åŠ æ¡ä»¶ |
| `beforePrepare()` | SQL**å‡†å¤‡å‰** | é¢„å¤„ç†SQLè¯­å¥ |
| `beforeGetBoundSql()` | è·å–SQL**ä¹‹å‰** | æœ€åæœºä¼šä¿®æ”¹SQL |

> ğŸ’¡ **è®°å¿†æŠ€å·§**ï¼šæ‰€æœ‰æ–¹æ³•éƒ½æ˜¯"beforeå¼€å¤´"ï¼Œè¡¨ç¤ºåœ¨æŸä¸ªé˜¶æ®µ**ä¹‹å‰**æ‰§è¡Œ

### 2.2 æ ¸å¿ƒæ–¹æ³•è¯¦è§£


**æ–¹æ³•1ï¼šbeforeQueryï¼ˆæœ€å¸¸ç”¨ï¼‰**

```java
// åœ¨æ‰§è¡ŒæŸ¥è¯¢å‰è¢«è°ƒç”¨
void beforeQuery(Executor executor, 
                 MappedStatement ms, 
                 Object parameter, 
                 RowBounds rowBounds, 
                 ResultHandler resultHandler, 
                 BoundSql boundSql)
```

**å‚æ•°å«ä¹‰è§£é‡Š**

```
å‚æ•°ä½œç”¨è¯´æ˜ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
executor        â†’ SQLæ‰§è¡Œå™¨ï¼ˆè´Ÿè´£æ‰§è¡ŒSQLï¼‰
MappedStatement â†’ SQLè¯­å¥ä¿¡æ¯ï¼ˆåŒ…å«SQLé…ç½®ï¼‰
parameter       â†’ æŸ¥è¯¢å‚æ•°ï¼ˆç”¨æˆ·ä¼ å…¥çš„å‚æ•°ï¼‰
RowBounds       â†’ åˆ†é¡µä¿¡æ¯ï¼ˆèµ·å§‹ä½ç½®ã€æ•°é‡ï¼‰
ResultHandler   â†’ ç»“æœå¤„ç†å™¨ï¼ˆå¤„ç†æŸ¥è¯¢ç»“æœï¼‰
BoundSql        â†’ å®Œæ•´SQLï¼ˆå¯ä»¥è·å–å’Œä¿®æ”¹SQLï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

é€šä¿—ç†è§£ï¼š
â€¢ executor â†’ å¨å¸ˆï¼ˆè´Ÿè´£åšèœï¼‰
â€¢ MappedStatement â†’ èœè°±ï¼ˆè§„å®šæ€ä¹ˆåšï¼‰
â€¢ parameter â†’ é£Ÿæï¼ˆåšèœçš„åŸæ–™ï¼‰
â€¢ BoundSql â†’ æœ€ç»ˆèœå“ï¼ˆè¦ç«¯ç»™å®¢äººçš„ï¼‰
```

**å®é™…åº”ç”¨ç¤ºä¾‹**

```java
// ç¤ºä¾‹ï¼šè‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·æ¡ä»¶
public class TenantInterceptor implements InnerInterceptor {
    
    @Override
    public void beforeQuery(Executor executor, 
                           MappedStatement ms, 
                           Object parameter,
                           RowBounds rowBounds, 
                           ResultHandler resultHandler, 
                           BoundSql boundSql) {
        
        // 1. è·å–åŸå§‹SQL
        String originalSql = boundSql.getSql();
        // SELECT * FROM user WHERE age > 18
        
        // 2. è·å–å½“å‰ç§Ÿæˆ·ID
        Long tenantId = TenantContext.getCurrentTenantId();
        
        // 3. æ”¹å†™SQLæ·»åŠ ç§Ÿæˆ·æ¡ä»¶
        String newSql = originalSql + " AND tenant_id = " + tenantId;
        // SELECT * FROM user WHERE age > 18 AND tenant_id = 1001
        
        // 4. è®¾ç½®æ–°SQL
        FieldUtils.writeField(boundSql, "sql", newSql, true);
    }
}
```

> âš ï¸ **é‡è¦æé†’**ï¼šå®é™…å¼€å‘è¦ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œè¿™é‡Œç®€åŒ–æ¼”ç¤ºåŸç†

### 2.3 æ–¹æ³•æ‰§è¡Œæ—¶æœºå¯¹æ¯”


**æ—¶åºå›¾ç¤º**

```
SQLæ‰§è¡Œå®Œæ•´æµç¨‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç”¨æˆ·è°ƒç”¨Mapperæ–¹æ³•
        â†“
   beforePrepare()      â† ğŸ”¹ SQLå‡†å¤‡å‰ï¼ˆå¾ˆå°‘ç”¨ï¼‰
        â†“
åˆ›å»ºMappedStatement
        â†“
 beforeGetBoundSql()    â† ğŸ”¹ è·å–SQLå‰ï¼ˆå¶å°”ç”¨ï¼‰
        â†“
    è·å–BoundSql
        â†“
   beforeQuery()        â† ğŸ”¹ æ‰§è¡ŒæŸ¥è¯¢å‰ï¼ˆæœ€å¸¸ç”¨ï¼‰
        â†“
    æ‰§è¡ŒSQLæŸ¥è¯¢
        â†“
    è¿”å›ç»“æœ
```

**ğŸ”¹ é€‰æ‹©å»ºè®®**

```
ä½¿ç”¨åœºæ™¯æŒ‡å—ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
beforeQuery()       â†’ 90%çš„åœºæ™¯ç”¨è¿™ä¸ª
â€¢ ä¿®æ”¹SQLæ¡ä»¶
â€¢ æ·»åŠ æƒé™è¿‡æ»¤
â€¢ è®°å½•SQLæ—¥å¿—

beforeGetBoundSql() â†’ ç‰¹æ®ŠSQLå¤„ç†
â€¢ SQLæ¨¡æ¿æ›¿æ¢
â€¢ åŠ¨æ€SQLæ”¹å†™

beforePrepare()     â†’ æå°‘ä½¿ç”¨
â€¢ åº•å±‚å‚æ•°å¤„ç†
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## 3. ğŸ” SQLæ‹¦æˆªæœºåˆ¶åŸç†


### 3.1 æ‹¦æˆªæœºåˆ¶æ ¸å¿ƒæ€æƒ³


**ğŸ”¸ æ‹¦æˆªæœºåˆ¶æµç¨‹**

```
æ­£å¸¸æ‰§è¡Œæµç¨‹ï¼š
ç”¨æˆ· â†’ Mapper â†’ SQL â†’ æ•°æ®åº“ â†’ ç»“æœ

åŠ å…¥æ‹¦æˆªå™¨åï¼š
ç”¨æˆ· â†’ Mapper â†’ [æ‹¦æˆªå™¨1] â†’ [æ‹¦æˆªå™¨2] â†’ SQL â†’ æ•°æ®åº“ â†’ ç»“æœ
                  â†“ä¿®æ”¹SQL      â†“ä¿®æ”¹SQL
```

**é€šä¿—ç±»æ¯”**

æƒ³è±¡ä½ å»é¤å…ç‚¹èœçš„è¿‡ç¨‹ï¼š

```
æ²¡æœ‰æ‹¦æˆªå™¨ï¼š
ä½  â†’ æœåŠ¡å‘˜ â†’ å¨æˆ¿ â†’ ä¸Šèœ

æœ‰æ‹¦æˆªå™¨ï¼š
ä½  â†’ æœåŠ¡å‘˜ â†’ [ä¸»ç®¡æ£€æŸ¥èœå•] â†’ [åå¨è°ƒæ•´é…æ–™] â†’ å¨æˆ¿ â†’ ä¸Šèœ
              â†“å¯èƒ½ä¿®æ”¹         â†“å¯èƒ½ä¿®æ”¹
```

### 3.2 æ‹¦æˆªç‚¹ä½è¯´æ˜


**å››ä¸ªæ ¸å¿ƒæ‹¦æˆªç‚¹**

| æ‹¦æˆªç‚¹ | å¯¹è±¡ç±»å‹ | æ‹¦æˆªå†…å®¹ | ä½¿ç”¨é¢‘ç‡ |
|--------|---------|---------|----------|
| **Executor** | æ‰§è¡Œå™¨ | æ‰€æœ‰SQLæ“ä½œ | â­â­â­â­â­ |
| **StatementHandler** | è¯­å¥å¤„ç†å™¨ | SQLé¢„ç¼–è¯‘ | â­â­â­â­ |
| **ParameterHandler** | å‚æ•°å¤„ç†å™¨ | å‚æ•°è®¾ç½® | â­â­â­ |
| **ResultSetHandler** | ç»“æœå¤„ç†å™¨ | ç»“æœæ˜ å°„ | â­â­â­ |

**æ‹¦æˆªç‚¹ä½œç”¨è¯¦è§£**

```
1ï¸âƒ£ Executorï¼ˆæ‰§è¡Œå™¨ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ‹¦æˆªæ—¶æœºï¼šSQLæ‰§è¡Œå‰å
é€‚ç”¨åœºæ™¯ï¼š
â€¢ åˆ†é¡µæ’ä»¶    â†’ æ”¹å†™SQLæ·»åŠ LIMIT
â€¢ æƒé™æ’ä»¶    â†’ æ·»åŠ WHEREæ¡ä»¶
â€¢ å®¡è®¡æ’ä»¶    â†’ è®°å½•SQLæ—¥å¿—

ä»£ç ä½ç½®ï¼š
@Intercepts({
    @Signature(
        type = Executor.class,
        method = "query",
        args = {MappedStatement.class, Object.class, 
                RowBounds.class, ResultHandler.class}
    )
})

2ï¸âƒ£ StatementHandlerï¼ˆè¯­å¥å¤„ç†å™¨ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ‹¦æˆªæ—¶æœºï¼šSQLå‡†å¤‡é˜¶æ®µ
é€‚ç”¨åœºæ™¯ï¼š
â€¢ SQLä¼˜åŒ–      â†’ æ·»åŠ ç´¢å¼•æç¤º
â€¢ è¶…æ—¶æ§åˆ¶     â†’ è®¾ç½®æŸ¥è¯¢è¶…æ—¶
â€¢ è¿æ¥ç®¡ç†     â†’ åˆ‡æ¢æ•°æ®æº

3ï¸âƒ£ ParameterHandlerï¼ˆå‚æ•°å¤„ç†å™¨ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ‹¦æˆªæ—¶æœºï¼šå‚æ•°è®¾ç½®æ—¶
é€‚ç”¨åœºæ™¯ï¼š
â€¢ æ•°æ®åŠ å¯†     â†’ æ•æ„Ÿæ•°æ®åŠ å¯†
â€¢ å‚æ•°æ ¡éªŒ     â†’ é˜²SQLæ³¨å…¥
â€¢ ç±»å‹è½¬æ¢     â†’ è‡ªå®šä¹‰ç±»å‹å¤„ç†

4ï¸âƒ£ ResultSetHandlerï¼ˆç»“æœå¤„ç†å™¨ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ‹¦æˆªæ—¶æœºï¼šç»“æœæ˜ å°„æ—¶
é€‚ç”¨åœºæ™¯ï¼š
â€¢ æ•°æ®è§£å¯†     â†’ æ•æ„Ÿæ•°æ®è§£å¯†
â€¢ è„±æ•å¤„ç†     â†’ æ‰‹æœºå·è„±æ•
â€¢ ç»“æœè½¬æ¢     â†’ è‡ªå®šä¹‰æ˜ å°„
```

### 3.3 æ‹¦æˆªå™¨å·¥ä½œåŸç†


**åº•å±‚å®ç°æœºåˆ¶**

```
å·¥ä½œæµç¨‹å›¾ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Springå¯åŠ¨æ—¶
   â†“
2. æ‰«æ@Interceptsæ³¨è§£
   â†“
3. åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆPlugin.wrapï¼‰
   â†“
4. æ›¿æ¢åŸå§‹å¯¹è±¡
   â†“
5. SQLæ‰§è¡Œæ—¶è°ƒç”¨ä»£ç†
   â†“
6. ä»£ç†è°ƒç”¨æ‹¦æˆªå™¨æ–¹æ³•
   â†“
7. æ‹¦æˆªå™¨å¤„ç†å®Œæˆ
   â†“
8. ç»§ç»­æ‰§è¡ŒåŸæ–¹æ³•
```

**ä»£ç†æ¨¡å¼ç¤ºæ„**

```java
// åŸå§‹å¯¹è±¡ï¼ˆæ²¡æœ‰æ‹¦æˆªåŠŸèƒ½ï¼‰
Executor executor = new SimpleExecutor();

// è¢«ä»£ç†åŒ…è£…åï¼ˆæœ‰æ‹¦æˆªåŠŸèƒ½ï¼‰
Executor proxyExecutor = (Executor) Proxy.newProxyInstance(
    executor.getClass().getClassLoader(),
    new Class[]{Executor.class},
    new InvocationHandler() {
        public Object invoke(Object proxy, Method method, Object[] args) {
            // 1. æ‰§è¡Œæ‹¦æˆªå™¨é€»è¾‘
            interceptor.intercept(...);
            
            // 2. æ‰§è¡ŒåŸæ–¹æ³•
            return method.invoke(executor, args);
        }
    }
);
```

> ğŸ’¡ **æ ¸å¿ƒç†è§£**ï¼šæ‹¦æˆªå™¨æœ¬è´¨æ˜¯**ä»£ç†æ¨¡å¼**ï¼Œåœ¨åŸæ–¹æ³•å‰åæ’å…¥è‡ªå®šä¹‰é€»è¾‘

---

## 4. âš™ï¸ Mybatisæ‹¦æˆªå™¨åŸç†


### 4.1 Mybatisæ‹¦æˆªå™¨æ¥å£


**ğŸ”¸ Interceptoræ¥å£å®šä¹‰**

```java
public interface Interceptor {
    
    // æ‹¦æˆªæ–¹æ³•ï¼ˆæ ¸å¿ƒï¼‰
    Object intercept(Invocation invocation) throws Throwable;
    
    // ç”Ÿæˆä»£ç†å¯¹è±¡
    default Object plugin(Object target) {
        return Plugin.wrap(target, this);
    }
    
    // è®¾ç½®å±æ€§
    default void setProperties(Properties properties) {}
}
```

**ä¸‰ä¸ªæ–¹æ³•ä½œç”¨**

```
æ–¹æ³•èŒè´£è¯´æ˜ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

intercept()      â†’ æ‹¦æˆªé€»è¾‘å®ç°ï¼ˆå¿…é¡»å®ç°ï¼‰
â€¢ å‚æ•°ï¼šInvocationï¼ˆåŒ…å«æ–¹æ³•å’Œå‚æ•°ï¼‰
â€¢ è¿”å›ï¼šå¤„ç†åçš„ç»“æœ
â€¢ ç”¨é€”ï¼šæ ¸å¿ƒæ‹¦æˆªå¤„ç†

plugin()         â†’ åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆä¸€èˆ¬ç”¨é»˜è®¤ï¼‰
â€¢ å‚æ•°ï¼štargetï¼ˆè¢«ä»£ç†å¯¹è±¡ï¼‰
â€¢ è¿”å›ï¼šä»£ç†åçš„å¯¹è±¡
â€¢ ç”¨é€”ï¼šåŒ…è£…ç›®æ ‡å¯¹è±¡

setProperties()  â†’ é…ç½®æ’ä»¶å±æ€§ï¼ˆå¯é€‰ï¼‰
â€¢ å‚æ•°ï¼šPropertiesé…ç½®
â€¢ ç”¨é€”ï¼šå¤–éƒ¨é…ç½®æ³¨å…¥
```

### 4.2 @Interceptsæ³¨è§£è¯¦è§£


**æ³¨è§£é…ç½®è¯´æ˜**

```java
@Intercepts({
    @Signature(
        type = Executor.class,           // æ‹¦æˆªçš„æ¥å£ç±»å‹
        method = "query",                // æ‹¦æˆªçš„æ–¹æ³•å
        args = {                         // æ–¹æ³•å‚æ•°ç±»å‹
            MappedStatement.class,       // å‚æ•°1
            Object.class,                // å‚æ•°2
            RowBounds.class,             // å‚æ•°3
            ResultHandler.class          // å‚æ•°4
        }
    )
})
public class MyInterceptor implements Interceptor {
    // ...
}
```

**é…ç½®è¦ç´ è§£é‡Š**

| å±æ€§ | å«ä¹‰ | å¦‚ä½•ç¡®å®š |
|------|------|---------|
| **type** | æ‹¦æˆªå“ªä¸ªæ¥å£ | Executorã€StatementHandlerç­‰ |
| **method** | æ‹¦æˆªå“ªä¸ªæ–¹æ³• | æŸ¥çœ‹æ¥å£æ–¹æ³•å |
| **args** | æ–¹æ³•å‚æ•°ç±»å‹ | å¿…é¡»å®Œå…¨åŒ¹é…å‚æ•°åˆ—è¡¨ |

> âš ï¸ **ç‰¹åˆ«æ³¨æ„**ï¼šargså‚æ•°ç±»å‹å¿…é¡»**å®Œå…¨åŒ¹é…**ï¼Œå¦åˆ™æ‹¦æˆªä¸ç”Ÿæ•ˆï¼

### 4.3 Invocationå¯¹è±¡è¯¦è§£


**Invocationç»“æ„**

```java
public class Invocation {
    private final Object target;    // ç›®æ ‡å¯¹è±¡
    private final Method method;    // ç›®æ ‡æ–¹æ³•
    private final Object[] args;    // æ–¹æ³•å‚æ•°
    
    // æ‰§è¡ŒåŸæ–¹æ³•
    public Object proceed() throws Throwable {
        return method.invoke(target, args);
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**

```java
@Override
public Object intercept(Invocation invocation) throws Throwable {
    
    // 1. è·å–ç›®æ ‡å¯¹è±¡
    Executor executor = (Executor) invocation.getTarget();
    
    // 2. è·å–æ–¹æ³•å‚æ•°
    Object[] args = invocation.getArgs();
    MappedStatement ms = (MappedStatement) args[0];
    Object parameter = args[1];
    
    // 3. æ‰§è¡Œå‰ç½®å¤„ç†
    System.out.println("æ‰§è¡ŒSQLï¼š" + ms.getId());
    
    // 4. æ‰§è¡ŒåŸæ–¹æ³•
    Object result = invocation.proceed();
    
    // 5. æ‰§è¡Œåç½®å¤„ç†
    System.out.println("è¿”å›ç»“æœï¼š" + result);
    
    return result;
}
```

**å®Œæ•´æµç¨‹ç¤ºæ„**

```
Invocationè°ƒç”¨æµç¨‹ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. æ–¹æ³•è¢«æ‹¦æˆª
   â†“
2. å°è£…æˆInvocationå¯¹è±¡
   â€¢ target  â†’ åŸå§‹å¯¹è±¡ï¼ˆå¦‚Executorï¼‰
   â€¢ method  â†’ è¢«è°ƒç”¨æ–¹æ³•ï¼ˆå¦‚queryï¼‰
   â€¢ args    â†’ æ–¹æ³•å‚æ•°
   â†“
3. è°ƒç”¨æ‹¦æˆªå™¨çš„interceptæ–¹æ³•
   â†“
4. æ‹¦æˆªå™¨å¤„ç†
   â€¢ å‰ç½®å¤„ç†
   â€¢ invocation.proceed() â†’ æ‰§è¡ŒåŸæ–¹æ³•
   â€¢ åç½®å¤„ç†
   â†“
5. è¿”å›ç»“æœ
```

---

## 5. ğŸ”— æ’ä»¶é“¾æ‰§è¡Œé¡ºåº


### 5.1 æ’ä»¶é“¾æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ’ä»¶é“¾**

æ’ä»¶é“¾å°±æ˜¯å¤šä¸ªæ’ä»¶**æŒ‰é¡ºåºæ‰§è¡Œ**çš„é“¾æ¡ï¼Œå°±åƒå·¥å‚æµæ°´çº¿ä¸€æ ·ã€‚

```
æµæ°´çº¿ç±»æ¯”ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

åŸæ–™ â†’ [å·¥åº1] â†’ [å·¥åº2] â†’ [å·¥åº3] â†’ æˆå“
       â†“åˆ‡å‰²     â†“æ‰“ç£¨     â†“ä¸Šæ¼†

SQL  â†’ [æ’ä»¶1] â†’ [æ’ä»¶2] â†’ [æ’ä»¶3] â†’ ç»“æœ
       â†“åˆ†é¡µ     â†“åŠ å¯†     â†“å®¡è®¡
```

**æ’ä»¶é“¾é…ç½®**

```java
@Configuration
public class MybatisPlusConfig {
    
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        
        // æŒ‰é¡ºåºæ·»åŠ æ’ä»¶
        interceptor.addInnerInterceptor(new TenantLineInnerInterceptor());  // 1
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor());  // 2
        interceptor.addInnerInterceptor(new DataPermissionInterceptor());   // 3
        
        return interceptor;
    }
}
```

### 5.2 æ‰§è¡Œé¡ºåºè§„åˆ™


**ğŸ”¹ æ ¸å¿ƒè§„åˆ™**

```
æ‰§è¡Œé¡ºåºé“å¾‹ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è§„åˆ™1ï¼šæŒ‰æ·»åŠ é¡ºåºæ­£å‘æ‰§è¡Œ
â€¢ å…ˆæ·»åŠ çš„å…ˆæ‰§è¡Œ
â€¢ åæ·»åŠ çš„åæ‰§è¡Œ

è§„åˆ™2ï¼šåµŒå¥—æ‰§è¡Œï¼ˆæ´‹è‘±æ¨¡å‹ï¼‰
â€¢ å¤–å±‚æ’ä»¶åŒ…è£¹å†…å±‚æ’ä»¶
â€¢ æœ€å…ˆæ‰§è¡Œçš„æœ€åç»“æŸ
```

**æ´‹è‘±æ¨¡å‹å›¾è§£**

```
åµŒå¥—æ‰§è¡Œç¤ºæ„å›¾ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   æ’ä»¶1ï¼ˆç§Ÿæˆ·ï¼‰      â”‚ â† æœ€å¤–å±‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ æ’ä»¶2ï¼ˆåˆ†é¡µï¼‰  â”‚  â”‚ â† ä¸­é—´å±‚
        â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
        â”‚  â”‚ â”‚æ’ä»¶3å®¡è®¡ â”‚  â”‚  â”‚ â† æœ€å†…å±‚
        â”‚  â”‚ â”‚   SQL    â”‚  â”‚  â”‚
        â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰§è¡Œæµç¨‹ï¼š
è¿›å…¥ï¼šæ’ä»¶1 â†’ æ’ä»¶2 â†’ æ’ä»¶3 â†’ SQL
è¿”å›ï¼šæ’ä»¶3 â†’ æ’ä»¶2 â†’ æ’ä»¶1 â†’ ç»“æœ
```

**æ—¶åºå¯¹æ¯”**

| æ’ä»¶ | è¿›å…¥æ—¶æœº | å¤„ç† | é€€å‡ºæ—¶æœº |
|------|---------|------|---------|
| æ’ä»¶1ï¼ˆç§Ÿæˆ·ï¼‰ | **ç¬¬1ä¸ª**è¿›å…¥ | æ·»åŠ ç§Ÿæˆ·æ¡ä»¶ | **æœ€å**é€€å‡º |
| æ’ä»¶2ï¼ˆåˆ†é¡µï¼‰ | **ç¬¬2ä¸ª**è¿›å…¥ | æ·»åŠ åˆ†é¡µ | **ç¬¬2ä¸ª**é€€å‡º |
| æ’ä»¶3ï¼ˆå®¡è®¡ï¼‰ | **ç¬¬3ä¸ª**è¿›å…¥ | è®°å½•æ—¥å¿— | **ç¬¬1ä¸ª**é€€å‡º |

### 5.3 é¡ºåºå½±å“åˆ†æ


**ğŸ”¸ ä¸ºä»€ä¹ˆé¡ºåºé‡è¦**

```
åœºæ™¯1ï¼šç§Ÿæˆ·æ’ä»¶ â†’ åˆ†é¡µæ’ä»¶ âœ… æ­£ç¡®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åŸå§‹SQLï¼šSELECT * FROM user
          â†“ ç§Ÿæˆ·æ’ä»¶
       SELECT * FROM user WHERE tenant_id = 1001
          â†“ åˆ†é¡µæ’ä»¶  
       SELECT * FROM user WHERE tenant_id = 1001 LIMIT 10
       
ç»“æœï¼šæ­£ç¡®åˆ†é¡µç§Ÿæˆ·æ•°æ®


åœºæ™¯2ï¼šåˆ†é¡µæ’ä»¶ â†’ ç§Ÿæˆ·æ’ä»¶ âŒ é”™è¯¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åŸå§‹SQLï¼šSELECT * FROM user
          â†“ åˆ†é¡µæ’ä»¶
       SELECT * FROM user LIMIT 10
          â†“ ç§Ÿæˆ·æ’ä»¶ï¼ˆSQLå·²ç»æœ‰LIMITï¼Œå¯èƒ½è§£æé”™è¯¯ï¼‰
       è§£æå¤±è´¥æˆ–é€»è¾‘é”™è¯¯ï¼
```

**æœ€ä½³å®è·µé¡ºåº**

```
æ¨èæ’ä»¶é¡ºåºï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. å¤šç§Ÿæˆ·æ’ä»¶        â†’ æœ€å…ˆè¿‡æ»¤æ•°æ®èŒƒå›´
2. æ•°æ®æƒé™æ’ä»¶      â†’ è¿›ä¸€æ­¥è¿‡æ»¤æƒé™
3. åŠ¨æ€è¡¨åæ’ä»¶      â†’ ä¿®æ”¹è¡¨å
4. åˆ†é¡µæ’ä»¶          â†’ æœ€åæ·»åŠ åˆ†é¡µ
5. SQLå®¡è®¡æ’ä»¶       â†’ è®°å½•æœ€ç»ˆSQL

è®°å¿†å£è¯€ï¼š
"ç§Ÿæˆ·æƒé™è¡¨åé¡µï¼Œå®¡è®¡æ—¥å¿—æœ€åæ’"
```

---

## 6. â° æ‹¦æˆªæ—¶æœºé€‰æ‹©


### 6.1 æ‹¦æˆªæ—¶æœºå¯¹æ¯”


**å››å¤§æ‹¦æˆªæ—¶æœº**

| æ—¶æœº | æ‰§è¡Œé˜¶æ®µ | é€‚ç”¨åœºæ™¯ | éš¾åº¦ |
|------|---------|---------|------|
| **Executor** | SQLæ‰§è¡Œå‰ | SQLæ”¹å†™ã€æ—¥å¿—è®°å½• | â­â­ |
| **StatementHandler** | SQLé¢„ç¼–è¯‘ | è¶…æ—¶è®¾ç½®ã€æ‰¹å¤„ç† | â­â­â­ |
| **ParameterHandler** | å‚æ•°è®¾ç½® | åŠ å¯†ã€ç±»å‹è½¬æ¢ | â­â­â­â­ |
| **ResultSetHandler** | ç»“æœå¤„ç† | è§£å¯†ã€è„±æ• | â­â­â­â­ |

**å®Œæ•´æ—¶åºå›¾**

```
SQLæ‰§è¡Œå®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Mapperè°ƒç”¨
    â†“
ã€Executoræ‹¦æˆªç‚¹ã€‘         â† æœ€æ—©æ‹¦æˆªï¼ˆæ¨èå¤§éƒ¨åˆ†åœºæ™¯ï¼‰
â€¢ å¯ä»¥ä¿®æ”¹SQL
â€¢ å¯ä»¥ä¿®æ”¹å‚æ•°
â€¢ å¯ä»¥è¿”å›ç¼“å­˜
    â†“
SQLè§£æ
    â†“
ã€StatementHandleræ‹¦æˆªç‚¹ã€‘  â† SQLå‡†å¤‡é˜¶æ®µ
â€¢ è®¾ç½®è¶…æ—¶æ—¶é—´
â€¢ è®¾ç½®æ‰¹å¤„ç†å¤§å°
â€¢ åˆ‡æ¢æ•°æ®æº
    â†“
ã€ParameterHandleræ‹¦æˆªç‚¹ã€‘  â† å‚æ•°è®¾ç½®é˜¶æ®µ
â€¢ å‚æ•°åŠ å¯†
â€¢ å‚æ•°æ ¡éªŒ
â€¢ ç±»å‹è½¬æ¢
    â†“
æ‰§è¡ŒSQL
    â†“
ã€ResultSetHandleræ‹¦æˆªç‚¹ã€‘  â† ç»“æœå¤„ç†é˜¶æ®µ
â€¢ ç»“æœè§£å¯†
â€¢ ç»“æœè„±æ•
â€¢ è‡ªå®šä¹‰æ˜ å°„
    â†“
è¿”å›ç»“æœ
```

### 6.2 åœºæ™¯é€‰æ‹©æŒ‡å—


**ğŸ”¹ é€‰æ‹©å†³ç­–æ ‘**

```
éœ€æ±‚åˆ†ææµç¨‹ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

é—®é¢˜1: éœ€è¦ä¿®æ”¹SQLå—ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ Executoræ‹¦æˆª
  â””â”€ å¦ â†’ ç»§ç»­ä¸‹ä¸€ä¸ªé—®é¢˜

é—®é¢˜2: éœ€è¦å¤„ç†å‚æ•°å—ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ ParameterHandleræ‹¦æˆª
  â””â”€ å¦ â†’ ç»§ç»­ä¸‹ä¸€ä¸ªé—®é¢˜

é—®é¢˜3: éœ€è¦å¤„ç†ç»“æœå—ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ ResultSetHandleræ‹¦æˆª
  â””â”€ å¦ â†’ è€ƒè™‘æ˜¯å¦çœŸçš„éœ€è¦æ’ä»¶
```

**å…¸å‹åœºæ™¯ç¤ºä¾‹**

```java
// åœºæ™¯1ï¼šSQLæ”¹å†™ï¼ˆç”¨Executorï¼‰
@Intercepts({
    @Signature(type = Executor.class, method = "query", ...)
})
public class SqlRewriteInterceptor implements Interceptor {
    // æ·»åŠ WHEREæ¡ä»¶ã€ä¿®æ”¹è¡¨åç­‰
}

// åœºæ™¯2ï¼šå‚æ•°åŠ å¯†ï¼ˆç”¨ParameterHandlerï¼‰
@Intercepts({
    @Signature(type = ParameterHandler.class, method = "setParameters", ...)
})
public class ParameterEncryptInterceptor implements Interceptor {
    // æ•æ„Ÿå­—æ®µåŠ å¯†
}

// åœºæ™¯3ï¼šç»“æœè„±æ•ï¼ˆç”¨ResultSetHandlerï¼‰
@Intercepts({
    @Signature(type = ResultSetHandler.class, method = "handleResultSets", ...)
})
public class ResultDesensitizeInterceptor implements Interceptor {
    // æ‰‹æœºå·ã€èº«ä»½è¯è„±æ•
}
```

### 6.3 æ€§èƒ½è€ƒè™‘


**æ‹¦æˆªç‚¹æ€§èƒ½å¯¹æ¯”**

```
æ€§èƒ½å½±å“åˆ†æï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Executor         â†’ å½±å“ï¼šä½ â­
â€¢ æ¯æ¬¡SQLæ‰§è¡Œä¸€æ¬¡
â€¢ å»ºè®®ï¼šå¤§éƒ¨åˆ†é€»è¾‘æ”¾è¿™é‡Œ

StatementHandler â†’ å½±å“ï¼šä¸­ â­â­
â€¢ æ¯ä¸ªStatementä¸€æ¬¡
â€¢ å»ºè®®ï¼šç®€å•é…ç½®æ“ä½œ

ParameterHandler â†’ å½±å“ï¼šé«˜ â­â­â­
â€¢ æ¯ä¸ªå‚æ•°éƒ½å¤„ç†
â€¢ å»ºè®®ï¼šé¿å…å¤æ‚è®¡ç®—

ResultSetHandler â†’ å½±å“ï¼šé«˜ â­â­â­â­
â€¢ æ¯è¡Œç»“æœéƒ½å¤„ç†
â€¢ å»ºè®®ï¼šé¿å…å¤§é‡æ•°æ®æ—¶ä½¿ç”¨
```

> ğŸ’¡ **ä¼˜åŒ–å»ºè®®**ï¼šä¼˜å…ˆä½¿ç”¨Executoræ‹¦æˆªï¼Œé¿å…åœ¨ParameterHandlerå’ŒResultSetHandleråšå¤æ‚æ“ä½œ

---

## 7. ğŸ“ æ’ä»¶å¼€å‘è§„èŒƒ


### 7.1 å¼€å‘æµç¨‹æ ‡å‡†


**ğŸ”¸ æ ‡å‡†å¼€å‘æ­¥éª¤**

```
æ’ä»¶å¼€å‘äº”æ­¥æ³•ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1ï¸âƒ£ ç¡®å®šéœ€æ±‚
   â€¢ æ˜ç¡®è¦è§£å†³ä»€ä¹ˆé—®é¢˜
   â€¢ ç¡®å®šæ‹¦æˆªæ—¶æœº
   
2ï¸âƒ£ å®ç°æ¥å£
   â€¢ é€‰æ‹©InnerInterceptoræˆ–Interceptor
   â€¢ å®ç°å¿…è¦æ–¹æ³•
   
3ï¸âƒ£ ç¼–å†™é€»è¾‘
   â€¢ å‰ç½®å¤„ç†
   â€¢ è°ƒç”¨åŸæ–¹æ³•
   â€¢ åç½®å¤„ç†
   
4ï¸âƒ£ é…ç½®æ³¨å†Œ
   â€¢ Springé…ç½®
   â€¢ è®¾ç½®æ‰§è¡Œé¡ºåº
   
5ï¸âƒ£ æµ‹è¯•éªŒè¯
   â€¢ å•å…ƒæµ‹è¯•
   â€¢ é›†æˆæµ‹è¯•
```

### 7.2 ä»£ç è§„èŒƒè¦æ±‚


**ğŸ”¹ å‘½åè§„èŒƒ**

```
ç±»åè§„èŒƒï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… æ¨èå‘½åï¼š
â€¢ TenantLineInnerInterceptor     ï¼ˆåŠŸèƒ½+Inner+Interceptorï¼‰
â€¢ DataPermissionInterceptor       ï¼ˆåŠŸèƒ½+Interceptorï¼‰
â€¢ SqlAuditInterceptor             ï¼ˆåŠŸèƒ½+Interceptorï¼‰

âŒ ä¸æ¨èï¼š
â€¢ MyInterceptor                   ï¼ˆæ— å®é™…å«ä¹‰ï¼‰
â€¢ Interceptor1                    ï¼ˆç”¨æ•°å­—åŒºåˆ†ï¼‰
â€¢ TenantPlugin                    ï¼ˆæ··æ·†æ¦‚å¿µï¼‰
```

**æ–¹æ³•è§„èŒƒ**

```java
// âœ… å¥½çš„å†™æ³•
@Override
public void beforeQuery(Executor executor, MappedStatement ms, 
                       Object parameter, RowBounds rowBounds,
                       ResultHandler resultHandler, BoundSql boundSql) {
    
    // 1. å‚æ•°æ ¡éªŒ
    if (boundSql == null) {
        return;
    }
    
    // 2. è·å–SQL
    String originalSql = boundSql.getSql();
    
    // 3. ä¸šåŠ¡é€»è¾‘ï¼ˆæ¸…æ™°æ³¨é‡Šï¼‰
    String newSql = rewriteSql(originalSql);
    
    // 4. è®¾ç½®æ–°SQL
    setSql(boundSql, newSql);
}

// âŒ ä¸å¥½çš„å†™æ³•
@Override
public void beforeQuery(...) {
    // æ²¡æ³¨é‡Šï¼Œç›´æ¥ä¿®æ”¹
    FieldUtils.writeField(boundSql, "sql", 
        boundSql.getSql() + " AND tenant_id = 1", true);
}
```

### 7.3 å¼‚å¸¸å¤„ç†è§„èŒƒ


**å¼‚å¸¸å¤„ç†åŸåˆ™**

```java
// âœ… æ­£ç¡®çš„å¼‚å¸¸å¤„ç†
@Override
public Object intercept(Invocation invocation) throws Throwable {
    try {
        // 1. å‰ç½®å¤„ç†
        preHandle(invocation);
        
        // 2. æ‰§è¡ŒåŸæ–¹æ³•
        Object result = invocation.proceed();
        
        // 3. åç½®å¤„ç†
        postHandle(result);
        
        return result;
        
    } catch (Exception e) {
        // 4. è®°å½•æ—¥å¿—
        log.error("æ’ä»¶æ‰§è¡Œå¼‚å¸¸", e);
        
        // 5. æ ¹æ®æƒ…å†µå†³å®šæ˜¯å¦æŠ›å‡º
        if (isCritical(e)) {
            throw new PluginException("å…³é”®é”™è¯¯", e);
        }
        
        // 6. éå…³é”®é”™è¯¯ç»§ç»­æ‰§è¡Œ
        return invocation.proceed();
    }
}
```

**å¼‚å¸¸å¤„ç†ç­–ç•¥**

| å¼‚å¸¸ç±»å‹ | å¤„ç†æ–¹å¼ | è¯´æ˜ |
|---------|---------|------|
| **ç©ºæŒ‡é’ˆ** | é˜²å¾¡æ€§ç¼–ç¨‹ | æå‰åˆ¤ç©º |
| **SQLé”™è¯¯** | è®°å½•+æŠ›å‡º | ä¸èƒ½ç»§ç»­æ‰§è¡Œ |
| **å‚æ•°é”™è¯¯** | è®°å½•+è¿”å› | é™çº§å¤„ç† |
| **å…¶ä»–å¼‚å¸¸** | è®°å½•+å†³ç­– | æ ¹æ®ä¸šåŠ¡åˆ¤æ–­ |

### 7.4 æ€§èƒ½ä¼˜åŒ–è§„èŒƒ


**æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•**

```
æ€§èƒ½ä¼˜åŒ–è¦ç‚¹ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â–¡ é¿å…é‡å¤è§£æSQL
  âœ… ä½¿ç”¨ç¼“å­˜
  âŒ æ¯æ¬¡éƒ½é‡æ–°è§£æ

â–¡ å‡å°‘åå°„è°ƒç”¨
  âœ… ç¼“å­˜Methodå¯¹è±¡
  âŒ æ¯æ¬¡getMethod()

â–¡ æ§åˆ¶æ—¥å¿—çº§åˆ«
  âœ… debugæ—¥å¿—ç”¨isDebugEnabledåˆ¤æ–­
  âŒ ç›´æ¥æ‰“å°å¤§é‡æ—¥å¿—

â–¡ å¼‚æ­¥å¤„ç†éå…³é”®é€»è¾‘
  âœ… å®¡è®¡æ—¥å¿—å¼‚æ­¥è®°å½•
  âŒ åŒæ­¥å†™å…¥é˜»å¡SQL

â–¡ æ‰¹é‡å¤„ç†ä»£æ›¿å¾ªç¯
  âœ… ä¸€æ¬¡æ€§å¤„ç†å¤šä¸ªå‚æ•°
  âŒ forå¾ªç¯é€ä¸ªå¤„ç†
```

**ä¼˜åŒ–ç¤ºä¾‹**

```java
// âœ… å¥½çš„æ€§èƒ½å®è·µ
public class OptimizedInterceptor implements InnerInterceptor {
    
    // ç¼“å­˜é¿å…é‡å¤åˆ›å»º
    private static final Pattern SQL_PATTERN = Pattern.compile(...);
    
    // ä½¿ç”¨ThreadLocalé¿å…å¹¶å‘é—®é¢˜
    private ThreadLocal<SqlContext> contextHolder = new ThreadLocal<>();
    
    @Override
    public void beforeQuery(...) {
        // åˆ¤æ–­æ—¥å¿—çº§åˆ«
        if (log.isDebugEnabled()) {
            log.debug("SQL: {}", boundSql.getSql());
        }
        
        // ä½¿ç”¨ç¼“å­˜çš„æ­£åˆ™
        Matcher matcher = SQL_PATTERN.matcher(sql);
        
        // å¼‚æ­¥è®°å½•å®¡è®¡æ—¥å¿—
        CompletableFuture.runAsync(() -> auditLog(sql));
    }
}
```

### 7.5 é…ç½®ç®¡ç†è§„èŒƒ


**é…ç½®æ–‡ä»¶è§„èŒƒ**

```yaml
# application.yml
mybatis-plus:
  configuration:
    # æ—¥å¿—é…ç½®
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl
  
  # æ’ä»¶é…ç½®
  global-config:
    # è‡ªå®šä¹‰æ’ä»¶é…ç½®
    plugins:
      tenant:
        enabled: true
        tenant-id-column: tenant_id
        ignore-tables:
          - sys_user
          - sys_config
      
      pagination:
        enabled: true
        overflow: true
        max-limit: 1000
```

**åŠ¨æ€é…ç½®æ”¯æŒ**

```java
@Configuration
public class PluginConfig {
    
    @Value("${mybatis-plus.plugins.tenant.enabled:true}")
    private boolean tenantEnabled;
    
    @Bean
    public MybatisPlusInterceptor interceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        
        // æ ¹æ®é…ç½®å†³å®šæ˜¯å¦æ·»åŠ 
        if (tenantEnabled) {
            interceptor.addInnerInterceptor(new TenantLineInnerInterceptor());
        }
        
        return interceptor;
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ’ä»¶ä½“ç³» = æ‰©å±•MyBatis-PlusåŠŸèƒ½çš„æœºåˆ¶
ğŸ”¸ InnerInterceptor = MyBatis-Plusç»Ÿä¸€æ’ä»¶æ¥å£
ğŸ”¸ æ‹¦æˆªæœºåˆ¶ = ä»£ç†æ¨¡å¼åœ¨SQLæ‰§è¡Œæµç¨‹ä¸­æ’å…¥é€»è¾‘
ğŸ”¸ æ’ä»¶é“¾ = å¤šä¸ªæ’ä»¶æŒ‰é¡ºåºæ‰§è¡Œï¼ˆæ´‹è‘±æ¨¡å‹ï¼‰
ğŸ”¸ æ‹¦æˆªæ—¶æœº = Executor/StatementHandler/ParameterHandler/ResultSetHandler
ğŸ”¸ å¼€å‘è§„èŒƒ = å‘½å/å¼‚å¸¸/æ€§èƒ½/é…ç½®æ ‡å‡†
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ’ä»¶æœ¬è´¨ç†è§£**

```
ä¸‰ä¸ªæ ¸å¿ƒç†è§£ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. æ’ä»¶æ˜¯ä»£ç†
   â€¢ ä¸ä¿®æ”¹åŸä»£ç 
   â€¢ åœ¨æ–¹æ³•å‰åæ’å…¥é€»è¾‘
   â€¢ é€æ˜æ‰©å±•åŠŸèƒ½

2. æ‹¦æˆªæ˜¯æœ‰åºçš„
   â€¢ å…ˆæ·»åŠ å…ˆæ‰§è¡Œ
   â€¢ åµŒå¥—æ‰§è¡Œè¿”å›
   â€¢ é¡ºåºå½±å“ç»“æœ

3. æ—¶æœºå¾ˆé‡è¦
   â€¢ Executoræœ€å¸¸ç”¨ï¼ˆSQLæ”¹å†™ï¼‰
   â€¢ ParameterHandlerå¤„ç†å‚æ•°
   â€¢ ResultSetHandlerå¤„ç†ç»“æœ
```

**ğŸ”¹ å¼€å‘æœ€ä½³å®è·µ**

```
äº”ä¸ªé»„é‡‘æ³•åˆ™ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. ä¼˜å…ˆç”¨Executoræ‹¦æˆª
   â†’ 90%åœºæ™¯å¤Ÿç”¨

2. åˆç†å®‰æ’æ’ä»¶é¡ºåº
   â†’ ç§Ÿæˆ·â†’æƒé™â†’åˆ†é¡µâ†’å®¡è®¡

3. åšå¥½å¼‚å¸¸å¤„ç†
   â†’ è®°å½•æ—¥å¿—ï¼Œé™çº§å¤„ç†

4. æ³¨æ„æ€§èƒ½å½±å“
   â†’ é¿å…å¤æ‚è®¡ç®—ï¼Œä½¿ç”¨ç¼“å­˜

5. è§„èŒƒå‘½åå’Œæ³¨é‡Š
   â†’ è®©åˆ«äººèƒ½çœ‹æ‡‚
```

### 8.3 å®æˆ˜å¼€å‘å»ºè®®


**ğŸ¯ å¼€å‘æ£€æŸ¥æ¸…å•**

```
å¼€å‘å‰ï¼š
â–¡ æ˜ç¡®è¦è§£å†³ä»€ä¹ˆé—®é¢˜
â–¡ ç¡®å®šä½¿ç”¨å“ªä¸ªæ‹¦æˆªæ—¶æœº
â–¡ è®¾è®¡å¥½æ‰§è¡Œé¡ºåº

å¼€å‘ä¸­ï¼š
â–¡ éµå¾ªå‘½åè§„èŒƒ
â–¡ æ·»åŠ è¯¦ç»†æ³¨é‡Š
â–¡ å¤„ç†å„ç§å¼‚å¸¸
â–¡ è€ƒè™‘æ€§èƒ½å½±å“

å¼€å‘åï¼š
â–¡ ç¼–å†™å•å…ƒæµ‹è¯•
â–¡ è¿›è¡Œé›†æˆæµ‹è¯•
â–¡ æ£€æŸ¥æ—¥å¿—è¾“å‡º
â–¡ éªŒè¯æ€§èƒ½æŒ‡æ ‡
```

**å¸¸è§é—®é¢˜é€ŸæŸ¥**

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| æ’ä»¶ä¸ç”Ÿæ•ˆ | @Signatureé…ç½®é”™è¯¯ | æ£€æŸ¥type/method/argsé…ç½® |
| SQLæ”¹å†™å¤±è´¥ | æ‹¦æˆªæ—¶æœºå¤ªæ™š | æ”¹ç”¨Executoræ‹¦æˆª |
| æ€§èƒ½ä¸‹é™ | æ‹¦æˆªç‚¹é€‰æ‹©ä¸å½“ | é¿å…ç”¨ResultSetHandler |
| é¡ºåºæ··ä¹± | æ’ä»¶é¡ºåºé”™è¯¯ | è°ƒæ•´addInnerInterceptoré¡ºåº |

**è®°å¿†å£è¯€**

```
æ’ä»¶å¼€å‘è¦ç‚¹è®°å¿†ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä»£ç†æ¨¡å¼æ˜¯æ ¹æœ¬ï¼Œ
æ‹¦æˆªæ—¶æœºè¦é€‰å‡†ã€‚
æ’ä»¶é¡ºåºæœ‰è®²ç©¶ï¼Œ
å¼‚å¸¸å¤„ç†è¦è°¨æ…ã€‚
æ€§èƒ½ä¼˜åŒ–åˆ«å¿˜è®°ï¼Œ
è§„èŒƒå‘½åå¥½ä¹ æƒ¯ã€‚

Executoræœ€å¸¸ç”¨ï¼Œ
SQLæ”¹å†™å®ƒå½“å…ˆã€‚
å‚æ•°åŠ å¯†Handlerç®¡ï¼Œ
ç»“æœè„±æ•ä¹Ÿé å®ƒã€‚
```

**è¿›é˜¶å­¦ä¹ æ–¹å‘**

```
æŒæ¡åŸºç¡€åå¯ä»¥å­¦ä¹ ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. é«˜çº§æ’ä»¶å¼€å‘
   â€¢ SQL Parseræ·±åº¦ä½¿ç”¨
   â€¢ è‡ªå®šä¹‰æ³¨è§£é©±åŠ¨
   â€¢ åŠ¨æ€æ’ä»¶åŠ è½½

2. æ€§èƒ½è°ƒä¼˜
   â€¢ æ’ä»¶ç¼“å­˜ç­–ç•¥
   â€¢ å¼‚æ­¥å¤„ç†ä¼˜åŒ–
   â€¢ ç›‘æ§æŒ‡æ ‡æ”¶é›†

3. å®æˆ˜åœºæ™¯
   â€¢ å¤šæ•°æ®æºåˆ‡æ¢
   â€¢ å¤æ‚æƒé™æ§åˆ¶
   â€¢ åˆ†å¸ƒå¼è¿½è¸ª
```