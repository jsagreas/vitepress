---
title: 24ã€saveOrUpdateæ™ºèƒ½ä¿å­˜
---
## ğŸ“š ç›®å½•

1. [saveOrUpdateæ–¹æ³•æ¦‚è¿°](#1-saveOrUpdateæ–¹æ³•æ¦‚è¿°)
2. [ä¸»é”®å­˜åœ¨åˆ¤æ–­æœºåˆ¶](#2-ä¸»é”®å­˜åœ¨åˆ¤æ–­æœºåˆ¶)
3. [æ’å…¥æ›´æ–°é€»è¾‘è¯¦è§£](#3-æ’å…¥æ›´æ–°é€»è¾‘è¯¦è§£)
4. [ä¸šåŠ¡åœºæ™¯ç®€åŒ–åº”ç”¨](#4-ä¸šåŠ¡åœºæ™¯ç®€åŒ–åº”ç”¨)
5. [æ€§èƒ½å½±å“åˆ†æ](#5-æ€§èƒ½å½±å“åˆ†æ)
6. [ä½¿ç”¨æ³¨æ„äº‹é¡¹](#6-ä½¿ç”¨æ³¨æ„äº‹é¡¹)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ saveOrUpdateæ–¹æ³•æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯saveOrUpdate


**ğŸ”¸ é€šä¿—ç†è§£**
```
saveOrUpdate = saveï¼ˆä¿å­˜æ–°æ•°æ®ï¼‰+ updateï¼ˆæ›´æ–°æ—§æ•°æ®ï¼‰

å°±åƒä¸€ä¸ªæ™ºèƒ½å¼€å…³ï¼š
- æ•°æ®ä¸å­˜åœ¨ï¼Ÿâ†’ è‡ªåŠ¨æ–°å¢
- æ•°æ®å·²å­˜åœ¨ï¼Ÿâ†’ è‡ªåŠ¨æ›´æ–°
- ä¸éœ€è¦ä½ æ‰‹åŠ¨åˆ¤æ–­ï¼
```

**ğŸ’¡ å®é™…åœºæ™¯ç±»æ¯”**
```
ä¼ ç»Ÿæ–¹å¼ï¼ˆéœ€è¦æ‰‹åŠ¨åˆ¤æ–­ï¼‰ï¼š
ä½ è¦ä¿å­˜ç”¨æˆ·ä¿¡æ¯ â†’ å…ˆæŸ¥è¯¢æ•°æ®åº“çœ‹æœ‰æ²¡æœ‰è¿™ä¸ªç”¨æˆ·
â†’ æ²¡æœ‰ï¼Ÿæ‰§è¡Œinsert
â†’ æœ‰ï¼Ÿæ‰§è¡Œupdate

saveOrUpdateæ–¹å¼ï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰ï¼š
ä½ è¦ä¿å­˜ç”¨æˆ·ä¿¡æ¯ â†’ ç›´æ¥è°ƒç”¨saveOrUpdate()
â†’ æ¡†æ¶è‡ªåŠ¨åˆ¤æ–­å¹¶æ‰§è¡Œå¯¹åº”æ“ä½œ
```

### 1.2 æ ¸å¿ƒä»·å€¼


**ğŸ“Š è§£å†³çš„é—®é¢˜**

| **ä¼ ç»Ÿæ–¹å¼** | **saveOrUpdateæ–¹å¼** |
|-------------|---------------------|
| éœ€è¦å…ˆæŸ¥è¯¢åˆ¤æ–­æ˜¯å¦å­˜åœ¨ | è‡ªåŠ¨åˆ¤æ–­ï¼Œæ— éœ€æŸ¥è¯¢ |
| éœ€è¦å†™if-elseé€»è¾‘ | ä¸€è¡Œä»£ç æå®š |
| ä»£ç å†—é•¿ï¼Œå®¹æ˜“å‡ºé”™ | ç®€æ´ä¼˜é›…ï¼Œå‡å°‘bug |
| å¤šæ¬¡æ•°æ®åº“æ“ä½œ | æ™ºèƒ½ä¼˜åŒ–ï¼Œå‡å°‘IO |

**ğŸ¯ é€‚ç”¨åœºæ™¯**
- âœ… è¡¨å•æäº¤ï¼ˆä¸ç¡®å®šæ˜¯æ–°å¢è¿˜æ˜¯ä¿®æ”¹ï¼‰
- âœ… æ•°æ®å¯¼å…¥ï¼ˆå¯èƒ½æœ‰é‡å¤æ•°æ®ï¼‰
- âœ… æ‰¹é‡æ“ä½œï¼ˆæ··åˆæ–°å¢å’Œæ›´æ–°ï¼‰
- âœ… å‰åç«¯åˆ†ç¦»é¡¹ç›®ï¼ˆå‰ç«¯ä¼ æ¥çš„æ•°æ®ï¼‰

---

## 2. ğŸ” ä¸»é”®å­˜åœ¨åˆ¤æ–­æœºåˆ¶


### 2.1 åˆ¤æ–­é€»è¾‘è¯¦è§£


**ğŸ”¸ åˆ¤æ–­æµç¨‹**
```
saveOrUpdateæ¥æ”¶æ•°æ®
    â†“
æ£€æŸ¥ä¸»é”®å­—æ®µçš„å€¼
    â†“
ä¸»é”®ä¸ºnullæˆ–ç©ºï¼Ÿ
    â†“                    â†“
   YES                  NO
    â†“                    â†“
æ‰§è¡Œinsert          æŸ¥è¯¢æ•°æ®åº“
                        â†“
                   å­˜åœ¨è¯¥ä¸»é”®ï¼Ÿ
                    â†“        â†“
                   YES      NO
                    â†“        â†“
                æ‰§è¡Œupdate  æ‰§è¡Œinsert
```

**ğŸ’¡ ä¸‰ç§åˆ¤æ–­æƒ…å†µ**

```java
// æƒ…å†µ1ï¼šä¸»é”®ä¸ºnull â†’ ç›´æ¥insert
User user1 = new User();
user1.setName("å¼ ä¸‰");
// idä¸ºnull
userService.saveOrUpdate(user1);  // æ‰§è¡ŒINSERT

// æƒ…å†µ2ï¼šä¸»é”®æœ‰å€¼ä½†æ•°æ®åº“ä¸å­˜åœ¨ â†’ insert
User user2 = new User();
user2.setId(999L);  // æ•°æ®åº“æ²¡æœ‰id=999çš„è®°å½•
user2.setName("æå››");
userService.saveOrUpdate(user2);  // æ‰§è¡ŒINSERT

// æƒ…å†µ3ï¼šä¸»é”®æœ‰å€¼ä¸”æ•°æ®åº“å­˜åœ¨ â†’ update
User user3 = new User();
user3.setId(1L);  // æ•°æ®åº“æœ‰id=1çš„è®°å½•
user3.setName("ç‹äº”");
userService.saveOrUpdate(user3);  // æ‰§è¡ŒUPDATE
```

### 2.2 ä¸»é”®ç±»å‹å½±å“


**ğŸ”§ ä¸åŒä¸»é”®ç­–ç•¥çš„è¡¨ç°**

| ä¸»é”®ç­–ç•¥ | åˆ¤æ–­æ–¹å¼ | è¯´æ˜ |
|---------|---------|------|
| **AUTO** | `id == null` | æ•°æ®åº“è‡ªå¢ï¼Œnullæ—¶æ’å…¥ |
| **INPUT** | `id == null` | æ‰‹åŠ¨è¾“å…¥ï¼Œnullæ—¶æ’å…¥ |
| **ASSIGN_ID** | `id == null` | é›ªèŠ±ç®—æ³•ï¼Œnullæ—¶æ’å…¥ |
| **ASSIGN_UUID** | `id == null` | UUIDï¼Œnullæ—¶æ’å…¥ |

**âš ï¸ é‡è¦æç¤º**
```
ä¸»é”®ç­–ç•¥ä¸åŒï¼ŒsaveOrUpdateçš„è¡Œä¸ºä¹Ÿä¸åŒï¼š

@TableId(type = IdType.AUTO)  // è‡ªå¢ä¸»é”®
- æ–°æ•°æ®idå¿…é¡»ä¸ºnull
- æœ‰idå€¼æ—¶ä¼šå…ˆæŸ¥è¯¢æ•°æ®åº“

@TableId(type = IdType.ASSIGN_ID)  // é›ªèŠ±ID
- æ–°æ•°æ®ä¹Ÿä¼šè‡ªåŠ¨ç”Ÿæˆid
- éœ€è¦é¢å¤–åˆ¤æ–­é€»è¾‘
```

---

## 3. âš™ï¸ æ’å…¥æ›´æ–°é€»è¾‘è¯¦è§£


### 3.1 æºç æ‰§è¡Œæµç¨‹


**ğŸ”¸ æ‰§è¡Œæ­¥éª¤æ‹†è§£**
```
Step 1: åˆ¤æ–­ä¸»é”®æ˜¯å¦ä¸ºç©º
    â†“
Step 2: ä¸»é”®ä¸ºç©º â†’ ç›´æ¥insertï¼Œç»“æŸ
    â†“
Step 3: ä¸»é”®ä¸ä¸ºç©º â†’ æ‰§è¡ŒselectByIdæŸ¥è¯¢
    â†“
Step 4: æŸ¥è¯¢ç»“æœä¸ºnull â†’ insert
    â†“
Step 5: æŸ¥è¯¢ç»“æœä¸ä¸ºnull â†’ updateById
```

**ğŸ’» ä¼ªä»£ç å±•ç¤º**
```java
// MyBatis-Pluså†…éƒ¨å®ç°åŸç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
public boolean saveOrUpdate(T entity) {
    // Step 1: è·å–ä¸»é”®å€¼
    Serializable idValue = getId(entity);
    
    // Step 2: ä¸»é”®ä¸ºç©ºï¼Œç›´æ¥æ’å…¥
    if (idValue == null || "".equals(idValue)) {
        return save(entity);
    }
    
    // Step 3: ä¸»é”®ä¸ä¸ºç©ºï¼ŒæŸ¥è¯¢æ˜¯å¦å­˜åœ¨
    T existEntity = getById(idValue);
    
    // Step 4: ä¸å­˜åœ¨åˆ™æ’å…¥ï¼Œå­˜åœ¨åˆ™æ›´æ–°
    if (existEntity == null) {
        return save(entity);
    } else {
        return updateById(entity);
    }
}
```

### 3.2 SQLæ‰§è¡Œåˆ†æ


**ğŸ“Š ä¸åŒæƒ…å†µçš„SQLæ‰§è¡Œ**

**æƒ…å†µ1ï¼šæ–°å¢æ•°æ®ï¼ˆä¸»é”®ä¸ºnullï¼‰**
```sql
-- åªæ‰§è¡Œ1æ¡SQL
INSERT INTO user (name, age, email) 
VALUES ('å¼ ä¸‰', 25, 'zhangsan@qq.com');
```

**æƒ…å†µ2ï¼šæ›´æ–°æ•°æ®ï¼ˆä¸»é”®æœ‰å€¼ä¸”å­˜åœ¨ï¼‰**
```sql
-- æ‰§è¡Œ2æ¡SQL
-- SQL 1: å…ˆæŸ¥è¯¢
SELECT id, name, age, email FROM user WHERE id = 1;

-- SQL 2: å†æ›´æ–°
UPDATE user SET name = 'å¼ ä¸‰', age = 26 WHERE id = 1;
```

**æƒ…å†µ3ï¼šæ–°å¢æ•°æ®ï¼ˆä¸»é”®æœ‰å€¼ä½†ä¸å­˜åœ¨ï¼‰**
```sql
-- æ‰§è¡Œ2æ¡SQL
-- SQL 1: å…ˆæŸ¥è¯¢
SELECT id, name, age, email FROM user WHERE id = 999;

-- SQL 2: å†æ’å…¥
INSERT INTO user (id, name, age, email) 
VALUES (999, 'æå››', 30, 'lisi@qq.com');
```

### 3.3 æ‰¹é‡æ“ä½œæ”¯æŒ


**ğŸ”¸ æ‰¹é‡saveOrUpdate**
```java
// æ‰¹é‡å¤„ç†å¤šæ¡æ•°æ®
List<User> userList = Arrays.asList(
    new User(1L, "å¼ ä¸‰", 25),     // å­˜åœ¨ï¼Œä¼šupdate
    new User(null, "æå››", 30),   // ä¸å­˜åœ¨ï¼Œä¼šinsert
    new User(999L, "ç‹äº”", 35)    // ä¸å­˜åœ¨ï¼Œä¼šinsert
);

// ä¸€æ¬¡è°ƒç”¨å¤„ç†æ‰€æœ‰æ•°æ®
userService.saveOrUpdateBatch(userList);
```

**âš¡ æ‰¹é‡æ‰§è¡Œä¼˜åŒ–**
```
saveOrUpdateBatchå†…éƒ¨ä¼˜åŒ–ï¼š
1. åˆ†æ‰¹å¤„ç†ï¼ˆé»˜è®¤1000æ¡ä¸€æ‰¹ï¼‰
2. åŒºåˆ†insertå’Œupdateåˆ—è¡¨
3. æ‰¹é‡insertä¸€æ¬¡æ‰§è¡Œ
4. æ‰¹é‡updateä¸€æ¬¡æ‰§è¡Œ
5. å‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•°
```

---

## 4. ğŸ’¼ ä¸šåŠ¡åœºæ™¯ç®€åŒ–åº”ç”¨


### 4.1 è¡¨å•æäº¤åœºæ™¯


**ğŸ”¸ å‰åç«¯åˆ†ç¦»é¡¹ç›®**
```java
@RestController
@RequestMapping("/user")
public class UserController {
    
    @Autowired
    private IUserService userService;
    
    /**
     * ç”¨æˆ·ä¿¡æ¯ä¿å­˜æ¥å£
     * å‰ç«¯ä¸å…³å¿ƒæ˜¯æ–°å¢è¿˜æ˜¯ä¿®æ”¹ï¼Œåç«¯è‡ªåŠ¨å¤„ç†
     */
    @PostMapping("/save")
    public Result saveUser(@RequestBody User user) {
        // ä¸€è¡Œä»£ç æå®šæ–°å¢å’Œä¿®æ”¹
        boolean success = userService.saveOrUpdate(user);
        return success ? Result.ok() : Result.fail();
    }
}
```

**ğŸ’¡ ä¸šåŠ¡ä»·å€¼**
```
ä¼ ç»Ÿæ–¹å¼éœ€è¦ï¼š
1. å‰ç«¯åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯ä¿®æ”¹
2. è°ƒç”¨ä¸åŒçš„æ¥å£ï¼ˆ/add å’Œ /updateï¼‰
3. åç«¯å†™ä¸¤ä¸ªæ–¹æ³•å¤„ç†

saveOrUpdateæ–¹å¼ï¼š
1. å‰ç«¯ç›´æ¥æäº¤æ•°æ®
2. ç»Ÿä¸€è°ƒç”¨ä¸€ä¸ªæ¥å£
3. åç«¯ä¸€ä¸ªæ–¹æ³•æå®š
```

### 4.2 æ•°æ®å¯¼å…¥åœºæ™¯


**ğŸ”¸ Excelæ•°æ®å¯¼å…¥**
```java
@Service
public class UserImportService {
    
    @Autowired
    private IUserService userService;
    
    /**
     * å¯¼å…¥Excelç”¨æˆ·æ•°æ®
     * å¯èƒ½æœ‰æ–°ç”¨æˆ·ï¼Œä¹Ÿå¯èƒ½æ›´æ–°æ—§ç”¨æˆ·
     */
    public void importUsers(List<User> excelUsers) {
        // ç›´æ¥æ‰¹é‡ä¿å­˜ï¼Œè‡ªåŠ¨å¤„ç†æ–°å¢å’Œæ›´æ–°
        userService.saveOrUpdateBatch(excelUsers);
    }
}
```

**ğŸ“Š å®é™…æ•ˆæœ**
```
å¯¼å…¥100æ¡ç”¨æˆ·æ•°æ®ï¼š
- 50æ¡æ˜¯æ–°ç”¨æˆ· â†’ è‡ªåŠ¨insert
- 30æ¡æ˜¯æ›´æ–°æ—§ç”¨æˆ·ä¿¡æ¯ â†’ è‡ªåŠ¨update  
- 20æ¡ä¸»é”®å†²çªéœ€è¦è¦†ç›– â†’ è‡ªåŠ¨update

ä¸éœ€è¦æ‰‹åŠ¨åˆ†ç±»å¤„ç†ï¼
```

### 4.3 ç¼“å­˜åŒæ­¥åœºæ™¯


**ğŸ”¸ ç¼“å­˜æ›´æ–°åœºæ™¯**
```java
@Service
public class UserCacheService {
    
    @Autowired
    private IUserService userService;
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    /**
     * ä»ç¼“å­˜åŒæ­¥åˆ°æ•°æ®åº“
     */
    public void syncCacheToDb(Long userId) {
        // ä»Redisè·å–ç”¨æˆ·ä¿¡æ¯
        User cacheUser = (User) redisTemplate.opsForValue()
            .get("user:" + userId);
        
        if (cacheUser != null) {
            // è‡ªåŠ¨åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯æ›´æ–°
            userService.saveOrUpdate(cacheUser);
        }
    }
}
```

### 4.4 å¯¹æ¯”ä¼ ç»Ÿå®ç°


**âŒ ä¼ ç»Ÿæ–¹å¼ï¼ˆä»£ç å†—é•¿ï¼‰**
```java
public void saveUser(User user) {
    if (user.getId() == null) {
        // æ–°å¢é€»è¾‘
        userService.save(user);
    } else {
        // æŸ¥è¯¢æ˜¯å¦å­˜åœ¨
        User existUser = userService.getById(user.getId());
        if (existUser == null) {
            // ä¸å­˜åœ¨åˆ™æ–°å¢
            userService.save(user);
        } else {
            // å­˜åœ¨åˆ™æ›´æ–°
            userService.updateById(user);
        }
    }
}
```

**âœ… saveOrUpdateæ–¹å¼ï¼ˆç®€æ´ä¼˜é›…ï¼‰**
```java
public void saveUser(User user) {
    userService.saveOrUpdate(user);
}
```

---

## 5. ğŸ“ˆ æ€§èƒ½å½±å“åˆ†æ


### 5.1 SQLæ‰§è¡Œå¼€é”€


**ğŸ”¸ ä¸åŒåœºæ™¯çš„æ€§èƒ½è¡¨ç°**

| æ“ä½œç±»å‹ | SQLæ‰§è¡Œæ¬¡æ•° | æ€§èƒ½è¯„ä»· | é€‚ç”¨åœºæ™¯ |
|---------|-----------|---------|---------|
| **çº¯æ–°å¢** | 1æ¬¡INSERT | â­â­â­â­â­ ä¼˜ç§€ | æ‰¹é‡å¯¼å…¥æ–°æ•°æ® |
| **çº¯æ›´æ–°** | 1æ¬¡SELECT + 1æ¬¡UPDATE | â­â­â­ ä¸€èˆ¬ | å·²çŸ¥æ•°æ®å­˜åœ¨ |
| **æ··åˆæ“ä½œ** | éƒ¨åˆ†1æ¬¡ï¼Œéƒ¨åˆ†2æ¬¡ | â­â­â­â­ è‰¯å¥½ | ä¸ç¡®å®šæ•°æ®çŠ¶æ€ |

**ğŸ’¡ æ€§èƒ½å¯¹æ¯”**
```
åœºæ™¯ï¼šä¿å­˜100æ¡æ•°æ®

æ–¹æ¡ˆ1ï¼šå…¨éƒ¨ä½¿ç”¨saveOrUpdate
- æ–°å¢æ•°æ®ï¼š100æ¬¡INSERT
- æ›´æ–°æ•°æ®ï¼š100æ¬¡SELECT + 100æ¬¡UPDATE
- æ€»è®¡ï¼š100-200æ¬¡æ•°æ®åº“æ“ä½œ

æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨åˆ¤æ–­ååˆ†æ‰¹å¤„ç†
- å…ˆæŸ¥è¯¢ï¼š1æ¬¡æ‰¹é‡SELECTï¼ˆ100æ¡ï¼‰
- å†åˆ†åˆ«å¤„ç†ï¼š
  * æ–°å¢ï¼š1æ¬¡æ‰¹é‡INSERTï¼ˆå‡è®¾50æ¡ï¼‰
  * æ›´æ–°ï¼š1æ¬¡æ‰¹é‡UPDATEï¼ˆå‡è®¾50æ¡ï¼‰
- æ€»è®¡ï¼š3æ¬¡æ•°æ®åº“æ“ä½œ

ç»“è®ºï¼šæ˜ç¡®çŸ¥é“æ•°æ®çŠ¶æ€æ—¶ï¼Œæ‰‹åŠ¨åˆ†æ‰¹å¤„ç†æ›´å¿«
```

### 5.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ğŸ¯ ä¼˜åŒ–ç­–ç•¥**

**ç­–ç•¥1ï¼šæ˜ç¡®åœºæ™¯æ—¶ä¸ç”¨saveOrUpdate**
```java
// âŒ æ˜çŸ¥é“æ˜¯æ–°å¢ï¼Œä¸è¦ç”¨saveOrUpdate
public void batchInsertNewUsers(List<User> newUsers) {
    // å¤šæ‰§è¡Œäº†æŸ¥è¯¢æ“ä½œ
    userService.saveOrUpdateBatch(newUsers);
}

// âœ… ç›´æ¥ä½¿ç”¨saveBatch
public void batchInsertNewUsers(List<User> newUsers) {
    userService.saveBatch(newUsers);
}
```

**ç­–ç•¥2ï¼šå¤§æ‰¹é‡æ•°æ®æ‰‹åŠ¨åˆ†ç±»**
```java
// âœ… å¤§æ‰¹é‡æ—¶å…ˆåˆ†ç±»å†å¤„ç†
public void smartBatchSave(List<User> users) {
    // åˆ†ç¦»æœ‰idå’Œæ— idçš„æ•°æ®
    List<User> newUsers = users.stream()
        .filter(u -> u.getId() == null)
        .collect(Collectors.toList());
        
    List<User> updateUsers = users.stream()
        .filter(u -> u.getId() != null)
        .collect(Collectors.toList());
    
    // åˆ†åˆ«æ‰¹é‡å¤„ç†
    if (!newUsers.isEmpty()) {
        userService.saveBatch(newUsers);
    }
    
    if (!updateUsers.isEmpty()) {
        userService.updateBatchById(updateUsers);
    }
}
```

**ç­–ç•¥3ï¼šä½¿ç”¨MySQLçš„REPLACEæˆ–ON DUPLICATE KEY**
```java
// æ›´é«˜æ•ˆçš„æ–¹å¼ï¼šä½¿ç”¨æ•°æ®åº“ç‰¹æ€§
@Mapper
public interface UserMapper extends BaseMapper<User> {
    
    @Insert("INSERT INTO user(id, name, age) " +
            "VALUES(#{id}, #{name}, #{age}) " +
            "ON DUPLICATE KEY UPDATE " +
            "name = VALUES(name), age = VALUES(age)")
    int saveOrUpdateBySQL(User user);
}
```

### 5.3 æ€§èƒ½æµ‹è¯•æ•°æ®


**ğŸ“Š å®æµ‹å¯¹æ¯”ï¼ˆ1000æ¡æ•°æ®ï¼‰**
```
æµ‹è¯•ç¯å¢ƒï¼šMySQL 8.0ï¼Œæœ¬åœ°ç½‘ç»œ

saveOrUpdateæ–¹å¼ï¼š
- å…¨æ–°å¢ï¼š500msï¼ˆ1000æ¬¡INSERTï¼‰
- å…¨æ›´æ–°ï¼š1200msï¼ˆ1000æ¬¡SELECT + 1000æ¬¡UPDATEï¼‰
- æ··åˆæ“ä½œï¼š850msï¼ˆå¹³å‡ï¼‰

ä¼˜åŒ–åæ–¹å¼ï¼š
- åˆ†ç±»æ‰¹é‡å¤„ç†ï¼š200msï¼ˆ1æ¬¡SELECT + 2æ¬¡æ‰¹é‡æ“ä½œï¼‰
- ä½¿ç”¨SQLç‰¹æ€§ï¼š180msï¼ˆ1æ¬¡æ‰¹é‡REPLACEï¼‰

ç»“è®ºï¼šæ˜ç¡®åœºæ™¯ä¼˜åŒ–å¯æå‡4-6å€æ€§èƒ½
```

---

## 6. âš ï¸ ä½¿ç”¨æ³¨æ„äº‹é¡¹


### 6.1 ä¸»é”®ç­–ç•¥å½±å“


**ğŸ”¸ è‡ªå¢ä¸»é”®çš„é—®é¢˜**
```java
// âŒ é”™è¯¯ç”¨æ³•ï¼šè‡ªå¢ä¸»é”®æ‰‹åŠ¨è®¾ç½®id
@TableId(type = IdType.AUTO)
private Long id;

User user = new User();
user.setId(100L);  // æ‰‹åŠ¨è®¾ç½®
user.setName("å¼ ä¸‰");
userService.saveOrUpdate(user);

// é—®é¢˜ï¼š
// 1. ä¼šå…ˆæŸ¥è¯¢id=100æ˜¯å¦å­˜åœ¨
// 2. å¦‚æœä¸å­˜åœ¨ï¼Œinsertæ—¶id=100å¯èƒ½å†²çª
// 3. å¦‚æœå­˜åœ¨ï¼Œä¼šæ‰§è¡Œupdateè€Œä¸æ˜¯insert
```

**âœ… æ­£ç¡®ç”¨æ³•**
```java
// æ–°å¢æ—¶ä¸è®¾ç½®idï¼Œè®©æ•°æ®åº“è‡ªå¢
User user = new User();
// user.setId(100L);  ä¸è®¾ç½®ï¼
user.setName("å¼ ä¸‰");
userService.saveOrUpdate(user);

// æ›´æ–°æ—¶æ‰è®¾ç½®id
User updateUser = new User();
updateUser.setId(1L);  // æ˜ç¡®è¦æ›´æ–°çš„è®°å½•
updateUser.setName("æå››");
userService.saveOrUpdate(updateUser);
```

### 6.2 ä¹è§‚é”é—®é¢˜


**ğŸ”¸ ä¹è§‚é”å†²çªå¤„ç†**
```java
@Data
public class User {
    @TableId
    private Long id;
    
    private String name;
    
    @Version  // ä¹è§‚é”å­—æ®µ
    private Integer version;
}

// âš ï¸ æ³¨æ„ï¼šsaveOrUpdateæ—¶versionè¦æ­£ç¡®
User user = userService.getById(1L);  
// æ­¤æ—¶ version = 1

user.setName("æ–°åå­—");
// ç›´æ¥saveOrUpdateå¯èƒ½å¤±è´¥
userService.saveOrUpdate(user);

// åŸå› ï¼š
// 1. å…ˆæŸ¥è¯¢å¾—åˆ°version=1
// 2. updateæ—¶æ¡ä»¶æ˜¯ WHERE id=1 AND version=1
// 3. å¦‚æœå…¶ä»–çº¿ç¨‹å·²æ›´æ–°ï¼Œversionå˜æˆ2
// 4. updateå¤±è´¥ï¼Œä½†saveOrUpdateä¸ä¼šæŠ›å¼‚å¸¸
```

**âœ… è§£å†³æ–¹æ¡ˆ**
```java
// æ–¹æ¡ˆ1ï¼šä½¿ç”¨updateByIdä»£æ›¿
User user = userService.getById(1L);
user.setName("æ–°åå­—");
boolean success = userService.updateById(user);
if (!success) {
    // å¤„ç†ä¹è§‚é”å†²çª
    throw new RuntimeException("æ•°æ®å·²è¢«ä¿®æ”¹ï¼Œè¯·é‡è¯•");
}

// æ–¹æ¡ˆ2ï¼šé‡è¯•æœºåˆ¶
@Retryable(maxAttempts = 3)
public void updateUserWithRetry(Long id, String name) {
    User user = userService.getById(id);
    user.setName(name);
    boolean success = userService.updateById(user);
    if (!success) {
        throw new OptimisticLockException();
    }
}
```

### 6.3 äº‹åŠ¡æ§åˆ¶è¦ç‚¹


**ğŸ”¸ äº‹åŠ¡ä¸­çš„è¡¨ç°**
```java
@Service
public class UserService {
    
    @Transactional
    public void complexOperation(User user) {
        // saveOrUpdateåœ¨äº‹åŠ¡ä¸­
        userService.saveOrUpdate(user);
        
        // å¦‚æœåç»­æ“ä½œå¤±è´¥ï¼Œä¼šå›æ»š
        // åŒ…æ‹¬saveOrUpdateçš„æ“ä½œ
        otherService.doSomething();  // å¯èƒ½æŠ›å¼‚å¸¸
    }
}
```

**âš ï¸ äº‹åŠ¡æ³¨æ„**
```
1. saveOrUpdateæœ¬èº«ä¸å¼€å¯äº‹åŠ¡
2. éœ€è¦åœ¨Serviceå±‚æ–¹æ³•ä¸ŠåŠ @Transactional
3. æŸ¥è¯¢æ“ä½œï¼ˆåˆ¤æ–­ä¸»é”®ï¼‰ä¹Ÿåœ¨äº‹åŠ¡å†…
4. å¤±è´¥åæ•´ä½“å›æ»š
```

### 6.4 æ‰¹é‡æ“ä½œé™åˆ¶


**ğŸ”¸ æ‰¹é‡å¤§å°æ§åˆ¶**
```java
// âŒ ä¸€æ¬¡å¤„ç†10000æ¡å¯èƒ½å†…å­˜æº¢å‡º
List<User> hugeList = queryHugeData();  // 10000æ¡
userService.saveOrUpdateBatch(hugeList);

// âœ… åˆ†æ‰¹å¤„ç†
List<User> hugeList = queryHugeData();
int batchSize = 1000;

for (int i = 0; i < hugeList.size(); i += batchSize) {
    int end = Math.min(i + batchSize, hugeList.size());
    List<User> batch = hugeList.subList(i, end);
    userService.saveOrUpdateBatch(batch);
}
```

**ğŸ”§ é…ç½®æ‰¹é‡å¤§å°**
```java
// ä¿®æ”¹é»˜è®¤æ‰¹é‡å¤§å°
userService.saveOrUpdateBatch(userList, 500);  // 500æ¡ä¸€æ‰¹
```

### 6.5 å­—æ®µæ›´æ–°é—®é¢˜


**ğŸ”¸ nullå€¼æ›´æ–°é—®é¢˜**
```java
// åœºæ™¯ï¼šåªæƒ³æ›´æ–°éƒ¨åˆ†å­—æ®µ
User user = new User();
user.setId(1L);
user.setName("æ–°åå­—");  // åªè®¾ç½®name
// ageã€emailç­‰å­—æ®µä¸ºnull

userService.saveOrUpdate(user);

// é—®é¢˜ï¼š
// ä¼šæŠŠageã€emailç­‰å­—æ®µæ›´æ–°ä¸ºnullï¼
// SQL: UPDATE user SET name='æ–°åå­—', age=NULL, email=NULL WHERE id=1
```

**âœ… è§£å†³æ–¹æ¡ˆ**
```java
// æ–¹æ¡ˆ1ï¼šä½¿ç”¨LambdaUpdateWrapper
userService.update(
    Wrappers.<User>lambdaUpdate()
        .eq(User::getId, 1L)
        .set(User::getName, "æ–°åå­—")
);

// æ–¹æ¡ˆ2ï¼šå…ˆæŸ¥è¯¢å†æ›´æ–°
User user = userService.getById(1L);
user.setName("æ–°åå­—");  // åªä¿®æ”¹éœ€è¦çš„å­—æ®µ
userService.updateById(user);

// æ–¹æ¡ˆ3ï¼šä½¿ç”¨@TableFieldé…ç½®
@TableField(updateStrategy = FieldStrategy.NOT_NULL)
private String name;  // nullå€¼ä¸æ›´æ–°
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ saveOrUpdate = æ™ºèƒ½ä¿å­˜æ–¹æ³•ï¼Œè‡ªåŠ¨åˆ¤æ–­æ–°å¢æˆ–æ›´æ–°
ğŸ”¸ åˆ¤æ–­ä¾æ® = ä¸»é”®æ˜¯å¦ä¸ºnull + æ•°æ®åº“æ˜¯å¦å­˜åœ¨
ğŸ”¸ æ‰§è¡Œé€»è¾‘ = æœ€å°‘1æ¬¡SQLï¼Œæœ€å¤š2æ¬¡SQL
ğŸ”¸ æ ¸å¿ƒä»·å€¼ = ç®€åŒ–ä»£ç ï¼Œå‡å°‘åˆ¤æ–­é€»è¾‘
ğŸ”¸ é€‚ç”¨åœºæ™¯ = ä¸ç¡®å®šæ•°æ®çŠ¶æ€çš„ä¿å­˜æ“ä½œ
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å·¥ä½œåŸç†**
```
æ ¸å¿ƒæµç¨‹ï¼š
1. æ£€æŸ¥ä¸»é”®å€¼
2. ä¸»é”®ä¸ºç©º â†’ ç›´æ¥INSERT
3. ä¸»é”®ä¸ä¸ºç©º â†’ SELECTæŸ¥è¯¢
4. æŸ¥è¯¢ç»“æœå†³å®šINSERTè¿˜æ˜¯UPDATE

è®°å¿†å£è¯€ï¼š
"ä¸»é”®ä¸ºç©ºç›´æ¥å­˜ï¼Œä¸»é”®æœ‰å€¼å…ˆæŸ¥è¯¢
æŸ¥åˆ°æ•°æ®å°±æ›´æ–°ï¼ŒæŸ¥ä¸åˆ°æ•°æ®å°±æ–°å¢"
```

**ğŸ”¹ æ€§èƒ½è€ƒé‡**
```
ä¼˜åŠ¿ï¼š
âœ… ä»£ç ç®€æ´ï¼Œå¼€å‘æ•ˆç‡é«˜
âœ… è‡ªåŠ¨å¤„ç†ï¼Œå‡å°‘bug

åŠ£åŠ¿ï¼š
âŒ å¯èƒ½å¤šä¸€æ¬¡æŸ¥è¯¢
âŒ å¤§æ‰¹é‡æ—¶æ•ˆç‡ä¸å¦‚æ‰‹åŠ¨åˆ†ç±»

é€‰æ‹©åŸåˆ™ï¼š
- å°æ‰¹é‡ã€ä¸ç¡®å®šçŠ¶æ€ â†’ ç”¨saveOrUpdate
- å¤§æ‰¹é‡ã€æ˜ç¡®çŠ¶æ€ â†’ æ‰‹åŠ¨åˆ†ç±»å¤„ç†
- è¿½æ±‚æè‡´æ€§èƒ½ â†’ ä½¿ç”¨SQLç‰¹æ€§
```

**ğŸ”¹ ä½¿ç”¨æŠ€å·§**
```
æŠ€å·§1ï¼šæ˜ç¡®åœºæ™¯é€‰å¯¹æ–¹æ³•
- ç¡®å®šæ–°å¢ â†’ save/saveBatch
- ç¡®å®šæ›´æ–° â†’ updateById/updateBatchById  
- ä¸ç¡®å®š â†’ saveOrUpdate/saveOrUpdateBatch

æŠ€å·§2ï¼šæ³¨æ„ä¸»é”®ç­–ç•¥
- AUTOè‡ªå¢ â†’ æ–°å¢æ—¶idå¿…é¡»ä¸ºnull
- ASSIGN_ID â†’ æ³¨æ„åˆ¤æ–­é€»è¾‘

æŠ€å·§3ï¼šå¤„ç†ç‰¹æ®Šå­—æ®µ
- ä¹è§‚é” â†’ ä½¿ç”¨updateByIdæ›´å®‰å…¨
- nullå€¼ â†’ é…ç½®æ›´æ–°ç­–ç•¥æˆ–å…ˆæŸ¥è¯¢
```

### 7.3 å®æˆ˜åº”ç”¨å»ºè®®


**ğŸ’¼ ä¸šåŠ¡åœºæ™¯é€‰æ‹©**
```
âœ… æ¨èä½¿ç”¨saveOrUpdateçš„åœºæ™¯ï¼š
- è¡¨å•æäº¤ï¼ˆPCç«¯/ç§»åŠ¨ç«¯ï¼‰
- æ•°æ®å¯¼å…¥ï¼ˆExcel/CSVï¼‰
- æ¥å£å¯¹æ¥ï¼ˆç¬¬ä¸‰æ–¹æ•°æ®ï¼‰
- ç¼“å­˜åŒæ­¥ï¼ˆRedis â†’ DBï¼‰
- å‰åç«¯åˆ†ç¦»é¡¹ç›®

âŒ ä¸æ¨èä½¿ç”¨saveOrUpdateçš„åœºæ™¯ï¼š
- æ˜ç¡®çš„æ‰¹é‡æ–°å¢
- æ˜ç¡®çš„æ‰¹é‡æ›´æ–°
- è¶…å¤§æ•°æ®é‡æ“ä½œ
- å¯¹æ€§èƒ½è¦æ±‚æé«˜çš„åœºæ™¯
```

**ğŸ”§ æœ€ä½³å®è·µ**
```java
// 1. è¡¨å•æäº¤ç»Ÿä¸€æ¥å£
@PostMapping("/save")
public Result save(@RequestBody User user) {
    return Result.ok(userService.saveOrUpdate(user));
}

// 2. æ•°æ®å¯¼å…¥åˆ†æ‰¹å¤„ç†
public void importData(List<User> list) {
    // æŒ‰1000æ¡åˆ†æ‰¹
    userService.saveOrUpdateBatch(list, 1000);
}

// 3. å®šæ—¶ä»»åŠ¡æ•°æ®åŒæ­¥
@Scheduled(cron = "0 0 2 * * ?")
public void syncData() {
    List<User> cacheList = getCacheData();
    userService.saveOrUpdateBatch(cacheList);
}

// 4. å¤§æ‰¹é‡ä¼˜åŒ–å¤„ç†
public void smartBatchSave(List<User> users) {
    Map<Boolean, List<User>> grouped = users.stream()
        .collect(Collectors.partitioningBy(u -> u.getId() == null));
    
    userService.saveBatch(grouped.get(true));      // æ–°å¢
    userService.updateBatchById(grouped.get(false)); // æ›´æ–°
}
```

### 7.4 å¸¸è§é—®é¢˜è§£ç­”


**â“ Q1: saveOrUpdateä»€ä¹ˆæ—¶å€™æ‰§è¡ŒINSERTï¼Ÿ**
```
A: ä¸¤ç§æƒ…å†µä¼šINSERTï¼š
1. ä¸»é”®å€¼ä¸ºnull
2. ä¸»é”®å€¼ä¸ä¸ºnullï¼Œä½†æ•°æ®åº“æŸ¥è¯¢ä¸åˆ°å¯¹åº”è®°å½•
```

**â“ Q2: ä¸ºä»€ä¹ˆæœ‰æ—¶å€™saveOrUpdateæ¯”è¾ƒæ…¢ï¼Ÿ**
```
A: å› ä¸ºéœ€è¦å…ˆæŸ¥è¯¢ï¼š
- ä¸»é”®ä¸ä¸ºnullæ—¶ï¼Œå…ˆæ‰§è¡ŒSELECT
- å¦‚æœæ•°æ®åº“è®°å½•å¤šï¼ŒæŸ¥è¯¢å¯èƒ½æ…¢
- å»ºè®®ï¼šæ˜ç¡®æ˜¯æ›´æ–°æ—¶ï¼Œç›´æ¥ç”¨updateById
```

**â“ Q3: æ‰¹é‡æ“ä½œæ—¶å¦‚ä½•æé«˜æ€§èƒ½ï¼Ÿ**
```
A: ä¸‰ä¸ªä¼˜åŒ–æ–¹å‘ï¼š
1. æ‰‹åŠ¨åˆ†ç±»ï¼šå°†æ–°å¢å’Œæ›´æ–°åˆ†å¼€å¤„ç†
2. æ§åˆ¶æ‰¹é‡å¤§å°ï¼šé»˜è®¤1000æ¡ï¼Œå¯è°ƒæ•´
3. ä½¿ç”¨æ•°æ®åº“ç‰¹æ€§ï¼šREPLACEæˆ–ON DUPLICATE KEY
```

**â“ Q4: ä¹è§‚é”å†²çªæ€ä¹ˆåŠï¼Ÿ**
```
A: å»ºè®®ä½¿ç”¨updateByIdï¼š
- saveOrUpdateå¤±è´¥ä¸æŠ›å¼‚å¸¸
- updateByIdè¿”å›falseå¯ä»¥æ•è·
- åŠ é‡è¯•æœºåˆ¶å¤„ç†å†²çª
```

**æ ¸å¿ƒè®°å¿†**ï¼š
```
ğŸ’¡ saveOrUpdateä¸‰æ­¥èµ°ï¼š
   1. çœ‹ä¸»é”®ï¼šç©ºå°±å­˜
   2. ä¸ç©ºå°±æŸ¥ï¼šæœ‰å°±æ›´æ–°
   3. æŸ¥ä¸åˆ°å°±å­˜ï¼šä¸€æ°”å‘µæˆ
   
âš¡ ä½¿ç”¨åŸåˆ™ï¼š
   åœºæ™¯ä¸æ˜ç”¨saveOrUpdate
   åœºæ™¯æ˜ç¡®é€‰ä¸“ç”¨æ–¹æ³•
   æ€§èƒ½ä¼˜å…ˆæ‰‹åŠ¨åˆ†ç±»
```