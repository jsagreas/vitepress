---
title: 41ã€å¤šç§Ÿæˆ·æ’ä»¶
---
## ğŸ“š ç›®å½•

1. [å¤šç§Ÿæˆ·æ¦‚å¿µç†è§£](#1-å¤šç§Ÿæˆ·æ¦‚å¿µç†è§£)
2. [TenantLineInnerInterceptoræ ¸å¿ƒæ‹¦æˆªå™¨](#2-TenantLineInnerInterceptoræ ¸å¿ƒæ‹¦æˆªå™¨)
3. [ç§Ÿæˆ·å­—æ®µé…ç½®è¯¦è§£](#3-ç§Ÿæˆ·å­—æ®µé…ç½®è¯¦è§£)
4. [æ•°æ®éš”ç¦»æœºåˆ¶åŸç†](#4-æ•°æ®éš”ç¦»æœºåˆ¶åŸç†)
5. [å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡](#5-å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡)
6. [SQLè‡ªåŠ¨æ‹¼æ¥æœºåˆ¶](#6-SQLè‡ªåŠ¨æ‹¼æ¥æœºåˆ¶)
7. [ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†](#7-ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†)
8. [å®æˆ˜åº”ç”¨æŒ‡å—](#8-å®æˆ˜åº”ç”¨æŒ‡å—)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¢ å¤šç§Ÿæˆ·æ¦‚å¿µç†è§£


### 1.1 ä»€ä¹ˆæ˜¯å¤šç§Ÿæˆ·


ğŸ’­ **å…ˆæƒ³è±¡ä¸€ä¸ªåœºæ™¯**ï¼š
```
ä½ å¼€å‘äº†ä¸€ä¸ªSaaSç³»ç»Ÿï¼ˆæ¯”å¦‚åœ¨çº¿åŠå…¬è½¯ä»¶ï¼‰
ä¸åŒå…¬å¸éƒ½åœ¨ç”¨ä½ çš„ç³»ç»Ÿï¼š
- Aå…¬å¸æœ‰100ä¸ªå‘˜å·¥åœ¨ç”¨
- Bå…¬å¸æœ‰50ä¸ªå‘˜å·¥åœ¨ç”¨  
- Cå…¬å¸æœ‰200ä¸ªå‘˜å·¥åœ¨ç”¨

é—®é¢˜æ¥äº†ï¼š
ğŸ¤” å¦‚ä½•ä¿è¯Aå…¬å¸çœ‹ä¸åˆ°Bå…¬å¸çš„æ•°æ®ï¼Ÿ
ğŸ¤” å¦‚ä½•è®©æ¯ä¸ªå…¬å¸æ„Ÿè§‰è¿™æ˜¯"ä»–ä»¬è‡ªå·±çš„ç³»ç»Ÿ"ï¼Ÿ
```

**ğŸ·ï¸ å¤šç§Ÿæˆ·å®šä¹‰**ï¼š
- **ç§Ÿæˆ·ï¼ˆTenantï¼‰**ï¼šå°±æ˜¯æŒ‡ä½¿ç”¨ç³»ç»Ÿçš„æ¯ä¸ªç‹¬ç«‹å®¢æˆ·ï¼ˆæ¯”å¦‚æ¯ä¸ªå…¬å¸ï¼‰
- **å¤šç§Ÿæˆ·ï¼ˆMulti-Tenantï¼‰**ï¼šä¸€å¥—ç³»ç»ŸæœåŠ¡å¤šä¸ªå®¢æˆ·ï¼Œä½†æ•°æ®äº’ç›¸éš”ç¦»

ğŸŒ° **ç”Ÿæ´»ä¸­çš„ä¾‹å­**ï¼š
```
å¤šç§Ÿæˆ·ç³»ç»Ÿ = å…¬å¯“æ¥¼
- æ•´æ ‹æ¥¼æ˜¯åŒä¸€ä¸ªç³»ç»Ÿ
- æ¯æˆ·äººå®¶æ˜¯ä¸€ä¸ªç§Ÿæˆ·
- æ¯æˆ·æœ‰è‡ªå·±çš„é—¨é”ï¼ˆæ•°æ®éš”ç¦»ï¼‰
- å…±äº«ç”µæ¢¯ã€æ°´ç”µï¼ˆå…±äº«åŸºç¡€è®¾æ–½ï¼‰
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å¤šç§Ÿæˆ·


**ğŸ’° ä»æˆæœ¬è§’åº¦**ï¼š
```
ä¼ ç»Ÿåšæ³•ï¼ˆæ¯ä¸ªå®¢æˆ·ç‹¬ç«‹éƒ¨ç½²ï¼‰ï¼š
Aå…¬å¸ â†’ ç‹¬ç«‹æœåŠ¡å™¨ â†’ ç‹¬ç«‹æ•°æ®åº“
Bå…¬å¸ â†’ ç‹¬ç«‹æœåŠ¡å™¨ â†’ ç‹¬ç«‹æ•°æ®åº“
Cå…¬å¸ â†’ ç‹¬ç«‹æœåŠ¡å™¨ â†’ ç‹¬ç«‹æ•°æ®åº“
æˆæœ¬ï¼š3å°æœåŠ¡å™¨ + 3ä¸ªæ•°æ®åº“ + 3ä»½ç»´æŠ¤

å¤šç§Ÿæˆ·åšæ³•ï¼š
Aã€Bã€Cå…¬å¸ â†’ å…±äº«æœåŠ¡å™¨ â†’ å…±äº«æ•°æ®åº“ï¼ˆæ•°æ®éš”ç¦»ï¼‰
æˆæœ¬ï¼š1å°æœåŠ¡å™¨ + 1ä¸ªæ•°æ®åº“ + 1ä»½ç»´æŠ¤
èŠ‚çœï¼š60%ä»¥ä¸Šçš„æˆæœ¬ï¼
```

**âš¡ ä»å¼€å‘è§’åº¦**ï¼š
```
å¥½å¤„ï¼š
âœ… ä¸€æ¬¡å¼€å‘ï¼Œæ‰€æœ‰ç§Ÿæˆ·å…±äº«
âœ… ä¸€æ¬¡å‡çº§ï¼Œæ‰€æœ‰ç§Ÿæˆ·åŒæ­¥æ›´æ–°
âœ… ç»Ÿä¸€è¿ç»´ï¼Œé™ä½ç®¡ç†æˆæœ¬
âœ… èµ„æºå…±äº«ï¼Œæé«˜åˆ©ç”¨ç‡
```

### 1.3 å¤šç§Ÿæˆ·çš„ä¸‰ç§å®ç°æ–¹å¼


**ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆç±»å‹ | éš”ç¦»çº§åˆ« | æˆæœ¬ | é€‚ç”¨åœºæ™¯ | MyBatis-Plusæ”¯æŒ |
|---------|---------|------|---------|-----------------|
| **ç‹¬ç«‹æ•°æ®åº“** | `æœ€é«˜ï¼Œæ¯ä¸ªç§Ÿæˆ·ä¸€ä¸ªæ•°æ®åº“` | `å¾ˆé«˜` | `å¤§å®¢æˆ·ï¼Œæ•°æ®å®‰å…¨è¦æ±‚æé«˜` | `éœ€è¦åŠ¨æ€æ•°æ®æº` |
| **å…±äº«æ•°æ®åº“ï¼Œç‹¬ç«‹Schema** | `ä¸­ç­‰ï¼ŒåŒåº“ä¸åŒSchema` | `ä¸­ç­‰` | `ä¸­å‹å®¢æˆ·ï¼Œå¹³è¡¡æ€§èƒ½ä¸éš”ç¦»` | `éœ€è¦åŠ¨æ€Schema` |
| **å…±äº«æ•°æ®åº“ï¼Œå…±äº«è¡¨** | `åŸºç¡€ï¼Œé€šè¿‡å­—æ®µåŒºåˆ†` | `å¾ˆä½` | `ä¸­å°å®¢æˆ·ï¼Œå¤§é‡ç§Ÿæˆ·` | `âœ… æœ¬ç« é‡ç‚¹` |

**ğŸ” é‡ç‚¹ç†è§£ï¼šå…±äº«è¡¨æ–¹å¼**
```
usersè¡¨ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   id   â”‚ tenant_idâ”‚  name  â”‚   email    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   1    â”‚   100    â”‚ å¼ ä¸‰   â”‚ zhang@a.comâ”‚  â† Aå…¬å¸çš„æ•°æ®
â”‚   2    â”‚   100    â”‚ æå››   â”‚ li@a.com   â”‚  â† Aå…¬å¸çš„æ•°æ®
â”‚   3    â”‚   200    â”‚ ç‹äº”   â”‚ wang@b.com â”‚  â† Bå…¬å¸çš„æ•°æ®
â”‚   4    â”‚   200    â”‚ èµµå…­   â”‚ zhao@b.com â”‚  â† Bå…¬å¸çš„æ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®ç‚¹ï¼š
â€¢ tenant_idå°±æ˜¯ç§Ÿæˆ·æ ‡è¯†å­—æ®µ
â€¢ æ‰€æœ‰å…¬å¸æ•°æ®åœ¨åŒä¸€å¼ è¡¨
â€¢ é€šè¿‡tenant_idåŒºåˆ†ä¸åŒç§Ÿæˆ·
```

---

## 2. ğŸ”Œ TenantLineInnerInterceptoræ ¸å¿ƒæ‹¦æˆªå™¨


### 2.1 æ‹¦æˆªå™¨çš„ä½œç”¨


ğŸ’¡ **ç®€å•ç†è§£**ï¼š
```
æ‹¦æˆªå™¨ = ä¿å®‰
ä½ å†™çš„SQL = è¿›å‡ºçš„äºº
æ‹¦æˆªå™¨çš„å·¥ä½œ = æ£€æŸ¥å¹¶ä¿®æ”¹SQL

ä½ å†™çš„SQLï¼š
SELECT * FROM users WHERE name = 'å¼ ä¸‰'

æ‹¦æˆªå™¨è‡ªåŠ¨æ”¹æˆï¼š
SELECT * FROM users WHERE name = 'å¼ ä¸‰' AND tenant_id = 100
                                          â†‘
                                    è‡ªåŠ¨åŠ ä¸Šçš„
```

**ğŸ”¸ æ ¸å¿ƒåŠŸèƒ½**ï¼š
- **è‡ªåŠ¨æ·»åŠ **ï¼šåœ¨SQLä¸­è‡ªåŠ¨åŠ ä¸Šç§Ÿæˆ·æ¡ä»¶
- **é€æ˜å¤„ç†**ï¼šå¼€å‘è€…ä¸éœ€è¦æ‰‹åŠ¨å†™ç§Ÿæˆ·æ¡ä»¶
- **å…¨å±€ç”Ÿæ•ˆ**ï¼šæ‰€æœ‰SQLéƒ½ä¼šè‡ªåŠ¨å¤„ç†

### 2.2 æ‹¦æˆªå™¨é…ç½®


**ğŸ“ åŸºç¡€é…ç½®ä»£ç **ï¼š

```java
@Configuration
public class MybatisPlusConfig {
    
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        
        // åˆ›å»ºå¤šç§Ÿæˆ·æ‹¦æˆªå™¨
        TenantLineInnerInterceptor tenantInterceptor = 
            new TenantLineInnerInterceptor();
        
        // è®¾ç½®ç§Ÿæˆ·å¤„ç†å™¨
        tenantInterceptor.setTenantLineHandler(new TenantHandler());
        
        // æ·»åŠ åˆ°æ‹¦æˆªå™¨é“¾
        interceptor.addInnerInterceptor(tenantInterceptor);
        
        return interceptor;
    }
}
```

**ğŸ” ä»£ç ç†è§£**ï¼š
```
MybatisPlusInterceptorï¼šæ€»æ‹¦æˆªå™¨ï¼ˆå®¹å™¨ï¼‰
  â””â”€â”€ TenantLineInnerInterceptorï¼šå¤šç§Ÿæˆ·æ‹¦æˆªå™¨
       â””â”€â”€ TenantLineHandlerï¼šç§Ÿæˆ·å¤„ç†å™¨ï¼ˆå®šä¹‰è§„åˆ™ï¼‰

å°±åƒï¼š
æ€»æ‹¦æˆªå™¨ = å®‰ä¿éƒ¨é—¨
å¤šç§Ÿæˆ·æ‹¦æˆªå™¨ = ä¸“é—¨æ£€æŸ¥ç§Ÿæˆ·çš„ä¿å®‰
ç§Ÿæˆ·å¤„ç†å™¨ = ä¿å®‰çš„å·¥ä½œæ‰‹å†Œ
```

### 2.3 ç§Ÿæˆ·å¤„ç†å™¨å®ç°


```java
public class TenantHandler implements TenantLineHandler {
    
    /**
     * è·å–å½“å‰ç§Ÿæˆ·IDï¼ˆæœ€æ ¸å¿ƒçš„æ–¹æ³•ï¼‰
     */
    @Override
    public Expression getTenantId() {
        // ä»ä¸Šä¸‹æ–‡è·å–å½“å‰ç§Ÿæˆ·ID
        Long tenantId = TenantContext.getCurrentTenantId();
        
        // è¿”å›ç§Ÿæˆ·IDçš„SQLè¡¨è¾¾å¼
        return new LongValue(tenantId);
    }
    
    /**
     * æŒ‡å®šç§Ÿæˆ·å­—æ®µåç§°
     */
    @Override
    public String getTenantIdColumn() {
        return "tenant_id";  // æ•°æ®åº“ä¸­çš„ç§Ÿæˆ·å­—æ®µå
    }
    
    /**
     * å¿½ç•¥æŸäº›è¡¨ä¸è¿›è¡Œç§Ÿæˆ·è¿‡æ»¤
     */
    @Override
    public boolean ignoreTable(String tableName) {
        // ç³»ç»Ÿè¡¨ä¸éœ€è¦ç§Ÿæˆ·éš”ç¦»
        List<String> ignoreTables = Arrays.asList(
            "sys_user",      // ç³»ç»Ÿç”¨æˆ·è¡¨
            "sys_config",    // ç³»ç»Ÿé…ç½®è¡¨
            "sys_dict"       // æ•°æ®å­—å…¸è¡¨
        );
        return ignoreTables.contains(tableName);
    }
}
```

**ğŸ’­ ç†è§£è¿™ä¸‰ä¸ªæ–¹æ³•**ï¼š
```
getTenantId()ï¼š
é—®ï¼šå½“å‰æ˜¯å“ªä¸ªç§Ÿæˆ·åœ¨ç”¨ç³»ç»Ÿï¼Ÿ
ç­”ï¼šç§Ÿæˆ·100

getTenantIdColumn()ï¼š
é—®ï¼šæ•°æ®è¡¨ç”¨å“ªä¸ªå­—æ®µå­˜ç§Ÿæˆ·IDï¼Ÿ
ç­”ï¼štenant_idå­—æ®µ

ignoreTable()ï¼š
é—®ï¼šè¿™å¼ è¡¨éœ€è¦ç§Ÿæˆ·éš”ç¦»å—ï¼Ÿ
ç­”ï¼šç³»ç»Ÿè¡¨ä¸éœ€è¦ï¼Œä¸šåŠ¡è¡¨éœ€è¦
```

---

## 3. âš™ï¸ ç§Ÿæˆ·å­—æ®µé…ç½®è¯¦è§£


### 3.1 ç§Ÿæˆ·å­—æ®µçš„é€‰æ‹©


**ğŸ·ï¸ å­—æ®µå‘½åå»ºè®®**ï¼š

| å‘½åæ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|---------|------|------|-------|
| `tenant_id` | `æ¸…æ™°æ˜äº†ï¼Œè§åçŸ¥æ„` | `è¾ƒé•¿` | `â­â­â­â­â­` |
| `org_id` | `ç»„ç»‡IDï¼Œä¸šåŠ¡è¯­ä¹‰` | `å¯èƒ½æ··æ·†` | `â­â­â­â­` |
| `company_id` | `å…¬å¸IDï¼Œç›´è§‚` | `åœºæ™¯å—é™` | `â­â­â­` |
| `tid` | `ç®€çŸ­` | `ä¸ç›´è§‚` | `â­â­` |

**ğŸ”¸ å­—æ®µç±»å‹é€‰æ‹©**ï¼š
```sql
-- æ¨èï¼šBIGINT
tenant_id BIGINT NOT NULL COMMENT 'ç§Ÿæˆ·ID'

-- åŸå› ï¼š
âœ… æ”¯æŒå¤§é‡ç§Ÿæˆ·ï¼ˆæœ€å¤š2^63ä¸ªï¼‰
âœ… æ•°å­—ç±»å‹ï¼ŒæŸ¥è¯¢æ•ˆç‡é«˜
âœ… ä¸é›ªèŠ±IDç­‰åˆ†å¸ƒå¼IDå…¼å®¹

-- ä¸æ¨èï¼šVARCHAR
tenant_id VARCHAR(20)  âŒ
-- åŸå› ï¼š
â€¢ å­—ç¬¦ä¸²æ¯”è¾ƒæ…¢
â€¢ å ç”¨ç©ºé—´å¤§
â€¢ æ²¡æœ‰å¿…è¦
```

### 3.2 è¡¨ç»“æ„è®¾è®¡è§„èŒƒ


**ğŸ“‹ æ ‡å‡†è¡¨ç»“æ„æ¨¡æ¿**ï¼š

```sql
CREATE TABLE business_table (
    id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®',
    tenant_id BIGINT NOT NULL COMMENT 'ç§Ÿæˆ·ID',
    -- ä¸šåŠ¡å­—æ®µ
    name VARCHAR(100) COMMENT 'åç§°',
    status INT COMMENT 'çŠ¶æ€',
    -- å®¡è®¡å­—æ®µ
    create_time DATETIME COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME COMMENT 'æ›´æ–°æ—¶é—´',
    
    -- å…³é”®ç´¢å¼•
    INDEX idx_tenant (tenant_id),           -- ç§Ÿæˆ·ç´¢å¼•
    INDEX idx_tenant_name (tenant_id, name) -- å¤åˆç´¢å¼•
) COMMENT 'ä¸šåŠ¡è¡¨';
```

**âš¡ ç´¢å¼•è®¾è®¡è¦ç‚¹**ï¼š
```
ä¸ºä»€ä¹ˆè¦å»º tenant_id ç´¢å¼•ï¼Ÿ

æŸ¥è¯¢SQLï¼š
SELECT * FROM users 
WHERE tenant_id = 100 AND name = 'å¼ ä¸‰'

æ²¡æœ‰ç´¢å¼•ï¼š
å…¨è¡¨æ‰«æ â†’ æ…¢ ğŸŒ

æœ‰ tenant_id ç´¢å¼•ï¼š
å…ˆé€šè¿‡ç´¢å¼•å®šä½ç§Ÿæˆ·æ•°æ® â†’ å¿« ğŸš€

æœ€ä½³å®è·µï¼š
INDEX idx_tenant_ä¸šåŠ¡å­—æ®µ (tenant_id, å¸¸ç”¨æŸ¥è¯¢å­—æ®µ)
```

### 3.3 è‡ªåŠ¨å¡«å……é…ç½®


**ğŸ”§ å®ä½“ç±»é…ç½®**ï¼š

```java
@TableName("sys_user")
public class User {
    
    @TableId
    private Long id;
    
    /**
     * ç§Ÿæˆ·å­—æ®µï¼šæ’å…¥æ—¶è‡ªåŠ¨å¡«å……
     */
    @TableField(fill = FieldFill.INSERT)
    private Long tenantId;
    
    private String name;
    private String email;
}
```

**ğŸ”§ è‡ªåŠ¨å¡«å……å¤„ç†å™¨**ï¼š

```java
@Component
public class TenantMetaHandler implements MetaObjectHandler {
    
    /**
     * æ’å…¥æ—¶è‡ªåŠ¨å¡«å……ç§Ÿæˆ·ID
     */
    @Override
    public void insertFill(MetaObject metaObject) {
        // è·å–å½“å‰ç§Ÿæˆ·ID
        Long tenantId = TenantContext.getCurrentTenantId();
        
        // è‡ªåŠ¨è®¾ç½®
        this.strictInsertFill(metaObject, "tenantId", 
                             Long.class, tenantId);
    }
    
    @Override
    public void updateFill(MetaObject metaObject) {
        // æ›´æ–°æ—¶ä¸éœ€è¦å¡«å……ç§Ÿæˆ·ID
    }
}
```

**ğŸ’¡ ç†è§£è‡ªåŠ¨å¡«å……**ï¼š
```
æ²¡æœ‰è‡ªåŠ¨å¡«å……ï¼š
User user = new User();
user.setName("å¼ ä¸‰");
user.setTenantId(100);  // ğŸ˜° æ¯æ¬¡éƒ½è¦æ‰‹åŠ¨è®¾ç½®
userMapper.insert(user);

æœ‰è‡ªåŠ¨å¡«å……ï¼š
User user = new User();
user.setName("å¼ ä¸‰");
// tenantIdè‡ªåŠ¨å¡«å…… âœ¨
userMapper.insert(user);
```

---

## 4. ğŸ›¡ï¸ æ•°æ®éš”ç¦»æœºåˆ¶åŸç†


### 4.1 éš”ç¦»æœºåˆ¶å·¥ä½œæµç¨‹


**ğŸ“Š å®Œæ•´æ‰§è¡Œæµç¨‹**ï¼š

```
å¼€å‘è€…ä»£ç                 MyBatis-Pluså¤„ç†              æ•°æ®åº“æ‰§è¡Œ
   â”‚                          â”‚                          â”‚
   â”œâ”€ userMapper.            â”‚                          â”‚
   â”‚  selectList()           â”‚                          â”‚
   â”‚                         â”‚                          â”‚
   â†“                         â†“                          â”‚
åŸå§‹SQLï¼š                 æ‹¦æˆªå™¨ä»‹å…¥ï¼š                    â”‚
SELECT * FROM users      æ£€æŸ¥æ˜¯å¦éœ€è¦ç§Ÿæˆ·éš”ç¦»              â”‚
WHERE name='å¼ ä¸‰'          â†“                            â”‚
                         è·å–å½“å‰ç§Ÿæˆ·ID=100               â”‚
                           â†“                            â”‚
                         æ”¹å†™SQLï¼š                       â”‚
                         SELECT * FROM users            â”‚
                         WHERE name='å¼ ä¸‰'               â”‚
                         AND tenant_id=100 â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                                        â”‚
                                                        â†“
                                                   åªè¿”å›ç§Ÿæˆ·100çš„æ•°æ®
```

### 4.2 ä¸åŒSQLçš„å¤„ç†æ–¹å¼


**ğŸ”¸ æŸ¥è¯¢SQLå¤„ç†**ï¼š

```sql
-- ä½ å†™çš„SQL
SELECT * FROM orders WHERE status = 1

-- æ‹¦æˆªå™¨æ”¹æˆ
SELECT * FROM orders 
WHERE status = 1 AND tenant_id = 100

-- å…³è”æŸ¥è¯¢
SELECT o.*, u.name 
FROM orders o 
JOIN users u ON o.user_id = u.id

-- æ”¹æˆ
SELECT o.*, u.name 
FROM orders o 
JOIN users u ON o.user_id = u.id
WHERE o.tenant_id = 100 
  AND u.tenant_id = 100  -- æ¯ä¸ªè¡¨éƒ½åŠ 
```

**ğŸ”¸ æ’å…¥SQLå¤„ç†**ï¼š

```sql
-- ä½ å†™çš„SQL
INSERT INTO orders (order_no, amount) 
VALUES ('ORD001', 100)

-- æ‹¦æˆªå™¨æ”¹æˆ
INSERT INTO orders (order_no, amount, tenant_id) 
VALUES ('ORD001', 100, 100)
```

**ğŸ”¸ æ›´æ–°SQLå¤„ç†**ï¼š

```sql
-- ä½ å†™çš„SQL
UPDATE orders SET status = 2 
WHERE order_no = 'ORD001'

-- æ‹¦æˆªå™¨æ”¹æˆ
UPDATE orders SET status = 2 
WHERE order_no = 'ORD001' 
  AND tenant_id = 100  -- é˜²æ­¢è¯¯æ”¹å…¶ä»–ç§Ÿæˆ·æ•°æ®
```

**ğŸ”¸ åˆ é™¤SQLå¤„ç†**ï¼š

```sql
-- ä½ å†™çš„SQL
DELETE FROM orders WHERE order_no = 'ORD001'

-- æ‹¦æˆªå™¨æ”¹æˆ
DELETE FROM orders 
WHERE order_no = 'ORD001' 
  AND tenant_id = 100  -- é˜²æ­¢è¯¯åˆ å…¶ä»–ç§Ÿæˆ·æ•°æ®
```

### 4.3 éš”ç¦»è¾¹ç•Œä¸é™åˆ¶


**âš ï¸ æ‹¦æˆªå™¨çš„å±€é™æ€§**ï¼š

```java
// âœ… ä¼šè¢«æ‹¦æˆªå¤„ç†
userMapper.selectList(queryWrapper);
userMapper.selectById(id);

// âœ… ä¼šè¢«æ‹¦æˆªå¤„ç†  
userMapper.insert(user);
userMapper.updateById(user);

// âŒ ä¸ä¼šè¢«æ‹¦æˆª
@Select("SELECT * FROM users WHERE name = #{name}")
List<User> customSelect(String name);
// åŸå› ï¼šè‡ªå®šä¹‰SQLéœ€è¦æ‰‹åŠ¨åŠ ç§Ÿæˆ·æ¡ä»¶

// âŒ ä¸ä¼šè¢«æ‹¦æˆª
jdbcTemplate.query("SELECT * FROM users");
// åŸå› ï¼šç»•è¿‡äº†MyBatis
```

**ğŸ’¡ è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// æ–¹æ¡ˆ1ï¼šæ‰‹åŠ¨æ·»åŠ ç§Ÿæˆ·æ¡ä»¶
@Select("SELECT * FROM users " +
        "WHERE name = #{name} " +
        "AND tenant_id = #{tenantId}")  // æ‰‹åŠ¨åŠ ä¸Š
List<User> customSelect(@Param("name") String name,
                       @Param("tenantId") Long tenantId);

// æ–¹æ¡ˆ2ï¼šä½¿ç”¨MyBatis-Plusæä¾›çš„æ–¹æ³•
LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
wrapper.eq(User::getName, name);
// tenant_id è‡ªåŠ¨æ·»åŠ 
List<User> users = userMapper.selectList(wrapper);
```

---

## 5. ğŸ—ï¸ å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡


### 5.1 æ•´ä½“æ¶æ„å›¾


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å‰ç«¯åº”ç”¨ï¼ˆå¤šä¸ªç§Ÿæˆ·è®¿é—®ï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç½‘å…³å±‚                         â”‚
â”‚  â€¢ è¯†åˆ«ç§Ÿæˆ·ï¼ˆä»Tokenã€åŸŸåç­‰ï¼‰                     â”‚
â”‚  â€¢ è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åº”ç”¨æœåŠ¡å±‚                       â”‚
â”‚  â€¢ TenantContextï¼ˆå­˜å‚¨å½“å‰ç§Ÿæˆ·IDï¼‰                â”‚
â”‚  â€¢ ä¸šåŠ¡å¤„ç†ï¼ˆæ— éœ€å…³å¿ƒç§Ÿæˆ·ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MyBatis-Pluså±‚                      â”‚
â”‚  â€¢ TenantLineInnerInterceptor                   â”‚
â”‚  â€¢ SQLè‡ªåŠ¨æ”¹å†™                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®åº“                          â”‚
â”‚  â€¢ å…±äº«è¡¨ï¼Œé€šè¿‡tenant_idéš”ç¦»                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ç§Ÿæˆ·è¯†åˆ«ç­–ç•¥


**ğŸ” å¸¸è§è¯†åˆ«æ–¹å¼å¯¹æ¯”**ï¼š

| è¯†åˆ«æ–¹å¼ | å®ç°åŸç† | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|---------|------|------|---------|
| **åŸŸåè¯†åˆ«** | `a.comã€b.com` | `ç”¨æˆ·æ— æ„ŸçŸ¥` | `éœ€è¦å¤šåŸŸå` | `ç‹¬ç«‹å“ç‰Œç§Ÿæˆ·` |
| **URLè·¯å¾„** | `/tenant/100/api` | `ç®€å•ç›´è§‚` | `URLå˜é•¿` | `å†…éƒ¨ç³»ç»Ÿ` |
| **è¯·æ±‚å¤´** | `X-Tenant-Id: 100` | `çµæ´»` | `å‰ç«¯éœ€é…åˆ` | `APIç³»ç»Ÿ` |
| **Tokenæºå¸¦** | `JWTä¸­åŒ…å«ç§Ÿæˆ·ID` | `å®‰å…¨æ€§é«˜` | `éœ€è¦è§£æ` | `â­æ¨èæ–¹æ¡ˆ` |

**ğŸ”§ Tokenæºå¸¦ç§Ÿæˆ·IDå®ç°**ï¼š

```java
/**
 * JWTå·¥å…·ç±»
 */
public class JwtUtil {
    
    public static String createToken(Long userId, Long tenantId) {
        return JWT.create()
            .withClaim("userId", userId)
            .withClaim("tenantId", tenantId)  // ç§Ÿæˆ·ID
            .sign(Algorithm.HMAC256(SECRET));
    }
    
    public static Long getTenantId(String token) {
        DecodedJWT jwt = JWT.decode(token);
        return jwt.getClaim("tenantId").asLong();
    }
}

/**
 * æ‹¦æˆªå™¨ï¼šè®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
 */
@Component
public class TenantInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) {
        // 1. è·å–Token
        String token = request.getHeader("Authorization");
        
        // 2. è§£æç§Ÿæˆ·ID
        Long tenantId = JwtUtil.getTenantId(token);
        
        // 3. è®¾ç½®åˆ°ä¸Šä¸‹æ–‡
        TenantContext.setCurrentTenantId(tenantId);
        
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request,
                               HttpServletResponse response,
                               Object handler, Exception ex) {
        // è¯·æ±‚ç»“æŸï¼Œæ¸…ç†ä¸Šä¸‹æ–‡
        TenantContext.clear();
    }
}
```

### 5.3 åˆ†å±‚èŒè´£åˆ’åˆ†


**ğŸ“‹ å„å±‚èŒè´£æ¸…å•**ï¼š

```
ğŸŒ ç½‘å…³å±‚/è¿‡æ»¤å™¨ï¼š
âœ… è¯†åˆ«å½“å‰ç§Ÿæˆ·
âœ… éªŒè¯ç§Ÿæˆ·æƒé™
âœ… è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
âŒ ä¸å¤„ç†ä¸šåŠ¡é€»è¾‘

ğŸ’¼ Serviceå±‚ï¼š
âœ… ç¼–å†™ä¸šåŠ¡é€»è¾‘
âŒ ä¸å…³å¿ƒç§Ÿæˆ·éš”ç¦»
âŒ ä¸æ‰‹åŠ¨æ·»åŠ ç§Ÿæˆ·æ¡ä»¶

ğŸ—„ï¸ Mapperå±‚ï¼š
âœ… å®šä¹‰æ•°æ®è®¿é—®æ¥å£
âŒ ä¸æ‰‹åŠ¨æ·»åŠ ç§Ÿæˆ·æ¡ä»¶
âŒ MyBatis-Plusè‡ªåŠ¨å¤„ç†

ğŸ”Œ æ‹¦æˆªå™¨å±‚ï¼š
âœ… è‡ªåŠ¨æ”¹å†™SQL
âœ… æ·»åŠ ç§Ÿæˆ·æ¡ä»¶
âŒ ä¸ä¿®æ”¹ä¸šåŠ¡é€»è¾‘
```

---

## 6. ğŸ”§ SQLè‡ªåŠ¨æ‹¼æ¥æœºåˆ¶


### 6.1 æ‹¼æ¥åŸç†è¯¦è§£


**ğŸ” SQLè§£æä¸æ”¹å†™æµç¨‹**ï¼š

```
æ­¥éª¤1ï¼šåŸå§‹SQL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SELECT id, name, email 
FROM users 
WHERE status = 1

æ­¥éª¤2ï¼šMyBatis-Plusè§£æ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¯†åˆ«ï¼š
â€¢ è¡¨åï¼šusers
â€¢ æ¡ä»¶ï¼šstatus = 1
â€¢ æ“ä½œï¼šSELECT

æ­¥éª¤3ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦ç§Ÿæˆ·éš”ç¦»
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ usersè¡¨åœ¨ignoreTableåˆ—è¡¨ä¸­ï¼Ÿå¦
â€¢ å½“å‰æœ‰ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼Ÿæ˜¯ï¼ˆtenant_id=100ï¼‰
â€¢ ç»“è®ºï¼šéœ€è¦æ·»åŠ ç§Ÿæˆ·æ¡ä»¶

æ­¥éª¤4ï¼šæ”¹å†™SQL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SELECT id, name, email 
FROM users 
WHERE status = 1 
  AND tenant_id = 100  â† è‡ªåŠ¨æ·»åŠ 

æ­¥éª¤5ï¼šæ‰§è¡ŒSQL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å‘é€åˆ°æ•°æ®åº“æ‰§è¡Œ
```

### 6.2 å¤æ‚SQLçš„å¤„ç†


**ğŸ”¸ å­æŸ¥è¯¢å¤„ç†**ï¼š

```sql
-- åŸå§‹SQL
SELECT * FROM orders 
WHERE user_id IN (
    SELECT id FROM users WHERE city = 'åŒ—äº¬'
)

-- æ”¹å†™å
SELECT * FROM orders 
WHERE tenant_id = 100  -- å¤–å±‚åŠ 
  AND user_id IN (
      SELECT id FROM users 
      WHERE city = 'åŒ—äº¬' 
        AND tenant_id = 100  -- å­æŸ¥è¯¢ä¹ŸåŠ 
  )
```

**ğŸ”¸ è”åˆæŸ¥è¯¢å¤„ç†**ï¼š

```sql
-- åŸå§‹SQL
SELECT name FROM users WHERE age > 18
UNION
SELECT name FROM customers WHERE vip = 1

-- æ”¹å†™å
SELECT name FROM users 
WHERE age > 18 AND tenant_id = 100  -- ç¬¬ä¸€ä¸ªæŸ¥è¯¢åŠ 
UNION
SELECT name FROM customers 
WHERE vip = 1 AND tenant_id = 100   -- ç¬¬äºŒä¸ªæŸ¥è¯¢ä¹ŸåŠ 
```

**ğŸ”¸ èšåˆæŸ¥è¯¢å¤„ç†**ï¼š

```sql
-- åŸå§‹SQL
SELECT dept_id, COUNT(*) as cnt
FROM employees
GROUP BY dept_id

-- æ”¹å†™å
SELECT dept_id, COUNT(*) as cnt
FROM employees
WHERE tenant_id = 100  -- WHEREå­å¥åŠ ä¸Š
GROUP BY dept_id
```

### 6.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**âš¡ ç´¢å¼•ä¼˜åŒ–**ï¼š

```sql
-- âŒ ä¸å¥½çš„ç´¢å¼•
CREATE INDEX idx_name ON users(name);

-- å½“SQLæ˜¯ï¼š
SELECT * FROM users 
WHERE name = 'å¼ ä¸‰' AND tenant_id = 100

-- ç´¢å¼•æ— æ³•é«˜æ•ˆä½¿ç”¨ï¼

-- âœ… å¥½çš„ç´¢å¼•ï¼ˆå¤åˆç´¢å¼•ï¼Œç§Ÿæˆ·IDåœ¨å‰ï¼‰
CREATE INDEX idx_tenant_name ON users(tenant_id, name);

-- åŸå› ï¼š
â€¢ å…ˆé€šè¿‡tenant_idå¿«é€Ÿå®šä½ç§Ÿæˆ·æ•°æ®
â€¢ å†åœ¨ç§Ÿæˆ·æ•°æ®ä¸­æŸ¥æ‰¾name
â€¢ æ•ˆç‡æ›´é«˜
```

**ğŸ“Š ç´¢å¼•è®¾è®¡è§„èŒƒ**ï¼š

| åœºæ™¯ | ç´¢å¼•è®¾è®¡ | è¯´æ˜ |
|------|---------|------|
| **å•å­—æ®µæŸ¥è¯¢** | `(tenant_id, å­—æ®µ)` | `ç§Ÿæˆ·IDå¿…é¡»åœ¨å‰` |
| **å¤šå­—æ®µæŸ¥è¯¢** | `(tenant_id, å­—æ®µ1, å­—æ®µ2)` | `æŒ‰æŸ¥è¯¢é¢‘ç‡æ’åº` |
| **èŒƒå›´æŸ¥è¯¢** | `(tenant_id, èŒƒå›´å­—æ®µ)` | `èŒƒå›´å­—æ®µæ”¾æœ€å` |
| **æ’åºæŸ¥è¯¢** | `(tenant_id, æ’åºå­—æ®µ)` | `é¿å…filesort` |

---

## 7. ğŸ”„ ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†


### 7.1 ä¸Šä¸‹æ–‡å®ç°æ–¹å¼


**ğŸ“ ThreadLocalå®ç°**ï¼š

```java
/**
 * ç§Ÿæˆ·ä¸Šä¸‹æ–‡ - æ ¸å¿ƒç±»
 */
public class TenantContext {
    
    /**
     * ä½¿ç”¨ThreadLocalå­˜å‚¨ç§Ÿæˆ·ID
     * ä¸ºä»€ä¹ˆç”¨ThreadLocalï¼Ÿ
     * â€¢ çº¿ç¨‹éš”ç¦»ï¼šæ¯ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹ï¼Œäº’ä¸å¹²æ‰°
     * â€¢ å…¨å±€è®¿é—®ï¼šæ•´ä¸ªè¯·æ±‚é“¾è·¯éƒ½èƒ½è·å–
     */
    private static final ThreadLocal<Long> TENANT_ID = 
        new ThreadLocal<>();
    
    /**
     * è®¾ç½®å½“å‰ç§Ÿæˆ·ID
     */
    public static void setCurrentTenantId(Long tenantId) {
        TENANT_ID.set(tenantId);
    }
    
    /**
     * è·å–å½“å‰ç§Ÿæˆ·ID
     */
    public static Long getCurrentTenantId() {
        return TENANT_ID.get();
    }
    
    /**
     * æ¸…é™¤ç§Ÿæˆ·IDï¼ˆé‡è¦ï¼é˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
     */
    public static void clear() {
        TENANT_ID.remove();
    }
}
```

**ğŸ’¡ ThreadLocalåŸç†ç†è§£**ï¼š

```
çº¿ç¨‹1ï¼ˆå¤„ç†Aå…¬å¸è¯·æ±‚ï¼‰        çº¿ç¨‹2ï¼ˆå¤„ç†Bå…¬å¸è¯·æ±‚ï¼‰
     â”‚                              â”‚
     â”œâ”€ TenantContext.set(100)      â”œâ”€ TenantContext.set(200)
     â”‚  å­˜å‚¨ï¼štenant_id = 100        â”‚  å­˜å‚¨ï¼štenant_id = 200
     â”‚                              â”‚
     â”œâ”€ è°ƒç”¨Service                 â”œâ”€ è°ƒç”¨Service
     â”‚  get() = 100 âœ…               â”‚  get() = 200 âœ…
     â”‚                              â”‚
     â”œâ”€ è°ƒç”¨Mapper                  â”œâ”€ è°ƒç”¨Mapper  
     â”‚  get() = 100 âœ…               â”‚  get() = 200 âœ…
     â”‚                              â”‚
     â”œâ”€ SQLæ‰§è¡Œ                     â”œâ”€ SQLæ‰§è¡Œ
     â”‚  tenant_id=100 âœ…             â”‚  tenant_id=200 âœ…
     â”‚                              â”‚
     â””â”€ TenantContext.clear()       â””â”€ TenantContext.clear()

å…³é”®ç‚¹ï¼šä¸åŒçº¿ç¨‹çš„æ•°æ®å®Œå…¨éš”ç¦»ï¼
```

### 7.2 ç”Ÿå‘½å‘¨æœŸç®¡ç†


**ğŸ”„ å®Œæ•´ç”Ÿå‘½å‘¨æœŸ**ï¼š

```java
@Component
public class TenantFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, 
                        ServletResponse response, 
                        FilterChain chain) {
        try {
            // 1. è¯·æ±‚å¼€å§‹ - è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
            Long tenantId = extractTenantId(request);
            TenantContext.setCurrentTenantId(tenantId);
            
            // 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            chain.doFilter(request, response);
            
        } finally {
            // 3. è¯·æ±‚ç»“æŸ - å¿…é¡»æ¸…ç†ï¼
            TenantContext.clear();
            
            // ä¸ºä»€ä¹ˆå¿…é¡»æ¸…ç†ï¼Ÿ
            // â€¢ Tomcatä½¿ç”¨çº¿ç¨‹æ± 
            // â€¢ çº¿ç¨‹ä¼šè¢«å¤ç”¨
            // â€¢ ä¸æ¸…ç†ä¼šå¯¼è‡´ç§Ÿæˆ·IDæ··ä¹±
        }
    }
}
```

**âš ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³**ï¼š

```java
// âŒ é—®é¢˜1ï¼šå¿˜è®°æ¸…ç†
public void process() {
    TenantContext.set(100);
    // ... ä¸šåŠ¡å¤„ç†
    // å¿˜è®°clear()
}
// åæœï¼šä¸‹æ¬¡å¤ç”¨çº¿ç¨‹æ—¶ï¼Œç§Ÿæˆ·IDè¿˜æ˜¯100ï¼

// âœ… è§£å†³ï¼šä½¿ç”¨try-finally
public void process() {
    try {
        TenantContext.set(100);
        // ... ä¸šåŠ¡å¤„ç†
    } finally {
        TenantContext.clear();  // ç¡®ä¿æ¸…ç†
    }
}

// âŒ é—®é¢˜2ï¼šå¼‚æ­¥ä»»åŠ¡ä¸¢å¤±ç§Ÿæˆ·ä¸Šä¸‹æ–‡
@Async
public void asyncTask() {
    Long tenantId = TenantContext.get();  // null!
    // åŸå› ï¼šæ–°çº¿ç¨‹ï¼Œæ²¡æœ‰ç§Ÿæˆ·ä¸Šä¸‹æ–‡
}

// âœ… è§£å†³ï¼šä¼ é€’ç§Ÿæˆ·ID
public void asyncTask() {
    Long tenantId = TenantContext.get();  // ä¸»çº¿ç¨‹è·å–
    
    CompletableFuture.runAsync(() -> {
        TenantContext.set(tenantId);  // å­çº¿ç¨‹è®¾ç½®
        try {
            // ... å¼‚æ­¥ä¸šåŠ¡
        } finally {
            TenantContext.clear();
        }
    });
}
```

### 7.3 å¤šæ•°æ®æºåœºæ™¯å¤„ç†


**ğŸ”€ åŠ¨æ€æ•°æ®æº + å¤šç§Ÿæˆ·**ï¼š

```java
/**
 * æ”¯æŒå¤šæ•°æ®æºçš„ç§Ÿæˆ·ä¸Šä¸‹æ–‡
 */
public class TenantContext {
    
    // ç§Ÿæˆ·ID
    private static final ThreadLocal<Long> TENANT_ID = 
        new ThreadLocal<>();
    
    // æ•°æ®æºKeyï¼ˆå¯é€‰ï¼‰
    private static final ThreadLocal<String> DS_KEY = 
        new ThreadLocal<>();
    
    public static void setContext(Long tenantId, String dsKey) {
        TENANT_ID.set(tenantId);
        DS_KEY.set(dsKey);
    }
    
    public static String determineDataSource() {
        // æ ¹æ®ç§Ÿæˆ·IDå†³å®šæ•°æ®æº
        Long tenantId = TENANT_ID.get();
        
        if (tenantId >= 1 && tenantId <= 1000) {
            return "ds1";  // ç§Ÿæˆ·1-1000 ç”¨æ•°æ®æº1
        } else if (tenantId >= 1001 && tenantId <= 2000) {
            return "ds2";  // ç§Ÿæˆ·1001-2000 ç”¨æ•°æ®æº2
        }
        return "ds1";  // é»˜è®¤æ•°æ®æº
    }
}
```

---

## 8. ğŸš€ å®æˆ˜åº”ç”¨æŒ‡å—


### 8.1 å®Œæ•´å®æˆ˜ç¤ºä¾‹


**ğŸ“ é¡¹ç›®ç»“æ„**ï¼š

```
src/main/java/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ MybatisPlusConfig.java      # MyBatis-Plusé…ç½®
â”‚   â””â”€â”€ TenantConfig.java           # ç§Ÿæˆ·é…ç½®
â”œâ”€â”€ interceptor/
â”‚   â””â”€â”€ TenantInterceptor.java      # ç§Ÿæˆ·æ‹¦æˆªå™¨
â”œâ”€â”€ context/
â”‚   â””â”€â”€ TenantContext.java          # ç§Ÿæˆ·ä¸Šä¸‹æ–‡
â”œâ”€â”€ handler/
â”‚   â”œâ”€â”€ TenantHandler.java          # ç§Ÿæˆ·å¤„ç†å™¨
â”‚   â””â”€â”€ TenantMetaHandler.java      # å­—æ®µå¡«å……
â”œâ”€â”€ entity/
â”‚   â””â”€â”€ User.java                   # å®ä½“ç±»
â””â”€â”€ mapper/
    â””â”€â”€ UserMapper.java             # Mapper
```

**ğŸ”§ æ ¸å¿ƒé…ç½®ç±»**ï¼š

```java
@Configuration
public class MybatisPlusConfig {
    
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = 
            new MybatisPlusInterceptor();
        
        // å¤šç§Ÿæˆ·æ’ä»¶
        TenantLineInnerInterceptor tenantInterceptor = 
            new TenantLineInnerInterceptor();
        tenantInterceptor.setTenantLineHandler(tenantHandler());
        
        interceptor.addInnerInterceptor(tenantInterceptor);
        
        // åˆ†é¡µæ’ä»¶ï¼ˆå¯é€‰ï¼‰
        interceptor.addInnerInterceptor(
            new PaginationInnerInterceptor());
        
        return interceptor;
    }
    
    @Bean
    public TenantLineHandler tenantHandler() {
        return new TenantLineHandler() {
            @Override
            public Expression getTenantId() {
                Long tenantId = TenantContext.getCurrentTenantId();
                if (tenantId == null) {
                    throw new RuntimeException("ç§Ÿæˆ·IDä¸èƒ½ä¸ºç©º");
                }
                return new LongValue(tenantId);
            }
            
            @Override
            public String getTenantIdColumn() {
                return "tenant_id";
            }
            
            @Override
            public boolean ignoreTable(String tableName) {
                // ç³»ç»Ÿè¡¨ä¸éš”ç¦»
                return tableName.startsWith("sys_");
            }
        };
    }
}
```

### 8.2 ä¸šåŠ¡ä»£ç ç¤ºä¾‹


**ğŸ“ Serviceå±‚ï¼ˆæ— éœ€å…³å¿ƒç§Ÿæˆ·ï¼‰**ï¼š

```java
@Service
public class UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    /**
     * æŸ¥è¯¢ç”¨æˆ· - è‡ªåŠ¨éš”ç¦»
     */
    public List<User> queryUsers(String name) {
        LambdaQueryWrapper<User> wrapper = 
            new LambdaQueryWrapper<>();
        wrapper.like(User::getName, name);
        
        // ä¸éœ€è¦æ‰‹åŠ¨åŠ  tenant_id æ¡ä»¶
        // MyBatis-Plusè‡ªåŠ¨æ·»åŠ 
        return userMapper.selectList(wrapper);
    }
    
    /**
     * åˆ›å»ºç”¨æˆ· - è‡ªåŠ¨å¡«å……
     */
    public void createUser(User user) {
        // tenant_id è‡ªåŠ¨å¡«å……
        userMapper.insert(user);
    }
    
    /**
     * æ›´æ–°ç”¨æˆ· - è‡ªåŠ¨éš”ç¦»
     */
    public void updateUser(User user) {
        // è‡ªåŠ¨æ·»åŠ  tenant_id æ¡ä»¶ï¼Œé˜²æ­¢è¯¯æ”¹
        userMapper.updateById(user);
    }
}
```

**ğŸ“ Controllerå±‚ï¼ˆè®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼‰**ï¼š

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    /**
     * æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping
    public List<User> list(@RequestParam String name) {
        // ç§Ÿæˆ·IDå·²åœ¨æ‹¦æˆªå™¨ä¸­è®¾ç½®
        // ä¸šåŠ¡ä»£ç æ— éœ€å…³å¿ƒ
        return userService.queryUsers(name);
    }
    
    /**
     * åˆ›å»ºç”¨æˆ·
     */
    @PostMapping
    public void create(@RequestBody User user) {
        // ç§Ÿæˆ·IDè‡ªåŠ¨å¡«å……
        userService.createUser(user);
    }
}
```

### 8.3 æµ‹è¯•ä¸éªŒè¯


**ğŸ§ª å•å…ƒæµ‹è¯•**ï¼š

```java
@SpringBootTest
public class TenantTest {
    
    @Autowired
    private UserMapper userMapper;
    
    @Test
    public void testTenantIsolation() {
        // æ¨¡æ‹Ÿç§Ÿæˆ·100
        TenantContext.setCurrentTenantId(100L);
        
        try {
            // æ’å…¥æ•°æ®
            User user = new User();
            user.setName("å¼ ä¸‰");
            userMapper.insert(user);
            
            // éªŒè¯ï¼štenant_idè‡ªåŠ¨å¡«å……
            User saved = userMapper.selectById(user.getId());
            assertEquals(100L, saved.getTenantId());
            
            // éªŒè¯ï¼šæŸ¥è¯¢è‡ªåŠ¨éš”ç¦»
            List<User> users = userMapper.selectList(null);
            assertTrue(users.stream()
                .allMatch(u -> u.getTenantId().equals(100L)));
            
        } finally {
            TenantContext.clear();
        }
    }
    
    @Test
    public void testDifferentTenant() {
        // ç§Ÿæˆ·100æ’å…¥æ•°æ®
        TenantContext.setCurrentTenantId(100L);
        User user1 = new User();
        user1.setName("å¼ ä¸‰");
        userMapper.insert(user1);
        TenantContext.clear();
        
        // ç§Ÿæˆ·200æŸ¥è¯¢
        TenantContext.setCurrentTenantId(200L);
        User user = userMapper.selectById(user1.getId());
        // åº”è¯¥æŸ¥ä¸åˆ°ï¼ˆä¸åŒç§Ÿæˆ·ï¼‰
        assertNull(user);
        TenantContext.clear();
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¤šç§Ÿæˆ·ï¼šä¸€å¥—ç³»ç»ŸæœåŠ¡å¤šä¸ªå®¢æˆ·ï¼Œæ•°æ®éš”ç¦»
ğŸ”¸ TenantLineInnerInterceptorï¼šè‡ªåŠ¨æ”¹å†™SQLçš„æ‹¦æˆªå™¨
ğŸ”¸ ç§Ÿæˆ·å­—æ®µï¼šé€šå¸¸ç”¨tenant_idï¼Œå»ºè®®BIGINTç±»å‹
ğŸ”¸ æ•°æ®éš”ç¦»ï¼šé€šè¿‡åœ¨SQLä¸­è‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·æ¡ä»¶å®ç°
ğŸ”¸ ç§Ÿæˆ·ä¸Šä¸‹æ–‡ï¼šç”¨ThreadLocalå­˜å‚¨å½“å‰ç§Ÿæˆ·ID
ğŸ”¸ SQLæ‹¼æ¥ï¼šæ‰€æœ‰SQLè‡ªåŠ¨åŠ ä¸Š AND tenant_id = ?
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¤šç§Ÿæˆ·çš„æœ¬è´¨**ï¼š
```
ä¸æ˜¯æŠ€æœ¯å¤æ‚ï¼Œè€Œæ˜¯æ€ç»´è½¬å˜ï¼š
â€¢ ä»"ä¸€ä¸ªå®¢æˆ·ä¸€å¥—ç³»ç»Ÿ"
â€¢ åˆ°"ä¸€å¥—ç³»ç»ŸæœåŠ¡æ‰€æœ‰å®¢æˆ·"

æŠ€æœ¯å®ç°å¾ˆç®€å•ï¼š
1. è¡¨åŠ tenant_idå­—æ®µ
2. é…ç½®æ‹¦æˆªå™¨
3. SQLè‡ªåŠ¨æ”¹å†™
```

**ğŸ”¹ æ‹¦æˆªå™¨çš„å·¥ä½œåŸç†**ï¼š
```
å°±åƒä¸€ä¸ª"ç¿»è¯‘å®˜"ï¼š

ä½ è¯´ï¼šæŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
æ‹¦æˆªå™¨ç¿»è¯‘ï¼šæŸ¥è¯¢å½“å‰ç§Ÿæˆ·çš„æ‰€æœ‰ç”¨æˆ·

ä½ è¯´ï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯  
æ‹¦æˆªå™¨ç¿»è¯‘ï¼šæ›´æ–°å½“å‰ç§Ÿæˆ·çš„ç”¨æˆ·ä¿¡æ¯

ä½ è¯´ï¼šåˆ é™¤è®¢å•
æ‹¦æˆªå™¨ç¿»è¯‘ï¼šåˆ é™¤å½“å‰ç§Ÿæˆ·çš„è®¢å•
```

**ğŸ”¹ ç§Ÿæˆ·ä¸Šä¸‹æ–‡çš„é‡è¦æ€§**ï¼š
```
ä¸Šä¸‹æ–‡ = ä¸€ä¸ªå…¨å±€å˜é‡

ä½œç”¨ï¼š
â€¢ å­˜å‚¨å½“å‰æ˜¯å“ªä¸ªç§Ÿæˆ·åœ¨æ“ä½œ
â€¢ è´¯ç©¿æ•´ä¸ªè¯·æ±‚é“¾è·¯
â€¢ è®©æ‰€æœ‰å±‚éƒ½çŸ¥é“ç§Ÿæˆ·ID

ç”Ÿå‘½å‘¨æœŸï¼š
è¯·æ±‚è¿›æ¥ â†’ è®¾ç½®ç§Ÿæˆ·ID â†’ ä¸šåŠ¡å¤„ç† â†’ æ¸…ç†ç§Ÿæˆ·ID â†’ å“åº”è¿”å›
```

### 9.3 æœ€ä½³å®è·µå»ºè®®


**âœ… æ¨èåšæ³•**ï¼š

```
1. ç´¢å¼•è®¾è®¡ï¼š
   â€¢ æ‰€æœ‰ä¸šåŠ¡è¡¨å»ºç«‹ (tenant_id, ...) å¤åˆç´¢å¼•
   â€¢ tenant_idå¿…é¡»åœ¨ç´¢å¼•ç¬¬ä¸€ä½

2. å­—æ®µè®¾è®¡ï¼š
   â€¢ ä½¿ç”¨tenant_idå‘½åï¼Œæ¸…æ™°æ˜äº†
   â€¢ ç±»å‹é€‰BIGINTï¼ŒNOT NULL
   â€¢ æ·»åŠ æ³¨é‡Šè¯´æ˜

3. æ‹¦æˆªå™¨é…ç½®ï¼š
   â€¢ æ˜ç¡®å“ªäº›è¡¨éœ€è¦éš”ç¦»
   â€¢ ç³»ç»Ÿè¡¨é€šå¸¸ä¸éœ€è¦éš”ç¦»
   â€¢ é…ç½®å¥½ignoreTable

4. ä¸Šä¸‹æ–‡ç®¡ç†ï¼š
   â€¢ åœ¨Filter/Interceptorä¸­è®¾ç½®
   â€¢ ä½¿ç”¨try-finallyç¡®ä¿æ¸…ç†
   â€¢ å¼‚æ­¥åœºæ™¯æ³¨æ„ä¼ é€’

5. å¼‚å¸¸å¤„ç†ï¼š
   â€¢ ç§Ÿæˆ·IDä¸ºç©ºæ—¶æ˜ç¡®æç¤º
   â€¢ è®°å½•æ—¥å¿—ä¾¿äºæ’æŸ¥
   â€¢ å‹å¥½çš„é”™è¯¯ä¿¡æ¯
```

**âŒ é¿å…çš„é”™è¯¯**ï¼š

```
1. å¿˜è®°æ¸…ç†ä¸Šä¸‹æ–‡ï¼š
   â€¢ å¯¼è‡´ç§Ÿæˆ·IDä¸²ä¹±
   â€¢ ä½¿ç”¨try-finally

2. è‡ªå®šä¹‰SQLä¸åŠ ç§Ÿæˆ·æ¡ä»¶ï¼š
   â€¢ @Selectéœ€è¦æ‰‹åŠ¨åŠ 
   â€¢ æˆ–æ”¹ç”¨MyBatis-Plusæ–¹æ³•

3. ç´¢å¼•è®¾è®¡ä¸åˆç†ï¼š
   â€¢ ä¸æŠŠtenant_idæ”¾åœ¨å‰é¢
   â€¢ å¯¼è‡´å…¨è¡¨æ‰«æ

4. å¼‚æ­¥ä»»åŠ¡ä¸¢å¤±ä¸Šä¸‹æ–‡ï¼š
   â€¢ æ–°çº¿ç¨‹è¦é‡æ–°è®¾ç½®
   â€¢ ä¼ é€’ç§Ÿæˆ·IDå‚æ•°

5. è¿‡åº¦ä¾èµ–æ‹¦æˆªå™¨ï¼š
   â€¢ æ ¸å¿ƒæƒé™æ£€æŸ¥ä¸èƒ½åªé æ‹¦æˆªå™¨
   â€¢ é‡è¦æ“ä½œè¦äºŒæ¬¡éªŒè¯
```

### 9.4 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡ä»·å€¼**ï¼š
- **æˆæœ¬é™ä½**ï¼šä¸€å¥—ç³»ç»ŸæœåŠ¡æ‰€æœ‰å®¢æˆ·ï¼ŒèŠ‚çœ60%ä»¥ä¸Šæˆæœ¬
- **éƒ¨ç½²ç®€å•**ï¼šç»Ÿä¸€éƒ¨ç½²å‡çº§ï¼Œæ— éœ€é€ä¸ªå®¢æˆ·æ“ä½œ
- **æ‰©å±•æ–¹ä¾¿**ï¼šæ–°å¢ç§Ÿæˆ·åªéœ€é…ç½®ï¼Œæ— éœ€éƒ¨ç½²æ–°ç³»ç»Ÿ

**ğŸ”§ æŠ€æœ¯ä»·å€¼**ï¼š
- **å¼€å‘æ•ˆç‡**ï¼šä¸šåŠ¡ä»£ç ä¸å…³å¿ƒç§Ÿæˆ·ï¼Œå¼€å‘æ›´ä¸“æ³¨
- **æ•°æ®å®‰å…¨**ï¼šè‡ªåŠ¨éš”ç¦»ï¼Œå‡å°‘è¯¯æ“ä½œé£é™©
- **ç»´æŠ¤ç®€å•**ï¼šç»Ÿä¸€çš„æ¶æ„ï¼Œé™ä½ç»´æŠ¤æˆæœ¬

**ğŸ“š å­¦ä¹ ä»·å€¼**ï¼š
- ç†è§£SaaSæ¶æ„è®¾è®¡æ€æƒ³
- æŒæ¡MyBatis-Plusé«˜çº§ç‰¹æ€§
- å­¦ä¹ æ‹¦æˆªå™¨å’Œä¸Šä¸‹æ–‡ç®¡ç†æ¨¡å¼

---

**ğŸ¯ æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
å¤šç§Ÿæˆ·ç³»ç»Ÿçœæˆæœ¬ï¼Œä¸€å¥—æœåŠ¡åƒä¸‡å®¶
ç§Ÿæˆ·å­—æ®µtenant_idï¼Œç´¢å¼•è®¾è®¡è¦åœ¨å‰
æ‹¦æˆªå™¨æ¥æ”¹SQLï¼Œä¸Šä¸‹æ–‡ç®¡ç†è«å¿˜è®°
ThreadLocalå­˜ç§Ÿæˆ·ï¼Œæ¸…ç†åŠ¨ä½œè¦åŠæ—¶
ä¸šåŠ¡ä»£ç å¾ˆç®€æ´ï¼Œéš”ç¦»è‡ªåŠ¨ä¸ç”¨æ„
```

**ğŸŒŸ ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®**ï¼š
1. åŠ¨æ‰‹å®è·µï¼šæ­å»ºå¤šç§Ÿæˆ·Demoé¡¹ç›®
2. æ€§èƒ½ä¼˜åŒ–ï¼šå­¦ä¹ ç´¢å¼•å’ŒSQLä¼˜åŒ–
3. å®‰å…¨åŠ å›ºï¼šç ”ç©¶ç§Ÿæˆ·æƒé™æ§åˆ¶
4. æ¶æ„å‡çº§ï¼šäº†è§£ç‹¬ç«‹æ•°æ®åº“æ–¹æ¡ˆ