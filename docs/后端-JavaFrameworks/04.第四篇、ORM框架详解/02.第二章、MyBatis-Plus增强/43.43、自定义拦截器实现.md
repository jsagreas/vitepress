---
title: 43ã€è‡ªå®šä¹‰æ‹¦æˆªå™¨å®ç°
---
## ğŸ“š ç›®å½•

1. [æ‹¦æˆªå™¨åŸºæœ¬æ¦‚å¿µ](#1-æ‹¦æˆªå™¨åŸºæœ¬æ¦‚å¿µ)
2. [beforeQueryæŸ¥è¯¢å‰æ‹¦æˆª](#2-beforeQueryæŸ¥è¯¢å‰æ‹¦æˆª)
3. [beforeUpdateæ›´æ–°å‰æ‹¦æˆª](#3-beforeUpdateæ›´æ–°å‰æ‹¦æˆª)
4. [SQLè§£æå¤„ç†](#4-SQLè§£æå¤„ç†)
5. [å‚æ•°ä¿®æ”¹æœºåˆ¶](#5-å‚æ•°ä¿®æ”¹æœºåˆ¶)
6. [ç»“æœå¤„ç†é€»è¾‘](#6-ç»“æœå¤„ç†é€»è¾‘)
7. [æ‹¦æˆªå™¨æ³¨å†Œé…ç½®](#7-æ‹¦æˆªå™¨æ³¨å†Œé…ç½®)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ‹¦æˆªå™¨åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨


> **ğŸ’¡ æ ¸å¿ƒç†è§£**
> æ‹¦æˆªå™¨å°±åƒæ˜¯å®‰æ£€é—¨ï¼Œæ‰€æœ‰çš„SQLæ“ä½œéƒ½è¦ç»è¿‡å®ƒçš„"æ£€æŸ¥"ï¼Œä½ å¯ä»¥åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­åšä¸€äº›é¢å¤–çš„äº‹æƒ…ï¼Œæ¯”å¦‚è®°å½•æ—¥å¿—ã€ä¿®æ”¹å‚æ•°ã€æ£€æŸ¥æƒé™ç­‰ã€‚

**ç”Ÿæ´»ä¸­çš„ç±»æ¯”**ï¼š
```
å°±åƒä½ å»é“¶è¡ŒåŠä¸šåŠ¡ï¼š
çª—å£å·¥ä½œäººå‘˜ï¼ˆMyBatisï¼‰æ‰§è¡Œä¸šåŠ¡å‰
    â†“
ä¿å®‰ï¼ˆæ‹¦æˆªå™¨ï¼‰å…ˆæ£€æŸ¥ä½ çš„è¯ä»¶
    â†“
â€¢ è®°å½•ä½ æ¥åŠä»€ä¹ˆä¸šåŠ¡ï¼ˆæ—¥å¿—ï¼‰
â€¢ æ£€æŸ¥ä½ æœ‰æ²¡æœ‰æƒé™ï¼ˆæƒé™æ§åˆ¶ï¼‰  
â€¢ ä¿®æ”¹ä½ çš„ç”³è¯·å†…å®¹ï¼ˆå‚æ•°ä¿®æ”¹ï¼‰
    â†“
ç„¶åæ‰æ”¾è¡Œè®©çª—å£å¤„ç†
```

**æŠ€æœ¯å±‚é¢çš„ç†è§£**ï¼š
```
æ‹¦æˆªå™¨å·¥ä½œæµç¨‹ï¼š
ç”¨æˆ·å‘èµ·æ•°æ®åº“æ“ä½œ
    â†“
æ‹¦æˆªå™¨æ‹¦æˆªSQLæ‰§è¡Œ
    â†“
æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ï¼ˆbeforeï¼‰
    â†“
æ”¾è¡Œè®©MyBatisæ‰§è¡ŒSQL
    â†“
æ‹¦æˆªè¿”å›ç»“æœï¼ˆafterï¼‰
    â†“
è¿”å›ç»™ç”¨æˆ·
```

### 1.2 æ‹¦æˆªå™¨çš„ä½œç”¨åœºæ™¯


| åœºæ™¯ ğŸ¯ | è¯´æ˜ ğŸ“ | å®é™…ç”¨é€” ğŸ’¼ |
|---------|---------|-------------|
| **æ—¥å¿—è®°å½•** | è®°å½•è°åœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œäº†ä»€ä¹ˆSQL | å®¡è®¡è¿½è¸ªã€é—®é¢˜æ’æŸ¥ |
| **æƒé™æ§åˆ¶** | æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®æŸäº›æ•°æ® | æ•°æ®æƒé™éš”ç¦» |
| **SQLä¼˜åŒ–** | è‡ªåŠ¨æ·»åŠ ç´¢å¼•æç¤ºã€åˆ†é¡µä¼˜åŒ– | æ€§èƒ½æå‡ |
| **æ•°æ®è„±æ•** | æŸ¥è¯¢ç»“æœä¸­çš„æ•æ„Ÿä¿¡æ¯è‡ªåŠ¨æ‰“ç  | éšç§ä¿æŠ¤ |
| **å¤šç§Ÿæˆ·éš”ç¦»** | è‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·IDè¿‡æ»¤æ¡ä»¶ | SaaSç³»ç»Ÿ |
| **å‚æ•°æ ¡éªŒ** | é˜²æ­¢SQLæ³¨å…¥ã€å‚æ•°åˆæ³•æ€§æ£€æŸ¥ | å®‰å…¨é˜²æŠ¤ |

### 1.3 MyBatis-Plusæ‹¦æˆªå™¨ä½“ç³»


**æ‹¦æˆªå™¨ç»§æ‰¿å…³ç³»**ï¼š
```
MyBatisåŸç”Ÿæ‹¦æˆªå™¨ Interceptor
         â†“
MyBatis-Pluså¢å¼ºæ‹¦æˆªå™¨ InnerInterceptor
         â†“
å…·ä½“æ‹¦æˆªå™¨å®ç°
â”œâ”€â”€ PaginationInnerInterceptor     (åˆ†é¡µæ‹¦æˆªå™¨)
â”œâ”€â”€ TenantLineInnerInterceptor     (å¤šç§Ÿæˆ·æ‹¦æˆªå™¨)
â”œâ”€â”€ OptimisticLockerInnerInterceptor (ä¹è§‚é”æ‹¦æˆªå™¨)
â””â”€â”€ è‡ªå®šä¹‰æ‹¦æˆªå™¨                    (ä½ çš„å®ç°)
```

> **âš ï¸ é‡è¦æç¤º**
> MyBatis-Plusä½¿ç”¨çš„æ˜¯`InnerInterceptor`æ¥å£ï¼Œä¸æ˜¯MyBatisåŸç”Ÿçš„`Interceptor`ï¼è¿™æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¥å£ï¼Œåˆ«ææ··äº†ã€‚

---

## 2. ğŸ” beforeQueryæŸ¥è¯¢å‰æ‹¦æˆª


### 2.1 æŸ¥è¯¢æ‹¦æˆªçš„æ—¶æœº


**æ‹¦æˆªæ—¶æœºå›¾ç¤º**ï¼š
```
ç”¨æˆ·ä»£ç è°ƒç”¨
userMapper.selectList(...)
         â†“
è¿›å…¥MyBatis-Plus
         â†“
ğŸ”” beforeQueryæ‹¦æˆªç‚¹ â† åœ¨è¿™é‡Œæ‹¦æˆªï¼
         â†“
SQLè§£æå’Œå‚æ•°ç»‘å®š
         â†“
æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
         â†“
è¿”å›ç»“æœ
```

### 2.2 å®ç°æŸ¥è¯¢æ‹¦æˆªå™¨


**åŸºç¡€å®ç°ä»£ç **ï¼š
```java
public class QueryLogInterceptor implements InnerInterceptor {
    
    /**
     * æŸ¥è¯¢å‰æ‹¦æˆª
     * @param executor æ‰§è¡Œå™¨
     * @param ms MappedStatement (åŒ…å«SQLä¿¡æ¯)
     * @param parameter æŸ¥è¯¢å‚æ•°
     * @param rowBounds åˆ†é¡µä¿¡æ¯
     * @param resultHandler ç»“æœå¤„ç†å™¨
     * @param boundSql ç»‘å®šçš„SQL
     */
    @Override
    public void beforeQuery(Executor executor, 
                           MappedStatement ms, 
                           Object parameter,
                           RowBounds rowBounds, 
                           ResultHandler resultHandler, 
                           BoundSql boundSql) {
        
        // è·å–åŸå§‹SQL
        String sql = boundSql.getSql();
        
        // è®°å½•æŸ¥è¯¢æ—¥å¿—
        log.info("æ‰§è¡ŒæŸ¥è¯¢SQL: {}", sql);
        log.info("æŸ¥è¯¢å‚æ•°: {}", parameter);
    }
}
```

> **ğŸ§  ä»£ç è§£è¯»**
> - `MappedStatement`ï¼šåŒ…å«äº†SQLè¯­å¥çš„æ‰€æœ‰ä¿¡æ¯
> - `BoundSql`ï¼šç»‘å®šäº†å‚æ•°çš„SQLï¼Œæ˜¯æœ€æ¥è¿‘æ‰§è¡Œçš„SQL
> - `parameter`ï¼šç”¨æˆ·ä¼ å…¥çš„æŸ¥è¯¢å‚æ•°

### 2.3 å®æˆ˜æ¡ˆä¾‹ï¼šæ·»åŠ æŸ¥è¯¢æƒé™æ§åˆ¶


**åœºæ™¯è¯´æ˜**ï¼šæŸä¸ªå…¬å¸çš„å‘˜å·¥åªèƒ½æŸ¥è¯¢è‡ªå·±éƒ¨é—¨çš„æ•°æ®

```java
public class DeptDataInterceptor implements InnerInterceptor {
    
    @Override
    public void beforeQuery(Executor executor, 
                           MappedStatement ms, 
                           Object parameter,
                           RowBounds rowBounds, 
                           ResultHandler resultHandler, 
                           BoundSql boundSql) {
        
        // 1. è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„éƒ¨é—¨ID
        Long currentDeptId = SecurityUtils.getCurrentDeptId();
        
        // 2. åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªï¼ˆæŸäº›æŸ¥è¯¢ä¸éœ€è¦éƒ¨é—¨è¿‡æ»¤ï¼‰
        if (shouldIntercept(ms.getId())) {
            
            // 3. ä¿®æ”¹SQLï¼Œæ·»åŠ éƒ¨é—¨è¿‡æ»¤æ¡ä»¶
            String originalSql = boundSql.getSql();
            String newSql = addDeptCondition(originalSql, currentDeptId);
            
            // 4. æ›¿æ¢SQLï¼ˆé€šè¿‡åå°„ä¿®æ”¹ï¼‰
            ReflectionUtils.setFieldValue(boundSql, "sql", newSql);
        }
    }
    
    // åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆª
    private boolean shouldIntercept(String mapperId) {
        // æ’é™¤è¶…çº§ç®¡ç†å‘˜ã€ç³»ç»ŸæŸ¥è¯¢ç­‰
        return !mapperId.contains("Admin") 
            && !mapperId.contains("System");
    }
}
```

**æ‹¦æˆªæ•ˆæœå¯¹æ¯”**ï¼š
```
åŸå§‹SQLï¼š
SELECT * FROM t_employee WHERE status = 1

æ‹¦æˆªåçš„SQLï¼š
SELECT * FROM t_employee 
WHERE status = 1 AND dept_id = 100  â† è‡ªåŠ¨æ·»åŠ 
```

---

## 3. âœï¸ beforeUpdateæ›´æ–°å‰æ‹¦æˆª


### 3.1 æ›´æ–°æ‹¦æˆªçš„ä½œç”¨


> **ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦æ›´æ–°æ‹¦æˆªï¼Ÿ**
> 
> æ›´æ–°æ“ä½œæ¯”æŸ¥è¯¢æ›´"å±é™©"ï¼Œä¸€æ—¦æ‰§è¡Œé”™è¯¯å¯èƒ½å¯¼è‡´æ•°æ®æŸåã€‚é€šè¿‡æ‹¦æˆªå¯ä»¥ï¼š
> - è‡ªåŠ¨å¡«å……æ›´æ–°æ—¶é—´ã€æ›´æ–°äºº
> - é˜²æ­¢è¯¯åˆ å…¨è¡¨æ•°æ®
> - æ·»åŠ ä¹è§‚é”ç‰ˆæœ¬å·
> - è®°å½•æ“ä½œå®¡è®¡æ—¥å¿—

### 3.2 å®ç°æ›´æ–°æ‹¦æˆªå™¨


**åŸºç¡€å®ç°**ï¼š
```java
public class UpdateInterceptor implements InnerInterceptor {
    
    @Override
    public void beforeUpdate(Executor executor, 
                            MappedStatement ms, 
                            Object parameter) {
        
        // 1. è·å–SQLç±»å‹
        SqlCommandType sqlType = ms.getSqlCommandType();
        
        // 2. æ ¹æ®ç±»å‹åšä¸åŒå¤„ç†
        if (sqlType == SqlCommandType.UPDATE) {
            handleUpdate(parameter);
        } else if (sqlType == SqlCommandType.DELETE) {
            handleDelete(parameter);
        }
    }
    
    private void handleUpdate(Object parameter) {
        // è‡ªåŠ¨å¡«å……æ›´æ–°ä¿¡æ¯
        if (parameter instanceof Map) {
            Map<String, Object> map = (Map<String, Object>) parameter;
            map.put("updateTime", LocalDateTime.now());
            map.put("updateBy", SecurityUtils.getCurrentUserId());
        }
    }
}
```

### 3.3 å®æˆ˜æ¡ˆä¾‹ï¼šé˜²æ­¢å…¨è¡¨åˆ é™¤


**å±é™©æ“ä½œç¤ºä¾‹**ï¼š
```java
// å±é™©ï¼æ²¡æœ‰whereæ¡ä»¶ä¼šåˆ é™¤å…¨è¡¨
userMapper.delete(null);  // ğŸ˜± å…¨è¡¨æ•°æ®éƒ½æ²¡äº†ï¼
```

**å®‰å…¨æ‹¦æˆªå®ç°**ï¼š
```java
public class SafeDeleteInterceptor implements InnerInterceptor {
    
    @Override
    public void beforeUpdate(Executor executor, 
                            MappedStatement ms, 
                            Object parameter) {
        
        if (ms.getSqlCommandType() == SqlCommandType.DELETE) {
            
            // è·å–SQL
            BoundSql boundSql = ms.getBoundSql(parameter);
            String sql = boundSql.getSql().toLowerCase();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰whereæ¡ä»¶
            if (!sql.contains("where")) {
                throw new RuntimeException(
                    "ğŸš« ç¦æ­¢æ‰§è¡Œæ— æ¡ä»¶çš„DELETEæ“ä½œï¼SQL: " + sql
                );
            }
        }
    }
}
```

**é˜²æŠ¤æ•ˆæœ**ï¼š
```
æ‰§è¡Œï¼šuserMapper.delete(null)
     â†“
æ‹¦æˆªå™¨æ£€æµ‹åˆ°æ²¡æœ‰whereæ¡ä»¶
     â†“
æŠ›å‡ºå¼‚å¸¸é˜»æ­¢æ‰§è¡Œ
     â†“
ğŸ’¾ æ•°æ®å®‰å…¨ï¼Œé¿å…è¯¯åˆ 
```

---

## 4. ğŸ”§ SQLè§£æå¤„ç†


### 4.1 SQLè§£æçš„å¿…è¦æ€§


**ä¸ºä»€ä¹ˆè¦è§£æSQLï¼Ÿ**
```
åŸå§‹SQLï¼ˆå­—ç¬¦ä¸²ï¼‰
    â†“
è§£ææˆç»“æ„åŒ–å¯¹è±¡
    â†“
å¯ä»¥ç²¾ç¡®æ“ä½œSQLçš„æ¯ä¸ªéƒ¨åˆ†
â”œâ”€â”€ SELECTå­—æ®µ
â”œâ”€â”€ FROMè¡¨å  
â”œâ”€â”€ WHEREæ¡ä»¶
â”œâ”€â”€ ORDER BYæ’åº
â””â”€â”€ LIMITåˆ†é¡µ
```

### 4.2 ä½¿ç”¨JSqlParserè§£æSQL


**å¼•å…¥ä¾èµ–**ï¼š
```xml
<dependency>
    <groupId>com.github.jsqlparser</groupId>
    <artifactId>jsqlparser</artifactId>
    <version>4.5</version>
</dependency>
```

**è§£æSQLç¤ºä¾‹**ï¼š
```java
public class SqlParserExample {
    
    public void parseSql(String sql) throws JSQLParserException {
        
        // 1. è§£æSQL
        Statement statement = CCJSqlParserUtil.parse(sql);
        
        // 2. åˆ¤æ–­SQLç±»å‹
        if (statement instanceof Select) {
            Select select = (Select) statement;
            
            // 3. è·å–SELECTä¸»ä½“
            PlainSelect plainSelect = (PlainSelect) select.getSelectBody();
            
            // 4. è·å–è¡¨å
            Table table = (Table) plainSelect.getFromItem();
            System.out.println("è¡¨å: " + table.getName());
            
            // 5. è·å–WHEREæ¡ä»¶
            Expression where = plainSelect.getWhere();
            System.out.println("WHEREæ¡ä»¶: " + where);
        }
    }
}
```

### 4.3 å®æˆ˜ï¼šè‡ªåŠ¨æ·»åŠ è½¯åˆ é™¤æ¡ä»¶


**ä¸šåŠ¡éœ€æ±‚**ï¼šæ‰€æœ‰æŸ¥è¯¢éƒ½è¦è¿‡æ»¤å·²åˆ é™¤çš„æ•°æ®

```java
public class SoftDeleteInterceptor implements InnerInterceptor {
    
    @Override
    public void beforeQuery(Executor executor, 
                           MappedStatement ms, 
                           Object parameter,
                           RowBounds rowBounds, 
                           ResultHandler resultHandler, 
                           BoundSql boundSql) {
        
        try {
            String sql = boundSql.getSql();
            
            // è§£æSQL
            Statement stmt = CCJSqlParserUtil.parse(sql);
            
            if (stmt instanceof Select) {
                Select select = (Select) stmt;
                PlainSelect plainSelect = (PlainSelect) select.getSelectBody();
                
                // æ·»åŠ è½¯åˆ é™¤æ¡ä»¶
                Expression deleteCondition = 
                    new EqualsTo(
                        new Column("deleted"), 
                        new LongValue(0)
                    );
                
                // åˆå¹¶åŸæœ‰WHEREæ¡ä»¶
                Expression where = plainSelect.getWhere();
                if (where != null) {
                    plainSelect.setWhere(
                        new AndExpression(where, deleteCondition)
                    );
                } else {
                    plainSelect.setWhere(deleteCondition);
                }
                
                // æ›¿æ¢SQL
                String newSql = select.toString();
                ReflectionUtils.setFieldValue(boundSql, "sql", newSql);
            }
            
        } catch (JSQLParserException e) {
            log.error("SQLè§£æå¤±è´¥", e);
        }
    }
}
```

**æ•ˆæœæ¼”ç¤º**ï¼š
```
åŸå§‹SQLï¼š
SELECT * FROM t_user WHERE age > 18

è‡ªåŠ¨æ·»åŠ åï¼š
SELECT * FROM t_user 
WHERE age > 18 AND deleted = 0  â† è‡ªåŠ¨æ·»åŠ 
```

---

## 5. ğŸ”„ å‚æ•°ä¿®æ”¹æœºåˆ¶


### 5.1 å‚æ•°ä¿®æ”¹çš„åŸç†


**å‚æ•°ä¼ é€’æµç¨‹**ï¼š
```
ç”¨æˆ·ä»£ç 
QueryWrapper<User> wrapper = new QueryWrapper<>();
wrapper.eq("name", "å¼ ä¸‰");
    â†“
è½¬æ¢ä¸ºå‚æ•°Map
{
    "ew.paramNameValuePairs.MPGENVAL1": "å¼ ä¸‰"
}
    â†“
ğŸ”” æ‹¦æˆªå™¨å¯ä»¥ä¿®æ”¹è¿™é‡Œçš„å‚æ•°
    â†“
ç»‘å®šåˆ°SQL
WHERE name = #{ew.paramNameValuePairs.MPGENVAL1}
    â†“
æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
WHERE name = 'å¼ ä¸‰'
```

### 5.2 ä¿®æ”¹å‚æ•°çš„æ–¹æ³•


**æ–¹æ³•ä¸€ï¼šä¿®æ”¹å‚æ•°Map**
```java
@Override
public void beforeQuery(..., Object parameter, ...) {
    
    if (parameter instanceof Map) {
        Map<String, Object> paramMap = (Map<String, Object>) parameter;
        
        // æ·»åŠ æ–°å‚æ•°
        paramMap.put("tenantId", getCurrentTenantId());
        
        // ä¿®æ”¹å·²æœ‰å‚æ•°
        if (paramMap.containsKey("status")) {
            paramMap.put("status", 1); // å¼ºåˆ¶æ”¹ä¸º1
        }
    }
}
```

**æ–¹æ³•äºŒï¼šä¿®æ”¹å®ä½“å¯¹è±¡**
```java
@Override
public void beforeUpdate(Executor executor, 
                        MappedStatement ms, 
                        Object parameter) {
    
    // å¦‚æœæ˜¯å®ä½“æ›´æ–°
    if (parameter instanceof User) {
        User user = (User) parameter;
        
        // è‡ªåŠ¨å¡«å……å­—æ®µ
        user.setUpdateTime(LocalDateTime.now());
        user.setUpdateBy(getCurrentUserId());
    }
}
```

### 5.3 å®æˆ˜ï¼šå¤šç§Ÿæˆ·å‚æ•°è‡ªåŠ¨æ³¨å…¥


**éœ€æ±‚**ï¼šSaaSç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªç§Ÿæˆ·åªèƒ½çœ‹åˆ°è‡ªå·±çš„æ•°æ®

```java
public class TenantInterceptor implements InnerInterceptor {
    
    @Override
    public void beforeQuery(Executor executor, 
                           MappedStatement ms, 
                           Object parameter,
                           RowBounds rowBounds, 
                           ResultHandler resultHandler, 
                           BoundSql boundSql) {
        
        // 1. è·å–å½“å‰ç§Ÿæˆ·ID
        Long tenantId = TenantContext.getCurrentTenantId();
        
        // 2. è§£æSQLï¼Œæ‰¾åˆ°éœ€è¦æ·»åŠ ç§Ÿæˆ·è¿‡æ»¤çš„è¡¨
        String sql = boundSql.getSql();
        String newSql = addTenantCondition(sql, tenantId);
        
        // 3. ä¿®æ”¹å‚æ•°ï¼ˆæ·»åŠ ç§Ÿæˆ·IDï¼‰
        if (parameter instanceof Map) {
            Map<String, Object> paramMap = (Map<String, Object>) parameter;
            paramMap.put("TENANT_ID", tenantId);
        }
        
        // 4. æ›¿æ¢SQL
        ReflectionUtils.setFieldValue(boundSql, "sql", newSql);
    }
    
    private String addTenantCondition(String sql, Long tenantId) {
        // è§£æå¹¶æ·»åŠ  AND tenant_id = #{TENANT_ID}
        // ... SQLè§£æé€»è¾‘
        return modifiedSql;
    }
}
```

**è‡ªåŠ¨éš”ç¦»æ•ˆæœ**ï¼š
```
ç§Ÿæˆ·Aæ‰§è¡ŒæŸ¥è¯¢ï¼š
SELECT * FROM t_order WHERE status = 1

è‡ªåŠ¨å˜ä¸ºï¼š
SELECT * FROM t_order 
WHERE status = 1 
AND tenant_id = 100  â† ç§Ÿæˆ·Açš„ID

ç§Ÿæˆ·Bæ‰§è¡ŒæŸ¥è¯¢ï¼š
SELECT * FROM t_order WHERE status = 1

è‡ªåŠ¨å˜ä¸ºï¼š
SELECT * FROM t_order 
WHERE status = 1 
AND tenant_id = 200  â† ç§Ÿæˆ·Bçš„ID

ğŸ”’ å®Œç¾å®ç°æ•°æ®éš”ç¦»ï¼
```

---

## 6. ğŸ“Š ç»“æœå¤„ç†é€»è¾‘


### 6.1 ç»“æœå¤„ç†çš„æ—¶æœº


**æŸ¥è¯¢ç»“æœæµç¨‹**ï¼š
```
æ•°æ®åº“è¿”å›åŸå§‹æ•°æ®
ResultSet {id=1, name="å¼ ä¸‰", phone="13812345678"}
    â†“
MyBatisæ˜ å°„ä¸ºå¯¹è±¡
User {id=1, name="å¼ ä¸‰", phone="13812345678"}
    â†“
ğŸ”” æ‹¦æˆªå™¨å¯ä»¥åœ¨è¿™é‡Œå¤„ç†ç»“æœ
    â†“
è„±æ•ã€åŠ å¯†ã€æ ¼å¼åŒ–ç­‰
User {id=1, name="å¼ ä¸‰", phone="138****5678"}
    â†“
è¿”å›ç»™ç”¨æˆ·
```

### 6.2 å®ç°ç»“æœå¤„ç†


> **âš ï¸ æ³¨æ„**
> MyBatis-Plusçš„`InnerInterceptor`æ²¡æœ‰ç›´æ¥çš„ç»“æœå¤„ç†æ–¹æ³•ï¼Œéœ€è¦ç»“åˆMyBatisçš„`ResultSetHandler`æ‹¦æˆª

**å®Œæ•´æ‹¦æˆªå™¨å®ç°**ï¼š
```java
@Intercepts({
    @Signature(
        type = ResultSetHandler.class,
        method = "handleResultSets",
        args = {Statement.class}
    )
})
public class ResultInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        
        // 1. æ‰§è¡ŒåŸæ–¹æ³•ï¼Œè·å–ç»“æœ
        Object result = invocation.proceed();
        
        // 2. å¤„ç†ç»“æœ
        if (result instanceof List) {
            List<?> list = (List<?>) result;
            for (Object obj : list) {
                processResult(obj);
            }
        } else {
            processResult(result);
        }
        
        return result;
    }
    
    // å¤„ç†å•ä¸ªç»“æœå¯¹è±¡
    private void processResult(Object obj) {
        if (obj == null) return;
        
        // éå†å­—æ®µï¼Œå¤„ç†æ•æ„Ÿä¿¡æ¯
        Field[] fields = obj.getClass().getDeclaredFields();
        for (Field field : fields) {
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è„±æ•æ³¨è§£
            if (field.isAnnotationPresent(Sensitive.class)) {
                field.setAccessible(true);
                try {
                    Object value = field.get(obj);
                    if (value instanceof String) {
                        // è„±æ•å¤„ç†
                        String masked = maskSensitiveData((String) value);
                        field.set(obj, masked);
                    }
                } catch (IllegalAccessException e) {
                    log.error("å­—æ®µè®¿é—®å¤±è´¥", e);
                }
            }
        }
    }
}
```

### 6.3 å®æˆ˜ï¼šè‡ªåŠ¨æ•°æ®è„±æ•


**å®šä¹‰è„±æ•æ³¨è§£**ï¼š
```java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.FIELD)
public @interface Sensitive {
    SensitiveType type();  // è„±æ•ç±»å‹
}

public enum SensitiveType {
    PHONE,      // æ‰‹æœºå·
    ID_CARD,    // èº«ä»½è¯
    BANK_CARD,  // é“¶è¡Œå¡
    EMAIL       // é‚®ç®±
}
```

**åœ¨å®ä½“ç±»ä½¿ç”¨**ï¼š
```java
public class User {
    private Long id;
    private String name;
    
    @Sensitive(type = SensitiveType.PHONE)
    private String phone;
    
    @Sensitive(type = SensitiveType.ID_CARD)
    private String idCard;
}
```

**è„±æ•å¤„ç†é€»è¾‘**ï¼š
```java
private String maskSensitiveData(String data, SensitiveType type) {
    if (data == null) return null;
    
    switch (type) {
        case PHONE:
            // 138****5678
            return data.replaceAll("(\\d{3})\\d{4}(\\d{4})", "$1****$2");
            
        case ID_CARD:
            // 110***********1234
            return data.replaceAll("(\\d{3})\\d{11}(\\d{4})", "$1***********$2");
            
        case EMAIL:
            // abc***@qq.com
            return data.replaceAll("(\\w{3})\\w*(@.*)", "$1***$2");
            
        default:
            return data;
    }
}
```

**æ•ˆæœå±•ç¤º**ï¼š
```
æ•°æ®åº“åŸå§‹æ•°æ®ï¼š
{
  "name": "å¼ ä¸‰",
  "phone": "13812345678",
  "idCard": "110101199001011234"
}

æŸ¥è¯¢è¿”å›ç»“æœï¼ˆè‡ªåŠ¨è„±æ•ï¼‰ï¼š
{
  "name": "å¼ ä¸‰",
  "phone": "138****5678",      â† å·²è„±æ•
  "idCard": "110***********1234" â† å·²è„±æ•
}
```

---

## 7. âš™ï¸ æ‹¦æˆªå™¨æ³¨å†Œé…ç½®


### 7.1 é…ç½®æ–¹å¼å¯¹æ¯”


| é…ç½®æ–¹å¼ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|----------|----------|------|------|
| **Javaé…ç½®** | SpringBooté¡¹ç›® | çµæ´»ã€ç±»å‹å®‰å…¨ | ä»£ç é‡ç¨å¤š |
| **XMLé…ç½®** | Springé¡¹ç›® | é…ç½®é›†ä¸­ | ä¸å¤Ÿçµæ´» |
| **æ³¨è§£é…ç½®** | ç®€å•æ‹¦æˆªå™¨ | ç®€æ´ | åŠŸèƒ½å—é™ |

### 7.2 SpringBooté…ç½®æ–¹å¼


**æ–¹å¼ä¸€ï¼šé…ç½®ç±»æ³¨å†Œï¼ˆæ¨èï¼‰**
```java
@Configuration
public class MybatisPlusConfig {
    
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        
        // æ·»åŠ å¤šä¸ªæ‹¦æˆªå™¨ï¼ˆæ³¨æ„é¡ºåºï¼ï¼‰
        
        // 1. å¤šç§Ÿæˆ·æ‹¦æˆªå™¨ï¼ˆæœ€å…ˆæ‰§è¡Œï¼‰
        interceptor.addInnerInterceptor(new TenantInterceptor());
        
        // 2. æ•°æ®æƒé™æ‹¦æˆªå™¨
        interceptor.addInnerInterceptor(new DataPermissionInterceptor());
        
        // 3. åˆ†é¡µæ‹¦æˆªå™¨
        PaginationInnerInterceptor pageInterceptor = 
            new PaginationInnerInterceptor(DbType.MYSQL);
        pageInterceptor.setMaxLimit(1000L); // å•é¡µæœ€å¤§1000æ¡
        interceptor.addInnerInterceptor(pageInterceptor);
        
        // 4. ä¹è§‚é”æ‹¦æˆªå™¨
        interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
        
        return interceptor;
    }
}
```

> **ğŸ”‘ æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº**
> ```
> æŒ‰ç…§æ·»åŠ é¡ºåºæ‰§è¡Œï¼š
> æŸ¥è¯¢æ—¶ï¼šæ‹¦æˆªå™¨1 â†’ æ‹¦æˆªå™¨2 â†’ æ‹¦æˆªå™¨3 â†’ æ‰§è¡ŒSQL
> æ›´æ–°æ—¶ï¼šæ‹¦æˆªå™¨1 â†’ æ‹¦æˆªå™¨2 â†’ æ‹¦æˆªå™¨3 â†’ æ‰§è¡ŒSQL
> 
> âš ï¸ é¡ºåºå¾ˆé‡è¦ï¼æ¯”å¦‚å¤šç§Ÿæˆ·è¦åœ¨åˆ†é¡µå‰æ‰§è¡Œ
> ```

**æ–¹å¼äºŒï¼šè‡ªåŠ¨é…ç½®**
```java
@Component
public class CustomInterceptor implements InnerInterceptor {
    // å®ç°æ‹¦æˆªé€»è¾‘...
}

// åœ¨é…ç½®ç±»ä¸­è‡ªåŠ¨æ³¨å…¥
@Configuration
public class MybatisPlusConfig {
    
    @Autowired
    private List<InnerInterceptor> innerInterceptors;
    
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        
        // è‡ªåŠ¨æ·»åŠ æ‰€æœ‰æ‹¦æˆªå™¨
        innerInterceptors.forEach(interceptor::addInnerInterceptor);
        
        return interceptor;
    }
}
```

### 7.3 æ‹¦æˆªå™¨é…ç½®æœ€ä½³å®è·µ


**ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•**ï¼š

- [ ] **é¡ºåºæ£€æŸ¥**ï¼šç§Ÿæˆ·ã€æƒé™ç­‰æ‹¦æˆªå™¨è¦åœ¨åˆ†é¡µå‰
- [ ] **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…åœ¨æ‹¦æˆªå™¨ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
- [ ] **å¼‚å¸¸å¤„ç†**ï¼šæ‹¦æˆªå™¨å¼‚å¸¸è¦æœ‰é™çº§æ–¹æ¡ˆ
- [ ] **æ—¥å¿—è®°å½•**ï¼šè®°å½•æ‹¦æˆªå™¨çš„æ‰§è¡Œæƒ…å†µ
- [ ] **å¼€å…³æ§åˆ¶**ï¼šæ”¯æŒåŠ¨æ€å¼€å¯/å…³é—­æ‹¦æˆªå™¨

**å®Œæ•´é…ç½®ç¤ºä¾‹**ï¼š
```java
@Configuration
@EnableConfigurationProperties(InterceptorProperties.class)
public class MybatisPlusConfig {
    
    @Autowired
    private InterceptorProperties properties;
    
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        
        // æ ¹æ®é…ç½®åŠ¨æ€æ·»åŠ æ‹¦æˆªå™¨
        if (properties.isTenantEnabled()) {
            interceptor.addInnerInterceptor(tenantInterceptor());
        }
        
        if (properties.isDataPermissionEnabled()) {
            interceptor.addInnerInterceptor(dataPermissionInterceptor());
        }
        
        // åˆ†é¡µæ‹¦æˆªå™¨ï¼ˆåŸºæœ¬éƒ½éœ€è¦ï¼‰
        interceptor.addInnerInterceptor(paginationInterceptor());
        
        return interceptor;
    }
    
    private TenantInterceptor tenantInterceptor() {
        TenantInterceptor interceptor = new TenantInterceptor();
        // è®¾ç½®ç§Ÿæˆ·å­—æ®µå
        interceptor.setTenantIdColumn("tenant_id");
        return interceptor;
    }
}

// é…ç½®å±æ€§ç±»
@ConfigurationProperties(prefix = "mybatis-plus.interceptor")
@Data
public class InterceptorProperties {
    private boolean tenantEnabled = true;
    private boolean dataPermissionEnabled = true;
    private boolean sqlLogEnabled = false;
}
```

**application.ymlé…ç½®**ï¼š
```yaml
mybatis-plus:
  interceptor:
    tenant-enabled: true           # å¼€å¯å¤šç§Ÿæˆ·
    data-permission-enabled: true  # å¼€å¯æ•°æ®æƒé™
    sql-log-enabled: false         # å…³é—­SQLæ—¥å¿—
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


> **ğŸ¯ æ‹¦æˆªå™¨äº”å¤§æ ¸å¿ƒ**
> 
> 1. **æ‹¦æˆªæ—¶æœº**ï¼šbeforeQueryæŸ¥è¯¢å‰ã€beforeUpdateæ›´æ–°å‰
> 2. **SQLå¤„ç†**ï¼šè§£æSQLã€ä¿®æ”¹SQLã€æ·»åŠ æ¡ä»¶
> 3. **å‚æ•°ä¿®æ”¹**ï¼šæ³¨å…¥å‚æ•°ã€ä¿®æ”¹å‚æ•°ã€æ ¡éªŒå‚æ•°
> 4. **ç»“æœå¤„ç†**ï¼šæ•°æ®è„±æ•ã€æ ¼å¼è½¬æ¢ã€æƒé™è¿‡æ»¤
> 5. **æ³¨å†Œé…ç½®**ï¼šé…ç½®é¡ºåºã€åŠ¨æ€å¼€å…³ã€æ€§èƒ½ä¼˜åŒ–

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ‹¦æˆªå™¨å°±åƒ"è¿‡æ»¤ç½‘"**
```
ç”¨æˆ·è¯·æ±‚
    â†“
[æ‹¦æˆªå™¨1ï¼šæ—¥å¿—è®°å½•] â† è®°å½•è°åœ¨æ“ä½œ
    â†“
[æ‹¦æˆªå™¨2ï¼šæƒé™æ£€æŸ¥] â† æ£€æŸ¥æ˜¯å¦æœ‰æƒé™
    â†“
[æ‹¦æˆªå™¨3ï¼šå‚æ•°å¤„ç†] â† æ·»åŠ ç§Ÿæˆ·IDç­‰
    â†“
[æ‹¦æˆªå™¨4ï¼šSQLä¼˜åŒ–] â† ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
    â†“
æ‰§è¡Œæ•°æ®åº“æ“ä½œ
    â†“
[æ‹¦æˆªå™¨5ï¼šç»“æœå¤„ç†] â† æ•°æ®è„±æ•
    â†“
è¿”å›ç»“æœ
```

**ğŸ”¹ ä½¿ç”¨åœºæ™¯åˆ¤æ–­**

| éœ€æ±‚ | ä½¿ç”¨æ‹¦æˆªå™¨ | æ‹¦æˆªç±»å‹ |
|------|-----------|---------|
| è®°å½•æ“ä½œæ—¥å¿— | âœ… æ¨è | beforeQuery/Update |
| æ•°æ®æƒé™æ§åˆ¶ | âœ… æ¨è | beforeQuery |
| å¤šç§Ÿæˆ·éš”ç¦» | âœ… æ¨è | beforeQuery/Update |
| æ•°æ®è„±æ• | âœ… æ¨è | ResultSetHandler |
| é˜²æ­¢å…¨è¡¨åˆ é™¤ | âœ… æ¨è | beforeUpdate |
| ç®€å•å­—æ®µå¡«å…… | âŒ ç”¨@TableField | - |
| å¤æ‚ä¸šåŠ¡é€»è¾‘ | âŒ æ”¾Serviceå±‚ | - |

### 8.3 å®æˆ˜å¼€å‘å»ºè®®


**ğŸ”§ å¼€å‘æ­¥éª¤**ï¼š
```
1. æ˜ç¡®éœ€æ±‚
   â†“ ç¡®å®šè¦åœ¨ä»€ä¹ˆæ—¶å€™æ‹¦æˆªä»€ä¹ˆæ“ä½œ
   
2. é€‰æ‹©æ‹¦æˆªç‚¹
   â†“ beforeQuery / beforeUpdate / ResultSetHandler
   
3. å®ç°æ‹¦æˆªé€»è¾‘
   â†“ SQLè§£æ â†’ å‚æ•°ä¿®æ”¹ â†’ ç»“æœå¤„ç†
   
4. æ³¨å†Œæ‹¦æˆªå™¨
   â†“ é…ç½®é¡ºåºã€è®¾ç½®å‚æ•°
   
5. æµ‹è¯•éªŒè¯
   â†“ å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•
```

**âš ï¸ å¸¸è§é™·é˜±**

```
é™·é˜±1ï¼šæ‹¦æˆªå™¨é¡ºåºé”™è¯¯
âŒ åˆ†é¡µæ‹¦æˆªå™¨åœ¨å‰ï¼Œç§Ÿæˆ·æ‹¦æˆªå™¨åœ¨å
   â†’ ç»“æœï¼šåˆ†é¡µç»Ÿè®¡ä¸å‡†ç¡®
âœ… ç§Ÿæˆ·æ‹¦æˆªå™¨åœ¨å‰ï¼Œåˆ†é¡µæ‹¦æˆªå™¨åœ¨å

é™·é˜±2ï¼šè¿‡åº¦æ‹¦æˆª
âŒ æ‰€æœ‰SQLéƒ½æ‹¦æˆªå¤„ç†
   â†’ ç»“æœï¼šæ€§èƒ½ä¸‹é™
âœ… åªæ‹¦æˆªéœ€è¦çš„SQLï¼Œæ·»åŠ è¿‡æ»¤æ¡ä»¶

é™·é˜±3ï¼šå‚æ•°ä¿®æ”¹ä¸ç”Ÿæ•ˆ
âŒ ç›´æ¥ä¿®æ”¹parameterå¯¹è±¡
   â†’ ç»“æœï¼šæŸäº›æƒ…å†µä¸‹ä¸ç”Ÿæ•ˆ
âœ… é€šè¿‡åå°„ä¿®æ”¹BoundSqlä¸­çš„å‚æ•°

é™·é˜±4ï¼šSQLè§£æå¤±è´¥
âŒ æ²¡æœ‰åšå¼‚å¸¸å¤„ç†
   â†’ ç»“æœï¼šç³»ç»Ÿå´©æºƒ
âœ… try-catchå¹¶è®°å½•æ—¥å¿—ï¼Œé™çº§å¤„ç†
```

**ğŸª è®°å¿†å£è¯€**

```
æ‹¦æˆªå™¨å¼€å‘è¦è®°ç‰¢ï¼Œ
æ—¶æœºé€‰æ‹©æœ€é‡è¦ã€‚
æŸ¥è¯¢æ›´æ–°ä¸¤å¤§ç‚¹ï¼Œ
ç»“æœå¤„ç†ä¹Ÿè¦æã€‚

SQLè§£æè¦ä»”ç»†ï¼Œ
å‚æ•°ä¿®æ”¹æœ‰æŠ€å·§ã€‚
æ³¨å†Œé¡ºåºä¸èƒ½ä¹±ï¼Œ
å¼‚å¸¸å¤„ç†è¦åšå¥½ã€‚

æ€§èƒ½ä¼˜åŒ–æ”¾å¿ƒä¸Šï¼Œ
æ—¥å¿—è®°å½•ä¸èƒ½å°‘ã€‚
å¤šç§Ÿæˆ·æƒé™æ˜¯é‡ç‚¹ï¼Œ
æ•°æ®å®‰å…¨ç¬¬ä¸€æ¡ï¼
```

### 8.4 è¿›é˜¶å­¦ä¹ æ–¹å‘


**ğŸ“š æ·±å…¥å­¦ä¹ è·¯å¾„**ï¼š

```
å½“å‰æ°´å¹³ï¼šæŒæ¡åŸºç¡€æ‹¦æˆªå™¨
         â†“
ä¸‹ä¸€æ­¥ï¼šå­¦ä¹ MyBatisæºç 
â”œâ”€â”€ Executoræ‰§è¡Œå™¨åŸç†
â”œâ”€â”€ StatementHandleråŸç†  
â””â”€â”€ ResultSetHandleråŸç†
         â†“
è¿›é˜¶ï¼šæ€§èƒ½ä¼˜åŒ–
â”œâ”€â”€ SQLæ‰§è¡Œè®¡åˆ’åˆ†æ
â”œâ”€â”€ ç´¢å¼•ä¼˜åŒ–å»ºè®®
â””â”€â”€ æ…¢SQLè‡ªåŠ¨å‘Šè­¦
         â†“
é«˜çº§ï¼šåˆ†å¸ƒå¼åœºæ™¯
â”œâ”€â”€ åˆ†å¸ƒå¼äº‹åŠ¡æ‹¦æˆª
â”œâ”€â”€ è¯»å†™åˆ†ç¦»è·¯ç”±
â””â”€â”€ æ•°æ®åº“åˆ†ç‰‡
```

**ğŸ”— ç›¸å…³æŠ€æœ¯**ï¼š
- å‰ç½®çŸ¥è¯†ï¼š`MyBatisåŸç†` `Javaåå°„` `SQLè¯­æ³•`
- é…åˆä½¿ç”¨ï¼š`Spring AOP` `åˆ†é¡µæ’ä»¶` `æ•°æ®æƒé™`
- è¿›é˜¶å­¦ä¹ ï¼š`ShardingSphere` `åˆ†å¸ƒå¼äº‹åŠ¡` `æ€§èƒ½ä¼˜åŒ–`

---

**æ ¸å¿ƒè®°å¿†**ï¼š
- æ‹¦æˆªå™¨æ˜¯SQLæ‰§è¡Œçš„"å®ˆé—¨å‘˜"ï¼Œåœ¨æ‰§è¡Œå‰ååšæ£€æŸ¥å’Œå¤„ç†
- beforeQueryç®¡æŸ¥è¯¢ã€beforeUpdateç®¡æ›´æ–°ï¼Œå„å¸å…¶èŒ
- SQLè§£æç”¨JSqlParserï¼Œå‚æ•°ä¿®æ”¹é åå°„ï¼Œç»“æœå¤„ç†ç”¨æ‹¦æˆª
- é…ç½®é¡ºåºå¾ˆå…³é”®ï¼Œå¼‚å¸¸å¤„ç†è¦å®Œå–„ï¼Œæ€§èƒ½ä¼˜åŒ–ä¸èƒ½å¿˜
- å¤šç§Ÿæˆ·ã€æƒé™ã€è„±æ•æ˜¯ä¸‰å¤§åº”ç”¨åœºæ™¯ï¼ŒæŒæ¡äº†å°±èƒ½åº”å¯¹å¤§éƒ¨åˆ†éœ€æ±‚