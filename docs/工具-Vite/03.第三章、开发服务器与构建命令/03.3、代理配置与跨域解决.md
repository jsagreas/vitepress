---
title: 3、代理配置与跨域解决
---
## 📚 目录

1. [跨域问题理解](#1-跨域问题理解)
2. [代理服务器配置](#2-代理服务器配置)
3. [代理实战应用](#3-代理实战应用)
4. [代理问题排查](#4-代理问题排查)
5. [核心要点总结](#5-核心要点总结)

---

## 1. 🌐 跨域问题理解


### 1.1 什么是跨域？


**🔸 简单理解**
跨域就像是小区的门禁系统，不同小区的人不能随便进入其他小区。

```
网站A (http://localhost:3000)  →  想访问  →  网站B (http://localhost:8080)
    ↑                                           ↑
前端页面                                     后端接口

浏览器：❌ "不行！你们不是同一个域，我不允许这样的访问！"
```

**💡 专业解释**
跨域是指从一个域名的网页去访问另一个域名的资源。浏览器的**同源策略**会阻止这种访问。

### 1.2 什么是同源策略？


**🔸 同源的三个条件（必须完全相同）**
```
协议 + 域名 + 端口 = 同源

✅ 同源示例：
http://localhost:3000/page1
http://localhost:3000/page2
→ 协议、域名、端口都相同

❌ 跨域示例：
http://localhost:3000  ←→  http://localhost:8080  (端口不同)
http://localhost:3000  ←→  https://localhost:3000  (协议不同)
http://localhost:3000  ←→  http://127.0.0.1:3000   (域名不同)
```

### 1.3 为什么会跨域？


**🛡️ 浏览器的安全考虑**
想象一下，如果没有跨域限制：
- 恶意网站可以随意读取你银行网站的信息
- 钓鱼网站可以伪造请求到其他网站
- 用户信息安全无法保障

**💭 现实场景**
```
你在开发时：
前端项目：http://localhost:3000  (Vite开发服务器)
后端接口：http://localhost:8080  (Spring Boot/Node.js等)

浏览器看到：端口不同 → 跨域 → 阻止请求
```

### 1.4 跨域产生的常见场景


**🎯 开发环境最常见**
```
场景1：前后端分离开发
前端：http://localhost:3000
后端：http://localhost:8080
→ 端口不同，产生跨域

场景2：调用第三方API
你的网站：http://localhost:3000
第三方API：https://api.github.com
→ 协议、域名都不同，产生跨域

场景3：CDN资源访问
你的网站：http://localhost:3000
CDN资源：https://cdn.example.com
→ 协议、域名不同，产生跨域
```

### 1.5 跨域的表现症状


**❌ 浏览器控制台常见错误**
```
CORS policy error:
Access to fetch at 'http://localhost:8080/api/users' 
from origin 'http://localhost:3000' has been blocked 
by CORS policy: No 'Access-Control-Allow-Origin' header.

翻译：从源头'http://localhost:3000'获取'http://localhost:8080/api/users'
被CORS策略阻止：没有'Access-Control-Allow-Origin'响应头。
```

**🔍 实际现象**
- 🚫 接口请求失败
- 🚫 获取不到数据  
- 🚫 网络面板显示请求被阻止
- 🚫 前端报错但后端日志正常

---

## 2. 🔧 代理服务器配置


### 2.1 什么是代理服务器？


**🔸 代理的工作原理**
```
没有代理时（跨域）：
前端(3000) → 直接请求 → 后端(8080)  ❌ 被浏览器阻止

有代理时（绕过跨域）：
前端(3000) → 请求同源代理 → 代理转发 → 后端(8080)  ✅ 成功
              ↑                    ↑
           同源，不跨域           服务器间通信，无跨域限制
```

**💡 简单理解**
代理就像是你的"代购朋友"：
- 你想买国外的东西（跨域请求）
- 直接买不到（被浏览器阻止）
- 朋友帮你代购（代理服务器）
- 朋友买到后给你（返回数据）

### 2.2 Vite中的代理配置


**📝 基础配置语法**
```js
// vite.config.js
export default {
  server: {
    proxy: {
      // 配置代理规则
      '/api': 'http://localhost:8080'
    }
  }
}
```

**🔍 配置解读**
```js
'/api': 'http://localhost:8080'
  ↑              ↑
代理路径      目标服务器

含义：所有以 /api 开头的请求，都转发到 http://localhost:8080
```

### 2.3 server.proxy 常见配置


**🎯 基础代理配置**
```js
export default {
  server: {
    proxy: {
      // 简单配置：字符串形式
      '/api': 'http://localhost:8080',
      
      // 详细配置：对象形式
      '/api': {
        target: 'http://localhost:8080',  // 目标服务器
        changeOrigin: true,               // 改变请求头中的origin
        rewrite: (path) => path.replace(/^\/api/, '') // 重写路径
      }
    }
  }
}
```

**📋 重要配置项说明**

| 配置项 | **作用** | **示例** |
|--------|---------|---------|
| `target` | 🎯 **目标服务器地址** | `'http://localhost:8080'` |
| `changeOrigin` | 🔄 **是否改变源地址** | `true`（推荐开启） |
| `rewrite` | ✂️ **重写请求路径** | 去掉路径前缀 |
| `secure` | 🔒 **是否验证SSL证书** | `false`（开发时忽略） |

### 2.4 路径重写的重要性


**🔸 为什么需要路径重写？**
```js
前端请求：http://localhost:3000/api/users
代理转发：http://localhost:8080/api/users
                                  ↑
                        后端可能没有 /api 前缀！

解决方案：
rewrite: (path) => path.replace(/^\/api/, '')

结果：
前端请求：http://localhost:3000/api/users
实际转发：http://localhost:8080/users  ✅ 正确
```

**💻 完整配置示例**
```js
// vite.config.js
export default {
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
}
```

---

## 3. 🚀 代理实战应用


### 3.1 单个API服务代理


**🎯 场景：前端调用后端用户管理接口**

```js
// vite.config.js
export default {
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
}
```

**📱 前端使用方式**
```js
// 前端代码
async function getUsers() {
  // 实际请求：http://localhost:3000/api/users
  // 代理转发：http://localhost:8080/users
  const response = await fetch('/api/users')
  return response.json()
}
```

**✅ 代理流程**
```
1. 前端发起：GET /api/users
2. Vite识别：路径匹配 /api
3. 路径重写：/api/users → /users  
4. 转发请求：GET http://localhost:8080/users
5. 返回数据：后端响应 → 前端接收
```

### 3.2 多个服务代理配置


**🎯 场景：对接多个后端服务**

```js
// vite.config.js
export default {
  server: {
    proxy: {
      // 用户服务
      '/api/user': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api\/user/, '/user')
      },
      
      // 订单服务  
      '/api/order': {
        target: 'http://localhost:8081',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api\/order/, '/order')
      },
      
      // 第三方支付服务
      '/api/payment': {
        target: 'https://payment.example.com',
        changeOrigin: true,
        secure: false, // 忽略SSL证书验证
        rewrite: (path) => path.replace(/^\/api\/payment/, '')
      }
    }
  }
}
```

**🔄 请求分发示例**
```js
// 不同请求被分发到不同服务
fetch('/api/user/profile')    → http://localhost:8080/user/profile
fetch('/api/order/list')      → http://localhost:8081/order/list  
fetch('/api/payment/create')  → https://payment.example.com/create
```

### 3.3 高级代理配置


**🔧 带请求头和响应处理**
```js
export default {
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        
        // 配置请求头
        configure: (proxy, options) => {
          proxy.on('proxyReq', (proxyReq, req, res) => {
            // 添加自定义请求头
            proxyReq.setHeader('X-Special-Proxy-Header', 'vite-proxy')
            console.log('代理请求:', req.method, req.url)
          })
          
          proxy.on('proxyRes', (proxyRes, req, res) => {
            // 处理响应
            console.log('代理响应:', proxyRes.statusCode, req.url)
          })
        }
      }
    }
  }
}
```

### 3.4 开发与生产环境适配


**🌍 环境变量配置**
```js
// vite.config.js
export default {
  server: {
    proxy: {
      '/api': {
        // 根据环境变量选择目标服务器
        target: process.env.NODE_ENV === 'development' 
          ? 'http://localhost:8080'    // 开发环境
          : 'https://api.prod.com',    // 生产环境
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
}
```

**📝 .env 文件配置**
```bash
# .env.development
VITE_API_BASE_URL=http://localhost:8080

# .env.production  
VITE_API_BASE_URL=https://api.prod.com
```

---

## 4. 🔍 代理问题排查


### 4.1 代理失效常见原因


**❌ 常见问题及解决方案**

**问题1：路径匹配错误**
```js
❌ 错误配置：
'/api': { target: 'http://localhost:8080' }
前端请求：/user/list  → 不匹配，代理不生效

✅ 正确配置：
'/api': { target: 'http://localhost:8080' }  
前端请求：/api/user/list  → 匹配成功
```

**问题2：忘记路径重写**
```js
❌ 问题：
'/api': { target: 'http://localhost:8080' }
转发结果：http://localhost:8080/api/users
但后端没有 /api 前缀！

✅ 解决：
'/api': {
  target: 'http://localhost:8080',
  rewrite: (path) => path.replace(/^\/api/, '')
}
```

**问题3：changeOrigin配置错误**
```js
❌ 问题：某些后端检查请求来源
changeOrigin: false  → 请求被后端拒绝

✅ 解决：
changeOrigin: true  → 修改请求头，绕过检查
```

### 4.2 代理配置调试方法


**🔍 开启代理日志**
```js
export default {
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        configure: (proxy, options) => {
          proxy.on('proxyReq', (proxyReq, req, res) => {
            console.log('🔄 代理请求:', req.method, req.url)
            console.log('📍 目标地址:', options.target + req.url)
          })
          
          proxy.on('proxyRes', (proxyRes, req, res) => {
            console.log('✅ 代理响应:', proxyRes.statusCode)
          })
          
          proxy.on('error', (err, req, res) => {
            console.error('❌ 代理错误:', err.message)
          })
        }
      }
    }
  }
}
```

**📊 调试检查清单**

> 🔍 **调试步骤**：
> 1. **检查控制台** - 是否有CORS错误？
> 2. **检查网络面板** - 请求是否发出？状态码？
> 3. **检查路径匹配** - URL是否符合代理规则？
> 4. **检查后端日志** - 后端是否收到请求？
> 5. **检查代理日志** - 代理是否正常转发？

### 4.3 接口请求验证


**✅ 验证代理是否生效**
```js
// 1. 直接访问后端（会跨域）
fetch('http://localhost:8080/users')  // ❌ CORS Error

// 2. 通过代理访问（应该成功）
fetch('/api/users')  // ✅ Success

// 3. 检查请求详情
fetch('/api/users')
  .then(response => {
    console.log('状态码:', response.status)
    console.log('响应头:', response.headers)
    return response.json()
  })
  .then(data => {
    console.log('数据:', data)
  })
  .catch(error => {
    console.error('错误:', error)
  })
```

**🧪 测试代理配置**
```js
// vite.config.js - 添加测试端点
export default {
  server: {
    proxy: {
      '/test-proxy': {
        target: 'https://jsonplaceholder.typicode.com',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/test-proxy/, '')
      }
    }
  }
}

// 测试请求
fetch('/test-proxy/posts/1')  // 应该返回测试数据
```

---

## 5. 📋 核心要点总结


### 5.1 必须掌握的核心概念


```
🔸 跨域本质：浏览器同源策略的安全限制
🔸 代理原理：通过同源服务器转发请求绕过跨域
🔸 配置要点：路径匹配 + 目标服务器 + 路径重写
🔸 调试方法：查看控制台 + 网络面板 + 代理日志
🔸 实际应用：开发环境解决前后端分离的跨域问题
```

### 5.2 关键配置模板


**🎯 最常用的代理配置**
```js
// vite.config.js
export default {
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8080',  // 后端服务地址
        changeOrigin: true,               // 必须开启
        rewrite: (path) => path.replace(/^\/api/, '') // 去掉前缀
      }
    }
  }
}
```

### 5.3 问题解决思路


**🔧 遇到代理问题的排查顺序**
```
1. 🔍 确认跨域现象：控制台是否有CORS错误？
2. 📝 检查配置语法：代理规则是否正确？
3. 🎯 验证路径匹配：请求URL是否符合规则？
4. 🔄 测试路径重写：转发后的URL是否正确？
5. 🌐 检查目标服务：后端服务是否正常运行？
6. 📊 查看代理日志：请求是否正常转发？
```

### 5.4 实践建议


**💡 开发中的最佳实践**
- ✅ **统一前缀**：所有API请求都用 `/api` 开头
- ✅ **路径重写**：后端通常不需要 `/api` 前缀
- ✅ **开启changeOrigin**：避免请求来源检查问题
- ✅ **环境区分**：开发和生产用不同的目标地址
- ✅ **错误处理**：添加代理错误监听和日志

**🎯 核心理解**
> 💡 **记住**：代理不是魔法，它只是帮你"绕过"浏览器的跨域限制。本质上是让Vite开发服务器充当"中间人"，帮你转发请求到真正的后端服务器。

**核心记忆口诀**：
- 跨域问题浏览器拦，代理服务来周旋
- 同源策略要绕过，路径匹配配置全
- 目标服务要准确，路径重写别遗漏
- changeOrigin要开启，调试日志助排查