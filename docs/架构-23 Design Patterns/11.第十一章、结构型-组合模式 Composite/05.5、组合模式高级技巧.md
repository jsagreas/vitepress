---
title: 5ã€ç»„åˆæ¨¡å¼é«˜çº§æŠ€å·§
---
## ğŸ“š ç›®å½•

1. [ç¼“å­˜æœºåˆ¶è®¾è®¡](#1-ç¼“å­˜æœºåˆ¶è®¾è®¡)
2. [å»¶è¿ŸåŠ è½½ç­–ç•¥](#2-å»¶è¿ŸåŠ è½½ç­–ç•¥)
3. [äº‹ä»¶ä¼ æ’­æœºåˆ¶](#3-äº‹ä»¶ä¼ æ’­æœºåˆ¶)
4. [è®¿é—®è€…æ¨¡å¼ç»“åˆ](#4-è®¿é—®è€…æ¨¡å¼ç»“åˆ)
5. [æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯](#5-æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—„ï¸ ç¼“å­˜æœºåˆ¶è®¾è®¡


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜


æƒ³è±¡ä¸€ä¸‹ä½ åœ¨ç®¡ç†ä¸€ä¸ªå…¬å¸çš„ç»„ç»‡æ¶æ„ï¼Œæ¯æ¬¡æŸ¥è¯¢æŸä¸ªéƒ¨é—¨çš„æ€»äººæ•°æ—¶ï¼Œå¦‚æœéƒ½è¦é‡æ–°éå†æ‰€æœ‰å­éƒ¨é—¨æ¥è®¡ç®—ï¼Œè¿™ä¼šå¾ˆæ…¢ã€‚ç¼“å­˜å°±åƒæ˜¯æŠŠè®¡ç®—ç»“æœè®°åœ¨å°æœ¬å­ä¸Šï¼Œä¸‹æ¬¡ç›´æ¥çœ‹æœ¬å­å°±è¡Œã€‚

**ğŸ”¸ ç¼“å­˜çš„æœ¬è´¨**
```
æ²¡æœ‰ç¼“å­˜çš„æƒ…å†µï¼š
ç”¨æˆ·æŸ¥è¯¢ â†’ éå†æ•´ä¸ªæ ‘ â†’ è®¡ç®—ç»“æœ â†’ è¿”å›
(æ¯æ¬¡éƒ½è¦é‡æ–°è®¡ç®—ï¼Œå¾ˆæ…¢)

æœ‰ç¼“å­˜çš„æƒ…å†µï¼š
ç”¨æˆ·æŸ¥è¯¢ â†’ æ£€æŸ¥ç¼“å­˜ â†’ å¦‚æœæœ‰ç¼“å­˜ç›´æ¥è¿”å›
                  â†’ å¦‚æœæ²¡æœ‰å†è®¡ç®—å¹¶å­˜å…¥ç¼“å­˜
```

### 1.2 ç¼“å­˜æœºåˆ¶å®ç°


**ç®€å•çš„è®¡æ•°ç¼“å­˜ç¤ºä¾‹**ï¼š
```java
// å‘˜å·¥ç»„ä»¶åŸºç±»
abstract class Employee {
    protected String name;
    protected Integer cachedCount = null;  // ç¼“å­˜å‘˜å·¥æ•°é‡
    protected boolean isDirty = true;      // æ ‡è®°æ•°æ®æ˜¯å¦è¿‡æœŸ
    
    // è·å–å‘˜å·¥æ€»æ•°ï¼ˆå¸¦ç¼“å­˜ï¼‰
    public int getEmployeeCount() {
        if (isDirty || cachedCount == null) {
            cachedCount = calculateCount();
            isDirty = false;
        }
        return cachedCount;
    }
    
    // å­ç±»å®ç°å…·ä½“è®¡ç®—é€»è¾‘
    protected abstract int calculateCount();
    
    // æ ‡è®°ç¼“å­˜å¤±æ•ˆ
    protected void invalidateCache() {
        isDirty = true;
        cachedCount = null;
    }
}

// éƒ¨é—¨ç±»ï¼ˆç»„åˆèŠ‚ç‚¹ï¼‰
class Department extends Employee {
    private List<Employee> members = new ArrayList<>();
    
    public void addMember(Employee employee) {
        members.add(employee);
        invalidateCache(); // æ·»åŠ æˆå‘˜åç¼“å­˜å¤±æ•ˆ
    }
    
    @Override
    protected int calculateCount() {
        return members.stream()
                .mapToInt(Employee::getEmployeeCount)
                .sum();
    }
}

// æ™®é€šå‘˜å·¥ç±»ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰
class Worker extends Employee {
    @Override
    protected int calculateCount() {
        return 1; // ä¸€ä¸ªå‘˜å·¥å°±æ˜¯1
    }
}
```

### 1.3 æ™ºèƒ½ç¼“å­˜æ›´æ–°ç­–ç•¥


**ğŸ”¸ å‘ä¸Šä¼ æ’­å¤±æ•ˆç­–ç•¥**
```java
abstract class Employee {
    protected Employee parent;
    private Map<String, Object> cache = new HashMap<>();
    
    // æ·»åŠ å­èŠ‚ç‚¹æ—¶è‡ªåŠ¨å¤„ç†ç¼“å­˜
    protected void addChild(Employee child) {
        child.parent = this;
        invalidateCacheUpward(); // å‘ä¸Šä¼ æ’­ç¼“å­˜å¤±æ•ˆ
    }
    
    // å‘ä¸Šä¼ æ’­ç¼“å­˜å¤±æ•ˆ
    private void invalidateCacheUpward() {
        cache.clear();
        if (parent != null) {
            parent.invalidateCacheUpward();
        }
    }
    
    // é€šç”¨ç¼“å­˜è·å–æ–¹æ³•
    @SuppressWarnings("unchecked")
    protected <T> T getCached(String key, Supplier<T> calculator) {
        return (T) cache.computeIfAbsent(key, k -> calculator.get());
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// è®¡ç®—éƒ¨é—¨è–ªèµ„æ€»å’Œï¼ˆå¸¦ç¼“å­˜ï¼‰
class Department extends Employee {
    public double getTotalSalary() {
        return getCached("totalSalary", () -> {
            return members.stream()
                    .mapToDouble(Employee::getSalary)
                    .sum();
        });
    }
}
```

---

## 2. â° å»¶è¿ŸåŠ è½½ç­–ç•¥


### 2.1 ä»€ä¹ˆæ˜¯å»¶è¿ŸåŠ è½½


å»¶è¿ŸåŠ è½½å°±åƒæ˜¯"ç”¨åˆ°æ—¶å†æ‰“å¼€"çš„ç­–ç•¥ã€‚æ¯”å¦‚ä½ æœ‰ä¸€ä¸ªè£…æ»¡ç…§ç‰‡çš„ç›¸å†Œï¼Œä¸æ˜¯ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰ç…§ç‰‡éƒ½æ‹¿å‡ºæ¥çœ‹ï¼Œè€Œæ˜¯æƒ³çœ‹å“ªå¼ å†ç¿»åˆ°å“ªå¼ ã€‚

**ğŸ”¸ å»¶è¿ŸåŠ è½½çš„å¥½å¤„**
```
ä¼ ç»ŸåŠ è½½ï¼š
ç¨‹åºå¯åŠ¨ â†’ åŠ è½½æ‰€æœ‰æ•°æ® â†’ å ç”¨å¤§é‡å†…å­˜ â†’ å¯åŠ¨æ…¢

å»¶è¿ŸåŠ è½½ï¼š
ç¨‹åºå¯åŠ¨ â†’ åªåŠ è½½åŸºæœ¬ä¿¡æ¯ â†’ å¯åŠ¨å¿«
ç”¨æˆ·è®¿é—®æ—¶ â†’ å†åŠ è½½å…·ä½“æ•°æ® â†’ å†…å­˜ç”¨é‡å°
```

### 2.2 æ–‡ä»¶ç³»ç»Ÿå»¶è¿ŸåŠ è½½ç¤ºä¾‹


```java
// æ–‡ä»¶ç³»ç»Ÿç»„ä»¶æ¥å£
interface FileSystemComponent {
    String getName();
    long getSize();
    void list();
}

// æ–‡ä»¶ç±»ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰
class File implements FileSystemComponent {
    private String name;
    private long size;
    
    public File(String name, long size) {
        this.name = name;
        this.size = size;
    }
    
    @Override
    public void list() {
        System.out.println("ğŸ“„ " + name + " (" + size + " bytes)");
    }
}

// æ–‡ä»¶å¤¹ç±»ï¼ˆæ”¯æŒå»¶è¿ŸåŠ è½½ï¼‰
class Folder implements FileSystemComponent {
    private String name;
    private List<FileSystemComponent> children;
    private boolean loaded = false;  // æ˜¯å¦å·²åŠ è½½
    
    public Folder(String name) {
        this.name = name;
    }
    
    // å»¶è¿ŸåŠ è½½å­æ–‡ä»¶
    private void ensureLoaded() {
        if (!loaded) {
            System.out.println("ğŸ”„ æ­£åœ¨åŠ è½½æ–‡ä»¶å¤¹: " + name);
            loadChildren(); // æ¨¡æ‹Ÿä»ç£ç›˜åŠ è½½
            loaded = true;
        }
    }
    
    // æ¨¡æ‹Ÿä»ç£ç›˜åŠ è½½æ–‡ä»¶åˆ—è¡¨
    private void loadChildren() {
        children = new ArrayList<>();
        // è¿™é‡Œå¯ä»¥æ˜¯ä»æ•°æ®åº“ã€æ–‡ä»¶ç³»ç»Ÿç­‰åŠ è½½æ•°æ®
        if ("Documents".equals(name)) {
            children.add(new File("report.pdf", 1024));
            children.add(new File("notes.txt", 512));
        }
    }
    
    @Override
    public void list() {
        ensureLoaded(); // è®¿é—®æ—¶æ‰åŠ è½½
        System.out.println("ğŸ“ " + name + "/");
        for (FileSystemComponent child : children) {
            System.out.print("  ");
            child.list();
        }
    }
    
    @Override
    public long getSize() {
        ensureLoaded();
        return children.stream()
                .mapToLong(FileSystemComponent::getSize)
                .sum();
    }
}
```

### 2.3 æ™ºèƒ½é¢„åŠ è½½ç­–ç•¥


```java
// å¸¦é¢„åŠ è½½æç¤ºçš„æ–‡ä»¶å¤¹
class SmartFolder extends Folder {
    private int accessCount = 0;
    private Set<String> frequentlyAccessed = new HashSet<>();
    
    @Override
    public void list() {
        accessCount++;
        super.list();
        
        // å¦‚æœé¢‘ç¹è®¿é—®ï¼Œé¢„åŠ è½½å­æ–‡ä»¶å¤¹
        if (accessCount > 3) {
            preloadFrequentFolders();
        }
    }
    
    private void preloadFrequentFolders() {
        // é¢„åŠ è½½ç»å¸¸è®¿é—®çš„å­æ–‡ä»¶å¤¹
        children.stream()
                .filter(child -> child instanceof SmartFolder)
                .forEach(folder -> {
                    if (frequentlyAccessed.contains(folder.getName())) {
                        ((SmartFolder) folder).list(); // è§¦å‘åŠ è½½
                    }
                });
    }
}
```

---

## 3. ğŸ“¡ äº‹ä»¶ä¼ æ’­æœºåˆ¶


### 3.1 äº‹ä»¶ä¼ æ’­çš„æ¦‚å¿µ


æƒ³è±¡ä¸€ä¸‹å…¬å¸é‡Œçš„æ¶ˆæ¯ä¼ é€’ï¼šCEOå‘å¸ƒé‡è¦é€šçŸ¥ï¼Œéœ€è¦ä¼ è¾¾åˆ°æ¯ä¸ªéƒ¨é—¨ï¼Œå†ç”±éƒ¨é—¨ç»ç†ä¼ è¾¾ç»™æ¯ä¸ªå‘˜å·¥ã€‚äº‹ä»¶ä¼ æ’­å°±æ˜¯è¿™æ ·çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶ã€‚

**ğŸ”¸ äº‹ä»¶ä¼ æ’­çš„æ–¹å‘**
```
å‘ä¸‹ä¼ æ’­ï¼ˆä»æ ¹åˆ°å¶ï¼‰ï¼š
    CEOé€šçŸ¥
      â†“
   éƒ¨é—¨ç»ç†
      â†“
   æ™®é€šå‘˜å·¥

å‘ä¸Šä¼ æ’­ï¼ˆä»å¶åˆ°æ ¹ï¼‰ï¼š
   å‘˜å·¥åé¦ˆ
      â†‘
   éƒ¨é—¨æ±‡æ€»
      â†‘
    CEOå†³ç­–
```

### 3.2 äº‹ä»¶ç³»ç»Ÿå®ç°


```java
// äº‹ä»¶æ¥å£
interface Event {
    String getType();
    Object getData();
    boolean canPropagate();
}

// å…·ä½“äº‹ä»¶ç±»
class SalaryChangeEvent implements Event {
    private double newSalary;
    private boolean propagate = true;
    
    public SalaryChangeEvent(double newSalary) {
        this.newSalary = newSalary;
    }
    
    @Override
    public String getType() { return "SALARY_CHANGE"; }
    
    @Override
    public Object getData() { return newSalary; }
    
    @Override
    public boolean canPropagate() { return propagate; }
}

// äº‹ä»¶ç›‘å¬å™¨æ¥å£
interface EventListener {
    void handleEvent(Event event);
}

// æ”¯æŒäº‹ä»¶çš„å‘˜å·¥åŸºç±»
abstract class EventAwareEmployee {
    protected String name;
    protected List<EventListener> listeners = new ArrayList<>();
    protected List<EventAwareEmployee> children = new ArrayList<>();
    protected EventAwareEmployee parent;
    
    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    public void addEventListener(EventListener listener) {
        listeners.add(listener);
    }
    
    // å‘ä¸‹ä¼ æ’­äº‹ä»¶
    public void broadcastDown(Event event) {
        // å…ˆå¤„ç†è‡ªå·±
        notifyListeners(event);
        
        // å†ä¼ æ’­ç»™å­èŠ‚ç‚¹
        if (event.canPropagate()) {
            for (EventAwareEmployee child : children) {
                child.broadcastDown(event);
            }
        }
    }
    
    // å‘ä¸Šä¼ æ’­äº‹ä»¶
    public void bubbleUp(Event event) {
        notifyListeners(event);
        
        if (event.canPropagate() && parent != null) {
            parent.bubbleUp(event);
        }
    }
    
    // é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨
    private void notifyListeners(Event event) {
        for (EventListener listener : listeners) {
            listener.handleEvent(event);
        }
    }
}
```

### 3.3 å®é™…åº”ç”¨ç¤ºä¾‹


```java
// éƒ¨é—¨ç±»
class EventDepartment extends EventAwareEmployee {
    public EventDepartment(String name) {
        this.name = name;
        
        // ç›‘å¬è–ªèµ„å˜åŒ–äº‹ä»¶
        addEventListener(event -> {
            if ("SALARY_CHANGE".equals(event.getType())) {
                System.out.println("ğŸ“Š éƒ¨é—¨ " + name + " æ”¶åˆ°è–ªèµ„å˜åŒ–é€šçŸ¥");
                updateBudget((Double) event.getData());
            }
        });
    }
    
    private void updateBudget(double newSalary) {
        System.out.println("ğŸ’° æ›´æ–°éƒ¨é—¨é¢„ç®—...");
    }
    
    // å®£å¸ƒéƒ¨é—¨é‡ç»„
    public void announceDepartmentReorg() {
        Event event = new Event() {
            @Override
            public String getType() { return "DEPARTMENT_REORG"; }
            @Override
            public Object getData() { return name; }
            @Override
            public boolean canPropagate() { return true; }
        };
        
        broadcastDown(event); // å‘ä¸‹é€šçŸ¥æ‰€æœ‰å‘˜å·¥
    }
}

// å‘˜å·¥ç±»
class EventWorker extends EventAwareEmployee {
    private double salary;
    
    public EventWorker(String name, double salary) {
        this.name = name;
        this.salary = salary;
        
        // ç›‘å¬éƒ¨é—¨é‡ç»„äº‹ä»¶
        addEventListener(event -> {
            if ("DEPARTMENT_REORG".equals(event.getType())) {
                System.out.println("ğŸ‘¤ å‘˜å·¥ " + name + " æ”¶åˆ°é‡ç»„é€šçŸ¥");
            }
        });
    }
    
    // ç”³è¯·åŠ è–ªï¼ˆå‘ä¸Šä¼ æ’­ï¼‰
    public void requestRaise(double amount) {
        Event event = new SalaryChangeEvent(salary + amount);
        bubbleUp(event); // å‘ä¸Šä¼ æ’­ç»™ä¸Šçº§
    }
}
```

---

## 4. ğŸ­ è®¿é—®è€…æ¨¡å¼ç»“åˆ


### 4.1 ä¸ºä»€ä¹ˆè¦ç»“åˆè®¿é—®è€…æ¨¡å¼


ç»„åˆæ¨¡å¼æ“…é•¿æ„å»ºæ ‘å½¢ç»“æ„ï¼Œä½†å½“ä½ éœ€è¦å¯¹æ ‘ä¸­ä¸åŒç±»å‹çš„èŠ‚ç‚¹æ‰§è¡Œä¸åŒæ“ä½œæ—¶ï¼Œè®¿é—®è€…æ¨¡å¼å°±æ´¾ä¸Šç”¨åœºäº†ã€‚å°±åƒæ˜¯è¯·ä¸åŒçš„ä¸“å®¶æ¥æ£€æŸ¥ä½ çš„ç»„ç»‡æ¶æ„ï¼šHRçœ‹äººå‘˜é…ç½®ï¼Œè´¢åŠ¡çœ‹é¢„ç®—åˆ†é…ã€‚

**ğŸ”¸ é—®é¢˜åœºæ™¯**
```
ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š
- æ¯æ¬¡æ–°å¢æ“ä½œï¼Œéƒ½è¦ä¿®æ”¹æ‰€æœ‰èŠ‚ç‚¹ç±»
- ä¸åŒæ“ä½œçš„ä»£ç æ··æ‚åœ¨ä¸€èµ·
- è¿åå¼€é—­åŸåˆ™

è®¿é—®è€…æ¨¡å¼çš„è§£å†³ï¼š
- æŠŠæ“ä½œæŠ½ç¦»åˆ°ç‹¬ç«‹çš„è®¿é—®è€…ç±»
- æ–°å¢æ“ä½œåªéœ€æ–°å¢è®¿é—®è€…
- å„ç§æ“ä½œé€»è¾‘åˆ†ç¦»æ¸…æ™°
```

### 4.2 è®¿é—®è€…æ¨¡å¼ç»“åˆå®ç°


```java
// è®¿é—®è€…æ¥å£
interface OrganizationVisitor {
    void visitDepartment(Department department);
    void visitEmployee(Worker worker);
}

// å¯è®¿é—®çš„ç»„ç»‡ç»„ä»¶æ¥å£
interface Visitable {
    void accept(OrganizationVisitor visitor);
}

// éƒ¨é—¨ç±»ï¼ˆæ”¯æŒè®¿é—®è€…ï¼‰
class Department implements Visitable {
    private String name;
    private List<Visitable> members = new ArrayList<>();
    
    public void addMember(Visitable member) {
        members.add(member);
    }
    
    @Override
    public void accept(OrganizationVisitor visitor) {
        visitor.visitDepartment(this); // è®¿é—®è‡ªå·±
        
        // è®¿é—®æ‰€æœ‰ä¸‹å±
        for (Visitable member : members) {
            member.accept(visitor);
        }
    }
    
    // getter methods...
    public String getName() { return name; }
    public List<Visitable> getMembers() { return members; }
}

// å‘˜å·¥ç±»ï¼ˆæ”¯æŒè®¿é—®è€…ï¼‰
class Worker implements Visitable {
    private String name;
    private double salary;
    private String position;
    
    @Override
    public void accept(OrganizationVisitor visitor) {
        visitor.visitEmployee(this);
    }
    
    // getter methods...
    public String getName() { return name; }
    public double getSalary() { return salary; }
    public String getPosition() { return position; }
}
```

### 4.3 å…·ä½“è®¿é—®è€…å®ç°


```java
// è–ªèµ„ç»Ÿè®¡è®¿é—®è€…
class SalaryReportVisitor implements OrganizationVisitor {
    private double totalSalary = 0;
    private int employeeCount = 0;
    private Map<String, Double> departmentSalaries = new HashMap<>();
    
    @Override
    public void visitDepartment(Department department) {
        System.out.println("ğŸ“Š åˆ†æéƒ¨é—¨: " + department.getName());
        double departmentTotal = 0;
        
        // è¿™é‡Œå¯ä»¥æ·»åŠ éƒ¨é—¨çº§åˆ«çš„è–ªèµ„ç»Ÿè®¡é€»è¾‘
        departmentSalaries.put(department.getName(), departmentTotal);
    }
    
    @Override
    public void visitEmployee(Worker worker) {
        totalSalary += worker.getSalary();
        employeeCount++;
        System.out.println("ğŸ’° å‘˜å·¥ " + worker.getName() + 
                          " è–ªèµ„: $" + worker.getSalary());
    }
    
    public void printReport() {
        System.out.println("\nğŸ“ˆ è–ªèµ„æŠ¥å‘Šæ±‡æ€»ï¼š");
        System.out.println("æ€»å‘˜å·¥æ•°: " + employeeCount);
        System.out.println("è–ªèµ„æ€»é¢: $" + totalSalary);
        System.out.println("å¹³å‡è–ªèµ„: $" + (totalSalary / employeeCount));
    }
}

// ç»„ç»‡æ¶æ„å›¾è®¿é—®è€…
class OrgChartVisitor implements OrganizationVisitor {
    private int depth = 0;
    
    @Override
    public void visitDepartment(Department department) {
        printIndent();
        System.out.println("ğŸ¢ " + department.getName());
        depth++;
    }
    
    @Override
    public void visitEmployee(Worker worker) {
        printIndent();
        System.out.println("ğŸ‘¤ " + worker.getName() + 
                          " (" + worker.getPosition() + ")");
    }
    
    private void printIndent() {
        for (int i = 0; i < depth; i++) {
            System.out.print("  ");
        }
    }
}
```

### 4.4 ä½¿ç”¨ç¤ºä¾‹


```java
public class VisitorPatternDemo {
    public static void main(String[] args) {
        // æ„å»ºç»„ç»‡æ¶æ„
        Department company = new Department("ABCå…¬å¸");
        Department tech = new Department("æŠ€æœ¯éƒ¨");
        Department sales = new Department("é”€å”®éƒ¨");
        
        tech.addMember(new Worker("å¼ ä¸‰", 8000, "ç¨‹åºå‘˜"));
        tech.addMember(new Worker("æå››", 12000, "æ¶æ„å¸ˆ"));
        sales.addMember(new Worker("ç‹äº”", 6000, "é”€å”®å‘˜"));
        
        company.addMember(tech);
        company.addMember(sales);
        
        // ä½¿ç”¨ä¸åŒè®¿é—®è€…
        System.out.println("=== è–ªèµ„åˆ†æ ===");
        SalaryReportVisitor salaryVisitor = new SalaryReportVisitor();
        company.accept(salaryVisitor);
        salaryVisitor.printReport();
        
        System.out.println("\n=== ç»„ç»‡æ¶æ„å›¾ ===");
        OrgChartVisitor chartVisitor = new OrgChartVisitor();
        company.accept(chartVisitor);
    }
}
```

---

## 5. âš¡ æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯


### 5.1 æ‰¹é‡æ“ä½œä¼˜åŒ–


å½“ä½ éœ€è¦å¯¹æ ‘ä¸­å¤§é‡èŠ‚ç‚¹æ‰§è¡Œç›¸åŒæ“ä½œæ—¶ï¼Œæ‰¹é‡å¤„ç†æ¯”é€ä¸ªå¤„ç†æ•ˆç‡æ›´é«˜ã€‚

```java
// æ”¯æŒæ‰¹é‡æ“ä½œçš„ç»„åˆç»„ä»¶
abstract class OptimizedComponent {
    protected List<OptimizedComponent> children = new ArrayList<>();
    
    // æ‰¹é‡æ›´æ–°ï¼ˆä¸€æ¬¡æ€§æ”¶é›†æ‰€æœ‰éœ€è¦æ›´æ–°çš„é¡¹ï¼‰
    public void batchUpdate(BatchOperation operation) {
        List<OptimizedComponent> allComponents = new ArrayList<>();
        collectAllComponents(allComponents);
        
        // æ‰¹é‡æ‰§è¡Œæ“ä½œ
        operation.executeBatch(allComponents);
    }
    
    // æ”¶é›†æ‰€æœ‰ç»„ä»¶
    private void collectAllComponents(List<OptimizedComponent> collector) {
        collector.add(this);
        for (OptimizedComponent child : children) {
            child.collectAllComponents(collector);
        }
    }
}

// æ‰¹é‡æ“ä½œæ¥å£
interface BatchOperation {
    void executeBatch(List<OptimizedComponent> components);
}

// ä½¿ç”¨ç¤ºä¾‹
public class BatchUpdateExample {
    public static void main(String[] args) {
        OptimizedComponent root = createLargeTree();
        
        // æ‰¹é‡æ›´æ–°æ‰€æœ‰å‘˜å·¥è–ªèµ„
        root.batchUpdate(components -> {
            // ä¸€æ¬¡æ€§æ•°æ®åº“è¿æ¥ï¼Œæ‰¹é‡æ›´æ–°
            System.out.println("å¼€å§‹æ‰¹é‡æ›´æ–° " + components.size() + " ä¸ªç»„ä»¶");
            for (OptimizedComponent component : components) {
                // æ‰§è¡Œæ›´æ–°é€»è¾‘
            }
            System.out.println("æ‰¹é‡æ›´æ–°å®Œæˆ");
        });
    }
}
```

### 5.2 ç´¢å¼•æœºåˆ¶ä¼˜åŒ–


```java
// å¸¦ç´¢å¼•çš„ç»„åˆç»“æ„
class IndexedComposite {
    private Map<String, Component> idIndex = new HashMap<>();
    private Map<String, List<Component>> typeIndex = new HashMap<>();
    private Component root;
    
    // æ·»åŠ ç»„ä»¶æ—¶è‡ªåŠ¨å»ºç«‹ç´¢å¼•
    public void addComponent(Component component) {
        // æ›´æ–°IDç´¢å¼•
        idIndex.put(component.getId(), component);
        
        // æ›´æ–°ç±»å‹ç´¢å¼•
        String type = component.getType();
        typeIndex.computeIfAbsent(type, k -> new ArrayList<>())
                 .add(component);
    }
    
    // å¿«é€ŸæŸ¥æ‰¾ï¼ˆO(1)æ—¶é—´å¤æ‚åº¦ï¼‰
    public Component findById(String id) {
        return idIndex.get(id);
    }
    
    // æŒ‰ç±»å‹æŸ¥æ‰¾
    public List<Component> findByType(String type) {
        return typeIndex.getOrDefault(type, new ArrayList<>());
    }
    
    // æ¸…ç†ç´¢å¼•
    public void removeComponent(String id) {
        Component component = idIndex.remove(id);
        if (component != null) {
            typeIndex.get(component.getType()).remove(component);
        }
    }
}
```

### 5.3 å†…å­˜ä¼˜åŒ–æŠ€æœ¯


```java
// è½»é‡çº§ç»„ä»¶ï¼ˆäº«å…ƒæ¨¡å¼ç»“åˆï¼‰
class LightweightComponent {
    // å†…åœ¨çŠ¶æ€ï¼ˆå…±äº«ï¼‰
    private static final Map<String, ComponentType> TYPE_CACHE = new HashMap<>();
    
    // å¤–åœ¨çŠ¶æ€ï¼ˆæ¯ä¸ªå®ä¾‹ç‹¬æœ‰ï¼‰
    private String id;
    private ComponentType type;
    private Object specificData;
    
    // è·å–å…±äº«çš„ç±»å‹å¯¹è±¡
    public static ComponentType getType(String typeName) {
        return TYPE_CACHE.computeIfAbsent(typeName, ComponentType::new);
    }
    
    public LightweightComponent(String id, String typeName) {
        this.id = id;
        this.type = getType(typeName); // å…±äº«ç±»å‹å¯¹è±¡
    }
}

// ç»„ä»¶ç±»å‹ï¼ˆå¯å…±äº«çš„éƒ¨åˆ†ï¼‰
class ComponentType {
    private String name;
    private String defaultBehavior;
    private Map<String, Object> metadata;
    
    public ComponentType(String name) {
        this.name = name;
        // åˆå§‹åŒ–å…¬å…±æ•°æ®
    }
}
```

### 5.4 å¹¶å‘å®‰å…¨ä¼˜åŒ–


```java
// çº¿ç¨‹å®‰å…¨çš„ç»„åˆç»„ä»¶
public class ThreadSafeComposite {
    private final ReadWriteLock lock = new ReentrantReadWriteLock();
    private final List<Component> children = new ArrayList<>();
    
    // è¯»æ“ä½œï¼ˆå…è®¸å¹¶å‘ï¼‰
    public List<Component> getChildren() {
        lock.readLock().lock();
        try {
            return new ArrayList<>(children); // è¿”å›å‰¯æœ¬
        } finally {
            lock.readLock().unlock();
        }
    }
    
    // å†™æ“ä½œï¼ˆäº’æ–¥ï¼‰
    public void addChild(Component child) {
        lock.writeLock().lock();
        try {
            children.add(child);
        } finally {
            lock.writeLock().unlock();
        }
    }
    
    // æ‰¹é‡æ“ä½œï¼ˆå‡å°‘é”ç«äº‰ï¼‰
    public void addChildren(List<Component> newChildren) {
        lock.writeLock().lock();
        try {
            children.addAll(newChildren);
        } finally {
            lock.writeLock().unlock();
        }
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„é«˜çº§æŠ€å·§


```
ğŸ”¸ ç¼“å­˜æœºåˆ¶ï¼šé¿å…é‡å¤è®¡ç®—ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
ğŸ”¸ å»¶è¿ŸåŠ è½½ï¼šæŒ‰éœ€åŠ è½½æ•°æ®ï¼Œå‡å°‘å†…å­˜å ç”¨å’Œå¯åŠ¨æ—¶é—´
ğŸ”¸ äº‹ä»¶ä¼ æ’­ï¼šå®ç°ç»„ä»¶é—´æ¾è€¦åˆé€šä¿¡æœºåˆ¶
ğŸ”¸ è®¿é—®è€…ç»“åˆï¼šåˆ†ç¦»æ•°æ®ç»“æ„å’Œæ“ä½œé€»è¾‘ï¼Œä¾¿äºæ‰©å±•
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡æ“ä½œã€ç´¢å¼•æœºåˆ¶ã€å†…å­˜ä¼˜åŒ–ã€å¹¶å‘å®‰å…¨
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç¼“å­˜ç­–ç•¥é€‰æ‹©**
```
ä½•æ—¶ä½¿ç”¨ç¼“å­˜ï¼š
âœ… è®¡ç®—æˆæœ¬é«˜çš„æ“ä½œ
âœ… é¢‘ç¹è®¿é—®çš„æ•°æ®
âœ… ç›¸å¯¹ç¨³å®šçš„ç»“æœ

ç¼“å­˜å¤±æ•ˆç­–ç•¥ï¼š
- ç«‹å³å¤±æ•ˆï¼šæ•°æ®å˜åŒ–æ—¶ç«‹å³æ¸…é™¤ç¼“å­˜
- å®šæ—¶å¤±æ•ˆï¼šè®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´
- æ‰‹åŠ¨å¤±æ•ˆï¼šæä¾›æ¸…é™¤ç¼“å­˜çš„æ–¹æ³•
```

**ğŸ”¹ å»¶è¿ŸåŠ è½½çš„é€‚ç”¨åœºæ™¯**
```
é€‚åˆå»¶è¿ŸåŠ è½½çš„æƒ…å†µï¼š
âœ… å¤§é‡æ•°æ®ä½†ä¸ä¸€å®šå…¨éƒ¨ç”¨åˆ°
âœ… åŠ è½½æˆæœ¬é«˜ï¼ˆæ•°æ®åº“æŸ¥è¯¢ã€ç½‘ç»œè¯·æ±‚ï¼‰
âœ… ç”¨æˆ·ç•Œé¢éœ€è¦å¿«é€Ÿå“åº”

ä¸é€‚åˆçš„æƒ…å†µï¼š
âŒ æ•°æ®é‡å°ä¸”ç»å¸¸è®¿é—®
âŒ å®æ—¶æ€§è¦æ±‚å¾ˆé«˜
âŒ åŠ è½½å¤±è´¥ä¼šä¸¥é‡å½±å“åŠŸèƒ½
```

**ğŸ”¹ äº‹ä»¶ä¼ æ’­çš„è®¾è®¡åŸåˆ™**
```
è®¾è®¡è¦ç‚¹ï¼š
- å®šä¹‰æ¸…æ™°çš„äº‹ä»¶æ¥å£
- æ”¯æŒäº‹ä»¶çš„å–æ¶ˆå’Œåœæ­¢ä¼ æ’­
- é¿å…å¾ªç¯å¼•ç”¨å¯¼è‡´çš„æ— é™ä¼ æ’­
- å¼‚æ­¥å¤„ç†é¿å…é˜»å¡ä¸»æµç¨‹
```

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š æ€§èƒ½ç›‘æ§è¦ç‚¹**
| ä¼˜åŒ–æŠ€æœ¯ | **ç›‘æ§æŒ‡æ ‡** | **é¢„æœŸæ•ˆæœ** | **æ³¨æ„äº‹é¡¹** |
|---------|------------|-------------|-------------|
| ğŸ—„ï¸ **ç¼“å­˜æœºåˆ¶** | `ç¼“å­˜å‘½ä¸­ç‡ã€å†…å­˜ä½¿ç”¨` | `æŸ¥è¯¢é€Ÿåº¦æå‡2-10å€` | `ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜` |
| â° **å»¶è¿ŸåŠ è½½** | `åˆå§‹åŒ–æ—¶é—´ã€å†…å­˜å ç”¨` | `å¯åŠ¨é€Ÿåº¦æå‡50%+` | `é¦–æ¬¡è®¿é—®å»¶è¿Ÿ` |
| ğŸ“¡ **äº‹ä»¶ä¼ æ’­** | `äº‹ä»¶å¤„ç†æ—¶é—´ã€æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦` | `ç»„ä»¶è§£è€¦ã€æ‰©å±•æ€§å¢å¼º` | `è°ƒè¯•éš¾åº¦å¢åŠ ` |
| ğŸ­ **è®¿é—®è€…æ¨¡å¼** | `ä»£ç å¤æ‚åº¦ã€æ‰©å±•é¢‘ç‡` | `æ–°åŠŸèƒ½å¼€å‘æ•ˆç‡æå‡` | `ç±»çš„æ•°é‡å¢åŠ ` |

### 6.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ æŠ€æœ¯é€‰æ‹©æŒ‡å—**
```
é€‰æ‹©ç¼“å­˜æœºåˆ¶ï¼š
- æ•°æ®ç›¸å¯¹ç¨³å®š + è®¡ç®—å¤æ‚ â†’ ä½¿ç”¨ç¼“å­˜
- æ•°æ®é¢‘ç¹å˜åŒ– + è®¡ç®—ç®€å• â†’ ç›´æ¥è®¡ç®—

é€‰æ‹©å»¶è¿ŸåŠ è½½ï¼š
- å¤§å‹æ•°æ®é›† + éƒ¨åˆ†è®¿é—® â†’ å»¶è¿ŸåŠ è½½
- å°å‹æ•°æ®é›† + é¢‘ç¹è®¿é—® â†’ é¢„åŠ è½½

é€‰æ‹©äº‹ä»¶æœºåˆ¶ï¼š
- ç»„ä»¶é—´é€šä¿¡å¤æ‚ â†’ äº‹ä»¶ä¼ æ’­
- ç®€å•çš„çˆ¶å­å…³ç³» â†’ ç›´æ¥è°ƒç”¨

é€‰æ‹©è®¿é—®è€…æ¨¡å¼ï¼š
- æ“ä½œç§ç±»å¤šä¸”ç»å¸¸æ–°å¢ â†’ è®¿é—®è€…æ¨¡å¼
- æ“ä½œå›ºå®šä¸”ç®€å• â†’ ç›´æ¥åœ¨ç»„ä»¶ä¸­å®ç°
```

### 6.5 å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ


**âš ï¸ ç¼“å­˜ç›¸å…³é—®é¢˜**
```
é—®é¢˜ï¼šç¼“å­˜ä¸ä¸€è‡´
è§£å†³ï¼šå®ç°å®Œå–„çš„ç¼“å­˜å¤±æ•ˆæœºåˆ¶

é—®é¢˜ï¼šå†…å­˜æ³„æ¼
è§£å†³ï¼šè®¾ç½®ç¼“å­˜å¤§å°é™åˆ¶å’Œè¿‡æœŸæ—¶é—´

é—®é¢˜ï¼šç¼“å­˜é›ªå´©
è§£å†³ï¼šé”™å¼€ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œä½¿ç”¨å¤‡ç”¨æ•°æ®
```

**âš ï¸ å»¶è¿ŸåŠ è½½é—®é¢˜**
```
é—®é¢˜ï¼šN+1æŸ¥è¯¢é—®é¢˜
è§£å†³ï¼šæ‰¹é‡é¢„åŠ è½½ç›¸å…³æ•°æ®

é—®é¢˜ï¼šåŠ è½½å¤±è´¥å¤„ç†
è§£å†³ï¼šæä¾›é™çº§æ–¹æ¡ˆå’Œé‡è¯•æœºåˆ¶

é—®é¢˜ï¼šçº¿ç¨‹å®‰å…¨é—®é¢˜
è§£å†³ï¼šä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„å»¶è¿ŸåŠ è½½å®ç°
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- ç¼“å­˜æœºåˆ¶è¦å¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§
- å»¶è¿ŸåŠ è½½é€‚åˆå¤§æ•°æ®é‡åœºæ™¯
- äº‹ä»¶ä¼ æ’­å®ç°æ¾è€¦åˆé€šä¿¡
- è®¿é—®è€…æ¨¡å¼åˆ†ç¦»ç»“æ„å’Œæ“ä½œ
- æ€§èƒ½ä¼˜åŒ–è¦åŸºäºå®é™…æµ‹é‡æ•°æ®