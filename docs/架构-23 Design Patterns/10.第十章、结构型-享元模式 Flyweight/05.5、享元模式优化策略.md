---
title: 5ã€äº«å…ƒæ¨¡å¼ä¼˜åŒ–ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [äº«å…ƒå¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†](#1-äº«å…ƒå¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†)
2. [ç¼“å­˜æ·˜æ±°ç­–ç•¥è®¾è®¡](#2-ç¼“å­˜æ·˜æ±°ç­–ç•¥è®¾è®¡)
3. [å†…å­˜æ³„æ¼é˜²æŠ¤æœºåˆ¶](#3-å†…å­˜æ³„æ¼é˜²æŠ¤æœºåˆ¶)
4. [çº¿ç¨‹å®‰å…¨è®¾è®¡æ–¹æ¡ˆ](#4-çº¿ç¨‹å®‰å…¨è®¾è®¡æ–¹æ¡ˆ)
5. [æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜](#5-æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ äº«å…ƒå¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†


### 1.1 ä»€ä¹ˆæ˜¯äº«å…ƒå¯¹è±¡ç”Ÿå‘½å‘¨æœŸ


**ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ**
äº«å…ƒå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯å®ƒä»åˆ›å»ºåˆ°é”€æ¯çš„æ•´ä¸ªè¿‡ç¨‹ã€‚ä¸æ™®é€šå¯¹è±¡ä¸åŒï¼Œäº«å…ƒå¯¹è±¡éœ€è¦è¢«å¤šä¸ªåœ°æ–¹å…±äº«ä½¿ç”¨ï¼Œæ‰€ä»¥å®ƒçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†æ›´åŠ å¤æ‚ã€‚

**ğŸŒ° ç”Ÿæ´»ç±»æ¯”**
```
æƒ³è±¡ä¸€ä¸ªå›¾ä¹¦é¦†ï¼š
ğŸ“š ä¹¦ç± = äº«å…ƒå¯¹è±¡
ğŸ‘¥ è¯»è€… = ä½¿ç”¨äº«å…ƒçš„å®¢æˆ·ç«¯
ğŸ“‹ å€Ÿä¹¦è®°å½• = å¼•ç”¨è®¡æ•°

ä¹¦ç±çš„ç”Ÿå‘½å‘¨æœŸï¼š
å…¥åº“ â†’ è¢«å€Ÿé˜… â†’ å½’è¿˜ â†’ å†æ¬¡å€Ÿé˜… â†’ ... â†’ æŠ¥åºŸ
```

### 1.2 ç”Ÿå‘½å‘¨æœŸé˜¶æ®µè¯¦è§£


**ğŸ“Š å®Œæ•´ç”Ÿå‘½å‘¨æœŸå›¾**
```
åˆ›å»ºé˜¶æ®µ    ä½¿ç”¨é˜¶æ®µ    ç»´æŠ¤é˜¶æ®µ    é”€æ¯é˜¶æ®µ
   â†“          â†“          â†“          â†“
 å®ä¾‹åŒ–  â†’  è¢«å¼•ç”¨  â†’  çŠ¶æ€æ£€æŸ¥  â†’  èµ„æºé‡Šæ”¾
   â†“          â†“          â†“          â†“
 åŠ å…¥æ±   â†’  å¼•ç”¨è®¡æ•°  â†’  æ¸…ç†æ£€æŸ¥  â†’  ä»æ± ç§»é™¤
```

**ğŸ”¸ åˆ›å»ºé˜¶æ®µï¼ˆCreation Phaseï¼‰**
```java
public class FontFlyweight {
    private String fontFamily;  // å†…éƒ¨çŠ¶æ€
    private int fontSize;       // å†…éƒ¨çŠ¶æ€
    private int referenceCount; // å¼•ç”¨è®¡æ•°
    
    public FontFlyweight(String fontFamily, int fontSize) {
        this.fontFamily = fontFamily;
        this.fontSize = fontSize;
        this.referenceCount = 0;
        System.out.println("åˆ›å»ºå­—ä½“äº«å…ƒ: " + fontFamily + "-" + fontSize);
    }
}
```

**ğŸ”¸ ä½¿ç”¨é˜¶æ®µï¼ˆUsage Phaseï¼‰**
```java
public class FlyweightFactory {
    private Map<String, FontFlyweight> flyweights = new HashMap<>();
    
    public FontFlyweight getFlyweight(String fontFamily, int fontSize) {
        String key = fontFamily + "-" + fontSize;
        FontFlyweight flyweight = flyweights.get(key);
        
        if (flyweight == null) {
            flyweight = new FontFlyweight(fontFamily, fontSize);
            flyweights.put(key, flyweight);
        }
        
        // å¢åŠ å¼•ç”¨è®¡æ•°
        flyweight.addReference();
        return flyweight;
    }
}
```

### 1.3 å¼•ç”¨è®¡æ•°ç®¡ç†


**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦å¼•ç”¨è®¡æ•°**
å¼•ç”¨è®¡æ•°å°±åƒå›¾ä¹¦é¦†çš„å€Ÿä¹¦è®°å½•ï¼Œè®°å½•æœ‰å¤šå°‘äººåœ¨ä½¿ç”¨è¿™ä¸ªäº«å…ƒå¯¹è±¡ã€‚å½“æ²¡æœ‰äººä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘å›æ”¶å®ƒã€‚

**ğŸ”§ å¼•ç”¨è®¡æ•°å®ç°**
```java
public class FontFlyweight {
    private int referenceCount = 0;
    private final Object lock = new Object();
    
    // å¢åŠ å¼•ç”¨
    public void addReference() {
        synchronized (lock) {
            referenceCount++;
        }
    }
    
    // å‡å°‘å¼•ç”¨
    public void removeReference() {
        synchronized (lock) {
            referenceCount--;
            if (referenceCount < 0) {
                referenceCount = 0; // é˜²æ­¢è®¡æ•°é”™è¯¯
            }
        }
    }
    
    // è·å–å¼•ç”¨æ•°
    public int getReferenceCount() {
        synchronized (lock) {
            return referenceCount;
        }
    }
    
    // æ˜¯å¦å¯ä»¥å›æ”¶
    public boolean canBeRecycled() {
        return getReferenceCount() == 0;
    }
}
```

---

## 2. ğŸ—‘ï¸ ç¼“å­˜æ·˜æ±°ç­–ç•¥è®¾è®¡


### 2.1 ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜æ·˜æ±°


**ğŸ¤” é—®é¢˜èƒŒæ™¯**
äº«å…ƒæ¨¡å¼é€šè¿‡ç¼“å­˜å¯¹è±¡æ¥èŠ‚çœå†…å­˜ï¼Œä½†å¦‚æœç¼“å­˜æ— é™å¢é•¿ï¼Œåè€Œä¼šå¯¼è‡´å†…å­˜ä¸è¶³ã€‚å°±åƒåœè½¦åœºæœ‰é™ï¼Œéœ€è¦æ¸…ç†é•¿æ—¶é—´ä¸ç”¨çš„è½¦ä½ã€‚

**ğŸ“ˆ å†…å­˜ä½¿ç”¨æƒ…å†µå¯¹æ¯”**
```
æ— æ·˜æ±°ç­–ç•¥ï¼š
æ—¶é—´  â†’  0h    2h    4h    6h    8h
ç¼“å­˜  â†’  10    50    120   300   500+  (æŒç»­å¢é•¿)

æœ‰æ·˜æ±°ç­–ç•¥ï¼š
æ—¶é—´  â†’  0h    2h    4h    6h    8h  
ç¼“å­˜  â†’  10    50    80    85    90   (ç¨³å®šæ§åˆ¶)
```

### 2.2 å¸¸ç”¨æ·˜æ±°ç­–ç•¥


**ğŸ”¸ LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç­–ç•¥**

> ğŸ’¡ **æ ¸å¿ƒæ€æƒ³**  
> æ·˜æ±°æœ€é•¿æ—¶é—´æ²¡æœ‰è¢«ä½¿ç”¨çš„äº«å…ƒå¯¹è±¡ï¼Œå°±åƒæ¸…ç†æœ€ä¹…æ²¡å¼€çš„è½¦ã€‚

```java
public class LRUFlyweightCache {
    private final int maxSize;
    private final LinkedHashMap<String, FontFlyweight> cache;
    
    public LRUFlyweightCache(int maxSize) {
        this.maxSize = maxSize;
        this.cache = new LinkedHashMap<String, FontFlyweight>(16, 0.75f, true) {
            @Override
            protected boolean removeEldestEntry(Map.Entry eldest) {
                return size() > maxSize;
            }
        };
    }
    
    public FontFlyweight get(String key) {
        return cache.get(key); // è‡ªåŠ¨æ›´æ–°è®¿é—®é¡ºåº
    }
    
    public void put(String key, FontFlyweight flyweight) {
        cache.put(key, flyweight);
    }
}
```

**ğŸ”¸ å¼•ç”¨è®¡æ•°ç­–ç•¥**

> ğŸ’¡ **æ ¸å¿ƒæ€æƒ³**  
> ä¼˜å…ˆæ·˜æ±°å¼•ç”¨æ¬¡æ•°æœ€å°‘çš„å¯¹è±¡ï¼Œä¿ç•™çƒ­é—¨å¯¹è±¡ã€‚

```java
public class ReferenceFlyweightCache {
    private Map<String, FontFlyweight> cache = new HashMap<>();
    private int maxSize = 100;
    
    public void cleanup() {
        if (cache.size() <= maxSize) return;
        
        // æ‰¾å‡ºå¼•ç”¨æ¬¡æ•°æœ€å°‘çš„å¯¹è±¡
        List<Map.Entry<String, FontFlyweight>> entries = 
            new ArrayList<>(cache.entrySet());
            
        entries.sort((a, b) -> 
            a.getValue().getReferenceCount() - b.getValue().getReferenceCount());
        
        // ç§»é™¤å¼•ç”¨è®¡æ•°ä¸º0çš„å¯¹è±¡
        entries.stream()
            .filter(entry -> entry.getValue().canBeRecycled())
            .limit(cache.size() - maxSize)
            .forEach(entry -> cache.remove(entry.getKey()));
    }
}
```

**ğŸ”¸ æ—¶é—´è¿‡æœŸç­–ç•¥**

> ğŸ’¡ **æ ¸å¿ƒæ€æƒ³**  
> è®¾ç½®äº«å…ƒå¯¹è±¡çš„è¿‡æœŸæ—¶é—´ï¼Œå®šæœŸæ¸…ç†è¿‡æœŸå¯¹è±¡ã€‚

```java
public class TimeBasedFlyweight extends FontFlyweight {
    private long createTime;
    private long ttl; // ç”Ÿå­˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    
    public TimeBasedFlyweight(String fontFamily, int fontSize, long ttl) {
        super(fontFamily, fontSize);
        this.createTime = System.currentTimeMillis();
        this.ttl = ttl;
    }
    
    public boolean isExpired() {
        return System.currentTimeMillis() - createTime > ttl;
    }
}
```

### 2.3 æ·˜æ±°ç­–ç•¥é€‰æ‹©æŒ‡å—


| ä½¿ç”¨åœºæ™¯ | **æ¨èç­–ç•¥** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|---------|-------------|---------|---------|
| ğŸ”¸ **è®¿é—®æ¨¡å¼ç¨³å®š** | `LRUç­–ç•¥` | `ç®€å•é«˜æ•ˆï¼Œå‘½ä¸­ç‡é«˜` | `ä¸è€ƒè™‘å¯¹è±¡é‡è¦æ€§` |
| ğŸ”¸ **å¯¹è±¡é‡è¦æ€§ä¸åŒ** | `å¼•ç”¨è®¡æ•°ç­–ç•¥` | `ä¿ç•™é‡è¦å¯¹è±¡` | `å®ç°å¤æ‚` |
| ğŸ”¸ **æ•°æ®æœ‰æ—¶æ•ˆæ€§** | `æ—¶é—´è¿‡æœŸç­–ç•¥` | `è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®` | `å¯èƒ½è¯¯åˆ æœ‰ç”¨å¯¹è±¡` |
| ğŸ”¸ **å¤æ‚ä¸šåŠ¡åœºæ™¯** | `ç»„åˆç­–ç•¥` | `çµæ´»é€‚åº”å„ç§æƒ…å†µ` | `é…ç½®å¤æ‚` |

---

## 3. ğŸ›¡ï¸ å†…å­˜æ³„æ¼é˜²æŠ¤æœºåˆ¶


### 3.1 å†…å­˜æ³„æ¼çš„å¸¸è§åŸå› 


**ğŸš¨ å…¸å‹å†…å­˜æ³„æ¼åœºæ™¯**

**åœºæ™¯1ï¼šå¿˜è®°é‡Šæ”¾å¼•ç”¨**
```java
// âŒ é”™è¯¯ç¤ºä¾‹
public class TextEditor {
    private FontFlyweight currentFont;
    
    public void changeFont(String family, int size) {
        // è·å–æ–°å­—ä½“ï¼Œä½†å¿˜è®°é‡Šæ”¾æ—§å­—ä½“çš„å¼•ç”¨
        currentFont = FontFactory.getFlyweight(family, size);
        // æ—§çš„currentFontå¼•ç”¨ä¸¢å¤±ï¼Œä½†å¼•ç”¨è®¡æ•°æ²¡æœ‰å‡å°‘
    }
}
```

**åœºæ™¯2ï¼šé™æ€é›†åˆæŒæœ‰å¼•ç”¨**
```java
// âŒ å®¹æ˜“å†…å­˜æ³„æ¼
public class FontCache {
    private static Set<FontFlyweight> allFonts = new HashSet<>();
    
    public static void addFont(FontFlyweight font) {
        allFonts.add(font); // é™æ€é›†åˆæ°¸è¿œä¸ä¼šé‡Šæ”¾å¼•ç”¨
    }
}
```

### 3.2 é˜²æŠ¤æœºåˆ¶è®¾è®¡


**ğŸ”§ è‡ªåŠ¨å¼•ç”¨ç®¡ç†**
```java
public class SafeFontFlyweight {
    private int referenceCount = 0;
    private WeakHashMap<Object, Boolean> holders = new WeakHashMap<>();
    
    // å®‰å…¨çš„å¼•ç”¨è·å–
    public void acquireReference(Object holder) {
        synchronized (this) {
            holders.put(holder, true);
            referenceCount++;
        }
    }
    
    // å®‰å…¨çš„å¼•ç”¨é‡Šæ”¾
    public void releaseReference(Object holder) {
        synchronized (this) {
            if (holders.remove(holder) != null) {
                referenceCount--;
            }
        }
    }
    
    // æ¸…ç†æ— æ•ˆå¼•ç”¨
    public void cleanupWeakReferences() {
        synchronized (this) {
            referenceCount = holders.size(); // é‡æ–°è®¡ç®—çœŸå®å¼•ç”¨æ•°
        }
    }
}
```

**ğŸ”§ èµ„æºè‡ªåŠ¨å›æ”¶**
```java
public class AutoCleanupFlyweight implements AutoCloseable {
    private FontFlyweight flyweight;
    private boolean closed = false;
    
    public AutoCleanupFlyweight(FontFlyweight flyweight) {
        this.flyweight = flyweight;
        flyweight.addReference();
    }
    
    @Override
    public void close() {
        if (!closed) {
            flyweight.removeReference();
            closed = true;
        }
    }
    
    // ä½¿ç”¨finalizeä½œä¸ºå®‰å…¨ç½‘ï¼ˆè™½ç„¶ä¸æ¨èä¾èµ–ï¼‰
    @Override
    protected void finalize() throws Throwable {
        if (!closed) {
            close();
        }
        super.finalize();
    }
}
```

**ğŸ”§ å†…å­˜ç›‘æ§æœºåˆ¶**
```java
public class MemoryMonitor {
    private static final long MEMORY_THRESHOLD = 100 * 1024 * 1024; // 100MB
    
    public static void checkMemoryUsage() {
        Runtime runtime = Runtime.getRuntime();
        long usedMemory = runtime.totalMemory() - runtime.freeMemory();
        
        if (usedMemory > MEMORY_THRESHOLD) {
            // è§¦å‘ç¼“å­˜æ¸…ç†
            FlyweightFactory.getInstance().forceCleanup();
            
            // å»ºè®®åƒåœ¾å›æ”¶
            System.gc();
            
            System.out.println("âš ï¸ å†…å­˜ä½¿ç”¨è¿‡é«˜ï¼Œå·²è§¦å‘æ¸…ç†æœºåˆ¶");
        }
    }
}
```

### 3.3 é˜²æŠ¤æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**
```java
// ä½¿ç”¨try-with-resourcesç¡®ä¿èµ„æºé‡Šæ”¾
try (AutoCleanupFlyweight fontWrapper = new AutoCleanupFlyweight(font)) {
    // ä½¿ç”¨å­—ä½“
    fontWrapper.getFlyweight().render(text, x, y);
} // è‡ªåŠ¨é‡Šæ”¾å¼•ç”¨
```

**âš ï¸ æ³¨æ„äº‹é¡¹æ¸…å•**
- [ ] æ¯æ¬¡è·å–äº«å…ƒå¯¹è±¡åéƒ½è¦è®°å¾—é‡Šæ”¾å¼•ç”¨
- [ ] é¿å…åœ¨é™æ€é›†åˆä¸­é•¿æœŸæŒæœ‰äº«å…ƒå¯¹è±¡
- [ ] å®šæœŸæ£€æŸ¥å¼•ç”¨è®¡æ•°çš„æ­£ç¡®æ€§
- [ ] ä½¿ç”¨WeakReferenceé¿å…æ„å¤–çš„å¼ºå¼•ç”¨
- [ ] å®ç°å†…å­˜ç›‘æ§å’Œè‡ªåŠ¨æ¸…ç†æœºåˆ¶

---

## 4. ğŸ”’ çº¿ç¨‹å®‰å…¨è®¾è®¡æ–¹æ¡ˆ


### 4.1 çº¿ç¨‹å®‰å…¨çš„é‡è¦æ€§


**ğŸ¤” ä¸ºä»€ä¹ˆäº«å…ƒæ¨¡å¼éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨**
äº«å…ƒå¯¹è±¡ä¼šè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œå°±åƒå…¬å…±å›¾ä¹¦é¦†çš„ä¹¦ç±ä¼šè¢«å¤šä¸ªè¯»è€…åŒæ—¶å€Ÿé˜…ã€‚å¦‚æœä¸åšå¥½åè°ƒï¼Œå°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚

**ğŸš¨ çº¿ç¨‹ä¸å®‰å…¨çš„åæœ**
```
çº¿ç¨‹A: åˆ›å»ºå­—ä½“"Arial-12"ï¼Œå¼•ç”¨è®¡æ•°+1
çº¿ç¨‹B: åŒæ—¶åˆ›å»ºå­—ä½“"Arial-12"ï¼Œä¹Ÿåˆ›å»ºäº†æ–°å¯¹è±¡
ç»“æœ: è¿èƒŒäº†äº«å…ƒæ¨¡å¼çš„åˆè¡·ï¼Œåˆ›å»ºäº†é‡å¤å¯¹è±¡
```

### 4.2 å·¥å‚ç±»çº¿ç¨‹å®‰å…¨


**ğŸ”§ åŒé‡æ£€æŸ¥é”å®šå®ç°**
```java
public class ThreadSafeFlyweightFactory {
    private volatile Map<String, FontFlyweight> flyweights = new HashMap<>();
    private final Object lock = new Object();
    
    public FontFlyweight getFlyweight(String fontFamily, int fontSize) {
        String key = fontFamily + "-" + fontSize;
        FontFlyweight flyweight = flyweights.get(key);
        
        if (flyweight == null) {
            synchronized (lock) {
                // åŒé‡æ£€æŸ¥ï¼Œé˜²æ­¢é‡å¤åˆ›å»º
                flyweight = flyweights.get(key);
                if (flyweight == null) {
                    flyweight = new FontFlyweight(fontFamily, fontSize);
                    
                    // åˆ›å»ºæ–°çš„Mapå‰¯æœ¬ï¼ˆå†™æ—¶å¤åˆ¶ï¼‰
                    Map<String, FontFlyweight> newMap = new HashMap<>(flyweights);
                    newMap.put(key, flyweight);
                    flyweights = newMap;
                }
            }
        }
        
        return flyweight;
    }
}
```

**ğŸ”§ ä½¿ç”¨ConcurrentHashMap**
```java
public class ConcurrentFlyweightFactory {
    private final ConcurrentHashMap<String, FontFlyweight> flyweights = 
        new ConcurrentHashMap<>();
    
    public FontFlyweight getFlyweight(String fontFamily, int fontSize) {
        String key = fontFamily + "-" + fontSize;
        
        // ä½¿ç”¨computeIfAbsentç¡®ä¿åŸå­æ€§
        return flyweights.computeIfAbsent(key, k -> {
            System.out.println("çº¿ç¨‹ " + Thread.currentThread().getName() + 
                             " åˆ›å»ºäº«å…ƒ: " + key);
            return new FontFlyweight(fontFamily, fontSize);
        });
    }
}
```

### 4.3 äº«å…ƒå¯¹è±¡çº¿ç¨‹å®‰å…¨


**ğŸ”§ çŠ¶æ€ä¿æŠ¤æœºåˆ¶**
```java
public class ThreadSafeFlyweight {
    private final String fontFamily; // ä¸å¯å˜å†…éƒ¨çŠ¶æ€
    private final int fontSize;      // ä¸å¯å˜å†…éƒ¨çŠ¶æ€
    private final AtomicInteger referenceCount = new AtomicInteger(0);
    
    // ä½¿ç”¨åŸå­æ“ä½œä¿è¯çº¿ç¨‹å®‰å…¨
    public void addReference() {
        referenceCount.incrementAndGet();
    }
    
    public void removeReference() {
        referenceCount.decrementAndGet();
    }
    
    public int getReferenceCount() {
        return referenceCount.get();
    }
    
    // çº¿ç¨‹å®‰å…¨çš„æ“ä½œæ–¹æ³•
    public synchronized void render(String text, int x, int y, Color color) {
        // æ¸²æŸ“é€»è¾‘ï¼Œä½¿ç”¨åŒæ­¥ä¿è¯ä¸€è‡´æ€§
        System.out.println("æ¸²æŸ“æ–‡æœ¬: " + text + " ä½ç½®: (" + x + "," + y + ")");
    }
}
```

### 4.4 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ğŸ“Š ä¸åŒåŒæ­¥ç­–ç•¥çš„æ€§èƒ½å¯¹æ¯”**

| åŒæ­¥ç­–ç•¥ | **æ€§èƒ½** | **å®‰å…¨æ€§** | **å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|-----------|-----------|-------------|
| ğŸ”¸ **synchronizedæ–¹æ³•** | `ä¸­ç­‰` | `é«˜` | `ä½` | `æ“ä½œç®€å•ï¼Œå¹¶å‘ä¸é«˜` |
| ğŸ”¸ **è¯»å†™é”** | `é«˜` | `é«˜` | `ä¸­ç­‰` | `è¯»å¤šå†™å°‘åœºæ™¯` |
| ğŸ”¸ **ConcurrentHashMap** | `å¾ˆé«˜` | `é«˜` | `ä½` | `é«˜å¹¶å‘è®¿é—®` |
| ğŸ”¸ **æ— é”ç®—æ³•** | `æœ€é«˜` | `é«˜` | `å¾ˆé«˜` | `æé«˜æ€§èƒ½è¦æ±‚` |

**ğŸ”§ è¯»å†™é”ä¼˜åŒ–ç¤ºä¾‹**
```java
public class ReadWriteLockFlyweightFactory {
    private final Map<String, FontFlyweight> flyweights = new HashMap<>();
    private final ReadWriteLock lock = new ReentrantReadWriteLock();
    
    public FontFlyweight getFlyweight(String fontFamily, int fontSize) {
        String key = fontFamily + "-" + fontSize;
        
        // å…ˆå°è¯•è¯»é”
        lock.readLock().lock();
        try {
            FontFlyweight flyweight = flyweights.get(key);
            if (flyweight != null) {
                return flyweight;
            }
        } finally {
            lock.readLock().unlock();
        }
        
        // éœ€è¦åˆ›å»ºæ—¶ä½¿ç”¨å†™é”
        lock.writeLock().lock();
        try {
            // å†æ¬¡æ£€æŸ¥ï¼ˆå¯èƒ½å…¶ä»–çº¿ç¨‹å·²åˆ›å»ºï¼‰
            FontFlyweight flyweight = flyweights.get(key);
            if (flyweight == null) {
                flyweight = new FontFlyweight(fontFamily, fontSize);
                flyweights.put(key, flyweight);
            }
            return flyweight;
        } finally {
            lock.writeLock().unlock();
        }
    }
}
```

---

## 5. ğŸ“Š æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜


### 5.1 å…³é”®æ€§èƒ½æŒ‡æ ‡


**ğŸ“ˆ ç›‘æ§æŒ‡æ ‡ä½“ç³»**
```
å†…å­˜æŒ‡æ ‡ï¼š
â”œâ”€â”€ äº«å…ƒå¯¹è±¡æ€»æ•°é‡
â”œâ”€â”€ ç¼“å­˜å‘½ä¸­ç‡
â”œâ”€â”€ å†…å­˜ä½¿ç”¨é‡
â””â”€â”€ GCé¢‘ç‡å’Œè€—æ—¶

æ€§èƒ½æŒ‡æ ‡ï¼š
â”œâ”€â”€ å¯¹è±¡åˆ›å»ºæ—¶é—´
â”œâ”€â”€ ç¼“å­˜æŸ¥æ‰¾æ—¶é—´  
â”œâ”€â”€ å¼•ç”¨æ“ä½œè€—æ—¶
â””â”€â”€ å¹¶å‘è®¿é—®å“åº”æ—¶é—´

ä¸šåŠ¡æŒ‡æ ‡ï¼š
â”œâ”€â”€ å†…å­˜èŠ‚çœæ¯”ä¾‹
â”œâ”€â”€ å“åº”æ—¶é—´æ”¹å–„
â”œâ”€â”€ ååé‡æå‡
â””â”€â”€ ç³»ç»Ÿç¨³å®šæ€§
```

### 5.2 ç›‘æ§å·¥å…·å®ç°


**ğŸ”§ æ€§èƒ½ç›‘æ§å™¨**
```java
public class FlyweightPerformanceMonitor {
    private final AtomicLong cacheHits = new AtomicLong(0);
    private final AtomicLong cacheMisses = new AtomicLong(0);
    private final AtomicLong totalMemoryUsed = new AtomicLong(0);
    private final Map<String, Long> creationTimes = new ConcurrentHashMap<>();
    
    // è®°å½•ç¼“å­˜å‘½ä¸­
    public void recordCacheHit() {
        cacheHits.incrementAndGet();
    }
    
    // è®°å½•ç¼“å­˜æœªå‘½ä¸­
    public void recordCacheMiss() {
        cacheMisses.incrementAndGet();
    }
    
    // è®°å½•å¯¹è±¡åˆ›å»º
    public void recordObjectCreation(String key, int objectSize) {
        creationTimes.put(key, System.currentTimeMillis());
        totalMemoryUsed.addAndGet(objectSize);
    }
    
    // è·å–ç¼“å­˜å‘½ä¸­ç‡
    public double getCacheHitRate() {
        long hits = cacheHits.get();
        long misses = cacheMisses.get();
        long total = hits + misses;
        return total > 0 ? (double) hits / total * 100 : 0;
    }
    
    // ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
    public String generateReport() {
        return String.format(
            "ç¼“å­˜å‘½ä¸­ç‡: %.2f%%\n" +
            "æ€»å‘½ä¸­æ¬¡æ•°: %d\n" +
            "æ€»æœªå‘½ä¸­æ¬¡æ•°: %d\n" +
            "å†…å­˜ä½¿ç”¨é‡: %d KB\n" +
            "äº«å…ƒå¯¹è±¡æ•°é‡: %d",
            getCacheHitRate(),
            cacheHits.get(),
            cacheMisses.get(),
            totalMemoryUsed.get() / 1024,
            creationTimes.size()
        );
    }
}
```

### 5.3 æ€§èƒ½è°ƒä¼˜ç­–ç•¥


**ğŸ”§ åŠ¨æ€è°ƒä¼˜ç®—æ³•**
```java
public class DynamicFlyweightOptimizer {
    private FlyweightPerformanceMonitor monitor;
    private FlyweightFactory factory;
    private int currentCacheSize = 100;
    
    // åŠ¨æ€è°ƒæ•´ç¼“å­˜å¤§å°
    public void optimizeCacheSize() {
        double hitRate = monitor.getCacheHitRate();
        
        if (hitRate < 70.0) {
            // å‘½ä¸­ç‡å¤ªä½ï¼Œå¢åŠ ç¼“å­˜å¤§å°
            currentCacheSize = Math.min(currentCacheSize * 2, 1000);
            factory.setCacheSize(currentCacheSize);
            System.out.println("ğŸ“ˆ å¢åŠ ç¼“å­˜å¤§å°åˆ°: " + currentCacheSize);
            
        } else if (hitRate > 95.0 && getCurrentMemoryUsage() > getMemoryThreshold()) {
            // å‘½ä¸­ç‡å¾ˆé«˜ä½†å†…å­˜ç´§å¼ ï¼Œé€‚å½“å‡å°‘ç¼“å­˜
            currentCacheSize = Math.max(currentCacheSize / 2, 50);
            factory.setCacheSize(currentCacheSize);
            System.out.println("ğŸ“‰ å‡å°‘ç¼“å­˜å¤§å°åˆ°: " + currentCacheSize);
        }
    }
    
    // æ™ºèƒ½æ¸…ç†ç­–ç•¥
    public void smartCleanup() {
        long memoryUsage = getCurrentMemoryUsage();
        long memoryThreshold = getMemoryThreshold();
        
        if (memoryUsage > memoryThreshold * 0.8) {
            // å†…å­˜ä½¿ç”¨è¶…è¿‡80%ï¼Œè§¦å‘æ¸…ç†
            factory.cleanupUnusedFlyweights();
            System.gc(); // å»ºè®®åƒåœ¾å›æ”¶
        }
    }
    
    private long getCurrentMemoryUsage() {
        Runtime runtime = Runtime.getRuntime();
        return runtime.totalMemory() - runtime.freeMemory();
    }
    
    private long getMemoryThreshold() {
        return Runtime.getRuntime().maxMemory();
    }
}
```

### 5.4 æ€§èƒ½æµ‹è¯•æ¡ˆä¾‹


**ğŸ§ª å‹åŠ›æµ‹è¯•ç¤ºä¾‹**
```java
public class FlyweightStressTest {
    public static void main(String[] args) {
        FlyweightFactory factory = new FlyweightFactory();
        FlyweightPerformanceMonitor monitor = new FlyweightPerformanceMonitor();
        
        // å¤šçº¿ç¨‹å‹åŠ›æµ‹è¯•
        int threadCount = 10;
        int operationsPerThread = 1000;
        
        ExecutorService executor = Executors.newFixedThreadPool(threadCount);
        long startTime = System.currentTimeMillis();
        
        for (int i = 0; i < threadCount; i++) {
            executor.submit(() -> {
                Random random = new Random();
                String[] fonts = {"Arial", "Times", "Helvetica", "Courier"};
                int[] sizes = {12, 14, 16, 18, 20};
                
                for (int j = 0; j < operationsPerThread; j++) {
                    String font = fonts[random.nextInt(fonts.length)];
                    int size = sizes[random.nextInt(sizes.length)];
                    
                    FontFlyweight flyweight = factory.getFlyweight(font, size);
                    monitor.recordCacheHit();
                    
                    // æ¨¡æ‹Ÿä½¿ç”¨
                    flyweight.render("æµ‹è¯•æ–‡æœ¬", j, j, Color.BLACK);
                }
            });
        }
        
        executor.shutdown();
        try {
            executor.awaitTermination(1, TimeUnit.MINUTES);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        long endTime = System.currentTimeMillis();
        
        System.out.println("=== å‹åŠ›æµ‹è¯•ç»“æœ ===");
        System.out.println("æµ‹è¯•è€—æ—¶: " + (endTime - startTime) + " ms");
        System.out.println(monitor.generateReport());
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


```
ğŸ”¸ ç”Ÿå‘½å‘¨æœŸç®¡ç†: äº«å…ƒå¯¹è±¡ä»åˆ›å»ºåˆ°é”€æ¯çš„å®Œæ•´æµç¨‹æ§åˆ¶
ğŸ”¸ ç¼“å­˜æ·˜æ±°ç­–ç•¥: LRUã€å¼•ç”¨è®¡æ•°ã€æ—¶é—´è¿‡æœŸç­‰ç­–ç•¥çš„é€‰æ‹©å’Œå®ç°
ğŸ”¸ å†…å­˜æ³„æ¼é˜²æŠ¤: å¼•ç”¨ç®¡ç†ã€è‡ªåŠ¨æ¸…ç†ã€ç›‘æ§é¢„è­¦çš„å®Œæ•´æ–¹æ¡ˆ
ğŸ”¸ çº¿ç¨‹å®‰å…¨è®¾è®¡: å·¥å‚ç±»å’Œäº«å…ƒå¯¹è±¡çš„å¹¶å‘è®¿é—®ä¿æŠ¤
ğŸ”¸ æ€§èƒ½ç›‘æ§è°ƒä¼˜: å…³é”®æŒ‡æ ‡ç›‘æ§å’ŒåŠ¨æ€ä¼˜åŒ–ç­–ç•¥
```

### 6.2 å®è·µåº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä¼˜åŒ–ç­–ç•¥é€‰æ‹©åŸåˆ™**
```
ç³»ç»Ÿè§„æ¨¡å° (< 1ä¸‡å¯¹è±¡):
â†’ ç®€å•å¼•ç”¨è®¡æ•° + åŸºç¡€ç›‘æ§

ç³»ç»Ÿè§„æ¨¡ä¸­ç­‰ (1ä¸‡-10ä¸‡å¯¹è±¡):  
â†’ LRUç¼“å­˜ + æ—¶é—´è¿‡æœŸ + çº¿ç¨‹å®‰å…¨

ç³»ç»Ÿè§„æ¨¡å¤§ (> 10ä¸‡å¯¹è±¡):
â†’ ç»„åˆç­–ç•¥ + åŠ¨æ€è°ƒä¼˜ + å…¨é¢ç›‘æ§
```

**âš ï¸ å¸¸è§è¯¯åŒºä¸æ³¨æ„äº‹é¡¹**
- **è¯¯åŒº1**: è®¤ä¸ºäº«å…ƒå¯¹è±¡æ°¸è¿œä¸éœ€è¦é”€æ¯
- **è¯¯åŒº2**: å¿½ç•¥çº¿ç¨‹å®‰å…¨ï¼Œå¯¼è‡´é‡å¤åˆ›å»ºå¯¹è±¡  
- **è¯¯åŒº3**: è¿‡åº¦ä¼˜åŒ–ï¼Œå¢åŠ ä¸å¿…è¦çš„å¤æ‚æ€§
- **è¯¯åŒº4**: æ²¡æœ‰ç›‘æ§æœºåˆ¶ï¼Œé—®é¢˜å‘ç°å¤ªæ™š

**ğŸš€ æœ€ä½³å®è·µå»ºè®®**
1. **æ¸è¿›å¼ä¼˜åŒ–**: ä»ç®€å•å¼€å§‹ï¼Œæ ¹æ®å®é™…éœ€æ±‚é€æ­¥å®Œå–„
2. **ç›‘æ§å…ˆè¡Œ**: å…ˆå»ºç«‹ç›‘æ§ä½“ç³»ï¼Œå†è¿›è¡Œé’ˆå¯¹æ€§ä¼˜åŒ–
3. **æµ‹è¯•éªŒè¯**: æ¯ä¸ªä¼˜åŒ–éƒ½è¦é€šè¿‡å‹åŠ›æµ‹è¯•éªŒè¯æ•ˆæœ
4. **æ–‡æ¡£è®°å½•**: è¯¦ç»†è®°å½•é…ç½®å‚æ•°å’Œè°ƒä¼˜è¿‡ç¨‹

### 6.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¼ä¸šçº§åº”ç”¨åœºæ™¯**
- **æ¸¸æˆå¼€å‘**: å¤§é‡ç›¸åŒçº¹ç†ã€æ¨¡å‹çš„æ¸²æŸ“ä¼˜åŒ–
- **æ–‡æ¡£ç¼–è¾‘å™¨**: å­—ä½“ã€æ ·å¼ç­‰å¯¹è±¡çš„å†…å­˜ç®¡ç†
- **Webåº”ç”¨**: ç”¨æˆ·ç•Œé¢å…ƒç´ çš„ç¼“å­˜å’Œé‡ç”¨
- **æ•°æ®å¤„ç†**: å¤§æ•°æ®åœºæ™¯ä¸‹çš„å¯¹è±¡æ± ç®¡ç†

**ğŸ“ˆ æ€§èƒ½æå‡æ•ˆæœ**
- **å†…å­˜èŠ‚çœ**: é€šå¸¸å¯èŠ‚çœ60-80%çš„å†…å­˜ä½¿ç”¨
- **åˆ›å»ºæ€§èƒ½**: é¿å…é‡å¤åˆ›å»ºï¼Œæå‡5-10å€æ€§èƒ½
- **ç³»ç»Ÿç¨³å®šæ€§**: å‡å°‘GCå‹åŠ›ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- äº«å…ƒä¼˜åŒ–å¦‚ç®¡å›¾ä¹¦é¦†ï¼Œç”Ÿå‘½å‘¨æœŸè¦ç®¡å¥½
- ç¼“å­˜ç­–ç•¥é€‰æ‹©å‡†ï¼Œå†…å­˜æ³„æ¼é˜²æŠ¤ç‰¢
- çº¿ç¨‹å®‰å…¨æ˜¯åŸºç¡€ï¼Œæ€§èƒ½ç›‘æ§ä¸å¯å°‘
- æ¸è¿›ä¼˜åŒ–æµ‹è¯•éªŒï¼Œä¼ä¸šåº”ç”¨ä»·å€¼é«˜