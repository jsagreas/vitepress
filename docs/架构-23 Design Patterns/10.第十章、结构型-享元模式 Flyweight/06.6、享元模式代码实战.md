---
title: 6ã€äº«å…ƒæ¨¡å¼ä»£ç å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [å®æˆ˜éœ€æ±‚åˆ†æ](#1-å®æˆ˜éœ€æ±‚åˆ†æ)
2. [å®Œæ•´ä»£ç ç¤ºä¾‹](#2-å®Œæ•´ä»£ç ç¤ºä¾‹)
3. [å†…å­˜ä½¿ç”¨å¯¹æ¯”æµ‹è¯•](#3-å†…å­˜ä½¿ç”¨å¯¹æ¯”æµ‹è¯•)
4. [ç¼“å­˜ç­–ç•¥å®ç°](#4-ç¼“å­˜ç­–ç•¥å®ç°)
5. [å¤šçº¿ç¨‹å®‰å…¨æµ‹è¯•](#5-å¤šçº¿ç¨‹å®‰å…¨æµ‹è¯•)
6. [æ€§èƒ½ä¼˜åŒ–å®è·µ](#6-æ€§èƒ½ä¼˜åŒ–å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å®æˆ˜éœ€æ±‚åˆ†æ


### 1.1 åœºæ™¯æè¿°


æƒ³è±¡ä¸€ä¸‹ä½ åœ¨å¼€å‘ä¸€ä¸ª**åœ¨çº¿æ–‡æ¡£ç¼–è¾‘å™¨**ï¼Œç±»ä¼¼äºWordæˆ–Google Docsã€‚æ–‡æ¡£ä¸­æœ‰å¤§é‡çš„æ–‡å­—ï¼Œæ¯ä¸ªå­—ç¬¦éƒ½éœ€è¦æ˜¾ç¤ºä¸åŒçš„æ ¼å¼ã€‚

**ä¼ ç»Ÿåšæ³•çš„é—®é¢˜**ï¼š
```
ä¸€ä¸ªæ–‡æ¡£æœ‰10000ä¸ªå­—ç¬¦
æ¯ä¸ªå­—ç¬¦å¯¹è±¡å­˜å‚¨ï¼šå­—ç¬¦å†…å®¹ã€å­—ä½“ã€å¤§å°ã€é¢œè‰²ã€æ ·å¼
å¦‚æœæ¯ä¸ªå­—ç¬¦éƒ½åˆ›å»ºç‹¬ç«‹å¯¹è±¡ â†’ å†…å­˜æ¶ˆè€—å·¨å¤§ï¼

ä¸¾ä¾‹ï¼š
- å­—ç¬¦'A'å‡ºç°äº†500æ¬¡
- ä¼ ç»Ÿæ–¹å¼ï¼šåˆ›å»º500ä¸ª'A'å¯¹è±¡
- æ¯ä¸ªå¯¹è±¡å ç”¨å†…å­˜ï¼šå‡è®¾100å­—èŠ‚
- æ€»å†…å­˜ï¼š500 Ã— 100 = 50000å­—èŠ‚
```

**äº«å…ƒæ¨¡å¼çš„è§£å†³æ–¹æ¡ˆ**ï¼š
```
æ ¸å¿ƒæ€è·¯ï¼šæŠŠå­—ç¬¦ä¿¡æ¯åˆ†æˆä¸¤éƒ¨åˆ†
å†…éƒ¨çŠ¶æ€ï¼ˆå¯å…±äº«ï¼‰ï¼šå­—ç¬¦å†…å®¹ï¼ˆ'A'ã€'B'ã€'C'...ï¼‰
å¤–éƒ¨çŠ¶æ€ï¼ˆä¸å¯å…±äº«ï¼‰ï¼šä½ç½®ã€å…·ä½“çš„å­—ä½“å¤§å°ç­‰

ç»“æœï¼š
- å­—ç¬¦'A'åªåˆ›å»º1ä¸ªäº«å…ƒå¯¹è±¡
- 500ä¸ªä½ç½®ä¿¡æ¯åˆ†åˆ«å­˜å‚¨
- å¤§å¹…å‡å°‘å†…å­˜ä½¿ç”¨
```

### 1.2 æ ¸å¿ƒæ¦‚å¿µè§£é‡Š


**ğŸ”¸ ä»€ä¹ˆæ˜¯å†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨çŠ¶æ€ï¼Ÿ**

> ğŸ’¡ **ç®€å•ç†è§£**ï¼š
> - **å†…éƒ¨çŠ¶æ€** = å¯ä»¥è¢«å¤šä¸ªå¯¹è±¡å…±äº«çš„ä¿¡æ¯ï¼ˆåƒæ¨¡æ¿ï¼‰
> - **å¤–éƒ¨çŠ¶æ€** = æ¯ä¸ªå¯¹è±¡ç‹¬æœ‰çš„ä¿¡æ¯ï¼ˆåƒä¸ªäººèµ„æ–™ï¼‰

**å®é™…ä¾‹å­**ï¼š
```
æ¯”å¦‚å­¦æ ¡é‡Œçš„æ ¡æœï¼š
å†…éƒ¨çŠ¶æ€ï¼šæ ¡æœçš„æ¬¾å¼ã€é¢œè‰²ã€æè´¨ï¼ˆæ‰€æœ‰å­¦ç”Ÿå…±äº«ï¼‰
å¤–éƒ¨çŠ¶æ€ï¼šæ ¡æœçš„å°ºå¯¸ã€ç©¿æ ¡æœçš„å­¦ç”Ÿå§“åï¼ˆæ¯ä¸ªå­¦ç”Ÿä¸åŒï¼‰

æ–‡æ¡£ç¼–è¾‘å™¨ä¸­ï¼š
å†…éƒ¨çŠ¶æ€ï¼šå­—ç¬¦å†…å®¹ï¼ˆ'A'ã€'B'ç­‰ï¼‰ã€åŸºç¡€å­—ä½“ä¿¡æ¯
å¤–éƒ¨çŠ¶æ€ï¼šå­—ç¬¦åœ¨æ–‡æ¡£ä¸­çš„ä½ç½®ã€å…·ä½“çš„å­—ä½“å¤§å°
```

---

## 2. ğŸ’» å®Œæ•´ä»£ç ç¤ºä¾‹


### 2.1 äº«å…ƒæ¥å£å®šä¹‰


```java
/**
 * äº«å…ƒæ¥å£ - å®šä¹‰äº«å…ƒå¯¹è±¡èƒ½åšä»€ä¹ˆ
 * å°±åƒå®šä¹‰"æ ¡æœ"åº”è¯¥æœ‰ä»€ä¹ˆåŠŸèƒ½
 */
public interface CharacterFlyweight {
    /**
     * æ˜¾ç¤ºå­—ç¬¦
     * @param context å¤–éƒ¨çŠ¶æ€ï¼ˆä½ç½®ã€å¤§å°ç­‰ä¸ªæ€§åŒ–ä¿¡æ¯ï¼‰
     */
    void display(CharacterContext context);
}
```

### 2.2 å¤–éƒ¨çŠ¶æ€å°è£…


```java
/**
 * å¤–éƒ¨çŠ¶æ€ç±» - å­˜å‚¨æ¯ä¸ªå­—ç¬¦ç‹¬æœ‰çš„ä¿¡æ¯
 * å°±åƒæ¯ä¸ªå­¦ç”Ÿçš„"ä¸ªäººæ¡£æ¡ˆ"
 */
public class CharacterContext {
    private int x;          // å­—ç¬¦åœ¨æ–‡æ¡£ä¸­çš„Xåæ ‡
    private int y;          // å­—ç¬¦åœ¨æ–‡æ¡£ä¸­çš„Yåæ ‡
    private int fontSize;   // å­—ä½“å¤§å°
    private String color;   // å­—ä½“é¢œè‰²
    
    public CharacterContext(int x, int y, int fontSize, String color) {
        this.x = x;
        this.y = y;
        this.fontSize = fontSize;
        this.color = color;
    }
    
    // getteræ–¹æ³•
    public int getX() { return x; }
    public int getY() { return y; }
    public int getFontSize() { return fontSize; }
    public String getColor() { return color; }
}
```

### 2.3 å…·ä½“äº«å…ƒå®ç°


```java
/**
 * å…·ä½“äº«å…ƒç±» - å­˜å‚¨å¯å…±äº«çš„å­—ç¬¦ä¿¡æ¯
 * å°±åƒ"æ ¡æœæ¨¡æ¿"ï¼Œæ‰€æœ‰åŒæ ·çš„å­—ç¬¦å…±äº«ä¸€ä¸ªå¯¹è±¡
 */
public class ConcreteCharacterFlyweight implements CharacterFlyweight {
    private char character;  // å†…éƒ¨çŠ¶æ€ï¼šå­—ç¬¦å†…å®¹ï¼ˆå¯å…±äº«ï¼‰
    
    public ConcreteCharacterFlyweight(char character) {
        this.character = character;
        System.out.println("åˆ›å»ºäº«å…ƒå¯¹è±¡ï¼š'" + character + "'");
    }
    
    @Override
    public void display(CharacterContext context) {
        System.out.printf("æ˜¾ç¤ºå­—ç¬¦'%c' ä½ç½®:(%d,%d) å¤§å°:%d é¢œè‰²:%s%n",
            character, 
            context.getX(), 
            context.getY(),
            context.getFontSize(),
            context.getColor());
    }
    
    public char getCharacter() {
        return character;
    }
}
```

### 2.4 äº«å…ƒå·¥å‚å®ç°


```java
/**
 * äº«å…ƒå·¥å‚ - ç®¡ç†å’Œåˆ›å»ºäº«å…ƒå¯¹è±¡
 * å°±åƒ"æ ¡æœä»“åº“"ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰æ ¡æœæ¨¡æ¿
 */
public class CharacterFlyweightFactory {
    // äº«å…ƒæ± ï¼šå­˜å‚¨å·²åˆ›å»ºçš„äº«å…ƒå¯¹è±¡
    private Map<Character, CharacterFlyweight> flyweights = new HashMap<>();
    
    /**
     * è·å–äº«å…ƒå¯¹è±¡ï¼ˆå•ä¾‹æ¨¡å¼çš„æ€æƒ³ï¼‰
     */
    public CharacterFlyweight getFlyweight(char character) {
        CharacterFlyweight flyweight = flyweights.get(character);
        
        if (flyweight == null) {
            // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„äº«å…ƒå¯¹è±¡
            flyweight = new ConcreteCharacterFlyweight(character);
            flyweights.put(character, flyweight);
        } else {
            System.out.println("å¤ç”¨äº«å…ƒå¯¹è±¡ï¼š'" + character + "'");
        }
        
        return flyweight;
    }
    
    /**
     * è·å–äº«å…ƒæ± å¤§å°
     */
    public int getFlyweightCount() {
        return flyweights.size();
    }
    
    /**
     * æ˜¾ç¤ºäº«å…ƒæ± çŠ¶æ€
     */
    public void showFlyweightPool() {
        System.out.println("äº«å…ƒæ± ä¸­çš„å¯¹è±¡ï¼š" + flyweights.keySet());
        System.out.println("äº«å…ƒå¯¹è±¡æ€»æ•°ï¼š" + flyweights.size());
    }
}
```

### 2.5 æ–‡æ¡£ç±»å®ç°


```java
/**
 * æ–‡æ¡£ç±» - ä½¿ç”¨äº«å…ƒæ¨¡å¼çš„å®¢æˆ·ç«¯
 */
public class Document {
    private List<CharacterFlyweight> characters = new ArrayList<>();
    private List<CharacterContext> contexts = new ArrayList<>();
    private CharacterFlyweightFactory factory = new CharacterFlyweightFactory();
    
    /**
     * æ·»åŠ å­—ç¬¦åˆ°æ–‡æ¡£
     */
    public void addCharacter(char ch, int x, int y, int fontSize, String color) {
        // è·å–äº«å…ƒå¯¹è±¡ï¼ˆå¯èƒ½æ˜¯æ–°åˆ›å»ºçš„ï¼Œä¹Ÿå¯èƒ½æ˜¯å¤ç”¨çš„ï¼‰
        CharacterFlyweight flyweight = factory.getFlyweight(ch);
        characters.add(flyweight);
        
        // åˆ›å»ºå¤–éƒ¨çŠ¶æ€
        CharacterContext context = new CharacterContext(x, y, fontSize, color);
        contexts.add(context);
    }
    
    /**
     * æ˜¾ç¤ºæ•´ä¸ªæ–‡æ¡£
     */
    public void display() {
        System.out.println("\n=== æ–‡æ¡£å†…å®¹ ===");
        for (int i = 0; i < characters.size(); i++) {
            characters.get(i).display(contexts.get(i));
        }
    }
    
    /**
     * æ˜¾ç¤ºå†…å­˜ä½¿ç”¨ç»Ÿè®¡
     */
    public void showMemoryStats() {
        System.out.println("\n=== å†…å­˜ä½¿ç”¨ç»Ÿè®¡ ===");
        System.out.println("æ–‡æ¡£ä¸­å­—ç¬¦æ€»æ•°ï¼š" + characters.size());
        factory.showFlyweightPool();
        
        double memoryReduction = (1.0 - (double)factory.getFlyweightCount() / characters.size()) * 100;
        System.out.printf("å†…å­˜èŠ‚çœæ¯”ä¾‹ï¼š%.1f%%\n", memoryReduction);
    }
}
```

---

## 3. ğŸ“Š å†…å­˜ä½¿ç”¨å¯¹æ¯”æµ‹è¯•


### 3.1 æµ‹è¯•ä»£ç 


```java
public class MemoryComparisonTest {
    
    public static void main(String[] args) {
        // æµ‹è¯•1ï¼šäº«å…ƒæ¨¡å¼
        testFlyweightPattern();
        
        System.out.println("\n" + "=".repeat(50) + "\n");
        
        // æµ‹è¯•2ï¼šä¼ ç»Ÿæ¨¡å¼ï¼ˆå¯¹æ¯”ï¼‰
        testTraditionalPattern();
    }
    
    /**
     * äº«å…ƒæ¨¡å¼æµ‹è¯•
     */
    public static void testFlyweightPattern() {
        System.out.println("ğŸš€ äº«å…ƒæ¨¡å¼æµ‹è¯•");
        Document document = new Document();
        
        // æ¨¡æ‹Ÿæ·»åŠ é‡å¤å­—ç¬¦
        String text = "HELLO WORLD! HELLO WORLD! HELLO WORLD!";
        int x = 0, y = 0;
        
        for (char ch : text.toCharArray()) {
            document.addCharacter(ch, x++, y, 12, "black");
        }
        
        document.showMemoryStats();
    }
    
    /**
     * ä¼ ç»Ÿæ¨¡å¼æµ‹è¯•ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
     */
    public static void testTraditionalPattern() {
        System.out.println("âš ï¸ ä¼ ç»Ÿæ¨¡å¼æµ‹è¯•");
        
        String text = "HELLO WORLD! HELLO WORLD! HELLO WORLD!";
        List<TraditionalCharacter> characters = new ArrayList<>();
        
        int x = 0, y = 0;
        for (char ch : text.toCharArray()) {
            // æ¯ä¸ªå­—ç¬¦éƒ½åˆ›å»ºæ–°å¯¹è±¡
            characters.add(new TraditionalCharacter(ch, x++, y, 12, "black"));
        }
        
        System.out.println("å­—ç¬¦å¯¹è±¡æ€»æ•°ï¼š" + characters.size());
        System.out.println("æ¯ä¸ªå­—ç¬¦éƒ½åˆ›å»ºäº†ç‹¬ç«‹å¯¹è±¡ï¼");
        System.out.println("å†…å­˜èŠ‚çœæ¯”ä¾‹ï¼š0%ï¼ˆæ²¡æœ‰å¤ç”¨ï¼‰");
    }
}

/**
 * ä¼ ç»Ÿå­—ç¬¦ç±»ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
 */
class TraditionalCharacter {
    private char character;
    private int x, y, fontSize;
    private String color;
    
    public TraditionalCharacter(char character, int x, int y, int fontSize, String color) {
        this.character = character;
        this.x = x;
        this.y = y;
        this.fontSize = fontSize;
        this.color = color;
        System.out.println("åˆ›å»ºä¼ ç»Ÿå­—ç¬¦å¯¹è±¡ï¼š'" + character + "'");
    }
}
```

### 3.2 æµ‹è¯•ç»“æœåˆ†æ


```
é¢„æœŸè¾“å‡ºç»“æœå¯¹æ¯”ï¼š

äº«å…ƒæ¨¡å¼ï¼š
- åˆ›å»ºäº«å…ƒå¯¹è±¡ï¼š'H'
- å¤ç”¨äº«å…ƒå¯¹è±¡ï¼š'H'
- åˆ›å»ºäº«å…ƒå¯¹è±¡ï¼š'E'
- ...
- äº«å…ƒå¯¹è±¡æ€»æ•°ï¼š10ä¸ªï¼ˆå»é‡åçš„å­—ç¬¦æ•°é‡ï¼‰
- å†…å­˜èŠ‚çœæ¯”ä¾‹ï¼š74.4%

ä¼ ç»Ÿæ¨¡å¼ï¼š
- åˆ›å»ºä¼ ç»Ÿå­—ç¬¦å¯¹è±¡ï¼š'H'
- åˆ›å»ºä¼ ç»Ÿå­—ç¬¦å¯¹è±¡ï¼š'E'
- åˆ›å»ºä¼ ç»Ÿå­—ç¬¦å¯¹è±¡ï¼š'L'
- åˆ›å»ºä¼ ç»Ÿå­—ç¬¦å¯¹è±¡ï¼š'L'  â† é‡å¤åˆ›å»º
- ...
- å­—ç¬¦å¯¹è±¡æ€»æ•°ï¼š39ä¸ªï¼ˆæ¯ä¸ªå­—ç¬¦éƒ½åˆ›å»ºå¯¹è±¡ï¼‰
- å†…å­˜èŠ‚çœæ¯”ä¾‹ï¼š0%
```

**ğŸ“ˆ å†…å­˜èŠ‚çœæ•ˆæœ**ï¼š

| æ–¹å¼ | **å¯¹è±¡æ•°é‡** | **å†…å­˜ä½¿ç”¨** | **èŠ‚çœæ¯”ä¾‹** |
|------|-------------|-------------|-------------|
| ä¼ ç»Ÿæ¨¡å¼ | 39ä¸ªå¯¹è±¡ | 100% | 0% |
| äº«å…ƒæ¨¡å¼ | 10ä¸ªäº«å…ƒå¯¹è±¡ | 25.6% | 74.4% |

---

## 4. ğŸ”„ ç¼“å­˜ç­–ç•¥å®ç°


### 4.1 LRUç¼“å­˜ç­–ç•¥


å½“äº«å…ƒå¯¹è±¡è¿‡å¤šæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨**LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç¼“å­˜ç­–ç•¥**æ¥æ§åˆ¶å†…å­˜ã€‚

```java
/**
 * å¸¦LRUç¼“å­˜çš„äº«å…ƒå·¥å‚
 * LRU = Least Recently Usedï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰
 */
public class LRUCharacterFlyweightFactory {
    private final int maxSize;  // æœ€å¤§ç¼“å­˜å¤§å°
    private final LinkedHashMap<Character, CharacterFlyweight> flyweights;
    
    public LRUCharacterFlyweightFactory(int maxSize) {
        this.maxSize = maxSize;
        // LinkedHashMapæ”¯æŒè®¿é—®é¡ºåºæ’åº
        this.flyweights = new LinkedHashMap<Character, CharacterFlyweight>(16, 0.75f, true) {
            @Override
            protected boolean removeEldestEntry(Map.Entry<Character, CharacterFlyweight> eldest) {
                return size() > maxSize;  // è¶…è¿‡æœ€å¤§å¤§å°æ—¶ç§»é™¤æœ€è€çš„å…ƒç´ 
            }
        };
    }
    
    public CharacterFlyweight getFlyweight(char character) {
        CharacterFlyweight flyweight = flyweights.get(character);
        
        if (flyweight == null) {
            if (flyweights.size() >= maxSize) {
                System.out.println("ç¼“å­˜å·²æ»¡ï¼Œå°†ç§»é™¤æœ€å°‘ä½¿ç”¨çš„äº«å…ƒå¯¹è±¡");
            }
            
            flyweight = new ConcreteCharacterFlyweight(character);
            flyweights.put(character, flyweight);
            System.out.println("åˆ›å»ºå¹¶ç¼“å­˜äº«å…ƒå¯¹è±¡ï¼š'" + character + "'");
        } else {
            System.out.println("ä»ç¼“å­˜è·å–äº«å…ƒå¯¹è±¡ï¼š'" + character + "'");
        }
        
        return flyweight;
    }
    
    public void showCacheStatus() {
        System.out.println("ç¼“å­˜çŠ¶æ€ï¼š" + flyweights.keySet());
        System.out.println("ç¼“å­˜å¤§å°ï¼š" + flyweights.size() + "/" + maxSize);
    }
}
```

### 4.2 ç¼“å­˜æµ‹è¯•


```java
public class CacheTest {
    public static void main(String[] args) {
        // åˆ›å»ºæœ€å¤§å®¹é‡ä¸º5çš„LRUç¼“å­˜
        LRUCharacterFlyweightFactory factory = new LRUCharacterFlyweightFactory(5);
        
        // æ·»åŠ å­—ç¬¦ï¼Œè§‚å¯Ÿç¼“å­˜è¡Œä¸º
        char[] chars = {'A', 'B', 'C', 'D', 'E', 'F', 'G'};
        
        System.out.println("=== æ·»åŠ å­—ç¬¦åˆ°ç¼“å­˜ ===");
        for (char ch : chars) {
            factory.getFlyweight(ch);
            factory.showCacheStatus();
            System.out.println();
        }
        
        System.out.println("=== é‡å¤è®¿é—®å­—ç¬¦ ===");
        factory.getFlyweight('A');  // è¿™ä¼šè®©Aé‡æ–°æˆä¸ºæœ€è¿‘ä½¿ç”¨çš„
        factory.showCacheStatus();
    }
}
```

---

## 5. ğŸ”’ å¤šçº¿ç¨‹å®‰å…¨æµ‹è¯•


### 5.1 çº¿ç¨‹å®‰å…¨çš„äº«å…ƒå·¥å‚


```java
/**
 * çº¿ç¨‹å®‰å…¨çš„äº«å…ƒå·¥å‚
 */
public class ThreadSafeCharacterFlyweightFactory {
    // ä½¿ç”¨ConcurrentHashMapä¿è¯çº¿ç¨‹å®‰å…¨
    private final ConcurrentHashMap<Character, CharacterFlyweight> flyweights = new ConcurrentHashMap<>();
    
    public CharacterFlyweight getFlyweight(char character) {
        // computeIfAbsentæ–¹æ³•æ˜¯åŸå­æ“ä½œï¼Œä¿è¯çº¿ç¨‹å®‰å…¨
        return flyweights.computeIfAbsent(character, key -> {
            System.out.println("çº¿ç¨‹ " + Thread.currentThread().getName() + " åˆ›å»ºäº«å…ƒï¼š'" + key + "'");
            return new ConcreteCharacterFlyweight(key);
        });
    }
    
    public int getFlyweightCount() {
        return flyweights.size();
    }
    
    public void showStats() {
        System.out.println("äº«å…ƒå¯¹è±¡æ•°é‡ï¼š" + flyweights.size());
        System.out.println("äº«å…ƒå¯¹è±¡ï¼š" + flyweights.keySet());
    }
}
```

### 5.2 å¤šçº¿ç¨‹æµ‹è¯•


```java
public class MultiThreadTest {
    public static void main(String[] args) throws InterruptedException {
        ThreadSafeCharacterFlyweightFactory factory = new ThreadSafeCharacterFlyweightFactory();
        
        // åˆ›å»ºå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®äº«å…ƒå·¥å‚
        ExecutorService executor = Executors.newFixedThreadPool(5);
        CountDownLatch latch = new CountDownLatch(5);
        
        for (int i = 0; i < 5; i++) {
            final int threadId = i;
            executor.submit(() -> {
                try {
                    // æ¯ä¸ªçº¿ç¨‹åˆ›å»ºç›¸åŒçš„å­—ç¬¦
                    for (char ch = 'A'; ch <= 'E'; ch++) {
                        CharacterFlyweight flyweight = factory.getFlyweight(ch);
                        Thread.sleep(10); // æ¨¡æ‹Ÿä¸€äº›å¤„ç†æ—¶é—´
                    }
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                } finally {
                    latch.countDown();
                }
            });
        }
        
        latch.await(); // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
        executor.shutdown();
        
        System.out.println("\n=== å¤šçº¿ç¨‹æµ‹è¯•ç»“æœ ===");
        factory.showStats();
        System.out.println("é¢„æœŸï¼šæ¯ä¸ªå­—ç¬¦åªåˆ›å»ºä¸€æ¬¡ï¼Œæ€»å…±5ä¸ªäº«å…ƒå¯¹è±¡");
    }
}
```

---

## 6. âš¡ æ€§èƒ½ä¼˜åŒ–å®è·µ


### 6.1 å†…å­˜å ç”¨ä¼˜åŒ–


**ğŸ”¸ ä¼˜åŒ–ç­–ç•¥1ï¼šä½¿ç”¨åŸºæœ¬ç±»å‹**

```java
/**
 * ä¼˜åŒ–çš„äº«å…ƒç±» - å‡å°‘å¯¹è±¡åŒ…è£…
 */
public class OptimizedCharacterFlyweight implements CharacterFlyweight {
    private final char character;  // ä½¿ç”¨åŸºæœ¬ç±»å‹è€Œä¸æ˜¯CharacteråŒ…è£…ç±»
    
    public OptimizedCharacterFlyweight(char character) {
        this.character = character;
    }
    
    @Override
    public void display(CharacterContext context) {
        // ä¼˜åŒ–ï¼šå‡å°‘å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œä½¿ç”¨StringBuilder
        StringBuilder sb = new StringBuilder(50);
        sb.append("å­—ç¬¦'").append(character)
          .append("' ä½ç½®:(").append(context.getX()).append(",").append(context.getY())
          .append(") å¤§å°:").append(context.getFontSize())
          .append(" é¢œè‰²:").append(context.getColor());
        System.out.println(sb.toString());
    }
}
```

**ğŸ”¸ ä¼˜åŒ–ç­–ç•¥2ï¼šå¯¹è±¡æ± å¤ç”¨**

```java
/**
 * å¤–éƒ¨çŠ¶æ€å¯¹è±¡æ±  - å¤ç”¨Contextå¯¹è±¡
 */
public class CharacterContextPool {
    private final Queue<CharacterContext> pool = new ArrayDeque<>();
    private final int maxPoolSize;
    
    public CharacterContextPool(int maxPoolSize) {
        this.maxPoolSize = maxPoolSize;
    }
    
    /**
     * è·å–Contextå¯¹è±¡ï¼ˆä¼˜å…ˆä»æ± ä¸­è·å–ï¼‰
     */
    public CharacterContext getContext(int x, int y, int fontSize, String color) {
        CharacterContext context = pool.poll();
        if (context == null) {
            context = new CharacterContext(x, y, fontSize, color);
        } else {
            // é‡ç½®å¯¹è±¡çŠ¶æ€
            context.reset(x, y, fontSize, color);
        }
        return context;
    }
    
    /**
     * å½’è¿˜Contextå¯¹è±¡åˆ°æ± ä¸­
     */
    public void returnContext(CharacterContext context) {
        if (pool.size() < maxPoolSize) {
            pool.offer(context);
        }
    }
}
```

### 6.2 æ€§èƒ½åŸºå‡†æµ‹è¯•


```java
public class PerformanceBenchmark {
    
    public static void main(String[] args) {
        System.out.println("=== æ€§èƒ½åŸºå‡†æµ‹è¯• ===");
        
        // æµ‹è¯•æ•°æ®
        int testSize = 100000;  // 10ä¸‡ä¸ªå­—ç¬¦
        String testData = generateTestData(testSize);
        
        // æµ‹è¯•1ï¼šäº«å…ƒæ¨¡å¼
        long flyweightTime = testFlyweightPerformance(testData);
        
        // æµ‹è¯•2ï¼šä¼ ç»Ÿæ¨¡å¼
        long traditionalTime = testTraditionalPerformance(testData);
        
        // ç»“æœå¯¹æ¯”
        printPerformanceResults(flyweightTime, traditionalTime, testSize);
    }
    
    private static String generateTestData(int size) {
        StringBuilder sb = new StringBuilder(size);
        Random random = new Random();
        for (int i = 0; i < size; i++) {
            // ç”ŸæˆA-Zçš„éšæœºå­—ç¬¦
            sb.append((char)('A' + random.nextInt(26)));
        }
        return sb.toString();
    }
    
    private static long testFlyweightPerformance(String data) {
        System.out.println("æµ‹è¯•äº«å…ƒæ¨¡å¼æ€§èƒ½...");
        long startTime = System.currentTimeMillis();
        
        Document document = new Document();
        for (int i = 0; i < data.length(); i++) {
            document.addCharacter(data.charAt(i), i, 0, 12, "black");
        }
        
        long endTime = System.currentTimeMillis();
        return endTime - startTime;
    }
    
    private static long testTraditionalPerformance(String data) {
        System.out.println("æµ‹è¯•ä¼ ç»Ÿæ¨¡å¼æ€§èƒ½...");
        long startTime = System.currentTimeMillis();
        
        List<TraditionalCharacter> characters = new ArrayList<>();
        for (int i = 0; i < data.length(); i++) {
            characters.add(new TraditionalCharacter(data.charAt(i), i, 0, 12, "black"));
        }
        
        long endTime = System.currentTimeMillis();
        return endTime - startTime;
    }
    
    private static void printPerformanceResults(long flyweightTime, long traditionalTime, int testSize) {
        System.out.println("\n" + "=".repeat(50));
        System.out.println("ğŸ“Š æ€§èƒ½æµ‹è¯•ç»“æœ");
        System.out.println("=".repeat(50));
        System.out.printf("æµ‹è¯•æ•°æ®é‡ï¼š%,d ä¸ªå­—ç¬¦\n", testSize);
        System.out.printf("äº«å…ƒæ¨¡å¼è€—æ—¶ï¼š%d ms\n", flyweightTime);
        System.out.printf("ä¼ ç»Ÿæ¨¡å¼è€—æ—¶ï¼š%d ms\n", traditionalTime);
        
        if (traditionalTime > 0) {
            double improvement = ((double)(traditionalTime - flyweightTime) / traditionalTime) * 100;
            System.out.printf("æ€§èƒ½æå‡ï¼š%.1f%%\n", improvement);
        }
        
        System.out.println("=".repeat(50));
    }
}
```

### 6.3 å†…å­˜ç›‘æ§å·¥å…·


```java
/**
 * å†…å­˜ä½¿ç”¨ç›‘æ§å·¥å…·
 */
public class MemoryMonitor {
    
    public static void printMemoryUsage(String phase) {
        Runtime runtime = Runtime.getRuntime();
        long totalMemory = runtime.totalMemory();
        long freeMemory = runtime.freeMemory();
        long usedMemory = totalMemory - freeMemory;
        
        System.out.printf("=== %s å†…å­˜ä½¿ç”¨æƒ…å†µ ===\n", phase);
        System.out.printf("å·²ä½¿ç”¨å†…å­˜ï¼š%,.2f MB\n", usedMemory / 1024.0 / 1024.0);
        System.out.printf("ç©ºé—²å†…å­˜ï¼š%,.2f MB\n", freeMemory / 1024.0 / 1024.0);
        System.out.printf("æ€»å†…å­˜ï¼š%,.2f MB\n", totalMemory / 1024.0 / 1024.0);
        System.out.println();
    }
    
    public static void forceGC() {
        System.gc();
        try {
            Thread.sleep(100); // ç»™GCä¸€äº›æ—¶é—´
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 äº«å…ƒæ¨¡å¼çš„æœ¬è´¨ç†è§£


**ğŸ”¸ æ ¸å¿ƒæ€æƒ³**
```
äº«å…ƒæ¨¡å¼ = å¯¹è±¡å¤ç”¨ + çŠ¶æ€åˆ†ç¦»
ç›®æ ‡ï¼šç”¨æœ€å°‘çš„å¯¹è±¡æ”¯æŒæœ€å¤šçš„åŠŸèƒ½
æ‰‹æ®µï¼šæŠŠå¯¹è±¡ä¿¡æ¯åˆ†æˆ"å…±äº«"å’Œ"ç‹¬æœ‰"ä¸¤éƒ¨åˆ†
```

**ğŸ”¸ ç®€å•è®°å¿†æ³•**
> æŠŠäº«å…ƒæ¨¡å¼æƒ³è±¡æˆ**å…±äº«å•è½¦**ï¼š
> - **è½¦çš„å‹å·**ï¼ˆå†…éƒ¨çŠ¶æ€ï¼‰ï¼šæ‰€æœ‰åŒå‹å·è½¦éƒ½ä¸€æ ·ï¼Œå¯ä»¥å…±äº«
> - **è½¦çš„ä½ç½®**ï¼ˆå¤–éƒ¨çŠ¶æ€ï¼‰ï¼šæ¯è¾†è½¦ä½ç½®ä¸åŒï¼Œä¸èƒ½å…±äº«
> - **èŠ‚çœæˆæœ¬**ï¼šä¸ç”¨ä¸ºæ¯ä¸ªä½ç½®éƒ½é€ ä¸€è¾†æ–°è½¦

### 7.2 ä½¿ç”¨åœºæ™¯åˆ¤æ–­


**âœ… é€‚åˆä½¿ç”¨äº«å…ƒæ¨¡å¼çš„æƒ…å†µ**ï¼š
- ç³»ç»Ÿä¸­å­˜åœ¨å¤§é‡ç›¸ä¼¼å¯¹è±¡
- è¿™äº›å¯¹è±¡çš„éƒ¨åˆ†çŠ¶æ€å¯ä»¥å…±äº«
- å†…å­˜ä½¿ç”¨æ˜¯æ€§èƒ½ç“¶é¢ˆ
- å¯¹è±¡åˆ›å»ºæˆæœ¬è¾ƒé«˜

**âŒ ä¸é€‚åˆä½¿ç”¨çš„æƒ…å†µ**ï¼š
- å¯¹è±¡æ•°é‡ä¸å¤šï¼ˆ< 1000ä¸ªï¼‰
- å¯¹è±¡çŠ¶æ€å˜åŒ–é¢‘ç¹
- å…±äº«çŠ¶æ€å¾ˆå°‘æˆ–æ²¡æœ‰
- ç³»ç»Ÿå†…å­˜å……è¶³

### 7.3 å®ç°è¦ç‚¹


**ğŸ”¸ è®¾è®¡åŸåˆ™**ï¼š
1. **çŠ¶æ€åˆ†ç¦»**ï¼šæ˜ç¡®åŒºåˆ†å†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨çŠ¶æ€
2. **å·¥å‚ç®¡ç†**ï¼šä½¿ç”¨å·¥å‚æ¨¡å¼ç®¡ç†äº«å…ƒå¯¹è±¡
3. **çº¿ç¨‹å®‰å…¨**ï¼šå¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ³¨æ„å¹¶å‘å®‰å…¨
4. **å†…å­˜æ§åˆ¶**ï¼šè€ƒè™‘ä½¿ç”¨ç¼“å­˜ç­–ç•¥æ§åˆ¶å†…å­˜

**ğŸ”¸ å¸¸è§é™·é˜±**ï¼š
- çŠ¶æ€åˆ†ç¦»ä¸æ¸…æ™°ï¼Œå¯¼è‡´æ— æ³•æœ‰æ•ˆå…±äº«
- å¿˜è®°è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜
- å¤–éƒ¨çŠ¶æ€ç®¡ç†å¤æ‚ï¼Œå¢åŠ ç»´æŠ¤æˆæœ¬
- è¿‡åº¦ä½¿ç”¨å¯¼è‡´ä»£ç å¤æ‚åº¦å¢åŠ 

### 7.4 æ€§èƒ½æ”¶ç›Š


**ğŸ“Š å®é™…æ•ˆæœè¯„ä¼°**ï¼š

| åœºæ™¯ | **å¯¹è±¡å‡å°‘** | **å†…å­˜èŠ‚çœ** | **æ€§èƒ½æå‡** |
|------|-------------|-------------|-------------|
| æ–‡æœ¬ç¼–è¾‘å™¨ | 70-90% | 60-80% | æ˜¾è‘— |
| æ¸¸æˆå¯¹è±¡ | 50-70% | 40-60% | ä¸­ç­‰ |
| å›¾å½¢æ¸²æŸ“ | 80-95% | 70-90% | æ˜¾è‘— |

**ğŸ¯ æœ€ä½³å®è·µ**ï¼š
- åœ¨è®¾è®¡é˜¶æ®µå°±è€ƒè™‘çŠ¶æ€åˆ†ç¦»
- ä½¿ç”¨å¯¹è±¡æ± è¿›ä¸€æ­¥ä¼˜åŒ–å¤–éƒ¨çŠ¶æ€
- ç»“åˆç¼“å­˜ç­–ç•¥æ§åˆ¶å†…å­˜ä½¿ç”¨
- å®šæœŸç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
- ç¼–å†™æ€§èƒ½æµ‹è¯•éªŒè¯ä¼˜åŒ–æ•ˆæœ

**æ ¸å¿ƒè®°å¿†**ï¼š
- äº«å…ƒæ¨¡å¼æ ¸å¿ƒæ˜¯"çŠ¶æ€åˆ†ç¦»+å¯¹è±¡å¤ç”¨"
- å†…éƒ¨çŠ¶æ€å…±äº«ï¼Œå¤–éƒ¨çŠ¶æ€ç‹¬ç«‹
- å¤§é‡ç›¸ä¼¼å¯¹è±¡æ—¶è€ƒè™‘ä½¿ç”¨
- ç”¨å·¥å‚ç®¡ç†ï¼Œæ³¨æ„çº¿ç¨‹å®‰å…¨
- æ€§èƒ½æå‡æ˜¾è‘—ï¼Œä½†è¦åˆç†ä½¿ç”¨