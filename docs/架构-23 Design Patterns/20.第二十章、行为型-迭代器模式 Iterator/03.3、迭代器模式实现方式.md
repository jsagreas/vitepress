---
title: 3ã€è¿­ä»£å™¨æ¨¡å¼å®ç°æ–¹å¼
---
## ğŸ“š ç›®å½•

1. [è¿­ä»£å™¨å®ç°æ¦‚è¿°](#1-è¿­ä»£å™¨å®ç°æ¦‚è¿°)
2. [å†…éƒ¨è¿­ä»£å™¨å®ç°](#2-å†…éƒ¨è¿­ä»£å™¨å®ç°)
3. [å¤–éƒ¨è¿­ä»£å™¨å®ç°](#3-å¤–éƒ¨è¿­ä»£å™¨å®ç°)
4. [åŒå‘è¿­ä»£å™¨è®¾è®¡](#4-åŒå‘è¿­ä»£å™¨è®¾è®¡)
5. [éšæœºè®¿é—®è¿­ä»£å™¨](#5-éšæœºè®¿é—®è¿­ä»£å™¨)
6. [å¹¶å‘å®‰å…¨è¿­ä»£å™¨](#6-å¹¶å‘å®‰å…¨è¿­ä»£å™¨)
7. [å®ç°æ–¹å¼å¯¹æ¯”](#7-å®ç°æ–¹å¼å¯¹æ¯”)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è¿­ä»£å™¨å®ç°æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯è¿­ä»£å™¨å®ç°æ–¹å¼


**é€šä¿—ç†è§£**ï¼šå°±åƒé¥æ§å™¨æœ‰ä¸åŒçš„æ“æ§æ–¹å¼ä¸€æ ·ï¼Œè¿­ä»£å™¨ä¹Ÿæœ‰ä¸åŒçš„å®ç°æ–¹æ³•

```
ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
ç”µè§†é¥æ§å™¨ â†’ ä½ ä¸»åŠ¨æŒ‰æŒ‰é’®æ§åˆ¶
æ™ºèƒ½éŸ³ç®± â†’ ä½ è¯´è¯ï¼Œå®ƒè‡ªåŠ¨æ‰§è¡Œ

è¿­ä»£å™¨ä¹Ÿç±»ä¼¼ï¼š
å¤–éƒ¨è¿­ä»£å™¨ â†’ ä½ ä¸»åŠ¨æ§åˆ¶éå†è¿‡ç¨‹
å†…éƒ¨è¿­ä»£å™¨ â†’ ä½ æä¾›æ“ä½œï¼Œå®ƒè‡ªåŠ¨éå†
```

### 1.2 è¿­ä»£å™¨å®ç°çš„åˆ†ç±»


**ğŸ”¸ æŒ‰æ§åˆ¶æƒåˆ†ç±»**
```
å†…éƒ¨è¿­ä»£å™¨ï¼ˆInternal Iteratorï¼‰ï¼š
â€¢ é›†åˆæ§åˆ¶éå†è¿‡ç¨‹
â€¢ å®¢æˆ·ç«¯æä¾›å¤„ç†é€»è¾‘
â€¢ ç±»ä¼¼ï¼šä½ å‘Šè¯‰å¸æœºç›®çš„åœ°ï¼Œå¸æœºè´Ÿè´£å¼€è½¦

å¤–éƒ¨è¿­ä»£å™¨ï¼ˆExternal Iteratorï¼‰ï¼š
â€¢ å®¢æˆ·ç«¯æ§åˆ¶éå†è¿‡ç¨‹  
â€¢ é›†åˆæä¾›è®¿é—®æ¥å£
â€¢ ç±»ä¼¼ï¼šä½ è‡ªå·±å¼€è½¦ï¼Œæƒ³åœå°±åœï¼Œæƒ³èµ°å°±èµ°
```

**ğŸ”¸ æŒ‰åŠŸèƒ½èƒ½åŠ›åˆ†ç±»**
```
å•å‘è¿­ä»£å™¨ï¼šåªèƒ½å¾€å‰èµ° â†’
åŒå‘è¿­ä»£å™¨ï¼šèƒ½å‰è¿›ä¹Ÿèƒ½åé€€ â† â†’
éšæœºè®¿é—®è¿­ä»£å™¨ï¼šæƒ³è·³åˆ°å“ªå°±è·³åˆ°å“ª â†•
```

### 1.3 å®ç°æ–¹å¼é€‰æ‹©åŸåˆ™


| åœºæ™¯éœ€æ±‚ | **æ¨èå®ç°** | **åŸå› è¯´æ˜** |
|---------|------------|-------------|
| ğŸ”„ **ç®€å•éå†å¤„ç†** | `å†…éƒ¨è¿­ä»£å™¨` | `ä»£ç ç®€æ´ï¼Œæ˜“äºä½¿ç”¨` |
| ğŸ¯ **ç²¾ç¡®æ§åˆ¶éå†** | `å¤–éƒ¨è¿­ä»£å™¨` | `çµæ´»æ€§é«˜ï¼Œå¯ä¸­æ–­` |
| ğŸ“Š **æ•°æ®åˆ†æç»Ÿè®¡** | `å†…éƒ¨è¿­ä»£å™¨` | `å‡½æ•°å¼ç¼–ç¨‹å‹å¥½` |
| ğŸ” **æ¡ä»¶æŸ¥æ‰¾æœç´¢** | `å¤–éƒ¨è¿­ä»£å™¨` | `å¯æå‰ç»ˆæ­¢éå†` |
| ğŸ“ **å¤æ‚ä¸šåŠ¡é€»è¾‘** | `å¤–éƒ¨è¿­ä»£å™¨` | `æ§åˆ¶æµç¨‹æ›´çµæ´»` |

---

## 2. ğŸ  å†…éƒ¨è¿­ä»£å™¨å®ç°


### 2.1 å†…éƒ¨è¿­ä»£å™¨æ ¸å¿ƒæ¦‚å¿µ


**æœ¬è´¨ç†è§£**ï¼šå†…éƒ¨è¿­ä»£å™¨å°±åƒæ˜¯"åŒ…åŠå‹æœåŠ¡"

```
é¤å…ç”¨é¤çš„æ¯”å–»ï¼š
å¥—é¤æœåŠ¡ = å†…éƒ¨è¿­ä»£å™¨
â€¢ ä½ ï¼šç‚¹ä¸€ä¸ªå¥—é¤ï¼ˆæä¾›å¤„ç†å‡½æ•°ï¼‰
â€¢ é¤å…ï¼šæŒ‰é¡ºåºä¸Šèœï¼ˆè‡ªåŠ¨éå†ï¼‰
â€¢ ç»“æœï¼šä½ åªéœ€è¦åƒï¼Œä¸ç”¨ç®¡ä¸Šèœé¡ºåº

ç‚¹èœæœåŠ¡ = å¤–éƒ¨è¿­ä»£å™¨  
â€¢ ä½ ï¼šä¸»åŠ¨ç‚¹æ¯é“èœï¼ˆä¸»åŠ¨æ§åˆ¶ï¼‰
â€¢ é¤å…ï¼šç­‰ä½ çš„æŒ‡ä»¤ï¼ˆæä¾›è®¿é—®æ¥å£ï¼‰
â€¢ ç»“æœï¼šä½ å®Œå…¨æ§åˆ¶ç”¨é¤èŠ‚å¥
```

### 2.2 å†…éƒ¨è¿­ä»£å™¨åŸºç¡€å®ç°


```java
// ç®€å•çš„å†…éƒ¨è¿­ä»£å™¨å®ç°
public class BookShelf {
    private List<String> books = new ArrayList<>();
    
    public void addBook(String book) {
        books.add(book);
    }
    
    // å†…éƒ¨è¿­ä»£å™¨ï¼šforEachæ–¹æ³•
    public void forEach(Consumer<String> action) {
        for (String book : books) {
            action.accept(book);  // å¯¹æ¯æœ¬ä¹¦æ‰§è¡Œæ“ä½œ
        }
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    public static void main(String[] args) {
        BookShelf shelf = new BookShelf();
        shelf.addBook("Javaç¼–ç¨‹æ€æƒ³");
        shelf.addBook("è®¾è®¡æ¨¡å¼");
        
        // å†…éƒ¨è¿­ä»£å™¨ä½¿ç”¨ - æ‰“å°æ‰€æœ‰ä¹¦ç±
        shelf.forEach(book -> System.out.println("ä¹¦å: " + book));
        
        // å†…éƒ¨è¿­ä»£å™¨ä½¿ç”¨ - ç»Ÿè®¡ä¹¦ç±æ•°é‡
        AtomicInteger count = new AtomicInteger(0);
        shelf.forEach(book -> count.incrementAndGet());
        System.out.println("æ€»å…±æœ‰: " + count.get() + " æœ¬ä¹¦");
    }
}
```

### 2.3 é«˜çº§å†…éƒ¨è¿­ä»£å™¨å®ç°


```java
// åŠŸèƒ½ä¸°å¯Œçš„å†…éƒ¨è¿­ä»£å™¨
public class SmartBookShelf {
    private List<Book> books = new ArrayList<>();
    
    // åŸºç¡€éå†
    public void forEach(Consumer<Book> action) {
        books.forEach(action);
    }
    
    // æ¡ä»¶éå†
    public void forEachIf(Predicate<Book> condition, Consumer<Book> action) {
        books.stream()
             .filter(condition)
             .forEach(action);
    }
    
    // å¸¦ç´¢å¼•éå†
    public void forEachWithIndex(BiConsumer<Integer, Book> action) {
        for (int i = 0; i < books.size(); i++) {
            action.accept(i, books.get(i));
        }
    }
    
    // æ˜ å°„éå†
    public <R> List<R> map(Function<Book, R> mapper) {
        return books.stream()
                   .map(mapper)
                   .collect(Collectors.toList());
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public class InternalIteratorDemo {
    public static void main(String[] args) {
        SmartBookShelf shelf = new SmartBookShelf();
        
        // æ¡ä»¶éå†ï¼šåªå¤„ç†Javaç›¸å…³ä¹¦ç±
        shelf.forEachIf(
            book -> book.getTitle().contains("Java"),
            book -> System.out.println("Javaä¹¦ç±: " + book.getTitle())
        );
        
        // å¸¦ç´¢å¼•éå†ï¼šæ˜¾ç¤ºä¹¦ç±ç¼–å·
        shelf.forEachWithIndex((index, book) -> 
            System.out.println((index + 1) + ". " + book.getTitle())
        );
        
        // æ˜ å°„éå†ï¼šè·å–æ‰€æœ‰ä¹¦å
        List<String> titles = shelf.map(Book::getTitle);
    }
}
```

### 2.4 å†…éƒ¨è¿­ä»£å™¨çš„ä¼˜ç¼ºç‚¹


**âœ… ä¼˜ç‚¹åˆ†æ**
```
ä½¿ç”¨ç®€å•ï¼š
â€¢ å®¢æˆ·ç«¯ä»£ç ç®€æ´
â€¢ ä¸éœ€è¦ç®¡ç†è¿­ä»£çŠ¶æ€
â€¢ å‡½æ•°å¼ç¼–ç¨‹é£æ ¼

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ é›†åˆå†…éƒ¨å¯åšä¼˜åŒ–
â€¢ å‡å°‘æ–¹æ³•è°ƒç”¨å¼€é”€
â€¢ ä¾¿äºå¹¶è¡Œå¤„ç†
```

**âŒ ç¼ºç‚¹åˆ†æ**
```
æ§åˆ¶å—é™ï¼š
â€¢ æ— æ³•ä¸­é€”åœæ­¢éå†
â€¢ æ— æ³•è·³è¿‡æŸäº›å…ƒç´ 
â€¢ éå†é¡ºåºå›ºå®š

çµæ´»æ€§å·®ï¼š
â€¢ éš¾ä»¥å®ç°å¤æ‚çš„éå†é€»è¾‘
â€¢ å¤šä¸ªè¿­ä»£å™¨æ— æ³•ååŒå·¥ä½œ
â€¢ æ— æ³•åœ¨éå†ä¸­ä¿®æ”¹é›†åˆ
```

---

## 3. ğŸ® å¤–éƒ¨è¿­ä»£å™¨å®ç°


### 3.1 å¤–éƒ¨è¿­ä»£å™¨æ ¸å¿ƒæ¦‚å¿µ


**æœ¬è´¨ç†è§£**ï¼šå¤–éƒ¨è¿­ä»£å™¨å°±åƒæ˜¯"è‡ªåŠ©å‹æœåŠ¡"

```
å›¾ä¹¦é¦†å€Ÿä¹¦çš„æ¯”å–»ï¼š
è‡ªåŠ©å€Ÿä¹¦ = å¤–éƒ¨è¿­ä»£å™¨
â€¢ ä½ ï¼šä¸»åŠ¨é€‰æ‹©ä¹¦ç±ï¼ˆæ§åˆ¶éå†ï¼‰
â€¢ ç³»ç»Ÿï¼šæä¾›æŸ¥è¯¢æ¥å£ï¼ˆhasNext/nextï¼‰
â€¢ å¥½å¤„ï¼šæƒ³å€Ÿå‡ æœ¬å€Ÿå‡ æœ¬ï¼Œéšæ—¶å¯ä»¥åœæ­¢

ç®¡ç†å‘˜ä»£å€Ÿ = å†…éƒ¨è¿­ä»£å™¨
â€¢ ä½ ï¼šå‘Šè¯‰éœ€æ±‚ï¼ˆæä¾›å¤„ç†å‡½æ•°ï¼‰
â€¢ ç®¡ç†å‘˜ï¼šæŒ‰é¡ºåºæ‰¾ä¹¦ï¼ˆè‡ªåŠ¨éå†ï¼‰
â€¢ å¥½å¤„ï¼šçœäº‹ï¼Œä½†æ— æ³•ä¸­é€”æ”¹å˜ä¸»æ„
```

### 3.2 åŸºç¡€å¤–éƒ¨è¿­ä»£å™¨å®ç°


```java
// å¤–éƒ¨è¿­ä»£å™¨æ¥å£
public interface Iterator<T> {
    boolean hasNext();  // æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ 
    T next();          // è·å–ä¸‹ä¸€ä¸ªå…ƒç´ 
    void remove();     // åˆ é™¤å½“å‰å…ƒç´ ï¼ˆå¯é€‰ï¼‰
}

// ä¹¦æ¶çš„å¤–éƒ¨è¿­ä»£å™¨å®ç°
public class BookShelfIterator implements Iterator<String> {
    private List<String> books;
    private int currentIndex = 0;
    
    public BookShelfIterator(List<String> books) {
        this.books = new ArrayList<>(books); // åˆ›å»ºå‰¯æœ¬ï¼Œé¿å…å¹¶å‘ä¿®æ”¹
    }
    
    @Override
    public boolean hasNext() {
        return currentIndex < books.size();
    }
    
    @Override
    public String next() {
        if (!hasNext()) {
            throw new NoSuchElementException("æ²¡æœ‰æ›´å¤šä¹¦ç±äº†");
        }
        return books.get(currentIndex++);
    }
    
    @Override
    public void remove() {
        if (currentIndex <= 0) {
            throw new IllegalStateException("è¿˜æ²¡æœ‰è°ƒç”¨next()æ–¹æ³•");
        }
        books.remove(--currentIndex);
    }
}

// æ”¯æŒå¤–éƒ¨è¿­ä»£å™¨çš„ä¹¦æ¶
public class IterableBookShelf implements Iterable<String> {
    private List<String> books = new ArrayList<>();
    
    public void addBook(String book) {
        books.add(book);
    }
    
    @Override
    public Iterator<String> iterator() {
        return new BookShelfIterator(books);
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    public static void main(String[] args) {
        IterableBookShelf shelf = new IterableBookShelf();
        shelf.addBook("Javaæ ¸å¿ƒæŠ€æœ¯");
        shelf.addBook("è®¾è®¡æ¨¡å¼");
        shelf.addBook("ç®—æ³•å¯¼è®º");
        
        // å¤–éƒ¨è¿­ä»£å™¨ä½¿ç”¨ - æ‰‹åŠ¨æ§åˆ¶
        Iterator<String> iterator = shelf.iterator();
        while (iterator.hasNext()) {
            String book = iterator.next();
            System.out.println("æ­£åœ¨é˜…è¯»: " + book);
            
            // å¯ä»¥æ ¹æ®æ¡ä»¶æå‰é€€å‡º
            if (book.contains("ç®—æ³•")) {
                System.out.println("æ‰¾åˆ°ç®—æ³•ä¹¦ï¼Œåœæ­¢éå†");
                break;
            }
        }
        
        // æ”¯æŒå¢å¼ºforå¾ªç¯
        for (String book : shelf) {
            System.out.println("ä¹¦ç±: " + book);
        }
    }
}
```

### 3.3 é«˜çº§å¤–éƒ¨è¿­ä»£å™¨å®ç°


```java
// æ”¯æŒå¤šç§éå†ç­–ç•¥çš„è¿­ä»£å™¨
public class AdvancedBookShelf {
    private List<Book> books = new ArrayList<>();
    
    // æ­£åºè¿­ä»£å™¨
    public Iterator<Book> iterator() {
        return new ForwardIterator();
    }
    
    // å€’åºè¿­ä»£å™¨
    public Iterator<Book> reverseIterator() {
        return new ReverseIterator();
    }
    
    // è¿‡æ»¤è¿­ä»£å™¨
    public Iterator<Book> filterIterator(Predicate<Book> filter) {
        return new FilterIterator(filter);
    }
    
    // æ­£åºè¿­ä»£å™¨å®ç°
    private class ForwardIterator implements Iterator<Book> {
        private int index = 0;
        
        @Override
        public boolean hasNext() {
            return index < books.size();
        }
        
        @Override
        public Book next() {
            return books.get(index++);
        }
    }
    
    // å€’åºè¿­ä»£å™¨å®ç°
    private class ReverseIterator implements Iterator<Book> {
        private int index = books.size() - 1;
        
        @Override
        public boolean hasNext() {
            return index >= 0;
        }
        
        @Override
        public Book next() {
            return books.get(index--);
        }
    }
    
    // è¿‡æ»¤è¿­ä»£å™¨å®ç°
    private class FilterIterator implements Iterator<Book> {
        private Predicate<Book> filter;
        private int index = 0;
        private Book nextBook = null;
        private boolean nextFound = false;
        
        public FilterIterator(Predicate<Book> filter) {
            this.filter = filter;
            findNext();
        }
        
        private void findNext() {
            nextFound = false;
            while (index < books.size()) {
                Book book = books.get(index++);
                if (filter.test(book)) {
                    nextBook = book;
                    nextFound = true;
                    break;
                }
            }
        }
        
        @Override
        public boolean hasNext() {
            return nextFound;
        }
        
        @Override
        public Book next() {
            if (!nextFound) {
                throw new NoSuchElementException();
            }
            Book result = nextBook;
            findNext();
            return result;
        }
    }
}
```

### 3.4 å¤–éƒ¨è¿­ä»£å™¨ä½¿ç”¨åœºæ™¯


**ğŸ¯ é€‚ç”¨åœºæ™¯**
```
ç²¾ç¡®æ§åˆ¶éœ€æ±‚ï¼š
BookShelf shelf = new BookShelf();
Iterator<Book> it = shelf.iterator();

// åœºæ™¯1ï¼šæ¡ä»¶é€€å‡º
while (it.hasNext()) {
    Book book = it.next();
    if (book.getPrice() > 100) {
        break; // é‡åˆ°è´µä¹¦å°±åœæ­¢
    }
    processBook(book);
}

// åœºæ™¯2ï¼šè·³è¿‡å¤„ç†
while (it.hasNext()) {
    Book book = it.next();
    if (book.getCategory().equals("æŠ€æœ¯")) {
        continue; // è·³è¿‡æŠ€æœ¯ä¹¦ç±
    }
    readBook(book);
}

// åœºæ™¯3ï¼šå¤šè¿­ä»£å™¨ååŒ
Iterator<Book> it1 = shelf.iterator();
Iterator<Book> it2 = shelf.reverseIterator();
// åŒæ—¶ä»å‰åéå†ï¼Œå®ç°æŸç§ç®—æ³•
```

---

## 4. ğŸ”„ åŒå‘è¿­ä»£å™¨è®¾è®¡


### 4.1 åŒå‘è¿­ä»£å™¨æ¦‚å¿µ


**é€šä¿—ç†è§£**ï¼šåŒå‘è¿­ä»£å™¨å°±åƒé¥æ§å™¨çš„å‰è¿›åé€€æŒ‰é’®

```
éŸ³ä¹æ’­æ”¾å™¨çš„æ¯”å–»ï¼š
å•å‘æ’­æ”¾ = å•å‘è¿­ä»£å™¨
â€¢ åªèƒ½ä¸‹ä¸€é¦– â†’
â€¢ åˆ°å¤´äº†å°±ç»“æŸ

åŒå‘æ’­æ”¾ = åŒå‘è¿­ä»£å™¨  
â€¢ å¯ä»¥ä¸‹ä¸€é¦– â†’
â€¢ ä¹Ÿå¯ä»¥ä¸Šä¸€é¦– â†
â€¢ éšæ„å‰è¿›åé€€
```

### 4.2 åŒå‘è¿­ä»£å™¨æ¥å£è®¾è®¡


```java
// åŒå‘è¿­ä»£å™¨æ¥å£
public interface BidirectionalIterator<T> extends Iterator<T> {
    // ç»§æ‰¿åŸºç¡€æ–¹æ³•
    boolean hasNext();
    T next();
    
    // æ–°å¢åå‘æ–¹æ³•
    boolean hasPrevious();  // æ˜¯å¦æœ‰å‰ä¸€ä¸ªå…ƒç´ 
    T previous();          // è·å–å‰ä¸€ä¸ªå…ƒç´ 
    
    // ä½ç½®ä¿¡æ¯
    int nextIndex();       // ä¸‹ä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•
    int previousIndex();   // å‰ä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•
    
    // ä¿®æ”¹æ“ä½œ
    void set(T element);   // æ›¿æ¢å½“å‰å…ƒç´ 
    void add(T element);   // åœ¨å½“å‰ä½ç½®æ’å…¥å…ƒç´ 
}
```

### 4.3 åŒå‘è¿­ä»£å™¨å®ç°


```java
// åŒå‘é“¾è¡¨èŠ‚ç‚¹
class BookNode {
    String title;
    BookNode prev;
    BookNode next;
    
    public BookNode(String title) {
        this.title = title;
    }
}

// æ”¯æŒåŒå‘è¿­ä»£çš„ä¹¦æ¶
public class DoublyLinkedBookShelf {
    private BookNode head = null;
    private BookNode tail = null;
    private int size = 0;
    
    public void addBook(String title) {
        BookNode newNode = new BookNode(title);
        if (head == null) {
            head = tail = newNode;
        } else {
            tail.next = newNode;
            newNode.prev = tail;
            tail = newNode;
        }
        size++;
    }
    
    // åˆ›å»ºåŒå‘è¿­ä»£å™¨
    public BidirectionalIterator<String> listIterator() {
        return new BookListIterator();
    }
    
    // ä»æŒ‡å®šä½ç½®åˆ›å»ºè¿­ä»£å™¨
    public BidirectionalIterator<String> listIterator(int index) {
        return new BookListIterator(index);
    }
    
    // åŒå‘è¿­ä»£å™¨å®ç°
    private class BookListIterator implements BidirectionalIterator<String> {
        private BookNode current = null;
        private BookNode lastReturned = null;
        private int nextIndex = 0;
        
        // é»˜è®¤ä»å¼€å¤´å¼€å§‹
        public BookListIterator() {
            current = head;
        }
        
        // ä»æŒ‡å®šä½ç½®å¼€å§‹
        public BookListIterator(int index) {
            if (index < 0 || index > size) {
                throw new IndexOutOfBoundsException("ç´¢å¼•è¶…å‡ºèŒƒå›´");
            }
            
            // ä¼˜åŒ–ï¼šä»æ›´è¿‘çš„ä¸€ç«¯å¼€å§‹æœç´¢
            if (index < size / 2) {
                current = head;
                for (int i = 0; i < index; i++) {
                    current = current.next;
                }
            } else {
                current = null; // è¡¨ç¤ºåœ¨æœ«å°¾
                nextIndex = size;
                for (int i = size; i > index; i--) {
                    current = (current == null) ? tail : current.prev;
                    nextIndex--;
                }
            }
        }
        
        @Override
        public boolean hasNext() {
            return nextIndex < size;
        }
        
        @Override
        public String next() {
            if (!hasNext()) {
                throw new NoSuchElementException();
            }
            
            lastReturned = current;
            String result = current.title;
            current = current.next;
            nextIndex++;
            return result;
        }
        
        @Override
        public boolean hasPrevious() {
            return nextIndex > 0;
        }
        
        @Override
        public String previous() {
            if (!hasPrevious()) {
                throw new NoSuchElementException();
            }
            
            current = (current == null) ? tail : current.prev;
            lastReturned = current;
            nextIndex--;
            return current.title;
        }
        
        @Override
        public int nextIndex() {
            return nextIndex;
        }
        
        @Override
        public int previousIndex() {
            return nextIndex - 1;
        }
        
        @Override
        public void set(String title) {
            if (lastReturned == null) {
                throw new IllegalStateException();
            }
            lastReturned.title = title;
        }
        
        @Override
        public void add(String title) {
            BookNode newNode = new BookNode(title);
            
            if (current == null) {
                // åœ¨æœ«å°¾æ·»åŠ 
                if (tail == null) {
                    head = tail = newNode;
                } else {
                    tail.next = newNode;
                    newNode.prev = tail;
                    tail = newNode;
                }
            } else {
                // åœ¨currentå‰æ·»åŠ 
                newNode.next = current;
                newNode.prev = current.prev;
                
                if (current.prev != null) {
                    current.prev.next = newNode;
                } else {
                    head = newNode;
                }
                current.prev = newNode;
            }
            
            size++;
            nextIndex++;
            lastReturned = null;
        }
        
        @Override
        public void remove() {
            if (lastReturned == null) {
                throw new IllegalStateException();
            }
            
            // åˆ é™¤lastReturnedèŠ‚ç‚¹
            if (lastReturned.prev != null) {
                lastReturned.prev.next = lastReturned.next;
            } else {
                head = lastReturned.next;
            }
            
            if (lastReturned.next != null) {
                lastReturned.next.prev = lastReturned.prev;
            } else {
                tail = lastReturned.prev;
            }
            
            size--;
            if (current == lastReturned) {
                current = lastReturned.next;
            } else {
                nextIndex--;
            }
            lastReturned = null;
        }
    }
}
```

### 4.4 åŒå‘è¿­ä»£å™¨ä½¿ç”¨ç¤ºä¾‹


```java
public class BidirectionalIteratorDemo {
    public static void main(String[] args) {
        DoublyLinkedBookShelf shelf = new DoublyLinkedBookShelf();
        shelf.addBook("JavaåŸºç¡€");
        shelf.addBook("è®¾è®¡æ¨¡å¼");
        shelf.addBook("æ•°æ®ç»“æ„");
        shelf.addBook("ç®—æ³•å¯¼è®º");
        
        BidirectionalIterator<String> iterator = shelf.listIterator();
        
        // æ­£å‘éå†
        System.out.println("=== æ­£å‘éå† ===");
        while (iterator.hasNext()) {
            System.out.println("ä¸‹ä¸€æœ¬: " + iterator.next());
        }
        
        // åå‘éå†
        System.out.println("\n=== åå‘éå† ===");
        while (iterator.hasPrevious()) {
            System.out.println("ä¸Šä¸€æœ¬: " + iterator.previous());
        }
        
        // æ¥å›ç§»åŠ¨
        System.out.println("\n=== è‡ªç”±ç§»åŠ¨ ===");
        iterator = shelf.listIterator(1); // ä»ç¬¬2æœ¬å¼€å§‹
        System.out.println("å½“å‰ä½ç½®çš„ä¸‹ä¸€æœ¬: " + iterator.next()); // è®¾è®¡æ¨¡å¼
        System.out.println("å¾€å›ä¸€æœ¬: " + iterator.previous());      // è®¾è®¡æ¨¡å¼
        System.out.println("å†å¾€å›ä¸€æœ¬: " + iterator.previous());    // JavaåŸºç¡€
        
        // ä¿®æ”¹å’Œæ·»åŠ 
        iterator.set("Javaè¿›é˜¶");              // ä¿®æ”¹å½“å‰å…ƒç´ 
        iterator.add("Springæ¡†æ¶");            // æ·»åŠ æ–°å…ƒç´ 
    }
}
```

---

## 5. ğŸ¯ éšæœºè®¿é—®è¿­ä»£å™¨


### 5.1 éšæœºè®¿é—®è¿­ä»£å™¨æ¦‚å¿µ


**é€šä¿—ç†è§£**ï¼šéšæœºè®¿é—®è¿­ä»£å™¨å°±åƒç”µæ¢¯ï¼Œæƒ³å»å‡ æ¥¼ç›´æ¥æŒ‰æŒ‰é’®

```
äº¤é€šå·¥å…·çš„æ¯”å–»ï¼š
æ­¥è¡Œ = é¡ºåºè¿­ä»£å™¨
â€¢ ä¸€æ­¥ä¸€æ­¥èµ°ï¼Œä¸èƒ½è·³è·ƒ

ç”µæ¢¯ = éšæœºè®¿é—®è¿­ä»£å™¨
â€¢ æƒ³å»å‡ æ¥¼ç›´æ¥æŒ‰æŒ‰é’®
â€¢ å¯ä»¥å¿«é€Ÿè·³è·ƒåˆ°ä»»æ„ä½ç½®

è‡ªè¡Œè½¦ = åŒå‘è¿­ä»£å™¨  
â€¢ å¯ä»¥å‰è¿›åé€€
â€¢ ä½†è¿˜æ˜¯éœ€è¦ä¸€æ­¥æ­¥ç§»åŠ¨
```

### 5.2 éšæœºè®¿é—®è¿­ä»£å™¨æ¥å£è®¾è®¡


```java
// éšæœºè®¿é—®è¿­ä»£å™¨æ¥å£
public interface RandomAccessIterator<T> extends BidirectionalIterator<T> {
    // ç»§æ‰¿åŒå‘è¿­ä»£å™¨çš„æ‰€æœ‰æ–¹æ³•
    
    // éšæœºè®¿é—®æ–¹æ³•
    T get(int index);              // è·å–æŒ‡å®šä½ç½®çš„å…ƒç´ 
    void set(int index, T element); // è®¾ç½®æŒ‡å®šä½ç½®çš„å…ƒç´ 
    
    // è·³è·ƒç§»åŠ¨
    void advance(int steps);        // å‘å‰ç§»åŠ¨næ­¥
    void retreat(int steps);        // å‘åç§»åŠ¨næ­¥
    void jumpTo(int index);         // è·³è½¬åˆ°æŒ‡å®šä½ç½®
    
    // è·ç¦»è®¡ç®—
    int distance(RandomAccessIterator<T> other); // è®¡ç®—ä¸¤ä¸ªè¿­ä»£å™¨é—´çš„è·ç¦»
    
    // ç®—æœ¯è¿ç®—
    RandomAccessIterator<T> plus(int offset);    // è¿”å›å‘å‰åç§»çš„è¿­ä»£å™¨
    RandomAccessIterator<T> minus(int offset);   // è¿”å›å‘ååç§»çš„è¿­ä»£å™¨
    
    // æ¯”è¾ƒæ“ä½œ
    boolean before(RandomAccessIterator<T> other); // æ˜¯å¦åœ¨å¦ä¸€ä¸ªè¿­ä»£å™¨ä¹‹å‰
    boolean after(RandomAccessIterator<T> other);  // æ˜¯å¦åœ¨å¦ä¸€ä¸ªè¿­ä»£å™¨ä¹‹å
}
```

### 5.3 åŸºäºæ•°ç»„çš„éšæœºè®¿é—®è¿­ä»£å™¨


```java
// åŸºäºæ•°ç»„çš„ä¹¦æ¶ï¼Œæ”¯æŒéšæœºè®¿é—®
public class ArrayBookShelf {
    private static final int DEFAULT_CAPACITY = 10;
    private String[] books;
    private int size = 0;
    
    public ArrayBookShelf() {
        books = new String[DEFAULT_CAPACITY];
    }
    
    public void addBook(String title) {
        ensureCapacity();
        books[size++] = title;
    }
    
    private void ensureCapacity() {
        if (size >= books.length) {
            books = Arrays.copyOf(books, books.length * 2);
        }
    }
    
    public String getBook(int index) {
        if (index < 0 || index >= size) {
            throw new IndexOutOfBoundsException("ç´¢å¼•è¶…å‡ºèŒƒå›´: " + index);
        }
        return books[index];
    }
    
    public void setBook(int index, String title) {
        if (index < 0 || index >= size) {
            throw new IndexOutOfBoundsException("ç´¢å¼•è¶…å‡ºèŒƒå›´: " + index);
        }
        books[index] = title;
    }
    
    public int size() {
        return size;
    }
    
    // åˆ›å»ºéšæœºè®¿é—®è¿­ä»£å™¨
    public RandomAccessIterator<String> randomIterator() {
        return new ArrayRandomIterator(0);
    }
    
    public RandomAccessIterator<String> randomIterator(int startIndex) {
        return new ArrayRandomIterator(startIndex);
    }
    
    // éšæœºè®¿é—®è¿­ä»£å™¨å®ç°
    private class ArrayRandomIterator implements RandomAccessIterator<String> {
        private int currentIndex;
        private int lastReturnedIndex = -1;
        
        public ArrayRandomIterator(int startIndex) {
            if (startIndex < 0 || startIndex > size) {
                throw new IndexOutOfBoundsException("èµ·å§‹ç´¢å¼•è¶…å‡ºèŒƒå›´");
            }
            this.currentIndex = startIndex;
        }
        
        // åŸºç¡€è¿­ä»£å™¨æ–¹æ³•
        @Override
        public boolean hasNext() {
            return currentIndex < size;
        }
        
        @Override
        public String next() {
            if (!hasNext()) {
                throw new NoSuchElementException();
            }
            lastReturnedIndex = currentIndex;
            return books[currentIndex++];
        }
        
        @Override
        public boolean hasPrevious() {
            return currentIndex > 0;
        }
        
        @Override
        public String previous() {
            if (!hasPrevious()) {
                throw new NoSuchElementException();
            }
            lastReturnedIndex = --currentIndex;
            return books[currentIndex];
        }
        
        // éšæœºè®¿é—®æ–¹æ³•
        @Override
        public String get(int index) {
            return getBook(index);
        }
        
        @Override
        public void set(int index, String element) {
            setBook(index, element);
        }
        
        @Override
        public void advance(int steps) {
            currentIndex += steps;
            if (currentIndex < 0) currentIndex = 0;
            if (currentIndex > size) currentIndex = size;
        }
        
        @Override
        public void retreat(int steps) {
            advance(-steps);
        }
        
        @Override
        public void jumpTo(int index) {
            if (index < 0 || index > size) {
                throw new IndexOutOfBoundsException("ç›®æ ‡ç´¢å¼•è¶…å‡ºèŒƒå›´");
            }
            currentIndex = index;
        }
        
        @Override
        public int distance(RandomAccessIterator<String> other) {
            if (!(other instanceof ArrayRandomIterator)) {
                throw new IllegalArgumentException("ä¸åŒç±»å‹çš„è¿­ä»£å™¨");
            }
            ArrayRandomIterator otherIter = (ArrayRandomIterator) other;
            return otherIter.currentIndex - this.currentIndex;
        }
        
        @Override
        public RandomAccessIterator<String> plus(int offset) {
            return new ArrayRandomIterator(currentIndex + offset);
        }
        
        @Override
        public RandomAccessIterator<String> minus(int offset) {
            return new ArrayRandomIterator(currentIndex - offset);
        }
        
        @Override
        public boolean before(RandomAccessIterator<String> other) {
            return distance(other) > 0;
        }
        
        @Override
        public boolean after(RandomAccessIterator<String> other) {
            return distance(other) < 0;
        }
        
        // å…¶ä»–æ–¹æ³•çš„å®ç°...
        @Override
        public int nextIndex() {
            return currentIndex;
        }
        
        @Override
        public int previousIndex() {
            return currentIndex - 1;
        }
        
        @Override
        public void set(String element) {
            if (lastReturnedIndex == -1) {
                throw new IllegalStateException();
            }
            books[lastReturnedIndex] = element;
        }
        
        @Override
        public void add(String element) {
            // åœ¨å½“å‰ä½ç½®æ’å…¥å…ƒç´ ï¼ˆç®€åŒ–å®ç°ï¼‰
            throw new UnsupportedOperationException("æ•°ç»„è¿­ä»£å™¨ä¸æ”¯æŒæ’å…¥æ“ä½œ");
        }
        
        @Override
        public void remove() {
            if (lastReturnedIndex == -1) {
                throw new IllegalStateException();
            }
            // åˆ é™¤å…ƒç´ ï¼ˆç®€åŒ–å®ç°ï¼‰
            System.arraycopy(books, lastReturnedIndex + 1, books, lastReturnedIndex, 
                           size - lastReturnedIndex - 1);
            size--;
            currentIndex = lastReturnedIndex;
            lastReturnedIndex = -1;
        }
    }
}
```

### 5.4 éšæœºè®¿é—®è¿­ä»£å™¨åº”ç”¨åœºæ™¯


```java
public class RandomAccessDemo {
    public static void main(String[] args) {
        ArrayBookShelf shelf = new ArrayBookShelf();
        // æ·»åŠ ä¸€äº›ä¹¦ç±
        shelf.addBook("JavaåŸºç¡€");      // ç´¢å¼•0
        shelf.addBook("è®¾è®¡æ¨¡å¼");      // ç´¢å¼•1  
        shelf.addBook("æ•°æ®ç»“æ„");      // ç´¢å¼•2
        shelf.addBook("ç®—æ³•å¯¼è®º");      // ç´¢å¼•3
        shelf.addBook("è®¡ç®—æœºç½‘ç»œ");    // ç´¢å¼•4
        
        RandomAccessIterator<String> iter = shelf.randomIterator();
        
        // åœºæ™¯1ï¼šå¿«é€Ÿè·³è½¬è®¿é—®
        System.out.println("=== éšæœºè®¿é—®æ¼”ç¤º ===");
        iter.jumpTo(3);
        System.out.println("ç¬¬4æœ¬ä¹¦: " + iter.get(3));
        
        iter.jumpTo(0);  
        System.out.println("ç¬¬1æœ¬ä¹¦: " + iter.get(0));
        
        // åœºæ™¯2ï¼šå¤§æ­¥é•¿ç§»åŠ¨
        System.out.println("\n=== å¤§æ­¥é•¿ç§»åŠ¨ ===");
        iter.jumpTo(1);
        System.out.println("å½“å‰ä½ç½®: " + iter.nextIndex() + ", ä¹¦ç±: " + iter.get(1));
        
        iter.advance(3);  // å‘å‰ç§»åŠ¨3æ­¥
        if (iter.hasNext()) {
            System.out.println("ç§»åŠ¨åä½ç½®: " + iter.nextIndex() + ", ä¹¦ç±: " + iter.get(4));
        }
        
        // åœºæ™¯3ï¼šäºŒåˆ†æŸ¥æ‰¾ç®—æ³•
        System.out.println("\n=== äºŒåˆ†æŸ¥æ‰¾æ¼”ç¤º ===");
        String target = "æ•°æ®ç»“æ„";
        int result = binarySearch(shelf, target);
        System.out.println("æŸ¥æ‰¾ '" + target + "' ç»“æœ: " + 
                         (result >= 0 ? "æ‰¾åˆ°ï¼Œä½ç½®" + result : "æœªæ‰¾åˆ°"));
    }
    
    // ä½¿ç”¨éšæœºè®¿é—®è¿­ä»£å™¨å®ç°äºŒåˆ†æŸ¥æ‰¾
    public static int binarySearch(ArrayBookShelf shelf, String target) {
        RandomAccessIterator<String> left = shelf.randomIterator(0);
        RandomAccessIterator<String> right = shelf.randomIterator(shelf.size());
        
        while (left.before(right)) {
            int mid = left.nextIndex() + left.distance(right) / 2;
            RandomAccessIterator<String> midIter = shelf.randomIterator(mid);
            
            String midValue = midIter.get(mid);
            int cmp = midValue.compareTo(target);
            
            if (cmp == 0) {
                return mid;  // æ‰¾åˆ°äº†
            } else if (cmp < 0) {
                left = midIter.plus(1);
            } else {
                right = midIter;
            }
        }
        
        return -1;  // æœªæ‰¾åˆ°
    }
}
```

---

## 6. ğŸ”’ å¹¶å‘å®‰å…¨è¿­ä»£å™¨


### 6.1 å¹¶å‘å®‰å…¨é—®é¢˜


**é€šä¿—ç†è§£**ï¼šå¤šäººåŒæ—¶ä½¿ç”¨å›¾ä¹¦é¦†ä¼šé‡åˆ°çš„é—®é¢˜

```
å›¾ä¹¦é¦†å¹¶å‘é—®é¢˜ï¼š
é—®é¢˜1ï¼šå€Ÿä¹¦å†²çª
â€¢ Aæ­£åœ¨å€Ÿã€ŠJavaç¼–ç¨‹ã€‹
â€¢ BåŒæ—¶ä¹Ÿæƒ³å€Ÿè¿™æœ¬ä¹¦
â€¢ ç»“æœï¼šå¯èƒ½å‡ºç°ä¸€æœ¬ä¹¦è¢«ä¸¤äººå€Ÿèµ°

é—®é¢˜2ï¼šç›®å½•æ›´æ–°
â€¢ Aæ­£åœ¨æµè§ˆå›¾ä¹¦ç›®å½•
â€¢ Bæ­¤æ—¶æ·»åŠ äº†æ–°ä¹¦
â€¢ ç»“æœï¼šAå¯èƒ½çœ‹åˆ°ä¸ä¸€è‡´çš„ç›®å½•

è¿­ä»£å™¨å¹¶å‘é—®é¢˜ï¼š
é—®é¢˜1ï¼šç»“æ„ä¿®æ”¹
â€¢ çº¿ç¨‹Aæ­£åœ¨éå†é›†åˆ
â€¢ çº¿ç¨‹Bä¿®æ”¹äº†é›†åˆç»“æ„
â€¢ ç»“æœï¼šConcurrentModificationException

é—®é¢˜2ï¼šæ•°æ®ä¸ä¸€è‡´
â€¢ çº¿ç¨‹Aè¯»å–å…ƒç´ 
â€¢ çº¿ç¨‹BåŒæ—¶ä¿®æ”¹å…ƒç´ 
â€¢ ç»“æœï¼šè¯»å–åˆ°ä¸ä¸€è‡´çš„æ•°æ®
```

### 6.2 å¿«é€Ÿå¤±è´¥è¿­ä»£å™¨ï¼ˆFail-Fastï¼‰


```java
// å¿«é€Ÿå¤±è´¥çš„ä¹¦æ¶å®ç°
public class FailFastBookShelf {
    private List<String> books = new ArrayList<>();
    private volatile int modCount = 0;  // ä¿®æ”¹è®¡æ•°å™¨
    
    public synchronized void addBook(String book) {
        books.add(book);
        modCount++;  // ç»“æ„ä¿®æ”¹æ—¶å¢åŠ è®¡æ•°
    }
    
    public synchronized boolean removeBook(String book) {
        boolean removed = books.remove(book);
        if (removed) {
            modCount++;
        }
        return removed;
    }
    
    // åˆ›å»ºå¿«é€Ÿå¤±è´¥è¿­ä»£å™¨
    public Iterator<String> iterator() {
        return new FailFastIterator();
    }
    
    private class FailFastIterator implements Iterator<String> {
        private int cursor = 0;
        private int lastReturned = -1;
        private int expectedModCount = modCount;  // è®°å½•åˆ›å»ºæ—¶çš„ä¿®æ”¹è®¡æ•°
        
        @Override
        public boolean hasNext() {
            return cursor < books.size();
        }
        
        @Override
        public String next() {
            checkForComodification();  // æ£€æŸ¥å¹¶å‘ä¿®æ”¹
            
            if (cursor >= books.size()) {
                throw new NoSuchElementException();
            }
            
            lastReturned = cursor;
            return books.get(cursor++);
        }
        
        @Override
        public void remove() {
            if (lastReturned < 0) {
                throw new IllegalStateException();
            }
            
            checkForComodification();
            
            try {
                books.remove(lastReturned);
                cursor = lastReturned;
                lastReturned = -1;
                expectedModCount = ++modCount;  // åŒæ­¥ä¿®æ”¹è®¡æ•°
            } catch (IndexOutOfBoundsException ex) {
                throw new ConcurrentModificationException();
            }
        }
        
        // æ£€æŸ¥å¹¶å‘ä¿®æ”¹
        private void checkForComodification() {
            if (modCount != expectedModCount) {
                throw new ConcurrentModificationException(
                    "é›†åˆåœ¨è¿­ä»£è¿‡ç¨‹ä¸­è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†");
            }
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public class FailFastDemo {
    public static void main(String[] args) {
        FailFastBookShelf shelf = new FailFastBookShelf();
        shelf.addBook("Javaç¼–ç¨‹");
        shelf.addBook("è®¾è®¡æ¨¡å¼");
        
        Iterator<String> iter = shelf.iterator();
        
        // æ¼”ç¤ºå¿«é€Ÿå¤±è´¥
        try {
            while (iter.hasNext()) {
                String book = iter.next();
                System.out.println("æ­£åœ¨è¯»: " + book);
                
                // åœ¨è¿­ä»£è¿‡ç¨‹ä¸­ä¿®æ”¹é›†åˆ
                if (book.equals("Javaç¼–ç¨‹")) {
                    shelf.addBook("æ–°ä¹¦");  // è¿™ä¼šå¯¼è‡´ConcurrentModificationException
                }
            }
        } catch (ConcurrentModificationException e) {
            System.out.println("æ£€æµ‹åˆ°å¹¶å‘ä¿®æ”¹: " + e.getMessage());
        }
    }
}
```

### 6.3 å®‰å…¨å¤±è´¥è¿­ä»£å™¨ï¼ˆFail-Safeï¼‰


```java
// å®‰å…¨å¤±è´¥çš„ä¹¦æ¶å®ç°
public class FailSafeBookShelf {
    private final CopyOnWriteArrayList<String> books = new CopyOnWriteArrayList<>();
    
    public void addBook(String book) {
        books.add(book);
    }
    
    public boolean removeBook(String book) {
        return books.remove(book);
    }
    
    // CopyOnWriteArrayListçš„è¿­ä»£å™¨å¤©ç„¶æ˜¯å®‰å…¨å¤±è´¥çš„
    public Iterator<String> iterator() {
        return books.iterator();
    }
    
    // è‡ªå®šä¹‰çš„å®‰å…¨å¤±è´¥è¿­ä»£å™¨
    public Iterator<String> safeIterator() {
        return new FailSafeIterator();
    }
    
    private class FailSafeIterator implements Iterator<String> {
        private final List<String> snapshot;
        private int cursor = 0;
        
        public FailSafeIterator() {
            // åˆ›å»ºå¿«ç…§ï¼Œé¿å…å¹¶å‘ä¿®æ”¹å½±å“
            synchronized (books) {
                snapshot = new ArrayList<>(books);
            }
        }
        
        @Override
        public boolean hasNext() {
            return cursor < snapshot.size();
        }
        
        @Override
        public String next() {
            if (!hasNext()) {
                throw new NoSuchElementException();
            }
            return snapshot.get(cursor++);
        }
        
        @Override
        public void remove() {
            throw new UnsupportedOperationException(
                "å¿«ç…§è¿­ä»£å™¨ä¸æ”¯æŒåˆ é™¤æ“ä½œ");
        }
    }
}
```

### 6.4 çº¿ç¨‹å®‰å…¨çš„è¿­ä»£å™¨è®¾è®¡


```java
// å®Œå…¨çº¿ç¨‹å®‰å…¨çš„ä¹¦æ¶
public class ThreadSafeBookShelf {
    private final List<String> books = Collections.synchronizedList(new ArrayList<>());
    private final ReadWriteLock lock = new ReentrantReadWriteLock();
    
    public void addBook(String book) {
        lock.writeLock().lock();
        try {
            books.add(book);
        } finally {
            lock.writeLock().unlock();
        }
    }
    
    public boolean removeBook(String book) {
        lock.writeLock().lock();
        try {
            return books.remove(book);
        } finally {
            lock.writeLock().unlock();
        }
    }
    
    // åˆ›å»ºçº¿ç¨‹å®‰å…¨çš„è¿­ä»£å™¨
    public Iterator<String> threadSafeIterator() {
        return new ThreadSafeIterator();
    }
    
    private class ThreadSafeIterator implements Iterator<String> {
        private final Iterator<String> delegate;
        private String lastReturned = null;
        
        public ThreadSafeIterator() {
            lock.readLock().lock();
            try {
                // åˆ›å»ºä¸å¯å˜çš„å¿«ç…§
                List<String> snapshot = new ArrayList<>(books);
                delegate = snapshot.iterator();
            } finally {
                lock.readLock().unlock();
            }
        }
        
        @Override
        public boolean hasNext() {
            return delegate.hasNext();
        }
        
        @Override
        public String next() {
            lastReturned = delegate.next();
            return lastReturned;
        }
        
        @Override
        public void remove() {
            if (lastReturned == null) {
                throw new IllegalStateException();
            }
            
            // ä»åŸé›†åˆä¸­åˆ é™¤ï¼ˆéœ€è¦è·å–å†™é”ï¼‰
            lock.writeLock().lock();
            try {
                books.remove(lastReturned);
                lastReturned = null;
            } finally {
                lock.writeLock().unlock();
            }
        }
    }
}

// å¹¶å‘å®‰å…¨ä½¿ç”¨ç¤ºä¾‹
public class ConcurrentIteratorDemo {
    public static void main(String[] args) throws InterruptedException {
        ThreadSafeBookShelf shelf = new ThreadSafeBookShelf();
        
        // æ·»åŠ åˆå§‹æ•°æ®
        shelf.addBook("Javaç¼–ç¨‹");
        shelf.addBook("è®¾è®¡æ¨¡å¼");
        shelf.addBook("æ•°æ®ç»“æ„");
        
        // åˆ›å»ºå¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œ
        ExecutorService executor = Executors.newFixedThreadPool(3);
        
        // çº¿ç¨‹1ï¼šæŒç»­è¯»å–
        executor.submit(() -> {
            Iterator<String> iter = shelf.threadSafeIterator();
            while (iter.hasNext()) {
                System.out.println("è¯»å–çº¿ç¨‹: " + iter.next());
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }
        });
        
        // çº¿ç¨‹2ï¼šæŒç»­æ·»åŠ 
        executor.submit(() -> {
            for (int i = 0; i < 5; i++) {
                shelf.addBook("æ–°ä¹¦" + i);
                System.out.println("æ·»åŠ çº¿ç¨‹: æ·»åŠ äº†æ–°ä¹¦" + i);
                try {
                    Thread.sleep(150);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }
        });
        
        // çº¿ç¨‹3ï¼šæŒç»­åˆ é™¤
        executor.submit(() -> {
            try {
                Thread.sleep(500);
                shelf.removeBook("Javaç¼–ç¨‹");
                System.out.println("åˆ é™¤çº¿ç¨‹: åˆ é™¤äº†Javaç¼–ç¨‹");
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        });
        
        executor.shutdown();
        executor.awaitTermination(5, TimeUnit.SECONDS);
    }
}
```

---

## 7. ğŸ“Š å®ç°æ–¹å¼å¯¹æ¯”


### 7.1 åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”


| ç‰¹æ€§ | **å†…éƒ¨è¿­ä»£å™¨** | **å¤–éƒ¨è¿­ä»£å™¨** | **åŒå‘è¿­ä»£å™¨** | **éšæœºè®¿é—®è¿­ä»£å™¨** | **å¹¶å‘å®‰å…¨è¿­ä»£å™¨** |
|------|--------------|--------------|--------------|------------------|------------------|
| ğŸ¯ **ä½¿ç”¨ç®€å•åº¦** | `â­â­â­â­â­` | `â­â­â­` | `â­â­` | `â­â­` | `â­â­` |
| ğŸ”§ **å®ç°å¤æ‚åº¦** | `â­â­` | `â­â­â­` | `â­â­â­â­` | `â­â­â­â­â­` | `â­â­â­â­â­` |
| âš¡ **æ€§èƒ½æ•ˆç‡** | `â­â­â­â­` | `â­â­â­â­` | `â­â­â­` | `â­â­â­â­â­` | `â­â­` |
| ğŸ® **æ§åˆ¶çµæ´»æ€§** | `â­` | `â­â­â­â­â­` | `â­â­â­â­â­` | `â­â­â­â­â­` | `â­â­â­` |
| ğŸ”’ **çº¿ç¨‹å®‰å…¨æ€§** | `å–å†³äºå®ç°` | `âŒ` | `âŒ` | `âŒ` | `â­â­â­â­â­` |

### 7.2 é€‚ç”¨åœºæ™¯å¯¹æ¯”


```
æ•°æ®å¤„ç†åœºæ™¯åˆ†æï¼š

ç®€å•éå†ç»Ÿè®¡ï¼š
âœ… å†…éƒ¨è¿­ä»£å™¨ - forEach(item -> count++)
âŒ å¤–éƒ¨è¿­ä»£å™¨ - ä»£ç å†—é•¿

æ¡ä»¶æŸ¥æ‰¾æœç´¢ï¼š  
âŒ å†…éƒ¨è¿­ä»£å™¨ - æ— æ³•ä¸­é€”åœæ­¢
âœ… å¤–éƒ¨è¿­ä»£å™¨ - æ‰¾åˆ°å³å¯é€€å‡º

åŒå‘æµè§ˆæ•°æ®ï¼š
âŒ å•å‘è¿­ä»£å™¨ - åªèƒ½å¾€å‰
âœ… åŒå‘è¿­ä»£å™¨ - å‰åè‡ªç”±ç§»åŠ¨

å¿«é€Ÿè·³è½¬è®¿é—®ï¼š
âŒ é¡ºåºè¿­ä»£å™¨ - éœ€è¦é€æ­¥ç§»åŠ¨
âœ… éšæœºè®¿é—®è¿­ä»£å™¨ - ç›´æ¥è·³è½¬

å¤šçº¿ç¨‹ç¯å¢ƒï¼š
âŒ æ™®é€šè¿­ä»£å™¨ - å¯èƒ½æŠ›å¼‚å¸¸
âœ… å¹¶å‘å®‰å…¨è¿­ä»£å™¨ - ä¿è¯æ•°æ®ä¸€è‡´æ€§
```

### 7.3 æ€§èƒ½å¼€é”€åˆ†æ


```
æ—¶é—´å¤æ‚åº¦å¯¹æ¯”ï¼š

æ“ä½œç±»å‹          å†…éƒ¨    å¤–éƒ¨    åŒå‘    éšæœºè®¿é—®  å¹¶å‘å®‰å…¨
åˆ›å»ºè¿­ä»£å™¨        O(1)    O(1)    O(1)    O(1)     O(n)
è·å–ä¸‹ä¸€ä¸ªå…ƒç´      O(1)    O(1)    O(1)    O(1)     O(1)
è·³è½¬åˆ°æŒ‡å®šä½ç½®     N/A     O(n)    O(n)    O(1)     O(1)
éå†å…¨éƒ¨å…ƒç´        O(n)    O(n)    O(n)    O(n)     O(n)

ç©ºé—´å¤æ‚åº¦å¯¹æ¯”ï¼š

å†…éƒ¨è¿­ä»£å™¨ï¼šO(1) - ä¸éœ€è¦çŠ¶æ€å­˜å‚¨
å¤–éƒ¨è¿­ä»£å™¨ï¼šO(1) - åªå­˜å‚¨ä½ç½®ä¿¡æ¯
åŒå‘è¿­ä»£å™¨ï¼šO(1) - é¢å¤–å­˜å‚¨å‰å‘æŒ‡é’ˆ
éšæœºè®¿é—®è¿­ä»£å™¨ï¼šO(1) - åŸºäºæ•°ç»„ç´¢å¼•
å¹¶å‘å®‰å…¨è¿­ä»£å™¨ï¼šO(n) - éœ€è¦åˆ›å»ºæ•°æ®å‰¯æœ¬
```

### 7.4 é€‰æ‹©å†³ç­–æ ‘


```
é€‰æ‹©è¿­ä»£å™¨å®ç°çš„å†³ç­–æµç¨‹ï¼š

å¼€å§‹
 |
 â”œâ”€ éœ€è¦çº¿ç¨‹å®‰å…¨ï¼Ÿ
 â”‚   â””â”€ æ˜¯ â†’ å¹¶å‘å®‰å…¨è¿­ä»£å™¨
 â”‚
 â”œâ”€ éœ€è¦å¿«é€Ÿè·³è½¬ï¼Ÿ
 â”‚   â””â”€ æ˜¯ â†’ éšæœºè®¿é—®è¿­ä»£å™¨
 â”‚
 â”œâ”€ éœ€è¦åŒå‘ç§»åŠ¨ï¼Ÿ
 â”‚   â””â”€ æ˜¯ â†’ åŒå‘è¿­ä»£å™¨
 â”‚
 â”œâ”€ éœ€è¦æ§åˆ¶éå†è¿‡ç¨‹ï¼Ÿ
 â”‚   â”œâ”€ æ˜¯ â†’ å¤–éƒ¨è¿­ä»£å™¨
 â”‚   â””â”€ å¦ â†’ å†…éƒ¨è¿­ä»£å™¨
 â”‚
 â””â”€ ç®€å•æ•°æ®å¤„ç†ï¼Ÿ
     â””â”€ æ˜¯ â†’ å†…éƒ¨è¿­ä»£å™¨

å®é™…é€‰æ‹©å»ºè®®ï¼š
â€¢ é»˜è®¤é€‰æ‹©ï¼šå¤–éƒ¨è¿­ä»£å™¨ï¼ˆæœ€é€šç”¨ï¼‰
â€¢ å‡½æ•°å¼ç¼–ç¨‹ï¼šå†…éƒ¨è¿­ä»£å™¨
â€¢ å¤æ‚å¯¼èˆªï¼šåŒå‘è¿­ä»£å™¨
â€¢ å¤§æ•°æ®é›†ï¼šéšæœºè®¿é—®è¿­ä»£å™¨
â€¢ å¤šçº¿ç¨‹ï¼šå¹¶å‘å®‰å…¨è¿­ä»£å™¨
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å®ç°æ–¹å¼åˆ†ç±»ï¼šå†…éƒ¨vså¤–éƒ¨ï¼Œå•å‘vsåŒå‘vséšæœºè®¿é—®
ğŸ”¸ æ§åˆ¶æƒå·®å¼‚ï¼šå†…éƒ¨è¿­ä»£å™¨é›†åˆæ§åˆ¶ï¼Œå¤–éƒ¨è¿­ä»£å™¨å®¢æˆ·ç«¯æ§åˆ¶
ğŸ”¸ åŠŸèƒ½ç‰¹ç‚¹ï¼šæ¯ç§å®ç°æ–¹å¼éƒ½æœ‰å…¶ç‹¬ç‰¹çš„ä¼˜åŠ¿å’Œé€‚ç”¨åœºæ™¯
ğŸ”¸ å¹¶å‘å®‰å…¨ï¼šå¤šçº¿ç¨‹ç¯å¢ƒä¸‹éœ€è¦ç‰¹æ®Šçš„å®‰å…¨ä¿æŠ¤æœºåˆ¶
ğŸ”¸ æ€§èƒ½æƒè¡¡ï¼šåŠŸèƒ½è¶Šå¼ºå¤§ï¼Œå®ç°å¤æ‚åº¦å’Œæ€§èƒ½å¼€é”€è¶Šé«˜
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å†…éƒ¨è¿­ä»£å™¨çš„æœ¬è´¨**
```
æœ¬è´¨ï¼šæŠŠéå†æ§åˆ¶æƒäº¤ç»™é›†åˆ
ä¼˜åŠ¿ï¼šä½¿ç”¨ç®€å•ï¼Œä»£ç ç®€æ´ï¼Œé€‚åˆå‡½æ•°å¼ç¼–ç¨‹
å±€é™ï¼šæ— æ³•ä¸­é€”åœæ­¢ï¼Œæ§åˆ¶çµæ´»æ€§å·®
é€‚ç”¨ï¼šç®€å•çš„æ•°æ®å¤„ç†å’Œç»Ÿè®¡æ“ä½œ
```

**ğŸ”¹ å¤–éƒ¨è¿­ä»£å™¨çš„ä»·å€¼**
```
æœ¬è´¨ï¼šå®¢æˆ·ç«¯å®Œå…¨æ§åˆ¶éå†è¿‡ç¨‹
ä¼˜åŠ¿ï¼šæœ€å¤§çš„çµæ´»æ€§ï¼Œå¯ä»¥å®ç°å¤æ‚çš„éå†é€»è¾‘
æˆæœ¬ï¼šä»£ç ç›¸å¯¹å¤æ‚ï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†çŠ¶æ€
é€‚ç”¨ï¼šéœ€è¦ç²¾ç¡®æ§åˆ¶çš„å¤æ‚åœºæ™¯
```

**ğŸ”¹ é«˜çº§è¿­ä»£å™¨çš„æƒè¡¡**
```
åŒå‘è¿­ä»£å™¨ï¼šå¢åŠ äº†åå‘éå†èƒ½åŠ›ï¼Œé€‚åˆéœ€è¦å›é€€çš„åœºæ™¯
éšæœºè®¿é—®è¿­ä»£å™¨ï¼šæä¾›å¿«é€Ÿè·³è½¬ï¼Œé€‚åˆå¤§æ•°æ®é›†å’Œç®—æ³•å®ç°
å¹¶å‘å®‰å…¨è¿­ä»£å™¨ï¼šä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä½†ç‰ºç‰²äº†ä¸€å®šçš„æ€§èƒ½
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ é€‰æ‹©ç­–ç•¥**
- **ç®€å•éå†**ï¼šä¼˜å…ˆé€‰æ‹©å†…éƒ¨è¿­ä»£å™¨ï¼ˆforEachï¼‰
- **æ¡ä»¶å¤„ç†**ï¼šé€‰æ‹©å¤–éƒ¨è¿­ä»£å™¨ï¼ˆçµæ´»æ§åˆ¶ï¼‰
- **åŒå‘æµè§ˆ**ï¼šé€‰æ‹©åŒå‘è¿­ä»£å™¨ï¼ˆå¦‚éŸ³ä¹æ’­æ”¾å™¨ï¼‰
- **å¿«é€Ÿå®šä½**ï¼šé€‰æ‹©éšæœºè®¿é—®è¿­ä»£å™¨ï¼ˆå¦‚å¤§æ•°æ®åˆ†æï¼‰
- **å¤šçº¿ç¨‹**ï¼šé€‰æ‹©å¹¶å‘å®‰å…¨è¿­ä»£å™¨ï¼ˆå¦‚WebæœåŠ¡å™¨ï¼‰

**âš ï¸ å¸¸è§è¯¯åŒº**
```
è¯¯åŒº1ï¼šè®¤ä¸ºåŠŸèƒ½è¶Šå¤šè¶Šå¥½
å®é™…ï¼šåº”è¯¥æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©æœ€é€‚åˆçš„å®ç°

è¯¯åŒº2ï¼šå¿½è§†æ€§èƒ½å¼€é”€
å®é™…ï¼šé«˜çº§è¿­ä»£å™¨é€šå¸¸æœ‰æ›´å¤§çš„æ€§èƒ½å¼€é”€

è¯¯åŒº3ï¼šåœ¨å•çº¿ç¨‹ç¯å¢ƒä½¿ç”¨å¹¶å‘å®‰å…¨è¿­ä»£å™¨
å®é™…ï¼šä¼šå¸¦æ¥ä¸å¿…è¦çš„æ€§èƒ½æŸå¤±

è¯¯åŒº4ï¼šè¿‡åº¦è®¾è®¡
å®é™…ï¼šå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç®€å•çš„å¤–éƒ¨è¿­ä»£å™¨å°±è¶³å¤Ÿäº†
```

**ğŸ”§ æœ€ä½³å®è·µ**
- æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©æœ€ç®€å•å¤Ÿç”¨çš„å®ç°
- åœ¨æ¥å£è®¾è®¡æ—¶è€ƒè™‘æœªæ¥çš„æ‰©å±•æ€§
- ä¸ºæ€§èƒ½å…³é”®çš„ä»£ç é€‰æ‹©åˆé€‚çš„è¿­ä»£å™¨ç±»å‹
- åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å§‹ç»ˆè€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜

**æ ¸å¿ƒè®°å¿†**ï¼š
- å†…éƒ¨è¿­ä»£å™¨ç®€å•æ˜“ç”¨ï¼Œå¤–éƒ¨è¿­ä»£å™¨çµæ´»å¯æ§
- åŒå‘è¿­ä»£å™¨èƒ½å‰åç§»åŠ¨ï¼Œéšæœºè®¿é—®è¿­ä»£å™¨èƒ½å¿«é€Ÿè·³è½¬
- å¹¶å‘å®‰å…¨è¿­ä»£å™¨ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä½†æ€§èƒ½æœ‰æ‰€ç‰ºç‰²
- é€‰æ‹©åŸåˆ™ï¼šå¤Ÿç”¨å°±å¥½ï¼Œä¸è¦è¿‡åº¦è®¾è®¡