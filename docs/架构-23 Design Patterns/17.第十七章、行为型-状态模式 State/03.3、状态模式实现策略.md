---
title: 3ã€çŠ¶æ€æ¨¡å¼å®ç°ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [çŠ¶æ€æ¨¡å¼å®ç°æ¦‚è¿°](#1-çŠ¶æ€æ¨¡å¼å®ç°æ¦‚è¿°)
2. [çŠ¶æ€è½¬æ¢è¡¨è®¾è®¡](#2-çŠ¶æ€è½¬æ¢è¡¨è®¾è®¡)
3. [çŠ¶æ€å·¥å‚è®¾è®¡](#3-çŠ¶æ€å·¥å‚è®¾è®¡)
4. [çŠ¶æ€ç¼“å­˜æœºåˆ¶](#4-çŠ¶æ€ç¼“å­˜æœºåˆ¶)
5. [çŠ¶æ€æŒä¹…åŒ–ç­–ç•¥](#5-çŠ¶æ€æŒä¹…åŒ–ç­–ç•¥)
6. [å¹¶å‘çŠ¶æ€å¤„ç†](#6-å¹¶å‘çŠ¶æ€å¤„ç†)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ çŠ¶æ€æ¨¡å¼å®ç°æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯çŠ¶æ€æ¨¡å¼å®ç°ç­–ç•¥


**é€šä¿—ç†è§£**ï¼šå°±åƒç”µè§†é¥æ§å™¨çš„è®¾è®¡ç­–ç•¥ä¸€æ ·ï¼ŒåŒä¸€ä¸ªæŒ‰é’®åœ¨ä¸åŒçŠ¶æ€ä¸‹æœ‰ä¸åŒåŠŸèƒ½

```
ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
ç”µè§†å…³æœºçŠ¶æ€ â†’ æŒ‰ç”µæºé”® â†’ å¼€æœº
ç”µè§†å¼€æœºçŠ¶æ€ â†’ æŒ‰ç”µæºé”® â†’ å…³æœº
ç”µè§†æ’­æ”¾çŠ¶æ€ â†’ æŒ‰éŸ³é‡é”® â†’ è°ƒèŠ‚éŸ³é‡
ç”µè§†é™éŸ³çŠ¶æ€ â†’ æŒ‰éŸ³é‡é”® â†’ å–æ¶ˆé™éŸ³

çŠ¶æ€æ¨¡å¼å°±æ˜¯ï¼šè®©å¯¹è±¡æ ¹æ®å½“å‰çŠ¶æ€è‡ªåŠ¨é€‰æ‹©ä¸åŒçš„è¡Œä¸ºæ–¹å¼
```

### 1.2 çŠ¶æ€æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
ä¼ ç»Ÿæ–¹å¼ï¼šç”¨å¤§é‡if-elseåˆ¤æ–­å½“å‰çŠ¶æ€
çŠ¶æ€æ¨¡å¼ï¼šæŠŠæ¯ç§çŠ¶æ€å°è£…æˆç‹¬ç«‹çš„ç±»

ä¼˜åŠ¿å¯¹æ¯”ï¼š
âŒ ä¼ ç»Ÿæ–¹å¼ï¼šä»£ç æ··ä¹±ï¼Œéš¾ç»´æŠ¤ï¼Œå®¹æ˜“å‡ºé”™
âœ… çŠ¶æ€æ¨¡å¼ï¼šé€»è¾‘æ¸…æ™°ï¼Œæ˜“æ‰©å±•ï¼ŒèŒè´£åˆ†æ˜
```

**ğŸ”¸ å®ç°ç­–ç•¥åˆ†ç±»**
- **çŠ¶æ€è½¬æ¢è¡¨**ï¼šç”¨è¡¨æ ¼ç®¡ç†çŠ¶æ€ä¹‹é—´çš„è½¬æ¢å…³ç³»
- **çŠ¶æ€å·¥å‚**ï¼šç»Ÿä¸€åˆ›å»ºå’Œç®¡ç†çŠ¶æ€å¯¹è±¡
- **çŠ¶æ€ç¼“å­˜**ï¼šæé«˜æ€§èƒ½ï¼Œé¿å…é‡å¤åˆ›å»ºçŠ¶æ€å¯¹è±¡
- **çŠ¶æ€æŒä¹…åŒ–**ï¼šå°†çŠ¶æ€ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“æˆ–æ–‡ä»¶
- **å¹¶å‘å¤„ç†**ï¼šå¤„ç†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„çŠ¶æ€å®‰å…¨é—®é¢˜

### 1.3 å®ç°ç­–ç•¥çš„é€‰æ‹©åŸåˆ™


| åº”ç”¨åœºæ™¯ | **æ¨èç­–ç•¥** | **åŸå› è¯´æ˜** |
|---------|-------------|-------------|
| ç®€å•çŠ¶æ€åˆ‡æ¢ | åŸºç¡€å®ç° | ä»£ç ç®€å•ï¼Œå®¹æ˜“ç†è§£ |
| å¤æ‚çŠ¶æ€å…³ç³» | çŠ¶æ€è½¬æ¢è¡¨ | å…³ç³»æ¸…æ™°ï¼Œä¾¿äºç®¡ç† |
| å¤§é‡çŠ¶æ€å¯¹è±¡ | çŠ¶æ€å·¥å‚+ç¼“å­˜ | æé«˜æ€§èƒ½ï¼Œç»Ÿä¸€ç®¡ç† |
| éœ€è¦ä¿å­˜çŠ¶æ€ | çŠ¶æ€æŒä¹…åŒ– | æ•°æ®ä¸ä¸¢å¤±ï¼Œå¯æ¢å¤ |
| å¤šçº¿ç¨‹ç¯å¢ƒ | å¹¶å‘çŠ¶æ€å¤„ç† | ä¿è¯çº¿ç¨‹å®‰å…¨ |

---

## 2. ğŸ“Š çŠ¶æ€è½¬æ¢è¡¨è®¾è®¡


### 2.1 ä»€ä¹ˆæ˜¯çŠ¶æ€è½¬æ¢è¡¨


**é€šä¿—è§£é‡Š**ï¼šå°±åƒæ¸¸æˆä¸­çš„æŠ€èƒ½æ ‘ï¼Œæ¸…æ¥šæ ‡æ˜ä»ä¸€ä¸ªçŠ¶æ€å¯ä»¥è½¬æ¢åˆ°å“ªäº›çŠ¶æ€

```
ä»¥è®¢å•çŠ¶æ€ä¸ºä¾‹çš„è½¬æ¢å…³ç³»ï¼š

å½“å‰çŠ¶æ€     è§¦å‘äº‹ä»¶      ç›®æ ‡çŠ¶æ€
å¾…æ”¯ä»˜   â†’   æ”¯ä»˜å®Œæˆ   â†’   å¾…å‘è´§
å¾…æ”¯ä»˜   â†’   å–æ¶ˆè®¢å•   â†’   å·²å–æ¶ˆ
å¾…å‘è´§   â†’   å•†å®¶å‘è´§   â†’   è¿è¾“ä¸­
è¿è¾“ä¸­   â†’   ç¡®è®¤æ”¶è´§   â†’   å·²å®Œæˆ
è¿è¾“ä¸­   â†’   ç”³è¯·é€€è´§   â†’   é€€è´§ä¸­
```

### 2.2 çŠ¶æ€è½¬æ¢è¡¨çš„å®ç°æ–¹å¼


**ğŸ”¸ æ–¹å¼ä¸€ï¼šäºŒç»´æ•°ç»„å®ç°**
```java
// å®šä¹‰çŠ¶æ€æšä¸¾
enum OrderState {
    WAITING_PAYMENT(0),    // å¾…æ”¯ä»˜
    WAITING_SHIPMENT(1),   // å¾…å‘è´§  
    SHIPPING(2),           // è¿è¾“ä¸­
    COMPLETED(3),          // å·²å®Œæˆ
    CANCELLED(4);          // å·²å–æ¶ˆ
    
    private final int code;
    OrderState(int code) { this.code = code; }
    public int getCode() { return code; }
}

// çŠ¶æ€è½¬æ¢è¡¨
public class StateTransitionTable {
    // è½¬æ¢è¡¨ï¼š[å½“å‰çŠ¶æ€][è§¦å‘äº‹ä»¶] = ç›®æ ‡çŠ¶æ€
    private static final OrderState[][] transitionTable = {
        // å¾…æ”¯ä»˜çŠ¶æ€ä¸‹çš„è½¬æ¢
        {null, OrderState.WAITING_SHIPMENT, null, null, OrderState.CANCELLED},
        // å¾…å‘è´§çŠ¶æ€ä¸‹çš„è½¬æ¢  
        {null, null, OrderState.SHIPPING, null, OrderState.CANCELLED},
        // è¿è¾“ä¸­çŠ¶æ€ä¸‹çš„è½¬æ¢
        {null, null, null, OrderState.COMPLETED, null},
        // å…¶ä»–çŠ¶æ€...
    };
    
    // æ£€æŸ¥çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•
    public boolean canTransition(OrderState current, int event) {
        OrderState target = transitionTable[current.getCode()][event];
        return target != null;
    }
}
```

**ğŸ”¸ æ–¹å¼äºŒï¼šMapé›†åˆå®ç°**
```java
public class StateTransitionMap {
    // ç”¨Mapå­˜å‚¨è½¬æ¢å…³ç³»ï¼Œæ›´çµæ´»
    private Map<String, OrderState> transitions = new HashMap<>();
    
    public StateTransitionMap() {
        // æ„å»ºè½¬æ¢å…³ç³»ï¼š"å½“å‰çŠ¶æ€-äº‹ä»¶" -> ç›®æ ‡çŠ¶æ€
        transitions.put("WAITING_PAYMENT-PAY", OrderState.WAITING_SHIPMENT);
        transitions.put("WAITING_PAYMENT-CANCEL", OrderState.CANCELLED);
        transitions.put("WAITING_SHIPMENT-SHIP", OrderState.SHIPPING);
        transitions.put("SHIPPING-COMPLETE", OrderState.COMPLETED);
    }
    
    // è·å–ä¸‹ä¸€ä¸ªçŠ¶æ€
    public OrderState getNextState(OrderState current, String event) {
        String key = current.name() + "-" + event;
        return transitions.get(key);
    }
}
```

### 2.3 è½¬æ¢è¡¨çš„ä¼˜åŠ¿ä¸åº”ç”¨


**âœ… ä¸»è¦ä¼˜åŠ¿**
- **é€»è¾‘æ¸…æ™°**ï¼šçŠ¶æ€å…³ç³»ä¸€ç›®äº†ç„¶
- **æ˜“äºç»´æŠ¤**ï¼šä¿®æ”¹è½¬æ¢è§„åˆ™åªéœ€æ›´æ–°è¡¨æ ¼
- **é˜²æ­¢é”™è¯¯**ï¼šè‡ªåŠ¨æ£€æŸ¥éæ³•çŠ¶æ€è½¬æ¢
- **ä¾¿äºæµ‹è¯•**ï¼šå¯ä»¥è½»æ¾éªŒè¯æ‰€æœ‰è½¬æ¢è·¯å¾„

**ğŸ¯ å®é™…åº”ç”¨åœºæ™¯**
```
å·¥ä½œæµç³»ç»Ÿï¼š
- è¯·å‡ç”³è¯·ï¼šæäº¤â†’å®¡æ‰¹â†’é€šè¿‡/æ‹’ç»
- æ–‡æ¡£å®¡æ ¸ï¼šè‰ç¨¿â†’å®¡æ ¸â†’å‘å¸ƒ

æ¸¸æˆå¼€å‘ï¼š
- è§’è‰²çŠ¶æ€ï¼šæ­£å¸¸â†’å—ä¼¤â†’æ­»äº¡â†’å¤æ´»
- æŠ€èƒ½çŠ¶æ€ï¼šå†·å´â†’å¯ç”¨â†’é‡Šæ”¾â†’å†·å´

ä¸šåŠ¡ç³»ç»Ÿï¼š
- è®¢å•æµç¨‹ï¼šä¸‹å•â†’æ”¯ä»˜â†’å‘è´§â†’å®Œæˆ
- ä¼šå‘˜ç­‰çº§ï¼šæ™®é€šâ†’VIPâ†’è¶…çº§VIP
```

---

## 3. ğŸ­ çŠ¶æ€å·¥å‚è®¾è®¡


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦çŠ¶æ€å·¥å‚


**é—®é¢˜åœºæ™¯**ï¼šå¦‚æœç›´æ¥ç”¨newåˆ›å»ºçŠ¶æ€å¯¹è±¡ï¼Œä¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼Ÿ

```
é—®é¢˜1ï¼šä»£ç é‡å¤
OrderState state1 = new WaitingPaymentState();
OrderState state2 = new WaitingShipmentState();
// æ¯æ¬¡éƒ½è¦newï¼Œå¾ˆéº»çƒ¦

é—®é¢˜2ï¼šç±»å‹å®‰å…¨
// å®¹æ˜“å†™é”™ç±»åï¼Œç¼–è¯‘å™¨å‘ç°ä¸äº†é€»è¾‘é”™è¯¯
OrderState state = new WaitingPaymentState(); // æƒ³è¦å‘è´§çŠ¶æ€å´åˆ›å»ºäº†æ”¯ä»˜çŠ¶æ€

é—®é¢˜3ï¼šç»´æŠ¤å›°éš¾
// å¦‚æœçŠ¶æ€ç±»æ„é€ å‡½æ•°æ”¹äº†ï¼Œæ‰€æœ‰åœ°æ–¹éƒ½è¦ä¿®æ”¹
```

**çŠ¶æ€å·¥å‚çš„è§£å†³æ–¹æ¡ˆ**ï¼šç»Ÿä¸€ç®¡ç†çŠ¶æ€å¯¹è±¡çš„åˆ›å»ºï¼Œå°±åƒæ±½è½¦å·¥å‚ç»Ÿä¸€ç”Ÿäº§æ±½è½¦ä¸€æ ·

### 3.2 çŠ¶æ€å·¥å‚çš„å®ç°æ–¹å¼


**ğŸ”¸ ç®€å•å·¥å‚æ¨¡å¼**
```java
public class OrderStateFactory {
    // æ ¹æ®çŠ¶æ€ç±»å‹åˆ›å»ºå¯¹åº”çš„çŠ¶æ€å¯¹è±¡
    public static OrderState createState(OrderStateType type) {
        switch (type) {
            case WAITING_PAYMENT:
                return new WaitingPaymentState();
            case WAITING_SHIPMENT:
                return new WaitingShipmentState();
            case SHIPPING:
                return new ShippingState();
            case COMPLETED:
                return new CompletedState();
            default:
                throw new IllegalArgumentException("æœªçŸ¥çš„çŠ¶æ€ç±»å‹: " + type);
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
OrderState paymentState = OrderStateFactory.createState(OrderStateType.WAITING_PAYMENT);
```

**ğŸ”¸ æ³¨å†Œå¼å·¥å‚æ¨¡å¼**
```java
public class AdvancedStateFactory {
    // æ³¨å†Œè¡¨ï¼šçŠ¶æ€åç§° -> çŠ¶æ€ç±»
    private static Map<String, Class<? extends OrderState>> stateRegistry = new HashMap<>();
    
    // æ³¨å†ŒçŠ¶æ€ç±»
    static {
        stateRegistry.put("WAITING_PAYMENT", WaitingPaymentState.class);
        stateRegistry.put("WAITING_SHIPMENT", WaitingShipmentState.class);
        stateRegistry.put("SHIPPING", ShippingState.class);
    }
    
    // åŠ¨æ€åˆ›å»ºçŠ¶æ€å¯¹è±¡
    public static OrderState createState(String stateName) {
        Class<? extends OrderState> stateClass = stateRegistry.get(stateName);
        if (stateClass == null) {
            throw new IllegalArgumentException("æœªæ³¨å†Œçš„çŠ¶æ€: " + stateName);
        }
        
        try {
            return stateClass.newInstance();
        } catch (Exception e) {
            throw new RuntimeException("åˆ›å»ºçŠ¶æ€å¤±è´¥: " + stateName, e);
        }
    }
}
```

### 3.3 å·¥å‚æ¨¡å¼çš„æ‰©å±•åŠŸèƒ½


**ğŸ”¸ å¸¦å‚æ•°çš„çŠ¶æ€åˆ›å»º**
```java
public class ParameterizedStateFactory {
    public static OrderState createState(OrderStateType type, OrderContext context) {
        switch (type) {
            case WAITING_PAYMENT:
                // å¯ä»¥ä¼ å…¥è¶…æ—¶æ—¶é—´ç­‰å‚æ•°
                return new WaitingPaymentState(context.getPaymentTimeout());
            case SHIPPING:
                // å¯ä»¥ä¼ å…¥ç‰©æµä¿¡æ¯ç­‰å‚æ•°
                return new ShippingState(context.getLogisticsInfo());
            default:
                return createState(type);
        }
    }
}
```

**ğŸ”¸ çŠ¶æ€å·¥å‚çš„é…ç½®åŒ–**
```java
// é€šè¿‡é…ç½®æ–‡ä»¶å®šä¹‰çŠ¶æ€æ˜ å°„å…³ç³»
public class ConfigurableStateFactory {
    private Properties stateConfig;
    
    public ConfigurableStateFactory() {
        stateConfig = loadConfig("state-mapping.properties");
    }
    
    public OrderState createState(String stateName) {
        String className = stateConfig.getProperty(stateName);
        // é€šè¿‡åå°„åˆ›å»ºçŠ¶æ€å¯¹è±¡
        return (OrderState) Class.forName(className).newInstance();
    }
}
```

---

## 4. âš¡ çŠ¶æ€ç¼“å­˜æœºåˆ¶


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦çŠ¶æ€ç¼“å­˜


**æ€§èƒ½é—®é¢˜åˆ†æ**ï¼šé¢‘ç¹åˆ›å»ºçŠ¶æ€å¯¹è±¡çš„ä»£ä»·

```
æ— ç¼“å­˜çš„é—®é¢˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¯æ¬¡çŠ¶æ€åˆ‡æ¢    â”‚ â†’ newå¯¹è±¡ â†’ å ç”¨å†…å­˜ â†’ GCå›æ”¶
â”‚ éƒ½åˆ›å»ºæ–°å¯¹è±¡    â”‚   (è€—æ—¶)    (æµªè´¹)    (å¡é¡¿)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœ‰ç¼“å­˜çš„å¥½å¤„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€å¯¹è±¡å¤ç”¨    â”‚ â†’ ä»ç¼“å­˜å– â†’ èŠ‚çœå†…å­˜ â†’ æ€§èƒ½æå‡
â”‚ é¿å…é‡å¤åˆ›å»º    â”‚   (å¿«é€Ÿ)     (ç¯ä¿)     (æµç•…)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 çŠ¶æ€ç¼“å­˜çš„å®ç°ç­–ç•¥


**ğŸ”¸ å•ä¾‹çŠ¶æ€ç¼“å­˜**
```java
public class SingletonStateCache {
    // æ¯ç§çŠ¶æ€åªåˆ›å»ºä¸€ä¸ªå®ä¾‹
    private static final Map<OrderStateType, OrderState> stateCache = new HashMap<>();
    
    public static OrderState getState(OrderStateType type) {
        // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå°±åˆ›å»ºä¸€ä¸ª
        return stateCache.computeIfAbsent(type, t -> {
            return OrderStateFactory.createState(t);
        });
    }
}

// ä½¿ç”¨æ–¹å¼
OrderState state = SingletonStateCache.getState(OrderStateType.WAITING_PAYMENT);
```

**ğŸ”¸ LRUç¼“å­˜ç­–ç•¥**
```java
public class LRUStateCache {
    private final int maxSize;
    private final LinkedHashMap<String, OrderState> cache;
    
    public LRUStateCache(int maxSize) {
        this.maxSize = maxSize;
        // LinkedHashMapæ”¯æŒLRUæ·˜æ±°ç­–ç•¥
        this.cache = new LinkedHashMap<String, OrderState>(16, 0.75f, true) {
            @Override
            protected boolean removeEldestEntry(Map.Entry<String, OrderState> eldest) {
                return size() > maxSize;
            }
        };
    }
    
    public synchronized OrderState getState(String stateKey) {
        OrderState state = cache.get(stateKey);
        if (state == null) {
            state = createNewState(stateKey);
            cache.put(stateKey, state);
        }
        return state;
    }
}
```

### 4.3 ç¼“å­˜ç­–ç•¥çš„é€‰æ‹©


| çŠ¶æ€ç‰¹ç‚¹ | **æ¨èç¼“å­˜ç­–ç•¥** | **é€‚ç”¨åœºæ™¯** |
|---------|-----------------|-------------|
| æ— çŠ¶æ€å¯¹è±¡ | å•ä¾‹ç¼“å­˜ | çŠ¶æ€å¯¹è±¡ä¸åŒ…å«å®ä¾‹æ•°æ® |
| æœ‰çŠ¶æ€å¯¹è±¡ | åŸå‹ç¼“å­˜ | éœ€è¦ä¸ºæ¯ä¸ªä¸Šä¸‹æ–‡åˆ›å»ºç‹¬ç«‹å®ä¾‹ |
| å¤§é‡çŠ¶æ€ç±» | LRUç¼“å­˜ | å†…å­˜æœ‰é™ï¼Œéœ€è¦æ·˜æ±°æœºåˆ¶ |
| ä¸´æ—¶çŠ¶æ€ | æ— ç¼“å­˜ | çŠ¶æ€ç”Ÿå‘½å‘¨æœŸå¾ˆçŸ­ |

**âš ï¸ ç¼“å­˜ä½¿ç”¨æ³¨æ„äº‹é¡¹**
- **çº¿ç¨‹å®‰å…¨**ï¼šå¤šçº¿ç¨‹ç¯å¢ƒä¸‹è¦åŠ é”æˆ–ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„é›†åˆ
- **å†…å­˜æ³„æ¼**ï¼šé•¿æœŸç¼“å­˜è¦æ³¨æ„åŠæ—¶æ¸…ç†æ— ç”¨å¯¹è±¡
- **çŠ¶æ€æ±¡æŸ“**ï¼šç¡®ä¿ç¼“å­˜çš„çŠ¶æ€å¯¹è±¡æ˜¯å¹²å‡€çš„ï¼Œæ²¡æœ‰æ®‹ç•™æ•°æ®

---

## 5. ğŸ’¾ çŠ¶æ€æŒä¹…åŒ–ç­–ç•¥


### 5.1 ä»€ä¹ˆæ˜¯çŠ¶æ€æŒä¹…åŒ–


**é€šä¿—è§£é‡Š**ï¼šå°±åƒæ¸¸æˆçš„å­˜æ¡£åŠŸèƒ½ï¼ŒæŠŠå½“å‰çŠ¶æ€ä¿å­˜èµ·æ¥ï¼Œä¸‹æ¬¡å¯ä»¥ç»§ç»­

```
ä¸ºä»€ä¹ˆéœ€è¦æŒä¹…åŒ–ï¼Ÿ

åœºæ™¯1ï¼šç³»ç»Ÿé‡å¯
- æœåŠ¡å™¨é‡å¯åï¼Œå†…å­˜ä¸­çš„çŠ¶æ€ä¸¢å¤±
- ç”¨æˆ·çš„è®¢å•çŠ¶æ€éœ€è¦æ¢å¤

åœºæ™¯2ï¼šå¼‚å¸¸æ¢å¤  
- ç¨‹åºå¼‚å¸¸é€€å‡ºæ—¶ï¼Œæ­£åœ¨å¤„ç†çš„çŠ¶æ€éœ€è¦ä¿å­˜
- é‡æ–°å¯åŠ¨åèƒ½ä»ä¸­æ–­å¤„ç»§ç»­

åœºæ™¯3ï¼šæ•°æ®åˆ†æ
- éœ€è¦åˆ†æçŠ¶æ€å˜åŒ–çš„å†å²è®°å½•
- ç»Ÿè®¡å„ç§çŠ¶æ€çš„åœç•™æ—¶é—´
```

### 5.2 çŠ¶æ€æŒä¹…åŒ–çš„å®ç°æ–¹å¼


**ğŸ”¸ æ•°æ®åº“æŒä¹…åŒ–**
```java
public class DatabaseStatePersistence {
    private DataSource dataSource;
    
    // ä¿å­˜çŠ¶æ€åˆ°æ•°æ®åº“
    public void saveState(String objectId, OrderState state, Date timestamp) {
        String sql = "INSERT INTO state_history (object_id, state_name, create_time) VALUES (?, ?, ?)";
        
        try (Connection conn = dataSource.getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {
            
            stmt.setString(1, objectId);
            stmt.setString(2, state.getClass().getSimpleName());
            stmt.setTimestamp(3, new Timestamp(timestamp.getTime()));
            stmt.executeUpdate();
            
        } catch (SQLException e) {
            throw new RuntimeException("ä¿å­˜çŠ¶æ€å¤±è´¥", e);
        }
    }
    
    // ä»æ•°æ®åº“æ¢å¤çŠ¶æ€
    public OrderState loadState(String objectId) {
        String sql = "SELECT state_name FROM state_history WHERE object_id = ? ORDER BY create_time DESC LIMIT 1";
        
        try (Connection conn = dataSource.getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {
            
            stmt.setString(1, objectId);
            ResultSet rs = stmt.executeQuery();
            
            if (rs.next()) {
                String stateName = rs.getString("state_name");
                return OrderStateFactory.createState(stateName);
            }
            
        } catch (SQLException e) {
            throw new RuntimeException("åŠ è½½çŠ¶æ€å¤±è´¥", e);
        }
        
        return null;
    }
}
```

**ğŸ”¸ æ–‡ä»¶æŒä¹…åŒ–**
```java
public class FileStatePersistence {
    private final String baseDir;
    
    public FileStatePersistence(String baseDir) {
        this.baseDir = baseDir;
        // ç¡®ä¿ç›®å½•å­˜åœ¨
        new File(baseDir).mkdirs();
    }
    
    // ä¿å­˜çŠ¶æ€åˆ°æ–‡ä»¶
    public void saveState(String objectId, OrderState state) {
        String fileName = baseDir + "/" + objectId + ".state";
        
        try (FileWriter writer = new FileWriter(fileName)) {
            // ç®€å•çš„æ ¼å¼ï¼šçŠ¶æ€ç±»å|æ—¶é—´æˆ³
            String content = state.getClass().getSimpleName() + "|" + System.currentTimeMillis();
            writer.write(content);
        } catch (IOException e) {
            throw new RuntimeException("ä¿å­˜çŠ¶æ€åˆ°æ–‡ä»¶å¤±è´¥", e);
        }
    }
    
    // ä»æ–‡ä»¶æ¢å¤çŠ¶æ€
    public OrderState loadState(String objectId) {
        String fileName = baseDir + "/" + objectId + ".state";
        File file = new File(fileName);
        
        if (!file.exists()) {
            return null;
        }
        
        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String content = reader.readLine();
            if (content != null) {
                String[] parts = content.split("\\|");
                String stateName = parts[0];
                return OrderStateFactory.createState(stateName);
            }
        } catch (IOException e) {
            throw new RuntimeException("ä»æ–‡ä»¶åŠ è½½çŠ¶æ€å¤±è´¥", e);
        }
        
        return null;
    }
}
```

### 5.3 æŒä¹…åŒ–ç­–ç•¥çš„å¯¹æ¯”


| æŒä¹…åŒ–æ–¹å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|-----------|---------|---------|-------------|
| æ•°æ®åº“ | æŸ¥è¯¢çµæ´»ã€æ”¯æŒäº‹åŠ¡ | é…ç½®å¤æ‚ã€ä¾èµ–æ•°æ®åº“ | ä¼ä¸šçº§åº”ç”¨ |
| æ–‡ä»¶ | ç®€å•æ˜“ç”¨ã€æ— ä¾èµ– | æŸ¥è¯¢ä¸ä¾¿ã€å¹¶å‘é—®é¢˜ | å°å‹åº”ç”¨ |
| å†…å­˜æ•°æ®åº“ | æ€§èƒ½æé«˜ã€åŠŸèƒ½ä¸°å¯Œ | é‡å¯ä¸¢å¤±ã€æˆæœ¬è¾ƒé«˜ | é«˜æ€§èƒ½åœºæ™¯ |
| æ¶ˆæ¯é˜Ÿåˆ— | å¼‚æ­¥å¤„ç†ã€é«˜å¯ç”¨ | å¤æ‚åº¦é«˜ã€ä¸€è‡´æ€§éš¾ä¿è¯ | åˆ†å¸ƒå¼ç³»ç»Ÿ |

---

## 6. ğŸ”„ å¹¶å‘çŠ¶æ€å¤„ç†


### 6.1 å¹¶å‘ç¯å¢ƒä¸‹çš„çŠ¶æ€é—®é¢˜


**é—®é¢˜åœºæ™¯åˆ†æ**ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œåŒä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€

```
é—®é¢˜åœºæ™¯ï¼šç”µå•†è®¢å•çŠ¶æ€å¹¶å‘ä¿®æ”¹

çº¿ç¨‹Aï¼šç”¨æˆ·ç‚¹å‡»"æ”¯ä»˜" â†’ æ£€æŸ¥çŠ¶æ€(å¾…æ”¯ä»˜) â†’ å‡†å¤‡æ”¹ä¸º"å·²æ”¯ä»˜"
çº¿ç¨‹Bï¼šç”¨æˆ·ç‚¹å‡»"å–æ¶ˆ" â†’ æ£€æŸ¥çŠ¶æ€(å¾…æ”¯ä»˜) â†’ å‡†å¤‡æ”¹ä¸º"å·²å–æ¶ˆ"

ç»“æœï¼šä¸¤ä¸ªæ“ä½œéƒ½è®¤ä¸ºçŠ¶æ€æ£€æŸ¥é€šè¿‡ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

æœŸæœ›ç»“æœï¼šåªæœ‰ä¸€ä¸ªæ“ä½œæˆåŠŸï¼Œå¦ä¸€ä¸ªæ“ä½œè¢«æ‹’ç»
```

### 6.2 å¹¶å‘æ§åˆ¶çš„è§£å†³æ–¹æ¡ˆ


**ğŸ”¸ æ–¹æ¡ˆä¸€ï¼šåŒæ­¥é”æœºåˆ¶**
```java
public class ThreadSafeOrderContext {
    private volatile OrderState currentState;
    private final Object stateLock = new Object();
    
    // çº¿ç¨‹å®‰å…¨çš„çŠ¶æ€åˆ‡æ¢
    public boolean changeState(OrderState newState) {
        synchronized (stateLock) {
            // æ£€æŸ¥çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•
            if (currentState.canTransitionTo(newState)) {
                // æ‰§è¡ŒçŠ¶æ€è½¬æ¢
                currentState.exit(); // é€€å‡ºå½“å‰çŠ¶æ€
                currentState = newState;
                currentState.enter(); // è¿›å…¥æ–°çŠ¶æ€
                return true;
            }
            return false;
        }
    }
    
    // è·å–å½“å‰çŠ¶æ€ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
    public OrderState getCurrentState() {
        synchronized (stateLock) {
            return currentState;
        }
    }
}
```

**ğŸ”¸ æ–¹æ¡ˆäºŒï¼šä¹è§‚é”æœºåˆ¶**
```java
public class OptimisticLockOrderContext {
    private volatile OrderState currentState;
    private final AtomicInteger version = new AtomicInteger(0);
    
    // ä¹è§‚é”çŠ¶æ€æ›´æ–°
    public boolean compareAndSwapState(OrderState expectedState, OrderState newState) {
        // æ£€æŸ¥å½“å‰çŠ¶æ€æ˜¯å¦ç¬¦åˆé¢„æœŸ
        if (currentState == expectedState) {
            synchronized (this) {
                // åŒé‡æ£€æŸ¥
                if (currentState == expectedState) {
                    currentState = newState;
                    version.incrementAndGet(); // ç‰ˆæœ¬å·+1
                    return true;
                }
            }
        }
        return false;
    }
    
    // è·å–çŠ¶æ€å’Œç‰ˆæœ¬å·
    public StateSnapshot getStateSnapshot() {
        return new StateSnapshot(currentState, version.get());
    }
}

// çŠ¶æ€å¿«ç…§ç±»
class StateSnapshot {
    private final OrderState state;
    private final int version;
    
    public StateSnapshot(OrderState state, int version) {
        this.state = state;
        this.version = version;
    }
    
    // getteræ–¹æ³•...
}
```

**ğŸ”¸ æ–¹æ¡ˆä¸‰ï¼šä¸å¯å˜çŠ¶æ€å¯¹è±¡**
```java
public class ImmutableStateContext {
    private volatile StateInfo stateInfo;
    
    // çŠ¶æ€ä¿¡æ¯ä¸å¯å˜ç±»
    public static class StateInfo {
        private final OrderState state;
        private final long timestamp;
        private final String reason;
        
        public StateInfo(OrderState state, String reason) {
            this.state = state;
            this.timestamp = System.currentTimeMillis();
            this.reason = reason;
        }
        
        // åˆ›å»ºæ–°çš„çŠ¶æ€ä¿¡æ¯
        public StateInfo withNewState(OrderState newState, String reason) {
            return new StateInfo(newState, reason);
        }
        
        // åªæä¾›getteræ–¹æ³•ï¼Œç¡®ä¿ä¸å¯å˜
        public OrderState getState() { return state; }
        public long getTimestamp() { return timestamp; }
        public String getReason() { return reason; }
    }
    
    // åŸå­æ€§çŠ¶æ€æ›´æ–°
    public boolean updateState(OrderState newState, String reason) {
        StateInfo oldInfo, newInfo;
        do {
            oldInfo = stateInfo;
            // æ£€æŸ¥çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•
            if (!oldInfo.getState().canTransitionTo(newState)) {
                return false;
            }
            newInfo = oldInfo.withNewState(newState, reason);
        } while (!compareAndSet(oldInfo, newInfo));
        
        return true;
    }
    
    // CASæ“ä½œ
    private boolean compareAndSet(StateInfo expected, StateInfo update) {
        // ä½¿ç”¨AtomicReferenceå®ç°
        return true; // ç®€åŒ–å®ç°
    }
}
```

### 6.3 å¹¶å‘å¤„ç†ç­–ç•¥é€‰æ‹©


**ğŸ¯ ç­–ç•¥é€‰æ‹©æŒ‡å—**

```
é€‰æ‹©æ ‡å‡†ï¼š

è¯»å¤šå†™å°‘åœºæ™¯ï¼š
â†’ ä½¿ç”¨è¯»å†™é”(ReadWriteLock)
â†’ è¯»æ“ä½œä¸é˜»å¡ï¼Œå†™æ“ä½œç‹¬å 

å†™æ“ä½œé¢‘ç¹åœºæ™¯ï¼š
â†’ ä½¿ç”¨ä¹è§‚é”(CAS)
â†’ å‡å°‘é”ç­‰å¾…æ—¶é—´

ä¸¥æ ¼ä¸€è‡´æ€§è¦æ±‚ï¼š
â†’ ä½¿ç”¨æ‚²è§‚é”(synchronized)
â†’ ç¡®ä¿æ“ä½œåŸå­æ€§

é«˜æ€§èƒ½è¦æ±‚ï¼š
â†’ ä½¿ç”¨æ— é”è®¾è®¡
â†’ ä¸å¯å˜å¯¹è±¡+CASæ“ä½œ
```

**âš ï¸ å¹¶å‘å¤„ç†æ³¨æ„äº‹é¡¹**
- **æ­»é”é¢„é˜²**ï¼šé¿å…å¾ªç¯ç­‰å¾…ï¼Œç»Ÿä¸€åŠ é”é¡ºåº
- **æ€§èƒ½å¹³è¡¡**ï¼šåœ¨ä¸€è‡´æ€§å’Œæ€§èƒ½ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ç‚¹
- **å¼‚å¸¸å¤„ç†**ï¼šç¡®ä¿å¼‚å¸¸æƒ…å†µä¸‹é”èƒ½æ­£ç¡®é‡Šæ”¾
- **æµ‹è¯•å……åˆ†**ï¼šå¹¶å‘é—®é¢˜éš¾ä»¥å¤ç°ï¼Œéœ€è¦å……åˆ†çš„å¹¶å‘æµ‹è¯•

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ çŠ¶æ€è½¬æ¢è¡¨ï¼šæ¸…æ™°ç®¡ç†çŠ¶æ€ä¹‹é—´çš„è½¬æ¢å…³ç³»ï¼Œé˜²æ­¢éæ³•è½¬æ¢
ğŸ”¸ çŠ¶æ€å·¥å‚ï¼šç»Ÿä¸€åˆ›å»ºå’Œç®¡ç†çŠ¶æ€å¯¹è±¡ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§
ğŸ”¸ çŠ¶æ€ç¼“å­˜ï¼šé¿å…é‡å¤åˆ›å»ºçŠ¶æ€å¯¹è±¡ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½
ğŸ”¸ çŠ¶æ€æŒä¹…åŒ–ï¼šä¿å­˜çŠ¶æ€ä¿¡æ¯ï¼Œæ”¯æŒç³»ç»Ÿæ¢å¤å’Œæ•°æ®åˆ†æ
ğŸ”¸ å¹¶å‘å¤„ç†ï¼šç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çŠ¶æ€æ“ä½œçš„å®‰å…¨æ€§å’Œä¸€è‡´æ€§
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å®ç°ç­–ç•¥çš„æœ¬è´¨**
```
æ ¸å¿ƒç›®æ ‡ï¼š
- è®©çŠ¶æ€æ¨¡å¼æ›´å¥½ç”¨ã€æ›´é«˜æ•ˆã€æ›´å®‰å…¨
- è§£å†³å®é™…é¡¹ç›®ä¸­é‡åˆ°çš„å…·ä½“é—®é¢˜
- åœ¨æ€§èƒ½ã€å®‰å…¨ã€å¯ç»´æŠ¤æ€§ä¹‹é—´æ‰¾å¹³è¡¡

è®¾è®¡åŸåˆ™ï¼š
- å•ä¸€èŒè´£ï¼šæ¯ä¸ªç»„ä»¶ä¸“æ³¨è§£å†³ä¸€ç±»é—®é¢˜
- å¼€é—­åŸåˆ™ï¼šæ˜“äºæ‰©å±•æ–°çš„çŠ¶æ€å’Œç­–ç•¥
- ä¾èµ–å€’ç½®ï¼šä¾èµ–æŠ½è±¡è€Œä¸æ˜¯å…·ä½“å®ç°
```

**ğŸ”¹ ç­–ç•¥ç»„åˆä½¿ç”¨**
```
åŸºç¡€ç‰ˆæœ¬ï¼šçŠ¶æ€æ¨¡å¼ + ç®€å•å·¥å‚
è¿›é˜¶ç‰ˆæœ¬ï¼š+ çŠ¶æ€ç¼“å­˜ + è½¬æ¢è¡¨
ä¼ä¸šç‰ˆæœ¬ï¼š+ æŒä¹…åŒ– + å¹¶å‘æ§åˆ¶ + ç›‘æ§æ—¥å¿—

é€‰æ‹©å»ºè®®ï¼š
- ç®€å•åº”ç”¨ï¼šåŸºç¡€ç‰ˆæœ¬è¶³å¤Ÿ
- é«˜å¹¶å‘åº”ç”¨ï¼šå¿…é¡»è€ƒè™‘å¹¶å‘æ§åˆ¶
- ä¼ä¸šåº”ç”¨ï¼šéœ€è¦å®Œæ•´çš„è§£å†³æ–¹æ¡ˆ
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç”µå•†ç³»ç»Ÿ**ï¼šè®¢å•çŠ¶æ€ç®¡ç†ã€æ”¯ä»˜æµç¨‹æ§åˆ¶
- **å·¥ä½œæµç³»ç»Ÿ**ï¼šå®¡æ‰¹æµç¨‹ã€ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª
- **æ¸¸æˆå¼€å‘**ï¼šè§’è‰²çŠ¶æ€ã€æŠ€èƒ½å†·å´ã€å…³å¡è¿›åº¦
- **ç‰©è”ç½‘**ï¼šè®¾å¤‡çŠ¶æ€ç›‘æ§ã€è‡ªåŠ¨åŒ–æ§åˆ¶

**ğŸ”§ æŠ€æœ¯å®è·µè¦ç‚¹**
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†ä½¿ç”¨ç¼“å­˜ï¼Œé¿å…è¿‡åº¦è®¾è®¡
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
- **æµ‹è¯•ç­–ç•¥**ï¼šçŠ¶æ€è½¬æ¢çš„å®Œæ•´æ€§æµ‹è¯•å’Œå¹¶å‘æµ‹è¯•
- **ç›‘æ§è¿ç»´**ï¼šçŠ¶æ€å˜åŒ–çš„ç›‘æ§å’ŒæŠ¥è­¦æœºåˆ¶

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- çŠ¶æ€è½¬æ¢è¡¨è®©å…³ç³»æ›´æ¸…æ™°ï¼Œå·¥å‚æ¨¡å¼è®©åˆ›å»ºæ›´ç»Ÿä¸€
- ç¼“å­˜æœºåˆ¶æå‡æ€§èƒ½ï¼ŒæŒä¹…åŒ–ä¿è¯æ•°æ®ä¸ä¸¢å¤±
- å¹¶å‘æ§åˆ¶ä¿è¯å®‰å…¨ï¼Œç­–ç•¥ç»„åˆè§£å†³å¤æ‚é—®é¢˜
- å®ç°ç­–ç•¥æœåŠ¡äºä¸šåŠ¡éœ€æ±‚ï¼Œä¸è¦ä¸ºäº†æŠ€æœ¯è€ŒæŠ€æœ¯