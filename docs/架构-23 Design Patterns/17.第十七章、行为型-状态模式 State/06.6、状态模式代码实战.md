---
title: 6ã€çŠ¶æ€æ¨¡å¼ä»£ç å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [çŠ¶æ€æ¨¡å¼å®æˆ˜æ¦‚è¿°](#1-çŠ¶æ€æ¨¡å¼å®æˆ˜æ¦‚è¿°)
2. [è®¢å•çŠ¶æ€æœºæ ¸å¿ƒå®ç°](#2-è®¢å•çŠ¶æ€æœºæ ¸å¿ƒå®ç°)
3. [çŠ¶æ€è½¬æ¢æ¼”ç¤ºä¸æµ‹è¯•](#3-çŠ¶æ€è½¬æ¢æ¼”ç¤ºä¸æµ‹è¯•)
4. [å¹¶å‘å®‰å…¨å¤„ç†æ–¹æ¡ˆ](#4-å¹¶å‘å®‰å…¨å¤„ç†æ–¹æ¡ˆ)
5. [å·¥ä½œæµå¼•æ“åº”ç”¨å®è·µ](#5-å·¥ä½œæµå¼•æ“åº”ç”¨å®è·µ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ çŠ¶æ€æ¨¡å¼å®æˆ˜æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯çŠ¶æ€æ¨¡å¼å®æˆ˜


**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
çŠ¶æ€æ¨¡å¼å®æˆ˜å°±æ˜¯æŠŠç†è®ºåº”ç”¨åˆ°çœŸå®çš„ä¸šåŠ¡åœºæ™¯ä¸­ã€‚å°±åƒå­¦ä¼šäº†å¼€è½¦ç†è®ºï¼Œç°åœ¨è¦ä¸Šè·¯å®é™…é©¾é©¶ä¸€æ ·ã€‚

```
ç”Ÿæ´»ä¸­çš„çŠ¶æ€è½¬æ¢ï¼š
è®¢é¤æµç¨‹ï¼šä¸‹å• â†’ æ”¯ä»˜ â†’ åˆ¶ä½œ â†’ é…é€ â†’ å®Œæˆ
æ¯ä¸ªé˜¶æ®µéƒ½æœ‰ç‰¹å®šçš„æ“ä½œå’Œè§„åˆ™

ä»£ç ä¸­çš„çŠ¶æ€æ¨¡å¼ï¼š
æŠŠæ¯ä¸ªçŠ¶æ€å†™æˆç‹¬ç«‹çš„ç±»
è®©å¯¹è±¡æ ¹æ®çŠ¶æ€è‡ªåŠ¨åˆ‡æ¢è¡Œä¸º
```

**ğŸ” æ ¸å¿ƒä»·å€¼**ï¼š
- **æ¶ˆé™¤å¤æ‚if-else**ï¼šä¸ç”¨å†™ä¸€å †åˆ¤æ–­è¯­å¥
- **èŒè´£åˆ†ç¦»æ¸…æ™°**ï¼šæ¯ä¸ªçŠ¶æ€åªç®¡è‡ªå·±çš„äº‹
- **æ‰©å±•ç»´æŠ¤ç®€å•**ï¼šæ–°å¢çŠ¶æ€ä¸å½±å“ç°æœ‰ä»£ç 
- **ä¸šåŠ¡é€»è¾‘ç›´è§‚**ï¼šä»£ç ç»“æ„å’Œä¸šåŠ¡æµç¨‹ä¸€è‡´

### 1.2 å®æˆ˜åœºæ™¯é€‰æ‹©


**ğŸ“‹ å¸¸è§åº”ç”¨åœºæ™¯**ï¼š

| ä¸šåŠ¡åœºæ™¯ | çŠ¶æ€æ•°é‡ | **å¤æ‚åº¦** | **é€‚ç”¨æ€§** |
|---------|---------|-----------|-----------|
| ğŸ›’ **è®¢å•ç®¡ç†** | `5-8ä¸ª` | `ä¸­ç­‰` | `â­â­â­â­â­` |
| ğŸ® **æ¸¸æˆè§’è‰²** | `3-6ä¸ª` | `ç®€å•` | `â­â­â­â­` |
| ğŸ“‹ **å®¡æ‰¹æµç¨‹** | `6-10ä¸ª` | `å¤æ‚` | `â­â­â­â­â­` |
| ğŸš— **äº¤é€šä¿¡å·** | `3ä¸ª` | `ç®€å•` | `â­â­â­` |

> ğŸ’¡ **é€‰æ‹©å»ºè®®**
> æˆ‘ä»¬é€‰æ‹©**è®¢å•ç®¡ç†**ä½œä¸ºå®æˆ˜æ¡ˆä¾‹ï¼Œå› ä¸ºå®ƒä¸šåŠ¡æ¸…æ™°ã€çŠ¶æ€é€‚ä¸­ã€å®¹æ˜“ç†è§£

---

## 2. ğŸ›’ è®¢å•çŠ¶æ€æœºæ ¸å¿ƒå®ç°


### 2.1 è®¢å•çŠ¶æ€åˆ†æ


**ğŸ“Š è®¢å•ç”Ÿå‘½å‘¨æœŸ**ï¼š
```
è®¢å•çŠ¶æ€æµè½¬å›¾ï¼š
    
    [æ–°å»º] â”€â”€æ”¯ä»˜â”€â”€â†’ [å·²æ”¯ä»˜] â”€â”€å‘è´§â”€â”€â†’ [å·²å‘è´§]
      â”‚                           â”‚
      â”‚                           â†“
    å–æ¶ˆ â†“                     [å·²æ”¶è´§]
      â”‚                           â”‚
      â†“                         ç¡®è®¤ â†“
    [å·²å–æ¶ˆ]                   [å·²å®Œæˆ]
      â†‘                           â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€ é€€æ¬¾ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”‘ çŠ¶æ€å®šä¹‰**ï¼š
- **æ–°å»ºçŠ¶æ€**ï¼šåˆšä¸‹å•ï¼Œå¯ä»¥æ”¯ä»˜æˆ–å–æ¶ˆ
- **å·²æ”¯ä»˜çŠ¶æ€**ï¼šä»˜æ¬¾å®Œæˆï¼Œç­‰å¾…å‘è´§
- **å·²å‘è´§çŠ¶æ€**ï¼šå•†å“åœ¨è·¯ä¸Šï¼Œç­‰å¾…æ”¶è´§
- **å·²æ”¶è´§çŠ¶æ€**ï¼šç¡®è®¤æ”¶è´§ï¼Œå¯ä»¥å®Œæˆæˆ–é€€æ¬¾
- **å·²å®ŒæˆçŠ¶æ€**ï¼šäº¤æ˜“ç»“æŸ
- **å·²å–æ¶ˆçŠ¶æ€**ï¼šè®¢å•å–æ¶ˆ

### 2.2 çŠ¶æ€æ¥å£è®¾è®¡


```java
// è®¢å•çŠ¶æ€æ¥å£ - å®šä¹‰æ‰€æœ‰çŠ¶æ€çš„é€šç”¨è¡Œä¸º
public interface OrderState {
    
    // æ”¯ä»˜æ“ä½œ
    void pay(OrderContext context);
    
    // å‘è´§æ“ä½œ
    void ship(OrderContext context);
    
    // æ”¶è´§æ“ä½œ  
    void receive(OrderContext context);
    
    // å®Œæˆæ“ä½œ
    void complete(OrderContext context);
    
    // å–æ¶ˆæ“ä½œ
    void cancel(OrderContext context);
    
    // é€€æ¬¾æ“ä½œ
    void refund(OrderContext context);
    
    // è·å–çŠ¶æ€åç§°
    String getStateName();
}
```

> ğŸ” **è®¾è®¡è¦ç‚¹**
> æ¯ä¸ªçŠ¶æ€éƒ½è¦å®ç°æ‰€æœ‰æ–¹æ³•ï¼Œä½†åªæœ‰å½“å‰çŠ¶æ€å…è®¸çš„æ“ä½œæ‰ä¼šæ‰§è¡Œ

### 2.3 è®¢å•ä¸Šä¸‹æ–‡ç±»


```java
// è®¢å•ä¸Šä¸‹æ–‡ - ç»´æŠ¤å½“å‰çŠ¶æ€å’Œè®¢å•ä¿¡æ¯
public class OrderContext {
    private OrderState currentState;    // å½“å‰çŠ¶æ€
    private String orderId;            // è®¢å•ID
    private String productName;        // å•†å“åç§°
    private double amount;             // è®¢å•é‡‘é¢
    
    public OrderContext(String orderId, String productName, double amount) {
        this.orderId = orderId;
        this.productName = productName;
        this.amount = amount;
        // åˆå§‹çŠ¶æ€ä¸ºæ–°å»º
        this.currentState = new NewOrderState();
    }
    
    // çŠ¶æ€è½¬æ¢æ–¹æ³•
    public void setState(OrderState state) {
        System.out.println("è®¢å•çŠ¶æ€ä» [" + currentState.getStateName() + 
                          "] è½¬æ¢ä¸º [" + state.getStateName() + "]");
        this.currentState = state;
    }
    
    // å§”æ‰˜ç»™å½“å‰çŠ¶æ€å¤„ç†çš„æ–¹æ³•
    public void pay() { currentState.pay(this); }
    public void ship() { currentState.ship(this); }
    public void receive() { currentState.receive(this); }
    public void complete() { currentState.complete(this); }
    public void cancel() { currentState.cancel(this); }
    public void refund() { currentState.refund(this); }
    
    // getteræ–¹æ³•
    public String getOrderId() { return orderId; }
    public String getProductName() { return productName; }
    public double getAmount() { return amount; }
    public String getCurrentStateName() { return currentState.getStateName(); }
}
```

### 2.4 å…·ä½“çŠ¶æ€å®ç°


**ğŸŸ¢ æ–°å»ºçŠ¶æ€**ï¼š
```java
public class NewOrderState implements OrderState {
    
    @Override
    public void pay(OrderContext context) {
        System.out.println("è®¢å•æ”¯ä»˜æˆåŠŸï¼Œé‡‘é¢ï¼š" + context.getAmount());
        // çŠ¶æ€è½¬æ¢ï¼šæ–°å»º â†’ å·²æ”¯ä»˜
        context.setState(new PaidOrderState());
    }
    
    @Override
    public void cancel(OrderContext context) {
        System.out.println("è®¢å•å·²å–æ¶ˆ");
        // çŠ¶æ€è½¬æ¢ï¼šæ–°å»º â†’ å·²å–æ¶ˆ
        context.setState(new CancelledOrderState());
    }
    
    // å…¶ä»–æ“ä½œåœ¨æ–°å»ºçŠ¶æ€ä¸‹ä¸å…è®¸
    @Override
    public void ship(OrderContext context) {
        System.out.println("âŒ è®¢å•æœªæ”¯ä»˜ï¼Œæ— æ³•å‘è´§");
    }
    
    @Override
    public void receive(OrderContext context) {
        System.out.println("âŒ è®¢å•æœªå‘è´§ï¼Œæ— æ³•æ”¶è´§");
    }
    
    @Override
    public void complete(OrderContext context) {
        System.out.println("âŒ è®¢å•æœªå®Œæˆæ”¯ä»˜æµç¨‹");
    }
    
    @Override
    public void refund(OrderContext context) {
        System.out.println("âŒ è®¢å•æœªæ”¯ä»˜ï¼Œæ— æ³•é€€æ¬¾");
    }
    
    @Override
    public String getStateName() {
        return "æ–°å»º";
    }
}
```

**ğŸ”µ å·²æ”¯ä»˜çŠ¶æ€**ï¼š
```java
public class PaidOrderState implements OrderState {
    
    @Override
    public void ship(OrderContext context) {
        System.out.println("è®¢å•å¼€å§‹å‘è´§ï¼Œå•†å“ï¼š" + context.getProductName());
        // çŠ¶æ€è½¬æ¢ï¼šå·²æ”¯ä»˜ â†’ å·²å‘è´§
        context.setState(new ShippedOrderState());
    }
    
    @Override
    public void cancel(OrderContext context) {
        System.out.println("æ”¯ä»˜åå–æ¶ˆè®¢å•ï¼Œå‡†å¤‡é€€æ¬¾");
        // çŠ¶æ€è½¬æ¢ï¼šå·²æ”¯ä»˜ â†’ å·²å–æ¶ˆ
        context.setState(new CancelledOrderState());
    }
    
    // å·²æ”¯ä»˜çŠ¶æ€ä¸‹ä¸å…è®¸çš„æ“ä½œ
    @Override
    public void pay(OrderContext context) {
        System.out.println("âŒ è®¢å•å·²æ”¯ä»˜ï¼Œè¯·å‹¿é‡å¤æ”¯ä»˜");
    }
    
    @Override
    public void receive(OrderContext context) {
        System.out.println("âŒ è®¢å•æœªå‘è´§ï¼Œæ— æ³•æ”¶è´§");
    }
    
    @Override
    public void complete(OrderContext context) {
        System.out.println("âŒ è®¢å•æœªå®Œæˆå‘è´§æµç¨‹");
    }
    
    @Override
    public void refund(OrderContext context) {
        System.out.println("å¤„ç†é€€æ¬¾ï¼Œé‡‘é¢ï¼š" + context.getAmount());
        context.setState(new CancelledOrderState());
    }
    
    @Override
    public String getStateName() {
        return "å·²æ”¯ä»˜";
    }
}
```

**ğŸŸ¡ å·²å‘è´§çŠ¶æ€**ï¼š
```java
public class ShippedOrderState implements OrderState {
    
    @Override
    public void receive(OrderContext context) {
        System.out.println("ç”¨æˆ·ç¡®è®¤æ”¶è´§ï¼Œå•†å“ï¼š" + context.getProductName());
        // çŠ¶æ€è½¬æ¢ï¼šå·²å‘è´§ â†’ å·²æ”¶è´§
        context.setState(new ReceivedOrderState());
    }
    
    // å·²å‘è´§çŠ¶æ€ä¸‹ä¸å…è®¸çš„æ“ä½œ
    @Override
    public void pay(OrderContext context) {
        System.out.println("âŒ è®¢å•å·²æ”¯ä»˜");
    }
    
    @Override
    public void ship(OrderContext context) {
        System.out.println("âŒ è®¢å•å·²å‘è´§");
    }
    
    @Override
    public void complete(OrderContext context) {
        System.out.println("âŒ è¯·å…ˆç¡®è®¤æ”¶è´§");
    }
    
    @Override
    public void cancel(OrderContext context) {
        System.out.println("âŒ å•†å“å·²å‘è´§ï¼Œæ— æ³•å–æ¶ˆ");
    }
    
    @Override
    public void refund(OrderContext context) {
        System.out.println("âŒ è¯·å…ˆç¡®è®¤æ”¶è´§å†ç”³è¯·é€€æ¬¾");
    }
    
    @Override
    public String getStateName() {
        return "å·²å‘è´§";
    }
}
```

---

## 3. ğŸ”„ çŠ¶æ€è½¬æ¢æ¼”ç¤ºä¸æµ‹è¯•


### 3.1 æ­£å¸¸æµç¨‹æ¼”ç¤º


```java
public class OrderStateDemo {
    
    public static void main(String[] args) {
        // åˆ›å»ºè®¢å•
        OrderContext order = new OrderContext("ORD001", "iPhone 15", 8999.0);
        
        System.out.println("=== è®¢å•æ­£å¸¸æµç¨‹æ¼”ç¤º ===");
        System.out.println("å½“å‰çŠ¶æ€ï¼š" + order.getCurrentStateName());
        
        // 1. æ”¯ä»˜è®¢å•
        System.out.println("\n>>> æ­¥éª¤1ï¼šæ”¯ä»˜è®¢å•");
        order.pay();
        
        // 2. å‘è´§
        System.out.println("\n>>> æ­¥éª¤2ï¼šå•†å®¶å‘è´§");
        order.ship();
        
        // 3. æ”¶è´§
        System.out.println("\n>>> æ­¥éª¤3ï¼šç”¨æˆ·æ”¶è´§");
        order.receive();
        
        // 4. å®Œæˆè®¢å•
        System.out.println("\n>>> æ­¥éª¤4ï¼šå®Œæˆè®¢å•");
        order.complete();
        
        System.out.println("\næœ€ç»ˆçŠ¶æ€ï¼š" + order.getCurrentStateName());
    }
}
```

**ğŸ“‹ æ‰§è¡Œç»“æœ**ï¼š
```
=== è®¢å•æ­£å¸¸æµç¨‹æ¼”ç¤º ===
å½“å‰çŠ¶æ€ï¼šæ–°å»º

>>> æ­¥éª¤1ï¼šæ”¯ä»˜è®¢å•
è®¢å•æ”¯ä»˜æˆåŠŸï¼Œé‡‘é¢ï¼š8999.0
è®¢å•çŠ¶æ€ä» [æ–°å»º] è½¬æ¢ä¸º [å·²æ”¯ä»˜]

>>> æ­¥éª¤2ï¼šå•†å®¶å‘è´§  
è®¢å•å¼€å§‹å‘è´§ï¼Œå•†å“ï¼šiPhone 15
è®¢å•çŠ¶æ€ä» [å·²æ”¯ä»˜] è½¬æ¢ä¸º [å·²å‘è´§]

>>> æ­¥éª¤3ï¼šç”¨æˆ·æ”¶è´§
ç”¨æˆ·ç¡®è®¤æ”¶è´§ï¼Œå•†å“ï¼šiPhone 15
è®¢å•çŠ¶æ€ä» [å·²å‘è´§] è½¬æ¢ä¸º [å·²æ”¶è´§]

>>> æ­¥éª¤4ï¼šå®Œæˆè®¢å•
è®¢å•äº¤æ˜“å®Œæˆ
è®¢å•çŠ¶æ€ä» [å·²æ”¶è´§] è½¬æ¢ä¸º [å·²å®Œæˆ]

æœ€ç»ˆçŠ¶æ€ï¼šå·²å®Œæˆ
```

### 3.2 å¼‚å¸¸æ“ä½œæµ‹è¯•


```java
public class OrderErrorDemo {
    
    public static void testInvalidOperations() {
        OrderContext order = new OrderContext("ORD002", "MacBook Pro", 15999.0);
        
        System.out.println("=== æ— æ•ˆæ“ä½œæµ‹è¯• ===");
        
        // æ–°å»ºçŠ¶æ€ä¸‹å°è¯•å‘è´§
        System.out.println("\n>>> æµ‹è¯•ï¼šæœªæ”¯ä»˜ç›´æ¥å‘è´§");
        order.ship();  // åº”è¯¥å¤±è´¥
        
        // æ–°å»ºçŠ¶æ€ä¸‹å°è¯•æ”¶è´§
        System.out.println("\n>>> æµ‹è¯•ï¼šæœªæ”¯ä»˜ç›´æ¥æ”¶è´§");
        order.receive();  // åº”è¯¥å¤±è´¥
        
        // æ”¯ä»˜åæµ‹è¯•
        order.pay();
        System.out.println("\n>>> æµ‹è¯•ï¼šé‡å¤æ”¯ä»˜");
        order.pay();  // åº”è¯¥å¤±è´¥
        
        System.out.println("\nå½“å‰çŠ¶æ€ï¼š" + order.getCurrentStateName());
    }
}
```

### 3.3 çŠ¶æ€è½¬æ¢éªŒè¯


**ğŸ” çŠ¶æ€è½¬æ¢è§„åˆ™è¡¨**ï¼š

| å½“å‰çŠ¶æ€ | **å…è®¸æ“ä½œ** | **è½¬æ¢ç›®æ ‡** | **ç¦æ­¢æ“ä½œ** |
|---------|------------|------------|------------|
| ğŸŸ¢ **æ–°å»º** | `æ”¯ä»˜ã€å–æ¶ˆ` | `å·²æ”¯ä»˜ã€å·²å–æ¶ˆ` | `å‘è´§ã€æ”¶è´§ã€å®Œæˆã€é€€æ¬¾` |
| ğŸ”µ **å·²æ”¯ä»˜** | `å‘è´§ã€å–æ¶ˆã€é€€æ¬¾` | `å·²å‘è´§ã€å·²å–æ¶ˆ` | `æ”¯ä»˜ã€æ”¶è´§ã€å®Œæˆ` |
| ğŸŸ¡ **å·²å‘è´§** | `æ”¶è´§` | `å·²æ”¶è´§` | `æ”¯ä»˜ã€å‘è´§ã€å–æ¶ˆã€å®Œæˆã€é€€æ¬¾` |
| ğŸŸ  **å·²æ”¶è´§** | `å®Œæˆã€é€€æ¬¾` | `å·²å®Œæˆã€å·²å–æ¶ˆ` | `æ”¯ä»˜ã€å‘è´§ã€æ”¶è´§ã€å–æ¶ˆ` |
| âœ… **å·²å®Œæˆ** | `æ— ` | `æ— ` | `æ‰€æœ‰æ“ä½œ` |
| âŒ **å·²å–æ¶ˆ** | `æ— ` | `æ— ` | `æ‰€æœ‰æ“ä½œ` |

> âš ï¸ **æ³¨æ„äº‹é¡¹**
> çŠ¶æ€æœºè¦ç¡®ä¿ä¸èƒ½å‡ºç°éæ³•çš„çŠ¶æ€è½¬æ¢ï¼Œè¿™æ˜¯ä¿è¯ä¸šåŠ¡é€»è¾‘æ­£ç¡®æ€§çš„å…³é”®

---

## 4. ğŸ”’ å¹¶å‘å®‰å…¨å¤„ç†æ–¹æ¡ˆ


### 4.1 å¹¶å‘é—®é¢˜åˆ†æ


**ğŸš¨ æ½œåœ¨é—®é¢˜**ï¼š
```
å¹¶å‘åœºæ™¯ç¤ºä¾‹ï¼š
ç”¨æˆ·Aï¼šç‚¹å‡»æ”¯ä»˜æŒ‰é’®
ç”¨æˆ·Bï¼šåŒæ—¶ç‚¹å‡»å–æ¶ˆæŒ‰é’®

å¯èƒ½ç»“æœï¼š
1. æ”¯ä»˜æˆåŠŸ + å–æ¶ˆå¤±è´¥ âœ“
2. å–æ¶ˆæˆåŠŸ + æ”¯ä»˜å¤±è´¥ âœ“  
3. ä¸¤ä¸ªæ“ä½œéƒ½æˆåŠŸ âŒ (æ•°æ®ä¸ä¸€è‡´)
```

**ğŸ’¡ è§£å†³æ€è·¯**ï¼š
- **åŒæ­¥æ§åˆ¶**ï¼šç¡®ä¿çŠ¶æ€è½¬æ¢çš„åŸå­æ€§
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ£€æµ‹å¹¶å‘ä¿®æ”¹
- **é‡è¯•æœºåˆ¶**ï¼šå¤„ç†å¹¶å‘å†²çª

### 4.2 çº¿ç¨‹å®‰å…¨çš„çŠ¶æ€æœº


```java
public class ThreadSafeOrderContext {
    private volatile OrderState currentState;  // ä½¿ç”¨volatileç¡®ä¿å¯è§æ€§
    private final Object stateLock = new Object();  // çŠ¶æ€é”
    private final String orderId;
    private final String productName;
    private final double amount;
    private volatile long version = 0;  // ç‰ˆæœ¬å·
    
    public ThreadSafeOrderContext(String orderId, String productName, double amount) {
        this.orderId = orderId;
        this.productName = productName;
        this.amount = amount;
        this.currentState = new NewOrderState();
    }
    
    // çº¿ç¨‹å®‰å…¨çš„çŠ¶æ€è½¬æ¢
    public boolean setState(OrderState newState) {
        synchronized (stateLock) {
            // æ£€æŸ¥å½“å‰çŠ¶æ€æ˜¯å¦å…è®¸è½¬æ¢
            if (isValidTransition(currentState, newState)) {
                OrderState oldState = currentState;
                this.currentState = newState;
                this.version++;  // å¢åŠ ç‰ˆæœ¬å·
                
                System.out.println("çº¿ç¨‹[" + Thread.currentThread().getName() + 
                                 "] çŠ¶æ€è½¬æ¢ï¼š[" + oldState.getStateName() + 
                                 "] â†’ [" + newState.getStateName() + "]");
                return true;
            }
            return false;
        }
    }
    
    // éªŒè¯çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•
    private boolean isValidTransition(OrderState from, OrderState to) {
        // è¿™é‡Œå¯ä»¥åŠ å…¥å¤æ‚çš„çŠ¶æ€è½¬æ¢è§„åˆ™
        return true;  // ç®€åŒ–å®ç°
    }
    
    // çº¿ç¨‹å®‰å…¨çš„æ“ä½œæ–¹æ³•
    public boolean pay() {
        synchronized (stateLock) {
            try {
                currentState.pay(this);
                return true;
            } catch (Exception e) {
                System.out.println("æ”¯ä»˜æ“ä½œå¤±è´¥ï¼š" + e.getMessage());
                return false;
            }
        }
    }
    
    // å…¶ä»–æ“ä½œæ–¹æ³•ç±»ä¼¼...
    public String getCurrentStateName() {
        return currentState.getStateName();
    }
    
    public long getVersion() {
        return version;
    }
}
```

### 4.3 å¹¶å‘æµ‹è¯•


```java
public class ConcurrencyTest {
    
    public static void testConcurrentOperations() {
        ThreadSafeOrderContext order = new ThreadSafeOrderContext(
            "ORD003", "AirPods Pro", 1999.0);
        
        // åˆ›å»ºå¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œ
        Thread payThread = new Thread(() -> {
            System.out.println("çº¿ç¨‹1å°è¯•æ”¯ä»˜...");
            order.pay();
        }, "PayThread");
        
        Thread cancelThread = new Thread(() -> {
            System.out.println("çº¿ç¨‹2å°è¯•å–æ¶ˆ...");
            order.cancel();
        }, "CancelThread");
        
        // åŒæ—¶å¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹
        payThread.start();
        cancelThread.start();
        
        // ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæˆ
        try {
            payThread.join();
            cancelThread.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        
        System.out.println("æœ€ç»ˆçŠ¶æ€ï¼š" + order.getCurrentStateName());
        System.out.println("ç‰ˆæœ¬å·ï¼š" + order.getVersion());
    }
}
```

> ğŸ”§ **å®æˆ˜ç»éªŒ**
> åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ä½¿ç”¨æ•°æ®åº“çš„ä¹è§‚é”æˆ–æ‚²è§‚é”æ¥å¤„ç†å¹¶å‘é—®é¢˜

---

## 5. âš™ï¸ å·¥ä½œæµå¼•æ“åº”ç”¨å®è·µ


### 5.1 å·¥ä½œæµçŠ¶æ€æœºè®¾è®¡


**ğŸ“‹ è¯·å‡ç”³è¯·æµç¨‹**ï¼š
```
è¯·å‡å·¥ä½œæµï¼š
    
[æäº¤ç”³è¯·] â”€â”€â†’ [éƒ¨é—¨å®¡æ‰¹] â”€â”€â†’ [HRå®¡æ‰¹] â”€â”€â†’ [å·²æ‰¹å‡†]
     â”‚            â”‚           â”‚
   æ’¤å› â”‚         æ‹’ç» â”‚      æ‹’ç» â”‚
     â”‚            â”‚           â”‚
     â†“            â†“           â†“
[å·²æ’¤å›]    â†â”€â”€â”€ [å·²æ‹’ç»] â”€â”€â”€â”€â”˜
```

### 5.2 å·¥ä½œæµçŠ¶æ€å®ç°


```java
// å·¥ä½œæµä¸Šä¸‹æ–‡
public class WorkflowContext {
    private WorkflowState currentState;
    private String applicant;      // ç”³è¯·äºº
    private String reason;         // è¯·å‡åŸå› 
    private int days;             // è¯·å‡å¤©æ•°
    private String approver;       // å½“å‰å®¡æ‰¹äºº
    private List<String> approvalHistory;  // å®¡æ‰¹å†å²
    
    public WorkflowContext(String applicant, String reason, int days) {
        this.applicant = applicant;
        this.reason = reason;
        this.days = days;
        this.approvalHistory = new ArrayList<>();
        this.currentState = new SubmittedState();
        
        addHistory("å‘˜å·¥ " + applicant + " æäº¤è¯·å‡ç”³è¯·");
    }
    
    public void setState(WorkflowState state) {
        this.currentState = state;
    }
    
    public void addHistory(String record) {
        String timestamp = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
                          .format(new Date());
        approvalHistory.add(timestamp + " - " + record);
    }
    
    // å·¥ä½œæµæ“ä½œ
    public void approve(String approverName) {
        this.approver = approverName;
        currentState.approve(this);
    }
    
    public void reject(String approverName, String rejectReason) {
        this.approver = approverName;
        currentState.reject(this, rejectReason);
    }
    
    public void withdraw() {
        currentState.withdraw(this);
    }
    
    // getteræ–¹æ³•...
}
```

**ğŸ”µ å·²æäº¤çŠ¶æ€**ï¼š
```java
public class SubmittedState implements WorkflowState {
    
    @Override
    public void approve(WorkflowContext context) {
        System.out.println("éƒ¨é—¨ç»ç†å®¡æ‰¹é€šè¿‡");
        context.addHistory("éƒ¨é—¨ç»ç† " + context.getApprover() + " å®¡æ‰¹é€šè¿‡");
        
        // æ ¹æ®è¯·å‡å¤©æ•°å†³å®šä¸‹ä¸€æ­¥
        if (context.getDays() <= 3) {
            // 3å¤©ä»¥å†…ç›´æ¥æ‰¹å‡†
            context.setState(new ApprovedState());
            context.addHistory("è¯·å‡ç”³è¯·å·²æ‰¹å‡†");
        } else {
            // è¶…è¿‡3å¤©éœ€è¦HRå®¡æ‰¹
            context.setState(new HrReviewState());
            context.addHistory("è½¬è‡³HRå®¡æ‰¹");
        }
    }
    
    @Override
    public void reject(WorkflowContext context, String reason) {
        System.out.println("éƒ¨é—¨ç»ç†æ‹’ç»ç”³è¯·ï¼ŒåŸå› ï¼š" + reason);
        context.addHistory("éƒ¨é—¨ç»ç†æ‹’ç»ç”³è¯·ï¼š" + reason);
        context.setState(new RejectedState());
    }
    
    @Override
    public void withdraw(WorkflowContext context) {
        System.out.println("ç”³è¯·äººæ’¤å›ç”³è¯·");
        context.addHistory("ç”³è¯·äººä¸»åŠ¨æ’¤å›ç”³è¯·");
        context.setState(new WithdrawnState());
    }
    
    @Override
    public String getStateName() {
        return "å·²æäº¤";
    }
}
```

### 5.3 å·¥ä½œæµå¼•æ“


```java
public class WorkflowEngine {
    private Map<String, WorkflowContext> workflows;
    private WorkflowEventListener eventListener;
    
    public WorkflowEngine() {
        this.workflows = new ConcurrentHashMap<>();
        this.eventListener = new DefaultWorkflowEventListener();
    }
    
    // å¯åŠ¨å·¥ä½œæµ
    public String startWorkflow(String applicant, String reason, int days) {
        String workflowId = "WF" + System.currentTimeMillis();
        WorkflowContext workflow = new WorkflowContext(applicant, reason, days);
        
        workflows.put(workflowId, workflow);
        eventListener.onWorkflowStarted(workflowId, workflow);
        
        System.out.println("å·¥ä½œæµå¯åŠ¨ï¼š" + workflowId);
        return workflowId;
    }
    
    // æ‰§è¡Œå®¡æ‰¹
    public boolean approveWorkflow(String workflowId, String approver) {
        WorkflowContext workflow = workflows.get(workflowId);
        if (workflow == null) {
            System.out.println("å·¥ä½œæµä¸å­˜åœ¨ï¼š" + workflowId);
            return false;
        }
        
        try {
            workflow.approve(approver);
            eventListener.onWorkflowStateChanged(workflowId, workflow);
            return true;
        } catch (Exception e) {
            System.out.println("å®¡æ‰¹å¤±è´¥ï¼š" + e.getMessage());
            return false;
        }
    }
    
    // æŸ¥è¯¢å·¥ä½œæµçŠ¶æ€
    public String getWorkflowStatus(String workflowId) {
        WorkflowContext workflow = workflows.get(workflowId);
        return workflow != null ? workflow.getCurrentStateName() : "ä¸å­˜åœ¨";
    }
    
    // è·å–å®¡æ‰¹å†å²
    public List<String> getApprovalHistory(String workflowId) {
        WorkflowContext workflow = workflows.get(workflowId);
        return workflow != null ? workflow.getApprovalHistory() : Collections.emptyList();
    }
}
```

### 5.4 å·¥ä½œæµåº”ç”¨ç¤ºä¾‹


```java
public class WorkflowDemo {
    
    public static void main(String[] args) {
        WorkflowEngine engine = new WorkflowEngine();
        
        // å¯åŠ¨è¯·å‡ç”³è¯·å·¥ä½œæµ
        String workflowId = engine.startWorkflow("å¼ ä¸‰", "å®¶é‡Œæœ‰äº‹", 5);
        
        System.out.println("=== å·¥ä½œæµæ‰§è¡Œè¿‡ç¨‹ ===");
        
        // éƒ¨é—¨ç»ç†å®¡æ‰¹
        System.out.println("\n>>> éƒ¨é—¨ç»ç†å®¡æ‰¹");
        engine.approveWorkflow(workflowId, "æç»ç†");
        System.out.println("å½“å‰çŠ¶æ€ï¼š" + engine.getWorkflowStatus(workflowId));
        
        // HRå®¡æ‰¹
        System.out.println("\n>>> HRå®¡æ‰¹");
        engine.approveWorkflow(workflowId, "ç‹HR");
        System.out.println("å½“å‰çŠ¶æ€ï¼š" + engine.getWorkflowStatus(workflowId));
        
        // æŸ¥çœ‹å®¡æ‰¹å†å²
        System.out.println("\n=== å®¡æ‰¹å†å² ===");
        List<String> history = engine.getApprovalHistory(workflowId);
        for (String record : history) {
            System.out.println(record);
        }
    }
}
```

> ğŸš€ **è¿›é˜¶æŠ€å·§**
> åœ¨å¤§å‹ç³»ç»Ÿä¸­ï¼Œå¯ä»¥ç»“åˆæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥å·¥ä½œæµï¼Œæé«˜ç³»ç»Ÿæ€§èƒ½

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ çŠ¶æ€æ¨¡å¼å®æˆ˜ï¼šå°†ç†è®ºåº”ç”¨åˆ°çœŸå®ä¸šåŠ¡åœºæ™¯
ğŸ”¸ çŠ¶æ€æœºè®¾è®¡ï¼šåˆç†è§„åˆ’çŠ¶æ€è½¬æ¢è§„åˆ™
ğŸ”¸ å¹¶å‘å®‰å…¨ï¼šå¤„ç†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„çŠ¶æ€ä¸€è‡´æ€§
ğŸ”¸ å·¥ä½œæµå¼•æ“ï¼šåˆ©ç”¨çŠ¶æ€æ¨¡å¼æ„å»ºå¤æ‚ä¸šåŠ¡æµç¨‹
ğŸ”¸ ä»£ç ç»„ç»‡ï¼šçŠ¶æ€æ¥å£ã€ä¸Šä¸‹æ–‡ç±»ã€å…·ä½“çŠ¶æ€çš„åä½œ
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ çŠ¶æ€æ¨¡å¼çš„å®æˆ˜ä»·å€¼**
```
ä»£ç ç»´æŠ¤æ€§ï¼š
- æ–°å¢çŠ¶æ€ï¼šåªéœ€è¦å¢åŠ æ–°çš„çŠ¶æ€ç±»
- ä¿®æ”¹é€»è¾‘ï¼šåªå½±å“å¯¹åº”çš„çŠ¶æ€ç±»
- è°ƒè¯•é—®é¢˜ï¼šçŠ¶æ€è½¬æ¢è¿‡ç¨‹æ¸…æ™°å¯è¿½è¸ª

ä¸šåŠ¡è¡¨è¾¾åŠ›ï¼š
- ä»£ç ç»“æ„ï¼šç›´æ¥åæ˜ ä¸šåŠ¡æµç¨‹
- çŠ¶æ€è½¬æ¢ï¼šä¸šåŠ¡è§„åˆ™ä¸€ç›®äº†ç„¶
- æ‰©å±•èƒ½åŠ›ï¼šé€‚åº”ä¸šåŠ¡å˜åŒ–éœ€æ±‚
```

**ğŸ”¹ å¹¶å‘å®‰å…¨çš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆéœ€è¦è€ƒè™‘å¹¶å‘ï¼š
- å¤šç”¨æˆ·åŒæ—¶æ“ä½œï¼šå¯èƒ½å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´
- ç³»ç»Ÿæ€§èƒ½è¦æ±‚ï¼šä¸èƒ½ç®€å•åŠ é”å½±å“æ€§èƒ½
- æ•°æ®å®Œæ•´æ€§ï¼šçŠ¶æ€è½¬æ¢å¿…é¡»åŸå­åŒ–

è§£å†³æ–¹æ¡ˆé€‰æ‹©ï¼š
- å†…å­˜çŠ¶æ€æœºï¼šä½¿ç”¨synchronizedåŒæ­¥
- æ•°æ®åº“çŠ¶æ€æœºï¼šä½¿ç”¨ä¹è§‚é”æˆ–æ‚²è§‚é”
- åˆ†å¸ƒå¼çŠ¶æ€æœºï¼šä½¿ç”¨åˆ†å¸ƒå¼é”
```

**ğŸ”¹ å·¥ä½œæµå¼•æ“çš„è®¾è®¡æ€è·¯**
```
æ ¸å¿ƒç»„ä»¶ï¼š
- çŠ¶æ€å®šä¹‰ï¼šå®šä¹‰å·¥ä½œæµçš„å„ä¸ªé˜¶æ®µ
- è½¬æ¢è§„åˆ™ï¼šå®šä¹‰çŠ¶æ€ä¹‹é—´çš„è½¬æ¢æ¡ä»¶
- äº‹ä»¶å¤„ç†ï¼šå¤„ç†çŠ¶æ€è½¬æ¢æ—¶çš„ä¸šåŠ¡é€»è¾‘
- æŒä¹…åŒ–ï¼šä¿å­˜å·¥ä½œæµçŠ¶æ€å’Œå†å²è®°å½•

æ‰©å±•åŠŸèƒ½ï¼š
- æ¡ä»¶åˆ†æ”¯ï¼šæ ¹æ®æ¡ä»¶é€‰æ‹©ä¸åŒè·¯å¾„
- å¹¶è¡Œå¤„ç†ï¼šåŒæ—¶æ‰§è¡Œå¤šä¸ªåˆ†æ”¯
- è¶…æ—¶å¤„ç†ï¼šè‡ªåŠ¨å¤„ç†è¶…æ—¶çš„æµç¨‹
- å›é€€æœºåˆ¶ï¼šæ”¯æŒæµç¨‹å›é€€å’Œé‡è¯•
```

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ é€‚ç”¨åœºæ™¯åˆ¤æ–­**
```
âœ… é€‚åˆä½¿ç”¨çŠ¶æ€æ¨¡å¼çš„åœºæ™¯ï¼š
- å¯¹è±¡çŠ¶æ€è¾ƒå¤šï¼ˆ>3ä¸ªï¼‰
- çŠ¶æ€è½¬æ¢è§„åˆ™å¤æ‚
- æ¯ä¸ªçŠ¶æ€çš„è¡Œä¸ºå·®å¼‚è¾ƒå¤§
- éœ€è¦ä¸¥æ ¼æ§åˆ¶çŠ¶æ€è½¬æ¢

âŒ ä¸é€‚åˆä½¿ç”¨çš„åœºæ™¯ï¼š
- çŠ¶æ€å¾ˆå°‘ï¼ˆâ‰¤2ä¸ªï¼‰
- çŠ¶æ€è½¬æ¢è§„åˆ™ç®€å•
- çŠ¶æ€è¡Œä¸ºå·®å¼‚å¾ˆå°
- æ€§èƒ½è¦æ±‚æé«˜çš„åœºæ™¯
```

**ğŸ”§ å®ç°æœ€ä½³å®è·µ**
```
è®¾è®¡åŸåˆ™ï¼š
- å•ä¸€èŒè´£ï¼šæ¯ä¸ªçŠ¶æ€ç±»åªè´Ÿè´£è‡ªå·±çš„é€»è¾‘
- å¼€é—­åŸåˆ™ï¼šæ–°å¢çŠ¶æ€ä¸ä¿®æ”¹ç°æœ‰ä»£ç 
- çŠ¶æ€å°è£…ï¼šçŠ¶æ€è½¬æ¢é€»è¾‘å°è£…åœ¨çŠ¶æ€å†…éƒ¨
- ä¸Šä¸‹æ–‡ç®€åŒ–ï¼šä¸Šä¸‹æ–‡ç±»ä¿æŒç®€æ´

ä»£ç ç»„ç»‡ï¼š
- çŠ¶æ€æ¥å£ï¼šå®šä¹‰ç»Ÿä¸€çš„æ“ä½œæ–¹æ³•
- æŠ½è±¡çŠ¶æ€ï¼šæä¾›é»˜è®¤å®ç°å‡å°‘é‡å¤ä»£ç 
- çŠ¶æ€æ³¨å†Œï¼šä½¿ç”¨å·¥å‚æ¨¡å¼ç®¡ç†çŠ¶æ€å®ä¾‹
- å¼‚å¸¸å¤„ç†ï¼šä¼˜é›…å¤„ç†éæ³•çŠ¶æ€è½¬æ¢
```

**ğŸ’¡ å¸¸è§é—®é¢˜ä¸è§£å†³**
```
é—®é¢˜1ï¼šçŠ¶æ€è¿‡å¤šå¯¼è‡´ç±»çˆ†ç‚¸
è§£å†³ï¼šä½¿ç”¨çŠ¶æ€è¡¨æˆ–é…ç½®æ–‡ä»¶ç®¡ç†ç®€å•çŠ¶æ€

é—®é¢˜2ï¼šçŠ¶æ€è½¬æ¢é€»è¾‘å¤æ‚
è§£å†³ï¼šå¼•å…¥çŠ¶æ€æœºæ¡†æ¶ï¼ˆå¦‚Spring State Machineï¼‰

é—®é¢˜3ï¼šå¹¶å‘é—®é¢˜éš¾ä»¥è°ƒè¯•
è§£å†³ï¼šå¢åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•å’ŒçŠ¶æ€ç‰ˆæœ¬æ§åˆ¶

é—®é¢˜4ï¼šæ€§èƒ½å¼€é”€è¾ƒå¤§
è§£å†³ï¼šä½¿ç”¨äº«å…ƒæ¨¡å¼å…±äº«çŠ¶æ€å®ä¾‹
```

### 6.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š å­¦ä¹ è¿›é˜¶è·¯çº¿**
```
ç¬¬1é˜¶æ®µï¼šåŸºç¡€ç†è§£ï¼ˆ1-2å¤©ï¼‰
- æŒæ¡çŠ¶æ€æ¨¡å¼åŸºæœ¬æ¦‚å¿µ
- å®ç°ç®€å•çš„çŠ¶æ€è½¬æ¢ç¤ºä¾‹
- ç†è§£çŠ¶æ€æ¨¡å¼ä¸if-elseçš„åŒºåˆ«

ç¬¬2é˜¶æ®µï¼šå®æˆ˜åº”ç”¨ï¼ˆ3-5å¤©ï¼‰
- å®Œæˆè®¢å•çŠ¶æ€æœºå®ç°
- å¤„ç†å¹¶å‘å®‰å…¨é—®é¢˜
- é›†æˆåˆ°çœŸå®é¡¹ç›®ä¸­

ç¬¬3é˜¶æ®µï¼šæ·±å…¥æ‰©å±•ï¼ˆ1-2å‘¨ï¼‰
- å­¦ä¹ å·¥ä½œæµå¼•æ“æ¡†æ¶
- ç ”ç©¶åˆ†å¸ƒå¼çŠ¶æ€æœº
- æ¢ç´¢çŠ¶æ€æ¨¡å¼çš„å˜ç§å®ç°

ç¬¬4é˜¶æ®µï¼šä¸“å®¶çº§åº”ç”¨ï¼ˆæŒç»­ï¼‰
- è®¾è®¡å¤æ‚ä¸šåŠ¡çŠ¶æ€æœº
- ä¼˜åŒ–æ€§èƒ½å’Œæ‰©å±•æ€§
- è´¡çŒ®å¼€æºçŠ¶æ€æœºæ¡†æ¶
```

**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**
```
çŠ¶æ€æ¨¡å¼åšå®æˆ˜ï¼Œä¸šåŠ¡æµç¨‹å˜ä»£ç 
æ¯ä¸ªçŠ¶æ€ç®¡è‡ªå·±ï¼Œè½¬æ¢è§„åˆ™è¦æ¸…æ™°
å¹¶å‘å®‰å…¨è¦è€ƒè™‘ï¼Œå·¥ä½œæµç¨‹å¯æ‰©å±•
ä»£ç æ¸…æ™°æ˜“ç»´æŠ¤ï¼Œå¤æ‚é€»è¾‘å˜ç®€å•
```

**æ ¸å¿ƒä»·å€¼**ï¼š
- çŠ¶æ€æ¨¡å¼å®æˆ˜è®©å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å˜å¾—æ¸…æ™°å¯ç»´æŠ¤
- åˆç†çš„çŠ¶æ€è®¾è®¡æ˜¯ç³»ç»Ÿç¨³å®šæ€§å’Œæ‰©å±•æ€§çš„åŸºç¡€
- å¹¶å‘å®‰å…¨å’Œå·¥ä½œæµå¼•æ“æ˜¯ä¼ä¸šçº§åº”ç”¨çš„å¿…å¤‡èƒ½åŠ›
- æŒæ¡çŠ¶æ€æ¨¡å¼å®æˆ˜æŠ€èƒ½èƒ½æ˜¾è‘—æå‡ä»£ç è´¨é‡å’Œå¼€å‘æ•ˆç‡