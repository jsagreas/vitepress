---
title: 3、服务可用性-监控
---
## 📚 目录


1. [服务可用性监控基础概念](#1-服务可用性监控基础概念)
2. [端口连通性检查](#2-端口连通性检查)
3. [HTTP服务监控](#3-HTTP服务监控)
4. [数据库连接监控](#4-数据库连接监控)
5. [应用进程监控](#5-应用进程监控)
6. [响应时间监控](#6-响应时间监控)
7. [SSL证书监控](#7-SSL证书监控)
8. [自定义脚本检查](#8-自定义脚本检查)
9. [核心要点总结](#9-核心要点总结)

---

# 🎯 **学习路径导航**


**前置知识**：需要掌握Zabbix基础配置、监控项创建 → **当前内容**：服务可用性监控 → **后续学习**：建议学习性能监控和告警机制

⏱️ **预计学习时间**：本章预计90分钟 | 实践配置60分钟

---

## 1. 🔍 服务可用性监控基础概念



### 1.1 什么是服务可用性监控



**📋 核心定义**
服务可用性监控就是**检查你的服务是否正常运行**。就像医生给病人测体温、量血压一样，我们需要定期检查各种服务是否"健康"。

**💡 生活化理解**
想象你开了一家餐厅：
- **服务可用性** = 餐厅是否正常营业
- **端口检查** = 检查餐厅门是否开着
- **HTTP监控** = 检查顾客能否正常点餐
- **数据库监控** = 检查收银系统是否工作
- **进程监控** = 检查厨师是否在岗

### 1.2 为什么需要服务可用性监控



**🎯 监控价值**
- **及时发现问题**：服务挂了立即知道，而不是等用户投诉
- **减少损失**：快速恢复服务，减少业务影响
- **提升用户体验**：保证服务稳定可靠
- **运维自动化**：自动检测、自动告警、自动处理

### 1.3 Zabbix中的可用性监控类型



| **监控类型** | **检查内容** | **适用场景** | **难度等级** |
|-------------|-------------|-------------|-------------|
| **端口检查** | 网络端口是否开放 | 基础连通性 | ⭐ |
| **HTTP监控** | 网站是否可访问 | Web服务 | ⭐⭐ |
| **数据库监控** | 数据库是否可连接 | 数据存储 | ⭐⭐⭐ |
| **进程监控** | 应用程序是否运行 | 系统服务 | ⭐⭐ |
| **响应时间** | 服务响应速度 | 性能检查 | ⭐⭐⭐ |
| **SSL证书** | 证书是否有效 | 安全服务 | ⭐⭐⭐ |

---

## 2. 🔌 端口连通性检查



### 2.1 端口检查的基本原理



**🔸 什么是端口检查**
端口检查就像**敲门看有没有人回应**。每个网络服务都会监听特定的端口号，我们通过检查这些端口是否响应来判断服务是否正常。

**常见服务端口**
```
HTTP服务：80端口
HTTPS服务：443端口
SSH服务：22端口
MySQL数据库：3306端口
Redis缓存：6379端口
```

### 2.2 在Zabbix中配置端口检查



**📝 配置步骤详解**

**步骤1：创建监控项**
```
配置路径：主机 → 监控项 → 创建监控项
名称：MySQL端口检查
类型：简单检查
键值：net.tcp.port[,3306]
更新间隔：60s
```

**步骤2：理解键值参数**
- `net.tcp.port[主机,端口]` 是Zabbix内置的端口检查函数
- 主机可以为空（检查本机）或填写IP地址
- 端口号是要检查的服务端口

**步骤3：设置触发器**
```
触发器名称：MySQL端口不可达
表达式：{主机名:net.tcp.port[,3306].last()}=0
严重性：高
描述：MySQL数据库端口3306无法连接
```

### 2.3 端口检查实战案例



**🏷️ 常见服务监控配置**

**Web服务器监控**
```
监控项名称：Nginx HTTP端口检查
键值：net.tcp.port[192.168.1.100,80]
说明：检查Web服务器80端口是否可访问
```

**数据库服务监控**
```
监控项名称：PostgreSQL端口检查  
键值：net.tcp.port[db.example.com,5432]
说明：检查PostgreSQL数据库连接
```

**💡 实用技巧**
- **批量配置**：使用模板为多台服务器配置相同的端口检查
- **告警优化**：设置2-3次连续失败才告警，避免网络抖动误报
- **检查频率**：重要服务可以30秒检查一次，一般服务60秒即可

---

## 3. 🌐 HTTP服务监控



### 3.1 HTTP监控比端口检查更精确



**🔸 为什么需要HTTP监控**
端口开放不代表服务正常！就像餐厅门开着，但里面可能没有服务员。HTTP监控会实际访问网页，确保服务真正可用。

**HTTP监控能检查什么**
- 网站是否能正常访问
- 返回的状态码是否正确（200表示成功）
- 页面内容是否包含预期文字
- 响应时间是否在合理范围内

### 3.2 配置基础HTTP监控



**📋 基本HTTP检查配置**

**监控项配置**
```
名称：网站可用性检查
类型：Web监控
主机：web.example.com
端口：80
路径：/
状态码：200
超时：10秒
```

**实际配置界面操作**
1. 进入 **配置 → 主机 → Web监控**
2. 点击 **创建Web场景**
3. 填写场景信息：
   - 名称：`主站访问检查`
   - 更新间隔：`60s`
4. 添加监控步骤：
   - 名称：`首页检查`
   - URL：`http://www.example.com/`
   - 预期状态码：`200`

### 3.3 高级HTTP监控功能



**🔍 内容匹配检查**
```
检查目标：确保登录页面显示正常
URL：http://example.com/login
预期内容：用户名
不应包含：错误|异常|Error
```

**🔐 需要认证的HTTP监控**
```
场景：监控需要登录的管理后台
步骤1：访问登录页面
步骤2：提交登录表单
步骤3：检查登录后的管理页面
```

**📊 HTTP监控数据收集**
Zabbix自动收集这些数据：
- **响应时间**：`web.test.time[场景名,步骤名]`
- **下载速度**：`web.test.speed[场景名,步骤名]`
- **响应码**：`web.test.rspcode[场景名,步骤名]`

### 3.4 HTTP监控最佳实践



**⚠️ 常见配置误区**
```
❌ 错误做法：只检查首页
✅ 正确做法：检查关键业务页面

❌ 错误做法：超时时间设置太短
✅ 正确做法：根据实际网络情况设置合理超时

❌ 错误做法：检查频率过高
✅ 正确做法：重要服务1-5分钟，一般服务10-30分钟
```

---

## 4. 🗄️ 数据库连接监控



### 4.1 数据库监控的重要性



**🔸 为什么数据库监控特别重要**
数据库是应用程序的**心脏**，一旦出问题，整个系统就瘫痪了。数据库监控不仅要检查能否连接，还要检查性能是否正常。

### 4.2 MySQL数据库监控配置



**📝 基础连接检查**

**方法1：使用内置检查**
```
监控项名称：MySQL服务状态
键值：mysql.ping[,root,password]
说明：检查MySQL是否可以连接
返回值：1表示正常，0表示异常
```

**方法2：自定义SQL查询**
```
监控项名称：MySQL活跃连接数
键值：mysql.status[Threads_connected]
说明：获取当前活跃连接数量
告警阈值：>100（根据实际情况调整）
```

### 4.3 其他数据库监控配置



**PostgreSQL监控**
```
连接检查：pgsql.ping[,postgres,password]
活跃连接：pgsql.connections[,postgres,password]
数据库大小：pgsql.db.size[数据库名]
```

**Redis监控**
```
连接检查：redis.ping[,6379]
内存使用：redis.info[,6379,used_memory]
连接数：redis.info[,6379,connected_clients]
```

### 4.4 数据库性能监控



**📊 关键性能指标**

| **监控指标** | **监控键值** | **正常范围** | **告警条件** |
|-------------|-------------|-------------|-------------|
| **连接数** | `mysql.status[Threads_connected]` | < 80% 最大连接数 | > 90% 最大连接数 |
| **查询执行时间** | `mysql.status[Slow_queries]` | 增长缓慢 | 快速增长 |
| **锁等待** | `mysql.status[Table_locks_waited]` | 偶尔发生 | 频繁发生 |
| **缓存命中率** | `mysql.status[Qcache_hits]` | > 90% | < 80% |

**💡 实用监控技巧**
```
🔸 设置基准线：记录正常情况下的指标值
🔸 分层告警：轻微异常warning，严重问题critical
🔸 趋势监控：关注指标变化趋势，不只看当前值
🔸 业务关联：结合业务高峰期调整告警阈值
```

---

## 5. ⚙️ 应用进程监控



### 5.1 进程监控基础概念



**🔸 什么是进程监控**
进程监控就是**检查应用程序是否在运行**。就像检查厨师是否在厨房工作一样，我们需要确保关键应用程序始终在后台运行。

**进程监控的作用**
- 确保关键服务始终运行
- 监控进程的资源使用情况
- 及时发现进程异常退出
- 自动重启失败的服务

### 5.2 Linux进程监控配置



**📋 基础进程检查**

**方法1：检查进程是否存在**
```
监控项名称：Nginx进程检查
键值：proc.num[nginx]
说明：统计nginx进程数量
正常值：> 0（至少有一个进程）
```

**方法2：检查特定进程**
```
监控项名称：MySQL进程状态
键值：proc.num[mysqld,,run]
说明：检查mysqld进程是否在运行状态
参数解释：进程名,用户名,状态
```

### 5.3 进程详细监控



**🔍 进程资源使用监控**

**CPU使用率监控**
```
监控项名称：Apache CPU使用率
键值：proc.cpu.util[httpd]
单位：百分比
告警条件：> 80%
```

**内存使用监控**
```
监控项名称：Java应用内存使用
键值：proc.mem[java,,,,rss]
说明：获取Java进程的物理内存使用量
单位：字节
```

**进程数量监控**
```
监控项名称：PHP-FPM工作进程数
键值：proc.num[php-fpm]
正常范围：5-20个进程
告警条件：< 2 或 > 50
```

### 5.4 Windows服务监控



**🪟 Windows环境特殊配置**

**服务状态检查**
```
监控项名称：IIS服务状态
键值：service_state[W3SVC]
返回值：0(停止) 1(启动) 2(暂停) 3(启动挂起)
正常状态：1
```

**服务启动类型检查**
```
监控项名称：SQL Server启动类型
键值：service.info[MSSQLSERVER,startup]
返回值：automatic(自动) manual(手动) disabled(禁用)
```

---

## 6. ⏱️ 响应时间监控



### 6.1 响应时间监控的意义



**🔸 为什么响应时间很重要**
响应时间就像餐厅的**上菜速度**。即使菜品质量很好，但如果等待时间太长，顾客还是会不满意。网络服务也是如此，响应太慢会严重影响用户体验。

**响应时间标准参考**
```
优秀：< 100ms
良好：100-300ms  
可接受：300-1000ms
较慢：1-3秒
很慢：> 3秒
```

### 6.2 网络响应时间监控



**📡 ICMP Ping监控**
```
监控项名称：服务器网络延迟
键值：icmpping[,3]
说明：发送3个ping包测试网络延迟
单位：毫秒
告警条件：> 500ms
```

**网络丢包率监控**
```
监控项名称：网络丢包率
键值：icmppingloss[,10]
说明：发送10个包统计丢包率
单位：百分比
告警条件：> 5%
```

### 6.3 应用响应时间监控



**🌐 Web应用响应时间**
```
配置位置：Web监控场景中自动收集
监控项：web.test.time[场景名,步骤名]
数据类型：浮点数（秒）
正常范围：< 2秒
```

**数据库查询响应时间**
```
自定义脚本方式：
1. 编写脚本执行测试查询
2. 记录查询开始和结束时间
3. 计算时间差并返回给Zabbix
```

### 6.4 响应时间优化建议



**⚡ 性能优化方向**
- **网络优化**：使用CDN、优化DNS解析
- **服务器优化**：增加内存、升级CPU、使用SSD
- **应用优化**：缓存策略、数据库索引、代码优化
- **架构优化**：负载均衡、微服务拆分

---

## 7. 🔒 SSL证书监控



### 7.1 SSL证书监控的必要性



**🔸 为什么要监控SSL证书**
SSL证书就像网站的**身份证**，过期了用户就无法安全访问网站。证书过期是很常见但容易被忽视的问题，提前监控可以避免网站访问中断。

**SSL证书常见问题**
- 证书到期导致网站无法访问
- 证书链不完整影响兼容性  
- 证书域名不匹配
- 使用了不受信任的CA

### 7.2 SSL证书监控配置



**📋 证书到期时间监控**

**基础配置**
```
监控项名称：SSL证书到期检查
键值：net.tcp.service[https,www.example.com,443]
说明：检查HTTPS服务是否可用
返回值：1表示正常，0表示异常
```

**高级证书监控**
```
使用自定义脚本：
#!/bin/bash

# 获取证书到期时间

expiry_date=$(echo | openssl s_client -servername $1 -connect $1:443 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
# 转换为时间戳计算剩余天数

```

### 7.3 证书监控最佳实践



**⏰ 告警时间设置**
```
🔸 30天提醒：开始准备续费
🔸 15天警告：紧急处理续费
🔸 7天严重：立即续费
🔸 3天灾难：极度紧急
```

**📋 监控范围建议**
- 主站SSL证书
- API接口SSL证书  
- 管理后台SSL证书
- 第三方依赖服务证书

---

## 8. 📝 自定义脚本检查



### 8.1 自定义脚本的应用场景



**🔸 什么时候需要自定义脚本**
当Zabbix内置的监控项无法满足需求时，我们就需要**自己写脚本**来实现特殊的检查功能。就像标准体检项目无法满足特殊需求时，需要做专项检查一样。

**常见自定义检查场景**
- 业务逻辑检查（订单处理是否正常）
- 第三方API可用性检查
- 复杂的文件或日志分析
- 自定义性能指标计算

### 8.2 编写自定义检查脚本



**📝 脚本编写基本规范**

**简单的服务检查脚本**
```bash
#!/bin/bash

# 检查Redis连接示例

redis-cli ping > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo 1  # 正常
else
    echo 0  # 异常
fi
```

**业务逻辑检查脚本**
```bash
#!/bin/bash

# 检查订单处理队列

queue_size=$(redis-cli llen order_queue)
if [ $queue_size -lt 100 ]; then
    echo 1  # 队列正常
else
    echo 0  # 队列积压
fi
```

### 8.3 脚本集成到Zabbix



**🔧 配置步骤详解**

**步骤1：部署脚本**
```
脚本位置：/usr/local/bin/check_business.sh
权限设置：chmod +x /usr/local/bin/check_business.sh
测试脚本：./check_business.sh
```

**步骤2：配置用户参数**
```
编辑文件：/etc/zabbix/zabbix_agentd.conf
添加配置：UserParameter=custom.business.check,/usr/local/bin/check_business.sh
重启agent：systemctl restart zabbix-agent
```

**步骤3：创建监控项**
```
名称：业务逻辑检查
类型：Zabbix客户端
键值：custom.business.check
更新间隔：300s（5分钟）
```

### 8.4 脚本监控最佳实践



**✅ 脚本编写要点**
- **返回值规范**：0/1表示状态，数字表示数值
- **超时处理**：脚本执行时间不超过30秒
- **错误处理**：异常情况要有合理的返回值
- **日志记录**：关键操作要记录日志

**⚠️ 常见问题避免**
```
❌ 脚本执行时间过长
❌ 权限配置不正确
❌ 返回值格式不规范
❌ 没有错误处理机制
```

---

## 9. 📋 核心要点总结



### 9.1 必须掌握的核心概念



```
🔸 服务可用性监控：确保各种服务正常运行的检查机制
🔸 端口检查：最基础的连通性验证，像敲门确认有人
🔸 HTTP监控：比端口检查更深入，确保Web服务真正可用
🔸 数据库监控：检查数据存储服务的连接和性能
🔸 进程监控：确保关键应用程序持续运行
🔸 响应时间监控：衡量服务性能和用户体验
🔸 SSL证书监控：防止证书过期导致的访问中断
🔸 自定义脚本：解决特殊监控需求的万能工具
```

### 9.2 关键理解要点



**🔹 监控层次的递进关系**
```
基础层：端口是否开放
服务层：服务是否响应  
功能层：功能是否正常
性能层：响应是否及时
安全层：证书是否有效
```

**🔹 监控频率的选择原则**
```
关键服务：30秒-1分钟
一般服务：1-5分钟
性能监控：5-15分钟
证书检查：1天-1周
```

### 9.3 实际应用建议



**🎯 监控配置策略**
- **分优先级**：核心业务系统监控最严格
- **分环境**：生产环境比测试环境要求更高
- **分时段**：业务高峰期缩短检查间隔
- **分层次**：从基础到高级逐步完善

**🛠️ 运维最佳实践**
```
监控项配置：
- 名称要清晰明了，一看就懂
- 告警阈值要符合实际业务需求
- 检查间隔要平衡及时性和系统负载

告警设置：
- 避免误报：设置合理的触发条件
- 避免漏报：关键服务要有冗余检查
- 分级处理：不同严重程度使用不同处理方式
```

### 9.4 学习检查清单



- [ ] 理解各种监控类型的应用场景
- [ ] 能够配置基础的端口和HTTP监控
- [ ] 掌握数据库连接监控方法
- [ ] 了解进程监控的配置要点
- [ ] 会设置合理的响应时间告警
- [ ] 能够监控SSL证书到期时间
- [ ] 会编写简单的自定义检查脚本

**🔑 核心记忆要点**
> 服务监控层层递进，从连通到可用再到性能
> 端口HTTP数据库，进程证书加脚本
> 监控频率要合理，告警阈值需准确
> 自定义脚本是万能，解决特殊监控需求

**💡 延伸学习方向**
- 深入学习Zabbix模板制作
- 研究分布式监控架构
- 学习监控数据的可视化展示
- 了解监控与自动化运维的结合