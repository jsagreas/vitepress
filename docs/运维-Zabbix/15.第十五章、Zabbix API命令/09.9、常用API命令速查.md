---
title: 9、常用API命令速查
---
## 📚 目录

1. [Zabbix API基础认知](#1-zabbix-api基础认知)
2. [API通信原理与JSON-RPC](#2-api通信原理与json-rpc)
3. [认证机制详解](#3-认证机制详解)
4. [主机管理API实战](#4-主机管理api实战)
5. [监控项API操作](#5-监控项api操作)
6. [触发器API管理](#6-触发器api管理)
7. [问题与事件处理API](#7-问题与事件处理api)
8. [模板和主机组API](#8-模板和主机组api)
9. [数据查询与历史记录API](#9-数据查询与历史记录api)
10. [API调试与错误处理](#10-api调试与错误处理)
11. [实用脚本与自动化](#11-实用脚本与自动化)
12. [核心要点总结](#12-核心要点总结)

---

## 1. 🌟 Zabbix API基础认知


### 1.1 什么是Zabbix API


**🔸 简单理解API的作用**
```
API就像是一个"翻译官"：
- 你想要什么信息，用标准的"语言"告诉Zabbix
- Zabbix理解后，把结果用同样的"语言"返回给你
- 这个"语言"就是JSON格式，简单易懂

比如日常应用：
🏠 你想知道家里有几台服务器在运行
📱 通过API发送请求："给我所有主机列表"
💻 Zabbix回复："一共3台，分别是Web服务器、数据库服务器、文件服务器"
```

**💡 为什么要学API**
```
手工操作的局限性：
❌ 在网页上点击几百台服务器太累
❌ 重复性工作容易出错
❌ 半夜故障时，需要快速批量处理

API的优势：
✅ 批量操作：一次处理100台服务器
✅ 自动化：写个脚本，定时执行
✅ 集成：和其他系统连接，形成自动化运维
✅ 精确控制：想要什么数据就取什么数据
```

### 1.2 Zabbix API的应用场景


**🎯 实际使用场景举例**
```
运维日常工作：
📊 自动生成监控报表
🔧 批量添加新服务器到监控
⚠️ 自动处理告警确认
📈 定期导出性能数据
🔄 同步CMDB系统中的主机信息

开发集成：
🌐 在自己的管理平台中嵌入Zabbix数据
📱 开发手机APP查看监控状态
🎨 制作个性化的监控大屏
🔔 集成到微信、钉钉等消息系统
```

### 1.3 API访问准备工作


**📋 开始前的准备清单**
```
环境要求：
✅ Zabbix服务器正常运行
✅ 有管理员账号和密码
✅ 知道Zabbix的访问地址
✅ 能够发送HTTP请求的工具

常用工具选择：
🔧 curl命令：Linux下最简单的方式
🌐 Postman：图形界面，适合调试
📝 Python脚本：适合自动化
💻 浏览器开发者工具：快速测试
```

---

## 2. 🔄 API通信原理与JSON-RPC


### 2.1 JSON-RPC协议理解


**🔸 什么是JSON-RPC**
```
JSON-RPC是一种简单的通信协议：
- JSON：数据格式，类似于填表格的标准格式
- RPC：远程过程调用，就是"远程遥控"的意思

简单类比：
📞 打电话订外卖
  1. 你说："我要一份宫保鸡丁"（请求）
  2. 店家说："好的，30分钟送达"（响应）

📡 API调用
  1. 你发送："获取主机列表"（JSON请求）
  2. Zabbix返回："这里是所有主机信息"（JSON响应）
```

### 2.2 API请求的基本结构


**📝 请求格式详解**
```json
{
    "jsonrpc": "2.0",          // 协议版本，固定写法
    "method": "host.get",      // 要调用的方法，告诉Zabbix你想做什么
    "params": {                // 参数，具体的要求和条件
        "output": "extend"
    },
    "auth": "令牌字符串",      // 身份验证，证明你有权限
    "id": 1                    // 请求ID，用来对应请求和响应
}
```

**🔍 各字段含义解释**
```
jsonrpc: "2.0"
→ 就像信封上写明这是"标准邮件格式"

method: "host.get" 
→ 具体要做的事情，比如"获取主机"、"创建用户"等

params: {...}
→ 具体要求，比如"只要前10个"、"只要名字包含web的"

auth: "令牌"
→ 身份证明，证明你有权限做这件事

id: 1
→ 请求编号，方便对应请求和回复
```

### 2.3 API响应的结构


**📨 成功响应格式**
```json
{
    "jsonrpc": "2.0",
    "result": [                // 实际的数据结果
        {
            "hostid": "10084",
            "host": "Web-Server-01"
        }
    ],
    "id": 1                    // 对应请求的ID
}
```

**❌ 错误响应格式**
```json
{
    "jsonrpc": "2.0",
    "error": {
        "code": -32602,        // 错误代码
        "message": "Invalid params",  // 错误描述
        "data": "详细错误信息"
    },
    "id": 1
}
```

### 2.4 HTTP请求方式


**🌐 API调用的HTTP细节**
```
请求方法：POST（固定使用POST）
请求地址：http://your-zabbix/api_jsonrpc.php
请求头：Content-Type: application/json

完整的curl示例：
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"apiinfo.version","id":1}' \
  http://your-zabbix/api_jsonrpc.php
```

---

## 3. 🔐 认证机制详解


### 3.1 用户登录获取令牌


**🔑 登录过程详解**
```
登录就像去银行办事：
1. 先到前台报身份（用户名密码）
2. 前台给你一个号码牌（认证令牌）
3. 拿着号码牌去办各种业务（API调用）

API登录也是一样：
1. 发送用户名密码给Zabbix
2. Zabbix验证正确后，返回一个令牌
3. 后续所有操作都带着这个令牌
```

**📝 登录API调用示例**
```bash
# 使用curl登录
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "user.login",
    "params": {
        "user": "Admin",
        "password": "zabbix"
    },
    "id": 1
  }' \
  http://192.168.1.100/zabbix/api_jsonrpc.php
```

**✅ 成功登录的响应**
```json
{
    "jsonrpc": "2.0",
    "result": "038e1d7b1735c6a5436ee9eae095879e",
    "id": 1
}
```

> 💡 **重要提示**：这个返回的字符串就是你的"通行证"，后续所有API调用都需要它

### 3.2 令牌的使用方法


**🎫 如何使用认证令牌**
```json
{
    "jsonrpc": "2.0",
    "method": "host.get",
    "params": {
        "output": ["hostid", "host"]
    },
    "auth": "038e1d7b1735c6a5436ee9eae095879e",  // 这里放入登录时获得的令牌
    "id": 2
}
```

### 3.3 令牌安全注意事项


**⚠️ 安全最佳实践**
```
令牌管理要点：

安全存储：
✅ 不要把令牌写在代码里
✅ 使用环境变量或配置文件
✅ 定期更换令牌

及时清理：
✅ 用完后主动登出
✅ 设置合理的过期时间
✅ 避免令牌泄露

权限控制：
✅ 使用专门的API账号
✅ 只给必要的权限
✅ 记录API使用日志
```

---

## 4. 🖥️ 主机管理API实战


### 4.1 获取主机列表


**📋 基础主机查询**
```
想象你是一个管理员，需要清点有多少台服务器：
- 类似于点名册，列出所有在册的服务器
- 可以选择显示哪些信息，比如只要名字还是要详细信息
- 可以设置筛选条件，比如只看Linux服务器
```

**🔍 简单查询示例**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "host.get",
    "params": {
        "output": ["hostid", "host", "status"],
        "selectInterfaces": "extend"
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

**📊 返回结果解读**
```json
{
    "jsonrpc": "2.0",
    "result": [
        {
            "hostid": "10084",      // 主机的唯一ID号
            "host": "Web-Server-01", // 主机名称
            "status": "0",          // 状态：0=启用，1=禁用
            "interfaces": [         // 网络接口信息
                {
                    "ip": "192.168.1.100",
                    "port": "10050"
                }
            ]
        }
    ],
    "id": 1
}
```

### 4.2 主机状态过滤


**🔍 按条件筛选主机**

| 筛选条件 | **说明** | **API参数** |
|---------|---------|------------|
| 启用的主机 | `正常监控中的服务器` | `"filter": {"status": 0}` |
| 禁用的主机 | `暂停监控的服务器` | `"filter": {"status": 1}` |
| 特定组的主机 | `某个部门的服务器` | `"groupids": ["2"]` |
| 名称匹配 | `名字包含web的服务器` | `"search": {"host": "web"}` |

```bash
# 查询启用状态的主机
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "host.get",
    "params": {
        "output": "extend",
        "filter": {
            "status": 0
        }
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

### 4.3 创建新主机


**➕ 添加主机到监控**
```
添加主机就像给新员工办入职：
1. 填写基本信息（主机名、IP地址）
2. 分配到部门（主机组）
3. 设置联系方式（监控接口）
4. 分配工作任务（监控模板）
```

**📝 创建主机的完整示例**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "host.create",
    "params": {
        "host": "New-Web-Server",           // 主机名
        "interfaces": [                     // 监控接口配置
            {
                "type": 1,                  // 1=Agent接口
                "main": 1,                  // 1=主要接口
                "useip": 1,                 // 1=使用IP，0=使用DNS
                "ip": "192.168.1.200",      // IP地址
                "dns": "",                  // DNS名称
                "port": "10050"             // 端口号
            }
        ],
        "groups": [                         // 所属主机组
            {
                "groupid": "2"              // 组ID，2通常是Linux servers
            }
        ],
        "templates": [                      // 关联模板
            {
                "templateid": "10001"       // 模板ID
            }
        ]
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

### 4.4 批量操作主机


**🔧 批量启用/禁用主机**
```bash
# 批量禁用多台主机（比如维护期间）
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "host.update",
    "params": {
        "hostid": "10084",
        "status": 1
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

---

## 5. 📊 监控项API操作


### 5.1 监控项基础概念


**🔸 什么是监控项**
```
监控项就像是医院的体检项目：
- 血压：对应CPU使用率
- 心率：对应网络流量
- 体温：对应磁盘空间
- 血糖：对应内存使用

每个监控项都有：
📏 测量什么（CPU、内存、磁盘）
⏱️ 多久测一次（30秒、1分钟、5分钟）
📈 数据类型（数字、文本、百分比）
💾 保存多久（7天、30天、1年）
```

### 5.2 获取监控项列表


**📋 查询主机的监控项**
```bash
# 获取特定主机的所有监控项
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "item.get",
    "params": {
        "output": "extend",
        "hostids": "10084",
        "search": {
            "key_": "system"
        }
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

### 5.3 常用监控项类型


**📊 监控项类型说明**

| 类型编号 | **名称** | **说明** | **使用场景** |
|---------|---------|---------|-------------|
| 0 | `Zabbix agent` | `通过Agent获取数据` | `服务器基础监控` |
| 2 | `Zabbix trapper` | `被动接收数据` | `自定义脚本推送` |
| 3 | `Simple check` | `简单检查` | `网络连通性测试` |
| 7 | `Zabbix agent (active)` | `主动模式Agent` | `大规模环境监控` |
| 10 | `External check` | `外部脚本` | `复杂自定义检查` |

### 5.4 创建监控项实例


**📈 CPU使用率监控项**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "item.create",
    "params": {
        "name": "CPU使用率",
        "key_": "system.cpu.util[,idle]",
        "hostid": "10084",
        "type": 0,
        "value_type": 0,
        "delay": "60s",
        "units": "%",
        "description": "CPU空闲百分比监控"
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

**💾 磁盘空间监控项**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "item.create",
    "params": {
        "name": "根分区剩余空间",
        "key_": "vfs.fs.size[/,free]",
        "hostid": "10084",
        "type": 0,
        "value_type": 3,
        "delay": "300s",
        "units": "B",
        "description": "根分区可用磁盘空间"
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

### 5.5 监控项参数详解


**⚙️ 重要参数说明**
```
value_type（数据类型）：
0 = 浮点数（小数）
1 = 字符（文本）
2 = 日志文件
3 = 无符号整数
4 = 文本内容

delay（采集间隔）：
"30s" = 30秒采集一次
"5m" = 5分钟采集一次
"1h" = 1小时采集一次
"1d" = 1天采集一次

units（单位）：
"%" = 百分比
"B" = 字节
"bps" = 比特每秒
"ops" = 操作次数
```

---

## 6. 🚨 触发器API管理


### 6.1 触发器基础理解


**🔸 什么是触发器**
```
触发器就像是智能报警器：
- 烟雾报警器：检测到烟雾就报警
- 温度报警器：超过设定温度就报警
- 门磁报警器：门被打开就报警

Zabbix触发器：
🔥 CPU使用率 > 90% 就报警
💧 磁盘空间 < 10% 就报警
⚡ 服务器无响应就报警

触发器的状态：
✅ OK：一切正常
❗ PROBLEM：出现问题需要关注
```

### 6.2 获取触发器列表


**📋 查询主机触发器**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "trigger.get",
    "params": {
        "output": "extend",
        "hostids": "10084",
        "selectFunctions": "extend",
        "selectHosts": ["host"]
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

### 6.3 触发器优先级设置


**🚩 优先级等级说明**

| 级别 | **名称** | **颜色** | **使用场景** |
|------|---------|---------|-------------|
| 0 | `未分类` | `灰色` | `一般信息提示` |
| 1 | `信息` | `浅蓝色` | `状态变化通知` |
| 2 | `警告` | `黄色` | `需要关注的问题` |
| 3 | `一般严重` | `橙色` | `影响业务的问题` |
| 4 | `严重` | `浅红色` | `严重影响业务` |
| 5 | `灾难` | `深红色` | `系统崩溃级别` |

### 6.4 创建触发器实例


**⚠️ CPU使用率报警触发器**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "trigger.create",
    "params": {
        "description": "CPU使用率过高",
        "expression": "last(/Web-Server-01/system.cpu.util[,idle])<10",
        "priority": 3,
        "comments": "CPU空闲率小于10%时触发报警"
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

**💾 磁盘空间报警触发器**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "trigger.create",
    "params": {
        "description": "根分区磁盘空间不足",
        "expression": "last(/Web-Server-01/vfs.fs.size[/,pfree])<20",
        "priority": 4,
        "comments": "根分区剩余空间小于20%时触发严重报警"
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

### 6.5 触发器表达式解析


**🧮 表达式语法理解**
```
表达式就像是数学公式：

基本格式：
function(/主机名/监控项key,参数)比较符数值

常用函数：
last() = 最新值
avg() = 平均值
min() = 最小值
max() = 最大值

实际例子：
last(/Web-Server/system.cpu.util[,idle])<10
↓
获取Web-Server主机的CPU空闲率最新值，如果小于10就报警

avg(/Web-Server/system.cpu.util[,idle],5m)<20  
↓
获取Web-Server主机CPU空闲率5分钟平均值，如果小于20就报警
```

---

## 7. 📢 问题与事件处理API


### 7.1 问题管理概念


**🔸 问题与事件的区别**
```
事件：记录发生的所有事情
- 就像监控摄像头，记录所有画面
- 包括：问题产生、问题恢复、配置变更等

问题：当前需要关注的事件
- 就像是火灾报警，需要立即处理
- 只包括：当前未解决的故障

状态流转：
正常 → 检测到异常 → 生成事件 → 创建问题
问题解决 → 系统恢复正常 → 问题自动关闭
```

### 7.2 获取当前问题


**📋 查询未解决的问题**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "problem.get",
    "params": {
        "output": "extend",
        "selectAcknowledges": "extend",
        "selectTags": "extend",
        "recent": "true",
        "sortfield": ["eventid"],
        "sortorder": "DESC"
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

### 7.3 问题确认操作


**✅ 确认问题处理**
```
问题确认的作用：
📝 告诉系统"我知道这个问题了"
👥 让团队其他人知道有人在处理
⏰ 记录处理时间和负责人
📋 添加处理说明和解决方案
```

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "event.acknowledge",
    "params": {
        "eventids": "12345",
        "action": 6,
        "message": "CPU使用率过高问题已确认，正在检查具体进程"
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

### 7.4 确认动作类型


**🎯 确认动作说明**

| 动作值 | **说明** | **实际作用** |
|-------|---------|-------------|
| 1 | `关闭问题` | `手动标记问题已解决` |
| 2 | `确认问题` | `表示已知晓此问题` |
| 4 | `添加消息` | `记录处理过程说明` |
| 8 | `改变严重性` | `调整问题优先级` |

```bash
# 组合操作：确认+添加消息
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "event.acknowledge",
    "params": {
        "eventids": ["12345", "12346"],
        "action": 6,
        "message": "批量确认CPU相关问题，正在统一处理"
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

---

## 8. 📋 模板和主机组API


### 8.1 模板管理基础


**🔸 模板的作用理解**
```
模板就像是"装修标准方案"：
🏠 精装修方案：包含所有家具家电配置
🖥️ Linux服务器模板：包含所有基础监控项

使用模板的好处：
✅ 标准化：所有同类服务器配置一致
✅ 快速部署：新服务器一键应用模板
✅ 统一管理：修改模板影响所有关联主机
✅ 减少错误：避免手工配置的遗漏
```

### 8.2 获取模板列表


**📋 查询可用模板**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "template.get",
    "params": {
        "output": ["templateid", "host", "name"],
        "search": {
            "name": "Linux"
        }
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

### 8.3 主机组管理


**👥 主机组的组织作用**
```
主机组就像公司的部门划分：
🌐 Web服务器组：所有提供网站服务的服务器
💾 数据库组：所有数据库服务器
🔧 基础设施组：路由器、交换机等网络设备

组织的好处：
📊 分组统计：按部门查看资源使用情况
🎯 权限控制：不同团队管理不同组的设备
📧 批量操作：对整个组进行统一配置
📈 报表生成：按组生成性能报告
```

**📋 获取主机组列表**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "hostgroup.get",
    "params": {
        "output": "extend",
        "selectHosts": ["hostid", "host"]
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

### 8.4 创建主机组


**➕ 新建主机组**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "hostgroup.create",
    "params": {
        "name": "Docker容器组"
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

---

## 9. 📈 数据查询与历史记录API


### 9.1 历史数据概念


**🔸 历史数据的价值**
```
历史数据就像是体检记录：
📊 趋势分析：CPU使用率是否在逐渐升高
🔍 问题排查：故障发生时各项指标的变化
📈 容量规划：根据增长趋势预测扩容需求
📋 性能优化：找出性能瓶颈的时间规律

数据类型分类：
🔢 数值数据：CPU、内存、磁盘使用率
📝 文本数据：日志内容、版本信息
📊 聚合数据：平均值、最大值、趋势数据
```

### 9.2 获取历史数据


**📊 查询监控项历史数据**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "history.get",
    "params": {
        "output": "extend",
        "history": 0,
        "itemids": "23296",
        "sortfield": "clock",
        "sortorder": "DESC",
        "limit": 10
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

### 9.3 时间范围查询


**⏰ 指定时间段的数据**
```bash
# 查询最近24小时的数据
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "history.get",
    "params": {
        "output": "extend",
        "history": 0,
        "itemids": "23296",
        "time_from": "'$(date -d "24 hours ago" +%s)'",
        "time_till": "'$(date +%s)'"
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

### 9.4 趋势数据查询


**📈 获取聚合趋势数据**
```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "trend.get",
    "params": {
        "output": "extend",
        "itemids": "23296",
        "time_from": "'$(date -d "7 days ago" +%s)'",
        "time_till": "'$(date +%s)'"
    },
    "auth": "your_auth_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php
```

---

## 10. 🔧 API调试与错误处理


### 10.1 常见错误类型


**❌ API调用常见问题**

| 错误代码 | **含义** | **可能原因** | **解决方法** |
|---------|---------|-------------|-------------|
| -32700 | `解析错误` | `JSON格式不正确` | `检查JSON语法` |
| -32602 | `参数无效` | `参数格式或类型错误` | `核对API文档参数要求` |
| -32500 | `应用错误` | `业务逻辑错误` | `检查权限和数据状态` |
| -32603 | `内部错误` | `服务器内部问题` | `检查Zabbix日志` |

### 10.2 调试技巧


**🔍 API调试最佳实践**
```bash
# 1. 先测试简单的API
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"apiinfo.version","id":1}' \
  http://your-zabbix/api_jsonrpc.php

# 2. 验证认证令牌
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "user.get",
    "params": {
        "output": ["userid", "alias"]
    },
    "auth": "your_token",
    "id": 1
  }' \
  http://your-zabbix/api_jsonrpc.php

# 3. 使用jq美化JSON输出
curl ... | jq '.'
```

### 10.3 错误处理示例


**💡 Python错误处理代码**
```python
import requests
import json

def zabbix_api_call(url, payload, auth_token=None):
    """安全的Zabbix API调用函数"""
    
    if auth_token:
        payload['auth'] = auth_token
    
    headers = {'Content-Type': 'application/json'}
    
    try:
        response = requests.post(url, 
                               data=json.dumps(payload), 
                               headers=headers, 
                               timeout=30)
        
        result = response.json()
        
        if 'error' in result:
            print(f"API错误: {result['error']['message']}")
            return None
        
        return result['result']
        
    except requests.exceptions.RequestException as e:
        print(f"网络请求错误: {e}")
        return None
    except json.JSONDecodeError as e:
        print(f"JSON解析错误: {e}")
        return None
```

---

## 11. 🚀 实用脚本与自动化


### 11.1 批量主机管理脚本


**📝 Python批量操作示例**
```python
#!/usr/bin/env python3
"""
Zabbix批量主机管理脚本
功能：批量添加、启用、禁用主机
"""

import requests
import json
import sys

class ZabbixAPI:
    def __init__(self, url, username, password):
        self.url = url
        self.auth_token = None
        self.login(username, password)
    
    def login(self, username, password):
        """用户登录获取认证令牌"""
        payload = {
            "jsonrpc": "2.0",
            "method": "user.login",
            "params": {
                "user": username,
                "password": password
            },
            "id": 1
        }
        
        result = self._call_api(payload)
        if result:
            self.auth_token = result
            print("✅ 登录成功")
        else:
            print("❌ 登录失败")
            sys.exit(1)
    
    def _call_api(self, payload):
        """统一的API调用方法"""
        if self.auth_token:
            payload['auth'] = self.auth_token
        
        try:
            response = requests.post(
                self.url,
                data=json.dumps(payload),
                headers={'Content-Type': 'application/json'},
                timeout=30
            )
            
            result = response.json()
            
            if 'error' in result:
                print(f"API错误: {result['error']['message']}")
                return None
            
            return result['result']
            
        except Exception as e:
            print(f"请求错误: {e}")
            return None
    
    def get_hosts(self, group_name=None):
        """获取主机列表"""
        payload = {
            "jsonrpc": "2.0",
            "method": "host.get",
            "params": {
                "output": ["hostid", "host", "status"],
                "selectGroups": "extend"
            },
            "id": 1
        }
        
        hosts = self._call_api(payload)
        
        if group_name:
            # 按组名过滤
            filtered_hosts = []
            for host in hosts:
                for group in host['groups']:
                    if group['name'] == group_name:
                        filtered_hosts.append(host)
                        break
            return filtered_hosts
        
        return hosts
    
    def batch_update_status(self, host_ids, status):
        """批量更新主机状态"""
        for host_id in host_ids:
            payload = {
                "jsonrpc": "2.0",
                "method": "host.update",
                "params": {
                    "hostid": host_id,
                    "status": status
                },
                "id": 1
            }
            
            result = self._call_api(payload)
            if result:
                status_text = "启用" if status == 0 else "禁用"
                print(f"✅ 主机 {host_id} {status_text}成功")

# 使用示例
if __name__ == "__main__":
    # 配置信息
    ZABBIX_URL = "http://your-zabbix/api_jsonrpc.php"
    USERNAME = "Admin"
    PASSWORD = "zabbix"
    
    # 创建API对象
    zapi = ZabbixAPI(ZABBIX_URL, USERNAME, PASSWORD)
    
    # 获取所有主机
    hosts = zapi.get_hosts()
    print(f"📊 总共找到 {len(hosts)} 台主机")
    
    # 批量操作示例
    # zapi.batch_update_status(["10084", "10085"], 1)  # 禁用指定主机
```

### 11.2 监控数据导出脚本


**📊 数据导出自动化**
```bash
#!/bin/bash
# Zabbix监控数据导出脚本

ZABBIX_URL="http://your-zabbix/api_jsonrpc.php"
USERNAME="Admin"
PASSWORD="zabbix"

# 获取认证令牌
get_auth_token() {
    curl -s -X POST \
        -H "Content-Type: application/json" \
        -d "{
            \"jsonrpc\": \"2.0\",
            \"method\": \"user.login\",
            \"params\": {
                \"user\": \"$USERNAME\",
                \"password\": \"$PASSWORD\"
            },
            \"id\": 1
        }" \
        "$ZABBIX_URL" | jq -r '.result'
}

# 导出主机清单
export_hosts() {
    local auth_token=$1
    echo "📋 导出主机清单..."
    
    curl -s -X POST \
        -H "Content-Type: application/json" \
        -d "{
            \"jsonrpc\": \"2.0\",
            \"method\": \"host.get\",
            \"params\": {
                \"output\": [\"hostid\", \"host\", \"status\"],
                \"selectInterfaces\": \"extend\",
                \"selectGroups\": \"extend\"
            },
            \"auth\": \"$auth_token\",
            \"id\": 1
        }" \
        "$ZABBIX_URL" | jq '.result' > "hosts_$(date +%Y%m%d).json"
    
    echo "✅ 主机清单已导出到 hosts_$(date +%Y%m%d).json"
}

# 主函数
main() {
    echo "🚀 开始导出Zabbix数据..."
    
    AUTH_TOKEN=$(get_auth_token)
    
    if [ "$AUTH_TOKEN" = "null" ] || [ -z "$AUTH_TOKEN" ]; then
        echo "❌ 认证失败，请检查用户名和密码"
        exit 1
    fi
    
    echo "✅ 认证成功"
    export_hosts "$AUTH_TOKEN"
    
    echo "🎉 数据导出完成"
}

main "$@"
```

---

## 12. 📋 核心要点总结


### 12.1 必须掌握的基本概念


```
🔸 API本质：通过标准JSON格式与Zabbix系统通信的接口
🔸 认证机制：用户名密码换取令牌，令牌用于后续所有操作
🔸 请求格式：jsonrpc、method、params、auth、id五个核心字段
🔸 主要对象：主机、监控项、触发器、问题、模板、主机组
🔸 操作类型：get查询、create创建、update修改、delete删除
```

### 12.2 关键理解要点


**🔹 API学习的层次递进**
```
基础层：
- 理解JSON-RPC协议格式
- 掌握认证登录流程
- 熟悉基本的get操作

应用层：
- 批量操作主机和监控项
- 自动化问题处理
- 数据导出和报表生成

高级层：
- 错误处理和异常恢复
- 性能优化和批量处理
- 与其他系统集成
```

**🔹 实际工作中的应用价值**
```
日常运维：
✅ 新服务器快速批量添加到监控
✅ 维护期间批量禁用告警
✅ 自动确认已知问题的告警
✅ 定期导出监控数据做报表

自动化集成：
✅ 与CMDB系统同步主机信息
✅ 集成到CI/CD流程中
✅ 开发监控数据可视化大屏
✅ 实现智能告警和自动处理
```

### 12.3 学习建议和最佳实践


**💡 学习路径建议**
```
第一阶段：基础操作
1. 熟练使用curl进行API调用
2. 掌握登录认证和基本查询
3. 理解JSON响应格式

第二阶段：实用操作  
1. 批量管理主机和监控项
2. 处理告警和问题确认
3. 数据查询和导出

第三阶段：自动化开发
1. 编写Python/Bash脚本
2. 集成到现有系统中
3. 开发监控工具和平台
```

**🛠️ 实践建议**
```
开发环境：
✅ 搭建测试环境进行练习
✅ 使用Postman等工具调试API
✅ 保存常用的API调用模板

代码管理：
✅ 统一错误处理机制
✅ 合理设置超时和重试
✅ 记录详细的操作日志

安全考虑：
✅ 使用专门的API账号
✅ 定期更换认证密码
✅ 限制API账号权限范围
```

### 12.4 常用API速查


```
核心API方法：

用户认证：
user.login          # 登录获取令牌
user.logout         # 退出登录

主机管理：
host.get            # 查询主机
host.create         # 创建主机
host.update         # 更新主机
host.delete         # 删除主机

监控管理：
item.get            # 查询监控项
trigger.get         # 查询触发器
problem.get         # 查询问题
event.acknowledge   # 确认事件

数据查询：
history.get         # 历史数据
trend.get           # 趋势数据
```

**核心记忆要点**：
- Zabbix API是自动化运维的重要工具
- JSON-RPC格式简单易学，五个字段构成请求
- 认证令牌是所有操作的前提，注意安全管理
- 从简单查询开始，逐步掌握复杂操作
- 实践是最好的学习方法，多动手多尝试