---
title: 5、触发器管理API
---
## 📚 目录

1. [触发器基础概念](#1-触发器基础概念)
2. [触发器查询API](#2-触发器查询API)
3. [触发器创建API](#3-触发器创建API)
4. [触发器更新API](#4-触发器更新API)
5. [触发器删除API](#5-触发器删除API)
6. [触发器表达式详解](#6-触发器表达式详解)
7. [触发器高级配置](#7-触发器高级配置)
8. [实战应用场景](#8-实战应用场景)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🎯 触发器基础概念


### 1.1 什么是触发器


**简单理解**：触发器就像是监控系统的"警报器"
```
现实生活类比：
火灾报警器 → Zabbix触发器
烟雾浓度  → 监控项数据
报警响起  → 触发器激活

当监控数据达到设定条件时，触发器就会"响起警报"
```

**核心作用**：
- 🔸 **自动判断**：根据监控数据自动判断是否异常
- 🔸 **及时告警**：问题发生时立即通知管理员
- 🔸 **状态跟踪**：记录问题的产生和恢复过程

### 1.2 触发器的工作原理


```
工作流程图：
监控项收集数据 → 触发器计算表达式 → 判断是否满足条件 → 产生告警事件

详细说明：
┌─────────────┐    ┌──────────────┐    ┌─────────────┐    ┌─────────────┐
│ 监控项数据   │ → │ 触发器表达式  │ → │ 条件判断     │ → │ 告警事件     │
│ CPU: 85%    │    │ {host:cpu}>80 │    │ 85% > 80%   │    │ 高CPU使用率  │
└─────────────┘    └──────────────┘    └─────────────┘    └─────────────┘
```

### 1.3 触发器状态说明


| 状态 | **英文名称** | **中文含义** | **说明** |
|------|------------|------------|----------|
| 🟢 | `OK` | `正常` | `条件不满足，系统正常` |
| 🔴 | `PROBLEM` | `问题` | `条件满足，出现异常` |
| 🟡 | `UNKNOWN` | `未知` | `无法获取数据或计算` |

---

## 2. 🔍 触发器查询API


### 2.1 基础查询方法


**API方法**：`trigger.get`

**基本语法**：
```json
{
    "jsonrpc": "2.0",
    "method": "trigger.get",
    "params": {
        "查询条件": "具体参数"
    },
    "auth": "认证token",
    "id": 1
}
```

### 2.2 常用查询参数详解


**🔸 triggerids** - 按ID查询特定触发器
```bash
# 查询指定ID的触发器
curl -X POST http://zabbix-server/api_jsonrpc.php \
-H "Content-Type: application/json" \
-d '{
    "jsonrpc": "2.0",
    "method": "trigger.get",
    "params": {
        "triggerids": ["13", "17"]
    },
    "auth": "your_auth_token",
    "id": 1
}'
```

**🔸 hostids** - 查询指定主机的所有触发器
```json
{
    "jsonrpc": "2.0",
    "method": "trigger.get",
    "params": {
        "hostids": ["10084"],
        "output": ["triggerid", "description", "status"]
    },
    "auth": "auth_token",
    "id": 1
}
```

### 2.3 过滤和排序选项


**状态过滤**：
```json
{
    "params": {
        "filter": {
            "status": "0"    // 0=启用, 1=禁用
        }
    }
}
```

**优先级过滤**：
```json
{
    "params": {
        "filter": {
            "priority": ["2", "3", "4"]  // 2=警告, 3=一般严重, 4=严重
        }
    }
}
```

**排序选项**：
```json
{
    "params": {
        "sortfield": ["priority", "description"],
        "sortorder": "DESC"  // ASC=升序, DESC=降序
    }
}
```

### 2.4 输出字段控制


**常用输出字段**：
```json
{
    "params": {
        "output": [
            "triggerid",      // 触发器ID
            "description",    // 描述信息
            "expression",     // 触发表达式
            "priority",       // 优先级
            "status",         // 启用状态
            "type",          // 类型
            "url",           // 自定义URL
            "recovery_mode"   // 恢复模式
        ]
    }
}
```

---

## 3. ➕ 触发器创建API


### 3.1 创建基础触发器


**API方法**：`trigger.create`

**最简单的触发器创建**：
```json
{
    "jsonrpc": "2.0",
    "method": "trigger.create",
    "params": {
        "description": "CPU使用率过高",
        "expression": "{Web Server:system.cpu.util.avg(5m)}>80"
    },
    "auth": "auth_token",
    "id": 1
}
```

**参数说明**：
- **description**：触发器名称描述
- **expression**：触发条件表达式

### 3.2 完整参数的触发器创建


```json
{
    "jsonrpc": "2.0",
    "method": "trigger.create",
    "params": {
        "description": "内存使用率严重告警",
        "expression": "{Web Server:vm.memory.util.avg(10m)}>90",
        "priority": 4,
        "status": 0,
        "type": 0,
        "recovery_mode": 0,
        "recovery_expression": "{Web Server:vm.memory.util.avg(5m)}<85",
        "correlation_mode": 0,
        "manual_close": 1,
        "url": "http://wiki.company.com/memory-troubleshooting",
        "comments": "内存使用率超过90%时触发，自动恢复阈值为85%",
        "tags": [
            {
                "tag": "severity",
                "value": "high"
            },
            {
                "tag": "component", 
                "value": "memory"
            }
        ]
    },
    "auth": "auth_token",
    "id": 1
}
```

### 3.3 关键参数详细说明


**🔸 priority（优先级设置）**
```
0 = 未分类     （灰色）
1 = 信息       （绿色）
2 = 警告       （黄色）
3 = 一般严重    （橙色）
4 = 严重       （浅红色）
5 = 灾难       （红色）

选择建议：
- CPU/内存轻微超标 → 警告(2)
- 服务响应慢 → 一般严重(3)  
- 服务不可用 → 严重(4)
- 系统完全瘫痪 → 灾难(5)
```

**🔸 type（触发器类型）**
```
0 = 普通触发器（默认）
1 = 多重触发器

普通触发器：一个问题对应一个事件
多重触发器：可以产生多个独立事件
```

**🔸 recovery_mode（恢复模式）**
```
0 = 表达式（默认）- 当原表达式不满足时自动恢复
1 = 恢复表达式 - 需要单独的恢复条件
2 = 无 - 需要手动关闭
```

---

## 4. 🔄 触发器更新API


### 4.1 基础更新操作


**API方法**：`trigger.update`

**更新触发器描述**：
```json
{
    "jsonrpc": "2.0",
    "method": "trigger.update",
    "params": {
        "triggerid": "13",
        "description": "CPU使用率告警（已优化阈值）"
    },
    "auth": "auth_token",
    "id": 1
}
```

### 4.2 批量更新多个触发器


```json
{
    "jsonrpc": "2.0",
    "method": "trigger.update",
    "params": [
        {
            "triggerid": "13",
            "priority": 3,
            "status": 0
        },
        {
            "triggerid": "17", 
            "priority": 4,
            "url": "http://docs.company.com/alerts"
        }
    ],
    "auth": "auth_token",
    "id": 1
}
```

### 4.3 更新触发器表达式


**表达式更新示例**：
```json
{
    "jsonrpc": "2.0",
    "method": "trigger.update", 
    "params": {
        "triggerid": "13",
        "expression": "{Web Server:system.cpu.util.avg(10m)}>85",
        "recovery_expression": "{Web Server:system.cpu.util.avg(5m)}<80"
    },
    "auth": "auth_token",
    "id": 1
}
```

**更新说明**：
- 原始阈值：80% → 新阈值：85%
- 增加恢复表达式：低于80%时自动恢复

---

## 5. 🗑️ 触发器删除API


### 5.1 删除指定触发器


**API方法**：`trigger.delete`

**删除单个触发器**：
```json
{
    "jsonrpc": "2.0",
    "method": "trigger.delete",
    "params": ["13"],
    "auth": "auth_token",
    "id": 1
}
```

### 5.2 批量删除触发器


```json
{
    "jsonrpc": "2.0",
    "method": "trigger.delete",
    "params": ["13", "17", "25"],
    "auth": "auth_token", 
    "id": 1
}
```

> ⚠️ **重要提醒**：删除触发器会同时删除相关的告警历史和事件记录，操作前请确认！

---

## 6. 📐 触发器表达式详解


### 6.1 表达式基本语法


**标准格式**：
```
{主机名:监控项键值.函数(参数)}操作符阈值
```

**语法分解说明**：
```
{Web Server:system.cpu.util.avg(5m)}>80

分解：
- Web Server     → 主机名
- system.cpu.util → 监控项键值  
- avg(5m)        → 函数：5分钟平均值
- >80            → 条件：大于80
```

### 6.2 常用触发器函数


**🔸 avg() - 平均值函数**
```bash
# 5分钟内CPU平均使用率
{host:system.cpu.util.avg(5m)}>80

# 1小时内磁盘空间平均使用率  
{host:vfs.fs.size[/,pused].avg(1h)}>90
```

**🔸 max() - 最大值函数**
```bash
# 10分钟内最大响应时间
{host:net.tcp.service.perf[http,80].max(10m)}>5

# 30分钟内最大网络流量
{host:net.if.in[eth0].max(30m)}>1000000000
```

**🔸 min() - 最小值函数**
```bash
# 检查最小可用内存
{host:vm.memory.size[available].min(5m)}<1000000000
```

**🔸 last() - 最新值函数**
```bash
# 检查最新的进程数量
{host:proc.num[httpd].last()}<1

# 检查最新的磁盘空间
{host:vfs.fs.size[/,free].last()}<5000000000
```

### 6.3 复杂表达式构建


**逻辑组合表达式**：
```bash
# AND逻辑：CPU和内存同时告警
{host:system.cpu.util.avg(5m)}>80 and {host:vm.memory.util.avg(5m)}>90

# OR逻辑：磁盘空间或inode不足
{host:vfs.fs.size[/,pused].last()}>95 or {host:vfs.fs.inode[/,pused].last()}>95
```

**时间比较表达式**：
```bash
# 检查值是否持续上升
{host:system.cpu.util.avg(5m)}>{host:system.cpu.util.avg(10m)}

# 检查服务是否连续失败
{host:net.tcp.service[http,80].last()}=0 and {host:net.tcp.service[http,80].last(#2)}=0
```

### 6.4 表达式常见错误及解决


**❌ 常见错误**：
```bash
# 错误：主机名包含空格但未用引号
{Web Server:system.cpu.util.avg(5m)}>80

# 正确：使用引号包围含空格的主机名
{"Web Server":system.cpu.util.avg(5m)}>80
```

**❌ 函数参数错误**：
```bash
# 错误：时间参数格式不对
{host:system.cpu.util.avg(5min)}>80

# 正确：使用标准时间格式
{host:system.cpu.util.avg(5m)}>80
```

---

## 7. ⚙️ 触发器高级配置


### 7.1 依赖关系设置


**概念说明**：如果A依赖B，当B出现问题时，A的告警会被抑制

**设置依赖关系**：
```json
{
    "jsonrpc": "2.0",
    "method": "trigger.update",
    "params": {
        "triggerid": "13",
        "dependencies": [
            {
                "triggerid": "17"  // 依赖的触发器ID
            }
        ]
    },
    "auth": "auth_token",
    "id": 1
}
```

**实际应用场景**：
```
网络设备层级依赖：
路由器故障 → 交换机告警被抑制 → 服务器告警被抑制

这样避免了一个网络问题导致大量无意义的告警
```

### 7.2 标签管理


**添加标签**：
```json
{
    "jsonrpc": "2.0",
    "method": "trigger.create",
    "params": {
        "description": "数据库连接异常",
        "expression": "{DB Server:net.tcp.service[mysql].last()}=0",
        "tags": [
            {
                "tag": "service",
                "value": "database"
            },
            {
                "tag": "team", 
                "value": "dba"
            },
            {
                "tag": "priority",
                "value": "high"
            }
        ]
    },
    "auth": "auth_token",
    "id": 1
}
```

**标签的作用**：
- 🏷️ **分类管理**：按服务类型、团队责任人分类
- 🎯 **告警路由**：根据标签发送给不同的团队
- 📊 **统计分析**：按标签统计告警数量和类型

### 7.3 关联模式配置


**correlation_mode参数说明**：
```json
{
    "correlation_mode": 0,  // 0=不关联, 1=标签关联
    "correlation_tag": "incident_id"  // 关联标签名
}
```

**关联的好处**：
- 相关告警会被分组显示
- 便于问题的整体分析和处理
- 避免告警信息过于分散

### 7.4 手动关闭设置


```json
{
    "manual_close": 1,  // 1=允许手动关闭, 0=不允许
    "recovery_mode": 2  // 2=无自动恢复，必须手动关闭
}
```

**适用场景**：
- 需要人工干预确认的问题
- 系统维护期间的告警
- 需要记录处理过程的严重告警

---

## 8. 🛠️ 实战应用场景


### 8.1 Web服务监控触发器


**场景**：监控Web服务的可用性和性能

```json
{
    "jsonrpc": "2.0",
    "method": "trigger.create",
    "params": [
        {
            "description": "Web服务不可用",
            "expression": "{Web Server:net.tcp.service[http].last()}=0",
            "priority": 5,
            "recovery_mode": 0,
            "tags": [
                {"tag": "service", "value": "web"},
                {"tag": "severity", "value": "critical"}
            ]
        },
        {
            "description": "Web响应时间过慢", 
            "expression": "{Web Server:net.tcp.service.perf[http].avg(5m)}>3",
            "priority": 3,
            "recovery_expression": "{Web Server:net.tcp.service.perf[http].avg(5m)}<2"
        }
    ],
    "auth": "auth_token",
    "id": 1
}
```

### 8.2 数据库监控触发器


**场景**：监控数据库性能和连接状态

```json
{
    "jsonrpc": "2.0", 
    "method": "trigger.create",
    "params": [
        {
            "description": "数据库连接数过多",
            "expression": "{DB Server:mysql.threads_connected.avg(5m)}>80",
            "priority": 4,
            "url": "http://wiki.company.com/mysql-connections",
            "comments": "当MySQL连接数超过80时告警，检查应用连接池配置"
        },
        {
            "description": "数据库慢查询增多",
            "expression": "{DB Server:mysql.slow_queries.avg(10m)}>10", 
            "priority": 3
        }
    ],
    "auth": "auth_token",
    "id": 1
}
```

### 8.3 系统资源监控触发器


**场景**：监控服务器基础资源

```json
{
    "jsonrpc": "2.0",
    "method": "trigger.create", 
    "params": [
        {
            "description": "CPU使用率过高",
            "expression": "{Server:system.cpu.util.avg(5m)}>85 and {Server:system.cpu.util.avg(10m)}>80",
            "priority": 3,
            "recovery_expression": "{Server:system.cpu.util.avg(5m)}<75"
        },
        {
            "description": "内存使用率严重",
            "expression": "{Server:vm.memory.util.avg(5m)}>95",
            "priority": 4,
            "manual_close": 1
        },
        {
            "description": "磁盘空间不足",
            "expression": "{Server:vfs.fs.size[/,pused].last()}>90",
            "priority": 4,
            "url": "http://runbook.company.com/disk-cleanup"
        }
    ],
    "auth": "auth_token",
    "id": 1
}
```

### 8.4 网络监控触发器


**场景**：监控网络连通性和流量

```bash
# 网络延迟监控
curl -X POST http://zabbix-server/api_jsonrpc.php \
-H "Content-Type: application/json" \
-d '{
    "jsonrpc": "2.0",
    "method": "trigger.create",
    "params": {
        "description": "网络延迟过高",
        "expression": "{Gateway:icmpping.avg(5m)}>0.1 or {Gateway:icmppingloss.avg(5m)}>10",
        "priority": 3,
        "comments": "网络延迟超过100ms或丢包率超过10%"
    },
    "auth": "auth_token",
    "id": 1
}'
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


**🔸 触发器四大操作**
```
trigger.get    → 查询触发器信息
trigger.create → 创建新的触发器  
trigger.update → 更新现有触发器
trigger.delete → 删除不需要的触发器
```

**🔸 触发器三要素**
```
description  → 触发器名称描述（必需）
expression   → 触发条件表达式（必需）  
priority     → 告警优先级（推荐设置）
```

**🔸 表达式语法结构**
```
{主机名:监控项.函数(时间)}操作符阈值

实例：{Web Server:system.cpu.util.avg(5m)}>80
```

### 9.2 关键理解要点


**🔹 触发器状态循环**
```
正常状态(OK) → 条件满足 → 问题状态(PROBLEM) → 条件恢复 → 正常状态(OK)

理解：触发器会在正常和问题状态之间自动切换
```

**🔹 优先级选择原则**
```
信息(1)   → 系统信息通知
警告(2)   → 需要关注但不紧急
一般严重(3) → 影响性能但服务可用
严重(4)   → 服务受到明显影响  
灾难(5)   → 服务完全不可用
```

**🔹 恢复模式选择**
```
表达式恢复(0)   → 条件不满足时自动恢复（常用）
恢复表达式(1)   → 需要满足另一个条件才恢复
手动恢复(2)     → 必须人工确认后才恢复
```

### 9.3 实用操作技巧


**🎯 批量操作提升效率**
- 创建触发器时可以传递数组同时创建多个
- 更新操作支持批量修改多个触发器属性
- 删除操作可以同时删除多个触发器ID

**🎯 表达式优化建议**
- 使用适当的时间窗口：太短容易误报，太长响应不及时
- 组合多个条件：避免单一指标的偶然波动
- 设置合理的恢复阈值：避免频繁的状态切换

**🎯 标签管理最佳实践**
- 按服务类型分类：web、database、network等
- 按责任团队分类：便于告警分发和处理
- 按严重程度分类：便于优先级排序和统计

### 9.4 常见问题避免


**❌ 避免的常见错误**
- 主机名包含特殊字符时忘记用引号包围
- 时间参数使用错误的格式（如5min而不是5m）
- 设置过低的阈值导致频繁误报
- 忘记设置恢复条件导致告警无法自动清除

**✅ 推荐的最佳实践**
- 新建触发器前先测试表达式的有效性
- 为重要触发器设置依赖关系避免告警风暴
- 定期审查和优化触发器阈值
- 为触发器添加详细的注释和自定义URL

**核心记忆口诀**：
- 触发器管理四步走：查询创建更新删
- 表达式语法要记牢：主机监控项函数条件
- 优先级设置要合理：信息警告严重灾难
- 恢复模式选择好：自动手动看需要