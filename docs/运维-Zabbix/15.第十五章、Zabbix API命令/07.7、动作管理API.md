---
title: 7、动作管理API
---
## 📚 目录

1. [动作管理API概述](#1-动作管理API概述)
2. [动作查询API详解](#2-动作查询API详解)
3. [动作创建API实战](#3-动作创建API实战)
4. [动作更新与删除](#4-动作更新与删除)
5. [触发条件配置深入](#5-触发条件配置深入)
6. [执行操作配置详解](#6-执行操作配置详解)
7. [上报策略与优先级](#7-上报策略与优先级)
8. [实战案例与最佳实践](#8-实战案例与最佳实践)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🎯 动作管理API概述


### 1.1 什么是Zabbix动作


**🔸 动作的本质理解**
```
简单来说：动作就是"当发生什么情况时，要做什么事情"的自动化规则

生活中的例子：
• 当水温超过90度时 → 自动关闭加热器
• 当门铃响起时 → 发送手机通知
• 当银行卡余额不足时 → 发送短信提醒

Zabbix中的动作：
• 当CPU使用率超过90%时 → 发送邮件给管理员
• 当服务器宕机时 → 发送短信并重启服务
• 当磁盘空间不足时 → 执行清理脚本
```

**📋 动作的核心组成**
```
动作 = 触发条件 + 执行操作 + 恢复操作

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   触发条件       │    │   执行操作       │    │   恢复操作       │
│ (什么时候触发)   │───▶│ (要做什么事)     │───▶│ (问题解决后做什么)│
│                │    │                │    │                │
│ • 主机组判断     │    │ • 发送通知       │    │ • 发送恢复通知   │
│ • 触发器条件     │    │ • 执行脚本       │    │ • 记录日志       │
│ • 问题严重程度   │    │ • 重启服务       │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.2 动作API的四大核心功能


| API方法 | **作用** | **使用场景** | **重要程度** |
|---------|---------|-------------|-------------|
| `action.get` | **查询动作** | `查看现有动作配置，了解当前监控策略` | ⭐⭐⭐⭐⭐ |
| `action.create` | **创建动作** | `设置新的自动化响应规则` | ⭐⭐⭐⭐⭐ |
| `action.update` | **更新动作** | `修改现有动作的配置参数` | ⭐⭐⭐⭐ |
| `action.delete` | **删除动作** | `清理不需要的动作规则` | ⭐⭐⭐ |

---

## 2. 🔍 动作查询API详解


### 2.1 基础查询语法


**🔸 最简单的查询**
```json
{
    "jsonrpc": "2.0",
    "method": "action.get",
    "params": {
        "output": "extend"
    },
    "auth": "你的认证token",
    "id": 1
}
```

> 💡 **新手提示**：`"output": "extend"` 的意思是"给我返回所有详细信息"，就像问老师"把这个动作的所有信息都告诉我"

### 2.2 常用查询参数详解


**📊 核心参数说明**

| 参数名 | **含义** | **常用值** | **实际作用** |
|--------|---------|-----------|-------------|
| `output` | **返回哪些字段** | `extend`, `["name","status"]` | `控制返回信息的详细程度` |
| `selectConditions` | **是否返回触发条件** | `extend`, `query` | `查看动作在什么情况下触发` |
| `selectOperations` | **是否返回执行操作** | `extend`, `query` | `查看动作会执行什么操作` |
| `filter` | **过滤条件** | `{"name": "CPU告警"}` | `只查询符合条件的动作` |

**🎯 实用查询示例**

```json
{
    "jsonrpc": "2.0",
    "method": "action.get",
    "params": {
        "output": ["name", "status", "eventsource"],
        "selectConditions": "extend",
        "selectOperations": "extend",
        "filter": {
            "status": "0"
        }
    },
    "auth": "你的token",
    "id": 1
}
```

> 📝 **解释**：这个查询的意思是"给我查询所有启用状态的动作，并且要告诉我它们的触发条件和执行操作"

### 2.3 查询结果解读


**📋 返回结果示例**
```json
{
    "jsonrpc": "2.0",
    "result": [
        {
            "actionid": "2",
            "name": "CPU使用率过高告警",
            "eventsource": "0",
            "status": "0",
            "esc_period": "3600",
            "def_shortdata": "问题: {EVENT.NAME}",
            "def_longdata": "主机: {HOST.NAME}\n时间: {EVENT.DATE} {EVENT.TIME}",
            "conditions": [
                {
                    "conditiontype": "1",
                    "value": "CPU使用率过高"
                }
            ],
            "operations": [
                {
                    "operationtype": "0",
                    "esc_period": "0",
                    "opmessage": {
                        "default_msg": "1",
                        "subject": "Zabbix告警通知"
                    }
                }
            ]
        }
    ],
    "id": 1
}
```

**🔧 关键字段含义解释**

```
actionid: "2"                    ← 动作的唯一ID，就像身份证号
name: "CPU使用率过高告警"          ← 动作的名字，方便识别
eventsource: "0"                 ← 事件源(0=触发器事件)
status: "0"                      ← 状态(0=启用, 1=禁用)
esc_period: "3600"               ← 上报周期(秒)，3600秒=1小时
def_shortdata: "问题: {EVENT.NAME}" ← 默认短消息模板
def_longdata: "主机: {HOST.NAME}..."  ← 默认长消息模板
```

---

## 3. ⚡ 动作创建API实战


### 3.1 创建动作的基本步骤


**🎯 创建流程图解**
```
第1步: 定义基本信息    第2步: 设置触发条件    第3步: 配置执行操作
┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│ • 动作名称       │──▶│ • 什么情况下触发 │──▶│ • 触发后做什么   │
│ • 事件源类型     │   │ • 哪些主机组     │   │ • 发送给谁       │
│ • 启用状态       │   │ • 问题严重程度   │   │ • 通知内容       │
└─────────────────┘   └─────────────────┘   └─────────────────┘
```

### 3.2 基础动作创建示例


**🔸 创建一个简单的CPU告警动作**

```json
{
    "jsonrpc": "2.0",
    "method": "action.create",
    "params": {
        "name": "服务器CPU使用率告警",
        "eventsource": 0,
        "status": 0,
        "esc_period": 3600,
        "def_shortdata": "告警: {EVENT.NAME}",
        "def_longdata": "主机: {HOST.NAME}\n时间: {EVENT.DATE} {EVENT.TIME}\n详情: {EVENT.DESCRIPTION}",
        "conditions": [
            {
                "conditiontype": 1,
                "value": "CPU"
            }
        ],
        "operations": [
            {
                "operationtype": 0,
                "esc_period": 0,
                "opmessage": {
                    "default_msg": 1,
                    "subject": "Zabbix服务器告警"
                },
                "opmessage_usr": [
                    {"userid": "1"}
                ]
            }
        ]
    },
    "auth": "你的token",
    "id": 1
}
```

**📝 代码解释**

```
name: "服务器CPU使用率告警"     ← 给动作起个容易理解的名字
eventsource: 0                ← 0表示这是针对触发器事件的动作
status: 0                     ← 0表示启用这个动作
esc_period: 3600              ← 每小时重新发送一次通知
def_shortdata: "告警: {EVENT.NAME}"  ← 短消息模板
def_longdata: "主机: {HOST.NAME}..." ← 长消息模板，包含更多信息

conditions部分：
conditiontype: 1              ← 1表示"触发器名称"条件
value: "CPU"                  ← 触发器名称包含"CPU"时触发

operations部分：
operationtype: 0              ← 0表示"发送消息"操作
opmessage_usr: [{"userid": "1"}]  ← 发送给用户ID为1的用户
```

### 3.3 必须了解的事件源类型


**📊 eventsource参数详解**

| 值 | **含义** | **使用场景** | **举例** |
|----|---------|-------------|---------|
| `0` | **触发器事件** | `监控项超过阈值时` | `CPU使用率>90%、内存不足` |
| `1` | **发现规则事件** | `网络发现新设备时` | `发现新服务器、新服务` |
| `2` | **自动注册事件** | `新主机注册时` | `新服务器自动加入监控` |
| `3` | **内部事件** | `Zabbix系统内部问题` | `数据收集失败、服务停止` |

> 💡 **新手建议**：99%的情况下使用 `eventsource: 0`（触发器事件），这是最常用的监控告警场景

---

## 4. 🔄 动作更新与删除


### 4.1 动作更新操作


**🔧 更新动作的基本语法**

```json
{
    "jsonrpc": "2.0",
    "method": "action.update",
    "params": {
        "actionid": "2",
        "name": "更新后的CPU告警动作",
        "status": "0",
        "esc_period": "1800"
    },
    "auth": "你的token",
    "id": 1
}
```

> 📝 **注意事项**：更新时只需要提供要修改的字段，不需要提供所有字段

**🎯 常见更新场景**

```
场景1: 修改通知频率
"esc_period": "1800"     ← 改为30分钟通知一次

场景2: 启用/禁用动作
"status": "1"            ← 1=禁用，0=启用

场景3: 修改消息模板
"def_shortdata": "紧急: {EVENT.NAME}"  ← 更严重的提示
```

### 4.2 动作删除操作


**🗑️ 删除单个动作**
```json
{
    "jsonrpc": "2.0",
    "method": "action.delete",
    "params": ["2"],
    "auth": "你的token",
    "id": 1
}
```

**🗑️ 批量删除多个动作**
```json
{
    "jsonrpc": "2.0",
    "method": "action.delete",
    "params": ["2", "3", "4"],
    "auth": "你的token",
    "id": 1
}
```

> ⚠️ **安全提醒**：删除动作是不可恢复的操作，删除前务必确认！

---

## 5. 🎯 触发条件配置深入


### 5.1 条件类型全面解析


**📋 常用条件类型对照表**

| conditiontype | **条件名称** | **value参数含义** | **实际应用** |
|---------------|-------------|------------------|-------------|
| `0` | **主机组** | `主机组名称` | `只对特定服务器组生效` |
| `1` | **主机** | `主机名称` | `只对特定服务器生效` |
| `2` | **触发器** | `触发器名称` | `只对特定触发器生效` |
| `3` | **触发器名称** | `名称关键字` | `名称包含关键字的触发器` |
| `4` | **触发器严重程度** | `0-5数字` | `只对特定严重程度生效` |
| `5` | **触发器值** | `0或1` | `0=OK状态，1=问题状态` |
| `6` | **时间段** | `时间范围` | `只在特定时间段生效` |

### 5.2 实用条件配置示例


**🔸 场景1：只监控生产环境服务器**

```json
"conditions": [
    {
        "conditiontype": 0,
        "value": "生产环境服务器",
        "operator": 0
    }
]
```

**🔸 场景2：只处理高危和灾难级别告警**

```json
"conditions": [
    {
        "conditiontype": 4,
        "value": "4",
        "operator": 7
    },
    {
        "conditiontype": 4,
        "value": "5",
        "operator": 7
    }
]
```

> 📝 **operator参数说明**：
> - `0` = 等于
> - `1` = 不等于  
> - `2` = 包含
> - `7` = 大于等于

### 5.3 条件组合逻辑


**🔧 AND逻辑（所有条件都满足）**

```json
"conditions": [
    {
        "conditiontype": 0,
        "value": "数据库服务器",
        "operator": 0
    },
    {
        "conditiontype": 4,
        "value": "4",
        "operator": 7
    }
]
```

**解释**：只有当"主机属于数据库服务器组" **并且** "告警严重程度≥高危"时才触发

**🔧 OR逻辑配置**

```json
"evaltype": 2,
"formula": "A or B",
"conditions": [
    {
        "conditiontype": 3,
        "value": "CPU",
        "operator": 2,
        "formulaid": "A"
    },
    {
        "conditiontype": 3,
        "value": "内存",
        "operator": 2,
        "formulaid": "B"
    }
]
```

**解释**：当触发器名称包含"CPU" **或者** 包含"内存"时就触发

---

## 6. ⚙️ 执行操作配置详解


### 6.1 操作类型全览


**📊 主要操作类型对照表**

| operationtype | **操作名称** | **作用** | **使用频率** |
|---------------|-------------|---------|-------------|
| `0` | **发送消息** | `发送通知给用户` | ⭐⭐⭐⭐⭐ |
| `1` | **远程命令** | `执行远程脚本或命令` | ⭐⭐⭐⭐ |
| `2` | **添加主机** | `自动添加主机到主机组` | ⭐⭐ |
| `3` | **移除主机** | `从主机组中移除主机` | ⭐⭐ |
| `4` | **启用主机** | `启用被禁用的主机` | ⭐⭐⭐ |
| `5` | **禁用主机** | `禁用有问题的主机` | ⭐⭐⭐ |

### 6.2 发送消息操作详解


**🔸 基础消息发送配置**

```json
"operations": [
    {
        "operationtype": 0,
        "esc_period": 0,
        "esc_step_from": 1,
        "esc_step_to": 1,
        "opmessage": {
            "default_msg": 0,
            "subject": "【紧急告警】{EVENT.NAME}",
            "message": "告警详情:\n主机: {HOST.NAME}\n时间: {EVENT.DATE} {EVENT.TIME}\n问题: {EVENT.DESCRIPTION}\n\n请及时处理！",
            "mediatypeid": "1"
        },
        "opmessage_usr": [
            {"userid": "2"},
            {"userid": "3"}
        ]
    }
]
```

**📋 关键参数解释**

```
esc_period: 0                ← 0表示不重复发送
esc_step_from: 1             ← 从第1步开始
esc_step_to: 1               ← 到第1步结束
default_msg: 0               ← 0=使用自定义消息，1=使用默认消息
subject: "【紧急告警】..."     ← 邮件/短信标题
message: "告警详情:..."       ← 消息正文内容
mediatypeid: "1"             ← 媒体类型ID(1=邮件，2=短信等)
opmessage_usr: [...]         ← 接收通知的用户列表
```

### 6.3 远程命令操作


**🔸 执行远程脚本示例**

```json
"operations": [
    {
        "operationtype": 1,
        "opcommand": {
            "type": 0,
            "command": "/opt/scripts/restart_service.sh {HOST.NAME}",
            "execute_on": 0
        },
        "opcommand_hst": [
            {"hostid": "{HOST.ID}"}
        ]
    }
]
```

**📝 参数说明**

```
type: 0                      ← 0=自定义脚本，1=IPMI，2=SSH，3=Telnet
command: "/opt/scripts/..."  ← 要执行的命令或脚本路径
execute_on: 0                ← 0=Zabbix Agent，1=Zabbix Server
opcommand_hst: [...]         ← 在哪些主机上执行
```

> ⚠️ **安全提醒**：远程命令具有很高的权限，使用时要特别小心，确保脚本安全可靠

### 6.4 上报策略配置


**🔧 渐进式告警配置**

```json
"operations": [
    {
        "operationtype": 0,
        "esc_period": 600,
        "esc_step_from": 1,
        "esc_step_to": 1,
        "opmessage_usr": [{"userid": "2"}]
    },
    {
        "operationtype": 0,
        "esc_period": 1800,
        "esc_step_from": 2,
        "esc_step_to": 2,
        "opmessage_usr": [{"userid": "1"}]
    },
    {
        "operationtype": 0,
        "esc_period": 3600,
        "esc_step_from": 3,
        "esc_step_to": 0,
        "opmessage_usr": [{"userid": "3"}]
    }
]
```

**📊 告警升级流程图**

```
问题发生
    ↓
第1步: 10分钟后 → 通知运维工程师(userid=2)
    ↓ (如果问题未解决)
第2步: 30分钟后 → 通知技术主管(userid=1)  
    ↓ (如果问题未解决)
第3步: 1小时后 → 通知部门经理(userid=3)，并持续通知
```

---

## 7. 📈 上报策略与优先级


### 7.1 上报周期参数详解


**🕐 esc_period参数理解**

```
esc_period的含义：多长时间重新发送一次通知(单位：秒)

常用设置：
0      ← 不重复发送，只发一次
300    ← 每5分钟发送一次  
600    ← 每10分钟发送一次
1800   ← 每30分钟发送一次
3600   ← 每1小时发送一次
```

**🎯 不同场景的建议设置**

| 告警类型 | **建议周期** | **理由** |
|---------|-------------|---------|
| `灾难级别` | `300秒(5分钟)` | `需要立即处理，频繁提醒` |
| `高危级别` | `600秒(10分钟)` | `重要但允许短暂延迟` |
| `警告级别` | `1800秒(30分钟)` | `需要关注但不紧急` |
| `信息级别` | `0(不重复)` | `仅通知一次即可` |

### 7.2 动作优先级设置


**🏆 通过动作名称和条件控制优先级**

```json
// 高优先级动作 - 处理紧急情况
{
    "name": "【P1-紧急】服务器宕机告警",
    "conditions": [
        {
            "conditiontype": 4,
            "value": "5",  // 灾难级别
            "operator": 0
        }
    ],
    "esc_period": 300
}

// 中优先级动作 - 处理重要问题  
{
    "name": "【P2-重要】资源使用率告警",
    "conditions": [
        {
            "conditiontype": 4,
            "value": "4",  // 高危级别
            "operator": 0
        }
    ],
    "esc_period": 900
}
```

---

## 8. 🛠️ 实战案例与最佳实践


### 8.1 完整的生产环境告警动作


**🎯 场景：为生产环境创建分级告警动作**

```json
{
    "jsonrpc": "2.0",
    "method": "action.create",
    "params": {
        "name": "生产环境分级告警",
        "eventsource": 0,
        "status": 0,
        "esc_period": 0,
        "def_shortdata": "【{EVENT.SEVERITY}】{EVENT.NAME}",
        "def_longdata": "=== Zabbix监控告警 ===\n主机: {HOST.NAME} ({HOST.IP})\n时间: {EVENT.DATE} {EVENT.TIME}\n问题: {EVENT.NAME}\n严重程度: {EVENT.SEVERITY}\n当前值: {ITEM.LASTVALUE}\n\n详细信息:\n{EVENT.DESCRIPTION}",
        "r_shortdata": "【已恢复】{EVENT.NAME}",
        "r_longdata": "=== 问题已恢复 ===\n主机: {HOST.NAME}\n恢复时间: {EVENT.RECOVERY.DATE} {EVENT.RECOVERY.TIME}\n问题: {EVENT.NAME}\n持续时间: {EVENT.DURATION}",
        "conditions": [
            {
                "conditiontype": 0,
                "value": "生产环境",
                "operator": 0
            }
        ],
        "operations": [
            {
                "operationtype": 0,
                "esc_period": 600,
                "esc_step_from": 1,
                "esc_step_to": 2,
                "evaltype": 0,
                "opconditions": [
                    {
                        "conditiontype": 14,
                        "value": "4",
                        "operator": 7
                    }
                ],
                "opmessage": {
                    "default_msg": 0,
                    "subject": "【紧急】生产环境告警 - {EVENT.NAME}",
                    "message": "{ACTION.MESSAGE}"
                },
                "opmessage_usr": [
                    {"userid": "1"},
                    {"userid": "2"}
                ]
            }
        ],
        "recovery_operations": [
            {
                "operationtype": 0,
                "opmessage": {
                    "default_msg": 0,
                    "subject": "【恢复】生产环境问题已解决 - {EVENT.NAME}",
                    "message": "{ACTION.RECOVERY.MESSAGE}"
                },
                "opmessage_usr": [
                    {"userid": "1"},
                    {"userid": "2"}
                ]
            }
        ]
    },
    "auth": "你的token",
    "id": 1
}
```

### 8.2 自动化处理动作示例


**🤖 场景：服务异常时自动重启**

```json
{
    "name": "Web服务自动重启动作",
    "eventsource": 0,
    "status": 0,
    "conditions": [
        {
            "conditiontype": 3,
            "value": "Web服务状态",
            "operator": 2
        }
    ],
    "operations": [
        {
            "operationtype": 1,
            "opcommand": {
                "type": 0,
                "command": "systemctl restart nginx && echo '服务已重启' | logger",
                "execute_on": 0
            },
            "opcommand_hst": [
                {"hostid": "{HOST.ID}"}
            ]
        },
        {
            "operationtype": 0,
            "esc_period": 0,
            "opmessage": {
                "default_msg": 0,
                "subject": "自动重启通知",
                "message": "检测到{HOST.NAME}的Web服务异常，已自动执行重启操作。\n时间: {EVENT.DATE} {EVENT.TIME}"
            },
            "opmessage_usr": [{"userid": "1"}]
        }
    ]
}
```

### 8.3 最佳实践建议


**✅ 推荐做法**

```
1. 命名规范化
   格式: 【优先级】环境-功能-动作类型
   示例: 【P1】生产-数据库-告警通知

2. 分层级处理
   • P1(灾难): 立即通知 + 自动处理
   • P2(高危): 快速通知 + 人工处理  
   • P3(警告): 定期通知 + 批量处理

3. 消息模板标准化
   • 包含关键信息: 主机、时间、问题、当前值
   • 使用统一格式便于自动化处理
   • 提供足够上下文信息

4. 恢复操作必须配置
   • 通知问题已解决
   • 记录恢复时间和持续时间
   • 为后续分析提供数据
```

**❌ 避免的问题**

```
1. 通知轰炸
   • 避免过于频繁的重复通知
   • 合理设置esc_period参数
   
2. 权限过大的远程命令
   • 避免使用root权限执行命令
   • 脚本要有充分的错误处理

3. 缺少条件限制
   • 避免动作对所有告警生效
   • 必须设置合适的触发条件
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 动作本质：条件触发的自动化响应规则
🔸 四大API：action.get查询、action.create创建、action.update更新、action.delete删除
🔸 三大组成：触发条件 + 执行操作 + 恢复操作
🔸 事件源类型：主要使用eventsource=0(触发器事件)
🔸 操作类型：发送消息(0)和远程命令(1)最常用
🔸 上报策略：通过esc_period控制通知频率
```

### 9.2 关键理解要点


**🔹 动作设计思路**
```
问自己三个问题：
1. 什么情况下要触发？(conditions)
2. 触发后要做什么？(operations)  
3. 恢复后要做什么？(recovery_operations)

设计原则：
• 条件要精确，避免误报
• 操作要有效，解决实际问题
• 通知要及时，但不能骚扰
```

**🔹 消息模板变量**
```
主机相关：{HOST.NAME}、{HOST.IP}
事件相关：{EVENT.NAME}、{EVENT.DATE}、{EVENT.TIME}
问题相关：{EVENT.SEVERITY}、{EVENT.DESCRIPTION}
监控项：{ITEM.LASTVALUE}、{ITEM.NAME}
恢复相关：{EVENT.RECOVERY.DATE}、{EVENT.DURATION}
```

**🔹 条件组合逻辑**
```
默认AND逻辑：所有条件都满足时触发
自定义OR逻辑：使用evaltype=2和formula参数
实际应用：根据业务需求灵活组合条件
```

### 9.3 实际应用价值


**🎯 业务场景应用**
- **运维自动化**：故障自动发现和初步处理
- **告警分级**：不同严重程度采用不同处理策略  
- **团队协作**：告警自动分发给相关责任人
- **合规要求**：满足运维规范和审计要求

**🔧 技能提升价值**
- **API编程**：掌握Zabbix API调用方法
- **监控理念**：理解现代化监控系统设计思想
- **自动化思维**：培养系统化解决问题的能力
- **JSON技能**：熟练使用JSON格式进行配置

**核心记忆口诀**：
```
动作管理四API，查创改删要记牢
条件操作恢复全，三者缺一不可靠
消息模板变量活，远程命令权限小
分级告警有策略，通知频率设置好
```

**学习建议**：
1. **先理解概念**：明白动作的作用和工作原理
2. **实践简单例子**：从基础的通知动作开始练习
3. **逐步增加复杂度**：加入条件判断和远程命令
4. **总结最佳实践**：形成自己的动作设计规范